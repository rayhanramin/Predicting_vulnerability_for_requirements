<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 28803:d575c65cb9ea5c7f01c7eedf861f3e0425ab72db</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ d575c65cb9ea5c7f01c7eedf861f3e0425ab72db" />
<meta property="og:url" content="/comm-central/rev/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db" />
<meta property="og:description" content="Bug 1614265 - Remove old nsAbManager implementation. r=mkmelin" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / d575c65cb9ea5c7f01c7eedf861f3e0425ab72db 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db">shortlog</a> |
<a href="/comm-central/log/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db">files</a> |
changeset |
<a href="/comm-central/raw-rev/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db">raw</a>  | <a href="/comm-central/archive/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1614265">Bug 1614265</a> - Remove old nsAbManager implementation. r=mkmelin
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#71;&#101;&#111;&#102;&#102;&#32;&#76;&#97;&#110;&#107;&#111;&#119;&#32;&#60;&#103;&#101;&#111;&#102;&#102;&#64;&#100;&#97;&#114;&#107;&#116;&#114;&#111;&#106;&#97;&#110;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Wed, 12 Feb 2020 23:16:51 +0000</td></tr>

<tr>
 <td>changeset 28803</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db">d575c65cb9ea5c7f01c7eedf861f3e0425ab72db</a></td>
</tr>



<tr>
<td>parent 28802</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/3204b6752a70b3d144ceebdf36bf9414e06281dd">3204b6752a70b3d144ceebdf36bf9414e06281dd</a>
</td>
</tr>

<tr>
<td>child 28804</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/a04956310d2fe4df06c9ba41cb7bb239a09341d4">a04956310d2fe4df06c9ba41cb7bb239a09341d4</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=d575c65cb9ea5c7f01c7eedf861f3e0425ab72db">17045</a></td></tr>
<tr><td>push user</td><td>geoff@darktrojan.net</td></tr>
<tr><td>push date</td><td class="date age">Wed, 19 Feb 2020 23:43:49 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@a04956310d2f [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=a04956310d2fe4df06c9ba41cb7bb239a09341d4">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=a04956310d2fe4df06c9ba41cb7bb239a09341d4&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=a04956310d2fe4df06c9ba41cb7bb239a09341d4&newProject=comm-central&newRevision=a94a4098acb456ab8ad149007e9732fe6a9cd64e&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=a04956310d2fe4df06c9ba41cb7bb239a09341d4&newProject=comm-central&newRevision=a94a4098acb456ab8ad149007e9732fe6a9cd64e&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=a04956310d2fe4df06c9ba41cb7bb239a09341d4&newProject=comm-central&newRevision=a94a4098acb456ab8ad149007e9732fe6a9cd64e&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28mkmelin%29&revcount=50">mkmelin</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1614265">1614265</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1614265">Bug 1614265</a> - Remove old nsAbManager implementation. r=mkmelin

Differential Revision: <a href="https://phabricator.services.mozilla.com/D62394">https://phabricator.services.mozilla.com/D62394</a></div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/jsaddrbook/AddrBookDirectory.jsm">mailnews/addrbook/jsaddrbook/AddrBookDirectory.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/jsaddrbook/AddrBookDirectory.jsm">file</a> |
<a href="/comm-central/annotate/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/jsaddrbook/AddrBookDirectory.jsm">annotate</a> |
<a href="/comm-central/diff/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/jsaddrbook/AddrBookDirectory.jsm">diff</a> |
<a href="/comm-central/comparison/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/jsaddrbook/AddrBookDirectory.jsm">comparison</a> |
<a href="/comm-central/log/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/jsaddrbook/AddrBookDirectory.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/jsaddrbook/AddrBookFactory.jsm">mailnews/addrbook/jsaddrbook/AddrBookFactory.jsm</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/jsaddrbook/AddrBookFactory.jsm">diff</a> |
<a href="/comm-central/comparison/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/jsaddrbook/AddrBookFactory.jsm">comparison</a> |
<a href="/comm-central/log/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/jsaddrbook/AddrBookFactory.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/jsaddrbook/components.conf">mailnews/addrbook/jsaddrbook/components.conf</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/jsaddrbook/components.conf">file</a> |
<a href="/comm-central/annotate/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/jsaddrbook/components.conf">annotate</a> |
<a href="/comm-central/diff/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/jsaddrbook/components.conf">diff</a> |
<a href="/comm-central/comparison/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/jsaddrbook/components.conf">comparison</a> |
<a href="/comm-central/log/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/jsaddrbook/components.conf">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/jsaddrbook/moz.build">mailnews/addrbook/jsaddrbook/moz.build</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/jsaddrbook/moz.build">file</a> |
<a href="/comm-central/annotate/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/jsaddrbook/moz.build">annotate</a> |
<a href="/comm-central/diff/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/jsaddrbook/moz.build">diff</a> |
<a href="/comm-central/comparison/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/jsaddrbook/moz.build">comparison</a> |
<a href="/comm-central/log/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/jsaddrbook/moz.build">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/public/moz.build">mailnews/addrbook/public/moz.build</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/public/moz.build">file</a> |
<a href="/comm-central/annotate/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/public/moz.build">annotate</a> |
<a href="/comm-central/diff/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/public/moz.build">diff</a> |
<a href="/comm-central/comparison/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/public/moz.build">comparison</a> |
<a href="/comm-central/log/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/public/moz.build">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/public/nsAbBaseCID.h">mailnews/addrbook/public/nsAbBaseCID.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/public/nsAbBaseCID.h">file</a> |
<a href="/comm-central/annotate/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/public/nsAbBaseCID.h">annotate</a> |
<a href="/comm-central/diff/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/public/nsAbBaseCID.h">diff</a> |
<a href="/comm-central/comparison/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/public/nsAbBaseCID.h">comparison</a> |
<a href="/comm-central/log/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/public/nsAbBaseCID.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/public/nsIAbDirFactory.idl">mailnews/addrbook/public/nsIAbDirFactory.idl</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/public/nsIAbDirFactory.idl">diff</a> |
<a href="/comm-central/comparison/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/public/nsIAbDirFactory.idl">comparison</a> |
<a href="/comm-central/log/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/public/nsIAbDirFactory.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/public/nsIAbDirFactoryService.idl">mailnews/addrbook/public/nsIAbDirFactoryService.idl</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/public/nsIAbDirFactoryService.idl">diff</a> |
<a href="/comm-central/comparison/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/public/nsIAbDirFactoryService.idl">comparison</a> |
<a href="/comm-central/log/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/public/nsIAbDirFactoryService.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/public/nsIAbDirectory.idl">mailnews/addrbook/public/nsIAbDirectory.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/public/nsIAbDirectory.idl">file</a> |
<a href="/comm-central/annotate/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/public/nsIAbDirectory.idl">annotate</a> |
<a href="/comm-central/diff/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/public/nsIAbDirectory.idl">diff</a> |
<a href="/comm-central/comparison/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/public/nsIAbDirectory.idl">comparison</a> |
<a href="/comm-central/log/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/public/nsIAbDirectory.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/src/moz.build">mailnews/addrbook/src/moz.build</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/src/moz.build">file</a> |
<a href="/comm-central/annotate/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/src/moz.build">annotate</a> |
<a href="/comm-central/diff/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/src/moz.build">diff</a> |
<a href="/comm-central/comparison/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/src/moz.build">comparison</a> |
<a href="/comm-central/log/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/src/moz.build">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/src/nsAbBSDirectory.cpp">mailnews/addrbook/src/nsAbBSDirectory.cpp</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/src/nsAbBSDirectory.cpp">diff</a> |
<a href="/comm-central/comparison/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/src/nsAbBSDirectory.cpp">comparison</a> |
<a href="/comm-central/log/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/src/nsAbBSDirectory.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/src/nsAbBSDirectory.h">mailnews/addrbook/src/nsAbBSDirectory.h</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/src/nsAbBSDirectory.h">diff</a> |
<a href="/comm-central/comparison/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/src/nsAbBSDirectory.h">comparison</a> |
<a href="/comm-central/log/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/src/nsAbBSDirectory.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/src/nsAbDirFactoryService.cpp">mailnews/addrbook/src/nsAbDirFactoryService.cpp</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/src/nsAbDirFactoryService.cpp">diff</a> |
<a href="/comm-central/comparison/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/src/nsAbDirFactoryService.cpp">comparison</a> |
<a href="/comm-central/log/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/src/nsAbDirFactoryService.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/src/nsAbDirFactoryService.h">mailnews/addrbook/src/nsAbDirFactoryService.h</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/src/nsAbDirFactoryService.h">diff</a> |
<a href="/comm-central/comparison/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/src/nsAbDirFactoryService.h">comparison</a> |
<a href="/comm-central/log/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/src/nsAbDirFactoryService.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/src/nsAbDirProperty.cpp">mailnews/addrbook/src/nsAbDirProperty.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/src/nsAbDirProperty.cpp">file</a> |
<a href="/comm-central/annotate/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/src/nsAbDirProperty.cpp">annotate</a> |
<a href="/comm-central/diff/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/src/nsAbDirProperty.cpp">diff</a> |
<a href="/comm-central/comparison/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/src/nsAbDirProperty.cpp">comparison</a> |
<a href="/comm-central/log/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/src/nsAbDirProperty.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/src/nsAbLDAPDirFactory.cpp">mailnews/addrbook/src/nsAbLDAPDirFactory.cpp</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/src/nsAbLDAPDirFactory.cpp">diff</a> |
<a href="/comm-central/comparison/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/src/nsAbLDAPDirFactory.cpp">comparison</a> |
<a href="/comm-central/log/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/src/nsAbLDAPDirFactory.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/src/nsAbLDAPDirFactory.h">mailnews/addrbook/src/nsAbLDAPDirFactory.h</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/src/nsAbLDAPDirFactory.h">diff</a> |
<a href="/comm-central/comparison/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/src/nsAbLDAPDirFactory.h">comparison</a> |
<a href="/comm-central/log/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/src/nsAbLDAPDirFactory.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/src/nsAbLDAPReplicationQuery.cpp">mailnews/addrbook/src/nsAbLDAPReplicationQuery.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/src/nsAbLDAPReplicationQuery.cpp">file</a> |
<a href="/comm-central/annotate/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/src/nsAbLDAPReplicationQuery.cpp">annotate</a> |
<a href="/comm-central/diff/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/src/nsAbLDAPReplicationQuery.cpp">diff</a> |
<a href="/comm-central/comparison/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/src/nsAbLDAPReplicationQuery.cpp">comparison</a> |
<a href="/comm-central/log/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/src/nsAbLDAPReplicationQuery.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/src/nsAbManager.cpp">mailnews/addrbook/src/nsAbManager.cpp</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/src/nsAbManager.cpp">diff</a> |
<a href="/comm-central/comparison/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/src/nsAbManager.cpp">comparison</a> |
<a href="/comm-central/log/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/src/nsAbManager.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/src/nsAbManager.h">mailnews/addrbook/src/nsAbManager.h</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/src/nsAbManager.h">diff</a> |
<a href="/comm-central/comparison/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/src/nsAbManager.h">comparison</a> |
<a href="/comm-central/log/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/src/nsAbManager.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/src/nsAbOSXDirFactory.cpp">mailnews/addrbook/src/nsAbOSXDirFactory.cpp</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/src/nsAbOSXDirFactory.cpp">diff</a> |
<a href="/comm-central/comparison/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/src/nsAbOSXDirFactory.cpp">comparison</a> |
<a href="/comm-central/log/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/src/nsAbOSXDirFactory.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/src/nsAbOSXDirFactory.h">mailnews/addrbook/src/nsAbOSXDirFactory.h</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/src/nsAbOSXDirFactory.h">diff</a> |
<a href="/comm-central/comparison/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/src/nsAbOSXDirFactory.h">comparison</a> |
<a href="/comm-central/log/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/src/nsAbOSXDirFactory.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/src/nsDirPrefs.cpp">mailnews/addrbook/src/nsDirPrefs.cpp</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/src/nsDirPrefs.cpp">diff</a> |
<a href="/comm-central/comparison/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/src/nsDirPrefs.cpp">comparison</a> |
<a href="/comm-central/log/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/src/nsDirPrefs.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/src/nsDirPrefs.h">mailnews/addrbook/src/nsDirPrefs.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/src/nsDirPrefs.h">file</a> |
<a href="/comm-central/annotate/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/src/nsDirPrefs.h">annotate</a> |
<a href="/comm-central/diff/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/src/nsDirPrefs.h">diff</a> |
<a href="/comm-central/comparison/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/src/nsDirPrefs.h">comparison</a> |
<a href="/comm-central/log/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/src/nsDirPrefs.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/test/unit/test_basic_nsIAbDirectory.js">mailnews/addrbook/test/unit/test_basic_nsIAbDirectory.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/test/unit/test_basic_nsIAbDirectory.js">file</a> |
<a href="/comm-central/annotate/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/test/unit/test_basic_nsIAbDirectory.js">annotate</a> |
<a href="/comm-central/diff/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/test/unit/test_basic_nsIAbDirectory.js">diff</a> |
<a href="/comm-central/comparison/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/test/unit/test_basic_nsIAbDirectory.js">comparison</a> |
<a href="/comm-central/log/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/addrbook/test/unit/test_basic_nsIAbDirectory.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/build/nsMailModule.cpp">mailnews/build/nsMailModule.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/build/nsMailModule.cpp">file</a> |
<a href="/comm-central/annotate/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/build/nsMailModule.cpp">annotate</a> |
<a href="/comm-central/diff/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/build/nsMailModule.cpp">diff</a> |
<a href="/comm-central/comparison/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/build/nsMailModule.cpp">comparison</a> |
<a href="/comm-central/log/d575c65cb9ea5c7f01c7eedf861f3e0425ab72db/mailnews/build/nsMailModule.cpp">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/addrbook/jsaddrbook/AddrBookDirectory.jsm</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/addrbook/jsaddrbook/AddrBookDirectory.jsm</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -935,24 +935,16 @@ AddrBookDirectoryInner.prototype = {</span>
<a href="#l1.4"></a><span id="l1.4">   },</span>
<a href="#l1.5"></a><span id="l1.5">   editMailListToDatabase(listCard) {</span>
<a href="#l1.6"></a><span id="l1.6">     // Deliberately not implemented, this isn't a mailing list.</span>
<a href="#l1.7"></a><span id="l1.7">     throw Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l1.8"></a><span id="l1.8">   },</span>
<a href="#l1.9"></a><span id="l1.9">   copyMailList(srcList) {</span>
<a href="#l1.10"></a><span id="l1.10">     throw Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l1.11"></a><span id="l1.11">   },</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-  createNewDirectory(dirName, uri, type, prefName) {</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-    // Deliberately not implemented, this isn't the root directory.</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineminus">-    throw Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineminus">-  },</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineminus">-  createDirectoryByURI(displayName, uri) {</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineminus">-    // Deliberately not implemented, this isn't the root directory.</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineminus">-    throw Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineminus">-  },</span>
<a href="#l1.20"></a><span id="l1.20">   getIntValue(name, defaultValue) {</span>
<a href="#l1.21"></a><span id="l1.21">     return this._prefBranch.getIntPref(name, defaultValue);</span>
<a href="#l1.22"></a><span id="l1.22">   },</span>
<a href="#l1.23"></a><span id="l1.23">   getBoolValue(name, defaultValue) {</span>
<a href="#l1.24"></a><span id="l1.24">     return this._prefBranch.getBoolPref(name, defaultValue);</span>
<a href="#l1.25"></a><span id="l1.25">   },</span>
<a href="#l1.26"></a><span id="l1.26">   getStringValue(name, defaultValue) {</span>
<a href="#l1.27"></a><span id="l1.27">     return this._prefBranch.getStringPref(name, defaultValue);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1">deleted file mode 100644</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineminus">--- a/mailnews/addrbook/jsaddrbook/AddrBookFactory.jsm</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineplus">+++ /dev/null</span>
<a href="#l2.4"></a><span id="l2.4" class="difflineat">@@ -1,68 +0,0 @@</span>
<a href="#l2.5"></a><span id="l2.5" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l2.6"></a><span id="l2.6" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l2.7"></a><span id="l2.7" class="difflineminus">- * file, you can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l2.8"></a><span id="l2.8" class="difflineminus">-</span>
<a href="#l2.9"></a><span id="l2.9" class="difflineminus">-this.EXPORTED_SYMBOLS = [&quot;AddrBookFactory&quot;];</span>
<a href="#l2.10"></a><span id="l2.10" class="difflineminus">-</span>
<a href="#l2.11"></a><span id="l2.11" class="difflineminus">-ChromeUtils.defineModuleGetter(</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-  this,</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-  &quot;FileUtils&quot;,</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineminus">-  &quot;resource://gre/modules/FileUtils.jsm&quot;</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineminus">-);</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineminus">-ChromeUtils.defineModuleGetter(</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineminus">-  this,</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineminus">-  &quot;MailServices&quot;,</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineminus">-  &quot;resource:///modules/MailServices.jsm&quot;</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineminus">-);</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineminus">-ChromeUtils.defineModuleGetter(</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineminus">-  this,</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineminus">-  &quot;closeConnectionTo&quot;,</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineminus">-  &quot;resource:///modules/AddrBookDirectory.jsm&quot;</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineminus">-);</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineminus">-</span>
<a href="#l2.27"></a><span id="l2.27" class="difflineminus">-/**</span>
<a href="#l2.28"></a><span id="l2.28" class="difflineminus">- * Address book factory. This looks like it should be a useful for keeping</span>
<a href="#l2.29"></a><span id="l2.29" class="difflineminus">- * reference to all JS directories, but in reality it's not used for most</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineminus">- * methods of accessing a directory, and nsAbManager has a cache anyway.</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineminus">- *</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineminus">- * @implements {nsIAbDirFactory}</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineminus">- */</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineminus">-function AddrBookFactory() {}</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineminus">-AddrBookFactory.prototype = {</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineminus">-  QueryInterface: ChromeUtils.generateQI([Ci.nsIAbDirFactory]),</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineminus">-  classID: Components.ID(&quot;{567c1f22-bae5-4bc9-9951-885678dc14a5}&quot;),</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineminus">-</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineminus">-  /* nsIAbDirFactory */</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineminus">-</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineminus">-  getDirectories(dirName, uri, prefName) {</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineminus">-    let directory = MailServices.ab.getDirectory(uri);</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineminus">-    directory.dirPrefId = prefName;</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineminus">-</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineminus">-    return {</span>
<a href="#l2.46"></a><span id="l2.46" class="difflineminus">-      _position: 0,</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineminus">-      hasMoreElements() {</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineminus">-        return this._position == 0;</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineminus">-      },</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineminus">-      getNext() {</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineminus">-        if (this.hasMoreElements()) {</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineminus">-          this._position++;</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineminus">-          return directory;</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineminus">-        }</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineminus">-        throw Cr.NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineminus">-      },</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineminus">-      QueryInterface: ChromeUtils.generateQI([Ci.nsISimpleEnumerator]),</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineminus">-      *[Symbol.iterator]() {</span>
<a href="#l2.59"></a><span id="l2.59" class="difflineminus">-        while (this.hasMoreElements()) {</span>
<a href="#l2.60"></a><span id="l2.60" class="difflineminus">-          yield this.getNext();</span>
<a href="#l2.61"></a><span id="l2.61" class="difflineminus">-        }</span>
<a href="#l2.62"></a><span id="l2.62" class="difflineminus">-      },</span>
<a href="#l2.63"></a><span id="l2.63" class="difflineminus">-    };</span>
<a href="#l2.64"></a><span id="l2.64" class="difflineminus">-  },</span>
<a href="#l2.65"></a><span id="l2.65" class="difflineminus">-  async deleteDirectory(directory) {</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineminus">-    let file = FileUtils.getFile(&quot;ProfD&quot;, [directory.fileName]);</span>
<a href="#l2.67"></a><span id="l2.67" class="difflineminus">-    if (file.exists()) {</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineminus">-      await closeConnectionTo(file);</span>
<a href="#l2.69"></a><span id="l2.69" class="difflineminus">-      file.remove(false);</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineminus">-    }</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineminus">-  },</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineminus">-};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/addrbook/jsaddrbook/components.conf</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/addrbook/jsaddrbook/components.conf</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -1,15 +1,10 @@</span>
<a href="#l3.4"></a><span id="l3.4"> Classes = [</span>
<a href="#l3.5"></a><span id="l3.5">     {</span>
<a href="#l3.6"></a><span id="l3.6" class="difflineminus">-        'cid': '{567c1f22-bae5-4bc9-9951-885678dc14a5}',</span>
<a href="#l3.7"></a><span id="l3.7" class="difflineminus">-        'contract_ids': ['@mozilla.org/addressbook/directory-factory;1?name=jsaddrbook'],</span>
<a href="#l3.8"></a><span id="l3.8" class="difflineminus">-        'jsm': 'resource:///modules/AddrBookFactory.jsm',</span>
<a href="#l3.9"></a><span id="l3.9" class="difflineminus">-        'constructor': 'AddrBookFactory',</span>
<a href="#l3.10"></a><span id="l3.10" class="difflineminus">-    }, {</span>
<a href="#l3.11"></a><span id="l3.11">         'cid': '{e96ee804-0bd3-472f-81a6-8a9d65277ad3}',</span>
<a href="#l3.12"></a><span id="l3.12">         'contract_ids': ['@mozilla.org/addressbook/directory;1?type=jsaddrbook'],</span>
<a href="#l3.13"></a><span id="l3.13">         'jsm': 'resource:///modules/AddrBookDirectory.jsm',</span>
<a href="#l3.14"></a><span id="l3.14">         'constructor': 'AddrBookDirectory',</span>
<a href="#l3.15"></a><span id="l3.15">     }, {</span>
<a href="#l3.16"></a><span id="l3.16">         'cid': '{1143991d-31cd-4ea6-9c97-c587d990d724}',</span>
<a href="#l3.17"></a><span id="l3.17">         'contract_ids': ['@mozilla.org/addressbook/jsaddrbookcard;1'],</span>
<a href="#l3.18"></a><span id="l3.18">         'jsm': 'resource:///modules/AddrBookCard.jsm',</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/addrbook/jsaddrbook/moz.build</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/addrbook/jsaddrbook/moz.build</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -1,16 +1,15 @@</span>
<a href="#l4.4"></a><span id="l4.4"> # This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l4.5"></a><span id="l4.5"> # License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l4.6"></a><span id="l4.6"> # file, you can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l4.7"></a><span id="l4.7"> </span>
<a href="#l4.8"></a><span id="l4.8"> EXTRA_JS_MODULES += [</span>
<a href="#l4.9"></a><span id="l4.9">     'AddrBookCard.jsm',</span>
<a href="#l4.10"></a><span id="l4.10">     'AddrBookDirectory.jsm',</span>
<a href="#l4.11"></a><span id="l4.11" class="difflineminus">-    'AddrBookFactory.jsm',</span>
<a href="#l4.12"></a><span id="l4.12">     'AddrBookMailingList.jsm',</span>
<a href="#l4.13"></a><span id="l4.13">     'AddrBookManager.jsm',</span>
<a href="#l4.14"></a><span id="l4.14">     'AddrBookUtils.jsm',</span>
<a href="#l4.15"></a><span id="l4.15"> ]</span>
<a href="#l4.16"></a><span id="l4.16"> </span>
<a href="#l4.17"></a><span id="l4.17"> XPCOM_MANIFESTS += [</span>
<a href="#l4.18"></a><span id="l4.18">     'components.conf',</span>
<a href="#l4.19"></a><span id="l4.19"> ]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/addrbook/public/moz.build</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/addrbook/public/moz.build</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -6,18 +6,16 @@</span>
<a href="#l5.4"></a><span id="l5.4"> XPIDL_SOURCES += [</span>
<a href="#l5.5"></a><span id="l5.5">     'nsIAbAddressCollector.idl',</span>
<a href="#l5.6"></a><span id="l5.6">     'nsIAbAutoCompleteResult.idl',</span>
<a href="#l5.7"></a><span id="l5.7">     'nsIAbBooleanExpression.idl',</span>
<a href="#l5.8"></a><span id="l5.8">     'nsIAbCard.idl',</span>
<a href="#l5.9"></a><span id="l5.9">     'nsIAbDirectory.idl',</span>
<a href="#l5.10"></a><span id="l5.10">     'nsIAbDirectoryQuery.idl',</span>
<a href="#l5.11"></a><span id="l5.11">     'nsIAbDirectoryQueryProxy.idl',</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-    'nsIAbDirFactory.idl',</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineminus">-    'nsIAbDirFactoryService.idl',</span>
<a href="#l5.14"></a><span id="l5.14">     'nsIAbDirSearchListener.idl',</span>
<a href="#l5.15"></a><span id="l5.15">     'nsIAbLDAPAttributeMap.idl',</span>
<a href="#l5.16"></a><span id="l5.16">     'nsIAbLDIFService.idl',</span>
<a href="#l5.17"></a><span id="l5.17">     'nsIAbListener.idl',</span>
<a href="#l5.18"></a><span id="l5.18">     'nsIAbManager.idl',</span>
<a href="#l5.19"></a><span id="l5.19">     'nsIAbView.idl',</span>
<a href="#l5.20"></a><span id="l5.20">     'nsIAddbookUrl.idl',</span>
<a href="#l5.21"></a><span id="l5.21">     'nsIAddrDatabase.idl',</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/addrbook/public/nsAbBaseCID.h</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/addrbook/public/nsAbBaseCID.h</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -22,50 +22,27 @@</span>
<a href="#l6.4"></a><span id="l6.4"> #define NS_AB_DIRECTORY_TYPE_CONTRACTID_PREFIX \</span>
<a href="#l6.5"></a><span id="l6.5">   &quot;@mozilla.org/addressbook/directory;1?type=&quot;</span>
<a href="#l6.6"></a><span id="l6.6"> </span>
<a href="#l6.7"></a><span id="l6.7"> //</span>
<a href="#l6.8"></a><span id="l6.8"> // nsAbManager</span>
<a href="#l6.9"></a><span id="l6.9"> //</span>
<a href="#l6.10"></a><span id="l6.10"> #define NS_ABMANAGER_CONTRACTID &quot;@mozilla.org/abmanager;1&quot;</span>
<a href="#l6.11"></a><span id="l6.11"> </span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-#define NS_ABMANAGERSTARTUPHANDLER_CONTRACTID \</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-  &quot;@mozilla.org/commandlinehandler/general-startup;1?type=addressbook&quot;</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineminus">-</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineminus">-#define NS_ABMANAGER_CID                             \</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineminus">-  {                                                  \</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineminus">-    0xad81b321, 0x8a8a, 0x42ca, {                    \</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineminus">-      0xa5, 0x08, 0xfe, 0x65, 0x9d, 0x8e, 0x45, 0x86 \</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineminus">-    }                                                \</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineminus">-  }</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineminus">-</span>
<a href="#l6.22"></a><span id="l6.22"> //</span>
<a href="#l6.23"></a><span id="l6.23"> // nsAbContentHandler</span>
<a href="#l6.24"></a><span id="l6.24"> //</span>
<a href="#l6.25"></a><span id="l6.25"> #define NS_ABCONTENTHANDLER_CID                      \</span>
<a href="#l6.26"></a><span id="l6.26">   {                                                  \</span>
<a href="#l6.27"></a><span id="l6.27">     0xa72ad552, 0x0484, 0x4b5f, {                    \</span>
<a href="#l6.28"></a><span id="l6.28">       0x8d, 0x45, 0x2d, 0x79, 0x15, 0x8d, 0x22, 0xe3 \</span>
<a href="#l6.29"></a><span id="l6.29">     }                                                \</span>
<a href="#l6.30"></a><span id="l6.30">   }</span>
<a href="#l6.31"></a><span id="l6.31"> </span>
<a href="#l6.32"></a><span id="l6.32"> //</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineminus">-// nsAbBSDirectory - the root address book</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineminus">-//</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineminus">-#define NS_ABDIRECTORY_CONTRACTID \</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineminus">-  NS_AB_DIRECTORY_TYPE_CONTRACTID_PREFIX &quot;moz-abdirectory&quot;</span>
<a href="#l6.37"></a><span id="l6.37" class="difflineminus">-</span>
<a href="#l6.38"></a><span id="l6.38" class="difflineminus">-#define NS_ABDIRECTORY_CID                           \</span>
<a href="#l6.39"></a><span id="l6.39" class="difflineminus">-  {                                                  \</span>
<a href="#l6.40"></a><span id="l6.40" class="difflineminus">-    0x012D3C24, 0x1DD2, 0x11B2, {                    \</span>
<a href="#l6.41"></a><span id="l6.41" class="difflineminus">-      0xBA, 0x79, 0xB4, 0xAD, 0x35, 0x9F, 0xC4, 0x61 \</span>
<a href="#l6.42"></a><span id="l6.42" class="difflineminus">-    }                                                \</span>
<a href="#l6.43"></a><span id="l6.43" class="difflineminus">-  }</span>
<a href="#l6.44"></a><span id="l6.44" class="difflineminus">-</span>
<a href="#l6.45"></a><span id="l6.45" class="difflineminus">-//</span>
<a href="#l6.46"></a><span id="l6.46"> // JS/SQLite address book</span>
<a href="#l6.47"></a><span id="l6.47"> //</span>
<a href="#l6.48"></a><span id="l6.48"> #define NS_ABJSDIRECTORY_CONTRACTID \</span>
<a href="#l6.49"></a><span id="l6.49">   NS_AB_DIRECTORY_TYPE_CONTRACTID_PREFIX &quot;jsaddrbook&quot;</span>
<a href="#l6.50"></a><span id="l6.50"> </span>
<a href="#l6.51"></a><span id="l6.51"> //</span>
<a href="#l6.52"></a><span id="l6.52"> // nsAddressBookDB</span>
<a href="#l6.53"></a><span id="l6.53"> //</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1">deleted file mode 100644</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineminus">--- a/mailnews/addrbook/public/nsIAbDirFactory.idl</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineplus">+++ /dev/null</span>
<a href="#l7.4"></a><span id="l7.4" class="difflineat">@@ -1,35 +0,0 @@</span>
<a href="#l7.5"></a><span id="l7.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l7.6"></a><span id="l7.6" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l7.7"></a><span id="l7.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l7.8"></a><span id="l7.8" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l7.9"></a><span id="l7.9" class="difflineminus">-</span>
<a href="#l7.10"></a><span id="l7.10" class="difflineminus">-#include &quot;nsISupports.idl&quot;</span>
<a href="#l7.11"></a><span id="l7.11" class="difflineminus">-#include &quot;nsISimpleEnumerator.idl&quot;</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">-interface nsIAbDirectory;</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineminus">-</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineminus">-[scriptable, uuid(ad61b4fc-d8d8-40b2-b924-4c10f28a8a17)]</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineminus">-interface nsIAbDirFactory : nsISupports</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineminus">-{</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineminus">-    /**</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineminus">-     * Get a top level address book directory and sub directories, given some</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineminus">-     * properties.</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineminus">-     *</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineminus">-     * @param aDirName  Name of the address book</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineminus">-     *</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineminus">-     * @param aURI      URI of the address book</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineminus">-     *</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineminus">-     * @param aPrefName Pref name for the preferences of the address book</span>
<a href="#l7.27"></a><span id="l7.27" class="difflineminus">-     *</span>
<a href="#l7.28"></a><span id="l7.28" class="difflineminus">-     * @return          Enumeration of nsIAbDirectory interfaces</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineminus">-     */</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineminus">-    nsISimpleEnumerator getDirectories(in AString aDirName, in ACString aURI,</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineminus">-                                       in ACString aPrefName);</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineminus">-</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineminus">-    /**</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineminus">-     * Delete a top level address book directory</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineminus">-     *</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineminus">-     */</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineminus">-    void deleteDirectory(in nsIAbDirectory directory);</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineminus">-};</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1">deleted file mode 100644</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineminus">--- a/mailnews/addrbook/public/nsIAbDirFactoryService.idl</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineplus">+++ /dev/null</span>
<a href="#l8.4"></a><span id="l8.4" class="difflineat">@@ -1,28 +0,0 @@</span>
<a href="#l8.5"></a><span id="l8.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l8.6"></a><span id="l8.6" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l8.7"></a><span id="l8.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l8.8"></a><span id="l8.8" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l8.9"></a><span id="l8.9" class="difflineminus">-</span>
<a href="#l8.10"></a><span id="l8.10" class="difflineminus">-</span>
<a href="#l8.11"></a><span id="l8.11" class="difflineminus">-#include &quot;nsISupports.idl&quot;</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineminus">-interface nsIAbDirFactory;</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineminus">-</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineminus">-[scriptable, uuid(154a951b-a310-400c-b98f-d769cc5d575f)]</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineminus">-interface nsIAbDirFactoryService : nsISupports</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineminus">-{</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineminus">-  /**</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineminus">-   * Obtain a directory factory component given a uri representing an address</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineminus">-   * book. The scheme is extracted from the uri and contract id is generated</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineminus">-   * of the form:</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineminus">-   * @mozilla.org/addressbook/directory-factory;1?name=&lt;scheme&gt;</span>
<a href="#l8.23"></a><span id="l8.23" class="difflineminus">-   *</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineminus">-   * This id is used to instantiate a registered component which implemented</span>
<a href="#l8.25"></a><span id="l8.25" class="difflineminus">-   * the nsIAbDirFactory interface.</span>
<a href="#l8.26"></a><span id="l8.26" class="difflineminus">-   *</span>
<a href="#l8.27"></a><span id="l8.27" class="difflineminus">-   * @param aURI  The uri which contains the scheme that defines what directory</span>
<a href="#l8.28"></a><span id="l8.28" class="difflineminus">-   *              factory instance is returned</span>
<a href="#l8.29"></a><span id="l8.29" class="difflineminus">-   */</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineminus">-  nsIAbDirFactory getDirFactory(in ACString aURI);</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineminus">-};</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/addrbook/public/nsIAbDirectory.idl</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/addrbook/public/nsIAbDirectory.idl</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -312,35 +312,16 @@ interface nsIAbDirectory : nsISupports {</span>
<a href="#l9.4"></a><span id="l9.4">    *                   values.</span>
<a href="#l9.5"></a><span id="l9.5">    */</span>
<a href="#l9.6"></a><span id="l9.6">   void editMailListToDatabase(in nsIAbCard listCard);</span>
<a href="#l9.7"></a><span id="l9.7"> </span>
<a href="#l9.8"></a><span id="l9.8">   // Copies mail list properties from the srcList</span>
<a href="#l9.9"></a><span id="l9.9">   void copyMailList(in nsIAbDirectory srcList);</span>
<a href="#l9.10"></a><span id="l9.10"> </span>
<a href="#l9.11"></a><span id="l9.11">   /**</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-   * Only creates a top level address book</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineminus">-   * which is stored in the preferences</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineminus">-   *</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineminus">-   * Need to change to factory based approach</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineminus">-   * to create new address books</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineminus">-   *</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineminus">-   * This method should become redundant or</span>
<a href="#l9.19"></a><span id="l9.19" class="difflineminus">-   * be only associated with card folders</span>
<a href="#l9.20"></a><span id="l9.20" class="difflineminus">-   *</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineminus">-   * The parameters are the same as for</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineminus">-   * nsIAbManager::newAddressBook</span>
<a href="#l9.23"></a><span id="l9.23" class="difflineminus">-   */</span>
<a href="#l9.24"></a><span id="l9.24" class="difflineminus">-  ACString createNewDirectory(in AString aDirName, in ACString aURI,</span>
<a href="#l9.25"></a><span id="l9.25" class="difflineminus">-                              in unsigned long aType, in ACString aPrefName);</span>
<a href="#l9.26"></a><span id="l9.26" class="difflineminus">-</span>
<a href="#l9.27"></a><span id="l9.27" class="difflineminus">-  /* create a directory by passing the display name and address book uri */</span>
<a href="#l9.28"></a><span id="l9.28" class="difflineminus">-  void createDirectoryByURI(in AString displayName, in ACString aURI);</span>
<a href="#l9.29"></a><span id="l9.29" class="difflineminus">-</span>
<a href="#l9.30"></a><span id="l9.30" class="difflineminus">-  /**</span>
<a href="#l9.31"></a><span id="l9.31">    * The id of the directory used in prefs e.g. &quot;ldap_2.servers.pab&quot;</span>
<a href="#l9.32"></a><span id="l9.32">    * Setting this will cause directoryPrefs to be updated.</span>
<a href="#l9.33"></a><span id="l9.33">    */</span>
<a href="#l9.34"></a><span id="l9.34">   attribute ACString dirPrefId;</span>
<a href="#l9.35"></a><span id="l9.35"> </span>
<a href="#l9.36"></a><span id="l9.36">   /**</span>
<a href="#l9.37"></a><span id="l9.37">    * @name  getXXXValue</span>
<a href="#l9.38"></a><span id="l9.38">    *</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/addrbook/src/moz.build</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/addrbook/src/moz.build</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -7,64 +7,54 @@ EXPORTS += [</span>
<a href="#l10.4"></a><span id="l10.4">     'nsAbDirProperty.h',</span>
<a href="#l10.5"></a><span id="l10.5">     'nsDirPrefs.h',</span>
<a href="#l10.6"></a><span id="l10.6">     'nsVCardObj.h',</span>
<a href="#l10.7"></a><span id="l10.7"> ]</span>
<a href="#l10.8"></a><span id="l10.8"> </span>
<a href="#l10.9"></a><span id="l10.9"> SOURCES += [</span>
<a href="#l10.10"></a><span id="l10.10">     'nsAbAddressCollector.cpp',</span>
<a href="#l10.11"></a><span id="l10.11">     'nsAbBooleanExpression.cpp',</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-    'nsAbBSDirectory.cpp',</span>
<a href="#l10.13"></a><span id="l10.13">     'nsAbCardProperty.cpp',</span>
<a href="#l10.14"></a><span id="l10.14">     'nsAbContentHandler.cpp',</span>
<a href="#l10.15"></a><span id="l10.15">     'nsAbDirectoryQuery.cpp',</span>
<a href="#l10.16"></a><span id="l10.16">     'nsAbDirectoryQueryProxy.cpp',</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineminus">-    'nsAbDirFactoryService.cpp',</span>
<a href="#l10.18"></a><span id="l10.18">     'nsAbDirProperty.cpp',</span>
<a href="#l10.19"></a><span id="l10.19">     'nsAbLDIFService.cpp',</span>
<a href="#l10.20"></a><span id="l10.20" class="difflineminus">-    # 'nsAbManager.cpp',</span>
<a href="#l10.21"></a><span id="l10.21">     'nsAbQueryStringToExpression.cpp',</span>
<a href="#l10.22"></a><span id="l10.22">     'nsAbView.cpp',</span>
<a href="#l10.23"></a><span id="l10.23">     'nsAddbookProtocolHandler.cpp',</span>
<a href="#l10.24"></a><span id="l10.24">     'nsAddbookUrl.cpp',</span>
<a href="#l10.25"></a><span id="l10.25">     'nsAddrDatabase.cpp',</span>
<a href="#l10.26"></a><span id="l10.26" class="difflineminus">-    'nsDirPrefs.cpp',</span>
<a href="#l10.27"></a><span id="l10.27">     'nsMsgVCardService.cpp',</span>
<a href="#l10.28"></a><span id="l10.28">     'nsVCard.cpp',</span>
<a href="#l10.29"></a><span id="l10.29">     'nsVCardObj.cpp',</span>
<a href="#l10.30"></a><span id="l10.30"> ]</span>
<a href="#l10.31"></a><span id="l10.31"> </span>
<a href="#l10.32"></a><span id="l10.32"> if CONFIG['OS_ARCH'] == 'WINNT' and CONFIG['MOZ_MAPI_SUPPORT']:</span>
<a href="#l10.33"></a><span id="l10.33">     SOURCES += [</span>
<a href="#l10.34"></a><span id="l10.34">         'nsAbOutlookDirectory.cpp',</span>
<a href="#l10.35"></a><span id="l10.35" class="difflineminus">-        'nsAbOutlookDirFactory.cpp',</span>
<a href="#l10.36"></a><span id="l10.36">         'nsAbWinHelper.cpp',</span>
<a href="#l10.37"></a><span id="l10.37">         'nsMapiAddressBook.cpp',</span>
<a href="#l10.38"></a><span id="l10.38">         'nsWabAddressBook.cpp',</span>
<a href="#l10.39"></a><span id="l10.39">     ]</span>
<a href="#l10.40"></a><span id="l10.40"> </span>
<a href="#l10.41"></a><span id="l10.41"> if CONFIG['OS_ARCH'] == 'Darwin':</span>
<a href="#l10.42"></a><span id="l10.42">     SOURCES += [</span>
<a href="#l10.43"></a><span id="l10.43" class="difflineminus">-        'nsAbOSXDirFactory.cpp',</span>
<a href="#l10.44"></a><span id="l10.44" class="difflineminus">-    ]</span>
<a href="#l10.45"></a><span id="l10.45" class="difflineminus">-</span>
<a href="#l10.46"></a><span id="l10.46" class="difflineminus">-    SOURCES += [</span>
<a href="#l10.47"></a><span id="l10.47">         'nsAbOSXCard.mm',</span>
<a href="#l10.48"></a><span id="l10.48">         'nsAbOSXDirectory.mm',</span>
<a href="#l10.49"></a><span id="l10.49">         'nsAbOSXUtils.mm',</span>
<a href="#l10.50"></a><span id="l10.50">     ]</span>
<a href="#l10.51"></a><span id="l10.51"> </span>
<a href="#l10.52"></a><span id="l10.52"> if CONFIG['MOZ_LDAP_XPCOM']:</span>
<a href="#l10.53"></a><span id="l10.53">     SOURCES += [</span>
<a href="#l10.54"></a><span id="l10.54">         'nsAbBoolExprToLDAPFilter.cpp',</span>
<a href="#l10.55"></a><span id="l10.55">         'nsAbLDAPCard.cpp',</span>
<a href="#l10.56"></a><span id="l10.56">         'nsAbLDAPDirectory.cpp',</span>
<a href="#l10.57"></a><span id="l10.57">         'nsAbLDAPDirectoryModify.cpp',</span>
<a href="#l10.58"></a><span id="l10.58">         'nsAbLDAPDirectoryQuery.cpp',</span>
<a href="#l10.59"></a><span id="l10.59" class="difflineminus">-        'nsAbLDAPDirFactory.cpp',</span>
<a href="#l10.60"></a><span id="l10.60">         'nsAbLDAPListenerBase.cpp',</span>
<a href="#l10.61"></a><span id="l10.61">         'nsAbLDAPReplicationData.cpp',</span>
<a href="#l10.62"></a><span id="l10.62">         'nsAbLDAPReplicationQuery.cpp',</span>
<a href="#l10.63"></a><span id="l10.63">         'nsAbLDAPReplicationService.cpp',</span>
<a href="#l10.64"></a><span id="l10.64">     ]</span>
<a href="#l10.65"></a><span id="l10.65">     # XXX These files are not being built as they don't work. Bug 311632 should</span>
<a href="#l10.66"></a><span id="l10.66">     # fix them.</span>
<a href="#l10.67"></a><span id="l10.67">     # nsAbLDAPChangeLogQuery.cpp</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1">deleted file mode 100644</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineminus">--- a/mailnews/addrbook/src/nsAbBSDirectory.cpp</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineplus">+++ /dev/null</span>
<a href="#l11.4"></a><span id="l11.4" class="difflineat">@@ -1,305 +0,0 @@</span>
<a href="#l11.5"></a><span id="l11.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l11.6"></a><span id="l11.6" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l11.7"></a><span id="l11.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l11.8"></a><span id="l11.8" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l11.9"></a><span id="l11.9" class="difflineminus">-</span>
<a href="#l11.10"></a><span id="l11.10" class="difflineminus">-#include &quot;nsAbBSDirectory.h&quot;</span>
<a href="#l11.11"></a><span id="l11.11" class="difflineminus">-</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-#include &quot;nsDirPrefs.h&quot;</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineminus">-#include &quot;nsAbBaseCID.h&quot;</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineminus">-#include &quot;nsAddrDatabase.h&quot;</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineminus">-#include &quot;nsIAbManager.h&quot;</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineminus">-#include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l11.17"></a><span id="l11.17" class="difflineminus">-#include &quot;nsAbDirFactoryService.h&quot;</span>
<a href="#l11.18"></a><span id="l11.18" class="difflineminus">-#include &quot;nsIAbDirFactory.h&quot;</span>
<a href="#l11.19"></a><span id="l11.19" class="difflineminus">-#include &quot;nsArrayEnumerator.h&quot;</span>
<a href="#l11.20"></a><span id="l11.20" class="difflineminus">-</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineminus">-#include &quot;nsCRTGlue.h&quot;</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineminus">-</span>
<a href="#l11.23"></a><span id="l11.23" class="difflineminus">-nsAbBSDirectory::nsAbBSDirectory() : mInitialized(false), mServers(13) {}</span>
<a href="#l11.24"></a><span id="l11.24" class="difflineminus">-</span>
<a href="#l11.25"></a><span id="l11.25" class="difflineminus">-nsAbBSDirectory::~nsAbBSDirectory() {}</span>
<a href="#l11.26"></a><span id="l11.26" class="difflineminus">-</span>
<a href="#l11.27"></a><span id="l11.27" class="difflineminus">-NS_IMETHODIMP nsAbBSDirectory::Init(const char *aURI) {</span>
<a href="#l11.28"></a><span id="l11.28" class="difflineminus">-  mURI = aURI;</span>
<a href="#l11.29"></a><span id="l11.29" class="difflineminus">-  return NS_OK;</span>
<a href="#l11.30"></a><span id="l11.30" class="difflineminus">-}</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineminus">-</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineminus">-NS_IMPL_ISUPPORTS_INHERITED0(nsAbBSDirectory, nsAbDirProperty)</span>
<a href="#l11.33"></a><span id="l11.33" class="difflineminus">-</span>
<a href="#l11.34"></a><span id="l11.34" class="difflineminus">-nsresult nsAbBSDirectory::CreateDirectoriesFromFactory(const nsACString &amp;aURI,</span>
<a href="#l11.35"></a><span id="l11.35" class="difflineminus">-                                                       DIR_Server *aServer,</span>
<a href="#l11.36"></a><span id="l11.36" class="difflineminus">-                                                       bool aNotify) {</span>
<a href="#l11.37"></a><span id="l11.37" class="difflineminus">-  nsresult rv;</span>
<a href="#l11.38"></a><span id="l11.38" class="difflineminus">-</span>
<a href="#l11.39"></a><span id="l11.39" class="difflineminus">-  // Get the directory factory service</span>
<a href="#l11.40"></a><span id="l11.40" class="difflineminus">-  nsCOMPtr&lt;nsIAbDirFactoryService&gt; dirFactoryService =</span>
<a href="#l11.41"></a><span id="l11.41" class="difflineminus">-      do_GetService(NS_ABDIRFACTORYSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l11.42"></a><span id="l11.42" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.43"></a><span id="l11.43" class="difflineminus">-</span>
<a href="#l11.44"></a><span id="l11.44" class="difflineminus">-  // Get the directory factory from the URI</span>
<a href="#l11.45"></a><span id="l11.45" class="difflineminus">-  nsCOMPtr&lt;nsIAbDirFactory&gt; dirFactory;</span>
<a href="#l11.46"></a><span id="l11.46" class="difflineminus">-  rv = dirFactoryService-&gt;GetDirFactory(aURI, getter_AddRefs(dirFactory));</span>
<a href="#l11.47"></a><span id="l11.47" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.48"></a><span id="l11.48" class="difflineminus">-</span>
<a href="#l11.49"></a><span id="l11.49" class="difflineminus">-  // Create the directories</span>
<a href="#l11.50"></a><span id="l11.50" class="difflineminus">-  nsCOMPtr&lt;nsISimpleEnumerator&gt; newDirEnumerator;</span>
<a href="#l11.51"></a><span id="l11.51" class="difflineminus">-  rv = dirFactory-&gt;GetDirectories(NS_ConvertUTF8toUTF16(aServer-&gt;description),</span>
<a href="#l11.52"></a><span id="l11.52" class="difflineminus">-                                  aURI, nsDependentCString(aServer-&gt;prefName),</span>
<a href="#l11.53"></a><span id="l11.53" class="difflineminus">-                                  getter_AddRefs(newDirEnumerator));</span>
<a href="#l11.54"></a><span id="l11.54" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.55"></a><span id="l11.55" class="difflineminus">-</span>
<a href="#l11.56"></a><span id="l11.56" class="difflineminus">-  // Enumerate through the directories adding them</span>
<a href="#l11.57"></a><span id="l11.57" class="difflineminus">-  // to the sub directories array</span>
<a href="#l11.58"></a><span id="l11.58" class="difflineminus">-  bool hasMore;</span>
<a href="#l11.59"></a><span id="l11.59" class="difflineminus">-  nsCOMPtr&lt;nsIAbManager&gt; abManager =</span>
<a href="#l11.60"></a><span id="l11.60" class="difflineminus">-      do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l11.61"></a><span id="l11.61" class="difflineminus">-</span>
<a href="#l11.62"></a><span id="l11.62" class="difflineminus">-  while (NS_SUCCEEDED(newDirEnumerator-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore) {</span>
<a href="#l11.63"></a><span id="l11.63" class="difflineminus">-    nsCOMPtr&lt;nsISupports&gt; newDirSupports;</span>
<a href="#l11.64"></a><span id="l11.64" class="difflineminus">-    rv = newDirEnumerator-&gt;GetNext(getter_AddRefs(newDirSupports));</span>
<a href="#l11.65"></a><span id="l11.65" class="difflineminus">-    if (NS_FAILED(rv)) continue;</span>
<a href="#l11.66"></a><span id="l11.66" class="difflineminus">-</span>
<a href="#l11.67"></a><span id="l11.67" class="difflineminus">-    nsCOMPtr&lt;nsIAbDirectory&gt; childDir = do_QueryInterface(newDirSupports, &amp;rv);</span>
<a href="#l11.68"></a><span id="l11.68" class="difflineminus">-    if (NS_FAILED(rv)) continue;</span>
<a href="#l11.69"></a><span id="l11.69" class="difflineminus">-</span>
<a href="#l11.70"></a><span id="l11.70" class="difflineminus">-    // In some cases (LDAP) the actual URI of the directory may differ from</span>
<a href="#l11.71"></a><span id="l11.71" class="difflineminus">-    // aURI. Use the URI of the directory.</span>
<a href="#l11.72"></a><span id="l11.72" class="difflineminus">-    nsCString uri;</span>
<a href="#l11.73"></a><span id="l11.73" class="difflineminus">-    childDir-&gt;GetURI(uri);</span>
<a href="#l11.74"></a><span id="l11.74" class="difflineminus">-</span>
<a href="#l11.75"></a><span id="l11.75" class="difflineminus">-    // Define a relationship between the preference entry and the directory.</span>
<a href="#l11.76"></a><span id="l11.76" class="difflineminus">-    mServers.Put(uri, aServer);</span>
<a href="#l11.77"></a><span id="l11.77" class="difflineminus">-</span>
<a href="#l11.78"></a><span id="l11.78" class="difflineminus">-    mSubDirectories.AppendObject(childDir);</span>
<a href="#l11.79"></a><span id="l11.79" class="difflineminus">-</span>
<a href="#l11.80"></a><span id="l11.80" class="difflineminus">-    if (aNotify &amp;&amp; abManager)</span>
<a href="#l11.81"></a><span id="l11.81" class="difflineminus">-      abManager-&gt;NotifyDirectoryItemAdded(this, childDir);</span>
<a href="#l11.82"></a><span id="l11.82" class="difflineminus">-  }</span>
<a href="#l11.83"></a><span id="l11.83" class="difflineminus">-</span>
<a href="#l11.84"></a><span id="l11.84" class="difflineminus">-  return NS_OK;</span>
<a href="#l11.85"></a><span id="l11.85" class="difflineminus">-}</span>
<a href="#l11.86"></a><span id="l11.86" class="difflineminus">-</span>
<a href="#l11.87"></a><span id="l11.87" class="difflineminus">-NS_IMETHODIMP nsAbBSDirectory::GetChildNodes(nsISimpleEnumerator **aResult) {</span>
<a href="#l11.88"></a><span id="l11.88" class="difflineminus">-  nsresult rv = EnsureInitialized();</span>
<a href="#l11.89"></a><span id="l11.89" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.90"></a><span id="l11.90" class="difflineminus">-</span>
<a href="#l11.91"></a><span id="l11.91" class="difflineminus">-  return NS_NewArrayEnumerator(aResult, mSubDirectories,</span>
<a href="#l11.92"></a><span id="l11.92" class="difflineminus">-                               NS_GET_IID(nsIAbDirectory));</span>
<a href="#l11.93"></a><span id="l11.93" class="difflineminus">-}</span>
<a href="#l11.94"></a><span id="l11.94" class="difflineminus">-</span>
<a href="#l11.95"></a><span id="l11.95" class="difflineminus">-nsresult nsAbBSDirectory::EnsureInitialized() {</span>
<a href="#l11.96"></a><span id="l11.96" class="difflineminus">-  if (mInitialized) return NS_OK;</span>
<a href="#l11.97"></a><span id="l11.97" class="difflineminus">-</span>
<a href="#l11.98"></a><span id="l11.98" class="difflineminus">-  nsresult rv;</span>
<a href="#l11.99"></a><span id="l11.99" class="difflineminus">-  nsCOMPtr&lt;nsIAbDirFactoryService&gt; dirFactoryService =</span>
<a href="#l11.100"></a><span id="l11.100" class="difflineminus">-      do_GetService(NS_ABDIRFACTORYSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l11.101"></a><span id="l11.101" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.102"></a><span id="l11.102" class="difflineminus">-</span>
<a href="#l11.103"></a><span id="l11.103" class="difflineminus">-  nsTArray&lt;DIR_Server *&gt; *directories = DIR_GetDirectories();</span>
<a href="#l11.104"></a><span id="l11.104" class="difflineminus">-  if (!directories) return NS_ERROR_FAILURE;</span>
<a href="#l11.105"></a><span id="l11.105" class="difflineminus">-</span>
<a href="#l11.106"></a><span id="l11.106" class="difflineminus">-  int32_t count = directories-&gt;Length();</span>
<a href="#l11.107"></a><span id="l11.107" class="difflineminus">-  for (int32_t i = 0; i &lt; count; i++) {</span>
<a href="#l11.108"></a><span id="l11.108" class="difflineminus">-    DIR_Server *server = directories-&gt;ElementAt(i);</span>
<a href="#l11.109"></a><span id="l11.109" class="difflineminus">-</span>
<a href="#l11.110"></a><span id="l11.110" class="difflineminus">-    // if this is a 4.x, local .na2 addressbook (PABDirectory)</span>
<a href="#l11.111"></a><span id="l11.111" class="difflineminus">-    // we must skip it.</span>
<a href="#l11.112"></a><span id="l11.112" class="difflineminus">-    // mozilla can't handle 4.x .na2 addressbooks</span>
<a href="#l11.113"></a><span id="l11.113" class="difflineminus">-    // note, the filename might be na2 for 4.x LDAP directories</span>
<a href="#l11.114"></a><span id="l11.114" class="difflineminus">-    // (we used the .na2 file for replication), and we don't want to skip</span>
<a href="#l11.115"></a><span id="l11.115" class="difflineminus">-    // those.  see bug #127007</span>
<a href="#l11.116"></a><span id="l11.116" class="difflineminus">-    uint32_t fileNameLen = strlen(server-&gt;fileName);</span>
<a href="#l11.117"></a><span id="l11.117" class="difflineminus">-    if (((fileNameLen &gt; kABFileName_PreviousSuffixLen) &amp;&amp;</span>
<a href="#l11.118"></a><span id="l11.118" class="difflineminus">-         strcmp(server-&gt;fileName + fileNameLen - kABFileName_PreviousSuffixLen,</span>
<a href="#l11.119"></a><span id="l11.119" class="difflineminus">-                kABFileName_PreviousSuffix) == 0) &amp;&amp;</span>
<a href="#l11.120"></a><span id="l11.120" class="difflineminus">-        (server-&gt;dirType == PABDirectory))</span>
<a href="#l11.121"></a><span id="l11.121" class="difflineminus">-      continue;</span>
<a href="#l11.122"></a><span id="l11.122" class="difflineminus">-</span>
<a href="#l11.123"></a><span id="l11.123" class="difflineminus">-    // Set the uri property</span>
<a href="#l11.124"></a><span id="l11.124" class="difflineminus">-    nsAutoCString URI(server-&gt;uri);</span>
<a href="#l11.125"></a><span id="l11.125" class="difflineminus">-</span>
<a href="#l11.126"></a><span id="l11.126" class="difflineminus">-    // Create the directories</span>
<a href="#l11.127"></a><span id="l11.127" class="difflineminus">-    rv = CreateDirectoriesFromFactory(URI, server, false /* notify */);</span>
<a href="#l11.128"></a><span id="l11.128" class="difflineminus">-</span>
<a href="#l11.129"></a><span id="l11.129" class="difflineminus">-    // If we failed, this could be because something has set a pref for us</span>
<a href="#l11.130"></a><span id="l11.130" class="difflineminus">-    // which is now broke (e.g. no factory present). So just ignore this one</span>
<a href="#l11.131"></a><span id="l11.131" class="difflineminus">-    // and move on.</span>
<a href="#l11.132"></a><span id="l11.132" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l11.133"></a><span id="l11.133" class="difflineminus">-      NS_WARNING(&quot;CreateDirectoriesFromFactory failed - Invalid factory?&quot;);</span>
<a href="#l11.134"></a><span id="l11.134" class="difflineminus">-  }</span>
<a href="#l11.135"></a><span id="l11.135" class="difflineminus">-</span>
<a href="#l11.136"></a><span id="l11.136" class="difflineminus">-  mInitialized = true;</span>
<a href="#l11.137"></a><span id="l11.137" class="difflineminus">-  // sort directories by position...</span>
<a href="#l11.138"></a><span id="l11.138" class="difflineminus">-  return NS_OK;</span>
<a href="#l11.139"></a><span id="l11.139" class="difflineminus">-}</span>
<a href="#l11.140"></a><span id="l11.140" class="difflineminus">-</span>
<a href="#l11.141"></a><span id="l11.141" class="difflineminus">-NS_IMETHODIMP nsAbBSDirectory::CreateNewDirectory(const nsAString &amp;aDirName,</span>
<a href="#l11.142"></a><span id="l11.142" class="difflineminus">-                                                  const nsACString &amp;aURI,</span>
<a href="#l11.143"></a><span id="l11.143" class="difflineminus">-                                                  uint32_t aType,</span>
<a href="#l11.144"></a><span id="l11.144" class="difflineminus">-                                                  const nsACString &amp;aPrefName,</span>
<a href="#l11.145"></a><span id="l11.145" class="difflineminus">-                                                  nsACString &amp;aResult) {</span>
<a href="#l11.146"></a><span id="l11.146" class="difflineminus">-  nsresult rv = EnsureInitialized();</span>
<a href="#l11.147"></a><span id="l11.147" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.148"></a><span id="l11.148" class="difflineminus">-</span>
<a href="#l11.149"></a><span id="l11.149" class="difflineminus">-  /*</span>
<a href="#l11.150"></a><span id="l11.150" class="difflineminus">-   * TODO</span>
<a href="#l11.151"></a><span id="l11.151" class="difflineminus">-   * This procedure is still MDB specific</span>
<a href="#l11.152"></a><span id="l11.152" class="difflineminus">-   * due to the dependence on the current</span>
<a href="#l11.153"></a><span id="l11.153" class="difflineminus">-   * nsDirPref.cpp code</span>
<a href="#l11.154"></a><span id="l11.154" class="difflineminus">-   */</span>
<a href="#l11.155"></a><span id="l11.155" class="difflineminus">-</span>
<a href="#l11.156"></a><span id="l11.156" class="difflineminus">-  nsCString URI(aURI);</span>
<a href="#l11.157"></a><span id="l11.157" class="difflineminus">-</span>
<a href="#l11.158"></a><span id="l11.158" class="difflineminus">-  /*</span>
<a href="#l11.159"></a><span id="l11.159" class="difflineminus">-   * The creation of the address book in the preferences</span>
<a href="#l11.160"></a><span id="l11.160" class="difflineminus">-   * is very MDB implementation specific.</span>
<a href="#l11.161"></a><span id="l11.161" class="difflineminus">-   * If the fileName attribute is null then it will</span>
<a href="#l11.162"></a><span id="l11.162" class="difflineminus">-   * create an appropriate file name.</span>
<a href="#l11.163"></a><span id="l11.163" class="difflineminus">-   * Somehow have to resolve this issue so that it</span>
<a href="#l11.164"></a><span id="l11.164" class="difflineminus">-   * is more general.</span>
<a href="#l11.165"></a><span id="l11.165" class="difflineminus">-   *</span>
<a href="#l11.166"></a><span id="l11.166" class="difflineminus">-   */</span>
<a href="#l11.167"></a><span id="l11.167" class="difflineminus">-  DIR_Server *server = nullptr;</span>
<a href="#l11.168"></a><span id="l11.168" class="difflineminus">-  rv = DIR_AddNewAddressBook(aDirName, EmptyCString(), URI,</span>
<a href="#l11.169"></a><span id="l11.169" class="difflineminus">-                             (DirectoryType)aType, aPrefName, &amp;server);</span>
<a href="#l11.170"></a><span id="l11.170" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.171"></a><span id="l11.171" class="difflineminus">-</span>
<a href="#l11.172"></a><span id="l11.172" class="difflineminus">-  if (aType == JSDirectory) {</span>
<a href="#l11.173"></a><span id="l11.173" class="difflineminus">-    URI.AssignLiteral(kJSDirectoryRoot);</span>
<a href="#l11.174"></a><span id="l11.174" class="difflineminus">-    URI.Append(nsDependentCString(server-&gt;fileName));</span>
<a href="#l11.175"></a><span id="l11.175" class="difflineminus">-  }</span>
<a href="#l11.176"></a><span id="l11.176" class="difflineminus">-</span>
<a href="#l11.177"></a><span id="l11.177" class="difflineminus">-  aResult.Assign(server-&gt;prefName);</span>
<a href="#l11.178"></a><span id="l11.178" class="difflineminus">-</span>
<a href="#l11.179"></a><span id="l11.179" class="difflineminus">-  rv = CreateDirectoriesFromFactory(URI, server, true /* notify */);</span>
<a href="#l11.180"></a><span id="l11.180" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.181"></a><span id="l11.181" class="difflineminus">-  return rv;</span>
<a href="#l11.182"></a><span id="l11.182" class="difflineminus">-}</span>
<a href="#l11.183"></a><span id="l11.183" class="difflineminus">-</span>
<a href="#l11.184"></a><span id="l11.184" class="difflineminus">-NS_IMETHODIMP nsAbBSDirectory::CreateDirectoryByURI(</span>
<a href="#l11.185"></a><span id="l11.185" class="difflineminus">-    const nsAString &amp;aDisplayName, const nsACString &amp;aURI) {</span>
<a href="#l11.186"></a><span id="l11.186" class="difflineminus">-  nsresult rv = EnsureInitialized();</span>
<a href="#l11.187"></a><span id="l11.187" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.188"></a><span id="l11.188" class="difflineminus">-</span>
<a href="#l11.189"></a><span id="l11.189" class="difflineminus">-  DIR_Server *server = nullptr;</span>
<a href="#l11.190"></a><span id="l11.190" class="difflineminus">-  rv = DIR_AddNewAddressBook(aDisplayName, EmptyCString(), aURI, PABDirectory,</span>
<a href="#l11.191"></a><span id="l11.191" class="difflineminus">-                             EmptyCString(), &amp;server);</span>
<a href="#l11.192"></a><span id="l11.192" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.193"></a><span id="l11.193" class="difflineminus">-</span>
<a href="#l11.194"></a><span id="l11.194" class="difflineminus">-  rv = CreateDirectoriesFromFactory(aURI, server, true /* notify */);</span>
<a href="#l11.195"></a><span id="l11.195" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.196"></a><span id="l11.196" class="difflineminus">-  return rv;</span>
<a href="#l11.197"></a><span id="l11.197" class="difflineminus">-}</span>
<a href="#l11.198"></a><span id="l11.198" class="difflineminus">-</span>
<a href="#l11.199"></a><span id="l11.199" class="difflineminus">-NS_IMETHODIMP nsAbBSDirectory::DeleteDirectory(nsIAbDirectory *directory) {</span>
<a href="#l11.200"></a><span id="l11.200" class="difflineminus">-  NS_ENSURE_ARG_POINTER(directory);</span>
<a href="#l11.201"></a><span id="l11.201" class="difflineminus">-</span>
<a href="#l11.202"></a><span id="l11.202" class="difflineminus">-  nsresult rv = EnsureInitialized();</span>
<a href="#l11.203"></a><span id="l11.203" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.204"></a><span id="l11.204" class="difflineminus">-</span>
<a href="#l11.205"></a><span id="l11.205" class="difflineminus">-  nsCString uri;</span>
<a href="#l11.206"></a><span id="l11.206" class="difflineminus">-  directory-&gt;GetURI(uri);</span>
<a href="#l11.207"></a><span id="l11.207" class="difflineminus">-</span>
<a href="#l11.208"></a><span id="l11.208" class="difflineminus">-  DIR_Server *server = nullptr;</span>
<a href="#l11.209"></a><span id="l11.209" class="difflineminus">-  mServers.Get(uri, &amp;server);</span>
<a href="#l11.210"></a><span id="l11.210" class="difflineminus">-</span>
<a href="#l11.211"></a><span id="l11.211" class="difflineminus">-  if (!server) return NS_ERROR_FAILURE;</span>
<a href="#l11.212"></a><span id="l11.212" class="difflineminus">-</span>
<a href="#l11.213"></a><span id="l11.213" class="difflineminus">-  nsCOMPtr&lt;nsIAbManager&gt; abManager =</span>
<a href="#l11.214"></a><span id="l11.214" class="difflineminus">-      do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l11.215"></a><span id="l11.215" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.216"></a><span id="l11.216" class="difflineminus">-</span>
<a href="#l11.217"></a><span id="l11.217" class="difflineminus">-  nsCOMPtr&lt;nsISimpleEnumerator&gt; dirEnumerator;</span>
<a href="#l11.218"></a><span id="l11.218" class="difflineminus">-  abManager-&gt;GetDirectories(getter_AddRefs(dirEnumerator));</span>
<a href="#l11.219"></a><span id="l11.219" class="difflineminus">-</span>
<a href="#l11.220"></a><span id="l11.220" class="difflineminus">-  nsCOMArray&lt;nsIAbDirectory&gt; directories;</span>
<a href="#l11.221"></a><span id="l11.221" class="difflineminus">-  bool hasMore;</span>
<a href="#l11.222"></a><span id="l11.222" class="difflineminus">-  while (NS_SUCCEEDED(dirEnumerator-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore) {</span>
<a href="#l11.223"></a><span id="l11.223" class="difflineminus">-    nsCOMPtr&lt;nsISupports&gt; dirSupports;</span>
<a href="#l11.224"></a><span id="l11.224" class="difflineminus">-    rv = dirEnumerator-&gt;GetNext(getter_AddRefs(dirSupports));</span>
<a href="#l11.225"></a><span id="l11.225" class="difflineminus">-    if (NS_FAILED(rv)) continue;</span>
<a href="#l11.226"></a><span id="l11.226" class="difflineminus">-</span>
<a href="#l11.227"></a><span id="l11.227" class="difflineminus">-    nsCOMPtr&lt;nsIAbDirectory&gt; d = do_QueryInterface(dirSupports, &amp;rv);</span>
<a href="#l11.228"></a><span id="l11.228" class="difflineminus">-    if (NS_FAILED(rv)) continue;</span>
<a href="#l11.229"></a><span id="l11.229" class="difflineminus">-</span>
<a href="#l11.230"></a><span id="l11.230" class="difflineminus">-    nsCString u;</span>
<a href="#l11.231"></a><span id="l11.231" class="difflineminus">-    d-&gt;GetURI(u);</span>
<a href="#l11.232"></a><span id="l11.232" class="difflineminus">-</span>
<a href="#l11.233"></a><span id="l11.233" class="difflineminus">-    DIR_Server *s;</span>
<a href="#l11.234"></a><span id="l11.234" class="difflineminus">-    mServers.Get(u, &amp;s);</span>
<a href="#l11.235"></a><span id="l11.235" class="difflineminus">-</span>
<a href="#l11.236"></a><span id="l11.236" class="difflineminus">-    if (s &amp;&amp; s == server) {</span>
<a href="#l11.237"></a><span id="l11.237" class="difflineminus">-      if (d) {</span>
<a href="#l11.238"></a><span id="l11.238" class="difflineminus">-        directories.AppendElement(d);</span>
<a href="#l11.239"></a><span id="l11.239" class="difflineminus">-      }</span>
<a href="#l11.240"></a><span id="l11.240" class="difflineminus">-    }</span>
<a href="#l11.241"></a><span id="l11.241" class="difflineminus">-  }</span>
<a href="#l11.242"></a><span id="l11.242" class="difflineminus">-</span>
<a href="#l11.243"></a><span id="l11.243" class="difflineminus">-  DIR_DeleteServerFromList(server);</span>
<a href="#l11.244"></a><span id="l11.244" class="difflineminus">-</span>
<a href="#l11.245"></a><span id="l11.245" class="difflineminus">-  nsCOMPtr&lt;nsIAbDirFactoryService&gt; dirFactoryService =</span>
<a href="#l11.246"></a><span id="l11.246" class="difflineminus">-      do_GetService(NS_ABDIRFACTORYSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l11.247"></a><span id="l11.247" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.248"></a><span id="l11.248" class="difflineminus">-</span>
<a href="#l11.249"></a><span id="l11.249" class="difflineminus">-  uint32_t count = directories.Count();</span>
<a href="#l11.250"></a><span id="l11.250" class="difflineminus">-</span>
<a href="#l11.251"></a><span id="l11.251" class="difflineminus">-  for (uint32_t i = 0; i &lt; count; i++) {</span>
<a href="#l11.252"></a><span id="l11.252" class="difflineminus">-    nsCOMPtr&lt;nsIAbDirectory&gt; d = directories[i];</span>
<a href="#l11.253"></a><span id="l11.253" class="difflineminus">-</span>
<a href="#l11.254"></a><span id="l11.254" class="difflineminus">-    nsCString uri;</span>
<a href="#l11.255"></a><span id="l11.255" class="difflineminus">-    rv = d-&gt;GetURI(uri);</span>
<a href="#l11.256"></a><span id="l11.256" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.257"></a><span id="l11.257" class="difflineminus">-</span>
<a href="#l11.258"></a><span id="l11.258" class="difflineminus">-    mServers.Remove(uri);</span>
<a href="#l11.259"></a><span id="l11.259" class="difflineminus">-</span>
<a href="#l11.260"></a><span id="l11.260" class="difflineminus">-    for (uint32_t i = 0; i &lt; mSubDirectories.Length(); ++i) {</span>
<a href="#l11.261"></a><span id="l11.261" class="difflineminus">-      nsAutoCString u;</span>
<a href="#l11.262"></a><span id="l11.262" class="difflineminus">-      mSubDirectories[i]-&gt;GetURI(u);</span>
<a href="#l11.263"></a><span id="l11.263" class="difflineminus">-      if (u.Equals(uri)) {</span>
<a href="#l11.264"></a><span id="l11.264" class="difflineminus">-        mSubDirectories.RemoveObjectsAt(i, 1);</span>
<a href="#l11.265"></a><span id="l11.265" class="difflineminus">-        break;</span>
<a href="#l11.266"></a><span id="l11.266" class="difflineminus">-      }</span>
<a href="#l11.267"></a><span id="l11.267" class="difflineminus">-    }</span>
<a href="#l11.268"></a><span id="l11.268" class="difflineminus">-</span>
<a href="#l11.269"></a><span id="l11.269" class="difflineminus">-    if (abManager) abManager-&gt;NotifyDirectoryDeleted(this, d);</span>
<a href="#l11.270"></a><span id="l11.270" class="difflineminus">-</span>
<a href="#l11.271"></a><span id="l11.271" class="difflineminus">-    nsCOMPtr&lt;nsIAbDirFactory&gt; dirFactory;</span>
<a href="#l11.272"></a><span id="l11.272" class="difflineminus">-    rv = dirFactoryService-&gt;GetDirFactory(uri, getter_AddRefs(dirFactory));</span>
<a href="#l11.273"></a><span id="l11.273" class="difflineminus">-    if (NS_FAILED(rv)) continue;</span>
<a href="#l11.274"></a><span id="l11.274" class="difflineminus">-</span>
<a href="#l11.275"></a><span id="l11.275" class="difflineminus">-    rv = dirFactory-&gt;DeleteDirectory(d);</span>
<a href="#l11.276"></a><span id="l11.276" class="difflineminus">-  }</span>
<a href="#l11.277"></a><span id="l11.277" class="difflineminus">-</span>
<a href="#l11.278"></a><span id="l11.278" class="difflineminus">-  return rv;</span>
<a href="#l11.279"></a><span id="l11.279" class="difflineminus">-}</span>
<a href="#l11.280"></a><span id="l11.280" class="difflineminus">-</span>
<a href="#l11.281"></a><span id="l11.281" class="difflineminus">-NS_IMETHODIMP nsAbBSDirectory::HasDirectory(nsIAbDirectory *dir, bool *hasDir) {</span>
<a href="#l11.282"></a><span id="l11.282" class="difflineminus">-  if (!hasDir) return NS_ERROR_NULL_POINTER;</span>
<a href="#l11.283"></a><span id="l11.283" class="difflineminus">-</span>
<a href="#l11.284"></a><span id="l11.284" class="difflineminus">-  nsresult rv = EnsureInitialized();</span>
<a href="#l11.285"></a><span id="l11.285" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.286"></a><span id="l11.286" class="difflineminus">-</span>
<a href="#l11.287"></a><span id="l11.287" class="difflineminus">-  nsCString uri;</span>
<a href="#l11.288"></a><span id="l11.288" class="difflineminus">-  dir-&gt;GetURI(uri);</span>
<a href="#l11.289"></a><span id="l11.289" class="difflineminus">-</span>
<a href="#l11.290"></a><span id="l11.290" class="difflineminus">-  DIR_Server *dirServer = nullptr;</span>
<a href="#l11.291"></a><span id="l11.291" class="difflineminus">-  mServers.Get(uri, &amp;dirServer);</span>
<a href="#l11.292"></a><span id="l11.292" class="difflineminus">-  return DIR_ContainsServer(dirServer, hasDir);</span>
<a href="#l11.293"></a><span id="l11.293" class="difflineminus">-}</span>
<a href="#l11.294"></a><span id="l11.294" class="difflineminus">-</span>
<a href="#l11.295"></a><span id="l11.295" class="difflineminus">-NS_IMETHODIMP nsAbBSDirectory::UseForAutocomplete(</span>
<a href="#l11.296"></a><span id="l11.296" class="difflineminus">-    const nsACString &amp;aIdentityKey, bool *aResult) {</span>
<a href="#l11.297"></a><span id="l11.297" class="difflineminus">-  // For the &quot;root&quot; directory (kAllDirectoryRoot) always return true so that</span>
<a href="#l11.298"></a><span id="l11.298" class="difflineminus">-  // we can search sub directories that may or may not be local.</span>
<a href="#l11.299"></a><span id="l11.299" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l11.300"></a><span id="l11.300" class="difflineminus">-  *aResult = true;</span>
<a href="#l11.301"></a><span id="l11.301" class="difflineminus">-  return NS_OK;</span>
<a href="#l11.302"></a><span id="l11.302" class="difflineminus">-}</span>
<a href="#l11.303"></a><span id="l11.303" class="difflineminus">-</span>
<a href="#l11.304"></a><span id="l11.304" class="difflineminus">-NS_IMETHODIMP nsAbBSDirectory::GetURI(nsACString &amp;aURI) {</span>
<a href="#l11.305"></a><span id="l11.305" class="difflineminus">-  if (mURI.IsEmpty()) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l11.306"></a><span id="l11.306" class="difflineminus">-</span>
<a href="#l11.307"></a><span id="l11.307" class="difflineminus">-  aURI = mURI;</span>
<a href="#l11.308"></a><span id="l11.308" class="difflineminus">-  return NS_OK;</span>
<a href="#l11.309"></a><span id="l11.309" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1">deleted file mode 100644</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineminus">--- a/mailnews/addrbook/src/nsAbBSDirectory.h</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineplus">+++ /dev/null</span>
<a href="#l12.4"></a><span id="l12.4" class="difflineat">@@ -1,48 +0,0 @@</span>
<a href="#l12.5"></a><span id="l12.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l12.6"></a><span id="l12.6" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l12.7"></a><span id="l12.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l12.8"></a><span id="l12.8" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l12.9"></a><span id="l12.9" class="difflineminus">-</span>
<a href="#l12.10"></a><span id="l12.10" class="difflineminus">-#ifndef nsAbBSDirectory_h__</span>
<a href="#l12.11"></a><span id="l12.11" class="difflineminus">-#define nsAbBSDirectory_h__</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineminus">-#include &quot;mozilla/Attributes.h&quot;</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineminus">-#include &quot;nsAbDirProperty.h&quot;</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineminus">-</span>
<a href="#l12.16"></a><span id="l12.16" class="difflineminus">-#include &quot;nsDataHashtable.h&quot;</span>
<a href="#l12.17"></a><span id="l12.17" class="difflineminus">-#include &quot;nsCOMArray.h&quot;</span>
<a href="#l12.18"></a><span id="l12.18" class="difflineminus">-</span>
<a href="#l12.19"></a><span id="l12.19" class="difflineminus">-class nsAbBSDirectory : public nsAbDirProperty {</span>
<a href="#l12.20"></a><span id="l12.20" class="difflineminus">- public:</span>
<a href="#l12.21"></a><span id="l12.21" class="difflineminus">-  NS_DECL_ISUPPORTS_INHERITED</span>
<a href="#l12.22"></a><span id="l12.22" class="difflineminus">-</span>
<a href="#l12.23"></a><span id="l12.23" class="difflineminus">-  nsAbBSDirectory();</span>
<a href="#l12.24"></a><span id="l12.24" class="difflineminus">-</span>
<a href="#l12.25"></a><span id="l12.25" class="difflineminus">-  // nsIAbDirectory methods</span>
<a href="#l12.26"></a><span id="l12.26" class="difflineminus">-  NS_IMETHOD Init(const char *aURI) override;</span>
<a href="#l12.27"></a><span id="l12.27" class="difflineminus">-  NS_IMETHOD GetChildNodes(nsISimpleEnumerator **result) override;</span>
<a href="#l12.28"></a><span id="l12.28" class="difflineminus">-  NS_IMETHOD CreateNewDirectory(const nsAString &amp;aDirName,</span>
<a href="#l12.29"></a><span id="l12.29" class="difflineminus">-                                const nsACString &amp;aURI, uint32_t aType,</span>
<a href="#l12.30"></a><span id="l12.30" class="difflineminus">-                                const nsACString &amp;aPrefName,</span>
<a href="#l12.31"></a><span id="l12.31" class="difflineminus">-                                nsACString &amp;aResult) override;</span>
<a href="#l12.32"></a><span id="l12.32" class="difflineminus">-  NS_IMETHOD CreateDirectoryByURI(const nsAString &amp;aDisplayName,</span>
<a href="#l12.33"></a><span id="l12.33" class="difflineminus">-                                  const nsACString &amp;aURI) override;</span>
<a href="#l12.34"></a><span id="l12.34" class="difflineminus">-  NS_IMETHOD DeleteDirectory(nsIAbDirectory *directory) override;</span>
<a href="#l12.35"></a><span id="l12.35" class="difflineminus">-  NS_IMETHOD HasDirectory(nsIAbDirectory *dir, bool *hasDir) override;</span>
<a href="#l12.36"></a><span id="l12.36" class="difflineminus">-  NS_IMETHOD UseForAutocomplete(const nsACString &amp;aIdentityKey,</span>
<a href="#l12.37"></a><span id="l12.37" class="difflineminus">-                                bool *aResult) override;</span>
<a href="#l12.38"></a><span id="l12.38" class="difflineminus">-  NS_IMETHOD GetURI(nsACString &amp;aURI) override;</span>
<a href="#l12.39"></a><span id="l12.39" class="difflineminus">-</span>
<a href="#l12.40"></a><span id="l12.40" class="difflineminus">- protected:</span>
<a href="#l12.41"></a><span id="l12.41" class="difflineminus">-  virtual ~nsAbBSDirectory();</span>
<a href="#l12.42"></a><span id="l12.42" class="difflineminus">-  nsresult EnsureInitialized();</span>
<a href="#l12.43"></a><span id="l12.43" class="difflineminus">-  nsresult CreateDirectoriesFromFactory(const nsACString &amp;aURI,</span>
<a href="#l12.44"></a><span id="l12.44" class="difflineminus">-                                        DIR_Server *aServer, bool aNotify);</span>
<a href="#l12.45"></a><span id="l12.45" class="difflineminus">-</span>
<a href="#l12.46"></a><span id="l12.46" class="difflineminus">- protected:</span>
<a href="#l12.47"></a><span id="l12.47" class="difflineminus">-  bool mInitialized;</span>
<a href="#l12.48"></a><span id="l12.48" class="difflineminus">-  nsCOMArray&lt;nsIAbDirectory&gt; mSubDirectories;</span>
<a href="#l12.49"></a><span id="l12.49" class="difflineminus">-  nsDataHashtable&lt;nsCStringHashKey, DIR_Server *&gt; mServers;</span>
<a href="#l12.50"></a><span id="l12.50" class="difflineminus">-};</span>
<a href="#l12.51"></a><span id="l12.51" class="difflineminus">-</span>
<a href="#l12.52"></a><span id="l12.52" class="difflineminus">-#endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1">deleted file mode 100644</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineminus">--- a/mailnews/addrbook/src/nsAbDirFactoryService.cpp</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineplus">+++ /dev/null</span>
<a href="#l13.4"></a><span id="l13.4" class="difflineat">@@ -1,48 +0,0 @@</span>
<a href="#l13.5"></a><span id="l13.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l13.6"></a><span id="l13.6" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l13.7"></a><span id="l13.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l13.8"></a><span id="l13.8" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l13.9"></a><span id="l13.9" class="difflineminus">-</span>
<a href="#l13.10"></a><span id="l13.10" class="difflineminus">-#include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l13.11"></a><span id="l13.11" class="difflineminus">-#include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-#include &quot;nsIIOService.h&quot;</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineminus">-#include &quot;nsNetCID.h&quot;</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineminus">-#include &quot;nsMemory.h&quot;</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineminus">-#include &quot;nsString.h&quot;</span>
<a href="#l13.16"></a><span id="l13.16" class="difflineminus">-#include &quot;plstr.h&quot;</span>
<a href="#l13.17"></a><span id="l13.17" class="difflineminus">-</span>
<a href="#l13.18"></a><span id="l13.18" class="difflineminus">-#include &quot;nsAbBaseCID.h&quot;</span>
<a href="#l13.19"></a><span id="l13.19" class="difflineminus">-#include &quot;nsAbDirFactoryService.h&quot;</span>
<a href="#l13.20"></a><span id="l13.20" class="difflineminus">-#include &quot;nsIAbDirFactory.h&quot;</span>
<a href="#l13.21"></a><span id="l13.21" class="difflineminus">-#include &quot;mozilla/Services.h&quot;</span>
<a href="#l13.22"></a><span id="l13.22" class="difflineminus">-</span>
<a href="#l13.23"></a><span id="l13.23" class="difflineminus">-NS_IMPL_ISUPPORTS(nsAbDirFactoryService, nsIAbDirFactoryService)</span>
<a href="#l13.24"></a><span id="l13.24" class="difflineminus">-</span>
<a href="#l13.25"></a><span id="l13.25" class="difflineminus">-nsAbDirFactoryService::nsAbDirFactoryService() {}</span>
<a href="#l13.26"></a><span id="l13.26" class="difflineminus">-</span>
<a href="#l13.27"></a><span id="l13.27" class="difflineminus">-nsAbDirFactoryService::~nsAbDirFactoryService() {}</span>
<a href="#l13.28"></a><span id="l13.28" class="difflineminus">-</span>
<a href="#l13.29"></a><span id="l13.29" class="difflineminus">-/* nsIAbDirFactory getDirFactory (in string uri); */</span>
<a href="#l13.30"></a><span id="l13.30" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l13.31"></a><span id="l13.31" class="difflineminus">-nsAbDirFactoryService::GetDirFactory(const nsACString&amp; aURI,</span>
<a href="#l13.32"></a><span id="l13.32" class="difflineminus">-                                     nsIAbDirFactory** aDirFactory) {</span>
<a href="#l13.33"></a><span id="l13.33" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aDirFactory);</span>
<a href="#l13.34"></a><span id="l13.34" class="difflineminus">-</span>
<a href="#l13.35"></a><span id="l13.35" class="difflineminus">-  nsresult rv;</span>
<a href="#l13.36"></a><span id="l13.36" class="difflineminus">-</span>
<a href="#l13.37"></a><span id="l13.37" class="difflineminus">-  // Obtain the network IO service</span>
<a href="#l13.38"></a><span id="l13.38" class="difflineminus">-  nsCOMPtr&lt;nsIIOService&gt; nsService = mozilla::services::GetIOService();</span>
<a href="#l13.39"></a><span id="l13.39" class="difflineminus">-  NS_ENSURE_TRUE(nsService, NS_ERROR_UNEXPECTED);</span>
<a href="#l13.40"></a><span id="l13.40" class="difflineminus">-</span>
<a href="#l13.41"></a><span id="l13.41" class="difflineminus">-  // Extract the scheme</span>
<a href="#l13.42"></a><span id="l13.42" class="difflineminus">-  nsAutoCString scheme;</span>
<a href="#l13.43"></a><span id="l13.43" class="difflineminus">-  rv = nsService-&gt;ExtractScheme(aURI, scheme);</span>
<a href="#l13.44"></a><span id="l13.44" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.45"></a><span id="l13.45" class="difflineminus">-</span>
<a href="#l13.46"></a><span id="l13.46" class="difflineminus">-  // Try to find a factory using the component manager.</span>
<a href="#l13.47"></a><span id="l13.47" class="difflineminus">-  nsAutoCString contractID;</span>
<a href="#l13.48"></a><span id="l13.48" class="difflineminus">-  contractID.AssignLiteral(NS_AB_DIRECTORY_FACTORY_CONTRACTID_PREFIX);</span>
<a href="#l13.49"></a><span id="l13.49" class="difflineminus">-  contractID.Append(scheme);</span>
<a href="#l13.50"></a><span id="l13.50" class="difflineminus">-</span>
<a href="#l13.51"></a><span id="l13.51" class="difflineminus">-  return CallCreateInstance(contractID.get(), aDirFactory);</span>
<a href="#l13.52"></a><span id="l13.52" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1">deleted file mode 100644</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineminus">--- a/mailnews/addrbook/src/nsAbDirFactoryService.h</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineplus">+++ /dev/null</span>
<a href="#l14.4"></a><span id="l14.4" class="difflineat">@@ -1,22 +0,0 @@</span>
<a href="#l14.5"></a><span id="l14.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l14.6"></a><span id="l14.6" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l14.7"></a><span id="l14.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l14.8"></a><span id="l14.8" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l14.9"></a><span id="l14.9" class="difflineminus">-</span>
<a href="#l14.10"></a><span id="l14.10" class="difflineminus">-#ifndef nsAbDirFactoryService_h__</span>
<a href="#l14.11"></a><span id="l14.11" class="difflineminus">-#define nsAbDirFactoryService_h__</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineminus">-#include &quot;nsIAbDirFactoryService.h&quot;</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineminus">-</span>
<a href="#l14.15"></a><span id="l14.15" class="difflineminus">-class nsAbDirFactoryService : public nsIAbDirFactoryService {</span>
<a href="#l14.16"></a><span id="l14.16" class="difflineminus">- public:</span>
<a href="#l14.17"></a><span id="l14.17" class="difflineminus">-  NS_DECL_ISUPPORTS</span>
<a href="#l14.18"></a><span id="l14.18" class="difflineminus">-  NS_DECL_NSIABDIRFACTORYSERVICE</span>
<a href="#l14.19"></a><span id="l14.19" class="difflineminus">-</span>
<a href="#l14.20"></a><span id="l14.20" class="difflineminus">-  nsAbDirFactoryService();</span>
<a href="#l14.21"></a><span id="l14.21" class="difflineminus">-</span>
<a href="#l14.22"></a><span id="l14.22" class="difflineminus">- private:</span>
<a href="#l14.23"></a><span id="l14.23" class="difflineminus">-  virtual ~nsAbDirFactoryService();</span>
<a href="#l14.24"></a><span id="l14.24" class="difflineminus">-};</span>
<a href="#l14.25"></a><span id="l14.25" class="difflineminus">-</span>
<a href="#l14.26"></a><span id="l14.26" class="difflineminus">-#endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbDirProperty.cpp</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbDirProperty.cpp</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -337,30 +337,16 @@ nsAbDirProperty::HasMailListWithName(con</span>
<a href="#l15.4"></a><span id="l15.4">         *aHasList = true;</span>
<a href="#l15.5"></a><span id="l15.5">         return NS_OK;</span>
<a href="#l15.6"></a><span id="l15.6">       }</span>
<a href="#l15.7"></a><span id="l15.7">     }</span>
<a href="#l15.8"></a><span id="l15.8">   }</span>
<a href="#l15.9"></a><span id="l15.9">   return NS_OK;</span>
<a href="#l15.10"></a><span id="l15.10"> }</span>
<a href="#l15.11"></a><span id="l15.11"> </span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineminus">-nsAbDirProperty::CreateNewDirectory(const nsAString &amp;aDirName,</span>
<a href="#l15.14"></a><span id="l15.14" class="difflineminus">-                                    const nsACString &amp;aURI, uint32_t aType,</span>
<a href="#l15.15"></a><span id="l15.15" class="difflineminus">-                                    const nsACString &amp;aPrefName,</span>
<a href="#l15.16"></a><span id="l15.16" class="difflineminus">-                                    nsACString &amp;aResult) {</span>
<a href="#l15.17"></a><span id="l15.17" class="difflineminus">-  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l15.18"></a><span id="l15.18" class="difflineminus">-}</span>
<a href="#l15.19"></a><span id="l15.19" class="difflineminus">-</span>
<a href="#l15.20"></a><span id="l15.20" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l15.21"></a><span id="l15.21" class="difflineminus">-nsAbDirProperty::CreateDirectoryByURI(const nsAString &amp;aDisplayName,</span>
<a href="#l15.22"></a><span id="l15.22" class="difflineminus">-                                      const nsACString &amp;aURI) {</span>
<a href="#l15.23"></a><span id="l15.23" class="difflineminus">-  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l15.24"></a><span id="l15.24" class="difflineminus">-}</span>
<a href="#l15.25"></a><span id="l15.25" class="difflineminus">-</span>
<a href="#l15.26"></a><span id="l15.26"> NS_IMETHODIMP nsAbDirProperty::AddMailList(nsIAbDirectory *list,</span>
<a href="#l15.27"></a><span id="l15.27">                                            nsIAbDirectory **addedList) {</span>
<a href="#l15.28"></a><span id="l15.28">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l15.29"></a><span id="l15.29"> }</span>
<a href="#l15.30"></a><span id="l15.30"> </span>
<a href="#l15.31"></a><span id="l15.31"> NS_IMETHODIMP nsAbDirProperty::EditMailListToDatabase(nsIAbCard *listCard) {</span>
<a href="#l15.32"></a><span id="l15.32">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l15.33"></a><span id="l15.33"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1">deleted file mode 100644</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineminus">--- a/mailnews/addrbook/src/nsAbLDAPDirFactory.cpp</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineplus">+++ /dev/null</span>
<a href="#l16.4"></a><span id="l16.4" class="difflineat">@@ -1,72 +0,0 @@</span>
<a href="#l16.5"></a><span id="l16.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l16.6"></a><span id="l16.6" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l16.7"></a><span id="l16.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l16.8"></a><span id="l16.8" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l16.9"></a><span id="l16.9" class="difflineminus">-</span>
<a href="#l16.10"></a><span id="l16.10" class="difflineminus">-#include &quot;nsAbLDAPDirFactory.h&quot;</span>
<a href="#l16.11"></a><span id="l16.11" class="difflineminus">-#include &quot;nsAbUtils.h&quot;</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineminus">-#include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l16.14"></a><span id="l16.14" class="difflineminus">-#include &quot;nsIAbManager.h&quot;</span>
<a href="#l16.15"></a><span id="l16.15" class="difflineminus">-#include &quot;nsIAbDirectory.h&quot;</span>
<a href="#l16.16"></a><span id="l16.16" class="difflineminus">-#include &quot;nsAbLDAPDirectory.h&quot;</span>
<a href="#l16.17"></a><span id="l16.17" class="difflineminus">-</span>
<a href="#l16.18"></a><span id="l16.18" class="difflineminus">-#include &quot;nsEnumeratorUtils.h&quot;</span>
<a href="#l16.19"></a><span id="l16.19" class="difflineminus">-#include &quot;nsAbBaseCID.h&quot;</span>
<a href="#l16.20"></a><span id="l16.20" class="difflineminus">-</span>
<a href="#l16.21"></a><span id="l16.21" class="difflineminus">-NS_IMPL_ISUPPORTS(nsAbLDAPDirFactory, nsIAbDirFactory)</span>
<a href="#l16.22"></a><span id="l16.22" class="difflineminus">-</span>
<a href="#l16.23"></a><span id="l16.23" class="difflineminus">-nsAbLDAPDirFactory::nsAbLDAPDirFactory() {}</span>
<a href="#l16.24"></a><span id="l16.24" class="difflineminus">-</span>
<a href="#l16.25"></a><span id="l16.25" class="difflineminus">-nsAbLDAPDirFactory::~nsAbLDAPDirFactory() {}</span>
<a href="#l16.26"></a><span id="l16.26" class="difflineminus">-</span>
<a href="#l16.27"></a><span id="l16.27" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l16.28"></a><span id="l16.28" class="difflineminus">-nsAbLDAPDirFactory::GetDirectories(const nsAString &amp;aDirName,</span>
<a href="#l16.29"></a><span id="l16.29" class="difflineminus">-                                   const nsACString &amp;aURI,</span>
<a href="#l16.30"></a><span id="l16.30" class="difflineminus">-                                   const nsACString &amp;aPrefName,</span>
<a href="#l16.31"></a><span id="l16.31" class="difflineminus">-                                   nsISimpleEnumerator **aDirectories) {</span>
<a href="#l16.32"></a><span id="l16.32" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aDirectories);</span>
<a href="#l16.33"></a><span id="l16.33" class="difflineminus">-</span>
<a href="#l16.34"></a><span id="l16.34" class="difflineminus">-  nsresult rv;</span>
<a href="#l16.35"></a><span id="l16.35" class="difflineminus">-  nsCOMPtr&lt;nsIAbManager&gt; abManager(do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv));</span>
<a href="#l16.36"></a><span id="l16.36" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.37"></a><span id="l16.37" class="difflineminus">-</span>
<a href="#l16.38"></a><span id="l16.38" class="difflineminus">-  nsCOMPtr&lt;nsIAbDirectory&gt; directory;</span>
<a href="#l16.39"></a><span id="l16.39" class="difflineminus">-  if (Substring(aURI, 0, 5).EqualsLiteral(&quot;ldap:&quot;) ||</span>
<a href="#l16.40"></a><span id="l16.40" class="difflineminus">-      Substring(aURI, 0, 6).EqualsLiteral(&quot;ldaps:&quot;)) {</span>
<a href="#l16.41"></a><span id="l16.41" class="difflineminus">-    /*</span>
<a href="#l16.42"></a><span id="l16.42" class="difflineminus">-     * If the URI starts with ldap: or ldaps:</span>
<a href="#l16.43"></a><span id="l16.43" class="difflineminus">-     * then this directory is an LDAP directory.</span>
<a href="#l16.44"></a><span id="l16.44" class="difflineminus">-     *</span>
<a href="#l16.45"></a><span id="l16.45" class="difflineminus">-     * We don't want to use the ldap:// or ldaps:// URI</span>
<a href="#l16.46"></a><span id="l16.46" class="difflineminus">-     * as the URI because the ldap:// or ldaps:// URI</span>
<a href="#l16.47"></a><span id="l16.47" class="difflineminus">-     * will contain the hostname, basedn, port, etc.</span>
<a href="#l16.48"></a><span id="l16.48" class="difflineminus">-     * so if those attributes changed, we'll run into the</span>
<a href="#l16.49"></a><span id="l16.49" class="difflineminus">-     * the same problem that we hit with changing username / hostname</span>
<a href="#l16.50"></a><span id="l16.50" class="difflineminus">-     * for mail servers.  To solve this problem, we add an extra</span>
<a href="#l16.51"></a><span id="l16.51" class="difflineminus">-     * level of indirection.  The URI that we generate</span>
<a href="#l16.52"></a><span id="l16.52" class="difflineminus">-     * (the bridge URI) will be moz-abldapdirectory://&lt;prefName&gt;</span>
<a href="#l16.53"></a><span id="l16.53" class="difflineminus">-     * and when we need the hostname, basedn, port, etc,</span>
<a href="#l16.54"></a><span id="l16.54" class="difflineminus">-     * we'll use the &lt;prefName&gt; to get the necessary prefs.</span>
<a href="#l16.55"></a><span id="l16.55" class="difflineminus">-     * note, &lt;prefName&gt; does not change.</span>
<a href="#l16.56"></a><span id="l16.56" class="difflineminus">-     */</span>
<a href="#l16.57"></a><span id="l16.57" class="difflineminus">-    nsAutoCString bridgeURI;</span>
<a href="#l16.58"></a><span id="l16.58" class="difflineminus">-    bridgeURI = NS_LITERAL_CSTRING(kLDAPDirectoryRoot);</span>
<a href="#l16.59"></a><span id="l16.59" class="difflineminus">-    bridgeURI += aPrefName;</span>
<a href="#l16.60"></a><span id="l16.60" class="difflineminus">-    rv = abManager-&gt;GetDirectory(bridgeURI, getter_AddRefs(directory));</span>
<a href="#l16.61"></a><span id="l16.61" class="difflineminus">-  } else {</span>
<a href="#l16.62"></a><span id="l16.62" class="difflineminus">-    rv = abManager-&gt;GetDirectory(aURI, getter_AddRefs(directory));</span>
<a href="#l16.63"></a><span id="l16.63" class="difflineminus">-  }</span>
<a href="#l16.64"></a><span id="l16.64" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.65"></a><span id="l16.65" class="difflineminus">-</span>
<a href="#l16.66"></a><span id="l16.66" class="difflineminus">-  return NS_NewSingletonEnumerator(aDirectories, directory);</span>
<a href="#l16.67"></a><span id="l16.67" class="difflineminus">-}</span>
<a href="#l16.68"></a><span id="l16.68" class="difflineminus">-</span>
<a href="#l16.69"></a><span id="l16.69" class="difflineminus">-/* void deleteDirectory (in nsIAbDirectory directory); */</span>
<a href="#l16.70"></a><span id="l16.70" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l16.71"></a><span id="l16.71" class="difflineminus">-nsAbLDAPDirFactory::DeleteDirectory(nsIAbDirectory *directory) {</span>
<a href="#l16.72"></a><span id="l16.72" class="difflineminus">-  // No actual deletion - as the LDAP Address Book is not physically</span>
<a href="#l16.73"></a><span id="l16.73" class="difflineminus">-  // created in the corresponding CreateDirectory() unlike the Personal</span>
<a href="#l16.74"></a><span id="l16.74" class="difflineminus">-  // Address Books. But we still need to return NS_OK from here.</span>
<a href="#l16.75"></a><span id="l16.75" class="difflineminus">-  return NS_OK;</span>
<a href="#l16.76"></a><span id="l16.76" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1">deleted file mode 100644</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineminus">--- a/mailnews/addrbook/src/nsAbLDAPDirFactory.h</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineplus">+++ /dev/null</span>
<a href="#l17.4"></a><span id="l17.4" class="difflineat">@@ -1,22 +0,0 @@</span>
<a href="#l17.5"></a><span id="l17.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l17.6"></a><span id="l17.6" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l17.7"></a><span id="l17.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l17.8"></a><span id="l17.8" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l17.9"></a><span id="l17.9" class="difflineminus">-</span>
<a href="#l17.10"></a><span id="l17.10" class="difflineminus">-#ifndef nsAbLDAPDirFactory_h__</span>
<a href="#l17.11"></a><span id="l17.11" class="difflineminus">-#define nsAbLDAPDirFactory_h__</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineminus">-#include &quot;nsIAbDirFactory.h&quot;</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineminus">-</span>
<a href="#l17.15"></a><span id="l17.15" class="difflineminus">-class nsAbLDAPDirFactory : public nsIAbDirFactory {</span>
<a href="#l17.16"></a><span id="l17.16" class="difflineminus">- public:</span>
<a href="#l17.17"></a><span id="l17.17" class="difflineminus">-  NS_DECL_ISUPPORTS</span>
<a href="#l17.18"></a><span id="l17.18" class="difflineminus">-  NS_DECL_NSIABDIRFACTORY</span>
<a href="#l17.19"></a><span id="l17.19" class="difflineminus">-</span>
<a href="#l17.20"></a><span id="l17.20" class="difflineminus">-  nsAbLDAPDirFactory();</span>
<a href="#l17.21"></a><span id="l17.21" class="difflineminus">-</span>
<a href="#l17.22"></a><span id="l17.22" class="difflineminus">- private:</span>
<a href="#l17.23"></a><span id="l17.23" class="difflineminus">-  virtual ~nsAbLDAPDirFactory();</span>
<a href="#l17.24"></a><span id="l17.24" class="difflineminus">-};</span>
<a href="#l17.25"></a><span id="l17.25" class="difflineminus">-</span>
<a href="#l17.26"></a><span id="l17.26" class="difflineminus">-#endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbLDAPReplicationQuery.cpp</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbLDAPReplicationQuery.cpp</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -14,50 +14,17 @@</span>
<a href="#l18.4"></a><span id="l18.4"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l18.5"></a><span id="l18.5"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l18.6"></a><span id="l18.6"> </span>
<a href="#l18.7"></a><span id="l18.7"> NS_IMPL_ISUPPORTS(nsAbLDAPReplicationQuery, nsIAbLDAPReplicationQuery)</span>
<a href="#l18.8"></a><span id="l18.8"> </span>
<a href="#l18.9"></a><span id="l18.9"> nsAbLDAPReplicationQuery::nsAbLDAPReplicationQuery() : mInitialized(false) {}</span>
<a href="#l18.10"></a><span id="l18.10"> </span>
<a href="#l18.11"></a><span id="l18.11"> nsresult nsAbLDAPReplicationQuery::InitLDAPData() {</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-  nsAutoCString fileName;</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineminus">-  nsresult rv = mDirectory-&gt;GetReplicationFileName(fileName);</span>
<a href="#l18.14"></a><span id="l18.14" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.15"></a><span id="l18.15" class="difflineminus">-</span>
<a href="#l18.16"></a><span id="l18.16" class="difflineminus">-  // this is done here to take care of the problem related to bug # 99124.</span>
<a href="#l18.17"></a><span id="l18.17" class="difflineminus">-  // earlier versions of Mozilla could have the fileName associated with the</span>
<a href="#l18.18"></a><span id="l18.18" class="difflineminus">-  // directory to be abook.mab which is the profile's personal addressbook. If</span>
<a href="#l18.19"></a><span id="l18.19" class="difflineminus">-  // the pref points to it, calls nsDirPrefs to generate a new server filename.</span>
<a href="#l18.20"></a><span id="l18.20" class="difflineminus">-  if (fileName.IsEmpty() || fileName.EqualsLiteral(kPersonalAddressbook)) {</span>
<a href="#l18.21"></a><span id="l18.21" class="difflineminus">-    // Ensure fileName is empty for DIR_GenerateAbFileName to work</span>
<a href="#l18.22"></a><span id="l18.22" class="difflineminus">-    // correctly.</span>
<a href="#l18.23"></a><span id="l18.23" class="difflineminus">-    fileName.Truncate();</span>
<a href="#l18.24"></a><span id="l18.24" class="difflineminus">-</span>
<a href="#l18.25"></a><span id="l18.25" class="difflineminus">-    nsCOMPtr&lt;nsIAbDirectory&gt; standardDir(do_QueryInterface(mDirectory, &amp;rv));</span>
<a href="#l18.26"></a><span id="l18.26" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.27"></a><span id="l18.27" class="difflineminus">-</span>
<a href="#l18.28"></a><span id="l18.28" class="difflineminus">-    nsCString dirPrefId;</span>
<a href="#l18.29"></a><span id="l18.29" class="difflineminus">-    rv = standardDir-&gt;GetDirPrefId(dirPrefId);</span>
<a href="#l18.30"></a><span id="l18.30" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.31"></a><span id="l18.31" class="difflineminus">-</span>
<a href="#l18.32"></a><span id="l18.32" class="difflineminus">-    // XXX This should be replaced by a local function at some stage.</span>
<a href="#l18.33"></a><span id="l18.33" class="difflineminus">-    // For now we'll continue using the nsDirPrefs version.</span>
<a href="#l18.34"></a><span id="l18.34" class="difflineminus">-    DIR_Server *server = DIR_GetServerFromList(dirPrefId.get());</span>
<a href="#l18.35"></a><span id="l18.35" class="difflineminus">-    if (server) {</span>
<a href="#l18.36"></a><span id="l18.36" class="difflineminus">-      DIR_SetServerFileName(server);</span>
<a href="#l18.37"></a><span id="l18.37" class="difflineminus">-      // Now ensure the prefs are saved</span>
<a href="#l18.38"></a><span id="l18.38" class="difflineminus">-      DIR_SavePrefsForOneServer(server);</span>
<a href="#l18.39"></a><span id="l18.39" class="difflineminus">-    }</span>
<a href="#l18.40"></a><span id="l18.40" class="difflineminus">-  }</span>
<a href="#l18.41"></a><span id="l18.41" class="difflineminus">-</span>
<a href="#l18.42"></a><span id="l18.42" class="difflineminus">-  rv = mDirectory-&gt;SetReplicationFileName(fileName);</span>
<a href="#l18.43"></a><span id="l18.43" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.44"></a><span id="l18.44" class="difflineminus">-</span>
<a href="#l18.45"></a><span id="l18.45" class="difflineminus">-  rv = mDirectory-&gt;GetLDAPURL(getter_AddRefs(mURL));</span>
<a href="#l18.46"></a><span id="l18.46" class="difflineplus">+  nsresult rv = mDirectory-&gt;GetLDAPURL(getter_AddRefs(mURL));</span>
<a href="#l18.47"></a><span id="l18.47">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.48"></a><span id="l18.48"> </span>
<a href="#l18.49"></a><span id="l18.49">   rv = mDirectory-&gt;GetAuthDn(mLogin);</span>
<a href="#l18.50"></a><span id="l18.50">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.51"></a><span id="l18.51"> </span>
<a href="#l18.52"></a><span id="l18.52">   mConnection = do_CreateInstance(NS_LDAPCONNECTION_CONTRACTID, &amp;rv);</span>
<a href="#l18.53"></a><span id="l18.53">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l18.54"></a><span id="l18.54"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1">deleted file mode 100644</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineminus">--- a/mailnews/addrbook/src/nsAbManager.cpp</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineplus">+++ /dev/null</span>
<a href="#l19.4"></a><span id="l19.4" class="difflineat">@@ -1,1354 +0,0 @@</span>
<a href="#l19.5"></a><span id="l19.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l19.6"></a><span id="l19.6" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l19.7"></a><span id="l19.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l19.8"></a><span id="l19.8" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l19.9"></a><span id="l19.9" class="difflineminus">-</span>
<a href="#l19.10"></a><span id="l19.10" class="difflineminus">-#include &quot;nsAbManager.h&quot;</span>
<a href="#l19.11"></a><span id="l19.11" class="difflineminus">-#include &quot;nsAbBaseCID.h&quot;</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-#include &quot;nsAddrDatabase.h&quot;</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineminus">-#include &quot;nsIOutputStream.h&quot;</span>
<a href="#l19.14"></a><span id="l19.14" class="difflineminus">-#include &quot;nsNetUtil.h&quot;</span>
<a href="#l19.15"></a><span id="l19.15" class="difflineminus">-#include &quot;nsNativeCharsetUtils.h&quot;</span>
<a href="#l19.16"></a><span id="l19.16" class="difflineminus">-#include &quot;nsIStringBundle.h&quot;</span>
<a href="#l19.17"></a><span id="l19.17" class="difflineminus">-#include &quot;nsMsgUtils.h&quot;</span>
<a href="#l19.18"></a><span id="l19.18" class="difflineminus">-#include &quot;nsAppDirectoryServiceDefs.h&quot;</span>
<a href="#l19.19"></a><span id="l19.19" class="difflineminus">-#include &quot;plstr.h&quot;</span>
<a href="#l19.20"></a><span id="l19.20" class="difflineminus">-#include &quot;prmem.h&quot;</span>
<a href="#l19.21"></a><span id="l19.21" class="difflineminus">-#include &quot;mozIDOMWindow.h&quot;</span>
<a href="#l19.22"></a><span id="l19.22" class="difflineminus">-#include &quot;plbase64.h&quot;</span>
<a href="#l19.23"></a><span id="l19.23" class="difflineminus">-#include &quot;nsIWindowWatcher.h&quot;</span>
<a href="#l19.24"></a><span id="l19.24" class="difflineminus">-#include &quot;nsDirectoryServiceUtils.h&quot;</span>
<a href="#l19.25"></a><span id="l19.25" class="difflineminus">-#include &quot;nsVCard.h&quot;</span>
<a href="#l19.26"></a><span id="l19.26" class="difflineminus">-#include &quot;nsVCardObj.h&quot;</span>
<a href="#l19.27"></a><span id="l19.27" class="difflineminus">-#include &quot;nsIAbLDAPAttributeMap.h&quot;</span>
<a href="#l19.28"></a><span id="l19.28" class="difflineminus">-#include &quot;nsICommandLine.h&quot;</span>
<a href="#l19.29"></a><span id="l19.29" class="difflineminus">-#include &quot;nsIFile.h&quot;</span>
<a href="#l19.30"></a><span id="l19.30" class="difflineminus">-#include &quot;nsIMutableArray.h&quot;</span>
<a href="#l19.31"></a><span id="l19.31" class="difflineminus">-#include &quot;nsArrayUtils.h&quot;</span>
<a href="#l19.32"></a><span id="l19.32" class="difflineminus">-#include &quot;nsDirectoryServiceUtils.h&quot;</span>
<a href="#l19.33"></a><span id="l19.33" class="difflineminus">-#include &quot;nsIObserverService.h&quot;</span>
<a href="#l19.34"></a><span id="l19.34" class="difflineminus">-#include &quot;nsDirPrefs.h&quot;</span>
<a href="#l19.35"></a><span id="l19.35" class="difflineminus">-#include &quot;nsThreadUtils.h&quot;</span>
<a href="#l19.36"></a><span id="l19.36" class="difflineminus">-#include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l19.37"></a><span id="l19.37" class="difflineminus">-#include &quot;nsAbQueryStringToExpression.h&quot;</span>
<a href="#l19.38"></a><span id="l19.38" class="difflineminus">-#include &quot;mozilla/ArrayUtils.h&quot;</span>
<a href="#l19.39"></a><span id="l19.39" class="difflineminus">-#include &quot;mozilla/Services.h&quot;</span>
<a href="#l19.40"></a><span id="l19.40" class="difflineminus">-using namespace mozilla;</span>
<a href="#l19.41"></a><span id="l19.41" class="difflineminus">-</span>
<a href="#l19.42"></a><span id="l19.42" class="difflineminus">-struct ExportAttributesTableStruct {</span>
<a href="#l19.43"></a><span id="l19.43" class="difflineminus">-  const char *abPropertyName;</span>
<a href="#l19.44"></a><span id="l19.44" class="difflineminus">-  uint32_t plainTextStringID;</span>
<a href="#l19.45"></a><span id="l19.45" class="difflineminus">-};</span>
<a href="#l19.46"></a><span id="l19.46" class="difflineminus">-</span>
<a href="#l19.47"></a><span id="l19.47" class="difflineminus">-// our schema is not fixed yet, but we still want some sort of objectclass</span>
<a href="#l19.48"></a><span id="l19.48" class="difflineminus">-// for now, use obsolete in the class name, hinting that this will change</span>
<a href="#l19.49"></a><span id="l19.49" class="difflineminus">-// see bugs bug #116692 and #118454</span>
<a href="#l19.50"></a><span id="l19.50" class="difflineminus">-#define MOZ_AB_OBJECTCLASS &quot;mozillaAbPersonAlpha&quot;</span>
<a href="#l19.51"></a><span id="l19.51" class="difflineminus">-</span>
<a href="#l19.52"></a><span id="l19.52" class="difflineminus">-// for now, the order of the attributes with true for includeForPlainText</span>
<a href="#l19.53"></a><span id="l19.53" class="difflineminus">-// should be in the same order as they are in the import code</span>
<a href="#l19.54"></a><span id="l19.54" class="difflineminus">-// see importMsgProperties and nsImportStringBundle.</span>
<a href="#l19.55"></a><span id="l19.55" class="difflineminus">-//</span>
<a href="#l19.56"></a><span id="l19.56" class="difflineminus">-// XXX todo, merge with what's in nsAbLDAPProperties.cpp, so we can</span>
<a href="#l19.57"></a><span id="l19.57" class="difflineminus">-// use this for LDAP and LDIF export</span>
<a href="#l19.58"></a><span id="l19.58" class="difflineminus">-//</span>
<a href="#l19.59"></a><span id="l19.59" class="difflineminus">-// here's how we're coming up with the ldapPropertyName values</span>
<a href="#l19.60"></a><span id="l19.60" class="difflineminus">-// if they are specified in RFC 2798, use them</span>
<a href="#l19.61"></a><span id="l19.61" class="difflineminus">-// else use the 4.x LDIF attribute names (for example, &quot;xmozillanickname&quot;</span>
<a href="#l19.62"></a><span id="l19.62" class="difflineminus">-// as we want to allow export from mozilla back to 4.x, and other apps</span>
<a href="#l19.63"></a><span id="l19.63" class="difflineminus">-// are probably out there that can handle 4.x LDIF)</span>
<a href="#l19.64"></a><span id="l19.64" class="difflineminus">-// else use the MOZ_AB_LDIF_PREFIX prefix, see nsIAddrDatabase.idl</span>
<a href="#l19.65"></a><span id="l19.65" class="difflineminus">-</span>
<a href="#l19.66"></a><span id="l19.66" class="difflineminus">-const ExportAttributesTableStruct EXPORT_ATTRIBUTES_TABLE[] = {</span>
<a href="#l19.67"></a><span id="l19.67" class="difflineminus">-    {kFirstNameProperty, 2100},     {kLastNameProperty, 2101},</span>
<a href="#l19.68"></a><span id="l19.68" class="difflineminus">-    {kDisplayNameProperty, 2102},   {kNicknameProperty, 2103},</span>
<a href="#l19.69"></a><span id="l19.69" class="difflineminus">-    {kPriEmailProperty, 2104},      {k2ndEmailProperty, 2105},</span>
<a href="#l19.70"></a><span id="l19.70" class="difflineminus">-    {kScreenNameProperty, 2136},    {kPreferMailFormatProperty, 0},</span>
<a href="#l19.71"></a><span id="l19.71" class="difflineminus">-    {kLastModifiedDateProperty, 0}, {kWorkPhoneProperty, 2106},</span>
<a href="#l19.72"></a><span id="l19.72" class="difflineminus">-    {kWorkPhoneTypeProperty, 0},    {kHomePhoneProperty, 2107},</span>
<a href="#l19.73"></a><span id="l19.73" class="difflineminus">-    {kHomePhoneTypeProperty, 0},    {kFaxProperty, 2108},</span>
<a href="#l19.74"></a><span id="l19.74" class="difflineminus">-    {kFaxTypeProperty, 0},          {kPagerProperty, 2109},</span>
<a href="#l19.75"></a><span id="l19.75" class="difflineminus">-    {kPagerTypeProperty, 0},        {kCellularProperty, 2110},</span>
<a href="#l19.76"></a><span id="l19.76" class="difflineminus">-    {kCellularTypeProperty, 0},     {kHomeAddressProperty, 2111},</span>
<a href="#l19.77"></a><span id="l19.77" class="difflineminus">-    {kHomeAddress2Property, 2112},  {kHomeCityProperty, 2113},</span>
<a href="#l19.78"></a><span id="l19.78" class="difflineminus">-    {kHomeStateProperty, 2114},     {kHomeZipCodeProperty, 2115},</span>
<a href="#l19.79"></a><span id="l19.79" class="difflineminus">-    {kHomeCountryProperty, 2116},   {kWorkAddressProperty, 2117},</span>
<a href="#l19.80"></a><span id="l19.80" class="difflineminus">-    {kWorkAddress2Property, 2118},  {kWorkCityProperty, 2119},</span>
<a href="#l19.81"></a><span id="l19.81" class="difflineminus">-    {kWorkStateProperty, 2120},     {kWorkZipCodeProperty, 2121},</span>
<a href="#l19.82"></a><span id="l19.82" class="difflineminus">-    {kWorkCountryProperty, 2122},   {kJobTitleProperty, 2123},</span>
<a href="#l19.83"></a><span id="l19.83" class="difflineminus">-    {kDepartmentProperty, 2124},    {kCompanyProperty, 2125},</span>
<a href="#l19.84"></a><span id="l19.84" class="difflineminus">-    {kWorkWebPageProperty, 2126},   {kHomeWebPageProperty, 2127},</span>
<a href="#l19.85"></a><span id="l19.85" class="difflineminus">-    {kBirthYearProperty, 2128},   // unused for now</span>
<a href="#l19.86"></a><span id="l19.86" class="difflineminus">-    {kBirthMonthProperty, 2129},  // unused for now</span>
<a href="#l19.87"></a><span id="l19.87" class="difflineminus">-    {kBirthDayProperty, 2130},    // unused for now</span>
<a href="#l19.88"></a><span id="l19.88" class="difflineminus">-    {kCustom1Property, 2131},       {kCustom2Property, 2132},</span>
<a href="#l19.89"></a><span id="l19.89" class="difflineminus">-    {kCustom3Property, 2133},       {kCustom4Property, 2134},</span>
<a href="#l19.90"></a><span id="l19.90" class="difflineminus">-    {kNotesProperty, 2135},         {kAnniversaryYearProperty, 0},</span>
<a href="#l19.91"></a><span id="l19.91" class="difflineminus">-    {kAnniversaryMonthProperty, 0}, {kAnniversaryDayProperty, 0},</span>
<a href="#l19.92"></a><span id="l19.92" class="difflineminus">-    {kSpouseNameProperty, 0},       {kFamilyNameProperty, 0},</span>
<a href="#l19.93"></a><span id="l19.93" class="difflineminus">-};</span>
<a href="#l19.94"></a><span id="l19.94" class="difflineminus">-</span>
<a href="#l19.95"></a><span id="l19.95" class="difflineminus">-//</span>
<a href="#l19.96"></a><span id="l19.96" class="difflineminus">-// nsAbManager</span>
<a href="#l19.97"></a><span id="l19.97" class="difflineminus">-//</span>
<a href="#l19.98"></a><span id="l19.98" class="difflineminus">-nsAbManager::nsAbManager() {}</span>
<a href="#l19.99"></a><span id="l19.99" class="difflineminus">-</span>
<a href="#l19.100"></a><span id="l19.100" class="difflineminus">-nsAbManager::~nsAbManager() {}</span>
<a href="#l19.101"></a><span id="l19.101" class="difflineminus">-</span>
<a href="#l19.102"></a><span id="l19.102" class="difflineminus">-NS_IMPL_ISUPPORTS(nsAbManager, nsIAbManager, nsICommandLineHandler, nsIObserver)</span>
<a href="#l19.103"></a><span id="l19.103" class="difflineminus">-</span>
<a href="#l19.104"></a><span id="l19.104" class="difflineminus">-nsresult nsAbManager::Init() {</span>
<a href="#l19.105"></a><span id="l19.105" class="difflineminus">-  NS_ENSURE_TRUE(NS_IsMainThread(), NS_ERROR_FAILURE);</span>
<a href="#l19.106"></a><span id="l19.106" class="difflineminus">-</span>
<a href="#l19.107"></a><span id="l19.107" class="difflineminus">-  nsCOMPtr&lt;nsIObserverService&gt; observerService =</span>
<a href="#l19.108"></a><span id="l19.108" class="difflineminus">-      mozilla::services::GetObserverService();</span>
<a href="#l19.109"></a><span id="l19.109" class="difflineminus">-  NS_ENSURE_TRUE(observerService, NS_ERROR_UNEXPECTED);</span>
<a href="#l19.110"></a><span id="l19.110" class="difflineminus">-</span>
<a href="#l19.111"></a><span id="l19.111" class="difflineminus">-  nsresult rv = observerService-&gt;AddObserver(this, &quot;profile-do-change&quot;, false);</span>
<a href="#l19.112"></a><span id="l19.112" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.113"></a><span id="l19.113" class="difflineminus">-</span>
<a href="#l19.114"></a><span id="l19.114" class="difflineminus">-  rv = observerService-&gt;AddObserver(this, &quot;addrbook-reload&quot;, false);</span>
<a href="#l19.115"></a><span id="l19.115" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.116"></a><span id="l19.116" class="difflineminus">-</span>
<a href="#l19.117"></a><span id="l19.117" class="difflineminus">-  rv = observerService-&gt;AddObserver(this, NS_XPCOM_SHUTDOWN_OBSERVER_ID, false);</span>
<a href="#l19.118"></a><span id="l19.118" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.119"></a><span id="l19.119" class="difflineminus">-</span>
<a href="#l19.120"></a><span id="l19.120" class="difflineminus">-  return NS_OK;</span>
<a href="#l19.121"></a><span id="l19.121" class="difflineminus">-}</span>
<a href="#l19.122"></a><span id="l19.122" class="difflineminus">-</span>
<a href="#l19.123"></a><span id="l19.123" class="difflineminus">-NS_IMETHODIMP nsAbManager::Observe(nsISupports *aSubject, const char *aTopic,</span>
<a href="#l19.124"></a><span id="l19.124" class="difflineminus">-                                   const char16_t *someData) {</span>
<a href="#l19.125"></a><span id="l19.125" class="difflineminus">-  // The nsDirPrefs code caches all the directories that it got</span>
<a href="#l19.126"></a><span id="l19.126" class="difflineminus">-  // from the first profiles prefs.js.</span>
<a href="#l19.127"></a><span id="l19.127" class="difflineminus">-  // When we profile switch, we need to force it to shut down.</span>
<a href="#l19.128"></a><span id="l19.128" class="difflineminus">-  // We'll re-load all the directories from the second profiles prefs.js</span>
<a href="#l19.129"></a><span id="l19.129" class="difflineminus">-  // that happens in nsAbBSDirectory::GetChildNodes()</span>
<a href="#l19.130"></a><span id="l19.130" class="difflineminus">-  // when we call DIR_GetDirectories().</span>
<a href="#l19.131"></a><span id="l19.131" class="difflineminus">-  if (!strcmp(aTopic, &quot;profile-do-change&quot;)) {</span>
<a href="#l19.132"></a><span id="l19.132" class="difflineminus">-    DIR_ShutDown();</span>
<a href="#l19.133"></a><span id="l19.133" class="difflineminus">-    return NS_OK;</span>
<a href="#l19.134"></a><span id="l19.134" class="difflineminus">-  }</span>
<a href="#l19.135"></a><span id="l19.135" class="difflineminus">-</span>
<a href="#l19.136"></a><span id="l19.136" class="difflineminus">-  if (!strcmp(aTopic, &quot;addrbook-reload&quot;)) {</span>
<a href="#l19.137"></a><span id="l19.137" class="difflineminus">-    DIR_ShutDown();</span>
<a href="#l19.138"></a><span id="l19.138" class="difflineminus">-    mCacheTopLevelAb = nullptr;</span>
<a href="#l19.139"></a><span id="l19.139" class="difflineminus">-    mAbStore.Clear();</span>
<a href="#l19.140"></a><span id="l19.140" class="difflineminus">-    return NS_OK;</span>
<a href="#l19.141"></a><span id="l19.141" class="difflineminus">-  }</span>
<a href="#l19.142"></a><span id="l19.142" class="difflineminus">-</span>
<a href="#l19.143"></a><span id="l19.143" class="difflineminus">-  if (!strcmp(aTopic, NS_XPCOM_SHUTDOWN_OBSERVER_ID)) {</span>
<a href="#l19.144"></a><span id="l19.144" class="difflineminus">-    DIR_ShutDown();</span>
<a href="#l19.145"></a><span id="l19.145" class="difflineminus">-</span>
<a href="#l19.146"></a><span id="l19.146" class="difflineminus">-    nsCOMPtr&lt;nsIObserverService&gt; observerService =</span>
<a href="#l19.147"></a><span id="l19.147" class="difflineminus">-        mozilla::services::GetObserverService();</span>
<a href="#l19.148"></a><span id="l19.148" class="difflineminus">-    NS_ENSURE_TRUE(observerService, NS_ERROR_UNEXPECTED);</span>
<a href="#l19.149"></a><span id="l19.149" class="difflineminus">-</span>
<a href="#l19.150"></a><span id="l19.150" class="difflineminus">-    nsresult rv = observerService-&gt;RemoveObserver(this, &quot;profile-do-change&quot;);</span>
<a href="#l19.151"></a><span id="l19.151" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.152"></a><span id="l19.152" class="difflineminus">-</span>
<a href="#l19.153"></a><span id="l19.153" class="difflineminus">-    rv = observerService-&gt;RemoveObserver(this, &quot;addrbook-reload&quot;);</span>
<a href="#l19.154"></a><span id="l19.154" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.155"></a><span id="l19.155" class="difflineminus">-</span>
<a href="#l19.156"></a><span id="l19.156" class="difflineminus">-    rv = observerService-&gt;RemoveObserver(this, NS_XPCOM_SHUTDOWN_OBSERVER_ID);</span>
<a href="#l19.157"></a><span id="l19.157" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.158"></a><span id="l19.158" class="difflineminus">-  }</span>
<a href="#l19.159"></a><span id="l19.159" class="difflineminus">-</span>
<a href="#l19.160"></a><span id="l19.160" class="difflineminus">-  return NS_OK;</span>
<a href="#l19.161"></a><span id="l19.161" class="difflineminus">-}</span>
<a href="#l19.162"></a><span id="l19.162" class="difflineminus">-</span>
<a href="#l19.163"></a><span id="l19.163" class="difflineminus">-//</span>
<a href="#l19.164"></a><span id="l19.164" class="difflineminus">-// nsIAbManager</span>
<a href="#l19.165"></a><span id="l19.165" class="difflineminus">-//</span>
<a href="#l19.166"></a><span id="l19.166" class="difflineminus">-</span>
<a href="#l19.167"></a><span id="l19.167" class="difflineminus">-NS_IMETHODIMP nsAbManager::GetDirectories(nsISimpleEnumerator **aResult) {</span>
<a href="#l19.168"></a><span id="l19.168" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l19.169"></a><span id="l19.169" class="difflineminus">-</span>
<a href="#l19.170"></a><span id="l19.170" class="difflineminus">-  // We cache the top level AB to ensure that nsIAbDirectory items are not</span>
<a href="#l19.171"></a><span id="l19.171" class="difflineminus">-  // created and dumped every time GetDirectories is called. This was causing</span>
<a href="#l19.172"></a><span id="l19.172" class="difflineminus">-  // performance problems, especially with the content policy on messages</span>
<a href="#l19.173"></a><span id="l19.173" class="difflineminus">-  // with lots of urls.</span>
<a href="#l19.174"></a><span id="l19.174" class="difflineminus">-  nsresult rv;</span>
<a href="#l19.175"></a><span id="l19.175" class="difflineminus">-  nsCOMPtr&lt;nsIAbDirectory&gt; rootAddressBook;</span>
<a href="#l19.176"></a><span id="l19.176" class="difflineminus">-  rv = GetRootDirectory(getter_AddRefs(rootAddressBook));</span>
<a href="#l19.177"></a><span id="l19.177" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.178"></a><span id="l19.178" class="difflineminus">-</span>
<a href="#l19.179"></a><span id="l19.179" class="difflineminus">-  return rootAddressBook-&gt;GetChildNodes(aResult);</span>
<a href="#l19.180"></a><span id="l19.180" class="difflineminus">-}</span>
<a href="#l19.181"></a><span id="l19.181" class="difflineminus">-</span>
<a href="#l19.182"></a><span id="l19.182" class="difflineminus">-nsresult nsAbManager::GetRootDirectory(nsIAbDirectory **aResult) {</span>
<a href="#l19.183"></a><span id="l19.183" class="difflineminus">-  // We cache the top level AB to ensure that nsIAbDirectory items are not</span>
<a href="#l19.184"></a><span id="l19.184" class="difflineminus">-  // created and dumped every time GetDirectories is called. This was causing</span>
<a href="#l19.185"></a><span id="l19.185" class="difflineminus">-  // performance problems, especially with the content policy on messages</span>
<a href="#l19.186"></a><span id="l19.186" class="difflineminus">-  // with lots of urls.</span>
<a href="#l19.187"></a><span id="l19.187" class="difflineminus">-  nsresult rv;</span>
<a href="#l19.188"></a><span id="l19.188" class="difflineminus">-</span>
<a href="#l19.189"></a><span id="l19.189" class="difflineminus">-  if (!mCacheTopLevelAb) {</span>
<a href="#l19.190"></a><span id="l19.190" class="difflineminus">-    nsCOMPtr&lt;nsIAbDirectory&gt; rootAddressBook(</span>
<a href="#l19.191"></a><span id="l19.191" class="difflineminus">-        do_CreateInstance(NS_ABDIRECTORY_CONTRACTID, &amp;rv));</span>
<a href="#l19.192"></a><span id="l19.192" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.193"></a><span id="l19.193" class="difflineminus">-    mCacheTopLevelAb = rootAddressBook;</span>
<a href="#l19.194"></a><span id="l19.194" class="difflineminus">-  }</span>
<a href="#l19.195"></a><span id="l19.195" class="difflineminus">-</span>
<a href="#l19.196"></a><span id="l19.196" class="difflineminus">-  NS_IF_ADDREF(*aResult = mCacheTopLevelAb);</span>
<a href="#l19.197"></a><span id="l19.197" class="difflineminus">-  return NS_OK;</span>
<a href="#l19.198"></a><span id="l19.198" class="difflineminus">-}</span>
<a href="#l19.199"></a><span id="l19.199" class="difflineminus">-</span>
<a href="#l19.200"></a><span id="l19.200" class="difflineminus">-NS_IMETHODIMP nsAbManager::GetDirectoryFromId(const nsACString &amp;aDirPrefId,</span>
<a href="#l19.201"></a><span id="l19.201" class="difflineminus">-                                              nsIAbDirectory **aResult) {</span>
<a href="#l19.202"></a><span id="l19.202" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l19.203"></a><span id="l19.203" class="difflineminus">-</span>
<a href="#l19.204"></a><span id="l19.204" class="difflineminus">-  nsCOMPtr&lt;nsISimpleEnumerator&gt; enumerator;</span>
<a href="#l19.205"></a><span id="l19.205" class="difflineminus">-  nsresult rv = GetDirectories(getter_AddRefs(enumerator));</span>
<a href="#l19.206"></a><span id="l19.206" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.207"></a><span id="l19.207" class="difflineminus">-  nsCOMPtr&lt;nsISupports&gt; support;</span>
<a href="#l19.208"></a><span id="l19.208" class="difflineminus">-  nsCOMPtr&lt;nsIAbDirectory&gt; directory;</span>
<a href="#l19.209"></a><span id="l19.209" class="difflineminus">-</span>
<a href="#l19.210"></a><span id="l19.210" class="difflineminus">-  bool hasMore = false;</span>
<a href="#l19.211"></a><span id="l19.211" class="difflineminus">-  while (NS_SUCCEEDED(enumerator-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore) {</span>
<a href="#l19.212"></a><span id="l19.212" class="difflineminus">-    rv = enumerator-&gt;GetNext(getter_AddRefs(support));</span>
<a href="#l19.213"></a><span id="l19.213" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.214"></a><span id="l19.214" class="difflineminus">-    directory = do_QueryInterface(support, &amp;rv);</span>
<a href="#l19.215"></a><span id="l19.215" class="difflineminus">-    if (NS_FAILED(rv)) {</span>
<a href="#l19.216"></a><span id="l19.216" class="difflineminus">-      NS_WARNING(</span>
<a href="#l19.217"></a><span id="l19.217" class="difflineminus">-          &quot;Unable to select Address book nsAbManager::GetDirectoryFromId()&quot;);</span>
<a href="#l19.218"></a><span id="l19.218" class="difflineminus">-      continue;</span>
<a href="#l19.219"></a><span id="l19.219" class="difflineminus">-    }</span>
<a href="#l19.220"></a><span id="l19.220" class="difflineminus">-</span>
<a href="#l19.221"></a><span id="l19.221" class="difflineminus">-    nsCString dirPrefId;</span>
<a href="#l19.222"></a><span id="l19.222" class="difflineminus">-    directory-&gt;GetDirPrefId(dirPrefId);</span>
<a href="#l19.223"></a><span id="l19.223" class="difflineminus">-    if (dirPrefId.Equals(aDirPrefId)) {</span>
<a href="#l19.224"></a><span id="l19.224" class="difflineminus">-      directory.forget(aResult);</span>
<a href="#l19.225"></a><span id="l19.225" class="difflineminus">-      return NS_OK;</span>
<a href="#l19.226"></a><span id="l19.226" class="difflineminus">-    }</span>
<a href="#l19.227"></a><span id="l19.227" class="difflineminus">-  }</span>
<a href="#l19.228"></a><span id="l19.228" class="difflineminus">-</span>
<a href="#l19.229"></a><span id="l19.229" class="difflineminus">-  return NS_OK;</span>
<a href="#l19.230"></a><span id="l19.230" class="difflineminus">-}</span>
<a href="#l19.231"></a><span id="l19.231" class="difflineminus">-</span>
<a href="#l19.232"></a><span id="l19.232" class="difflineminus">-NS_IMETHODIMP nsAbManager::GetDirectory(const nsACString &amp;aURI,</span>
<a href="#l19.233"></a><span id="l19.233" class="difflineminus">-                                        nsIAbDirectory **aResult) {</span>
<a href="#l19.234"></a><span id="l19.234" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l19.235"></a><span id="l19.235" class="difflineminus">-</span>
<a href="#l19.236"></a><span id="l19.236" class="difflineminus">-  nsresult rv;</span>
<a href="#l19.237"></a><span id="l19.237" class="difflineminus">-  nsCOMPtr&lt;nsIAbDirectory&gt; directory;</span>
<a href="#l19.238"></a><span id="l19.238" class="difflineminus">-</span>
<a href="#l19.239"></a><span id="l19.239" class="difflineminus">-  // Was the directory root requested?</span>
<a href="#l19.240"></a><span id="l19.240" class="difflineminus">-  if (aURI.EqualsLiteral(kAllDirectoryRoot)) {</span>
<a href="#l19.241"></a><span id="l19.241" class="difflineminus">-    rv = GetRootDirectory(getter_AddRefs(directory));</span>
<a href="#l19.242"></a><span id="l19.242" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.243"></a><span id="l19.243" class="difflineminus">-    directory.forget(aResult);</span>
<a href="#l19.244"></a><span id="l19.244" class="difflineminus">-    return NS_OK;</span>
<a href="#l19.245"></a><span id="l19.245" class="difflineminus">-  }</span>
<a href="#l19.246"></a><span id="l19.246" class="difflineminus">-</span>
<a href="#l19.247"></a><span id="l19.247" class="difflineminus">-  // Do we have a copy of this directory already within our look-up table?</span>
<a href="#l19.248"></a><span id="l19.248" class="difflineminus">-  if (!mAbStore.Get(aURI, getter_AddRefs(directory))) {</span>
<a href="#l19.249"></a><span id="l19.249" class="difflineminus">-    // The directory wasn't in our look-up table, so we need to instantiate</span>
<a href="#l19.250"></a><span id="l19.250" class="difflineminus">-    // it. First, extract the scheme from the URI...</span>
<a href="#l19.251"></a><span id="l19.251" class="difflineminus">-</span>
<a href="#l19.252"></a><span id="l19.252" class="difflineminus">-    nsAutoCString scheme;</span>
<a href="#l19.253"></a><span id="l19.253" class="difflineminus">-</span>
<a href="#l19.254"></a><span id="l19.254" class="difflineminus">-    int32_t colon = aURI.FindChar(':');</span>
<a href="#l19.255"></a><span id="l19.255" class="difflineminus">-    if (colon &lt;= 0) return NS_ERROR_MALFORMED_URI;</span>
<a href="#l19.256"></a><span id="l19.256" class="difflineminus">-    scheme = Substring(aURI, 0, colon);</span>
<a href="#l19.257"></a><span id="l19.257" class="difflineminus">-</span>
<a href="#l19.258"></a><span id="l19.258" class="difflineminus">-    // Construct the appropriate nsIAbDirectory...</span>
<a href="#l19.259"></a><span id="l19.259" class="difflineminus">-    nsAutoCString contractID;</span>
<a href="#l19.260"></a><span id="l19.260" class="difflineminus">-    contractID.AssignLiteral(NS_AB_DIRECTORY_TYPE_CONTRACTID_PREFIX);</span>
<a href="#l19.261"></a><span id="l19.261" class="difflineminus">-    contractID.Append(scheme);</span>
<a href="#l19.262"></a><span id="l19.262" class="difflineminus">-    directory = do_CreateInstance(contractID.get(), &amp;rv);</span>
<a href="#l19.263"></a><span id="l19.263" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.264"></a><span id="l19.264" class="difflineminus">-</span>
<a href="#l19.265"></a><span id="l19.265" class="difflineminus">-    // Init it with the URI</span>
<a href="#l19.266"></a><span id="l19.266" class="difflineminus">-    rv = directory-&gt;Init(PromiseFlatCString(aURI).get());</span>
<a href="#l19.267"></a><span id="l19.267" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.268"></a><span id="l19.268" class="difflineminus">-</span>
<a href="#l19.269"></a><span id="l19.269" class="difflineminus">-    // Check if this directory was initiated with a search query.  If so,</span>
<a href="#l19.270"></a><span id="l19.270" class="difflineminus">-    // we don't cache it.</span>
<a href="#l19.271"></a><span id="l19.271" class="difflineminus">-    bool isQuery = false;</span>
<a href="#l19.272"></a><span id="l19.272" class="difflineminus">-    rv = directory-&gt;GetIsQuery(&amp;isQuery);</span>
<a href="#l19.273"></a><span id="l19.273" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.274"></a><span id="l19.274" class="difflineminus">-</span>
<a href="#l19.275"></a><span id="l19.275" class="difflineminus">-    if (!isQuery) mAbStore.Put(aURI, directory);</span>
<a href="#l19.276"></a><span id="l19.276" class="difflineminus">-  }</span>
<a href="#l19.277"></a><span id="l19.277" class="difflineminus">-  directory.forget(aResult);</span>
<a href="#l19.278"></a><span id="l19.278" class="difflineminus">-</span>
<a href="#l19.279"></a><span id="l19.279" class="difflineminus">-  return NS_OK;</span>
<a href="#l19.280"></a><span id="l19.280" class="difflineminus">-}</span>
<a href="#l19.281"></a><span id="l19.281" class="difflineminus">-</span>
<a href="#l19.282"></a><span id="l19.282" class="difflineminus">-NS_IMETHODIMP nsAbManager::NewAddressBook(const nsAString &amp;aDirName,</span>
<a href="#l19.283"></a><span id="l19.283" class="difflineminus">-                                          const nsACString &amp;aURI,</span>
<a href="#l19.284"></a><span id="l19.284" class="difflineminus">-                                          const uint32_t aType,</span>
<a href="#l19.285"></a><span id="l19.285" class="difflineminus">-                                          const nsACString &amp;aPrefName,</span>
<a href="#l19.286"></a><span id="l19.286" class="difflineminus">-                                          nsACString &amp;aResult) {</span>
<a href="#l19.287"></a><span id="l19.287" class="difflineminus">-  nsresult rv;</span>
<a href="#l19.288"></a><span id="l19.288" class="difflineminus">-</span>
<a href="#l19.289"></a><span id="l19.289" class="difflineminus">-  nsCOMPtr&lt;nsIAbDirectory&gt; parentDir;</span>
<a href="#l19.290"></a><span id="l19.290" class="difflineminus">-  rv = GetRootDirectory(getter_AddRefs(parentDir));</span>
<a href="#l19.291"></a><span id="l19.291" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.292"></a><span id="l19.292" class="difflineminus">-  return parentDir-&gt;CreateNewDirectory(aDirName, aURI, aType, aPrefName,</span>
<a href="#l19.293"></a><span id="l19.293" class="difflineminus">-                                       aResult);</span>
<a href="#l19.294"></a><span id="l19.294" class="difflineminus">-}</span>
<a href="#l19.295"></a><span id="l19.295" class="difflineminus">-</span>
<a href="#l19.296"></a><span id="l19.296" class="difflineminus">-NS_IMETHODIMP nsAbManager::DeleteAddressBook(const nsACString &amp;aURI) {</span>
<a href="#l19.297"></a><span id="l19.297" class="difflineminus">-  // Find the address book</span>
<a href="#l19.298"></a><span id="l19.298" class="difflineminus">-  nsresult rv;</span>
<a href="#l19.299"></a><span id="l19.299" class="difflineminus">-</span>
<a href="#l19.300"></a><span id="l19.300" class="difflineminus">-  nsCOMPtr&lt;nsIAbDirectory&gt; directory;</span>
<a href="#l19.301"></a><span id="l19.301" class="difflineminus">-  rv = GetDirectory(aURI, getter_AddRefs(directory));</span>
<a href="#l19.302"></a><span id="l19.302" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.303"></a><span id="l19.303" class="difflineminus">-</span>
<a href="#l19.304"></a><span id="l19.304" class="difflineminus">-  nsCOMPtr&lt;nsIAbDirectory&gt; rootDirectory;</span>
<a href="#l19.305"></a><span id="l19.305" class="difflineminus">-  rv = GetRootDirectory(getter_AddRefs(rootDirectory));</span>
<a href="#l19.306"></a><span id="l19.306" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.307"></a><span id="l19.307" class="difflineminus">-</span>
<a href="#l19.308"></a><span id="l19.308" class="difflineminus">-  // Go through each of the children of the address book</span>
<a href="#l19.309"></a><span id="l19.309" class="difflineminus">-  // (so, the mailing lists) and remove their entries from</span>
<a href="#l19.310"></a><span id="l19.310" class="difflineminus">-  // the look up table.</span>
<a href="#l19.311"></a><span id="l19.311" class="difflineminus">-  nsCOMPtr&lt;nsISimpleEnumerator&gt; enumerator;</span>
<a href="#l19.312"></a><span id="l19.312" class="difflineminus">-  rv = directory-&gt;GetChildNodes(getter_AddRefs(enumerator));</span>
<a href="#l19.313"></a><span id="l19.313" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.314"></a><span id="l19.314" class="difflineminus">-</span>
<a href="#l19.315"></a><span id="l19.315" class="difflineminus">-  nsCOMPtr&lt;nsISupports&gt; item;</span>
<a href="#l19.316"></a><span id="l19.316" class="difflineminus">-  nsCOMPtr&lt;nsIAbDirectory&gt; childDirectory;</span>
<a href="#l19.317"></a><span id="l19.317" class="difflineminus">-  bool hasMore = false;</span>
<a href="#l19.318"></a><span id="l19.318" class="difflineminus">-  while (NS_SUCCEEDED(enumerator-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore) {</span>
<a href="#l19.319"></a><span id="l19.319" class="difflineminus">-    rv = enumerator-&gt;GetNext(getter_AddRefs(item));</span>
<a href="#l19.320"></a><span id="l19.320" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.321"></a><span id="l19.321" class="difflineminus">-</span>
<a href="#l19.322"></a><span id="l19.322" class="difflineminus">-    childDirectory = do_QueryInterface(item, &amp;rv);</span>
<a href="#l19.323"></a><span id="l19.323" class="difflineminus">-    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l19.324"></a><span id="l19.324" class="difflineminus">-      nsCString childURI;</span>
<a href="#l19.325"></a><span id="l19.325" class="difflineminus">-      rv = childDirectory-&gt;GetURI(childURI);</span>
<a href="#l19.326"></a><span id="l19.326" class="difflineminus">-      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.327"></a><span id="l19.327" class="difflineminus">-</span>
<a href="#l19.328"></a><span id="l19.328" class="difflineminus">-      mAbStore.Remove(childURI);</span>
<a href="#l19.329"></a><span id="l19.329" class="difflineminus">-    }</span>
<a href="#l19.330"></a><span id="l19.330" class="difflineminus">-  }</span>
<a href="#l19.331"></a><span id="l19.331" class="difflineminus">-</span>
<a href="#l19.332"></a><span id="l19.332" class="difflineminus">-  mAbStore.Remove(aURI);</span>
<a href="#l19.333"></a><span id="l19.333" class="difflineminus">-</span>
<a href="#l19.334"></a><span id="l19.334" class="difflineminus">-  bool isMailList;</span>
<a href="#l19.335"></a><span id="l19.335" class="difflineminus">-  rv = directory-&gt;GetIsMailList(&amp;isMailList);</span>
<a href="#l19.336"></a><span id="l19.336" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.337"></a><span id="l19.337" class="difflineminus">-</span>
<a href="#l19.338"></a><span id="l19.338" class="difflineminus">-  if (!isMailList)</span>
<a href="#l19.339"></a><span id="l19.339" class="difflineminus">-    // If we're not a mailing list, then our parent</span>
<a href="#l19.340"></a><span id="l19.340" class="difflineminus">-    // must be the root address book directory.</span>
<a href="#l19.341"></a><span id="l19.341" class="difflineminus">-    return rootDirectory-&gt;DeleteDirectory(directory);</span>
<a href="#l19.342"></a><span id="l19.342" class="difflineminus">-</span>
<a href="#l19.343"></a><span id="l19.343" class="difflineminus">-  nsCString parentUri;</span>
<a href="#l19.344"></a><span id="l19.344" class="difflineminus">-  parentUri.Append(aURI);</span>
<a href="#l19.345"></a><span id="l19.345" class="difflineminus">-  int32_t pos = parentUri.RFindChar('/');</span>
<a href="#l19.346"></a><span id="l19.346" class="difflineminus">-</span>
<a href="#l19.347"></a><span id="l19.347" class="difflineminus">-  // If we didn't find a /, we're in trouble.</span>
<a href="#l19.348"></a><span id="l19.348" class="difflineminus">-  if (pos == -1) return NS_ERROR_FAILURE;</span>
<a href="#l19.349"></a><span id="l19.349" class="difflineminus">-</span>
<a href="#l19.350"></a><span id="l19.350" class="difflineminus">-  parentUri = StringHead(parentUri, pos);</span>
<a href="#l19.351"></a><span id="l19.351" class="difflineminus">-  nsCOMPtr&lt;nsIAbDirectory&gt; parentDirectory;</span>
<a href="#l19.352"></a><span id="l19.352" class="difflineminus">-  rv = GetDirectory(parentUri, getter_AddRefs(parentDirectory));</span>
<a href="#l19.353"></a><span id="l19.353" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.354"></a><span id="l19.354" class="difflineminus">-</span>
<a href="#l19.355"></a><span id="l19.355" class="difflineminus">-  return parentDirectory-&gt;DeleteDirectory(directory);</span>
<a href="#l19.356"></a><span id="l19.356" class="difflineminus">-}</span>
<a href="#l19.357"></a><span id="l19.357" class="difflineminus">-</span>
<a href="#l19.358"></a><span id="l19.358" class="difflineminus">-NS_IMETHODIMP nsAbManager::AddAddressBookListener(</span>
<a href="#l19.359"></a><span id="l19.359" class="difflineminus">-    nsIAbListener *aListener, abListenerNotifyFlagValue aNotifyFlags) {</span>
<a href="#l19.360"></a><span id="l19.360" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aListener);</span>
<a href="#l19.361"></a><span id="l19.361" class="difflineminus">-</span>
<a href="#l19.362"></a><span id="l19.362" class="difflineminus">-  abListener newListener(aListener, aNotifyFlags);</span>
<a href="#l19.363"></a><span id="l19.363" class="difflineminus">-  mListeners.AppendElementUnlessExists(newListener);</span>
<a href="#l19.364"></a><span id="l19.364" class="difflineminus">-  return NS_OK;</span>
<a href="#l19.365"></a><span id="l19.365" class="difflineminus">-}</span>
<a href="#l19.366"></a><span id="l19.366" class="difflineminus">-</span>
<a href="#l19.367"></a><span id="l19.367" class="difflineminus">-NS_IMETHODIMP nsAbManager::RemoveAddressBookListener(nsIAbListener *aListener) {</span>
<a href="#l19.368"></a><span id="l19.368" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aListener);</span>
<a href="#l19.369"></a><span id="l19.369" class="difflineminus">-</span>
<a href="#l19.370"></a><span id="l19.370" class="difflineminus">-  mListeners.RemoveElement(aListener);</span>
<a href="#l19.371"></a><span id="l19.371" class="difflineminus">-  return NS_OK;</span>
<a href="#l19.372"></a><span id="l19.372" class="difflineminus">-}</span>
<a href="#l19.373"></a><span id="l19.373" class="difflineminus">-</span>
<a href="#l19.374"></a><span id="l19.374" class="difflineminus">-#define NOTIFY_AB_LISTENERS(propertyflag_, propertyfunc_, params_) \</span>
<a href="#l19.375"></a><span id="l19.375" class="difflineminus">-  PR_BEGIN_MACRO                                                   \</span>
<a href="#l19.376"></a><span id="l19.376" class="difflineminus">-  nsTObserverArray&lt;abListener&gt;::ForwardIterator iter(mListeners);  \</span>
<a href="#l19.377"></a><span id="l19.377" class="difflineminus">-  while (iter.HasMore()) {                                         \</span>
<a href="#l19.378"></a><span id="l19.378" class="difflineminus">-    const abListener &amp;abL = iter.GetNext();                        \</span>
<a href="#l19.379"></a><span id="l19.379" class="difflineminus">-    if (abL.mNotifyFlags &amp; nsIAbListener::propertyflag_)           \</span>
<a href="#l19.380"></a><span id="l19.380" class="difflineminus">-      abL.mListener-&gt;propertyfunc_ params_;                        \</span>
<a href="#l19.381"></a><span id="l19.381" class="difflineminus">-  }                                                                \</span>
<a href="#l19.382"></a><span id="l19.382" class="difflineminus">-  PR_END_MACRO</span>
<a href="#l19.383"></a><span id="l19.383" class="difflineminus">-</span>
<a href="#l19.384"></a><span id="l19.384" class="difflineminus">-NS_IMETHODIMP nsAbManager::NotifyItemPropertyChanged(</span>
<a href="#l19.385"></a><span id="l19.385" class="difflineminus">-    nsISupports *aItem, const char *aProperty, const nsAString &amp;aOldValue,</span>
<a href="#l19.386"></a><span id="l19.386" class="difflineminus">-    const nsAString &amp;aNewValue) {</span>
<a href="#l19.387"></a><span id="l19.387" class="difflineminus">-  NOTIFY_AB_LISTENERS(itemChanged, OnItemPropertyChanged,</span>
<a href="#l19.388"></a><span id="l19.388" class="difflineminus">-                      (aItem, aProperty, aOldValue, aNewValue));</span>
<a href="#l19.389"></a><span id="l19.389" class="difflineminus">-  return NS_OK;</span>
<a href="#l19.390"></a><span id="l19.390" class="difflineminus">-}</span>
<a href="#l19.391"></a><span id="l19.391" class="difflineminus">-</span>
<a href="#l19.392"></a><span id="l19.392" class="difflineminus">-NS_IMETHODIMP nsAbManager::NotifyDirectoryItemAdded(</span>
<a href="#l19.393"></a><span id="l19.393" class="difflineminus">-    nsIAbDirectory *aParentDirectory, nsISupports *aItem) {</span>
<a href="#l19.394"></a><span id="l19.394" class="difflineminus">-  NOTIFY_AB_LISTENERS(itemAdded, OnItemAdded, (aParentDirectory, aItem));</span>
<a href="#l19.395"></a><span id="l19.395" class="difflineminus">-  return NS_OK;</span>
<a href="#l19.396"></a><span id="l19.396" class="difflineminus">-}</span>
<a href="#l19.397"></a><span id="l19.397" class="difflineminus">-</span>
<a href="#l19.398"></a><span id="l19.398" class="difflineminus">-NS_IMETHODIMP nsAbManager::NotifyDirectoryItemDeleted(</span>
<a href="#l19.399"></a><span id="l19.399" class="difflineminus">-    nsIAbDirectory *aParentDirectory, nsISupports *aItem) {</span>
<a href="#l19.400"></a><span id="l19.400" class="difflineminus">-  NOTIFY_AB_LISTENERS(directoryItemRemoved, OnItemRemoved,</span>
<a href="#l19.401"></a><span id="l19.401" class="difflineminus">-                      (aParentDirectory, aItem));</span>
<a href="#l19.402"></a><span id="l19.402" class="difflineminus">-  return NS_OK;</span>
<a href="#l19.403"></a><span id="l19.403" class="difflineminus">-}</span>
<a href="#l19.404"></a><span id="l19.404" class="difflineminus">-</span>
<a href="#l19.405"></a><span id="l19.405" class="difflineminus">-NS_IMETHODIMP nsAbManager::NotifyDirectoryDeleted(</span>
<a href="#l19.406"></a><span id="l19.406" class="difflineminus">-    nsIAbDirectory *aParentDirectory, nsISupports *aDirectory) {</span>
<a href="#l19.407"></a><span id="l19.407" class="difflineminus">-  NOTIFY_AB_LISTENERS(directoryRemoved, OnItemRemoved,</span>
<a href="#l19.408"></a><span id="l19.408" class="difflineminus">-                      (aParentDirectory, aDirectory));</span>
<a href="#l19.409"></a><span id="l19.409" class="difflineminus">-  return NS_OK;</span>
<a href="#l19.410"></a><span id="l19.410" class="difflineminus">-}</span>
<a href="#l19.411"></a><span id="l19.411" class="difflineminus">-</span>
<a href="#l19.412"></a><span id="l19.412" class="difflineminus">-NS_IMETHODIMP nsAbManager::GetUserProfileDirectory(nsIFile **userDir) {</span>
<a href="#l19.413"></a><span id="l19.413" class="difflineminus">-  NS_ENSURE_ARG_POINTER(userDir);</span>
<a href="#l19.414"></a><span id="l19.414" class="difflineminus">-  *userDir = nullptr;</span>
<a href="#l19.415"></a><span id="l19.415" class="difflineminus">-</span>
<a href="#l19.416"></a><span id="l19.416" class="difflineminus">-  nsresult rv;</span>
<a href="#l19.417"></a><span id="l19.417" class="difflineminus">-  nsCOMPtr&lt;nsIFile&gt; profileDir;</span>
<a href="#l19.418"></a><span id="l19.418" class="difflineminus">-  nsAutoCString pathBuf;</span>
<a href="#l19.419"></a><span id="l19.419" class="difflineminus">-</span>
<a href="#l19.420"></a><span id="l19.420" class="difflineminus">-  rv = NS_GetSpecialDirectory(NS_APP_USER_PROFILE_50_DIR,</span>
<a href="#l19.421"></a><span id="l19.421" class="difflineminus">-                              getter_AddRefs(profileDir));</span>
<a href="#l19.422"></a><span id="l19.422" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.423"></a><span id="l19.423" class="difflineminus">-</span>
<a href="#l19.424"></a><span id="l19.424" class="difflineminus">-  profileDir.forget(userDir);</span>
<a href="#l19.425"></a><span id="l19.425" class="difflineminus">-  return NS_OK;</span>
<a href="#l19.426"></a><span id="l19.426" class="difflineminus">-}</span>
<a href="#l19.427"></a><span id="l19.427" class="difflineminus">-</span>
<a href="#l19.428"></a><span id="l19.428" class="difflineminus">-NS_IMETHODIMP nsAbManager::MailListNameExists(const char16_t *aName,</span>
<a href="#l19.429"></a><span id="l19.429" class="difflineminus">-                                              bool *aExists) {</span>
<a href="#l19.430"></a><span id="l19.430" class="difflineminus">-  nsresult rv;</span>
<a href="#l19.431"></a><span id="l19.431" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aExists);</span>
<a href="#l19.432"></a><span id="l19.432" class="difflineminus">-</span>
<a href="#l19.433"></a><span id="l19.433" class="difflineminus">-  *aExists = false;</span>
<a href="#l19.434"></a><span id="l19.434" class="difflineminus">-</span>
<a href="#l19.435"></a><span id="l19.435" class="difflineminus">-  // now get the top-level book</span>
<a href="#l19.436"></a><span id="l19.436" class="difflineminus">-  nsCOMPtr&lt;nsIAbDirectory&gt; topDirectory;</span>
<a href="#l19.437"></a><span id="l19.437" class="difflineminus">-  rv = GetRootDirectory(getter_AddRefs(topDirectory));</span>
<a href="#l19.438"></a><span id="l19.438" class="difflineminus">-</span>
<a href="#l19.439"></a><span id="l19.439" class="difflineminus">-  // now go through the address books</span>
<a href="#l19.440"></a><span id="l19.440" class="difflineminus">-  nsCOMPtr&lt;nsISimpleEnumerator&gt; enumerator;</span>
<a href="#l19.441"></a><span id="l19.441" class="difflineminus">-  rv = topDirectory-&gt;GetChildNodes(getter_AddRefs(enumerator));</span>
<a href="#l19.442"></a><span id="l19.442" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.443"></a><span id="l19.443" class="difflineminus">-</span>
<a href="#l19.444"></a><span id="l19.444" class="difflineminus">-  bool hasMore;</span>
<a href="#l19.445"></a><span id="l19.445" class="difflineminus">-  while (NS_SUCCEEDED(enumerator-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore) {</span>
<a href="#l19.446"></a><span id="l19.446" class="difflineminus">-    nsCOMPtr&lt;nsISupports&gt; item;</span>
<a href="#l19.447"></a><span id="l19.447" class="difflineminus">-    rv = enumerator-&gt;GetNext(getter_AddRefs(item));</span>
<a href="#l19.448"></a><span id="l19.448" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.449"></a><span id="l19.449" class="difflineminus">-</span>
<a href="#l19.450"></a><span id="l19.450" class="difflineminus">-    nsCOMPtr&lt;nsIAbDirectory&gt; directory = do_QueryInterface(item, &amp;rv);</span>
<a href="#l19.451"></a><span id="l19.451" class="difflineminus">-    if (NS_FAILED(rv)) continue;</span>
<a href="#l19.452"></a><span id="l19.452" class="difflineminus">-</span>
<a href="#l19.453"></a><span id="l19.453" class="difflineminus">-    rv = directory-&gt;HasMailListWithName(aName, aExists);</span>
<a href="#l19.454"></a><span id="l19.454" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; *aExists) return NS_OK;</span>
<a href="#l19.455"></a><span id="l19.455" class="difflineminus">-  }</span>
<a href="#l19.456"></a><span id="l19.456" class="difflineminus">-</span>
<a href="#l19.457"></a><span id="l19.457" class="difflineminus">-  *aExists = false;</span>
<a href="#l19.458"></a><span id="l19.458" class="difflineminus">-  return NS_OK;</span>
<a href="#l19.459"></a><span id="l19.459" class="difflineminus">-}</span>
<a href="#l19.460"></a><span id="l19.460" class="difflineminus">-</span>
<a href="#l19.461"></a><span id="l19.461" class="difflineminus">-#define CSV_DELIM &quot;,&quot;</span>
<a href="#l19.462"></a><span id="l19.462" class="difflineminus">-#define CSV_DELIM_LEN 1</span>
<a href="#l19.463"></a><span id="l19.463" class="difflineminus">-#define TAB_DELIM &quot;\t&quot;</span>
<a href="#l19.464"></a><span id="l19.464" class="difflineminus">-#define TAB_DELIM_LEN 1</span>
<a href="#l19.465"></a><span id="l19.465" class="difflineminus">-</span>
<a href="#l19.466"></a><span id="l19.466" class="difflineminus">-#define CSV_FILE_EXTENSION &quot;.csv&quot;</span>
<a href="#l19.467"></a><span id="l19.467" class="difflineminus">-#define TAB_FILE_EXTENSION &quot;.tab&quot;</span>
<a href="#l19.468"></a><span id="l19.468" class="difflineminus">-#define TXT_FILE_EXTENSION &quot;.txt&quot;</span>
<a href="#l19.469"></a><span id="l19.469" class="difflineminus">-#define VCF_FILE_EXTENSION &quot;.vcf&quot;</span>
<a href="#l19.470"></a><span id="l19.470" class="difflineminus">-#define LDIF_FILE_EXTENSION &quot;.ldi&quot;</span>
<a href="#l19.471"></a><span id="l19.471" class="difflineminus">-#define LDIF_FILE_EXTENSION2 &quot;.ldif&quot;</span>
<a href="#l19.472"></a><span id="l19.472" class="difflineminus">-</span>
<a href="#l19.473"></a><span id="l19.473" class="difflineminus">-enum ADDRESSBOOK_EXPORT_FILE_TYPE {</span>
<a href="#l19.474"></a><span id="l19.474" class="difflineminus">-  CSV_EXPORT_TYPE = 0,</span>
<a href="#l19.475"></a><span id="l19.475" class="difflineminus">-  CSV_EXPORT_TYPE_UTF8 = 1,</span>
<a href="#l19.476"></a><span id="l19.476" class="difflineminus">-  TAB_EXPORT_TYPE = 2,</span>
<a href="#l19.477"></a><span id="l19.477" class="difflineminus">-  TAB_EXPORT_TYPE_UTF8 = 3,</span>
<a href="#l19.478"></a><span id="l19.478" class="difflineminus">-  VCF_EXPORT_TYPE = 4,</span>
<a href="#l19.479"></a><span id="l19.479" class="difflineminus">-  LDIF_EXPORT_TYPE = 5,</span>
<a href="#l19.480"></a><span id="l19.480" class="difflineminus">-};</span>
<a href="#l19.481"></a><span id="l19.481" class="difflineminus">-</span>
<a href="#l19.482"></a><span id="l19.482" class="difflineminus">-NS_IMPL_ISUPPORTS(nsAbManager::nsFilePickerShownCallback,</span>
<a href="#l19.483"></a><span id="l19.483" class="difflineminus">-                  nsIFilePickerShownCallback)</span>
<a href="#l19.484"></a><span id="l19.484" class="difflineminus">-nsAbManager::nsFilePickerShownCallback::nsFilePickerShownCallback(</span>
<a href="#l19.485"></a><span id="l19.485" class="difflineminus">-    nsAbManager *aAbManager, nsIFilePicker *aFilePicker,</span>
<a href="#l19.486"></a><span id="l19.486" class="difflineminus">-    nsIAbDirectory *aDirectory)</span>
<a href="#l19.487"></a><span id="l19.487" class="difflineminus">-    : mFilePicker(aFilePicker),</span>
<a href="#l19.488"></a><span id="l19.488" class="difflineminus">-      mAbManager(aAbManager),</span>
<a href="#l19.489"></a><span id="l19.489" class="difflineminus">-      mDirectory(aDirectory) {}</span>
<a href="#l19.490"></a><span id="l19.490" class="difflineminus">-</span>
<a href="#l19.491"></a><span id="l19.491" class="difflineminus">-NS_IMETHODIMP nsAbManager::ExportAddressBook(mozIDOMWindowProxy *aParentWin,</span>
<a href="#l19.492"></a><span id="l19.492" class="difflineminus">-                                             nsIAbDirectory *aDirectory) {</span>
<a href="#l19.493"></a><span id="l19.493" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aParentWin);</span>
<a href="#l19.494"></a><span id="l19.494" class="difflineminus">-</span>
<a href="#l19.495"></a><span id="l19.495" class="difflineminus">-  nsresult rv;</span>
<a href="#l19.496"></a><span id="l19.496" class="difflineminus">-  nsCOMPtr&lt;nsIFilePicker&gt; filePicker =</span>
<a href="#l19.497"></a><span id="l19.497" class="difflineminus">-      do_CreateInstance(&quot;@mozilla.org/filepicker;1&quot;, &amp;rv);</span>
<a href="#l19.498"></a><span id="l19.498" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.499"></a><span id="l19.499" class="difflineminus">-</span>
<a href="#l19.500"></a><span id="l19.500" class="difflineminus">-  nsCOMPtr&lt;nsIStringBundleService&gt; bundleService =</span>
<a href="#l19.501"></a><span id="l19.501" class="difflineminus">-      mozilla::services::GetStringBundleService();</span>
<a href="#l19.502"></a><span id="l19.502" class="difflineminus">-  NS_ENSURE_TRUE(bundleService, NS_ERROR_UNEXPECTED);</span>
<a href="#l19.503"></a><span id="l19.503" class="difflineminus">-  nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l19.504"></a><span id="l19.504" class="difflineminus">-  rv = bundleService-&gt;CreateBundle(</span>
<a href="#l19.505"></a><span id="l19.505" class="difflineminus">-      &quot;chrome://messenger/locale/addressbook/addressBook.properties&quot;,</span>
<a href="#l19.506"></a><span id="l19.506" class="difflineminus">-      getter_AddRefs(bundle));</span>
<a href="#l19.507"></a><span id="l19.507" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.508"></a><span id="l19.508" class="difflineminus">-</span>
<a href="#l19.509"></a><span id="l19.509" class="difflineminus">-  nsString dirName;</span>
<a href="#l19.510"></a><span id="l19.510" class="difflineminus">-  aDirectory-&gt;GetDirName(dirName);</span>
<a href="#l19.511"></a><span id="l19.511" class="difflineminus">-  AutoTArray&lt;nsString, 1&gt; formatStrings = {dirName};</span>
<a href="#l19.512"></a><span id="l19.512" class="difflineminus">-</span>
<a href="#l19.513"></a><span id="l19.513" class="difflineminus">-  nsString title;</span>
<a href="#l19.514"></a><span id="l19.514" class="difflineminus">-  rv = bundle-&gt;FormatStringFromName(&quot;ExportAddressBookNameTitle&quot;, formatStrings,</span>
<a href="#l19.515"></a><span id="l19.515" class="difflineminus">-                                    title);</span>
<a href="#l19.516"></a><span id="l19.516" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.517"></a><span id="l19.517" class="difflineminus">-</span>
<a href="#l19.518"></a><span id="l19.518" class="difflineminus">-  rv = filePicker-&gt;Init(aParentWin, title, nsIFilePicker::modeSave);</span>
<a href="#l19.519"></a><span id="l19.519" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.520"></a><span id="l19.520" class="difflineminus">-</span>
<a href="#l19.521"></a><span id="l19.521" class="difflineminus">-  filePicker-&gt;SetDefaultString(dirName);</span>
<a href="#l19.522"></a><span id="l19.522" class="difflineminus">-</span>
<a href="#l19.523"></a><span id="l19.523" class="difflineminus">-  nsString filterString;</span>
<a href="#l19.524"></a><span id="l19.524" class="difflineminus">-</span>
<a href="#l19.525"></a><span id="l19.525" class="difflineminus">-  // CSV: System charset and UTF-8.</span>
<a href="#l19.526"></a><span id="l19.526" class="difflineminus">-  rv = bundle-&gt;GetStringFromName(&quot;CSVFilesSysCharset&quot;, filterString);</span>
<a href="#l19.527"></a><span id="l19.527" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.528"></a><span id="l19.528" class="difflineminus">-  rv = filePicker-&gt;AppendFilter(filterString, NS_LITERAL_STRING(&quot;*.csv&quot;));</span>
<a href="#l19.529"></a><span id="l19.529" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.530"></a><span id="l19.530" class="difflineminus">-  rv = bundle-&gt;GetStringFromName(&quot;CSVFilesUTF8&quot;, filterString);</span>
<a href="#l19.531"></a><span id="l19.531" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.532"></a><span id="l19.532" class="difflineminus">-  rv = filePicker-&gt;AppendFilter(filterString, NS_LITERAL_STRING(&quot;*.csv&quot;));</span>
<a href="#l19.533"></a><span id="l19.533" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.534"></a><span id="l19.534" class="difflineminus">-</span>
<a href="#l19.535"></a><span id="l19.535" class="difflineminus">-  // Tab separated: System charset and UTF-8.</span>
<a href="#l19.536"></a><span id="l19.536" class="difflineminus">-  rv = bundle-&gt;GetStringFromName(&quot;TABFilesSysCharset&quot;, filterString);</span>
<a href="#l19.537"></a><span id="l19.537" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.538"></a><span id="l19.538" class="difflineminus">-  rv =</span>
<a href="#l19.539"></a><span id="l19.539" class="difflineminus">-      filePicker-&gt;AppendFilter(filterString, NS_LITERAL_STRING(&quot;*.tab; *.txt&quot;));</span>
<a href="#l19.540"></a><span id="l19.540" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.541"></a><span id="l19.541" class="difflineminus">-  rv = bundle-&gt;GetStringFromName(&quot;TABFilesUTF8&quot;, filterString);</span>
<a href="#l19.542"></a><span id="l19.542" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.543"></a><span id="l19.543" class="difflineminus">-  rv =</span>
<a href="#l19.544"></a><span id="l19.544" class="difflineminus">-      filePicker-&gt;AppendFilter(filterString, NS_LITERAL_STRING(&quot;*.tab; *.txt&quot;));</span>
<a href="#l19.545"></a><span id="l19.545" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.546"></a><span id="l19.546" class="difflineminus">-</span>
<a href="#l19.547"></a><span id="l19.547" class="difflineminus">-  rv = bundle-&gt;GetStringFromName(&quot;VCFFiles&quot;, filterString);</span>
<a href="#l19.548"></a><span id="l19.548" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.549"></a><span id="l19.549" class="difflineminus">-  rv = filePicker-&gt;AppendFilter(filterString, NS_LITERAL_STRING(&quot;*.vcf&quot;));</span>
<a href="#l19.550"></a><span id="l19.550" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.551"></a><span id="l19.551" class="difflineminus">-</span>
<a href="#l19.552"></a><span id="l19.552" class="difflineminus">-  rv = bundle-&gt;GetStringFromName(&quot;LDIFFiles&quot;, filterString);</span>
<a href="#l19.553"></a><span id="l19.553" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.554"></a><span id="l19.554" class="difflineminus">-  rv = filePicker-&gt;AppendFilter(filterString,</span>
<a href="#l19.555"></a><span id="l19.555" class="difflineminus">-                                NS_LITERAL_STRING(&quot;*.ldi; *.ldif&quot;));</span>
<a href="#l19.556"></a><span id="l19.556" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.557"></a><span id="l19.557" class="difflineminus">-</span>
<a href="#l19.558"></a><span id="l19.558" class="difflineminus">-  nsCOMPtr&lt;nsIFilePickerShownCallback&gt; callback =</span>
<a href="#l19.559"></a><span id="l19.559" class="difflineminus">-      new nsAbManager::nsFilePickerShownCallback(this, filePicker, aDirectory);</span>
<a href="#l19.560"></a><span id="l19.560" class="difflineminus">-  return filePicker-&gt;Open(callback);</span>
<a href="#l19.561"></a><span id="l19.561" class="difflineminus">-}</span>
<a href="#l19.562"></a><span id="l19.562" class="difflineminus">-</span>
<a href="#l19.563"></a><span id="l19.563" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l19.564"></a><span id="l19.564" class="difflineminus">-nsAbManager::nsFilePickerShownCallback::Done(int16_t aResult) {</span>
<a href="#l19.565"></a><span id="l19.565" class="difflineminus">-  nsresult rv;</span>
<a href="#l19.566"></a><span id="l19.566" class="difflineminus">-  if (aResult == nsIFilePicker::returnCancel) return NS_OK;</span>
<a href="#l19.567"></a><span id="l19.567" class="difflineminus">-</span>
<a href="#l19.568"></a><span id="l19.568" class="difflineminus">-  nsCOMPtr&lt;nsIFile&gt; localFile;</span>
<a href="#l19.569"></a><span id="l19.569" class="difflineminus">-  rv = mFilePicker-&gt;GetFile(getter_AddRefs(localFile));</span>
<a href="#l19.570"></a><span id="l19.570" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.571"></a><span id="l19.571" class="difflineminus">-</span>
<a href="#l19.572"></a><span id="l19.572" class="difflineminus">-  if (aResult == nsIFilePicker::returnReplace) {</span>
<a href="#l19.573"></a><span id="l19.573" class="difflineminus">-    // be extra safe and only delete when the file is really a file</span>
<a href="#l19.574"></a><span id="l19.574" class="difflineminus">-    bool isFile;</span>
<a href="#l19.575"></a><span id="l19.575" class="difflineminus">-    rv = localFile-&gt;IsFile(&amp;isFile);</span>
<a href="#l19.576"></a><span id="l19.576" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; isFile) {</span>
<a href="#l19.577"></a><span id="l19.577" class="difflineminus">-      rv = localFile-&gt;Remove(false /* recursive delete */);</span>
<a href="#l19.578"></a><span id="l19.578" class="difflineminus">-      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.579"></a><span id="l19.579" class="difflineminus">-    }</span>
<a href="#l19.580"></a><span id="l19.580" class="difflineminus">-  }</span>
<a href="#l19.581"></a><span id="l19.581" class="difflineminus">-</span>
<a href="#l19.582"></a><span id="l19.582" class="difflineminus">-  // The type of export is determined by the drop-down in</span>
<a href="#l19.583"></a><span id="l19.583" class="difflineminus">-  // the file picker dialog.</span>
<a href="#l19.584"></a><span id="l19.584" class="difflineminus">-  int32_t exportType;</span>
<a href="#l19.585"></a><span id="l19.585" class="difflineminus">-  rv = mFilePicker-&gt;GetFilterIndex(&amp;exportType);</span>
<a href="#l19.586"></a><span id="l19.586" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.587"></a><span id="l19.587" class="difflineminus">-</span>
<a href="#l19.588"></a><span id="l19.588" class="difflineminus">-  nsAutoString fileName;</span>
<a href="#l19.589"></a><span id="l19.589" class="difflineminus">-  rv = localFile-&gt;GetLeafName(fileName);</span>
<a href="#l19.590"></a><span id="l19.590" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.591"></a><span id="l19.591" class="difflineminus">-</span>
<a href="#l19.592"></a><span id="l19.592" class="difflineminus">-  switch (exportType) {</span>
<a href="#l19.593"></a><span id="l19.593" class="difflineminus">-    default:</span>
<a href="#l19.594"></a><span id="l19.594" class="difflineminus">-    case LDIF_EXPORT_TYPE:  // ldif</span>
<a href="#l19.595"></a><span id="l19.595" class="difflineminus">-      // If filename does not have the correct ext, add one.</span>
<a href="#l19.596"></a><span id="l19.596" class="difflineminus">-      if ((MsgFind(fileName, LDIF_FILE_EXTENSION, true,</span>
<a href="#l19.597"></a><span id="l19.597" class="difflineminus">-                   fileName.Length() - strlen(LDIF_FILE_EXTENSION)) == -1) &amp;&amp;</span>
<a href="#l19.598"></a><span id="l19.598" class="difflineminus">-          (MsgFind(fileName, LDIF_FILE_EXTENSION2, true,</span>
<a href="#l19.599"></a><span id="l19.599" class="difflineminus">-                   fileName.Length() - strlen(LDIF_FILE_EXTENSION2)) == -1)) {</span>
<a href="#l19.600"></a><span id="l19.600" class="difflineminus">-        // Add the extension and build a new localFile.</span>
<a href="#l19.601"></a><span id="l19.601" class="difflineminus">-        fileName.AppendLiteral(LDIF_FILE_EXTENSION2);</span>
<a href="#l19.602"></a><span id="l19.602" class="difflineminus">-        localFile-&gt;SetLeafName(fileName);</span>
<a href="#l19.603"></a><span id="l19.603" class="difflineminus">-      }</span>
<a href="#l19.604"></a><span id="l19.604" class="difflineminus">-      rv = mAbManager-&gt;ExportDirectoryToLDIF(mDirectory, localFile);</span>
<a href="#l19.605"></a><span id="l19.605" class="difflineminus">-      break;</span>
<a href="#l19.606"></a><span id="l19.606" class="difflineminus">-</span>
<a href="#l19.607"></a><span id="l19.607" class="difflineminus">-    case CSV_EXPORT_TYPE:  // csv</span>
<a href="#l19.608"></a><span id="l19.608" class="difflineminus">-    case CSV_EXPORT_TYPE_UTF8:</span>
<a href="#l19.609"></a><span id="l19.609" class="difflineminus">-      // If filename does not have the correct ext, add one.</span>
<a href="#l19.610"></a><span id="l19.610" class="difflineminus">-      if (MsgFind(fileName, CSV_FILE_EXTENSION, true,</span>
<a href="#l19.611"></a><span id="l19.611" class="difflineminus">-                  fileName.Length() - strlen(CSV_FILE_EXTENSION)) == -1) {</span>
<a href="#l19.612"></a><span id="l19.612" class="difflineminus">-        // Add the extension and build a new localFile.</span>
<a href="#l19.613"></a><span id="l19.613" class="difflineminus">-        fileName.AppendLiteral(CSV_FILE_EXTENSION);</span>
<a href="#l19.614"></a><span id="l19.614" class="difflineminus">-        localFile-&gt;SetLeafName(fileName);</span>
<a href="#l19.615"></a><span id="l19.615" class="difflineminus">-      }</span>
<a href="#l19.616"></a><span id="l19.616" class="difflineminus">-      rv = mAbManager-&gt;ExportDirectoryToDelimitedText(</span>
<a href="#l19.617"></a><span id="l19.617" class="difflineminus">-          mDirectory, CSV_DELIM, CSV_DELIM_LEN, localFile,</span>
<a href="#l19.618"></a><span id="l19.618" class="difflineminus">-          exportType == CSV_EXPORT_TYPE_UTF8);</span>
<a href="#l19.619"></a><span id="l19.619" class="difflineminus">-      break;</span>
<a href="#l19.620"></a><span id="l19.620" class="difflineminus">-</span>
<a href="#l19.621"></a><span id="l19.621" class="difflineminus">-    case TAB_EXPORT_TYPE:  // tab &amp; text</span>
<a href="#l19.622"></a><span id="l19.622" class="difflineminus">-    case TAB_EXPORT_TYPE_UTF8:</span>
<a href="#l19.623"></a><span id="l19.623" class="difflineminus">-      // If filename does not have the correct ext, add one.</span>
<a href="#l19.624"></a><span id="l19.624" class="difflineminus">-      if ((MsgFind(fileName, TXT_FILE_EXTENSION, true,</span>
<a href="#l19.625"></a><span id="l19.625" class="difflineminus">-                   fileName.Length() - strlen(TXT_FILE_EXTENSION)) == -1) &amp;&amp;</span>
<a href="#l19.626"></a><span id="l19.626" class="difflineminus">-          (MsgFind(fileName, TAB_FILE_EXTENSION, true,</span>
<a href="#l19.627"></a><span id="l19.627" class="difflineminus">-                   fileName.Length() - strlen(TAB_FILE_EXTENSION)) == -1)) {</span>
<a href="#l19.628"></a><span id="l19.628" class="difflineminus">-        // Add the extension and build a new localFile.</span>
<a href="#l19.629"></a><span id="l19.629" class="difflineminus">-        fileName.AppendLiteral(TXT_FILE_EXTENSION);</span>
<a href="#l19.630"></a><span id="l19.630" class="difflineminus">-        localFile-&gt;SetLeafName(fileName);</span>
<a href="#l19.631"></a><span id="l19.631" class="difflineminus">-      }</span>
<a href="#l19.632"></a><span id="l19.632" class="difflineminus">-      rv = mAbManager-&gt;ExportDirectoryToDelimitedText(</span>
<a href="#l19.633"></a><span id="l19.633" class="difflineminus">-          mDirectory, TAB_DELIM, TAB_DELIM_LEN, localFile,</span>
<a href="#l19.634"></a><span id="l19.634" class="difflineminus">-          exportType == TAB_EXPORT_TYPE_UTF8);</span>
<a href="#l19.635"></a><span id="l19.635" class="difflineminus">-      break;</span>
<a href="#l19.636"></a><span id="l19.636" class="difflineminus">-</span>
<a href="#l19.637"></a><span id="l19.637" class="difflineminus">-    case VCF_EXPORT_TYPE:  // vCard</span>
<a href="#l19.638"></a><span id="l19.638" class="difflineminus">-      // If filename does not have the correct ext, add one.</span>
<a href="#l19.639"></a><span id="l19.639" class="difflineminus">-      if (MsgFind(fileName, VCF_FILE_EXTENSION, true,</span>
<a href="#l19.640"></a><span id="l19.640" class="difflineminus">-                  fileName.Length() - strlen(VCF_FILE_EXTENSION)) == -1) {</span>
<a href="#l19.641"></a><span id="l19.641" class="difflineminus">-        // Add the extension and build a new localFile.</span>
<a href="#l19.642"></a><span id="l19.642" class="difflineminus">-        fileName.AppendLiteral(VCF_FILE_EXTENSION);</span>
<a href="#l19.643"></a><span id="l19.643" class="difflineminus">-        localFile-&gt;SetLeafName(fileName);</span>
<a href="#l19.644"></a><span id="l19.644" class="difflineminus">-      }</span>
<a href="#l19.645"></a><span id="l19.645" class="difflineminus">-      rv = mAbManager-&gt;ExportDirectoryToVCard(mDirectory, localFile);</span>
<a href="#l19.646"></a><span id="l19.646" class="difflineminus">-      break;</span>
<a href="#l19.647"></a><span id="l19.647" class="difflineminus">-  };</span>
<a href="#l19.648"></a><span id="l19.648" class="difflineminus">-</span>
<a href="#l19.649"></a><span id="l19.649" class="difflineminus">-  return rv;</span>
<a href="#l19.650"></a><span id="l19.650" class="difflineminus">-}</span>
<a href="#l19.651"></a><span id="l19.651" class="difflineminus">-</span>
<a href="#l19.652"></a><span id="l19.652" class="difflineminus">-nsresult nsAbManager::ExportDirectoryToDelimitedText(nsIAbDirectory *aDirectory,</span>
<a href="#l19.653"></a><span id="l19.653" class="difflineminus">-                                                     const char *aDelim,</span>
<a href="#l19.654"></a><span id="l19.654" class="difflineminus">-                                                     uint32_t aDelimLen,</span>
<a href="#l19.655"></a><span id="l19.655" class="difflineminus">-                                                     nsIFile *aLocalFile,</span>
<a href="#l19.656"></a><span id="l19.656" class="difflineminus">-                                                     bool useUTF8) {</span>
<a href="#l19.657"></a><span id="l19.657" class="difflineminus">-  nsCOMPtr&lt;nsISimpleEnumerator&gt; cardsEnumerator;</span>
<a href="#l19.658"></a><span id="l19.658" class="difflineminus">-  nsCOMPtr&lt;nsIAbCard&gt; card;</span>
<a href="#l19.659"></a><span id="l19.659" class="difflineminus">-</span>
<a href="#l19.660"></a><span id="l19.660" class="difflineminus">-  nsresult rv;</span>
<a href="#l19.661"></a><span id="l19.661" class="difflineminus">-</span>
<a href="#l19.662"></a><span id="l19.662" class="difflineminus">-  nsCOMPtr&lt;nsIOutputStream&gt; outputStream;</span>
<a href="#l19.663"></a><span id="l19.663" class="difflineminus">-  rv = MsgNewBufferedFileOutputStream(getter_AddRefs(outputStream), aLocalFile,</span>
<a href="#l19.664"></a><span id="l19.664" class="difflineminus">-                                      PR_CREATE_FILE | PR_WRONLY | PR_TRUNCATE,</span>
<a href="#l19.665"></a><span id="l19.665" class="difflineminus">-                                      0664);</span>
<a href="#l19.666"></a><span id="l19.666" class="difflineminus">-</span>
<a href="#l19.667"></a><span id="l19.667" class="difflineminus">-  // the desired file may be read only</span>
<a href="#l19.668"></a><span id="l19.668" class="difflineminus">-  if (NS_FAILED(rv)) return rv;</span>
<a href="#l19.669"></a><span id="l19.669" class="difflineminus">-</span>
<a href="#l19.670"></a><span id="l19.670" class="difflineminus">-  uint32_t i;</span>
<a href="#l19.671"></a><span id="l19.671" class="difflineminus">-  uint32_t writeCount;</span>
<a href="#l19.672"></a><span id="l19.672" class="difflineminus">-  uint32_t length;</span>
<a href="#l19.673"></a><span id="l19.673" class="difflineminus">-</span>
<a href="#l19.674"></a><span id="l19.674" class="difflineminus">-  nsCOMPtr&lt;nsIStringBundleService&gt; bundleService =</span>
<a href="#l19.675"></a><span id="l19.675" class="difflineminus">-      mozilla::services::GetStringBundleService();</span>
<a href="#l19.676"></a><span id="l19.676" class="difflineminus">-  NS_ENSURE_TRUE(bundleService, NS_ERROR_UNEXPECTED);</span>
<a href="#l19.677"></a><span id="l19.677" class="difflineminus">-</span>
<a href="#l19.678"></a><span id="l19.678" class="difflineminus">-  nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l19.679"></a><span id="l19.679" class="difflineminus">-  rv = bundleService-&gt;CreateBundle(</span>
<a href="#l19.680"></a><span id="l19.680" class="difflineminus">-      &quot;chrome://messenger/locale/importMsgs.properties&quot;,</span>
<a href="#l19.681"></a><span id="l19.681" class="difflineminus">-      getter_AddRefs(bundle));</span>
<a href="#l19.682"></a><span id="l19.682" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.683"></a><span id="l19.683" class="difflineminus">-</span>
<a href="#l19.684"></a><span id="l19.684" class="difflineminus">-  nsCString revisedName;</span>
<a href="#l19.685"></a><span id="l19.685" class="difflineminus">-  nsString columnName;</span>
<a href="#l19.686"></a><span id="l19.686" class="difflineminus">-</span>
<a href="#l19.687"></a><span id="l19.687" class="difflineminus">-  for (i = 0; i &lt; ArrayLength(EXPORT_ATTRIBUTES_TABLE); i++) {</span>
<a href="#l19.688"></a><span id="l19.688" class="difflineminus">-    if (EXPORT_ATTRIBUTES_TABLE[i].plainTextStringID != 0) {</span>
<a href="#l19.689"></a><span id="l19.689" class="difflineminus">-      // We don't need to truncate the string here as getter_Copies will</span>
<a href="#l19.690"></a><span id="l19.690" class="difflineminus">-      // do that for us.</span>
<a href="#l19.691"></a><span id="l19.691" class="difflineminus">-      if (NS_FAILED(bundle-&gt;GetStringFromID(</span>
<a href="#l19.692"></a><span id="l19.692" class="difflineminus">-              EXPORT_ATTRIBUTES_TABLE[i].plainTextStringID, columnName)))</span>
<a href="#l19.693"></a><span id="l19.693" class="difflineminus">-        columnName.AppendInt(EXPORT_ATTRIBUTES_TABLE[i].plainTextStringID);</span>
<a href="#l19.694"></a><span id="l19.694" class="difflineminus">-</span>
<a href="#l19.695"></a><span id="l19.695" class="difflineminus">-      if (useUTF8)</span>
<a href="#l19.696"></a><span id="l19.696" class="difflineminus">-        CopyUTF16toUTF8(columnName, revisedName);</span>
<a href="#l19.697"></a><span id="l19.697" class="difflineminus">-      else</span>
<a href="#l19.698"></a><span id="l19.698" class="difflineminus">-        NS_CopyUnicodeToNative(columnName, revisedName);</span>
<a href="#l19.699"></a><span id="l19.699" class="difflineminus">-</span>
<a href="#l19.700"></a><span id="l19.700" class="difflineminus">-      rv = outputStream-&gt;Write(revisedName.get(), revisedName.Length(),</span>
<a href="#l19.701"></a><span id="l19.701" class="difflineminus">-                               &amp;writeCount);</span>
<a href="#l19.702"></a><span id="l19.702" class="difflineminus">-      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.703"></a><span id="l19.703" class="difflineminus">-</span>
<a href="#l19.704"></a><span id="l19.704" class="difflineminus">-      if (revisedName.Length() != writeCount) return NS_ERROR_FAILURE;</span>
<a href="#l19.705"></a><span id="l19.705" class="difflineminus">-</span>
<a href="#l19.706"></a><span id="l19.706" class="difflineminus">-      if (i &lt; ArrayLength(EXPORT_ATTRIBUTES_TABLE) - 1) {</span>
<a href="#l19.707"></a><span id="l19.707" class="difflineminus">-        rv = outputStream-&gt;Write(aDelim, aDelimLen, &amp;writeCount);</span>
<a href="#l19.708"></a><span id="l19.708" class="difflineminus">-        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.709"></a><span id="l19.709" class="difflineminus">-</span>
<a href="#l19.710"></a><span id="l19.710" class="difflineminus">-        if (aDelimLen != writeCount) return NS_ERROR_FAILURE;</span>
<a href="#l19.711"></a><span id="l19.711" class="difflineminus">-      }</span>
<a href="#l19.712"></a><span id="l19.712" class="difflineminus">-    }</span>
<a href="#l19.713"></a><span id="l19.713" class="difflineminus">-  }</span>
<a href="#l19.714"></a><span id="l19.714" class="difflineminus">-  rv = outputStream-&gt;Write(MSG_LINEBREAK, MSG_LINEBREAK_LEN, &amp;writeCount);</span>
<a href="#l19.715"></a><span id="l19.715" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.716"></a><span id="l19.716" class="difflineminus">-  if (MSG_LINEBREAK_LEN != writeCount) return NS_ERROR_FAILURE;</span>
<a href="#l19.717"></a><span id="l19.717" class="difflineminus">-</span>
<a href="#l19.718"></a><span id="l19.718" class="difflineminus">-  rv = aDirectory-&gt;GetChildCards(getter_AddRefs(cardsEnumerator));</span>
<a href="#l19.719"></a><span id="l19.719" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; cardsEnumerator) {</span>
<a href="#l19.720"></a><span id="l19.720" class="difflineminus">-    nsCOMPtr&lt;nsISupports&gt; item;</span>
<a href="#l19.721"></a><span id="l19.721" class="difflineminus">-    bool more;</span>
<a href="#l19.722"></a><span id="l19.722" class="difflineminus">-    while (NS_SUCCEEDED(cardsEnumerator-&gt;HasMoreElements(&amp;more)) &amp;&amp; more) {</span>
<a href="#l19.723"></a><span id="l19.723" class="difflineminus">-      rv = cardsEnumerator-&gt;GetNext(getter_AddRefs(item));</span>
<a href="#l19.724"></a><span id="l19.724" class="difflineminus">-      if (NS_SUCCEEDED(rv)) {</span>
<a href="#l19.725"></a><span id="l19.725" class="difflineminus">-        nsCOMPtr&lt;nsIAbCard&gt; card = do_QueryInterface(item, &amp;rv);</span>
<a href="#l19.726"></a><span id="l19.726" class="difflineminus">-        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.727"></a><span id="l19.727" class="difflineminus">-</span>
<a href="#l19.728"></a><span id="l19.728" class="difflineminus">-        bool isMailList;</span>
<a href="#l19.729"></a><span id="l19.729" class="difflineminus">-        rv = card-&gt;GetIsMailList(&amp;isMailList);</span>
<a href="#l19.730"></a><span id="l19.730" class="difflineminus">-        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.731"></a><span id="l19.731" class="difflineminus">-</span>
<a href="#l19.732"></a><span id="l19.732" class="difflineminus">-        if (isMailList) {</span>
<a href="#l19.733"></a><span id="l19.733" class="difflineminus">-          // .tab, .txt and .csv aren't able to export mailing lists</span>
<a href="#l19.734"></a><span id="l19.734" class="difflineminus">-          // use LDIF for that.</span>
<a href="#l19.735"></a><span id="l19.735" class="difflineminus">-        } else {</span>
<a href="#l19.736"></a><span id="l19.736" class="difflineminus">-          nsString value;</span>
<a href="#l19.737"></a><span id="l19.737" class="difflineminus">-          nsCString valueCStr;</span>
<a href="#l19.738"></a><span id="l19.738" class="difflineminus">-</span>
<a href="#l19.739"></a><span id="l19.739" class="difflineminus">-          for (i = 0; i &lt; ArrayLength(EXPORT_ATTRIBUTES_TABLE); i++) {</span>
<a href="#l19.740"></a><span id="l19.740" class="difflineminus">-            if (EXPORT_ATTRIBUTES_TABLE[i].plainTextStringID != 0) {</span>
<a href="#l19.741"></a><span id="l19.741" class="difflineminus">-              rv = card-&gt;GetPropertyAsAString(</span>
<a href="#l19.742"></a><span id="l19.742" class="difflineminus">-                  EXPORT_ATTRIBUTES_TABLE[i].abPropertyName, value);</span>
<a href="#l19.743"></a><span id="l19.743" class="difflineminus">-              if (NS_FAILED(rv)) value.Truncate();</span>
<a href="#l19.744"></a><span id="l19.744" class="difflineminus">-</span>
<a href="#l19.745"></a><span id="l19.745" class="difflineminus">-              // If a string contains at least one comma, tab or double quote</span>
<a href="#l19.746"></a><span id="l19.746" class="difflineminus">-              // then we need to quote the entire string. Also if double quote</span>
<a href="#l19.747"></a><span id="l19.747" class="difflineminus">-              // is part of the string we need to quote the double quote(s) as</span>
<a href="#l19.748"></a><span id="l19.748" class="difflineminus">-              // well.</span>
<a href="#l19.749"></a><span id="l19.749" class="difflineminus">-              nsAutoString newValue(value);</span>
<a href="#l19.750"></a><span id="l19.750" class="difflineminus">-              bool needsQuotes = false;</span>
<a href="#l19.751"></a><span id="l19.751" class="difflineminus">-              if (newValue.FindChar('&quot;') != -1) {</span>
<a href="#l19.752"></a><span id="l19.752" class="difflineminus">-                needsQuotes = true;</span>
<a href="#l19.753"></a><span id="l19.753" class="difflineminus">-</span>
<a href="#l19.754"></a><span id="l19.754" class="difflineminus">-                int32_t match = 0;</span>
<a href="#l19.755"></a><span id="l19.755" class="difflineminus">-                uint32_t offset = 0;</span>
<a href="#l19.756"></a><span id="l19.756" class="difflineminus">-                nsString oldSubstr = NS_LITERAL_STRING(&quot;\&quot;&quot;);</span>
<a href="#l19.757"></a><span id="l19.757" class="difflineminus">-                nsString newSubstr = NS_LITERAL_STRING(&quot;\&quot;\&quot;&quot;);</span>
<a href="#l19.758"></a><span id="l19.758" class="difflineminus">-                while (offset &lt; newValue.Length()) {</span>
<a href="#l19.759"></a><span id="l19.759" class="difflineminus">-                  match = newValue.Find(oldSubstr, offset);</span>
<a href="#l19.760"></a><span id="l19.760" class="difflineminus">-                  if (match == -1) break;</span>
<a href="#l19.761"></a><span id="l19.761" class="difflineminus">-</span>
<a href="#l19.762"></a><span id="l19.762" class="difflineminus">-                  newValue.Replace(match, oldSubstr.Length(), newSubstr);</span>
<a href="#l19.763"></a><span id="l19.763" class="difflineminus">-                  offset += (match + newSubstr.Length());</span>
<a href="#l19.764"></a><span id="l19.764" class="difflineminus">-                }</span>
<a href="#l19.765"></a><span id="l19.765" class="difflineminus">-              }</span>
<a href="#l19.766"></a><span id="l19.766" class="difflineminus">-              if (!needsQuotes &amp;&amp; (newValue.FindChar(',') != -1 ||</span>
<a href="#l19.767"></a><span id="l19.767" class="difflineminus">-                                   newValue.FindChar('\x09') != -1))</span>
<a href="#l19.768"></a><span id="l19.768" class="difflineminus">-                needsQuotes = true;</span>
<a href="#l19.769"></a><span id="l19.769" class="difflineminus">-</span>
<a href="#l19.770"></a><span id="l19.770" class="difflineminus">-              // Make sure we quote if containing CR/LF.</span>
<a href="#l19.771"></a><span id="l19.771" class="difflineminus">-              if (newValue.FindChar('\r') != -1 ||</span>
<a href="#l19.772"></a><span id="l19.772" class="difflineminus">-                  newValue.FindChar('\n') != -1)</span>
<a href="#l19.773"></a><span id="l19.773" class="difflineminus">-                needsQuotes = true;</span>
<a href="#l19.774"></a><span id="l19.774" class="difflineminus">-</span>
<a href="#l19.775"></a><span id="l19.775" class="difflineminus">-              if (needsQuotes) {</span>
<a href="#l19.776"></a><span id="l19.776" class="difflineminus">-                newValue.InsertLiteral(u&quot;\&quot;&quot;, 0);</span>
<a href="#l19.777"></a><span id="l19.777" class="difflineminus">-                newValue.Append(u'&quot;');</span>
<a href="#l19.778"></a><span id="l19.778" class="difflineminus">-              }</span>
<a href="#l19.779"></a><span id="l19.779" class="difflineminus">-</span>
<a href="#l19.780"></a><span id="l19.780" class="difflineminus">-              if (useUTF8)</span>
<a href="#l19.781"></a><span id="l19.781" class="difflineminus">-                CopyUTF16toUTF8(newValue, valueCStr);</span>
<a href="#l19.782"></a><span id="l19.782" class="difflineminus">-              else</span>
<a href="#l19.783"></a><span id="l19.783" class="difflineminus">-                NS_CopyUnicodeToNative(newValue, valueCStr);</span>
<a href="#l19.784"></a><span id="l19.784" class="difflineminus">-</span>
<a href="#l19.785"></a><span id="l19.785" class="difflineminus">-              length = valueCStr.Length();</span>
<a href="#l19.786"></a><span id="l19.786" class="difflineminus">-              if (length) {</span>
<a href="#l19.787"></a><span id="l19.787" class="difflineminus">-                rv = outputStream-&gt;Write(valueCStr.get(), length, &amp;writeCount);</span>
<a href="#l19.788"></a><span id="l19.788" class="difflineminus">-                NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.789"></a><span id="l19.789" class="difflineminus">-                if (length != writeCount) return NS_ERROR_FAILURE;</span>
<a href="#l19.790"></a><span id="l19.790" class="difflineminus">-              }</span>
<a href="#l19.791"></a><span id="l19.791" class="difflineminus">-              valueCStr = &quot;&quot;;</span>
<a href="#l19.792"></a><span id="l19.792" class="difflineminus">-            } else {</span>
<a href="#l19.793"></a><span id="l19.793" class="difflineminus">-              // something we don't support for the current export</span>
<a href="#l19.794"></a><span id="l19.794" class="difflineminus">-              // for example, .tab doesn't export preferred html format</span>
<a href="#l19.795"></a><span id="l19.795" class="difflineminus">-              continue;  // go to next field</span>
<a href="#l19.796"></a><span id="l19.796" class="difflineminus">-            }</span>
<a href="#l19.797"></a><span id="l19.797" class="difflineminus">-</span>
<a href="#l19.798"></a><span id="l19.798" class="difflineminus">-            if (i &lt; ArrayLength(EXPORT_ATTRIBUTES_TABLE) - 1) {</span>
<a href="#l19.799"></a><span id="l19.799" class="difflineminus">-              rv = outputStream-&gt;Write(aDelim, aDelimLen, &amp;writeCount);</span>
<a href="#l19.800"></a><span id="l19.800" class="difflineminus">-              NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.801"></a><span id="l19.801" class="difflineminus">-              if (aDelimLen != writeCount) return NS_ERROR_FAILURE;</span>
<a href="#l19.802"></a><span id="l19.802" class="difflineminus">-            }</span>
<a href="#l19.803"></a><span id="l19.803" class="difflineminus">-          }</span>
<a href="#l19.804"></a><span id="l19.804" class="difflineminus">-</span>
<a href="#l19.805"></a><span id="l19.805" class="difflineminus">-          // write out the linebreak that separates the cards</span>
<a href="#l19.806"></a><span id="l19.806" class="difflineminus">-          rv = outputStream-&gt;Write(MSG_LINEBREAK, MSG_LINEBREAK_LEN,</span>
<a href="#l19.807"></a><span id="l19.807" class="difflineminus">-                                   &amp;writeCount);</span>
<a href="#l19.808"></a><span id="l19.808" class="difflineminus">-          NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.809"></a><span id="l19.809" class="difflineminus">-          if (MSG_LINEBREAK_LEN != writeCount) return NS_ERROR_FAILURE;</span>
<a href="#l19.810"></a><span id="l19.810" class="difflineminus">-        }</span>
<a href="#l19.811"></a><span id="l19.811" class="difflineminus">-      }</span>
<a href="#l19.812"></a><span id="l19.812" class="difflineminus">-    }</span>
<a href="#l19.813"></a><span id="l19.813" class="difflineminus">-  }</span>
<a href="#l19.814"></a><span id="l19.814" class="difflineminus">-</span>
<a href="#l19.815"></a><span id="l19.815" class="difflineminus">-  rv = outputStream-&gt;Flush();</span>
<a href="#l19.816"></a><span id="l19.816" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.817"></a><span id="l19.817" class="difflineminus">-</span>
<a href="#l19.818"></a><span id="l19.818" class="difflineminus">-  rv = outputStream-&gt;Close();</span>
<a href="#l19.819"></a><span id="l19.819" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.820"></a><span id="l19.820" class="difflineminus">-  return NS_OK;</span>
<a href="#l19.821"></a><span id="l19.821" class="difflineminus">-}</span>
<a href="#l19.822"></a><span id="l19.822" class="difflineminus">-</span>
<a href="#l19.823"></a><span id="l19.823" class="difflineminus">-nsresult nsAbManager::ExportDirectoryToVCard(nsIAbDirectory *aDirectory,</span>
<a href="#l19.824"></a><span id="l19.824" class="difflineminus">-                                             nsIFile *aLocalFile) {</span>
<a href="#l19.825"></a><span id="l19.825" class="difflineminus">-  nsCOMPtr&lt;nsISimpleEnumerator&gt; cardsEnumerator;</span>
<a href="#l19.826"></a><span id="l19.826" class="difflineminus">-  nsCOMPtr&lt;nsIAbCard&gt; card;</span>
<a href="#l19.827"></a><span id="l19.827" class="difflineminus">-</span>
<a href="#l19.828"></a><span id="l19.828" class="difflineminus">-  nsresult rv;</span>
<a href="#l19.829"></a><span id="l19.829" class="difflineminus">-</span>
<a href="#l19.830"></a><span id="l19.830" class="difflineminus">-  nsCOMPtr&lt;nsIOutputStream&gt; outputStream;</span>
<a href="#l19.831"></a><span id="l19.831" class="difflineminus">-  rv = MsgNewBufferedFileOutputStream(getter_AddRefs(outputStream), aLocalFile,</span>
<a href="#l19.832"></a><span id="l19.832" class="difflineminus">-                                      PR_CREATE_FILE | PR_WRONLY | PR_TRUNCATE,</span>
<a href="#l19.833"></a><span id="l19.833" class="difflineminus">-                                      0664);</span>
<a href="#l19.834"></a><span id="l19.834" class="difflineminus">-</span>
<a href="#l19.835"></a><span id="l19.835" class="difflineminus">-  // the desired file may be read only</span>
<a href="#l19.836"></a><span id="l19.836" class="difflineminus">-  if (NS_FAILED(rv)) return rv;</span>
<a href="#l19.837"></a><span id="l19.837" class="difflineminus">-</span>
<a href="#l19.838"></a><span id="l19.838" class="difflineminus">-  uint32_t writeCount;</span>
<a href="#l19.839"></a><span id="l19.839" class="difflineminus">-  uint32_t length;</span>
<a href="#l19.840"></a><span id="l19.840" class="difflineminus">-</span>
<a href="#l19.841"></a><span id="l19.841" class="difflineminus">-  rv = aDirectory-&gt;GetChildCards(getter_AddRefs(cardsEnumerator));</span>
<a href="#l19.842"></a><span id="l19.842" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; cardsEnumerator) {</span>
<a href="#l19.843"></a><span id="l19.843" class="difflineminus">-    nsCOMPtr&lt;nsISupports&gt; item;</span>
<a href="#l19.844"></a><span id="l19.844" class="difflineminus">-    bool more;</span>
<a href="#l19.845"></a><span id="l19.845" class="difflineminus">-    while (NS_SUCCEEDED(cardsEnumerator-&gt;HasMoreElements(&amp;more)) &amp;&amp; more) {</span>
<a href="#l19.846"></a><span id="l19.846" class="difflineminus">-      rv = cardsEnumerator-&gt;GetNext(getter_AddRefs(item));</span>
<a href="#l19.847"></a><span id="l19.847" class="difflineminus">-      if (NS_SUCCEEDED(rv)) {</span>
<a href="#l19.848"></a><span id="l19.848" class="difflineminus">-        nsCOMPtr&lt;nsIAbCard&gt; card = do_QueryInterface(item, &amp;rv);</span>
<a href="#l19.849"></a><span id="l19.849" class="difflineminus">-        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.850"></a><span id="l19.850" class="difflineminus">-</span>
<a href="#l19.851"></a><span id="l19.851" class="difflineminus">-        bool isMailList;</span>
<a href="#l19.852"></a><span id="l19.852" class="difflineminus">-        rv = card-&gt;GetIsMailList(&amp;isMailList);</span>
<a href="#l19.853"></a><span id="l19.853" class="difflineminus">-        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.854"></a><span id="l19.854" class="difflineminus">-</span>
<a href="#l19.855"></a><span id="l19.855" class="difflineminus">-        if (isMailList) {</span>
<a href="#l19.856"></a><span id="l19.856" class="difflineminus">-          // we don't know how to export mailing lists to vcf</span>
<a href="#l19.857"></a><span id="l19.857" class="difflineminus">-          // use LDIF for that.</span>
<a href="#l19.858"></a><span id="l19.858" class="difflineminus">-        } else {</span>
<a href="#l19.859"></a><span id="l19.859" class="difflineminus">-          nsCString escapedValue;</span>
<a href="#l19.860"></a><span id="l19.860" class="difflineminus">-          rv = card-&gt;TranslateTo(NS_LITERAL_CSTRING(&quot;vcard&quot;), escapedValue);</span>
<a href="#l19.861"></a><span id="l19.861" class="difflineminus">-          NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.862"></a><span id="l19.862" class="difflineminus">-</span>
<a href="#l19.863"></a><span id="l19.863" class="difflineminus">-          nsCString valueCStr;</span>
<a href="#l19.864"></a><span id="l19.864" class="difflineminus">-          MsgUnescapeString(escapedValue, 0, valueCStr);</span>
<a href="#l19.865"></a><span id="l19.865" class="difflineminus">-</span>
<a href="#l19.866"></a><span id="l19.866" class="difflineminus">-          length = valueCStr.Length();</span>
<a href="#l19.867"></a><span id="l19.867" class="difflineminus">-          rv = outputStream-&gt;Write(valueCStr.get(), length, &amp;writeCount);</span>
<a href="#l19.868"></a><span id="l19.868" class="difflineminus">-          NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.869"></a><span id="l19.869" class="difflineminus">-          if (length != writeCount) return NS_ERROR_FAILURE;</span>
<a href="#l19.870"></a><span id="l19.870" class="difflineminus">-        }</span>
<a href="#l19.871"></a><span id="l19.871" class="difflineminus">-      }</span>
<a href="#l19.872"></a><span id="l19.872" class="difflineminus">-    }</span>
<a href="#l19.873"></a><span id="l19.873" class="difflineminus">-  }</span>
<a href="#l19.874"></a><span id="l19.874" class="difflineminus">-</span>
<a href="#l19.875"></a><span id="l19.875" class="difflineminus">-  rv = outputStream-&gt;Flush();</span>
<a href="#l19.876"></a><span id="l19.876" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.877"></a><span id="l19.877" class="difflineminus">-</span>
<a href="#l19.878"></a><span id="l19.878" class="difflineminus">-  rv = outputStream-&gt;Close();</span>
<a href="#l19.879"></a><span id="l19.879" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.880"></a><span id="l19.880" class="difflineminus">-  return NS_OK;</span>
<a href="#l19.881"></a><span id="l19.881" class="difflineminus">-}</span>
<a href="#l19.882"></a><span id="l19.882" class="difflineminus">-</span>
<a href="#l19.883"></a><span id="l19.883" class="difflineminus">-nsresult nsAbManager::ExportDirectoryToLDIF(nsIAbDirectory *aDirectory,</span>
<a href="#l19.884"></a><span id="l19.884" class="difflineminus">-                                            nsIFile *aLocalFile) {</span>
<a href="#l19.885"></a><span id="l19.885" class="difflineminus">-  nsCOMPtr&lt;nsISimpleEnumerator&gt; cardsEnumerator;</span>
<a href="#l19.886"></a><span id="l19.886" class="difflineminus">-  nsCOMPtr&lt;nsIAbCard&gt; card;</span>
<a href="#l19.887"></a><span id="l19.887" class="difflineminus">-</span>
<a href="#l19.888"></a><span id="l19.888" class="difflineminus">-  nsresult rv;</span>
<a href="#l19.889"></a><span id="l19.889" class="difflineminus">-</span>
<a href="#l19.890"></a><span id="l19.890" class="difflineminus">-  nsCOMPtr&lt;nsIOutputStream&gt; outputStream;</span>
<a href="#l19.891"></a><span id="l19.891" class="difflineminus">-  rv = MsgNewBufferedFileOutputStream(getter_AddRefs(outputStream), aLocalFile,</span>
<a href="#l19.892"></a><span id="l19.892" class="difflineminus">-                                      PR_CREATE_FILE | PR_WRONLY | PR_TRUNCATE,</span>
<a href="#l19.893"></a><span id="l19.893" class="difflineminus">-                                      0664);</span>
<a href="#l19.894"></a><span id="l19.894" class="difflineminus">-</span>
<a href="#l19.895"></a><span id="l19.895" class="difflineminus">-  // the desired file may be read only</span>
<a href="#l19.896"></a><span id="l19.896" class="difflineminus">-  if (NS_FAILED(rv)) return rv;</span>
<a href="#l19.897"></a><span id="l19.897" class="difflineminus">-</span>
<a href="#l19.898"></a><span id="l19.898" class="difflineminus">-  // Get the default attribute map for ldap. We use the default attribute</span>
<a href="#l19.899"></a><span id="l19.899" class="difflineminus">-  // map rather than one for a specific server because if people want an</span>
<a href="#l19.900"></a><span id="l19.900" class="difflineminus">-  // ldif export using a servers specific schema, then they can use ldapsearch</span>
<a href="#l19.901"></a><span id="l19.901" class="difflineminus">-  nsCOMPtr&lt;nsIAbLDAPAttributeMapService&gt; mapSrv = do_GetService(</span>
<a href="#l19.902"></a><span id="l19.902" class="difflineminus">-      &quot;@mozilla.org/addressbook/ldap-attribute-map-service;1&quot;, &amp;rv);</span>
<a href="#l19.903"></a><span id="l19.903" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.904"></a><span id="l19.904" class="difflineminus">-</span>
<a href="#l19.905"></a><span id="l19.905" class="difflineminus">-  nsCOMPtr&lt;nsIAbLDAPAttributeMap&gt; attrMap;</span>
<a href="#l19.906"></a><span id="l19.906" class="difflineminus">-  rv = mapSrv-&gt;GetMapForPrefBranch(</span>
<a href="#l19.907"></a><span id="l19.907" class="difflineminus">-      NS_LITERAL_CSTRING(&quot;ldap_2.servers.default.attrmap&quot;),</span>
<a href="#l19.908"></a><span id="l19.908" class="difflineminus">-      getter_AddRefs(attrMap));</span>
<a href="#l19.909"></a><span id="l19.909" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.910"></a><span id="l19.910" class="difflineminus">-</span>
<a href="#l19.911"></a><span id="l19.911" class="difflineminus">-  uint32_t i;</span>
<a href="#l19.912"></a><span id="l19.912" class="difflineminus">-  uint32_t writeCount;</span>
<a href="#l19.913"></a><span id="l19.913" class="difflineminus">-  uint32_t length;</span>
<a href="#l19.914"></a><span id="l19.914" class="difflineminus">-</span>
<a href="#l19.915"></a><span id="l19.915" class="difflineminus">-  rv = aDirectory-&gt;GetChildCards(getter_AddRefs(cardsEnumerator));</span>
<a href="#l19.916"></a><span id="l19.916" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; cardsEnumerator) {</span>
<a href="#l19.917"></a><span id="l19.917" class="difflineminus">-    nsCOMPtr&lt;nsISupports&gt; item;</span>
<a href="#l19.918"></a><span id="l19.918" class="difflineminus">-    bool more;</span>
<a href="#l19.919"></a><span id="l19.919" class="difflineminus">-    while (NS_SUCCEEDED(cardsEnumerator-&gt;HasMoreElements(&amp;more)) &amp;&amp; more) {</span>
<a href="#l19.920"></a><span id="l19.920" class="difflineminus">-      rv = cardsEnumerator-&gt;GetNext(getter_AddRefs(item));</span>
<a href="#l19.921"></a><span id="l19.921" class="difflineminus">-      if (NS_SUCCEEDED(rv)) {</span>
<a href="#l19.922"></a><span id="l19.922" class="difflineminus">-        nsCOMPtr&lt;nsIAbCard&gt; card = do_QueryInterface(item, &amp;rv);</span>
<a href="#l19.923"></a><span id="l19.923" class="difflineminus">-        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.924"></a><span id="l19.924" class="difflineminus">-</span>
<a href="#l19.925"></a><span id="l19.925" class="difflineminus">-        bool isMailList;</span>
<a href="#l19.926"></a><span id="l19.926" class="difflineminus">-        rv = card-&gt;GetIsMailList(&amp;isMailList);</span>
<a href="#l19.927"></a><span id="l19.927" class="difflineminus">-        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.928"></a><span id="l19.928" class="difflineminus">-</span>
<a href="#l19.929"></a><span id="l19.929" class="difflineminus">-        if (isMailList) {</span>
<a href="#l19.930"></a><span id="l19.930" class="difflineminus">-          nsCString mailListCStr;</span>
<a href="#l19.931"></a><span id="l19.931" class="difflineminus">-</span>
<a href="#l19.932"></a><span id="l19.932" class="difflineminus">-          rv = AppendLDIFForMailList(card, attrMap, mailListCStr);</span>
<a href="#l19.933"></a><span id="l19.933" class="difflineminus">-          NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.934"></a><span id="l19.934" class="difflineminus">-</span>
<a href="#l19.935"></a><span id="l19.935" class="difflineminus">-          length = mailListCStr.Length();</span>
<a href="#l19.936"></a><span id="l19.936" class="difflineminus">-          rv = outputStream-&gt;Write(mailListCStr.get(), length, &amp;writeCount);</span>
<a href="#l19.937"></a><span id="l19.937" class="difflineminus">-          NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.938"></a><span id="l19.938" class="difflineminus">-          if (length != writeCount) return NS_ERROR_FAILURE;</span>
<a href="#l19.939"></a><span id="l19.939" class="difflineminus">-        } else {</span>
<a href="#l19.940"></a><span id="l19.940" class="difflineminus">-          nsString value;</span>
<a href="#l19.941"></a><span id="l19.941" class="difflineminus">-          nsCString valueCStr;</span>
<a href="#l19.942"></a><span id="l19.942" class="difflineminus">-</span>
<a href="#l19.943"></a><span id="l19.943" class="difflineminus">-          rv = AppendBasicLDIFForCard(card, attrMap, valueCStr);</span>
<a href="#l19.944"></a><span id="l19.944" class="difflineminus">-          NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.945"></a><span id="l19.945" class="difflineminus">-</span>
<a href="#l19.946"></a><span id="l19.946" class="difflineminus">-          length = valueCStr.Length();</span>
<a href="#l19.947"></a><span id="l19.947" class="difflineminus">-          rv = outputStream-&gt;Write(valueCStr.get(), length, &amp;writeCount);</span>
<a href="#l19.948"></a><span id="l19.948" class="difflineminus">-          NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.949"></a><span id="l19.949" class="difflineminus">-          if (length != writeCount) return NS_ERROR_FAILURE;</span>
<a href="#l19.950"></a><span id="l19.950" class="difflineminus">-</span>
<a href="#l19.951"></a><span id="l19.951" class="difflineminus">-          valueCStr.Truncate();</span>
<a href="#l19.952"></a><span id="l19.952" class="difflineminus">-</span>
<a href="#l19.953"></a><span id="l19.953" class="difflineminus">-          nsAutoCString ldapAttribute;</span>
<a href="#l19.954"></a><span id="l19.954" class="difflineminus">-</span>
<a href="#l19.955"></a><span id="l19.955" class="difflineminus">-          for (i = 0; i &lt; ArrayLength(EXPORT_ATTRIBUTES_TABLE); i++) {</span>
<a href="#l19.956"></a><span id="l19.956" class="difflineminus">-            if (NS_SUCCEEDED(attrMap-&gt;GetFirstAttribute(</span>
<a href="#l19.957"></a><span id="l19.957" class="difflineminus">-                    nsDependentCString(</span>
<a href="#l19.958"></a><span id="l19.958" class="difflineminus">-                        EXPORT_ATTRIBUTES_TABLE[i].abPropertyName),</span>
<a href="#l19.959"></a><span id="l19.959" class="difflineminus">-                    ldapAttribute)) &amp;&amp;</span>
<a href="#l19.960"></a><span id="l19.960" class="difflineminus">-                !ldapAttribute.IsEmpty()) {</span>
<a href="#l19.961"></a><span id="l19.961" class="difflineminus">-              rv = card-&gt;GetPropertyAsAString(</span>
<a href="#l19.962"></a><span id="l19.962" class="difflineminus">-                  EXPORT_ATTRIBUTES_TABLE[i].abPropertyName, value);</span>
<a href="#l19.963"></a><span id="l19.963" class="difflineminus">-              if (NS_FAILED(rv)) value.Truncate();</span>
<a href="#l19.964"></a><span id="l19.964" class="difflineminus">-</span>
<a href="#l19.965"></a><span id="l19.965" class="difflineminus">-              if (!PL_strcmp(EXPORT_ATTRIBUTES_TABLE[i].abPropertyName,</span>
<a href="#l19.966"></a><span id="l19.966" class="difflineminus">-                             kPreferMailFormatProperty)) {</span>
<a href="#l19.967"></a><span id="l19.967" class="difflineminus">-                if (value.EqualsLiteral(&quot;html&quot;))</span>
<a href="#l19.968"></a><span id="l19.968" class="difflineminus">-                  value.AssignLiteral(&quot;true&quot;);</span>
<a href="#l19.969"></a><span id="l19.969" class="difflineminus">-                else if (value.EqualsLiteral(&quot;plaintext&quot;))</span>
<a href="#l19.970"></a><span id="l19.970" class="difflineminus">-                  value.AssignLiteral(&quot;false&quot;);</span>
<a href="#l19.971"></a><span id="l19.971" class="difflineminus">-                else</span>
<a href="#l19.972"></a><span id="l19.972" class="difflineminus">-                  value.Truncate();  // unknown.</span>
<a href="#l19.973"></a><span id="l19.973" class="difflineminus">-              }</span>
<a href="#l19.974"></a><span id="l19.974" class="difflineminus">-</span>
<a href="#l19.975"></a><span id="l19.975" class="difflineminus">-              if (!value.IsEmpty()) {</span>
<a href="#l19.976"></a><span id="l19.976" class="difflineminus">-                rv =</span>
<a href="#l19.977"></a><span id="l19.977" class="difflineminus">-                    AppendProperty(ldapAttribute.get(), value.get(), valueCStr);</span>
<a href="#l19.978"></a><span id="l19.978" class="difflineminus">-                NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.979"></a><span id="l19.979" class="difflineminus">-</span>
<a href="#l19.980"></a><span id="l19.980" class="difflineminus">-                valueCStr += MSG_LINEBREAK;</span>
<a href="#l19.981"></a><span id="l19.981" class="difflineminus">-              } else</span>
<a href="#l19.982"></a><span id="l19.982" class="difflineminus">-                valueCStr.Truncate();</span>
<a href="#l19.983"></a><span id="l19.983" class="difflineminus">-</span>
<a href="#l19.984"></a><span id="l19.984" class="difflineminus">-              length = valueCStr.Length();</span>
<a href="#l19.985"></a><span id="l19.985" class="difflineminus">-              if (length) {</span>
<a href="#l19.986"></a><span id="l19.986" class="difflineminus">-                rv = outputStream-&gt;Write(valueCStr.get(), length, &amp;writeCount);</span>
<a href="#l19.987"></a><span id="l19.987" class="difflineminus">-                NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.988"></a><span id="l19.988" class="difflineminus">-                if (length != writeCount) return NS_ERROR_FAILURE;</span>
<a href="#l19.989"></a><span id="l19.989" class="difflineminus">-              }</span>
<a href="#l19.990"></a><span id="l19.990" class="difflineminus">-              valueCStr.Truncate();</span>
<a href="#l19.991"></a><span id="l19.991" class="difflineminus">-            } else {</span>
<a href="#l19.992"></a><span id="l19.992" class="difflineminus">-              // something we don't support yet</span>
<a href="#l19.993"></a><span id="l19.993" class="difflineminus">-              // ldif doesn't export multiple addresses</span>
<a href="#l19.994"></a><span id="l19.994" class="difflineminus">-            }</span>
<a href="#l19.995"></a><span id="l19.995" class="difflineminus">-          }</span>
<a href="#l19.996"></a><span id="l19.996" class="difflineminus">-</span>
<a href="#l19.997"></a><span id="l19.997" class="difflineminus">-          // write out the linebreak that separates the cards</span>
<a href="#l19.998"></a><span id="l19.998" class="difflineminus">-          rv = outputStream-&gt;Write(MSG_LINEBREAK, MSG_LINEBREAK_LEN,</span>
<a href="#l19.999"></a><span id="l19.999" class="difflineminus">-                                   &amp;writeCount);</span>
<a href="#l19.1000"></a><span id="l19.1000" class="difflineminus">-          NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.1001"></a><span id="l19.1001" class="difflineminus">-          if (MSG_LINEBREAK_LEN != writeCount) return NS_ERROR_FAILURE;</span>
<a href="#l19.1002"></a><span id="l19.1002" class="difflineminus">-        }</span>
<a href="#l19.1003"></a><span id="l19.1003" class="difflineminus">-      }</span>
<a href="#l19.1004"></a><span id="l19.1004" class="difflineminus">-    }</span>
<a href="#l19.1005"></a><span id="l19.1005" class="difflineminus">-  }</span>
<a href="#l19.1006"></a><span id="l19.1006" class="difflineminus">-</span>
<a href="#l19.1007"></a><span id="l19.1007" class="difflineminus">-  rv = outputStream-&gt;Flush();</span>
<a href="#l19.1008"></a><span id="l19.1008" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.1009"></a><span id="l19.1009" class="difflineminus">-</span>
<a href="#l19.1010"></a><span id="l19.1010" class="difflineminus">-  rv = outputStream-&gt;Close();</span>
<a href="#l19.1011"></a><span id="l19.1011" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.1012"></a><span id="l19.1012" class="difflineminus">-  return NS_OK;</span>
<a href="#l19.1013"></a><span id="l19.1013" class="difflineminus">-}</span>
<a href="#l19.1014"></a><span id="l19.1014" class="difflineminus">-</span>
<a href="#l19.1015"></a><span id="l19.1015" class="difflineminus">-nsresult nsAbManager::AppendLDIFForMailList(nsIAbCard *aCard,</span>
<a href="#l19.1016"></a><span id="l19.1016" class="difflineminus">-                                            nsIAbLDAPAttributeMap *aAttrMap,</span>
<a href="#l19.1017"></a><span id="l19.1017" class="difflineminus">-                                            nsACString &amp;aResult) {</span>
<a href="#l19.1018"></a><span id="l19.1018" class="difflineminus">-  nsresult rv;</span>
<a href="#l19.1019"></a><span id="l19.1019" class="difflineminus">-  nsString attrValue;</span>
<a href="#l19.1020"></a><span id="l19.1020" class="difflineminus">-</span>
<a href="#l19.1021"></a><span id="l19.1021" class="difflineminus">-  rv = AppendDNForCard(&quot;dn&quot;, aCard, aAttrMap, aResult);</span>
<a href="#l19.1022"></a><span id="l19.1022" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.1023"></a><span id="l19.1023" class="difflineminus">-</span>
<a href="#l19.1024"></a><span id="l19.1024" class="difflineminus">-  aResult += MSG_LINEBREAK &quot;objectclass: top&quot; MSG_LINEBREAK</span>
<a href="#l19.1025"></a><span id="l19.1025" class="difflineminus">-                           &quot;objectclass: groupOfNames&quot; MSG_LINEBREAK;</span>
<a href="#l19.1026"></a><span id="l19.1026" class="difflineminus">-</span>
<a href="#l19.1027"></a><span id="l19.1027" class="difflineminus">-  rv = aCard-&gt;GetDisplayName(attrValue);</span>
<a href="#l19.1028"></a><span id="l19.1028" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.1029"></a><span id="l19.1029" class="difflineminus">-</span>
<a href="#l19.1030"></a><span id="l19.1030" class="difflineminus">-  nsAutoCString ldapAttributeName;</span>
<a href="#l19.1031"></a><span id="l19.1031" class="difflineminus">-</span>
<a href="#l19.1032"></a><span id="l19.1032" class="difflineminus">-  rv = aAttrMap-&gt;GetFirstAttribute(NS_LITERAL_CSTRING(kDisplayNameProperty),</span>
<a href="#l19.1033"></a><span id="l19.1033" class="difflineminus">-                                   ldapAttributeName);</span>
<a href="#l19.1034"></a><span id="l19.1034" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.1035"></a><span id="l19.1035" class="difflineminus">-</span>
<a href="#l19.1036"></a><span id="l19.1036" class="difflineminus">-  rv = AppendProperty(ldapAttributeName.get(), attrValue.get(), aResult);</span>
<a href="#l19.1037"></a><span id="l19.1037" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.1038"></a><span id="l19.1038" class="difflineminus">-  aResult += MSG_LINEBREAK;</span>
<a href="#l19.1039"></a><span id="l19.1039" class="difflineminus">-</span>
<a href="#l19.1040"></a><span id="l19.1040" class="difflineminus">-  rv = aAttrMap-&gt;GetFirstAttribute(NS_LITERAL_CSTRING(kNicknameProperty),</span>
<a href="#l19.1041"></a><span id="l19.1041" class="difflineminus">-                                   ldapAttributeName);</span>
<a href="#l19.1042"></a><span id="l19.1042" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.1043"></a><span id="l19.1043" class="difflineminus">-</span>
<a href="#l19.1044"></a><span id="l19.1044" class="difflineminus">-  rv = aCard-&gt;GetPropertyAsAString(kNicknameProperty, attrValue);</span>
<a href="#l19.1045"></a><span id="l19.1045" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; !attrValue.IsEmpty()) {</span>
<a href="#l19.1046"></a><span id="l19.1046" class="difflineminus">-    rv = AppendProperty(ldapAttributeName.get(), attrValue.get(), aResult);</span>
<a href="#l19.1047"></a><span id="l19.1047" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.1048"></a><span id="l19.1048" class="difflineminus">-    aResult += MSG_LINEBREAK;</span>
<a href="#l19.1049"></a><span id="l19.1049" class="difflineminus">-  }</span>
<a href="#l19.1050"></a><span id="l19.1050" class="difflineminus">-</span>
<a href="#l19.1051"></a><span id="l19.1051" class="difflineminus">-  rv = aAttrMap-&gt;GetFirstAttribute(NS_LITERAL_CSTRING(kNotesProperty),</span>
<a href="#l19.1052"></a><span id="l19.1052" class="difflineminus">-                                   ldapAttributeName);</span>
<a href="#l19.1053"></a><span id="l19.1053" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.1054"></a><span id="l19.1054" class="difflineminus">-</span>
<a href="#l19.1055"></a><span id="l19.1055" class="difflineminus">-  rv = aCard-&gt;GetPropertyAsAString(kNotesProperty, attrValue);</span>
<a href="#l19.1056"></a><span id="l19.1056" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; !attrValue.IsEmpty()) {</span>
<a href="#l19.1057"></a><span id="l19.1057" class="difflineminus">-    rv = AppendProperty(ldapAttributeName.get(), attrValue.get(), aResult);</span>
<a href="#l19.1058"></a><span id="l19.1058" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.1059"></a><span id="l19.1059" class="difflineminus">-    aResult += MSG_LINEBREAK;</span>
<a href="#l19.1060"></a><span id="l19.1060" class="difflineminus">-  }</span>
<a href="#l19.1061"></a><span id="l19.1061" class="difflineminus">-</span>
<a href="#l19.1062"></a><span id="l19.1062" class="difflineminus">-  nsCString mailListURI;</span>
<a href="#l19.1063"></a><span id="l19.1063" class="difflineminus">-  rv = aCard-&gt;GetMailListURI(getter_Copies(mailListURI));</span>
<a href="#l19.1064"></a><span id="l19.1064" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.1065"></a><span id="l19.1065" class="difflineminus">-</span>
<a href="#l19.1066"></a><span id="l19.1066" class="difflineminus">-  nsCOMPtr&lt;nsIAbDirectory&gt; mailList;</span>
<a href="#l19.1067"></a><span id="l19.1067" class="difflineminus">-  rv = GetDirectory(mailListURI, getter_AddRefs(mailList));</span>
<a href="#l19.1068"></a><span id="l19.1068" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.1069"></a><span id="l19.1069" class="difflineminus">-</span>
<a href="#l19.1070"></a><span id="l19.1070" class="difflineminus">-  nsCOMPtr&lt;nsIMutableArray&gt; addresses;</span>
<a href="#l19.1071"></a><span id="l19.1071" class="difflineminus">-  rv = mailList-&gt;GetAddressLists(getter_AddRefs(addresses));</span>
<a href="#l19.1072"></a><span id="l19.1072" class="difflineminus">-  if (addresses) {</span>
<a href="#l19.1073"></a><span id="l19.1073" class="difflineminus">-    uint32_t total = 0;</span>
<a href="#l19.1074"></a><span id="l19.1074" class="difflineminus">-    addresses-&gt;GetLength(&amp;total);</span>
<a href="#l19.1075"></a><span id="l19.1075" class="difflineminus">-    if (total) {</span>
<a href="#l19.1076"></a><span id="l19.1076" class="difflineminus">-      uint32_t i;</span>
<a href="#l19.1077"></a><span id="l19.1077" class="difflineminus">-      for (i = 0; i &lt; total; i++) {</span>
<a href="#l19.1078"></a><span id="l19.1078" class="difflineminus">-        nsCOMPtr&lt;nsIAbCard&gt; listCard = do_QueryElementAt(addresses, i, &amp;rv);</span>
<a href="#l19.1079"></a><span id="l19.1079" class="difflineminus">-        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.1080"></a><span id="l19.1080" class="difflineminus">-</span>
<a href="#l19.1081"></a><span id="l19.1081" class="difflineminus">-        rv = AppendDNForCard(&quot;member&quot;, listCard, aAttrMap, aResult);</span>
<a href="#l19.1082"></a><span id="l19.1082" class="difflineminus">-        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.1083"></a><span id="l19.1083" class="difflineminus">-</span>
<a href="#l19.1084"></a><span id="l19.1084" class="difflineminus">-        aResult += MSG_LINEBREAK;</span>
<a href="#l19.1085"></a><span id="l19.1085" class="difflineminus">-      }</span>
<a href="#l19.1086"></a><span id="l19.1086" class="difflineminus">-    }</span>
<a href="#l19.1087"></a><span id="l19.1087" class="difflineminus">-  }</span>
<a href="#l19.1088"></a><span id="l19.1088" class="difflineminus">-</span>
<a href="#l19.1089"></a><span id="l19.1089" class="difflineminus">-  aResult += MSG_LINEBREAK;</span>
<a href="#l19.1090"></a><span id="l19.1090" class="difflineminus">-  return NS_OK;</span>
<a href="#l19.1091"></a><span id="l19.1091" class="difflineminus">-}</span>
<a href="#l19.1092"></a><span id="l19.1092" class="difflineminus">-</span>
<a href="#l19.1093"></a><span id="l19.1093" class="difflineminus">-nsresult nsAbManager::AppendDNForCard(const char *aProperty, nsIAbCard *aCard,</span>
<a href="#l19.1094"></a><span id="l19.1094" class="difflineminus">-                                      nsIAbLDAPAttributeMap *aAttrMap,</span>
<a href="#l19.1095"></a><span id="l19.1095" class="difflineminus">-                                      nsACString &amp;aResult) {</span>
<a href="#l19.1096"></a><span id="l19.1096" class="difflineminus">-  nsString email;</span>
<a href="#l19.1097"></a><span id="l19.1097" class="difflineminus">-  nsString displayName;</span>
<a href="#l19.1098"></a><span id="l19.1098" class="difflineminus">-  nsAutoCString ldapAttributeName;</span>
<a href="#l19.1099"></a><span id="l19.1099" class="difflineminus">-</span>
<a href="#l19.1100"></a><span id="l19.1100" class="difflineminus">-  nsresult rv = aCard-&gt;GetPrimaryEmail(email);</span>
<a href="#l19.1101"></a><span id="l19.1101" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.1102"></a><span id="l19.1102" class="difflineminus">-</span>
<a href="#l19.1103"></a><span id="l19.1103" class="difflineminus">-  rv = aCard-&gt;GetDisplayName(displayName);</span>
<a href="#l19.1104"></a><span id="l19.1104" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.1105"></a><span id="l19.1105" class="difflineminus">-</span>
<a href="#l19.1106"></a><span id="l19.1106" class="difflineminus">-  nsString cnStr;</span>
<a href="#l19.1107"></a><span id="l19.1107" class="difflineminus">-</span>
<a href="#l19.1108"></a><span id="l19.1108" class="difflineminus">-  rv = aAttrMap-&gt;GetFirstAttribute(NS_LITERAL_CSTRING(kDisplayNameProperty),</span>
<a href="#l19.1109"></a><span id="l19.1109" class="difflineminus">-                                   ldapAttributeName);</span>
<a href="#l19.1110"></a><span id="l19.1110" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.1111"></a><span id="l19.1111" class="difflineminus">-</span>
<a href="#l19.1112"></a><span id="l19.1112" class="difflineminus">-  if (!displayName.IsEmpty()) {</span>
<a href="#l19.1113"></a><span id="l19.1113" class="difflineminus">-    cnStr += NS_ConvertUTF8toUTF16(ldapAttributeName).get();</span>
<a href="#l19.1114"></a><span id="l19.1114" class="difflineminus">-    cnStr.Append('=');</span>
<a href="#l19.1115"></a><span id="l19.1115" class="difflineminus">-    cnStr.Append(displayName);</span>
<a href="#l19.1116"></a><span id="l19.1116" class="difflineminus">-    if (!email.IsEmpty()) {</span>
<a href="#l19.1117"></a><span id="l19.1117" class="difflineminus">-      cnStr.Append(',');</span>
<a href="#l19.1118"></a><span id="l19.1118" class="difflineminus">-    }</span>
<a href="#l19.1119"></a><span id="l19.1119" class="difflineminus">-  }</span>
<a href="#l19.1120"></a><span id="l19.1120" class="difflineminus">-</span>
<a href="#l19.1121"></a><span id="l19.1121" class="difflineminus">-  rv = aAttrMap-&gt;GetFirstAttribute(NS_LITERAL_CSTRING(kPriEmailProperty),</span>
<a href="#l19.1122"></a><span id="l19.1122" class="difflineminus">-                                   ldapAttributeName);</span>
<a href="#l19.1123"></a><span id="l19.1123" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.1124"></a><span id="l19.1124" class="difflineminus">-</span>
<a href="#l19.1125"></a><span id="l19.1125" class="difflineminus">-  if (!email.IsEmpty()) {</span>
<a href="#l19.1126"></a><span id="l19.1126" class="difflineminus">-    cnStr += NS_ConvertUTF8toUTF16(ldapAttributeName).get();</span>
<a href="#l19.1127"></a><span id="l19.1127" class="difflineminus">-    cnStr.Append('=');</span>
<a href="#l19.1128"></a><span id="l19.1128" class="difflineminus">-    cnStr.Append(email);</span>
<a href="#l19.1129"></a><span id="l19.1129" class="difflineminus">-  }</span>
<a href="#l19.1130"></a><span id="l19.1130" class="difflineminus">-</span>
<a href="#l19.1131"></a><span id="l19.1131" class="difflineminus">-  rv = AppendProperty(aProperty, cnStr.get(), aResult);</span>
<a href="#l19.1132"></a><span id="l19.1132" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.1133"></a><span id="l19.1133" class="difflineminus">-  return rv;</span>
<a href="#l19.1134"></a><span id="l19.1134" class="difflineminus">-}</span>
<a href="#l19.1135"></a><span id="l19.1135" class="difflineminus">-</span>
<a href="#l19.1136"></a><span id="l19.1136" class="difflineminus">-nsresult nsAbManager::AppendBasicLDIFForCard(nsIAbCard *aCard,</span>
<a href="#l19.1137"></a><span id="l19.1137" class="difflineminus">-                                             nsIAbLDAPAttributeMap *aAttrMap,</span>
<a href="#l19.1138"></a><span id="l19.1138" class="difflineminus">-                                             nsACString &amp;aResult) {</span>
<a href="#l19.1139"></a><span id="l19.1139" class="difflineminus">-  nsresult rv = AppendDNForCard(&quot;dn&quot;, aCard, aAttrMap, aResult);</span>
<a href="#l19.1140"></a><span id="l19.1140" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.1141"></a><span id="l19.1141" class="difflineminus">-  aResult += MSG_LINEBREAK &quot;objectclass: top&quot; MSG_LINEBREAK</span>
<a href="#l19.1142"></a><span id="l19.1142" class="difflineminus">-                           &quot;objectclass: person&quot; MSG_LINEBREAK</span>
<a href="#l19.1143"></a><span id="l19.1143" class="difflineminus">-                           &quot;objectclass: organizationalPerson&quot; MSG_LINEBREAK</span>
<a href="#l19.1144"></a><span id="l19.1144" class="difflineminus">-                           &quot;objectclass: inetOrgPerson&quot; MSG_LINEBREAK</span>
<a href="#l19.1145"></a><span id="l19.1145" class="difflineminus">-                           &quot;objectclass: &quot; MOZ_AB_OBJECTCLASS MSG_LINEBREAK;</span>
<a href="#l19.1146"></a><span id="l19.1146" class="difflineminus">-  return rv;</span>
<a href="#l19.1147"></a><span id="l19.1147" class="difflineminus">-}</span>
<a href="#l19.1148"></a><span id="l19.1148" class="difflineminus">-</span>
<a href="#l19.1149"></a><span id="l19.1149" class="difflineminus">-bool nsAbManager::IsSafeLDIFString(const char16_t *aStr) {</span>
<a href="#l19.1150"></a><span id="l19.1150" class="difflineminus">-  // follow RFC 2849 to determine if something is safe &quot;as is&quot; for LDIF</span>
<a href="#l19.1151"></a><span id="l19.1151" class="difflineminus">-  if (aStr[0] == char16_t(' ') || aStr[0] == char16_t(':') ||</span>
<a href="#l19.1152"></a><span id="l19.1152" class="difflineminus">-      aStr[0] == char16_t('&lt;'))</span>
<a href="#l19.1153"></a><span id="l19.1153" class="difflineminus">-    return false;</span>
<a href="#l19.1154"></a><span id="l19.1154" class="difflineminus">-</span>
<a href="#l19.1155"></a><span id="l19.1155" class="difflineminus">-  uint32_t i;</span>
<a href="#l19.1156"></a><span id="l19.1156" class="difflineminus">-  uint32_t len = NS_strlen(aStr);</span>
<a href="#l19.1157"></a><span id="l19.1157" class="difflineminus">-  for (i = 0; i &lt; len; i++) {</span>
<a href="#l19.1158"></a><span id="l19.1158" class="difflineminus">-    // If string contains CR or LF, it is not safe for LDIF</span>
<a href="#l19.1159"></a><span id="l19.1159" class="difflineminus">-    // and MUST be base64 encoded</span>
<a href="#l19.1160"></a><span id="l19.1160" class="difflineminus">-    if ((aStr[i] == char16_t('\n')) || (aStr[i] == char16_t('\r')) ||</span>
<a href="#l19.1161"></a><span id="l19.1161" class="difflineminus">-        (!mozilla::IsAscii(aStr[i])))</span>
<a href="#l19.1162"></a><span id="l19.1162" class="difflineminus">-      return false;</span>
<a href="#l19.1163"></a><span id="l19.1163" class="difflineminus">-  }</span>
<a href="#l19.1164"></a><span id="l19.1164" class="difflineminus">-  return true;</span>
<a href="#l19.1165"></a><span id="l19.1165" class="difflineminus">-}</span>
<a href="#l19.1166"></a><span id="l19.1166" class="difflineminus">-</span>
<a href="#l19.1167"></a><span id="l19.1167" class="difflineminus">-nsresult nsAbManager::AppendProperty(const char *aProperty,</span>
<a href="#l19.1168"></a><span id="l19.1168" class="difflineminus">-                                     const char16_t *aValue,</span>
<a href="#l19.1169"></a><span id="l19.1169" class="difflineminus">-                                     nsACString &amp;aResult) {</span>
<a href="#l19.1170"></a><span id="l19.1170" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aValue);</span>
<a href="#l19.1171"></a><span id="l19.1171" class="difflineminus">-</span>
<a href="#l19.1172"></a><span id="l19.1172" class="difflineminus">-  aResult += aProperty;</span>
<a href="#l19.1173"></a><span id="l19.1173" class="difflineminus">-</span>
<a href="#l19.1174"></a><span id="l19.1174" class="difflineminus">-  // if the string is not safe &quot;as is&quot;, base64 encode it</span>
<a href="#l19.1175"></a><span id="l19.1175" class="difflineminus">-  if (IsSafeLDIFString(aValue)) {</span>
<a href="#l19.1176"></a><span id="l19.1176" class="difflineminus">-    aResult.AppendLiteral(&quot;: &quot;);</span>
<a href="#l19.1177"></a><span id="l19.1177" class="difflineminus">-    aResult.Append(NS_LossyConvertUTF16toASCII(aValue));</span>
<a href="#l19.1178"></a><span id="l19.1178" class="difflineminus">-  } else {</span>
<a href="#l19.1179"></a><span id="l19.1179" class="difflineminus">-    char *base64Str =</span>
<a href="#l19.1180"></a><span id="l19.1180" class="difflineminus">-        PL_Base64Encode(NS_ConvertUTF16toUTF8(aValue).get(), 0, nullptr);</span>
<a href="#l19.1181"></a><span id="l19.1181" class="difflineminus">-    if (!base64Str) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l19.1182"></a><span id="l19.1182" class="difflineminus">-</span>
<a href="#l19.1183"></a><span id="l19.1183" class="difflineminus">-    aResult.AppendLiteral(&quot;:: &quot;);</span>
<a href="#l19.1184"></a><span id="l19.1184" class="difflineminus">-    aResult.Append(nsDependentCString(base64Str));</span>
<a href="#l19.1185"></a><span id="l19.1185" class="difflineminus">-    PR_Free(base64Str);</span>
<a href="#l19.1186"></a><span id="l19.1186" class="difflineminus">-  }</span>
<a href="#l19.1187"></a><span id="l19.1187" class="difflineminus">-</span>
<a href="#l19.1188"></a><span id="l19.1188" class="difflineminus">-  return NS_OK;</span>
<a href="#l19.1189"></a><span id="l19.1189" class="difflineminus">-}</span>
<a href="#l19.1190"></a><span id="l19.1190" class="difflineminus">-</span>
<a href="#l19.1191"></a><span id="l19.1191" class="difflineminus">-char *getCString(VObject *vObj) {</span>
<a href="#l19.1192"></a><span id="l19.1192" class="difflineminus">-  if (VALUE_TYPE(vObj) == VCVT_USTRINGZ)</span>
<a href="#l19.1193"></a><span id="l19.1193" class="difflineminus">-    return fakeCString(vObjectUStringZValue(vObj));</span>
<a href="#l19.1194"></a><span id="l19.1194" class="difflineminus">-  if (VALUE_TYPE(vObj) == VCVT_STRINGZ)</span>
<a href="#l19.1195"></a><span id="l19.1195" class="difflineminus">-    return PL_strdup(vObjectStringZValue(vObj));</span>
<a href="#l19.1196"></a><span id="l19.1196" class="difflineminus">-  return NULL;</span>
<a href="#l19.1197"></a><span id="l19.1197" class="difflineminus">-}</span>
<a href="#l19.1198"></a><span id="l19.1198" class="difflineminus">-</span>
<a href="#l19.1199"></a><span id="l19.1199" class="difflineminus">-static void convertNameValue(VObject *vObj, nsIAbCard *aCard) {</span>
<a href="#l19.1200"></a><span id="l19.1200" class="difflineminus">-  const char *cardPropName = NULL;</span>
<a href="#l19.1201"></a><span id="l19.1201" class="difflineminus">-</span>
<a href="#l19.1202"></a><span id="l19.1202" class="difflineminus">-  // if the vCard property is not a root property then we need to determine its</span>
<a href="#l19.1203"></a><span id="l19.1203" class="difflineminus">-  // exact property. a good example of this is VCTelephoneProp, this prop has</span>
<a href="#l19.1204"></a><span id="l19.1204" class="difflineminus">-  // four objects underneath it: fax, work and home and cellular.</span>
<a href="#l19.1205"></a><span id="l19.1205" class="difflineminus">-  if (PL_strcasecmp(VCCityProp, vObjectName(vObj)) == 0)</span>
<a href="#l19.1206"></a><span id="l19.1206" class="difflineminus">-    cardPropName = kWorkCityProperty;</span>
<a href="#l19.1207"></a><span id="l19.1207" class="difflineminus">-  else if (PL_strcasecmp(VCTelephoneProp, vObjectName(vObj)) == 0) {</span>
<a href="#l19.1208"></a><span id="l19.1208" class="difflineminus">-    if (isAPropertyOf(vObj, VCFaxProp))</span>
<a href="#l19.1209"></a><span id="l19.1209" class="difflineminus">-      cardPropName = kFaxProperty;</span>
<a href="#l19.1210"></a><span id="l19.1210" class="difflineminus">-    else if (isAPropertyOf(vObj, VCWorkProp))</span>
<a href="#l19.1211"></a><span id="l19.1211" class="difflineminus">-      cardPropName = kWorkPhoneProperty;</span>
<a href="#l19.1212"></a><span id="l19.1212" class="difflineminus">-    else if (isAPropertyOf(vObj, VCHomeProp))</span>
<a href="#l19.1213"></a><span id="l19.1213" class="difflineminus">-      cardPropName = kHomePhoneProperty;</span>
<a href="#l19.1214"></a><span id="l19.1214" class="difflineminus">-    else if (isAPropertyOf(vObj, VCCellularProp))</span>
<a href="#l19.1215"></a><span id="l19.1215" class="difflineminus">-      cardPropName = kCellularProperty;</span>
<a href="#l19.1216"></a><span id="l19.1216" class="difflineminus">-    else if (isAPropertyOf(vObj, VCPagerProp))</span>
<a href="#l19.1217"></a><span id="l19.1217" class="difflineminus">-      cardPropName = kPagerProperty;</span>
<a href="#l19.1218"></a><span id="l19.1218" class="difflineminus">-    else</span>
<a href="#l19.1219"></a><span id="l19.1219" class="difflineminus">-      return;</span>
<a href="#l19.1220"></a><span id="l19.1220" class="difflineminus">-  } else if (PL_strcasecmp(VCEmailAddressProp, vObjectName(vObj)) == 0)</span>
<a href="#l19.1221"></a><span id="l19.1221" class="difflineminus">-    cardPropName = kPriEmailProperty;</span>
<a href="#l19.1222"></a><span id="l19.1222" class="difflineminus">-  else if (PL_strcasecmp(VCFamilyNameProp, vObjectName(vObj)) == 0)</span>
<a href="#l19.1223"></a><span id="l19.1223" class="difflineminus">-    cardPropName = kLastNameProperty;</span>
<a href="#l19.1224"></a><span id="l19.1224" class="difflineminus">-  else if (PL_strcasecmp(VCFullNameProp, vObjectName(vObj)) == 0)</span>
<a href="#l19.1225"></a><span id="l19.1225" class="difflineminus">-    cardPropName = kDisplayNameProperty;</span>
<a href="#l19.1226"></a><span id="l19.1226" class="difflineminus">-  else if (PL_strcasecmp(VCGivenNameProp, vObjectName(vObj)) == 0)</span>
<a href="#l19.1227"></a><span id="l19.1227" class="difflineminus">-    cardPropName = kFirstNameProperty;</span>
<a href="#l19.1228"></a><span id="l19.1228" class="difflineminus">-  else if (PL_strcasecmp(VCOrgNameProp, vObjectName(vObj)) == 0)</span>
<a href="#l19.1229"></a><span id="l19.1229" class="difflineminus">-    cardPropName = kCompanyProperty;</span>
<a href="#l19.1230"></a><span id="l19.1230" class="difflineminus">-  else if (PL_strcasecmp(VCOrgUnitProp, vObjectName(vObj)) == 0)</span>
<a href="#l19.1231"></a><span id="l19.1231" class="difflineminus">-    cardPropName = kDepartmentProperty;</span>
<a href="#l19.1232"></a><span id="l19.1232" class="difflineminus">-  else if (PL_strcasecmp(VCPostalCodeProp, vObjectName(vObj)) == 0)</span>
<a href="#l19.1233"></a><span id="l19.1233" class="difflineminus">-    cardPropName = kWorkZipCodeProperty;</span>
<a href="#l19.1234"></a><span id="l19.1234" class="difflineminus">-  else if (PL_strcasecmp(VCRegionProp, vObjectName(vObj)) == 0)</span>
<a href="#l19.1235"></a><span id="l19.1235" class="difflineminus">-    cardPropName = kWorkStateProperty;</span>
<a href="#l19.1236"></a><span id="l19.1236" class="difflineminus">-  else if (PL_strcasecmp(VCStreetAddressProp, vObjectName(vObj)) == 0)</span>
<a href="#l19.1237"></a><span id="l19.1237" class="difflineminus">-    cardPropName = kWorkAddressProperty;</span>
<a href="#l19.1238"></a><span id="l19.1238" class="difflineminus">-  else if (PL_strcasecmp(VCPostalBoxProp, vObjectName(vObj)) == 0)</span>
<a href="#l19.1239"></a><span id="l19.1239" class="difflineminus">-    cardPropName = kWorkAddress2Property;</span>
<a href="#l19.1240"></a><span id="l19.1240" class="difflineminus">-  else if (PL_strcasecmp(VCCountryNameProp, vObjectName(vObj)) == 0)</span>
<a href="#l19.1241"></a><span id="l19.1241" class="difflineminus">-    cardPropName = kWorkCountryProperty;</span>
<a href="#l19.1242"></a><span id="l19.1242" class="difflineminus">-  else if (PL_strcasecmp(VCTitleProp, vObjectName(vObj)) == 0)</span>
<a href="#l19.1243"></a><span id="l19.1243" class="difflineminus">-    cardPropName = kJobTitleProperty;</span>
<a href="#l19.1244"></a><span id="l19.1244" class="difflineminus">-  else if (PL_strcasecmp(VCUseHTML, vObjectName(vObj)) == 0)</span>
<a href="#l19.1245"></a><span id="l19.1245" class="difflineminus">-    cardPropName = kPreferMailFormatProperty;</span>
<a href="#l19.1246"></a><span id="l19.1246" class="difflineminus">-  else if (PL_strcasecmp(VCNoteProp, vObjectName(vObj)) == 0)</span>
<a href="#l19.1247"></a><span id="l19.1247" class="difflineminus">-    cardPropName = kNotesProperty;</span>
<a href="#l19.1248"></a><span id="l19.1248" class="difflineminus">-  else if (PL_strcasecmp(VCURLProp, vObjectName(vObj)) == 0)</span>
<a href="#l19.1249"></a><span id="l19.1249" class="difflineminus">-    cardPropName = kWorkWebPageProperty;</span>
<a href="#l19.1250"></a><span id="l19.1250" class="difflineminus">-  else</span>
<a href="#l19.1251"></a><span id="l19.1251" class="difflineminus">-    return;</span>
<a href="#l19.1252"></a><span id="l19.1252" class="difflineminus">-</span>
<a href="#l19.1253"></a><span id="l19.1253" class="difflineminus">-  if (!VALUE_TYPE(vObj)) return;</span>
<a href="#l19.1254"></a><span id="l19.1254" class="difflineminus">-</span>
<a href="#l19.1255"></a><span id="l19.1255" class="difflineminus">-  char *cardPropValue = getCString(vObj);</span>
<a href="#l19.1256"></a><span id="l19.1256" class="difflineminus">-  if (PL_strcmp(cardPropName, kPreferMailFormatProperty)) {</span>
<a href="#l19.1257"></a><span id="l19.1257" class="difflineminus">-    aCard-&gt;SetPropertyAsAUTF8String(cardPropName,</span>
<a href="#l19.1258"></a><span id="l19.1258" class="difflineminus">-                                    nsDependentCString(cardPropValue));</span>
<a href="#l19.1259"></a><span id="l19.1259" class="difflineminus">-  } else {</span>
<a href="#l19.1260"></a><span id="l19.1260" class="difflineminus">-    if (!PL_strcmp(cardPropValue, &quot;TRUE&quot;))</span>
<a href="#l19.1261"></a><span id="l19.1261" class="difflineminus">-      aCard-&gt;SetPropertyAsUint32(cardPropName, nsIAbPreferMailFormat::html);</span>
<a href="#l19.1262"></a><span id="l19.1262" class="difflineminus">-    else if (!PL_strcmp(cardPropValue, &quot;FALSE&quot;))</span>
<a href="#l19.1263"></a><span id="l19.1263" class="difflineminus">-      aCard-&gt;SetPropertyAsUint32(cardPropName,</span>
<a href="#l19.1264"></a><span id="l19.1264" class="difflineminus">-                                 nsIAbPreferMailFormat::plaintext);</span>
<a href="#l19.1265"></a><span id="l19.1265" class="difflineminus">-    else</span>
<a href="#l19.1266"></a><span id="l19.1266" class="difflineminus">-      aCard-&gt;SetPropertyAsUint32(cardPropName, nsIAbPreferMailFormat::unknown);</span>
<a href="#l19.1267"></a><span id="l19.1267" class="difflineminus">-  }</span>
<a href="#l19.1268"></a><span id="l19.1268" class="difflineminus">-  PR_FREEIF(cardPropValue);</span>
<a href="#l19.1269"></a><span id="l19.1269" class="difflineminus">-  return;</span>
<a href="#l19.1270"></a><span id="l19.1270" class="difflineminus">-}</span>
<a href="#l19.1271"></a><span id="l19.1271" class="difflineminus">-</span>
<a href="#l19.1272"></a><span id="l19.1272" class="difflineminus">-static void convertFromVObject(VObject *vObj, nsIAbCard *aCard) {</span>
<a href="#l19.1273"></a><span id="l19.1273" class="difflineminus">-  if (vObj) {</span>
<a href="#l19.1274"></a><span id="l19.1274" class="difflineminus">-    VObjectIterator t;</span>
<a href="#l19.1275"></a><span id="l19.1275" class="difflineminus">-</span>
<a href="#l19.1276"></a><span id="l19.1276" class="difflineminus">-    convertNameValue(vObj, aCard);</span>
<a href="#l19.1277"></a><span id="l19.1277" class="difflineminus">-</span>
<a href="#l19.1278"></a><span id="l19.1278" class="difflineminus">-    initPropIterator(&amp;t, vObj);</span>
<a href="#l19.1279"></a><span id="l19.1279" class="difflineminus">-    while (moreIteration(&amp;t)) {</span>
<a href="#l19.1280"></a><span id="l19.1280" class="difflineminus">-      VObject *nextObject = nextVObject(&amp;t);</span>
<a href="#l19.1281"></a><span id="l19.1281" class="difflineminus">-      convertFromVObject(nextObject, aCard);</span>
<a href="#l19.1282"></a><span id="l19.1282" class="difflineminus">-    }</span>
<a href="#l19.1283"></a><span id="l19.1283" class="difflineminus">-  }</span>
<a href="#l19.1284"></a><span id="l19.1284" class="difflineminus">-  return;</span>
<a href="#l19.1285"></a><span id="l19.1285" class="difflineminus">-}</span>
<a href="#l19.1286"></a><span id="l19.1286" class="difflineminus">-</span>
<a href="#l19.1287"></a><span id="l19.1287" class="difflineminus">-NS_IMETHODIMP nsAbManager::EscapedVCardToAbCard(const char *aEscapedVCardStr,</span>
<a href="#l19.1288"></a><span id="l19.1288" class="difflineminus">-                                                nsIAbCard **aCard) {</span>
<a href="#l19.1289"></a><span id="l19.1289" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aEscapedVCardStr);</span>
<a href="#l19.1290"></a><span id="l19.1290" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aCard);</span>
<a href="#l19.1291"></a><span id="l19.1291" class="difflineminus">-</span>
<a href="#l19.1292"></a><span id="l19.1292" class="difflineminus">-  nsCOMPtr&lt;nsIAbCard&gt; cardFromVCard =</span>
<a href="#l19.1293"></a><span id="l19.1293" class="difflineminus">-      do_CreateInstance(NS_ABCARDPROPERTY_CONTRACTID);</span>
<a href="#l19.1294"></a><span id="l19.1294" class="difflineminus">-  if (!cardFromVCard) return NS_ERROR_FAILURE;</span>
<a href="#l19.1295"></a><span id="l19.1295" class="difflineminus">-</span>
<a href="#l19.1296"></a><span id="l19.1296" class="difflineminus">-  // aEscapedVCardStr will be &quot;&quot; the first time, before you have a vCard</span>
<a href="#l19.1297"></a><span id="l19.1297" class="difflineminus">-  if (*aEscapedVCardStr != '\0') {</span>
<a href="#l19.1298"></a><span id="l19.1298" class="difflineminus">-    nsCString unescapedData;</span>
<a href="#l19.1299"></a><span id="l19.1299" class="difflineminus">-    MsgUnescapeString(nsDependentCString(aEscapedVCardStr), 0, unescapedData);</span>
<a href="#l19.1300"></a><span id="l19.1300" class="difflineminus">-</span>
<a href="#l19.1301"></a><span id="l19.1301" class="difflineminus">-    VObject *vObj = parse_MIME(unescapedData.get(), unescapedData.Length());</span>
<a href="#l19.1302"></a><span id="l19.1302" class="difflineminus">-    if (vObj) {</span>
<a href="#l19.1303"></a><span id="l19.1303" class="difflineminus">-      convertFromVObject(vObj, cardFromVCard);</span>
<a href="#l19.1304"></a><span id="l19.1304" class="difflineminus">-</span>
<a href="#l19.1305"></a><span id="l19.1305" class="difflineminus">-      cleanVObject(vObj);</span>
<a href="#l19.1306"></a><span id="l19.1306" class="difflineminus">-    } else</span>
<a href="#l19.1307"></a><span id="l19.1307" class="difflineminus">-      NS_WARNING(&quot;Parse of vCard failed&quot;);</span>
<a href="#l19.1308"></a><span id="l19.1308" class="difflineminus">-  }</span>
<a href="#l19.1309"></a><span id="l19.1309" class="difflineminus">-</span>
<a href="#l19.1310"></a><span id="l19.1310" class="difflineminus">-  cardFromVCard.forget(aCard);</span>
<a href="#l19.1311"></a><span id="l19.1311" class="difflineminus">-  return NS_OK;</span>
<a href="#l19.1312"></a><span id="l19.1312" class="difflineminus">-}</span>
<a href="#l19.1313"></a><span id="l19.1313" class="difflineminus">-</span>
<a href="#l19.1314"></a><span id="l19.1314" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l19.1315"></a><span id="l19.1315" class="difflineminus">-nsAbManager::Handle(nsICommandLine *aCmdLine) {</span>
<a href="#l19.1316"></a><span id="l19.1316" class="difflineminus">-  nsresult rv;</span>
<a href="#l19.1317"></a><span id="l19.1317" class="difflineminus">-  bool found;</span>
<a href="#l19.1318"></a><span id="l19.1318" class="difflineminus">-</span>
<a href="#l19.1319"></a><span id="l19.1319" class="difflineminus">-  rv = aCmdLine-&gt;HandleFlag(NS_LITERAL_STRING(&quot;addressbook&quot;), false, &amp;found);</span>
<a href="#l19.1320"></a><span id="l19.1320" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.1321"></a><span id="l19.1321" class="difflineminus">-</span>
<a href="#l19.1322"></a><span id="l19.1322" class="difflineminus">-  if (!found) return NS_OK;</span>
<a href="#l19.1323"></a><span id="l19.1323" class="difflineminus">-</span>
<a href="#l19.1324"></a><span id="l19.1324" class="difflineminus">-  nsCOMPtr&lt;nsIWindowWatcher&gt; wwatch(do_GetService(NS_WINDOWWATCHER_CONTRACTID));</span>
<a href="#l19.1325"></a><span id="l19.1325" class="difflineminus">-  NS_ENSURE_TRUE(wwatch, NS_ERROR_FAILURE);</span>
<a href="#l19.1326"></a><span id="l19.1326" class="difflineminus">-</span>
<a href="#l19.1327"></a><span id="l19.1327" class="difflineminus">-  nsCOMPtr&lt;mozIDOMWindowProxy&gt; opened;</span>
<a href="#l19.1328"></a><span id="l19.1328" class="difflineminus">-  wwatch-&gt;OpenWindow(</span>
<a href="#l19.1329"></a><span id="l19.1329" class="difflineminus">-      nullptr, &quot;chrome://messenger/content/addressbook/addressbook.xhtml&quot;,</span>
<a href="#l19.1330"></a><span id="l19.1330" class="difflineminus">-      &quot;_blank&quot;,</span>
<a href="#l19.1331"></a><span id="l19.1331" class="difflineminus">-      &quot;chrome,extrachrome,menubar,resizable,scrollbars,status,toolbar&quot;, nullptr,</span>
<a href="#l19.1332"></a><span id="l19.1332" class="difflineminus">-      getter_AddRefs(opened));</span>
<a href="#l19.1333"></a><span id="l19.1333" class="difflineminus">-  aCmdLine-&gt;SetPreventDefault(true);</span>
<a href="#l19.1334"></a><span id="l19.1334" class="difflineminus">-  return NS_OK;</span>
<a href="#l19.1335"></a><span id="l19.1335" class="difflineminus">-}</span>
<a href="#l19.1336"></a><span id="l19.1336" class="difflineminus">-</span>
<a href="#l19.1337"></a><span id="l19.1337" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l19.1338"></a><span id="l19.1338" class="difflineminus">-nsAbManager::GetHelpInfo(nsACString &amp;aResult) {</span>
<a href="#l19.1339"></a><span id="l19.1339" class="difflineminus">-  aResult.AssignLiteral(</span>
<a href="#l19.1340"></a><span id="l19.1340" class="difflineminus">-      &quot;  -addressbook       Open the address book at startup.\n&quot;);</span>
<a href="#l19.1341"></a><span id="l19.1341" class="difflineminus">-  return NS_OK;</span>
<a href="#l19.1342"></a><span id="l19.1342" class="difflineminus">-}</span>
<a href="#l19.1343"></a><span id="l19.1343" class="difflineminus">-</span>
<a href="#l19.1344"></a><span id="l19.1344" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l19.1345"></a><span id="l19.1345" class="difflineminus">-nsAbManager::GenerateUUID(const nsACString &amp;aDirectoryId,</span>
<a href="#l19.1346"></a><span id="l19.1346" class="difflineminus">-                          const nsACString &amp;aLocalId, nsACString &amp;uuid) {</span>
<a href="#l19.1347"></a><span id="l19.1347" class="difflineminus">-  uuid.Assign(aDirectoryId);</span>
<a href="#l19.1348"></a><span id="l19.1348" class="difflineminus">-  uuid.Append('#');</span>
<a href="#l19.1349"></a><span id="l19.1349" class="difflineminus">-  uuid.Append(aLocalId);</span>
<a href="#l19.1350"></a><span id="l19.1350" class="difflineminus">-  return NS_OK;</span>
<a href="#l19.1351"></a><span id="l19.1351" class="difflineminus">-}</span>
<a href="#l19.1352"></a><span id="l19.1352" class="difflineminus">-</span>
<a href="#l19.1353"></a><span id="l19.1353" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l19.1354"></a><span id="l19.1354" class="difflineminus">-nsAbManager::ConvertQueryStringToExpression(const nsACString &amp;aQueryString,</span>
<a href="#l19.1355"></a><span id="l19.1355" class="difflineminus">-                                            nsIAbBooleanExpression **_retval) {</span>
<a href="#l19.1356"></a><span id="l19.1356" class="difflineminus">-  NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l19.1357"></a><span id="l19.1357" class="difflineminus">-  return nsAbQueryStringToExpression::Convert(aQueryString, _retval);</span>
<a href="#l19.1358"></a><span id="l19.1358" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1">deleted file mode 100644</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineminus">--- a/mailnews/addrbook/src/nsAbManager.h</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineplus">+++ /dev/null</span>
<a href="#l20.4"></a><span id="l20.4" class="difflineat">@@ -1,97 +0,0 @@</span>
<a href="#l20.5"></a><span id="l20.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l20.6"></a><span id="l20.6" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l20.7"></a><span id="l20.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l20.8"></a><span id="l20.8" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l20.9"></a><span id="l20.9" class="difflineminus">-</span>
<a href="#l20.10"></a><span id="l20.10" class="difflineminus">-#ifndef __nsAbManager_h</span>
<a href="#l20.11"></a><span id="l20.11" class="difflineminus">-#define __nsAbManager_h</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineminus">-</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineminus">-#include &quot;nsIAbManager.h&quot;</span>
<a href="#l20.14"></a><span id="l20.14" class="difflineminus">-#include &quot;nsTObserverArray.h&quot;</span>
<a href="#l20.15"></a><span id="l20.15" class="difflineminus">-#include &quot;nsCOMPtr.h&quot;</span>
<a href="#l20.16"></a><span id="l20.16" class="difflineminus">-#include &quot;nsICommandLineHandler.h&quot;</span>
<a href="#l20.17"></a><span id="l20.17" class="difflineminus">-#include &quot;nsIObserver.h&quot;</span>
<a href="#l20.18"></a><span id="l20.18" class="difflineminus">-#include &quot;nsInterfaceHashtable.h&quot;</span>
<a href="#l20.19"></a><span id="l20.19" class="difflineminus">-#include &quot;nsIAbDirectory.h&quot;</span>
<a href="#l20.20"></a><span id="l20.20" class="difflineminus">-#include &quot;nsIFilePicker.h&quot;</span>
<a href="#l20.21"></a><span id="l20.21" class="difflineminus">-</span>
<a href="#l20.22"></a><span id="l20.22" class="difflineminus">-class nsIAbLDAPAttributeMap;</span>
<a href="#l20.23"></a><span id="l20.23" class="difflineminus">-</span>
<a href="#l20.24"></a><span id="l20.24" class="difflineminus">-class nsAbManager : public nsIAbManager,</span>
<a href="#l20.25"></a><span id="l20.25" class="difflineminus">-                    public nsICommandLineHandler,</span>
<a href="#l20.26"></a><span id="l20.26" class="difflineminus">-                    public nsIObserver {</span>
<a href="#l20.27"></a><span id="l20.27" class="difflineminus">- public:</span>
<a href="#l20.28"></a><span id="l20.28" class="difflineminus">-  nsAbManager();</span>
<a href="#l20.29"></a><span id="l20.29" class="difflineminus">-</span>
<a href="#l20.30"></a><span id="l20.30" class="difflineminus">-  NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l20.31"></a><span id="l20.31" class="difflineminus">-  NS_DECL_NSIABMANAGER</span>
<a href="#l20.32"></a><span id="l20.32" class="difflineminus">-  NS_DECL_NSIOBSERVER</span>
<a href="#l20.33"></a><span id="l20.33" class="difflineminus">-  NS_DECL_NSICOMMANDLINEHANDLER</span>
<a href="#l20.34"></a><span id="l20.34" class="difflineminus">-</span>
<a href="#l20.35"></a><span id="l20.35" class="difflineminus">-  nsresult Init();</span>
<a href="#l20.36"></a><span id="l20.36" class="difflineminus">-</span>
<a href="#l20.37"></a><span id="l20.37" class="difflineminus">- private:</span>
<a href="#l20.38"></a><span id="l20.38" class="difflineminus">-  virtual ~nsAbManager();</span>
<a href="#l20.39"></a><span id="l20.39" class="difflineminus">-  nsresult GetRootDirectory(nsIAbDirectory **aResult);</span>
<a href="#l20.40"></a><span id="l20.40" class="difflineminus">-  nsresult ExportDirectoryToDelimitedText(nsIAbDirectory *aDirectory,</span>
<a href="#l20.41"></a><span id="l20.41" class="difflineminus">-                                          const char *aDelim,</span>
<a href="#l20.42"></a><span id="l20.42" class="difflineminus">-                                          uint32_t aDelimLen,</span>
<a href="#l20.43"></a><span id="l20.43" class="difflineminus">-                                          nsIFile *aLocalFile, bool useUTF8);</span>
<a href="#l20.44"></a><span id="l20.44" class="difflineminus">-  nsresult ExportDirectoryToVCard(nsIAbDirectory *aDirectory,</span>
<a href="#l20.45"></a><span id="l20.45" class="difflineminus">-                                  nsIFile *aLocalFile);</span>
<a href="#l20.46"></a><span id="l20.46" class="difflineminus">-  nsresult ExportDirectoryToLDIF(nsIAbDirectory *aDirectory,</span>
<a href="#l20.47"></a><span id="l20.47" class="difflineminus">-                                 nsIFile *aLocalFile);</span>
<a href="#l20.48"></a><span id="l20.48" class="difflineminus">-  nsresult AppendLDIFForMailList(nsIAbCard *aCard,</span>
<a href="#l20.49"></a><span id="l20.49" class="difflineminus">-                                 nsIAbLDAPAttributeMap *aAttrMap,</span>
<a href="#l20.50"></a><span id="l20.50" class="difflineminus">-                                 nsACString &amp;aResult);</span>
<a href="#l20.51"></a><span id="l20.51" class="difflineminus">-  nsresult AppendDNForCard(const char *aProperty, nsIAbCard *aCard,</span>
<a href="#l20.52"></a><span id="l20.52" class="difflineminus">-                           nsIAbLDAPAttributeMap *aAttrMap,</span>
<a href="#l20.53"></a><span id="l20.53" class="difflineminus">-                           nsACString &amp;aResult);</span>
<a href="#l20.54"></a><span id="l20.54" class="difflineminus">-  nsresult AppendBasicLDIFForCard(nsIAbCard *aCard,</span>
<a href="#l20.55"></a><span id="l20.55" class="difflineminus">-                                  nsIAbLDAPAttributeMap *aAttrMap,</span>
<a href="#l20.56"></a><span id="l20.56" class="difflineminus">-                                  nsACString &amp;aResult);</span>
<a href="#l20.57"></a><span id="l20.57" class="difflineminus">-  nsresult AppendProperty(const char *aProperty, const char16_t *aValue,</span>
<a href="#l20.58"></a><span id="l20.58" class="difflineminus">-                          nsACString &amp;aResult);</span>
<a href="#l20.59"></a><span id="l20.59" class="difflineminus">-  bool IsSafeLDIFString(const char16_t *aStr);</span>
<a href="#l20.60"></a><span id="l20.60" class="difflineminus">-</span>
<a href="#l20.61"></a><span id="l20.61" class="difflineminus">-  struct abListener {</span>
<a href="#l20.62"></a><span id="l20.62" class="difflineminus">-    nsCOMPtr&lt;nsIAbListener&gt; mListener;</span>
<a href="#l20.63"></a><span id="l20.63" class="difflineminus">-    uint32_t mNotifyFlags;</span>
<a href="#l20.64"></a><span id="l20.64" class="difflineminus">-</span>
<a href="#l20.65"></a><span id="l20.65" class="difflineminus">-    abListener(nsIAbListener *aListener, uint32_t aNotifyFlags)</span>
<a href="#l20.66"></a><span id="l20.66" class="difflineminus">-        : mListener(aListener), mNotifyFlags(aNotifyFlags) {}</span>
<a href="#l20.67"></a><span id="l20.67" class="difflineminus">-    abListener(const abListener &amp;aListener)</span>
<a href="#l20.68"></a><span id="l20.68" class="difflineminus">-        : mListener(aListener.mListener),</span>
<a href="#l20.69"></a><span id="l20.69" class="difflineminus">-          mNotifyFlags(aListener.mNotifyFlags) {}</span>
<a href="#l20.70"></a><span id="l20.70" class="difflineminus">-    ~abListener() {}</span>
<a href="#l20.71"></a><span id="l20.71" class="difflineminus">-</span>
<a href="#l20.72"></a><span id="l20.72" class="difflineminus">-    int operator==(nsIAbListener *aListener) const {</span>
<a href="#l20.73"></a><span id="l20.73" class="difflineminus">-      return mListener == aListener;</span>
<a href="#l20.74"></a><span id="l20.74" class="difflineminus">-    }</span>
<a href="#l20.75"></a><span id="l20.75" class="difflineminus">-    int operator==(const abListener &amp;aListener) const {</span>
<a href="#l20.76"></a><span id="l20.76" class="difflineminus">-      return mListener == aListener.mListener;</span>
<a href="#l20.77"></a><span id="l20.77" class="difflineminus">-    }</span>
<a href="#l20.78"></a><span id="l20.78" class="difflineminus">-  };</span>
<a href="#l20.79"></a><span id="l20.79" class="difflineminus">-</span>
<a href="#l20.80"></a><span id="l20.80" class="difflineminus">-  class nsFilePickerShownCallback : public nsIFilePickerShownCallback {</span>
<a href="#l20.81"></a><span id="l20.81" class="difflineminus">-    virtual ~nsFilePickerShownCallback() {}</span>
<a href="#l20.82"></a><span id="l20.82" class="difflineminus">-</span>
<a href="#l20.83"></a><span id="l20.83" class="difflineminus">-   public:</span>
<a href="#l20.84"></a><span id="l20.84" class="difflineminus">-    nsFilePickerShownCallback(nsAbManager *aInput, nsIFilePicker *aFilePicker,</span>
<a href="#l20.85"></a><span id="l20.85" class="difflineminus">-                              nsIAbDirectory *aDirectory);</span>
<a href="#l20.86"></a><span id="l20.86" class="difflineminus">-    NS_DECL_ISUPPORTS</span>
<a href="#l20.87"></a><span id="l20.87" class="difflineminus">-</span>
<a href="#l20.88"></a><span id="l20.88" class="difflineminus">-    NS_IMETHOD Done(int16_t aResult) override;</span>
<a href="#l20.89"></a><span id="l20.89" class="difflineminus">-</span>
<a href="#l20.90"></a><span id="l20.90" class="difflineminus">-   private:</span>
<a href="#l20.91"></a><span id="l20.91" class="difflineminus">-    nsCOMPtr&lt;nsIFilePicker&gt; mFilePicker;</span>
<a href="#l20.92"></a><span id="l20.92" class="difflineminus">-    RefPtr&lt;nsAbManager&gt; mAbManager;</span>
<a href="#l20.93"></a><span id="l20.93" class="difflineminus">-    RefPtr&lt;nsIAbDirectory&gt; mDirectory;</span>
<a href="#l20.94"></a><span id="l20.94" class="difflineminus">-  };</span>
<a href="#l20.95"></a><span id="l20.95" class="difflineminus">-</span>
<a href="#l20.96"></a><span id="l20.96" class="difflineminus">-  nsTObserverArray&lt;abListener&gt; mListeners;</span>
<a href="#l20.97"></a><span id="l20.97" class="difflineminus">-  nsCOMPtr&lt;nsIAbDirectory&gt; mCacheTopLevelAb;</span>
<a href="#l20.98"></a><span id="l20.98" class="difflineminus">-  nsInterfaceHashtable&lt;nsCStringHashKey, nsIAbDirectory&gt; mAbStore;</span>
<a href="#l20.99"></a><span id="l20.99" class="difflineminus">-};</span>
<a href="#l20.100"></a><span id="l20.100" class="difflineminus">-</span>
<a href="#l20.101"></a><span id="l20.101" class="difflineminus">-#endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1">deleted file mode 100644</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineminus">--- a/mailnews/addrbook/src/nsAbOSXDirFactory.cpp</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineplus">+++ /dev/null</span>
<a href="#l21.4"></a><span id="l21.4" class="difflineat">@@ -1,47 +0,0 @@</span>
<a href="#l21.5"></a><span id="l21.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l21.6"></a><span id="l21.6" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l21.7"></a><span id="l21.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l21.8"></a><span id="l21.8" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l21.9"></a><span id="l21.9" class="difflineminus">-</span>
<a href="#l21.10"></a><span id="l21.10" class="difflineminus">-#include &quot;nsAbOSXDirFactory.h&quot;</span>
<a href="#l21.11"></a><span id="l21.11" class="difflineminus">-#include &quot;nsAbBaseCID.h&quot;</span>
<a href="#l21.12"></a><span id="l21.12" class="difflineminus">-#include &quot;nsEnumeratorUtils.h&quot;</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineminus">-#include &quot;nsIAbDirectory.h&quot;</span>
<a href="#l21.14"></a><span id="l21.14" class="difflineminus">-#include &quot;nsIAbManager.h&quot;</span>
<a href="#l21.15"></a><span id="l21.15" class="difflineminus">-#include &quot;nsString.h&quot;</span>
<a href="#l21.16"></a><span id="l21.16" class="difflineminus">-#include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l21.17"></a><span id="l21.17" class="difflineminus">-#include &quot;nsAbOSXDirectory.h&quot;</span>
<a href="#l21.18"></a><span id="l21.18" class="difflineminus">-</span>
<a href="#l21.19"></a><span id="l21.19" class="difflineminus">-NS_IMPL_ISUPPORTS(nsAbOSXDirFactory, nsIAbDirFactory)</span>
<a href="#l21.20"></a><span id="l21.20" class="difflineminus">-</span>
<a href="#l21.21"></a><span id="l21.21" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l21.22"></a><span id="l21.22" class="difflineminus">-nsAbOSXDirFactory::GetDirectories(const nsAString &amp;aDirName,</span>
<a href="#l21.23"></a><span id="l21.23" class="difflineminus">-                                  const nsACString &amp;aURI,</span>
<a href="#l21.24"></a><span id="l21.24" class="difflineminus">-                                  const nsACString &amp;aPrefName,</span>
<a href="#l21.25"></a><span id="l21.25" class="difflineminus">-                                  nsISimpleEnumerator **aDirectories) {</span>
<a href="#l21.26"></a><span id="l21.26" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aDirectories);</span>
<a href="#l21.27"></a><span id="l21.27" class="difflineminus">-</span>
<a href="#l21.28"></a><span id="l21.28" class="difflineminus">-  *aDirectories = nullptr;</span>
<a href="#l21.29"></a><span id="l21.29" class="difflineminus">-</span>
<a href="#l21.30"></a><span id="l21.30" class="difflineminus">-  nsresult rv;</span>
<a href="#l21.31"></a><span id="l21.31" class="difflineminus">-  nsCOMPtr&lt;nsIAbManager&gt; abManager(do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv));</span>
<a href="#l21.32"></a><span id="l21.32" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l21.33"></a><span id="l21.33" class="difflineminus">-</span>
<a href="#l21.34"></a><span id="l21.34" class="difflineminus">-  nsCOMPtr&lt;nsIAbDirectory&gt; directory;</span>
<a href="#l21.35"></a><span id="l21.35" class="difflineminus">-  rv = abManager-&gt;GetDirectory(</span>
<a href="#l21.36"></a><span id="l21.36" class="difflineminus">-      NS_LITERAL_CSTRING(NS_ABOSXDIRECTORY_URI_PREFIX &quot;/&quot;),</span>
<a href="#l21.37"></a><span id="l21.37" class="difflineminus">-      getter_AddRefs(directory));</span>
<a href="#l21.38"></a><span id="l21.38" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l21.39"></a><span id="l21.39" class="difflineminus">-</span>
<a href="#l21.40"></a><span id="l21.40" class="difflineminus">-  nsCOMPtr&lt;nsIAbOSXDirectory&gt; osxDirectory(do_QueryInterface(directory, &amp;rv));</span>
<a href="#l21.41"></a><span id="l21.41" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l21.42"></a><span id="l21.42" class="difflineminus">-</span>
<a href="#l21.43"></a><span id="l21.43" class="difflineminus">-  rv = osxDirectory-&gt;AssertChildNodes();</span>
<a href="#l21.44"></a><span id="l21.44" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l21.45"></a><span id="l21.45" class="difflineminus">-</span>
<a href="#l21.46"></a><span id="l21.46" class="difflineminus">-  return NS_NewSingletonEnumerator(aDirectories, osxDirectory);</span>
<a href="#l21.47"></a><span id="l21.47" class="difflineminus">-}</span>
<a href="#l21.48"></a><span id="l21.48" class="difflineminus">-</span>
<a href="#l21.49"></a><span id="l21.49" class="difflineminus">-// No actual deletion, since you cannot create the address books from Mozilla.</span>
<a href="#l21.50"></a><span id="l21.50" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l21.51"></a><span id="l21.51" class="difflineminus">-nsAbOSXDirFactory::DeleteDirectory(nsIAbDirectory *aDirectory) { return NS_OK; }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1">deleted file mode 100644</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineminus">--- a/mailnews/addrbook/src/nsAbOSXDirFactory.h</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineplus">+++ /dev/null</span>
<a href="#l22.4"></a><span id="l22.4" class="difflineat">@@ -1,20 +0,0 @@</span>
<a href="#l22.5"></a><span id="l22.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l22.6"></a><span id="l22.6" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l22.7"></a><span id="l22.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l22.8"></a><span id="l22.8" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l22.9"></a><span id="l22.9" class="difflineminus">-</span>
<a href="#l22.10"></a><span id="l22.10" class="difflineminus">-#ifndef nsAbOSXDirFactory_h___</span>
<a href="#l22.11"></a><span id="l22.11" class="difflineminus">-#define nsAbOSXDirFactory_h___</span>
<a href="#l22.12"></a><span id="l22.12" class="difflineminus">-</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineminus">-#include &quot;nsIAbDirFactory.h&quot;</span>
<a href="#l22.14"></a><span id="l22.14" class="difflineminus">-</span>
<a href="#l22.15"></a><span id="l22.15" class="difflineminus">-class nsAbOSXDirFactory final : public nsIAbDirFactory {</span>
<a href="#l22.16"></a><span id="l22.16" class="difflineminus">- public:</span>
<a href="#l22.17"></a><span id="l22.17" class="difflineminus">-  NS_DECL_ISUPPORTS</span>
<a href="#l22.18"></a><span id="l22.18" class="difflineminus">-  NS_DECL_NSIABDIRFACTORY</span>
<a href="#l22.19"></a><span id="l22.19" class="difflineminus">-</span>
<a href="#l22.20"></a><span id="l22.20" class="difflineminus">- private:</span>
<a href="#l22.21"></a><span id="l22.21" class="difflineminus">-  ~nsAbOSXDirFactory() {}</span>
<a href="#l22.22"></a><span id="l22.22" class="difflineminus">-};</span>
<a href="#l22.23"></a><span id="l22.23" class="difflineminus">-</span>
<a href="#l22.24"></a><span id="l22.24" class="difflineminus">-#endif  // nsAbOSXDirFactory_h___</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1">deleted file mode 100644</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineminus">--- a/mailnews/addrbook/src/nsDirPrefs.cpp</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineplus">+++ /dev/null</span>
<a href="#l23.4"></a><span id="l23.4" class="difflineat">@@ -1,1334 +0,0 @@</span>
<a href="#l23.5"></a><span id="l23.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l23.6"></a><span id="l23.6" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l23.7"></a><span id="l23.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l23.8"></a><span id="l23.8" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l23.9"></a><span id="l23.9" class="difflineminus">-</span>
<a href="#l23.10"></a><span id="l23.10" class="difflineminus">-/* directory server preferences (used to be dirprefs.c in 4.x) */</span>
<a href="#l23.11"></a><span id="l23.11" class="difflineminus">-</span>
<a href="#l23.12"></a><span id="l23.12" class="difflineminus">-#include &quot;nsIPrefService.h&quot;</span>
<a href="#l23.13"></a><span id="l23.13" class="difflineminus">-#include &quot;nsIPrefBranch.h&quot;</span>
<a href="#l23.14"></a><span id="l23.14" class="difflineminus">-#include &quot;nsDirPrefs.h&quot;</span>
<a href="#l23.15"></a><span id="l23.15" class="difflineminus">-#include &quot;nsIPrefLocalizedString.h&quot;</span>
<a href="#l23.16"></a><span id="l23.16" class="difflineminus">-#include &quot;nsIObserver.h&quot;</span>
<a href="#l23.17"></a><span id="l23.17" class="difflineminus">-#include &quot;nsTArray.h&quot;</span>
<a href="#l23.18"></a><span id="l23.18" class="difflineminus">-#include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l23.19"></a><span id="l23.19" class="difflineminus">-#include &quot;nsMemory.h&quot;</span>
<a href="#l23.20"></a><span id="l23.20" class="difflineminus">-#include &quot;nsIAddrDatabase.h&quot;</span>
<a href="#l23.21"></a><span id="l23.21" class="difflineminus">-#include &quot;nsAbBaseCID.h&quot;</span>
<a href="#l23.22"></a><span id="l23.22" class="difflineminus">-#include &quot;nsIAbManager.h&quot;</span>
<a href="#l23.23"></a><span id="l23.23" class="difflineminus">-#include &quot;nsIFile.h&quot;</span>
<a href="#l23.24"></a><span id="l23.24" class="difflineminus">-#include &quot;nsWeakReference.h&quot;</span>
<a href="#l23.25"></a><span id="l23.25" class="difflineminus">-#if defined(MOZ_LDAP_XPCOM)</span>
<a href="#l23.26"></a><span id="l23.26" class="difflineminus">-#  include &quot;nsIAbLDAPDirectory.h&quot;</span>
<a href="#l23.27"></a><span id="l23.27" class="difflineminus">-#endif</span>
<a href="#l23.28"></a><span id="l23.28" class="difflineminus">-#include &quot;prmem.h&quot;</span>
<a href="#l23.29"></a><span id="l23.29" class="difflineminus">-#include &quot;prprf.h&quot;</span>
<a href="#l23.30"></a><span id="l23.30" class="difflineminus">-#include &quot;plstr.h&quot;</span>
<a href="#l23.31"></a><span id="l23.31" class="difflineminus">-#include &quot;nsQuickSort.h&quot;</span>
<a href="#l23.32"></a><span id="l23.32" class="difflineminus">-#include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l23.33"></a><span id="l23.33" class="difflineminus">-#include &quot;msgCore.h&quot;</span>
<a href="#l23.34"></a><span id="l23.34" class="difflineminus">-#include &quot;nsString.h&quot;</span>
<a href="#l23.35"></a><span id="l23.35" class="difflineminus">-#include &quot;nsAppDirectoryServiceDefs.h&quot;</span>
<a href="#l23.36"></a><span id="l23.36" class="difflineminus">-</span>
<a href="#l23.37"></a><span id="l23.37" class="difflineminus">-#include &lt;ctype.h&gt;</span>
<a href="#l23.38"></a><span id="l23.38" class="difflineminus">-</span>
<a href="#l23.39"></a><span id="l23.39" class="difflineminus">-/*****************************************************************************</span>
<a href="#l23.40"></a><span id="l23.40" class="difflineminus">- * Private definitions</span>
<a href="#l23.41"></a><span id="l23.41" class="difflineminus">- */</span>
<a href="#l23.42"></a><span id="l23.42" class="difflineminus">-</span>
<a href="#l23.43"></a><span id="l23.43" class="difflineminus">-/* Default settings for site-configurable prefs */</span>
<a href="#l23.44"></a><span id="l23.44" class="difflineminus">-#define kDefaultPosition 1</span>
<a href="#l23.45"></a><span id="l23.45" class="difflineminus">-static bool dir_IsServerDeleted(DIR_Server *server);</span>
<a href="#l23.46"></a><span id="l23.46" class="difflineminus">-</span>
<a href="#l23.47"></a><span id="l23.47" class="difflineminus">-static char *DIR_GetStringPref(const char *prefRoot, const char *prefLeaf,</span>
<a href="#l23.48"></a><span id="l23.48" class="difflineminus">-                               const char *defaultValue);</span>
<a href="#l23.49"></a><span id="l23.49" class="difflineminus">-static int32_t DIR_GetIntPref(const char *prefRoot, const char *prefLeaf,</span>
<a href="#l23.50"></a><span id="l23.50" class="difflineminus">-                              int32_t defaultValue);</span>
<a href="#l23.51"></a><span id="l23.51" class="difflineminus">-static char *DIR_GetLocalizedStringPref(const char *prefRoot,</span>
<a href="#l23.52"></a><span id="l23.52" class="difflineminus">-                                        const char *prefLeaf);</span>
<a href="#l23.53"></a><span id="l23.53" class="difflineminus">-</span>
<a href="#l23.54"></a><span id="l23.54" class="difflineminus">-static char *dir_ConvertDescriptionToPrefName(DIR_Server *server);</span>
<a href="#l23.55"></a><span id="l23.55" class="difflineminus">-</span>
<a href="#l23.56"></a><span id="l23.56" class="difflineminus">-void DIR_SetFileName(char **filename, const char *leafName);</span>
<a href="#l23.57"></a><span id="l23.57" class="difflineminus">-static void DIR_SetIntPref(const char *prefRoot, const char *prefLeaf,</span>
<a href="#l23.58"></a><span id="l23.58" class="difflineminus">-                           int32_t value, int32_t defaultValue);</span>
<a href="#l23.59"></a><span id="l23.59" class="difflineminus">-static DIR_Server *dir_MatchServerPrefToServer(</span>
<a href="#l23.60"></a><span id="l23.60" class="difflineminus">-    nsTArray&lt;DIR_Server *&gt; *wholeList, const char *pref);</span>
<a href="#l23.61"></a><span id="l23.61" class="difflineminus">-static bool dir_ValidateAndAddNewServer(nsTArray&lt;DIR_Server *&gt; *wholeList,</span>
<a href="#l23.62"></a><span id="l23.62" class="difflineminus">-                                        const char *fullprefname);</span>
<a href="#l23.63"></a><span id="l23.63" class="difflineminus">-static void DIR_DeleteServerList(nsTArray&lt;DIR_Server *&gt; *wholeList);</span>
<a href="#l23.64"></a><span id="l23.64" class="difflineminus">-</span>
<a href="#l23.65"></a><span id="l23.65" class="difflineminus">-static char *dir_CreateServerPrefName(DIR_Server *server);</span>
<a href="#l23.66"></a><span id="l23.66" class="difflineminus">-static void DIR_GetPrefsForOneServer(DIR_Server *server);</span>
<a href="#l23.67"></a><span id="l23.67" class="difflineminus">-</span>
<a href="#l23.68"></a><span id="l23.68" class="difflineminus">-static void DIR_InitServer(DIR_Server *server,</span>
<a href="#l23.69"></a><span id="l23.69" class="difflineminus">-                           DirectoryType dirType = (DirectoryType)0);</span>
<a href="#l23.70"></a><span id="l23.70" class="difflineminus">-static DIR_PrefId DIR_AtomizePrefName(const char *prefname);</span>
<a href="#l23.71"></a><span id="l23.71" class="difflineminus">-</span>
<a href="#l23.72"></a><span id="l23.72" class="difflineminus">-const int32_t DIR_POS_APPEND = -1;</span>
<a href="#l23.73"></a><span id="l23.73" class="difflineminus">-const int32_t DIR_POS_DELETE = -2;</span>
<a href="#l23.74"></a><span id="l23.74" class="difflineminus">-static bool DIR_SetServerPosition(nsTArray&lt;DIR_Server *&gt; *wholeList,</span>
<a href="#l23.75"></a><span id="l23.75" class="difflineminus">-                                  DIR_Server *server, int32_t position);</span>
<a href="#l23.76"></a><span id="l23.76" class="difflineminus">-</span>
<a href="#l23.77"></a><span id="l23.77" class="difflineminus">-/* These two routines should be called to initialize and save</span>
<a href="#l23.78"></a><span id="l23.78" class="difflineminus">- * directory preferences from the XP Java Script preferences</span>
<a href="#l23.79"></a><span id="l23.79" class="difflineminus">- */</span>
<a href="#l23.80"></a><span id="l23.80" class="difflineminus">-static nsresult DIR_GetServerPreferences(nsTArray&lt;DIR_Server *&gt; **list);</span>
<a href="#l23.81"></a><span id="l23.81" class="difflineminus">-static void DIR_SaveServerPreferences(nsTArray&lt;DIR_Server *&gt; *wholeList);</span>
<a href="#l23.82"></a><span id="l23.82" class="difflineminus">-</span>
<a href="#l23.83"></a><span id="l23.83" class="difflineminus">-static int32_t dir_UserId = 0;</span>
<a href="#l23.84"></a><span id="l23.84" class="difflineminus">-nsTArray&lt;DIR_Server *&gt; *dir_ServerList = nullptr;</span>
<a href="#l23.85"></a><span id="l23.85" class="difflineminus">-</span>
<a href="#l23.86"></a><span id="l23.86" class="difflineminus">-/*****************************************************************************</span>
<a href="#l23.87"></a><span id="l23.87" class="difflineminus">- * Functions for creating the new back end managed DIR_Server list.</span>
<a href="#l23.88"></a><span id="l23.88" class="difflineminus">- */</span>
<a href="#l23.89"></a><span id="l23.89" class="difflineminus">-class DirPrefObserver final : public nsSupportsWeakReference,</span>
<a href="#l23.90"></a><span id="l23.90" class="difflineminus">-                              public nsIObserver {</span>
<a href="#l23.91"></a><span id="l23.91" class="difflineminus">- public:</span>
<a href="#l23.92"></a><span id="l23.92" class="difflineminus">-  NS_DECL_ISUPPORTS</span>
<a href="#l23.93"></a><span id="l23.93" class="difflineminus">-  NS_DECL_NSIOBSERVER</span>
<a href="#l23.94"></a><span id="l23.94" class="difflineminus">-</span>
<a href="#l23.95"></a><span id="l23.95" class="difflineminus">- private:</span>
<a href="#l23.96"></a><span id="l23.96" class="difflineminus">-  ~DirPrefObserver() {}</span>
<a href="#l23.97"></a><span id="l23.97" class="difflineminus">-};</span>
<a href="#l23.98"></a><span id="l23.98" class="difflineminus">-</span>
<a href="#l23.99"></a><span id="l23.99" class="difflineminus">-NS_IMPL_ISUPPORTS(DirPrefObserver, nsISupportsWeakReference, nsIObserver)</span>
<a href="#l23.100"></a><span id="l23.100" class="difflineminus">-</span>
<a href="#l23.101"></a><span id="l23.101" class="difflineminus">-NS_IMETHODIMP DirPrefObserver::Observe(nsISupports *aSubject,</span>
<a href="#l23.102"></a><span id="l23.102" class="difflineminus">-                                       const char *aTopic,</span>
<a href="#l23.103"></a><span id="l23.103" class="difflineminus">-                                       const char16_t *aData) {</span>
<a href="#l23.104"></a><span id="l23.104" class="difflineminus">-  nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(do_QueryInterface(aSubject));</span>
<a href="#l23.105"></a><span id="l23.105" class="difflineminus">-  nsCString strPrefName;</span>
<a href="#l23.106"></a><span id="l23.106" class="difflineminus">-  strPrefName.Assign(NS_ConvertUTF16toUTF8(aData));</span>
<a href="#l23.107"></a><span id="l23.107" class="difflineminus">-  const char *prefname = strPrefName.get();</span>
<a href="#l23.108"></a><span id="l23.108" class="difflineminus">-</span>
<a href="#l23.109"></a><span id="l23.109" class="difflineminus">-  DIR_PrefId id = DIR_AtomizePrefName(prefname);</span>
<a href="#l23.110"></a><span id="l23.110" class="difflineminus">-</span>
<a href="#l23.111"></a><span id="l23.111" class="difflineminus">-  // Just get out if we get nothing here - we don't need to do anything</span>
<a href="#l23.112"></a><span id="l23.112" class="difflineminus">-  if (id == idNone) return NS_OK;</span>
<a href="#l23.113"></a><span id="l23.113" class="difflineminus">-</span>
<a href="#l23.114"></a><span id="l23.114" class="difflineminus">-  /* Check to see if the server is in the unified server list.</span>
<a href="#l23.115"></a><span id="l23.115" class="difflineminus">-   */</span>
<a href="#l23.116"></a><span id="l23.116" class="difflineminus">-  DIR_Server *server = dir_MatchServerPrefToServer(dir_ServerList, prefname);</span>
<a href="#l23.117"></a><span id="l23.117" class="difflineminus">-  if (server) {</span>
<a href="#l23.118"></a><span id="l23.118" class="difflineminus">-    /* If the server is in the process of being saved, just ignore this</span>
<a href="#l23.119"></a><span id="l23.119" class="difflineminus">-     * change.  The DIR_Server structure is not really changing.</span>
<a href="#l23.120"></a><span id="l23.120" class="difflineminus">-     */</span>
<a href="#l23.121"></a><span id="l23.121" class="difflineminus">-    if (server-&gt;savingServer) return NS_OK;</span>
<a href="#l23.122"></a><span id="l23.122" class="difflineminus">-</span>
<a href="#l23.123"></a><span id="l23.123" class="difflineminus">-    /* If the pref that changed is the position, read it in.  If the new</span>
<a href="#l23.124"></a><span id="l23.124" class="difflineminus">-     * position is zero, remove the server from the list.</span>
<a href="#l23.125"></a><span id="l23.125" class="difflineminus">-     */</span>
<a href="#l23.126"></a><span id="l23.126" class="difflineminus">-    if (id == idPosition) {</span>
<a href="#l23.127"></a><span id="l23.127" class="difflineminus">-      int32_t position;</span>
<a href="#l23.128"></a><span id="l23.128" class="difflineminus">-</span>
<a href="#l23.129"></a><span id="l23.129" class="difflineminus">-      /* We must not do anything if the new position is the same as the</span>
<a href="#l23.130"></a><span id="l23.130" class="difflineminus">-       * position in the DIR_Server.  This avoids recursion in cases</span>
<a href="#l23.131"></a><span id="l23.131" class="difflineminus">-       * where we are deleting the server.</span>
<a href="#l23.132"></a><span id="l23.132" class="difflineminus">-       */</span>
<a href="#l23.133"></a><span id="l23.133" class="difflineminus">-      prefBranch-&gt;GetIntPref(prefname, &amp;position);</span>
<a href="#l23.134"></a><span id="l23.134" class="difflineminus">-      if (position != server-&gt;position) {</span>
<a href="#l23.135"></a><span id="l23.135" class="difflineminus">-        server-&gt;position = position;</span>
<a href="#l23.136"></a><span id="l23.136" class="difflineminus">-        if (dir_IsServerDeleted(server))</span>
<a href="#l23.137"></a><span id="l23.137" class="difflineminus">-          DIR_SetServerPosition(dir_ServerList, server, DIR_POS_DELETE);</span>
<a href="#l23.138"></a><span id="l23.138" class="difflineminus">-      }</span>
<a href="#l23.139"></a><span id="l23.139" class="difflineminus">-    }</span>
<a href="#l23.140"></a><span id="l23.140" class="difflineminus">-</span>
<a href="#l23.141"></a><span id="l23.141" class="difflineminus">-    if (id == idDescription) {</span>
<a href="#l23.142"></a><span id="l23.142" class="difflineminus">-      // Ensure the local copy of the description is kept up to date.</span>
<a href="#l23.143"></a><span id="l23.143" class="difflineminus">-      PR_FREEIF(server-&gt;description);</span>
<a href="#l23.144"></a><span id="l23.144" class="difflineminus">-      server-&gt;description = DIR_GetLocalizedStringPref(prefname, nullptr);</span>
<a href="#l23.145"></a><span id="l23.145" class="difflineminus">-    }</span>
<a href="#l23.146"></a><span id="l23.146" class="difflineminus">-  }</span>
<a href="#l23.147"></a><span id="l23.147" class="difflineminus">-  /* If the server is not in the unified list, we may need to add it.  Servers</span>
<a href="#l23.148"></a><span id="l23.148" class="difflineminus">-   * are only added when the position, serverName and description are valid.</span>
<a href="#l23.149"></a><span id="l23.149" class="difflineminus">-   */</span>
<a href="#l23.150"></a><span id="l23.150" class="difflineminus">-  else if (id == idPosition || id == idType || id == idDescription) {</span>
<a href="#l23.151"></a><span id="l23.151" class="difflineminus">-    dir_ValidateAndAddNewServer(dir_ServerList, prefname);</span>
<a href="#l23.152"></a><span id="l23.152" class="difflineminus">-  }</span>
<a href="#l23.153"></a><span id="l23.153" class="difflineminus">-</span>
<a href="#l23.154"></a><span id="l23.154" class="difflineminus">-  return NS_OK;</span>
<a href="#l23.155"></a><span id="l23.155" class="difflineminus">-}</span>
<a href="#l23.156"></a><span id="l23.156" class="difflineminus">-</span>
<a href="#l23.157"></a><span id="l23.157" class="difflineminus">-// A pointer to the pref observer</span>
<a href="#l23.158"></a><span id="l23.158" class="difflineminus">-static RefPtr&lt;DirPrefObserver&gt; prefObserver;</span>
<a href="#l23.159"></a><span id="l23.159" class="difflineminus">-</span>
<a href="#l23.160"></a><span id="l23.160" class="difflineminus">-static nsresult DIR_GetDirServers() {</span>
<a href="#l23.161"></a><span id="l23.161" class="difflineminus">-  nsresult rv = NS_OK;</span>
<a href="#l23.162"></a><span id="l23.162" class="difflineminus">-</span>
<a href="#l23.163"></a><span id="l23.163" class="difflineminus">-  if (!dir_ServerList) {</span>
<a href="#l23.164"></a><span id="l23.164" class="difflineminus">-    /* we need to build the DIR_Server list */</span>
<a href="#l23.165"></a><span id="l23.165" class="difflineminus">-    rv = DIR_GetServerPreferences(&amp;dir_ServerList);</span>
<a href="#l23.166"></a><span id="l23.166" class="difflineminus">-</span>
<a href="#l23.167"></a><span id="l23.167" class="difflineminus">-    /* Register the preference call back if necessary. */</span>
<a href="#l23.168"></a><span id="l23.168" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; !prefObserver) {</span>
<a href="#l23.169"></a><span id="l23.169" class="difflineminus">-      nsCOMPtr&lt;nsIPrefBranch&gt; pbi(</span>
<a href="#l23.170"></a><span id="l23.170" class="difflineminus">-          do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l23.171"></a><span id="l23.171" class="difflineminus">-      if (NS_FAILED(rv)) return rv;</span>
<a href="#l23.172"></a><span id="l23.172" class="difflineminus">-      prefObserver = new DirPrefObserver();</span>
<a href="#l23.173"></a><span id="l23.173" class="difflineminus">-</span>
<a href="#l23.174"></a><span id="l23.174" class="difflineminus">-      pbi-&gt;AddObserver(PREF_LDAP_SERVER_TREE_NAME, prefObserver, true);</span>
<a href="#l23.175"></a><span id="l23.175" class="difflineminus">-    }</span>
<a href="#l23.176"></a><span id="l23.176" class="difflineminus">-  }</span>
<a href="#l23.177"></a><span id="l23.177" class="difflineminus">-  return rv;</span>
<a href="#l23.178"></a><span id="l23.178" class="difflineminus">-}</span>
<a href="#l23.179"></a><span id="l23.179" class="difflineminus">-</span>
<a href="#l23.180"></a><span id="l23.180" class="difflineminus">-nsTArray&lt;DIR_Server *&gt; *DIR_GetDirectories() {</span>
<a href="#l23.181"></a><span id="l23.181" class="difflineminus">-  if (!dir_ServerList) DIR_GetDirServers();</span>
<a href="#l23.182"></a><span id="l23.182" class="difflineminus">-  return dir_ServerList;</span>
<a href="#l23.183"></a><span id="l23.183" class="difflineminus">-}</span>
<a href="#l23.184"></a><span id="l23.184" class="difflineminus">-</span>
<a href="#l23.185"></a><span id="l23.185" class="difflineminus">-DIR_Server *DIR_GetServerFromList(const char *prefName) {</span>
<a href="#l23.186"></a><span id="l23.186" class="difflineminus">-  DIR_Server *result = nullptr;</span>
<a href="#l23.187"></a><span id="l23.187" class="difflineminus">-</span>
<a href="#l23.188"></a><span id="l23.188" class="difflineminus">-  if (!dir_ServerList) DIR_GetDirServers();</span>
<a href="#l23.189"></a><span id="l23.189" class="difflineminus">-</span>
<a href="#l23.190"></a><span id="l23.190" class="difflineminus">-  if (dir_ServerList) {</span>
<a href="#l23.191"></a><span id="l23.191" class="difflineminus">-    int32_t count = dir_ServerList-&gt;Length();</span>
<a href="#l23.192"></a><span id="l23.192" class="difflineminus">-    int32_t i;</span>
<a href="#l23.193"></a><span id="l23.193" class="difflineminus">-    for (i = 0; i &lt; count; ++i) {</span>
<a href="#l23.194"></a><span id="l23.194" class="difflineminus">-      DIR_Server *server = dir_ServerList-&gt;ElementAt(i);</span>
<a href="#l23.195"></a><span id="l23.195" class="difflineminus">-</span>
<a href="#l23.196"></a><span id="l23.196" class="difflineminus">-      if (server &amp;&amp; strcmp(server-&gt;prefName, prefName) == 0) {</span>
<a href="#l23.197"></a><span id="l23.197" class="difflineminus">-        result = server;</span>
<a href="#l23.198"></a><span id="l23.198" class="difflineminus">-        break;</span>
<a href="#l23.199"></a><span id="l23.199" class="difflineminus">-      }</span>
<a href="#l23.200"></a><span id="l23.200" class="difflineminus">-    }</span>
<a href="#l23.201"></a><span id="l23.201" class="difflineminus">-  }</span>
<a href="#l23.202"></a><span id="l23.202" class="difflineminus">-  return result;</span>
<a href="#l23.203"></a><span id="l23.203" class="difflineminus">-}</span>
<a href="#l23.204"></a><span id="l23.204" class="difflineminus">-</span>
<a href="#l23.205"></a><span id="l23.205" class="difflineminus">-static nsresult SavePrefsFile() {</span>
<a href="#l23.206"></a><span id="l23.206" class="difflineminus">-  nsresult rv;</span>
<a href="#l23.207"></a><span id="l23.207" class="difflineminus">-  nsCOMPtr&lt;nsIPrefService&gt; pPref(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l23.208"></a><span id="l23.208" class="difflineminus">-  if (NS_FAILED(rv)) return rv;</span>
<a href="#l23.209"></a><span id="l23.209" class="difflineminus">-  return pPref-&gt;SavePrefFile(nullptr);</span>
<a href="#l23.210"></a><span id="l23.210" class="difflineminus">-}</span>
<a href="#l23.211"></a><span id="l23.211" class="difflineminus">-</span>
<a href="#l23.212"></a><span id="l23.212" class="difflineminus">-nsresult</span>
<a href="#l23.213"></a><span id="l23.213" class="difflineminus">-DIR_ShutDown() /* FEs should call this when the app is shutting down. It frees</span>
<a href="#l23.214"></a><span id="l23.214" class="difflineminus">-                  all DIR_Servers regardless of ref count values! */</span>
<a href="#l23.215"></a><span id="l23.215" class="difflineminus">-{</span>
<a href="#l23.216"></a><span id="l23.216" class="difflineminus">-  nsresult rv = SavePrefsFile();</span>
<a href="#l23.217"></a><span id="l23.217" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.218"></a><span id="l23.218" class="difflineminus">-</span>
<a href="#l23.219"></a><span id="l23.219" class="difflineminus">-  DIR_DeleteServerList(dir_ServerList);</span>
<a href="#l23.220"></a><span id="l23.220" class="difflineminus">-  dir_ServerList = nullptr;</span>
<a href="#l23.221"></a><span id="l23.221" class="difflineminus">-</span>
<a href="#l23.222"></a><span id="l23.222" class="difflineminus">-  /* unregister the preference call back, if necessary.</span>
<a href="#l23.223"></a><span id="l23.223" class="difflineminus">-   * we need to do this as DIR_Shutdown() is called when switching profiles</span>
<a href="#l23.224"></a><span id="l23.224" class="difflineminus">-   * when using turbo.  (see nsAbDirectoryDataSource::Observe())</span>
<a href="#l23.225"></a><span id="l23.225" class="difflineminus">-   * When switching profiles, prefs get unloaded and then re-loaded</span>
<a href="#l23.226"></a><span id="l23.226" class="difflineminus">-   * we don't want our callback to get called for all that.</span>
<a href="#l23.227"></a><span id="l23.227" class="difflineminus">-   * We'll reset our callback the first time DIR_GetDirServers() is called</span>
<a href="#l23.228"></a><span id="l23.228" class="difflineminus">-   * after we've switched profiles.</span>
<a href="#l23.229"></a><span id="l23.229" class="difflineminus">-   */</span>
<a href="#l23.230"></a><span id="l23.230" class="difflineminus">-  prefObserver = nullptr;</span>
<a href="#l23.231"></a><span id="l23.231" class="difflineminus">-</span>
<a href="#l23.232"></a><span id="l23.232" class="difflineminus">-  return NS_OK;</span>
<a href="#l23.233"></a><span id="l23.233" class="difflineminus">-}</span>
<a href="#l23.234"></a><span id="l23.234" class="difflineminus">-</span>
<a href="#l23.235"></a><span id="l23.235" class="difflineminus">-nsresult DIR_ContainsServer(DIR_Server *pServer, bool *hasDir) {</span>
<a href="#l23.236"></a><span id="l23.236" class="difflineminus">-  if (dir_ServerList) {</span>
<a href="#l23.237"></a><span id="l23.237" class="difflineminus">-    int32_t count = dir_ServerList-&gt;Length();</span>
<a href="#l23.238"></a><span id="l23.238" class="difflineminus">-    int32_t i;</span>
<a href="#l23.239"></a><span id="l23.239" class="difflineminus">-    for (i = 0; i &lt; count; i++) {</span>
<a href="#l23.240"></a><span id="l23.240" class="difflineminus">-      DIR_Server *server = dir_ServerList-&gt;ElementAt(i);</span>
<a href="#l23.241"></a><span id="l23.241" class="difflineminus">-      if (server == pServer) {</span>
<a href="#l23.242"></a><span id="l23.242" class="difflineminus">-        *hasDir = true;</span>
<a href="#l23.243"></a><span id="l23.243" class="difflineminus">-        return NS_OK;</span>
<a href="#l23.244"></a><span id="l23.244" class="difflineminus">-      }</span>
<a href="#l23.245"></a><span id="l23.245" class="difflineminus">-    }</span>
<a href="#l23.246"></a><span id="l23.246" class="difflineminus">-  }</span>
<a href="#l23.247"></a><span id="l23.247" class="difflineminus">-  *hasDir = false;</span>
<a href="#l23.248"></a><span id="l23.248" class="difflineminus">-  return NS_OK;</span>
<a href="#l23.249"></a><span id="l23.249" class="difflineminus">-}</span>
<a href="#l23.250"></a><span id="l23.250" class="difflineminus">-</span>
<a href="#l23.251"></a><span id="l23.251" class="difflineminus">-nsresult DIR_AddNewAddressBook(const nsAString &amp;dirName,</span>
<a href="#l23.252"></a><span id="l23.252" class="difflineminus">-                               const nsACString &amp;fileName,</span>
<a href="#l23.253"></a><span id="l23.253" class="difflineminus">-                               const nsACString &amp;uri, DirectoryType dirType,</span>
<a href="#l23.254"></a><span id="l23.254" class="difflineminus">-                               const nsACString &amp;prefName,</span>
<a href="#l23.255"></a><span id="l23.255" class="difflineminus">-                               DIR_Server **pServer) {</span>
<a href="#l23.256"></a><span id="l23.256" class="difflineminus">-  DIR_Server *server = (DIR_Server *)PR_Malloc(sizeof(DIR_Server));</span>
<a href="#l23.257"></a><span id="l23.257" class="difflineminus">-  if (!server) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l23.258"></a><span id="l23.258" class="difflineminus">-</span>
<a href="#l23.259"></a><span id="l23.259" class="difflineminus">-  DIR_InitServer(server, dirType);</span>
<a href="#l23.260"></a><span id="l23.260" class="difflineminus">-  if (!dir_ServerList) DIR_GetDirServers();</span>
<a href="#l23.261"></a><span id="l23.261" class="difflineminus">-  if (dir_ServerList) {</span>
<a href="#l23.262"></a><span id="l23.262" class="difflineminus">-    server-&gt;description = ToNewCString(NS_ConvertUTF16toUTF8(dirName));</span>
<a href="#l23.263"></a><span id="l23.263" class="difflineminus">-    server-&gt;position =</span>
<a href="#l23.264"></a><span id="l23.264" class="difflineminus">-        kDefaultPosition;  // don't set position so alphabetic sort will happen.</span>
<a href="#l23.265"></a><span id="l23.265" class="difflineminus">-</span>
<a href="#l23.266"></a><span id="l23.266" class="difflineminus">-    if (!fileName.IsEmpty())</span>
<a href="#l23.267"></a><span id="l23.267" class="difflineminus">-      server-&gt;fileName = ToNewCString(fileName);</span>
<a href="#l23.268"></a><span id="l23.268" class="difflineminus">-    else if (dirType == LDAPDirectory)</span>
<a href="#l23.269"></a><span id="l23.269" class="difflineminus">-      DIR_SetFileName(&amp;server-&gt;fileName, kMainLdapAddressBook);</span>
<a href="#l23.270"></a><span id="l23.270" class="difflineminus">-    else if (dirType == JSDirectory)</span>
<a href="#l23.271"></a><span id="l23.271" class="difflineminus">-      DIR_SetFileName(&amp;server-&gt;fileName, kJSAddressBook);</span>
<a href="#l23.272"></a><span id="l23.272" class="difflineminus">-</span>
<a href="#l23.273"></a><span id="l23.273" class="difflineminus">-    if (dirType != PABDirectory) {</span>
<a href="#l23.274"></a><span id="l23.274" class="difflineminus">-      if (!uri.IsEmpty()) server-&gt;uri = ToNewCString(uri);</span>
<a href="#l23.275"></a><span id="l23.275" class="difflineminus">-    }</span>
<a href="#l23.276"></a><span id="l23.276" class="difflineminus">-</span>
<a href="#l23.277"></a><span id="l23.277" class="difflineminus">-    if (!prefName.IsEmpty()) server-&gt;prefName = ToNewCString(prefName);</span>
<a href="#l23.278"></a><span id="l23.278" class="difflineminus">-</span>
<a href="#l23.279"></a><span id="l23.279" class="difflineminus">-    dir_ServerList-&gt;AppendElement(server);</span>
<a href="#l23.280"></a><span id="l23.280" class="difflineminus">-</span>
<a href="#l23.281"></a><span id="l23.281" class="difflineminus">-    DIR_SavePrefsForOneServer(server);</span>
<a href="#l23.282"></a><span id="l23.282" class="difflineminus">-</span>
<a href="#l23.283"></a><span id="l23.283" class="difflineminus">-    *pServer = server;</span>
<a href="#l23.284"></a><span id="l23.284" class="difflineminus">-</span>
<a href="#l23.285"></a><span id="l23.285" class="difflineminus">-    // save new address book into pref file</span>
<a href="#l23.286"></a><span id="l23.286" class="difflineminus">-    return SavePrefsFile();</span>
<a href="#l23.287"></a><span id="l23.287" class="difflineminus">-  }</span>
<a href="#l23.288"></a><span id="l23.288" class="difflineminus">-  return NS_ERROR_FAILURE;</span>
<a href="#l23.289"></a><span id="l23.289" class="difflineminus">-}</span>
<a href="#l23.290"></a><span id="l23.290" class="difflineminus">-</span>
<a href="#l23.291"></a><span id="l23.291" class="difflineminus">-/*****************************************************************************</span>
<a href="#l23.292"></a><span id="l23.292" class="difflineminus">- * Functions for creating DIR_Servers</span>
<a href="#l23.293"></a><span id="l23.293" class="difflineminus">- */</span>
<a href="#l23.294"></a><span id="l23.294" class="difflineminus">-static void DIR_InitServer(DIR_Server *server, DirectoryType dirType) {</span>
<a href="#l23.295"></a><span id="l23.295" class="difflineminus">-  if (!server) {</span>
<a href="#l23.296"></a><span id="l23.296" class="difflineminus">-    NS_WARNING(&quot;DIR_InitServer: server parameter not initialized&quot;);</span>
<a href="#l23.297"></a><span id="l23.297" class="difflineminus">-    return;</span>
<a href="#l23.298"></a><span id="l23.298" class="difflineminus">-  }</span>
<a href="#l23.299"></a><span id="l23.299" class="difflineminus">-</span>
<a href="#l23.300"></a><span id="l23.300" class="difflineminus">-  memset(server, 0, sizeof(DIR_Server));</span>
<a href="#l23.301"></a><span id="l23.301" class="difflineminus">-  server-&gt;position = kDefaultPosition;</span>
<a href="#l23.302"></a><span id="l23.302" class="difflineminus">-  server-&gt;uri = nullptr;</span>
<a href="#l23.303"></a><span id="l23.303" class="difflineminus">-  server-&gt;savingServer = false;</span>
<a href="#l23.304"></a><span id="l23.304" class="difflineminus">-  server-&gt;dirType = dirType;</span>
<a href="#l23.305"></a><span id="l23.305" class="difflineminus">-}</span>
<a href="#l23.306"></a><span id="l23.306" class="difflineminus">-</span>
<a href="#l23.307"></a><span id="l23.307" class="difflineminus">-/* Function for setting the position of a server.  Can be used to append,</span>
<a href="#l23.308"></a><span id="l23.308" class="difflineminus">- * delete, or move a server in a server list.</span>
<a href="#l23.309"></a><span id="l23.309" class="difflineminus">- *</span>
<a href="#l23.310"></a><span id="l23.310" class="difflineminus">- * The third parameter specifies the new position the server is to occupy.</span>
<a href="#l23.311"></a><span id="l23.311" class="difflineminus">- * The resulting position may differ depending on the lock state of the</span>
<a href="#l23.312"></a><span id="l23.312" class="difflineminus">- * given server and other servers in the list.  The following special values</span>
<a href="#l23.313"></a><span id="l23.313" class="difflineminus">- * are supported:</span>
<a href="#l23.314"></a><span id="l23.314" class="difflineminus">- *   DIR_POS_APPEND - Appends the server to the end of the list.  If the server</span>
<a href="#l23.315"></a><span id="l23.315" class="difflineminus">- *                    is already in the list, does nothing.</span>
<a href="#l23.316"></a><span id="l23.316" class="difflineminus">- *   DIR_POS_DELETE - Deletes the given server from the list.  Note that this</span>
<a href="#l23.317"></a><span id="l23.317" class="difflineminus">- *                    does not cause the server structure to be freed.</span>
<a href="#l23.318"></a><span id="l23.318" class="difflineminus">- *</span>
<a href="#l23.319"></a><span id="l23.319" class="difflineminus">- * Returns true if the server list was re-sorted.</span>
<a href="#l23.320"></a><span id="l23.320" class="difflineminus">- */</span>
<a href="#l23.321"></a><span id="l23.321" class="difflineminus">-static bool DIR_SetServerPosition(nsTArray&lt;DIR_Server *&gt; *wholeList,</span>
<a href="#l23.322"></a><span id="l23.322" class="difflineminus">-                                  DIR_Server *server, int32_t position) {</span>
<a href="#l23.323"></a><span id="l23.323" class="difflineminus">-  NS_ENSURE_TRUE(wholeList, false);</span>
<a href="#l23.324"></a><span id="l23.324" class="difflineminus">-</span>
<a href="#l23.325"></a><span id="l23.325" class="difflineminus">-  int32_t i, count, num;</span>
<a href="#l23.326"></a><span id="l23.326" class="difflineminus">-  bool resort = false;</span>
<a href="#l23.327"></a><span id="l23.327" class="difflineminus">-  DIR_Server *s = nullptr;</span>
<a href="#l23.328"></a><span id="l23.328" class="difflineminus">-</span>
<a href="#l23.329"></a><span id="l23.329" class="difflineminus">-  switch (position) {</span>
<a href="#l23.330"></a><span id="l23.330" class="difflineminus">-    case DIR_POS_APPEND:</span>
<a href="#l23.331"></a><span id="l23.331" class="difflineminus">-      /* Do nothing if the request is to append a server that is already</span>
<a href="#l23.332"></a><span id="l23.332" class="difflineminus">-       * in the list.</span>
<a href="#l23.333"></a><span id="l23.333" class="difflineminus">-       */</span>
<a href="#l23.334"></a><span id="l23.334" class="difflineminus">-      count = wholeList-&gt;Length();</span>
<a href="#l23.335"></a><span id="l23.335" class="difflineminus">-      for (i = 0; i &lt; count; i++) {</span>
<a href="#l23.336"></a><span id="l23.336" class="difflineminus">-        if ((s = wholeList-&gt;ElementAt(i)) != nullptr)</span>
<a href="#l23.337"></a><span id="l23.337" class="difflineminus">-          if (s == server) return false;</span>
<a href="#l23.338"></a><span id="l23.338" class="difflineminus">-      }</span>
<a href="#l23.339"></a><span id="l23.339" class="difflineminus">-      /* In general, if there are any servers already in the list, set the</span>
<a href="#l23.340"></a><span id="l23.340" class="difflineminus">-       * position to the position of the last server plus one.  If there</span>
<a href="#l23.341"></a><span id="l23.341" class="difflineminus">-       * are none, set it to position 1.</span>
<a href="#l23.342"></a><span id="l23.342" class="difflineminus">-       */</span>
<a href="#l23.343"></a><span id="l23.343" class="difflineminus">-      if (count &gt; 0) {</span>
<a href="#l23.344"></a><span id="l23.344" class="difflineminus">-        s = wholeList-&gt;ElementAt(count - 1);</span>
<a href="#l23.345"></a><span id="l23.345" class="difflineminus">-        server-&gt;position = s-&gt;position + 1;</span>
<a href="#l23.346"></a><span id="l23.346" class="difflineminus">-      } else</span>
<a href="#l23.347"></a><span id="l23.347" class="difflineminus">-        server-&gt;position = 1;</span>
<a href="#l23.348"></a><span id="l23.348" class="difflineminus">-</span>
<a href="#l23.349"></a><span id="l23.349" class="difflineminus">-      wholeList-&gt;AppendElement(server);</span>
<a href="#l23.350"></a><span id="l23.350" class="difflineminus">-      break;</span>
<a href="#l23.351"></a><span id="l23.351" class="difflineminus">-</span>
<a href="#l23.352"></a><span id="l23.352" class="difflineminus">-    case DIR_POS_DELETE:</span>
<a href="#l23.353"></a><span id="l23.353" class="difflineminus">-      /* Remove the prefs corresponding to the given server.  If the prefName</span>
<a href="#l23.354"></a><span id="l23.354" class="difflineminus">-       * value is nullptr, the server has never been saved and there are no</span>
<a href="#l23.355"></a><span id="l23.355" class="difflineminus">-       * prefs to remove.</span>
<a href="#l23.356"></a><span id="l23.356" class="difflineminus">-       */</span>
<a href="#l23.357"></a><span id="l23.357" class="difflineminus">-      if (server-&gt;prefName) {</span>
<a href="#l23.358"></a><span id="l23.358" class="difflineminus">-        nsresult rv;</span>
<a href="#l23.359"></a><span id="l23.359" class="difflineminus">-        nsCOMPtr&lt;nsIPrefBranch&gt; pPref(</span>
<a href="#l23.360"></a><span id="l23.360" class="difflineminus">-            do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l23.361"></a><span id="l23.361" class="difflineminus">-        if (NS_FAILED(rv)) return false;</span>
<a href="#l23.362"></a><span id="l23.362" class="difflineminus">-</span>
<a href="#l23.363"></a><span id="l23.363" class="difflineminus">-        pPref-&gt;DeleteBranch(server-&gt;prefName);</span>
<a href="#l23.364"></a><span id="l23.364" class="difflineminus">-</span>
<a href="#l23.365"></a><span id="l23.365" class="difflineminus">-        // mark the server as deleted by setting its position to 0</span>
<a href="#l23.366"></a><span id="l23.366" class="difflineminus">-        DIR_SetIntPref(server-&gt;prefName, &quot;position&quot;, 0, -1);</span>
<a href="#l23.367"></a><span id="l23.367" class="difflineminus">-      }</span>
<a href="#l23.368"></a><span id="l23.368" class="difflineminus">-</span>
<a href="#l23.369"></a><span id="l23.369" class="difflineminus">-      /* If the server is in the server list, remove it.</span>
<a href="#l23.370"></a><span id="l23.370" class="difflineminus">-       */</span>
<a href="#l23.371"></a><span id="l23.371" class="difflineminus">-      num = wholeList-&gt;IndexOf(server);</span>
<a href="#l23.372"></a><span id="l23.372" class="difflineminus">-      if (num &gt;= 0) {</span>
<a href="#l23.373"></a><span id="l23.373" class="difflineminus">-        /* The list does not need to be re-sorted if the server is the</span>
<a href="#l23.374"></a><span id="l23.374" class="difflineminus">-         * last one in the list.</span>
<a href="#l23.375"></a><span id="l23.375" class="difflineminus">-         */</span>
<a href="#l23.376"></a><span id="l23.376" class="difflineminus">-        count = wholeList-&gt;Length();</span>
<a href="#l23.377"></a><span id="l23.377" class="difflineminus">-        if (num == count - 1) {</span>
<a href="#l23.378"></a><span id="l23.378" class="difflineminus">-          wholeList-&gt;RemoveElementAt(num);</span>
<a href="#l23.379"></a><span id="l23.379" class="difflineminus">-        } else {</span>
<a href="#l23.380"></a><span id="l23.380" class="difflineminus">-          resort = true;</span>
<a href="#l23.381"></a><span id="l23.381" class="difflineminus">-          wholeList-&gt;RemoveElement(server);</span>
<a href="#l23.382"></a><span id="l23.382" class="difflineminus">-        }</span>
<a href="#l23.383"></a><span id="l23.383" class="difflineminus">-      }</span>
<a href="#l23.384"></a><span id="l23.384" class="difflineminus">-      break;</span>
<a href="#l23.385"></a><span id="l23.385" class="difflineminus">-</span>
<a href="#l23.386"></a><span id="l23.386" class="difflineminus">-    default:</span>
<a href="#l23.387"></a><span id="l23.387" class="difflineminus">-      /* See if the server is already in the list.</span>
<a href="#l23.388"></a><span id="l23.388" class="difflineminus">-       */</span>
<a href="#l23.389"></a><span id="l23.389" class="difflineminus">-      count = wholeList-&gt;Length();</span>
<a href="#l23.390"></a><span id="l23.390" class="difflineminus">-      for (i = 0; i &lt; count; i++) {</span>
<a href="#l23.391"></a><span id="l23.391" class="difflineminus">-        if ((s = wholeList-&gt;ElementAt(i)) != nullptr)</span>
<a href="#l23.392"></a><span id="l23.392" class="difflineminus">-          if (s == server) break;</span>
<a href="#l23.393"></a><span id="l23.393" class="difflineminus">-      }</span>
<a href="#l23.394"></a><span id="l23.394" class="difflineminus">-</span>
<a href="#l23.395"></a><span id="l23.395" class="difflineminus">-      /* If the server is not in the list, add it to the beginning and re-sort.</span>
<a href="#l23.396"></a><span id="l23.396" class="difflineminus">-       */</span>
<a href="#l23.397"></a><span id="l23.397" class="difflineminus">-      if (s == nullptr) {</span>
<a href="#l23.398"></a><span id="l23.398" class="difflineminus">-        server-&gt;position = position;</span>
<a href="#l23.399"></a><span id="l23.399" class="difflineminus">-        wholeList-&gt;AppendElement(server);</span>
<a href="#l23.400"></a><span id="l23.400" class="difflineminus">-        resort = true;</span>
<a href="#l23.401"></a><span id="l23.401" class="difflineminus">-      }</span>
<a href="#l23.402"></a><span id="l23.402" class="difflineminus">-</span>
<a href="#l23.403"></a><span id="l23.403" class="difflineminus">-      /* Don't re-sort if the server is already in the requested position.</span>
<a href="#l23.404"></a><span id="l23.404" class="difflineminus">-       */</span>
<a href="#l23.405"></a><span id="l23.405" class="difflineminus">-      else if (server-&gt;position != position) {</span>
<a href="#l23.406"></a><span id="l23.406" class="difflineminus">-        server-&gt;position = position;</span>
<a href="#l23.407"></a><span id="l23.407" class="difflineminus">-        wholeList-&gt;RemoveElement(server);</span>
<a href="#l23.408"></a><span id="l23.408" class="difflineminus">-        wholeList-&gt;AppendElement(server);</span>
<a href="#l23.409"></a><span id="l23.409" class="difflineminus">-        resort = true;</span>
<a href="#l23.410"></a><span id="l23.410" class="difflineminus">-      }</span>
<a href="#l23.411"></a><span id="l23.411" class="difflineminus">-      break;</span>
<a href="#l23.412"></a><span id="l23.412" class="difflineminus">-  }</span>
<a href="#l23.413"></a><span id="l23.413" class="difflineminus">-</span>
<a href="#l23.414"></a><span id="l23.414" class="difflineminus">-  /* Make sure our position changes get saved back to prefs</span>
<a href="#l23.415"></a><span id="l23.415" class="difflineminus">-   */</span>
<a href="#l23.416"></a><span id="l23.416" class="difflineminus">-  DIR_SaveServerPreferences(wholeList);</span>
<a href="#l23.417"></a><span id="l23.417" class="difflineminus">-</span>
<a href="#l23.418"></a><span id="l23.418" class="difflineminus">-  return resort;</span>
<a href="#l23.419"></a><span id="l23.419" class="difflineminus">-}</span>
<a href="#l23.420"></a><span id="l23.420" class="difflineminus">-</span>
<a href="#l23.421"></a><span id="l23.421" class="difflineminus">-/*****************************************************************************</span>
<a href="#l23.422"></a><span id="l23.422" class="difflineminus">- * DIR_Server Callback Notification Functions</span>
<a href="#l23.423"></a><span id="l23.423" class="difflineminus">- */</span>
<a href="#l23.424"></a><span id="l23.424" class="difflineminus">-</span>
<a href="#l23.425"></a><span id="l23.425" class="difflineminus">-/* dir_matchServerPrefToServer</span>
<a href="#l23.426"></a><span id="l23.426" class="difflineminus">- *</span>
<a href="#l23.427"></a><span id="l23.427" class="difflineminus">- * This function finds the DIR_Server in the unified DIR_Server list to which</span>
<a href="#l23.428"></a><span id="l23.428" class="difflineminus">- * the given preference string belongs.</span>
<a href="#l23.429"></a><span id="l23.429" class="difflineminus">- */</span>
<a href="#l23.430"></a><span id="l23.430" class="difflineminus">-static DIR_Server *dir_MatchServerPrefToServer(</span>
<a href="#l23.431"></a><span id="l23.431" class="difflineminus">-    nsTArray&lt;DIR_Server *&gt; *wholeList, const char *pref) {</span>
<a href="#l23.432"></a><span id="l23.432" class="difflineminus">-  DIR_Server *server;</span>
<a href="#l23.433"></a><span id="l23.433" class="difflineminus">-</span>
<a href="#l23.434"></a><span id="l23.434" class="difflineminus">-  int32_t count = wholeList-&gt;Length();</span>
<a href="#l23.435"></a><span id="l23.435" class="difflineminus">-  int32_t i;</span>
<a href="#l23.436"></a><span id="l23.436" class="difflineminus">-  for (i = 0; i &lt; count; i++) {</span>
<a href="#l23.437"></a><span id="l23.437" class="difflineminus">-    if ((server = wholeList-&gt;ElementAt(i)) != nullptr) {</span>
<a href="#l23.438"></a><span id="l23.438" class="difflineminus">-      if (server-&gt;prefName &amp;&amp; PL_strstr(pref, server-&gt;prefName) == pref) {</span>
<a href="#l23.439"></a><span id="l23.439" class="difflineminus">-        char c = pref[PL_strlen(server-&gt;prefName)];</span>
<a href="#l23.440"></a><span id="l23.440" class="difflineminus">-        if (c == 0 || c == '.') return server;</span>
<a href="#l23.441"></a><span id="l23.441" class="difflineminus">-      }</span>
<a href="#l23.442"></a><span id="l23.442" class="difflineminus">-    }</span>
<a href="#l23.443"></a><span id="l23.443" class="difflineminus">-  }</span>
<a href="#l23.444"></a><span id="l23.444" class="difflineminus">-  return nullptr;</span>
<a href="#l23.445"></a><span id="l23.445" class="difflineminus">-}</span>
<a href="#l23.446"></a><span id="l23.446" class="difflineminus">-</span>
<a href="#l23.447"></a><span id="l23.447" class="difflineminus">-/* dir_ValidateAndAddNewServer</span>
<a href="#l23.448"></a><span id="l23.448" class="difflineminus">- *</span>
<a href="#l23.449"></a><span id="l23.449" class="difflineminus">- * This function verifies that the position, serverName and description values</span>
<a href="#l23.450"></a><span id="l23.450" class="difflineminus">- * are set for the given prefName.  If they are then it adds the server to the</span>
<a href="#l23.451"></a><span id="l23.451" class="difflineminus">- * unified server list.</span>
<a href="#l23.452"></a><span id="l23.452" class="difflineminus">- */</span>
<a href="#l23.453"></a><span id="l23.453" class="difflineminus">-static bool dir_ValidateAndAddNewServer(nsTArray&lt;DIR_Server *&gt; *wholeList,</span>
<a href="#l23.454"></a><span id="l23.454" class="difflineminus">-                                        const char *fullprefname) {</span>
<a href="#l23.455"></a><span id="l23.455" class="difflineminus">-  bool rc = false;</span>
<a href="#l23.456"></a><span id="l23.456" class="difflineminus">-</span>
<a href="#l23.457"></a><span id="l23.457" class="difflineminus">-  const char *endname =</span>
<a href="#l23.458"></a><span id="l23.458" class="difflineminus">-      PL_strchr(&amp;fullprefname[PL_strlen(PREF_LDAP_SERVER_TREE_NAME) + 1], '.');</span>
<a href="#l23.459"></a><span id="l23.459" class="difflineminus">-  if (endname) {</span>
<a href="#l23.460"></a><span id="l23.460" class="difflineminus">-    char *prefname = (char *)PR_Malloc(endname - fullprefname + 1);</span>
<a href="#l23.461"></a><span id="l23.461" class="difflineminus">-    if (prefname) {</span>
<a href="#l23.462"></a><span id="l23.462" class="difflineminus">-      int32_t dirType;</span>
<a href="#l23.463"></a><span id="l23.463" class="difflineminus">-      char *t1 = nullptr, *t2 = nullptr;</span>
<a href="#l23.464"></a><span id="l23.464" class="difflineminus">-</span>
<a href="#l23.465"></a><span id="l23.465" class="difflineminus">-      PL_strncpyz(prefname, fullprefname, endname - fullprefname + 1);</span>
<a href="#l23.466"></a><span id="l23.466" class="difflineminus">-</span>
<a href="#l23.467"></a><span id="l23.467" class="difflineminus">-      dirType = DIR_GetIntPref(prefname, &quot;dirType&quot;, -1);</span>
<a href="#l23.468"></a><span id="l23.468" class="difflineminus">-      if (dirType != -1 &amp;&amp; DIR_GetIntPref(prefname, &quot;position&quot;, 0) != 0 &amp;&amp;</span>
<a href="#l23.469"></a><span id="l23.469" class="difflineminus">-          (t1 = DIR_GetLocalizedStringPref(prefname, &quot;description&quot;)) !=</span>
<a href="#l23.470"></a><span id="l23.470" class="difflineminus">-              nullptr) {</span>
<a href="#l23.471"></a><span id="l23.471" class="difflineminus">-        if (dirType == PABDirectory ||</span>
<a href="#l23.472"></a><span id="l23.472" class="difflineminus">-            (t2 = DIR_GetStringPref(prefname, &quot;serverName&quot;, nullptr)) !=</span>
<a href="#l23.473"></a><span id="l23.473" class="difflineminus">-                nullptr) {</span>
<a href="#l23.474"></a><span id="l23.474" class="difflineminus">-          DIR_Server *server = (DIR_Server *)PR_Malloc(sizeof(DIR_Server));</span>
<a href="#l23.475"></a><span id="l23.475" class="difflineminus">-          if (server) {</span>
<a href="#l23.476"></a><span id="l23.476" class="difflineminus">-            DIR_InitServer(server, (DirectoryType)dirType);</span>
<a href="#l23.477"></a><span id="l23.477" class="difflineminus">-            server-&gt;prefName = prefname;</span>
<a href="#l23.478"></a><span id="l23.478" class="difflineminus">-            DIR_GetPrefsForOneServer(server);</span>
<a href="#l23.479"></a><span id="l23.479" class="difflineminus">-            DIR_SetServerPosition(wholeList, server, server-&gt;position);</span>
<a href="#l23.480"></a><span id="l23.480" class="difflineminus">-            rc = true;</span>
<a href="#l23.481"></a><span id="l23.481" class="difflineminus">-          }</span>
<a href="#l23.482"></a><span id="l23.482" class="difflineminus">-          PR_FREEIF(t2);</span>
<a href="#l23.483"></a><span id="l23.483" class="difflineminus">-        }</span>
<a href="#l23.484"></a><span id="l23.484" class="difflineminus">-        PR_Free(t1);</span>
<a href="#l23.485"></a><span id="l23.485" class="difflineminus">-      } else</span>
<a href="#l23.486"></a><span id="l23.486" class="difflineminus">-        PR_Free(prefname);</span>
<a href="#l23.487"></a><span id="l23.487" class="difflineminus">-    }</span>
<a href="#l23.488"></a><span id="l23.488" class="difflineminus">-  }</span>
<a href="#l23.489"></a><span id="l23.489" class="difflineminus">-</span>
<a href="#l23.490"></a><span id="l23.490" class="difflineminus">-  return rc;</span>
<a href="#l23.491"></a><span id="l23.491" class="difflineminus">-}</span>
<a href="#l23.492"></a><span id="l23.492" class="difflineminus">-</span>
<a href="#l23.493"></a><span id="l23.493" class="difflineminus">-static DIR_PrefId DIR_AtomizePrefName(const char *prefname) {</span>
<a href="#l23.494"></a><span id="l23.494" class="difflineminus">-  if (!prefname) return idNone;</span>
<a href="#l23.495"></a><span id="l23.495" class="difflineminus">-</span>
<a href="#l23.496"></a><span id="l23.496" class="difflineminus">-  DIR_PrefId rc = idNone;</span>
<a href="#l23.497"></a><span id="l23.497" class="difflineminus">-</span>
<a href="#l23.498"></a><span id="l23.498" class="difflineminus">-  /* Skip the &quot;ldap_2.servers.&lt;server-name&gt;.&quot; portion of the string.</span>
<a href="#l23.499"></a><span id="l23.499" class="difflineminus">-   */</span>
<a href="#l23.500"></a><span id="l23.500" class="difflineminus">-  if (PL_strstr(prefname, PREF_LDAP_SERVER_TREE_NAME) == prefname) {</span>
<a href="#l23.501"></a><span id="l23.501" class="difflineminus">-    prefname =</span>
<a href="#l23.502"></a><span id="l23.502" class="difflineminus">-        PL_strchr(&amp;prefname[PL_strlen(PREF_LDAP_SERVER_TREE_NAME) + 1], '.');</span>
<a href="#l23.503"></a><span id="l23.503" class="difflineminus">-    if (!prefname)</span>
<a href="#l23.504"></a><span id="l23.504" class="difflineminus">-      return idNone;</span>
<a href="#l23.505"></a><span id="l23.505" class="difflineminus">-    else</span>
<a href="#l23.506"></a><span id="l23.506" class="difflineminus">-      prefname = prefname + 1;</span>
<a href="#l23.507"></a><span id="l23.507" class="difflineminus">-  }</span>
<a href="#l23.508"></a><span id="l23.508" class="difflineminus">-</span>
<a href="#l23.509"></a><span id="l23.509" class="difflineminus">-  switch (prefname[0]) {</span>
<a href="#l23.510"></a><span id="l23.510" class="difflineminus">-    case 'd':</span>
<a href="#l23.511"></a><span id="l23.511" class="difflineminus">-      switch (prefname[1]) {</span>
<a href="#l23.512"></a><span id="l23.512" class="difflineminus">-        case 'e': /* description */</span>
<a href="#l23.513"></a><span id="l23.513" class="difflineminus">-          rc = idDescription;</span>
<a href="#l23.514"></a><span id="l23.514" class="difflineminus">-          break;</span>
<a href="#l23.515"></a><span id="l23.515" class="difflineminus">-        case 'i': /* dirType */</span>
<a href="#l23.516"></a><span id="l23.516" class="difflineminus">-          rc = idType;</span>
<a href="#l23.517"></a><span id="l23.517" class="difflineminus">-          break;</span>
<a href="#l23.518"></a><span id="l23.518" class="difflineminus">-      }</span>
<a href="#l23.519"></a><span id="l23.519" class="difflineminus">-      break;</span>
<a href="#l23.520"></a><span id="l23.520" class="difflineminus">-</span>
<a href="#l23.521"></a><span id="l23.521" class="difflineminus">-    case 'f':</span>
<a href="#l23.522"></a><span id="l23.522" class="difflineminus">-      rc = idFileName;</span>
<a href="#l23.523"></a><span id="l23.523" class="difflineminus">-      break;</span>
<a href="#l23.524"></a><span id="l23.524" class="difflineminus">-</span>
<a href="#l23.525"></a><span id="l23.525" class="difflineminus">-    case 'p':</span>
<a href="#l23.526"></a><span id="l23.526" class="difflineminus">-      switch (prefname[1]) {</span>
<a href="#l23.527"></a><span id="l23.527" class="difflineminus">-        case 'o':</span>
<a href="#l23.528"></a><span id="l23.528" class="difflineminus">-          switch (prefname[2]) {</span>
<a href="#l23.529"></a><span id="l23.529" class="difflineminus">-            case 's': /* position */</span>
<a href="#l23.530"></a><span id="l23.530" class="difflineminus">-              rc = idPosition;</span>
<a href="#l23.531"></a><span id="l23.531" class="difflineminus">-              break;</span>
<a href="#l23.532"></a><span id="l23.532" class="difflineminus">-          }</span>
<a href="#l23.533"></a><span id="l23.533" class="difflineminus">-          break;</span>
<a href="#l23.534"></a><span id="l23.534" class="difflineminus">-      }</span>
<a href="#l23.535"></a><span id="l23.535" class="difflineminus">-      break;</span>
<a href="#l23.536"></a><span id="l23.536" class="difflineminus">-</span>
<a href="#l23.537"></a><span id="l23.537" class="difflineminus">-    case 'u': /* uri */</span>
<a href="#l23.538"></a><span id="l23.538" class="difflineminus">-      rc = idUri;</span>
<a href="#l23.539"></a><span id="l23.539" class="difflineminus">-      break;</span>
<a href="#l23.540"></a><span id="l23.540" class="difflineminus">-  }</span>
<a href="#l23.541"></a><span id="l23.541" class="difflineminus">-</span>
<a href="#l23.542"></a><span id="l23.542" class="difflineminus">-  return rc;</span>
<a href="#l23.543"></a><span id="l23.543" class="difflineminus">-}</span>
<a href="#l23.544"></a><span id="l23.544" class="difflineminus">-</span>
<a href="#l23.545"></a><span id="l23.545" class="difflineminus">-/*****************************************************************************</span>
<a href="#l23.546"></a><span id="l23.546" class="difflineminus">- * Functions for destroying DIR_Servers</span>
<a href="#l23.547"></a><span id="l23.547" class="difflineminus">- */</span>
<a href="#l23.548"></a><span id="l23.548" class="difflineminus">-</span>
<a href="#l23.549"></a><span id="l23.549" class="difflineminus">-/* this function determines if the passed in server is no longer part of the of</span>
<a href="#l23.550"></a><span id="l23.550" class="difflineminus">-   the global server list. */</span>
<a href="#l23.551"></a><span id="l23.551" class="difflineminus">-static bool dir_IsServerDeleted(DIR_Server *server) {</span>
<a href="#l23.552"></a><span id="l23.552" class="difflineminus">-  return (server &amp;&amp; server-&gt;position == 0);</span>
<a href="#l23.553"></a><span id="l23.553" class="difflineminus">-}</span>
<a href="#l23.554"></a><span id="l23.554" class="difflineminus">-</span>
<a href="#l23.555"></a><span id="l23.555" class="difflineminus">-/* when the back end manages the server list, deleting a server just decrements</span>
<a href="#l23.556"></a><span id="l23.556" class="difflineminus">-   its ref count, in the old world, we actually delete the server */</span>
<a href="#l23.557"></a><span id="l23.557" class="difflineminus">-static void DIR_DeleteServer(DIR_Server *server) {</span>
<a href="#l23.558"></a><span id="l23.558" class="difflineminus">-  if (server) {</span>
<a href="#l23.559"></a><span id="l23.559" class="difflineminus">-    /* when destroying the server check its clear flag to see if things need</span>
<a href="#l23.560"></a><span id="l23.560" class="difflineminus">-     * cleared */</span>
<a href="#l23.561"></a><span id="l23.561" class="difflineminus">-#ifdef XP_FileRemove</span>
<a href="#l23.562"></a><span id="l23.562" class="difflineminus">-    if (DIR_TestFlag(server, DIR_CLEAR_SERVER)) {</span>
<a href="#l23.563"></a><span id="l23.563" class="difflineminus">-      if (server-&gt;fileName) XP_FileRemove(server-&gt;fileName, xpAddrBookNew);</span>
<a href="#l23.564"></a><span id="l23.564" class="difflineminus">-    }</span>
<a href="#l23.565"></a><span id="l23.565" class="difflineminus">-#endif /* XP_FileRemove */</span>
<a href="#l23.566"></a><span id="l23.566" class="difflineminus">-    PR_Free(server-&gt;prefName);</span>
<a href="#l23.567"></a><span id="l23.567" class="difflineminus">-    PR_Free(server-&gt;description);</span>
<a href="#l23.568"></a><span id="l23.568" class="difflineminus">-    PR_Free(server-&gt;fileName);</span>
<a href="#l23.569"></a><span id="l23.569" class="difflineminus">-    PR_Free(server-&gt;uri);</span>
<a href="#l23.570"></a><span id="l23.570" class="difflineminus">-    PR_Free(server);</span>
<a href="#l23.571"></a><span id="l23.571" class="difflineminus">-  }</span>
<a href="#l23.572"></a><span id="l23.572" class="difflineminus">-}</span>
<a href="#l23.573"></a><span id="l23.573" class="difflineminus">-</span>
<a href="#l23.574"></a><span id="l23.574" class="difflineminus">-nsresult DIR_DeleteServerFromList(DIR_Server *server) {</span>
<a href="#l23.575"></a><span id="l23.575" class="difflineminus">-  if (!server) return NS_ERROR_NULL_POINTER;</span>
<a href="#l23.576"></a><span id="l23.576" class="difflineminus">-</span>
<a href="#l23.577"></a><span id="l23.577" class="difflineminus">-  nsCOMPtr&lt;nsIFile&gt; dbPath;</span>
<a href="#l23.578"></a><span id="l23.578" class="difflineminus">-  nsresult rv = NS_GetSpecialDirectory(NS_APP_USER_PROFILE_50_DIR,</span>
<a href="#l23.579"></a><span id="l23.579" class="difflineminus">-                                       getter_AddRefs(dbPath));</span>
<a href="#l23.580"></a><span id="l23.580" class="difflineminus">-</span>
<a href="#l23.581"></a><span id="l23.581" class="difflineminus">-  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l23.582"></a><span id="l23.582" class="difflineminus">-    // close the database, as long as it isn't the special ones</span>
<a href="#l23.583"></a><span id="l23.583" class="difflineminus">-    // (personal addressbook and collected addressbook)</span>
<a href="#l23.584"></a><span id="l23.584" class="difflineminus">-    // which can never be deleted.  There was a bug where we would slap in</span>
<a href="#l23.585"></a><span id="l23.585" class="difflineminus">-    // &quot;abook.mab&quot; as the file name for LDAP directories, which would cause a</span>
<a href="#l23.586"></a><span id="l23.586" class="difflineminus">-    // crash on delete of LDAP directories.  this is just extra protection.</span>
<a href="#l23.587"></a><span id="l23.587" class="difflineminus">-    if (server-&gt;fileName &amp;&amp; server-&gt;dirType != JSDirectory &amp;&amp;</span>
<a href="#l23.588"></a><span id="l23.588" class="difflineminus">-        strcmp(server-&gt;fileName, &quot;abook.mab&quot;) &amp;&amp;</span>
<a href="#l23.589"></a><span id="l23.589" class="difflineminus">-        strcmp(server-&gt;fileName, &quot;history.mab&quot;)) {</span>
<a href="#l23.590"></a><span id="l23.590" class="difflineminus">-      nsCOMPtr&lt;nsIAddrDatabase&gt; database;</span>
<a href="#l23.591"></a><span id="l23.591" class="difflineminus">-</span>
<a href="#l23.592"></a><span id="l23.592" class="difflineminus">-      rv = dbPath-&gt;AppendNative(nsDependentCString(server-&gt;fileName));</span>
<a href="#l23.593"></a><span id="l23.593" class="difflineminus">-      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.594"></a><span id="l23.594" class="difflineminus">-</span>
<a href="#l23.595"></a><span id="l23.595" class="difflineminus">-      // close file before delete it</span>
<a href="#l23.596"></a><span id="l23.596" class="difflineminus">-      nsCOMPtr&lt;nsIAddrDatabase&gt; addrDBFactory =</span>
<a href="#l23.597"></a><span id="l23.597" class="difflineminus">-          do_GetService(NS_ADDRDATABASE_CONTRACTID, &amp;rv);</span>
<a href="#l23.598"></a><span id="l23.598" class="difflineminus">-</span>
<a href="#l23.599"></a><span id="l23.599" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp; addrDBFactory)</span>
<a href="#l23.600"></a><span id="l23.600" class="difflineminus">-        rv = addrDBFactory-&gt;Open(dbPath, false, true, getter_AddRefs(database));</span>
<a href="#l23.601"></a><span id="l23.601" class="difflineminus">-      if (database) /* database exists */</span>
<a href="#l23.602"></a><span id="l23.602" class="difflineminus">-      {</span>
<a href="#l23.603"></a><span id="l23.603" class="difflineminus">-        database-&gt;ForceClosed();</span>
<a href="#l23.604"></a><span id="l23.604" class="difflineminus">-        rv = dbPath-&gt;Remove(false);</span>
<a href="#l23.605"></a><span id="l23.605" class="difflineminus">-        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.606"></a><span id="l23.606" class="difflineminus">-      }</span>
<a href="#l23.607"></a><span id="l23.607" class="difflineminus">-    }</span>
<a href="#l23.608"></a><span id="l23.608" class="difflineminus">-</span>
<a href="#l23.609"></a><span id="l23.609" class="difflineminus">-    nsTArray&lt;DIR_Server *&gt; *dirList = DIR_GetDirectories();</span>
<a href="#l23.610"></a><span id="l23.610" class="difflineminus">-    DIR_SetServerPosition(dirList, server, DIR_POS_DELETE);</span>
<a href="#l23.611"></a><span id="l23.611" class="difflineminus">-    DIR_DeleteServer(server);</span>
<a href="#l23.612"></a><span id="l23.612" class="difflineminus">-</span>
<a href="#l23.613"></a><span id="l23.613" class="difflineminus">-    return SavePrefsFile();</span>
<a href="#l23.614"></a><span id="l23.614" class="difflineminus">-  }</span>
<a href="#l23.615"></a><span id="l23.615" class="difflineminus">-</span>
<a href="#l23.616"></a><span id="l23.616" class="difflineminus">-  return NS_ERROR_NULL_POINTER;</span>
<a href="#l23.617"></a><span id="l23.617" class="difflineminus">-}</span>
<a href="#l23.618"></a><span id="l23.618" class="difflineminus">-</span>
<a href="#l23.619"></a><span id="l23.619" class="difflineminus">-static void DIR_DeleteServerList(nsTArray&lt;DIR_Server *&gt; *wholeList) {</span>
<a href="#l23.620"></a><span id="l23.620" class="difflineminus">-  if (wholeList) {</span>
<a href="#l23.621"></a><span id="l23.621" class="difflineminus">-    DIR_Server *server = nullptr;</span>
<a href="#l23.622"></a><span id="l23.622" class="difflineminus">-</span>
<a href="#l23.623"></a><span id="l23.623" class="difflineminus">-    /* TBD: Send notifications? */</span>
<a href="#l23.624"></a><span id="l23.624" class="difflineminus">-    int32_t count = wholeList-&gt;Length();</span>
<a href="#l23.625"></a><span id="l23.625" class="difflineminus">-    int32_t i;</span>
<a href="#l23.626"></a><span id="l23.626" class="difflineminus">-    for (i = count - 1; i &gt;= 0; i--) {</span>
<a href="#l23.627"></a><span id="l23.627" class="difflineminus">-      server = wholeList-&gt;ElementAt(i);</span>
<a href="#l23.628"></a><span id="l23.628" class="difflineminus">-      if (server != nullptr) DIR_DeleteServer(server);</span>
<a href="#l23.629"></a><span id="l23.629" class="difflineminus">-    }</span>
<a href="#l23.630"></a><span id="l23.630" class="difflineminus">-    delete wholeList;</span>
<a href="#l23.631"></a><span id="l23.631" class="difflineminus">-  }</span>
<a href="#l23.632"></a><span id="l23.632" class="difflineminus">-}</span>
<a href="#l23.633"></a><span id="l23.633" class="difflineminus">-</span>
<a href="#l23.634"></a><span id="l23.634" class="difflineminus">-/*****************************************************************************</span>
<a href="#l23.635"></a><span id="l23.635" class="difflineminus">- * Functions for managing JavaScript prefs for the DIR_Servers</span>
<a href="#l23.636"></a><span id="l23.636" class="difflineminus">- */</span>
<a href="#l23.637"></a><span id="l23.637" class="difflineminus">-</span>
<a href="#l23.638"></a><span id="l23.638" class="difflineminus">-class MOZ_STACK_CLASS PrefArrayMemberComparator {</span>
<a href="#l23.639"></a><span id="l23.639" class="difflineminus">- public:</span>
<a href="#l23.640"></a><span id="l23.640" class="difflineminus">-  explicit PrefArrayMemberComparator(uint32_t aOffset) : mOffset(aOffset) {}</span>
<a href="#l23.641"></a><span id="l23.641" class="difflineminus">-</span>
<a href="#l23.642"></a><span id="l23.642" class="difflineminus">-  // begin the comparison at |mOffset| chars into the string -</span>
<a href="#l23.643"></a><span id="l23.643" class="difflineminus">-  // this avoids comparing the &quot;ldap_2.servers.&quot; portion of every element,</span>
<a href="#l23.644"></a><span id="l23.644" class="difflineminus">-  // which will always remain the same.</span>
<a href="#l23.645"></a><span id="l23.645" class="difflineminus">-  bool Equals(const nsCString &amp;aFirst, const nsCString &amp;aSecond) const {</span>
<a href="#l23.646"></a><span id="l23.646" class="difflineminus">-    return Substring(aFirst, mOffset) == Substring(aSecond, mOffset);</span>
<a href="#l23.647"></a><span id="l23.647" class="difflineminus">-  }</span>
<a href="#l23.648"></a><span id="l23.648" class="difflineminus">-</span>
<a href="#l23.649"></a><span id="l23.649" class="difflineminus">-  bool LessThan(const nsCString &amp;aFirst, const nsCString &amp;aSecond) const {</span>
<a href="#l23.650"></a><span id="l23.650" class="difflineminus">-    return Substring(aFirst, mOffset) &lt; Substring(aSecond, mOffset);</span>
<a href="#l23.651"></a><span id="l23.651" class="difflineminus">-  }</span>
<a href="#l23.652"></a><span id="l23.652" class="difflineminus">-</span>
<a href="#l23.653"></a><span id="l23.653" class="difflineminus">- private:</span>
<a href="#l23.654"></a><span id="l23.654" class="difflineminus">-  uint32_t mOffset;</span>
<a href="#l23.655"></a><span id="l23.655" class="difflineminus">-};</span>
<a href="#l23.656"></a><span id="l23.656" class="difflineminus">-</span>
<a href="#l23.657"></a><span id="l23.657" class="difflineminus">-static nsresult dir_GetChildList(const nsCString &amp;aBranch,</span>
<a href="#l23.658"></a><span id="l23.658" class="difflineminus">-                                 nsTArray&lt;nsCString&gt; &amp;aChildList) {</span>
<a href="#l23.659"></a><span id="l23.659" class="difflineminus">-  uint32_t branchLen = aBranch.Length();</span>
<a href="#l23.660"></a><span id="l23.660" class="difflineminus">-</span>
<a href="#l23.661"></a><span id="l23.661" class="difflineminus">-  nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch = do_GetService(NS_PREFSERVICE_CONTRACTID);</span>
<a href="#l23.662"></a><span id="l23.662" class="difflineminus">-  if (!prefBranch) {</span>
<a href="#l23.663"></a><span id="l23.663" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l23.664"></a><span id="l23.664" class="difflineminus">-  }</span>
<a href="#l23.665"></a><span id="l23.665" class="difflineminus">-</span>
<a href="#l23.666"></a><span id="l23.666" class="difflineminus">-  nsresult rv = prefBranch-&gt;GetChildList(aBranch.get(), aChildList);</span>
<a href="#l23.667"></a><span id="l23.667" class="difflineminus">-  if (NS_FAILED(rv)) {</span>
<a href="#l23.668"></a><span id="l23.668" class="difflineminus">-    return rv;</span>
<a href="#l23.669"></a><span id="l23.669" class="difflineminus">-  }</span>
<a href="#l23.670"></a><span id="l23.670" class="difflineminus">-</span>
<a href="#l23.671"></a><span id="l23.671" class="difflineminus">-  // traverse the list, and truncate all the descendant strings to just</span>
<a href="#l23.672"></a><span id="l23.672" class="difflineminus">-  // one branch level below the root branch.</span>
<a href="#l23.673"></a><span id="l23.673" class="difflineminus">-  for (auto &amp;child : aChildList) {</span>
<a href="#l23.674"></a><span id="l23.674" class="difflineminus">-    // The prefname we passed to GetChildList was of the form</span>
<a href="#l23.675"></a><span id="l23.675" class="difflineminus">-    // &quot;ldap_2.servers.&quot; and we are returned the descendants</span>
<a href="#l23.676"></a><span id="l23.676" class="difflineminus">-    // in the form of &quot;ldap_2.servers.servername.foo&quot;</span>
<a href="#l23.677"></a><span id="l23.677" class="difflineminus">-    // But we want the prefbranch of the servername, so</span>
<a href="#l23.678"></a><span id="l23.678" class="difflineminus">-    // terminate the string at the first '.' after our branchname.</span>
<a href="#l23.679"></a><span id="l23.679" class="difflineminus">-    int32_t dotPos = child.FindChar('.', branchLen);</span>
<a href="#l23.680"></a><span id="l23.680" class="difflineminus">-    if (dotPos != kNotFound) {</span>
<a href="#l23.681"></a><span id="l23.681" class="difflineminus">-      child.Truncate(dotPos);</span>
<a href="#l23.682"></a><span id="l23.682" class="difflineminus">-    }</span>
<a href="#l23.683"></a><span id="l23.683" class="difflineminus">-  }</span>
<a href="#l23.684"></a><span id="l23.684" class="difflineminus">-</span>
<a href="#l23.685"></a><span id="l23.685" class="difflineminus">-  if (aChildList.Length() &gt; 1) {</span>
<a href="#l23.686"></a><span id="l23.686" class="difflineminus">-    // sort the list, in preparation for duplicate entry removal</span>
<a href="#l23.687"></a><span id="l23.687" class="difflineminus">-    PrefArrayMemberComparator comparator(branchLen);</span>
<a href="#l23.688"></a><span id="l23.688" class="difflineminus">-    aChildList.Sort(comparator);</span>
<a href="#l23.689"></a><span id="l23.689" class="difflineminus">-</span>
<a href="#l23.690"></a><span id="l23.690" class="difflineminus">-    // traverse the list and remove duplicate entries.</span>
<a href="#l23.691"></a><span id="l23.691" class="difflineminus">-    // we use two positions in the list; the current entry and the next</span>
<a href="#l23.692"></a><span id="l23.692" class="difflineminus">-    // entry; and perform a bunch of in-place moves. so |cur| points</span>
<a href="#l23.693"></a><span id="l23.693" class="difflineminus">-    // to the last unique entry, and |next| points to some (possibly much</span>
<a href="#l23.694"></a><span id="l23.694" class="difflineminus">-    // later) entry to test, at any given point. we know we have &gt;= 2</span>
<a href="#l23.695"></a><span id="l23.695" class="difflineminus">-    // elements in the list here, so we just init the two counters sensibly</span>
<a href="#l23.696"></a><span id="l23.696" class="difflineminus">-    // to begin with.</span>
<a href="#l23.697"></a><span id="l23.697" class="difflineminus">-    uint32_t cur = 0;</span>
<a href="#l23.698"></a><span id="l23.698" class="difflineminus">-    for (uint32_t next = 1; next &lt; aChildList.Length(); ++next) {</span>
<a href="#l23.699"></a><span id="l23.699" class="difflineminus">-      // check if the elements are equal or unique</span>
<a href="#l23.700"></a><span id="l23.700" class="difflineminus">-      if (comparator.Equals(aChildList[cur], aChildList[next])) {</span>
<a href="#l23.701"></a><span id="l23.701" class="difflineminus">-        ;  // equal - just increment the next element ptr</span>
<a href="#l23.702"></a><span id="l23.702" class="difflineminus">-      } else {</span>
<a href="#l23.703"></a><span id="l23.703" class="difflineminus">-        // cur &amp; next are unique, so we need to shift the element.</span>
<a href="#l23.704"></a><span id="l23.704" class="difflineminus">-        // ++cur will point to the next free location in the</span>
<a href="#l23.705"></a><span id="l23.705" class="difflineminus">-        // reduced array (it's okay if that's == next)</span>
<a href="#l23.706"></a><span id="l23.706" class="difflineminus">-        aChildList[++cur] = aChildList[next];</span>
<a href="#l23.707"></a><span id="l23.707" class="difflineminus">-      }</span>
<a href="#l23.708"></a><span id="l23.708" class="difflineminus">-    }</span>
<a href="#l23.709"></a><span id="l23.709" class="difflineminus">-</span>
<a href="#l23.710"></a><span id="l23.710" class="difflineminus">-    // update the unique element count</span>
<a href="#l23.711"></a><span id="l23.711" class="difflineminus">-    aChildList.SetLength(cur + 1);</span>
<a href="#l23.712"></a><span id="l23.712" class="difflineminus">-  }</span>
<a href="#l23.713"></a><span id="l23.713" class="difflineminus">-</span>
<a href="#l23.714"></a><span id="l23.714" class="difflineminus">-  return NS_OK;</span>
<a href="#l23.715"></a><span id="l23.715" class="difflineminus">-}</span>
<a href="#l23.716"></a><span id="l23.716" class="difflineminus">-</span>
<a href="#l23.717"></a><span id="l23.717" class="difflineminus">-static char *DIR_GetStringPref(const char *prefRoot, const char *prefLeaf,</span>
<a href="#l23.718"></a><span id="l23.718" class="difflineminus">-                               const char *defaultValue) {</span>
<a href="#l23.719"></a><span id="l23.719" class="difflineminus">-  nsresult rv;</span>
<a href="#l23.720"></a><span id="l23.720" class="difflineminus">-  nsCOMPtr&lt;nsIPrefBranch&gt; pPref(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l23.721"></a><span id="l23.721" class="difflineminus">-  if (NS_FAILED(rv)) return nullptr;</span>
<a href="#l23.722"></a><span id="l23.722" class="difflineminus">-</span>
<a href="#l23.723"></a><span id="l23.723" class="difflineminus">-  nsCString value;</span>
<a href="#l23.724"></a><span id="l23.724" class="difflineminus">-  nsAutoCString prefLocation(prefRoot);</span>
<a href="#l23.725"></a><span id="l23.725" class="difflineminus">-</span>
<a href="#l23.726"></a><span id="l23.726" class="difflineminus">-  prefLocation.Append('.');</span>
<a href="#l23.727"></a><span id="l23.727" class="difflineminus">-  prefLocation.Append(prefLeaf);</span>
<a href="#l23.728"></a><span id="l23.728" class="difflineminus">-</span>
<a href="#l23.729"></a><span id="l23.729" class="difflineminus">-  if (NS_SUCCEEDED(pPref-&gt;GetCharPref(prefLocation.get(), value))) {</span>
<a href="#l23.730"></a><span id="l23.730" class="difflineminus">-    /* unfortunately, there may be some prefs out there which look like this */</span>
<a href="#l23.731"></a><span id="l23.731" class="difflineminus">-    if (value.EqualsLiteral(&quot;(null)&quot;)) {</span>
<a href="#l23.732"></a><span id="l23.732" class="difflineminus">-      if (defaultValue)</span>
<a href="#l23.733"></a><span id="l23.733" class="difflineminus">-        value = defaultValue;</span>
<a href="#l23.734"></a><span id="l23.734" class="difflineminus">-      else</span>
<a href="#l23.735"></a><span id="l23.735" class="difflineminus">-        value.Truncate();</span>
<a href="#l23.736"></a><span id="l23.736" class="difflineminus">-    }</span>
<a href="#l23.737"></a><span id="l23.737" class="difflineminus">-</span>
<a href="#l23.738"></a><span id="l23.738" class="difflineminus">-    if (value.IsEmpty()) {</span>
<a href="#l23.739"></a><span id="l23.739" class="difflineminus">-      rv = pPref-&gt;GetCharPref(prefLocation.get(), value);</span>
<a href="#l23.740"></a><span id="l23.740" class="difflineminus">-    }</span>
<a href="#l23.741"></a><span id="l23.741" class="difflineminus">-  } else</span>
<a href="#l23.742"></a><span id="l23.742" class="difflineminus">-    value = defaultValue;</span>
<a href="#l23.743"></a><span id="l23.743" class="difflineminus">-</span>
<a href="#l23.744"></a><span id="l23.744" class="difflineminus">-  return ToNewCString(value);</span>
<a href="#l23.745"></a><span id="l23.745" class="difflineminus">-}</span>
<a href="#l23.746"></a><span id="l23.746" class="difflineminus">-</span>
<a href="#l23.747"></a><span id="l23.747" class="difflineminus">-/**</span>
<a href="#l23.748"></a><span id="l23.748" class="difflineminus">- * Get localized unicode string pref from properties file, convert into an UTF8</span>
<a href="#l23.749"></a><span id="l23.749" class="difflineminus">- * string since address book prefs store as UTF8 strings. So far there are 2</span>
<a href="#l23.750"></a><span id="l23.750" class="difflineminus">- * default prefs stored in addressbook.properties.</span>
<a href="#l23.751"></a><span id="l23.751" class="difflineminus">- * &quot;ldap_2.servers.pab.description&quot;</span>
<a href="#l23.752"></a><span id="l23.752" class="difflineminus">- * &quot;ldap_2.servers.history.description&quot;</span>
<a href="#l23.753"></a><span id="l23.753" class="difflineminus">- */</span>
<a href="#l23.754"></a><span id="l23.754" class="difflineminus">-static char *DIR_GetLocalizedStringPref(const char *prefRoot,</span>
<a href="#l23.755"></a><span id="l23.755" class="difflineminus">-                                        const char *prefLeaf) {</span>
<a href="#l23.756"></a><span id="l23.756" class="difflineminus">-  nsresult rv;</span>
<a href="#l23.757"></a><span id="l23.757" class="difflineminus">-  nsCOMPtr&lt;nsIPrefBranch&gt; pPref(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l23.758"></a><span id="l23.758" class="difflineminus">-</span>
<a href="#l23.759"></a><span id="l23.759" class="difflineminus">-  if (NS_FAILED(rv)) return nullptr;</span>
<a href="#l23.760"></a><span id="l23.760" class="difflineminus">-</span>
<a href="#l23.761"></a><span id="l23.761" class="difflineminus">-  nsAutoCString prefLocation(prefRoot);</span>
<a href="#l23.762"></a><span id="l23.762" class="difflineminus">-  if (prefLeaf) {</span>
<a href="#l23.763"></a><span id="l23.763" class="difflineminus">-    prefLocation.Append('.');</span>
<a href="#l23.764"></a><span id="l23.764" class="difflineminus">-    prefLocation.Append(prefLeaf);</span>
<a href="#l23.765"></a><span id="l23.765" class="difflineminus">-  }</span>
<a href="#l23.766"></a><span id="l23.766" class="difflineminus">-</span>
<a href="#l23.767"></a><span id="l23.767" class="difflineminus">-  nsString wvalue;</span>
<a href="#l23.768"></a><span id="l23.768" class="difflineminus">-  nsCOMPtr&lt;nsIPrefLocalizedString&gt; locStr;</span>
<a href="#l23.769"></a><span id="l23.769" class="difflineminus">-</span>
<a href="#l23.770"></a><span id="l23.770" class="difflineminus">-  rv = pPref-&gt;GetComplexValue(prefLocation.get(),</span>
<a href="#l23.771"></a><span id="l23.771" class="difflineminus">-                              NS_GET_IID(nsIPrefLocalizedString),</span>
<a href="#l23.772"></a><span id="l23.772" class="difflineminus">-                              getter_AddRefs(locStr));</span>
<a href="#l23.773"></a><span id="l23.773" class="difflineminus">-  if (NS_SUCCEEDED(rv)) rv = locStr-&gt;ToString(getter_Copies(wvalue));</span>
<a href="#l23.774"></a><span id="l23.774" class="difflineminus">-</span>
<a href="#l23.775"></a><span id="l23.775" class="difflineminus">-  nsCString value;</span>
<a href="#l23.776"></a><span id="l23.776" class="difflineminus">-  if (!wvalue.IsEmpty()) {</span>
<a href="#l23.777"></a><span id="l23.777" class="difflineminus">-    value = NS_ConvertUTF16toUTF8(wvalue);</span>
<a href="#l23.778"></a><span id="l23.778" class="difflineminus">-  } else {</span>
<a href="#l23.779"></a><span id="l23.779" class="difflineminus">-    // In TB 2 only some prefs had chrome:// URIs. We had code in place that</span>
<a href="#l23.780"></a><span id="l23.780" class="difflineminus">-    // would only get the localized string pref for the particular address books</span>
<a href="#l23.781"></a><span id="l23.781" class="difflineminus">-    // that were built-in. Additionally, nsIPrefBranch::getComplexValue will</span>
<a href="#l23.782"></a><span id="l23.782" class="difflineminus">-    // only get a non-user-set, non-locked pref value if it is a chrome:// URI</span>
<a href="#l23.783"></a><span id="l23.783" class="difflineminus">-    // and will get the string value at that chrome URI. This breaks</span>
<a href="#l23.784"></a><span id="l23.784" class="difflineminus">-    // extensions/autoconfig that want to set default pref values and allow</span>
<a href="#l23.785"></a><span id="l23.785" class="difflineminus">-    // users to change directory names.</span>
<a href="#l23.786"></a><span id="l23.786" class="difflineminus">-    //</span>
<a href="#l23.787"></a><span id="l23.787" class="difflineminus">-    // Now we have to support this, and so if for whatever reason we fail to get</span>
<a href="#l23.788"></a><span id="l23.788" class="difflineminus">-    // the localized version, then we try and get the non-localized version</span>
<a href="#l23.789"></a><span id="l23.789" class="difflineminus">-    // instead. If the string value is empty, then we'll just get the empty</span>
<a href="#l23.790"></a><span id="l23.790" class="difflineminus">-    // value back here.</span>
<a href="#l23.791"></a><span id="l23.791" class="difflineminus">-    rv = pPref-&gt;GetCharPref(prefLocation.get(), value);</span>
<a href="#l23.792"></a><span id="l23.792" class="difflineminus">-    if (NS_FAILED(rv)) value.Truncate();</span>
<a href="#l23.793"></a><span id="l23.793" class="difflineminus">-  }</span>
<a href="#l23.794"></a><span id="l23.794" class="difflineminus">-</span>
<a href="#l23.795"></a><span id="l23.795" class="difflineminus">-  return moz_xstrdup(value.get());</span>
<a href="#l23.796"></a><span id="l23.796" class="difflineminus">-}</span>
<a href="#l23.797"></a><span id="l23.797" class="difflineminus">-</span>
<a href="#l23.798"></a><span id="l23.798" class="difflineminus">-static int32_t DIR_GetIntPref(const char *prefRoot, const char *prefLeaf,</span>
<a href="#l23.799"></a><span id="l23.799" class="difflineminus">-                              int32_t defaultValue) {</span>
<a href="#l23.800"></a><span id="l23.800" class="difflineminus">-  nsresult rv;</span>
<a href="#l23.801"></a><span id="l23.801" class="difflineminus">-  nsCOMPtr&lt;nsIPrefBranch&gt; pPref(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l23.802"></a><span id="l23.802" class="difflineminus">-</span>
<a href="#l23.803"></a><span id="l23.803" class="difflineminus">-  if (NS_FAILED(rv)) return defaultValue;</span>
<a href="#l23.804"></a><span id="l23.804" class="difflineminus">-</span>
<a href="#l23.805"></a><span id="l23.805" class="difflineminus">-  int32_t value;</span>
<a href="#l23.806"></a><span id="l23.806" class="difflineminus">-  nsAutoCString prefLocation(prefRoot);</span>
<a href="#l23.807"></a><span id="l23.807" class="difflineminus">-</span>
<a href="#l23.808"></a><span id="l23.808" class="difflineminus">-  prefLocation.Append('.');</span>
<a href="#l23.809"></a><span id="l23.809" class="difflineminus">-  prefLocation.Append(prefLeaf);</span>
<a href="#l23.810"></a><span id="l23.810" class="difflineminus">-</span>
<a href="#l23.811"></a><span id="l23.811" class="difflineminus">-  if (NS_FAILED(pPref-&gt;GetIntPref(prefLocation.get(), &amp;value)))</span>
<a href="#l23.812"></a><span id="l23.812" class="difflineminus">-    value = defaultValue;</span>
<a href="#l23.813"></a><span id="l23.813" class="difflineminus">-</span>
<a href="#l23.814"></a><span id="l23.814" class="difflineminus">-  return value;</span>
<a href="#l23.815"></a><span id="l23.815" class="difflineminus">-}</span>
<a href="#l23.816"></a><span id="l23.816" class="difflineminus">-</span>
<a href="#l23.817"></a><span id="l23.817" class="difflineminus">-/* This will convert from the old preference that was a path and filename */</span>
<a href="#l23.818"></a><span id="l23.818" class="difflineminus">-/* to a just a filename */</span>
<a href="#l23.819"></a><span id="l23.819" class="difflineminus">-static void DIR_ConvertServerFileName(DIR_Server *pServer) {</span>
<a href="#l23.820"></a><span id="l23.820" class="difflineminus">-  char *leafName = pServer-&gt;fileName;</span>
<a href="#l23.821"></a><span id="l23.821" class="difflineminus">-  char *newLeafName = nullptr;</span>
<a href="#l23.822"></a><span id="l23.822" class="difflineminus">-#if defined(XP_WIN)</span>
<a href="#l23.823"></a><span id="l23.823" class="difflineminus">-  /* jefft -- bug 73349 This is to allow users share same address book.</span>
<a href="#l23.824"></a><span id="l23.824" class="difflineminus">-   * It only works if the user specify a full path filename.</span>
<a href="#l23.825"></a><span id="l23.825" class="difflineminus">-   */</span>
<a href="#l23.826"></a><span id="l23.826" class="difflineminus">-#  ifdef XP_FileIsFullPath</span>
<a href="#l23.827"></a><span id="l23.827" class="difflineminus">-  if (!XP_FileIsFullPath(leafName)) newLeafName = XP_STRRCHR(leafName, '\\');</span>
<a href="#l23.828"></a><span id="l23.828" class="difflineminus">-#  endif /* XP_FileIsFullPath */</span>
<a href="#l23.829"></a><span id="l23.829" class="difflineminus">-#else</span>
<a href="#l23.830"></a><span id="l23.830" class="difflineminus">-  newLeafName = strrchr(leafName, '/');</span>
<a href="#l23.831"></a><span id="l23.831" class="difflineminus">-#endif</span>
<a href="#l23.832"></a><span id="l23.832" class="difflineminus">-  pServer-&gt;fileName = newLeafName ? strdup(newLeafName + 1) : strdup(leafName);</span>
<a href="#l23.833"></a><span id="l23.833" class="difflineminus">-  if (leafName) PR_Free(leafName);</span>
<a href="#l23.834"></a><span id="l23.834" class="difflineminus">-}</span>
<a href="#l23.835"></a><span id="l23.835" class="difflineminus">-</span>
<a href="#l23.836"></a><span id="l23.836" class="difflineminus">-/* This will generate a correct filename and then remove the path.</span>
<a href="#l23.837"></a><span id="l23.837" class="difflineminus">- * Note: we are assuming that the default name is in the native</span>
<a href="#l23.838"></a><span id="l23.838" class="difflineminus">- * filesystem charset. The filename will be returned as a UTF8</span>
<a href="#l23.839"></a><span id="l23.839" class="difflineminus">- * string.</span>
<a href="#l23.840"></a><span id="l23.840" class="difflineminus">- */</span>
<a href="#l23.841"></a><span id="l23.841" class="difflineminus">-void DIR_SetFileName(char **fileName, const char *defaultName) {</span>
<a href="#l23.842"></a><span id="l23.842" class="difflineminus">-  if (!fileName) return;</span>
<a href="#l23.843"></a><span id="l23.843" class="difflineminus">-</span>
<a href="#l23.844"></a><span id="l23.844" class="difflineminus">-  nsCOMPtr&lt;nsIFile&gt; dbPath;</span>
<a href="#l23.845"></a><span id="l23.845" class="difflineminus">-  nsresult rv = NS_GetSpecialDirectory(NS_APP_USER_PROFILE_50_DIR,</span>
<a href="#l23.846"></a><span id="l23.846" class="difflineminus">-                                       getter_AddRefs(dbPath));</span>
<a href="#l23.847"></a><span id="l23.847" class="difflineminus">-</span>
<a href="#l23.848"></a><span id="l23.848" class="difflineminus">-  *fileName = nullptr;</span>
<a href="#l23.849"></a><span id="l23.849" class="difflineminus">-</span>
<a href="#l23.850"></a><span id="l23.850" class="difflineminus">-  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l23.851"></a><span id="l23.851" class="difflineminus">-    rv = dbPath-&gt;AppendNative(nsDependentCString(defaultName));</span>
<a href="#l23.852"></a><span id="l23.852" class="difflineminus">-    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l23.853"></a><span id="l23.853" class="difflineminus">-      rv = dbPath-&gt;CreateUnique(nsIFile::NORMAL_FILE_TYPE, 0664);</span>
<a href="#l23.854"></a><span id="l23.854" class="difflineminus">-</span>
<a href="#l23.855"></a><span id="l23.855" class="difflineminus">-      nsAutoString realFileName;</span>
<a href="#l23.856"></a><span id="l23.856" class="difflineminus">-      rv = dbPath-&gt;GetLeafName(realFileName);</span>
<a href="#l23.857"></a><span id="l23.857" class="difflineminus">-</span>
<a href="#l23.858"></a><span id="l23.858" class="difflineminus">-      if (NS_SUCCEEDED(rv)) *fileName = ToNewUTF8String(realFileName);</span>
<a href="#l23.859"></a><span id="l23.859" class="difflineminus">-    }</span>
<a href="#l23.860"></a><span id="l23.860" class="difflineminus">-  }</span>
<a href="#l23.861"></a><span id="l23.861" class="difflineminus">-}</span>
<a href="#l23.862"></a><span id="l23.862" class="difflineminus">-</span>
<a href="#l23.863"></a><span id="l23.863" class="difflineminus">-/****************************************************************</span>
<a href="#l23.864"></a><span id="l23.864" class="difflineminus">-Helper function used to generate a file name from the description</span>
<a href="#l23.865"></a><span id="l23.865" class="difflineminus">-of a directory. Caller must free returned string.</span>
<a href="#l23.866"></a><span id="l23.866" class="difflineminus">-An extension is not applied</span>
<a href="#l23.867"></a><span id="l23.867" class="difflineminus">-*****************************************************************/</span>
<a href="#l23.868"></a><span id="l23.868" class="difflineminus">-</span>
<a href="#l23.869"></a><span id="l23.869" class="difflineminus">-static char *dir_ConvertDescriptionToPrefName(DIR_Server *server) {</span>
<a href="#l23.870"></a><span id="l23.870" class="difflineminus">-#define MAX_PREF_NAME_SIZE 25</span>
<a href="#l23.871"></a><span id="l23.871" class="difflineminus">-  char *fileName = nullptr;</span>
<a href="#l23.872"></a><span id="l23.872" class="difflineminus">-  char fileNameBuf[MAX_PREF_NAME_SIZE];</span>
<a href="#l23.873"></a><span id="l23.873" class="difflineminus">-  int32_t srcIndex = 0;</span>
<a href="#l23.874"></a><span id="l23.874" class="difflineminus">-  int32_t destIndex = 0;</span>
<a href="#l23.875"></a><span id="l23.875" class="difflineminus">-  int32_t numSrcBytes = 0;</span>
<a href="#l23.876"></a><span id="l23.876" class="difflineminus">-  const char *descr = nullptr;</span>
<a href="#l23.877"></a><span id="l23.877" class="difflineminus">-  if (server &amp;&amp; server-&gt;description) {</span>
<a href="#l23.878"></a><span id="l23.878" class="difflineminus">-    descr = server-&gt;description;</span>
<a href="#l23.879"></a><span id="l23.879" class="difflineminus">-    numSrcBytes = PL_strlen(descr);</span>
<a href="#l23.880"></a><span id="l23.880" class="difflineminus">-    while (srcIndex &lt; numSrcBytes &amp;&amp; destIndex &lt; MAX_PREF_NAME_SIZE - 1) {</span>
<a href="#l23.881"></a><span id="l23.881" class="difflineminus">-      if (IS_DIGIT(descr[srcIndex]) || IS_ALPHA(descr[srcIndex])) {</span>
<a href="#l23.882"></a><span id="l23.882" class="difflineminus">-        fileNameBuf[destIndex] = descr[srcIndex];</span>
<a href="#l23.883"></a><span id="l23.883" class="difflineminus">-        destIndex++;</span>
<a href="#l23.884"></a><span id="l23.884" class="difflineminus">-      }</span>
<a href="#l23.885"></a><span id="l23.885" class="difflineminus">-</span>
<a href="#l23.886"></a><span id="l23.886" class="difflineminus">-      srcIndex++;</span>
<a href="#l23.887"></a><span id="l23.887" class="difflineminus">-    }</span>
<a href="#l23.888"></a><span id="l23.888" class="difflineminus">-</span>
<a href="#l23.889"></a><span id="l23.889" class="difflineminus">-    fileNameBuf[destIndex] = '\0'; /* zero out the last character */</span>
<a href="#l23.890"></a><span id="l23.890" class="difflineminus">-  }</span>
<a href="#l23.891"></a><span id="l23.891" class="difflineminus">-</span>
<a href="#l23.892"></a><span id="l23.892" class="difflineminus">-  if (destIndex) /* have at least one character in the file name? */</span>
<a href="#l23.893"></a><span id="l23.893" class="difflineminus">-    fileName = strdup(fileNameBuf);</span>
<a href="#l23.894"></a><span id="l23.894" class="difflineminus">-</span>
<a href="#l23.895"></a><span id="l23.895" class="difflineminus">-  return fileName;</span>
<a href="#l23.896"></a><span id="l23.896" class="difflineminus">-}</span>
<a href="#l23.897"></a><span id="l23.897" class="difflineminus">-</span>
<a href="#l23.898"></a><span id="l23.898" class="difflineminus">-void DIR_SetServerFileName(DIR_Server *server) {</span>
<a href="#l23.899"></a><span id="l23.899" class="difflineminus">-  char *tempName = nullptr;</span>
<a href="#l23.900"></a><span id="l23.900" class="difflineminus">-  const char *prefName = nullptr;</span>
<a href="#l23.901"></a><span id="l23.901" class="difflineminus">-  uint32_t numHeaderBytes = 0;</span>
<a href="#l23.902"></a><span id="l23.902" class="difflineminus">-</span>
<a href="#l23.903"></a><span id="l23.903" class="difflineminus">-  if (server &amp;&amp; (!server-&gt;fileName || !(*server-&gt;fileName))) {</span>
<a href="#l23.904"></a><span id="l23.904" class="difflineminus">-    PR_FREEIF(server-&gt;fileName);  // might be one byte empty string.</span>
<a href="#l23.905"></a><span id="l23.905" class="difflineminus">-    /* make sure we have a pref name...*/</span>
<a href="#l23.906"></a><span id="l23.906" class="difflineminus">-    if (!server-&gt;prefName || !*server-&gt;prefName)</span>
<a href="#l23.907"></a><span id="l23.907" class="difflineminus">-      server-&gt;prefName = dir_CreateServerPrefName(server);</span>
<a href="#l23.908"></a><span id="l23.908" class="difflineminus">-</span>
<a href="#l23.909"></a><span id="l23.909" class="difflineminus">-    /* set default personal address book file name*/</span>
<a href="#l23.910"></a><span id="l23.910" class="difflineminus">-    if ((server-&gt;position == 1) &amp;&amp; (server-&gt;dirType == JSDirectory))</span>
<a href="#l23.911"></a><span id="l23.911" class="difflineminus">-      server-&gt;fileName = strdup(kPersonalAddressbook);</span>
<a href="#l23.912"></a><span id="l23.912" class="difflineminus">-    else {</span>
<a href="#l23.913"></a><span id="l23.913" class="difflineminus">-      /* now use the pref name as the file name since we know the pref name</span>
<a href="#l23.914"></a><span id="l23.914" class="difflineminus">-         will be unique */</span>
<a href="#l23.915"></a><span id="l23.915" class="difflineminus">-      prefName = server-&gt;prefName;</span>
<a href="#l23.916"></a><span id="l23.916" class="difflineminus">-      if (prefName &amp;&amp; *prefName) {</span>
<a href="#l23.917"></a><span id="l23.917" class="difflineminus">-        /* extract just the pref name part and not the ldap tree name portion</span>
<a href="#l23.918"></a><span id="l23.918" class="difflineminus">-         * from the string */</span>
<a href="#l23.919"></a><span id="l23.919" class="difflineminus">-        numHeaderBytes = PL_strlen(PREF_LDAP_SERVER_TREE_NAME) +</span>
<a href="#l23.920"></a><span id="l23.920" class="difflineminus">-                         1; /* + 1 for the '.' b4 the name */</span>
<a href="#l23.921"></a><span id="l23.921" class="difflineminus">-        if (PL_strlen(prefName) &gt; numHeaderBytes)</span>
<a href="#l23.922"></a><span id="l23.922" class="difflineminus">-          tempName = strdup(prefName + numHeaderBytes);</span>
<a href="#l23.923"></a><span id="l23.923" class="difflineminus">-</span>
<a href="#l23.924"></a><span id="l23.924" class="difflineminus">-        if (tempName) {</span>
<a href="#l23.925"></a><span id="l23.925" class="difflineminus">-          server-&gt;fileName =</span>
<a href="#l23.926"></a><span id="l23.926" class="difflineminus">-              PR_smprintf(&quot;%s%s&quot;, tempName, kABFileName_CurrentSuffix);</span>
<a href="#l23.927"></a><span id="l23.927" class="difflineminus">-          PR_Free(tempName);</span>
<a href="#l23.928"></a><span id="l23.928" class="difflineminus">-        }</span>
<a href="#l23.929"></a><span id="l23.929" class="difflineminus">-      }</span>
<a href="#l23.930"></a><span id="l23.930" class="difflineminus">-    }</span>
<a href="#l23.931"></a><span id="l23.931" class="difflineminus">-</span>
<a href="#l23.932"></a><span id="l23.932" class="difflineminus">-    if (!server-&gt;fileName || !*server-&gt;fileName) /* when all else has failed,</span>
<a href="#l23.933"></a><span id="l23.933" class="difflineminus">-                                                    generate a default name */</span>
<a href="#l23.934"></a><span id="l23.934" class="difflineminus">-    {</span>
<a href="#l23.935"></a><span id="l23.935" class="difflineminus">-      if (server-&gt;dirType == LDAPDirectory) {</span>
<a href="#l23.936"></a><span id="l23.936" class="difflineminus">-        DIR_SetFileName(</span>
<a href="#l23.937"></a><span id="l23.937" class="difflineminus">-            &amp;(server-&gt;fileName),</span>
<a href="#l23.938"></a><span id="l23.938" class="difflineminus">-            kMainLdapAddressBook); /* generates file name with an ldap prefix */</span>
<a href="#l23.939"></a><span id="l23.939" class="difflineminus">-      } else {</span>
<a href="#l23.940"></a><span id="l23.940" class="difflineminus">-        DIR_SetFileName(&amp;(server-&gt;fileName), kPersonalAddressbook);</span>
<a href="#l23.941"></a><span id="l23.941" class="difflineminus">-      }</span>
<a href="#l23.942"></a><span id="l23.942" class="difflineminus">-    }</span>
<a href="#l23.943"></a><span id="l23.943" class="difflineminus">-  }</span>
<a href="#l23.944"></a><span id="l23.944" class="difflineminus">-}</span>
<a href="#l23.945"></a><span id="l23.945" class="difflineminus">-</span>
<a href="#l23.946"></a><span id="l23.946" class="difflineminus">-static char *dir_CreateServerPrefName(DIR_Server *server) {</span>
<a href="#l23.947"></a><span id="l23.947" class="difflineminus">-  /* we are going to try to be smart in how we generate our server</span>
<a href="#l23.948"></a><span id="l23.948" class="difflineminus">-     pref name. We'll try to convert the description into a pref name</span>
<a href="#l23.949"></a><span id="l23.949" class="difflineminus">-     and then verify that it is unique. If it is unique then use it... */</span>
<a href="#l23.950"></a><span id="l23.950" class="difflineminus">-  char *leafName = dir_ConvertDescriptionToPrefName(server);</span>
<a href="#l23.951"></a><span id="l23.951" class="difflineminus">-  char *prefName = nullptr;</span>
<a href="#l23.952"></a><span id="l23.952" class="difflineminus">-  bool isUnique = false;</span>
<a href="#l23.953"></a><span id="l23.953" class="difflineminus">-</span>
<a href="#l23.954"></a><span id="l23.954" class="difflineminus">-  if (!leafName || !*leafName) {</span>
<a href="#l23.955"></a><span id="l23.955" class="difflineminus">-    // we need to handle this in case the description has no alphanumeric chars</span>
<a href="#l23.956"></a><span id="l23.956" class="difflineminus">-    // it's very common for cjk users</span>
<a href="#l23.957"></a><span id="l23.957" class="difflineminus">-    leafName = strdup(&quot;_nonascii&quot;);</span>
<a href="#l23.958"></a><span id="l23.958" class="difflineminus">-  }</span>
<a href="#l23.959"></a><span id="l23.959" class="difflineminus">-</span>
<a href="#l23.960"></a><span id="l23.960" class="difflineminus">-  if (leafName) {</span>
<a href="#l23.961"></a><span id="l23.961" class="difflineminus">-    int32_t uniqueIDCnt = 0;</span>
<a href="#l23.962"></a><span id="l23.962" class="difflineminus">-    nsTArray&lt;nsCString&gt; children;</span>
<a href="#l23.963"></a><span id="l23.963" class="difflineminus">-    /* we need to verify that this pref string name is unique */</span>
<a href="#l23.964"></a><span id="l23.964" class="difflineminus">-    prefName = PR_smprintf(PREF_LDAP_SERVER_TREE_NAME &quot;.%s&quot;, leafName);</span>
<a href="#l23.965"></a><span id="l23.965" class="difflineminus">-    isUnique = false;</span>
<a href="#l23.966"></a><span id="l23.966" class="difflineminus">-    nsresult rv = dir_GetChildList(</span>
<a href="#l23.967"></a><span id="l23.967" class="difflineminus">-        NS_LITERAL_CSTRING(PREF_LDAP_SERVER_TREE_NAME &quot;.&quot;), children);</span>
<a href="#l23.968"></a><span id="l23.968" class="difflineminus">-    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l23.969"></a><span id="l23.969" class="difflineminus">-      while (!isUnique &amp;&amp; prefName) {</span>
<a href="#l23.970"></a><span id="l23.970" class="difflineminus">-        isUnique = true; /* now flip the logic and assume we are unique until we</span>
<a href="#l23.971"></a><span id="l23.971" class="difflineminus">-                            find a match */</span>
<a href="#l23.972"></a><span id="l23.972" class="difflineminus">-        for (auto &amp;child : children) {</span>
<a href="#l23.973"></a><span id="l23.973" class="difflineminus">-          if (child.EqualsIgnoreCase(</span>
<a href="#l23.974"></a><span id="l23.974" class="difflineminus">-                  prefName)) { /* are they the same branch? */</span>
<a href="#l23.975"></a><span id="l23.975" class="difflineminus">-            isUnique = false;</span>
<a href="#l23.976"></a><span id="l23.976" class="difflineminus">-            break;</span>
<a href="#l23.977"></a><span id="l23.977" class="difflineminus">-          }</span>
<a href="#l23.978"></a><span id="l23.978" class="difflineminus">-        }</span>
<a href="#l23.979"></a><span id="l23.979" class="difflineminus">-        if (!isUnique) /* then try generating a new pref name and try again */</span>
<a href="#l23.980"></a><span id="l23.980" class="difflineminus">-        {</span>
<a href="#l23.981"></a><span id="l23.981" class="difflineminus">-          PR_smprintf_free(prefName);</span>
<a href="#l23.982"></a><span id="l23.982" class="difflineminus">-          prefName = PR_smprintf(PREF_LDAP_SERVER_TREE_NAME &quot;.%s_%d&quot;, leafName,</span>
<a href="#l23.983"></a><span id="l23.983" class="difflineminus">-                                 ++uniqueIDCnt);</span>
<a href="#l23.984"></a><span id="l23.984" class="difflineminus">-        }</span>
<a href="#l23.985"></a><span id="l23.985" class="difflineminus">-      } /* if we have a list of pref Names */</span>
<a href="#l23.986"></a><span id="l23.986" class="difflineminus">-    }   /* while we don't have a unique name */</span>
<a href="#l23.987"></a><span id="l23.987" class="difflineminus">-</span>
<a href="#l23.988"></a><span id="l23.988" class="difflineminus">-    // fallback to &quot;user_directory_N&quot; form if we failed to verify</span>
<a href="#l23.989"></a><span id="l23.989" class="difflineminus">-    if (!isUnique &amp;&amp; prefName) {</span>
<a href="#l23.990"></a><span id="l23.990" class="difflineminus">-      PR_smprintf_free(prefName);</span>
<a href="#l23.991"></a><span id="l23.991" class="difflineminus">-      prefName = nullptr;</span>
<a href="#l23.992"></a><span id="l23.992" class="difflineminus">-    }</span>
<a href="#l23.993"></a><span id="l23.993" class="difflineminus">-</span>
<a href="#l23.994"></a><span id="l23.994" class="difflineminus">-    PR_Free(leafName);</span>
<a href="#l23.995"></a><span id="l23.995" class="difflineminus">-</span>
<a href="#l23.996"></a><span id="l23.996" class="difflineminus">-  } /* if leafName */</span>
<a href="#l23.997"></a><span id="l23.997" class="difflineminus">-</span>
<a href="#l23.998"></a><span id="l23.998" class="difflineminus">-  if (!prefName) /* last resort if we still don't have a pref name is to use</span>
<a href="#l23.999"></a><span id="l23.999" class="difflineminus">-                    user_directory string */</span>
<a href="#l23.1000"></a><span id="l23.1000" class="difflineminus">-    return PR_smprintf(PREF_LDAP_SERVER_TREE_NAME &quot;.user_directory_%d&quot;,</span>
<a href="#l23.1001"></a><span id="l23.1001" class="difflineminus">-                       ++dir_UserId);</span>
<a href="#l23.1002"></a><span id="l23.1002" class="difflineminus">-  else</span>
<a href="#l23.1003"></a><span id="l23.1003" class="difflineminus">-    return prefName;</span>
<a href="#l23.1004"></a><span id="l23.1004" class="difflineminus">-}</span>
<a href="#l23.1005"></a><span id="l23.1005" class="difflineminus">-</span>
<a href="#l23.1006"></a><span id="l23.1006" class="difflineminus">-static void DIR_GetPrefsForOneServer(DIR_Server *server) {</span>
<a href="#l23.1007"></a><span id="l23.1007" class="difflineminus">-  nsresult rv;</span>
<a href="#l23.1008"></a><span id="l23.1008" class="difflineminus">-  nsCOMPtr&lt;nsIPrefBranch&gt; pPref(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l23.1009"></a><span id="l23.1009" class="difflineminus">-  if (NS_FAILED(rv)) return;</span>
<a href="#l23.1010"></a><span id="l23.1010" class="difflineminus">-</span>
<a href="#l23.1011"></a><span id="l23.1011" class="difflineminus">-  char *prefstring = server-&gt;prefName;</span>
<a href="#l23.1012"></a><span id="l23.1012" class="difflineminus">-</span>
<a href="#l23.1013"></a><span id="l23.1013" class="difflineminus">-  // this call fills in tempstring with the position pref, and</span>
<a href="#l23.1014"></a><span id="l23.1014" class="difflineminus">-  // we then check to see if it's locked.</span>
<a href="#l23.1015"></a><span id="l23.1015" class="difflineminus">-  server-&gt;position = DIR_GetIntPref(prefstring, &quot;position&quot;, kDefaultPosition);</span>
<a href="#l23.1016"></a><span id="l23.1016" class="difflineminus">-</span>
<a href="#l23.1017"></a><span id="l23.1017" class="difflineminus">-  // For default address books, this will get the name from the chrome</span>
<a href="#l23.1018"></a><span id="l23.1018" class="difflineminus">-  // file referenced, for other address books it'll just retrieve it from prefs</span>
<a href="#l23.1019"></a><span id="l23.1019" class="difflineminus">-  // as normal.</span>
<a href="#l23.1020"></a><span id="l23.1020" class="difflineminus">-  server-&gt;description = DIR_GetLocalizedStringPref(prefstring, &quot;description&quot;);</span>
<a href="#l23.1021"></a><span id="l23.1021" class="difflineminus">-</span>
<a href="#l23.1022"></a><span id="l23.1022" class="difflineminus">-  server-&gt;dirType =</span>
<a href="#l23.1023"></a><span id="l23.1023" class="difflineminus">-      (DirectoryType)DIR_GetIntPref(prefstring, &quot;dirType&quot;, LDAPDirectory);</span>
<a href="#l23.1024"></a><span id="l23.1024" class="difflineminus">-</span>
<a href="#l23.1025"></a><span id="l23.1025" class="difflineminus">-  server-&gt;fileName = DIR_GetStringPref(prefstring, &quot;filename&quot;, &quot;&quot;);</span>
<a href="#l23.1026"></a><span id="l23.1026" class="difflineminus">-  // if we don't have a file name try and get one</span>
<a href="#l23.1027"></a><span id="l23.1027" class="difflineminus">-  if (!server-&gt;fileName || !*(server-&gt;fileName)) DIR_SetServerFileName(server);</span>
<a href="#l23.1028"></a><span id="l23.1028" class="difflineminus">-  if (server-&gt;fileName &amp;&amp; *server-&gt;fileName) DIR_ConvertServerFileName(server);</span>
<a href="#l23.1029"></a><span id="l23.1029" class="difflineminus">-</span>
<a href="#l23.1030"></a><span id="l23.1030" class="difflineminus">-  // the string &quot;s&quot; is the default uri ( &lt;scheme&gt; + &quot;://&quot; + &lt;filename&gt; )</span>
<a href="#l23.1031"></a><span id="l23.1031" class="difflineminus">-  nsCString s;</span>
<a href="#l23.1032"></a><span id="l23.1032" class="difflineminus">-  switch (server-&gt;dirType) {</span>
<a href="#l23.1033"></a><span id="l23.1033" class="difflineminus">-    case PABDirectory:</span>
<a href="#l23.1034"></a><span id="l23.1034" class="difflineminus">-    case MAPIDirectory:</span>
<a href="#l23.1035"></a><span id="l23.1035" class="difflineminus">-    case JSDirectory:</span>
<a href="#l23.1036"></a><span id="l23.1036" class="difflineminus">-      s = kJSDirectoryRoot;</span>
<a href="#l23.1037"></a><span id="l23.1037" class="difflineminus">-      break;</span>
<a href="#l23.1038"></a><span id="l23.1038" class="difflineminus">-    default:</span>
<a href="#l23.1039"></a><span id="l23.1039" class="difflineminus">-#if defined(MOZ_LDAP_XPCOM)</span>
<a href="#l23.1040"></a><span id="l23.1040" class="difflineminus">-      s = kLDAPDirectoryRoot;</span>
<a href="#l23.1041"></a><span id="l23.1041" class="difflineminus">-#else</span>
<a href="#l23.1042"></a><span id="l23.1042" class="difflineminus">-      // Fallback to the all directory root in the non-ldap enabled case.</span>
<a href="#l23.1043"></a><span id="l23.1043" class="difflineminus">-      s = kAllDirectoryRoot;</span>
<a href="#l23.1044"></a><span id="l23.1044" class="difflineminus">-#endif</span>
<a href="#l23.1045"></a><span id="l23.1045" class="difflineminus">-      break;</span>
<a href="#l23.1046"></a><span id="l23.1046" class="difflineminus">-  }</span>
<a href="#l23.1047"></a><span id="l23.1047" class="difflineminus">-  s.Append(server-&gt;fileName);</span>
<a href="#l23.1048"></a><span id="l23.1048" class="difflineminus">-  server-&gt;uri = DIR_GetStringPref(prefstring, &quot;uri&quot;, s.get());</span>
<a href="#l23.1049"></a><span id="l23.1049" class="difflineminus">-}</span>
<a href="#l23.1050"></a><span id="l23.1050" class="difflineminus">-</span>
<a href="#l23.1051"></a><span id="l23.1051" class="difflineminus">-static nsresult dir_GetPrefs(nsTArray&lt;DIR_Server *&gt; **list) {</span>
<a href="#l23.1052"></a><span id="l23.1052" class="difflineminus">-  nsresult rv;</span>
<a href="#l23.1053"></a><span id="l23.1053" class="difflineminus">-  nsCOMPtr&lt;nsIPrefBranch&gt; pPref(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l23.1054"></a><span id="l23.1054" class="difflineminus">-  if (NS_FAILED(rv)) return rv;</span>
<a href="#l23.1055"></a><span id="l23.1055" class="difflineminus">-</span>
<a href="#l23.1056"></a><span id="l23.1056" class="difflineminus">-  (*list) = new nsTArray&lt;DIR_Server *&gt;();</span>
<a href="#l23.1057"></a><span id="l23.1057" class="difflineminus">-  if (!(*list)) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l23.1058"></a><span id="l23.1058" class="difflineminus">-</span>
<a href="#l23.1059"></a><span id="l23.1059" class="difflineminus">-  nsTArray&lt;nsCString&gt; children;</span>
<a href="#l23.1060"></a><span id="l23.1060" class="difflineminus">-</span>
<a href="#l23.1061"></a><span id="l23.1061" class="difflineminus">-  rv = dir_GetChildList(NS_LITERAL_CSTRING(PREF_LDAP_SERVER_TREE_NAME &quot;.&quot;),</span>
<a href="#l23.1062"></a><span id="l23.1062" class="difflineminus">-                        children);</span>
<a href="#l23.1063"></a><span id="l23.1063" class="difflineminus">-  if (NS_FAILED(rv)) return rv;</span>
<a href="#l23.1064"></a><span id="l23.1064" class="difflineminus">-</span>
<a href="#l23.1065"></a><span id="l23.1065" class="difflineminus">-  /* TBD: Temporary code to read broken &quot;ldap&quot; preferences tree.</span>
<a href="#l23.1066"></a><span id="l23.1066" class="difflineminus">-   *      Remove line with if statement after M10.</span>
<a href="#l23.1067"></a><span id="l23.1067" class="difflineminus">-   */</span>
<a href="#l23.1068"></a><span id="l23.1068" class="difflineminus">-  if (dir_UserId == 0)</span>
<a href="#l23.1069"></a><span id="l23.1069" class="difflineminus">-    pPref-&gt;GetIntPref(PREF_LDAP_GLOBAL_TREE_NAME &quot;.user_id&quot;, &amp;dir_UserId);</span>
<a href="#l23.1070"></a><span id="l23.1070" class="difflineminus">-</span>
<a href="#l23.1071"></a><span id="l23.1071" class="difflineminus">-  for (auto &amp;child : children) {</span>
<a href="#l23.1072"></a><span id="l23.1072" class="difflineminus">-    DIR_Server *server;</span>
<a href="#l23.1073"></a><span id="l23.1073" class="difflineminus">-</span>
<a href="#l23.1074"></a><span id="l23.1074" class="difflineminus">-    server = (DIR_Server *)PR_Calloc(1, sizeof(DIR_Server));</span>
<a href="#l23.1075"></a><span id="l23.1075" class="difflineminus">-    if (server) {</span>
<a href="#l23.1076"></a><span id="l23.1076" class="difflineminus">-      DIR_InitServer(server);</span>
<a href="#l23.1077"></a><span id="l23.1077" class="difflineminus">-      server-&gt;prefName = strdup(child.get());</span>
<a href="#l23.1078"></a><span id="l23.1078" class="difflineminus">-      DIR_GetPrefsForOneServer(server);</span>
<a href="#l23.1079"></a><span id="l23.1079" class="difflineminus">-      if (server-&gt;description &amp;&amp; server-&gt;description[0] &amp;&amp;</span>
<a href="#l23.1080"></a><span id="l23.1080" class="difflineminus">-          ((server-&gt;dirType == PABDirectory ||</span>
<a href="#l23.1081"></a><span id="l23.1081" class="difflineminus">-            server-&gt;dirType == MAPIDirectory ||</span>
<a href="#l23.1082"></a><span id="l23.1082" class="difflineminus">-            server-&gt;dirType == JSDirectory ||</span>
<a href="#l23.1083"></a><span id="l23.1083" class="difflineminus">-            server-&gt;dirType ==</span>
<a href="#l23.1084"></a><span id="l23.1084" class="difflineminus">-                FixedQueryLDAPDirectory ||  // this one might go away</span>
<a href="#l23.1085"></a><span id="l23.1085" class="difflineminus">-            server-&gt;dirType == LDAPDirectory))) {</span>
<a href="#l23.1086"></a><span id="l23.1086" class="difflineminus">-        if (!dir_IsServerDeleted(server)) {</span>
<a href="#l23.1087"></a><span id="l23.1087" class="difflineminus">-          (*list)-&gt;AppendElement(server);</span>
<a href="#l23.1088"></a><span id="l23.1088" class="difflineminus">-        } else</span>
<a href="#l23.1089"></a><span id="l23.1089" class="difflineminus">-          DIR_DeleteServer(server);</span>
<a href="#l23.1090"></a><span id="l23.1090" class="difflineminus">-      } else {</span>
<a href="#l23.1091"></a><span id="l23.1091" class="difflineminus">-        DIR_DeleteServer(server);</span>
<a href="#l23.1092"></a><span id="l23.1092" class="difflineminus">-      }</span>
<a href="#l23.1093"></a><span id="l23.1093" class="difflineminus">-    }</span>
<a href="#l23.1094"></a><span id="l23.1094" class="difflineminus">-  }</span>
<a href="#l23.1095"></a><span id="l23.1095" class="difflineminus">-</span>
<a href="#l23.1096"></a><span id="l23.1096" class="difflineminus">-  return NS_OK;</span>
<a href="#l23.1097"></a><span id="l23.1097" class="difflineminus">-}</span>
<a href="#l23.1098"></a><span id="l23.1098" class="difflineminus">-</span>
<a href="#l23.1099"></a><span id="l23.1099" class="difflineminus">-// I don't think we care about locked positions, etc.</span>
<a href="#l23.1100"></a><span id="l23.1100" class="difflineminus">-void DIR_SortServersByPosition(nsTArray&lt;DIR_Server *&gt; *serverList) {</span>
<a href="#l23.1101"></a><span id="l23.1101" class="difflineminus">-  int i, j;</span>
<a href="#l23.1102"></a><span id="l23.1102" class="difflineminus">-  DIR_Server *server;</span>
<a href="#l23.1103"></a><span id="l23.1103" class="difflineminus">-</span>
<a href="#l23.1104"></a><span id="l23.1104" class="difflineminus">-  int count = serverList-&gt;Length();</span>
<a href="#l23.1105"></a><span id="l23.1105" class="difflineminus">-  for (i = 0; i &lt; count - 1; i++) {</span>
<a href="#l23.1106"></a><span id="l23.1106" class="difflineminus">-    for (j = i + 1; j &lt; count; j++) {</span>
<a href="#l23.1107"></a><span id="l23.1107" class="difflineminus">-      if (serverList-&gt;ElementAt(j)-&gt;position &lt;</span>
<a href="#l23.1108"></a><span id="l23.1108" class="difflineminus">-          serverList-&gt;ElementAt(i)-&gt;position) {</span>
<a href="#l23.1109"></a><span id="l23.1109" class="difflineminus">-        server = serverList-&gt;ElementAt(i);</span>
<a href="#l23.1110"></a><span id="l23.1110" class="difflineminus">-        serverList-&gt;ReplaceElementAt(i, serverList-&gt;ElementAt(j));</span>
<a href="#l23.1111"></a><span id="l23.1111" class="difflineminus">-        serverList-&gt;ReplaceElementAt(j, server);</span>
<a href="#l23.1112"></a><span id="l23.1112" class="difflineminus">-      }</span>
<a href="#l23.1113"></a><span id="l23.1113" class="difflineminus">-    }</span>
<a href="#l23.1114"></a><span id="l23.1114" class="difflineminus">-  }</span>
<a href="#l23.1115"></a><span id="l23.1115" class="difflineminus">-}</span>
<a href="#l23.1116"></a><span id="l23.1116" class="difflineminus">-</span>
<a href="#l23.1117"></a><span id="l23.1117" class="difflineminus">-static nsresult DIR_GetServerPreferences(nsTArray&lt;DIR_Server *&gt; **list) {</span>
<a href="#l23.1118"></a><span id="l23.1118" class="difflineminus">-  nsresult err;</span>
<a href="#l23.1119"></a><span id="l23.1119" class="difflineminus">-  nsCOMPtr&lt;nsIPrefBranch&gt; pPref(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;err));</span>
<a href="#l23.1120"></a><span id="l23.1120" class="difflineminus">-  if (NS_FAILED(err)) return err;</span>
<a href="#l23.1121"></a><span id="l23.1121" class="difflineminus">-</span>
<a href="#l23.1122"></a><span id="l23.1122" class="difflineminus">-  int32_t version = -1;</span>
<a href="#l23.1123"></a><span id="l23.1123" class="difflineminus">-  nsTArray&lt;DIR_Server *&gt; *newList = nullptr;</span>
<a href="#l23.1124"></a><span id="l23.1124" class="difflineminus">-</span>
<a href="#l23.1125"></a><span id="l23.1125" class="difflineminus">-  /* Update the ldap list version and see if there are old prefs to migrate. */</span>
<a href="#l23.1126"></a><span id="l23.1126" class="difflineminus">-  err = pPref-&gt;GetIntPref(PREF_LDAP_VERSION_NAME, &amp;version);</span>
<a href="#l23.1127"></a><span id="l23.1127" class="difflineminus">-  NS_ENSURE_SUCCESS(err, err);</span>
<a href="#l23.1128"></a><span id="l23.1128" class="difflineminus">-</span>
<a href="#l23.1129"></a><span id="l23.1129" class="difflineminus">-  /* Find the new-style &quot;ldap_2.servers&quot; tree in prefs */</span>
<a href="#l23.1130"></a><span id="l23.1130" class="difflineminus">-  err = dir_GetPrefs(&amp;newList);</span>
<a href="#l23.1131"></a><span id="l23.1131" class="difflineminus">-</span>
<a href="#l23.1132"></a><span id="l23.1132" class="difflineminus">-  if (version &lt; kCurrentListVersion) {</span>
<a href="#l23.1133"></a><span id="l23.1133" class="difflineminus">-    pPref-&gt;SetIntPref(PREF_LDAP_VERSION_NAME, kCurrentListVersion);</span>
<a href="#l23.1134"></a><span id="l23.1134" class="difflineminus">-  }</span>
<a href="#l23.1135"></a><span id="l23.1135" class="difflineminus">-</span>
<a href="#l23.1136"></a><span id="l23.1136" class="difflineminus">-  DIR_SortServersByPosition(newList);</span>
<a href="#l23.1137"></a><span id="l23.1137" class="difflineminus">-</span>
<a href="#l23.1138"></a><span id="l23.1138" class="difflineminus">-  *list = newList;</span>
<a href="#l23.1139"></a><span id="l23.1139" class="difflineminus">-</span>
<a href="#l23.1140"></a><span id="l23.1140" class="difflineminus">-  return err;</span>
<a href="#l23.1141"></a><span id="l23.1141" class="difflineminus">-}</span>
<a href="#l23.1142"></a><span id="l23.1142" class="difflineminus">-</span>
<a href="#l23.1143"></a><span id="l23.1143" class="difflineminus">-static void DIR_SetStringPref(const char *prefRoot, const char *prefLeaf,</span>
<a href="#l23.1144"></a><span id="l23.1144" class="difflineminus">-                              const char *value, const char *defaultValue) {</span>
<a href="#l23.1145"></a><span id="l23.1145" class="difflineminus">-  nsresult rv;</span>
<a href="#l23.1146"></a><span id="l23.1146" class="difflineminus">-  nsCOMPtr&lt;nsIPrefBranch&gt; pPref(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l23.1147"></a><span id="l23.1147" class="difflineminus">-  if (NS_FAILED(rv)) return;</span>
<a href="#l23.1148"></a><span id="l23.1148" class="difflineminus">-</span>
<a href="#l23.1149"></a><span id="l23.1149" class="difflineminus">-  nsCString defaultPref;</span>
<a href="#l23.1150"></a><span id="l23.1150" class="difflineminus">-  nsAutoCString prefLocation(prefRoot);</span>
<a href="#l23.1151"></a><span id="l23.1151" class="difflineminus">-</span>
<a href="#l23.1152"></a><span id="l23.1152" class="difflineminus">-  prefLocation.Append('.');</span>
<a href="#l23.1153"></a><span id="l23.1153" class="difflineminus">-  prefLocation.Append(prefLeaf);</span>
<a href="#l23.1154"></a><span id="l23.1154" class="difflineminus">-</span>
<a href="#l23.1155"></a><span id="l23.1155" class="difflineminus">-  if (NS_SUCCEEDED(pPref-&gt;GetCharPref(prefLocation.get(), defaultPref))) {</span>
<a href="#l23.1156"></a><span id="l23.1156" class="difflineminus">-    /* If there's a default pref, just set ours in and let libpref worry</span>
<a href="#l23.1157"></a><span id="l23.1157" class="difflineminus">-     * about potential defaults in all.js</span>
<a href="#l23.1158"></a><span id="l23.1158" class="difflineminus">-     */</span>
<a href="#l23.1159"></a><span id="l23.1159" class="difflineminus">-    if (value) /* added this check to make sure we have a value before we try to</span>
<a href="#l23.1160"></a><span id="l23.1160" class="difflineminus">-                  set it..*/</span>
<a href="#l23.1161"></a><span id="l23.1161" class="difflineminus">-      rv = pPref-&gt;SetCharPref(prefLocation.get(), nsDependentCString(value));</span>
<a href="#l23.1162"></a><span id="l23.1162" class="difflineminus">-    else</span>
<a href="#l23.1163"></a><span id="l23.1163" class="difflineminus">-      rv = pPref-&gt;ClearUserPref(prefLocation.get());</span>
<a href="#l23.1164"></a><span id="l23.1164" class="difflineminus">-  } else {</span>
<a href="#l23.1165"></a><span id="l23.1165" class="difflineminus">-    /* If there's no default pref, look for a user pref, and only set our value</span>
<a href="#l23.1166"></a><span id="l23.1166" class="difflineminus">-     * in if the user pref is different than one of them.</span>
<a href="#l23.1167"></a><span id="l23.1167" class="difflineminus">-     */</span>
<a href="#l23.1168"></a><span id="l23.1168" class="difflineminus">-    nsCString userPref;</span>
<a href="#l23.1169"></a><span id="l23.1169" class="difflineminus">-    if (NS_SUCCEEDED(pPref-&gt;GetCharPref(prefLocation.get(), userPref))) {</span>
<a href="#l23.1170"></a><span id="l23.1170" class="difflineminus">-      if (value &amp;&amp; (defaultValue ? PL_strcasecmp(value, defaultValue)</span>
<a href="#l23.1171"></a><span id="l23.1171" class="difflineminus">-                                 : value != defaultValue))</span>
<a href="#l23.1172"></a><span id="l23.1172" class="difflineminus">-        rv = pPref-&gt;SetCharPref(prefLocation.get(), nsDependentCString(value));</span>
<a href="#l23.1173"></a><span id="l23.1173" class="difflineminus">-      else</span>
<a href="#l23.1174"></a><span id="l23.1174" class="difflineminus">-        rv = pPref-&gt;ClearUserPref(prefLocation.get());</span>
<a href="#l23.1175"></a><span id="l23.1175" class="difflineminus">-    } else {</span>
<a href="#l23.1176"></a><span id="l23.1176" class="difflineminus">-      if (value &amp;&amp; (defaultValue ? PL_strcasecmp(value, defaultValue)</span>
<a href="#l23.1177"></a><span id="l23.1177" class="difflineminus">-                                 : value != defaultValue))</span>
<a href="#l23.1178"></a><span id="l23.1178" class="difflineminus">-        rv = pPref-&gt;SetCharPref(prefLocation.get(), nsDependentCString(value));</span>
<a href="#l23.1179"></a><span id="l23.1179" class="difflineminus">-    }</span>
<a href="#l23.1180"></a><span id="l23.1180" class="difflineminus">-  }</span>
<a href="#l23.1181"></a><span id="l23.1181" class="difflineminus">-</span>
<a href="#l23.1182"></a><span id="l23.1182" class="difflineminus">-  NS_ASSERTION(NS_SUCCEEDED(rv), &quot;Could not set pref in DIR_SetStringPref&quot;);</span>
<a href="#l23.1183"></a><span id="l23.1183" class="difflineminus">-}</span>
<a href="#l23.1184"></a><span id="l23.1184" class="difflineminus">-</span>
<a href="#l23.1185"></a><span id="l23.1185" class="difflineminus">-static void DIR_SetLocalizedStringPref(const char *prefRoot,</span>
<a href="#l23.1186"></a><span id="l23.1186" class="difflineminus">-                                       const char *prefLeaf,</span>
<a href="#l23.1187"></a><span id="l23.1187" class="difflineminus">-                                       const char *value) {</span>
<a href="#l23.1188"></a><span id="l23.1188" class="difflineminus">-  nsresult rv;</span>
<a href="#l23.1189"></a><span id="l23.1189" class="difflineminus">-  nsCOMPtr&lt;nsIPrefService&gt; prefSvc(</span>
<a href="#l23.1190"></a><span id="l23.1190" class="difflineminus">-      do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l23.1191"></a><span id="l23.1191" class="difflineminus">-</span>
<a href="#l23.1192"></a><span id="l23.1192" class="difflineminus">-  if (NS_FAILED(rv)) return;</span>
<a href="#l23.1193"></a><span id="l23.1193" class="difflineminus">-</span>
<a href="#l23.1194"></a><span id="l23.1194" class="difflineminus">-  nsAutoCString prefLocation(prefRoot);</span>
<a href="#l23.1195"></a><span id="l23.1195" class="difflineminus">-  prefLocation.Append('.');</span>
<a href="#l23.1196"></a><span id="l23.1196" class="difflineminus">-</span>
<a href="#l23.1197"></a><span id="l23.1197" class="difflineminus">-  nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch;</span>
<a href="#l23.1198"></a><span id="l23.1198" class="difflineminus">-  rv = prefSvc-&gt;GetBranch(prefLocation.get(), getter_AddRefs(prefBranch));</span>
<a href="#l23.1199"></a><span id="l23.1199" class="difflineminus">-  if (NS_FAILED(rv)) return;</span>
<a href="#l23.1200"></a><span id="l23.1200" class="difflineminus">-</span>
<a href="#l23.1201"></a><span id="l23.1201" class="difflineminus">-  nsString wvalue;</span>
<a href="#l23.1202"></a><span id="l23.1202" class="difflineminus">-  nsCOMPtr&lt;nsIPrefLocalizedString&gt; newStr(</span>
<a href="#l23.1203"></a><span id="l23.1203" class="difflineminus">-      do_CreateInstance(NS_PREFLOCALIZEDSTRING_CONTRACTID, &amp;rv));</span>
<a href="#l23.1204"></a><span id="l23.1204" class="difflineminus">-  if (NS_FAILED(rv)) {</span>
<a href="#l23.1205"></a><span id="l23.1205" class="difflineminus">-    NS_ASSERTION(NS_SUCCEEDED(rv),</span>
<a href="#l23.1206"></a><span id="l23.1206" class="difflineminus">-                 &quot;Could not createInstance in DIR_SetLocalizedStringPref&quot;);</span>
<a href="#l23.1207"></a><span id="l23.1207" class="difflineminus">-    return;</span>
<a href="#l23.1208"></a><span id="l23.1208" class="difflineminus">-  }</span>
<a href="#l23.1209"></a><span id="l23.1209" class="difflineminus">-</span>
<a href="#l23.1210"></a><span id="l23.1210" class="difflineminus">-  NS_ConvertUTF8toUTF16 newValue(value);</span>
<a href="#l23.1211"></a><span id="l23.1211" class="difflineminus">-</span>
<a href="#l23.1212"></a><span id="l23.1212" class="difflineminus">-  rv = newStr-&gt;SetData(newValue);</span>
<a href="#l23.1213"></a><span id="l23.1213" class="difflineminus">-  if (NS_FAILED(rv)) {</span>
<a href="#l23.1214"></a><span id="l23.1214" class="difflineminus">-    NS_ASSERTION(NS_SUCCEEDED(rv),</span>
<a href="#l23.1215"></a><span id="l23.1215" class="difflineminus">-                 &quot;Could not set pref data in DIR_SetLocalizedStringPref&quot;);</span>
<a href="#l23.1216"></a><span id="l23.1216" class="difflineminus">-    return;</span>
<a href="#l23.1217"></a><span id="l23.1217" class="difflineminus">-  }</span>
<a href="#l23.1218"></a><span id="l23.1218" class="difflineminus">-  nsCOMPtr&lt;nsIPrefLocalizedString&gt; locStr;</span>
<a href="#l23.1219"></a><span id="l23.1219" class="difflineminus">-  if (NS_SUCCEEDED(prefBranch-&gt;GetComplexValue(</span>
<a href="#l23.1220"></a><span id="l23.1220" class="difflineminus">-          prefLeaf, NS_GET_IID(nsIPrefLocalizedString),</span>
<a href="#l23.1221"></a><span id="l23.1221" class="difflineminus">-          getter_AddRefs(locStr)))) {</span>
<a href="#l23.1222"></a><span id="l23.1222" class="difflineminus">-    nsString data;</span>
<a href="#l23.1223"></a><span id="l23.1223" class="difflineminus">-    locStr-&gt;GetData(data);</span>
<a href="#l23.1224"></a><span id="l23.1224" class="difflineminus">-</span>
<a href="#l23.1225"></a><span id="l23.1225" class="difflineminus">-    // Only set the pref if the data values aren't the same (i.e. don't change</span>
<a href="#l23.1226"></a><span id="l23.1226" class="difflineminus">-    // unnecessarily, but also, don't change in the case that its a chrome</span>
<a href="#l23.1227"></a><span id="l23.1227" class="difflineminus">-    // string pointing to the value we want to set the pref to).</span>
<a href="#l23.1228"></a><span id="l23.1228" class="difflineminus">-    if (newValue != data)</span>
<a href="#l23.1229"></a><span id="l23.1229" class="difflineminus">-      rv = prefBranch-&gt;SetComplexValue(</span>
<a href="#l23.1230"></a><span id="l23.1230" class="difflineminus">-          prefLeaf, NS_GET_IID(nsIPrefLocalizedString), newStr);</span>
<a href="#l23.1231"></a><span id="l23.1231" class="difflineminus">-  } else {</span>
<a href="#l23.1232"></a><span id="l23.1232" class="difflineminus">-    // No value set, but check the default pref branch (i.e. user may have</span>
<a href="#l23.1233"></a><span id="l23.1233" class="difflineminus">-    // cleared the pref)</span>
<a href="#l23.1234"></a><span id="l23.1234" class="difflineminus">-    nsCOMPtr&lt;nsIPrefBranch&gt; dPB;</span>
<a href="#l23.1235"></a><span id="l23.1235" class="difflineminus">-    rv = prefSvc-&gt;GetDefaultBranch(prefLocation.get(), getter_AddRefs(dPB));</span>
<a href="#l23.1236"></a><span id="l23.1236" class="difflineminus">-</span>
<a href="#l23.1237"></a><span id="l23.1237" class="difflineminus">-    if (NS_SUCCEEDED(dPB-&gt;GetComplexValue(prefLeaf,</span>
<a href="#l23.1238"></a><span id="l23.1238" class="difflineminus">-                                          NS_GET_IID(nsIPrefLocalizedString),</span>
<a href="#l23.1239"></a><span id="l23.1239" class="difflineminus">-                                          getter_AddRefs(locStr)))) {</span>
<a href="#l23.1240"></a><span id="l23.1240" class="difflineminus">-      // Default branch has a value</span>
<a href="#l23.1241"></a><span id="l23.1241" class="difflineminus">-      nsString data;</span>
<a href="#l23.1242"></a><span id="l23.1242" class="difflineminus">-      locStr-&gt;GetData(data);</span>
<a href="#l23.1243"></a><span id="l23.1243" class="difflineminus">-</span>
<a href="#l23.1244"></a><span id="l23.1244" class="difflineminus">-      if (newValue != data)</span>
<a href="#l23.1245"></a><span id="l23.1245" class="difflineminus">-        // If the vales aren't the same, set the data on the main pref branch</span>
<a href="#l23.1246"></a><span id="l23.1246" class="difflineminus">-        rv = prefBranch-&gt;SetComplexValue(</span>
<a href="#l23.1247"></a><span id="l23.1247" class="difflineminus">-            prefLeaf, NS_GET_IID(nsIPrefLocalizedString), newStr);</span>
<a href="#l23.1248"></a><span id="l23.1248" class="difflineminus">-      else</span>
<a href="#l23.1249"></a><span id="l23.1249" class="difflineminus">-        // Else if they are, kill the user pref</span>
<a href="#l23.1250"></a><span id="l23.1250" class="difflineminus">-        rv = prefBranch-&gt;ClearUserPref(prefLeaf);</span>
<a href="#l23.1251"></a><span id="l23.1251" class="difflineminus">-    } else</span>
<a href="#l23.1252"></a><span id="l23.1252" class="difflineminus">-      // No values set anywhere, so just set the pref</span>
<a href="#l23.1253"></a><span id="l23.1253" class="difflineminus">-      rv = prefBranch-&gt;SetComplexValue(</span>
<a href="#l23.1254"></a><span id="l23.1254" class="difflineminus">-          prefLeaf, NS_GET_IID(nsIPrefLocalizedString), newStr);</span>
<a href="#l23.1255"></a><span id="l23.1255" class="difflineminus">-  }</span>
<a href="#l23.1256"></a><span id="l23.1256" class="difflineminus">-</span>
<a href="#l23.1257"></a><span id="l23.1257" class="difflineminus">-  NS_ASSERTION(NS_SUCCEEDED(rv),</span>
<a href="#l23.1258"></a><span id="l23.1258" class="difflineminus">-               &quot;Could not set pref in DIR_SetLocalizedStringPref&quot;);</span>
<a href="#l23.1259"></a><span id="l23.1259" class="difflineminus">-}</span>
<a href="#l23.1260"></a><span id="l23.1260" class="difflineminus">-</span>
<a href="#l23.1261"></a><span id="l23.1261" class="difflineminus">-static void DIR_SetIntPref(const char *prefRoot, const char *prefLeaf,</span>
<a href="#l23.1262"></a><span id="l23.1262" class="difflineminus">-                           int32_t value, int32_t defaultValue) {</span>
<a href="#l23.1263"></a><span id="l23.1263" class="difflineminus">-  nsresult rv;</span>
<a href="#l23.1264"></a><span id="l23.1264" class="difflineminus">-  nsCOMPtr&lt;nsIPrefBranch&gt; pPref(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l23.1265"></a><span id="l23.1265" class="difflineminus">-  if (NS_FAILED(rv)) return;</span>
<a href="#l23.1266"></a><span id="l23.1266" class="difflineminus">-</span>
<a href="#l23.1267"></a><span id="l23.1267" class="difflineminus">-  int32_t defaultPref;</span>
<a href="#l23.1268"></a><span id="l23.1268" class="difflineminus">-  nsAutoCString prefLocation(prefRoot);</span>
<a href="#l23.1269"></a><span id="l23.1269" class="difflineminus">-</span>
<a href="#l23.1270"></a><span id="l23.1270" class="difflineminus">-  prefLocation.Append('.');</span>
<a href="#l23.1271"></a><span id="l23.1271" class="difflineminus">-  prefLocation.Append(prefLeaf);</span>
<a href="#l23.1272"></a><span id="l23.1272" class="difflineminus">-</span>
<a href="#l23.1273"></a><span id="l23.1273" class="difflineminus">-  if (NS_SUCCEEDED(pPref-&gt;GetIntPref(prefLocation.get(), &amp;defaultPref))) {</span>
<a href="#l23.1274"></a><span id="l23.1274" class="difflineminus">-    /* solve the problem where reordering user prefs must override default prefs</span>
<a href="#l23.1275"></a><span id="l23.1275" class="difflineminus">-     */</span>
<a href="#l23.1276"></a><span id="l23.1276" class="difflineminus">-    rv = pPref-&gt;SetIntPref(prefLocation.get(), value);</span>
<a href="#l23.1277"></a><span id="l23.1277" class="difflineminus">-  } else {</span>
<a href="#l23.1278"></a><span id="l23.1278" class="difflineminus">-    int32_t userPref;</span>
<a href="#l23.1279"></a><span id="l23.1279" class="difflineminus">-    if (NS_SUCCEEDED(pPref-&gt;GetIntPref(prefLocation.get(), &amp;userPref))) {</span>
<a href="#l23.1280"></a><span id="l23.1280" class="difflineminus">-      if (value != defaultValue)</span>
<a href="#l23.1281"></a><span id="l23.1281" class="difflineminus">-        rv = pPref-&gt;SetIntPref(prefLocation.get(), value);</span>
<a href="#l23.1282"></a><span id="l23.1282" class="difflineminus">-      else</span>
<a href="#l23.1283"></a><span id="l23.1283" class="difflineminus">-        rv = pPref-&gt;ClearUserPref(prefLocation.get());</span>
<a href="#l23.1284"></a><span id="l23.1284" class="difflineminus">-    } else {</span>
<a href="#l23.1285"></a><span id="l23.1285" class="difflineminus">-      if (value != defaultValue)</span>
<a href="#l23.1286"></a><span id="l23.1286" class="difflineminus">-        rv = pPref-&gt;SetIntPref(prefLocation.get(), value);</span>
<a href="#l23.1287"></a><span id="l23.1287" class="difflineminus">-    }</span>
<a href="#l23.1288"></a><span id="l23.1288" class="difflineminus">-  }</span>
<a href="#l23.1289"></a><span id="l23.1289" class="difflineminus">-</span>
<a href="#l23.1290"></a><span id="l23.1290" class="difflineminus">-  NS_ASSERTION(NS_SUCCEEDED(rv), &quot;Could not set pref in DIR_SetIntPref&quot;);</span>
<a href="#l23.1291"></a><span id="l23.1291" class="difflineminus">-}</span>
<a href="#l23.1292"></a><span id="l23.1292" class="difflineminus">-</span>
<a href="#l23.1293"></a><span id="l23.1293" class="difflineminus">-void DIR_SavePrefsForOneServer(DIR_Server *server) {</span>
<a href="#l23.1294"></a><span id="l23.1294" class="difflineminus">-  if (!server) return;</span>
<a href="#l23.1295"></a><span id="l23.1295" class="difflineminus">-</span>
<a href="#l23.1296"></a><span id="l23.1296" class="difflineminus">-  char *prefstring;</span>
<a href="#l23.1297"></a><span id="l23.1297" class="difflineminus">-</span>
<a href="#l23.1298"></a><span id="l23.1298" class="difflineminus">-  if (server-&gt;prefName == nullptr)</span>
<a href="#l23.1299"></a><span id="l23.1299" class="difflineminus">-    server-&gt;prefName = dir_CreateServerPrefName(server);</span>
<a href="#l23.1300"></a><span id="l23.1300" class="difflineminus">-  prefstring = server-&gt;prefName;</span>
<a href="#l23.1301"></a><span id="l23.1301" class="difflineminus">-</span>
<a href="#l23.1302"></a><span id="l23.1302" class="difflineminus">-  server-&gt;savingServer = true;</span>
<a href="#l23.1303"></a><span id="l23.1303" class="difflineminus">-</span>
<a href="#l23.1304"></a><span id="l23.1304" class="difflineminus">-  DIR_SetIntPref(prefstring, &quot;position&quot;, server-&gt;position, kDefaultPosition);</span>
<a href="#l23.1305"></a><span id="l23.1305" class="difflineminus">-</span>
<a href="#l23.1306"></a><span id="l23.1306" class="difflineminus">-  // Only save the non-default address book name</span>
<a href="#l23.1307"></a><span id="l23.1307" class="difflineminus">-  DIR_SetLocalizedStringPref(prefstring, &quot;description&quot;, server-&gt;description);</span>
<a href="#l23.1308"></a><span id="l23.1308" class="difflineminus">-</span>
<a href="#l23.1309"></a><span id="l23.1309" class="difflineminus">-  DIR_SetStringPref(prefstring, &quot;filename&quot;, server-&gt;fileName, &quot;&quot;);</span>
<a href="#l23.1310"></a><span id="l23.1310" class="difflineminus">-  DIR_SetIntPref(prefstring, &quot;dirType&quot;, server-&gt;dirType, LDAPDirectory);</span>
<a href="#l23.1311"></a><span id="l23.1311" class="difflineminus">-</span>
<a href="#l23.1312"></a><span id="l23.1312" class="difflineminus">-  if (server-&gt;dirType != PABDirectory)</span>
<a href="#l23.1313"></a><span id="l23.1313" class="difflineminus">-    DIR_SetStringPref(prefstring, &quot;uri&quot;, server-&gt;uri, &quot;&quot;);</span>
<a href="#l23.1314"></a><span id="l23.1314" class="difflineminus">-</span>
<a href="#l23.1315"></a><span id="l23.1315" class="difflineminus">-  server-&gt;savingServer = false;</span>
<a href="#l23.1316"></a><span id="l23.1316" class="difflineminus">-}</span>
<a href="#l23.1317"></a><span id="l23.1317" class="difflineminus">-</span>
<a href="#l23.1318"></a><span id="l23.1318" class="difflineminus">-static void DIR_SaveServerPreferences(nsTArray&lt;DIR_Server *&gt; *wholeList) {</span>
<a href="#l23.1319"></a><span id="l23.1319" class="difflineminus">-  if (wholeList) {</span>
<a href="#l23.1320"></a><span id="l23.1320" class="difflineminus">-    nsresult rv;</span>
<a href="#l23.1321"></a><span id="l23.1321" class="difflineminus">-    nsCOMPtr&lt;nsIPrefBranch&gt; pPref(</span>
<a href="#l23.1322"></a><span id="l23.1322" class="difflineminus">-        do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l23.1323"></a><span id="l23.1323" class="difflineminus">-    if (NS_FAILED(rv)) {</span>
<a href="#l23.1324"></a><span id="l23.1324" class="difflineminus">-      NS_WARNING(&quot;DIR_SaveServerPreferences: Failed to get the pref service&quot;);</span>
<a href="#l23.1325"></a><span id="l23.1325" class="difflineminus">-      return;</span>
<a href="#l23.1326"></a><span id="l23.1326" class="difflineminus">-    }</span>
<a href="#l23.1327"></a><span id="l23.1327" class="difflineminus">-</span>
<a href="#l23.1328"></a><span id="l23.1328" class="difflineminus">-    int32_t i;</span>
<a href="#l23.1329"></a><span id="l23.1329" class="difflineminus">-    int32_t count = wholeList-&gt;Length();</span>
<a href="#l23.1330"></a><span id="l23.1330" class="difflineminus">-    DIR_Server *server;</span>
<a href="#l23.1331"></a><span id="l23.1331" class="difflineminus">-</span>
<a href="#l23.1332"></a><span id="l23.1332" class="difflineminus">-    for (i = 0; i &lt; count; i++) {</span>
<a href="#l23.1333"></a><span id="l23.1333" class="difflineminus">-      server = wholeList-&gt;ElementAt(i);</span>
<a href="#l23.1334"></a><span id="l23.1334" class="difflineminus">-      if (server) DIR_SavePrefsForOneServer(server);</span>
<a href="#l23.1335"></a><span id="l23.1335" class="difflineminus">-    }</span>
<a href="#l23.1336"></a><span id="l23.1336" class="difflineminus">-    pPref-&gt;SetIntPref(PREF_LDAP_GLOBAL_TREE_NAME &quot;.user_id&quot;, dir_UserId);</span>
<a href="#l23.1337"></a><span id="l23.1337" class="difflineminus">-  }</span>
<a href="#l23.1338"></a><span id="l23.1338" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/mailnews/addrbook/src/nsDirPrefs.h</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsDirPrefs.h</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -1,87 +1,16 @@</span>
<a href="#l24.4"></a><span id="l24.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l24.5"></a><span id="l24.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l24.6"></a><span id="l24.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l24.7"></a><span id="l24.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l24.8"></a><span id="l24.8"> </span>
<a href="#l24.9"></a><span id="l24.9"> #ifndef _NSDIRPREFS_H_</span>
<a href="#l24.10"></a><span id="l24.10"> #define _NSDIRPREFS_H_</span>
<a href="#l24.11"></a><span id="l24.11"> </span>
<a href="#l24.12"></a><span id="l24.12" class="difflineminus">-#include &quot;nsTArray.h&quot;</span>
<a href="#l24.13"></a><span id="l24.13" class="difflineminus">-</span>
<a href="#l24.14"></a><span id="l24.14" class="difflineminus">-//</span>
<a href="#l24.15"></a><span id="l24.15" class="difflineminus">-// XXX nsDirPrefs is being greatly reduced if not removed altogether. Directory</span>
<a href="#l24.16"></a><span id="l24.16" class="difflineminus">-// Prefs etc. should be handled via their appropriate nsAb*Directory classes.</span>
<a href="#l24.17"></a><span id="l24.17" class="difflineminus">-//</span>
<a href="#l24.18"></a><span id="l24.18" class="difflineminus">-</span>
<a href="#l24.19"></a><span id="l24.19" class="difflineminus">-#define kPreviousListVersion 2</span>
<a href="#l24.20"></a><span id="l24.20" class="difflineminus">-#define kCurrentListVersion 3</span>
<a href="#l24.21"></a><span id="l24.21" class="difflineminus">-#define PREF_LDAP_GLOBAL_TREE_NAME &quot;ldap_2&quot;</span>
<a href="#l24.22"></a><span id="l24.22" class="difflineminus">-#define PREF_LDAP_VERSION_NAME &quot;ldap_2.version&quot;</span>
<a href="#l24.23"></a><span id="l24.23" class="difflineminus">-#define PREF_LDAP_SERVER_TREE_NAME &quot;ldap_2.servers&quot;</span>
<a href="#l24.24"></a><span id="l24.24" class="difflineminus">-</span>
<a href="#l24.25"></a><span id="l24.25" class="difflineminus">-#define kMainLdapAddressBook &quot;ldap.sqlite&quot;  // v3 main ldap address book file</span>
<a href="#l24.26"></a><span id="l24.26" class="difflineminus">-</span>
<a href="#l24.27"></a><span id="l24.27"> /* DIR_Server.dirType */</span>
<a href="#l24.28"></a><span id="l24.28"> typedef enum {</span>
<a href="#l24.29"></a><span id="l24.29">   LDAPDirectory,</span>
<a href="#l24.30"></a><span id="l24.30" class="difflineminus">-  HTMLDirectory,</span>
<a href="#l24.31"></a><span id="l24.31" class="difflineminus">-  PABDirectory,</span>
<a href="#l24.32"></a><span id="l24.32" class="difflineminus">-  MAPIDirectory,</span>
<a href="#l24.33"></a><span id="l24.33" class="difflineminus">-  JSDirectory = 101,</span>
<a href="#l24.34"></a><span id="l24.34" class="difflineminus">-  FixedQueryLDAPDirectory = 777</span>
<a href="#l24.35"></a><span id="l24.35" class="difflineplus">+  MAPIDirectory = 3,</span>
<a href="#l24.36"></a><span id="l24.36" class="difflineplus">+  JSDirectory = 101</span>
<a href="#l24.37"></a><span id="l24.37"> } DirectoryType;</span>
<a href="#l24.38"></a><span id="l24.38"> </span>
<a href="#l24.39"></a><span id="l24.39" class="difflineminus">-typedef enum {</span>
<a href="#l24.40"></a><span id="l24.40" class="difflineminus">-  idNone = 0, /* Special value */</span>
<a href="#l24.41"></a><span id="l24.41" class="difflineminus">-  idPrefName,</span>
<a href="#l24.42"></a><span id="l24.42" class="difflineminus">-  idPosition,</span>
<a href="#l24.43"></a><span id="l24.43" class="difflineminus">-  idDescription,</span>
<a href="#l24.44"></a><span id="l24.44" class="difflineminus">-  idFileName,</span>
<a href="#l24.45"></a><span id="l24.45" class="difflineminus">-  idUri,</span>
<a href="#l24.46"></a><span id="l24.46" class="difflineminus">-  idType</span>
<a href="#l24.47"></a><span id="l24.47" class="difflineminus">-} DIR_PrefId;</span>
<a href="#l24.48"></a><span id="l24.48" class="difflineminus">-</span>
<a href="#l24.49"></a><span id="l24.49" class="difflineminus">-#define DIR_Server_typedef 1 /* this quiets a redeclare warning in libaddr */</span>
<a href="#l24.50"></a><span id="l24.50" class="difflineminus">-</span>
<a href="#l24.51"></a><span id="l24.51" class="difflineminus">-typedef struct DIR_Server {</span>
<a href="#l24.52"></a><span id="l24.52" class="difflineminus">-  /* Housekeeping fields */</span>
<a href="#l24.53"></a><span id="l24.53" class="difflineminus">-  char *prefName;   /* preference name, this server's subtree */</span>
<a href="#l24.54"></a><span id="l24.54" class="difflineminus">-  int32_t position; /* relative position in server list       */</span>
<a href="#l24.55"></a><span id="l24.55" class="difflineminus">-</span>
<a href="#l24.56"></a><span id="l24.56" class="difflineminus">-  /* General purpose fields */</span>
<a href="#l24.57"></a><span id="l24.57" class="difflineminus">-  char *description; /* human readable name                    */</span>
<a href="#l24.58"></a><span id="l24.58" class="difflineminus">-  char *fileName;    /* XP path name of local DB               */</span>
<a href="#l24.59"></a><span id="l24.59" class="difflineminus">-  DirectoryType dirType;</span>
<a href="#l24.60"></a><span id="l24.60" class="difflineminus">-  char *uri;  // URI of the address book</span>
<a href="#l24.61"></a><span id="l24.61" class="difflineminus">-</span>
<a href="#l24.62"></a><span id="l24.62" class="difflineminus">-  // Set whilst saving the server to avoid updating it again</span>
<a href="#l24.63"></a><span id="l24.63" class="difflineminus">-  bool savingServer;</span>
<a href="#l24.64"></a><span id="l24.64" class="difflineminus">-} DIR_Server;</span>
<a href="#l24.65"></a><span id="l24.65" class="difflineminus">-</span>
<a href="#l24.66"></a><span id="l24.66" class="difflineminus">-/* We are developing a new model for managing DIR_Servers. In the 4.0x world,</span>
<a href="#l24.67"></a><span id="l24.67" class="difflineminus">-  the FEs managed each list. Calls to FE_GetDirServer caused the FEs to manage</span>
<a href="#l24.68"></a><span id="l24.68" class="difflineminus">-  and return the DIR_Server list. In our new view of the world, the back end</span>
<a href="#l24.69"></a><span id="l24.69" class="difflineminus">-  does most of the list management so we are going to have the back end create</span>
<a href="#l24.70"></a><span id="l24.70" class="difflineminus">-  and manage the list. Replace calls to FE_GetDirServers() with</span>
<a href="#l24.71"></a><span id="l24.71" class="difflineminus">-  DIR_GetDirServers(). */</span>
<a href="#l24.72"></a><span id="l24.72" class="difflineminus">-</span>
<a href="#l24.73"></a><span id="l24.73" class="difflineminus">-nsTArray&lt;DIR_Server *&gt; *DIR_GetDirectories();</span>
<a href="#l24.74"></a><span id="l24.74" class="difflineminus">-DIR_Server *DIR_GetServerFromList(const char *prefName);</span>
<a href="#l24.75"></a><span id="l24.75" class="difflineminus">-nsresult DIR_ShutDown(</span>
<a href="#l24.76"></a><span id="l24.76" class="difflineminus">-    void); /* FEs should call this when the app is shutting down. It frees all</span>
<a href="#l24.77"></a><span id="l24.77" class="difflineminus">-              DIR_Servers regardless of ref count values! */</span>
<a href="#l24.78"></a><span id="l24.78" class="difflineminus">-</span>
<a href="#l24.79"></a><span id="l24.79" class="difflineminus">-nsresult DIR_AddNewAddressBook(const nsAString &amp;dirName,</span>
<a href="#l24.80"></a><span id="l24.80" class="difflineminus">-                               const nsACString &amp;fileName,</span>
<a href="#l24.81"></a><span id="l24.81" class="difflineminus">-                               const nsACString &amp;uri, DirectoryType dirType,</span>
<a href="#l24.82"></a><span id="l24.82" class="difflineminus">-                               const nsACString &amp;prefName,</span>
<a href="#l24.83"></a><span id="l24.83" class="difflineminus">-                               DIR_Server **pServer);</span>
<a href="#l24.84"></a><span id="l24.84" class="difflineminus">-nsresult DIR_ContainsServer(DIR_Server *pServer, bool *hasDir);</span>
<a href="#l24.85"></a><span id="l24.85" class="difflineminus">-</span>
<a href="#l24.86"></a><span id="l24.86" class="difflineminus">-nsresult DIR_DeleteServerFromList(DIR_Server *);</span>
<a href="#l24.87"></a><span id="l24.87" class="difflineminus">-</span>
<a href="#l24.88"></a><span id="l24.88" class="difflineminus">-void DIR_SavePrefsForOneServer(DIR_Server *server);</span>
<a href="#l24.89"></a><span id="l24.89" class="difflineminus">-</span>
<a href="#l24.90"></a><span id="l24.90" class="difflineminus">-void DIR_SetServerFileName(DIR_Server *pServer);</span>
<a href="#l24.91"></a><span id="l24.91" class="difflineminus">-</span>
<a href="#l24.92"></a><span id="l24.92"> #endif /* dirprefs.h */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1" class="difflineminus">--- a/mailnews/addrbook/test/unit/test_basic_nsIAbDirectory.js</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineplus">+++ b/mailnews/addrbook/test/unit/test_basic_nsIAbDirectory.js</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineat">@@ -15,18 +15,16 @@</span>
<a href="#l25.4"></a><span id="l25.4">  * - deleteCards</span>
<a href="#l25.5"></a><span id="l25.5">  * - dropCard</span>
<a href="#l25.6"></a><span id="l25.6">  * - addressLists</span>
<a href="#l25.7"></a><span id="l25.7">  * - addMailList</span>
<a href="#l25.8"></a><span id="l25.8">  * - listNickName</span>
<a href="#l25.9"></a><span id="l25.9">  * - description</span>
<a href="#l25.10"></a><span id="l25.10">  * - editMailListToDatabase</span>
<a href="#l25.11"></a><span id="l25.11">  * - copyMailList</span>
<a href="#l25.12"></a><span id="l25.12" class="difflineminus">- * - createNewDirectory</span>
<a href="#l25.13"></a><span id="l25.13" class="difflineminus">- * - createDirectoryByURI</span>
<a href="#l25.14"></a><span id="l25.14">  */</span>
<a href="#l25.15"></a><span id="l25.15"> </span>
<a href="#l25.16"></a><span id="l25.16"> // Main function for the this test so we can check both personal and</span>
<a href="#l25.17"></a><span id="l25.17"> // collected books work correctly in an easy manner.</span>
<a href="#l25.18"></a><span id="l25.18"> function check_ab(abConfig) {</span>
<a href="#l25.19"></a><span id="l25.19">   // Test - Get the directory</span>
<a href="#l25.20"></a><span id="l25.20"> </span>
<a href="#l25.21"></a><span id="l25.21">   let AB = MailServices.ab.getDirectory(abConfig.URI);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1" class="difflineminus">--- a/mailnews/build/nsMailModule.cpp</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineplus">+++ b/mailnews/build/nsMailModule.cpp</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineat">@@ -106,20 +106,17 @@</span>
<a href="#l26.4"></a><span id="l26.4"> #include &quot;nsMessengerContentHandler.h&quot;</span>
<a href="#l26.5"></a><span id="l26.5"> #include &quot;nsStopwatch.h&quot;</span>
<a href="#l26.6"></a><span id="l26.6"> #include &quot;MailNewsDLF.h&quot;</span>
<a href="#l26.7"></a><span id="l26.7"> </span>
<a href="#l26.8"></a><span id="l26.8"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l26.9"></a><span id="l26.9"> // addrbook includes</span>
<a href="#l26.10"></a><span id="l26.10"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l26.11"></a><span id="l26.11"> #include &quot;nsAbBaseCID.h&quot;</span>
<a href="#l26.12"></a><span id="l26.12" class="difflineminus">-#include &quot;nsAbBSDirectory.h&quot;</span>
<a href="#l26.13"></a><span id="l26.13" class="difflineminus">-#include &quot;nsAbDirFactoryService.h&quot;</span>
<a href="#l26.14"></a><span id="l26.14"> #include &quot;nsAddrDatabase.h&quot;</span>
<a href="#l26.15"></a><span id="l26.15" class="difflineminus">-// #include &quot;nsAbManager.h&quot;</span>
<a href="#l26.16"></a><span id="l26.16"> #include &quot;nsAbContentHandler.h&quot;</span>
<a href="#l26.17"></a><span id="l26.17"> #include &quot;nsAbDirProperty.h&quot;</span>
<a href="#l26.18"></a><span id="l26.18"> #include &quot;nsAbAddressCollector.h&quot;</span>
<a href="#l26.19"></a><span id="l26.19"> #include &quot;nsAddbookProtocolHandler.h&quot;</span>
<a href="#l26.20"></a><span id="l26.20"> #include &quot;nsAddbookUrl.h&quot;</span>
<a href="#l26.21"></a><span id="l26.21"> </span>
<a href="#l26.22"></a><span id="l26.22"> #include &quot;nsAbDirectoryQuery.h&quot;</span>
<a href="#l26.23"></a><span id="l26.23"> #include &quot;nsAbBooleanExpression.h&quot;</span>
<a href="#l26.24"></a><span id="l26.24" class="difflineat">@@ -127,17 +124,16 @@</span>
<a href="#l26.25"></a><span id="l26.25"> #include &quot;nsAbView.h&quot;</span>
<a href="#l26.26"></a><span id="l26.26"> #include &quot;nsMsgVCardService.h&quot;</span>
<a href="#l26.27"></a><span id="l26.27"> #include &quot;nsAbLDIFService.h&quot;</span>
<a href="#l26.28"></a><span id="l26.28"> </span>
<a href="#l26.29"></a><span id="l26.29"> #if defined(MOZ_LDAP_XPCOM)</span>
<a href="#l26.30"></a><span id="l26.30"> #  include &quot;nsAbLDAPDirectory.h&quot;</span>
<a href="#l26.31"></a><span id="l26.31"> #  include &quot;nsAbLDAPDirectoryQuery.h&quot;</span>
<a href="#l26.32"></a><span id="l26.32"> #  include &quot;nsAbLDAPCard.h&quot;</span>
<a href="#l26.33"></a><span id="l26.33" class="difflineminus">-#  include &quot;nsAbLDAPDirFactory.h&quot;</span>
<a href="#l26.34"></a><span id="l26.34"> #  include &quot;nsAbLDAPReplicationService.h&quot;</span>
<a href="#l26.35"></a><span id="l26.35"> #  include &quot;nsAbLDAPReplicationQuery.h&quot;</span>
<a href="#l26.36"></a><span id="l26.36"> #  include &quot;nsAbLDAPReplicationData.h&quot;</span>
<a href="#l26.37"></a><span id="l26.37"> // XXX These files are not being built as they don't work. Bug 311632 should</span>
<a href="#l26.38"></a><span id="l26.38"> // fix them.</span>
<a href="#l26.39"></a><span id="l26.39"> //#include &quot;nsAbLDAPChangeLogQuery.h&quot;</span>
<a href="#l26.40"></a><span id="l26.40"> //#include &quot;nsAbLDAPChangeLogData.h&quot;</span>
<a href="#l26.41"></a><span id="l26.41"> #endif</span>
<a href="#l26.42"></a><span id="l26.42" class="difflineat">@@ -145,17 +141,16 @@</span>
<a href="#l26.43"></a><span id="l26.43"> #if defined(MOZ_MAPI_SUPPORT)</span>
<a href="#l26.44"></a><span id="l26.44"> #  include &quot;nsAbOutlookDirFactory.h&quot;</span>
<a href="#l26.45"></a><span id="l26.45"> #  include &quot;nsAbOutlookDirectory.h&quot;</span>
<a href="#l26.46"></a><span id="l26.46"> #endif</span>
<a href="#l26.47"></a><span id="l26.47"> </span>
<a href="#l26.48"></a><span id="l26.48"> #ifdef XP_MACOSX</span>
<a href="#l26.49"></a><span id="l26.49"> #  include &quot;nsAbOSXDirectory.h&quot;</span>
<a href="#l26.50"></a><span id="l26.50"> #  include &quot;nsAbOSXCard.h&quot;</span>
<a href="#l26.51"></a><span id="l26.51" class="difflineminus">-#  include &quot;nsAbOSXDirFactory.h&quot;</span>
<a href="#l26.52"></a><span id="l26.52"> #endif</span>
<a href="#l26.53"></a><span id="l26.53"> </span>
<a href="#l26.54"></a><span id="l26.54"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l26.55"></a><span id="l26.55"> // bayesian spam filter includes</span>
<a href="#l26.56"></a><span id="l26.56"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l26.57"></a><span id="l26.57"> #include &quot;nsBayesianFilterCID.h&quot;</span>
<a href="#l26.58"></a><span id="l26.58"> #include &quot;nsBayesianFilter.h&quot;</span>
<a href="#l26.59"></a><span id="l26.59"> </span>
<a href="#l26.60"></a><span id="l26.60" class="difflineat">@@ -432,37 +427,34 @@ NS_DEFINE_NAMED_CID(NS_STOPWATCH_CID);</span>
<a href="#l26.61"></a><span id="l26.61"> NS_DEFINE_NAMED_CID(NS_MAILNEWSDLF_CID);</span>
<a href="#l26.62"></a><span id="l26.62"> </span>
<a href="#l26.63"></a><span id="l26.63"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l26.64"></a><span id="l26.64"> // addrbook factories</span>
<a href="#l26.65"></a><span id="l26.65"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l26.66"></a><span id="l26.66"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsAbContentHandler)</span>
<a href="#l26.67"></a><span id="l26.67"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsAbDirProperty)</span>
<a href="#l26.68"></a><span id="l26.68"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsAbCardProperty)</span>
<a href="#l26.69"></a><span id="l26.69" class="difflineminus">-NS_GENERIC_FACTORY_CONSTRUCTOR(nsAbBSDirectory)</span>
<a href="#l26.70"></a><span id="l26.70"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsAddrDatabase)</span>
<a href="#l26.71"></a><span id="l26.71"> NS_GENERIC_FACTORY_CONSTRUCTOR_INIT(nsAbAddressCollector, Init)</span>
<a href="#l26.72"></a><span id="l26.72"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsAddbookUrl)</span>
<a href="#l26.73"></a><span id="l26.73" class="difflineminus">-NS_GENERIC_FACTORY_CONSTRUCTOR(nsAbDirFactoryService)</span>
<a href="#l26.74"></a><span id="l26.74"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsAddbookProtocolHandler)</span>
<a href="#l26.75"></a><span id="l26.75"> </span>
<a href="#l26.76"></a><span id="l26.76"> #if defined(MOZ_MAPI_SUPPORT)</span>
<a href="#l26.77"></a><span id="l26.77"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsAbOutlookDirectory)</span>
<a href="#l26.78"></a><span id="l26.78"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsAbOutlookDirFactory)</span>
<a href="#l26.79"></a><span id="l26.79"> #endif</span>
<a href="#l26.80"></a><span id="l26.80"> </span>
<a href="#l26.81"></a><span id="l26.81"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsAbDirectoryQueryArguments)</span>
<a href="#l26.82"></a><span id="l26.82"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsAbBooleanConditionString)</span>
<a href="#l26.83"></a><span id="l26.83"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsAbBooleanExpression)</span>
<a href="#l26.84"></a><span id="l26.84"> </span>
<a href="#l26.85"></a><span id="l26.85"> #if defined(MOZ_LDAP_XPCOM)</span>
<a href="#l26.86"></a><span id="l26.86"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsAbLDAPDirectory)</span>
<a href="#l26.87"></a><span id="l26.87"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsAbLDAPDirectoryQuery)</span>
<a href="#l26.88"></a><span id="l26.88"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsAbLDAPCard)</span>
<a href="#l26.89"></a><span id="l26.89" class="difflineminus">-NS_GENERIC_FACTORY_CONSTRUCTOR(nsAbLDAPDirFactory)</span>
<a href="#l26.90"></a><span id="l26.90"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsAbLDAPReplicationService)</span>
<a href="#l26.91"></a><span id="l26.91"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsAbLDAPReplicationQuery)</span>
<a href="#l26.92"></a><span id="l26.92"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsAbLDAPProcessReplicationData)</span>
<a href="#l26.93"></a><span id="l26.93"> // XXX These files are not being built as they don't work. Bug 311632 should</span>
<a href="#l26.94"></a><span id="l26.94"> // fix them.</span>
<a href="#l26.95"></a><span id="l26.95"> // NS_GENERIC_FACTORY_CONSTRUCTOR(nsAbLDAPChangeLogQuery)</span>
<a href="#l26.96"></a><span id="l26.96"> // NS_GENERIC_FACTORY_CONSTRUCTOR(nsAbLDAPProcessChangeLogData)</span>
<a href="#l26.97"></a><span id="l26.97"> #endif</span>
<a href="#l26.98"></a><span id="l26.98" class="difflineat">@@ -470,51 +462,45 @@ NS_GENERIC_FACTORY_CONSTRUCTOR(nsAbLDAPP</span>
<a href="#l26.99"></a><span id="l26.99"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsAbDirectoryQueryProxy)</span>
<a href="#l26.100"></a><span id="l26.100"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsAbView)</span>
<a href="#l26.101"></a><span id="l26.101"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsMsgVCardService)</span>
<a href="#l26.102"></a><span id="l26.102"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsAbLDIFService)</span>
<a href="#l26.103"></a><span id="l26.103"> </span>
<a href="#l26.104"></a><span id="l26.104"> #ifdef XP_MACOSX</span>
<a href="#l26.105"></a><span id="l26.105"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsAbOSXDirectory)</span>
<a href="#l26.106"></a><span id="l26.106"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsAbOSXCard)</span>
<a href="#l26.107"></a><span id="l26.107" class="difflineminus">-NS_GENERIC_FACTORY_CONSTRUCTOR(nsAbOSXDirFactory)</span>
<a href="#l26.108"></a><span id="l26.108"> #endif</span>
<a href="#l26.109"></a><span id="l26.109"> </span>
<a href="#l26.110"></a><span id="l26.110" class="difflineminus">-NS_DEFINE_NAMED_CID(NS_ABMANAGER_CID);</span>
<a href="#l26.111"></a><span id="l26.111" class="difflineminus">-NS_DEFINE_NAMED_CID(NS_ABDIRECTORY_CID);</span>
<a href="#l26.112"></a><span id="l26.112"> NS_DEFINE_NAMED_CID(NS_ADDRDATABASE_CID);</span>
<a href="#l26.113"></a><span id="l26.113"> NS_DEFINE_NAMED_CID(NS_ABCARDPROPERTY_CID);</span>
<a href="#l26.114"></a><span id="l26.114"> NS_DEFINE_NAMED_CID(NS_ABDIRPROPERTY_CID);</span>
<a href="#l26.115"></a><span id="l26.115"> NS_DEFINE_NAMED_CID(NS_ABADDRESSCOLLECTOR_CID);</span>
<a href="#l26.116"></a><span id="l26.116"> NS_DEFINE_NAMED_CID(NS_ADDBOOKURL_CID);</span>
<a href="#l26.117"></a><span id="l26.117"> NS_DEFINE_NAMED_CID(NS_ADDBOOK_HANDLER_CID);</span>
<a href="#l26.118"></a><span id="l26.118"> NS_DEFINE_NAMED_CID(NS_ABCONTENTHANDLER_CID);</span>
<a href="#l26.119"></a><span id="l26.119" class="difflineminus">-NS_DEFINE_NAMED_CID(NS_ABDIRFACTORYSERVICE_CID);</span>
<a href="#l26.120"></a><span id="l26.120"> NS_DEFINE_NAMED_CID(NS_ABDIRECTORYQUERYARGUMENTS_CID);</span>
<a href="#l26.121"></a><span id="l26.121"> NS_DEFINE_NAMED_CID(NS_BOOLEANCONDITIONSTRING_CID);</span>
<a href="#l26.122"></a><span id="l26.122"> NS_DEFINE_NAMED_CID(NS_BOOLEANEXPRESSION_CID);</span>
<a href="#l26.123"></a><span id="l26.123"> #if defined(MOZ_MAPI_SUPPORT)</span>
<a href="#l26.124"></a><span id="l26.124"> NS_DEFINE_NAMED_CID(NS_ABOUTLOOKDIRECTORY_CID);</span>
<a href="#l26.125"></a><span id="l26.125"> NS_DEFINE_NAMED_CID(NS_ABOUTLOOKDIRFACTORY_CID);</span>
<a href="#l26.126"></a><span id="l26.126"> #endif</span>
<a href="#l26.127"></a><span id="l26.127"> </span>
<a href="#l26.128"></a><span id="l26.128"> #if defined(MOZ_LDAP_XPCOM)</span>
<a href="#l26.129"></a><span id="l26.129"> NS_DEFINE_NAMED_CID(NS_ABLDAPDIRECTORY_CID);</span>
<a href="#l26.130"></a><span id="l26.130"> NS_DEFINE_NAMED_CID(NS_ABLDAPDIRECTORYQUERY_CID);</span>
<a href="#l26.131"></a><span id="l26.131"> NS_DEFINE_NAMED_CID(NS_ABLDAPCARD_CID);</span>
<a href="#l26.132"></a><span id="l26.132" class="difflineminus">-NS_DEFINE_NAMED_CID(NS_ABLDAPDIRFACTORY_CID);</span>
<a href="#l26.133"></a><span id="l26.133"> NS_DEFINE_NAMED_CID(NS_ABLDAP_REPLICATIONSERVICE_CID);</span>
<a href="#l26.134"></a><span id="l26.134"> NS_DEFINE_NAMED_CID(NS_ABLDAP_REPLICATIONQUERY_CID);</span>
<a href="#l26.135"></a><span id="l26.135"> NS_DEFINE_NAMED_CID(NS_ABLDAP_PROCESSREPLICATIONDATA_CID);</span>
<a href="#l26.136"></a><span id="l26.136"> #endif</span>
<a href="#l26.137"></a><span id="l26.137"> NS_DEFINE_NAMED_CID(NS_ABDIRECTORYQUERYPROXY_CID);</span>
<a href="#l26.138"></a><span id="l26.138"> #ifdef XP_MACOSX</span>
<a href="#l26.139"></a><span id="l26.139"> NS_DEFINE_NAMED_CID(NS_ABOSXDIRECTORY_CID);</span>
<a href="#l26.140"></a><span id="l26.140"> NS_DEFINE_NAMED_CID(NS_ABOSXCARD_CID);</span>
<a href="#l26.141"></a><span id="l26.141" class="difflineminus">-NS_DEFINE_NAMED_CID(NS_ABOSXDIRFACTORY_CID);</span>
<a href="#l26.142"></a><span id="l26.142"> #endif</span>
<a href="#l26.143"></a><span id="l26.143"> NS_DEFINE_NAMED_CID(NS_ABVIEW_CID);</span>
<a href="#l26.144"></a><span id="l26.144"> NS_DEFINE_NAMED_CID(NS_MSGVCARDSERVICE_CID);</span>
<a href="#l26.145"></a><span id="l26.145"> NS_DEFINE_NAMED_CID(NS_ABLDIFSERVICE_CID);</span>
<a href="#l26.146"></a><span id="l26.146"> </span>
<a href="#l26.147"></a><span id="l26.147"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l26.148"></a><span id="l26.148"> // bayesian spam filter factories</span>
<a href="#l26.149"></a><span id="l26.149"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l26.150"></a><span id="l26.150" class="difflineat">@@ -891,28 +877,24 @@ const mozilla::Module::CIDEntry kMailNew</span>
<a href="#l26.151"></a><span id="l26.151">     {&amp;kNS_MESSENGERCONTENTHANDLER_CID, false, NULL,</span>
<a href="#l26.152"></a><span id="l26.152">      nsMessengerContentHandlerConstructor},</span>
<a href="#l26.153"></a><span id="l26.153">     {&amp;kNS_MSGCONTENTPOLICY_CID, false, NULL, nsMsgContentPolicyConstructor},</span>
<a href="#l26.154"></a><span id="l26.154">     {&amp;kNS_MSGSHUTDOWNSERVICE_CID, false, NULL, nsMsgShutdownServiceConstructor},</span>
<a href="#l26.155"></a><span id="l26.155">     {&amp;kMAILDIRPROVIDER_CID, false, NULL, nsMailDirProviderConstructor},</span>
<a href="#l26.156"></a><span id="l26.156">     {&amp;kNS_STOPWATCH_CID, false, NULL, nsStopwatchConstructor},</span>
<a href="#l26.157"></a><span id="l26.157">     {&amp;kNS_MAILNEWSDLF_CID, false, NULL, MailNewsDLFConstructor},</span>
<a href="#l26.158"></a><span id="l26.158">     // Address Book Entries</span>
<a href="#l26.159"></a><span id="l26.159" class="difflineminus">-    // {&amp;kNS_ABMANAGER_CID, false, NULL, nsAbManagerConstructor},</span>
<a href="#l26.160"></a><span id="l26.160" class="difflineminus">-    {&amp;kNS_ABDIRECTORY_CID, false, NULL, nsAbBSDirectoryConstructor},</span>
<a href="#l26.161"></a><span id="l26.161">     {&amp;kNS_ADDRDATABASE_CID, false, NULL, nsAddrDatabaseConstructor},</span>
<a href="#l26.162"></a><span id="l26.162">     {&amp;kNS_ABCARDPROPERTY_CID, false, NULL, nsAbCardPropertyConstructor},</span>
<a href="#l26.163"></a><span id="l26.163">     {&amp;kNS_ABDIRPROPERTY_CID, false, NULL, nsAbDirPropertyConstructor},</span>
<a href="#l26.164"></a><span id="l26.164">     {&amp;kNS_ABADDRESSCOLLECTOR_CID, false, NULL, nsAbAddressCollectorConstructor},</span>
<a href="#l26.165"></a><span id="l26.165">     {&amp;kNS_ADDBOOKURL_CID, false, NULL, nsAddbookUrlConstructor},</span>
<a href="#l26.166"></a><span id="l26.166">     {&amp;kNS_ADDBOOK_HANDLER_CID, false, NULL,</span>
<a href="#l26.167"></a><span id="l26.167">      nsAddbookProtocolHandlerConstructor},</span>
<a href="#l26.168"></a><span id="l26.168">     {&amp;kNS_ABCONTENTHANDLER_CID, false, NULL, nsAbContentHandlerConstructor},</span>
<a href="#l26.169"></a><span id="l26.169" class="difflineminus">-    {&amp;kNS_ABDIRFACTORYSERVICE_CID, false, NULL,</span>
<a href="#l26.170"></a><span id="l26.170" class="difflineminus">-     nsAbDirFactoryServiceConstructor},</span>
<a href="#l26.171"></a><span id="l26.171"> #if defined(MOZ_MAPI_SUPPORT)</span>
<a href="#l26.172"></a><span id="l26.172">     {&amp;kNS_ABOUTLOOKDIRECTORY_CID, false, NULL, nsAbOutlookDirectoryConstructor},</span>
<a href="#l26.173"></a><span id="l26.173">     {&amp;kNS_ABOUTLOOKDIRFACTORY_CID, false, NULL,</span>
<a href="#l26.174"></a><span id="l26.174">      nsAbOutlookDirFactoryConstructor},</span>
<a href="#l26.175"></a><span id="l26.175"> #endif</span>
<a href="#l26.176"></a><span id="l26.176">     {&amp;kNS_ABDIRECTORYQUERYARGUMENTS_CID, false, NULL,</span>
<a href="#l26.177"></a><span id="l26.177">      nsAbDirectoryQueryArgumentsConstructor},</span>
<a href="#l26.178"></a><span id="l26.178">     {&amp;kNS_BOOLEANCONDITIONSTRING_CID, false, NULL,</span>
<a href="#l26.179"></a><span id="l26.179" class="difflineat">@@ -925,24 +907,22 @@ const mozilla::Module::CIDEntry kMailNew</span>
<a href="#l26.180"></a><span id="l26.180">      nsAbLDAPDirectoryQueryConstructor},</span>
<a href="#l26.181"></a><span id="l26.181">     {&amp;kNS_ABLDAPCARD_CID, false, NULL, nsAbLDAPCardConstructor},</span>
<a href="#l26.182"></a><span id="l26.182">     {&amp;kNS_ABLDAP_REPLICATIONSERVICE_CID, false, NULL,</span>
<a href="#l26.183"></a><span id="l26.183">      nsAbLDAPReplicationServiceConstructor},</span>
<a href="#l26.184"></a><span id="l26.184">     {&amp;kNS_ABLDAP_REPLICATIONQUERY_CID, false, NULL,</span>
<a href="#l26.185"></a><span id="l26.185">      nsAbLDAPReplicationQueryConstructor},</span>
<a href="#l26.186"></a><span id="l26.186">     {&amp;kNS_ABLDAP_PROCESSREPLICATIONDATA_CID, false, NULL,</span>
<a href="#l26.187"></a><span id="l26.187">      nsAbLDAPProcessReplicationDataConstructor},</span>
<a href="#l26.188"></a><span id="l26.188" class="difflineminus">-    {&amp;kNS_ABLDAPDIRFACTORY_CID, false, NULL, nsAbLDAPDirFactoryConstructor},</span>
<a href="#l26.189"></a><span id="l26.189"> #endif</span>
<a href="#l26.190"></a><span id="l26.190">     {&amp;kNS_ABDIRECTORYQUERYPROXY_CID, false, NULL,</span>
<a href="#l26.191"></a><span id="l26.191">      nsAbDirectoryQueryProxyConstructor},</span>
<a href="#l26.192"></a><span id="l26.192"> #ifdef XP_MACOSX</span>
<a href="#l26.193"></a><span id="l26.193">     {&amp;kNS_ABOSXDIRECTORY_CID, false, NULL, nsAbOSXDirectoryConstructor},</span>
<a href="#l26.194"></a><span id="l26.194">     {&amp;kNS_ABOSXCARD_CID, false, NULL, nsAbOSXCardConstructor},</span>
<a href="#l26.195"></a><span id="l26.195" class="difflineminus">-    {&amp;kNS_ABOSXDIRFACTORY_CID, false, NULL, nsAbOSXDirFactoryConstructor},</span>
<a href="#l26.196"></a><span id="l26.196"> #endif</span>
<a href="#l26.197"></a><span id="l26.197">     {&amp;kNS_ABVIEW_CID, false, NULL, nsAbViewConstructor},</span>
<a href="#l26.198"></a><span id="l26.198">     {&amp;kNS_MSGVCARDSERVICE_CID, false, NULL, nsMsgVCardServiceConstructor},</span>
<a href="#l26.199"></a><span id="l26.199">     {&amp;kNS_ABLDIFSERVICE_CID, false, NULL, nsAbLDIFServiceConstructor},</span>
<a href="#l26.200"></a><span id="l26.200">     // Bayesian Filter Entries</span>
<a href="#l26.201"></a><span id="l26.201">     {&amp;kNS_BAYESIANFILTER_CID, false, NULL, nsBayesianFilterConstructor},</span>
<a href="#l26.202"></a><span id="l26.202">     // Compose Entries</span>
<a href="#l26.203"></a><span id="l26.203">     {&amp;kNS_MSGCOMPOSE_CID, false, NULL, nsMsgComposeConstructor},</span>
<a href="#l26.204"></a><span id="l26.204" class="difflineat">@@ -1132,58 +1112,50 @@ const mozilla::Module::ContractIDEntry k</span>
<a href="#l26.205"></a><span id="l26.205"> #endif</span>
<a href="#l26.206"></a><span id="l26.206">     {NS_MESSENGERCONTENTHANDLER_CONTRACTID, &amp;kNS_MESSENGERCONTENTHANDLER_CID},</span>
<a href="#l26.207"></a><span id="l26.207">     {NS_MSGCONTENTPOLICY_CONTRACTID, &amp;kNS_MSGCONTENTPOLICY_CID},</span>
<a href="#l26.208"></a><span id="l26.208">     {NS_MSGSHUTDOWNSERVICE_CONTRACTID, &amp;kNS_MSGSHUTDOWNSERVICE_CID},</span>
<a href="#l26.209"></a><span id="l26.209">     {NS_MAILDIRPROVIDER_CONTRACTID, &amp;kMAILDIRPROVIDER_CID},</span>
<a href="#l26.210"></a><span id="l26.210">     {NS_STOPWATCH_CONTRACTID, &amp;kNS_STOPWATCH_CID},</span>
<a href="#l26.211"></a><span id="l26.211">     {NS_MAILNEWSDLF_CONTRACTID, &amp;kNS_MAILNEWSDLF_CID},</span>
<a href="#l26.212"></a><span id="l26.212">     // Address Book Entries</span>
<a href="#l26.213"></a><span id="l26.213" class="difflineminus">-    {NS_ABMANAGER_CONTRACTID, &amp;kNS_ABMANAGER_CID},</span>
<a href="#l26.214"></a><span id="l26.214" class="difflineminus">-    {NS_ABMANAGERSTARTUPHANDLER_CONTRACTID, &amp;kNS_ABMANAGER_CID},</span>
<a href="#l26.215"></a><span id="l26.215" class="difflineminus">-    {NS_ABDIRECTORY_CONTRACTID, &amp;kNS_ABDIRECTORY_CID},</span>
<a href="#l26.216"></a><span id="l26.216">     {NS_ADDRDATABASE_CONTRACTID, &amp;kNS_ADDRDATABASE_CID},</span>
<a href="#l26.217"></a><span id="l26.217">     {NS_ABCARDPROPERTY_CONTRACTID, &amp;kNS_ABCARDPROPERTY_CID},</span>
<a href="#l26.218"></a><span id="l26.218">     {NS_ABDIRPROPERTY_CONTRACTID, &amp;kNS_ABDIRPROPERTY_CID},</span>
<a href="#l26.219"></a><span id="l26.219">     {NS_ABADDRESSCOLLECTOR_CONTRACTID, &amp;kNS_ABADDRESSCOLLECTOR_CID},</span>
<a href="#l26.220"></a><span id="l26.220">     {NS_ADDBOOKURL_CONTRACTID, &amp;kNS_ADDBOOKURL_CID},</span>
<a href="#l26.221"></a><span id="l26.221">     {NS_NETWORK_PROTOCOL_CONTRACTID_PREFIX &quot;addbook&quot;, &amp;kNS_ADDBOOK_HANDLER_CID},</span>
<a href="#l26.222"></a><span id="l26.222">     {NS_CONTENT_HANDLER_CONTRACTID_PREFIX &quot;application/x-addvcard&quot;,</span>
<a href="#l26.223"></a><span id="l26.223">      &amp;kNS_ABCONTENTHANDLER_CID},</span>
<a href="#l26.224"></a><span id="l26.224">     {NS_CONTENT_HANDLER_CONTRACTID_PREFIX &quot;text/x-vcard&quot;,</span>
<a href="#l26.225"></a><span id="l26.225">      &amp;kNS_ABCONTENTHANDLER_CID},</span>
<a href="#l26.226"></a><span id="l26.226" class="difflineminus">-    {NS_ABDIRFACTORYSERVICE_CONTRACTID, &amp;kNS_ABDIRFACTORYSERVICE_CID},</span>
<a href="#l26.227"></a><span id="l26.227"> #if defined(MOZ_MAPI_SUPPORT)</span>
<a href="#l26.228"></a><span id="l26.228">     {NS_ABOUTLOOKDIRECTORY_CONTRACTID, &amp;kNS_ABOUTLOOKDIRECTORY_CID},</span>
<a href="#l26.229"></a><span id="l26.229">     {NS_ABOUTLOOKDIRFACTORY_CONTRACTID, &amp;kNS_ABOUTLOOKDIRFACTORY_CID},</span>
<a href="#l26.230"></a><span id="l26.230"> #endif</span>
<a href="#l26.231"></a><span id="l26.231">     {NS_ABDIRECTORYQUERYARGUMENTS_CONTRACTID,</span>
<a href="#l26.232"></a><span id="l26.232">      &amp;kNS_ABDIRECTORYQUERYARGUMENTS_CID},</span>
<a href="#l26.233"></a><span id="l26.233">     {NS_BOOLEANCONDITIONSTRING_CONTRACTID, &amp;kNS_BOOLEANCONDITIONSTRING_CID},</span>
<a href="#l26.234"></a><span id="l26.234">     {NS_BOOLEANEXPRESSION_CONTRACTID, &amp;kNS_BOOLEANEXPRESSION_CID},</span>
<a href="#l26.235"></a><span id="l26.235"> </span>
<a href="#l26.236"></a><span id="l26.236"> #if defined(MOZ_LDAP_XPCOM)</span>
<a href="#l26.237"></a><span id="l26.237">     {NS_ABLDAPDIRECTORY_CONTRACTID, &amp;kNS_ABLDAPDIRECTORY_CID},</span>
<a href="#l26.238"></a><span id="l26.238">     {NS_ABLDAPDIRECTORYQUERY_CONTRACTID, &amp;kNS_ABLDAPDIRECTORYQUERY_CID},</span>
<a href="#l26.239"></a><span id="l26.239">     {NS_ABLDAPCARD_CONTRACTID, &amp;kNS_ABLDAPCARD_CID},</span>
<a href="#l26.240"></a><span id="l26.240" class="difflineminus">-    {NS_ABLDAPDIRFACTORY_CONTRACTID, &amp;kNS_ABLDAPDIRFACTORY_CID},</span>
<a href="#l26.241"></a><span id="l26.241">     {NS_ABLDAP_REPLICATIONSERVICE_CONTRACTID,</span>
<a href="#l26.242"></a><span id="l26.242">      &amp;kNS_ABLDAP_REPLICATIONSERVICE_CID},</span>
<a href="#l26.243"></a><span id="l26.243">     {NS_ABLDAP_REPLICATIONQUERY_CONTRACTID, &amp;kNS_ABLDAP_REPLICATIONQUERY_CID},</span>
<a href="#l26.244"></a><span id="l26.244">     {NS_ABLDAP_PROCESSREPLICATIONDATA_CONTRACTID,</span>
<a href="#l26.245"></a><span id="l26.245">      &amp;kNS_ABLDAP_PROCESSREPLICATIONDATA_CID},</span>
<a href="#l26.246"></a><span id="l26.246" class="difflineminus">-    {NS_ABLDAPACDIRFACTORY_CONTRACTID, &amp;kNS_ABLDAPDIRFACTORY_CID},</span>
<a href="#l26.247"></a><span id="l26.247" class="difflineminus">-    {NS_ABLDAPSACDIRFACTORY_CONTRACTID, &amp;kNS_ABLDAPDIRFACTORY_CID},</span>
<a href="#l26.248"></a><span id="l26.248"> #endif</span>
<a href="#l26.249"></a><span id="l26.249"> </span>
<a href="#l26.250"></a><span id="l26.250">     {NS_ABDIRECTORYQUERYPROXY_CONTRACTID, &amp;kNS_ABDIRECTORYQUERYPROXY_CID},</span>
<a href="#l26.251"></a><span id="l26.251"> #ifdef XP_MACOSX</span>
<a href="#l26.252"></a><span id="l26.252">     {NS_ABOSXDIRECTORY_CONTRACTID, &amp;kNS_ABOSXDIRECTORY_CID},</span>
<a href="#l26.253"></a><span id="l26.253">     {NS_ABOSXCARD_CONTRACTID, &amp;kNS_ABOSXCARD_CID},</span>
<a href="#l26.254"></a><span id="l26.254" class="difflineminus">-    {NS_ABOSXDIRFACTORY_CONTRACTID, &amp;kNS_ABOSXDIRFACTORY_CID},</span>
<a href="#l26.255"></a><span id="l26.255"> #endif</span>
<a href="#l26.256"></a><span id="l26.256">     {NS_ABVIEW_CONTRACTID, &amp;kNS_ABVIEW_CID},</span>
<a href="#l26.257"></a><span id="l26.257">     {NS_MSGVCARDSERVICE_CONTRACTID, &amp;kNS_MSGVCARDSERVICE_CID},</span>
<a href="#l26.258"></a><span id="l26.258">     {NS_ABLDIFSERVICE_CONTRACTID, &amp;kNS_ABLDIFSERVICE_CID},</span>
<a href="#l26.259"></a><span id="l26.259">     // Bayesian Filter Entries</span>
<a href="#l26.260"></a><span id="l26.260">     {NS_BAYESIANFILTER_CONTRACTID, &amp;kNS_BAYESIANFILTER_CID},</span>
<a href="#l26.261"></a><span id="l26.261">     // Compose Entries</span>
<a href="#l26.262"></a><span id="l26.262">     {NS_MSGCOMPOSE_CONTRACTID, &amp;kNS_MSGCOMPOSE_CID},</span>
<a href="#l26.263"></a><span id="l26.263" class="difflineat">@@ -1337,18 +1309,16 @@ static const mozilla::Module::CategoryEn</span>
<a href="#l26.264"></a><span id="l26.264">     {&quot;content-policy&quot;, NS_MSGCONTENTPOLICY_CONTRACTID,</span>
<a href="#l26.265"></a><span id="l26.265">      NS_MSGCONTENTPOLICY_CONTRACTID},</span>
<a href="#l26.266"></a><span id="l26.266">     MAILNEWSDLF_CATEGORIES</span>
<a href="#l26.267"></a><span id="l26.267"> #ifdef XP_MACOSX</span>
<a href="#l26.268"></a><span id="l26.268">     {&quot;app-startup&quot;, NS_MESSENGEROSINTEGRATION_CONTRACTID,</span>
<a href="#l26.269"></a><span id="l26.269">      &quot;service,&quot; NS_MESSENGEROSINTEGRATION_CONTRACTID},</span>
<a href="#l26.270"></a><span id="l26.270"> #endif</span>
<a href="#l26.271"></a><span id="l26.271">     // Address Book Entries</span>
<a href="#l26.272"></a><span id="l26.272" class="difflineminus">-    {&quot;command-line-handler&quot;, &quot;m-addressbook&quot;,</span>
<a href="#l26.273"></a><span id="l26.273" class="difflineminus">-     NS_ABMANAGERSTARTUPHANDLER_CONTRACTID},</span>
<a href="#l26.274"></a><span id="l26.274">     // Bayesian Filter Entries</span>
<a href="#l26.275"></a><span id="l26.275">     // Compose Entries</span>
<a href="#l26.276"></a><span id="l26.276">     {&quot;command-line-handler&quot;, &quot;m-compose&quot;,</span>
<a href="#l26.277"></a><span id="l26.277">      NS_MSGCOMPOSESTARTUPHANDLER_CONTRACTID},</span>
<a href="#l26.278"></a><span id="l26.278">     // JsAccount Entries</span>
<a href="#l26.279"></a><span id="l26.279">     // Imap Entries</span>
<a href="#l26.280"></a><span id="l26.280">     // Local Entries</span>
<a href="#l26.281"></a><span id="l26.281">     // msgdb Entries</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:32Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

