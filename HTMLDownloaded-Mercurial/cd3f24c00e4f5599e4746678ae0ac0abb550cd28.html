<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 10725:cd3f24c00e4f5599e4746678ae0ac0abb550cd28</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ cd3f24c00e4f5599e4746678ae0ac0abb550cd28" />
<meta property="og:url" content="/comm-central/rev/cd3f24c00e4f5599e4746678ae0ac0abb550cd28" />
<meta property="og:description" content="Fix bug 757902 - Weekly and Monthly print layouts don't work, remove e4x usage (cpg fallout) (regression). r=mmecca/ssitter" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / cd3f24c00e4f5599e4746678ae0ac0abb550cd28 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/cd3f24c00e4f5599e4746678ae0ac0abb550cd28">shortlog</a> |
<a href="/comm-central/log/cd3f24c00e4f5599e4746678ae0ac0abb550cd28">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/cd3f24c00e4f5599e4746678ae0ac0abb550cd28">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/cd3f24c00e4f5599e4746678ae0ac0abb550cd28">files</a> |
changeset |
<a href="/comm-central/raw-rev/cd3f24c00e4f5599e4746678ae0ac0abb550cd28">raw</a>  | <a href="/comm-central/archive/cd3f24c00e4f5599e4746678ae0ac0abb550cd28.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
Fix <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=757902">bug 757902</a> - Weekly and Monthly print layouts don't work, remove e4x usage (cpg fallout) (regression). r=mmecca/ssitter
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#80;&#104;&#105;&#108;&#105;&#112;&#112;&#32;&#75;&#101;&#119;&#105;&#115;&#99;&#104;&#32;&#60;&#109;&#111;&#122;&#105;&#108;&#108;&#97;&#64;&#107;&#101;&#119;&#105;&#115;&#46;&#99;&#104;&#62;</td></tr>
<tr><td></td><td class="date age">Thu, 26 Jul 2012 16:47:06 +0200</td></tr>

<tr>
 <td>changeset 10725</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/cd3f24c00e4f5599e4746678ae0ac0abb550cd28">cd3f24c00e4f5599e4746678ae0ac0abb550cd28</a></td>
</tr>



<tr>
<td>parent 10724</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/3f7c3f2283978aba7312e0d4694becd7a7ad4e91">3f7c3f2283978aba7312e0d4694becd7a7ad4e91</a>
</td>
</tr>

<tr>
<td>child 10726</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/8fcc7b51d0a291008734b9dbe1e8be217df1f110">8fcc7b51d0a291008734b9dbe1e8be217df1f110</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=cd3f24c00e4f5599e4746678ae0ac0abb550cd28">8084</a></td></tr>
<tr><td>push user</td><td>mozilla@kewis.ch</td></tr>
<tr><td>push date</td><td class="date age">Thu, 26 Jul 2012 14:52:50 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@cd3f24c00e4f [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=cd3f24c00e4f5599e4746678ae0ac0abb550cd28">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=cd3f24c00e4f5599e4746678ae0ac0abb550cd28&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=cd3f24c00e4f5599e4746678ae0ac0abb550cd28&newProject=comm-central&newRevision=cd3f24c00e4f5599e4746678ae0ac0abb550cd28&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=cd3f24c00e4f5599e4746678ae0ac0abb550cd28&newProject=comm-central&newRevision=cd3f24c00e4f5599e4746678ae0ac0abb550cd28&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=cd3f24c00e4f5599e4746678ae0ac0abb550cd28&newProject=comm-central&newRevision=cd3f24c00e4f5599e4746678ae0ac0abb550cd28&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28mmecca%29&revcount=50">mmecca</a>, <a href="/comm-central/log?rev=reviewer%28ssitter%29&revcount=50">ssitter</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=757902">757902</a></td></tr>




</table></div>

<div class="page_body description">Fix <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=757902">bug 757902</a> - Weekly and Monthly print layouts don't work, remove e4x usage (cpg fallout) (regression). r=mmecca/ssitter</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/cd3f24c00e4f5599e4746678ae0ac0abb550cd28/calendar/base/content/dialogs/calendar-print-dialog.js">calendar/base/content/dialogs/calendar-print-dialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cd3f24c00e4f5599e4746678ae0ac0abb550cd28/calendar/base/content/dialogs/calendar-print-dialog.js">file</a> |
<a href="/comm-central/annotate/cd3f24c00e4f5599e4746678ae0ac0abb550cd28/calendar/base/content/dialogs/calendar-print-dialog.js">annotate</a> |
<a href="/comm-central/diff/cd3f24c00e4f5599e4746678ae0ac0abb550cd28/calendar/base/content/dialogs/calendar-print-dialog.js">diff</a> |
<a href="/comm-central/comparison/cd3f24c00e4f5599e4746678ae0ac0abb550cd28/calendar/base/content/dialogs/calendar-print-dialog.js">comparison</a> |
<a href="/comm-central/log/cd3f24c00e4f5599e4746678ae0ac0abb550cd28/calendar/base/content/dialogs/calendar-print-dialog.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/cd3f24c00e4f5599e4746678ae0ac0abb550cd28/calendar/base/content/dialogs/calendar-print-dialog.xul">calendar/base/content/dialogs/calendar-print-dialog.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cd3f24c00e4f5599e4746678ae0ac0abb550cd28/calendar/base/content/dialogs/calendar-print-dialog.xul">file</a> |
<a href="/comm-central/annotate/cd3f24c00e4f5599e4746678ae0ac0abb550cd28/calendar/base/content/dialogs/calendar-print-dialog.xul">annotate</a> |
<a href="/comm-central/diff/cd3f24c00e4f5599e4746678ae0ac0abb550cd28/calendar/base/content/dialogs/calendar-print-dialog.xul">diff</a> |
<a href="/comm-central/comparison/cd3f24c00e4f5599e4746678ae0ac0abb550cd28/calendar/base/content/dialogs/calendar-print-dialog.xul">comparison</a> |
<a href="/comm-central/log/cd3f24c00e4f5599e4746678ae0ac0abb550cd28/calendar/base/content/dialogs/calendar-print-dialog.xul">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/cd3f24c00e4f5599e4746678ae0ac0abb550cd28/calendar/base/modules/calPrintUtils.jsm">calendar/base/modules/calPrintUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cd3f24c00e4f5599e4746678ae0ac0abb550cd28/calendar/base/modules/calPrintUtils.jsm">file</a> |
<a href="/comm-central/annotate/cd3f24c00e4f5599e4746678ae0ac0abb550cd28/calendar/base/modules/calPrintUtils.jsm">annotate</a> |
<a href="/comm-central/diff/cd3f24c00e4f5599e4746678ae0ac0abb550cd28/calendar/base/modules/calPrintUtils.jsm">diff</a> |
<a href="/comm-central/comparison/cd3f24c00e4f5599e4746678ae0ac0abb550cd28/calendar/base/modules/calPrintUtils.jsm">comparison</a> |
<a href="/comm-central/log/cd3f24c00e4f5599e4746678ae0ac0abb550cd28/calendar/base/modules/calPrintUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/cd3f24c00e4f5599e4746678ae0ac0abb550cd28/calendar/base/modules/calUtils.jsm">calendar/base/modules/calUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cd3f24c00e4f5599e4746678ae0ac0abb550cd28/calendar/base/modules/calUtils.jsm">file</a> |
<a href="/comm-central/annotate/cd3f24c00e4f5599e4746678ae0ac0abb550cd28/calendar/base/modules/calUtils.jsm">annotate</a> |
<a href="/comm-central/diff/cd3f24c00e4f5599e4746678ae0ac0abb550cd28/calendar/base/modules/calUtils.jsm">diff</a> |
<a href="/comm-central/comparison/cd3f24c00e4f5599e4746678ae0ac0abb550cd28/calendar/base/modules/calUtils.jsm">comparison</a> |
<a href="/comm-central/log/cd3f24c00e4f5599e4746678ae0ac0abb550cd28/calendar/base/modules/calUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/cd3f24c00e4f5599e4746678ae0ac0abb550cd28/calendar/base/modules/calXMLUtils.jsm">calendar/base/modules/calXMLUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cd3f24c00e4f5599e4746678ae0ac0abb550cd28/calendar/base/modules/calXMLUtils.jsm">file</a> |
<a href="/comm-central/annotate/cd3f24c00e4f5599e4746678ae0ac0abb550cd28/calendar/base/modules/calXMLUtils.jsm">annotate</a> |
<a href="/comm-central/diff/cd3f24c00e4f5599e4746678ae0ac0abb550cd28/calendar/base/modules/calXMLUtils.jsm">diff</a> |
<a href="/comm-central/comparison/cd3f24c00e4f5599e4746678ae0ac0abb550cd28/calendar/base/modules/calXMLUtils.jsm">comparison</a> |
<a href="/comm-central/log/cd3f24c00e4f5599e4746678ae0ac0abb550cd28/calendar/base/modules/calXMLUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/cd3f24c00e4f5599e4746678ae0ac0abb550cd28/calendar/base/public/calIDateTimeFormatter.idl">calendar/base/public/calIDateTimeFormatter.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cd3f24c00e4f5599e4746678ae0ac0abb550cd28/calendar/base/public/calIDateTimeFormatter.idl">file</a> |
<a href="/comm-central/annotate/cd3f24c00e4f5599e4746678ae0ac0abb550cd28/calendar/base/public/calIDateTimeFormatter.idl">annotate</a> |
<a href="/comm-central/diff/cd3f24c00e4f5599e4746678ae0ac0abb550cd28/calendar/base/public/calIDateTimeFormatter.idl">diff</a> |
<a href="/comm-central/comparison/cd3f24c00e4f5599e4746678ae0ac0abb550cd28/calendar/base/public/calIDateTimeFormatter.idl">comparison</a> |
<a href="/comm-central/log/cd3f24c00e4f5599e4746678ae0ac0abb550cd28/calendar/base/public/calIDateTimeFormatter.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/cd3f24c00e4f5599e4746678ae0ac0abb550cd28/calendar/base/src/calDateTimeFormatter.js">calendar/base/src/calDateTimeFormatter.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cd3f24c00e4f5599e4746678ae0ac0abb550cd28/calendar/base/src/calDateTimeFormatter.js">file</a> |
<a href="/comm-central/annotate/cd3f24c00e4f5599e4746678ae0ac0abb550cd28/calendar/base/src/calDateTimeFormatter.js">annotate</a> |
<a href="/comm-central/diff/cd3f24c00e4f5599e4746678ae0ac0abb550cd28/calendar/base/src/calDateTimeFormatter.js">diff</a> |
<a href="/comm-central/comparison/cd3f24c00e4f5599e4746678ae0ac0abb550cd28/calendar/base/src/calDateTimeFormatter.js">comparison</a> |
<a href="/comm-central/log/cd3f24c00e4f5599e4746678ae0ac0abb550cd28/calendar/base/src/calDateTimeFormatter.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/cd3f24c00e4f5599e4746678ae0ac0abb550cd28/calendar/import-export/calHtmlExport.html">calendar/import-export/calHtmlExport.html</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cd3f24c00e4f5599e4746678ae0ac0abb550cd28/calendar/import-export/calHtmlExport.html">file</a> |
<a href="/comm-central/annotate/cd3f24c00e4f5599e4746678ae0ac0abb550cd28/calendar/import-export/calHtmlExport.html">annotate</a> |
<a href="/comm-central/diff/cd3f24c00e4f5599e4746678ae0ac0abb550cd28/calendar/import-export/calHtmlExport.html">diff</a> |
<a href="/comm-central/comparison/cd3f24c00e4f5599e4746678ae0ac0abb550cd28/calendar/import-export/calHtmlExport.html">comparison</a> |
<a href="/comm-central/log/cd3f24c00e4f5599e4746678ae0ac0abb550cd28/calendar/import-export/calHtmlExport.html">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/cd3f24c00e4f5599e4746678ae0ac0abb550cd28/calendar/import-export/calHtmlExport.js">calendar/import-export/calHtmlExport.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cd3f24c00e4f5599e4746678ae0ac0abb550cd28/calendar/import-export/calHtmlExport.js">file</a> |
<a href="/comm-central/annotate/cd3f24c00e4f5599e4746678ae0ac0abb550cd28/calendar/import-export/calHtmlExport.js">annotate</a> |
<a href="/comm-central/diff/cd3f24c00e4f5599e4746678ae0ac0abb550cd28/calendar/import-export/calHtmlExport.js">diff</a> |
<a href="/comm-central/comparison/cd3f24c00e4f5599e4746678ae0ac0abb550cd28/calendar/import-export/calHtmlExport.js">comparison</a> |
<a href="/comm-central/log/cd3f24c00e4f5599e4746678ae0ac0abb550cd28/calendar/import-export/calHtmlExport.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/cd3f24c00e4f5599e4746678ae0ac0abb550cd28/calendar/import-export/calIcsImportExport.js">calendar/import-export/calIcsImportExport.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cd3f24c00e4f5599e4746678ae0ac0abb550cd28/calendar/import-export/calIcsImportExport.js">file</a> |
<a href="/comm-central/annotate/cd3f24c00e4f5599e4746678ae0ac0abb550cd28/calendar/import-export/calIcsImportExport.js">annotate</a> |
<a href="/comm-central/diff/cd3f24c00e4f5599e4746678ae0ac0abb550cd28/calendar/import-export/calIcsImportExport.js">diff</a> |
<a href="/comm-central/comparison/cd3f24c00e4f5599e4746678ae0ac0abb550cd28/calendar/import-export/calIcsImportExport.js">comparison</a> |
<a href="/comm-central/log/cd3f24c00e4f5599e4746678ae0ac0abb550cd28/calendar/import-export/calIcsImportExport.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/cd3f24c00e4f5599e4746678ae0ac0abb550cd28/calendar/import-export/calListFormatter.js">calendar/import-export/calListFormatter.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cd3f24c00e4f5599e4746678ae0ac0abb550cd28/calendar/import-export/calListFormatter.js">file</a> |
<a href="/comm-central/annotate/cd3f24c00e4f5599e4746678ae0ac0abb550cd28/calendar/import-export/calListFormatter.js">annotate</a> |
<a href="/comm-central/diff/cd3f24c00e4f5599e4746678ae0ac0abb550cd28/calendar/import-export/calListFormatter.js">diff</a> |
<a href="/comm-central/comparison/cd3f24c00e4f5599e4746678ae0ac0abb550cd28/calendar/import-export/calListFormatter.js">comparison</a> |
<a href="/comm-central/log/cd3f24c00e4f5599e4746678ae0ac0abb550cd28/calendar/import-export/calListFormatter.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/cd3f24c00e4f5599e4746678ae0ac0abb550cd28/calendar/import-export/calMonthGridPrinter.html">calendar/import-export/calMonthGridPrinter.html</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cd3f24c00e4f5599e4746678ae0ac0abb550cd28/calendar/import-export/calMonthGridPrinter.html">file</a> |
<a href="/comm-central/annotate/cd3f24c00e4f5599e4746678ae0ac0abb550cd28/calendar/import-export/calMonthGridPrinter.html">annotate</a> |
<a href="/comm-central/diff/cd3f24c00e4f5599e4746678ae0ac0abb550cd28/calendar/import-export/calMonthGridPrinter.html">diff</a> |
<a href="/comm-central/comparison/cd3f24c00e4f5599e4746678ae0ac0abb550cd28/calendar/import-export/calMonthGridPrinter.html">comparison</a> |
<a href="/comm-central/log/cd3f24c00e4f5599e4746678ae0ac0abb550cd28/calendar/import-export/calMonthGridPrinter.html">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/cd3f24c00e4f5599e4746678ae0ac0abb550cd28/calendar/import-export/calMonthGridPrinter.js">calendar/import-export/calMonthGridPrinter.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cd3f24c00e4f5599e4746678ae0ac0abb550cd28/calendar/import-export/calMonthGridPrinter.js">file</a> |
<a href="/comm-central/annotate/cd3f24c00e4f5599e4746678ae0ac0abb550cd28/calendar/import-export/calMonthGridPrinter.js">annotate</a> |
<a href="/comm-central/diff/cd3f24c00e4f5599e4746678ae0ac0abb550cd28/calendar/import-export/calMonthGridPrinter.js">diff</a> |
<a href="/comm-central/comparison/cd3f24c00e4f5599e4746678ae0ac0abb550cd28/calendar/import-export/calMonthGridPrinter.js">comparison</a> |
<a href="/comm-central/log/cd3f24c00e4f5599e4746678ae0ac0abb550cd28/calendar/import-export/calMonthGridPrinter.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/cd3f24c00e4f5599e4746678ae0ac0abb550cd28/calendar/import-export/calWeekPrinter.html">calendar/import-export/calWeekPrinter.html</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cd3f24c00e4f5599e4746678ae0ac0abb550cd28/calendar/import-export/calWeekPrinter.html">file</a> |
<a href="/comm-central/annotate/cd3f24c00e4f5599e4746678ae0ac0abb550cd28/calendar/import-export/calWeekPrinter.html">annotate</a> |
<a href="/comm-central/diff/cd3f24c00e4f5599e4746678ae0ac0abb550cd28/calendar/import-export/calWeekPrinter.html">diff</a> |
<a href="/comm-central/comparison/cd3f24c00e4f5599e4746678ae0ac0abb550cd28/calendar/import-export/calWeekPrinter.html">comparison</a> |
<a href="/comm-central/log/cd3f24c00e4f5599e4746678ae0ac0abb550cd28/calendar/import-export/calWeekPrinter.html">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/cd3f24c00e4f5599e4746678ae0ac0abb550cd28/calendar/import-export/calWeekPrinter.js">calendar/import-export/calWeekPrinter.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cd3f24c00e4f5599e4746678ae0ac0abb550cd28/calendar/import-export/calWeekPrinter.js">file</a> |
<a href="/comm-central/annotate/cd3f24c00e4f5599e4746678ae0ac0abb550cd28/calendar/import-export/calWeekPrinter.js">annotate</a> |
<a href="/comm-central/diff/cd3f24c00e4f5599e4746678ae0ac0abb550cd28/calendar/import-export/calWeekPrinter.js">diff</a> |
<a href="/comm-central/comparison/cd3f24c00e4f5599e4746678ae0ac0abb550cd28/calendar/import-export/calWeekPrinter.js">comparison</a> |
<a href="/comm-central/log/cd3f24c00e4f5599e4746678ae0ac0abb550cd28/calendar/import-export/calWeekPrinter.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/cd3f24c00e4f5599e4746678ae0ac0abb550cd28/calendar/import-export/jar.mn">calendar/import-export/jar.mn</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cd3f24c00e4f5599e4746678ae0ac0abb550cd28/calendar/import-export/jar.mn">file</a> |
<a href="/comm-central/annotate/cd3f24c00e4f5599e4746678ae0ac0abb550cd28/calendar/import-export/jar.mn">annotate</a> |
<a href="/comm-central/diff/cd3f24c00e4f5599e4746678ae0ac0abb550cd28/calendar/import-export/jar.mn">diff</a> |
<a href="/comm-central/comparison/cd3f24c00e4f5599e4746678ae0ac0abb550cd28/calendar/import-export/jar.mn">comparison</a> |
<a href="/comm-central/log/cd3f24c00e4f5599e4746678ae0ac0abb550cd28/calendar/import-export/jar.mn">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/cd3f24c00e4f5599e4746678ae0ac0abb550cd28/calendar/lightning/components/lightningTextCalendarConverter.js">calendar/lightning/components/lightningTextCalendarConverter.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cd3f24c00e4f5599e4746678ae0ac0abb550cd28/calendar/lightning/components/lightningTextCalendarConverter.js">file</a> |
<a href="/comm-central/annotate/cd3f24c00e4f5599e4746678ae0ac0abb550cd28/calendar/lightning/components/lightningTextCalendarConverter.js">annotate</a> |
<a href="/comm-central/diff/cd3f24c00e4f5599e4746678ae0ac0abb550cd28/calendar/lightning/components/lightningTextCalendarConverter.js">diff</a> |
<a href="/comm-central/comparison/cd3f24c00e4f5599e4746678ae0ac0abb550cd28/calendar/lightning/components/lightningTextCalendarConverter.js">comparison</a> |
<a href="/comm-central/log/cd3f24c00e4f5599e4746678ae0ac0abb550cd28/calendar/lightning/components/lightningTextCalendarConverter.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-print-dialog.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-print-dialog.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -54,25 +54,85 @@ function loadCalendarPrintDialog() {</span>
<a href="#l1.4"></a><span id="l1.4">     opener.setCursor(&quot;auto&quot;);</span>
<a href="#l1.5"></a><span id="l1.5"> </span>
<a href="#l1.6"></a><span id="l1.6">     refreshHtml();</span>
<a href="#l1.7"></a><span id="l1.7"> </span>
<a href="#l1.8"></a><span id="l1.8">     self.focus();</span>
<a href="#l1.9"></a><span id="l1.9"> }</span>
<a href="#l1.10"></a><span id="l1.10"> </span>
<a href="#l1.11"></a><span id="l1.11"> /**</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">- * Gets the settings from the dialog's UI widgets.</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">- * notifies an Object with title, layoutCId, eventList, start, and end</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineminus">- *          properties containing the appropriate values.</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+ * Retrieves a settings object containing info on what to print. The</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineplus">+ * receiverFunc will be called with the settings object containing various print</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineplus">+ * settings.</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineplus">+ *</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineplus">+ * @param receiverFunc  The callback function to call on completion.</span>
<a href="#l1.20"></a><span id="l1.20">  */</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineminus">-function getEventsAndDialogSettings(receiverFunc) {</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineminus">-    let settings = getWhatToPrintSettings();</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineminus">-    if (settings.eventList.length != 0) {</span>
<a href="#l1.24"></a><span id="l1.24" class="difflineminus">-        receiverFunc(settings);</span>
<a href="#l1.25"></a><span id="l1.25" class="difflineminus">-    } else {</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineplus">+function getPrintSettings(receiverFunc) {</span>
<a href="#l1.27"></a><span id="l1.27" class="difflineplus">+    let tempTitle = document.getElementById(&quot;title-field&quot;).value;</span>
<a href="#l1.28"></a><span id="l1.28" class="difflineplus">+    let settings = new Object();</span>
<a href="#l1.29"></a><span id="l1.29" class="difflineplus">+    let requiresFetch = true;</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineplus">+    settings.title = (tempTitle || calGetString(&quot;calendar&quot;, &quot;Untitled&quot;));</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineplus">+    settings.layoutCId = document.getElementById(&quot;layout-field&quot;).value;</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineplus">+    settings.start = null;</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineplus">+    settings.end = null;</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineplus">+    settings.eventList = [];</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineplus">+    settings.printEvents = document.getElementById(&quot;events&quot;).checked;</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineplus">+    settings.printTasks = document.getElementById(&quot;tasks&quot;).checked;</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineplus">+    settings.printCompletedTasks = document.getElementById(&quot;completed-tasks&quot;).checked;</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineplus">+    settings.printTasksWithNoDueDate = document.getElementById(&quot;tasks-with-no-due-date&quot;).checked;</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineplus">+    var theView = getCalendarView();</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineplus">+    switch (document.getElementById(&quot;view-field&quot;).selectedItem.value) {</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineplus">+    case 'currentView':</span>
<a href="#l1.42"></a><span id="l1.42" class="difflineplus">+    case '': //just in case</span>
<a href="#l1.43"></a><span id="l1.43" class="difflineplus">+        settings.start = theView.startDay.clone();</span>
<a href="#l1.44"></a><span id="l1.44" class="difflineplus">+        settings.end = theView.endDay.clone();</span>
<a href="#l1.45"></a><span id="l1.45" class="difflineplus">+        settings.end.day += 1;</span>
<a href="#l1.46"></a><span id="l1.46" class="difflineplus">+        settings.start.isDate = false;</span>
<a href="#l1.47"></a><span id="l1.47" class="difflineplus">+        settings.end.isDate = false;</span>
<a href="#l1.48"></a><span id="l1.48" class="difflineplus">+        break;</span>
<a href="#l1.49"></a><span id="l1.49" class="difflineplus">+    case 'selected': {</span>
<a href="#l1.50"></a><span id="l1.50" class="difflineplus">+        let selectedItems = theView.getSelectedItems({});</span>
<a href="#l1.51"></a><span id="l1.51" class="difflineplus">+        settings.eventList = selectedItems.filter(function(item) {</span>
<a href="#l1.52"></a><span id="l1.52" class="difflineplus">+            if (cal.isEvent(item) &amp;&amp; !settings.printEvents) return false;</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineplus">+            if (cal.isToDo(item) &amp;&amp; !settings.printTasks) return false;</span>
<a href="#l1.54"></a><span id="l1.54" class="difflineplus">+            return true;</span>
<a href="#l1.55"></a><span id="l1.55" class="difflineplus">+        });</span>
<a href="#l1.56"></a><span id="l1.56" class="difflineplus">+</span>
<a href="#l1.57"></a><span id="l1.57" class="difflineplus">+        // If tasks should be printed, also include selected tasks from the</span>
<a href="#l1.58"></a><span id="l1.58" class="difflineplus">+        // opening window.</span>
<a href="#l1.59"></a><span id="l1.59" class="difflineplus">+        if (settings.printTasks) {</span>
<a href="#l1.60"></a><span id="l1.60" class="difflineplus">+            let selectedTasks = window.opener.getSelectedTasks();</span>
<a href="#l1.61"></a><span id="l1.61" class="difflineplus">+            for each (var task in selectedTasks) {</span>
<a href="#l1.62"></a><span id="l1.62" class="difflineplus">+                settings.eventList.push(task);</span>
<a href="#l1.63"></a><span id="l1.63" class="difflineplus">+            }</span>
<a href="#l1.64"></a><span id="l1.64" class="difflineplus">+        }</span>
<a href="#l1.65"></a><span id="l1.65" class="difflineplus">+</span>
<a href="#l1.66"></a><span id="l1.66" class="difflineplus">+        // We've set the event list above, no need to fetch items below.</span>
<a href="#l1.67"></a><span id="l1.67" class="difflineplus">+        requiresFetch = false;</span>
<a href="#l1.68"></a><span id="l1.68" class="difflineplus">+        break;</span>
<a href="#l1.69"></a><span id="l1.69" class="difflineplus">+    }</span>
<a href="#l1.70"></a><span id="l1.70" class="difflineplus">+    case 'custom':</span>
<a href="#l1.71"></a><span id="l1.71" class="difflineplus">+        // We return the time from the timepickers using the selected</span>
<a href="#l1.72"></a><span id="l1.72" class="difflineplus">+        // timezone, as not doing so in timezones with a positive offset</span>
<a href="#l1.73"></a><span id="l1.73" class="difflineplus">+        // from UTC may cause the printout to include the wrong days.</span>
<a href="#l1.74"></a><span id="l1.74" class="difflineplus">+        var currentTimezone = calendarDefaultTimezone();</span>
<a href="#l1.75"></a><span id="l1.75" class="difflineplus">+        settings.start = jsDateToDateTime(document.getElementById(&quot;start-date-picker&quot;).value);</span>
<a href="#l1.76"></a><span id="l1.76" class="difflineplus">+        settings.start = settings.start.getInTimezone(currentTimezone);</span>
<a href="#l1.77"></a><span id="l1.77" class="difflineplus">+        settings.end = jsDateToDateTime(document.getElementById(&quot;end-date-picker&quot;).value);</span>
<a href="#l1.78"></a><span id="l1.78" class="difflineplus">+        settings.end = settings.end.getInTimezone(currentTimezone);</span>
<a href="#l1.79"></a><span id="l1.79" class="difflineplus">+        settings.end = settings.end.clone();</span>
<a href="#l1.80"></a><span id="l1.80" class="difflineplus">+        settings.end.day += 1;</span>
<a href="#l1.81"></a><span id="l1.81" class="difflineplus">+        break ;</span>
<a href="#l1.82"></a><span id="l1.82" class="difflineplus">+    default:</span>
<a href="#l1.83"></a><span id="l1.83" class="difflineplus">+        dump(&quot;Error : no case in printDialog.js::printCalendar()&quot;);</span>
<a href="#l1.84"></a><span id="l1.84" class="difflineplus">+    }</span>
<a href="#l1.85"></a><span id="l1.85" class="difflineplus">+</span>
<a href="#l1.86"></a><span id="l1.86" class="difflineplus">+    // Some filters above might have filled the events list themselves. If not,</span>
<a href="#l1.87"></a><span id="l1.87" class="difflineplus">+    // then fetch the items here.</span>
<a href="#l1.88"></a><span id="l1.88" class="difflineplus">+    if (requiresFetch) {</span>
<a href="#l1.89"></a><span id="l1.89">         let listener = {</span>
<a href="#l1.90"></a><span id="l1.90">             onOperationComplete:</span>
<a href="#l1.91"></a><span id="l1.91">             function onOperationComplete(aCalendar, aStatus, aOperationType, aId, aDateTime) {</span>
<a href="#l1.92"></a><span id="l1.92">                 receiverFunc(settings);</span>
<a href="#l1.93"></a><span id="l1.93">             },</span>
<a href="#l1.94"></a><span id="l1.94">             onGetResult:</span>
<a href="#l1.95"></a><span id="l1.95">             function onGetResult(aCalendar, aStatus, aItemType, aDetail, aCount, aItems) {</span>
<a href="#l1.96"></a><span id="l1.96">                 settings.eventList = settings.eventList.concat(aItems);</span>
<a href="#l1.97"></a><span id="l1.97" class="difflineat">@@ -82,76 +142,29 @@ function getEventsAndDialogSettings(rece</span>
<a href="#l1.98"></a><span id="l1.98">                         if (item.dueDate || item.endDate) {</span>
<a href="#l1.99"></a><span id="l1.99">                             eventWithDueDate.push(item)</span>
<a href="#l1.100"></a><span id="l1.100">                         }</span>
<a href="#l1.101"></a><span id="l1.101">                     }</span>
<a href="#l1.102"></a><span id="l1.102">                     settings.eventList = eventWithDueDate;</span>
<a href="#l1.103"></a><span id="l1.103">                 }</span>
<a href="#l1.104"></a><span id="l1.104">             }</span>
<a href="#l1.105"></a><span id="l1.105">         };</span>
<a href="#l1.106"></a><span id="l1.106" class="difflineminus">-        window.opener.getCompositeCalendar().getItems(getFilter(settings), 0, settings.start, settings.end, listener);</span>
<a href="#l1.107"></a><span id="l1.107" class="difflineplus">+        let filter = getFilter(settings);</span>
<a href="#l1.108"></a><span id="l1.108" class="difflineplus">+        if (filter) {</span>
<a href="#l1.109"></a><span id="l1.109" class="difflineplus">+            window.opener.getCompositeCalendar().getItems(filter, 0, settings.start, settings.end, listener);</span>
<a href="#l1.110"></a><span id="l1.110" class="difflineplus">+        } else {</span>
<a href="#l1.111"></a><span id="l1.111" class="difflineplus">+            // No filter means no items, just complete with the empty list set above</span>
<a href="#l1.112"></a><span id="l1.112" class="difflineplus">+            receiverFunc(settings);</span>
<a href="#l1.113"></a><span id="l1.113" class="difflineplus">+        }</span>
<a href="#l1.114"></a><span id="l1.114" class="difflineplus">+    } else {</span>
<a href="#l1.115"></a><span id="l1.115" class="difflineplus">+        receiverFunc(settings);</span>
<a href="#l1.116"></a><span id="l1.116">     }</span>
<a href="#l1.117"></a><span id="l1.117"> }</span>
<a href="#l1.118"></a><span id="l1.118"> </span>
<a href="#l1.119"></a><span id="l1.119"> /**</span>
<a href="#l1.120"></a><span id="l1.120" class="difflineminus">- * Retrieves a settings object containing info on what to print</span>
<a href="#l1.121"></a><span id="l1.121" class="difflineminus">- *</span>
<a href="#l1.122"></a><span id="l1.122" class="difflineminus">- * @return      The settings object with all print settings</span>
<a href="#l1.123"></a><span id="l1.123" class="difflineminus">- */</span>
<a href="#l1.124"></a><span id="l1.124" class="difflineminus">-function getWhatToPrintSettings() {</span>
<a href="#l1.125"></a><span id="l1.125" class="difflineminus">-    let tempTitle = document.getElementById(&quot;title-field&quot;).value;</span>
<a href="#l1.126"></a><span id="l1.126" class="difflineminus">-    let settings = new Object();</span>
<a href="#l1.127"></a><span id="l1.127" class="difflineminus">-    settings.title = (tempTitle || calGetString(&quot;calendar&quot;, &quot;Untitled&quot;));</span>
<a href="#l1.128"></a><span id="l1.128" class="difflineminus">-    settings.layoutCId = document.getElementById(&quot;layout-field&quot;).value;</span>
<a href="#l1.129"></a><span id="l1.129" class="difflineminus">-    settings.start = null;</span>
<a href="#l1.130"></a><span id="l1.130" class="difflineminus">-    settings.end = null;</span>
<a href="#l1.131"></a><span id="l1.131" class="difflineminus">-    settings.eventList = [];</span>
<a href="#l1.132"></a><span id="l1.132" class="difflineminus">-    settings.printEvents = document.getElementById(&quot;events&quot;).checked;</span>
<a href="#l1.133"></a><span id="l1.133" class="difflineminus">-    settings.printTasks = document.getElementById(&quot;tasks&quot;).checked;</span>
<a href="#l1.134"></a><span id="l1.134" class="difflineminus">-    settings.printCompletedTasks = document.getElementById(&quot;completed-tasks&quot;).checked;</span>
<a href="#l1.135"></a><span id="l1.135" class="difflineminus">-    settings.printTasksWithNoDueDate = document.getElementById(&quot;tasks-with-no-due-date&quot;).checked;</span>
<a href="#l1.136"></a><span id="l1.136" class="difflineminus">-    var theView = getCalendarView();</span>
<a href="#l1.137"></a><span id="l1.137" class="difflineminus">-    switch (document.getElementById(&quot;view-field&quot;).selectedItem.value) {</span>
<a href="#l1.138"></a><span id="l1.138" class="difflineminus">-    case 'currentView':</span>
<a href="#l1.139"></a><span id="l1.139" class="difflineminus">-    case '': //just in case</span>
<a href="#l1.140"></a><span id="l1.140" class="difflineminus">-        settings.start = theView.startDay;</span>
<a href="#l1.141"></a><span id="l1.141" class="difflineminus">-        settings.end = theView.endDay;</span>
<a href="#l1.142"></a><span id="l1.142" class="difflineminus">-        settings.end = settings.end.clone();</span>
<a href="#l1.143"></a><span id="l1.143" class="difflineminus">-        settings.end.day += 1;</span>
<a href="#l1.144"></a><span id="l1.144" class="difflineminus">-        break;</span>
<a href="#l1.145"></a><span id="l1.145" class="difflineminus">-    case 'selected':</span>
<a href="#l1.146"></a><span id="l1.146" class="difflineminus">-        if (settings.printEvents) {</span>
<a href="#l1.147"></a><span id="l1.147" class="difflineminus">-            settings.eventList = theView.getSelectedItems({});</span>
<a href="#l1.148"></a><span id="l1.148" class="difflineminus">-        }</span>
<a href="#l1.149"></a><span id="l1.149" class="difflineminus">-        if (settings.printTasks) {</span>
<a href="#l1.150"></a><span id="l1.150" class="difflineminus">-            let selectedTasks = window.opener.document.getElementById(&quot;unifinder-todo-tree&quot;).selectedTasks;</span>
<a href="#l1.151"></a><span id="l1.151" class="difflineminus">-            for each (var task in selectedTasks) {</span>
<a href="#l1.152"></a><span id="l1.152" class="difflineminus">-                settings.eventList.push(task);</span>
<a href="#l1.153"></a><span id="l1.153" class="difflineminus">-            }</span>
<a href="#l1.154"></a><span id="l1.154" class="difflineminus">-        }</span>
<a href="#l1.155"></a><span id="l1.155" class="difflineminus">-        break;</span>
<a href="#l1.156"></a><span id="l1.156" class="difflineminus">-    case 'custom':</span>
<a href="#l1.157"></a><span id="l1.157" class="difflineminus">-        // We return the time from the timepickers using the selected</span>
<a href="#l1.158"></a><span id="l1.158" class="difflineminus">-        // timezone, as not doing so in timezones with a positive offset</span>
<a href="#l1.159"></a><span id="l1.159" class="difflineminus">-        // from UTC may cause the printout to include the wrong days.</span>
<a href="#l1.160"></a><span id="l1.160" class="difflineminus">-        var currentTimezone = calendarDefaultTimezone();</span>
<a href="#l1.161"></a><span id="l1.161" class="difflineminus">-        settings.start = jsDateToDateTime(document.getElementById(&quot;start-date-picker&quot;).value);</span>
<a href="#l1.162"></a><span id="l1.162" class="difflineminus">-        settings.start = settings.start.getInTimezone(currentTimezone);</span>
<a href="#l1.163"></a><span id="l1.163" class="difflineminus">-        settings.end = jsDateToDateTime(document.getElementById(&quot;end-date-picker&quot;).value);</span>
<a href="#l1.164"></a><span id="l1.164" class="difflineminus">-        settings.end = settings.end.getInTimezone(currentTimezone);</span>
<a href="#l1.165"></a><span id="l1.165" class="difflineminus">-        settings.end = settings.end.clone();</span>
<a href="#l1.166"></a><span id="l1.166" class="difflineminus">-        settings.end.day += 1;</span>
<a href="#l1.167"></a><span id="l1.167" class="difflineminus">-        break ;</span>
<a href="#l1.168"></a><span id="l1.168" class="difflineminus">-    default:</span>
<a href="#l1.169"></a><span id="l1.169" class="difflineminus">-        dump(&quot;Error : no case in printDialog.js::printCalendar()&quot;);</span>
<a href="#l1.170"></a><span id="l1.170" class="difflineminus">-    }</span>
<a href="#l1.171"></a><span id="l1.171" class="difflineminus">-    return settings;</span>
<a href="#l1.172"></a><span id="l1.172" class="difflineminus">-}</span>
<a href="#l1.173"></a><span id="l1.173" class="difflineminus">-</span>
<a href="#l1.174"></a><span id="l1.174" class="difflineminus">-/**</span>
<a href="#l1.175"></a><span id="l1.175">  * Sets up the filter for a getItems call based on the javascript settings</span>
<a href="#l1.176"></a><span id="l1.176">  * object</span>
<a href="#l1.177"></a><span id="l1.177">  *</span>
<a href="#l1.178"></a><span id="l1.178">  * @param settings      The settings data to base upon</span>
<a href="#l1.179"></a><span id="l1.179">  */</span>
<a href="#l1.180"></a><span id="l1.180"> function getFilter(settings) {</span>
<a href="#l1.181"></a><span id="l1.181">     let filter = 0;</span>
<a href="#l1.182"></a><span id="l1.182">     if (settings.printTasks) {</span>
<a href="#l1.183"></a><span id="l1.183" class="difflineat">@@ -171,25 +184,17 @@ function getFilter(settings) {</span>
<a href="#l1.184"></a><span id="l1.184"> }</span>
<a href="#l1.185"></a><span id="l1.185"> </span>
<a href="#l1.186"></a><span id="l1.186"> /**</span>
<a href="#l1.187"></a><span id="l1.187">  * Looks at the selections the user has made (start date, layout, etc.), and</span>
<a href="#l1.188"></a><span id="l1.188">  * updates the HTML in the iframe accordingly. This is also called when a</span>
<a href="#l1.189"></a><span id="l1.189">  * dialog UI element has changed, since we'll want to refresh the preview.</span>
<a href="#l1.190"></a><span id="l1.190">  */</span>
<a href="#l1.191"></a><span id="l1.191"> function refreshHtml(finishFunc) {</span>
<a href="#l1.192"></a><span id="l1.192" class="difflineminus">-    if (document.documentElement.getButton(&quot;accept&quot;).disabled) {</span>
<a href="#l1.193"></a><span id="l1.193" class="difflineminus">-        // If the accept button is disabled, then something wants us to not</span>
<a href="#l1.194"></a><span id="l1.194" class="difflineminus">-        // print. Bail out before refreshing the html, otherwise errors might</span>
<a href="#l1.195"></a><span id="l1.195" class="difflineminus">-        // occur. Don't call the finish func, its expected to be called on</span>
<a href="#l1.196"></a><span id="l1.196" class="difflineminus">-        // success.</span>
<a href="#l1.197"></a><span id="l1.197" class="difflineminus">-        return;</span>
<a href="#l1.198"></a><span id="l1.198" class="difflineminus">-    }</span>
<a href="#l1.199"></a><span id="l1.199" class="difflineminus">-    getEventsAndDialogSettings(</span>
<a href="#l1.200"></a><span id="l1.200" class="difflineminus">-        function getEventsAndDialogSettings_response(settings) {</span>
<a href="#l1.201"></a><span id="l1.201" class="difflineplus">+    getPrintSettings(function getSettingsResponse(settings) {</span>
<a href="#l1.202"></a><span id="l1.202">             document.title = calGetString(&quot;calendar&quot;, &quot;PrintPreviewWindowTitle&quot;, [settings.title]);</span>
<a href="#l1.203"></a><span id="l1.203"> </span>
<a href="#l1.204"></a><span id="l1.204">             let printformatter = Components.classes[settings.layoutCId]</span>
<a href="#l1.205"></a><span id="l1.205">                                            .createInstance(Components.interfaces.calIPrintFormatter);</span>
<a href="#l1.206"></a><span id="l1.206">             let html = &quot;&quot;;</span>
<a href="#l1.207"></a><span id="l1.207">             try {</span>
<a href="#l1.208"></a><span id="l1.208">                 let pipe = Components.classes[&quot;@mozilla.org/pipe;1&quot;]</span>
<a href="#l1.209"></a><span id="l1.209">                                      .createInstance(Components.interfaces.nsIPipe);</span>
<a href="#l1.210"></a><span id="l1.210" class="difflineat">@@ -281,23 +286,10 @@ function printAndClose() {</span>
<a href="#l1.211"></a><span id="l1.211">     return false; // leave open</span>
<a href="#l1.212"></a><span id="l1.212"> }</span>
<a href="#l1.213"></a><span id="l1.213"> </span>
<a href="#l1.214"></a><span id="l1.214"> /**</span>
<a href="#l1.215"></a><span id="l1.215">  * Called when once a date has been selected in the datepicker.</span>
<a href="#l1.216"></a><span id="l1.216">  */</span>
<a href="#l1.217"></a><span id="l1.217"> function onDatePick() {</span>
<a href="#l1.218"></a><span id="l1.218">     calRadioGroupSelectItem(&quot;view-field&quot;, &quot;custom-range&quot;);</span>
<a href="#l1.219"></a><span id="l1.219" class="difflineminus">-    refreshHtml();</span>
<a href="#l1.220"></a><span id="l1.220" class="difflineplus">+    setTimeout(refreshHtml, 0);</span>
<a href="#l1.221"></a><span id="l1.221"> }</span>
<a href="#l1.222"></a><span id="l1.222" class="difflineminus">-</span>
<a href="#l1.223"></a><span id="l1.223" class="difflineminus">-/**</span>
<a href="#l1.224"></a><span id="l1.224" class="difflineminus">- * Update the disabled state of the controls on the dialog, if not all print</span>
<a href="#l1.225"></a><span id="l1.225" class="difflineminus">- * parameters are set (i.e nothing to print).</span>
<a href="#l1.226"></a><span id="l1.226" class="difflineminus">- */</span>
<a href="#l1.227"></a><span id="l1.227" class="difflineminus">-function updatePrintState() {</span>
<a href="#l1.228"></a><span id="l1.228" class="difflineminus">-    let columns = document.getElementById(&quot;columns-for-events-and-tasks&quot;);</span>
<a href="#l1.229"></a><span id="l1.229" class="difflineminus">-    let cboxes = columns.getElementsByTagName(&quot;checkbox&quot;);</span>
<a href="#l1.230"></a><span id="l1.230" class="difflineminus">-</span>
<a href="#l1.231"></a><span id="l1.231" class="difflineminus">-    // If no checkboxes are checked, disable the print button</span>
<a href="#l1.232"></a><span id="l1.232" class="difflineminus">-    let someChecked = Array.slice(cboxes).some(function(x) x.checked);</span>
<a href="#l1.233"></a><span id="l1.233" class="difflineminus">-    document.documentElement.getButton(&quot;accept&quot;).disabled = !someChecked;</span>
<a href="#l1.234"></a><span id="l1.234" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-print-dialog.xul</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-print-dialog.xul</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -66,20 +66,20 @@</span>
<a href="#l2.4"></a><span id="l2.4">         &lt;/grid&gt;</span>
<a href="#l2.5"></a><span id="l2.5">       &lt;/groupbox&gt;</span>
<a href="#l2.6"></a><span id="l2.6"> </span>
<a href="#l2.7"></a><span id="l2.7">       &lt;groupbox id=&quot;what-to-print-group&quot;&gt;</span>
<a href="#l2.8"></a><span id="l2.8">         &lt;caption label=&quot;&amp;calendar.print.range.label;&quot;/&gt;</span>
<a href="#l2.9"></a><span id="l2.9">         &lt;grid id=&quot;grid-events-and-tasks&quot;&gt;</span>
<a href="#l2.10"></a><span id="l2.10">           &lt;columns id=&quot;columns-for-events-and-tasks&quot;&gt;</span>
<a href="#l2.11"></a><span id="l2.11">             &lt;column id=&quot;column-event&quot;&gt;</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-              &lt;checkbox id=&quot;events&quot; label=&quot;&amp;calendar.print.events.label;&quot; checked=&quot;true&quot; oncommand=&quot;updatePrintState(); refreshHtml();&quot;/&gt;</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+              &lt;checkbox id=&quot;events&quot; label=&quot;&amp;calendar.print.events.label;&quot; checked=&quot;true&quot; oncommand=&quot;refreshHtml();&quot;/&gt;</span>
<a href="#l2.14"></a><span id="l2.14">             &lt;/column&gt;</span>
<a href="#l2.15"></a><span id="l2.15">             &lt;column id=&quot;column-tasks&quot;&gt;</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineminus">-              &lt;checkbox id=&quot;tasks&quot; label=&quot;&amp;calendar.print.tasks.label;&quot; checked=&quot;true&quot; oncommand=&quot;updatePrintState(); refreshHtml();&quot;/&gt;</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineplus">+              &lt;checkbox id=&quot;tasks&quot; label=&quot;&amp;calendar.print.tasks.label;&quot; checked=&quot;true&quot; oncommand=&quot;refreshHtml();&quot;/&gt;</span>
<a href="#l2.18"></a><span id="l2.18">             &lt;/column&gt;</span>
<a href="#l2.19"></a><span id="l2.19">           &lt;/columns&gt;</span>
<a href="#l2.20"></a><span id="l2.20">         &lt;/grid&gt;</span>
<a href="#l2.21"></a><span id="l2.21">         &lt;radiogroup id=&quot;view-field&quot;</span>
<a href="#l2.22"></a><span id="l2.22">                     oncommand=&quot;refreshHtml();&quot;&gt;</span>
<a href="#l2.23"></a><span id="l2.23">           &lt;radio id=&quot;printCurrentViewRadio&quot;</span>
<a href="#l2.24"></a><span id="l2.24">                  label=&quot;&amp;calendar.print.currentView2.label;&quot;</span>
<a href="#l2.25"></a><span id="l2.25">                  value=&quot;currentView&quot;/&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/calendar/base/modules/calPrintUtils.jsm</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/calendar/base/modules/calPrintUtils.jsm</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -1,35 +1,185 @@</span>
<a href="#l3.4"></a><span id="l3.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l3.5"></a><span id="l3.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l3.6"></a><span id="l3.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l3.7"></a><span id="l3.7"> </span>
<a href="#l3.8"></a><span id="l3.8"> Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l3.9"></a><span id="l3.9"> </span>
<a href="#l3.10"></a><span id="l3.10"> EXPORTED_SYMBOLS = [&quot;cal&quot;]; // even though it's defined in calUtils.jsm, import needs this</span>
<a href="#l3.11"></a><span id="l3.11"> cal.print = {</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-    getTasksWithoutDueDate: function getTasksWithoutDueDate(aItems, date) {</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-        function isTaskWithoutDueDate(item) {</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineminus">-            return !item.dueDate &amp;&amp; !item.endDate;</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+    /**</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+     * Returns a simple key in the format YYYY-MM-DD for use in the table of</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+     * dates to day boxes</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineplus">+     *</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineplus">+     * @param dt    The date to translate</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineplus">+     * @return      YYYY-MM-DD</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineplus">+     */</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineplus">+    getDateKey: function getDateKey(dt) {</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineplus">+        return dt.year + &quot;-&quot; + dt.month + &quot;-&quot; + dt.day;</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineplus">+    },</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineplus">+</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineplus">+    /**</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineplus">+     * Add category styles to the document's &quot;sheet&quot; element. This is needed</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineplus">+     * since the HTML created is serialized, so we can't dynamically set the</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineplus">+     * styles and can be changed if the print formatter decides to return a</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineplus">+     * DOM document instead.</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineplus">+     *</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineplus">+     * @param document      The document that contains &lt;style id=&quot;sheet&quot;/&gt;.</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineplus">+     * @param categories    Array of categories to insert rules for.</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineplus">+     */</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineplus">+    insertCategoryRules: function insertCategoryRules(document, categories) {</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineplus">+        let sheet = document.getElementById(&quot;sheet&quot;);</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineplus">+        sheet.insertedCategoryRules = sheet.insertedCategoryRules || {};</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineplus">+</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineplus">+        for each (let category in categories) {</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineplus">+            let prefName = cal.formatStringForCSSRule(category);</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineplus">+            let color = cal.getPrefSafe(&quot;calendar.category.color.&quot; + prefName) || &quot;transparent&quot;;</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineplus">+            if (!(prefName in sheet.insertedCategoryRules)) {</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineplus">+                sheet.insertedCategoryRules[prefName] = true;</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineplus">+                let ruleAdd = ' .category-color-box[categories~=&quot;' + prefName + '&quot;] { ' +</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineplus">+                              ' border: 2px solid ' + color + '; }' + &quot;\n&quot;;</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineplus">+                sheet.textContent += ruleAdd;</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineplus">+            }</span>
<a href="#l3.48"></a><span id="l3.48">         }</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineminus">-        let filteredItems = aItems.filter(isTaskWithoutDueDate);</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineminus">-        if (filteredItems.length == 0) {</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineminus">-            return &quot;&quot;;</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineplus">+    },</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineplus">+</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineplus">+    /**</span>
<a href="#l3.55"></a><span id="l3.55" class="difflineplus">+     * Add calendar styles to the document's &quot;sheet&quot; element. This is needed</span>
<a href="#l3.56"></a><span id="l3.56" class="difflineplus">+     * since the HTML created is serialized, so we can't dynamically set the</span>
<a href="#l3.57"></a><span id="l3.57" class="difflineplus">+     * styles and can be changed if the print formatter decides to return a</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineplus">+     * DOM document instead.</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineplus">+     *</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineplus">+     * @param document      The document that contains &lt;style id=&quot;sheet&quot;/&gt;.</span>
<a href="#l3.61"></a><span id="l3.61" class="difflineplus">+     * @param categories    The calendar to insert a rule for.</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineplus">+     */</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineplus">+    insertCalendarRules: function insertCalendarRules(document, calendar) {</span>
<a href="#l3.64"></a><span id="l3.64" class="difflineplus">+        let sheet = document.getElementById(&quot;sheet&quot;);</span>
<a href="#l3.65"></a><span id="l3.65" class="difflineplus">+        let color = calendar.getProperty(&quot;color&quot;) || &quot;#A8C2E1&quot;;</span>
<a href="#l3.66"></a><span id="l3.66" class="difflineplus">+        sheet.insertedCalendarRules = sheet.insertedCalendarRules || {};</span>
<a href="#l3.67"></a><span id="l3.67" class="difflineplus">+</span>
<a href="#l3.68"></a><span id="l3.68" class="difflineplus">+        if (!(calendar.id in sheet.insertedCalendarRules)) {</span>
<a href="#l3.69"></a><span id="l3.69" class="difflineplus">+            sheet.insertedCalendarRules[calendar.id] = true;</span>
<a href="#l3.70"></a><span id="l3.70" class="difflineplus">+            let formattedId = cal.formatStringForCSSRule(calendar.id);</span>
<a href="#l3.71"></a><span id="l3.71" class="difflineplus">+            let ruleAdd = ' .calendar-color-box[calendar-id=&quot;' + formattedId + '&quot;] { ' +</span>
<a href="#l3.72"></a><span id="l3.72" class="difflineplus">+                          ' background-color: ' + color + '; ' +</span>
<a href="#l3.73"></a><span id="l3.73" class="difflineplus">+                          ' color: ' + cal.getContrastingTextColor(color) + '; }' + &quot;\n&quot;;</span>
<a href="#l3.74"></a><span id="l3.74" class="difflineplus">+            sheet.textContent += ruleAdd;</span>
<a href="#l3.75"></a><span id="l3.75">         }</span>
<a href="#l3.76"></a><span id="l3.76" class="difflineminus">-        let tasksDiv = &lt;div class=&quot;tasks&quot;/&gt;;</span>
<a href="#l3.77"></a><span id="l3.77" class="difflineminus">-        let monthName = cal.calGetString(&quot;dateFormat&quot;, &quot;month.&quot; + (date.month +1)+ &quot;.name&quot;);</span>
<a href="#l3.78"></a><span id="l3.78" class="difflineminus">-        tasksDiv.appendChild(&lt;h3&gt;{cal.calGetString(&quot;calendar&quot;,&quot;tasksWithNoDueDate&quot;)}&lt;/h3&gt;);</span>
<a href="#l3.79"></a><span id="l3.79" class="difflineminus">-        let list = &lt;ul class=&quot;taskList&quot; /&gt;;</span>
<a href="#l3.80"></a><span id="l3.80" class="difflineminus">-        for each (let task in filteredItems) {</span>
<a href="#l3.81"></a><span id="l3.81" class="difflineminus">-            let taskItem = &lt;li class=&quot;taskItem&quot; /&gt;;</span>
<a href="#l3.82"></a><span id="l3.82" class="difflineminus">-            if (task.isCompleted) {</span>
<a href="#l3.83"></a><span id="l3.83" class="difflineminus">-                taskItem.appendChild(&lt;input checked=&quot;checked&quot; type=&quot;checkbox&quot; disabled=&quot;true&quot;/&gt;);</span>
<a href="#l3.84"></a><span id="l3.84" class="difflineminus">-                taskItem.appendChild(&lt;s&gt;{task.title}&lt;/s&gt;);</span>
<a href="#l3.85"></a><span id="l3.85" class="difflineminus">-            } else {</span>
<a href="#l3.86"></a><span id="l3.86" class="difflineminus">-                taskItem.appendChild(&lt;input type=&quot;checkbox&quot; disabled=&quot;true&quot;/&gt;);</span>
<a href="#l3.87"></a><span id="l3.87" class="difflineminus">-                taskItem.appendChild(task.title);</span>
<a href="#l3.88"></a><span id="l3.88" class="difflineminus">-            }</span>
<a href="#l3.89"></a><span id="l3.89" class="difflineminus">-            list.appendChild(taskItem);</span>
<a href="#l3.90"></a><span id="l3.90" class="difflineplus">+    },</span>
<a href="#l3.91"></a><span id="l3.91" class="difflineplus">+</span>
<a href="#l3.92"></a><span id="l3.92" class="difflineplus">+    /**</span>
<a href="#l3.93"></a><span id="l3.93" class="difflineplus">+     * Serializes the given item by setting marked nodes to the item's content.</span>
<a href="#l3.94"></a><span id="l3.94" class="difflineplus">+     * Has some expectations about the DOM document (in CSS-selector-speak), all</span>
<a href="#l3.95"></a><span id="l3.95" class="difflineplus">+     * following nodes MUST exist.</span>
<a href="#l3.96"></a><span id="l3.96" class="difflineplus">+     *</span>
<a href="#l3.97"></a><span id="l3.97" class="difflineplus">+     * - #item-template will be cloned and filled, and modified:</span>
<a href="#l3.98"></a><span id="l3.98" class="difflineplus">+     *   - .item-interval gets the time interval of the item.</span>
<a href="#l3.99"></a><span id="l3.99" class="difflineplus">+     *   - .item-title gets the item title</span>
<a href="#l3.100"></a><span id="l3.100" class="difflineplus">+     *   - .category-color-box gets a 2px solid border in category color</span>
<a href="#l3.101"></a><span id="l3.101" class="difflineplus">+     *   - .calendar-color-box gets background color of the calendar</span>
<a href="#l3.102"></a><span id="l3.102" class="difflineplus">+     *</span>
<a href="#l3.103"></a><span id="l3.103" class="difflineplus">+     * @param document          The DOM Document to set things on</span>
<a href="#l3.104"></a><span id="l3.104" class="difflineplus">+     * @param item              The item to serialize</span>
<a href="#l3.105"></a><span id="l3.105" class="difflineplus">+     * @param dayContainer      The DOM Node to insert the container in</span>
<a href="#l3.106"></a><span id="l3.106" class="difflineplus">+     */</span>
<a href="#l3.107"></a><span id="l3.107" class="difflineplus">+    addItemToDaybox: function addItemToDaybox(document, item, dayContainer) {</span>
<a href="#l3.108"></a><span id="l3.108" class="difflineplus">+        // Clone our template</span>
<a href="#l3.109"></a><span id="l3.109" class="difflineplus">+        let itemNode = document.getElementById(&quot;item-template&quot;).cloneNode(true);</span>
<a href="#l3.110"></a><span id="l3.110" class="difflineplus">+        itemNode.removeAttribute(&quot;id&quot;);</span>
<a href="#l3.111"></a><span id="l3.111" class="difflineplus">+        itemNode.item = item;</span>
<a href="#l3.112"></a><span id="l3.112" class="difflineplus">+</span>
<a href="#l3.113"></a><span id="l3.113" class="difflineplus">+        // Fill in details of the item</span>
<a href="#l3.114"></a><span id="l3.114" class="difflineplus">+        let itemInterval = cal.getDateFormatter().formatItemTimeInterval(item);</span>
<a href="#l3.115"></a><span id="l3.115" class="difflineplus">+        itemNode.querySelector(&quot;.item-interval&quot;).textContent = itemInterval;</span>
<a href="#l3.116"></a><span id="l3.116" class="difflineplus">+        itemNode.querySelector(&quot;.item-title&quot;).textContent = item.title;</span>
<a href="#l3.117"></a><span id="l3.117" class="difflineplus">+</span>
<a href="#l3.118"></a><span id="l3.118" class="difflineplus">+        // Fill in category details</span>
<a href="#l3.119"></a><span id="l3.119" class="difflineplus">+        let categoriesArray = item.getCategories({});</span>
<a href="#l3.120"></a><span id="l3.120" class="difflineplus">+        if (categoriesArray.length &gt; 0) {</span>
<a href="#l3.121"></a><span id="l3.121" class="difflineplus">+            let cssClassesArray = categoriesArray.map(cal.formatStringForCSSRule);</span>
<a href="#l3.122"></a><span id="l3.122" class="difflineplus">+            itemNode.querySelector(&quot;.category-color-box&quot;)</span>
<a href="#l3.123"></a><span id="l3.123" class="difflineplus">+                    .setAttribute(&quot;categories&quot;, cssClassesArray.join(&quot; &quot;));</span>
<a href="#l3.124"></a><span id="l3.124" class="difflineplus">+</span>
<a href="#l3.125"></a><span id="l3.125" class="difflineplus">+            cal.print.insertCategoryRules(document, categoriesArray);</span>
<a href="#l3.126"></a><span id="l3.126">         }</span>
<a href="#l3.127"></a><span id="l3.127" class="difflineminus">-        tasksDiv.appendChild(list);</span>
<a href="#l3.128"></a><span id="l3.128" class="difflineminus">-        return tasksDiv;</span>
<a href="#l3.129"></a><span id="l3.129" class="difflineplus">+</span>
<a href="#l3.130"></a><span id="l3.130" class="difflineplus">+        // Fill in calendar color</span>
<a href="#l3.131"></a><span id="l3.131" class="difflineplus">+        itemNode.querySelector(&quot;.calendar-color-box&quot;)</span>
<a href="#l3.132"></a><span id="l3.132" class="difflineplus">+                .setAttribute(&quot;calendar-id&quot;, cal.formatStringForCSSRule(item.calendar.id));</span>
<a href="#l3.133"></a><span id="l3.133" class="difflineplus">+        cal.print.insertCalendarRules(document, item.calendar);</span>
<a href="#l3.134"></a><span id="l3.134" class="difflineplus">+</span>
<a href="#l3.135"></a><span id="l3.135" class="difflineplus">+        // Add it to the day container in the right order</span>
<a href="#l3.136"></a><span id="l3.136" class="difflineplus">+        cal.binaryInsertNode(dayContainer, itemNode, item, comparePrintItems);</span>
<a href="#l3.137"></a><span id="l3.137" class="difflineplus">+    },</span>
<a href="#l3.138"></a><span id="l3.138" class="difflineplus">+</span>
<a href="#l3.139"></a><span id="l3.139" class="difflineplus">+    /**</span>
<a href="#l3.140"></a><span id="l3.140" class="difflineplus">+     * Serializes the given item by setting marked nodes to the item's</span>
<a href="#l3.141"></a><span id="l3.141" class="difflineplus">+     * content. Should be used for tasks with no start and due date. Has</span>
<a href="#l3.142"></a><span id="l3.142" class="difflineplus">+     * some expectations about the DOM document (in CSS-selector-speak),</span>
<a href="#l3.143"></a><span id="l3.143" class="difflineplus">+     * all following nodes MUST exist.</span>
<a href="#l3.144"></a><span id="l3.144" class="difflineplus">+     *</span>
<a href="#l3.145"></a><span id="l3.145" class="difflineplus">+     * - Nodes will be added to #task-container.</span>
<a href="#l3.146"></a><span id="l3.146" class="difflineplus">+     * - #task-list-box will have the &quot;hidden&quot; attribute removed.</span>
<a href="#l3.147"></a><span id="l3.147" class="difflineplus">+     * - #task-template will be cloned and filled, and modified:</span>
<a href="#l3.148"></a><span id="l3.148" class="difflineplus">+     *   - .task-checkbox gets the &quot;checked&quot; attribute set, if completed</span>
<a href="#l3.149"></a><span id="l3.149" class="difflineplus">+     *   - .task-title gets the item title.</span>
<a href="#l3.150"></a><span id="l3.150" class="difflineplus">+     *</span>
<a href="#l3.151"></a><span id="l3.151" class="difflineplus">+     * @param document          The DOM Document to set things on</span>
<a href="#l3.152"></a><span id="l3.152" class="difflineplus">+     * @param item              The item to serialize</span>
<a href="#l3.153"></a><span id="l3.153" class="difflineplus">+     */</span>
<a href="#l3.154"></a><span id="l3.154" class="difflineplus">+    addItemToDayboxNodate: function addItemToDayboxNodate(document, item) {</span>
<a href="#l3.155"></a><span id="l3.155" class="difflineplus">+        let taskContainer = document.getElementById(&quot;task-container&quot;);</span>
<a href="#l3.156"></a><span id="l3.156" class="difflineplus">+        let taskNode = document.getElementById(&quot;task-template&quot;).cloneNode(true);</span>
<a href="#l3.157"></a><span id="l3.157" class="difflineplus">+        taskNode.removeAttribute(&quot;id&quot;);</span>
<a href="#l3.158"></a><span id="l3.158" class="difflineplus">+        taskNode.item = item;</span>
<a href="#l3.159"></a><span id="l3.159" class="difflineplus">+</span>
<a href="#l3.160"></a><span id="l3.160" class="difflineplus">+        let taskListBox = document.getElementById(&quot;tasks-list-box&quot;);</span>
<a href="#l3.161"></a><span id="l3.161" class="difflineplus">+        if (taskListBox.hasAttribute(&quot;hidden&quot;)) {</span>
<a href="#l3.162"></a><span id="l3.162" class="difflineplus">+            let tasksTitle = document.getElementById(&quot;tasks-title&quot;);</span>
<a href="#l3.163"></a><span id="l3.163" class="difflineplus">+            taskListBox.removeAttribute(&quot;hidden&quot;);</span>
<a href="#l3.164"></a><span id="l3.164" class="difflineplus">+            tasksTitle.textContent = cal.calGetString(&quot;calendar&quot;,&quot;tasksWithNoDueDate&quot;);</span>
<a href="#l3.165"></a><span id="l3.165" class="difflineplus">+        }</span>
<a href="#l3.166"></a><span id="l3.166" class="difflineplus">+</span>
<a href="#l3.167"></a><span id="l3.167" class="difflineplus">+        // Fill in details of the task</span>
<a href="#l3.168"></a><span id="l3.168" class="difflineplus">+        if (item.isCompleted) {</span>
<a href="#l3.169"></a><span id="l3.169" class="difflineplus">+            taskNode.querySelector(&quot;.task-checkbox&quot;).setAttribute(&quot;checked&quot;, &quot;checked&quot;);</span>
<a href="#l3.170"></a><span id="l3.170" class="difflineplus">+        }</span>
<a href="#l3.171"></a><span id="l3.171" class="difflineplus">+</span>
<a href="#l3.172"></a><span id="l3.172" class="difflineplus">+        taskNode.querySelector(&quot;.task-title&quot;).textContent = item.title;</span>
<a href="#l3.173"></a><span id="l3.173" class="difflineplus">+</span>
<a href="#l3.174"></a><span id="l3.174" class="difflineplus">+        let collator = cal.createLocaleCollator();</span>
<a href="#l3.175"></a><span id="l3.175" class="difflineplus">+        cal.binaryInsertNode(taskContainer, taskNode, item, function(a, b) collator.compareString(0, a, b), function(node) node.item.title);</span>
<a href="#l3.176"></a><span id="l3.176">     }</span>
<a href="#l3.177"></a><span id="l3.177"> }</span>
<a href="#l3.178"></a><span id="l3.178" class="difflineplus">+</span>
<a href="#l3.179"></a><span id="l3.179" class="difflineplus">+/**</span>
<a href="#l3.180"></a><span id="l3.180" class="difflineplus">+ * Item comparator for inserting items into dayboxes.</span>
<a href="#l3.181"></a><span id="l3.181" class="difflineplus">+ *</span>
<a href="#l3.182"></a><span id="l3.182" class="difflineplus">+ * TODO This could possibly be replaced with a global item comparator so</span>
<a href="#l3.183"></a><span id="l3.183" class="difflineplus">+ * that it matches with the views and such.</span>
<a href="#l3.184"></a><span id="l3.184" class="difflineplus">+ *</span>
<a href="#l3.185"></a><span id="l3.185" class="difflineplus">+ * @param a     The first item</span>
<a href="#l3.186"></a><span id="l3.186" class="difflineplus">+ * @param b     The second item</span>
<a href="#l3.187"></a><span id="l3.187" class="difflineplus">+ * @return      The usual -1, 0, 1</span>
<a href="#l3.188"></a><span id="l3.188" class="difflineplus">+ */</span>
<a href="#l3.189"></a><span id="l3.189" class="difflineplus">+function comparePrintItems(a, b) {</span>
<a href="#l3.190"></a><span id="l3.190" class="difflineplus">+    if (!a) return -1;</span>
<a href="#l3.191"></a><span id="l3.191" class="difflineplus">+    if (!b) return 1;</span>
<a href="#l3.192"></a><span id="l3.192" class="difflineplus">+</span>
<a href="#l3.193"></a><span id="l3.193" class="difflineplus">+    // Sort tasks before events</span>
<a href="#l3.194"></a><span id="l3.194" class="difflineplus">+    if (cal.isEvent(a) &amp;&amp; cal.isToDo(b)) {</span>
<a href="#l3.195"></a><span id="l3.195" class="difflineplus">+        return 1;</span>
<a href="#l3.196"></a><span id="l3.196" class="difflineplus">+    }</span>
<a href="#l3.197"></a><span id="l3.197" class="difflineplus">+    if (cal.isToDo(a) &amp;&amp; cal.isEvent(b)) {</span>
<a href="#l3.198"></a><span id="l3.198" class="difflineplus">+        return -1;</span>
<a href="#l3.199"></a><span id="l3.199" class="difflineplus">+    }</span>
<a href="#l3.200"></a><span id="l3.200" class="difflineplus">+    if (cal.isEvent(a)) {</span>
<a href="#l3.201"></a><span id="l3.201" class="difflineplus">+        let startCompare = a.startDate.compare(b.startDate);</span>
<a href="#l3.202"></a><span id="l3.202" class="difflineplus">+        if (startCompare != 0) {</span>
<a href="#l3.203"></a><span id="l3.203" class="difflineplus">+            return startCompare;</span>
<a href="#l3.204"></a><span id="l3.204" class="difflineplus">+        }</span>
<a href="#l3.205"></a><span id="l3.205" class="difflineplus">+        return a.endDate.compare(b.endDate);</span>
<a href="#l3.206"></a><span id="l3.206" class="difflineplus">+    }</span>
<a href="#l3.207"></a><span id="l3.207" class="difflineplus">+    let dateA = a.entryDate || a.dueDate;</span>
<a href="#l3.208"></a><span id="l3.208" class="difflineplus">+    let dateB = b.entryDate || b.dueDate;</span>
<a href="#l3.209"></a><span id="l3.209" class="difflineplus">+    return dateA.compare(dateB);</span>
<a href="#l3.210"></a><span id="l3.210" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/calendar/base/modules/calUtils.jsm</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/calendar/base/modules/calUtils.jsm</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -344,16 +344,30 @@ let cal = {</span>
<a href="#l4.4"></a><span id="l4.4"> </span>
<a href="#l4.5"></a><span id="l4.5">     nativeTime: function cal_nativeTime(calDateTime) {</span>
<a href="#l4.6"></a><span id="l4.6">         if (calDateTime == null) {</span>
<a href="#l4.7"></a><span id="l4.7">             return -62168601600000000; // ns value for (0000/00/00 00:00:00)</span>
<a href="#l4.8"></a><span id="l4.8">         }</span>
<a href="#l4.9"></a><span id="l4.9">         return calDateTime.nativeTime;</span>
<a href="#l4.10"></a><span id="l4.10">     },</span>
<a href="#l4.11"></a><span id="l4.11"> </span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+    userWeekStart: function userWeekStart(dt) {</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+        let wkst = cal.getPrefSafe(&quot;calendar.week.start&quot;, 0);</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+        let wkstDate = dt.clone();</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+        wkstDate.day -= (wkstDate.weekday - wkst + 7) % 7;</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineplus">+        return wkstDate;</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineplus">+    },</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineplus">+</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineplus">+    userWeekEnd: function userWeekEnd(dt) {</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineplus">+        let wkst = cal.getPrefSafe(&quot;calendar.week.start&quot;, 0);</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineplus">+        let wkendDate = dt.clone();</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineplus">+        wkendDate.day += (7 - wkendDate.weekday) + wkst;</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineplus">+        return wkendDate;</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineplus">+    },</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineplus">+</span>
<a href="#l4.26"></a><span id="l4.26">     sortEntry: function cal_sortEntry(aItem) {</span>
<a href="#l4.27"></a><span id="l4.27">         let key = cal.getItemSortKey(aItem, this.mSortKey, this.mSortStartedDate);</span>
<a href="#l4.28"></a><span id="l4.28">         return { mSortKey : key, mItem: aItem };</span>
<a href="#l4.29"></a><span id="l4.29">     },</span>
<a href="#l4.30"></a><span id="l4.30"> </span>
<a href="#l4.31"></a><span id="l4.31">     sortEntryItem: function cal_sortEntryItem(sortEntry) {</span>
<a href="#l4.32"></a><span id="l4.32">         return sortEntry.mItem;</span>
<a href="#l4.33"></a><span id="l4.33">     },</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/calendar/base/modules/calXMLUtils.jsm</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/calendar/base/modules/calXMLUtils.jsm</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -1,17 +1,17 @@</span>
<a href="#l5.4"></a><span id="l5.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l5.5"></a><span id="l5.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l5.6"></a><span id="l5.6">  * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l5.7"></a><span id="l5.7"> </span>
<a href="#l5.8"></a><span id="l5.8" class="difflineminus">-/* Helper functions for parsing and serializing XML */</span>
<a href="#l5.9"></a><span id="l5.9" class="difflineplus">+/** Helper functions for parsing and serializing XML */</span>
<a href="#l5.10"></a><span id="l5.10"> </span>
<a href="#l5.11"></a><span id="l5.11"> Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l5.12"></a><span id="l5.12"> </span>
<a href="#l5.13"></a><span id="l5.13" class="difflineminus">-EXPORTED_SYMBOLS = [&quot;cal&quot;]</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+EXPORTED_SYMBOLS = [&quot;cal&quot;];</span>
<a href="#l5.15"></a><span id="l5.15"> cal.xml = {} || cal.xml;</span>
<a href="#l5.16"></a><span id="l5.16"> </span>
<a href="#l5.17"></a><span id="l5.17"> /**</span>
<a href="#l5.18"></a><span id="l5.18">  * Evaluate an XPath query for the given node. Be careful with the return value</span>
<a href="#l5.19"></a><span id="l5.19">  * here, as it may be:</span>
<a href="#l5.20"></a><span id="l5.20">  *</span>
<a href="#l5.21"></a><span id="l5.21">  * - null, if there are no results</span>
<a href="#l5.22"></a><span id="l5.22">  * - a number, string or boolean value</span>
<a href="#l5.23"></a><span id="l5.23" class="difflineat">@@ -40,17 +40,17 @@ cal.xml.evalXPath = function evaluateXPa</span>
<a href="#l5.24"></a><span id="l5.24">             break;</span>
<a href="#l5.25"></a><span id="l5.25">         case XPR.BOOLEAN_TYPE:</span>
<a href="#l5.26"></a><span id="l5.26">             returnResult = result.booleanValue;</span>
<a href="#l5.27"></a><span id="l5.27">             break;</span>
<a href="#l5.28"></a><span id="l5.28">         case XPR.UNORDERED_NODE_ITERATOR_TYPE:</span>
<a href="#l5.29"></a><span id="l5.29">         case XPR.ORDERED_NODE_ITERATOR_TYPE:</span>
<a href="#l5.30"></a><span id="l5.30">         case XPR.ORDERED_NODE_ITERATOR_TYPE:</span>
<a href="#l5.31"></a><span id="l5.31">             returnResult = [];</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineminus">-            while (next = result.iterateNext()) {</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineplus">+            while ((next = result.iterateNext())) {</span>
<a href="#l5.34"></a><span id="l5.34">                 if (next instanceof Components.interfaces.nsIDOMText) {</span>
<a href="#l5.35"></a><span id="l5.35">                     returnResult.push(next.wholeText);</span>
<a href="#l5.36"></a><span id="l5.36">                 } else if (next instanceof Components.interfaces.nsIDOMAttr) {</span>
<a href="#l5.37"></a><span id="l5.37">                     returnResult.push(next.value);</span>
<a href="#l5.38"></a><span id="l5.38">                 } else {</span>
<a href="#l5.39"></a><span id="l5.39">                     returnResult.push(next);</span>
<a href="#l5.40"></a><span id="l5.40">                 }</span>
<a href="#l5.41"></a><span id="l5.41">             }</span>
<a href="#l5.42"></a><span id="l5.42" class="difflineat">@@ -120,16 +120,33 @@ cal.xml.evalXPathFirst = function evalXP</span>
<a href="#l5.43"></a><span id="l5.43"> cal.xml.parseString = function(str, docUri, baseUri) {</span>
<a href="#l5.44"></a><span id="l5.44">     let parser = Components.classes[&quot;@mozilla.org/xmlextras/domparser;1&quot;]</span>
<a href="#l5.45"></a><span id="l5.45">                  .createInstance(Components.interfaces.nsIDOMParser);</span>
<a href="#l5.46"></a><span id="l5.46">     parser.init(null, docUri, baseUri);</span>
<a href="#l5.47"></a><span id="l5.47">     return parser.parseFromString(str, &quot;application/xml&quot;);</span>
<a href="#l5.48"></a><span id="l5.48"> };</span>
<a href="#l5.49"></a><span id="l5.49"> </span>
<a href="#l5.50"></a><span id="l5.50"> /**</span>
<a href="#l5.51"></a><span id="l5.51" class="difflineplus">+ * Read an XML file synchronously. This method should be avoided, consider</span>
<a href="#l5.52"></a><span id="l5.52" class="difflineplus">+ * rewriting the caller to be asynchronous.</span>
<a href="#l5.53"></a><span id="l5.53" class="difflineplus">+ *</span>
<a href="#l5.54"></a><span id="l5.54" class="difflineplus">+ * @param uri       The URI to read.</span>
<a href="#l5.55"></a><span id="l5.55" class="difflineplus">+ * @return          The DOM Document resulting from the file.</span>
<a href="#l5.56"></a><span id="l5.56" class="difflineplus">+ */</span>
<a href="#l5.57"></a><span id="l5.57" class="difflineplus">+cal.xml.parseFile = function(uri) {</span>
<a href="#l5.58"></a><span id="l5.58" class="difflineplus">+    let req = Components.classes[&quot;@mozilla.org/xmlextras/xmlhttprequest;1&quot;]</span>
<a href="#l5.59"></a><span id="l5.59" class="difflineplus">+                        .createInstance(Components.interfaces.nsIXMLHttpRequest);</span>
<a href="#l5.60"></a><span id="l5.60" class="difflineplus">+</span>
<a href="#l5.61"></a><span id="l5.61" class="difflineplus">+    req.open('GET', uri, false);</span>
<a href="#l5.62"></a><span id="l5.62" class="difflineplus">+    req.overrideMimeType(&quot;text/xml&quot;);</span>
<a href="#l5.63"></a><span id="l5.63" class="difflineplus">+    req.send(null);</span>
<a href="#l5.64"></a><span id="l5.64" class="difflineplus">+    return req.responseXML;</span>
<a href="#l5.65"></a><span id="l5.65" class="difflineplus">+};</span>
<a href="#l5.66"></a><span id="l5.66" class="difflineplus">+</span>
<a href="#l5.67"></a><span id="l5.67" class="difflineplus">+/**</span>
<a href="#l5.68"></a><span id="l5.68">  * Serialize the DOM tree into a string.</span>
<a href="#l5.69"></a><span id="l5.69">  *</span>
<a href="#l5.70"></a><span id="l5.70">  * @param doc       The DOM document to serialize</span>
<a href="#l5.71"></a><span id="l5.71">  * @return          The DOM document as a string.</span>
<a href="#l5.72"></a><span id="l5.72">  */</span>
<a href="#l5.73"></a><span id="l5.73"> cal.xml.serializeDOM = function(doc) {</span>
<a href="#l5.74"></a><span id="l5.74">     let serializer = Components.classes[&quot;@mozilla.org/xmlextras/xmlserializer;1&quot;]</span>
<a href="#l5.75"></a><span id="l5.75">                                .createInstance(Components.interfaces.nsIDOMSerializer);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/calendar/base/public/calIDateTimeFormatter.idl</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/calendar/base/public/calIDateTimeFormatter.idl</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -82,31 +82,45 @@ interface calIDateTimeFormatter : nsISup</span>
<a href="#l6.4"></a><span id="l6.4">      * the start/entry and end/due date of the item.</span>
<a href="#l6.5"></a><span id="l6.5">      *</span>
<a href="#l6.6"></a><span id="l6.6">      * @param aItem </span>
<a href="#l6.7"></a><span id="l6.7">      *      The item describing the interval</span>
<a href="#l6.8"></a><span id="l6.8">      */</span>
<a href="#l6.9"></a><span id="l6.9">     AUTF8String formatItemInterval(in calIItemBase aItem);</span>
<a href="#l6.10"></a><span id="l6.10"> </span>
<a href="#l6.11"></a><span id="l6.11">     /**</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-     * Format a time interval. The returned string may assume that the dates</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-     * are so close to each other, that it can leave out some parts of the</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineminus">-     * part string denoting the end date</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+     * Format a time interval like formatItemInterval, but only show times.</span>
<a href="#l6.16"></a><span id="l6.16">      *</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineminus">-     * @param aStartDate</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineminus">-     *      The start of the interval</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineminus">-     * @param aEndDate</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineminus">-     *      The end of the interval</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineminus">-     * @returns</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineminus">-     *      A String describing the interval in a legible form</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineplus">+     * @param aItem     The item providing the interval</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineplus">+     * @return          The string describing the interval</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineplus">+     */</span>
<a href="#l6.26"></a><span id="l6.26" class="difflineplus">+     AUTF8String formatItemTimeInterval(in calIItemBase aItem);</span>
<a href="#l6.27"></a><span id="l6.27" class="difflineplus">+</span>
<a href="#l6.28"></a><span id="l6.28" class="difflineplus">+    /**</span>
<a href="#l6.29"></a><span id="l6.29" class="difflineplus">+     * Format a date/time interval. The returned string may assume that the</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineplus">+     * dates are so close to each other, that it can leave out some parts of the</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineplus">+     * part string denoting the end date.</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineplus">+     *</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineplus">+     * @param aStartDate        The start of the interval</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineplus">+     * @param aEndDate          The end of the interval</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineplus">+     * @return                  A String describing the interval in a legible form</span>
<a href="#l6.36"></a><span id="l6.36">      */</span>
<a href="#l6.37"></a><span id="l6.37">     AUTF8String formatInterval(in calIDateTime aStartDate,</span>
<a href="#l6.38"></a><span id="l6.38">                                in calIDateTime aEndDate);</span>
<a href="#l6.39"></a><span id="l6.39"> </span>
<a href="#l6.40"></a><span id="l6.40">     /**</span>
<a href="#l6.41"></a><span id="l6.41" class="difflineplus">+     * Format a time interval like formatInterval, but show only the time.</span>
<a href="#l6.42"></a><span id="l6.42" class="difflineplus">+     *</span>
<a href="#l6.43"></a><span id="l6.43" class="difflineplus">+     * @param aStartDate        The start of the interval.</span>
<a href="#l6.44"></a><span id="l6.44" class="difflineplus">+     * @param aEndDate          The end of the interval.</span>
<a href="#l6.45"></a><span id="l6.45" class="difflineplus">+     * @return                  The formatted time interval.</span>
<a href="#l6.46"></a><span id="l6.46" class="difflineplus">+     */</span>
<a href="#l6.47"></a><span id="l6.47" class="difflineplus">+    AUTF8String formatTimeInterval(in calIDateTime aStartTime,</span>
<a href="#l6.48"></a><span id="l6.48" class="difflineplus">+                                   in calIDateTime aEndTime);</span>
<a href="#l6.49"></a><span id="l6.49" class="difflineplus">+    /**</span>
<a href="#l6.50"></a><span id="l6.50">      * Get the month name</span>
<a href="#l6.51"></a><span id="l6.51">      *</span>
<a href="#l6.52"></a><span id="l6.52">      * @param aMonthIndex</span>
<a href="#l6.53"></a><span id="l6.53">      *     zero-based month number (0 is january, 11 is december)</span>
<a href="#l6.54"></a><span id="l6.54">      * @returns</span>
<a href="#l6.55"></a><span id="l6.55">      *      the month name in the current locale</span>
<a href="#l6.56"></a><span id="l6.56">      */</span>
<a href="#l6.57"></a><span id="l6.57">     AString monthName(in unsigned long aMonthIndex);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/calendar/base/src/calDateTimeFormatter.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/calendar/base/src/calDateTimeFormatter.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -147,16 +147,27 @@ calDateTimeFormatter.prototype = {</span>
<a href="#l7.4"></a><span id="l7.4">         let timeBeforeDate = cal.getPrefSafe(&quot;calendar.date.formatTimeBeforeDate&quot;, false);</span>
<a href="#l7.5"></a><span id="l7.5">         if (timeBeforeDate) {</span>
<a href="#l7.6"></a><span id="l7.6">             return formattedTime + &quot; &quot; + formattedDate;</span>
<a href="#l7.7"></a><span id="l7.7">         } else {</span>
<a href="#l7.8"></a><span id="l7.8">             return formattedDate + &quot; &quot; + formattedTime;</span>
<a href="#l7.9"></a><span id="l7.9">         }</span>
<a href="#l7.10"></a><span id="l7.10">     },</span>
<a href="#l7.11"></a><span id="l7.11"> </span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+    formatTimeInterval: function formatTimeInterval(aStartDate, aEndDate) {</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+        if (!aStartDate &amp;&amp; aEndDate) return this.formatTime(aEndDate);</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+        if (!aEndDate &amp;&amp; aStartDate) return this.formatTime(aStartDate);</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+        if (!aStartDate &amp;&amp; !aEndDate) return &quot;&quot;;</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineplus">+</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineplus">+        // TODO do we need l10n for this?</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineplus">+        // TODO should we check for the same day? The caller should know what</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineplus">+        // he is doing...</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineplus">+        return this.formatTime(aStartDate) + &quot;\u2013&quot; + this.formatTime(aEndDate);</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineplus">+    },</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineplus">+</span>
<a href="#l7.23"></a><span id="l7.23">     formatInterval: function formatInterval(aStartDate, aEndDate) {</span>
<a href="#l7.24"></a><span id="l7.24">         // Check for tasks without start and/or due date</span>
<a href="#l7.25"></a><span id="l7.25">         if (aEndDate == null &amp;&amp; aStartDate == null ) {</span>
<a href="#l7.26"></a><span id="l7.26">             return calGetString(&quot;calendar&quot;, &quot;datetimeIntervalTaskWithoutDate&quot;);</span>
<a href="#l7.27"></a><span id="l7.27">         } else if (aEndDate == null) {</span>
<a href="#l7.28"></a><span id="l7.28">             let startDateString = this.formatDate(aStartDate);</span>
<a href="#l7.29"></a><span id="l7.29">             let startTime = this.formatTime(aStartDate);</span>
<a href="#l7.30"></a><span id="l7.30">             return calGetString(&quot;calendar&quot;, &quot;datetimeIntervalTaskWithoutDueDate&quot;, [startDateString, startTime]);</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineat">@@ -214,33 +225,42 @@ calDateTimeFormatter.prototype = {</span>
<a href="#l7.32"></a><span id="l7.32">                 // Spanning multiple days, so need to include date and time</span>
<a href="#l7.33"></a><span id="l7.33">                 // for start and end</span>
<a href="#l7.34"></a><span id="l7.34">                 // &quot;5 Jan 2006 13:00 - 7 Jan 2006 9:00&quot;</span>
<a href="#l7.35"></a><span id="l7.35">                 return calGetString(&quot;calendar&quot;, &quot;datetimeIntervalOnSeveralDays&quot;, [startDateString, startTime, endDateString, endTime]);</span>
<a href="#l7.36"></a><span id="l7.36">             }</span>
<a href="#l7.37"></a><span id="l7.37">         }</span>
<a href="#l7.38"></a><span id="l7.38">     },</span>
<a href="#l7.39"></a><span id="l7.39"> </span>
<a href="#l7.40"></a><span id="l7.40" class="difflineminus">-    formatItemInterval: function formatItemInterval(aItem) {</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineplus">+    _getItemDates: function _getItemDates(aItem) {</span>
<a href="#l7.42"></a><span id="l7.42">         let start = aItem[calGetStartDateProp(aItem)];</span>
<a href="#l7.43"></a><span id="l7.43">         let end = aItem[calGetEndDateProp(aItem)];</span>
<a href="#l7.44"></a><span id="l7.44">         let kDefaultTimezone = calendarDefaultTimezone();</span>
<a href="#l7.45"></a><span id="l7.45">         // Check for tasks without start and/or due date</span>
<a href="#l7.46"></a><span id="l7.46">         if (start) {</span>
<a href="#l7.47"></a><span id="l7.47">             start = start.getInTimezone(kDefaultTimezone);</span>
<a href="#l7.48"></a><span id="l7.48">         }</span>
<a href="#l7.49"></a><span id="l7.49">         if (end) {</span>
<a href="#l7.50"></a><span id="l7.50">             end = end.getInTimezone(kDefaultTimezone);</span>
<a href="#l7.51"></a><span id="l7.51">         }</span>
<a href="#l7.52"></a><span id="l7.52">         // EndDate is exclusive. For all-day events, we ened to substract one day,</span>
<a href="#l7.53"></a><span id="l7.53">         // to get into a format that's understandable.</span>
<a href="#l7.54"></a><span id="l7.54">         if (start &amp;&amp; start.isDate &amp;&amp; end) {</span>
<a href="#l7.55"></a><span id="l7.55">             end.day -= 1;</span>
<a href="#l7.56"></a><span id="l7.56">         }</span>
<a href="#l7.57"></a><span id="l7.57" class="difflineminus">-        return this.formatInterval(start, end);</span>
<a href="#l7.58"></a><span id="l7.58" class="difflineplus">+</span>
<a href="#l7.59"></a><span id="l7.59" class="difflineplus">+        return [start, end];</span>
<a href="#l7.60"></a><span id="l7.60" class="difflineplus">+    },</span>
<a href="#l7.61"></a><span id="l7.61" class="difflineplus">+</span>
<a href="#l7.62"></a><span id="l7.62" class="difflineplus">+    formatItemInterval: function formatItemInterval(aItem) {</span>
<a href="#l7.63"></a><span id="l7.63" class="difflineplus">+        return this.formatInterval.apply(this, this._getItemDates(aItem));</span>
<a href="#l7.64"></a><span id="l7.64" class="difflineplus">+    },</span>
<a href="#l7.65"></a><span id="l7.65" class="difflineplus">+</span>
<a href="#l7.66"></a><span id="l7.66" class="difflineplus">+    formatItemTimeInterval: function formatItemTimeInterval(aItem) {</span>
<a href="#l7.67"></a><span id="l7.67" class="difflineplus">+        return this.formatTimeInterval.apply(this, this._getItemDates(aItem));</span>
<a href="#l7.68"></a><span id="l7.68">     },</span>
<a href="#l7.69"></a><span id="l7.69"> </span>
<a href="#l7.70"></a><span id="l7.70">     monthName: function monthName(aMonthIndex) {</span>
<a href="#l7.71"></a><span id="l7.71">         let oneBasedMonthIndex = aMonthIndex + 1;</span>
<a href="#l7.72"></a><span id="l7.72">         return this.mDateStringBundle.GetStringFromName(&quot;month.&quot; + oneBasedMonthIndex + &quot;.name&quot; );</span>
<a href="#l7.73"></a><span id="l7.73">     },</span>
<a href="#l7.74"></a><span id="l7.74"> </span>
<a href="#l7.75"></a><span id="l7.75">     shortMonthName: function shortMonthName(aMonthIndex) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1">new file mode 100644</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineminus">--- /dev/null</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineplus">+++ b/calendar/import-export/calHtmlExport.html</span>
<a href="#l8.4"></a><span id="l8.4" class="difflineat">@@ -0,0 +1,70 @@</span>
<a href="#l8.5"></a><span id="l8.5" class="difflineplus">+&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD XHTML 1.1//EN&quot;</span>
<a href="#l8.6"></a><span id="l8.6" class="difflineplus">+   &quot;http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd&quot;&gt;</span>
<a href="#l8.7"></a><span id="l8.7" class="difflineplus">+&lt;html xmlns=&quot;http://www.w3.org/1999/xhtml&quot;&gt;</span>
<a href="#l8.8"></a><span id="l8.8" class="difflineplus">+  &lt;head&gt;</span>
<a href="#l8.9"></a><span id="l8.9" class="difflineplus">+    &lt;title id=&quot;title&quot;&gt;&lt;/title&gt;</span>
<a href="#l8.10"></a><span id="l8.10" class="difflineplus">+    &lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=UTF-8&quot;/&gt;</span>
<a href="#l8.11"></a><span id="l8.11" class="difflineplus">+    &lt;style type=&quot;text/css&quot; id=&quot;sheet&quot;&gt;</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+      .vevent {</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+        border: 1px solid black;</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineplus">+        padding: 0;</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineplus">+        margin-bottom: 10px;</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineplus">+      }</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineplus">+</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineplus">+      .key {</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineplus">+        font-style: italic;</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineplus">+        margin-left: 3px;</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineplus">+      }</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineplus">+</span>
<a href="#l8.23"></a><span id="l8.23" class="difflineplus">+      .value {</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineplus">+        margin-left: 20px;</span>
<a href="#l8.25"></a><span id="l8.25" class="difflineplus">+      }</span>
<a href="#l8.26"></a><span id="l8.26" class="difflineplus">+</span>
<a href="#l8.27"></a><span id="l8.27" class="difflineplus">+      abbr {</span>
<a href="#l8.28"></a><span id="l8.28" class="difflineplus">+        border: none;</span>
<a href="#l8.29"></a><span id="l8.29" class="difflineplus">+      }</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineplus">+</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineplus">+      .summarykey {</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineplus">+        display: none;</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineplus">+      }</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineplus">+</span>
<a href="#l8.35"></a><span id="l8.35" class="difflineplus">+      .summary {</span>
<a href="#l8.36"></a><span id="l8.36" class="difflineplus">+        font-weight: bold;</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineplus">+        margin: 0;</span>
<a href="#l8.38"></a><span id="l8.38" class="difflineplus">+        padding: 3px;</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineplus">+      }</span>
<a href="#l8.40"></a><span id="l8.40" class="difflineplus">+</span>
<a href="#l8.41"></a><span id="l8.41" class="difflineplus">+      .description {</span>
<a href="#l8.42"></a><span id="l8.42" class="difflineplus">+        white-space: pre-wrap;</span>
<a href="#l8.43"></a><span id="l8.43" class="difflineplus">+      }</span>
<a href="#l8.44"></a><span id="l8.44" class="difflineplus">+    &lt;/style&gt;</span>
<a href="#l8.45"></a><span id="l8.45" class="difflineplus">+  &lt;/head&gt;</span>
<a href="#l8.46"></a><span id="l8.46" class="difflineplus">+  &lt;body id=&quot;item-container&quot;&gt;</span>
<a href="#l8.47"></a><span id="l8.47" class="difflineplus">+    &lt;!-- Note on the use of the summarykey class:</span>
<a href="#l8.48"></a><span id="l8.48" class="difflineplus">+         This node is hidden by default for better readability. If you would</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineplus">+         like to show the key, remove the display style above. --&gt;</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineplus">+    &lt;div id=&quot;templates&quot;&gt;</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineplus">+      &lt;div class=&quot;vevent&quot; id=&quot;item-template&quot;&gt;</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineplus">+        &lt;div class=&quot;row summaryrow&quot;&gt;</span>
<a href="#l8.53"></a><span id="l8.53" class="difflineplus">+          &lt;div class=&quot;key summarykey&quot;&gt;&lt;/div&gt;</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineplus">+          &lt;div class=&quot;value summary&quot;&gt;&lt;/div&gt;</span>
<a href="#l8.55"></a><span id="l8.55" class="difflineplus">+        &lt;/div&gt;</span>
<a href="#l8.56"></a><span id="l8.56" class="difflineplus">+        &lt;div class=&quot;row intervalrow&quot;&gt;</span>
<a href="#l8.57"></a><span id="l8.57" class="difflineplus">+          &lt;div class=&quot;key intervalkey&quot;&gt;&lt;/div&gt;</span>
<a href="#l8.58"></a><span id="l8.58" class="difflineplus">+          &lt;div class=&quot;value&quot;&gt;</span>
<a href="#l8.59"></a><span id="l8.59" class="difflineplus">+            &lt;abbr class=&quot;dtstart&quot;&gt;&lt;/abbr&gt;</span>
<a href="#l8.60"></a><span id="l8.60" class="difflineplus">+          &lt;/div&gt;</span>
<a href="#l8.61"></a><span id="l8.61" class="difflineplus">+        &lt;/div&gt;</span>
<a href="#l8.62"></a><span id="l8.62" class="difflineplus">+        &lt;div class=&quot;row locationrow&quot;&gt;</span>
<a href="#l8.63"></a><span id="l8.63" class="difflineplus">+          &lt;div class=&quot;key locationkey&quot;&gt;&lt;/div&gt;</span>
<a href="#l8.64"></a><span id="l8.64" class="difflineplus">+          &lt;div class=&quot;value location&quot;&gt;&lt;/div&gt;</span>
<a href="#l8.65"></a><span id="l8.65" class="difflineplus">+        &lt;/div&gt;</span>
<a href="#l8.66"></a><span id="l8.66" class="difflineplus">+        &lt;div class=&quot;row descriptionrow&quot;&gt;</span>
<a href="#l8.67"></a><span id="l8.67" class="difflineplus">+          &lt;div class=&quot;key descriptionkey&quot;&gt;&lt;/div&gt;</span>
<a href="#l8.68"></a><span id="l8.68" class="difflineplus">+          &lt;div class=&quot;value description&quot;&gt;&lt;/div&gt;</span>
<a href="#l8.69"></a><span id="l8.69" class="difflineplus">+        &lt;/div&gt;</span>
<a href="#l8.70"></a><span id="l8.70" class="difflineplus">+</span>
<a href="#l8.71"></a><span id="l8.71" class="difflineplus">+      &lt;/div&gt;</span>
<a href="#l8.72"></a><span id="l8.72" class="difflineplus">+    &lt;/div&gt;</span>
<a href="#l8.73"></a><span id="l8.73" class="difflineplus">+  &lt;/body&gt;</span>
<a href="#l8.74"></a><span id="l8.74" class="difflineplus">+&lt;/html&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/calendar/import-export/calHtmlExport.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/calendar/import-export/calHtmlExport.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -1,159 +1,112 @@</span>
<a href="#l9.4"></a><span id="l9.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l9.5"></a><span id="l9.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l9.6"></a><span id="l9.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l9.7"></a><span id="l9.7"> </span>
<a href="#l9.8"></a><span id="l9.8" class="difflineminus">-Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l9.9"></a><span id="l9.9" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l9.10"></a><span id="l9.10"> </span>
<a href="#l9.11"></a><span id="l9.11" class="difflineminus">-// Export</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calXMLUtils.jsm&quot;);</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineplus">+</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineplus">+/**</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineplus">+ * HTML Export Plugin</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineplus">+ */</span>
<a href="#l9.18"></a><span id="l9.18"> function calHtmlExporter() {</span>
<a href="#l9.19"></a><span id="l9.19"> }</span>
<a href="#l9.20"></a><span id="l9.20"> </span>
<a href="#l9.21"></a><span id="l9.21"> calHtmlExporter.prototype = {</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineminus">-    getInterfaces: function (count) {</span>
<a href="#l9.23"></a><span id="l9.23" class="difflineminus">-        const ifaces = [</span>
<a href="#l9.24"></a><span id="l9.24" class="difflineminus">-            Components.interfaces.nsISupports,</span>
<a href="#l9.25"></a><span id="l9.25" class="difflineminus">-            Components.interfaces.nsIClassInfo,</span>
<a href="#l9.26"></a><span id="l9.26" class="difflineminus">-            Components.interfaces.calIExporter,</span>
<a href="#l9.27"></a><span id="l9.27" class="difflineminus">-        ];</span>
<a href="#l9.28"></a><span id="l9.28" class="difflineminus">-        count.value = ifaces.length;</span>
<a href="#l9.29"></a><span id="l9.29" class="difflineminus">-        return ifaces;</span>
<a href="#l9.30"></a><span id="l9.30" class="difflineminus">-    },</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineplus">+    classID: Components.ID(&quot;{72d9ab35-9b1b-442a-8cd0-ae49f00b159b}&quot;),</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineplus">+    QueryInterface: XPCOMUtils.generateQI([Components.interfaces.calIExporter]),</span>
<a href="#l9.33"></a><span id="l9.33"> </span>
<a href="#l9.34"></a><span id="l9.34" class="difflineminus">-    getHelperForLanguage: function (language) {</span>
<a href="#l9.35"></a><span id="l9.35" class="difflineminus">-        return null;</span>
<a href="#l9.36"></a><span id="l9.36" class="difflineminus">-    },</span>
<a href="#l9.37"></a><span id="l9.37" class="difflineminus">-</span>
<a href="#l9.38"></a><span id="l9.38" class="difflineminus">-    contractID: &quot;@mozilla.org/calendar/export;1?type=html&quot;,</span>
<a href="#l9.39"></a><span id="l9.39" class="difflineminus">-    classDescription: &quot;Calendar HTML Exporter&quot;,</span>
<a href="#l9.40"></a><span id="l9.40" class="difflineminus">-    classID: Components.ID(&quot;{72d9ab35-9b1b-442a-8cd0-ae49f00b159b}&quot;),</span>
<a href="#l9.41"></a><span id="l9.41" class="difflineminus">-    implementationLanguage: Components.interfaces.nsIProgrammingLanguage.JAVASCRIPT,</span>
<a href="#l9.42"></a><span id="l9.42" class="difflineminus">-    flags: 0,</span>
<a href="#l9.43"></a><span id="l9.43" class="difflineminus">-</span>
<a href="#l9.44"></a><span id="l9.44" class="difflineminus">-    QueryInterface: function QueryInterface(aIID) {</span>
<a href="#l9.45"></a><span id="l9.45" class="difflineminus">-        return cal.doQueryInterface(this, calHtmlExporter.prototype, aIID, null, this);</span>
<a href="#l9.46"></a><span id="l9.46" class="difflineminus">-    },</span>
<a href="#l9.47"></a><span id="l9.47" class="difflineplus">+    classInfo: XPCOMUtils.generateCI({</span>
<a href="#l9.48"></a><span id="l9.48" class="difflineplus">+        classID: Components.ID(&quot;{72d9ab35-9b1b-442a-8cd0-ae49f00b159b}&quot;),</span>
<a href="#l9.49"></a><span id="l9.49" class="difflineplus">+        contractID: &quot;@mozilla.org/calendar/export;1?type=html&quot;,</span>
<a href="#l9.50"></a><span id="l9.50" class="difflineplus">+        classDescription: &quot;Calendar HTML Exporter&quot;,</span>
<a href="#l9.51"></a><span id="l9.51" class="difflineplus">+        interfaces: [Components.interfaces.calIExporter]</span>
<a href="#l9.52"></a><span id="l9.52" class="difflineplus">+    }),</span>
<a href="#l9.53"></a><span id="l9.53"> </span>
<a href="#l9.54"></a><span id="l9.54">     getFileTypes: function getFileTypes(aCount) {</span>
<a href="#l9.55"></a><span id="l9.55">         aCount.value = 1;</span>
<a href="#l9.56"></a><span id="l9.56">         let wildmat = '*.html; *.htm';</span>
<a href="#l9.57"></a><span id="l9.57">         let label = cal.calGetString(&quot;calendar&quot;, 'filterHtml', [wildmat]);</span>
<a href="#l9.58"></a><span id="l9.58" class="difflineminus">-        return [{ defaultExtension:'html',</span>
<a href="#l9.59"></a><span id="l9.59" class="difflineminus">-                  extensionFilter: wildmat,</span>
<a href="#l9.60"></a><span id="l9.60" class="difflineminus">-                  description: label }];</span>
<a href="#l9.61"></a><span id="l9.61" class="difflineplus">+        return [{</span>
<a href="#l9.62"></a><span id="l9.62" class="difflineplus">+            QueryInterface: XPCOMUtils.generateQI([Components.interfaces.calIFileType]),</span>
<a href="#l9.63"></a><span id="l9.63" class="difflineplus">+            defaultExtension: 'html',</span>
<a href="#l9.64"></a><span id="l9.64" class="difflineplus">+            extensionFilter: wildmat,</span>
<a href="#l9.65"></a><span id="l9.65" class="difflineplus">+            description: label</span>
<a href="#l9.66"></a><span id="l9.66" class="difflineplus">+        }];</span>
<a href="#l9.67"></a><span id="l9.67">     },</span>
<a href="#l9.68"></a><span id="l9.68"> </span>
<a href="#l9.69"></a><span id="l9.69">     exportToStream: function html_exportToStream(aStream, aCount, aItems, aTitle) {</span>
<a href="#l9.70"></a><span id="l9.70" class="difflineminus">-        let documentTitle = aTitle || cal.calGetString(&quot;calendar&quot;, &quot;HTMLTitle&quot;);</span>
<a href="#l9.71"></a><span id="l9.71" class="difflineminus">-</span>
<a href="#l9.72"></a><span id="l9.72" class="difflineminus">-        let html =</span>
<a href="#l9.73"></a><span id="l9.73" class="difflineminus">-            &lt;html&gt;</span>
<a href="#l9.74"></a><span id="l9.74" class="difflineminus">-                &lt;head&gt;</span>
<a href="#l9.75"></a><span id="l9.75" class="difflineminus">-                    &lt;title&gt;{documentTitle}&lt;/title&gt;</span>
<a href="#l9.76"></a><span id="l9.76" class="difflineminus">-                    &lt;meta http-equiv='Content-Type' content='text/html; charset=UTF-8'/&gt;</span>
<a href="#l9.77"></a><span id="l9.77" class="difflineminus">-                    &lt;style type='text/css'/&gt;</span>
<a href="#l9.78"></a><span id="l9.78" class="difflineminus">-                &lt;/head&gt;</span>
<a href="#l9.79"></a><span id="l9.79" class="difflineminus">-                &lt;body&gt;</span>
<a href="#l9.80"></a><span id="l9.80" class="difflineminus">-                    &lt;!-- Note on the use of the summarykey class: this is a</span>
<a href="#l9.81"></a><span id="l9.81" class="difflineminus">-                         special class, because in the default style, it is hidden.</span>
<a href="#l9.82"></a><span id="l9.82" class="difflineminus">-                         The div is still included for those that want a different</span>
<a href="#l9.83"></a><span id="l9.83" class="difflineminus">-                         style, where the key is visible --&gt;</span>
<a href="#l9.84"></a><span id="l9.84" class="difflineminus">-                &lt;/body&gt;</span>
<a href="#l9.85"></a><span id="l9.85" class="difflineminus">-            &lt;/html&gt;;</span>
<a href="#l9.86"></a><span id="l9.86" class="difflineminus">-        // XXX The html comment above won't propagate to the resulting html.</span>
<a href="#l9.87"></a><span id="l9.87" class="difflineminus">-        //     Should fix that, one day.</span>
<a href="#l9.88"></a><span id="l9.88" class="difflineminus">-</span>
<a href="#l9.89"></a><span id="l9.89" class="difflineminus">-        // Using this way to create the styles, because { and } are special chars</span>
<a href="#l9.90"></a><span id="l9.90" class="difflineminus">-        // in e4x. They have to be escaped, which doesn't improve readability</span>
<a href="#l9.91"></a><span id="l9.91" class="difflineminus">-        html.head.style = &quot;.vevent {border: 1px solid black; padding: 0px; margin-bottom: 10px;}\n&quot;;</span>
<a href="#l9.92"></a><span id="l9.92" class="difflineminus">-        html.head.style += &quot;div.key {font-style: italic; margin-left: 3px;}\n&quot;;</span>
<a href="#l9.93"></a><span id="l9.93" class="difflineminus">-        html.head.style += &quot;div.value {margin-left: 20px;}\n&quot;;</span>
<a href="#l9.94"></a><span id="l9.94" class="difflineminus">-        html.head.style += &quot;abbr {border: none;}\n&quot;;</span>
<a href="#l9.95"></a><span id="l9.95" class="difflineminus">-        html.head.style += &quot;.summarykey {display: none;}\n&quot;;</span>
<a href="#l9.96"></a><span id="l9.96" class="difflineminus">-        html.head.style += &quot;div.summary {background: white; font-weight: bold; margin: 0px; padding: 3px;}\n&quot;;</span>
<a href="#l9.97"></a><span id="l9.97" class="difflineminus">-        html.head.style += &quot;div.description { white-space: pre-wrap; }\n&quot;;</span>
<a href="#l9.98"></a><span id="l9.98" class="difflineplus">+        let document = cal.xml.parseFile(&quot;chrome://calendar/skin/printing/calHtmlExport.html&quot;);</span>
<a href="#l9.99"></a><span id="l9.99" class="difflineplus">+        let itemContainer = document.getElementById(&quot;item-container&quot;);</span>
<a href="#l9.100"></a><span id="l9.100" class="difflineplus">+        document.getElementById(&quot;title&quot;).textContent = aTitle || cal.calGetString(&quot;calendar&quot;, &quot;HTMLTitle&quot;);</span>
<a href="#l9.101"></a><span id="l9.101"> </span>
<a href="#l9.102"></a><span id="l9.102">         // Sort aItems</span>
<a href="#l9.103"></a><span id="l9.103" class="difflineminus">-        function sortFunc(a, b) {</span>
<a href="#l9.104"></a><span id="l9.104" class="difflineplus">+        aItems.sort(function(a, b) {</span>
<a href="#l9.105"></a><span id="l9.105">             let start_a = a[cal.calGetStartDateProp(a)];</span>
<a href="#l9.106"></a><span id="l9.106">             if (!start_a) {</span>
<a href="#l9.107"></a><span id="l9.107">                 return -1;</span>
<a href="#l9.108"></a><span id="l9.108">             }</span>
<a href="#l9.109"></a><span id="l9.109">             let start_b = b[cal.calGetStartDateProp(b)];</span>
<a href="#l9.110"></a><span id="l9.110">             if (!start_b) {</span>
<a href="#l9.111"></a><span id="l9.111">                 return 1;</span>
<a href="#l9.112"></a><span id="l9.112">             }</span>
<a href="#l9.113"></a><span id="l9.113">             return start_a.compare(start_b);</span>
<a href="#l9.114"></a><span id="l9.114" class="difflineminus">-        }</span>
<a href="#l9.115"></a><span id="l9.115" class="difflineminus">-        aItems.sort(sortFunc);</span>
<a href="#l9.116"></a><span id="l9.116" class="difflineplus">+        });</span>
<a href="#l9.117"></a><span id="l9.117"> </span>
<a href="#l9.118"></a><span id="l9.118" class="difflineminus">-        let prefixTitle = cal.calGetString(&quot;calendar&quot;, &quot;htmlPrefixTitle&quot;);</span>
<a href="#l9.119"></a><span id="l9.119" class="difflineminus">-        let prefixWhen = cal.calGetString(&quot;calendar&quot;, &quot;htmlPrefixWhen&quot;);</span>
<a href="#l9.120"></a><span id="l9.120" class="difflineminus">-        let prefixLocation = cal.calGetString(&quot;calendar&quot;, &quot;htmlPrefixLocation&quot;);</span>
<a href="#l9.121"></a><span id="l9.121" class="difflineminus">-        let prefixDescription = cal.calGetString(&quot;calendar&quot;, &quot;htmlPrefixDescription&quot;);</span>
<a href="#l9.122"></a><span id="l9.122" class="difflineminus">-        let defaultTimezone = cal.calendarDefaultTimezone();</span>
<a href="#l9.123"></a><span id="l9.123" class="difflineminus">-</span>
<a href="#l9.124"></a><span id="l9.124" class="difflineminus">-        for (let pos = 0; pos &lt; aItems.length; ++pos) {</span>
<a href="#l9.125"></a><span id="l9.125" class="difflineminus">-            let item = aItems[pos];</span>
<a href="#l9.126"></a><span id="l9.126" class="difflineplus">+        for each (let item in aItems) {</span>
<a href="#l9.127"></a><span id="l9.127" class="difflineplus">+            let itemNode = document.getElementById(&quot;item-template&quot;).cloneNode(true);</span>
<a href="#l9.128"></a><span id="l9.128" class="difflineplus">+            itemNode.removeAttribute(&quot;id&quot;);</span>
<a href="#l9.129"></a><span id="l9.129"> </span>
<a href="#l9.130"></a><span id="l9.130" class="difflineminus">-            // Put properties of the event in a definition list</span>
<a href="#l9.131"></a><span id="l9.131" class="difflineminus">-            // Use hCalendar classes as bonus</span>
<a href="#l9.132"></a><span id="l9.132" class="difflineminus">-            let ev = &lt;div class='vevent'/&gt;;</span>
<a href="#l9.133"></a><span id="l9.133" class="difflineminus">-            let fmtTaskCompleted = cal.calGetString(&quot;calendar&quot;,</span>
<a href="#l9.134"></a><span id="l9.134" class="difflineminus">-                                                    &quot;htmlTaskCompleted&quot;,</span>
<a href="#l9.135"></a><span id="l9.135" class="difflineminus">-                                                    [item.title]);</span>
<a href="#l9.136"></a><span id="l9.136" class="difflineplus">+            function setupTextRow(classKey, propValue, prefixKey) {</span>
<a href="#l9.137"></a><span id="l9.137" class="difflineplus">+                if (propValue) {</span>
<a href="#l9.138"></a><span id="l9.138" class="difflineplus">+                    let prefix = cal.calGetString(&quot;calendar&quot;, prefixKey);</span>
<a href="#l9.139"></a><span id="l9.139" class="difflineplus">+                    itemNode.querySelector(&quot;.&quot; + classKey + &quot;key&quot;).textContent = prefix;</span>
<a href="#l9.140"></a><span id="l9.140" class="difflineplus">+                    itemNode.querySelector(&quot;.&quot; + classKey).textContent = propValue;</span>
<a href="#l9.141"></a><span id="l9.141" class="difflineplus">+                } else {</span>
<a href="#l9.142"></a><span id="l9.142" class="difflineplus">+                    let row = itemNode.querySelector(&quot;.&quot; + classKey + &quot;row&quot;);</span>
<a href="#l9.143"></a><span id="l9.143" class="difflineplus">+                    if (row.nextSibling instanceof Components.interfaces.nsIDOMText) {</span>
<a href="#l9.144"></a><span id="l9.144" class="difflineplus">+                        row.parentNode.removeChild(row.nextSibling);</span>
<a href="#l9.145"></a><span id="l9.145" class="difflineplus">+                    }</span>
<a href="#l9.146"></a><span id="l9.146" class="difflineplus">+                    row.parentNode.removeChild(row);</span>
<a href="#l9.147"></a><span id="l9.147" class="difflineplus">+                }</span>
<a href="#l9.148"></a><span id="l9.148" class="difflineplus">+            }</span>
<a href="#l9.149"></a><span id="l9.149"> </span>
<a href="#l9.150"></a><span id="l9.150" class="difflineminus">-            // Title</span>
<a href="#l9.151"></a><span id="l9.151" class="difflineminus">-            ev.appendChild(</span>
<a href="#l9.152"></a><span id="l9.152" class="difflineminus">-                &lt;div&gt;</span>
<a href="#l9.153"></a><span id="l9.153" class="difflineminus">-                    &lt;div class='key summarykey'&gt;{prefixTitle}&lt;/div&gt;</span>
<a href="#l9.154"></a><span id="l9.154" class="difflineminus">-                    &lt;div class='value summary'&gt;{item.isCompleted ? fmtTaskCompleted : item.title}&lt;/div&gt;</span>
<a href="#l9.155"></a><span id="l9.155" class="difflineminus">-                &lt;/div&gt;</span>
<a href="#l9.156"></a><span id="l9.156" class="difflineminus">-            );</span>
<a href="#l9.157"></a><span id="l9.157">             let startDate = item[cal.calGetStartDateProp(item)];</span>
<a href="#l9.158"></a><span id="l9.158">             let endDate = item[cal.calGetEndDateProp(item)];</span>
<a href="#l9.159"></a><span id="l9.159" class="difflineminus">-            let dateString = cal.getDateFormatter().formatItemInterval(item);</span>
<a href="#l9.160"></a><span id="l9.160" class="difflineminus">-</span>
<a href="#l9.161"></a><span id="l9.161" class="difflineminus">-            if (startDate != null || endDate != null) {</span>
<a href="#l9.162"></a><span id="l9.162" class="difflineplus">+            if (startDate || endDate) {</span>
<a href="#l9.163"></a><span id="l9.163">                 // This is a task with a start or due date, format accordingly</span>
<a href="#l9.164"></a><span id="l9.164" class="difflineminus">-                ev.appendChild(</span>
<a href="#l9.165"></a><span id="l9.165" class="difflineminus">-                    &lt;div&gt;</span>
<a href="#l9.166"></a><span id="l9.166" class="difflineminus">-                        &lt;div class='key'&gt;{prefixWhen}&lt;/div&gt;</span>
<a href="#l9.167"></a><span id="l9.167" class="difflineminus">-                        &lt;div class='value'&gt;</span>
<a href="#l9.168"></a><span id="l9.168" class="difflineminus">-                            &lt;abbr class='dtstart' title={startDate ? startDate.icalString : &quot;none&quot;}&gt;{dateString}&lt;/abbr&gt;</span>
<a href="#l9.169"></a><span id="l9.169" class="difflineminus">-                        &lt;/div&gt;</span>
<a href="#l9.170"></a><span id="l9.170" class="difflineminus">-                    &lt;/div&gt;</span>
<a href="#l9.171"></a><span id="l9.171" class="difflineminus">-                );</span>
<a href="#l9.172"></a><span id="l9.172" class="difflineminus">-            }</span>
<a href="#l9.173"></a><span id="l9.173" class="difflineminus">-            // Location</span>
<a href="#l9.174"></a><span id="l9.174" class="difflineminus">-            if (item.getProperty('LOCATION')) {</span>
<a href="#l9.175"></a><span id="l9.175" class="difflineminus">-                ev.appendChild(</span>
<a href="#l9.176"></a><span id="l9.176" class="difflineminus">-                    &lt;div&gt;</span>
<a href="#l9.177"></a><span id="l9.177" class="difflineminus">-                        &lt;div class='key'&gt;{prefixLocation}&lt;/div&gt;</span>
<a href="#l9.178"></a><span id="l9.178" class="difflineminus">-                        &lt;div class='value location'&gt;{item.getProperty('LOCATION')}&lt;/div&gt;</span>
<a href="#l9.179"></a><span id="l9.179" class="difflineminus">-                    &lt;/div&gt;</span>
<a href="#l9.180"></a><span id="l9.180" class="difflineminus">-                );</span>
<a href="#l9.181"></a><span id="l9.181" class="difflineplus">+                let prefixWhen = cal.calGetString(&quot;calendar&quot;, &quot;htmlPrefixWhen&quot;);</span>
<a href="#l9.182"></a><span id="l9.182" class="difflineplus">+                itemNode.querySelector(&quot;.intervalkey&quot;).textContent = prefixWhen;</span>
<a href="#l9.183"></a><span id="l9.183" class="difflineplus">+</span>
<a href="#l9.184"></a><span id="l9.184" class="difflineplus">+                let startNode = itemNode.querySelector(&quot;.dtstart&quot;);</span>
<a href="#l9.185"></a><span id="l9.185" class="difflineplus">+                let dateString = cal.getDateFormatter().formatItemInterval(item);</span>
<a href="#l9.186"></a><span id="l9.186" class="difflineplus">+                startNode.setAttribute(&quot;title&quot;, (startDate ? startDate.icalString : &quot;none&quot;));</span>
<a href="#l9.187"></a><span id="l9.187" class="difflineplus">+                startNode.textContent = dateString;</span>
<a href="#l9.188"></a><span id="l9.188" class="difflineplus">+            } else {</span>
<a href="#l9.189"></a><span id="l9.189" class="difflineplus">+                let row = itemNode.querySelector(&quot;.intervalrow&quot;);</span>
<a href="#l9.190"></a><span id="l9.190" class="difflineplus">+                row.parentNode.removeChild(row);</span>
<a href="#l9.191"></a><span id="l9.191" class="difflineplus">+                if (row.nextSibling instanceof Components.interfaces.nsIDOMText) {</span>
<a href="#l9.192"></a><span id="l9.192" class="difflineplus">+                    row.parentNode.removeChild(row.nextSibling);</span>
<a href="#l9.193"></a><span id="l9.193" class="difflineplus">+                }</span>
<a href="#l9.194"></a><span id="l9.194">             }</span>
<a href="#l9.195"></a><span id="l9.195"> </span>
<a href="#l9.196"></a><span id="l9.196" class="difflineminus">-            let desc = item.getProperty('DESCRIPTION');</span>
<a href="#l9.197"></a><span id="l9.197" class="difflineminus">-            if (desc &amp;&amp; desc.length &gt; 0) {</span>
<a href="#l9.198"></a><span id="l9.198" class="difflineminus">-                let descnode =</span>
<a href="#l9.199"></a><span id="l9.199" class="difflineminus">-                    &lt;div&gt;</span>
<a href="#l9.200"></a><span id="l9.200" class="difflineminus">-                        &lt;div class='key'&gt;{prefixDescription}&lt;/div&gt;</span>
<a href="#l9.201"></a><span id="l9.201" class="difflineminus">-                        &lt;div class='value description'&gt;{desc}&lt;/div&gt;</span>
<a href="#l9.202"></a><span id="l9.202" class="difflineminus">-                    &lt;/div&gt;;</span>
<a href="#l9.203"></a><span id="l9.203" class="difflineplus">+            let itemTitle = (item.isCompleted ? cal.calGetString(&quot;calendar&quot;, &quot;htmlTaskCompleted&quot;, [item.title]) : item.title);</span>
<a href="#l9.204"></a><span id="l9.204" class="difflineplus">+            setupTextRow(&quot;summary&quot;, itemTitle, &quot;htmlPrefixTitle&quot;);</span>
<a href="#l9.205"></a><span id="l9.205"> </span>
<a href="#l9.206"></a><span id="l9.206" class="difflineminus">-                ev.appendChild(descnode);</span>
<a href="#l9.207"></a><span id="l9.207" class="difflineminus">-            }</span>
<a href="#l9.208"></a><span id="l9.208" class="difflineminus">-            html.body.appendChild(ev);</span>
<a href="#l9.209"></a><span id="l9.209" class="difflineplus">+            setupTextRow(&quot;location&quot;, item.getProperty(&quot;LOCATION&quot;), &quot;htmlPrefixLocation&quot;);</span>
<a href="#l9.210"></a><span id="l9.210" class="difflineplus">+            setupTextRow(&quot;description&quot;, item.getProperty(&quot;DESCRIPTION&quot;), &quot;htmlPrefixDescription&quot;);</span>
<a href="#l9.211"></a><span id="l9.211" class="difflineplus">+</span>
<a href="#l9.212"></a><span id="l9.212" class="difflineplus">+            itemContainer.appendChild(itemNode);</span>
<a href="#l9.213"></a><span id="l9.213">         }</span>
<a href="#l9.214"></a><span id="l9.214"> </span>
<a href="#l9.215"></a><span id="l9.215" class="difflineminus">-        // Convert the javascript string to an array of bytes, using the</span>
<a href="#l9.216"></a><span id="l9.216" class="difflineminus">-        // utf8 encoder</span>
<a href="#l9.217"></a><span id="l9.217" class="difflineplus">+        let templates = document.getElementById(&quot;templates&quot;);</span>
<a href="#l9.218"></a><span id="l9.218" class="difflineplus">+        templates.parentNode.removeChild(templates);</span>
<a href="#l9.219"></a><span id="l9.219" class="difflineplus">+</span>
<a href="#l9.220"></a><span id="l9.220" class="difflineplus">+        // Convert the javascript string to an array of bytes, using the utf8 encoder</span>
<a href="#l9.221"></a><span id="l9.221">         let convStream = Components.classes[&quot;@mozilla.org/intl/converter-output-stream;1&quot;]</span>
<a href="#l9.222"></a><span id="l9.222">                                    .createInstance(Components.interfaces.nsIConverterOutputStream);</span>
<a href="#l9.223"></a><span id="l9.223">         convStream.init(aStream, 'UTF-8', 0, 0x0000);</span>
<a href="#l9.224"></a><span id="l9.224" class="difflineminus">-</span>
<a href="#l9.225"></a><span id="l9.225" class="difflineminus">-        let str = html.toXMLString()</span>
<a href="#l9.226"></a><span id="l9.226" class="difflineminus">-        convStream.writeString(str);</span>
<a href="#l9.227"></a><span id="l9.227" class="difflineplus">+        convStream.writeString(cal.xml.serializeDOM(document));</span>
<a href="#l9.228"></a><span id="l9.228">     }</span>
<a href="#l9.229"></a><span id="l9.229"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/calendar/import-export/calIcsImportExport.js</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/calendar/import-export/calIcsImportExport.js</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -1,91 +1,69 @@</span>
<a href="#l10.4"></a><span id="l10.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l10.5"></a><span id="l10.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l10.6"></a><span id="l10.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l10.7"></a><span id="l10.7"> </span>
<a href="#l10.8"></a><span id="l10.8" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l10.9"></a><span id="l10.9"> Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l10.10"></a><span id="l10.10"> </span>
<a href="#l10.11"></a><span id="l10.11" class="difflineplus">+/**</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineplus">+ * ICS Import and Export Plugin</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+ */</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineplus">+</span>
<a href="#l10.15"></a><span id="l10.15"> // Shared functions</span>
<a href="#l10.16"></a><span id="l10.16"> function getIcsFileTypes(aCount) {</span>
<a href="#l10.17"></a><span id="l10.17">     aCount.value = 1;</span>
<a href="#l10.18"></a><span id="l10.18" class="difflineminus">-    let wildmat = '*.ics';</span>
<a href="#l10.19"></a><span id="l10.19" class="difflineminus">-    let label = cal.calGetString(&quot;calendar&quot;, 'filterIcs', [wildmat]);</span>
<a href="#l10.20"></a><span id="l10.20" class="difflineminus">-    return [{ defaultExtension: 'ics',</span>
<a href="#l10.21"></a><span id="l10.21" class="difflineminus">-              extensionFilter: wildmat,</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineminus">-              description: label }];</span>
<a href="#l10.23"></a><span id="l10.23" class="difflineplus">+    return [{</span>
<a href="#l10.24"></a><span id="l10.24" class="difflineplus">+        QueryInterface: XPCOMUtils.generateQI([Components.interfaces.calIFileType]),</span>
<a href="#l10.25"></a><span id="l10.25" class="difflineplus">+        defaultExtension: 'ics',</span>
<a href="#l10.26"></a><span id="l10.26" class="difflineplus">+        extensionFilter: '*.ics',</span>
<a href="#l10.27"></a><span id="l10.27" class="difflineplus">+        description: cal.calGetString(&quot;calendar&quot;, 'filterIcs', ['*.ics'])</span>
<a href="#l10.28"></a><span id="l10.28" class="difflineplus">+    }];</span>
<a href="#l10.29"></a><span id="l10.29"> }</span>
<a href="#l10.30"></a><span id="l10.30"> </span>
<a href="#l10.31"></a><span id="l10.31"> // Importer</span>
<a href="#l10.32"></a><span id="l10.32"> function calIcsImporter() {</span>
<a href="#l10.33"></a><span id="l10.33"> }</span>
<a href="#l10.34"></a><span id="l10.34"> </span>
<a href="#l10.35"></a><span id="l10.35"> calIcsImporter.prototype = {</span>
<a href="#l10.36"></a><span id="l10.36" class="difflineminus">-    getInterfaces: function (count) {</span>
<a href="#l10.37"></a><span id="l10.37" class="difflineminus">-        const ifaces = [</span>
<a href="#l10.38"></a><span id="l10.38" class="difflineminus">-            Components.interfaces.nsISupports,</span>
<a href="#l10.39"></a><span id="l10.39" class="difflineminus">-            Components.interfaces.nsIClassInfo,</span>
<a href="#l10.40"></a><span id="l10.40" class="difflineminus">-            Components.interfaces.calIImporter,</span>
<a href="#l10.41"></a><span id="l10.41" class="difflineminus">-        ];</span>
<a href="#l10.42"></a><span id="l10.42" class="difflineminus">-        count.value = ifaces.length;</span>
<a href="#l10.43"></a><span id="l10.43" class="difflineminus">-        return ifaces;</span>
<a href="#l10.44"></a><span id="l10.44" class="difflineminus">-    },</span>
<a href="#l10.45"></a><span id="l10.45" class="difflineplus">+    classID: Components.ID(&quot;{1e3e33dc-445a-49de-b2b6-15b2a050bb9d}&quot;),</span>
<a href="#l10.46"></a><span id="l10.46" class="difflineplus">+    QueryInterface: XPCOMUtils.generateQI([Components.interfaces.calIImporter]),</span>
<a href="#l10.47"></a><span id="l10.47"> </span>
<a href="#l10.48"></a><span id="l10.48" class="difflineminus">-    getHelperForLanguage: function (language) {</span>
<a href="#l10.49"></a><span id="l10.49" class="difflineminus">-        return null;</span>
<a href="#l10.50"></a><span id="l10.50" class="difflineminus">-    },</span>
<a href="#l10.51"></a><span id="l10.51" class="difflineminus">-</span>
<a href="#l10.52"></a><span id="l10.52" class="difflineminus">-    contractID: &quot;@mozilla.org/calendar/import;1?type=ics&quot;,</span>
<a href="#l10.53"></a><span id="l10.53" class="difflineminus">-    classDescription: &quot;Calendar ICS Importer&quot;,</span>
<a href="#l10.54"></a><span id="l10.54" class="difflineminus">-    classID: Components.ID(&quot;{1e3e33dc-445a-49de-b2b6-15b2a050bb9d}&quot;),</span>
<a href="#l10.55"></a><span id="l10.55" class="difflineminus">-    implementationLanguage: Components.interfaces.nsIProgrammingLanguage.JAVASCRIPT,</span>
<a href="#l10.56"></a><span id="l10.56" class="difflineminus">-    flags: 0,</span>
<a href="#l10.57"></a><span id="l10.57" class="difflineminus">-</span>
<a href="#l10.58"></a><span id="l10.58" class="difflineminus">-    QueryInterface: function QueryInterface(aIID) {</span>
<a href="#l10.59"></a><span id="l10.59" class="difflineminus">-        return cal.doQueryInterface(this, calIcsImporter.prototype, aIID, null, this);</span>
<a href="#l10.60"></a><span id="l10.60" class="difflineminus">-    },</span>
<a href="#l10.61"></a><span id="l10.61" class="difflineplus">+    classInfo: XPCOMUtils.generateCI({</span>
<a href="#l10.62"></a><span id="l10.62" class="difflineplus">+        classID: Components.ID(&quot;{1e3e33dc-445a-49de-b2b6-15b2a050bb9d}&quot;),</span>
<a href="#l10.63"></a><span id="l10.63" class="difflineplus">+        contractID: &quot;@mozilla.org/calendar/import;1?type=ics&quot;,</span>
<a href="#l10.64"></a><span id="l10.64" class="difflineplus">+        classDescription: &quot;Calendar ICS Importer&quot;,</span>
<a href="#l10.65"></a><span id="l10.65" class="difflineplus">+        interfaces: [Components.interfaces.calIImporter]</span>
<a href="#l10.66"></a><span id="l10.66" class="difflineplus">+    }),</span>
<a href="#l10.67"></a><span id="l10.67"> </span>
<a href="#l10.68"></a><span id="l10.68">     getFileTypes: getIcsFileTypes,</span>
<a href="#l10.69"></a><span id="l10.69"> </span>
<a href="#l10.70"></a><span id="l10.70">     importFromStream: function importFromStream(aStream, aCount) {</span>
<a href="#l10.71"></a><span id="l10.71">         let parser = Components.classes[&quot;@mozilla.org/calendar/ics-parser;1&quot;]</span>
<a href="#l10.72"></a><span id="l10.72">                                .createInstance(Components.interfaces.calIIcsParser);</span>
<a href="#l10.73"></a><span id="l10.73">         parser.parseFromStream(aStream, null);</span>
<a href="#l10.74"></a><span id="l10.74">         return parser.getItems(aCount);</span>
<a href="#l10.75"></a><span id="l10.75">     }</span>
<a href="#l10.76"></a><span id="l10.76"> };</span>
<a href="#l10.77"></a><span id="l10.77"> </span>
<a href="#l10.78"></a><span id="l10.78"> // Exporter</span>
<a href="#l10.79"></a><span id="l10.79"> function calIcsExporter() {</span>
<a href="#l10.80"></a><span id="l10.80"> }</span>
<a href="#l10.81"></a><span id="l10.81"> </span>
<a href="#l10.82"></a><span id="l10.82"> calIcsExporter.prototype = {</span>
<a href="#l10.83"></a><span id="l10.83" class="difflineminus">-    getInterfaces: function (count) {</span>
<a href="#l10.84"></a><span id="l10.84" class="difflineminus">-        const ifaces = [</span>
<a href="#l10.85"></a><span id="l10.85" class="difflineminus">-            Components.interfaces.nsISupports,</span>
<a href="#l10.86"></a><span id="l10.86" class="difflineminus">-            Components.interfaces.nsIClassInfo,</span>
<a href="#l10.87"></a><span id="l10.87" class="difflineminus">-            Components.interfaces.calIExporter,</span>
<a href="#l10.88"></a><span id="l10.88" class="difflineminus">-        ];</span>
<a href="#l10.89"></a><span id="l10.89" class="difflineminus">-        count.value = ifaces.length;</span>
<a href="#l10.90"></a><span id="l10.90" class="difflineminus">-        return ifaces;</span>
<a href="#l10.91"></a><span id="l10.91" class="difflineminus">-    },</span>
<a href="#l10.92"></a><span id="l10.92" class="difflineplus">+    classID: Components.ID(&quot;{a6a524ce-adff-4a0f-bb7d-d1aaad4adc60}&quot;),</span>
<a href="#l10.93"></a><span id="l10.93" class="difflineplus">+    QueryInterface: XPCOMUtils.generateQI([Components.interfaces.calIExporter]),</span>
<a href="#l10.94"></a><span id="l10.94"> </span>
<a href="#l10.95"></a><span id="l10.95" class="difflineminus">-    getHelperForLanguage: function (language) {</span>
<a href="#l10.96"></a><span id="l10.96" class="difflineminus">-        return null;</span>
<a href="#l10.97"></a><span id="l10.97" class="difflineminus">-    },</span>
<a href="#l10.98"></a><span id="l10.98" class="difflineminus">-</span>
<a href="#l10.99"></a><span id="l10.99" class="difflineminus">-    contractID: &quot;@mozilla.org/calendar/export;1?type=ics&quot;,</span>
<a href="#l10.100"></a><span id="l10.100" class="difflineminus">-    classDescription: &quot;Calendar ICS Exporter&quot;,</span>
<a href="#l10.101"></a><span id="l10.101" class="difflineminus">-    classID: Components.ID(&quot;{a6a524ce-adff-4a0f-bb7d-d1aaad4adc60}&quot;),</span>
<a href="#l10.102"></a><span id="l10.102" class="difflineminus">-    implementationLanguage: Components.interfaces.nsIProgrammingLanguage.JAVASCRIPT,</span>
<a href="#l10.103"></a><span id="l10.103" class="difflineminus">-    flags: 0,</span>
<a href="#l10.104"></a><span id="l10.104" class="difflineminus">-</span>
<a href="#l10.105"></a><span id="l10.105" class="difflineminus">-    QueryInterface: function QueryInterface(aIID) {</span>
<a href="#l10.106"></a><span id="l10.106" class="difflineminus">-        return cal.doQueryInterface(this, calIcsExporter.prototype, aIID, null, this);</span>
<a href="#l10.107"></a><span id="l10.107" class="difflineminus">-    },</span>
<a href="#l10.108"></a><span id="l10.108" class="difflineplus">+    classInfo: XPCOMUtils.generateCI({</span>
<a href="#l10.109"></a><span id="l10.109" class="difflineplus">+        classID: Components.ID(&quot;{a6a524ce-adff-4a0f-bb7d-d1aaad4adc60}&quot;),</span>
<a href="#l10.110"></a><span id="l10.110" class="difflineplus">+        contractID: &quot;@mozilla.org/calendar/export;1?type=ics&quot;,</span>
<a href="#l10.111"></a><span id="l10.111" class="difflineplus">+        classDescription: &quot;Calendar ICS Exporter&quot;,</span>
<a href="#l10.112"></a><span id="l10.112" class="difflineplus">+        interfaces: [Components.interfaces.calIExporter]</span>
<a href="#l10.113"></a><span id="l10.113" class="difflineplus">+    }),</span>
<a href="#l10.114"></a><span id="l10.114"> </span>
<a href="#l10.115"></a><span id="l10.115">     getFileTypes: getIcsFileTypes,</span>
<a href="#l10.116"></a><span id="l10.116"> </span>
<a href="#l10.117"></a><span id="l10.117">     exportToStream: function exportToStream(aStream, aCount, aItems) {</span>
<a href="#l10.118"></a><span id="l10.118">         let serializer = Components.classes[&quot;@mozilla.org/calendar/ics-serializer;1&quot;]</span>
<a href="#l10.119"></a><span id="l10.119">                                    .createInstance(Components.interfaces.calIIcsSerializer);</span>
<a href="#l10.120"></a><span id="l10.120">         serializer.addItems(aItems, aItems.length);</span>
<a href="#l10.121"></a><span id="l10.121">         serializer.serializeToStream(aStream);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/calendar/import-export/calListFormatter.js</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/calendar/import-export/calListFormatter.js</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -1,46 +1,32 @@</span>
<a href="#l11.4"></a><span id="l11.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l11.5"></a><span id="l11.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l11.6"></a><span id="l11.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l11.7"></a><span id="l11.7"> </span>
<a href="#l11.8"></a><span id="l11.8" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l11.9"></a><span id="l11.9" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l11.10"></a><span id="l11.10" class="difflineplus">+</span>
<a href="#l11.11"></a><span id="l11.11"> /**</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">- * A thin wrapper that is a print formatter, and just calls the html (list)</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineminus">- * exporter</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineplus">+ * A thin wrapper around the html list exporter for the list print format.</span>
<a href="#l11.15"></a><span id="l11.15">  */</span>
<a href="#l11.16"></a><span id="l11.16"> function calListFormatter() {</span>
<a href="#l11.17"></a><span id="l11.17"> }</span>
<a href="#l11.18"></a><span id="l11.18"> </span>
<a href="#l11.19"></a><span id="l11.19"> calListFormatter.prototype = {</span>
<a href="#l11.20"></a><span id="l11.20" class="difflineminus">-    getInterfaces: function (count) {</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineminus">-        const ifaces = [</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineminus">-            Components.interfaces.nsISupports,</span>
<a href="#l11.23"></a><span id="l11.23" class="difflineminus">-            Components.interfaces.nsIClassInfo,</span>
<a href="#l11.24"></a><span id="l11.24" class="difflineminus">-            Components.interfaces.calIPrintFormatter,</span>
<a href="#l11.25"></a><span id="l11.25" class="difflineminus">-        ];</span>
<a href="#l11.26"></a><span id="l11.26" class="difflineminus">-        count.value = ifaces.length;</span>
<a href="#l11.27"></a><span id="l11.27" class="difflineminus">-        return ifaces;</span>
<a href="#l11.28"></a><span id="l11.28" class="difflineminus">-    },</span>
<a href="#l11.29"></a><span id="l11.29" class="difflineminus">-</span>
<a href="#l11.30"></a><span id="l11.30" class="difflineminus">-    getHelperForLanguage: function (language) {</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineminus">-        return null;</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineminus">-    },</span>
<a href="#l11.33"></a><span id="l11.33" class="difflineplus">+    classID: Components.ID(&quot;{9ae04413-fee3-45b9-8bbb-1eb39a4cbd1b}&quot;),</span>
<a href="#l11.34"></a><span id="l11.34" class="difflineplus">+    QueryInterface: XPCOMUtils.generateQI([Components.interfaces.calIPrintFormatter]),</span>
<a href="#l11.35"></a><span id="l11.35"> </span>
<a href="#l11.36"></a><span id="l11.36" class="difflineminus">-    contractID: &quot;@mozilla.org/calendar/printformatter;1?type=list&quot;,</span>
<a href="#l11.37"></a><span id="l11.37" class="difflineminus">-    classDescription: &quot;Calendar List Print Formatter&quot;,</span>
<a href="#l11.38"></a><span id="l11.38" class="difflineminus">-    classID: Components.ID(&quot;{9ae04413-fee3-45b9-8bbb-1eb39a4cbd1b}&quot;),</span>
<a href="#l11.39"></a><span id="l11.39" class="difflineminus">-    implementationLanguage: Components.interfaces.nsIProgrammingLanguage.JAVASCRIPT,</span>
<a href="#l11.40"></a><span id="l11.40" class="difflineminus">-    flags: 0,</span>
<a href="#l11.41"></a><span id="l11.41" class="difflineplus">+    classInfo: XPCOMUtils.generateCI({</span>
<a href="#l11.42"></a><span id="l11.42" class="difflineplus">+        classID: Components.ID(&quot;{9ae04413-fee3-45b9-8bbb-1eb39a4cbd1b}&quot;),</span>
<a href="#l11.43"></a><span id="l11.43" class="difflineplus">+        contractID: &quot;@mozilla.org/calendar/printformatter;1?type=list&quot;,</span>
<a href="#l11.44"></a><span id="l11.44" class="difflineplus">+        classDescription: &quot;Calendar List Print Formatter&quot;,</span>
<a href="#l11.45"></a><span id="l11.45" class="difflineplus">+        interfaces: [Components.interfaces.calIPrintFormatter]</span>
<a href="#l11.46"></a><span id="l11.46" class="difflineplus">+    }),</span>
<a href="#l11.47"></a><span id="l11.47"> </span>
<a href="#l11.48"></a><span id="l11.48" class="difflineminus">-    QueryInterface: function QueryInterface(aIID) {</span>
<a href="#l11.49"></a><span id="l11.49" class="difflineminus">-        return cal.doQueryInterface(this, calListFormatter.prototype, aIID, null, this);</span>
<a href="#l11.50"></a><span id="l11.50" class="difflineminus">-    },</span>
<a href="#l11.51"></a><span id="l11.51" class="difflineminus">-</span>
<a href="#l11.52"></a><span id="l11.52" class="difflineminus">-    get name() {</span>
<a href="#l11.53"></a><span id="l11.53" class="difflineminus">-        return cal.calGetString(&quot;calendar&quot;, &quot;formatListName&quot;);</span>
<a href="#l11.54"></a><span id="l11.54" class="difflineminus">-    },</span>
<a href="#l11.55"></a><span id="l11.55" class="difflineplus">+    get name() cal.calGetString(&quot;calendar&quot;, &quot;formatListName&quot;),</span>
<a href="#l11.56"></a><span id="l11.56"> </span>
<a href="#l11.57"></a><span id="l11.57">     formatToHtml: function list_formatToHtml(aStream, aStart, aEnd, aCount, aItems, aTitle) {</span>
<a href="#l11.58"></a><span id="l11.58">         let htmlexporter = Components.classes[&quot;@mozilla.org/calendar/export;1?type=htmllist&quot;]</span>
<a href="#l11.59"></a><span id="l11.59">                                      .createInstance(Components.interfaces.calIExporter);</span>
<a href="#l11.60"></a><span id="l11.60">         htmlexporter.exportToStream(aStream, aCount, aItems, aTitle);</span>
<a href="#l11.61"></a><span id="l11.61">     }</span>
<a href="#l11.62"></a><span id="l11.62"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1">new file mode 100644</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineminus">--- /dev/null</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineplus">+++ b/calendar/import-export/calMonthGridPrinter.html</span>
<a href="#l12.4"></a><span id="l12.4" class="difflineat">@@ -0,0 +1,108 @@</span>
<a href="#l12.5"></a><span id="l12.5" class="difflineplus">+&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD XHTML 1.1//EN&quot;</span>
<a href="#l12.6"></a><span id="l12.6" class="difflineplus">+   &quot;http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd&quot;&gt;</span>
<a href="#l12.7"></a><span id="l12.7" class="difflineplus">+&lt;html xmlns=&quot;http://www.w3.org/1999/xhtml&quot;&gt;</span>
<a href="#l12.8"></a><span id="l12.8" class="difflineplus">+  &lt;head&gt;</span>
<a href="#l12.9"></a><span id="l12.9" class="difflineplus">+    &lt;title id=&quot;title&quot;/&gt;</span>
<a href="#l12.10"></a><span id="l12.10" class="difflineplus">+    &lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=UTF-8&quot;/&gt;</span>
<a href="#l12.11"></a><span id="l12.11" class="difflineplus">+    &lt;link rel=&quot;stylesheet&quot; type=&quot;text/css&quot; href=&quot;chrome://calendar/skin/calendar-printing.css&quot;/&gt;</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineplus">+    &lt;style type=&quot;text/css&quot; id=&quot;sheet&quot;&gt;</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+      .main-table { font-size: 26px; font-weight: bold; }</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineplus">+      .day-name { border: 1px solid black; background-color: white; font-size: 12px; font-weight: bold; }</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineplus">+      .day-box { border: 1px solid black; vertical-align: top; }</span>
<a href="#l12.16"></a><span id="l12.16" class="difflineplus">+      .out-of-month { background-color: white !important; }</span>
<a href="#l12.17"></a><span id="l12.17" class="difflineplus">+      .day-off { background-color: white !important; }</span>
<a href="#l12.18"></a><span id="l12.18" class="difflineplus">+  &lt;/style&gt;</span>
<a href="#l12.19"></a><span id="l12.19" class="difflineplus">+  &lt;/head&gt;</span>
<a href="#l12.20"></a><span id="l12.20" class="difflineplus">+  &lt;body&gt;</span>
<a href="#l12.21"></a><span id="l12.21" class="difflineplus">+    &lt;div id=&quot;month-container&quot;/&gt;</span>
<a href="#l12.22"></a><span id="l12.22" class="difflineplus">+    &lt;div id=&quot;tasks-list-box&quot; hidden=&quot;true&quot;&gt;</span>
<a href="#l12.23"></a><span id="l12.23" class="difflineplus">+      &lt;h3 id=&quot;tasks-title&quot;/&gt;</span>
<a href="#l12.24"></a><span id="l12.24" class="difflineplus">+      &lt;ul class=&quot;taskList&quot; id=&quot;task-container&quot;/&gt;</span>
<a href="#l12.25"></a><span id="l12.25" class="difflineplus">+    &lt;/div&gt;</span>
<a href="#l12.26"></a><span id="l12.26" class="difflineplus">+</span>
<a href="#l12.27"></a><span id="l12.27" class="difflineplus">+    &lt;!-- Templates follow --&gt;</span>
<a href="#l12.28"></a><span id="l12.28" class="difflineplus">+    &lt;div id=&quot;templates&quot; hidden=&quot;true&quot;&gt;</span>
<a href="#l12.29"></a><span id="l12.29" class="difflineplus">+      &lt;li id=&quot;task-template&quot;&gt;</span>
<a href="#l12.30"></a><span id="l12.30" class="difflineplus">+        &lt;input type=&quot;checkbox&quot; class=&quot;task-checkbox&quot; disabled=&quot;true&quot;/&gt;</span>
<a href="#l12.31"></a><span id="l12.31" class="difflineplus">+        &lt;s class=&quot;task-title&quot;/&gt;</span>
<a href="#l12.32"></a><span id="l12.32" class="difflineplus">+      &lt;/li&gt;</span>
<a href="#l12.33"></a><span id="l12.33" class="difflineplus">+      &lt;tr id=&quot;item-template&quot;&gt;</span>
<a href="#l12.34"></a><span id="l12.34" class="difflineplus">+        &lt;td valign=&quot;top&quot; style=&quot;font-size: 11px; text-align: left;&quot; class=&quot;category-color-box calendar-color-box&quot;&gt;</span>
<a href="#l12.35"></a><span id="l12.35" class="difflineplus">+          &lt;span class=&quot;item-interval&quot;/&gt;</span>
<a href="#l12.36"></a><span id="l12.36" class="difflineplus">+          &lt;span class=&quot;item-title&quot;/&gt;</span>
<a href="#l12.37"></a><span id="l12.37" class="difflineplus">+        &lt;/td&gt;</span>
<a href="#l12.38"></a><span id="l12.38" class="difflineplus">+      &lt;/tr&gt;</span>
<a href="#l12.39"></a><span id="l12.39" class="difflineplus">+      &lt;div id=&quot;month-template&quot; style=&quot;page-break-after: always;&quot;&gt;</span>
<a href="#l12.40"></a><span id="l12.40" class="difflineplus">+        &lt;table border=&quot;0&quot; width=&quot;100%&quot; class=&quot;main-table&quot;&gt;</span>
<a href="#l12.41"></a><span id="l12.41" class="difflineplus">+          &lt;tr&gt;</span>
<a href="#l12.42"></a><span id="l12.42" class="difflineplus">+            &lt;td align=&quot;center&quot; valign=&quot;bottom&quot; class=&quot;month-name&quot;/&gt;</span>
<a href="#l12.43"></a><span id="l12.43" class="difflineplus">+          &lt;/tr&gt;</span>
<a href="#l12.44"></a><span id="l12.44" class="difflineplus">+        &lt;/table&gt;</span>
<a href="#l12.45"></a><span id="l12.45" class="difflineplus">+        &lt;table style=&quot;border:1px solid black;&quot; width=&quot;100%&quot; class=&quot;week-container&quot;&gt;</span>
<a href="#l12.46"></a><span id="l12.46" class="difflineplus">+          &lt;tr&gt;</span>
<a href="#l12.47"></a><span id="l12.47" class="difflineplus">+            &lt;td class=&quot;day-name day1-title&quot; align=&quot;center&quot; /&gt;</span>
<a href="#l12.48"></a><span id="l12.48" class="difflineplus">+            &lt;td class=&quot;day-name day2-title&quot; align=&quot;center&quot; /&gt;</span>
<a href="#l12.49"></a><span id="l12.49" class="difflineplus">+            &lt;td class=&quot;day-name day3-title&quot; align=&quot;center&quot; /&gt;</span>
<a href="#l12.50"></a><span id="l12.50" class="difflineplus">+            &lt;td class=&quot;day-name day4-title&quot; align=&quot;center&quot; /&gt;</span>
<a href="#l12.51"></a><span id="l12.51" class="difflineplus">+            &lt;td class=&quot;day-name day5-title&quot; align=&quot;center&quot; /&gt;</span>
<a href="#l12.52"></a><span id="l12.52" class="difflineplus">+            &lt;td class=&quot;day-name day6-title&quot; align=&quot;center&quot; /&gt;</span>
<a href="#l12.53"></a><span id="l12.53" class="difflineplus">+            &lt;td class=&quot;day-name day7-title&quot; align=&quot;center&quot; /&gt;</span>
<a href="#l12.54"></a><span id="l12.54" class="difflineplus">+          &lt;/tr&gt;</span>
<a href="#l12.55"></a><span id="l12.55" class="difflineplus">+        &lt;/table&gt;</span>
<a href="#l12.56"></a><span id="l12.56" class="difflineplus">+      &lt;/div&gt;</span>
<a href="#l12.57"></a><span id="l12.57" class="difflineplus">+      &lt;div id=&quot;week-template&quot;&gt;</span>
<a href="#l12.58"></a><span id="l12.58" class="difflineplus">+        &lt;tr&gt;</span>
<a href="#l12.59"></a><span id="l12.59" class="difflineplus">+          &lt;td align=&quot;left&quot; valign=&quot;top&quot; class=&quot;day1-box day-box&quot; height=&quot;100&quot; width=&quot;100&quot;&gt;</span>
<a href="#l12.60"></a><span id="l12.60" class="difflineplus">+            &lt;table valign=&quot;top&quot; style=&quot;font-size: 10px;&quot; class=&quot;day1-container&quot;&gt;</span>
<a href="#l12.61"></a><span id="l12.61" class="difflineplus">+              &lt;tr valign=&quot;top&quot;&gt;</span>
<a href="#l12.62"></a><span id="l12.62" class="difflineplus">+                &lt;td valign=&quot;top&quot; align=&quot;left&quot; class=&quot;day1-number&quot;/&gt;</span>
<a href="#l12.63"></a><span id="l12.63" class="difflineplus">+              &lt;/tr&gt;</span>
<a href="#l12.64"></a><span id="l12.64" class="difflineplus">+            &lt;/table&gt;</span>
<a href="#l12.65"></a><span id="l12.65" class="difflineplus">+          &lt;/td&gt;</span>
<a href="#l12.66"></a><span id="l12.66" class="difflineplus">+          &lt;td align=&quot;left&quot; valign=&quot;top&quot; class=&quot;day2-box day-box&quot; height=&quot;100&quot; width=&quot;100&quot;&gt;</span>
<a href="#l12.67"></a><span id="l12.67" class="difflineplus">+            &lt;table valign=&quot;top&quot; style=&quot;font-size: 10px;&quot; class=&quot;day2-container&quot;&gt;</span>
<a href="#l12.68"></a><span id="l12.68" class="difflineplus">+              &lt;tr valign=&quot;top&quot;&gt;</span>
<a href="#l12.69"></a><span id="l12.69" class="difflineplus">+                &lt;td valign=&quot;top&quot; align=&quot;left&quot; class=&quot;day2-number&quot;/&gt;</span>
<a href="#l12.70"></a><span id="l12.70" class="difflineplus">+              &lt;/tr&gt;</span>
<a href="#l12.71"></a><span id="l12.71" class="difflineplus">+            &lt;/table&gt;</span>
<a href="#l12.72"></a><span id="l12.72" class="difflineplus">+          &lt;/td&gt;</span>
<a href="#l12.73"></a><span id="l12.73" class="difflineplus">+          &lt;td align=&quot;left&quot; valign=&quot;top&quot; class=&quot;day3-box day-box&quot; height=&quot;100&quot; width=&quot;100&quot;&gt;</span>
<a href="#l12.74"></a><span id="l12.74" class="difflineplus">+            &lt;table valign=&quot;top&quot; style=&quot;font-size: 10px;&quot; class=&quot;day3-container&quot;&gt;</span>
<a href="#l12.75"></a><span id="l12.75" class="difflineplus">+              &lt;tr valign=&quot;top&quot;&gt;</span>
<a href="#l12.76"></a><span id="l12.76" class="difflineplus">+                &lt;td valign=&quot;top&quot; align=&quot;left&quot; class=&quot;day3-number&quot;/&gt;</span>
<a href="#l12.77"></a><span id="l12.77" class="difflineplus">+              &lt;/tr&gt;</span>
<a href="#l12.78"></a><span id="l12.78" class="difflineplus">+            &lt;/table&gt;</span>
<a href="#l12.79"></a><span id="l12.79" class="difflineplus">+          &lt;/td&gt;</span>
<a href="#l12.80"></a><span id="l12.80" class="difflineplus">+          &lt;td align=&quot;left&quot; valign=&quot;top&quot; class=&quot;day4-box day-box&quot; height=&quot;100&quot; width=&quot;100&quot;&gt;</span>
<a href="#l12.81"></a><span id="l12.81" class="difflineplus">+            &lt;table valign=&quot;top&quot; style=&quot;font-size: 10px;&quot; class=&quot;day4-container&quot;&gt;</span>
<a href="#l12.82"></a><span id="l12.82" class="difflineplus">+              &lt;tr valign=&quot;top&quot;&gt;</span>
<a href="#l12.83"></a><span id="l12.83" class="difflineplus">+                &lt;td valign=&quot;top&quot; align=&quot;left&quot; class=&quot;day4-number&quot;/&gt;</span>
<a href="#l12.84"></a><span id="l12.84" class="difflineplus">+              &lt;/tr&gt;</span>
<a href="#l12.85"></a><span id="l12.85" class="difflineplus">+            &lt;/table&gt;</span>
<a href="#l12.86"></a><span id="l12.86" class="difflineplus">+          &lt;/td&gt;</span>
<a href="#l12.87"></a><span id="l12.87" class="difflineplus">+          &lt;td align=&quot;left&quot; valign=&quot;top&quot; class=&quot;day5-box day-box&quot; height=&quot;100&quot; width=&quot;100&quot;&gt;</span>
<a href="#l12.88"></a><span id="l12.88" class="difflineplus">+            &lt;table valign=&quot;top&quot; style=&quot;font-size: 10px;&quot; class=&quot;day5-container&quot;&gt;</span>
<a href="#l12.89"></a><span id="l12.89" class="difflineplus">+              &lt;tr valign=&quot;top&quot;&gt;</span>
<a href="#l12.90"></a><span id="l12.90" class="difflineplus">+                &lt;td valign=&quot;top&quot; align=&quot;left&quot; class=&quot;day5-number&quot;/&gt;</span>
<a href="#l12.91"></a><span id="l12.91" class="difflineplus">+              &lt;/tr&gt;</span>
<a href="#l12.92"></a><span id="l12.92" class="difflineplus">+            &lt;/table&gt;</span>
<a href="#l12.93"></a><span id="l12.93" class="difflineplus">+          &lt;/td&gt;</span>
<a href="#l12.94"></a><span id="l12.94" class="difflineplus">+          &lt;td align=&quot;left&quot; valign=&quot;top&quot; class=&quot;day6-box day-box&quot; height=&quot;100&quot; width=&quot;100&quot;&gt;</span>
<a href="#l12.95"></a><span id="l12.95" class="difflineplus">+            &lt;table valign=&quot;top&quot; style=&quot;font-size: 10px;&quot; class=&quot;day6-container&quot;&gt;</span>
<a href="#l12.96"></a><span id="l12.96" class="difflineplus">+              &lt;tr valign=&quot;top&quot;&gt;</span>
<a href="#l12.97"></a><span id="l12.97" class="difflineplus">+                &lt;td valign=&quot;top&quot; align=&quot;left&quot; class=&quot;day6-number&quot;/&gt;</span>
<a href="#l12.98"></a><span id="l12.98" class="difflineplus">+              &lt;/tr&gt;</span>
<a href="#l12.99"></a><span id="l12.99" class="difflineplus">+            &lt;/table&gt;</span>
<a href="#l12.100"></a><span id="l12.100" class="difflineplus">+          &lt;/td&gt;</span>
<a href="#l12.101"></a><span id="l12.101" class="difflineplus">+          &lt;td align=&quot;left&quot; valign=&quot;top&quot; class=&quot;day7-box day-box&quot; height=&quot;100&quot; width=&quot;100&quot;&gt;</span>
<a href="#l12.102"></a><span id="l12.102" class="difflineplus">+            &lt;table valign=&quot;top&quot; style=&quot;font-size: 10px;&quot; class=&quot;day7-container&quot;&gt;</span>
<a href="#l12.103"></a><span id="l12.103" class="difflineplus">+              &lt;tr valign=&quot;top&quot;&gt;</span>
<a href="#l12.104"></a><span id="l12.104" class="difflineplus">+                &lt;td valign=&quot;top&quot; align=&quot;left&quot; class=&quot;day7-number&quot;/&gt;</span>
<a href="#l12.105"></a><span id="l12.105" class="difflineplus">+              &lt;/tr&gt;</span>
<a href="#l12.106"></a><span id="l12.106" class="difflineplus">+            &lt;/table&gt;</span>
<a href="#l12.107"></a><span id="l12.107" class="difflineplus">+          &lt;/td&gt;</span>
<a href="#l12.108"></a><span id="l12.108" class="difflineplus">+        &lt;/tr&gt;</span>
<a href="#l12.109"></a><span id="l12.109" class="difflineplus">+      &lt;/div&gt;</span>
<a href="#l12.110"></a><span id="l12.110" class="difflineplus">+    &lt;/div&gt;</span>
<a href="#l12.111"></a><span id="l12.111" class="difflineplus">+  &lt;/body&gt;</span>
<a href="#l12.112"></a><span id="l12.112" class="difflineplus">+&lt;/html&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/calendar/import-export/calMonthGridPrinter.js</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/calendar/import-export/calMonthGridPrinter.js</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -1,316 +1,207 @@</span>
<a href="#l13.4"></a><span id="l13.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l13.5"></a><span id="l13.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l13.6"></a><span id="l13.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l13.7"></a><span id="l13.7"> </span>
<a href="#l13.8"></a><span id="l13.8" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l13.9"></a><span id="l13.9" class="difflineplus">+</span>
<a href="#l13.10"></a><span id="l13.10" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l13.11"></a><span id="l13.11" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calXMLUtils.jsm&quot;);</span>
<a href="#l13.12"></a><span id="l13.12"> Components.utils.import(&quot;resource://calendar/modules/calPrintUtils.jsm&quot;);</span>
<a href="#l13.13"></a><span id="l13.13"> </span>
<a href="#l13.14"></a><span id="l13.14"> /**</span>
<a href="#l13.15"></a><span id="l13.15">  * Prints a rough month-grid of events/tasks</span>
<a href="#l13.16"></a><span id="l13.16">  */</span>
<a href="#l13.17"></a><span id="l13.17"> function calMonthPrinter() {</span>
<a href="#l13.18"></a><span id="l13.18"> }</span>
<a href="#l13.19"></a><span id="l13.19"> </span>
<a href="#l13.20"></a><span id="l13.20"> calMonthPrinter.prototype = {</span>
<a href="#l13.21"></a><span id="l13.21" class="difflineminus">-    getInterfaces: function (count) {</span>
<a href="#l13.22"></a><span id="l13.22" class="difflineminus">-        const ifaces = [</span>
<a href="#l13.23"></a><span id="l13.23" class="difflineminus">-            Components.interfaces.nsISupports,</span>
<a href="#l13.24"></a><span id="l13.24" class="difflineminus">-            Components.interfaces.nsIClassInfo,</span>
<a href="#l13.25"></a><span id="l13.25" class="difflineminus">-            Components.interfaces.calIPrintFormatter,</span>
<a href="#l13.26"></a><span id="l13.26" class="difflineminus">-        ];</span>
<a href="#l13.27"></a><span id="l13.27" class="difflineminus">-        count.value = ifaces.length;</span>
<a href="#l13.28"></a><span id="l13.28" class="difflineminus">-        return ifaces;</span>
<a href="#l13.29"></a><span id="l13.29" class="difflineminus">-    },</span>
<a href="#l13.30"></a><span id="l13.30" class="difflineminus">-</span>
<a href="#l13.31"></a><span id="l13.31" class="difflineminus">-    getHelperForLanguage: function (language) {</span>
<a href="#l13.32"></a><span id="l13.32" class="difflineminus">-        return null;</span>
<a href="#l13.33"></a><span id="l13.33" class="difflineminus">-    },</span>
<a href="#l13.34"></a><span id="l13.34" class="difflineplus">+    classID: Components.ID(&quot;{f42d5132-92c4-487b-b5c8-38bf292d74c1}&quot;),</span>
<a href="#l13.35"></a><span id="l13.35" class="difflineplus">+    QueryInterface: XPCOMUtils.generateQI([Components.interfaces.calIPrintFormatter]),</span>
<a href="#l13.36"></a><span id="l13.36"> </span>
<a href="#l13.37"></a><span id="l13.37" class="difflineminus">-    contractID: &quot;@mozilla.org/calendar/printformatter;1?type=monthgrid&quot;,</span>
<a href="#l13.38"></a><span id="l13.38" class="difflineminus">-    classDescription: &quot;Calendar Month Grid Print Formatter&quot;,</span>
<a href="#l13.39"></a><span id="l13.39" class="difflineminus">-    classID: Components.ID(&quot;{f42d5132-92c4-487b-b5c8-38bf292d74c1}&quot;),</span>
<a href="#l13.40"></a><span id="l13.40" class="difflineminus">-    implementationLanguage: Components.interfaces.nsIProgrammingLanguage.JAVASCRIPT,</span>
<a href="#l13.41"></a><span id="l13.41" class="difflineminus">-    flags: 0,</span>
<a href="#l13.42"></a><span id="l13.42" class="difflineplus">+    classInfo: XPCOMUtils.generateCI({</span>
<a href="#l13.43"></a><span id="l13.43" class="difflineplus">+        classID: Components.ID(&quot;{f42d5132-92c4-487b-b5c8-38bf292d74c1}&quot;),</span>
<a href="#l13.44"></a><span id="l13.44" class="difflineplus">+        contractID: &quot;@mozilla.org/calendar/printformatter;1?type=monthgrid&quot;,</span>
<a href="#l13.45"></a><span id="l13.45" class="difflineplus">+        classDescription: &quot;Calendar Month Grid Print Formatter&quot;,</span>
<a href="#l13.46"></a><span id="l13.46" class="difflineplus">+        interfaces: [Components.interfaces.calIPrintFormatter]</span>
<a href="#l13.47"></a><span id="l13.47" class="difflineplus">+    }),</span>
<a href="#l13.48"></a><span id="l13.48"> </span>
<a href="#l13.49"></a><span id="l13.49" class="difflineminus">-    QueryInterface: function QueryInterface(aIID) {</span>
<a href="#l13.50"></a><span id="l13.50" class="difflineminus">-        return cal.doQueryInterface(this, calMonthPrinter.prototype, aIID, null, this);</span>
<a href="#l13.51"></a><span id="l13.51" class="difflineminus">-    },</span>
<a href="#l13.52"></a><span id="l13.52" class="difflineminus">-</span>
<a href="#l13.53"></a><span id="l13.53" class="difflineminus">-    get name() {</span>
<a href="#l13.54"></a><span id="l13.54" class="difflineminus">-        return cal.calGetString(&quot;calendar&quot;, &quot;monthPrinterName&quot;);</span>
<a href="#l13.55"></a><span id="l13.55" class="difflineminus">-    },</span>
<a href="#l13.56"></a><span id="l13.56" class="difflineplus">+    get name() cal.calGetString(&quot;calendar&quot;, &quot;monthPrinterName&quot;),</span>
<a href="#l13.57"></a><span id="l13.57"> </span>
<a href="#l13.58"></a><span id="l13.58">     formatToHtml: function monthPrint_format(aStream, aStart, aEnd, aCount, aItems, aTitle) {</span>
<a href="#l13.59"></a><span id="l13.59" class="difflineminus">-        let html = &lt;html/&gt;</span>
<a href="#l13.60"></a><span id="l13.60" class="difflineminus">-        html.appendChild(</span>
<a href="#l13.61"></a><span id="l13.61" class="difflineminus">-                &lt;head&gt;</span>
<a href="#l13.62"></a><span id="l13.62" class="difflineminus">-                    &lt;title&gt;{aTitle}&lt;/title&gt;</span>
<a href="#l13.63"></a><span id="l13.63" class="difflineminus">-                    &lt;meta http-equiv='Content-Type' content='text/html; charset=UTF-8'/&gt;</span>
<a href="#l13.64"></a><span id="l13.64" class="difflineminus">-                    &lt;link rel='stylesheet' type='text/css' href='chrome://calendar/skin/calendar-printing.css'/&gt;</span>
<a href="#l13.65"></a><span id="l13.65" class="difflineminus">-                &lt;/head&gt;);</span>
<a href="#l13.66"></a><span id="l13.66" class="difflineminus">-        html.head.style = &quot;.main-table { font-size: 26px; font-weight: bold; }\n&quot;;</span>
<a href="#l13.67"></a><span id="l13.67" class="difflineminus">-        html.head.style += &quot;.day-name { border: 1px solid black; background-color: white; font-size: 12px; font-weight: bold; }\n&quot;;</span>
<a href="#l13.68"></a><span id="l13.68" class="difflineminus">-        html.head.style += &quot;.day-box { border: 1px solid black; vertical-align: top; }\n&quot;;</span>
<a href="#l13.69"></a><span id="l13.69" class="difflineminus">-        html.head.style += &quot;.out-of-month { background-color: white !important; }\n&quot;;</span>
<a href="#l13.70"></a><span id="l13.70" class="difflineminus">-        html.head.style += &quot;.day-off { background-color: white !important; }\n&quot;;</span>
<a href="#l13.71"></a><span id="l13.71" class="difflineplus">+        let document = cal.xml.parseFile(&quot;chrome://calendar/skin/printing/calMonthGridPrinter.html&quot;);</span>
<a href="#l13.72"></a><span id="l13.72" class="difflineplus">+</span>
<a href="#l13.73"></a><span id="l13.73" class="difflineplus">+        // Set page title</span>
<a href="#l13.74"></a><span id="l13.74" class="difflineplus">+        document.getElementById(&quot;title&quot;).textContent = aTitle;</span>
<a href="#l13.75"></a><span id="l13.75" class="difflineplus">+</span>
<a href="#l13.76"></a><span id="l13.76" class="difflineplus">+        // Table that maps YYYY-MM-DD to the DOM node container where items are to be added</span>
<a href="#l13.77"></a><span id="l13.77" class="difflineplus">+        let dayTable = {};</span>
<a href="#l13.78"></a><span id="l13.78" class="difflineplus">+</span>
<a href="#l13.79"></a><span id="l13.79" class="difflineplus">+        // Make sure to create tables from start to end, if passed</span>
<a href="#l13.80"></a><span id="l13.80" class="difflineplus">+        if (aStart &amp;&amp; aEnd) {</span>
<a href="#l13.81"></a><span id="l13.81" class="difflineplus">+            // Make sure the start date is really a date.</span>
<a href="#l13.82"></a><span id="l13.82" class="difflineplus">+            let startDate = aStart.clone();</span>
<a href="#l13.83"></a><span id="l13.83" class="difflineplus">+            startDate.isDate = true;</span>
<a href="#l13.84"></a><span id="l13.84" class="difflineplus">+</span>
<a href="#l13.85"></a><span id="l13.85" class="difflineplus">+            // Copy end date, which is exclusive. For our calculations, we will</span>
<a href="#l13.86"></a><span id="l13.86" class="difflineplus">+            // only be handling dates and the below code is much cleaner with</span>
<a href="#l13.87"></a><span id="l13.87" class="difflineplus">+            // the range being inclusive.</span>
<a href="#l13.88"></a><span id="l13.88" class="difflineplus">+            let endDate = aEnd.clone();</span>
<a href="#l13.89"></a><span id="l13.89" class="difflineplus">+            endDate.isDate = true;</span>
<a href="#l13.90"></a><span id="l13.90" class="difflineplus">+</span>
<a href="#l13.91"></a><span id="l13.91" class="difflineplus">+            // Find out if the start date is also shown in the first week of the</span>
<a href="#l13.92"></a><span id="l13.92" class="difflineplus">+            // following month. This means we can spare a month printout.</span>
<a href="#l13.93"></a><span id="l13.93" class="difflineplus">+            let probeDate = startDate.clone();</span>
<a href="#l13.94"></a><span id="l13.94" class="difflineplus">+            probeDate.month++;</span>
<a href="#l13.95"></a><span id="l13.95" class="difflineplus">+            probeDate.day = 1;</span>
<a href="#l13.96"></a><span id="l13.96" class="difflineplus">+            if (cal.userWeekStart(probeDate).compare(startDate) &lt;= 0) {</span>
<a href="#l13.97"></a><span id="l13.97" class="difflineplus">+                startDate = probeDate;</span>
<a href="#l13.98"></a><span id="l13.98" class="difflineplus">+            } else {</span>
<a href="#l13.99"></a><span id="l13.99" class="difflineplus">+                startDate = startDate.startOfMonth;</span>
<a href="#l13.100"></a><span id="l13.100" class="difflineplus">+            }</span>
<a href="#l13.101"></a><span id="l13.101"> </span>
<a href="#l13.102"></a><span id="l13.102" class="difflineminus">-        // If aStart or aEnd weren't passed in, we need to calculate them based on</span>
<a href="#l13.103"></a><span id="l13.103" class="difflineminus">-        // aItems data.</span>
<a href="#l13.104"></a><span id="l13.104" class="difflineplus">+            // Find out if the end date is also shown in the last week of the</span>
<a href="#l13.105"></a><span id="l13.105" class="difflineplus">+            // previous month. This also means we can spare a month printout.</span>
<a href="#l13.106"></a><span id="l13.106" class="difflineplus">+            probeDate = endDate.clone();</span>
<a href="#l13.107"></a><span id="l13.107" class="difflineplus">+            probeDate.month--;</span>
<a href="#l13.108"></a><span id="l13.108" class="difflineplus">+            probeDate = probeDate.endOfMonth;</span>
<a href="#l13.109"></a><span id="l13.109" class="difflineplus">+            if (cal.userWeekEnd(probeDate).compare(endDate) &gt;= 0) {</span>
<a href="#l13.110"></a><span id="l13.110" class="difflineplus">+                endDate = probeDate;</span>
<a href="#l13.111"></a><span id="l13.111" class="difflineplus">+            }</span>
<a href="#l13.112"></a><span id="l13.112" class="difflineplus">+</span>
<a href="#l13.113"></a><span id="l13.113" class="difflineplus">+            // Now set up all the months we need to</span>
<a href="#l13.114"></a><span id="l13.114" class="difflineplus">+            for (let current = startDate.clone(); cal.userWeekEnd(current).compare(endDate) &lt;= 0; current.month += 1) {</span>
<a href="#l13.115"></a><span id="l13.115" class="difflineplus">+                this.setupMonth(document, current, dayTable);</span>
<a href="#l13.116"></a><span id="l13.116" class="difflineplus">+            }</span>
<a href="#l13.117"></a><span id="l13.117" class="difflineplus">+        }</span>
<a href="#l13.118"></a><span id="l13.118" class="difflineplus">+</span>
<a href="#l13.119"></a><span id="l13.119" class="difflineplus">+        for each (let item in aItems) {</span>
<a href="#l13.120"></a><span id="l13.120" class="difflineplus">+            let boxDate = item[cal.calGetStartDateProp(item)] || item[cal.calGetEndDateProp(item)];</span>
<a href="#l13.121"></a><span id="l13.121"> </span>
<a href="#l13.122"></a><span id="l13.122" class="difflineminus">-        let start = aStart;</span>
<a href="#l13.123"></a><span id="l13.123" class="difflineminus">-        let end = aEnd;</span>
<a href="#l13.124"></a><span id="l13.124" class="difflineminus">-        if (!start || !end) {</span>
<a href="#l13.125"></a><span id="l13.125" class="difflineminus">-            for each (let item in aItems) {</span>
<a href="#l13.126"></a><span id="l13.126" class="difflineminus">-                let itemStart = item[cal.calGetStartDateProp(item)];</span>
<a href="#l13.127"></a><span id="l13.127" class="difflineminus">-                let itemEnd = item[cal.calGetEndDateProp(item)];</span>
<a href="#l13.128"></a><span id="l13.128" class="difflineminus">-                if (!start || (itemStart &amp;&amp; start.compare(itemStart) == 1)) {</span>
<a href="#l13.129"></a><span id="l13.129" class="difflineminus">-                    start = itemStart;</span>
<a href="#l13.130"></a><span id="l13.130" class="difflineplus">+            // Ignore items outside of the range, i.e tasks without start date</span>
<a href="#l13.131"></a><span id="l13.131" class="difflineplus">+            // where the end date is somewhere else.</span>
<a href="#l13.132"></a><span id="l13.132" class="difflineplus">+            if (aStart &amp;&amp; aEnd &amp;&amp; boxDate &amp;&amp;</span>
<a href="#l13.133"></a><span id="l13.133" class="difflineplus">+                (boxDate.compare(aStart) &lt; 0 || boxDate.compare(aEnd) &gt;= 0)) {</span>
<a href="#l13.134"></a><span id="l13.134" class="difflineplus">+                continue;</span>
<a href="#l13.135"></a><span id="l13.135" class="difflineplus">+            }</span>
<a href="#l13.136"></a><span id="l13.136" class="difflineplus">+</span>
<a href="#l13.137"></a><span id="l13.137" class="difflineplus">+            if (boxDate) {</span>
<a href="#l13.138"></a><span id="l13.138" class="difflineplus">+                let boxDateKey = cal.print.getDateKey(boxDate);</span>
<a href="#l13.139"></a><span id="l13.139" class="difflineplus">+</span>
<a href="#l13.140"></a><span id="l13.140" class="difflineplus">+                if (!(boxDateKey in dayTable)) {</span>
<a href="#l13.141"></a><span id="l13.141" class="difflineplus">+                    // Doesn't exist, we need to create a new table for it</span>
<a href="#l13.142"></a><span id="l13.142" class="difflineplus">+                    let startOfMonth = boxDate.startOfMonth;</span>
<a href="#l13.143"></a><span id="l13.143" class="difflineplus">+                    this.setupMonth(document, startOfMonth, dayTable);</span>
<a href="#l13.144"></a><span id="l13.144">                 }</span>
<a href="#l13.145"></a><span id="l13.145" class="difflineminus">-                if (!end || (itemEnd &amp;&amp; end.compare(itemEnd) == -1)) {</span>
<a href="#l13.146"></a><span id="l13.146" class="difflineminus">-                    end = itemEnd;</span>
<a href="#l13.147"></a><span id="l13.147" class="difflineplus">+</span>
<a href="#l13.148"></a><span id="l13.148" class="difflineplus">+                let dayBoxes = dayTable[boxDateKey];</span>
<a href="#l13.149"></a><span id="l13.149" class="difflineplus">+                let addSingleItem = cal.print.addItemToDaybox.bind(cal.print, document, item);</span>
<a href="#l13.150"></a><span id="l13.150" class="difflineplus">+</span>
<a href="#l13.151"></a><span id="l13.151" class="difflineplus">+                if (Array.isArray(dayBoxes)) {</span>
<a href="#l13.152"></a><span id="l13.152" class="difflineplus">+                    dayBoxes.forEach(addSingleItem);</span>
<a href="#l13.153"></a><span id="l13.153" class="difflineplus">+                } else {</span>
<a href="#l13.154"></a><span id="l13.154" class="difflineplus">+                    addSingleItem(dayBoxes);</span>
<a href="#l13.155"></a><span id="l13.155">                 }</span>
<a href="#l13.156"></a><span id="l13.156" class="difflineplus">+            } else {</span>
<a href="#l13.157"></a><span id="l13.157" class="difflineplus">+                cal.print.addItemToDayboxNodate(document, item);</span>
<a href="#l13.158"></a><span id="l13.158">             }</span>
<a href="#l13.159"></a><span id="l13.159">         }</span>
<a href="#l13.160"></a><span id="l13.160"> </span>
<a href="#l13.161"></a><span id="l13.161" class="difflineminus">-        // Play around with aStart and aEnd to determine the minimal number of</span>
<a href="#l13.162"></a><span id="l13.162" class="difflineminus">-        // months we can show to still technically meet their requirements.  This</span>
<a href="#l13.163"></a><span id="l13.163" class="difflineminus">-        // is most useful when someone printed 'Current View' in the month view. If</span>
<a href="#l13.164"></a><span id="l13.164" class="difflineminus">-        // we take the aStart and aEnd literally, we'll print 3 months (because of</span>
<a href="#l13.165"></a><span id="l13.165" class="difflineminus">-        // the extra days at the start/end), but we should avoid that.</span>
<a href="#l13.166"></a><span id="l13.166" class="difflineminus">-        //</span>
<a href="#l13.167"></a><span id="l13.167" class="difflineminus">-        // Basically, we check whether aStart falls in the same week as the start</span>
<a href="#l13.168"></a><span id="l13.168" class="difflineminus">-        // of a month (ie aStart  is Jan 29, which often is in the same week as</span>
<a href="#l13.169"></a><span id="l13.169" class="difflineminus">-        // Feb 1), and similarly whether aEnd falls in the same week as the end of</span>
<a href="#l13.170"></a><span id="l13.170" class="difflineminus">-        // a month.</span>
<a href="#l13.171"></a><span id="l13.171" class="difflineminus">-        let weekStart = cal.getPrefSafe(&quot;calendar.week.start&quot;, 0);</span>
<a href="#l13.172"></a><span id="l13.172" class="difflineminus">-        let maybeNewStart = start.clone();</span>
<a href="#l13.173"></a><span id="l13.173" class="difflineminus">-        maybeNewStart.day = 1;</span>
<a href="#l13.174"></a><span id="l13.174" class="difflineminus">-        maybeNewStart.month = start.month+1;</span>
<a href="#l13.175"></a><span id="l13.175" class="difflineminus">-</span>
<a href="#l13.176"></a><span id="l13.176" class="difflineminus">-        let dt = start.clone();</span>
<a href="#l13.177"></a><span id="l13.177" class="difflineminus">-</span>
<a href="#l13.178"></a><span id="l13.178" class="difflineminus">-        // First we have to adjust the end date for comparison, as the</span>
<a href="#l13.179"></a><span id="l13.179" class="difflineminus">-        // provided end date is exclusive, i.e. will not be displayed.</span>
<a href="#l13.180"></a><span id="l13.180" class="difflineminus">-</span>
<a href="#l13.181"></a><span id="l13.181" class="difflineminus">-        let realEnd = end.clone();</span>
<a href="#l13.182"></a><span id="l13.182" class="difflineminus">-        realEnd.day -= 1;</span>
<a href="#l13.183"></a><span id="l13.183" class="difflineminus">-</span>
<a href="#l13.184"></a><span id="l13.184" class="difflineminus">-        if (start.compare(realEnd) &lt;= 0) {</span>
<a href="#l13.185"></a><span id="l13.185" class="difflineminus">-            // Only adjust dates if start date is earlier than end date.</span>
<a href="#l13.186"></a><span id="l13.186" class="difflineminus">-</span>
<a href="#l13.187"></a><span id="l13.187" class="difflineminus">-            if ((start.month != realEnd.month) || (start.year != realEnd.year)) {</span>
<a href="#l13.188"></a><span id="l13.188" class="difflineminus">-                // We only need to adjust if start and end are in different months.</span>
<a href="#l13.189"></a><span id="l13.189" class="difflineminus">-</span>
<a href="#l13.190"></a><span id="l13.190" class="difflineminus">-                // We want to check whether or not the start day is in the same</span>
<a href="#l13.191"></a><span id="l13.191" class="difflineminus">-                // week as the beginning of the next month. To do this, we take</span>
<a href="#l13.192"></a><span id="l13.192" class="difflineminus">-                // the start date, add seven days and subtract the &quot;day of week&quot;</span>
<a href="#l13.193"></a><span id="l13.193" class="difflineminus">-                // value (which has to be corrected in case we do not start on</span>
<a href="#l13.194"></a><span id="l13.194" class="difflineminus">-                // Sunday).</span>
<a href="#l13.195"></a><span id="l13.195" class="difflineminus">-                let testBegin = start.clone();</span>
<a href="#l13.196"></a><span id="l13.196" class="difflineminus">-                let startWeekday = testBegin.weekday;</span>
<a href="#l13.197"></a><span id="l13.197" class="difflineminus">-                if (startWeekday &lt; weekStart) {</span>
<a href="#l13.198"></a><span id="l13.198" class="difflineminus">-                    startWeekday += 7;</span>
<a href="#l13.199"></a><span id="l13.199" class="difflineminus">-                }</span>
<a href="#l13.200"></a><span id="l13.200" class="difflineminus">-                testBegin.day += 7 + weekStart - startWeekday;</span>
<a href="#l13.201"></a><span id="l13.201" class="difflineminus">-                if (testBegin.compare(maybeNewStart) &gt; 0) {</span>
<a href="#l13.202"></a><span id="l13.202" class="difflineminus">-                    start = maybeNewStart;</span>
<a href="#l13.203"></a><span id="l13.203" class="difflineminus">-                    dt = start.clone();</span>
<a href="#l13.204"></a><span id="l13.204" class="difflineminus">-                }</span>
<a href="#l13.205"></a><span id="l13.205" class="difflineminus">-            }</span>
<a href="#l13.206"></a><span id="l13.206" class="difflineminus">-            if ((start.month != realEnd.month) || (start.year != realEnd.year)) {</span>
<a href="#l13.207"></a><span id="l13.207" class="difflineminus">-                // We only need to adjust if start and end are in different months.</span>
<a href="#l13.208"></a><span id="l13.208" class="difflineplus">+        // Remove templates from HTML, no longer needed</span>
<a href="#l13.209"></a><span id="l13.209" class="difflineplus">+        let templates = document.getElementById(&quot;templates&quot;);</span>
<a href="#l13.210"></a><span id="l13.210" class="difflineplus">+        templates.parentNode.removeChild(templates);</span>
<a href="#l13.211"></a><span id="l13.211"> </span>
<a href="#l13.212"></a><span id="l13.212" class="difflineminus">-                // Next, we want to check whether or not the end day is in the same</span>
<a href="#l13.213"></a><span id="l13.213" class="difflineminus">-                // week as the end of the previous month. So we have to get the</span>
<a href="#l13.214"></a><span id="l13.214" class="difflineminus">-                // &quot;day of week&quot; value for the end of the previous month, adjust it</span>
<a href="#l13.215"></a><span id="l13.215" class="difflineminus">-                // if necessary (when start of week is not Sunday) and check if the</span>
<a href="#l13.216"></a><span id="l13.216" class="difflineminus">-                // end day is in the same week.</span>
<a href="#l13.217"></a><span id="l13.217" class="difflineminus">-</span>
<a href="#l13.218"></a><span id="l13.218" class="difflineminus">-                let lastDayOfPreviousMonth = end.clone();</span>
<a href="#l13.219"></a><span id="l13.219" class="difflineminus">-                lastDayOfPreviousMonth.day = 0;</span>
<a href="#l13.220"></a><span id="l13.220" class="difflineminus">-                let lastDayWeekday = lastDayOfPreviousMonth.weekday;</span>
<a href="#l13.221"></a><span id="l13.221" class="difflineminus">-                if (lastDayWeekday &lt; weekStart) {</span>
<a href="#l13.222"></a><span id="l13.222" class="difflineminus">-                    lastDayWeekday += 7;</span>
<a href="#l13.223"></a><span id="l13.223" class="difflineminus">-                }</span>
<a href="#l13.224"></a><span id="l13.224" class="difflineminus">-                if (dt.month != end.month) {</span>
<a href="#l13.225"></a><span id="l13.225" class="difflineminus">-                    dt.day = 1;</span>
<a href="#l13.226"></a><span id="l13.226" class="difflineminus">-                }</span>
<a href="#l13.227"></a><span id="l13.227" class="difflineminus">-                if ((lastDayWeekday + end.day - 1) &lt; (7 + weekStart)) {</span>
<a href="#l13.228"></a><span id="l13.228" class="difflineminus">-                    dt.day = end.day;</span>
<a href="#l13.229"></a><span id="l13.229" class="difflineminus">-                }</span>
<a href="#l13.230"></a><span id="l13.230" class="difflineminus">-</span>
<a href="#l13.231"></a><span id="l13.231" class="difflineminus">-                // Finally, we have to check whether we adjusted the dates too</span>
<a href="#l13.232"></a><span id="l13.232" class="difflineminus">-                // well so that nothing is printed. That happens if you print just</span>
<a href="#l13.233"></a><span id="l13.233" class="difflineminus">-                // one week which has the last day of a month in it.</span>
<a href="#l13.234"></a><span id="l13.234" class="difflineminus">-</span>
<a href="#l13.235"></a><span id="l13.235" class="difflineminus">-                if (dt.compare(end) &gt;= 0) {</span>
<a href="#l13.236"></a><span id="l13.236" class="difflineminus">-                    dt.day = 1;</span>
<a href="#l13.237"></a><span id="l13.237" class="difflineminus">-                }</span>
<a href="#l13.238"></a><span id="l13.238" class="difflineminus">-            } else {</span>
<a href="#l13.239"></a><span id="l13.239" class="difflineminus">-                dt.day = 1;</span>
<a href="#l13.240"></a><span id="l13.240" class="difflineminus">-            }</span>
<a href="#l13.241"></a><span id="l13.241" class="difflineminus">-        } else {</span>
<a href="#l13.242"></a><span id="l13.242" class="difflineminus">-             // If start date is after end date, just print empty month.</span>
<a href="#l13.243"></a><span id="l13.243" class="difflineminus">-             dt = realEnd.clone();</span>
<a href="#l13.244"></a><span id="l13.244" class="difflineminus">-        }</span>
<a href="#l13.245"></a><span id="l13.245" class="difflineminus">-</span>
<a href="#l13.246"></a><span id="l13.246" class="difflineminus">-        let body = &lt;body/&gt;</span>
<a href="#l13.247"></a><span id="l13.247" class="difflineminus">-</span>
<a href="#l13.248"></a><span id="l13.248" class="difflineminus">-        while (dt.compare(end) &lt; 0) {</span>
<a href="#l13.249"></a><span id="l13.249" class="difflineminus">-            let monthName = cal.calGetString(&quot;dateFormat&quot;, &quot;month.&quot; + (dt.month +1) + &quot;.name&quot;);</span>
<a href="#l13.250"></a><span id="l13.250" class="difflineminus">-            monthName += &quot; &quot; + dt.year;</span>
<a href="#l13.251"></a><span id="l13.251" class="difflineminus">-            body.appendChild(</span>
<a href="#l13.252"></a><span id="l13.252" class="difflineminus">-                         &lt;table border='0' width='100%' class='main-table'&gt;</span>
<a href="#l13.253"></a><span id="l13.253" class="difflineminus">-                             &lt;tr&gt;</span>
<a href="#l13.254"></a><span id="l13.254" class="difflineminus">-                                 &lt;td align='center' valign='bottom'&gt;{monthName}&lt;/td&gt;</span>
<a href="#l13.255"></a><span id="l13.255" class="difflineminus">-                             &lt;/tr&gt;</span>
<a href="#l13.256"></a><span id="l13.256" class="difflineminus">-                         &lt;/table&gt;);</span>
<a href="#l13.257"></a><span id="l13.257" class="difflineminus">-            body.appendChild(this.getStringForMonth(dt, aItems));</span>
<a href="#l13.258"></a><span id="l13.258" class="difflineminus">-            // Make sure each month gets put on its own page</span>
<a href="#l13.259"></a><span id="l13.259" class="difflineminus">-            body.appendChild(&lt;br style=&quot;page-break-after:always;&quot;/&gt;);</span>
<a href="#l13.260"></a><span id="l13.260" class="difflineminus">-            dt.month++;</span>
<a href="#l13.261"></a><span id="l13.261" class="difflineminus">-        }</span>
<a href="#l13.262"></a><span id="l13.262" class="difflineminus">-        let tasks = cal.print.getTasksWithoutDueDate(aItems, dt);</span>
<a href="#l13.263"></a><span id="l13.263" class="difflineminus">-        body.appendChild(tasks);</span>
<a href="#l13.264"></a><span id="l13.264" class="difflineminus">-        html.appendChild(body);</span>
<a href="#l13.265"></a><span id="l13.265" class="difflineplus">+        // Stream out the resulting HTML</span>
<a href="#l13.266"></a><span id="l13.266" class="difflineplus">+        let html = cal.xml.serializeDOM(document);</span>
<a href="#l13.267"></a><span id="l13.267">         let convStream = Components.classes[&quot;@mozilla.org/intl/converter-output-stream;1&quot;]</span>
<a href="#l13.268"></a><span id="l13.268">                                    .createInstance(Components.interfaces.nsIConverterOutputStream);</span>
<a href="#l13.269"></a><span id="l13.269">         convStream.init(aStream, 'UTF-8', 0, 0x0000);</span>
<a href="#l13.270"></a><span id="l13.270" class="difflineminus">-        convStream.writeString(html.toXMLString());</span>
<a href="#l13.271"></a><span id="l13.271" class="difflineplus">+        convStream.writeString(html);</span>
<a href="#l13.272"></a><span id="l13.272">     },</span>
<a href="#l13.273"></a><span id="l13.273"> </span>
<a href="#l13.274"></a><span id="l13.274" class="difflineminus">-    getStringForMonth: function monthPrint_getStringForMonth(aStart, aItems) {</span>
<a href="#l13.275"></a><span id="l13.275" class="difflineminus">-        let weekStart = cal.getPrefSafe(&quot;calendar.week.start&quot;, 0);</span>
<a href="#l13.276"></a><span id="l13.276" class="difflineplus">+    setupMonth: function setupMonth(document, startOfMonth, dayTable) {</span>
<a href="#l13.277"></a><span id="l13.277" class="difflineplus">+        let monthTemplate = document.getElementById(&quot;month-template&quot;);</span>
<a href="#l13.278"></a><span id="l13.278" class="difflineplus">+        let monthContainer = document.getElementById(&quot;month-container&quot;);</span>
<a href="#l13.279"></a><span id="l13.279"> </span>
<a href="#l13.280"></a><span id="l13.280" class="difflineminus">-        let monthTable = &lt;table style='border:1px solid black;' width='100%'/&gt;</span>
<a href="#l13.281"></a><span id="l13.281" class="difflineminus">-        let dayNameRow = &lt;tr/&gt;</span>
<a href="#l13.282"></a><span id="l13.282" class="difflineminus">-        for (let i = 0; i &lt; 7; i++) {</span>
<a href="#l13.283"></a><span id="l13.283" class="difflineminus">-            let dayName = cal.calGetString(&quot;dateFormat&quot;, &quot;day.&quot;+ (((weekStart+i)%7)+1) + &quot;.Mmm&quot;);</span>
<a href="#l13.284"></a><span id="l13.284" class="difflineminus">-            dayNameRow.appendChild(&lt;td class='day-name' align='center'&gt;{dayName}&lt;/td&gt;);</span>
<a href="#l13.285"></a><span id="l13.285" class="difflineminus">-        }</span>
<a href="#l13.286"></a><span id="l13.286" class="difflineminus">-        monthTable.appendChild(dayNameRow);</span>
<a href="#l13.287"></a><span id="l13.287" class="difflineminus">-</span>
<a href="#l13.288"></a><span id="l13.288" class="difflineminus">-        // Set up the item-list so it's easy to work with.</span>
<a href="#l13.289"></a><span id="l13.289" class="difflineminus">-        function hasUsableDate(item) item.startDate || item.entryDate || item.dueDate;</span>
<a href="#l13.290"></a><span id="l13.290" class="difflineminus">-        let filteredItems = aItems.filter(hasUsableDate);</span>
<a href="#l13.291"></a><span id="l13.291" class="difflineplus">+        // Clone the template month and make sure it doesn't have an id</span>
<a href="#l13.292"></a><span id="l13.292" class="difflineplus">+        let currentMonth = monthTemplate.cloneNode(true);</span>
<a href="#l13.293"></a><span id="l13.293" class="difflineplus">+        currentMonth.removeAttribute(&quot;id&quot;);</span>
<a href="#l13.294"></a><span id="l13.294" class="difflineplus">+        currentMonth.item = startOfMonth.clone();</span>
<a href="#l13.295"></a><span id="l13.295"> </span>
<a href="#l13.296"></a><span id="l13.296" class="difflineminus">-        function compareItems(a, b) {</span>
<a href="#l13.297"></a><span id="l13.297" class="difflineminus">-            // Sort tasks before events</span>
<a href="#l13.298"></a><span id="l13.298" class="difflineminus">-            if (cal.isEvent(a) &amp;&amp; cal.isToDo(b)) {</span>
<a href="#l13.299"></a><span id="l13.299" class="difflineminus">-                return 1;</span>
<a href="#l13.300"></a><span id="l13.300" class="difflineminus">-            }</span>
<a href="#l13.301"></a><span id="l13.301" class="difflineminus">-            if (cal.isToDo(a) &amp;&amp; cal.isEvent(b)) {</span>
<a href="#l13.302"></a><span id="l13.302" class="difflineminus">-                return -1;</span>
<a href="#l13.303"></a><span id="l13.303" class="difflineminus">-            }</span>
<a href="#l13.304"></a><span id="l13.304" class="difflineminus">-            if (cal.isEvent(a)) {</span>
<a href="#l13.305"></a><span id="l13.305" class="difflineminus">-                let startCompare = a.startDate.compare(b.startDate);</span>
<a href="#l13.306"></a><span id="l13.306" class="difflineminus">-                if (startCompare != 0) {</span>
<a href="#l13.307"></a><span id="l13.307" class="difflineminus">-                    return startCompare;</span>
<a href="#l13.308"></a><span id="l13.308" class="difflineminus">-                }</span>
<a href="#l13.309"></a><span id="l13.309" class="difflineminus">-                return a.endDate.compare(b.endDate);</span>
<a href="#l13.310"></a><span id="l13.310" class="difflineminus">-            }</span>
<a href="#l13.311"></a><span id="l13.311" class="difflineminus">-            let aDate = a.entryDate || a.dueDate;</span>
<a href="#l13.312"></a><span id="l13.312" class="difflineminus">-            let bDate = b.entryDate || b.dueDate;</span>
<a href="#l13.313"></a><span id="l13.313" class="difflineminus">-            return aDate.compare(bDate);</span>
<a href="#l13.314"></a><span id="l13.314" class="difflineminus">-        }</span>
<a href="#l13.315"></a><span id="l13.315" class="difflineminus">-        let sortedList = filteredItems.sort(compareItems);</span>
<a href="#l13.316"></a><span id="l13.316" class="difflineminus">-        let firstDate = aStart.startOfMonth.startOfWeek.clone();</span>
<a href="#l13.317"></a><span id="l13.317" class="difflineminus">-        firstDate.day += weekStart;</span>
<a href="#l13.318"></a><span id="l13.318" class="difflineminus">-        if (aStart.startOfMonth.weekday &lt; weekStart) {</span>
<a href="#l13.319"></a><span id="l13.319" class="difflineminus">-            // Go back one week to make sure we display this day</span>
<a href="#l13.320"></a><span id="l13.320" class="difflineminus">-            firstDate.day -= 7;</span>
<a href="#l13.321"></a><span id="l13.321" class="difflineplus">+        // Set up the month title</span>
<a href="#l13.322"></a><span id="l13.322" class="difflineplus">+        let monthName = cal.formatMonth(startOfMonth.month + 1, &quot;calendar&quot;, &quot;monthInYear&quot;);</span>
<a href="#l13.323"></a><span id="l13.323" class="difflineplus">+        let monthTitle = cal.calGetString(&quot;calendar&quot;, &quot;monthInYear&quot;, [monthName, startOfMonth.year]);</span>
<a href="#l13.324"></a><span id="l13.324" class="difflineplus">+        currentMonth.querySelector(&quot;.month-name&quot;).textContent = monthTitle;</span>
<a href="#l13.325"></a><span id="l13.325" class="difflineplus">+</span>
<a href="#l13.326"></a><span id="l13.326" class="difflineplus">+        // Set up the weekday titles</span>
<a href="#l13.327"></a><span id="l13.327" class="difflineplus">+        let wkst = cal.getPrefSafe(&quot;calendar.week.start&quot;, 0);</span>
<a href="#l13.328"></a><span id="l13.328" class="difflineplus">+        for (let i = 1; i &lt;= 7; i++) {</span>
<a href="#l13.329"></a><span id="l13.329" class="difflineplus">+            let dayNumber = ((i + wkst - 1) % 7) + 1;</span>
<a href="#l13.330"></a><span id="l13.330" class="difflineplus">+            let dayTitle = currentMonth.querySelector(&quot;.day&quot; + i + &quot;-title&quot;);</span>
<a href="#l13.331"></a><span id="l13.331" class="difflineplus">+            dayTitle.textContent = cal.calGetString(&quot;dateFormat&quot;, &quot;day.&quot; + dayNumber + &quot;.Mmm&quot;);</span>
<a href="#l13.332"></a><span id="l13.332">         }</span>
<a href="#l13.333"></a><span id="l13.333"> </span>
<a href="#l13.334"></a><span id="l13.334" class="difflineminus">-        let lastDate = aStart.endOfMonth.endOfWeek.clone();</span>
<a href="#l13.335"></a><span id="l13.335" class="difflineminus">-        if (aStart.endOfMonth.weekday &lt; weekStart) {</span>
<a href="#l13.336"></a><span id="l13.336" class="difflineminus">-            // Go back one week so we don't display any extra days</span>
<a href="#l13.337"></a><span id="l13.337" class="difflineminus">-            lastDate.day -= 7;</span>
<a href="#l13.338"></a><span id="l13.338" class="difflineplus">+        // Set up each week</span>
<a href="#l13.339"></a><span id="l13.339" class="difflineplus">+        let endOfMonthView = cal.userWeekEnd(startOfMonth.endOfMonth);</span>
<a href="#l13.340"></a><span id="l13.340" class="difflineplus">+        let startOfMonthView = cal.userWeekStart(startOfMonth);</span>
<a href="#l13.341"></a><span id="l13.341" class="difflineplus">+        let mainMonth = startOfMonth.month;</span>
<a href="#l13.342"></a><span id="l13.342" class="difflineplus">+        let weekContainer = currentMonth.querySelector(&quot;.week-container&quot;);</span>
<a href="#l13.343"></a><span id="l13.343" class="difflineplus">+</span>
<a href="#l13.344"></a><span id="l13.344" class="difflineplus">+        for (let weekStart = startOfMonthView; weekStart.compare(endOfMonthView) &lt; 0; weekStart.day += 7) {</span>
<a href="#l13.345"></a><span id="l13.345" class="difflineplus">+            this.setupWeek(document, weekContainer, weekStart, mainMonth, dayTable);</span>
<a href="#l13.346"></a><span id="l13.346">         }</span>
<a href="#l13.347"></a><span id="l13.347" class="difflineminus">-        firstDate.isDate = true;</span>
<a href="#l13.348"></a><span id="l13.348" class="difflineminus">-        lastDate.isDate = true;</span>
<a href="#l13.349"></a><span id="l13.349"> </span>
<a href="#l13.350"></a><span id="l13.350" class="difflineminus">-        let dt = firstDate.clone();</span>
<a href="#l13.351"></a><span id="l13.351" class="difflineminus">-        let itemListIndex = 0;</span>
<a href="#l13.352"></a><span id="l13.352" class="difflineminus">-        while (dt.compare(lastDate) != 1) {</span>
<a href="#l13.353"></a><span id="l13.353" class="difflineminus">-            monthTable.appendChild(this.makeHTMLWeek(dt, sortedList, aStart.month));</span>
<a href="#l13.354"></a><span id="l13.354" class="difflineplus">+        // Now insert the month into the page container, sorting by date (and therefore by month)</span>
<a href="#l13.355"></a><span id="l13.355" class="difflineplus">+        function compareDates(a, b) {</span>
<a href="#l13.356"></a><span id="l13.356" class="difflineplus">+            if (!a || !b) return -1;</span>
<a href="#l13.357"></a><span id="l13.357" class="difflineplus">+            let res = a.compare(b);</span>
<a href="#l13.358"></a><span id="l13.358" class="difflineplus">+            return res;</span>
<a href="#l13.359"></a><span id="l13.359">         }</span>
<a href="#l13.360"></a><span id="l13.360" class="difflineminus">-        return monthTable;</span>
<a href="#l13.361"></a><span id="l13.361" class="difflineplus">+</span>
<a href="#l13.362"></a><span id="l13.362" class="difflineplus">+        cal.binaryInsertNode(monthContainer, currentMonth, currentMonth.item, compareDates);</span>
<a href="#l13.363"></a><span id="l13.363">     },</span>
<a href="#l13.364"></a><span id="l13.364"> </span>
<a href="#l13.365"></a><span id="l13.365" class="difflineminus">-    makeHTMLWeek: function makeHTMLWeek(dt, sortedList, targetMonth) {</span>
<a href="#l13.366"></a><span id="l13.366" class="difflineminus">-        let weekRow = &lt;tr/&gt;;</span>
<a href="#l13.367"></a><span id="l13.367" class="difflineminus">-        const weekPrefix = &quot;calendar.week.&quot;;</span>
<a href="#l13.368"></a><span id="l13.368" class="difflineminus">-        let prefNames = [&quot;d0sundaysoff&quot;, &quot;d1mondaysoff&quot;, &quot;d2tuesdaysoff&quot;,</span>
<a href="#l13.369"></a><span id="l13.369" class="difflineminus">-                         &quot;d3wednesdaysoff&quot;, &quot;d4thursdaysoff&quot;, &quot;d5fridaysoff&quot;, &quot;d6saturdaysoff&quot;];</span>
<a href="#l13.370"></a><span id="l13.370" class="difflineminus">-        let defaults = [true, false, false, false, false, false, true];</span>
<a href="#l13.371"></a><span id="l13.371" class="difflineminus">-        let daysOff = [];</span>
<a href="#l13.372"></a><span id="l13.372" class="difflineminus">-        for (let i in prefNames) {</span>
<a href="#l13.373"></a><span id="l13.373" class="difflineminus">-            if (cal.getPrefSafe(weekPrefix+prefNames[i], defaults[i])) {</span>
<a href="#l13.374"></a><span id="l13.374" class="difflineminus">-                daysOff.push(Number(i));</span>
<a href="#l13.375"></a><span id="l13.375" class="difflineplus">+    setupWeek: function setupWeek(document, weekContainer, startOfWeek, mainMonth, dayTable) {</span>
<a href="#l13.376"></a><span id="l13.376" class="difflineplus">+        const weekdayMap = [&quot;sunday&quot;, &quot;monday&quot;, &quot;tuesday&quot;, &quot;wednesday&quot;, &quot;thursday&quot;, &quot;friday&quot;, &quot;saturday&quot;];</span>
<a href="#l13.377"></a><span id="l13.377" class="difflineplus">+        let weekTemplate = document.getElementById(&quot;week-template&quot;);</span>
<a href="#l13.378"></a><span id="l13.378" class="difflineplus">+</span>
<a href="#l13.379"></a><span id="l13.379" class="difflineplus">+        // Clone the template week and make sure it doesn't have an id</span>
<a href="#l13.380"></a><span id="l13.380" class="difflineplus">+        let currentWeek = weekTemplate.cloneNode(true);</span>
<a href="#l13.381"></a><span id="l13.381" class="difflineplus">+        currentWeek.removeAttribute(&quot;id&quot;);</span>
<a href="#l13.382"></a><span id="l13.382" class="difflineplus">+</span>
<a href="#l13.383"></a><span id="l13.383" class="difflineplus">+        // Set up day numbers for all days in this week</span>
<a href="#l13.384"></a><span id="l13.384" class="difflineplus">+        let currentDate = startOfWeek.clone();</span>
<a href="#l13.385"></a><span id="l13.385" class="difflineplus">+        for (let i = 1; i &lt;= 7; i++) {</span>
<a href="#l13.386"></a><span id="l13.386" class="difflineplus">+            let dayNumber = currentWeek.querySelector(&quot;.day&quot; + i + &quot;-number&quot;);</span>
<a href="#l13.387"></a><span id="l13.387" class="difflineplus">+            let dayContainer =  currentWeek.querySelector(&quot;.day&quot; + i + &quot;-container&quot;);</span>
<a href="#l13.388"></a><span id="l13.388" class="difflineplus">+            let dayBox = currentWeek.querySelector(&quot;.day&quot; + i + &quot;-box&quot;);</span>
<a href="#l13.389"></a><span id="l13.389" class="difflineplus">+            let dateKey = cal.print.getDateKey(currentDate);</span>
<a href="#l13.390"></a><span id="l13.390" class="difflineplus">+            dayNumber.textContent = currentDate.day;</span>
<a href="#l13.391"></a><span id="l13.391" class="difflineplus">+</span>
<a href="#l13.392"></a><span id="l13.392" class="difflineplus">+            // We need to support adding multiple boxes, since the months have</span>
<a href="#l13.393"></a><span id="l13.393" class="difflineplus">+            // overlapping days.</span>
<a href="#l13.394"></a><span id="l13.394" class="difflineplus">+            if (dateKey in dayTable) {</span>
<a href="#l13.395"></a><span id="l13.395" class="difflineplus">+                if (Array.isArray(dayTable[dateKey])) {</span>
<a href="#l13.396"></a><span id="l13.396" class="difflineplus">+                    dayTable[dateKey].push(dayContainer);</span>
<a href="#l13.397"></a><span id="l13.397" class="difflineplus">+                } else {</span>
<a href="#l13.398"></a><span id="l13.398" class="difflineplus">+                    dayTable[dateKey] = [dayTable[dateKey], dayContainer];</span>
<a href="#l13.399"></a><span id="l13.399" class="difflineplus">+                }</span>
<a href="#l13.400"></a><span id="l13.400" class="difflineplus">+            } else {</span>
<a href="#l13.401"></a><span id="l13.401" class="difflineplus">+                dayTable[dateKey] = dayContainer;</span>
<a href="#l13.402"></a><span id="l13.402">             }</span>
<a href="#l13.403"></a><span id="l13.403" class="difflineplus">+</span>
<a href="#l13.404"></a><span id="l13.404" class="difflineplus">+            let weekDay = currentDate.weekday;</span>
<a href="#l13.405"></a><span id="l13.405" class="difflineplus">+            let dayOffPrefName = &quot;calendar.week.d&quot; + weekDay + weekdayMap[weekDay] + &quot;soff&quot;;</span>
<a href="#l13.406"></a><span id="l13.406" class="difflineplus">+            if (cal.getPrefSafe(dayOffPrefName, false)) {</span>
<a href="#l13.407"></a><span id="l13.407" class="difflineplus">+                dayBox.className += &quot; day-off&quot;;</span>
<a href="#l13.408"></a><span id="l13.408" class="difflineplus">+            }</span>
<a href="#l13.409"></a><span id="l13.409" class="difflineplus">+</span>
<a href="#l13.410"></a><span id="l13.410" class="difflineplus">+            if (currentDate.month != mainMonth) {</span>
<a href="#l13.411"></a><span id="l13.411" class="difflineplus">+                dayBox.className += &quot; out-of-month&quot;;</span>
<a href="#l13.412"></a><span id="l13.412" class="difflineplus">+            }</span>
<a href="#l13.413"></a><span id="l13.413" class="difflineplus">+            currentDate.day++;</span>
<a href="#l13.414"></a><span id="l13.414">         }</span>
<a href="#l13.415"></a><span id="l13.415"> </span>
<a href="#l13.416"></a><span id="l13.416" class="difflineminus">-        for (let i = 0; i &lt; 7; i++) {</span>
<a href="#l13.417"></a><span id="l13.417" class="difflineminus">-            let myClass = 'day-box';</span>
<a href="#l13.418"></a><span id="l13.418" class="difflineminus">-            if (dt.month != targetMonth) {</span>
<a href="#l13.419"></a><span id="l13.419" class="difflineminus">-                myClass += ' out-of-month';</span>
<a href="#l13.420"></a><span id="l13.420" class="difflineminus">-            } else if (daysOff.some(function(a) { return a == dt.weekday; })) {</span>
<a href="#l13.421"></a><span id="l13.421" class="difflineminus">-                myClass += ' day-off';</span>
<a href="#l13.422"></a><span id="l13.422" class="difflineminus">-            }</span>
<a href="#l13.423"></a><span id="l13.423" class="difflineminus">-            let day = &lt;td align='left' valign='top' class={myClass} height='100' width='100'/&gt;</span>
<a href="#l13.424"></a><span id="l13.424" class="difflineminus">-            let innerTable = &lt;table valign='top' style='font-size: 10px;'/&gt;</span>
<a href="#l13.425"></a><span id="l13.425" class="difflineminus">-            let dateLabel = &lt;tr valign='top'&gt;</span>
<a href="#l13.426"></a><span id="l13.426" class="difflineminus">-                                &lt;td valign='top' align='left'&gt;{dt.day}&lt;/td&gt;</span>
<a href="#l13.427"></a><span id="l13.427" class="difflineminus">-                            &lt;/tr&gt;</span>
<a href="#l13.428"></a><span id="l13.428" class="difflineminus">-            innerTable.appendChild(dateLabel);</span>
<a href="#l13.429"></a><span id="l13.429" class="difflineminus">-            let defaultTimezone = cal.calendarDefaultTimezone();</span>
<a href="#l13.430"></a><span id="l13.430" class="difflineminus">-            for each (let item in sortedList) {</span>
<a href="#l13.431"></a><span id="l13.431" class="difflineminus">-                let sDate = item.startDate || item.entryDate || item.dueDate;</span>
<a href="#l13.432"></a><span id="l13.432" class="difflineminus">-                let eDate = item.endDate || item.dueDate || item.entryDate;</span>
<a href="#l13.433"></a><span id="l13.433" class="difflineminus">-                if (sDate) {</span>
<a href="#l13.434"></a><span id="l13.434" class="difflineminus">-                    sDate = sDate.getInTimezone(defaultTimezone);</span>
<a href="#l13.435"></a><span id="l13.435" class="difflineminus">-                }</span>
<a href="#l13.436"></a><span id="l13.436" class="difflineminus">-                if (eDate) {</span>
<a href="#l13.437"></a><span id="l13.437" class="difflineminus">-                    eDate = eDate.getInTimezone(defaultTimezone);</span>
<a href="#l13.438"></a><span id="l13.438" class="difflineminus">-                }</span>
<a href="#l13.439"></a><span id="l13.439" class="difflineminus">-</span>
<a href="#l13.440"></a><span id="l13.440" class="difflineminus">-                // end dates are exclusive</span>
<a href="#l13.441"></a><span id="l13.441" class="difflineminus">-                if (sDate.isDate) {</span>
<a href="#l13.442"></a><span id="l13.442" class="difflineminus">-                    eDate = eDate.clone();</span>
<a href="#l13.443"></a><span id="l13.443" class="difflineminus">-                    eDate.day -= 1;</span>
<a href="#l13.444"></a><span id="l13.444" class="difflineminus">-                }</span>
<a href="#l13.445"></a><span id="l13.445" class="difflineminus">-                if (!eDate || eDate.compare(dt) == -1) {</span>
<a href="#l13.446"></a><span id="l13.446" class="difflineminus">-                    continue;</span>
<a href="#l13.447"></a><span id="l13.447" class="difflineminus">-                }</span>
<a href="#l13.448"></a><span id="l13.448" class="difflineminus">-                let itemListIndex = i;</span>
<a href="#l13.449"></a><span id="l13.449" class="difflineminus">-                if (!sDate || sDate.compare(dt) == 1) {</span>
<a href="#l13.450"></a><span id="l13.450" class="difflineminus">-                    break;</span>
<a href="#l13.451"></a><span id="l13.451" class="difflineminus">-                }</span>
<a href="#l13.452"></a><span id="l13.452" class="difflineminus">-</span>
<a href="#l13.453"></a><span id="l13.453" class="difflineminus">-                let time = (!sDate.isDate ? cal.getDateFormatter().formatTime(sDate) : &quot;&quot;);</span>
<a href="#l13.454"></a><span id="l13.454" class="difflineminus">-                let calColor = item.calendar.getProperty('color') || &quot;#A8C2E1&quot;;</span>
<a href="#l13.455"></a><span id="l13.455" class="difflineminus">-                let pb2 = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l13.456"></a><span id="l13.456" class="difflineminus">-                                    .getService(Components.interfaces.nsIPrefBranch);</span>
<a href="#l13.457"></a><span id="l13.457" class="difflineminus">-                let catColor;</span>
<a href="#l13.458"></a><span id="l13.458" class="difflineminus">-                for each (let cat in item.getCategories({})) {</span>
<a href="#l13.459"></a><span id="l13.459" class="difflineminus">-                    try {</span>
<a href="#l13.460"></a><span id="l13.460" class="difflineminus">-                        catColor = pb2.getCharPref(&quot;calendar.category.color.&quot; + cal.formatStringForCSSRule(cat));</span>
<a href="#l13.461"></a><span id="l13.461" class="difflineminus">-                        break; // take first matching</span>
<a href="#l13.462"></a><span id="l13.462" class="difflineminus">-                    } catch (ex) {}</span>
<a href="#l13.463"></a><span id="l13.463" class="difflineminus">-                }</span>
<a href="#l13.464"></a><span id="l13.464" class="difflineminus">-</span>
<a href="#l13.465"></a><span id="l13.465" class="difflineminus">-                let style = 'font-size: 11px; text-align: left;';</span>
<a href="#l13.466"></a><span id="l13.466" class="difflineminus">-                style += ' background-color: ' + calColor + ';';</span>
<a href="#l13.467"></a><span id="l13.467" class="difflineminus">-                style += ' color: ' + cal.getContrastingTextColor(calColor) + ';';</span>
<a href="#l13.468"></a><span id="l13.468" class="difflineminus">-                if (catColor) {</span>
<a href="#l13.469"></a><span id="l13.469" class="difflineminus">-                    style += ' border: solid ' + catColor + ' 2px;';</span>
<a href="#l13.470"></a><span id="l13.470" class="difflineminus">-                }</span>
<a href="#l13.471"></a><span id="l13.471" class="difflineminus">-                let tableRow = &lt;tr&gt;&lt;td valign='top' style={style}&gt;{time} {item.title}&lt;/td&gt;&lt;/tr&gt;;</span>
<a href="#l13.472"></a><span id="l13.472" class="difflineminus">-                innerTable.appendChild(tableRow);</span>
<a href="#l13.473"></a><span id="l13.473" class="difflineminus">-            }</span>
<a href="#l13.474"></a><span id="l13.474" class="difflineminus">-            day.appendChild(innerTable);</span>
<a href="#l13.475"></a><span id="l13.475" class="difflineminus">-            weekRow.appendChild(day);</span>
<a href="#l13.476"></a><span id="l13.476" class="difflineminus">-            dt.day++;</span>
<a href="#l13.477"></a><span id="l13.477" class="difflineminus">-        }</span>
<a href="#l13.478"></a><span id="l13.478" class="difflineminus">-        return weekRow;</span>
<a href="#l13.479"></a><span id="l13.479" class="difflineplus">+        // No need for sorting, setupWeek will be called in sequence</span>
<a href="#l13.480"></a><span id="l13.480" class="difflineplus">+        weekContainer.appendChild(currentWeek);</span>
<a href="#l13.481"></a><span id="l13.481">     }</span>
<a href="#l13.482"></a><span id="l13.482"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1">new file mode 100644</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineminus">--- /dev/null</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineplus">+++ b/calendar/import-export/calWeekPrinter.html</span>
<a href="#l14.4"></a><span id="l14.4" class="difflineat">@@ -0,0 +1,124 @@</span>
<a href="#l14.5"></a><span id="l14.5" class="difflineplus">+&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD XHTML 1.1//EN&quot;</span>
<a href="#l14.6"></a><span id="l14.6" class="difflineplus">+   &quot;http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd&quot;&gt;</span>
<a href="#l14.7"></a><span id="l14.7" class="difflineplus">+&lt;html xmlns=&quot;http://www.w3.org/1999/xhtml&quot;&gt;</span>
<a href="#l14.8"></a><span id="l14.8" class="difflineplus">+  &lt;head&gt;</span>
<a href="#l14.9"></a><span id="l14.9" class="difflineplus">+    &lt;title id=&quot;title&quot;/&gt;</span>
<a href="#l14.10"></a><span id="l14.10" class="difflineplus">+    &lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=UTF-8&quot;/&gt;</span>
<a href="#l14.11"></a><span id="l14.11" class="difflineplus">+    &lt;link rel=&quot;stylesheet&quot; type=&quot;text/css&quot; href=&quot;chrome://calendar/skin/calendar-printing.css&quot;/&gt;</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineplus">+    &lt;style type=&quot;text/css&quot; id=&quot;sheet&quot;/&gt;</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+  &lt;/head&gt;</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineplus">+  &lt;body&gt;</span>
<a href="#l14.15"></a><span id="l14.15" class="difflineplus">+    &lt;div id=&quot;week-container&quot;/&gt;</span>
<a href="#l14.16"></a><span id="l14.16" class="difflineplus">+    &lt;div id=&quot;tasks-list-box&quot; hidden=&quot;true&quot;&gt;</span>
<a href="#l14.17"></a><span id="l14.17" class="difflineplus">+      &lt;h3 id=&quot;tasks-title&quot;/&gt;</span>
<a href="#l14.18"></a><span id="l14.18" class="difflineplus">+      &lt;ul class=&quot;taskList&quot; id=&quot;task-container&quot;/&gt;</span>
<a href="#l14.19"></a><span id="l14.19" class="difflineplus">+    &lt;/div&gt;</span>
<a href="#l14.20"></a><span id="l14.20" class="difflineplus">+</span>
<a href="#l14.21"></a><span id="l14.21" class="difflineplus">+    &lt;!-- Templates follow --&gt;</span>
<a href="#l14.22"></a><span id="l14.22" class="difflineplus">+    &lt;div id=&quot;templates&quot; hidden=&quot;true&quot;&gt;</span>
<a href="#l14.23"></a><span id="l14.23" class="difflineplus">+      &lt;li id=&quot;task-template&quot;&gt;</span>
<a href="#l14.24"></a><span id="l14.24" class="difflineplus">+        &lt;input type=&quot;checkbox&quot; class=&quot;task-checkbox&quot; disabled=&quot;true&quot;/&gt;</span>
<a href="#l14.25"></a><span id="l14.25" class="difflineplus">+        &lt;s class=&quot;task-title&quot;/&gt;</span>
<a href="#l14.26"></a><span id="l14.26" class="difflineplus">+      &lt;/li&gt;</span>
<a href="#l14.27"></a><span id="l14.27" class="difflineplus">+      &lt;tr id=&quot;item-template&quot;&gt;</span>
<a href="#l14.28"></a><span id="l14.28" class="difflineplus">+        &lt;td valign=&quot;top&quot; align=&quot;left&quot; style=&quot;font-size: 11px;&quot; class=&quot;category-color-box calendar-color-box&quot;&gt;</span>
<a href="#l14.29"></a><span id="l14.29" class="difflineplus">+          &lt;span class=&quot;item-interval&quot;/&gt;</span>
<a href="#l14.30"></a><span id="l14.30" class="difflineplus">+          &lt;span class=&quot;item-title&quot;/&gt;</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineplus">+        &lt;/td&gt;</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineplus">+      &lt;/tr&gt;</span>
<a href="#l14.33"></a><span id="l14.33" class="difflineplus">+      &lt;div id=&quot;week-template&quot; style=&quot;page-break-after: always;&quot;&gt;</span>
<a href="#l14.34"></a><span id="l14.34" class="difflineplus">+        &lt;table border=&quot;0&quot; width=&quot;100%&quot; class=&quot;main-table&quot;&gt;</span>
<a href="#l14.35"></a><span id="l14.35" class="difflineplus">+          &lt;tr&gt;</span>
<a href="#l14.36"></a><span id="l14.36" class="difflineplus">+            &lt;td align=&quot;center&quot; valign=&quot;bottom&quot; class=&quot;week-number&quot;/&gt;</span>
<a href="#l14.37"></a><span id="l14.37" class="difflineplus">+          &lt;/tr&gt;</span>
<a href="#l14.38"></a><span id="l14.38" class="difflineplus">+        &lt;/table&gt;</span>
<a href="#l14.39"></a><span id="l14.39" class="difflineplus">+        &lt;table width=&quot;100%&quot; height=&quot;90%&quot; border=&quot;solid 1px;&quot;&gt;</span>
<a href="#l14.40"></a><span id="l14.40" class="difflineplus">+          &lt;tr height=&quot;33%&quot;&gt;</span>
<a href="#l14.41"></a><span id="l14.41" class="difflineplus">+            &lt;td border=&quot;1px solid black;&quot; width=&quot;50%&quot; valign=&quot;top&quot; class=&quot;monday-box&quot;&gt;</span>
<a href="#l14.42"></a><span id="l14.42" class="difflineplus">+              &lt;table class=&quot;day-name&quot; width=&quot;100%&quot; style=&quot;background-color:white; border: 1px solid black;&quot;&gt;</span>
<a href="#l14.43"></a><span id="l14.43" class="difflineplus">+                &lt;tr&gt;</span>
<a href="#l14.44"></a><span id="l14.44" class="difflineplus">+                  &lt;td align=&quot;center&quot; valign=&quot;bottom&quot; class=&quot;monday-title&quot;/&gt;</span>
<a href="#l14.45"></a><span id="l14.45" class="difflineplus">+                &lt;/tr&gt;</span>
<a href="#l14.46"></a><span id="l14.46" class="difflineplus">+              &lt;/table&gt;</span>
<a href="#l14.47"></a><span id="l14.47" class="difflineplus">+              &lt;table valign=&quot;top&quot; style=&quot;font-size: 10px;&quot; class=&quot;monday-container&quot;&gt;</span>
<a href="#l14.48"></a><span id="l14.48" class="difflineplus">+                &lt;p/&gt;</span>
<a href="#l14.49"></a><span id="l14.49" class="difflineplus">+              &lt;/table&gt;</span>
<a href="#l14.50"></a><span id="l14.50" class="difflineplus">+            &lt;/td&gt;</span>
<a href="#l14.51"></a><span id="l14.51" class="difflineplus">+            &lt;td border=&quot;1px solid black;&quot; width=&quot;50%&quot; valign=&quot;top&quot; class=&quot;thursday-box&quot;&gt;</span>
<a href="#l14.52"></a><span id="l14.52" class="difflineplus">+              &lt;table class=&quot;day-name&quot; width=&quot;100%&quot; style=&quot;background-color:white; border: 1px solid black;&quot;&gt;</span>
<a href="#l14.53"></a><span id="l14.53" class="difflineplus">+                &lt;tr&gt;</span>
<a href="#l14.54"></a><span id="l14.54" class="difflineplus">+                  &lt;td align=&quot;center&quot; valign=&quot;bottom&quot; class=&quot;thursday-title&quot;/&gt;</span>
<a href="#l14.55"></a><span id="l14.55" class="difflineplus">+                &lt;/tr&gt;</span>
<a href="#l14.56"></a><span id="l14.56" class="difflineplus">+              &lt;/table&gt;</span>
<a href="#l14.57"></a><span id="l14.57" class="difflineplus">+              &lt;table valign=&quot;top&quot; style=&quot;font-size: 10px;&quot; class=&quot;thursday-container&quot;&gt;</span>
<a href="#l14.58"></a><span id="l14.58" class="difflineplus">+                &lt;p/&gt;</span>
<a href="#l14.59"></a><span id="l14.59" class="difflineplus">+              &lt;/table&gt;</span>
<a href="#l14.60"></a><span id="l14.60" class="difflineplus">+            &lt;/td&gt;</span>
<a href="#l14.61"></a><span id="l14.61" class="difflineplus">+          &lt;/tr&gt;</span>
<a href="#l14.62"></a><span id="l14.62" class="difflineplus">+          &lt;tr height=&quot;33%&quot;&gt;</span>
<a href="#l14.63"></a><span id="l14.63" class="difflineplus">+            &lt;td border=&quot;1px solid black;&quot; width=&quot;50%&quot; valign=&quot;top&quot; class=&quot;tuesday-box&quot;&gt;</span>
<a href="#l14.64"></a><span id="l14.64" class="difflineplus">+              &lt;table class=&quot;day-name&quot; width=&quot;100%&quot; style=&quot;background-color:white; border: 1px solid black;&quot;&gt;</span>
<a href="#l14.65"></a><span id="l14.65" class="difflineplus">+                &lt;tr&gt;</span>
<a href="#l14.66"></a><span id="l14.66" class="difflineplus">+                  &lt;td align=&quot;center&quot; valign=&quot;bottom&quot; class=&quot;tuesday-title&quot;/&gt;</span>
<a href="#l14.67"></a><span id="l14.67" class="difflineplus">+                &lt;/tr&gt;</span>
<a href="#l14.68"></a><span id="l14.68" class="difflineplus">+              &lt;/table&gt;</span>
<a href="#l14.69"></a><span id="l14.69" class="difflineplus">+              &lt;table valign=&quot;top&quot; style=&quot;font-size: 10px;&quot; class=&quot;tuesday-container&quot;&gt;</span>
<a href="#l14.70"></a><span id="l14.70" class="difflineplus">+                &lt;p/&gt;</span>
<a href="#l14.71"></a><span id="l14.71" class="difflineplus">+              &lt;/table&gt;</span>
<a href="#l14.72"></a><span id="l14.72" class="difflineplus">+            &lt;/td&gt;</span>
<a href="#l14.73"></a><span id="l14.73" class="difflineplus">+            &lt;td border=&quot;1px solid black;&quot; width=&quot;50%&quot; valign=&quot;top&quot; class=&quot;friday-box&quot;&gt;</span>
<a href="#l14.74"></a><span id="l14.74" class="difflineplus">+              &lt;table class=&quot;day-name&quot; width=&quot;100%&quot; style=&quot;background-color:white; border: 1px solid black;&quot;&gt;</span>
<a href="#l14.75"></a><span id="l14.75" class="difflineplus">+                &lt;tr&gt;</span>
<a href="#l14.76"></a><span id="l14.76" class="difflineplus">+                  &lt;td align=&quot;center&quot; valign=&quot;bottom&quot; class=&quot;friday-title&quot;/&gt;</span>
<a href="#l14.77"></a><span id="l14.77" class="difflineplus">+                &lt;/tr&gt;</span>
<a href="#l14.78"></a><span id="l14.78" class="difflineplus">+              &lt;/table&gt;</span>
<a href="#l14.79"></a><span id="l14.79" class="difflineplus">+              &lt;table valign=&quot;top&quot; style=&quot;font-size: 10px;&quot; class=&quot;friday-container&quot;&gt;</span>
<a href="#l14.80"></a><span id="l14.80" class="difflineplus">+                &lt;p/&gt;</span>
<a href="#l14.81"></a><span id="l14.81" class="difflineplus">+              &lt;/table&gt;</span>
<a href="#l14.82"></a><span id="l14.82" class="difflineplus">+            &lt;/td&gt;</span>
<a href="#l14.83"></a><span id="l14.83" class="difflineplus">+          &lt;/tr&gt;</span>
<a href="#l14.84"></a><span id="l14.84" class="difflineplus">+          &lt;tr height=&quot;33%&quot;&gt;</span>
<a href="#l14.85"></a><span id="l14.85" class="difflineplus">+            &lt;td border=&quot;1px solid black;&quot; width=&quot;50%&quot; valign=&quot;top&quot; class=&quot;wednesday-box&quot;&gt;</span>
<a href="#l14.86"></a><span id="l14.86" class="difflineplus">+              &lt;table class=&quot;day-name&quot; width=&quot;100%&quot; style=&quot;background-color:white; border: 1px solid black;&quot;&gt;</span>
<a href="#l14.87"></a><span id="l14.87" class="difflineplus">+                &lt;tr&gt;</span>
<a href="#l14.88"></a><span id="l14.88" class="difflineplus">+                  &lt;td align=&quot;center&quot; valign=&quot;bottom&quot; class=&quot;wednesday-title&quot;/&gt;</span>
<a href="#l14.89"></a><span id="l14.89" class="difflineplus">+                &lt;/tr&gt;</span>
<a href="#l14.90"></a><span id="l14.90" class="difflineplus">+              &lt;/table&gt;</span>
<a href="#l14.91"></a><span id="l14.91" class="difflineplus">+              &lt;table valign=&quot;top&quot; style=&quot;font-size: 10px;&quot; class=&quot;wednesday-container&quot;&gt;</span>
<a href="#l14.92"></a><span id="l14.92" class="difflineplus">+                &lt;p/&gt;</span>
<a href="#l14.93"></a><span id="l14.93" class="difflineplus">+              &lt;/table&gt;</span>
<a href="#l14.94"></a><span id="l14.94" class="difflineplus">+            &lt;/td&gt;</span>
<a href="#l14.95"></a><span id="l14.95" class="difflineplus">+            &lt;td height=&quot;33%&quot; style=&quot;padding: 0&quot;&gt;</span>
<a href="#l14.96"></a><span id="l14.96" class="difflineplus">+              &lt;table border=&quot;0&quot; width=&quot;100%&quot; height=&quot;100%&quot;&gt;</span>
<a href="#l14.97"></a><span id="l14.97" class="difflineplus">+                &lt;tr valign=&quot;top&quot;&gt;</span>
<a href="#l14.98"></a><span id="l14.98" class="difflineplus">+                  &lt;td border=&quot;1px solid black;&quot; width=&quot;50%&quot; valign=&quot;top&quot; class=&quot;saturday-box&quot;&gt;</span>
<a href="#l14.99"></a><span id="l14.99" class="difflineplus">+                    &lt;table class=&quot;day-name&quot; width=&quot;100%&quot; style=&quot;background-color:white; border: 1px solid black;&quot;&gt;</span>
<a href="#l14.100"></a><span id="l14.100" class="difflineplus">+                      &lt;tr&gt;</span>
<a href="#l14.101"></a><span id="l14.101" class="difflineplus">+                        &lt;td align=&quot;center&quot; valign=&quot;bottom&quot; class=&quot;saturday-title&quot;/&gt;</span>
<a href="#l14.102"></a><span id="l14.102" class="difflineplus">+                      &lt;/tr&gt;</span>
<a href="#l14.103"></a><span id="l14.103" class="difflineplus">+                    &lt;/table&gt;</span>
<a href="#l14.104"></a><span id="l14.104" class="difflineplus">+                    &lt;table valign=&quot;top&quot; style=&quot;font-size: 10px;&quot; class=&quot;saturday-container&quot;&gt;</span>
<a href="#l14.105"></a><span id="l14.105" class="difflineplus">+                      &lt;p/&gt;</span>
<a href="#l14.106"></a><span id="l14.106" class="difflineplus">+                    &lt;/table&gt;</span>
<a href="#l14.107"></a><span id="l14.107" class="difflineplus">+                  &lt;/td&gt;</span>
<a href="#l14.108"></a><span id="l14.108" class="difflineplus">+                &lt;/tr&gt;</span>
<a href="#l14.109"></a><span id="l14.109" class="difflineplus">+                &lt;tr valign=&quot;top&quot;&gt;</span>
<a href="#l14.110"></a><span id="l14.110" class="difflineplus">+                  &lt;td border=&quot;1px solid black;&quot; width=&quot;50%&quot; valign=&quot;top&quot; class=&quot;sunday-box&quot;&gt;</span>
<a href="#l14.111"></a><span id="l14.111" class="difflineplus">+                    &lt;table class=&quot;day-name&quot; width=&quot;100%&quot; style=&quot;background-color:white; border: 1px solid black;&quot;&gt;</span>
<a href="#l14.112"></a><span id="l14.112" class="difflineplus">+                      &lt;tr&gt;</span>
<a href="#l14.113"></a><span id="l14.113" class="difflineplus">+                        &lt;td align=&quot;center&quot; valign=&quot;bottom&quot; class=&quot;sunday-title&quot;/&gt;</span>
<a href="#l14.114"></a><span id="l14.114" class="difflineplus">+                      &lt;/tr&gt;</span>
<a href="#l14.115"></a><span id="l14.115" class="difflineplus">+                    &lt;/table&gt;</span>
<a href="#l14.116"></a><span id="l14.116" class="difflineplus">+                    &lt;table valign=&quot;top&quot; style=&quot;font-size: 10px;&quot; class=&quot;sunday-container&quot;&gt;</span>
<a href="#l14.117"></a><span id="l14.117" class="difflineplus">+                      &lt;p/&gt;</span>
<a href="#l14.118"></a><span id="l14.118" class="difflineplus">+                    &lt;/table&gt;</span>
<a href="#l14.119"></a><span id="l14.119" class="difflineplus">+                  &lt;/td&gt;</span>
<a href="#l14.120"></a><span id="l14.120" class="difflineplus">+                &lt;/tr&gt;</span>
<a href="#l14.121"></a><span id="l14.121" class="difflineplus">+              &lt;/table&gt;</span>
<a href="#l14.122"></a><span id="l14.122" class="difflineplus">+            &lt;/td&gt;</span>
<a href="#l14.123"></a><span id="l14.123" class="difflineplus">+          &lt;/tr&gt;</span>
<a href="#l14.124"></a><span id="l14.124" class="difflineplus">+        &lt;/table&gt;</span>
<a href="#l14.125"></a><span id="l14.125" class="difflineplus">+      &lt;/div&gt;</span>
<a href="#l14.126"></a><span id="l14.126" class="difflineplus">+    &lt;/div&gt;</span>
<a href="#l14.127"></a><span id="l14.127" class="difflineplus">+  &lt;/body&gt;</span>
<a href="#l14.128"></a><span id="l14.128" class="difflineplus">+&lt;/html&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/calendar/import-export/calWeekPrinter.js</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/calendar/import-export/calWeekPrinter.js</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -1,251 +1,134 @@</span>
<a href="#l15.4"></a><span id="l15.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l15.5"></a><span id="l15.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l15.6"></a><span id="l15.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l15.7"></a><span id="l15.7"> </span>
<a href="#l15.8"></a><span id="l15.8" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l15.9"></a><span id="l15.9" class="difflineplus">+</span>
<a href="#l15.10"></a><span id="l15.10" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l15.11"></a><span id="l15.11" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calXMLUtils.jsm&quot;);</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calPrintUtils.jsm&quot;);</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineplus">+</span>
<a href="#l15.14"></a><span id="l15.14"> /**</span>
<a href="#l15.15"></a><span id="l15.15">  * Prints a two column view of a week of events, much like a paper day-planner</span>
<a href="#l15.16"></a><span id="l15.16">  */</span>
<a href="#l15.17"></a><span id="l15.17" class="difflineminus">-Components.utils.import(&quot;resource://calendar/modules/calPrintUtils.jsm&quot;);</span>
<a href="#l15.18"></a><span id="l15.18" class="difflineminus">-</span>
<a href="#l15.19"></a><span id="l15.19"> function calWeekPrinter() {</span>
<a href="#l15.20"></a><span id="l15.20"> }</span>
<a href="#l15.21"></a><span id="l15.21"> </span>
<a href="#l15.22"></a><span id="l15.22"> calWeekPrinter.prototype = {</span>
<a href="#l15.23"></a><span id="l15.23" class="difflineminus">-    getInterfaces: function (count) {</span>
<a href="#l15.24"></a><span id="l15.24" class="difflineminus">-        const ifaces = [</span>
<a href="#l15.25"></a><span id="l15.25" class="difflineminus">-            Components.interfaces.nsISupports,</span>
<a href="#l15.26"></a><span id="l15.26" class="difflineminus">-            Components.interfaces.nsIClassInfo,</span>
<a href="#l15.27"></a><span id="l15.27" class="difflineminus">-            Components.interfaces.calIPrintFormatter,</span>
<a href="#l15.28"></a><span id="l15.28" class="difflineminus">-        ];</span>
<a href="#l15.29"></a><span id="l15.29" class="difflineminus">-        count.value = ifaces.length;</span>
<a href="#l15.30"></a><span id="l15.30" class="difflineminus">-        return ifaces;</span>
<a href="#l15.31"></a><span id="l15.31" class="difflineminus">-    },</span>
<a href="#l15.32"></a><span id="l15.32" class="difflineminus">-</span>
<a href="#l15.33"></a><span id="l15.33" class="difflineminus">-    getHelperForLanguage: function (language) {</span>
<a href="#l15.34"></a><span id="l15.34" class="difflineminus">-        return null;</span>
<a href="#l15.35"></a><span id="l15.35" class="difflineminus">-    },</span>
<a href="#l15.36"></a><span id="l15.36" class="difflineplus">+    classID: Components.ID(&quot;{2d6ec97b-9109-4b92-89c5-d4b4806619ce}&quot;),</span>
<a href="#l15.37"></a><span id="l15.37" class="difflineplus">+    QueryInterface: XPCOMUtils.generateQI([Components.interfaces.calIPrintFormatter]),</span>
<a href="#l15.38"></a><span id="l15.38"> </span>
<a href="#l15.39"></a><span id="l15.39" class="difflineminus">-    contractID: &quot;@mozilla.org/calendar/printformatter;1?type=weekplan&quot;,</span>
<a href="#l15.40"></a><span id="l15.40" class="difflineminus">-    classDescription: &quot;Calendar Week Print Formatter&quot;,</span>
<a href="#l15.41"></a><span id="l15.41" class="difflineminus">-    classID: Components.ID(&quot;{2d6ec97b-9109-4b92-89c5-d4b4806619ce}&quot;),</span>
<a href="#l15.42"></a><span id="l15.42" class="difflineminus">-    implementationLanguage: Components.interfaces.nsIProgrammingLanguage.JAVASCRIPT,</span>
<a href="#l15.43"></a><span id="l15.43" class="difflineminus">-    flags: 0,</span>
<a href="#l15.44"></a><span id="l15.44" class="difflineplus">+    classInfo: XPCOMUtils.generateCI({</span>
<a href="#l15.45"></a><span id="l15.45" class="difflineplus">+        classID: Components.ID(&quot;{2d6ec97b-9109-4b92-89c5-d4b4806619ce}&quot;),</span>
<a href="#l15.46"></a><span id="l15.46" class="difflineplus">+        contractID: &quot;@mozilla.org/calendar/printformatter;1?type=weekplan&quot;,</span>
<a href="#l15.47"></a><span id="l15.47" class="difflineplus">+        classDescription: &quot;Calendar Week Print Formatter&quot;,</span>
<a href="#l15.48"></a><span id="l15.48" class="difflineplus">+        interfaces: [Components.interfaces.calIPrintFormatter]</span>
<a href="#l15.49"></a><span id="l15.49" class="difflineplus">+    }),</span>
<a href="#l15.50"></a><span id="l15.50"> </span>
<a href="#l15.51"></a><span id="l15.51" class="difflineminus">-    QueryInterface: function QueryInterface(aIID) {</span>
<a href="#l15.52"></a><span id="l15.52" class="difflineminus">-        return cal.doQueryInterface(this, calWeekPrinter.prototype, aIID, null, this);</span>
<a href="#l15.53"></a><span id="l15.53" class="difflineminus">-    },</span>
<a href="#l15.54"></a><span id="l15.54" class="difflineminus">-</span>
<a href="#l15.55"></a><span id="l15.55" class="difflineminus">-    get name() {</span>
<a href="#l15.56"></a><span id="l15.56" class="difflineminus">-        return cal.calGetString(&quot;calendar&quot;, &quot;weekPrinterName&quot;);</span>
<a href="#l15.57"></a><span id="l15.57" class="difflineminus">-    },</span>
<a href="#l15.58"></a><span id="l15.58" class="difflineplus">+    get name() cal.calGetString(&quot;calendar&quot;, &quot;weekPrinterName&quot;),</span>
<a href="#l15.59"></a><span id="l15.59"> </span>
<a href="#l15.60"></a><span id="l15.60">     formatToHtml: function weekPrint_format(aStream, aStart, aEnd, aCount, aItems, aTitle) {</span>
<a href="#l15.61"></a><span id="l15.61" class="difflineminus">-        // Create the e4x framework of the HTML document</span>
<a href="#l15.62"></a><span id="l15.62" class="difflineminus">-        let html = &lt;html/&gt;;</span>
<a href="#l15.63"></a><span id="l15.63" class="difflineminus">-        html.appendChild(</span>
<a href="#l15.64"></a><span id="l15.64" class="difflineminus">-                &lt;head&gt;</span>
<a href="#l15.65"></a><span id="l15.65" class="difflineminus">-                    &lt;title&gt;{aTitle}&lt;/title&gt;</span>
<a href="#l15.66"></a><span id="l15.66" class="difflineminus">-                    &lt;meta http-equiv='Content-Type' content='text/html; charset=UTF-8'/&gt;</span>
<a href="#l15.67"></a><span id="l15.67" class="difflineminus">-                    &lt;link rel='stylesheet' type='text/css' href='chrome://calendar/skin/calendar-printing.css'/&gt;</span>
<a href="#l15.68"></a><span id="l15.68" class="difflineminus">-                &lt;/head&gt;);</span>
<a href="#l15.69"></a><span id="l15.69" class="difflineplus">+        let dateFormatter = cal.getDateFormatter();</span>
<a href="#l15.70"></a><span id="l15.70" class="difflineplus">+        let document = cal.xml.parseFile(&quot;chrome://calendar/skin/printing/calWeekPrinter.html&quot;);</span>
<a href="#l15.71"></a><span id="l15.71"> </span>
<a href="#l15.72"></a><span id="l15.72" class="difflineminus">-        let body = &lt;body/&gt;;</span>
<a href="#l15.73"></a><span id="l15.73" class="difflineplus">+        // Set page title</span>
<a href="#l15.74"></a><span id="l15.74" class="difflineplus">+        document.getElementById(&quot;title&quot;).textContent = aTitle;</span>
<a href="#l15.75"></a><span id="l15.75"> </span>
<a href="#l15.76"></a><span id="l15.76" class="difflineminus">-        // helper: returns the passed item's startDate, entryDate or dueDate, in</span>
<a href="#l15.77"></a><span id="l15.77" class="difflineminus">-        //         that order. If the item doesn't have one of those dates, this</span>
<a href="#l15.78"></a><span id="l15.78" class="difflineminus">-        //         doesn't return.</span>
<a href="#l15.79"></a><span id="l15.79" class="difflineminus">-        function hasUsableDate(item) item.startDate || item.entryDate || item.dueDate;</span>
<a href="#l15.80"></a><span id="l15.80" class="difflineplus">+        // Table that maps YYYY-MM-DD to the DOM node container where items are to be added</span>
<a href="#l15.81"></a><span id="l15.81" class="difflineplus">+        let dayTable = {};</span>
<a href="#l15.82"></a><span id="l15.82"> </span>
<a href="#l15.83"></a><span id="l15.83" class="difflineminus">-        // Clean out the item list so it only contains items we will want to</span>
<a href="#l15.84"></a><span id="l15.84" class="difflineminus">-        // include in the printout.</span>
<a href="#l15.85"></a><span id="l15.85" class="difflineminus">-        let filteredItems = aItems.filter(hasUsableDate);</span>
<a href="#l15.86"></a><span id="l15.86" class="difflineplus">+        // Make sure to create tables from start to end, if passed</span>
<a href="#l15.87"></a><span id="l15.87" class="difflineplus">+        if (aStart &amp;&amp; aEnd) {</span>
<a href="#l15.88"></a><span id="l15.88" class="difflineplus">+            let startDate = aStart.clone();</span>
<a href="#l15.89"></a><span id="l15.89" class="difflineplus">+            startDate.isDate = true;</span>
<a href="#l15.90"></a><span id="l15.90"> </span>
<a href="#l15.91"></a><span id="l15.91" class="difflineminus">-        function compareItems(a, b) {</span>
<a href="#l15.92"></a><span id="l15.92" class="difflineminus">-            // Sort tasks before events</span>
<a href="#l15.93"></a><span id="l15.93" class="difflineminus">-            if (cal.isEvent(a) &amp;&amp; cal.isToDo(b)) {</span>
<a href="#l15.94"></a><span id="l15.94" class="difflineminus">-                return 1;</span>
<a href="#l15.95"></a><span id="l15.95" class="difflineminus">-            }</span>
<a href="#l15.96"></a><span id="l15.96" class="difflineminus">-            if (cal.isToDo(a) &amp;&amp; cal.isEvent(b)) {</span>
<a href="#l15.97"></a><span id="l15.97" class="difflineminus">-                return -1;</span>
<a href="#l15.98"></a><span id="l15.98" class="difflineplus">+            for (let current = cal.userWeekStart(startDate); current.compare(aEnd) &lt; 0; current.day += 7) {</span>
<a href="#l15.99"></a><span id="l15.99" class="difflineplus">+                this.setupWeek(document, current, dayTable);</span>
<a href="#l15.100"></a><span id="l15.100">             }</span>
<a href="#l15.101"></a><span id="l15.101" class="difflineminus">-            if (cal.isEvent(a)) {</span>
<a href="#l15.102"></a><span id="l15.102" class="difflineminus">-                let startCompare = a.startDate.compare(b.startDate);</span>
<a href="#l15.103"></a><span id="l15.103" class="difflineminus">-                if (startCompare != 0) {</span>
<a href="#l15.104"></a><span id="l15.104" class="difflineminus">-                    return startCompare;</span>
<a href="#l15.105"></a><span id="l15.105" class="difflineminus">-                }</span>
<a href="#l15.106"></a><span id="l15.106" class="difflineminus">-                return a.endDate.compare(b.endDate);</span>
<a href="#l15.107"></a><span id="l15.107" class="difflineminus">-            }</span>
<a href="#l15.108"></a><span id="l15.108" class="difflineminus">-            let dateA = a.entryDate || a.dueDate;</span>
<a href="#l15.109"></a><span id="l15.109" class="difflineminus">-            let dateB = b.entryDate || b.dueDate;</span>
<a href="#l15.110"></a><span id="l15.110" class="difflineminus">-            return dateA.compare(dateB);</span>
<a href="#l15.111"></a><span id="l15.111" class="difflineminus">-        }</span>
<a href="#l15.112"></a><span id="l15.112" class="difflineminus">-        let sortedList = filteredItems.sort(compareItems);</span>
<a href="#l15.113"></a><span id="l15.113" class="difflineminus">-</span>
<a href="#l15.114"></a><span id="l15.114" class="difflineminus">-        let weekInfo = cal.getWeekInfoService();</span>
<a href="#l15.115"></a><span id="l15.115" class="difflineminus">-</span>
<a href="#l15.116"></a><span id="l15.116" class="difflineminus">-        // Start at the beginning of the week that aStart is in, and loop until</span>
<a href="#l15.117"></a><span id="l15.117" class="difflineminus">-        // we're at aEnd. In the loop we build the HTML table for each day, and</span>
<a href="#l15.118"></a><span id="l15.118" class="difflineminus">-        // get the day's items using getDayTd().</span>
<a href="#l15.119"></a><span id="l15.119" class="difflineminus">-        let start = aStart || sortedList[0].startDate || sortedList[0].entryDate ||</span>
<a href="#l15.120"></a><span id="l15.120" class="difflineminus">-                    sortList[0].dueDate;</span>
<a href="#l15.121"></a><span id="l15.121" class="difflineminus">-        cal.ASSERT(start, &quot;can't find a good starting date to print&quot;);</span>
<a href="#l15.122"></a><span id="l15.122" class="difflineminus">-</span>
<a href="#l15.123"></a><span id="l15.123" class="difflineminus">-        let lastItem = sortedList[sortedList.length-1];</span>
<a href="#l15.124"></a><span id="l15.124" class="difflineminus">-        let end = aEnd || lastItem.startDate || lastItem.entryDate ||</span>
<a href="#l15.125"></a><span id="l15.125" class="difflineminus">-                   lastItem.dueDate;</span>
<a href="#l15.126"></a><span id="l15.126" class="difflineminus">-        cal.ASSERT(end, &quot;can't find a good ending date to print&quot;);</span>
<a href="#l15.127"></a><span id="l15.127" class="difflineminus">-</span>
<a href="#l15.128"></a><span id="l15.128" class="difflineminus">-        let dt = start.startOfWeek;</span>
<a href="#l15.129"></a><span id="l15.129" class="difflineminus">-        let startOfWeek = cal.getPrefSafe(&quot;calendar.week.start&quot;, 0);</span>
<a href="#l15.130"></a><span id="l15.130" class="difflineminus">-        dt.day += startOfWeek;</span>
<a href="#l15.131"></a><span id="l15.131" class="difflineminus">-        // Make sure we didn't go too far ahead</span>
<a href="#l15.132"></a><span id="l15.132" class="difflineminus">-        if (dt.compare(start) == 1) {</span>
<a href="#l15.133"></a><span id="l15.133" class="difflineminus">-            dt.day -= 7;</span>
<a href="#l15.134"></a><span id="l15.134">         }</span>
<a href="#l15.135"></a><span id="l15.135"> </span>
<a href="#l15.136"></a><span id="l15.136" class="difflineminus">-        while (dt.compare(end) == -1) {</span>
<a href="#l15.137"></a><span id="l15.137" class="difflineminus">-            let weekno = weekInfo.getWeekTitle(dt);</span>
<a href="#l15.138"></a><span id="l15.138" class="difflineminus">-            let weekTitle = cal.calGetString(&quot;calendar&quot;, 'WeekTitle', [weekno]);</span>
<a href="#l15.139"></a><span id="l15.139" class="difflineminus">-            body.appendChild(</span>
<a href="#l15.140"></a><span id="l15.140" class="difflineminus">-                         &lt;table border='0' width='100%' class='main-table'&gt;</span>
<a href="#l15.141"></a><span id="l15.141" class="difflineminus">-                             &lt;tr&gt;</span>
<a href="#l15.142"></a><span id="l15.142" class="difflineminus">-                                 &lt;td align='center' valign='bottom'&gt;{weekTitle}&lt;/td&gt;</span>
<a href="#l15.143"></a><span id="l15.143" class="difflineminus">-                             &lt;/tr&gt;</span>
<a href="#l15.144"></a><span id="l15.144" class="difflineminus">-                         &lt;/table&gt;);</span>
<a href="#l15.145"></a><span id="l15.145" class="difflineminus">-            let mainWeek = &lt;table width='100%' height=&quot;90%&quot; border='solid 1px;'/&gt;</span>
<a href="#l15.146"></a><span id="l15.146" class="difflineplus">+        for each (let item in aItems) {</span>
<a href="#l15.147"></a><span id="l15.147" class="difflineplus">+            let boxDate = item[cal.calGetStartDateProp(item)] || item[cal.calGetEndDateProp(item)];</span>
<a href="#l15.148"></a><span id="l15.148"> </span>
<a href="#l15.149"></a><span id="l15.149" class="difflineminus">-            // Create the &lt;td&gt; for each day, and put it into an array.</span>
<a href="#l15.150"></a><span id="l15.150" class="difflineminus">-            let dayTds = [];</span>
<a href="#l15.151"></a><span id="l15.151" class="difflineminus">-            for (let i = 0; i &lt; 7 ; i++) {</span>
<a href="#l15.152"></a><span id="l15.152" class="difflineminus">-                dayTds[dt.weekday] = this.getDayTd(dt, sortedList);</span>
<a href="#l15.153"></a><span id="l15.153" class="difflineminus">-                dt.day += 1;</span>
<a href="#l15.154"></a><span id="l15.154" class="difflineplus">+            // Ignore items outside of the range, i.e tasks without start date</span>
<a href="#l15.155"></a><span id="l15.155" class="difflineplus">+            // where the end date is somewhere else.</span>
<a href="#l15.156"></a><span id="l15.156" class="difflineplus">+            if (aStart &amp;&amp; aEnd &amp;&amp; boxDate &amp;&amp;</span>
<a href="#l15.157"></a><span id="l15.157" class="difflineplus">+                (boxDate.compare(aStart) &lt; 0 || boxDate.compare(aEnd) &gt;= 0)) {</span>
<a href="#l15.158"></a><span id="l15.158" class="difflineplus">+                continue;</span>
<a href="#l15.159"></a><span id="l15.159">             }</span>
<a href="#l15.160"></a><span id="l15.160"> </span>
<a href="#l15.161"></a><span id="l15.161" class="difflineminus">-            let monRow = &lt;tr height=&quot;33%&quot;/&gt;;</span>
<a href="#l15.162"></a><span id="l15.162" class="difflineminus">-            monRow.appendChild(dayTds[1]); // Monday</span>
<a href="#l15.163"></a><span id="l15.163" class="difflineminus">-            monRow.appendChild(dayTds[4]); // Thursday</span>
<a href="#l15.164"></a><span id="l15.164" class="difflineminus">-            mainWeek.appendChild(monRow);</span>
<a href="#l15.165"></a><span id="l15.165" class="difflineplus">+            if (boxDate) {</span>
<a href="#l15.166"></a><span id="l15.166" class="difflineplus">+                let boxDateKey = cal.print.getDateKey(boxDate);</span>
<a href="#l15.167"></a><span id="l15.167"> </span>
<a href="#l15.168"></a><span id="l15.168" class="difflineminus">-            let tueRow = &lt;tr height=&quot;33%&quot;/&gt;;</span>
<a href="#l15.169"></a><span id="l15.169" class="difflineminus">-            tueRow.appendChild(dayTds[2]); // Tuesday</span>
<a href="#l15.170"></a><span id="l15.170" class="difflineminus">-            tueRow.appendChild(dayTds[5]); // Friday</span>
<a href="#l15.171"></a><span id="l15.171" class="difflineminus">-            mainWeek.appendChild(tueRow);</span>
<a href="#l15.172"></a><span id="l15.172" class="difflineminus">-</span>
<a href="#l15.173"></a><span id="l15.173" class="difflineminus">-            let wedRow = &lt;tr height=&quot;33%&quot;/&gt;;</span>
<a href="#l15.174"></a><span id="l15.174" class="difflineminus">-            wedRow.appendChild(dayTds[3]); // Wednesday</span>
<a href="#l15.175"></a><span id="l15.175" class="difflineminus">-</span>
<a href="#l15.176"></a><span id="l15.176" class="difflineminus">-            // Saturday and Sunday are half-size</span>
<a href="#l15.177"></a><span id="l15.177" class="difflineminus">-            let satSunTd = &lt;td height=&quot;33%&quot;/&gt;;</span>
<a href="#l15.178"></a><span id="l15.178" class="difflineminus">-            let weekendTable = &lt;table border=&quot;1&quot; width=&quot;100%&quot; height=&quot;100%&quot;/&gt;;</span>
<a href="#l15.179"></a><span id="l15.179" class="difflineplus">+                if (!(boxDateKey in dayTable)) {</span>
<a href="#l15.180"></a><span id="l15.180" class="difflineplus">+                    // Doesn't exist, we need to create a new table for it</span>
<a href="#l15.181"></a><span id="l15.181" class="difflineplus">+                    let startOfWeek = boxDate.startOfWeek;</span>
<a href="#l15.182"></a><span id="l15.182" class="difflineplus">+                    this.setupWeek(document, startOfWeek, dayTable);</span>
<a href="#l15.183"></a><span id="l15.183" class="difflineplus">+                }</span>
<a href="#l15.184"></a><span id="l15.184"> </span>
<a href="#l15.185"></a><span id="l15.185" class="difflineminus">-            let satRow = &lt;tr valign='top'/&gt;;</span>
<a href="#l15.186"></a><span id="l15.186" class="difflineminus">-            satRow.appendChild(dayTds[6]); // Saturday</span>
<a href="#l15.187"></a><span id="l15.187" class="difflineminus">-            weekendTable.appendChild(satRow);</span>
<a href="#l15.188"></a><span id="l15.188" class="difflineminus">-</span>
<a href="#l15.189"></a><span id="l15.189" class="difflineminus">-            let sunRow = &lt;tr valign='top'/&gt;;</span>
<a href="#l15.190"></a><span id="l15.190" class="difflineminus">-            sunRow.appendChild(dayTds[0]); // Sunday</span>
<a href="#l15.191"></a><span id="l15.191" class="difflineminus">-            weekendTable.appendChild(sunRow);</span>
<a href="#l15.192"></a><span id="l15.192" class="difflineplus">+                cal.print.addItemToDaybox(document, item, dayTable[boxDateKey]);</span>
<a href="#l15.193"></a><span id="l15.193" class="difflineplus">+            } else {</span>
<a href="#l15.194"></a><span id="l15.194" class="difflineplus">+                cal.print.addItemToDayboxNodate(document, item);</span>
<a href="#l15.195"></a><span id="l15.195" class="difflineplus">+            }</span>
<a href="#l15.196"></a><span id="l15.196" class="difflineplus">+        }</span>
<a href="#l15.197"></a><span id="l15.197"> </span>
<a href="#l15.198"></a><span id="l15.198" class="difflineminus">-            satSunTd.appendChild(weekendTable);</span>
<a href="#l15.199"></a><span id="l15.199" class="difflineminus">-            wedRow.appendChild(satSunTd);</span>
<a href="#l15.200"></a><span id="l15.200" class="difflineminus">-            mainWeek.appendChild(wedRow);</span>
<a href="#l15.201"></a><span id="l15.201" class="difflineminus">-</span>
<a href="#l15.202"></a><span id="l15.202" class="difflineminus">-            body.appendChild(mainWeek);</span>
<a href="#l15.203"></a><span id="l15.203" class="difflineminus">-            // Make sure each month gets put on its own page</span>
<a href="#l15.204"></a><span id="l15.204" class="difflineminus">-            body.appendChild(&lt;br style=&quot;page-break-after: always;&quot;/&gt;);</span>
<a href="#l15.205"></a><span id="l15.205" class="difflineminus">-        }</span>
<a href="#l15.206"></a><span id="l15.206" class="difflineminus">-        let tasks = cal.print.getTasksWithoutDueDate(aItems, dt);</span>
<a href="#l15.207"></a><span id="l15.207" class="difflineminus">-        body.appendChild(tasks);</span>
<a href="#l15.208"></a><span id="l15.208" class="difflineminus">-        html.appendChild(body);</span>
<a href="#l15.209"></a><span id="l15.209" class="difflineplus">+        // Remove templates from HTML, no longer needed</span>
<a href="#l15.210"></a><span id="l15.210" class="difflineplus">+        let templates = document.getElementById(&quot;templates&quot;);</span>
<a href="#l15.211"></a><span id="l15.211" class="difflineplus">+        templates.parentNode.removeChild(templates);</span>
<a href="#l15.212"></a><span id="l15.212"> </span>
<a href="#l15.213"></a><span id="l15.213">         // Stream out the resulting HTML</span>
<a href="#l15.214"></a><span id="l15.214" class="difflineplus">+        let html = cal.xml.serializeDOM(document);</span>
<a href="#l15.215"></a><span id="l15.215">         let convStream = Components.classes[&quot;@mozilla.org/intl/converter-output-stream;1&quot;]</span>
<a href="#l15.216"></a><span id="l15.216">                                    .createInstance(Components.interfaces.nsIConverterOutputStream);</span>
<a href="#l15.217"></a><span id="l15.217">         convStream.init(aStream, 'UTF-8', 0, 0x0000);</span>
<a href="#l15.218"></a><span id="l15.218" class="difflineminus">-        convStream.writeString(html.toXMLString());</span>
<a href="#l15.219"></a><span id="l15.219" class="difflineplus">+        convStream.writeString(html);</span>
<a href="#l15.220"></a><span id="l15.220">     },</span>
<a href="#l15.221"></a><span id="l15.221"> </span>
<a href="#l15.222"></a><span id="l15.222" class="difflineminus">-    /**</span>
<a href="#l15.223"></a><span id="l15.223" class="difflineminus">-     * Given a calIDateTime and an array of items, this function creates an HTML</span>
<a href="#l15.224"></a><span id="l15.224" class="difflineminus">-     * table containing the items, using the appropriate formatting and colours.</span>
<a href="#l15.225"></a><span id="l15.225" class="difflineminus">-     */</span>
<a href="#l15.226"></a><span id="l15.226" class="difflineminus">-    getDayTd: function weekPrint_getDayTable(aDate, aItems) {</span>
<a href="#l15.227"></a><span id="l15.227" class="difflineminus">-        // mainTd is the &lt;td&gt; element from the parent HTML table that will hold</span>
<a href="#l15.228"></a><span id="l15.228" class="difflineminus">-        // the child HTML tables containing the date string and this day's items.</span>
<a href="#l15.229"></a><span id="l15.229" class="difflineminus">-        let mainTd = &lt;td border='1px solid black;' width=&quot;50%&quot; valign='top'/&gt;</span>
<a href="#l15.230"></a><span id="l15.230" class="difflineminus">-        let dateFormatter = cal.getDateFormatter();</span>
<a href="#l15.231"></a><span id="l15.231" class="difflineplus">+    setupWeek: function setupWeek(document, startOfWeek, dayTable) {</span>
<a href="#l15.232"></a><span id="l15.232" class="difflineplus">+        const weekdayMap = [&quot;sunday&quot;, &quot;monday&quot;, &quot;tuesday&quot;, &quot;wednesday&quot;, &quot;thursday&quot;, &quot;friday&quot;, &quot;saturday&quot;];</span>
<a href="#l15.233"></a><span id="l15.233" class="difflineplus">+</span>
<a href="#l15.234"></a><span id="l15.234" class="difflineplus">+        let weekTemplate = document.getElementById(&quot;week-template&quot;);</span>
<a href="#l15.235"></a><span id="l15.235" class="difflineplus">+        let weekContainer = document.getElementById(&quot;week-container&quot;);</span>
<a href="#l15.236"></a><span id="l15.236">         let defaultTimezone = cal.calendarDefaultTimezone();</span>
<a href="#l15.237"></a><span id="l15.237" class="difflineminus">-        let dateString = dateFormatter.formatDateLong(aDate.getInTimezone(defaultTimezone));</span>
<a href="#l15.238"></a><span id="l15.238"> </span>
<a href="#l15.239"></a><span id="l15.239" class="difflineminus">-        // Add the formatted date string (in its own child HTML table)</span>
<a href="#l15.240"></a><span id="l15.240" class="difflineminus">-        mainTd.appendChild(</span>
<a href="#l15.241"></a><span id="l15.241" class="difflineminus">-                         &lt;table class='day-name' width='100%' style='background-color:white; border: 1px solid black;'&gt;</span>
<a href="#l15.242"></a><span id="l15.242" class="difflineminus">-                           &lt;tr&gt;</span>
<a href="#l15.243"></a><span id="l15.243" class="difflineminus">-                             &lt;td align='center' valign='bottom'&gt;{dateString}&lt;/td&gt;</span>
<a href="#l15.244"></a><span id="l15.244" class="difflineminus">-                           &lt;/tr&gt;</span>
<a href="#l15.245"></a><span id="l15.245" class="difflineminus">-                         &lt;/table&gt;);</span>
<a href="#l15.246"></a><span id="l15.246" class="difflineplus">+        // Clone the template week and make sure it doesn't have an id</span>
<a href="#l15.247"></a><span id="l15.247" class="difflineplus">+        let currentPage = weekTemplate.cloneNode(true);</span>
<a href="#l15.248"></a><span id="l15.248" class="difflineplus">+        let startOfWeekKey = cal.print.getDateKey(startOfWeek);</span>
<a href="#l15.249"></a><span id="l15.249" class="difflineplus">+        currentPage.removeAttribute(&quot;id&quot;);</span>
<a href="#l15.250"></a><span id="l15.250" class="difflineplus">+        currentPage.item = startOfWeek.clone();</span>
<a href="#l15.251"></a><span id="l15.251"> </span>
<a href="#l15.252"></a><span id="l15.252" class="difflineminus">-        // Add the formatted items (in their child HTML table)</span>
<a href="#l15.253"></a><span id="l15.253" class="difflineminus">-        let innerTable = &lt;table valign='top' style='font-size: 10px;'/&gt;;</span>
<a href="#l15.254"></a><span id="l15.254" class="difflineminus">-        for each (let item in aItems) {</span>
<a href="#l15.255"></a><span id="l15.255" class="difflineminus">-            let sDate = item.startDate || item.entryDate || item.dueDate;</span>
<a href="#l15.256"></a><span id="l15.256" class="difflineminus">-            let eDate = item.endDate || item.dueDate || item.entryDate;</span>
<a href="#l15.257"></a><span id="l15.257" class="difflineminus">-            if (sDate) {</span>
<a href="#l15.258"></a><span id="l15.258" class="difflineminus">-                sDate = sDate.getInTimezone(defaultTimezone);</span>
<a href="#l15.259"></a><span id="l15.259" class="difflineminus">-            }</span>
<a href="#l15.260"></a><span id="l15.260" class="difflineminus">-            if (eDate) {</span>
<a href="#l15.261"></a><span id="l15.261" class="difflineminus">-                eDate = eDate.getInTimezone(defaultTimezone);</span>
<a href="#l15.262"></a><span id="l15.262" class="difflineminus">-            }</span>
<a href="#l15.263"></a><span id="l15.263" class="difflineplus">+        // Set up the week number title</span>
<a href="#l15.264"></a><span id="l15.264" class="difflineplus">+        let weekInfo = cal.getWeekInfoService();</span>
<a href="#l15.265"></a><span id="l15.265" class="difflineplus">+        let dateFormatter = cal.getDateFormatter();</span>
<a href="#l15.266"></a><span id="l15.266" class="difflineplus">+        let weekno = weekInfo.getWeekTitle(startOfWeek);</span>
<a href="#l15.267"></a><span id="l15.267" class="difflineplus">+        let weekTitle = cal.calGetString(&quot;calendar&quot;, 'WeekTitle', [weekno]);</span>
<a href="#l15.268"></a><span id="l15.268" class="difflineplus">+        currentPage.querySelector(&quot;.week-number&quot;).textContent = weekTitle;</span>
<a href="#l15.269"></a><span id="l15.269"> </span>
<a href="#l15.270"></a><span id="l15.270" class="difflineminus">-            // End dates are exclusive. Adjust the eDate accordingly.</span>
<a href="#l15.271"></a><span id="l15.271" class="difflineminus">-            if (sDate &amp;&amp; sDate.isDate &amp;&amp; eDate) {</span>
<a href="#l15.272"></a><span id="l15.272" class="difflineminus">-                eDate = eDate.clone();</span>
<a href="#l15.273"></a><span id="l15.273" class="difflineminus">-                eDate.day -= 1;</span>
<a href="#l15.274"></a><span id="l15.274" class="difflineminus">-            }</span>
<a href="#l15.275"></a><span id="l15.275"> </span>
<a href="#l15.276"></a><span id="l15.276" class="difflineminus">-            // If the item has no end date, or if the item's end date is aDate or</span>
<a href="#l15.277"></a><span id="l15.277" class="difflineminus">-            // is before aDate, skip to the next item.</span>
<a href="#l15.278"></a><span id="l15.278" class="difflineminus">-            if (!eDate || (eDate.compare(aDate) &lt; 0)) {</span>
<a href="#l15.279"></a><span id="l15.279" class="difflineminus">-                continue;</span>
<a href="#l15.280"></a><span id="l15.280" class="difflineminus">-            }</span>
<a href="#l15.281"></a><span id="l15.281" class="difflineplus">+        // Set up the day boxes</span>
<a href="#l15.282"></a><span id="l15.282" class="difflineplus">+        let endOfWeek = cal.userWeekEnd(startOfWeek);</span>
<a href="#l15.283"></a><span id="l15.283" class="difflineplus">+        for (let currentDate = startOfWeek; currentDate.compare(endOfWeek) &lt;= 0; currentDate.day++) {</span>
<a href="#l15.284"></a><span id="l15.284" class="difflineplus">+            let weekday = currentDate.weekday;</span>
<a href="#l15.285"></a><span id="l15.285" class="difflineplus">+            let weekdayName = weekdayMap[weekday];</span>
<a href="#l15.286"></a><span id="l15.286" class="difflineplus">+            let dayOffPrefName = &quot;calendar.week.d&quot; +  weekday + weekdayName + &quot;soff&quot;;</span>
<a href="#l15.287"></a><span id="l15.287" class="difflineplus">+            dayTable[cal.print.getDateKey(currentDate)] = currentPage.querySelector(&quot;.&quot; + weekdayName + &quot;-container&quot;);</span>
<a href="#l15.288"></a><span id="l15.288"> </span>
<a href="#l15.289"></a><span id="l15.289" class="difflineminus">-            // No start date or a start date that's after the date we want is bad.</span>
<a href="#l15.290"></a><span id="l15.290" class="difflineminus">-            if (!sDate || (sDate.compare(aDate) &gt; 0)) {</span>
<a href="#l15.291"></a><span id="l15.291" class="difflineminus">-                break;</span>
<a href="#l15.292"></a><span id="l15.292" class="difflineminus">-            }</span>
<a href="#l15.293"></a><span id="l15.293" class="difflineminus">-</span>
<a href="#l15.294"></a><span id="l15.294" class="difflineminus">-            let time = &quot;&quot;;</span>
<a href="#l15.295"></a><span id="l15.295" class="difflineminus">-            if (sDate &amp;&amp; eDate &amp;&amp; !sDate.isDate) {</span>
<a href="#l15.296"></a><span id="l15.296" class="difflineminus">-                time = dateFormatter.formatTime(sDate) + '-' + dateFormatter.formatTime(eDate);</span>
<a href="#l15.297"></a><span id="l15.297" class="difflineminus">-            } else if (sDate &amp;&amp; !sDate.isDate) {</span>
<a href="#l15.298"></a><span id="l15.298" class="difflineminus">-                time = dateFormatter.formatTime(sDate);</span>
<a href="#l15.299"></a><span id="l15.299" class="difflineminus">-            } else if (eDate &amp;&amp; !eDate.isDate) {</span>
<a href="#l15.300"></a><span id="l15.300" class="difflineminus">-                time = dateFormatter.formatTime(eDate);</span>
<a href="#l15.301"></a><span id="l15.301" class="difflineminus">-            }</span>
<a href="#l15.302"></a><span id="l15.302" class="difflineplus">+            let titleNode = currentPage.querySelector(&quot;.&quot; + weekdayName + &quot;-title&quot;);</span>
<a href="#l15.303"></a><span id="l15.303" class="difflineplus">+            titleNode.textContent = dateFormatter.formatDateLong(currentDate.getInTimezone(defaultTimezone));</span>
<a href="#l15.304"></a><span id="l15.304"> </span>
<a href="#l15.305"></a><span id="l15.305" class="difflineminus">-            // Get calendar and category colours and apply them to the item's</span>
<a href="#l15.306"></a><span id="l15.306" class="difflineminus">-            // table cell.</span>
<a href="#l15.307"></a><span id="l15.307" class="difflineminus">-            let calColor = item.calendar.getProperty('color') || &quot;#A8C2E1&quot;;</span>
<a href="#l15.308"></a><span id="l15.308" class="difflineminus">-            let pb2 = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l15.309"></a><span id="l15.309" class="difflineminus">-                                .getService(Components.interfaces.nsIPrefBranch);</span>
<a href="#l15.310"></a><span id="l15.310" class="difflineminus">-            let catColor;</span>
<a href="#l15.311"></a><span id="l15.311" class="difflineminus">-            for each (let cat in item.getCategories({})) {</span>
<a href="#l15.312"></a><span id="l15.312" class="difflineminus">-                try {</span>
<a href="#l15.313"></a><span id="l15.313" class="difflineminus">-                    catColor = pb2.getCharPref(&quot;calendar.category.color.&quot; + cal.formatStringForCSSRule(cat));</span>
<a href="#l15.314"></a><span id="l15.314" class="difflineminus">-                    break; // take first matching</span>
<a href="#l15.315"></a><span id="l15.315" class="difflineminus">-                } catch (ex) {}</span>
<a href="#l15.316"></a><span id="l15.316" class="difflineplus">+            if (cal.getPrefSafe(dayOffPrefName, false)) {</span>
<a href="#l15.317"></a><span id="l15.317" class="difflineplus">+                let daysOffNode = currentPage.querySelector(&quot;.&quot; + weekdayName + &quot;-box&quot;);</span>
<a href="#l15.318"></a><span id="l15.318" class="difflineplus">+                daysOffNode.className += &quot; day-off&quot;;</span>
<a href="#l15.319"></a><span id="l15.319">             }</span>
<a href="#l15.320"></a><span id="l15.320" class="difflineplus">+        }</span>
<a href="#l15.321"></a><span id="l15.321"> </span>
<a href="#l15.322"></a><span id="l15.322" class="difflineminus">-            let style = 'font-size: 11px; background-color: ' + calColor + ';';</span>
<a href="#l15.323"></a><span id="l15.323" class="difflineminus">-            style += ' color: ' + cal.getContrastingTextColor(calColor) + ';';</span>
<a href="#l15.324"></a><span id="l15.324" class="difflineminus">-            if (catColor) {</span>
<a href="#l15.325"></a><span id="l15.325" class="difflineminus">-                style += ' border: solid ' + catColor + ' 2px;';</span>
<a href="#l15.326"></a><span id="l15.326" class="difflineminus">-            }</span>
<a href="#l15.327"></a><span id="l15.327" class="difflineminus">-            let tableRow = &lt;tr&gt;&lt;td valign='top' align='left' style={style}&gt;{time} {item.title}&lt;/td&gt;&lt;/tr&gt;;</span>
<a href="#l15.328"></a><span id="l15.328" class="difflineminus">-            innerTable.appendChild(tableRow);</span>
<a href="#l15.329"></a><span id="l15.329" class="difflineplus">+        // Now insert the week into the week container, sorting by date (and therefore week number)</span>
<a href="#l15.330"></a><span id="l15.330" class="difflineplus">+        function compareDates(a, b) {</span>
<a href="#l15.331"></a><span id="l15.331" class="difflineplus">+            if (!a || !b) return -1;</span>
<a href="#l15.332"></a><span id="l15.332" class="difflineplus">+            let res = a.compare(b);</span>
<a href="#l15.333"></a><span id="l15.333" class="difflineplus">+            return res;</span>
<a href="#l15.334"></a><span id="l15.334">         }</span>
<a href="#l15.335"></a><span id="l15.335" class="difflineminus">-        innerTable.appendChild(&lt;p&gt; &lt;/p&gt;);</span>
<a href="#l15.336"></a><span id="l15.336" class="difflineminus">-        mainTd.appendChild(innerTable);</span>
<a href="#l15.337"></a><span id="l15.337" class="difflineminus">-        return mainTd;</span>
<a href="#l15.338"></a><span id="l15.338" class="difflineplus">+</span>
<a href="#l15.339"></a><span id="l15.339" class="difflineplus">+        cal.binaryInsertNode(weekContainer, currentPage, currentPage.item, compareDates);</span>
<a href="#l15.340"></a><span id="l15.340">     }</span>
<a href="#l15.341"></a><span id="l15.341"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1">new file mode 100644</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineminus">--- /dev/null</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineplus">+++ b/calendar/import-export/jar.mn</span>
<a href="#l16.4"></a><span id="l16.4" class="difflineat">@@ -0,0 +1,5 @@</span>
<a href="#l16.5"></a><span id="l16.5" class="difflineplus">+#filter substitution</span>
<a href="#l16.6"></a><span id="l16.6" class="difflineplus">+calendar.jar:</span>
<a href="#l16.7"></a><span id="l16.7" class="difflineplus">+    skin/calendar/printing/calWeekPrinter.html             (calWeekPrinter.html)</span>
<a href="#l16.8"></a><span id="l16.8" class="difflineplus">+    skin/calendar/printing/calMonthGridPrinter.html        (calMonthGridPrinter.html)</span>
<a href="#l16.9"></a><span id="l16.9" class="difflineplus">+    skin/calendar/printing/calHtmlExport.html              (calHtmlExport.html)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/calendar/lightning/components/lightningTextCalendarConverter.js</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/calendar/lightning/components/lightningTextCalendarConverter.js</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -1,15 +1,16 @@</span>
<a href="#l17.4"></a><span id="l17.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l17.5"></a><span id="l17.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l17.6"></a><span id="l17.6">  * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l17.7"></a><span id="l17.7"> </span>
<a href="#l17.8"></a><span id="l17.8"> Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l17.9"></a><span id="l17.9"> Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l17.10"></a><span id="l17.10"> Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l17.11"></a><span id="l17.11" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calXMLUtils.jsm&quot;);</span>
<a href="#l17.12"></a><span id="l17.12"> </span>
<a href="#l17.13"></a><span id="l17.13"> function ltnMimeConverter() {</span>
<a href="#l17.14"></a><span id="l17.14"> }</span>
<a href="#l17.15"></a><span id="l17.15"> </span>
<a href="#l17.16"></a><span id="l17.16"> ltnMimeConverter.prototype = {</span>
<a href="#l17.17"></a><span id="l17.17">     classID: Components.ID(&quot;{c70acb08-464e-4e55-899d-b2c84c5409fa}&quot;),</span>
<a href="#l17.18"></a><span id="l17.18"> </span>
<a href="#l17.19"></a><span id="l17.19">     QueryInterface: XPCOMUtils.generateQI([Components.interfaces.nsISimpleMimeConverter]),</span>
<a href="#l17.20"></a><span id="l17.20" class="difflineat">@@ -57,40 +58,24 @@ ltnMimeConverter.prototype = {</span>
<a href="#l17.21"></a><span id="l17.21"> </span>
<a href="#l17.22"></a><span id="l17.22">             node.appendChild(a);</span>
<a href="#l17.23"></a><span id="l17.23"> </span>
<a href="#l17.24"></a><span id="l17.24">             localText = localText.substr(endPos);</span>
<a href="#l17.25"></a><span id="l17.25">         }</span>
<a href="#l17.26"></a><span id="l17.26">     },</span>
<a href="#l17.27"></a><span id="l17.27"> </span>
<a href="#l17.28"></a><span id="l17.28">     /**</span>
<a href="#l17.29"></a><span id="l17.29" class="difflineminus">-     * Synchronously read the given uri and return its xml document</span>
<a href="#l17.30"></a><span id="l17.30" class="difflineminus">-     *</span>
<a href="#l17.31"></a><span id="l17.31" class="difflineminus">-     * @param uri       The uri to read.</span>
<a href="#l17.32"></a><span id="l17.32" class="difflineminus">-     * @return          The response DOM Document.</span>
<a href="#l17.33"></a><span id="l17.33" class="difflineminus">-     */</span>
<a href="#l17.34"></a><span id="l17.34" class="difflineminus">-    readChromeUri: function readChromeUri(uri) {</span>
<a href="#l17.35"></a><span id="l17.35" class="difflineminus">-        let req = Components.classes[&quot;@mozilla.org/xmlextras/xmlhttprequest;1&quot;]</span>
<a href="#l17.36"></a><span id="l17.36" class="difflineminus">-                            .createInstance(Components.interfaces.nsIXMLHttpRequest);</span>
<a href="#l17.37"></a><span id="l17.37" class="difflineminus">-</span>
<a href="#l17.38"></a><span id="l17.38" class="difflineminus">-        req.open('GET', uri, false);</span>
<a href="#l17.39"></a><span id="l17.39" class="difflineminus">-        req.overrideMimeType(&quot;text/xml&quot;);</span>
<a href="#l17.40"></a><span id="l17.40" class="difflineminus">-        req.send(null);</span>
<a href="#l17.41"></a><span id="l17.41" class="difflineminus">-        return req.responseXML;</span>
<a href="#l17.42"></a><span id="l17.42" class="difflineminus">-    },</span>
<a href="#l17.43"></a><span id="l17.43" class="difflineminus">-</span>
<a href="#l17.44"></a><span id="l17.44" class="difflineminus">-    /**</span>
<a href="#l17.45"></a><span id="l17.45">      * Returns the html representation of the event as a DOM document.</span>
<a href="#l17.46"></a><span id="l17.46">      *</span>
<a href="#l17.47"></a><span id="l17.47">      * @param event     The calIItemBase to parse into html.</span>
<a href="#l17.48"></a><span id="l17.48">      * @return          The DOM document with values filled in.</span>
<a href="#l17.49"></a><span id="l17.49">      */</span>
<a href="#l17.50"></a><span id="l17.50">     createHtml: function createHtml(event) {</span>
<a href="#l17.51"></a><span id="l17.51">         // Creates HTML using the Node strings in the properties file</span>
<a href="#l17.52"></a><span id="l17.52" class="difflineminus">-        let doc = this.readChromeUri(&quot;chrome://lightning/content/lightning-invitation.xhtml&quot;);</span>
<a href="#l17.53"></a><span id="l17.53" class="difflineplus">+        let doc = cal.xml.parseFile(&quot;chrome://lightning/content/lightning-invitation.xhtml&quot;);</span>
<a href="#l17.54"></a><span id="l17.54">         let self = this;</span>
<a href="#l17.55"></a><span id="l17.55">         function field(field, contentText, linkify) {</span>
<a href="#l17.56"></a><span id="l17.56">             let descr = doc.getElementById(&quot;imipHtml-&quot; + field + &quot;-descr&quot;);</span>
<a href="#l17.57"></a><span id="l17.57">             if (descr) {</span>
<a href="#l17.58"></a><span id="l17.58">                 let labelText = cal.calGetString(&quot;lightning&quot;, &quot;imipHtml.&quot; + field, null, &quot;lightning&quot;);</span>
<a href="#l17.59"></a><span id="l17.59">                 descr.textContent = labelText;</span>
<a href="#l17.60"></a><span id="l17.60">             }</span>
<a href="#l17.61"></a><span id="l17.61"> </span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

