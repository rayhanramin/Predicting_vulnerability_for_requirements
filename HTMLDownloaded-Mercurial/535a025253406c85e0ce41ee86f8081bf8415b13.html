<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 18020:535a025253406c85e0ce41ee86f8081bf8415b13</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 535a025253406c85e0ce41ee86f8081bf8415b13" />
<meta property="og:url" content="/comm-central/rev/535a025253406c85e0ce41ee86f8081bf8415b13" />
<meta property="og:description" content="Bug 1173366 - Use aData parameter of update-typing notifications to pass a short name to the UI. r=aleth" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 535a025253406c85e0ce41ee86f8081bf8415b13 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/535a025253406c85e0ce41ee86f8081bf8415b13">shortlog</a> |
<a href="/comm-central/log/535a025253406c85e0ce41ee86f8081bf8415b13">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/535a025253406c85e0ce41ee86f8081bf8415b13">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/535a025253406c85e0ce41ee86f8081bf8415b13">files</a> |
changeset |
<a href="/comm-central/raw-rev/535a025253406c85e0ce41ee86f8081bf8415b13">raw</a>  | <a href="/comm-central/archive/535a025253406c85e0ce41ee86f8081bf8415b13.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1173366">Bug 1173366</a> - Use aData parameter of update-typing notifications to pass a short name to the UI. r=aleth
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#65;&#98;&#100;&#101;&#108;&#114;&#104;&#109;&#97;&#110;&#32;&#65;&#104;&#109;&#101;&#100;&#32;&#60;&#97;&#46;&#97;&#104;&#109;&#101;&#100;&#49;&#48;&#50;&#54;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Sun, 14 Jun 2015 09:23:00 +0200</td></tr>

<tr>
 <td>changeset 18020</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/535a025253406c85e0ce41ee86f8081bf8415b13">535a025253406c85e0ce41ee86f8081bf8415b13</a></td>
</tr>



<tr>
<td>parent 18019</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/c352d4695e280ede8c37d0e1f3ede6fc51d3e10e">c352d4695e280ede8c37d0e1f3ede6fc51d3e10e</a>
</td>
</tr>

<tr>
<td>child 18021</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/8f8d9edfa43ef98b6bc7c1478c7d4d4a8cf43179">8f8d9edfa43ef98b6bc7c1478c7d4d4a8cf43179</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=535a025253406c85e0ce41ee86f8081bf8415b13">11075</a></td></tr>
<tr><td>push user</td><td>aleth@instantbird.org</td></tr>
<tr><td>push date</td><td class="date age">Sun, 14 Jun 2015 16:50:04 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@4c61c3db9975 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=4c61c3db9975da4020b7c83736628f426f4f56d4">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=4c61c3db9975da4020b7c83736628f426f4f56d4&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=4c61c3db9975da4020b7c83736628f426f4f56d4&newProject=comm-central&newRevision=535a025253406c85e0ce41ee86f8081bf8415b13&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=4c61c3db9975da4020b7c83736628f426f4f56d4&newProject=comm-central&newRevision=535a025253406c85e0ce41ee86f8081bf8415b13&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=4c61c3db9975da4020b7c83736628f426f4f56d4&newProject=comm-central&newRevision=535a025253406c85e0ce41ee86f8081bf8415b13&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28aleth%29&revcount=50">aleth</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1173366">1173366</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1173366">Bug 1173366</a> - Use aData parameter of update-typing notifications to pass a short name to the UI. r=aleth</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/535a025253406c85e0ce41ee86f8081bf8415b13/chat/modules/jsProtoHelper.jsm">chat/modules/jsProtoHelper.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/535a025253406c85e0ce41ee86f8081bf8415b13/chat/modules/jsProtoHelper.jsm">file</a> |
<a href="/comm-central/annotate/535a025253406c85e0ce41ee86f8081bf8415b13/chat/modules/jsProtoHelper.jsm">annotate</a> |
<a href="/comm-central/diff/535a025253406c85e0ce41ee86f8081bf8415b13/chat/modules/jsProtoHelper.jsm">diff</a> |
<a href="/comm-central/comparison/535a025253406c85e0ce41ee86f8081bf8415b13/chat/modules/jsProtoHelper.jsm">comparison</a> |
<a href="/comm-central/log/535a025253406c85e0ce41ee86f8081bf8415b13/chat/modules/jsProtoHelper.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/535a025253406c85e0ce41ee86f8081bf8415b13/chat/protocols/xmpp/xmpp.jsm">chat/protocols/xmpp/xmpp.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/535a025253406c85e0ce41ee86f8081bf8415b13/chat/protocols/xmpp/xmpp.jsm">file</a> |
<a href="/comm-central/annotate/535a025253406c85e0ce41ee86f8081bf8415b13/chat/protocols/xmpp/xmpp.jsm">annotate</a> |
<a href="/comm-central/diff/535a025253406c85e0ce41ee86f8081bf8415b13/chat/protocols/xmpp/xmpp.jsm">diff</a> |
<a href="/comm-central/comparison/535a025253406c85e0ce41ee86f8081bf8415b13/chat/protocols/xmpp/xmpp.jsm">comparison</a> |
<a href="/comm-central/log/535a025253406c85e0ce41ee86f8081bf8415b13/chat/protocols/xmpp/xmpp.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/535a025253406c85e0ce41ee86f8081bf8415b13/chat/protocols/yahoo/test/test_yahooAccount.js">chat/protocols/yahoo/test/test_yahooAccount.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/535a025253406c85e0ce41ee86f8081bf8415b13/chat/protocols/yahoo/test/test_yahooAccount.js">file</a> |
<a href="/comm-central/annotate/535a025253406c85e0ce41ee86f8081bf8415b13/chat/protocols/yahoo/test/test_yahooAccount.js">annotate</a> |
<a href="/comm-central/diff/535a025253406c85e0ce41ee86f8081bf8415b13/chat/protocols/yahoo/test/test_yahooAccount.js">diff</a> |
<a href="/comm-central/comparison/535a025253406c85e0ce41ee86f8081bf8415b13/chat/protocols/yahoo/test/test_yahooAccount.js">comparison</a> |
<a href="/comm-central/log/535a025253406c85e0ce41ee86f8081bf8415b13/chat/protocols/yahoo/test/test_yahooAccount.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/535a025253406c85e0ce41ee86f8081bf8415b13/chat/protocols/yahoo/yahoo.js">chat/protocols/yahoo/yahoo.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/535a025253406c85e0ce41ee86f8081bf8415b13/chat/protocols/yahoo/yahoo.js">file</a> |
<a href="/comm-central/annotate/535a025253406c85e0ce41ee86f8081bf8415b13/chat/protocols/yahoo/yahoo.js">annotate</a> |
<a href="/comm-central/diff/535a025253406c85e0ce41ee86f8081bf8415b13/chat/protocols/yahoo/yahoo.js">diff</a> |
<a href="/comm-central/comparison/535a025253406c85e0ce41ee86f8081bf8415b13/chat/protocols/yahoo/yahoo.js">comparison</a> |
<a href="/comm-central/log/535a025253406c85e0ce41ee86f8081bf8415b13/chat/protocols/yahoo/yahoo.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/535a025253406c85e0ce41ee86f8081bf8415b13/im/content/conversation.xml">im/content/conversation.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/535a025253406c85e0ce41ee86f8081bf8415b13/im/content/conversation.xml">file</a> |
<a href="/comm-central/annotate/535a025253406c85e0ce41ee86f8081bf8415b13/im/content/conversation.xml">annotate</a> |
<a href="/comm-central/diff/535a025253406c85e0ce41ee86f8081bf8415b13/im/content/conversation.xml">diff</a> |
<a href="/comm-central/comparison/535a025253406c85e0ce41ee86f8081bf8415b13/im/content/conversation.xml">comparison</a> |
<a href="/comm-central/log/535a025253406c85e0ce41ee86f8081bf8415b13/im/content/conversation.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/535a025253406c85e0ce41ee86f8081bf8415b13/mail/components/im/content/imconversation.xml">mail/components/im/content/imconversation.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/535a025253406c85e0ce41ee86f8081bf8415b13/mail/components/im/content/imconversation.xml">file</a> |
<a href="/comm-central/annotate/535a025253406c85e0ce41ee86f8081bf8415b13/mail/components/im/content/imconversation.xml">annotate</a> |
<a href="/comm-central/diff/535a025253406c85e0ce41ee86f8081bf8415b13/mail/components/im/content/imconversation.xml">diff</a> |
<a href="/comm-central/comparison/535a025253406c85e0ce41ee86f8081bf8415b13/mail/components/im/content/imconversation.xml">comparison</a> |
<a href="/comm-central/log/535a025253406c85e0ce41ee86f8081bf8415b13/mail/components/im/content/imconversation.xml">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/chat/modules/jsProtoHelper.jsm</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/chat/modules/jsProtoHelper.jsm</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -514,25 +514,25 @@ const GenericConversationPrototype = {</span>
<a href="#l1.4"></a><span id="l1.4">   get startDate() this._date</span>
<a href="#l1.5"></a><span id="l1.5"> };</span>
<a href="#l1.6"></a><span id="l1.6"> </span>
<a href="#l1.7"></a><span id="l1.7"> const GenericConvIMPrototype = {</span>
<a href="#l1.8"></a><span id="l1.8">   __proto__: GenericConversationPrototype,</span>
<a href="#l1.9"></a><span id="l1.9">   _interfaces: [Ci.prplIConversation, Ci.prplIConvIM],</span>
<a href="#l1.10"></a><span id="l1.10">   classDescription: &quot;generic ConvIM object&quot;,</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-  updateTyping: function(aState) {</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+  updateTyping: function(aState, aName) {</span>
<a href="#l1.14"></a><span id="l1.14">     if (aState == this.typingState)</span>
<a href="#l1.15"></a><span id="l1.15">       return;</span>
<a href="#l1.16"></a><span id="l1.16"> </span>
<a href="#l1.17"></a><span id="l1.17">     if (aState == Ci.prplIConvIM.NOT_TYPING)</span>
<a href="#l1.18"></a><span id="l1.18">       delete this.typingState;</span>
<a href="#l1.19"></a><span id="l1.19">     else</span>
<a href="#l1.20"></a><span id="l1.20">       this.typingState = aState;</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineminus">-    this.notifyObservers(null, &quot;update-typing&quot;, null);</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineplus">+    this.notifyObservers(null, &quot;update-typing&quot;, aName);</span>
<a href="#l1.23"></a><span id="l1.23">   },</span>
<a href="#l1.24"></a><span id="l1.24"> </span>
<a href="#l1.25"></a><span id="l1.25">   get isChat() false,</span>
<a href="#l1.26"></a><span id="l1.26">   buddy: null,</span>
<a href="#l1.27"></a><span id="l1.27">   typingState: Ci.prplIConvIM.NOT_TYPING</span>
<a href="#l1.28"></a><span id="l1.28"> };</span>
<a href="#l1.29"></a><span id="l1.29"> </span>
<a href="#l1.30"></a><span id="l1.30"> const GenericConvChatPrototype = {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/chat/protocols/xmpp/xmpp.jsm</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/chat/protocols/xmpp/xmpp.jsm</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -372,16 +372,27 @@ const XMPPConversationPrototype = {</span>
<a href="#l2.4"></a><span id="l2.4">   supportChatStateNotifications: true,</span>
<a href="#l2.5"></a><span id="l2.5">   _typingState: &quot;active&quot;,</span>
<a href="#l2.6"></a><span id="l2.6"> </span>
<a href="#l2.7"></a><span id="l2.7">   get buddy() this._account._buddies.get(this.name),</span>
<a href="#l2.8"></a><span id="l2.8">   get title() this.contactDisplayName,</span>
<a href="#l2.9"></a><span id="l2.9">   get contactDisplayName() this.buddy ? this.buddy.contactDisplayName : this.name,</span>
<a href="#l2.10"></a><span id="l2.10">   get userName() this.buddy ? this.buddy.userName : this.name,</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+  // Used to avoid showing full jids in typing notifications.</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+  get shortName() {</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+    if (this.buddy)</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+      return this.buddy.contactDisplayName;</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineplus">+    let jid = this._account._parseJID(this.name);</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineplus">+    if (!jid || !jid.node)</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineplus">+      return this.name;</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineplus">+    return jid.node;</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineplus">+  },</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineplus">+</span>
<a href="#l2.23"></a><span id="l2.23">   get shouldSendTypingNotifications()</span>
<a href="#l2.24"></a><span id="l2.24">     this.supportChatStateNotifications &amp;&amp;</span>
<a href="#l2.25"></a><span id="l2.25">     Services.prefs.getBoolPref(&quot;purple.conversations.im.send_typing&quot;),</span>
<a href="#l2.26"></a><span id="l2.26"> </span>
<a href="#l2.27"></a><span id="l2.27">   /* Called when the user is typing a message</span>
<a href="#l2.28"></a><span id="l2.28">    * aString - the currently typed message</span>
<a href="#l2.29"></a><span id="l2.29">    * Returns the number of characters that can still be typed */</span>
<a href="#l2.30"></a><span id="l2.30">   sendTyping: function(aString) {</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineat">@@ -689,17 +700,17 @@ const XMPPAccountBuddyPrototype = {</span>
<a href="#l2.32"></a><span id="l2.32">     let resource =</span>
<a href="#l2.33"></a><span id="l2.33">       this._account._parseJID(aStanza.attributes[&quot;from&quot;]).resource || &quot;&quot;;</span>
<a href="#l2.34"></a><span id="l2.34"> </span>
<a href="#l2.35"></a><span id="l2.35">     let type = aStanza.attributes[&quot;type&quot;];</span>
<a href="#l2.36"></a><span id="l2.36"> </span>
<a href="#l2.37"></a><span id="l2.37">     // Reset typing status if the buddy is in a conversation and becomes unavailable.</span>
<a href="#l2.38"></a><span id="l2.38">     let conv = this._account._conv.get(this.normalizedName);</span>
<a href="#l2.39"></a><span id="l2.39">     if (type == &quot;unavailable&quot; &amp;&amp; conv)</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineminus">-      conv.updateTyping(Ci.prplIConvIM.NOT_TYPING);</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineplus">+      conv.updateTyping(Ci.prplIConvIM.NOT_TYPING, this.contactDisplayName);</span>
<a href="#l2.42"></a><span id="l2.42"> </span>
<a href="#l2.43"></a><span id="l2.43">     if (type == &quot;unavailable&quot; || type == &quot;error&quot;) {</span>
<a href="#l2.44"></a><span id="l2.44">       if (!this._resources || !(resource in this._resources))</span>
<a href="#l2.45"></a><span id="l2.45">         return; // ignore for already offline resources.</span>
<a href="#l2.46"></a><span id="l2.46">       delete this._resources[resource];</span>
<a href="#l2.47"></a><span id="l2.47">       if (preferred == resource)</span>
<a href="#l2.48"></a><span id="l2.48">         preferred = undefined;</span>
<a href="#l2.49"></a><span id="l2.49">     }</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineat">@@ -1347,17 +1358,17 @@ const XMPPAccountPrototype = {</span>
<a href="#l2.51"></a><span id="l2.51">     if (state) {</span>
<a href="#l2.52"></a><span id="l2.52">       this.DEBUG(state);</span>
<a href="#l2.53"></a><span id="l2.53">       if (state == &quot;composing&quot;)</span>
<a href="#l2.54"></a><span id="l2.54">         typingState = Ci.prplIConvIM.TYPING;</span>
<a href="#l2.55"></a><span id="l2.55">       else if (state == &quot;paused&quot;)</span>
<a href="#l2.56"></a><span id="l2.56">         typingState = Ci.prplIConvIM.TYPED;</span>
<a href="#l2.57"></a><span id="l2.57">     }</span>
<a href="#l2.58"></a><span id="l2.58">     let conv = this._conv.get(norm);</span>
<a href="#l2.59"></a><span id="l2.59" class="difflineminus">-    conv.updateTyping(typingState);</span>
<a href="#l2.60"></a><span id="l2.60" class="difflineplus">+    conv.updateTyping(typingState, conv.shortName);</span>
<a href="#l2.61"></a><span id="l2.61">     conv.supportChatStateNotifications = !!state;</span>
<a href="#l2.62"></a><span id="l2.62">   },</span>
<a href="#l2.63"></a><span id="l2.63"> </span>
<a href="#l2.64"></a><span id="l2.64">   /* Called when there is an error in the xmpp session */</span>
<a href="#l2.65"></a><span id="l2.65">   onError: function(aError, aException) {</span>
<a href="#l2.66"></a><span id="l2.66">     if (aError === null || aError === undefined)</span>
<a href="#l2.67"></a><span id="l2.67">       aError = Ci.prplIAccount.ERROR_OTHER_ERROR;</span>
<a href="#l2.68"></a><span id="l2.68">     this._disconnect(aError, aException.toString());</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/chat/protocols/yahoo/test/test_yahooAccount.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/chat/protocols/yahoo/test/test_yahooAccount.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -79,19 +79,19 @@ function test_fixFontSize()</span>
<a href="#l3.4"></a><span id="l3.4">   let fakeImAccount = {name: &quot;test-user&quot;};</span>
<a href="#l3.5"></a><span id="l3.5">   // We create a fake conversation object so we can obtain the cleaned up</span>
<a href="#l3.6"></a><span id="l3.6">   // message from the conv.writeMessage() call.</span>
<a href="#l3.7"></a><span id="l3.7">   let messagePair;</span>
<a href="#l3.8"></a><span id="l3.8">   let fakeConversation = {</span>
<a href="#l3.9"></a><span id="l3.9">     writeMessage: function(aName, aMessage, aProperties) {</span>
<a href="#l3.10"></a><span id="l3.10">       do_check_eq(aMessage, messagePair[1]); // Compare to the good message.</span>
<a href="#l3.11"></a><span id="l3.11">     },</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-    updateTyping: function(aStatus) { }</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+    updateTyping: function(aStatus, aName) { }</span>
<a href="#l3.14"></a><span id="l3.14">   };</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineminus">-  </span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+</span>
<a href="#l3.17"></a><span id="l3.17">   let yahooAccount = new yahoo.YahooAccount(fakeProtocol, fakeImAccount);</span>
<a href="#l3.18"></a><span id="l3.18">   yahooAccount._conversations.set(&quot;test-user&quot;, fakeConversation);</span>
<a href="#l3.19"></a><span id="l3.19">   for each(let pair in testMessages) {</span>
<a href="#l3.20"></a><span id="l3.20">     messagePair = pair;</span>
<a href="#l3.21"></a><span id="l3.21">     // Send in the badly formed message.</span>
<a href="#l3.22"></a><span id="l3.22">     yahooAccount.receiveMessage(&quot;test-user&quot;, messagePair[0]);</span>
<a href="#l3.23"></a><span id="l3.23">   }</span>
<a href="#l3.24"></a><span id="l3.24">   run_next_test();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/chat/protocols/yahoo/yahoo.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/chat/protocols/yahoo/yahoo.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -402,36 +402,37 @@ YahooAccount.prototype = {</span>
<a href="#l4.4"></a><span id="l4.4"> </span>
<a href="#l4.5"></a><span id="l4.5">     // Certain Yahoo clients, such as the official web client, sends formatted</span>
<a href="#l4.6"></a><span id="l4.6">     // messages, but the size value is the actual pt size, not the 1 - 7 size</span>
<a href="#l4.7"></a><span id="l4.7">     // expected from the HTML &lt;font&gt; tag. We replace it with the correct size.</span>
<a href="#l4.8"></a><span id="l4.8">     let message = this.decodeMessage(aMessage)</span>
<a href="#l4.9"></a><span id="l4.9">                       .replace(/(&lt;font[^&gt;]+)size=\&quot;(\d+)\&quot;/g, this._fixFontSize);</span>
<a href="#l4.10"></a><span id="l4.10"> </span>
<a href="#l4.11"></a><span id="l4.11">     conv.writeMessage(aName, message, {incoming: true});</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-    conv.updateTyping(Ci.prplIConvIM.NOT_TYPING);</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+    conv.updateTyping(Ci.prplIConvIM.NOT_TYPING, conv.name);</span>
<a href="#l4.14"></a><span id="l4.14">   },</span>
<a href="#l4.15"></a><span id="l4.15"> </span>
<a href="#l4.16"></a><span id="l4.16">   receiveConferenceMessage: function(aName, aRoom, aMessage) {</span>
<a href="#l4.17"></a><span id="l4.17">     if (!this._conferences.has(aRoom))</span>
<a href="#l4.18"></a><span id="l4.18">       return;</span>
<a href="#l4.19"></a><span id="l4.19"> </span>
<a href="#l4.20"></a><span id="l4.20">     this._conferences.get(aRoom).writeMessage(aName,</span>
<a href="#l4.21"></a><span id="l4.21">                                               this.decodeMessage(aMessage),</span>
<a href="#l4.22"></a><span id="l4.22">                                               {incoming: true});</span>
<a href="#l4.23"></a><span id="l4.23">   },</span>
<a href="#l4.24"></a><span id="l4.24"> </span>
<a href="#l4.25"></a><span id="l4.25">   receiveTypingNotification: function(aName, aIsTyping) {</span>
<a href="#l4.26"></a><span id="l4.26">     if (!this._conversations.has(aName))</span>
<a href="#l4.27"></a><span id="l4.27">       return;</span>
<a href="#l4.28"></a><span id="l4.28"> </span>
<a href="#l4.29"></a><span id="l4.29" class="difflineplus">+    let conv = this._conversations.get(aName);</span>
<a href="#l4.30"></a><span id="l4.30">     if (aIsTyping)</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineminus">-      this._conversations.get(aName).updateTyping(Ci.prplIConvIM.TYPING);</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineplus">+      conv.updateTyping(Ci.prplIConvIM.TYPING, conv.name);</span>
<a href="#l4.33"></a><span id="l4.33">     else</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineminus">-      this._conversations.get(aName).updateTyping(Ci.prplIConvIM.NOT_TYPING);</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineplus">+      conv.updateTyping(Ci.prplIConvIM.NOT_TYPING, conv.name);</span>
<a href="#l4.36"></a><span id="l4.36">   },</span>
<a href="#l4.37"></a><span id="l4.37"> </span>
<a href="#l4.38"></a><span id="l4.38">   encodeMessage: function(aMessage) {</span>
<a href="#l4.39"></a><span id="l4.39">     // Try to perform a convertion from JavaScript UTF-16 into the charset</span>
<a href="#l4.40"></a><span id="l4.40">     // specified in the options. If the conversion fails, just leave</span>
<a href="#l4.41"></a><span id="l4.41">     // the message as it is.</span>
<a href="#l4.42"></a><span id="l4.42">     let encodedMsg;</span>
<a href="#l4.43"></a><span id="l4.43">     try {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/im/content/conversation.xml</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/im/content/conversation.xml</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -1646,29 +1646,35 @@</span>
<a href="#l5.4"></a><span id="l5.4">           if (this._statusText.length)</span>
<a href="#l5.5"></a><span id="l5.5">             convStatusContainer.removeAttribute(&quot;hidden&quot;);</span>
<a href="#l5.6"></a><span id="l5.6">           else</span>
<a href="#l5.7"></a><span id="l5.7">             convStatusContainer.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l5.8"></a><span id="l5.8">         ]]&gt;</span>
<a href="#l5.9"></a><span id="l5.9">         &lt;/body&gt;</span>
<a href="#l5.10"></a><span id="l5.10">       &lt;/method&gt;</span>
<a href="#l5.11"></a><span id="l5.11"> </span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+      &lt;field name=&quot;_currentTypingName&quot;&gt;&quot;&quot;&lt;/field&gt;</span>
<a href="#l5.13"></a><span id="l5.13">       &lt;method name=&quot;updateTyping&quot;&gt;</span>
<a href="#l5.14"></a><span id="l5.14">         &lt;parameter name=&quot;aForceUpdate&quot;/&gt;</span>
<a href="#l5.15"></a><span id="l5.15">         &lt;body&gt;</span>
<a href="#l5.16"></a><span id="l5.16">         &lt;![CDATA[</span>
<a href="#l5.17"></a><span id="l5.17">           let typingState = this._conv.typingState;</span>
<a href="#l5.18"></a><span id="l5.18">           if (typingState == this.typingState &amp;&amp; !aForceUpdate)</span>
<a href="#l5.19"></a><span id="l5.19">             return;</span>
<a href="#l5.20"></a><span id="l5.20"> </span>
<a href="#l5.21"></a><span id="l5.21">           this.tab.removeAttribute(&quot;typing&quot;);</span>
<a href="#l5.22"></a><span id="l5.22">           this.tab.removeAttribute(&quot;typed&quot;);</span>
<a href="#l5.23"></a><span id="l5.23"> </span>
<a href="#l5.24"></a><span id="l5.24">           let typingText = &quot;&quot;;</span>
<a href="#l5.25"></a><span id="l5.25" class="difflineminus">-          var name = this._conv.title.replace(/^([a-zA-Z0-9.]+)[@\s].*/, &quot;$1&quot;);</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineplus">+          let name = this._currentTypingName;</span>
<a href="#l5.27"></a><span id="l5.27" class="difflineplus">+          if (!this._currentTypingName) {</span>
<a href="#l5.28"></a><span id="l5.28" class="difflineplus">+            // This regex is intended to get a shortened name for prpls that</span>
<a href="#l5.29"></a><span id="l5.29" class="difflineplus">+            // don't provide a _currentTypingName.</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineplus">+            name = this._conv.title.replace(/^([a-zA-Z0-9.]+)[@\s].*/, &quot;$1&quot;);</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineplus">+          }</span>
<a href="#l5.32"></a><span id="l5.32">           if (typingState == Ci.prplIConvIM.TYPING) {</span>
<a href="#l5.33"></a><span id="l5.33">             this.tab.setAttribute(&quot;typing&quot;, &quot;true&quot;);</span>
<a href="#l5.34"></a><span id="l5.34">             typingText = this.bundle.formatStringFromName(&quot;isTyping&quot;, [name], 1);</span>
<a href="#l5.35"></a><span id="l5.35">           }</span>
<a href="#l5.36"></a><span id="l5.36">           else if (typingState == Ci.prplIConvIM.TYPED) {</span>
<a href="#l5.37"></a><span id="l5.37">             this.tab.setAttribute(&quot;typed&quot;, &quot;true&quot;);</span>
<a href="#l5.38"></a><span id="l5.38">             typingText =</span>
<a href="#l5.39"></a><span id="l5.39">               this.bundle.formatStringFromName(&quot;hasStoppedTyping&quot;, [name], 1);</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineat">@@ -1865,16 +1871,17 @@</span>
<a href="#l5.41"></a><span id="l5.41"> </span>
<a href="#l5.42"></a><span id="l5.42">           switch(aTopic) {</span>
<a href="#l5.43"></a><span id="l5.43">           case &quot;new-text&quot;:</span>
<a href="#l5.44"></a><span id="l5.44">             if (this.loaded)</span>
<a href="#l5.45"></a><span id="l5.45">               this.addMsg(aSubject);</span>
<a href="#l5.46"></a><span id="l5.46">             break;</span>
<a href="#l5.47"></a><span id="l5.47"> </span>
<a href="#l5.48"></a><span id="l5.48">           case &quot;update-typing&quot;:</span>
<a href="#l5.49"></a><span id="l5.49" class="difflineplus">+            this._currentTypingName = aData;</span>
<a href="#l5.50"></a><span id="l5.50">             this.updateTyping();</span>
<a href="#l5.51"></a><span id="l5.51">             break;</span>
<a href="#l5.52"></a><span id="l5.52"> </span>
<a href="#l5.53"></a><span id="l5.53">           case &quot;status-text-changed&quot;:</span>
<a href="#l5.54"></a><span id="l5.54">             this._statusText = aData;</span>
<a href="#l5.55"></a><span id="l5.55">             this.displayStatusText();</span>
<a href="#l5.56"></a><span id="l5.56">             break;</span>
<a href="#l5.57"></a><span id="l5.57"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mail/components/im/content/imconversation.xml</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mail/components/im/content/imconversation.xml</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -1264,25 +1264,28 @@</span>
<a href="#l6.4"></a><span id="l6.4">            this.tab.removeAttribute(&quot;unread&quot;);</span>
<a href="#l6.5"></a><span id="l6.5">            this.tab.removeAttribute(&quot;attention&quot;);</span>
<a href="#l6.6"></a><span id="l6.6">          }</span>
<a href="#l6.7"></a><span id="l6.7">          this._conv.markAsRead();</span>
<a href="#l6.8"></a><span id="l6.8">        ]]&gt;</span>
<a href="#l6.9"></a><span id="l6.9">        &lt;/body&gt;</span>
<a href="#l6.10"></a><span id="l6.10">      &lt;/method&gt;</span>
<a href="#l6.11"></a><span id="l6.11"> </span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+     &lt;field name=&quot;_currentTypingName&quot;&gt;&quot;&quot;&lt;/field&gt;</span>
<a href="#l6.13"></a><span id="l6.13">      &lt;method name=&quot;updateTyping&quot;&gt;</span>
<a href="#l6.14"></a><span id="l6.14">        &lt;body&gt;</span>
<a href="#l6.15"></a><span id="l6.15">        &lt;![CDATA[</span>
<a href="#l6.16"></a><span id="l6.16">           let typingState = this._conv.typingState;</span>
<a href="#l6.17"></a><span id="l6.17">           let cti = document.getElementById(&quot;conv-top-info&quot;);</span>
<a href="#l6.18"></a><span id="l6.18">           cti.removeAttribute(&quot;typing&quot;);</span>
<a href="#l6.19"></a><span id="l6.19">           cti.removeAttribute(&quot;typed&quot;);</span>
<a href="#l6.20"></a><span id="l6.20"> </span>
<a href="#l6.21"></a><span id="l6.21" class="difflineminus">-          let name = this._conv.title;//.replace(/^([a-zA-Z0-9.]+)[@\s].*/, &quot;$1&quot;);</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineplus">+          let name = this._currentTypingName;</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineplus">+          if (!this._currentTypingName)</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineplus">+            name = this._conv.title;//.replace(/^([a-zA-Z0-9.]+)[@\s].*/, &quot;$1&quot;);</span>
<a href="#l6.25"></a><span id="l6.25">           if (typingState == Ci.prplIConvIM.TYPING) {</span>
<a href="#l6.26"></a><span id="l6.26">             cti.setAttribute(&quot;typing&quot;, &quot;true&quot;);</span>
<a href="#l6.27"></a><span id="l6.27">             let typingMsg = this.bundle.formatStringFromName(&quot;chat.contactIsTyping&quot;,</span>
<a href="#l6.28"></a><span id="l6.28">                                                              [name], 1);</span>
<a href="#l6.29"></a><span id="l6.29">             cti.setAttribute(&quot;statusTypeTooltiptext&quot;, typingMsg);</span>
<a href="#l6.30"></a><span id="l6.30">             cti.setAttribute(&quot;statusTooltiptext&quot;, typingMsg);</span>
<a href="#l6.31"></a><span id="l6.31">             cti.setAttribute(&quot;statusMessage&quot;,</span>
<a href="#l6.32"></a><span id="l6.32">                              this.bundle.GetStringFromName(&quot;chat.isTyping&quot;));</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineat">@@ -1476,21 +1479,27 @@</span>
<a href="#l6.34"></a><span id="l6.34">          case &quot;target-prpl-conversation-changed&quot;:</span>
<a href="#l6.35"></a><span id="l6.35">          case &quot;update-conv-title&quot;:</span>
<a href="#l6.36"></a><span id="l6.36">            if (this.tab)</span>
<a href="#l6.37"></a><span id="l6.37">                this.tab.setAttribute(&quot;label&quot;, this.conv.title);</span>
<a href="#l6.38"></a><span id="l6.38">            // Update the status too.</span>
<a href="#l6.39"></a><span id="l6.39">          case &quot;update-buddy-status&quot;:</span>
<a href="#l6.40"></a><span id="l6.40">          case &quot;update-buddy-icon&quot;:</span>
<a href="#l6.41"></a><span id="l6.41">          case &quot;update-conv-chatleft&quot;:</span>
<a href="#l6.42"></a><span id="l6.42" class="difflineminus">-         case &quot;update-typing&quot;:</span>
<a href="#l6.43"></a><span id="l6.43">            if (this.tab &amp;&amp; this._isConversationSelected)</span>
<a href="#l6.44"></a><span id="l6.44">              this.updateConvStatus();</span>
<a href="#l6.45"></a><span id="l6.45">            break;</span>
<a href="#l6.46"></a><span id="l6.46"> </span>
<a href="#l6.47"></a><span id="l6.47" class="difflineplus">+         case &quot;update-typing&quot;:</span>
<a href="#l6.48"></a><span id="l6.48" class="difflineplus">+           if (this.tab &amp;&amp; this._isConversationSelected) {</span>
<a href="#l6.49"></a><span id="l6.49" class="difflineplus">+             this._currentTypingName = aData;</span>
<a href="#l6.50"></a><span id="l6.50" class="difflineplus">+             this.updateConvStatus();</span>
<a href="#l6.51"></a><span id="l6.51" class="difflineplus">+           }</span>
<a href="#l6.52"></a><span id="l6.52" class="difflineplus">+           break;</span>
<a href="#l6.53"></a><span id="l6.53" class="difflineplus">+</span>
<a href="#l6.54"></a><span id="l6.54">          case &quot;chat-buddy-add&quot;:</span>
<a href="#l6.55"></a><span id="l6.55">            if (!this._isConversationSelected)</span>
<a href="#l6.56"></a><span id="l6.56">              break;</span>
<a href="#l6.57"></a><span id="l6.57">            aSubject.QueryInterface(Ci.nsISimpleEnumerator);</span>
<a href="#l6.58"></a><span id="l6.58">            while (aSubject.hasMoreElements())</span>
<a href="#l6.59"></a><span id="l6.59">              this.addBuddy(aSubject.getNext());</span>
<a href="#l6.60"></a><span id="l6.60">            this.updateParticipantCount();</span>
<a href="#l6.61"></a><span id="l6.61">            break;</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

