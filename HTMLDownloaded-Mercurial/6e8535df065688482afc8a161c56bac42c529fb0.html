<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 20587:6e8535df065688482afc8a161c56bac42c529fb0</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 6e8535df065688482afc8a161c56bac42c529fb0" />
<meta property="og:url" content="/comm-central/rev/6e8535df065688482afc8a161c56bac42c529fb0" />
<meta property="og:description" content="Bug 558528 - Use larger file I/O buffer size in some file operations by MailNews. r=rkent" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 6e8535df065688482afc8a161c56bac42c529fb0 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/6e8535df065688482afc8a161c56bac42c529fb0">shortlog</a> |
<a href="/comm-central/log/6e8535df065688482afc8a161c56bac42c529fb0">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/6e8535df065688482afc8a161c56bac42c529fb0">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/6e8535df065688482afc8a161c56bac42c529fb0">files</a> |
changeset |
<a href="/comm-central/raw-rev/6e8535df065688482afc8a161c56bac42c529fb0">raw</a>  | <a href="/comm-central/archive/6e8535df065688482afc8a161c56bac42c529fb0.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=558528">Bug 558528</a> - Use larger file I/O buffer size in some file operations by MailNews. r=rkent
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#97;&#99;&#101;&#109;&#97;&#110;&#32;&#60;&#97;&#99;&#101;&#108;&#105;&#115;&#116;&#115;&#64;&#97;&#116;&#108;&#97;&#115;&#46;&#115;&#107;&#62;</td></tr>
<tr><td></td><td class="date age">Thu, 20 Oct 2016 00:34:40 +0200</td></tr>

<tr>
 <td>changeset 20587</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/6e8535df065688482afc8a161c56bac42c529fb0">6e8535df065688482afc8a161c56bac42c529fb0</a></td>
</tr>



<tr>
<td>parent 20586</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/2bf4d3a7b660b4014c2b21258c502a4fcf86eb52">2bf4d3a7b660b4014c2b21258c502a4fcf86eb52</a>
</td>
</tr>

<tr>
<td>child 20588</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/67de54418efbb0929b25c68525c8a67ed621bda2">67de54418efbb0929b25c68525c8a67ed621bda2</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=6e8535df065688482afc8a161c56bac42c529fb0">12436</a></td></tr>
<tr><td>push user</td><td>acelists@atlas.sk</td></tr>
<tr><td>push date</td><td class="date age">Wed, 19 Oct 2016 22:35:06 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@6e8535df0656 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=6e8535df065688482afc8a161c56bac42c529fb0">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=6e8535df065688482afc8a161c56bac42c529fb0&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=6e8535df065688482afc8a161c56bac42c529fb0&newProject=comm-central&newRevision=2bf4d3a7b660b4014c2b21258c502a4fcf86eb52&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=6e8535df065688482afc8a161c56bac42c529fb0&newProject=comm-central&newRevision=2bf4d3a7b660b4014c2b21258c502a4fcf86eb52&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=6e8535df065688482afc8a161c56bac42c529fb0&newProject=comm-central&newRevision=2bf4d3a7b660b4014c2b21258c502a4fcf86eb52&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28rkent%29&revcount=50">rkent</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=558528">558528</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=558528">Bug 558528</a> - Use larger file I/O buffer size in some file operations by MailNews. r=rkent</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/base/search/src/nsMsgFilterList.cpp">mailnews/base/search/src/nsMsgFilterList.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/base/search/src/nsMsgFilterList.cpp">file</a> |
<a href="/comm-central/annotate/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/base/search/src/nsMsgFilterList.cpp">annotate</a> |
<a href="/comm-central/diff/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/base/search/src/nsMsgFilterList.cpp">diff</a> |
<a href="/comm-central/comparison/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/base/search/src/nsMsgFilterList.cpp">comparison</a> |
<a href="/comm-central/log/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/base/search/src/nsMsgFilterList.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/base/src/nsMessenger.cpp">mailnews/base/src/nsMessenger.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/base/src/nsMessenger.cpp">file</a> |
<a href="/comm-central/annotate/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/base/src/nsMessenger.cpp">annotate</a> |
<a href="/comm-central/diff/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/base/src/nsMessenger.cpp">diff</a> |
<a href="/comm-central/comparison/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/base/src/nsMessenger.cpp">comparison</a> |
<a href="/comm-central/log/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/base/src/nsMessenger.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/base/util/nsMsgMailNewsUrl.cpp">mailnews/base/util/nsMsgMailNewsUrl.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/base/util/nsMsgMailNewsUrl.cpp">file</a> |
<a href="/comm-central/annotate/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/base/util/nsMsgMailNewsUrl.cpp">annotate</a> |
<a href="/comm-central/diff/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/base/util/nsMsgMailNewsUrl.cpp">diff</a> |
<a href="/comm-central/comparison/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/base/util/nsMsgMailNewsUrl.cpp">comparison</a> |
<a href="/comm-central/log/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/base/util/nsMsgMailNewsUrl.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/base/util/nsMsgProtocol.cpp">mailnews/base/util/nsMsgProtocol.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/base/util/nsMsgProtocol.cpp">file</a> |
<a href="/comm-central/annotate/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/base/util/nsMsgProtocol.cpp">annotate</a> |
<a href="/comm-central/diff/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/base/util/nsMsgProtocol.cpp">diff</a> |
<a href="/comm-central/comparison/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/base/util/nsMsgProtocol.cpp">comparison</a> |
<a href="/comm-central/log/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/base/util/nsMsgProtocol.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/base/util/nsMsgUtils.cpp">mailnews/base/util/nsMsgUtils.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/base/util/nsMsgUtils.cpp">file</a> |
<a href="/comm-central/annotate/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/base/util/nsMsgUtils.cpp">annotate</a> |
<a href="/comm-central/diff/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/base/util/nsMsgUtils.cpp">diff</a> |
<a href="/comm-central/comparison/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/base/util/nsMsgUtils.cpp">comparison</a> |
<a href="/comm-central/log/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/base/util/nsMsgUtils.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/base/util/nsMsgUtils.h">mailnews/base/util/nsMsgUtils.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/base/util/nsMsgUtils.h">file</a> |
<a href="/comm-central/annotate/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/base/util/nsMsgUtils.h">annotate</a> |
<a href="/comm-central/diff/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/base/util/nsMsgUtils.h">diff</a> |
<a href="/comm-central/comparison/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/base/util/nsMsgUtils.h">comparison</a> |
<a href="/comm-central/log/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/base/util/nsMsgUtils.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/compose/src/nsMsgAttachmentHandler.cpp">mailnews/compose/src/nsMsgAttachmentHandler.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/compose/src/nsMsgAttachmentHandler.cpp">file</a> |
<a href="/comm-central/annotate/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/compose/src/nsMsgAttachmentHandler.cpp">annotate</a> |
<a href="/comm-central/diff/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/compose/src/nsMsgAttachmentHandler.cpp">diff</a> |
<a href="/comm-central/comparison/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/compose/src/nsMsgAttachmentHandler.cpp">comparison</a> |
<a href="/comm-central/log/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/compose/src/nsMsgAttachmentHandler.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/compose/src/nsMsgSend.cpp">mailnews/compose/src/nsMsgSend.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/compose/src/nsMsgSend.cpp">file</a> |
<a href="/comm-central/annotate/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/compose/src/nsMsgSend.cpp">annotate</a> |
<a href="/comm-central/diff/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/compose/src/nsMsgSend.cpp">diff</a> |
<a href="/comm-central/comparison/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/compose/src/nsMsgSend.cpp">comparison</a> |
<a href="/comm-central/log/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/compose/src/nsMsgSend.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/compose/src/nsMsgSend.h">mailnews/compose/src/nsMsgSend.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/compose/src/nsMsgSend.h">file</a> |
<a href="/comm-central/annotate/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/compose/src/nsMsgSend.h">annotate</a> |
<a href="/comm-central/diff/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/compose/src/nsMsgSend.h">diff</a> |
<a href="/comm-central/comparison/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/compose/src/nsMsgSend.h">comparison</a> |
<a href="/comm-central/log/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/compose/src/nsMsgSend.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/extensions/mdn/src/nsMsgMdnGenerator.cpp">mailnews/extensions/mdn/src/nsMsgMdnGenerator.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/extensions/mdn/src/nsMsgMdnGenerator.cpp">file</a> |
<a href="/comm-central/annotate/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/extensions/mdn/src/nsMsgMdnGenerator.cpp">annotate</a> |
<a href="/comm-central/diff/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/extensions/mdn/src/nsMsgMdnGenerator.cpp">diff</a> |
<a href="/comm-central/comparison/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/extensions/mdn/src/nsMsgMdnGenerator.cpp">comparison</a> |
<a href="/comm-central/log/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/extensions/mdn/src/nsMsgMdnGenerator.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/imap/src/nsImapMailFolder.cpp">mailnews/imap/src/nsImapMailFolder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/imap/src/nsImapMailFolder.cpp">file</a> |
<a href="/comm-central/annotate/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/imap/src/nsImapMailFolder.cpp">annotate</a> |
<a href="/comm-central/diff/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/imap/src/nsImapMailFolder.cpp">diff</a> |
<a href="/comm-central/comparison/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/imap/src/nsImapMailFolder.cpp">comparison</a> |
<a href="/comm-central/log/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/imap/src/nsImapMailFolder.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/imap/src/nsImapOfflineSync.cpp">mailnews/imap/src/nsImapOfflineSync.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/imap/src/nsImapOfflineSync.cpp">file</a> |
<a href="/comm-central/annotate/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/imap/src/nsImapOfflineSync.cpp">annotate</a> |
<a href="/comm-central/diff/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/imap/src/nsImapOfflineSync.cpp">diff</a> |
<a href="/comm-central/comparison/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/imap/src/nsImapOfflineSync.cpp">comparison</a> |
<a href="/comm-central/log/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/imap/src/nsImapOfflineSync.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/imap/src/nsImapService.cpp">mailnews/imap/src/nsImapService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/imap/src/nsImapService.cpp">file</a> |
<a href="/comm-central/annotate/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/imap/src/nsImapService.cpp">annotate</a> |
<a href="/comm-central/diff/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/imap/src/nsImapService.cpp">diff</a> |
<a href="/comm-central/comparison/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/imap/src/nsImapService.cpp">comparison</a> |
<a href="/comm-central/log/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/imap/src/nsImapService.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/import/becky/src/nsBeckyImport.cpp">mailnews/import/becky/src/nsBeckyImport.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/import/becky/src/nsBeckyImport.cpp">file</a> |
<a href="/comm-central/annotate/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/import/becky/src/nsBeckyImport.cpp">annotate</a> |
<a href="/comm-central/diff/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/import/becky/src/nsBeckyImport.cpp">diff</a> |
<a href="/comm-central/comparison/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/import/becky/src/nsBeckyImport.cpp">comparison</a> |
<a href="/comm-central/log/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/import/becky/src/nsBeckyImport.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/import/becky/src/nsBeckyMail.cpp">mailnews/import/becky/src/nsBeckyMail.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/import/becky/src/nsBeckyMail.cpp">file</a> |
<a href="/comm-central/annotate/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/import/becky/src/nsBeckyMail.cpp">annotate</a> |
<a href="/comm-central/diff/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/import/becky/src/nsBeckyMail.cpp">diff</a> |
<a href="/comm-central/comparison/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/import/becky/src/nsBeckyMail.cpp">comparison</a> |
<a href="/comm-central/log/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/import/becky/src/nsBeckyMail.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/import/outlook/src/nsOutlookCompose.cpp">mailnews/import/outlook/src/nsOutlookCompose.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/import/outlook/src/nsOutlookCompose.cpp">file</a> |
<a href="/comm-central/annotate/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/import/outlook/src/nsOutlookCompose.cpp">annotate</a> |
<a href="/comm-central/diff/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/import/outlook/src/nsOutlookCompose.cpp">diff</a> |
<a href="/comm-central/comparison/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/import/outlook/src/nsOutlookCompose.cpp">comparison</a> |
<a href="/comm-central/log/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/import/outlook/src/nsOutlookCompose.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/import/outlook/src/nsOutlookCompose.h">mailnews/import/outlook/src/nsOutlookCompose.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/import/outlook/src/nsOutlookCompose.h">file</a> |
<a href="/comm-central/annotate/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/import/outlook/src/nsOutlookCompose.h">annotate</a> |
<a href="/comm-central/diff/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/import/outlook/src/nsOutlookCompose.h">diff</a> |
<a href="/comm-central/comparison/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/import/outlook/src/nsOutlookCompose.h">comparison</a> |
<a href="/comm-central/log/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/import/outlook/src/nsOutlookCompose.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/local/src/nsMsgMaildirStore.cpp">mailnews/local/src/nsMsgMaildirStore.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/local/src/nsMsgMaildirStore.cpp">file</a> |
<a href="/comm-central/annotate/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/local/src/nsMsgMaildirStore.cpp">annotate</a> |
<a href="/comm-central/diff/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/local/src/nsMsgMaildirStore.cpp">diff</a> |
<a href="/comm-central/comparison/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/local/src/nsMsgMaildirStore.cpp">comparison</a> |
<a href="/comm-central/log/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/local/src/nsMsgMaildirStore.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/local/src/nsParseMailbox.cpp">mailnews/local/src/nsParseMailbox.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/local/src/nsParseMailbox.cpp">file</a> |
<a href="/comm-central/annotate/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/local/src/nsParseMailbox.cpp">annotate</a> |
<a href="/comm-central/diff/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/local/src/nsParseMailbox.cpp">diff</a> |
<a href="/comm-central/comparison/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/local/src/nsParseMailbox.cpp">comparison</a> |
<a href="/comm-central/log/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/local/src/nsParseMailbox.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/mime/src/mimemrel.cpp">mailnews/mime/src/mimemrel.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/mime/src/mimemrel.cpp">file</a> |
<a href="/comm-central/annotate/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/mime/src/mimemrel.cpp">annotate</a> |
<a href="/comm-central/diff/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/mime/src/mimemrel.cpp">diff</a> |
<a href="/comm-central/comparison/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/mime/src/mimemrel.cpp">comparison</a> |
<a href="/comm-central/log/6e8535df065688482afc8a161c56bac42c529fb0/mailnews/mime/src/mimemrel.cpp">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/base/search/src/nsMsgFilterList.cpp</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/base/search/src/nsMsgFilterList.cpp</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -497,17 +497,17 @@ nsresult nsMsgFilterList::LoadValue(nsCS</span>
<a href="#l1.4"></a><span id="l1.4"> }</span>
<a href="#l1.5"></a><span id="l1.5"> </span>
<a href="#l1.6"></a><span id="l1.6"> nsresult nsMsgFilterList::LoadTextFilters(nsIInputStream *aStream)</span>
<a href="#l1.7"></a><span id="l1.7"> {</span>
<a href="#l1.8"></a><span id="l1.8">   nsresult  err = NS_OK;</span>
<a href="#l1.9"></a><span id="l1.9">   uint64_t bytesAvailable;</span>
<a href="#l1.10"></a><span id="l1.10"> </span>
<a href="#l1.11"></a><span id="l1.11">   nsCOMPtr&lt;nsIInputStream&gt; bufStream;</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-  err = NS_NewBufferedInputStream(getter_AddRefs(bufStream), aStream, 10240);</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+  err = NS_NewBufferedInputStream(getter_AddRefs(bufStream), aStream, FILE_IO_BUFFER_SIZE);</span>
<a href="#l1.14"></a><span id="l1.14">   NS_ENSURE_SUCCESS(err, err);</span>
<a href="#l1.15"></a><span id="l1.15"> </span>
<a href="#l1.16"></a><span id="l1.16">   nsMsgFilterFileAttribValue attrib;</span>
<a href="#l1.17"></a><span id="l1.17">   nsCOMPtr&lt;nsIMsgRuleAction&gt; currentFilterAction;</span>
<a href="#l1.18"></a><span id="l1.18">   // We'd really like to move lot's of these into the objects that they refer to.</span>
<a href="#l1.19"></a><span id="l1.19">   do</span>
<a href="#l1.20"></a><span id="l1.20">   {</span>
<a href="#l1.21"></a><span id="l1.21">     nsAutoCString value;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/base/src/nsMessenger.cpp</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/base/src/nsMessenger.cpp</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -93,17 +93,16 @@</span>
<a href="#l2.4"></a><span id="l2.4"> #include &quot;nsIExternalProtocolService.h&quot;</span>
<a href="#l2.5"></a><span id="l2.5"> #include &quot;nsIMIMEService.h&quot;</span>
<a href="#l2.6"></a><span id="l2.6"> #include &quot;nsITransfer.h&quot;</span>
<a href="#l2.7"></a><span id="l2.7"> </span>
<a href="#l2.8"></a><span id="l2.8"> #include &quot;nsILinkHandler.h&quot;</span>
<a href="#l2.9"></a><span id="l2.9"> </span>
<a href="#l2.10"></a><span id="l2.10"> static NS_DEFINE_CID(kRDFServiceCID,  NS_RDFSERVICE_CID);</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-#define FOUR_K 4096</span>
<a href="#l2.13"></a><span id="l2.13"> #define MESSENGER_SAVE_DIR_PREF_NAME &quot;messenger.save.dir&quot;</span>
<a href="#l2.14"></a><span id="l2.14"> #define MIMETYPE_DELETED    &quot;text/x-moz-deleted&quot;</span>
<a href="#l2.15"></a><span id="l2.15"> #define ATTACHMENT_PERMISSION 00664</span>
<a href="#l2.16"></a><span id="l2.16"> </span>
<a href="#l2.17"></a><span id="l2.17"> //</span>
<a href="#l2.18"></a><span id="l2.18"> // Convert an nsString buffer to plain text...</span>
<a href="#l2.19"></a><span id="l2.19"> //</span>
<a href="#l2.20"></a><span id="l2.20"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineat">@@ -145,17 +144,17 @@ public:</span>
<a href="#l2.22"></a><span id="l2.22">   NS_DECL_NSIURLLISTENER</span>
<a href="#l2.23"></a><span id="l2.23">   NS_DECL_NSIMSGCOPYSERVICELISTENER</span>
<a href="#l2.24"></a><span id="l2.24">   NS_DECL_NSISTREAMLISTENER</span>
<a href="#l2.25"></a><span id="l2.25">   NS_DECL_NSIREQUESTOBSERVER</span>
<a href="#l2.26"></a><span id="l2.26">   NS_DECL_NSICANCELABLE</span>
<a href="#l2.27"></a><span id="l2.27"> </span>
<a href="#l2.28"></a><span id="l2.28">   nsCOMPtr&lt;nsIFile&gt; m_file;</span>
<a href="#l2.29"></a><span id="l2.29">   nsCOMPtr&lt;nsIOutputStream&gt; m_outputStream;</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineminus">-  char m_dataBuffer[FOUR_K];</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineplus">+  char m_dataBuffer[FILE_IO_BUFFER_SIZE];</span>
<a href="#l2.32"></a><span id="l2.32">   nsCOMPtr&lt;nsIChannel&gt; m_channel;</span>
<a href="#l2.33"></a><span id="l2.33">   nsCString m_templateUri;</span>
<a href="#l2.34"></a><span id="l2.34">   nsMessenger *m_messenger; // not ref counted</span>
<a href="#l2.35"></a><span id="l2.35">   nsSaveAllAttachmentsState *m_saveAllAttachmentsState;</span>
<a href="#l2.36"></a><span id="l2.36"> </span>
<a href="#l2.37"></a><span id="l2.37">   // rhp: For character set handling</span>
<a href="#l2.38"></a><span id="l2.38">   bool          m_doCharsetConversion;</span>
<a href="#l2.39"></a><span id="l2.39">   nsString      m_charset;</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineat">@@ -1965,17 +1964,17 @@ nsSaveMsgListener::OnDataAvailable(nsIRe</span>
<a href="#l2.41"></a><span id="l2.41">   </span>
<a href="#l2.42"></a><span id="l2.42">   if (!mInitialized)</span>
<a href="#l2.43"></a><span id="l2.43">     InitializeDownload(request);</span>
<a href="#l2.44"></a><span id="l2.44"> </span>
<a href="#l2.45"></a><span id="l2.45">   if (m_outputStream)</span>
<a href="#l2.46"></a><span id="l2.46">   {</span>
<a href="#l2.47"></a><span id="l2.47">     mProgress += count;</span>
<a href="#l2.48"></a><span id="l2.48">     uint64_t available;</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineminus">-    uint32_t readCount, maxReadCount = FOUR_K;</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineplus">+    uint32_t readCount, maxReadCount = sizeof(m_dataBuffer);</span>
<a href="#l2.51"></a><span id="l2.51">     uint32_t writeCount;</span>
<a href="#l2.52"></a><span id="l2.52">     rv = inStream-&gt;Available(&amp;available);</span>
<a href="#l2.53"></a><span id="l2.53">     while (NS_SUCCEEDED(rv) &amp;&amp; available)</span>
<a href="#l2.54"></a><span id="l2.54">     {</span>
<a href="#l2.55"></a><span id="l2.55">       if (maxReadCount &gt; available)</span>
<a href="#l2.56"></a><span id="l2.56">         maxReadCount = (uint32_t)available;</span>
<a href="#l2.57"></a><span id="l2.57">       rv = inStream-&gt;Read(m_dataBuffer, maxReadCount, &amp;readCount);</span>
<a href="#l2.58"></a><span id="l2.58"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/base/util/nsMsgMailNewsUrl.cpp</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgMailNewsUrl.cpp</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -728,17 +728,17 @@ NS_IMETHODIMP nsMsgMailNewsUrl::SetMimeH</span>
<a href="#l3.4"></a><span id="l3.4"> NS_IMETHODIMP nsMsgMailNewsUrl::LoadURI(nsIDocShell* docShell,</span>
<a href="#l3.5"></a><span id="l3.5">                                         nsIDocShellLoadInfo* loadInfo,</span>
<a href="#l3.6"></a><span id="l3.6">                                         uint32_t aLoadFlags)</span>
<a href="#l3.7"></a><span id="l3.7"> {</span>
<a href="#l3.8"></a><span id="l3.8">   NS_ENSURE_ARG_POINTER(docShell);</span>
<a href="#l3.9"></a><span id="l3.9">   return docShell-&gt;LoadURI(this, loadInfo, aLoadFlags, false);</span>
<a href="#l3.10"></a><span id="l3.10"> }</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-#define SAVE_BUF_SIZE 8192</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+#define SAVE_BUF_SIZE FILE_IO_BUFFER_SIZE</span>
<a href="#l3.14"></a><span id="l3.14"> class nsMsgSaveAsListener : public nsIStreamListener</span>
<a href="#l3.15"></a><span id="l3.15"> {</span>
<a href="#l3.16"></a><span id="l3.16"> public:</span>
<a href="#l3.17"></a><span id="l3.17">   NS_DECL_ISUPPORTS</span>
<a href="#l3.18"></a><span id="l3.18">   NS_DECL_NSIREQUESTOBSERVER</span>
<a href="#l3.19"></a><span id="l3.19">   NS_DECL_NSISTREAMLISTENER</span>
<a href="#l3.20"></a><span id="l3.20"> </span>
<a href="#l3.21"></a><span id="l3.21">   nsMsgSaveAsListener(nsIFile *aFile, bool addDummyEnvelope);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/base/util/nsMsgProtocol.cpp</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgProtocol.cpp</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -1039,17 +1039,17 @@ public:</span>
<a href="#l4.4"></a><span id="l4.4">           return NS_OK;</span>
<a href="#l4.5"></a><span id="l4.5">         }</span>
<a href="#l4.6"></a><span id="l4.6">         protInst-&gt;mSuspendedWrite = false;</span>
<a href="#l4.7"></a><span id="l4.7"> </span>
<a href="#l4.8"></a><span id="l4.8">         uint32_t bytesWritten;</span>
<a href="#l4.9"></a><span id="l4.9"> </span>
<a href="#l4.10"></a><span id="l4.10">         if (avail)</span>
<a href="#l4.11"></a><span id="l4.11">         {</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-          rv = aOutStream-&gt;WriteFrom(mInStream, std::min(avail, uint64_t(4096)), &amp;bytesWritten);</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+          rv = aOutStream-&gt;WriteFrom(mInStream, std::min(avail, uint64_t(FILE_IO_BUFFER_SIZE)), &amp;bytesWritten);</span>
<a href="#l4.14"></a><span id="l4.14">           // if were full at the time, the input stream may be backed up and we need to read any remains from the last ODA call</span>
<a href="#l4.15"></a><span id="l4.15">           // before we'll get more ODA calls</span>
<a href="#l4.16"></a><span id="l4.16">           if (protInst-&gt;mSuspendedRead)</span>
<a href="#l4.17"></a><span id="l4.17">             protInst-&gt;UnblockPostReader();</span>
<a href="#l4.18"></a><span id="l4.18">         }</span>
<a href="#l4.19"></a><span id="l4.19">         else</span>
<a href="#l4.20"></a><span id="l4.20">         {</span>
<a href="#l4.21"></a><span id="l4.21">           rv = aOutStream-&gt;Write(protInst-&gt;mAsyncBuffer.get(),</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/base/util/nsMsgUtils.cpp</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgUtils.cpp</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -116,18 +116,16 @@ using namespace mozilla::net;</span>
<a href="#l5.4"></a><span id="l5.4"> static NS_DEFINE_CID(kImapUrlCID, NS_IMAPURL_CID);</span>
<a href="#l5.5"></a><span id="l5.5"> static NS_DEFINE_CID(kCMailboxUrl, NS_MAILBOXURL_CID);</span>
<a href="#l5.6"></a><span id="l5.6"> static NS_DEFINE_CID(kCNntpUrlCID, NS_NNTPURL_CID);</span>
<a href="#l5.7"></a><span id="l5.7"> </span>
<a href="#l5.8"></a><span id="l5.8"> #define ILLEGAL_FOLDER_CHARS &quot;;#&quot;</span>
<a href="#l5.9"></a><span id="l5.9"> #define ILLEGAL_FOLDER_CHARS_AS_FIRST_LETTER &quot;.&quot;</span>
<a href="#l5.10"></a><span id="l5.10"> #define ILLEGAL_FOLDER_CHARS_AS_LAST_LETTER  &quot;.~ &quot;</span>
<a href="#l5.11"></a><span id="l5.11"> </span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-#define FOUR_K 4096</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineminus">-</span>
<a href="#l5.14"></a><span id="l5.14"> nsresult GetMessageServiceContractIDForURI(const char *uri, nsCString &amp;contractID)</span>
<a href="#l5.15"></a><span id="l5.15"> {</span>
<a href="#l5.16"></a><span id="l5.16">   nsresult rv = NS_OK;</span>
<a href="#l5.17"></a><span id="l5.17">   //Find protocol</span>
<a href="#l5.18"></a><span id="l5.18">   nsAutoCString uriStr(uri);</span>
<a href="#l5.19"></a><span id="l5.19">   int32_t pos = uriStr.FindChar(':');</span>
<a href="#l5.20"></a><span id="l5.20">   if (pos == -1)</span>
<a href="#l5.21"></a><span id="l5.21">     return NS_ERROR_FAILURE;</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineat">@@ -583,17 +581,16 @@ nsresult FormatFileSize(int64_t size, bo</span>
<a href="#l5.23"></a><span id="l5.23">       decimalSeparator.AssignLiteral(&quot;.&quot;);</span>
<a href="#l5.24"></a><span id="l5.24"> </span>
<a href="#l5.25"></a><span id="l5.25">     formattedSize.Replace(separatorPos, 1, decimalSeparator);</span>
<a href="#l5.26"></a><span id="l5.26">   }</span>
<a href="#l5.27"></a><span id="l5.27"> </span>
<a href="#l5.28"></a><span id="l5.28">   return NS_OK;</span>
<a href="#l5.29"></a><span id="l5.29"> }</span>
<a href="#l5.30"></a><span id="l5.30"> </span>
<a href="#l5.31"></a><span id="l5.31" class="difflineminus">-</span>
<a href="#l5.32"></a><span id="l5.32"> nsresult NS_MsgCreatePathStringFromFolderURI(const char *aFolderURI,</span>
<a href="#l5.33"></a><span id="l5.33">                                              nsCString&amp; aPathCString,</span>
<a href="#l5.34"></a><span id="l5.34">                                              const nsCString &amp;aScheme,</span>
<a href="#l5.35"></a><span id="l5.35">                                              bool aIsNewsFolder)</span>
<a href="#l5.36"></a><span id="l5.36"> {</span>
<a href="#l5.37"></a><span id="l5.37">   // A file name has to be in native charset. Here we convert</span>
<a href="#l5.38"></a><span id="l5.38">   // to UTF-16 and check for 'unsafe' characters before converting</span>
<a href="#l5.39"></a><span id="l5.39">   // to native charset.</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineat">@@ -1482,29 +1479,29 @@ nsresult MsgReopenFileStream(nsIFile *fi</span>
<a href="#l5.41"></a><span id="l5.41"> nsresult MsgNewBufferedFileOutputStream(nsIOutputStream **aResult,</span>
<a href="#l5.42"></a><span id="l5.42">                                         nsIFile* aFile,</span>
<a href="#l5.43"></a><span id="l5.43">                                         int32_t aIOFlags,</span>
<a href="#l5.44"></a><span id="l5.44">                                         int32_t aPerm)</span>
<a href="#l5.45"></a><span id="l5.45"> {</span>
<a href="#l5.46"></a><span id="l5.46">   nsCOMPtr&lt;nsIOutputStream&gt; stream;</span>
<a href="#l5.47"></a><span id="l5.47">   nsresult rv = NS_NewLocalFileOutputStream(getter_AddRefs(stream), aFile, aIOFlags, aPerm);</span>
<a href="#l5.48"></a><span id="l5.48">   if (NS_SUCCEEDED(rv))</span>
<a href="#l5.49"></a><span id="l5.49" class="difflineminus">-    rv = NS_NewBufferedOutputStream(aResult, stream, FOUR_K * 4);</span>
<a href="#l5.50"></a><span id="l5.50" class="difflineplus">+    rv = NS_NewBufferedOutputStream(aResult, stream, FILE_IO_BUFFER_SIZE);</span>
<a href="#l5.51"></a><span id="l5.51">   return rv;</span>
<a href="#l5.52"></a><span id="l5.52"> }</span>
<a href="#l5.53"></a><span id="l5.53"> </span>
<a href="#l5.54"></a><span id="l5.54"> nsresult MsgNewSafeBufferedFileOutputStream(nsIOutputStream **aResult,</span>
<a href="#l5.55"></a><span id="l5.55">                                         nsIFile* aFile,</span>
<a href="#l5.56"></a><span id="l5.56">                                         int32_t aIOFlags,</span>
<a href="#l5.57"></a><span id="l5.57">                                         int32_t aPerm)</span>
<a href="#l5.58"></a><span id="l5.58"> {</span>
<a href="#l5.59"></a><span id="l5.59">   nsCOMPtr&lt;nsIOutputStream&gt; stream;</span>
<a href="#l5.60"></a><span id="l5.60">   nsresult rv = NS_NewSafeLocalFileOutputStream(getter_AddRefs(stream), aFile, aIOFlags, aPerm);</span>
<a href="#l5.61"></a><span id="l5.61">   if (NS_SUCCEEDED(rv))</span>
<a href="#l5.62"></a><span id="l5.62" class="difflineminus">-    rv = NS_NewBufferedOutputStream(aResult, stream, FOUR_K * 4);</span>
<a href="#l5.63"></a><span id="l5.63" class="difflineplus">+    rv = NS_NewBufferedOutputStream(aResult, stream, FILE_IO_BUFFER_SIZE);</span>
<a href="#l5.64"></a><span id="l5.64">   return rv;</span>
<a href="#l5.65"></a><span id="l5.65"> }</span>
<a href="#l5.66"></a><span id="l5.66"> </span>
<a href="#l5.67"></a><span id="l5.67"> bool MsgFindKeyword(const nsCString &amp;keyword, nsCString &amp;keywords, int32_t *aStartOfKeyword, int32_t *aLength)</span>
<a href="#l5.68"></a><span id="l5.68"> {</span>
<a href="#l5.69"></a><span id="l5.69"> #ifdef MOZILLA_INTERNAL_API</span>
<a href="#l5.70"></a><span id="l5.70"> // nsTString_CharT::Find(const nsCString&amp; aString,</span>
<a href="#l5.71"></a><span id="l5.71"> //                       bool aIgnoreCase=false,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/base/util/nsMsgUtils.h</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgUtils.h</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -33,16 +33,17 @@ class nsIOutputStream;</span>
<a href="#l6.4"></a><span id="l6.4"> class nsIInputStream;</span>
<a href="#l6.5"></a><span id="l6.5"> class nsIMsgDatabase;</span>
<a href="#l6.6"></a><span id="l6.6"> class nsIMutableArray;</span>
<a href="#l6.7"></a><span id="l6.7"> class nsIProxyInfo;</span>
<a href="#l6.8"></a><span id="l6.8"> class nsIMsgWindow;</span>
<a href="#l6.9"></a><span id="l6.9"> class nsISupportsArray;</span>
<a href="#l6.10"></a><span id="l6.10"> class nsIStreamListener;</span>
<a href="#l6.11"></a><span id="l6.11"> </span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+#define FILE_IO_BUFFER_SIZE (16*1024)</span>
<a href="#l6.13"></a><span id="l6.13"> #define MSGS_URL    &quot;chrome://messenger/locale/messenger.properties&quot;</span>
<a href="#l6.14"></a><span id="l6.14"> </span>
<a href="#l6.15"></a><span id="l6.15"> //These are utility functions that can used throughout the mailnews code</span>
<a href="#l6.16"></a><span id="l6.16"> </span>
<a href="#l6.17"></a><span id="l6.17"> NS_MSG_BASE nsresult GetMessageServiceContractIDForURI(const char *uri, nsCString &amp;contractID);</span>
<a href="#l6.18"></a><span id="l6.18"> </span>
<a href="#l6.19"></a><span id="l6.19"> NS_MSG_BASE nsresult GetMessageServiceFromURI(const nsACString&amp; uri, nsIMsgMessageService **aMessageService);</span>
<a href="#l6.20"></a><span id="l6.20"> </span>
<a href="#l6.21"></a><span id="l6.21" class="difflineat">@@ -185,20 +186,20 @@ NS_MSG_BASE nsresult GetSpecialDirectory</span>
<a href="#l6.22"></a><span id="l6.22"> // we'll clean up 1-10. If the leaks are common, I think the gaps will tend to</span>
<a href="#l6.23"></a><span id="l6.23"> // be filled.</span>
<a href="#l6.24"></a><span id="l6.24"> NS_MSG_BASE nsresult MsgCleanupTempFiles(const char *fileName, const char *extension);</span>
<a href="#l6.25"></a><span id="l6.25"> </span>
<a href="#l6.26"></a><span id="l6.26"> NS_MSG_BASE nsresult MsgGetFileStream(nsIFile *file, nsIOutputStream **fileStream);</span>
<a href="#l6.27"></a><span id="l6.27"> </span>
<a href="#l6.28"></a><span id="l6.28"> NS_MSG_BASE nsresult MsgReopenFileStream(nsIFile *file, nsIInputStream *fileStream);</span>
<a href="#l6.29"></a><span id="l6.29"> </span>
<a href="#l6.30"></a><span id="l6.30" class="difflineminus">-// Automatically creates an output stream with a 4K buffer</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineplus">+// Automatically creates an output stream with a suitable buffer</span>
<a href="#l6.32"></a><span id="l6.32"> NS_MSG_BASE nsresult MsgNewBufferedFileOutputStream(nsIOutputStream **aResult, nsIFile *aFile, int32_t aIOFlags = -1, int32_t aPerm = -1);</span>
<a href="#l6.33"></a><span id="l6.33"> </span>
<a href="#l6.34"></a><span id="l6.34" class="difflineminus">-// Automatically creates an output stream with a 4K buffer, but write to a temporary file first, then rename to aFile</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineplus">+// Automatically creates an output stream with a suitable buffer, but write to a temporary file first, then rename to aFile</span>
<a href="#l6.36"></a><span id="l6.36"> NS_MSG_BASE nsresult MsgNewSafeBufferedFileOutputStream(nsIOutputStream **aResult, nsIFile *aFile, int32_t aIOFlags = -1, int32_t aPerm = -1);</span>
<a href="#l6.37"></a><span id="l6.37"> </span>
<a href="#l6.38"></a><span id="l6.38"> // fills in the position of the passed in keyword in the passed in keyword list</span>
<a href="#l6.39"></a><span id="l6.39"> // and returns false if the keyword isn't present</span>
<a href="#l6.40"></a><span id="l6.40"> NS_MSG_BASE bool MsgFindKeyword(const nsCString &amp;keyword, nsCString &amp;keywords, int32_t *aStartOfKeyword, int32_t *aLength);</span>
<a href="#l6.41"></a><span id="l6.41"> </span>
<a href="#l6.42"></a><span id="l6.42"> NS_MSG_BASE bool MsgHostDomainIsTrusted(nsCString &amp;host, nsCString &amp;trustedMailDomains);</span>
<a href="#l6.43"></a><span id="l6.43"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgAttachmentHandler.cpp</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgAttachmentHandler.cpp</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -36,17 +36,17 @@</span>
<a href="#l7.4"></a><span id="l7.4"> #include &quot;mozilla/mailnews/MimeEncoder.h&quot;</span>
<a href="#l7.5"></a><span id="l7.5"> #include &quot;nsIPrincipal.h&quot;</span>
<a href="#l7.6"></a><span id="l7.6"> </span>
<a href="#l7.7"></a><span id="l7.7"> ///////////////////////////////////////////////////////////////////////////</span>
<a href="#l7.8"></a><span id="l7.8"> // Mac Specific Attachment Handling for AppleDouble Encoded Files</span>
<a href="#l7.9"></a><span id="l7.9"> ///////////////////////////////////////////////////////////////////////////</span>
<a href="#l7.10"></a><span id="l7.10"> #ifdef XP_MACOSX</span>
<a href="#l7.11"></a><span id="l7.11"> </span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-#define AD_WORKING_BUFF_SIZE                  8192</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+#define AD_WORKING_BUFF_SIZE FILE_IO_BUFFER_SIZE</span>
<a href="#l7.14"></a><span id="l7.14"> </span>
<a href="#l7.15"></a><span id="l7.15"> extern void         MacGetFileType(nsIFile *fs, bool *useDefault, char **type, char **encoding);</span>
<a href="#l7.16"></a><span id="l7.16"> </span>
<a href="#l7.17"></a><span id="l7.17"> #include &quot;nsILocalFileMac.h&quot;</span>
<a href="#l7.18"></a><span id="l7.18"> </span>
<a href="#l7.19"></a><span id="l7.19"> /* static */</span>
<a href="#l7.20"></a><span id="l7.20"> nsresult nsSimpleZipper::Zip(nsIFile *aInputFile, nsIFile *aOutputFile)</span>
<a href="#l7.21"></a><span id="l7.21"> {</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineat">@@ -916,48 +916,39 @@ nsMsgAttachmentHandler::ConvertToAppleEn</span>
<a href="#l7.23"></a><span id="l7.23">     rv = MsgGetFileStream(mEncodedWorkingFile, getter_AddRefs(obj-&gt;fileStream));</span>
<a href="#l7.24"></a><span id="l7.24">     if (NS_FAILED(rv) || !obj-&gt;fileStream)</span>
<a href="#l7.25"></a><span id="l7.25">     {</span>
<a href="#l7.26"></a><span id="l7.26">       PR_FREEIF(separator);</span>
<a href="#l7.27"></a><span id="l7.27">       delete obj;</span>
<a href="#l7.28"></a><span id="l7.28">       return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l7.29"></a><span id="l7.29">     }</span>
<a href="#l7.30"></a><span id="l7.30"> </span>
<a href="#l7.31"></a><span id="l7.31" class="difflineminus">-    int32_t     bSize = AD_WORKING_BUFF_SIZE;</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineminus">-</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineminus">-    char  *working_buff = nullptr;</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineminus">-    while (!working_buff &amp;&amp; (bSize &gt;= 512))</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineminus">-    {</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineminus">-      working_buff = (char *)PR_CALLOC(bSize);</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineminus">-      if (!working_buff)</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineminus">-        bSize /= 2;</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineminus">-    }</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineminus">-</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineplus">+    char *working_buff = (char *) PR_Malloc(AD_WORKING_BUFF_SIZE);</span>
<a href="#l7.42"></a><span id="l7.42">     if (!working_buff)</span>
<a href="#l7.43"></a><span id="l7.43">     {</span>
<a href="#l7.44"></a><span id="l7.44">       PR_FREEIF(separator);</span>
<a href="#l7.45"></a><span id="l7.45">       delete obj;</span>
<a href="#l7.46"></a><span id="l7.46">       return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l7.47"></a><span id="l7.47">     }</span>
<a href="#l7.48"></a><span id="l7.48"> </span>
<a href="#l7.49"></a><span id="l7.49">     obj-&gt;buff = working_buff;</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineminus">-    obj-&gt;s_buff = bSize;</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineplus">+    obj-&gt;s_buff = AD_WORKING_BUFF_SIZE;</span>
<a href="#l7.52"></a><span id="l7.52"> </span>
<a href="#l7.53"></a><span id="l7.53">     //</span>
<a href="#l7.54"></a><span id="l7.54">     //  Setup all the need information on the apple double encoder.</span>
<a href="#l7.55"></a><span id="l7.55">     //</span>
<a href="#l7.56"></a><span id="l7.56">     ap_encode_init(&amp;(obj-&gt;ap_encode_obj), aFilePath.get(), separator);</span>
<a href="#l7.57"></a><span id="l7.57"> </span>
<a href="#l7.58"></a><span id="l7.58">     int32_t count;</span>
<a href="#l7.59"></a><span id="l7.59"> </span>
<a href="#l7.60"></a><span id="l7.60">     OSErr status = noErr;</span>
<a href="#l7.61"></a><span id="l7.61">     m_size = 0;</span>
<a href="#l7.62"></a><span id="l7.62">     while (status == noErr)</span>
<a href="#l7.63"></a><span id="l7.63">     {</span>
<a href="#l7.64"></a><span id="l7.64" class="difflineminus">-      status = ap_encode_next(&amp;(obj-&gt;ap_encode_obj), obj-&gt;buff, bSize, &amp;count);</span>
<a href="#l7.65"></a><span id="l7.65" class="difflineplus">+      status = ap_encode_next(&amp;(obj-&gt;ap_encode_obj), obj-&gt;buff, obj-&gt;s_buff, &amp;count);</span>
<a href="#l7.66"></a><span id="l7.66">       if (status == noErr || status == errDone)</span>
<a href="#l7.67"></a><span id="l7.67">       {</span>
<a href="#l7.68"></a><span id="l7.68">         //</span>
<a href="#l7.69"></a><span id="l7.69">         // we got the encode data, so call the next stream to write it to the disk.</span>
<a href="#l7.70"></a><span id="l7.70">         //</span>
<a href="#l7.71"></a><span id="l7.71">         uint32_t bytesWritten;</span>
<a href="#l7.72"></a><span id="l7.72">         obj-&gt;fileStream-&gt;Write(obj-&gt;buff, count, &amp;bytesWritten);</span>
<a href="#l7.73"></a><span id="l7.73">         if (bytesWritten != (uint32_t) count)</span>
<a href="#l7.74"></a><span id="l7.74" class="difflineat">@@ -1224,17 +1215,18 @@ nsMsgAttachmentHandler::UrlExit(nsresult</span>
<a href="#l7.75"></a><span id="l7.75">       GetSerialiserFlags(m_charset.get(), &amp;flowed, &amp;delsp, &amp;formatted, &amp;disallowBreaks);</span>
<a href="#l7.76"></a><span id="l7.76"> </span>
<a href="#l7.77"></a><span id="l7.77">       if (NS_SUCCEEDED(ConvertBufToPlainText(conData, flowed, delsp, formatted, disallowBreaks)))</span>
<a href="#l7.78"></a><span id="l7.78">       {</span>
<a href="#l7.79"></a><span id="l7.79">         if (mDeleteFile)</span>
<a href="#l7.80"></a><span id="l7.80">           mTmpFile-&gt;Remove(false);</span>
<a href="#l7.81"></a><span id="l7.81"> </span>
<a href="#l7.82"></a><span id="l7.82">         nsCOMPtr&lt;nsIOutputStream&gt; outputStream;</span>
<a href="#l7.83"></a><span id="l7.83" class="difflineminus">-        nsresult rv = NS_NewLocalFileOutputStream(getter_AddRefs(outputStream), mTmpFile,  PR_WRONLY | PR_CREATE_FILE, 00600);</span>
<a href="#l7.84"></a><span id="l7.84" class="difflineplus">+        nsresult rv = MsgNewBufferedFileOutputStream(getter_AddRefs(outputStream), mTmpFile,</span>
<a href="#l7.85"></a><span id="l7.85" class="difflineplus">+                                                     PR_WRONLY | PR_CREATE_FILE, 00600);</span>
<a href="#l7.86"></a><span id="l7.86"> </span>
<a href="#l7.87"></a><span id="l7.87">         if (NS_SUCCEEDED(rv))</span>
<a href="#l7.88"></a><span id="l7.88">         {</span>
<a href="#l7.89"></a><span id="l7.89">           nsAutoCString tData;</span>
<a href="#l7.90"></a><span id="l7.90">           if (NS_FAILED(ConvertFromUnicode(m_charset.get(), conData, tData)))</span>
<a href="#l7.91"></a><span id="l7.91">             LossyCopyUTF16toASCII(conData, tData);</span>
<a href="#l7.92"></a><span id="l7.92">           if (!tData.IsEmpty())</span>
<a href="#l7.93"></a><span id="l7.93">           {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgSend.cpp</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgSend.cpp</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -4202,27 +4202,26 @@ nsMsgGetEnvelopeLine(void)</span>
<a href="#l8.4"></a><span id="l8.4">   // PL_strftime(&quot;... %c ...&quot;) is no good, because it is localized.</span>
<a href="#l8.5"></a><span id="l8.5">   //</span>
<a href="#l8.6"></a><span id="l8.6">   PL_strcpy(result, &quot;From - &quot;);</span>
<a href="#l8.7"></a><span id="l8.7">   PL_strcpy(result + 7, buffer);</span>
<a href="#l8.8"></a><span id="l8.8">   PL_strcpy(result + 7 + 24, CRLF);</span>
<a href="#l8.9"></a><span id="l8.9">   return result;</span>
<a href="#l8.10"></a><span id="l8.10"> }</span>
<a href="#l8.11"></a><span id="l8.11"> </span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+#define ibuffer_size FILE_IO_BUFFER_SIZE</span>
<a href="#l8.13"></a><span id="l8.13"> nsresult</span>
<a href="#l8.14"></a><span id="l8.14"> nsMsgComposeAndSend::MimeDoFCC(nsIFile          *input_file,</span>
<a href="#l8.15"></a><span id="l8.15">                                nsMsgDeliverMode mode,</span>
<a href="#l8.16"></a><span id="l8.16">                                const char       *bcc_header,</span>
<a href="#l8.17"></a><span id="l8.17">                                const char       *fcc_header,</span>
<a href="#l8.18"></a><span id="l8.18">                                const char       *news_url)</span>
<a href="#l8.19"></a><span id="l8.19"> {</span>
<a href="#l8.20"></a><span id="l8.20">   nsresult      status = NS_OK;</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineminus">-  char          *ibuffer = 0;</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineminus">-  int32_t       ibuffer_size = TEN_K;</span>
<a href="#l8.23"></a><span id="l8.23" class="difflineminus">-  char          *obuffer = 0;</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineplus">+  char          *ibuffer = nullptr;</span>
<a href="#l8.25"></a><span id="l8.25">   uint32_t      n;</span>
<a href="#l8.26"></a><span id="l8.26">   bool          folderIsLocal = true;</span>
<a href="#l8.27"></a><span id="l8.27">   nsCString     turi;</span>
<a href="#l8.28"></a><span id="l8.28">   char16_t     *printfString = nullptr;</span>
<a href="#l8.29"></a><span id="l8.29">   nsString msg;</span>
<a href="#l8.30"></a><span id="l8.30">   nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l8.31"></a><span id="l8.31"> </span>
<a href="#l8.32"></a><span id="l8.32">   // Before continuing, just check the user has not cancel the operation</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineat">@@ -4280,24 +4279,17 @@ nsMsgComposeAndSend::MimeDoFCC(nsIFile  </span>
<a href="#l8.34"></a><span id="l8.34">       nsMsgBuildMessageWithFile(input_file, error_msg);</span>
<a href="#l8.35"></a><span id="l8.35">       mSendReport-&gt;SetMessage(nsIMsgSendReport::process_Current, error_msg.get(), false);</span>
<a href="#l8.36"></a><span id="l8.36">     }</span>
<a href="#l8.37"></a><span id="l8.37">     status = NS_MSG_UNABLE_TO_OPEN_FILE;</span>
<a href="#l8.38"></a><span id="l8.38">     goto FAIL;</span>
<a href="#l8.39"></a><span id="l8.39">   }</span>
<a href="#l8.40"></a><span id="l8.40"> </span>
<a href="#l8.41"></a><span id="l8.41">   // now the buffers...</span>
<a href="#l8.42"></a><span id="l8.42" class="difflineminus">-  ibuffer = nullptr;</span>
<a href="#l8.43"></a><span id="l8.43" class="difflineminus">-  while (!ibuffer &amp;&amp; (ibuffer_size &gt;= 1024))</span>
<a href="#l8.44"></a><span id="l8.44" class="difflineminus">-  {</span>
<a href="#l8.45"></a><span id="l8.45" class="difflineminus">-    ibuffer = (char *) PR_Malloc(ibuffer_size);</span>
<a href="#l8.46"></a><span id="l8.46" class="difflineminus">-    if (!ibuffer)</span>
<a href="#l8.47"></a><span id="l8.47" class="difflineminus">-      ibuffer_size /= 2;</span>
<a href="#l8.48"></a><span id="l8.48" class="difflineminus">-  }</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineminus">-</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineplus">+  ibuffer = (char *) PR_Malloc(ibuffer_size);</span>
<a href="#l8.51"></a><span id="l8.51">   if (!ibuffer)</span>
<a href="#l8.52"></a><span id="l8.52">   {</span>
<a href="#l8.53"></a><span id="l8.53">     status = NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l8.54"></a><span id="l8.54">     goto FAIL;</span>
<a href="#l8.55"></a><span id="l8.55">   }</span>
<a href="#l8.56"></a><span id="l8.56"> </span>
<a href="#l8.57"></a><span id="l8.57">   //</span>
<a href="#l8.58"></a><span id="l8.58">   // First, we we need to put a Berkeley &quot;From - &quot; delimiter at the head of</span>
<a href="#l8.59"></a><span id="l8.59" class="difflineat">@@ -4629,19 +4621,16 @@ nsMsgComposeAndSend::MimeDoFCC(nsIFile  </span>
<a href="#l8.60"></a><span id="l8.60">     }</span>
<a href="#l8.61"></a><span id="l8.61"> </span>
<a href="#l8.62"></a><span id="l8.62">     rv = inputFile-&gt;Available(&amp;available);</span>
<a href="#l8.63"></a><span id="l8.63">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.64"></a><span id="l8.64">   }</span>
<a href="#l8.65"></a><span id="l8.65"> </span>
<a href="#l8.66"></a><span id="l8.66"> FAIL:</span>
<a href="#l8.67"></a><span id="l8.67">   PR_Free(ibuffer);</span>
<a href="#l8.68"></a><span id="l8.68" class="difflineminus">-  if (obuffer != ibuffer)</span>
<a href="#l8.69"></a><span id="l8.69" class="difflineminus">-    PR_Free(obuffer);</span>
<a href="#l8.70"></a><span id="l8.70" class="difflineminus">-</span>
<a href="#l8.71"></a><span id="l8.71"> </span>
<a href="#l8.72"></a><span id="l8.72">   if (NS_FAILED(tempOutfile-&gt;Flush()))</span>
<a href="#l8.73"></a><span id="l8.73">     status = NS_MSG_ERROR_WRITING_FILE;</span>
<a href="#l8.74"></a><span id="l8.74"> </span>
<a href="#l8.75"></a><span id="l8.75">   tempOutfile-&gt;Close();</span>
<a href="#l8.76"></a><span id="l8.76"> </span>
<a href="#l8.77"></a><span id="l8.77">   if (inputFile)</span>
<a href="#l8.78"></a><span id="l8.78">     inputFile-&gt;Close();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgSend.h</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgSend.h</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -132,17 +132,16 @@</span>
<a href="#l9.4"></a><span id="l9.4"> #include &quot;nsAutoPtr.h&quot;</span>
<a href="#l9.5"></a><span id="l9.5"> #include &quot;nsMsgAttachmentData.h&quot;</span>
<a href="#l9.6"></a><span id="l9.6"> #include &quot;nsIMsgFilterService.h&quot;</span>
<a href="#l9.7"></a><span id="l9.7"> #include &quot;nsIMsgOperationListener.h&quot;</span>
<a href="#l9.8"></a><span id="l9.8"> </span>
<a href="#l9.9"></a><span id="l9.9"> //</span>
<a href="#l9.10"></a><span id="l9.10"> // Some necessary defines...</span>
<a href="#l9.11"></a><span id="l9.11"> //</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-#define TEN_K                 10240</span>
<a href="#l9.13"></a><span id="l9.13"> #define MIME_BUFFER_SIZE      4096 // must be greater than 1000</span>
<a href="#l9.14"></a><span id="l9.14">                                    // SMTP (RFC821) limit</span>
<a href="#l9.15"></a><span id="l9.15"> // Maximum number of bytes we allow in a line before we force</span>
<a href="#l9.16"></a><span id="l9.16"> // encoding to base64 if not already QR-encoded or of type message/rfc822.</span>
<a href="#l9.17"></a><span id="l9.17"> #define LINELENGTH_ENCODING_THRESHOLD 990</span>
<a href="#l9.18"></a><span id="l9.18"> </span>
<a href="#l9.19"></a><span id="l9.19"> //</span>
<a href="#l9.20"></a><span id="l9.20"> // Utilities for string handling</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/extensions/mdn/src/nsMsgMdnGenerator.cpp</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/extensions/mdn/src/nsMsgMdnGenerator.cpp</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -371,20 +371,20 @@ nsresult nsMsgMdnGenerator::CreateMdnMsg</span>
<a href="#l10.4"></a><span id="l10.4">     nsCOMPtr&lt;nsIFile&gt; tmpFile;</span>
<a href="#l10.5"></a><span id="l10.5">     rv = GetSpecialDirectoryWithFileName(NS_OS_TEMP_DIR,</span>
<a href="#l10.6"></a><span id="l10.6">                                          &quot;mdnmsg&quot;,</span>
<a href="#l10.7"></a><span id="l10.7">                                          getter_AddRefs(m_file));</span>
<a href="#l10.8"></a><span id="l10.8">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.9"></a><span id="l10.9"> </span>
<a href="#l10.10"></a><span id="l10.10">     rv = m_file-&gt;CreateUnique(nsIFile::NORMAL_FILE_TYPE, 00600);</span>
<a href="#l10.11"></a><span id="l10.11">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-    rv = NS_NewLocalFileOutputStream(getter_AddRefs(m_outputStream),</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineminus">-                                     m_file,</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineminus">-                                     PR_CREATE_FILE | PR_WRONLY | PR_TRUNCATE,</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineminus">-                                     0664);</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineplus">+    rv = MsgNewBufferedFileOutputStream(getter_AddRefs(m_outputStream),</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineplus">+                                        m_file,</span>
<a href="#l10.18"></a><span id="l10.18" class="difflineplus">+                                        PR_CREATE_FILE | PR_WRONLY | PR_TRUNCATE,</span>
<a href="#l10.19"></a><span id="l10.19" class="difflineplus">+                                        0664);</span>
<a href="#l10.20"></a><span id="l10.20">     NS_ASSERTION(NS_SUCCEEDED(rv),&quot;creating mdn: failed to output stream&quot;);</span>
<a href="#l10.21"></a><span id="l10.21">     if (NS_FAILED(rv))</span>
<a href="#l10.22"></a><span id="l10.22">         return NS_OK;</span>
<a href="#l10.23"></a><span id="l10.23"> </span>
<a href="#l10.24"></a><span id="l10.24">     rv = CreateFirstPart();</span>
<a href="#l10.25"></a><span id="l10.25">     if (NS_SUCCEEDED(rv))</span>
<a href="#l10.26"></a><span id="l10.26">     {</span>
<a href="#l10.27"></a><span id="l10.27">         rv = CreateSecondPart();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/imap/src/nsImapMailFolder.cpp</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapMailFolder.cpp</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -100,17 +100,16 @@</span>
<a href="#l11.4"></a><span id="l11.4"> </span>
<a href="#l11.5"></a><span id="l11.5"> static NS_DEFINE_CID(kRDFServiceCID, NS_RDFSERVICE_CID);</span>
<a href="#l11.6"></a><span id="l11.6"> static NS_DEFINE_CID(kParseMailMsgStateCID, NS_PARSEMAILMSGSTATE_CID);</span>
<a href="#l11.7"></a><span id="l11.7"> static NS_DEFINE_CID(kCImapHostSessionList, NS_IIMAPHOSTSESSIONLIST_CID);</span>
<a href="#l11.8"></a><span id="l11.8"> </span>
<a href="#l11.9"></a><span id="l11.9"> extern PRLogModuleInfo *gAutoSyncLog;</span>
<a href="#l11.10"></a><span id="l11.10"> extern PRLogModuleInfo* IMAP;</span>
<a href="#l11.11"></a><span id="l11.11"> </span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-#define FOUR_K 4096</span>
<a href="#l11.13"></a><span id="l11.13"> #define MAILNEWS_CUSTOM_HEADERS &quot;mailnews.customHeaders&quot;</span>
<a href="#l11.14"></a><span id="l11.14"> </span>
<a href="#l11.15"></a><span id="l11.15"> /*</span>
<a href="#l11.16"></a><span id="l11.16">     Copies the contents of srcDir into destDir.</span>
<a href="#l11.17"></a><span id="l11.17">     destDir will be created if it doesn't exist.</span>
<a href="#l11.18"></a><span id="l11.18"> */</span>
<a href="#l11.19"></a><span id="l11.19"> </span>
<a href="#l11.20"></a><span id="l11.20"> static</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineat">@@ -7046,25 +7045,24 @@ nsresult nsImapMailFolder::CopyOfflineMs</span>
<a href="#l11.22"></a><span id="l11.22">   nsCOMPtr&lt;nsISeekableStream&gt; seekStream = do_QueryInterface(inputStream);</span>
<a href="#l11.23"></a><span id="l11.23">   NS_ASSERTION(seekStream, &quot;non seekable stream - can't read from offline msg&quot;);</span>
<a href="#l11.24"></a><span id="l11.24">   if (seekStream)</span>
<a href="#l11.25"></a><span id="l11.25">   {</span>
<a href="#l11.26"></a><span id="l11.26">     rv = seekStream-&gt;Seek(nsISeekableStream::NS_SEEK_SET, messageOffset);</span>
<a href="#l11.27"></a><span id="l11.27">     if (NS_SUCCEEDED(rv))</span>
<a href="#l11.28"></a><span id="l11.28">     {</span>
<a href="#l11.29"></a><span id="l11.29">       // now, copy the dest folder offline store msg to the temp file</span>
<a href="#l11.30"></a><span id="l11.30" class="difflineminus">-      int32_t inputBufferSize = 10240;</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineminus">-      char *inputBuffer = (char *) PR_Malloc(inputBufferSize);</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineplus">+      char *inputBuffer = (char *) PR_Malloc(FILE_IO_BUFFER_SIZE);</span>
<a href="#l11.33"></a><span id="l11.33">       int32_t bytesLeft;</span>
<a href="#l11.34"></a><span id="l11.34">       uint32_t bytesRead, bytesWritten;</span>
<a href="#l11.35"></a><span id="l11.35">       bytesLeft = messageSize;</span>
<a href="#l11.36"></a><span id="l11.36">       rv = (inputBuffer) ? NS_OK : NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l11.37"></a><span id="l11.37">       while (bytesLeft &gt; 0 &amp;&amp; NS_SUCCEEDED(rv))</span>
<a href="#l11.38"></a><span id="l11.38">       {</span>
<a href="#l11.39"></a><span id="l11.39" class="difflineminus">-        rv = inputStream-&gt;Read(inputBuffer, inputBufferSize, &amp;bytesRead);</span>
<a href="#l11.40"></a><span id="l11.40" class="difflineplus">+        rv = inputStream-&gt;Read(inputBuffer, FILE_IO_BUFFER_SIZE, &amp;bytesRead);</span>
<a href="#l11.41"></a><span id="l11.41">         if (NS_SUCCEEDED(rv) &amp;&amp; bytesRead &gt; 0)</span>
<a href="#l11.42"></a><span id="l11.42">         {</span>
<a href="#l11.43"></a><span id="l11.43">           rv = outputStream-&gt;Write(inputBuffer, std::min((int32_t) bytesRead, bytesLeft), &amp;bytesWritten);</span>
<a href="#l11.44"></a><span id="l11.44">           NS_ASSERTION((int32_t) bytesWritten == std::min((int32_t) bytesRead, bytesLeft), &quot;wrote out incorrect number of bytes&quot;);</span>
<a href="#l11.45"></a><span id="l11.45">         }</span>
<a href="#l11.46"></a><span id="l11.46">         else</span>
<a href="#l11.47"></a><span id="l11.47">           break;</span>
<a href="#l11.48"></a><span id="l11.48">         bytesLeft -= bytesRead;</span>
<a href="#l11.49"></a><span id="l11.49" class="difflineat">@@ -8390,19 +8388,18 @@ nsImapMailFolder::CopyFileToOfflineStore</span>
<a href="#l11.50"></a><span id="l11.50">   }</span>
<a href="#l11.51"></a><span id="l11.51">   msgParser-&gt;SetEnvelopePos(offset);</span>
<a href="#l11.52"></a><span id="l11.52"> </span>
<a href="#l11.53"></a><span id="l11.53">   rv = NS_NewLocalFileInputStream(getter_AddRefs(inputStream), srcFile);</span>
<a href="#l11.54"></a><span id="l11.54">   if (NS_SUCCEEDED(rv) &amp;&amp; inputStream)</span>
<a href="#l11.55"></a><span id="l11.55">   {</span>
<a href="#l11.56"></a><span id="l11.56">     // Now, parse the temp file to (optionally) copy to</span>
<a href="#l11.57"></a><span id="l11.57">     // the offline store for the cur folder.</span>
<a href="#l11.58"></a><span id="l11.58" class="difflineminus">-    int32_t inputBufferSize = 10240;</span>
<a href="#l11.59"></a><span id="l11.59">     nsMsgLineStreamBuffer *inputStreamBuffer =</span>
<a href="#l11.60"></a><span id="l11.60" class="difflineminus">-      new nsMsgLineStreamBuffer(inputBufferSize, true, false);</span>
<a href="#l11.61"></a><span id="l11.61" class="difflineplus">+      new nsMsgLineStreamBuffer(FILE_IO_BUFFER_SIZE, true, false);</span>
<a href="#l11.62"></a><span id="l11.62">     int64_t fileSize;</span>
<a href="#l11.63"></a><span id="l11.63">     srcFile-&gt;GetFileSize(&amp;fileSize);</span>
<a href="#l11.64"></a><span id="l11.64">     uint32_t bytesWritten;</span>
<a href="#l11.65"></a><span id="l11.65">     rv = NS_OK;</span>
<a href="#l11.66"></a><span id="l11.66">     msgParser-&gt;SetState(nsIMsgParseMailMsgState::ParseHeadersState);</span>
<a href="#l11.67"></a><span id="l11.67">     msgParser-&gt;SetNewMsgHdr(fakeHdr);</span>
<a href="#l11.68"></a><span id="l11.68">     bool needMoreData = false;</span>
<a href="#l11.69"></a><span id="l11.69">     char * newLine = nullptr;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/imap/src/nsImapOfflineSync.cpp</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapOfflineSync.cpp</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -410,37 +410,31 @@ nsImapOfflineSync::ProcessAppendMsgOpera</span>
<a href="#l12.4"></a><span id="l12.4">             nsCOMPtr&lt;nsISeekableStream&gt; seekStream = do_QueryInterface(offlineStoreInputStream);</span>
<a href="#l12.5"></a><span id="l12.5">             NS_ASSERTION(seekStream, &quot;non seekable stream - can't read from offline msg&quot;);</span>
<a href="#l12.6"></a><span id="l12.6">             if (seekStream)</span>
<a href="#l12.7"></a><span id="l12.7">             {</span>
<a href="#l12.8"></a><span id="l12.8">               rv = seekStream-&gt;Seek(PR_SEEK_SET, messageOffset);</span>
<a href="#l12.9"></a><span id="l12.9">               if (NS_SUCCEEDED(rv))</span>
<a href="#l12.10"></a><span id="l12.10">               {</span>
<a href="#l12.11"></a><span id="l12.11">                 // now, copy the dest folder offline store msg to the temp file</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-                int32_t inputBufferSize = 10240;</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineminus">-                char *inputBuffer = nullptr;</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineplus">+                int32_t inputBufferSize = FILE_IO_BUFFER_SIZE;</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineplus">+                char *inputBuffer = (char *) PR_Malloc(inputBufferSize);</span>
<a href="#l12.16"></a><span id="l12.16"> </span>
<a href="#l12.17"></a><span id="l12.17" class="difflineminus">-                while (!inputBuffer &amp;&amp; (inputBufferSize &gt;= 512))</span>
<a href="#l12.18"></a><span id="l12.18" class="difflineminus">-                {</span>
<a href="#l12.19"></a><span id="l12.19" class="difflineminus">-                  inputBuffer = (char *) PR_Malloc(inputBufferSize);</span>
<a href="#l12.20"></a><span id="l12.20" class="difflineminus">-                  if (!inputBuffer)</span>
<a href="#l12.21"></a><span id="l12.21" class="difflineminus">-                    inputBufferSize /= 2;</span>
<a href="#l12.22"></a><span id="l12.22" class="difflineminus">-                }</span>
<a href="#l12.23"></a><span id="l12.23">                 int32_t bytesLeft;</span>
<a href="#l12.24"></a><span id="l12.24">                 uint32_t bytesRead, bytesWritten;</span>
<a href="#l12.25"></a><span id="l12.25">                 bytesLeft = messageSize;</span>
<a href="#l12.26"></a><span id="l12.26" class="difflineminus">-                rv = NS_OK;</span>
<a href="#l12.27"></a><span id="l12.27" class="difflineplus">+                rv = inputBuffer ? NS_OK : NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l12.28"></a><span id="l12.28">                 while (bytesLeft &gt; 0 &amp;&amp; NS_SUCCEEDED(rv))</span>
<a href="#l12.29"></a><span id="l12.29">                 {</span>
<a href="#l12.30"></a><span id="l12.30">                   int32_t bytesToRead = std::min(inputBufferSize, bytesLeft);</span>
<a href="#l12.31"></a><span id="l12.31">                   rv = offlineStoreInputStream-&gt;Read(inputBuffer, bytesToRead, &amp;bytesRead);</span>
<a href="#l12.32"></a><span id="l12.32">                   if (NS_SUCCEEDED(rv) &amp;&amp; bytesRead &gt; 0)</span>
<a href="#l12.33"></a><span id="l12.33">                   {</span>
<a href="#l12.34"></a><span id="l12.34">                     rv = outputStream-&gt;Write(inputBuffer, bytesRead, &amp;bytesWritten);</span>
<a href="#l12.35"></a><span id="l12.35" class="difflineminus">-                    NS_ASSERTION(bytesWritten == bytesRead, &quot;wrote out correct number of bytes&quot;);</span>
<a href="#l12.36"></a><span id="l12.36" class="difflineplus">+                    NS_ASSERTION(bytesWritten == bytesRead, &quot;wrote out incorrect number of bytes&quot;);</span>
<a href="#l12.37"></a><span id="l12.37">                   }</span>
<a href="#l12.38"></a><span id="l12.38">                   else</span>
<a href="#l12.39"></a><span id="l12.39">                     break;</span>
<a href="#l12.40"></a><span id="l12.40">                   bytesLeft -= bytesRead;</span>
<a href="#l12.41"></a><span id="l12.41">                 }</span>
<a href="#l12.42"></a><span id="l12.42">                 outputStream-&gt;Flush();</span>
<a href="#l12.43"></a><span id="l12.43">                 outputStream-&gt;Close();</span>
<a href="#l12.44"></a><span id="l12.44">                 if (NS_SUCCEEDED(rv))</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mailnews/imap/src/nsImapService.cpp</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapService.cpp</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -2038,18 +2038,17 @@ nsresult nsImapService::OfflineAppendFro</span>
<a href="#l13.4"></a><span id="l13.4">         nsCOMPtr &lt;nsIInputStream&gt; inputStream;</span>
<a href="#l13.5"></a><span id="l13.5">         nsCOMPtr &lt;nsIMsgParseMailMsgState&gt; msgParser = do_CreateInstance(NS_PARSEMAILMSGSTATE_CONTRACTID, &amp;rv);</span>
<a href="#l13.6"></a><span id="l13.6">         msgParser-&gt;SetMailDB(destDB);</span>
<a href="#l13.7"></a><span id="l13.7"> </span>
<a href="#l13.8"></a><span id="l13.8">         rv = NS_NewLocalFileInputStream(getter_AddRefs(inputStream), aFile);</span>
<a href="#l13.9"></a><span id="l13.9">         if (NS_SUCCEEDED(rv) &amp;&amp; inputStream)</span>
<a href="#l13.10"></a><span id="l13.10">         {</span>
<a href="#l13.11"></a><span id="l13.11">           // now, copy the temp file to the offline store for the dest folder.</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-          int32_t inputBufferSize = 10240;</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineminus">-          nsMsgLineStreamBuffer *inputStreamBuffer = new nsMsgLineStreamBuffer(inputBufferSize, </span>
<a href="#l13.14"></a><span id="l13.14" class="difflineplus">+          nsMsgLineStreamBuffer *inputStreamBuffer = new nsMsgLineStreamBuffer(FILE_IO_BUFFER_SIZE,</span>
<a href="#l13.15"></a><span id="l13.15">                                                                                true,    // allocate new lines</span>
<a href="#l13.16"></a><span id="l13.16">                                                                                false);  // leave CRLFs on the returned string</span>
<a href="#l13.17"></a><span id="l13.17">           int64_t fileSize;</span>
<a href="#l13.18"></a><span id="l13.18">           aFile-&gt;GetFileSize(&amp;fileSize);</span>
<a href="#l13.19"></a><span id="l13.19">           uint32_t bytesWritten;</span>
<a href="#l13.20"></a><span id="l13.20">           rv = NS_OK;</span>
<a href="#l13.21"></a><span id="l13.21"> //        rv = inputStream-&gt;Read(inputBuffer, inputBufferSize, &amp;bytesRead);</span>
<a href="#l13.22"></a><span id="l13.22"> //        if (NS_SUCCEEDED(rv) &amp;&amp; bytesRead &gt; 0)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mailnews/import/becky/src/nsBeckyImport.cpp</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mailnews/import/becky/src/nsBeckyImport.cpp</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -3,17 +3,16 @@</span>
<a href="#l14.4"></a><span id="l14.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l14.5"></a><span id="l14.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l14.6"></a><span id="l14.6"> </span>
<a href="#l14.7"></a><span id="l14.7"> #include &quot;nscore.h&quot;</span>
<a href="#l14.8"></a><span id="l14.8"> #include &quot;nsIServiceManager.h&quot;</span>
<a href="#l14.9"></a><span id="l14.9"> #include &quot;nsIImportService.h&quot;</span>
<a href="#l14.10"></a><span id="l14.10"> #include &quot;nsIComponentManager.h&quot;</span>
<a href="#l14.11"></a><span id="l14.11"> #include &quot;nsIMemory.h&quot;</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-#include &quot;nsIImportService.h&quot;</span>
<a href="#l14.13"></a><span id="l14.13"> #include &quot;nsIImportMail.h&quot;</span>
<a href="#l14.14"></a><span id="l14.14"> #include &quot;nsIImportMailboxDescriptor.h&quot;</span>
<a href="#l14.15"></a><span id="l14.15"> #include &quot;nsIImportGeneric.h&quot;</span>
<a href="#l14.16"></a><span id="l14.16"> #include &quot;nsIImportAddressBooks.h&quot;</span>
<a href="#l14.17"></a><span id="l14.17"> #include &quot;nsIImportABDescriptor.h&quot;</span>
<a href="#l14.18"></a><span id="l14.18"> #include &quot;nsIImportSettings.h&quot;</span>
<a href="#l14.19"></a><span id="l14.19"> #include &quot;nsIImportFilters.h&quot;</span>
<a href="#l14.20"></a><span id="l14.20"> #include &quot;nsIImportFieldMap.h&quot;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mailnews/import/becky/src/nsBeckyMail.cpp</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mailnews/import/becky/src/nsBeckyMail.cpp</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -477,17 +477,17 @@ ImportMessageRunnable::WriteAttachmentFi</span>
<a href="#l15.4"></a><span id="l15.4">                          getter_AddRefs(attachmentFile));</span>
<a href="#l15.5"></a><span id="l15.5">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.6"></a><span id="l15.6"> </span>
<a href="#l15.7"></a><span id="l15.7">   nsCOMPtr&lt;nsIInputStream&gt; inputStream;</span>
<a href="#l15.8"></a><span id="l15.8">   rv = NS_NewLocalFileInputStream(getter_AddRefs(inputStream),</span>
<a href="#l15.9"></a><span id="l15.9">                                   attachmentFile);</span>
<a href="#l15.10"></a><span id="l15.10">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.11"></a><span id="l15.11"> </span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-  char buffer[4096];</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineplus">+  char buffer[FILE_IO_BUFFER_SIZE];</span>
<a href="#l15.14"></a><span id="l15.14">   uint32_t readBytes = 0;</span>
<a href="#l15.15"></a><span id="l15.15">   uint32_t writtenBytes = 0;</span>
<a href="#l15.16"></a><span id="l15.16">   rv = aOutputStream-&gt;Write(MSG_LINEBREAK, strlen(MSG_LINEBREAK), &amp;writtenBytes);</span>
<a href="#l15.17"></a><span id="l15.17">   while (NS_SUCCEEDED(inputStream-&gt;Read(buffer, sizeof(buffer), &amp;readBytes)) &amp;&amp;</span>
<a href="#l15.18"></a><span id="l15.18">          readBytes &gt; 0) {</span>
<a href="#l15.19"></a><span id="l15.19">     rv = aOutputStream-&gt;Write(buffer, readBytes, &amp;writtenBytes);</span>
<a href="#l15.20"></a><span id="l15.20">     if (NS_FAILED(rv))</span>
<a href="#l15.21"></a><span id="l15.21">       break;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mailnews/import/outlook/src/nsOutlookCompose.cpp</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mailnews/import/outlook/src/nsOutlookCompose.cpp</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -187,18 +187,17 @@ nsresult OutlookSendListener::CreateSend</span>
<a href="#l16.4"></a><span id="l16.4"> #define hackAmpersandA &quot;amp&quot;</span>
<a href="#l16.5"></a><span id="l16.5"> #define hackAmpersandW u&quot;amp&quot;</span>
<a href="#l16.6"></a><span id="l16.6"> </span>
<a href="#l16.7"></a><span id="l16.7"> nsOutlookCompose::nsOutlookCompose()</span>
<a href="#l16.8"></a><span id="l16.8"> {</span>
<a href="#l16.9"></a><span id="l16.9">   m_pListener = nullptr;</span>
<a href="#l16.10"></a><span id="l16.10">   m_pMsgFields = nullptr;</span>
<a href="#l16.11"></a><span id="l16.11"> </span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-  m_optimizationBufferSize = 16*1024;</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineminus">-  m_optimizationBuffer = new char[m_optimizationBufferSize];</span>
<a href="#l16.14"></a><span id="l16.14" class="difflineplus">+  m_optimizationBuffer = new char[FILE_IO_BUFFER_SIZE];</span>
<a href="#l16.15"></a><span id="l16.15"> }</span>
<a href="#l16.16"></a><span id="l16.16"> </span>
<a href="#l16.17"></a><span id="l16.17"> nsOutlookCompose::~nsOutlookCompose()</span>
<a href="#l16.18"></a><span id="l16.18"> {</span>
<a href="#l16.19"></a><span id="l16.19">   NS_IF_RELEASE(m_pListener);</span>
<a href="#l16.20"></a><span id="l16.20">   NS_IF_RELEASE(m_pMsgFields);</span>
<a href="#l16.21"></a><span id="l16.21">   if (m_pIdentity) {</span>
<a href="#l16.22"></a><span id="l16.22">     nsresult rv = m_pIdentity-&gt;ClearAllValues();</span>
<a href="#l16.23"></a><span id="l16.23" class="difflineat">@@ -373,17 +372,17 @@ nsresult nsOutlookCompose::ComposeTheMes</span>
<a href="#l16.24"></a><span id="l16.24"> </span>
<a href="#l16.25"></a><span id="l16.25"> nsresult nsOutlookCompose::CopyComposedMessage(nsIFile *pSrc,</span>
<a href="#l16.26"></a><span id="l16.26">                                                nsIOutputStream *pDst,</span>
<a href="#l16.27"></a><span id="l16.27">                                                CMapiMessage&amp; origMsg)</span>
<a href="#l16.28"></a><span id="l16.28"> {</span>
<a href="#l16.29"></a><span id="l16.29">   // I'm unsure if we really need the convertCRs feature here.</span>
<a href="#l16.30"></a><span id="l16.30">   // The headers in the file are generated by TB, the body was generated by rtf reader that always used CRLF,</span>
<a href="#l16.31"></a><span id="l16.31">   // and the attachments were processed by TB either... However, I let it stay as it was in the original code.</span>
<a href="#l16.32"></a><span id="l16.32" class="difflineminus">-  CCompositionFile f(pSrc, m_optimizationBuffer, m_optimizationBufferSize, true);</span>
<a href="#l16.33"></a><span id="l16.33" class="difflineplus">+  CCompositionFile f(pSrc, m_optimizationBuffer, FILE_IO_BUFFER_SIZE, true);</span>
<a href="#l16.34"></a><span id="l16.34">   if (!f) {</span>
<a href="#l16.35"></a><span id="l16.35">     IMPORT_LOG0(&quot;*** Error, unexpected zero file size for composed message\n&quot;);</span>
<a href="#l16.36"></a><span id="l16.36">     return NS_ERROR_FAILURE;</span>
<a href="#l16.37"></a><span id="l16.37">   }</span>
<a href="#l16.38"></a><span id="l16.38"> </span>
<a href="#l16.39"></a><span id="l16.39">   // The &quot;From ...&quot; separates the messages. Without it, TB cannot see the messages in the mailbox file.</span>
<a href="#l16.40"></a><span id="l16.40">   // Thus, the lines that look like &quot;From ...&quot; in the message must be escaped (see EscapeFromSpaceLine())</span>
<a href="#l16.41"></a><span id="l16.41">   int fromLineLen;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mailnews/import/outlook/src/nsOutlookCompose.h</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mailnews/import/outlook/src/nsOutlookCompose.h</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -50,17 +50,16 @@ private:</span>
<a href="#l17.4"></a><span id="l17.4">   bool GenerateHackSequence(const wchar_t* body, size_t origLen);</span>
<a href="#l17.5"></a><span id="l17.5">   // End Bug 593907</span>
<a href="#l17.6"></a><span id="l17.6"> </span>
<a href="#l17.7"></a><span id="l17.7"> private:</span>
<a href="#l17.8"></a><span id="l17.8">   nsIMsgSendListener *  m_pListener;</span>
<a href="#l17.9"></a><span id="l17.9">   nsIMsgCompFields *    m_pMsgFields;</span>
<a href="#l17.10"></a><span id="l17.10">   static nsIMsgIdentity *    m_pIdentity;</span>
<a href="#l17.11"></a><span id="l17.11">   char* m_optimizationBuffer;</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-  unsigned int m_optimizationBufferSize;</span>
<a href="#l17.13"></a><span id="l17.13">   nsCOMPtr&lt;nsIImportService&gt;  m_pImportService;</span>
<a href="#l17.14"></a><span id="l17.14"> </span>
<a href="#l17.15"></a><span id="l17.15">   // Bug 593907</span>
<a href="#l17.16"></a><span id="l17.16">   nsString m_hackedPostfix;</span>
<a href="#l17.17"></a><span id="l17.17">   // End Bug 593907</span>
<a href="#l17.18"></a><span id="l17.18"> };</span>
<a href="#l17.19"></a><span id="l17.19"> </span>
<a href="#l17.20"></a><span id="l17.20"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mailnews/local/src/nsMsgMaildirStore.cpp</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mailnews/local/src/nsMsgMaildirStore.cpp</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -1188,19 +1188,18 @@ nsresult MaildirStoreParser::ParseNextMe</span>
<a href="#l18.4"></a><span id="l18.4">   rv = m_db-&gt;CreateNewHdr(nsMsgKey_None, getter_AddRefs(newMsgHdr));</span>
<a href="#l18.5"></a><span id="l18.5">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.6"></a><span id="l18.6"> </span>
<a href="#l18.7"></a><span id="l18.7">   newMsgHdr-&gt;SetMessageOffset(0);</span>
<a href="#l18.8"></a><span id="l18.8"> </span>
<a href="#l18.9"></a><span id="l18.9">   rv = NS_NewLocalFileInputStream(getter_AddRefs(inputStream), aFile);</span>
<a href="#l18.10"></a><span id="l18.10">   if (NS_SUCCEEDED(rv) &amp;&amp; inputStream)</span>
<a href="#l18.11"></a><span id="l18.11">   {</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-    int32_t inputBufferSize = 10240;</span>
<a href="#l18.13"></a><span id="l18.13">     nsMsgLineStreamBuffer *inputStreamBuffer =</span>
<a href="#l18.14"></a><span id="l18.14" class="difflineminus">-      new nsMsgLineStreamBuffer(inputBufferSize, true, false);</span>
<a href="#l18.15"></a><span id="l18.15" class="difflineplus">+      new nsMsgLineStreamBuffer(FILE_IO_BUFFER_SIZE, true, false);</span>
<a href="#l18.16"></a><span id="l18.16">     int64_t fileSize;</span>
<a href="#l18.17"></a><span id="l18.17">     aFile-&gt;GetFileSize(&amp;fileSize);</span>
<a href="#l18.18"></a><span id="l18.18">     msgParser-&gt;SetNewMsgHdr(newMsgHdr);</span>
<a href="#l18.19"></a><span id="l18.19">     msgParser-&gt;SetState(nsIMsgParseMailMsgState::ParseHeadersState);</span>
<a href="#l18.20"></a><span id="l18.20">     msgParser-&gt;SetEnvelopePos(0);</span>
<a href="#l18.21"></a><span id="l18.21">     bool needMoreData = false;</span>
<a href="#l18.22"></a><span id="l18.22">     char * newLine = nullptr;</span>
<a href="#l18.23"></a><span id="l18.23">     uint32_t numBytesInLine = 0;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mailnews/local/src/nsParseMailbox.cpp</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mailnews/local/src/nsParseMailbox.cpp</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -2428,27 +2428,24 @@ nsresult nsParseNewMailState::AppendMsgF</span>
<a href="#l19.4"></a><span id="l19.4">   nsresult rv = destFolder-&gt;GetMsgStore(getter_AddRefs(store));</span>
<a href="#l19.5"></a><span id="l19.5">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.6"></a><span id="l19.6">   bool reusable;</span>
<a href="#l19.7"></a><span id="l19.7">   rv = store-&gt;GetNewMsgOutputStream(destFolder, &amp;aHdr, &amp;reusable,</span>
<a href="#l19.8"></a><span id="l19.8">                                     getter_AddRefs(destOutputStream));</span>
<a href="#l19.9"></a><span id="l19.9">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.10"></a><span id="l19.10"> </span>
<a href="#l19.11"></a><span id="l19.11">   if (!m_ibuffer)</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-    m_ibuffer_size = 10240;</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineplus">+  {</span>
<a href="#l19.14"></a><span id="l19.14" class="difflineplus">+    m_ibuffer_size = FILE_IO_BUFFER_SIZE;</span>
<a href="#l19.15"></a><span id="l19.15" class="difflineplus">+    m_ibuffer = (char *) PR_Malloc(m_ibuffer_size);</span>
<a href="#l19.16"></a><span id="l19.16" class="difflineplus">+    NS_ASSERTION(m_ibuffer != nullptr, &quot;couldn't get memory to move msg&quot;);</span>
<a href="#l19.17"></a><span id="l19.17" class="difflineplus">+  }</span>
<a href="#l19.18"></a><span id="l19.18">   m_ibuffer_fp = 0;</span>
<a href="#l19.19"></a><span id="l19.19"> </span>
<a href="#l19.20"></a><span id="l19.20" class="difflineminus">-  while (!m_ibuffer &amp;&amp; (m_ibuffer_size &gt;= 512))</span>
<a href="#l19.21"></a><span id="l19.21" class="difflineminus">-  {</span>
<a href="#l19.22"></a><span id="l19.22" class="difflineminus">-    m_ibuffer = (char *) PR_Malloc(m_ibuffer_size);</span>
<a href="#l19.23"></a><span id="l19.23" class="difflineminus">-    if (m_ibuffer == nullptr)</span>
<a href="#l19.24"></a><span id="l19.24" class="difflineminus">-      m_ibuffer_size /= 2;</span>
<a href="#l19.25"></a><span id="l19.25" class="difflineminus">-  }</span>
<a href="#l19.26"></a><span id="l19.26" class="difflineminus">-  NS_ASSERTION(m_ibuffer != nullptr, &quot;couldn't get memory to move msg&quot;);</span>
<a href="#l19.27"></a><span id="l19.27" class="difflineminus">-  while ((length &gt; 0) &amp;&amp; m_ibuffer)</span>
<a href="#l19.28"></a><span id="l19.28" class="difflineplus">+  while (length &gt; 0 &amp;&amp; m_ibuffer)</span>
<a href="#l19.29"></a><span id="l19.29">   {</span>
<a href="#l19.30"></a><span id="l19.30">     uint32_t nRead;</span>
<a href="#l19.31"></a><span id="l19.31">     fileStream-&gt;Read (m_ibuffer, length &gt; m_ibuffer_size ? m_ibuffer_size  : length, &amp;nRead);</span>
<a href="#l19.32"></a><span id="l19.32">     if (nRead == 0)</span>
<a href="#l19.33"></a><span id="l19.33">       break;</span>
<a href="#l19.34"></a><span id="l19.34"> </span>
<a href="#l19.35"></a><span id="l19.35">     uint32_t bytesWritten;</span>
<a href="#l19.36"></a><span id="l19.36">     // Check the number of bytes actually written to the stream.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/mailnews/mime/src/mimemrel.cpp</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/mailnews/mime/src/mimemrel.cpp</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -1083,28 +1083,27 @@ MimeMultipartRelated_parse_eof (MimeObje</span>
<a href="#l20.4"></a><span id="l20.4">     status = body-&gt;clazz-&gt;parse_buffer(relobj-&gt;head_buffer,</span>
<a href="#l20.5"></a><span id="l20.5">                          relobj-&gt;head_buffer_fp,</span>
<a href="#l20.6"></a><span id="l20.6">                          body);</span>
<a href="#l20.7"></a><span id="l20.7">   }</span>
<a href="#l20.8"></a><span id="l20.8">   else if (relobj-&gt;file_buffer)</span>
<a href="#l20.9"></a><span id="l20.9">   {</span>
<a href="#l20.10"></a><span id="l20.10">     /* Read it off disk. */</span>
<a href="#l20.11"></a><span id="l20.11">     char *buf;</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineminus">-    int32_t buf_size = 10 * 1024;  /* 10k; tune this? */</span>
<a href="#l20.13"></a><span id="l20.13"> </span>
<a href="#l20.14"></a><span id="l20.14">     PR_ASSERT(relobj-&gt;head_buffer_size == 0 &amp;&amp;</span>
<a href="#l20.15"></a><span id="l20.15">           relobj-&gt;head_buffer_fp == 0);</span>
<a href="#l20.16"></a><span id="l20.16">     PR_ASSERT(relobj-&gt;file_buffer);</span>
<a href="#l20.17"></a><span id="l20.17">     if (!relobj-&gt;file_buffer)</span>
<a href="#l20.18"></a><span id="l20.18">     {</span>
<a href="#l20.19"></a><span id="l20.19">       status = -1;</span>
<a href="#l20.20"></a><span id="l20.20">       goto FAIL;</span>
<a href="#l20.21"></a><span id="l20.21">     }</span>
<a href="#l20.22"></a><span id="l20.22"> </span>
<a href="#l20.23"></a><span id="l20.23" class="difflineminus">-    buf = (char *) PR_MALLOC(buf_size);</span>
<a href="#l20.24"></a><span id="l20.24" class="difflineplus">+    buf = (char *) PR_MALLOC(FILE_IO_BUFFER_SIZE);</span>
<a href="#l20.25"></a><span id="l20.25">     if (!buf)</span>
<a href="#l20.26"></a><span id="l20.26">     {</span>
<a href="#l20.27"></a><span id="l20.27">       status = MIME_OUT_OF_MEMORY;</span>
<a href="#l20.28"></a><span id="l20.28">       goto FAIL;</span>
<a href="#l20.29"></a><span id="l20.29">     }</span>
<a href="#l20.30"></a><span id="l20.30"> </span>
<a href="#l20.31"></a><span id="l20.31">     // First, close the output file to open the input file!</span>
<a href="#l20.32"></a><span id="l20.32">     if (relobj-&gt;output_file_stream)</span>
<a href="#l20.33"></a><span id="l20.33" class="difflineat">@@ -1116,17 +1115,17 @@ MimeMultipartRelated_parse_eof (MimeObje</span>
<a href="#l20.34"></a><span id="l20.34">       PR_Free(buf);</span>
<a href="#l20.35"></a><span id="l20.35">       status = MIME_UNABLE_TO_OPEN_TMP_FILE;</span>
<a href="#l20.36"></a><span id="l20.36">       goto FAIL;</span>
<a href="#l20.37"></a><span id="l20.37">     }</span>
<a href="#l20.38"></a><span id="l20.38"> </span>
<a href="#l20.39"></a><span id="l20.39">     while(1)</span>
<a href="#l20.40"></a><span id="l20.40">     {</span>
<a href="#l20.41"></a><span id="l20.41">       uint32_t bytesRead = 0;</span>
<a href="#l20.42"></a><span id="l20.42" class="difflineminus">-      rv = relobj-&gt;input_file_stream-&gt;Read(buf, buf_size - 1, &amp;bytesRead);</span>
<a href="#l20.43"></a><span id="l20.43" class="difflineplus">+      rv = relobj-&gt;input_file_stream-&gt;Read(buf, FILE_IO_BUFFER_SIZE - 1, &amp;bytesRead);</span>
<a href="#l20.44"></a><span id="l20.44">       if (NS_FAILED(rv) || !bytesRead)</span>
<a href="#l20.45"></a><span id="l20.45">       {</span>
<a href="#l20.46"></a><span id="l20.46">         status = NS_FAILED(rv) ? -1 : 0;</span>
<a href="#l20.47"></a><span id="l20.47">         break;</span>
<a href="#l20.48"></a><span id="l20.48">       }</span>
<a href="#l20.49"></a><span id="l20.49">       else</span>
<a href="#l20.50"></a><span id="l20.50">       {</span>
<a href="#l20.51"></a><span id="l20.51">         /* It would be really nice to be able to yield here, and let</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

