<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 28961:09f75ac5b05969661e8738050e3f58691689d1a1</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 09f75ac5b05969661e8738050e3f58691689d1a1" />
<meta property="og:url" content="/comm-central/rev/09f75ac5b05969661e8738050e3f58691689d1a1" />
<meta property="og:description" content="Bug 1551590 - OTR: improve notifications when a chat starts with a verification request. r=kaie" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 09f75ac5b05969661e8738050e3f58691689d1a1 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/09f75ac5b05969661e8738050e3f58691689d1a1">shortlog</a> |
<a href="/comm-central/log/09f75ac5b05969661e8738050e3f58691689d1a1">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/09f75ac5b05969661e8738050e3f58691689d1a1">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/09f75ac5b05969661e8738050e3f58691689d1a1">files</a> |
changeset |
<a href="/comm-central/raw-rev/09f75ac5b05969661e8738050e3f58691689d1a1">raw</a>  | <a href="/comm-central/archive/09f75ac5b05969661e8738050e3f58691689d1a1.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1551590">Bug 1551590</a> - OTR: improve notifications when a chat starts with a verification request. r=kaie
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#65;&#108;&#101;&#115;&#115;&#97;&#110;&#100;&#114;&#111;&#32;&#67;&#97;&#115;&#116;&#101;&#108;&#108;&#97;&#110;&#105;&#32;&#60;&#97;&#108;&#101;&#115;&#115;&#97;&#110;&#100;&#114;&#111;&#64;&#116;&#104;&#117;&#110;&#100;&#101;&#114;&#98;&#105;&#114;&#100;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Tue, 10 Mar 2020 22:53:51 +0200</td></tr>

<tr>
 <td>changeset 28961</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/09f75ac5b05969661e8738050e3f58691689d1a1">09f75ac5b05969661e8738050e3f58691689d1a1</a></td>
</tr>



<tr>
<td>parent 28960</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/d4e300e98f228b41d9ca84500f36e5d5cf2ec30b">d4e300e98f228b41d9ca84500f36e5d5cf2ec30b</a>
</td>
</tr>

<tr>
<td>child 28962</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/368f0e33482a39316f406aa428fbc10076429fa2">368f0e33482a39316f406aa428fbc10076429fa2</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=09f75ac5b05969661e8738050e3f58691689d1a1">17124</a></td></tr>
<tr><td>push user</td><td>mkmelin@iki.fi</td></tr>
<tr><td>push date</td><td class="date age">Tue, 10 Mar 2020 20:55:14 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@368f0e33482a [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=368f0e33482a39316f406aa428fbc10076429fa2">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=368f0e33482a39316f406aa428fbc10076429fa2&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=368f0e33482a39316f406aa428fbc10076429fa2&newProject=comm-central&newRevision=d4e300e98f228b41d9ca84500f36e5d5cf2ec30b&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=368f0e33482a39316f406aa428fbc10076429fa2&newProject=comm-central&newRevision=d4e300e98f228b41d9ca84500f36e5d5cf2ec30b&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=368f0e33482a39316f406aa428fbc10076429fa2&newProject=comm-central&newRevision=d4e300e98f228b41d9ca84500f36e5d5cf2ec30b&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28kaie%29&revcount=50">kaie</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1551590">1551590</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1551590">Bug 1551590</a> - OTR: improve notifications when a chat starts with a verification request. r=kaie</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/09f75ac5b05969661e8738050e3f58691689d1a1/chat/components/public/imIConversationsService.idl">chat/components/public/imIConversationsService.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/09f75ac5b05969661e8738050e3f58691689d1a1/chat/components/public/imIConversationsService.idl">file</a> |
<a href="/comm-central/annotate/09f75ac5b05969661e8738050e3f58691689d1a1/chat/components/public/imIConversationsService.idl">annotate</a> |
<a href="/comm-central/diff/09f75ac5b05969661e8738050e3f58691689d1a1/chat/components/public/imIConversationsService.idl">diff</a> |
<a href="/comm-central/comparison/09f75ac5b05969661e8738050e3f58691689d1a1/chat/components/public/imIConversationsService.idl">comparison</a> |
<a href="/comm-central/log/09f75ac5b05969661e8738050e3f58691689d1a1/chat/components/public/imIConversationsService.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/09f75ac5b05969661e8738050e3f58691689d1a1/chat/components/src/imConversations.jsm">chat/components/src/imConversations.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/09f75ac5b05969661e8738050e3f58691689d1a1/chat/components/src/imConversations.jsm">file</a> |
<a href="/comm-central/annotate/09f75ac5b05969661e8738050e3f58691689d1a1/chat/components/src/imConversations.jsm">annotate</a> |
<a href="/comm-central/diff/09f75ac5b05969661e8738050e3f58691689d1a1/chat/components/src/imConversations.jsm">diff</a> |
<a href="/comm-central/comparison/09f75ac5b05969661e8738050e3f58691689d1a1/chat/components/src/imConversations.jsm">comparison</a> |
<a href="/comm-central/log/09f75ac5b05969661e8738050e3f58691689d1a1/chat/components/src/imConversations.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/09f75ac5b05969661e8738050e3f58691689d1a1/chat/content/otr-auth.js">chat/content/otr-auth.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/09f75ac5b05969661e8738050e3f58691689d1a1/chat/content/otr-auth.js">file</a> |
<a href="/comm-central/annotate/09f75ac5b05969661e8738050e3f58691689d1a1/chat/content/otr-auth.js">annotate</a> |
<a href="/comm-central/diff/09f75ac5b05969661e8738050e3f58691689d1a1/chat/content/otr-auth.js">diff</a> |
<a href="/comm-central/comparison/09f75ac5b05969661e8738050e3f58691689d1a1/chat/content/otr-auth.js">comparison</a> |
<a href="/comm-central/log/09f75ac5b05969661e8738050e3f58691689d1a1/chat/content/otr-auth.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/09f75ac5b05969661e8738050e3f58691689d1a1/chat/content/otr/otrUI.ftl">chat/content/otr/otrUI.ftl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/09f75ac5b05969661e8738050e3f58691689d1a1/chat/content/otr/otrUI.ftl">file</a> |
<a href="/comm-central/annotate/09f75ac5b05969661e8738050e3f58691689d1a1/chat/content/otr/otrUI.ftl">annotate</a> |
<a href="/comm-central/diff/09f75ac5b05969661e8738050e3f58691689d1a1/chat/content/otr/otrUI.ftl">diff</a> |
<a href="/comm-central/comparison/09f75ac5b05969661e8738050e3f58691689d1a1/chat/content/otr/otrUI.ftl">comparison</a> |
<a href="/comm-central/log/09f75ac5b05969661e8738050e3f58691689d1a1/chat/content/otr/otrUI.ftl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/09f75ac5b05969661e8738050e3f58691689d1a1/chat/modules/OTRUI.jsm">chat/modules/OTRUI.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/09f75ac5b05969661e8738050e3f58691689d1a1/chat/modules/OTRUI.jsm">file</a> |
<a href="/comm-central/annotate/09f75ac5b05969661e8738050e3f58691689d1a1/chat/modules/OTRUI.jsm">annotate</a> |
<a href="/comm-central/diff/09f75ac5b05969661e8738050e3f58691689d1a1/chat/modules/OTRUI.jsm">diff</a> |
<a href="/comm-central/comparison/09f75ac5b05969661e8738050e3f58691689d1a1/chat/modules/OTRUI.jsm">comparison</a> |
<a href="/comm-central/log/09f75ac5b05969661e8738050e3f58691689d1a1/chat/modules/OTRUI.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/09f75ac5b05969661e8738050e3f58691689d1a1/mail/components/im/content/chat-conversation-info.js">mail/components/im/content/chat-conversation-info.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/09f75ac5b05969661e8738050e3f58691689d1a1/mail/components/im/content/chat-conversation-info.js">file</a> |
<a href="/comm-central/annotate/09f75ac5b05969661e8738050e3f58691689d1a1/mail/components/im/content/chat-conversation-info.js">annotate</a> |
<a href="/comm-central/diff/09f75ac5b05969661e8738050e3f58691689d1a1/mail/components/im/content/chat-conversation-info.js">diff</a> |
<a href="/comm-central/comparison/09f75ac5b05969661e8738050e3f58691689d1a1/mail/components/im/content/chat-conversation-info.js">comparison</a> |
<a href="/comm-central/log/09f75ac5b05969661e8738050e3f58691689d1a1/mail/components/im/content/chat-conversation-info.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/09f75ac5b05969661e8738050e3f58691689d1a1/mail/components/im/content/chat-conversation.js">mail/components/im/content/chat-conversation.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/09f75ac5b05969661e8738050e3f58691689d1a1/mail/components/im/content/chat-conversation.js">file</a> |
<a href="/comm-central/annotate/09f75ac5b05969661e8738050e3f58691689d1a1/mail/components/im/content/chat-conversation.js">annotate</a> |
<a href="/comm-central/diff/09f75ac5b05969661e8738050e3f58691689d1a1/mail/components/im/content/chat-conversation.js">diff</a> |
<a href="/comm-central/comparison/09f75ac5b05969661e8738050e3f58691689d1a1/mail/components/im/content/chat-conversation.js">comparison</a> |
<a href="/comm-central/log/09f75ac5b05969661e8738050e3f58691689d1a1/mail/components/im/content/chat-conversation.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/09f75ac5b05969661e8738050e3f58691689d1a1/mail/components/im/content/chat-imconv.js">mail/components/im/content/chat-imconv.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/09f75ac5b05969661e8738050e3f58691689d1a1/mail/components/im/content/chat-imconv.js">file</a> |
<a href="/comm-central/annotate/09f75ac5b05969661e8738050e3f58691689d1a1/mail/components/im/content/chat-imconv.js">annotate</a> |
<a href="/comm-central/diff/09f75ac5b05969661e8738050e3f58691689d1a1/mail/components/im/content/chat-imconv.js">diff</a> |
<a href="/comm-central/comparison/09f75ac5b05969661e8738050e3f58691689d1a1/mail/components/im/content/chat-imconv.js">comparison</a> |
<a href="/comm-central/log/09f75ac5b05969661e8738050e3f58691689d1a1/mail/components/im/content/chat-imconv.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/09f75ac5b05969661e8738050e3f58691689d1a1/mail/components/im/content/chat-messenger.js">mail/components/im/content/chat-messenger.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/09f75ac5b05969661e8738050e3f58691689d1a1/mail/components/im/content/chat-messenger.js">file</a> |
<a href="/comm-central/annotate/09f75ac5b05969661e8738050e3f58691689d1a1/mail/components/im/content/chat-messenger.js">annotate</a> |
<a href="/comm-central/diff/09f75ac5b05969661e8738050e3f58691689d1a1/mail/components/im/content/chat-messenger.js">diff</a> |
<a href="/comm-central/comparison/09f75ac5b05969661e8738050e3f58691689d1a1/mail/components/im/content/chat-messenger.js">comparison</a> |
<a href="/comm-central/log/09f75ac5b05969661e8738050e3f58691689d1a1/mail/components/im/content/chat-messenger.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/09f75ac5b05969661e8738050e3f58691689d1a1/mail/components/im/content/imAccounts.js">mail/components/im/content/imAccounts.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/09f75ac5b05969661e8738050e3f58691689d1a1/mail/components/im/content/imAccounts.js">file</a> |
<a href="/comm-central/annotate/09f75ac5b05969661e8738050e3f58691689d1a1/mail/components/im/content/imAccounts.js">annotate</a> |
<a href="/comm-central/diff/09f75ac5b05969661e8738050e3f58691689d1a1/mail/components/im/content/imAccounts.js">diff</a> |
<a href="/comm-central/comparison/09f75ac5b05969661e8738050e3f58691689d1a1/mail/components/im/content/imAccounts.js">comparison</a> |
<a href="/comm-central/log/09f75ac5b05969661e8738050e3f58691689d1a1/mail/components/im/content/imAccounts.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/09f75ac5b05969661e8738050e3f58691689d1a1/mail/components/im/modules/chatNotifications.jsm">mail/components/im/modules/chatNotifications.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/09f75ac5b05969661e8738050e3f58691689d1a1/mail/components/im/modules/chatNotifications.jsm">file</a> |
<a href="/comm-central/annotate/09f75ac5b05969661e8738050e3f58691689d1a1/mail/components/im/modules/chatNotifications.jsm">annotate</a> |
<a href="/comm-central/diff/09f75ac5b05969661e8738050e3f58691689d1a1/mail/components/im/modules/chatNotifications.jsm">diff</a> |
<a href="/comm-central/comparison/09f75ac5b05969661e8738050e3f58691689d1a1/mail/components/im/modules/chatNotifications.jsm">comparison</a> |
<a href="/comm-central/log/09f75ac5b05969661e8738050e3f58691689d1a1/mail/components/im/modules/chatNotifications.jsm">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/chat/components/public/imIConversationsService.idl</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/chat/components/public/imIConversationsService.idl</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -13,27 +13,34 @@ interface imIMessage;</span>
<a href="#l1.4"></a><span id="l1.4"> interface imIConversation: prplIConversation {</span>
<a href="#l1.5"></a><span id="l1.5">   // Will be null for MUCs and IMs from people not in the contacts list.</span>
<a href="#l1.6"></a><span id="l1.6">   readonly attribute imIContact contact;</span>
<a href="#l1.7"></a><span id="l1.7"> </span>
<a href="#l1.8"></a><span id="l1.8">   // Write a system message into the conversation.</span>
<a href="#l1.9"></a><span id="l1.9">   // Note: this will not be logged.</span>
<a href="#l1.10"></a><span id="l1.10">   void systemMessage(in AUTF8String aMessage, [optional] in boolean aIsError);</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+  // Write a system message into the conversation and trigger the udpate of the</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+  // notification counter during an off-the-record authentication request.</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+  // Note: this will not be logged.</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+  void notificationOTR(in AUTF8String aMessage);</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineplus">+</span>
<a href="#l1.17"></a><span id="l1.17">   attribute prplIConversation target;</span>
<a href="#l1.18"></a><span id="l1.18"> </span>
<a href="#l1.19"></a><span id="l1.19">   // Number of unread messages (all messages, including system</span>
<a href="#l1.20"></a><span id="l1.20">   // messages are counted).</span>
<a href="#l1.21"></a><span id="l1.21">   readonly attribute unsigned long unreadMessageCount;</span>
<a href="#l1.22"></a><span id="l1.22">   // Number of unread incoming messages targeted at the user (= IMs or</span>
<a href="#l1.23"></a><span id="l1.23">   // message containing the user's nick in MUCs).</span>
<a href="#l1.24"></a><span id="l1.24">   readonly attribute unsigned long unreadTargetedMessageCount;</span>
<a href="#l1.25"></a><span id="l1.25">   // Number of unread incoming messages (both targeted and untargeted</span>
<a href="#l1.26"></a><span id="l1.26">   // messages are counted).</span>
<a href="#l1.27"></a><span id="l1.27">   readonly attribute unsigned long unreadIncomingMessageCount;</span>
<a href="#l1.28"></a><span id="l1.28" class="difflineplus">+  // Number of unread off-the-record authentication requests.</span>
<a href="#l1.29"></a><span id="l1.29" class="difflineplus">+  readonly attribute unsigned long unreadOTRNotificationCount;</span>
<a href="#l1.30"></a><span id="l1.30">   // Reset all unread message counts.</span>
<a href="#l1.31"></a><span id="l1.31">   void markAsRead();</span>
<a href="#l1.32"></a><span id="l1.32"> </span>
<a href="#l1.33"></a><span id="l1.33">   // Can be used instead of the topic when no topic is set.</span>
<a href="#l1.34"></a><span id="l1.34">   readonly attribute AUTF8String noTopicString;</span>
<a href="#l1.35"></a><span id="l1.35"> </span>
<a href="#l1.36"></a><span id="l1.36">   // Call this to give the core an opportunity to close an inactive</span>
<a href="#l1.37"></a><span id="l1.37">   // conversation.  If the conversation is a left MUC or an IM</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/chat/components/src/imConversations.jsm</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/chat/components/src/imConversations.jsm</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -244,20 +244,25 @@ UIConversation.prototype = {</span>
<a href="#l2.4"></a><span id="l2.4">   _unreadTargetedMessageCount: 0,</span>
<a href="#l2.5"></a><span id="l2.5">   get unreadTargetedMessageCount() {</span>
<a href="#l2.6"></a><span id="l2.6">     return this._unreadTargetedMessageCount;</span>
<a href="#l2.7"></a><span id="l2.7">   },</span>
<a href="#l2.8"></a><span id="l2.8">   _unreadIncomingMessageCount: 0,</span>
<a href="#l2.9"></a><span id="l2.9">   get unreadIncomingMessageCount() {</span>
<a href="#l2.10"></a><span id="l2.10">     return this._unreadIncomingMessageCount;</span>
<a href="#l2.11"></a><span id="l2.11">   },</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+  _unreadOTRNotificationCount: 0,</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+  get unreadOTRNotificationCount() {</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+    return this._unreadOTRNotificationCount;</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+  },</span>
<a href="#l2.16"></a><span id="l2.16">   markAsRead() {</span>
<a href="#l2.17"></a><span id="l2.17">     delete this._unreadMessageCount;</span>
<a href="#l2.18"></a><span id="l2.18">     delete this._unreadTargetedMessageCount;</span>
<a href="#l2.19"></a><span id="l2.19">     delete this._unreadIncomingMessageCount;</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineplus">+    delete this._unreadOTRNotificationCount;</span>
<a href="#l2.21"></a><span id="l2.21">     this._notifyUnreadCountChanged();</span>
<a href="#l2.22"></a><span id="l2.22">   },</span>
<a href="#l2.23"></a><span id="l2.23">   _lastNotifiedUnreadCount: 0,</span>
<a href="#l2.24"></a><span id="l2.24">   _notifyUnreadCountChanged() {</span>
<a href="#l2.25"></a><span id="l2.25">     if (this._unreadIncomingMessageCount == this._lastNotifiedUnreadCount) {</span>
<a href="#l2.26"></a><span id="l2.26">       return;</span>
<a href="#l2.27"></a><span id="l2.27">     }</span>
<a href="#l2.28"></a><span id="l2.28"> </span>
<a href="#l2.29"></a><span id="l2.29" class="difflineat">@@ -440,16 +445,28 @@ UIConversation.prototype = {</span>
<a href="#l2.30"></a><span id="l2.30">     this.notifyObservers(aSubject, aTopic, aData);</span>
<a href="#l2.31"></a><span id="l2.31">   },</span>
<a href="#l2.32"></a><span id="l2.32"> </span>
<a href="#l2.33"></a><span id="l2.33">   systemMessage(aText, aIsError) {</span>
<a href="#l2.34"></a><span id="l2.34">     let flags = { system: true, noLog: true, error: !!aIsError };</span>
<a href="#l2.35"></a><span id="l2.35">     new Message(&quot;system&quot;, aText, flags).conversation = this;</span>
<a href="#l2.36"></a><span id="l2.36">   },</span>
<a href="#l2.37"></a><span id="l2.37"> </span>
<a href="#l2.38"></a><span id="l2.38" class="difflineplus">+  notificationOTR(aText) {</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineplus">+    this._unreadOTRNotificationCount++;</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineplus">+    this.systemMessage(aText);</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineplus">+    for (let observer of this._observers) {</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineplus">+      observer.observe(</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineplus">+        this,</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineplus">+        &quot;unread-message-count-changed&quot;,</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineplus">+        this._unreadOTRNotificationCount.toString()</span>
<a href="#l2.46"></a><span id="l2.46" class="difflineplus">+      );</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineplus">+    }</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineplus">+  },</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineplus">+</span>
<a href="#l2.50"></a><span id="l2.50">   // prplIConversation</span>
<a href="#l2.51"></a><span id="l2.51">   get isChat() {</span>
<a href="#l2.52"></a><span id="l2.52">     return this.target.isChat;</span>
<a href="#l2.53"></a><span id="l2.53">   },</span>
<a href="#l2.54"></a><span id="l2.54">   get account() {</span>
<a href="#l2.55"></a><span id="l2.55">     return this.target.account;</span>
<a href="#l2.56"></a><span id="l2.56">   },</span>
<a href="#l2.57"></a><span id="l2.57">   get name() {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/chat/content/otr-auth.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/chat/content/otr-auth.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -164,16 +164,23 @@ var otrAuth = {</span>
<a href="#l3.4"></a><span id="l3.4">     }</span>
<a href="#l3.5"></a><span id="l3.5">     return true;</span>
<a href="#l3.6"></a><span id="l3.6">   },</span>
<a href="#l3.7"></a><span id="l3.7"> </span>
<a href="#l3.8"></a><span id="l3.8">   cancel() {</span>
<a href="#l3.9"></a><span id="l3.9">     if (mode === &quot;ask&quot;) {</span>
<a href="#l3.10"></a><span id="l3.10">       let context = OTR.getContext(uiConv.target);</span>
<a href="#l3.11"></a><span id="l3.11">       OTR.abortSMP(context);</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+      // Close the ask-auth notification if it was previously triggered.</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+      OTR.notifyObservers(</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+        {</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+          context,</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+        },</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+        &quot;otr:cancel-ask-auth&quot;</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineplus">+      );</span>
<a href="#l3.19"></a><span id="l3.19">     }</span>
<a href="#l3.20"></a><span id="l3.20">   },</span>
<a href="#l3.21"></a><span id="l3.21"> </span>
<a href="#l3.22"></a><span id="l3.22">   oninput(e) {</span>
<a href="#l3.23"></a><span id="l3.23">     document</span>
<a href="#l3.24"></a><span id="l3.24">       .getElementById(&quot;otrAuthDialog&quot;)</span>
<a href="#l3.25"></a><span id="l3.25">       .getButton(&quot;accept&quot;).disabled = !e.value;</span>
<a href="#l3.26"></a><span id="l3.26">   },</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/chat/content/otr/otrUI.ftl</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/chat/content/otr/otrUI.ftl</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -58,16 +58,20 @@ state-finished = { $name } has ended the</span>
<a href="#l4.4"></a><span id="l4.4"> </span>
<a href="#l4.5"></a><span id="l4.5"> state-not_private-label = Insecure</span>
<a href="#l4.6"></a><span id="l4.6"> state-unverified-label = Unverified</span>
<a href="#l4.7"></a><span id="l4.7"> state-private-label = Private</span>
<a href="#l4.8"></a><span id="l4.8"> state-finished-label = Finished</span>
<a href="#l4.9"></a><span id="l4.9"> </span>
<a href="#l4.10"></a><span id="l4.10"> # Variables:</span>
<a href="#l4.11"></a><span id="l4.11"> #   $name (String) - the screen name of a chat contact person</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+verify-request = { $name } requested the verification of your identity.</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+# Variables:</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+#   $name (String) - the screen name of a chat contact person</span>
<a href="#l4.16"></a><span id="l4.16"> afterauth-private = You have verified the identity of { $name }.</span>
<a href="#l4.17"></a><span id="l4.17"> </span>
<a href="#l4.18"></a><span id="l4.18"> # Variables:</span>
<a href="#l4.19"></a><span id="l4.19"> #   $name (String) - the screen name of a chat contact person</span>
<a href="#l4.20"></a><span id="l4.20"> afterauth-unverified = The identity of { $name } has not been verified.</span>
<a href="#l4.21"></a><span id="l4.21"> </span>
<a href="#l4.22"></a><span id="l4.22"> verify-title = Verify your contact's identity</span>
<a href="#l4.23"></a><span id="l4.23"> error-title = Error</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/chat/modules/OTRUI.jsm</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/chat/modules/OTRUI.jsm</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -252,16 +252,17 @@ var OTRUI = {</span>
<a href="#l5.4"></a><span id="l5.4">     this.debug = Services.prefs.getBoolPref(&quot;chat.otr.trace&quot;, false);</span>
<a href="#l5.5"></a><span id="l5.5"> </span>
<a href="#l5.6"></a><span id="l5.6">     OTR.init({});</span>
<a href="#l5.7"></a><span id="l5.7">     if (!OTR.libLoaded) {</span>
<a href="#l5.8"></a><span id="l5.8">       return;</span>
<a href="#l5.9"></a><span id="l5.9">     }</span>
<a href="#l5.10"></a><span id="l5.10"> </span>
<a href="#l5.11"></a><span id="l5.11">     this.enabled = true;</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+    this.notificationbox = null;</span>
<a href="#l5.13"></a><span id="l5.13"> </span>
<a href="#l5.14"></a><span id="l5.14">     OTR.addObserver(OTRUI);</span>
<a href="#l5.15"></a><span id="l5.15">     OTR.loadFiles()</span>
<a href="#l5.16"></a><span id="l5.16">       .then(function() {</span>
<a href="#l5.17"></a><span id="l5.17">         Services.obs.addObserver(OTR, &quot;new-ui-conversation&quot;);</span>
<a href="#l5.18"></a><span id="l5.18">         // Disabled until #76 is resolved.</span>
<a href="#l5.19"></a><span id="l5.19">         // Services.obs.addObserver(OTRUI, &quot;contact-added&quot;, false);</span>
<a href="#l5.20"></a><span id="l5.20">         Services.obs.addObserver(OTRUI, &quot;account-added&quot;);</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineat">@@ -474,19 +475,62 @@ var OTRUI = {</span>
<a href="#l5.22"></a><span id="l5.22">   },</span>
<a href="#l5.23"></a><span id="l5.23"> </span>
<a href="#l5.24"></a><span id="l5.24">   askAuth(aObject) {</span>
<a href="#l5.25"></a><span id="l5.25">     let uiConv = OTR.getUIConvFromContext(aObject.context);</span>
<a href="#l5.26"></a><span id="l5.26">     if (!uiConv) {</span>
<a href="#l5.27"></a><span id="l5.27">       return;</span>
<a href="#l5.28"></a><span id="l5.28">     }</span>
<a href="#l5.29"></a><span id="l5.29"> </span>
<a href="#l5.30"></a><span id="l5.30" class="difflineplus">+    let name = uiConv.target.normalizedName;</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineplus">+    let msg = _strArgs(&quot;verify-request&quot;, { name });</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineplus">+    // Trigger the udpate of the unread message counter.</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineplus">+    uiConv.notificationOTR(msg);</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineplus">+    Services.obs.notifyObservers(uiConv, &quot;new-otr-verification-request&quot;);</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineplus">+</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineplus">+    // Trigger the inline notification.</span>
<a href="#l5.37"></a><span id="l5.37">     let window = this.globalDoc.defaultView;</span>
<a href="#l5.38"></a><span id="l5.38" class="difflineminus">-    let name = uiConv.target.normalizedName;</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineminus">-    OTRUI.openAuth(window, name, &quot;ask&quot;, uiConv, aObject);</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineplus">+    let buttons = [</span>
<a href="#l5.41"></a><span id="l5.41" class="difflineplus">+      {</span>
<a href="#l5.42"></a><span id="l5.42" class="difflineplus">+        label: _str(&quot;finger-verify&quot;),</span>
<a href="#l5.43"></a><span id="l5.43" class="difflineplus">+        accessKey: _str(&quot;finger-verify-accessKey&quot;),</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineplus">+        callback() {</span>
<a href="#l5.45"></a><span id="l5.45" class="difflineplus">+          OTRUI.openAuth(window, name, &quot;ask&quot;, uiConv, aObject);</span>
<a href="#l5.46"></a><span id="l5.46" class="difflineplus">+          // prevent closing of notification bar when the button is hit</span>
<a href="#l5.47"></a><span id="l5.47" class="difflineplus">+          return true;</span>
<a href="#l5.48"></a><span id="l5.48" class="difflineplus">+        },</span>
<a href="#l5.49"></a><span id="l5.49" class="difflineplus">+      },</span>
<a href="#l5.50"></a><span id="l5.50" class="difflineplus">+    ];</span>
<a href="#l5.51"></a><span id="l5.51" class="difflineplus">+</span>
<a href="#l5.52"></a><span id="l5.52" class="difflineplus">+    let mainWindow = Services.wm.getMostRecentWindow(&quot;mail:3pane&quot;);</span>
<a href="#l5.53"></a><span id="l5.53" class="difflineplus">+    this.notificationbox = mainWindow.chatHandler.msgNotificationBar;</span>
<a href="#l5.54"></a><span id="l5.54" class="difflineplus">+</span>
<a href="#l5.55"></a><span id="l5.55" class="difflineplus">+    let priority = this.globalBox.PRIORITY_WARNING_MEDIUM;</span>
<a href="#l5.56"></a><span id="l5.56" class="difflineplus">+    this.notificationbox.appendNotification(</span>
<a href="#l5.57"></a><span id="l5.57" class="difflineplus">+      msg,</span>
<a href="#l5.58"></a><span id="l5.58" class="difflineplus">+      name,</span>
<a href="#l5.59"></a><span id="l5.59" class="difflineplus">+      null,</span>
<a href="#l5.60"></a><span id="l5.60" class="difflineplus">+      priority,</span>
<a href="#l5.61"></a><span id="l5.61" class="difflineplus">+      buttons,</span>
<a href="#l5.62"></a><span id="l5.62" class="difflineplus">+      null</span>
<a href="#l5.63"></a><span id="l5.63" class="difflineplus">+    );</span>
<a href="#l5.64"></a><span id="l5.64" class="difflineplus">+  },</span>
<a href="#l5.65"></a><span id="l5.65" class="difflineplus">+</span>
<a href="#l5.66"></a><span id="l5.66" class="difflineplus">+  closeAskAuthNotification(aObject) {</span>
<a href="#l5.67"></a><span id="l5.67" class="difflineplus">+    if (!this.notificationbox) {</span>
<a href="#l5.68"></a><span id="l5.68" class="difflineplus">+      return;</span>
<a href="#l5.69"></a><span id="l5.69" class="difflineplus">+    }</span>
<a href="#l5.70"></a><span id="l5.70" class="difflineplus">+</span>
<a href="#l5.71"></a><span id="l5.71" class="difflineplus">+    let name = aObject.context.username;</span>
<a href="#l5.72"></a><span id="l5.72" class="difflineplus">+    let notification = this.notificationbox.getNotificationWithValue(name);</span>
<a href="#l5.73"></a><span id="l5.73" class="difflineplus">+    if (!notification) {</span>
<a href="#l5.74"></a><span id="l5.74" class="difflineplus">+      return;</span>
<a href="#l5.75"></a><span id="l5.75" class="difflineplus">+    }</span>
<a href="#l5.76"></a><span id="l5.76" class="difflineplus">+</span>
<a href="#l5.77"></a><span id="l5.77" class="difflineplus">+    this.notificationbox.removeNotification(notification);</span>
<a href="#l5.78"></a><span id="l5.78">   },</span>
<a href="#l5.79"></a><span id="l5.79"> </span>
<a href="#l5.80"></a><span id="l5.80">   closeUnverified(context) {</span>
<a href="#l5.81"></a><span id="l5.81">     let uiConv = OTR.getUIConvFromContext(context);</span>
<a href="#l5.82"></a><span id="l5.82">     if (!uiConv) {</span>
<a href="#l5.83"></a><span id="l5.83">       return;</span>
<a href="#l5.84"></a><span id="l5.84">     }</span>
<a href="#l5.85"></a><span id="l5.85"> </span>
<a href="#l5.86"></a><span id="l5.86" class="difflineat">@@ -625,17 +669,17 @@ var OTRUI = {</span>
<a href="#l5.87"></a><span id="l5.87">     let prevNotification = OTRUI.globalBox.getNotificationWithValue(</span>
<a href="#l5.88"></a><span id="l5.88">       context.username</span>
<a href="#l5.89"></a><span id="l5.89">     );</span>
<a href="#l5.90"></a><span id="l5.90">     if (prevNotification) {</span>
<a href="#l5.91"></a><span id="l5.91">       prevNotification.close();</span>
<a href="#l5.92"></a><span id="l5.92">     }</span>
<a href="#l5.93"></a><span id="l5.93">   },</span>
<a href="#l5.94"></a><span id="l5.94"> </span>
<a href="#l5.95"></a><span id="l5.95" class="difflineminus">-  notifyVerification(context, key, cancelable) {</span>
<a href="#l5.96"></a><span id="l5.96" class="difflineplus">+  notifyVerification(context, key, cancelable, verifiable) {</span>
<a href="#l5.97"></a><span id="l5.97">     let uiConv = OTR.getUIConvFromContext(context);</span>
<a href="#l5.98"></a><span id="l5.98">     if (!uiConv) {</span>
<a href="#l5.99"></a><span id="l5.99">       return;</span>
<a href="#l5.100"></a><span id="l5.100">     }</span>
<a href="#l5.101"></a><span id="l5.101"> </span>
<a href="#l5.102"></a><span id="l5.102">     // TODO: maybe update the .label property on the notification instead</span>
<a href="#l5.103"></a><span id="l5.103">     // of closing it ... although, buttons need to be updated too.</span>
<a href="#l5.104"></a><span id="l5.104">     OTRUI.closeVerification(context);</span>
<a href="#l5.105"></a><span id="l5.105" class="difflineat">@@ -651,16 +695,33 @@ var OTRUI = {</span>
<a href="#l5.106"></a><span id="l5.106">           callback() {</span>
<a href="#l5.107"></a><span id="l5.107">             let context = OTR.getContext(uiConv.target);</span>
<a href="#l5.108"></a><span id="l5.108">             OTR.abortSMP(context);</span>
<a href="#l5.109"></a><span id="l5.109">           },</span>
<a href="#l5.110"></a><span id="l5.110">         },</span>
<a href="#l5.111"></a><span id="l5.111">       ];</span>
<a href="#l5.112"></a><span id="l5.112">     }</span>
<a href="#l5.113"></a><span id="l5.113"> </span>
<a href="#l5.114"></a><span id="l5.114" class="difflineplus">+    if (verifiable) {</span>
<a href="#l5.115"></a><span id="l5.115" class="difflineplus">+      let window = this.globalDoc.defaultView;</span>
<a href="#l5.116"></a><span id="l5.116" class="difflineplus">+</span>
<a href="#l5.117"></a><span id="l5.117" class="difflineplus">+      buttons = [</span>
<a href="#l5.118"></a><span id="l5.118" class="difflineplus">+        {</span>
<a href="#l5.119"></a><span id="l5.119" class="difflineplus">+          label: _str(&quot;finger-verify&quot;),</span>
<a href="#l5.120"></a><span id="l5.120" class="difflineplus">+          accessKey: _str(&quot;finger-verify-accessKey&quot;),</span>
<a href="#l5.121"></a><span id="l5.121" class="difflineplus">+          callback() {</span>
<a href="#l5.122"></a><span id="l5.122" class="difflineplus">+            let name = uiConv.target.normalizedName;</span>
<a href="#l5.123"></a><span id="l5.123" class="difflineplus">+            OTRUI.openAuth(window, name, &quot;start&quot;, uiConv);</span>
<a href="#l5.124"></a><span id="l5.124" class="difflineplus">+            // prevent closing of notification bar when the button is hit</span>
<a href="#l5.125"></a><span id="l5.125" class="difflineplus">+            return true;</span>
<a href="#l5.126"></a><span id="l5.126" class="difflineplus">+          },</span>
<a href="#l5.127"></a><span id="l5.127" class="difflineplus">+        },</span>
<a href="#l5.128"></a><span id="l5.128" class="difflineplus">+      ];</span>
<a href="#l5.129"></a><span id="l5.129" class="difflineplus">+    }</span>
<a href="#l5.130"></a><span id="l5.130" class="difflineplus">+</span>
<a href="#l5.131"></a><span id="l5.131">     // higher priority to overlay the current notifyUnverified</span>
<a href="#l5.132"></a><span id="l5.132">     let priority = this.globalBox.PRIORITY_WARNING_HIGH;</span>
<a href="#l5.133"></a><span id="l5.133">     OTRUI.closeUnverified(context);</span>
<a href="#l5.134"></a><span id="l5.134">     this.globalBox.appendNotification(</span>
<a href="#l5.135"></a><span id="l5.135">       msg,</span>
<a href="#l5.136"></a><span id="l5.136">       context.username,</span>
<a href="#l5.137"></a><span id="l5.137">       null,</span>
<a href="#l5.138"></a><span id="l5.138">       priority,</span>
<a href="#l5.139"></a><span id="l5.139" class="difflineat">@@ -670,38 +731,41 @@ var OTRUI = {</span>
<a href="#l5.140"></a><span id="l5.140"> </span>
<a href="#l5.141"></a><span id="l5.141">     this.updateNotificationUI(context, typeTitle, context.username, key);</span>
<a href="#l5.142"></a><span id="l5.142">   },</span>
<a href="#l5.143"></a><span id="l5.143"> </span>
<a href="#l5.144"></a><span id="l5.144">   updateAuth(aObj) {</span>
<a href="#l5.145"></a><span id="l5.145">     // let uiConv = OTR.getUIConvFromContext(aObj.context);</span>
<a href="#l5.146"></a><span id="l5.146">     if (!aObj.progress) {</span>
<a href="#l5.147"></a><span id="l5.147">       OTRUI.closeAuth(aObj.context);</span>
<a href="#l5.148"></a><span id="l5.148" class="difflineminus">-      OTRUI.notifyVerification(aObj.context, &quot;otr:auth-error&quot;, false);</span>
<a href="#l5.149"></a><span id="l5.149" class="difflineplus">+      OTRUI.notifyVerification(aObj.context, &quot;otr:auth-error&quot;, false, false);</span>
<a href="#l5.150"></a><span id="l5.150">     } else if (aObj.progress === 100) {</span>
<a href="#l5.151"></a><span id="l5.151">       let key;</span>
<a href="#l5.152"></a><span id="l5.152" class="difflineplus">+      let verifiable = false;</span>
<a href="#l5.153"></a><span id="l5.153">       if (aObj.success) {</span>
<a href="#l5.154"></a><span id="l5.154">         if (aObj.context.trust) {</span>
<a href="#l5.155"></a><span id="l5.155">           key = &quot;otr:auth-success&quot;;</span>
<a href="#l5.156"></a><span id="l5.156">           OTR.notifyTrust(aObj.context);</span>
<a href="#l5.157"></a><span id="l5.157">         } else {</span>
<a href="#l5.158"></a><span id="l5.158">           key = &quot;otr:auth-successThem&quot;;</span>
<a href="#l5.159"></a><span id="l5.159" class="difflineplus">+          verifiable = true;</span>
<a href="#l5.160"></a><span id="l5.160">         }</span>
<a href="#l5.161"></a><span id="l5.161">       } else {</span>
<a href="#l5.162"></a><span id="l5.162">         key = &quot;otr:auth-fail&quot;;</span>
<a href="#l5.163"></a><span id="l5.163">         if (!aObj.context.trust) {</span>
<a href="#l5.164"></a><span id="l5.164">           OTR.notifyTrust(aObj.context);</span>
<a href="#l5.165"></a><span id="l5.165">         }</span>
<a href="#l5.166"></a><span id="l5.166">       }</span>
<a href="#l5.167"></a><span id="l5.167" class="difflineminus">-      OTRUI.notifyVerification(aObj.context, key, false);</span>
<a href="#l5.168"></a><span id="l5.168" class="difflineplus">+      OTRUI.notifyVerification(aObj.context, key, false, verifiable);</span>
<a href="#l5.169"></a><span id="l5.169">     } else {</span>
<a href="#l5.170"></a><span id="l5.170">       // TODO: show the aObj.progress to the user with a</span>
<a href="#l5.171"></a><span id="l5.171">       //   &lt;progressmeter mode=&quot;determined&quot; value=&quot;10&quot; /&gt;</span>
<a href="#l5.172"></a><span id="l5.172" class="difflineminus">-      OTRUI.notifyVerification(aObj.context, &quot;otr:auth-waiting&quot;, true);</span>
<a href="#l5.173"></a><span id="l5.173" class="difflineplus">+      OTRUI.notifyVerification(aObj.context, &quot;otr:auth-waiting&quot;, true, false);</span>
<a href="#l5.174"></a><span id="l5.174">     }</span>
<a href="#l5.175"></a><span id="l5.175" class="difflineplus">+    OTRUI.closeAskAuthNotification(aObj);</span>
<a href="#l5.176"></a><span id="l5.176">   },</span>
<a href="#l5.177"></a><span id="l5.177"> </span>
<a href="#l5.178"></a><span id="l5.178">   onAccountCreated(acc) {</span>
<a href="#l5.179"></a><span id="l5.179">     let account = acc.normalizedName;</span>
<a href="#l5.180"></a><span id="l5.180">     let protocol = acc.protocol.normalizedName;</span>
<a href="#l5.181"></a><span id="l5.181">     Promise.resolve();</span>
<a href="#l5.182"></a><span id="l5.182">     if (OTR.privateKeyFingerprint(account, protocol) === null) {</span>
<a href="#l5.183"></a><span id="l5.183">       OTR.generatePrivateKey(account, protocol).catch(</span>
<a href="#l5.184"></a><span id="l5.184" class="difflineat">@@ -824,16 +888,19 @@ var OTRUI = {</span>
<a href="#l5.185"></a><span id="l5.185">         OTRUI.onContactAdded(aObject);</span>
<a href="#l5.186"></a><span id="l5.186">         break;</span>
<a href="#l5.187"></a><span id="l5.187">       case &quot;otr:auth-ask&quot;:</span>
<a href="#l5.188"></a><span id="l5.188">         OTRUI.askAuth(aObject);</span>
<a href="#l5.189"></a><span id="l5.189">         break;</span>
<a href="#l5.190"></a><span id="l5.190">       case &quot;otr:auth-update&quot;:</span>
<a href="#l5.191"></a><span id="l5.191">         OTRUI.updateAuth(aObject);</span>
<a href="#l5.192"></a><span id="l5.192">         break;</span>
<a href="#l5.193"></a><span id="l5.193" class="difflineplus">+      case &quot;otr:cancel-ask-auth&quot;:</span>
<a href="#l5.194"></a><span id="l5.194" class="difflineplus">+        OTRUI.closeAskAuthNotification(aObject);</span>
<a href="#l5.195"></a><span id="l5.195" class="difflineplus">+        break;</span>
<a href="#l5.196"></a><span id="l5.196">     }</span>
<a href="#l5.197"></a><span id="l5.197">   },</span>
<a href="#l5.198"></a><span id="l5.198"> </span>
<a href="#l5.199"></a><span id="l5.199">   initConv(binding) {</span>
<a href="#l5.200"></a><span id="l5.200">     OTR.addConversation(binding._conv);</span>
<a href="#l5.201"></a><span id="l5.201">     OTRUI.addButton(binding);</span>
<a href="#l5.202"></a><span id="l5.202">   },</span>
<a href="#l5.203"></a><span id="l5.203"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mail/components/im/content/chat-conversation-info.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mail/components/im/content/chat-conversation-info.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -77,18 +77,17 @@</span>
<a href="#l6.4"></a><span id="l6.4">                 &lt;image class=&quot;prplIcon&quot;&gt;&lt;/image&gt;</span>
<a href="#l6.5"></a><span id="l6.5">               &lt;/hbox&gt;</span>
<a href="#l6.6"></a><span id="l6.6">               &lt;description class=&quot;statusMessage&quot; crop=&quot;end&quot; flex=&quot;100000&quot;/&gt;</span>
<a href="#l6.7"></a><span id="l6.7">               &lt;html:input class=&quot;statusMessageInput input-inline&quot;</span>
<a href="#l6.8"></a><span id="l6.8">                           hidden=&quot;hidden&quot;/&gt;</span>
<a href="#l6.9"></a><span id="l6.9">             &lt;/stack&gt;</span>
<a href="#l6.10"></a><span id="l6.10">           &lt;/hbox&gt;</span>
<a href="#l6.11"></a><span id="l6.11">           &lt;hbox class=&quot;otr-container&quot;</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-                align=&quot;start&quot;</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-                valign=&quot;middle&quot;</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+                align=&quot;middle&quot;</span>
<a href="#l6.15"></a><span id="l6.15">                 hidden=&quot;true&quot;&gt;</span>
<a href="#l6.16"></a><span id="l6.16">             &lt;label class=&quot;otr-label&quot;</span>
<a href="#l6.17"></a><span id="l6.17">                    crop=&quot;end&quot;</span>
<a href="#l6.18"></a><span id="l6.18">                    data-l10n-id=&quot;state-label&quot;</span>
<a href="#l6.19"></a><span id="l6.19">                    flex=&quot;1&quot;/&gt;</span>
<a href="#l6.20"></a><span id="l6.20">             &lt;toolbarbutton id=&quot;otrButton&quot;</span>
<a href="#l6.21"></a><span id="l6.21">                            mode=&quot;dialog&quot;</span>
<a href="#l6.22"></a><span id="l6.22">                            class=&quot;otr-button&quot;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mail/components/im/content/chat-conversation.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mail/components/im/content/chat-conversation.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -168,46 +168,41 @@</span>
<a href="#l7.4"></a><span id="l7.4">       // Ratio textbox height / conversation height.</span>
<a href="#l7.5"></a><span id="l7.5">       // 0.1 means that the textbox's height is 10% of the conversation's height.</span>
<a href="#l7.6"></a><span id="l7.6">       this._TEXTBOX_RATIO = 0.1;</span>
<a href="#l7.7"></a><span id="l7.7"> </span>
<a href="#l7.8"></a><span id="l7.8">       this.setAttribute(&quot;orient&quot;, &quot;vertical&quot;);</span>
<a href="#l7.9"></a><span id="l7.9">       this.setAttribute(&quot;flex&quot;, &quot;1&quot;);</span>
<a href="#l7.10"></a><span id="l7.10">       this.classList.add(&quot;convBox&quot;);</span>
<a href="#l7.11"></a><span id="l7.11"> </span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-      this.convTop = document.createXULElement(&quot;hbox&quot;);</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+      this.convTop = document.createXULElement(&quot;vbox&quot;);</span>
<a href="#l7.14"></a><span id="l7.14">       this.convTop.setAttribute(&quot;flex&quot;, &quot;1&quot;);</span>
<a href="#l7.15"></a><span id="l7.15">       this.convTop.classList.add(&quot;conv-top&quot;);</span>
<a href="#l7.16"></a><span id="l7.16"> </span>
<a href="#l7.17"></a><span id="l7.17" class="difflineminus">-      this.notification = document.createXULElement(&quot;hbox&quot;);</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineminus">-      this.notification.setAttribute(&quot;flex&quot;, &quot;1&quot;);</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineminus">-</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineminus">-      let nbox = document.createXULElement(&quot;vbox&quot;);</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineminus">-      nbox.setAttribute(&quot;flex&quot;, &quot;1&quot;);</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineplus">+      this.notification = document.createXULElement(&quot;vbox&quot;);</span>
<a href="#l7.23"></a><span id="l7.23"> </span>
<a href="#l7.24"></a><span id="l7.24">       this.convBrowser = document.createXULElement(&quot;browser&quot;, {</span>
<a href="#l7.25"></a><span id="l7.25">         is: &quot;conversation-browser&quot;,</span>
<a href="#l7.26"></a><span id="l7.26">       });</span>
<a href="#l7.27"></a><span id="l7.27">       this.convBrowser.setAttribute(&quot;flex&quot;, &quot;1&quot;);</span>
<a href="#l7.28"></a><span id="l7.28">       this.convBrowser.setAttribute(&quot;type&quot;, &quot;content&quot;);</span>
<a href="#l7.29"></a><span id="l7.29"> </span>
<a href="#l7.30"></a><span id="l7.30">       this.progressBar = document.createElementNS(</span>
<a href="#l7.31"></a><span id="l7.31">         &quot;http://www.w3.org/1999/xhtml&quot;,</span>
<a href="#l7.32"></a><span id="l7.32">         &quot;progress&quot;</span>
<a href="#l7.33"></a><span id="l7.33">       );</span>
<a href="#l7.34"></a><span id="l7.34">       this.progressBar.setAttribute(&quot;hidden&quot;, &quot;hidden&quot;);</span>
<a href="#l7.35"></a><span id="l7.35"> </span>
<a href="#l7.36"></a><span id="l7.36">       this.findbar = document.createXULElement(&quot;findbar&quot;);</span>
<a href="#l7.37"></a><span id="l7.37">       this.findbar.setAttribute(&quot;reversed&quot;, &quot;true&quot;);</span>
<a href="#l7.38"></a><span id="l7.38"> </span>
<a href="#l7.39"></a><span id="l7.39" class="difflineminus">-      nbox.appendChild(this.convBrowser);</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineminus">-      nbox.appendChild(this.progressBar);</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineminus">-      nbox.appendChild(this.findbar);</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineminus">-      this.notification.appendChild(nbox);</span>
<a href="#l7.43"></a><span id="l7.43">       this.convTop.appendChild(this.notification);</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineplus">+      this.convTop.appendChild(this.convBrowser);</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineplus">+      this.convTop.appendChild(this.progressBar);</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineplus">+      this.convTop.appendChild(this.findbar);</span>
<a href="#l7.47"></a><span id="l7.47"> </span>
<a href="#l7.48"></a><span id="l7.48">       this.splitter = document.createXULElement(&quot;splitter&quot;);</span>
<a href="#l7.49"></a><span id="l7.49">       this.splitter.setAttribute(&quot;orient&quot;, &quot;vertical&quot;);</span>
<a href="#l7.50"></a><span id="l7.50">       this.splitter.classList.add(&quot;splitter&quot;);</span>
<a href="#l7.51"></a><span id="l7.51"> </span>
<a href="#l7.52"></a><span id="l7.52">       this.convStatusContainer = document.createXULElement(&quot;hbox&quot;);</span>
<a href="#l7.53"></a><span id="l7.53">       this.convStatusContainer.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l7.54"></a><span id="l7.54">       this.convStatusContainer.classList.add(&quot;conv-status-container&quot;);</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineat">@@ -290,25 +285,25 @@</span>
<a href="#l7.56"></a><span id="l7.56">         }</span>
<a href="#l7.57"></a><span id="l7.57">       };</span>
<a href="#l7.58"></a><span id="l7.58">       Services.prefs.addObserver(&quot;mail.spellcheck.inline&quot;, this.prefObserver);</span>
<a href="#l7.59"></a><span id="l7.59"> </span>
<a href="#l7.60"></a><span id="l7.60">       this.initializeAttributeInheritance();</span>
<a href="#l7.61"></a><span id="l7.61">     }</span>
<a href="#l7.62"></a><span id="l7.62"> </span>
<a href="#l7.63"></a><span id="l7.63">     get msgNotificationBar() {</span>
<a href="#l7.64"></a><span id="l7.64" class="difflineminus">-      delete this.msgNotificationBar;</span>
<a href="#l7.65"></a><span id="l7.65" class="difflineplus">+      delete this._msgNotificationBar;</span>
<a href="#l7.66"></a><span id="l7.66"> </span>
<a href="#l7.67"></a><span id="l7.67">       let newNotificationBox = new MozElements.NotificationBox(element =&gt; {</span>
<a href="#l7.68"></a><span id="l7.68">         element.setAttribute(&quot;flex&quot;, &quot;1&quot;);</span>
<a href="#l7.69"></a><span id="l7.69">         element.setAttribute(&quot;notificationside&quot;, &quot;top&quot;);</span>
<a href="#l7.70"></a><span id="l7.70" class="difflineminus">-        this.notification.append(element);</span>
<a href="#l7.71"></a><span id="l7.71" class="difflineplus">+        this.notification.prepend(element);</span>
<a href="#l7.72"></a><span id="l7.72">       });</span>
<a href="#l7.73"></a><span id="l7.73"> </span>
<a href="#l7.74"></a><span id="l7.74" class="difflineminus">-      return (this.msgNotificationBar = newNotificationBox);</span>
<a href="#l7.75"></a><span id="l7.75" class="difflineplus">+      return (this._msgNotificationBar = newNotificationBox);</span>
<a href="#l7.76"></a><span id="l7.76">     }</span>
<a href="#l7.77"></a><span id="l7.77"> </span>
<a href="#l7.78"></a><span id="l7.78">     destroy() {</span>
<a href="#l7.79"></a><span id="l7.79">       if (this._conv) {</span>
<a href="#l7.80"></a><span id="l7.80">         this._forgetConv();</span>
<a href="#l7.81"></a><span id="l7.81">       }</span>
<a href="#l7.82"></a><span id="l7.82"> </span>
<a href="#l7.83"></a><span id="l7.83">       if (&quot;MessageFormat&quot; in window) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mail/components/im/content/chat-imconv.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mail/components/im/content/chat-imconv.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -165,17 +165,19 @@</span>
<a href="#l8.4"></a><span id="l8.4">           chatHandler.updateTitle();</span>
<a href="#l8.5"></a><span id="l8.5">           chatHandler.updateChatButtonState();</span>
<a href="#l8.6"></a><span id="l8.6">         }</span>
<a href="#l8.7"></a><span id="l8.7">         this.setAttribute(&quot;unreadCount&quot;, &quot;0&quot;);</span>
<a href="#l8.8"></a><span id="l8.8">         this.setAttribute(&quot;unreadTargetedCount&quot;, &quot;0&quot;);</span>
<a href="#l8.9"></a><span id="l8.9">         this.removeAttribute(&quot;unread&quot;);</span>
<a href="#l8.10"></a><span id="l8.10">         this.removeAttribute(&quot;attention&quot;);</span>
<a href="#l8.11"></a><span id="l8.11">       } else {</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-        let unreadCount = this.conv.unreadIncomingMessageCount;</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+        let unreadCount =</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineplus">+          this.conv.unreadIncomingMessageCount +</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineplus">+          this.conv.unreadOTRNotificationCount;</span>
<a href="#l8.16"></a><span id="l8.16">         let directedMessages = unreadCount;</span>
<a href="#l8.17"></a><span id="l8.17">         if (unreadCount) {</span>
<a href="#l8.18"></a><span id="l8.18">           this.setAttribute(&quot;unread&quot;, &quot;true&quot;);</span>
<a href="#l8.19"></a><span id="l8.19">           if (this.conv.isChat) {</span>
<a href="#l8.20"></a><span id="l8.20">             directedMessages = this.conv.unreadTargetedMessageCount;</span>
<a href="#l8.21"></a><span id="l8.21">             if (directedMessages) {</span>
<a href="#l8.22"></a><span id="l8.22">               this.setAttribute(&quot;attention&quot;, &quot;true&quot;);</span>
<a href="#l8.23"></a><span id="l8.23">             }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mail/components/im/content/chat-messenger.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mail/components/im/content/chat-messenger.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -402,24 +402,24 @@ var chatTabType = {</span>
<a href="#l9.4"></a><span id="l9.4">     return null;</span>
<a href="#l9.5"></a><span id="l9.5">   },</span>
<a href="#l9.6"></a><span id="l9.6"> </span>
<a href="#l9.7"></a><span id="l9.7">   saveTabState(aTab) {},</span>
<a href="#l9.8"></a><span id="l9.8"> };</span>
<a href="#l9.9"></a><span id="l9.9"> </span>
<a href="#l9.10"></a><span id="l9.10"> var chatHandler = {</span>
<a href="#l9.11"></a><span id="l9.11">   get msgNotificationBar() {</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-    delete this.msgNotificationBar;</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+    delete this._msgNotificationBar;</span>
<a href="#l9.14"></a><span id="l9.14"> </span>
<a href="#l9.15"></a><span id="l9.15">     let newNotificationBox = new MozElements.NotificationBox(element =&gt; {</span>
<a href="#l9.16"></a><span id="l9.16">       element.setAttribute(&quot;notificationside&quot;, &quot;top&quot;);</span>
<a href="#l9.17"></a><span id="l9.17">       document.getElementById(&quot;chat-notification-top&quot;).prepend(element);</span>
<a href="#l9.18"></a><span id="l9.18">     });</span>
<a href="#l9.19"></a><span id="l9.19"> </span>
<a href="#l9.20"></a><span id="l9.20" class="difflineminus">-    return (this.msgNotificationBar = newNotificationBox);</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineplus">+    return (this._msgNotificationBar = newNotificationBox);</span>
<a href="#l9.22"></a><span id="l9.22">   },</span>
<a href="#l9.23"></a><span id="l9.23"> </span>
<a href="#l9.24"></a><span id="l9.24">   _addConversation(aConv) {</span>
<a href="#l9.25"></a><span id="l9.25">     let list = document.getElementById(&quot;contactlistbox&quot;);</span>
<a href="#l9.26"></a><span id="l9.26">     let convs = document.getElementById(&quot;conversationsGroup&quot;);</span>
<a href="#l9.27"></a><span id="l9.27">     let selectedItem = list.selectedItem;</span>
<a href="#l9.28"></a><span id="l9.28">     let shouldSelect =</span>
<a href="#l9.29"></a><span id="l9.29">       gChatTab &amp;&amp;</span>
<a href="#l9.30"></a><span id="l9.30" class="difflineat">@@ -471,48 +471,56 @@ var chatHandler = {</span>
<a href="#l9.31"></a><span id="l9.31">   _notifiedUnreadCount: 0,</span>
<a href="#l9.32"></a><span id="l9.32">   _updateChatButtonState() {</span>
<a href="#l9.33"></a><span id="l9.33">     delete this._chatButtonUpdatePending;</span>
<a href="#l9.34"></a><span id="l9.34">     let chatButton = document.getElementById(&quot;button-chat&quot;);</span>
<a href="#l9.35"></a><span id="l9.35">     if (!chatButton) {</span>
<a href="#l9.36"></a><span id="l9.36">       return;</span>
<a href="#l9.37"></a><span id="l9.37">     }</span>
<a href="#l9.38"></a><span id="l9.38"> </span>
<a href="#l9.39"></a><span id="l9.39" class="difflineminus">-    let [unreadTargettedCount, unreadTotalCount] = this.countUnreadMessages();</span>
<a href="#l9.40"></a><span id="l9.40" class="difflineminus">-    chatButton.badgeCount = unreadTargettedCount;</span>
<a href="#l9.41"></a><span id="l9.41" class="difflineplus">+    let [</span>
<a href="#l9.42"></a><span id="l9.42" class="difflineplus">+      unreadTargettedCount,</span>
<a href="#l9.43"></a><span id="l9.43" class="difflineplus">+      unreadTotalCount,</span>
<a href="#l9.44"></a><span id="l9.44" class="difflineplus">+      unreadOTRNotificationCount,</span>
<a href="#l9.45"></a><span id="l9.45" class="difflineplus">+    ] = this.countUnreadMessages();</span>
<a href="#l9.46"></a><span id="l9.46" class="difflineplus">+    let unreadMsgAndNotificationCount =</span>
<a href="#l9.47"></a><span id="l9.47" class="difflineplus">+      unreadTargettedCount + unreadOTRNotificationCount;</span>
<a href="#l9.48"></a><span id="l9.48" class="difflineplus">+    chatButton.badgeCount = unreadMsgAndNotificationCount;</span>
<a href="#l9.49"></a><span id="l9.49"> </span>
<a href="#l9.50"></a><span id="l9.50" class="difflineminus">-    if (unreadTotalCount) {</span>
<a href="#l9.51"></a><span id="l9.51" class="difflineplus">+    if (unreadTotalCount || unreadOTRNotificationCount) {</span>
<a href="#l9.52"></a><span id="l9.52">       chatButton.setAttribute(&quot;unreadMessages&quot;, &quot;true&quot;);</span>
<a href="#l9.53"></a><span id="l9.53">     } else {</span>
<a href="#l9.54"></a><span id="l9.54">       chatButton.removeAttribute(&quot;unreadMessages&quot;);</span>
<a href="#l9.55"></a><span id="l9.55">     }</span>
<a href="#l9.56"></a><span id="l9.56"> </span>
<a href="#l9.57"></a><span id="l9.57" class="difflineminus">-    if (unreadTargettedCount != this._notifiedUnreadCount) {</span>
<a href="#l9.58"></a><span id="l9.58" class="difflineplus">+    if (unreadMsgAndNotificationCount != this._notifiedUnreadCount) {</span>
<a href="#l9.59"></a><span id="l9.59">       let unreadInt = Cc[&quot;@mozilla.org/supports-PRInt32;1&quot;].createInstance(</span>
<a href="#l9.60"></a><span id="l9.60">         Ci.nsISupportsPRInt32</span>
<a href="#l9.61"></a><span id="l9.61">       );</span>
<a href="#l9.62"></a><span id="l9.62" class="difflineminus">-      unreadInt.data = unreadTargettedCount;</span>
<a href="#l9.63"></a><span id="l9.63" class="difflineplus">+      unreadInt.data = unreadMsgAndNotificationCount;</span>
<a href="#l9.64"></a><span id="l9.64">       Services.obs.notifyObservers(</span>
<a href="#l9.65"></a><span id="l9.65">         unreadInt,</span>
<a href="#l9.66"></a><span id="l9.66">         &quot;unread-im-count-changed&quot;,</span>
<a href="#l9.67"></a><span id="l9.67" class="difflineminus">-        unreadTargettedCount</span>
<a href="#l9.68"></a><span id="l9.68" class="difflineplus">+        unreadMsgAndNotificationCount</span>
<a href="#l9.69"></a><span id="l9.69">       );</span>
<a href="#l9.70"></a><span id="l9.70" class="difflineminus">-      this._notifiedUnreadCount = unreadTargettedCount;</span>
<a href="#l9.71"></a><span id="l9.71" class="difflineplus">+      this._notifiedUnreadCount = unreadMsgAndNotificationCount;</span>
<a href="#l9.72"></a><span id="l9.72">     }</span>
<a href="#l9.73"></a><span id="l9.73">   },</span>
<a href="#l9.74"></a><span id="l9.74"> </span>
<a href="#l9.75"></a><span id="l9.75">   countUnreadMessages() {</span>
<a href="#l9.76"></a><span id="l9.76">     let convs = imServices.conversations.getUIConversations();</span>
<a href="#l9.77"></a><span id="l9.77">     let unreadTargettedCount = 0;</span>
<a href="#l9.78"></a><span id="l9.78">     let unreadTotalCount = 0;</span>
<a href="#l9.79"></a><span id="l9.79" class="difflineplus">+    let unreadOTRNotificationCount = 0;</span>
<a href="#l9.80"></a><span id="l9.80">     for (let conv of convs) {</span>
<a href="#l9.81"></a><span id="l9.81">       unreadTargettedCount += conv.unreadTargetedMessageCount;</span>
<a href="#l9.82"></a><span id="l9.82">       unreadTotalCount += conv.unreadIncomingMessageCount;</span>
<a href="#l9.83"></a><span id="l9.83" class="difflineplus">+      unreadOTRNotificationCount += conv.unreadOTRNotificationCount;</span>
<a href="#l9.84"></a><span id="l9.84">     }</span>
<a href="#l9.85"></a><span id="l9.85" class="difflineminus">-    return [unreadTargettedCount, unreadTotalCount];</span>
<a href="#l9.86"></a><span id="l9.86" class="difflineplus">+    return [unreadTargettedCount, unreadTotalCount, unreadOTRNotificationCount];</span>
<a href="#l9.87"></a><span id="l9.87">   },</span>
<a href="#l9.88"></a><span id="l9.88"> </span>
<a href="#l9.89"></a><span id="l9.89">   updateTitle() {</span>
<a href="#l9.90"></a><span id="l9.90">     if (!gChatTab) {</span>
<a href="#l9.91"></a><span id="l9.91">       return;</span>
<a href="#l9.92"></a><span id="l9.92">     }</span>
<a href="#l9.93"></a><span id="l9.93"> </span>
<a href="#l9.94"></a><span id="l9.94">     let title = document.getElementById(&quot;chatBundle&quot;).getString(&quot;chatTabTitle&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mail/components/im/content/imAccounts.js</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mail/components/im/content/imAccounts.js</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -40,23 +40,23 @@ var events = [</span>
<a href="#l10.4"></a><span id="l10.4"> var gAccountManager = {</span>
<a href="#l10.5"></a><span id="l10.5">   // Sets the delay after connect() or disconnect() during which</span>
<a href="#l10.6"></a><span id="l10.6">   // it is impossible to perform disconnect() and connect()</span>
<a href="#l10.7"></a><span id="l10.7">   _disabledDelay: 500,</span>
<a href="#l10.8"></a><span id="l10.8">   disableTimerID: 0,</span>
<a href="#l10.9"></a><span id="l10.9">   _connectedLabelInterval: 0,</span>
<a href="#l10.10"></a><span id="l10.10"> </span>
<a href="#l10.11"></a><span id="l10.11">   get msgNotificationBar() {</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-    delete this.msgNotificationBar;</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+    delete this._msgNotificationBar;</span>
<a href="#l10.14"></a><span id="l10.14"> </span>
<a href="#l10.15"></a><span id="l10.15">     let newNotificationBox = new MozElements.NotificationBox(element =&gt; {</span>
<a href="#l10.16"></a><span id="l10.16">       document.getElementById(&quot;accounts-notification-box&quot;).prepend(element);</span>
<a href="#l10.17"></a><span id="l10.17">     });</span>
<a href="#l10.18"></a><span id="l10.18"> </span>
<a href="#l10.19"></a><span id="l10.19" class="difflineminus">-    return (this.msgNotificationBar = newNotificationBox);</span>
<a href="#l10.20"></a><span id="l10.20" class="difflineplus">+    return (this._msgNotificationBar = newNotificationBox);</span>
<a href="#l10.21"></a><span id="l10.21">   },</span>
<a href="#l10.22"></a><span id="l10.22"> </span>
<a href="#l10.23"></a><span id="l10.23">   load() {</span>
<a href="#l10.24"></a><span id="l10.24">     // Wait until the password service is ready before offering anything.</span>
<a href="#l10.25"></a><span id="l10.25">     Services.logins.initializationPromise.then(</span>
<a href="#l10.26"></a><span id="l10.26">       () =&gt; {</span>
<a href="#l10.27"></a><span id="l10.27">         this.accountList = document.getElementById(&quot;accountlist&quot;);</span>
<a href="#l10.28"></a><span id="l10.28">         let defaultID;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mail/components/im/modules/chatNotifications.jsm</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mail/components/im/modules/chatNotifications.jsm</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -184,67 +184,85 @@ var Notifications = {</span>
<a href="#l11.4"></a><span id="l11.4">         }</span>
<a href="#l11.5"></a><span id="l11.5">       );</span>
<a href="#l11.6"></a><span id="l11.6"> </span>
<a href="#l11.7"></a><span id="l11.7">     this._heldMessage = null;</span>
<a href="#l11.8"></a><span id="l11.8">     this._msgCounter = 0;</span>
<a href="#l11.9"></a><span id="l11.9">   },</span>
<a href="#l11.10"></a><span id="l11.10"> </span>
<a href="#l11.11"></a><span id="l11.11">   init() {</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineplus">+    Services.obs.addObserver(Notifications, &quot;new-otr-verification-request&quot;);</span>
<a href="#l11.13"></a><span id="l11.13">     Services.obs.addObserver(Notifications, &quot;new-directed-incoming-message&quot;);</span>
<a href="#l11.14"></a><span id="l11.14">     Services.obs.addObserver(Notifications, &quot;alertclickcallback&quot;);</span>
<a href="#l11.15"></a><span id="l11.15">   },</span>
<a href="#l11.16"></a><span id="l11.16"> </span>
<a href="#l11.17"></a><span id="l11.17">   _notificationPrefName: &quot;mail.chat.show_desktop_notifications&quot;,</span>
<a href="#l11.18"></a><span id="l11.18">   observe(aSubject, aTopic, aData) {</span>
<a href="#l11.19"></a><span id="l11.19" class="difflineminus">-    if (</span>
<a href="#l11.20"></a><span id="l11.20" class="difflineminus">-      aTopic == &quot;new-directed-incoming-message&quot; &amp;&amp;</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineminus">-      Services.prefs.getBoolPref(this._notificationPrefName)</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineminus">-    ) {</span>
<a href="#l11.23"></a><span id="l11.23" class="difflineminus">-      // If this is the first message, we show the notification and</span>
<a href="#l11.24"></a><span id="l11.24" class="difflineminus">-      // store the sender's name.</span>
<a href="#l11.25"></a><span id="l11.25" class="difflineminus">-      let sender = aSubject.who || aSubject.alias;</span>
<a href="#l11.26"></a><span id="l11.26" class="difflineminus">-      if (this._lastMessageSender == null) {</span>
<a href="#l11.27"></a><span id="l11.27" class="difflineminus">-        this._lastMessageSender = sender;</span>
<a href="#l11.28"></a><span id="l11.28" class="difflineminus">-        this._lastMessageTime = aSubject.time;</span>
<a href="#l11.29"></a><span id="l11.29" class="difflineminus">-        this._showMessageNotification(aSubject);</span>
<a href="#l11.30"></a><span id="l11.30" class="difflineminus">-      } else if (</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineminus">-        this._lastMessageSender != sender ||</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineminus">-        aSubject.time &gt; this._lastMessageTime + kTimeToWaitForMoreMsgs</span>
<a href="#l11.33"></a><span id="l11.33" class="difflineminus">-      ) {</span>
<a href="#l11.34"></a><span id="l11.34" class="difflineminus">-        // If the sender is not the same as the previous sender or the</span>
<a href="#l11.35"></a><span id="l11.35" class="difflineminus">-        // time elapsed since the last message is greater than kTimeToWaitForMoreMsgs,</span>
<a href="#l11.36"></a><span id="l11.36" class="difflineminus">-        // we show the held notification and set timeout for the message just arrived.</span>
<a href="#l11.37"></a><span id="l11.37" class="difflineminus">-        if (this._heldMessage) {</span>
<a href="#l11.38"></a><span id="l11.38" class="difflineminus">-          // if the time for the current message is greater than _lastMessageTime by</span>
<a href="#l11.39"></a><span id="l11.39" class="difflineminus">-          // more than kTimeToWaitForMoreMsgs, this will not happen since the notification will</span>
<a href="#l11.40"></a><span id="l11.40" class="difflineminus">-          // have already been dispatched.</span>
<a href="#l11.41"></a><span id="l11.41" class="difflineplus">+    if (!Services.prefs.getBoolPref(this._notificationPrefName)) {</span>
<a href="#l11.42"></a><span id="l11.42" class="difflineplus">+      return;</span>
<a href="#l11.43"></a><span id="l11.43" class="difflineplus">+    }</span>
<a href="#l11.44"></a><span id="l11.44" class="difflineplus">+</span>
<a href="#l11.45"></a><span id="l11.45" class="difflineplus">+    switch (aTopic) {</span>
<a href="#l11.46"></a><span id="l11.46" class="difflineplus">+      case &quot;new-directed-incoming-message&quot;:</span>
<a href="#l11.47"></a><span id="l11.47" class="difflineplus">+        // If this is the first message, we show the notification and</span>
<a href="#l11.48"></a><span id="l11.48" class="difflineplus">+        // store the sender's name.</span>
<a href="#l11.49"></a><span id="l11.49" class="difflineplus">+        let sender = aSubject.who || aSubject.alias;</span>
<a href="#l11.50"></a><span id="l11.50" class="difflineplus">+        if (this._lastMessageSender == null) {</span>
<a href="#l11.51"></a><span id="l11.51" class="difflineplus">+          this._lastMessageSender = sender;</span>
<a href="#l11.52"></a><span id="l11.52" class="difflineplus">+          this._lastMessageTime = aSubject.time;</span>
<a href="#l11.53"></a><span id="l11.53" class="difflineplus">+          this._showMessageNotification(aSubject);</span>
<a href="#l11.54"></a><span id="l11.54" class="difflineplus">+        } else if (</span>
<a href="#l11.55"></a><span id="l11.55" class="difflineplus">+          this._lastMessageSender != sender ||</span>
<a href="#l11.56"></a><span id="l11.56" class="difflineplus">+          aSubject.time &gt; this._lastMessageTime + kTimeToWaitForMoreMsgs</span>
<a href="#l11.57"></a><span id="l11.57" class="difflineplus">+        ) {</span>
<a href="#l11.58"></a><span id="l11.58" class="difflineplus">+          // If the sender is not the same as the previous sender or the</span>
<a href="#l11.59"></a><span id="l11.59" class="difflineplus">+          // time elapsed since the last message is greater than kTimeToWaitForMoreMsgs,</span>
<a href="#l11.60"></a><span id="l11.60" class="difflineplus">+          // we show the held notification and set timeout for the message just arrived.</span>
<a href="#l11.61"></a><span id="l11.61" class="difflineplus">+          if (this._heldMessage) {</span>
<a href="#l11.62"></a><span id="l11.62" class="difflineplus">+            // if the time for the current message is greater than _lastMessageTime by</span>
<a href="#l11.63"></a><span id="l11.63" class="difflineplus">+            // more than kTimeToWaitForMoreMsgs, this will not happen since the notification will</span>
<a href="#l11.64"></a><span id="l11.64" class="difflineplus">+            // have already been dispatched.</span>
<a href="#l11.65"></a><span id="l11.65" class="difflineplus">+            clearTimeout(this._timeoutId);</span>
<a href="#l11.66"></a><span id="l11.66" class="difflineplus">+            this._showMessageNotification(this._heldMessage, this._msgCounter);</span>
<a href="#l11.67"></a><span id="l11.67" class="difflineplus">+          }</span>
<a href="#l11.68"></a><span id="l11.68" class="difflineplus">+          this._lastMessageSender = sender;</span>
<a href="#l11.69"></a><span id="l11.69" class="difflineplus">+          this._lastMessageTime = aSubject.time;</span>
<a href="#l11.70"></a><span id="l11.70" class="difflineplus">+          this._showMessageNotification(aSubject);</span>
<a href="#l11.71"></a><span id="l11.71" class="difflineplus">+        } else if (</span>
<a href="#l11.72"></a><span id="l11.72" class="difflineplus">+          this._lastMessageSender == sender &amp;&amp;</span>
<a href="#l11.73"></a><span id="l11.73" class="difflineplus">+          this._lastMessageTime + kTimeToWaitForMoreMsgs &gt;= aSubject.time</span>
<a href="#l11.74"></a><span id="l11.74" class="difflineplus">+        ) {</span>
<a href="#l11.75"></a><span id="l11.75" class="difflineplus">+          // If the sender is same as the previous sender and the time elapsed since the</span>
<a href="#l11.76"></a><span id="l11.76" class="difflineplus">+          // last held message is less than kTimeToWaitForMoreMsgs, we increase the held messages</span>
<a href="#l11.77"></a><span id="l11.77" class="difflineplus">+          // counter and update the last message's arrival time.</span>
<a href="#l11.78"></a><span id="l11.78" class="difflineplus">+          this._lastMessageTime = aSubject.time;</span>
<a href="#l11.79"></a><span id="l11.79" class="difflineplus">+          if (!this._heldMessage) {</span>
<a href="#l11.80"></a><span id="l11.80" class="difflineplus">+            this._heldMessage = aSubject;</span>
<a href="#l11.81"></a><span id="l11.81" class="difflineplus">+          } else {</span>
<a href="#l11.82"></a><span id="l11.82" class="difflineplus">+            this._msgCounter++;</span>
<a href="#l11.83"></a><span id="l11.83" class="difflineplus">+          }</span>
<a href="#l11.84"></a><span id="l11.84" class="difflineplus">+</span>
<a href="#l11.85"></a><span id="l11.85">           clearTimeout(this._timeoutId);</span>
<a href="#l11.86"></a><span id="l11.86" class="difflineminus">-          this._showMessageNotification(this._heldMessage, this._msgCounter);</span>
<a href="#l11.87"></a><span id="l11.87" class="difflineplus">+          this._timeoutId = setTimeout(() =&gt; {</span>
<a href="#l11.88"></a><span id="l11.88" class="difflineplus">+            this._showMessageNotification(this._heldMessage, this._msgCounter);</span>
<a href="#l11.89"></a><span id="l11.89" class="difflineplus">+          }, kTimeToWaitForMoreMsgs * 1000);</span>
<a href="#l11.90"></a><span id="l11.90">         }</span>
<a href="#l11.91"></a><span id="l11.91" class="difflineminus">-        this._lastMessageSender = sender;</span>
<a href="#l11.92"></a><span id="l11.92" class="difflineminus">-        this._lastMessageTime = aSubject.time;</span>
<a href="#l11.93"></a><span id="l11.93" class="difflineminus">-        this._showMessageNotification(aSubject);</span>
<a href="#l11.94"></a><span id="l11.94" class="difflineminus">-      } else if (</span>
<a href="#l11.95"></a><span id="l11.95" class="difflineminus">-        this._lastMessageSender == sender &amp;&amp;</span>
<a href="#l11.96"></a><span id="l11.96" class="difflineminus">-        this._lastMessageTime + kTimeToWaitForMoreMsgs &gt;= aSubject.time</span>
<a href="#l11.97"></a><span id="l11.97" class="difflineminus">-      ) {</span>
<a href="#l11.98"></a><span id="l11.98" class="difflineminus">-        // If the sender is same as the previous sender and the time elapsed since the</span>
<a href="#l11.99"></a><span id="l11.99" class="difflineminus">-        // last held message is less than kTimeToWaitForMoreMsgs, we increase the held messages</span>
<a href="#l11.100"></a><span id="l11.100" class="difflineminus">-        // counter and update the last message's arrival time.</span>
<a href="#l11.101"></a><span id="l11.101" class="difflineminus">-        this._lastMessageTime = aSubject.time;</span>
<a href="#l11.102"></a><span id="l11.102" class="difflineminus">-        if (!this._heldMessage) {</span>
<a href="#l11.103"></a><span id="l11.103" class="difflineminus">-          this._heldMessage = aSubject;</span>
<a href="#l11.104"></a><span id="l11.104" class="difflineminus">-        } else {</span>
<a href="#l11.105"></a><span id="l11.105" class="difflineminus">-          this._msgCounter++;</span>
<a href="#l11.106"></a><span id="l11.106" class="difflineplus">+        break;</span>
<a href="#l11.107"></a><span id="l11.107" class="difflineplus">+</span>
<a href="#l11.108"></a><span id="l11.108" class="difflineplus">+      case &quot;new-otr-verification-request&quot;:</span>
<a href="#l11.109"></a><span id="l11.109" class="difflineplus">+        // If the Chat tab is not focused, play the sounds and update the icon</span>
<a href="#l11.110"></a><span id="l11.110" class="difflineplus">+        // counter, and show the counter in the buddy richlistitem.</span>
<a href="#l11.111"></a><span id="l11.111" class="difflineplus">+        let win = Services.wm.getMostRecentWindow(&quot;mail:3pane&quot;);</span>
<a href="#l11.112"></a><span id="l11.112" class="difflineplus">+        if (</span>
<a href="#l11.113"></a><span id="l11.113" class="difflineplus">+          !Services.focus.activeWindow ||</span>
<a href="#l11.114"></a><span id="l11.114" class="difflineplus">+          win.document.getElementById(&quot;tabmail&quot;).currentTabInfo.mode.name !=</span>
<a href="#l11.115"></a><span id="l11.115" class="difflineplus">+            &quot;chat&quot;</span>
<a href="#l11.116"></a><span id="l11.116" class="difflineplus">+        ) {</span>
<a href="#l11.117"></a><span id="l11.117" class="difflineplus">+          Services.obs.notifyObservers(</span>
<a href="#l11.118"></a><span id="l11.118" class="difflineplus">+            aSubject,</span>
<a href="#l11.119"></a><span id="l11.119" class="difflineplus">+            &quot;play-chat-notification-sound&quot;</span>
<a href="#l11.120"></a><span id="l11.120" class="difflineplus">+          );</span>
<a href="#l11.121"></a><span id="l11.121">         }</span>
<a href="#l11.122"></a><span id="l11.122"> </span>
<a href="#l11.123"></a><span id="l11.123" class="difflineminus">-        clearTimeout(this._timeoutId);</span>
<a href="#l11.124"></a><span id="l11.124" class="difflineminus">-        this._timeoutId = setTimeout(function() {</span>
<a href="#l11.125"></a><span id="l11.125" class="difflineminus">-          Notifications._showMessageNotification(</span>
<a href="#l11.126"></a><span id="l11.126" class="difflineminus">-            Notifications._heldMessage,</span>
<a href="#l11.127"></a><span id="l11.127" class="difflineminus">-            Notifications._msgCounter</span>
<a href="#l11.128"></a><span id="l11.128" class="difflineminus">-          );</span>
<a href="#l11.129"></a><span id="l11.129" class="difflineminus">-        }, kTimeToWaitForMoreMsgs * 1000);</span>
<a href="#l11.130"></a><span id="l11.130" class="difflineminus">-      }</span>
<a href="#l11.131"></a><span id="l11.131" class="difflineplus">+        break;</span>
<a href="#l11.132"></a><span id="l11.132">     }</span>
<a href="#l11.133"></a><span id="l11.133">   },</span>
<a href="#l11.134"></a><span id="l11.134"> };</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:33Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

