<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 26528:c6597fe7374a29da54e54d1f0ba62cf7328cc970</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ c6597fe7374a29da54e54d1f0ba62cf7328cc970" />
<meta property="og:url" content="/comm-central/rev/c6597fe7374a29da54e54d1f0ba62cf7328cc970" />
<meta property="og:description" content="Bug 1546364 - Reformat to Google coding style in mailnews/imap (part 3). rs=reformat" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / c6597fe7374a29da54e54d1f0ba62cf7328cc970 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/c6597fe7374a29da54e54d1f0ba62cf7328cc970">shortlog</a> |
<a href="/comm-central/log/c6597fe7374a29da54e54d1f0ba62cf7328cc970">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/c6597fe7374a29da54e54d1f0ba62cf7328cc970">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/c6597fe7374a29da54e54d1f0ba62cf7328cc970">files</a> |
changeset |
<a href="/comm-central/raw-rev/c6597fe7374a29da54e54d1f0ba62cf7328cc970">raw</a>  | <a href="/comm-central/archive/c6597fe7374a29da54e54d1f0ba62cf7328cc970.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1546364">Bug 1546364</a> - Reformat to Google coding style in mailnews/imap (part 3). rs=reformat
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#74;&#111;&#114;&#103;&#32;&#75;&#32;&#60;&#106;&#111;&#114;&#103;&#107;&#64;&#106;&#111;&#114;&#103;&#107;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Mon, 06 May 2019 21:30:12 +0200</td></tr>

<tr>
 <td>changeset 26528</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/c6597fe7374a29da54e54d1f0ba62cf7328cc970">c6597fe7374a29da54e54d1f0ba62cf7328cc970</a></td>
</tr>



<tr>
<td>parent 26527</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/d9e252049461c31a3dee652c91d3ff11b864e6a7">d9e252049461c31a3dee652c91d3ff11b864e6a7</a>
</td>
</tr>

<tr>
<td>child 26529</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/fb9a0f3d6c42c57cb65e636e78228e0418850cab">fb9a0f3d6c42c57cb65e636e78228e0418850cab</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=c6597fe7374a29da54e54d1f0ba62cf7328cc970">15880</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Mon, 06 May 2019 21:56:08 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@c6597fe7374a [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=c6597fe7374a29da54e54d1f0ba62cf7328cc970">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=c6597fe7374a29da54e54d1f0ba62cf7328cc970&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=c6597fe7374a29da54e54d1f0ba62cf7328cc970&newProject=comm-central&newRevision=c6597fe7374a29da54e54d1f0ba62cf7328cc970&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=c6597fe7374a29da54e54d1f0ba62cf7328cc970&newProject=comm-central&newRevision=c6597fe7374a29da54e54d1f0ba62cf7328cc970&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=c6597fe7374a29da54e54d1f0ba62cf7328cc970&newProject=comm-central&newRevision=c6597fe7374a29da54e54d1f0ba62cf7328cc970&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28reformat%29&revcount=50">reformat</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1546364">1546364</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1546364">Bug 1546364</a> - Reformat to Google coding style in mailnews/imap (part 3). rs=reformat
# ignore-this-changeset</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/src/nsImapSearchResults.cpp">mailnews/imap/src/nsImapSearchResults.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/src/nsImapSearchResults.cpp">file</a> |
<a href="/comm-central/annotate/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/src/nsImapSearchResults.cpp">annotate</a> |
<a href="/comm-central/diff/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/src/nsImapSearchResults.cpp">diff</a> |
<a href="/comm-central/comparison/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/src/nsImapSearchResults.cpp">comparison</a> |
<a href="/comm-central/log/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/src/nsImapSearchResults.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/src/nsImapSearchResults.h">mailnews/imap/src/nsImapSearchResults.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/src/nsImapSearchResults.h">file</a> |
<a href="/comm-central/annotate/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/src/nsImapSearchResults.h">annotate</a> |
<a href="/comm-central/diff/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/src/nsImapSearchResults.h">diff</a> |
<a href="/comm-central/comparison/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/src/nsImapSearchResults.h">comparison</a> |
<a href="/comm-central/log/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/src/nsImapSearchResults.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/src/nsImapServerResponseParser.cpp">mailnews/imap/src/nsImapServerResponseParser.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/src/nsImapServerResponseParser.cpp">file</a> |
<a href="/comm-central/annotate/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/src/nsImapServerResponseParser.cpp">annotate</a> |
<a href="/comm-central/diff/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/src/nsImapServerResponseParser.cpp">diff</a> |
<a href="/comm-central/comparison/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/src/nsImapServerResponseParser.cpp">comparison</a> |
<a href="/comm-central/log/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/src/nsImapServerResponseParser.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/src/nsImapServerResponseParser.h">mailnews/imap/src/nsImapServerResponseParser.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/src/nsImapServerResponseParser.h">file</a> |
<a href="/comm-central/annotate/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/src/nsImapServerResponseParser.h">annotate</a> |
<a href="/comm-central/diff/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/src/nsImapServerResponseParser.h">diff</a> |
<a href="/comm-central/comparison/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/src/nsImapServerResponseParser.h">comparison</a> |
<a href="/comm-central/log/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/src/nsImapServerResponseParser.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/src/nsImapService.cpp">mailnews/imap/src/nsImapService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/src/nsImapService.cpp">file</a> |
<a href="/comm-central/annotate/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/src/nsImapService.cpp">annotate</a> |
<a href="/comm-central/diff/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/src/nsImapService.cpp">diff</a> |
<a href="/comm-central/comparison/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/src/nsImapService.cpp">comparison</a> |
<a href="/comm-central/log/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/src/nsImapService.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/src/nsImapService.h">mailnews/imap/src/nsImapService.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/src/nsImapService.h">file</a> |
<a href="/comm-central/annotate/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/src/nsImapService.h">annotate</a> |
<a href="/comm-central/diff/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/src/nsImapService.h">diff</a> |
<a href="/comm-central/comparison/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/src/nsImapService.h">comparison</a> |
<a href="/comm-central/log/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/src/nsImapService.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/src/nsImapStringBundle.cpp">mailnews/imap/src/nsImapStringBundle.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/src/nsImapStringBundle.cpp">file</a> |
<a href="/comm-central/annotate/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/src/nsImapStringBundle.cpp">annotate</a> |
<a href="/comm-central/diff/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/src/nsImapStringBundle.cpp">diff</a> |
<a href="/comm-central/comparison/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/src/nsImapStringBundle.cpp">comparison</a> |
<a href="/comm-central/log/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/src/nsImapStringBundle.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/src/nsImapStringBundle.h">mailnews/imap/src/nsImapStringBundle.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/src/nsImapStringBundle.h">file</a> |
<a href="/comm-central/annotate/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/src/nsImapStringBundle.h">annotate</a> |
<a href="/comm-central/diff/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/src/nsImapStringBundle.h">diff</a> |
<a href="/comm-central/comparison/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/src/nsImapStringBundle.h">comparison</a> |
<a href="/comm-central/log/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/src/nsImapStringBundle.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/src/nsImapUndoTxn.cpp">mailnews/imap/src/nsImapUndoTxn.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/src/nsImapUndoTxn.cpp">file</a> |
<a href="/comm-central/annotate/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/src/nsImapUndoTxn.cpp">annotate</a> |
<a href="/comm-central/diff/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/src/nsImapUndoTxn.cpp">diff</a> |
<a href="/comm-central/comparison/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/src/nsImapUndoTxn.cpp">comparison</a> |
<a href="/comm-central/log/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/src/nsImapUndoTxn.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/src/nsImapUndoTxn.h">mailnews/imap/src/nsImapUndoTxn.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/src/nsImapUndoTxn.h">file</a> |
<a href="/comm-central/annotate/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/src/nsImapUndoTxn.h">annotate</a> |
<a href="/comm-central/diff/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/src/nsImapUndoTxn.h">diff</a> |
<a href="/comm-central/comparison/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/src/nsImapUndoTxn.h">comparison</a> |
<a href="/comm-central/log/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/src/nsImapUndoTxn.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/src/nsImapUrl.cpp">mailnews/imap/src/nsImapUrl.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/src/nsImapUrl.cpp">file</a> |
<a href="/comm-central/annotate/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/src/nsImapUrl.cpp">annotate</a> |
<a href="/comm-central/diff/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/src/nsImapUrl.cpp">diff</a> |
<a href="/comm-central/comparison/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/src/nsImapUrl.cpp">comparison</a> |
<a href="/comm-central/log/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/src/nsImapUrl.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/src/nsImapUrl.h">mailnews/imap/src/nsImapUrl.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/src/nsImapUrl.h">file</a> |
<a href="/comm-central/annotate/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/src/nsImapUrl.h">annotate</a> |
<a href="/comm-central/diff/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/src/nsImapUrl.h">diff</a> |
<a href="/comm-central/comparison/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/src/nsImapUrl.h">comparison</a> |
<a href="/comm-central/log/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/src/nsImapUrl.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/src/nsImapUtils.cpp">mailnews/imap/src/nsImapUtils.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/src/nsImapUtils.cpp">file</a> |
<a href="/comm-central/annotate/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/src/nsImapUtils.cpp">annotate</a> |
<a href="/comm-central/diff/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/src/nsImapUtils.cpp">diff</a> |
<a href="/comm-central/comparison/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/src/nsImapUtils.cpp">comparison</a> |
<a href="/comm-central/log/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/src/nsImapUtils.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/src/nsImapUtils.h">mailnews/imap/src/nsImapUtils.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/src/nsImapUtils.h">file</a> |
<a href="/comm-central/annotate/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/src/nsImapUtils.h">annotate</a> |
<a href="/comm-central/diff/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/src/nsImapUtils.h">diff</a> |
<a href="/comm-central/comparison/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/src/nsImapUtils.h">comparison</a> |
<a href="/comm-central/log/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/src/nsImapUtils.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/src/nsSyncRunnableHelpers.cpp">mailnews/imap/src/nsSyncRunnableHelpers.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/src/nsSyncRunnableHelpers.cpp">file</a> |
<a href="/comm-central/annotate/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/src/nsSyncRunnableHelpers.cpp">annotate</a> |
<a href="/comm-central/diff/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/src/nsSyncRunnableHelpers.cpp">diff</a> |
<a href="/comm-central/comparison/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/src/nsSyncRunnableHelpers.cpp">comparison</a> |
<a href="/comm-central/log/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/src/nsSyncRunnableHelpers.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/src/nsSyncRunnableHelpers.h">mailnews/imap/src/nsSyncRunnableHelpers.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/src/nsSyncRunnableHelpers.h">file</a> |
<a href="/comm-central/annotate/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/src/nsSyncRunnableHelpers.h">annotate</a> |
<a href="/comm-central/diff/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/src/nsSyncRunnableHelpers.h">diff</a> |
<a href="/comm-central/comparison/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/src/nsSyncRunnableHelpers.h">comparison</a> |
<a href="/comm-central/log/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/src/nsSyncRunnableHelpers.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/test/TestImapFlagAndUidState.cpp">mailnews/imap/test/TestImapFlagAndUidState.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/test/TestImapFlagAndUidState.cpp">file</a> |
<a href="/comm-central/annotate/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/test/TestImapFlagAndUidState.cpp">annotate</a> |
<a href="/comm-central/diff/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/test/TestImapFlagAndUidState.cpp">diff</a> |
<a href="/comm-central/comparison/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/test/TestImapFlagAndUidState.cpp">comparison</a> |
<a href="/comm-central/log/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/test/TestImapFlagAndUidState.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/test/TestImapHdrXferInfo.cpp">mailnews/imap/test/TestImapHdrXferInfo.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/test/TestImapHdrXferInfo.cpp">file</a> |
<a href="/comm-central/annotate/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/test/TestImapHdrXferInfo.cpp">annotate</a> |
<a href="/comm-central/diff/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/test/TestImapHdrXferInfo.cpp">diff</a> |
<a href="/comm-central/comparison/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/test/TestImapHdrXferInfo.cpp">comparison</a> |
<a href="/comm-central/log/c6597fe7374a29da54e54d1f0ba62cf7328cc970/mailnews/imap/test/TestImapHdrXferInfo.cpp">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/imap/src/nsImapSearchResults.cpp</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapSearchResults.cpp</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -4,88 +4,69 @@</span>
<a href="#l1.4"></a><span id="l1.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l1.5"></a><span id="l1.5"> </span>
<a href="#l1.6"></a><span id="l1.6"> #include &quot;msgCore.h&quot;  // for pre-compiled headers</span>
<a href="#l1.7"></a><span id="l1.7"> </span>
<a href="#l1.8"></a><span id="l1.8"> #include &quot;nsImapSearchResults.h&quot;</span>
<a href="#l1.9"></a><span id="l1.9"> #include &quot;prmem.h&quot;</span>
<a href="#l1.10"></a><span id="l1.10"> #include &quot;nsCRT.h&quot;</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-nsImapSearchResultSequence::nsImapSearchResultSequence()</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-{</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineminus">-}</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+nsImapSearchResultSequence::nsImapSearchResultSequence() {}</span>
<a href="#l1.16"></a><span id="l1.16"> </span>
<a href="#l1.17"></a><span id="l1.17" class="difflineminus">-nsImapSearchResultSequence *nsImapSearchResultSequence::CreateSearchResultSequence()</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineminus">-{</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineplus">+nsImapSearchResultSequence *</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineplus">+nsImapSearchResultSequence::CreateSearchResultSequence() {</span>
<a href="#l1.21"></a><span id="l1.21">   return new nsImapSearchResultSequence;</span>
<a href="#l1.22"></a><span id="l1.22"> }</span>
<a href="#l1.23"></a><span id="l1.23"> </span>
<a href="#l1.24"></a><span id="l1.24" class="difflineminus">-void nsImapSearchResultSequence::Clear(void)</span>
<a href="#l1.25"></a><span id="l1.25" class="difflineminus">-{</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineminus">-    int32_t i = Length();</span>
<a href="#l1.27"></a><span id="l1.27" class="difflineminus">-    while (0 &lt;= --i)</span>
<a href="#l1.28"></a><span id="l1.28" class="difflineminus">-    {</span>
<a href="#l1.29"></a><span id="l1.29" class="difflineminus">-      char* string = ElementAt(i);</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineminus">-      PR_Free(string);</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineminus">-    }</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineminus">-    nsTArray&lt;char*&gt;::Clear();</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineplus">+void nsImapSearchResultSequence::Clear(void) {</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineplus">+  int32_t i = Length();</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineplus">+  while (0 &lt;= --i) {</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineplus">+    char *string = ElementAt(i);</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineplus">+    PR_Free(string);</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineplus">+  }</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineplus">+  nsTArray&lt;char *&gt;::Clear();</span>
<a href="#l1.40"></a><span id="l1.40"> }</span>
<a href="#l1.41"></a><span id="l1.41"> </span>
<a href="#l1.42"></a><span id="l1.42" class="difflineminus">-nsImapSearchResultSequence::~nsImapSearchResultSequence()</span>
<a href="#l1.43"></a><span id="l1.43" class="difflineminus">-{</span>
<a href="#l1.44"></a><span id="l1.44" class="difflineminus">-  Clear();</span>
<a href="#l1.45"></a><span id="l1.45" class="difflineminus">-}</span>
<a href="#l1.46"></a><span id="l1.46" class="difflineplus">+nsImapSearchResultSequence::~nsImapSearchResultSequence() { Clear(); }</span>
<a href="#l1.47"></a><span id="l1.47"> </span>
<a href="#l1.48"></a><span id="l1.48" class="difflineplus">+void nsImapSearchResultSequence::ResetSequence() { Clear(); }</span>
<a href="#l1.49"></a><span id="l1.49"> </span>
<a href="#l1.50"></a><span id="l1.50" class="difflineminus">-void nsImapSearchResultSequence::ResetSequence()</span>
<a href="#l1.51"></a><span id="l1.51" class="difflineminus">-{</span>
<a href="#l1.52"></a><span id="l1.52" class="difflineminus">-  Clear();</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineminus">-}</span>
<a href="#l1.54"></a><span id="l1.54" class="difflineminus">-</span>
<a href="#l1.55"></a><span id="l1.55" class="difflineminus">-void nsImapSearchResultSequence::AddSearchResultLine(const char *searchLine)</span>
<a href="#l1.56"></a><span id="l1.56" class="difflineminus">-{</span>
<a href="#l1.57"></a><span id="l1.57" class="difflineplus">+void nsImapSearchResultSequence::AddSearchResultLine(const char *searchLine) {</span>
<a href="#l1.58"></a><span id="l1.58">   // The first add becomes node 2.  Fix this.</span>
<a href="#l1.59"></a><span id="l1.59" class="difflineminus">-  char *copiedSequence = PL_strdup(searchLine + 9); // 9 == &quot;* SEARCH &quot;</span>
<a href="#l1.60"></a><span id="l1.60" class="difflineplus">+  char *copiedSequence = PL_strdup(searchLine + 9);  // 9 == &quot;* SEARCH &quot;</span>
<a href="#l1.61"></a><span id="l1.61"> </span>
<a href="#l1.62"></a><span id="l1.62">   if (copiedSequence)  // if we can't allocate this then the search won't hit</span>
<a href="#l1.63"></a><span id="l1.63">     AppendElement(copiedSequence);</span>
<a href="#l1.64"></a><span id="l1.64"> }</span>
<a href="#l1.65"></a><span id="l1.65"> </span>
<a href="#l1.66"></a><span id="l1.66" class="difflineminus">-</span>
<a href="#l1.67"></a><span id="l1.67" class="difflineminus">-nsImapSearchResultIterator::nsImapSearchResultIterator(nsImapSearchResultSequence &amp;sequence) :</span>
<a href="#l1.68"></a><span id="l1.68" class="difflineminus">-fSequence(sequence)</span>
<a href="#l1.69"></a><span id="l1.69" class="difflineminus">-{</span>
<a href="#l1.70"></a><span id="l1.70" class="difflineplus">+nsImapSearchResultIterator::nsImapSearchResultIterator(</span>
<a href="#l1.71"></a><span id="l1.71" class="difflineplus">+    nsImapSearchResultSequence &amp;sequence)</span>
<a href="#l1.72"></a><span id="l1.72" class="difflineplus">+    : fSequence(sequence) {</span>
<a href="#l1.73"></a><span id="l1.73">   ResetIterator();</span>
<a href="#l1.74"></a><span id="l1.74"> }</span>
<a href="#l1.75"></a><span id="l1.75"> </span>
<a href="#l1.76"></a><span id="l1.76" class="difflineminus">-nsImapSearchResultIterator::~nsImapSearchResultIterator()</span>
<a href="#l1.77"></a><span id="l1.77" class="difflineminus">-{</span>
<a href="#l1.78"></a><span id="l1.78" class="difflineminus">-}</span>
<a href="#l1.79"></a><span id="l1.79" class="difflineplus">+nsImapSearchResultIterator::~nsImapSearchResultIterator() {}</span>
<a href="#l1.80"></a><span id="l1.80"> </span>
<a href="#l1.81"></a><span id="l1.81" class="difflineminus">-void  nsImapSearchResultIterator::ResetIterator()</span>
<a href="#l1.82"></a><span id="l1.82" class="difflineminus">-{</span>
<a href="#l1.83"></a><span id="l1.83" class="difflineplus">+void nsImapSearchResultIterator::ResetIterator() {</span>
<a href="#l1.84"></a><span id="l1.84">   fSequenceIndex = 0;</span>
<a href="#l1.85"></a><span id="l1.85" class="difflineminus">-  fCurrentLine = (char *) fSequence.SafeElementAt(fSequenceIndex);</span>
<a href="#l1.86"></a><span id="l1.86" class="difflineplus">+  fCurrentLine = (char *)fSequence.SafeElementAt(fSequenceIndex);</span>
<a href="#l1.87"></a><span id="l1.87">   fPositionInCurrentLine = fCurrentLine;</span>
<a href="#l1.88"></a><span id="l1.88"> }</span>
<a href="#l1.89"></a><span id="l1.89"> </span>
<a href="#l1.90"></a><span id="l1.90" class="difflineminus">-int32_t nsImapSearchResultIterator::GetNextMessageNumber()</span>
<a href="#l1.91"></a><span id="l1.91" class="difflineminus">-{</span>
<a href="#l1.92"></a><span id="l1.92" class="difflineplus">+int32_t nsImapSearchResultIterator::GetNextMessageNumber() {</span>
<a href="#l1.93"></a><span id="l1.93">   int32_t returnValue = 0;</span>
<a href="#l1.94"></a><span id="l1.94" class="difflineminus">-  if (fPositionInCurrentLine)</span>
<a href="#l1.95"></a><span id="l1.95" class="difflineminus">-  {</span>
<a href="#l1.96"></a><span id="l1.96" class="difflineplus">+  if (fPositionInCurrentLine) {</span>
<a href="#l1.97"></a><span id="l1.97">     returnValue = atoi(fPositionInCurrentLine);</span>
<a href="#l1.98"></a><span id="l1.98"> </span>
<a href="#l1.99"></a><span id="l1.99">     // eat the current number</span>
<a href="#l1.100"></a><span id="l1.100">     while (isdigit(*++fPositionInCurrentLine))</span>
<a href="#l1.101"></a><span id="l1.101">       ;</span>
<a href="#l1.102"></a><span id="l1.102"> </span>
<a href="#l1.103"></a><span id="l1.103">     if (*fPositionInCurrentLine == 0xD)  // found CR, no more digits on line</span>
<a href="#l1.104"></a><span id="l1.104">     {</span>
<a href="#l1.105"></a><span id="l1.105" class="difflineminus">-      fCurrentLine = (char *) fSequence.SafeElementAt(++fSequenceIndex);</span>
<a href="#l1.106"></a><span id="l1.106" class="difflineplus">+      fCurrentLine = (char *)fSequence.SafeElementAt(++fSequenceIndex);</span>
<a href="#l1.107"></a><span id="l1.107">       fPositionInCurrentLine = fCurrentLine;</span>
<a href="#l1.108"></a><span id="l1.108" class="difflineminus">-    }</span>
<a href="#l1.109"></a><span id="l1.109" class="difflineminus">-    else  // eat the space</span>
<a href="#l1.110"></a><span id="l1.110" class="difflineplus">+    } else  // eat the space</span>
<a href="#l1.111"></a><span id="l1.111">       fPositionInCurrentLine++;</span>
<a href="#l1.112"></a><span id="l1.112">   }</span>
<a href="#l1.113"></a><span id="l1.113"> </span>
<a href="#l1.114"></a><span id="l1.114">   return returnValue;</span>
<a href="#l1.115"></a><span id="l1.115"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/imap/src/nsImapSearchResults.h</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapSearchResults.h</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -3,40 +3,38 @@</span>
<a href="#l2.4"></a><span id="l2.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l2.5"></a><span id="l2.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l2.6"></a><span id="l2.6"> </span>
<a href="#l2.7"></a><span id="l2.7"> #ifndef nsImapSearchResults_h___</span>
<a href="#l2.8"></a><span id="l2.8"> #define nsImapSearchResults_h___</span>
<a href="#l2.9"></a><span id="l2.9"> </span>
<a href="#l2.10"></a><span id="l2.10"> #include &quot;nsTArray.h&quot;</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-class nsImapSearchResultSequence : public nsTArray&lt;char*&gt;</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-{</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineminus">-public:</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineminus">-    virtual ~nsImapSearchResultSequence();</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineminus">-    static nsImapSearchResultSequence *CreateSearchResultSequence();</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineplus">+class nsImapSearchResultSequence : public nsTArray&lt;char *&gt; {</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineplus">+ public:</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineplus">+  virtual ~nsImapSearchResultSequence();</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineplus">+  static nsImapSearchResultSequence *CreateSearchResultSequence();</span>
<a href="#l2.21"></a><span id="l2.21"> </span>
<a href="#l2.22"></a><span id="l2.22" class="difflineminus">-    virtual void AddSearchResultLine(const char *searchLine);</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineminus">-    virtual void ResetSequence();</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineminus">-    void  Clear();</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineplus">+  virtual void AddSearchResultLine(const char *searchLine);</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineplus">+  virtual void ResetSequence();</span>
<a href="#l2.27"></a><span id="l2.27" class="difflineplus">+  void Clear();</span>
<a href="#l2.28"></a><span id="l2.28"> </span>
<a href="#l2.29"></a><span id="l2.29" class="difflineminus">-    friend class nsImapSearchResultIterator;</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineminus">-private:</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineminus">-    nsImapSearchResultSequence();</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineplus">+  friend class nsImapSearchResultIterator;</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineplus">+</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineplus">+ private:</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineplus">+  nsImapSearchResultSequence();</span>
<a href="#l2.36"></a><span id="l2.36"> };</span>
<a href="#l2.37"></a><span id="l2.37"> </span>
<a href="#l2.38"></a><span id="l2.38"> class nsImapSearchResultIterator {</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineminus">-public:</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineminus">-    explicit nsImapSearchResultIterator(nsImapSearchResultSequence &amp;sequence);</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineminus">-    virtual ~nsImapSearchResultIterator();</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineplus">+ public:</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineplus">+  explicit nsImapSearchResultIterator(nsImapSearchResultSequence &amp;sequence);</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineplus">+  virtual ~nsImapSearchResultIterator();</span>
<a href="#l2.45"></a><span id="l2.45"> </span>
<a href="#l2.46"></a><span id="l2.46" class="difflineminus">-    void  ResetIterator();</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineminus">-    int32_t GetNextMessageNumber();   // returns 0 at end of list</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineminus">-private:</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineminus">-    nsImapSearchResultSequence &amp;fSequence;</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineminus">-    int32_t fSequenceIndex;</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineminus">-    char  *fCurrentLine;</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineminus">-    char  *fPositionInCurrentLine;</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineplus">+  void ResetIterator();</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineplus">+  int32_t GetNextMessageNumber();  // returns 0 at end of list</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineplus">+ private:</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineplus">+  nsImapSearchResultSequence &amp;fSequence;</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineplus">+  int32_t fSequenceIndex;</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineplus">+  char *fCurrentLine;</span>
<a href="#l2.59"></a><span id="l2.59" class="difflineplus">+  char *fPositionInCurrentLine;</span>
<a href="#l2.60"></a><span id="l2.60"> };</span>
<a href="#l2.61"></a><span id="l2.61"> </span>
<a href="#l2.62"></a><span id="l2.62" class="difflineminus">-</span>
<a href="#l2.63"></a><span id="l2.63" class="difflineminus">-</span>
<a href="#l2.64"></a><span id="l2.64"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/imap/src/nsImapServerResponseParser.cpp</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapServerResponseParser.cpp</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -13,37 +13,37 @@</span>
<a href="#l3.4"></a><span id="l3.4"> #include &quot;nsIMAPNamespace.h&quot;</span>
<a href="#l3.5"></a><span id="l3.5"> #include &quot;nsImapUtils.h&quot;</span>
<a href="#l3.6"></a><span id="l3.6"> #include &quot;nsCRT.h&quot;</span>
<a href="#l3.7"></a><span id="l3.7"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l3.8"></a><span id="l3.8"> #include &quot;mozilla/Logging.h&quot;</span>
<a href="#l3.9"></a><span id="l3.9"> </span>
<a href="#l3.10"></a><span id="l3.10"> ////////////////// nsImapServerResponseParser /////////////////////////</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-extern mozilla::LazyLogModule IMAP; // defined in nsImapProtocol.cpp</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+extern mozilla::LazyLogModule IMAP;  // defined in nsImapProtocol.cpp</span>
<a href="#l3.14"></a><span id="l3.14"> </span>
<a href="#l3.15"></a><span id="l3.15" class="difflineminus">-nsImapServerResponseParser::nsImapServerResponseParser(nsImapProtocol &amp;imapProtocolConnection)</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineminus">-                            : nsIMAPGenericParser(),</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineminus">-    fReportingErrors(true),</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineminus">-    fCurrentFolderReadOnly(false),</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineminus">-    fCurrentLineContainedFlagInfo(false),</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineminus">-    fServerIsNetscape3xServer(false),</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineminus">-    fNumberOfUnseenMessages(0),</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineminus">-    fNumberOfExistingMessages(0),</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineminus">-    fNumberOfRecentMessages(0),</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineminus">-    fSizeOfMostRecentMessage(0),</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineminus">-    fTotalDownloadSize(0),</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineminus">-    fCurrentCommandTag(nullptr),</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineminus">-    fSelectedMailboxName(nullptr),</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineminus">-    fIMAPstate(kNonAuthenticated),</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineminus">-    fLastChunk(false),</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineminus">-    fNextChunkStartsWithNewline(false),</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineminus">-    fServerConnection(imapProtocolConnection),</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineminus">-    fHostSessionList(nullptr)</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineminus">-{</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineplus">+nsImapServerResponseParser::nsImapServerResponseParser(</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineplus">+    nsImapProtocol &amp;imapProtocolConnection)</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineplus">+    : nsIMAPGenericParser(),</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineplus">+      fReportingErrors(true),</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineplus">+      fCurrentFolderReadOnly(false),</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineplus">+      fCurrentLineContainedFlagInfo(false),</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineplus">+      fServerIsNetscape3xServer(false),</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineplus">+      fNumberOfUnseenMessages(0),</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineplus">+      fNumberOfExistingMessages(0),</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineplus">+      fNumberOfRecentMessages(0),</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineplus">+      fSizeOfMostRecentMessage(0),</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineplus">+      fTotalDownloadSize(0),</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineplus">+      fCurrentCommandTag(nullptr),</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineplus">+      fSelectedMailboxName(nullptr),</span>
<a href="#l3.48"></a><span id="l3.48" class="difflineplus">+      fIMAPstate(kNonAuthenticated),</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineplus">+      fLastChunk(false),</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineplus">+      fNextChunkStartsWithNewline(false),</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineplus">+      fServerConnection(imapProtocolConnection),</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineplus">+      fHostSessionList(nullptr) {</span>
<a href="#l3.53"></a><span id="l3.53">   fSearchResults = nsImapSearchResultSequence::CreateSearchResultSequence();</span>
<a href="#l3.54"></a><span id="l3.54">   fFolderAdminUrl = nullptr;</span>
<a href="#l3.55"></a><span id="l3.55">   fNetscapeServerVersionString = nullptr;</span>
<a href="#l3.56"></a><span id="l3.56">   fXSenderInfo = nullptr;</span>
<a href="#l3.57"></a><span id="l3.57">   fSupportsUserDefinedFlags = 0;</span>
<a href="#l3.58"></a><span id="l3.58">   fSettablePermanentFlags = 0;</span>
<a href="#l3.59"></a><span id="l3.59">   fCapabilityFlag = kCapabilityUndefined;</span>
<a href="#l3.60"></a><span id="l3.60">   fLastAlert = nullptr;</span>
<a href="#l3.61"></a><span id="l3.61" class="difflineat">@@ -56,711 +56,632 @@ nsImapServerResponseParser::nsImapServer</span>
<a href="#l3.62"></a><span id="l3.62">   fStatusRecentMessages = 0;</span>
<a href="#l3.63"></a><span id="l3.63">   fStatusNextUID = nsMsgKey_None;</span>
<a href="#l3.64"></a><span id="l3.64">   fStatusExistingMessages = 0;</span>
<a href="#l3.65"></a><span id="l3.65">   fReceivedHeaderOrSizeForUID = nsMsgKey_None;</span>
<a href="#l3.66"></a><span id="l3.66">   fCondStoreEnabled = false;</span>
<a href="#l3.67"></a><span id="l3.67">   fStdJunkNotJunkUseOk = false;</span>
<a href="#l3.68"></a><span id="l3.68"> }</span>
<a href="#l3.69"></a><span id="l3.69"> </span>
<a href="#l3.70"></a><span id="l3.70" class="difflineminus">-nsImapServerResponseParser::~nsImapServerResponseParser()</span>
<a href="#l3.71"></a><span id="l3.71" class="difflineminus">-{</span>
<a href="#l3.72"></a><span id="l3.72" class="difflineminus">-  PR_Free( fCurrentCommandTag );</span>
<a href="#l3.73"></a><span id="l3.73" class="difflineplus">+nsImapServerResponseParser::~nsImapServerResponseParser() {</span>
<a href="#l3.74"></a><span id="l3.74" class="difflineplus">+  PR_Free(fCurrentCommandTag);</span>
<a href="#l3.75"></a><span id="l3.75">   delete fSearchResults;</span>
<a href="#l3.76"></a><span id="l3.76" class="difflineminus">-  PR_Free( fFolderAdminUrl );</span>
<a href="#l3.77"></a><span id="l3.77" class="difflineminus">-  PR_Free( fNetscapeServerVersionString );</span>
<a href="#l3.78"></a><span id="l3.78" class="difflineminus">-  PR_Free( fXSenderInfo );</span>
<a href="#l3.79"></a><span id="l3.79" class="difflineminus">-  PR_Free( fLastAlert );</span>
<a href="#l3.80"></a><span id="l3.80" class="difflineminus">-  PR_Free( fSelectedMailboxName );</span>
<a href="#l3.81"></a><span id="l3.81" class="difflineplus">+  PR_Free(fFolderAdminUrl);</span>
<a href="#l3.82"></a><span id="l3.82" class="difflineplus">+  PR_Free(fNetscapeServerVersionString);</span>
<a href="#l3.83"></a><span id="l3.83" class="difflineplus">+  PR_Free(fXSenderInfo);</span>
<a href="#l3.84"></a><span id="l3.84" class="difflineplus">+  PR_Free(fLastAlert);</span>
<a href="#l3.85"></a><span id="l3.85" class="difflineplus">+  PR_Free(fSelectedMailboxName);</span>
<a href="#l3.86"></a><span id="l3.86">   PR_Free(fAuthChallenge);</span>
<a href="#l3.87"></a><span id="l3.87"> }</span>
<a href="#l3.88"></a><span id="l3.88"> </span>
<a href="#l3.89"></a><span id="l3.89" class="difflineminus">-bool nsImapServerResponseParser::LastCommandSuccessful()</span>
<a href="#l3.90"></a><span id="l3.90" class="difflineminus">-{</span>
<a href="#l3.91"></a><span id="l3.91" class="difflineminus">-  return (!CommandFailed() &amp;&amp;</span>
<a href="#l3.92"></a><span id="l3.92" class="difflineminus">-    !fServerConnection.DeathSignalReceived() &amp;&amp;</span>
<a href="#l3.93"></a><span id="l3.93" class="difflineminus">-    nsIMAPGenericParser::LastCommandSuccessful());</span>
<a href="#l3.94"></a><span id="l3.94" class="difflineplus">+bool nsImapServerResponseParser::LastCommandSuccessful() {</span>
<a href="#l3.95"></a><span id="l3.95" class="difflineplus">+  return (!CommandFailed() &amp;&amp; !fServerConnection.DeathSignalReceived() &amp;&amp;</span>
<a href="#l3.96"></a><span id="l3.96" class="difflineplus">+          nsIMAPGenericParser::LastCommandSuccessful());</span>
<a href="#l3.97"></a><span id="l3.97"> }</span>
<a href="#l3.98"></a><span id="l3.98"> </span>
<a href="#l3.99"></a><span id="l3.99"> // returns true if things look ok to continue</span>
<a href="#l3.100"></a><span id="l3.100" class="difflineminus">-bool nsImapServerResponseParser::GetNextLineForParser(char **nextLine)</span>
<a href="#l3.101"></a><span id="l3.101" class="difflineminus">-{</span>
<a href="#l3.102"></a><span id="l3.102" class="difflineplus">+bool nsImapServerResponseParser::GetNextLineForParser(char **nextLine) {</span>
<a href="#l3.103"></a><span id="l3.103">   bool rv = true;</span>
<a href="#l3.104"></a><span id="l3.104">   *nextLine = fServerConnection.CreateNewLineFromSocket();</span>
<a href="#l3.105"></a><span id="l3.105">   if (fServerConnection.DeathSignalReceived() ||</span>
<a href="#l3.106"></a><span id="l3.106">       NS_FAILED(fServerConnection.GetConnectionStatus()))</span>
<a href="#l3.107"></a><span id="l3.107">     rv = false;</span>
<a href="#l3.108"></a><span id="l3.108">   // we'd really like to try to silently reconnect, but we shouldn't put this</span>
<a href="#l3.109"></a><span id="l3.109">   // message up just in the interrupt case</span>
<a href="#l3.110"></a><span id="l3.110">   if (NS_FAILED(fServerConnection.GetConnectionStatus()) &amp;&amp;</span>
<a href="#l3.111"></a><span id="l3.111">       !fServerConnection.DeathSignalReceived())</span>
<a href="#l3.112"></a><span id="l3.112">     fServerConnection.AlertUserEventUsingName(&quot;imapServerDisconnected&quot;);</span>
<a href="#l3.113"></a><span id="l3.113">   return rv;</span>
<a href="#l3.114"></a><span id="l3.114"> }</span>
<a href="#l3.115"></a><span id="l3.115"> </span>
<a href="#l3.116"></a><span id="l3.116" class="difflineminus">-bool nsImapServerResponseParser::CommandFailed()</span>
<a href="#l3.117"></a><span id="l3.117" class="difflineminus">-{</span>
<a href="#l3.118"></a><span id="l3.118" class="difflineplus">+bool nsImapServerResponseParser::CommandFailed() {</span>
<a href="#l3.119"></a><span id="l3.119">   return fCurrentCommandFailed;</span>
<a href="#l3.120"></a><span id="l3.120"> }</span>
<a href="#l3.121"></a><span id="l3.121"> </span>
<a href="#l3.122"></a><span id="l3.122" class="difflineminus">-void nsImapServerResponseParser::SetCommandFailed(bool failed)</span>
<a href="#l3.123"></a><span id="l3.123" class="difflineminus">-{</span>
<a href="#l3.124"></a><span id="l3.124" class="difflineplus">+void nsImapServerResponseParser::SetCommandFailed(bool failed) {</span>
<a href="#l3.125"></a><span id="l3.125">   fCurrentCommandFailed = failed;</span>
<a href="#l3.126"></a><span id="l3.126"> }</span>
<a href="#l3.127"></a><span id="l3.127"> </span>
<a href="#l3.128"></a><span id="l3.128" class="difflineminus">-void nsImapServerResponseParser::SetFlagState(nsIImapFlagAndUidState *state)</span>
<a href="#l3.129"></a><span id="l3.129" class="difflineminus">-{</span>
<a href="#l3.130"></a><span id="l3.130" class="difflineplus">+void nsImapServerResponseParser::SetFlagState(nsIImapFlagAndUidState *state) {</span>
<a href="#l3.131"></a><span id="l3.131">   fFlagState = state;</span>
<a href="#l3.132"></a><span id="l3.132"> }</span>
<a href="#l3.133"></a><span id="l3.133"> </span>
<a href="#l3.134"></a><span id="l3.134" class="difflineminus">-uint32_t nsImapServerResponseParser::SizeOfMostRecentMessage()</span>
<a href="#l3.135"></a><span id="l3.135" class="difflineminus">-{</span>
<a href="#l3.136"></a><span id="l3.136" class="difflineplus">+uint32_t nsImapServerResponseParser::SizeOfMostRecentMessage() {</span>
<a href="#l3.137"></a><span id="l3.137">   return fSizeOfMostRecentMessage;</span>
<a href="#l3.138"></a><span id="l3.138"> }</span>
<a href="#l3.139"></a><span id="l3.139"> </span>
<a href="#l3.140"></a><span id="l3.140"> // Call this when adding a pipelined command to the session</span>
<a href="#l3.141"></a><span id="l3.141" class="difflineminus">-void nsImapServerResponseParser::IncrementNumberOfTaggedResponsesExpected(const char *newExpectedTag)</span>
<a href="#l3.142"></a><span id="l3.142" class="difflineminus">-{</span>
<a href="#l3.143"></a><span id="l3.143" class="difflineplus">+void nsImapServerResponseParser::IncrementNumberOfTaggedResponsesExpected(</span>
<a href="#l3.144"></a><span id="l3.144" class="difflineplus">+    const char *newExpectedTag) {</span>
<a href="#l3.145"></a><span id="l3.145">   fNumberOfTaggedResponsesExpected++;</span>
<a href="#l3.146"></a><span id="l3.146" class="difflineminus">-  PR_Free( fCurrentCommandTag );</span>
<a href="#l3.147"></a><span id="l3.147" class="difflineplus">+  PR_Free(fCurrentCommandTag);</span>
<a href="#l3.148"></a><span id="l3.148">   fCurrentCommandTag = PL_strdup(newExpectedTag);</span>
<a href="#l3.149"></a><span id="l3.149" class="difflineminus">-  if (!fCurrentCommandTag)</span>
<a href="#l3.150"></a><span id="l3.150" class="difflineminus">-    HandleMemoryFailure();</span>
<a href="#l3.151"></a><span id="l3.151" class="difflineplus">+  if (!fCurrentCommandTag) HandleMemoryFailure();</span>
<a href="#l3.152"></a><span id="l3.152"> }</span>
<a href="#l3.153"></a><span id="l3.153"> </span>
<a href="#l3.154"></a><span id="l3.154" class="difflineminus">-void nsImapServerResponseParser::InitializeState()</span>
<a href="#l3.155"></a><span id="l3.155" class="difflineminus">-{</span>
<a href="#l3.156"></a><span id="l3.156" class="difflineplus">+void nsImapServerResponseParser::InitializeState() {</span>
<a href="#l3.157"></a><span id="l3.157">   fCurrentCommandFailed = false;</span>
<a href="#l3.158"></a><span id="l3.158">   fNumberOfRecentMessages = 0;</span>
<a href="#l3.159"></a><span id="l3.159">   fReceivedHeaderOrSizeForUID = nsMsgKey_None;</span>
<a href="#l3.160"></a><span id="l3.160"> }</span>
<a href="#l3.161"></a><span id="l3.161"> </span>
<a href="#l3.162"></a><span id="l3.162"> // RFC3501:  response = *(continue-req / response-data) response-done</span>
<a href="#l3.163"></a><span id="l3.163"> //           response-data = &quot;*&quot; SP (resp-cond-state / resp-cond-bye /</span>
<a href="#l3.164"></a><span id="l3.164"> //                           mailbox-data / message-data / capability-data) CRLF</span>
<a href="#l3.165"></a><span id="l3.165"> //           continue-req    = &quot;+&quot; SP (resp-text / base64) CRLF</span>
<a href="#l3.166"></a><span id="l3.166" class="difflineminus">-void nsImapServerResponseParser::ParseIMAPServerResponse(const char *aCurrentCommand,</span>
<a href="#l3.167"></a><span id="l3.167" class="difflineminus">-                                                         bool aIgnoreBadAndNOResponses,</span>
<a href="#l3.168"></a><span id="l3.168" class="difflineminus">-                                                         char *aGreetingWithCapability)</span>
<a href="#l3.169"></a><span id="l3.169" class="difflineminus">-{</span>
<a href="#l3.170"></a><span id="l3.170" class="difflineminus">-</span>
<a href="#l3.171"></a><span id="l3.171" class="difflineplus">+void nsImapServerResponseParser::ParseIMAPServerResponse(</span>
<a href="#l3.172"></a><span id="l3.172" class="difflineplus">+    const char *aCurrentCommand, bool aIgnoreBadAndNOResponses,</span>
<a href="#l3.173"></a><span id="l3.173" class="difflineplus">+    char *aGreetingWithCapability) {</span>
<a href="#l3.174"></a><span id="l3.174">   NS_ASSERTION(aCurrentCommand &amp;&amp; *aCurrentCommand != '\r' &amp;&amp;</span>
<a href="#l3.175"></a><span id="l3.175" class="difflineminus">-    *aCurrentCommand != '\n' &amp;&amp; *aCurrentCommand != ' ', &quot;Invailid command string&quot;);</span>
<a href="#l3.176"></a><span id="l3.176" class="difflineplus">+                   *aCurrentCommand != '\n' &amp;&amp; *aCurrentCommand != ' ',</span>
<a href="#l3.177"></a><span id="l3.177" class="difflineplus">+               &quot;Invailid command string&quot;);</span>
<a href="#l3.178"></a><span id="l3.178">   bool sendingIdleDone = !strcmp(aCurrentCommand, &quot;DONE&quot; CRLF);</span>
<a href="#l3.179"></a><span id="l3.179" class="difflineminus">-  if (sendingIdleDone)</span>
<a href="#l3.180"></a><span id="l3.180" class="difflineminus">-    fWaitingForMoreClientInput = false;</span>
<a href="#l3.181"></a><span id="l3.181" class="difflineplus">+  if (sendingIdleDone) fWaitingForMoreClientInput = false;</span>
<a href="#l3.182"></a><span id="l3.182"> </span>
<a href="#l3.183"></a><span id="l3.183">   // Reinitialize the parser</span>
<a href="#l3.184"></a><span id="l3.184">   SetConnected(true);</span>
<a href="#l3.185"></a><span id="l3.185">   SetSyntaxError(false);</span>
<a href="#l3.186"></a><span id="l3.186"> </span>
<a href="#l3.187"></a><span id="l3.187">   // Reinitialize our state</span>
<a href="#l3.188"></a><span id="l3.188">   InitializeState();</span>
<a href="#l3.189"></a><span id="l3.189"> </span>
<a href="#l3.190"></a><span id="l3.190">   // the default is to not pipeline</span>
<a href="#l3.191"></a><span id="l3.191">   fNumberOfTaggedResponsesExpected = 1;</span>
<a href="#l3.192"></a><span id="l3.192">   int numberOfTaggedResponsesReceived = 0;</span>
<a href="#l3.193"></a><span id="l3.193"> </span>
<a href="#l3.194"></a><span id="l3.194">   nsCString copyCurrentCommand(aCurrentCommand);</span>
<a href="#l3.195"></a><span id="l3.195" class="difflineminus">-  if (!fServerConnection.DeathSignalReceived())</span>
<a href="#l3.196"></a><span id="l3.196" class="difflineminus">-  {</span>
<a href="#l3.197"></a><span id="l3.197" class="difflineplus">+  if (!fServerConnection.DeathSignalReceived()) {</span>
<a href="#l3.198"></a><span id="l3.198">     char *placeInTokenString = nullptr;</span>
<a href="#l3.199"></a><span id="l3.199">     char *tagToken = nullptr;</span>
<a href="#l3.200"></a><span id="l3.200">     const char *commandToken = nullptr;</span>
<a href="#l3.201"></a><span id="l3.201">     bool inIdle = false;</span>
<a href="#l3.202"></a><span id="l3.202" class="difflineminus">-    if (!sendingIdleDone)</span>
<a href="#l3.203"></a><span id="l3.203" class="difflineminus">-    {</span>
<a href="#l3.204"></a><span id="l3.204" class="difflineplus">+    if (!sendingIdleDone) {</span>
<a href="#l3.205"></a><span id="l3.205">       placeInTokenString = copyCurrentCommand.BeginWriting();</span>
<a href="#l3.206"></a><span id="l3.206">       tagToken = NS_strtok(WHITESPACE, &amp;placeInTokenString);</span>
<a href="#l3.207"></a><span id="l3.207">       commandToken = NS_strtok(WHITESPACE, &amp;placeInTokenString);</span>
<a href="#l3.208"></a><span id="l3.208" class="difflineminus">-    }</span>
<a href="#l3.209"></a><span id="l3.209" class="difflineminus">-    else</span>
<a href="#l3.210"></a><span id="l3.210" class="difflineplus">+    } else</span>
<a href="#l3.211"></a><span id="l3.211">       commandToken = &quot;DONE&quot;;</span>
<a href="#l3.212"></a><span id="l3.212" class="difflineminus">-    if (tagToken)</span>
<a href="#l3.213"></a><span id="l3.213" class="difflineminus">-    {</span>
<a href="#l3.214"></a><span id="l3.214" class="difflineminus">-      PR_Free( fCurrentCommandTag );</span>
<a href="#l3.215"></a><span id="l3.215" class="difflineplus">+    if (tagToken) {</span>
<a href="#l3.216"></a><span id="l3.216" class="difflineplus">+      PR_Free(fCurrentCommandTag);</span>
<a href="#l3.217"></a><span id="l3.217">       fCurrentCommandTag = PL_strdup(tagToken);</span>
<a href="#l3.218"></a><span id="l3.218" class="difflineminus">-      if (!fCurrentCommandTag)</span>
<a href="#l3.219"></a><span id="l3.219" class="difflineminus">-        HandleMemoryFailure();</span>
<a href="#l3.220"></a><span id="l3.220" class="difflineplus">+      if (!fCurrentCommandTag) HandleMemoryFailure();</span>
<a href="#l3.221"></a><span id="l3.221">       inIdle = commandToken &amp;&amp; !strcmp(commandToken, &quot;IDLE&quot;);</span>
<a href="#l3.222"></a><span id="l3.222">     }</span>
<a href="#l3.223"></a><span id="l3.223"> </span>
<a href="#l3.224"></a><span id="l3.224">     if (commandToken &amp;&amp; ContinueParse())</span>
<a href="#l3.225"></a><span id="l3.225">       PreProcessCommandToken(commandToken, aCurrentCommand);</span>
<a href="#l3.226"></a><span id="l3.226"> </span>
<a href="#l3.227"></a><span id="l3.227">     // For checking expected response to IDLE command below.</span>
<a href="#l3.228"></a><span id="l3.228">     bool untagged = false;</span>
<a href="#l3.229"></a><span id="l3.229"> </span>
<a href="#l3.230"></a><span id="l3.230" class="difflineminus">-    if (ContinueParse())</span>
<a href="#l3.231"></a><span id="l3.231" class="difflineminus">-    {</span>
<a href="#l3.232"></a><span id="l3.232" class="difflineplus">+    if (ContinueParse()) {</span>
<a href="#l3.233"></a><span id="l3.233">       ResetLexAnalyzer();</span>
<a href="#l3.234"></a><span id="l3.234"> </span>
<a href="#l3.235"></a><span id="l3.235" class="difflineminus">-      if (aGreetingWithCapability)</span>
<a href="#l3.236"></a><span id="l3.236" class="difflineminus">-      {</span>
<a href="#l3.237"></a><span id="l3.237" class="difflineplus">+      if (aGreetingWithCapability) {</span>
<a href="#l3.238"></a><span id="l3.238">         PR_FREEIF(fCurrentLine);</span>
<a href="#l3.239"></a><span id="l3.239">         fCurrentLine = aGreetingWithCapability;</span>
<a href="#l3.240"></a><span id="l3.240">       }</span>
<a href="#l3.241"></a><span id="l3.241"> </span>
<a href="#l3.242"></a><span id="l3.242">       do {</span>
<a href="#l3.243"></a><span id="l3.243">         AdvanceToNextToken();</span>
<a href="#l3.244"></a><span id="l3.244"> </span>
<a href="#l3.245"></a><span id="l3.245">         // untagged responses [RFC3501, Sec. 2.2.2]</span>
<a href="#l3.246"></a><span id="l3.246" class="difflineminus">-        while (ContinueParse() &amp;&amp; fNextToken &amp;&amp; *fNextToken == '*')</span>
<a href="#l3.247"></a><span id="l3.247" class="difflineminus">-        {</span>
<a href="#l3.248"></a><span id="l3.248" class="difflineplus">+        while (ContinueParse() &amp;&amp; fNextToken &amp;&amp; *fNextToken == '*') {</span>
<a href="#l3.249"></a><span id="l3.249">           response_data();</span>
<a href="#l3.250"></a><span id="l3.250" class="difflineminus">-          if (ContinueParse())</span>
<a href="#l3.251"></a><span id="l3.251" class="difflineminus">-          {</span>
<a href="#l3.252"></a><span id="l3.252" class="difflineplus">+          if (ContinueParse()) {</span>
<a href="#l3.253"></a><span id="l3.253">             if (!fAtEndOfLine)</span>
<a href="#l3.254"></a><span id="l3.254">               SetSyntaxError(true);</span>
<a href="#l3.255"></a><span id="l3.255" class="difflineminus">-            else if (!inIdle &amp;&amp; !fCurrentCommandFailed &amp;&amp; !aGreetingWithCapability)</span>
<a href="#l3.256"></a><span id="l3.256" class="difflineplus">+            else if (!inIdle &amp;&amp; !fCurrentCommandFailed &amp;&amp;</span>
<a href="#l3.257"></a><span id="l3.257" class="difflineplus">+                     !aGreetingWithCapability)</span>
<a href="#l3.258"></a><span id="l3.258">               AdvanceToNextToken();</span>
<a href="#l3.259"></a><span id="l3.259">           }</span>
<a href="#l3.260"></a><span id="l3.260">           untagged = true;</span>
<a href="#l3.261"></a><span id="l3.261">         }</span>
<a href="#l3.262"></a><span id="l3.262"> </span>
<a href="#l3.263"></a><span id="l3.263">         // command continuation request [RFC3501, Sec. 7.5]</span>
<a href="#l3.264"></a><span id="l3.264" class="difflineminus">-        if (ContinueParse() &amp;&amp; fNextToken &amp;&amp; *fNextToken == '+')  // never pipeline APPEND or AUTHENTICATE</span>
<a href="#l3.265"></a><span id="l3.265" class="difflineplus">+        if (ContinueParse() &amp;&amp; fNextToken &amp;&amp;</span>
<a href="#l3.266"></a><span id="l3.266" class="difflineplus">+            *fNextToken == '+')  // never pipeline APPEND or AUTHENTICATE</span>
<a href="#l3.267"></a><span id="l3.267">         {</span>
<a href="#l3.268"></a><span id="l3.268" class="difflineminus">-          NS_ASSERTION((fNumberOfTaggedResponsesExpected - numberOfTaggedResponsesReceived) == 1,</span>
<a href="#l3.269"></a><span id="l3.269" class="difflineminus">-            &quot; didn't get the number of tagged responses we expected&quot;);</span>
<a href="#l3.270"></a><span id="l3.270" class="difflineplus">+          NS_ASSERTION(</span>
<a href="#l3.271"></a><span id="l3.271" class="difflineplus">+              (fNumberOfTaggedResponsesExpected -</span>
<a href="#l3.272"></a><span id="l3.272" class="difflineplus">+               numberOfTaggedResponsesReceived) == 1,</span>
<a href="#l3.273"></a><span id="l3.273" class="difflineplus">+              &quot; didn't get the number of tagged responses we expected&quot;);</span>
<a href="#l3.274"></a><span id="l3.274">           numberOfTaggedResponsesReceived = fNumberOfTaggedResponsesExpected;</span>
<a href="#l3.275"></a><span id="l3.275" class="difflineminus">-          if (commandToken &amp;&amp; !PL_strcasecmp(commandToken, &quot;authenticate&quot;) &amp;&amp; placeInTokenString &amp;&amp;</span>
<a href="#l3.276"></a><span id="l3.276" class="difflineminus">-            (!PL_strncasecmp(placeInTokenString, &quot;CRAM-MD5&quot;, strlen(&quot;CRAM-MD5&quot;))</span>
<a href="#l3.277"></a><span id="l3.277" class="difflineminus">-             || !PL_strncasecmp(placeInTokenString, &quot;NTLM&quot;, strlen(&quot;NTLM&quot;))</span>
<a href="#l3.278"></a><span id="l3.278" class="difflineminus">-             || !PL_strncasecmp(placeInTokenString, &quot;GSSAPI&quot;, strlen(&quot;GSSAPI&quot;))</span>
<a href="#l3.279"></a><span id="l3.279" class="difflineminus">-             || !PL_strncasecmp(placeInTokenString, &quot;MSN&quot;, strlen(&quot;MSN&quot;))))</span>
<a href="#l3.280"></a><span id="l3.280" class="difflineminus">-          {</span>
<a href="#l3.281"></a><span id="l3.281" class="difflineminus">-            // we need to store the challenge from the server if we are using CRAM-MD5 or NTLM.</span>
<a href="#l3.282"></a><span id="l3.282" class="difflineplus">+          if (commandToken &amp;&amp; !PL_strcasecmp(commandToken, &quot;authenticate&quot;) &amp;&amp;</span>
<a href="#l3.283"></a><span id="l3.283" class="difflineplus">+              placeInTokenString &amp;&amp;</span>
<a href="#l3.284"></a><span id="l3.284" class="difflineplus">+              (!PL_strncasecmp(placeInTokenString, &quot;CRAM-MD5&quot;,</span>
<a href="#l3.285"></a><span id="l3.285" class="difflineplus">+                               strlen(&quot;CRAM-MD5&quot;)) ||</span>
<a href="#l3.286"></a><span id="l3.286" class="difflineplus">+               !PL_strncasecmp(placeInTokenString, &quot;NTLM&quot;, strlen(&quot;NTLM&quot;)) ||</span>
<a href="#l3.287"></a><span id="l3.287" class="difflineplus">+               !PL_strncasecmp(placeInTokenString, &quot;GSSAPI&quot;,</span>
<a href="#l3.288"></a><span id="l3.288" class="difflineplus">+                               strlen(&quot;GSSAPI&quot;)) ||</span>
<a href="#l3.289"></a><span id="l3.289" class="difflineplus">+               !PL_strncasecmp(placeInTokenString, &quot;MSN&quot;, strlen(&quot;MSN&quot;)))) {</span>
<a href="#l3.290"></a><span id="l3.290" class="difflineplus">+            // we need to store the challenge from the server if we are using</span>
<a href="#l3.291"></a><span id="l3.291" class="difflineplus">+            // CRAM-MD5 or NTLM.</span>
<a href="#l3.292"></a><span id="l3.292">             authChallengeResponse_data();</span>
<a href="#l3.293"></a><span id="l3.293">           }</span>
<a href="#l3.294"></a><span id="l3.294" class="difflineminus">-        }</span>
<a href="#l3.295"></a><span id="l3.295" class="difflineminus">-        else</span>
<a href="#l3.296"></a><span id="l3.296" class="difflineplus">+        } else</span>
<a href="#l3.297"></a><span id="l3.297">           numberOfTaggedResponsesReceived++;</span>
<a href="#l3.298"></a><span id="l3.298"> </span>
<a href="#l3.299"></a><span id="l3.299">         if (numberOfTaggedResponsesReceived &lt; fNumberOfTaggedResponsesExpected)</span>
<a href="#l3.300"></a><span id="l3.300">           response_tagged();</span>
<a href="#l3.301"></a><span id="l3.301"> </span>
<a href="#l3.302"></a><span id="l3.302" class="difflineminus">-      } while (ContinueParse() &amp;&amp; !inIdle &amp;&amp; (numberOfTaggedResponsesReceived &lt; fNumberOfTaggedResponsesExpected));</span>
<a href="#l3.303"></a><span id="l3.303" class="difflineplus">+      } while (</span>
<a href="#l3.304"></a><span id="l3.304" class="difflineplus">+          ContinueParse() &amp;&amp; !inIdle &amp;&amp;</span>
<a href="#l3.305"></a><span id="l3.305" class="difflineplus">+          (numberOfTaggedResponsesReceived &lt; fNumberOfTaggedResponsesExpected));</span>
<a href="#l3.306"></a><span id="l3.306"> </span>
<a href="#l3.307"></a><span id="l3.307">       // check and see if the server is waiting for more input</span>
<a href="#l3.308"></a><span id="l3.308" class="difflineminus">-      // it's possible that we ate this + while parsing certain responses (like cram data),</span>
<a href="#l3.309"></a><span id="l3.309" class="difflineminus">-      // in these cases, the parsing routine for that specific command will manually set</span>
<a href="#l3.310"></a><span id="l3.310" class="difflineminus">-      // fWaitingForMoreClientInput so we don't lose that information....</span>
<a href="#l3.311"></a><span id="l3.311" class="difflineminus">-      if ((fNextToken &amp;&amp; *fNextToken == '+') || inIdle)</span>
<a href="#l3.312"></a><span id="l3.312" class="difflineminus">-      {</span>
<a href="#l3.313"></a><span id="l3.313" class="difflineminus">-        if (inIdle &amp;&amp; !((fNextToken &amp;&amp; *fNextToken == '+') || untagged))</span>
<a href="#l3.314"></a><span id="l3.314" class="difflineminus">-        {</span>
<a href="#l3.315"></a><span id="l3.315" class="difflineplus">+      // it's possible that we ate this + while parsing certain responses (like</span>
<a href="#l3.316"></a><span id="l3.316" class="difflineplus">+      // cram data), in these cases, the parsing routine for that specific</span>
<a href="#l3.317"></a><span id="l3.317" class="difflineplus">+      // command will manually set fWaitingForMoreClientInput so we don't lose</span>
<a href="#l3.318"></a><span id="l3.318" class="difflineplus">+      // that information....</span>
<a href="#l3.319"></a><span id="l3.319" class="difflineplus">+      if ((fNextToken &amp;&amp; *fNextToken == '+') || inIdle) {</span>
<a href="#l3.320"></a><span id="l3.320" class="difflineplus">+        if (inIdle &amp;&amp; !((fNextToken &amp;&amp; *fNextToken == '+') || untagged)) {</span>
<a href="#l3.321"></a><span id="l3.321">           // IDLE &quot;response&quot; + will not be &quot;eaten&quot; as described above since it</span>
<a href="#l3.322"></a><span id="l3.322">           // is not an authentication response. So if IDLE response does not</span>
<a href="#l3.323"></a><span id="l3.323">           // begin with '+' (continuation) or '*' (untagged and probably useful</span>
<a href="#l3.324"></a><span id="l3.324">           // response) then something is wrong and it is probably a tagged</span>
<a href="#l3.325"></a><span id="l3.325" class="difflineminus">-          // NO or BAD due to transient error or bad configuration of the server.</span>
<a href="#l3.326"></a><span id="l3.326" class="difflineminus">-          if (!PL_strcmp(fCurrentCommandTag, fNextToken))</span>
<a href="#l3.327"></a><span id="l3.327" class="difflineminus">-          {</span>
<a href="#l3.328"></a><span id="l3.328" class="difflineplus">+          // NO or BAD due to transient error or bad configuration of the</span>
<a href="#l3.329"></a><span id="l3.329" class="difflineplus">+          // server.</span>
<a href="#l3.330"></a><span id="l3.330" class="difflineplus">+          if (!PL_strcmp(fCurrentCommandTag, fNextToken)) {</span>
<a href="#l3.331"></a><span id="l3.331">             response_tagged();</span>
<a href="#l3.332"></a><span id="l3.332" class="difflineminus">-          }</span>
<a href="#l3.333"></a><span id="l3.333" class="difflineminus">-          else</span>
<a href="#l3.334"></a><span id="l3.334" class="difflineminus">-          {</span>
<a href="#l3.335"></a><span id="l3.335" class="difflineminus">-            // Expected tag doesn't match the received tag. Not good, start over.</span>
<a href="#l3.336"></a><span id="l3.336" class="difflineplus">+          } else {</span>
<a href="#l3.337"></a><span id="l3.337" class="difflineplus">+            // Expected tag doesn't match the received tag. Not good, start</span>
<a href="#l3.338"></a><span id="l3.338" class="difflineplus">+            // over.</span>
<a href="#l3.339"></a><span id="l3.339">             response_fatal();</span>
<a href="#l3.340"></a><span id="l3.340">           }</span>
<a href="#l3.341"></a><span id="l3.341" class="difflineminus">-          // Show an alert notification containing the server response to bad IDLE.</span>
<a href="#l3.342"></a><span id="l3.342" class="difflineplus">+          // Show an alert notification containing the server response to bad</span>
<a href="#l3.343"></a><span id="l3.343" class="difflineplus">+          // IDLE.</span>
<a href="#l3.344"></a><span id="l3.344">           fServerConnection.AlertUserEventFromServer(fCurrentLine, true);</span>
<a href="#l3.345"></a><span id="l3.345" class="difflineminus">-        }</span>
<a href="#l3.346"></a><span id="l3.346" class="difflineminus">-        else</span>
<a href="#l3.347"></a><span id="l3.347" class="difflineminus">-        {</span>
<a href="#l3.348"></a><span id="l3.348" class="difflineplus">+        } else {</span>
<a href="#l3.349"></a><span id="l3.349">           fWaitingForMoreClientInput = true;</span>
<a href="#l3.350"></a><span id="l3.350">         }</span>
<a href="#l3.351"></a><span id="l3.351">       }</span>
<a href="#l3.352"></a><span id="l3.352">       // if we aren't still waiting for more input....</span>
<a href="#l3.353"></a><span id="l3.353" class="difflineminus">-      else if (!fWaitingForMoreClientInput &amp;&amp; !aGreetingWithCapability)</span>
<a href="#l3.354"></a><span id="l3.354" class="difflineminus">-      {</span>
<a href="#l3.355"></a><span id="l3.355" class="difflineminus">-        if (ContinueParse())</span>
<a href="#l3.356"></a><span id="l3.356" class="difflineminus">-          response_done();</span>
<a href="#l3.357"></a><span id="l3.357" class="difflineplus">+      else if (!fWaitingForMoreClientInput &amp;&amp; !aGreetingWithCapability) {</span>
<a href="#l3.358"></a><span id="l3.358" class="difflineplus">+        if (ContinueParse()) response_done();</span>
<a href="#l3.359"></a><span id="l3.359"> </span>
<a href="#l3.360"></a><span id="l3.360" class="difflineminus">-        if (ContinueParse() &amp;&amp; !CommandFailed())</span>
<a href="#l3.361"></a><span id="l3.361" class="difflineminus">-        {</span>
<a href="#l3.362"></a><span id="l3.362" class="difflineplus">+        if (ContinueParse() &amp;&amp; !CommandFailed()) {</span>
<a href="#l3.363"></a><span id="l3.363">           // a successful command may change the eIMAPstate</span>
<a href="#l3.364"></a><span id="l3.364">           ProcessOkCommand(commandToken);</span>
<a href="#l3.365"></a><span id="l3.365" class="difflineminus">-        }</span>
<a href="#l3.366"></a><span id="l3.366" class="difflineminus">-        else if (CommandFailed())</span>
<a href="#l3.367"></a><span id="l3.367" class="difflineminus">-        {</span>
<a href="#l3.368"></a><span id="l3.368" class="difflineplus">+        } else if (CommandFailed()) {</span>
<a href="#l3.369"></a><span id="l3.369">           // a failed command may change the eIMAPstate</span>
<a href="#l3.370"></a><span id="l3.370">           ProcessBadCommand(commandToken);</span>
<a href="#l3.371"></a><span id="l3.371">           if (fReportingErrors &amp;&amp; !aIgnoreBadAndNOResponses)</span>
<a href="#l3.372"></a><span id="l3.372">             fServerConnection.AlertUserEventFromServer(fCurrentLine, false);</span>
<a href="#l3.373"></a><span id="l3.373">         }</span>
<a href="#l3.374"></a><span id="l3.374">       }</span>
<a href="#l3.375"></a><span id="l3.375">     }</span>
<a href="#l3.376"></a><span id="l3.376" class="difflineminus">-  }</span>
<a href="#l3.377"></a><span id="l3.377" class="difflineminus">-  else</span>
<a href="#l3.378"></a><span id="l3.378" class="difflineplus">+  } else</span>
<a href="#l3.379"></a><span id="l3.379">     SetConnected(false);</span>
<a href="#l3.380"></a><span id="l3.380"> }</span>
<a href="#l3.381"></a><span id="l3.381"> </span>
<a href="#l3.382"></a><span id="l3.382" class="difflineminus">-void nsImapServerResponseParser::HandleMemoryFailure()</span>
<a href="#l3.383"></a><span id="l3.383" class="difflineminus">-{</span>
<a href="#l3.384"></a><span id="l3.384" class="difflineplus">+void nsImapServerResponseParser::HandleMemoryFailure() {</span>
<a href="#l3.385"></a><span id="l3.385">   fServerConnection.AlertUserEventUsingName(&quot;imapOutOfMemory&quot;);</span>
<a href="#l3.386"></a><span id="l3.386">   nsIMAPGenericParser::HandleMemoryFailure();</span>
<a href="#l3.387"></a><span id="l3.387"> }</span>
<a href="#l3.388"></a><span id="l3.388"> </span>
<a href="#l3.389"></a><span id="l3.389" class="difflineminus">-</span>
<a href="#l3.390"></a><span id="l3.390"> // SEARCH is the only command that requires pre-processing for now.</span>
<a href="#l3.391"></a><span id="l3.391"> // others will be added here.</span>
<a href="#l3.392"></a><span id="l3.392" class="difflineminus">-void nsImapServerResponseParser::PreProcessCommandToken(const char *commandToken,</span>
<a href="#l3.393"></a><span id="l3.393" class="difflineminus">-                                                        const char *currentCommand)</span>
<a href="#l3.394"></a><span id="l3.394" class="difflineminus">-{</span>
<a href="#l3.395"></a><span id="l3.395" class="difflineplus">+void nsImapServerResponseParser::PreProcessCommandToken(</span>
<a href="#l3.396"></a><span id="l3.396" class="difflineplus">+    const char *commandToken, const char *currentCommand) {</span>
<a href="#l3.397"></a><span id="l3.397">   fCurrentCommandIsSingleMessageFetch = false;</span>
<a href="#l3.398"></a><span id="l3.398">   fWaitingForMoreClientInput = false;</span>
<a href="#l3.399"></a><span id="l3.399"> </span>
<a href="#l3.400"></a><span id="l3.400">   if (!PL_strcasecmp(commandToken, &quot;SEARCH&quot;))</span>
<a href="#l3.401"></a><span id="l3.401">     fSearchResults-&gt;ResetSequence();</span>
<a href="#l3.402"></a><span id="l3.402" class="difflineminus">-  else if (!PL_strcasecmp(commandToken, &quot;SELECT&quot;) &amp;&amp; currentCommand)</span>
<a href="#l3.403"></a><span id="l3.403" class="difflineminus">-  {</span>
<a href="#l3.404"></a><span id="l3.404" class="difflineplus">+  else if (!PL_strcasecmp(commandToken, &quot;SELECT&quot;) &amp;&amp; currentCommand) {</span>
<a href="#l3.405"></a><span id="l3.405">     // the mailbox name must be quoted, so strip the quotes</span>
<a href="#l3.406"></a><span id="l3.406">     const char *openQuote = PL_strchr(currentCommand, '&quot;');</span>
<a href="#l3.407"></a><span id="l3.407">     NS_ASSERTION(openQuote, &quot;expected open quote in imap server response&quot;);</span>
<a href="#l3.408"></a><span id="l3.408" class="difflineminus">-    if (!openQuote)</span>
<a href="#l3.409"></a><span id="l3.409" class="difflineminus">-    { // ill formed select command</span>
<a href="#l3.410"></a><span id="l3.410" class="difflineplus">+    if (!openQuote) {  // ill formed select command</span>
<a href="#l3.411"></a><span id="l3.411">       openQuote = PL_strchr(currentCommand, ' ');</span>
<a href="#l3.412"></a><span id="l3.412">     }</span>
<a href="#l3.413"></a><span id="l3.413" class="difflineminus">-    PR_Free( fSelectedMailboxName);</span>
<a href="#l3.414"></a><span id="l3.414" class="difflineplus">+    PR_Free(fSelectedMailboxName);</span>
<a href="#l3.415"></a><span id="l3.415">     fSelectedMailboxName = PL_strdup(openQuote + 1);</span>
<a href="#l3.416"></a><span id="l3.416" class="difflineminus">-    if (fSelectedMailboxName)</span>
<a href="#l3.417"></a><span id="l3.417" class="difflineminus">-    {</span>
<a href="#l3.418"></a><span id="l3.418" class="difflineplus">+    if (fSelectedMailboxName) {</span>
<a href="#l3.419"></a><span id="l3.419">       // strip the escape chars and the ending quote</span>
<a href="#l3.420"></a><span id="l3.420">       char *currentChar = fSelectedMailboxName;</span>
<a href="#l3.421"></a><span id="l3.421" class="difflineminus">-      while (*currentChar)</span>
<a href="#l3.422"></a><span id="l3.422" class="difflineminus">-      {</span>
<a href="#l3.423"></a><span id="l3.423" class="difflineminus">-        if (*currentChar == '\\')</span>
<a href="#l3.424"></a><span id="l3.424" class="difflineminus">-        {</span>
<a href="#l3.425"></a><span id="l3.425" class="difflineminus">-          PL_strcpy(currentChar, currentChar+1);</span>
<a href="#l3.426"></a><span id="l3.426" class="difflineplus">+      while (*currentChar) {</span>
<a href="#l3.427"></a><span id="l3.427" class="difflineplus">+        if (*currentChar == '\\') {</span>
<a href="#l3.428"></a><span id="l3.428" class="difflineplus">+          PL_strcpy(currentChar, currentChar + 1);</span>
<a href="#l3.429"></a><span id="l3.429">           currentChar++;  // skip what we are escaping</span>
<a href="#l3.430"></a><span id="l3.430" class="difflineminus">-        }</span>
<a href="#l3.431"></a><span id="l3.431" class="difflineminus">-        else if (*currentChar == '\&quot;')</span>
<a href="#l3.432"></a><span id="l3.432" class="difflineplus">+        } else if (*currentChar == '\&quot;')</span>
<a href="#l3.433"></a><span id="l3.433">           *currentChar = 0;  // end quote</span>
<a href="#l3.434"></a><span id="l3.434">         else</span>
<a href="#l3.435"></a><span id="l3.435">           currentChar++;</span>
<a href="#l3.436"></a><span id="l3.436">       }</span>
<a href="#l3.437"></a><span id="l3.437" class="difflineminus">-    }</span>
<a href="#l3.438"></a><span id="l3.438" class="difflineminus">-    else</span>
<a href="#l3.439"></a><span id="l3.439" class="difflineplus">+    } else</span>
<a href="#l3.440"></a><span id="l3.440">       HandleMemoryFailure();</span>
<a href="#l3.441"></a><span id="l3.441"> </span>
<a href="#l3.442"></a><span id="l3.442">     // we don't want bogus info for this new box</span>
<a href="#l3.443"></a><span id="l3.443" class="difflineminus">-    //delete fFlagState;  // not our object</span>
<a href="#l3.444"></a><span id="l3.444" class="difflineminus">-    //fFlagState = nullptr;</span>
<a href="#l3.445"></a><span id="l3.445" class="difflineminus">-  }</span>
<a href="#l3.446"></a><span id="l3.446" class="difflineminus">-  else if (!PL_strcasecmp(commandToken, &quot;CLOSE&quot;))</span>
<a href="#l3.447"></a><span id="l3.447" class="difflineminus">-  {</span>
<a href="#l3.448"></a><span id="l3.448" class="difflineplus">+    // delete fFlagState;  // not our object</span>
<a href="#l3.449"></a><span id="l3.449" class="difflineplus">+    // fFlagState = nullptr;</span>
<a href="#l3.450"></a><span id="l3.450" class="difflineplus">+  } else if (!PL_strcasecmp(commandToken, &quot;CLOSE&quot;)) {</span>
<a href="#l3.451"></a><span id="l3.451">     return;  // just for debugging</span>
<a href="#l3.452"></a><span id="l3.452">     // we don't want bogus info outside the selected state</span>
<a href="#l3.453"></a><span id="l3.453" class="difflineminus">-    //delete fFlagState;  // not our object</span>
<a href="#l3.454"></a><span id="l3.454" class="difflineminus">-    //fFlagState = nullptr;</span>
<a href="#l3.455"></a><span id="l3.455" class="difflineminus">-  }</span>
<a href="#l3.456"></a><span id="l3.456" class="difflineminus">-  else if (!PL_strcasecmp(commandToken, &quot;UID&quot;))</span>
<a href="#l3.457"></a><span id="l3.457" class="difflineminus">-  {</span>
<a href="#l3.458"></a><span id="l3.458" class="difflineplus">+    // delete fFlagState;  // not our object</span>
<a href="#l3.459"></a><span id="l3.459" class="difflineplus">+    // fFlagState = nullptr;</span>
<a href="#l3.460"></a><span id="l3.460" class="difflineplus">+  } else if (!PL_strcasecmp(commandToken, &quot;UID&quot;)) {</span>
<a href="#l3.461"></a><span id="l3.461">     nsCString copyCurrentCommand(currentCommand);</span>
<a href="#l3.462"></a><span id="l3.462" class="difflineminus">-    if (!fServerConnection.DeathSignalReceived())</span>
<a href="#l3.463"></a><span id="l3.463" class="difflineminus">-    {</span>
<a href="#l3.464"></a><span id="l3.464" class="difflineplus">+    if (!fServerConnection.DeathSignalReceived()) {</span>
<a href="#l3.465"></a><span id="l3.465">       char *placeInTokenString = copyCurrentCommand.BeginWriting();</span>
<a href="#l3.466"></a><span id="l3.466" class="difflineminus">-      (void) NS_strtok(WHITESPACE, &amp;placeInTokenString); // skip tag token</span>
<a href="#l3.467"></a><span id="l3.467" class="difflineminus">-      (void) NS_strtok(WHITESPACE, &amp;placeInTokenString); // skip uid token</span>
<a href="#l3.468"></a><span id="l3.468" class="difflineplus">+      (void)NS_strtok(WHITESPACE, &amp;placeInTokenString);  // skip tag token</span>
<a href="#l3.469"></a><span id="l3.469" class="difflineplus">+      (void)NS_strtok(WHITESPACE, &amp;placeInTokenString);  // skip uid token</span>
<a href="#l3.470"></a><span id="l3.470">       char *fetchToken = NS_strtok(WHITESPACE, &amp;placeInTokenString);</span>
<a href="#l3.471"></a><span id="l3.471" class="difflineminus">-      if (!PL_strcasecmp(fetchToken, &quot;FETCH&quot;) )</span>
<a href="#l3.472"></a><span id="l3.472" class="difflineminus">-      {</span>
<a href="#l3.473"></a><span id="l3.473" class="difflineplus">+      if (!PL_strcasecmp(fetchToken, &quot;FETCH&quot;)) {</span>
<a href="#l3.474"></a><span id="l3.474">         char *uidStringToken = NS_strtok(WHITESPACE, &amp;placeInTokenString);</span>
<a href="#l3.475"></a><span id="l3.475">         // , and : are uid delimiters</span>
<a href="#l3.476"></a><span id="l3.476">         if (!PL_strchr(uidStringToken, ',') &amp;&amp; !PL_strchr(uidStringToken, ':'))</span>
<a href="#l3.477"></a><span id="l3.477">           fCurrentCommandIsSingleMessageFetch = true;</span>
<a href="#l3.478"></a><span id="l3.478">       }</span>
<a href="#l3.479"></a><span id="l3.479">     }</span>
<a href="#l3.480"></a><span id="l3.480">   }</span>
<a href="#l3.481"></a><span id="l3.481"> }</span>
<a href="#l3.482"></a><span id="l3.482"> </span>
<a href="#l3.483"></a><span id="l3.483" class="difflineminus">-const char *nsImapServerResponseParser::GetSelectedMailboxName()</span>
<a href="#l3.484"></a><span id="l3.484" class="difflineminus">-{</span>
<a href="#l3.485"></a><span id="l3.485" class="difflineplus">+const char *nsImapServerResponseParser::GetSelectedMailboxName() {</span>
<a href="#l3.486"></a><span id="l3.486">   return fSelectedMailboxName;</span>
<a href="#l3.487"></a><span id="l3.487"> }</span>
<a href="#l3.488"></a><span id="l3.488"> </span>
<a href="#l3.489"></a><span id="l3.489" class="difflineminus">-nsImapSearchResultIterator *nsImapServerResponseParser::CreateSearchResultIterator()</span>
<a href="#l3.490"></a><span id="l3.490" class="difflineminus">-{</span>
<a href="#l3.491"></a><span id="l3.491" class="difflineplus">+nsImapSearchResultIterator *</span>
<a href="#l3.492"></a><span id="l3.492" class="difflineplus">+nsImapServerResponseParser::CreateSearchResultIterator() {</span>
<a href="#l3.493"></a><span id="l3.493">   return new nsImapSearchResultIterator(*fSearchResults);</span>
<a href="#l3.494"></a><span id="l3.494"> }</span>
<a href="#l3.495"></a><span id="l3.495"> </span>
<a href="#l3.496"></a><span id="l3.496" class="difflineminus">-nsImapServerResponseParser::eIMAPstate nsImapServerResponseParser::GetIMAPstate()</span>
<a href="#l3.497"></a><span id="l3.497" class="difflineminus">-{</span>
<a href="#l3.498"></a><span id="l3.498" class="difflineplus">+nsImapServerResponseParser::eIMAPstate</span>
<a href="#l3.499"></a><span id="l3.499" class="difflineplus">+nsImapServerResponseParser::GetIMAPstate() {</span>
<a href="#l3.500"></a><span id="l3.500">   return fIMAPstate;</span>
<a href="#l3.501"></a><span id="l3.501"> }</span>
<a href="#l3.502"></a><span id="l3.502"> </span>
<a href="#l3.503"></a><span id="l3.503" class="difflineminus">-void nsImapServerResponseParser::PreauthSetAuthenticatedState()</span>
<a href="#l3.504"></a><span id="l3.504" class="difflineminus">-{</span>
<a href="#l3.505"></a><span id="l3.505" class="difflineplus">+void nsImapServerResponseParser::PreauthSetAuthenticatedState() {</span>
<a href="#l3.506"></a><span id="l3.506">   fIMAPstate = kAuthenticated;</span>
<a href="#l3.507"></a><span id="l3.507"> }</span>
<a href="#l3.508"></a><span id="l3.508"> </span>
<a href="#l3.509"></a><span id="l3.509" class="difflineminus">-void nsImapServerResponseParser::ProcessOkCommand(const char *commandToken)</span>
<a href="#l3.510"></a><span id="l3.510" class="difflineminus">-{</span>
<a href="#l3.511"></a><span id="l3.511" class="difflineplus">+void nsImapServerResponseParser::ProcessOkCommand(const char *commandToken) {</span>
<a href="#l3.512"></a><span id="l3.512">   if (!PL_strcasecmp(commandToken, &quot;LOGIN&quot;) ||</span>
<a href="#l3.513"></a><span id="l3.513" class="difflineminus">-    !PL_strcasecmp(commandToken, &quot;AUTHENTICATE&quot;))</span>
<a href="#l3.514"></a><span id="l3.514" class="difflineplus">+      !PL_strcasecmp(commandToken, &quot;AUTHENTICATE&quot;))</span>
<a href="#l3.515"></a><span id="l3.515">     fIMAPstate = kAuthenticated;</span>
<a href="#l3.516"></a><span id="l3.516">   else if (!PL_strcasecmp(commandToken, &quot;LOGOUT&quot;))</span>
<a href="#l3.517"></a><span id="l3.517">     fIMAPstate = kNonAuthenticated;</span>
<a href="#l3.518"></a><span id="l3.518">   else if (!PL_strcasecmp(commandToken, &quot;SELECT&quot;) ||</span>
<a href="#l3.519"></a><span id="l3.519" class="difflineminus">-    !PL_strcasecmp(commandToken, &quot;EXAMINE&quot;))</span>
<a href="#l3.520"></a><span id="l3.520" class="difflineplus">+           !PL_strcasecmp(commandToken, &quot;EXAMINE&quot;))</span>
<a href="#l3.521"></a><span id="l3.521">     fIMAPstate = kFolderSelected;</span>
<a href="#l3.522"></a><span id="l3.522" class="difflineminus">-  else if (!PL_strcasecmp(commandToken, &quot;CLOSE&quot;))</span>
<a href="#l3.523"></a><span id="l3.523" class="difflineminus">-  {</span>
<a href="#l3.524"></a><span id="l3.524" class="difflineplus">+  else if (!PL_strcasecmp(commandToken, &quot;CLOSE&quot;)) {</span>
<a href="#l3.525"></a><span id="l3.525">     fIMAPstate = kAuthenticated;</span>
<a href="#l3.526"></a><span id="l3.526">     // we no longer have a selected mailbox.</span>
<a href="#l3.527"></a><span id="l3.527" class="difflineminus">-    PR_FREEIF( fSelectedMailboxName );</span>
<a href="#l3.528"></a><span id="l3.528" class="difflineminus">-  }</span>
<a href="#l3.529"></a><span id="l3.529" class="difflineminus">-  else if ((!PL_strcasecmp(commandToken, &quot;LIST&quot;)) ||</span>
<a href="#l3.530"></a><span id="l3.530" class="difflineminus">-          (!PL_strcasecmp(commandToken, &quot;LSUB&quot;)) ||</span>
<a href="#l3.531"></a><span id="l3.531" class="difflineminus">-          (!PL_strcasecmp(commandToken, &quot;XLIST&quot;)))</span>
<a href="#l3.532"></a><span id="l3.532" class="difflineminus">-  {</span>
<a href="#l3.533"></a><span id="l3.533" class="difflineminus">-    //fServerConnection.MailboxDiscoveryFinished();</span>
<a href="#l3.534"></a><span id="l3.534" class="difflineplus">+    PR_FREEIF(fSelectedMailboxName);</span>
<a href="#l3.535"></a><span id="l3.535" class="difflineplus">+  } else if ((!PL_strcasecmp(commandToken, &quot;LIST&quot;)) ||</span>
<a href="#l3.536"></a><span id="l3.536" class="difflineplus">+             (!PL_strcasecmp(commandToken, &quot;LSUB&quot;)) ||</span>
<a href="#l3.537"></a><span id="l3.537" class="difflineplus">+             (!PL_strcasecmp(commandToken, &quot;XLIST&quot;))) {</span>
<a href="#l3.538"></a><span id="l3.538" class="difflineplus">+    // fServerConnection.MailboxDiscoveryFinished();</span>
<a href="#l3.539"></a><span id="l3.539">     // This used to be reporting that we were finished</span>
<a href="#l3.540"></a><span id="l3.540">     // discovering folders for each time we issued a</span>
<a href="#l3.541"></a><span id="l3.541">     // LIST or LSUB.  So if we explicitly listed the</span>
<a href="#l3.542"></a><span id="l3.542">     // INBOX, or Trash, or namespaces, we would get multiple</span>
<a href="#l3.543"></a><span id="l3.543">     // &quot;done&quot; states, even though we hadn't finished.</span>
<a href="#l3.544"></a><span id="l3.544">     // Move this to be called from the connection object</span>
<a href="#l3.545"></a><span id="l3.545">     // itself.</span>
<a href="#l3.546"></a><span id="l3.546" class="difflineminus">-  }</span>
<a href="#l3.547"></a><span id="l3.547" class="difflineminus">-  else if (!PL_strcasecmp(commandToken, &quot;FETCH&quot;))</span>
<a href="#l3.548"></a><span id="l3.548" class="difflineminus">-  {</span>
<a href="#l3.549"></a><span id="l3.549" class="difflineminus">-    if (!fZeroLengthMessageUidString.IsEmpty())</span>
<a href="#l3.550"></a><span id="l3.550" class="difflineminus">-    {</span>
<a href="#l3.551"></a><span id="l3.551" class="difflineplus">+  } else if (!PL_strcasecmp(commandToken, &quot;FETCH&quot;)) {</span>
<a href="#l3.552"></a><span id="l3.552" class="difflineplus">+    if (!fZeroLengthMessageUidString.IsEmpty()) {</span>
<a href="#l3.553"></a><span id="l3.553">       // &quot;Deleting zero length message&quot;);</span>
<a href="#l3.554"></a><span id="l3.554" class="difflineminus">-      fServerConnection.Store(fZeroLengthMessageUidString, &quot;+Flags (\\Deleted)&quot;, true);</span>
<a href="#l3.555"></a><span id="l3.555" class="difflineminus">-      if (LastCommandSuccessful())</span>
<a href="#l3.556"></a><span id="l3.556" class="difflineminus">-        fServerConnection.Expunge();</span>
<a href="#l3.557"></a><span id="l3.557" class="difflineplus">+      fServerConnection.Store(fZeroLengthMessageUidString, &quot;+Flags (\\Deleted)&quot;,</span>
<a href="#l3.558"></a><span id="l3.558" class="difflineplus">+                              true);</span>
<a href="#l3.559"></a><span id="l3.559" class="difflineplus">+      if (LastCommandSuccessful()) fServerConnection.Expunge();</span>
<a href="#l3.560"></a><span id="l3.560"> </span>
<a href="#l3.561"></a><span id="l3.561">       fZeroLengthMessageUidString.Truncate();</span>
<a href="#l3.562"></a><span id="l3.562">     }</span>
<a href="#l3.563"></a><span id="l3.563">   }</span>
<a href="#l3.564"></a><span id="l3.564" class="difflineminus">-  if (GetFillingInShell())</span>
<a href="#l3.565"></a><span id="l3.565" class="difflineminus">-  {</span>
<a href="#l3.566"></a><span id="l3.566" class="difflineplus">+  if (GetFillingInShell()) {</span>
<a href="#l3.567"></a><span id="l3.567">     // There is a BODYSTRUCTURE response.  Now let's generate the stream...</span>
<a href="#l3.568"></a><span id="l3.568">     // that is, if we're not doing it already</span>
<a href="#l3.569"></a><span id="l3.569" class="difflineminus">-    if (!m_shell-&gt;IsBeingGenerated())</span>
<a href="#l3.570"></a><span id="l3.570" class="difflineminus">-    {</span>
<a href="#l3.571"></a><span id="l3.571" class="difflineplus">+    if (!m_shell-&gt;IsBeingGenerated()) {</span>
<a href="#l3.572"></a><span id="l3.572">       nsImapProtocol *navCon = &amp;fServerConnection;</span>
<a href="#l3.573"></a><span id="l3.573"> </span>
<a href="#l3.574"></a><span id="l3.574">       char *imapPart = nullptr;</span>
<a href="#l3.575"></a><span id="l3.575"> </span>
<a href="#l3.576"></a><span id="l3.576">       fServerConnection.GetCurrentUrl()-&gt;GetImapPartToFetch(&amp;imapPart);</span>
<a href="#l3.577"></a><span id="l3.577">       m_shell-&gt;Generate(imapPart);</span>
<a href="#l3.578"></a><span id="l3.578">       PR_Free(imapPart);</span>
<a href="#l3.579"></a><span id="l3.579"> </span>
<a href="#l3.580"></a><span id="l3.580" class="difflineminus">-      if ((navCon &amp;&amp; navCon-&gt;GetPseudoInterrupted())</span>
<a href="#l3.581"></a><span id="l3.581" class="difflineminus">-        || fServerConnection.DeathSignalReceived())</span>
<a href="#l3.582"></a><span id="l3.582" class="difflineminus">-      {</span>
<a href="#l3.583"></a><span id="l3.583" class="difflineplus">+      if ((navCon &amp;&amp; navCon-&gt;GetPseudoInterrupted()) ||</span>
<a href="#l3.584"></a><span id="l3.584" class="difflineplus">+          fServerConnection.DeathSignalReceived()) {</span>
<a href="#l3.585"></a><span id="l3.585">         // we were pseudointerrupted or interrupted</span>
<a href="#l3.586"></a><span id="l3.586" class="difflineminus">-        // if it's not in the cache, then we were (pseudo)interrupted while generating</span>
<a href="#l3.587"></a><span id="l3.587" class="difflineminus">-        // for the first time. Release it.</span>
<a href="#l3.588"></a><span id="l3.588" class="difflineminus">-        if (!m_shell-&gt;IsShellCached())</span>
<a href="#l3.589"></a><span id="l3.589" class="difflineminus">-          m_shell = nullptr;</span>
<a href="#l3.590"></a><span id="l3.590" class="difflineplus">+        // if it's not in the cache, then we were (pseudo)interrupted while</span>
<a href="#l3.591"></a><span id="l3.591" class="difflineplus">+        // generating for the first time. Release it.</span>
<a href="#l3.592"></a><span id="l3.592" class="difflineplus">+        if (!m_shell-&gt;IsShellCached()) m_shell = nullptr;</span>
<a href="#l3.593"></a><span id="l3.593">         navCon-&gt;PseudoInterrupt(false);</span>
<a href="#l3.594"></a><span id="l3.594" class="difflineminus">-      }</span>
<a href="#l3.595"></a><span id="l3.595" class="difflineminus">-      else if (m_shell-&gt;GetIsValid())</span>
<a href="#l3.596"></a><span id="l3.596" class="difflineminus">-      {</span>
<a href="#l3.597"></a><span id="l3.597" class="difflineminus">-        // If we have a valid shell that has not already been cached, then cache it.</span>
<a href="#l3.598"></a><span id="l3.598" class="difflineminus">-        if (!m_shell-&gt;IsShellCached() &amp;&amp; fHostSessionList)  // cache is responsible for destroying it</span>
<a href="#l3.599"></a><span id="l3.599" class="difflineplus">+      } else if (m_shell-&gt;GetIsValid()) {</span>
<a href="#l3.600"></a><span id="l3.600" class="difflineplus">+        // If we have a valid shell that has not already been cached, then cache</span>
<a href="#l3.601"></a><span id="l3.601" class="difflineplus">+        // it.</span>
<a href="#l3.602"></a><span id="l3.602" class="difflineplus">+        if (!m_shell-&gt;IsShellCached() &amp;&amp;</span>
<a href="#l3.603"></a><span id="l3.603" class="difflineplus">+            fHostSessionList)  // cache is responsible for destroying it</span>
<a href="#l3.604"></a><span id="l3.604">         {</span>
<a href="#l3.605"></a><span id="l3.605">           MOZ_LOG(IMAP, mozilla::LogLevel::Info,</span>
<a href="#l3.606"></a><span id="l3.606" class="difflineminus">-            (&quot;BODYSHELL:  Adding shell to cache.&quot;));</span>
<a href="#l3.607"></a><span id="l3.607" class="difflineplus">+                  (&quot;BODYSHELL:  Adding shell to cache.&quot;));</span>
<a href="#l3.608"></a><span id="l3.608">           const char *serverKey = fServerConnection.GetImapServerKey();</span>
<a href="#l3.609"></a><span id="l3.609" class="difflineminus">-          fHostSessionList-&gt;AddShellToCacheForHost(</span>
<a href="#l3.610"></a><span id="l3.610" class="difflineminus">-            serverKey, m_shell);</span>
<a href="#l3.611"></a><span id="l3.611" class="difflineplus">+          fHostSessionList-&gt;AddShellToCacheForHost(serverKey, m_shell);</span>
<a href="#l3.612"></a><span id="l3.612">         }</span>
<a href="#l3.613"></a><span id="l3.613">       }</span>
<a href="#l3.614"></a><span id="l3.614">       m_shell = nullptr;</span>
<a href="#l3.615"></a><span id="l3.615">     }</span>
<a href="#l3.616"></a><span id="l3.616">   }</span>
<a href="#l3.617"></a><span id="l3.617"> }</span>
<a href="#l3.618"></a><span id="l3.618"> </span>
<a href="#l3.619"></a><span id="l3.619" class="difflineminus">-void nsImapServerResponseParser::ProcessBadCommand(const char *commandToken)</span>
<a href="#l3.620"></a><span id="l3.620" class="difflineminus">-{</span>
<a href="#l3.621"></a><span id="l3.621" class="difflineplus">+void nsImapServerResponseParser::ProcessBadCommand(const char *commandToken) {</span>
<a href="#l3.622"></a><span id="l3.622">   if (!PL_strcasecmp(commandToken, &quot;LOGIN&quot;) ||</span>
<a href="#l3.623"></a><span id="l3.623" class="difflineminus">-    !PL_strcasecmp(commandToken, &quot;AUTHENTICATE&quot;))</span>
<a href="#l3.624"></a><span id="l3.624" class="difflineplus">+      !PL_strcasecmp(commandToken, &quot;AUTHENTICATE&quot;))</span>
<a href="#l3.625"></a><span id="l3.625">     fIMAPstate = kNonAuthenticated;</span>
<a href="#l3.626"></a><span id="l3.626">   else if (!PL_strcasecmp(commandToken, &quot;LOGOUT&quot;))</span>
<a href="#l3.627"></a><span id="l3.627" class="difflineminus">-    fIMAPstate = kNonAuthenticated; // ??</span>
<a href="#l3.628"></a><span id="l3.628" class="difflineplus">+    fIMAPstate = kNonAuthenticated;  // ??</span>
<a href="#l3.629"></a><span id="l3.629">   else if (!PL_strcasecmp(commandToken, &quot;SELECT&quot;) ||</span>
<a href="#l3.630"></a><span id="l3.630" class="difflineminus">-    !PL_strcasecmp(commandToken, &quot;EXAMINE&quot;))</span>
<a href="#l3.631"></a><span id="l3.631" class="difflineminus">-    fIMAPstate = kAuthenticated; // nothing selected</span>
<a href="#l3.632"></a><span id="l3.632" class="difflineplus">+           !PL_strcasecmp(commandToken, &quot;EXAMINE&quot;))</span>
<a href="#l3.633"></a><span id="l3.633" class="difflineplus">+    fIMAPstate = kAuthenticated;  // nothing selected</span>
<a href="#l3.634"></a><span id="l3.634">   else if (!PL_strcasecmp(commandToken, &quot;CLOSE&quot;))</span>
<a href="#l3.635"></a><span id="l3.635" class="difflineminus">-    fIMAPstate = kAuthenticated; // nothing selected</span>
<a href="#l3.636"></a><span id="l3.636" class="difflineminus">-  if (GetFillingInShell() &amp;&amp; !m_shell-&gt;IsBeingGenerated())</span>
<a href="#l3.637"></a><span id="l3.637" class="difflineminus">-    m_shell = nullptr;</span>
<a href="#l3.638"></a><span id="l3.638" class="difflineplus">+    fIMAPstate = kAuthenticated;  // nothing selected</span>
<a href="#l3.639"></a><span id="l3.639" class="difflineplus">+  if (GetFillingInShell() &amp;&amp; !m_shell-&gt;IsBeingGenerated()) m_shell = nullptr;</span>
<a href="#l3.640"></a><span id="l3.640"> }</span>
<a href="#l3.641"></a><span id="l3.641"> </span>
<a href="#l3.642"></a><span id="l3.642" class="difflineminus">-</span>
<a href="#l3.643"></a><span id="l3.643" class="difflineminus">-</span>
<a href="#l3.644"></a><span id="l3.644"> // RFC3501:  response-data = &quot;*&quot; SP (resp-cond-state / resp-cond-bye /</span>
<a href="#l3.645"></a><span id="l3.645"> //                           mailbox-data / message-data / capability-data) CRLF</span>
<a href="#l3.646"></a><span id="l3.646"> // These are ``untagged'' responses [RFC3501, Sec. 2.2.2]</span>
<a href="#l3.647"></a><span id="l3.647"> /*</span>
<a href="#l3.648"></a><span id="l3.648">  The RFC1730 grammar spec did not allow one symbol look ahead to determine</span>
<a href="#l3.649"></a><span id="l3.649">  between mailbox_data / message_data so I combined the numeric possibilities</span>
<a href="#l3.650"></a><span id="l3.650">  of mailbox_data and all of message_data into numeric_mailbox_data.</span>
<a href="#l3.651"></a><span id="l3.651"> </span>
<a href="#l3.652"></a><span id="l3.652">  It is assumed that the initial &quot;*&quot; is already consumed before calling this</span>
<a href="#l3.653"></a><span id="l3.653">  method. The production implemented here is</span>
<a href="#l3.654"></a><span id="l3.654">          response_data   ::= (resp_cond_state / resp_cond_bye /</span>
<a href="#l3.655"></a><span id="l3.655">                               mailbox_data / numeric_mailbox_data /</span>
<a href="#l3.656"></a><span id="l3.656">                               capability_data)</span>
<a href="#l3.657"></a><span id="l3.657">                               CRLF</span>
<a href="#l3.658"></a><span id="l3.658"> */</span>
<a href="#l3.659"></a><span id="l3.659" class="difflineminus">-void nsImapServerResponseParser::response_data()</span>
<a href="#l3.660"></a><span id="l3.660" class="difflineminus">-{</span>
<a href="#l3.661"></a><span id="l3.661" class="difflineplus">+void nsImapServerResponseParser::response_data() {</span>
<a href="#l3.662"></a><span id="l3.662">   AdvanceToNextToken();</span>
<a href="#l3.663"></a><span id="l3.663"> </span>
<a href="#l3.664"></a><span id="l3.664" class="difflineminus">-  if (ContinueParse())</span>
<a href="#l3.665"></a><span id="l3.665" class="difflineminus">-  {</span>
<a href="#l3.666"></a><span id="l3.666" class="difflineplus">+  if (ContinueParse()) {</span>
<a href="#l3.667"></a><span id="l3.667">     // Instead of comparing lots of strings and make function calls, try to</span>
<a href="#l3.668"></a><span id="l3.668">     // pre-flight the possibilities based on the first letter of the token.</span>
<a href="#l3.669"></a><span id="l3.669" class="difflineminus">-    switch (NS_ToUpper(fNextToken[0]))</span>
<a href="#l3.670"></a><span id="l3.670" class="difflineminus">-    {</span>
<a href="#l3.671"></a><span id="l3.671" class="difflineminus">-    case 'O':   // OK</span>
<a href="#l3.672"></a><span id="l3.672" class="difflineminus">-      if (NS_ToUpper(fNextToken[1]) == 'K')</span>
<a href="#l3.673"></a><span id="l3.673" class="difflineminus">-        resp_cond_state(false);</span>
<a href="#l3.674"></a><span id="l3.674" class="difflineminus">-      else SetSyntaxError(true);</span>
<a href="#l3.675"></a><span id="l3.675" class="difflineminus">-      break;</span>
<a href="#l3.676"></a><span id="l3.676" class="difflineminus">-    case 'N':   // NO</span>
<a href="#l3.677"></a><span id="l3.677" class="difflineminus">-      if (NS_ToUpper(fNextToken[1]) == 'O')</span>
<a href="#l3.678"></a><span id="l3.678" class="difflineminus">-        resp_cond_state(false);</span>
<a href="#l3.679"></a><span id="l3.679" class="difflineminus">-      else if (!PL_strcasecmp(fNextToken, &quot;NAMESPACE&quot;))</span>
<a href="#l3.680"></a><span id="l3.680" class="difflineminus">-        namespace_data();</span>
<a href="#l3.681"></a><span id="l3.681" class="difflineminus">-      else SetSyntaxError(true);</span>
<a href="#l3.682"></a><span id="l3.682" class="difflineminus">-      break;</span>
<a href="#l3.683"></a><span id="l3.683" class="difflineminus">-    case 'B':   // BAD</span>
<a href="#l3.684"></a><span id="l3.684" class="difflineminus">-      if (!PL_strcasecmp(fNextToken, &quot;BAD&quot;))</span>
<a href="#l3.685"></a><span id="l3.685" class="difflineminus">-        resp_cond_state(false);</span>
<a href="#l3.686"></a><span id="l3.686" class="difflineminus">-      else if (!PL_strcasecmp(fNextToken, &quot;BYE&quot;))</span>
<a href="#l3.687"></a><span id="l3.687" class="difflineminus">-        resp_cond_bye();</span>
<a href="#l3.688"></a><span id="l3.688" class="difflineminus">-      else SetSyntaxError(true);</span>
<a href="#l3.689"></a><span id="l3.689" class="difflineminus">-      break;</span>
<a href="#l3.690"></a><span id="l3.690" class="difflineminus">-    case 'F':</span>
<a href="#l3.691"></a><span id="l3.691" class="difflineminus">-      if (!PL_strcasecmp(fNextToken, &quot;FLAGS&quot;))</span>
<a href="#l3.692"></a><span id="l3.692" class="difflineminus">-        mailbox_data();</span>
<a href="#l3.693"></a><span id="l3.693" class="difflineminus">-      else SetSyntaxError(true);</span>
<a href="#l3.694"></a><span id="l3.694" class="difflineminus">-      break;</span>
<a href="#l3.695"></a><span id="l3.695" class="difflineminus">-    case 'P':</span>
<a href="#l3.696"></a><span id="l3.696" class="difflineminus">-      if (PL_strcasecmp(fNextToken, &quot;PERMANENTFLAGS&quot;))</span>
<a href="#l3.697"></a><span id="l3.697" class="difflineminus">-        mailbox_data();</span>
<a href="#l3.698"></a><span id="l3.698" class="difflineminus">-      else SetSyntaxError(true);</span>
<a href="#l3.699"></a><span id="l3.699" class="difflineminus">-      break;</span>
<a href="#l3.700"></a><span id="l3.700" class="difflineminus">-    case 'L':</span>
<a href="#l3.701"></a><span id="l3.701" class="difflineminus">-      if (!PL_strcasecmp(fNextToken, &quot;LIST&quot;) || !PL_strcasecmp(fNextToken, &quot;LSUB&quot;))</span>
<a href="#l3.702"></a><span id="l3.702" class="difflineminus">-        mailbox_data();</span>
<a href="#l3.703"></a><span id="l3.703" class="difflineminus">-      else if (!PL_strcasecmp(fNextToken, &quot;LANGUAGE&quot;))</span>
<a href="#l3.704"></a><span id="l3.704" class="difflineminus">-        language_data();</span>
<a href="#l3.705"></a><span id="l3.705" class="difflineminus">-      else</span>
<a href="#l3.706"></a><span id="l3.706" class="difflineminus">-        SetSyntaxError(true);</span>
<a href="#l3.707"></a><span id="l3.707" class="difflineminus">-      break;</span>
<a href="#l3.708"></a><span id="l3.708" class="difflineminus">-    case 'M':</span>
<a href="#l3.709"></a><span id="l3.709" class="difflineminus">-      if (!PL_strcasecmp(fNextToken, &quot;MAILBOX&quot;))</span>
<a href="#l3.710"></a><span id="l3.710" class="difflineminus">-        mailbox_data();</span>
<a href="#l3.711"></a><span id="l3.711" class="difflineminus">-      else if (!PL_strcasecmp(fNextToken, &quot;MYRIGHTS&quot;))</span>
<a href="#l3.712"></a><span id="l3.712" class="difflineminus">-        myrights_data(false);</span>
<a href="#l3.713"></a><span id="l3.713" class="difflineminus">-      else SetSyntaxError(true);</span>
<a href="#l3.714"></a><span id="l3.714" class="difflineminus">-      break;</span>
<a href="#l3.715"></a><span id="l3.715" class="difflineminus">-    case 'S':</span>
<a href="#l3.716"></a><span id="l3.716" class="difflineminus">-      if (!PL_strcasecmp(fNextToken, &quot;SEARCH&quot;))</span>
<a href="#l3.717"></a><span id="l3.717" class="difflineminus">-        mailbox_data();</span>
<a href="#l3.718"></a><span id="l3.718" class="difflineminus">-      else if (!PL_strcasecmp(fNextToken, &quot;STATUS&quot;))</span>
<a href="#l3.719"></a><span id="l3.719" class="difflineminus">-      {</span>
<a href="#l3.720"></a><span id="l3.720" class="difflineminus">-        AdvanceToNextToken();</span>
<a href="#l3.721"></a><span id="l3.721" class="difflineminus">-        if (fNextToken)</span>
<a href="#l3.722"></a><span id="l3.722" class="difflineminus">-        {</span>
<a href="#l3.723"></a><span id="l3.723" class="difflineminus">-          char *mailboxName = CreateAstring();</span>
<a href="#l3.724"></a><span id="l3.724" class="difflineminus">-          PL_strfree( mailboxName);</span>
<a href="#l3.725"></a><span id="l3.725" class="difflineminus">-        }</span>
<a href="#l3.726"></a><span id="l3.726" class="difflineminus">-        while (ContinueParse() &amp;&amp; !fAtEndOfLine)</span>
<a href="#l3.727"></a><span id="l3.727" class="difflineminus">-        {</span>
<a href="#l3.728"></a><span id="l3.728" class="difflineplus">+    switch (NS_ToUpper(fNextToken[0])) {</span>
<a href="#l3.729"></a><span id="l3.729" class="difflineplus">+      case 'O':  // OK</span>
<a href="#l3.730"></a><span id="l3.730" class="difflineplus">+        if (NS_ToUpper(fNextToken[1]) == 'K')</span>
<a href="#l3.731"></a><span id="l3.731" class="difflineplus">+          resp_cond_state(false);</span>
<a href="#l3.732"></a><span id="l3.732" class="difflineplus">+        else</span>
<a href="#l3.733"></a><span id="l3.733" class="difflineplus">+          SetSyntaxError(true);</span>
<a href="#l3.734"></a><span id="l3.734" class="difflineplus">+        break;</span>
<a href="#l3.735"></a><span id="l3.735" class="difflineplus">+      case 'N':  // NO</span>
<a href="#l3.736"></a><span id="l3.736" class="difflineplus">+        if (NS_ToUpper(fNextToken[1]) == 'O')</span>
<a href="#l3.737"></a><span id="l3.737" class="difflineplus">+          resp_cond_state(false);</span>
<a href="#l3.738"></a><span id="l3.738" class="difflineplus">+        else if (!PL_strcasecmp(fNextToken, &quot;NAMESPACE&quot;))</span>
<a href="#l3.739"></a><span id="l3.739" class="difflineplus">+          namespace_data();</span>
<a href="#l3.740"></a><span id="l3.740" class="difflineplus">+        else</span>
<a href="#l3.741"></a><span id="l3.741" class="difflineplus">+          SetSyntaxError(true);</span>
<a href="#l3.742"></a><span id="l3.742" class="difflineplus">+        break;</span>
<a href="#l3.743"></a><span id="l3.743" class="difflineplus">+      case 'B':  // BAD</span>
<a href="#l3.744"></a><span id="l3.744" class="difflineplus">+        if (!PL_strcasecmp(fNextToken, &quot;BAD&quot;))</span>
<a href="#l3.745"></a><span id="l3.745" class="difflineplus">+          resp_cond_state(false);</span>
<a href="#l3.746"></a><span id="l3.746" class="difflineplus">+        else if (!PL_strcasecmp(fNextToken, &quot;BYE&quot;))</span>
<a href="#l3.747"></a><span id="l3.747" class="difflineplus">+          resp_cond_bye();</span>
<a href="#l3.748"></a><span id="l3.748" class="difflineplus">+        else</span>
<a href="#l3.749"></a><span id="l3.749" class="difflineplus">+          SetSyntaxError(true);</span>
<a href="#l3.750"></a><span id="l3.750" class="difflineplus">+        break;</span>
<a href="#l3.751"></a><span id="l3.751" class="difflineplus">+      case 'F':</span>
<a href="#l3.752"></a><span id="l3.752" class="difflineplus">+        if (!PL_strcasecmp(fNextToken, &quot;FLAGS&quot;))</span>
<a href="#l3.753"></a><span id="l3.753" class="difflineplus">+          mailbox_data();</span>
<a href="#l3.754"></a><span id="l3.754" class="difflineplus">+        else</span>
<a href="#l3.755"></a><span id="l3.755" class="difflineplus">+          SetSyntaxError(true);</span>
<a href="#l3.756"></a><span id="l3.756" class="difflineplus">+        break;</span>
<a href="#l3.757"></a><span id="l3.757" class="difflineplus">+      case 'P':</span>
<a href="#l3.758"></a><span id="l3.758" class="difflineplus">+        if (PL_strcasecmp(fNextToken, &quot;PERMANENTFLAGS&quot;))</span>
<a href="#l3.759"></a><span id="l3.759" class="difflineplus">+          mailbox_data();</span>
<a href="#l3.760"></a><span id="l3.760" class="difflineplus">+        else</span>
<a href="#l3.761"></a><span id="l3.761" class="difflineplus">+          SetSyntaxError(true);</span>
<a href="#l3.762"></a><span id="l3.762" class="difflineplus">+        break;</span>
<a href="#l3.763"></a><span id="l3.763" class="difflineplus">+      case 'L':</span>
<a href="#l3.764"></a><span id="l3.764" class="difflineplus">+        if (!PL_strcasecmp(fNextToken, &quot;LIST&quot;) ||</span>
<a href="#l3.765"></a><span id="l3.765" class="difflineplus">+            !PL_strcasecmp(fNextToken, &quot;LSUB&quot;))</span>
<a href="#l3.766"></a><span id="l3.766" class="difflineplus">+          mailbox_data();</span>
<a href="#l3.767"></a><span id="l3.767" class="difflineplus">+        else if (!PL_strcasecmp(fNextToken, &quot;LANGUAGE&quot;))</span>
<a href="#l3.768"></a><span id="l3.768" class="difflineplus">+          language_data();</span>
<a href="#l3.769"></a><span id="l3.769" class="difflineplus">+        else</span>
<a href="#l3.770"></a><span id="l3.770" class="difflineplus">+          SetSyntaxError(true);</span>
<a href="#l3.771"></a><span id="l3.771" class="difflineplus">+        break;</span>
<a href="#l3.772"></a><span id="l3.772" class="difflineplus">+      case 'M':</span>
<a href="#l3.773"></a><span id="l3.773" class="difflineplus">+        if (!PL_strcasecmp(fNextToken, &quot;MAILBOX&quot;))</span>
<a href="#l3.774"></a><span id="l3.774" class="difflineplus">+          mailbox_data();</span>
<a href="#l3.775"></a><span id="l3.775" class="difflineplus">+        else if (!PL_strcasecmp(fNextToken, &quot;MYRIGHTS&quot;))</span>
<a href="#l3.776"></a><span id="l3.776" class="difflineplus">+          myrights_data(false);</span>
<a href="#l3.777"></a><span id="l3.777" class="difflineplus">+        else</span>
<a href="#l3.778"></a><span id="l3.778" class="difflineplus">+          SetSyntaxError(true);</span>
<a href="#l3.779"></a><span id="l3.779" class="difflineplus">+        break;</span>
<a href="#l3.780"></a><span id="l3.780" class="difflineplus">+      case 'S':</span>
<a href="#l3.781"></a><span id="l3.781" class="difflineplus">+        if (!PL_strcasecmp(fNextToken, &quot;SEARCH&quot;))</span>
<a href="#l3.782"></a><span id="l3.782" class="difflineplus">+          mailbox_data();</span>
<a href="#l3.783"></a><span id="l3.783" class="difflineplus">+        else if (!PL_strcasecmp(fNextToken, &quot;STATUS&quot;)) {</span>
<a href="#l3.784"></a><span id="l3.784" class="difflineplus">+          AdvanceToNextToken();</span>
<a href="#l3.785"></a><span id="l3.785" class="difflineplus">+          if (fNextToken) {</span>
<a href="#l3.786"></a><span id="l3.786" class="difflineplus">+            char *mailboxName = CreateAstring();</span>
<a href="#l3.787"></a><span id="l3.787" class="difflineplus">+            PL_strfree(mailboxName);</span>
<a href="#l3.788"></a><span id="l3.788" class="difflineplus">+          }</span>
<a href="#l3.789"></a><span id="l3.789" class="difflineplus">+          while (ContinueParse() &amp;&amp; !fAtEndOfLine) {</span>
<a href="#l3.790"></a><span id="l3.790" class="difflineplus">+            AdvanceToNextToken();</span>
<a href="#l3.791"></a><span id="l3.791" class="difflineplus">+            if (!fNextToken) break;</span>
<a href="#l3.792"></a><span id="l3.792" class="difflineplus">+</span>
<a href="#l3.793"></a><span id="l3.793" class="difflineplus">+            if (*fNextToken == '(') fNextToken++;</span>
<a href="#l3.794"></a><span id="l3.794" class="difflineplus">+            if (!PL_strcasecmp(fNextToken, &quot;UIDNEXT&quot;)) {</span>
<a href="#l3.795"></a><span id="l3.795" class="difflineplus">+              AdvanceToNextToken();</span>
<a href="#l3.796"></a><span id="l3.796" class="difflineplus">+              if (fNextToken) {</span>
<a href="#l3.797"></a><span id="l3.797" class="difflineplus">+                fStatusNextUID = strtoul(fNextToken, nullptr, 10);</span>
<a href="#l3.798"></a><span id="l3.798" class="difflineplus">+                // if this token ends in ')', then it is the last token</span>
<a href="#l3.799"></a><span id="l3.799" class="difflineplus">+                // else we advance</span>
<a href="#l3.800"></a><span id="l3.800" class="difflineplus">+                if (*(fNextToken + strlen(fNextToken) - 1) == ')')</span>
<a href="#l3.801"></a><span id="l3.801" class="difflineplus">+                  fNextToken += strlen(fNextToken) - 1;</span>
<a href="#l3.802"></a><span id="l3.802" class="difflineplus">+              }</span>
<a href="#l3.803"></a><span id="l3.803" class="difflineplus">+            } else if (!PL_strcasecmp(fNextToken, &quot;MESSAGES&quot;)) {</span>
<a href="#l3.804"></a><span id="l3.804" class="difflineplus">+              AdvanceToNextToken();</span>
<a href="#l3.805"></a><span id="l3.805" class="difflineplus">+              if (fNextToken) {</span>
<a href="#l3.806"></a><span id="l3.806" class="difflineplus">+                fStatusExistingMessages = strtoul(fNextToken, nullptr, 10);</span>
<a href="#l3.807"></a><span id="l3.807" class="difflineplus">+                // if this token ends in ')', then it is the last token</span>
<a href="#l3.808"></a><span id="l3.808" class="difflineplus">+                // else we advance</span>
<a href="#l3.809"></a><span id="l3.809" class="difflineplus">+                if (*(fNextToken + strlen(fNextToken) - 1) == ')')</span>
<a href="#l3.810"></a><span id="l3.810" class="difflineplus">+                  fNextToken += strlen(fNextToken) - 1;</span>
<a href="#l3.811"></a><span id="l3.811" class="difflineplus">+              }</span>
<a href="#l3.812"></a><span id="l3.812" class="difflineplus">+            } else if (!PL_strcasecmp(fNextToken, &quot;UNSEEN&quot;)) {</span>
<a href="#l3.813"></a><span id="l3.813" class="difflineplus">+              AdvanceToNextToken();</span>
<a href="#l3.814"></a><span id="l3.814" class="difflineplus">+              if (fNextToken) {</span>
<a href="#l3.815"></a><span id="l3.815" class="difflineplus">+                fStatusUnseenMessages = strtoul(fNextToken, nullptr, 10);</span>
<a href="#l3.816"></a><span id="l3.816" class="difflineplus">+                // if this token ends in ')', then it is the last token</span>
<a href="#l3.817"></a><span id="l3.817" class="difflineplus">+                // else we advance</span>
<a href="#l3.818"></a><span id="l3.818" class="difflineplus">+                if (*(fNextToken + strlen(fNextToken) - 1) == ')')</span>
<a href="#l3.819"></a><span id="l3.819" class="difflineplus">+                  fNextToken += strlen(fNextToken) - 1;</span>
<a href="#l3.820"></a><span id="l3.820" class="difflineplus">+              }</span>
<a href="#l3.821"></a><span id="l3.821" class="difflineplus">+            } else if (!PL_strcasecmp(fNextToken, &quot;RECENT&quot;)) {</span>
<a href="#l3.822"></a><span id="l3.822" class="difflineplus">+              AdvanceToNextToken();</span>
<a href="#l3.823"></a><span id="l3.823" class="difflineplus">+              if (fNextToken) {</span>
<a href="#l3.824"></a><span id="l3.824" class="difflineplus">+                fStatusRecentMessages = strtoul(fNextToken, nullptr, 10);</span>
<a href="#l3.825"></a><span id="l3.825" class="difflineplus">+                // if this token ends in ')', then it is the last token</span>
<a href="#l3.826"></a><span id="l3.826" class="difflineplus">+                // else we advance</span>
<a href="#l3.827"></a><span id="l3.827" class="difflineplus">+                if (*(fNextToken + strlen(fNextToken) - 1) == ')')</span>
<a href="#l3.828"></a><span id="l3.828" class="difflineplus">+                  fNextToken += strlen(fNextToken) - 1;</span>
<a href="#l3.829"></a><span id="l3.829" class="difflineplus">+              }</span>
<a href="#l3.830"></a><span id="l3.830" class="difflineplus">+            } else if (*fNextToken == ')')</span>
<a href="#l3.831"></a><span id="l3.831" class="difflineplus">+              break;</span>
<a href="#l3.832"></a><span id="l3.832" class="difflineplus">+            else if (!fAtEndOfLine)</span>
<a href="#l3.833"></a><span id="l3.833" class="difflineplus">+              SetSyntaxError(true);</span>
<a href="#l3.834"></a><span id="l3.834" class="difflineplus">+          }</span>
<a href="#l3.835"></a><span id="l3.835" class="difflineplus">+        } else</span>
<a href="#l3.836"></a><span id="l3.836" class="difflineplus">+          SetSyntaxError(true);</span>
<a href="#l3.837"></a><span id="l3.837" class="difflineplus">+        break;</span>
<a href="#l3.838"></a><span id="l3.838" class="difflineplus">+      case 'C':</span>
<a href="#l3.839"></a><span id="l3.839" class="difflineplus">+        if (!PL_strcasecmp(fNextToken, &quot;CAPABILITY&quot;))</span>
<a href="#l3.840"></a><span id="l3.840" class="difflineplus">+          capability_data();</span>
<a href="#l3.841"></a><span id="l3.841" class="difflineplus">+        else</span>
<a href="#l3.842"></a><span id="l3.842" class="difflineplus">+          SetSyntaxError(true);</span>
<a href="#l3.843"></a><span id="l3.843" class="difflineplus">+        break;</span>
<a href="#l3.844"></a><span id="l3.844" class="difflineplus">+      case 'V':</span>
<a href="#l3.845"></a><span id="l3.845" class="difflineplus">+        if (!PL_strcasecmp(fNextToken, &quot;VERSION&quot;)) {</span>
<a href="#l3.846"></a><span id="l3.846" class="difflineplus">+          // figure out the version of the Netscape server here</span>
<a href="#l3.847"></a><span id="l3.847" class="difflineplus">+          PR_FREEIF(fNetscapeServerVersionString);</span>
<a href="#l3.848"></a><span id="l3.848">           AdvanceToNextToken();</span>
<a href="#l3.849"></a><span id="l3.849">           if (!fNextToken)</span>
<a href="#l3.850"></a><span id="l3.850" class="difflineminus">-            break;</span>
<a href="#l3.851"></a><span id="l3.851" class="difflineminus">-</span>
<a href="#l3.852"></a><span id="l3.852" class="difflineminus">-          if (*fNextToken == '(') fNextToken++;</span>
<a href="#l3.853"></a><span id="l3.853" class="difflineminus">-          if (!PL_strcasecmp(fNextToken, &quot;UIDNEXT&quot;))</span>
<a href="#l3.854"></a><span id="l3.854" class="difflineminus">-          {</span>
<a href="#l3.855"></a><span id="l3.855" class="difflineminus">-            AdvanceToNextToken();</span>
<a href="#l3.856"></a><span id="l3.856" class="difflineminus">-            if (fNextToken)</span>
<a href="#l3.857"></a><span id="l3.857" class="difflineminus">-            {</span>
<a href="#l3.858"></a><span id="l3.858" class="difflineminus">-              fStatusNextUID = strtoul(fNextToken, nullptr, 10);</span>
<a href="#l3.859"></a><span id="l3.859" class="difflineminus">-              // if this token ends in ')', then it is the last token</span>
<a href="#l3.860"></a><span id="l3.860" class="difflineminus">-              // else we advance</span>
<a href="#l3.861"></a><span id="l3.861" class="difflineminus">-              if ( *(fNextToken + strlen(fNextToken) - 1) == ')')</span>
<a href="#l3.862"></a><span id="l3.862" class="difflineminus">-                fNextToken += strlen(fNextToken) - 1;</span>
<a href="#l3.863"></a><span id="l3.863" class="difflineminus">-            }</span>
<a href="#l3.864"></a><span id="l3.864" class="difflineminus">-          }</span>
<a href="#l3.865"></a><span id="l3.865" class="difflineminus">-          else if (!PL_strcasecmp(fNextToken, &quot;MESSAGES&quot;))</span>
<a href="#l3.866"></a><span id="l3.866" class="difflineminus">-          {</span>
<a href="#l3.867"></a><span id="l3.867" class="difflineplus">+            SetSyntaxError(true);</span>
<a href="#l3.868"></a><span id="l3.868" class="difflineplus">+          else {</span>
<a href="#l3.869"></a><span id="l3.869" class="difflineplus">+            fNetscapeServerVersionString = CreateAstring();</span>
<a href="#l3.870"></a><span id="l3.870">             AdvanceToNextToken();</span>
<a href="#l3.871"></a><span id="l3.871" class="difflineminus">-            if (fNextToken)</span>
<a href="#l3.872"></a><span id="l3.872" class="difflineminus">-            {</span>
<a href="#l3.873"></a><span id="l3.873" class="difflineminus">-              fStatusExistingMessages = strtoul(fNextToken, nullptr, 10);</span>
<a href="#l3.874"></a><span id="l3.874" class="difflineminus">-              // if this token ends in ')', then it is the last token</span>
<a href="#l3.875"></a><span id="l3.875" class="difflineminus">-              // else we advance</span>
<a href="#l3.876"></a><span id="l3.876" class="difflineminus">-              if ( *(fNextToken + strlen(fNextToken) - 1) == ')')</span>
<a href="#l3.877"></a><span id="l3.877" class="difflineminus">-                fNextToken += strlen(fNextToken) - 1;</span>
<a href="#l3.878"></a><span id="l3.878" class="difflineminus">-            }</span>
<a href="#l3.879"></a><span id="l3.879" class="difflineminus">-          }</span>
<a href="#l3.880"></a><span id="l3.880" class="difflineminus">-          else if (!PL_strcasecmp(fNextToken, &quot;UNSEEN&quot;))</span>
<a href="#l3.881"></a><span id="l3.881" class="difflineminus">-          {</span>
<a href="#l3.882"></a><span id="l3.882" class="difflineminus">-            AdvanceToNextToken();</span>
<a href="#l3.883"></a><span id="l3.883" class="difflineminus">-            if (fNextToken)</span>
<a href="#l3.884"></a><span id="l3.884" class="difflineminus">-            {</span>
<a href="#l3.885"></a><span id="l3.885" class="difflineminus">-              fStatusUnseenMessages = strtoul(fNextToken, nullptr, 10);</span>
<a href="#l3.886"></a><span id="l3.886" class="difflineminus">-              // if this token ends in ')', then it is the last token</span>
<a href="#l3.887"></a><span id="l3.887" class="difflineminus">-              // else we advance</span>
<a href="#l3.888"></a><span id="l3.888" class="difflineminus">-              if ( *(fNextToken + strlen(fNextToken) - 1) == ')')</span>
<a href="#l3.889"></a><span id="l3.889" class="difflineminus">-                fNextToken += strlen(fNextToken) - 1;</span>
<a href="#l3.890"></a><span id="l3.890" class="difflineplus">+            if (fNetscapeServerVersionString) {</span>
<a href="#l3.891"></a><span id="l3.891" class="difflineplus">+              fServerIsNetscape3xServer =</span>
<a href="#l3.892"></a><span id="l3.892" class="difflineplus">+                  (*fNetscapeServerVersionString == '3');</span>
<a href="#l3.893"></a><span id="l3.893">             }</span>
<a href="#l3.894"></a><span id="l3.894">           }</span>
<a href="#l3.895"></a><span id="l3.895" class="difflineminus">-          else if (!PL_strcasecmp(fNextToken, &quot;RECENT&quot;))</span>
<a href="#l3.896"></a><span id="l3.896" class="difflineminus">-          {</span>
<a href="#l3.897"></a><span id="l3.897" class="difflineplus">+          skip_to_CRLF();</span>
<a href="#l3.898"></a><span id="l3.898" class="difflineplus">+        } else</span>
<a href="#l3.899"></a><span id="l3.899" class="difflineplus">+          SetSyntaxError(true);</span>
<a href="#l3.900"></a><span id="l3.900" class="difflineplus">+        break;</span>
<a href="#l3.901"></a><span id="l3.901" class="difflineplus">+      case 'A':</span>
<a href="#l3.902"></a><span id="l3.902" class="difflineplus">+        if (!PL_strcasecmp(fNextToken, &quot;ACL&quot;)) {</span>
<a href="#l3.903"></a><span id="l3.903" class="difflineplus">+          acl_data();</span>
<a href="#l3.904"></a><span id="l3.904" class="difflineplus">+        } else if (!PL_strcasecmp(fNextToken, &quot;ACCOUNT-URL&quot;)) {</span>
<a href="#l3.905"></a><span id="l3.905" class="difflineplus">+          fMailAccountUrl.Truncate();</span>
<a href="#l3.906"></a><span id="l3.906" class="difflineplus">+          AdvanceToNextToken();</span>
<a href="#l3.907"></a><span id="l3.907" class="difflineplus">+          if (!fNextToken)</span>
<a href="#l3.908"></a><span id="l3.908" class="difflineplus">+            SetSyntaxError(true);</span>
<a href="#l3.909"></a><span id="l3.909" class="difflineplus">+          else {</span>
<a href="#l3.910"></a><span id="l3.910" class="difflineplus">+            fMailAccountUrl.Adopt(CreateAstring());</span>
<a href="#l3.911"></a><span id="l3.911">             AdvanceToNextToken();</span>
<a href="#l3.912"></a><span id="l3.912" class="difflineminus">-            if (fNextToken)</span>
<a href="#l3.913"></a><span id="l3.913" class="difflineminus">-            {</span>
<a href="#l3.914"></a><span id="l3.914" class="difflineminus">-              fStatusRecentMessages = strtoul(fNextToken, nullptr, 10);</span>
<a href="#l3.915"></a><span id="l3.915" class="difflineminus">-              // if this token ends in ')', then it is the last token</span>
<a href="#l3.916"></a><span id="l3.916" class="difflineminus">-              // else we advance</span>
<a href="#l3.917"></a><span id="l3.917" class="difflineminus">-              if ( *(fNextToken + strlen(fNextToken) - 1) == ')')</span>
<a href="#l3.918"></a><span id="l3.918" class="difflineminus">-                fNextToken += strlen(fNextToken) - 1;</span>
<a href="#l3.919"></a><span id="l3.919" class="difflineplus">+          }</span>
<a href="#l3.920"></a><span id="l3.920" class="difflineplus">+        } else</span>
<a href="#l3.921"></a><span id="l3.921" class="difflineplus">+          SetSyntaxError(true);</span>
<a href="#l3.922"></a><span id="l3.922" class="difflineplus">+        break;</span>
<a href="#l3.923"></a><span id="l3.923" class="difflineplus">+      case 'E':</span>
<a href="#l3.924"></a><span id="l3.924" class="difflineplus">+        if (!PL_strcasecmp(fNextToken, &quot;ENABLED&quot;)) enable_data();</span>
<a href="#l3.925"></a><span id="l3.925" class="difflineplus">+        break;</span>
<a href="#l3.926"></a><span id="l3.926" class="difflineplus">+      case 'X':</span>
<a href="#l3.927"></a><span id="l3.927" class="difflineplus">+        if (!PL_strcasecmp(fNextToken, &quot;XSERVERINFO&quot;))</span>
<a href="#l3.928"></a><span id="l3.928" class="difflineplus">+          xserverinfo_data();</span>
<a href="#l3.929"></a><span id="l3.929" class="difflineplus">+        else if (!PL_strcasecmp(fNextToken, &quot;XMAILBOXINFO&quot;))</span>
<a href="#l3.930"></a><span id="l3.930" class="difflineplus">+          xmailboxinfo_data();</span>
<a href="#l3.931"></a><span id="l3.931" class="difflineplus">+        else if (!PL_strcasecmp(fNextToken, &quot;XAOL-OPTION&quot;))</span>
<a href="#l3.932"></a><span id="l3.932" class="difflineplus">+          skip_to_CRLF();</span>
<a href="#l3.933"></a><span id="l3.933" class="difflineplus">+        else if (!PL_strcasecmp(fNextToken, &quot;XLIST&quot;))</span>
<a href="#l3.934"></a><span id="l3.934" class="difflineplus">+          mailbox_data();</span>
<a href="#l3.935"></a><span id="l3.935" class="difflineplus">+        else {</span>
<a href="#l3.936"></a><span id="l3.936" class="difflineplus">+          // check if custom command</span>
<a href="#l3.937"></a><span id="l3.937" class="difflineplus">+          nsAutoCString customCommand;</span>
<a href="#l3.938"></a><span id="l3.938" class="difflineplus">+          fServerConnection.GetCurrentUrl()-&gt;GetCommand(customCommand);</span>
<a href="#l3.939"></a><span id="l3.939" class="difflineplus">+          if (customCommand.Equals(fNextToken)) {</span>
<a href="#l3.940"></a><span id="l3.940" class="difflineplus">+            nsAutoCString customCommandResponse;</span>
<a href="#l3.941"></a><span id="l3.941" class="difflineplus">+            while (Connected() &amp;&amp; !fAtEndOfLine) {</span>
<a href="#l3.942"></a><span id="l3.942" class="difflineplus">+              AdvanceToNextToken();</span>
<a href="#l3.943"></a><span id="l3.943" class="difflineplus">+              customCommandResponse.Append(fNextToken);</span>
<a href="#l3.944"></a><span id="l3.944" class="difflineplus">+              customCommandResponse.Append(' ');</span>
<a href="#l3.945"></a><span id="l3.945">             }</span>
<a href="#l3.946"></a><span id="l3.946" class="difflineminus">-          }</span>
<a href="#l3.947"></a><span id="l3.947" class="difflineminus">-          else if (*fNextToken == ')')</span>
<a href="#l3.948"></a><span id="l3.948" class="difflineminus">-            break;</span>
<a href="#l3.949"></a><span id="l3.949" class="difflineminus">-          else if (!fAtEndOfLine)</span>
<a href="#l3.950"></a><span id="l3.950" class="difflineplus">+            fServerConnection.GetCurrentUrl()-&gt;SetCustomCommandResult(</span>
<a href="#l3.951"></a><span id="l3.951" class="difflineplus">+                customCommandResponse);</span>
<a href="#l3.952"></a><span id="l3.952" class="difflineplus">+          } else</span>
<a href="#l3.953"></a><span id="l3.953">             SetSyntaxError(true);</span>
<a href="#l3.954"></a><span id="l3.954">         }</span>
<a href="#l3.955"></a><span id="l3.955" class="difflineminus">-      } else SetSyntaxError(true);</span>
<a href="#l3.956"></a><span id="l3.956" class="difflineminus">-      break;</span>
<a href="#l3.957"></a><span id="l3.957" class="difflineminus">-    case 'C':</span>
<a href="#l3.958"></a><span id="l3.958" class="difflineminus">-      if (!PL_strcasecmp(fNextToken, &quot;CAPABILITY&quot;))</span>
<a href="#l3.959"></a><span id="l3.959" class="difflineminus">-        capability_data();</span>
<a href="#l3.960"></a><span id="l3.960" class="difflineminus">-      else SetSyntaxError(true);</span>
<a href="#l3.961"></a><span id="l3.961" class="difflineminus">-      break;</span>
<a href="#l3.962"></a><span id="l3.962" class="difflineminus">-    case 'V':</span>
<a href="#l3.963"></a><span id="l3.963" class="difflineminus">-      if (!PL_strcasecmp(fNextToken, &quot;VERSION&quot;))</span>
<a href="#l3.964"></a><span id="l3.964" class="difflineminus">-      {</span>
<a href="#l3.965"></a><span id="l3.965" class="difflineminus">-        // figure out the version of the Netscape server here</span>
<a href="#l3.966"></a><span id="l3.966" class="difflineminus">-        PR_FREEIF(fNetscapeServerVersionString);</span>
<a href="#l3.967"></a><span id="l3.967" class="difflineminus">-        AdvanceToNextToken();</span>
<a href="#l3.968"></a><span id="l3.968" class="difflineminus">-        if (! fNextToken)</span>
<a href="#l3.969"></a><span id="l3.969" class="difflineminus">-          SetSyntaxError(true);</span>
<a href="#l3.970"></a><span id="l3.970" class="difflineminus">-        else</span>
<a href="#l3.971"></a><span id="l3.971" class="difflineminus">-        {</span>
<a href="#l3.972"></a><span id="l3.972" class="difflineminus">-          fNetscapeServerVersionString = CreateAstring();</span>
<a href="#l3.973"></a><span id="l3.973" class="difflineminus">-          AdvanceToNextToken();</span>
<a href="#l3.974"></a><span id="l3.974" class="difflineminus">-          if (fNetscapeServerVersionString)</span>
<a href="#l3.975"></a><span id="l3.975" class="difflineminus">-          {</span>
<a href="#l3.976"></a><span id="l3.976" class="difflineminus">-            fServerIsNetscape3xServer = (*fNetscapeServerVersionString == '3');</span>
<a href="#l3.977"></a><span id="l3.977" class="difflineminus">-          }</span>
<a href="#l3.978"></a><span id="l3.978" class="difflineminus">-        }</span>
<a href="#l3.979"></a><span id="l3.979" class="difflineminus">-        skip_to_CRLF();</span>
<a href="#l3.980"></a><span id="l3.980" class="difflineminus">-      }</span>
<a href="#l3.981"></a><span id="l3.981" class="difflineminus">-      else SetSyntaxError(true);</span>
<a href="#l3.982"></a><span id="l3.982" class="difflineminus">-      break;</span>
<a href="#l3.983"></a><span id="l3.983" class="difflineminus">-    case 'A':</span>
<a href="#l3.984"></a><span id="l3.984" class="difflineminus">-      if (!PL_strcasecmp(fNextToken, &quot;ACL&quot;))</span>
<a href="#l3.985"></a><span id="l3.985" class="difflineminus">-      {</span>
<a href="#l3.986"></a><span id="l3.986" class="difflineminus">-        acl_data();</span>
<a href="#l3.987"></a><span id="l3.987" class="difflineminus">-      }</span>
<a href="#l3.988"></a><span id="l3.988" class="difflineminus">-      else if (!PL_strcasecmp(fNextToken, &quot;ACCOUNT-URL&quot;))</span>
<a href="#l3.989"></a><span id="l3.989" class="difflineminus">-      {</span>
<a href="#l3.990"></a><span id="l3.990" class="difflineminus">-        fMailAccountUrl.Truncate();</span>
<a href="#l3.991"></a><span id="l3.991" class="difflineminus">-        AdvanceToNextToken();</span>
<a href="#l3.992"></a><span id="l3.992" class="difflineminus">-        if (! fNextToken)</span>
<a href="#l3.993"></a><span id="l3.993" class="difflineminus">-          SetSyntaxError(true);</span>
<a href="#l3.994"></a><span id="l3.994" class="difflineminus">-        else</span>
<a href="#l3.995"></a><span id="l3.995" class="difflineminus">-        {</span>
<a href="#l3.996"></a><span id="l3.996" class="difflineminus">-          fMailAccountUrl.Adopt(CreateAstring());</span>
<a href="#l3.997"></a><span id="l3.997" class="difflineminus">-          AdvanceToNextToken();</span>
<a href="#l3.998"></a><span id="l3.998" class="difflineminus">-        }</span>
<a href="#l3.999"></a><span id="l3.999" class="difflineminus">-      }</span>
<a href="#l3.1000"></a><span id="l3.1000" class="difflineminus">-      else SetSyntaxError(true);</span>
<a href="#l3.1001"></a><span id="l3.1001" class="difflineminus">-      break;</span>
<a href="#l3.1002"></a><span id="l3.1002" class="difflineminus">-    case 'E':</span>
<a href="#l3.1003"></a><span id="l3.1003" class="difflineminus">-      if (!PL_strcasecmp(fNextToken, &quot;ENABLED&quot;))</span>
<a href="#l3.1004"></a><span id="l3.1004" class="difflineminus">-        enable_data();</span>
<a href="#l3.1005"></a><span id="l3.1005" class="difflineminus">-      break;</span>
<a href="#l3.1006"></a><span id="l3.1006" class="difflineminus">-    case 'X':</span>
<a href="#l3.1007"></a><span id="l3.1007" class="difflineminus">-      if (!PL_strcasecmp(fNextToken, &quot;XSERVERINFO&quot;))</span>
<a href="#l3.1008"></a><span id="l3.1008" class="difflineminus">-        xserverinfo_data();</span>
<a href="#l3.1009"></a><span id="l3.1009" class="difflineminus">-      else if (!PL_strcasecmp(fNextToken, &quot;XMAILBOXINFO&quot;))</span>
<a href="#l3.1010"></a><span id="l3.1010" class="difflineminus">-        xmailboxinfo_data();</span>
<a href="#l3.1011"></a><span id="l3.1011" class="difflineminus">-      else if (!PL_strcasecmp(fNextToken, &quot;XAOL-OPTION&quot;))</span>
<a href="#l3.1012"></a><span id="l3.1012" class="difflineminus">-        skip_to_CRLF();</span>
<a href="#l3.1013"></a><span id="l3.1013" class="difflineminus">-      else if (!PL_strcasecmp(fNextToken, &quot;XLIST&quot;))</span>
<a href="#l3.1014"></a><span id="l3.1014" class="difflineminus">-        mailbox_data();</span>
<a href="#l3.1015"></a><span id="l3.1015" class="difflineminus">-      else</span>
<a href="#l3.1016"></a><span id="l3.1016" class="difflineminus">-      {</span>
<a href="#l3.1017"></a><span id="l3.1017" class="difflineminus">-        // check if custom command</span>
<a href="#l3.1018"></a><span id="l3.1018" class="difflineminus">-        nsAutoCString customCommand;</span>
<a href="#l3.1019"></a><span id="l3.1019" class="difflineminus">-        fServerConnection.GetCurrentUrl()-&gt;GetCommand(customCommand);</span>
<a href="#l3.1020"></a><span id="l3.1020" class="difflineminus">-        if (customCommand.Equals(fNextToken))</span>
<a href="#l3.1021"></a><span id="l3.1021" class="difflineminus">-        {</span>
<a href="#l3.1022"></a><span id="l3.1022" class="difflineminus">-          nsAutoCString customCommandResponse;</span>
<a href="#l3.1023"></a><span id="l3.1023" class="difflineminus">-          while (Connected() &amp;&amp; !fAtEndOfLine)</span>
<a href="#l3.1024"></a><span id="l3.1024" class="difflineminus">-          {</span>
<a href="#l3.1025"></a><span id="l3.1025" class="difflineminus">-            AdvanceToNextToken();</span>
<a href="#l3.1026"></a><span id="l3.1026" class="difflineminus">-            customCommandResponse.Append(fNextToken);</span>
<a href="#l3.1027"></a><span id="l3.1027" class="difflineminus">-            customCommandResponse.Append(' ');</span>
<a href="#l3.1028"></a><span id="l3.1028" class="difflineminus">-          }</span>
<a href="#l3.1029"></a><span id="l3.1029" class="difflineminus">-          fServerConnection.GetCurrentUrl()-&gt;SetCustomCommandResult(customCommandResponse);</span>
<a href="#l3.1030"></a><span id="l3.1030" class="difflineminus">-        }</span>
<a href="#l3.1031"></a><span id="l3.1031" class="difflineplus">+        break;</span>
<a href="#l3.1032"></a><span id="l3.1032" class="difflineplus">+      case 'Q':</span>
<a href="#l3.1033"></a><span id="l3.1033" class="difflineplus">+        if (!PL_strcasecmp(fNextToken, &quot;QUOTAROOT&quot;) ||</span>
<a href="#l3.1034"></a><span id="l3.1034" class="difflineplus">+            !PL_strcasecmp(fNextToken, &quot;QUOTA&quot;))</span>
<a href="#l3.1035"></a><span id="l3.1035" class="difflineplus">+          quota_data();</span>
<a href="#l3.1036"></a><span id="l3.1036">         else</span>
<a href="#l3.1037"></a><span id="l3.1037">           SetSyntaxError(true);</span>
<a href="#l3.1038"></a><span id="l3.1038" class="difflineminus">-      }</span>
<a href="#l3.1039"></a><span id="l3.1039" class="difflineminus">-      break;</span>
<a href="#l3.1040"></a><span id="l3.1040" class="difflineminus">-    case 'Q':</span>
<a href="#l3.1041"></a><span id="l3.1041" class="difflineminus">-      if (!PL_strcasecmp(fNextToken, &quot;QUOTAROOT&quot;)  || !PL_strcasecmp(fNextToken, &quot;QUOTA&quot;))</span>
<a href="#l3.1042"></a><span id="l3.1042" class="difflineminus">-        quota_data();</span>
<a href="#l3.1043"></a><span id="l3.1043" class="difflineminus">-      else</span>
<a href="#l3.1044"></a><span id="l3.1044" class="difflineminus">-        SetSyntaxError(true);</span>
<a href="#l3.1045"></a><span id="l3.1045" class="difflineminus">-      break;</span>
<a href="#l3.1046"></a><span id="l3.1046" class="difflineminus">-    case 'I':</span>
<a href="#l3.1047"></a><span id="l3.1047" class="difflineminus">-      id_data();</span>
<a href="#l3.1048"></a><span id="l3.1048" class="difflineminus">-      break;</span>
<a href="#l3.1049"></a><span id="l3.1049" class="difflineminus">-    default:</span>
<a href="#l3.1050"></a><span id="l3.1050" class="difflineminus">-      if (IsNumericString(fNextToken))</span>
<a href="#l3.1051"></a><span id="l3.1051" class="difflineminus">-        numeric_mailbox_data();</span>
<a href="#l3.1052"></a><span id="l3.1052" class="difflineminus">-      else</span>
<a href="#l3.1053"></a><span id="l3.1053" class="difflineminus">-        SetSyntaxError(true);</span>
<a href="#l3.1054"></a><span id="l3.1054" class="difflineminus">-      break;</span>
<a href="#l3.1055"></a><span id="l3.1055" class="difflineplus">+        break;</span>
<a href="#l3.1056"></a><span id="l3.1056" class="difflineplus">+      case 'I':</span>
<a href="#l3.1057"></a><span id="l3.1057" class="difflineplus">+        id_data();</span>
<a href="#l3.1058"></a><span id="l3.1058" class="difflineplus">+        break;</span>
<a href="#l3.1059"></a><span id="l3.1059" class="difflineplus">+      default:</span>
<a href="#l3.1060"></a><span id="l3.1060" class="difflineplus">+        if (IsNumericString(fNextToken))</span>
<a href="#l3.1061"></a><span id="l3.1061" class="difflineplus">+          numeric_mailbox_data();</span>
<a href="#l3.1062"></a><span id="l3.1062" class="difflineplus">+        else</span>
<a href="#l3.1063"></a><span id="l3.1063" class="difflineplus">+          SetSyntaxError(true);</span>
<a href="#l3.1064"></a><span id="l3.1064" class="difflineplus">+        break;</span>
<a href="#l3.1065"></a><span id="l3.1065">     }</span>
<a href="#l3.1066"></a><span id="l3.1066"> </span>
<a href="#l3.1067"></a><span id="l3.1067" class="difflineminus">-    if (ContinueParse())</span>
<a href="#l3.1068"></a><span id="l3.1068" class="difflineminus">-      PostProcessEndOfLine();</span>
<a href="#l3.1069"></a><span id="l3.1069" class="difflineplus">+    if (ContinueParse()) PostProcessEndOfLine();</span>
<a href="#l3.1070"></a><span id="l3.1070">   }</span>
<a href="#l3.1071"></a><span id="l3.1071"> }</span>
<a href="#l3.1072"></a><span id="l3.1072"> </span>
<a href="#l3.1073"></a><span id="l3.1073" class="difflineminus">-</span>
<a href="#l3.1074"></a><span id="l3.1074" class="difflineminus">-void nsImapServerResponseParser::PostProcessEndOfLine()</span>
<a href="#l3.1075"></a><span id="l3.1075" class="difflineminus">-{</span>
<a href="#l3.1076"></a><span id="l3.1076" class="difflineplus">+void nsImapServerResponseParser::PostProcessEndOfLine() {</span>
<a href="#l3.1077"></a><span id="l3.1077">   // for now we only have to do one thing here</span>
<a href="#l3.1078"></a><span id="l3.1078">   // a fetch response to a 'uid store' command might return the flags</span>
<a href="#l3.1079"></a><span id="l3.1079">   // before it returns the uid of the message.  So we need both before</span>
<a href="#l3.1080"></a><span id="l3.1080">   // we report the new flag info to the front end</span>
<a href="#l3.1081"></a><span id="l3.1081"> </span>
<a href="#l3.1082"></a><span id="l3.1082">   // also check and be sure that there was a UID in the current response</span>
<a href="#l3.1083"></a><span id="l3.1083" class="difflineminus">-  if (fCurrentLineContainedFlagInfo &amp;&amp; CurrentResponseUID())</span>
<a href="#l3.1084"></a><span id="l3.1084" class="difflineminus">-  {</span>
<a href="#l3.1085"></a><span id="l3.1085" class="difflineplus">+  if (fCurrentLineContainedFlagInfo &amp;&amp; CurrentResponseUID()) {</span>
<a href="#l3.1086"></a><span id="l3.1086">     fCurrentLineContainedFlagInfo = false;</span>
<a href="#l3.1087"></a><span id="l3.1087">     nsCString customFlags;</span>
<a href="#l3.1088"></a><span id="l3.1088" class="difflineminus">-    fFlagState-&gt;GetCustomFlags(CurrentResponseUID(), getter_Copies(customFlags));</span>
<a href="#l3.1089"></a><span id="l3.1089" class="difflineplus">+    fFlagState-&gt;GetCustomFlags(CurrentResponseUID(),</span>
<a href="#l3.1090"></a><span id="l3.1090" class="difflineplus">+                               getter_Copies(customFlags));</span>
<a href="#l3.1091"></a><span id="l3.1091">     fServerConnection.NotifyMessageFlags(fSavedFlagInfo, customFlags,</span>
<a href="#l3.1092"></a><span id="l3.1092">                                          CurrentResponseUID(), fHighestModSeq);</span>
<a href="#l3.1093"></a><span id="l3.1093">   }</span>
<a href="#l3.1094"></a><span id="l3.1094"> }</span>
<a href="#l3.1095"></a><span id="l3.1095"> </span>
<a href="#l3.1096"></a><span id="l3.1096" class="difflineminus">-</span>
<a href="#l3.1097"></a><span id="l3.1097"> /*</span>
<a href="#l3.1098"></a><span id="l3.1098">  mailbox_data    ::=  &quot;FLAGS&quot; SPACE flag_list /</span>
<a href="#l3.1099"></a><span id="l3.1099">                                &quot;LIST&quot; SPACE mailbox_list /</span>
<a href="#l3.1100"></a><span id="l3.1100">                                &quot;LSUB&quot; SPACE mailbox_list /</span>
<a href="#l3.1101"></a><span id="l3.1101">                                &quot;XLIST&quot; SPACE mailbox_list /</span>
<a href="#l3.1102"></a><span id="l3.1102">                                &quot;MAILBOX&quot; SPACE text /</span>
<a href="#l3.1103"></a><span id="l3.1103">                                &quot;SEARCH&quot; [SPACE 1#nz_number] /</span>
<a href="#l3.1104"></a><span id="l3.1104">                                number SPACE &quot;EXISTS&quot; / number SPACE &quot;RECENT&quot;</span>
<a href="#l3.1105"></a><span id="l3.1105" class="difflineat">@@ -769,84 +690,71 @@ This production was changed to accommoda</span>
<a href="#l3.1106"></a><span id="l3.1106"> </span>
<a href="#l3.1107"></a><span id="l3.1107">  mailbox_data    ::=  &quot;FLAGS&quot; SPACE flag_list /</span>
<a href="#l3.1108"></a><span id="l3.1108">                                &quot;LIST&quot; SPACE mailbox_list /</span>
<a href="#l3.1109"></a><span id="l3.1109">                                &quot;LSUB&quot; SPACE mailbox_list /</span>
<a href="#l3.1110"></a><span id="l3.1110">                                &quot;XLIST&quot; SPACE mailbox_list /</span>
<a href="#l3.1111"></a><span id="l3.1111">                                &quot;MAILBOX&quot; SPACE text /</span>
<a href="#l3.1112"></a><span id="l3.1112">                                &quot;SEARCH&quot; [SPACE 1#nz_number]</span>
<a href="#l3.1113"></a><span id="l3.1113"> */</span>
<a href="#l3.1114"></a><span id="l3.1114" class="difflineminus">-void nsImapServerResponseParser::mailbox_data()</span>
<a href="#l3.1115"></a><span id="l3.1115" class="difflineminus">-{</span>
<a href="#l3.1116"></a><span id="l3.1116" class="difflineminus">-  if (!PL_strcasecmp(fNextToken, &quot;FLAGS&quot;))</span>
<a href="#l3.1117"></a><span id="l3.1117" class="difflineminus">-  {</span>
<a href="#l3.1118"></a><span id="l3.1118" class="difflineplus">+void nsImapServerResponseParser::mailbox_data() {</span>
<a href="#l3.1119"></a><span id="l3.1119" class="difflineplus">+  if (!PL_strcasecmp(fNextToken, &quot;FLAGS&quot;)) {</span>
<a href="#l3.1120"></a><span id="l3.1120">     // this handles the case where we got the permanent flags response</span>
<a href="#l3.1121"></a><span id="l3.1121">     // before the flags response, in which case, we want to ignore these flags.</span>
<a href="#l3.1122"></a><span id="l3.1122">     if (fGotPermanentFlags)</span>
<a href="#l3.1123"></a><span id="l3.1123">       skip_to_CRLF();</span>
<a href="#l3.1124"></a><span id="l3.1124">     else</span>
<a href="#l3.1125"></a><span id="l3.1125">       parse_folder_flags(true);</span>
<a href="#l3.1126"></a><span id="l3.1126" class="difflineminus">-  }</span>
<a href="#l3.1127"></a><span id="l3.1127" class="difflineminus">-  else if (!PL_strcasecmp(fNextToken, &quot;LIST&quot;) ||</span>
<a href="#l3.1128"></a><span id="l3.1128" class="difflineminus">-           !PL_strcasecmp(fNextToken, &quot;XLIST&quot;))</span>
<a href="#l3.1129"></a><span id="l3.1129" class="difflineminus">-  {</span>
<a href="#l3.1130"></a><span id="l3.1130" class="difflineplus">+  } else if (!PL_strcasecmp(fNextToken, &quot;LIST&quot;) ||</span>
<a href="#l3.1131"></a><span id="l3.1131" class="difflineplus">+             !PL_strcasecmp(fNextToken, &quot;XLIST&quot;)) {</span>
<a href="#l3.1132"></a><span id="l3.1132">     AdvanceToNextToken();</span>
<a href="#l3.1133"></a><span id="l3.1133" class="difflineminus">-    if (ContinueParse())</span>
<a href="#l3.1134"></a><span id="l3.1134" class="difflineminus">-      mailbox_list(false);</span>
<a href="#l3.1135"></a><span id="l3.1135" class="difflineminus">-  }</span>
<a href="#l3.1136"></a><span id="l3.1136" class="difflineminus">-  else if (!PL_strcasecmp(fNextToken, &quot;LSUB&quot;))</span>
<a href="#l3.1137"></a><span id="l3.1137" class="difflineminus">-  {</span>
<a href="#l3.1138"></a><span id="l3.1138" class="difflineplus">+    if (ContinueParse()) mailbox_list(false);</span>
<a href="#l3.1139"></a><span id="l3.1139" class="difflineplus">+  } else if (!PL_strcasecmp(fNextToken, &quot;LSUB&quot;)) {</span>
<a href="#l3.1140"></a><span id="l3.1140">     AdvanceToNextToken();</span>
<a href="#l3.1141"></a><span id="l3.1141" class="difflineminus">-    if (ContinueParse())</span>
<a href="#l3.1142"></a><span id="l3.1142" class="difflineminus">-      mailbox_list(true);</span>
<a href="#l3.1143"></a><span id="l3.1143" class="difflineminus">-  }</span>
<a href="#l3.1144"></a><span id="l3.1144" class="difflineminus">-  else if (!PL_strcasecmp(fNextToken, &quot;MAILBOX&quot;))</span>
<a href="#l3.1145"></a><span id="l3.1145" class="difflineplus">+    if (ContinueParse()) mailbox_list(true);</span>
<a href="#l3.1146"></a><span id="l3.1146" class="difflineplus">+  } else if (!PL_strcasecmp(fNextToken, &quot;MAILBOX&quot;))</span>
<a href="#l3.1147"></a><span id="l3.1147">     skip_to_CRLF();</span>
<a href="#l3.1148"></a><span id="l3.1148" class="difflineminus">-  else if (!PL_strcasecmp(fNextToken, &quot;SEARCH&quot;))</span>
<a href="#l3.1149"></a><span id="l3.1149" class="difflineminus">-  {</span>
<a href="#l3.1150"></a><span id="l3.1150" class="difflineplus">+  else if (!PL_strcasecmp(fNextToken, &quot;SEARCH&quot;)) {</span>
<a href="#l3.1151"></a><span id="l3.1151">     fSearchResults-&gt;AddSearchResultLine(fCurrentLine);</span>
<a href="#l3.1152"></a><span id="l3.1152">     fServerConnection.NotifySearchHit(fCurrentLine);</span>
<a href="#l3.1153"></a><span id="l3.1153">     skip_to_CRLF();</span>
<a href="#l3.1154"></a><span id="l3.1154">   }</span>
<a href="#l3.1155"></a><span id="l3.1155"> }</span>
<a href="#l3.1156"></a><span id="l3.1156"> </span>
<a href="#l3.1157"></a><span id="l3.1157"> /*</span>
<a href="#l3.1158"></a><span id="l3.1158">  mailbox_list    ::= &quot;(&quot; #(&quot;\Marked&quot; / &quot;\Noinferiors&quot; /</span>
<a href="#l3.1159"></a><span id="l3.1159">                               &quot;\Noselect&quot; / &quot;\Unmarked&quot; / flag_extension) &quot;)&quot;</span>
<a href="#l3.1160"></a><span id="l3.1160">                               SPACE (&lt;&quot;&gt; QUOTED_CHAR &lt;&quot;&gt; / nil) SPACE mailbox</span>
<a href="#l3.1161"></a><span id="l3.1161"> */</span>
<a href="#l3.1162"></a><span id="l3.1162"> </span>
<a href="#l3.1163"></a><span id="l3.1163" class="difflineminus">-void nsImapServerResponseParser::mailbox_list(bool discoveredFromLsub)</span>
<a href="#l3.1164"></a><span id="l3.1164" class="difflineminus">-{</span>
<a href="#l3.1165"></a><span id="l3.1165" class="difflineplus">+void nsImapServerResponseParser::mailbox_list(bool discoveredFromLsub) {</span>
<a href="#l3.1166"></a><span id="l3.1166">   RefPtr&lt;nsImapMailboxSpec&gt; boxSpec = new nsImapMailboxSpec;</span>
<a href="#l3.1167"></a><span id="l3.1167">   boxSpec-&gt;mFolderSelected = false;</span>
<a href="#l3.1168"></a><span id="l3.1168">   boxSpec-&gt;mBoxFlags = kNoFlags;</span>
<a href="#l3.1169"></a><span id="l3.1169">   boxSpec-&gt;mAllocatedPathName.Truncate();</span>
<a href="#l3.1170"></a><span id="l3.1170">   boxSpec-&gt;mHostName.Truncate();</span>
<a href="#l3.1171"></a><span id="l3.1171">   boxSpec-&gt;mConnection = &amp;fServerConnection;</span>
<a href="#l3.1172"></a><span id="l3.1172">   boxSpec-&gt;mFlagState = nullptr;</span>
<a href="#l3.1173"></a><span id="l3.1173">   boxSpec-&gt;mDiscoveredFromLsub = discoveredFromLsub;</span>
<a href="#l3.1174"></a><span id="l3.1174">   boxSpec-&gt;mOnlineVerified = true;</span>
<a href="#l3.1175"></a><span id="l3.1175">   boxSpec-&gt;mBoxFlags &amp;= ~kNameSpace;</span>
<a href="#l3.1176"></a><span id="l3.1176"> </span>
<a href="#l3.1177"></a><span id="l3.1177">   bool endOfFlags = false;</span>
<a href="#l3.1178"></a><span id="l3.1178" class="difflineminus">-  fNextToken++;// eat the first &quot;(&quot;</span>
<a href="#l3.1179"></a><span id="l3.1179" class="difflineplus">+  fNextToken++;  // eat the first &quot;(&quot;</span>
<a href="#l3.1180"></a><span id="l3.1180">   do {</span>
<a href="#l3.1181"></a><span id="l3.1181">     if (!PL_strncasecmp(fNextToken, &quot;\\Marked&quot;, 7))</span>
<a href="#l3.1182"></a><span id="l3.1182">       boxSpec-&gt;mBoxFlags |= kMarked;</span>
<a href="#l3.1183"></a><span id="l3.1183">     else if (!PL_strncasecmp(fNextToken, &quot;\\Unmarked&quot;, 9))</span>
<a href="#l3.1184"></a><span id="l3.1184">       boxSpec-&gt;mBoxFlags |= kUnmarked;</span>
<a href="#l3.1185"></a><span id="l3.1185" class="difflineminus">-    else if (!PL_strncasecmp(fNextToken, &quot;\\Noinferiors&quot;, 12))</span>
<a href="#l3.1186"></a><span id="l3.1186" class="difflineminus">-    {</span>
<a href="#l3.1187"></a><span id="l3.1187" class="difflineplus">+    else if (!PL_strncasecmp(fNextToken, &quot;\\Noinferiors&quot;, 12)) {</span>
<a href="#l3.1188"></a><span id="l3.1188">       boxSpec-&gt;mBoxFlags |= kNoinferiors;</span>
<a href="#l3.1189"></a><span id="l3.1189">       // RFC 5258 \Noinferiors implies \HasNoChildren</span>
<a href="#l3.1190"></a><span id="l3.1190">       if (fCapabilityFlag &amp; kHasListExtendedCapability)</span>
<a href="#l3.1191"></a><span id="l3.1191">         boxSpec-&gt;mBoxFlags |= kHasNoChildren;</span>
<a href="#l3.1192"></a><span id="l3.1192" class="difflineminus">-    }</span>
<a href="#l3.1193"></a><span id="l3.1193" class="difflineminus">-    else if (!PL_strncasecmp(fNextToken, &quot;\\Noselect&quot;, 9))</span>
<a href="#l3.1194"></a><span id="l3.1194" class="difflineplus">+    } else if (!PL_strncasecmp(fNextToken, &quot;\\Noselect&quot;, 9))</span>
<a href="#l3.1195"></a><span id="l3.1195">       boxSpec-&gt;mBoxFlags |= kNoselect;</span>
<a href="#l3.1196"></a><span id="l3.1196">     else if (!PL_strncasecmp(fNextToken, &quot;\\Drafts&quot;, 7))</span>
<a href="#l3.1197"></a><span id="l3.1197">       boxSpec-&gt;mBoxFlags |= kImapDrafts;</span>
<a href="#l3.1198"></a><span id="l3.1198">     else if (!PL_strncasecmp(fNextToken, &quot;\\Trash&quot;, 6))</span>
<a href="#l3.1199"></a><span id="l3.1199">       boxSpec-&gt;mBoxFlags |= kImapXListTrash;</span>
<a href="#l3.1200"></a><span id="l3.1200">     else if (!PL_strncasecmp(fNextToken, &quot;\\Sent&quot;, 5))</span>
<a href="#l3.1201"></a><span id="l3.1201">       boxSpec-&gt;mBoxFlags |= kImapSent;</span>
<a href="#l3.1202"></a><span id="l3.1202">     else if (!PL_strncasecmp(fNextToken, &quot;\\Spam&quot;, 5) ||</span>
<a href="#l3.1203"></a><span id="l3.1203" class="difflineat">@@ -854,180 +762,151 @@ void nsImapServerResponseParser::mailbox</span>
<a href="#l3.1204"></a><span id="l3.1204">       boxSpec-&gt;mBoxFlags |= kImapSpam;</span>
<a href="#l3.1205"></a><span id="l3.1205">     else if (!PL_strncasecmp(fNextToken, &quot;\\Archive&quot;, 8))</span>
<a href="#l3.1206"></a><span id="l3.1206">       boxSpec-&gt;mBoxFlags |= kImapArchive;</span>
<a href="#l3.1207"></a><span id="l3.1207">     else if (!PL_strncasecmp(fNextToken, &quot;\\All&quot;, 4) ||</span>
<a href="#l3.1208"></a><span id="l3.1208">              !PL_strncasecmp(fNextToken, &quot;\\AllMail&quot;, 8))</span>
<a href="#l3.1209"></a><span id="l3.1209">       boxSpec-&gt;mBoxFlags |= kImapAllMail;</span>
<a href="#l3.1210"></a><span id="l3.1210">     else if (!PL_strncasecmp(fNextToken, &quot;\\Inbox&quot;, 6))</span>
<a href="#l3.1211"></a><span id="l3.1211">       boxSpec-&gt;mBoxFlags |= kImapInbox;</span>
<a href="#l3.1212"></a><span id="l3.1212" class="difflineminus">-    else if (!PL_strncasecmp(fNextToken, &quot;\\NonExistent&quot;, 11))</span>
<a href="#l3.1213"></a><span id="l3.1213" class="difflineminus">-    {</span>
<a href="#l3.1214"></a><span id="l3.1214" class="difflineplus">+    else if (!PL_strncasecmp(fNextToken, &quot;\\NonExistent&quot;, 11)) {</span>
<a href="#l3.1215"></a><span id="l3.1215">       boxSpec-&gt;mBoxFlags |= kNonExistent;</span>
<a href="#l3.1216"></a><span id="l3.1216">       // RFC 5258 \NonExistent implies \Noselect</span>
<a href="#l3.1217"></a><span id="l3.1217">       boxSpec-&gt;mBoxFlags |= kNoselect;</span>
<a href="#l3.1218"></a><span id="l3.1218" class="difflineminus">-    }</span>
<a href="#l3.1219"></a><span id="l3.1219" class="difflineminus">-    else if (!PL_strncasecmp(fNextToken, &quot;\\Subscribed&quot;, 10))</span>
<a href="#l3.1220"></a><span id="l3.1220" class="difflineplus">+    } else if (!PL_strncasecmp(fNextToken, &quot;\\Subscribed&quot;, 10))</span>
<a href="#l3.1221"></a><span id="l3.1221">       boxSpec-&gt;mBoxFlags |= kSubscribed;</span>
<a href="#l3.1222"></a><span id="l3.1222">     else if (!PL_strncasecmp(fNextToken, &quot;\\Remote&quot;, 6))</span>
<a href="#l3.1223"></a><span id="l3.1223">       boxSpec-&gt;mBoxFlags |= kRemote;</span>
<a href="#l3.1224"></a><span id="l3.1224">     else if (!PL_strncasecmp(fNextToken, &quot;\\HasChildren&quot;, 11))</span>
<a href="#l3.1225"></a><span id="l3.1225">       boxSpec-&gt;mBoxFlags |= kHasChildren;</span>
<a href="#l3.1226"></a><span id="l3.1226">     else if (!PL_strncasecmp(fNextToken, &quot;\\HasNoChildren&quot;, 13))</span>
<a href="#l3.1227"></a><span id="l3.1227">       boxSpec-&gt;mBoxFlags |= kHasNoChildren;</span>
<a href="#l3.1228"></a><span id="l3.1228">     // we ignore flag other extensions</span>
<a href="#l3.1229"></a><span id="l3.1229"> </span>
<a href="#l3.1230"></a><span id="l3.1230">     endOfFlags = *(fNextToken + strlen(fNextToken) - 1) == ')';</span>
<a href="#l3.1231"></a><span id="l3.1231">     AdvanceToNextToken();</span>
<a href="#l3.1232"></a><span id="l3.1232">   } while (!endOfFlags &amp;&amp; ContinueParse());</span>
<a href="#l3.1233"></a><span id="l3.1233"> </span>
<a href="#l3.1234"></a><span id="l3.1234" class="difflineminus">-  if (ContinueParse())</span>
<a href="#l3.1235"></a><span id="l3.1235" class="difflineminus">-  {</span>
<a href="#l3.1236"></a><span id="l3.1236" class="difflineminus">-    if (*fNextToken == '&quot;')</span>
<a href="#l3.1237"></a><span id="l3.1237" class="difflineminus">-    {</span>
<a href="#l3.1238"></a><span id="l3.1238" class="difflineplus">+  if (ContinueParse()) {</span>
<a href="#l3.1239"></a><span id="l3.1239" class="difflineplus">+    if (*fNextToken == '&quot;') {</span>
<a href="#l3.1240"></a><span id="l3.1240">       fNextToken++;</span>
<a href="#l3.1241"></a><span id="l3.1241" class="difflineminus">-      if (*fNextToken == '\\') // handle escaped char</span>
<a href="#l3.1242"></a><span id="l3.1242" class="difflineplus">+      if (*fNextToken == '\\')  // handle escaped char</span>
<a href="#l3.1243"></a><span id="l3.1243">         boxSpec-&gt;mHierarchySeparator = *(fNextToken + 1);</span>
<a href="#l3.1244"></a><span id="l3.1244">       else</span>
<a href="#l3.1245"></a><span id="l3.1245">         boxSpec-&gt;mHierarchySeparator = *fNextToken;</span>
<a href="#l3.1246"></a><span id="l3.1246" class="difflineminus">-    }</span>
<a href="#l3.1247"></a><span id="l3.1247" class="difflineminus">-    else  // likely NIL.  Discovered late in 4.02 that we do not handle literals here (e.g. {10} &lt;10 chars&gt;), although this is almost impossibly unlikely</span>
<a href="#l3.1248"></a><span id="l3.1248" class="difflineplus">+    } else  // likely NIL.  Discovered late in 4.02 that we do not handle</span>
<a href="#l3.1249"></a><span id="l3.1249" class="difflineplus">+            // literals here (e.g. {10} &lt;10 chars&gt;), although this is almost</span>
<a href="#l3.1250"></a><span id="l3.1250" class="difflineplus">+            // impossibly unlikely</span>
<a href="#l3.1251"></a><span id="l3.1251">       boxSpec-&gt;mHierarchySeparator = kOnlineHierarchySeparatorNil;</span>
<a href="#l3.1252"></a><span id="l3.1252">     AdvanceToNextToken();</span>
<a href="#l3.1253"></a><span id="l3.1253" class="difflineminus">-    if (ContinueParse())</span>
<a href="#l3.1254"></a><span id="l3.1254" class="difflineminus">-      mailbox(boxSpec);</span>
<a href="#l3.1255"></a><span id="l3.1255" class="difflineplus">+    if (ContinueParse()) mailbox(boxSpec);</span>
<a href="#l3.1256"></a><span id="l3.1256">   }</span>
<a href="#l3.1257"></a><span id="l3.1257"> }</span>
<a href="#l3.1258"></a><span id="l3.1258"> </span>
<a href="#l3.1259"></a><span id="l3.1259"> /* mailbox         ::= &quot;INBOX&quot; / astring</span>
<a href="#l3.1260"></a><span id="l3.1260" class="difflineminus">-*/</span>
<a href="#l3.1261"></a><span id="l3.1261" class="difflineminus">-void nsImapServerResponseParser::mailbox(nsImapMailboxSpec *boxSpec)</span>
<a href="#l3.1262"></a><span id="l3.1262" class="difflineminus">-{</span>
<a href="#l3.1263"></a><span id="l3.1263" class="difflineplus">+ */</span>
<a href="#l3.1264"></a><span id="l3.1264" class="difflineplus">+void nsImapServerResponseParser::mailbox(nsImapMailboxSpec *boxSpec) {</span>
<a href="#l3.1265"></a><span id="l3.1265">   char *boxname = nullptr;</span>
<a href="#l3.1266"></a><span id="l3.1266">   const char *serverKey = fServerConnection.GetImapServerKey();</span>
<a href="#l3.1267"></a><span id="l3.1267">   bool xlistInbox = boxSpec-&gt;mBoxFlags &amp; kImapInbox;</span>
<a href="#l3.1268"></a><span id="l3.1268"> </span>
<a href="#l3.1269"></a><span id="l3.1269" class="difflineminus">-  if (!PL_strcasecmp(fNextToken, &quot;INBOX&quot;) || xlistInbox)</span>
<a href="#l3.1270"></a><span id="l3.1270" class="difflineminus">-  {</span>
<a href="#l3.1271"></a><span id="l3.1271" class="difflineplus">+  if (!PL_strcasecmp(fNextToken, &quot;INBOX&quot;) || xlistInbox) {</span>
<a href="#l3.1272"></a><span id="l3.1272">     boxname = PL_strdup(&quot;INBOX&quot;);</span>
<a href="#l3.1273"></a><span id="l3.1273" class="difflineminus">-    if (xlistInbox)</span>
<a href="#l3.1274"></a><span id="l3.1274" class="difflineminus">-      PR_Free(CreateAstring());</span>
<a href="#l3.1275"></a><span id="l3.1275" class="difflineplus">+    if (xlistInbox) PR_Free(CreateAstring());</span>
<a href="#l3.1276"></a><span id="l3.1276">     AdvanceToNextToken();</span>
<a href="#l3.1277"></a><span id="l3.1277" class="difflineminus">-  }</span>
<a href="#l3.1278"></a><span id="l3.1278" class="difflineminus">-  else</span>
<a href="#l3.1279"></a><span id="l3.1279" class="difflineminus">-  {</span>
<a href="#l3.1280"></a><span id="l3.1280" class="difflineplus">+  } else {</span>
<a href="#l3.1281"></a><span id="l3.1281">     boxname = CreateAstring();</span>
<a href="#l3.1282"></a><span id="l3.1282">     AdvanceToNextToken();</span>
<a href="#l3.1283"></a><span id="l3.1283">   }</span>
<a href="#l3.1284"></a><span id="l3.1284"> </span>
<a href="#l3.1285"></a><span id="l3.1285" class="difflineminus">-  if (boxname &amp;&amp; fHostSessionList)</span>
<a href="#l3.1286"></a><span id="l3.1286" class="difflineminus">-  {</span>
<a href="#l3.1287"></a><span id="l3.1287" class="difflineplus">+  if (boxname &amp;&amp; fHostSessionList) {</span>
<a href="#l3.1288"></a><span id="l3.1288">     // should the namespace check go before or after the Utf7 conversion?</span>
<a href="#l3.1289"></a><span id="l3.1289">     fHostSessionList-&gt;SetNamespaceHierarchyDelimiterFromMailboxForHost(</span>
<a href="#l3.1290"></a><span id="l3.1290" class="difflineminus">-      serverKey, boxname, boxSpec-&gt;mHierarchySeparator);</span>
<a href="#l3.1291"></a><span id="l3.1291" class="difflineminus">-</span>
<a href="#l3.1292"></a><span id="l3.1292" class="difflineplus">+        serverKey, boxname, boxSpec-&gt;mHierarchySeparator);</span>
<a href="#l3.1293"></a><span id="l3.1293"> </span>
<a href="#l3.1294"></a><span id="l3.1294">     nsIMAPNamespace *ns = nullptr;</span>
<a href="#l3.1295"></a><span id="l3.1295">     fHostSessionList-&gt;GetNamespaceForMailboxForHost(serverKey, boxname, ns);</span>
<a href="#l3.1296"></a><span id="l3.1296" class="difflineminus">-    if (ns)</span>
<a href="#l3.1297"></a><span id="l3.1297" class="difflineminus">-    {</span>
<a href="#l3.1298"></a><span id="l3.1298" class="difflineminus">-      switch (ns-&gt;GetType())</span>
<a href="#l3.1299"></a><span id="l3.1299" class="difflineminus">-      {</span>
<a href="#l3.1300"></a><span id="l3.1300" class="difflineminus">-      case kPersonalNamespace:</span>
<a href="#l3.1301"></a><span id="l3.1301" class="difflineminus">-        boxSpec-&gt;mBoxFlags |= kPersonalMailbox;</span>
<a href="#l3.1302"></a><span id="l3.1302" class="difflineminus">-        break;</span>
<a href="#l3.1303"></a><span id="l3.1303" class="difflineminus">-      case kPublicNamespace:</span>
<a href="#l3.1304"></a><span id="l3.1304" class="difflineminus">-        boxSpec-&gt;mBoxFlags |= kPublicMailbox;</span>
<a href="#l3.1305"></a><span id="l3.1305" class="difflineminus">-        break;</span>
<a href="#l3.1306"></a><span id="l3.1306" class="difflineminus">-      case kOtherUsersNamespace:</span>
<a href="#l3.1307"></a><span id="l3.1307" class="difflineminus">-        boxSpec-&gt;mBoxFlags |= kOtherUsersMailbox;</span>
<a href="#l3.1308"></a><span id="l3.1308" class="difflineminus">-        break;</span>
<a href="#l3.1309"></a><span id="l3.1309" class="difflineminus">-      default:  // (kUnknownNamespace)</span>
<a href="#l3.1310"></a><span id="l3.1310" class="difflineminus">-        break;</span>
<a href="#l3.1311"></a><span id="l3.1311" class="difflineplus">+    if (ns) {</span>
<a href="#l3.1312"></a><span id="l3.1312" class="difflineplus">+      switch (ns-&gt;GetType()) {</span>
<a href="#l3.1313"></a><span id="l3.1313" class="difflineplus">+        case kPersonalNamespace:</span>
<a href="#l3.1314"></a><span id="l3.1314" class="difflineplus">+          boxSpec-&gt;mBoxFlags |= kPersonalMailbox;</span>
<a href="#l3.1315"></a><span id="l3.1315" class="difflineplus">+          break;</span>
<a href="#l3.1316"></a><span id="l3.1316" class="difflineplus">+        case kPublicNamespace:</span>
<a href="#l3.1317"></a><span id="l3.1317" class="difflineplus">+          boxSpec-&gt;mBoxFlags |= kPublicMailbox;</span>
<a href="#l3.1318"></a><span id="l3.1318" class="difflineplus">+          break;</span>
<a href="#l3.1319"></a><span id="l3.1319" class="difflineplus">+        case kOtherUsersNamespace:</span>
<a href="#l3.1320"></a><span id="l3.1320" class="difflineplus">+          boxSpec-&gt;mBoxFlags |= kOtherUsersMailbox;</span>
<a href="#l3.1321"></a><span id="l3.1321" class="difflineplus">+          break;</span>
<a href="#l3.1322"></a><span id="l3.1322" class="difflineplus">+        default:  // (kUnknownNamespace)</span>
<a href="#l3.1323"></a><span id="l3.1323" class="difflineplus">+          break;</span>
<a href="#l3.1324"></a><span id="l3.1324">       }</span>
<a href="#l3.1325"></a><span id="l3.1325">       boxSpec-&gt;mNamespaceForFolder = ns;</span>
<a href="#l3.1326"></a><span id="l3.1326">     }</span>
<a href="#l3.1327"></a><span id="l3.1327"> </span>
<a href="#l3.1328"></a><span id="l3.1328" class="difflineminus">-    // char *convertedName = fServerConnection.CreateUtf7ConvertedString(boxname, false);</span>
<a href="#l3.1329"></a><span id="l3.1329" class="difflineminus">-    // char16_t *unicharName = fServerConnection.CreatePRUnicharStringFromUTF7(boxname);</span>
<a href="#l3.1330"></a><span id="l3.1330" class="difflineplus">+    // char *convertedName =</span>
<a href="#l3.1331"></a><span id="l3.1331" class="difflineplus">+    // fServerConnection.CreateUtf7ConvertedString(boxname, false); char16_t</span>
<a href="#l3.1332"></a><span id="l3.1332" class="difflineplus">+    // *unicharName = fServerConnection.CreatePRUnicharStringFromUTF7(boxname);</span>
<a href="#l3.1333"></a><span id="l3.1333">     // PL_strfree(boxname);</span>
<a href="#l3.1334"></a><span id="l3.1334">     // boxname = convertedName;</span>
<a href="#l3.1335"></a><span id="l3.1335">   }</span>
<a href="#l3.1336"></a><span id="l3.1336"> </span>
<a href="#l3.1337"></a><span id="l3.1337" class="difflineminus">-  if (!boxname)</span>
<a href="#l3.1338"></a><span id="l3.1338" class="difflineminus">-  {</span>
<a href="#l3.1339"></a><span id="l3.1339" class="difflineminus">-    if (!fServerConnection.DeathSignalReceived())</span>
<a href="#l3.1340"></a><span id="l3.1340" class="difflineminus">-      HandleMemoryFailure();</span>
<a href="#l3.1341"></a><span id="l3.1341" class="difflineminus">-  }</span>
<a href="#l3.1342"></a><span id="l3.1342" class="difflineminus">-  else if (boxSpec-&gt;mConnection &amp;&amp; boxSpec-&gt;mConnection-&gt;GetCurrentUrl())</span>
<a href="#l3.1343"></a><span id="l3.1343" class="difflineminus">-  {</span>
<a href="#l3.1344"></a><span id="l3.1344" class="difflineminus">-    boxSpec-&gt;mConnection-&gt;GetCurrentUrl()-&gt;AllocateCanonicalPath(boxname, boxSpec-&gt;mHierarchySeparator,</span>
<a href="#l3.1345"></a><span id="l3.1345" class="difflineminus">-                                                                 getter_Copies(boxSpec-&gt;mAllocatedPathName));</span>
<a href="#l3.1346"></a><span id="l3.1346" class="difflineplus">+  if (!boxname) {</span>
<a href="#l3.1347"></a><span id="l3.1347" class="difflineplus">+    if (!fServerConnection.DeathSignalReceived()) HandleMemoryFailure();</span>
<a href="#l3.1348"></a><span id="l3.1348" class="difflineplus">+  } else if (boxSpec-&gt;mConnection &amp;&amp; boxSpec-&gt;mConnection-&gt;GetCurrentUrl()) {</span>
<a href="#l3.1349"></a><span id="l3.1349" class="difflineplus">+    boxSpec-&gt;mConnection-&gt;GetCurrentUrl()-&gt;AllocateCanonicalPath(</span>
<a href="#l3.1350"></a><span id="l3.1350" class="difflineplus">+        boxname, boxSpec-&gt;mHierarchySeparator,</span>
<a href="#l3.1351"></a><span id="l3.1351" class="difflineplus">+        getter_Copies(boxSpec-&gt;mAllocatedPathName));</span>
<a href="#l3.1352"></a><span id="l3.1352">     nsIURI *aURL = nullptr;</span>
<a href="#l3.1353"></a><span id="l3.1353" class="difflineminus">-    boxSpec-&gt;mConnection-&gt;GetCurrentUrl()-&gt;QueryInterface(NS_GET_IID(nsIURI), (void **) &amp;aURL);</span>
<a href="#l3.1354"></a><span id="l3.1354" class="difflineminus">-    if (aURL)</span>
<a href="#l3.1355"></a><span id="l3.1355" class="difflineminus">-      aURL-&gt;GetHost(boxSpec-&gt;mHostName);</span>
<a href="#l3.1356"></a><span id="l3.1356" class="difflineplus">+    boxSpec-&gt;mConnection-&gt;GetCurrentUrl()-&gt;QueryInterface(NS_GET_IID(nsIURI),</span>
<a href="#l3.1357"></a><span id="l3.1357" class="difflineplus">+                                                          (void **)&amp;aURL);</span>
<a href="#l3.1358"></a><span id="l3.1358" class="difflineplus">+    if (aURL) aURL-&gt;GetHost(boxSpec-&gt;mHostName);</span>
<a href="#l3.1359"></a><span id="l3.1359"> </span>
<a href="#l3.1360"></a><span id="l3.1360">     NS_IF_RELEASE(aURL);</span>
<a href="#l3.1361"></a><span id="l3.1361">     // storage for the boxSpec is now owned by server connection</span>
<a href="#l3.1362"></a><span id="l3.1362">     fServerConnection.DiscoverMailboxSpec(boxSpec);</span>
<a href="#l3.1363"></a><span id="l3.1363"> </span>
<a href="#l3.1364"></a><span id="l3.1364">     // if this was cancelled by the user,then we sure don't want to</span>
<a href="#l3.1365"></a><span id="l3.1365">     // send more mailboxes their way</span>
<a href="#l3.1366"></a><span id="l3.1366" class="difflineminus">-    if (NS_FAILED(fServerConnection.GetConnectionStatus()))</span>
<a href="#l3.1367"></a><span id="l3.1367" class="difflineminus">-      SetConnected(false);</span>
<a href="#l3.1368"></a><span id="l3.1368" class="difflineplus">+    if (NS_FAILED(fServerConnection.GetConnectionStatus())) SetConnected(false);</span>
<a href="#l3.1369"></a><span id="l3.1369">   }</span>
<a href="#l3.1370"></a><span id="l3.1370"> </span>
<a href="#l3.1371"></a><span id="l3.1371" class="difflineminus">-  if (boxname)</span>
<a href="#l3.1372"></a><span id="l3.1372" class="difflineminus">-    PL_strfree(boxname);</span>
<a href="#l3.1373"></a><span id="l3.1373" class="difflineplus">+  if (boxname) PL_strfree(boxname);</span>
<a href="#l3.1374"></a><span id="l3.1374"> }</span>
<a href="#l3.1375"></a><span id="l3.1375"> </span>
<a href="#l3.1376"></a><span id="l3.1376" class="difflineminus">-</span>
<a href="#l3.1377"></a><span id="l3.1377"> /*</span>
<a href="#l3.1378"></a><span id="l3.1378">  message_data    ::= nz_number SPACE (&quot;EXPUNGE&quot; /</span>
<a href="#l3.1379"></a><span id="l3.1379">                               (&quot;FETCH&quot; SPACE msg_fetch) / msg_obsolete)</span>
<a href="#l3.1380"></a><span id="l3.1380"> </span>
<a href="#l3.1381"></a><span id="l3.1381"> was changed to</span>
<a href="#l3.1382"></a><span id="l3.1382"> </span>
<a href="#l3.1383"></a><span id="l3.1383"> numeric_mailbox_data ::=  number SPACE &quot;EXISTS&quot; / number SPACE &quot;RECENT&quot;</span>
<a href="#l3.1384"></a><span id="l3.1384">  / nz_number SPACE (&quot;EXPUNGE&quot; /</span>
<a href="#l3.1385"></a><span id="l3.1385">                               (&quot;FETCH&quot; SPACE msg_fetch) / msg_obsolete)</span>
<a href="#l3.1386"></a><span id="l3.1386"> </span>
<a href="#l3.1387"></a><span id="l3.1387"> */</span>
<a href="#l3.1388"></a><span id="l3.1388" class="difflineminus">-void nsImapServerResponseParser::numeric_mailbox_data()</span>
<a href="#l3.1389"></a><span id="l3.1389" class="difflineminus">-{</span>
<a href="#l3.1390"></a><span id="l3.1390" class="difflineplus">+void nsImapServerResponseParser::numeric_mailbox_data() {</span>
<a href="#l3.1391"></a><span id="l3.1391">   int32_t tokenNumber = atoi(fNextToken);</span>
<a href="#l3.1392"></a><span id="l3.1392">   AdvanceToNextToken();</span>
<a href="#l3.1393"></a><span id="l3.1393"> </span>
<a href="#l3.1394"></a><span id="l3.1394" class="difflineminus">-  if (ContinueParse())</span>
<a href="#l3.1395"></a><span id="l3.1395" class="difflineminus">-  {</span>
<a href="#l3.1396"></a><span id="l3.1396" class="difflineminus">-    if (!PL_strcasecmp(fNextToken, &quot;FETCH&quot;))</span>
<a href="#l3.1397"></a><span id="l3.1397" class="difflineminus">-    {</span>
<a href="#l3.1398"></a><span id="l3.1398" class="difflineplus">+  if (ContinueParse()) {</span>
<a href="#l3.1399"></a><span id="l3.1399" class="difflineplus">+    if (!PL_strcasecmp(fNextToken, &quot;FETCH&quot;)) {</span>
<a href="#l3.1400"></a><span id="l3.1400">       fFetchResponseIndex = tokenNumber;</span>
<a href="#l3.1401"></a><span id="l3.1401">       AdvanceToNextToken();</span>
<a href="#l3.1402"></a><span id="l3.1402" class="difflineminus">-      if (ContinueParse())</span>
<a href="#l3.1403"></a><span id="l3.1403" class="difflineminus">-        msg_fetch();</span>
<a href="#l3.1404"></a><span id="l3.1404" class="difflineminus">-    }</span>
<a href="#l3.1405"></a><span id="l3.1405" class="difflineminus">-    else if (!PL_strcasecmp(fNextToken, &quot;EXISTS&quot;))</span>
<a href="#l3.1406"></a><span id="l3.1406" class="difflineminus">-    {</span>
<a href="#l3.1407"></a><span id="l3.1407" class="difflineplus">+      if (ContinueParse()) msg_fetch();</span>
<a href="#l3.1408"></a><span id="l3.1408" class="difflineplus">+    } else if (!PL_strcasecmp(fNextToken, &quot;EXISTS&quot;)) {</span>
<a href="#l3.1409"></a><span id="l3.1409">       fNumberOfExistingMessages = tokenNumber;</span>
<a href="#l3.1410"></a><span id="l3.1410">       AdvanceToNextToken();</span>
<a href="#l3.1411"></a><span id="l3.1411" class="difflineminus">-    }</span>
<a href="#l3.1412"></a><span id="l3.1412" class="difflineminus">-    else if (!PL_strcasecmp(fNextToken, &quot;RECENT&quot;))</span>
<a href="#l3.1413"></a><span id="l3.1413" class="difflineminus">-    {</span>
<a href="#l3.1414"></a><span id="l3.1414" class="difflineplus">+    } else if (!PL_strcasecmp(fNextToken, &quot;RECENT&quot;)) {</span>
<a href="#l3.1415"></a><span id="l3.1415">       fNumberOfRecentMessages = tokenNumber;</span>
<a href="#l3.1416"></a><span id="l3.1416">       AdvanceToNextToken();</span>
<a href="#l3.1417"></a><span id="l3.1417" class="difflineminus">-    }</span>
<a href="#l3.1418"></a><span id="l3.1418" class="difflineminus">-    else if (!PL_strcasecmp(fNextToken, &quot;EXPUNGE&quot;))</span>
<a href="#l3.1419"></a><span id="l3.1419" class="difflineminus">-    {</span>
<a href="#l3.1420"></a><span id="l3.1420" class="difflineplus">+    } else if (!PL_strcasecmp(fNextToken, &quot;EXPUNGE&quot;)) {</span>
<a href="#l3.1421"></a><span id="l3.1421">       if (!fServerConnection.GetIgnoreExpunges())</span>
<a href="#l3.1422"></a><span id="l3.1422" class="difflineminus">-        fFlagState-&gt;ExpungeByIndex((uint32_t) tokenNumber);</span>
<a href="#l3.1423"></a><span id="l3.1423" class="difflineplus">+        fFlagState-&gt;ExpungeByIndex((uint32_t)tokenNumber);</span>
<a href="#l3.1424"></a><span id="l3.1424">       skip_to_CRLF();</span>
<a href="#l3.1425"></a><span id="l3.1425" class="difflineminus">-    }</span>
<a href="#l3.1426"></a><span id="l3.1426" class="difflineminus">-    else</span>
<a href="#l3.1427"></a><span id="l3.1427" class="difflineplus">+    } else</span>
<a href="#l3.1428"></a><span id="l3.1428">       msg_obsolete();</span>
<a href="#l3.1429"></a><span id="l3.1429">   }</span>
<a href="#l3.1430"></a><span id="l3.1430"> }</span>
<a href="#l3.1431"></a><span id="l3.1431"> </span>
<a href="#l3.1432"></a><span id="l3.1432"> /*</span>
<a href="#l3.1433"></a><span id="l3.1433"> msg_fetch       ::= &quot;(&quot; 1#(&quot;BODY&quot; SPACE body /</span>
<a href="#l3.1434"></a><span id="l3.1434"> &quot;BODYSTRUCTURE&quot; SPACE body /</span>
<a href="#l3.1435"></a><span id="l3.1435"> &quot;BODY[&quot; section &quot;]&quot; SPACE nstring /</span>
<a href="#l3.1436"></a><span id="l3.1436" class="difflineat">@@ -1036,428 +915,361 @@ msg_fetch       ::= &quot;(&quot; 1#(&quot;BODY&quot; SPACE </span>
<a href="#l3.1437"></a><span id="l3.1437"> &quot;INTERNALDATE&quot; SPACE date_time /</span>
<a href="#l3.1438"></a><span id="l3.1438"> &quot;MODSEQ&quot; SPACE &quot;(&quot; nz_number &quot;)&quot; /</span>
<a href="#l3.1439"></a><span id="l3.1439"> &quot;RFC822&quot; [&quot;.HEADER&quot; / &quot;.TEXT&quot;] SPACE nstring /</span>
<a href="#l3.1440"></a><span id="l3.1440"> &quot;RFC822.SIZE&quot; SPACE number /</span>
<a href="#l3.1441"></a><span id="l3.1441"> &quot;UID&quot; SPACE uniqueid) &quot;)&quot;</span>
<a href="#l3.1442"></a><span id="l3.1442"> </span>
<a href="#l3.1443"></a><span id="l3.1443"> */</span>
<a href="#l3.1444"></a><span id="l3.1444"> </span>
<a href="#l3.1445"></a><span id="l3.1445" class="difflineminus">-void nsImapServerResponseParser::msg_fetch()</span>
<a href="#l3.1446"></a><span id="l3.1446" class="difflineminus">-{</span>
<a href="#l3.1447"></a><span id="l3.1447" class="difflineplus">+void nsImapServerResponseParser::msg_fetch() {</span>
<a href="#l3.1448"></a><span id="l3.1448">   bool bNeedEndMessageDownload = false;</span>
<a href="#l3.1449"></a><span id="l3.1449"> </span>
<a href="#l3.1450"></a><span id="l3.1450">   // we have not seen a uid response or flags for this fetch, yet</span>
<a href="#l3.1451"></a><span id="l3.1451">   fCurrentResponseUID = 0;</span>
<a href="#l3.1452"></a><span id="l3.1452">   fCurrentLineContainedFlagInfo = false;</span>
<a href="#l3.1453"></a><span id="l3.1453">   fSizeOfMostRecentMessage = 0;</span>
<a href="#l3.1454"></a><span id="l3.1454">   // show any incremental progress, for instance, for header downloading</span>
<a href="#l3.1455"></a><span id="l3.1455">   fServerConnection.ShowProgress();</span>
<a href="#l3.1456"></a><span id="l3.1456"> </span>
<a href="#l3.1457"></a><span id="l3.1457" class="difflineminus">-  fNextToken++; // eat the '(' character</span>
<a href="#l3.1458"></a><span id="l3.1458" class="difflineplus">+  fNextToken++;  // eat the '(' character</span>
<a href="#l3.1459"></a><span id="l3.1459"> </span>
<a href="#l3.1460"></a><span id="l3.1460">   // some of these productions are ignored for now</span>
<a href="#l3.1461"></a><span id="l3.1461" class="difflineminus">-  while (ContinueParse() &amp;&amp; (*fNextToken != ')') )</span>
<a href="#l3.1462"></a><span id="l3.1462" class="difflineminus">-  {</span>
<a href="#l3.1463"></a><span id="l3.1463" class="difflineminus">-    if (!PL_strcasecmp(fNextToken, &quot;FLAGS&quot;))</span>
<a href="#l3.1464"></a><span id="l3.1464" class="difflineminus">-    {</span>
<a href="#l3.1465"></a><span id="l3.1465" class="difflineplus">+  while (ContinueParse() &amp;&amp; (*fNextToken != ')')) {</span>
<a href="#l3.1466"></a><span id="l3.1466" class="difflineplus">+    if (!PL_strcasecmp(fNextToken, &quot;FLAGS&quot;)) {</span>
<a href="#l3.1467"></a><span id="l3.1467">       if (fCurrentResponseUID == 0)</span>
<a href="#l3.1468"></a><span id="l3.1468" class="difflineminus">-        fFlagState-&gt;GetUidOfMessage(fFetchResponseIndex - 1, &amp;fCurrentResponseUID);</span>
<a href="#l3.1469"></a><span id="l3.1469" class="difflineplus">+        fFlagState-&gt;GetUidOfMessage(fFetchResponseIndex - 1,</span>
<a href="#l3.1470"></a><span id="l3.1470" class="difflineplus">+                                    &amp;fCurrentResponseUID);</span>
<a href="#l3.1471"></a><span id="l3.1471"> </span>
<a href="#l3.1472"></a><span id="l3.1472">       AdvanceToNextToken();</span>
<a href="#l3.1473"></a><span id="l3.1473" class="difflineminus">-      if (ContinueParse())</span>
<a href="#l3.1474"></a><span id="l3.1474" class="difflineminus">-        flags();</span>
<a href="#l3.1475"></a><span id="l3.1475" class="difflineplus">+      if (ContinueParse()) flags();</span>
<a href="#l3.1476"></a><span id="l3.1476"> </span>
<a href="#l3.1477"></a><span id="l3.1477" class="difflineminus">-      if (ContinueParse())</span>
<a href="#l3.1478"></a><span id="l3.1478" class="difflineminus">-      { // eat the closing ')'</span>
<a href="#l3.1479"></a><span id="l3.1479" class="difflineplus">+      if (ContinueParse()) {  // eat the closing ')'</span>
<a href="#l3.1480"></a><span id="l3.1480">         fNextToken++;</span>
<a href="#l3.1481"></a><span id="l3.1481">         // there may be another ')' to close out</span>
<a href="#l3.1482"></a><span id="l3.1482">         // msg_fetch.  If there is then don't advance</span>
<a href="#l3.1483"></a><span id="l3.1483" class="difflineminus">-        if (*fNextToken != ')')</span>
<a href="#l3.1484"></a><span id="l3.1484" class="difflineminus">-          AdvanceToNextToken();</span>
<a href="#l3.1485"></a><span id="l3.1485" class="difflineplus">+        if (*fNextToken != ')') AdvanceToNextToken();</span>
<a href="#l3.1486"></a><span id="l3.1486">       }</span>
<a href="#l3.1487"></a><span id="l3.1487" class="difflineminus">-    }</span>
<a href="#l3.1488"></a><span id="l3.1488" class="difflineminus">-    else if (!PL_strcasecmp(fNextToken, &quot;UID&quot;))</span>
<a href="#l3.1489"></a><span id="l3.1489" class="difflineminus">-    {</span>
<a href="#l3.1490"></a><span id="l3.1490" class="difflineplus">+    } else if (!PL_strcasecmp(fNextToken, &quot;UID&quot;)) {</span>
<a href="#l3.1491"></a><span id="l3.1491">       AdvanceToNextToken();</span>
<a href="#l3.1492"></a><span id="l3.1492" class="difflineminus">-      if (ContinueParse())</span>
<a href="#l3.1493"></a><span id="l3.1493" class="difflineminus">-      {</span>
<a href="#l3.1494"></a><span id="l3.1494" class="difflineplus">+      if (ContinueParse()) {</span>
<a href="#l3.1495"></a><span id="l3.1495">         fCurrentResponseUID = strtoul(fNextToken, nullptr, 10);</span>
<a href="#l3.1496"></a><span id="l3.1496">         if (fCurrentResponseUID &gt; fHighestRecordedUID)</span>
<a href="#l3.1497"></a><span id="l3.1497">           fHighestRecordedUID = fCurrentResponseUID;</span>
<a href="#l3.1498"></a><span id="l3.1498">         // size came before UID</span>
<a href="#l3.1499"></a><span id="l3.1499">         if (fSizeOfMostRecentMessage)</span>
<a href="#l3.1500"></a><span id="l3.1500">           fReceivedHeaderOrSizeForUID = CurrentResponseUID();</span>
<a href="#l3.1501"></a><span id="l3.1501">         // if this token ends in ')', then it is the last token</span>
<a href="#l3.1502"></a><span id="l3.1502">         // else we advance</span>
<a href="#l3.1503"></a><span id="l3.1503">         char lastTokenChar = *(fNextToken + strlen(fNextToken) - 1);</span>
<a href="#l3.1504"></a><span id="l3.1504">         if (lastTokenChar == ')')</span>
<a href="#l3.1505"></a><span id="l3.1505">           fNextToken += strlen(fNextToken) - 1;</span>
<a href="#l3.1506"></a><span id="l3.1506" class="difflineminus">-        else if (lastTokenChar &lt; '0' || lastTokenChar &gt; '9')</span>
<a href="#l3.1507"></a><span id="l3.1507" class="difflineminus">-        {</span>
<a href="#l3.1508"></a><span id="l3.1508" class="difflineplus">+        else if (lastTokenChar &lt; '0' || lastTokenChar &gt; '9') {</span>
<a href="#l3.1509"></a><span id="l3.1509">           // GIANT HACK</span>
<a href="#l3.1510"></a><span id="l3.1510">           // this is a corrupt uid - see if it's pre 5.08 Zimbra omitting</span>
<a href="#l3.1511"></a><span id="l3.1511">           // a space between the UID and MODSEQ</span>
<a href="#l3.1512"></a><span id="l3.1512">           if (strlen(fNextToken) &gt; 6 &amp;&amp;</span>
<a href="#l3.1513"></a><span id="l3.1513">               !strcmp(&quot;MODSEQ&quot;, fNextToken + strlen(fNextToken) - 6))</span>
<a href="#l3.1514"></a><span id="l3.1514">             fNextToken += strlen(fNextToken) - 6;</span>
<a href="#l3.1515"></a><span id="l3.1515" class="difflineminus">-        }</span>
<a href="#l3.1516"></a><span id="l3.1516" class="difflineminus">-        else</span>
<a href="#l3.1517"></a><span id="l3.1517" class="difflineplus">+        } else</span>
<a href="#l3.1518"></a><span id="l3.1518">           AdvanceToNextToken();</span>
<a href="#l3.1519"></a><span id="l3.1519">       }</span>
<a href="#l3.1520"></a><span id="l3.1520" class="difflineminus">-    }</span>
<a href="#l3.1521"></a><span id="l3.1521" class="difflineminus">-    else if (!PL_strcasecmp(fNextToken, &quot;MODSEQ&quot;))</span>
<a href="#l3.1522"></a><span id="l3.1522" class="difflineminus">-    {</span>
<a href="#l3.1523"></a><span id="l3.1523" class="difflineplus">+    } else if (!PL_strcasecmp(fNextToken, &quot;MODSEQ&quot;)) {</span>
<a href="#l3.1524"></a><span id="l3.1524">       AdvanceToNextToken();</span>
<a href="#l3.1525"></a><span id="l3.1525" class="difflineminus">-      if (ContinueParse())</span>
<a href="#l3.1526"></a><span id="l3.1526" class="difflineminus">-      {</span>
<a href="#l3.1527"></a><span id="l3.1527" class="difflineminus">-        fNextToken++; // eat '('</span>
<a href="#l3.1528"></a><span id="l3.1528" class="difflineminus">-        uint64_t modSeq =  ParseUint64Str(fNextToken);</span>
<a href="#l3.1529"></a><span id="l3.1529" class="difflineminus">-        if (modSeq &gt; fHighestModSeq)</span>
<a href="#l3.1530"></a><span id="l3.1530" class="difflineminus">-          fHighestModSeq = modSeq;</span>
<a href="#l3.1531"></a><span id="l3.1531" class="difflineplus">+      if (ContinueParse()) {</span>
<a href="#l3.1532"></a><span id="l3.1532" class="difflineplus">+        fNextToken++;  // eat '('</span>
<a href="#l3.1533"></a><span id="l3.1533" class="difflineplus">+        uint64_t modSeq = ParseUint64Str(fNextToken);</span>
<a href="#l3.1534"></a><span id="l3.1534" class="difflineplus">+        if (modSeq &gt; fHighestModSeq) fHighestModSeq = modSeq;</span>
<a href="#l3.1535"></a><span id="l3.1535"> </span>
<a href="#l3.1536"></a><span id="l3.1536" class="difflineminus">-        if (PL_strcasestr(fNextToken, &quot;)&quot;))</span>
<a href="#l3.1537"></a><span id="l3.1537" class="difflineminus">-        {</span>
<a href="#l3.1538"></a><span id="l3.1538" class="difflineplus">+        if (PL_strcasestr(fNextToken, &quot;)&quot;)) {</span>
<a href="#l3.1539"></a><span id="l3.1539">           // eat token chars until we get the ')'</span>
<a href="#l3.1540"></a><span id="l3.1540">           fNextToken = strchr(fNextToken, ')');</span>
<a href="#l3.1541"></a><span id="l3.1541" class="difflineminus">-          if (fNextToken)</span>
<a href="#l3.1542"></a><span id="l3.1542" class="difflineminus">-          {</span>
<a href="#l3.1543"></a><span id="l3.1543" class="difflineplus">+          if (fNextToken) {</span>
<a href="#l3.1544"></a><span id="l3.1544">             fNextToken++;</span>
<a href="#l3.1545"></a><span id="l3.1545" class="difflineminus">-            if (*fNextToken != ')')</span>
<a href="#l3.1546"></a><span id="l3.1546" class="difflineminus">-              AdvanceToNextToken();</span>
<a href="#l3.1547"></a><span id="l3.1547" class="difflineminus">-          }</span>
<a href="#l3.1548"></a><span id="l3.1548" class="difflineminus">-          else</span>
<a href="#l3.1549"></a><span id="l3.1549" class="difflineplus">+            if (*fNextToken != ')') AdvanceToNextToken();</span>
<a href="#l3.1550"></a><span id="l3.1550" class="difflineplus">+          } else</span>
<a href="#l3.1551"></a><span id="l3.1551">             SetSyntaxError(true);</span>
<a href="#l3.1552"></a><span id="l3.1552" class="difflineminus">-        }</span>
<a href="#l3.1553"></a><span id="l3.1553" class="difflineminus">-        else</span>
<a href="#l3.1554"></a><span id="l3.1554" class="difflineminus">-        {</span>
<a href="#l3.1555"></a><span id="l3.1555" class="difflineplus">+        } else {</span>
<a href="#l3.1556"></a><span id="l3.1556">           SetSyntaxError(true);</span>
<a href="#l3.1557"></a><span id="l3.1557">         }</span>
<a href="#l3.1558"></a><span id="l3.1558">       }</span>
<a href="#l3.1559"></a><span id="l3.1559" class="difflineminus">-    }</span>
<a href="#l3.1560"></a><span id="l3.1560" class="difflineminus">-    else if (!PL_strcasecmp(fNextToken, &quot;RFC822&quot;) ||</span>
<a href="#l3.1561"></a><span id="l3.1561" class="difflineminus">-             !PL_strcasecmp(fNextToken, &quot;RFC822.HEADER&quot;) ||</span>
<a href="#l3.1562"></a><span id="l3.1562" class="difflineminus">-             !PL_strncasecmp(fNextToken, &quot;BODY[HEADER&quot;,11) ||</span>
<a href="#l3.1563"></a><span id="l3.1563" class="difflineminus">-             !PL_strncasecmp(fNextToken, &quot;BODY[]&quot;, 6) ||</span>
<a href="#l3.1564"></a><span id="l3.1564" class="difflineminus">-             !PL_strcasecmp(fNextToken, &quot;RFC822.TEXT&quot;) ||</span>
<a href="#l3.1565"></a><span id="l3.1565" class="difflineminus">-             (!PL_strncasecmp(fNextToken, &quot;BODY[&quot;, 5) &amp;&amp;</span>
<a href="#l3.1566"></a><span id="l3.1566" class="difflineminus">-              PL_strstr(fNextToken, &quot;HEADER&quot;)))</span>
<a href="#l3.1567"></a><span id="l3.1567" class="difflineminus">-    {</span>
<a href="#l3.1568"></a><span id="l3.1568" class="difflineplus">+    } else if (!PL_strcasecmp(fNextToken, &quot;RFC822&quot;) ||</span>
<a href="#l3.1569"></a><span id="l3.1569" class="difflineplus">+               !PL_strcasecmp(fNextToken, &quot;RFC822.HEADER&quot;) ||</span>
<a href="#l3.1570"></a><span id="l3.1570" class="difflineplus">+               !PL_strncasecmp(fNextToken, &quot;BODY[HEADER&quot;, 11) ||</span>
<a href="#l3.1571"></a><span id="l3.1571" class="difflineplus">+               !PL_strncasecmp(fNextToken, &quot;BODY[]&quot;, 6) ||</span>
<a href="#l3.1572"></a><span id="l3.1572" class="difflineplus">+               !PL_strcasecmp(fNextToken, &quot;RFC822.TEXT&quot;) ||</span>
<a href="#l3.1573"></a><span id="l3.1573" class="difflineplus">+               (!PL_strncasecmp(fNextToken, &quot;BODY[&quot;, 5) &amp;&amp;</span>
<a href="#l3.1574"></a><span id="l3.1574" class="difflineplus">+                PL_strstr(fNextToken, &quot;HEADER&quot;))) {</span>
<a href="#l3.1575"></a><span id="l3.1575">       if (fCurrentResponseUID == 0)</span>
<a href="#l3.1576"></a><span id="l3.1576" class="difflineminus">-        fFlagState-&gt;GetUidOfMessage(fFetchResponseIndex - 1, &amp;fCurrentResponseUID);</span>
<a href="#l3.1577"></a><span id="l3.1577" class="difflineplus">+        fFlagState-&gt;GetUidOfMessage(fFetchResponseIndex - 1,</span>
<a href="#l3.1578"></a><span id="l3.1578" class="difflineplus">+                                    &amp;fCurrentResponseUID);</span>
<a href="#l3.1579"></a><span id="l3.1579"> </span>
<a href="#l3.1580"></a><span id="l3.1580">       if (!PL_strcasecmp(fNextToken, &quot;RFC822.HEADER&quot;) ||</span>
<a href="#l3.1581"></a><span id="l3.1581" class="difflineminus">-        !PL_strcasecmp(fNextToken, &quot;BODY[HEADER]&quot;))</span>
<a href="#l3.1582"></a><span id="l3.1582" class="difflineminus">-      {</span>
<a href="#l3.1583"></a><span id="l3.1583" class="difflineplus">+          !PL_strcasecmp(fNextToken, &quot;BODY[HEADER]&quot;)) {</span>
<a href="#l3.1584"></a><span id="l3.1584">         // all of this message's headers</span>
<a href="#l3.1585"></a><span id="l3.1585">         AdvanceToNextToken();</span>
<a href="#l3.1586"></a><span id="l3.1586">         fDownloadingHeaders = true;</span>
<a href="#l3.1587"></a><span id="l3.1587" class="difflineminus">-        BeginMessageDownload(MESSAGE_RFC822); // initialize header parser</span>
<a href="#l3.1588"></a><span id="l3.1588" class="difflineplus">+        BeginMessageDownload(MESSAGE_RFC822);  // initialize header parser</span>
<a href="#l3.1589"></a><span id="l3.1589">         bNeedEndMessageDownload = false;</span>
<a href="#l3.1590"></a><span id="l3.1590" class="difflineminus">-        if (ContinueParse())</span>
<a href="#l3.1591"></a><span id="l3.1591" class="difflineminus">-          msg_fetch_headers(nullptr);</span>
<a href="#l3.1592"></a><span id="l3.1592" class="difflineminus">-      }</span>
<a href="#l3.1593"></a><span id="l3.1593" class="difflineminus">-      else if (!PL_strncasecmp(fNextToken, &quot;BODY[HEADER.FIELDS&quot;,19))</span>
<a href="#l3.1594"></a><span id="l3.1594" class="difflineminus">-      {</span>
<a href="#l3.1595"></a><span id="l3.1595" class="difflineplus">+        if (ContinueParse()) msg_fetch_headers(nullptr);</span>
<a href="#l3.1596"></a><span id="l3.1596" class="difflineplus">+      } else if (!PL_strncasecmp(fNextToken, &quot;BODY[HEADER.FIELDS&quot;, 19)) {</span>
<a href="#l3.1597"></a><span id="l3.1597">         fDownloadingHeaders = true;</span>
<a href="#l3.1598"></a><span id="l3.1598" class="difflineminus">-        BeginMessageDownload(MESSAGE_RFC822); // initialize header parser</span>
<a href="#l3.1599"></a><span id="l3.1599" class="difflineplus">+        BeginMessageDownload(MESSAGE_RFC822);  // initialize header parser</span>
<a href="#l3.1600"></a><span id="l3.1600">         // specific message header fields</span>
<a href="#l3.1601"></a><span id="l3.1601" class="difflineminus">-        while (ContinueParse() &amp;&amp; fNextToken[strlen(fNextToken)-1] != ']')</span>
<a href="#l3.1602"></a><span id="l3.1602" class="difflineplus">+        while (ContinueParse() &amp;&amp; fNextToken[strlen(fNextToken) - 1] != ']')</span>
<a href="#l3.1603"></a><span id="l3.1603">           AdvanceToNextToken();</span>
<a href="#l3.1604"></a><span id="l3.1604" class="difflineminus">-        if (ContinueParse())</span>
<a href="#l3.1605"></a><span id="l3.1605" class="difflineminus">-        {</span>
<a href="#l3.1606"></a><span id="l3.1606" class="difflineplus">+        if (ContinueParse()) {</span>
<a href="#l3.1607"></a><span id="l3.1607">           bNeedEndMessageDownload = false;</span>
<a href="#l3.1608"></a><span id="l3.1608">           AdvanceToNextToken();</span>
<a href="#l3.1609"></a><span id="l3.1609" class="difflineminus">-          if (ContinueParse())</span>
<a href="#l3.1610"></a><span id="l3.1610" class="difflineminus">-            msg_fetch_headers(nullptr);</span>
<a href="#l3.1611"></a><span id="l3.1611" class="difflineplus">+          if (ContinueParse()) msg_fetch_headers(nullptr);</span>
<a href="#l3.1612"></a><span id="l3.1612">         }</span>
<a href="#l3.1613"></a><span id="l3.1613" class="difflineminus">-      }</span>
<a href="#l3.1614"></a><span id="l3.1614" class="difflineminus">-      else</span>
<a href="#l3.1615"></a><span id="l3.1615" class="difflineminus">-      {</span>
<a href="#l3.1616"></a><span id="l3.1616" class="difflineplus">+      } else {</span>
<a href="#l3.1617"></a><span id="l3.1617">         char *whereHeader = PL_strstr(fNextToken, &quot;HEADER&quot;);</span>
<a href="#l3.1618"></a><span id="l3.1618" class="difflineminus">-        if (whereHeader)</span>
<a href="#l3.1619"></a><span id="l3.1619" class="difflineminus">-        {</span>
<a href="#l3.1620"></a><span id="l3.1620" class="difflineplus">+        if (whereHeader) {</span>
<a href="#l3.1621"></a><span id="l3.1621">           const char *startPartNum = fNextToken + 5;</span>
<a href="#l3.1622"></a><span id="l3.1622" class="difflineminus">-          if (whereHeader &gt; startPartNum)</span>
<a href="#l3.1623"></a><span id="l3.1623" class="difflineminus">-          {</span>
<a href="#l3.1624"></a><span id="l3.1624" class="difflineminus">-            int32_t partLength = whereHeader - startPartNum - 1; //-1 for the dot!</span>
<a href="#l3.1625"></a><span id="l3.1625" class="difflineminus">-            char *partNum = (char *)PR_CALLOC((partLength + 1) * sizeof (char));</span>
<a href="#l3.1626"></a><span id="l3.1626" class="difflineminus">-            if (partNum)</span>
<a href="#l3.1627"></a><span id="l3.1627" class="difflineminus">-            {</span>
<a href="#l3.1628"></a><span id="l3.1628" class="difflineplus">+          if (whereHeader &gt; startPartNum) {</span>
<a href="#l3.1629"></a><span id="l3.1629" class="difflineplus">+            int32_t partLength =</span>
<a href="#l3.1630"></a><span id="l3.1630" class="difflineplus">+                whereHeader - startPartNum - 1;  //-1 for the dot!</span>
<a href="#l3.1631"></a><span id="l3.1631" class="difflineplus">+            char *partNum = (char *)PR_CALLOC((partLength + 1) * sizeof(char));</span>
<a href="#l3.1632"></a><span id="l3.1632" class="difflineplus">+            if (partNum) {</span>
<a href="#l3.1633"></a><span id="l3.1633">               PL_strncpy(partNum, startPartNum, partLength);</span>
<a href="#l3.1634"></a><span id="l3.1634" class="difflineminus">-              if (ContinueParse())</span>
<a href="#l3.1635"></a><span id="l3.1635" class="difflineminus">-              {</span>
<a href="#l3.1636"></a><span id="l3.1636" class="difflineminus">-                if (PL_strstr(fNextToken, &quot;FIELDS&quot;))</span>
<a href="#l3.1637"></a><span id="l3.1637" class="difflineminus">-                {</span>
<a href="#l3.1638"></a><span id="l3.1638" class="difflineminus">-                  while (ContinueParse() &amp;&amp; fNextToken[strlen(fNextToken)-1] != ']')</span>
<a href="#l3.1639"></a><span id="l3.1639" class="difflineplus">+              if (ContinueParse()) {</span>
<a href="#l3.1640"></a><span id="l3.1640" class="difflineplus">+                if (PL_strstr(fNextToken, &quot;FIELDS&quot;)) {</span>
<a href="#l3.1641"></a><span id="l3.1641" class="difflineplus">+                  while (ContinueParse() &amp;&amp;</span>
<a href="#l3.1642"></a><span id="l3.1642" class="difflineplus">+                         fNextToken[strlen(fNextToken) - 1] != ']')</span>
<a href="#l3.1643"></a><span id="l3.1643">                     AdvanceToNextToken();</span>
<a href="#l3.1644"></a><span id="l3.1644">                 }</span>
<a href="#l3.1645"></a><span id="l3.1645" class="difflineminus">-                if (ContinueParse())</span>
<a href="#l3.1646"></a><span id="l3.1646" class="difflineminus">-                {</span>
<a href="#l3.1647"></a><span id="l3.1647" class="difflineplus">+                if (ContinueParse()) {</span>
<a href="#l3.1648"></a><span id="l3.1648">                   AdvanceToNextToken();</span>
<a href="#l3.1649"></a><span id="l3.1649" class="difflineminus">-                  if (ContinueParse())</span>
<a href="#l3.1650"></a><span id="l3.1650" class="difflineminus">-                    msg_fetch_headers(partNum);</span>
<a href="#l3.1651"></a><span id="l3.1651" class="difflineplus">+                  if (ContinueParse()) msg_fetch_headers(partNum);</span>
<a href="#l3.1652"></a><span id="l3.1652">                 }</span>
<a href="#l3.1653"></a><span id="l3.1653">               }</span>
<a href="#l3.1654"></a><span id="l3.1654">               PR_Free(partNum);</span>
<a href="#l3.1655"></a><span id="l3.1655">             }</span>
<a href="#l3.1656"></a><span id="l3.1656" class="difflineminus">-          }</span>
<a href="#l3.1657"></a><span id="l3.1657" class="difflineminus">-          else</span>
<a href="#l3.1658"></a><span id="l3.1658" class="difflineplus">+          } else</span>
<a href="#l3.1659"></a><span id="l3.1659">             SetSyntaxError(true);</span>
<a href="#l3.1660"></a><span id="l3.1660" class="difflineminus">-        }</span>
<a href="#l3.1661"></a><span id="l3.1661" class="difflineminus">-        else</span>
<a href="#l3.1662"></a><span id="l3.1662" class="difflineminus">-        {</span>
<a href="#l3.1663"></a><span id="l3.1663" class="difflineplus">+        } else {</span>
<a href="#l3.1664"></a><span id="l3.1664">           fDownloadingHeaders = false;</span>
<a href="#l3.1665"></a><span id="l3.1665"> </span>
<a href="#l3.1666"></a><span id="l3.1666">           bool chunk = false;</span>
<a href="#l3.1667"></a><span id="l3.1667">           int32_t origin = 0;</span>
<a href="#l3.1668"></a><span id="l3.1668" class="difflineminus">-          if (!PL_strncasecmp(fNextToken, &quot;BODY[]&lt;&quot;, 7))</span>
<a href="#l3.1669"></a><span id="l3.1669" class="difflineminus">-          {</span>
<a href="#l3.1670"></a><span id="l3.1670" class="difflineplus">+          if (!PL_strncasecmp(fNextToken, &quot;BODY[]&lt;&quot;, 7)) {</span>
<a href="#l3.1671"></a><span id="l3.1671">             char *tokenCopy = 0;</span>
<a href="#l3.1672"></a><span id="l3.1672">             tokenCopy = PL_strdup(fNextToken);</span>
<a href="#l3.1673"></a><span id="l3.1673" class="difflineminus">-            if (tokenCopy)</span>
<a href="#l3.1674"></a><span id="l3.1674" class="difflineminus">-            {</span>
<a href="#l3.1675"></a><span id="l3.1675" class="difflineminus">-              char *originString = tokenCopy + 7;  // where the byte number starts</span>
<a href="#l3.1676"></a><span id="l3.1676" class="difflineminus">-              char *closeBracket = PL_strchr(tokenCopy,'&gt;');</span>
<a href="#l3.1677"></a><span id="l3.1677" class="difflineminus">-              if (closeBracket &amp;&amp; originString &amp;&amp; *originString)</span>
<a href="#l3.1678"></a><span id="l3.1678" class="difflineminus">-              {</span>
<a href="#l3.1679"></a><span id="l3.1679" class="difflineplus">+            if (tokenCopy) {</span>
<a href="#l3.1680"></a><span id="l3.1680" class="difflineplus">+              char *originString =</span>
<a href="#l3.1681"></a><span id="l3.1681" class="difflineplus">+                  tokenCopy + 7;  // where the byte number starts</span>
<a href="#l3.1682"></a><span id="l3.1682" class="difflineplus">+              char *closeBracket = PL_strchr(tokenCopy, '&gt;');</span>
<a href="#l3.1683"></a><span id="l3.1683" class="difflineplus">+              if (closeBracket &amp;&amp; originString &amp;&amp; *originString) {</span>
<a href="#l3.1684"></a><span id="l3.1684">                 *closeBracket = 0;</span>
<a href="#l3.1685"></a><span id="l3.1685">                 origin = atoi(originString);</span>
<a href="#l3.1686"></a><span id="l3.1686">                 chunk = true;</span>
<a href="#l3.1687"></a><span id="l3.1687">               }</span>
<a href="#l3.1688"></a><span id="l3.1688">               PR_Free(tokenCopy);</span>
<a href="#l3.1689"></a><span id="l3.1689">             }</span>
<a href="#l3.1690"></a><span id="l3.1690">           }</span>
<a href="#l3.1691"></a><span id="l3.1691"> </span>
<a href="#l3.1692"></a><span id="l3.1692">           AdvanceToNextToken();</span>
<a href="#l3.1693"></a><span id="l3.1693" class="difflineminus">-          if (ContinueParse())</span>
<a href="#l3.1694"></a><span id="l3.1694" class="difflineminus">-          {</span>
<a href="#l3.1695"></a><span id="l3.1695" class="difflineplus">+          if (ContinueParse()) {</span>
<a href="#l3.1696"></a><span id="l3.1696">             msg_fetch_content(chunk, origin, MESSAGE_RFC822);</span>
<a href="#l3.1697"></a><span id="l3.1697">           }</span>
<a href="#l3.1698"></a><span id="l3.1698">         }</span>
<a href="#l3.1699"></a><span id="l3.1699">       }</span>
<a href="#l3.1700"></a><span id="l3.1700" class="difflineminus">-      }</span>
<a href="#l3.1701"></a><span id="l3.1701" class="difflineminus">-      else if (!PL_strcasecmp(fNextToken, &quot;RFC822.SIZE&quot;) || !PL_strcasecmp(fNextToken, &quot;XAOL.SIZE&quot;))</span>
<a href="#l3.1702"></a><span id="l3.1702" class="difflineminus">-      {</span>
<a href="#l3.1703"></a><span id="l3.1703" class="difflineminus">-        AdvanceToNextToken();</span>
<a href="#l3.1704"></a><span id="l3.1704" class="difflineminus">-        if (ContinueParse())</span>
<a href="#l3.1705"></a><span id="l3.1705" class="difflineminus">-        {</span>
<a href="#l3.1706"></a><span id="l3.1706" class="difflineminus">-          bool sendEndMsgDownload = (GetDownloadingHeaders()</span>
<a href="#l3.1707"></a><span id="l3.1707" class="difflineminus">-                                        &amp;&amp; fReceivedHeaderOrSizeForUID == CurrentResponseUID());</span>
<a href="#l3.1708"></a><span id="l3.1708" class="difflineminus">-          fSizeOfMostRecentMessage = strtoul(fNextToken, nullptr, 10);</span>
<a href="#l3.1709"></a><span id="l3.1709" class="difflineminus">-          fReceivedHeaderOrSizeForUID = CurrentResponseUID();</span>
<a href="#l3.1710"></a><span id="l3.1710" class="difflineminus">-          if (sendEndMsgDownload)</span>
<a href="#l3.1711"></a><span id="l3.1711" class="difflineminus">-          {</span>
<a href="#l3.1712"></a><span id="l3.1712" class="difflineminus">-            fServerConnection.NormalMessageEndDownload();</span>
<a href="#l3.1713"></a><span id="l3.1713" class="difflineminus">-            fReceivedHeaderOrSizeForUID = nsMsgKey_None;</span>
<a href="#l3.1714"></a><span id="l3.1714" class="difflineminus">-          }</span>
<a href="#l3.1715"></a><span id="l3.1715" class="difflineplus">+    } else if (!PL_strcasecmp(fNextToken, &quot;RFC822.SIZE&quot;) ||</span>
<a href="#l3.1716"></a><span id="l3.1716" class="difflineplus">+               !PL_strcasecmp(fNextToken, &quot;XAOL.SIZE&quot;)) {</span>
<a href="#l3.1717"></a><span id="l3.1717" class="difflineplus">+      AdvanceToNextToken();</span>
<a href="#l3.1718"></a><span id="l3.1718" class="difflineplus">+      if (ContinueParse()) {</span>
<a href="#l3.1719"></a><span id="l3.1719" class="difflineplus">+        bool sendEndMsgDownload =</span>
<a href="#l3.1720"></a><span id="l3.1720" class="difflineplus">+            (GetDownloadingHeaders() &amp;&amp;</span>
<a href="#l3.1721"></a><span id="l3.1721" class="difflineplus">+             fReceivedHeaderOrSizeForUID == CurrentResponseUID());</span>
<a href="#l3.1722"></a><span id="l3.1722" class="difflineplus">+        fSizeOfMostRecentMessage = strtoul(fNextToken, nullptr, 10);</span>
<a href="#l3.1723"></a><span id="l3.1723" class="difflineplus">+        fReceivedHeaderOrSizeForUID = CurrentResponseUID();</span>
<a href="#l3.1724"></a><span id="l3.1724" class="difflineplus">+        if (sendEndMsgDownload) {</span>
<a href="#l3.1725"></a><span id="l3.1725" class="difflineplus">+          fServerConnection.NormalMessageEndDownload();</span>
<a href="#l3.1726"></a><span id="l3.1726" class="difflineplus">+          fReceivedHeaderOrSizeForUID = nsMsgKey_None;</span>
<a href="#l3.1727"></a><span id="l3.1727" class="difflineplus">+        }</span>
<a href="#l3.1728"></a><span id="l3.1728"> </span>
<a href="#l3.1729"></a><span id="l3.1729" class="difflineminus">-          if (fSizeOfMostRecentMessage == 0 &amp;&amp; CurrentResponseUID())</span>
<a href="#l3.1730"></a><span id="l3.1730" class="difflineminus">-          {</span>
<a href="#l3.1731"></a><span id="l3.1731" class="difflineminus">-            // on no, bogus Netscape 2.0 mail server bug</span>
<a href="#l3.1732"></a><span id="l3.1732" class="difflineminus">-            char uidString[100];</span>
<a href="#l3.1733"></a><span id="l3.1733" class="difflineminus">-            sprintf(uidString, &quot;%ld&quot;, (long)CurrentResponseUID());</span>
<a href="#l3.1734"></a><span id="l3.1734" class="difflineplus">+        if (fSizeOfMostRecentMessage == 0 &amp;&amp; CurrentResponseUID()) {</span>
<a href="#l3.1735"></a><span id="l3.1735" class="difflineplus">+          // on no, bogus Netscape 2.0 mail server bug</span>
<a href="#l3.1736"></a><span id="l3.1736" class="difflineplus">+          char uidString[100];</span>
<a href="#l3.1737"></a><span id="l3.1737" class="difflineplus">+          sprintf(uidString, &quot;%ld&quot;, (long)CurrentResponseUID());</span>
<a href="#l3.1738"></a><span id="l3.1738" class="difflineplus">+</span>
<a href="#l3.1739"></a><span id="l3.1739" class="difflineplus">+          if (!fZeroLengthMessageUidString.IsEmpty())</span>
<a href="#l3.1740"></a><span id="l3.1740" class="difflineplus">+            fZeroLengthMessageUidString += &quot;,&quot;;</span>
<a href="#l3.1741"></a><span id="l3.1741" class="difflineplus">+</span>
<a href="#l3.1742"></a><span id="l3.1742" class="difflineplus">+          fZeroLengthMessageUidString += uidString;</span>
<a href="#l3.1743"></a><span id="l3.1743" class="difflineplus">+        }</span>
<a href="#l3.1744"></a><span id="l3.1744"> </span>
<a href="#l3.1745"></a><span id="l3.1745" class="difflineminus">-            if (!fZeroLengthMessageUidString.IsEmpty())</span>
<a href="#l3.1746"></a><span id="l3.1746" class="difflineminus">-              fZeroLengthMessageUidString += &quot;,&quot;;</span>
<a href="#l3.1747"></a><span id="l3.1747" class="difflineminus">-</span>
<a href="#l3.1748"></a><span id="l3.1748" class="difflineminus">-            fZeroLengthMessageUidString += uidString;</span>
<a href="#l3.1749"></a><span id="l3.1749" class="difflineminus">-          }</span>
<a href="#l3.1750"></a><span id="l3.1750" class="difflineplus">+        // if this token ends in ')', then it is the last token</span>
<a href="#l3.1751"></a><span id="l3.1751" class="difflineplus">+        // else we advance</span>
<a href="#l3.1752"></a><span id="l3.1752" class="difflineplus">+        if (*(fNextToken + strlen(fNextToken) - 1) == ')')</span>
<a href="#l3.1753"></a><span id="l3.1753" class="difflineplus">+          fNextToken += strlen(fNextToken) - 1;</span>
<a href="#l3.1754"></a><span id="l3.1754" class="difflineplus">+        else</span>
<a href="#l3.1755"></a><span id="l3.1755" class="difflineplus">+          AdvanceToNextToken();</span>
<a href="#l3.1756"></a><span id="l3.1756" class="difflineplus">+      }</span>
<a href="#l3.1757"></a><span id="l3.1757" class="difflineplus">+    } else if (!PL_strcasecmp(fNextToken, &quot;XSENDER&quot;)) {</span>
<a href="#l3.1758"></a><span id="l3.1758" class="difflineplus">+      PR_FREEIF(fXSenderInfo);</span>
<a href="#l3.1759"></a><span id="l3.1759" class="difflineplus">+      AdvanceToNextToken();</span>
<a href="#l3.1760"></a><span id="l3.1760" class="difflineplus">+      if (!fNextToken)</span>
<a href="#l3.1761"></a><span id="l3.1761" class="difflineplus">+        SetSyntaxError(true);</span>
<a href="#l3.1762"></a><span id="l3.1762" class="difflineplus">+      else {</span>
<a href="#l3.1763"></a><span id="l3.1763" class="difflineplus">+        fXSenderInfo = CreateAstring();</span>
<a href="#l3.1764"></a><span id="l3.1764" class="difflineplus">+        AdvanceToNextToken();</span>
<a href="#l3.1765"></a><span id="l3.1765" class="difflineplus">+      }</span>
<a href="#l3.1766"></a><span id="l3.1766" class="difflineplus">+    } else if (!PL_strcasecmp(fNextToken, &quot;X-GM-MSGID&quot;)) {</span>
<a href="#l3.1767"></a><span id="l3.1767" class="difflineplus">+      AdvanceToNextToken();</span>
<a href="#l3.1768"></a><span id="l3.1768" class="difflineplus">+      if (!fNextToken)</span>
<a href="#l3.1769"></a><span id="l3.1769" class="difflineplus">+        SetSyntaxError(true);</span>
<a href="#l3.1770"></a><span id="l3.1770" class="difflineplus">+      else {</span>
<a href="#l3.1771"></a><span id="l3.1771" class="difflineplus">+        fMsgID = CreateAtom();</span>
<a href="#l3.1772"></a><span id="l3.1772" class="difflineplus">+        AdvanceToNextToken();</span>
<a href="#l3.1773"></a><span id="l3.1773" class="difflineplus">+        nsCString msgIDValue;</span>
<a href="#l3.1774"></a><span id="l3.1774" class="difflineplus">+        msgIDValue.Assign(fMsgID);</span>
<a href="#l3.1775"></a><span id="l3.1775" class="difflineplus">+        if (fCurrentResponseUID == 0)</span>
<a href="#l3.1776"></a><span id="l3.1776" class="difflineplus">+          fFlagState-&gt;GetUidOfMessage(fFetchResponseIndex - 1,</span>
<a href="#l3.1777"></a><span id="l3.1777" class="difflineplus">+                                      &amp;fCurrentResponseUID);</span>
<a href="#l3.1778"></a><span id="l3.1778" class="difflineplus">+        fFlagState-&gt;SetCustomAttribute(</span>
<a href="#l3.1779"></a><span id="l3.1779" class="difflineplus">+            fCurrentResponseUID, NS_LITERAL_CSTRING(&quot;X-GM-MSGID&quot;), msgIDValue);</span>
<a href="#l3.1780"></a><span id="l3.1780" class="difflineplus">+        PR_FREEIF(fMsgID);</span>
<a href="#l3.1781"></a><span id="l3.1781" class="difflineplus">+      }</span>
<a href="#l3.1782"></a><span id="l3.1782" class="difflineplus">+    } else if (!PL_strcasecmp(fNextToken, &quot;X-GM-THRID&quot;)) {</span>
<a href="#l3.1783"></a><span id="l3.1783" class="difflineplus">+      AdvanceToNextToken();</span>
<a href="#l3.1784"></a><span id="l3.1784" class="difflineplus">+      if (!fNextToken)</span>
<a href="#l3.1785"></a><span id="l3.1785" class="difflineplus">+        SetSyntaxError(true);</span>
<a href="#l3.1786"></a><span id="l3.1786" class="difflineplus">+      else {</span>
<a href="#l3.1787"></a><span id="l3.1787" class="difflineplus">+        fThreadID = CreateAtom();</span>
<a href="#l3.1788"></a><span id="l3.1788" class="difflineplus">+        AdvanceToNextToken();</span>
<a href="#l3.1789"></a><span id="l3.1789" class="difflineplus">+        nsCString threadIDValue;</span>
<a href="#l3.1790"></a><span id="l3.1790" class="difflineplus">+        threadIDValue.Assign(fThreadID);</span>
<a href="#l3.1791"></a><span id="l3.1791" class="difflineplus">+        if (fCurrentResponseUID == 0)</span>
<a href="#l3.1792"></a><span id="l3.1792" class="difflineplus">+          fFlagState-&gt;GetUidOfMessage(fFetchResponseIndex - 1,</span>
<a href="#l3.1793"></a><span id="l3.1793" class="difflineplus">+                                      &amp;fCurrentResponseUID);</span>
<a href="#l3.1794"></a><span id="l3.1794" class="difflineplus">+        fFlagState-&gt;SetCustomAttribute(fCurrentResponseUID,</span>
<a href="#l3.1795"></a><span id="l3.1795" class="difflineplus">+                                       NS_LITERAL_CSTRING(&quot;X-GM-THRID&quot;),</span>
<a href="#l3.1796"></a><span id="l3.1796" class="difflineplus">+                                       threadIDValue);</span>
<a href="#l3.1797"></a><span id="l3.1797" class="difflineplus">+        PR_FREEIF(fThreadID);</span>
<a href="#l3.1798"></a><span id="l3.1798" class="difflineplus">+      }</span>
<a href="#l3.1799"></a><span id="l3.1799" class="difflineplus">+    } else if (!PL_strcasecmp(fNextToken, &quot;X-GM-LABELS&quot;)) {</span>
<a href="#l3.1800"></a><span id="l3.1800" class="difflineplus">+      AdvanceToNextToken();</span>
<a href="#l3.1801"></a><span id="l3.1801" class="difflineplus">+      if (!fNextToken)</span>
<a href="#l3.1802"></a><span id="l3.1802" class="difflineplus">+        SetSyntaxError(true);</span>
<a href="#l3.1803"></a><span id="l3.1803" class="difflineplus">+      else {</span>
<a href="#l3.1804"></a><span id="l3.1804" class="difflineplus">+        fLabels = CreateParenGroup();</span>
<a href="#l3.1805"></a><span id="l3.1805" class="difflineplus">+        nsCString labelsValue;</span>
<a href="#l3.1806"></a><span id="l3.1806" class="difflineplus">+        labelsValue.Assign(fLabels);</span>
<a href="#l3.1807"></a><span id="l3.1807" class="difflineplus">+        labelsValue.Cut(0, 1);</span>
<a href="#l3.1808"></a><span id="l3.1808" class="difflineplus">+        labelsValue.Cut(labelsValue.Length() - 1, 1);</span>
<a href="#l3.1809"></a><span id="l3.1809" class="difflineplus">+        if (fCurrentResponseUID == 0)</span>
<a href="#l3.1810"></a><span id="l3.1810" class="difflineplus">+          fFlagState-&gt;GetUidOfMessage(fFetchResponseIndex - 1,</span>
<a href="#l3.1811"></a><span id="l3.1811" class="difflineplus">+                                      &amp;fCurrentResponseUID);</span>
<a href="#l3.1812"></a><span id="l3.1812" class="difflineplus">+        fFlagState-&gt;SetCustomAttribute(fCurrentResponseUID,</span>
<a href="#l3.1813"></a><span id="l3.1813" class="difflineplus">+                                       NS_LITERAL_CSTRING(&quot;X-GM-LABELS&quot;),</span>
<a href="#l3.1814"></a><span id="l3.1814" class="difflineplus">+                                       labelsValue);</span>
<a href="#l3.1815"></a><span id="l3.1815" class="difflineplus">+        PR_FREEIF(fLabels);</span>
<a href="#l3.1816"></a><span id="l3.1816" class="difflineplus">+      }</span>
<a href="#l3.1817"></a><span id="l3.1817" class="difflineplus">+    }</span>
<a href="#l3.1818"></a><span id="l3.1818"> </span>
<a href="#l3.1819"></a><span id="l3.1819" class="difflineminus">-          // if this token ends in ')', then it is the last token</span>
<a href="#l3.1820"></a><span id="l3.1820" class="difflineminus">-          // else we advance</span>
<a href="#l3.1821"></a><span id="l3.1821" class="difflineminus">-          if ( *(fNextToken + strlen(fNextToken) - 1) == ')')</span>
<a href="#l3.1822"></a><span id="l3.1822" class="difflineminus">-            fNextToken += strlen(fNextToken) - 1;</span>
<a href="#l3.1823"></a><span id="l3.1823" class="difflineminus">-          else</span>
<a href="#l3.1824"></a><span id="l3.1824" class="difflineminus">-            AdvanceToNextToken();</span>
<a href="#l3.1825"></a><span id="l3.1825" class="difflineminus">-        }</span>
<a href="#l3.1826"></a><span id="l3.1826" class="difflineminus">-      }</span>
<a href="#l3.1827"></a><span id="l3.1827" class="difflineminus">-      else if (!PL_strcasecmp(fNextToken, &quot;XSENDER&quot;))</span>
<a href="#l3.1828"></a><span id="l3.1828" class="difflineminus">-      {</span>
<a href="#l3.1829"></a><span id="l3.1829" class="difflineminus">-        PR_FREEIF(fXSenderInfo);</span>
<a href="#l3.1830"></a><span id="l3.1830" class="difflineplus">+    // I only fetch RFC822 so I should never see these BODY responses</span>
<a href="#l3.1831"></a><span id="l3.1831" class="difflineplus">+    else if (!PL_strcasecmp(fNextToken, &quot;BODY&quot;))</span>
<a href="#l3.1832"></a><span id="l3.1832" class="difflineplus">+      skip_to_CRLF();  // I never ask for this</span>
<a href="#l3.1833"></a><span id="l3.1833" class="difflineplus">+    else if (!PL_strcasecmp(fNextToken, &quot;BODYSTRUCTURE&quot;)) {</span>
<a href="#l3.1834"></a><span id="l3.1834" class="difflineplus">+      if (fCurrentResponseUID == 0)</span>
<a href="#l3.1835"></a><span id="l3.1835" class="difflineplus">+        fFlagState-&gt;GetUidOfMessage(fFetchResponseIndex - 1,</span>
<a href="#l3.1836"></a><span id="l3.1836" class="difflineplus">+                                    &amp;fCurrentResponseUID);</span>
<a href="#l3.1837"></a><span id="l3.1837" class="difflineplus">+      bodystructure_data();</span>
<a href="#l3.1838"></a><span id="l3.1838" class="difflineplus">+    } else if (!PL_strncasecmp(fNextToken, &quot;BODY[TEXT&quot;, 9)) {</span>
<a href="#l3.1839"></a><span id="l3.1839" class="difflineplus">+      mime_data();</span>
<a href="#l3.1840"></a><span id="l3.1840" class="difflineplus">+    } else if (!PL_strncasecmp(fNextToken, &quot;BODY[&quot;, 5) &amp;&amp;</span>
<a href="#l3.1841"></a><span id="l3.1841" class="difflineplus">+               PL_strncasecmp(fNextToken, &quot;BODY[]&quot;, 6)) {</span>
<a href="#l3.1842"></a><span id="l3.1842" class="difflineplus">+      fDownloadingHeaders = false;</span>
<a href="#l3.1843"></a><span id="l3.1843" class="difflineplus">+      // A specific MIME part, or MIME part header</span>
<a href="#l3.1844"></a><span id="l3.1844" class="difflineplus">+      mime_data();</span>
<a href="#l3.1845"></a><span id="l3.1845" class="difflineplus">+    } else if (!PL_strcasecmp(fNextToken, &quot;ENVELOPE&quot;)) {</span>
<a href="#l3.1846"></a><span id="l3.1846" class="difflineplus">+      fDownloadingHeaders = true;</span>
<a href="#l3.1847"></a><span id="l3.1847" class="difflineplus">+      bNeedEndMessageDownload = true;</span>
<a href="#l3.1848"></a><span id="l3.1848" class="difflineplus">+      BeginMessageDownload(MESSAGE_RFC822);</span>
<a href="#l3.1849"></a><span id="l3.1849" class="difflineplus">+      envelope_data();</span>
<a href="#l3.1850"></a><span id="l3.1850" class="difflineplus">+    } else if (!PL_strcasecmp(fNextToken, &quot;INTERNALDATE&quot;)) {</span>
<a href="#l3.1851"></a><span id="l3.1851" class="difflineplus">+      fDownloadingHeaders =</span>
<a href="#l3.1852"></a><span id="l3.1852" class="difflineplus">+          true;  // we only request internal date while downloading headers</span>
<a href="#l3.1853"></a><span id="l3.1853" class="difflineplus">+      if (!bNeedEndMessageDownload) BeginMessageDownload(MESSAGE_RFC822);</span>
<a href="#l3.1854"></a><span id="l3.1854" class="difflineplus">+      bNeedEndMessageDownload = true;</span>
<a href="#l3.1855"></a><span id="l3.1855" class="difflineplus">+      internal_date();</span>
<a href="#l3.1856"></a><span id="l3.1856" class="difflineplus">+    } else if (!PL_strcasecmp(fNextToken, &quot;XAOL-ENVELOPE&quot;)) {</span>
<a href="#l3.1857"></a><span id="l3.1857" class="difflineplus">+      fDownloadingHeaders = true;</span>
<a href="#l3.1858"></a><span id="l3.1858" class="difflineplus">+      if (!bNeedEndMessageDownload) BeginMessageDownload(MESSAGE_RFC822);</span>
<a href="#l3.1859"></a><span id="l3.1859" class="difflineplus">+      bNeedEndMessageDownload = true;</span>
<a href="#l3.1860"></a><span id="l3.1860" class="difflineplus">+      xaolenvelope_data();</span>
<a href="#l3.1861"></a><span id="l3.1861" class="difflineplus">+    } else {</span>
<a href="#l3.1862"></a><span id="l3.1862" class="difflineplus">+      nsImapAction imapAction;</span>
<a href="#l3.1863"></a><span id="l3.1863" class="difflineplus">+      if (!fServerConnection.GetCurrentUrl()) return;</span>
<a href="#l3.1864"></a><span id="l3.1864" class="difflineplus">+      fServerConnection.GetCurrentUrl()-&gt;GetImapAction(&amp;imapAction);</span>
<a href="#l3.1865"></a><span id="l3.1865" class="difflineplus">+      nsAutoCString userDefinedFetchAttribute;</span>
<a href="#l3.1866"></a><span id="l3.1866" class="difflineplus">+      fServerConnection.GetCurrentUrl()-&gt;GetCustomAttributeToFetch(</span>
<a href="#l3.1867"></a><span id="l3.1867" class="difflineplus">+          userDefinedFetchAttribute);</span>
<a href="#l3.1868"></a><span id="l3.1868" class="difflineplus">+      if ((imapAction == nsIImapUrl::nsImapUserDefinedFetchAttribute &amp;&amp;</span>
<a href="#l3.1869"></a><span id="l3.1869" class="difflineplus">+           !strcmp(userDefinedFetchAttribute.get(), fNextToken)) ||</span>
<a href="#l3.1870"></a><span id="l3.1870" class="difflineplus">+          imapAction == nsIImapUrl::nsImapUserDefinedMsgCommand) {</span>
<a href="#l3.1871"></a><span id="l3.1871">         AdvanceToNextToken();</span>
<a href="#l3.1872"></a><span id="l3.1872" class="difflineminus">-        if (! fNextToken)</span>
<a href="#l3.1873"></a><span id="l3.1873" class="difflineminus">-          SetSyntaxError(true);</span>
<a href="#l3.1874"></a><span id="l3.1874" class="difflineminus">-        else</span>
<a href="#l3.1875"></a><span id="l3.1875" class="difflineminus">-        {</span>
<a href="#l3.1876"></a><span id="l3.1876" class="difflineminus">-          fXSenderInfo = CreateAstring();</span>
<a href="#l3.1877"></a><span id="l3.1877" class="difflineplus">+        char *fetchResult;</span>
<a href="#l3.1878"></a><span id="l3.1878" class="difflineplus">+        if (fNextToken[0] == '(')</span>
<a href="#l3.1879"></a><span id="l3.1879" class="difflineplus">+          // look through the tokens until we find the closing ')'</span>
<a href="#l3.1880"></a><span id="l3.1880" class="difflineplus">+          // we can have a result like the following:</span>
<a href="#l3.1881"></a><span id="l3.1881" class="difflineplus">+          // ((A B) (C D) (E F))</span>
<a href="#l3.1882"></a><span id="l3.1882" class="difflineplus">+          fetchResult = CreateParenGroup();</span>
<a href="#l3.1883"></a><span id="l3.1883" class="difflineplus">+        else {</span>
<a href="#l3.1884"></a><span id="l3.1884" class="difflineplus">+          fetchResult = CreateAstring();</span>
<a href="#l3.1885"></a><span id="l3.1885">           AdvanceToNextToken();</span>
<a href="#l3.1886"></a><span id="l3.1886">         }</span>
<a href="#l3.1887"></a><span id="l3.1887" class="difflineminus">-      }</span>
<a href="#l3.1888"></a><span id="l3.1888" class="difflineminus">-      else if (!PL_strcasecmp(fNextToken, &quot;X-GM-MSGID&quot;))</span>
<a href="#l3.1889"></a><span id="l3.1889" class="difflineminus">-      {</span>
<a href="#l3.1890"></a><span id="l3.1890" class="difflineminus">-        AdvanceToNextToken();</span>
<a href="#l3.1891"></a><span id="l3.1891" class="difflineminus">-        if (!fNextToken)</span>
<a href="#l3.1892"></a><span id="l3.1892" class="difflineminus">-          SetSyntaxError(true);</span>
<a href="#l3.1893"></a><span id="l3.1893" class="difflineminus">-        else</span>
<a href="#l3.1894"></a><span id="l3.1894" class="difflineminus">-        {</span>
<a href="#l3.1895"></a><span id="l3.1895" class="difflineminus">-          fMsgID = CreateAtom();</span>
<a href="#l3.1896"></a><span id="l3.1896" class="difflineminus">-          AdvanceToNextToken();</span>
<a href="#l3.1897"></a><span id="l3.1897" class="difflineminus">-          nsCString msgIDValue;</span>
<a href="#l3.1898"></a><span id="l3.1898" class="difflineminus">-          msgIDValue.Assign(fMsgID);</span>
<a href="#l3.1899"></a><span id="l3.1899" class="difflineminus">-          if (fCurrentResponseUID == 0)</span>
<a href="#l3.1900"></a><span id="l3.1900" class="difflineminus">-            fFlagState-&gt;GetUidOfMessage(fFetchResponseIndex - 1, &amp;fCurrentResponseUID);</span>
<a href="#l3.1901"></a><span id="l3.1901" class="difflineminus">-          fFlagState-&gt;SetCustomAttribute(fCurrentResponseUID,</span>
<a href="#l3.1902"></a><span id="l3.1902" class="difflineminus">-                                         NS_LITERAL_CSTRING(&quot;X-GM-MSGID&quot;), msgIDValue);</span>
<a href="#l3.1903"></a><span id="l3.1903" class="difflineminus">-          PR_FREEIF(fMsgID);</span>
<a href="#l3.1904"></a><span id="l3.1904" class="difflineminus">-        }</span>
<a href="#l3.1905"></a><span id="l3.1905" class="difflineminus">-      }</span>
<a href="#l3.1906"></a><span id="l3.1906" class="difflineminus">-      else if (!PL_strcasecmp(fNextToken, &quot;X-GM-THRID&quot;))</span>
<a href="#l3.1907"></a><span id="l3.1907" class="difflineminus">-      {</span>
<a href="#l3.1908"></a><span id="l3.1908" class="difflineminus">-        AdvanceToNextToken();</span>
<a href="#l3.1909"></a><span id="l3.1909" class="difflineminus">-        if (!fNextToken)</span>
<a href="#l3.1910"></a><span id="l3.1910" class="difflineminus">-          SetSyntaxError(true);</span>
<a href="#l3.1911"></a><span id="l3.1911" class="difflineminus">-        else</span>
<a href="#l3.1912"></a><span id="l3.1912" class="difflineminus">-        {</span>
<a href="#l3.1913"></a><span id="l3.1913" class="difflineminus">-          fThreadID = CreateAtom();</span>
<a href="#l3.1914"></a><span id="l3.1914" class="difflineminus">-          AdvanceToNextToken();</span>
<a href="#l3.1915"></a><span id="l3.1915" class="difflineminus">-          nsCString threadIDValue;</span>
<a href="#l3.1916"></a><span id="l3.1916" class="difflineminus">-          threadIDValue.Assign(fThreadID);</span>
<a href="#l3.1917"></a><span id="l3.1917" class="difflineminus">-          if (fCurrentResponseUID == 0)</span>
<a href="#l3.1918"></a><span id="l3.1918" class="difflineminus">-            fFlagState-&gt;GetUidOfMessage(fFetchResponseIndex - 1, &amp;fCurrentResponseUID);</span>
<a href="#l3.1919"></a><span id="l3.1919" class="difflineminus">-          fFlagState-&gt;SetCustomAttribute(fCurrentResponseUID,</span>
<a href="#l3.1920"></a><span id="l3.1920" class="difflineminus">-                                         NS_LITERAL_CSTRING(&quot;X-GM-THRID&quot;), threadIDValue);</span>
<a href="#l3.1921"></a><span id="l3.1921" class="difflineminus">-          PR_FREEIF(fThreadID);</span>
<a href="#l3.1922"></a><span id="l3.1922" class="difflineminus">-        }</span>
<a href="#l3.1923"></a><span id="l3.1923" class="difflineminus">-      }</span>
<a href="#l3.1924"></a><span id="l3.1924" class="difflineminus">-      else if (!PL_strcasecmp(fNextToken, &quot;X-GM-LABELS&quot;))</span>
<a href="#l3.1925"></a><span id="l3.1925" class="difflineminus">-      {</span>
<a href="#l3.1926"></a><span id="l3.1926" class="difflineminus">-        AdvanceToNextToken();</span>
<a href="#l3.1927"></a><span id="l3.1927" class="difflineminus">-        if (!fNextToken)</span>
<a href="#l3.1928"></a><span id="l3.1928" class="difflineminus">-          SetSyntaxError(true);</span>
<a href="#l3.1929"></a><span id="l3.1929" class="difflineminus">-        else</span>
<a href="#l3.1930"></a><span id="l3.1930" class="difflineminus">-        {</span>
<a href="#l3.1931"></a><span id="l3.1931" class="difflineminus">-          fLabels = CreateParenGroup();</span>
<a href="#l3.1932"></a><span id="l3.1932" class="difflineminus">-          nsCString labelsValue;</span>
<a href="#l3.1933"></a><span id="l3.1933" class="difflineminus">-          labelsValue.Assign(fLabels);</span>
<a href="#l3.1934"></a><span id="l3.1934" class="difflineminus">-          labelsValue.Cut(0, 1);</span>
<a href="#l3.1935"></a><span id="l3.1935" class="difflineminus">-          labelsValue.Cut(labelsValue.Length()-1, 1);</span>
<a href="#l3.1936"></a><span id="l3.1936" class="difflineminus">-          if (fCurrentResponseUID == 0)</span>
<a href="#l3.1937"></a><span id="l3.1937" class="difflineminus">-            fFlagState-&gt;GetUidOfMessage(fFetchResponseIndex - 1, &amp;fCurrentResponseUID);</span>
<a href="#l3.1938"></a><span id="l3.1938" class="difflineminus">-          fFlagState-&gt;SetCustomAttribute(fCurrentResponseUID,</span>
<a href="#l3.1939"></a><span id="l3.1939" class="difflineminus">-                                         NS_LITERAL_CSTRING(&quot;X-GM-LABELS&quot;), labelsValue);</span>
<a href="#l3.1940"></a><span id="l3.1940" class="difflineminus">-          PR_FREEIF(fLabels);</span>
<a href="#l3.1941"></a><span id="l3.1941" class="difflineminus">-        }</span>
<a href="#l3.1942"></a><span id="l3.1942" class="difflineminus">-      }</span>
<a href="#l3.1943"></a><span id="l3.1943" class="difflineplus">+        if (imapAction == nsIImapUrl::nsImapUserDefinedFetchAttribute)</span>
<a href="#l3.1944"></a><span id="l3.1944" class="difflineplus">+          fServerConnection.GetCurrentUrl()-&gt;SetCustomAttributeResult(</span>
<a href="#l3.1945"></a><span id="l3.1945" class="difflineplus">+              nsDependentCString(fetchResult));</span>
<a href="#l3.1946"></a><span id="l3.1946" class="difflineplus">+        if (imapAction == nsIImapUrl::nsImapUserDefinedMsgCommand)</span>
<a href="#l3.1947"></a><span id="l3.1947" class="difflineplus">+          fServerConnection.GetCurrentUrl()-&gt;SetCustomCommandResult(</span>
<a href="#l3.1948"></a><span id="l3.1948" class="difflineplus">+              nsDependentCString(fetchResult));</span>
<a href="#l3.1949"></a><span id="l3.1949" class="difflineplus">+        PR_Free(fetchResult);</span>
<a href="#l3.1950"></a><span id="l3.1950" class="difflineplus">+      } else</span>
<a href="#l3.1951"></a><span id="l3.1951" class="difflineplus">+        SetSyntaxError(true);</span>
<a href="#l3.1952"></a><span id="l3.1952" class="difflineplus">+    }</span>
<a href="#l3.1953"></a><span id="l3.1953" class="difflineplus">+  }</span>
<a href="#l3.1954"></a><span id="l3.1954"> </span>
<a href="#l3.1955"></a><span id="l3.1955" class="difflineminus">-      // I only fetch RFC822 so I should never see these BODY responses</span>
<a href="#l3.1956"></a><span id="l3.1956" class="difflineminus">-      else if (!PL_strcasecmp(fNextToken, &quot;BODY&quot;))</span>
<a href="#l3.1957"></a><span id="l3.1957" class="difflineminus">-        skip_to_CRLF(); // I never ask for this</span>
<a href="#l3.1958"></a><span id="l3.1958" class="difflineminus">-      else if (!PL_strcasecmp(fNextToken, &quot;BODYSTRUCTURE&quot;))</span>
<a href="#l3.1959"></a><span id="l3.1959" class="difflineminus">-      {</span>
<a href="#l3.1960"></a><span id="l3.1960" class="difflineminus">-        if (fCurrentResponseUID == 0)</span>
<a href="#l3.1961"></a><span id="l3.1961" class="difflineminus">-          fFlagState-&gt;GetUidOfMessage(fFetchResponseIndex - 1, &amp;fCurrentResponseUID);</span>
<a href="#l3.1962"></a><span id="l3.1962" class="difflineminus">-        bodystructure_data();</span>
<a href="#l3.1963"></a><span id="l3.1963" class="difflineminus">-      }</span>
<a href="#l3.1964"></a><span id="l3.1964" class="difflineminus">-      else if (!PL_strncasecmp(fNextToken, &quot;BODY[TEXT&quot;, 9))</span>
<a href="#l3.1965"></a><span id="l3.1965" class="difflineminus">-      {</span>
<a href="#l3.1966"></a><span id="l3.1966" class="difflineminus">-        mime_data();</span>
<a href="#l3.1967"></a><span id="l3.1967" class="difflineminus">-      }</span>
<a href="#l3.1968"></a><span id="l3.1968" class="difflineminus">-      else if (!PL_strncasecmp(fNextToken, &quot;BODY[&quot;, 5) &amp;&amp; PL_strncasecmp(fNextToken, &quot;BODY[]&quot;, 6))</span>
<a href="#l3.1969"></a><span id="l3.1969" class="difflineminus">-      {</span>
<a href="#l3.1970"></a><span id="l3.1970" class="difflineminus">-        fDownloadingHeaders = false;</span>
<a href="#l3.1971"></a><span id="l3.1971" class="difflineminus">-        // A specific MIME part, or MIME part header</span>
<a href="#l3.1972"></a><span id="l3.1972" class="difflineminus">-        mime_data();</span>
<a href="#l3.1973"></a><span id="l3.1973" class="difflineminus">-      }</span>
<a href="#l3.1974"></a><span id="l3.1974" class="difflineminus">-      else if (!PL_strcasecmp(fNextToken, &quot;ENVELOPE&quot;))</span>
<a href="#l3.1975"></a><span id="l3.1975" class="difflineminus">-      {</span>
<a href="#l3.1976"></a><span id="l3.1976" class="difflineminus">-        fDownloadingHeaders = true;</span>
<a href="#l3.1977"></a><span id="l3.1977" class="difflineminus">-        bNeedEndMessageDownload = true;</span>
<a href="#l3.1978"></a><span id="l3.1978" class="difflineminus">-        BeginMessageDownload(MESSAGE_RFC822);</span>
<a href="#l3.1979"></a><span id="l3.1979" class="difflineminus">-        envelope_data();</span>
<a href="#l3.1980"></a><span id="l3.1980" class="difflineminus">-      }</span>
<a href="#l3.1981"></a><span id="l3.1981" class="difflineminus">-      else if (!PL_strcasecmp(fNextToken, &quot;INTERNALDATE&quot;))</span>
<a href="#l3.1982"></a><span id="l3.1982" class="difflineminus">-      {</span>
<a href="#l3.1983"></a><span id="l3.1983" class="difflineminus">-        fDownloadingHeaders = true; // we only request internal date while downloading headers</span>
<a href="#l3.1984"></a><span id="l3.1984" class="difflineminus">-        if (!bNeedEndMessageDownload)</span>
<a href="#l3.1985"></a><span id="l3.1985" class="difflineminus">-          BeginMessageDownload(MESSAGE_RFC822);</span>
<a href="#l3.1986"></a><span id="l3.1986" class="difflineminus">-        bNeedEndMessageDownload = true;</span>
<a href="#l3.1987"></a><span id="l3.1987" class="difflineminus">-        internal_date();</span>
<a href="#l3.1988"></a><span id="l3.1988" class="difflineminus">-      }</span>
<a href="#l3.1989"></a><span id="l3.1989" class="difflineminus">-      else if (!PL_strcasecmp(fNextToken, &quot;XAOL-ENVELOPE&quot;))</span>
<a href="#l3.1990"></a><span id="l3.1990" class="difflineminus">-      {</span>
<a href="#l3.1991"></a><span id="l3.1991" class="difflineminus">-        fDownloadingHeaders = true;</span>
<a href="#l3.1992"></a><span id="l3.1992" class="difflineminus">-        if (!bNeedEndMessageDownload)</span>
<a href="#l3.1993"></a><span id="l3.1993" class="difflineminus">-          BeginMessageDownload(MESSAGE_RFC822);</span>
<a href="#l3.1994"></a><span id="l3.1994" class="difflineminus">-        bNeedEndMessageDownload = true;</span>
<a href="#l3.1995"></a><span id="l3.1995" class="difflineminus">-        xaolenvelope_data();</span>
<a href="#l3.1996"></a><span id="l3.1996" class="difflineminus">-      }</span>
<a href="#l3.1997"></a><span id="l3.1997" class="difflineminus">-      else</span>
<a href="#l3.1998"></a><span id="l3.1998" class="difflineminus">-      {</span>
<a href="#l3.1999"></a><span id="l3.1999" class="difflineminus">-        nsImapAction imapAction;</span>
<a href="#l3.2000"></a><span id="l3.2000" class="difflineminus">-        if (!fServerConnection.GetCurrentUrl())</span>
<a href="#l3.2001"></a><span id="l3.2001" class="difflineminus">-          return;</span>
<a href="#l3.2002"></a><span id="l3.2002" class="difflineminus">-        fServerConnection.GetCurrentUrl()-&gt;GetImapAction(&amp;imapAction);</span>
<a href="#l3.2003"></a><span id="l3.2003" class="difflineminus">-        nsAutoCString userDefinedFetchAttribute;</span>
<a href="#l3.2004"></a><span id="l3.2004" class="difflineminus">-        fServerConnection.GetCurrentUrl()-&gt;GetCustomAttributeToFetch(userDefinedFetchAttribute);</span>
<a href="#l3.2005"></a><span id="l3.2005" class="difflineminus">-        if ((imapAction == nsIImapUrl::nsImapUserDefinedFetchAttribute &amp;&amp; !strcmp(userDefinedFetchAttribute.get(), fNextToken)) ||</span>
<a href="#l3.2006"></a><span id="l3.2006" class="difflineminus">-            imapAction == nsIImapUrl::nsImapUserDefinedMsgCommand)</span>
<a href="#l3.2007"></a><span id="l3.2007" class="difflineminus">-        {</span>
<a href="#l3.2008"></a><span id="l3.2008" class="difflineminus">-          AdvanceToNextToken();</span>
<a href="#l3.2009"></a><span id="l3.2009" class="difflineminus">-          char *fetchResult;</span>
<a href="#l3.2010"></a><span id="l3.2010" class="difflineminus">-          if (fNextToken[0] == '(')</span>
<a href="#l3.2011"></a><span id="l3.2011" class="difflineminus">-            // look through the tokens until we find the closing ')'</span>
<a href="#l3.2012"></a><span id="l3.2012" class="difflineminus">-            // we can have a result like the following:</span>
<a href="#l3.2013"></a><span id="l3.2013" class="difflineminus">-            // ((A B) (C D) (E F))</span>
<a href="#l3.2014"></a><span id="l3.2014" class="difflineminus">-            fetchResult = CreateParenGroup();</span>
<a href="#l3.2015"></a><span id="l3.2015" class="difflineminus">-          else {</span>
<a href="#l3.2016"></a><span id="l3.2016" class="difflineminus">-            fetchResult = CreateAstring();</span>
<a href="#l3.2017"></a><span id="l3.2017" class="difflineminus">-            AdvanceToNextToken();</span>
<a href="#l3.2018"></a><span id="l3.2018" class="difflineminus">-          }</span>
<a href="#l3.2019"></a><span id="l3.2019" class="difflineminus">-          if (imapAction == nsIImapUrl::nsImapUserDefinedFetchAttribute)</span>
<a href="#l3.2020"></a><span id="l3.2020" class="difflineminus">-            fServerConnection.GetCurrentUrl()-&gt;SetCustomAttributeResult(nsDependentCString(fetchResult));</span>
<a href="#l3.2021"></a><span id="l3.2021" class="difflineminus">-          if (imapAction == nsIImapUrl::nsImapUserDefinedMsgCommand)</span>
<a href="#l3.2022"></a><span id="l3.2022" class="difflineminus">-            fServerConnection.GetCurrentUrl()-&gt;SetCustomCommandResult(nsDependentCString(fetchResult));</span>
<a href="#l3.2023"></a><span id="l3.2023" class="difflineminus">-          PR_Free(fetchResult);</span>
<a href="#l3.2024"></a><span id="l3.2024" class="difflineminus">-        }</span>
<a href="#l3.2025"></a><span id="l3.2025" class="difflineminus">-        else</span>
<a href="#l3.2026"></a><span id="l3.2026" class="difflineminus">-          SetSyntaxError(true);</span>
<a href="#l3.2027"></a><span id="l3.2027" class="difflineminus">-      }</span>
<a href="#l3.2028"></a><span id="l3.2028" class="difflineplus">+  if (ContinueParse()) {</span>
<a href="#l3.2029"></a><span id="l3.2029" class="difflineplus">+    if (CurrentResponseUID() &amp;&amp; CurrentResponseUID() != nsMsgKey_None &amp;&amp;</span>
<a href="#l3.2030"></a><span id="l3.2030" class="difflineplus">+        fCurrentLineContainedFlagInfo &amp;&amp; fFlagState) {</span>
<a href="#l3.2031"></a><span id="l3.2031" class="difflineplus">+      fFlagState-&gt;AddUidFlagPair(CurrentResponseUID(), fSavedFlagInfo,</span>
<a href="#l3.2032"></a><span id="l3.2032" class="difflineplus">+                                 fFetchResponseIndex - 1);</span>
<a href="#l3.2033"></a><span id="l3.2033" class="difflineplus">+      for (uint32_t i = 0; i &lt; fCustomFlags.Length(); i++)</span>
<a href="#l3.2034"></a><span id="l3.2034" class="difflineplus">+        fFlagState-&gt;AddUidCustomFlagPair(CurrentResponseUID(),</span>
<a href="#l3.2035"></a><span id="l3.2035" class="difflineplus">+                                         fCustomFlags[i].get());</span>
<a href="#l3.2036"></a><span id="l3.2036" class="difflineplus">+      fCustomFlags.Clear();</span>
<a href="#l3.2037"></a><span id="l3.2037" class="difflineplus">+    }</span>
<a href="#l3.2038"></a><span id="l3.2038"> </span>
<a href="#l3.2039"></a><span id="l3.2039" class="difflineminus">-        }</span>
<a href="#l3.2040"></a><span id="l3.2040" class="difflineminus">-</span>
<a href="#l3.2041"></a><span id="l3.2041" class="difflineminus">-        if (ContinueParse())</span>
<a href="#l3.2042"></a><span id="l3.2042" class="difflineminus">-        {</span>
<a href="#l3.2043"></a><span id="l3.2043" class="difflineminus">-          if (CurrentResponseUID() &amp;&amp; CurrentResponseUID() != nsMsgKey_None</span>
<a href="#l3.2044"></a><span id="l3.2044" class="difflineminus">-            &amp;&amp; fCurrentLineContainedFlagInfo &amp;&amp; fFlagState)</span>
<a href="#l3.2045"></a><span id="l3.2045" class="difflineminus">-          {</span>
<a href="#l3.2046"></a><span id="l3.2046" class="difflineminus">-            fFlagState-&gt;AddUidFlagPair(CurrentResponseUID(), fSavedFlagInfo, fFetchResponseIndex - 1);</span>
<a href="#l3.2047"></a><span id="l3.2047" class="difflineminus">-            for (uint32_t i = 0; i &lt; fCustomFlags.Length(); i++)</span>
<a href="#l3.2048"></a><span id="l3.2048" class="difflineminus">-              fFlagState-&gt;AddUidCustomFlagPair(CurrentResponseUID(), fCustomFlags[i].get());</span>
<a href="#l3.2049"></a><span id="l3.2049" class="difflineminus">-            fCustomFlags.Clear();</span>
<a href="#l3.2050"></a><span id="l3.2050" class="difflineminus">-          }</span>
<a href="#l3.2051"></a><span id="l3.2051" class="difflineplus">+    if (fFetchingAllFlags)</span>
<a href="#l3.2052"></a><span id="l3.2052" class="difflineplus">+      fCurrentLineContainedFlagInfo =</span>
<a href="#l3.2053"></a><span id="l3.2053" class="difflineplus">+          false;  // do not fire if in PostProcessEndOfLine</span>
<a href="#l3.2054"></a><span id="l3.2054"> </span>
<a href="#l3.2055"></a><span id="l3.2055" class="difflineminus">-          if (fFetchingAllFlags)</span>
<a href="#l3.2056"></a><span id="l3.2056" class="difflineminus">-            fCurrentLineContainedFlagInfo = false;  // do not fire if in PostProcessEndOfLine</span>
<a href="#l3.2057"></a><span id="l3.2057" class="difflineminus">-</span>
<a href="#l3.2058"></a><span id="l3.2058" class="difflineminus">-          AdvanceToNextToken(); // eat the ')' ending token</span>
<a href="#l3.2059"></a><span id="l3.2059" class="difflineminus">-          // should be at end of line</span>
<a href="#l3.2060"></a><span id="l3.2060" class="difflineminus">-          if (bNeedEndMessageDownload)</span>
<a href="#l3.2061"></a><span id="l3.2061" class="difflineminus">-          {</span>
<a href="#l3.2062"></a><span id="l3.2062" class="difflineminus">-            if (ContinueParse())</span>
<a href="#l3.2063"></a><span id="l3.2063" class="difflineminus">-            {</span>
<a href="#l3.2064"></a><span id="l3.2064" class="difflineminus">-              // complete the message download</span>
<a href="#l3.2065"></a><span id="l3.2065" class="difflineminus">-              fServerConnection.NormalMessageEndDownload();</span>
<a href="#l3.2066"></a><span id="l3.2066" class="difflineminus">-            }</span>
<a href="#l3.2067"></a><span id="l3.2067" class="difflineminus">-            else</span>
<a href="#l3.2068"></a><span id="l3.2068" class="difflineminus">-              fServerConnection.AbortMessageDownLoad();</span>
<a href="#l3.2069"></a><span id="l3.2069" class="difflineminus">-          }</span>
<a href="#l3.2070"></a><span id="l3.2070" class="difflineminus">-</span>
<a href="#l3.2071"></a><span id="l3.2071" class="difflineminus">-        }</span>
<a href="#l3.2072"></a><span id="l3.2072" class="difflineplus">+    AdvanceToNextToken();  // eat the ')' ending token</span>
<a href="#l3.2073"></a><span id="l3.2073" class="difflineplus">+    // should be at end of line</span>
<a href="#l3.2074"></a><span id="l3.2074" class="difflineplus">+    if (bNeedEndMessageDownload) {</span>
<a href="#l3.2075"></a><span id="l3.2075" class="difflineplus">+      if (ContinueParse()) {</span>
<a href="#l3.2076"></a><span id="l3.2076" class="difflineplus">+        // complete the message download</span>
<a href="#l3.2077"></a><span id="l3.2077" class="difflineplus">+        fServerConnection.NormalMessageEndDownload();</span>
<a href="#l3.2078"></a><span id="l3.2078" class="difflineplus">+      } else</span>
<a href="#l3.2079"></a><span id="l3.2079" class="difflineplus">+        fServerConnection.AbortMessageDownLoad();</span>
<a href="#l3.2080"></a><span id="l3.2080" class="difflineplus">+    }</span>
<a href="#l3.2081"></a><span id="l3.2081" class="difflineplus">+  }</span>
<a href="#l3.2082"></a><span id="l3.2082"> }</span>
<a href="#l3.2083"></a><span id="l3.2083"> </span>
<a href="#l3.2084"></a><span id="l3.2084" class="difflineminus">-typedef enum _envelopeItemType</span>
<a href="#l3.2085"></a><span id="l3.2085" class="difflineminus">-{</span>
<a href="#l3.2086"></a><span id="l3.2086" class="difflineplus">+typedef enum _envelopeItemType {</span>
<a href="#l3.2087"></a><span id="l3.2087">   envelopeString,</span>
<a href="#l3.2088"></a><span id="l3.2088">   envelopeAddress</span>
<a href="#l3.2089"></a><span id="l3.2089"> } envelopeItemType;</span>
<a href="#l3.2090"></a><span id="l3.2090"> </span>
<a href="#l3.2091"></a><span id="l3.2091" class="difflineminus">-typedef struct</span>
<a href="#l3.2092"></a><span id="l3.2092" class="difflineminus">-{</span>
<a href="#l3.2093"></a><span id="l3.2093" class="difflineminus">-  const char * name;</span>
<a href="#l3.2094"></a><span id="l3.2094" class="difflineplus">+typedef struct {</span>
<a href="#l3.2095"></a><span id="l3.2095" class="difflineplus">+  const char *name;</span>
<a href="#l3.2096"></a><span id="l3.2096">   envelopeItemType type;</span>
<a href="#l3.2097"></a><span id="l3.2097"> } envelopeItem;</span>
<a href="#l3.2098"></a><span id="l3.2098"> </span>
<a href="#l3.2099"></a><span id="l3.2099"> // RFC3501:  envelope  = &quot;(&quot; env-date SP env-subject SP env-from SP</span>
<a href="#l3.2100"></a><span id="l3.2100"> //                       env-sender SP env-reply-to SP env-to SP env-cc SP</span>
<a href="#l3.2101"></a><span id="l3.2101"> //                       env-bcc SP env-in-reply-to SP env-message-id &quot;)&quot;</span>
<a href="#l3.2102"></a><span id="l3.2102"> //           env-date    = nstring</span>
<a href="#l3.2103"></a><span id="l3.2103"> //           env-subject = nstring</span>
<a href="#l3.2104"></a><span id="l3.2104" class="difflineat">@@ -1465,430 +1277,354 @@ typedef struct</span>
<a href="#l3.2105"></a><span id="l3.2105"> //           env-sender  = &quot;(&quot; 1*address &quot;)&quot; / nil</span>
<a href="#l3.2106"></a><span id="l3.2106"> //           env-reply-to= &quot;(&quot; 1*address &quot;)&quot; / nil</span>
<a href="#l3.2107"></a><span id="l3.2107"> //           env-to      = &quot;(&quot; 1*address &quot;)&quot; / nil</span>
<a href="#l3.2108"></a><span id="l3.2108"> //           env-cc      = &quot;(&quot; 1*address &quot;)&quot; / nil</span>
<a href="#l3.2109"></a><span id="l3.2109"> //           env-bcc     = &quot;(&quot; 1*address &quot;)&quot; / nil</span>
<a href="#l3.2110"></a><span id="l3.2110"> //           env-in-reply-to = nstring</span>
<a href="#l3.2111"></a><span id="l3.2111"> //           env-message-id  = nstring</span>
<a href="#l3.2112"></a><span id="l3.2112"> </span>
<a href="#l3.2113"></a><span id="l3.2113" class="difflineminus">-static const envelopeItem EnvelopeTable[] =</span>
<a href="#l3.2114"></a><span id="l3.2114" class="difflineminus">-{</span>
<a href="#l3.2115"></a><span id="l3.2115" class="difflineminus">-  {&quot;Date&quot;, envelopeString},</span>
<a href="#l3.2116"></a><span id="l3.2116" class="difflineminus">-  {&quot;Subject&quot;, envelopeString},</span>
<a href="#l3.2117"></a><span id="l3.2117" class="difflineminus">-  {&quot;From&quot;, envelopeAddress},</span>
<a href="#l3.2118"></a><span id="l3.2118" class="difflineminus">-  {&quot;Sender&quot;, envelopeAddress},</span>
<a href="#l3.2119"></a><span id="l3.2119" class="difflineminus">-  {&quot;Reply-to&quot;, envelopeAddress},</span>
<a href="#l3.2120"></a><span id="l3.2120" class="difflineminus">-  {&quot;To&quot;, envelopeAddress},</span>
<a href="#l3.2121"></a><span id="l3.2121" class="difflineminus">-  {&quot;Cc&quot;, envelopeAddress},</span>
<a href="#l3.2122"></a><span id="l3.2122" class="difflineminus">-  {&quot;Bcc&quot;, envelopeAddress},</span>
<a href="#l3.2123"></a><span id="l3.2123" class="difflineminus">-  {&quot;In-reply-to&quot;, envelopeString},</span>
<a href="#l3.2124"></a><span id="l3.2124" class="difflineminus">-  {&quot;Message-id&quot;, envelopeString}</span>
<a href="#l3.2125"></a><span id="l3.2125" class="difflineminus">-};</span>
<a href="#l3.2126"></a><span id="l3.2126" class="difflineplus">+static const envelopeItem EnvelopeTable[] = {</span>
<a href="#l3.2127"></a><span id="l3.2127" class="difflineplus">+    {&quot;Date&quot;, envelopeString},        {&quot;Subject&quot;, envelopeString},</span>
<a href="#l3.2128"></a><span id="l3.2128" class="difflineplus">+    {&quot;From&quot;, envelopeAddress},       {&quot;Sender&quot;, envelopeAddress},</span>
<a href="#l3.2129"></a><span id="l3.2129" class="difflineplus">+    {&quot;Reply-to&quot;, envelopeAddress},   {&quot;To&quot;, envelopeAddress},</span>
<a href="#l3.2130"></a><span id="l3.2130" class="difflineplus">+    {&quot;Cc&quot;, envelopeAddress},         {&quot;Bcc&quot;, envelopeAddress},</span>
<a href="#l3.2131"></a><span id="l3.2131" class="difflineplus">+    {&quot;In-reply-to&quot;, envelopeString}, {&quot;Message-id&quot;, envelopeString}};</span>
<a href="#l3.2132"></a><span id="l3.2132"> </span>
<a href="#l3.2133"></a><span id="l3.2133" class="difflineminus">-void nsImapServerResponseParser::envelope_data()</span>
<a href="#l3.2134"></a><span id="l3.2134" class="difflineminus">-{</span>
<a href="#l3.2135"></a><span id="l3.2135" class="difflineplus">+void nsImapServerResponseParser::envelope_data() {</span>
<a href="#l3.2136"></a><span id="l3.2136">   AdvanceToNextToken();</span>
<a href="#l3.2137"></a><span id="l3.2137" class="difflineminus">-  fNextToken++; // eat '('</span>
<a href="#l3.2138"></a><span id="l3.2138" class="difflineminus">-  for (int tableIndex = 0; tableIndex &lt; (int)(sizeof(EnvelopeTable) / sizeof(EnvelopeTable[0])); tableIndex++)</span>
<a href="#l3.2139"></a><span id="l3.2139" class="difflineminus">-  {</span>
<a href="#l3.2140"></a><span id="l3.2140" class="difflineminus">-    if (!ContinueParse())</span>
<a href="#l3.2141"></a><span id="l3.2141" class="difflineminus">-      break;</span>
<a href="#l3.2142"></a><span id="l3.2142" class="difflineminus">-    if (*fNextToken == ')')</span>
<a href="#l3.2143"></a><span id="l3.2143" class="difflineminus">-    {</span>
<a href="#l3.2144"></a><span id="l3.2144" class="difflineminus">-      SetSyntaxError(true); // envelope too short</span>
<a href="#l3.2145"></a><span id="l3.2145" class="difflineplus">+  fNextToken++;  // eat '('</span>
<a href="#l3.2146"></a><span id="l3.2146" class="difflineplus">+  for (int tableIndex = 0;</span>
<a href="#l3.2147"></a><span id="l3.2147" class="difflineplus">+       tableIndex &lt; (int)(sizeof(EnvelopeTable) / sizeof(EnvelopeTable[0]));</span>
<a href="#l3.2148"></a><span id="l3.2148" class="difflineplus">+       tableIndex++) {</span>
<a href="#l3.2149"></a><span id="l3.2149" class="difflineplus">+    if (!ContinueParse()) break;</span>
<a href="#l3.2150"></a><span id="l3.2150" class="difflineplus">+    if (*fNextToken == ')') {</span>
<a href="#l3.2151"></a><span id="l3.2151" class="difflineplus">+      SetSyntaxError(true);  // envelope too short</span>
<a href="#l3.2152"></a><span id="l3.2152">       break;</span>
<a href="#l3.2153"></a><span id="l3.2153">     }</span>
<a href="#l3.2154"></a><span id="l3.2154"> </span>
<a href="#l3.2155"></a><span id="l3.2155">     nsAutoCString headerLine(EnvelopeTable[tableIndex].name);</span>
<a href="#l3.2156"></a><span id="l3.2156">     headerLine += &quot;: &quot;;</span>
<a href="#l3.2157"></a><span id="l3.2157">     bool headerNonNil = true;</span>
<a href="#l3.2158"></a><span id="l3.2158" class="difflineminus">-    if (EnvelopeTable[tableIndex].type == envelopeString)</span>
<a href="#l3.2159"></a><span id="l3.2159" class="difflineminus">-    {</span>
<a href="#l3.2160"></a><span id="l3.2160" class="difflineplus">+    if (EnvelopeTable[tableIndex].type == envelopeString) {</span>
<a href="#l3.2161"></a><span id="l3.2161">       nsAutoCString strValue;</span>
<a href="#l3.2162"></a><span id="l3.2162">       strValue.Adopt(CreateNilString());</span>
<a href="#l3.2163"></a><span id="l3.2163">       if (!strValue.IsEmpty())</span>
<a href="#l3.2164"></a><span id="l3.2164">         headerLine.Append(strValue);</span>
<a href="#l3.2165"></a><span id="l3.2165">       else</span>
<a href="#l3.2166"></a><span id="l3.2166">         headerNonNil = false;</span>
<a href="#l3.2167"></a><span id="l3.2167" class="difflineminus">-    }</span>
<a href="#l3.2168"></a><span id="l3.2168" class="difflineminus">-    else</span>
<a href="#l3.2169"></a><span id="l3.2169" class="difflineminus">-    {</span>
<a href="#l3.2170"></a><span id="l3.2170" class="difflineplus">+    } else {</span>
<a href="#l3.2171"></a><span id="l3.2171">       nsAutoCString address;</span>
<a href="#l3.2172"></a><span id="l3.2172">       parse_address(address);</span>
<a href="#l3.2173"></a><span id="l3.2173">       headerLine += address;</span>
<a href="#l3.2174"></a><span id="l3.2174" class="difflineminus">-      if (address.IsEmpty())</span>
<a href="#l3.2175"></a><span id="l3.2175" class="difflineminus">-        headerNonNil = false;</span>
<a href="#l3.2176"></a><span id="l3.2176" class="difflineplus">+      if (address.IsEmpty()) headerNonNil = false;</span>
<a href="#l3.2177"></a><span id="l3.2177">     }</span>
<a href="#l3.2178"></a><span id="l3.2178">     if (headerNonNil)</span>
<a href="#l3.2179"></a><span id="l3.2179">       fServerConnection.HandleMessageDownLoadLine(headerLine.get(), false);</span>
<a href="#l3.2180"></a><span id="l3.2180"> </span>
<a href="#l3.2181"></a><span id="l3.2181" class="difflineminus">-    if (ContinueParse())</span>
<a href="#l3.2182"></a><span id="l3.2182" class="difflineminus">-      AdvanceToNextToken();</span>
<a href="#l3.2183"></a><span id="l3.2183" class="difflineplus">+    if (ContinueParse()) AdvanceToNextToken();</span>
<a href="#l3.2184"></a><span id="l3.2184">   }</span>
<a href="#l3.2185"></a><span id="l3.2185">   // Now we should be at the end of the envelope and have *fToken == ')'.</span>
<a href="#l3.2186"></a><span id="l3.2186">   // Skip this last parenthesis.</span>
<a href="#l3.2187"></a><span id="l3.2187">   AdvanceToNextToken();</span>
<a href="#l3.2188"></a><span id="l3.2188"> }</span>
<a href="#l3.2189"></a><span id="l3.2189"> </span>
<a href="#l3.2190"></a><span id="l3.2190" class="difflineminus">-void nsImapServerResponseParser::xaolenvelope_data()</span>
<a href="#l3.2191"></a><span id="l3.2191" class="difflineminus">-{</span>
<a href="#l3.2192"></a><span id="l3.2192" class="difflineplus">+void nsImapServerResponseParser::xaolenvelope_data() {</span>
<a href="#l3.2193"></a><span id="l3.2193">   // eat the opening '('</span>
<a href="#l3.2194"></a><span id="l3.2194">   fNextToken++;</span>
<a href="#l3.2195"></a><span id="l3.2195"> </span>
<a href="#l3.2196"></a><span id="l3.2196" class="difflineminus">-  if (ContinueParse() &amp;&amp; (*fNextToken != ')'))</span>
<a href="#l3.2197"></a><span id="l3.2197" class="difflineminus">-  {</span>
<a href="#l3.2198"></a><span id="l3.2198" class="difflineplus">+  if (ContinueParse() &amp;&amp; (*fNextToken != ')')) {</span>
<a href="#l3.2199"></a><span id="l3.2199">     AdvanceToNextToken();</span>
<a href="#l3.2200"></a><span id="l3.2200" class="difflineminus">-    fNextToken++; // eat '('</span>
<a href="#l3.2201"></a><span id="l3.2201" class="difflineplus">+    fNextToken++;  // eat '('</span>
<a href="#l3.2202"></a><span id="l3.2202">     nsAutoCString subject;</span>
<a href="#l3.2203"></a><span id="l3.2203">     subject.Adopt(CreateNilString());</span>
<a href="#l3.2204"></a><span id="l3.2204">     nsAutoCString subjectLine(&quot;Subject: &quot;);</span>
<a href="#l3.2205"></a><span id="l3.2205">     subjectLine += subject;</span>
<a href="#l3.2206"></a><span id="l3.2206">     fServerConnection.HandleMessageDownLoadLine(subjectLine.get(), false);</span>
<a href="#l3.2207"></a><span id="l3.2207" class="difflineminus">-    fNextToken++; // eat the next '('</span>
<a href="#l3.2208"></a><span id="l3.2208" class="difflineminus">-    if (ContinueParse())</span>
<a href="#l3.2209"></a><span id="l3.2209" class="difflineminus">-    {</span>
<a href="#l3.2210"></a><span id="l3.2210" class="difflineplus">+    fNextToken++;  // eat the next '('</span>
<a href="#l3.2211"></a><span id="l3.2211" class="difflineplus">+    if (ContinueParse()) {</span>
<a href="#l3.2212"></a><span id="l3.2212">       AdvanceToNextToken();</span>
<a href="#l3.2213"></a><span id="l3.2213" class="difflineminus">-      if (ContinueParse())</span>
<a href="#l3.2214"></a><span id="l3.2214" class="difflineminus">-      {</span>
<a href="#l3.2215"></a><span id="l3.2215" class="difflineplus">+      if (ContinueParse()) {</span>
<a href="#l3.2216"></a><span id="l3.2216">         nsAutoCString fromLine;</span>
<a href="#l3.2217"></a><span id="l3.2217" class="difflineminus">-        if (!strcmp(GetSelectedMailboxName(), &quot;Sent Items&quot;))</span>
<a href="#l3.2218"></a><span id="l3.2218" class="difflineminus">-        {</span>
<a href="#l3.2219"></a><span id="l3.2219" class="difflineminus">-          // xaol envelope switches the From with the To, so we switch them back and</span>
<a href="#l3.2220"></a><span id="l3.2220" class="difflineminus">-          // create a fake from line From: user@aol.com</span>
<a href="#l3.2221"></a><span id="l3.2221" class="difflineplus">+        if (!strcmp(GetSelectedMailboxName(), &quot;Sent Items&quot;)) {</span>
<a href="#l3.2222"></a><span id="l3.2222" class="difflineplus">+          // xaol envelope switches the From with the To, so we switch them back</span>
<a href="#l3.2223"></a><span id="l3.2223" class="difflineplus">+          // and create a fake from line From: user@aol.com</span>
<a href="#l3.2224"></a><span id="l3.2224">           fromLine.AppendLiteral(&quot;To: &quot;);</span>
<a href="#l3.2225"></a><span id="l3.2225">           nsAutoCString fakeFromLine(NS_LITERAL_CSTRING(&quot;From: &quot;));</span>
<a href="#l3.2226"></a><span id="l3.2226">           fakeFromLine.Append(fServerConnection.GetImapUserName());</span>
<a href="#l3.2227"></a><span id="l3.2227">           fakeFromLine.AppendLiteral(&quot;@aol.com&quot;);</span>
<a href="#l3.2228"></a><span id="l3.2228" class="difflineminus">-          fServerConnection.HandleMessageDownLoadLine(fakeFromLine.get(), false);</span>
<a href="#l3.2229"></a><span id="l3.2229" class="difflineminus">-        }</span>
<a href="#l3.2230"></a><span id="l3.2230" class="difflineminus">-        else</span>
<a href="#l3.2231"></a><span id="l3.2231" class="difflineminus">-        {</span>
<a href="#l3.2232"></a><span id="l3.2232" class="difflineplus">+          fServerConnection.HandleMessageDownLoadLine(fakeFromLine.get(),</span>
<a href="#l3.2233"></a><span id="l3.2233" class="difflineplus">+                                                      false);</span>
<a href="#l3.2234"></a><span id="l3.2234" class="difflineplus">+        } else {</span>
<a href="#l3.2235"></a><span id="l3.2235">           fromLine.AppendLiteral(&quot;From: &quot;);</span>
<a href="#l3.2236"></a><span id="l3.2236">         }</span>
<a href="#l3.2237"></a><span id="l3.2237">         parse_address(fromLine);</span>
<a href="#l3.2238"></a><span id="l3.2238">         fServerConnection.HandleMessageDownLoadLine(fromLine.get(), false);</span>
<a href="#l3.2239"></a><span id="l3.2239" class="difflineminus">-        if (ContinueParse())</span>
<a href="#l3.2240"></a><span id="l3.2240" class="difflineminus">-        {</span>
<a href="#l3.2241"></a><span id="l3.2241" class="difflineplus">+        if (ContinueParse()) {</span>
<a href="#l3.2242"></a><span id="l3.2242">           AdvanceToNextToken();  // ge attachment size</span>
<a href="#l3.2243"></a><span id="l3.2243">           int32_t attachmentSize = atoi(fNextToken);</span>
<a href="#l3.2244"></a><span id="l3.2244" class="difflineminus">-          if (attachmentSize != 0)</span>
<a href="#l3.2245"></a><span id="l3.2245" class="difflineminus">-          {</span>
<a href="#l3.2246"></a><span id="l3.2246" class="difflineplus">+          if (attachmentSize != 0) {</span>
<a href="#l3.2247"></a><span id="l3.2247">             nsAutoCString attachmentLine(&quot;X-attachment-size: &quot;);</span>
<a href="#l3.2248"></a><span id="l3.2248">             attachmentLine.AppendInt(attachmentSize);</span>
<a href="#l3.2249"></a><span id="l3.2249" class="difflineminus">-            fServerConnection.HandleMessageDownLoadLine(attachmentLine.get(), false);</span>
<a href="#l3.2250"></a><span id="l3.2250" class="difflineplus">+            fServerConnection.HandleMessageDownLoadLine(attachmentLine.get(),</span>
<a href="#l3.2251"></a><span id="l3.2251" class="difflineplus">+                                                        false);</span>
<a href="#l3.2252"></a><span id="l3.2252">           }</span>
<a href="#l3.2253"></a><span id="l3.2253">         }</span>
<a href="#l3.2254"></a><span id="l3.2254" class="difflineminus">-        if (ContinueParse())</span>
<a href="#l3.2255"></a><span id="l3.2255" class="difflineminus">-        {</span>
<a href="#l3.2256"></a><span id="l3.2256" class="difflineplus">+        if (ContinueParse()) {</span>
<a href="#l3.2257"></a><span id="l3.2257">           AdvanceToNextToken();  // skip image size</span>
<a href="#l3.2258"></a><span id="l3.2258">           int32_t imageSize = atoi(fNextToken);</span>
<a href="#l3.2259"></a><span id="l3.2259" class="difflineminus">-          if (imageSize != 0)</span>
<a href="#l3.2260"></a><span id="l3.2260" class="difflineminus">-          {</span>
<a href="#l3.2261"></a><span id="l3.2261" class="difflineplus">+          if (imageSize != 0) {</span>
<a href="#l3.2262"></a><span id="l3.2262">             nsAutoCString imageLine(&quot;X-image-size: &quot;);</span>
<a href="#l3.2263"></a><span id="l3.2263">             imageLine.AppendInt(imageSize);</span>
<a href="#l3.2264"></a><span id="l3.2264">             fServerConnection.HandleMessageDownLoadLine(imageLine.get(), false);</span>
<a href="#l3.2265"></a><span id="l3.2265">           }</span>
<a href="#l3.2266"></a><span id="l3.2266">         }</span>
<a href="#l3.2267"></a><span id="l3.2267" class="difflineminus">-        if (ContinueParse())</span>
<a href="#l3.2268"></a><span id="l3.2268" class="difflineminus">-          AdvanceToNextToken();  // skip )</span>
<a href="#l3.2269"></a><span id="l3.2269" class="difflineplus">+        if (ContinueParse()) AdvanceToNextToken();  // skip )</span>
<a href="#l3.2270"></a><span id="l3.2270">       }</span>
<a href="#l3.2271"></a><span id="l3.2271">     }</span>
<a href="#l3.2272"></a><span id="l3.2272">   }</span>
<a href="#l3.2273"></a><span id="l3.2273"> }</span>
<a href="#l3.2274"></a><span id="l3.2274"> </span>
<a href="#l3.2275"></a><span id="l3.2275" class="difflineminus">-void nsImapServerResponseParser::parse_address(nsAutoCString &amp;addressLine)</span>
<a href="#l3.2276"></a><span id="l3.2276" class="difflineminus">-{</span>
<a href="#l3.2277"></a><span id="l3.2277" class="difflineminus">-  if (!strcmp(fNextToken, &quot;NIL&quot;))</span>
<a href="#l3.2278"></a><span id="l3.2278" class="difflineminus">-    return;</span>
<a href="#l3.2279"></a><span id="l3.2279" class="difflineplus">+void nsImapServerResponseParser::parse_address(nsAutoCString &amp;addressLine) {</span>
<a href="#l3.2280"></a><span id="l3.2280" class="difflineplus">+  if (!strcmp(fNextToken, &quot;NIL&quot;)) return;</span>
<a href="#l3.2281"></a><span id="l3.2281">   bool firstAddress = true;</span>
<a href="#l3.2282"></a><span id="l3.2282">   // should really look at chars here</span>
<a href="#l3.2283"></a><span id="l3.2283">   NS_ASSERTION(*fNextToken == '(', &quot;address should start with '('&quot;);</span>
<a href="#l3.2284"></a><span id="l3.2284" class="difflineminus">-  fNextToken++; // eat the next '('</span>
<a href="#l3.2285"></a><span id="l3.2285" class="difflineminus">-  while (ContinueParse() &amp;&amp; *fNextToken == '(')</span>
<a href="#l3.2286"></a><span id="l3.2286" class="difflineminus">-  {</span>
<a href="#l3.2287"></a><span id="l3.2287" class="difflineplus">+  fNextToken++;  // eat the next '('</span>
<a href="#l3.2288"></a><span id="l3.2288" class="difflineplus">+  while (ContinueParse() &amp;&amp; *fNextToken == '(') {</span>
<a href="#l3.2289"></a><span id="l3.2289">     NS_ASSERTION(*fNextToken == '(', &quot;address should start with '('&quot;);</span>
<a href="#l3.2290"></a><span id="l3.2290" class="difflineminus">-    fNextToken++; // eat the next '('</span>
<a href="#l3.2291"></a><span id="l3.2291" class="difflineplus">+    fNextToken++;  // eat the next '('</span>
<a href="#l3.2292"></a><span id="l3.2292"> </span>
<a href="#l3.2293"></a><span id="l3.2293" class="difflineminus">-    if (!firstAddress)</span>
<a href="#l3.2294"></a><span id="l3.2294" class="difflineminus">-      addressLine += &quot;, &quot;;</span>
<a href="#l3.2295"></a><span id="l3.2295" class="difflineplus">+    if (!firstAddress) addressLine += &quot;, &quot;;</span>
<a href="#l3.2296"></a><span id="l3.2296"> </span>
<a href="#l3.2297"></a><span id="l3.2297">     firstAddress = false;</span>
<a href="#l3.2298"></a><span id="l3.2298">     char *personalName = CreateNilString();</span>
<a href="#l3.2299"></a><span id="l3.2299">     AdvanceToNextToken();</span>
<a href="#l3.2300"></a><span id="l3.2300">     char *atDomainList = CreateNilString();</span>
<a href="#l3.2301"></a><span id="l3.2301" class="difflineminus">-    if (ContinueParse())</span>
<a href="#l3.2302"></a><span id="l3.2302" class="difflineminus">-    {</span>
<a href="#l3.2303"></a><span id="l3.2303" class="difflineplus">+    if (ContinueParse()) {</span>
<a href="#l3.2304"></a><span id="l3.2304">       AdvanceToNextToken();</span>
<a href="#l3.2305"></a><span id="l3.2305">       char *mailboxName = CreateNilString();</span>
<a href="#l3.2306"></a><span id="l3.2306" class="difflineminus">-      if (ContinueParse())</span>
<a href="#l3.2307"></a><span id="l3.2307" class="difflineminus">-      {</span>
<a href="#l3.2308"></a><span id="l3.2308" class="difflineplus">+      if (ContinueParse()) {</span>
<a href="#l3.2309"></a><span id="l3.2309">         AdvanceToNextToken();</span>
<a href="#l3.2310"></a><span id="l3.2310">         char *hostName = CreateNilString();</span>
<a href="#l3.2311"></a><span id="l3.2311">         AdvanceToNextToken();</span>
<a href="#l3.2312"></a><span id="l3.2312">         addressLine += mailboxName;</span>
<a href="#l3.2313"></a><span id="l3.2313" class="difflineminus">-        if (hostName)</span>
<a href="#l3.2314"></a><span id="l3.2314" class="difflineminus">-        {</span>
<a href="#l3.2315"></a><span id="l3.2315" class="difflineplus">+        if (hostName) {</span>
<a href="#l3.2316"></a><span id="l3.2316">           addressLine += '@';</span>
<a href="#l3.2317"></a><span id="l3.2317">           addressLine += hostName;</span>
<a href="#l3.2318"></a><span id="l3.2318">           free(hostName);</span>
<a href="#l3.2319"></a><span id="l3.2319">         }</span>
<a href="#l3.2320"></a><span id="l3.2320" class="difflineminus">-        if (personalName)</span>
<a href="#l3.2321"></a><span id="l3.2321" class="difflineminus">-        {</span>
<a href="#l3.2322"></a><span id="l3.2322" class="difflineplus">+        if (personalName) {</span>
<a href="#l3.2323"></a><span id="l3.2323">           addressLine += &quot; (&quot;;</span>
<a href="#l3.2324"></a><span id="l3.2324">           addressLine += personalName;</span>
<a href="#l3.2325"></a><span id="l3.2325">           addressLine += ')';</span>
<a href="#l3.2326"></a><span id="l3.2326">         }</span>
<a href="#l3.2327"></a><span id="l3.2327">       }</span>
<a href="#l3.2328"></a><span id="l3.2328">     }</span>
<a href="#l3.2329"></a><span id="l3.2329">     PR_Free(personalName);</span>
<a href="#l3.2330"></a><span id="l3.2330">     PR_Free(atDomainList);</span>
<a href="#l3.2331"></a><span id="l3.2331"> </span>
<a href="#l3.2332"></a><span id="l3.2332" class="difflineminus">-    if (*fNextToken == ')')</span>
<a href="#l3.2333"></a><span id="l3.2333" class="difflineminus">-      fNextToken++;</span>
<a href="#l3.2334"></a><span id="l3.2334" class="difflineplus">+    if (*fNextToken == ')') fNextToken++;</span>
<a href="#l3.2335"></a><span id="l3.2335">     // if the next token isn't a ')' for the address term,</span>
<a href="#l3.2336"></a><span id="l3.2336">     // then we must have another address pair left....so get the next</span>
<a href="#l3.2337"></a><span id="l3.2337">     // token and continue parsing in this loop...</span>
<a href="#l3.2338"></a><span id="l3.2338" class="difflineminus">-    if ( *fNextToken == '\0' )</span>
<a href="#l3.2339"></a><span id="l3.2339" class="difflineminus">-      AdvanceToNextToken();</span>
<a href="#l3.2340"></a><span id="l3.2340" class="difflineminus">-</span>
<a href="#l3.2341"></a><span id="l3.2341" class="difflineplus">+    if (*fNextToken == '\0') AdvanceToNextToken();</span>
<a href="#l3.2342"></a><span id="l3.2342">   }</span>
<a href="#l3.2343"></a><span id="l3.2343" class="difflineminus">-  if (*fNextToken == ')')</span>
<a href="#l3.2344"></a><span id="l3.2344" class="difflineminus">-    fNextToken++;</span>
<a href="#l3.2345"></a><span id="l3.2345" class="difflineplus">+  if (*fNextToken == ')') fNextToken++;</span>
<a href="#l3.2346"></a><span id="l3.2346">   // AdvanceToNextToken();  // skip &quot;))&quot;</span>
<a href="#l3.2347"></a><span id="l3.2347"> }</span>
<a href="#l3.2348"></a><span id="l3.2348"> </span>
<a href="#l3.2349"></a><span id="l3.2349" class="difflineminus">-void nsImapServerResponseParser::internal_date()</span>
<a href="#l3.2350"></a><span id="l3.2350" class="difflineminus">-{</span>
<a href="#l3.2351"></a><span id="l3.2351" class="difflineplus">+void nsImapServerResponseParser::internal_date() {</span>
<a href="#l3.2352"></a><span id="l3.2352">   AdvanceToNextToken();</span>
<a href="#l3.2353"></a><span id="l3.2353" class="difflineminus">-  if (ContinueParse())</span>
<a href="#l3.2354"></a><span id="l3.2354" class="difflineminus">-  {</span>
<a href="#l3.2355"></a><span id="l3.2355" class="difflineplus">+  if (ContinueParse()) {</span>
<a href="#l3.2356"></a><span id="l3.2356">     nsAutoCString dateLine(&quot;Date: &quot;);</span>
<a href="#l3.2357"></a><span id="l3.2357">     char *strValue = CreateNilString();</span>
<a href="#l3.2358"></a><span id="l3.2358" class="difflineminus">-    if (strValue)</span>
<a href="#l3.2359"></a><span id="l3.2359" class="difflineminus">-    {</span>
<a href="#l3.2360"></a><span id="l3.2360" class="difflineplus">+    if (strValue) {</span>
<a href="#l3.2361"></a><span id="l3.2361">       dateLine += strValue;</span>
<a href="#l3.2362"></a><span id="l3.2362">       free(strValue);</span>
<a href="#l3.2363"></a><span id="l3.2363">     }</span>
<a href="#l3.2364"></a><span id="l3.2364">     fServerConnection.HandleMessageDownLoadLine(dateLine.get(), false);</span>
<a href="#l3.2365"></a><span id="l3.2365">   }</span>
<a href="#l3.2366"></a><span id="l3.2366">   // advance the parser.</span>
<a href="#l3.2367"></a><span id="l3.2367">   AdvanceToNextToken();</span>
<a href="#l3.2368"></a><span id="l3.2368"> }</span>
<a href="#l3.2369"></a><span id="l3.2369"> </span>
<a href="#l3.2370"></a><span id="l3.2370" class="difflineminus">-void nsImapServerResponseParser::flags()</span>
<a href="#l3.2371"></a><span id="l3.2371" class="difflineminus">-{</span>
<a href="#l3.2372"></a><span id="l3.2372" class="difflineplus">+void nsImapServerResponseParser::flags() {</span>
<a href="#l3.2373"></a><span id="l3.2373">   imapMessageFlagsType messageFlags = kNoImapMsgFlag;</span>
<a href="#l3.2374"></a><span id="l3.2374">   fCustomFlags.Clear();</span>
<a href="#l3.2375"></a><span id="l3.2375"> </span>
<a href="#l3.2376"></a><span id="l3.2376">   // clear the custom flags for this message</span>
<a href="#l3.2377"></a><span id="l3.2377">   // otherwise the old custom flags will stay around</span>
<a href="#l3.2378"></a><span id="l3.2378">   // see bug #191042</span>
<a href="#l3.2379"></a><span id="l3.2379">   if (fFlagState &amp;&amp; CurrentResponseUID() != nsMsgKey_None)</span>
<a href="#l3.2380"></a><span id="l3.2380">     fFlagState-&gt;ClearCustomFlags(CurrentResponseUID());</span>
<a href="#l3.2381"></a><span id="l3.2381"> </span>
<a href="#l3.2382"></a><span id="l3.2382">   // eat the opening '('</span>
<a href="#l3.2383"></a><span id="l3.2383">   fNextToken++;</span>
<a href="#l3.2384"></a><span id="l3.2384" class="difflineminus">-  while (ContinueParse() &amp;&amp; (*fNextToken != ')'))</span>
<a href="#l3.2385"></a><span id="l3.2385" class="difflineminus">-  {</span>
<a href="#l3.2386"></a><span id="l3.2386" class="difflineplus">+  while (ContinueParse() &amp;&amp; (*fNextToken != ')')) {</span>
<a href="#l3.2387"></a><span id="l3.2387">     bool knownFlag = false;</span>
<a href="#l3.2388"></a><span id="l3.2388" class="difflineminus">-    if (*fNextToken == '\\')</span>
<a href="#l3.2389"></a><span id="l3.2389" class="difflineminus">-    {</span>
<a href="#l3.2390"></a><span id="l3.2390" class="difflineplus">+    if (*fNextToken == '\\') {</span>
<a href="#l3.2391"></a><span id="l3.2391">       switch (NS_ToUpper(fNextToken[1])) {</span>
<a href="#l3.2392"></a><span id="l3.2392" class="difflineminus">-      case 'S':</span>
<a href="#l3.2393"></a><span id="l3.2393" class="difflineminus">-        if (!PL_strncasecmp(fNextToken, &quot;\\Seen&quot;,5))</span>
<a href="#l3.2394"></a><span id="l3.2394" class="difflineminus">-        {</span>
<a href="#l3.2395"></a><span id="l3.2395" class="difflineminus">-          messageFlags |= kImapMsgSeenFlag;</span>
<a href="#l3.2396"></a><span id="l3.2396" class="difflineminus">-          knownFlag = true;</span>
<a href="#l3.2397"></a><span id="l3.2397" class="difflineminus">-        }</span>
<a href="#l3.2398"></a><span id="l3.2398" class="difflineminus">-        break;</span>
<a href="#l3.2399"></a><span id="l3.2399" class="difflineminus">-      case 'A':</span>
<a href="#l3.2400"></a><span id="l3.2400" class="difflineminus">-        if (!PL_strncasecmp(fNextToken, &quot;\\Answered&quot;,9))</span>
<a href="#l3.2401"></a><span id="l3.2401" class="difflineminus">-        {</span>
<a href="#l3.2402"></a><span id="l3.2402" class="difflineminus">-          messageFlags |= kImapMsgAnsweredFlag;</span>
<a href="#l3.2403"></a><span id="l3.2403" class="difflineminus">-          knownFlag = true;</span>
<a href="#l3.2404"></a><span id="l3.2404" class="difflineminus">-        }</span>
<a href="#l3.2405"></a><span id="l3.2405" class="difflineminus">-        break;</span>
<a href="#l3.2406"></a><span id="l3.2406" class="difflineminus">-      case 'F':</span>
<a href="#l3.2407"></a><span id="l3.2407" class="difflineminus">-        if (!PL_strncasecmp(fNextToken, &quot;\\Flagged&quot;,8))</span>
<a href="#l3.2408"></a><span id="l3.2408" class="difflineminus">-        {</span>
<a href="#l3.2409"></a><span id="l3.2409" class="difflineminus">-          messageFlags |= kImapMsgFlaggedFlag;</span>
<a href="#l3.2410"></a><span id="l3.2410" class="difflineminus">-          knownFlag = true;</span>
<a href="#l3.2411"></a><span id="l3.2411" class="difflineminus">-        }</span>
<a href="#l3.2412"></a><span id="l3.2412" class="difflineminus">-        break;</span>
<a href="#l3.2413"></a><span id="l3.2413" class="difflineminus">-      case 'D':</span>
<a href="#l3.2414"></a><span id="l3.2414" class="difflineminus">-        if (!PL_strncasecmp(fNextToken, &quot;\\Deleted&quot;,8))</span>
<a href="#l3.2415"></a><span id="l3.2415" class="difflineminus">-        {</span>
<a href="#l3.2416"></a><span id="l3.2416" class="difflineminus">-          messageFlags |= kImapMsgDeletedFlag;</span>
<a href="#l3.2417"></a><span id="l3.2417" class="difflineminus">-          knownFlag = true;</span>
<a href="#l3.2418"></a><span id="l3.2418" class="difflineminus">-        }</span>
<a href="#l3.2419"></a><span id="l3.2419" class="difflineminus">-        else if (!PL_strncasecmp(fNextToken, &quot;\\Draft&quot;,6))</span>
<a href="#l3.2420"></a><span id="l3.2420" class="difflineminus">-        {</span>
<a href="#l3.2421"></a><span id="l3.2421" class="difflineminus">-          messageFlags |= kImapMsgDraftFlag;</span>
<a href="#l3.2422"></a><span id="l3.2422" class="difflineminus">-          knownFlag = true;</span>
<a href="#l3.2423"></a><span id="l3.2423" class="difflineminus">-        }</span>
<a href="#l3.2424"></a><span id="l3.2424" class="difflineminus">-        break;</span>
<a href="#l3.2425"></a><span id="l3.2425" class="difflineminus">-      case 'R':</span>
<a href="#l3.2426"></a><span id="l3.2426" class="difflineminus">-        if (!PL_strncasecmp(fNextToken, &quot;\\Recent&quot;,7))</span>
<a href="#l3.2427"></a><span id="l3.2427" class="difflineminus">-        {</span>
<a href="#l3.2428"></a><span id="l3.2428" class="difflineminus">-          messageFlags |= kImapMsgRecentFlag;</span>
<a href="#l3.2429"></a><span id="l3.2429" class="difflineminus">-          knownFlag = true;</span>
<a href="#l3.2430"></a><span id="l3.2430" class="difflineminus">-        }</span>
<a href="#l3.2431"></a><span id="l3.2431" class="difflineminus">-        break;</span>
<a href="#l3.2432"></a><span id="l3.2432" class="difflineminus">-      default:</span>
<a href="#l3.2433"></a><span id="l3.2433" class="difflineminus">-        break;</span>
<a href="#l3.2434"></a><span id="l3.2434" class="difflineplus">+        case 'S':</span>
<a href="#l3.2435"></a><span id="l3.2435" class="difflineplus">+          if (!PL_strncasecmp(fNextToken, &quot;\\Seen&quot;, 5)) {</span>
<a href="#l3.2436"></a><span id="l3.2436" class="difflineplus">+            messageFlags |= kImapMsgSeenFlag;</span>
<a href="#l3.2437"></a><span id="l3.2437" class="difflineplus">+            knownFlag = true;</span>
<a href="#l3.2438"></a><span id="l3.2438" class="difflineplus">+          }</span>
<a href="#l3.2439"></a><span id="l3.2439" class="difflineplus">+          break;</span>
<a href="#l3.2440"></a><span id="l3.2440" class="difflineplus">+        case 'A':</span>
<a href="#l3.2441"></a><span id="l3.2441" class="difflineplus">+          if (!PL_strncasecmp(fNextToken, &quot;\\Answered&quot;, 9)) {</span>
<a href="#l3.2442"></a><span id="l3.2442" class="difflineplus">+            messageFlags |= kImapMsgAnsweredFlag;</span>
<a href="#l3.2443"></a><span id="l3.2443" class="difflineplus">+            knownFlag = true;</span>
<a href="#l3.2444"></a><span id="l3.2444" class="difflineplus">+          }</span>
<a href="#l3.2445"></a><span id="l3.2445" class="difflineplus">+          break;</span>
<a href="#l3.2446"></a><span id="l3.2446" class="difflineplus">+        case 'F':</span>
<a href="#l3.2447"></a><span id="l3.2447" class="difflineplus">+          if (!PL_strncasecmp(fNextToken, &quot;\\Flagged&quot;, 8)) {</span>
<a href="#l3.2448"></a><span id="l3.2448" class="difflineplus">+            messageFlags |= kImapMsgFlaggedFlag;</span>
<a href="#l3.2449"></a><span id="l3.2449" class="difflineplus">+            knownFlag = true;</span>
<a href="#l3.2450"></a><span id="l3.2450" class="difflineplus">+          }</span>
<a href="#l3.2451"></a><span id="l3.2451" class="difflineplus">+          break;</span>
<a href="#l3.2452"></a><span id="l3.2452" class="difflineplus">+        case 'D':</span>
<a href="#l3.2453"></a><span id="l3.2453" class="difflineplus">+          if (!PL_strncasecmp(fNextToken, &quot;\\Deleted&quot;, 8)) {</span>
<a href="#l3.2454"></a><span id="l3.2454" class="difflineplus">+            messageFlags |= kImapMsgDeletedFlag;</span>
<a href="#l3.2455"></a><span id="l3.2455" class="difflineplus">+            knownFlag = true;</span>
<a href="#l3.2456"></a><span id="l3.2456" class="difflineplus">+          } else if (!PL_strncasecmp(fNextToken, &quot;\\Draft&quot;, 6)) {</span>
<a href="#l3.2457"></a><span id="l3.2457" class="difflineplus">+            messageFlags |= kImapMsgDraftFlag;</span>
<a href="#l3.2458"></a><span id="l3.2458" class="difflineplus">+            knownFlag = true;</span>
<a href="#l3.2459"></a><span id="l3.2459" class="difflineplus">+          }</span>
<a href="#l3.2460"></a><span id="l3.2460" class="difflineplus">+          break;</span>
<a href="#l3.2461"></a><span id="l3.2461" class="difflineplus">+        case 'R':</span>
<a href="#l3.2462"></a><span id="l3.2462" class="difflineplus">+          if (!PL_strncasecmp(fNextToken, &quot;\\Recent&quot;, 7)) {</span>
<a href="#l3.2463"></a><span id="l3.2463" class="difflineplus">+            messageFlags |= kImapMsgRecentFlag;</span>
<a href="#l3.2464"></a><span id="l3.2464" class="difflineplus">+            knownFlag = true;</span>
<a href="#l3.2465"></a><span id="l3.2465" class="difflineplus">+          }</span>
<a href="#l3.2466"></a><span id="l3.2466" class="difflineplus">+          break;</span>
<a href="#l3.2467"></a><span id="l3.2467" class="difflineplus">+        default:</span>
<a href="#l3.2468"></a><span id="l3.2468" class="difflineplus">+          break;</span>
<a href="#l3.2469"></a><span id="l3.2469" class="difflineplus">+      }</span>
<a href="#l3.2470"></a><span id="l3.2470" class="difflineplus">+    } else if (*fNextToken == '$') {</span>
<a href="#l3.2471"></a><span id="l3.2471" class="difflineplus">+      switch (NS_ToUpper(fNextToken[1])) {</span>
<a href="#l3.2472"></a><span id="l3.2472" class="difflineplus">+        case 'M':</span>
<a href="#l3.2473"></a><span id="l3.2473" class="difflineplus">+          if ((fSupportsUserDefinedFlags &amp;</span>
<a href="#l3.2474"></a><span id="l3.2474" class="difflineplus">+               (kImapMsgSupportUserFlag | kImapMsgSupportMDNSentFlag)) &amp;&amp;</span>
<a href="#l3.2475"></a><span id="l3.2475" class="difflineplus">+              !PL_strncasecmp(fNextToken, &quot;$MDNSent&quot;, 8)) {</span>
<a href="#l3.2476"></a><span id="l3.2476" class="difflineplus">+            messageFlags |= kImapMsgMDNSentFlag;</span>
<a href="#l3.2477"></a><span id="l3.2477" class="difflineplus">+            knownFlag = true;</span>
<a href="#l3.2478"></a><span id="l3.2478" class="difflineplus">+          }</span>
<a href="#l3.2479"></a><span id="l3.2479" class="difflineplus">+          break;</span>
<a href="#l3.2480"></a><span id="l3.2480" class="difflineplus">+        case 'F':</span>
<a href="#l3.2481"></a><span id="l3.2481" class="difflineplus">+          if ((fSupportsUserDefinedFlags &amp;</span>
<a href="#l3.2482"></a><span id="l3.2482" class="difflineplus">+               (kImapMsgSupportUserFlag | kImapMsgSupportForwardedFlag)) &amp;&amp;</span>
<a href="#l3.2483"></a><span id="l3.2483" class="difflineplus">+              !PL_strncasecmp(fNextToken, &quot;$Forwarded&quot;, 10)) {</span>
<a href="#l3.2484"></a><span id="l3.2484" class="difflineplus">+            messageFlags |= kImapMsgForwardedFlag;</span>
<a href="#l3.2485"></a><span id="l3.2485" class="difflineplus">+            knownFlag = true;</span>
<a href="#l3.2486"></a><span id="l3.2486" class="difflineplus">+          }</span>
<a href="#l3.2487"></a><span id="l3.2487" class="difflineplus">+          break;</span>
<a href="#l3.2488"></a><span id="l3.2488" class="difflineplus">+        default:</span>
<a href="#l3.2489"></a><span id="l3.2489" class="difflineplus">+          break;</span>
<a href="#l3.2490"></a><span id="l3.2490">       }</span>
<a href="#l3.2491"></a><span id="l3.2491">     }</span>
<a href="#l3.2492"></a><span id="l3.2492" class="difflineminus">-    else if (*fNextToken == '$')</span>
<a href="#l3.2493"></a><span id="l3.2493" class="difflineminus">-    {</span>
<a href="#l3.2494"></a><span id="l3.2494" class="difflineminus">-      switch (NS_ToUpper(fNextToken[1])) {</span>
<a href="#l3.2495"></a><span id="l3.2495" class="difflineminus">-      case 'M':</span>
<a href="#l3.2496"></a><span id="l3.2496" class="difflineminus">-        if ((fSupportsUserDefinedFlags &amp; (kImapMsgSupportUserFlag |</span>
<a href="#l3.2497"></a><span id="l3.2497" class="difflineminus">-          kImapMsgSupportMDNSentFlag))</span>
<a href="#l3.2498"></a><span id="l3.2498" class="difflineminus">-          &amp;&amp; !PL_strncasecmp(fNextToken, &quot;$MDNSent&quot;,8))</span>
<a href="#l3.2499"></a><span id="l3.2499" class="difflineminus">-        {</span>
<a href="#l3.2500"></a><span id="l3.2500" class="difflineminus">-          messageFlags |= kImapMsgMDNSentFlag;</span>
<a href="#l3.2501"></a><span id="l3.2501" class="difflineminus">-          knownFlag = true;</span>
<a href="#l3.2502"></a><span id="l3.2502" class="difflineminus">-        }</span>
<a href="#l3.2503"></a><span id="l3.2503" class="difflineminus">-        break;</span>
<a href="#l3.2504"></a><span id="l3.2504" class="difflineminus">-      case 'F':</span>
<a href="#l3.2505"></a><span id="l3.2505" class="difflineminus">-        if ((fSupportsUserDefinedFlags &amp; (kImapMsgSupportUserFlag |</span>
<a href="#l3.2506"></a><span id="l3.2506" class="difflineminus">-          kImapMsgSupportForwardedFlag))</span>
<a href="#l3.2507"></a><span id="l3.2507" class="difflineminus">-          &amp;&amp; !PL_strncasecmp(fNextToken, &quot;$Forwarded&quot;,10))</span>
<a href="#l3.2508"></a><span id="l3.2508" class="difflineminus">-        {</span>
<a href="#l3.2509"></a><span id="l3.2509" class="difflineminus">-          messageFlags |= kImapMsgForwardedFlag;</span>
<a href="#l3.2510"></a><span id="l3.2510" class="difflineminus">-          knownFlag = true;</span>
<a href="#l3.2511"></a><span id="l3.2511" class="difflineminus">-        }</span>
<a href="#l3.2512"></a><span id="l3.2512" class="difflineminus">-        break;</span>
<a href="#l3.2513"></a><span id="l3.2513" class="difflineminus">-      default:</span>
<a href="#l3.2514"></a><span id="l3.2514" class="difflineminus">-        break;</span>
<a href="#l3.2515"></a><span id="l3.2515" class="difflineminus">-      }</span>
<a href="#l3.2516"></a><span id="l3.2516" class="difflineminus">-    }</span>
<a href="#l3.2517"></a><span id="l3.2517" class="difflineminus">-    if (!knownFlag &amp;&amp; fFlagState)</span>
<a href="#l3.2518"></a><span id="l3.2518" class="difflineminus">-    {</span>
<a href="#l3.2519"></a><span id="l3.2519" class="difflineplus">+    if (!knownFlag &amp;&amp; fFlagState) {</span>
<a href="#l3.2520"></a><span id="l3.2520">       nsAutoCString flag(fNextToken);</span>
<a href="#l3.2521"></a><span id="l3.2521">       int32_t parenIndex = flag.FindChar(')');</span>
<a href="#l3.2522"></a><span id="l3.2522" class="difflineminus">-      if (parenIndex &gt; 0)</span>
<a href="#l3.2523"></a><span id="l3.2523" class="difflineminus">-        flag.SetLength(parenIndex);</span>
<a href="#l3.2524"></a><span id="l3.2524" class="difflineplus">+      if (parenIndex &gt; 0) flag.SetLength(parenIndex);</span>
<a href="#l3.2525"></a><span id="l3.2525">       messageFlags |= kImapMsgCustomKeywordFlag;</span>
<a href="#l3.2526"></a><span id="l3.2526">       if (CurrentResponseUID() != nsMsgKey_None &amp;&amp; CurrentResponseUID() != 0)</span>
<a href="#l3.2527"></a><span id="l3.2527">         fFlagState-&gt;AddUidCustomFlagPair(CurrentResponseUID(), flag.get());</span>
<a href="#l3.2528"></a><span id="l3.2528">       else</span>
<a href="#l3.2529"></a><span id="l3.2529">         fCustomFlags.AppendElement(flag);</span>
<a href="#l3.2530"></a><span id="l3.2530">     }</span>
<a href="#l3.2531"></a><span id="l3.2531" class="difflineminus">-    if (PL_strcasestr(fNextToken, &quot;)&quot;))</span>
<a href="#l3.2532"></a><span id="l3.2532" class="difflineminus">-    {</span>
<a href="#l3.2533"></a><span id="l3.2533" class="difflineplus">+    if (PL_strcasestr(fNextToken, &quot;)&quot;)) {</span>
<a href="#l3.2534"></a><span id="l3.2534">       // eat token chars until we get the ')'</span>
<a href="#l3.2535"></a><span id="l3.2535" class="difflineminus">-      while (*fNextToken != ')')</span>
<a href="#l3.2536"></a><span id="l3.2536" class="difflineminus">-        fNextToken++;</span>
<a href="#l3.2537"></a><span id="l3.2537" class="difflineminus">-    }</span>
<a href="#l3.2538"></a><span id="l3.2538" class="difflineminus">-    else</span>
<a href="#l3.2539"></a><span id="l3.2539" class="difflineplus">+      while (*fNextToken != ')') fNextToken++;</span>
<a href="#l3.2540"></a><span id="l3.2540" class="difflineplus">+    } else</span>
<a href="#l3.2541"></a><span id="l3.2541">       AdvanceToNextToken();</span>
<a href="#l3.2542"></a><span id="l3.2542">   }</span>
<a href="#l3.2543"></a><span id="l3.2543"> </span>
<a href="#l3.2544"></a><span id="l3.2544">   if (ContinueParse())</span>
<a href="#l3.2545"></a><span id="l3.2545" class="difflineminus">-    while(*fNextToken != ')')</span>
<a href="#l3.2546"></a><span id="l3.2546" class="difflineminus">-      fNextToken++;</span>
<a href="#l3.2547"></a><span id="l3.2547" class="difflineplus">+    while (*fNextToken != ')') fNextToken++;</span>
<a href="#l3.2548"></a><span id="l3.2548"> </span>
<a href="#l3.2549"></a><span id="l3.2549">   fCurrentLineContainedFlagInfo = true;  // handled in PostProcessEndOfLine</span>
<a href="#l3.2550"></a><span id="l3.2550">   fSavedFlagInfo = messageFlags;</span>
<a href="#l3.2551"></a><span id="l3.2551"> }</span>
<a href="#l3.2552"></a><span id="l3.2552"> </span>
<a href="#l3.2553"></a><span id="l3.2553"> // RFC3501:  resp-cond-state = (&quot;OK&quot; / &quot;NO&quot; / &quot;BAD&quot;) SP resp-text</span>
<a href="#l3.2554"></a><span id="l3.2554"> //                             ; Status condition</span>
<a href="#l3.2555"></a><span id="l3.2555" class="difflineminus">-void nsImapServerResponseParser::resp_cond_state(bool isTagged)</span>
<a href="#l3.2556"></a><span id="l3.2556" class="difflineminus">-{</span>
<a href="#l3.2557"></a><span id="l3.2557" class="difflineplus">+void nsImapServerResponseParser::resp_cond_state(bool isTagged) {</span>
<a href="#l3.2558"></a><span id="l3.2558">   // According to RFC3501, Sec. 7.1, the untagged NO response &quot;indicates a</span>
<a href="#l3.2559"></a><span id="l3.2559">   // warning; the command can still complete successfully.&quot;</span>
<a href="#l3.2560"></a><span id="l3.2560">   // However, the untagged BAD response &quot;indicates a protocol-level error for</span>
<a href="#l3.2561"></a><span id="l3.2561">   // which the associated command can not be determined; it can also indicate an</span>
<a href="#l3.2562"></a><span id="l3.2562">   // internal server failure.&quot;</span>
<a href="#l3.2563"></a><span id="l3.2563">   // Thus, we flag an error for a tagged NO response and for any BAD response.</span>
<a href="#l3.2564"></a><span id="l3.2564">   if ((isTagged &amp;&amp; !PL_strcasecmp(fNextToken, &quot;NO&quot;)) ||</span>
<a href="#l3.2565"></a><span id="l3.2565">       !PL_strcasecmp(fNextToken, &quot;BAD&quot;))</span>
<a href="#l3.2566"></a><span id="l3.2566">     fCurrentCommandFailed = true;</span>
<a href="#l3.2567"></a><span id="l3.2567"> </span>
<a href="#l3.2568"></a><span id="l3.2568">   AdvanceToNextToken();</span>
<a href="#l3.2569"></a><span id="l3.2569" class="difflineminus">-  if (ContinueParse())</span>
<a href="#l3.2570"></a><span id="l3.2570" class="difflineminus">-    resp_text();</span>
<a href="#l3.2571"></a><span id="l3.2571" class="difflineplus">+  if (ContinueParse()) resp_text();</span>
<a href="#l3.2572"></a><span id="l3.2572"> }</span>
<a href="#l3.2573"></a><span id="l3.2573"> </span>
<a href="#l3.2574"></a><span id="l3.2574"> /*</span>
<a href="#l3.2575"></a><span id="l3.2575"> resp_text       ::= [&quot;[&quot; resp_text_code &quot;]&quot; SPACE] (text_mime2 / text)</span>
<a href="#l3.2576"></a><span id="l3.2576"> </span>
<a href="#l3.2577"></a><span id="l3.2577">   was changed to in order to enable a one symbol look ahead predictive</span>
<a href="#l3.2578"></a><span id="l3.2578">   parser.</span>
<a href="#l3.2579"></a><span id="l3.2579"> </span>
<a href="#l3.2580"></a><span id="l3.2580">     resp_text       ::= [&quot;[&quot; resp_text_code  SPACE] (text_mime2 / text)</span>
<a href="#l3.2581"></a><span id="l3.2581"> */</span>
<a href="#l3.2582"></a><span id="l3.2582" class="difflineminus">-void nsImapServerResponseParser::resp_text()</span>
<a href="#l3.2583"></a><span id="l3.2583" class="difflineminus">-{</span>
<a href="#l3.2584"></a><span id="l3.2584" class="difflineminus">-  if (ContinueParse() &amp;&amp; (*fNextToken == '['))</span>
<a href="#l3.2585"></a><span id="l3.2585" class="difflineminus">-    resp_text_code();</span>
<a href="#l3.2586"></a><span id="l3.2586" class="difflineplus">+void nsImapServerResponseParser::resp_text() {</span>
<a href="#l3.2587"></a><span id="l3.2587" class="difflineplus">+  if (ContinueParse() &amp;&amp; (*fNextToken == '[')) resp_text_code();</span>
<a href="#l3.2588"></a><span id="l3.2588"> </span>
<a href="#l3.2589"></a><span id="l3.2589" class="difflineminus">-  if (ContinueParse())</span>
<a href="#l3.2590"></a><span id="l3.2590" class="difflineminus">-  {</span>
<a href="#l3.2591"></a><span id="l3.2591" class="difflineplus">+  if (ContinueParse()) {</span>
<a href="#l3.2592"></a><span id="l3.2592">     if (!PL_strcmp(fNextToken, &quot;=?&quot;))</span>
<a href="#l3.2593"></a><span id="l3.2593">       text_mime2();</span>
<a href="#l3.2594"></a><span id="l3.2594">     else</span>
<a href="#l3.2595"></a><span id="l3.2595">       text();</span>
<a href="#l3.2596"></a><span id="l3.2596">   }</span>
<a href="#l3.2597"></a><span id="l3.2597"> }</span>
<a href="#l3.2598"></a><span id="l3.2598"> /*</span>
<a href="#l3.2599"></a><span id="l3.2599">  text_mime2       ::= &quot;=?&quot; &lt;charset&gt; &quot;?&quot; &lt;encoding&gt; &quot;?&quot;</span>
<a href="#l3.2600"></a><span id="l3.2600">                                &lt;encoded-text&gt; &quot;?=&quot;</span>
<a href="#l3.2601"></a><span id="l3.2601">                                ;; Syntax defined in [MIME-2]</span>
<a href="#l3.2602"></a><span id="l3.2602"> */</span>
<a href="#l3.2603"></a><span id="l3.2603" class="difflineminus">-void nsImapServerResponseParser::text_mime2()</span>
<a href="#l3.2604"></a><span id="l3.2604" class="difflineminus">-{</span>
<a href="#l3.2605"></a><span id="l3.2605" class="difflineminus">-  skip_to_CRLF();</span>
<a href="#l3.2606"></a><span id="l3.2606" class="difflineminus">-}</span>
<a href="#l3.2607"></a><span id="l3.2607" class="difflineplus">+void nsImapServerResponseParser::text_mime2() { skip_to_CRLF(); }</span>
<a href="#l3.2608"></a><span id="l3.2608"> </span>
<a href="#l3.2609"></a><span id="l3.2609"> /*</span>
<a href="#l3.2610"></a><span id="l3.2610">  text            ::= 1*TEXT_CHAR</span>
<a href="#l3.2611"></a><span id="l3.2611"> </span>
<a href="#l3.2612"></a><span id="l3.2612"> */</span>
<a href="#l3.2613"></a><span id="l3.2613" class="difflineminus">-void nsImapServerResponseParser::text()</span>
<a href="#l3.2614"></a><span id="l3.2614" class="difflineminus">-{</span>
<a href="#l3.2615"></a><span id="l3.2615" class="difflineminus">-  skip_to_CRLF();</span>
<a href="#l3.2616"></a><span id="l3.2616" class="difflineminus">-}</span>
<a href="#l3.2617"></a><span id="l3.2617" class="difflineplus">+void nsImapServerResponseParser::text() { skip_to_CRLF(); }</span>
<a href="#l3.2618"></a><span id="l3.2618"> </span>
<a href="#l3.2619"></a><span id="l3.2619" class="difflineminus">-void nsImapServerResponseParser::parse_folder_flags(bool calledForFlags)</span>
<a href="#l3.2620"></a><span id="l3.2620" class="difflineminus">-{</span>
<a href="#l3.2621"></a><span id="l3.2621" class="difflineplus">+void nsImapServerResponseParser::parse_folder_flags(bool calledForFlags) {</span>
<a href="#l3.2622"></a><span id="l3.2622">   uint16_t labelFlags = 0;</span>
<a href="#l3.2623"></a><span id="l3.2623">   uint16_t junkNotJunkFlags = 0;</span>
<a href="#l3.2624"></a><span id="l3.2624">   bool storeUserFlags = calledForFlags &amp;&amp; fFlagState;</span>
<a href="#l3.2625"></a><span id="l3.2625">   uint16_t numOtherKeywords = 0;</span>
<a href="#l3.2626"></a><span id="l3.2626"> </span>
<a href="#l3.2627"></a><span id="l3.2627" class="difflineminus">-  do</span>
<a href="#l3.2628"></a><span id="l3.2628" class="difflineminus">-  {</span>
<a href="#l3.2629"></a><span id="l3.2629" class="difflineplus">+  do {</span>
<a href="#l3.2630"></a><span id="l3.2630">     AdvanceToNextToken();</span>
<a href="#l3.2631"></a><span id="l3.2631" class="difflineminus">-    if (*fNextToken == '(')</span>
<a href="#l3.2632"></a><span id="l3.2632" class="difflineminus">-      fNextToken++;</span>
<a href="#l3.2633"></a><span id="l3.2633" class="difflineplus">+    if (*fNextToken == '(') fNextToken++;</span>
<a href="#l3.2634"></a><span id="l3.2634">     if (!PL_strncasecmp(fNextToken, &quot;\\Seen&quot;, 5))</span>
<a href="#l3.2635"></a><span id="l3.2635">       fSettablePermanentFlags |= kImapMsgSeenFlag;</span>
<a href="#l3.2636"></a><span id="l3.2636">     else if (!PL_strncasecmp(fNextToken, &quot;\\Answered&quot;, 9))</span>
<a href="#l3.2637"></a><span id="l3.2637">       fSettablePermanentFlags |= kImapMsgAnsweredFlag;</span>
<a href="#l3.2638"></a><span id="l3.2638">     else if (!PL_strncasecmp(fNextToken, &quot;\\Flagged&quot;, 8))</span>
<a href="#l3.2639"></a><span id="l3.2639">       fSettablePermanentFlags |= kImapMsgFlaggedFlag;</span>
<a href="#l3.2640"></a><span id="l3.2640">     else if (!PL_strncasecmp(fNextToken, &quot;\\Deleted&quot;, 8))</span>
<a href="#l3.2641"></a><span id="l3.2641">       fSettablePermanentFlags |= kImapMsgDeletedFlag;</span>
<a href="#l3.2642"></a><span id="l3.2642">     else if (!PL_strncasecmp(fNextToken, &quot;\\Draft&quot;, 6))</span>
<a href="#l3.2643"></a><span id="l3.2643">       fSettablePermanentFlags |= kImapMsgDraftFlag;</span>
<a href="#l3.2644"></a><span id="l3.2644" class="difflineminus">-    else if (!PL_strncasecmp(fNextToken, &quot;\\*&quot;, 2))</span>
<a href="#l3.2645"></a><span id="l3.2645" class="difflineminus">-    {</span>
<a href="#l3.2646"></a><span id="l3.2646" class="difflineplus">+    else if (!PL_strncasecmp(fNextToken, &quot;\\*&quot;, 2)) {</span>
<a href="#l3.2647"></a><span id="l3.2647">       // User defined and special keywords (tags) can be defined and set for</span>
<a href="#l3.2648"></a><span id="l3.2648">       // mailbox. Should only occur in PERMANENTFLAGS response.</span>
<a href="#l3.2649"></a><span id="l3.2649">       fSupportsUserDefinedFlags |= kImapMsgSupportUserFlag;</span>
<a href="#l3.2650"></a><span id="l3.2650">       fSupportsUserDefinedFlags |= kImapMsgSupportForwardedFlag;</span>
<a href="#l3.2651"></a><span id="l3.2651">       fSupportsUserDefinedFlags |= kImapMsgSupportMDNSentFlag;</span>
<a href="#l3.2652"></a><span id="l3.2652">       fSupportsUserDefinedFlags |= kImapMsgLabelFlags;</span>
<a href="#l3.2653"></a><span id="l3.2653" class="difflineminus">-    }</span>
<a href="#l3.2654"></a><span id="l3.2654" class="difflineminus">-    else</span>
<a href="#l3.2655"></a><span id="l3.2655" class="difflineminus">-    {</span>
<a href="#l3.2656"></a><span id="l3.2656" class="difflineplus">+    } else {</span>
<a href="#l3.2657"></a><span id="l3.2657">       // Treat special and built-in $LabelX's as user defined if a</span>
<a href="#l3.2658"></a><span id="l3.2658">       // store occurs below. Include $Junk/$NotJunk in this too.</span>
<a href="#l3.2659"></a><span id="l3.2659">       if (!PL_strncasecmp(fNextToken, &quot;$MDNSent&quot;, 8))</span>
<a href="#l3.2660"></a><span id="l3.2660">         fSupportsUserDefinedFlags |= kImapMsgSupportMDNSentFlag;</span>
<a href="#l3.2661"></a><span id="l3.2661">       else if (!PL_strncasecmp(fNextToken, &quot;$Forwarded&quot;, 10))</span>
<a href="#l3.2662"></a><span id="l3.2662">         fSupportsUserDefinedFlags |= kImapMsgSupportForwardedFlag;</span>
<a href="#l3.2663"></a><span id="l3.2663">       else if (!PL_strncasecmp(fNextToken, &quot;$Label1&quot;, 7))</span>
<a href="#l3.2664"></a><span id="l3.2664">         labelFlags |= 1;</span>
<a href="#l3.2665"></a><span id="l3.2665" class="difflineat">@@ -1906,41 +1642,36 @@ void nsImapServerResponseParser::parse_f</span>
<a href="#l3.2666"></a><span id="l3.2666">         junkNotJunkFlags |= 2;</span>
<a href="#l3.2667"></a><span id="l3.2667"> </span>
<a href="#l3.2668"></a><span id="l3.2668">       // Store user keywords defined for mailbox, usually by other clients.</span>
<a href="#l3.2669"></a><span id="l3.2669">       // But only do this for FLAGS response, not PERMANENTFLAGS response.</span>
<a href="#l3.2670"></a><span id="l3.2670">       // This is only needed if '\*' does not appear in a PERMANENTFLAGS</span>
<a href="#l3.2671"></a><span id="l3.2671">       // response indicating the user defined keywords are not allowed. But this</span>
<a href="#l3.2672"></a><span id="l3.2672">       // is not known until this function is called for PERMANENTFLAGS which</span>
<a href="#l3.2673"></a><span id="l3.2673">       // typically occurs after FLAGS, so must store them regardless.</span>
<a href="#l3.2674"></a><span id="l3.2674" class="difflineminus">-      if (storeUserFlags &amp;&amp; *fNextToken != '\r')</span>
<a href="#l3.2675"></a><span id="l3.2675" class="difflineminus">-      {</span>
<a href="#l3.2676"></a><span id="l3.2676" class="difflineminus">-        if (*(fNextToken + strlen(fNextToken) - 1) != ')')</span>
<a href="#l3.2677"></a><span id="l3.2677" class="difflineminus">-        {</span>
<a href="#l3.2678"></a><span id="l3.2678" class="difflineplus">+      if (storeUserFlags &amp;&amp; *fNextToken != '\r') {</span>
<a href="#l3.2679"></a><span id="l3.2679" class="difflineplus">+        if (*(fNextToken + strlen(fNextToken) - 1) != ')') {</span>
<a href="#l3.2680"></a><span id="l3.2680">           // Token doesn't end in ')' so save it as is.</span>
<a href="#l3.2681"></a><span id="l3.2681" class="difflineminus">-          fFlagState-&gt;SetOtherKeywords(numOtherKeywords++, nsDependentCString(fNextToken));</span>
<a href="#l3.2682"></a><span id="l3.2682" class="difflineminus">-        }</span>
<a href="#l3.2683"></a><span id="l3.2683" class="difflineminus">-        else</span>
<a href="#l3.2684"></a><span id="l3.2684" class="difflineminus">-        {</span>
<a href="#l3.2685"></a><span id="l3.2685" class="difflineplus">+          fFlagState-&gt;SetOtherKeywords(numOtherKeywords++,</span>
<a href="#l3.2686"></a><span id="l3.2686" class="difflineplus">+                                       nsDependentCString(fNextToken));</span>
<a href="#l3.2687"></a><span id="l3.2687" class="difflineplus">+        } else {</span>
<a href="#l3.2688"></a><span id="l3.2688">           // Token ends in ')' so end of list. Save all but ending ')'.</span>
<a href="#l3.2689"></a><span id="l3.2689" class="difflineminus">-          fFlagState-&gt;SetOtherKeywords(numOtherKeywords++,</span>
<a href="#l3.2690"></a><span id="l3.2690" class="difflineminus">-                                       nsDependentCSubstring(fNextToken, strlen(fNextToken) - 1));</span>
<a href="#l3.2691"></a><span id="l3.2691" class="difflineplus">+          fFlagState-&gt;SetOtherKeywords(</span>
<a href="#l3.2692"></a><span id="l3.2692" class="difflineplus">+              numOtherKeywords++,</span>
<a href="#l3.2693"></a><span id="l3.2693" class="difflineplus">+              nsDependentCSubstring(fNextToken, strlen(fNextToken) - 1));</span>
<a href="#l3.2694"></a><span id="l3.2694">         }</span>
<a href="#l3.2695"></a><span id="l3.2695">       }</span>
<a href="#l3.2696"></a><span id="l3.2696">     }</span>
<a href="#l3.2697"></a><span id="l3.2697">   } while (!fAtEndOfLine &amp;&amp; ContinueParse());</span>
<a href="#l3.2698"></a><span id="l3.2698"> </span>
<a href="#l3.2699"></a><span id="l3.2699" class="difflineminus">-  if (labelFlags == 31)</span>
<a href="#l3.2700"></a><span id="l3.2700" class="difflineminus">-    fSupportsUserDefinedFlags |= kImapMsgLabelFlags;</span>
<a href="#l3.2701"></a><span id="l3.2701" class="difflineplus">+  if (labelFlags == 31) fSupportsUserDefinedFlags |= kImapMsgLabelFlags;</span>
<a href="#l3.2702"></a><span id="l3.2702"> </span>
<a href="#l3.2703"></a><span id="l3.2703" class="difflineminus">-  if (fFlagState)</span>
<a href="#l3.2704"></a><span id="l3.2704" class="difflineminus">-    fFlagState-&gt;OrSupportedUserFlags(fSupportsUserDefinedFlags);</span>
<a href="#l3.2705"></a><span id="l3.2705" class="difflineplus">+  if (fFlagState) fFlagState-&gt;OrSupportedUserFlags(fSupportsUserDefinedFlags);</span>
<a href="#l3.2706"></a><span id="l3.2706"> </span>
<a href="#l3.2707"></a><span id="l3.2707" class="difflineminus">-  if (storeUserFlags)</span>
<a href="#l3.2708"></a><span id="l3.2708" class="difflineminus">-  {</span>
<a href="#l3.2709"></a><span id="l3.2709" class="difflineplus">+  if (storeUserFlags) {</span>
<a href="#l3.2710"></a><span id="l3.2710">     // Set true if both &quot;$Junk&quot; and &quot;$NotJunk&quot; appear in FLAGS.</span>
<a href="#l3.2711"></a><span id="l3.2711">     fStdJunkNotJunkUseOk = (junkNotJunkFlags == 3);</span>
<a href="#l3.2712"></a><span id="l3.2712">   }</span>
<a href="#l3.2713"></a><span id="l3.2713"> }</span>
<a href="#l3.2714"></a><span id="l3.2714"> /*</span>
<a href="#l3.2715"></a><span id="l3.2715">   resp_text_code  ::= (&quot;ALERT&quot; / &quot;PARSE&quot; /</span>
<a href="#l3.2716"></a><span id="l3.2716">                               &quot;PERMANENTFLAGS&quot; SPACE &quot;(&quot; #(flag / &quot;\*&quot;) &quot;)&quot; /</span>
<a href="#l3.2717"></a><span id="l3.2717">                               &quot;READ-ONLY&quot; / &quot;READ-WRITE&quot; / &quot;TRYCREATE&quot; /</span>
<a href="#l3.2718"></a><span id="l3.2718" class="difflineat">@@ -1948,976 +1679,812 @@ void nsImapServerResponseParser::parse_f</span>
<a href="#l3.2719"></a><span id="l3.2719">                               &quot;UNSEEN&quot; SPACE nz_number /</span>
<a href="#l3.2720"></a><span id="l3.2720">                               &quot;HIGHESTMODSEQ&quot; SPACE nz_number /</span>
<a href="#l3.2721"></a><span id="l3.2721">                               &quot;NOMODSEQ&quot; /</span>
<a href="#l3.2722"></a><span id="l3.2722">                               atom [SPACE 1*&lt;any TEXT_CHAR except &quot;]&quot;&gt;] )</span>
<a href="#l3.2723"></a><span id="l3.2723">                       &quot;]&quot;</span>
<a href="#l3.2724"></a><span id="l3.2724"> </span>
<a href="#l3.2725"></a><span id="l3.2725"> </span>
<a href="#l3.2726"></a><span id="l3.2726"> */</span>
<a href="#l3.2727"></a><span id="l3.2727" class="difflineminus">-void nsImapServerResponseParser::resp_text_code()</span>
<a href="#l3.2728"></a><span id="l3.2728" class="difflineminus">-{</span>
<a href="#l3.2729"></a><span id="l3.2729" class="difflineplus">+void nsImapServerResponseParser::resp_text_code() {</span>
<a href="#l3.2730"></a><span id="l3.2730">   // this is a special case way of advancing the token</span>
<a href="#l3.2731"></a><span id="l3.2731">   // strtok won't break up &quot;[ALERT]&quot; into separate tokens</span>
<a href="#l3.2732"></a><span id="l3.2732">   if (strlen(fNextToken) &gt; 1)</span>
<a href="#l3.2733"></a><span id="l3.2733">     fNextToken++;</span>
<a href="#l3.2734"></a><span id="l3.2734">   else</span>
<a href="#l3.2735"></a><span id="l3.2735">     AdvanceToNextToken();</span>
<a href="#l3.2736"></a><span id="l3.2736"> </span>
<a href="#l3.2737"></a><span id="l3.2737" class="difflineminus">-  if (ContinueParse())</span>
<a href="#l3.2738"></a><span id="l3.2738" class="difflineminus">-  {</span>
<a href="#l3.2739"></a><span id="l3.2739" class="difflineminus">-    if (!PL_strcasecmp(fNextToken,&quot;ALERT]&quot;))</span>
<a href="#l3.2740"></a><span id="l3.2740" class="difflineminus">-    {</span>
<a href="#l3.2741"></a><span id="l3.2741" class="difflineplus">+  if (ContinueParse()) {</span>
<a href="#l3.2742"></a><span id="l3.2742" class="difflineplus">+    if (!PL_strcasecmp(fNextToken, &quot;ALERT]&quot;)) {</span>
<a href="#l3.2743"></a><span id="l3.2743">       char *alertMsg = fCurrentTokenPlaceHolder;  // advance past ALERT]</span>
<a href="#l3.2744"></a><span id="l3.2744" class="difflineminus">-      if (alertMsg &amp;&amp; *alertMsg &amp;&amp; (!fLastAlert || PL_strcmp(fNextToken, fLastAlert)))</span>
<a href="#l3.2745"></a><span id="l3.2745" class="difflineminus">-      {</span>
<a href="#l3.2746"></a><span id="l3.2746" class="difflineplus">+      if (alertMsg &amp;&amp; *alertMsg &amp;&amp;</span>
<a href="#l3.2747"></a><span id="l3.2747" class="difflineplus">+          (!fLastAlert || PL_strcmp(fNextToken, fLastAlert))) {</span>
<a href="#l3.2748"></a><span id="l3.2748">         fServerConnection.AlertUserEvent(alertMsg);</span>
<a href="#l3.2749"></a><span id="l3.2749">         PR_Free(fLastAlert);</span>
<a href="#l3.2750"></a><span id="l3.2750">         fLastAlert = PL_strdup(alertMsg);</span>
<a href="#l3.2751"></a><span id="l3.2751">       }</span>
<a href="#l3.2752"></a><span id="l3.2752">       AdvanceToNextToken();</span>
<a href="#l3.2753"></a><span id="l3.2753" class="difflineminus">-    }</span>
<a href="#l3.2754"></a><span id="l3.2754" class="difflineminus">-    else if (!PL_strcasecmp(fNextToken,&quot;PARSE]&quot;))</span>
<a href="#l3.2755"></a><span id="l3.2755" class="difflineminus">-    {</span>
<a href="#l3.2756"></a><span id="l3.2756" class="difflineplus">+    } else if (!PL_strcasecmp(fNextToken, &quot;PARSE]&quot;)) {</span>
<a href="#l3.2757"></a><span id="l3.2757">       // do nothing for now</span>
<a href="#l3.2758"></a><span id="l3.2758">       AdvanceToNextToken();</span>
<a href="#l3.2759"></a><span id="l3.2759" class="difflineminus">-    }</span>
<a href="#l3.2760"></a><span id="l3.2760" class="difflineminus">-    else if (!PL_strcasecmp(fNextToken,&quot;NETSCAPE]&quot;))</span>
<a href="#l3.2761"></a><span id="l3.2761" class="difflineminus">-    {</span>
<a href="#l3.2762"></a><span id="l3.2762" class="difflineplus">+    } else if (!PL_strcasecmp(fNextToken, &quot;NETSCAPE]&quot;)) {</span>
<a href="#l3.2763"></a><span id="l3.2763">       skip_to_CRLF();</span>
<a href="#l3.2764"></a><span id="l3.2764" class="difflineminus">-    }</span>
<a href="#l3.2765"></a><span id="l3.2765" class="difflineminus">-    else if (!PL_strcasecmp(fNextToken,&quot;PERMANENTFLAGS&quot;))</span>
<a href="#l3.2766"></a><span id="l3.2766" class="difflineminus">-    {</span>
<a href="#l3.2767"></a><span id="l3.2767" class="difflineplus">+    } else if (!PL_strcasecmp(fNextToken, &quot;PERMANENTFLAGS&quot;)) {</span>
<a href="#l3.2768"></a><span id="l3.2768">       uint32_t saveSettableFlags = fSettablePermanentFlags;</span>
<a href="#l3.2769"></a><span id="l3.2769">       fSupportsUserDefinedFlags = 0;  // assume no unless told</span>
<a href="#l3.2770"></a><span id="l3.2770" class="difflineminus">-      fSettablePermanentFlags = 0;            // assume none, unless told otherwise.</span>
<a href="#l3.2771"></a><span id="l3.2771" class="difflineplus">+      fSettablePermanentFlags = 0;    // assume none, unless told otherwise.</span>
<a href="#l3.2772"></a><span id="l3.2772">       parse_folder_flags(false);</span>
<a href="#l3.2773"></a><span id="l3.2773">       // if the server tells us there are no permanent flags, we're</span>
<a href="#l3.2774"></a><span id="l3.2774">       // just going to pretend that the FLAGS response flags, if any, are</span>
<a href="#l3.2775"></a><span id="l3.2775">       // permanent in case the server is broken. This will allow us</span>
<a href="#l3.2776"></a><span id="l3.2776">       // to store delete and seen flag changes - if they're not permanent,</span>
<a href="#l3.2777"></a><span id="l3.2777">       // they're not permanent, but at least we'll try to set them.</span>
<a href="#l3.2778"></a><span id="l3.2778" class="difflineminus">-      if (!fSettablePermanentFlags)</span>
<a href="#l3.2779"></a><span id="l3.2779" class="difflineminus">-        fSettablePermanentFlags = saveSettableFlags;</span>
<a href="#l3.2780"></a><span id="l3.2780" class="difflineplus">+      if (!fSettablePermanentFlags) fSettablePermanentFlags = saveSettableFlags;</span>
<a href="#l3.2781"></a><span id="l3.2781">       fGotPermanentFlags = true;</span>
<a href="#l3.2782"></a><span id="l3.2782" class="difflineminus">-    }</span>
<a href="#l3.2783"></a><span id="l3.2783" class="difflineminus">-    else if (!PL_strcasecmp(fNextToken,&quot;READ-ONLY]&quot;))</span>
<a href="#l3.2784"></a><span id="l3.2784" class="difflineminus">-    {</span>
<a href="#l3.2785"></a><span id="l3.2785" class="difflineplus">+    } else if (!PL_strcasecmp(fNextToken, &quot;READ-ONLY]&quot;)) {</span>
<a href="#l3.2786"></a><span id="l3.2786">       fCurrentFolderReadOnly = true;</span>
<a href="#l3.2787"></a><span id="l3.2787">       AdvanceToNextToken();</span>
<a href="#l3.2788"></a><span id="l3.2788" class="difflineminus">-    }</span>
<a href="#l3.2789"></a><span id="l3.2789" class="difflineminus">-    else if (!PL_strcasecmp(fNextToken,&quot;READ-WRITE]&quot;))</span>
<a href="#l3.2790"></a><span id="l3.2790" class="difflineminus">-    {</span>
<a href="#l3.2791"></a><span id="l3.2791" class="difflineplus">+    } else if (!PL_strcasecmp(fNextToken, &quot;READ-WRITE]&quot;)) {</span>
<a href="#l3.2792"></a><span id="l3.2792">       fCurrentFolderReadOnly = false;</span>
<a href="#l3.2793"></a><span id="l3.2793">       AdvanceToNextToken();</span>
<a href="#l3.2794"></a><span id="l3.2794" class="difflineminus">-    }</span>
<a href="#l3.2795"></a><span id="l3.2795" class="difflineminus">-    else if (!PL_strcasecmp(fNextToken,&quot;TRYCREATE]&quot;))</span>
<a href="#l3.2796"></a><span id="l3.2796" class="difflineminus">-    {</span>
<a href="#l3.2797"></a><span id="l3.2797" class="difflineplus">+    } else if (!PL_strcasecmp(fNextToken, &quot;TRYCREATE]&quot;)) {</span>
<a href="#l3.2798"></a><span id="l3.2798">       // do nothing for now</span>
<a href="#l3.2799"></a><span id="l3.2799">       AdvanceToNextToken();</span>
<a href="#l3.2800"></a><span id="l3.2800" class="difflineminus">-    }</span>
<a href="#l3.2801"></a><span id="l3.2801" class="difflineminus">-    else if (!PL_strcasecmp(fNextToken,&quot;UIDVALIDITY&quot;))</span>
<a href="#l3.2802"></a><span id="l3.2802" class="difflineminus">-    {</span>
<a href="#l3.2803"></a><span id="l3.2803" class="difflineplus">+    } else if (!PL_strcasecmp(fNextToken, &quot;UIDVALIDITY&quot;)) {</span>
<a href="#l3.2804"></a><span id="l3.2804">       AdvanceToNextToken();</span>
<a href="#l3.2805"></a><span id="l3.2805" class="difflineminus">-      if (ContinueParse())</span>
<a href="#l3.2806"></a><span id="l3.2806" class="difflineminus">-      {</span>
<a href="#l3.2807"></a><span id="l3.2807" class="difflineplus">+      if (ContinueParse()) {</span>
<a href="#l3.2808"></a><span id="l3.2808">         fFolderUIDValidity = strtoul(fNextToken, nullptr, 10);</span>
<a href="#l3.2809"></a><span id="l3.2809">         fHighestRecordedUID = 0;</span>
<a href="#l3.2810"></a><span id="l3.2810">         AdvanceToNextToken();</span>
<a href="#l3.2811"></a><span id="l3.2811">       }</span>
<a href="#l3.2812"></a><span id="l3.2812" class="difflineminus">-    }</span>
<a href="#l3.2813"></a><span id="l3.2813" class="difflineminus">-    else if (!PL_strcasecmp(fNextToken,&quot;UNSEEN&quot;))</span>
<a href="#l3.2814"></a><span id="l3.2814" class="difflineminus">-    {</span>
<a href="#l3.2815"></a><span id="l3.2815" class="difflineplus">+    } else if (!PL_strcasecmp(fNextToken, &quot;UNSEEN&quot;)) {</span>
<a href="#l3.2816"></a><span id="l3.2816">       AdvanceToNextToken();</span>
<a href="#l3.2817"></a><span id="l3.2817" class="difflineminus">-      if (ContinueParse())</span>
<a href="#l3.2818"></a><span id="l3.2818" class="difflineminus">-      {</span>
<a href="#l3.2819"></a><span id="l3.2819" class="difflineplus">+      if (ContinueParse()) {</span>
<a href="#l3.2820"></a><span id="l3.2820">         fNumberOfUnseenMessages = strtoul(fNextToken, nullptr, 10);</span>
<a href="#l3.2821"></a><span id="l3.2821">         AdvanceToNextToken();</span>
<a href="#l3.2822"></a><span id="l3.2822">       }</span>
<a href="#l3.2823"></a><span id="l3.2823" class="difflineminus">-    }</span>
<a href="#l3.2824"></a><span id="l3.2824" class="difflineminus">-    else if (!PL_strcasecmp(fNextToken,&quot;UIDNEXT&quot;))</span>
<a href="#l3.2825"></a><span id="l3.2825" class="difflineminus">-    {</span>
<a href="#l3.2826"></a><span id="l3.2826" class="difflineplus">+    } else if (!PL_strcasecmp(fNextToken, &quot;UIDNEXT&quot;)) {</span>
<a href="#l3.2827"></a><span id="l3.2827">       AdvanceToNextToken();</span>
<a href="#l3.2828"></a><span id="l3.2828" class="difflineminus">-      if (ContinueParse())</span>
<a href="#l3.2829"></a><span id="l3.2829" class="difflineminus">-      {</span>
<a href="#l3.2830"></a><span id="l3.2830" class="difflineplus">+      if (ContinueParse()) {</span>
<a href="#l3.2831"></a><span id="l3.2831">         fStatusNextUID = strtoul(fNextToken, nullptr, 10);</span>
<a href="#l3.2832"></a><span id="l3.2832">         AdvanceToNextToken();</span>
<a href="#l3.2833"></a><span id="l3.2833">       }</span>
<a href="#l3.2834"></a><span id="l3.2834" class="difflineminus">-    }</span>
<a href="#l3.2835"></a><span id="l3.2835" class="difflineminus">-    else if (!PL_strcasecmp(fNextToken, &quot;APPENDUID&quot;))</span>
<a href="#l3.2836"></a><span id="l3.2836" class="difflineminus">-    {</span>
<a href="#l3.2837"></a><span id="l3.2837" class="difflineplus">+    } else if (!PL_strcasecmp(fNextToken, &quot;APPENDUID&quot;)) {</span>
<a href="#l3.2838"></a><span id="l3.2838">       AdvanceToNextToken();</span>
<a href="#l3.2839"></a><span id="l3.2839" class="difflineminus">-      if (ContinueParse())</span>
<a href="#l3.2840"></a><span id="l3.2840" class="difflineminus">-      {</span>
<a href="#l3.2841"></a><span id="l3.2841" class="difflineplus">+      if (ContinueParse()) {</span>
<a href="#l3.2842"></a><span id="l3.2842">         // ** jt -- the returned uidvalidity is the destination folder</span>
<a href="#l3.2843"></a><span id="l3.2843">         // uidvalidity; don't use it for current folder</span>
<a href="#l3.2844"></a><span id="l3.2844">         // fFolderUIDValidity = atoi(fNextToken);</span>
<a href="#l3.2845"></a><span id="l3.2845">         // fHighestRecordedUID = 0; ??? this should be wrong</span>
<a href="#l3.2846"></a><span id="l3.2846">         AdvanceToNextToken();</span>
<a href="#l3.2847"></a><span id="l3.2847" class="difflineminus">-        if (ContinueParse())</span>
<a href="#l3.2848"></a><span id="l3.2848" class="difflineminus">-        {</span>
<a href="#l3.2849"></a><span id="l3.2849" class="difflineplus">+        if (ContinueParse()) {</span>
<a href="#l3.2850"></a><span id="l3.2850">           fCurrentResponseUID = strtoul(fNextToken, nullptr, 10);</span>
<a href="#l3.2851"></a><span id="l3.2851">           AdvanceToNextToken();</span>
<a href="#l3.2852"></a><span id="l3.2852">         }</span>
<a href="#l3.2853"></a><span id="l3.2853">       }</span>
<a href="#l3.2854"></a><span id="l3.2854" class="difflineminus">-    }</span>
<a href="#l3.2855"></a><span id="l3.2855" class="difflineminus">-    else if (!PL_strcasecmp(fNextToken, &quot;COPYUID&quot;))</span>
<a href="#l3.2856"></a><span id="l3.2856" class="difflineminus">-    {</span>
<a href="#l3.2857"></a><span id="l3.2857" class="difflineplus">+    } else if (!PL_strcasecmp(fNextToken, &quot;COPYUID&quot;)) {</span>
<a href="#l3.2858"></a><span id="l3.2858">       AdvanceToNextToken();</span>
<a href="#l3.2859"></a><span id="l3.2859" class="difflineminus">-      if (ContinueParse())</span>
<a href="#l3.2860"></a><span id="l3.2860" class="difflineminus">-      {</span>
<a href="#l3.2861"></a><span id="l3.2861" class="difflineplus">+      if (ContinueParse()) {</span>
<a href="#l3.2862"></a><span id="l3.2862">         // ** jt -- destination folder uidvalidity</span>
<a href="#l3.2863"></a><span id="l3.2863">         // fFolderUIDValidity = atoi(fNextToken);</span>
<a href="#l3.2864"></a><span id="l3.2864">         // original message set; ignore it</span>
<a href="#l3.2865"></a><span id="l3.2865">         AdvanceToNextToken();</span>
<a href="#l3.2866"></a><span id="l3.2866" class="difflineminus">-        if (ContinueParse())</span>
<a href="#l3.2867"></a><span id="l3.2867" class="difflineminus">-        {</span>
<a href="#l3.2868"></a><span id="l3.2868" class="difflineplus">+        if (ContinueParse()) {</span>
<a href="#l3.2869"></a><span id="l3.2869">           // the resulting message set; should be in the form of</span>
<a href="#l3.2870"></a><span id="l3.2870">           // either uid or uid1:uid2</span>
<a href="#l3.2871"></a><span id="l3.2871">           AdvanceToNextToken();</span>
<a href="#l3.2872"></a><span id="l3.2872">           // clear copy response uid</span>
<a href="#l3.2873"></a><span id="l3.2873">           fServerConnection.SetCopyResponseUid(fNextToken);</span>
<a href="#l3.2874"></a><span id="l3.2874">         }</span>
<a href="#l3.2875"></a><span id="l3.2875" class="difflineminus">-        if (ContinueParse())</span>
<a href="#l3.2876"></a><span id="l3.2876" class="difflineminus">-          AdvanceToNextToken();</span>
<a href="#l3.2877"></a><span id="l3.2877" class="difflineplus">+        if (ContinueParse()) AdvanceToNextToken();</span>
<a href="#l3.2878"></a><span id="l3.2878">       }</span>
<a href="#l3.2879"></a><span id="l3.2879" class="difflineminus">-    }</span>
<a href="#l3.2880"></a><span id="l3.2880" class="difflineminus">-    else if (!PL_strcasecmp(fNextToken, &quot;HIGHESTMODSEQ&quot;))</span>
<a href="#l3.2881"></a><span id="l3.2881" class="difflineminus">-    {</span>
<a href="#l3.2882"></a><span id="l3.2882" class="difflineplus">+    } else if (!PL_strcasecmp(fNextToken, &quot;HIGHESTMODSEQ&quot;)) {</span>
<a href="#l3.2883"></a><span id="l3.2883">       AdvanceToNextToken();</span>
<a href="#l3.2884"></a><span id="l3.2884" class="difflineminus">-      if (ContinueParse())</span>
<a href="#l3.2885"></a><span id="l3.2885" class="difflineminus">-      {</span>
<a href="#l3.2886"></a><span id="l3.2886" class="difflineplus">+      if (ContinueParse()) {</span>
<a href="#l3.2887"></a><span id="l3.2887">         fHighestModSeq = ParseUint64Str(fNextToken);</span>
<a href="#l3.2888"></a><span id="l3.2888">         fUseModSeq = true;</span>
<a href="#l3.2889"></a><span id="l3.2889">         AdvanceToNextToken();</span>
<a href="#l3.2890"></a><span id="l3.2890">       }</span>
<a href="#l3.2891"></a><span id="l3.2891" class="difflineminus">-    }</span>
<a href="#l3.2892"></a><span id="l3.2892" class="difflineminus">-    else if (!PL_strcasecmp(fNextToken, &quot;NOMODSEQ]&quot;))</span>
<a href="#l3.2893"></a><span id="l3.2893" class="difflineminus">-    {</span>
<a href="#l3.2894"></a><span id="l3.2894" class="difflineplus">+    } else if (!PL_strcasecmp(fNextToken, &quot;NOMODSEQ]&quot;)) {</span>
<a href="#l3.2895"></a><span id="l3.2895">       fHighestModSeq = 0;</span>
<a href="#l3.2896"></a><span id="l3.2896">       fUseModSeq = false;</span>
<a href="#l3.2897"></a><span id="l3.2897">       skip_to_CRLF();</span>
<a href="#l3.2898"></a><span id="l3.2898" class="difflineminus">-    }</span>
<a href="#l3.2899"></a><span id="l3.2899" class="difflineminus">-    else if (!PL_strcasecmp(fNextToken, &quot;CAPABILITY&quot;))</span>
<a href="#l3.2900"></a><span id="l3.2900" class="difflineminus">-    {</span>
<a href="#l3.2901"></a><span id="l3.2901" class="difflineplus">+    } else if (!PL_strcasecmp(fNextToken, &quot;CAPABILITY&quot;)) {</span>
<a href="#l3.2902"></a><span id="l3.2902">       capability_data();</span>
<a href="#l3.2903"></a><span id="l3.2903" class="difflineminus">-    }</span>
<a href="#l3.2904"></a><span id="l3.2904" class="difflineminus">-    else if (!PL_strcasecmp(fNextToken, &quot;MYRIGHTS&quot;))</span>
<a href="#l3.2905"></a><span id="l3.2905" class="difflineminus">-    {</span>
<a href="#l3.2906"></a><span id="l3.2906" class="difflineplus">+    } else if (!PL_strcasecmp(fNextToken, &quot;MYRIGHTS&quot;)) {</span>
<a href="#l3.2907"></a><span id="l3.2907">       myrights_data(true);</span>
<a href="#l3.2908"></a><span id="l3.2908" class="difflineminus">-    }</span>
<a href="#l3.2909"></a><span id="l3.2909" class="difflineminus">-    else // just text</span>
<a href="#l3.2910"></a><span id="l3.2910" class="difflineplus">+    } else  // just text</span>
<a href="#l3.2911"></a><span id="l3.2911">     {</span>
<a href="#l3.2912"></a><span id="l3.2912">       // do nothing but eat tokens until we see the ] or CRLF</span>
<a href="#l3.2913"></a><span id="l3.2913">       // we should see the ] but we don't want to go into an</span>
<a href="#l3.2914"></a><span id="l3.2914">       // endless loop if the CRLF is not there</span>
<a href="#l3.2915"></a><span id="l3.2915" class="difflineminus">-      do</span>
<a href="#l3.2916"></a><span id="l3.2916" class="difflineminus">-      {</span>
<a href="#l3.2917"></a><span id="l3.2917" class="difflineplus">+      do {</span>
<a href="#l3.2918"></a><span id="l3.2918">         AdvanceToNextToken();</span>
<a href="#l3.2919"></a><span id="l3.2919" class="difflineminus">-      } while (!PL_strcasestr(fNextToken, &quot;]&quot;) &amp;&amp; !fAtEndOfLine</span>
<a href="#l3.2920"></a><span id="l3.2920" class="difflineminus">-                &amp;&amp; ContinueParse());</span>
<a href="#l3.2921"></a><span id="l3.2921" class="difflineplus">+      } while (!PL_strcasestr(fNextToken, &quot;]&quot;) &amp;&amp; !fAtEndOfLine &amp;&amp;</span>
<a href="#l3.2922"></a><span id="l3.2922" class="difflineplus">+               ContinueParse());</span>
<a href="#l3.2923"></a><span id="l3.2923">     }</span>
<a href="#l3.2924"></a><span id="l3.2924">   }</span>
<a href="#l3.2925"></a><span id="l3.2925"> }</span>
<a href="#l3.2926"></a><span id="l3.2926"> </span>
<a href="#l3.2927"></a><span id="l3.2927"> // RFC3501:  response-done = response-tagged / response-fatal</span>
<a href="#l3.2928"></a><span id="l3.2928" class="difflineminus">- void nsImapServerResponseParser::response_done()</span>
<a href="#l3.2929"></a><span id="l3.2929" class="difflineminus">- {</span>
<a href="#l3.2930"></a><span id="l3.2930" class="difflineminus">-   if (ContinueParse())</span>
<a href="#l3.2931"></a><span id="l3.2931" class="difflineminus">-   {</span>
<a href="#l3.2932"></a><span id="l3.2932" class="difflineminus">-     if (!PL_strcmp(fCurrentCommandTag, fNextToken))</span>
<a href="#l3.2933"></a><span id="l3.2933" class="difflineminus">-       response_tagged();</span>
<a href="#l3.2934"></a><span id="l3.2934" class="difflineminus">-     else</span>
<a href="#l3.2935"></a><span id="l3.2935" class="difflineminus">-       response_fatal();</span>
<a href="#l3.2936"></a><span id="l3.2936" class="difflineminus">-   }</span>
<a href="#l3.2937"></a><span id="l3.2937" class="difflineminus">- }</span>
<a href="#l3.2938"></a><span id="l3.2938" class="difflineplus">+void nsImapServerResponseParser::response_done() {</span>
<a href="#l3.2939"></a><span id="l3.2939" class="difflineplus">+  if (ContinueParse()) {</span>
<a href="#l3.2940"></a><span id="l3.2940" class="difflineplus">+    if (!PL_strcmp(fCurrentCommandTag, fNextToken))</span>
<a href="#l3.2941"></a><span id="l3.2941" class="difflineplus">+      response_tagged();</span>
<a href="#l3.2942"></a><span id="l3.2942" class="difflineplus">+    else</span>
<a href="#l3.2943"></a><span id="l3.2943" class="difflineplus">+      response_fatal();</span>
<a href="#l3.2944"></a><span id="l3.2944" class="difflineplus">+  }</span>
<a href="#l3.2945"></a><span id="l3.2945" class="difflineplus">+}</span>
<a href="#l3.2946"></a><span id="l3.2946"> </span>
<a href="#l3.2947"></a><span id="l3.2947"> // RFC3501:  response-tagged = tag SP resp-cond-state CRLF</span>
<a href="#l3.2948"></a><span id="l3.2948" class="difflineminus">- void nsImapServerResponseParser::response_tagged()</span>
<a href="#l3.2949"></a><span id="l3.2949" class="difflineminus">- {</span>
<a href="#l3.2950"></a><span id="l3.2950" class="difflineminus">-   // eat the tag</span>
<a href="#l3.2951"></a><span id="l3.2951" class="difflineminus">-   AdvanceToNextToken();</span>
<a href="#l3.2952"></a><span id="l3.2952" class="difflineminus">-   if (ContinueParse())</span>
<a href="#l3.2953"></a><span id="l3.2953" class="difflineminus">-   {</span>
<a href="#l3.2954"></a><span id="l3.2954" class="difflineminus">-     resp_cond_state(true);</span>
<a href="#l3.2955"></a><span id="l3.2955" class="difflineminus">-     if (ContinueParse())</span>
<a href="#l3.2956"></a><span id="l3.2956" class="difflineminus">-     {</span>
<a href="#l3.2957"></a><span id="l3.2957" class="difflineminus">-       if (!fAtEndOfLine)</span>
<a href="#l3.2958"></a><span id="l3.2958" class="difflineminus">-         SetSyntaxError(true);</span>
<a href="#l3.2959"></a><span id="l3.2959" class="difflineminus">-       else if (!fCurrentCommandFailed)</span>
<a href="#l3.2960"></a><span id="l3.2960" class="difflineminus">-         ResetLexAnalyzer();</span>
<a href="#l3.2961"></a><span id="l3.2961" class="difflineminus">-     }</span>
<a href="#l3.2962"></a><span id="l3.2962" class="difflineminus">-   }</span>
<a href="#l3.2963"></a><span id="l3.2963" class="difflineminus">- }</span>
<a href="#l3.2964"></a><span id="l3.2964" class="difflineplus">+void nsImapServerResponseParser::response_tagged() {</span>
<a href="#l3.2965"></a><span id="l3.2965" class="difflineplus">+  // eat the tag</span>
<a href="#l3.2966"></a><span id="l3.2966" class="difflineplus">+  AdvanceToNextToken();</span>
<a href="#l3.2967"></a><span id="l3.2967" class="difflineplus">+  if (ContinueParse()) {</span>
<a href="#l3.2968"></a><span id="l3.2968" class="difflineplus">+    resp_cond_state(true);</span>
<a href="#l3.2969"></a><span id="l3.2969" class="difflineplus">+    if (ContinueParse()) {</span>
<a href="#l3.2970"></a><span id="l3.2970" class="difflineplus">+      if (!fAtEndOfLine)</span>
<a href="#l3.2971"></a><span id="l3.2971" class="difflineplus">+        SetSyntaxError(true);</span>
<a href="#l3.2972"></a><span id="l3.2972" class="difflineplus">+      else if (!fCurrentCommandFailed)</span>
<a href="#l3.2973"></a><span id="l3.2973" class="difflineplus">+        ResetLexAnalyzer();</span>
<a href="#l3.2974"></a><span id="l3.2974" class="difflineplus">+    }</span>
<a href="#l3.2975"></a><span id="l3.2975" class="difflineplus">+  }</span>
<a href="#l3.2976"></a><span id="l3.2976" class="difflineplus">+}</span>
<a href="#l3.2977"></a><span id="l3.2977"> </span>
<a href="#l3.2978"></a><span id="l3.2978"> // RFC3501:  response-fatal = &quot;*&quot; SP resp-cond-bye CRLF</span>
<a href="#l3.2979"></a><span id="l3.2979"> //                              ; Server closes connection immediately</span>
<a href="#l3.2980"></a><span id="l3.2980" class="difflineminus">- void nsImapServerResponseParser::response_fatal()</span>
<a href="#l3.2981"></a><span id="l3.2981" class="difflineminus">- {</span>
<a href="#l3.2982"></a><span id="l3.2982" class="difflineminus">-   // eat the &quot;*&quot;</span>
<a href="#l3.2983"></a><span id="l3.2983" class="difflineminus">-   AdvanceToNextToken();</span>
<a href="#l3.2984"></a><span id="l3.2984" class="difflineminus">-   if (ContinueParse())</span>
<a href="#l3.2985"></a><span id="l3.2985" class="difflineminus">-     resp_cond_bye();</span>
<a href="#l3.2986"></a><span id="l3.2986" class="difflineminus">- }</span>
<a href="#l3.2987"></a><span id="l3.2987" class="difflineplus">+void nsImapServerResponseParser::response_fatal() {</span>
<a href="#l3.2988"></a><span id="l3.2988" class="difflineplus">+  // eat the &quot;*&quot;</span>
<a href="#l3.2989"></a><span id="l3.2989" class="difflineplus">+  AdvanceToNextToken();</span>
<a href="#l3.2990"></a><span id="l3.2990" class="difflineplus">+  if (ContinueParse()) resp_cond_bye();</span>
<a href="#l3.2991"></a><span id="l3.2991" class="difflineplus">+}</span>
<a href="#l3.2992"></a><span id="l3.2992"> </span>
<a href="#l3.2993"></a><span id="l3.2993"> // RFC3501:  resp-cond-bye = &quot;BYE&quot; SP resp-text</span>
<a href="#l3.2994"></a><span id="l3.2994" class="difflineminus">-void nsImapServerResponseParser::resp_cond_bye()</span>
<a href="#l3.2995"></a><span id="l3.2995" class="difflineminus">-{</span>
<a href="#l3.2996"></a><span id="l3.2996" class="difflineplus">+void nsImapServerResponseParser::resp_cond_bye() {</span>
<a href="#l3.2997"></a><span id="l3.2997">   SetConnected(false);</span>
<a href="#l3.2998"></a><span id="l3.2998">   fIMAPstate = kNonAuthenticated;</span>
<a href="#l3.2999"></a><span id="l3.2999"> }</span>
<a href="#l3.3000"></a><span id="l3.3000"> </span>
<a href="#l3.3001"></a><span id="l3.3001" class="difflineminus">-</span>
<a href="#l3.3002"></a><span id="l3.3002" class="difflineminus">-void nsImapServerResponseParser::msg_fetch_headers(const char *partNum)</span>
<a href="#l3.3003"></a><span id="l3.3003" class="difflineminus">-{</span>
<a href="#l3.3004"></a><span id="l3.3004" class="difflineminus">-  if (GetFillingInShell())</span>
<a href="#l3.3005"></a><span id="l3.3005" class="difflineminus">-  {</span>
<a href="#l3.3006"></a><span id="l3.3006" class="difflineplus">+void nsImapServerResponseParser::msg_fetch_headers(const char *partNum) {</span>
<a href="#l3.3007"></a><span id="l3.3007" class="difflineplus">+  if (GetFillingInShell()) {</span>
<a href="#l3.3008"></a><span id="l3.3008">     char *headerData = CreateAstring();</span>
<a href="#l3.3009"></a><span id="l3.3009">     AdvanceToNextToken();</span>
<a href="#l3.3010"></a><span id="l3.3010">     m_shell-&gt;AdoptMessageHeaders(headerData, partNum);</span>
<a href="#l3.3011"></a><span id="l3.3011" class="difflineminus">-  }</span>
<a href="#l3.3012"></a><span id="l3.3012" class="difflineminus">-  else</span>
<a href="#l3.3013"></a><span id="l3.3013" class="difflineminus">-  {</span>
<a href="#l3.3014"></a><span id="l3.3014" class="difflineplus">+  } else {</span>
<a href="#l3.3015"></a><span id="l3.3015">     msg_fetch_content(false, 0, MESSAGE_RFC822);</span>
<a href="#l3.3016"></a><span id="l3.3016">   }</span>
<a href="#l3.3017"></a><span id="l3.3017"> }</span>
<a href="#l3.3018"></a><span id="l3.3018"> </span>
<a href="#l3.3019"></a><span id="l3.3019" class="difflineminus">-</span>
<a href="#l3.3020"></a><span id="l3.3020"> /* nstring         ::= string / nil</span>
<a href="#l3.3021"></a><span id="l3.3021"> string          ::= quoted / literal</span>
<a href="#l3.3022"></a><span id="l3.3022"> nil             ::= &quot;NIL&quot;</span>
<a href="#l3.3023"></a><span id="l3.3023"> </span>
<a href="#l3.3024"></a><span id="l3.3024"> */</span>
<a href="#l3.3025"></a><span id="l3.3025" class="difflineminus">-void nsImapServerResponseParser::msg_fetch_content(bool chunk, int32_t origin, const char *content_type)</span>
<a href="#l3.3026"></a><span id="l3.3026" class="difflineminus">-{</span>
<a href="#l3.3027"></a><span id="l3.3027" class="difflineplus">+void nsImapServerResponseParser::msg_fetch_content(bool chunk, int32_t origin,</span>
<a href="#l3.3028"></a><span id="l3.3028" class="difflineplus">+                                                   const char *content_type) {</span>
<a href="#l3.3029"></a><span id="l3.3029">   // setup the stream for downloading this message.</span>
<a href="#l3.3030"></a><span id="l3.3030">   // Don't do it if we are filling in a shell or downloading a part.</span>
<a href="#l3.3031"></a><span id="l3.3031">   // DO do it if we are downloading a whole message as a result of</span>
<a href="#l3.3032"></a><span id="l3.3032">   // an invalid shell trying to generate.</span>
<a href="#l3.3033"></a><span id="l3.3033">   if ((!chunk || (origin == 0)) &amp;&amp; !GetDownloadingHeaders() &amp;&amp;</span>
<a href="#l3.3034"></a><span id="l3.3034" class="difflineminus">-    (GetFillingInShell() ? m_shell-&gt;GetGeneratingWholeMessage() : true))</span>
<a href="#l3.3035"></a><span id="l3.3035" class="difflineminus">-  {</span>
<a href="#l3.3036"></a><span id="l3.3036" class="difflineminus">-    if (NS_FAILED(BeginMessageDownload(content_type)))</span>
<a href="#l3.3037"></a><span id="l3.3037" class="difflineminus">-      return;</span>
<a href="#l3.3038"></a><span id="l3.3038" class="difflineplus">+      (GetFillingInShell() ? m_shell-&gt;GetGeneratingWholeMessage() : true)) {</span>
<a href="#l3.3039"></a><span id="l3.3039" class="difflineplus">+    if (NS_FAILED(BeginMessageDownload(content_type))) return;</span>
<a href="#l3.3040"></a><span id="l3.3040">   }</span>
<a href="#l3.3041"></a><span id="l3.3041"> </span>
<a href="#l3.3042"></a><span id="l3.3042" class="difflineminus">-  if (PL_strcasecmp(fNextToken, &quot;NIL&quot;))</span>
<a href="#l3.3043"></a><span id="l3.3043" class="difflineminus">-  {</span>
<a href="#l3.3044"></a><span id="l3.3044" class="difflineplus">+  if (PL_strcasecmp(fNextToken, &quot;NIL&quot;)) {</span>
<a href="#l3.3045"></a><span id="l3.3045">     if (*fNextToken == '&quot;')</span>
<a href="#l3.3046"></a><span id="l3.3046">       fLastChunk = msg_fetch_quoted();</span>
<a href="#l3.3047"></a><span id="l3.3047">     else</span>
<a href="#l3.3048"></a><span id="l3.3048">       fLastChunk = msg_fetch_literal(chunk, origin);</span>
<a href="#l3.3049"></a><span id="l3.3049" class="difflineminus">-  }</span>
<a href="#l3.3050"></a><span id="l3.3050" class="difflineminus">-  else</span>
<a href="#l3.3051"></a><span id="l3.3051" class="difflineplus">+  } else</span>
<a href="#l3.3052"></a><span id="l3.3052">     AdvanceToNextToken();  // eat &quot;NIL&quot;</span>
<a href="#l3.3053"></a><span id="l3.3053"> </span>
<a href="#l3.3054"></a><span id="l3.3054" class="difflineminus">-  if (fLastChunk &amp;&amp; (GetFillingInShell() ? m_shell-&gt;GetGeneratingWholeMessage() : true))</span>
<a href="#l3.3055"></a><span id="l3.3055" class="difflineminus">-  {</span>
<a href="#l3.3056"></a><span id="l3.3056" class="difflineplus">+  if (fLastChunk &amp;&amp;</span>
<a href="#l3.3057"></a><span id="l3.3057" class="difflineplus">+      (GetFillingInShell() ? m_shell-&gt;GetGeneratingWholeMessage() : true)) {</span>
<a href="#l3.3058"></a><span id="l3.3058">     // complete the message download</span>
<a href="#l3.3059"></a><span id="l3.3059" class="difflineminus">-    if (ContinueParse())</span>
<a href="#l3.3060"></a><span id="l3.3060" class="difflineminus">-    {</span>
<a href="#l3.3061"></a><span id="l3.3061" class="difflineminus">-      if (fReceivedHeaderOrSizeForUID == CurrentResponseUID())</span>
<a href="#l3.3062"></a><span id="l3.3062" class="difflineminus">-      {</span>
<a href="#l3.3063"></a><span id="l3.3063" class="difflineplus">+    if (ContinueParse()) {</span>
<a href="#l3.3064"></a><span id="l3.3064" class="difflineplus">+      if (fReceivedHeaderOrSizeForUID == CurrentResponseUID()) {</span>
<a href="#l3.3065"></a><span id="l3.3065">         fServerConnection.NormalMessageEndDownload();</span>
<a href="#l3.3066"></a><span id="l3.3066">         fReceivedHeaderOrSizeForUID = nsMsgKey_None;</span>
<a href="#l3.3067"></a><span id="l3.3067" class="difflineminus">-      }</span>
<a href="#l3.3068"></a><span id="l3.3068" class="difflineminus">-      else</span>
<a href="#l3.3069"></a><span id="l3.3069" class="difflineminus">-         fReceivedHeaderOrSizeForUID = CurrentResponseUID();</span>
<a href="#l3.3070"></a><span id="l3.3070" class="difflineminus">-    }</span>
<a href="#l3.3071"></a><span id="l3.3071" class="difflineminus">-    else</span>
<a href="#l3.3072"></a><span id="l3.3072" class="difflineplus">+      } else</span>
<a href="#l3.3073"></a><span id="l3.3073" class="difflineplus">+        fReceivedHeaderOrSizeForUID = CurrentResponseUID();</span>
<a href="#l3.3074"></a><span id="l3.3074" class="difflineplus">+    } else</span>
<a href="#l3.3075"></a><span id="l3.3075">       fServerConnection.AbortMessageDownLoad();</span>
<a href="#l3.3076"></a><span id="l3.3076">   }</span>
<a href="#l3.3077"></a><span id="l3.3077"> }</span>
<a href="#l3.3078"></a><span id="l3.3078"> </span>
<a href="#l3.3079"></a><span id="l3.3079" class="difflineminus">-</span>
<a href="#l3.3080"></a><span id="l3.3080"> /*</span>
<a href="#l3.3081"></a><span id="l3.3081"> quoted          ::= &lt;&quot;&gt; *QUOTED_CHAR &lt;&quot;&gt;</span>
<a href="#l3.3082"></a><span id="l3.3082"> </span>
<a href="#l3.3083"></a><span id="l3.3083">   QUOTED_CHAR     ::= &lt;any TEXT_CHAR except quoted_specials&gt; /</span>
<a href="#l3.3084"></a><span id="l3.3084">   &quot;\&quot; quoted_specials</span>
<a href="#l3.3085"></a><span id="l3.3085"> </span>
<a href="#l3.3086"></a><span id="l3.3086">     quoted_specials ::= &lt;&quot;&gt; / &quot;\&quot;</span>
<a href="#l3.3087"></a><span id="l3.3087"> */</span>
<a href="#l3.3088"></a><span id="l3.3088"> </span>
<a href="#l3.3089"></a><span id="l3.3089" class="difflineminus">-bool nsImapServerResponseParser::msg_fetch_quoted()</span>
<a href="#l3.3090"></a><span id="l3.3090" class="difflineminus">-{</span>
<a href="#l3.3091"></a><span id="l3.3091" class="difflineplus">+bool nsImapServerResponseParser::msg_fetch_quoted() {</span>
<a href="#l3.3092"></a><span id="l3.3092">   // *Should* never get a quoted string in response to a chunked download,</span>
<a href="#l3.3093"></a><span id="l3.3093">   // but the RFCs don't forbid it</span>
<a href="#l3.3094"></a><span id="l3.3094">   char *q = CreateQuoted();</span>
<a href="#l3.3095"></a><span id="l3.3095" class="difflineminus">-  if (q)</span>
<a href="#l3.3096"></a><span id="l3.3096" class="difflineminus">-  {</span>
<a href="#l3.3097"></a><span id="l3.3097" class="difflineplus">+  if (q) {</span>
<a href="#l3.3098"></a><span id="l3.3098">     numberOfCharsInThisChunk = PL_strlen(q);</span>
<a href="#l3.3099"></a><span id="l3.3099">     fServerConnection.HandleMessageDownLoadLine(q, false, q);</span>
<a href="#l3.3100"></a><span id="l3.3100">     PR_Free(q);</span>
<a href="#l3.3101"></a><span id="l3.3101" class="difflineminus">-  }</span>
<a href="#l3.3102"></a><span id="l3.3102" class="difflineminus">-  else</span>
<a href="#l3.3103"></a><span id="l3.3103" class="difflineplus">+  } else</span>
<a href="#l3.3104"></a><span id="l3.3104">     numberOfCharsInThisChunk = 0;</span>
<a href="#l3.3105"></a><span id="l3.3105"> </span>
<a href="#l3.3106"></a><span id="l3.3106">   AdvanceToNextToken();</span>
<a href="#l3.3107"></a><span id="l3.3107" class="difflineminus">-  bool lastChunk = ((fServerConnection.GetCurFetchSize() == 0) ||</span>
<a href="#l3.3108"></a><span id="l3.3108" class="difflineminus">-                    (numberOfCharsInThisChunk != fServerConnection.GetCurFetchSize()));</span>
<a href="#l3.3109"></a><span id="l3.3109" class="difflineplus">+  bool lastChunk =</span>
<a href="#l3.3110"></a><span id="l3.3110" class="difflineplus">+      ((fServerConnection.GetCurFetchSize() == 0) ||</span>
<a href="#l3.3111"></a><span id="l3.3111" class="difflineplus">+       (numberOfCharsInThisChunk != fServerConnection.GetCurFetchSize()));</span>
<a href="#l3.3112"></a><span id="l3.3112">   return lastChunk;</span>
<a href="#l3.3113"></a><span id="l3.3113"> }</span>
<a href="#l3.3114"></a><span id="l3.3114"> </span>
<a href="#l3.3115"></a><span id="l3.3115"> /* msg_obsolete    ::= &quot;COPY&quot; / (&quot;STORE&quot; SPACE msg_fetch)</span>
<a href="#l3.3116"></a><span id="l3.3116"> ;; OBSOLETE untagged data responses */</span>
<a href="#l3.3117"></a><span id="l3.3117" class="difflineminus">-void nsImapServerResponseParser::msg_obsolete()</span>
<a href="#l3.3118"></a><span id="l3.3118" class="difflineminus">-{</span>
<a href="#l3.3119"></a><span id="l3.3119" class="difflineplus">+void nsImapServerResponseParser::msg_obsolete() {</span>
<a href="#l3.3120"></a><span id="l3.3120">   if (!PL_strcasecmp(fNextToken, &quot;COPY&quot;))</span>
<a href="#l3.3121"></a><span id="l3.3121">     AdvanceToNextToken();</span>
<a href="#l3.3122"></a><span id="l3.3122" class="difflineminus">-  else if (!PL_strcasecmp(fNextToken, &quot;STORE&quot;))</span>
<a href="#l3.3123"></a><span id="l3.3123" class="difflineminus">-  {</span>
<a href="#l3.3124"></a><span id="l3.3124" class="difflineplus">+  else if (!PL_strcasecmp(fNextToken, &quot;STORE&quot;)) {</span>
<a href="#l3.3125"></a><span id="l3.3125">     AdvanceToNextToken();</span>
<a href="#l3.3126"></a><span id="l3.3126" class="difflineminus">-    if (ContinueParse())</span>
<a href="#l3.3127"></a><span id="l3.3127" class="difflineminus">-      msg_fetch();</span>
<a href="#l3.3128"></a><span id="l3.3128" class="difflineminus">-  }</span>
<a href="#l3.3129"></a><span id="l3.3129" class="difflineminus">-  else</span>
<a href="#l3.3130"></a><span id="l3.3130" class="difflineplus">+    if (ContinueParse()) msg_fetch();</span>
<a href="#l3.3131"></a><span id="l3.3131" class="difflineplus">+  } else</span>
<a href="#l3.3132"></a><span id="l3.3132">     SetSyntaxError(true);</span>
<a href="#l3.3133"></a><span id="l3.3133"> }</span>
<a href="#l3.3134"></a><span id="l3.3134"> </span>
<a href="#l3.3135"></a><span id="l3.3135" class="difflineminus">-void nsImapServerResponseParser::capability_data()</span>
<a href="#l3.3136"></a><span id="l3.3136" class="difflineminus">-{</span>
<a href="#l3.3137"></a><span id="l3.3137" class="difflineplus">+void nsImapServerResponseParser::capability_data() {</span>
<a href="#l3.3138"></a><span id="l3.3138">   int32_t endToken = -1;</span>
<a href="#l3.3139"></a><span id="l3.3139">   fCapabilityFlag = kCapabilityDefined | kHasAuthOldLoginCapability;</span>
<a href="#l3.3140"></a><span id="l3.3140">   do {</span>
<a href="#l3.3141"></a><span id="l3.3141">     AdvanceToNextToken();</span>
<a href="#l3.3142"></a><span id="l3.3142">     if (fNextToken) {</span>
<a href="#l3.3143"></a><span id="l3.3143">       nsCString token(fNextToken);</span>
<a href="#l3.3144"></a><span id="l3.3144">       endToken = token.FindChar(']');</span>
<a href="#l3.3145"></a><span id="l3.3145" class="difflineminus">-      if (endToken &gt;= 0)</span>
<a href="#l3.3146"></a><span id="l3.3146" class="difflineminus">-        token.SetLength(endToken);</span>
<a href="#l3.3147"></a><span id="l3.3147" class="difflineplus">+      if (endToken &gt;= 0) token.SetLength(endToken);</span>
<a href="#l3.3148"></a><span id="l3.3148"> </span>
<a href="#l3.3149"></a><span id="l3.3149" class="difflineminus">-      if(token.Equals(&quot;AUTH=LOGIN&quot;, nsCaseInsensitiveCStringComparator()))</span>
<a href="#l3.3150"></a><span id="l3.3150" class="difflineplus">+      if (token.Equals(&quot;AUTH=LOGIN&quot;, nsCaseInsensitiveCStringComparator()))</span>
<a href="#l3.3151"></a><span id="l3.3151">         fCapabilityFlag |= kHasAuthLoginCapability;</span>
<a href="#l3.3152"></a><span id="l3.3152" class="difflineminus">-      else if(token.Equals(&quot;AUTH=PLAIN&quot;, nsCaseInsensitiveCStringComparator()))</span>
<a href="#l3.3153"></a><span id="l3.3153" class="difflineplus">+      else if (token.Equals(&quot;AUTH=PLAIN&quot;, nsCaseInsensitiveCStringComparator()))</span>
<a href="#l3.3154"></a><span id="l3.3154">         fCapabilityFlag |= kHasAuthPlainCapability;</span>
<a href="#l3.3155"></a><span id="l3.3155" class="difflineminus">-      else if (token.Equals(&quot;AUTH=CRAM-MD5&quot;, nsCaseInsensitiveCStringComparator()))</span>
<a href="#l3.3156"></a><span id="l3.3156" class="difflineplus">+      else if (token.Equals(&quot;AUTH=CRAM-MD5&quot;,</span>
<a href="#l3.3157"></a><span id="l3.3157" class="difflineplus">+                            nsCaseInsensitiveCStringComparator()))</span>
<a href="#l3.3158"></a><span id="l3.3158">         fCapabilityFlag |= kHasCRAMCapability;</span>
<a href="#l3.3159"></a><span id="l3.3159">       else if (token.Equals(&quot;AUTH=NTLM&quot;, nsCaseInsensitiveCStringComparator()))</span>
<a href="#l3.3160"></a><span id="l3.3160">         fCapabilityFlag |= kHasAuthNTLMCapability;</span>
<a href="#l3.3161"></a><span id="l3.3161" class="difflineminus">-      else if (token.Equals(&quot;AUTH=GSSAPI&quot;, nsCaseInsensitiveCStringComparator()))</span>
<a href="#l3.3162"></a><span id="l3.3162" class="difflineplus">+      else if (token.Equals(&quot;AUTH=GSSAPI&quot;,</span>
<a href="#l3.3163"></a><span id="l3.3163" class="difflineplus">+                            nsCaseInsensitiveCStringComparator()))</span>
<a href="#l3.3164"></a><span id="l3.3164">         fCapabilityFlag |= kHasAuthGssApiCapability;</span>
<a href="#l3.3165"></a><span id="l3.3165">       else if (token.Equals(&quot;AUTH=MSN&quot;, nsCaseInsensitiveCStringComparator()))</span>
<a href="#l3.3166"></a><span id="l3.3166">         fCapabilityFlag |= kHasAuthMSNCapability;</span>
<a href="#l3.3167"></a><span id="l3.3167" class="difflineminus">-      else if (token.Equals(&quot;AUTH=EXTERNAL&quot;, nsCaseInsensitiveCStringComparator()))</span>
<a href="#l3.3168"></a><span id="l3.3168" class="difflineplus">+      else if (token.Equals(&quot;AUTH=EXTERNAL&quot;,</span>
<a href="#l3.3169"></a><span id="l3.3169" class="difflineplus">+                            nsCaseInsensitiveCStringComparator()))</span>
<a href="#l3.3170"></a><span id="l3.3170">         fCapabilityFlag |= kHasAuthExternalCapability;</span>
<a href="#l3.3171"></a><span id="l3.3171" class="difflineminus">-      else if (token.Equals(&quot;AUTH=XOAUTH2&quot;, nsCaseInsensitiveCStringComparator()))</span>
<a href="#l3.3172"></a><span id="l3.3172" class="difflineplus">+      else if (token.Equals(&quot;AUTH=XOAUTH2&quot;,</span>
<a href="#l3.3173"></a><span id="l3.3173" class="difflineplus">+                            nsCaseInsensitiveCStringComparator()))</span>
<a href="#l3.3174"></a><span id="l3.3174">         fCapabilityFlag |= kHasXOAuth2Capability;</span>
<a href="#l3.3175"></a><span id="l3.3175">       else if (token.Equals(&quot;STARTTLS&quot;, nsCaseInsensitiveCStringComparator()))</span>
<a href="#l3.3176"></a><span id="l3.3176">         fCapabilityFlag |= kHasStartTLSCapability;</span>
<a href="#l3.3177"></a><span id="l3.3177" class="difflineminus">-      else if (token.Equals(&quot;LOGINDISABLED&quot;, nsCaseInsensitiveCStringComparator()))</span>
<a href="#l3.3178"></a><span id="l3.3178" class="difflineminus">-        fCapabilityFlag &amp;= ~kHasAuthOldLoginCapability; // remove flag</span>
<a href="#l3.3179"></a><span id="l3.3179" class="difflineplus">+      else if (token.Equals(&quot;LOGINDISABLED&quot;,</span>
<a href="#l3.3180"></a><span id="l3.3180" class="difflineplus">+                            nsCaseInsensitiveCStringComparator()))</span>
<a href="#l3.3181"></a><span id="l3.3181" class="difflineplus">+        fCapabilityFlag &amp;= ~kHasAuthOldLoginCapability;  // remove flag</span>
<a href="#l3.3182"></a><span id="l3.3182">       else if (token.Equals(&quot;XSENDER&quot;, nsCaseInsensitiveCStringComparator()))</span>
<a href="#l3.3183"></a><span id="l3.3183">         fCapabilityFlag |= kHasXSenderCapability;</span>
<a href="#l3.3184"></a><span id="l3.3184">       else if (token.Equals(&quot;IMAP4&quot;, nsCaseInsensitiveCStringComparator()))</span>
<a href="#l3.3185"></a><span id="l3.3185">         fCapabilityFlag |= kIMAP4Capability;</span>
<a href="#l3.3186"></a><span id="l3.3186">       else if (token.Equals(&quot;IMAP4rev1&quot;, nsCaseInsensitiveCStringComparator()))</span>
<a href="#l3.3187"></a><span id="l3.3187">         fCapabilityFlag |= kIMAP4rev1Capability;</span>
<a href="#l3.3188"></a><span id="l3.3188" class="difflineminus">-      else if (Substring(token,0,5).Equals(&quot;IMAP4&quot;, nsCaseInsensitiveCStringComparator()))</span>
<a href="#l3.3189"></a><span id="l3.3189" class="difflineplus">+      else if (Substring(token, 0, 5)</span>
<a href="#l3.3190"></a><span id="l3.3190" class="difflineplus">+                   .Equals(&quot;IMAP4&quot;, nsCaseInsensitiveCStringComparator()))</span>
<a href="#l3.3191"></a><span id="l3.3191">         fCapabilityFlag |= kIMAP4other;</span>
<a href="#l3.3192"></a><span id="l3.3192" class="difflineminus">-      else if (token.Equals(&quot;X-NO-ATOMIC-RENAME&quot;, nsCaseInsensitiveCStringComparator()))</span>
<a href="#l3.3193"></a><span id="l3.3193" class="difflineplus">+      else if (token.Equals(&quot;X-NO-ATOMIC-RENAME&quot;,</span>
<a href="#l3.3194"></a><span id="l3.3194" class="difflineplus">+                            nsCaseInsensitiveCStringComparator()))</span>
<a href="#l3.3195"></a><span id="l3.3195">         fCapabilityFlag |= kNoHierarchyRename;</span>
<a href="#l3.3196"></a><span id="l3.3196" class="difflineminus">-      else if (token.Equals(&quot;X-NON-HIERARCHICAL-RENAME&quot;, nsCaseInsensitiveCStringComparator()))</span>
<a href="#l3.3197"></a><span id="l3.3197" class="difflineplus">+      else if (token.Equals(&quot;X-NON-HIERARCHICAL-RENAME&quot;,</span>
<a href="#l3.3198"></a><span id="l3.3198" class="difflineplus">+                            nsCaseInsensitiveCStringComparator()))</span>
<a href="#l3.3199"></a><span id="l3.3199">         fCapabilityFlag |= kNoHierarchyRename;</span>
<a href="#l3.3200"></a><span id="l3.3200">       else if (token.Equals(&quot;NAMESPACE&quot;, nsCaseInsensitiveCStringComparator()))</span>
<a href="#l3.3201"></a><span id="l3.3201">         fCapabilityFlag |= kNamespaceCapability;</span>
<a href="#l3.3202"></a><span id="l3.3202">       else if (token.Equals(&quot;ID&quot;, nsCaseInsensitiveCStringComparator()))</span>
<a href="#l3.3203"></a><span id="l3.3203">         fCapabilityFlag |= kHasIDCapability;</span>
<a href="#l3.3204"></a><span id="l3.3204">       else if (token.Equals(&quot;ACL&quot;, nsCaseInsensitiveCStringComparator()))</span>
<a href="#l3.3205"></a><span id="l3.3205">         fCapabilityFlag |= kACLCapability;</span>
<a href="#l3.3206"></a><span id="l3.3206" class="difflineminus">-      else if (token.Equals(&quot;XSERVERINFO&quot;, nsCaseInsensitiveCStringComparator()))</span>
<a href="#l3.3207"></a><span id="l3.3207" class="difflineplus">+      else if (token.Equals(&quot;XSERVERINFO&quot;,</span>
<a href="#l3.3208"></a><span id="l3.3208" class="difflineplus">+                            nsCaseInsensitiveCStringComparator()))</span>
<a href="#l3.3209"></a><span id="l3.3209">         fCapabilityFlag |= kXServerInfoCapability;</span>
<a href="#l3.3210"></a><span id="l3.3210">       else if (token.Equals(&quot;UIDPLUS&quot;, nsCaseInsensitiveCStringComparator()))</span>
<a href="#l3.3211"></a><span id="l3.3211">         fCapabilityFlag |= kUidplusCapability;</span>
<a href="#l3.3212"></a><span id="l3.3212">       else if (token.Equals(&quot;LITERAL+&quot;, nsCaseInsensitiveCStringComparator()))</span>
<a href="#l3.3213"></a><span id="l3.3213">         fCapabilityFlag |= kLiteralPlusCapability;</span>
<a href="#l3.3214"></a><span id="l3.3214" class="difflineminus">-      else if (token.Equals(&quot;XAOL-OPTION&quot;, nsCaseInsensitiveCStringComparator()))</span>
<a href="#l3.3215"></a><span id="l3.3215" class="difflineplus">+      else if (token.Equals(&quot;XAOL-OPTION&quot;,</span>
<a href="#l3.3216"></a><span id="l3.3216" class="difflineplus">+                            nsCaseInsensitiveCStringComparator()))</span>
<a href="#l3.3217"></a><span id="l3.3217">         fCapabilityFlag |= kAOLImapCapability;</span>
<a href="#l3.3218"></a><span id="l3.3218">       else if (token.Equals(&quot;X-GM-EXT-1&quot;, nsCaseInsensitiveCStringComparator()))</span>
<a href="#l3.3219"></a><span id="l3.3219">         fCapabilityFlag |= kGmailImapCapability;</span>
<a href="#l3.3220"></a><span id="l3.3220">       else if (token.Equals(&quot;QUOTA&quot;, nsCaseInsensitiveCStringComparator()))</span>
<a href="#l3.3221"></a><span id="l3.3221">         fCapabilityFlag |= kQuotaCapability;</span>
<a href="#l3.3222"></a><span id="l3.3222">       else if (token.Equals(&quot;LANGUAGE&quot;, nsCaseInsensitiveCStringComparator()))</span>
<a href="#l3.3223"></a><span id="l3.3223">         fCapabilityFlag |= kHasLanguageCapability;</span>
<a href="#l3.3224"></a><span id="l3.3224">       else if (token.Equals(&quot;IDLE&quot;, nsCaseInsensitiveCStringComparator()))</span>
<a href="#l3.3225"></a><span id="l3.3225">         fCapabilityFlag |= kHasIdleCapability;</span>
<a href="#l3.3226"></a><span id="l3.3226">       else if (token.Equals(&quot;CONDSTORE&quot;, nsCaseInsensitiveCStringComparator()))</span>
<a href="#l3.3227"></a><span id="l3.3227">         fCapabilityFlag |= kHasCondStoreCapability;</span>
<a href="#l3.3228"></a><span id="l3.3228">       else if (token.Equals(&quot;ENABLE&quot;, nsCaseInsensitiveCStringComparator()))</span>
<a href="#l3.3229"></a><span id="l3.3229">         fCapabilityFlag |= kHasEnableCapability;</span>
<a href="#l3.3230"></a><span id="l3.3230" class="difflineminus">-      else if (token.Equals(&quot;LIST-EXTENDED&quot;, nsCaseInsensitiveCStringComparator()))</span>
<a href="#l3.3231"></a><span id="l3.3231" class="difflineplus">+      else if (token.Equals(&quot;LIST-EXTENDED&quot;,</span>
<a href="#l3.3232"></a><span id="l3.3232" class="difflineplus">+                            nsCaseInsensitiveCStringComparator()))</span>
<a href="#l3.3233"></a><span id="l3.3233">         fCapabilityFlag |= kHasListExtendedCapability;</span>
<a href="#l3.3234"></a><span id="l3.3234">       else if (token.Equals(&quot;XLIST&quot;, nsCaseInsensitiveCStringComparator()))</span>
<a href="#l3.3235"></a><span id="l3.3235">         fCapabilityFlag |= kHasXListCapability;</span>
<a href="#l3.3236"></a><span id="l3.3236" class="difflineminus">-      else if (token.Equals(&quot;SPECIAL-USE&quot;, nsCaseInsensitiveCStringComparator()))</span>
<a href="#l3.3237"></a><span id="l3.3237" class="difflineplus">+      else if (token.Equals(&quot;SPECIAL-USE&quot;,</span>
<a href="#l3.3238"></a><span id="l3.3238" class="difflineplus">+                            nsCaseInsensitiveCStringComparator()))</span>
<a href="#l3.3239"></a><span id="l3.3239">         fCapabilityFlag |= kHasSpecialUseCapability;</span>
<a href="#l3.3240"></a><span id="l3.3240" class="difflineminus">-      else if (token.Equals(&quot;COMPRESS=DEFLATE&quot;, nsCaseInsensitiveCStringComparator()))</span>
<a href="#l3.3241"></a><span id="l3.3241" class="difflineplus">+      else if (token.Equals(&quot;COMPRESS=DEFLATE&quot;,</span>
<a href="#l3.3242"></a><span id="l3.3242" class="difflineplus">+                            nsCaseInsensitiveCStringComparator()))</span>
<a href="#l3.3243"></a><span id="l3.3243">         fCapabilityFlag |= kHasCompressDeflateCapability;</span>
<a href="#l3.3244"></a><span id="l3.3244">       else if (token.Equals(&quot;MOVE&quot;, nsCaseInsensitiveCStringComparator()))</span>
<a href="#l3.3245"></a><span id="l3.3245">         fCapabilityFlag |= kHasMoveCapability;</span>
<a href="#l3.3246"></a><span id="l3.3246" class="difflineminus">-      else if (token.Equals(&quot;HIGHESTMODSEQ&quot;, nsCaseInsensitiveCStringComparator()))</span>
<a href="#l3.3247"></a><span id="l3.3247" class="difflineplus">+      else if (token.Equals(&quot;HIGHESTMODSEQ&quot;,</span>
<a href="#l3.3248"></a><span id="l3.3248" class="difflineplus">+                            nsCaseInsensitiveCStringComparator()))</span>
<a href="#l3.3249"></a><span id="l3.3249">         fCapabilityFlag |= kHasHighestModSeqCapability;</span>
<a href="#l3.3250"></a><span id="l3.3250">     }</span>
<a href="#l3.3251"></a><span id="l3.3251">   } while (fNextToken &amp;&amp; endToken &lt; 0 &amp;&amp; !fAtEndOfLine &amp;&amp; ContinueParse());</span>
<a href="#l3.3252"></a><span id="l3.3252"> </span>
<a href="#l3.3253"></a><span id="l3.3253">   nsImapProtocol *navCon = &amp;fServerConnection;</span>
<a href="#l3.3254"></a><span id="l3.3254" class="difflineminus">-  NS_ASSERTION(navCon, &quot;null imap protocol connection while parsing capability response&quot;);  // we should always have this</span>
<a href="#l3.3255"></a><span id="l3.3255" class="difflineminus">-  if (navCon)</span>
<a href="#l3.3256"></a><span id="l3.3256" class="difflineminus">-    navCon-&gt;CommitCapability();</span>
<a href="#l3.3257"></a><span id="l3.3257" class="difflineplus">+  NS_ASSERTION(navCon,</span>
<a href="#l3.3258"></a><span id="l3.3258" class="difflineplus">+               &quot;null imap protocol connection while parsing capability &quot;</span>
<a href="#l3.3259"></a><span id="l3.3259" class="difflineplus">+               &quot;response&quot;);  // we should always have this</span>
<a href="#l3.3260"></a><span id="l3.3260" class="difflineplus">+  if (navCon) navCon-&gt;CommitCapability();</span>
<a href="#l3.3261"></a><span id="l3.3261">   skip_to_CRLF();</span>
<a href="#l3.3262"></a><span id="l3.3262"> }</span>
<a href="#l3.3263"></a><span id="l3.3263"> </span>
<a href="#l3.3264"></a><span id="l3.3264" class="difflineminus">-void nsImapServerResponseParser::xmailboxinfo_data()</span>
<a href="#l3.3265"></a><span id="l3.3265" class="difflineminus">-{</span>
<a href="#l3.3266"></a><span id="l3.3266" class="difflineplus">+void nsImapServerResponseParser::xmailboxinfo_data() {</span>
<a href="#l3.3267"></a><span id="l3.3267">   AdvanceToNextToken();</span>
<a href="#l3.3268"></a><span id="l3.3268" class="difflineminus">-  if (!fNextToken)</span>
<a href="#l3.3269"></a><span id="l3.3269" class="difflineminus">-    return;</span>
<a href="#l3.3270"></a><span id="l3.3270" class="difflineplus">+  if (!fNextToken) return;</span>
<a href="#l3.3271"></a><span id="l3.3271"> </span>
<a href="#l3.3272"></a><span id="l3.3272" class="difflineminus">-  char *mailboxName = CreateAstring(); // PL_strdup(fNextToken);</span>
<a href="#l3.3273"></a><span id="l3.3273" class="difflineminus">-  if (mailboxName)</span>
<a href="#l3.3274"></a><span id="l3.3274" class="difflineminus">-  {</span>
<a href="#l3.3275"></a><span id="l3.3275" class="difflineminus">-    do</span>
<a href="#l3.3276"></a><span id="l3.3276" class="difflineminus">-    {</span>
<a href="#l3.3277"></a><span id="l3.3277" class="difflineplus">+  char *mailboxName = CreateAstring();  // PL_strdup(fNextToken);</span>
<a href="#l3.3278"></a><span id="l3.3278" class="difflineplus">+  if (mailboxName) {</span>
<a href="#l3.3279"></a><span id="l3.3279" class="difflineplus">+    do {</span>
<a href="#l3.3280"></a><span id="l3.3280">       AdvanceToNextToken();</span>
<a href="#l3.3281"></a><span id="l3.3281" class="difflineminus">-      if (fNextToken)</span>
<a href="#l3.3282"></a><span id="l3.3282" class="difflineminus">-      {</span>
<a href="#l3.3283"></a><span id="l3.3283" class="difflineminus">-        if (!PL_strcmp(&quot;MANAGEURL&quot;, fNextToken))</span>
<a href="#l3.3284"></a><span id="l3.3284" class="difflineminus">-        {</span>
<a href="#l3.3285"></a><span id="l3.3285" class="difflineplus">+      if (fNextToken) {</span>
<a href="#l3.3286"></a><span id="l3.3286" class="difflineplus">+        if (!PL_strcmp(&quot;MANAGEURL&quot;, fNextToken)) {</span>
<a href="#l3.3287"></a><span id="l3.3287">           AdvanceToNextToken();</span>
<a href="#l3.3288"></a><span id="l3.3288">           fFolderAdminUrl = CreateAstring();</span>
<a href="#l3.3289"></a><span id="l3.3289" class="difflineminus">-        }</span>
<a href="#l3.3290"></a><span id="l3.3290" class="difflineminus">-        else if (!PL_strcmp(&quot;POSTURL&quot;, fNextToken))</span>
<a href="#l3.3291"></a><span id="l3.3291" class="difflineminus">-        {</span>
<a href="#l3.3292"></a><span id="l3.3292" class="difflineplus">+        } else if (!PL_strcmp(&quot;POSTURL&quot;, fNextToken)) {</span>
<a href="#l3.3293"></a><span id="l3.3293">           AdvanceToNextToken();</span>
<a href="#l3.3294"></a><span id="l3.3294">           // ignore this for now...</span>
<a href="#l3.3295"></a><span id="l3.3295">         }</span>
<a href="#l3.3296"></a><span id="l3.3296">       }</span>
<a href="#l3.3297"></a><span id="l3.3297">     } while (fNextToken &amp;&amp; !fAtEndOfLine &amp;&amp; ContinueParse());</span>
<a href="#l3.3298"></a><span id="l3.3298">   }</span>
<a href="#l3.3299"></a><span id="l3.3299"> }</span>
<a href="#l3.3300"></a><span id="l3.3300"> </span>
<a href="#l3.3301"></a><span id="l3.3301" class="difflineminus">-void nsImapServerResponseParser::xserverinfo_data()</span>
<a href="#l3.3302"></a><span id="l3.3302" class="difflineminus">-{</span>
<a href="#l3.3303"></a><span id="l3.3303" class="difflineminus">-  do</span>
<a href="#l3.3304"></a><span id="l3.3304" class="difflineminus">-  {</span>
<a href="#l3.3305"></a><span id="l3.3305" class="difflineplus">+void nsImapServerResponseParser::xserverinfo_data() {</span>
<a href="#l3.3306"></a><span id="l3.3306" class="difflineplus">+  do {</span>
<a href="#l3.3307"></a><span id="l3.3307">     AdvanceToNextToken();</span>
<a href="#l3.3308"></a><span id="l3.3308" class="difflineminus">-    if (!fNextToken)</span>
<a href="#l3.3309"></a><span id="l3.3309" class="difflineminus">-      break;</span>
<a href="#l3.3310"></a><span id="l3.3310" class="difflineminus">-    if (!PL_strcmp(&quot;MANAGEACCOUNTURL&quot;, fNextToken))</span>
<a href="#l3.3311"></a><span id="l3.3311" class="difflineminus">-    {</span>
<a href="#l3.3312"></a><span id="l3.3312" class="difflineplus">+    if (!fNextToken) break;</span>
<a href="#l3.3313"></a><span id="l3.3313" class="difflineplus">+    if (!PL_strcmp(&quot;MANAGEACCOUNTURL&quot;, fNextToken)) {</span>
<a href="#l3.3314"></a><span id="l3.3314">       AdvanceToNextToken();</span>
<a href="#l3.3315"></a><span id="l3.3315">       fMailAccountUrl.Adopt(CreateNilString());</span>
<a href="#l3.3316"></a><span id="l3.3316" class="difflineminus">-    }</span>
<a href="#l3.3317"></a><span id="l3.3317" class="difflineminus">-    else if (!PL_strcmp(&quot;MANAGELISTSURL&quot;, fNextToken))</span>
<a href="#l3.3318"></a><span id="l3.3318" class="difflineminus">-    {</span>
<a href="#l3.3319"></a><span id="l3.3319" class="difflineplus">+    } else if (!PL_strcmp(&quot;MANAGELISTSURL&quot;, fNextToken)) {</span>
<a href="#l3.3320"></a><span id="l3.3320">       AdvanceToNextToken();</span>
<a href="#l3.3321"></a><span id="l3.3321">       fManageListsUrl.Adopt(CreateNilString());</span>
<a href="#l3.3322"></a><span id="l3.3322" class="difflineminus">-    }</span>
<a href="#l3.3323"></a><span id="l3.3323" class="difflineminus">-    else if (!PL_strcmp(&quot;MANAGEFILTERSURL&quot;, fNextToken))</span>
<a href="#l3.3324"></a><span id="l3.3324" class="difflineminus">-    {</span>
<a href="#l3.3325"></a><span id="l3.3325" class="difflineplus">+    } else if (!PL_strcmp(&quot;MANAGEFILTERSURL&quot;, fNextToken)) {</span>
<a href="#l3.3326"></a><span id="l3.3326">       AdvanceToNextToken();</span>
<a href="#l3.3327"></a><span id="l3.3327">       fManageFiltersUrl.Adopt(CreateNilString());</span>
<a href="#l3.3328"></a><span id="l3.3328">     }</span>
<a href="#l3.3329"></a><span id="l3.3329">   } while (fNextToken &amp;&amp; !fAtEndOfLine &amp;&amp; ContinueParse());</span>
<a href="#l3.3330"></a><span id="l3.3330"> }</span>
<a href="#l3.3331"></a><span id="l3.3331"> </span>
<a href="#l3.3332"></a><span id="l3.3332" class="difflineminus">-void nsImapServerResponseParser::enable_data()</span>
<a href="#l3.3333"></a><span id="l3.3333" class="difflineminus">-{</span>
<a href="#l3.3334"></a><span id="l3.3334" class="difflineminus">-  do</span>
<a href="#l3.3335"></a><span id="l3.3335" class="difflineminus">-  {</span>
<a href="#l3.3336"></a><span id="l3.3336" class="difflineplus">+void nsImapServerResponseParser::enable_data() {</span>
<a href="#l3.3337"></a><span id="l3.3337" class="difflineplus">+  do {</span>
<a href="#l3.3338"></a><span id="l3.3338">     // eat each enable response;</span>
<a href="#l3.3339"></a><span id="l3.3339" class="difflineminus">-     AdvanceToNextToken();</span>
<a href="#l3.3340"></a><span id="l3.3340" class="difflineminus">-     if (!strcmp(&quot;CONDSTORE&quot;, fNextToken))</span>
<a href="#l3.3341"></a><span id="l3.3341" class="difflineminus">-       fCondStoreEnabled = true;</span>
<a href="#l3.3342"></a><span id="l3.3342" class="difflineplus">+    AdvanceToNextToken();</span>
<a href="#l3.3343"></a><span id="l3.3343" class="difflineplus">+    if (!strcmp(&quot;CONDSTORE&quot;, fNextToken)) fCondStoreEnabled = true;</span>
<a href="#l3.3344"></a><span id="l3.3344">   } while (fNextToken &amp;&amp; !fAtEndOfLine &amp;&amp; ContinueParse());</span>
<a href="#l3.3345"></a><span id="l3.3345" class="difflineminus">-</span>
<a href="#l3.3346"></a><span id="l3.3346"> }</span>
<a href="#l3.3347"></a><span id="l3.3347"> </span>
<a href="#l3.3348"></a><span id="l3.3348" class="difflineminus">-void nsImapServerResponseParser::language_data()</span>
<a href="#l3.3349"></a><span id="l3.3349" class="difflineminus">-{</span>
<a href="#l3.3350"></a><span id="l3.3350" class="difflineplus">+void nsImapServerResponseParser::language_data() {</span>
<a href="#l3.3351"></a><span id="l3.3351">   // we may want to go out and store the language returned to us</span>
<a href="#l3.3352"></a><span id="l3.3352">   // by the language command in the host info session stuff.</span>
<a href="#l3.3353"></a><span id="l3.3353"> </span>
<a href="#l3.3354"></a><span id="l3.3354">   // for now, just eat the language....</span>
<a href="#l3.3355"></a><span id="l3.3355" class="difflineminus">-  do</span>
<a href="#l3.3356"></a><span id="l3.3356" class="difflineminus">-  {</span>
<a href="#l3.3357"></a><span id="l3.3357" class="difflineplus">+  do {</span>
<a href="#l3.3358"></a><span id="l3.3358">     // eat each language returned to us</span>
<a href="#l3.3359"></a><span id="l3.3359">     AdvanceToNextToken();</span>
<a href="#l3.3360"></a><span id="l3.3360">   } while (fNextToken &amp;&amp; !fAtEndOfLine &amp;&amp; ContinueParse());</span>
<a href="#l3.3361"></a><span id="l3.3361"> }</span>
<a href="#l3.3362"></a><span id="l3.3362"> </span>
<a href="#l3.3363"></a><span id="l3.3363"> // cram/auth response data ::= &quot;+&quot; SPACE challenge CRLF</span>
<a href="#l3.3364"></a><span id="l3.3364"> // the server expects more client data after issuing its challenge</span>
<a href="#l3.3365"></a><span id="l3.3365"> </span>
<a href="#l3.3366"></a><span id="l3.3366" class="difflineminus">-void nsImapServerResponseParser::authChallengeResponse_data()</span>
<a href="#l3.3367"></a><span id="l3.3367" class="difflineminus">-{</span>
<a href="#l3.3368"></a><span id="l3.3368" class="difflineplus">+void nsImapServerResponseParser::authChallengeResponse_data() {</span>
<a href="#l3.3369"></a><span id="l3.3369">   AdvanceToNextToken();</span>
<a href="#l3.3370"></a><span id="l3.3370">   fAuthChallenge = strdup(fNextToken);</span>
<a href="#l3.3371"></a><span id="l3.3371">   fWaitingForMoreClientInput = true;</span>
<a href="#l3.3372"></a><span id="l3.3372"> </span>
<a href="#l3.3373"></a><span id="l3.3373">   skip_to_CRLF();</span>
<a href="#l3.3374"></a><span id="l3.3374"> }</span>
<a href="#l3.3375"></a><span id="l3.3375"> </span>
<a href="#l3.3376"></a><span id="l3.3376" class="difflineminus">-</span>
<a href="#l3.3377"></a><span id="l3.3377" class="difflineminus">-void nsImapServerResponseParser::namespace_data()</span>
<a href="#l3.3378"></a><span id="l3.3378" class="difflineminus">-{</span>
<a href="#l3.3379"></a><span id="l3.3379" class="difflineplus">+void nsImapServerResponseParser::namespace_data() {</span>
<a href="#l3.3380"></a><span id="l3.3380">   EIMAPNamespaceType namespaceType = kPersonalNamespace;</span>
<a href="#l3.3381"></a><span id="l3.3381">   bool namespacesCommitted = false;</span>
<a href="#l3.3382"></a><span id="l3.3382" class="difflineminus">-  const char* serverKey = fServerConnection.GetImapServerKey();</span>
<a href="#l3.3383"></a><span id="l3.3383" class="difflineminus">-  while ((namespaceType != kUnknownNamespace) &amp;&amp; ContinueParse())</span>
<a href="#l3.3384"></a><span id="l3.3384" class="difflineminus">-  {</span>
<a href="#l3.3385"></a><span id="l3.3385" class="difflineplus">+  const char *serverKey = fServerConnection.GetImapServerKey();</span>
<a href="#l3.3386"></a><span id="l3.3386" class="difflineplus">+  while ((namespaceType != kUnknownNamespace) &amp;&amp; ContinueParse()) {</span>
<a href="#l3.3387"></a><span id="l3.3387">     AdvanceToNextToken();</span>
<a href="#l3.3388"></a><span id="l3.3388" class="difflineminus">-    while (fAtEndOfLine &amp;&amp; ContinueParse())</span>
<a href="#l3.3389"></a><span id="l3.3389" class="difflineminus">-      AdvanceToNextToken();</span>
<a href="#l3.3390"></a><span id="l3.3390" class="difflineminus">-    if (!PL_strcasecmp(fNextToken,&quot;NIL&quot;))</span>
<a href="#l3.3391"></a><span id="l3.3391" class="difflineminus">-    {</span>
<a href="#l3.3392"></a><span id="l3.3392" class="difflineplus">+    while (fAtEndOfLine &amp;&amp; ContinueParse()) AdvanceToNextToken();</span>
<a href="#l3.3393"></a><span id="l3.3393" class="difflineplus">+    if (!PL_strcasecmp(fNextToken, &quot;NIL&quot;)) {</span>
<a href="#l3.3394"></a><span id="l3.3394">       // No namespace for this type.</span>
<a href="#l3.3395"></a><span id="l3.3395">       // Don't add anything to the Namespace object.</span>
<a href="#l3.3396"></a><span id="l3.3396" class="difflineminus">-    }</span>
<a href="#l3.3397"></a><span id="l3.3397" class="difflineminus">-    else if (fNextToken[0] == '(')</span>
<a href="#l3.3398"></a><span id="l3.3398" class="difflineminus">-    {</span>
<a href="#l3.3399"></a><span id="l3.3399" class="difflineplus">+    } else if (fNextToken[0] == '(') {</span>
<a href="#l3.3400"></a><span id="l3.3400">       // There may be multiple namespaces of the same type.</span>
<a href="#l3.3401"></a><span id="l3.3401">       // Go through each of them and add them to our Namespace object.</span>
<a href="#l3.3402"></a><span id="l3.3402"> </span>
<a href="#l3.3403"></a><span id="l3.3403">       fNextToken++;</span>
<a href="#l3.3404"></a><span id="l3.3404" class="difflineminus">-      while (fNextToken[0] == '(' &amp;&amp; ContinueParse())</span>
<a href="#l3.3405"></a><span id="l3.3405" class="difflineminus">-      {</span>
<a href="#l3.3406"></a><span id="l3.3406" class="difflineplus">+      while (fNextToken[0] == '(' &amp;&amp; ContinueParse()) {</span>
<a href="#l3.3407"></a><span id="l3.3407">         // we have another namespace for this namespace type</span>
<a href="#l3.3408"></a><span id="l3.3408">         fNextToken++;</span>
<a href="#l3.3409"></a><span id="l3.3409" class="difflineminus">-        if (fNextToken[0] != '&quot;')</span>
<a href="#l3.3410"></a><span id="l3.3410" class="difflineminus">-        {</span>
<a href="#l3.3411"></a><span id="l3.3411" class="difflineplus">+        if (fNextToken[0] != '&quot;') {</span>
<a href="#l3.3412"></a><span id="l3.3412">           SetSyntaxError(true);</span>
<a href="#l3.3413"></a><span id="l3.3413" class="difflineminus">-        }</span>
<a href="#l3.3414"></a><span id="l3.3414" class="difflineminus">-        else</span>
<a href="#l3.3415"></a><span id="l3.3415" class="difflineminus">-        {</span>
<a href="#l3.3416"></a><span id="l3.3416" class="difflineplus">+        } else {</span>
<a href="#l3.3417"></a><span id="l3.3417">           char *namespacePrefix = CreateQuoted(false);</span>
<a href="#l3.3418"></a><span id="l3.3418"> </span>
<a href="#l3.3419"></a><span id="l3.3419">           AdvanceToNextToken();</span>
<a href="#l3.3420"></a><span id="l3.3420">           const char *quotedDelimiter = fNextToken;</span>
<a href="#l3.3421"></a><span id="l3.3421">           char namespaceDelimiter = '\0';</span>
<a href="#l3.3422"></a><span id="l3.3422"> </span>
<a href="#l3.3423"></a><span id="l3.3423" class="difflineminus">-          if (quotedDelimiter[0] == '&quot;')</span>
<a href="#l3.3424"></a><span id="l3.3424" class="difflineminus">-          {</span>
<a href="#l3.3425"></a><span id="l3.3425" class="difflineplus">+          if (quotedDelimiter[0] == '&quot;') {</span>
<a href="#l3.3426"></a><span id="l3.3426">             quotedDelimiter++;</span>
<a href="#l3.3427"></a><span id="l3.3427">             namespaceDelimiter = quotedDelimiter[0];</span>
<a href="#l3.3428"></a><span id="l3.3428" class="difflineminus">-          }</span>
<a href="#l3.3429"></a><span id="l3.3429" class="difflineminus">-          else if (!PL_strncasecmp(quotedDelimiter, &quot;NIL&quot;, 3))</span>
<a href="#l3.3430"></a><span id="l3.3430" class="difflineminus">-          {</span>
<a href="#l3.3431"></a><span id="l3.3431" class="difflineplus">+          } else if (!PL_strncasecmp(quotedDelimiter, &quot;NIL&quot;, 3)) {</span>
<a href="#l3.3432"></a><span id="l3.3432">             // NIL hierarchy delimiter.  Leave namespace delimiter nullptr.</span>
<a href="#l3.3433"></a><span id="l3.3433" class="difflineminus">-          }</span>
<a href="#l3.3434"></a><span id="l3.3434" class="difflineminus">-          else</span>
<a href="#l3.3435"></a><span id="l3.3435" class="difflineminus">-          {</span>
<a href="#l3.3436"></a><span id="l3.3436" class="difflineplus">+          } else {</span>
<a href="#l3.3437"></a><span id="l3.3437">             // not quoted or NIL.</span>
<a href="#l3.3438"></a><span id="l3.3438">             SetSyntaxError(true);</span>
<a href="#l3.3439"></a><span id="l3.3439">           }</span>
<a href="#l3.3440"></a><span id="l3.3440" class="difflineminus">-          if (ContinueParse())</span>
<a href="#l3.3441"></a><span id="l3.3441" class="difflineminus">-          {</span>
<a href="#l3.3442"></a><span id="l3.3442" class="difflineplus">+          if (ContinueParse()) {</span>
<a href="#l3.3443"></a><span id="l3.3443">             // add code to parse the TRANSLATE attribute if it is present....</span>
<a href="#l3.3444"></a><span id="l3.3444" class="difflineminus">-            // we'll also need to expand the name space code to take in the translated prefix name.</span>
<a href="#l3.3445"></a><span id="l3.3445" class="difflineplus">+            // we'll also need to expand the name space code to take in the</span>
<a href="#l3.3446"></a><span id="l3.3446" class="difflineplus">+            // translated prefix name.</span>
<a href="#l3.3447"></a><span id="l3.3447"> </span>
<a href="#l3.3448"></a><span id="l3.3448" class="difflineminus">-            nsIMAPNamespace *newNamespace = new nsIMAPNamespace(namespaceType, namespacePrefix, namespaceDelimiter, false);</span>
<a href="#l3.3449"></a><span id="l3.3449" class="difflineplus">+            nsIMAPNamespace *newNamespace = new nsIMAPNamespace(</span>
<a href="#l3.3450"></a><span id="l3.3450" class="difflineplus">+                namespaceType, namespacePrefix, namespaceDelimiter, false);</span>
<a href="#l3.3451"></a><span id="l3.3451">             // add it to a temporary list in the host</span>
<a href="#l3.3452"></a><span id="l3.3452">             if (newNamespace &amp;&amp; fHostSessionList)</span>
<a href="#l3.3453"></a><span id="l3.3453">               fHostSessionList-&gt;AddNewNamespaceForHost(serverKey, newNamespace);</span>
<a href="#l3.3454"></a><span id="l3.3454"> </span>
<a href="#l3.3455"></a><span id="l3.3455">             skip_to_close_paren();  // Ignore any extension data</span>
<a href="#l3.3456"></a><span id="l3.3456"> </span>
<a href="#l3.3457"></a><span id="l3.3457">             bool endOfThisNamespaceType = (fNextToken[0] == ')');</span>
<a href="#l3.3458"></a><span id="l3.3458" class="difflineminus">-            if (!endOfThisNamespaceType &amp;&amp; fNextToken[0] != '(')  // no space between namespaces of the same type</span>
<a href="#l3.3459"></a><span id="l3.3459" class="difflineplus">+            if (!endOfThisNamespaceType &amp;&amp;</span>
<a href="#l3.3460"></a><span id="l3.3460" class="difflineplus">+                fNextToken[0] !=</span>
<a href="#l3.3461"></a><span id="l3.3461" class="difflineplus">+                    '(')  // no space between namespaces of the same type</span>
<a href="#l3.3462"></a><span id="l3.3462">             {</span>
<a href="#l3.3463"></a><span id="l3.3463">               SetSyntaxError(true);</span>
<a href="#l3.3464"></a><span id="l3.3464">             }</span>
<a href="#l3.3465"></a><span id="l3.3465">           }</span>
<a href="#l3.3466"></a><span id="l3.3466">           PR_Free(namespacePrefix);</span>
<a href="#l3.3467"></a><span id="l3.3467">         }</span>
<a href="#l3.3468"></a><span id="l3.3468">       }</span>
<a href="#l3.3469"></a><span id="l3.3469" class="difflineminus">-    }</span>
<a href="#l3.3470"></a><span id="l3.3470" class="difflineminus">-    else</span>
<a href="#l3.3471"></a><span id="l3.3471" class="difflineminus">-    {</span>
<a href="#l3.3472"></a><span id="l3.3472" class="difflineplus">+    } else {</span>
<a href="#l3.3473"></a><span id="l3.3473">       SetSyntaxError(true);</span>
<a href="#l3.3474"></a><span id="l3.3474">     }</span>
<a href="#l3.3475"></a><span id="l3.3475" class="difflineminus">-    switch (namespaceType)</span>
<a href="#l3.3476"></a><span id="l3.3476" class="difflineminus">-    {</span>
<a href="#l3.3477"></a><span id="l3.3477" class="difflineminus">-    case kPersonalNamespace:</span>
<a href="#l3.3478"></a><span id="l3.3478" class="difflineminus">-      namespaceType = kOtherUsersNamespace;</span>
<a href="#l3.3479"></a><span id="l3.3479" class="difflineminus">-      break;</span>
<a href="#l3.3480"></a><span id="l3.3480" class="difflineminus">-    case kOtherUsersNamespace:</span>
<a href="#l3.3481"></a><span id="l3.3481" class="difflineminus">-      namespaceType = kPublicNamespace;</span>
<a href="#l3.3482"></a><span id="l3.3482" class="difflineminus">-      break;</span>
<a href="#l3.3483"></a><span id="l3.3483" class="difflineminus">-    default:</span>
<a href="#l3.3484"></a><span id="l3.3484" class="difflineminus">-      namespaceType = kUnknownNamespace;</span>
<a href="#l3.3485"></a><span id="l3.3485" class="difflineminus">-      break;</span>
<a href="#l3.3486"></a><span id="l3.3486" class="difflineplus">+    switch (namespaceType) {</span>
<a href="#l3.3487"></a><span id="l3.3487" class="difflineplus">+      case kPersonalNamespace:</span>
<a href="#l3.3488"></a><span id="l3.3488" class="difflineplus">+        namespaceType = kOtherUsersNamespace;</span>
<a href="#l3.3489"></a><span id="l3.3489" class="difflineplus">+        break;</span>
<a href="#l3.3490"></a><span id="l3.3490" class="difflineplus">+      case kOtherUsersNamespace:</span>
<a href="#l3.3491"></a><span id="l3.3491" class="difflineplus">+        namespaceType = kPublicNamespace;</span>
<a href="#l3.3492"></a><span id="l3.3492" class="difflineplus">+        break;</span>
<a href="#l3.3493"></a><span id="l3.3493" class="difflineplus">+      default:</span>
<a href="#l3.3494"></a><span id="l3.3494" class="difflineplus">+        namespaceType = kUnknownNamespace;</span>
<a href="#l3.3495"></a><span id="l3.3495" class="difflineplus">+        break;</span>
<a href="#l3.3496"></a><span id="l3.3496">     }</span>
<a href="#l3.3497"></a><span id="l3.3497">   }</span>
<a href="#l3.3498"></a><span id="l3.3498" class="difflineminus">-  if (ContinueParse())</span>
<a href="#l3.3499"></a><span id="l3.3499" class="difflineminus">-  {</span>
<a href="#l3.3500"></a><span id="l3.3500" class="difflineplus">+  if (ContinueParse()) {</span>
<a href="#l3.3501"></a><span id="l3.3501">     nsImapProtocol *navCon = &amp;fServerConnection;</span>
<a href="#l3.3502"></a><span id="l3.3502" class="difflineminus">-    NS_ASSERTION(navCon, &quot;null protocol connection while parsing namespace&quot;);  // we should always have this</span>
<a href="#l3.3503"></a><span id="l3.3503" class="difflineminus">-    if (navCon)</span>
<a href="#l3.3504"></a><span id="l3.3504" class="difflineminus">-    {</span>
<a href="#l3.3505"></a><span id="l3.3505" class="difflineplus">+    NS_ASSERTION(</span>
<a href="#l3.3506"></a><span id="l3.3506" class="difflineplus">+        navCon,</span>
<a href="#l3.3507"></a><span id="l3.3507" class="difflineplus">+        &quot;null protocol connection while parsing namespace&quot;);  // we should</span>
<a href="#l3.3508"></a><span id="l3.3508" class="difflineplus">+                                                              // always have</span>
<a href="#l3.3509"></a><span id="l3.3509" class="difflineplus">+                                                              // this</span>
<a href="#l3.3510"></a><span id="l3.3510" class="difflineplus">+    if (navCon) {</span>
<a href="#l3.3511"></a><span id="l3.3511">       navCon-&gt;CommitNamespacesForHostEvent();</span>
<a href="#l3.3512"></a><span id="l3.3512">       namespacesCommitted = true;</span>
<a href="#l3.3513"></a><span id="l3.3513">     }</span>
<a href="#l3.3514"></a><span id="l3.3514">   }</span>
<a href="#l3.3515"></a><span id="l3.3515">   skip_to_CRLF();</span>
<a href="#l3.3516"></a><span id="l3.3516"> </span>
<a href="#l3.3517"></a><span id="l3.3517" class="difflineminus">-  if (!namespacesCommitted &amp;&amp; fHostSessionList)</span>
<a href="#l3.3518"></a><span id="l3.3518" class="difflineminus">-  {</span>
<a href="#l3.3519"></a><span id="l3.3519" class="difflineplus">+  if (!namespacesCommitted &amp;&amp; fHostSessionList) {</span>
<a href="#l3.3520"></a><span id="l3.3520">     bool success;</span>
<a href="#l3.3521"></a><span id="l3.3521" class="difflineminus">-    fHostSessionList-&gt;FlushUncommittedNamespacesForHost(serverKey,</span>
<a href="#l3.3522"></a><span id="l3.3522" class="difflineminus">-                                                            success);</span>
<a href="#l3.3523"></a><span id="l3.3523" class="difflineplus">+    fHostSessionList-&gt;FlushUncommittedNamespacesForHost(serverKey, success);</span>
<a href="#l3.3524"></a><span id="l3.3524">   }</span>
<a href="#l3.3525"></a><span id="l3.3525"> }</span>
<a href="#l3.3526"></a><span id="l3.3526"> </span>
<a href="#l3.3527"></a><span id="l3.3527" class="difflineminus">-void nsImapServerResponseParser::myrights_data(bool unsolicited)</span>
<a href="#l3.3528"></a><span id="l3.3528" class="difflineminus">-{</span>
<a href="#l3.3529"></a><span id="l3.3529" class="difflineplus">+void nsImapServerResponseParser::myrights_data(bool unsolicited) {</span>
<a href="#l3.3530"></a><span id="l3.3530">   AdvanceToNextToken();</span>
<a href="#l3.3531"></a><span id="l3.3531" class="difflineminus">-  if (ContinueParse() &amp;&amp; !fAtEndOfLine)</span>
<a href="#l3.3532"></a><span id="l3.3532" class="difflineminus">-  {</span>
<a href="#l3.3533"></a><span id="l3.3533" class="difflineplus">+  if (ContinueParse() &amp;&amp; !fAtEndOfLine) {</span>
<a href="#l3.3534"></a><span id="l3.3534">     char *mailboxName;</span>
<a href="#l3.3535"></a><span id="l3.3535">     // an unsolicited myrights response won't have the mailbox name in</span>
<a href="#l3.3536"></a><span id="l3.3536">     // the response, so we use the selected mailbox name.</span>
<a href="#l3.3537"></a><span id="l3.3537" class="difflineminus">-    if (unsolicited)</span>
<a href="#l3.3538"></a><span id="l3.3538" class="difflineminus">-    {</span>
<a href="#l3.3539"></a><span id="l3.3539" class="difflineplus">+    if (unsolicited) {</span>
<a href="#l3.3540"></a><span id="l3.3540">       mailboxName = strdup(fSelectedMailboxName);</span>
<a href="#l3.3541"></a><span id="l3.3541" class="difflineminus">-    }</span>
<a href="#l3.3542"></a><span id="l3.3542" class="difflineminus">-    else</span>
<a href="#l3.3543"></a><span id="l3.3543" class="difflineminus">-    {</span>
<a href="#l3.3544"></a><span id="l3.3544" class="difflineplus">+    } else {</span>
<a href="#l3.3545"></a><span id="l3.3545">       mailboxName = CreateAstring();</span>
<a href="#l3.3546"></a><span id="l3.3546" class="difflineminus">-      if (mailboxName)</span>
<a href="#l3.3547"></a><span id="l3.3547" class="difflineminus">-        AdvanceToNextToken();</span>
<a href="#l3.3548"></a><span id="l3.3548" class="difflineplus">+      if (mailboxName) AdvanceToNextToken();</span>
<a href="#l3.3549"></a><span id="l3.3549">     }</span>
<a href="#l3.3550"></a><span id="l3.3550" class="difflineminus">-    if (mailboxName)</span>
<a href="#l3.3551"></a><span id="l3.3551" class="difflineminus">-    {</span>
<a href="#l3.3552"></a><span id="l3.3552" class="difflineminus">-      if (ContinueParse())</span>
<a href="#l3.3553"></a><span id="l3.3553" class="difflineminus">-      {</span>
<a href="#l3.3554"></a><span id="l3.3554" class="difflineplus">+    if (mailboxName) {</span>
<a href="#l3.3555"></a><span id="l3.3555" class="difflineplus">+      if (ContinueParse()) {</span>
<a href="#l3.3556"></a><span id="l3.3556">         char *myrights = CreateAstring();</span>
<a href="#l3.3557"></a><span id="l3.3557" class="difflineminus">-        if (myrights)</span>
<a href="#l3.3558"></a><span id="l3.3558" class="difflineminus">-        {</span>
<a href="#l3.3559"></a><span id="l3.3559" class="difflineplus">+        if (myrights) {</span>
<a href="#l3.3560"></a><span id="l3.3560">           nsImapProtocol *navCon = &amp;fServerConnection;</span>
<a href="#l3.3561"></a><span id="l3.3561" class="difflineminus">-          NS_ASSERTION(navCon, &quot;null connection parsing my rights&quot;); // we should always have this</span>
<a href="#l3.3562"></a><span id="l3.3562" class="difflineplus">+          NS_ASSERTION(</span>
<a href="#l3.3563"></a><span id="l3.3563" class="difflineplus">+              navCon, &quot;null connection parsing my rights&quot;);  // we should always</span>
<a href="#l3.3564"></a><span id="l3.3564" class="difflineplus">+                                                             // have this</span>
<a href="#l3.3565"></a><span id="l3.3565">           if (navCon)</span>
<a href="#l3.3566"></a><span id="l3.3566" class="difflineminus">-            navCon-&gt;AddFolderRightsForUser(mailboxName, nullptr /* means &quot;me&quot; */, myrights);</span>
<a href="#l3.3567"></a><span id="l3.3567" class="difflineplus">+            navCon-&gt;AddFolderRightsForUser(mailboxName,</span>
<a href="#l3.3568"></a><span id="l3.3568" class="difflineplus">+                                           nullptr /* means &quot;me&quot; */, myrights);</span>
<a href="#l3.3569"></a><span id="l3.3569">           PR_Free(myrights);</span>
<a href="#l3.3570"></a><span id="l3.3570" class="difflineminus">-        }</span>
<a href="#l3.3571"></a><span id="l3.3571" class="difflineminus">-        else</span>
<a href="#l3.3572"></a><span id="l3.3572" class="difflineminus">-        {</span>
<a href="#l3.3573"></a><span id="l3.3573" class="difflineplus">+        } else {</span>
<a href="#l3.3574"></a><span id="l3.3574">           HandleMemoryFailure();</span>
<a href="#l3.3575"></a><span id="l3.3575">         }</span>
<a href="#l3.3576"></a><span id="l3.3576" class="difflineminus">-        if (ContinueParse())</span>
<a href="#l3.3577"></a><span id="l3.3577" class="difflineminus">-          AdvanceToNextToken();</span>
<a href="#l3.3578"></a><span id="l3.3578" class="difflineplus">+        if (ContinueParse()) AdvanceToNextToken();</span>
<a href="#l3.3579"></a><span id="l3.3579">       }</span>
<a href="#l3.3580"></a><span id="l3.3580">       PR_Free(mailboxName);</span>
<a href="#l3.3581"></a><span id="l3.3581" class="difflineminus">-    }</span>
<a href="#l3.3582"></a><span id="l3.3582" class="difflineminus">-    else</span>
<a href="#l3.3583"></a><span id="l3.3583" class="difflineminus">-    {</span>
<a href="#l3.3584"></a><span id="l3.3584" class="difflineplus">+    } else {</span>
<a href="#l3.3585"></a><span id="l3.3585">       HandleMemoryFailure();</span>
<a href="#l3.3586"></a><span id="l3.3586">     }</span>
<a href="#l3.3587"></a><span id="l3.3587" class="difflineminus">-  }</span>
<a href="#l3.3588"></a><span id="l3.3588" class="difflineminus">-  else</span>
<a href="#l3.3589"></a><span id="l3.3589" class="difflineminus">-  {</span>
<a href="#l3.3590"></a><span id="l3.3590" class="difflineplus">+  } else {</span>
<a href="#l3.3591"></a><span id="l3.3591">     SetSyntaxError(true);</span>
<a href="#l3.3592"></a><span id="l3.3592">   }</span>
<a href="#l3.3593"></a><span id="l3.3593"> }</span>
<a href="#l3.3594"></a><span id="l3.3594"> </span>
<a href="#l3.3595"></a><span id="l3.3595" class="difflineminus">-void nsImapServerResponseParser::acl_data()</span>
<a href="#l3.3596"></a><span id="l3.3596" class="difflineminus">-{</span>
<a href="#l3.3597"></a><span id="l3.3597" class="difflineplus">+void nsImapServerResponseParser::acl_data() {</span>
<a href="#l3.3598"></a><span id="l3.3598">   AdvanceToNextToken();</span>
<a href="#l3.3599"></a><span id="l3.3599" class="difflineminus">-  if (ContinueParse() &amp;&amp; !fAtEndOfLine)</span>
<a href="#l3.3600"></a><span id="l3.3600" class="difflineminus">-  {</span>
<a href="#l3.3601"></a><span id="l3.3601" class="difflineplus">+  if (ContinueParse() &amp;&amp; !fAtEndOfLine) {</span>
<a href="#l3.3602"></a><span id="l3.3602">     char *mailboxName = CreateAstring();  // PL_strdup(fNextToken);</span>
<a href="#l3.3603"></a><span id="l3.3603" class="difflineminus">-    if (mailboxName &amp;&amp; ContinueParse())</span>
<a href="#l3.3604"></a><span id="l3.3604" class="difflineminus">-    {</span>
<a href="#l3.3605"></a><span id="l3.3605" class="difflineplus">+    if (mailboxName &amp;&amp; ContinueParse()) {</span>
<a href="#l3.3606"></a><span id="l3.3606">       AdvanceToNextToken();</span>
<a href="#l3.3607"></a><span id="l3.3607" class="difflineminus">-      while (ContinueParse() &amp;&amp; !fAtEndOfLine)</span>
<a href="#l3.3608"></a><span id="l3.3608" class="difflineminus">-      {</span>
<a href="#l3.3609"></a><span id="l3.3609" class="difflineminus">-        char *userName = CreateAstring(); // PL_strdup(fNextToken);</span>
<a href="#l3.3610"></a><span id="l3.3610" class="difflineminus">-        if (userName &amp;&amp; ContinueParse())</span>
<a href="#l3.3611"></a><span id="l3.3611" class="difflineminus">-        {</span>
<a href="#l3.3612"></a><span id="l3.3612" class="difflineplus">+      while (ContinueParse() &amp;&amp; !fAtEndOfLine) {</span>
<a href="#l3.3613"></a><span id="l3.3613" class="difflineplus">+        char *userName = CreateAstring();  // PL_strdup(fNextToken);</span>
<a href="#l3.3614"></a><span id="l3.3614" class="difflineplus">+        if (userName &amp;&amp; ContinueParse()) {</span>
<a href="#l3.3615"></a><span id="l3.3615">           AdvanceToNextToken();</span>
<a href="#l3.3616"></a><span id="l3.3616" class="difflineminus">-          if (ContinueParse())</span>
<a href="#l3.3617"></a><span id="l3.3617" class="difflineminus">-          {</span>
<a href="#l3.3618"></a><span id="l3.3618" class="difflineminus">-            char *rights = CreateAstring(); // PL_strdup(fNextToken);</span>
<a href="#l3.3619"></a><span id="l3.3619" class="difflineminus">-            if (rights)</span>
<a href="#l3.3620"></a><span id="l3.3620" class="difflineminus">-            {</span>
<a href="#l3.3621"></a><span id="l3.3621" class="difflineminus">-              fServerConnection.AddFolderRightsForUser(mailboxName, userName, rights);</span>
<a href="#l3.3622"></a><span id="l3.3622" class="difflineplus">+          if (ContinueParse()) {</span>
<a href="#l3.3623"></a><span id="l3.3623" class="difflineplus">+            char *rights = CreateAstring();  // PL_strdup(fNextToken);</span>
<a href="#l3.3624"></a><span id="l3.3624" class="difflineplus">+            if (rights) {</span>
<a href="#l3.3625"></a><span id="l3.3625" class="difflineplus">+              fServerConnection.AddFolderRightsForUser(mailboxName, userName,</span>
<a href="#l3.3626"></a><span id="l3.3626" class="difflineplus">+                                                       rights);</span>
<a href="#l3.3627"></a><span id="l3.3627">               PR_Free(rights);</span>
<a href="#l3.3628"></a><span id="l3.3628" class="difflineminus">-            }</span>
<a href="#l3.3629"></a><span id="l3.3629" class="difflineminus">-            else</span>
<a href="#l3.3630"></a><span id="l3.3630" class="difflineplus">+            } else</span>
<a href="#l3.3631"></a><span id="l3.3631">               HandleMemoryFailure();</span>
<a href="#l3.3632"></a><span id="l3.3632"> </span>
<a href="#l3.3633"></a><span id="l3.3633" class="difflineminus">-            if (ContinueParse())</span>
<a href="#l3.3634"></a><span id="l3.3634" class="difflineminus">-              AdvanceToNextToken();</span>
<a href="#l3.3635"></a><span id="l3.3635" class="difflineplus">+            if (ContinueParse()) AdvanceToNextToken();</span>
<a href="#l3.3636"></a><span id="l3.3636">           }</span>
<a href="#l3.3637"></a><span id="l3.3637">           PR_Free(userName);</span>
<a href="#l3.3638"></a><span id="l3.3638" class="difflineminus">-        }</span>
<a href="#l3.3639"></a><span id="l3.3639" class="difflineminus">-        else</span>
<a href="#l3.3640"></a><span id="l3.3640" class="difflineplus">+        } else</span>
<a href="#l3.3641"></a><span id="l3.3641">           HandleMemoryFailure();</span>
<a href="#l3.3642"></a><span id="l3.3642">       }</span>
<a href="#l3.3643"></a><span id="l3.3643">       PR_Free(mailboxName);</span>
<a href="#l3.3644"></a><span id="l3.3644" class="difflineminus">-    }</span>
<a href="#l3.3645"></a><span id="l3.3645" class="difflineminus">-    else</span>
<a href="#l3.3646"></a><span id="l3.3646" class="difflineplus">+    } else</span>
<a href="#l3.3647"></a><span id="l3.3647">       HandleMemoryFailure();</span>
<a href="#l3.3648"></a><span id="l3.3648">   }</span>
<a href="#l3.3649"></a><span id="l3.3649"> }</span>
<a href="#l3.3650"></a><span id="l3.3650"> </span>
<a href="#l3.3651"></a><span id="l3.3651" class="difflineminus">-</span>
<a href="#l3.3652"></a><span id="l3.3652" class="difflineminus">-void nsImapServerResponseParser::mime_data()</span>
<a href="#l3.3653"></a><span id="l3.3653" class="difflineminus">-{</span>
<a href="#l3.3654"></a><span id="l3.3654" class="difflineplus">+void nsImapServerResponseParser::mime_data() {</span>
<a href="#l3.3655"></a><span id="l3.3655">   if (PL_strstr(fNextToken, &quot;MIME&quot;))</span>
<a href="#l3.3656"></a><span id="l3.3656">     mime_header_data();</span>
<a href="#l3.3657"></a><span id="l3.3657">   else</span>
<a href="#l3.3658"></a><span id="l3.3658">     mime_part_data();</span>
<a href="#l3.3659"></a><span id="l3.3659"> }</span>
<a href="#l3.3660"></a><span id="l3.3660"> </span>
<a href="#l3.3661"></a><span id="l3.3661"> // mime_header_data should not be streamed out;  rather, it should be</span>
<a href="#l3.3662"></a><span id="l3.3662"> // buffered in the nsIMAPBodyShell.</span>
<a href="#l3.3663"></a><span id="l3.3663"> // This is because we are still in the process of generating enough</span>
<a href="#l3.3664"></a><span id="l3.3664"> // information from the server (such as the MIME header's size) so that</span>
<a href="#l3.3665"></a><span id="l3.3665"> // we can construct the final output stream.</span>
<a href="#l3.3666"></a><span id="l3.3666" class="difflineminus">-void nsImapServerResponseParser::mime_header_data()</span>
<a href="#l3.3667"></a><span id="l3.3667" class="difflineminus">-{</span>
<a href="#l3.3668"></a><span id="l3.3668" class="difflineplus">+void nsImapServerResponseParser::mime_header_data() {</span>
<a href="#l3.3669"></a><span id="l3.3669">   char *partNumber = PL_strdup(fNextToken);</span>
<a href="#l3.3670"></a><span id="l3.3670" class="difflineminus">-  if (partNumber)</span>
<a href="#l3.3671"></a><span id="l3.3671" class="difflineminus">-  {</span>
<a href="#l3.3672"></a><span id="l3.3672" class="difflineminus">-    char *start = partNumber + 5, *end = partNumber + 5; // 5 == strlen(&quot;BODY[&quot;)</span>
<a href="#l3.3673"></a><span id="l3.3673" class="difflineminus">-    while (ContinueParse() &amp;&amp; end &amp;&amp; *end != 'M' &amp;&amp; *end != 'm')</span>
<a href="#l3.3674"></a><span id="l3.3674" class="difflineminus">-    {</span>
<a href="#l3.3675"></a><span id="l3.3675" class="difflineplus">+  if (partNumber) {</span>
<a href="#l3.3676"></a><span id="l3.3676" class="difflineplus">+    char *start = partNumber + 5,</span>
<a href="#l3.3677"></a><span id="l3.3677" class="difflineplus">+         *end = partNumber + 5;  // 5 == strlen(&quot;BODY[&quot;)</span>
<a href="#l3.3678"></a><span id="l3.3678" class="difflineplus">+    while (ContinueParse() &amp;&amp; end &amp;&amp; *end != 'M' &amp;&amp; *end != 'm') {</span>
<a href="#l3.3679"></a><span id="l3.3679">       end++;</span>
<a href="#l3.3680"></a><span id="l3.3680">     }</span>
<a href="#l3.3681"></a><span id="l3.3681" class="difflineminus">-    if (end &amp;&amp; (*end == 'M' || *end == 'm'))</span>
<a href="#l3.3682"></a><span id="l3.3682" class="difflineminus">-    {</span>
<a href="#l3.3683"></a><span id="l3.3683" class="difflineminus">-      *(end-1) = 0;</span>
<a href="#l3.3684"></a><span id="l3.3684" class="difflineplus">+    if (end &amp;&amp; (*end == 'M' || *end == 'm')) {</span>
<a href="#l3.3685"></a><span id="l3.3685" class="difflineplus">+      *(end - 1) = 0;</span>
<a href="#l3.3686"></a><span id="l3.3686">       AdvanceToNextToken();</span>
<a href="#l3.3687"></a><span id="l3.3687">       char *mimeHeaderData = CreateAstring();  // is it really this simple?</span>
<a href="#l3.3688"></a><span id="l3.3688">       AdvanceToNextToken();</span>
<a href="#l3.3689"></a><span id="l3.3689" class="difflineminus">-      if (m_shell)</span>
<a href="#l3.3690"></a><span id="l3.3690" class="difflineminus">-      {</span>
<a href="#l3.3691"></a><span id="l3.3691" class="difflineplus">+      if (m_shell) {</span>
<a href="#l3.3692"></a><span id="l3.3692">         m_shell-&gt;AdoptMimeHeader(start, mimeHeaderData);</span>
<a href="#l3.3693"></a><span id="l3.3693">       }</span>
<a href="#l3.3694"></a><span id="l3.3694" class="difflineminus">-    }</span>
<a href="#l3.3695"></a><span id="l3.3695" class="difflineminus">-    else</span>
<a href="#l3.3696"></a><span id="l3.3696" class="difflineminus">-    {</span>
<a href="#l3.3697"></a><span id="l3.3697" class="difflineplus">+    } else {</span>
<a href="#l3.3698"></a><span id="l3.3698">       SetSyntaxError(true);</span>
<a href="#l3.3699"></a><span id="l3.3699">     }</span>
<a href="#l3.3700"></a><span id="l3.3700">     PR_Free(partNumber);  // partNumber is not adopted by the body shell.</span>
<a href="#l3.3701"></a><span id="l3.3701" class="difflineminus">-  }</span>
<a href="#l3.3702"></a><span id="l3.3702" class="difflineminus">-  else</span>
<a href="#l3.3703"></a><span id="l3.3703" class="difflineminus">-  {</span>
<a href="#l3.3704"></a><span id="l3.3704" class="difflineplus">+  } else {</span>
<a href="#l3.3705"></a><span id="l3.3705">     HandleMemoryFailure();</span>
<a href="#l3.3706"></a><span id="l3.3706">   }</span>
<a href="#l3.3707"></a><span id="l3.3707"> }</span>
<a href="#l3.3708"></a><span id="l3.3708"> </span>
<a href="#l3.3709"></a><span id="l3.3709"> // Actual mime parts are filled in on demand (either from shell generation</span>
<a href="#l3.3710"></a><span id="l3.3710"> // or from explicit user download), so we need to stream these out.</span>
<a href="#l3.3711"></a><span id="l3.3711" class="difflineminus">-void nsImapServerResponseParser::mime_part_data()</span>
<a href="#l3.3712"></a><span id="l3.3712" class="difflineminus">-{</span>
<a href="#l3.3713"></a><span id="l3.3713" class="difflineplus">+void nsImapServerResponseParser::mime_part_data() {</span>
<a href="#l3.3714"></a><span id="l3.3714">   char *checkOriginToken = PL_strdup(fNextToken);</span>
<a href="#l3.3715"></a><span id="l3.3715" class="difflineminus">-  if (checkOriginToken)</span>
<a href="#l3.3716"></a><span id="l3.3716" class="difflineminus">-  {</span>
<a href="#l3.3717"></a><span id="l3.3717" class="difflineplus">+  if (checkOriginToken) {</span>
<a href="#l3.3718"></a><span id="l3.3718">     uint32_t origin = 0;</span>
<a href="#l3.3719"></a><span id="l3.3719">     bool originFound = false;</span>
<a href="#l3.3720"></a><span id="l3.3720">     char *whereStart = PL_strchr(checkOriginToken, '&lt;');</span>
<a href="#l3.3721"></a><span id="l3.3721" class="difflineminus">-    if (whereStart)</span>
<a href="#l3.3722"></a><span id="l3.3722" class="difflineminus">-    {</span>
<a href="#l3.3723"></a><span id="l3.3723" class="difflineplus">+    if (whereStart) {</span>
<a href="#l3.3724"></a><span id="l3.3724">       char *whereEnd = PL_strchr(whereStart, '&gt;');</span>
<a href="#l3.3725"></a><span id="l3.3725" class="difflineminus">-      if (whereEnd)</span>
<a href="#l3.3726"></a><span id="l3.3726" class="difflineminus">-      {</span>
<a href="#l3.3727"></a><span id="l3.3727" class="difflineplus">+      if (whereEnd) {</span>
<a href="#l3.3728"></a><span id="l3.3728">         *whereEnd = 0;</span>
<a href="#l3.3729"></a><span id="l3.3729">         whereStart++;</span>
<a href="#l3.3730"></a><span id="l3.3730">         origin = atoi(whereStart);</span>
<a href="#l3.3731"></a><span id="l3.3731">         originFound = true;</span>
<a href="#l3.3732"></a><span id="l3.3732">       }</span>
<a href="#l3.3733"></a><span id="l3.3733">     }</span>
<a href="#l3.3734"></a><span id="l3.3734">     PR_Free(checkOriginToken);</span>
<a href="#l3.3735"></a><span id="l3.3735">     AdvanceToNextToken();</span>
<a href="#l3.3736"></a><span id="l3.3736" class="difflineminus">-    msg_fetch_content(originFound, origin, MESSAGE_RFC822);  // keep content type as message/rfc822, even though the</span>
<a href="#l3.3737"></a><span id="l3.3737" class="difflineplus">+    msg_fetch_content(originFound, origin,</span>
<a href="#l3.3738"></a><span id="l3.3738" class="difflineplus">+                      MESSAGE_RFC822);  // keep content type as message/rfc822,</span>
<a href="#l3.3739"></a><span id="l3.3739" class="difflineplus">+                                        // even though the</span>
<a href="#l3.3740"></a><span id="l3.3740">     // MIME part might not be, because then libmime will</span>
<a href="#l3.3741"></a><span id="l3.3741">     // still handle and decode it.</span>
<a href="#l3.3742"></a><span id="l3.3742" class="difflineminus">-  }</span>
<a href="#l3.3743"></a><span id="l3.3743" class="difflineminus">-  else</span>
<a href="#l3.3744"></a><span id="l3.3744" class="difflineplus">+  } else</span>
<a href="#l3.3745"></a><span id="l3.3745">     HandleMemoryFailure();</span>
<a href="#l3.3746"></a><span id="l3.3746"> }</span>
<a href="#l3.3747"></a><span id="l3.3747"> </span>
<a href="#l3.3748"></a><span id="l3.3748"> // parse FETCH BODYSTRUCTURE response, &quot;a parenthesized list that describes</span>
<a href="#l3.3749"></a><span id="l3.3749"> // the [MIME-IMB] body structure of a message&quot; [RFC 3501].</span>
<a href="#l3.3750"></a><span id="l3.3750" class="difflineminus">-void nsImapServerResponseParser::bodystructure_data()</span>
<a href="#l3.3751"></a><span id="l3.3751" class="difflineminus">-{</span>
<a href="#l3.3752"></a><span id="l3.3752" class="difflineplus">+void nsImapServerResponseParser::bodystructure_data() {</span>
<a href="#l3.3753"></a><span id="l3.3753">   AdvanceToNextToken();</span>
<a href="#l3.3754"></a><span id="l3.3754" class="difflineminus">-  if (ContinueParse() &amp;&amp; fNextToken &amp;&amp; *fNextToken == '(')  // It has to start with an open paren.</span>
<a href="#l3.3755"></a><span id="l3.3755" class="difflineplus">+  if (ContinueParse() &amp;&amp; fNextToken &amp;&amp;</span>
<a href="#l3.3756"></a><span id="l3.3756" class="difflineplus">+      *fNextToken == '(')  // It has to start with an open paren.</span>
<a href="#l3.3757"></a><span id="l3.3757">   {</span>
<a href="#l3.3758"></a><span id="l3.3758" class="difflineminus">-    // Turn the BODYSTRUCTURE response into a form that the nsIMAPBodypartMessage can be constructed from.</span>
<a href="#l3.3759"></a><span id="l3.3759" class="difflineminus">-    // FIXME: Follow up on bug 384210 to investigate why the caller has to duplicate the two in-param strings.</span>
<a href="#l3.3760"></a><span id="l3.3760" class="difflineminus">-    nsIMAPBodypartMessage *message =</span>
<a href="#l3.3761"></a><span id="l3.3761" class="difflineminus">-      new nsIMAPBodypartMessage(NULL, NULL, true, strdup(&quot;message&quot;),</span>
<a href="#l3.3762"></a><span id="l3.3762" class="difflineminus">-                                strdup(&quot;rfc822&quot;),</span>
<a href="#l3.3763"></a><span id="l3.3763" class="difflineminus">-                                NULL, NULL, NULL, 0,</span>
<a href="#l3.3764"></a><span id="l3.3764" class="difflineminus">-                                fServerConnection.GetPreferPlainText());</span>
<a href="#l3.3765"></a><span id="l3.3765" class="difflineplus">+    // Turn the BODYSTRUCTURE response into a form that the</span>
<a href="#l3.3766"></a><span id="l3.3766" class="difflineplus">+    // nsIMAPBodypartMessage can be constructed from.</span>
<a href="#l3.3767"></a><span id="l3.3767" class="difflineplus">+    // FIXME: Follow up on bug 384210 to investigate why the caller has to</span>
<a href="#l3.3768"></a><span id="l3.3768" class="difflineplus">+    // duplicate the two in-param strings.</span>
<a href="#l3.3769"></a><span id="l3.3769" class="difflineplus">+    nsIMAPBodypartMessage *message = new nsIMAPBodypartMessage(</span>
<a href="#l3.3770"></a><span id="l3.3770" class="difflineplus">+        NULL, NULL, true, strdup(&quot;message&quot;), strdup(&quot;rfc822&quot;), NULL, NULL, NULL,</span>
<a href="#l3.3771"></a><span id="l3.3771" class="difflineplus">+        0, fServerConnection.GetPreferPlainText());</span>
<a href="#l3.3772"></a><span id="l3.3772">     nsIMAPBodypart *body = bodystructure_part(PL_strdup(&quot;1&quot;), message);</span>
<a href="#l3.3773"></a><span id="l3.3773">     if (body)</span>
<a href="#l3.3774"></a><span id="l3.3774">       message-&gt;SetBody(body);</span>
<a href="#l3.3775"></a><span id="l3.3775" class="difflineminus">-    else</span>
<a href="#l3.3776"></a><span id="l3.3776" class="difflineminus">-    {</span>
<a href="#l3.3777"></a><span id="l3.3777" class="difflineplus">+    else {</span>
<a href="#l3.3778"></a><span id="l3.3778">       delete message;</span>
<a href="#l3.3779"></a><span id="l3.3779">       message = nullptr;</span>
<a href="#l3.3780"></a><span id="l3.3780">     }</span>
<a href="#l3.3781"></a><span id="l3.3781" class="difflineminus">-    m_shell = new nsIMAPBodyShell(&amp;fServerConnection, message, CurrentResponseUID(),</span>
<a href="#l3.3782"></a><span id="l3.3782" class="difflineminus">-                                  FolderUID(), GetSelectedMailboxName());</span>
<a href="#l3.3783"></a><span id="l3.3783" class="difflineminus">-    // ignore syntax errors in parsing the body structure response. If there's an error</span>
<a href="#l3.3784"></a><span id="l3.3784" class="difflineminus">-    // we'll just fall back to fetching the whole message.</span>
<a href="#l3.3785"></a><span id="l3.3785" class="difflineplus">+    m_shell =</span>
<a href="#l3.3786"></a><span id="l3.3786" class="difflineplus">+        new nsIMAPBodyShell(&amp;fServerConnection, message, CurrentResponseUID(),</span>
<a href="#l3.3787"></a><span id="l3.3787" class="difflineplus">+                            FolderUID(), GetSelectedMailboxName());</span>
<a href="#l3.3788"></a><span id="l3.3788" class="difflineplus">+    // ignore syntax errors in parsing the body structure response. If there's</span>
<a href="#l3.3789"></a><span id="l3.3789" class="difflineplus">+    // an error we'll just fall back to fetching the whole message.</span>
<a href="#l3.3790"></a><span id="l3.3790">     SetSyntaxError(false);</span>
<a href="#l3.3791"></a><span id="l3.3791" class="difflineminus">-  }</span>
<a href="#l3.3792"></a><span id="l3.3792" class="difflineminus">-  else</span>
<a href="#l3.3793"></a><span id="l3.3793" class="difflineplus">+  } else</span>
<a href="#l3.3794"></a><span id="l3.3794">     SetSyntaxError(true);</span>
<a href="#l3.3795"></a><span id="l3.3795"> }</span>
<a href="#l3.3796"></a><span id="l3.3796"> </span>
<a href="#l3.3797"></a><span id="l3.3797"> // RFC3501:  body = &quot;(&quot; (body-type-1part / body-type-mpart) &quot;)&quot;</span>
<a href="#l3.3798"></a><span id="l3.3798" class="difflineminus">-nsIMAPBodypart *</span>
<a href="#l3.3799"></a><span id="l3.3799" class="difflineminus">-nsImapServerResponseParser::bodystructure_part(char *partNum, nsIMAPBodypart *parentPart)</span>
<a href="#l3.3800"></a><span id="l3.3800" class="difflineminus">-{</span>
<a href="#l3.3801"></a><span id="l3.3801" class="difflineplus">+nsIMAPBodypart *nsImapServerResponseParser::bodystructure_part(</span>
<a href="#l3.3802"></a><span id="l3.3802" class="difflineplus">+    char *partNum, nsIMAPBodypart *parentPart) {</span>
<a href="#l3.3803"></a><span id="l3.3803">   // Check to see if this buffer is a leaf or container</span>
<a href="#l3.3804"></a><span id="l3.3804">   // (Look at second character - if an open paren, then it is a container)</span>
<a href="#l3.3805"></a><span id="l3.3805" class="difflineminus">-  if (*fNextToken != '(')</span>
<a href="#l3.3806"></a><span id="l3.3806" class="difflineminus">-  {</span>
<a href="#l3.3807"></a><span id="l3.3807" class="difflineplus">+  if (*fNextToken != '(') {</span>
<a href="#l3.3808"></a><span id="l3.3808">     NS_ASSERTION(false, &quot;bodystructure_part must begin with '('&quot;);</span>
<a href="#l3.3809"></a><span id="l3.3809">     return NULL;</span>
<a href="#l3.3810"></a><span id="l3.3810">   }</span>
<a href="#l3.3811"></a><span id="l3.3811"> </span>
<a href="#l3.3812"></a><span id="l3.3812" class="difflineminus">-  if (fNextToken[1] == '(')</span>
<a href="#l3.3813"></a><span id="l3.3813" class="difflineminus">-    return bodystructure_multipart(partNum, parentPart);</span>
<a href="#l3.3814"></a><span id="l3.3814" class="difflineplus">+  if (fNextToken[1] == '(') return bodystructure_multipart(partNum, parentPart);</span>
<a href="#l3.3815"></a><span id="l3.3815">   return bodystructure_leaf(partNum, parentPart);</span>
<a href="#l3.3816"></a><span id="l3.3816"> }</span>
<a href="#l3.3817"></a><span id="l3.3817"> </span>
<a href="#l3.3818"></a><span id="l3.3818"> // RFC3501: body-type-1part = (body-type-basic / body-type-msg / body-type-text)</span>
<a href="#l3.3819"></a><span id="l3.3819"> //                            [SP body-ext-1part]</span>
<a href="#l3.3820"></a><span id="l3.3820" class="difflineminus">-nsIMAPBodypart *</span>
<a href="#l3.3821"></a><span id="l3.3821" class="difflineminus">-nsImapServerResponseParser::bodystructure_leaf(char *partNum, nsIMAPBodypart *parentPart)</span>
<a href="#l3.3822"></a><span id="l3.3822" class="difflineminus">-{</span>
<a href="#l3.3823"></a><span id="l3.3823" class="difflineminus">-  // historical note: this code was originally in nsIMAPBodypartLeaf::ParseIntoObjects()</span>
<a href="#l3.3824"></a><span id="l3.3824" class="difflineminus">-  char *bodyType = nullptr, *bodySubType = nullptr, *bodyID = nullptr, *bodyDescription = nullptr, *bodyEncoding = nullptr;</span>
<a href="#l3.3825"></a><span id="l3.3825" class="difflineplus">+nsIMAPBodypart *nsImapServerResponseParser::bodystructure_leaf(</span>
<a href="#l3.3826"></a><span id="l3.3826" class="difflineplus">+    char *partNum, nsIMAPBodypart *parentPart) {</span>
<a href="#l3.3827"></a><span id="l3.3827" class="difflineplus">+  // historical note: this code was originally in</span>
<a href="#l3.3828"></a><span id="l3.3828" class="difflineplus">+  // nsIMAPBodypartLeaf::ParseIntoObjects()</span>
<a href="#l3.3829"></a><span id="l3.3829" class="difflineplus">+  char *bodyType = nullptr, *bodySubType = nullptr, *bodyID = nullptr,</span>
<a href="#l3.3830"></a><span id="l3.3830" class="difflineplus">+       *bodyDescription = nullptr, *bodyEncoding = nullptr;</span>
<a href="#l3.3831"></a><span id="l3.3831">   int32_t partLength = 0;</span>
<a href="#l3.3832"></a><span id="l3.3832">   bool isValid = true;</span>
<a href="#l3.3833"></a><span id="l3.3833"> </span>
<a href="#l3.3834"></a><span id="l3.3834">   // body type  (&quot;application&quot;, &quot;text&quot;, &quot;image&quot;, etc.)</span>
<a href="#l3.3835"></a><span id="l3.3835" class="difflineminus">-  if (ContinueParse())</span>
<a href="#l3.3836"></a><span id="l3.3836" class="difflineminus">-  {</span>
<a href="#l3.3837"></a><span id="l3.3837" class="difflineminus">-    fNextToken++; // eat the first '('</span>
<a href="#l3.3838"></a><span id="l3.3838" class="difflineplus">+  if (ContinueParse()) {</span>
<a href="#l3.3839"></a><span id="l3.3839" class="difflineplus">+    fNextToken++;  // eat the first '('</span>
<a href="#l3.3840"></a><span id="l3.3840">     bodyType = CreateNilString();</span>
<a href="#l3.3841"></a><span id="l3.3841" class="difflineminus">-    if (ContinueParse())</span>
<a href="#l3.3842"></a><span id="l3.3842" class="difflineminus">-      AdvanceToNextToken();</span>
<a href="#l3.3843"></a><span id="l3.3843" class="difflineplus">+    if (ContinueParse()) AdvanceToNextToken();</span>
<a href="#l3.3844"></a><span id="l3.3844">   }</span>
<a href="#l3.3845"></a><span id="l3.3845"> </span>
<a href="#l3.3846"></a><span id="l3.3846">   // body subtype  (&quot;gif&quot;, &quot;html&quot;, etc.)</span>
<a href="#l3.3847"></a><span id="l3.3847" class="difflineminus">-  if (isValid &amp;&amp; ContinueParse())</span>
<a href="#l3.3848"></a><span id="l3.3848" class="difflineminus">-  {</span>
<a href="#l3.3849"></a><span id="l3.3849" class="difflineplus">+  if (isValid &amp;&amp; ContinueParse()) {</span>
<a href="#l3.3850"></a><span id="l3.3850">     bodySubType = CreateNilString();</span>
<a href="#l3.3851"></a><span id="l3.3851" class="difflineminus">-    if (ContinueParse())</span>
<a href="#l3.3852"></a><span id="l3.3852" class="difflineminus">-      AdvanceToNextToken();</span>
<a href="#l3.3853"></a><span id="l3.3853" class="difflineplus">+    if (ContinueParse()) AdvanceToNextToken();</span>
<a href="#l3.3854"></a><span id="l3.3854">   }</span>
<a href="#l3.3855"></a><span id="l3.3855"> </span>
<a href="#l3.3856"></a><span id="l3.3856">   // body parameter: parenthesized list</span>
<a href="#l3.3857"></a><span id="l3.3857" class="difflineminus">-  if (isValid &amp;&amp; ContinueParse())</span>
<a href="#l3.3858"></a><span id="l3.3858" class="difflineminus">-  {</span>
<a href="#l3.3859"></a><span id="l3.3859" class="difflineminus">-    if (fNextToken[0] == '(')</span>
<a href="#l3.3860"></a><span id="l3.3860" class="difflineminus">-    {</span>
<a href="#l3.3861"></a><span id="l3.3861" class="difflineplus">+  if (isValid &amp;&amp; ContinueParse()) {</span>
<a href="#l3.3862"></a><span id="l3.3862" class="difflineplus">+    if (fNextToken[0] == '(') {</span>
<a href="#l3.3863"></a><span id="l3.3863">       fNextToken++;</span>
<a href="#l3.3864"></a><span id="l3.3864">       skip_to_close_paren();</span>
<a href="#l3.3865"></a><span id="l3.3865" class="difflineminus">-    }</span>
<a href="#l3.3866"></a><span id="l3.3866" class="difflineminus">-    else if (!PL_strcasecmp(fNextToken, &quot;NIL&quot;))</span>
<a href="#l3.3867"></a><span id="l3.3867" class="difflineplus">+    } else if (!PL_strcasecmp(fNextToken, &quot;NIL&quot;))</span>
<a href="#l3.3868"></a><span id="l3.3868">       AdvanceToNextToken();</span>
<a href="#l3.3869"></a><span id="l3.3869">   }</span>
<a href="#l3.3870"></a><span id="l3.3870"> </span>
<a href="#l3.3871"></a><span id="l3.3871">   // body id</span>
<a href="#l3.3872"></a><span id="l3.3872" class="difflineminus">-  if (isValid &amp;&amp; ContinueParse())</span>
<a href="#l3.3873"></a><span id="l3.3873" class="difflineminus">-  {</span>
<a href="#l3.3874"></a><span id="l3.3874" class="difflineplus">+  if (isValid &amp;&amp; ContinueParse()) {</span>
<a href="#l3.3875"></a><span id="l3.3875">     bodyID = CreateNilString();</span>
<a href="#l3.3876"></a><span id="l3.3876" class="difflineminus">-    if (ContinueParse())</span>
<a href="#l3.3877"></a><span id="l3.3877" class="difflineminus">-      AdvanceToNextToken();</span>
<a href="#l3.3878"></a><span id="l3.3878" class="difflineplus">+    if (ContinueParse()) AdvanceToNextToken();</span>
<a href="#l3.3879"></a><span id="l3.3879">   }</span>
<a href="#l3.3880"></a><span id="l3.3880"> </span>
<a href="#l3.3881"></a><span id="l3.3881">   // body description</span>
<a href="#l3.3882"></a><span id="l3.3882" class="difflineminus">-  if (isValid &amp;&amp; ContinueParse())</span>
<a href="#l3.3883"></a><span id="l3.3883" class="difflineminus">-  {</span>
<a href="#l3.3884"></a><span id="l3.3884" class="difflineplus">+  if (isValid &amp;&amp; ContinueParse()) {</span>
<a href="#l3.3885"></a><span id="l3.3885">     bodyDescription = CreateNilString();</span>
<a href="#l3.3886"></a><span id="l3.3886" class="difflineminus">-    if (ContinueParse())</span>
<a href="#l3.3887"></a><span id="l3.3887" class="difflineminus">-      AdvanceToNextToken();</span>
<a href="#l3.3888"></a><span id="l3.3888" class="difflineplus">+    if (ContinueParse()) AdvanceToNextToken();</span>
<a href="#l3.3889"></a><span id="l3.3889">   }</span>
<a href="#l3.3890"></a><span id="l3.3890"> </span>
<a href="#l3.3891"></a><span id="l3.3891">   // body encoding</span>
<a href="#l3.3892"></a><span id="l3.3892" class="difflineminus">-  if (isValid &amp;&amp; ContinueParse())</span>
<a href="#l3.3893"></a><span id="l3.3893" class="difflineminus">-  {</span>
<a href="#l3.3894"></a><span id="l3.3894" class="difflineplus">+  if (isValid &amp;&amp; ContinueParse()) {</span>
<a href="#l3.3895"></a><span id="l3.3895">     bodyEncoding = CreateNilString();</span>
<a href="#l3.3896"></a><span id="l3.3896" class="difflineminus">-    if (ContinueParse())</span>
<a href="#l3.3897"></a><span id="l3.3897" class="difflineminus">-      AdvanceToNextToken();</span>
<a href="#l3.3898"></a><span id="l3.3898" class="difflineplus">+    if (ContinueParse()) AdvanceToNextToken();</span>
<a href="#l3.3899"></a><span id="l3.3899">   }</span>
<a href="#l3.3900"></a><span id="l3.3900"> </span>
<a href="#l3.3901"></a><span id="l3.3901">   // body size</span>
<a href="#l3.3902"></a><span id="l3.3902" class="difflineminus">-  if (isValid &amp;&amp; ContinueParse())</span>
<a href="#l3.3903"></a><span id="l3.3903" class="difflineminus">-  {</span>
<a href="#l3.3904"></a><span id="l3.3904" class="difflineplus">+  if (isValid &amp;&amp; ContinueParse()) {</span>
<a href="#l3.3905"></a><span id="l3.3905">     char *bodySizeString = CreateAtom();</span>
<a href="#l3.3906"></a><span id="l3.3906">     if (!bodySizeString)</span>
<a href="#l3.3907"></a><span id="l3.3907">       isValid = false;</span>
<a href="#l3.3908"></a><span id="l3.3908" class="difflineminus">-    else</span>
<a href="#l3.3909"></a><span id="l3.3909" class="difflineminus">-    {</span>
<a href="#l3.3910"></a><span id="l3.3910" class="difflineplus">+    else {</span>
<a href="#l3.3911"></a><span id="l3.3911">       partLength = atoi(bodySizeString);</span>
<a href="#l3.3912"></a><span id="l3.3912">       PR_Free(bodySizeString);</span>
<a href="#l3.3913"></a><span id="l3.3913" class="difflineminus">-      if (ContinueParse())</span>
<a href="#l3.3914"></a><span id="l3.3914" class="difflineminus">-        AdvanceToNextToken();</span>
<a href="#l3.3915"></a><span id="l3.3915" class="difflineplus">+      if (ContinueParse()) AdvanceToNextToken();</span>
<a href="#l3.3916"></a><span id="l3.3916">     }</span>
<a href="#l3.3917"></a><span id="l3.3917">   }</span>
<a href="#l3.3918"></a><span id="l3.3918"> </span>
<a href="#l3.3919"></a><span id="l3.3919" class="difflineminus">-  if (!isValid || !ContinueParse())</span>
<a href="#l3.3920"></a><span id="l3.3920" class="difflineminus">-  {</span>
<a href="#l3.3921"></a><span id="l3.3921" class="difflineplus">+  if (!isValid || !ContinueParse()) {</span>
<a href="#l3.3922"></a><span id="l3.3922">     PR_FREEIF(partNum);</span>
<a href="#l3.3923"></a><span id="l3.3923">     PR_FREEIF(bodyType);</span>
<a href="#l3.3924"></a><span id="l3.3924">     PR_FREEIF(bodySubType);</span>
<a href="#l3.3925"></a><span id="l3.3925">     PR_FREEIF(bodyID);</span>
<a href="#l3.3926"></a><span id="l3.3926">     PR_FREEIF(bodyDescription);</span>
<a href="#l3.3927"></a><span id="l3.3927">     PR_FREEIF(bodyEncoding);</span>
<a href="#l3.3928"></a><span id="l3.3928" class="difflineminus">-  }</span>
<a href="#l3.3929"></a><span id="l3.3929" class="difflineminus">-  else</span>
<a href="#l3.3930"></a><span id="l3.3930" class="difflineminus">-  {</span>
<a href="#l3.3931"></a><span id="l3.3931" class="difflineminus">-    if (PL_strcasecmp(bodyType, &quot;message&quot;) || PL_strcasecmp(bodySubType, &quot;rfc822&quot;))</span>
<a href="#l3.3932"></a><span id="l3.3932" class="difflineminus">-    {</span>
<a href="#l3.3933"></a><span id="l3.3933" class="difflineplus">+  } else {</span>
<a href="#l3.3934"></a><span id="l3.3934" class="difflineplus">+    if (PL_strcasecmp(bodyType, &quot;message&quot;) ||</span>
<a href="#l3.3935"></a><span id="l3.3935" class="difflineplus">+        PL_strcasecmp(bodySubType, &quot;rfc822&quot;)) {</span>
<a href="#l3.3936"></a><span id="l3.3936">       skip_to_close_paren();</span>
<a href="#l3.3937"></a><span id="l3.3937" class="difflineminus">-      return new nsIMAPBodypartLeaf(partNum, parentPart, bodyType, bodySubType,</span>
<a href="#l3.3938"></a><span id="l3.3938" class="difflineminus">-                                    bodyID, bodyDescription, bodyEncoding,</span>
<a href="#l3.3939"></a><span id="l3.3939" class="difflineminus">-                                    partLength,</span>
<a href="#l3.3940"></a><span id="l3.3940" class="difflineminus">-                                    fServerConnection.GetPreferPlainText());</span>
<a href="#l3.3941"></a><span id="l3.3941" class="difflineplus">+      return new nsIMAPBodypartLeaf(</span>
<a href="#l3.3942"></a><span id="l3.3942" class="difflineplus">+          partNum, parentPart, bodyType, bodySubType, bodyID, bodyDescription,</span>
<a href="#l3.3943"></a><span id="l3.3943" class="difflineplus">+          bodyEncoding, partLength, fServerConnection.GetPreferPlainText());</span>
<a href="#l3.3944"></a><span id="l3.3944">     }</span>
<a href="#l3.3945"></a><span id="l3.3945"> </span>
<a href="#l3.3946"></a><span id="l3.3946">     // This part is of type &quot;message/rfc822&quot;  (probably a forwarded message)</span>
<a href="#l3.3947"></a><span id="l3.3947" class="difflineminus">-    nsIMAPBodypartMessage *message =</span>
<a href="#l3.3948"></a><span id="l3.3948" class="difflineminus">-      new nsIMAPBodypartMessage(partNum, parentPart, false,</span>
<a href="#l3.3949"></a><span id="l3.3949" class="difflineminus">-                                bodyType, bodySubType, bodyID, bodyDescription,</span>
<a href="#l3.3950"></a><span id="l3.3950" class="difflineminus">-                                bodyEncoding, partLength,</span>
<a href="#l3.3951"></a><span id="l3.3951" class="difflineminus">-                                fServerConnection.GetPreferPlainText());</span>
<a href="#l3.3952"></a><span id="l3.3952" class="difflineplus">+    nsIMAPBodypartMessage *message = new nsIMAPBodypartMessage(</span>
<a href="#l3.3953"></a><span id="l3.3953" class="difflineplus">+        partNum, parentPart, false, bodyType, bodySubType, bodyID,</span>
<a href="#l3.3954"></a><span id="l3.3954" class="difflineplus">+        bodyDescription, bodyEncoding, partLength,</span>
<a href="#l3.3955"></a><span id="l3.3955" class="difflineplus">+        fServerConnection.GetPreferPlainText());</span>
<a href="#l3.3956"></a><span id="l3.3956"> </span>
<a href="#l3.3957"></a><span id="l3.3957" class="difflineminus">-    // there are three additional fields: envelope structure, bodystructure, and size in lines</span>
<a href="#l3.3958"></a><span id="l3.3958" class="difflineminus">-    // historical note: this code was originally in nsIMAPBodypartMessage::ParseIntoObjects()</span>
<a href="#l3.3959"></a><span id="l3.3959" class="difflineplus">+    // there are three additional fields: envelope structure, bodystructure, and</span>
<a href="#l3.3960"></a><span id="l3.3960" class="difflineplus">+    // size in lines historical note: this code was originally in</span>
<a href="#l3.3961"></a><span id="l3.3961" class="difflineplus">+    // nsIMAPBodypartMessage::ParseIntoObjects()</span>
<a href="#l3.3962"></a><span id="l3.3962"> </span>
<a href="#l3.3963"></a><span id="l3.3963">     // envelope (ignored)</span>
<a href="#l3.3964"></a><span id="l3.3964" class="difflineminus">-    if (*fNextToken == '(')</span>
<a href="#l3.3965"></a><span id="l3.3965" class="difflineminus">-    {</span>
<a href="#l3.3966"></a><span id="l3.3966" class="difflineplus">+    if (*fNextToken == '(') {</span>
<a href="#l3.3967"></a><span id="l3.3967">       fNextToken++;</span>
<a href="#l3.3968"></a><span id="l3.3968">       skip_to_close_paren();</span>
<a href="#l3.3969"></a><span id="l3.3969" class="difflineminus">-    }</span>
<a href="#l3.3970"></a><span id="l3.3970" class="difflineminus">-    else</span>
<a href="#l3.3971"></a><span id="l3.3971" class="difflineplus">+    } else</span>
<a href="#l3.3972"></a><span id="l3.3972">       isValid = false;</span>
<a href="#l3.3973"></a><span id="l3.3973"> </span>
<a href="#l3.3974"></a><span id="l3.3974">     // bodystructure</span>
<a href="#l3.3975"></a><span id="l3.3975" class="difflineminus">-    if (isValid &amp;&amp; ContinueParse())</span>
<a href="#l3.3976"></a><span id="l3.3976" class="difflineminus">-    {</span>
<a href="#l3.3977"></a><span id="l3.3977" class="difflineplus">+    if (isValid &amp;&amp; ContinueParse()) {</span>
<a href="#l3.3978"></a><span id="l3.3978">       if (*fNextToken != '(')</span>
<a href="#l3.3979"></a><span id="l3.3979">         isValid = false;</span>
<a href="#l3.3980"></a><span id="l3.3980" class="difflineminus">-      else</span>
<a href="#l3.3981"></a><span id="l3.3981" class="difflineminus">-      {</span>
<a href="#l3.3982"></a><span id="l3.3982" class="difflineplus">+      else {</span>
<a href="#l3.3983"></a><span id="l3.3983">         char *bodyPartNum = PR_smprintf(&quot;%s.1&quot;, partNum);</span>
<a href="#l3.3984"></a><span id="l3.3984" class="difflineminus">-        if (bodyPartNum)</span>
<a href="#l3.3985"></a><span id="l3.3985" class="difflineminus">-        {</span>
<a href="#l3.3986"></a><span id="l3.3986" class="difflineplus">+        if (bodyPartNum) {</span>
<a href="#l3.3987"></a><span id="l3.3987">           nsIMAPBodypart *body = bodystructure_part(bodyPartNum, message);</span>
<a href="#l3.3988"></a><span id="l3.3988">           if (body)</span>
<a href="#l3.3989"></a><span id="l3.3989">             message-&gt;SetBody(body);</span>
<a href="#l3.3990"></a><span id="l3.3990">           else</span>
<a href="#l3.3991"></a><span id="l3.3991">             isValid = false;</span>
<a href="#l3.3992"></a><span id="l3.3992">         }</span>
<a href="#l3.3993"></a><span id="l3.3993">       }</span>
<a href="#l3.3994"></a><span id="l3.3994">     }</span>
<a href="#l3.3995"></a><span id="l3.3995" class="difflineat">@@ -2927,551 +2494,480 @@ nsImapServerResponseParser::bodystructur</span>
<a href="#l3.3996"></a><span id="l3.3996">     if (isValid &amp;&amp; ContinueParse()) {</span>
<a href="#l3.3997"></a><span id="l3.3997">       skip_to_close_paren();</span>
<a href="#l3.3998"></a><span id="l3.3998">       return message;</span>
<a href="#l3.3999"></a><span id="l3.3999">     }</span>
<a href="#l3.4000"></a><span id="l3.4000">     delete message;</span>
<a href="#l3.4001"></a><span id="l3.4001">   }</span>
<a href="#l3.4002"></a><span id="l3.4002"> </span>
<a href="#l3.4003"></a><span id="l3.4003">   // parsing failed, just move to the end of the parentheses group</span>
<a href="#l3.4004"></a><span id="l3.4004" class="difflineminus">-  if (ContinueParse())</span>
<a href="#l3.4005"></a><span id="l3.4005" class="difflineminus">-    skip_to_close_paren();</span>
<a href="#l3.4006"></a><span id="l3.4006" class="difflineplus">+  if (ContinueParse()) skip_to_close_paren();</span>
<a href="#l3.4007"></a><span id="l3.4007">   return nullptr;</span>
<a href="#l3.4008"></a><span id="l3.4008"> }</span>
<a href="#l3.4009"></a><span id="l3.4009"> </span>
<a href="#l3.4010"></a><span id="l3.4010" class="difflineminus">-</span>
<a href="#l3.4011"></a><span id="l3.4011"> // RFC3501:  body-type-mpart = 1*body SP media-subtype</span>
<a href="#l3.4012"></a><span id="l3.4012"> //                             [SP body-ext-mpart]</span>
<a href="#l3.4013"></a><span id="l3.4013" class="difflineminus">-nsIMAPBodypart *</span>
<a href="#l3.4014"></a><span id="l3.4014" class="difflineminus">-nsImapServerResponseParser::bodystructure_multipart(char *partNum, nsIMAPBodypart *parentPart)</span>
<a href="#l3.4015"></a><span id="l3.4015" class="difflineminus">-{</span>
<a href="#l3.4016"></a><span id="l3.4016" class="difflineminus">-  nsIMAPBodypartMultipart *multipart = new nsIMAPBodypartMultipart(partNum, parentPart);</span>
<a href="#l3.4017"></a><span id="l3.4017" class="difflineplus">+nsIMAPBodypart *nsImapServerResponseParser::bodystructure_multipart(</span>
<a href="#l3.4018"></a><span id="l3.4018" class="difflineplus">+    char *partNum, nsIMAPBodypart *parentPart) {</span>
<a href="#l3.4019"></a><span id="l3.4019" class="difflineplus">+  nsIMAPBodypartMultipart *multipart =</span>
<a href="#l3.4020"></a><span id="l3.4020" class="difflineplus">+      new nsIMAPBodypartMultipart(partNum, parentPart);</span>
<a href="#l3.4021"></a><span id="l3.4021">   bool isValid = multipart-&gt;GetIsValid();</span>
<a href="#l3.4022"></a><span id="l3.4022" class="difflineminus">-  // historical note: this code was originally in nsIMAPBodypartMultipart::ParseIntoObjects()</span>
<a href="#l3.4023"></a><span id="l3.4023" class="difflineminus">-  if (ContinueParse())</span>
<a href="#l3.4024"></a><span id="l3.4024" class="difflineminus">-  {</span>
<a href="#l3.4025"></a><span id="l3.4025" class="difflineminus">-    fNextToken++; // eat the first '('</span>
<a href="#l3.4026"></a><span id="l3.4026" class="difflineplus">+  // historical note: this code was originally in</span>
<a href="#l3.4027"></a><span id="l3.4027" class="difflineplus">+  // nsIMAPBodypartMultipart::ParseIntoObjects()</span>
<a href="#l3.4028"></a><span id="l3.4028" class="difflineplus">+  if (ContinueParse()) {</span>
<a href="#l3.4029"></a><span id="l3.4029" class="difflineplus">+    fNextToken++;  // eat the first '('</span>
<a href="#l3.4030"></a><span id="l3.4030">     // Parse list of children</span>
<a href="#l3.4031"></a><span id="l3.4031">     int childCount = 0;</span>
<a href="#l3.4032"></a><span id="l3.4032" class="difflineminus">-    while (isValid &amp;&amp; fNextToken[0] == '(' &amp;&amp; ContinueParse())</span>
<a href="#l3.4033"></a><span id="l3.4033" class="difflineminus">-    {</span>
<a href="#l3.4034"></a><span id="l3.4034" class="difflineplus">+    while (isValid &amp;&amp; fNextToken[0] == '(' &amp;&amp; ContinueParse()) {</span>
<a href="#l3.4035"></a><span id="l3.4035">       childCount++;</span>
<a href="#l3.4036"></a><span id="l3.4036">       char *childPartNum = NULL;</span>
<a href="#l3.4037"></a><span id="l3.4037">       // note: the multipart constructor does some magic on partNumber</span>
<a href="#l3.4038"></a><span id="l3.4038" class="difflineminus">-      if (PL_strcmp(multipart-&gt;GetPartNumberString(), &quot;0&quot;)) // not top-level</span>
<a href="#l3.4039"></a><span id="l3.4039" class="difflineminus">-        childPartNum = PR_smprintf(&quot;%s.%d&quot;, multipart-&gt;GetPartNumberString(), childCount);</span>
<a href="#l3.4040"></a><span id="l3.4040" class="difflineminus">-      else // top-level</span>
<a href="#l3.4041"></a><span id="l3.4041" class="difflineplus">+      if (PL_strcmp(multipart-&gt;GetPartNumberString(), &quot;0&quot;))  // not top-level</span>
<a href="#l3.4042"></a><span id="l3.4042" class="difflineplus">+        childPartNum =</span>
<a href="#l3.4043"></a><span id="l3.4043" class="difflineplus">+            PR_smprintf(&quot;%s.%d&quot;, multipart-&gt;GetPartNumberString(), childCount);</span>
<a href="#l3.4044"></a><span id="l3.4044" class="difflineplus">+      else  // top-level</span>
<a href="#l3.4045"></a><span id="l3.4045">         childPartNum = PR_smprintf(&quot;%d&quot;, childCount);</span>
<a href="#l3.4046"></a><span id="l3.4046">       if (!childPartNum)</span>
<a href="#l3.4047"></a><span id="l3.4047">         isValid = false;</span>
<a href="#l3.4048"></a><span id="l3.4048" class="difflineminus">-      else</span>
<a href="#l3.4049"></a><span id="l3.4049" class="difflineminus">-      {</span>
<a href="#l3.4050"></a><span id="l3.4050" class="difflineplus">+      else {</span>
<a href="#l3.4051"></a><span id="l3.4051">         nsIMAPBodypart *child = bodystructure_part(childPartNum, multipart);</span>
<a href="#l3.4052"></a><span id="l3.4052">         if (child)</span>
<a href="#l3.4053"></a><span id="l3.4053">           multipart-&gt;AppendPart(child);</span>
<a href="#l3.4054"></a><span id="l3.4054">         else</span>
<a href="#l3.4055"></a><span id="l3.4055">           isValid = false;</span>
<a href="#l3.4056"></a><span id="l3.4056">       }</span>
<a href="#l3.4057"></a><span id="l3.4057">     }</span>
<a href="#l3.4058"></a><span id="l3.4058"> </span>
<a href="#l3.4059"></a><span id="l3.4059">     // RFC3501:  media-subtype   = string</span>
<a href="#l3.4060"></a><span id="l3.4060">     // (multipart subtype: mixed, alternative, etc.)</span>
<a href="#l3.4061"></a><span id="l3.4061" class="difflineminus">-    if (isValid &amp;&amp; ContinueParse())</span>
<a href="#l3.4062"></a><span id="l3.4062" class="difflineminus">-    {</span>
<a href="#l3.4063"></a><span id="l3.4063" class="difflineplus">+    if (isValid &amp;&amp; ContinueParse()) {</span>
<a href="#l3.4064"></a><span id="l3.4064">       char *bodySubType = CreateNilString();</span>
<a href="#l3.4065"></a><span id="l3.4065">       multipart-&gt;SetBodySubType(bodySubType);</span>
<a href="#l3.4066"></a><span id="l3.4066" class="difflineminus">-      if (ContinueParse())</span>
<a href="#l3.4067"></a><span id="l3.4067" class="difflineminus">-        AdvanceToNextToken();</span>
<a href="#l3.4068"></a><span id="l3.4068" class="difflineplus">+      if (ContinueParse()) AdvanceToNextToken();</span>
<a href="#l3.4069"></a><span id="l3.4069">     }</span>
<a href="#l3.4070"></a><span id="l3.4070"> </span>
<a href="#l3.4071"></a><span id="l3.4071" class="difflineplus">+    // clang-format off</span>
<a href="#l3.4072"></a><span id="l3.4072">     // extension data:</span>
<a href="#l3.4073"></a><span id="l3.4073">     // RFC3501:  body-ext-mpart = body-fld-param [SP body-fld-dsp [SP body-fld-lang</span>
<a href="#l3.4074"></a><span id="l3.4074">     //                            [SP body-fld-loc *(SP body-extension)]]]</span>
<a href="#l3.4075"></a><span id="l3.4075"> </span>
<a href="#l3.4076"></a><span id="l3.4076">     // body parameter parenthesized list (optional data), includes boundary parameter</span>
<a href="#l3.4077"></a><span id="l3.4077">     // RFC3501:  body-fld-param  = &quot;(&quot; string SP string *(SP string SP string) &quot;)&quot; / nil</span>
<a href="#l3.4078"></a><span id="l3.4078" class="difflineplus">+    // clang-format on</span>
<a href="#l3.4079"></a><span id="l3.4079">     char *boundaryData = nullptr;</span>
<a href="#l3.4080"></a><span id="l3.4080" class="difflineminus">-    if (isValid &amp;&amp; ContinueParse() &amp;&amp; *fNextToken == '(')</span>
<a href="#l3.4081"></a><span id="l3.4081" class="difflineminus">-    {</span>
<a href="#l3.4082"></a><span id="l3.4082" class="difflineplus">+    if (isValid &amp;&amp; ContinueParse() &amp;&amp; *fNextToken == '(') {</span>
<a href="#l3.4083"></a><span id="l3.4083">       fNextToken++;</span>
<a href="#l3.4084"></a><span id="l3.4084" class="difflineminus">-      while (ContinueParse() &amp;&amp; *fNextToken != ')')</span>
<a href="#l3.4085"></a><span id="l3.4085" class="difflineminus">-      {</span>
<a href="#l3.4086"></a><span id="l3.4086" class="difflineplus">+      while (ContinueParse() &amp;&amp; *fNextToken != ')') {</span>
<a href="#l3.4087"></a><span id="l3.4087">         char *attribute = CreateNilString();</span>
<a href="#l3.4088"></a><span id="l3.4088" class="difflineminus">-        if (ContinueParse())</span>
<a href="#l3.4089"></a><span id="l3.4089" class="difflineminus">-          AdvanceToNextToken();</span>
<a href="#l3.4090"></a><span id="l3.4090" class="difflineminus">-        if (ContinueParse() &amp;&amp; !PL_strcasecmp(attribute, &quot;BOUNDARY&quot;))</span>
<a href="#l3.4091"></a><span id="l3.4091" class="difflineminus">-        {</span>
<a href="#l3.4092"></a><span id="l3.4092" class="difflineplus">+        if (ContinueParse()) AdvanceToNextToken();</span>
<a href="#l3.4093"></a><span id="l3.4093" class="difflineplus">+        if (ContinueParse() &amp;&amp; !PL_strcasecmp(attribute, &quot;BOUNDARY&quot;)) {</span>
<a href="#l3.4094"></a><span id="l3.4094">           char *boundary = CreateNilString();</span>
<a href="#l3.4095"></a><span id="l3.4095" class="difflineminus">-          if (boundary)</span>
<a href="#l3.4096"></a><span id="l3.4096" class="difflineminus">-            boundaryData = PR_smprintf(&quot;--%s&quot;, boundary);</span>
<a href="#l3.4097"></a><span id="l3.4097" class="difflineplus">+          if (boundary) boundaryData = PR_smprintf(&quot;--%s&quot;, boundary);</span>
<a href="#l3.4098"></a><span id="l3.4098">           PR_FREEIF(boundary);</span>
<a href="#l3.4099"></a><span id="l3.4099" class="difflineminus">-        }</span>
<a href="#l3.4100"></a><span id="l3.4100" class="difflineminus">-        else if (ContinueParse())</span>
<a href="#l3.4101"></a><span id="l3.4101" class="difflineminus">-        {</span>
<a href="#l3.4102"></a><span id="l3.4102" class="difflineplus">+        } else if (ContinueParse()) {</span>
<a href="#l3.4103"></a><span id="l3.4103">           char *value = CreateNilString();</span>
<a href="#l3.4104"></a><span id="l3.4104">           PR_FREEIF(value);</span>
<a href="#l3.4105"></a><span id="l3.4105">         }</span>
<a href="#l3.4106"></a><span id="l3.4106">         PR_FREEIF(attribute);</span>
<a href="#l3.4107"></a><span id="l3.4107" class="difflineminus">-        if (ContinueParse())</span>
<a href="#l3.4108"></a><span id="l3.4108" class="difflineminus">-          AdvanceToNextToken();</span>
<a href="#l3.4109"></a><span id="l3.4109" class="difflineplus">+        if (ContinueParse()) AdvanceToNextToken();</span>
<a href="#l3.4110"></a><span id="l3.4110">       }</span>
<a href="#l3.4111"></a><span id="l3.4111" class="difflineminus">-      if (ContinueParse())</span>
<a href="#l3.4112"></a><span id="l3.4112" class="difflineminus">-        fNextToken++;  // skip closing ')'</span>
<a href="#l3.4113"></a><span id="l3.4113" class="difflineplus">+      if (ContinueParse()) fNextToken++;  // skip closing ')'</span>
<a href="#l3.4114"></a><span id="l3.4114">     }</span>
<a href="#l3.4115"></a><span id="l3.4115">     if (boundaryData)</span>
<a href="#l3.4116"></a><span id="l3.4116">       multipart-&gt;SetBoundaryData(boundaryData);</span>
<a href="#l3.4117"></a><span id="l3.4117">     else</span>
<a href="#l3.4118"></a><span id="l3.4118" class="difflineminus">-      isValid = false;   // Actually, we should probably generate a boundary here.</span>
<a href="#l3.4119"></a><span id="l3.4119" class="difflineplus">+      isValid =</span>
<a href="#l3.4120"></a><span id="l3.4120" class="difflineplus">+          false;  // Actually, we should probably generate a boundary here.</span>
<a href="#l3.4121"></a><span id="l3.4121">   }</span>
<a href="#l3.4122"></a><span id="l3.4122"> </span>
<a href="#l3.4123"></a><span id="l3.4123">   // always move to closing ')', even if part was not successfully read</span>
<a href="#l3.4124"></a><span id="l3.4124" class="difflineminus">-  if (ContinueParse())</span>
<a href="#l3.4125"></a><span id="l3.4125" class="difflineminus">-    skip_to_close_paren();</span>
<a href="#l3.4126"></a><span id="l3.4126" class="difflineplus">+  if (ContinueParse()) skip_to_close_paren();</span>
<a href="#l3.4127"></a><span id="l3.4127"> </span>
<a href="#l3.4128"></a><span id="l3.4128" class="difflineminus">-  if (isValid)</span>
<a href="#l3.4129"></a><span id="l3.4129" class="difflineminus">-    return multipart;</span>
<a href="#l3.4130"></a><span id="l3.4130" class="difflineplus">+  if (isValid) return multipart;</span>
<a href="#l3.4131"></a><span id="l3.4131">   delete multipart;</span>
<a href="#l3.4132"></a><span id="l3.4132">   return nullptr;</span>
<a href="#l3.4133"></a><span id="l3.4133"> }</span>
<a href="#l3.4134"></a><span id="l3.4134"> </span>
<a href="#l3.4135"></a><span id="l3.4135" class="difflineminus">-</span>
<a href="#l3.4136"></a><span id="l3.4136"> // RFC2087:  quotaroot_response = &quot;QUOTAROOT&quot; SP astring *(SP astring)</span>
<a href="#l3.4137"></a><span id="l3.4137"> //           quota_response = &quot;QUOTA&quot; SP astring SP quota_list</span>
<a href="#l3.4138"></a><span id="l3.4138"> //           quota_list     = &quot;(&quot; [quota_resource *(SP quota_resource)] &quot;)&quot;</span>
<a href="#l3.4139"></a><span id="l3.4139"> //           quota_resource = atom SP number SP number</span>
<a href="#l3.4140"></a><span id="l3.4140"> // Only the STORAGE resource is considered.  The current implementation is</span>
<a href="#l3.4141"></a><span id="l3.4141"> // slightly broken because it assumes that STORAGE is the first resource;</span>
<a href="#l3.4142"></a><span id="l3.4142"> // a response   QUOTA (MESSAGE 5 100 STORAGE 10 512)   would be ignored.</span>
<a href="#l3.4143"></a><span id="l3.4143" class="difflineminus">-void nsImapServerResponseParser::quota_data()</span>
<a href="#l3.4144"></a><span id="l3.4144" class="difflineminus">-{</span>
<a href="#l3.4145"></a><span id="l3.4145" class="difflineminus">-  if (!PL_strcasecmp(fNextToken, &quot;QUOTAROOT&quot;))</span>
<a href="#l3.4146"></a><span id="l3.4146" class="difflineminus">-  {</span>
<a href="#l3.4147"></a><span id="l3.4147" class="difflineplus">+void nsImapServerResponseParser::quota_data() {</span>
<a href="#l3.4148"></a><span id="l3.4148" class="difflineplus">+  if (!PL_strcasecmp(fNextToken, &quot;QUOTAROOT&quot;)) {</span>
<a href="#l3.4149"></a><span id="l3.4149">     // ignore QUOTAROOT response</span>
<a href="#l3.4150"></a><span id="l3.4150">     nsCString quotaroot;</span>
<a href="#l3.4151"></a><span id="l3.4151">     AdvanceToNextToken();</span>
<a href="#l3.4152"></a><span id="l3.4152" class="difflineminus">-    while (ContinueParse() &amp;&amp; !fAtEndOfLine)</span>
<a href="#l3.4153"></a><span id="l3.4153" class="difflineminus">-    {</span>
<a href="#l3.4154"></a><span id="l3.4154" class="difflineplus">+    while (ContinueParse() &amp;&amp; !fAtEndOfLine) {</span>
<a href="#l3.4155"></a><span id="l3.4155">       quotaroot.Adopt(CreateAstring());</span>
<a href="#l3.4156"></a><span id="l3.4156">       AdvanceToNextToken();</span>
<a href="#l3.4157"></a><span id="l3.4157">     }</span>
<a href="#l3.4158"></a><span id="l3.4158" class="difflineminus">-  }</span>
<a href="#l3.4159"></a><span id="l3.4159" class="difflineminus">-  else if(!PL_strcasecmp(fNextToken, &quot;QUOTA&quot;))</span>
<a href="#l3.4160"></a><span id="l3.4160" class="difflineminus">-  {</span>
<a href="#l3.4161"></a><span id="l3.4161" class="difflineplus">+  } else if (!PL_strcasecmp(fNextToken, &quot;QUOTA&quot;)) {</span>
<a href="#l3.4162"></a><span id="l3.4162">     uint32_t used, max;</span>
<a href="#l3.4163"></a><span id="l3.4163">     char *parengroup;</span>
<a href="#l3.4164"></a><span id="l3.4164"> </span>
<a href="#l3.4165"></a><span id="l3.4165">     AdvanceToNextToken();</span>
<a href="#l3.4166"></a><span id="l3.4166" class="difflineminus">-    if (ContinueParse())</span>
<a href="#l3.4167"></a><span id="l3.4167" class="difflineminus">-    {</span>
<a href="#l3.4168"></a><span id="l3.4168" class="difflineplus">+    if (ContinueParse()) {</span>
<a href="#l3.4169"></a><span id="l3.4169">       nsCString quotaroot;</span>
<a href="#l3.4170"></a><span id="l3.4170">       quotaroot.Adopt(CreateAstring());</span>
<a href="#l3.4171"></a><span id="l3.4171"> </span>
<a href="#l3.4172"></a><span id="l3.4172" class="difflineminus">-      if(ContinueParse() &amp;&amp; !fAtEndOfLine)</span>
<a href="#l3.4173"></a><span id="l3.4173" class="difflineminus">-      {</span>
<a href="#l3.4174"></a><span id="l3.4174" class="difflineplus">+      if (ContinueParse() &amp;&amp; !fAtEndOfLine) {</span>
<a href="#l3.4175"></a><span id="l3.4175">         AdvanceToNextToken();</span>
<a href="#l3.4176"></a><span id="l3.4176" class="difflineminus">-        if(fNextToken)</span>
<a href="#l3.4177"></a><span id="l3.4177" class="difflineminus">-        {</span>
<a href="#l3.4178"></a><span id="l3.4178" class="difflineminus">-          if(!PL_strcasecmp(fNextToken, &quot;(STORAGE&quot;))</span>
<a href="#l3.4179"></a><span id="l3.4179" class="difflineminus">-          {</span>
<a href="#l3.4180"></a><span id="l3.4180" class="difflineplus">+        if (fNextToken) {</span>
<a href="#l3.4181"></a><span id="l3.4181" class="difflineplus">+          if (!PL_strcasecmp(fNextToken, &quot;(STORAGE&quot;)) {</span>
<a href="#l3.4182"></a><span id="l3.4182">             parengroup = CreateParenGroup();</span>
<a href="#l3.4183"></a><span id="l3.4183" class="difflineminus">-            if(parengroup &amp;&amp; (PR_sscanf(parengroup, &quot;(STORAGE %lu %lu)&quot;, &amp;used, &amp;max) == 2) )</span>
<a href="#l3.4184"></a><span id="l3.4184" class="difflineminus">-            {</span>
<a href="#l3.4185"></a><span id="l3.4185" class="difflineplus">+            if (parengroup &amp;&amp; (PR_sscanf(parengroup, &quot;(STORAGE %lu %lu)&quot;, &amp;used,</span>
<a href="#l3.4186"></a><span id="l3.4186" class="difflineplus">+                                         &amp;max) == 2)) {</span>
<a href="#l3.4187"></a><span id="l3.4187">               fServerConnection.UpdateFolderQuotaData(quotaroot, used, max);</span>
<a href="#l3.4188"></a><span id="l3.4188">               skip_to_CRLF();</span>
<a href="#l3.4189"></a><span id="l3.4189" class="difflineminus">-            }</span>
<a href="#l3.4190"></a><span id="l3.4190" class="difflineminus">-            else</span>
<a href="#l3.4191"></a><span id="l3.4191" class="difflineplus">+            } else</span>
<a href="#l3.4192"></a><span id="l3.4192">               SetSyntaxError(true);</span>
<a href="#l3.4193"></a><span id="l3.4193"> </span>
<a href="#l3.4194"></a><span id="l3.4194">             PR_Free(parengroup);</span>
<a href="#l3.4195"></a><span id="l3.4195" class="difflineminus">-          }</span>
<a href="#l3.4196"></a><span id="l3.4196" class="difflineminus">-          else</span>
<a href="#l3.4197"></a><span id="l3.4197" class="difflineplus">+          } else</span>
<a href="#l3.4198"></a><span id="l3.4198">             // Ignore other limits, we just check STORAGE for now</span>
<a href="#l3.4199"></a><span id="l3.4199">             skip_to_CRLF();</span>
<a href="#l3.4200"></a><span id="l3.4200" class="difflineminus">-        }</span>
<a href="#l3.4201"></a><span id="l3.4201" class="difflineminus">-        else</span>
<a href="#l3.4202"></a><span id="l3.4202" class="difflineplus">+        } else</span>
<a href="#l3.4203"></a><span id="l3.4203">           SetSyntaxError(true);</span>
<a href="#l3.4204"></a><span id="l3.4204" class="difflineminus">-      }</span>
<a href="#l3.4205"></a><span id="l3.4205" class="difflineminus">-      else</span>
<a href="#l3.4206"></a><span id="l3.4206" class="difflineplus">+      } else</span>
<a href="#l3.4207"></a><span id="l3.4207">         HandleMemoryFailure();</span>
<a href="#l3.4208"></a><span id="l3.4208">     }</span>
<a href="#l3.4209"></a><span id="l3.4209" class="difflineminus">-  }</span>
<a href="#l3.4210"></a><span id="l3.4210" class="difflineminus">-  else</span>
<a href="#l3.4211"></a><span id="l3.4211" class="difflineplus">+  } else</span>
<a href="#l3.4212"></a><span id="l3.4212">     SetSyntaxError(true);</span>
<a href="#l3.4213"></a><span id="l3.4213"> }</span>
<a href="#l3.4214"></a><span id="l3.4214"> </span>
<a href="#l3.4215"></a><span id="l3.4215" class="difflineminus">-void nsImapServerResponseParser::id_data()</span>
<a href="#l3.4216"></a><span id="l3.4216" class="difflineminus">-{</span>
<a href="#l3.4217"></a><span id="l3.4217" class="difflineplus">+void nsImapServerResponseParser::id_data() {</span>
<a href="#l3.4218"></a><span id="l3.4218">   AdvanceToNextToken();</span>
<a href="#l3.4219"></a><span id="l3.4219">   if (!PL_strcasecmp(fNextToken, &quot;NIL&quot;))</span>
<a href="#l3.4220"></a><span id="l3.4220">     AdvanceToNextToken();</span>
<a href="#l3.4221"></a><span id="l3.4221">   else</span>
<a href="#l3.4222"></a><span id="l3.4222">     fServerIdResponse.Adopt(CreateParenGroup());</span>
<a href="#l3.4223"></a><span id="l3.4223">   skip_to_CRLF();</span>
<a href="#l3.4224"></a><span id="l3.4224"> }</span>
<a href="#l3.4225"></a><span id="l3.4225"> </span>
<a href="#l3.4226"></a><span id="l3.4226" class="difflineminus">-bool nsImapServerResponseParser::GetFillingInShell()</span>
<a href="#l3.4227"></a><span id="l3.4227" class="difflineminus">-{</span>
<a href="#l3.4228"></a><span id="l3.4228" class="difflineplus">+bool nsImapServerResponseParser::GetFillingInShell() {</span>
<a href="#l3.4229"></a><span id="l3.4229">   return (m_shell != nullptr);</span>
<a href="#l3.4230"></a><span id="l3.4230"> }</span>
<a href="#l3.4231"></a><span id="l3.4231"> </span>
<a href="#l3.4232"></a><span id="l3.4232" class="difflineminus">-bool nsImapServerResponseParser::GetDownloadingHeaders()</span>
<a href="#l3.4233"></a><span id="l3.4233" class="difflineminus">-{</span>
<a href="#l3.4234"></a><span id="l3.4234" class="difflineplus">+bool nsImapServerResponseParser::GetDownloadingHeaders() {</span>
<a href="#l3.4235"></a><span id="l3.4235">   return fDownloadingHeaders;</span>
<a href="#l3.4236"></a><span id="l3.4236"> }</span>
<a href="#l3.4237"></a><span id="l3.4237"> </span>
<a href="#l3.4238"></a><span id="l3.4238"> // Tells the server state parser to use a previously cached shell.</span>
<a href="#l3.4239"></a><span id="l3.4239" class="difflineminus">-void nsImapServerResponseParser::UseCachedShell(nsIMAPBodyShell *cachedShell)</span>
<a href="#l3.4240"></a><span id="l3.4240" class="difflineminus">-{</span>
<a href="#l3.4241"></a><span id="l3.4241" class="difflineplus">+void nsImapServerResponseParser::UseCachedShell(nsIMAPBodyShell *cachedShell) {</span>
<a href="#l3.4242"></a><span id="l3.4242">   // We shouldn't already have another shell we're dealing with.</span>
<a href="#l3.4243"></a><span id="l3.4243" class="difflineminus">-  if (m_shell &amp;&amp; cachedShell)</span>
<a href="#l3.4244"></a><span id="l3.4244" class="difflineminus">-  {</span>
<a href="#l3.4245"></a><span id="l3.4245" class="difflineplus">+  if (m_shell &amp;&amp; cachedShell) {</span>
<a href="#l3.4246"></a><span id="l3.4246">     MOZ_LOG(IMAP, mozilla::LogLevel::Info, (&quot;PARSER: Shell Collision&quot;));</span>
<a href="#l3.4247"></a><span id="l3.4247">     NS_ASSERTION(false, &quot;shell collision&quot;);</span>
<a href="#l3.4248"></a><span id="l3.4248">   }</span>
<a href="#l3.4249"></a><span id="l3.4249">   m_shell = cachedShell;</span>
<a href="#l3.4250"></a><span id="l3.4250"> }</span>
<a href="#l3.4251"></a><span id="l3.4251"> </span>
<a href="#l3.4252"></a><span id="l3.4252" class="difflineminus">-</span>
<a href="#l3.4253"></a><span id="l3.4253" class="difflineminus">-void nsImapServerResponseParser::ResetCapabilityFlag()</span>
<a href="#l3.4254"></a><span id="l3.4254" class="difflineminus">-{</span>
<a href="#l3.4255"></a><span id="l3.4255" class="difflineminus">-}</span>
<a href="#l3.4256"></a><span id="l3.4256" class="difflineplus">+void nsImapServerResponseParser::ResetCapabilityFlag() {}</span>
<a href="#l3.4257"></a><span id="l3.4257"> </span>
<a href="#l3.4258"></a><span id="l3.4258"> /*</span>
<a href="#l3.4259"></a><span id="l3.4259">  literal         ::= &quot;{&quot; number &quot;}&quot; CRLF *CHAR8</span>
<a href="#l3.4260"></a><span id="l3.4260">                               ;; Number represents the number of CHAR8 octets</span>
<a href="#l3.4261"></a><span id="l3.4261"> */</span>
<a href="#l3.4262"></a><span id="l3.4262"> // returns true if this is the last chunk and we should close the stream</span>
<a href="#l3.4263"></a><span id="l3.4263" class="difflineminus">-bool nsImapServerResponseParser::msg_fetch_literal(bool chunk, int32_t origin)</span>
<a href="#l3.4264"></a><span id="l3.4264" class="difflineminus">-{</span>
<a href="#l3.4265"></a><span id="l3.4265" class="difflineplus">+bool nsImapServerResponseParser::msg_fetch_literal(bool chunk, int32_t origin) {</span>
<a href="#l3.4266"></a><span id="l3.4266">   numberOfCharsInThisChunk = atoi(fNextToken + 1);</span>
<a href="#l3.4267"></a><span id="l3.4267">   // If we didn't request a specific size, or the server isn't returning exactly</span>
<a href="#l3.4268"></a><span id="l3.4268">   // as many octets as we requested, this must be the last or only chunk</span>
<a href="#l3.4269"></a><span id="l3.4269" class="difflineminus">-  bool lastChunk = (!chunk ||</span>
<a href="#l3.4270"></a><span id="l3.4270" class="difflineminus">-                    (numberOfCharsInThisChunk != fServerConnection.GetCurFetchSize()));</span>
<a href="#l3.4271"></a><span id="l3.4271" class="difflineplus">+  bool lastChunk = (!chunk || (numberOfCharsInThisChunk !=</span>
<a href="#l3.4272"></a><span id="l3.4272" class="difflineplus">+                               fServerConnection.GetCurFetchSize()));</span>
<a href="#l3.4273"></a><span id="l3.4273"> </span>
<a href="#l3.4274"></a><span id="l3.4274"> #ifdef DEBUG</span>
<a href="#l3.4275"></a><span id="l3.4275">   if (lastChunk)</span>
<a href="#l3.4276"></a><span id="l3.4276" class="difflineplus">+    // clang-format off</span>
<a href="#l3.4277"></a><span id="l3.4277">     MOZ_LOG(IMAP, mozilla::LogLevel::Debug,</span>
<a href="#l3.4278"></a><span id="l3.4278" class="difflineminus">-                  (&quot;PARSER: fetch_literal chunk = %d, requested %d, receiving %d&quot;,</span>
<a href="#l3.4279"></a><span id="l3.4279" class="difflineminus">-                    chunk, fServerConnection.GetCurFetchSize(),</span>
<a href="#l3.4280"></a><span id="l3.4280" class="difflineminus">-                    numberOfCharsInThisChunk));</span>
<a href="#l3.4281"></a><span id="l3.4281" class="difflineplus">+            (&quot;PARSER: fetch_literal chunk = %d, requested %d, receiving %d&quot;, chunk,</span>
<a href="#l3.4282"></a><span id="l3.4282" class="difflineplus">+             fServerConnection.GetCurFetchSize(), numberOfCharsInThisChunk));</span>
<a href="#l3.4283"></a><span id="l3.4283" class="difflineplus">+    // clang-format on</span>
<a href="#l3.4284"></a><span id="l3.4284"> #endif</span>
<a href="#l3.4285"></a><span id="l3.4285"> </span>
<a href="#l3.4286"></a><span id="l3.4286">   charsReadSoFar = 0;</span>
<a href="#l3.4287"></a><span id="l3.4287"> </span>
<a href="#l3.4288"></a><span id="l3.4288" class="difflineminus">-  while (ContinueParse() &amp;&amp; !fServerConnection.DeathSignalReceived() &amp;&amp; (charsReadSoFar &lt; numberOfCharsInThisChunk))</span>
<a href="#l3.4289"></a><span id="l3.4289" class="difflineminus">-  {</span>
<a href="#l3.4290"></a><span id="l3.4290" class="difflineplus">+  while (ContinueParse() &amp;&amp; !fServerConnection.DeathSignalReceived() &amp;&amp;</span>
<a href="#l3.4291"></a><span id="l3.4291" class="difflineplus">+         (charsReadSoFar &lt; numberOfCharsInThisChunk)) {</span>
<a href="#l3.4292"></a><span id="l3.4292">     AdvanceToNextLine();</span>
<a href="#l3.4293"></a><span id="l3.4293" class="difflineminus">-    if (ContinueParse())</span>
<a href="#l3.4294"></a><span id="l3.4294" class="difflineminus">-    {</span>
<a href="#l3.4295"></a><span id="l3.4295" class="difflineminus">-      // When &quot;\r\n&quot; (CRLF) is split across two chunks, the '\n' at the beginning of</span>
<a href="#l3.4296"></a><span id="l3.4296" class="difflineminus">-      // the next chunk might be set to an empty line consisting only of &quot;\r\n&quot;.</span>
<a href="#l3.4297"></a><span id="l3.4297" class="difflineminus">-      // This is observed while running unit tests with the imap &quot;fake&quot; server.</span>
<a href="#l3.4298"></a><span id="l3.4298" class="difflineminus">-      // The unexpected '\r' is discarded here. However, with several real world</span>
<a href="#l3.4299"></a><span id="l3.4299" class="difflineminus">-      // servers tested, e.g., Dovecot, Gmail, Outlook, Yahoo etc., the leading</span>
<a href="#l3.4300"></a><span id="l3.4300" class="difflineplus">+    if (ContinueParse()) {</span>
<a href="#l3.4301"></a><span id="l3.4301" class="difflineplus">+      // When &quot;\r\n&quot; (CRLF) is split across two chunks, the '\n' at the</span>
<a href="#l3.4302"></a><span id="l3.4302" class="difflineplus">+      // beginning of the next chunk might be set to an empty line consisting</span>
<a href="#l3.4303"></a><span id="l3.4303" class="difflineplus">+      // only of &quot;\r\n&quot;. This is observed while running unit tests with the imap</span>
<a href="#l3.4304"></a><span id="l3.4304" class="difflineplus">+      // &quot;fake&quot; server. The unexpected '\r' is discarded here. However, with</span>
<a href="#l3.4305"></a><span id="l3.4305" class="difflineplus">+      // several real world servers tested, e.g., Dovecot, Gmail, Outlook, Yahoo</span>
<a href="#l3.4306"></a><span id="l3.4306" class="difflineplus">+      // etc., the leading</span>
<a href="#l3.4307"></a><span id="l3.4307">       // '\r' is not inserted so the beginning line of the next chunk remains</span>
<a href="#l3.4308"></a><span id="l3.4308">       // just '\n' and no discard is required.</span>
<a href="#l3.4309"></a><span id="l3.4309">       // In any case, this &quot;orphan&quot; line is ignored and not processed below.</span>
<a href="#l3.4310"></a><span id="l3.4310" class="difflineminus">-      if (fNextChunkStartsWithNewline &amp;&amp; (*fCurrentLine == '\r'))</span>
<a href="#l3.4311"></a><span id="l3.4311" class="difflineminus">-      {</span>
<a href="#l3.4312"></a><span id="l3.4312" class="difflineplus">+      if (fNextChunkStartsWithNewline &amp;&amp; (*fCurrentLine == '\r')) {</span>
<a href="#l3.4313"></a><span id="l3.4313">         // Cause fCurrentLine to point to '\n' which discards the '\r'.</span>
<a href="#l3.4314"></a><span id="l3.4314">         char *usableCurrentLine = PL_strdup(fCurrentLine + 1);</span>
<a href="#l3.4315"></a><span id="l3.4315">         PR_Free(fCurrentLine);</span>
<a href="#l3.4316"></a><span id="l3.4316">         fCurrentLine = usableCurrentLine;</span>
<a href="#l3.4317"></a><span id="l3.4317">       }</span>
<a href="#l3.4318"></a><span id="l3.4318"> </span>
<a href="#l3.4319"></a><span id="l3.4319" class="difflineminus">-      // strlen() *would* fail on data containing \0, but the above AdvanceToNextLine() in</span>
<a href="#l3.4320"></a><span id="l3.4320" class="difflineminus">-      // nsMsgLineStreamBuffer::ReadNextLine() we replace '\0' with ' ' (blank) because</span>
<a href="#l3.4321"></a><span id="l3.4321" class="difflineminus">-      // who cares about binary transparency, and anyway \0 in this context violates RFCs.</span>
<a href="#l3.4322"></a><span id="l3.4322" class="difflineplus">+      // strlen() *would* fail on data containing \0, but the above</span>
<a href="#l3.4323"></a><span id="l3.4323" class="difflineplus">+      // AdvanceToNextLine() in nsMsgLineStreamBuffer::ReadNextLine() we replace</span>
<a href="#l3.4324"></a><span id="l3.4324" class="difflineplus">+      // '\0' with ' ' (blank) because who cares about binary transparency, and</span>
<a href="#l3.4325"></a><span id="l3.4325" class="difflineplus">+      // anyway \0 in this context violates RFCs.</span>
<a href="#l3.4326"></a><span id="l3.4326">       charsReadSoFar += strlen(fCurrentLine);</span>
<a href="#l3.4327"></a><span id="l3.4327" class="difflineminus">-      if (!fDownloadingHeaders &amp;&amp; fCurrentCommandIsSingleMessageFetch)</span>
<a href="#l3.4328"></a><span id="l3.4328" class="difflineminus">-      {</span>
<a href="#l3.4329"></a><span id="l3.4329" class="difflineminus">-        fServerConnection.ProgressEventFunctionUsingName(&quot;imapDownloadingMessage&quot;);</span>
<a href="#l3.4330"></a><span id="l3.4330" class="difflineplus">+      if (!fDownloadingHeaders &amp;&amp; fCurrentCommandIsSingleMessageFetch) {</span>
<a href="#l3.4331"></a><span id="l3.4331" class="difflineplus">+        fServerConnection.ProgressEventFunctionUsingName(</span>
<a href="#l3.4332"></a><span id="l3.4332" class="difflineplus">+            &quot;imapDownloadingMessage&quot;);</span>
<a href="#l3.4333"></a><span id="l3.4333">         if (fTotalDownloadSize &gt; 0)</span>
<a href="#l3.4334"></a><span id="l3.4334" class="difflineminus">-          fServerConnection.PercentProgressUpdateEvent(0, charsReadSoFar + origin, fTotalDownloadSize);</span>
<a href="#l3.4335"></a><span id="l3.4335" class="difflineplus">+          fServerConnection.PercentProgressUpdateEvent(</span>
<a href="#l3.4336"></a><span id="l3.4336" class="difflineplus">+              0, charsReadSoFar + origin, fTotalDownloadSize);</span>
<a href="#l3.4337"></a><span id="l3.4337">       }</span>
<a href="#l3.4338"></a><span id="l3.4338" class="difflineminus">-      if (charsReadSoFar &gt; numberOfCharsInThisChunk)</span>
<a href="#l3.4339"></a><span id="l3.4339" class="difflineminus">-      {</span>
<a href="#l3.4340"></a><span id="l3.4340" class="difflineminus">-        // This is the last line of a chunk. &quot;Literal&quot; here means actual email data and</span>
<a href="#l3.4341"></a><span id="l3.4341" class="difflineminus">-        // its EOLs, without imap protocol elements and their EOLs. End of line is</span>
<a href="#l3.4342"></a><span id="l3.4342" class="difflineminus">-        // defined by two characters \r\n (i.e., CRLF, 0xd,0xa) specified by RFC822.</span>
<a href="#l3.4343"></a><span id="l3.4343" class="difflineminus">-        // Here is an example the most typical last good line of a chunk:</span>
<a href="#l3.4344"></a><span id="l3.4344" class="difflineminus">-        // &quot;1s8AA5i4AAvF4QAG6+sAAD0bAPsAAAAA1OAAC)\r\n&quot;, where &quot;)\r\n&quot; are non-literals.</span>
<a href="#l3.4345"></a><span id="l3.4345" class="difflineminus">-        // This an example of the last &quot;good&quot; line of a chunk that terminates with \r\n</span>
<a href="#l3.4346"></a><span id="l3.4346" class="difflineplus">+      if (charsReadSoFar &gt; numberOfCharsInThisChunk) {</span>
<a href="#l3.4347"></a><span id="l3.4347" class="difflineplus">+        // This is the last line of a chunk. &quot;Literal&quot; here means actual email</span>
<a href="#l3.4348"></a><span id="l3.4348" class="difflineplus">+        // data and its EOLs, without imap protocol elements and their EOLs. End</span>
<a href="#l3.4349"></a><span id="l3.4349" class="difflineplus">+        // of line is defined by two characters \r\n (i.e., CRLF, 0xd,0xa)</span>
<a href="#l3.4350"></a><span id="l3.4350" class="difflineplus">+        // specified by RFC822. Here is an example the most typical last good</span>
<a href="#l3.4351"></a><span id="l3.4351" class="difflineplus">+        // line of a chunk: &quot;1s8AA5i4AAvF4QAG6+sAAD0bAPsAAAAA1OAAC)\r\n&quot;, where</span>
<a href="#l3.4352"></a><span id="l3.4352" class="difflineplus">+        // &quot;)\r\n&quot; are non-literals. This an example of the last &quot;good&quot; line of</span>
<a href="#l3.4353"></a><span id="l3.4353" class="difflineplus">+        // a chunk that terminates with \r\n</span>
<a href="#l3.4354"></a><span id="l3.4354">         // &quot;FxcA/wAAAALN2gADu80ACS0nAPpVVAD1wNAABF5YAPhAJgD31+QABAAAAP8oMQD+HBwA/umj\r\n&quot;</span>
<a href="#l3.4355"></a><span id="l3.4355">         // followed by another line of non-literal data:</span>
<a href="#l3.4356"></a><span id="l3.4356" class="difflineminus">-        // &quot; UID 1004)\r\n&quot;. These two are concatenated into a single string pointed to</span>
<a href="#l3.4357"></a><span id="l3.4357" class="difflineminus">-        // by fCurrentLine.  The extra &quot;non-literal data&quot; on the last chunk line makes</span>
<a href="#l3.4358"></a><span id="l3.4358" class="difflineminus">-        // the charsReadSoFar greater than numberOfCharsInThisChunk (the configured</span>
<a href="#l3.4359"></a><span id="l3.4359" class="difflineminus">-        // chunk size).</span>
<a href="#l3.4360"></a><span id="l3.4360" class="difflineminus">-        // A problem occurs if the \r\n of the long line above is split between</span>
<a href="#l3.4361"></a><span id="l3.4361" class="difflineminus">-        // chunks and \n is contained in the next chunk. For example, if last</span>
<a href="#l3.4362"></a><span id="l3.4362" class="difflineminus">-        // lines of chunk X are:</span>
<a href="#l3.4363"></a><span id="l3.4363" class="difflineplus">+        // &quot; UID 1004)\r\n&quot;. These two are concatenated into a single string</span>
<a href="#l3.4364"></a><span id="l3.4364" class="difflineplus">+        // pointed to by fCurrentLine.  The extra &quot;non-literal data&quot; on the last</span>
<a href="#l3.4365"></a><span id="l3.4365" class="difflineplus">+        // chunk line makes the charsReadSoFar greater than</span>
<a href="#l3.4366"></a><span id="l3.4366" class="difflineplus">+        // numberOfCharsInThisChunk (the configured chunk size). A problem</span>
<a href="#l3.4367"></a><span id="l3.4367" class="difflineplus">+        // occurs if the \r\n of the long line above is split between chunks and</span>
<a href="#l3.4368"></a><span id="l3.4368" class="difflineplus">+        // \n is contained in the next chunk. For example, if last lines of</span>
<a href="#l3.4369"></a><span id="l3.4369" class="difflineplus">+        // chunk X are:</span>
<a href="#l3.4370"></a><span id="l3.4370">         // &quot;/gAOC/wA/QAAAAAAAAAA8wACCvz+AgIEAAD8/P4ABQUAAPoAAAD+AAEA/voHAAQGBQD/BAQA\r&quot;</span>
<a href="#l3.4371"></a><span id="l3.4371">         // &quot;)\r\n&quot;</span>
<a href="#l3.4372"></a><span id="l3.4372">         // and the first two lines of chunk X+1 are:</span>
<a href="#l3.4373"></a><span id="l3.4373">         // &quot;\n&quot;</span>
<a href="#l3.4374"></a><span id="l3.4374">         // &quot;APwAAAAAmZkA/wAAAAAREQD/AAAAAquVAAbk8QAHCBAAAPD0AAP5+wABRCoA+0BgAP0AAAAA\r\n&quot;</span>
<a href="#l3.4375"></a><span id="l3.4375" class="difflineminus">-        // The missing '\n' on the last line of chunk X must be added back and the</span>
<a href="#l3.4376"></a><span id="l3.4376" class="difflineminus">-        // line consisting only of &quot;\n&quot; in chunk X+1 must be ignored in order to</span>
<a href="#l3.4377"></a><span id="l3.4377" class="difflineminus">-        // produce the the correct output. This is needed to insure that the signature</span>
<a href="#l3.4378"></a><span id="l3.4378" class="difflineminus">-        // verification of cryptographically signed emails does not fail due to missing</span>
<a href="#l3.4379"></a><span id="l3.4379" class="difflineminus">-        // or extra EOL characters. Otherwise, the extra or missing \n or \r  doesn't</span>
<a href="#l3.4380"></a><span id="l3.4380" class="difflineminus">-        // really matter.</span>
<a href="#l3.4381"></a><span id="l3.4381" class="difflineplus">+        // The missing '\n' on the last line of chunk X must be added back and</span>
<a href="#l3.4382"></a><span id="l3.4382" class="difflineplus">+        // the line consisting only of &quot;\n&quot; in chunk X+1 must be ignored in</span>
<a href="#l3.4383"></a><span id="l3.4383" class="difflineplus">+        // order to produce the the correct output. This is needed to insure</span>
<a href="#l3.4384"></a><span id="l3.4384" class="difflineplus">+        // that the signature verification of cryptographically signed emails</span>
<a href="#l3.4385"></a><span id="l3.4385" class="difflineplus">+        // does not fail due to missing or extra EOL characters. Otherwise, the</span>
<a href="#l3.4386"></a><span id="l3.4386" class="difflineplus">+        // extra or missing \n or \r  doesn't really matter.</span>
<a href="#l3.4387"></a><span id="l3.4387">         //</span>
<a href="#l3.4388"></a><span id="l3.4388">         // Special case observed only with the &quot;fake&quot; imap server used with TB</span>
<a href="#l3.4389"></a><span id="l3.4389" class="difflineminus">-        // unit test.  When the &quot;\r\n&quot; at the end of a chunk is split as described</span>
<a href="#l3.4390"></a><span id="l3.4390" class="difflineminus">-        // above, the \n at the beginning of the next chunk may actually be &quot;\r\n&quot;</span>
<a href="#l3.4391"></a><span id="l3.4391" class="difflineminus">-        // like this example:</span>
<a href="#l3.4392"></a><span id="l3.4392" class="difflineminus">-        // Last lines of chunk X</span>
<a href="#l3.4393"></a><span id="l3.4393" class="difflineplus">+        // unit test.  When the &quot;\r\n&quot; at the end of a chunk is split as</span>
<a href="#l3.4394"></a><span id="l3.4394" class="difflineplus">+        // described above, the \n at the beginning of the next chunk may</span>
<a href="#l3.4395"></a><span id="l3.4395" class="difflineplus">+        // actually be &quot;\r\n&quot; like this example: Last lines of chunk X</span>
<a href="#l3.4396"></a><span id="l3.4396">         // &quot;/gAOC/wA/QAAAAAAAAAA8wACCvz+AgIEAAD8/P4ABQUAAPoAAAD+AAEA/voHAAQGBQD/BAQA\r&quot;</span>
<a href="#l3.4397"></a><span id="l3.4397">         // &quot;)\r\n&quot;</span>
<a href="#l3.4398"></a><span id="l3.4398">         // and the first two lines of chunk X+1:</span>
<a href="#l3.4399"></a><span id="l3.4399">         // &quot;\r\n&quot;   &lt;-- The code changes this to just &quot;\n&quot; like it should be.</span>
<a href="#l3.4400"></a><span id="l3.4400">         // &quot;APwAAAAAmZkA/wAAAAAREQD/AAAAAquVAAbk8QAHCBAAAPD0AAP5+wABRCoA+0BgAP0AAAAA\r\n&quot;</span>
<a href="#l3.4401"></a><span id="l3.4401">         //</span>
<a href="#l3.4402"></a><span id="l3.4402">         // Implementation:</span>
<a href="#l3.4403"></a><span id="l3.4403" class="difflineminus">-        // Obtain pointer to last literal in chunk X, e.g., 'C' in 1st example above,</span>
<a href="#l3.4404"></a><span id="l3.4404" class="difflineminus">-        // or to the \n or \r in the other examples.</span>
<a href="#l3.4405"></a><span id="l3.4405" class="difflineplus">+        // Obtain pointer to last literal in chunk X, e.g., 'C' in 1st example</span>
<a href="#l3.4406"></a><span id="l3.4406" class="difflineplus">+        // above, or to the \n or \r in the other examples.</span>
<a href="#l3.4407"></a><span id="l3.4407">         char *displayEndOfLine =</span>
<a href="#l3.4408"></a><span id="l3.4408" class="difflineminus">-          (fCurrentLine + strlen(fCurrentLine) - (charsReadSoFar - numberOfCharsInThisChunk + 1));</span>
<a href="#l3.4409"></a><span id="l3.4409" class="difflineplus">+            (fCurrentLine + strlen(fCurrentLine) -</span>
<a href="#l3.4410"></a><span id="l3.4410" class="difflineplus">+             (charsReadSoFar - numberOfCharsInThisChunk + 1));</span>
<a href="#l3.4411"></a><span id="l3.4411">         // Save so original unmodified fCurrentLine is restored below.</span>
<a href="#l3.4412"></a><span id="l3.4412">         char saveit1 = displayEndOfLine[1];</span>
<a href="#l3.4413"></a><span id="l3.4413">         char saveit2 = 0;  // Keep compiler happy.</span>
<a href="#l3.4414"></a><span id="l3.4414">         // Determine if EOL is split such that Chunk X has the \r and chunk</span>
<a href="#l3.4415"></a><span id="l3.4415">         // X+1 has the \n.</span>
<a href="#l3.4416"></a><span id="l3.4416">         fNextChunkStartsWithNewline = (displayEndOfLine[0] == '\r');</span>
<a href="#l3.4417"></a><span id="l3.4417" class="difflineminus">-        if (fNextChunkStartsWithNewline)</span>
<a href="#l3.4418"></a><span id="l3.4418" class="difflineminus">-        {</span>
<a href="#l3.4419"></a><span id="l3.4419" class="difflineplus">+        if (fNextChunkStartsWithNewline) {</span>
<a href="#l3.4420"></a><span id="l3.4420">           saveit2 = displayEndOfLine[2];</span>
<a href="#l3.4421"></a><span id="l3.4421">           // Add the missing newline and terminate the string.</span>
<a href="#l3.4422"></a><span id="l3.4422">           displayEndOfLine[1] = '\n';</span>
<a href="#l3.4423"></a><span id="l3.4423">           displayEndOfLine[2] = 0;</span>
<a href="#l3.4424"></a><span id="l3.4424">           // This is a good thing to log.</span>
<a href="#l3.4425"></a><span id="l3.4425" class="difflineminus">-          MOZ_LOG(IMAP, mozilla::LogLevel::Info, (&quot;PARSER: CR/LF split at chunk boundary&quot;));</span>
<a href="#l3.4426"></a><span id="l3.4426" class="difflineminus">-        }</span>
<a href="#l3.4427"></a><span id="l3.4427" class="difflineminus">-        else</span>
<a href="#l3.4428"></a><span id="l3.4428" class="difflineminus">-        {</span>
<a href="#l3.4429"></a><span id="l3.4429" class="difflineplus">+          MOZ_LOG(IMAP, mozilla::LogLevel::Info,</span>
<a href="#l3.4430"></a><span id="l3.4430" class="difflineplus">+                  (&quot;PARSER: CR/LF split at chunk boundary&quot;));</span>
<a href="#l3.4431"></a><span id="l3.4431" class="difflineplus">+        } else {</span>
<a href="#l3.4432"></a><span id="l3.4432">           // Typical case where EOLs are not split. Terminate the string.</span>
<a href="#l3.4433"></a><span id="l3.4433">           displayEndOfLine[1] = 0;</span>
<a href="#l3.4434"></a><span id="l3.4434">         }</span>
<a href="#l3.4435"></a><span id="l3.4435">         // Process this modified string pointed to by fCurrentLine.</span>
<a href="#l3.4436"></a><span id="l3.4436">         fServerConnection.HandleMessageDownLoadLine(fCurrentLine, !lastChunk);</span>
<a href="#l3.4437"></a><span id="l3.4437">         // Restore fCurrentLine's original content.</span>
<a href="#l3.4438"></a><span id="l3.4438">         displayEndOfLine[1] = saveit1;</span>
<a href="#l3.4439"></a><span id="l3.4439" class="difflineminus">-        if (fNextChunkStartsWithNewline)</span>
<a href="#l3.4440"></a><span id="l3.4440" class="difflineminus">-          displayEndOfLine[2] = saveit2;</span>
<a href="#l3.4441"></a><span id="l3.4441" class="difflineminus">-      }</span>
<a href="#l3.4442"></a><span id="l3.4442" class="difflineminus">-      else</span>
<a href="#l3.4443"></a><span id="l3.4443" class="difflineminus">-      {</span>
<a href="#l3.4444"></a><span id="l3.4444" class="difflineplus">+        if (fNextChunkStartsWithNewline) displayEndOfLine[2] = saveit2;</span>
<a href="#l3.4445"></a><span id="l3.4445" class="difflineplus">+      } else {</span>
<a href="#l3.4446"></a><span id="l3.4446">         // Not the last line of a chunk.</span>
<a href="#l3.4447"></a><span id="l3.4447" class="difflineminus">-        if (!fNextChunkStartsWithNewline)</span>
<a href="#l3.4448"></a><span id="l3.4448" class="difflineminus">-        {</span>
<a href="#l3.4449"></a><span id="l3.4449" class="difflineplus">+        if (!fNextChunkStartsWithNewline) {</span>
<a href="#l3.4450"></a><span id="l3.4450">           // Process unmodified fCurrentLine string.</span>
<a href="#l3.4451"></a><span id="l3.4451" class="difflineminus">-          fServerConnection.HandleMessageDownLoadLine(fCurrentLine,</span>
<a href="#l3.4452"></a><span id="l3.4452" class="difflineminus">-            !lastChunk &amp;&amp; (charsReadSoFar == numberOfCharsInThisChunk),</span>
<a href="#l3.4453"></a><span id="l3.4453" class="difflineminus">-            fCurrentLine);</span>
<a href="#l3.4454"></a><span id="l3.4454" class="difflineminus">-        }</span>
<a href="#l3.4455"></a><span id="l3.4455" class="difflineminus">-        else</span>
<a href="#l3.4456"></a><span id="l3.4456" class="difflineminus">-        {</span>
<a href="#l3.4457"></a><span id="l3.4457" class="difflineplus">+          fServerConnection.HandleMessageDownLoadLine(</span>
<a href="#l3.4458"></a><span id="l3.4458" class="difflineplus">+              fCurrentLine,</span>
<a href="#l3.4459"></a><span id="l3.4459" class="difflineplus">+              !lastChunk &amp;&amp; (charsReadSoFar == numberOfCharsInThisChunk),</span>
<a href="#l3.4460"></a><span id="l3.4460" class="difflineplus">+              fCurrentLine);</span>
<a href="#l3.4461"></a><span id="l3.4461" class="difflineplus">+        } else {</span>
<a href="#l3.4462"></a><span id="l3.4462">           // Ignore the orphan '\n' on a line by itself.</span>
<a href="#l3.4463"></a><span id="l3.4463">           MOZ_ASSERT(strlen(fCurrentLine) == 1 &amp;&amp; fCurrentLine[0] == '\n',</span>
<a href="#l3.4464"></a><span id="l3.4464">                      &quot;Expect '\\n' as only character in this line&quot;);</span>
<a href="#l3.4465"></a><span id="l3.4465">           fNextChunkStartsWithNewline = false;</span>
<a href="#l3.4466"></a><span id="l3.4466">         }</span>
<a href="#l3.4467"></a><span id="l3.4467">       }</span>
<a href="#l3.4468"></a><span id="l3.4468">     }</span>
<a href="#l3.4469"></a><span id="l3.4469">   }</span>
<a href="#l3.4470"></a><span id="l3.4470"> </span>
<a href="#l3.4471"></a><span id="l3.4471" class="difflineminus">-  if (ContinueParse())</span>
<a href="#l3.4472"></a><span id="l3.4472" class="difflineminus">-  {</span>
<a href="#l3.4473"></a><span id="l3.4473" class="difflineminus">-    if (charsReadSoFar &gt; numberOfCharsInThisChunk)</span>
<a href="#l3.4474"></a><span id="l3.4474" class="difflineminus">-    {</span>
<a href="#l3.4475"></a><span id="l3.4475" class="difflineminus">-      // move the lexical analyzer state to the end of this message because this message</span>
<a href="#l3.4476"></a><span id="l3.4476" class="difflineminus">-      // fetch ends in the middle of this line.</span>
<a href="#l3.4477"></a><span id="l3.4477" class="difflineminus">-      AdvanceTokenizerStartingPoint(strlen(fCurrentLine) - (charsReadSoFar - numberOfCharsInThisChunk));</span>
<a href="#l3.4478"></a><span id="l3.4478" class="difflineplus">+  if (ContinueParse()) {</span>
<a href="#l3.4479"></a><span id="l3.4479" class="difflineplus">+    if (charsReadSoFar &gt; numberOfCharsInThisChunk) {</span>
<a href="#l3.4480"></a><span id="l3.4480" class="difflineplus">+      // move the lexical analyzer state to the end of this message because this</span>
<a href="#l3.4481"></a><span id="l3.4481" class="difflineplus">+      // message fetch ends in the middle of this line.</span>
<a href="#l3.4482"></a><span id="l3.4482" class="difflineplus">+      AdvanceTokenizerStartingPoint(</span>
<a href="#l3.4483"></a><span id="l3.4483" class="difflineplus">+          strlen(fCurrentLine) - (charsReadSoFar - numberOfCharsInThisChunk));</span>
<a href="#l3.4484"></a><span id="l3.4484">       AdvanceToNextToken();</span>
<a href="#l3.4485"></a><span id="l3.4485" class="difflineminus">-    }</span>
<a href="#l3.4486"></a><span id="l3.4486" class="difflineminus">-    else</span>
<a href="#l3.4487"></a><span id="l3.4487" class="difflineminus">-    {</span>
<a href="#l3.4488"></a><span id="l3.4488" class="difflineplus">+    } else {</span>
<a href="#l3.4489"></a><span id="l3.4489">       skip_to_CRLF();</span>
<a href="#l3.4490"></a><span id="l3.4490">       AdvanceToNextToken();</span>
<a href="#l3.4491"></a><span id="l3.4491">     }</span>
<a href="#l3.4492"></a><span id="l3.4492" class="difflineminus">-  }</span>
<a href="#l3.4493"></a><span id="l3.4493" class="difflineminus">-  else</span>
<a href="#l3.4494"></a><span id="l3.4494" class="difflineminus">-  {</span>
<a href="#l3.4495"></a><span id="l3.4495" class="difflineplus">+  } else {</span>
<a href="#l3.4496"></a><span id="l3.4496">     fNextChunkStartsWithNewline = false;</span>
<a href="#l3.4497"></a><span id="l3.4497">   }</span>
<a href="#l3.4498"></a><span id="l3.4498">   return lastChunk;</span>
<a href="#l3.4499"></a><span id="l3.4499"> }</span>
<a href="#l3.4500"></a><span id="l3.4500"> </span>
<a href="#l3.4501"></a><span id="l3.4501" class="difflineminus">-bool nsImapServerResponseParser::CurrentFolderReadOnly()</span>
<a href="#l3.4502"></a><span id="l3.4502" class="difflineminus">-{</span>
<a href="#l3.4503"></a><span id="l3.4503" class="difflineplus">+bool nsImapServerResponseParser::CurrentFolderReadOnly() {</span>
<a href="#l3.4504"></a><span id="l3.4504">   return fCurrentFolderReadOnly;</span>
<a href="#l3.4505"></a><span id="l3.4505"> }</span>
<a href="#l3.4506"></a><span id="l3.4506"> </span>
<a href="#l3.4507"></a><span id="l3.4507" class="difflineminus">-int32_t nsImapServerResponseParser::NumberOfMessages()</span>
<a href="#l3.4508"></a><span id="l3.4508" class="difflineminus">-{</span>
<a href="#l3.4509"></a><span id="l3.4509" class="difflineplus">+int32_t nsImapServerResponseParser::NumberOfMessages() {</span>
<a href="#l3.4510"></a><span id="l3.4510">   return fNumberOfExistingMessages;</span>
<a href="#l3.4511"></a><span id="l3.4511"> }</span>
<a href="#l3.4512"></a><span id="l3.4512"> </span>
<a href="#l3.4513"></a><span id="l3.4513" class="difflineminus">-int32_t nsImapServerResponseParser::NumberOfRecentMessages()</span>
<a href="#l3.4514"></a><span id="l3.4514" class="difflineminus">-{</span>
<a href="#l3.4515"></a><span id="l3.4515" class="difflineplus">+int32_t nsImapServerResponseParser::NumberOfRecentMessages() {</span>
<a href="#l3.4516"></a><span id="l3.4516">   return fNumberOfRecentMessages;</span>
<a href="#l3.4517"></a><span id="l3.4517"> }</span>
<a href="#l3.4518"></a><span id="l3.4518"> </span>
<a href="#l3.4519"></a><span id="l3.4519" class="difflineminus">-int32_t nsImapServerResponseParser::NumberOfUnseenMessages()</span>
<a href="#l3.4520"></a><span id="l3.4520" class="difflineminus">-{</span>
<a href="#l3.4521"></a><span id="l3.4521" class="difflineplus">+int32_t nsImapServerResponseParser::NumberOfUnseenMessages() {</span>
<a href="#l3.4522"></a><span id="l3.4522">   return fNumberOfUnseenMessages;</span>
<a href="#l3.4523"></a><span id="l3.4523"> }</span>
<a href="#l3.4524"></a><span id="l3.4524"> </span>
<a href="#l3.4525"></a><span id="l3.4525" class="difflineminus">-int32_t nsImapServerResponseParser::FolderUID()</span>
<a href="#l3.4526"></a><span id="l3.4526" class="difflineminus">-{</span>
<a href="#l3.4527"></a><span id="l3.4527" class="difflineminus">-  return fFolderUIDValidity;</span>
<a href="#l3.4528"></a><span id="l3.4528" class="difflineplus">+int32_t nsImapServerResponseParser::FolderUID() { return fFolderUIDValidity; }</span>
<a href="#l3.4529"></a><span id="l3.4529" class="difflineplus">+</span>
<a href="#l3.4530"></a><span id="l3.4530" class="difflineplus">+void nsImapServerResponseParser::SetCurrentResponseUID(uint32_t uid) {</span>
<a href="#l3.4531"></a><span id="l3.4531" class="difflineplus">+  if (uid &gt; 0) fCurrentResponseUID = uid;</span>
<a href="#l3.4532"></a><span id="l3.4532"> }</span>
<a href="#l3.4533"></a><span id="l3.4533"> </span>
<a href="#l3.4534"></a><span id="l3.4534" class="difflineminus">-void nsImapServerResponseParser::SetCurrentResponseUID(uint32_t uid)</span>
<a href="#l3.4535"></a><span id="l3.4535" class="difflineminus">-{</span>
<a href="#l3.4536"></a><span id="l3.4536" class="difflineminus">-  if (uid &gt; 0)</span>
<a href="#l3.4537"></a><span id="l3.4537" class="difflineminus">-    fCurrentResponseUID = uid;</span>
<a href="#l3.4538"></a><span id="l3.4538" class="difflineminus">-}</span>
<a href="#l3.4539"></a><span id="l3.4539" class="difflineminus">-</span>
<a href="#l3.4540"></a><span id="l3.4540" class="difflineminus">-uint32_t nsImapServerResponseParser::CurrentResponseUID()</span>
<a href="#l3.4541"></a><span id="l3.4541" class="difflineminus">-{</span>
<a href="#l3.4542"></a><span id="l3.4542" class="difflineplus">+uint32_t nsImapServerResponseParser::CurrentResponseUID() {</span>
<a href="#l3.4543"></a><span id="l3.4543">   return fCurrentResponseUID;</span>
<a href="#l3.4544"></a><span id="l3.4544"> }</span>
<a href="#l3.4545"></a><span id="l3.4545"> </span>
<a href="#l3.4546"></a><span id="l3.4546" class="difflineminus">-uint32_t nsImapServerResponseParser::HighestRecordedUID()</span>
<a href="#l3.4547"></a><span id="l3.4547" class="difflineminus">-{</span>
<a href="#l3.4548"></a><span id="l3.4548" class="difflineplus">+uint32_t nsImapServerResponseParser::HighestRecordedUID() {</span>
<a href="#l3.4549"></a><span id="l3.4549">   return fHighestRecordedUID;</span>
<a href="#l3.4550"></a><span id="l3.4550"> }</span>
<a href="#l3.4551"></a><span id="l3.4551"> </span>
<a href="#l3.4552"></a><span id="l3.4552" class="difflineminus">-void nsImapServerResponseParser::ResetHighestRecordedUID()</span>
<a href="#l3.4553"></a><span id="l3.4553" class="difflineminus">-{</span>
<a href="#l3.4554"></a><span id="l3.4554" class="difflineplus">+void nsImapServerResponseParser::ResetHighestRecordedUID() {</span>
<a href="#l3.4555"></a><span id="l3.4555">   fHighestRecordedUID = 0;</span>
<a href="#l3.4556"></a><span id="l3.4556"> }</span>
<a href="#l3.4557"></a><span id="l3.4557"> </span>
<a href="#l3.4558"></a><span id="l3.4558" class="difflineminus">-bool nsImapServerResponseParser::IsNumericString(const char *string)</span>
<a href="#l3.4559"></a><span id="l3.4559" class="difflineminus">-{</span>
<a href="#l3.4560"></a><span id="l3.4560" class="difflineplus">+bool nsImapServerResponseParser::IsNumericString(const char *string) {</span>
<a href="#l3.4561"></a><span id="l3.4561">   int i;</span>
<a href="#l3.4562"></a><span id="l3.4562" class="difflineminus">-  for(i = 0; i &lt; (int) PL_strlen(string); i++)</span>
<a href="#l3.4563"></a><span id="l3.4563" class="difflineminus">-  {</span>
<a href="#l3.4564"></a><span id="l3.4564" class="difflineminus">-    if (! isdigit(string[i]))</span>
<a href="#l3.4565"></a><span id="l3.4565" class="difflineminus">-    {</span>
<a href="#l3.4566"></a><span id="l3.4566" class="difflineplus">+  for (i = 0; i &lt; (int)PL_strlen(string); i++) {</span>
<a href="#l3.4567"></a><span id="l3.4567" class="difflineplus">+    if (!isdigit(string[i])) {</span>
<a href="#l3.4568"></a><span id="l3.4568">       return false;</span>
<a href="#l3.4569"></a><span id="l3.4569">     }</span>
<a href="#l3.4570"></a><span id="l3.4570">   }</span>
<a href="#l3.4571"></a><span id="l3.4571"> </span>
<a href="#l3.4572"></a><span id="l3.4572">   return true;</span>
<a href="#l3.4573"></a><span id="l3.4573"> }</span>
<a href="#l3.4574"></a><span id="l3.4574"> </span>
<a href="#l3.4575"></a><span id="l3.4575" class="difflineminus">-</span>
<a href="#l3.4576"></a><span id="l3.4576"> already_AddRefed&lt;nsImapMailboxSpec&gt;</span>
<a href="#l3.4577"></a><span id="l3.4577" class="difflineminus">-nsImapServerResponseParser::CreateCurrentMailboxSpec(const char *mailboxName /* = nullptr */)</span>
<a href="#l3.4578"></a><span id="l3.4578" class="difflineminus">-{</span>
<a href="#l3.4579"></a><span id="l3.4579" class="difflineplus">+nsImapServerResponseParser::CreateCurrentMailboxSpec(</span>
<a href="#l3.4580"></a><span id="l3.4580" class="difflineplus">+    const char *mailboxName /* = nullptr */) {</span>
<a href="#l3.4581"></a><span id="l3.4581">   RefPtr&lt;nsImapMailboxSpec&gt; returnSpec = new nsImapMailboxSpec;</span>
<a href="#l3.4582"></a><span id="l3.4582" class="difflineminus">-  const char *mailboxNameToConvert = (mailboxName) ? mailboxName : fSelectedMailboxName;</span>
<a href="#l3.4583"></a><span id="l3.4583" class="difflineminus">-  if (mailboxNameToConvert)</span>
<a href="#l3.4584"></a><span id="l3.4584" class="difflineminus">-  {</span>
<a href="#l3.4585"></a><span id="l3.4585" class="difflineplus">+  const char *mailboxNameToConvert =</span>
<a href="#l3.4586"></a><span id="l3.4586" class="difflineplus">+      (mailboxName) ? mailboxName : fSelectedMailboxName;</span>
<a href="#l3.4587"></a><span id="l3.4587" class="difflineplus">+  if (mailboxNameToConvert) {</span>
<a href="#l3.4588"></a><span id="l3.4588">     const char *serverKey = fServerConnection.GetImapServerKey();</span>
<a href="#l3.4589"></a><span id="l3.4589">     nsIMAPNamespace *ns = nullptr;</span>
<a href="#l3.4590"></a><span id="l3.4590">     if (serverKey &amp;&amp; fHostSessionList)</span>
<a href="#l3.4591"></a><span id="l3.4591" class="difflineminus">-      fHostSessionList-&gt;GetNamespaceForMailboxForHost(serverKey, mailboxNameToConvert, ns);  // for</span>
<a href="#l3.4592"></a><span id="l3.4592" class="difflineminus">-      // delimiter</span>
<a href="#l3.4593"></a><span id="l3.4593" class="difflineminus">-    returnSpec-&gt;mHierarchySeparator = (ns) ? ns-&gt;GetDelimiter(): '/';</span>
<a href="#l3.4594"></a><span id="l3.4594" class="difflineminus">-</span>
<a href="#l3.4595"></a><span id="l3.4595" class="difflineplus">+      fHostSessionList-&gt;GetNamespaceForMailboxForHost(</span>
<a href="#l3.4596"></a><span id="l3.4596" class="difflineplus">+          serverKey, mailboxNameToConvert, ns);  // for</span>
<a href="#l3.4597"></a><span id="l3.4597" class="difflineplus">+    // delimiter</span>
<a href="#l3.4598"></a><span id="l3.4598" class="difflineplus">+    returnSpec-&gt;mHierarchySeparator = (ns) ? ns-&gt;GetDelimiter() : '/';</span>
<a href="#l3.4599"></a><span id="l3.4599">   }</span>
<a href="#l3.4600"></a><span id="l3.4600"> </span>
<a href="#l3.4601"></a><span id="l3.4601" class="difflineminus">-  returnSpec-&gt;mFolderSelected = !mailboxName; // if mailboxName is null, we're doing a Status</span>
<a href="#l3.4602"></a><span id="l3.4602" class="difflineplus">+  returnSpec-&gt;mFolderSelected =</span>
<a href="#l3.4603"></a><span id="l3.4603" class="difflineplus">+      !mailboxName;  // if mailboxName is null, we're doing a Status</span>
<a href="#l3.4604"></a><span id="l3.4604">   returnSpec-&gt;mFolder_UIDVALIDITY = fFolderUIDValidity;</span>
<a href="#l3.4605"></a><span id="l3.4605">   returnSpec-&gt;mHighestModSeq = fHighestModSeq;</span>
<a href="#l3.4606"></a><span id="l3.4606" class="difflineminus">-  returnSpec-&gt;mNumOfMessages = (mailboxName) ? fStatusExistingMessages : fNumberOfExistingMessages;</span>
<a href="#l3.4607"></a><span id="l3.4607" class="difflineminus">-  returnSpec-&gt;mNumOfUnseenMessages = (mailboxName) ? fStatusUnseenMessages : fNumberOfUnseenMessages;</span>
<a href="#l3.4608"></a><span id="l3.4608" class="difflineminus">-  returnSpec-&gt;mNumOfRecentMessages = (mailboxName) ? fStatusRecentMessages : fNumberOfRecentMessages;</span>
<a href="#l3.4609"></a><span id="l3.4609" class="difflineplus">+  returnSpec-&gt;mNumOfMessages =</span>
<a href="#l3.4610"></a><span id="l3.4610" class="difflineplus">+      (mailboxName) ? fStatusExistingMessages : fNumberOfExistingMessages;</span>
<a href="#l3.4611"></a><span id="l3.4611" class="difflineplus">+  returnSpec-&gt;mNumOfUnseenMessages =</span>
<a href="#l3.4612"></a><span id="l3.4612" class="difflineplus">+      (mailboxName) ? fStatusUnseenMessages : fNumberOfUnseenMessages;</span>
<a href="#l3.4613"></a><span id="l3.4613" class="difflineplus">+  returnSpec-&gt;mNumOfRecentMessages =</span>
<a href="#l3.4614"></a><span id="l3.4614" class="difflineplus">+      (mailboxName) ? fStatusRecentMessages : fNumberOfRecentMessages;</span>
<a href="#l3.4615"></a><span id="l3.4615">   returnSpec-&gt;mNextUID = fStatusNextUID;</span>
<a href="#l3.4616"></a><span id="l3.4616"> </span>
<a href="#l3.4617"></a><span id="l3.4617">   returnSpec-&gt;mSupportedUserFlags = fSupportsUserDefinedFlags;</span>
<a href="#l3.4618"></a><span id="l3.4618"> </span>
<a href="#l3.4619"></a><span id="l3.4619">   returnSpec-&gt;mBoxFlags = kNoFlags;  // stub</span>
<a href="#l3.4620"></a><span id="l3.4620" class="difflineminus">-  returnSpec-&gt;mOnlineVerified = false;  // we're fabricating this.  The flags aren't verified.</span>
<a href="#l3.4621"></a><span id="l3.4621" class="difflineplus">+  returnSpec-&gt;mOnlineVerified =</span>
<a href="#l3.4622"></a><span id="l3.4622" class="difflineplus">+      false;  // we're fabricating this.  The flags aren't verified.</span>
<a href="#l3.4623"></a><span id="l3.4623">   returnSpec-&gt;mAllocatedPathName.Assign(mailboxNameToConvert);</span>
<a href="#l3.4624"></a><span id="l3.4624">   returnSpec-&gt;mConnection = &amp;fServerConnection;</span>
<a href="#l3.4625"></a><span id="l3.4625" class="difflineminus">-  if (returnSpec-&gt;mConnection)</span>
<a href="#l3.4626"></a><span id="l3.4626" class="difflineminus">-  {</span>
<a href="#l3.4627"></a><span id="l3.4627" class="difflineminus">-    nsIURI * aUrl = nullptr;</span>
<a href="#l3.4628"></a><span id="l3.4628" class="difflineplus">+  if (returnSpec-&gt;mConnection) {</span>
<a href="#l3.4629"></a><span id="l3.4629" class="difflineplus">+    nsIURI *aUrl = nullptr;</span>
<a href="#l3.4630"></a><span id="l3.4630">     nsresult rv = NS_OK;</span>
<a href="#l3.4631"></a><span id="l3.4631" class="difflineminus">-    returnSpec-&gt;mConnection-&gt;GetCurrentUrl()-&gt;QueryInterface(NS_GET_IID(nsIURI), (void **) &amp;aUrl);</span>
<a href="#l3.4632"></a><span id="l3.4632" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; aUrl)</span>
<a href="#l3.4633"></a><span id="l3.4633" class="difflineminus">-      aUrl-&gt;GetHost(returnSpec-&gt;mHostName);</span>
<a href="#l3.4634"></a><span id="l3.4634" class="difflineplus">+    returnSpec-&gt;mConnection-&gt;GetCurrentUrl()-&gt;QueryInterface(NS_GET_IID(nsIURI),</span>
<a href="#l3.4635"></a><span id="l3.4635" class="difflineplus">+                                                             (void **)&amp;aUrl);</span>
<a href="#l3.4636"></a><span id="l3.4636" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; aUrl) aUrl-&gt;GetHost(returnSpec-&gt;mHostName);</span>
<a href="#l3.4637"></a><span id="l3.4637"> </span>
<a href="#l3.4638"></a><span id="l3.4638">     NS_IF_RELEASE(aUrl);</span>
<a href="#l3.4639"></a><span id="l3.4639" class="difflineminus">-  }</span>
<a href="#l3.4640"></a><span id="l3.4640" class="difflineminus">-  else</span>
<a href="#l3.4641"></a><span id="l3.4641" class="difflineplus">+  } else</span>
<a href="#l3.4642"></a><span id="l3.4642">     returnSpec-&gt;mHostName.Truncate();</span>
<a href="#l3.4643"></a><span id="l3.4643"> </span>
<a href="#l3.4644"></a><span id="l3.4644">   if (fFlagState)</span>
<a href="#l3.4645"></a><span id="l3.4645" class="difflineminus">-    returnSpec-&gt;mFlagState = fFlagState; //copies flag state</span>
<a href="#l3.4646"></a><span id="l3.4646" class="difflineplus">+    returnSpec-&gt;mFlagState = fFlagState;  // copies flag state</span>
<a href="#l3.4647"></a><span id="l3.4647">   else</span>
<a href="#l3.4648"></a><span id="l3.4648">     returnSpec-&gt;mFlagState = nullptr;</span>
<a href="#l3.4649"></a><span id="l3.4649"> </span>
<a href="#l3.4650"></a><span id="l3.4650">   return returnSpec.forget();</span>
<a href="#l3.4651"></a><span id="l3.4651" class="difflineminus">-</span>
<a href="#l3.4652"></a><span id="l3.4652"> }</span>
<a href="#l3.4653"></a><span id="l3.4653"> // Reset the flag state.</span>
<a href="#l3.4654"></a><span id="l3.4654" class="difflineminus">-void nsImapServerResponseParser::ResetFlagInfo()</span>
<a href="#l3.4655"></a><span id="l3.4655" class="difflineminus">-{</span>
<a href="#l3.4656"></a><span id="l3.4656" class="difflineminus">-  if (fFlagState)</span>
<a href="#l3.4657"></a><span id="l3.4657" class="difflineminus">-    fFlagState-&gt;Reset();</span>
<a href="#l3.4658"></a><span id="l3.4658" class="difflineplus">+void nsImapServerResponseParser::ResetFlagInfo() {</span>
<a href="#l3.4659"></a><span id="l3.4659" class="difflineplus">+  if (fFlagState) fFlagState-&gt;Reset();</span>
<a href="#l3.4660"></a><span id="l3.4660"> }</span>
<a href="#l3.4661"></a><span id="l3.4661"> </span>
<a href="#l3.4662"></a><span id="l3.4662" class="difflineminus">-</span>
<a href="#l3.4663"></a><span id="l3.4663" class="difflineminus">-bool nsImapServerResponseParser::GetLastFetchChunkReceived()</span>
<a href="#l3.4664"></a><span id="l3.4664" class="difflineminus">-{</span>
<a href="#l3.4665"></a><span id="l3.4665" class="difflineplus">+bool nsImapServerResponseParser::GetLastFetchChunkReceived() {</span>
<a href="#l3.4666"></a><span id="l3.4666">   return fLastChunk;</span>
<a href="#l3.4667"></a><span id="l3.4667"> }</span>
<a href="#l3.4668"></a><span id="l3.4668"> </span>
<a href="#l3.4669"></a><span id="l3.4669" class="difflineminus">-void nsImapServerResponseParser::ClearLastFetchChunkReceived()</span>
<a href="#l3.4670"></a><span id="l3.4670" class="difflineminus">-{</span>
<a href="#l3.4671"></a><span id="l3.4671" class="difflineplus">+void nsImapServerResponseParser::ClearLastFetchChunkReceived() {</span>
<a href="#l3.4672"></a><span id="l3.4672">   fLastChunk = false;</span>
<a href="#l3.4673"></a><span id="l3.4673"> }</span>
<a href="#l3.4674"></a><span id="l3.4674"> </span>
<a href="#l3.4675"></a><span id="l3.4675" class="difflineminus">-void nsImapServerResponseParser::SetHostSessionList(nsIImapHostSessionList*</span>
<a href="#l3.4676"></a><span id="l3.4676" class="difflineminus">-                                               aHostSessionList)</span>
<a href="#l3.4677"></a><span id="l3.4677" class="difflineminus">-{</span>
<a href="#l3.4678"></a><span id="l3.4678" class="difflineminus">-    fHostSessionList = aHostSessionList;</span>
<a href="#l3.4679"></a><span id="l3.4679" class="difflineplus">+void nsImapServerResponseParser::SetHostSessionList(</span>
<a href="#l3.4680"></a><span id="l3.4680" class="difflineplus">+    nsIImapHostSessionList *aHostSessionList) {</span>
<a href="#l3.4681"></a><span id="l3.4681" class="difflineplus">+  fHostSessionList = aHostSessionList;</span>
<a href="#l3.4682"></a><span id="l3.4682"> }</span>
<a href="#l3.4683"></a><span id="l3.4683"> </span>
<a href="#l3.4684"></a><span id="l3.4684" class="difflineminus">-void nsImapServerResponseParser::SetSyntaxError(bool error, const char *msg)</span>
<a href="#l3.4685"></a><span id="l3.4685" class="difflineminus">-{</span>
<a href="#l3.4686"></a><span id="l3.4686" class="difflineplus">+void nsImapServerResponseParser::SetSyntaxError(bool error, const char *msg) {</span>
<a href="#l3.4687"></a><span id="l3.4687">   nsIMAPGenericParser::SetSyntaxError(error, msg);</span>
<a href="#l3.4688"></a><span id="l3.4688" class="difflineminus">-  if (error)</span>
<a href="#l3.4689"></a><span id="l3.4689" class="difflineminus">-  {</span>
<a href="#l3.4690"></a><span id="l3.4690" class="difflineminus">-    if (!fCurrentLine)</span>
<a href="#l3.4691"></a><span id="l3.4691" class="difflineminus">-    {</span>
<a href="#l3.4692"></a><span id="l3.4692" class="difflineplus">+  if (error) {</span>
<a href="#l3.4693"></a><span id="l3.4693" class="difflineplus">+    if (!fCurrentLine) {</span>
<a href="#l3.4694"></a><span id="l3.4694">       HandleMemoryFailure();</span>
<a href="#l3.4695"></a><span id="l3.4695" class="difflineminus">-      fServerConnection.Log(&quot;PARSER&quot;, (&quot;Internal Syntax Error: %s: &lt;no line&gt;&quot;), msg);</span>
<a href="#l3.4696"></a><span id="l3.4696" class="difflineminus">-    }</span>
<a href="#l3.4697"></a><span id="l3.4697" class="difflineminus">-    else</span>
<a href="#l3.4698"></a><span id="l3.4698" class="difflineminus">-    {</span>
<a href="#l3.4699"></a><span id="l3.4699" class="difflineplus">+      fServerConnection.Log(&quot;PARSER&quot;, (&quot;Internal Syntax Error: %s: &lt;no line&gt;&quot;),</span>
<a href="#l3.4700"></a><span id="l3.4700" class="difflineplus">+                            msg);</span>
<a href="#l3.4701"></a><span id="l3.4701" class="difflineplus">+    } else {</span>
<a href="#l3.4702"></a><span id="l3.4702">       if (!strcmp(fCurrentLine, CRLF))</span>
<a href="#l3.4703"></a><span id="l3.4703" class="difflineminus">-        fServerConnection.Log(&quot;PARSER&quot;, &quot;Internal Syntax Error: %s: &lt;CRLF&gt;&quot;, msg);</span>
<a href="#l3.4704"></a><span id="l3.4704" class="difflineminus">-      else</span>
<a href="#l3.4705"></a><span id="l3.4705" class="difflineminus">-      {</span>
<a href="#l3.4706"></a><span id="l3.4706" class="difflineplus">+        fServerConnection.Log(&quot;PARSER&quot;, &quot;Internal Syntax Error: %s: &lt;CRLF&gt;&quot;,</span>
<a href="#l3.4707"></a><span id="l3.4707" class="difflineplus">+                              msg);</span>
<a href="#l3.4708"></a><span id="l3.4708" class="difflineplus">+      else {</span>
<a href="#l3.4709"></a><span id="l3.4709">         if (msg)</span>
<a href="#l3.4710"></a><span id="l3.4710">           fServerConnection.Log(&quot;PARSER&quot;, &quot;Internal Syntax Error: %s:&quot;, msg);</span>
<a href="#l3.4711"></a><span id="l3.4711" class="difflineminus">-        fServerConnection.Log(&quot;PARSER&quot;, &quot;Internal Syntax Error on line: %s&quot;, fCurrentLine);</span>
<a href="#l3.4712"></a><span id="l3.4712" class="difflineplus">+        fServerConnection.Log(&quot;PARSER&quot;, &quot;Internal Syntax Error on line: %s&quot;,</span>
<a href="#l3.4713"></a><span id="l3.4713" class="difflineplus">+                              fCurrentLine);</span>
<a href="#l3.4714"></a><span id="l3.4714">       }</span>
<a href="#l3.4715"></a><span id="l3.4715">     }</span>
<a href="#l3.4716"></a><span id="l3.4716">   }</span>
<a href="#l3.4717"></a><span id="l3.4717"> }</span>
<a href="#l3.4718"></a><span id="l3.4718"> </span>
<a href="#l3.4719"></a><span id="l3.4719" class="difflineminus">-nsresult nsImapServerResponseParser::BeginMessageDownload(const char *content_type)</span>
<a href="#l3.4720"></a><span id="l3.4720" class="difflineminus">-{</span>
<a href="#l3.4721"></a><span id="l3.4721" class="difflineplus">+nsresult nsImapServerResponseParser::BeginMessageDownload(</span>
<a href="#l3.4722"></a><span id="l3.4722" class="difflineplus">+    const char *content_type) {</span>
<a href="#l3.4723"></a><span id="l3.4723">   nsresult rv = fServerConnection.BeginMessageDownLoad(fSizeOfMostRecentMessage,</span>
<a href="#l3.4724"></a><span id="l3.4724" class="difflineminus">-    content_type);</span>
<a href="#l3.4725"></a><span id="l3.4725" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l3.4726"></a><span id="l3.4726" class="difflineminus">-  {</span>
<a href="#l3.4727"></a><span id="l3.4727" class="difflineplus">+                                                       content_type);</span>
<a href="#l3.4728"></a><span id="l3.4728" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l3.4729"></a><span id="l3.4729">     skip_to_CRLF();</span>
<a href="#l3.4730"></a><span id="l3.4730">     fServerConnection.PseudoInterrupt(true);</span>
<a href="#l3.4731"></a><span id="l3.4731">     fServerConnection.AbortMessageDownLoad();</span>
<a href="#l3.4732"></a><span id="l3.4732">   }</span>
<a href="#l3.4733"></a><span id="l3.4733">   return rv;</span>
<a href="#l3.4734"></a><span id="l3.4734"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/imap/src/nsImapServerResponseParser.h</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapServerResponseParser.h</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -17,242 +17,256 @@</span>
<a href="#l4.4"></a><span id="l4.4"> </span>
<a href="#l4.5"></a><span id="l4.5"> class nsIMAPBodyShell;</span>
<a href="#l4.6"></a><span id="l4.6"> class nsIMAPBodypart;</span>
<a href="#l4.7"></a><span id="l4.7"> class nsImapSearchResultIterator;</span>
<a href="#l4.8"></a><span id="l4.8"> class nsIImapFlagAndUidState;</span>
<a href="#l4.9"></a><span id="l4.9"> </span>
<a href="#l4.10"></a><span id="l4.10"> #include &quot;nsIMAPGenericParser.h&quot;</span>
<a href="#l4.11"></a><span id="l4.11"> </span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-class nsImapServerResponseParser : public nsIMAPGenericParser</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-{</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineminus">-public:</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+class nsImapServerResponseParser : public nsIMAPGenericParser {</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineplus">+ public:</span>
<a href="#l4.17"></a><span id="l4.17">   explicit nsImapServerResponseParser(nsImapProtocol &amp;imapConnection);</span>
<a href="#l4.18"></a><span id="l4.18">   virtual ~nsImapServerResponseParser();</span>
<a href="#l4.19"></a><span id="l4.19"> </span>
<a href="#l4.20"></a><span id="l4.20">   // Overridden from the base parser class</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineminus">-  virtual bool       LastCommandSuccessful() override;</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineplus">+  virtual bool LastCommandSuccessful() override;</span>
<a href="#l4.23"></a><span id="l4.23">   virtual void HandleMemoryFailure() override;</span>
<a href="#l4.24"></a><span id="l4.24"> </span>
<a href="#l4.25"></a><span id="l4.25" class="difflineminus">-  // aignoreBadAndNOResponses --&gt; don't throw a error dialog if this command results in a NO or Bad response</span>
<a href="#l4.26"></a><span id="l4.26" class="difflineminus">-  // from the server..in other words the command is &quot;exploratory&quot; and we don't really care if it succeeds or fails.</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineminus">-  // This value is typically FALSE for almost all cases.</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineplus">+  // aignoreBadAndNOResponses --&gt; don't throw a error dialog if this command</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineplus">+  // results in a NO or Bad response from the server..in other words the command</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineplus">+  // is &quot;exploratory&quot; and we don't really care if it succeeds or fails. This</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineplus">+  // value is typically FALSE for almost all cases.</span>
<a href="#l4.32"></a><span id="l4.32">   virtual void ParseIMAPServerResponse(const char *aCurrentCommand,</span>
<a href="#l4.33"></a><span id="l4.33">                                        bool aIgnoreBadAndNOResponses,</span>
<a href="#l4.34"></a><span id="l4.34">                                        char *aGreetingWithCapability = NULL);</span>
<a href="#l4.35"></a><span id="l4.35">   virtual void InitializeState();</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineminus">-  bool    CommandFailed();</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineminus">-  void    SetCommandFailed(bool failed);</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineplus">+  bool CommandFailed();</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineplus">+  void SetCommandFailed(bool failed);</span>
<a href="#l4.40"></a><span id="l4.40"> </span>
<a href="#l4.41"></a><span id="l4.41" class="difflineminus">-    enum eIMAPstate {</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineminus">-        kNonAuthenticated,</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineminus">-        kAuthenticated,</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineminus">-        kFolderSelected</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineminus">-    } ;</span>
<a href="#l4.46"></a><span id="l4.46" class="difflineplus">+  enum eIMAPstate { kNonAuthenticated, kAuthenticated, kFolderSelected };</span>
<a href="#l4.47"></a><span id="l4.47"> </span>
<a href="#l4.48"></a><span id="l4.48">   virtual eIMAPstate GetIMAPstate();</span>
<a href="#l4.49"></a><span id="l4.49" class="difflineminus">-  virtual bool WaitingForMoreClientInput() { return fWaitingForMoreClientInput; }</span>
<a href="#l4.50"></a><span id="l4.50" class="difflineminus">-  const char *GetSelectedMailboxName();   // can be NULL</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineplus">+  virtual bool WaitingForMoreClientInput() {</span>
<a href="#l4.52"></a><span id="l4.52" class="difflineplus">+    return fWaitingForMoreClientInput;</span>
<a href="#l4.53"></a><span id="l4.53" class="difflineplus">+  }</span>
<a href="#l4.54"></a><span id="l4.54" class="difflineplus">+  const char *GetSelectedMailboxName();  // can be NULL</span>
<a href="#l4.55"></a><span id="l4.55">   bool IsStdJunkNotJunkUseOk() { return fStdJunkNotJunkUseOk; }</span>
<a href="#l4.56"></a><span id="l4.56"> </span>
<a href="#l4.57"></a><span id="l4.57" class="difflineminus">-  // if we get a PREAUTH greeting from the server, initialize the parser to begin in</span>
<a href="#l4.58"></a><span id="l4.58" class="difflineminus">-  // the kAuthenticated state</span>
<a href="#l4.59"></a><span id="l4.59" class="difflineplus">+  // if we get a PREAUTH greeting from the server, initialize the parser to</span>
<a href="#l4.60"></a><span id="l4.60" class="difflineplus">+  // begin in the kAuthenticated state</span>
<a href="#l4.61"></a><span id="l4.61">   void PreauthSetAuthenticatedState();</span>
<a href="#l4.62"></a><span id="l4.62"> </span>
<a href="#l4.63"></a><span id="l4.63">   // these functions represent the state of the currently selected</span>
<a href="#l4.64"></a><span id="l4.64">   // folder</span>
<a href="#l4.65"></a><span id="l4.65" class="difflineminus">-  bool       CurrentFolderReadOnly();</span>
<a href="#l4.66"></a><span id="l4.66" class="difflineminus">-  int32_t    NumberOfMessages();</span>
<a href="#l4.67"></a><span id="l4.67" class="difflineminus">-  int32_t    NumberOfRecentMessages();</span>
<a href="#l4.68"></a><span id="l4.68" class="difflineminus">-  int32_t    NumberOfUnseenMessages();</span>
<a href="#l4.69"></a><span id="l4.69" class="difflineminus">-  int32_t    FolderUID();</span>
<a href="#l4.70"></a><span id="l4.70" class="difflineminus">-  uint32_t   CurrentResponseUID();</span>
<a href="#l4.71"></a><span id="l4.71" class="difflineminus">-  uint32_t   HighestRecordedUID();</span>
<a href="#l4.72"></a><span id="l4.72" class="difflineminus">-  void       ResetHighestRecordedUID();</span>
<a href="#l4.73"></a><span id="l4.73" class="difflineminus">-  void       SetCurrentResponseUID(uint32_t uid);</span>
<a href="#l4.74"></a><span id="l4.74" class="difflineminus">-  bool       IsNumericString(const char *string);</span>
<a href="#l4.75"></a><span id="l4.75" class="difflineminus">-  uint32_t   SizeOfMostRecentMessage();</span>
<a href="#l4.76"></a><span id="l4.76" class="difflineminus">-  void       SetTotalDownloadSize(int32_t newSize) { fTotalDownloadSize = newSize; }</span>
<a href="#l4.77"></a><span id="l4.77" class="difflineplus">+  bool CurrentFolderReadOnly();</span>
<a href="#l4.78"></a><span id="l4.78" class="difflineplus">+  int32_t NumberOfMessages();</span>
<a href="#l4.79"></a><span id="l4.79" class="difflineplus">+  int32_t NumberOfRecentMessages();</span>
<a href="#l4.80"></a><span id="l4.80" class="difflineplus">+  int32_t NumberOfUnseenMessages();</span>
<a href="#l4.81"></a><span id="l4.81" class="difflineplus">+  int32_t FolderUID();</span>
<a href="#l4.82"></a><span id="l4.82" class="difflineplus">+  uint32_t CurrentResponseUID();</span>
<a href="#l4.83"></a><span id="l4.83" class="difflineplus">+  uint32_t HighestRecordedUID();</span>
<a href="#l4.84"></a><span id="l4.84" class="difflineplus">+  void ResetHighestRecordedUID();</span>
<a href="#l4.85"></a><span id="l4.85" class="difflineplus">+  void SetCurrentResponseUID(uint32_t uid);</span>
<a href="#l4.86"></a><span id="l4.86" class="difflineplus">+  bool IsNumericString(const char *string);</span>
<a href="#l4.87"></a><span id="l4.87" class="difflineplus">+  uint32_t SizeOfMostRecentMessage();</span>
<a href="#l4.88"></a><span id="l4.88" class="difflineplus">+  void SetTotalDownloadSize(int32_t newSize) { fTotalDownloadSize = newSize; }</span>
<a href="#l4.89"></a><span id="l4.89"> </span>
<a href="#l4.90"></a><span id="l4.90">   nsImapSearchResultIterator *CreateSearchResultIterator();</span>
<a href="#l4.91"></a><span id="l4.91" class="difflineminus">-  void ResetSearchResultSequence() {fSearchResults-&gt;ResetSequence();}</span>
<a href="#l4.92"></a><span id="l4.92" class="difflineplus">+  void ResetSearchResultSequence() { fSearchResults-&gt;ResetSequence(); }</span>
<a href="#l4.93"></a><span id="l4.93"> </span>
<a href="#l4.94"></a><span id="l4.94">   // create a struct mailbox_spec from our info, used in</span>
<a href="#l4.95"></a><span id="l4.95">   // libmsg c interface</span>
<a href="#l4.96"></a><span id="l4.96" class="difflineminus">-  already_AddRefed&lt;nsImapMailboxSpec&gt; CreateCurrentMailboxSpec(const char *mailboxName = nullptr);</span>
<a href="#l4.97"></a><span id="l4.97" class="difflineplus">+  already_AddRefed&lt;nsImapMailboxSpec&gt; CreateCurrentMailboxSpec(</span>
<a href="#l4.98"></a><span id="l4.98" class="difflineplus">+      const char *mailboxName = nullptr);</span>
<a href="#l4.99"></a><span id="l4.99"> </span>
<a href="#l4.100"></a><span id="l4.100">   // Resets the flags state.</span>
<a href="#l4.101"></a><span id="l4.101">   void ResetFlagInfo();</span>
<a href="#l4.102"></a><span id="l4.102"> </span>
<a href="#l4.103"></a><span id="l4.103">   // set this to false if you don't want to alert the user to server</span>
<a href="#l4.104"></a><span id="l4.104">   // error messages</span>
<a href="#l4.105"></a><span id="l4.105" class="difflineminus">-  void SetReportingErrors(bool reportThem) { fReportingErrors=reportThem;}</span>
<a href="#l4.106"></a><span id="l4.106" class="difflineplus">+  void SetReportingErrors(bool reportThem) { fReportingErrors = reportThem; }</span>
<a href="#l4.107"></a><span id="l4.107">   bool GetReportingErrors() { return fReportingErrors; }</span>
<a href="#l4.108"></a><span id="l4.108"> </span>
<a href="#l4.109"></a><span id="l4.109">   eIMAPCapabilityFlags GetCapabilityFlag() { return fCapabilityFlag; }</span>
<a href="#l4.110"></a><span id="l4.110" class="difflineminus">-  void   SetCapabilityFlag(eIMAPCapabilityFlags capability) {fCapabilityFlag = capability;}</span>
<a href="#l4.111"></a><span id="l4.111" class="difflineminus">-  bool ServerHasIMAP4Rev1Capability() { return ((fCapabilityFlag &amp; kIMAP4rev1Capability) != 0); }</span>
<a href="#l4.112"></a><span id="l4.112" class="difflineminus">-  bool ServerHasACLCapability() { return ((fCapabilityFlag &amp; kACLCapability) != 0); }</span>
<a href="#l4.113"></a><span id="l4.113" class="difflineminus">-  bool ServerHasNamespaceCapability() { return ((fCapabilityFlag &amp; kNamespaceCapability) != 0); }</span>
<a href="#l4.114"></a><span id="l4.114" class="difflineplus">+  void SetCapabilityFlag(eIMAPCapabilityFlags capability) {</span>
<a href="#l4.115"></a><span id="l4.115" class="difflineplus">+    fCapabilityFlag = capability;</span>
<a href="#l4.116"></a><span id="l4.116" class="difflineplus">+  }</span>
<a href="#l4.117"></a><span id="l4.117" class="difflineplus">+  bool ServerHasIMAP4Rev1Capability() {</span>
<a href="#l4.118"></a><span id="l4.118" class="difflineplus">+    return ((fCapabilityFlag &amp; kIMAP4rev1Capability) != 0);</span>
<a href="#l4.119"></a><span id="l4.119" class="difflineplus">+  }</span>
<a href="#l4.120"></a><span id="l4.120" class="difflineplus">+  bool ServerHasACLCapability() {</span>
<a href="#l4.121"></a><span id="l4.121" class="difflineplus">+    return ((fCapabilityFlag &amp; kACLCapability) != 0);</span>
<a href="#l4.122"></a><span id="l4.122" class="difflineplus">+  }</span>
<a href="#l4.123"></a><span id="l4.123" class="difflineplus">+  bool ServerHasNamespaceCapability() {</span>
<a href="#l4.124"></a><span id="l4.124" class="difflineplus">+    return ((fCapabilityFlag &amp; kNamespaceCapability) != 0);</span>
<a href="#l4.125"></a><span id="l4.125" class="difflineplus">+  }</span>
<a href="#l4.126"></a><span id="l4.126">   bool ServerIsNetscape3xServer() { return fServerIsNetscape3xServer; }</span>
<a href="#l4.127"></a><span id="l4.127" class="difflineminus">-  bool ServerHasServerInfo() {return ((fCapabilityFlag &amp; kXServerInfoCapability) != 0); }</span>
<a href="#l4.128"></a><span id="l4.128" class="difflineminus">-  bool ServerIsAOLServer() {return ((fCapabilityFlag &amp; kAOLImapCapability) != 0); }</span>
<a href="#l4.129"></a><span id="l4.129" class="difflineminus">-  void SetFetchingFlags(bool aFetchFlags) { fFetchingAllFlags = aFetchFlags;}</span>
<a href="#l4.130"></a><span id="l4.130" class="difflineminus">-  void ResetCapabilityFlag() ;</span>
<a href="#l4.131"></a><span id="l4.131" class="difflineplus">+  bool ServerHasServerInfo() {</span>
<a href="#l4.132"></a><span id="l4.132" class="difflineplus">+    return ((fCapabilityFlag &amp; kXServerInfoCapability) != 0);</span>
<a href="#l4.133"></a><span id="l4.133" class="difflineplus">+  }</span>
<a href="#l4.134"></a><span id="l4.134" class="difflineplus">+  bool ServerIsAOLServer() {</span>
<a href="#l4.135"></a><span id="l4.135" class="difflineplus">+    return ((fCapabilityFlag &amp; kAOLImapCapability) != 0);</span>
<a href="#l4.136"></a><span id="l4.136" class="difflineplus">+  }</span>
<a href="#l4.137"></a><span id="l4.137" class="difflineplus">+  void SetFetchingFlags(bool aFetchFlags) { fFetchingAllFlags = aFetchFlags; }</span>
<a href="#l4.138"></a><span id="l4.138" class="difflineplus">+  void ResetCapabilityFlag();</span>
<a href="#l4.139"></a><span id="l4.139"> </span>
<a href="#l4.140"></a><span id="l4.140" class="difflineminus">-  nsCString&amp; GetMailAccountUrl() { return fMailAccountUrl; }</span>
<a href="#l4.141"></a><span id="l4.141" class="difflineplus">+  nsCString &amp;GetMailAccountUrl() { return fMailAccountUrl; }</span>
<a href="#l4.142"></a><span id="l4.142">   const char *GetXSenderInfo() { return fXSenderInfo; }</span>
<a href="#l4.143"></a><span id="l4.143">   void FreeXSenderInfo() { PR_FREEIF(fXSenderInfo); }</span>
<a href="#l4.144"></a><span id="l4.144" class="difflineminus">-  nsCString&amp; GetManageListsUrl() { return fManageListsUrl; }</span>
<a href="#l4.145"></a><span id="l4.145" class="difflineminus">-  nsCString&amp; GetManageFiltersUrl() {return fManageFiltersUrl;}</span>
<a href="#l4.146"></a><span id="l4.146" class="difflineminus">-  const char *GetManageFolderUrl() {return fFolderAdminUrl;}</span>
<a href="#l4.147"></a><span id="l4.147" class="difflineminus">-  nsCString &amp;GetServerID() {return fServerIdResponse;}</span>
<a href="#l4.148"></a><span id="l4.148" class="difflineplus">+  nsCString &amp;GetManageListsUrl() { return fManageListsUrl; }</span>
<a href="#l4.149"></a><span id="l4.149" class="difflineplus">+  nsCString &amp;GetManageFiltersUrl() { return fManageFiltersUrl; }</span>
<a href="#l4.150"></a><span id="l4.150" class="difflineplus">+  const char *GetManageFolderUrl() { return fFolderAdminUrl; }</span>
<a href="#l4.151"></a><span id="l4.151" class="difflineplus">+  nsCString &amp;GetServerID() { return fServerIdResponse; }</span>
<a href="#l4.152"></a><span id="l4.152"> </span>
<a href="#l4.153"></a><span id="l4.153">   // Call this when adding a pipelined command to the session</span>
<a href="#l4.154"></a><span id="l4.154">   void IncrementNumberOfTaggedResponsesExpected(const char *newExpectedTag);</span>
<a href="#l4.155"></a><span id="l4.155"> </span>
<a href="#l4.156"></a><span id="l4.156">   // Interrupt a Fetch, without really Interrupting (through netlib)</span>
<a href="#l4.157"></a><span id="l4.157">   bool GetLastFetchChunkReceived();</span>
<a href="#l4.158"></a><span id="l4.158">   void ClearLastFetchChunkReceived();</span>
<a href="#l4.159"></a><span id="l4.159">   virtual uint16_t SupportsUserFlags() { return fSupportsUserDefinedFlags; }</span>
<a href="#l4.160"></a><span id="l4.160" class="difflineminus">-  virtual uint16_t  SettablePermanentFlags() { return fSettablePermanentFlags;}</span>
<a href="#l4.161"></a><span id="l4.161" class="difflineplus">+  virtual uint16_t SettablePermanentFlags() { return fSettablePermanentFlags; }</span>
<a href="#l4.162"></a><span id="l4.162">   void SetFlagState(nsIImapFlagAndUidState *state);</span>
<a href="#l4.163"></a><span id="l4.163">   bool GetDownloadingHeaders();</span>
<a href="#l4.164"></a><span id="l4.164">   bool GetFillingInShell();</span>
<a href="#l4.165"></a><span id="l4.165">   void UseCachedShell(nsIMAPBodyShell *cachedShell);</span>
<a href="#l4.166"></a><span id="l4.166">   void SetHostSessionList(nsIImapHostSessionList *aHostSession);</span>
<a href="#l4.167"></a><span id="l4.167" class="difflineminus">-  char  *fAuthChallenge;    // the challenge returned by the server in</span>
<a href="#l4.168"></a><span id="l4.168" class="difflineminus">-                            //response to authenticate using CRAM-MD5 or NTLM</span>
<a href="#l4.169"></a><span id="l4.169" class="difflineminus">-  bool            fCondStoreEnabled;</span>
<a href="#l4.170"></a><span id="l4.170" class="difflineminus">-  bool            fUseModSeq;  // can use mod seq for currently selected folder</span>
<a href="#l4.171"></a><span id="l4.171" class="difflineminus">-  uint64_t        fHighestModSeq;</span>
<a href="#l4.172"></a><span id="l4.172" class="difflineplus">+  char *fAuthChallenge;  // the challenge returned by the server in</span>
<a href="#l4.173"></a><span id="l4.173" class="difflineplus">+                         // response to authenticate using CRAM-MD5 or NTLM</span>
<a href="#l4.174"></a><span id="l4.174" class="difflineplus">+  bool fCondStoreEnabled;</span>
<a href="#l4.175"></a><span id="l4.175" class="difflineplus">+  bool fUseModSeq;  // can use mod seq for currently selected folder</span>
<a href="#l4.176"></a><span id="l4.176" class="difflineplus">+  uint64_t fHighestModSeq;</span>
<a href="#l4.177"></a><span id="l4.177"> </span>
<a href="#l4.178"></a><span id="l4.178" class="difflineminus">-protected:</span>
<a href="#l4.179"></a><span id="l4.179" class="difflineminus">-  virtual void    flags();</span>
<a href="#l4.180"></a><span id="l4.180" class="difflineminus">-  virtual void    envelope_data();</span>
<a href="#l4.181"></a><span id="l4.181" class="difflineminus">-  virtual void    xaolenvelope_data();</span>
<a href="#l4.182"></a><span id="l4.182" class="difflineminus">-  virtual void    parse_address(nsAutoCString &amp;addressLine);</span>
<a href="#l4.183"></a><span id="l4.183" class="difflineminus">-  virtual void    internal_date();</span>
<a href="#l4.184"></a><span id="l4.184" class="difflineplus">+ protected:</span>
<a href="#l4.185"></a><span id="l4.185" class="difflineplus">+  virtual void flags();</span>
<a href="#l4.186"></a><span id="l4.186" class="difflineplus">+  virtual void envelope_data();</span>
<a href="#l4.187"></a><span id="l4.187" class="difflineplus">+  virtual void xaolenvelope_data();</span>
<a href="#l4.188"></a><span id="l4.188" class="difflineplus">+  virtual void parse_address(nsAutoCString &amp;addressLine);</span>
<a href="#l4.189"></a><span id="l4.189" class="difflineplus">+  virtual void internal_date();</span>
<a href="#l4.190"></a><span id="l4.190">   virtual nsresult BeginMessageDownload(const char *content_type);</span>
<a href="#l4.191"></a><span id="l4.191"> </span>
<a href="#l4.192"></a><span id="l4.192" class="difflineminus">-  virtual void    response_data();</span>
<a href="#l4.193"></a><span id="l4.193" class="difflineminus">-  virtual void    resp_text();</span>
<a href="#l4.194"></a><span id="l4.194" class="difflineminus">-  virtual void    resp_cond_state(bool isTagged);</span>
<a href="#l4.195"></a><span id="l4.195" class="difflineminus">-  virtual void    text_mime2();</span>
<a href="#l4.196"></a><span id="l4.196" class="difflineminus">-  virtual void    text();</span>
<a href="#l4.197"></a><span id="l4.197" class="difflineminus">-  virtual void    parse_folder_flags(bool calledForFlags);</span>
<a href="#l4.198"></a><span id="l4.198" class="difflineminus">-  virtual void    enable_data();</span>
<a href="#l4.199"></a><span id="l4.199" class="difflineminus">-  virtual void    language_data();</span>
<a href="#l4.200"></a><span id="l4.200" class="difflineminus">-  virtual void    authChallengeResponse_data();</span>
<a href="#l4.201"></a><span id="l4.201" class="difflineminus">-  virtual void    resp_text_code();</span>
<a href="#l4.202"></a><span id="l4.202" class="difflineminus">-  virtual void    response_done();</span>
<a href="#l4.203"></a><span id="l4.203" class="difflineminus">-  virtual void    response_tagged();</span>
<a href="#l4.204"></a><span id="l4.204" class="difflineminus">-  virtual void    response_fatal();</span>
<a href="#l4.205"></a><span id="l4.205" class="difflineminus">-  virtual void    resp_cond_bye();</span>
<a href="#l4.206"></a><span id="l4.206" class="difflineminus">-  virtual void    id_data();</span>
<a href="#l4.207"></a><span id="l4.207" class="difflineminus">-  virtual void    mailbox_data();</span>
<a href="#l4.208"></a><span id="l4.208" class="difflineminus">-  virtual void    numeric_mailbox_data();</span>
<a href="#l4.209"></a><span id="l4.209" class="difflineminus">-  virtual void    capability_data();</span>
<a href="#l4.210"></a><span id="l4.210" class="difflineminus">-  virtual void    xserverinfo_data();</span>
<a href="#l4.211"></a><span id="l4.211" class="difflineminus">-  virtual void    xmailboxinfo_data();</span>
<a href="#l4.212"></a><span id="l4.212" class="difflineminus">-  virtual void    namespace_data();</span>
<a href="#l4.213"></a><span id="l4.213" class="difflineminus">-  virtual void    myrights_data(bool unsolicited);</span>
<a href="#l4.214"></a><span id="l4.214" class="difflineminus">-  virtual void    acl_data();</span>
<a href="#l4.215"></a><span id="l4.215" class="difflineminus">-  virtual void    bodystructure_data();</span>
<a href="#l4.216"></a><span id="l4.216" class="difflineminus">-  nsIMAPBodypart  *bodystructure_part(char *partNum, nsIMAPBodypart *parentPart);</span>
<a href="#l4.217"></a><span id="l4.217" class="difflineminus">-  nsIMAPBodypart  *bodystructure_leaf(char *partNum, nsIMAPBodypart *parentPart);</span>
<a href="#l4.218"></a><span id="l4.218" class="difflineminus">-  nsIMAPBodypart  *bodystructure_multipart(char *partNum, nsIMAPBodypart *parentPart);</span>
<a href="#l4.219"></a><span id="l4.219" class="difflineminus">-  virtual void    mime_data();</span>
<a href="#l4.220"></a><span id="l4.220" class="difflineminus">-  virtual void    mime_part_data();</span>
<a href="#l4.221"></a><span id="l4.221" class="difflineminus">-  virtual void    mime_header_data();</span>
<a href="#l4.222"></a><span id="l4.222" class="difflineminus">-  virtual void    quota_data();</span>
<a href="#l4.223"></a><span id="l4.223" class="difflineminus">-  virtual void    msg_fetch();</span>
<a href="#l4.224"></a><span id="l4.224" class="difflineminus">-  virtual void    msg_obsolete();</span>
<a href="#l4.225"></a><span id="l4.225" class="difflineminus">-  virtual void    msg_fetch_headers(const char *partNum);</span>
<a href="#l4.226"></a><span id="l4.226" class="difflineminus">-  virtual void    msg_fetch_content(bool chunk, int32_t origin, const char *content_type);</span>
<a href="#l4.227"></a><span id="l4.227" class="difflineminus">-  virtual bool    msg_fetch_quoted();</span>
<a href="#l4.228"></a><span id="l4.228" class="difflineminus">-  virtual bool    msg_fetch_literal(bool chunk, int32_t origin);</span>
<a href="#l4.229"></a><span id="l4.229" class="difflineminus">-  virtual void    mailbox_list(bool discoveredFromLsub);</span>
<a href="#l4.230"></a><span id="l4.230" class="difflineminus">-  virtual void    mailbox(nsImapMailboxSpec *boxSpec);</span>
<a href="#l4.231"></a><span id="l4.231" class="difflineplus">+  virtual void response_data();</span>
<a href="#l4.232"></a><span id="l4.232" class="difflineplus">+  virtual void resp_text();</span>
<a href="#l4.233"></a><span id="l4.233" class="difflineplus">+  virtual void resp_cond_state(bool isTagged);</span>
<a href="#l4.234"></a><span id="l4.234" class="difflineplus">+  virtual void text_mime2();</span>
<a href="#l4.235"></a><span id="l4.235" class="difflineplus">+  virtual void text();</span>
<a href="#l4.236"></a><span id="l4.236" class="difflineplus">+  virtual void parse_folder_flags(bool calledForFlags);</span>
<a href="#l4.237"></a><span id="l4.237" class="difflineplus">+  virtual void enable_data();</span>
<a href="#l4.238"></a><span id="l4.238" class="difflineplus">+  virtual void language_data();</span>
<a href="#l4.239"></a><span id="l4.239" class="difflineplus">+  virtual void authChallengeResponse_data();</span>
<a href="#l4.240"></a><span id="l4.240" class="difflineplus">+  virtual void resp_text_code();</span>
<a href="#l4.241"></a><span id="l4.241" class="difflineplus">+  virtual void response_done();</span>
<a href="#l4.242"></a><span id="l4.242" class="difflineplus">+  virtual void response_tagged();</span>
<a href="#l4.243"></a><span id="l4.243" class="difflineplus">+  virtual void response_fatal();</span>
<a href="#l4.244"></a><span id="l4.244" class="difflineplus">+  virtual void resp_cond_bye();</span>
<a href="#l4.245"></a><span id="l4.245" class="difflineplus">+  virtual void id_data();</span>
<a href="#l4.246"></a><span id="l4.246" class="difflineplus">+  virtual void mailbox_data();</span>
<a href="#l4.247"></a><span id="l4.247" class="difflineplus">+  virtual void numeric_mailbox_data();</span>
<a href="#l4.248"></a><span id="l4.248" class="difflineplus">+  virtual void capability_data();</span>
<a href="#l4.249"></a><span id="l4.249" class="difflineplus">+  virtual void xserverinfo_data();</span>
<a href="#l4.250"></a><span id="l4.250" class="difflineplus">+  virtual void xmailboxinfo_data();</span>
<a href="#l4.251"></a><span id="l4.251" class="difflineplus">+  virtual void namespace_data();</span>
<a href="#l4.252"></a><span id="l4.252" class="difflineplus">+  virtual void myrights_data(bool unsolicited);</span>
<a href="#l4.253"></a><span id="l4.253" class="difflineplus">+  virtual void acl_data();</span>
<a href="#l4.254"></a><span id="l4.254" class="difflineplus">+  virtual void bodystructure_data();</span>
<a href="#l4.255"></a><span id="l4.255" class="difflineplus">+  nsIMAPBodypart *bodystructure_part(char *partNum, nsIMAPBodypart *parentPart);</span>
<a href="#l4.256"></a><span id="l4.256" class="difflineplus">+  nsIMAPBodypart *bodystructure_leaf(char *partNum, nsIMAPBodypart *parentPart);</span>
<a href="#l4.257"></a><span id="l4.257" class="difflineplus">+  nsIMAPBodypart *bodystructure_multipart(char *partNum,</span>
<a href="#l4.258"></a><span id="l4.258" class="difflineplus">+                                          nsIMAPBodypart *parentPart);</span>
<a href="#l4.259"></a><span id="l4.259" class="difflineplus">+  virtual void mime_data();</span>
<a href="#l4.260"></a><span id="l4.260" class="difflineplus">+  virtual void mime_part_data();</span>
<a href="#l4.261"></a><span id="l4.261" class="difflineplus">+  virtual void mime_header_data();</span>
<a href="#l4.262"></a><span id="l4.262" class="difflineplus">+  virtual void quota_data();</span>
<a href="#l4.263"></a><span id="l4.263" class="difflineplus">+  virtual void msg_fetch();</span>
<a href="#l4.264"></a><span id="l4.264" class="difflineplus">+  virtual void msg_obsolete();</span>
<a href="#l4.265"></a><span id="l4.265" class="difflineplus">+  virtual void msg_fetch_headers(const char *partNum);</span>
<a href="#l4.266"></a><span id="l4.266" class="difflineplus">+  virtual void msg_fetch_content(bool chunk, int32_t origin,</span>
<a href="#l4.267"></a><span id="l4.267" class="difflineplus">+                                 const char *content_type);</span>
<a href="#l4.268"></a><span id="l4.268" class="difflineplus">+  virtual bool msg_fetch_quoted();</span>
<a href="#l4.269"></a><span id="l4.269" class="difflineplus">+  virtual bool msg_fetch_literal(bool chunk, int32_t origin);</span>
<a href="#l4.270"></a><span id="l4.270" class="difflineplus">+  virtual void mailbox_list(bool discoveredFromLsub);</span>
<a href="#l4.271"></a><span id="l4.271" class="difflineplus">+  virtual void mailbox(nsImapMailboxSpec *boxSpec);</span>
<a href="#l4.272"></a><span id="l4.272"> </span>
<a href="#l4.273"></a><span id="l4.273" class="difflineminus">-  virtual void    ProcessOkCommand(const char *commandToken);</span>
<a href="#l4.274"></a><span id="l4.274" class="difflineminus">-  virtual void    ProcessBadCommand(const char *commandToken);</span>
<a href="#l4.275"></a><span id="l4.275" class="difflineminus">-  virtual void    PreProcessCommandToken(const char *commandToken,</span>
<a href="#l4.276"></a><span id="l4.276" class="difflineminus">-                                             const char *currentCommand);</span>
<a href="#l4.277"></a><span id="l4.277" class="difflineminus">-  virtual void    PostProcessEndOfLine();</span>
<a href="#l4.278"></a><span id="l4.278" class="difflineplus">+  virtual void ProcessOkCommand(const char *commandToken);</span>
<a href="#l4.279"></a><span id="l4.279" class="difflineplus">+  virtual void ProcessBadCommand(const char *commandToken);</span>
<a href="#l4.280"></a><span id="l4.280" class="difflineplus">+  virtual void PreProcessCommandToken(const char *commandToken,</span>
<a href="#l4.281"></a><span id="l4.281" class="difflineplus">+                                      const char *currentCommand);</span>
<a href="#l4.282"></a><span id="l4.282" class="difflineplus">+  virtual void PostProcessEndOfLine();</span>
<a href="#l4.283"></a><span id="l4.283"> </span>
<a href="#l4.284"></a><span id="l4.284">   // Overridden from the nsIMAPGenericParser, to retrieve the next line</span>
<a href="#l4.285"></a><span id="l4.285">   // from the open socket.</span>
<a href="#l4.286"></a><span id="l4.286" class="difflineminus">-  virtual bool    GetNextLineForParser(char **nextLine) override;</span>
<a href="#l4.287"></a><span id="l4.287" class="difflineplus">+  virtual bool GetNextLineForParser(char **nextLine) override;</span>
<a href="#l4.288"></a><span id="l4.288">   // overridden to do logging</span>
<a href="#l4.289"></a><span id="l4.289" class="difflineminus">-  virtual void    SetSyntaxError(bool error, const char *msg = nullptr) override;</span>
<a href="#l4.290"></a><span id="l4.290" class="difflineplus">+  virtual void SetSyntaxError(bool error, const char *msg = nullptr) override;</span>
<a href="#l4.291"></a><span id="l4.291"> </span>
<a href="#l4.292"></a><span id="l4.292" class="difflineminus">-private:</span>
<a href="#l4.293"></a><span id="l4.293" class="difflineminus">-  bool            fCurrentCommandFailed;</span>
<a href="#l4.294"></a><span id="l4.294" class="difflineminus">-  bool            fReportingErrors;</span>
<a href="#l4.295"></a><span id="l4.295" class="difflineminus">-</span>
<a href="#l4.296"></a><span id="l4.296" class="difflineplus">+ private:</span>
<a href="#l4.297"></a><span id="l4.297" class="difflineplus">+  bool fCurrentCommandFailed;</span>
<a href="#l4.298"></a><span id="l4.298" class="difflineplus">+  bool fReportingErrors;</span>
<a href="#l4.299"></a><span id="l4.299"> </span>
<a href="#l4.300"></a><span id="l4.300" class="difflineminus">-  bool            fCurrentFolderReadOnly;</span>
<a href="#l4.301"></a><span id="l4.301" class="difflineminus">-  bool            fCurrentLineContainedFlagInfo;</span>
<a href="#l4.302"></a><span id="l4.302" class="difflineminus">-  bool            fFetchingAllFlags;</span>
<a href="#l4.303"></a><span id="l4.303" class="difflineminus">-  bool            fWaitingForMoreClientInput;</span>
<a href="#l4.304"></a><span id="l4.304" class="difflineplus">+  bool fCurrentFolderReadOnly;</span>
<a href="#l4.305"></a><span id="l4.305" class="difflineplus">+  bool fCurrentLineContainedFlagInfo;</span>
<a href="#l4.306"></a><span id="l4.306" class="difflineplus">+  bool fFetchingAllFlags;</span>
<a href="#l4.307"></a><span id="l4.307" class="difflineplus">+  bool fWaitingForMoreClientInput;</span>
<a href="#l4.308"></a><span id="l4.308">   // Is the server a Netscape 3.x Messaging Server?</span>
<a href="#l4.309"></a><span id="l4.309" class="difflineminus">-  bool            fServerIsNetscape3xServer;</span>
<a href="#l4.310"></a><span id="l4.310" class="difflineminus">-  bool            fDownloadingHeaders;</span>
<a href="#l4.311"></a><span id="l4.311" class="difflineminus">-  bool            fCurrentCommandIsSingleMessageFetch;</span>
<a href="#l4.312"></a><span id="l4.312" class="difflineminus">-  bool            fGotPermanentFlags;</span>
<a href="#l4.313"></a><span id="l4.313" class="difflineminus">-  bool            fStdJunkNotJunkUseOk;</span>
<a href="#l4.314"></a><span id="l4.314" class="difflineminus">-  imapMessageFlagsType   fSavedFlagInfo;</span>
<a href="#l4.315"></a><span id="l4.315" class="difflineplus">+  bool fServerIsNetscape3xServer;</span>
<a href="#l4.316"></a><span id="l4.316" class="difflineplus">+  bool fDownloadingHeaders;</span>
<a href="#l4.317"></a><span id="l4.317" class="difflineplus">+  bool fCurrentCommandIsSingleMessageFetch;</span>
<a href="#l4.318"></a><span id="l4.318" class="difflineplus">+  bool fGotPermanentFlags;</span>
<a href="#l4.319"></a><span id="l4.319" class="difflineplus">+  bool fStdJunkNotJunkUseOk;</span>
<a href="#l4.320"></a><span id="l4.320" class="difflineplus">+  imapMessageFlagsType fSavedFlagInfo;</span>
<a href="#l4.321"></a><span id="l4.321">   nsTArray&lt;nsCString&gt; fCustomFlags;</span>
<a href="#l4.322"></a><span id="l4.322"> </span>
<a href="#l4.323"></a><span id="l4.323" class="difflineminus">-  uint16_t  fSupportsUserDefinedFlags;</span>
<a href="#l4.324"></a><span id="l4.324" class="difflineminus">-  uint16_t  fSettablePermanentFlags;</span>
<a href="#l4.325"></a><span id="l4.325" class="difflineplus">+  uint16_t fSupportsUserDefinedFlags;</span>
<a href="#l4.326"></a><span id="l4.326" class="difflineplus">+  uint16_t fSettablePermanentFlags;</span>
<a href="#l4.327"></a><span id="l4.327"> </span>
<a href="#l4.328"></a><span id="l4.328" class="difflineminus">-  int32_t           fFolderUIDValidity;</span>
<a href="#l4.329"></a><span id="l4.329" class="difflineminus">-  int32_t           fNumberOfUnseenMessages;</span>
<a href="#l4.330"></a><span id="l4.330" class="difflineminus">-  int32_t           fNumberOfExistingMessages;</span>
<a href="#l4.331"></a><span id="l4.331" class="difflineminus">-  int32_t           fNumberOfRecentMessages;</span>
<a href="#l4.332"></a><span id="l4.332" class="difflineminus">-  uint32_t          fCurrentResponseUID;</span>
<a href="#l4.333"></a><span id="l4.333" class="difflineminus">-  uint32_t          fHighestRecordedUID;</span>
<a href="#l4.334"></a><span id="l4.334" class="difflineplus">+  int32_t fFolderUIDValidity;</span>
<a href="#l4.335"></a><span id="l4.335" class="difflineplus">+  int32_t fNumberOfUnseenMessages;</span>
<a href="#l4.336"></a><span id="l4.336" class="difflineplus">+  int32_t fNumberOfExistingMessages;</span>
<a href="#l4.337"></a><span id="l4.337" class="difflineplus">+  int32_t fNumberOfRecentMessages;</span>
<a href="#l4.338"></a><span id="l4.338" class="difflineplus">+  uint32_t fCurrentResponseUID;</span>
<a href="#l4.339"></a><span id="l4.339" class="difflineplus">+  uint32_t fHighestRecordedUID;</span>
<a href="#l4.340"></a><span id="l4.340">   // used to handle server that sends msg size after headers</span>
<a href="#l4.341"></a><span id="l4.341" class="difflineminus">-  uint32_t          fReceivedHeaderOrSizeForUID;</span>
<a href="#l4.342"></a><span id="l4.342" class="difflineminus">-  int32_t           fSizeOfMostRecentMessage;</span>
<a href="#l4.343"></a><span id="l4.343" class="difflineminus">-  int32_t           fTotalDownloadSize;</span>
<a href="#l4.344"></a><span id="l4.344" class="difflineplus">+  uint32_t fReceivedHeaderOrSizeForUID;</span>
<a href="#l4.345"></a><span id="l4.345" class="difflineplus">+  int32_t fSizeOfMostRecentMessage;</span>
<a href="#l4.346"></a><span id="l4.346" class="difflineplus">+  int32_t fTotalDownloadSize;</span>
<a href="#l4.347"></a><span id="l4.347"> </span>
<a href="#l4.348"></a><span id="l4.348" class="difflineminus">-  int32_t           fStatusUnseenMessages;</span>
<a href="#l4.349"></a><span id="l4.349" class="difflineminus">-  int32_t           fStatusRecentMessages;</span>
<a href="#l4.350"></a><span id="l4.350" class="difflineminus">-  uint32_t          fStatusNextUID;</span>
<a href="#l4.351"></a><span id="l4.351" class="difflineminus">-  uint32_t          fStatusExistingMessages;</span>
<a href="#l4.352"></a><span id="l4.352" class="difflineplus">+  int32_t fStatusUnseenMessages;</span>
<a href="#l4.353"></a><span id="l4.353" class="difflineplus">+  int32_t fStatusRecentMessages;</span>
<a href="#l4.354"></a><span id="l4.354" class="difflineplus">+  uint32_t fStatusNextUID;</span>
<a href="#l4.355"></a><span id="l4.355" class="difflineplus">+  uint32_t fStatusExistingMessages;</span>
<a href="#l4.356"></a><span id="l4.356"> </span>
<a href="#l4.357"></a><span id="l4.357" class="difflineminus">-  int               fNumberOfTaggedResponsesExpected;</span>
<a href="#l4.358"></a><span id="l4.358" class="difflineplus">+  int fNumberOfTaggedResponsesExpected;</span>
<a href="#l4.359"></a><span id="l4.359"> </span>
<a href="#l4.360"></a><span id="l4.360" class="difflineminus">-  char              *fCurrentCommandTag;</span>
<a href="#l4.361"></a><span id="l4.361" class="difflineplus">+  char *fCurrentCommandTag;</span>
<a href="#l4.362"></a><span id="l4.362"> </span>
<a href="#l4.363"></a><span id="l4.363" class="difflineminus">-  nsCString         fZeroLengthMessageUidString;</span>
<a href="#l4.364"></a><span id="l4.364" class="difflineplus">+  nsCString fZeroLengthMessageUidString;</span>
<a href="#l4.365"></a><span id="l4.365"> </span>
<a href="#l4.366"></a><span id="l4.366" class="difflineminus">-  char              *fSelectedMailboxName;</span>
<a href="#l4.367"></a><span id="l4.367" class="difflineplus">+  char *fSelectedMailboxName;</span>
<a href="#l4.368"></a><span id="l4.368"> </span>
<a href="#l4.369"></a><span id="l4.369" class="difflineminus">-  nsImapSearchResultSequence    *fSearchResults;</span>
<a href="#l4.370"></a><span id="l4.370" class="difflineplus">+  nsImapSearchResultSequence *fSearchResults;</span>
<a href="#l4.371"></a><span id="l4.371"> </span>
<a href="#l4.372"></a><span id="l4.372" class="difflineminus">-  nsCOMPtr &lt;nsIImapFlagAndUidState&gt; fFlagState;  // NOT owned by us, it's a copy, do not destroy</span>
<a href="#l4.373"></a><span id="l4.373" class="difflineplus">+  nsCOMPtr&lt;nsIImapFlagAndUidState&gt;</span>
<a href="#l4.374"></a><span id="l4.374" class="difflineplus">+      fFlagState;  // NOT owned by us, it's a copy, do not destroy</span>
<a href="#l4.375"></a><span id="l4.375"> </span>
<a href="#l4.376"></a><span id="l4.376" class="difflineminus">-  eIMAPstate               fIMAPstate;</span>
<a href="#l4.377"></a><span id="l4.377" class="difflineplus">+  eIMAPstate fIMAPstate;</span>
<a href="#l4.378"></a><span id="l4.378"> </span>
<a href="#l4.379"></a><span id="l4.379" class="difflineminus">-  eIMAPCapabilityFlags      fCapabilityFlag;</span>
<a href="#l4.380"></a><span id="l4.380" class="difflineminus">-  nsCString     fMailAccountUrl;</span>
<a href="#l4.381"></a><span id="l4.381" class="difflineminus">-  char          *fNetscapeServerVersionString;</span>
<a href="#l4.382"></a><span id="l4.382" class="difflineminus">-  char          *fXSenderInfo; /* changed per message download */</span>
<a href="#l4.383"></a><span id="l4.383" class="difflineminus">-  char          *fLastAlert; /* used to avoid displaying the same alert over and over */</span>
<a href="#l4.384"></a><span id="l4.384" class="difflineminus">-  char          *fMsgID; /* MessageID for Gmail only (X-GM-MSGID) */</span>
<a href="#l4.385"></a><span id="l4.385" class="difflineminus">-  char          *fThreadID; /* ThreadID for Gmail only (X-GM-THRID) */</span>
<a href="#l4.386"></a><span id="l4.386" class="difflineminus">-  char          *fLabels; /* Labels for Gmail only (X-GM-LABELS) [will include parens, removed while passing to hashTable ]*/</span>
<a href="#l4.387"></a><span id="l4.387" class="difflineminus">-  nsCString     fManageListsUrl;</span>
<a href="#l4.388"></a><span id="l4.388" class="difflineminus">-  nsCString    fManageFiltersUrl;</span>
<a href="#l4.389"></a><span id="l4.389" class="difflineminus">-  char          *fFolderAdminUrl;</span>
<a href="#l4.390"></a><span id="l4.390" class="difflineminus">-  nsCString    fServerIdResponse; // RFC</span>
<a href="#l4.391"></a><span id="l4.391" class="difflineplus">+  eIMAPCapabilityFlags fCapabilityFlag;</span>
<a href="#l4.392"></a><span id="l4.392" class="difflineplus">+  nsCString fMailAccountUrl;</span>
<a href="#l4.393"></a><span id="l4.393" class="difflineplus">+  char *fNetscapeServerVersionString;</span>
<a href="#l4.394"></a><span id="l4.394" class="difflineplus">+  char *fXSenderInfo; /* changed per message download */</span>
<a href="#l4.395"></a><span id="l4.395" class="difflineplus">+  char *fLastAlert; /* used to avoid displaying the same alert over and over */</span>
<a href="#l4.396"></a><span id="l4.396" class="difflineplus">+  char *fMsgID;     /* MessageID for Gmail only (X-GM-MSGID) */</span>
<a href="#l4.397"></a><span id="l4.397" class="difflineplus">+  char *fThreadID;  /* ThreadID for Gmail only (X-GM-THRID) */</span>
<a href="#l4.398"></a><span id="l4.398" class="difflineplus">+  char *fLabels;    /* Labels for Gmail only (X-GM-LABELS) [will include parens,</span>
<a href="#l4.399"></a><span id="l4.399" class="difflineplus">+                       removed while passing to hashTable ]*/</span>
<a href="#l4.400"></a><span id="l4.400" class="difflineplus">+  nsCString fManageListsUrl;</span>
<a href="#l4.401"></a><span id="l4.401" class="difflineplus">+  nsCString fManageFiltersUrl;</span>
<a href="#l4.402"></a><span id="l4.402" class="difflineplus">+  char *fFolderAdminUrl;</span>
<a href="#l4.403"></a><span id="l4.403" class="difflineplus">+  nsCString fServerIdResponse;  // RFC</span>
<a href="#l4.404"></a><span id="l4.404"> </span>
<a href="#l4.405"></a><span id="l4.405">   int32_t fFetchResponseIndex;</span>
<a href="#l4.406"></a><span id="l4.406"> </span>
<a href="#l4.407"></a><span id="l4.407">   // used for aborting a fetch stream when we're pseudo-Interrupted</span>
<a href="#l4.408"></a><span id="l4.408">   int32_t numberOfCharsInThisChunk;</span>
<a href="#l4.409"></a><span id="l4.409">   int32_t charsReadSoFar;</span>
<a href="#l4.410"></a><span id="l4.410">   bool fLastChunk;</span>
<a href="#l4.411"></a><span id="l4.411"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/imap/src/nsImapService.cpp</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapService.cpp</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -1,14 +1,14 @@</span>
<a href="#l5.4"></a><span id="l5.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l5.5"></a><span id="l5.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l5.6"></a><span id="l5.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l5.7"></a><span id="l5.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l5.8"></a><span id="l5.8"> </span>
<a href="#l5.9"></a><span id="l5.9" class="difflineminus">-#include &quot;msgCore.h&quot;    // precompiled header...</span>
<a href="#l5.10"></a><span id="l5.10" class="difflineplus">+#include &quot;msgCore.h&quot;  // precompiled header...</span>
<a href="#l5.11"></a><span id="l5.11"> #include &quot;nsImapService.h&quot;</span>
<a href="#l5.12"></a><span id="l5.12"> #include &quot;nsMsgImapCID.h&quot;</span>
<a href="#l5.13"></a><span id="l5.13"> #include &quot;nsImapCore.h&quot;</span>
<a href="#l5.14"></a><span id="l5.14"> #include &quot;netCore.h&quot;</span>
<a href="#l5.15"></a><span id="l5.15"> </span>
<a href="#l5.16"></a><span id="l5.16"> #include &quot;nsImapUrl.h&quot;</span>
<a href="#l5.17"></a><span id="l5.17"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l5.18"></a><span id="l5.18"> #include &quot;nsIMsgFolder.h&quot;</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineat">@@ -60,259 +60,237 @@</span>
<a href="#l5.20"></a><span id="l5.20"> #include &quot;nsNetUtil.h&quot;</span>
<a href="#l5.21"></a><span id="l5.21"> #include &quot;nsMsgMessageFlags.h&quot;</span>
<a href="#l5.22"></a><span id="l5.22"> #include &quot;nsIMsgPluggableStore.h&quot;</span>
<a href="#l5.23"></a><span id="l5.23"> #include &quot;../../base/src/MailnewsLoadContextInfo.h&quot;</span>
<a href="#l5.24"></a><span id="l5.24"> #include &quot;nsDocShellLoadState.h&quot;</span>
<a href="#l5.25"></a><span id="l5.25"> #include &quot;nsContentUtils.h&quot;</span>
<a href="#l5.26"></a><span id="l5.26"> #include &quot;mozilla/LoadInfo.h&quot;</span>
<a href="#l5.27"></a><span id="l5.27"> </span>
<a href="#l5.28"></a><span id="l5.28" class="difflineminus">-#define PREF_MAIL_ROOT_IMAP &quot;mail.root.imap&quot;            // old - for backward compatibility only</span>
<a href="#l5.29"></a><span id="l5.29"> #define PREF_MAIL_ROOT_IMAP_REL &quot;mail.root.imap-rel&quot;</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineplus">+// old - for backward compatibility only</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineplus">+#define PREF_MAIL_ROOT_IMAP &quot;mail.root.imap&quot;</span>
<a href="#l5.32"></a><span id="l5.32"> </span>
<a href="#l5.33"></a><span id="l5.33"> static NS_DEFINE_CID(kImapUrlCID, NS_IMAPURL_CID);</span>
<a href="#l5.34"></a><span id="l5.34"> static NS_DEFINE_CID(kCImapMockChannel, NS_IMAPMOCKCHANNEL_CID);</span>
<a href="#l5.35"></a><span id="l5.35"> </span>
<a href="#l5.36"></a><span id="l5.36"> static const char sequenceString[] = &quot;SEQUENCE&quot;;</span>
<a href="#l5.37"></a><span id="l5.37"> static const char uidString[] = &quot;UID&quot;;</span>
<a href="#l5.38"></a><span id="l5.38"> </span>
<a href="#l5.39"></a><span id="l5.39"> static bool gInitialized = false;</span>
<a href="#l5.40"></a><span id="l5.40"> static int32_t gMIMEOnDemandThreshold = 15000;</span>
<a href="#l5.41"></a><span id="l5.41"> static bool gMIMEOnDemand = false;</span>
<a href="#l5.42"></a><span id="l5.42"> </span>
<a href="#l5.43"></a><span id="l5.43" class="difflineminus">-NS_IMPL_ISUPPORTS(nsImapService,</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineminus">-                   nsIImapService,</span>
<a href="#l5.45"></a><span id="l5.45" class="difflineminus">-                   nsIMsgMessageService,</span>
<a href="#l5.46"></a><span id="l5.46" class="difflineminus">-                   nsIProtocolHandler,</span>
<a href="#l5.47"></a><span id="l5.47" class="difflineminus">-                   nsIMsgProtocolInfo,</span>
<a href="#l5.48"></a><span id="l5.48" class="difflineminus">-                   nsIMsgMessageFetchPartService,</span>
<a href="#l5.49"></a><span id="l5.49" class="difflineminus">-                   nsIContentHandler)</span>
<a href="#l5.50"></a><span id="l5.50" class="difflineminus">-</span>
<a href="#l5.51"></a><span id="l5.51" class="difflineminus">-nsImapService::nsImapService()</span>
<a href="#l5.52"></a><span id="l5.52" class="difflineminus">-{</span>
<a href="#l5.53"></a><span id="l5.53" class="difflineplus">+NS_IMPL_ISUPPORTS(nsImapService, nsIImapService, nsIMsgMessageService,</span>
<a href="#l5.54"></a><span id="l5.54" class="difflineplus">+                  nsIProtocolHandler, nsIMsgProtocolInfo,</span>
<a href="#l5.55"></a><span id="l5.55" class="difflineplus">+                  nsIMsgMessageFetchPartService, nsIContentHandler)</span>
<a href="#l5.56"></a><span id="l5.56" class="difflineplus">+</span>
<a href="#l5.57"></a><span id="l5.57" class="difflineplus">+nsImapService::nsImapService() {</span>
<a href="#l5.58"></a><span id="l5.58">   mPrintingOperation = false;</span>
<a href="#l5.59"></a><span id="l5.59" class="difflineminus">-  if (!gInitialized)</span>
<a href="#l5.60"></a><span id="l5.60" class="difflineminus">-  {</span>
<a href="#l5.61"></a><span id="l5.61" class="difflineplus">+  if (!gInitialized) {</span>
<a href="#l5.62"></a><span id="l5.62">     nsresult rv;</span>
<a href="#l5.63"></a><span id="l5.63" class="difflineminus">-    nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l5.64"></a><span id="l5.64" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; prefBranch)</span>
<a href="#l5.65"></a><span id="l5.65" class="difflineminus">-    {</span>
<a href="#l5.66"></a><span id="l5.66" class="difflineplus">+    nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(</span>
<a href="#l5.67"></a><span id="l5.67" class="difflineplus">+        do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l5.68"></a><span id="l5.68" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; prefBranch) {</span>
<a href="#l5.69"></a><span id="l5.69">       prefBranch-&gt;GetBoolPref(&quot;mail.imap.mime_parts_on_demand&quot;, &amp;gMIMEOnDemand);</span>
<a href="#l5.70"></a><span id="l5.70" class="difflineminus">-      prefBranch-&gt;GetIntPref(&quot;mail.imap.mime_parts_on_demand_threshold&quot;, &amp;gMIMEOnDemandThreshold);</span>
<a href="#l5.71"></a><span id="l5.71" class="difflineplus">+      prefBranch-&gt;GetIntPref(&quot;mail.imap.mime_parts_on_demand_threshold&quot;,</span>
<a href="#l5.72"></a><span id="l5.72" class="difflineplus">+                             &amp;gMIMEOnDemandThreshold);</span>
<a href="#l5.73"></a><span id="l5.73">     }</span>
<a href="#l5.74"></a><span id="l5.74"> </span>
<a href="#l5.75"></a><span id="l5.75">     // initialize auto-sync service</span>
<a href="#l5.76"></a><span id="l5.76" class="difflineminus">-    nsCOMPtr&lt;nsIAutoSyncManager&gt; autoSyncMgr = do_GetService(NS_AUTOSYNCMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l5.77"></a><span id="l5.77" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; autoSyncMgr)</span>
<a href="#l5.78"></a><span id="l5.78" class="difflineminus">-    {</span>
<a href="#l5.79"></a><span id="l5.79" class="difflineplus">+    nsCOMPtr&lt;nsIAutoSyncManager&gt; autoSyncMgr =</span>
<a href="#l5.80"></a><span id="l5.80" class="difflineplus">+        do_GetService(NS_AUTOSYNCMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l5.81"></a><span id="l5.81" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; autoSyncMgr) {</span>
<a href="#l5.82"></a><span id="l5.82">       // auto-sync manager initialization goes here</span>
<a href="#l5.83"></a><span id="l5.83">       // assign new strategy objects here...</span>
<a href="#l5.84"></a><span id="l5.84">     }</span>
<a href="#l5.85"></a><span id="l5.85" class="difflineminus">-    NS_ASSERTION(autoSyncMgr != nullptr, &quot;*** Cannot initialize nsAutoSyncManager service.&quot;);</span>
<a href="#l5.86"></a><span id="l5.86" class="difflineplus">+    NS_ASSERTION(autoSyncMgr != nullptr,</span>
<a href="#l5.87"></a><span id="l5.87" class="difflineplus">+                 &quot;*** Cannot initialize nsAutoSyncManager service.&quot;);</span>
<a href="#l5.88"></a><span id="l5.88"> </span>
<a href="#l5.89"></a><span id="l5.89">     gInitialized = true;</span>
<a href="#l5.90"></a><span id="l5.90">   }</span>
<a href="#l5.91"></a><span id="l5.91"> }</span>
<a href="#l5.92"></a><span id="l5.92"> </span>
<a href="#l5.93"></a><span id="l5.93" class="difflineminus">-nsImapService::~nsImapService()</span>
<a href="#l5.94"></a><span id="l5.94" class="difflineminus">-{</span>
<a href="#l5.95"></a><span id="l5.95" class="difflineminus">-}</span>
<a href="#l5.96"></a><span id="l5.96" class="difflineminus">-</span>
<a href="#l5.97"></a><span id="l5.97" class="difflineminus">-char nsImapService::GetHierarchyDelimiter(nsIMsgFolder *aMsgFolder)</span>
<a href="#l5.98"></a><span id="l5.98" class="difflineminus">-{</span>
<a href="#l5.99"></a><span id="l5.99" class="difflineplus">+nsImapService::~nsImapService() {}</span>
<a href="#l5.100"></a><span id="l5.100" class="difflineplus">+</span>
<a href="#l5.101"></a><span id="l5.101" class="difflineplus">+char nsImapService::GetHierarchyDelimiter(nsIMsgFolder *aMsgFolder) {</span>
<a href="#l5.102"></a><span id="l5.102">   char delimiter = '/';</span>
<a href="#l5.103"></a><span id="l5.103" class="difflineminus">-  if (aMsgFolder)</span>
<a href="#l5.104"></a><span id="l5.104" class="difflineminus">-  {</span>
<a href="#l5.105"></a><span id="l5.105" class="difflineplus">+  if (aMsgFolder) {</span>
<a href="#l5.106"></a><span id="l5.106">     nsCOMPtr&lt;nsIMsgImapMailFolder&gt; imapFolder = do_QueryInterface(aMsgFolder);</span>
<a href="#l5.107"></a><span id="l5.107" class="difflineminus">-    if (imapFolder)</span>
<a href="#l5.108"></a><span id="l5.108" class="difflineminus">-      imapFolder-&gt;GetHierarchyDelimiter(&amp;delimiter);</span>
<a href="#l5.109"></a><span id="l5.109" class="difflineplus">+    if (imapFolder) imapFolder-&gt;GetHierarchyDelimiter(&amp;delimiter);</span>
<a href="#l5.110"></a><span id="l5.110">   }</span>
<a href="#l5.111"></a><span id="l5.111">   return delimiter;</span>
<a href="#l5.112"></a><span id="l5.112"> }</span>
<a href="#l5.113"></a><span id="l5.113"> </span>
<a href="#l5.114"></a><span id="l5.114"> // N.B., this returns an escaped folder name, appropriate for putting in a url.</span>
<a href="#l5.115"></a><span id="l5.115" class="difflineminus">-nsresult nsImapService::GetFolderName(nsIMsgFolder *aImapFolder, nsACString &amp;aFolderName)</span>
<a href="#l5.116"></a><span id="l5.116" class="difflineminus">-{</span>
<a href="#l5.117"></a><span id="l5.117" class="difflineplus">+nsresult nsImapService::GetFolderName(nsIMsgFolder *aImapFolder,</span>
<a href="#l5.118"></a><span id="l5.118" class="difflineplus">+                                      nsACString &amp;aFolderName) {</span>
<a href="#l5.119"></a><span id="l5.119">   nsresult rv;</span>
<a href="#l5.120"></a><span id="l5.120">   nsCOMPtr&lt;nsIMsgImapMailFolder&gt; aFolder(do_QueryInterface(aImapFolder, &amp;rv));</span>
<a href="#l5.121"></a><span id="l5.121">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.122"></a><span id="l5.122"> </span>
<a href="#l5.123"></a><span id="l5.123">   nsCString onlineName;</span>
<a href="#l5.124"></a><span id="l5.124">   // online name is in imap utf-7 - leave it that way</span>
<a href="#l5.125"></a><span id="l5.125">   rv = aFolder-&gt;GetOnlineName(onlineName);</span>
<a href="#l5.126"></a><span id="l5.126">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.127"></a><span id="l5.127" class="difflineminus">-  if (onlineName.IsEmpty())</span>
<a href="#l5.128"></a><span id="l5.128" class="difflineminus">-  {</span>
<a href="#l5.129"></a><span id="l5.129" class="difflineplus">+  if (onlineName.IsEmpty()) {</span>
<a href="#l5.130"></a><span id="l5.130">     nsCString uri;</span>
<a href="#l5.131"></a><span id="l5.131">     rv = aImapFolder-&gt;GetURI(uri);</span>
<a href="#l5.132"></a><span id="l5.132">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.133"></a><span id="l5.133">     nsCString hostname;</span>
<a href="#l5.134"></a><span id="l5.134">     rv = aImapFolder-&gt;GetHostname(hostname);</span>
<a href="#l5.135"></a><span id="l5.135">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.136"></a><span id="l5.136" class="difflineminus">-    rv = nsImapURI2FullName(kImapRootURI, hostname.get(), uri.get(), getter_Copies(onlineName));</span>
<a href="#l5.137"></a><span id="l5.137" class="difflineplus">+    rv = nsImapURI2FullName(kImapRootURI, hostname.get(), uri.get(),</span>
<a href="#l5.138"></a><span id="l5.138" class="difflineplus">+                            getter_Copies(onlineName));</span>
<a href="#l5.139"></a><span id="l5.139">   }</span>
<a href="#l5.140"></a><span id="l5.140">   // if the hierarchy delimiter is not '/', then we want to escape slashes;</span>
<a href="#l5.141"></a><span id="l5.141">   // otherwise, we do want to escape slashes.</span>
<a href="#l5.142"></a><span id="l5.142">   // we want to escape slashes and '^' first, otherwise, nsEscape will lose them</span>
<a href="#l5.143"></a><span id="l5.143">   bool escapeSlashes = (GetHierarchyDelimiter(aImapFolder) != '/');</span>
<a href="#l5.144"></a><span id="l5.144" class="difflineminus">-  if (escapeSlashes &amp;&amp; !onlineName.IsEmpty())</span>
<a href="#l5.145"></a><span id="l5.145" class="difflineminus">-  {</span>
<a href="#l5.146"></a><span id="l5.146" class="difflineminus">-    char* escapedOnlineName;</span>
<a href="#l5.147"></a><span id="l5.147" class="difflineplus">+  if (escapeSlashes &amp;&amp; !onlineName.IsEmpty()) {</span>
<a href="#l5.148"></a><span id="l5.148" class="difflineplus">+    char *escapedOnlineName;</span>
<a href="#l5.149"></a><span id="l5.149">     rv = nsImapUrl::EscapeSlashes(onlineName.get(), &amp;escapedOnlineName);</span>
<a href="#l5.150"></a><span id="l5.150" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l5.151"></a><span id="l5.151" class="difflineminus">-      onlineName.Adopt(escapedOnlineName);</span>
<a href="#l5.152"></a><span id="l5.152" class="difflineplus">+    if (NS_SUCCEEDED(rv)) onlineName.Adopt(escapedOnlineName);</span>
<a href="#l5.153"></a><span id="l5.153">   }</span>
<a href="#l5.154"></a><span id="l5.154">   // need to escape everything else</span>
<a href="#l5.155"></a><span id="l5.155">   MsgEscapeString(onlineName, nsINetUtil::ESCAPE_URL_PATH, aFolderName);</span>
<a href="#l5.156"></a><span id="l5.156">   return rv;</span>
<a href="#l5.157"></a><span id="l5.157"> }</span>
<a href="#l5.158"></a><span id="l5.158"> </span>
<a href="#l5.159"></a><span id="l5.159"> NS_IMETHODIMP nsImapService::SelectFolder(nsIMsgFolder *aImapMailFolder,</span>
<a href="#l5.160"></a><span id="l5.160">                                           nsIUrlListener *aUrlListener,</span>
<a href="#l5.161"></a><span id="l5.161">                                           nsIMsgWindow *aMsgWindow,</span>
<a href="#l5.162"></a><span id="l5.162" class="difflineminus">-                                          nsIURI **aURL)</span>
<a href="#l5.163"></a><span id="l5.163" class="difflineminus">-{</span>
<a href="#l5.164"></a><span id="l5.164" class="difflineplus">+                                          nsIURI **aURL) {</span>
<a href="#l5.165"></a><span id="l5.165">   NS_ENSURE_ARG_POINTER(aImapMailFolder);</span>
<a href="#l5.166"></a><span id="l5.166"> </span>
<a href="#l5.167"></a><span id="l5.167" class="difflineminus">-  if (WeAreOffline())</span>
<a href="#l5.168"></a><span id="l5.168" class="difflineminus">-    return NS_MSG_ERROR_OFFLINE;</span>
<a href="#l5.169"></a><span id="l5.169" class="difflineplus">+  if (WeAreOffline()) return NS_MSG_ERROR_OFFLINE;</span>
<a href="#l5.170"></a><span id="l5.170"> </span>
<a href="#l5.171"></a><span id="l5.171">   bool canOpenThisFolder = true;</span>
<a href="#l5.172"></a><span id="l5.172" class="difflineminus">-  nsCOMPtr&lt;nsIMsgImapMailFolder&gt; imapFolder = do_QueryInterface(aImapMailFolder);</span>
<a href="#l5.173"></a><span id="l5.173" class="difflineminus">-  if (imapFolder)</span>
<a href="#l5.174"></a><span id="l5.174" class="difflineminus">-    imapFolder-&gt;GetCanOpenFolder(&amp;canOpenThisFolder);</span>
<a href="#l5.175"></a><span id="l5.175" class="difflineminus">-</span>
<a href="#l5.176"></a><span id="l5.176" class="difflineminus">-  if (!canOpenThisFolder)</span>
<a href="#l5.177"></a><span id="l5.177" class="difflineminus">-    return NS_OK;</span>
<a href="#l5.178"></a><span id="l5.178" class="difflineplus">+  nsCOMPtr&lt;nsIMsgImapMailFolder&gt; imapFolder =</span>
<a href="#l5.179"></a><span id="l5.179" class="difflineplus">+      do_QueryInterface(aImapMailFolder);</span>
<a href="#l5.180"></a><span id="l5.180" class="difflineplus">+  if (imapFolder) imapFolder-&gt;GetCanOpenFolder(&amp;canOpenThisFolder);</span>
<a href="#l5.181"></a><span id="l5.181" class="difflineplus">+</span>
<a href="#l5.182"></a><span id="l5.182" class="difflineplus">+  if (!canOpenThisFolder) return NS_OK;</span>
<a href="#l5.183"></a><span id="l5.183"> </span>
<a href="#l5.184"></a><span id="l5.184">   nsresult rv;</span>
<a href="#l5.185"></a><span id="l5.185">   nsCOMPtr&lt;nsIImapUrl&gt; imapUrl;</span>
<a href="#l5.186"></a><span id="l5.186">   nsAutoCString urlSpec;</span>
<a href="#l5.187"></a><span id="l5.187">   char hierarchyDelimiter = GetHierarchyDelimiter(aImapMailFolder);</span>
<a href="#l5.188"></a><span id="l5.188">   rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(imapUrl),</span>
<a href="#l5.189"></a><span id="l5.189" class="difflineminus">-                            aImapMailFolder, aUrlListener, urlSpec, hierarchyDelimiter);</span>
<a href="#l5.190"></a><span id="l5.190" class="difflineminus">-</span>
<a href="#l5.191"></a><span id="l5.191" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; imapUrl)</span>
<a href="#l5.192"></a><span id="l5.192" class="difflineminus">-  {</span>
<a href="#l5.193"></a><span id="l5.193" class="difflineplus">+                            aImapMailFolder, aUrlListener, urlSpec,</span>
<a href="#l5.194"></a><span id="l5.194" class="difflineplus">+                            hierarchyDelimiter);</span>
<a href="#l5.195"></a><span id="l5.195" class="difflineplus">+</span>
<a href="#l5.196"></a><span id="l5.196" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; imapUrl) {</span>
<a href="#l5.197"></a><span id="l5.197">     // nsImapUrl::SetSpec() will set the imap action properly</span>
<a href="#l5.198"></a><span id="l5.198">     rv = imapUrl-&gt;SetImapAction(nsIImapUrl::nsImapSelectFolder);</span>
<a href="#l5.199"></a><span id="l5.199"> </span>
<a href="#l5.200"></a><span id="l5.200">     nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailNewsUrl = do_QueryInterface(imapUrl);</span>
<a href="#l5.201"></a><span id="l5.201" class="difflineminus">-    // if no msg window, we won't put up error messages (this is almost certainly a biff-inspired get new msgs)</span>
<a href="#l5.202"></a><span id="l5.202" class="difflineminus">-    if (!aMsgWindow)</span>
<a href="#l5.203"></a><span id="l5.203" class="difflineminus">-      mailNewsUrl-&gt;SetSuppressErrorMsgs(true);</span>
<a href="#l5.204"></a><span id="l5.204" class="difflineplus">+    // if no msg window, we won't put up error messages (this is almost</span>
<a href="#l5.205"></a><span id="l5.205" class="difflineplus">+    // certainly a biff-inspired get new msgs)</span>
<a href="#l5.206"></a><span id="l5.206" class="difflineplus">+    if (!aMsgWindow) mailNewsUrl-&gt;SetSuppressErrorMsgs(true);</span>
<a href="#l5.207"></a><span id="l5.207">     mailNewsUrl-&gt;SetMsgWindow(aMsgWindow);</span>
<a href="#l5.208"></a><span id="l5.208">     mailNewsUrl-&gt;SetUpdatingFolder(true);</span>
<a href="#l5.209"></a><span id="l5.209">     rv = SetImapUrlSink(aImapMailFolder, imapUrl);</span>
<a href="#l5.210"></a><span id="l5.210"> </span>
<a href="#l5.211"></a><span id="l5.211" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l5.212"></a><span id="l5.212" class="difflineminus">-    {</span>
<a href="#l5.213"></a><span id="l5.213" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l5.214"></a><span id="l5.214">       nsAutoCString folderName;</span>
<a href="#l5.215"></a><span id="l5.215">       GetFolderName(aImapMailFolder, folderName);</span>
<a href="#l5.216"></a><span id="l5.216">       urlSpec.AppendLiteral(&quot;/select&gt;&quot;);</span>
<a href="#l5.217"></a><span id="l5.217">       urlSpec.Append(hierarchyDelimiter);</span>
<a href="#l5.218"></a><span id="l5.218">       urlSpec.Append(folderName);</span>
<a href="#l5.219"></a><span id="l5.219">       rv = mailNewsUrl-&gt;SetSpecInternal(urlSpec);</span>
<a href="#l5.220"></a><span id="l5.220">       if (NS_SUCCEEDED(rv))</span>
<a href="#l5.221"></a><span id="l5.221">         rv = GetImapConnectionAndLoadUrl(imapUrl, nullptr, aURL);</span>
<a href="#l5.222"></a><span id="l5.222">     }</span>
<a href="#l5.223"></a><span id="l5.223" class="difflineminus">-  } // if we have a url to run....</span>
<a href="#l5.224"></a><span id="l5.224" class="difflineplus">+  }  // if we have a url to run....</span>
<a href="#l5.225"></a><span id="l5.225"> </span>
<a href="#l5.226"></a><span id="l5.226">   return rv;</span>
<a href="#l5.227"></a><span id="l5.227"> }</span>
<a href="#l5.228"></a><span id="l5.228"> </span>
<a href="#l5.229"></a><span id="l5.229"> // lite select, used to verify UIDVALIDITY while going on/offline</span>
<a href="#l5.230"></a><span id="l5.230"> NS_IMETHODIMP nsImapService::LiteSelectFolder(nsIMsgFolder *aImapMailFolder,</span>
<a href="#l5.231"></a><span id="l5.231">                                               nsIUrlListener *aUrlListener,</span>
<a href="#l5.232"></a><span id="l5.232">                                               nsIMsgWindow *aMsgWindow,</span>
<a href="#l5.233"></a><span id="l5.233" class="difflineminus">-                                              nsIURI **aURL)</span>
<a href="#l5.234"></a><span id="l5.234" class="difflineminus">-{</span>
<a href="#l5.235"></a><span id="l5.235" class="difflineplus">+                                              nsIURI **aURL) {</span>
<a href="#l5.236"></a><span id="l5.236">   NS_ENSURE_ARG_POINTER(aImapMailFolder);</span>
<a href="#l5.237"></a><span id="l5.237"> </span>
<a href="#l5.238"></a><span id="l5.238" class="difflineminus">-  return FolderCommand(aImapMailFolder, aUrlListener,</span>
<a href="#l5.239"></a><span id="l5.239" class="difflineminus">-                       &quot;/liteselect&gt;&quot;, nsIImapUrl::nsImapLiteSelectFolder, aMsgWindow, aURL);</span>
<a href="#l5.240"></a><span id="l5.240" class="difflineplus">+  return FolderCommand(aImapMailFolder, aUrlListener, &quot;/liteselect&gt;&quot;,</span>
<a href="#l5.241"></a><span id="l5.241" class="difflineplus">+                       nsIImapUrl::nsImapLiteSelectFolder, aMsgWindow, aURL);</span>
<a href="#l5.242"></a><span id="l5.242"> }</span>
<a href="#l5.243"></a><span id="l5.243"> </span>
<a href="#l5.244"></a><span id="l5.244"> NS_IMETHODIMP nsImapService::GetUrlForUri(const char *aMessageURI,</span>
<a href="#l5.245"></a><span id="l5.245">                                           nsIURI **aURL,</span>
<a href="#l5.246"></a><span id="l5.246" class="difflineminus">-                                          nsIMsgWindow *aMsgWindow)</span>
<a href="#l5.247"></a><span id="l5.247" class="difflineminus">-{</span>
<a href="#l5.248"></a><span id="l5.248" class="difflineplus">+                                          nsIMsgWindow *aMsgWindow) {</span>
<a href="#l5.249"></a><span id="l5.249">   nsAutoCString messageURI(aMessageURI);</span>
<a href="#l5.250"></a><span id="l5.250"> </span>
<a href="#l5.251"></a><span id="l5.251" class="difflineminus">-  if (messageURI.Find(NS_LITERAL_CSTRING(&quot;&amp;type=application/x-message-display&quot;)) != kNotFound)</span>
<a href="#l5.252"></a><span id="l5.252" class="difflineplus">+  if (messageURI.Find(NS_LITERAL_CSTRING(</span>
<a href="#l5.253"></a><span id="l5.253" class="difflineplus">+          &quot;&amp;type=application/x-message-display&quot;)) != kNotFound)</span>
<a href="#l5.254"></a><span id="l5.254">     return NS_NewURI(aURL, aMessageURI);</span>
<a href="#l5.255"></a><span id="l5.255"> </span>
<a href="#l5.256"></a><span id="l5.256">   nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l5.257"></a><span id="l5.257">   nsAutoCString msgKey;</span>
<a href="#l5.258"></a><span id="l5.258">   nsresult rv = DecomposeImapURI(messageURI, getter_AddRefs(folder), msgKey);</span>
<a href="#l5.259"></a><span id="l5.259" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l5.260"></a><span id="l5.260" class="difflineminus">-  {</span>
<a href="#l5.261"></a><span id="l5.261" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l5.262"></a><span id="l5.262">     nsCOMPtr&lt;nsIImapUrl&gt; imapUrl;</span>
<a href="#l5.263"></a><span id="l5.263">     nsAutoCString urlSpec;</span>
<a href="#l5.264"></a><span id="l5.264">     char hierarchyDelimiter = GetHierarchyDelimiter(folder);</span>
<a href="#l5.265"></a><span id="l5.265" class="difflineminus">-    rv = CreateStartOfImapUrl(messageURI, getter_AddRefs(imapUrl), folder, nullptr, urlSpec, hierarchyDelimiter);</span>
<a href="#l5.266"></a><span id="l5.266" class="difflineplus">+    rv = CreateStartOfImapUrl(messageURI, getter_AddRefs(imapUrl), folder,</span>
<a href="#l5.267"></a><span id="l5.267" class="difflineplus">+                              nullptr, urlSpec, hierarchyDelimiter);</span>
<a href="#l5.268"></a><span id="l5.268">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.269"></a><span id="l5.269">     rv = SetImapUrlSink(folder, imapUrl);</span>
<a href="#l5.270"></a><span id="l5.270">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.271"></a><span id="l5.271" class="difflineminus">-    nsCOMPtr &lt;nsIMsgMailNewsUrl&gt; mailnewsUrl = do_QueryInterface(imapUrl);</span>
<a href="#l5.272"></a><span id="l5.272" class="difflineplus">+    nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsUrl = do_QueryInterface(imapUrl);</span>
<a href="#l5.273"></a><span id="l5.273">     bool useLocalCache = false;</span>
<a href="#l5.274"></a><span id="l5.274">     folder-&gt;HasMsgOffline(strtoul(msgKey.get(), nullptr, 10), &amp;useLocalCache);</span>
<a href="#l5.275"></a><span id="l5.275">     mailnewsUrl-&gt;SetMsgIsInLocalCache(useLocalCache);</span>
<a href="#l5.276"></a><span id="l5.276"> </span>
<a href="#l5.277"></a><span id="l5.277">     nsCOMPtr&lt;nsIURI&gt; url = do_QueryInterface(imapUrl);</span>
<a href="#l5.278"></a><span id="l5.278">     rv = url-&gt;GetSpec(urlSpec);</span>
<a href="#l5.279"></a><span id="l5.279">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.280"></a><span id="l5.280">     urlSpec.AppendLiteral(&quot;fetch&gt;UID&gt;&quot;);</span>
<a href="#l5.281"></a><span id="l5.281">     urlSpec.Append(hierarchyDelimiter);</span>
<a href="#l5.282"></a><span id="l5.282"> </span>
<a href="#l5.283"></a><span id="l5.283">     nsAutoCString folderName;</span>
<a href="#l5.284"></a><span id="l5.284">     GetFolderName(folder, folderName);</span>
<a href="#l5.285"></a><span id="l5.285">     urlSpec.Append(folderName);</span>
<a href="#l5.286"></a><span id="l5.286">     urlSpec.Append('&gt;');</span>
<a href="#l5.287"></a><span id="l5.287">     urlSpec.Append(msgKey);</span>
<a href="#l5.288"></a><span id="l5.288">     rv = mailnewsUrl-&gt;SetSpecInternal(urlSpec);</span>
<a href="#l5.289"></a><span id="l5.289" class="difflineminus">-    imapUrl-&gt;QueryInterface(NS_GET_IID(nsIURI), (void **) aURL);</span>
<a href="#l5.290"></a><span id="l5.290" class="difflineplus">+    imapUrl-&gt;QueryInterface(NS_GET_IID(nsIURI), (void **)aURL);</span>
<a href="#l5.291"></a><span id="l5.291">   }</span>
<a href="#l5.292"></a><span id="l5.292"> </span>
<a href="#l5.293"></a><span id="l5.293">   return rv;</span>
<a href="#l5.294"></a><span id="l5.294"> }</span>
<a href="#l5.295"></a><span id="l5.295"> </span>
<a href="#l5.296"></a><span id="l5.296" class="difflineminus">-NS_IMETHODIMP nsImapService::OpenAttachment(const char *aContentType,</span>
<a href="#l5.297"></a><span id="l5.297" class="difflineminus">-                                            const char *aFileName,</span>
<a href="#l5.298"></a><span id="l5.298" class="difflineminus">-                                            const char *aUrl,</span>
<a href="#l5.299"></a><span id="l5.299" class="difflineminus">-                                            const char *aMessageUri,</span>
<a href="#l5.300"></a><span id="l5.300" class="difflineminus">-                                            nsISupports *aDisplayConsumer,</span>
<a href="#l5.301"></a><span id="l5.301" class="difflineminus">-                                            nsIMsgWindow *aMsgWindow,</span>
<a href="#l5.302"></a><span id="l5.302" class="difflineminus">-                                            nsIUrlListener *aUrlListener)</span>
<a href="#l5.303"></a><span id="l5.303" class="difflineminus">-{</span>
<a href="#l5.304"></a><span id="l5.304" class="difflineplus">+NS_IMETHODIMP nsImapService::OpenAttachment(</span>
<a href="#l5.305"></a><span id="l5.305" class="difflineplus">+    const char *aContentType, const char *aFileName, const char *aUrl,</span>
<a href="#l5.306"></a><span id="l5.306" class="difflineplus">+    const char *aMessageUri, nsISupports *aDisplayConsumer,</span>
<a href="#l5.307"></a><span id="l5.307" class="difflineplus">+    nsIMsgWindow *aMsgWindow, nsIUrlListener *aUrlListener) {</span>
<a href="#l5.308"></a><span id="l5.308">   // okay this is a little tricky....we may have to fetch the mime part</span>
<a href="#l5.309"></a><span id="l5.309">   // or it may already be downloaded for us....the only way i can tell to</span>
<a href="#l5.310"></a><span id="l5.310">   // distinguish the two events is to search for ?section or ?part</span>
<a href="#l5.311"></a><span id="l5.311"> </span>
<a href="#l5.312"></a><span id="l5.312">   nsAutoCString uri(aMessageUri);</span>
<a href="#l5.313"></a><span id="l5.313">   nsAutoCString urlString(aUrl);</span>
<a href="#l5.314"></a><span id="l5.314">   MsgReplaceSubstring(urlString, &quot;/;section&quot;, &quot;?section&quot;);</span>
<a href="#l5.315"></a><span id="l5.315"> </span>
<a href="#l5.316"></a><span id="l5.316">   // more stuff i don't understand</span>
<a href="#l5.317"></a><span id="l5.317">   int32_t sectionPos = urlString.Find(&quot;?section&quot;);</span>
<a href="#l5.318"></a><span id="l5.318" class="difflineminus">-  // if we have a section field then we must be dealing with a mime part we need to fetchf</span>
<a href="#l5.319"></a><span id="l5.319" class="difflineminus">-  if (sectionPos &gt; 0)</span>
<a href="#l5.320"></a><span id="l5.320" class="difflineminus">-  {</span>
<a href="#l5.321"></a><span id="l5.321" class="difflineplus">+  // if we have a section field then we must be dealing with a mime part we need</span>
<a href="#l5.322"></a><span id="l5.322" class="difflineplus">+  // to fetchf</span>
<a href="#l5.323"></a><span id="l5.323" class="difflineplus">+  if (sectionPos &gt; 0) {</span>
<a href="#l5.324"></a><span id="l5.324">     uri.Append(Substring(urlString, sectionPos));</span>
<a href="#l5.325"></a><span id="l5.325">     uri += &quot;&amp;type=&quot;;</span>
<a href="#l5.326"></a><span id="l5.326">     uri += aContentType;</span>
<a href="#l5.327"></a><span id="l5.327">     uri += &quot;&amp;filename=&quot;;</span>
<a href="#l5.328"></a><span id="l5.328">     uri += aFileName;</span>
<a href="#l5.329"></a><span id="l5.329" class="difflineminus">-  }</span>
<a href="#l5.330"></a><span id="l5.330" class="difflineminus">-  else</span>
<a href="#l5.331"></a><span id="l5.331" class="difflineminus">-  {</span>
<a href="#l5.332"></a><span id="l5.332" class="difflineplus">+  } else {</span>
<a href="#l5.333"></a><span id="l5.333">     // try to extract the specific part number out from the url string</span>
<a href="#l5.334"></a><span id="l5.334">     const char *partStart = PL_strstr(aUrl, &quot;part=&quot;);</span>
<a href="#l5.335"></a><span id="l5.335" class="difflineminus">-    if (!partStart)</span>
<a href="#l5.336"></a><span id="l5.336" class="difflineminus">-      return NS_ERROR_FAILURE;</span>
<a href="#l5.337"></a><span id="l5.337" class="difflineplus">+    if (!partStart) return NS_ERROR_FAILURE;</span>
<a href="#l5.338"></a><span id="l5.338">     nsDependentCString part(partStart);</span>
<a href="#l5.339"></a><span id="l5.339">     uri += &quot;?&quot;;</span>
<a href="#l5.340"></a><span id="l5.340">     uri += Substring(part, 0, part.FindChar('&amp;'));</span>
<a href="#l5.341"></a><span id="l5.341">     uri += &quot;&amp;type=&quot;;</span>
<a href="#l5.342"></a><span id="l5.342">     uri += aContentType;</span>
<a href="#l5.343"></a><span id="l5.343">     uri += &quot;&amp;filename=&quot;;</span>
<a href="#l5.344"></a><span id="l5.344">     uri += aFileName;</span>
<a href="#l5.345"></a><span id="l5.345">   }</span>
<a href="#l5.346"></a><span id="l5.346" class="difflineat">@@ -320,640 +298,612 @@ NS_IMETHODIMP nsImapService::OpenAttachm</span>
<a href="#l5.347"></a><span id="l5.347">   nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l5.348"></a><span id="l5.348">   nsAutoCString msgKey;</span>
<a href="#l5.349"></a><span id="l5.349">   nsAutoCString uriMimePart;</span>
<a href="#l5.350"></a><span id="l5.350">   nsAutoCString folderURI;</span>
<a href="#l5.351"></a><span id="l5.351">   nsMsgKey key;</span>
<a href="#l5.352"></a><span id="l5.352"> </span>
<a href="#l5.353"></a><span id="l5.353">   nsresult rv = DecomposeImapURI(uri, getter_AddRefs(folder), msgKey);</span>
<a href="#l5.354"></a><span id="l5.354">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.355"></a><span id="l5.355" class="difflineminus">-  rv = nsParseImapMessageURI(uri.get(), folderURI, &amp;key, getter_Copies(uriMimePart));</span>
<a href="#l5.356"></a><span id="l5.356" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l5.357"></a><span id="l5.357" class="difflineminus">-  {</span>
<a href="#l5.358"></a><span id="l5.358" class="difflineminus">-    nsCOMPtr&lt;nsIImapMessageSink&gt; imapMessageSink(do_QueryInterface(folder, &amp;rv));</span>
<a href="#l5.359"></a><span id="l5.359" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l5.360"></a><span id="l5.360" class="difflineminus">-    {</span>
<a href="#l5.361"></a><span id="l5.361" class="difflineplus">+  rv = nsParseImapMessageURI(uri.get(), folderURI, &amp;key,</span>
<a href="#l5.362"></a><span id="l5.362" class="difflineplus">+                             getter_Copies(uriMimePart));</span>
<a href="#l5.363"></a><span id="l5.363" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l5.364"></a><span id="l5.364" class="difflineplus">+    nsCOMPtr&lt;nsIImapMessageSink&gt; imapMessageSink(</span>
<a href="#l5.365"></a><span id="l5.365" class="difflineplus">+        do_QueryInterface(folder, &amp;rv));</span>
<a href="#l5.366"></a><span id="l5.366" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l5.367"></a><span id="l5.367">       nsCOMPtr&lt;nsIImapUrl&gt; imapUrl;</span>
<a href="#l5.368"></a><span id="l5.368">       nsAutoCString urlSpec;</span>
<a href="#l5.369"></a><span id="l5.369">       char hierarchyDelimiter = GetHierarchyDelimiter(folder);</span>
<a href="#l5.370"></a><span id="l5.370" class="difflineminus">-      rv = CreateStartOfImapUrl(uri, getter_AddRefs(imapUrl), folder, aUrlListener, urlSpec, hierarchyDelimiter);</span>
<a href="#l5.371"></a><span id="l5.371" class="difflineplus">+      rv = CreateStartOfImapUrl(uri, getter_AddRefs(imapUrl), folder,</span>
<a href="#l5.372"></a><span id="l5.372" class="difflineplus">+                                aUrlListener, urlSpec, hierarchyDelimiter);</span>
<a href="#l5.373"></a><span id="l5.373">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.374"></a><span id="l5.374"> </span>
<a href="#l5.375"></a><span id="l5.375">       urlSpec.AppendLiteral(&quot;/fetch&gt;UID&gt;&quot;);</span>
<a href="#l5.376"></a><span id="l5.376">       urlSpec.Append(hierarchyDelimiter);</span>
<a href="#l5.377"></a><span id="l5.377"> </span>
<a href="#l5.378"></a><span id="l5.378">       nsCString folderName;</span>
<a href="#l5.379"></a><span id="l5.379">       GetFolderName(folder, folderName);</span>
<a href="#l5.380"></a><span id="l5.380">       urlSpec.Append(folderName);</span>
<a href="#l5.381"></a><span id="l5.381">       urlSpec.Append('&gt;');</span>
<a href="#l5.382"></a><span id="l5.382">       urlSpec.Append(msgKey);</span>
<a href="#l5.383"></a><span id="l5.383">       urlSpec.Append(uriMimePart);</span>
<a href="#l5.384"></a><span id="l5.384"> </span>
<a href="#l5.385"></a><span id="l5.385" class="difflineminus">-      if (!uriMimePart.IsEmpty())</span>
<a href="#l5.386"></a><span id="l5.386" class="difflineminus">-      {</span>
<a href="#l5.387"></a><span id="l5.387" class="difflineplus">+      if (!uriMimePart.IsEmpty()) {</span>
<a href="#l5.388"></a><span id="l5.388">         nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsurl(do_QueryInterface(imapUrl));</span>
<a href="#l5.389"></a><span id="l5.389" class="difflineminus">-        if (mailnewsurl)</span>
<a href="#l5.390"></a><span id="l5.390" class="difflineminus">-        {</span>
<a href="#l5.391"></a><span id="l5.391" class="difflineplus">+        if (mailnewsurl) {</span>
<a href="#l5.392"></a><span id="l5.392">           rv = mailnewsurl-&gt;SetSpecInternal(urlSpec);</span>
<a href="#l5.393"></a><span id="l5.393">           NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.394"></a><span id="l5.394">           if (aFileName)</span>
<a href="#l5.395"></a><span id="l5.395">             mailnewsurl-&gt;SetFileNameInternal(nsDependentCString(aFileName));</span>
<a href="#l5.396"></a><span id="l5.396">         }</span>
<a href="#l5.397"></a><span id="l5.397" class="difflineminus">-        rv =  FetchMimePart(imapUrl, nsIImapUrl::nsImapOpenMimePart, folder, imapMessageSink,</span>
<a href="#l5.398"></a><span id="l5.398" class="difflineminus">-                            nullptr, aDisplayConsumer, msgKey, uriMimePart);</span>
<a href="#l5.399"></a><span id="l5.399" class="difflineplus">+        rv = FetchMimePart(imapUrl, nsIImapUrl::nsImapOpenMimePart, folder,</span>
<a href="#l5.400"></a><span id="l5.400" class="difflineplus">+                           imapMessageSink, nullptr, aDisplayConsumer, msgKey,</span>
<a href="#l5.401"></a><span id="l5.401" class="difflineplus">+                           uriMimePart);</span>
<a href="#l5.402"></a><span id="l5.402">       }</span>
<a href="#l5.403"></a><span id="l5.403" class="difflineminus">-    } // if we got a message sink</span>
<a href="#l5.404"></a><span id="l5.404" class="difflineminus">-  } // if we parsed the message uri</span>
<a href="#l5.405"></a><span id="l5.405" class="difflineplus">+    }  // if we got a message sink</span>
<a href="#l5.406"></a><span id="l5.406" class="difflineplus">+  }    // if we parsed the message uri</span>
<a href="#l5.407"></a><span id="l5.407"> </span>
<a href="#l5.408"></a><span id="l5.408">   return rv;</span>
<a href="#l5.409"></a><span id="l5.409"> }</span>
<a href="#l5.410"></a><span id="l5.410"> </span>
<a href="#l5.411"></a><span id="l5.411" class="difflineminus">-NS_IMETHODIMP nsImapService::FetchMimePart(nsIURI *aURI,</span>
<a href="#l5.412"></a><span id="l5.412" class="difflineminus">-                                           const char *aMessageURI,</span>
<a href="#l5.413"></a><span id="l5.413" class="difflineminus">-                                           nsISupports *aDisplayConsumer,</span>
<a href="#l5.414"></a><span id="l5.414" class="difflineminus">-                                           nsIMsgWindow *aMsgWindow,</span>
<a href="#l5.415"></a><span id="l5.415" class="difflineminus">-                                           nsIUrlListener *aUrlListener,</span>
<a href="#l5.416"></a><span id="l5.416" class="difflineminus">-                                           nsIURI **aURL)</span>
<a href="#l5.417"></a><span id="l5.417" class="difflineminus">-{</span>
<a href="#l5.418"></a><span id="l5.418" class="difflineplus">+NS_IMETHODIMP nsImapService::FetchMimePart(</span>
<a href="#l5.419"></a><span id="l5.419" class="difflineplus">+    nsIURI *aURI, const char *aMessageURI, nsISupports *aDisplayConsumer,</span>
<a href="#l5.420"></a><span id="l5.420" class="difflineplus">+    nsIMsgWindow *aMsgWindow, nsIUrlListener *aUrlListener, nsIURI **aURL) {</span>
<a href="#l5.421"></a><span id="l5.421">   nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l5.422"></a><span id="l5.422">   nsAutoCString messageURI(aMessageURI);</span>
<a href="#l5.423"></a><span id="l5.423">   nsAutoCString msgKey;</span>
<a href="#l5.424"></a><span id="l5.424">   nsAutoCString mimePart;</span>
<a href="#l5.425"></a><span id="l5.425">   nsAutoCString folderURI;</span>
<a href="#l5.426"></a><span id="l5.426">   nsMsgKey key;</span>
<a href="#l5.427"></a><span id="l5.427"> </span>
<a href="#l5.428"></a><span id="l5.428">   nsresult rv = DecomposeImapURI(messageURI, getter_AddRefs(folder), msgKey);</span>
<a href="#l5.429"></a><span id="l5.429">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.430"></a><span id="l5.430" class="difflineminus">-  rv = nsParseImapMessageURI(aMessageURI, folderURI, &amp;key, getter_Copies(mimePart));</span>
<a href="#l5.431"></a><span id="l5.431" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l5.432"></a><span id="l5.432" class="difflineminus">-  {</span>
<a href="#l5.433"></a><span id="l5.433" class="difflineminus">-    nsCOMPtr&lt;nsIImapMessageSink&gt; imapMessageSink(do_QueryInterface(folder, &amp;rv));</span>
<a href="#l5.434"></a><span id="l5.434" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l5.435"></a><span id="l5.435" class="difflineminus">-    {</span>
<a href="#l5.436"></a><span id="l5.436" class="difflineplus">+  rv = nsParseImapMessageURI(aMessageURI, folderURI, &amp;key,</span>
<a href="#l5.437"></a><span id="l5.437" class="difflineplus">+                             getter_Copies(mimePart));</span>
<a href="#l5.438"></a><span id="l5.438" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l5.439"></a><span id="l5.439" class="difflineplus">+    nsCOMPtr&lt;nsIImapMessageSink&gt; imapMessageSink(</span>
<a href="#l5.440"></a><span id="l5.440" class="difflineplus">+        do_QueryInterface(folder, &amp;rv));</span>
<a href="#l5.441"></a><span id="l5.441" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l5.442"></a><span id="l5.442">       nsCOMPtr&lt;nsIImapUrl&gt; imapUrl = do_QueryInterface(aURI);</span>
<a href="#l5.443"></a><span id="l5.443" class="difflineminus">-      nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; msgurl (do_QueryInterface(aURI));</span>
<a href="#l5.444"></a><span id="l5.444" class="difflineplus">+      nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; msgurl(do_QueryInterface(aURI));</span>
<a href="#l5.445"></a><span id="l5.445"> </span>
<a href="#l5.446"></a><span id="l5.446">       msgurl-&gt;SetMsgWindow(aMsgWindow);</span>
<a href="#l5.447"></a><span id="l5.447">       msgurl-&gt;RegisterListener(aUrlListener);</span>
<a href="#l5.448"></a><span id="l5.448"> </span>
<a href="#l5.449"></a><span id="l5.449" class="difflineminus">-      if (!mimePart.IsEmpty())</span>
<a href="#l5.450"></a><span id="l5.450" class="difflineminus">-      {</span>
<a href="#l5.451"></a><span id="l5.451" class="difflineminus">-        return FetchMimePart(imapUrl, nsIImapUrl::nsImapMsgFetch, folder, imapMessageSink,</span>
<a href="#l5.452"></a><span id="l5.452" class="difflineminus">-          aURL, aDisplayConsumer, msgKey, mimePart);</span>
<a href="#l5.453"></a><span id="l5.453" class="difflineplus">+      if (!mimePart.IsEmpty()) {</span>
<a href="#l5.454"></a><span id="l5.454" class="difflineplus">+        return FetchMimePart(imapUrl, nsIImapUrl::nsImapMsgFetch, folder,</span>
<a href="#l5.455"></a><span id="l5.455" class="difflineplus">+                             imapMessageSink, aURL, aDisplayConsumer, msgKey,</span>
<a href="#l5.456"></a><span id="l5.456" class="difflineplus">+                             mimePart);</span>
<a href="#l5.457"></a><span id="l5.457">       }</span>
<a href="#l5.458"></a><span id="l5.458">     }</span>
<a href="#l5.459"></a><span id="l5.459">   }</span>
<a href="#l5.460"></a><span id="l5.460">   return rv;</span>
<a href="#l5.461"></a><span id="l5.461"> }</span>
<a href="#l5.462"></a><span id="l5.462"> </span>
<a href="#l5.463"></a><span id="l5.463"> NS_IMETHODIMP nsImapService::DisplayMessage(const char *aMessageURI,</span>
<a href="#l5.464"></a><span id="l5.464">                                             nsISupports *aDisplayConsumer,</span>
<a href="#l5.465"></a><span id="l5.465">                                             nsIMsgWindow *aMsgWindow,</span>
<a href="#l5.466"></a><span id="l5.466">                                             nsIUrlListener *aUrlListener,</span>
<a href="#l5.467"></a><span id="l5.467">                                             const char *aCharsetOverride,</span>
<a href="#l5.468"></a><span id="l5.468" class="difflineminus">-                                            nsIURI **aURL)</span>
<a href="#l5.469"></a><span id="l5.469" class="difflineminus">-{</span>
<a href="#l5.470"></a><span id="l5.470" class="difflineplus">+                                            nsIURI **aURL) {</span>
<a href="#l5.471"></a><span id="l5.471">   nsresult rv;</span>
<a href="#l5.472"></a><span id="l5.472"> </span>
<a href="#l5.473"></a><span id="l5.473">   nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l5.474"></a><span id="l5.474">   nsAutoCString msgKey;</span>
<a href="#l5.475"></a><span id="l5.475">   nsAutoCString mimePart;</span>
<a href="#l5.476"></a><span id="l5.476">   nsAutoCString folderURI;</span>
<a href="#l5.477"></a><span id="l5.477">   nsMsgKey key;</span>
<a href="#l5.478"></a><span id="l5.478">   nsAutoCString messageURI(aMessageURI);</span>
<a href="#l5.479"></a><span id="l5.479"> </span>
<a href="#l5.480"></a><span id="l5.480">   int32_t typeIndex = messageURI.Find(&quot;&amp;type=application/x-message-display&quot;);</span>
<a href="#l5.481"></a><span id="l5.481" class="difflineminus">-  if (typeIndex != kNotFound)</span>
<a href="#l5.482"></a><span id="l5.482" class="difflineminus">-  {</span>
<a href="#l5.483"></a><span id="l5.483" class="difflineplus">+  if (typeIndex != kNotFound) {</span>
<a href="#l5.484"></a><span id="l5.484">     // This happens with forward inline of a message/rfc822 attachment opened in</span>
<a href="#l5.485"></a><span id="l5.485">     // a standalone msg window.</span>
<a href="#l5.486"></a><span id="l5.486">     // So, just cut to the chase and call AsyncOpen on a channel.</span>
<a href="#l5.487"></a><span id="l5.487">     nsCOMPtr&lt;nsIURI&gt; uri;</span>
<a href="#l5.488"></a><span id="l5.488" class="difflineminus">-    messageURI.Cut(typeIndex, sizeof(&quot;&amp;type=application/x-message-display&quot;) - 1);</span>
<a href="#l5.489"></a><span id="l5.489" class="difflineplus">+    messageURI.Cut(typeIndex,</span>
<a href="#l5.490"></a><span id="l5.490" class="difflineplus">+                   sizeof(&quot;&amp;type=application/x-message-display&quot;) - 1);</span>
<a href="#l5.491"></a><span id="l5.491">     rv = NS_NewURI(getter_AddRefs(uri), messageURI.get());</span>
<a href="#l5.492"></a><span id="l5.492">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.493"></a><span id="l5.493" class="difflineminus">-    if (aURL)</span>
<a href="#l5.494"></a><span id="l5.494" class="difflineminus">-      NS_IF_ADDREF(*aURL = uri);</span>
<a href="#l5.495"></a><span id="l5.495" class="difflineminus">-    nsCOMPtr&lt;nsIStreamListener&gt; aStreamListener = do_QueryInterface(aDisplayConsumer, &amp;rv);</span>
<a href="#l5.496"></a><span id="l5.496" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; aStreamListener)</span>
<a href="#l5.497"></a><span id="l5.497" class="difflineminus">-    {</span>
<a href="#l5.498"></a><span id="l5.498" class="difflineplus">+    if (aURL) NS_IF_ADDREF(*aURL = uri);</span>
<a href="#l5.499"></a><span id="l5.499" class="difflineplus">+    nsCOMPtr&lt;nsIStreamListener&gt; aStreamListener =</span>
<a href="#l5.500"></a><span id="l5.500" class="difflineplus">+        do_QueryInterface(aDisplayConsumer, &amp;rv);</span>
<a href="#l5.501"></a><span id="l5.501" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; aStreamListener) {</span>
<a href="#l5.502"></a><span id="l5.502">       nsCOMPtr&lt;nsIChannel&gt; aChannel;</span>
<a href="#l5.503"></a><span id="l5.503">       nsCOMPtr&lt;nsILoadGroup&gt; aLoadGroup;</span>
<a href="#l5.504"></a><span id="l5.504">       nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsUrl = do_QueryInterface(uri, &amp;rv);</span>
<a href="#l5.505"></a><span id="l5.505">       if (NS_SUCCEEDED(rv) &amp;&amp; mailnewsUrl)</span>
<a href="#l5.506"></a><span id="l5.506">         mailnewsUrl-&gt;GetLoadGroup(getter_AddRefs(aLoadGroup));</span>
<a href="#l5.507"></a><span id="l5.507"> </span>
<a href="#l5.508"></a><span id="l5.508">       nsCOMPtr&lt;nsILoadInfo&gt; loadInfo = new mozilla::net::LoadInfo(</span>
<a href="#l5.509"></a><span id="l5.509" class="difflineminus">-        nsContentUtils::GetSystemPrincipal(),</span>
<a href="#l5.510"></a><span id="l5.510" class="difflineminus">-        nullptr,</span>
<a href="#l5.511"></a><span id="l5.511" class="difflineminus">-        nullptr,</span>
<a href="#l5.512"></a><span id="l5.512" class="difflineminus">-        nsILoadInfo::SEC_ALLOW_CROSS_ORIGIN_DATA_IS_NULL,</span>
<a href="#l5.513"></a><span id="l5.513" class="difflineminus">-        nsIContentPolicy::TYPE_OTHER);</span>
<a href="#l5.514"></a><span id="l5.514" class="difflineplus">+          nsContentUtils::GetSystemPrincipal(), nullptr, nullptr,</span>
<a href="#l5.515"></a><span id="l5.515" class="difflineplus">+          nsILoadInfo::SEC_ALLOW_CROSS_ORIGIN_DATA_IS_NULL,</span>
<a href="#l5.516"></a><span id="l5.516" class="difflineplus">+          nsIContentPolicy::TYPE_OTHER);</span>
<a href="#l5.517"></a><span id="l5.517">       rv = NewChannel(uri, loadInfo, getter_AddRefs(aChannel));</span>
<a href="#l5.518"></a><span id="l5.518">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.519"></a><span id="l5.519"> </span>
<a href="#l5.520"></a><span id="l5.520" class="difflineminus">-      //  now try to open the channel passing in our display consumer as the listener</span>
<a href="#l5.521"></a><span id="l5.521" class="difflineplus">+      //  now try to open the channel passing in our display consumer as the</span>
<a href="#l5.522"></a><span id="l5.522" class="difflineplus">+      //  listener</span>
<a href="#l5.523"></a><span id="l5.523">       rv = aChannel-&gt;AsyncOpen(aStreamListener);</span>
<a href="#l5.524"></a><span id="l5.524">       return rv;</span>
<a href="#l5.525"></a><span id="l5.525">     }</span>
<a href="#l5.526"></a><span id="l5.526">   }</span>
<a href="#l5.527"></a><span id="l5.527"> </span>
<a href="#l5.528"></a><span id="l5.528">   rv = DecomposeImapURI(messageURI, getter_AddRefs(folder), msgKey);</span>
<a href="#l5.529"></a><span id="l5.529">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.530"></a><span id="l5.530" class="difflineminus">-  if (msgKey.IsEmpty())</span>
<a href="#l5.531"></a><span id="l5.531" class="difflineminus">-    return NS_MSG_MESSAGE_NOT_FOUND;</span>
<a href="#l5.532"></a><span id="l5.532" class="difflineminus">-</span>
<a href="#l5.533"></a><span id="l5.533" class="difflineminus">-  rv = nsParseImapMessageURI(aMessageURI, folderURI, &amp;key, getter_Copies(mimePart));</span>
<a href="#l5.534"></a><span id="l5.534" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l5.535"></a><span id="l5.535" class="difflineminus">-  {</span>
<a href="#l5.536"></a><span id="l5.536" class="difflineminus">-    nsCOMPtr&lt;nsIImapMessageSink&gt; imapMessageSink(do_QueryInterface(folder, &amp;rv));</span>
<a href="#l5.537"></a><span id="l5.537" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l5.538"></a><span id="l5.538" class="difflineminus">-    {</span>
<a href="#l5.539"></a><span id="l5.539" class="difflineplus">+  if (msgKey.IsEmpty()) return NS_MSG_MESSAGE_NOT_FOUND;</span>
<a href="#l5.540"></a><span id="l5.540" class="difflineplus">+</span>
<a href="#l5.541"></a><span id="l5.541" class="difflineplus">+  rv = nsParseImapMessageURI(aMessageURI, folderURI, &amp;key,</span>
<a href="#l5.542"></a><span id="l5.542" class="difflineplus">+                             getter_Copies(mimePart));</span>
<a href="#l5.543"></a><span id="l5.543" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l5.544"></a><span id="l5.544" class="difflineplus">+    nsCOMPtr&lt;nsIImapMessageSink&gt; imapMessageSink(</span>
<a href="#l5.545"></a><span id="l5.545" class="difflineplus">+        do_QueryInterface(folder, &amp;rv));</span>
<a href="#l5.546"></a><span id="l5.546" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l5.547"></a><span id="l5.547">       nsCOMPtr&lt;nsIImapUrl&gt; imapUrl;</span>
<a href="#l5.548"></a><span id="l5.548">       nsAutoCString urlSpec;</span>
<a href="#l5.549"></a><span id="l5.549">       char hierarchyDelimiter = GetHierarchyDelimiter(folder);</span>
<a href="#l5.550"></a><span id="l5.550" class="difflineminus">-      rv = CreateStartOfImapUrl(messageURI, getter_AddRefs(imapUrl), folder, aUrlListener, urlSpec, hierarchyDelimiter);</span>
<a href="#l5.551"></a><span id="l5.551" class="difflineplus">+      rv = CreateStartOfImapUrl(messageURI, getter_AddRefs(imapUrl), folder,</span>
<a href="#l5.552"></a><span id="l5.552" class="difflineplus">+                                aUrlListener, urlSpec, hierarchyDelimiter);</span>
<a href="#l5.553"></a><span id="l5.553">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.554"></a><span id="l5.554" class="difflineminus">-      if (!mimePart.IsEmpty())</span>
<a href="#l5.555"></a><span id="l5.555" class="difflineminus">-      {</span>
<a href="#l5.556"></a><span id="l5.556" class="difflineplus">+      if (!mimePart.IsEmpty()) {</span>
<a href="#l5.557"></a><span id="l5.557">         nsresult rv;</span>
<a href="#l5.558"></a><span id="l5.558">         nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsurl = do_QueryInterface(imapUrl);</span>
<a href="#l5.559"></a><span id="l5.559"> </span>
<a href="#l5.560"></a><span id="l5.560" class="difflineminus">-        rv = AddImapFetchToUrl(mailnewsurl, folder, msgKey + mimePart, EmptyCString());</span>
<a href="#l5.561"></a><span id="l5.561" class="difflineplus">+        rv = AddImapFetchToUrl(mailnewsurl, folder, msgKey + mimePart,</span>
<a href="#l5.562"></a><span id="l5.562" class="difflineplus">+                               EmptyCString());</span>
<a href="#l5.563"></a><span id="l5.563">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.564"></a><span id="l5.564"> </span>
<a href="#l5.565"></a><span id="l5.565" class="difflineminus">-        return FetchMimePart(imapUrl, nsIImapUrl::nsImapMsgFetch, folder, imapMessageSink,</span>
<a href="#l5.566"></a><span id="l5.566" class="difflineminus">-                             aURL, aDisplayConsumer, msgKey, mimePart);</span>
<a href="#l5.567"></a><span id="l5.567" class="difflineplus">+        return FetchMimePart(imapUrl, nsIImapUrl::nsImapMsgFetch, folder,</span>
<a href="#l5.568"></a><span id="l5.568" class="difflineplus">+                             imapMessageSink, aURL, aDisplayConsumer, msgKey,</span>
<a href="#l5.569"></a><span id="l5.569" class="difflineplus">+                             mimePart);</span>
<a href="#l5.570"></a><span id="l5.570">       }</span>
<a href="#l5.571"></a><span id="l5.571"> </span>
<a href="#l5.572"></a><span id="l5.572" class="difflineminus">-      nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; msgurl (do_QueryInterface(imapUrl));</span>
<a href="#l5.573"></a><span id="l5.573" class="difflineminus">-      nsCOMPtr&lt;nsIMsgI18NUrl&gt; i18nurl (do_QueryInterface(imapUrl));</span>
<a href="#l5.574"></a><span id="l5.574" class="difflineplus">+      nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; msgurl(do_QueryInterface(imapUrl));</span>
<a href="#l5.575"></a><span id="l5.575" class="difflineplus">+      nsCOMPtr&lt;nsIMsgI18NUrl&gt; i18nurl(do_QueryInterface(imapUrl));</span>
<a href="#l5.576"></a><span id="l5.576">       i18nurl-&gt;SetCharsetOverRide(aCharsetOverride);</span>
<a href="#l5.577"></a><span id="l5.577"> </span>
<a href="#l5.578"></a><span id="l5.578">       uint32_t messageSize;</span>
<a href="#l5.579"></a><span id="l5.579">       bool useMimePartsOnDemand = gMIMEOnDemand;</span>
<a href="#l5.580"></a><span id="l5.580">       bool shouldStoreMsgOffline = false;</span>
<a href="#l5.581"></a><span id="l5.581">       bool hasMsgOffline = false;</span>
<a href="#l5.582"></a><span id="l5.582"> </span>
<a href="#l5.583"></a><span id="l5.583">       nsCOMPtr&lt;nsIMsgIncomingServer&gt; aMsgIncomingServer;</span>
<a href="#l5.584"></a><span id="l5.584"> </span>
<a href="#l5.585"></a><span id="l5.585">       if (imapMessageSink)</span>
<a href="#l5.586"></a><span id="l5.586">         imapMessageSink-&gt;GetMessageSizeFromDB(msgKey.get(), &amp;messageSize);</span>
<a href="#l5.587"></a><span id="l5.587"> </span>
<a href="#l5.588"></a><span id="l5.588">       msgurl-&gt;SetMsgWindow(aMsgWindow);</span>
<a href="#l5.589"></a><span id="l5.589"> </span>
<a href="#l5.590"></a><span id="l5.590">       rv = msgurl-&gt;GetServer(getter_AddRefs(aMsgIncomingServer));</span>
<a href="#l5.591"></a><span id="l5.591"> </span>
<a href="#l5.592"></a><span id="l5.592" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp; aMsgIncomingServer)</span>
<a href="#l5.593"></a><span id="l5.593" class="difflineminus">-      {</span>
<a href="#l5.594"></a><span id="l5.594" class="difflineminus">-        nsCOMPtr&lt;nsIImapIncomingServer&gt; aImapServer(do_QueryInterface(aMsgIncomingServer, &amp;rv));</span>
<a href="#l5.595"></a><span id="l5.595" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; aMsgIncomingServer) {</span>
<a href="#l5.596"></a><span id="l5.596" class="difflineplus">+        nsCOMPtr&lt;nsIImapIncomingServer&gt; aImapServer(</span>
<a href="#l5.597"></a><span id="l5.597" class="difflineplus">+            do_QueryInterface(aMsgIncomingServer, &amp;rv));</span>
<a href="#l5.598"></a><span id="l5.598">         if (NS_SUCCEEDED(rv) &amp;&amp; aImapServer)</span>
<a href="#l5.599"></a><span id="l5.599">           aImapServer-&gt;GetMimePartsOnDemand(&amp;useMimePartsOnDemand);</span>
<a href="#l5.600"></a><span id="l5.600">       }</span>
<a href="#l5.601"></a><span id="l5.601"> </span>
<a href="#l5.602"></a><span id="l5.602">       nsAutoCString uriStr(aMessageURI);</span>
<a href="#l5.603"></a><span id="l5.603">       int32_t keySeparator = uriStr.RFindChar('#');</span>
<a href="#l5.604"></a><span id="l5.604" class="difflineminus">-      if(keySeparator != -1)</span>
<a href="#l5.605"></a><span id="l5.605" class="difflineminus">-      {</span>
<a href="#l5.606"></a><span id="l5.606" class="difflineplus">+      if (keySeparator != -1) {</span>
<a href="#l5.607"></a><span id="l5.607">         int32_t keyEndSeparator = MsgFindCharInSet(uriStr, &quot;/?&amp;&quot;, keySeparator);</span>
<a href="#l5.608"></a><span id="l5.608" class="difflineminus">-        int32_t mpodFetchPos = MsgFind(uriStr, &quot;fetchCompleteMessage=true&quot;, false, keyEndSeparator);</span>
<a href="#l5.609"></a><span id="l5.609" class="difflineminus">-        if (mpodFetchPos != -1)</span>
<a href="#l5.610"></a><span id="l5.610" class="difflineminus">-          useMimePartsOnDemand = false;</span>
<a href="#l5.611"></a><span id="l5.611" class="difflineplus">+        int32_t mpodFetchPos = MsgFind(uriStr, &quot;fetchCompleteMessage=true&quot;,</span>
<a href="#l5.612"></a><span id="l5.612" class="difflineplus">+                                       false, keyEndSeparator);</span>
<a href="#l5.613"></a><span id="l5.613" class="difflineplus">+        if (mpodFetchPos != -1) useMimePartsOnDemand = false;</span>
<a href="#l5.614"></a><span id="l5.614">       }</span>
<a href="#l5.615"></a><span id="l5.615"> </span>
<a href="#l5.616"></a><span id="l5.616" class="difflineminus">-      if (folder)</span>
<a href="#l5.617"></a><span id="l5.617" class="difflineminus">-      {</span>
<a href="#l5.618"></a><span id="l5.618" class="difflineplus">+      if (folder) {</span>
<a href="#l5.619"></a><span id="l5.619">         folder-&gt;ShouldStoreMsgOffline(key, &amp;shouldStoreMsgOffline);</span>
<a href="#l5.620"></a><span id="l5.620">         folder-&gt;HasMsgOffline(key, &amp;hasMsgOffline);</span>
<a href="#l5.621"></a><span id="l5.621">       }</span>
<a href="#l5.622"></a><span id="l5.622">       imapUrl-&gt;SetStoreResultsOffline(shouldStoreMsgOffline);</span>
<a href="#l5.623"></a><span id="l5.623" class="difflineminus">-      imapUrl-&gt;SetFetchPartsOnDemand(</span>
<a href="#l5.624"></a><span id="l5.624" class="difflineminus">-        useMimePartsOnDemand &amp;&amp; messageSize &gt;= (uint32_t) gMIMEOnDemandThreshold);</span>
<a href="#l5.625"></a><span id="l5.625" class="difflineminus">-</span>
<a href="#l5.626"></a><span id="l5.626" class="difflineminus">-      if (hasMsgOffline)</span>
<a href="#l5.627"></a><span id="l5.627" class="difflineminus">-        msgurl-&gt;SetMsgIsInLocalCache(true);</span>
<a href="#l5.628"></a><span id="l5.628" class="difflineminus">-</span>
<a href="#l5.629"></a><span id="l5.629" class="difflineminus">-      nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l5.630"></a><span id="l5.630" class="difflineplus">+      imapUrl-&gt;SetFetchPartsOnDemand(useMimePartsOnDemand &amp;&amp;</span>
<a href="#l5.631"></a><span id="l5.631" class="difflineplus">+                                     messageSize &gt;=</span>
<a href="#l5.632"></a><span id="l5.632" class="difflineplus">+                                         (uint32_t)gMIMEOnDemandThreshold);</span>
<a href="#l5.633"></a><span id="l5.633" class="difflineplus">+</span>
<a href="#l5.634"></a><span id="l5.634" class="difflineplus">+      if (hasMsgOffline) msgurl-&gt;SetMsgIsInLocalCache(true);</span>
<a href="#l5.635"></a><span id="l5.635" class="difflineplus">+</span>
<a href="#l5.636"></a><span id="l5.636" class="difflineplus">+      nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(</span>
<a href="#l5.637"></a><span id="l5.637" class="difflineplus">+          do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l5.638"></a><span id="l5.638">       // Should the message fetch force a peek or a traditional fetch?</span>
<a href="#l5.639"></a><span id="l5.639" class="difflineminus">-      // Force peek if there is a delay in marking read (or no auto-marking at all).</span>
<a href="#l5.640"></a><span id="l5.640" class="difflineminus">-      // This is because a FETCH (BODY[]) will implicitly set the \Seen flag on the msg,</span>
<a href="#l5.641"></a><span id="l5.641" class="difflineminus">-      // but a FETCH (BODY.PEEK[]) won't.</span>
<a href="#l5.642"></a><span id="l5.642" class="difflineplus">+      // Force peek if there is a delay in marking read (or no auto-marking at</span>
<a href="#l5.643"></a><span id="l5.643" class="difflineplus">+      // all). This is because a FETCH (BODY[]) will implicitly set the \Seen</span>
<a href="#l5.644"></a><span id="l5.644" class="difflineplus">+      // flag on the msg, but a FETCH (BODY.PEEK[]) won't.</span>
<a href="#l5.645"></a><span id="l5.645">       bool forcePeek = false;</span>
<a href="#l5.646"></a><span id="l5.646" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp; prefBranch)</span>
<a href="#l5.647"></a><span id="l5.647" class="difflineminus">-      {</span>
<a href="#l5.648"></a><span id="l5.648" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; prefBranch) {</span>
<a href="#l5.649"></a><span id="l5.649">         int32_t dontMarkAsReadPos = uriStr.Find(&quot;&amp;markRead=false&quot;);</span>
<a href="#l5.650"></a><span id="l5.650">         bool markReadAuto = true;</span>
<a href="#l5.651"></a><span id="l5.651" class="difflineminus">-        prefBranch-&gt;GetBoolPref(&quot;mailnews.mark_message_read.auto&quot;, &amp;markReadAuto);</span>
<a href="#l5.652"></a><span id="l5.652" class="difflineplus">+        prefBranch-&gt;GetBoolPref(&quot;mailnews.mark_message_read.auto&quot;,</span>
<a href="#l5.653"></a><span id="l5.653" class="difflineplus">+                                &amp;markReadAuto);</span>
<a href="#l5.654"></a><span id="l5.654">         bool markReadDelay = false;</span>
<a href="#l5.655"></a><span id="l5.655" class="difflineminus">-        prefBranch-&gt;GetBoolPref(&quot;mailnews.mark_message_read.delay&quot;, &amp;markReadDelay);</span>
<a href="#l5.656"></a><span id="l5.656" class="difflineminus">-        forcePeek = (!markReadAuto || markReadDelay || (dontMarkAsReadPos != kNotFound));</span>
<a href="#l5.657"></a><span id="l5.657" class="difflineplus">+        prefBranch-&gt;GetBoolPref(&quot;mailnews.mark_message_read.delay&quot;,</span>
<a href="#l5.658"></a><span id="l5.658" class="difflineplus">+                                &amp;markReadDelay);</span>
<a href="#l5.659"></a><span id="l5.659" class="difflineplus">+        forcePeek = (!markReadAuto || markReadDelay ||</span>
<a href="#l5.660"></a><span id="l5.660" class="difflineplus">+                     (dontMarkAsReadPos != kNotFound));</span>
<a href="#l5.661"></a><span id="l5.661">       }</span>
<a href="#l5.662"></a><span id="l5.662"> </span>
<a href="#l5.663"></a><span id="l5.663" class="difflineminus">-      rv = FetchMessage(imapUrl, forcePeek ? nsIImapUrl::nsImapMsgFetchPeek : nsIImapUrl::nsImapMsgFetch,</span>
<a href="#l5.664"></a><span id="l5.664" class="difflineminus">-                        folder, imapMessageSink, aMsgWindow, aDisplayConsumer, msgKey, false,</span>
<a href="#l5.665"></a><span id="l5.665" class="difflineminus">-                        (mPrintingOperation) ? NS_LITERAL_CSTRING(&quot;print&quot;) : NS_LITERAL_CSTRING(&quot;&quot;), aURL);</span>
<a href="#l5.666"></a><span id="l5.666" class="difflineplus">+      rv = FetchMessage(imapUrl,</span>
<a href="#l5.667"></a><span id="l5.667" class="difflineplus">+                        forcePeek ? nsIImapUrl::nsImapMsgFetchPeek</span>
<a href="#l5.668"></a><span id="l5.668" class="difflineplus">+                                  : nsIImapUrl::nsImapMsgFetch,</span>
<a href="#l5.669"></a><span id="l5.669" class="difflineplus">+                        folder, imapMessageSink, aMsgWindow, aDisplayConsumer,</span>
<a href="#l5.670"></a><span id="l5.670" class="difflineplus">+                        msgKey, false,</span>
<a href="#l5.671"></a><span id="l5.671" class="difflineplus">+                        (mPrintingOperation) ? NS_LITERAL_CSTRING(&quot;print&quot;)</span>
<a href="#l5.672"></a><span id="l5.672" class="difflineplus">+                                             : NS_LITERAL_CSTRING(&quot;&quot;),</span>
<a href="#l5.673"></a><span id="l5.673" class="difflineplus">+                        aURL);</span>
<a href="#l5.674"></a><span id="l5.674">     }</span>
<a href="#l5.675"></a><span id="l5.675">   }</span>
<a href="#l5.676"></a><span id="l5.676">   return rv;</span>
<a href="#l5.677"></a><span id="l5.677"> }</span>
<a href="#l5.678"></a><span id="l5.678"> </span>
<a href="#l5.679"></a><span id="l5.679" class="difflineminus">-</span>
<a href="#l5.680"></a><span id="l5.680" class="difflineminus">-nsresult nsImapService::FetchMimePart(nsIImapUrl *aImapUrl,</span>
<a href="#l5.681"></a><span id="l5.681" class="difflineminus">-                                      nsImapAction aImapAction,</span>
<a href="#l5.682"></a><span id="l5.682" class="difflineminus">-                                      nsIMsgFolder *aImapMailFolder,</span>
<a href="#l5.683"></a><span id="l5.683" class="difflineminus">-                                      nsIImapMessageSink *aImapMessage,</span>
<a href="#l5.684"></a><span id="l5.684" class="difflineminus">-                                      nsIURI **aURL,</span>
<a href="#l5.685"></a><span id="l5.685" class="difflineminus">-                                      nsISupports *aDisplayConsumer,</span>
<a href="#l5.686"></a><span id="l5.686" class="difflineminus">-                                      const nsACString &amp;messageIdentifierList,</span>
<a href="#l5.687"></a><span id="l5.687" class="difflineminus">-                                      const nsACString &amp;mimePart)</span>
<a href="#l5.688"></a><span id="l5.688" class="difflineminus">-{</span>
<a href="#l5.689"></a><span id="l5.689" class="difflineplus">+nsresult nsImapService::FetchMimePart(</span>
<a href="#l5.690"></a><span id="l5.690" class="difflineplus">+    nsIImapUrl *aImapUrl, nsImapAction aImapAction,</span>
<a href="#l5.691"></a><span id="l5.691" class="difflineplus">+    nsIMsgFolder *aImapMailFolder, nsIImapMessageSink *aImapMessage,</span>
<a href="#l5.692"></a><span id="l5.692" class="difflineplus">+    nsIURI **aURL, nsISupports *aDisplayConsumer,</span>
<a href="#l5.693"></a><span id="l5.693" class="difflineplus">+    const nsACString &amp;messageIdentifierList, const nsACString &amp;mimePart) {</span>
<a href="#l5.694"></a><span id="l5.694">   NS_ENSURE_ARG_POINTER(aImapUrl);</span>
<a href="#l5.695"></a><span id="l5.695">   NS_ENSURE_ARG_POINTER(aImapMailFolder);</span>
<a href="#l5.696"></a><span id="l5.696">   NS_ENSURE_ARG_POINTER(aImapMessage);</span>
<a href="#l5.697"></a><span id="l5.697"> </span>
<a href="#l5.698"></a><span id="l5.698">   // create a protocol instance to handle the request.</span>
<a href="#l5.699"></a><span id="l5.699" class="difflineminus">-  // NOTE: once we start working with multiple connections, this step will be much more complicated...but for now</span>
<a href="#l5.700"></a><span id="l5.700" class="difflineminus">-  // just create a connection and process the request.</span>
<a href="#l5.701"></a><span id="l5.701" class="difflineplus">+  // NOTE: once we start working with multiple connections, this step will be</span>
<a href="#l5.702"></a><span id="l5.702" class="difflineplus">+  // much more complicated...but for now just create a connection and process</span>
<a href="#l5.703"></a><span id="l5.703" class="difflineplus">+  // the request.</span>
<a href="#l5.704"></a><span id="l5.704">   nsAutoCString urlSpec;</span>
<a href="#l5.705"></a><span id="l5.705">   nsresult rv = SetImapUrlSink(aImapMailFolder, aImapUrl);</span>
<a href="#l5.706"></a><span id="l5.706">   nsImapAction actionToUse = aImapAction;</span>
<a href="#l5.707"></a><span id="l5.707">   if (actionToUse == nsImapUrl::nsImapOpenMimePart)</span>
<a href="#l5.708"></a><span id="l5.708">     actionToUse = nsIImapUrl::nsImapMsgFetch;</span>
<a href="#l5.709"></a><span id="l5.709"> </span>
<a href="#l5.710"></a><span id="l5.710" class="difflineminus">-  nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; msgurl (do_QueryInterface(aImapUrl));</span>
<a href="#l5.711"></a><span id="l5.711" class="difflineminus">-  if (aImapMailFolder &amp;&amp; msgurl &amp;&amp; !messageIdentifierList.IsEmpty())</span>
<a href="#l5.712"></a><span id="l5.712" class="difflineminus">-  {</span>
<a href="#l5.713"></a><span id="l5.713" class="difflineplus">+  nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; msgurl(do_QueryInterface(aImapUrl));</span>
<a href="#l5.714"></a><span id="l5.714" class="difflineplus">+  if (aImapMailFolder &amp;&amp; msgurl &amp;&amp; !messageIdentifierList.IsEmpty()) {</span>
<a href="#l5.715"></a><span id="l5.715">     bool useLocalCache = false;</span>
<a href="#l5.716"></a><span id="l5.716" class="difflineminus">-    aImapMailFolder-&gt;HasMsgOffline(strtoul(nsCString(messageIdentifierList).get(), nullptr, 10),</span>
<a href="#l5.717"></a><span id="l5.717" class="difflineminus">-                                   &amp;useLocalCache);</span>
<a href="#l5.718"></a><span id="l5.718" class="difflineplus">+    aImapMailFolder-&gt;HasMsgOffline(</span>
<a href="#l5.719"></a><span id="l5.719" class="difflineplus">+        strtoul(nsCString(messageIdentifierList).get(), nullptr, 10),</span>
<a href="#l5.720"></a><span id="l5.720" class="difflineplus">+        &amp;useLocalCache);</span>
<a href="#l5.721"></a><span id="l5.721">     msgurl-&gt;SetMsgIsInLocalCache(useLocalCache);</span>
<a href="#l5.722"></a><span id="l5.722">   }</span>
<a href="#l5.723"></a><span id="l5.723">   rv = aImapUrl-&gt;SetImapMessageSink(aImapMessage);</span>
<a href="#l5.724"></a><span id="l5.724" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l5.725"></a><span id="l5.725" class="difflineminus">-  {</span>
<a href="#l5.726"></a><span id="l5.726" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l5.727"></a><span id="l5.727">     nsCOMPtr&lt;nsIURI&gt; url = do_QueryInterface(aImapUrl);</span>
<a href="#l5.728"></a><span id="l5.728" class="difflineminus">-    if (aURL)</span>
<a href="#l5.729"></a><span id="l5.729" class="difflineminus">-      NS_IF_ADDREF(*aURL = url);</span>
<a href="#l5.730"></a><span id="l5.730" class="difflineplus">+    if (aURL) NS_IF_ADDREF(*aURL = url);</span>
<a href="#l5.731"></a><span id="l5.731"> </span>
<a href="#l5.732"></a><span id="l5.732">     rv = url-&gt;GetSpec(urlSpec);</span>
<a href="#l5.733"></a><span id="l5.733">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.734"></a><span id="l5.734"> </span>
<a href="#l5.735"></a><span id="l5.735">     // rhp: If we are displaying this message for the purpose of printing, we</span>
<a href="#l5.736"></a><span id="l5.736">     // need to append the header=print option.</span>
<a href="#l5.737"></a><span id="l5.737">     //</span>
<a href="#l5.738"></a><span id="l5.738" class="difflineminus">-    if (mPrintingOperation)</span>
<a href="#l5.739"></a><span id="l5.739" class="difflineminus">-      urlSpec.AppendLiteral(&quot;?header=print&quot;);</span>
<a href="#l5.740"></a><span id="l5.740" class="difflineplus">+    if (mPrintingOperation) urlSpec.AppendLiteral(&quot;?header=print&quot;);</span>
<a href="#l5.741"></a><span id="l5.741"> </span>
<a href="#l5.742"></a><span id="l5.742">     rv = msgurl-&gt;SetSpecInternal(urlSpec);</span>
<a href="#l5.743"></a><span id="l5.743">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.744"></a><span id="l5.744"> </span>
<a href="#l5.745"></a><span id="l5.745">     rv = aImapUrl-&gt;SetImapAction(actionToUse /* nsIImapUrl::nsImapMsgFetch */);</span>
<a href="#l5.746"></a><span id="l5.746" class="difflineminus">-    if (aImapMailFolder &amp;&amp; aDisplayConsumer)</span>
<a href="#l5.747"></a><span id="l5.747" class="difflineminus">-    {</span>
<a href="#l5.748"></a><span id="l5.748" class="difflineplus">+    if (aImapMailFolder &amp;&amp; aDisplayConsumer) {</span>
<a href="#l5.749"></a><span id="l5.749">       nsCOMPtr&lt;nsIMsgIncomingServer&gt; aMsgIncomingServer;</span>
<a href="#l5.750"></a><span id="l5.750">       rv = aImapMailFolder-&gt;GetServer(getter_AddRefs(aMsgIncomingServer));</span>
<a href="#l5.751"></a><span id="l5.751" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp; aMsgIncomingServer)</span>
<a href="#l5.752"></a><span id="l5.752" class="difflineminus">-      {</span>
<a href="#l5.753"></a><span id="l5.753" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; aMsgIncomingServer) {</span>
<a href="#l5.754"></a><span id="l5.754">         bool interrupted;</span>
<a href="#l5.755"></a><span id="l5.755" class="difflineminus">-        nsCOMPtr&lt;nsIImapIncomingServer&gt;</span>
<a href="#l5.756"></a><span id="l5.756" class="difflineminus">-          aImapServer(do_QueryInterface(aMsgIncomingServer, &amp;rv));</span>
<a href="#l5.757"></a><span id="l5.757" class="difflineplus">+        nsCOMPtr&lt;nsIImapIncomingServer&gt; aImapServer(</span>
<a href="#l5.758"></a><span id="l5.758" class="difflineplus">+            do_QueryInterface(aMsgIncomingServer, &amp;rv));</span>
<a href="#l5.759"></a><span id="l5.759">         if (NS_SUCCEEDED(rv) &amp;&amp; aImapServer)</span>
<a href="#l5.760"></a><span id="l5.760" class="difflineminus">-          aImapServer-&gt;PseudoInterruptMsgLoad(aImapMailFolder, nullptr, &amp;interrupted);</span>
<a href="#l5.761"></a><span id="l5.761" class="difflineplus">+          aImapServer-&gt;PseudoInterruptMsgLoad(aImapMailFolder, nullptr,</span>
<a href="#l5.762"></a><span id="l5.762" class="difflineplus">+                                              &amp;interrupted);</span>
<a href="#l5.763"></a><span id="l5.763">       }</span>
<a href="#l5.764"></a><span id="l5.764">     }</span>
<a href="#l5.765"></a><span id="l5.765" class="difflineminus">-    // if the display consumer is a docshell, then we should run the url in the docshell.</span>
<a href="#l5.766"></a><span id="l5.766" class="difflineminus">-    // otherwise, it should be a stream listener....so open a channel using AsyncRead</span>
<a href="#l5.767"></a><span id="l5.767" class="difflineminus">-    // and the provided stream listener....</span>
<a href="#l5.768"></a><span id="l5.768" class="difflineplus">+    // if the display consumer is a docshell, then we should run the url in the</span>
<a href="#l5.769"></a><span id="l5.769" class="difflineplus">+    // docshell. otherwise, it should be a stream listener....so open a channel</span>
<a href="#l5.770"></a><span id="l5.770" class="difflineplus">+    // using AsyncRead and the provided stream listener....</span>
<a href="#l5.771"></a><span id="l5.771"> </span>
<a href="#l5.772"></a><span id="l5.772">     nsCOMPtr&lt;nsIDocShell&gt; docShell(do_QueryInterface(aDisplayConsumer, &amp;rv));</span>
<a href="#l5.773"></a><span id="l5.773" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; docShell)</span>
<a href="#l5.774"></a><span id="l5.774" class="difflineminus">-    {</span>
<a href="#l5.775"></a><span id="l5.775" class="difflineminus">-      // DIRTY LITTLE HACK --&gt; if we are opening an attachment we want the docshell to</span>
<a href="#l5.776"></a><span id="l5.776" class="difflineminus">-      // treat this load as if it were a user click event. Then the dispatching stuff will be much</span>
<a href="#l5.777"></a><span id="l5.777" class="difflineminus">-      // happier.</span>
<a href="#l5.778"></a><span id="l5.778" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; docShell) {</span>
<a href="#l5.779"></a><span id="l5.779" class="difflineplus">+      // DIRTY LITTLE HACK --&gt; if we are opening an attachment we want the</span>
<a href="#l5.780"></a><span id="l5.780" class="difflineplus">+      // docshell to treat this load as if it were a user click event. Then the</span>
<a href="#l5.781"></a><span id="l5.781" class="difflineplus">+      // dispatching stuff will be much happier.</span>
<a href="#l5.782"></a><span id="l5.782">       RefPtr&lt;nsDocShellLoadState&gt; loadState = new nsDocShellLoadState(url);</span>
<a href="#l5.783"></a><span id="l5.783">       loadState-&gt;SetLoadFlags(aImapAction == nsImapUrl::nsImapOpenMimePart</span>
<a href="#l5.784"></a><span id="l5.784" class="difflineminus">-                                ? nsIWebNavigation::LOAD_FLAGS_IS_LINK</span>
<a href="#l5.785"></a><span id="l5.785" class="difflineminus">-                                : nsIWebNavigation::LOAD_FLAGS_NONE);</span>
<a href="#l5.786"></a><span id="l5.786" class="difflineplus">+                                  ? nsIWebNavigation::LOAD_FLAGS_IS_LINK</span>
<a href="#l5.787"></a><span id="l5.787" class="difflineplus">+                                  : nsIWebNavigation::LOAD_FLAGS_NONE);</span>
<a href="#l5.788"></a><span id="l5.788">       if (aImapAction == nsImapUrl::nsImapOpenMimePart)</span>
<a href="#l5.789"></a><span id="l5.789">         loadState-&gt;SetLoadType(LOAD_LINK);</span>
<a href="#l5.790"></a><span id="l5.790">       loadState-&gt;SetFirstParty(false);</span>
<a href="#l5.791"></a><span id="l5.791">       loadState-&gt;SetTriggeringPrincipal(nsContentUtils::GetSystemPrincipal());</span>
<a href="#l5.792"></a><span id="l5.792">       rv = docShell-&gt;LoadURI(loadState);</span>
<a href="#l5.793"></a><span id="l5.793" class="difflineminus">-    }</span>
<a href="#l5.794"></a><span id="l5.794" class="difflineminus">-    else</span>
<a href="#l5.795"></a><span id="l5.795" class="difflineminus">-    {</span>
<a href="#l5.796"></a><span id="l5.796" class="difflineminus">-      nsCOMPtr&lt;nsIStreamListener&gt; aStreamListener = do_QueryInterface(aDisplayConsumer, &amp;rv);</span>
<a href="#l5.797"></a><span id="l5.797" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp; aStreamListener)</span>
<a href="#l5.798"></a><span id="l5.798" class="difflineminus">-      {</span>
<a href="#l5.799"></a><span id="l5.799" class="difflineplus">+    } else {</span>
<a href="#l5.800"></a><span id="l5.800" class="difflineplus">+      nsCOMPtr&lt;nsIStreamListener&gt; aStreamListener =</span>
<a href="#l5.801"></a><span id="l5.801" class="difflineplus">+          do_QueryInterface(aDisplayConsumer, &amp;rv);</span>
<a href="#l5.802"></a><span id="l5.802" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; aStreamListener) {</span>
<a href="#l5.803"></a><span id="l5.803">         nsCOMPtr&lt;nsIChannel&gt; aChannel;</span>
<a href="#l5.804"></a><span id="l5.804">         nsCOMPtr&lt;nsILoadGroup&gt; loadGroup;</span>
<a href="#l5.805"></a><span id="l5.805" class="difflineminus">-        nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsUrl = do_QueryInterface(aImapUrl, &amp;rv);</span>
<a href="#l5.806"></a><span id="l5.806" class="difflineplus">+        nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsUrl =</span>
<a href="#l5.807"></a><span id="l5.807" class="difflineplus">+            do_QueryInterface(aImapUrl, &amp;rv);</span>
<a href="#l5.808"></a><span id="l5.808">         if (NS_SUCCEEDED(rv) &amp;&amp; mailnewsUrl)</span>
<a href="#l5.809"></a><span id="l5.809">           mailnewsUrl-&gt;GetLoadGroup(getter_AddRefs(loadGroup));</span>
<a href="#l5.810"></a><span id="l5.810"> </span>
<a href="#l5.811"></a><span id="l5.811">         nsCOMPtr&lt;nsILoadInfo&gt; loadInfo = new mozilla::net::LoadInfo(</span>
<a href="#l5.812"></a><span id="l5.812" class="difflineminus">-          nsContentUtils::GetSystemPrincipal(),</span>
<a href="#l5.813"></a><span id="l5.813" class="difflineminus">-          nullptr,</span>
<a href="#l5.814"></a><span id="l5.814" class="difflineminus">-          nullptr,</span>
<a href="#l5.815"></a><span id="l5.815" class="difflineminus">-          nsILoadInfo::SEC_ALLOW_CROSS_ORIGIN_DATA_IS_NULL,</span>
<a href="#l5.816"></a><span id="l5.816" class="difflineminus">-          nsIContentPolicy::TYPE_OTHER);</span>
<a href="#l5.817"></a><span id="l5.817" class="difflineplus">+            nsContentUtils::GetSystemPrincipal(), nullptr, nullptr,</span>
<a href="#l5.818"></a><span id="l5.818" class="difflineplus">+            nsILoadInfo::SEC_ALLOW_CROSS_ORIGIN_DATA_IS_NULL,</span>
<a href="#l5.819"></a><span id="l5.819" class="difflineplus">+            nsIContentPolicy::TYPE_OTHER);</span>
<a href="#l5.820"></a><span id="l5.820">         rv = NewChannel(url, loadInfo, getter_AddRefs(aChannel));</span>
<a href="#l5.821"></a><span id="l5.821">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.822"></a><span id="l5.822"> </span>
<a href="#l5.823"></a><span id="l5.823" class="difflineminus">-        // we need a load group to hold onto the channel. When the request is finished,</span>
<a href="#l5.824"></a><span id="l5.824" class="difflineminus">-        // it'll get removed from the load group, and the channel will go away,</span>
<a href="#l5.825"></a><span id="l5.825" class="difflineminus">-        // which will free the load group.</span>
<a href="#l5.826"></a><span id="l5.826" class="difflineminus">-        if (!loadGroup)</span>
<a href="#l5.827"></a><span id="l5.827" class="difflineminus">-          loadGroup = do_CreateInstance(NS_LOADGROUP_CONTRACTID);</span>
<a href="#l5.828"></a><span id="l5.828" class="difflineplus">+        // we need a load group to hold onto the channel. When the request is</span>
<a href="#l5.829"></a><span id="l5.829" class="difflineplus">+        // finished, it'll get removed from the load group, and the channel will</span>
<a href="#l5.830"></a><span id="l5.830" class="difflineplus">+        // go away, which will free the load group.</span>
<a href="#l5.831"></a><span id="l5.831" class="difflineplus">+        if (!loadGroup) loadGroup = do_CreateInstance(NS_LOADGROUP_CONTRACTID);</span>
<a href="#l5.832"></a><span id="l5.832"> </span>
<a href="#l5.833"></a><span id="l5.833">         aChannel-&gt;SetLoadGroup(loadGroup);</span>
<a href="#l5.834"></a><span id="l5.834"> </span>
<a href="#l5.835"></a><span id="l5.835" class="difflineminus">-        //  now try to open the channel passing in our display consumer as the listener</span>
<a href="#l5.836"></a><span id="l5.836" class="difflineplus">+        //  now try to open the channel passing in our display consumer as the</span>
<a href="#l5.837"></a><span id="l5.837" class="difflineplus">+        //  listener</span>
<a href="#l5.838"></a><span id="l5.838">         rv = aChannel-&gt;AsyncOpen(aStreamListener);</span>
<a href="#l5.839"></a><span id="l5.839" class="difflineminus">-      }</span>
<a href="#l5.840"></a><span id="l5.840" class="difflineminus">-      else // do what we used to do before</span>
<a href="#l5.841"></a><span id="l5.841" class="difflineplus">+      } else  // do what we used to do before</span>
<a href="#l5.842"></a><span id="l5.842">       {</span>
<a href="#l5.843"></a><span id="l5.843" class="difflineminus">-        // I'd like to get rid of this code as I believe that we always get a docshell</span>
<a href="#l5.844"></a><span id="l5.844" class="difflineminus">-        // or stream listener passed into us in this method but i'm not sure yet...</span>
<a href="#l5.845"></a><span id="l5.845" class="difflineminus">-        // I'm going to use an assert for now to figure out if this is ever getting called</span>
<a href="#l5.846"></a><span id="l5.846" class="difflineplus">+        // I'd like to get rid of this code as I believe that we always get a</span>
<a href="#l5.847"></a><span id="l5.847" class="difflineplus">+        // docshell or stream listener passed into us in this method but i'm not</span>
<a href="#l5.848"></a><span id="l5.848" class="difflineplus">+        // sure yet... I'm going to use an assert for now to figure out if this</span>
<a href="#l5.849"></a><span id="l5.849" class="difflineplus">+        // is ever getting called</span>
<a href="#l5.850"></a><span id="l5.850"> #if defined(DEBUG_mscott) || defined(DEBUG_bienvenu)</span>
<a href="#l5.851"></a><span id="l5.851">         NS_ERROR(&quot;oops...someone still is reaching this part of the code&quot;);</span>
<a href="#l5.852"></a><span id="l5.852"> #endif</span>
<a href="#l5.853"></a><span id="l5.853">         rv = GetImapConnectionAndLoadUrl(aImapUrl, aDisplayConsumer, aURL);</span>
<a href="#l5.854"></a><span id="l5.854">       }</span>
<a href="#l5.855"></a><span id="l5.855">     }</span>
<a href="#l5.856"></a><span id="l5.856">   }</span>
<a href="#l5.857"></a><span id="l5.857">   return rv;</span>
<a href="#l5.858"></a><span id="l5.858"> }</span>
<a href="#l5.859"></a><span id="l5.859"> </span>
<a href="#l5.860"></a><span id="l5.860"> //</span>
<a href="#l5.861"></a><span id="l5.861"> // rhp: Right now, this is the same as simple DisplayMessage, but it will change</span>
<a href="#l5.862"></a><span id="l5.862"> // to support print rendering.</span>
<a href="#l5.863"></a><span id="l5.863"> //</span>
<a href="#l5.864"></a><span id="l5.864" class="difflineminus">-NS_IMETHODIMP nsImapService::DisplayMessageForPrinting(const char *aMessageURI,</span>
<a href="#l5.865"></a><span id="l5.865" class="difflineminus">-                                                       nsISupports *aDisplayConsumer,</span>
<a href="#l5.866"></a><span id="l5.866" class="difflineminus">-                                                       nsIMsgWindow *aMsgWindow,</span>
<a href="#l5.867"></a><span id="l5.867" class="difflineminus">-                                                       nsIUrlListener *aUrlListener,</span>
<a href="#l5.868"></a><span id="l5.868" class="difflineminus">-                                                       nsIURI **aURL)</span>
<a href="#l5.869"></a><span id="l5.869" class="difflineminus">-{</span>
<a href="#l5.870"></a><span id="l5.870" class="difflineplus">+NS_IMETHODIMP nsImapService::DisplayMessageForPrinting(</span>
<a href="#l5.871"></a><span id="l5.871" class="difflineplus">+    const char *aMessageURI, nsISupports *aDisplayConsumer,</span>
<a href="#l5.872"></a><span id="l5.872" class="difflineplus">+    nsIMsgWindow *aMsgWindow, nsIUrlListener *aUrlListener, nsIURI **aURL) {</span>
<a href="#l5.873"></a><span id="l5.873">   mPrintingOperation = true;</span>
<a href="#l5.874"></a><span id="l5.874" class="difflineminus">-  nsresult rv = DisplayMessage(aMessageURI, aDisplayConsumer, aMsgWindow, aUrlListener, nullptr, aURL);</span>
<a href="#l5.875"></a><span id="l5.875" class="difflineplus">+  nsresult rv = DisplayMessage(aMessageURI, aDisplayConsumer, aMsgWindow,</span>
<a href="#l5.876"></a><span id="l5.876" class="difflineplus">+                               aUrlListener, nullptr, aURL);</span>
<a href="#l5.877"></a><span id="l5.877">   mPrintingOperation = false;</span>
<a href="#l5.878"></a><span id="l5.878">   return rv;</span>
<a href="#l5.879"></a><span id="l5.879"> }</span>
<a href="#l5.880"></a><span id="l5.880"> </span>
<a href="#l5.881"></a><span id="l5.881"> NS_IMETHODIMP nsImapService::CopyMessage(const char *aSrcMailboxURI,</span>
<a href="#l5.882"></a><span id="l5.882">                                          nsIStreamListener *aMailboxCopy,</span>
<a href="#l5.883"></a><span id="l5.883">                                          bool moveMessage,</span>
<a href="#l5.884"></a><span id="l5.884">                                          nsIUrlListener *aUrlListener,</span>
<a href="#l5.885"></a><span id="l5.885">                                          nsIMsgWindow *aMsgWindow,</span>
<a href="#l5.886"></a><span id="l5.886" class="difflineminus">-                                         nsIURI **aURL)</span>
<a href="#l5.887"></a><span id="l5.887" class="difflineminus">-{</span>
<a href="#l5.888"></a><span id="l5.888" class="difflineplus">+                                         nsIURI **aURL) {</span>
<a href="#l5.889"></a><span id="l5.889">   NS_ENSURE_ARG_POINTER(aSrcMailboxURI);</span>
<a href="#l5.890"></a><span id="l5.890">   NS_ENSURE_ARG_POINTER(aMailboxCopy);</span>
<a href="#l5.891"></a><span id="l5.891"> </span>
<a href="#l5.892"></a><span id="l5.892">   nsresult rv;</span>
<a href="#l5.893"></a><span id="l5.893">   nsCOMPtr&lt;nsISupports&gt; streamSupport;</span>
<a href="#l5.894"></a><span id="l5.894">   streamSupport = do_QueryInterface(aMailboxCopy, &amp;rv);</span>
<a href="#l5.895"></a><span id="l5.895">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.896"></a><span id="l5.896"> </span>
<a href="#l5.897"></a><span id="l5.897">   nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l5.898"></a><span id="l5.898">   nsAutoCString msgKey;</span>
<a href="#l5.899"></a><span id="l5.899" class="difflineminus">-  rv = DecomposeImapURI(nsDependentCString(aSrcMailboxURI), getter_AddRefs(folder), msgKey);</span>
<a href="#l5.900"></a><span id="l5.900" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l5.901"></a><span id="l5.901" class="difflineminus">-  {</span>
<a href="#l5.902"></a><span id="l5.902" class="difflineminus">-    nsCOMPtr&lt;nsIImapMessageSink&gt; imapMessageSink(do_QueryInterface(folder, &amp;rv));</span>
<a href="#l5.903"></a><span id="l5.903" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l5.904"></a><span id="l5.904" class="difflineminus">-    {</span>
<a href="#l5.905"></a><span id="l5.905" class="difflineplus">+  rv = DecomposeImapURI(nsDependentCString(aSrcMailboxURI),</span>
<a href="#l5.906"></a><span id="l5.906" class="difflineplus">+                        getter_AddRefs(folder), msgKey);</span>
<a href="#l5.907"></a><span id="l5.907" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l5.908"></a><span id="l5.908" class="difflineplus">+    nsCOMPtr&lt;nsIImapMessageSink&gt; imapMessageSink(</span>
<a href="#l5.909"></a><span id="l5.909" class="difflineplus">+        do_QueryInterface(folder, &amp;rv));</span>
<a href="#l5.910"></a><span id="l5.910" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l5.911"></a><span id="l5.911">       nsCOMPtr&lt;nsIImapUrl&gt; imapUrl;</span>
<a href="#l5.912"></a><span id="l5.912">       nsAutoCString urlSpec;</span>
<a href="#l5.913"></a><span id="l5.913">       char hierarchyDelimiter = GetHierarchyDelimiter(folder);</span>
<a href="#l5.914"></a><span id="l5.914">       bool hasMsgOffline = false;</span>
<a href="#l5.915"></a><span id="l5.915">       nsMsgKey key = strtoul(msgKey.get(), nullptr, 10);</span>
<a href="#l5.916"></a><span id="l5.916"> </span>
<a href="#l5.917"></a><span id="l5.917" class="difflineminus">-      rv = CreateStartOfImapUrl(nsDependentCString(aSrcMailboxURI), getter_AddRefs(imapUrl),</span>
<a href="#l5.918"></a><span id="l5.918" class="difflineminus">-                                folder, aUrlListener, urlSpec, hierarchyDelimiter);</span>
<a href="#l5.919"></a><span id="l5.919" class="difflineminus">-      if (folder)</span>
<a href="#l5.920"></a><span id="l5.920" class="difflineminus">-      {</span>
<a href="#l5.921"></a><span id="l5.921" class="difflineminus">-        nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; msgurl (do_QueryInterface(imapUrl));</span>
<a href="#l5.922"></a><span id="l5.922" class="difflineplus">+      rv = CreateStartOfImapUrl(nsDependentCString(aSrcMailboxURI),</span>
<a href="#l5.923"></a><span id="l5.923" class="difflineplus">+                                getter_AddRefs(imapUrl), folder, aUrlListener,</span>
<a href="#l5.924"></a><span id="l5.924" class="difflineplus">+                                urlSpec, hierarchyDelimiter);</span>
<a href="#l5.925"></a><span id="l5.925" class="difflineplus">+      if (folder) {</span>
<a href="#l5.926"></a><span id="l5.926" class="difflineplus">+        nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; msgurl(do_QueryInterface(imapUrl));</span>
<a href="#l5.927"></a><span id="l5.927">         folder-&gt;HasMsgOffline(key, &amp;hasMsgOffline);</span>
<a href="#l5.928"></a><span id="l5.928" class="difflineminus">-        if (msgurl)</span>
<a href="#l5.929"></a><span id="l5.929" class="difflineminus">-          msgurl-&gt;SetMsgIsInLocalCache(hasMsgOffline);</span>
<a href="#l5.930"></a><span id="l5.930" class="difflineplus">+        if (msgurl) msgurl-&gt;SetMsgIsInLocalCache(hasMsgOffline);</span>
<a href="#l5.931"></a><span id="l5.931">       }</span>
<a href="#l5.932"></a><span id="l5.932">       // now try to download the message</span>
<a href="#l5.933"></a><span id="l5.933">       nsImapAction imapAction = nsIImapUrl::nsImapOnlineToOfflineCopy;</span>
<a href="#l5.934"></a><span id="l5.934" class="difflineminus">-      if (moveMessage)</span>
<a href="#l5.935"></a><span id="l5.935" class="difflineminus">-        imapAction = nsIImapUrl::nsImapOnlineToOfflineMove;</span>
<a href="#l5.936"></a><span id="l5.936" class="difflineminus">-      rv = FetchMessage(imapUrl,imapAction, folder, imapMessageSink,aMsgWindow,</span>
<a href="#l5.937"></a><span id="l5.937" class="difflineminus">-                        streamSupport, msgKey, false, EmptyCString(), aURL);</span>
<a href="#l5.938"></a><span id="l5.938" class="difflineminus">-    } // if we got an imap message sink</span>
<a href="#l5.939"></a><span id="l5.939" class="difflineminus">-  } // if we decomposed the imap message</span>
<a href="#l5.940"></a><span id="l5.940" class="difflineplus">+      if (moveMessage) imapAction = nsIImapUrl::nsImapOnlineToOfflineMove;</span>
<a href="#l5.941"></a><span id="l5.941" class="difflineplus">+      // clang-format off</span>
<a href="#l5.942"></a><span id="l5.942" class="difflineplus">+      rv = FetchMessage(imapUrl, imapAction, folder, imapMessageSink,</span>
<a href="#l5.943"></a><span id="l5.943" class="difflineplus">+                        aMsgWindow, streamSupport, msgKey, false,</span>
<a href="#l5.944"></a><span id="l5.944" class="difflineplus">+                        EmptyCString(), aURL);</span>
<a href="#l5.945"></a><span id="l5.945" class="difflineplus">+      // clang-format on</span>
<a href="#l5.946"></a><span id="l5.946" class="difflineplus">+    }  // if we got an imap message sink</span>
<a href="#l5.947"></a><span id="l5.947" class="difflineplus">+  }    // if we decomposed the imap message</span>
<a href="#l5.948"></a><span id="l5.948">   return rv;</span>
<a href="#l5.949"></a><span id="l5.949"> }</span>
<a href="#l5.950"></a><span id="l5.950"> </span>
<a href="#l5.951"></a><span id="l5.951" class="difflineminus">-NS_IMETHODIMP nsImapService::CopyMessages(uint32_t aNumKeys,</span>
<a href="#l5.952"></a><span id="l5.952" class="difflineminus">-                                          nsMsgKey*aKeys,</span>
<a href="#l5.953"></a><span id="l5.953" class="difflineminus">-                                          nsIMsgFolder *srcFolder,</span>
<a href="#l5.954"></a><span id="l5.954" class="difflineminus">-                                          nsIStreamListener *aMailboxCopy,</span>
<a href="#l5.955"></a><span id="l5.955" class="difflineminus">-                                          bool moveMessage,</span>
<a href="#l5.956"></a><span id="l5.956" class="difflineminus">-                                          nsIUrlListener *aUrlListener,</span>
<a href="#l5.957"></a><span id="l5.957" class="difflineminus">-                                          nsIMsgWindow *aMsgWindow,</span>
<a href="#l5.958"></a><span id="l5.958" class="difflineminus">-                                          nsIURI **aURL)</span>
<a href="#l5.959"></a><span id="l5.959" class="difflineminus">-{</span>
<a href="#l5.960"></a><span id="l5.960" class="difflineplus">+NS_IMETHODIMP nsImapService::CopyMessages(</span>
<a href="#l5.961"></a><span id="l5.961" class="difflineplus">+    uint32_t aNumKeys, nsMsgKey *aKeys, nsIMsgFolder *srcFolder,</span>
<a href="#l5.962"></a><span id="l5.962" class="difflineplus">+    nsIStreamListener *aMailboxCopy, bool moveMessage,</span>
<a href="#l5.963"></a><span id="l5.963" class="difflineplus">+    nsIUrlListener *aUrlListener, nsIMsgWindow *aMsgWindow, nsIURI **aURL) {</span>
<a href="#l5.964"></a><span id="l5.964">   NS_ENSURE_ARG_POINTER(aMailboxCopy);</span>
<a href="#l5.965"></a><span id="l5.965">   NS_ENSURE_ARG_POINTER(aKeys);</span>
<a href="#l5.966"></a><span id="l5.966"> </span>
<a href="#l5.967"></a><span id="l5.967">   nsresult rv;</span>
<a href="#l5.968"></a><span id="l5.968">   nsCOMPtr&lt;nsISupports&gt; streamSupport = do_QueryInterface(aMailboxCopy, &amp;rv);</span>
<a href="#l5.969"></a><span id="l5.969" class="difflineminus">-  if (!streamSupport || NS_FAILED(rv))</span>
<a href="#l5.970"></a><span id="l5.970" class="difflineminus">-    return rv;</span>
<a href="#l5.971"></a><span id="l5.971" class="difflineplus">+  if (!streamSupport || NS_FAILED(rv)) return rv;</span>
<a href="#l5.972"></a><span id="l5.972"> </span>
<a href="#l5.973"></a><span id="l5.973">   nsCOMPtr&lt;nsIMsgFolder&gt; folder = srcFolder;</span>
<a href="#l5.974"></a><span id="l5.974" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l5.975"></a><span id="l5.975" class="difflineminus">-  {</span>
<a href="#l5.976"></a><span id="l5.976" class="difflineminus">-    nsCOMPtr&lt;nsIImapMessageSink&gt; imapMessageSink(do_QueryInterface(folder, &amp;rv));</span>
<a href="#l5.977"></a><span id="l5.977" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l5.978"></a><span id="l5.978" class="difflineminus">-    {</span>
<a href="#l5.979"></a><span id="l5.979" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l5.980"></a><span id="l5.980" class="difflineplus">+    nsCOMPtr&lt;nsIImapMessageSink&gt; imapMessageSink(</span>
<a href="#l5.981"></a><span id="l5.981" class="difflineplus">+        do_QueryInterface(folder, &amp;rv));</span>
<a href="#l5.982"></a><span id="l5.982" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l5.983"></a><span id="l5.983">       // we generate the uri for the first message so that way on down the line,</span>
<a href="#l5.984"></a><span id="l5.984" class="difflineminus">-      // GetMessage in nsCopyMessageStreamListener will get an unescaped username</span>
<a href="#l5.985"></a><span id="l5.985" class="difflineminus">-      // and be able to find the msg hdr. See bug 259656 for details</span>
<a href="#l5.986"></a><span id="l5.986" class="difflineplus">+      // GetMessage in nsCopyMessageStreamListener will get an unescaped</span>
<a href="#l5.987"></a><span id="l5.987" class="difflineplus">+      // username and be able to find the msg hdr. See bug 259656 for details</span>
<a href="#l5.988"></a><span id="l5.988">       nsCString uri;</span>
<a href="#l5.989"></a><span id="l5.989">       srcFolder-&gt;GenerateMessageURI(aKeys[0], uri);</span>
<a href="#l5.990"></a><span id="l5.990"> </span>
<a href="#l5.991"></a><span id="l5.991">       nsCString messageIds;</span>
<a href="#l5.992"></a><span id="l5.992">       AllocateImapUidString(aKeys, aNumKeys, nullptr, messageIds);</span>
<a href="#l5.993"></a><span id="l5.993">       nsCOMPtr&lt;nsIImapUrl&gt; imapUrl;</span>
<a href="#l5.994"></a><span id="l5.994">       nsAutoCString urlSpec;</span>
<a href="#l5.995"></a><span id="l5.995">       char hierarchyDelimiter = GetHierarchyDelimiter(folder);</span>
<a href="#l5.996"></a><span id="l5.996" class="difflineminus">-      rv = CreateStartOfImapUrl(uri, getter_AddRefs(imapUrl), folder, aUrlListener, urlSpec, hierarchyDelimiter);</span>
<a href="#l5.997"></a><span id="l5.997" class="difflineplus">+      rv = CreateStartOfImapUrl(uri, getter_AddRefs(imapUrl), folder,</span>
<a href="#l5.998"></a><span id="l5.998" class="difflineplus">+                                aUrlListener, urlSpec, hierarchyDelimiter);</span>
<a href="#l5.999"></a><span id="l5.999">       nsImapAction action;</span>
<a href="#l5.1000"></a><span id="l5.1000" class="difflineminus">-      if (moveMessage) // don't use ?: syntax here, it seems to break the Mac.</span>
<a href="#l5.1001"></a><span id="l5.1001" class="difflineplus">+      if (moveMessage)  // don't use ?: syntax here, it seems to break the Mac.</span>
<a href="#l5.1002"></a><span id="l5.1002">         action = nsIImapUrl::nsImapOnlineToOfflineMove;</span>
<a href="#l5.1003"></a><span id="l5.1003">       else</span>
<a href="#l5.1004"></a><span id="l5.1004">         action = nsIImapUrl::nsImapOnlineToOfflineCopy;</span>
<a href="#l5.1005"></a><span id="l5.1005">       imapUrl-&gt;SetCopyState(aMailboxCopy);</span>
<a href="#l5.1006"></a><span id="l5.1006">       // now try to display the message</span>
<a href="#l5.1007"></a><span id="l5.1007">       rv = FetchMessage(imapUrl, action, folder, imapMessageSink, aMsgWindow,</span>
<a href="#l5.1008"></a><span id="l5.1008">                         streamSupport, messageIds, false, EmptyCString(), aURL);</span>
<a href="#l5.1009"></a><span id="l5.1009" class="difflineminus">-      // ### end of copy operation should know how to do the delete.if this is a move</span>
<a href="#l5.1010"></a><span id="l5.1010" class="difflineminus">-</span>
<a href="#l5.1011"></a><span id="l5.1011" class="difflineminus">-    } // if we got an imap message sink</span>
<a href="#l5.1012"></a><span id="l5.1012" class="difflineminus">-  } // if we decomposed the imap message</span>
<a href="#l5.1013"></a><span id="l5.1013" class="difflineplus">+      // ### end of copy operation should know how to do the delete.if this is a</span>
<a href="#l5.1014"></a><span id="l5.1014" class="difflineplus">+      // move</span>
<a href="#l5.1015"></a><span id="l5.1015" class="difflineplus">+</span>
<a href="#l5.1016"></a><span id="l5.1016" class="difflineplus">+    }  // if we got an imap message sink</span>
<a href="#l5.1017"></a><span id="l5.1017" class="difflineplus">+  }    // if we decomposed the imap message</span>
<a href="#l5.1018"></a><span id="l5.1018">   return rv;</span>
<a href="#l5.1019"></a><span id="l5.1019"> }</span>
<a href="#l5.1020"></a><span id="l5.1020"> </span>
<a href="#l5.1021"></a><span id="l5.1021"> NS_IMETHODIMP nsImapService::Search(nsIMsgSearchSession *aSearchSession,</span>
<a href="#l5.1022"></a><span id="l5.1022">                                     nsIMsgWindow *aMsgWindow,</span>
<a href="#l5.1023"></a><span id="l5.1023">                                     nsIMsgFolder *aMsgFolder,</span>
<a href="#l5.1024"></a><span id="l5.1024" class="difflineminus">-                                    const char *aSearchUri)</span>
<a href="#l5.1025"></a><span id="l5.1025" class="difflineminus">-{</span>
<a href="#l5.1026"></a><span id="l5.1026" class="difflineplus">+                                    const char *aSearchUri) {</span>
<a href="#l5.1027"></a><span id="l5.1027">   NS_ENSURE_ARG_POINTER(aSearchUri);</span>
<a href="#l5.1028"></a><span id="l5.1028">   NS_ENSURE_ARG_POINTER(aMsgFolder);</span>
<a href="#l5.1029"></a><span id="l5.1029">   nsresult rv;</span>
<a href="#l5.1030"></a><span id="l5.1030"> </span>
<a href="#l5.1031"></a><span id="l5.1031">   nsCOMPtr&lt;nsIImapUrl&gt; imapUrl;</span>
<a href="#l5.1032"></a><span id="l5.1032" class="difflineminus">-  nsCOMPtr &lt;nsIUrlListener&gt; urlListener = do_QueryInterface(aSearchSession, &amp;rv);</span>
<a href="#l5.1033"></a><span id="l5.1033" class="difflineplus">+  nsCOMPtr&lt;nsIUrlListener&gt; urlListener = do_QueryInterface(aSearchSession, &amp;rv);</span>
<a href="#l5.1034"></a><span id="l5.1034">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.1035"></a><span id="l5.1035"> </span>
<a href="#l5.1036"></a><span id="l5.1036">   nsAutoCString urlSpec;</span>
<a href="#l5.1037"></a><span id="l5.1037">   char hierarchyDelimiter = GetHierarchyDelimiter(aMsgFolder);</span>
<a href="#l5.1038"></a><span id="l5.1038" class="difflineminus">-  rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(imapUrl),</span>
<a href="#l5.1039"></a><span id="l5.1039" class="difflineminus">-                            aMsgFolder, urlListener, urlSpec,</span>
<a href="#l5.1040"></a><span id="l5.1040" class="difflineminus">-                            hierarchyDelimiter);</span>
<a href="#l5.1041"></a><span id="l5.1041" class="difflineplus">+  rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(imapUrl), aMsgFolder,</span>
<a href="#l5.1042"></a><span id="l5.1042" class="difflineplus">+                            urlListener, urlSpec, hierarchyDelimiter);</span>
<a href="#l5.1043"></a><span id="l5.1043">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.1044"></a><span id="l5.1044" class="difflineminus">-  nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; msgurl (do_QueryInterface(imapUrl));</span>
<a href="#l5.1045"></a><span id="l5.1045" class="difflineplus">+  nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; msgurl(do_QueryInterface(imapUrl));</span>
<a href="#l5.1046"></a><span id="l5.1046"> </span>
<a href="#l5.1047"></a><span id="l5.1047">   msgurl-&gt;SetMsgWindow(aMsgWindow);</span>
<a href="#l5.1048"></a><span id="l5.1048">   msgurl-&gt;SetSearchSession(aSearchSession);</span>
<a href="#l5.1049"></a><span id="l5.1049">   rv = SetImapUrlSink(aMsgFolder, imapUrl);</span>
<a href="#l5.1050"></a><span id="l5.1050"> </span>
<a href="#l5.1051"></a><span id="l5.1051" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l5.1052"></a><span id="l5.1052" class="difflineminus">-  {</span>
<a href="#l5.1053"></a><span id="l5.1053" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l5.1054"></a><span id="l5.1054">     nsCString folderName;</span>
<a href="#l5.1055"></a><span id="l5.1055">     GetFolderName(aMsgFolder, folderName);</span>
<a href="#l5.1056"></a><span id="l5.1056"> </span>
<a href="#l5.1057"></a><span id="l5.1057" class="difflineminus">-    nsCOMPtr &lt;nsIMsgMailNewsUrl&gt; mailNewsUrl = do_QueryInterface(imapUrl);</span>
<a href="#l5.1058"></a><span id="l5.1058" class="difflineminus">-    if (!aMsgWindow)</span>
<a href="#l5.1059"></a><span id="l5.1059" class="difflineminus">-      mailNewsUrl-&gt;SetSuppressErrorMsgs(true);</span>
<a href="#l5.1060"></a><span id="l5.1060" class="difflineplus">+    nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailNewsUrl = do_QueryInterface(imapUrl);</span>
<a href="#l5.1061"></a><span id="l5.1061" class="difflineplus">+    if (!aMsgWindow) mailNewsUrl-&gt;SetSuppressErrorMsgs(true);</span>
<a href="#l5.1062"></a><span id="l5.1062"> </span>
<a href="#l5.1063"></a><span id="l5.1063">     urlSpec.AppendLiteral(&quot;/search&gt;UID&gt;&quot;);</span>
<a href="#l5.1064"></a><span id="l5.1064">     urlSpec.Append(hierarchyDelimiter);</span>
<a href="#l5.1065"></a><span id="l5.1065">     urlSpec.Append(folderName);</span>
<a href="#l5.1066"></a><span id="l5.1066">     urlSpec.Append('&gt;');</span>
<a href="#l5.1067"></a><span id="l5.1067">     // escape aSearchUri so that IMAP special characters (i.e. '\')</span>
<a href="#l5.1068"></a><span id="l5.1068">     // won't be replaced with '/' in NECKO.</span>
<a href="#l5.1069"></a><span id="l5.1069">     // it will be unescaped in nsImapUrl::ParseUrl().</span>
<a href="#l5.1070"></a><span id="l5.1070">     nsCString escapedSearchUri;</span>
<a href="#l5.1071"></a><span id="l5.1071"> </span>
<a href="#l5.1072"></a><span id="l5.1072" class="difflineminus">-    MsgEscapeString(nsDependentCString(aSearchUri), nsINetUtil::ESCAPE_XALPHAS, escapedSearchUri);</span>
<a href="#l5.1073"></a><span id="l5.1073" class="difflineplus">+    MsgEscapeString(nsDependentCString(aSearchUri), nsINetUtil::ESCAPE_XALPHAS,</span>
<a href="#l5.1074"></a><span id="l5.1074" class="difflineplus">+                    escapedSearchUri);</span>
<a href="#l5.1075"></a><span id="l5.1075">     urlSpec.Append(escapedSearchUri);</span>
<a href="#l5.1076"></a><span id="l5.1076">     rv = mailNewsUrl-&gt;SetSpecInternal(urlSpec);</span>
<a href="#l5.1077"></a><span id="l5.1077">     if (NS_SUCCEEDED(rv))</span>
<a href="#l5.1078"></a><span id="l5.1078">       rv = GetImapConnectionAndLoadUrl(imapUrl, nullptr, nullptr);</span>
<a href="#l5.1079"></a><span id="l5.1079">   }</span>
<a href="#l5.1080"></a><span id="l5.1080">   return rv;</span>
<a href="#l5.1081"></a><span id="l5.1081"> }</span>
<a href="#l5.1082"></a><span id="l5.1082"> </span>
<a href="#l5.1083"></a><span id="l5.1083"> // just a helper method to break down imap message URIs....</span>
<a href="#l5.1084"></a><span id="l5.1084"> nsresult nsImapService::DecomposeImapURI(const nsACString &amp;aMessageURI,</span>
<a href="#l5.1085"></a><span id="l5.1085">                                          nsIMsgFolder **aFolder,</span>
<a href="#l5.1086"></a><span id="l5.1086" class="difflineminus">-                                         nsACString &amp;aMsgKey)</span>
<a href="#l5.1087"></a><span id="l5.1087" class="difflineminus">-{</span>
<a href="#l5.1088"></a><span id="l5.1088" class="difflineplus">+                                         nsACString &amp;aMsgKey) {</span>
<a href="#l5.1089"></a><span id="l5.1089">   nsMsgKey msgKey;</span>
<a href="#l5.1090"></a><span id="l5.1090">   nsresult rv = DecomposeImapURI(aMessageURI, aFolder, &amp;msgKey);</span>
<a href="#l5.1091"></a><span id="l5.1091">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.1092"></a><span id="l5.1092"> </span>
<a href="#l5.1093"></a><span id="l5.1093" class="difflineminus">-  if (msgKey)</span>
<a href="#l5.1094"></a><span id="l5.1094" class="difflineminus">-  {</span>
<a href="#l5.1095"></a><span id="l5.1095" class="difflineplus">+  if (msgKey) {</span>
<a href="#l5.1096"></a><span id="l5.1096">     nsAutoCString messageIdString;</span>
<a href="#l5.1097"></a><span id="l5.1097">     messageIdString.AppendInt(msgKey);</span>
<a href="#l5.1098"></a><span id="l5.1098">     aMsgKey = messageIdString;</span>
<a href="#l5.1099"></a><span id="l5.1099">   }</span>
<a href="#l5.1100"></a><span id="l5.1100"> </span>
<a href="#l5.1101"></a><span id="l5.1101">   return rv;</span>
<a href="#l5.1102"></a><span id="l5.1102"> }</span>
<a href="#l5.1103"></a><span id="l5.1103"> </span>
<a href="#l5.1104"></a><span id="l5.1104"> // just a helper method to break down imap message URIs....</span>
<a href="#l5.1105"></a><span id="l5.1105"> nsresult nsImapService::DecomposeImapURI(const nsACString &amp;aMessageURI,</span>
<a href="#l5.1106"></a><span id="l5.1106">                                          nsIMsgFolder **aFolder,</span>
<a href="#l5.1107"></a><span id="l5.1107" class="difflineminus">-                                         nsMsgKey *aMsgKey)</span>
<a href="#l5.1108"></a><span id="l5.1108" class="difflineminus">-{</span>
<a href="#l5.1109"></a><span id="l5.1109" class="difflineplus">+                                         nsMsgKey *aMsgKey) {</span>
<a href="#l5.1110"></a><span id="l5.1110">   NS_ENSURE_ARG_POINTER(aFolder);</span>
<a href="#l5.1111"></a><span id="l5.1111">   NS_ENSURE_ARG_POINTER(aMsgKey);</span>
<a href="#l5.1112"></a><span id="l5.1112"> </span>
<a href="#l5.1113"></a><span id="l5.1113">   nsAutoCString folderURI;</span>
<a href="#l5.1114"></a><span id="l5.1114">   nsresult rv = nsParseImapMessageURI(PromiseFlatCString(aMessageURI).get(),</span>
<a href="#l5.1115"></a><span id="l5.1115">                                       folderURI, aMsgKey, nullptr);</span>
<a href="#l5.1116"></a><span id="l5.1116">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.1117"></a><span id="l5.1117"> </span>
<a href="#l5.1118"></a><span id="l5.1118">   nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l5.1119"></a><span id="l5.1119">   rv = GetOrCreateFolder(folderURI, aFolder);</span>
<a href="#l5.1120"></a><span id="l5.1120">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.1121"></a><span id="l5.1121"> </span>
<a href="#l5.1122"></a><span id="l5.1122">   return NS_OK;</span>
<a href="#l5.1123"></a><span id="l5.1123"> }</span>
<a href="#l5.1124"></a><span id="l5.1124"> </span>
<a href="#l5.1125"></a><span id="l5.1125" class="difflineminus">-NS_IMETHODIMP nsImapService::SaveMessageToDisk(const char *aMessageURI,</span>
<a href="#l5.1126"></a><span id="l5.1126" class="difflineminus">-                                               nsIFile *aFile,</span>
<a href="#l5.1127"></a><span id="l5.1127" class="difflineminus">-                                               bool aAddDummyEnvelope,</span>
<a href="#l5.1128"></a><span id="l5.1128" class="difflineminus">-                                               nsIUrlListener *aUrlListener,</span>
<a href="#l5.1129"></a><span id="l5.1129" class="difflineminus">-                                               nsIURI **aURL,</span>
<a href="#l5.1130"></a><span id="l5.1130" class="difflineminus">-                                               bool canonicalLineEnding,</span>
<a href="#l5.1131"></a><span id="l5.1131" class="difflineminus">-                                               nsIMsgWindow *aMsgWindow)</span>
<a href="#l5.1132"></a><span id="l5.1132" class="difflineminus">-{</span>
<a href="#l5.1133"></a><span id="l5.1133" class="difflineplus">+NS_IMETHODIMP nsImapService::SaveMessageToDisk(</span>
<a href="#l5.1134"></a><span id="l5.1134" class="difflineplus">+    const char *aMessageURI, nsIFile *aFile, bool aAddDummyEnvelope,</span>
<a href="#l5.1135"></a><span id="l5.1135" class="difflineplus">+    nsIUrlListener *aUrlListener, nsIURI **aURL, bool canonicalLineEnding,</span>
<a href="#l5.1136"></a><span id="l5.1136" class="difflineplus">+    nsIMsgWindow *aMsgWindow) {</span>
<a href="#l5.1137"></a><span id="l5.1137">   nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l5.1138"></a><span id="l5.1138">   nsCOMPtr&lt;nsIImapUrl&gt; imapUrl;</span>
<a href="#l5.1139"></a><span id="l5.1139">   nsAutoCString msgKey;</span>
<a href="#l5.1140"></a><span id="l5.1140"> </span>
<a href="#l5.1141"></a><span id="l5.1141">   nsresult rv = DecomposeImapURI(nsDependentCString(aMessageURI),</span>
<a href="#l5.1142"></a><span id="l5.1142">                                  getter_AddRefs(folder), msgKey);</span>
<a href="#l5.1143"></a><span id="l5.1143">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.1144"></a><span id="l5.1144"> </span>
<a href="#l5.1145"></a><span id="l5.1145">   bool hasMsgOffline = false;</span>
<a href="#l5.1146"></a><span id="l5.1146"> </span>
<a href="#l5.1147"></a><span id="l5.1147">   if (folder)</span>
<a href="#l5.1148"></a><span id="l5.1148">     folder-&gt;HasMsgOffline(strtoul(msgKey.get(), nullptr, 10), &amp;hasMsgOffline);</span>
<a href="#l5.1149"></a><span id="l5.1149"> </span>
<a href="#l5.1150"></a><span id="l5.1150">   nsAutoCString urlSpec;</span>
<a href="#l5.1151"></a><span id="l5.1151">   char hierarchyDelimiter = GetHierarchyDelimiter(folder);</span>
<a href="#l5.1152"></a><span id="l5.1152" class="difflineminus">-  rv = CreateStartOfImapUrl(nsDependentCString(aMessageURI), getter_AddRefs(imapUrl),</span>
<a href="#l5.1153"></a><span id="l5.1153" class="difflineminus">-                            folder, aUrlListener, urlSpec, hierarchyDelimiter);</span>
<a href="#l5.1154"></a><span id="l5.1154" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l5.1155"></a><span id="l5.1155" class="difflineminus">-  {</span>
<a href="#l5.1156"></a><span id="l5.1156" class="difflineminus">-    nsCOMPtr&lt;nsIImapMessageSink&gt; imapMessageSink(do_QueryInterface(folder, &amp;rv));</span>
<a href="#l5.1157"></a><span id="l5.1157" class="difflineplus">+  rv = CreateStartOfImapUrl(nsDependentCString(aMessageURI),</span>
<a href="#l5.1158"></a><span id="l5.1158" class="difflineplus">+                            getter_AddRefs(imapUrl), folder, aUrlListener,</span>
<a href="#l5.1159"></a><span id="l5.1159" class="difflineplus">+                            urlSpec, hierarchyDelimiter);</span>
<a href="#l5.1160"></a><span id="l5.1160" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l5.1161"></a><span id="l5.1161" class="difflineplus">+    nsCOMPtr&lt;nsIImapMessageSink&gt; imapMessageSink(</span>
<a href="#l5.1162"></a><span id="l5.1162" class="difflineplus">+        do_QueryInterface(folder, &amp;rv));</span>
<a href="#l5.1163"></a><span id="l5.1163">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.1164"></a><span id="l5.1164">     nsCOMPtr&lt;nsIMsgMessageUrl&gt; msgUrl = do_QueryInterface(imapUrl, &amp;rv);</span>
<a href="#l5.1165"></a><span id="l5.1165">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.1166"></a><span id="l5.1166">     msgUrl-&gt;SetMessageFile(aFile);</span>
<a href="#l5.1167"></a><span id="l5.1167">     msgUrl-&gt;SetAddDummyEnvelope(aAddDummyEnvelope);</span>
<a href="#l5.1168"></a><span id="l5.1168">     msgUrl-&gt;SetCanonicalLineEnding(canonicalLineEnding);</span>
<a href="#l5.1169"></a><span id="l5.1169"> </span>
<a href="#l5.1170"></a><span id="l5.1170" class="difflineminus">-    nsCOMPtr &lt;nsIMsgMailNewsUrl&gt; mailnewsUrl = do_QueryInterface(msgUrl);</span>
<a href="#l5.1171"></a><span id="l5.1171" class="difflineminus">-    if (mailnewsUrl)</span>
<a href="#l5.1172"></a><span id="l5.1172" class="difflineminus">-      mailnewsUrl-&gt;SetMsgIsInLocalCache(hasMsgOffline);</span>
<a href="#l5.1173"></a><span id="l5.1173" class="difflineminus">-</span>
<a href="#l5.1174"></a><span id="l5.1174" class="difflineminus">-    nsCOMPtr &lt;nsIStreamListener&gt; saveAsListener;</span>
<a href="#l5.1175"></a><span id="l5.1175" class="difflineminus">-    mailnewsUrl-&gt;GetSaveAsListener(aAddDummyEnvelope, aFile, getter_AddRefs(saveAsListener));</span>
<a href="#l5.1176"></a><span id="l5.1176" class="difflineminus">-</span>
<a href="#l5.1177"></a><span id="l5.1177" class="difflineminus">-    return FetchMessage(imapUrl, nsIImapUrl::nsImapSaveMessageToDisk, folder, imapMessageSink,</span>
<a href="#l5.1178"></a><span id="l5.1178" class="difflineminus">-                        aMsgWindow, saveAsListener, msgKey, false, EmptyCString(), aURL);</span>
<a href="#l5.1179"></a><span id="l5.1179" class="difflineplus">+    nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsUrl = do_QueryInterface(msgUrl);</span>
<a href="#l5.1180"></a><span id="l5.1180" class="difflineplus">+    if (mailnewsUrl) mailnewsUrl-&gt;SetMsgIsInLocalCache(hasMsgOffline);</span>
<a href="#l5.1181"></a><span id="l5.1181" class="difflineplus">+</span>
<a href="#l5.1182"></a><span id="l5.1182" class="difflineplus">+    nsCOMPtr&lt;nsIStreamListener&gt; saveAsListener;</span>
<a href="#l5.1183"></a><span id="l5.1183" class="difflineplus">+    mailnewsUrl-&gt;GetSaveAsListener(aAddDummyEnvelope, aFile,</span>
<a href="#l5.1184"></a><span id="l5.1184" class="difflineplus">+                                   getter_AddRefs(saveAsListener));</span>
<a href="#l5.1185"></a><span id="l5.1185" class="difflineplus">+</span>
<a href="#l5.1186"></a><span id="l5.1186" class="difflineplus">+    return FetchMessage(imapUrl, nsIImapUrl::nsImapSaveMessageToDisk, folder,</span>
<a href="#l5.1187"></a><span id="l5.1187" class="difflineplus">+                        imapMessageSink, aMsgWindow, saveAsListener, msgKey,</span>
<a href="#l5.1188"></a><span id="l5.1188" class="difflineplus">+                        false, EmptyCString(), aURL);</span>
<a href="#l5.1189"></a><span id="l5.1189">   }</span>
<a href="#l5.1190"></a><span id="l5.1190">   return rv;</span>
<a href="#l5.1191"></a><span id="l5.1191"> }</span>
<a href="#l5.1192"></a><span id="l5.1192"> </span>
<a href="#l5.1193"></a><span id="l5.1193"> /* fetching RFC822 messages */</span>
<a href="#l5.1194"></a><span id="l5.1194"> /* imap4://HOST&gt;fetch&gt;&lt;UID&gt;&gt;MAILBOXPATH&gt;x */</span>
<a href="#l5.1195"></a><span id="l5.1195"> /*   'x' is the message UID */</span>
<a href="#l5.1196"></a><span id="l5.1196"> /* will set the 'SEEN' flag */</span>
<a href="#l5.1197"></a><span id="l5.1197" class="difflineminus">-NS_IMETHODIMP nsImapService::AddImapFetchToUrl(nsIMsgMailNewsUrl *aUrl,</span>
<a href="#l5.1198"></a><span id="l5.1198" class="difflineminus">-                                               nsIMsgFolder *aImapMailFolder,</span>
<a href="#l5.1199"></a><span id="l5.1199" class="difflineminus">-                                               const nsACString &amp;aMessageIdentifierList,</span>
<a href="#l5.1200"></a><span id="l5.1200" class="difflineminus">-                                               const nsACString &amp;aAdditionalHeader)</span>
<a href="#l5.1201"></a><span id="l5.1201" class="difflineminus">-{</span>
<a href="#l5.1202"></a><span id="l5.1202" class="difflineplus">+NS_IMETHODIMP nsImapService::AddImapFetchToUrl(</span>
<a href="#l5.1203"></a><span id="l5.1203" class="difflineplus">+    nsIMsgMailNewsUrl *aUrl, nsIMsgFolder *aImapMailFolder,</span>
<a href="#l5.1204"></a><span id="l5.1204" class="difflineplus">+    const nsACString &amp;aMessageIdentifierList,</span>
<a href="#l5.1205"></a><span id="l5.1205" class="difflineplus">+    const nsACString &amp;aAdditionalHeader) {</span>
<a href="#l5.1206"></a><span id="l5.1206">   NS_ENSURE_ARG_POINTER(aUrl);</span>
<a href="#l5.1207"></a><span id="l5.1207"> </span>
<a href="#l5.1208"></a><span id="l5.1208">   nsAutoCString urlSpec;</span>
<a href="#l5.1209"></a><span id="l5.1209">   nsresult rv = aUrl-&gt;GetSpec(urlSpec);</span>
<a href="#l5.1210"></a><span id="l5.1210">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.1211"></a><span id="l5.1211"> </span>
<a href="#l5.1212"></a><span id="l5.1212">   char hierarchyDelimiter = GetHierarchyDelimiter(aImapMailFolder);</span>
<a href="#l5.1213"></a><span id="l5.1213"> </span>
<a href="#l5.1214"></a><span id="l5.1214" class="difflineat">@@ -962,256 +912,234 @@ NS_IMETHODIMP nsImapService::AddImapFetc</span>
<a href="#l5.1215"></a><span id="l5.1215"> </span>
<a href="#l5.1216"></a><span id="l5.1216">   nsAutoCString folderName;</span>
<a href="#l5.1217"></a><span id="l5.1217">   GetFolderName(aImapMailFolder, folderName);</span>
<a href="#l5.1218"></a><span id="l5.1218">   urlSpec.Append(folderName);</span>
<a href="#l5.1219"></a><span id="l5.1219"> </span>
<a href="#l5.1220"></a><span id="l5.1220">   urlSpec.Append('&gt;');</span>
<a href="#l5.1221"></a><span id="l5.1221">   urlSpec.Append(aMessageIdentifierList);</span>
<a href="#l5.1222"></a><span id="l5.1222"> </span>
<a href="#l5.1223"></a><span id="l5.1223" class="difflineminus">-  if (!aAdditionalHeader.IsEmpty())</span>
<a href="#l5.1224"></a><span id="l5.1224" class="difflineminus">-  {</span>
<a href="#l5.1225"></a><span id="l5.1225" class="difflineplus">+  if (!aAdditionalHeader.IsEmpty()) {</span>
<a href="#l5.1226"></a><span id="l5.1226">     urlSpec.AppendLiteral(&quot;?header=&quot;);</span>
<a href="#l5.1227"></a><span id="l5.1227">     urlSpec.Append(aAdditionalHeader);</span>
<a href="#l5.1228"></a><span id="l5.1228">   }</span>
<a href="#l5.1229"></a><span id="l5.1229"> </span>
<a href="#l5.1230"></a><span id="l5.1230">   return aUrl-&gt;SetSpecInternal(urlSpec);</span>
<a href="#l5.1231"></a><span id="l5.1231"> }</span>
<a href="#l5.1232"></a><span id="l5.1232"> </span>
<a href="#l5.1233"></a><span id="l5.1233" class="difflineminus">-NS_IMETHODIMP nsImapService::FetchMessage(nsIImapUrl *aImapUrl,</span>
<a href="#l5.1234"></a><span id="l5.1234" class="difflineminus">-                                          nsImapAction aImapAction,</span>
<a href="#l5.1235"></a><span id="l5.1235" class="difflineminus">-                                          nsIMsgFolder *aImapMailFolder,</span>
<a href="#l5.1236"></a><span id="l5.1236" class="difflineminus">-                                          nsIImapMessageSink *aImapMessage,</span>
<a href="#l5.1237"></a><span id="l5.1237" class="difflineminus">-                                          nsIMsgWindow *aMsgWindow,</span>
<a href="#l5.1238"></a><span id="l5.1238" class="difflineminus">-                                          nsISupports *aDisplayConsumer,</span>
<a href="#l5.1239"></a><span id="l5.1239" class="difflineminus">-                                          const nsACString &amp;messageIdentifierList,</span>
<a href="#l5.1240"></a><span id="l5.1240" class="difflineminus">-                                          bool aConvertDataToText,</span>
<a href="#l5.1241"></a><span id="l5.1241" class="difflineminus">-                                          const nsACString &amp;aAdditionalHeader,</span>
<a href="#l5.1242"></a><span id="l5.1242" class="difflineminus">-                                          nsIURI **aURL)</span>
<a href="#l5.1243"></a><span id="l5.1243" class="difflineminus">-{</span>
<a href="#l5.1244"></a><span id="l5.1244" class="difflineplus">+NS_IMETHODIMP nsImapService::FetchMessage(</span>
<a href="#l5.1245"></a><span id="l5.1245" class="difflineplus">+    nsIImapUrl *aImapUrl, nsImapAction aImapAction,</span>
<a href="#l5.1246"></a><span id="l5.1246" class="difflineplus">+    nsIMsgFolder *aImapMailFolder, nsIImapMessageSink *aImapMessage,</span>
<a href="#l5.1247"></a><span id="l5.1247" class="difflineplus">+    nsIMsgWindow *aMsgWindow, nsISupports *aDisplayConsumer,</span>
<a href="#l5.1248"></a><span id="l5.1248" class="difflineplus">+    const nsACString &amp;messageIdentifierList, bool aConvertDataToText,</span>
<a href="#l5.1249"></a><span id="l5.1249" class="difflineplus">+    const nsACString &amp;aAdditionalHeader, nsIURI **aURL) {</span>
<a href="#l5.1250"></a><span id="l5.1250">   NS_ENSURE_ARG_POINTER(aImapUrl);</span>
<a href="#l5.1251"></a><span id="l5.1251">   NS_ENSURE_ARG_POINTER(aImapMailFolder);</span>
<a href="#l5.1252"></a><span id="l5.1252">   NS_ENSURE_ARG_POINTER(aImapMessage);</span>
<a href="#l5.1253"></a><span id="l5.1253"> </span>
<a href="#l5.1254"></a><span id="l5.1254">   nsresult rv;</span>
<a href="#l5.1255"></a><span id="l5.1255">   nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsurl = do_QueryInterface(aImapUrl);</span>
<a href="#l5.1256"></a><span id="l5.1256"> </span>
<a href="#l5.1257"></a><span id="l5.1257" class="difflineminus">-  rv = AddImapFetchToUrl(mailnewsurl, aImapMailFolder, messageIdentifierList, aAdditionalHeader);</span>
<a href="#l5.1258"></a><span id="l5.1258" class="difflineplus">+  rv = AddImapFetchToUrl(mailnewsurl, aImapMailFolder, messageIdentifierList,</span>
<a href="#l5.1259"></a><span id="l5.1259" class="difflineplus">+                         aAdditionalHeader);</span>
<a href="#l5.1260"></a><span id="l5.1260">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.1261"></a><span id="l5.1261"> </span>
<a href="#l5.1262"></a><span id="l5.1262" class="difflineminus">-  if (WeAreOffline())</span>
<a href="#l5.1263"></a><span id="l5.1263" class="difflineminus">-  {</span>
<a href="#l5.1264"></a><span id="l5.1264" class="difflineplus">+  if (WeAreOffline()) {</span>
<a href="#l5.1265"></a><span id="l5.1265">     bool msgIsInCache = false;</span>
<a href="#l5.1266"></a><span id="l5.1266">     nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; msgUrl(do_QueryInterface(aImapUrl));</span>
<a href="#l5.1267"></a><span id="l5.1267">     msgUrl-&gt;GetMsgIsInLocalCache(&amp;msgIsInCache);</span>
<a href="#l5.1268"></a><span id="l5.1268">     if (!msgIsInCache)</span>
<a href="#l5.1269"></a><span id="l5.1269">       IsMsgInMemCache(mailnewsurl, aImapMailFolder, &amp;msgIsInCache);</span>
<a href="#l5.1270"></a><span id="l5.1270"> </span>
<a href="#l5.1271"></a><span id="l5.1271" class="difflineminus">-    // Display the &quot;offline&quot; message if we didn't find it in the memory cache either</span>
<a href="#l5.1272"></a><span id="l5.1272" class="difflineminus">-    if (!msgIsInCache)</span>
<a href="#l5.1273"></a><span id="l5.1273" class="difflineminus">-    {</span>
<a href="#l5.1274"></a><span id="l5.1274" class="difflineplus">+    // Display the &quot;offline&quot; message if we didn't find it in the memory cache</span>
<a href="#l5.1275"></a><span id="l5.1275" class="difflineplus">+    // either</span>
<a href="#l5.1276"></a><span id="l5.1276" class="difflineplus">+    if (!msgIsInCache) {</span>
<a href="#l5.1277"></a><span id="l5.1277">       nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l5.1278"></a><span id="l5.1278">       rv = aImapMailFolder-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l5.1279"></a><span id="l5.1279">       if (server &amp;&amp; aDisplayConsumer)</span>
<a href="#l5.1280"></a><span id="l5.1280">         rv = server-&gt;DisplayOfflineMsg(aMsgWindow);</span>
<a href="#l5.1281"></a><span id="l5.1281">       return rv;</span>
<a href="#l5.1282"></a><span id="l5.1282">     }</span>
<a href="#l5.1283"></a><span id="l5.1283">   }</span>
<a href="#l5.1284"></a><span id="l5.1284"> </span>
<a href="#l5.1285"></a><span id="l5.1285" class="difflineminus">-  if (aURL)</span>
<a href="#l5.1286"></a><span id="l5.1286" class="difflineminus">-    mailnewsurl.forget(aURL);</span>
<a href="#l5.1287"></a><span id="l5.1287" class="difflineplus">+  if (aURL) mailnewsurl.forget(aURL);</span>
<a href="#l5.1288"></a><span id="l5.1288"> </span>
<a href="#l5.1289"></a><span id="l5.1289">   return GetMessageFromUrl(aImapUrl, aImapAction, aImapMailFolder, aImapMessage,</span>
<a href="#l5.1290"></a><span id="l5.1290" class="difflineminus">-                           aMsgWindow, aDisplayConsumer, aConvertDataToText, aURL);</span>
<a href="#l5.1291"></a><span id="l5.1291" class="difflineplus">+                           aMsgWindow, aDisplayConsumer, aConvertDataToText,</span>
<a href="#l5.1292"></a><span id="l5.1292" class="difflineplus">+                           aURL);</span>
<a href="#l5.1293"></a><span id="l5.1293"> }</span>
<a href="#l5.1294"></a><span id="l5.1294"> </span>
<a href="#l5.1295"></a><span id="l5.1295" class="difflineminus">-nsresult nsImapService::GetMessageFromUrl(nsIImapUrl *aImapUrl,</span>
<a href="#l5.1296"></a><span id="l5.1296" class="difflineminus">-                                          nsImapAction aImapAction,</span>
<a href="#l5.1297"></a><span id="l5.1297" class="difflineminus">-                                          nsIMsgFolder *aImapMailFolder,</span>
<a href="#l5.1298"></a><span id="l5.1298" class="difflineminus">-                                          nsIImapMessageSink *aImapMessage,</span>
<a href="#l5.1299"></a><span id="l5.1299" class="difflineminus">-                                          nsIMsgWindow *aMsgWindow,</span>
<a href="#l5.1300"></a><span id="l5.1300" class="difflineminus">-                                          nsISupports *aDisplayConsumer,</span>
<a href="#l5.1301"></a><span id="l5.1301" class="difflineminus">-                                          bool aConvertDataToText,</span>
<a href="#l5.1302"></a><span id="l5.1302" class="difflineminus">-                                          nsIURI **aURL)</span>
<a href="#l5.1303"></a><span id="l5.1303" class="difflineminus">-{</span>
<a href="#l5.1304"></a><span id="l5.1304" class="difflineplus">+nsresult nsImapService::GetMessageFromUrl(</span>
<a href="#l5.1305"></a><span id="l5.1305" class="difflineplus">+    nsIImapUrl *aImapUrl, nsImapAction aImapAction,</span>
<a href="#l5.1306"></a><span id="l5.1306" class="difflineplus">+    nsIMsgFolder *aImapMailFolder, nsIImapMessageSink *aImapMessage,</span>
<a href="#l5.1307"></a><span id="l5.1307" class="difflineplus">+    nsIMsgWindow *aMsgWindow, nsISupports *aDisplayConsumer,</span>
<a href="#l5.1308"></a><span id="l5.1308" class="difflineplus">+    bool aConvertDataToText, nsIURI **aURL) {</span>
<a href="#l5.1309"></a><span id="l5.1309">   nsresult rv = SetImapUrlSink(aImapMailFolder, aImapUrl);</span>
<a href="#l5.1310"></a><span id="l5.1310">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.1311"></a><span id="l5.1311"> </span>
<a href="#l5.1312"></a><span id="l5.1312">   rv = aImapUrl-&gt;SetImapMessageSink(aImapMessage);</span>
<a href="#l5.1313"></a><span id="l5.1313">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.1314"></a><span id="l5.1314"> </span>
<a href="#l5.1315"></a><span id="l5.1315">   rv = aImapUrl-&gt;SetImapAction(aImapAction);</span>
<a href="#l5.1316"></a><span id="l5.1316">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.1317"></a><span id="l5.1317"> </span>
<a href="#l5.1318"></a><span id="l5.1318">   nsCOMPtr&lt;nsIURI&gt; url(do_QueryInterface(aImapUrl));</span>
<a href="#l5.1319"></a><span id="l5.1319"> </span>
<a href="#l5.1320"></a><span id="l5.1320" class="difflineminus">-  // if the display consumer is a docshell, then we should run the url in the docshell.</span>
<a href="#l5.1321"></a><span id="l5.1321" class="difflineminus">-  // otherwise, it should be a stream listener....so open a channel using AsyncRead</span>
<a href="#l5.1322"></a><span id="l5.1322" class="difflineminus">-  // and the provided stream listener....</span>
<a href="#l5.1323"></a><span id="l5.1323" class="difflineplus">+  // if the display consumer is a docshell, then we should run the url in the</span>
<a href="#l5.1324"></a><span id="l5.1324" class="difflineplus">+  // docshell. otherwise, it should be a stream listener....so open a channel</span>
<a href="#l5.1325"></a><span id="l5.1325" class="difflineplus">+  // using AsyncRead and the provided stream listener....</span>
<a href="#l5.1326"></a><span id="l5.1326"> </span>
<a href="#l5.1327"></a><span id="l5.1327">   nsCOMPtr&lt;nsIDocShell&gt; docShell(do_QueryInterface(aDisplayConsumer, &amp;rv));</span>
<a href="#l5.1328"></a><span id="l5.1328" class="difflineminus">-  if (aImapMailFolder &amp;&amp; docShell)</span>
<a href="#l5.1329"></a><span id="l5.1329" class="difflineminus">-  {</span>
<a href="#l5.1330"></a><span id="l5.1330" class="difflineplus">+  if (aImapMailFolder &amp;&amp; docShell) {</span>
<a href="#l5.1331"></a><span id="l5.1331">     nsCOMPtr&lt;nsIMsgIncomingServer&gt; aMsgIncomingServer;</span>
<a href="#l5.1332"></a><span id="l5.1332">     rv = aImapMailFolder-&gt;GetServer(getter_AddRefs(aMsgIncomingServer));</span>
<a href="#l5.1333"></a><span id="l5.1333" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; aMsgIncomingServer)</span>
<a href="#l5.1334"></a><span id="l5.1334" class="difflineminus">-    {</span>
<a href="#l5.1335"></a><span id="l5.1335" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; aMsgIncomingServer) {</span>
<a href="#l5.1336"></a><span id="l5.1336">       bool interrupted;</span>
<a href="#l5.1337"></a><span id="l5.1337" class="difflineminus">-      nsCOMPtr&lt;nsIImapIncomingServer&gt;</span>
<a href="#l5.1338"></a><span id="l5.1338" class="difflineminus">-        aImapServer(do_QueryInterface(aMsgIncomingServer, &amp;rv));</span>
<a href="#l5.1339"></a><span id="l5.1339" class="difflineplus">+      nsCOMPtr&lt;nsIImapIncomingServer&gt; aImapServer(</span>
<a href="#l5.1340"></a><span id="l5.1340" class="difflineplus">+          do_QueryInterface(aMsgIncomingServer, &amp;rv));</span>
<a href="#l5.1341"></a><span id="l5.1341">       if (NS_SUCCEEDED(rv) &amp;&amp; aImapServer)</span>
<a href="#l5.1342"></a><span id="l5.1342" class="difflineminus">-        aImapServer-&gt;PseudoInterruptMsgLoad(aImapMailFolder, aMsgWindow, &amp;interrupted);</span>
<a href="#l5.1343"></a><span id="l5.1343" class="difflineplus">+        aImapServer-&gt;PseudoInterruptMsgLoad(aImapMailFolder, aMsgWindow,</span>
<a href="#l5.1344"></a><span id="l5.1344" class="difflineplus">+                                            &amp;interrupted);</span>
<a href="#l5.1345"></a><span id="l5.1345">     }</span>
<a href="#l5.1346"></a><span id="l5.1346">   }</span>
<a href="#l5.1347"></a><span id="l5.1347" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; docShell)</span>
<a href="#l5.1348"></a><span id="l5.1348" class="difflineminus">-  {</span>
<a href="#l5.1349"></a><span id="l5.1349" class="difflineminus">-    NS_ASSERTION(!aConvertDataToText, &quot;can't convert to text when using docshell&quot;);</span>
<a href="#l5.1350"></a><span id="l5.1350" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; docShell) {</span>
<a href="#l5.1351"></a><span id="l5.1351" class="difflineplus">+    NS_ASSERTION(!aConvertDataToText,</span>
<a href="#l5.1352"></a><span id="l5.1352" class="difflineplus">+                 &quot;can't convert to text when using docshell&quot;);</span>
<a href="#l5.1353"></a><span id="l5.1353">     RefPtr&lt;nsDocShellLoadState&gt; loadState = new nsDocShellLoadState(url);</span>
<a href="#l5.1354"></a><span id="l5.1354">     loadState-&gt;SetLoadFlags(nsIWebNavigation::LOAD_FLAGS_NONE);</span>
<a href="#l5.1355"></a><span id="l5.1355">     loadState-&gt;SetFirstParty(false);</span>
<a href="#l5.1356"></a><span id="l5.1356">     loadState-&gt;SetTriggeringPrincipal(nsContentUtils::GetSystemPrincipal());</span>
<a href="#l5.1357"></a><span id="l5.1357">     rv = docShell-&gt;LoadURI(loadState);</span>
<a href="#l5.1358"></a><span id="l5.1358" class="difflineminus">-  }</span>
<a href="#l5.1359"></a><span id="l5.1359" class="difflineminus">-  else</span>
<a href="#l5.1360"></a><span id="l5.1360" class="difflineminus">-  {</span>
<a href="#l5.1361"></a><span id="l5.1361" class="difflineminus">-    nsCOMPtr&lt;nsIStreamListener&gt; streamListener = do_QueryInterface(aDisplayConsumer, &amp;rv);</span>
<a href="#l5.1362"></a><span id="l5.1362" class="difflineplus">+  } else {</span>
<a href="#l5.1363"></a><span id="l5.1363" class="difflineplus">+    nsCOMPtr&lt;nsIStreamListener&gt; streamListener =</span>
<a href="#l5.1364"></a><span id="l5.1364" class="difflineplus">+        do_QueryInterface(aDisplayConsumer, &amp;rv);</span>
<a href="#l5.1365"></a><span id="l5.1365">     nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsUrl = do_QueryInterface(aImapUrl, &amp;rv);</span>
<a href="#l5.1366"></a><span id="l5.1366" class="difflineminus">-    if (aMsgWindow &amp;&amp; mailnewsUrl)</span>
<a href="#l5.1367"></a><span id="l5.1367" class="difflineminus">-      mailnewsUrl-&gt;SetMsgWindow(aMsgWindow);</span>
<a href="#l5.1368"></a><span id="l5.1368" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; streamListener)</span>
<a href="#l5.1369"></a><span id="l5.1369" class="difflineminus">-    {</span>
<a href="#l5.1370"></a><span id="l5.1370" class="difflineplus">+    if (aMsgWindow &amp;&amp; mailnewsUrl) mailnewsUrl-&gt;SetMsgWindow(aMsgWindow);</span>
<a href="#l5.1371"></a><span id="l5.1371" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; streamListener) {</span>
<a href="#l5.1372"></a><span id="l5.1372">       nsCOMPtr&lt;nsIChannel&gt; channel;</span>
<a href="#l5.1373"></a><span id="l5.1373">       nsCOMPtr&lt;nsILoadGroup&gt; loadGroup;</span>
<a href="#l5.1374"></a><span id="l5.1374">       if (NS_SUCCEEDED(rv) &amp;&amp; mailnewsUrl)</span>
<a href="#l5.1375"></a><span id="l5.1375">         mailnewsUrl-&gt;GetLoadGroup(getter_AddRefs(loadGroup));</span>
<a href="#l5.1376"></a><span id="l5.1376"> </span>
<a href="#l5.1377"></a><span id="l5.1377">       nsCOMPtr&lt;nsILoadInfo&gt; loadInfo = new mozilla::net::LoadInfo(</span>
<a href="#l5.1378"></a><span id="l5.1378" class="difflineminus">-        nsContentUtils::GetSystemPrincipal(),</span>
<a href="#l5.1379"></a><span id="l5.1379" class="difflineminus">-        nullptr,</span>
<a href="#l5.1380"></a><span id="l5.1380" class="difflineminus">-        nullptr,</span>
<a href="#l5.1381"></a><span id="l5.1381" class="difflineminus">-        nsILoadInfo::SEC_ALLOW_CROSS_ORIGIN_DATA_IS_NULL,</span>
<a href="#l5.1382"></a><span id="l5.1382" class="difflineminus">-        nsIContentPolicy::TYPE_OTHER);</span>
<a href="#l5.1383"></a><span id="l5.1383" class="difflineplus">+          nsContentUtils::GetSystemPrincipal(), nullptr, nullptr,</span>
<a href="#l5.1384"></a><span id="l5.1384" class="difflineplus">+          nsILoadInfo::SEC_ALLOW_CROSS_ORIGIN_DATA_IS_NULL,</span>
<a href="#l5.1385"></a><span id="l5.1385" class="difflineplus">+          nsIContentPolicy::TYPE_OTHER);</span>
<a href="#l5.1386"></a><span id="l5.1386">       rv = NewChannel(url, loadInfo, getter_AddRefs(channel));</span>
<a href="#l5.1387"></a><span id="l5.1387">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.1388"></a><span id="l5.1388"> </span>
<a href="#l5.1389"></a><span id="l5.1389" class="difflineminus">-      // we need a load group to hold onto the channel. When the request is finished,</span>
<a href="#l5.1390"></a><span id="l5.1390" class="difflineminus">-      // it'll get removed from the load group, and the channel will go away,</span>
<a href="#l5.1391"></a><span id="l5.1391" class="difflineminus">-      // which will free the load group.</span>
<a href="#l5.1392"></a><span id="l5.1392" class="difflineminus">-      if (!loadGroup)</span>
<a href="#l5.1393"></a><span id="l5.1393" class="difflineminus">-        loadGroup = do_CreateInstance(NS_LOADGROUP_CONTRACTID);</span>
<a href="#l5.1394"></a><span id="l5.1394" class="difflineplus">+      // we need a load group to hold onto the channel. When the request is</span>
<a href="#l5.1395"></a><span id="l5.1395" class="difflineplus">+      // finished, it'll get removed from the load group, and the channel will</span>
<a href="#l5.1396"></a><span id="l5.1396" class="difflineplus">+      // go away, which will free the load group.</span>
<a href="#l5.1397"></a><span id="l5.1397" class="difflineplus">+      if (!loadGroup) loadGroup = do_CreateInstance(NS_LOADGROUP_CONTRACTID);</span>
<a href="#l5.1398"></a><span id="l5.1398"> </span>
<a href="#l5.1399"></a><span id="l5.1399">       rv = channel-&gt;SetLoadGroup(loadGroup);</span>
<a href="#l5.1400"></a><span id="l5.1400">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.1401"></a><span id="l5.1401"> </span>
<a href="#l5.1402"></a><span id="l5.1402" class="difflineminus">-      if (aConvertDataToText)</span>
<a href="#l5.1403"></a><span id="l5.1403" class="difflineminus">-      {</span>
<a href="#l5.1404"></a><span id="l5.1404" class="difflineplus">+      if (aConvertDataToText) {</span>
<a href="#l5.1405"></a><span id="l5.1405">         nsCOMPtr&lt;nsIStreamListener&gt; conversionListener;</span>
<a href="#l5.1406"></a><span id="l5.1406" class="difflineminus">-        nsCOMPtr&lt;nsIStreamConverterService&gt; streamConverter = do_GetService(&quot;@mozilla.org/streamConverters;1&quot;, &amp;rv);</span>
<a href="#l5.1407"></a><span id="l5.1407" class="difflineplus">+        nsCOMPtr&lt;nsIStreamConverterService&gt; streamConverter =</span>
<a href="#l5.1408"></a><span id="l5.1408" class="difflineplus">+            do_GetService(&quot;@mozilla.org/streamConverters;1&quot;, &amp;rv);</span>
<a href="#l5.1409"></a><span id="l5.1409">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.1410"></a><span id="l5.1410" class="difflineminus">-        rv = streamConverter-&gt;AsyncConvertData(&quot;message/rfc822&quot;,</span>
<a href="#l5.1411"></a><span id="l5.1411" class="difflineminus">-                                               &quot;*/*&quot;, streamListener, channel, getter_AddRefs(conversionListener));</span>
<a href="#l5.1412"></a><span id="l5.1412" class="difflineplus">+        rv = streamConverter-&gt;AsyncConvertData(</span>
<a href="#l5.1413"></a><span id="l5.1413" class="difflineplus">+            &quot;message/rfc822&quot;, &quot;*/*&quot;, streamListener, channel,</span>
<a href="#l5.1414"></a><span id="l5.1414" class="difflineplus">+            getter_AddRefs(conversionListener));</span>
<a href="#l5.1415"></a><span id="l5.1415">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.1416"></a><span id="l5.1416" class="difflineminus">-        streamListener = conversionListener; // this is our new listener.</span>
<a href="#l5.1417"></a><span id="l5.1417" class="difflineplus">+        streamListener = conversionListener;  // this is our new listener.</span>
<a href="#l5.1418"></a><span id="l5.1418">       }</span>
<a href="#l5.1419"></a><span id="l5.1419"> </span>
<a href="#l5.1420"></a><span id="l5.1420" class="difflineminus">-      //  now try to open the channel passing in our display consumer as the listener</span>
<a href="#l5.1421"></a><span id="l5.1421" class="difflineplus">+      //  now try to open the channel passing in our display consumer as the</span>
<a href="#l5.1422"></a><span id="l5.1422" class="difflineplus">+      //  listener</span>
<a href="#l5.1423"></a><span id="l5.1423">       rv = channel-&gt;AsyncOpen(streamListener);</span>
<a href="#l5.1424"></a><span id="l5.1424" class="difflineminus">-    }</span>
<a href="#l5.1425"></a><span id="l5.1425" class="difflineminus">-    else // do what we used to do before</span>
<a href="#l5.1426"></a><span id="l5.1426" class="difflineplus">+    } else  // do what we used to do before</span>
<a href="#l5.1427"></a><span id="l5.1427">     {</span>
<a href="#l5.1428"></a><span id="l5.1428" class="difflineminus">-      // I'd like to get rid of this code as I believe that we always get a docshell</span>
<a href="#l5.1429"></a><span id="l5.1429" class="difflineminus">-      // or stream listener passed into us in this method but i'm not sure yet...</span>
<a href="#l5.1430"></a><span id="l5.1430" class="difflineminus">-      // I'm going to use an assert for now to figure out if this is ever getting called</span>
<a href="#l5.1431"></a><span id="l5.1431" class="difflineplus">+      // I'd like to get rid of this code as I believe that we always get a</span>
<a href="#l5.1432"></a><span id="l5.1432" class="difflineplus">+      // docshell or stream listener passed into us in this method but i'm not</span>
<a href="#l5.1433"></a><span id="l5.1433" class="difflineplus">+      // sure yet... I'm going to use an assert for now to figure out if this is</span>
<a href="#l5.1434"></a><span id="l5.1434" class="difflineplus">+      // ever getting called</span>
<a href="#l5.1435"></a><span id="l5.1435"> #if defined(DEBUG_mscott) || defined(DEBUG_bienvenu)</span>
<a href="#l5.1436"></a><span id="l5.1436">       NS_ERROR(&quot;oops...someone still is reaching this part of the code&quot;);</span>
<a href="#l5.1437"></a><span id="l5.1437"> #endif</span>
<a href="#l5.1438"></a><span id="l5.1438" class="difflineminus">-      rv = GetImapConnectionAndLoadUrl(aImapUrl,</span>
<a href="#l5.1439"></a><span id="l5.1439" class="difflineminus">-                                       aDisplayConsumer, aURL);</span>
<a href="#l5.1440"></a><span id="l5.1440" class="difflineplus">+      rv = GetImapConnectionAndLoadUrl(aImapUrl, aDisplayConsumer, aURL);</span>
<a href="#l5.1441"></a><span id="l5.1441">     }</span>
<a href="#l5.1442"></a><span id="l5.1442">   }</span>
<a href="#l5.1443"></a><span id="l5.1443">   return rv;</span>
<a href="#l5.1444"></a><span id="l5.1444"> }</span>
<a href="#l5.1445"></a><span id="l5.1445"> </span>
<a href="#l5.1446"></a><span id="l5.1446" class="difflineminus">-// this method streams a message to the passed in consumer, with an optional stream converter</span>
<a href="#l5.1447"></a><span id="l5.1447" class="difflineminus">-// and additional header (e.g., &quot;header=filter&quot;)</span>
<a href="#l5.1448"></a><span id="l5.1448" class="difflineminus">-NS_IMETHODIMP nsImapService::StreamMessage(const char *aMessageURI,</span>
<a href="#l5.1449"></a><span id="l5.1449" class="difflineminus">-                                           nsISupports *aConsumer,</span>
<a href="#l5.1450"></a><span id="l5.1450" class="difflineminus">-                                           nsIMsgWindow *aMsgWindow,</span>
<a href="#l5.1451"></a><span id="l5.1451" class="difflineminus">-                                           nsIUrlListener *aUrlListener,</span>
<a href="#l5.1452"></a><span id="l5.1452" class="difflineminus">-                                           bool aConvertData,</span>
<a href="#l5.1453"></a><span id="l5.1453" class="difflineminus">-                                           const nsACString &amp;aAdditionalHeader,</span>
<a href="#l5.1454"></a><span id="l5.1454" class="difflineminus">-                                           bool aLocalOnly,</span>
<a href="#l5.1455"></a><span id="l5.1455" class="difflineminus">-                                           nsIURI **aURL)</span>
<a href="#l5.1456"></a><span id="l5.1456" class="difflineminus">-{</span>
<a href="#l5.1457"></a><span id="l5.1457" class="difflineplus">+// this method streams a message to the passed in consumer, with an optional</span>
<a href="#l5.1458"></a><span id="l5.1458" class="difflineplus">+// stream converter and additional header (e.g., &quot;header=filter&quot;)</span>
<a href="#l5.1459"></a><span id="l5.1459" class="difflineplus">+NS_IMETHODIMP nsImapService::StreamMessage(</span>
<a href="#l5.1460"></a><span id="l5.1460" class="difflineplus">+    const char *aMessageURI, nsISupports *aConsumer, nsIMsgWindow *aMsgWindow,</span>
<a href="#l5.1461"></a><span id="l5.1461" class="difflineplus">+    nsIUrlListener *aUrlListener, bool aConvertData,</span>
<a href="#l5.1462"></a><span id="l5.1462" class="difflineplus">+    const nsACString &amp;aAdditionalHeader, bool aLocalOnly, nsIURI **aURL) {</span>
<a href="#l5.1463"></a><span id="l5.1463">   NS_ENSURE_ARG_POINTER(aMessageURI);</span>
<a href="#l5.1464"></a><span id="l5.1464"> </span>
<a href="#l5.1465"></a><span id="l5.1465">   nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l5.1466"></a><span id="l5.1466">   nsAutoCString msgKey;</span>
<a href="#l5.1467"></a><span id="l5.1467">   nsAutoCString mimePart;</span>
<a href="#l5.1468"></a><span id="l5.1468">   nsAutoCString folderURI;</span>
<a href="#l5.1469"></a><span id="l5.1469">   nsMsgKey key;</span>
<a href="#l5.1470"></a><span id="l5.1470"> </span>
<a href="#l5.1471"></a><span id="l5.1471" class="difflineminus">-  nsresult rv = DecomposeImapURI(nsDependentCString(aMessageURI), getter_AddRefs(folder), msgKey);</span>
<a href="#l5.1472"></a><span id="l5.1472" class="difflineplus">+  nsresult rv = DecomposeImapURI(nsDependentCString(aMessageURI),</span>
<a href="#l5.1473"></a><span id="l5.1473" class="difflineplus">+                                 getter_AddRefs(folder), msgKey);</span>
<a href="#l5.1474"></a><span id="l5.1474">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.1475"></a><span id="l5.1475"> </span>
<a href="#l5.1476"></a><span id="l5.1476" class="difflineminus">-  if (msgKey.IsEmpty())</span>
<a href="#l5.1477"></a><span id="l5.1477" class="difflineminus">-    return NS_MSG_MESSAGE_NOT_FOUND;</span>
<a href="#l5.1478"></a><span id="l5.1478" class="difflineminus">-  rv = nsParseImapMessageURI(aMessageURI, folderURI, &amp;key, getter_Copies(mimePart));</span>
<a href="#l5.1479"></a><span id="l5.1479" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l5.1480"></a><span id="l5.1480" class="difflineminus">-  {</span>
<a href="#l5.1481"></a><span id="l5.1481" class="difflineminus">-    nsCOMPtr&lt;nsIImapMessageSink&gt; imapMessageSink(do_QueryInterface(folder, &amp;rv));</span>
<a href="#l5.1482"></a><span id="l5.1482" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l5.1483"></a><span id="l5.1483" class="difflineminus">-    {</span>
<a href="#l5.1484"></a><span id="l5.1484" class="difflineplus">+  if (msgKey.IsEmpty()) return NS_MSG_MESSAGE_NOT_FOUND;</span>
<a href="#l5.1485"></a><span id="l5.1485" class="difflineplus">+  rv = nsParseImapMessageURI(aMessageURI, folderURI, &amp;key,</span>
<a href="#l5.1486"></a><span id="l5.1486" class="difflineplus">+                             getter_Copies(mimePart));</span>
<a href="#l5.1487"></a><span id="l5.1487" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l5.1488"></a><span id="l5.1488" class="difflineplus">+    nsCOMPtr&lt;nsIImapMessageSink&gt; imapMessageSink(</span>
<a href="#l5.1489"></a><span id="l5.1489" class="difflineplus">+        do_QueryInterface(folder, &amp;rv));</span>
<a href="#l5.1490"></a><span id="l5.1490" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l5.1491"></a><span id="l5.1491">       nsCOMPtr&lt;nsIImapUrl&gt; imapUrl;</span>
<a href="#l5.1492"></a><span id="l5.1492">       nsAutoCString urlSpec;</span>
<a href="#l5.1493"></a><span id="l5.1493">       char hierarchyDelimiter = GetHierarchyDelimiter(folder);</span>
<a href="#l5.1494"></a><span id="l5.1494" class="difflineminus">-      rv = CreateStartOfImapUrl(nsDependentCString(aMessageURI), getter_AddRefs(imapUrl),</span>
<a href="#l5.1495"></a><span id="l5.1495" class="difflineminus">-                                folder, aUrlListener, urlSpec, hierarchyDelimiter);</span>
<a href="#l5.1496"></a><span id="l5.1496" class="difflineplus">+      rv = CreateStartOfImapUrl(nsDependentCString(aMessageURI),</span>
<a href="#l5.1497"></a><span id="l5.1497" class="difflineplus">+                                getter_AddRefs(imapUrl), folder, aUrlListener,</span>
<a href="#l5.1498"></a><span id="l5.1498" class="difflineplus">+                                urlSpec, hierarchyDelimiter);</span>
<a href="#l5.1499"></a><span id="l5.1499">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.1500"></a><span id="l5.1500">       nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsurl(do_QueryInterface(imapUrl));</span>
<a href="#l5.1501"></a><span id="l5.1501"> </span>
<a href="#l5.1502"></a><span id="l5.1502">       // This option is used by the JS Mime Emitter, in case we want a cheap</span>
<a href="#l5.1503"></a><span id="l5.1503">       // streaming, for example, if we just want a quick look at some header,</span>
<a href="#l5.1504"></a><span id="l5.1504">       // without having to download all the attachments...</span>
<a href="#l5.1505"></a><span id="l5.1505"> </span>
<a href="#l5.1506"></a><span id="l5.1506">       uint32_t messageSize = 0;</span>
<a href="#l5.1507"></a><span id="l5.1507">       imapMessageSink-&gt;GetMessageSizeFromDB(msgKey.get(), &amp;messageSize);</span>
<a href="#l5.1508"></a><span id="l5.1508">       nsAutoCString additionalHeader(aAdditionalHeader);</span>
<a href="#l5.1509"></a><span id="l5.1509">       bool fetchOnDemand =</span>
<a href="#l5.1510"></a><span id="l5.1510" class="difflineminus">-        additionalHeader.Find(&quot;&amp;fetchCompleteMessage=false&quot;) != kNotFound &amp;&amp;</span>
<a href="#l5.1511"></a><span id="l5.1511" class="difflineminus">-          messageSize &gt; (uint32_t) gMIMEOnDemandThreshold;</span>
<a href="#l5.1512"></a><span id="l5.1512" class="difflineplus">+          additionalHeader.Find(&quot;&amp;fetchCompleteMessage=false&quot;) != kNotFound &amp;&amp;</span>
<a href="#l5.1513"></a><span id="l5.1513" class="difflineplus">+          messageSize &gt; (uint32_t)gMIMEOnDemandThreshold;</span>
<a href="#l5.1514"></a><span id="l5.1514">       imapUrl-&gt;SetFetchPartsOnDemand(fetchOnDemand);</span>
<a href="#l5.1515"></a><span id="l5.1515"> </span>
<a href="#l5.1516"></a><span id="l5.1516" class="difflineminus">-      // We need to add the fetch command here for the cache lookup to behave correctly</span>
<a href="#l5.1517"></a><span id="l5.1517" class="difflineplus">+      // We need to add the fetch command here for the cache lookup to behave</span>
<a href="#l5.1518"></a><span id="l5.1518" class="difflineplus">+      // correctly</span>
<a href="#l5.1519"></a><span id="l5.1519">       rv = AddImapFetchToUrl(mailnewsurl, folder, msgKey, additionalHeader);</span>
<a href="#l5.1520"></a><span id="l5.1520">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.1521"></a><span id="l5.1521"> </span>
<a href="#l5.1522"></a><span id="l5.1522">       nsCOMPtr&lt;nsIMsgIncomingServer&gt; aMsgIncomingServer;</span>
<a href="#l5.1523"></a><span id="l5.1523"> </span>
<a href="#l5.1524"></a><span id="l5.1524">       mailnewsurl-&gt;SetMsgWindow(aMsgWindow);</span>
<a href="#l5.1525"></a><span id="l5.1525">       rv = mailnewsurl-&gt;GetServer(getter_AddRefs(aMsgIncomingServer));</span>
<a href="#l5.1526"></a><span id="l5.1526"> </span>
<a href="#l5.1527"></a><span id="l5.1527">       // Try to check if the message is offline</span>
<a href="#l5.1528"></a><span id="l5.1528">       bool hasMsgOffline = false;</span>
<a href="#l5.1529"></a><span id="l5.1529">       folder-&gt;HasMsgOffline(key, &amp;hasMsgOffline);</span>
<a href="#l5.1530"></a><span id="l5.1530">       mailnewsurl-&gt;SetMsgIsInLocalCache(hasMsgOffline);</span>
<a href="#l5.1531"></a><span id="l5.1531">       imapUrl-&gt;SetLocalFetchOnly(aLocalOnly);</span>
<a href="#l5.1532"></a><span id="l5.1532"> </span>
<a href="#l5.1533"></a><span id="l5.1533" class="difflineminus">-      // If we don't have the message available locally, and we can't get it over</span>
<a href="#l5.1534"></a><span id="l5.1534" class="difflineminus">-      // the network, return with an error</span>
<a href="#l5.1535"></a><span id="l5.1535" class="difflineminus">-      if (aLocalOnly || WeAreOffline())</span>
<a href="#l5.1536"></a><span id="l5.1536" class="difflineminus">-      {</span>
<a href="#l5.1537"></a><span id="l5.1537" class="difflineplus">+      // If we don't have the message available locally, and we can't get it</span>
<a href="#l5.1538"></a><span id="l5.1538" class="difflineplus">+      // over the network, return with an error</span>
<a href="#l5.1539"></a><span id="l5.1539" class="difflineplus">+      if (aLocalOnly || WeAreOffline()) {</span>
<a href="#l5.1540"></a><span id="l5.1540">         bool isMsgInMemCache = false;</span>
<a href="#l5.1541"></a><span id="l5.1541" class="difflineminus">-        if (!hasMsgOffline)</span>
<a href="#l5.1542"></a><span id="l5.1542" class="difflineminus">-        {</span>
<a href="#l5.1543"></a><span id="l5.1543" class="difflineplus">+        if (!hasMsgOffline) {</span>
<a href="#l5.1544"></a><span id="l5.1544">           rv = IsMsgInMemCache(mailnewsurl, folder, &amp;isMsgInMemCache);</span>
<a href="#l5.1545"></a><span id="l5.1545">           NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.1546"></a><span id="l5.1546"> </span>
<a href="#l5.1547"></a><span id="l5.1547" class="difflineminus">-          if (!isMsgInMemCache)</span>
<a href="#l5.1548"></a><span id="l5.1548" class="difflineminus">-            return NS_ERROR_FAILURE;</span>
<a href="#l5.1549"></a><span id="l5.1549" class="difflineplus">+          if (!isMsgInMemCache) return NS_ERROR_FAILURE;</span>
<a href="#l5.1550"></a><span id="l5.1550">         }</span>
<a href="#l5.1551"></a><span id="l5.1551">       }</span>
<a href="#l5.1552"></a><span id="l5.1552"> </span>
<a href="#l5.1553"></a><span id="l5.1553">       bool shouldStoreMsgOffline = false;</span>
<a href="#l5.1554"></a><span id="l5.1554">       folder-&gt;ShouldStoreMsgOffline(key, &amp;shouldStoreMsgOffline);</span>
<a href="#l5.1555"></a><span id="l5.1555">       imapUrl-&gt;SetStoreResultsOffline(shouldStoreMsgOffline);</span>
<a href="#l5.1556"></a><span id="l5.1556">       rv = GetMessageFromUrl(imapUrl, nsIImapUrl::nsImapMsgFetchPeek, folder,</span>
<a href="#l5.1557"></a><span id="l5.1557">                              imapMessageSink, aMsgWindow, aConsumer,</span>
<a href="#l5.1558"></a><span id="l5.1558" class="difflineat">@@ -1220,64 +1148,58 @@ NS_IMETHODIMP nsImapService::StreamMessa</span>
<a href="#l5.1559"></a><span id="l5.1559">   }</span>
<a href="#l5.1560"></a><span id="l5.1560">   return rv;</span>
<a href="#l5.1561"></a><span id="l5.1561"> }</span>
<a href="#l5.1562"></a><span id="l5.1562"> </span>
<a href="#l5.1563"></a><span id="l5.1563"> // this method streams a message's headers to the passed in consumer.</span>
<a href="#l5.1564"></a><span id="l5.1564"> NS_IMETHODIMP nsImapService::StreamHeaders(const char *aMessageURI,</span>
<a href="#l5.1565"></a><span id="l5.1565">                                            nsIStreamListener *aConsumer,</span>
<a href="#l5.1566"></a><span id="l5.1566">                                            nsIUrlListener *aUrlListener,</span>
<a href="#l5.1567"></a><span id="l5.1567" class="difflineminus">-                                           bool aLocalOnly,</span>
<a href="#l5.1568"></a><span id="l5.1568" class="difflineminus">-                                           nsIURI **aURL)</span>
<a href="#l5.1569"></a><span id="l5.1569" class="difflineminus">-{</span>
<a href="#l5.1570"></a><span id="l5.1570" class="difflineplus">+                                           bool aLocalOnly, nsIURI **aURL) {</span>
<a href="#l5.1571"></a><span id="l5.1571">   NS_ENSURE_ARG_POINTER(aMessageURI);</span>
<a href="#l5.1572"></a><span id="l5.1572">   NS_ENSURE_ARG_POINTER(aConsumer);</span>
<a href="#l5.1573"></a><span id="l5.1573">   nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l5.1574"></a><span id="l5.1574">   nsAutoCString msgKey;</span>
<a href="#l5.1575"></a><span id="l5.1575">   nsAutoCString folderURI;</span>
<a href="#l5.1576"></a><span id="l5.1576">   nsCString mimePart;</span>
<a href="#l5.1577"></a><span id="l5.1577">   nsMsgKey key;</span>
<a href="#l5.1578"></a><span id="l5.1578"> </span>
<a href="#l5.1579"></a><span id="l5.1579" class="difflineminus">-  nsresult rv = DecomposeImapURI(nsDependentCString(aMessageURI), getter_AddRefs(folder), msgKey);</span>
<a href="#l5.1580"></a><span id="l5.1580" class="difflineplus">+  nsresult rv = DecomposeImapURI(nsDependentCString(aMessageURI),</span>
<a href="#l5.1581"></a><span id="l5.1581" class="difflineplus">+                                 getter_AddRefs(folder), msgKey);</span>
<a href="#l5.1582"></a><span id="l5.1582">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.1583"></a><span id="l5.1583"> </span>
<a href="#l5.1584"></a><span id="l5.1584" class="difflineminus">-  if (msgKey.IsEmpty())</span>
<a href="#l5.1585"></a><span id="l5.1585" class="difflineminus">-    return NS_MSG_MESSAGE_NOT_FOUND;</span>
<a href="#l5.1586"></a><span id="l5.1586" class="difflineminus">-  rv = nsParseImapMessageURI(aMessageURI, folderURI, &amp;key, getter_Copies(mimePart));</span>
<a href="#l5.1587"></a><span id="l5.1587" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l5.1588"></a><span id="l5.1588" class="difflineminus">-  {</span>
<a href="#l5.1589"></a><span id="l5.1589" class="difflineplus">+  if (msgKey.IsEmpty()) return NS_MSG_MESSAGE_NOT_FOUND;</span>
<a href="#l5.1590"></a><span id="l5.1590" class="difflineplus">+  rv = nsParseImapMessageURI(aMessageURI, folderURI, &amp;key,</span>
<a href="#l5.1591"></a><span id="l5.1591" class="difflineplus">+                             getter_Copies(mimePart));</span>
<a href="#l5.1592"></a><span id="l5.1592" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l5.1593"></a><span id="l5.1593">     nsCOMPtr&lt;nsIInputStream&gt; inputStream;</span>
<a href="#l5.1594"></a><span id="l5.1594">     bool hasMsgOffline = false;</span>
<a href="#l5.1595"></a><span id="l5.1595">     folder-&gt;HasMsgOffline(key, &amp;hasMsgOffline);</span>
<a href="#l5.1596"></a><span id="l5.1596" class="difflineminus">-    if (hasMsgOffline)</span>
<a href="#l5.1597"></a><span id="l5.1597" class="difflineminus">-    {</span>
<a href="#l5.1598"></a><span id="l5.1598" class="difflineplus">+    if (hasMsgOffline) {</span>
<a href="#l5.1599"></a><span id="l5.1599">       int64_t messageOffset;</span>
<a href="#l5.1600"></a><span id="l5.1600">       uint32_t messageSize;</span>
<a href="#l5.1601"></a><span id="l5.1601" class="difflineminus">-      folder-&gt;GetOfflineFileStream(key, &amp;messageOffset, &amp;messageSize, getter_AddRefs(inputStream));</span>
<a href="#l5.1602"></a><span id="l5.1602" class="difflineminus">-      if (inputStream)</span>
<a href="#l5.1603"></a><span id="l5.1603" class="difflineminus">-        return MsgStreamMsgHeaders(inputStream, aConsumer);</span>
<a href="#l5.1604"></a><span id="l5.1604" class="difflineplus">+      folder-&gt;GetOfflineFileStream(key, &amp;messageOffset, &amp;messageSize,</span>
<a href="#l5.1605"></a><span id="l5.1605" class="difflineplus">+                                   getter_AddRefs(inputStream));</span>
<a href="#l5.1606"></a><span id="l5.1606" class="difflineplus">+      if (inputStream) return MsgStreamMsgHeaders(inputStream, aConsumer);</span>
<a href="#l5.1607"></a><span id="l5.1607">     }</span>
<a href="#l5.1608"></a><span id="l5.1608">   }</span>
<a href="#l5.1609"></a><span id="l5.1609"> </span>
<a href="#l5.1610"></a><span id="l5.1610" class="difflineminus">-  if (aLocalOnly)</span>
<a href="#l5.1611"></a><span id="l5.1611" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l5.1612"></a><span id="l5.1612" class="difflineplus">+  if (aLocalOnly) return NS_ERROR_FAILURE;</span>
<a href="#l5.1613"></a><span id="l5.1613">   return rv;</span>
<a href="#l5.1614"></a><span id="l5.1614"> }</span>
<a href="#l5.1615"></a><span id="l5.1615"> </span>
<a href="#l5.1616"></a><span id="l5.1616"> NS_IMETHODIMP nsImapService::IsMsgInMemCache(nsIURI *aUrl,</span>
<a href="#l5.1617"></a><span id="l5.1617">                                              nsIMsgFolder *aImapMailFolder,</span>
<a href="#l5.1618"></a><span id="l5.1618" class="difflineminus">-                                             bool *aResult)</span>
<a href="#l5.1619"></a><span id="l5.1619" class="difflineminus">-{</span>
<a href="#l5.1620"></a><span id="l5.1620" class="difflineplus">+                                             bool *aResult) {</span>
<a href="#l5.1621"></a><span id="l5.1621">   NS_ENSURE_ARG_POINTER(aUrl);</span>
<a href="#l5.1622"></a><span id="l5.1622">   NS_ENSURE_ARG_POINTER(aImapMailFolder);</span>
<a href="#l5.1623"></a><span id="l5.1623">   *aResult = false;</span>
<a href="#l5.1624"></a><span id="l5.1624"> </span>
<a href="#l5.1625"></a><span id="l5.1625">   // Poke around in the memory cache</span>
<a href="#l5.1626"></a><span id="l5.1626" class="difflineminus">-  if (mCacheStorage)</span>
<a href="#l5.1627"></a><span id="l5.1627" class="difflineminus">-  {</span>
<a href="#l5.1628"></a><span id="l5.1628" class="difflineplus">+  if (mCacheStorage) {</span>
<a href="#l5.1629"></a><span id="l5.1629">     nsAutoCString urlSpec;</span>
<a href="#l5.1630"></a><span id="l5.1630">     aUrl-&gt;GetSpec(urlSpec);</span>
<a href="#l5.1631"></a><span id="l5.1631"> </span>
<a href="#l5.1632"></a><span id="l5.1632">     // Strip any query qualifiers.</span>
<a href="#l5.1633"></a><span id="l5.1633">     bool truncated = false;</span>
<a href="#l5.1634"></a><span id="l5.1634">     int32_t ind = urlSpec.FindChar('?');</span>
<a href="#l5.1635"></a><span id="l5.1635">     if (ind != kNotFound) {</span>
<a href="#l5.1636"></a><span id="l5.1636">       urlSpec.SetLength(ind);</span>
<a href="#l5.1637"></a><span id="l5.1637" class="difflineat">@@ -1285,17 +1207,18 @@ NS_IMETHODIMP nsImapService::IsMsgInMemC</span>
<a href="#l5.1638"></a><span id="l5.1638">     }</span>
<a href="#l5.1639"></a><span id="l5.1639">     ind = urlSpec.Find(&quot;/;&quot;);</span>
<a href="#l5.1640"></a><span id="l5.1640">     if (ind != kNotFound) {</span>
<a href="#l5.1641"></a><span id="l5.1641">       urlSpec.SetLength(ind);</span>
<a href="#l5.1642"></a><span id="l5.1642">       truncated = true;</span>
<a href="#l5.1643"></a><span id="l5.1643">     }</span>
<a href="#l5.1644"></a><span id="l5.1644"> </span>
<a href="#l5.1645"></a><span id="l5.1645">     nsresult rv;</span>
<a href="#l5.1646"></a><span id="l5.1646" class="difflineminus">-    nsCOMPtr&lt;nsIImapMailFolderSink&gt; folderSink(do_QueryInterface(aImapMailFolder, &amp;rv));</span>
<a href="#l5.1647"></a><span id="l5.1647" class="difflineplus">+    nsCOMPtr&lt;nsIImapMailFolderSink&gt; folderSink(</span>
<a href="#l5.1648"></a><span id="l5.1648" class="difflineplus">+        do_QueryInterface(aImapMailFolder, &amp;rv));</span>
<a href="#l5.1649"></a><span id="l5.1649">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.1650"></a><span id="l5.1650"> </span>
<a href="#l5.1651"></a><span id="l5.1651">     int32_t uidValidity = -1;</span>
<a href="#l5.1652"></a><span id="l5.1652">     folderSink-&gt;GetUidValidity(&amp;uidValidity);</span>
<a href="#l5.1653"></a><span id="l5.1653">     // stick the uid validity in front of the url, so that if the uid validity</span>
<a href="#l5.1654"></a><span id="l5.1654">     // changes, we won't re-use the wrong cache entries.</span>
<a href="#l5.1655"></a><span id="l5.1655">     nsAutoCString extension;</span>
<a href="#l5.1656"></a><span id="l5.1656">     extension.AppendInt(uidValidity, 16);</span>
<a href="#l5.1657"></a><span id="l5.1657" class="difflineat">@@ -1317,45 +1240,42 @@ NS_IMETHODIMP nsImapService::IsMsgInMemC</span>
<a href="#l5.1658"></a><span id="l5.1658">   return NS_OK;</span>
<a href="#l5.1659"></a><span id="l5.1659"> }</span>
<a href="#l5.1660"></a><span id="l5.1660"> </span>
<a href="#l5.1661"></a><span id="l5.1661"> nsresult nsImapService::CreateStartOfImapUrl(const nsACString &amp;aImapURI,</span>
<a href="#l5.1662"></a><span id="l5.1662">                                              nsIImapUrl **imapUrl,</span>
<a href="#l5.1663"></a><span id="l5.1663">                                              nsIMsgFolder *aImapMailFolder,</span>
<a href="#l5.1664"></a><span id="l5.1664">                                              nsIUrlListener *aUrlListener,</span>
<a href="#l5.1665"></a><span id="l5.1665">                                              nsACString &amp;urlSpec,</span>
<a href="#l5.1666"></a><span id="l5.1666" class="difflineminus">-                                             char &amp;hierarchyDelimiter)</span>
<a href="#l5.1667"></a><span id="l5.1667" class="difflineminus">-{</span>
<a href="#l5.1668"></a><span id="l5.1668" class="difflineplus">+                                             char &amp;hierarchyDelimiter) {</span>
<a href="#l5.1669"></a><span id="l5.1669">   NS_ENSURE_ARG_POINTER(aImapMailFolder);</span>
<a href="#l5.1670"></a><span id="l5.1670"> </span>
<a href="#l5.1671"></a><span id="l5.1671">   nsCString hostname;</span>
<a href="#l5.1672"></a><span id="l5.1672">   nsCString username;</span>
<a href="#l5.1673"></a><span id="l5.1673">   nsCString escapedUsername;</span>
<a href="#l5.1674"></a><span id="l5.1674"> </span>
<a href="#l5.1675"></a><span id="l5.1675">   nsresult rv = aImapMailFolder-&gt;GetHostname(hostname);</span>
<a href="#l5.1676"></a><span id="l5.1676">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.1677"></a><span id="l5.1677">   rv = aImapMailFolder-&gt;GetUsername(username);</span>
<a href="#l5.1678"></a><span id="l5.1678">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.1679"></a><span id="l5.1679">   if (!username.IsEmpty())</span>
<a href="#l5.1680"></a><span id="l5.1680">     MsgEscapeString(username, nsINetUtil::ESCAPE_XALPHAS, escapedUsername);</span>
<a href="#l5.1681"></a><span id="l5.1681"> </span>
<a href="#l5.1682"></a><span id="l5.1682">   int32_t port = nsIImapUrl::DEFAULT_IMAP_PORT;</span>
<a href="#l5.1683"></a><span id="l5.1683">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l5.1684"></a><span id="l5.1684">   rv = aImapMailFolder-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l5.1685"></a><span id="l5.1685" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l5.1686"></a><span id="l5.1686" class="difflineminus">-  {</span>
<a href="#l5.1687"></a><span id="l5.1687" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l5.1688"></a><span id="l5.1688">     server-&gt;GetPort(&amp;port);</span>
<a href="#l5.1689"></a><span id="l5.1689">     if (port == -1 || port == 0) port = nsIImapUrl::DEFAULT_IMAP_PORT;</span>
<a href="#l5.1690"></a><span id="l5.1690">   }</span>
<a href="#l5.1691"></a><span id="l5.1691"> </span>
<a href="#l5.1692"></a><span id="l5.1692">   // now we need to create an imap url to load into the connection. The url</span>
<a href="#l5.1693"></a><span id="l5.1693">   // needs to represent a select folder action.</span>
<a href="#l5.1694"></a><span id="l5.1694">   rv = CallCreateInstance(kImapUrlCID, imapUrl);</span>
<a href="#l5.1695"></a><span id="l5.1695" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; *imapUrl)</span>
<a href="#l5.1696"></a><span id="l5.1696" class="difflineminus">-  {</span>
<a href="#l5.1697"></a><span id="l5.1697" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; *imapUrl) {</span>
<a href="#l5.1698"></a><span id="l5.1698">     nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsUrl = do_QueryInterface(*imapUrl, &amp;rv);</span>
<a href="#l5.1699"></a><span id="l5.1699">     if (NS_SUCCEEDED(rv) &amp;&amp; mailnewsUrl &amp;&amp; aUrlListener)</span>
<a href="#l5.1700"></a><span id="l5.1700">       mailnewsUrl-&gt;RegisterListener(aUrlListener);</span>
<a href="#l5.1701"></a><span id="l5.1701">     nsCOMPtr&lt;nsIMsgMessageUrl&gt; msgurl(do_QueryInterface(*imapUrl));</span>
<a href="#l5.1702"></a><span id="l5.1702">     (*imapUrl)-&gt;SetExternalLinkUrl(false);</span>
<a href="#l5.1703"></a><span id="l5.1703">     msgurl-&gt;SetUri(PromiseFlatCString(aImapURI).get());</span>
<a href="#l5.1704"></a><span id="l5.1704"> </span>
<a href="#l5.1705"></a><span id="l5.1705">     urlSpec = &quot;imap://&quot;;</span>
<a href="#l5.1706"></a><span id="l5.1706" class="difflineat">@@ -1369,101 +1289,95 @@ nsresult nsImapService::CreateStartOfIma</span>
<a href="#l5.1707"></a><span id="l5.1707">     urlSpec.Append(portStr);</span>
<a href="#l5.1708"></a><span id="l5.1708"> </span>
<a href="#l5.1709"></a><span id="l5.1709">     // *** jefft - force to parse the urlSpec in order to search for</span>
<a href="#l5.1710"></a><span id="l5.1710">     // the correct incoming server</span>
<a href="#l5.1711"></a><span id="l5.1711">     rv = mailnewsUrl-&gt;SetSpecInternal(urlSpec);</span>
<a href="#l5.1712"></a><span id="l5.1712">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.1713"></a><span id="l5.1713"> </span>
<a href="#l5.1714"></a><span id="l5.1714">     hierarchyDelimiter = kOnlineHierarchySeparatorUnknown;</span>
<a href="#l5.1715"></a><span id="l5.1715" class="difflineminus">-    nsCOMPtr &lt;nsIMsgImapMailFolder&gt; imapFolder = do_QueryInterface(aImapMailFolder);</span>
<a href="#l5.1716"></a><span id="l5.1716" class="difflineminus">-    if (imapFolder)</span>
<a href="#l5.1717"></a><span id="l5.1717" class="difflineminus">-      imapFolder-&gt;GetHierarchyDelimiter(&amp;hierarchyDelimiter);</span>
<a href="#l5.1718"></a><span id="l5.1718" class="difflineplus">+    nsCOMPtr&lt;nsIMsgImapMailFolder&gt; imapFolder =</span>
<a href="#l5.1719"></a><span id="l5.1719" class="difflineplus">+        do_QueryInterface(aImapMailFolder);</span>
<a href="#l5.1720"></a><span id="l5.1720" class="difflineplus">+    if (imapFolder) imapFolder-&gt;GetHierarchyDelimiter(&amp;hierarchyDelimiter);</span>
<a href="#l5.1721"></a><span id="l5.1721">   }</span>
<a href="#l5.1722"></a><span id="l5.1722">   return rv;</span>
<a href="#l5.1723"></a><span id="l5.1723"> }</span>
<a href="#l5.1724"></a><span id="l5.1724"> </span>
<a href="#l5.1725"></a><span id="l5.1725"> /* fetching the headers of RFC822 messages */</span>
<a href="#l5.1726"></a><span id="l5.1726"> /* imap4://HOST&gt;header&gt;&lt;UID/SEQUENCE&gt;&gt;MAILBOXPATH&gt;x */</span>
<a href="#l5.1727"></a><span id="l5.1727"> /*   'x' is the message UID or sequence number list */</span>
<a href="#l5.1728"></a><span id="l5.1728"> /* will not affect the 'SEEN' flag */</span>
<a href="#l5.1729"></a><span id="l5.1729"> NS_IMETHODIMP nsImapService::GetHeaders(nsIMsgFolder *aImapMailFolder,</span>
<a href="#l5.1730"></a><span id="l5.1730">                                         nsIUrlListener *aUrlListener,</span>
<a href="#l5.1731"></a><span id="l5.1731">                                         nsIURI **aURL,</span>
<a href="#l5.1732"></a><span id="l5.1732">                                         const nsACString &amp;messageIdentifierList,</span>
<a href="#l5.1733"></a><span id="l5.1733" class="difflineminus">-                                        bool messageIdsAreUID)</span>
<a href="#l5.1734"></a><span id="l5.1734" class="difflineminus">-{</span>
<a href="#l5.1735"></a><span id="l5.1735" class="difflineplus">+                                        bool messageIdsAreUID) {</span>
<a href="#l5.1736"></a><span id="l5.1736">   // create a protocol instance to handle the request.</span>
<a href="#l5.1737"></a><span id="l5.1737" class="difflineminus">-  // NOTE: once we start working with multiple connections, this step will be much more complicated...but for now</span>
<a href="#l5.1738"></a><span id="l5.1738" class="difflineminus">-  // just create a connection and process the request.</span>
<a href="#l5.1739"></a><span id="l5.1739" class="difflineplus">+  // NOTE: once we start working with multiple connections, this step will be</span>
<a href="#l5.1740"></a><span id="l5.1740" class="difflineplus">+  // much more complicated...but for now just create a connection and process</span>
<a href="#l5.1741"></a><span id="l5.1741" class="difflineplus">+  // the request.</span>
<a href="#l5.1742"></a><span id="l5.1742">   NS_ENSURE_ARG_POINTER(aImapMailFolder);</span>
<a href="#l5.1743"></a><span id="l5.1743"> </span>
<a href="#l5.1744"></a><span id="l5.1744">   nsCOMPtr&lt;nsIImapUrl&gt; imapUrl;</span>
<a href="#l5.1745"></a><span id="l5.1745">   nsAutoCString urlSpec;</span>
<a href="#l5.1746"></a><span id="l5.1746">   char hierarchyDelimiter = GetHierarchyDelimiter(aImapMailFolder);</span>
<a href="#l5.1747"></a><span id="l5.1747"> </span>
<a href="#l5.1748"></a><span id="l5.1748" class="difflineminus">-  nsresult rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(imapUrl), aImapMailFolder,</span>
<a href="#l5.1749"></a><span id="l5.1749" class="difflineminus">-                                     aUrlListener, urlSpec, hierarchyDelimiter);</span>
<a href="#l5.1750"></a><span id="l5.1750" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; imapUrl)</span>
<a href="#l5.1751"></a><span id="l5.1751" class="difflineminus">-  {</span>
<a href="#l5.1752"></a><span id="l5.1752" class="difflineplus">+  nsresult rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(imapUrl),</span>
<a href="#l5.1753"></a><span id="l5.1753" class="difflineplus">+                                     aImapMailFolder, aUrlListener, urlSpec,</span>
<a href="#l5.1754"></a><span id="l5.1754" class="difflineplus">+                                     hierarchyDelimiter);</span>
<a href="#l5.1755"></a><span id="l5.1755" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; imapUrl) {</span>
<a href="#l5.1756"></a><span id="l5.1756">     nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsUrl = do_QueryInterface(imapUrl);</span>
<a href="#l5.1757"></a><span id="l5.1757"> </span>
<a href="#l5.1758"></a><span id="l5.1758">     rv = imapUrl-&gt;SetImapAction(nsIImapUrl::nsImapMsgFetch);</span>
<a href="#l5.1759"></a><span id="l5.1759">     rv = SetImapUrlSink(aImapMailFolder, imapUrl);</span>
<a href="#l5.1760"></a><span id="l5.1760"> </span>
<a href="#l5.1761"></a><span id="l5.1761" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l5.1762"></a><span id="l5.1762" class="difflineminus">-    {</span>
<a href="#l5.1763"></a><span id="l5.1763" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l5.1764"></a><span id="l5.1764">       urlSpec.AppendLiteral(&quot;/header&gt;&quot;);</span>
<a href="#l5.1765"></a><span id="l5.1765">       urlSpec.Append(messageIdsAreUID ? uidString : sequenceString);</span>
<a href="#l5.1766"></a><span id="l5.1766">       urlSpec.Append('&gt;');</span>
<a href="#l5.1767"></a><span id="l5.1767" class="difflineminus">-      urlSpec.Append(char (hierarchyDelimiter));</span>
<a href="#l5.1768"></a><span id="l5.1768" class="difflineplus">+      urlSpec.Append(char(hierarchyDelimiter));</span>
<a href="#l5.1769"></a><span id="l5.1769"> </span>
<a href="#l5.1770"></a><span id="l5.1770">       nsCString folderName;</span>
<a href="#l5.1771"></a><span id="l5.1771"> </span>
<a href="#l5.1772"></a><span id="l5.1772">       GetFolderName(aImapMailFolder, folderName);</span>
<a href="#l5.1773"></a><span id="l5.1773">       urlSpec.Append(folderName);</span>
<a href="#l5.1774"></a><span id="l5.1774">       urlSpec.Append('&gt;');</span>
<a href="#l5.1775"></a><span id="l5.1775">       urlSpec.Append(messageIdentifierList);</span>
<a href="#l5.1776"></a><span id="l5.1776">       rv = mailnewsUrl-&gt;SetSpecInternal(urlSpec);</span>
<a href="#l5.1777"></a><span id="l5.1777"> </span>
<a href="#l5.1778"></a><span id="l5.1778">       if (NS_SUCCEEDED(rv))</span>
<a href="#l5.1779"></a><span id="l5.1779">         rv = GetImapConnectionAndLoadUrl(imapUrl, nullptr, aURL);</span>
<a href="#l5.1780"></a><span id="l5.1780">     }</span>
<a href="#l5.1781"></a><span id="l5.1781">   }</span>
<a href="#l5.1782"></a><span id="l5.1782">   return rv;</span>
<a href="#l5.1783"></a><span id="l5.1783"> }</span>
<a href="#l5.1784"></a><span id="l5.1784"> </span>
<a href="#l5.1785"></a><span id="l5.1785" class="difflineminus">-</span>
<a href="#l5.1786"></a><span id="l5.1786"> /* peeking at the start of msg bodies */</span>
<a href="#l5.1787"></a><span id="l5.1787"> /* imap4://HOST&gt;header&gt;&lt;UID&gt;&gt;MAILBOXPATH&gt;x&gt;n */</span>
<a href="#l5.1788"></a><span id="l5.1788"> /*   'x' is the message UID */</span>
<a href="#l5.1789"></a><span id="l5.1789"> /*   'n' is the number of bytes to fetch */</span>
<a href="#l5.1790"></a><span id="l5.1790"> /* will not affect the 'SEEN' flag */</span>
<a href="#l5.1791"></a><span id="l5.1791" class="difflineminus">-NS_IMETHODIMP nsImapService::GetBodyStart(nsIMsgFolder *aImapMailFolder,</span>
<a href="#l5.1792"></a><span id="l5.1792" class="difflineminus">-                                          nsIUrlListener *aUrlListener,</span>
<a href="#l5.1793"></a><span id="l5.1793" class="difflineminus">-                                          const nsACString &amp;messageIdentifierList,</span>
<a href="#l5.1794"></a><span id="l5.1794" class="difflineminus">-                                          int32_t numBytes,</span>
<a href="#l5.1795"></a><span id="l5.1795" class="difflineminus">-                                          nsIURI **aURL)</span>
<a href="#l5.1796"></a><span id="l5.1796" class="difflineminus">-{</span>
<a href="#l5.1797"></a><span id="l5.1797" class="difflineplus">+NS_IMETHODIMP nsImapService::GetBodyStart(</span>
<a href="#l5.1798"></a><span id="l5.1798" class="difflineplus">+    nsIMsgFolder *aImapMailFolder, nsIUrlListener *aUrlListener,</span>
<a href="#l5.1799"></a><span id="l5.1799" class="difflineplus">+    const nsACString &amp;messageIdentifierList, int32_t numBytes, nsIURI **aURL) {</span>
<a href="#l5.1800"></a><span id="l5.1800">   NS_ENSURE_ARG_POINTER(aImapMailFolder);</span>
<a href="#l5.1801"></a><span id="l5.1801"> </span>
<a href="#l5.1802"></a><span id="l5.1802">   nsresult rv;</span>
<a href="#l5.1803"></a><span id="l5.1803">   nsCOMPtr&lt;nsIImapUrl&gt; imapUrl;</span>
<a href="#l5.1804"></a><span id="l5.1804">   nsAutoCString urlSpec;</span>
<a href="#l5.1805"></a><span id="l5.1805"> </span>
<a href="#l5.1806"></a><span id="l5.1806">   char hierarchyDelimiter = GetHierarchyDelimiter(aImapMailFolder);</span>
<a href="#l5.1807"></a><span id="l5.1807" class="difflineminus">-  rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(imapUrl), aImapMailFolder,</span>
<a href="#l5.1808"></a><span id="l5.1808" class="difflineminus">-    aUrlListener, urlSpec, hierarchyDelimiter);</span>
<a href="#l5.1809"></a><span id="l5.1809" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; imapUrl)</span>
<a href="#l5.1810"></a><span id="l5.1810" class="difflineminus">-  {</span>
<a href="#l5.1811"></a><span id="l5.1811" class="difflineplus">+  rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(imapUrl),</span>
<a href="#l5.1812"></a><span id="l5.1812" class="difflineplus">+                            aImapMailFolder, aUrlListener, urlSpec,</span>
<a href="#l5.1813"></a><span id="l5.1813" class="difflineplus">+                            hierarchyDelimiter);</span>
<a href="#l5.1814"></a><span id="l5.1814" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; imapUrl) {</span>
<a href="#l5.1815"></a><span id="l5.1815">     rv = imapUrl-&gt;SetImapAction(nsIImapUrl::nsImapMsgPreview);</span>
<a href="#l5.1816"></a><span id="l5.1816">     rv = SetImapUrlSink(aImapMailFolder, imapUrl);</span>
<a href="#l5.1817"></a><span id="l5.1817"> </span>
<a href="#l5.1818"></a><span id="l5.1818" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l5.1819"></a><span id="l5.1819" class="difflineminus">-    {</span>
<a href="#l5.1820"></a><span id="l5.1820" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l5.1821"></a><span id="l5.1821">       nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsUrl = do_QueryInterface(imapUrl);</span>
<a href="#l5.1822"></a><span id="l5.1822"> </span>
<a href="#l5.1823"></a><span id="l5.1823">       urlSpec.AppendLiteral(&quot;/previewBody&gt;&quot;);</span>
<a href="#l5.1824"></a><span id="l5.1824">       urlSpec.Append(uidString);</span>
<a href="#l5.1825"></a><span id="l5.1825">       urlSpec.Append('&gt;');</span>
<a href="#l5.1826"></a><span id="l5.1826">       urlSpec.Append(hierarchyDelimiter);</span>
<a href="#l5.1827"></a><span id="l5.1827"> </span>
<a href="#l5.1828"></a><span id="l5.1828">       nsCString folderName;</span>
<a href="#l5.1829"></a><span id="l5.1829" class="difflineat">@@ -1480,136 +1394,121 @@ NS_IMETHODIMP nsImapService::GetBodyStar</span>
<a href="#l5.1830"></a><span id="l5.1830">   }</span>
<a href="#l5.1831"></a><span id="l5.1831">   return rv;</span>
<a href="#l5.1832"></a><span id="l5.1832"> }</span>
<a href="#l5.1833"></a><span id="l5.1833"> </span>
<a href="#l5.1834"></a><span id="l5.1834"> nsresult nsImapService::FolderCommand(nsIMsgFolder *imapMailFolder,</span>
<a href="#l5.1835"></a><span id="l5.1835">                                       nsIUrlListener *urlListener,</span>
<a href="#l5.1836"></a><span id="l5.1836">                                       const char *aCommand,</span>
<a href="#l5.1837"></a><span id="l5.1837">                                       nsImapAction imapAction,</span>
<a href="#l5.1838"></a><span id="l5.1838" class="difflineminus">-                                      nsIMsgWindow *msgWindow,</span>
<a href="#l5.1839"></a><span id="l5.1839" class="difflineminus">-                                      nsIURI **url)</span>
<a href="#l5.1840"></a><span id="l5.1840" class="difflineminus">-{</span>
<a href="#l5.1841"></a><span id="l5.1841" class="difflineplus">+                                      nsIMsgWindow *msgWindow, nsIURI **url) {</span>
<a href="#l5.1842"></a><span id="l5.1842">   NS_ENSURE_ARG_POINTER(imapMailFolder);</span>
<a href="#l5.1843"></a><span id="l5.1843"> </span>
<a href="#l5.1844"></a><span id="l5.1844">   nsCOMPtr&lt;nsIImapUrl&gt; imapUrl;</span>
<a href="#l5.1845"></a><span id="l5.1845">   nsAutoCString urlSpec;</span>
<a href="#l5.1846"></a><span id="l5.1846"> </span>
<a href="#l5.1847"></a><span id="l5.1847">   char hierarchyDelimiter = GetHierarchyDelimiter(imapMailFolder);</span>
<a href="#l5.1848"></a><span id="l5.1848">   nsresult rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(imapUrl),</span>
<a href="#l5.1849"></a><span id="l5.1849" class="difflineminus">-                                     imapMailFolder, urlListener, urlSpec, hierarchyDelimiter);</span>
<a href="#l5.1850"></a><span id="l5.1850" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; imapUrl)</span>
<a href="#l5.1851"></a><span id="l5.1851" class="difflineminus">-  {</span>
<a href="#l5.1852"></a><span id="l5.1852" class="difflineplus">+                                     imapMailFolder, urlListener, urlSpec,</span>
<a href="#l5.1853"></a><span id="l5.1853" class="difflineplus">+                                     hierarchyDelimiter);</span>
<a href="#l5.1854"></a><span id="l5.1854" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; imapUrl) {</span>
<a href="#l5.1855"></a><span id="l5.1855">     rv = imapUrl-&gt;SetImapAction(imapAction);</span>
<a href="#l5.1856"></a><span id="l5.1856">     rv = SetImapUrlSink(imapMailFolder, imapUrl);</span>
<a href="#l5.1857"></a><span id="l5.1857">     nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsurl = do_QueryInterface(imapUrl);</span>
<a href="#l5.1858"></a><span id="l5.1858" class="difflineminus">-    if (mailnewsurl)</span>
<a href="#l5.1859"></a><span id="l5.1859" class="difflineminus">-      mailnewsurl-&gt;SetMsgWindow(msgWindow);</span>
<a href="#l5.1860"></a><span id="l5.1860" class="difflineminus">-</span>
<a href="#l5.1861"></a><span id="l5.1861" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l5.1862"></a><span id="l5.1862" class="difflineminus">-    {</span>
<a href="#l5.1863"></a><span id="l5.1863" class="difflineplus">+    if (mailnewsurl) mailnewsurl-&gt;SetMsgWindow(msgWindow);</span>
<a href="#l5.1864"></a><span id="l5.1864" class="difflineplus">+</span>
<a href="#l5.1865"></a><span id="l5.1865" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l5.1866"></a><span id="l5.1866">       urlSpec.Append(aCommand);</span>
<a href="#l5.1867"></a><span id="l5.1867">       urlSpec.Append(hierarchyDelimiter);</span>
<a href="#l5.1868"></a><span id="l5.1868"> </span>
<a href="#l5.1869"></a><span id="l5.1869">       nsCString folderName;</span>
<a href="#l5.1870"></a><span id="l5.1870">       GetFolderName(imapMailFolder, folderName);</span>
<a href="#l5.1871"></a><span id="l5.1871">       urlSpec.Append(folderName);</span>
<a href="#l5.1872"></a><span id="l5.1872">       rv = mailnewsurl-&gt;SetSpecInternal(urlSpec);</span>
<a href="#l5.1873"></a><span id="l5.1873">       if (NS_SUCCEEDED(rv))</span>
<a href="#l5.1874"></a><span id="l5.1874">         rv = GetImapConnectionAndLoadUrl(imapUrl, nullptr, url);</span>
<a href="#l5.1875"></a><span id="l5.1875">     }</span>
<a href="#l5.1876"></a><span id="l5.1876">   }</span>
<a href="#l5.1877"></a><span id="l5.1877">   return rv;</span>
<a href="#l5.1878"></a><span id="l5.1878"> }</span>
<a href="#l5.1879"></a><span id="l5.1879"> </span>
<a href="#l5.1880"></a><span id="l5.1880"> NS_IMETHODIMP</span>
<a href="#l5.1881"></a><span id="l5.1881"> nsImapService::VerifyLogon(nsIMsgFolder *aFolder, nsIUrlListener *aUrlListener,</span>
<a href="#l5.1882"></a><span id="l5.1882" class="difflineminus">-                           nsIMsgWindow *aMsgWindow, nsIURI **aURL)</span>
<a href="#l5.1883"></a><span id="l5.1883" class="difflineminus">-{</span>
<a href="#l5.1884"></a><span id="l5.1884" class="difflineplus">+                           nsIMsgWindow *aMsgWindow, nsIURI **aURL) {</span>
<a href="#l5.1885"></a><span id="l5.1885">   nsCOMPtr&lt;nsIImapUrl&gt; imapUrl;</span>
<a href="#l5.1886"></a><span id="l5.1886">   nsAutoCString urlSpec;</span>
<a href="#l5.1887"></a><span id="l5.1887"> </span>
<a href="#l5.1888"></a><span id="l5.1888" class="difflineminus">-  char delimiter = '/'; // shouldn't matter what is is.</span>
<a href="#l5.1889"></a><span id="l5.1889" class="difflineminus">-  nsresult rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(imapUrl), aFolder,</span>
<a href="#l5.1890"></a><span id="l5.1890" class="difflineminus">-                                     aUrlListener, urlSpec, delimiter);</span>
<a href="#l5.1891"></a><span id="l5.1891" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; imapUrl)</span>
<a href="#l5.1892"></a><span id="l5.1892" class="difflineminus">-  {</span>
<a href="#l5.1893"></a><span id="l5.1893" class="difflineplus">+  char delimiter = '/';  // shouldn't matter what is is.</span>
<a href="#l5.1894"></a><span id="l5.1894" class="difflineplus">+  nsresult rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(imapUrl),</span>
<a href="#l5.1895"></a><span id="l5.1895" class="difflineplus">+                                     aFolder, aUrlListener, urlSpec, delimiter);</span>
<a href="#l5.1896"></a><span id="l5.1896" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; imapUrl) {</span>
<a href="#l5.1897"></a><span id="l5.1897">     nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsurl = do_QueryInterface(imapUrl);</span>
<a href="#l5.1898"></a><span id="l5.1898"> </span>
<a href="#l5.1899"></a><span id="l5.1899">     nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailNewsUrl = do_QueryInterface(imapUrl);</span>
<a href="#l5.1900"></a><span id="l5.1900">     mailNewsUrl-&gt;SetSuppressErrorMsgs(true);</span>
<a href="#l5.1901"></a><span id="l5.1901">     mailNewsUrl-&gt;SetMsgWindow(aMsgWindow);</span>
<a href="#l5.1902"></a><span id="l5.1902">     rv = SetImapUrlSink(aFolder, imapUrl);</span>
<a href="#l5.1903"></a><span id="l5.1903">     urlSpec.AppendLiteral(&quot;/verifyLogon&quot;);</span>
<a href="#l5.1904"></a><span id="l5.1904">     rv = mailnewsurl-&gt;SetSpecInternal(urlSpec);</span>
<a href="#l5.1905"></a><span id="l5.1905">     if (NS_SUCCEEDED(rv))</span>
<a href="#l5.1906"></a><span id="l5.1906">       rv = GetImapConnectionAndLoadUrl(imapUrl, nullptr, nullptr);</span>
<a href="#l5.1907"></a><span id="l5.1907" class="difflineminus">-    if (aURL)</span>
<a href="#l5.1908"></a><span id="l5.1908" class="difflineminus">-      mailnewsurl.forget(aURL);</span>
<a href="#l5.1909"></a><span id="l5.1909" class="difflineplus">+    if (aURL) mailnewsurl.forget(aURL);</span>
<a href="#l5.1910"></a><span id="l5.1910">   }</span>
<a href="#l5.1911"></a><span id="l5.1911">   return rv;</span>
<a href="#l5.1912"></a><span id="l5.1912"> }</span>
<a href="#l5.1913"></a><span id="l5.1913"> </span>
<a href="#l5.1914"></a><span id="l5.1914"> // Noop, used to update a folder (causes server to send changes).</span>
<a href="#l5.1915"></a><span id="l5.1915"> NS_IMETHODIMP nsImapService::Noop(nsIMsgFolder *aImapMailFolder,</span>
<a href="#l5.1916"></a><span id="l5.1916" class="difflineminus">-                                  nsIUrlListener *aUrlListener,</span>
<a href="#l5.1917"></a><span id="l5.1917" class="difflineminus">-                                  nsIURI **aURL)</span>
<a href="#l5.1918"></a><span id="l5.1918" class="difflineminus">-{</span>
<a href="#l5.1919"></a><span id="l5.1919" class="difflineplus">+                                  nsIUrlListener *aUrlListener, nsIURI **aURL) {</span>
<a href="#l5.1920"></a><span id="l5.1920">   NS_ENSURE_ARG_POINTER(aImapMailFolder);</span>
<a href="#l5.1921"></a><span id="l5.1921"> </span>
<a href="#l5.1922"></a><span id="l5.1922" class="difflineminus">-  return FolderCommand(aImapMailFolder, aUrlListener,</span>
<a href="#l5.1923"></a><span id="l5.1923" class="difflineminus">-                       &quot;/selectnoop&gt;&quot;, nsIImapUrl::nsImapSelectNoopFolder, nullptr, aURL);</span>
<a href="#l5.1924"></a><span id="l5.1924" class="difflineplus">+  return FolderCommand(aImapMailFolder, aUrlListener, &quot;/selectnoop&gt;&quot;,</span>
<a href="#l5.1925"></a><span id="l5.1925" class="difflineplus">+                       nsIImapUrl::nsImapSelectNoopFolder, nullptr, aURL);</span>
<a href="#l5.1926"></a><span id="l5.1926"> }</span>
<a href="#l5.1927"></a><span id="l5.1927"> </span>
<a href="#l5.1928"></a><span id="l5.1928"> // FolderStatus, used to update message counts</span>
<a href="#l5.1929"></a><span id="l5.1929"> NS_IMETHODIMP nsImapService::UpdateFolderStatus(nsIMsgFolder *aImapMailFolder,</span>
<a href="#l5.1930"></a><span id="l5.1930">                                                 nsIUrlListener *aUrlListener,</span>
<a href="#l5.1931"></a><span id="l5.1931" class="difflineminus">-                                                nsIURI **aURL)</span>
<a href="#l5.1932"></a><span id="l5.1932" class="difflineminus">-{</span>
<a href="#l5.1933"></a><span id="l5.1933" class="difflineplus">+                                                nsIURI **aURL) {</span>
<a href="#l5.1934"></a><span id="l5.1934">   NS_ENSURE_ARG_POINTER(aImapMailFolder);</span>
<a href="#l5.1935"></a><span id="l5.1935"> </span>
<a href="#l5.1936"></a><span id="l5.1936" class="difflineminus">-  return FolderCommand(aImapMailFolder, aUrlListener,</span>
<a href="#l5.1937"></a><span id="l5.1937" class="difflineminus">-                       &quot;/folderstatus&gt;&quot;, nsIImapUrl::nsImapFolderStatus, nullptr, aURL);</span>
<a href="#l5.1938"></a><span id="l5.1938" class="difflineplus">+  return FolderCommand(aImapMailFolder, aUrlListener, &quot;/folderstatus&gt;&quot;,</span>
<a href="#l5.1939"></a><span id="l5.1939" class="difflineplus">+                       nsIImapUrl::nsImapFolderStatus, nullptr, aURL);</span>
<a href="#l5.1940"></a><span id="l5.1940"> }</span>
<a href="#l5.1941"></a><span id="l5.1941"> </span>
<a href="#l5.1942"></a><span id="l5.1942"> // Expunge, used to &quot;compress&quot; an imap folder,removes deleted messages.</span>
<a href="#l5.1943"></a><span id="l5.1943"> NS_IMETHODIMP nsImapService::Expunge(nsIMsgFolder *aImapMailFolder,</span>
<a href="#l5.1944"></a><span id="l5.1944">                                      nsIUrlListener *aUrlListener,</span>
<a href="#l5.1945"></a><span id="l5.1945" class="difflineminus">-                                     nsIMsgWindow *aMsgWindow,</span>
<a href="#l5.1946"></a><span id="l5.1946" class="difflineminus">-                                     nsIURI **aURL)</span>
<a href="#l5.1947"></a><span id="l5.1947" class="difflineminus">-{</span>
<a href="#l5.1948"></a><span id="l5.1948" class="difflineplus">+                                     nsIMsgWindow *aMsgWindow, nsIURI **aURL) {</span>
<a href="#l5.1949"></a><span id="l5.1949">   NS_ENSURE_ARG_POINTER(aImapMailFolder);</span>
<a href="#l5.1950"></a><span id="l5.1950"> </span>
<a href="#l5.1951"></a><span id="l5.1951" class="difflineminus">-  return FolderCommand(aImapMailFolder, aUrlListener,</span>
<a href="#l5.1952"></a><span id="l5.1952" class="difflineminus">-                       &quot;/Expunge&gt;&quot;, nsIImapUrl::nsImapExpungeFolder, aMsgWindow, aURL);</span>
<a href="#l5.1953"></a><span id="l5.1953" class="difflineplus">+  return FolderCommand(aImapMailFolder, aUrlListener, &quot;/Expunge&gt;&quot;,</span>
<a href="#l5.1954"></a><span id="l5.1954" class="difflineplus">+                       nsIImapUrl::nsImapExpungeFolder, aMsgWindow, aURL);</span>
<a href="#l5.1955"></a><span id="l5.1955"> }</span>
<a href="#l5.1956"></a><span id="l5.1956"> </span>
<a href="#l5.1957"></a><span id="l5.1957"> /* old-stle biff that doesn't download headers */</span>
<a href="#l5.1958"></a><span id="l5.1958"> NS_IMETHODIMP nsImapService::Biff(nsIMsgFolder *aImapMailFolder,</span>
<a href="#l5.1959"></a><span id="l5.1959" class="difflineminus">-                                  nsIUrlListener *aUrlListener,</span>
<a href="#l5.1960"></a><span id="l5.1960" class="difflineminus">-                                  nsIURI **aURL,</span>
<a href="#l5.1961"></a><span id="l5.1961" class="difflineminus">-                                  uint32_t uidHighWater)</span>
<a href="#l5.1962"></a><span id="l5.1962" class="difflineminus">-{</span>
<a href="#l5.1963"></a><span id="l5.1963" class="difflineplus">+                                  nsIUrlListener *aUrlListener, nsIURI **aURL,</span>
<a href="#l5.1964"></a><span id="l5.1964" class="difflineplus">+                                  uint32_t uidHighWater) {</span>
<a href="#l5.1965"></a><span id="l5.1965">   NS_ENSURE_ARG_POINTER(aImapMailFolder);</span>
<a href="#l5.1966"></a><span id="l5.1966"> </span>
<a href="#l5.1967"></a><span id="l5.1967">   // static const char *formatString = &quot;biff&gt;%c%s&gt;%ld&quot;;</span>
<a href="#l5.1968"></a><span id="l5.1968">   nsCOMPtr&lt;nsIImapUrl&gt; imapUrl;</span>
<a href="#l5.1969"></a><span id="l5.1969">   nsAutoCString urlSpec;</span>
<a href="#l5.1970"></a><span id="l5.1970"> </span>
<a href="#l5.1971"></a><span id="l5.1971">   char hierarchyDelimiter = GetHierarchyDelimiter(aImapMailFolder);</span>
<a href="#l5.1972"></a><span id="l5.1972">   nsresult rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(imapUrl),</span>
<a href="#l5.1973"></a><span id="l5.1973" class="difflineminus">-    aImapMailFolder, aUrlListener, urlSpec, hierarchyDelimiter);</span>
<a href="#l5.1974"></a><span id="l5.1974" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; imapUrl)</span>
<a href="#l5.1975"></a><span id="l5.1975" class="difflineminus">-  {</span>
<a href="#l5.1976"></a><span id="l5.1976" class="difflineplus">+                                     aImapMailFolder, aUrlListener, urlSpec,</span>
<a href="#l5.1977"></a><span id="l5.1977" class="difflineplus">+                                     hierarchyDelimiter);</span>
<a href="#l5.1978"></a><span id="l5.1978" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; imapUrl) {</span>
<a href="#l5.1979"></a><span id="l5.1979">     rv = imapUrl-&gt;SetImapAction(nsIImapUrl::nsImapExpungeFolder);</span>
<a href="#l5.1980"></a><span id="l5.1980">     rv = SetImapUrlSink(aImapMailFolder, imapUrl);</span>
<a href="#l5.1981"></a><span id="l5.1981"> </span>
<a href="#l5.1982"></a><span id="l5.1982">     nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsurl = do_QueryInterface(imapUrl);</span>
<a href="#l5.1983"></a><span id="l5.1983" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l5.1984"></a><span id="l5.1984" class="difflineminus">-    {</span>
<a href="#l5.1985"></a><span id="l5.1985" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l5.1986"></a><span id="l5.1986">       urlSpec.AppendLiteral(&quot;/Biff&gt;&quot;);</span>
<a href="#l5.1987"></a><span id="l5.1987">       urlSpec.Append(hierarchyDelimiter);</span>
<a href="#l5.1988"></a><span id="l5.1988"> </span>
<a href="#l5.1989"></a><span id="l5.1989">       nsCString folderName;</span>
<a href="#l5.1990"></a><span id="l5.1990">       GetFolderName(aImapMailFolder, folderName);</span>
<a href="#l5.1991"></a><span id="l5.1991">       urlSpec.Append(folderName);</span>
<a href="#l5.1992"></a><span id="l5.1992">       urlSpec.Append('&gt;');</span>
<a href="#l5.1993"></a><span id="l5.1993">       urlSpec.AppendInt(uidHighWater);</span>
<a href="#l5.1994"></a><span id="l5.1994" class="difflineat">@@ -1619,61 +1518,56 @@ NS_IMETHODIMP nsImapService::Biff(nsIMsg</span>
<a href="#l5.1995"></a><span id="l5.1995">     }</span>
<a href="#l5.1996"></a><span id="l5.1996">   }</span>
<a href="#l5.1997"></a><span id="l5.1997">   return rv;</span>
<a href="#l5.1998"></a><span id="l5.1998"> }</span>
<a href="#l5.1999"></a><span id="l5.1999"> </span>
<a href="#l5.2000"></a><span id="l5.2000"> NS_IMETHODIMP nsImapService::DeleteFolder(nsIMsgFolder *aImapMailFolder,</span>
<a href="#l5.2001"></a><span id="l5.2001">                                           nsIUrlListener *aUrlListener,</span>
<a href="#l5.2002"></a><span id="l5.2002">                                           nsIMsgWindow *aMsgWindow,</span>
<a href="#l5.2003"></a><span id="l5.2003" class="difflineminus">-                                          nsIURI **aURL)</span>
<a href="#l5.2004"></a><span id="l5.2004" class="difflineminus">-{</span>
<a href="#l5.2005"></a><span id="l5.2005" class="difflineplus">+                                          nsIURI **aURL) {</span>
<a href="#l5.2006"></a><span id="l5.2006">   NS_ENSURE_ARG_POINTER(aImapMailFolder);</span>
<a href="#l5.2007"></a><span id="l5.2007"> </span>
<a href="#l5.2008"></a><span id="l5.2008">   // If it's an aol server then use 'deletefolder' url to</span>
<a href="#l5.2009"></a><span id="l5.2009">   // remove all msgs first and then remove the folder itself.</span>
<a href="#l5.2010"></a><span id="l5.2010">   bool removeFolderAndMsgs = false;</span>
<a href="#l5.2011"></a><span id="l5.2011">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l5.2012"></a><span id="l5.2012" class="difflineminus">-  if (NS_SUCCEEDED(aImapMailFolder-&gt;GetServer(getter_AddRefs(server))) &amp;&amp; server)</span>
<a href="#l5.2013"></a><span id="l5.2013" class="difflineminus">-  {</span>
<a href="#l5.2014"></a><span id="l5.2014" class="difflineminus">-    nsCOMPtr &lt;nsIImapIncomingServer&gt; imapServer = do_QueryInterface(server);</span>
<a href="#l5.2015"></a><span id="l5.2015" class="difflineminus">-    if (imapServer)</span>
<a href="#l5.2016"></a><span id="l5.2016" class="difflineminus">-      imapServer-&gt;GetIsAOLServer(&amp;removeFolderAndMsgs);</span>
<a href="#l5.2017"></a><span id="l5.2017" class="difflineplus">+  if (NS_SUCCEEDED(aImapMailFolder-&gt;GetServer(getter_AddRefs(server))) &amp;&amp;</span>
<a href="#l5.2018"></a><span id="l5.2018" class="difflineplus">+      server) {</span>
<a href="#l5.2019"></a><span id="l5.2019" class="difflineplus">+    nsCOMPtr&lt;nsIImapIncomingServer&gt; imapServer = do_QueryInterface(server);</span>
<a href="#l5.2020"></a><span id="l5.2020" class="difflineplus">+    if (imapServer) imapServer-&gt;GetIsAOLServer(&amp;removeFolderAndMsgs);</span>
<a href="#l5.2021"></a><span id="l5.2021">   }</span>
<a href="#l5.2022"></a><span id="l5.2022"> </span>
<a href="#l5.2023"></a><span id="l5.2023">   return FolderCommand(aImapMailFolder, aUrlListener,</span>
<a href="#l5.2024"></a><span id="l5.2024">                        removeFolderAndMsgs ? &quot;/deletefolder&gt;&quot; : &quot;/delete&gt;&quot;,</span>
<a href="#l5.2025"></a><span id="l5.2025">                        nsIImapUrl::nsImapDeleteFolder, aMsgWindow, aURL);</span>
<a href="#l5.2026"></a><span id="l5.2026"> }</span>
<a href="#l5.2027"></a><span id="l5.2027"> </span>
<a href="#l5.2028"></a><span id="l5.2028" class="difflineminus">-NS_IMETHODIMP nsImapService::DeleteMessages(nsIMsgFolder *aImapMailFolder,</span>
<a href="#l5.2029"></a><span id="l5.2029" class="difflineminus">-                                            nsIUrlListener *aUrlListener,</span>
<a href="#l5.2030"></a><span id="l5.2030" class="difflineminus">-                                            nsIURI **aURL,</span>
<a href="#l5.2031"></a><span id="l5.2031" class="difflineminus">-                                            const nsACString &amp;messageIdentifierList,</span>
<a href="#l5.2032"></a><span id="l5.2032" class="difflineminus">-                                            bool messageIdsAreUID)</span>
<a href="#l5.2033"></a><span id="l5.2033" class="difflineminus">-{</span>
<a href="#l5.2034"></a><span id="l5.2034" class="difflineplus">+NS_IMETHODIMP nsImapService::DeleteMessages(</span>
<a href="#l5.2035"></a><span id="l5.2035" class="difflineplus">+    nsIMsgFolder *aImapMailFolder, nsIUrlListener *aUrlListener, nsIURI **aURL,</span>
<a href="#l5.2036"></a><span id="l5.2036" class="difflineplus">+    const nsACString &amp;messageIdentifierList, bool messageIdsAreUID) {</span>
<a href="#l5.2037"></a><span id="l5.2037">   NS_ENSURE_ARG_POINTER(aImapMailFolder);</span>
<a href="#l5.2038"></a><span id="l5.2038"> </span>
<a href="#l5.2039"></a><span id="l5.2039">   // create a protocol instance to handle the request.</span>
<a href="#l5.2040"></a><span id="l5.2040" class="difflineminus">-  // NOTE: once we start working with multiple connections, this step will be much more complicated...but for now</span>
<a href="#l5.2041"></a><span id="l5.2041" class="difflineminus">-  // just create a connection and process the request.</span>
<a href="#l5.2042"></a><span id="l5.2042" class="difflineplus">+  // NOTE: once we start working with multiple connections, this step will be</span>
<a href="#l5.2043"></a><span id="l5.2043" class="difflineplus">+  // much more complicated...but for now just create a connection and process</span>
<a href="#l5.2044"></a><span id="l5.2044" class="difflineplus">+  // the request.</span>
<a href="#l5.2045"></a><span id="l5.2045">   nsresult rv;</span>
<a href="#l5.2046"></a><span id="l5.2046">   nsCOMPtr&lt;nsIImapUrl&gt; imapUrl;</span>
<a href="#l5.2047"></a><span id="l5.2047">   nsAutoCString urlSpec;</span>
<a href="#l5.2048"></a><span id="l5.2048"> </span>
<a href="#l5.2049"></a><span id="l5.2049">   char hierarchyDelimiter = GetHierarchyDelimiter(aImapMailFolder);</span>
<a href="#l5.2050"></a><span id="l5.2050" class="difflineminus">-  rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(imapUrl), aImapMailFolder,</span>
<a href="#l5.2051"></a><span id="l5.2051" class="difflineminus">-    aUrlListener, urlSpec, hierarchyDelimiter);</span>
<a href="#l5.2052"></a><span id="l5.2052" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; imapUrl)</span>
<a href="#l5.2053"></a><span id="l5.2053" class="difflineminus">-  {</span>
<a href="#l5.2054"></a><span id="l5.2054" class="difflineplus">+  rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(imapUrl),</span>
<a href="#l5.2055"></a><span id="l5.2055" class="difflineplus">+                            aImapMailFolder, aUrlListener, urlSpec,</span>
<a href="#l5.2056"></a><span id="l5.2056" class="difflineplus">+                            hierarchyDelimiter);</span>
<a href="#l5.2057"></a><span id="l5.2057" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; imapUrl) {</span>
<a href="#l5.2058"></a><span id="l5.2058">     rv = imapUrl-&gt;SetImapAction(nsIImapUrl::nsImapMsgFetch);</span>
<a href="#l5.2059"></a><span id="l5.2059">     rv = SetImapUrlSink(aImapMailFolder, imapUrl);</span>
<a href="#l5.2060"></a><span id="l5.2060"> </span>
<a href="#l5.2061"></a><span id="l5.2061" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l5.2062"></a><span id="l5.2062" class="difflineminus">-    {</span>
<a href="#l5.2063"></a><span id="l5.2063" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l5.2064"></a><span id="l5.2064">       nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsurl = do_QueryInterface(imapUrl);</span>
<a href="#l5.2065"></a><span id="l5.2065"> </span>
<a href="#l5.2066"></a><span id="l5.2066">       urlSpec.AppendLiteral(&quot;/deletemsg&gt;&quot;);</span>
<a href="#l5.2067"></a><span id="l5.2067">       urlSpec.Append(messageIdsAreUID ? uidString : sequenceString);</span>
<a href="#l5.2068"></a><span id="l5.2068">       urlSpec.Append('&gt;');</span>
<a href="#l5.2069"></a><span id="l5.2069">       urlSpec.Append(hierarchyDelimiter);</span>
<a href="#l5.2070"></a><span id="l5.2070"> </span>
<a href="#l5.2071"></a><span id="l5.2071">       nsCString folderName;</span>
<a href="#l5.2072"></a><span id="l5.2072" class="difflineat">@@ -1687,90 +1581,77 @@ NS_IMETHODIMP nsImapService::DeleteMessa</span>
<a href="#l5.2073"></a><span id="l5.2073">     }</span>
<a href="#l5.2074"></a><span id="l5.2074">   }</span>
<a href="#l5.2075"></a><span id="l5.2075">   return rv;</span>
<a href="#l5.2076"></a><span id="l5.2076"> }</span>
<a href="#l5.2077"></a><span id="l5.2077"> </span>
<a href="#l5.2078"></a><span id="l5.2078"> // Delete all messages in a folder, used to empty trash</span>
<a href="#l5.2079"></a><span id="l5.2079"> NS_IMETHODIMP nsImapService::DeleteAllMessages(nsIMsgFolder *aImapMailFolder,</span>
<a href="#l5.2080"></a><span id="l5.2080">                                                nsIUrlListener *aUrlListener,</span>
<a href="#l5.2081"></a><span id="l5.2081" class="difflineminus">-                                               nsIURI **aURL)</span>
<a href="#l5.2082"></a><span id="l5.2082" class="difflineminus">-{</span>
<a href="#l5.2083"></a><span id="l5.2083" class="difflineplus">+                                               nsIURI **aURL) {</span>
<a href="#l5.2084"></a><span id="l5.2084">   NS_ENSURE_ARG_POINTER(aImapMailFolder);</span>
<a href="#l5.2085"></a><span id="l5.2085"> </span>
<a href="#l5.2086"></a><span id="l5.2086" class="difflineminus">-  return FolderCommand(aImapMailFolder, aUrlListener,</span>
<a href="#l5.2087"></a><span id="l5.2087" class="difflineminus">-                      &quot;/deleteallmsgs&gt;&quot;, nsIImapUrl::nsImapSelectNoopFolder, nullptr, aURL);</span>
<a href="#l5.2088"></a><span id="l5.2088" class="difflineplus">+  return FolderCommand(aImapMailFolder, aUrlListener, &quot;/deleteallmsgs&gt;&quot;,</span>
<a href="#l5.2089"></a><span id="l5.2089" class="difflineplus">+                       nsIImapUrl::nsImapSelectNoopFolder, nullptr, aURL);</span>
<a href="#l5.2090"></a><span id="l5.2090"> }</span>
<a href="#l5.2091"></a><span id="l5.2091"> </span>
<a href="#l5.2092"></a><span id="l5.2092" class="difflineminus">-NS_IMETHODIMP nsImapService::AddMessageFlags(nsIMsgFolder *aImapMailFolder,</span>
<a href="#l5.2093"></a><span id="l5.2093" class="difflineminus">-                                             nsIUrlListener *aUrlListener,</span>
<a href="#l5.2094"></a><span id="l5.2094" class="difflineminus">-                                             nsIURI **aURL,</span>
<a href="#l5.2095"></a><span id="l5.2095" class="difflineminus">-                                             const nsACString &amp;messageIdentifierList,</span>
<a href="#l5.2096"></a><span id="l5.2096" class="difflineminus">-                                             imapMessageFlagsType flags,</span>
<a href="#l5.2097"></a><span id="l5.2097" class="difflineminus">-                                             bool messageIdsAreUID)</span>
<a href="#l5.2098"></a><span id="l5.2098" class="difflineminus">-{</span>
<a href="#l5.2099"></a><span id="l5.2099" class="difflineplus">+NS_IMETHODIMP nsImapService::AddMessageFlags(</span>
<a href="#l5.2100"></a><span id="l5.2100" class="difflineplus">+    nsIMsgFolder *aImapMailFolder, nsIUrlListener *aUrlListener, nsIURI **aURL,</span>
<a href="#l5.2101"></a><span id="l5.2101" class="difflineplus">+    const nsACString &amp;messageIdentifierList, imapMessageFlagsType flags,</span>
<a href="#l5.2102"></a><span id="l5.2102" class="difflineplus">+    bool messageIdsAreUID) {</span>
<a href="#l5.2103"></a><span id="l5.2103">   NS_ENSURE_ARG_POINTER(aImapMailFolder);</span>
<a href="#l5.2104"></a><span id="l5.2104"> </span>
<a href="#l5.2105"></a><span id="l5.2105">   return DiddleFlags(aImapMailFolder, aUrlListener, aURL, messageIdentifierList,</span>
<a href="#l5.2106"></a><span id="l5.2106">                      &quot;addmsgflags&quot;, flags, messageIdsAreUID);</span>
<a href="#l5.2107"></a><span id="l5.2107"> }</span>
<a href="#l5.2108"></a><span id="l5.2108"> </span>
<a href="#l5.2109"></a><span id="l5.2109" class="difflineminus">-NS_IMETHODIMP nsImapService::SubtractMessageFlags(nsIMsgFolder *aImapMailFolder,</span>
<a href="#l5.2110"></a><span id="l5.2110" class="difflineminus">-                                                  nsIUrlListener *aUrlListener,</span>
<a href="#l5.2111"></a><span id="l5.2111" class="difflineminus">-                                                  nsIURI **aURL,</span>
<a href="#l5.2112"></a><span id="l5.2112" class="difflineminus">-                                                  const nsACString &amp;messageIdentifierList,</span>
<a href="#l5.2113"></a><span id="l5.2113" class="difflineminus">-                                                  imapMessageFlagsType flags,</span>
<a href="#l5.2114"></a><span id="l5.2114" class="difflineminus">-                                                  bool messageIdsAreUID)</span>
<a href="#l5.2115"></a><span id="l5.2115" class="difflineminus">-{</span>
<a href="#l5.2116"></a><span id="l5.2116" class="difflineplus">+NS_IMETHODIMP nsImapService::SubtractMessageFlags(</span>
<a href="#l5.2117"></a><span id="l5.2117" class="difflineplus">+    nsIMsgFolder *aImapMailFolder, nsIUrlListener *aUrlListener, nsIURI **aURL,</span>
<a href="#l5.2118"></a><span id="l5.2118" class="difflineplus">+    const nsACString &amp;messageIdentifierList, imapMessageFlagsType flags,</span>
<a href="#l5.2119"></a><span id="l5.2119" class="difflineplus">+    bool messageIdsAreUID) {</span>
<a href="#l5.2120"></a><span id="l5.2120">   NS_ENSURE_ARG_POINTER(aImapMailFolder);</span>
<a href="#l5.2121"></a><span id="l5.2121"> </span>
<a href="#l5.2122"></a><span id="l5.2122">   return DiddleFlags(aImapMailFolder, aUrlListener, aURL, messageIdentifierList,</span>
<a href="#l5.2123"></a><span id="l5.2123">                      &quot;subtractmsgflags&quot;, flags, messageIdsAreUID);</span>
<a href="#l5.2124"></a><span id="l5.2124"> }</span>
<a href="#l5.2125"></a><span id="l5.2125"> </span>
<a href="#l5.2126"></a><span id="l5.2126" class="difflineminus">-NS_IMETHODIMP nsImapService::SetMessageFlags(nsIMsgFolder *aImapMailFolder,</span>
<a href="#l5.2127"></a><span id="l5.2127" class="difflineminus">-                                             nsIUrlListener *aUrlListener,</span>
<a href="#l5.2128"></a><span id="l5.2128" class="difflineminus">-                                             nsIURI **aURL,</span>
<a href="#l5.2129"></a><span id="l5.2129" class="difflineminus">-                                             const nsACString &amp;messageIdentifierList,</span>
<a href="#l5.2130"></a><span id="l5.2130" class="difflineminus">-                                             imapMessageFlagsType flags,</span>
<a href="#l5.2131"></a><span id="l5.2131" class="difflineminus">-                                             bool messageIdsAreUID)</span>
<a href="#l5.2132"></a><span id="l5.2132" class="difflineminus">-{</span>
<a href="#l5.2133"></a><span id="l5.2133" class="difflineplus">+NS_IMETHODIMP nsImapService::SetMessageFlags(</span>
<a href="#l5.2134"></a><span id="l5.2134" class="difflineplus">+    nsIMsgFolder *aImapMailFolder, nsIUrlListener *aUrlListener, nsIURI **aURL,</span>
<a href="#l5.2135"></a><span id="l5.2135" class="difflineplus">+    const nsACString &amp;messageIdentifierList, imapMessageFlagsType flags,</span>
<a href="#l5.2136"></a><span id="l5.2136" class="difflineplus">+    bool messageIdsAreUID) {</span>
<a href="#l5.2137"></a><span id="l5.2137">   NS_ENSURE_ARG_POINTER(aImapMailFolder);</span>
<a href="#l5.2138"></a><span id="l5.2138"> </span>
<a href="#l5.2139"></a><span id="l5.2139">   return DiddleFlags(aImapMailFolder, aUrlListener, aURL, messageIdentifierList,</span>
<a href="#l5.2140"></a><span id="l5.2140">                      &quot;setmsgflags&quot;, flags, messageIdsAreUID);</span>
<a href="#l5.2141"></a><span id="l5.2141"> }</span>
<a href="#l5.2142"></a><span id="l5.2142"> </span>
<a href="#l5.2143"></a><span id="l5.2143"> nsresult nsImapService::DiddleFlags(nsIMsgFolder *aImapMailFolder,</span>
<a href="#l5.2144"></a><span id="l5.2144" class="difflineminus">-                                    nsIUrlListener *aUrlListener,</span>
<a href="#l5.2145"></a><span id="l5.2145" class="difflineminus">-                                    nsIURI **aURL,</span>
<a href="#l5.2146"></a><span id="l5.2146" class="difflineplus">+                                    nsIUrlListener *aUrlListener, nsIURI **aURL,</span>
<a href="#l5.2147"></a><span id="l5.2147">                                     const nsACString &amp;messageIdentifierList,</span>
<a href="#l5.2148"></a><span id="l5.2148">                                     const char *howToDiddle,</span>
<a href="#l5.2149"></a><span id="l5.2149">                                     imapMessageFlagsType flags,</span>
<a href="#l5.2150"></a><span id="l5.2150" class="difflineminus">-                                    bool messageIdsAreUID)</span>
<a href="#l5.2151"></a><span id="l5.2151" class="difflineminus">-{</span>
<a href="#l5.2152"></a><span id="l5.2152" class="difflineplus">+                                    bool messageIdsAreUID) {</span>
<a href="#l5.2153"></a><span id="l5.2153">   NS_ENSURE_ARG_POINTER(aImapMailFolder);</span>
<a href="#l5.2154"></a><span id="l5.2154"> </span>
<a href="#l5.2155"></a><span id="l5.2155">   // create a protocol instance to handle the request.</span>
<a href="#l5.2156"></a><span id="l5.2156">   // NOTE: once we start working with multiple connections,</span>
<a href="#l5.2157"></a><span id="l5.2157">   //       this step will be much more complicated...but for now</span>
<a href="#l5.2158"></a><span id="l5.2158">   // just create a connection and process the request.</span>
<a href="#l5.2159"></a><span id="l5.2159">   nsCOMPtr&lt;nsIImapUrl&gt; imapUrl;</span>
<a href="#l5.2160"></a><span id="l5.2160">   nsAutoCString urlSpec;</span>
<a href="#l5.2161"></a><span id="l5.2161"> </span>
<a href="#l5.2162"></a><span id="l5.2162">   char hierarchyDelimiter = GetHierarchyDelimiter(aImapMailFolder);</span>
<a href="#l5.2163"></a><span id="l5.2163">   nsresult rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(imapUrl),</span>
<a href="#l5.2164"></a><span id="l5.2164" class="difflineminus">-                                     aImapMailFolder, aUrlListener, urlSpec, hierarchyDelimiter);</span>
<a href="#l5.2165"></a><span id="l5.2165" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; imapUrl)</span>
<a href="#l5.2166"></a><span id="l5.2166" class="difflineminus">-  {</span>
<a href="#l5.2167"></a><span id="l5.2167" class="difflineplus">+                                     aImapMailFolder, aUrlListener, urlSpec,</span>
<a href="#l5.2168"></a><span id="l5.2168" class="difflineplus">+                                     hierarchyDelimiter);</span>
<a href="#l5.2169"></a><span id="l5.2169" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; imapUrl) {</span>
<a href="#l5.2170"></a><span id="l5.2170">     rv = imapUrl-&gt;SetImapAction(nsIImapUrl::nsImapMsgFetch);</span>
<a href="#l5.2171"></a><span id="l5.2171">     rv = SetImapUrlSink(aImapMailFolder, imapUrl);</span>
<a href="#l5.2172"></a><span id="l5.2172"> </span>
<a href="#l5.2173"></a><span id="l5.2173" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l5.2174"></a><span id="l5.2174" class="difflineminus">-    {</span>
<a href="#l5.2175"></a><span id="l5.2175" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l5.2176"></a><span id="l5.2176">       nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsurl = do_QueryInterface(imapUrl);</span>
<a href="#l5.2177"></a><span id="l5.2177"> </span>
<a href="#l5.2178"></a><span id="l5.2178">       urlSpec.Append('/');</span>
<a href="#l5.2179"></a><span id="l5.2179">       urlSpec.Append(howToDiddle);</span>
<a href="#l5.2180"></a><span id="l5.2180">       urlSpec.Append('&gt;');</span>
<a href="#l5.2181"></a><span id="l5.2181">       urlSpec.Append(messageIdsAreUID ? uidString : sequenceString);</span>
<a href="#l5.2182"></a><span id="l5.2182">       urlSpec.Append('&gt;');</span>
<a href="#l5.2183"></a><span id="l5.2183">       urlSpec.Append(hierarchyDelimiter);</span>
<a href="#l5.2184"></a><span id="l5.2184" class="difflineat">@@ -1784,158 +1665,145 @@ nsresult nsImapService::DiddleFlags(nsIM</span>
<a href="#l5.2185"></a><span id="l5.2185">       rv = mailnewsurl-&gt;SetSpecInternal(urlSpec);</span>
<a href="#l5.2186"></a><span id="l5.2186">       if (NS_SUCCEEDED(rv))</span>
<a href="#l5.2187"></a><span id="l5.2187">         rv = GetImapConnectionAndLoadUrl(imapUrl, nullptr, aURL);</span>
<a href="#l5.2188"></a><span id="l5.2188">     }</span>
<a href="#l5.2189"></a><span id="l5.2189">   }</span>
<a href="#l5.2190"></a><span id="l5.2190">   return rv;</span>
<a href="#l5.2191"></a><span id="l5.2191"> }</span>
<a href="#l5.2192"></a><span id="l5.2192"> </span>
<a href="#l5.2193"></a><span id="l5.2193" class="difflineminus">-nsresult nsImapService::SetImapUrlSink(nsIMsgFolder *aMsgFolder, nsIImapUrl *aImapUrl)</span>
<a href="#l5.2194"></a><span id="l5.2194" class="difflineminus">-{</span>
<a href="#l5.2195"></a><span id="l5.2195" class="difflineplus">+nsresult nsImapService::SetImapUrlSink(nsIMsgFolder *aMsgFolder,</span>
<a href="#l5.2196"></a><span id="l5.2196" class="difflineplus">+                                       nsIImapUrl *aImapUrl) {</span>
<a href="#l5.2197"></a><span id="l5.2197">   NS_ENSURE_ARG_POINTER(aMsgFolder);</span>
<a href="#l5.2198"></a><span id="l5.2198">   NS_ENSURE_ARG_POINTER(aImapUrl);</span>
<a href="#l5.2199"></a><span id="l5.2199"> </span>
<a href="#l5.2200"></a><span id="l5.2200">   nsresult rv;</span>
<a href="#l5.2201"></a><span id="l5.2201">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; incomingServer;</span>
<a href="#l5.2202"></a><span id="l5.2202">   nsCOMPtr&lt;nsIImapServerSink&gt; imapServerSink;</span>
<a href="#l5.2203"></a><span id="l5.2203"> </span>
<a href="#l5.2204"></a><span id="l5.2204">   rv = aMsgFolder-&gt;GetServer(getter_AddRefs(incomingServer));</span>
<a href="#l5.2205"></a><span id="l5.2205" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; incomingServer)</span>
<a href="#l5.2206"></a><span id="l5.2206" class="difflineminus">-  {</span>
<a href="#l5.2207"></a><span id="l5.2207" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; incomingServer) {</span>
<a href="#l5.2208"></a><span id="l5.2208">     imapServerSink = do_QueryInterface(incomingServer);</span>
<a href="#l5.2209"></a><span id="l5.2209" class="difflineminus">-    if (imapServerSink)</span>
<a href="#l5.2210"></a><span id="l5.2210" class="difflineminus">-      aImapUrl-&gt;SetImapServerSink(imapServerSink);</span>
<a href="#l5.2211"></a><span id="l5.2211" class="difflineplus">+    if (imapServerSink) aImapUrl-&gt;SetImapServerSink(imapServerSink);</span>
<a href="#l5.2212"></a><span id="l5.2212">   }</span>
<a href="#l5.2213"></a><span id="l5.2213"> </span>
<a href="#l5.2214"></a><span id="l5.2214" class="difflineminus">-  nsCOMPtr&lt;nsIImapMailFolderSink&gt; imapMailFolderSink = do_QueryInterface(aMsgFolder);</span>
<a href="#l5.2215"></a><span id="l5.2215" class="difflineplus">+  nsCOMPtr&lt;nsIImapMailFolderSink&gt; imapMailFolderSink =</span>
<a href="#l5.2216"></a><span id="l5.2216" class="difflineplus">+      do_QueryInterface(aMsgFolder);</span>
<a href="#l5.2217"></a><span id="l5.2217">   if (NS_SUCCEEDED(rv) &amp;&amp; imapMailFolderSink)</span>
<a href="#l5.2218"></a><span id="l5.2218">     aImapUrl-&gt;SetImapMailFolderSink(imapMailFolderSink);</span>
<a href="#l5.2219"></a><span id="l5.2219"> </span>
<a href="#l5.2220"></a><span id="l5.2220">   nsCOMPtr&lt;nsIImapMessageSink&gt; imapMessageSink = do_QueryInterface(aMsgFolder);</span>
<a href="#l5.2221"></a><span id="l5.2221">   if (NS_SUCCEEDED(rv) &amp;&amp; imapMessageSink)</span>
<a href="#l5.2222"></a><span id="l5.2222">     aImapUrl-&gt;SetImapMessageSink(imapMessageSink);</span>
<a href="#l5.2223"></a><span id="l5.2223"> </span>
<a href="#l5.2224"></a><span id="l5.2224" class="difflineminus">-  nsCOMPtr &lt;nsIMsgMailNewsUrl&gt; mailnewsUrl = do_QueryInterface(aImapUrl);</span>
<a href="#l5.2225"></a><span id="l5.2225" class="difflineplus">+  nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsUrl = do_QueryInterface(aImapUrl);</span>
<a href="#l5.2226"></a><span id="l5.2226">   mailnewsUrl-&gt;SetFolder(aMsgFolder);</span>
<a href="#l5.2227"></a><span id="l5.2227"> </span>
<a href="#l5.2228"></a><span id="l5.2228">   return NS_OK;</span>
<a href="#l5.2229"></a><span id="l5.2229"> }</span>
<a href="#l5.2230"></a><span id="l5.2230"> </span>
<a href="#l5.2231"></a><span id="l5.2231"> NS_IMETHODIMP nsImapService::DiscoverAllFolders(nsIMsgFolder *aImapMailFolder,</span>
<a href="#l5.2232"></a><span id="l5.2232">                                                 nsIUrlListener *aUrlListener,</span>
<a href="#l5.2233"></a><span id="l5.2233">                                                 nsIMsgWindow *aMsgWindow,</span>
<a href="#l5.2234"></a><span id="l5.2234" class="difflineminus">-                                                nsIURI **aURL)</span>
<a href="#l5.2235"></a><span id="l5.2235" class="difflineminus">-{</span>
<a href="#l5.2236"></a><span id="l5.2236" class="difflineplus">+                                                nsIURI **aURL) {</span>
<a href="#l5.2237"></a><span id="l5.2237">   NS_ENSURE_ARG_POINTER(aImapMailFolder);</span>
<a href="#l5.2238"></a><span id="l5.2238"> </span>
<a href="#l5.2239"></a><span id="l5.2239">   nsCOMPtr&lt;nsIImapUrl&gt; imapUrl;</span>
<a href="#l5.2240"></a><span id="l5.2240">   nsAutoCString urlSpec;</span>
<a href="#l5.2241"></a><span id="l5.2241"> </span>
<a href="#l5.2242"></a><span id="l5.2242">   char hierarchyDelimiter = GetHierarchyDelimiter(aImapMailFolder);</span>
<a href="#l5.2243"></a><span id="l5.2243" class="difflineminus">-  nsresult rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(imapUrl), aImapMailFolder,</span>
<a href="#l5.2244"></a><span id="l5.2244" class="difflineminus">-                                     aUrlListener, urlSpec, hierarchyDelimiter);</span>
<a href="#l5.2245"></a><span id="l5.2245" class="difflineminus">-  if (NS_SUCCEEDED (rv))</span>
<a href="#l5.2246"></a><span id="l5.2246" class="difflineminus">-  {</span>
<a href="#l5.2247"></a><span id="l5.2247" class="difflineplus">+  nsresult rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(imapUrl),</span>
<a href="#l5.2248"></a><span id="l5.2248" class="difflineplus">+                                     aImapMailFolder, aUrlListener, urlSpec,</span>
<a href="#l5.2249"></a><span id="l5.2249" class="difflineplus">+                                     hierarchyDelimiter);</span>
<a href="#l5.2250"></a><span id="l5.2250" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l5.2251"></a><span id="l5.2251">     rv = SetImapUrlSink(aImapMailFolder, imapUrl);</span>
<a href="#l5.2252"></a><span id="l5.2252"> </span>
<a href="#l5.2253"></a><span id="l5.2253" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l5.2254"></a><span id="l5.2254" class="difflineminus">-    {</span>
<a href="#l5.2255"></a><span id="l5.2255" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l5.2256"></a><span id="l5.2256">       nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsurl = do_QueryInterface(imapUrl);</span>
<a href="#l5.2257"></a><span id="l5.2257">       mailnewsurl-&gt;SetMsgWindow(aMsgWindow);</span>
<a href="#l5.2258"></a><span id="l5.2258">       urlSpec.AppendLiteral(&quot;/discoverallboxes&quot;);</span>
<a href="#l5.2259"></a><span id="l5.2259">       rv = mailnewsurl-&gt;SetSpecInternal(urlSpec);</span>
<a href="#l5.2260"></a><span id="l5.2260">       if (NS_SUCCEEDED(rv))</span>
<a href="#l5.2261"></a><span id="l5.2261">         rv = GetImapConnectionAndLoadUrl(imapUrl, nullptr, aURL);</span>
<a href="#l5.2262"></a><span id="l5.2262">     }</span>
<a href="#l5.2263"></a><span id="l5.2263">   }</span>
<a href="#l5.2264"></a><span id="l5.2264">   return rv;</span>
<a href="#l5.2265"></a><span id="l5.2265"> }</span>
<a href="#l5.2266"></a><span id="l5.2266"> </span>
<a href="#l5.2267"></a><span id="l5.2267" class="difflineminus">-NS_IMETHODIMP nsImapService::DiscoverAllAndSubscribedFolders(nsIMsgFolder *aImapMailFolder,</span>
<a href="#l5.2268"></a><span id="l5.2268" class="difflineminus">-                                                             nsIUrlListener *aUrlListener,</span>
<a href="#l5.2269"></a><span id="l5.2269" class="difflineminus">-                                                             nsIURI **aURL)</span>
<a href="#l5.2270"></a><span id="l5.2270" class="difflineminus">-{</span>
<a href="#l5.2271"></a><span id="l5.2271" class="difflineplus">+NS_IMETHODIMP nsImapService::DiscoverAllAndSubscribedFolders(</span>
<a href="#l5.2272"></a><span id="l5.2272" class="difflineplus">+    nsIMsgFolder *aImapMailFolder, nsIUrlListener *aUrlListener,</span>
<a href="#l5.2273"></a><span id="l5.2273" class="difflineplus">+    nsIURI **aURL) {</span>
<a href="#l5.2274"></a><span id="l5.2274">   NS_ENSURE_ARG_POINTER(aImapMailFolder);</span>
<a href="#l5.2275"></a><span id="l5.2275"> </span>
<a href="#l5.2276"></a><span id="l5.2276">   nsCOMPtr&lt;nsIImapUrl&gt; aImapUrl;</span>
<a href="#l5.2277"></a><span id="l5.2277">   nsAutoCString urlSpec;</span>
<a href="#l5.2278"></a><span id="l5.2278"> </span>
<a href="#l5.2279"></a><span id="l5.2279">   char hierarchyDelimiter = GetHierarchyDelimiter(aImapMailFolder);</span>
<a href="#l5.2280"></a><span id="l5.2280" class="difflineminus">-  nsresult rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(aImapUrl), aImapMailFolder,</span>
<a href="#l5.2281"></a><span id="l5.2281" class="difflineminus">-                                     aUrlListener, urlSpec, hierarchyDelimiter);</span>
<a href="#l5.2282"></a><span id="l5.2282" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; aImapUrl)</span>
<a href="#l5.2283"></a><span id="l5.2283" class="difflineminus">-  {</span>
<a href="#l5.2284"></a><span id="l5.2284" class="difflineplus">+  nsresult rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(aImapUrl),</span>
<a href="#l5.2285"></a><span id="l5.2285" class="difflineplus">+                                     aImapMailFolder, aUrlListener, urlSpec,</span>
<a href="#l5.2286"></a><span id="l5.2286" class="difflineplus">+                                     hierarchyDelimiter);</span>
<a href="#l5.2287"></a><span id="l5.2287" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; aImapUrl) {</span>
<a href="#l5.2288"></a><span id="l5.2288">     rv = SetImapUrlSink(aImapMailFolder, aImapUrl);</span>
<a href="#l5.2289"></a><span id="l5.2289" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l5.2290"></a><span id="l5.2290" class="difflineminus">-    {</span>
<a href="#l5.2291"></a><span id="l5.2291" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l5.2292"></a><span id="l5.2292">       nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsurl = do_QueryInterface(aImapUrl);</span>
<a href="#l5.2293"></a><span id="l5.2293">       urlSpec.AppendLiteral(&quot;/discoverallandsubscribedboxes&quot;);</span>
<a href="#l5.2294"></a><span id="l5.2294">       rv = mailnewsurl-&gt;SetSpecInternal(urlSpec);</span>
<a href="#l5.2295"></a><span id="l5.2295">       if (NS_SUCCEEDED(rv))</span>
<a href="#l5.2296"></a><span id="l5.2296">         rv = GetImapConnectionAndLoadUrl(aImapUrl, nullptr, aURL);</span>
<a href="#l5.2297"></a><span id="l5.2297">     }</span>
<a href="#l5.2298"></a><span id="l5.2298">   }</span>
<a href="#l5.2299"></a><span id="l5.2299">   return rv;</span>
<a href="#l5.2300"></a><span id="l5.2300"> }</span>
<a href="#l5.2301"></a><span id="l5.2301"> </span>
<a href="#l5.2302"></a><span id="l5.2302"> NS_IMETHODIMP nsImapService::DiscoverChildren(nsIMsgFolder *aImapMailFolder,</span>
<a href="#l5.2303"></a><span id="l5.2303">                                               nsIUrlListener *aUrlListener,</span>
<a href="#l5.2304"></a><span id="l5.2304">                                               const nsACString &amp;folderPath,</span>
<a href="#l5.2305"></a><span id="l5.2305" class="difflineminus">-                                              nsIURI **aURL)</span>
<a href="#l5.2306"></a><span id="l5.2306" class="difflineminus">-{</span>
<a href="#l5.2307"></a><span id="l5.2307" class="difflineplus">+                                              nsIURI **aURL) {</span>
<a href="#l5.2308"></a><span id="l5.2308">   NS_ENSURE_ARG_POINTER(aImapMailFolder);</span>
<a href="#l5.2309"></a><span id="l5.2309"> </span>
<a href="#l5.2310"></a><span id="l5.2310">   nsCOMPtr&lt;nsIImapUrl&gt; aImapUrl;</span>
<a href="#l5.2311"></a><span id="l5.2311">   nsAutoCString urlSpec;</span>
<a href="#l5.2312"></a><span id="l5.2312"> </span>
<a href="#l5.2313"></a><span id="l5.2313">   char hierarchyDelimiter = GetHierarchyDelimiter(aImapMailFolder);</span>
<a href="#l5.2314"></a><span id="l5.2314" class="difflineminus">-  nsresult rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(aImapUrl), aImapMailFolder,</span>
<a href="#l5.2315"></a><span id="l5.2315" class="difflineminus">-                                     aUrlListener, urlSpec, hierarchyDelimiter);</span>
<a href="#l5.2316"></a><span id="l5.2316" class="difflineminus">-  if (NS_SUCCEEDED (rv))</span>
<a href="#l5.2317"></a><span id="l5.2317" class="difflineminus">-  {</span>
<a href="#l5.2318"></a><span id="l5.2318" class="difflineplus">+  nsresult rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(aImapUrl),</span>
<a href="#l5.2319"></a><span id="l5.2319" class="difflineplus">+                                     aImapMailFolder, aUrlListener, urlSpec,</span>
<a href="#l5.2320"></a><span id="l5.2320" class="difflineplus">+                                     hierarchyDelimiter);</span>
<a href="#l5.2321"></a><span id="l5.2321" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l5.2322"></a><span id="l5.2322">     rv = SetImapUrlSink(aImapMailFolder, aImapUrl);</span>
<a href="#l5.2323"></a><span id="l5.2323" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l5.2324"></a><span id="l5.2324" class="difflineminus">-    {</span>
<a href="#l5.2325"></a><span id="l5.2325" class="difflineminus">-      if (!folderPath.IsEmpty())</span>
<a href="#l5.2326"></a><span id="l5.2326" class="difflineminus">-      {</span>
<a href="#l5.2327"></a><span id="l5.2327" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l5.2328"></a><span id="l5.2328" class="difflineplus">+      if (!folderPath.IsEmpty()) {</span>
<a href="#l5.2329"></a><span id="l5.2329">         nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsurl = do_QueryInterface(aImapUrl);</span>
<a href="#l5.2330"></a><span id="l5.2330">         urlSpec.AppendLiteral(&quot;/discoverchildren&gt;&quot;);</span>
<a href="#l5.2331"></a><span id="l5.2331">         urlSpec.Append(hierarchyDelimiter);</span>
<a href="#l5.2332"></a><span id="l5.2332">         urlSpec.Append(folderPath);</span>
<a href="#l5.2333"></a><span id="l5.2333">         rv = mailnewsurl-&gt;SetSpecInternal(urlSpec);</span>
<a href="#l5.2334"></a><span id="l5.2334"> </span>
<a href="#l5.2335"></a><span id="l5.2335" class="difflineminus">-        // Make sure the uri has the same hierarchy separator as the one in msg folder</span>
<a href="#l5.2336"></a><span id="l5.2336" class="difflineminus">-        // obj if it's not kOnlineHierarchySeparatorUnknown (ie, '^').</span>
<a href="#l5.2337"></a><span id="l5.2337" class="difflineplus">+        // Make sure the uri has the same hierarchy separator as the one in msg</span>
<a href="#l5.2338"></a><span id="l5.2338" class="difflineplus">+        // folder obj if it's not kOnlineHierarchySeparatorUnknown (ie, '^').</span>
<a href="#l5.2339"></a><span id="l5.2339">         char uriDelimiter;</span>
<a href="#l5.2340"></a><span id="l5.2340">         nsresult rv1 = aImapUrl-&gt;GetOnlineSubDirSeparator(&amp;uriDelimiter);</span>
<a href="#l5.2341"></a><span id="l5.2341" class="difflineminus">-        if (NS_SUCCEEDED (rv1) &amp;&amp; hierarchyDelimiter != kOnlineHierarchySeparatorUnknown &amp;&amp;</span>
<a href="#l5.2342"></a><span id="l5.2342" class="difflineplus">+        if (NS_SUCCEEDED(rv1) &amp;&amp;</span>
<a href="#l5.2343"></a><span id="l5.2343" class="difflineplus">+            hierarchyDelimiter != kOnlineHierarchySeparatorUnknown &amp;&amp;</span>
<a href="#l5.2344"></a><span id="l5.2344">             uriDelimiter != hierarchyDelimiter)</span>
<a href="#l5.2345"></a><span id="l5.2345">           aImapUrl-&gt;SetOnlineSubDirSeparator(hierarchyDelimiter);</span>
<a href="#l5.2346"></a><span id="l5.2346"> </span>
<a href="#l5.2347"></a><span id="l5.2347">         if (NS_SUCCEEDED(rv))</span>
<a href="#l5.2348"></a><span id="l5.2348">           rv = GetImapConnectionAndLoadUrl(aImapUrl, nullptr, aURL);</span>
<a href="#l5.2349"></a><span id="l5.2349" class="difflineminus">-      }</span>
<a href="#l5.2350"></a><span id="l5.2350" class="difflineminus">-      else</span>
<a href="#l5.2351"></a><span id="l5.2351" class="difflineplus">+      } else</span>
<a href="#l5.2352"></a><span id="l5.2352">         rv = NS_ERROR_FAILURE;</span>
<a href="#l5.2353"></a><span id="l5.2353">     }</span>
<a href="#l5.2354"></a><span id="l5.2354">   }</span>
<a href="#l5.2355"></a><span id="l5.2355">   return rv;</span>
<a href="#l5.2356"></a><span id="l5.2356"> }</span>
<a href="#l5.2357"></a><span id="l5.2357"> </span>
<a href="#l5.2358"></a><span id="l5.2358" class="difflineminus">-NS_IMETHODIMP nsImapService::OnlineMessageCopy(nsIMsgFolder *aSrcFolder,</span>
<a href="#l5.2359"></a><span id="l5.2359" class="difflineminus">-                                               const nsACString &amp;messageIds,</span>
<a href="#l5.2360"></a><span id="l5.2360" class="difflineminus">-                                               nsIMsgFolder *aDstFolder,</span>
<a href="#l5.2361"></a><span id="l5.2361" class="difflineminus">-                                               bool idsAreUids,</span>
<a href="#l5.2362"></a><span id="l5.2362" class="difflineminus">-                                               bool isMove,</span>
<a href="#l5.2363"></a><span id="l5.2363" class="difflineminus">-                                               nsIUrlListener *aUrlListener,</span>
<a href="#l5.2364"></a><span id="l5.2364" class="difflineminus">-                                               nsIURI **aURL,</span>
<a href="#l5.2365"></a><span id="l5.2365" class="difflineminus">-                                               nsISupports *copyState,</span>
<a href="#l5.2366"></a><span id="l5.2366" class="difflineminus">-                                               nsIMsgWindow *aMsgWindow)</span>
<a href="#l5.2367"></a><span id="l5.2367" class="difflineminus">-{</span>
<a href="#l5.2368"></a><span id="l5.2368" class="difflineplus">+NS_IMETHODIMP nsImapService::OnlineMessageCopy(</span>
<a href="#l5.2369"></a><span id="l5.2369" class="difflineplus">+    nsIMsgFolder *aSrcFolder, const nsACString &amp;messageIds,</span>
<a href="#l5.2370"></a><span id="l5.2370" class="difflineplus">+    nsIMsgFolder *aDstFolder, bool idsAreUids, bool isMove,</span>
<a href="#l5.2371"></a><span id="l5.2371" class="difflineplus">+    nsIUrlListener *aUrlListener, nsIURI **aURL, nsISupports *copyState,</span>
<a href="#l5.2372"></a><span id="l5.2372" class="difflineplus">+    nsIMsgWindow *aMsgWindow) {</span>
<a href="#l5.2373"></a><span id="l5.2373">   NS_ENSURE_ARG_POINTER(aSrcFolder);</span>
<a href="#l5.2374"></a><span id="l5.2374">   NS_ENSURE_ARG_POINTER(aDstFolder);</span>
<a href="#l5.2375"></a><span id="l5.2375"> </span>
<a href="#l5.2376"></a><span id="l5.2376">   nsresult rv;</span>
<a href="#l5.2377"></a><span id="l5.2377">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; srcServer;</span>
<a href="#l5.2378"></a><span id="l5.2378">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; dstServer;</span>
<a href="#l5.2379"></a><span id="l5.2379"> </span>
<a href="#l5.2380"></a><span id="l5.2380">   rv = aSrcFolder-&gt;GetServer(getter_AddRefs(srcServer));</span>
<a href="#l5.2381"></a><span id="l5.2381" class="difflineat">@@ -1943,34 +1811,33 @@ NS_IMETHODIMP nsImapService::OnlineMessa</span>
<a href="#l5.2382"></a><span id="l5.2382"> </span>
<a href="#l5.2383"></a><span id="l5.2383">   rv = aDstFolder-&gt;GetServer(getter_AddRefs(dstServer));</span>
<a href="#l5.2384"></a><span id="l5.2384">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.2385"></a><span id="l5.2385"> </span>
<a href="#l5.2386"></a><span id="l5.2386">   bool sameServer;</span>
<a href="#l5.2387"></a><span id="l5.2387">   rv = dstServer-&gt;Equals(srcServer, &amp;sameServer);</span>
<a href="#l5.2388"></a><span id="l5.2388">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.2389"></a><span id="l5.2389"> </span>
<a href="#l5.2390"></a><span id="l5.2390" class="difflineminus">-  if (!sameServer)</span>
<a href="#l5.2391"></a><span id="l5.2391" class="difflineminus">-  {</span>
<a href="#l5.2392"></a><span id="l5.2392" class="difflineplus">+  if (!sameServer) {</span>
<a href="#l5.2393"></a><span id="l5.2393">     NS_ASSERTION(false, &quot;can't use this method to copy across servers&quot;);</span>
<a href="#l5.2394"></a><span id="l5.2394">     // *** can only take message from the same imap host and user accnt</span>
<a href="#l5.2395"></a><span id="l5.2395">     return NS_ERROR_FAILURE;</span>
<a href="#l5.2396"></a><span id="l5.2396">   }</span>
<a href="#l5.2397"></a><span id="l5.2397"> </span>
<a href="#l5.2398"></a><span id="l5.2398">   nsCOMPtr&lt;nsIImapUrl&gt; imapUrl;</span>
<a href="#l5.2399"></a><span id="l5.2399">   nsAutoCString urlSpec;</span>
<a href="#l5.2400"></a><span id="l5.2400"> </span>
<a href="#l5.2401"></a><span id="l5.2401">   char hierarchyDelimiter = GetHierarchyDelimiter(aSrcFolder);</span>
<a href="#l5.2402"></a><span id="l5.2402" class="difflineminus">-  rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(imapUrl), aSrcFolder, aUrlListener, urlSpec, hierarchyDelimiter);</span>
<a href="#l5.2403"></a><span id="l5.2403" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l5.2404"></a><span id="l5.2404" class="difflineminus">-  {</span>
<a href="#l5.2405"></a><span id="l5.2405" class="difflineplus">+  rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(imapUrl), aSrcFolder,</span>
<a href="#l5.2406"></a><span id="l5.2406" class="difflineplus">+                            aUrlListener, urlSpec, hierarchyDelimiter);</span>
<a href="#l5.2407"></a><span id="l5.2407" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l5.2408"></a><span id="l5.2408">     SetImapUrlSink(aSrcFolder, imapUrl);</span>
<a href="#l5.2409"></a><span id="l5.2409">     imapUrl-&gt;SetCopyState(copyState);</span>
<a href="#l5.2410"></a><span id="l5.2410"> </span>
<a href="#l5.2411"></a><span id="l5.2411" class="difflineminus">-    nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsurl (do_QueryInterface(imapUrl));</span>
<a href="#l5.2412"></a><span id="l5.2412" class="difflineplus">+    nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsurl(do_QueryInterface(imapUrl));</span>
<a href="#l5.2413"></a><span id="l5.2413">     mailnewsurl-&gt;SetMsgWindow(aMsgWindow);</span>
<a href="#l5.2414"></a><span id="l5.2414"> </span>
<a href="#l5.2415"></a><span id="l5.2415">     if (isMove)</span>
<a href="#l5.2416"></a><span id="l5.2416">       urlSpec.AppendLiteral(&quot;/onlinemove&gt;&quot;);</span>
<a href="#l5.2417"></a><span id="l5.2417">     else</span>
<a href="#l5.2418"></a><span id="l5.2418">       urlSpec.AppendLiteral(&quot;/onlinecopy&gt;&quot;);</span>
<a href="#l5.2419"></a><span id="l5.2419">     if (idsAreUids)</span>
<a href="#l5.2420"></a><span id="l5.2420">       urlSpec.Append(uidString);</span>
<a href="#l5.2421"></a><span id="l5.2421" class="difflineat">@@ -1992,166 +1859,154 @@ NS_IMETHODIMP nsImapService::OnlineMessa</span>
<a href="#l5.2422"></a><span id="l5.2422"> </span>
<a href="#l5.2423"></a><span id="l5.2423">     rv = mailnewsurl-&gt;SetSpecInternal(urlSpec);</span>
<a href="#l5.2424"></a><span id="l5.2424">     if (NS_SUCCEEDED(rv))</span>
<a href="#l5.2425"></a><span id="l5.2425">       rv = GetImapConnectionAndLoadUrl(imapUrl, nullptr, aURL);</span>
<a href="#l5.2426"></a><span id="l5.2426">   }</span>
<a href="#l5.2427"></a><span id="l5.2427">   return rv;</span>
<a href="#l5.2428"></a><span id="l5.2428"> }</span>
<a href="#l5.2429"></a><span id="l5.2429"> </span>
<a href="#l5.2430"></a><span id="l5.2430" class="difflineminus">-nsresult nsImapService::OfflineAppendFromFile(nsIFile *aFile,</span>
<a href="#l5.2431"></a><span id="l5.2431" class="difflineminus">-                                              nsIURI *aUrl,</span>
<a href="#l5.2432"></a><span id="l5.2432" class="difflineminus">-                                              nsIMsgFolder* aDstFolder,</span>
<a href="#l5.2433"></a><span id="l5.2433" class="difflineminus">-                                              const nsACString &amp;messageId,  // to be replaced</span>
<a href="#l5.2434"></a><span id="l5.2434" class="difflineminus">-                                              bool inSelectedState, // needs to be in</span>
<a href="#l5.2435"></a><span id="l5.2435" class="difflineminus">-                                              nsIUrlListener *aListener,</span>
<a href="#l5.2436"></a><span id="l5.2436" class="difflineminus">-                                              nsIURI **aURL,</span>
<a href="#l5.2437"></a><span id="l5.2437" class="difflineminus">-                                              nsISupports *aCopyState)</span>
<a href="#l5.2438"></a><span id="l5.2438" class="difflineminus">-{</span>
<a href="#l5.2439"></a><span id="l5.2439" class="difflineplus">+nsresult nsImapService::OfflineAppendFromFile(</span>
<a href="#l5.2440"></a><span id="l5.2440" class="difflineplus">+    nsIFile *aFile, nsIURI *aUrl, nsIMsgFolder *aDstFolder,</span>
<a href="#l5.2441"></a><span id="l5.2441" class="difflineplus">+    const nsACString &amp;messageId,  // to be replaced</span>
<a href="#l5.2442"></a><span id="l5.2442" class="difflineplus">+    bool inSelectedState,         // needs to be in</span>
<a href="#l5.2443"></a><span id="l5.2443" class="difflineplus">+    nsIUrlListener *aListener, nsIURI **aURL, nsISupports *aCopyState) {</span>
<a href="#l5.2444"></a><span id="l5.2444">   nsCOMPtr&lt;nsIMsgDatabase&gt; destDB;</span>
<a href="#l5.2445"></a><span id="l5.2445">   nsresult rv = aDstFolder-&gt;GetMsgDatabase(getter_AddRefs(destDB));</span>
<a href="#l5.2446"></a><span id="l5.2446">   // ### might need to send some notifications instead of just returning</span>
<a href="#l5.2447"></a><span id="l5.2447"> </span>
<a href="#l5.2448"></a><span id="l5.2448">   bool isLocked;</span>
<a href="#l5.2449"></a><span id="l5.2449">   aDstFolder-&gt;GetLocked(&amp;isLocked);</span>
<a href="#l5.2450"></a><span id="l5.2450" class="difflineminus">-  if (isLocked)</span>
<a href="#l5.2451"></a><span id="l5.2451" class="difflineminus">-    return NS_MSG_FOLDER_BUSY;</span>
<a href="#l5.2452"></a><span id="l5.2452" class="difflineminus">-</span>
<a href="#l5.2453"></a><span id="l5.2453" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; destDB)</span>
<a href="#l5.2454"></a><span id="l5.2454" class="difflineminus">-  {</span>
<a href="#l5.2455"></a><span id="l5.2455" class="difflineplus">+  if (isLocked) return NS_MSG_FOLDER_BUSY;</span>
<a href="#l5.2456"></a><span id="l5.2456" class="difflineplus">+</span>
<a href="#l5.2457"></a><span id="l5.2457" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; destDB) {</span>
<a href="#l5.2458"></a><span id="l5.2458">     nsMsgKey fakeKey;</span>
<a href="#l5.2459"></a><span id="l5.2459">     destDB-&gt;GetNextFakeOfflineMsgKey(&amp;fakeKey);</span>
<a href="#l5.2460"></a><span id="l5.2460"> </span>
<a href="#l5.2461"></a><span id="l5.2461" class="difflineminus">-    nsCOMPtr &lt;nsIMsgOfflineImapOperation&gt; op;</span>
<a href="#l5.2462"></a><span id="l5.2462" class="difflineplus">+    nsCOMPtr&lt;nsIMsgOfflineImapOperation&gt; op;</span>
<a href="#l5.2463"></a><span id="l5.2463">     rv = destDB-&gt;GetOfflineOpForKey(fakeKey, true, getter_AddRefs(op));</span>
<a href="#l5.2464"></a><span id="l5.2464" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; op)</span>
<a href="#l5.2465"></a><span id="l5.2465" class="difflineminus">-    {</span>
<a href="#l5.2466"></a><span id="l5.2466" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; op) {</span>
<a href="#l5.2467"></a><span id="l5.2467">       nsCString destFolderUri;</span>
<a href="#l5.2468"></a><span id="l5.2468">       aDstFolder-&gt;GetURI(destFolderUri);</span>
<a href="#l5.2469"></a><span id="l5.2469" class="difflineminus">-      op-&gt;SetOperation(nsIMsgOfflineImapOperation::kAppendDraft); // ### do we care if it's a template?</span>
<a href="#l5.2470"></a><span id="l5.2470" class="difflineplus">+      op-&gt;SetOperation(</span>
<a href="#l5.2471"></a><span id="l5.2471" class="difflineplus">+          nsIMsgOfflineImapOperation::kAppendDraft);  // ### do we care if it's</span>
<a href="#l5.2472"></a><span id="l5.2472" class="difflineplus">+                                                      // a template?</span>
<a href="#l5.2473"></a><span id="l5.2473">       op-&gt;SetDestinationFolderURI(destFolderUri.get());</span>
<a href="#l5.2474"></a><span id="l5.2474" class="difflineminus">-      nsCOMPtr &lt;nsIOutputStream&gt; offlineStore;</span>
<a href="#l5.2475"></a><span id="l5.2475" class="difflineplus">+      nsCOMPtr&lt;nsIOutputStream&gt; offlineStore;</span>
<a href="#l5.2476"></a><span id="l5.2476">       nsCOMPtr&lt;nsIMsgPluggableStore&gt; msgStore;</span>
<a href="#l5.2477"></a><span id="l5.2477">       nsCOMPtr&lt;nsIMsgIncomingServer&gt; dstServer;</span>
<a href="#l5.2478"></a><span id="l5.2478">       nsCOMPtr&lt;nsIMsgDBHdr&gt; newMsgHdr;</span>
<a href="#l5.2479"></a><span id="l5.2479"> </span>
<a href="#l5.2480"></a><span id="l5.2480">       aDstFolder-&gt;GetServer(getter_AddRefs(dstServer));</span>
<a href="#l5.2481"></a><span id="l5.2481">       rv = dstServer-&gt;GetMsgStore(getter_AddRefs(msgStore));</span>
<a href="#l5.2482"></a><span id="l5.2482">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.2483"></a><span id="l5.2483">       rv = destDB-&gt;CreateNewHdr(fakeKey, getter_AddRefs(newMsgHdr));</span>
<a href="#l5.2484"></a><span id="l5.2484">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.2485"></a><span id="l5.2485" class="difflineminus">-      rv = aDstFolder-&gt;GetOfflineStoreOutputStream(newMsgHdr, getter_AddRefs(offlineStore));</span>
<a href="#l5.2486"></a><span id="l5.2486" class="difflineminus">-</span>
<a href="#l5.2487"></a><span id="l5.2487" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp; offlineStore)</span>
<a href="#l5.2488"></a><span id="l5.2488" class="difflineminus">-      {</span>
<a href="#l5.2489"></a><span id="l5.2489" class="difflineplus">+      rv = aDstFolder-&gt;GetOfflineStoreOutputStream(</span>
<a href="#l5.2490"></a><span id="l5.2490" class="difflineplus">+          newMsgHdr, getter_AddRefs(offlineStore));</span>
<a href="#l5.2491"></a><span id="l5.2491" class="difflineplus">+</span>
<a href="#l5.2492"></a><span id="l5.2492" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; offlineStore) {</span>
<a href="#l5.2493"></a><span id="l5.2493">         int64_t curOfflineStorePos = 0;</span>
<a href="#l5.2494"></a><span id="l5.2494" class="difflineminus">-        nsCOMPtr &lt;nsISeekableStream&gt; seekable = do_QueryInterface(offlineStore);</span>
<a href="#l5.2495"></a><span id="l5.2495" class="difflineplus">+        nsCOMPtr&lt;nsISeekableStream&gt; seekable = do_QueryInterface(offlineStore);</span>
<a href="#l5.2496"></a><span id="l5.2496">         if (seekable)</span>
<a href="#l5.2497"></a><span id="l5.2497">           seekable-&gt;Tell(&amp;curOfflineStorePos);</span>
<a href="#l5.2498"></a><span id="l5.2498" class="difflineminus">-        else</span>
<a href="#l5.2499"></a><span id="l5.2499" class="difflineminus">-        {</span>
<a href="#l5.2500"></a><span id="l5.2500" class="difflineplus">+        else {</span>
<a href="#l5.2501"></a><span id="l5.2501">           NS_ERROR(&quot;needs to be a random store!&quot;);</span>
<a href="#l5.2502"></a><span id="l5.2502">           return NS_ERROR_FAILURE;</span>
<a href="#l5.2503"></a><span id="l5.2503">         }</span>
<a href="#l5.2504"></a><span id="l5.2504"> </span>
<a href="#l5.2505"></a><span id="l5.2505" class="difflineminus">-        nsCOMPtr &lt;nsIInputStream&gt; inputStream;</span>
<a href="#l5.2506"></a><span id="l5.2506" class="difflineminus">-        nsCOMPtr &lt;nsIMsgParseMailMsgState&gt; msgParser = do_CreateInstance(NS_PARSEMAILMSGSTATE_CONTRACTID, &amp;rv);</span>
<a href="#l5.2507"></a><span id="l5.2507" class="difflineplus">+        nsCOMPtr&lt;nsIInputStream&gt; inputStream;</span>
<a href="#l5.2508"></a><span id="l5.2508" class="difflineplus">+        nsCOMPtr&lt;nsIMsgParseMailMsgState&gt; msgParser =</span>
<a href="#l5.2509"></a><span id="l5.2509" class="difflineplus">+            do_CreateInstance(NS_PARSEMAILMSGSTATE_CONTRACTID, &amp;rv);</span>
<a href="#l5.2510"></a><span id="l5.2510">         msgParser-&gt;SetMailDB(destDB);</span>
<a href="#l5.2511"></a><span id="l5.2511"> </span>
<a href="#l5.2512"></a><span id="l5.2512">         rv = NS_NewLocalFileInputStream(getter_AddRefs(inputStream), aFile);</span>
<a href="#l5.2513"></a><span id="l5.2513" class="difflineminus">-        if (NS_SUCCEEDED(rv) &amp;&amp; inputStream)</span>
<a href="#l5.2514"></a><span id="l5.2514" class="difflineminus">-        {</span>
<a href="#l5.2515"></a><span id="l5.2515" class="difflineplus">+        if (NS_SUCCEEDED(rv) &amp;&amp; inputStream) {</span>
<a href="#l5.2516"></a><span id="l5.2516">           // now, copy the temp file to the offline store for the dest folder.</span>
<a href="#l5.2517"></a><span id="l5.2517">           RefPtr&lt;nsMsgLineStreamBuffer&gt; inputStreamBuffer =</span>
<a href="#l5.2518"></a><span id="l5.2518" class="difflineminus">-            new nsMsgLineStreamBuffer(FILE_IO_BUFFER_SIZE,</span>
<a href="#l5.2519"></a><span id="l5.2519" class="difflineminus">-                                      true,    // allocate new lines</span>
<a href="#l5.2520"></a><span id="l5.2520" class="difflineminus">-                                      false);  // leave CRLFs on the returned string</span>
<a href="#l5.2521"></a><span id="l5.2521" class="difflineplus">+              new nsMsgLineStreamBuffer(</span>
<a href="#l5.2522"></a><span id="l5.2522" class="difflineplus">+                  FILE_IO_BUFFER_SIZE,</span>
<a href="#l5.2523"></a><span id="l5.2523" class="difflineplus">+                  true,    // allocate new lines</span>
<a href="#l5.2524"></a><span id="l5.2524" class="difflineplus">+                  false);  // leave CRLFs on the returned string</span>
<a href="#l5.2525"></a><span id="l5.2525">           int64_t fileSize;</span>
<a href="#l5.2526"></a><span id="l5.2526">           aFile-&gt;GetFileSize(&amp;fileSize);</span>
<a href="#l5.2527"></a><span id="l5.2527">           uint32_t bytesWritten;</span>
<a href="#l5.2528"></a><span id="l5.2528">           rv = NS_OK;</span>
<a href="#l5.2529"></a><span id="l5.2529" class="difflineminus">-//        rv = inputStream-&gt;Read(inputBuffer, inputBufferSize, &amp;bytesRead);</span>
<a href="#l5.2530"></a><span id="l5.2530" class="difflineminus">-//        if (NS_SUCCEEDED(rv) &amp;&amp; bytesRead &gt; 0)</span>
<a href="#l5.2531"></a><span id="l5.2531" class="difflineplus">+          // rv = inputStream-&gt;Read(inputBuffer, inputBufferSize, &amp;bytesRead);</span>
<a href="#l5.2532"></a><span id="l5.2532" class="difflineplus">+          // if (NS_SUCCEEDED(rv) &amp;&amp; bytesRead &gt; 0)</span>
<a href="#l5.2533"></a><span id="l5.2533">           msgParser-&gt;SetState(nsIMsgParseMailMsgState::ParseHeadersState);</span>
<a href="#l5.2534"></a><span id="l5.2534">           msgParser-&gt;SetNewMsgHdr(newMsgHdr);</span>
<a href="#l5.2535"></a><span id="l5.2535">           // set the new key to fake key so the msg hdr will have that for a key</span>
<a href="#l5.2536"></a><span id="l5.2536">           msgParser-&gt;SetNewKey(fakeKey);</span>
<a href="#l5.2537"></a><span id="l5.2537">           bool needMoreData = false;</span>
<a href="#l5.2538"></a><span id="l5.2538" class="difflineminus">-          char * newLine = nullptr;</span>
<a href="#l5.2539"></a><span id="l5.2539" class="difflineplus">+          char *newLine = nullptr;</span>
<a href="#l5.2540"></a><span id="l5.2540">           uint32_t numBytesInLine = 0;</span>
<a href="#l5.2541"></a><span id="l5.2541" class="difflineminus">-          do</span>
<a href="#l5.2542"></a><span id="l5.2542" class="difflineminus">-          {</span>
<a href="#l5.2543"></a><span id="l5.2543" class="difflineminus">-            newLine = inputStreamBuffer-&gt;ReadNextLine(inputStream, numBytesInLine, needMoreData);</span>
<a href="#l5.2544"></a><span id="l5.2544" class="difflineminus">-            if (newLine)</span>
<a href="#l5.2545"></a><span id="l5.2545" class="difflineminus">-            {</span>
<a href="#l5.2546"></a><span id="l5.2546" class="difflineplus">+          do {</span>
<a href="#l5.2547"></a><span id="l5.2547" class="difflineplus">+            newLine = inputStreamBuffer-&gt;ReadNextLine(</span>
<a href="#l5.2548"></a><span id="l5.2548" class="difflineplus">+                inputStream, numBytesInLine, needMoreData);</span>
<a href="#l5.2549"></a><span id="l5.2549" class="difflineplus">+            if (newLine) {</span>
<a href="#l5.2550"></a><span id="l5.2550">               msgParser-&gt;ParseAFolderLine(newLine, numBytesInLine);</span>
<a href="#l5.2551"></a><span id="l5.2551">               rv = offlineStore-&gt;Write(newLine, numBytesInLine, &amp;bytesWritten);</span>
<a href="#l5.2552"></a><span id="l5.2552">               free(newLine);</span>
<a href="#l5.2553"></a><span id="l5.2553">             }</span>
<a href="#l5.2554"></a><span id="l5.2554">           } while (newLine);</span>
<a href="#l5.2555"></a><span id="l5.2555">           msgParser-&gt;FinishHeader();</span>
<a href="#l5.2556"></a><span id="l5.2556"> </span>
<a href="#l5.2557"></a><span id="l5.2557">           nsCOMPtr&lt;nsIMsgDBHdr&gt; fakeHdr;</span>
<a href="#l5.2558"></a><span id="l5.2558">           msgParser-&gt;GetNewMsgHdr(getter_AddRefs(fakeHdr));</span>
<a href="#l5.2559"></a><span id="l5.2559" class="difflineminus">-          if (fakeHdr)</span>
<a href="#l5.2560"></a><span id="l5.2560" class="difflineminus">-          {</span>
<a href="#l5.2561"></a><span id="l5.2561" class="difflineminus">-            if (NS_SUCCEEDED(rv) &amp;&amp; fakeHdr)</span>
<a href="#l5.2562"></a><span id="l5.2562" class="difflineminus">-            {</span>
<a href="#l5.2563"></a><span id="l5.2563" class="difflineplus">+          if (fakeHdr) {</span>
<a href="#l5.2564"></a><span id="l5.2564" class="difflineplus">+            if (NS_SUCCEEDED(rv) &amp;&amp; fakeHdr) {</span>
<a href="#l5.2565"></a><span id="l5.2565">               uint32_t resultFlags;</span>
<a href="#l5.2566"></a><span id="l5.2566">               fakeHdr-&gt;SetMessageOffset(curOfflineStorePos);</span>
<a href="#l5.2567"></a><span id="l5.2567" class="difflineminus">-              fakeHdr-&gt;OrFlags(nsMsgMessageFlags::Offline | nsMsgMessageFlags::Read, &amp;resultFlags);</span>
<a href="#l5.2568"></a><span id="l5.2568" class="difflineplus">+              fakeHdr-&gt;OrFlags(</span>
<a href="#l5.2569"></a><span id="l5.2569" class="difflineplus">+                  nsMsgMessageFlags::Offline | nsMsgMessageFlags::Read,</span>
<a href="#l5.2570"></a><span id="l5.2570" class="difflineplus">+                  &amp;resultFlags);</span>
<a href="#l5.2571"></a><span id="l5.2571">               fakeHdr-&gt;SetOfflineMessageSize(fileSize);</span>
<a href="#l5.2572"></a><span id="l5.2572">               destDB-&gt;AddNewHdrToDB(fakeHdr, true /* notify */);</span>
<a href="#l5.2573"></a><span id="l5.2573">               aDstFolder-&gt;SetFlag(nsMsgFolderFlags::OfflineEvents);</span>
<a href="#l5.2574"></a><span id="l5.2574" class="difflineminus">-              if (msgStore)</span>
<a href="#l5.2575"></a><span id="l5.2575" class="difflineminus">-                msgStore-&gt;FinishNewMessage(offlineStore, fakeHdr);</span>
<a href="#l5.2576"></a><span id="l5.2576" class="difflineplus">+              if (msgStore) msgStore-&gt;FinishNewMessage(offlineStore, fakeHdr);</span>
<a href="#l5.2577"></a><span id="l5.2577">             }</span>
<a href="#l5.2578"></a><span id="l5.2578">           }</span>
<a href="#l5.2579"></a><span id="l5.2579">           // tell the listener we're done.</span>
<a href="#l5.2580"></a><span id="l5.2580">           inputStream-&gt;Close();</span>
<a href="#l5.2581"></a><span id="l5.2581">           inputStream = nullptr;</span>
<a href="#l5.2582"></a><span id="l5.2582">           aListener-&gt;OnStopRunningUrl(aUrl, NS_OK);</span>
<a href="#l5.2583"></a><span id="l5.2583">         }</span>
<a href="#l5.2584"></a><span id="l5.2584">         offlineStore-&gt;Close();</span>
<a href="#l5.2585"></a><span id="l5.2585">       }</span>
<a href="#l5.2586"></a><span id="l5.2586">     }</span>
<a href="#l5.2587"></a><span id="l5.2587">   }</span>
<a href="#l5.2588"></a><span id="l5.2588"> </span>
<a href="#l5.2589"></a><span id="l5.2589" class="difflineminus">-  if (destDB)</span>
<a href="#l5.2590"></a><span id="l5.2590" class="difflineminus">-    destDB-&gt;Close(true);</span>
<a href="#l5.2591"></a><span id="l5.2591" class="difflineplus">+  if (destDB) destDB-&gt;Close(true);</span>
<a href="#l5.2592"></a><span id="l5.2592">   return rv;</span>
<a href="#l5.2593"></a><span id="l5.2593"> }</span>
<a href="#l5.2594"></a><span id="l5.2594"> </span>
<a href="#l5.2595"></a><span id="l5.2595"> /* append message from file url */</span>
<a href="#l5.2596"></a><span id="l5.2596"> /* imap://HOST&gt;appendmsgfromfile&gt;DESTINATIONMAILBOXPATH */</span>
<a href="#l5.2597"></a><span id="l5.2597"> /* imap://HOST&gt;appenddraftfromfile&gt;DESTINATIONMAILBOXPATH&gt;UID&gt;messageId */</span>
<a href="#l5.2598"></a><span id="l5.2598" class="difflineminus">-NS_IMETHODIMP nsImapService::AppendMessageFromFile(nsIFile *aFile,</span>
<a href="#l5.2599"></a><span id="l5.2599" class="difflineminus">-                                                   nsIMsgFolder *aDstFolder,</span>
<a href="#l5.2600"></a><span id="l5.2600" class="difflineminus">-                                                   const nsACString &amp;messageId,  // to be replaced</span>
<a href="#l5.2601"></a><span id="l5.2601" class="difflineminus">-                                                   bool idsAreUids,</span>
<a href="#l5.2602"></a><span id="l5.2602" class="difflineminus">-                                                   bool inSelectedState,       // needs to be in</span>
<a href="#l5.2603"></a><span id="l5.2603" class="difflineminus">-                                                   nsIUrlListener *aListener,</span>
<a href="#l5.2604"></a><span id="l5.2604" class="difflineminus">-                                                   nsIURI **aURL,</span>
<a href="#l5.2605"></a><span id="l5.2605" class="difflineminus">-                                                   nsISupports *aCopyState,</span>
<a href="#l5.2606"></a><span id="l5.2606" class="difflineminus">-                                                   nsIMsgWindow *aMsgWindow)</span>
<a href="#l5.2607"></a><span id="l5.2607" class="difflineminus">-{</span>
<a href="#l5.2608"></a><span id="l5.2608" class="difflineplus">+NS_IMETHODIMP nsImapService::AppendMessageFromFile(</span>
<a href="#l5.2609"></a><span id="l5.2609" class="difflineplus">+    nsIFile *aFile, nsIMsgFolder *aDstFolder,</span>
<a href="#l5.2610"></a><span id="l5.2610" class="difflineplus">+    const nsACString &amp;messageId,  // to be replaced</span>
<a href="#l5.2611"></a><span id="l5.2611" class="difflineplus">+    bool idsAreUids,</span>
<a href="#l5.2612"></a><span id="l5.2612" class="difflineplus">+    bool inSelectedState,  // needs to be in</span>
<a href="#l5.2613"></a><span id="l5.2613" class="difflineplus">+    nsIUrlListener *aListener, nsIURI **aURL, nsISupports *aCopyState,</span>
<a href="#l5.2614"></a><span id="l5.2614" class="difflineplus">+    nsIMsgWindow *aMsgWindow) {</span>
<a href="#l5.2615"></a><span id="l5.2615">   NS_ENSURE_ARG_POINTER(aFile);</span>
<a href="#l5.2616"></a><span id="l5.2616">   NS_ENSURE_ARG_POINTER(aDstFolder);</span>
<a href="#l5.2617"></a><span id="l5.2617"> </span>
<a href="#l5.2618"></a><span id="l5.2618">   nsresult rv;</span>
<a href="#l5.2619"></a><span id="l5.2619">   nsCOMPtr&lt;nsIImapUrl&gt; imapUrl;</span>
<a href="#l5.2620"></a><span id="l5.2620">   nsAutoCString urlSpec;</span>
<a href="#l5.2621"></a><span id="l5.2621"> </span>
<a href="#l5.2622"></a><span id="l5.2622">   char hierarchyDelimiter = GetHierarchyDelimiter(aDstFolder);</span>
<a href="#l5.2623"></a><span id="l5.2623" class="difflineminus">-  rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(imapUrl), aDstFolder, aListener, urlSpec, hierarchyDelimiter);</span>
<a href="#l5.2624"></a><span id="l5.2624" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l5.2625"></a><span id="l5.2625" class="difflineminus">-  {</span>
<a href="#l5.2626"></a><span id="l5.2626" class="difflineplus">+  rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(imapUrl), aDstFolder,</span>
<a href="#l5.2627"></a><span id="l5.2627" class="difflineplus">+                            aListener, urlSpec, hierarchyDelimiter);</span>
<a href="#l5.2628"></a><span id="l5.2628" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l5.2629"></a><span id="l5.2629">     nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; msgUrl = do_QueryInterface(imapUrl);</span>
<a href="#l5.2630"></a><span id="l5.2630" class="difflineminus">-    if (msgUrl &amp;&amp; aMsgWindow)</span>
<a href="#l5.2631"></a><span id="l5.2631" class="difflineminus">-    {</span>
<a href="#l5.2632"></a><span id="l5.2632" class="difflineplus">+    if (msgUrl &amp;&amp; aMsgWindow) {</span>
<a href="#l5.2633"></a><span id="l5.2633">       // we get the loadGroup from msgWindow</span>
<a href="#l5.2634"></a><span id="l5.2634">       msgUrl-&gt;SetMsgWindow(aMsgWindow);</span>
<a href="#l5.2635"></a><span id="l5.2635">     }</span>
<a href="#l5.2636"></a><span id="l5.2636"> </span>
<a href="#l5.2637"></a><span id="l5.2637">     SetImapUrlSink(aDstFolder, imapUrl);</span>
<a href="#l5.2638"></a><span id="l5.2638">     imapUrl-&gt;SetMsgFile(aFile);</span>
<a href="#l5.2639"></a><span id="l5.2639">     imapUrl-&gt;SetCopyState(aCopyState);</span>
<a href="#l5.2640"></a><span id="l5.2640"> </span>
<a href="#l5.2641"></a><span id="l5.2641" class="difflineat">@@ -2163,1227 +2018,1129 @@ NS_IMETHODIMP nsImapService::AppendMessa</span>
<a href="#l5.2642"></a><span id="l5.2642">       urlSpec.AppendLiteral(&quot;/appendmsgfromfile&gt;&quot;);</span>
<a href="#l5.2643"></a><span id="l5.2643"> </span>
<a href="#l5.2644"></a><span id="l5.2644">     urlSpec.Append(hierarchyDelimiter);</span>
<a href="#l5.2645"></a><span id="l5.2645"> </span>
<a href="#l5.2646"></a><span id="l5.2646">     nsCString folderName;</span>
<a href="#l5.2647"></a><span id="l5.2647">     GetFolderName(aDstFolder, folderName);</span>
<a href="#l5.2648"></a><span id="l5.2648">     urlSpec.Append(folderName);</span>
<a href="#l5.2649"></a><span id="l5.2649"> </span>
<a href="#l5.2650"></a><span id="l5.2650" class="difflineminus">-    if (inSelectedState)</span>
<a href="#l5.2651"></a><span id="l5.2651" class="difflineminus">-    {</span>
<a href="#l5.2652"></a><span id="l5.2652" class="difflineplus">+    if (inSelectedState) {</span>
<a href="#l5.2653"></a><span id="l5.2653">       urlSpec.Append('&gt;');</span>
<a href="#l5.2654"></a><span id="l5.2654">       if (idsAreUids)</span>
<a href="#l5.2655"></a><span id="l5.2655">         urlSpec.Append(uidString);</span>
<a href="#l5.2656"></a><span id="l5.2656">       else</span>
<a href="#l5.2657"></a><span id="l5.2657">         urlSpec.Append(sequenceString);</span>
<a href="#l5.2658"></a><span id="l5.2658">       urlSpec.Append('&gt;');</span>
<a href="#l5.2659"></a><span id="l5.2659" class="difflineminus">-      if (!messageId.IsEmpty())</span>
<a href="#l5.2660"></a><span id="l5.2660" class="difflineminus">-        urlSpec.Append(messageId);</span>
<a href="#l5.2661"></a><span id="l5.2661" class="difflineplus">+      if (!messageId.IsEmpty()) urlSpec.Append(messageId);</span>
<a href="#l5.2662"></a><span id="l5.2662">     }</span>
<a href="#l5.2663"></a><span id="l5.2663"> </span>
<a href="#l5.2664"></a><span id="l5.2664">     rv = mailnewsurl-&gt;SetSpecInternal(urlSpec);</span>
<a href="#l5.2665"></a><span id="l5.2665" class="difflineminus">-    if (WeAreOffline())</span>
<a href="#l5.2666"></a><span id="l5.2666" class="difflineminus">-    {</span>
<a href="#l5.2667"></a><span id="l5.2667" class="difflineplus">+    if (WeAreOffline()) {</span>
<a href="#l5.2668"></a><span id="l5.2668">       // handle offline append to drafts or templates folder here.</span>
<a href="#l5.2669"></a><span id="l5.2669" class="difflineminus">-      return OfflineAppendFromFile(aFile, mailnewsurl, aDstFolder, messageId, inSelectedState, aListener, aURL, aCopyState);</span>
<a href="#l5.2670"></a><span id="l5.2670" class="difflineplus">+      return OfflineAppendFromFile(aFile, mailnewsurl, aDstFolder, messageId,</span>
<a href="#l5.2671"></a><span id="l5.2671" class="difflineplus">+                                   inSelectedState, aListener, aURL,</span>
<a href="#l5.2672"></a><span id="l5.2672" class="difflineplus">+                                   aCopyState);</span>
<a href="#l5.2673"></a><span id="l5.2673">     }</span>
<a href="#l5.2674"></a><span id="l5.2674">     if (NS_SUCCEEDED(rv))</span>
<a href="#l5.2675"></a><span id="l5.2675">       rv = GetImapConnectionAndLoadUrl(imapUrl, nullptr, aURL);</span>
<a href="#l5.2676"></a><span id="l5.2676">   }</span>
<a href="#l5.2677"></a><span id="l5.2677">   return rv;</span>
<a href="#l5.2678"></a><span id="l5.2678"> }</span>
<a href="#l5.2679"></a><span id="l5.2679"> </span>
<a href="#l5.2680"></a><span id="l5.2680"> nsresult nsImapService::GetImapConnectionAndLoadUrl(nsIImapUrl *aImapUrl,</span>
<a href="#l5.2681"></a><span id="l5.2681">                                                     nsISupports *aConsumer,</span>
<a href="#l5.2682"></a><span id="l5.2682" class="difflineminus">-                                                    nsIURI **aURL)</span>
<a href="#l5.2683"></a><span id="l5.2683" class="difflineminus">-{</span>
<a href="#l5.2684"></a><span id="l5.2684" class="difflineplus">+                                                    nsIURI **aURL) {</span>
<a href="#l5.2685"></a><span id="l5.2685">   NS_ENSURE_ARG_POINTER(aImapUrl);</span>
<a href="#l5.2686"></a><span id="l5.2686"> </span>
<a href="#l5.2687"></a><span id="l5.2687">   bool isValidUrl;</span>
<a href="#l5.2688"></a><span id="l5.2688">   aImapUrl-&gt;GetValidUrl(&amp;isValidUrl);</span>
<a href="#l5.2689"></a><span id="l5.2689" class="difflineminus">-  if (!isValidUrl)</span>
<a href="#l5.2690"></a><span id="l5.2690" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l5.2691"></a><span id="l5.2691" class="difflineminus">-</span>
<a href="#l5.2692"></a><span id="l5.2692" class="difflineminus">-  if (WeAreOffline())</span>
<a href="#l5.2693"></a><span id="l5.2693" class="difflineminus">-  {</span>
<a href="#l5.2694"></a><span id="l5.2694" class="difflineplus">+  if (!isValidUrl) return NS_ERROR_FAILURE;</span>
<a href="#l5.2695"></a><span id="l5.2695" class="difflineplus">+</span>
<a href="#l5.2696"></a><span id="l5.2696" class="difflineplus">+  if (WeAreOffline()) {</span>
<a href="#l5.2697"></a><span id="l5.2697">     nsImapAction imapAction;</span>
<a href="#l5.2698"></a><span id="l5.2698"> </span>
<a href="#l5.2699"></a><span id="l5.2699">     // the only thing we can do offline is fetch messages.</span>
<a href="#l5.2700"></a><span id="l5.2700">     // ### TODO - need to look at msg copy, save attachment, etc. when we</span>
<a href="#l5.2701"></a><span id="l5.2701">     // have offline message bodies.</span>
<a href="#l5.2702"></a><span id="l5.2702">     aImapUrl-&gt;GetImapAction(&amp;imapAction);</span>
<a href="#l5.2703"></a><span id="l5.2703" class="difflineminus">-    if (imapAction != nsIImapUrl::nsImapMsgFetch &amp;&amp; imapAction != nsIImapUrl::nsImapSaveMessageToDisk)</span>
<a href="#l5.2704"></a><span id="l5.2704" class="difflineplus">+    if (imapAction != nsIImapUrl::nsImapMsgFetch &amp;&amp;</span>
<a href="#l5.2705"></a><span id="l5.2705" class="difflineplus">+        imapAction != nsIImapUrl::nsImapSaveMessageToDisk)</span>
<a href="#l5.2706"></a><span id="l5.2706">       return NS_MSG_ERROR_OFFLINE;</span>
<a href="#l5.2707"></a><span id="l5.2707">   }</span>
<a href="#l5.2708"></a><span id="l5.2708"> </span>
<a href="#l5.2709"></a><span id="l5.2709">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; aMsgIncomingServer;</span>
<a href="#l5.2710"></a><span id="l5.2710">   nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; msgUrl = do_QueryInterface(aImapUrl);</span>
<a href="#l5.2711"></a><span id="l5.2711">   nsresult rv = msgUrl-&gt;GetServer(getter_AddRefs(aMsgIncomingServer));</span>
<a href="#l5.2712"></a><span id="l5.2712"> </span>
<a href="#l5.2713"></a><span id="l5.2713" class="difflineminus">-  if (aURL)</span>
<a href="#l5.2714"></a><span id="l5.2714" class="difflineminus">-  {</span>
<a href="#l5.2715"></a><span id="l5.2715" class="difflineplus">+  if (aURL) {</span>
<a href="#l5.2716"></a><span id="l5.2716">     msgUrl.forget(aURL);</span>
<a href="#l5.2717"></a><span id="l5.2717">   }</span>
<a href="#l5.2718"></a><span id="l5.2718"> </span>
<a href="#l5.2719"></a><span id="l5.2719" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; aMsgIncomingServer)</span>
<a href="#l5.2720"></a><span id="l5.2720" class="difflineminus">-  {</span>
<a href="#l5.2721"></a><span id="l5.2721" class="difflineminus">-    nsCOMPtr&lt;nsIImapIncomingServer&gt; aImapServer(do_QueryInterface(aMsgIncomingServer, &amp;rv));</span>
<a href="#l5.2722"></a><span id="l5.2722" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; aMsgIncomingServer) {</span>
<a href="#l5.2723"></a><span id="l5.2723" class="difflineplus">+    nsCOMPtr&lt;nsIImapIncomingServer&gt; aImapServer(</span>
<a href="#l5.2724"></a><span id="l5.2724" class="difflineplus">+        do_QueryInterface(aMsgIncomingServer, &amp;rv));</span>
<a href="#l5.2725"></a><span id="l5.2725">     if (NS_SUCCEEDED(rv) &amp;&amp; aImapServer)</span>
<a href="#l5.2726"></a><span id="l5.2726">       rv = aImapServer-&gt;GetImapConnectionAndLoadUrl(aImapUrl, aConsumer);</span>
<a href="#l5.2727"></a><span id="l5.2727">   }</span>
<a href="#l5.2728"></a><span id="l5.2728">   return rv;</span>
<a href="#l5.2729"></a><span id="l5.2729"> }</span>
<a href="#l5.2730"></a><span id="l5.2730"> </span>
<a href="#l5.2731"></a><span id="l5.2731"> NS_IMETHODIMP nsImapService::MoveFolder(nsIMsgFolder *srcFolder,</span>
<a href="#l5.2732"></a><span id="l5.2732">                                         nsIMsgFolder *dstFolder,</span>
<a href="#l5.2733"></a><span id="l5.2733">                                         nsIUrlListener *urlListener,</span>
<a href="#l5.2734"></a><span id="l5.2734" class="difflineminus">-                                        nsIMsgWindow *msgWindow,</span>
<a href="#l5.2735"></a><span id="l5.2735" class="difflineminus">-                                        nsIURI **url)</span>
<a href="#l5.2736"></a><span id="l5.2736" class="difflineminus">-{</span>
<a href="#l5.2737"></a><span id="l5.2737" class="difflineplus">+                                        nsIMsgWindow *msgWindow, nsIURI **url) {</span>
<a href="#l5.2738"></a><span id="l5.2738">   NS_ENSURE_ARG_POINTER(srcFolder);</span>
<a href="#l5.2739"></a><span id="l5.2739">   NS_ENSURE_ARG_POINTER(dstFolder);</span>
<a href="#l5.2740"></a><span id="l5.2740"> </span>
<a href="#l5.2741"></a><span id="l5.2741">   nsCOMPtr&lt;nsIImapUrl&gt; imapUrl;</span>
<a href="#l5.2742"></a><span id="l5.2742">   nsAutoCString urlSpec;</span>
<a href="#l5.2743"></a><span id="l5.2743">   nsresult rv;</span>
<a href="#l5.2744"></a><span id="l5.2744"> </span>
<a href="#l5.2745"></a><span id="l5.2745">   char default_hierarchyDelimiter = GetHierarchyDelimiter(dstFolder);</span>
<a href="#l5.2746"></a><span id="l5.2746">   rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(imapUrl), dstFolder,</span>
<a href="#l5.2747"></a><span id="l5.2747">                             urlListener, urlSpec, default_hierarchyDelimiter);</span>
<a href="#l5.2748"></a><span id="l5.2748" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; imapUrl)</span>
<a href="#l5.2749"></a><span id="l5.2749" class="difflineminus">-  {</span>
<a href="#l5.2750"></a><span id="l5.2750" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; imapUrl) {</span>
<a href="#l5.2751"></a><span id="l5.2751">     rv = SetImapUrlSink(dstFolder, imapUrl);</span>
<a href="#l5.2752"></a><span id="l5.2752" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l5.2753"></a><span id="l5.2753" class="difflineminus">-    {</span>
<a href="#l5.2754"></a><span id="l5.2754" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l5.2755"></a><span id="l5.2755">       nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailNewsUrl = do_QueryInterface(imapUrl);</span>
<a href="#l5.2756"></a><span id="l5.2756" class="difflineminus">-      if (mailNewsUrl)</span>
<a href="#l5.2757"></a><span id="l5.2757" class="difflineminus">-        mailNewsUrl-&gt;SetMsgWindow(msgWindow);</span>
<a href="#l5.2758"></a><span id="l5.2758" class="difflineplus">+      if (mailNewsUrl) mailNewsUrl-&gt;SetMsgWindow(msgWindow);</span>
<a href="#l5.2759"></a><span id="l5.2759">       char hierarchyDelimiter = kOnlineHierarchySeparatorUnknown;</span>
<a href="#l5.2760"></a><span id="l5.2760">       nsCString folderName;</span>
<a href="#l5.2761"></a><span id="l5.2761"> </span>
<a href="#l5.2762"></a><span id="l5.2762">       nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsurl = do_QueryInterface(imapUrl);</span>
<a href="#l5.2763"></a><span id="l5.2763">       GetFolderName(srcFolder, folderName);</span>
<a href="#l5.2764"></a><span id="l5.2764">       urlSpec.AppendLiteral(&quot;/movefolderhierarchy&gt;&quot;);</span>
<a href="#l5.2765"></a><span id="l5.2765">       urlSpec.Append(hierarchyDelimiter);</span>
<a href="#l5.2766"></a><span id="l5.2766">       urlSpec.Append(folderName);</span>
<a href="#l5.2767"></a><span id="l5.2767">       urlSpec.Append('&gt;');</span>
<a href="#l5.2768"></a><span id="l5.2768">       GetFolderName(dstFolder, folderName);</span>
<a href="#l5.2769"></a><span id="l5.2769" class="difflineminus">-      if (!folderName.IsEmpty())</span>
<a href="#l5.2770"></a><span id="l5.2770" class="difflineminus">-      {</span>
<a href="#l5.2771"></a><span id="l5.2771" class="difflineplus">+      if (!folderName.IsEmpty()) {</span>
<a href="#l5.2772"></a><span id="l5.2772">         urlSpec.Append(hierarchyDelimiter);</span>
<a href="#l5.2773"></a><span id="l5.2773">         urlSpec.Append(folderName);</span>
<a href="#l5.2774"></a><span id="l5.2774">       }</span>
<a href="#l5.2775"></a><span id="l5.2775">       rv = mailnewsurl-&gt;SetSpecInternal(urlSpec);</span>
<a href="#l5.2776"></a><span id="l5.2776" class="difflineminus">-      if (NS_SUCCEEDED(rv))</span>
<a href="#l5.2777"></a><span id="l5.2777" class="difflineminus">-      {</span>
<a href="#l5.2778"></a><span id="l5.2778" class="difflineplus">+      if (NS_SUCCEEDED(rv)) {</span>
<a href="#l5.2779"></a><span id="l5.2779">         GetFolderName(srcFolder, folderName);</span>
<a href="#l5.2780"></a><span id="l5.2780">         rv = GetImapConnectionAndLoadUrl(imapUrl, nullptr, url);</span>
<a href="#l5.2781"></a><span id="l5.2781">       }</span>
<a href="#l5.2782"></a><span id="l5.2782">     }</span>
<a href="#l5.2783"></a><span id="l5.2783">   }</span>
<a href="#l5.2784"></a><span id="l5.2784">   return rv;</span>
<a href="#l5.2785"></a><span id="l5.2785"> }</span>
<a href="#l5.2786"></a><span id="l5.2786"> </span>
<a href="#l5.2787"></a><span id="l5.2787"> NS_IMETHODIMP nsImapService::RenameLeaf(nsIMsgFolder *srcFolder,</span>
<a href="#l5.2788"></a><span id="l5.2788">                                         const nsAString &amp;newLeafName,</span>
<a href="#l5.2789"></a><span id="l5.2789">                                         nsIUrlListener *urlListener,</span>
<a href="#l5.2790"></a><span id="l5.2790" class="difflineminus">-                                        nsIMsgWindow *msgWindow,</span>
<a href="#l5.2791"></a><span id="l5.2791" class="difflineminus">-                                        nsIURI **url)</span>
<a href="#l5.2792"></a><span id="l5.2792" class="difflineminus">-{</span>
<a href="#l5.2793"></a><span id="l5.2793" class="difflineplus">+                                        nsIMsgWindow *msgWindow, nsIURI **url) {</span>
<a href="#l5.2794"></a><span id="l5.2794">   NS_ENSURE_ARG_POINTER(srcFolder);</span>
<a href="#l5.2795"></a><span id="l5.2795"> </span>
<a href="#l5.2796"></a><span id="l5.2796">   nsCOMPtr&lt;nsIImapUrl&gt; imapUrl;</span>
<a href="#l5.2797"></a><span id="l5.2797">   nsAutoCString urlSpec;</span>
<a href="#l5.2798"></a><span id="l5.2798"> </span>
<a href="#l5.2799"></a><span id="l5.2799">   char hierarchyDelimiter = GetHierarchyDelimiter(srcFolder);</span>
<a href="#l5.2800"></a><span id="l5.2800" class="difflineminus">-  nsresult rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(imapUrl), srcFolder,</span>
<a href="#l5.2801"></a><span id="l5.2801" class="difflineminus">-                            urlListener, urlSpec, hierarchyDelimiter);</span>
<a href="#l5.2802"></a><span id="l5.2802" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l5.2803"></a><span id="l5.2803" class="difflineminus">-  {</span>
<a href="#l5.2804"></a><span id="l5.2804" class="difflineplus">+  nsresult rv =</span>
<a href="#l5.2805"></a><span id="l5.2805" class="difflineplus">+      CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(imapUrl), srcFolder,</span>
<a href="#l5.2806"></a><span id="l5.2806" class="difflineplus">+                           urlListener, urlSpec, hierarchyDelimiter);</span>
<a href="#l5.2807"></a><span id="l5.2807" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l5.2808"></a><span id="l5.2808">     rv = SetImapUrlSink(srcFolder, imapUrl);</span>
<a href="#l5.2809"></a><span id="l5.2809" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l5.2810"></a><span id="l5.2810" class="difflineminus">-    {</span>
<a href="#l5.2811"></a><span id="l5.2811" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l5.2812"></a><span id="l5.2812">       nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailNewsUrl = do_QueryInterface(imapUrl);</span>
<a href="#l5.2813"></a><span id="l5.2813">       mailNewsUrl-&gt;SetMsgWindow(msgWindow);</span>
<a href="#l5.2814"></a><span id="l5.2814">       nsCString folderName;</span>
<a href="#l5.2815"></a><span id="l5.2815">       GetFolderName(srcFolder, folderName);</span>
<a href="#l5.2816"></a><span id="l5.2816">       urlSpec.AppendLiteral(&quot;/rename&gt;&quot;);</span>
<a href="#l5.2817"></a><span id="l5.2817">       urlSpec.Append(hierarchyDelimiter);</span>
<a href="#l5.2818"></a><span id="l5.2818">       urlSpec.Append(folderName);</span>
<a href="#l5.2819"></a><span id="l5.2819">       urlSpec.Append('&gt;');</span>
<a href="#l5.2820"></a><span id="l5.2820">       urlSpec.Append(hierarchyDelimiter);</span>
<a href="#l5.2821"></a><span id="l5.2821">       nsAutoCString cStrFolderName;</span>
<a href="#l5.2822"></a><span id="l5.2822">       // Unescape the name before looking for parent path</span>
<a href="#l5.2823"></a><span id="l5.2823">       MsgUnescapeString(folderName, 0, cStrFolderName);</span>
<a href="#l5.2824"></a><span id="l5.2824">       int32_t leafNameStart = cStrFolderName.RFindChar(hierarchyDelimiter);</span>
<a href="#l5.2825"></a><span id="l5.2825" class="difflineminus">-      if (leafNameStart != -1)</span>
<a href="#l5.2826"></a><span id="l5.2826" class="difflineminus">-      {</span>
<a href="#l5.2827"></a><span id="l5.2827" class="difflineminus">-        cStrFolderName.SetLength(leafNameStart+1);</span>
<a href="#l5.2828"></a><span id="l5.2828" class="difflineplus">+      if (leafNameStart != -1) {</span>
<a href="#l5.2829"></a><span id="l5.2829" class="difflineplus">+        cStrFolderName.SetLength(leafNameStart + 1);</span>
<a href="#l5.2830"></a><span id="l5.2830">         urlSpec.Append(cStrFolderName);</span>
<a href="#l5.2831"></a><span id="l5.2831">       }</span>
<a href="#l5.2832"></a><span id="l5.2832"> </span>
<a href="#l5.2833"></a><span id="l5.2833">       nsAutoCString utfNewName;</span>
<a href="#l5.2834"></a><span id="l5.2834">       CopyUTF16toMUTF7(PromiseFlatString(newLeafName), utfNewName);</span>
<a href="#l5.2835"></a><span id="l5.2835">       nsCString escapedNewName;</span>
<a href="#l5.2836"></a><span id="l5.2836">       MsgEscapeString(utfNewName, nsINetUtil::ESCAPE_URL_PATH, escapedNewName);</span>
<a href="#l5.2837"></a><span id="l5.2837">       nsCString escapedSlashName;</span>
<a href="#l5.2838"></a><span id="l5.2838" class="difflineminus">-      rv = nsImapUrl::EscapeSlashes(escapedNewName.get(), getter_Copies(escapedSlashName));</span>
<a href="#l5.2839"></a><span id="l5.2839" class="difflineplus">+      rv = nsImapUrl::EscapeSlashes(escapedNewName.get(),</span>
<a href="#l5.2840"></a><span id="l5.2840" class="difflineplus">+                                    getter_Copies(escapedSlashName));</span>
<a href="#l5.2841"></a><span id="l5.2841">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.2842"></a><span id="l5.2842">       urlSpec.Append(escapedSlashName);</span>
<a href="#l5.2843"></a><span id="l5.2843"> </span>
<a href="#l5.2844"></a><span id="l5.2844">       rv = mailNewsUrl-&gt;SetSpecInternal(urlSpec);</span>
<a href="#l5.2845"></a><span id="l5.2845">       if (NS_SUCCEEDED(rv))</span>
<a href="#l5.2846"></a><span id="l5.2846">         rv = GetImapConnectionAndLoadUrl(imapUrl, nullptr, url);</span>
<a href="#l5.2847"></a><span id="l5.2847">     }</span>
<a href="#l5.2848"></a><span id="l5.2848">   }</span>
<a href="#l5.2849"></a><span id="l5.2849">   return rv;</span>
<a href="#l5.2850"></a><span id="l5.2850"> }</span>
<a href="#l5.2851"></a><span id="l5.2851"> </span>
<a href="#l5.2852"></a><span id="l5.2852"> NS_IMETHODIMP nsImapService::CreateFolder(nsIMsgFolder *parent,</span>
<a href="#l5.2853"></a><span id="l5.2853">                                           const nsAString &amp;newFolderName,</span>
<a href="#l5.2854"></a><span id="l5.2854">                                           nsIUrlListener *urlListener,</span>
<a href="#l5.2855"></a><span id="l5.2855" class="difflineminus">-                                          nsIURI **url)</span>
<a href="#l5.2856"></a><span id="l5.2856" class="difflineminus">-{</span>
<a href="#l5.2857"></a><span id="l5.2857" class="difflineplus">+                                          nsIURI **url) {</span>
<a href="#l5.2858"></a><span id="l5.2858">   NS_ENSURE_ARG_POINTER(parent);</span>
<a href="#l5.2859"></a><span id="l5.2859"> </span>
<a href="#l5.2860"></a><span id="l5.2860">   nsCOMPtr&lt;nsIImapUrl&gt; imapUrl;</span>
<a href="#l5.2861"></a><span id="l5.2861">   nsAutoCString urlSpec;</span>
<a href="#l5.2862"></a><span id="l5.2862">   nsresult rv;</span>
<a href="#l5.2863"></a><span id="l5.2863"> </span>
<a href="#l5.2864"></a><span id="l5.2864">   char hierarchyDelimiter = GetHierarchyDelimiter(parent);</span>
<a href="#l5.2865"></a><span id="l5.2865">   rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(imapUrl), parent,</span>
<a href="#l5.2866"></a><span id="l5.2866">                             urlListener, urlSpec, hierarchyDelimiter);</span>
<a href="#l5.2867"></a><span id="l5.2867" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; imapUrl)</span>
<a href="#l5.2868"></a><span id="l5.2868" class="difflineminus">-  {</span>
<a href="#l5.2869"></a><span id="l5.2869" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; imapUrl) {</span>
<a href="#l5.2870"></a><span id="l5.2870">     rv = SetImapUrlSink(parent, imapUrl);</span>
<a href="#l5.2871"></a><span id="l5.2871" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l5.2872"></a><span id="l5.2872" class="difflineminus">-    {</span>
<a href="#l5.2873"></a><span id="l5.2873" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l5.2874"></a><span id="l5.2874">       nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsurl = do_QueryInterface(imapUrl);</span>
<a href="#l5.2875"></a><span id="l5.2875"> </span>
<a href="#l5.2876"></a><span id="l5.2876">       nsCString folderName;</span>
<a href="#l5.2877"></a><span id="l5.2877">       GetFolderName(parent, folderName);</span>
<a href="#l5.2878"></a><span id="l5.2878">       urlSpec.AppendLiteral(&quot;/create&gt;&quot;);</span>
<a href="#l5.2879"></a><span id="l5.2879">       urlSpec.Append(hierarchyDelimiter);</span>
<a href="#l5.2880"></a><span id="l5.2880" class="difflineminus">-      if (!folderName.IsEmpty())</span>
<a href="#l5.2881"></a><span id="l5.2881" class="difflineminus">-      {</span>
<a href="#l5.2882"></a><span id="l5.2882" class="difflineplus">+      if (!folderName.IsEmpty()) {</span>
<a href="#l5.2883"></a><span id="l5.2883">         nsCString canonicalName;</span>
<a href="#l5.2884"></a><span id="l5.2884" class="difflineminus">-        nsImapUrl::ConvertToCanonicalFormat(folderName.get(),</span>
<a href="#l5.2885"></a><span id="l5.2885" class="difflineminus">-                                            hierarchyDelimiter,</span>
<a href="#l5.2886"></a><span id="l5.2886" class="difflineminus">-                                            getter_Copies(canonicalName));</span>
<a href="#l5.2887"></a><span id="l5.2887" class="difflineplus">+        nsImapUrl::ConvertToCanonicalFormat(</span>
<a href="#l5.2888"></a><span id="l5.2888" class="difflineplus">+            folderName.get(), hierarchyDelimiter, getter_Copies(canonicalName));</span>
<a href="#l5.2889"></a><span id="l5.2889">         urlSpec.Append(canonicalName);</span>
<a href="#l5.2890"></a><span id="l5.2890">         urlSpec.Append(hierarchyDelimiter);</span>
<a href="#l5.2891"></a><span id="l5.2891">       }</span>
<a href="#l5.2892"></a><span id="l5.2892"> </span>
<a href="#l5.2893"></a><span id="l5.2893">       nsAutoCString utfNewName;</span>
<a href="#l5.2894"></a><span id="l5.2894">       rv = CopyUTF16toMUTF7(PromiseFlatString(newFolderName), utfNewName);</span>
<a href="#l5.2895"></a><span id="l5.2895">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.2896"></a><span id="l5.2896">       nsCString escapedFolderName;</span>
<a href="#l5.2897"></a><span id="l5.2897" class="difflineminus">-      MsgEscapeString(utfNewName, nsINetUtil::ESCAPE_URL_PATH, escapedFolderName);</span>
<a href="#l5.2898"></a><span id="l5.2898" class="difflineplus">+      MsgEscapeString(utfNewName, nsINetUtil::ESCAPE_URL_PATH,</span>
<a href="#l5.2899"></a><span id="l5.2899" class="difflineplus">+                      escapedFolderName);</span>
<a href="#l5.2900"></a><span id="l5.2900">       urlSpec.Append(escapedFolderName);</span>
<a href="#l5.2901"></a><span id="l5.2901"> </span>
<a href="#l5.2902"></a><span id="l5.2902">       rv = mailnewsurl-&gt;SetSpecInternal(urlSpec);</span>
<a href="#l5.2903"></a><span id="l5.2903">       if (NS_SUCCEEDED(rv))</span>
<a href="#l5.2904"></a><span id="l5.2904">         rv = GetImapConnectionAndLoadUrl(imapUrl, nullptr, url);</span>
<a href="#l5.2905"></a><span id="l5.2905">     }</span>
<a href="#l5.2906"></a><span id="l5.2906">   }</span>
<a href="#l5.2907"></a><span id="l5.2907">   return rv;</span>
<a href="#l5.2908"></a><span id="l5.2908"> }</span>
<a href="#l5.2909"></a><span id="l5.2909"> </span>
<a href="#l5.2910"></a><span id="l5.2910"> NS_IMETHODIMP nsImapService::EnsureFolderExists(nsIMsgFolder *parent,</span>
<a href="#l5.2911"></a><span id="l5.2911">                                                 const nsAString &amp;newFolderName,</span>
<a href="#l5.2912"></a><span id="l5.2912">                                                 nsIUrlListener *urlListener,</span>
<a href="#l5.2913"></a><span id="l5.2913" class="difflineminus">-                                                nsIURI **url)</span>
<a href="#l5.2914"></a><span id="l5.2914" class="difflineminus">-{</span>
<a href="#l5.2915"></a><span id="l5.2915" class="difflineplus">+                                                nsIURI **url) {</span>
<a href="#l5.2916"></a><span id="l5.2916">   NS_ENSURE_ARG_POINTER(parent);</span>
<a href="#l5.2917"></a><span id="l5.2917"> </span>
<a href="#l5.2918"></a><span id="l5.2918">   nsCOMPtr&lt;nsIImapUrl&gt; imapUrl;</span>
<a href="#l5.2919"></a><span id="l5.2919">   nsAutoCString urlSpec;</span>
<a href="#l5.2920"></a><span id="l5.2920">   nsresult rv;</span>
<a href="#l5.2921"></a><span id="l5.2921"> </span>
<a href="#l5.2922"></a><span id="l5.2922">   char hierarchyDelimiter = GetHierarchyDelimiter(parent);</span>
<a href="#l5.2923"></a><span id="l5.2923" class="difflineminus">-  rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(imapUrl), parent, urlListener, urlSpec, hierarchyDelimiter);</span>
<a href="#l5.2924"></a><span id="l5.2924" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; imapUrl)</span>
<a href="#l5.2925"></a><span id="l5.2925" class="difflineminus">-  {</span>
<a href="#l5.2926"></a><span id="l5.2926" class="difflineplus">+  rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(imapUrl), parent,</span>
<a href="#l5.2927"></a><span id="l5.2927" class="difflineplus">+                            urlListener, urlSpec, hierarchyDelimiter);</span>
<a href="#l5.2928"></a><span id="l5.2928" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; imapUrl) {</span>
<a href="#l5.2929"></a><span id="l5.2929">     rv = SetImapUrlSink(parent, imapUrl);</span>
<a href="#l5.2930"></a><span id="l5.2930" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l5.2931"></a><span id="l5.2931" class="difflineminus">-    {</span>
<a href="#l5.2932"></a><span id="l5.2932" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l5.2933"></a><span id="l5.2933">       nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsurl = do_QueryInterface(imapUrl);</span>
<a href="#l5.2934"></a><span id="l5.2934"> </span>
<a href="#l5.2935"></a><span id="l5.2935">       nsCString folderName;</span>
<a href="#l5.2936"></a><span id="l5.2936">       GetFolderName(parent, folderName);</span>
<a href="#l5.2937"></a><span id="l5.2937">       urlSpec.AppendLiteral(&quot;/ensureExists&gt;&quot;);</span>
<a href="#l5.2938"></a><span id="l5.2938">       urlSpec.Append(hierarchyDelimiter);</span>
<a href="#l5.2939"></a><span id="l5.2939" class="difflineminus">-      if (!folderName.IsEmpty())</span>
<a href="#l5.2940"></a><span id="l5.2940" class="difflineminus">-      {</span>
<a href="#l5.2941"></a><span id="l5.2941" class="difflineplus">+      if (!folderName.IsEmpty()) {</span>
<a href="#l5.2942"></a><span id="l5.2942">         urlSpec.Append(folderName);</span>
<a href="#l5.2943"></a><span id="l5.2943">         urlSpec.Append(hierarchyDelimiter);</span>
<a href="#l5.2944"></a><span id="l5.2944">       }</span>
<a href="#l5.2945"></a><span id="l5.2945">       nsAutoCString utfNewName;</span>
<a href="#l5.2946"></a><span id="l5.2946">       CopyUTF16toMUTF7(PromiseFlatString(newFolderName), utfNewName);</span>
<a href="#l5.2947"></a><span id="l5.2947">       nsCString escapedFolderName;</span>
<a href="#l5.2948"></a><span id="l5.2948" class="difflineminus">-      MsgEscapeString(utfNewName, nsINetUtil::ESCAPE_URL_PATH, escapedFolderName);</span>
<a href="#l5.2949"></a><span id="l5.2949" class="difflineplus">+      MsgEscapeString(utfNewName, nsINetUtil::ESCAPE_URL_PATH,</span>
<a href="#l5.2950"></a><span id="l5.2950" class="difflineplus">+                      escapedFolderName);</span>
<a href="#l5.2951"></a><span id="l5.2951">       urlSpec.Append(escapedFolderName);</span>
<a href="#l5.2952"></a><span id="l5.2952"> </span>
<a href="#l5.2953"></a><span id="l5.2953">       rv = mailnewsurl-&gt;SetSpecInternal(urlSpec);</span>
<a href="#l5.2954"></a><span id="l5.2954">       if (NS_SUCCEEDED(rv))</span>
<a href="#l5.2955"></a><span id="l5.2955">         rv = GetImapConnectionAndLoadUrl(imapUrl, nullptr, url);</span>
<a href="#l5.2956"></a><span id="l5.2956">     }</span>
<a href="#l5.2957"></a><span id="l5.2957">   }</span>
<a href="#l5.2958"></a><span id="l5.2958">   return rv;</span>
<a href="#l5.2959"></a><span id="l5.2959"> }</span>
<a href="#l5.2960"></a><span id="l5.2960"> </span>
<a href="#l5.2961"></a><span id="l5.2961"> NS_IMETHODIMP nsImapService::ListFolder(nsIMsgFolder *aImapMailFolder,</span>
<a href="#l5.2962"></a><span id="l5.2962">                                         nsIUrlListener *aUrlListener,</span>
<a href="#l5.2963"></a><span id="l5.2963" class="difflineminus">-                                        nsIURI **aURL)</span>
<a href="#l5.2964"></a><span id="l5.2964" class="difflineminus">-{</span>
<a href="#l5.2965"></a><span id="l5.2965" class="difflineplus">+                                        nsIURI **aURL) {</span>
<a href="#l5.2966"></a><span id="l5.2966">   NS_ENSURE_ARG_POINTER(aImapMailFolder);</span>
<a href="#l5.2967"></a><span id="l5.2967"> </span>
<a href="#l5.2968"></a><span id="l5.2968" class="difflineminus">-  return FolderCommand(aImapMailFolder, aUrlListener,</span>
<a href="#l5.2969"></a><span id="l5.2969" class="difflineminus">-                       &quot;/listfolder&gt;&quot;, nsIImapUrl::nsImapListFolder, nullptr, aURL);</span>
<a href="#l5.2970"></a><span id="l5.2970" class="difflineplus">+  return FolderCommand(aImapMailFolder, aUrlListener, &quot;/listfolder&gt;&quot;,</span>
<a href="#l5.2971"></a><span id="l5.2971" class="difflineplus">+                       nsIImapUrl::nsImapListFolder, nullptr, aURL);</span>
<a href="#l5.2972"></a><span id="l5.2972"> }</span>
<a href="#l5.2973"></a><span id="l5.2973"> </span>
<a href="#l5.2974"></a><span id="l5.2974" class="difflineminus">-NS_IMETHODIMP nsImapService::GetScheme(nsACString &amp;aScheme)</span>
<a href="#l5.2975"></a><span id="l5.2975" class="difflineminus">-{</span>
<a href="#l5.2976"></a><span id="l5.2976" class="difflineplus">+NS_IMETHODIMP nsImapService::GetScheme(nsACString &amp;aScheme) {</span>
<a href="#l5.2977"></a><span id="l5.2977">   aScheme.AssignLiteral(&quot;imap&quot;);</span>
<a href="#l5.2978"></a><span id="l5.2978">   return NS_OK;</span>
<a href="#l5.2979"></a><span id="l5.2979"> }</span>
<a href="#l5.2980"></a><span id="l5.2980"> </span>
<a href="#l5.2981"></a><span id="l5.2981" class="difflineminus">-NS_IMETHODIMP nsImapService::GetDefaultPort(int32_t *aDefaultPort)</span>
<a href="#l5.2982"></a><span id="l5.2982" class="difflineminus">-{</span>
<a href="#l5.2983"></a><span id="l5.2983" class="difflineplus">+NS_IMETHODIMP nsImapService::GetDefaultPort(int32_t *aDefaultPort) {</span>
<a href="#l5.2984"></a><span id="l5.2984">   NS_ENSURE_ARG_POINTER(aDefaultPort);</span>
<a href="#l5.2985"></a><span id="l5.2985">   *aDefaultPort = nsIImapUrl::DEFAULT_IMAP_PORT;</span>
<a href="#l5.2986"></a><span id="l5.2986">   return NS_OK;</span>
<a href="#l5.2987"></a><span id="l5.2987"> }</span>
<a href="#l5.2988"></a><span id="l5.2988"> </span>
<a href="#l5.2989"></a><span id="l5.2989" class="difflineminus">-NS_IMETHODIMP nsImapService::GetProtocolFlags(uint32_t *result)</span>
<a href="#l5.2990"></a><span id="l5.2990" class="difflineminus">-{</span>
<a href="#l5.2991"></a><span id="l5.2991" class="difflineplus">+NS_IMETHODIMP nsImapService::GetProtocolFlags(uint32_t *result) {</span>
<a href="#l5.2992"></a><span id="l5.2992">   *result = URI_NORELATIVE | URI_FORBIDS_AUTOMATIC_DOCUMENT_REPLACEMENT |</span>
<a href="#l5.2993"></a><span id="l5.2993" class="difflineminus">-    URI_DANGEROUS_TO_LOAD | ALLOWS_PROXY | URI_FORBIDS_COOKIE_ACCESS</span>
<a href="#l5.2994"></a><span id="l5.2994" class="difflineplus">+            URI_DANGEROUS_TO_LOAD | ALLOWS_PROXY | URI_FORBIDS_COOKIE_ACCESS</span>
<a href="#l5.2995"></a><span id="l5.2995"> #ifdef IS_ORIGIN_IS_FULL_SPEC_DEFINED</span>
<a href="#l5.2996"></a><span id="l5.2996" class="difflineminus">-    | ORIGIN_IS_FULL_SPEC</span>
<a href="#l5.2997"></a><span id="l5.2997" class="difflineplus">+            | ORIGIN_IS_FULL_SPEC</span>
<a href="#l5.2998"></a><span id="l5.2998"> #endif</span>
<a href="#l5.2999"></a><span id="l5.2999" class="difflineminus">-  ;</span>
<a href="#l5.3000"></a><span id="l5.3000" class="difflineplus">+      ;</span>
<a href="#l5.3001"></a><span id="l5.3001">   return NS_OK;</span>
<a href="#l5.3002"></a><span id="l5.3002"> }</span>
<a href="#l5.3003"></a><span id="l5.3003"> </span>
<a href="#l5.3004"></a><span id="l5.3004" class="difflineminus">-NS_IMETHODIMP nsImapService::AllowPort(int32_t port, const char *scheme, bool *aRetVal)</span>
<a href="#l5.3005"></a><span id="l5.3005" class="difflineminus">-{</span>
<a href="#l5.3006"></a><span id="l5.3006" class="difflineplus">+NS_IMETHODIMP nsImapService::AllowPort(int32_t port, const char *scheme,</span>
<a href="#l5.3007"></a><span id="l5.3007" class="difflineplus">+                                       bool *aRetVal) {</span>
<a href="#l5.3008"></a><span id="l5.3008">   // allow imap to run on any port</span>
<a href="#l5.3009"></a><span id="l5.3009">   *aRetVal = true;</span>
<a href="#l5.3010"></a><span id="l5.3010">   return NS_OK;</span>
<a href="#l5.3011"></a><span id="l5.3011"> }</span>
<a href="#l5.3012"></a><span id="l5.3012"> </span>
<a href="#l5.3013"></a><span id="l5.3013" class="difflineminus">-NS_IMETHODIMP nsImapService::GetDefaultDoBiff(bool *aDoBiff)</span>
<a href="#l5.3014"></a><span id="l5.3014" class="difflineminus">-{</span>
<a href="#l5.3015"></a><span id="l5.3015" class="difflineplus">+NS_IMETHODIMP nsImapService::GetDefaultDoBiff(bool *aDoBiff) {</span>
<a href="#l5.3016"></a><span id="l5.3016">   NS_ENSURE_ARG_POINTER(aDoBiff);</span>
<a href="#l5.3017"></a><span id="l5.3017">   // by default, do biff for IMAP servers</span>
<a href="#l5.3018"></a><span id="l5.3018">   *aDoBiff = true;</span>
<a href="#l5.3019"></a><span id="l5.3019">   return NS_OK;</span>
<a href="#l5.3020"></a><span id="l5.3020"> }</span>
<a href="#l5.3021"></a><span id="l5.3021"> </span>
<a href="#l5.3022"></a><span id="l5.3022" class="difflineminus">-NS_IMETHODIMP nsImapService::GetDefaultServerPort(bool isSecure, int32_t *aDefaultPort)</span>
<a href="#l5.3023"></a><span id="l5.3023" class="difflineminus">-{</span>
<a href="#l5.3024"></a><span id="l5.3024" class="difflineplus">+NS_IMETHODIMP nsImapService::GetDefaultServerPort(bool isSecure,</span>
<a href="#l5.3025"></a><span id="l5.3025" class="difflineplus">+                                                  int32_t *aDefaultPort) {</span>
<a href="#l5.3026"></a><span id="l5.3026">   nsresult rv = NS_OK;</span>
<a href="#l5.3027"></a><span id="l5.3027"> </span>
<a href="#l5.3028"></a><span id="l5.3028">   // Return Secure IMAP Port if secure option chosen i.e., if isSecure is TRUE</span>
<a href="#l5.3029"></a><span id="l5.3029">   if (isSecure)</span>
<a href="#l5.3030"></a><span id="l5.3030">     *aDefaultPort = nsIImapUrl::DEFAULT_IMAPS_PORT;</span>
<a href="#l5.3031"></a><span id="l5.3031">   else</span>
<a href="#l5.3032"></a><span id="l5.3032">     rv = GetDefaultPort(aDefaultPort);</span>
<a href="#l5.3033"></a><span id="l5.3033"> </span>
<a href="#l5.3034"></a><span id="l5.3034">   return rv;</span>
<a href="#l5.3035"></a><span id="l5.3035"> }</span>
<a href="#l5.3036"></a><span id="l5.3036"> </span>
<a href="#l5.3037"></a><span id="l5.3037" class="difflineminus">-// this method first tries to find an exact username and hostname match with the given url</span>
<a href="#l5.3038"></a><span id="l5.3038" class="difflineminus">-// then, tries to find any account on the passed in imap host in case this is a url to</span>
<a href="#l5.3039"></a><span id="l5.3039" class="difflineminus">-// a shared imap folder.</span>
<a href="#l5.3040"></a><span id="l5.3040" class="difflineminus">-nsresult nsImapService::GetServerFromUrl(nsIImapUrl *aImapUrl, nsIMsgIncomingServer **aServer)</span>
<a href="#l5.3041"></a><span id="l5.3041" class="difflineminus">-{</span>
<a href="#l5.3042"></a><span id="l5.3042" class="difflineplus">+// this method first tries to find an exact username and hostname match with the</span>
<a href="#l5.3043"></a><span id="l5.3043" class="difflineplus">+// given url then, tries to find any account on the passed in imap host in case</span>
<a href="#l5.3044"></a><span id="l5.3044" class="difflineplus">+// this is a url to a shared imap folder.</span>
<a href="#l5.3045"></a><span id="l5.3045" class="difflineplus">+nsresult nsImapService::GetServerFromUrl(nsIImapUrl *aImapUrl,</span>
<a href="#l5.3046"></a><span id="l5.3046" class="difflineplus">+                                         nsIMsgIncomingServer **aServer) {</span>
<a href="#l5.3047"></a><span id="l5.3047">   nsresult rv;</span>
<a href="#l5.3048"></a><span id="l5.3048">   nsCString folderName;</span>
<a href="#l5.3049"></a><span id="l5.3049">   nsAutoCString userPass;</span>
<a href="#l5.3050"></a><span id="l5.3050">   nsAutoCString hostName;</span>
<a href="#l5.3051"></a><span id="l5.3051">   nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsUrl = do_QueryInterface(aImapUrl);</span>
<a href="#l5.3052"></a><span id="l5.3052"> </span>
<a href="#l5.3053"></a><span id="l5.3053">   // if we can't get a folder name out of the url then I think this is an error</span>
<a href="#l5.3054"></a><span id="l5.3054">   aImapUrl-&gt;CreateCanonicalSourceFolderPathString(getter_Copies(folderName));</span>
<a href="#l5.3055"></a><span id="l5.3055" class="difflineminus">-  if (folderName.IsEmpty())</span>
<a href="#l5.3056"></a><span id="l5.3056" class="difflineminus">-  {</span>
<a href="#l5.3057"></a><span id="l5.3057" class="difflineplus">+  if (folderName.IsEmpty()) {</span>
<a href="#l5.3058"></a><span id="l5.3058">     rv = mailnewsUrl-&gt;GetFileName(folderName);</span>
<a href="#l5.3059"></a><span id="l5.3059">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.3060"></a><span id="l5.3060">   }</span>
<a href="#l5.3061"></a><span id="l5.3061"> </span>
<a href="#l5.3062"></a><span id="l5.3062" class="difflineminus">-  nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager = do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l5.3063"></a><span id="l5.3063" class="difflineplus">+  nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l5.3064"></a><span id="l5.3064" class="difflineplus">+      do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l5.3065"></a><span id="l5.3065">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.3066"></a><span id="l5.3066"> </span>
<a href="#l5.3067"></a><span id="l5.3067">   rv = accountManager-&gt;FindServerByURI(mailnewsUrl, false, aServer);</span>
<a href="#l5.3068"></a><span id="l5.3068"> </span>
<a href="#l5.3069"></a><span id="l5.3069">   // look for server with any user name, in case we're trying to subscribe</span>
<a href="#l5.3070"></a><span id="l5.3070">   // to a folder with some one else's user name like the following</span>
<a href="#l5.3071"></a><span id="l5.3071">   // &quot;IMAP://userSharingFolder@server1/SharedFolderName&quot;</span>
<a href="#l5.3072"></a><span id="l5.3072" class="difflineminus">-  if (NS_FAILED(rv) || !aServer)</span>
<a href="#l5.3073"></a><span id="l5.3073" class="difflineminus">-  {</span>
<a href="#l5.3074"></a><span id="l5.3074" class="difflineplus">+  if (NS_FAILED(rv) || !aServer) {</span>
<a href="#l5.3075"></a><span id="l5.3075">     nsAutoCString turl;</span>
<a href="#l5.3076"></a><span id="l5.3076">     rv = mailnewsUrl-&gt;GetSpec(turl);</span>
<a href="#l5.3077"></a><span id="l5.3077">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.3078"></a><span id="l5.3078"> </span>
<a href="#l5.3079"></a><span id="l5.3079">     nsCOMPtr&lt;nsIURL&gt; url;</span>
<a href="#l5.3080"></a><span id="l5.3080">     rv = NS_MutateURI(NS_STANDARDURLMUTATOR_CONTRACTID)</span>
<a href="#l5.3081"></a><span id="l5.3081" class="difflineminus">-           .SetSpec(turl)</span>
<a href="#l5.3082"></a><span id="l5.3082" class="difflineminus">-           .SetUserPass(EmptyCString())</span>
<a href="#l5.3083"></a><span id="l5.3083" class="difflineminus">-           .Finalize(url);</span>
<a href="#l5.3084"></a><span id="l5.3084" class="difflineplus">+             .SetSpec(turl)</span>
<a href="#l5.3085"></a><span id="l5.3085" class="difflineplus">+             .SetUserPass(EmptyCString())</span>
<a href="#l5.3086"></a><span id="l5.3086" class="difflineplus">+             .Finalize(url);</span>
<a href="#l5.3087"></a><span id="l5.3087">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.3088"></a><span id="l5.3088"> </span>
<a href="#l5.3089"></a><span id="l5.3089">     rv = accountManager-&gt;FindServerByURI(url, false, aServer);</span>
<a href="#l5.3090"></a><span id="l5.3090" class="difflineminus">-    if (*aServer)</span>
<a href="#l5.3091"></a><span id="l5.3091" class="difflineminus">-      aImapUrl-&gt;SetExternalLinkUrl(true);</span>
<a href="#l5.3092"></a><span id="l5.3092" class="difflineplus">+    if (*aServer) aImapUrl-&gt;SetExternalLinkUrl(true);</span>
<a href="#l5.3093"></a><span id="l5.3093">   }</span>
<a href="#l5.3094"></a><span id="l5.3094"> </span>
<a href="#l5.3095"></a><span id="l5.3095" class="difflineminus">-    // if we can't extract the imap server from this url then give up!!!</span>
<a href="#l5.3096"></a><span id="l5.3096" class="difflineplus">+  // if we can't extract the imap server from this url then give up!!!</span>
<a href="#l5.3097"></a><span id="l5.3097">   NS_ENSURE_TRUE(*aServer, NS_ERROR_FAILURE);</span>
<a href="#l5.3098"></a><span id="l5.3098">   return rv;</span>
<a href="#l5.3099"></a><span id="l5.3099"> }</span>
<a href="#l5.3100"></a><span id="l5.3100"> </span>
<a href="#l5.3101"></a><span id="l5.3101"> NS_IMETHODIMP nsImapService::NewURI(const nsACString &amp;aSpec,</span>
<a href="#l5.3102"></a><span id="l5.3102">                                     const char *aOriginCharset,  // ignored</span>
<a href="#l5.3103"></a><span id="l5.3103" class="difflineminus">-                                    nsIURI *aBaseURI,</span>
<a href="#l5.3104"></a><span id="l5.3104" class="difflineminus">-                                    nsIURI **aRetVal)</span>
<a href="#l5.3105"></a><span id="l5.3105" class="difflineminus">-{</span>
<a href="#l5.3106"></a><span id="l5.3106" class="difflineplus">+                                    nsIURI *aBaseURI, nsIURI **aRetVal) {</span>
<a href="#l5.3107"></a><span id="l5.3107">   NS_ENSURE_ARG_POINTER(aRetVal);</span>
<a href="#l5.3108"></a><span id="l5.3108"> </span>
<a href="#l5.3109"></a><span id="l5.3109">   nsresult rv;</span>
<a href="#l5.3110"></a><span id="l5.3110">   nsCOMPtr&lt;nsIImapUrl&gt; aImapUrl = do_CreateInstance(kImapUrlCID, &amp;rv);</span>
<a href="#l5.3111"></a><span id="l5.3111">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.3112"></a><span id="l5.3112"> </span>
<a href="#l5.3113"></a><span id="l5.3113">   // now extract lots of fun information...</span>
<a href="#l5.3114"></a><span id="l5.3114">   nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsUrl = do_QueryInterface(aImapUrl);</span>
<a href="#l5.3115"></a><span id="l5.3115">   // nsAutoCString unescapedSpec(aSpec);</span>
<a href="#l5.3116"></a><span id="l5.3116">   // nsUnescape(unescapedSpec.BeginWriting());</span>
<a href="#l5.3117"></a><span id="l5.3117"> </span>
<a href="#l5.3118"></a><span id="l5.3118">   // set the spec</span>
<a href="#l5.3119"></a><span id="l5.3119" class="difflineminus">-  if (aBaseURI)</span>
<a href="#l5.3120"></a><span id="l5.3120" class="difflineminus">-  {</span>
<a href="#l5.3121"></a><span id="l5.3121" class="difflineplus">+  if (aBaseURI) {</span>
<a href="#l5.3122"></a><span id="l5.3122">     nsAutoCString newSpec;</span>
<a href="#l5.3123"></a><span id="l5.3123">     aBaseURI-&gt;Resolve(aSpec, newSpec);</span>
<a href="#l5.3124"></a><span id="l5.3124">     rv = mailnewsUrl-&gt;SetSpecInternal(newSpec);</span>
<a href="#l5.3125"></a><span id="l5.3125" class="difflineminus">-  }</span>
<a href="#l5.3126"></a><span id="l5.3126" class="difflineminus">-  else</span>
<a href="#l5.3127"></a><span id="l5.3127" class="difflineminus">-  {</span>
<a href="#l5.3128"></a><span id="l5.3128" class="difflineplus">+  } else {</span>
<a href="#l5.3129"></a><span id="l5.3129">     rv = mailnewsUrl-&gt;SetSpecInternal(aSpec);</span>
<a href="#l5.3130"></a><span id="l5.3130">   }</span>
<a href="#l5.3131"></a><span id="l5.3131"> </span>
<a href="#l5.3132"></a><span id="l5.3132">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.3133"></a><span id="l5.3133"> </span>
<a href="#l5.3134"></a><span id="l5.3134">   nsCString folderName;</span>
<a href="#l5.3135"></a><span id="l5.3135">   // if we can't get a folder name out of the url then I think this is an error</span>
<a href="#l5.3136"></a><span id="l5.3136">   aImapUrl-&gt;CreateCanonicalSourceFolderPathString(getter_Copies(folderName));</span>
<a href="#l5.3137"></a><span id="l5.3137" class="difflineminus">-  if (folderName.IsEmpty())</span>
<a href="#l5.3138"></a><span id="l5.3138" class="difflineminus">-  {</span>
<a href="#l5.3139"></a><span id="l5.3139" class="difflineplus">+  if (folderName.IsEmpty()) {</span>
<a href="#l5.3140"></a><span id="l5.3140">     rv = mailnewsUrl-&gt;GetFileName(folderName);</span>
<a href="#l5.3141"></a><span id="l5.3141">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.3142"></a><span id="l5.3142">   }</span>
<a href="#l5.3143"></a><span id="l5.3143"> </span>
<a href="#l5.3144"></a><span id="l5.3144">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l5.3145"></a><span id="l5.3145">   rv = GetServerFromUrl(aImapUrl, getter_AddRefs(server));</span>
<a href="#l5.3146"></a><span id="l5.3146">   // if we can't extract the imap server from this url then give up!!!</span>
<a href="#l5.3147"></a><span id="l5.3147">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.3148"></a><span id="l5.3148">   NS_ENSURE_TRUE(server, NS_ERROR_FAILURE);</span>
<a href="#l5.3149"></a><span id="l5.3149"> </span>
<a href="#l5.3150"></a><span id="l5.3150">   // now try to get the folder in question...</span>
<a href="#l5.3151"></a><span id="l5.3151">   nsCOMPtr&lt;nsIMsgFolder&gt; rootFolder;</span>
<a href="#l5.3152"></a><span id="l5.3152">   server-&gt;GetRootFolder(getter_AddRefs(rootFolder));</span>
<a href="#l5.3153"></a><span id="l5.3153" class="difflineminus">-  if (rootFolder &amp;&amp; !folderName.IsEmpty())</span>
<a href="#l5.3154"></a><span id="l5.3154" class="difflineminus">-  {</span>
<a href="#l5.3155"></a><span id="l5.3155" class="difflineplus">+  if (rootFolder &amp;&amp; !folderName.IsEmpty()) {</span>
<a href="#l5.3156"></a><span id="l5.3156">     nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l5.3157"></a><span id="l5.3157">     nsCOMPtr&lt;nsIMsgImapMailFolder&gt; imapRoot = do_QueryInterface(rootFolder);</span>
<a href="#l5.3158"></a><span id="l5.3158">     nsCOMPtr&lt;nsIMsgImapMailFolder&gt; subFolder;</span>
<a href="#l5.3159"></a><span id="l5.3159" class="difflineminus">-    if (imapRoot)</span>
<a href="#l5.3160"></a><span id="l5.3160" class="difflineminus">-    {</span>
<a href="#l5.3161"></a><span id="l5.3161" class="difflineplus">+    if (imapRoot) {</span>
<a href="#l5.3162"></a><span id="l5.3162">       imapRoot-&gt;FindOnlineSubFolder(folderName, getter_AddRefs(subFolder));</span>
<a href="#l5.3163"></a><span id="l5.3163">       folder = do_QueryInterface(subFolder);</span>
<a href="#l5.3164"></a><span id="l5.3164">     }</span>
<a href="#l5.3165"></a><span id="l5.3165"> </span>
<a href="#l5.3166"></a><span id="l5.3166">     // If we can't find the folder, we can still create the URI</span>
<a href="#l5.3167"></a><span id="l5.3167">     // in this low-level service. Cloning URIs where the folder</span>
<a href="#l5.3168"></a><span id="l5.3168">     // isn't found is common when folders are renamed or moved.</span>
<a href="#l5.3169"></a><span id="l5.3169">     // We also ignore return statuses here.</span>
<a href="#l5.3170"></a><span id="l5.3170" class="difflineminus">-    if (folder)</span>
<a href="#l5.3171"></a><span id="l5.3171" class="difflineminus">-    {</span>
<a href="#l5.3172"></a><span id="l5.3172" class="difflineplus">+    if (folder) {</span>
<a href="#l5.3173"></a><span id="l5.3173">       nsCOMPtr&lt;nsIImapMessageSink&gt; msgSink = do_QueryInterface(folder);</span>
<a href="#l5.3174"></a><span id="l5.3174" class="difflineminus">-      (void) aImapUrl-&gt;SetImapMessageSink(msgSink);</span>
<a href="#l5.3175"></a><span id="l5.3175" class="difflineminus">-</span>
<a href="#l5.3176"></a><span id="l5.3176" class="difflineminus">-      (void) SetImapUrlSink(folder, aImapUrl);</span>
<a href="#l5.3177"></a><span id="l5.3177" class="difflineplus">+      (void)aImapUrl-&gt;SetImapMessageSink(msgSink);</span>
<a href="#l5.3178"></a><span id="l5.3178" class="difflineplus">+</span>
<a href="#l5.3179"></a><span id="l5.3179" class="difflineplus">+      (void)SetImapUrlSink(folder, aImapUrl);</span>
<a href="#l5.3180"></a><span id="l5.3180"> </span>
<a href="#l5.3181"></a><span id="l5.3181">       nsCString messageIdString;</span>
<a href="#l5.3182"></a><span id="l5.3182">       aImapUrl-&gt;GetListOfMessageIds(messageIdString);</span>
<a href="#l5.3183"></a><span id="l5.3183" class="difflineminus">-      if (!messageIdString.IsEmpty())</span>
<a href="#l5.3184"></a><span id="l5.3184" class="difflineminus">-      {</span>
<a href="#l5.3185"></a><span id="l5.3185" class="difflineplus">+      if (!messageIdString.IsEmpty()) {</span>
<a href="#l5.3186"></a><span id="l5.3186">         bool useLocalCache = false;</span>
<a href="#l5.3187"></a><span id="l5.3187">         folder-&gt;HasMsgOffline(strtoul(messageIdString.get(), nullptr, 10),</span>
<a href="#l5.3188"></a><span id="l5.3188">                               &amp;useLocalCache);</span>
<a href="#l5.3189"></a><span id="l5.3189">         mailnewsUrl-&gt;SetMsgIsInLocalCache(useLocalCache);</span>
<a href="#l5.3190"></a><span id="l5.3190">       }</span>
<a href="#l5.3191"></a><span id="l5.3191">     }</span>
<a href="#l5.3192"></a><span id="l5.3192">   }</span>
<a href="#l5.3193"></a><span id="l5.3193"> </span>
<a href="#l5.3194"></a><span id="l5.3194">   // if we are fetching a part, be sure to enable fetch parts on demand</span>
<a href="#l5.3195"></a><span id="l5.3195">   bool mimePartSelectorDetected = false;</span>
<a href="#l5.3196"></a><span id="l5.3196">   aImapUrl-&gt;GetMimePartSelectorDetected(&amp;mimePartSelectorDetected);</span>
<a href="#l5.3197"></a><span id="l5.3197" class="difflineminus">-  if (mimePartSelectorDetected)</span>
<a href="#l5.3198"></a><span id="l5.3198" class="difflineminus">-    aImapUrl-&gt;SetFetchPartsOnDemand(true);</span>
<a href="#l5.3199"></a><span id="l5.3199" class="difflineplus">+  if (mimePartSelectorDetected) aImapUrl-&gt;SetFetchPartsOnDemand(true);</span>
<a href="#l5.3200"></a><span id="l5.3200"> </span>
<a href="#l5.3201"></a><span id="l5.3201">   // we got an imap url, so be sure to return it...</span>
<a href="#l5.3202"></a><span id="l5.3202">   nsCOMPtr&lt;nsIURI&gt; imapUri = do_QueryInterface(aImapUrl);</span>
<a href="#l5.3203"></a><span id="l5.3203"> </span>
<a href="#l5.3204"></a><span id="l5.3204">   imapUri.forget(aRetVal);</span>
<a href="#l5.3205"></a><span id="l5.3205"> </span>
<a href="#l5.3206"></a><span id="l5.3206">   return rv;</span>
<a href="#l5.3207"></a><span id="l5.3207"> }</span>
<a href="#l5.3208"></a><span id="l5.3208"> </span>
<a href="#l5.3209"></a><span id="l5.3209" class="difflineminus">-NS_IMETHODIMP nsImapService::NewChannel(nsIURI *aURI,</span>
<a href="#l5.3210"></a><span id="l5.3210" class="difflineminus">-                                        nsILoadInfo* aLoadInfo,</span>
<a href="#l5.3211"></a><span id="l5.3211" class="difflineminus">-                                        nsIChannel **aRetVal)</span>
<a href="#l5.3212"></a><span id="l5.3212" class="difflineminus">-{</span>
<a href="#l5.3213"></a><span id="l5.3213" class="difflineplus">+NS_IMETHODIMP nsImapService::NewChannel(nsIURI *aURI, nsILoadInfo *aLoadInfo,</span>
<a href="#l5.3214"></a><span id="l5.3214" class="difflineplus">+                                        nsIChannel **aRetVal) {</span>
<a href="#l5.3215"></a><span id="l5.3215">   NS_ENSURE_ARG_POINTER(aURI);</span>
<a href="#l5.3216"></a><span id="l5.3216">   NS_ENSURE_ARG_POINTER(aRetVal);</span>
<a href="#l5.3217"></a><span id="l5.3217">   *aRetVal = nullptr;</span>
<a href="#l5.3218"></a><span id="l5.3218"> </span>
<a href="#l5.3219"></a><span id="l5.3219">   nsresult rv;</span>
<a href="#l5.3220"></a><span id="l5.3220">   nsCOMPtr&lt;nsIImapUrl&gt; imapUrl = do_QueryInterface(aURI, &amp;rv);</span>
<a href="#l5.3221"></a><span id="l5.3221">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.3222"></a><span id="l5.3222" class="difflineminus">-  nsCOMPtr &lt;nsIMsgMailNewsUrl&gt; mailnewsUrl = do_QueryInterface(imapUrl, &amp;rv);</span>
<a href="#l5.3223"></a><span id="l5.3223" class="difflineplus">+  nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsUrl = do_QueryInterface(imapUrl, &amp;rv);</span>
<a href="#l5.3224"></a><span id="l5.3224">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.3225"></a><span id="l5.3225"> </span>
<a href="#l5.3226"></a><span id="l5.3226" class="difflineminus">-  // imap can't open and return a channel right away...the url needs to go in the imap url queue</span>
<a href="#l5.3227"></a><span id="l5.3227" class="difflineminus">-  // until we find a connection which can run the url..in order to satisfy necko, we're going to return</span>
<a href="#l5.3228"></a><span id="l5.3228" class="difflineminus">-  // a mock imap channel....</span>
<a href="#l5.3229"></a><span id="l5.3229" class="difflineminus">-  nsCOMPtr&lt;nsIImapMockChannel&gt; channel = do_CreateInstance(kCImapMockChannel, &amp;rv);</span>
<a href="#l5.3230"></a><span id="l5.3230" class="difflineplus">+  // imap can't open and return a channel right away...the url needs to go in</span>
<a href="#l5.3231"></a><span id="l5.3231" class="difflineplus">+  // the imap url queue until we find a connection which can run the url..in</span>
<a href="#l5.3232"></a><span id="l5.3232" class="difflineplus">+  // order to satisfy necko, we're going to return a mock imap channel....</span>
<a href="#l5.3233"></a><span id="l5.3233" class="difflineplus">+  nsCOMPtr&lt;nsIImapMockChannel&gt; channel =</span>
<a href="#l5.3234"></a><span id="l5.3234" class="difflineplus">+      do_CreateInstance(kCImapMockChannel, &amp;rv);</span>
<a href="#l5.3235"></a><span id="l5.3235">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.3236"></a><span id="l5.3236">   channel-&gt;SetURI(aURI);</span>
<a href="#l5.3237"></a><span id="l5.3237"> </span>
<a href="#l5.3238"></a><span id="l5.3238">   rv = channel-&gt;SetLoadInfo(aLoadInfo);</span>
<a href="#l5.3239"></a><span id="l5.3239">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.3240"></a><span id="l5.3240"> </span>
<a href="#l5.3241"></a><span id="l5.3241">   nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow;</span>
<a href="#l5.3242"></a><span id="l5.3242">   mailnewsUrl-&gt;GetMsgWindow(getter_AddRefs(msgWindow));</span>
<a href="#l5.3243"></a><span id="l5.3243" class="difflineminus">-  if (msgWindow)</span>
<a href="#l5.3244"></a><span id="l5.3244" class="difflineminus">-  {</span>
<a href="#l5.3245"></a><span id="l5.3245" class="difflineplus">+  if (msgWindow) {</span>
<a href="#l5.3246"></a><span id="l5.3246">     nsCOMPtr&lt;nsIDocShell&gt; msgDocShell;</span>
<a href="#l5.3247"></a><span id="l5.3247">     msgWindow-&gt;GetRootDocShell(getter_AddRefs(msgDocShell));</span>
<a href="#l5.3248"></a><span id="l5.3248" class="difflineminus">-    if (msgDocShell)</span>
<a href="#l5.3249"></a><span id="l5.3249" class="difflineminus">-    {</span>
<a href="#l5.3250"></a><span id="l5.3250" class="difflineminus">-      nsCOMPtr &lt;nsIProgressEventSink&gt; prevEventSink;</span>
<a href="#l5.3251"></a><span id="l5.3251" class="difflineplus">+    if (msgDocShell) {</span>
<a href="#l5.3252"></a><span id="l5.3252" class="difflineplus">+      nsCOMPtr&lt;nsIProgressEventSink&gt; prevEventSink;</span>
<a href="#l5.3253"></a><span id="l5.3253">       channel-&gt;GetProgressEventSink(getter_AddRefs(prevEventSink));</span>
<a href="#l5.3254"></a><span id="l5.3254">       nsCOMPtr&lt;nsIInterfaceRequestor&gt; docIR(do_QueryInterface(msgDocShell));</span>
<a href="#l5.3255"></a><span id="l5.3255">       channel-&gt;SetNotificationCallbacks(docIR);</span>
<a href="#l5.3256"></a><span id="l5.3256">       // we want to use our existing event sink.</span>
<a href="#l5.3257"></a><span id="l5.3257" class="difflineminus">-      if (prevEventSink)</span>
<a href="#l5.3258"></a><span id="l5.3258" class="difflineminus">-        channel-&gt;SetProgressEventSink(prevEventSink);</span>
<a href="#l5.3259"></a><span id="l5.3259" class="difflineplus">+      if (prevEventSink) channel-&gt;SetProgressEventSink(prevEventSink);</span>
<a href="#l5.3260"></a><span id="l5.3260">     }</span>
<a href="#l5.3261"></a><span id="l5.3261">   }</span>
<a href="#l5.3262"></a><span id="l5.3262" class="difflineminus">-  imapUrl-&gt;SetMockChannel(channel); // the imap url holds a weak reference so we can pass the channel into the imap protocol when we actually run the url</span>
<a href="#l5.3263"></a><span id="l5.3263" class="difflineplus">+  // the imap url holds a weak reference so we can pass the channel into the</span>
<a href="#l5.3264"></a><span id="l5.3264" class="difflineplus">+  // imap protocol when we actually run the url.</span>
<a href="#l5.3265"></a><span id="l5.3265" class="difflineplus">+  imapUrl-&gt;SetMockChannel(channel);</span>
<a href="#l5.3266"></a><span id="l5.3266"> </span>
<a href="#l5.3267"></a><span id="l5.3267">   bool externalLinkUrl;</span>
<a href="#l5.3268"></a><span id="l5.3268">   imapUrl-&gt;GetExternalLinkUrl(&amp;externalLinkUrl);</span>
<a href="#l5.3269"></a><span id="l5.3269" class="difflineminus">-  if (externalLinkUrl)</span>
<a href="#l5.3270"></a><span id="l5.3270" class="difflineminus">-  {</span>
<a href="#l5.3271"></a><span id="l5.3271" class="difflineminus">-    // everything after here is to handle clicking on an external link. We only want</span>
<a href="#l5.3272"></a><span id="l5.3272" class="difflineminus">-    // to do this if we didn't run the url through the various nsImapService methods,</span>
<a href="#l5.3273"></a><span id="l5.3273" class="difflineminus">-    // which we can tell by seeing if the sinks have been setup on the url or not.</span>
<a href="#l5.3274"></a><span id="l5.3274" class="difflineminus">-    nsCOMPtr &lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l5.3275"></a><span id="l5.3275" class="difflineplus">+  if (externalLinkUrl) {</span>
<a href="#l5.3276"></a><span id="l5.3276" class="difflineplus">+    // everything after here is to handle clicking on an external link. We only</span>
<a href="#l5.3277"></a><span id="l5.3277" class="difflineplus">+    // want to do this if we didn't run the url through the various</span>
<a href="#l5.3278"></a><span id="l5.3278" class="difflineplus">+    // nsImapService methods, which we can tell by seeing if the sinks have been</span>
<a href="#l5.3279"></a><span id="l5.3279" class="difflineplus">+    // setup on the url or not.</span>
<a href="#l5.3280"></a><span id="l5.3280" class="difflineplus">+    nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l5.3281"></a><span id="l5.3281">     rv = GetServerFromUrl(imapUrl, getter_AddRefs(server));</span>
<a href="#l5.3282"></a><span id="l5.3282">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.3283"></a><span id="l5.3283">     nsCString folderName;</span>
<a href="#l5.3284"></a><span id="l5.3284">     imapUrl-&gt;CreateCanonicalSourceFolderPathString(getter_Copies(folderName));</span>
<a href="#l5.3285"></a><span id="l5.3285" class="difflineminus">-    if (folderName.IsEmpty())</span>
<a href="#l5.3286"></a><span id="l5.3286" class="difflineminus">-    {</span>
<a href="#l5.3287"></a><span id="l5.3287" class="difflineplus">+    if (folderName.IsEmpty()) {</span>
<a href="#l5.3288"></a><span id="l5.3288">       nsCString escapedFolderName;</span>
<a href="#l5.3289"></a><span id="l5.3289">       rv = mailnewsUrl-&gt;GetFileName(escapedFolderName);</span>
<a href="#l5.3290"></a><span id="l5.3290">       if (!escapedFolderName.IsEmpty()) {</span>
<a href="#l5.3291"></a><span id="l5.3291">         MsgUnescapeString(escapedFolderName, 0, folderName);</span>
<a href="#l5.3292"></a><span id="l5.3292">       }</span>
<a href="#l5.3293"></a><span id="l5.3293">     }</span>
<a href="#l5.3294"></a><span id="l5.3294" class="difflineminus">-    // if the parent is null, then the folder doesn't really exist, so see if the user</span>
<a href="#l5.3295"></a><span id="l5.3295" class="difflineminus">-    // wants to subscribe to it./</span>
<a href="#l5.3296"></a><span id="l5.3296" class="difflineplus">+    // if the parent is null, then the folder doesn't really exist, so see if</span>
<a href="#l5.3297"></a><span id="l5.3297" class="difflineplus">+    // the user wants to subscribe to it./</span>
<a href="#l5.3298"></a><span id="l5.3298">     nsCOMPtr&lt;nsIMsgFolder&gt; aFolder;</span>
<a href="#l5.3299"></a><span id="l5.3299">     // now try to get the folder in question...</span>
<a href="#l5.3300"></a><span id="l5.3300">     nsCOMPtr&lt;nsIMsgFolder&gt; rootFolder;</span>
<a href="#l5.3301"></a><span id="l5.3301">     server-&gt;GetRootFolder(getter_AddRefs(rootFolder));</span>
<a href="#l5.3302"></a><span id="l5.3302" class="difflineminus">-    nsCOMPtr &lt;nsIMsgImapMailFolder&gt; imapRoot = do_QueryInterface(rootFolder);</span>
<a href="#l5.3303"></a><span id="l5.3303" class="difflineminus">-    nsCOMPtr &lt;nsIMsgImapMailFolder&gt; subFolder;</span>
<a href="#l5.3304"></a><span id="l5.3304" class="difflineminus">-    if (imapRoot)</span>
<a href="#l5.3305"></a><span id="l5.3305" class="difflineminus">-    {</span>
<a href="#l5.3306"></a><span id="l5.3306" class="difflineplus">+    nsCOMPtr&lt;nsIMsgImapMailFolder&gt; imapRoot = do_QueryInterface(rootFolder);</span>
<a href="#l5.3307"></a><span id="l5.3307" class="difflineplus">+    nsCOMPtr&lt;nsIMsgImapMailFolder&gt; subFolder;</span>
<a href="#l5.3308"></a><span id="l5.3308" class="difflineplus">+    if (imapRoot) {</span>
<a href="#l5.3309"></a><span id="l5.3309">       imapRoot-&gt;FindOnlineSubFolder(folderName, getter_AddRefs(subFolder));</span>
<a href="#l5.3310"></a><span id="l5.3310">       aFolder = do_QueryInterface(subFolder);</span>
<a href="#l5.3311"></a><span id="l5.3311">     }</span>
<a href="#l5.3312"></a><span id="l5.3312" class="difflineminus">-    nsCOMPtr &lt;nsIMsgFolder&gt; parent;</span>
<a href="#l5.3313"></a><span id="l5.3313" class="difflineminus">-    if (aFolder)</span>
<a href="#l5.3314"></a><span id="l5.3314" class="difflineminus">-      aFolder-&gt;GetParent(getter_AddRefs(parent));</span>
<a href="#l5.3315"></a><span id="l5.3315" class="difflineplus">+    nsCOMPtr&lt;nsIMsgFolder&gt; parent;</span>
<a href="#l5.3316"></a><span id="l5.3316" class="difflineplus">+    if (aFolder) aFolder-&gt;GetParent(getter_AddRefs(parent));</span>
<a href="#l5.3317"></a><span id="l5.3317">     nsCString serverKey;</span>
<a href="#l5.3318"></a><span id="l5.3318">     nsAutoCString userPass;</span>
<a href="#l5.3319"></a><span id="l5.3319">     rv = mailnewsUrl-&gt;GetUserPass(userPass);</span>
<a href="#l5.3320"></a><span id="l5.3320">     server-&gt;GetKey(serverKey);</span>
<a href="#l5.3321"></a><span id="l5.3321">     nsCString fullFolderName;</span>
<a href="#l5.3322"></a><span id="l5.3322" class="difflineminus">-    if (parent)</span>
<a href="#l5.3323"></a><span id="l5.3323" class="difflineminus">-      fullFolderName = folderName;</span>
<a href="#l5.3324"></a><span id="l5.3324" class="difflineminus">-    if (!parent &amp;&amp; !folderName.IsEmpty())  // check if this folder is another user's folder</span>
<a href="#l5.3325"></a><span id="l5.3325" class="difflineplus">+    if (parent) fullFolderName = folderName;</span>
<a href="#l5.3326"></a><span id="l5.3326" class="difflineplus">+    if (!parent &amp;&amp;</span>
<a href="#l5.3327"></a><span id="l5.3327" class="difflineplus">+        !folderName.IsEmpty())  // check if this folder is another user's folder</span>
<a href="#l5.3328"></a><span id="l5.3328">     {</span>
<a href="#l5.3329"></a><span id="l5.3329" class="difflineminus">-      fullFolderName = nsIMAPNamespaceList::GenerateFullFolderNameWithDefaultNamespace(serverKey.get(),</span>
<a href="#l5.3330"></a><span id="l5.3330" class="difflineminus">-                                                                                       folderName.get(),</span>
<a href="#l5.3331"></a><span id="l5.3331" class="difflineminus">-                                                                                       userPass.get(),</span>
<a href="#l5.3332"></a><span id="l5.3332" class="difflineminus">-                                                                                       kOtherUsersNamespace,</span>
<a href="#l5.3333"></a><span id="l5.3333" class="difflineminus">-                                                                                       nullptr);</span>
<a href="#l5.3334"></a><span id="l5.3334" class="difflineminus">-      // if this is another user's folder, let's see if we're already subscribed to it.</span>
<a href="#l5.3335"></a><span id="l5.3335" class="difflineminus">-      rv = imapRoot-&gt;FindOnlineSubFolder(fullFolderName, getter_AddRefs(subFolder));</span>
<a href="#l5.3336"></a><span id="l5.3336" class="difflineplus">+      fullFolderName =</span>
<a href="#l5.3337"></a><span id="l5.3337" class="difflineplus">+          nsIMAPNamespaceList::GenerateFullFolderNameWithDefaultNamespace(</span>
<a href="#l5.3338"></a><span id="l5.3338" class="difflineplus">+              serverKey.get(), folderName.get(), userPass.get(),</span>
<a href="#l5.3339"></a><span id="l5.3339" class="difflineplus">+              kOtherUsersNamespace, nullptr);</span>
<a href="#l5.3340"></a><span id="l5.3340" class="difflineplus">+      // if this is another user's folder, let's see if we're already subscribed</span>
<a href="#l5.3341"></a><span id="l5.3341" class="difflineplus">+      // to it.</span>
<a href="#l5.3342"></a><span id="l5.3342" class="difflineplus">+      rv = imapRoot-&gt;FindOnlineSubFolder(fullFolderName,</span>
<a href="#l5.3343"></a><span id="l5.3343" class="difflineplus">+                                         getter_AddRefs(subFolder));</span>
<a href="#l5.3344"></a><span id="l5.3344">       aFolder = do_QueryInterface(subFolder);</span>
<a href="#l5.3345"></a><span id="l5.3345" class="difflineminus">-      if (aFolder)</span>
<a href="#l5.3346"></a><span id="l5.3346" class="difflineminus">-        aFolder-&gt;GetParent(getter_AddRefs(parent));</span>
<a href="#l5.3347"></a><span id="l5.3347" class="difflineplus">+      if (aFolder) aFolder-&gt;GetParent(getter_AddRefs(parent));</span>
<a href="#l5.3348"></a><span id="l5.3348">     }</span>
<a href="#l5.3349"></a><span id="l5.3349">     // if we couldn't get the fullFolderName, then we probably couldn't find</span>
<a href="#l5.3350"></a><span id="l5.3350" class="difflineminus">-    // the other user's namespace, in which case, we shouldn't try to subscribe to it.</span>
<a href="#l5.3351"></a><span id="l5.3351" class="difflineminus">-    if (!parent &amp;&amp; !folderName.IsEmpty() &amp;&amp; !fullFolderName.IsEmpty())</span>
<a href="#l5.3352"></a><span id="l5.3352" class="difflineminus">-    {</span>
<a href="#l5.3353"></a><span id="l5.3353" class="difflineminus">-      // this folder doesn't exist - check if the user wants to subscribe to this folder.</span>
<a href="#l5.3354"></a><span id="l5.3354" class="difflineplus">+    // the other user's namespace, in which case, we shouldn't try to subscribe</span>
<a href="#l5.3355"></a><span id="l5.3355" class="difflineplus">+    // to it.</span>
<a href="#l5.3356"></a><span id="l5.3356" class="difflineplus">+    if (!parent &amp;&amp; !folderName.IsEmpty() &amp;&amp; !fullFolderName.IsEmpty()) {</span>
<a href="#l5.3357"></a><span id="l5.3357" class="difflineplus">+      // this folder doesn't exist - check if the user wants to subscribe to</span>
<a href="#l5.3358"></a><span id="l5.3358" class="difflineplus">+      // this folder.</span>
<a href="#l5.3359"></a><span id="l5.3359">       nsCOMPtr&lt;nsIPrompt&gt; dialog;</span>
<a href="#l5.3360"></a><span id="l5.3360" class="difflineminus">-      nsCOMPtr&lt;nsIWindowWatcher&gt; wwatch(do_GetService(NS_WINDOWWATCHER_CONTRACTID, &amp;rv));</span>
<a href="#l5.3361"></a><span id="l5.3361" class="difflineplus">+      nsCOMPtr&lt;nsIWindowWatcher&gt; wwatch(</span>
<a href="#l5.3362"></a><span id="l5.3362" class="difflineplus">+          do_GetService(NS_WINDOWWATCHER_CONTRACTID, &amp;rv));</span>
<a href="#l5.3363"></a><span id="l5.3363">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.3364"></a><span id="l5.3364">       wwatch-&gt;GetNewPrompter(nullptr, getter_AddRefs(dialog));</span>
<a href="#l5.3365"></a><span id="l5.3365"> </span>
<a href="#l5.3366"></a><span id="l5.3366">       nsString statusString, confirmText;</span>
<a href="#l5.3367"></a><span id="l5.3367">       nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l5.3368"></a><span id="l5.3368">       rv = IMAPGetStringBundle(getter_AddRefs(bundle));</span>
<a href="#l5.3369"></a><span id="l5.3369">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.3370"></a><span id="l5.3370" class="difflineminus">-        // need to convert folder name from mod-utf7 to unicode</span>
<a href="#l5.3371"></a><span id="l5.3371" class="difflineplus">+      // need to convert folder name from mod-utf7 to unicode</span>
<a href="#l5.3372"></a><span id="l5.3372">       nsAutoString unescapedName;</span>
<a href="#l5.3373"></a><span id="l5.3373">       if (NS_FAILED(CopyMUTF7toUTF16(fullFolderName, unescapedName)))</span>
<a href="#l5.3374"></a><span id="l5.3374">         CopyASCIItoUTF16(fullFolderName, unescapedName);</span>
<a href="#l5.3375"></a><span id="l5.3375" class="difflineminus">-      const char16_t *formatStrings[1] = { unescapedName.get() };</span>
<a href="#l5.3376"></a><span id="l5.3376" class="difflineminus">-</span>
<a href="#l5.3377"></a><span id="l5.3377" class="difflineminus">-      rv = bundle-&gt;FormatStringFromName(</span>
<a href="#l5.3378"></a><span id="l5.3378" class="difflineminus">-        &quot;imapSubscribePrompt&quot;,</span>
<a href="#l5.3379"></a><span id="l5.3379" class="difflineminus">-        formatStrings, 1, confirmText);</span>
<a href="#l5.3380"></a><span id="l5.3380" class="difflineminus">-      NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l5.3381"></a><span id="l5.3381" class="difflineplus">+      const char16_t *formatStrings[1] = {unescapedName.get()};</span>
<a href="#l5.3382"></a><span id="l5.3382" class="difflineplus">+</span>
<a href="#l5.3383"></a><span id="l5.3383" class="difflineplus">+      rv = bundle-&gt;FormatStringFromName(&quot;imapSubscribePrompt&quot;, formatStrings, 1,</span>
<a href="#l5.3384"></a><span id="l5.3384" class="difflineplus">+                                        confirmText);</span>
<a href="#l5.3385"></a><span id="l5.3385" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.3386"></a><span id="l5.3386"> </span>
<a href="#l5.3387"></a><span id="l5.3387">       bool confirmResult = false;</span>
<a href="#l5.3388"></a><span id="l5.3388">       rv = dialog-&gt;Confirm(nullptr, confirmText.get(), &amp;confirmResult);</span>
<a href="#l5.3389"></a><span id="l5.3389">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.3390"></a><span id="l5.3390"> </span>
<a href="#l5.3391"></a><span id="l5.3391" class="difflineminus">-      if (confirmResult)</span>
<a href="#l5.3392"></a><span id="l5.3392" class="difflineminus">-      {</span>
<a href="#l5.3393"></a><span id="l5.3393" class="difflineminus">-        nsCOMPtr &lt;nsIImapIncomingServer&gt; imapServer = do_QueryInterface(server);</span>
<a href="#l5.3394"></a><span id="l5.3394" class="difflineminus">-        if (imapServer)</span>
<a href="#l5.3395"></a><span id="l5.3395" class="difflineminus">-        {</span>
<a href="#l5.3396"></a><span id="l5.3396" class="difflineminus">-          nsCOMPtr &lt;nsIURI&gt; subscribeURI;</span>
<a href="#l5.3397"></a><span id="l5.3397" class="difflineminus">-          // now we have the real folder name to try to subscribe to. Let's try running</span>
<a href="#l5.3398"></a><span id="l5.3398" class="difflineminus">-          // a subscribe url and returning that as the uri we've created.</span>
<a href="#l5.3399"></a><span id="l5.3399" class="difflineminus">-          // We need to convert this to unicode because that's what subscribe wants :-(</span>
<a href="#l5.3400"></a><span id="l5.3400" class="difflineminus">-          // It's already in mod-utf7.</span>
<a href="#l5.3401"></a><span id="l5.3401" class="difflineplus">+      if (confirmResult) {</span>
<a href="#l5.3402"></a><span id="l5.3402" class="difflineplus">+        nsCOMPtr&lt;nsIImapIncomingServer&gt; imapServer = do_QueryInterface(server);</span>
<a href="#l5.3403"></a><span id="l5.3403" class="difflineplus">+        if (imapServer) {</span>
<a href="#l5.3404"></a><span id="l5.3404" class="difflineplus">+          nsCOMPtr&lt;nsIURI&gt; subscribeURI;</span>
<a href="#l5.3405"></a><span id="l5.3405" class="difflineplus">+          // now we have the real folder name to try to subscribe to. Let's try</span>
<a href="#l5.3406"></a><span id="l5.3406" class="difflineplus">+          // running a subscribe url and returning that as the uri we've</span>
<a href="#l5.3407"></a><span id="l5.3407" class="difflineplus">+          // created. We need to convert this to unicode because that's what</span>
<a href="#l5.3408"></a><span id="l5.3408" class="difflineplus">+          // subscribe wants :-( It's already in mod-utf7.</span>
<a href="#l5.3409"></a><span id="l5.3409">           nsAutoString unicodeName;</span>
<a href="#l5.3410"></a><span id="l5.3410">           CopyASCIItoUTF16(fullFolderName, unicodeName);</span>
<a href="#l5.3411"></a><span id="l5.3411" class="difflineminus">-          rv = imapServer-&gt;SubscribeToFolder(unicodeName, true, getter_AddRefs(subscribeURI));</span>
<a href="#l5.3412"></a><span id="l5.3412" class="difflineminus">-          if (NS_SUCCEEDED(rv) &amp;&amp; subscribeURI)</span>
<a href="#l5.3413"></a><span id="l5.3413" class="difflineminus">-          {</span>
<a href="#l5.3414"></a><span id="l5.3414" class="difflineminus">-            nsCOMPtr &lt;nsIImapUrl&gt; imapSubscribeUrl = do_QueryInterface(subscribeURI);</span>
<a href="#l5.3415"></a><span id="l5.3415" class="difflineminus">-            if (imapSubscribeUrl)</span>
<a href="#l5.3416"></a><span id="l5.3416" class="difflineminus">-              imapSubscribeUrl-&gt;SetExternalLinkUrl(true);</span>
<a href="#l5.3417"></a><span id="l5.3417" class="difflineminus">-            nsCOMPtr &lt;nsIMsgMailNewsUrl&gt; mailnewsUrl = do_QueryInterface(subscribeURI);</span>
<a href="#l5.3418"></a><span id="l5.3418" class="difflineminus">-            if (mailnewsUrl)</span>
<a href="#l5.3419"></a><span id="l5.3419" class="difflineminus">-            {</span>
<a href="#l5.3420"></a><span id="l5.3420" class="difflineminus">-              nsCOMPtr&lt;nsIMsgMailSession&gt; mailSession = do_GetService(NS_MSGMAILSESSION_CONTRACTID, &amp;rv);</span>
<a href="#l5.3421"></a><span id="l5.3421" class="difflineplus">+          rv = imapServer-&gt;SubscribeToFolder(unicodeName, true,</span>
<a href="#l5.3422"></a><span id="l5.3422" class="difflineplus">+                                             getter_AddRefs(subscribeURI));</span>
<a href="#l5.3423"></a><span id="l5.3423" class="difflineplus">+          if (NS_SUCCEEDED(rv) &amp;&amp; subscribeURI) {</span>
<a href="#l5.3424"></a><span id="l5.3424" class="difflineplus">+            nsCOMPtr&lt;nsIImapUrl&gt; imapSubscribeUrl =</span>
<a href="#l5.3425"></a><span id="l5.3425" class="difflineplus">+                do_QueryInterface(subscribeURI);</span>
<a href="#l5.3426"></a><span id="l5.3426" class="difflineplus">+            if (imapSubscribeUrl) imapSubscribeUrl-&gt;SetExternalLinkUrl(true);</span>
<a href="#l5.3427"></a><span id="l5.3427" class="difflineplus">+            nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsUrl =</span>
<a href="#l5.3428"></a><span id="l5.3428" class="difflineplus">+                do_QueryInterface(subscribeURI);</span>
<a href="#l5.3429"></a><span id="l5.3429" class="difflineplus">+            if (mailnewsUrl) {</span>
<a href="#l5.3430"></a><span id="l5.3430" class="difflineplus">+              nsCOMPtr&lt;nsIMsgMailSession&gt; mailSession =</span>
<a href="#l5.3431"></a><span id="l5.3431" class="difflineplus">+                  do_GetService(NS_MSGMAILSESSION_CONTRACTID, &amp;rv);</span>
<a href="#l5.3432"></a><span id="l5.3432">               NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.3433"></a><span id="l5.3433" class="difflineminus">-              nsCOMPtr &lt;nsIMsgWindow&gt; msgWindow;</span>
<a href="#l5.3434"></a><span id="l5.3434" class="difflineplus">+              nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow;</span>
<a href="#l5.3435"></a><span id="l5.3435">               rv = mailSession-&gt;GetTopmostMsgWindow(getter_AddRefs(msgWindow));</span>
<a href="#l5.3436"></a><span id="l5.3436" class="difflineminus">-              if (NS_SUCCEEDED(rv) &amp;&amp; msgWindow)</span>
<a href="#l5.3437"></a><span id="l5.3437" class="difflineminus">-              {</span>
<a href="#l5.3438"></a><span id="l5.3438" class="difflineplus">+              if (NS_SUCCEEDED(rv) &amp;&amp; msgWindow) {</span>
<a href="#l5.3439"></a><span id="l5.3439">                 mailnewsUrl-&gt;SetMsgWindow(msgWindow);</span>
<a href="#l5.3440"></a><span id="l5.3440" class="difflineminus">-                nsCOMPtr &lt;nsIUrlListener&gt; listener = do_QueryInterface(rootFolder);</span>
<a href="#l5.3441"></a><span id="l5.3441" class="difflineminus">-                if (listener)</span>
<a href="#l5.3442"></a><span id="l5.3442" class="difflineminus">-                  mailnewsUrl-&gt;RegisterListener(listener);</span>
<a href="#l5.3443"></a><span id="l5.3443" class="difflineplus">+                nsCOMPtr&lt;nsIUrlListener&gt; listener =</span>
<a href="#l5.3444"></a><span id="l5.3444" class="difflineplus">+                    do_QueryInterface(rootFolder);</span>
<a href="#l5.3445"></a><span id="l5.3445" class="difflineplus">+                if (listener) mailnewsUrl-&gt;RegisterListener(listener);</span>
<a href="#l5.3446"></a><span id="l5.3446">               }</span>
<a href="#l5.3447"></a><span id="l5.3447">             }</span>
<a href="#l5.3448"></a><span id="l5.3448">           }</span>
<a href="#l5.3449"></a><span id="l5.3449">         }</span>
<a href="#l5.3450"></a><span id="l5.3450">       }</span>
<a href="#l5.3451"></a><span id="l5.3451">       // error out this channel, so it'll stop trying to run the url.</span>
<a href="#l5.3452"></a><span id="l5.3452">       rv = NS_ERROR_FAILURE;</span>
<a href="#l5.3453"></a><span id="l5.3453">       *aRetVal = nullptr;</span>
<a href="#l5.3454"></a><span id="l5.3454">     }</span>
<a href="#l5.3455"></a><span id="l5.3455">     // this folder exists - check if this is a click on a link to the folder</span>
<a href="#l5.3456"></a><span id="l5.3456">     // in which case, we'll select it.</span>
<a href="#l5.3457"></a><span id="l5.3457" class="difflineminus">-    else if (!fullFolderName.IsEmpty())</span>
<a href="#l5.3458"></a><span id="l5.3458" class="difflineminus">-    {</span>
<a href="#l5.3459"></a><span id="l5.3459" class="difflineplus">+    else if (!fullFolderName.IsEmpty()) {</span>
<a href="#l5.3460"></a><span id="l5.3460">       nsCOMPtr&lt;nsIMsgFolder&gt; imapFolder;</span>
<a href="#l5.3461"></a><span id="l5.3461">       nsCOMPtr&lt;nsIImapServerSink&gt; serverSink;</span>
<a href="#l5.3462"></a><span id="l5.3462"> </span>
<a href="#l5.3463"></a><span id="l5.3463">       mailnewsUrl-&gt;GetFolder(getter_AddRefs(imapFolder));</span>
<a href="#l5.3464"></a><span id="l5.3464">       imapUrl-&gt;GetImapServerSink(getter_AddRefs(serverSink));</span>
<a href="#l5.3465"></a><span id="l5.3465" class="difflineminus">-      // need to see if this is a link click - one way is to check if the url is set up correctly</span>
<a href="#l5.3466"></a><span id="l5.3466" class="difflineminus">-      // if not, it's probably a url click. We need a better way of doing this.</span>
<a href="#l5.3467"></a><span id="l5.3467" class="difflineminus">-      if (!imapFolder)</span>
<a href="#l5.3468"></a><span id="l5.3468" class="difflineminus">-      {</span>
<a href="#l5.3469"></a><span id="l5.3469" class="difflineminus">-        nsCOMPtr&lt;nsIMsgMailSession&gt; mailSession = do_GetService(NS_MSGMAILSESSION_CONTRACTID, &amp;rv);</span>
<a href="#l5.3470"></a><span id="l5.3470" class="difflineplus">+      // need to see if this is a link click - one way is to check if the url is</span>
<a href="#l5.3471"></a><span id="l5.3471" class="difflineplus">+      // set up correctly if not, it's probably a url click. We need a better</span>
<a href="#l5.3472"></a><span id="l5.3472" class="difflineplus">+      // way of doing this.</span>
<a href="#l5.3473"></a><span id="l5.3473" class="difflineplus">+      if (!imapFolder) {</span>
<a href="#l5.3474"></a><span id="l5.3474" class="difflineplus">+        nsCOMPtr&lt;nsIMsgMailSession&gt; mailSession =</span>
<a href="#l5.3475"></a><span id="l5.3475" class="difflineplus">+            do_GetService(NS_MSGMAILSESSION_CONTRACTID, &amp;rv);</span>
<a href="#l5.3476"></a><span id="l5.3476">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.3477"></a><span id="l5.3477" class="difflineminus">-        nsCOMPtr &lt;nsIMsgWindow&gt; msgWindow;</span>
<a href="#l5.3478"></a><span id="l5.3478" class="difflineplus">+        nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow;</span>
<a href="#l5.3479"></a><span id="l5.3479">         rv = mailSession-&gt;GetTopmostMsgWindow(getter_AddRefs(msgWindow));</span>
<a href="#l5.3480"></a><span id="l5.3480" class="difflineminus">-        if (NS_SUCCEEDED(rv) &amp;&amp; msgWindow)</span>
<a href="#l5.3481"></a><span id="l5.3481" class="difflineminus">-        {</span>
<a href="#l5.3482"></a><span id="l5.3482" class="difflineplus">+        if (NS_SUCCEEDED(rv) &amp;&amp; msgWindow) {</span>
<a href="#l5.3483"></a><span id="l5.3483">           nsCString uri;</span>
<a href="#l5.3484"></a><span id="l5.3484">           rootFolder-&gt;GetURI(uri);</span>
<a href="#l5.3485"></a><span id="l5.3485">           uri.Append('/');</span>
<a href="#l5.3486"></a><span id="l5.3486">           uri.Append(fullFolderName);</span>
<a href="#l5.3487"></a><span id="l5.3487">           nsCOMPtr&lt;nsIMsgWindowCommands&gt; windowCommands;</span>
<a href="#l5.3488"></a><span id="l5.3488">           msgWindow-&gt;GetWindowCommands(getter_AddRefs(windowCommands));</span>
<a href="#l5.3489"></a><span id="l5.3489" class="difflineminus">-          if (windowCommands)</span>
<a href="#l5.3490"></a><span id="l5.3490" class="difflineminus">-            windowCommands-&gt;SelectFolder(uri);</span>
<a href="#l5.3491"></a><span id="l5.3491" class="difflineminus">-            // error out this channel, so it'll stop trying to run the url.</span>
<a href="#l5.3492"></a><span id="l5.3492" class="difflineplus">+          if (windowCommands) windowCommands-&gt;SelectFolder(uri);</span>
<a href="#l5.3493"></a><span id="l5.3493" class="difflineplus">+          // error out this channel, so it'll stop trying to run the url.</span>
<a href="#l5.3494"></a><span id="l5.3494">           *aRetVal = nullptr;</span>
<a href="#l5.3495"></a><span id="l5.3495">           rv = NS_ERROR_FAILURE;</span>
<a href="#l5.3496"></a><span id="l5.3496" class="difflineminus">-        }</span>
<a href="#l5.3497"></a><span id="l5.3497" class="difflineminus">-        else</span>
<a href="#l5.3498"></a><span id="l5.3498" class="difflineminus">-        {</span>
<a href="#l5.3499"></a><span id="l5.3499" class="difflineplus">+        } else {</span>
<a href="#l5.3500"></a><span id="l5.3500">           // make sure the imap action is selectFolder, so the content type</span>
<a href="#l5.3501"></a><span id="l5.3501">           // will be x-application-imapfolder, so ::HandleContent will</span>
<a href="#l5.3502"></a><span id="l5.3502">           // know to open a new 3 pane window.</span>
<a href="#l5.3503"></a><span id="l5.3503">           imapUrl-&gt;SetImapAction(nsIImapUrl::nsImapSelectFolder);</span>
<a href="#l5.3504"></a><span id="l5.3504">         }</span>
<a href="#l5.3505"></a><span id="l5.3505">       }</span>
<a href="#l5.3506"></a><span id="l5.3506">     }</span>
<a href="#l5.3507"></a><span id="l5.3507">   }</span>
<a href="#l5.3508"></a><span id="l5.3508" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l5.3509"></a><span id="l5.3509" class="difflineminus">-    channel.forget(aRetVal);</span>
<a href="#l5.3510"></a><span id="l5.3510" class="difflineplus">+  if (NS_SUCCEEDED(rv)) channel.forget(aRetVal);</span>
<a href="#l5.3511"></a><span id="l5.3511">   return rv;</span>
<a href="#l5.3512"></a><span id="l5.3512"> }</span>
<a href="#l5.3513"></a><span id="l5.3513"> </span>
<a href="#l5.3514"></a><span id="l5.3514" class="difflineminus">-NS_IMETHODIMP nsImapService::SetDefaultLocalPath(nsIFile *aPath)</span>
<a href="#l5.3515"></a><span id="l5.3515" class="difflineminus">-{</span>
<a href="#l5.3516"></a><span id="l5.3516" class="difflineplus">+NS_IMETHODIMP nsImapService::SetDefaultLocalPath(nsIFile *aPath) {</span>
<a href="#l5.3517"></a><span id="l5.3517">   NS_ENSURE_ARG_POINTER(aPath);</span>
<a href="#l5.3518"></a><span id="l5.3518"> </span>
<a href="#l5.3519"></a><span id="l5.3519" class="difflineminus">-  return NS_SetPersistentFile(PREF_MAIL_ROOT_IMAP_REL, PREF_MAIL_ROOT_IMAP, aPath);</span>
<a href="#l5.3520"></a><span id="l5.3520" class="difflineplus">+  return NS_SetPersistentFile(PREF_MAIL_ROOT_IMAP_REL, PREF_MAIL_ROOT_IMAP,</span>
<a href="#l5.3521"></a><span id="l5.3521" class="difflineplus">+                              aPath);</span>
<a href="#l5.3522"></a><span id="l5.3522"> }</span>
<a href="#l5.3523"></a><span id="l5.3523"> </span>
<a href="#l5.3524"></a><span id="l5.3524" class="difflineminus">-NS_IMETHODIMP nsImapService::GetDefaultLocalPath(nsIFile **aResult)</span>
<a href="#l5.3525"></a><span id="l5.3525" class="difflineminus">-{</span>
<a href="#l5.3526"></a><span id="l5.3526" class="difflineplus">+NS_IMETHODIMP nsImapService::GetDefaultLocalPath(nsIFile **aResult) {</span>
<a href="#l5.3527"></a><span id="l5.3527">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l5.3528"></a><span id="l5.3528">   *aResult = nullptr;</span>
<a href="#l5.3529"></a><span id="l5.3529"> </span>
<a href="#l5.3530"></a><span id="l5.3530">   bool havePref;</span>
<a href="#l5.3531"></a><span id="l5.3531">   nsCOMPtr&lt;nsIFile&gt; localFile;</span>
<a href="#l5.3532"></a><span id="l5.3532" class="difflineminus">-  nsresult rv = NS_GetPersistentFile(PREF_MAIL_ROOT_IMAP_REL,</span>
<a href="#l5.3533"></a><span id="l5.3533" class="difflineminus">-                                     PREF_MAIL_ROOT_IMAP,</span>
<a href="#l5.3534"></a><span id="l5.3534" class="difflineminus">-                                     NS_APP_IMAP_MAIL_50_DIR,</span>
<a href="#l5.3535"></a><span id="l5.3535" class="difflineminus">-                                     havePref,</span>
<a href="#l5.3536"></a><span id="l5.3536" class="difflineminus">-                                     getter_AddRefs(localFile));</span>
<a href="#l5.3537"></a><span id="l5.3537" class="difflineplus">+  nsresult rv = NS_GetPersistentFile(</span>
<a href="#l5.3538"></a><span id="l5.3538" class="difflineplus">+      PREF_MAIL_ROOT_IMAP_REL, PREF_MAIL_ROOT_IMAP, NS_APP_IMAP_MAIL_50_DIR,</span>
<a href="#l5.3539"></a><span id="l5.3539" class="difflineplus">+      havePref, getter_AddRefs(localFile));</span>
<a href="#l5.3540"></a><span id="l5.3540">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.3541"></a><span id="l5.3541">   NS_ENSURE_TRUE(localFile, NS_ERROR_FAILURE);</span>
<a href="#l5.3542"></a><span id="l5.3542"> </span>
<a href="#l5.3543"></a><span id="l5.3543">   bool exists;</span>
<a href="#l5.3544"></a><span id="l5.3544">   rv = localFile-&gt;Exists(&amp;exists);</span>
<a href="#l5.3545"></a><span id="l5.3545">   if (NS_SUCCEEDED(rv) &amp;&amp; !exists)</span>
<a href="#l5.3546"></a><span id="l5.3546">     rv = localFile-&gt;Create(nsIFile::DIRECTORY_TYPE, 0775);</span>
<a href="#l5.3547"></a><span id="l5.3547">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.3548"></a><span id="l5.3548"> </span>
<a href="#l5.3549"></a><span id="l5.3549" class="difflineminus">-  if (!havePref || !exists)</span>
<a href="#l5.3550"></a><span id="l5.3550" class="difflineminus">-  {</span>
<a href="#l5.3551"></a><span id="l5.3551" class="difflineminus">-    rv = NS_SetPersistentFile(PREF_MAIL_ROOT_IMAP_REL, PREF_MAIL_ROOT_IMAP, localFile);</span>
<a href="#l5.3552"></a><span id="l5.3552" class="difflineplus">+  if (!havePref || !exists) {</span>
<a href="#l5.3553"></a><span id="l5.3553" class="difflineplus">+    rv = NS_SetPersistentFile(PREF_MAIL_ROOT_IMAP_REL, PREF_MAIL_ROOT_IMAP,</span>
<a href="#l5.3554"></a><span id="l5.3554" class="difflineplus">+                              localFile);</span>
<a href="#l5.3555"></a><span id="l5.3555">     NS_ASSERTION(NS_SUCCEEDED(rv), &quot;Failed to set root dir pref.&quot;);</span>
<a href="#l5.3556"></a><span id="l5.3556">   }</span>
<a href="#l5.3557"></a><span id="l5.3557"> </span>
<a href="#l5.3558"></a><span id="l5.3558">   localFile.forget(aResult);</span>
<a href="#l5.3559"></a><span id="l5.3559">   return NS_OK;</span>
<a href="#l5.3560"></a><span id="l5.3560"> }</span>
<a href="#l5.3561"></a><span id="l5.3561"> </span>
<a href="#l5.3562"></a><span id="l5.3562" class="difflineminus">-NS_IMETHODIMP nsImapService::GetServerIID(nsIID **aServerIID)</span>
<a href="#l5.3563"></a><span id="l5.3563" class="difflineminus">-{</span>
<a href="#l5.3564"></a><span id="l5.3564" class="difflineplus">+NS_IMETHODIMP nsImapService::GetServerIID(nsIID **aServerIID) {</span>
<a href="#l5.3565"></a><span id="l5.3565">   *aServerIID = new nsIID(NS_GET_IID(nsIImapIncomingServer));</span>
<a href="#l5.3566"></a><span id="l5.3566">   return NS_OK;</span>
<a href="#l5.3567"></a><span id="l5.3567"> }</span>
<a href="#l5.3568"></a><span id="l5.3568"> </span>
<a href="#l5.3569"></a><span id="l5.3569" class="difflineminus">-NS_IMETHODIMP nsImapService::GetRequiresUsername(bool *aRequiresUsername)</span>
<a href="#l5.3570"></a><span id="l5.3570" class="difflineminus">-{</span>
<a href="#l5.3571"></a><span id="l5.3571" class="difflineplus">+NS_IMETHODIMP nsImapService::GetRequiresUsername(bool *aRequiresUsername) {</span>
<a href="#l5.3572"></a><span id="l5.3572">   NS_ENSURE_ARG_POINTER(aRequiresUsername);</span>
<a href="#l5.3573"></a><span id="l5.3573"> </span>
<a href="#l5.3574"></a><span id="l5.3574">   *aRequiresUsername = true;</span>
<a href="#l5.3575"></a><span id="l5.3575">   return NS_OK;</span>
<a href="#l5.3576"></a><span id="l5.3576"> }</span>
<a href="#l5.3577"></a><span id="l5.3577"> </span>
<a href="#l5.3578"></a><span id="l5.3578" class="difflineminus">-NS_IMETHODIMP nsImapService::GetPreflightPrettyNameWithEmailAddress(bool *aPreflightPrettyNameWithEmailAddress)</span>
<a href="#l5.3579"></a><span id="l5.3579" class="difflineminus">-{</span>
<a href="#l5.3580"></a><span id="l5.3580" class="difflineplus">+NS_IMETHODIMP nsImapService::GetPreflightPrettyNameWithEmailAddress(</span>
<a href="#l5.3581"></a><span id="l5.3581" class="difflineplus">+    bool *aPreflightPrettyNameWithEmailAddress) {</span>
<a href="#l5.3582"></a><span id="l5.3582">   NS_ENSURE_ARG_POINTER(aPreflightPrettyNameWithEmailAddress);</span>
<a href="#l5.3583"></a><span id="l5.3583"> </span>
<a href="#l5.3584"></a><span id="l5.3584">   *aPreflightPrettyNameWithEmailAddress = true;</span>
<a href="#l5.3585"></a><span id="l5.3585">   return NS_OK;</span>
<a href="#l5.3586"></a><span id="l5.3586"> }</span>
<a href="#l5.3587"></a><span id="l5.3587"> </span>
<a href="#l5.3588"></a><span id="l5.3588" class="difflineminus">-NS_IMETHODIMP nsImapService::GetCanLoginAtStartUp(bool *aCanLoginAtStartUp)</span>
<a href="#l5.3589"></a><span id="l5.3589" class="difflineminus">-{</span>
<a href="#l5.3590"></a><span id="l5.3590" class="difflineplus">+NS_IMETHODIMP nsImapService::GetCanLoginAtStartUp(bool *aCanLoginAtStartUp) {</span>
<a href="#l5.3591"></a><span id="l5.3591">   NS_ENSURE_ARG_POINTER(aCanLoginAtStartUp);</span>
<a href="#l5.3592"></a><span id="l5.3592">   *aCanLoginAtStartUp = true;</span>
<a href="#l5.3593"></a><span id="l5.3593">   return NS_OK;</span>
<a href="#l5.3594"></a><span id="l5.3594"> }</span>
<a href="#l5.3595"></a><span id="l5.3595"> </span>
<a href="#l5.3596"></a><span id="l5.3596" class="difflineminus">-NS_IMETHODIMP nsImapService::GetCanDelete(bool *aCanDelete)</span>
<a href="#l5.3597"></a><span id="l5.3597" class="difflineminus">-{</span>
<a href="#l5.3598"></a><span id="l5.3598" class="difflineplus">+NS_IMETHODIMP nsImapService::GetCanDelete(bool *aCanDelete) {</span>
<a href="#l5.3599"></a><span id="l5.3599">   NS_ENSURE_ARG_POINTER(aCanDelete);</span>
<a href="#l5.3600"></a><span id="l5.3600">   *aCanDelete = true;</span>
<a href="#l5.3601"></a><span id="l5.3601">   return NS_OK;</span>
<a href="#l5.3602"></a><span id="l5.3602"> }</span>
<a href="#l5.3603"></a><span id="l5.3603"> </span>
<a href="#l5.3604"></a><span id="l5.3604" class="difflineminus">-NS_IMETHODIMP nsImapService::GetCanDuplicate(bool *aCanDuplicate)</span>
<a href="#l5.3605"></a><span id="l5.3605" class="difflineminus">-{</span>
<a href="#l5.3606"></a><span id="l5.3606" class="difflineplus">+NS_IMETHODIMP nsImapService::GetCanDuplicate(bool *aCanDuplicate) {</span>
<a href="#l5.3607"></a><span id="l5.3607">   NS_ENSURE_ARG_POINTER(aCanDuplicate);</span>
<a href="#l5.3608"></a><span id="l5.3608">   *aCanDuplicate = true;</span>
<a href="#l5.3609"></a><span id="l5.3609">   return NS_OK;</span>
<a href="#l5.3610"></a><span id="l5.3610"> }</span>
<a href="#l5.3611"></a><span id="l5.3611"> </span>
<a href="#l5.3612"></a><span id="l5.3612" class="difflineminus">-NS_IMETHODIMP nsImapService::GetCanGetMessages(bool *aCanGetMessages)</span>
<a href="#l5.3613"></a><span id="l5.3613" class="difflineminus">-{</span>
<a href="#l5.3614"></a><span id="l5.3614" class="difflineplus">+NS_IMETHODIMP nsImapService::GetCanGetMessages(bool *aCanGetMessages) {</span>
<a href="#l5.3615"></a><span id="l5.3615">   NS_ENSURE_ARG_POINTER(aCanGetMessages);</span>
<a href="#l5.3616"></a><span id="l5.3616">   *aCanGetMessages = true;</span>
<a href="#l5.3617"></a><span id="l5.3617">   return NS_OK;</span>
<a href="#l5.3618"></a><span id="l5.3618"> }</span>
<a href="#l5.3619"></a><span id="l5.3619"> </span>
<a href="#l5.3620"></a><span id="l5.3620" class="difflineminus">-NS_IMETHODIMP nsImapService::GetCanGetIncomingMessages(bool *aCanGetIncomingMessages)</span>
<a href="#l5.3621"></a><span id="l5.3621" class="difflineminus">-{</span>
<a href="#l5.3622"></a><span id="l5.3622" class="difflineplus">+NS_IMETHODIMP nsImapService::GetCanGetIncomingMessages(</span>
<a href="#l5.3623"></a><span id="l5.3623" class="difflineplus">+    bool *aCanGetIncomingMessages) {</span>
<a href="#l5.3624"></a><span id="l5.3624">   NS_ENSURE_ARG_POINTER(aCanGetIncomingMessages);</span>
<a href="#l5.3625"></a><span id="l5.3625">   *aCanGetIncomingMessages = true;</span>
<a href="#l5.3626"></a><span id="l5.3626">   return NS_OK;</span>
<a href="#l5.3627"></a><span id="l5.3627"> }</span>
<a href="#l5.3628"></a><span id="l5.3628"> </span>
<a href="#l5.3629"></a><span id="l5.3629" class="difflineminus">-NS_IMETHODIMP nsImapService::GetShowComposeMsgLink(bool *showComposeMsgLink)</span>
<a href="#l5.3630"></a><span id="l5.3630" class="difflineminus">-{</span>
<a href="#l5.3631"></a><span id="l5.3631" class="difflineplus">+NS_IMETHODIMP nsImapService::GetShowComposeMsgLink(bool *showComposeMsgLink) {</span>
<a href="#l5.3632"></a><span id="l5.3632">   NS_ENSURE_ARG_POINTER(showComposeMsgLink);</span>
<a href="#l5.3633"></a><span id="l5.3633">   *showComposeMsgLink = true;</span>
<a href="#l5.3634"></a><span id="l5.3634">   return NS_OK;</span>
<a href="#l5.3635"></a><span id="l5.3635"> }</span>
<a href="#l5.3636"></a><span id="l5.3636"> </span>
<a href="#l5.3637"></a><span id="l5.3637" class="difflineminus">-NS_IMETHODIMP nsImapService::GetFoldersCreatedAsync(bool *aAsyncCreation)</span>
<a href="#l5.3638"></a><span id="l5.3638" class="difflineminus">-{</span>
<a href="#l5.3639"></a><span id="l5.3639" class="difflineplus">+NS_IMETHODIMP nsImapService::GetFoldersCreatedAsync(bool *aAsyncCreation) {</span>
<a href="#l5.3640"></a><span id="l5.3640">   NS_ENSURE_ARG_POINTER(aAsyncCreation);</span>
<a href="#l5.3641"></a><span id="l5.3641">   *aAsyncCreation = true;</span>
<a href="#l5.3642"></a><span id="l5.3642">   return NS_OK;</span>
<a href="#l5.3643"></a><span id="l5.3643"> }</span>
<a href="#l5.3644"></a><span id="l5.3644"> </span>
<a href="#l5.3645"></a><span id="l5.3645" class="difflineminus">-NS_IMETHODIMP nsImapService::GetListOfFoldersWithPath(nsIImapIncomingServer *aServer,</span>
<a href="#l5.3646"></a><span id="l5.3646" class="difflineminus">-                                                      nsIMsgWindow *aMsgWindow,</span>
<a href="#l5.3647"></a><span id="l5.3647" class="difflineminus">-                                                      const nsACString &amp;folderPath)</span>
<a href="#l5.3648"></a><span id="l5.3648" class="difflineminus">-{</span>
<a href="#l5.3649"></a><span id="l5.3649" class="difflineplus">+NS_IMETHODIMP nsImapService::GetListOfFoldersWithPath(</span>
<a href="#l5.3650"></a><span id="l5.3650" class="difflineplus">+    nsIImapIncomingServer *aServer, nsIMsgWindow *aMsgWindow,</span>
<a href="#l5.3651"></a><span id="l5.3651" class="difflineplus">+    const nsACString &amp;folderPath) {</span>
<a href="#l5.3652"></a><span id="l5.3652">   nsresult rv;</span>
<a href="#l5.3653"></a><span id="l5.3653">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server = do_QueryInterface(aServer);</span>
<a href="#l5.3654"></a><span id="l5.3654" class="difflineminus">-  if (!server)</span>
<a href="#l5.3655"></a><span id="l5.3655" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l5.3656"></a><span id="l5.3656" class="difflineplus">+  if (!server) return NS_ERROR_FAILURE;</span>
<a href="#l5.3657"></a><span id="l5.3657"> </span>
<a href="#l5.3658"></a><span id="l5.3658">   nsCOMPtr&lt;nsIMsgFolder&gt; rootMsgFolder;</span>
<a href="#l5.3659"></a><span id="l5.3659">   rv = server-&gt;GetRootMsgFolder(getter_AddRefs(rootMsgFolder));</span>
<a href="#l5.3660"></a><span id="l5.3660"> </span>
<a href="#l5.3661"></a><span id="l5.3661">   NS_ENSURE_TRUE(NS_SUCCEEDED(rv) &amp;&amp; rootMsgFolder, NS_ERROR_FAILURE);</span>
<a href="#l5.3662"></a><span id="l5.3662"> </span>
<a href="#l5.3663"></a><span id="l5.3663">   nsCOMPtr&lt;nsIUrlListener&gt; listener = do_QueryInterface(aServer, &amp;rv);</span>
<a href="#l5.3664"></a><span id="l5.3664">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.3665"></a><span id="l5.3665" class="difflineminus">-  if (!listener)</span>
<a href="#l5.3666"></a><span id="l5.3666" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l5.3667"></a><span id="l5.3667" class="difflineminus">-</span>
<a href="#l5.3668"></a><span id="l5.3668" class="difflineminus">-  // Locate the folder so that the correct hierarchical delimiter is used in the folder</span>
<a href="#l5.3669"></a><span id="l5.3669" class="difflineminus">-  // pathnames, otherwise root's (ie, '^') is used and this is wrong.</span>
<a href="#l5.3670"></a><span id="l5.3670" class="difflineplus">+  if (!listener) return NS_ERROR_FAILURE;</span>
<a href="#l5.3671"></a><span id="l5.3671" class="difflineplus">+</span>
<a href="#l5.3672"></a><span id="l5.3672" class="difflineplus">+  // Locate the folder so that the correct hierarchical delimiter is used in the</span>
<a href="#l5.3673"></a><span id="l5.3673" class="difflineplus">+  // folder pathnames, otherwise root's (ie, '^') is used and this is wrong.</span>
<a href="#l5.3674"></a><span id="l5.3674">   nsCOMPtr&lt;nsIMsgFolder&gt; msgFolder;</span>
<a href="#l5.3675"></a><span id="l5.3675" class="difflineminus">-  if (rootMsgFolder &amp;&amp; !folderPath.IsEmpty())</span>
<a href="#l5.3676"></a><span id="l5.3676" class="difflineminus">-  {</span>
<a href="#l5.3677"></a><span id="l5.3677" class="difflineminus">-    // If the folder path contains 'INBOX' of any forms, we need to convert it to uppercase</span>
<a href="#l5.3678"></a><span id="l5.3678" class="difflineminus">-    // before finding it under the root folder. We do the same in PossibleImapMailbox().</span>
<a href="#l5.3679"></a><span id="l5.3679" class="difflineplus">+  if (rootMsgFolder &amp;&amp; !folderPath.IsEmpty()) {</span>
<a href="#l5.3680"></a><span id="l5.3680" class="difflineplus">+    // If the folder path contains 'INBOX' of any forms, we need to convert it</span>
<a href="#l5.3681"></a><span id="l5.3681" class="difflineplus">+    // to uppercase before finding it under the root folder. We do the same in</span>
<a href="#l5.3682"></a><span id="l5.3682" class="difflineplus">+    // PossibleImapMailbox().</span>
<a href="#l5.3683"></a><span id="l5.3683">     nsAutoCString tempFolderName(folderPath);</span>
<a href="#l5.3684"></a><span id="l5.3684">     nsAutoCString tokenStr, remStr, changedStr;</span>
<a href="#l5.3685"></a><span id="l5.3685">     int32_t slashPos = tempFolderName.FindChar('/');</span>
<a href="#l5.3686"></a><span id="l5.3686" class="difflineminus">-    if (slashPos &gt; 0)</span>
<a href="#l5.3687"></a><span id="l5.3687" class="difflineminus">-    {</span>
<a href="#l5.3688"></a><span id="l5.3688" class="difflineplus">+    if (slashPos &gt; 0) {</span>
<a href="#l5.3689"></a><span id="l5.3689">       tokenStr = StringHead(tempFolderName, slashPos);</span>
<a href="#l5.3690"></a><span id="l5.3690">       remStr = Substring(tempFolderName, slashPos);</span>
<a href="#l5.3691"></a><span id="l5.3691" class="difflineminus">-    }</span>
<a href="#l5.3692"></a><span id="l5.3692" class="difflineminus">-    else</span>
<a href="#l5.3693"></a><span id="l5.3693" class="difflineplus">+    } else</span>
<a href="#l5.3694"></a><span id="l5.3694">       tokenStr.Assign(tempFolderName);</span>
<a href="#l5.3695"></a><span id="l5.3695"> </span>
<a href="#l5.3696"></a><span id="l5.3696">     if (tokenStr.LowerCaseEqualsLiteral(&quot;inbox&quot;) &amp;&amp;</span>
<a href="#l5.3697"></a><span id="l5.3697">         !tokenStr.EqualsLiteral(&quot;INBOX&quot;))</span>
<a href="#l5.3698"></a><span id="l5.3698">       changedStr.AppendLiteral(&quot;INBOX&quot;);</span>
<a href="#l5.3699"></a><span id="l5.3699">     else</span>
<a href="#l5.3700"></a><span id="l5.3700">       changedStr.Append(tokenStr);</span>
<a href="#l5.3701"></a><span id="l5.3701"> </span>
<a href="#l5.3702"></a><span id="l5.3702" class="difflineminus">-    if (slashPos &gt; 0 )</span>
<a href="#l5.3703"></a><span id="l5.3703" class="difflineminus">-      changedStr.Append(remStr);</span>
<a href="#l5.3704"></a><span id="l5.3704" class="difflineplus">+    if (slashPos &gt; 0) changedStr.Append(remStr);</span>
<a href="#l5.3705"></a><span id="l5.3705"> </span>
<a href="#l5.3706"></a><span id="l5.3706">     rv = rootMsgFolder-&gt;FindSubFolder(changedStr, getter_AddRefs(msgFolder));</span>
<a href="#l5.3707"></a><span id="l5.3707">   }</span>
<a href="#l5.3708"></a><span id="l5.3708">   return DiscoverChildren(msgFolder, listener, folderPath, nullptr);</span>
<a href="#l5.3709"></a><span id="l5.3709"> }</span>
<a href="#l5.3710"></a><span id="l5.3710"> </span>
<a href="#l5.3711"></a><span id="l5.3711" class="difflineminus">-NS_IMETHODIMP nsImapService::GetListOfFoldersOnServer(nsIImapIncomingServer *aServer,</span>
<a href="#l5.3712"></a><span id="l5.3712" class="difflineminus">-                                                      nsIMsgWindow *aMsgWindow)</span>
<a href="#l5.3713"></a><span id="l5.3713" class="difflineminus">-{</span>
<a href="#l5.3714"></a><span id="l5.3714" class="difflineplus">+NS_IMETHODIMP nsImapService::GetListOfFoldersOnServer(</span>
<a href="#l5.3715"></a><span id="l5.3715" class="difflineplus">+    nsIImapIncomingServer *aServer, nsIMsgWindow *aMsgWindow) {</span>
<a href="#l5.3716"></a><span id="l5.3716">   nsresult rv;</span>
<a href="#l5.3717"></a><span id="l5.3717"> </span>
<a href="#l5.3718"></a><span id="l5.3718">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server = do_QueryInterface(aServer);</span>
<a href="#l5.3719"></a><span id="l5.3719" class="difflineminus">-  if (!server)</span>
<a href="#l5.3720"></a><span id="l5.3720" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l5.3721"></a><span id="l5.3721" class="difflineplus">+  if (!server) return NS_ERROR_FAILURE;</span>
<a href="#l5.3722"></a><span id="l5.3722"> </span>
<a href="#l5.3723"></a><span id="l5.3723">   nsCOMPtr&lt;nsIMsgFolder&gt; rootMsgFolder;</span>
<a href="#l5.3724"></a><span id="l5.3724">   rv = server-&gt;GetRootMsgFolder(getter_AddRefs(rootMsgFolder));</span>
<a href="#l5.3725"></a><span id="l5.3725"> </span>
<a href="#l5.3726"></a><span id="l5.3726">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.3727"></a><span id="l5.3727" class="difflineminus">-  if (!rootMsgFolder)</span>
<a href="#l5.3728"></a><span id="l5.3728" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l5.3729"></a><span id="l5.3729" class="difflineplus">+  if (!rootMsgFolder) return NS_ERROR_FAILURE;</span>
<a href="#l5.3730"></a><span id="l5.3730"> </span>
<a href="#l5.3731"></a><span id="l5.3731">   nsCOMPtr&lt;nsIUrlListener&gt; listener = do_QueryInterface(aServer, &amp;rv);</span>
<a href="#l5.3732"></a><span id="l5.3732">   NS_ENSURE_TRUE(NS_SUCCEEDED(rv) &amp;&amp; listener, NS_ERROR_FAILURE);</span>
<a href="#l5.3733"></a><span id="l5.3733"> </span>
<a href="#l5.3734"></a><span id="l5.3734">   return DiscoverAllAndSubscribedFolders(rootMsgFolder, listener, nullptr);</span>
<a href="#l5.3735"></a><span id="l5.3735"> }</span>
<a href="#l5.3736"></a><span id="l5.3736"> </span>
<a href="#l5.3737"></a><span id="l5.3737"> NS_IMETHODIMP nsImapService::SubscribeFolder(nsIMsgFolder *aFolder,</span>
<a href="#l5.3738"></a><span id="l5.3738">                                              const nsAString &amp;aFolderName,</span>
<a href="#l5.3739"></a><span id="l5.3739">                                              nsIUrlListener *urlListener,</span>
<a href="#l5.3740"></a><span id="l5.3740" class="difflineminus">-                                             nsIURI **url)</span>
<a href="#l5.3741"></a><span id="l5.3741" class="difflineminus">-{</span>
<a href="#l5.3742"></a><span id="l5.3742" class="difflineminus">-</span>
<a href="#l5.3743"></a><span id="l5.3743" class="difflineminus">-  return ChangeFolderSubscription(aFolder, aFolderName,</span>
<a href="#l5.3744"></a><span id="l5.3744" class="difflineminus">-                                  &quot;/subscribe&gt;&quot;, urlListener, url);</span>
<a href="#l5.3745"></a><span id="l5.3745" class="difflineplus">+                                             nsIURI **url) {</span>
<a href="#l5.3746"></a><span id="l5.3746" class="difflineplus">+  return ChangeFolderSubscription(aFolder, aFolderName, &quot;/subscribe&gt;&quot;,</span>
<a href="#l5.3747"></a><span id="l5.3747" class="difflineplus">+                                  urlListener, url);</span>
<a href="#l5.3748"></a><span id="l5.3748"> }</span>
<a href="#l5.3749"></a><span id="l5.3749"> </span>
<a href="#l5.3750"></a><span id="l5.3750"> nsresult nsImapService::ChangeFolderSubscription(nsIMsgFolder *folder,</span>
<a href="#l5.3751"></a><span id="l5.3751">                                                  const nsAString &amp;folderName,</span>
<a href="#l5.3752"></a><span id="l5.3752">                                                  const char *command,</span>
<a href="#l5.3753"></a><span id="l5.3753">                                                  nsIUrlListener *urlListener,</span>
<a href="#l5.3754"></a><span id="l5.3754" class="difflineminus">-                                                 nsIURI **url)</span>
<a href="#l5.3755"></a><span id="l5.3755" class="difflineminus">-{</span>
<a href="#l5.3756"></a><span id="l5.3756" class="difflineplus">+                                                 nsIURI **url) {</span>
<a href="#l5.3757"></a><span id="l5.3757">   NS_ENSURE_ARG_POINTER(folder);</span>
<a href="#l5.3758"></a><span id="l5.3758"> </span>
<a href="#l5.3759"></a><span id="l5.3759">   nsCOMPtr&lt;nsIImapUrl&gt; imapUrl;</span>
<a href="#l5.3760"></a><span id="l5.3760">   nsAutoCString urlSpec;</span>
<a href="#l5.3761"></a><span id="l5.3761">   nsresult rv;</span>
<a href="#l5.3762"></a><span id="l5.3762">   char hierarchyDelimiter = GetHierarchyDelimiter(folder);</span>
<a href="#l5.3763"></a><span id="l5.3763" class="difflineminus">-  rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(imapUrl), folder, urlListener,</span>
<a href="#l5.3764"></a><span id="l5.3764" class="difflineminus">-                            urlSpec, hierarchyDelimiter);</span>
<a href="#l5.3765"></a><span id="l5.3765" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; imapUrl)</span>
<a href="#l5.3766"></a><span id="l5.3766" class="difflineminus">-  {</span>
<a href="#l5.3767"></a><span id="l5.3767" class="difflineplus">+  rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(imapUrl), folder,</span>
<a href="#l5.3768"></a><span id="l5.3768" class="difflineplus">+                            urlListener, urlSpec, hierarchyDelimiter);</span>
<a href="#l5.3769"></a><span id="l5.3769" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; imapUrl) {</span>
<a href="#l5.3770"></a><span id="l5.3770">     rv = SetImapUrlSink(folder, imapUrl);</span>
<a href="#l5.3771"></a><span id="l5.3771" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l5.3772"></a><span id="l5.3772" class="difflineminus">-    {</span>
<a href="#l5.3773"></a><span id="l5.3773" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l5.3774"></a><span id="l5.3774">       nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsurl = do_QueryInterface(imapUrl);</span>
<a href="#l5.3775"></a><span id="l5.3775">       urlSpec.Append(command);</span>
<a href="#l5.3776"></a><span id="l5.3776">       urlSpec.Append(hierarchyDelimiter);</span>
<a href="#l5.3777"></a><span id="l5.3777">       nsAutoCString utfFolderName;</span>
<a href="#l5.3778"></a><span id="l5.3778">       rv = CopyUTF16toMUTF7(PromiseFlatString(folderName), utfFolderName);</span>
<a href="#l5.3779"></a><span id="l5.3779">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.3780"></a><span id="l5.3780">       nsCString escapedFolderName;</span>
<a href="#l5.3781"></a><span id="l5.3781" class="difflineminus">-      MsgEscapeString(utfFolderName, nsINetUtil::ESCAPE_URL_PATH, escapedFolderName);</span>
<a href="#l5.3782"></a><span id="l5.3782" class="difflineplus">+      MsgEscapeString(utfFolderName, nsINetUtil::ESCAPE_URL_PATH,</span>
<a href="#l5.3783"></a><span id="l5.3783" class="difflineplus">+                      escapedFolderName);</span>
<a href="#l5.3784"></a><span id="l5.3784">       urlSpec.Append(escapedFolderName);</span>
<a href="#l5.3785"></a><span id="l5.3785">       rv = mailnewsurl-&gt;SetSpecInternal(urlSpec);</span>
<a href="#l5.3786"></a><span id="l5.3786">       if (NS_SUCCEEDED(rv))</span>
<a href="#l5.3787"></a><span id="l5.3787">         rv = GetImapConnectionAndLoadUrl(imapUrl, nullptr, url);</span>
<a href="#l5.3788"></a><span id="l5.3788">     }</span>
<a href="#l5.3789"></a><span id="l5.3789">   }</span>
<a href="#l5.3790"></a><span id="l5.3790">   return rv;</span>
<a href="#l5.3791"></a><span id="l5.3791"> }</span>
<a href="#l5.3792"></a><span id="l5.3792"> </span>
<a href="#l5.3793"></a><span id="l5.3793"> NS_IMETHODIMP nsImapService::UnsubscribeFolder(nsIMsgFolder *aFolder,</span>
<a href="#l5.3794"></a><span id="l5.3794">                                                const nsAString &amp;aFolderName,</span>
<a href="#l5.3795"></a><span id="l5.3795">                                                nsIUrlListener *aUrlListener,</span>
<a href="#l5.3796"></a><span id="l5.3796" class="difflineminus">-                                               nsIURI **aUrl)</span>
<a href="#l5.3797"></a><span id="l5.3797" class="difflineminus">-{</span>
<a href="#l5.3798"></a><span id="l5.3798" class="difflineminus">-</span>
<a href="#l5.3799"></a><span id="l5.3799" class="difflineminus">-  return ChangeFolderSubscription(aFolder, aFolderName,</span>
<a href="#l5.3800"></a><span id="l5.3800" class="difflineminus">-                                  &quot;/unsubscribe&gt;&quot;, aUrlListener, aUrl);</span>
<a href="#l5.3801"></a><span id="l5.3801" class="difflineplus">+                                               nsIURI **aUrl) {</span>
<a href="#l5.3802"></a><span id="l5.3802" class="difflineplus">+  return ChangeFolderSubscription(aFolder, aFolderName, &quot;/unsubscribe&gt;&quot;,</span>
<a href="#l5.3803"></a><span id="l5.3803" class="difflineplus">+                                  aUrlListener, aUrl);</span>
<a href="#l5.3804"></a><span id="l5.3804"> }</span>
<a href="#l5.3805"></a><span id="l5.3805"> </span>
<a href="#l5.3806"></a><span id="l5.3806"> NS_IMETHODIMP nsImapService::GetFolderAdminUrl(nsIMsgFolder *aImapMailFolder,</span>
<a href="#l5.3807"></a><span id="l5.3807">                                                nsIMsgWindow *aMsgWindow,</span>
<a href="#l5.3808"></a><span id="l5.3808">                                                nsIUrlListener *aUrlListener,</span>
<a href="#l5.3809"></a><span id="l5.3809" class="difflineminus">-                                               nsIURI **aURL)</span>
<a href="#l5.3810"></a><span id="l5.3810" class="difflineminus">-{</span>
<a href="#l5.3811"></a><span id="l5.3811" class="difflineplus">+                                               nsIURI **aURL) {</span>
<a href="#l5.3812"></a><span id="l5.3812">   NS_ENSURE_ARG_POINTER(aImapMailFolder);</span>
<a href="#l5.3813"></a><span id="l5.3813"> </span>
<a href="#l5.3814"></a><span id="l5.3814" class="difflineminus">-  return FolderCommand(aImapMailFolder, aUrlListener,</span>
<a href="#l5.3815"></a><span id="l5.3815" class="difflineminus">-                       &quot;/refreshfolderurls&gt;&quot;, nsIImapUrl::nsImapRefreshFolderUrls, aMsgWindow, aURL);</span>
<a href="#l5.3816"></a><span id="l5.3816" class="difflineplus">+  return FolderCommand(aImapMailFolder, aUrlListener, &quot;/refreshfolderurls&gt;&quot;,</span>
<a href="#l5.3817"></a><span id="l5.3817" class="difflineplus">+                       nsIImapUrl::nsImapRefreshFolderUrls, aMsgWindow, aURL);</span>
<a href="#l5.3818"></a><span id="l5.3818"> }</span>
<a href="#l5.3819"></a><span id="l5.3819"> </span>
<a href="#l5.3820"></a><span id="l5.3820"> NS_IMETHODIMP nsImapService::IssueCommandOnMsgs(nsIMsgFolder *anImapFolder,</span>
<a href="#l5.3821"></a><span id="l5.3821">                                                 nsIMsgWindow *aMsgWindow,</span>
<a href="#l5.3822"></a><span id="l5.3822">                                                 const nsACString &amp;aCommand,</span>
<a href="#l5.3823"></a><span id="l5.3823">                                                 const nsACString &amp;uids,</span>
<a href="#l5.3824"></a><span id="l5.3824" class="difflineminus">-                                                nsIURI **aURL)</span>
<a href="#l5.3825"></a><span id="l5.3825" class="difflineminus">-{</span>
<a href="#l5.3826"></a><span id="l5.3826" class="difflineplus">+                                                nsIURI **aURL) {</span>
<a href="#l5.3827"></a><span id="l5.3827">   NS_ENSURE_ARG_POINTER(anImapFolder);</span>
<a href="#l5.3828"></a><span id="l5.3828">   NS_ENSURE_ARG_POINTER(aMsgWindow);</span>
<a href="#l5.3829"></a><span id="l5.3829"> </span>
<a href="#l5.3830"></a><span id="l5.3830">   nsCOMPtr&lt;nsIImapUrl&gt; imapUrl;</span>
<a href="#l5.3831"></a><span id="l5.3831">   nsAutoCString urlSpec;</span>
<a href="#l5.3832"></a><span id="l5.3832">   nsresult rv;</span>
<a href="#l5.3833"></a><span id="l5.3833">   char hierarchyDelimiter = GetHierarchyDelimiter(anImapFolder);</span>
<a href="#l5.3834"></a><span id="l5.3834" class="difflineminus">-  rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(imapUrl), anImapFolder, nullptr, urlSpec, hierarchyDelimiter);</span>
<a href="#l5.3835"></a><span id="l5.3835" class="difflineminus">-</span>
<a href="#l5.3836"></a><span id="l5.3836" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; imapUrl)</span>
<a href="#l5.3837"></a><span id="l5.3837" class="difflineminus">-  {</span>
<a href="#l5.3838"></a><span id="l5.3838" class="difflineplus">+  rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(imapUrl),</span>
<a href="#l5.3839"></a><span id="l5.3839" class="difflineplus">+                            anImapFolder, nullptr, urlSpec, hierarchyDelimiter);</span>
<a href="#l5.3840"></a><span id="l5.3840" class="difflineplus">+</span>
<a href="#l5.3841"></a><span id="l5.3841" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; imapUrl) {</span>
<a href="#l5.3842"></a><span id="l5.3842">     // nsImapUrl::SetSpec() will set the imap action properly</span>
<a href="#l5.3843"></a><span id="l5.3843">     rv = imapUrl-&gt;SetImapAction(nsIImapUrl::nsImapUserDefinedMsgCommand);</span>
<a href="#l5.3844"></a><span id="l5.3844"> </span>
<a href="#l5.3845"></a><span id="l5.3845" class="difflineminus">-    nsCOMPtr &lt;nsIMsgMailNewsUrl&gt; mailNewsUrl = do_QueryInterface(imapUrl);</span>
<a href="#l5.3846"></a><span id="l5.3846" class="difflineplus">+    nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailNewsUrl = do_QueryInterface(imapUrl);</span>
<a href="#l5.3847"></a><span id="l5.3847">     mailNewsUrl-&gt;SetMsgWindow(aMsgWindow);</span>
<a href="#l5.3848"></a><span id="l5.3848">     mailNewsUrl-&gt;SetUpdatingFolder(true);</span>
<a href="#l5.3849"></a><span id="l5.3849">     rv = SetImapUrlSink(anImapFolder, imapUrl);</span>
<a href="#l5.3850"></a><span id="l5.3850"> </span>
<a href="#l5.3851"></a><span id="l5.3851" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l5.3852"></a><span id="l5.3852" class="difflineminus">-    {</span>
<a href="#l5.3853"></a><span id="l5.3853" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l5.3854"></a><span id="l5.3854">       nsCString folderName;</span>
<a href="#l5.3855"></a><span id="l5.3855">       GetFolderName(anImapFolder, folderName);</span>
<a href="#l5.3856"></a><span id="l5.3856">       urlSpec.Append('/');</span>
<a href="#l5.3857"></a><span id="l5.3857">       urlSpec.Append(aCommand);</span>
<a href="#l5.3858"></a><span id="l5.3858">       urlSpec.Append('&gt;');</span>
<a href="#l5.3859"></a><span id="l5.3859">       urlSpec.Append(uidString);</span>
<a href="#l5.3860"></a><span id="l5.3860">       urlSpec.Append('&gt;');</span>
<a href="#l5.3861"></a><span id="l5.3861">       urlSpec.Append(hierarchyDelimiter);</span>
<a href="#l5.3862"></a><span id="l5.3862">       urlSpec.Append(folderName);</span>
<a href="#l5.3863"></a><span id="l5.3863">       urlSpec.Append('&gt;');</span>
<a href="#l5.3864"></a><span id="l5.3864">       urlSpec.Append(uids);</span>
<a href="#l5.3865"></a><span id="l5.3865">       rv = mailNewsUrl-&gt;SetSpecInternal(urlSpec);</span>
<a href="#l5.3866"></a><span id="l5.3866">       if (NS_SUCCEEDED(rv))</span>
<a href="#l5.3867"></a><span id="l5.3867">         rv = GetImapConnectionAndLoadUrl(imapUrl, nullptr, aURL);</span>
<a href="#l5.3868"></a><span id="l5.3868">     }</span>
<a href="#l5.3869"></a><span id="l5.3869" class="difflineminus">-  } // if we have a url to run....</span>
<a href="#l5.3870"></a><span id="l5.3870" class="difflineplus">+  }  // if we have a url to run....</span>
<a href="#l5.3871"></a><span id="l5.3871"> </span>
<a href="#l5.3872"></a><span id="l5.3872">   return rv;</span>
<a href="#l5.3873"></a><span id="l5.3873"> }</span>
<a href="#l5.3874"></a><span id="l5.3874"> </span>
<a href="#l5.3875"></a><span id="l5.3875" class="difflineminus">-NS_IMETHODIMP nsImapService::FetchCustomMsgAttribute(nsIMsgFolder *anImapFolder,</span>
<a href="#l5.3876"></a><span id="l5.3876" class="difflineminus">-                                                     nsIMsgWindow *aMsgWindow,</span>
<a href="#l5.3877"></a><span id="l5.3877" class="difflineminus">-                                                     const nsACString &amp;aAttribute,</span>
<a href="#l5.3878"></a><span id="l5.3878" class="difflineminus">-                                                     const nsACString &amp;uids,</span>
<a href="#l5.3879"></a><span id="l5.3879" class="difflineminus">-                                                     nsIURI **aURL)</span>
<a href="#l5.3880"></a><span id="l5.3880" class="difflineminus">-{</span>
<a href="#l5.3881"></a><span id="l5.3881" class="difflineplus">+NS_IMETHODIMP nsImapService::FetchCustomMsgAttribute(</span>
<a href="#l5.3882"></a><span id="l5.3882" class="difflineplus">+    nsIMsgFolder *anImapFolder, nsIMsgWindow *aMsgWindow,</span>
<a href="#l5.3883"></a><span id="l5.3883" class="difflineplus">+    const nsACString &amp;aAttribute, const nsACString &amp;uids, nsIURI **aURL) {</span>
<a href="#l5.3884"></a><span id="l5.3884">   NS_ENSURE_ARG_POINTER(anImapFolder);</span>
<a href="#l5.3885"></a><span id="l5.3885">   NS_ENSURE_ARG_POINTER(aMsgWindow);</span>
<a href="#l5.3886"></a><span id="l5.3886"> </span>
<a href="#l5.3887"></a><span id="l5.3887">   nsCOMPtr&lt;nsIImapUrl&gt; imapUrl;</span>
<a href="#l5.3888"></a><span id="l5.3888">   nsAutoCString urlSpec;</span>
<a href="#l5.3889"></a><span id="l5.3889">   nsresult rv;</span>
<a href="#l5.3890"></a><span id="l5.3890">   char hierarchyDelimiter = GetHierarchyDelimiter(anImapFolder);</span>
<a href="#l5.3891"></a><span id="l5.3891" class="difflineminus">-  rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(imapUrl), anImapFolder,</span>
<a href="#l5.3892"></a><span id="l5.3892" class="difflineminus">-                            nullptr, urlSpec, hierarchyDelimiter);</span>
<a href="#l5.3893"></a><span id="l5.3893" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; imapUrl)</span>
<a href="#l5.3894"></a><span id="l5.3894" class="difflineminus">-  {</span>
<a href="#l5.3895"></a><span id="l5.3895" class="difflineplus">+  rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(imapUrl),</span>
<a href="#l5.3896"></a><span id="l5.3896" class="difflineplus">+                            anImapFolder, nullptr, urlSpec, hierarchyDelimiter);</span>
<a href="#l5.3897"></a><span id="l5.3897" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; imapUrl) {</span>
<a href="#l5.3898"></a><span id="l5.3898">     // nsImapUrl::SetSpec() will set the imap action properly</span>
<a href="#l5.3899"></a><span id="l5.3899">     rv = imapUrl-&gt;SetImapAction(nsIImapUrl::nsImapUserDefinedFetchAttribute);</span>
<a href="#l5.3900"></a><span id="l5.3900"> </span>
<a href="#l5.3901"></a><span id="l5.3901" class="difflineminus">-    nsCOMPtr &lt;nsIMsgMailNewsUrl&gt; mailNewsUrl = do_QueryInterface(imapUrl);</span>
<a href="#l5.3902"></a><span id="l5.3902" class="difflineplus">+    nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailNewsUrl = do_QueryInterface(imapUrl);</span>
<a href="#l5.3903"></a><span id="l5.3903">     mailNewsUrl-&gt;SetMsgWindow(aMsgWindow);</span>
<a href="#l5.3904"></a><span id="l5.3904">     mailNewsUrl-&gt;SetUpdatingFolder(true);</span>
<a href="#l5.3905"></a><span id="l5.3905">     rv = SetImapUrlSink(anImapFolder, imapUrl);</span>
<a href="#l5.3906"></a><span id="l5.3906"> </span>
<a href="#l5.3907"></a><span id="l5.3907" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l5.3908"></a><span id="l5.3908" class="difflineminus">-    {</span>
<a href="#l5.3909"></a><span id="l5.3909" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l5.3910"></a><span id="l5.3910">       nsCString folderName;</span>
<a href="#l5.3911"></a><span id="l5.3911">       GetFolderName(anImapFolder, folderName);</span>
<a href="#l5.3912"></a><span id="l5.3912">       urlSpec.AppendLiteral(&quot;/customFetch&gt;UID&gt;&quot;);</span>
<a href="#l5.3913"></a><span id="l5.3913">       urlSpec.Append(hierarchyDelimiter);</span>
<a href="#l5.3914"></a><span id="l5.3914">       urlSpec.Append(folderName);</span>
<a href="#l5.3915"></a><span id="l5.3915">       urlSpec.Append('&gt;');</span>
<a href="#l5.3916"></a><span id="l5.3916">       urlSpec.Append(uids);</span>
<a href="#l5.3917"></a><span id="l5.3917">       urlSpec.Append('&gt;');</span>
<a href="#l5.3918"></a><span id="l5.3918">       urlSpec.Append(aAttribute);</span>
<a href="#l5.3919"></a><span id="l5.3919">       rv = mailNewsUrl-&gt;SetSpecInternal(urlSpec);</span>
<a href="#l5.3920"></a><span id="l5.3920">       if (NS_SUCCEEDED(rv))</span>
<a href="#l5.3921"></a><span id="l5.3921">         rv = GetImapConnectionAndLoadUrl(imapUrl, nullptr, aURL);</span>
<a href="#l5.3922"></a><span id="l5.3922">     }</span>
<a href="#l5.3923"></a><span id="l5.3923" class="difflineminus">-  } // if we have a url to run....</span>
<a href="#l5.3924"></a><span id="l5.3924" class="difflineplus">+  }  // if we have a url to run....</span>
<a href="#l5.3925"></a><span id="l5.3925"> </span>
<a href="#l5.3926"></a><span id="l5.3926">   return rv;</span>
<a href="#l5.3927"></a><span id="l5.3927"> }</span>
<a href="#l5.3928"></a><span id="l5.3928"> </span>
<a href="#l5.3929"></a><span id="l5.3929" class="difflineminus">-NS_IMETHODIMP nsImapService::StoreCustomKeywords(nsIMsgFolder *anImapFolder,</span>
<a href="#l5.3930"></a><span id="l5.3930" class="difflineminus">-                                                 nsIMsgWindow *aMsgWindow,</span>
<a href="#l5.3931"></a><span id="l5.3931" class="difflineminus">-                                                 const nsACString &amp;flagsToAdd,</span>
<a href="#l5.3932"></a><span id="l5.3932" class="difflineminus">-                                                 const nsACString &amp;flagsToSubtract,</span>
<a href="#l5.3933"></a><span id="l5.3933" class="difflineminus">-                                                 const nsACString &amp;uids,</span>
<a href="#l5.3934"></a><span id="l5.3934" class="difflineminus">-                                                 nsIURI **aURL)</span>
<a href="#l5.3935"></a><span id="l5.3935" class="difflineminus">-{</span>
<a href="#l5.3936"></a><span id="l5.3936" class="difflineplus">+NS_IMETHODIMP nsImapService::StoreCustomKeywords(</span>
<a href="#l5.3937"></a><span id="l5.3937" class="difflineplus">+    nsIMsgFolder *anImapFolder, nsIMsgWindow *aMsgWindow,</span>
<a href="#l5.3938"></a><span id="l5.3938" class="difflineplus">+    const nsACString &amp;flagsToAdd, const nsACString &amp;flagsToSubtract,</span>
<a href="#l5.3939"></a><span id="l5.3939" class="difflineplus">+    const nsACString &amp;uids, nsIURI **aURL) {</span>
<a href="#l5.3940"></a><span id="l5.3940">   NS_ENSURE_ARG_POINTER(anImapFolder);</span>
<a href="#l5.3941"></a><span id="l5.3941"> </span>
<a href="#l5.3942"></a><span id="l5.3942">   nsCOMPtr&lt;nsIImapUrl&gt; imapUrl;</span>
<a href="#l5.3943"></a><span id="l5.3943">   nsAutoCString urlSpec;</span>
<a href="#l5.3944"></a><span id="l5.3944">   nsresult rv;</span>
<a href="#l5.3945"></a><span id="l5.3945">   char hierarchyDelimiter = GetHierarchyDelimiter(anImapFolder);</span>
<a href="#l5.3946"></a><span id="l5.3946" class="difflineminus">-  rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(imapUrl), anImapFolder, nullptr, urlSpec, hierarchyDelimiter);</span>
<a href="#l5.3947"></a><span id="l5.3947" class="difflineminus">-</span>
<a href="#l5.3948"></a><span id="l5.3948" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; imapUrl)</span>
<a href="#l5.3949"></a><span id="l5.3949" class="difflineminus">-  {</span>
<a href="#l5.3950"></a><span id="l5.3950" class="difflineplus">+  rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(imapUrl),</span>
<a href="#l5.3951"></a><span id="l5.3951" class="difflineplus">+                            anImapFolder, nullptr, urlSpec, hierarchyDelimiter);</span>
<a href="#l5.3952"></a><span id="l5.3952" class="difflineplus">+</span>
<a href="#l5.3953"></a><span id="l5.3953" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; imapUrl) {</span>
<a href="#l5.3954"></a><span id="l5.3954">     // nsImapUrl::SetSpec() will set the imap action properly</span>
<a href="#l5.3955"></a><span id="l5.3955">     rv = imapUrl-&gt;SetImapAction(nsIImapUrl::nsImapMsgStoreCustomKeywords);</span>
<a href="#l5.3956"></a><span id="l5.3956"> </span>
<a href="#l5.3957"></a><span id="l5.3957" class="difflineminus">-    nsCOMPtr &lt;nsIMsgMailNewsUrl&gt; mailNewsUrl = do_QueryInterface(imapUrl);</span>
<a href="#l5.3958"></a><span id="l5.3958" class="difflineplus">+    nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailNewsUrl = do_QueryInterface(imapUrl);</span>
<a href="#l5.3959"></a><span id="l5.3959">     mailNewsUrl-&gt;SetMsgWindow(aMsgWindow);</span>
<a href="#l5.3960"></a><span id="l5.3960">     mailNewsUrl-&gt;SetUpdatingFolder(true);</span>
<a href="#l5.3961"></a><span id="l5.3961">     rv = SetImapUrlSink(anImapFolder, imapUrl);</span>
<a href="#l5.3962"></a><span id="l5.3962"> </span>
<a href="#l5.3963"></a><span id="l5.3963" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l5.3964"></a><span id="l5.3964" class="difflineminus">-    {</span>
<a href="#l5.3965"></a><span id="l5.3965" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l5.3966"></a><span id="l5.3966">       nsCString folderName;</span>
<a href="#l5.3967"></a><span id="l5.3967">       GetFolderName(anImapFolder, folderName);</span>
<a href="#l5.3968"></a><span id="l5.3968">       urlSpec.AppendLiteral(&quot;/customKeywords&gt;UID&gt;&quot;);</span>
<a href="#l5.3969"></a><span id="l5.3969">       urlSpec.Append(hierarchyDelimiter);</span>
<a href="#l5.3970"></a><span id="l5.3970">       urlSpec.Append(folderName);</span>
<a href="#l5.3971"></a><span id="l5.3971">       urlSpec.Append('&gt;');</span>
<a href="#l5.3972"></a><span id="l5.3972">       urlSpec.Append(uids);</span>
<a href="#l5.3973"></a><span id="l5.3973">       urlSpec.Append('&gt;');</span>
<a href="#l5.3974"></a><span id="l5.3974">       urlSpec.Append(flagsToAdd);</span>
<a href="#l5.3975"></a><span id="l5.3975">       urlSpec.Append('&gt;');</span>
<a href="#l5.3976"></a><span id="l5.3976">       urlSpec.Append(flagsToSubtract);</span>
<a href="#l5.3977"></a><span id="l5.3977">       rv = mailNewsUrl-&gt;SetSpecInternal(urlSpec);</span>
<a href="#l5.3978"></a><span id="l5.3978">       if (NS_SUCCEEDED(rv))</span>
<a href="#l5.3979"></a><span id="l5.3979">         rv = GetImapConnectionAndLoadUrl(imapUrl, nullptr, aURL);</span>
<a href="#l5.3980"></a><span id="l5.3980">     }</span>
<a href="#l5.3981"></a><span id="l5.3981" class="difflineminus">-  } // if we have a url to run....</span>
<a href="#l5.3982"></a><span id="l5.3982" class="difflineplus">+  }  // if we have a url to run....</span>
<a href="#l5.3983"></a><span id="l5.3983"> </span>
<a href="#l5.3984"></a><span id="l5.3984">   return rv;</span>
<a href="#l5.3985"></a><span id="l5.3985"> }</span>
<a href="#l5.3986"></a><span id="l5.3986"> </span>
<a href="#l5.3987"></a><span id="l5.3987" class="difflineminus">-</span>
<a href="#l5.3988"></a><span id="l5.3988" class="difflineminus">-NS_IMETHODIMP nsImapService::DownloadMessagesForOffline(const nsACString &amp;messageIds,</span>
<a href="#l5.3989"></a><span id="l5.3989" class="difflineminus">-                                                        nsIMsgFolder *aFolder,</span>
<a href="#l5.3990"></a><span id="l5.3990" class="difflineminus">-                                                        nsIUrlListener *aUrlListener,</span>
<a href="#l5.3991"></a><span id="l5.3991" class="difflineminus">-                                                        nsIMsgWindow *aMsgWindow)</span>
<a href="#l5.3992"></a><span id="l5.3992" class="difflineminus">-{</span>
<a href="#l5.3993"></a><span id="l5.3993" class="difflineplus">+NS_IMETHODIMP nsImapService::DownloadMessagesForOffline(</span>
<a href="#l5.3994"></a><span id="l5.3994" class="difflineplus">+    const nsACString &amp;messageIds, nsIMsgFolder *aFolder,</span>
<a href="#l5.3995"></a><span id="l5.3995" class="difflineplus">+    nsIUrlListener *aUrlListener, nsIMsgWindow *aMsgWindow) {</span>
<a href="#l5.3996"></a><span id="l5.3996">   NS_ENSURE_ARG_POINTER(aFolder);</span>
<a href="#l5.3997"></a><span id="l5.3997"> </span>
<a href="#l5.3998"></a><span id="l5.3998">   nsCOMPtr&lt;nsIImapUrl&gt; imapUrl;</span>
<a href="#l5.3999"></a><span id="l5.3999">   nsAutoCString urlSpec;</span>
<a href="#l5.4000"></a><span id="l5.4000">   nsresult rv;</span>
<a href="#l5.4001"></a><span id="l5.4001">   char hierarchyDelimiter = GetHierarchyDelimiter(aFolder);</span>
<a href="#l5.4002"></a><span id="l5.4002" class="difflineminus">-  rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(imapUrl), aFolder, nullptr,</span>
<a href="#l5.4003"></a><span id="l5.4003" class="difflineminus">-                            urlSpec, hierarchyDelimiter);</span>
<a href="#l5.4004"></a><span id="l5.4004" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; imapUrl)</span>
<a href="#l5.4005"></a><span id="l5.4005" class="difflineminus">-  {</span>
<a href="#l5.4006"></a><span id="l5.4006" class="difflineplus">+  rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(imapUrl), aFolder,</span>
<a href="#l5.4007"></a><span id="l5.4007" class="difflineplus">+                            nullptr, urlSpec, hierarchyDelimiter);</span>
<a href="#l5.4008"></a><span id="l5.4008" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; imapUrl) {</span>
<a href="#l5.4009"></a><span id="l5.4009">     nsCOMPtr&lt;nsIURI&gt; runningURI;</span>
<a href="#l5.4010"></a><span id="l5.4010" class="difflineminus">-    // need to pass in stream listener in order to get the channel created correctly</span>
<a href="#l5.4011"></a><span id="l5.4011" class="difflineminus">-    nsCOMPtr&lt;nsIImapMessageSink&gt; imapMessageSink(do_QueryInterface(aFolder, &amp;rv));</span>
<a href="#l5.4012"></a><span id="l5.4012" class="difflineminus">-    rv = FetchMessage(imapUrl, nsImapUrl::nsImapMsgDownloadForOffline,aFolder,</span>
<a href="#l5.4013"></a><span id="l5.4013" class="difflineminus">-                      imapMessageSink, aMsgWindow, nullptr, messageIds,</span>
<a href="#l5.4014"></a><span id="l5.4014" class="difflineminus">-                      false, EmptyCString(), getter_AddRefs(runningURI));</span>
<a href="#l5.4015"></a><span id="l5.4015" class="difflineminus">-    if (runningURI &amp;&amp; aUrlListener)</span>
<a href="#l5.4016"></a><span id="l5.4016" class="difflineminus">-    {</span>
<a href="#l5.4017"></a><span id="l5.4017" class="difflineminus">-      nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; msgurl (do_QueryInterface(runningURI));</span>
<a href="#l5.4018"></a><span id="l5.4018" class="difflineplus">+    // need to pass in stream listener in order to get the channel created</span>
<a href="#l5.4019"></a><span id="l5.4019" class="difflineplus">+    // correctly</span>
<a href="#l5.4020"></a><span id="l5.4020" class="difflineplus">+    nsCOMPtr&lt;nsIImapMessageSink&gt; imapMessageSink(</span>
<a href="#l5.4021"></a><span id="l5.4021" class="difflineplus">+        do_QueryInterface(aFolder, &amp;rv));</span>
<a href="#l5.4022"></a><span id="l5.4022" class="difflineplus">+    rv = FetchMessage(imapUrl, nsImapUrl::nsImapMsgDownloadForOffline, aFolder,</span>
<a href="#l5.4023"></a><span id="l5.4023" class="difflineplus">+                      imapMessageSink, aMsgWindow, nullptr, messageIds, false,</span>
<a href="#l5.4024"></a><span id="l5.4024" class="difflineplus">+                      EmptyCString(), getter_AddRefs(runningURI));</span>
<a href="#l5.4025"></a><span id="l5.4025" class="difflineplus">+    if (runningURI &amp;&amp; aUrlListener) {</span>
<a href="#l5.4026"></a><span id="l5.4026" class="difflineplus">+      nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; msgurl(do_QueryInterface(runningURI));</span>
<a href="#l5.4027"></a><span id="l5.4027">       nsCOMPtr&lt;nsIImapUrl&gt; imapUrl(do_QueryInterface(runningURI));</span>
<a href="#l5.4028"></a><span id="l5.4028" class="difflineminus">-      if (msgurl)</span>
<a href="#l5.4029"></a><span id="l5.4029" class="difflineminus">-        msgurl-&gt;RegisterListener(aUrlListener);</span>
<a href="#l5.4030"></a><span id="l5.4030" class="difflineminus">-      if (imapUrl)</span>
<a href="#l5.4031"></a><span id="l5.4031" class="difflineminus">-        imapUrl-&gt;SetStoreResultsOffline(true);</span>
<a href="#l5.4032"></a><span id="l5.4032" class="difflineplus">+      if (msgurl) msgurl-&gt;RegisterListener(aUrlListener);</span>
<a href="#l5.4033"></a><span id="l5.4033" class="difflineplus">+      if (imapUrl) imapUrl-&gt;SetStoreResultsOffline(true);</span>
<a href="#l5.4034"></a><span id="l5.4034">     }</span>
<a href="#l5.4035"></a><span id="l5.4035">   }</span>
<a href="#l5.4036"></a><span id="l5.4036">   return rv;</span>
<a href="#l5.4037"></a><span id="l5.4037"> }</span>
<a href="#l5.4038"></a><span id="l5.4038"> </span>
<a href="#l5.4039"></a><span id="l5.4039" class="difflineminus">-NS_IMETHODIMP nsImapService::MessageURIToMsgHdr(const char *uri, nsIMsgDBHdr **aRetVal)</span>
<a href="#l5.4040"></a><span id="l5.4040" class="difflineminus">-{</span>
<a href="#l5.4041"></a><span id="l5.4041" class="difflineplus">+NS_IMETHODIMP nsImapService::MessageURIToMsgHdr(const char *uri,</span>
<a href="#l5.4042"></a><span id="l5.4042" class="difflineplus">+                                                nsIMsgDBHdr **aRetVal) {</span>
<a href="#l5.4043"></a><span id="l5.4043">   NS_ENSURE_ARG_POINTER(uri);</span>
<a href="#l5.4044"></a><span id="l5.4044">   NS_ENSURE_ARG_POINTER(aRetVal);</span>
<a href="#l5.4045"></a><span id="l5.4045"> </span>
<a href="#l5.4046"></a><span id="l5.4046">   nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l5.4047"></a><span id="l5.4047">   nsMsgKey msgKey;</span>
<a href="#l5.4048"></a><span id="l5.4048">   nsresult rv = DecomposeImapURI(nsDependentCString(uri),</span>
<a href="#l5.4049"></a><span id="l5.4049">                                  getter_AddRefs(folder), &amp;msgKey);</span>
<a href="#l5.4050"></a><span id="l5.4050" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l5.4051"></a><span id="l5.4051" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.4052"></a><span id="l5.4052">   rv = folder-&gt;GetMessageHeader(msgKey, aRetVal);</span>
<a href="#l5.4053"></a><span id="l5.4053" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l5.4054"></a><span id="l5.4054" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.4055"></a><span id="l5.4055"> </span>
<a href="#l5.4056"></a><span id="l5.4056">   return NS_OK;</span>
<a href="#l5.4057"></a><span id="l5.4057"> }</span>
<a href="#l5.4058"></a><span id="l5.4058"> </span>
<a href="#l5.4059"></a><span id="l5.4059" class="difflineminus">-NS_IMETHODIMP nsImapService::PlaybackAllOfflineOperations(nsIMsgWindow *aMsgWindow,</span>
<a href="#l5.4060"></a><span id="l5.4060" class="difflineminus">-                                                          nsIUrlListener *aListener,</span>
<a href="#l5.4061"></a><span id="l5.4061" class="difflineminus">-                                                          nsISupports **aResult)</span>
<a href="#l5.4062"></a><span id="l5.4062" class="difflineminus">-{</span>
<a href="#l5.4063"></a><span id="l5.4063" class="difflineplus">+NS_IMETHODIMP nsImapService::PlaybackAllOfflineOperations(</span>
<a href="#l5.4064"></a><span id="l5.4064" class="difflineplus">+    nsIMsgWindow *aMsgWindow, nsIUrlListener *aListener,</span>
<a href="#l5.4065"></a><span id="l5.4065" class="difflineplus">+    nsISupports **aResult) {</span>
<a href="#l5.4066"></a><span id="l5.4066">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l5.4067"></a><span id="l5.4067"> </span>
<a href="#l5.4068"></a><span id="l5.4068">   nsresult rv;</span>
<a href="#l5.4069"></a><span id="l5.4069" class="difflineminus">-  nsImapOfflineSync *goOnline = new nsImapOfflineSync(aMsgWindow, aListener, nullptr);</span>
<a href="#l5.4070"></a><span id="l5.4070" class="difflineminus">-  if (goOnline)</span>
<a href="#l5.4071"></a><span id="l5.4071" class="difflineminus">-  {</span>
<a href="#l5.4072"></a><span id="l5.4072" class="difflineminus">-    rv = goOnline-&gt;QueryInterface(NS_GET_IID(nsISupports), (void **) aResult);</span>
<a href="#l5.4073"></a><span id="l5.4073" class="difflineplus">+  nsImapOfflineSync *goOnline =</span>
<a href="#l5.4074"></a><span id="l5.4074" class="difflineplus">+      new nsImapOfflineSync(aMsgWindow, aListener, nullptr);</span>
<a href="#l5.4075"></a><span id="l5.4075" class="difflineplus">+  if (goOnline) {</span>
<a href="#l5.4076"></a><span id="l5.4076" class="difflineplus">+    rv = goOnline-&gt;QueryInterface(NS_GET_IID(nsISupports), (void **)aResult);</span>
<a href="#l5.4077"></a><span id="l5.4077">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.4078"></a><span id="l5.4078" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; *aResult)</span>
<a href="#l5.4079"></a><span id="l5.4079" class="difflineminus">-      return goOnline-&gt;ProcessNextOperation();</span>
<a href="#l5.4080"></a><span id="l5.4080" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; *aResult) return goOnline-&gt;ProcessNextOperation();</span>
<a href="#l5.4081"></a><span id="l5.4081">   }</span>
<a href="#l5.4082"></a><span id="l5.4082">   return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l5.4083"></a><span id="l5.4083"> }</span>
<a href="#l5.4084"></a><span id="l5.4084"> </span>
<a href="#l5.4085"></a><span id="l5.4085" class="difflineminus">-NS_IMETHODIMP nsImapService::DownloadAllOffineImapFolders(nsIMsgWindow *aMsgWindow,</span>
<a href="#l5.4086"></a><span id="l5.4086" class="difflineminus">-                                                          nsIUrlListener *aListener)</span>
<a href="#l5.4087"></a><span id="l5.4087" class="difflineminus">-{</span>
<a href="#l5.4088"></a><span id="l5.4088" class="difflineminus">-  RefPtr&lt;nsImapOfflineDownloader&gt; downloadForOffline = new nsImapOfflineDownloader(aMsgWindow, aListener);</span>
<a href="#l5.4089"></a><span id="l5.4089" class="difflineminus">-  if (downloadForOffline)</span>
<a href="#l5.4090"></a><span id="l5.4090" class="difflineminus">-  {</span>
<a href="#l5.4091"></a><span id="l5.4091" class="difflineplus">+NS_IMETHODIMP nsImapService::DownloadAllOffineImapFolders(</span>
<a href="#l5.4092"></a><span id="l5.4092" class="difflineplus">+    nsIMsgWindow *aMsgWindow, nsIUrlListener *aListener) {</span>
<a href="#l5.4093"></a><span id="l5.4093" class="difflineplus">+  RefPtr&lt;nsImapOfflineDownloader&gt; downloadForOffline =</span>
<a href="#l5.4094"></a><span id="l5.4094" class="difflineplus">+      new nsImapOfflineDownloader(aMsgWindow, aListener);</span>
<a href="#l5.4095"></a><span id="l5.4095" class="difflineplus">+  if (downloadForOffline) {</span>
<a href="#l5.4096"></a><span id="l5.4096">     // hold reference to this so it won't get deleted out from under itself.</span>
<a href="#l5.4097"></a><span id="l5.4097">     nsresult rv = downloadForOffline-&gt;ProcessNextOperation();</span>
<a href="#l5.4098"></a><span id="l5.4098">     return rv;</span>
<a href="#l5.4099"></a><span id="l5.4099">   }</span>
<a href="#l5.4100"></a><span id="l5.4100">   return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l5.4101"></a><span id="l5.4101"> }</span>
<a href="#l5.4102"></a><span id="l5.4102"> </span>
<a href="#l5.4103"></a><span id="l5.4103" class="difflineminus">-NS_IMETHODIMP nsImapService::GetCacheStorage(nsICacheStorage **result)</span>
<a href="#l5.4104"></a><span id="l5.4104" class="difflineminus">-{</span>
<a href="#l5.4105"></a><span id="l5.4105" class="difflineplus">+NS_IMETHODIMP nsImapService::GetCacheStorage(nsICacheStorage **result) {</span>
<a href="#l5.4106"></a><span id="l5.4106">   nsresult rv = NS_OK;</span>
<a href="#l5.4107"></a><span id="l5.4107" class="difflineminus">-  if (!mCacheStorage)</span>
<a href="#l5.4108"></a><span id="l5.4108" class="difflineminus">-  {</span>
<a href="#l5.4109"></a><span id="l5.4109" class="difflineplus">+  if (!mCacheStorage) {</span>
<a href="#l5.4110"></a><span id="l5.4110">     nsCOMPtr&lt;nsICacheStorageService&gt; cacheStorageService =</span>
<a href="#l5.4111"></a><span id="l5.4111" class="difflineminus">-      do_GetService(&quot;@mozilla.org/netwerk/cache-storage-service;1&quot;, &amp;rv);</span>
<a href="#l5.4112"></a><span id="l5.4112" class="difflineplus">+        do_GetService(&quot;@mozilla.org/netwerk/cache-storage-service;1&quot;, &amp;rv);</span>
<a href="#l5.4113"></a><span id="l5.4113">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.4114"></a><span id="l5.4114"> </span>
<a href="#l5.4115"></a><span id="l5.4115">     RefPtr&lt;MailnewsLoadContextInfo&gt; lci =</span>
<a href="#l5.4116"></a><span id="l5.4116" class="difflineminus">-      new MailnewsLoadContextInfo(false, false, mozilla::OriginAttributes());</span>
<a href="#l5.4117"></a><span id="l5.4117" class="difflineminus">-</span>
<a href="#l5.4118"></a><span id="l5.4118" class="difflineminus">-    rv = cacheStorageService-&gt;MemoryCacheStorage(lci, getter_AddRefs(mCacheStorage));</span>
<a href="#l5.4119"></a><span id="l5.4119" class="difflineplus">+        new MailnewsLoadContextInfo(false, false, mozilla::OriginAttributes());</span>
<a href="#l5.4120"></a><span id="l5.4120" class="difflineplus">+</span>
<a href="#l5.4121"></a><span id="l5.4121" class="difflineplus">+    rv = cacheStorageService-&gt;MemoryCacheStorage(lci,</span>
<a href="#l5.4122"></a><span id="l5.4122" class="difflineplus">+                                                 getter_AddRefs(mCacheStorage));</span>
<a href="#l5.4123"></a><span id="l5.4123">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.4124"></a><span id="l5.4124">   }</span>
<a href="#l5.4125"></a><span id="l5.4125"> </span>
<a href="#l5.4126"></a><span id="l5.4126">   NS_IF_ADDREF(*result = mCacheStorage);</span>
<a href="#l5.4127"></a><span id="l5.4127">   return rv;</span>
<a href="#l5.4128"></a><span id="l5.4128"> }</span>
<a href="#l5.4129"></a><span id="l5.4129"> </span>
<a href="#l5.4130"></a><span id="l5.4130" class="difflineminus">-NS_IMETHODIMP nsImapService::HandleContent(const char *aContentType,</span>
<a href="#l5.4131"></a><span id="l5.4131" class="difflineminus">-                                           nsIInterfaceRequestor *aWindowContext,</span>
<a href="#l5.4132"></a><span id="l5.4132" class="difflineminus">-                                           nsIRequest *request)</span>
<a href="#l5.4133"></a><span id="l5.4133" class="difflineminus">-{</span>
<a href="#l5.4134"></a><span id="l5.4134" class="difflineplus">+NS_IMETHODIMP nsImapService::HandleContent(</span>
<a href="#l5.4135"></a><span id="l5.4135" class="difflineplus">+    const char *aContentType, nsIInterfaceRequestor *aWindowContext,</span>
<a href="#l5.4136"></a><span id="l5.4136" class="difflineplus">+    nsIRequest *request) {</span>
<a href="#l5.4137"></a><span id="l5.4137">   NS_ENSURE_ARG_POINTER(request);</span>
<a href="#l5.4138"></a><span id="l5.4138"> </span>
<a href="#l5.4139"></a><span id="l5.4139">   nsresult rv;</span>
<a href="#l5.4140"></a><span id="l5.4140">   nsCOMPtr&lt;nsIChannel&gt; aChannel = do_QueryInterface(request, &amp;rv);</span>
<a href="#l5.4141"></a><span id="l5.4141">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.4142"></a><span id="l5.4142"> </span>
<a href="#l5.4143"></a><span id="l5.4143" class="difflineminus">-  if (PL_strcasecmp(aContentType, &quot;x-application-imapfolder&quot;) == 0)</span>
<a href="#l5.4144"></a><span id="l5.4144" class="difflineminus">-  {</span>
<a href="#l5.4145"></a><span id="l5.4145" class="difflineplus">+  if (PL_strcasecmp(aContentType, &quot;x-application-imapfolder&quot;) == 0) {</span>
<a href="#l5.4146"></a><span id="l5.4146">     nsCOMPtr&lt;nsIURI&gt; uri;</span>
<a href="#l5.4147"></a><span id="l5.4147">     rv = aChannel-&gt;GetURI(getter_AddRefs(uri));</span>
<a href="#l5.4148"></a><span id="l5.4148">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.4149"></a><span id="l5.4149"> </span>
<a href="#l5.4150"></a><span id="l5.4150" class="difflineminus">-    if (uri)</span>
<a href="#l5.4151"></a><span id="l5.4151" class="difflineminus">-    {</span>
<a href="#l5.4152"></a><span id="l5.4152" class="difflineplus">+    if (uri) {</span>
<a href="#l5.4153"></a><span id="l5.4153">       request-&gt;Cancel(NS_BINDING_ABORTED);</span>
<a href="#l5.4154"></a><span id="l5.4154" class="difflineminus">-      nsCOMPtr&lt;nsIWindowMediator&gt; mediator(do_GetService(NS_WINDOWMEDIATOR_CONTRACTID, &amp;rv));</span>
<a href="#l5.4155"></a><span id="l5.4155" class="difflineplus">+      nsCOMPtr&lt;nsIWindowMediator&gt; mediator(</span>
<a href="#l5.4156"></a><span id="l5.4156" class="difflineplus">+          do_GetService(NS_WINDOWMEDIATOR_CONTRACTID, &amp;rv));</span>
<a href="#l5.4157"></a><span id="l5.4157">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.4158"></a><span id="l5.4158"> </span>
<a href="#l5.4159"></a><span id="l5.4159">       nsAutoCString uriStr;</span>
<a href="#l5.4160"></a><span id="l5.4160">       rv = uri-&gt;GetSpec(uriStr);</span>
<a href="#l5.4161"></a><span id="l5.4161">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.4162"></a><span id="l5.4162"> </span>
<a href="#l5.4163"></a><span id="l5.4163">       // imap uri's are unescaped, so unescape the url.</span>
<a href="#l5.4164"></a><span id="l5.4164">       nsCString unescapedUriStr;</span>
<a href="#l5.4165"></a><span id="l5.4165">       MsgUnescapeString(uriStr, 0, unescapedUriStr);</span>
<a href="#l5.4166"></a><span id="l5.4166" class="difflineminus">-      nsCOMPtr &lt;nsIMessengerWindowService&gt; messengerWindowService = do_GetService(NS_MESSENGERWINDOWSERVICE_CONTRACTID,&amp;rv);</span>
<a href="#l5.4167"></a><span id="l5.4167" class="difflineplus">+      nsCOMPtr&lt;nsIMessengerWindowService&gt; messengerWindowService =</span>
<a href="#l5.4168"></a><span id="l5.4168" class="difflineplus">+          do_GetService(NS_MESSENGERWINDOWSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l5.4169"></a><span id="l5.4169">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.4170"></a><span id="l5.4170"> </span>
<a href="#l5.4171"></a><span id="l5.4171" class="difflineminus">-      rv = messengerWindowService-&gt;OpenMessengerWindowWithUri(&quot;mail:3pane&quot;, unescapedUriStr.get(), nsMsgKey_None);</span>
<a href="#l5.4172"></a><span id="l5.4172" class="difflineplus">+      rv = messengerWindowService-&gt;OpenMessengerWindowWithUri(</span>
<a href="#l5.4173"></a><span id="l5.4173" class="difflineplus">+          &quot;mail:3pane&quot;, unescapedUriStr.get(), nsMsgKey_None);</span>
<a href="#l5.4174"></a><span id="l5.4174">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.4175"></a><span id="l5.4175">     }</span>
<a href="#l5.4176"></a><span id="l5.4176" class="difflineminus">-  }</span>
<a href="#l5.4177"></a><span id="l5.4177" class="difflineminus">-  else</span>
<a href="#l5.4178"></a><span id="l5.4178" class="difflineminus">-  {</span>
<a href="#l5.4179"></a><span id="l5.4179" class="difflineplus">+  } else {</span>
<a href="#l5.4180"></a><span id="l5.4180">     // The content-type was not x-application-imapfolder</span>
<a href="#l5.4181"></a><span id="l5.4181">     return NS_ERROR_WONT_HANDLE_CONTENT;</span>
<a href="#l5.4182"></a><span id="l5.4182">   }</span>
<a href="#l5.4183"></a><span id="l5.4183"> </span>
<a href="#l5.4184"></a><span id="l5.4184">   return rv;</span>
<a href="#l5.4185"></a><span id="l5.4185"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/imap/src/nsImapService.h</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapService.h</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -20,102 +20,91 @@ class nsIImapUrl;</span>
<a href="#l6.4"></a><span id="l6.4"> class nsIMsgFolder;</span>
<a href="#l6.5"></a><span id="l6.5"> class nsIMsgIncomingServer;</span>
<a href="#l6.6"></a><span id="l6.6"> </span>
<a href="#l6.7"></a><span id="l6.7"> class nsImapService : public nsIImapService,</span>
<a href="#l6.8"></a><span id="l6.8">                       public nsIMsgMessageService,</span>
<a href="#l6.9"></a><span id="l6.9">                       public nsIMsgMessageFetchPartService,</span>
<a href="#l6.10"></a><span id="l6.10">                       public nsIProtocolHandler,</span>
<a href="#l6.11"></a><span id="l6.11">                       public nsIMsgProtocolInfo,</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-                      public nsIContentHandler</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-{</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineminus">-public:</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+                      public nsIContentHandler {</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineplus">+ public:</span>
<a href="#l6.17"></a><span id="l6.17">   nsImapService();</span>
<a href="#l6.18"></a><span id="l6.18"> </span>
<a href="#l6.19"></a><span id="l6.19">   NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l6.20"></a><span id="l6.20">   NS_DECL_NSIMSGPROTOCOLINFO</span>
<a href="#l6.21"></a><span id="l6.21">   NS_DECL_NSIIMAPSERVICE</span>
<a href="#l6.22"></a><span id="l6.22">   NS_DECL_NSIMSGMESSAGESERVICE</span>
<a href="#l6.23"></a><span id="l6.23">   NS_DECL_NSIPROTOCOLHANDLER</span>
<a href="#l6.24"></a><span id="l6.24">   NS_DECL_NSIMSGMESSAGEFETCHPARTSERVICE</span>
<a href="#l6.25"></a><span id="l6.25">   NS_DECL_NSICONTENTHANDLER</span>
<a href="#l6.26"></a><span id="l6.26"> </span>
<a href="#l6.27"></a><span id="l6.27" class="difflineminus">-protected:</span>
<a href="#l6.28"></a><span id="l6.28" class="difflineplus">+ protected:</span>
<a href="#l6.29"></a><span id="l6.29">   virtual ~nsImapService();</span>
<a href="#l6.30"></a><span id="l6.30">   char GetHierarchyDelimiter(nsIMsgFolder *aMsgFolder);</span>
<a href="#l6.31"></a><span id="l6.31"> </span>
<a href="#l6.32"></a><span id="l6.32">   nsresult GetFolderName(nsIMsgFolder *aImapFolder, nsACString &amp;aFolderName);</span>
<a href="#l6.33"></a><span id="l6.33"> </span>
<a href="#l6.34"></a><span id="l6.34">   // This is called by both FetchMessage and StreamMessage</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineminus">-  nsresult GetMessageFromUrl(nsIImapUrl *aImapUrl,</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineminus">-                             nsImapAction aImapAction,</span>
<a href="#l6.37"></a><span id="l6.37" class="difflineplus">+  nsresult GetMessageFromUrl(nsIImapUrl *aImapUrl, nsImapAction aImapAction,</span>
<a href="#l6.38"></a><span id="l6.38">                              nsIMsgFolder *aImapMailFolder,</span>
<a href="#l6.39"></a><span id="l6.39">                              nsIImapMessageSink *aImapMessage,</span>
<a href="#l6.40"></a><span id="l6.40">                              nsIMsgWindow *aMsgWindow,</span>
<a href="#l6.41"></a><span id="l6.41">                              nsISupports *aDisplayConsumer,</span>
<a href="#l6.42"></a><span id="l6.42" class="difflineminus">-                             bool aConvertDataToText,</span>
<a href="#l6.43"></a><span id="l6.43" class="difflineminus">-                             nsIURI **aURL);</span>
<a href="#l6.44"></a><span id="l6.44" class="difflineplus">+                             bool aConvertDataToText, nsIURI **aURL);</span>
<a href="#l6.45"></a><span id="l6.45"> </span>
<a href="#l6.46"></a><span id="l6.46" class="difflineminus">-  nsresult CreateStartOfImapUrl(const nsACString &amp;aImapURI,  // a RDF URI for the current message/folder, can be empty</span>
<a href="#l6.47"></a><span id="l6.47" class="difflineminus">-                                nsIImapUrl  **imapUrl,</span>
<a href="#l6.48"></a><span id="l6.48" class="difflineminus">-                                nsIMsgFolder *aImapFolder,</span>
<a href="#l6.49"></a><span id="l6.49" class="difflineminus">-                                nsIUrlListener *aUrlListener,</span>
<a href="#l6.50"></a><span id="l6.50" class="difflineminus">-                                nsACString &amp;urlSpec,</span>
<a href="#l6.51"></a><span id="l6.51" class="difflineminus">-                                char &amp;hierarchyDelimiter);</span>
<a href="#l6.52"></a><span id="l6.52" class="difflineplus">+  nsresult CreateStartOfImapUrl(</span>
<a href="#l6.53"></a><span id="l6.53" class="difflineplus">+      const nsACString</span>
<a href="#l6.54"></a><span id="l6.54" class="difflineplus">+          &amp;aImapURI,  // a RDF URI for the current message/folder, can be empty</span>
<a href="#l6.55"></a><span id="l6.55" class="difflineplus">+      nsIImapUrl **imapUrl, nsIMsgFolder *aImapFolder,</span>
<a href="#l6.56"></a><span id="l6.56" class="difflineplus">+      nsIUrlListener *aUrlListener, nsACString &amp;urlSpec,</span>
<a href="#l6.57"></a><span id="l6.57" class="difflineplus">+      char &amp;hierarchyDelimiter);</span>
<a href="#l6.58"></a><span id="l6.58"> </span>
<a href="#l6.59"></a><span id="l6.59">   nsresult GetImapConnectionAndLoadUrl(nsIImapUrl *aImapUrl,</span>
<a href="#l6.60"></a><span id="l6.60" class="difflineminus">-                                       nsISupports *aConsumer,</span>
<a href="#l6.61"></a><span id="l6.61" class="difflineminus">-                                       nsIURI **aURL);</span>
<a href="#l6.62"></a><span id="l6.62" class="difflineplus">+                                       nsISupports *aConsumer, nsIURI **aURL);</span>
<a href="#l6.63"></a><span id="l6.63"> </span>
<a href="#l6.64"></a><span id="l6.64">   nsresult SetImapUrlSink(nsIMsgFolder *aMsgFolder, nsIImapUrl *aImapUrl);</span>
<a href="#l6.65"></a><span id="l6.65"> </span>
<a href="#l6.66"></a><span id="l6.66" class="difflineminus">-  nsresult FetchMimePart(nsIImapUrl *aImapUrl,</span>
<a href="#l6.67"></a><span id="l6.67" class="difflineminus">-                         nsImapAction aImapAction,</span>
<a href="#l6.68"></a><span id="l6.68" class="difflineplus">+  nsresult FetchMimePart(nsIImapUrl *aImapUrl, nsImapAction aImapAction,</span>
<a href="#l6.69"></a><span id="l6.69">                          nsIMsgFolder *aImapMailFolder,</span>
<a href="#l6.70"></a><span id="l6.70" class="difflineminus">-                         nsIImapMessageSink *aImapMessage,</span>
<a href="#l6.71"></a><span id="l6.71" class="difflineminus">-                         nsIURI **aURL,</span>
<a href="#l6.72"></a><span id="l6.72" class="difflineplus">+                         nsIImapMessageSink *aImapMessage, nsIURI **aURL,</span>
<a href="#l6.73"></a><span id="l6.73">                          nsISupports *aDisplayConsumer,</span>
<a href="#l6.74"></a><span id="l6.74">                          const nsACString &amp;messageIdentifierList,</span>
<a href="#l6.75"></a><span id="l6.75">                          const nsACString &amp;mimePart);</span>
<a href="#l6.76"></a><span id="l6.76"> </span>
<a href="#l6.77"></a><span id="l6.77">   nsresult FolderCommand(nsIMsgFolder *imapMailFolder,</span>
<a href="#l6.78"></a><span id="l6.78" class="difflineminus">-                         nsIUrlListener *urlListener,</span>
<a href="#l6.79"></a><span id="l6.79" class="difflineminus">-                         const char *aCommand,</span>
<a href="#l6.80"></a><span id="l6.80" class="difflineminus">-                         nsImapAction imapAction,</span>
<a href="#l6.81"></a><span id="l6.81" class="difflineminus">-                         nsIMsgWindow *msgWindow,</span>
<a href="#l6.82"></a><span id="l6.82" class="difflineplus">+                         nsIUrlListener *urlListener, const char *aCommand,</span>
<a href="#l6.83"></a><span id="l6.83" class="difflineplus">+                         nsImapAction imapAction, nsIMsgWindow *msgWindow,</span>
<a href="#l6.84"></a><span id="l6.84">                          nsIURI **url);</span>
<a href="#l6.85"></a><span id="l6.85"> </span>
<a href="#l6.86"></a><span id="l6.86">   nsresult ChangeFolderSubscription(nsIMsgFolder *folder,</span>
<a href="#l6.87"></a><span id="l6.87">                                     const nsAString &amp;folderName,</span>
<a href="#l6.88"></a><span id="l6.88">                                     const char *aCommand,</span>
<a href="#l6.89"></a><span id="l6.89" class="difflineminus">-                                    nsIUrlListener *urlListener,</span>
<a href="#l6.90"></a><span id="l6.90" class="difflineminus">-                                    nsIURI **url);</span>
<a href="#l6.91"></a><span id="l6.91" class="difflineplus">+                                    nsIUrlListener *urlListener, nsIURI **url);</span>
<a href="#l6.92"></a><span id="l6.92"> </span>
<a href="#l6.93"></a><span id="l6.93">   nsresult DiddleFlags(nsIMsgFolder *aImapMailFolder,</span>
<a href="#l6.94"></a><span id="l6.94" class="difflineminus">-                       nsIUrlListener *aUrlListener,</span>
<a href="#l6.95"></a><span id="l6.95" class="difflineminus">-                       nsIURI **aURL,</span>
<a href="#l6.96"></a><span id="l6.96" class="difflineplus">+                       nsIUrlListener *aUrlListener, nsIURI **aURL,</span>
<a href="#l6.97"></a><span id="l6.97">                        const nsACString &amp;messageIdentifierList,</span>
<a href="#l6.98"></a><span id="l6.98" class="difflineminus">-                       const char *howToDiddle,</span>
<a href="#l6.99"></a><span id="l6.99" class="difflineminus">-                       imapMessageFlagsType flags,</span>
<a href="#l6.100"></a><span id="l6.100" class="difflineplus">+                       const char *howToDiddle, imapMessageFlagsType flags,</span>
<a href="#l6.101"></a><span id="l6.101">                        bool messageIdsAreUID);</span>
<a href="#l6.102"></a><span id="l6.102"> </span>
<a href="#l6.103"></a><span id="l6.103" class="difflineminus">-  nsresult OfflineAppendFromFile(nsIFile *aFile,</span>
<a href="#l6.104"></a><span id="l6.104" class="difflineminus">-                                 nsIURI *aUrl,</span>
<a href="#l6.105"></a><span id="l6.105" class="difflineplus">+  nsresult OfflineAppendFromFile(nsIFile *aFile, nsIURI *aUrl,</span>
<a href="#l6.106"></a><span id="l6.106">                                  nsIMsgFolder *aDstFolder,</span>
<a href="#l6.107"></a><span id="l6.107">                                  const nsACString &amp;messageId,  // to be replaced</span>
<a href="#l6.108"></a><span id="l6.108" class="difflineminus">-                                 bool inSelectedState, // needs to be in</span>
<a href="#l6.109"></a><span id="l6.109" class="difflineminus">-                                 nsIUrlListener *aListener,</span>
<a href="#l6.110"></a><span id="l6.110" class="difflineminus">-                                 nsIURI **aURL,</span>
<a href="#l6.111"></a><span id="l6.111" class="difflineplus">+                                 bool inSelectedState,         // needs to be in</span>
<a href="#l6.112"></a><span id="l6.112" class="difflineplus">+                                 nsIUrlListener *aListener, nsIURI **aURL,</span>
<a href="#l6.113"></a><span id="l6.113">                                  nsISupports *aCopyState);</span>
<a href="#l6.114"></a><span id="l6.114"> </span>
<a href="#l6.115"></a><span id="l6.115" class="difflineminus">-  nsresult GetServerFromUrl(nsIImapUrl *aImapUrl, nsIMsgIncomingServer **aServer);</span>
<a href="#l6.116"></a><span id="l6.116" class="difflineplus">+  nsresult GetServerFromUrl(nsIImapUrl *aImapUrl,</span>
<a href="#l6.117"></a><span id="l6.117" class="difflineplus">+                            nsIMsgIncomingServer **aServer);</span>
<a href="#l6.118"></a><span id="l6.118"> </span>
<a href="#l6.119"></a><span id="l6.119" class="difflineminus">-  // just a little helper method...maybe it should be a macro? which helps break down a imap message uri</span>
<a href="#l6.120"></a><span id="l6.120" class="difflineminus">-  // into the folder and message key equivalents</span>
<a href="#l6.121"></a><span id="l6.121" class="difflineminus">-  nsresult DecomposeImapURI(const nsACString &amp;aMessageURI, nsIMsgFolder **aFolder, nsACString &amp;msgKey);</span>
<a href="#l6.122"></a><span id="l6.122" class="difflineminus">-  nsresult DecomposeImapURI(const nsACString &amp;aMessageURI, nsIMsgFolder **aFolder, nsMsgKey *msgKey);</span>
<a href="#l6.123"></a><span id="l6.123" class="difflineminus">-</span>
<a href="#l6.124"></a><span id="l6.124" class="difflineplus">+  // just a little helper method...maybe it should be a macro? which helps break</span>
<a href="#l6.125"></a><span id="l6.125" class="difflineplus">+  // down a imap message uri into the folder and message key equivalents</span>
<a href="#l6.126"></a><span id="l6.126" class="difflineplus">+  nsresult DecomposeImapURI(const nsACString &amp;aMessageURI,</span>
<a href="#l6.127"></a><span id="l6.127" class="difflineplus">+                            nsIMsgFolder **aFolder, nsACString &amp;msgKey);</span>
<a href="#l6.128"></a><span id="l6.128" class="difflineplus">+  nsresult DecomposeImapURI(const nsACString &amp;aMessageURI,</span>
<a href="#l6.129"></a><span id="l6.129" class="difflineplus">+                            nsIMsgFolder **aFolder, nsMsgKey *msgKey);</span>
<a href="#l6.130"></a><span id="l6.130"> </span>
<a href="#l6.131"></a><span id="l6.131">   nsCOMPtr&lt;nsICacheStorage&gt; mCacheStorage;</span>
<a href="#l6.132"></a><span id="l6.132" class="difflineminus">-  bool mPrintingOperation;                // Flag for printing operations</span>
<a href="#l6.133"></a><span id="l6.133" class="difflineplus">+  bool mPrintingOperation;  // Flag for printing operations</span>
<a href="#l6.134"></a><span id="l6.134"> };</span>
<a href="#l6.135"></a><span id="l6.135"> </span>
<a href="#l6.136"></a><span id="l6.136"> #endif /* nsImapService_h___ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/imap/src/nsImapStringBundle.cpp</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapStringBundle.cpp</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -6,36 +6,32 @@</span>
<a href="#l7.4"></a><span id="l7.4"> #include &quot;prmem.h&quot;</span>
<a href="#l7.5"></a><span id="l7.5"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l7.6"></a><span id="l7.6"> #include &quot;nsString.h&quot;</span>
<a href="#l7.7"></a><span id="l7.7"> #include &quot;nsIStringBundle.h&quot;</span>
<a href="#l7.8"></a><span id="l7.8"> #include &quot;nsImapStringBundle.h&quot;</span>
<a href="#l7.9"></a><span id="l7.9"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l7.10"></a><span id="l7.10"> #include &quot;mozilla/Services.h&quot;</span>
<a href="#l7.11"></a><span id="l7.11"> </span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-#define IMAP_MSGS_URL       &quot;chrome://messenger/locale/imapMsgs.properties&quot;</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+#define IMAP_MSGS_URL &quot;chrome://messenger/locale/imapMsgs.properties&quot;</span>
<a href="#l7.14"></a><span id="l7.14"> </span>
<a href="#l7.15"></a><span id="l7.15" class="difflineminus">-extern &quot;C&quot;</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineminus">-nsresult</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineminus">-IMAPGetStringByName(const char* stringName, char16_t **aString)</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineminus">-{</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineminus">-  nsCOMPtr &lt;nsIStringBundle&gt; sBundle;</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineplus">+extern &quot;C&quot; nsresult IMAPGetStringByName(const char *stringName,</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineplus">+                                        char16_t **aString) {</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineplus">+  nsCOMPtr&lt;nsIStringBundle&gt; sBundle;</span>
<a href="#l7.23"></a><span id="l7.23">   nsresult rv = IMAPGetStringBundle(getter_AddRefs(sBundle));</span>
<a href="#l7.24"></a><span id="l7.24">   if (NS_SUCCEEDED(rv) &amp;&amp; sBundle) {</span>
<a href="#l7.25"></a><span id="l7.25">     nsAutoString string;</span>
<a href="#l7.26"></a><span id="l7.26">     rv = sBundle-&gt;GetStringFromName(stringName, string);</span>
<a href="#l7.27"></a><span id="l7.27">     *aString = ToNewUnicode(string);</span>
<a href="#l7.28"></a><span id="l7.28">   }</span>
<a href="#l7.29"></a><span id="l7.29">   return rv;</span>
<a href="#l7.30"></a><span id="l7.30"> }</span>
<a href="#l7.31"></a><span id="l7.31"> </span>
<a href="#l7.32"></a><span id="l7.32" class="difflineminus">-nsresult</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineminus">-IMAPGetStringBundle(nsIStringBundle **aBundle)</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineminus">-{</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineminus">-  nsresult rv=NS_OK;</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineplus">+nsresult IMAPGetStringBundle(nsIStringBundle **aBundle) {</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineplus">+  nsresult rv = NS_OK;</span>
<a href="#l7.38"></a><span id="l7.38">   nsCOMPtr&lt;nsIStringBundleService&gt; stringService =</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineminus">-    mozilla::services::GetStringBundleService();</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineplus">+      mozilla::services::GetStringBundleService();</span>
<a href="#l7.41"></a><span id="l7.41">   if (!stringService) return NS_ERROR_NULL_POINTER;</span>
<a href="#l7.42"></a><span id="l7.42">   nsCOMPtr&lt;nsIStringBundle&gt; stringBundle;</span>
<a href="#l7.43"></a><span id="l7.43">   rv = stringService-&gt;CreateBundle(IMAP_MSGS_URL, getter_AddRefs(stringBundle));</span>
<a href="#l7.44"></a><span id="l7.44">   stringBundle.forget(aBundle);</span>
<a href="#l7.45"></a><span id="l7.45">   return rv;</span>
<a href="#l7.46"></a><span id="l7.46"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/imap/src/nsImapStringBundle.h</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapStringBundle.h</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -4,14 +4,14 @@</span>
<a href="#l8.4"></a><span id="l8.4"> </span>
<a href="#l8.5"></a><span id="l8.5"> #ifndef _nsImapStringBundle_H__</span>
<a href="#l8.6"></a><span id="l8.6"> #define _nsImapStringBundle_H__</span>
<a href="#l8.7"></a><span id="l8.7"> </span>
<a href="#l8.8"></a><span id="l8.8"> #include &quot;nsIStringBundle.h&quot;</span>
<a href="#l8.9"></a><span id="l8.9"> </span>
<a href="#l8.10"></a><span id="l8.10"> PR_BEGIN_EXTERN_C</span>
<a href="#l8.11"></a><span id="l8.11"> </span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-nsresult      IMAPGetStringByName(const char* stringName, char16_t **aString);</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineminus">-nsresult      IMAPGetStringBundle(nsIStringBundle **aBundle);</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineplus">+nsresult IMAPGetStringByName(const char *stringName, char16_t **aString);</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineplus">+nsresult IMAPGetStringBundle(nsIStringBundle **aBundle);</span>
<a href="#l8.16"></a><span id="l8.16"> </span>
<a href="#l8.17"></a><span id="l8.17"> PR_END_EXTERN_C</span>
<a href="#l8.18"></a><span id="l8.18"> </span>
<a href="#l8.19"></a><span id="l8.19"> #endif /* _nsImapStringBundle_H__ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/imap/src/nsImapUndoTxn.cpp</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapUndoTxn.cpp</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -1,37 +1,35 @@</span>
<a href="#l9.4"></a><span id="l9.4"> /* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l9.5"></a><span id="l9.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l9.6"></a><span id="l9.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l9.7"></a><span id="l9.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l9.8"></a><span id="l9.8"> </span>
<a href="#l9.9"></a><span id="l9.9" class="difflineminus">-#include &quot;msgCore.h&quot; // for precompiled headers</span>
<a href="#l9.10"></a><span id="l9.10" class="difflineplus">+#include &quot;msgCore.h&quot;  // for precompiled headers</span>
<a href="#l9.11"></a><span id="l9.11"> #include &quot;nsMsgImapCID.h&quot;</span>
<a href="#l9.12"></a><span id="l9.12"> #include &quot;nsIMsgHdr.h&quot;</span>
<a href="#l9.13"></a><span id="l9.13"> #include &quot;nsImapUndoTxn.h&quot;</span>
<a href="#l9.14"></a><span id="l9.14"> #include &quot;nsIMsgIncomingServer.h&quot;</span>
<a href="#l9.15"></a><span id="l9.15"> #include &quot;nsImapMailFolder.h&quot;</span>
<a href="#l9.16"></a><span id="l9.16"> #include &quot;nsIImapService.h&quot;</span>
<a href="#l9.17"></a><span id="l9.17"> #include &quot;nsIDBFolderInfo.h&quot;</span>
<a href="#l9.18"></a><span id="l9.18"> #include &quot;nsIMsgDatabase.h&quot;</span>
<a href="#l9.19"></a><span id="l9.19"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l9.20"></a><span id="l9.20"> #include &quot;nsThreadUtils.h&quot;</span>
<a href="#l9.21"></a><span id="l9.21"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l9.22"></a><span id="l9.22"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l9.23"></a><span id="l9.23"> </span>
<a href="#l9.24"></a><span id="l9.24" class="difflineminus">-nsImapMoveCopyMsgTxn::nsImapMoveCopyMsgTxn() :</span>
<a href="#l9.25"></a><span id="l9.25" class="difflineminus">-    m_idsAreUids(false), m_isMove(false), m_srcIsPop3(false)</span>
<a href="#l9.26"></a><span id="l9.26" class="difflineminus">-{</span>
<a href="#l9.27"></a><span id="l9.27" class="difflineminus">-}</span>
<a href="#l9.28"></a><span id="l9.28" class="difflineplus">+nsImapMoveCopyMsgTxn::nsImapMoveCopyMsgTxn()</span>
<a href="#l9.29"></a><span id="l9.29" class="difflineplus">+    : m_idsAreUids(false), m_isMove(false), m_srcIsPop3(false) {}</span>
<a href="#l9.30"></a><span id="l9.30"> </span>
<a href="#l9.31"></a><span id="l9.31" class="difflineminus">-nsresult</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineminus">-nsImapMoveCopyMsgTxn::Init(nsIMsgFolder* srcFolder, nsTArray&lt;nsMsgKey&gt;* srcKeyArray,</span>
<a href="#l9.33"></a><span id="l9.33" class="difflineminus">-                           const char* srcMsgIdString, nsIMsgFolder* dstFolder,</span>
<a href="#l9.34"></a><span id="l9.34" class="difflineminus">-                           bool idsAreUids, bool isMove)</span>
<a href="#l9.35"></a><span id="l9.35" class="difflineminus">-{</span>
<a href="#l9.36"></a><span id="l9.36" class="difflineplus">+nsresult nsImapMoveCopyMsgTxn::Init(nsIMsgFolder* srcFolder,</span>
<a href="#l9.37"></a><span id="l9.37" class="difflineplus">+                                    nsTArray&lt;nsMsgKey&gt;* srcKeyArray,</span>
<a href="#l9.38"></a><span id="l9.38" class="difflineplus">+                                    const char* srcMsgIdString,</span>
<a href="#l9.39"></a><span id="l9.39" class="difflineplus">+                                    nsIMsgFolder* dstFolder, bool idsAreUids,</span>
<a href="#l9.40"></a><span id="l9.40" class="difflineplus">+                                    bool isMove) {</span>
<a href="#l9.41"></a><span id="l9.41">   m_srcMsgIdString = srcMsgIdString;</span>
<a href="#l9.42"></a><span id="l9.42">   m_idsAreUids = idsAreUids;</span>
<a href="#l9.43"></a><span id="l9.43">   m_isMove = isMove;</span>
<a href="#l9.44"></a><span id="l9.44">   m_srcFolder = do_GetWeakReference(srcFolder);</span>
<a href="#l9.45"></a><span id="l9.45">   m_dstFolder = do_GetWeakReference(dstFolder);</span>
<a href="#l9.46"></a><span id="l9.46">   m_srcKeyArray = *srcKeyArray;</span>
<a href="#l9.47"></a><span id="l9.47">   m_dupKeyArray = *srcKeyArray;</span>
<a href="#l9.48"></a><span id="l9.48">   nsCString uri;</span>
<a href="#l9.49"></a><span id="l9.49" class="difflineat">@@ -41,703 +39,596 @@ nsImapMoveCopyMsgTxn::Init(nsIMsgFolder*</span>
<a href="#l9.50"></a><span id="l9.50">   nsCOMPtr&lt;nsIMsgDatabase&gt; srcDB;</span>
<a href="#l9.51"></a><span id="l9.51">   rv = srcFolder-&gt;GetMsgDatabase(getter_AddRefs(srcDB));</span>
<a href="#l9.52"></a><span id="l9.52">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.53"></a><span id="l9.53">   uint32_t i, count = m_srcKeyArray.Length();</span>
<a href="#l9.54"></a><span id="l9.54">   nsCOMPtr&lt;nsIMsgDBHdr&gt; srcHdr;</span>
<a href="#l9.55"></a><span id="l9.55">   nsCOMPtr&lt;nsIMsgDBHdr&gt; copySrcHdr;</span>
<a href="#l9.56"></a><span id="l9.56">   nsCString messageId;</span>
<a href="#l9.57"></a><span id="l9.57"> </span>
<a href="#l9.58"></a><span id="l9.58" class="difflineminus">-  for (i = 0; i &lt; count; i++)</span>
<a href="#l9.59"></a><span id="l9.59" class="difflineminus">-  {</span>
<a href="#l9.60"></a><span id="l9.60" class="difflineminus">-    rv = srcDB-&gt;GetMsgHdrForKey(m_srcKeyArray[i],</span>
<a href="#l9.61"></a><span id="l9.61" class="difflineminus">-      getter_AddRefs(srcHdr));</span>
<a href="#l9.62"></a><span id="l9.62" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l9.63"></a><span id="l9.63" class="difflineminus">-    {</span>
<a href="#l9.64"></a><span id="l9.64" class="difflineplus">+  for (i = 0; i &lt; count; i++) {</span>
<a href="#l9.65"></a><span id="l9.65" class="difflineplus">+    rv = srcDB-&gt;GetMsgHdrForKey(m_srcKeyArray[i], getter_AddRefs(srcHdr));</span>
<a href="#l9.66"></a><span id="l9.66" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l9.67"></a><span id="l9.67">       // ** jt -- only do this for mailbox protocol</span>
<a href="#l9.68"></a><span id="l9.68" class="difflineminus">-      if (MsgLowerCaseEqualsLiteral(protocolType, &quot;mailbox&quot;))</span>
<a href="#l9.69"></a><span id="l9.69" class="difflineminus">-      {</span>
<a href="#l9.70"></a><span id="l9.70" class="difflineplus">+      if (MsgLowerCaseEqualsLiteral(protocolType, &quot;mailbox&quot;)) {</span>
<a href="#l9.71"></a><span id="l9.71">         m_srcIsPop3 = true;</span>
<a href="#l9.72"></a><span id="l9.72">         uint32_t msgSize;</span>
<a href="#l9.73"></a><span id="l9.73">         rv = srcHdr-&gt;GetMessageSize(&amp;msgSize);</span>
<a href="#l9.74"></a><span id="l9.74" class="difflineminus">-        if (NS_SUCCEEDED(rv))</span>
<a href="#l9.75"></a><span id="l9.75" class="difflineminus">-          m_srcSizeArray.AppendElement(msgSize);</span>
<a href="#l9.76"></a><span id="l9.76" class="difflineminus">-        if (isMove)</span>
<a href="#l9.77"></a><span id="l9.77" class="difflineminus">-        {</span>
<a href="#l9.78"></a><span id="l9.78" class="difflineplus">+        if (NS_SUCCEEDED(rv)) m_srcSizeArray.AppendElement(msgSize);</span>
<a href="#l9.79"></a><span id="l9.79" class="difflineplus">+        if (isMove) {</span>
<a href="#l9.80"></a><span id="l9.80">           rv = srcDB-&gt;CopyHdrFromExistingHdr(nsMsgKey_None, srcHdr, false,</span>
<a href="#l9.81"></a><span id="l9.81">                                              getter_AddRefs(copySrcHdr));</span>
<a href="#l9.82"></a><span id="l9.82">           nsMsgKey pseudoKey = nsMsgKey_None;</span>
<a href="#l9.83"></a><span id="l9.83" class="difflineminus">-          if (NS_SUCCEEDED(rv))</span>
<a href="#l9.84"></a><span id="l9.84" class="difflineminus">-          {</span>
<a href="#l9.85"></a><span id="l9.85" class="difflineplus">+          if (NS_SUCCEEDED(rv)) {</span>
<a href="#l9.86"></a><span id="l9.86">             copySrcHdr-&gt;GetMessageKey(&amp;pseudoKey);</span>
<a href="#l9.87"></a><span id="l9.87">             m_srcHdrs.AppendObject(copySrcHdr);</span>
<a href="#l9.88"></a><span id="l9.88">           }</span>
<a href="#l9.89"></a><span id="l9.89">           m_dupKeyArray[i] = pseudoKey;</span>
<a href="#l9.90"></a><span id="l9.90">         }</span>
<a href="#l9.91"></a><span id="l9.91">       }</span>
<a href="#l9.92"></a><span id="l9.92">       srcHdr-&gt;GetMessageId(getter_Copies(messageId));</span>
<a href="#l9.93"></a><span id="l9.93">       m_srcMessageIds.AppendElement(messageId);</span>
<a href="#l9.94"></a><span id="l9.94">     }</span>
<a href="#l9.95"></a><span id="l9.95">   }</span>
<a href="#l9.96"></a><span id="l9.96">   return nsMsgTxn::Init();</span>
<a href="#l9.97"></a><span id="l9.97"> }</span>
<a href="#l9.98"></a><span id="l9.98"> </span>
<a href="#l9.99"></a><span id="l9.99" class="difflineminus">-nsImapMoveCopyMsgTxn::~nsImapMoveCopyMsgTxn()</span>
<a href="#l9.100"></a><span id="l9.100" class="difflineminus">-{</span>
<a href="#l9.101"></a><span id="l9.101" class="difflineminus">-}</span>
<a href="#l9.102"></a><span id="l9.102" class="difflineplus">+nsImapMoveCopyMsgTxn::~nsImapMoveCopyMsgTxn() {}</span>
<a href="#l9.103"></a><span id="l9.103"> </span>
<a href="#l9.104"></a><span id="l9.104"> NS_IMPL_ISUPPORTS_INHERITED(nsImapMoveCopyMsgTxn, nsMsgTxn, nsIUrlListener)</span>
<a href="#l9.105"></a><span id="l9.105"> </span>
<a href="#l9.106"></a><span id="l9.106"> NS_IMETHODIMP</span>
<a href="#l9.107"></a><span id="l9.107" class="difflineminus">-nsImapMoveCopyMsgTxn::UndoTransaction(void)</span>
<a href="#l9.108"></a><span id="l9.108" class="difflineminus">-{</span>
<a href="#l9.109"></a><span id="l9.109" class="difflineplus">+nsImapMoveCopyMsgTxn::UndoTransaction(void) {</span>
<a href="#l9.110"></a><span id="l9.110">   nsresult rv;</span>
<a href="#l9.111"></a><span id="l9.111" class="difflineminus">-  nsCOMPtr&lt;nsIImapService&gt; imapService = do_GetService(NS_IMAPSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l9.112"></a><span id="l9.112" class="difflineplus">+  nsCOMPtr&lt;nsIImapService&gt; imapService =</span>
<a href="#l9.113"></a><span id="l9.113" class="difflineplus">+      do_GetService(NS_IMAPSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l9.114"></a><span id="l9.114">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.115"></a><span id="l9.115"> </span>
<a href="#l9.116"></a><span id="l9.116">   bool finishInOnStopRunningUrl = false;</span>
<a href="#l9.117"></a><span id="l9.117"> </span>
<a href="#l9.118"></a><span id="l9.118" class="difflineminus">-  if (m_isMove || !m_dstFolder)</span>
<a href="#l9.119"></a><span id="l9.119" class="difflineminus">-  {</span>
<a href="#l9.120"></a><span id="l9.120" class="difflineminus">-    if (m_srcIsPop3)</span>
<a href="#l9.121"></a><span id="l9.121" class="difflineminus">-    {</span>
<a href="#l9.122"></a><span id="l9.122" class="difflineplus">+  if (m_isMove || !m_dstFolder) {</span>
<a href="#l9.123"></a><span id="l9.123" class="difflineplus">+    if (m_srcIsPop3) {</span>
<a href="#l9.124"></a><span id="l9.124">       rv = UndoMailboxDelete();</span>
<a href="#l9.125"></a><span id="l9.125">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.126"></a><span id="l9.126" class="difflineminus">-    }</span>
<a href="#l9.127"></a><span id="l9.127" class="difflineminus">-    else</span>
<a href="#l9.128"></a><span id="l9.128" class="difflineminus">-    {</span>
<a href="#l9.129"></a><span id="l9.129" class="difflineplus">+    } else {</span>
<a href="#l9.130"></a><span id="l9.130">       nsCOMPtr&lt;nsIMsgFolder&gt; srcFolder = do_QueryReferent(m_srcFolder, &amp;rv);</span>
<a href="#l9.131"></a><span id="l9.131" class="difflineminus">-      if (NS_FAILED(rv) || !srcFolder)</span>
<a href="#l9.132"></a><span id="l9.132" class="difflineminus">-        return rv;</span>
<a href="#l9.133"></a><span id="l9.133" class="difflineplus">+      if (NS_FAILED(rv) || !srcFolder) return rv;</span>
<a href="#l9.134"></a><span id="l9.134">       nsCOMPtr&lt;nsIUrlListener&gt; srcListener = do_QueryInterface(srcFolder, &amp;rv);</span>
<a href="#l9.135"></a><span id="l9.135" class="difflineminus">-      if (NS_FAILED(rv))</span>
<a href="#l9.136"></a><span id="l9.136" class="difflineminus">-        return rv;</span>
<a href="#l9.137"></a><span id="l9.137" class="difflineminus">-      m_onStopListener =   do_GetWeakReference(srcListener);</span>
<a href="#l9.138"></a><span id="l9.138" class="difflineplus">+      if (NS_FAILED(rv)) return rv;</span>
<a href="#l9.139"></a><span id="l9.139" class="difflineplus">+      m_onStopListener = do_GetWeakReference(srcListener);</span>
<a href="#l9.140"></a><span id="l9.140"> </span>
<a href="#l9.141"></a><span id="l9.141">       // ** make sure we are in the selected state; use lite select</span>
<a href="#l9.142"></a><span id="l9.142">       // folder so we won't hit performance hard</span>
<a href="#l9.143"></a><span id="l9.143" class="difflineminus">-      rv = imapService-&gt;LiteSelectFolder(srcFolder, srcListener, nullptr, nullptr);</span>
<a href="#l9.144"></a><span id="l9.144" class="difflineminus">-      if (NS_FAILED(rv))</span>
<a href="#l9.145"></a><span id="l9.145" class="difflineminus">-        return rv;</span>
<a href="#l9.146"></a><span id="l9.146" class="difflineminus">-      bool deletedMsgs = true; //default is true unless imapDelete model</span>
<a href="#l9.147"></a><span id="l9.147" class="difflineplus">+      rv = imapService-&gt;LiteSelectFolder(srcFolder, srcListener, nullptr,</span>
<a href="#l9.148"></a><span id="l9.148" class="difflineplus">+                                         nullptr);</span>
<a href="#l9.149"></a><span id="l9.149" class="difflineplus">+      if (NS_FAILED(rv)) return rv;</span>
<a href="#l9.150"></a><span id="l9.150" class="difflineplus">+      bool deletedMsgs = true;  // default is true unless imapDelete model</span>
<a href="#l9.151"></a><span id="l9.151">       nsMsgImapDeleteModel deleteModel;</span>
<a href="#l9.152"></a><span id="l9.152">       rv = GetImapDeleteModel(srcFolder, &amp;deleteModel);</span>
<a href="#l9.153"></a><span id="l9.153"> </span>
<a href="#l9.154"></a><span id="l9.154">       // protect against a bogus undo txn without any source keys</span>
<a href="#l9.155"></a><span id="l9.155">       // see bug #179856 for details</span>
<a href="#l9.156"></a><span id="l9.156">       NS_ASSERTION(!m_srcKeyArray.IsEmpty(), &quot;no source keys&quot;);</span>
<a href="#l9.157"></a><span id="l9.157" class="difflineminus">-      if (m_srcKeyArray.IsEmpty())</span>
<a href="#l9.158"></a><span id="l9.158" class="difflineminus">-        return NS_ERROR_UNEXPECTED;</span>
<a href="#l9.159"></a><span id="l9.159" class="difflineplus">+      if (m_srcKeyArray.IsEmpty()) return NS_ERROR_UNEXPECTED;</span>
<a href="#l9.160"></a><span id="l9.160"> </span>
<a href="#l9.161"></a><span id="l9.161" class="difflineminus">-      if (!m_srcMsgIdString.IsEmpty())</span>
<a href="#l9.162"></a><span id="l9.162" class="difflineminus">-      {</span>
<a href="#l9.163"></a><span id="l9.163" class="difflineminus">-        if (NS_SUCCEEDED(rv) &amp;&amp; deleteModel == nsMsgImapDeleteModels::IMAPDelete)</span>
<a href="#l9.164"></a><span id="l9.164" class="difflineplus">+      if (!m_srcMsgIdString.IsEmpty()) {</span>
<a href="#l9.165"></a><span id="l9.165" class="difflineplus">+        if (NS_SUCCEEDED(rv) &amp;&amp;</span>
<a href="#l9.166"></a><span id="l9.166" class="difflineplus">+            deleteModel == nsMsgImapDeleteModels::IMAPDelete)</span>
<a href="#l9.167"></a><span id="l9.167">           CheckForToggleDelete(srcFolder, m_srcKeyArray[0], &amp;deletedMsgs);</span>
<a href="#l9.168"></a><span id="l9.168"> </span>
<a href="#l9.169"></a><span id="l9.169">         if (deletedMsgs)</span>
<a href="#l9.170"></a><span id="l9.170" class="difflineminus">-          rv = imapService-&gt;SubtractMessageFlags(srcFolder,</span>
<a href="#l9.171"></a><span id="l9.171" class="difflineminus">-                                                 this, nullptr,</span>
<a href="#l9.172"></a><span id="l9.172" class="difflineminus">-                                                 m_srcMsgIdString,</span>
<a href="#l9.173"></a><span id="l9.173" class="difflineminus">-                                                 kImapMsgDeletedFlag,</span>
<a href="#l9.174"></a><span id="l9.174" class="difflineminus">-                                                 m_idsAreUids);</span>
<a href="#l9.175"></a><span id="l9.175" class="difflineplus">+          rv = imapService-&gt;SubtractMessageFlags(</span>
<a href="#l9.176"></a><span id="l9.176" class="difflineplus">+              srcFolder, this, nullptr, m_srcMsgIdString, kImapMsgDeletedFlag,</span>
<a href="#l9.177"></a><span id="l9.177" class="difflineplus">+              m_idsAreUids);</span>
<a href="#l9.178"></a><span id="l9.178">         else</span>
<a href="#l9.179"></a><span id="l9.179" class="difflineminus">-          rv = imapService-&gt;AddMessageFlags(srcFolder,</span>
<a href="#l9.180"></a><span id="l9.180" class="difflineminus">-                                            srcListener, nullptr,</span>
<a href="#l9.181"></a><span id="l9.181" class="difflineplus">+          rv = imapService-&gt;AddMessageFlags(srcFolder, srcListener, nullptr,</span>
<a href="#l9.182"></a><span id="l9.182">                                             m_srcMsgIdString,</span>
<a href="#l9.183"></a><span id="l9.183" class="difflineminus">-                                            kImapMsgDeletedFlag,</span>
<a href="#l9.184"></a><span id="l9.184" class="difflineminus">-                                            m_idsAreUids);</span>
<a href="#l9.185"></a><span id="l9.185" class="difflineminus">-        if (NS_FAILED(rv))</span>
<a href="#l9.186"></a><span id="l9.186" class="difflineminus">-          return rv;</span>
<a href="#l9.187"></a><span id="l9.187" class="difflineplus">+                                            kImapMsgDeletedFlag, m_idsAreUids);</span>
<a href="#l9.188"></a><span id="l9.188" class="difflineplus">+        if (NS_FAILED(rv)) return rv;</span>
<a href="#l9.189"></a><span id="l9.189"> </span>
<a href="#l9.190"></a><span id="l9.190">         finishInOnStopRunningUrl = true;</span>
<a href="#l9.191"></a><span id="l9.191">         if (deleteModel != nsMsgImapDeleteModels::IMAPDelete)</span>
<a href="#l9.192"></a><span id="l9.192">           rv = imapService-&gt;GetHeaders(srcFolder, srcListener, nullptr,</span>
<a href="#l9.193"></a><span id="l9.193">                                        m_srcMsgIdString, true);</span>
<a href="#l9.194"></a><span id="l9.194">       }</span>
<a href="#l9.195"></a><span id="l9.195">     }</span>
<a href="#l9.196"></a><span id="l9.196">   }</span>
<a href="#l9.197"></a><span id="l9.197" class="difflineminus">-  if (!finishInOnStopRunningUrl &amp;&amp; !m_dstMsgIdString.IsEmpty())</span>
<a href="#l9.198"></a><span id="l9.198" class="difflineminus">-  {</span>
<a href="#l9.199"></a><span id="l9.199" class="difflineplus">+  if (!finishInOnStopRunningUrl &amp;&amp; !m_dstMsgIdString.IsEmpty()) {</span>
<a href="#l9.200"></a><span id="l9.200">     nsCOMPtr&lt;nsIMsgFolder&gt; dstFolder = do_QueryReferent(m_dstFolder, &amp;rv);</span>
<a href="#l9.201"></a><span id="l9.201" class="difflineminus">-    if (NS_FAILED(rv) || !dstFolder)</span>
<a href="#l9.202"></a><span id="l9.202" class="difflineminus">-      return rv;</span>
<a href="#l9.203"></a><span id="l9.203" class="difflineplus">+    if (NS_FAILED(rv) || !dstFolder) return rv;</span>
<a href="#l9.204"></a><span id="l9.204"> </span>
<a href="#l9.205"></a><span id="l9.205">     nsCOMPtr&lt;nsIUrlListener&gt; dstListener;</span>
<a href="#l9.206"></a><span id="l9.206"> </span>
<a href="#l9.207"></a><span id="l9.207">     dstListener = do_QueryInterface(dstFolder, &amp;rv);</span>
<a href="#l9.208"></a><span id="l9.208">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.209"></a><span id="l9.209">     // ** make sure we are in the selected state; use lite select folder</span>
<a href="#l9.210"></a><span id="l9.210">     // so we won't potentially download a bunch of headers.</span>
<a href="#l9.211"></a><span id="l9.211" class="difflineminus">-    rv = imapService-&gt;LiteSelectFolder(dstFolder,</span>
<a href="#l9.212"></a><span id="l9.212" class="difflineminus">-      dstListener, nullptr, nullptr);</span>
<a href="#l9.213"></a><span id="l9.213" class="difflineplus">+    rv =</span>
<a href="#l9.214"></a><span id="l9.214" class="difflineplus">+        imapService-&gt;LiteSelectFolder(dstFolder, dstListener, nullptr, nullptr);</span>
<a href="#l9.215"></a><span id="l9.215">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.216"></a><span id="l9.216" class="difflineminus">-    rv = imapService-&gt;AddMessageFlags(dstFolder, dstListener,</span>
<a href="#l9.217"></a><span id="l9.217" class="difflineminus">-                                      nullptr, m_dstMsgIdString,</span>
<a href="#l9.218"></a><span id="l9.218" class="difflineminus">-                                      kImapMsgDeletedFlag, m_idsAreUids);</span>
<a href="#l9.219"></a><span id="l9.219" class="difflineplus">+    rv = imapService-&gt;AddMessageFlags(dstFolder, dstListener, nullptr,</span>
<a href="#l9.220"></a><span id="l9.220" class="difflineplus">+                                      m_dstMsgIdString, kImapMsgDeletedFlag,</span>
<a href="#l9.221"></a><span id="l9.221" class="difflineplus">+                                      m_idsAreUids);</span>
<a href="#l9.222"></a><span id="l9.222">   }</span>
<a href="#l9.223"></a><span id="l9.223">   return rv;</span>
<a href="#l9.224"></a><span id="l9.224"> }</span>
<a href="#l9.225"></a><span id="l9.225"> </span>
<a href="#l9.226"></a><span id="l9.226"> NS_IMETHODIMP</span>
<a href="#l9.227"></a><span id="l9.227" class="difflineminus">-nsImapMoveCopyMsgTxn::RedoTransaction(void)</span>
<a href="#l9.228"></a><span id="l9.228" class="difflineminus">-{</span>
<a href="#l9.229"></a><span id="l9.229" class="difflineplus">+nsImapMoveCopyMsgTxn::RedoTransaction(void) {</span>
<a href="#l9.230"></a><span id="l9.230">   nsresult rv;</span>
<a href="#l9.231"></a><span id="l9.231" class="difflineminus">-  nsCOMPtr&lt;nsIImapService&gt; imapService = do_GetService(NS_IMAPSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l9.232"></a><span id="l9.232" class="difflineplus">+  nsCOMPtr&lt;nsIImapService&gt; imapService =</span>
<a href="#l9.233"></a><span id="l9.233" class="difflineplus">+      do_GetService(NS_IMAPSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l9.234"></a><span id="l9.234">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.235"></a><span id="l9.235"> </span>
<a href="#l9.236"></a><span id="l9.236" class="difflineminus">-  if (m_isMove || !m_dstFolder)</span>
<a href="#l9.237"></a><span id="l9.237" class="difflineminus">-  {</span>
<a href="#l9.238"></a><span id="l9.238" class="difflineminus">-    if (m_srcIsPop3)</span>
<a href="#l9.239"></a><span id="l9.239" class="difflineminus">-    {</span>
<a href="#l9.240"></a><span id="l9.240" class="difflineplus">+  if (m_isMove || !m_dstFolder) {</span>
<a href="#l9.241"></a><span id="l9.241" class="difflineplus">+    if (m_srcIsPop3) {</span>
<a href="#l9.242"></a><span id="l9.242">       rv = RedoMailboxDelete();</span>
<a href="#l9.243"></a><span id="l9.243">       if (NS_FAILED(rv)) return rv;</span>
<a href="#l9.244"></a><span id="l9.244" class="difflineminus">-    }</span>
<a href="#l9.245"></a><span id="l9.245" class="difflineminus">-    else if (!m_srcMsgIdString.IsEmpty())</span>
<a href="#l9.246"></a><span id="l9.246" class="difflineminus">-    {</span>
<a href="#l9.247"></a><span id="l9.247" class="difflineplus">+    } else if (!m_srcMsgIdString.IsEmpty()) {</span>
<a href="#l9.248"></a><span id="l9.248">       nsCOMPtr&lt;nsIMsgFolder&gt; srcFolder = do_QueryReferent(m_srcFolder, &amp;rv);</span>
<a href="#l9.249"></a><span id="l9.249" class="difflineminus">-      if (NS_FAILED(rv) || !srcFolder)</span>
<a href="#l9.250"></a><span id="l9.250" class="difflineminus">-        return rv;</span>
<a href="#l9.251"></a><span id="l9.251" class="difflineplus">+      if (NS_FAILED(rv) || !srcFolder) return rv;</span>
<a href="#l9.252"></a><span id="l9.252">       nsCOMPtr&lt;nsIUrlListener&gt; srcListener = do_QueryInterface(srcFolder, &amp;rv);</span>
<a href="#l9.253"></a><span id="l9.253">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.254"></a><span id="l9.254"> </span>
<a href="#l9.255"></a><span id="l9.255" class="difflineminus">-      bool deletedMsgs = false;  //default will be false unless imapDeleteModel;</span>
<a href="#l9.256"></a><span id="l9.256" class="difflineplus">+      bool deletedMsgs = false;  // default will be false unless</span>
<a href="#l9.257"></a><span id="l9.257" class="difflineplus">+                                 // imapDeleteModel;</span>
<a href="#l9.258"></a><span id="l9.258">       nsMsgImapDeleteModel deleteModel;</span>
<a href="#l9.259"></a><span id="l9.259">       rv = GetImapDeleteModel(srcFolder, &amp;deleteModel);</span>
<a href="#l9.260"></a><span id="l9.260"> </span>
<a href="#l9.261"></a><span id="l9.261">       // protect against a bogus undo txn without any source keys</span>
<a href="#l9.262"></a><span id="l9.262">       // see bug #179856 for details</span>
<a href="#l9.263"></a><span id="l9.263">       NS_ASSERTION(!m_srcKeyArray.IsEmpty(), &quot;no source keys&quot;);</span>
<a href="#l9.264"></a><span id="l9.264" class="difflineminus">-      if (m_srcKeyArray.IsEmpty())</span>
<a href="#l9.265"></a><span id="l9.265" class="difflineminus">-        return NS_ERROR_UNEXPECTED;</span>
<a href="#l9.266"></a><span id="l9.266" class="difflineplus">+      if (m_srcKeyArray.IsEmpty()) return NS_ERROR_UNEXPECTED;</span>
<a href="#l9.267"></a><span id="l9.267"> </span>
<a href="#l9.268"></a><span id="l9.268">       if (NS_SUCCEEDED(rv) &amp;&amp; deleteModel == nsMsgImapDeleteModels::IMAPDelete)</span>
<a href="#l9.269"></a><span id="l9.269">         rv = CheckForToggleDelete(srcFolder, m_srcKeyArray[0], &amp;deletedMsgs);</span>
<a href="#l9.270"></a><span id="l9.270"> </span>
<a href="#l9.271"></a><span id="l9.271">       // Make sure we are in the selected state; use lite select</span>
<a href="#l9.272"></a><span id="l9.272">       // folder so performance won't suffer.</span>
<a href="#l9.273"></a><span id="l9.273" class="difflineminus">-      rv = imapService-&gt;LiteSelectFolder(srcFolder, srcListener, nullptr, nullptr);</span>
<a href="#l9.274"></a><span id="l9.274" class="difflineplus">+      rv = imapService-&gt;LiteSelectFolder(srcFolder, srcListener, nullptr,</span>
<a href="#l9.275"></a><span id="l9.275" class="difflineplus">+                                         nullptr);</span>
<a href="#l9.276"></a><span id="l9.276">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.277"></a><span id="l9.277" class="difflineminus">-      if (deletedMsgs)</span>
<a href="#l9.278"></a><span id="l9.278" class="difflineminus">-      {</span>
<a href="#l9.279"></a><span id="l9.279" class="difflineminus">-        rv = imapService-&gt;SubtractMessageFlags(srcFolder,</span>
<a href="#l9.280"></a><span id="l9.280" class="difflineminus">-                                               srcListener, nullptr,</span>
<a href="#l9.281"></a><span id="l9.281" class="difflineminus">-                                               m_srcMsgIdString,</span>
<a href="#l9.282"></a><span id="l9.282" class="difflineminus">-                                               kImapMsgDeletedFlag,</span>
<a href="#l9.283"></a><span id="l9.283" class="difflineminus">-                                               m_idsAreUids);</span>
<a href="#l9.284"></a><span id="l9.284" class="difflineminus">-      }</span>
<a href="#l9.285"></a><span id="l9.285" class="difflineminus">-      else</span>
<a href="#l9.286"></a><span id="l9.286" class="difflineminus">-      {</span>
<a href="#l9.287"></a><span id="l9.287" class="difflineminus">-        rv = imapService-&gt;AddMessageFlags(srcFolder,</span>
<a href="#l9.288"></a><span id="l9.288" class="difflineminus">-                                          srcListener, nullptr, m_srcMsgIdString,</span>
<a href="#l9.289"></a><span id="l9.289" class="difflineminus">-                                          kImapMsgDeletedFlag, m_idsAreUids);</span>
<a href="#l9.290"></a><span id="l9.290" class="difflineplus">+      if (deletedMsgs) {</span>
<a href="#l9.291"></a><span id="l9.291" class="difflineplus">+        rv = imapService-&gt;SubtractMessageFlags(</span>
<a href="#l9.292"></a><span id="l9.292" class="difflineplus">+            srcFolder, srcListener, nullptr, m_srcMsgIdString,</span>
<a href="#l9.293"></a><span id="l9.293" class="difflineplus">+            kImapMsgDeletedFlag, m_idsAreUids);</span>
<a href="#l9.294"></a><span id="l9.294" class="difflineplus">+      } else {</span>
<a href="#l9.295"></a><span id="l9.295" class="difflineplus">+        rv = imapService-&gt;AddMessageFlags(srcFolder, srcListener, nullptr,</span>
<a href="#l9.296"></a><span id="l9.296" class="difflineplus">+                                          m_srcMsgIdString, kImapMsgDeletedFlag,</span>
<a href="#l9.297"></a><span id="l9.297" class="difflineplus">+                                          m_idsAreUids);</span>
<a href="#l9.298"></a><span id="l9.298">       }</span>
<a href="#l9.299"></a><span id="l9.299">     }</span>
<a href="#l9.300"></a><span id="l9.300">   }</span>
<a href="#l9.301"></a><span id="l9.301" class="difflineminus">-  if (!m_dstMsgIdString.IsEmpty())</span>
<a href="#l9.302"></a><span id="l9.302" class="difflineminus">-  {</span>
<a href="#l9.303"></a><span id="l9.303" class="difflineplus">+  if (!m_dstMsgIdString.IsEmpty()) {</span>
<a href="#l9.304"></a><span id="l9.304">     nsCOMPtr&lt;nsIMsgFolder&gt; dstFolder = do_QueryReferent(m_dstFolder, &amp;rv);</span>
<a href="#l9.305"></a><span id="l9.305">     if (NS_FAILED(rv) || !dstFolder) return rv;</span>
<a href="#l9.306"></a><span id="l9.306"> </span>
<a href="#l9.307"></a><span id="l9.307">     nsCOMPtr&lt;nsIUrlListener&gt; dstListener;</span>
<a href="#l9.308"></a><span id="l9.308"> </span>
<a href="#l9.309"></a><span id="l9.309">     dstListener = do_QueryInterface(dstFolder, &amp;rv);</span>
<a href="#l9.310"></a><span id="l9.310">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.311"></a><span id="l9.311">     // ** make sure we are in the selected state; use lite select</span>
<a href="#l9.312"></a><span id="l9.312">     // folder so we won't hit performance hard</span>
<a href="#l9.313"></a><span id="l9.313" class="difflineminus">-    rv = imapService-&gt;LiteSelectFolder(dstFolder, dstListener, nullptr, nullptr);</span>
<a href="#l9.314"></a><span id="l9.314" class="difflineplus">+    rv =</span>
<a href="#l9.315"></a><span id="l9.315" class="difflineplus">+        imapService-&gt;LiteSelectFolder(dstFolder, dstListener, nullptr, nullptr);</span>
<a href="#l9.316"></a><span id="l9.316">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.317"></a><span id="l9.317" class="difflineminus">-    rv = imapService-&gt;SubtractMessageFlags(dstFolder,</span>
<a href="#l9.318"></a><span id="l9.318" class="difflineminus">-                                           dstListener, nullptr,</span>
<a href="#l9.319"></a><span id="l9.319" class="difflineplus">+    rv = imapService-&gt;SubtractMessageFlags(dstFolder, dstListener, nullptr,</span>
<a href="#l9.320"></a><span id="l9.320">                                            m_dstMsgIdString,</span>
<a href="#l9.321"></a><span id="l9.321" class="difflineminus">-                                           kImapMsgDeletedFlag,</span>
<a href="#l9.322"></a><span id="l9.322" class="difflineminus">-                                           m_idsAreUids);</span>
<a href="#l9.323"></a><span id="l9.323" class="difflineplus">+                                           kImapMsgDeletedFlag, m_idsAreUids);</span>
<a href="#l9.324"></a><span id="l9.324">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.325"></a><span id="l9.325">     nsMsgImapDeleteModel deleteModel;</span>
<a href="#l9.326"></a><span id="l9.326">     rv = GetImapDeleteModel(dstFolder, &amp;deleteModel);</span>
<a href="#l9.327"></a><span id="l9.327" class="difflineminus">-    if (NS_FAILED(rv) || deleteModel == nsMsgImapDeleteModels::MoveToTrash)</span>
<a href="#l9.328"></a><span id="l9.328" class="difflineminus">-    {</span>
<a href="#l9.329"></a><span id="l9.329" class="difflineminus">-      rv = imapService-&gt;GetHeaders(dstFolder, dstListener,</span>
<a href="#l9.330"></a><span id="l9.330" class="difflineminus">-                                   nullptr, m_dstMsgIdString, true);</span>
<a href="#l9.331"></a><span id="l9.331" class="difflineplus">+    if (NS_FAILED(rv) || deleteModel == nsMsgImapDeleteModels::MoveToTrash) {</span>
<a href="#l9.332"></a><span id="l9.332" class="difflineplus">+      rv = imapService-&gt;GetHeaders(dstFolder, dstListener, nullptr,</span>
<a href="#l9.333"></a><span id="l9.333" class="difflineplus">+                                   m_dstMsgIdString, true);</span>
<a href="#l9.334"></a><span id="l9.334">     }</span>
<a href="#l9.335"></a><span id="l9.335">   }</span>
<a href="#l9.336"></a><span id="l9.336">   return rv;</span>
<a href="#l9.337"></a><span id="l9.337"> }</span>
<a href="#l9.338"></a><span id="l9.338"> </span>
<a href="#l9.339"></a><span id="l9.339" class="difflineminus">-nsresult</span>
<a href="#l9.340"></a><span id="l9.340" class="difflineminus">-nsImapMoveCopyMsgTxn::SetCopyResponseUid(const char* aMsgIdString)</span>
<a href="#l9.341"></a><span id="l9.341" class="difflineminus">-{</span>
<a href="#l9.342"></a><span id="l9.342" class="difflineplus">+nsresult nsImapMoveCopyMsgTxn::SetCopyResponseUid(const char* aMsgIdString) {</span>
<a href="#l9.343"></a><span id="l9.343">   if (!aMsgIdString) return NS_ERROR_NULL_POINTER;</span>
<a href="#l9.344"></a><span id="l9.344">   m_dstMsgIdString = aMsgIdString;</span>
<a href="#l9.345"></a><span id="l9.345" class="difflineminus">-  if (m_dstMsgIdString.Last() == ']')</span>
<a href="#l9.346"></a><span id="l9.346" class="difflineminus">-  {</span>
<a href="#l9.347"></a><span id="l9.347" class="difflineplus">+  if (m_dstMsgIdString.Last() == ']') {</span>
<a href="#l9.348"></a><span id="l9.348">     int32_t len = m_dstMsgIdString.Length();</span>
<a href="#l9.349"></a><span id="l9.349">     m_dstMsgIdString.SetLength(len - 1);</span>
<a href="#l9.350"></a><span id="l9.350">   }</span>
<a href="#l9.351"></a><span id="l9.351">   return NS_OK;</span>
<a href="#l9.352"></a><span id="l9.352"> }</span>
<a href="#l9.353"></a><span id="l9.353"> </span>
<a href="#l9.354"></a><span id="l9.354" class="difflineminus">-nsresult</span>
<a href="#l9.355"></a><span id="l9.355" class="difflineminus">-nsImapMoveCopyMsgTxn::GetSrcKeyArray(nsTArray&lt;nsMsgKey&gt;&amp; srcKeyArray)</span>
<a href="#l9.356"></a><span id="l9.356" class="difflineminus">-{</span>
<a href="#l9.357"></a><span id="l9.357" class="difflineminus">-    srcKeyArray = m_srcKeyArray;</span>
<a href="#l9.358"></a><span id="l9.358" class="difflineminus">-    return NS_OK;</span>
<a href="#l9.359"></a><span id="l9.359" class="difflineplus">+nsresult nsImapMoveCopyMsgTxn::GetSrcKeyArray(nsTArray&lt;nsMsgKey&gt;&amp; srcKeyArray) {</span>
<a href="#l9.360"></a><span id="l9.360" class="difflineplus">+  srcKeyArray = m_srcKeyArray;</span>
<a href="#l9.361"></a><span id="l9.361" class="difflineplus">+  return NS_OK;</span>
<a href="#l9.362"></a><span id="l9.362"> }</span>
<a href="#l9.363"></a><span id="l9.363"> </span>
<a href="#l9.364"></a><span id="l9.364" class="difflineminus">-nsresult</span>
<a href="#l9.365"></a><span id="l9.365" class="difflineminus">-nsImapMoveCopyMsgTxn::AddDstKey(nsMsgKey aKey)</span>
<a href="#l9.366"></a><span id="l9.366" class="difflineminus">-{</span>
<a href="#l9.367"></a><span id="l9.367" class="difflineminus">-    if (!m_dstMsgIdString.IsEmpty())</span>
<a href="#l9.368"></a><span id="l9.368" class="difflineminus">-        m_dstMsgIdString.Append(',');</span>
<a href="#l9.369"></a><span id="l9.369" class="difflineminus">-    m_dstMsgIdString.AppendInt((int32_t) aKey);</span>
<a href="#l9.370"></a><span id="l9.370" class="difflineminus">-    return NS_OK;</span>
<a href="#l9.371"></a><span id="l9.371" class="difflineplus">+nsresult nsImapMoveCopyMsgTxn::AddDstKey(nsMsgKey aKey) {</span>
<a href="#l9.372"></a><span id="l9.372" class="difflineplus">+  if (!m_dstMsgIdString.IsEmpty()) m_dstMsgIdString.Append(',');</span>
<a href="#l9.373"></a><span id="l9.373" class="difflineplus">+  m_dstMsgIdString.AppendInt((int32_t)aKey);</span>
<a href="#l9.374"></a><span id="l9.374" class="difflineplus">+  return NS_OK;</span>
<a href="#l9.375"></a><span id="l9.375"> }</span>
<a href="#l9.376"></a><span id="l9.376"> </span>
<a href="#l9.377"></a><span id="l9.377" class="difflineminus">-nsresult</span>
<a href="#l9.378"></a><span id="l9.378" class="difflineminus">-nsImapMoveCopyMsgTxn::UndoMailboxDelete()</span>
<a href="#l9.379"></a><span id="l9.379" class="difflineminus">-{</span>
<a href="#l9.380"></a><span id="l9.380" class="difflineminus">-    nsresult rv = NS_ERROR_FAILURE;</span>
<a href="#l9.381"></a><span id="l9.381" class="difflineminus">-    // ** jt -- only do this for mailbox protocol</span>
<a href="#l9.382"></a><span id="l9.382" class="difflineminus">-    if (m_srcIsPop3)</span>
<a href="#l9.383"></a><span id="l9.383" class="difflineminus">-    {</span>
<a href="#l9.384"></a><span id="l9.384" class="difflineminus">-        nsCOMPtr&lt;nsIMsgFolder&gt; srcFolder = do_QueryReferent(m_srcFolder, &amp;rv);</span>
<a href="#l9.385"></a><span id="l9.385" class="difflineminus">-        if (NS_FAILED(rv) || !srcFolder) return rv;</span>
<a href="#l9.386"></a><span id="l9.386" class="difflineplus">+nsresult nsImapMoveCopyMsgTxn::UndoMailboxDelete() {</span>
<a href="#l9.387"></a><span id="l9.387" class="difflineplus">+  nsresult rv = NS_ERROR_FAILURE;</span>
<a href="#l9.388"></a><span id="l9.388" class="difflineplus">+  // ** jt -- only do this for mailbox protocol</span>
<a href="#l9.389"></a><span id="l9.389" class="difflineplus">+  if (m_srcIsPop3) {</span>
<a href="#l9.390"></a><span id="l9.390" class="difflineplus">+    nsCOMPtr&lt;nsIMsgFolder&gt; srcFolder = do_QueryReferent(m_srcFolder, &amp;rv);</span>
<a href="#l9.391"></a><span id="l9.391" class="difflineplus">+    if (NS_FAILED(rv) || !srcFolder) return rv;</span>
<a href="#l9.392"></a><span id="l9.392"> </span>
<a href="#l9.393"></a><span id="l9.393" class="difflineminus">-        nsCOMPtr&lt;nsIMsgFolder&gt; dstFolder = do_QueryReferent(m_dstFolder, &amp;rv);</span>
<a href="#l9.394"></a><span id="l9.394" class="difflineminus">-        if (NS_FAILED(rv) || !dstFolder) return rv;</span>
<a href="#l9.395"></a><span id="l9.395" class="difflineplus">+    nsCOMPtr&lt;nsIMsgFolder&gt; dstFolder = do_QueryReferent(m_dstFolder, &amp;rv);</span>
<a href="#l9.396"></a><span id="l9.396" class="difflineplus">+    if (NS_FAILED(rv) || !dstFolder) return rv;</span>
<a href="#l9.397"></a><span id="l9.397"> </span>
<a href="#l9.398"></a><span id="l9.398" class="difflineminus">-        nsCOMPtr&lt;nsIMsgDatabase&gt; srcDB;</span>
<a href="#l9.399"></a><span id="l9.399" class="difflineminus">-        nsCOMPtr&lt;nsIMsgDatabase&gt; dstDB;</span>
<a href="#l9.400"></a><span id="l9.400" class="difflineminus">-        rv = srcFolder-&gt;GetMsgDatabase(getter_AddRefs(srcDB));</span>
<a href="#l9.401"></a><span id="l9.401" class="difflineminus">-        if (NS_FAILED(rv)) return rv;</span>
<a href="#l9.402"></a><span id="l9.402" class="difflineminus">-        rv = dstFolder-&gt;GetMsgDatabase(getter_AddRefs(dstDB));</span>
<a href="#l9.403"></a><span id="l9.403" class="difflineminus">-        if (NS_FAILED(rv)) return rv;</span>
<a href="#l9.404"></a><span id="l9.404" class="difflineplus">+    nsCOMPtr&lt;nsIMsgDatabase&gt; srcDB;</span>
<a href="#l9.405"></a><span id="l9.405" class="difflineplus">+    nsCOMPtr&lt;nsIMsgDatabase&gt; dstDB;</span>
<a href="#l9.406"></a><span id="l9.406" class="difflineplus">+    rv = srcFolder-&gt;GetMsgDatabase(getter_AddRefs(srcDB));</span>
<a href="#l9.407"></a><span id="l9.407" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l9.408"></a><span id="l9.408" class="difflineplus">+    rv = dstFolder-&gt;GetMsgDatabase(getter_AddRefs(dstDB));</span>
<a href="#l9.409"></a><span id="l9.409" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l9.410"></a><span id="l9.410"> </span>
<a href="#l9.411"></a><span id="l9.411" class="difflineminus">-        uint32_t count = m_srcKeyArray.Length();</span>
<a href="#l9.412"></a><span id="l9.412" class="difflineminus">-        uint32_t i;</span>
<a href="#l9.413"></a><span id="l9.413" class="difflineminus">-        nsCOMPtr&lt;nsIMsgDBHdr&gt; oldHdr;</span>
<a href="#l9.414"></a><span id="l9.414" class="difflineminus">-        nsCOMPtr&lt;nsIMsgDBHdr&gt; newHdr;</span>
<a href="#l9.415"></a><span id="l9.415" class="difflineminus">-        for (i = 0; i &lt; count; i++)</span>
<a href="#l9.416"></a><span id="l9.416" class="difflineminus">-        {</span>
<a href="#l9.417"></a><span id="l9.417" class="difflineminus">-            oldHdr = m_srcHdrs[i];</span>
<a href="#l9.418"></a><span id="l9.418" class="difflineminus">-            NS_ASSERTION(oldHdr, &quot;fatal ... cannot get old msg header&quot;);</span>
<a href="#l9.419"></a><span id="l9.419" class="difflineminus">-            rv = srcDB-&gt;CopyHdrFromExistingHdr(m_srcKeyArray[i],</span>
<a href="#l9.420"></a><span id="l9.420" class="difflineminus">-                                               oldHdr,true,</span>
<a href="#l9.421"></a><span id="l9.421" class="difflineminus">-                                               getter_AddRefs(newHdr));</span>
<a href="#l9.422"></a><span id="l9.422" class="difflineminus">-            NS_ASSERTION(newHdr, &quot;fatal ... cannot create new header&quot;);</span>
<a href="#l9.423"></a><span id="l9.423" class="difflineplus">+    uint32_t count = m_srcKeyArray.Length();</span>
<a href="#l9.424"></a><span id="l9.424" class="difflineplus">+    uint32_t i;</span>
<a href="#l9.425"></a><span id="l9.425" class="difflineplus">+    nsCOMPtr&lt;nsIMsgDBHdr&gt; oldHdr;</span>
<a href="#l9.426"></a><span id="l9.426" class="difflineplus">+    nsCOMPtr&lt;nsIMsgDBHdr&gt; newHdr;</span>
<a href="#l9.427"></a><span id="l9.427" class="difflineplus">+    for (i = 0; i &lt; count; i++) {</span>
<a href="#l9.428"></a><span id="l9.428" class="difflineplus">+      oldHdr = m_srcHdrs[i];</span>
<a href="#l9.429"></a><span id="l9.429" class="difflineplus">+      NS_ASSERTION(oldHdr, &quot;fatal ... cannot get old msg header&quot;);</span>
<a href="#l9.430"></a><span id="l9.430" class="difflineplus">+      rv = srcDB-&gt;CopyHdrFromExistingHdr(m_srcKeyArray[i], oldHdr, true,</span>
<a href="#l9.431"></a><span id="l9.431" class="difflineplus">+                                         getter_AddRefs(newHdr));</span>
<a href="#l9.432"></a><span id="l9.432" class="difflineplus">+      NS_ASSERTION(newHdr, &quot;fatal ... cannot create new header&quot;);</span>
<a href="#l9.433"></a><span id="l9.433"> </span>
<a href="#l9.434"></a><span id="l9.434" class="difflineminus">-            if (NS_SUCCEEDED(rv) &amp;&amp; newHdr)</span>
<a href="#l9.435"></a><span id="l9.435" class="difflineminus">-            {</span>
<a href="#l9.436"></a><span id="l9.436" class="difflineminus">-                if (i &lt; m_srcSizeArray.Length())</span>
<a href="#l9.437"></a><span id="l9.437" class="difflineminus">-                    newHdr-&gt;SetMessageSize(m_srcSizeArray[i]);</span>
<a href="#l9.438"></a><span id="l9.438" class="difflineminus">-                srcDB-&gt;UndoDelete(newHdr);</span>
<a href="#l9.439"></a><span id="l9.439" class="difflineminus">-            }</span>
<a href="#l9.440"></a><span id="l9.440" class="difflineminus">-        }</span>
<a href="#l9.441"></a><span id="l9.441" class="difflineminus">-        srcDB-&gt;SetSummaryValid(true);</span>
<a href="#l9.442"></a><span id="l9.442" class="difflineminus">-        return NS_OK; // always return NS_OK</span>
<a href="#l9.443"></a><span id="l9.443" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; newHdr) {</span>
<a href="#l9.444"></a><span id="l9.444" class="difflineplus">+        if (i &lt; m_srcSizeArray.Length())</span>
<a href="#l9.445"></a><span id="l9.445" class="difflineplus">+          newHdr-&gt;SetMessageSize(m_srcSizeArray[i]);</span>
<a href="#l9.446"></a><span id="l9.446" class="difflineplus">+        srcDB-&gt;UndoDelete(newHdr);</span>
<a href="#l9.447"></a><span id="l9.447" class="difflineplus">+      }</span>
<a href="#l9.448"></a><span id="l9.448">     }</span>
<a href="#l9.449"></a><span id="l9.449" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l9.450"></a><span id="l9.450" class="difflineplus">+    srcDB-&gt;SetSummaryValid(true);</span>
<a href="#l9.451"></a><span id="l9.451" class="difflineplus">+    return NS_OK;  // always return NS_OK</span>
<a href="#l9.452"></a><span id="l9.452" class="difflineplus">+  }</span>
<a href="#l9.453"></a><span id="l9.453" class="difflineplus">+  return NS_ERROR_FAILURE;</span>
<a href="#l9.454"></a><span id="l9.454"> }</span>
<a href="#l9.455"></a><span id="l9.455"> </span>
<a href="#l9.456"></a><span id="l9.456" class="difflineminus">-</span>
<a href="#l9.457"></a><span id="l9.457" class="difflineminus">-nsresult</span>
<a href="#l9.458"></a><span id="l9.458" class="difflineminus">-nsImapMoveCopyMsgTxn::RedoMailboxDelete()</span>
<a href="#l9.459"></a><span id="l9.459" class="difflineminus">-{</span>
<a href="#l9.460"></a><span id="l9.460" class="difflineminus">-    nsresult rv = NS_ERROR_FAILURE;</span>
<a href="#l9.461"></a><span id="l9.461" class="difflineminus">-    if (m_srcIsPop3)</span>
<a href="#l9.462"></a><span id="l9.462" class="difflineminus">-    {</span>
<a href="#l9.463"></a><span id="l9.463" class="difflineminus">-        nsCOMPtr&lt;nsIMsgDatabase&gt; srcDB;</span>
<a href="#l9.464"></a><span id="l9.464" class="difflineminus">-        nsCOMPtr&lt;nsIMsgFolder&gt; srcFolder = do_QueryReferent(m_srcFolder, &amp;rv);</span>
<a href="#l9.465"></a><span id="l9.465" class="difflineminus">-        if (NS_FAILED(rv) || !srcFolder) return rv;</span>
<a href="#l9.466"></a><span id="l9.466" class="difflineminus">-        rv = srcFolder-&gt;GetMsgDatabase(getter_AddRefs(srcDB));</span>
<a href="#l9.467"></a><span id="l9.467" class="difflineminus">-        if (NS_SUCCEEDED(rv))</span>
<a href="#l9.468"></a><span id="l9.468" class="difflineminus">-        {</span>
<a href="#l9.469"></a><span id="l9.469" class="difflineminus">-            srcDB-&gt;DeleteMessages(m_srcKeyArray.Length(), m_srcKeyArray.Elements(), nullptr);</span>
<a href="#l9.470"></a><span id="l9.470" class="difflineminus">-            srcDB-&gt;SetSummaryValid(true);</span>
<a href="#l9.471"></a><span id="l9.471" class="difflineminus">-        }</span>
<a href="#l9.472"></a><span id="l9.472" class="difflineminus">-        return NS_OK; // always return NS_OK</span>
<a href="#l9.473"></a><span id="l9.473" class="difflineplus">+nsresult nsImapMoveCopyMsgTxn::RedoMailboxDelete() {</span>
<a href="#l9.474"></a><span id="l9.474" class="difflineplus">+  nsresult rv = NS_ERROR_FAILURE;</span>
<a href="#l9.475"></a><span id="l9.475" class="difflineplus">+  if (m_srcIsPop3) {</span>
<a href="#l9.476"></a><span id="l9.476" class="difflineplus">+    nsCOMPtr&lt;nsIMsgDatabase&gt; srcDB;</span>
<a href="#l9.477"></a><span id="l9.477" class="difflineplus">+    nsCOMPtr&lt;nsIMsgFolder&gt; srcFolder = do_QueryReferent(m_srcFolder, &amp;rv);</span>
<a href="#l9.478"></a><span id="l9.478" class="difflineplus">+    if (NS_FAILED(rv) || !srcFolder) return rv;</span>
<a href="#l9.479"></a><span id="l9.479" class="difflineplus">+    rv = srcFolder-&gt;GetMsgDatabase(getter_AddRefs(srcDB));</span>
<a href="#l9.480"></a><span id="l9.480" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l9.481"></a><span id="l9.481" class="difflineplus">+      srcDB-&gt;DeleteMessages(m_srcKeyArray.Length(), m_srcKeyArray.Elements(),</span>
<a href="#l9.482"></a><span id="l9.482" class="difflineplus">+                            nullptr);</span>
<a href="#l9.483"></a><span id="l9.483" class="difflineplus">+      srcDB-&gt;SetSummaryValid(true);</span>
<a href="#l9.484"></a><span id="l9.484">     }</span>
<a href="#l9.485"></a><span id="l9.485" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l9.486"></a><span id="l9.486" class="difflineplus">+    return NS_OK;  // always return NS_OK</span>
<a href="#l9.487"></a><span id="l9.487" class="difflineplus">+  }</span>
<a href="#l9.488"></a><span id="l9.488" class="difflineplus">+  return NS_ERROR_FAILURE;</span>
<a href="#l9.489"></a><span id="l9.489"> }</span>
<a href="#l9.490"></a><span id="l9.490"> </span>
<a href="#l9.491"></a><span id="l9.491" class="difflineminus">-nsresult nsImapMoveCopyMsgTxn::GetImapDeleteModel(nsIMsgFolder *aFolder, nsMsgImapDeleteModel *aDeleteModel)</span>
<a href="#l9.492"></a><span id="l9.492" class="difflineminus">-{</span>
<a href="#l9.493"></a><span id="l9.493" class="difflineplus">+nsresult nsImapMoveCopyMsgTxn::GetImapDeleteModel(</span>
<a href="#l9.494"></a><span id="l9.494" class="difflineplus">+    nsIMsgFolder* aFolder, nsMsgImapDeleteModel* aDeleteModel) {</span>
<a href="#l9.495"></a><span id="l9.495">   nsresult rv;</span>
<a href="#l9.496"></a><span id="l9.496">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l9.497"></a><span id="l9.497" class="difflineminus">-  if (!aFolder)</span>
<a href="#l9.498"></a><span id="l9.498" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l9.499"></a><span id="l9.499" class="difflineplus">+  if (!aFolder) return NS_ERROR_NULL_POINTER;</span>
<a href="#l9.500"></a><span id="l9.500">   rv = aFolder-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l9.501"></a><span id="l9.501">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.502"></a><span id="l9.502">   nsCOMPtr&lt;nsIImapIncomingServer&gt; imapServer = do_QueryInterface(server, &amp;rv);</span>
<a href="#l9.503"></a><span id="l9.503">   if (NS_SUCCEEDED(rv) &amp;&amp; imapServer)</span>
<a href="#l9.504"></a><span id="l9.504" class="difflineminus">-   rv = imapServer-&gt;GetDeleteModel(aDeleteModel);</span>
<a href="#l9.505"></a><span id="l9.505" class="difflineplus">+    rv = imapServer-&gt;GetDeleteModel(aDeleteModel);</span>
<a href="#l9.506"></a><span id="l9.506">   return rv;</span>
<a href="#l9.507"></a><span id="l9.507"> }</span>
<a href="#l9.508"></a><span id="l9.508"> </span>
<a href="#l9.509"></a><span id="l9.509" class="difflineminus">-NS_IMETHODIMP nsImapMoveCopyMsgTxn::OnStartRunningUrl(nsIURI *aUrl)</span>
<a href="#l9.510"></a><span id="l9.510" class="difflineminus">-{</span>
<a href="#l9.511"></a><span id="l9.511" class="difflineplus">+NS_IMETHODIMP nsImapMoveCopyMsgTxn::OnStartRunningUrl(nsIURI* aUrl) {</span>
<a href="#l9.512"></a><span id="l9.512">   return NS_OK;</span>
<a href="#l9.513"></a><span id="l9.513"> }</span>
<a href="#l9.514"></a><span id="l9.514"> </span>
<a href="#l9.515"></a><span id="l9.515" class="difflineminus">-NS_IMETHODIMP nsImapMoveCopyMsgTxn::OnStopRunningUrl(nsIURI *aUrl, nsresult aExitCode)</span>
<a href="#l9.516"></a><span id="l9.516" class="difflineminus">-{</span>
<a href="#l9.517"></a><span id="l9.517" class="difflineplus">+NS_IMETHODIMP nsImapMoveCopyMsgTxn::OnStopRunningUrl(nsIURI* aUrl,</span>
<a href="#l9.518"></a><span id="l9.518" class="difflineplus">+                                                     nsresult aExitCode) {</span>
<a href="#l9.519"></a><span id="l9.519">   nsCOMPtr&lt;nsIUrlListener&gt; urlListener = do_QueryReferent(m_onStopListener);</span>
<a href="#l9.520"></a><span id="l9.520" class="difflineminus">-  if (urlListener)</span>
<a href="#l9.521"></a><span id="l9.521" class="difflineminus">-    urlListener-&gt;OnStopRunningUrl(aUrl, aExitCode);</span>
<a href="#l9.522"></a><span id="l9.522" class="difflineplus">+  if (urlListener) urlListener-&gt;OnStopRunningUrl(aUrl, aExitCode);</span>
<a href="#l9.523"></a><span id="l9.523"> </span>
<a href="#l9.524"></a><span id="l9.524">   nsCOMPtr&lt;nsIImapUrl&gt; imapUrl = do_QueryInterface(aUrl);</span>
<a href="#l9.525"></a><span id="l9.525" class="difflineminus">-  if (imapUrl)</span>
<a href="#l9.526"></a><span id="l9.526" class="difflineminus">-  {</span>
<a href="#l9.527"></a><span id="l9.527" class="difflineplus">+  if (imapUrl) {</span>
<a href="#l9.528"></a><span id="l9.528">     nsresult rv;</span>
<a href="#l9.529"></a><span id="l9.529" class="difflineminus">-    nsCOMPtr&lt;nsIImapService&gt; imapService = do_GetService(NS_IMAPSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l9.530"></a><span id="l9.530" class="difflineplus">+    nsCOMPtr&lt;nsIImapService&gt; imapService =</span>
<a href="#l9.531"></a><span id="l9.531" class="difflineplus">+        do_GetService(NS_IMAPSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l9.532"></a><span id="l9.532">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.533"></a><span id="l9.533">     nsImapAction imapAction;</span>
<a href="#l9.534"></a><span id="l9.534">     imapUrl-&gt;GetImapAction(&amp;imapAction);</span>
<a href="#l9.535"></a><span id="l9.535">     nsCOMPtr&lt;nsIMsgFolder&gt; dstFolder = do_QueryReferent(m_dstFolder, &amp;rv);</span>
<a href="#l9.536"></a><span id="l9.536">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.537"></a><span id="l9.537">     nsCOMPtr&lt;nsIMsgFolder&gt; srcFolder = do_QueryReferent(m_srcFolder, &amp;rv);</span>
<a href="#l9.538"></a><span id="l9.538">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.539"></a><span id="l9.539" class="difflineminus">-    if (imapAction == nsIImapUrl::nsImapSubtractMsgFlags)</span>
<a href="#l9.540"></a><span id="l9.540" class="difflineminus">-    {</span>
<a href="#l9.541"></a><span id="l9.541" class="difflineplus">+    if (imapAction == nsIImapUrl::nsImapSubtractMsgFlags) {</span>
<a href="#l9.542"></a><span id="l9.542">       int32_t extraStatus;</span>
<a href="#l9.543"></a><span id="l9.543">       imapUrl-&gt;GetExtraStatus(&amp;extraStatus);</span>
<a href="#l9.544"></a><span id="l9.544" class="difflineminus">-      if (extraStatus != nsIImapUrl::ImapStatusNone)</span>
<a href="#l9.545"></a><span id="l9.545" class="difflineminus">-      {</span>
<a href="#l9.546"></a><span id="l9.546" class="difflineplus">+      if (extraStatus != nsIImapUrl::ImapStatusNone) {</span>
<a href="#l9.547"></a><span id="l9.547">         // If subtracting the deleted flag didn't work, try</span>
<a href="#l9.548"></a><span id="l9.548">         // moving the message back from the target folder to the src folder</span>
<a href="#l9.549"></a><span id="l9.549">         if (!m_dstMsgIdString.IsEmpty())</span>
<a href="#l9.550"></a><span id="l9.550" class="difflineminus">-          imapService-&gt;OnlineMessageCopy(dstFolder,</span>
<a href="#l9.551"></a><span id="l9.551" class="difflineminus">-                                         m_dstMsgIdString,</span>
<a href="#l9.552"></a><span id="l9.552" class="difflineminus">-                                         srcFolder,</span>
<a href="#l9.553"></a><span id="l9.553" class="difflineminus">-                                         true,</span>
<a href="#l9.554"></a><span id="l9.554" class="difflineminus">-                                         true,</span>
<a href="#l9.555"></a><span id="l9.555" class="difflineminus">-                                         nullptr, /* listener */</span>
<a href="#l9.556"></a><span id="l9.556" class="difflineminus">-                                         nullptr,</span>
<a href="#l9.557"></a><span id="l9.557" class="difflineminus">-                                         nullptr,</span>
<a href="#l9.558"></a><span id="l9.558" class="difflineminus">-                                         nullptr);</span>
<a href="#l9.559"></a><span id="l9.559" class="difflineminus">-        else</span>
<a href="#l9.560"></a><span id="l9.560" class="difflineminus">-        {</span>
<a href="#l9.561"></a><span id="l9.561" class="difflineplus">+          imapService-&gt;OnlineMessageCopy(dstFolder, m_dstMsgIdString, srcFolder,</span>
<a href="#l9.562"></a><span id="l9.562" class="difflineplus">+                                         true, true, nullptr, /* listener */</span>
<a href="#l9.563"></a><span id="l9.563" class="difflineplus">+                                         nullptr, nullptr, nullptr);</span>
<a href="#l9.564"></a><span id="l9.564" class="difflineplus">+        else {</span>
<a href="#l9.565"></a><span id="l9.565">           // server doesn't support COPYUID, so we're going to update the dest</span>
<a href="#l9.566"></a><span id="l9.566">           // folder, and when that's done, use the db to find the messages</span>
<a href="#l9.567"></a><span id="l9.567">           // to move back, looking them up by message-id.</span>
<a href="#l9.568"></a><span id="l9.568" class="difflineminus">-          nsCOMPtr&lt;nsIMsgImapMailFolder&gt; imapDest = do_QueryInterface(dstFolder);</span>
<a href="#l9.569"></a><span id="l9.569" class="difflineminus">-          if (imapDest)</span>
<a href="#l9.570"></a><span id="l9.570" class="difflineminus">-            imapDest-&gt;UpdateFolderWithListener(nullptr, this);</span>
<a href="#l9.571"></a><span id="l9.571" class="difflineplus">+          nsCOMPtr&lt;nsIMsgImapMailFolder&gt; imapDest =</span>
<a href="#l9.572"></a><span id="l9.572" class="difflineplus">+              do_QueryInterface(dstFolder);</span>
<a href="#l9.573"></a><span id="l9.573" class="difflineplus">+          if (imapDest) imapDest-&gt;UpdateFolderWithListener(nullptr, this);</span>
<a href="#l9.574"></a><span id="l9.574">         }</span>
<a href="#l9.575"></a><span id="l9.575" class="difflineminus">-      }</span>
<a href="#l9.576"></a><span id="l9.576" class="difflineminus">-      else if (!m_dstMsgIdString.IsEmpty())</span>
<a href="#l9.577"></a><span id="l9.577" class="difflineminus">-      {</span>
<a href="#l9.578"></a><span id="l9.578" class="difflineplus">+      } else if (!m_dstMsgIdString.IsEmpty()) {</span>
<a href="#l9.579"></a><span id="l9.579">         nsCOMPtr&lt;nsIUrlListener&gt; dstListener;</span>
<a href="#l9.580"></a><span id="l9.580"> </span>
<a href="#l9.581"></a><span id="l9.581">         dstListener = do_QueryInterface(dstFolder, &amp;rv);</span>
<a href="#l9.582"></a><span id="l9.582">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.583"></a><span id="l9.583">         // ** make sure we are in the selected state; use lite select folder</span>
<a href="#l9.584"></a><span id="l9.584">         // so we won't potentially download a bunch of headers.</span>
<a href="#l9.585"></a><span id="l9.585" class="difflineminus">-        rv = imapService-&gt;LiteSelectFolder(dstFolder, dstListener, nullptr, nullptr);</span>
<a href="#l9.586"></a><span id="l9.586" class="difflineplus">+        rv = imapService-&gt;LiteSelectFolder(dstFolder, dstListener, nullptr,</span>
<a href="#l9.587"></a><span id="l9.587" class="difflineplus">+                                           nullptr);</span>
<a href="#l9.588"></a><span id="l9.588">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.589"></a><span id="l9.589" class="difflineminus">-        rv = imapService-&gt;AddMessageFlags(dstFolder, dstListener,</span>
<a href="#l9.590"></a><span id="l9.590" class="difflineminus">-                                          nullptr, m_dstMsgIdString,</span>
<a href="#l9.591"></a><span id="l9.591" class="difflineminus">-                                          kImapMsgDeletedFlag, m_idsAreUids);</span>
<a href="#l9.592"></a><span id="l9.592" class="difflineplus">+        rv = imapService-&gt;AddMessageFlags(dstFolder, dstListener, nullptr,</span>
<a href="#l9.593"></a><span id="l9.593" class="difflineplus">+                                          m_dstMsgIdString, kImapMsgDeletedFlag,</span>
<a href="#l9.594"></a><span id="l9.594" class="difflineplus">+                                          m_idsAreUids);</span>
<a href="#l9.595"></a><span id="l9.595">       }</span>
<a href="#l9.596"></a><span id="l9.596" class="difflineminus">-    }</span>
<a href="#l9.597"></a><span id="l9.597" class="difflineminus">-    else if (imapAction == nsIImapUrl::nsImapSelectFolder)</span>
<a href="#l9.598"></a><span id="l9.598" class="difflineminus">-    {</span>
<a href="#l9.599"></a><span id="l9.599" class="difflineplus">+    } else if (imapAction == nsIImapUrl::nsImapSelectFolder) {</span>
<a href="#l9.600"></a><span id="l9.600">       // Now we should have the headers from the dest folder.</span>
<a href="#l9.601"></a><span id="l9.601">       // Look them up and move them back to the source folder.</span>
<a href="#l9.602"></a><span id="l9.602">       uint32_t count = m_srcMessageIds.Length();</span>
<a href="#l9.603"></a><span id="l9.603">       uint32_t i;</span>
<a href="#l9.604"></a><span id="l9.604">       nsCString messageId;</span>
<a href="#l9.605"></a><span id="l9.605">       nsTArray&lt;nsMsgKey&gt; dstKeys;</span>
<a href="#l9.606"></a><span id="l9.606">       nsCOMPtr&lt;nsIMsgDatabase&gt; destDB;</span>
<a href="#l9.607"></a><span id="l9.607">       nsCOMPtr&lt;nsIMsgDBHdr&gt; dstHdr;</span>
<a href="#l9.608"></a><span id="l9.608"> </span>
<a href="#l9.609"></a><span id="l9.609">       rv = dstFolder-&gt;GetMsgDatabase(getter_AddRefs(destDB));</span>
<a href="#l9.610"></a><span id="l9.610">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.611"></a><span id="l9.611" class="difflineminus">-      for (i = 0; i &lt; count; i++)</span>
<a href="#l9.612"></a><span id="l9.612" class="difflineminus">-      {</span>
<a href="#l9.613"></a><span id="l9.613" class="difflineminus">-        rv = destDB-&gt;GetMsgHdrForMessageID(m_srcMessageIds[i].get(), getter_AddRefs(dstHdr));</span>
<a href="#l9.614"></a><span id="l9.614" class="difflineminus">-        if (NS_SUCCEEDED(rv) &amp;&amp; dstHdr)</span>
<a href="#l9.615"></a><span id="l9.615" class="difflineminus">-        {</span>
<a href="#l9.616"></a><span id="l9.616" class="difflineplus">+      for (i = 0; i &lt; count; i++) {</span>
<a href="#l9.617"></a><span id="l9.617" class="difflineplus">+        rv = destDB-&gt;GetMsgHdrForMessageID(m_srcMessageIds[i].get(),</span>
<a href="#l9.618"></a><span id="l9.618" class="difflineplus">+                                           getter_AddRefs(dstHdr));</span>
<a href="#l9.619"></a><span id="l9.619" class="difflineplus">+        if (NS_SUCCEEDED(rv) &amp;&amp; dstHdr) {</span>
<a href="#l9.620"></a><span id="l9.620">           nsMsgKey dstKey;</span>
<a href="#l9.621"></a><span id="l9.621">           dstHdr-&gt;GetMessageKey(&amp;dstKey);</span>
<a href="#l9.622"></a><span id="l9.622">           dstKeys.AppendElement(dstKey);</span>
<a href="#l9.623"></a><span id="l9.623">         }</span>
<a href="#l9.624"></a><span id="l9.624">       }</span>
<a href="#l9.625"></a><span id="l9.625" class="difflineminus">-      if (dstKeys.Length())</span>
<a href="#l9.626"></a><span id="l9.626" class="difflineminus">-      {</span>
<a href="#l9.627"></a><span id="l9.627" class="difflineplus">+      if (dstKeys.Length()) {</span>
<a href="#l9.628"></a><span id="l9.628">         nsAutoCString uids;</span>
<a href="#l9.629"></a><span id="l9.629" class="difflineminus">-        nsImapMailFolder::AllocateUidStringFromKeys(dstKeys.Elements(), dstKeys.Length(), uids);</span>
<a href="#l9.630"></a><span id="l9.630" class="difflineminus">-        rv = imapService-&gt;OnlineMessageCopy(dstFolder, uids, srcFolder,</span>
<a href="#l9.631"></a><span id="l9.631" class="difflineminus">-                                            true, true, nullptr,</span>
<a href="#l9.632"></a><span id="l9.632" class="difflineminus">-                                            nullptr, nullptr, nullptr);</span>
<a href="#l9.633"></a><span id="l9.633" class="difflineplus">+        nsImapMailFolder::AllocateUidStringFromKeys(dstKeys.Elements(),</span>
<a href="#l9.634"></a><span id="l9.634" class="difflineplus">+                                                    dstKeys.Length(), uids);</span>
<a href="#l9.635"></a><span id="l9.635" class="difflineplus">+        rv = imapService-&gt;OnlineMessageCopy(dstFolder, uids, srcFolder, true,</span>
<a href="#l9.636"></a><span id="l9.636" class="difflineplus">+                                            true, nullptr, nullptr, nullptr,</span>
<a href="#l9.637"></a><span id="l9.637" class="difflineplus">+                                            nullptr);</span>
<a href="#l9.638"></a><span id="l9.638">       }</span>
<a href="#l9.639"></a><span id="l9.639">     }</span>
<a href="#l9.640"></a><span id="l9.640">   }</span>
<a href="#l9.641"></a><span id="l9.641">   return NS_OK;</span>
<a href="#l9.642"></a><span id="l9.642"> }</span>
<a href="#l9.643"></a><span id="l9.643"> </span>
<a href="#l9.644"></a><span id="l9.644" class="difflineminus">-nsImapOfflineTxn::nsImapOfflineTxn(nsIMsgFolder* srcFolder, nsTArray&lt;nsMsgKey&gt;* srcKeyArray,</span>
<a href="#l9.645"></a><span id="l9.645" class="difflineminus">-                                   const char *srcMsgIdString, nsIMsgFolder* dstFolder,</span>
<a href="#l9.646"></a><span id="l9.646" class="difflineminus">-                                   bool isMove, nsOfflineImapOperationType opType,</span>
<a href="#l9.647"></a><span id="l9.647" class="difflineminus">-                                   nsCOMArray&lt;nsIMsgDBHdr&gt; &amp;srcHdrs)</span>
<a href="#l9.648"></a><span id="l9.648" class="difflineminus">-{</span>
<a href="#l9.649"></a><span id="l9.649" class="difflineminus">-  Init(srcFolder, srcKeyArray, srcMsgIdString, dstFolder, true,</span>
<a href="#l9.650"></a><span id="l9.650" class="difflineminus">-       isMove);</span>
<a href="#l9.651"></a><span id="l9.651" class="difflineplus">+nsImapOfflineTxn::nsImapOfflineTxn(nsIMsgFolder* srcFolder,</span>
<a href="#l9.652"></a><span id="l9.652" class="difflineplus">+                                   nsTArray&lt;nsMsgKey&gt;* srcKeyArray,</span>
<a href="#l9.653"></a><span id="l9.653" class="difflineplus">+                                   const char* srcMsgIdString,</span>
<a href="#l9.654"></a><span id="l9.654" class="difflineplus">+                                   nsIMsgFolder* dstFolder, bool isMove,</span>
<a href="#l9.655"></a><span id="l9.655" class="difflineplus">+                                   nsOfflineImapOperationType opType,</span>
<a href="#l9.656"></a><span id="l9.656" class="difflineplus">+                                   nsCOMArray&lt;nsIMsgDBHdr&gt;&amp; srcHdrs) {</span>
<a href="#l9.657"></a><span id="l9.657" class="difflineplus">+  Init(srcFolder, srcKeyArray, srcMsgIdString, dstFolder, true, isMove);</span>
<a href="#l9.658"></a><span id="l9.658"> </span>
<a href="#l9.659"></a><span id="l9.659">   m_opType = opType;</span>
<a href="#l9.660"></a><span id="l9.660">   m_flags = 0;</span>
<a href="#l9.661"></a><span id="l9.661">   m_addFlags = false;</span>
<a href="#l9.662"></a><span id="l9.662" class="difflineminus">-  if (opType == nsIMsgOfflineImapOperation::kDeletedMsg)</span>
<a href="#l9.663"></a><span id="l9.663" class="difflineminus">-  {</span>
<a href="#l9.664"></a><span id="l9.664" class="difflineplus">+  if (opType == nsIMsgOfflineImapOperation::kDeletedMsg) {</span>
<a href="#l9.665"></a><span id="l9.665">     nsCOMPtr&lt;nsIMsgDatabase&gt; srcDB;</span>
<a href="#l9.666"></a><span id="l9.666">     nsCOMPtr&lt;nsIDBFolderInfo&gt; folderInfo;</span>
<a href="#l9.667"></a><span id="l9.667"> </span>
<a href="#l9.668"></a><span id="l9.668" class="difflineminus">-    nsresult rv = srcFolder-&gt;GetDBFolderInfoAndDB(getter_AddRefs(folderInfo), getter_AddRefs(srcDB));</span>
<a href="#l9.669"></a><span id="l9.669" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; srcDB)</span>
<a href="#l9.670"></a><span id="l9.670" class="difflineminus">-    {</span>
<a href="#l9.671"></a><span id="l9.671" class="difflineplus">+    nsresult rv = srcFolder-&gt;GetDBFolderInfoAndDB(getter_AddRefs(folderInfo),</span>
<a href="#l9.672"></a><span id="l9.672" class="difflineplus">+                                                  getter_AddRefs(srcDB));</span>
<a href="#l9.673"></a><span id="l9.673" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; srcDB) {</span>
<a href="#l9.674"></a><span id="l9.674">       nsMsgKey pseudoKey;</span>
<a href="#l9.675"></a><span id="l9.675" class="difflineminus">-      nsCOMPtr &lt;nsIMsgDBHdr&gt; copySrcHdr;</span>
<a href="#l9.676"></a><span id="l9.676" class="difflineplus">+      nsCOMPtr&lt;nsIMsgDBHdr&gt; copySrcHdr;</span>
<a href="#l9.677"></a><span id="l9.677"> </span>
<a href="#l9.678"></a><span id="l9.678">       // Imap protocols have conflated key/UUID so we cannot use</span>
<a href="#l9.679"></a><span id="l9.679">       // auto key with them.</span>
<a href="#l9.680"></a><span id="l9.680">       nsCString protocolType;</span>
<a href="#l9.681"></a><span id="l9.681">       srcFolder-&gt;GetURI(protocolType);</span>
<a href="#l9.682"></a><span id="l9.682">       protocolType.SetLength(protocolType.FindChar(':'));</span>
<a href="#l9.683"></a><span id="l9.683" class="difflineminus">-      for (int32_t i = 0; i &lt; srcHdrs.Count(); i++)</span>
<a href="#l9.684"></a><span id="l9.684" class="difflineminus">-      {</span>
<a href="#l9.685"></a><span id="l9.685" class="difflineminus">-        if (protocolType.EqualsLiteral(&quot;imap&quot;))</span>
<a href="#l9.686"></a><span id="l9.686" class="difflineminus">-        {</span>
<a href="#l9.687"></a><span id="l9.687" class="difflineplus">+      for (int32_t i = 0; i &lt; srcHdrs.Count(); i++) {</span>
<a href="#l9.688"></a><span id="l9.688" class="difflineplus">+        if (protocolType.EqualsLiteral(&quot;imap&quot;)) {</span>
<a href="#l9.689"></a><span id="l9.689">           srcDB-&gt;GetNextPseudoMsgKey(&amp;pseudoKey);</span>
<a href="#l9.690"></a><span id="l9.690">           pseudoKey--;</span>
<a href="#l9.691"></a><span id="l9.691" class="difflineminus">-        }</span>
<a href="#l9.692"></a><span id="l9.692" class="difflineminus">-        else</span>
<a href="#l9.693"></a><span id="l9.693" class="difflineminus">-        {</span>
<a href="#l9.694"></a><span id="l9.694" class="difflineplus">+        } else {</span>
<a href="#l9.695"></a><span id="l9.695">           pseudoKey = nsMsgKey_None;</span>
<a href="#l9.696"></a><span id="l9.696">         }</span>
<a href="#l9.697"></a><span id="l9.697" class="difflineminus">-        rv = srcDB-&gt;CopyHdrFromExistingHdr(pseudoKey, srcHdrs[i], false, getter_AddRefs(copySrcHdr));</span>
<a href="#l9.698"></a><span id="l9.698" class="difflineminus">-        if (NS_SUCCEEDED(rv))</span>
<a href="#l9.699"></a><span id="l9.699" class="difflineminus">-        {</span>
<a href="#l9.700"></a><span id="l9.700" class="difflineplus">+        rv = srcDB-&gt;CopyHdrFromExistingHdr(pseudoKey, srcHdrs[i], false,</span>
<a href="#l9.701"></a><span id="l9.701" class="difflineplus">+                                           getter_AddRefs(copySrcHdr));</span>
<a href="#l9.702"></a><span id="l9.702" class="difflineplus">+        if (NS_SUCCEEDED(rv)) {</span>
<a href="#l9.703"></a><span id="l9.703">           copySrcHdr-&gt;GetMessageKey(&amp;pseudoKey);</span>
<a href="#l9.704"></a><span id="l9.704">           m_srcHdrs.AppendObject(copySrcHdr);</span>
<a href="#l9.705"></a><span id="l9.705">         }</span>
<a href="#l9.706"></a><span id="l9.706">         m_dupKeyArray[i] = pseudoKey;</span>
<a href="#l9.707"></a><span id="l9.707">       }</span>
<a href="#l9.708"></a><span id="l9.708">     }</span>
<a href="#l9.709"></a><span id="l9.709" class="difflineminus">-  }</span>
<a href="#l9.710"></a><span id="l9.710" class="difflineminus">-  else</span>
<a href="#l9.711"></a><span id="l9.711" class="difflineplus">+  } else</span>
<a href="#l9.712"></a><span id="l9.712">     m_srcHdrs.AppendObjects(srcHdrs);</span>
<a href="#l9.713"></a><span id="l9.713"> }</span>
<a href="#l9.714"></a><span id="l9.714"> </span>
<a href="#l9.715"></a><span id="l9.715" class="difflineminus">-nsImapOfflineTxn::~nsImapOfflineTxn()</span>
<a href="#l9.716"></a><span id="l9.716" class="difflineminus">-{</span>
<a href="#l9.717"></a><span id="l9.717" class="difflineminus">-}</span>
<a href="#l9.718"></a><span id="l9.718" class="difflineplus">+nsImapOfflineTxn::~nsImapOfflineTxn() {}</span>
<a href="#l9.719"></a><span id="l9.719"> </span>
<a href="#l9.720"></a><span id="l9.720"> // Open the database and find the key for the offline operation that we want to</span>
<a href="#l9.721"></a><span id="l9.721"> // undo, then remove it from the database, we also hold on to this</span>
<a href="#l9.722"></a><span id="l9.722"> // data for a redo operation.</span>
<a href="#l9.723"></a><span id="l9.723" class="difflineminus">-NS_IMETHODIMP nsImapOfflineTxn::UndoTransaction(void)</span>
<a href="#l9.724"></a><span id="l9.724" class="difflineminus">-{</span>
<a href="#l9.725"></a><span id="l9.725" class="difflineplus">+NS_IMETHODIMP nsImapOfflineTxn::UndoTransaction(void) {</span>
<a href="#l9.726"></a><span id="l9.726">   nsresult rv;</span>
<a href="#l9.727"></a><span id="l9.727"> </span>
<a href="#l9.728"></a><span id="l9.728">   nsCOMPtr&lt;nsIMsgFolder&gt; srcFolder = do_QueryReferent(m_srcFolder, &amp;rv);</span>
<a href="#l9.729"></a><span id="l9.729" class="difflineminus">-  if (NS_FAILED(rv) || !srcFolder)</span>
<a href="#l9.730"></a><span id="l9.730" class="difflineminus">-    return rv;</span>
<a href="#l9.731"></a><span id="l9.731" class="difflineminus">-  nsCOMPtr &lt;nsIMsgOfflineImapOperation&gt; op;</span>
<a href="#l9.732"></a><span id="l9.732" class="difflineminus">-  nsCOMPtr &lt;nsIDBFolderInfo&gt; folderInfo;</span>
<a href="#l9.733"></a><span id="l9.733" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDatabase&gt; srcDB;</span>
<a href="#l9.734"></a><span id="l9.734" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDatabase&gt; destDB;</span>
<a href="#l9.735"></a><span id="l9.735" class="difflineplus">+  if (NS_FAILED(rv) || !srcFolder) return rv;</span>
<a href="#l9.736"></a><span id="l9.736" class="difflineplus">+  nsCOMPtr&lt;nsIMsgOfflineImapOperation&gt; op;</span>
<a href="#l9.737"></a><span id="l9.737" class="difflineplus">+  nsCOMPtr&lt;nsIDBFolderInfo&gt; folderInfo;</span>
<a href="#l9.738"></a><span id="l9.738" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDatabase&gt; srcDB;</span>
<a href="#l9.739"></a><span id="l9.739" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDatabase&gt; destDB;</span>
<a href="#l9.740"></a><span id="l9.740"> </span>
<a href="#l9.741"></a><span id="l9.741" class="difflineminus">-  rv = srcFolder-&gt;GetDBFolderInfoAndDB(getter_AddRefs(folderInfo), getter_AddRefs(srcDB));</span>
<a href="#l9.742"></a><span id="l9.742" class="difflineplus">+  rv = srcFolder-&gt;GetDBFolderInfoAndDB(getter_AddRefs(folderInfo),</span>
<a href="#l9.743"></a><span id="l9.743" class="difflineplus">+                                       getter_AddRefs(srcDB));</span>
<a href="#l9.744"></a><span id="l9.744">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.745"></a><span id="l9.745"> </span>
<a href="#l9.746"></a><span id="l9.746" class="difflineminus">-  switch (m_opType)</span>
<a href="#l9.747"></a><span id="l9.747" class="difflineminus">-  {</span>
<a href="#l9.748"></a><span id="l9.748" class="difflineplus">+  switch (m_opType) {</span>
<a href="#l9.749"></a><span id="l9.749">     case nsIMsgOfflineImapOperation::kMsgMoved:</span>
<a href="#l9.750"></a><span id="l9.750">     case nsIMsgOfflineImapOperation::kMsgCopy:</span>
<a href="#l9.751"></a><span id="l9.751">     case nsIMsgOfflineImapOperation::kAddedHeader:</span>
<a href="#l9.752"></a><span id="l9.752">     case nsIMsgOfflineImapOperation::kFlagsChanged:</span>
<a href="#l9.753"></a><span id="l9.753" class="difflineminus">-    case nsIMsgOfflineImapOperation::kDeletedMsg:</span>
<a href="#l9.754"></a><span id="l9.754" class="difflineminus">-    {</span>
<a href="#l9.755"></a><span id="l9.755" class="difflineminus">-      if (m_srcHdrs.IsEmpty())</span>
<a href="#l9.756"></a><span id="l9.756" class="difflineminus">-      {</span>
<a href="#l9.757"></a><span id="l9.757" class="difflineplus">+    case nsIMsgOfflineImapOperation::kDeletedMsg: {</span>
<a href="#l9.758"></a><span id="l9.758" class="difflineplus">+      if (m_srcHdrs.IsEmpty()) {</span>
<a href="#l9.759"></a><span id="l9.759">         NS_ASSERTION(false, &quot;No msg header to apply undo.&quot;);</span>
<a href="#l9.760"></a><span id="l9.760">         break;</span>
<a href="#l9.761"></a><span id="l9.761">       }</span>
<a href="#l9.762"></a><span id="l9.762">       nsCOMPtr&lt;nsIMsgDBHdr&gt; firstHdr = m_srcHdrs[0];</span>
<a href="#l9.763"></a><span id="l9.763">       nsMsgKey hdrKey;</span>
<a href="#l9.764"></a><span id="l9.764">       firstHdr-&gt;GetMessageKey(&amp;hdrKey);</span>
<a href="#l9.765"></a><span id="l9.765">       rv = srcDB-&gt;GetOfflineOpForKey(hdrKey, false, getter_AddRefs(op));</span>
<a href="#l9.766"></a><span id="l9.766">       bool offlineOpPlayedBack = true;</span>
<a href="#l9.767"></a><span id="l9.767" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp; op)</span>
<a href="#l9.768"></a><span id="l9.768" class="difflineminus">-      {</span>
<a href="#l9.769"></a><span id="l9.769" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; op) {</span>
<a href="#l9.770"></a><span id="l9.770">         op-&gt;GetPlayingBack(&amp;offlineOpPlayedBack);</span>
<a href="#l9.771"></a><span id="l9.771">         srcDB-&gt;RemoveOfflineOp(op);</span>
<a href="#l9.772"></a><span id="l9.772">         op = nullptr;</span>
<a href="#l9.773"></a><span id="l9.773">       }</span>
<a href="#l9.774"></a><span id="l9.774" class="difflineminus">-      if (!WeAreOffline() &amp;&amp; offlineOpPlayedBack)</span>
<a href="#l9.775"></a><span id="l9.775" class="difflineminus">-      {</span>
<a href="#l9.776"></a><span id="l9.776" class="difflineplus">+      if (!WeAreOffline() &amp;&amp; offlineOpPlayedBack) {</span>
<a href="#l9.777"></a><span id="l9.777">         // couldn't find offline op - it must have been played back already</span>
<a href="#l9.778"></a><span id="l9.778">         // so we should undo the transaction online.</span>
<a href="#l9.779"></a><span id="l9.779">         return nsImapMoveCopyMsgTxn::UndoTransaction();</span>
<a href="#l9.780"></a><span id="l9.780">       }</span>
<a href="#l9.781"></a><span id="l9.781"> </span>
<a href="#l9.782"></a><span id="l9.782" class="difflineminus">-      if (!firstHdr)</span>
<a href="#l9.783"></a><span id="l9.783" class="difflineminus">-        break;</span>
<a href="#l9.784"></a><span id="l9.784" class="difflineplus">+      if (!firstHdr) break;</span>
<a href="#l9.785"></a><span id="l9.785">       nsMsgKey msgKey;</span>
<a href="#l9.786"></a><span id="l9.786" class="difflineminus">-      if (m_opType == nsIMsgOfflineImapOperation::kAddedHeader)</span>
<a href="#l9.787"></a><span id="l9.787" class="difflineminus">-      {</span>
<a href="#l9.788"></a><span id="l9.788" class="difflineminus">-        for (int32_t i = 0; i &lt; m_srcHdrs.Count(); i++)</span>
<a href="#l9.789"></a><span id="l9.789" class="difflineminus">-        {</span>
<a href="#l9.790"></a><span id="l9.790" class="difflineplus">+      if (m_opType == nsIMsgOfflineImapOperation::kAddedHeader) {</span>
<a href="#l9.791"></a><span id="l9.791" class="difflineplus">+        for (int32_t i = 0; i &lt; m_srcHdrs.Count(); i++) {</span>
<a href="#l9.792"></a><span id="l9.792">           m_srcHdrs[i]-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l9.793"></a><span id="l9.793">           nsCOMPtr&lt;nsIMsgDBHdr&gt; mailHdr;</span>
<a href="#l9.794"></a><span id="l9.794">           rv = srcDB-&gt;GetMsgHdrForKey(msgKey, getter_AddRefs(mailHdr));</span>
<a href="#l9.795"></a><span id="l9.795" class="difflineminus">-          if (mailHdr)</span>
<a href="#l9.796"></a><span id="l9.796" class="difflineminus">-            srcDB-&gt;DeleteHeader(mailHdr, nullptr, false, false);</span>
<a href="#l9.797"></a><span id="l9.797" class="difflineplus">+          if (mailHdr) srcDB-&gt;DeleteHeader(mailHdr, nullptr, false, false);</span>
<a href="#l9.798"></a><span id="l9.798">         }</span>
<a href="#l9.799"></a><span id="l9.799">         srcDB-&gt;Commit(true);</span>
<a href="#l9.800"></a><span id="l9.800" class="difflineminus">-      }</span>
<a href="#l9.801"></a><span id="l9.801" class="difflineminus">-      else if (m_opType == nsIMsgOfflineImapOperation::kDeletedMsg)</span>
<a href="#l9.802"></a><span id="l9.802" class="difflineminus">-      {</span>
<a href="#l9.803"></a><span id="l9.803" class="difflineminus">-        for (int32_t i = 0; i &lt; m_srcHdrs.Count(); i++)</span>
<a href="#l9.804"></a><span id="l9.804" class="difflineminus">-        {</span>
<a href="#l9.805"></a><span id="l9.805" class="difflineplus">+      } else if (m_opType == nsIMsgOfflineImapOperation::kDeletedMsg) {</span>
<a href="#l9.806"></a><span id="l9.806" class="difflineplus">+        for (int32_t i = 0; i &lt; m_srcHdrs.Count(); i++) {</span>
<a href="#l9.807"></a><span id="l9.807">           nsCOMPtr&lt;nsIMsgDBHdr&gt; undeletedHdr = m_srcHdrs[i];</span>
<a href="#l9.808"></a><span id="l9.808">           m_srcHdrs[i]-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l9.809"></a><span id="l9.809" class="difflineminus">-          if (undeletedHdr)</span>
<a href="#l9.810"></a><span id="l9.810" class="difflineminus">-          {</span>
<a href="#l9.811"></a><span id="l9.811" class="difflineplus">+          if (undeletedHdr) {</span>
<a href="#l9.812"></a><span id="l9.812">             nsCOMPtr&lt;nsIMsgDBHdr&gt; newHdr;</span>
<a href="#l9.813"></a><span id="l9.813" class="difflineminus">-            srcDB-&gt;CopyHdrFromExistingHdr (msgKey, undeletedHdr, true, getter_AddRefs(newHdr));</span>
<a href="#l9.814"></a><span id="l9.814" class="difflineplus">+            srcDB-&gt;CopyHdrFromExistingHdr(msgKey, undeletedHdr, true,</span>
<a href="#l9.815"></a><span id="l9.815" class="difflineplus">+                                          getter_AddRefs(newHdr));</span>
<a href="#l9.816"></a><span id="l9.816">           }</span>
<a href="#l9.817"></a><span id="l9.817">         }</span>
<a href="#l9.818"></a><span id="l9.818">         srcDB-&gt;Close(true);</span>
<a href="#l9.819"></a><span id="l9.819">         srcFolder-&gt;SummaryChanged();</span>
<a href="#l9.820"></a><span id="l9.820">       }</span>
<a href="#l9.821"></a><span id="l9.821">       break;</span>
<a href="#l9.822"></a><span id="l9.822">     }</span>
<a href="#l9.823"></a><span id="l9.823" class="difflineminus">-    case nsIMsgOfflineImapOperation::kMsgMarkedDeleted:</span>
<a href="#l9.824"></a><span id="l9.824" class="difflineminus">-      {</span>
<a href="#l9.825"></a><span id="l9.825" class="difflineminus">-        nsMsgKey msgKey;</span>
<a href="#l9.826"></a><span id="l9.826" class="difflineminus">-        for (int32_t i = 0; i &lt; m_srcHdrs.Count(); i++)</span>
<a href="#l9.827"></a><span id="l9.827" class="difflineminus">-        {</span>
<a href="#l9.828"></a><span id="l9.828" class="difflineminus">-          m_srcHdrs[i]-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l9.829"></a><span id="l9.829" class="difflineminus">-          srcDB-&gt;MarkImapDeleted(msgKey, false, nullptr);</span>
<a href="#l9.830"></a><span id="l9.830" class="difflineminus">-        }</span>
<a href="#l9.831"></a><span id="l9.831" class="difflineplus">+    case nsIMsgOfflineImapOperation::kMsgMarkedDeleted: {</span>
<a href="#l9.832"></a><span id="l9.832" class="difflineplus">+      nsMsgKey msgKey;</span>
<a href="#l9.833"></a><span id="l9.833" class="difflineplus">+      for (int32_t i = 0; i &lt; m_srcHdrs.Count(); i++) {</span>
<a href="#l9.834"></a><span id="l9.834" class="difflineplus">+        m_srcHdrs[i]-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l9.835"></a><span id="l9.835" class="difflineplus">+        srcDB-&gt;MarkImapDeleted(msgKey, false, nullptr);</span>
<a href="#l9.836"></a><span id="l9.836">       }</span>
<a href="#l9.837"></a><span id="l9.837" class="difflineminus">-      break;</span>
<a href="#l9.838"></a><span id="l9.838" class="difflineplus">+    } break;</span>
<a href="#l9.839"></a><span id="l9.839">     default:</span>
<a href="#l9.840"></a><span id="l9.840">       break;</span>
<a href="#l9.841"></a><span id="l9.841">   }</span>
<a href="#l9.842"></a><span id="l9.842">   srcDB-&gt;Close(true);</span>
<a href="#l9.843"></a><span id="l9.843">   srcFolder-&gt;SummaryChanged();</span>
<a href="#l9.844"></a><span id="l9.844">   return NS_OK;</span>
<a href="#l9.845"></a><span id="l9.845"> }</span>
<a href="#l9.846"></a><span id="l9.846"> </span>
<a href="#l9.847"></a><span id="l9.847" class="difflineminus">-NS_IMETHODIMP nsImapOfflineTxn::RedoTransaction(void)</span>
<a href="#l9.848"></a><span id="l9.848" class="difflineminus">-{</span>
<a href="#l9.849"></a><span id="l9.849" class="difflineplus">+NS_IMETHODIMP nsImapOfflineTxn::RedoTransaction(void) {</span>
<a href="#l9.850"></a><span id="l9.850">   nsresult rv;</span>
<a href="#l9.851"></a><span id="l9.851"> </span>
<a href="#l9.852"></a><span id="l9.852">   nsCOMPtr&lt;nsIMsgFolder&gt; srcFolder = do_QueryReferent(m_srcFolder, &amp;rv);</span>
<a href="#l9.853"></a><span id="l9.853" class="difflineminus">-  if (NS_FAILED(rv) || !srcFolder)</span>
<a href="#l9.854"></a><span id="l9.854" class="difflineminus">-    return rv;</span>
<a href="#l9.855"></a><span id="l9.855" class="difflineminus">-  nsCOMPtr &lt;nsIMsgOfflineImapOperation&gt; op;</span>
<a href="#l9.856"></a><span id="l9.856" class="difflineminus">-  nsCOMPtr &lt;nsIDBFolderInfo&gt; folderInfo;</span>
<a href="#l9.857"></a><span id="l9.857" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDatabase&gt; srcDB;</span>
<a href="#l9.858"></a><span id="l9.858" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDatabase&gt; destDB;</span>
<a href="#l9.859"></a><span id="l9.859" class="difflineminus">-  rv = srcFolder-&gt;GetDBFolderInfoAndDB(getter_AddRefs(folderInfo), getter_AddRefs(srcDB));</span>
<a href="#l9.860"></a><span id="l9.860" class="difflineplus">+  if (NS_FAILED(rv) || !srcFolder) return rv;</span>
<a href="#l9.861"></a><span id="l9.861" class="difflineplus">+  nsCOMPtr&lt;nsIMsgOfflineImapOperation&gt; op;</span>
<a href="#l9.862"></a><span id="l9.862" class="difflineplus">+  nsCOMPtr&lt;nsIDBFolderInfo&gt; folderInfo;</span>
<a href="#l9.863"></a><span id="l9.863" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDatabase&gt; srcDB;</span>
<a href="#l9.864"></a><span id="l9.864" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDatabase&gt; destDB;</span>
<a href="#l9.865"></a><span id="l9.865" class="difflineplus">+  rv = srcFolder-&gt;GetDBFolderInfoAndDB(getter_AddRefs(folderInfo),</span>
<a href="#l9.866"></a><span id="l9.866" class="difflineplus">+                                       getter_AddRefs(srcDB));</span>
<a href="#l9.867"></a><span id="l9.867">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.868"></a><span id="l9.868"> </span>
<a href="#l9.869"></a><span id="l9.869" class="difflineminus">-  switch (m_opType)</span>
<a href="#l9.870"></a><span id="l9.870" class="difflineminus">-  {</span>
<a href="#l9.871"></a><span id="l9.871" class="difflineminus">-  case nsIMsgOfflineImapOperation::kMsgMoved:</span>
<a href="#l9.872"></a><span id="l9.872" class="difflineminus">-  case nsIMsgOfflineImapOperation::kMsgCopy:</span>
<a href="#l9.873"></a><span id="l9.873" class="difflineminus">-    for (int32_t i = 0; i &lt; m_srcHdrs.Count(); i++)</span>
<a href="#l9.874"></a><span id="l9.874" class="difflineminus">-    {</span>
<a href="#l9.875"></a><span id="l9.875" class="difflineminus">-      nsMsgKey hdrKey;</span>
<a href="#l9.876"></a><span id="l9.876" class="difflineminus">-      m_srcHdrs[i]-&gt;GetMessageKey(&amp;hdrKey);</span>
<a href="#l9.877"></a><span id="l9.877" class="difflineminus">-      rv = srcDB-&gt;GetOfflineOpForKey(hdrKey, false, getter_AddRefs(op));</span>
<a href="#l9.878"></a><span id="l9.878" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp; op)</span>
<a href="#l9.879"></a><span id="l9.879" class="difflineminus">-      {</span>
<a href="#l9.880"></a><span id="l9.880" class="difflineminus">-        nsCOMPtr&lt;nsIMsgFolder&gt; dstFolder = do_QueryReferent(m_dstFolder, &amp;rv);</span>
<a href="#l9.881"></a><span id="l9.881" class="difflineminus">-        if (dstFolder)</span>
<a href="#l9.882"></a><span id="l9.882" class="difflineminus">-        {</span>
<a href="#l9.883"></a><span id="l9.883" class="difflineminus">-          nsCString folderURI;</span>
<a href="#l9.884"></a><span id="l9.884" class="difflineminus">-          dstFolder-&gt;GetURI(folderURI);</span>
<a href="#l9.885"></a><span id="l9.885" class="difflineplus">+  switch (m_opType) {</span>
<a href="#l9.886"></a><span id="l9.886" class="difflineplus">+    case nsIMsgOfflineImapOperation::kMsgMoved:</span>
<a href="#l9.887"></a><span id="l9.887" class="difflineplus">+    case nsIMsgOfflineImapOperation::kMsgCopy:</span>
<a href="#l9.888"></a><span id="l9.888" class="difflineplus">+      for (int32_t i = 0; i &lt; m_srcHdrs.Count(); i++) {</span>
<a href="#l9.889"></a><span id="l9.889" class="difflineplus">+        nsMsgKey hdrKey;</span>
<a href="#l9.890"></a><span id="l9.890" class="difflineplus">+        m_srcHdrs[i]-&gt;GetMessageKey(&amp;hdrKey);</span>
<a href="#l9.891"></a><span id="l9.891" class="difflineplus">+        rv = srcDB-&gt;GetOfflineOpForKey(hdrKey, false, getter_AddRefs(op));</span>
<a href="#l9.892"></a><span id="l9.892" class="difflineplus">+        if (NS_SUCCEEDED(rv) &amp;&amp; op) {</span>
<a href="#l9.893"></a><span id="l9.893" class="difflineplus">+          nsCOMPtr&lt;nsIMsgFolder&gt; dstFolder = do_QueryReferent(m_dstFolder, &amp;rv);</span>
<a href="#l9.894"></a><span id="l9.894" class="difflineplus">+          if (dstFolder) {</span>
<a href="#l9.895"></a><span id="l9.895" class="difflineplus">+            nsCString folderURI;</span>
<a href="#l9.896"></a><span id="l9.896" class="difflineplus">+            dstFolder-&gt;GetURI(folderURI);</span>
<a href="#l9.897"></a><span id="l9.897"> </span>
<a href="#l9.898"></a><span id="l9.898" class="difflineminus">-          if (m_opType == nsIMsgOfflineImapOperation::kMsgMoved)</span>
<a href="#l9.899"></a><span id="l9.899" class="difflineminus">-            op-&gt;SetDestinationFolderURI(folderURI.get()); // offline move</span>
<a href="#l9.900"></a><span id="l9.900" class="difflineminus">-          if (m_opType == nsIMsgOfflineImapOperation::kMsgCopy)</span>
<a href="#l9.901"></a><span id="l9.901" class="difflineminus">-          {</span>
<a href="#l9.902"></a><span id="l9.902" class="difflineminus">-            op-&gt;SetOperation(nsIMsgOfflineImapOperation::kMsgMoved);</span>
<a href="#l9.903"></a><span id="l9.903" class="difflineminus">-            op-&gt;AddMessageCopyOperation(folderURI.get()); // offline copy</span>
<a href="#l9.904"></a><span id="l9.904" class="difflineplus">+            if (m_opType == nsIMsgOfflineImapOperation::kMsgMoved)</span>
<a href="#l9.905"></a><span id="l9.905" class="difflineplus">+              op-&gt;SetDestinationFolderURI(folderURI.get());  // offline move</span>
<a href="#l9.906"></a><span id="l9.906" class="difflineplus">+            if (m_opType == nsIMsgOfflineImapOperation::kMsgCopy) {</span>
<a href="#l9.907"></a><span id="l9.907" class="difflineplus">+              op-&gt;SetOperation(nsIMsgOfflineImapOperation::kMsgMoved);</span>
<a href="#l9.908"></a><span id="l9.908" class="difflineplus">+              op-&gt;AddMessageCopyOperation(folderURI.get());  // offline copy</span>
<a href="#l9.909"></a><span id="l9.909" class="difflineplus">+            }</span>
<a href="#l9.910"></a><span id="l9.910" class="difflineplus">+            dstFolder-&gt;SummaryChanged();</span>
<a href="#l9.911"></a><span id="l9.911">           }</span>
<a href="#l9.912"></a><span id="l9.912" class="difflineminus">-          dstFolder-&gt;SummaryChanged();</span>
<a href="#l9.913"></a><span id="l9.913" class="difflineplus">+        } else if (!WeAreOffline()) {</span>
<a href="#l9.914"></a><span id="l9.914" class="difflineplus">+          // couldn't find offline op - it must have been played back already</span>
<a href="#l9.915"></a><span id="l9.915" class="difflineplus">+          // so we should redo the transaction online.</span>
<a href="#l9.916"></a><span id="l9.916" class="difflineplus">+          return nsImapMoveCopyMsgTxn::RedoTransaction();</span>
<a href="#l9.917"></a><span id="l9.917">         }</span>
<a href="#l9.918"></a><span id="l9.918">       }</span>
<a href="#l9.919"></a><span id="l9.919" class="difflineminus">-      else if (!WeAreOffline())</span>
<a href="#l9.920"></a><span id="l9.920" class="difflineminus">-      {</span>
<a href="#l9.921"></a><span id="l9.921" class="difflineminus">-        // couldn't find offline op - it must have been played back already</span>
<a href="#l9.922"></a><span id="l9.922" class="difflineminus">-        // so we should redo the transaction online.</span>
<a href="#l9.923"></a><span id="l9.923" class="difflineminus">-        return nsImapMoveCopyMsgTxn::RedoTransaction();</span>
<a href="#l9.924"></a><span id="l9.924" class="difflineminus">-      }</span>
<a href="#l9.925"></a><span id="l9.925" class="difflineminus">-    }</span>
<a href="#l9.926"></a><span id="l9.926" class="difflineminus">-    break;</span>
<a href="#l9.927"></a><span id="l9.927" class="difflineminus">-  case nsIMsgOfflineImapOperation::kAddedHeader:</span>
<a href="#l9.928"></a><span id="l9.928" class="difflineminus">-    {</span>
<a href="#l9.929"></a><span id="l9.929" class="difflineplus">+      break;</span>
<a href="#l9.930"></a><span id="l9.930" class="difflineplus">+    case nsIMsgOfflineImapOperation::kAddedHeader: {</span>
<a href="#l9.931"></a><span id="l9.931">       nsCOMPtr&lt;nsIMsgFolder&gt; dstFolder = do_QueryReferent(m_dstFolder, &amp;rv);</span>
<a href="#l9.932"></a><span id="l9.932" class="difflineminus">-      rv = srcFolder-&gt;GetDBFolderInfoAndDB(getter_AddRefs(folderInfo), getter_AddRefs(destDB));</span>
<a href="#l9.933"></a><span id="l9.933" class="difflineplus">+      rv = srcFolder-&gt;GetDBFolderInfoAndDB(getter_AddRefs(folderInfo),</span>
<a href="#l9.934"></a><span id="l9.934" class="difflineplus">+                                           getter_AddRefs(destDB));</span>
<a href="#l9.935"></a><span id="l9.935">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.936"></a><span id="l9.936" class="difflineminus">-      for (int32_t i = 0; i &lt; m_srcHdrs.Count(); i++)</span>
<a href="#l9.937"></a><span id="l9.937" class="difflineminus">-      {</span>
<a href="#l9.938"></a><span id="l9.938" class="difflineplus">+      for (int32_t i = 0; i &lt; m_srcHdrs.Count(); i++) {</span>
<a href="#l9.939"></a><span id="l9.939">         nsCOMPtr&lt;nsIMsgDBHdr&gt; restoreHdr;</span>
<a href="#l9.940"></a><span id="l9.940">         nsMsgKey msgKey;</span>
<a href="#l9.941"></a><span id="l9.941">         m_srcHdrs[i]-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l9.942"></a><span id="l9.942" class="difflineminus">-        destDB-&gt;CopyHdrFromExistingHdr (msgKey, m_srcHdrs[i], true, getter_AddRefs(restoreHdr));</span>
<a href="#l9.943"></a><span id="l9.943" class="difflineplus">+        destDB-&gt;CopyHdrFromExistingHdr(msgKey, m_srcHdrs[i], true,</span>
<a href="#l9.944"></a><span id="l9.944" class="difflineplus">+                                       getter_AddRefs(restoreHdr));</span>
<a href="#l9.945"></a><span id="l9.945">         rv = destDB-&gt;GetOfflineOpForKey(msgKey, true, getter_AddRefs(op));</span>
<a href="#l9.946"></a><span id="l9.946" class="difflineminus">-        if (NS_SUCCEEDED(rv) &amp;&amp; op)</span>
<a href="#l9.947"></a><span id="l9.947" class="difflineminus">-        {</span>
<a href="#l9.948"></a><span id="l9.948" class="difflineplus">+        if (NS_SUCCEEDED(rv) &amp;&amp; op) {</span>
<a href="#l9.949"></a><span id="l9.949">           nsCString folderURI;</span>
<a href="#l9.950"></a><span id="l9.950">           srcFolder-&gt;GetURI(folderURI);</span>
<a href="#l9.951"></a><span id="l9.951">           op-&gt;SetSourceFolderURI(folderURI.get());</span>
<a href="#l9.952"></a><span id="l9.952">         }</span>
<a href="#l9.953"></a><span id="l9.953">       }</span>
<a href="#l9.954"></a><span id="l9.954">       dstFolder-&gt;SummaryChanged();</span>
<a href="#l9.955"></a><span id="l9.955">       destDB-&gt;Close(true);</span>
<a href="#l9.956"></a><span id="l9.956" class="difflineminus">-    }</span>
<a href="#l9.957"></a><span id="l9.957" class="difflineminus">-    break;</span>
<a href="#l9.958"></a><span id="l9.958" class="difflineminus">-  case nsIMsgOfflineImapOperation::kDeletedMsg:</span>
<a href="#l9.959"></a><span id="l9.959" class="difflineminus">-    for (int32_t i = 0; i &lt; m_srcHdrs.Count(); i++)</span>
<a href="#l9.960"></a><span id="l9.960" class="difflineminus">-    {</span>
<a href="#l9.961"></a><span id="l9.961" class="difflineminus">-      nsMsgKey msgKey;</span>
<a href="#l9.962"></a><span id="l9.962" class="difflineminus">-      m_srcHdrs[i]-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l9.963"></a><span id="l9.963" class="difflineminus">-      srcDB-&gt;DeleteMessage(msgKey, nullptr, true);</span>
<a href="#l9.964"></a><span id="l9.964" class="difflineminus">-    }</span>
<a href="#l9.965"></a><span id="l9.965" class="difflineminus">-    break;</span>
<a href="#l9.966"></a><span id="l9.966" class="difflineminus">-  case nsIMsgOfflineImapOperation::kMsgMarkedDeleted:</span>
<a href="#l9.967"></a><span id="l9.967" class="difflineminus">-    for (int32_t i = 0; i &lt; m_srcHdrs.Count(); i++)</span>
<a href="#l9.968"></a><span id="l9.968" class="difflineminus">-    {</span>
<a href="#l9.969"></a><span id="l9.969" class="difflineminus">-      nsMsgKey msgKey;</span>
<a href="#l9.970"></a><span id="l9.970" class="difflineminus">-      m_srcHdrs[i]-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l9.971"></a><span id="l9.971" class="difflineminus">-      srcDB-&gt;MarkImapDeleted(msgKey, true, nullptr);</span>
<a href="#l9.972"></a><span id="l9.972" class="difflineminus">-    }</span>
<a href="#l9.973"></a><span id="l9.973" class="difflineminus">-    break;</span>
<a href="#l9.974"></a><span id="l9.974" class="difflineminus">-  case nsIMsgOfflineImapOperation::kFlagsChanged:</span>
<a href="#l9.975"></a><span id="l9.975" class="difflineminus">-    for (int32_t i = 0; i &lt; m_srcHdrs.Count(); i++)</span>
<a href="#l9.976"></a><span id="l9.976" class="difflineminus">-    {</span>
<a href="#l9.977"></a><span id="l9.977" class="difflineminus">-      nsMsgKey msgKey;</span>
<a href="#l9.978"></a><span id="l9.978" class="difflineminus">-      m_srcHdrs[i]-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l9.979"></a><span id="l9.979" class="difflineminus">-      rv = srcDB-&gt;GetOfflineOpForKey(msgKey, true, getter_AddRefs(op));</span>
<a href="#l9.980"></a><span id="l9.980" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp; op)</span>
<a href="#l9.981"></a><span id="l9.981" class="difflineminus">-      {</span>
<a href="#l9.982"></a><span id="l9.982" class="difflineminus">-        imapMessageFlagsType newMsgFlags;</span>
<a href="#l9.983"></a><span id="l9.983" class="difflineminus">-        op-&gt;GetNewFlags(&amp;newMsgFlags);</span>
<a href="#l9.984"></a><span id="l9.984" class="difflineminus">-        if (m_addFlags)</span>
<a href="#l9.985"></a><span id="l9.985" class="difflineminus">-          op-&gt;SetFlagOperation(newMsgFlags | m_flags);</span>
<a href="#l9.986"></a><span id="l9.986" class="difflineminus">-        else</span>
<a href="#l9.987"></a><span id="l9.987" class="difflineminus">-          op-&gt;SetFlagOperation(newMsgFlags &amp; ~m_flags);</span>
<a href="#l9.988"></a><span id="l9.988" class="difflineplus">+    } break;</span>
<a href="#l9.989"></a><span id="l9.989" class="difflineplus">+    case nsIMsgOfflineImapOperation::kDeletedMsg:</span>
<a href="#l9.990"></a><span id="l9.990" class="difflineplus">+      for (int32_t i = 0; i &lt; m_srcHdrs.Count(); i++) {</span>
<a href="#l9.991"></a><span id="l9.991" class="difflineplus">+        nsMsgKey msgKey;</span>
<a href="#l9.992"></a><span id="l9.992" class="difflineplus">+        m_srcHdrs[i]-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l9.993"></a><span id="l9.993" class="difflineplus">+        srcDB-&gt;DeleteMessage(msgKey, nullptr, true);</span>
<a href="#l9.994"></a><span id="l9.994" class="difflineplus">+      }</span>
<a href="#l9.995"></a><span id="l9.995" class="difflineplus">+      break;</span>
<a href="#l9.996"></a><span id="l9.996" class="difflineplus">+    case nsIMsgOfflineImapOperation::kMsgMarkedDeleted:</span>
<a href="#l9.997"></a><span id="l9.997" class="difflineplus">+      for (int32_t i = 0; i &lt; m_srcHdrs.Count(); i++) {</span>
<a href="#l9.998"></a><span id="l9.998" class="difflineplus">+        nsMsgKey msgKey;</span>
<a href="#l9.999"></a><span id="l9.999" class="difflineplus">+        m_srcHdrs[i]-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l9.1000"></a><span id="l9.1000" class="difflineplus">+        srcDB-&gt;MarkImapDeleted(msgKey, true, nullptr);</span>
<a href="#l9.1001"></a><span id="l9.1001">       }</span>
<a href="#l9.1002"></a><span id="l9.1002" class="difflineminus">-    }</span>
<a href="#l9.1003"></a><span id="l9.1003" class="difflineminus">-    break;</span>
<a href="#l9.1004"></a><span id="l9.1004" class="difflineminus">-  default:</span>
<a href="#l9.1005"></a><span id="l9.1005" class="difflineminus">-    break;</span>
<a href="#l9.1006"></a><span id="l9.1006" class="difflineplus">+      break;</span>
<a href="#l9.1007"></a><span id="l9.1007" class="difflineplus">+    case nsIMsgOfflineImapOperation::kFlagsChanged:</span>
<a href="#l9.1008"></a><span id="l9.1008" class="difflineplus">+      for (int32_t i = 0; i &lt; m_srcHdrs.Count(); i++) {</span>
<a href="#l9.1009"></a><span id="l9.1009" class="difflineplus">+        nsMsgKey msgKey;</span>
<a href="#l9.1010"></a><span id="l9.1010" class="difflineplus">+        m_srcHdrs[i]-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l9.1011"></a><span id="l9.1011" class="difflineplus">+        rv = srcDB-&gt;GetOfflineOpForKey(msgKey, true, getter_AddRefs(op));</span>
<a href="#l9.1012"></a><span id="l9.1012" class="difflineplus">+        if (NS_SUCCEEDED(rv) &amp;&amp; op) {</span>
<a href="#l9.1013"></a><span id="l9.1013" class="difflineplus">+          imapMessageFlagsType newMsgFlags;</span>
<a href="#l9.1014"></a><span id="l9.1014" class="difflineplus">+          op-&gt;GetNewFlags(&amp;newMsgFlags);</span>
<a href="#l9.1015"></a><span id="l9.1015" class="difflineplus">+          if (m_addFlags)</span>
<a href="#l9.1016"></a><span id="l9.1016" class="difflineplus">+            op-&gt;SetFlagOperation(newMsgFlags | m_flags);</span>
<a href="#l9.1017"></a><span id="l9.1017" class="difflineplus">+          else</span>
<a href="#l9.1018"></a><span id="l9.1018" class="difflineplus">+            op-&gt;SetFlagOperation(newMsgFlags &amp; ~m_flags);</span>
<a href="#l9.1019"></a><span id="l9.1019" class="difflineplus">+        }</span>
<a href="#l9.1020"></a><span id="l9.1020" class="difflineplus">+      }</span>
<a href="#l9.1021"></a><span id="l9.1021" class="difflineplus">+      break;</span>
<a href="#l9.1022"></a><span id="l9.1022" class="difflineplus">+    default:</span>
<a href="#l9.1023"></a><span id="l9.1023" class="difflineplus">+      break;</span>
<a href="#l9.1024"></a><span id="l9.1024">   }</span>
<a href="#l9.1025"></a><span id="l9.1025">   srcDB-&gt;Close(true);</span>
<a href="#l9.1026"></a><span id="l9.1026">   srcDB = nullptr;</span>
<a href="#l9.1027"></a><span id="l9.1027">   srcFolder-&gt;SummaryChanged();</span>
<a href="#l9.1028"></a><span id="l9.1028">   return NS_OK;</span>
<a href="#l9.1029"></a><span id="l9.1029"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/imap/src/nsImapUndoTxn.h</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapUndoTxn.h</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -13,43 +13,41 @@</span>
<a href="#l10.4"></a><span id="l10.4"> #include &quot;nsMsgTxn.h&quot;</span>
<a href="#l10.5"></a><span id="l10.5"> #include &quot;MailNewsTypes.h&quot;</span>
<a href="#l10.6"></a><span id="l10.6"> #include &quot;nsTArray.h&quot;</span>
<a href="#l10.7"></a><span id="l10.7"> #include &quot;nsIMsgOfflineImapOperation.h&quot;</span>
<a href="#l10.8"></a><span id="l10.8"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l10.9"></a><span id="l10.9"> #include &quot;nsIWeakReferenceUtils.h&quot;</span>
<a href="#l10.10"></a><span id="l10.10"> #include &quot;nsCOMArray.h&quot;</span>
<a href="#l10.11"></a><span id="l10.11"> </span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-class nsImapMoveCopyMsgTxn : public nsMsgTxn, nsIUrlListener</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineminus">-{</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineminus">-public:</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineminus">-</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineplus">+class nsImapMoveCopyMsgTxn : public nsMsgTxn, nsIUrlListener {</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineplus">+ public:</span>
<a href="#l10.18"></a><span id="l10.18">   nsImapMoveCopyMsgTxn();</span>
<a href="#l10.19"></a><span id="l10.19">   nsImapMoveCopyMsgTxn(nsIMsgFolder* srcFolder, nsTArray&lt;nsMsgKey&gt;* srcKeyArray,</span>
<a href="#l10.20"></a><span id="l10.20">                        const char* srcMsgIdString, nsIMsgFolder* dstFolder,</span>
<a href="#l10.21"></a><span id="l10.21">                        bool isMove);</span>
<a href="#l10.22"></a><span id="l10.22"> </span>
<a href="#l10.23"></a><span id="l10.23">   NS_DECL_ISUPPORTS_INHERITED</span>
<a href="#l10.24"></a><span id="l10.24">   NS_DECL_NSIURLLISTENER</span>
<a href="#l10.25"></a><span id="l10.25"> </span>
<a href="#l10.26"></a><span id="l10.26">   NS_IMETHOD UndoTransaction(void) override;</span>
<a href="#l10.27"></a><span id="l10.27">   NS_IMETHOD RedoTransaction(void) override;</span>
<a href="#l10.28"></a><span id="l10.28"> </span>
<a href="#l10.29"></a><span id="l10.29">   // helper</span>
<a href="#l10.30"></a><span id="l10.30" class="difflineminus">-  nsresult SetCopyResponseUid(const char *msgIdString);</span>
<a href="#l10.31"></a><span id="l10.31" class="difflineplus">+  nsresult SetCopyResponseUid(const char* msgIdString);</span>
<a href="#l10.32"></a><span id="l10.32">   nsresult GetSrcKeyArray(nsTArray&lt;nsMsgKey&gt;&amp; srcKeyArray);</span>
<a href="#l10.33"></a><span id="l10.33" class="difflineminus">-  void GetSrcMsgIds(nsCString &amp;srcMsgIds) {srcMsgIds = m_srcMsgIdString;}</span>
<a href="#l10.34"></a><span id="l10.34" class="difflineplus">+  void GetSrcMsgIds(nsCString&amp; srcMsgIds) { srcMsgIds = m_srcMsgIdString; }</span>
<a href="#l10.35"></a><span id="l10.35">   nsresult AddDstKey(nsMsgKey aKey);</span>
<a href="#l10.36"></a><span id="l10.36">   nsresult UndoMailboxDelete();</span>
<a href="#l10.37"></a><span id="l10.37">   nsresult RedoMailboxDelete();</span>
<a href="#l10.38"></a><span id="l10.38">   nsresult Init(nsIMsgFolder* srcFolder, nsTArray&lt;nsMsgKey&gt;* srcKeyArray,</span>
<a href="#l10.39"></a><span id="l10.39">                 const char* srcMsgIdString, nsIMsgFolder* dstFolder,</span>
<a href="#l10.40"></a><span id="l10.40">                 bool idsAreUids, bool isMove);</span>
<a href="#l10.41"></a><span id="l10.41"> </span>
<a href="#l10.42"></a><span id="l10.42" class="difflineminus">-protected:</span>
<a href="#l10.43"></a><span id="l10.43" class="difflineplus">+ protected:</span>
<a href="#l10.44"></a><span id="l10.44">   virtual ~nsImapMoveCopyMsgTxn();</span>
<a href="#l10.45"></a><span id="l10.45"> </span>
<a href="#l10.46"></a><span id="l10.46">   nsWeakPtr m_srcFolder;</span>
<a href="#l10.47"></a><span id="l10.47">   nsCOMArray&lt;nsIMsgDBHdr&gt; m_srcHdrs;</span>
<a href="#l10.48"></a><span id="l10.48">   nsTArray&lt;nsMsgKey&gt; m_dupKeyArray;</span>
<a href="#l10.49"></a><span id="l10.49">   nsTArray&lt;nsMsgKey&gt; m_srcKeyArray;</span>
<a href="#l10.50"></a><span id="l10.50">   nsTArray&lt;nsCString&gt; m_srcMessageIds;</span>
<a href="#l10.51"></a><span id="l10.51">   nsCString m_srcMsgIdString;</span>
<a href="#l10.52"></a><span id="l10.52" class="difflineat">@@ -58,33 +56,32 @@ protected:</span>
<a href="#l10.53"></a><span id="l10.53">   bool m_idsAreUids;</span>
<a href="#l10.54"></a><span id="l10.54">   bool m_isMove;</span>
<a href="#l10.55"></a><span id="l10.55">   bool m_srcIsPop3;</span>
<a href="#l10.56"></a><span id="l10.56">   nsTArray&lt;uint32_t&gt; m_srcSizeArray;</span>
<a href="#l10.57"></a><span id="l10.57">   // this is used when we chain urls for imap undo, since &quot;this&quot; needs</span>
<a href="#l10.58"></a><span id="l10.58">   // to be the listener, but the folder may need to also be notified.</span>
<a href="#l10.59"></a><span id="l10.59">   nsWeakPtr m_onStopListener;</span>
<a href="#l10.60"></a><span id="l10.60"> </span>
<a href="#l10.61"></a><span id="l10.61" class="difflineminus">-  nsresult GetImapDeleteModel(nsIMsgFolder* aFolder, nsMsgImapDeleteModel *aDeleteModel);</span>
<a href="#l10.62"></a><span id="l10.62" class="difflineplus">+  nsresult GetImapDeleteModel(nsIMsgFolder* aFolder,</span>
<a href="#l10.63"></a><span id="l10.63" class="difflineplus">+                              nsMsgImapDeleteModel* aDeleteModel);</span>
<a href="#l10.64"></a><span id="l10.64"> };</span>
<a href="#l10.65"></a><span id="l10.65"> </span>
<a href="#l10.66"></a><span id="l10.66" class="difflineminus">-class nsImapOfflineTxn : public nsImapMoveCopyMsgTxn</span>
<a href="#l10.67"></a><span id="l10.67" class="difflineminus">-{</span>
<a href="#l10.68"></a><span id="l10.68" class="difflineminus">-public:</span>
<a href="#l10.69"></a><span id="l10.69" class="difflineplus">+class nsImapOfflineTxn : public nsImapMoveCopyMsgTxn {</span>
<a href="#l10.70"></a><span id="l10.70" class="difflineplus">+ public:</span>
<a href="#l10.71"></a><span id="l10.71">   nsImapOfflineTxn(nsIMsgFolder* srcFolder, nsTArray&lt;nsMsgKey&gt;* srcKeyArray,</span>
<a href="#l10.72"></a><span id="l10.72" class="difflineminus">-                   const char* srcMsgIdString,</span>
<a href="#l10.73"></a><span id="l10.73" class="difflineminus">-                   nsIMsgFolder* dstFolder,</span>
<a href="#l10.74"></a><span id="l10.74" class="difflineminus">-                   bool isMove,</span>
<a href="#l10.75"></a><span id="l10.75" class="difflineminus">-                   nsOfflineImapOperationType opType,</span>
<a href="#l10.76"></a><span id="l10.76" class="difflineminus">-                   nsCOMArray&lt;nsIMsgDBHdr&gt; &amp;srcHdrs);</span>
<a href="#l10.77"></a><span id="l10.77" class="difflineplus">+                   const char* srcMsgIdString, nsIMsgFolder* dstFolder,</span>
<a href="#l10.78"></a><span id="l10.78" class="difflineplus">+                   bool isMove, nsOfflineImapOperationType opType,</span>
<a href="#l10.79"></a><span id="l10.79" class="difflineplus">+                   nsCOMArray&lt;nsIMsgDBHdr&gt;&amp; srcHdrs);</span>
<a href="#l10.80"></a><span id="l10.80"> </span>
<a href="#l10.81"></a><span id="l10.81">   NS_IMETHOD UndoTransaction(void) override;</span>
<a href="#l10.82"></a><span id="l10.82">   NS_IMETHOD RedoTransaction(void) override;</span>
<a href="#l10.83"></a><span id="l10.83" class="difflineminus">-  void SetAddFlags(bool addFlags) {m_addFlags = addFlags;}</span>
<a href="#l10.84"></a><span id="l10.84" class="difflineminus">-  void SetFlags(uint32_t flags) {m_flags = flags;}</span>
<a href="#l10.85"></a><span id="l10.85" class="difflineminus">-protected:</span>
<a href="#l10.86"></a><span id="l10.86" class="difflineplus">+  void SetAddFlags(bool addFlags) { m_addFlags = addFlags; }</span>
<a href="#l10.87"></a><span id="l10.87" class="difflineplus">+  void SetFlags(uint32_t flags) { m_flags = flags; }</span>
<a href="#l10.88"></a><span id="l10.88" class="difflineplus">+</span>
<a href="#l10.89"></a><span id="l10.89" class="difflineplus">+ protected:</span>
<a href="#l10.90"></a><span id="l10.90">   virtual ~nsImapOfflineTxn();</span>
<a href="#l10.91"></a><span id="l10.91">   nsOfflineImapOperationType m_opType;</span>
<a href="#l10.92"></a><span id="l10.92">   // these two are used to undo flag changes, which we don't currently do.</span>
<a href="#l10.93"></a><span id="l10.93">   bool m_addFlags;</span>
<a href="#l10.94"></a><span id="l10.94">   uint32_t m_flags;</span>
<a href="#l10.95"></a><span id="l10.95"> };</span>
<a href="#l10.96"></a><span id="l10.96"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/imap/src/nsImapUrl.cpp</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapUrl.cpp</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -1,14 +1,14 @@</span>
<a href="#l11.4"></a><span id="l11.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l11.5"></a><span id="l11.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l11.6"></a><span id="l11.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l11.7"></a><span id="l11.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l11.8"></a><span id="l11.8"> </span>
<a href="#l11.9"></a><span id="l11.9" class="difflineminus">-#include &quot;msgCore.h&quot;    // precompiled header...</span>
<a href="#l11.10"></a><span id="l11.10" class="difflineplus">+#include &quot;msgCore.h&quot;  // precompiled header...</span>
<a href="#l11.11"></a><span id="l11.11"> #include &quot;nsMsgImapCID.h&quot;</span>
<a href="#l11.12"></a><span id="l11.12"> </span>
<a href="#l11.13"></a><span id="l11.13"> #include &quot;nsImapUrl.h&quot;</span>
<a href="#l11.14"></a><span id="l11.14"> #include &quot;nsIIMAPHostSessionList.h&quot;</span>
<a href="#l11.15"></a><span id="l11.15"> #include &quot;nsThreadUtils.h&quot;</span>
<a href="#l11.16"></a><span id="l11.16"> #include &quot;nsString.h&quot;</span>
<a href="#l11.17"></a><span id="l11.17"> #include &quot;prmem.h&quot;</span>
<a href="#l11.18"></a><span id="l11.18"> #include &quot;plstr.h&quot;</span>
<a href="#l11.19"></a><span id="l11.19" class="difflineat">@@ -28,52 +28,51 @@</span>
<a href="#l11.20"></a><span id="l11.20"> #include &quot;nsIMsgHdr.h&quot;</span>
<a href="#l11.21"></a><span id="l11.21"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l11.22"></a><span id="l11.22"> </span>
<a href="#l11.23"></a><span id="l11.23"> using namespace mozilla;</span>
<a href="#l11.24"></a><span id="l11.24"> extern LazyLogModule IMAPCache;  // defined in nsImapProtocol.cpp</span>
<a href="#l11.25"></a><span id="l11.25"> </span>
<a href="#l11.26"></a><span id="l11.26"> static NS_DEFINE_CID(kCImapHostSessionListCID, NS_IIMAPHOSTSESSIONLIST_CID);</span>
<a href="#l11.27"></a><span id="l11.27"> </span>
<a href="#l11.28"></a><span id="l11.28" class="difflineminus">-nsImapUrl::nsImapUrl() : mLock(&quot;nsImapUrl.mLock&quot;)</span>
<a href="#l11.29"></a><span id="l11.29" class="difflineminus">-{</span>
<a href="#l11.30"></a><span id="l11.30" class="difflineplus">+nsImapUrl::nsImapUrl() : mLock(&quot;nsImapUrl.mLock&quot;) {</span>
<a href="#l11.31"></a><span id="l11.31">   m_listOfMessageIds = nullptr;</span>
<a href="#l11.32"></a><span id="l11.32">   m_sourceCanonicalFolderPathSubString = nullptr;</span>
<a href="#l11.33"></a><span id="l11.33">   m_destinationCanonicalFolderPathSubString = nullptr;</span>
<a href="#l11.34"></a><span id="l11.34">   m_listOfMessageIds = nullptr;</span>
<a href="#l11.35"></a><span id="l11.35">   m_tokenPlaceHolder = nullptr;</span>
<a href="#l11.36"></a><span id="l11.36">   m_searchCriteriaString = nullptr;</span>
<a href="#l11.37"></a><span id="l11.37">   m_idsAreUids = false;</span>
<a href="#l11.38"></a><span id="l11.38">   m_mimePartSelectorDetected = false;</span>
<a href="#l11.39"></a><span id="l11.39" class="difflineminus">-  m_allowContentChange = true;  // assume we can do MPOD.</span>
<a href="#l11.40"></a><span id="l11.40" class="difflineminus">-  m_fetchPartsOnDemand = false; // but assume we're not doing it :-)</span>
<a href="#l11.41"></a><span id="l11.41" class="difflineplus">+  m_allowContentChange = true;   // assume we can do MPOD.</span>
<a href="#l11.42"></a><span id="l11.42" class="difflineplus">+  m_fetchPartsOnDemand = false;  // but assume we're not doing it :-)</span>
<a href="#l11.43"></a><span id="l11.43">   m_msgLoadingFromCache = false;</span>
<a href="#l11.44"></a><span id="l11.44">   m_storeResultsOffline = false;</span>
<a href="#l11.45"></a><span id="l11.45">   m_storeOfflineOnFallback = false;</span>
<a href="#l11.46"></a><span id="l11.46">   m_localFetchOnly = false;</span>
<a href="#l11.47"></a><span id="l11.47">   m_rerunningUrl = false;</span>
<a href="#l11.48"></a><span id="l11.48">   m_moreHeadersToDownload = false;</span>
<a href="#l11.49"></a><span id="l11.49" class="difflineminus">-  m_externalLinkUrl = true; // we'll start this at true, and set it false in nsImapService::CreateStartOfImapUrl</span>
<a href="#l11.50"></a><span id="l11.50" class="difflineplus">+  m_externalLinkUrl = true;  // we'll start this at true, and set it false in</span>
<a href="#l11.51"></a><span id="l11.51" class="difflineplus">+                             // nsImapService::CreateStartOfImapUrl</span>
<a href="#l11.52"></a><span id="l11.52">   m_contentModified = IMAP_CONTENT_NOT_MODIFIED;</span>
<a href="#l11.53"></a><span id="l11.53">   m_validUrl = true;  // assume the best.</span>
<a href="#l11.54"></a><span id="l11.54">   m_flags = 0;</span>
<a href="#l11.55"></a><span id="l11.55">   m_extraStatus = ImapStatusNone;</span>
<a href="#l11.56"></a><span id="l11.56">   m_onlineSubDirSeparator = '/';</span>
<a href="#l11.57"></a><span id="l11.57"> </span>
<a href="#l11.58"></a><span id="l11.58">   // ** jt - the following are not ref counted</span>
<a href="#l11.59"></a><span id="l11.59">   m_copyState = nullptr;</span>
<a href="#l11.60"></a><span id="l11.60">   m_file = nullptr;</span>
<a href="#l11.61"></a><span id="l11.61">   m_imapMailFolderSink = nullptr;</span>
<a href="#l11.62"></a><span id="l11.62">   m_imapMessageSink = nullptr;</span>
<a href="#l11.63"></a><span id="l11.63">   m_addDummyEnvelope = false;</span>
<a href="#l11.64"></a><span id="l11.64">   m_canonicalLineEnding = false;</span>
<a href="#l11.65"></a><span id="l11.65"> }</span>
<a href="#l11.66"></a><span id="l11.66"> </span>
<a href="#l11.67"></a><span id="l11.67" class="difflineminus">-nsImapUrl::~nsImapUrl()</span>
<a href="#l11.68"></a><span id="l11.68" class="difflineminus">-{</span>
<a href="#l11.69"></a><span id="l11.69" class="difflineplus">+nsImapUrl::~nsImapUrl() {</span>
<a href="#l11.70"></a><span id="l11.70">   PR_FREEIF(m_listOfMessageIds);</span>
<a href="#l11.71"></a><span id="l11.71">   PR_FREEIF(m_destinationCanonicalFolderPathSubString);</span>
<a href="#l11.72"></a><span id="l11.72">   PR_FREEIF(m_sourceCanonicalFolderPathSubString);</span>
<a href="#l11.73"></a><span id="l11.73">   PR_FREEIF(m_searchCriteriaString);</span>
<a href="#l11.74"></a><span id="l11.74"> }</span>
<a href="#l11.75"></a><span id="l11.75"> </span>
<a href="#l11.76"></a><span id="l11.76"> NS_IMPL_ADDREF_INHERITED(nsImapUrl, nsMsgMailNewsUrl)</span>
<a href="#l11.77"></a><span id="l11.77"> </span>
<a href="#l11.78"></a><span id="l11.78" class="difflineat">@@ -84,1148 +83,981 @@ NS_INTERFACE_MAP_BEGIN(nsImapUrl)</span>
<a href="#l11.79"></a><span id="l11.79">   NS_INTERFACE_MAP_ENTRY(nsIMsgMessageUrl)</span>
<a href="#l11.80"></a><span id="l11.80">   NS_INTERFACE_MAP_ENTRY(nsIMsgI18NUrl)</span>
<a href="#l11.81"></a><span id="l11.81"> NS_INTERFACE_MAP_END_INHERITING(nsMsgMailNewsUrl)</span>
<a href="#l11.82"></a><span id="l11.82"> </span>
<a href="#l11.83"></a><span id="l11.83"> ////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l11.84"></a><span id="l11.84"> // Begin nsIImapUrl specific support</span>
<a href="#l11.85"></a><span id="l11.85"> ////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l11.86"></a><span id="l11.86"> </span>
<a href="#l11.87"></a><span id="l11.87" class="difflineminus">-NS_IMETHODIMP nsImapUrl::GetRequiredImapState(nsImapState * aImapUrlState)</span>
<a href="#l11.88"></a><span id="l11.88" class="difflineminus">-{</span>
<a href="#l11.89"></a><span id="l11.89" class="difflineminus">-  if (aImapUrlState)</span>
<a href="#l11.90"></a><span id="l11.90" class="difflineminus">-  {</span>
<a href="#l11.91"></a><span id="l11.91" class="difflineplus">+NS_IMETHODIMP nsImapUrl::GetRequiredImapState(nsImapState *aImapUrlState) {</span>
<a href="#l11.92"></a><span id="l11.92" class="difflineplus">+  if (aImapUrlState) {</span>
<a href="#l11.93"></a><span id="l11.93">     // the imap action determines the state we must be in...check the</span>
<a href="#l11.94"></a><span id="l11.94">     // the imap action.</span>
<a href="#l11.95"></a><span id="l11.95"> </span>
<a href="#l11.96"></a><span id="l11.96">     if (m_imapAction &amp; 0x10000000)</span>
<a href="#l11.97"></a><span id="l11.97">       *aImapUrlState = nsImapSelectedState;</span>
<a href="#l11.98"></a><span id="l11.98">     else</span>
<a href="#l11.99"></a><span id="l11.99">       *aImapUrlState = nsImapAuthenticatedState;</span>
<a href="#l11.100"></a><span id="l11.100">   }</span>
<a href="#l11.101"></a><span id="l11.101"> </span>
<a href="#l11.102"></a><span id="l11.102">   return NS_OK;</span>
<a href="#l11.103"></a><span id="l11.103"> }</span>
<a href="#l11.104"></a><span id="l11.104"> </span>
<a href="#l11.105"></a><span id="l11.105" class="difflineminus">-NS_IMETHODIMP nsImapUrl::GetImapAction(nsImapAction * aImapAction)</span>
<a href="#l11.106"></a><span id="l11.106" class="difflineminus">-{</span>
<a href="#l11.107"></a><span id="l11.107" class="difflineplus">+NS_IMETHODIMP nsImapUrl::GetImapAction(nsImapAction *aImapAction) {</span>
<a href="#l11.108"></a><span id="l11.108">   *aImapAction = m_imapAction;</span>
<a href="#l11.109"></a><span id="l11.109">   return NS_OK;</span>
<a href="#l11.110"></a><span id="l11.110"> }</span>
<a href="#l11.111"></a><span id="l11.111"> </span>
<a href="#l11.112"></a><span id="l11.112" class="difflineminus">-NS_IMETHODIMP nsImapUrl::SetImapAction(nsImapAction aImapAction)</span>
<a href="#l11.113"></a><span id="l11.113" class="difflineminus">-{</span>
<a href="#l11.114"></a><span id="l11.114" class="difflineplus">+NS_IMETHODIMP nsImapUrl::SetImapAction(nsImapAction aImapAction) {</span>
<a href="#l11.115"></a><span id="l11.115">   m_imapAction = aImapAction;</span>
<a href="#l11.116"></a><span id="l11.116">   return NS_OK;</span>
<a href="#l11.117"></a><span id="l11.117"> }</span>
<a href="#l11.118"></a><span id="l11.118"> </span>
<a href="#l11.119"></a><span id="l11.119" class="difflineminus">-NS_IMETHODIMP nsImapUrl::GetFolder(nsIMsgFolder **aMsgFolder)</span>
<a href="#l11.120"></a><span id="l11.120" class="difflineminus">-{</span>
<a href="#l11.121"></a><span id="l11.121" class="difflineplus">+NS_IMETHODIMP nsImapUrl::GetFolder(nsIMsgFolder **aMsgFolder) {</span>
<a href="#l11.122"></a><span id="l11.122">   NS_ENSURE_ARG_POINTER(aMsgFolder);</span>
<a href="#l11.123"></a><span id="l11.123">   NS_ENSURE_ARG_POINTER(m_imapFolder);</span>
<a href="#l11.124"></a><span id="l11.124"> </span>
<a href="#l11.125"></a><span id="l11.125">   nsCOMPtr&lt;nsIMsgFolder&gt; folder = do_QueryReferent(m_imapFolder);</span>
<a href="#l11.126"></a><span id="l11.126">   folder.forget(aMsgFolder);</span>
<a href="#l11.127"></a><span id="l11.127">   return NS_OK;</span>
<a href="#l11.128"></a><span id="l11.128"> }</span>
<a href="#l11.129"></a><span id="l11.129"> </span>
<a href="#l11.130"></a><span id="l11.130" class="difflineminus">-NS_IMETHODIMP nsImapUrl::SetFolder(nsIMsgFolder  * aMsgFolder)</span>
<a href="#l11.131"></a><span id="l11.131" class="difflineminus">-{</span>
<a href="#l11.132"></a><span id="l11.132" class="difflineplus">+NS_IMETHODIMP nsImapUrl::SetFolder(nsIMsgFolder *aMsgFolder) {</span>
<a href="#l11.133"></a><span id="l11.133">   nsresult rv;</span>
<a href="#l11.134"></a><span id="l11.134">   m_imapFolder = do_GetWeakReference(aMsgFolder, &amp;rv);</span>
<a href="#l11.135"></a><span id="l11.135" class="difflineminus">-  if (aMsgFolder)</span>
<a href="#l11.136"></a><span id="l11.136" class="difflineminus">-  {</span>
<a href="#l11.137"></a><span id="l11.137" class="difflineminus">-    nsCOMPtr &lt;nsIMsgIncomingServer&gt; incomingServer;</span>
<a href="#l11.138"></a><span id="l11.138" class="difflineplus">+  if (aMsgFolder) {</span>
<a href="#l11.139"></a><span id="l11.139" class="difflineplus">+    nsCOMPtr&lt;nsIMsgIncomingServer&gt; incomingServer;</span>
<a href="#l11.140"></a><span id="l11.140">     aMsgFolder-&gt;GetServer(getter_AddRefs(incomingServer));</span>
<a href="#l11.141"></a><span id="l11.141" class="difflineminus">-    if (incomingServer)</span>
<a href="#l11.142"></a><span id="l11.142" class="difflineminus">-      incomingServer-&gt;GetKey(m_serverKey);</span>
<a href="#l11.143"></a><span id="l11.143" class="difflineplus">+    if (incomingServer) incomingServer-&gt;GetKey(m_serverKey);</span>
<a href="#l11.144"></a><span id="l11.144">   }</span>
<a href="#l11.145"></a><span id="l11.145">   return rv;</span>
<a href="#l11.146"></a><span id="l11.146"> }</span>
<a href="#l11.147"></a><span id="l11.147"> </span>
<a href="#l11.148"></a><span id="l11.148" class="difflineminus">-NS_IMETHODIMP nsImapUrl::GetImapMailFolderSink(nsIImapMailFolderSink **</span>
<a href="#l11.149"></a><span id="l11.149" class="difflineminus">-                                           aImapMailFolderSink)</span>
<a href="#l11.150"></a><span id="l11.150" class="difflineminus">-{</span>
<a href="#l11.151"></a><span id="l11.151" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aImapMailFolderSink);</span>
<a href="#l11.152"></a><span id="l11.152" class="difflineminus">-    if (!m_imapMailFolderSink)</span>
<a href="#l11.153"></a><span id="l11.153" class="difflineminus">-      return NS_ERROR_NULL_POINTER; // no assert, so don't use NS_ENSURE_POINTER.</span>
<a href="#l11.154"></a><span id="l11.154" class="difflineplus">+NS_IMETHODIMP nsImapUrl::GetImapMailFolderSink(</span>
<a href="#l11.155"></a><span id="l11.155" class="difflineplus">+    nsIImapMailFolderSink **aImapMailFolderSink) {</span>
<a href="#l11.156"></a><span id="l11.156" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aImapMailFolderSink);</span>
<a href="#l11.157"></a><span id="l11.157" class="difflineplus">+  if (!m_imapMailFolderSink)</span>
<a href="#l11.158"></a><span id="l11.158" class="difflineplus">+    return NS_ERROR_NULL_POINTER;  // no assert, so don't use NS_ENSURE_POINTER.</span>
<a href="#l11.159"></a><span id="l11.159"> </span>
<a href="#l11.160"></a><span id="l11.160" class="difflineminus">-    nsCOMPtr&lt;nsIImapMailFolderSink&gt; folderSink = do_QueryReferent(m_imapMailFolderSink);</span>
<a href="#l11.161"></a><span id="l11.161" class="difflineminus">-    folderSink.forget(aImapMailFolderSink);</span>
<a href="#l11.162"></a><span id="l11.162" class="difflineminus">-    return NS_OK;</span>
<a href="#l11.163"></a><span id="l11.163" class="difflineplus">+  nsCOMPtr&lt;nsIImapMailFolderSink&gt; folderSink =</span>
<a href="#l11.164"></a><span id="l11.164" class="difflineplus">+      do_QueryReferent(m_imapMailFolderSink);</span>
<a href="#l11.165"></a><span id="l11.165" class="difflineplus">+  folderSink.forget(aImapMailFolderSink);</span>
<a href="#l11.166"></a><span id="l11.166" class="difflineplus">+  return NS_OK;</span>
<a href="#l11.167"></a><span id="l11.167"> }</span>
<a href="#l11.168"></a><span id="l11.168"> </span>
<a href="#l11.169"></a><span id="l11.169" class="difflineminus">-NS_IMETHODIMP nsImapUrl::SetImapMailFolderSink(nsIImapMailFolderSink  * aImapMailFolderSink)</span>
<a href="#l11.170"></a><span id="l11.170" class="difflineminus">-{</span>
<a href="#l11.171"></a><span id="l11.171" class="difflineminus">-    nsresult rv;</span>
<a href="#l11.172"></a><span id="l11.172" class="difflineminus">-    m_imapMailFolderSink = do_GetWeakReference(aImapMailFolderSink, &amp;rv);</span>
<a href="#l11.173"></a><span id="l11.173" class="difflineminus">-    return rv;</span>
<a href="#l11.174"></a><span id="l11.174" class="difflineplus">+NS_IMETHODIMP nsImapUrl::SetImapMailFolderSink(</span>
<a href="#l11.175"></a><span id="l11.175" class="difflineplus">+    nsIImapMailFolderSink *aImapMailFolderSink) {</span>
<a href="#l11.176"></a><span id="l11.176" class="difflineplus">+  nsresult rv;</span>
<a href="#l11.177"></a><span id="l11.177" class="difflineplus">+  m_imapMailFolderSink = do_GetWeakReference(aImapMailFolderSink, &amp;rv);</span>
<a href="#l11.178"></a><span id="l11.178" class="difflineplus">+  return rv;</span>
<a href="#l11.179"></a><span id="l11.179"> }</span>
<a href="#l11.180"></a><span id="l11.180"> </span>
<a href="#l11.181"></a><span id="l11.181" class="difflineminus">-NS_IMETHODIMP nsImapUrl::GetImapMessageSink(nsIImapMessageSink ** aImapMessageSink)</span>
<a href="#l11.182"></a><span id="l11.182" class="difflineminus">-{</span>
<a href="#l11.183"></a><span id="l11.183" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aImapMessageSink);</span>
<a href="#l11.184"></a><span id="l11.184" class="difflineminus">-    NS_ENSURE_ARG_POINTER(m_imapMessageSink);</span>
<a href="#l11.185"></a><span id="l11.185" class="difflineplus">+NS_IMETHODIMP nsImapUrl::GetImapMessageSink(</span>
<a href="#l11.186"></a><span id="l11.186" class="difflineplus">+    nsIImapMessageSink **aImapMessageSink) {</span>
<a href="#l11.187"></a><span id="l11.187" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aImapMessageSink);</span>
<a href="#l11.188"></a><span id="l11.188" class="difflineplus">+  NS_ENSURE_ARG_POINTER(m_imapMessageSink);</span>
<a href="#l11.189"></a><span id="l11.189"> </span>
<a href="#l11.190"></a><span id="l11.190" class="difflineminus">-    nsCOMPtr&lt;nsIImapMessageSink&gt; messageSink = do_QueryReferent(m_imapMessageSink);</span>
<a href="#l11.191"></a><span id="l11.191" class="difflineminus">-    messageSink.forget(aImapMessageSink);</span>
<a href="#l11.192"></a><span id="l11.192" class="difflineminus">-    return NS_OK;</span>
<a href="#l11.193"></a><span id="l11.193" class="difflineplus">+  nsCOMPtr&lt;nsIImapMessageSink&gt; messageSink =</span>
<a href="#l11.194"></a><span id="l11.194" class="difflineplus">+      do_QueryReferent(m_imapMessageSink);</span>
<a href="#l11.195"></a><span id="l11.195" class="difflineplus">+  messageSink.forget(aImapMessageSink);</span>
<a href="#l11.196"></a><span id="l11.196" class="difflineplus">+  return NS_OK;</span>
<a href="#l11.197"></a><span id="l11.197"> }</span>
<a href="#l11.198"></a><span id="l11.198"> </span>
<a href="#l11.199"></a><span id="l11.199" class="difflineminus">-NS_IMETHODIMP nsImapUrl::SetImapMessageSink(nsIImapMessageSink  * aImapMessageSink)</span>
<a href="#l11.200"></a><span id="l11.200" class="difflineminus">-{</span>
<a href="#l11.201"></a><span id="l11.201" class="difflineplus">+NS_IMETHODIMP nsImapUrl::SetImapMessageSink(</span>
<a href="#l11.202"></a><span id="l11.202" class="difflineplus">+    nsIImapMessageSink *aImapMessageSink) {</span>
<a href="#l11.203"></a><span id="l11.203">   nsresult rv;</span>
<a href="#l11.204"></a><span id="l11.204">   m_imapMessageSink = do_GetWeakReference(aImapMessageSink, &amp;rv);</span>
<a href="#l11.205"></a><span id="l11.205">   return rv;</span>
<a href="#l11.206"></a><span id="l11.206"> }</span>
<a href="#l11.207"></a><span id="l11.207"> </span>
<a href="#l11.208"></a><span id="l11.208" class="difflineminus">-NS_IMETHODIMP nsImapUrl::GetImapServerSink(nsIImapServerSink ** aImapServerSink)</span>
<a href="#l11.209"></a><span id="l11.209" class="difflineminus">-{</span>
<a href="#l11.210"></a><span id="l11.210" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aImapServerSink);</span>
<a href="#l11.211"></a><span id="l11.211" class="difflineminus">-    NS_ENSURE_ARG_POINTER(m_imapServerSink);</span>
<a href="#l11.212"></a><span id="l11.212" class="difflineplus">+NS_IMETHODIMP nsImapUrl::GetImapServerSink(</span>
<a href="#l11.213"></a><span id="l11.213" class="difflineplus">+    nsIImapServerSink **aImapServerSink) {</span>
<a href="#l11.214"></a><span id="l11.214" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aImapServerSink);</span>
<a href="#l11.215"></a><span id="l11.215" class="difflineplus">+  NS_ENSURE_ARG_POINTER(m_imapServerSink);</span>
<a href="#l11.216"></a><span id="l11.216"> </span>
<a href="#l11.217"></a><span id="l11.217" class="difflineminus">-    nsCOMPtr&lt;nsIImapServerSink&gt; serverSink = do_QueryReferent(m_imapServerSink);</span>
<a href="#l11.218"></a><span id="l11.218" class="difflineminus">-    serverSink.forget(aImapServerSink);</span>
<a href="#l11.219"></a><span id="l11.219" class="difflineminus">-    return NS_OK;</span>
<a href="#l11.220"></a><span id="l11.220" class="difflineplus">+  nsCOMPtr&lt;nsIImapServerSink&gt; serverSink = do_QueryReferent(m_imapServerSink);</span>
<a href="#l11.221"></a><span id="l11.221" class="difflineplus">+  serverSink.forget(aImapServerSink);</span>
<a href="#l11.222"></a><span id="l11.222" class="difflineplus">+  return NS_OK;</span>
<a href="#l11.223"></a><span id="l11.223"> }</span>
<a href="#l11.224"></a><span id="l11.224"> </span>
<a href="#l11.225"></a><span id="l11.225" class="difflineminus">-NS_IMETHODIMP nsImapUrl::SetImapServerSink(nsIImapServerSink  * aImapServerSink)</span>
<a href="#l11.226"></a><span id="l11.226" class="difflineminus">-{</span>
<a href="#l11.227"></a><span id="l11.227" class="difflineplus">+NS_IMETHODIMP nsImapUrl::SetImapServerSink(nsIImapServerSink *aImapServerSink) {</span>
<a href="#l11.228"></a><span id="l11.228">   nsresult rv;</span>
<a href="#l11.229"></a><span id="l11.229">   m_imapServerSink = do_GetWeakReference(aImapServerSink, &amp;rv);</span>
<a href="#l11.230"></a><span id="l11.230">   return rv;</span>
<a href="#l11.231"></a><span id="l11.231"> }</span>
<a href="#l11.232"></a><span id="l11.232"> </span>
<a href="#l11.233"></a><span id="l11.233" class="difflineminus">-</span>
<a href="#l11.234"></a><span id="l11.234"> ////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l11.235"></a><span id="l11.235"> // End nsIImapUrl specific support</span>
<a href="#l11.236"></a><span id="l11.236"> ////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l11.237"></a><span id="l11.237"> </span>
<a href="#l11.238"></a><span id="l11.238" class="difflineminus">-nsresult nsImapUrl::SetSpecInternal(const nsACString &amp;aSpec)</span>
<a href="#l11.239"></a><span id="l11.239" class="difflineminus">-{</span>
<a href="#l11.240"></a><span id="l11.240" class="difflineplus">+nsresult nsImapUrl::SetSpecInternal(const nsACString &amp;aSpec) {</span>
<a href="#l11.241"></a><span id="l11.241">   nsresult rv = nsMsgMailNewsUrl::SetSpecInternal(aSpec);</span>
<a href="#l11.242"></a><span id="l11.242" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l11.243"></a><span id="l11.243" class="difflineminus">-  {</span>
<a href="#l11.244"></a><span id="l11.244" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l11.245"></a><span id="l11.245">     m_validUrl = true;  // assume the best.</span>
<a href="#l11.246"></a><span id="l11.246">     rv = ParseUrl();</span>
<a href="#l11.247"></a><span id="l11.247">   }</span>
<a href="#l11.248"></a><span id="l11.248">   return rv;</span>
<a href="#l11.249"></a><span id="l11.249"> }</span>
<a href="#l11.250"></a><span id="l11.250"> </span>
<a href="#l11.251"></a><span id="l11.251" class="difflineminus">-nsresult nsImapUrl::SetQuery(const nsACString &amp;aQuery)</span>
<a href="#l11.252"></a><span id="l11.252" class="difflineminus">-{</span>
<a href="#l11.253"></a><span id="l11.253" class="difflineplus">+nsresult nsImapUrl::SetQuery(const nsACString &amp;aQuery) {</span>
<a href="#l11.254"></a><span id="l11.254">   nsresult rv = nsMsgMailNewsUrl::SetQuery(aQuery);</span>
<a href="#l11.255"></a><span id="l11.255" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l11.256"></a><span id="l11.256" class="difflineminus">-    rv = ParseUrl();</span>
<a href="#l11.257"></a><span id="l11.257" class="difflineplus">+  if (NS_SUCCEEDED(rv)) rv = ParseUrl();</span>
<a href="#l11.258"></a><span id="l11.258">   return rv;</span>
<a href="#l11.259"></a><span id="l11.259"> }</span>
<a href="#l11.260"></a><span id="l11.260"> </span>
<a href="#l11.261"></a><span id="l11.261" class="difflineminus">-nsresult nsImapUrl::ParseUrl()</span>
<a href="#l11.262"></a><span id="l11.262" class="difflineminus">-{</span>
<a href="#l11.263"></a><span id="l11.263" class="difflineplus">+nsresult nsImapUrl::ParseUrl() {</span>
<a href="#l11.264"></a><span id="l11.264">   nsresult rv = NS_OK;</span>
<a href="#l11.265"></a><span id="l11.265">   // extract the user name</span>
<a href="#l11.266"></a><span id="l11.266">   GetUserPass(m_userName);</span>
<a href="#l11.267"></a><span id="l11.267"> </span>
<a href="#l11.268"></a><span id="l11.268">   nsAutoCString imapPartOfUrl;</span>
<a href="#l11.269"></a><span id="l11.269">   rv = GetPathQueryRef(imapPartOfUrl);</span>
<a href="#l11.270"></a><span id="l11.270">   nsAutoCString unescapedImapPartOfUrl;</span>
<a href="#l11.271"></a><span id="l11.271">   MsgUnescapeString(imapPartOfUrl, 0, unescapedImapPartOfUrl);</span>
<a href="#l11.272"></a><span id="l11.272" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; !unescapedImapPartOfUrl.IsEmpty())</span>
<a href="#l11.273"></a><span id="l11.273" class="difflineminus">-  {</span>
<a href="#l11.274"></a><span id="l11.274" class="difflineminus">-    ParseImapPart(unescapedImapPartOfUrl.BeginWriting()+1);  // GetPath leaves leading '/' in the path!!!</span>
<a href="#l11.275"></a><span id="l11.275" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; !unescapedImapPartOfUrl.IsEmpty()) {</span>
<a href="#l11.276"></a><span id="l11.276" class="difflineplus">+    ParseImapPart(unescapedImapPartOfUrl.BeginWriting() +</span>
<a href="#l11.277"></a><span id="l11.277" class="difflineplus">+                  1);  // GetPath leaves leading '/' in the path!!!</span>
<a href="#l11.278"></a><span id="l11.278">   }</span>
<a href="#l11.279"></a><span id="l11.279"> </span>
<a href="#l11.280"></a><span id="l11.280">   return NS_OK;</span>
<a href="#l11.281"></a><span id="l11.281"> }</span>
<a href="#l11.282"></a><span id="l11.282"> </span>
<a href="#l11.283"></a><span id="l11.283" class="difflineminus">-NS_IMETHODIMP nsImapUrl::CreateSearchCriteriaString(char ** aResult)</span>
<a href="#l11.284"></a><span id="l11.284" class="difflineminus">-{</span>
<a href="#l11.285"></a><span id="l11.285" class="difflineplus">+NS_IMETHODIMP nsImapUrl::CreateSearchCriteriaString(char **aResult) {</span>
<a href="#l11.286"></a><span id="l11.286">   // this method should only be called from the imap thread...</span>
<a href="#l11.287"></a><span id="l11.287">   // o.t. add lock protection..</span>
<a href="#l11.288"></a><span id="l11.288">   if (nullptr == aResult || !m_searchCriteriaString)</span>
<a href="#l11.289"></a><span id="l11.289" class="difflineminus">-    return  NS_ERROR_NULL_POINTER;</span>
<a href="#l11.290"></a><span id="l11.290" class="difflineplus">+    return NS_ERROR_NULL_POINTER;</span>
<a href="#l11.291"></a><span id="l11.291">   *aResult = strdup(m_searchCriteriaString);</span>
<a href="#l11.292"></a><span id="l11.292">   return NS_OK;</span>
<a href="#l11.293"></a><span id="l11.293"> }</span>
<a href="#l11.294"></a><span id="l11.294"> </span>
<a href="#l11.295"></a><span id="l11.295"> // this method gets called from the UI thread and the imap thread</span>
<a href="#l11.296"></a><span id="l11.296" class="difflineminus">-NS_IMETHODIMP nsImapUrl::GetListOfMessageIds(nsACString &amp;aResult)</span>
<a href="#l11.297"></a><span id="l11.297" class="difflineminus">-{</span>
<a href="#l11.298"></a><span id="l11.298" class="difflineplus">+NS_IMETHODIMP nsImapUrl::GetListOfMessageIds(nsACString &amp;aResult) {</span>
<a href="#l11.299"></a><span id="l11.299">   MutexAutoLock mon(mLock);</span>
<a href="#l11.300"></a><span id="l11.300" class="difflineminus">-  if (!m_listOfMessageIds)</span>
<a href="#l11.301"></a><span id="l11.301" class="difflineminus">-    return  NS_ERROR_NULL_POINTER;</span>
<a href="#l11.302"></a><span id="l11.302" class="difflineplus">+  if (!m_listOfMessageIds) return NS_ERROR_NULL_POINTER;</span>
<a href="#l11.303"></a><span id="l11.303"> </span>
<a href="#l11.304"></a><span id="l11.304">   int32_t bytesToCopy = strlen(m_listOfMessageIds);</span>
<a href="#l11.305"></a><span id="l11.305"> </span>
<a href="#l11.306"></a><span id="l11.306">   // mime may have glommed a &quot;&amp;part=&quot; for a part download</span>
<a href="#l11.307"></a><span id="l11.307">   // we return the entire message and let mime extract</span>
<a href="#l11.308"></a><span id="l11.308">   // the part. Pop and news work this way also.</span>
<a href="#l11.309"></a><span id="l11.309">   // this algorithm truncates the &quot;&amp;part&quot; string.</span>
<a href="#l11.310"></a><span id="l11.310">   char *currentChar = m_listOfMessageIds;</span>
<a href="#l11.311"></a><span id="l11.311" class="difflineminus">-  while (*currentChar &amp;&amp; (*currentChar != '?'))</span>
<a href="#l11.312"></a><span id="l11.312" class="difflineminus">-    currentChar++;</span>
<a href="#l11.313"></a><span id="l11.313" class="difflineminus">-  if (*currentChar == '?')</span>
<a href="#l11.314"></a><span id="l11.314" class="difflineminus">-    bytesToCopy = currentChar - m_listOfMessageIds;</span>
<a href="#l11.315"></a><span id="l11.315" class="difflineplus">+  while (*currentChar &amp;&amp; (*currentChar != '?')) currentChar++;</span>
<a href="#l11.316"></a><span id="l11.316" class="difflineplus">+  if (*currentChar == '?') bytesToCopy = currentChar - m_listOfMessageIds;</span>
<a href="#l11.317"></a><span id="l11.317"> </span>
<a href="#l11.318"></a><span id="l11.318">   // we should also strip off anything after &quot;/;section=&quot;</span>
<a href="#l11.319"></a><span id="l11.319">   // since that can specify an IMAP MIME part</span>
<a href="#l11.320"></a><span id="l11.320">   char *wherePart = PL_strstr(m_listOfMessageIds, &quot;/;section=&quot;);</span>
<a href="#l11.321"></a><span id="l11.321">   if (wherePart)</span>
<a href="#l11.322"></a><span id="l11.322" class="difflineminus">-    bytesToCopy = std::min(bytesToCopy, int32_t(wherePart - m_listOfMessageIds));</span>
<a href="#l11.323"></a><span id="l11.323" class="difflineplus">+    bytesToCopy =</span>
<a href="#l11.324"></a><span id="l11.324" class="difflineplus">+        std::min(bytesToCopy, int32_t(wherePart - m_listOfMessageIds));</span>
<a href="#l11.325"></a><span id="l11.325"> </span>
<a href="#l11.326"></a><span id="l11.326">   aResult.Assign(m_listOfMessageIds, bytesToCopy);</span>
<a href="#l11.327"></a><span id="l11.327">   return NS_OK;</span>
<a href="#l11.328"></a><span id="l11.328"> }</span>
<a href="#l11.329"></a><span id="l11.329"> </span>
<a href="#l11.330"></a><span id="l11.330" class="difflineminus">-NS_IMETHODIMP nsImapUrl::GetCommand(nsACString &amp;result)</span>
<a href="#l11.331"></a><span id="l11.331" class="difflineminus">-{</span>
<a href="#l11.332"></a><span id="l11.332" class="difflineplus">+NS_IMETHODIMP nsImapUrl::GetCommand(nsACString &amp;result) {</span>
<a href="#l11.333"></a><span id="l11.333">   result = m_command;</span>
<a href="#l11.334"></a><span id="l11.334">   return NS_OK;</span>
<a href="#l11.335"></a><span id="l11.335"> }</span>
<a href="#l11.336"></a><span id="l11.336"> </span>
<a href="#l11.337"></a><span id="l11.337" class="difflineminus">-</span>
<a href="#l11.338"></a><span id="l11.338" class="difflineminus">-NS_IMETHODIMP nsImapUrl::GetCustomAttributeToFetch(nsACString &amp;result)</span>
<a href="#l11.339"></a><span id="l11.339" class="difflineminus">-{</span>
<a href="#l11.340"></a><span id="l11.340" class="difflineplus">+NS_IMETHODIMP nsImapUrl::GetCustomAttributeToFetch(nsACString &amp;result) {</span>
<a href="#l11.341"></a><span id="l11.341">   result = m_msgFetchAttribute;</span>
<a href="#l11.342"></a><span id="l11.342">   return NS_OK;</span>
<a href="#l11.343"></a><span id="l11.343"> }</span>
<a href="#l11.344"></a><span id="l11.344"> </span>
<a href="#l11.345"></a><span id="l11.345" class="difflineminus">-NS_IMETHODIMP nsImapUrl::GetCustomAttributeResult(nsACString &amp;result)</span>
<a href="#l11.346"></a><span id="l11.346" class="difflineminus">-{</span>
<a href="#l11.347"></a><span id="l11.347" class="difflineplus">+NS_IMETHODIMP nsImapUrl::GetCustomAttributeResult(nsACString &amp;result) {</span>
<a href="#l11.348"></a><span id="l11.348">   result = m_customAttributeResult;</span>
<a href="#l11.349"></a><span id="l11.349">   return NS_OK;</span>
<a href="#l11.350"></a><span id="l11.350"> }</span>
<a href="#l11.351"></a><span id="l11.351"> </span>
<a href="#l11.352"></a><span id="l11.352" class="difflineminus">-NS_IMETHODIMP nsImapUrl::SetCustomAttributeResult(const nsACString &amp;result)</span>
<a href="#l11.353"></a><span id="l11.353" class="difflineminus">-{</span>
<a href="#l11.354"></a><span id="l11.354" class="difflineplus">+NS_IMETHODIMP nsImapUrl::SetCustomAttributeResult(const nsACString &amp;result) {</span>
<a href="#l11.355"></a><span id="l11.355">   m_customAttributeResult = result;</span>
<a href="#l11.356"></a><span id="l11.356">   return NS_OK;</span>
<a href="#l11.357"></a><span id="l11.357"> }</span>
<a href="#l11.358"></a><span id="l11.358"> </span>
<a href="#l11.359"></a><span id="l11.359" class="difflineminus">-NS_IMETHODIMP nsImapUrl::GetCustomCommandResult(nsACString &amp;result)</span>
<a href="#l11.360"></a><span id="l11.360" class="difflineminus">-{</span>
<a href="#l11.361"></a><span id="l11.361" class="difflineplus">+NS_IMETHODIMP nsImapUrl::GetCustomCommandResult(nsACString &amp;result) {</span>
<a href="#l11.362"></a><span id="l11.362">   result = m_customCommandResult;</span>
<a href="#l11.363"></a><span id="l11.363">   return NS_OK;</span>
<a href="#l11.364"></a><span id="l11.364"> }</span>
<a href="#l11.365"></a><span id="l11.365"> </span>
<a href="#l11.366"></a><span id="l11.366" class="difflineminus">-NS_IMETHODIMP nsImapUrl::SetCustomCommandResult(const nsACString &amp;result)</span>
<a href="#l11.367"></a><span id="l11.367" class="difflineminus">-{</span>
<a href="#l11.368"></a><span id="l11.368" class="difflineplus">+NS_IMETHODIMP nsImapUrl::SetCustomCommandResult(const nsACString &amp;result) {</span>
<a href="#l11.369"></a><span id="l11.369">   m_customCommandResult = result;</span>
<a href="#l11.370"></a><span id="l11.370">   return NS_OK;</span>
<a href="#l11.371"></a><span id="l11.371"> }</span>
<a href="#l11.372"></a><span id="l11.372"> </span>
<a href="#l11.373"></a><span id="l11.373" class="difflineminus">-NS_IMETHODIMP nsImapUrl::GetCustomAddFlags(nsACString &amp;aResult)</span>
<a href="#l11.374"></a><span id="l11.374" class="difflineminus">-{</span>
<a href="#l11.375"></a><span id="l11.375" class="difflineplus">+NS_IMETHODIMP nsImapUrl::GetCustomAddFlags(nsACString &amp;aResult) {</span>
<a href="#l11.376"></a><span id="l11.376">   aResult = m_customAddFlags;</span>
<a href="#l11.377"></a><span id="l11.377">   return NS_OK;</span>
<a href="#l11.378"></a><span id="l11.378"> }</span>
<a href="#l11.379"></a><span id="l11.379"> </span>
<a href="#l11.380"></a><span id="l11.380" class="difflineminus">-NS_IMETHODIMP nsImapUrl::GetCustomSubtractFlags(nsACString &amp;aResult)</span>
<a href="#l11.381"></a><span id="l11.381" class="difflineminus">-{</span>
<a href="#l11.382"></a><span id="l11.382" class="difflineplus">+NS_IMETHODIMP nsImapUrl::GetCustomSubtractFlags(nsACString &amp;aResult) {</span>
<a href="#l11.383"></a><span id="l11.383">   aResult = m_customSubtractFlags;</span>
<a href="#l11.384"></a><span id="l11.384">   return NS_OK;</span>
<a href="#l11.385"></a><span id="l11.385"> }</span>
<a href="#l11.386"></a><span id="l11.386"> </span>
<a href="#l11.387"></a><span id="l11.387" class="difflineminus">-</span>
<a href="#l11.388"></a><span id="l11.388" class="difflineminus">-NS_IMETHODIMP nsImapUrl::GetImapPartToFetch(char **result)</span>
<a href="#l11.389"></a><span id="l11.389" class="difflineminus">-{</span>
<a href="#l11.390"></a><span id="l11.390" class="difflineplus">+NS_IMETHODIMP nsImapUrl::GetImapPartToFetch(char **result) {</span>
<a href="#l11.391"></a><span id="l11.391">   //  here's the old code....</span>
<a href="#l11.392"></a><span id="l11.392"> </span>
<a href="#l11.393"></a><span id="l11.393">   // unfortunately an imap part can have the form: /;section= OR</span>
<a href="#l11.394"></a><span id="l11.394">   // it can have the form ?section=. We need to look for both.</span>
<a href="#l11.395"></a><span id="l11.395" class="difflineminus">-  if (m_listOfMessageIds)</span>
<a href="#l11.396"></a><span id="l11.396" class="difflineminus">-  {</span>
<a href="#l11.397"></a><span id="l11.397" class="difflineplus">+  if (m_listOfMessageIds) {</span>
<a href="#l11.398"></a><span id="l11.398">     char *wherepart = PL_strstr(m_listOfMessageIds, &quot;;section=&quot;);</span>
<a href="#l11.399"></a><span id="l11.399" class="difflineminus">-    if (!wherepart) // look for ?section too....</span>
<a href="#l11.400"></a><span id="l11.400" class="difflineplus">+    if (!wherepart)  // look for ?section too....</span>
<a href="#l11.401"></a><span id="l11.401">       wherepart = PL_strstr(m_listOfMessageIds, &quot;?section=&quot;);</span>
<a href="#l11.402"></a><span id="l11.402" class="difflineminus">-    if (wherepart)</span>
<a href="#l11.403"></a><span id="l11.403" class="difflineminus">-    {</span>
<a href="#l11.404"></a><span id="l11.404" class="difflineplus">+    if (wherepart) {</span>
<a href="#l11.405"></a><span id="l11.405">       wherepart += 9;  // strlen(&quot;/;section=&quot;)</span>
<a href="#l11.406"></a><span id="l11.406">       char *wherelibmimepart = PL_strstr(wherepart, &quot;&amp;part=&quot;);</span>
<a href="#l11.407"></a><span id="l11.407" class="difflineminus">-      if (!wherelibmimepart)</span>
<a href="#l11.408"></a><span id="l11.408" class="difflineminus">-        wherelibmimepart = PL_strstr(wherepart, &quot;?part=&quot;);</span>
<a href="#l11.409"></a><span id="l11.409" class="difflineminus">-      int numCharsToCopy = (wherelibmimepart) ? wherelibmimepart - wherepart :</span>
<a href="#l11.410"></a><span id="l11.410" class="difflineminus">-                   PL_strlen(m_listOfMessageIds) - (wherepart - m_listOfMessageIds);</span>
<a href="#l11.411"></a><span id="l11.411" class="difflineminus">-      if (numCharsToCopy)</span>
<a href="#l11.412"></a><span id="l11.412" class="difflineminus">-      {</span>
<a href="#l11.413"></a><span id="l11.413" class="difflineminus">-        *result = (char *) PR_Malloc(sizeof(char) * (numCharsToCopy + 1));</span>
<a href="#l11.414"></a><span id="l11.414" class="difflineminus">-        if (*result)</span>
<a href="#l11.415"></a><span id="l11.415" class="difflineminus">-        {</span>
<a href="#l11.416"></a><span id="l11.416" class="difflineplus">+      if (!wherelibmimepart) wherelibmimepart = PL_strstr(wherepart, &quot;?part=&quot;);</span>
<a href="#l11.417"></a><span id="l11.417" class="difflineplus">+      int numCharsToCopy = (wherelibmimepart)</span>
<a href="#l11.418"></a><span id="l11.418" class="difflineplus">+                               ? wherelibmimepart - wherepart</span>
<a href="#l11.419"></a><span id="l11.419" class="difflineplus">+                               : PL_strlen(m_listOfMessageIds) -</span>
<a href="#l11.420"></a><span id="l11.420" class="difflineplus">+                                     (wherepart - m_listOfMessageIds);</span>
<a href="#l11.421"></a><span id="l11.421" class="difflineplus">+      if (numCharsToCopy) {</span>
<a href="#l11.422"></a><span id="l11.422" class="difflineplus">+        *result = (char *)PR_Malloc(sizeof(char) * (numCharsToCopy + 1));</span>
<a href="#l11.423"></a><span id="l11.423" class="difflineplus">+        if (*result) {</span>
<a href="#l11.424"></a><span id="l11.424">           PL_strncpy(*result, wherepart, numCharsToCopy + 1);  // appends a \0</span>
<a href="#l11.425"></a><span id="l11.425">           (*result)[numCharsToCopy] = '\0';</span>
<a href="#l11.426"></a><span id="l11.426">         }</span>
<a href="#l11.427"></a><span id="l11.427">       }</span>
<a href="#l11.428"></a><span id="l11.428" class="difflineminus">-    } // if we got a wherepart</span>
<a href="#l11.429"></a><span id="l11.429" class="difflineminus">-  } // if we got a m_listOfMessageIds</span>
<a href="#l11.430"></a><span id="l11.430" class="difflineplus">+    }  // if we got a wherepart</span>
<a href="#l11.431"></a><span id="l11.431" class="difflineplus">+  }    // if we got a m_listOfMessageIds</span>
<a href="#l11.432"></a><span id="l11.432">   return NS_OK;</span>
<a href="#l11.433"></a><span id="l11.433"> }</span>
<a href="#l11.434"></a><span id="l11.434"> </span>
<a href="#l11.435"></a><span id="l11.435" class="difflineminus">-NS_IMETHODIMP nsImapUrl::GetOnlineSubDirSeparator(char* separator)</span>
<a href="#l11.436"></a><span id="l11.436" class="difflineminus">-{</span>
<a href="#l11.437"></a><span id="l11.437" class="difflineminus">-  if (separator)</span>
<a href="#l11.438"></a><span id="l11.438" class="difflineminus">-  {</span>
<a href="#l11.439"></a><span id="l11.439" class="difflineminus">-      *separator = m_onlineSubDirSeparator;</span>
<a href="#l11.440"></a><span id="l11.440" class="difflineminus">-      return NS_OK;</span>
<a href="#l11.441"></a><span id="l11.441" class="difflineplus">+NS_IMETHODIMP nsImapUrl::GetOnlineSubDirSeparator(char *separator) {</span>
<a href="#l11.442"></a><span id="l11.442" class="difflineplus">+  if (separator) {</span>
<a href="#l11.443"></a><span id="l11.443" class="difflineplus">+    *separator = m_onlineSubDirSeparator;</span>
<a href="#l11.444"></a><span id="l11.444" class="difflineplus">+    return NS_OK;</span>
<a href="#l11.445"></a><span id="l11.445">   }</span>
<a href="#l11.446"></a><span id="l11.446">   return NS_ERROR_NULL_POINTER;</span>
<a href="#l11.447"></a><span id="l11.447"> }</span>
<a href="#l11.448"></a><span id="l11.448"> </span>
<a href="#l11.449"></a><span id="l11.449" class="difflineminus">-NS_IMETHODIMP nsImapUrl::GetNumBytesToFetch(int32_t *aNumBytesToFetch)</span>
<a href="#l11.450"></a><span id="l11.450" class="difflineminus">-{</span>
<a href="#l11.451"></a><span id="l11.451" class="difflineplus">+NS_IMETHODIMP nsImapUrl::GetNumBytesToFetch(int32_t *aNumBytesToFetch) {</span>
<a href="#l11.452"></a><span id="l11.452">   NS_ENSURE_ARG_POINTER(aNumBytesToFetch);</span>
<a href="#l11.453"></a><span id="l11.453">   *aNumBytesToFetch = m_numBytesToFetch;</span>
<a href="#l11.454"></a><span id="l11.454">   return NS_OK;</span>
<a href="#l11.455"></a><span id="l11.455"> }</span>
<a href="#l11.456"></a><span id="l11.456"> </span>
<a href="#l11.457"></a><span id="l11.457"> NS_IMETHODIMP</span>
<a href="#l11.458"></a><span id="l11.458" class="difflineminus">-nsImapUrl::SetOnlineSubDirSeparator(char onlineDirSeparator)</span>
<a href="#l11.459"></a><span id="l11.459" class="difflineminus">-{</span>
<a href="#l11.460"></a><span id="l11.460" class="difflineplus">+nsImapUrl::SetOnlineSubDirSeparator(char onlineDirSeparator) {</span>
<a href="#l11.461"></a><span id="l11.461">   m_onlineSubDirSeparator = onlineDirSeparator;</span>
<a href="#l11.462"></a><span id="l11.462">   return NS_OK;</span>
<a href="#l11.463"></a><span id="l11.463"> }</span>
<a href="#l11.464"></a><span id="l11.464"> </span>
<a href="#l11.465"></a><span id="l11.465"> // this method is only called from the imap thread</span>
<a href="#l11.466"></a><span id="l11.466" class="difflineminus">-NS_IMETHODIMP nsImapUrl::MessageIdsAreUids(bool *result)</span>
<a href="#l11.467"></a><span id="l11.467" class="difflineminus">-{</span>
<a href="#l11.468"></a><span id="l11.468" class="difflineplus">+NS_IMETHODIMP nsImapUrl::MessageIdsAreUids(bool *result) {</span>
<a href="#l11.469"></a><span id="l11.469">   *result = m_idsAreUids;</span>
<a href="#l11.470"></a><span id="l11.470">   return NS_OK;</span>
<a href="#l11.471"></a><span id="l11.471"> }</span>
<a href="#l11.472"></a><span id="l11.472"> </span>
<a href="#l11.473"></a><span id="l11.473"> NS_IMETHODIMP</span>
<a href="#l11.474"></a><span id="l11.474" class="difflineminus">-nsImapUrl::SetExtraStatus(int32_t aExtraStatus)</span>
<a href="#l11.475"></a><span id="l11.475" class="difflineminus">-{</span>
<a href="#l11.476"></a><span id="l11.476" class="difflineplus">+nsImapUrl::SetExtraStatus(int32_t aExtraStatus) {</span>
<a href="#l11.477"></a><span id="l11.477">   m_extraStatus = aExtraStatus;</span>
<a href="#l11.478"></a><span id="l11.478">   return NS_OK;</span>
<a href="#l11.479"></a><span id="l11.479"> }</span>
<a href="#l11.480"></a><span id="l11.480"> </span>
<a href="#l11.481"></a><span id="l11.481" class="difflineminus">-NS_IMETHODIMP nsImapUrl::GetExtraStatus(int32_t *aResult)</span>
<a href="#l11.482"></a><span id="l11.482" class="difflineminus">-{</span>
<a href="#l11.483"></a><span id="l11.483" class="difflineplus">+NS_IMETHODIMP nsImapUrl::GetExtraStatus(int32_t *aResult) {</span>
<a href="#l11.484"></a><span id="l11.484">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l11.485"></a><span id="l11.485">   *aResult = m_extraStatus;</span>
<a href="#l11.486"></a><span id="l11.486">   return NS_OK;</span>
<a href="#l11.487"></a><span id="l11.487"> }</span>
<a href="#l11.488"></a><span id="l11.488"> </span>
<a href="#l11.489"></a><span id="l11.489"> // this method is only called from the imap thread</span>
<a href="#l11.490"></a><span id="l11.490" class="difflineminus">-NS_IMETHODIMP nsImapUrl::GetMsgFlags(imapMessageFlagsType *result)  // kAddMsgFlags or kSubtractMsgFlags only</span>
<a href="#l11.491"></a><span id="l11.491" class="difflineplus">+NS_IMETHODIMP nsImapUrl::GetMsgFlags(</span>
<a href="#l11.492"></a><span id="l11.492" class="difflineplus">+    imapMessageFlagsType *result)  // kAddMsgFlags or kSubtractMsgFlags only</span>
<a href="#l11.493"></a><span id="l11.493"> {</span>
<a href="#l11.494"></a><span id="l11.494">   *result = m_flags;</span>
<a href="#l11.495"></a><span id="l11.495">   return NS_OK;</span>
<a href="#l11.496"></a><span id="l11.496"> }</span>
<a href="#l11.497"></a><span id="l11.497"> </span>
<a href="#l11.498"></a><span id="l11.498" class="difflineminus">-void nsImapUrl::ParseImapPart(char *imapPartOfUrl)</span>
<a href="#l11.499"></a><span id="l11.499" class="difflineminus">-{</span>
<a href="#l11.500"></a><span id="l11.500" class="difflineplus">+void nsImapUrl::ParseImapPart(char *imapPartOfUrl) {</span>
<a href="#l11.501"></a><span id="l11.501">   m_tokenPlaceHolder = imapPartOfUrl;</span>
<a href="#l11.502"></a><span id="l11.502" class="difflineminus">-  m_urlidSubString = m_tokenPlaceHolder ? NS_strtok(IMAP_URL_TOKEN_SEPARATOR, &amp;m_tokenPlaceHolder) : (char *)NULL;</span>
<a href="#l11.503"></a><span id="l11.503" class="difflineplus">+  m_urlidSubString = m_tokenPlaceHolder ? NS_strtok(IMAP_URL_TOKEN_SEPARATOR,</span>
<a href="#l11.504"></a><span id="l11.504" class="difflineplus">+                                                    &amp;m_tokenPlaceHolder)</span>
<a href="#l11.505"></a><span id="l11.505" class="difflineplus">+                                        : (char *)NULL;</span>
<a href="#l11.506"></a><span id="l11.506"> </span>
<a href="#l11.507"></a><span id="l11.507" class="difflineminus">-  if (!m_urlidSubString)</span>
<a href="#l11.508"></a><span id="l11.508" class="difflineminus">-  {</span>
<a href="#l11.509"></a><span id="l11.509" class="difflineplus">+  if (!m_urlidSubString) {</span>
<a href="#l11.510"></a><span id="l11.510">     m_validUrl = false;</span>
<a href="#l11.511"></a><span id="l11.511">     return;</span>
<a href="#l11.512"></a><span id="l11.512">   }</span>
<a href="#l11.513"></a><span id="l11.513"> </span>
<a href="#l11.514"></a><span id="l11.514" class="difflineminus">-  if (!PL_strcasecmp(m_urlidSubString, &quot;fetch&quot;))</span>
<a href="#l11.515"></a><span id="l11.515" class="difflineminus">-  {</span>
<a href="#l11.516"></a><span id="l11.516" class="difflineminus">-    m_imapAction  = nsImapMsgFetch;</span>
<a href="#l11.517"></a><span id="l11.517" class="difflineplus">+  if (!PL_strcasecmp(m_urlidSubString, &quot;fetch&quot;)) {</span>
<a href="#l11.518"></a><span id="l11.518" class="difflineplus">+    m_imapAction = nsImapMsgFetch;</span>
<a href="#l11.519"></a><span id="l11.519">     ParseUidChoice();</span>
<a href="#l11.520"></a><span id="l11.520">     PR_FREEIF(m_sourceCanonicalFolderPathSubString);</span>
<a href="#l11.521"></a><span id="l11.521">     ParseFolderPath(&amp;m_sourceCanonicalFolderPathSubString);</span>
<a href="#l11.522"></a><span id="l11.522">     ParseListOfMessageIds();</span>
<a href="#l11.523"></a><span id="l11.523" class="difflineminus">-    // if fetched by spam filter, the action will be changed to nsImapMsgFetchPeek</span>
<a href="#l11.524"></a><span id="l11.524" class="difflineminus">-  }</span>
<a href="#l11.525"></a><span id="l11.525" class="difflineminus">-  else</span>
<a href="#l11.526"></a><span id="l11.526" class="difflineminus">-  {</span>
<a href="#l11.527"></a><span id="l11.527" class="difflineminus">-    if (!PL_strcasecmp(m_urlidSubString, &quot;header&quot;))</span>
<a href="#l11.528"></a><span id="l11.528" class="difflineminus">-    {</span>
<a href="#l11.529"></a><span id="l11.529" class="difflineplus">+    // if fetched by spam filter, the action will be changed to</span>
<a href="#l11.530"></a><span id="l11.530" class="difflineplus">+    // nsImapMsgFetchPeek</span>
<a href="#l11.531"></a><span id="l11.531" class="difflineplus">+  } else {</span>
<a href="#l11.532"></a><span id="l11.532" class="difflineplus">+    if (!PL_strcasecmp(m_urlidSubString, &quot;header&quot;)) {</span>
<a href="#l11.533"></a><span id="l11.533">       m_imapAction = nsImapMsgHeader;</span>
<a href="#l11.534"></a><span id="l11.534">       ParseUidChoice();</span>
<a href="#l11.535"></a><span id="l11.535">       ParseFolderPath(&amp;m_sourceCanonicalFolderPathSubString);</span>
<a href="#l11.536"></a><span id="l11.536">       ParseListOfMessageIds();</span>
<a href="#l11.537"></a><span id="l11.537" class="difflineminus">-    }</span>
<a href="#l11.538"></a><span id="l11.538" class="difflineminus">-    else if (!PL_strcasecmp(m_urlidSubString, &quot;customFetch&quot;))</span>
<a href="#l11.539"></a><span id="l11.539" class="difflineminus">-    {</span>
<a href="#l11.540"></a><span id="l11.540" class="difflineplus">+    } else if (!PL_strcasecmp(m_urlidSubString, &quot;customFetch&quot;)) {</span>
<a href="#l11.541"></a><span id="l11.541">       ParseUidChoice();</span>
<a href="#l11.542"></a><span id="l11.542">       ParseFolderPath(&amp;m_sourceCanonicalFolderPathSubString);</span>
<a href="#l11.543"></a><span id="l11.543">       ParseListOfMessageIds();</span>
<a href="#l11.544"></a><span id="l11.544">       ParseCustomMsgFetchAttribute();</span>
<a href="#l11.545"></a><span id="l11.545" class="difflineminus">-    }</span>
<a href="#l11.546"></a><span id="l11.546" class="difflineminus">-    else if (!PL_strcasecmp(m_urlidSubString, &quot;previewBody&quot;))</span>
<a href="#l11.547"></a><span id="l11.547" class="difflineminus">-    {</span>
<a href="#l11.548"></a><span id="l11.548" class="difflineplus">+    } else if (!PL_strcasecmp(m_urlidSubString, &quot;previewBody&quot;)) {</span>
<a href="#l11.549"></a><span id="l11.549">       ParseUidChoice();</span>
<a href="#l11.550"></a><span id="l11.550">       ParseFolderPath(&amp;m_sourceCanonicalFolderPathSubString);</span>
<a href="#l11.551"></a><span id="l11.551">       ParseListOfMessageIds();</span>
<a href="#l11.552"></a><span id="l11.552">       ParseNumBytes();</span>
<a href="#l11.553"></a><span id="l11.553" class="difflineminus">-    }</span>
<a href="#l11.554"></a><span id="l11.554" class="difflineminus">-    else if (!PL_strcasecmp(m_urlidSubString, &quot;deletemsg&quot;))</span>
<a href="#l11.555"></a><span id="l11.555" class="difflineminus">-    {</span>
<a href="#l11.556"></a><span id="l11.556" class="difflineplus">+    } else if (!PL_strcasecmp(m_urlidSubString, &quot;deletemsg&quot;)) {</span>
<a href="#l11.557"></a><span id="l11.557">       m_imapAction = nsImapDeleteMsg;</span>
<a href="#l11.558"></a><span id="l11.558">       ParseUidChoice();</span>
<a href="#l11.559"></a><span id="l11.559">       ParseFolderPath(&amp;m_sourceCanonicalFolderPathSubString);</span>
<a href="#l11.560"></a><span id="l11.560">       ParseListOfMessageIds();</span>
<a href="#l11.561"></a><span id="l11.561" class="difflineminus">-    }</span>
<a href="#l11.562"></a><span id="l11.562" class="difflineminus">-    else if (!PL_strcasecmp(m_urlidSubString, &quot;uidexpunge&quot;))</span>
<a href="#l11.563"></a><span id="l11.563" class="difflineminus">-    {</span>
<a href="#l11.564"></a><span id="l11.564" class="difflineplus">+    } else if (!PL_strcasecmp(m_urlidSubString, &quot;uidexpunge&quot;)) {</span>
<a href="#l11.565"></a><span id="l11.565">       m_imapAction = nsImapUidExpunge;</span>
<a href="#l11.566"></a><span id="l11.566">       ParseFolderPath(&amp;m_sourceCanonicalFolderPathSubString);</span>
<a href="#l11.567"></a><span id="l11.567">       ParseListOfMessageIds();</span>
<a href="#l11.568"></a><span id="l11.568" class="difflineminus">-    }</span>
<a href="#l11.569"></a><span id="l11.569" class="difflineminus">-    else if (!PL_strcasecmp(m_urlidSubString, &quot;deleteallmsgs&quot;))</span>
<a href="#l11.570"></a><span id="l11.570" class="difflineminus">-    {</span>
<a href="#l11.571"></a><span id="l11.571" class="difflineplus">+    } else if (!PL_strcasecmp(m_urlidSubString, &quot;deleteallmsgs&quot;)) {</span>
<a href="#l11.572"></a><span id="l11.572">       m_imapAction = nsImapDeleteAllMsgs;</span>
<a href="#l11.573"></a><span id="l11.573">       ParseFolderPath(&amp;m_sourceCanonicalFolderPathSubString);</span>
<a href="#l11.574"></a><span id="l11.574" class="difflineminus">-    }</span>
<a href="#l11.575"></a><span id="l11.575" class="difflineminus">-    else if (!PL_strcasecmp(m_urlidSubString, &quot;addmsgflags&quot;))</span>
<a href="#l11.576"></a><span id="l11.576" class="difflineminus">-    {</span>
<a href="#l11.577"></a><span id="l11.577" class="difflineplus">+    } else if (!PL_strcasecmp(m_urlidSubString, &quot;addmsgflags&quot;)) {</span>
<a href="#l11.578"></a><span id="l11.578">       m_imapAction = nsImapAddMsgFlags;</span>
<a href="#l11.579"></a><span id="l11.579">       ParseUidChoice();</span>
<a href="#l11.580"></a><span id="l11.580">       ParseFolderPath(&amp;m_sourceCanonicalFolderPathSubString);</span>
<a href="#l11.581"></a><span id="l11.581">       ParseListOfMessageIds();</span>
<a href="#l11.582"></a><span id="l11.582">       ParseMsgFlags();</span>
<a href="#l11.583"></a><span id="l11.583" class="difflineminus">-    }</span>
<a href="#l11.584"></a><span id="l11.584" class="difflineminus">-    else if (!PL_strcasecmp(m_urlidSubString, &quot;subtractmsgflags&quot;))</span>
<a href="#l11.585"></a><span id="l11.585" class="difflineminus">-    {</span>
<a href="#l11.586"></a><span id="l11.586" class="difflineplus">+    } else if (!PL_strcasecmp(m_urlidSubString, &quot;subtractmsgflags&quot;)) {</span>
<a href="#l11.587"></a><span id="l11.587">       m_imapAction = nsImapSubtractMsgFlags;</span>
<a href="#l11.588"></a><span id="l11.588">       ParseUidChoice();</span>
<a href="#l11.589"></a><span id="l11.589">       ParseFolderPath(&amp;m_sourceCanonicalFolderPathSubString);</span>
<a href="#l11.590"></a><span id="l11.590">       ParseListOfMessageIds();</span>
<a href="#l11.591"></a><span id="l11.591">       ParseMsgFlags();</span>
<a href="#l11.592"></a><span id="l11.592" class="difflineminus">-    }</span>
<a href="#l11.593"></a><span id="l11.593" class="difflineminus">-    else if (!PL_strcasecmp(m_urlidSubString, &quot;setmsgflags&quot;))</span>
<a href="#l11.594"></a><span id="l11.594" class="difflineminus">-    {</span>
<a href="#l11.595"></a><span id="l11.595" class="difflineplus">+    } else if (!PL_strcasecmp(m_urlidSubString, &quot;setmsgflags&quot;)) {</span>
<a href="#l11.596"></a><span id="l11.596">       m_imapAction = nsImapSetMsgFlags;</span>
<a href="#l11.597"></a><span id="l11.597">       ParseUidChoice();</span>
<a href="#l11.598"></a><span id="l11.598">       ParseFolderPath(&amp;m_sourceCanonicalFolderPathSubString);</span>
<a href="#l11.599"></a><span id="l11.599">       ParseListOfMessageIds();</span>
<a href="#l11.600"></a><span id="l11.600">       ParseMsgFlags();</span>
<a href="#l11.601"></a><span id="l11.601" class="difflineminus">-    }</span>
<a href="#l11.602"></a><span id="l11.602" class="difflineminus">-    else if (!PL_strcasecmp(m_urlidSubString, &quot;onlinecopy&quot;))</span>
<a href="#l11.603"></a><span id="l11.603" class="difflineminus">-    {</span>
<a href="#l11.604"></a><span id="l11.604" class="difflineplus">+    } else if (!PL_strcasecmp(m_urlidSubString, &quot;onlinecopy&quot;)) {</span>
<a href="#l11.605"></a><span id="l11.605">       m_imapAction = nsImapOnlineCopy;</span>
<a href="#l11.606"></a><span id="l11.606">       ParseUidChoice();</span>
<a href="#l11.607"></a><span id="l11.607">       ParseFolderPath(&amp;m_sourceCanonicalFolderPathSubString);</span>
<a href="#l11.608"></a><span id="l11.608">       ParseListOfMessageIds();</span>
<a href="#l11.609"></a><span id="l11.609">       ParseFolderPath(&amp;m_destinationCanonicalFolderPathSubString);</span>
<a href="#l11.610"></a><span id="l11.610" class="difflineminus">-    }</span>
<a href="#l11.611"></a><span id="l11.611" class="difflineminus">-    else if (!PL_strcasecmp(m_urlidSubString, &quot;onlinemove&quot;))</span>
<a href="#l11.612"></a><span id="l11.612" class="difflineminus">-    {</span>
<a href="#l11.613"></a><span id="l11.613" class="difflineplus">+    } else if (!PL_strcasecmp(m_urlidSubString, &quot;onlinemove&quot;)) {</span>
<a href="#l11.614"></a><span id="l11.614">       m_imapAction = nsImapOnlineMove;</span>
<a href="#l11.615"></a><span id="l11.615">       ParseUidChoice();</span>
<a href="#l11.616"></a><span id="l11.616">       ParseFolderPath(&amp;m_sourceCanonicalFolderPathSubString);</span>
<a href="#l11.617"></a><span id="l11.617">       ParseListOfMessageIds();</span>
<a href="#l11.618"></a><span id="l11.618">       ParseFolderPath(&amp;m_destinationCanonicalFolderPathSubString);</span>
<a href="#l11.619"></a><span id="l11.619" class="difflineminus">-    }</span>
<a href="#l11.620"></a><span id="l11.620" class="difflineminus">-    else if (!PL_strcasecmp(m_urlidSubString, &quot;onlinetoofflinecopy&quot;))</span>
<a href="#l11.621"></a><span id="l11.621" class="difflineminus">-    {</span>
<a href="#l11.622"></a><span id="l11.622" class="difflineplus">+    } else if (!PL_strcasecmp(m_urlidSubString, &quot;onlinetoofflinecopy&quot;)) {</span>
<a href="#l11.623"></a><span id="l11.623">       m_imapAction = nsImapOnlineToOfflineCopy;</span>
<a href="#l11.624"></a><span id="l11.624">       ParseUidChoice();</span>
<a href="#l11.625"></a><span id="l11.625">       ParseFolderPath(&amp;m_sourceCanonicalFolderPathSubString);</span>
<a href="#l11.626"></a><span id="l11.626">       ParseListOfMessageIds();</span>
<a href="#l11.627"></a><span id="l11.627">       ParseFolderPath(&amp;m_destinationCanonicalFolderPathSubString);</span>
<a href="#l11.628"></a><span id="l11.628" class="difflineminus">-    }</span>
<a href="#l11.629"></a><span id="l11.629" class="difflineminus">-    else if (!PL_strcasecmp(m_urlidSubString, &quot;onlinetoofflinemove&quot;))</span>
<a href="#l11.630"></a><span id="l11.630" class="difflineminus">-    {</span>
<a href="#l11.631"></a><span id="l11.631" class="difflineplus">+    } else if (!PL_strcasecmp(m_urlidSubString, &quot;onlinetoofflinemove&quot;)) {</span>
<a href="#l11.632"></a><span id="l11.632">       m_imapAction = nsImapOnlineToOfflineMove;</span>
<a href="#l11.633"></a><span id="l11.633">       ParseUidChoice();</span>
<a href="#l11.634"></a><span id="l11.634">       ParseFolderPath(&amp;m_sourceCanonicalFolderPathSubString);</span>
<a href="#l11.635"></a><span id="l11.635">       ParseListOfMessageIds();</span>
<a href="#l11.636"></a><span id="l11.636">       ParseFolderPath(&amp;m_destinationCanonicalFolderPathSubString);</span>
<a href="#l11.637"></a><span id="l11.637" class="difflineminus">-    }</span>
<a href="#l11.638"></a><span id="l11.638" class="difflineminus">-    else if (!PL_strcasecmp(m_urlidSubString, &quot;offlinetoonlinecopy&quot;))</span>
<a href="#l11.639"></a><span id="l11.639" class="difflineminus">-    {</span>
<a href="#l11.640"></a><span id="l11.640" class="difflineplus">+    } else if (!PL_strcasecmp(m_urlidSubString, &quot;offlinetoonlinecopy&quot;)) {</span>
<a href="#l11.641"></a><span id="l11.641">       m_imapAction = nsImapOfflineToOnlineMove;</span>
<a href="#l11.642"></a><span id="l11.642">       ParseFolderPath(&amp;m_destinationCanonicalFolderPathSubString);</span>
<a href="#l11.643"></a><span id="l11.643" class="difflineminus">-    }</span>
<a href="#l11.644"></a><span id="l11.644" class="difflineminus">-    else if (!PL_strcasecmp(m_urlidSubString, &quot;search&quot;))</span>
<a href="#l11.645"></a><span id="l11.645" class="difflineminus">-    {</span>
<a href="#l11.646"></a><span id="l11.646" class="difflineplus">+    } else if (!PL_strcasecmp(m_urlidSubString, &quot;search&quot;)) {</span>
<a href="#l11.647"></a><span id="l11.647">       m_imapAction = nsImapSearch;</span>
<a href="#l11.648"></a><span id="l11.648">       ParseUidChoice();</span>
<a href="#l11.649"></a><span id="l11.649">       ParseFolderPath(&amp;m_sourceCanonicalFolderPathSubString);</span>
<a href="#l11.650"></a><span id="l11.650">       ParseSearchCriteriaString();</span>
<a href="#l11.651"></a><span id="l11.651" class="difflineminus">-    }</span>
<a href="#l11.652"></a><span id="l11.652" class="difflineminus">-    else if (!PL_strcasecmp(m_urlidSubString, &quot;test&quot;))</span>
<a href="#l11.653"></a><span id="l11.653" class="difflineminus">-    {</span>
<a href="#l11.654"></a><span id="l11.654" class="difflineplus">+    } else if (!PL_strcasecmp(m_urlidSubString, &quot;test&quot;)) {</span>
<a href="#l11.655"></a><span id="l11.655">       m_imapAction = nsImapTest;</span>
<a href="#l11.656"></a><span id="l11.656" class="difflineminus">-    }</span>
<a href="#l11.657"></a><span id="l11.657" class="difflineminus">-    else if (!PL_strcasecmp(m_urlidSubString, &quot;select&quot;))</span>
<a href="#l11.658"></a><span id="l11.658" class="difflineminus">-    {</span>
<a href="#l11.659"></a><span id="l11.659" class="difflineplus">+    } else if (!PL_strcasecmp(m_urlidSubString, &quot;select&quot;)) {</span>
<a href="#l11.660"></a><span id="l11.660">       m_imapAction = nsImapSelectFolder;</span>
<a href="#l11.661"></a><span id="l11.661">       ParseFolderPath(&amp;m_sourceCanonicalFolderPathSubString);</span>
<a href="#l11.662"></a><span id="l11.662">       if (m_tokenPlaceHolder &amp;&amp; *m_tokenPlaceHolder)</span>
<a href="#l11.663"></a><span id="l11.663">         ParseListOfMessageIds();</span>
<a href="#l11.664"></a><span id="l11.664">       else</span>
<a href="#l11.665"></a><span id="l11.665">         m_listOfMessageIds = PL_strdup(&quot;&quot;);</span>
<a href="#l11.666"></a><span id="l11.666" class="difflineminus">-    }</span>
<a href="#l11.667"></a><span id="l11.667" class="difflineminus">-    else if (!PL_strcasecmp(m_urlidSubString, &quot;liteselect&quot;))</span>
<a href="#l11.668"></a><span id="l11.668" class="difflineminus">-    {</span>
<a href="#l11.669"></a><span id="l11.669" class="difflineplus">+    } else if (!PL_strcasecmp(m_urlidSubString, &quot;liteselect&quot;)) {</span>
<a href="#l11.670"></a><span id="l11.670">       m_imapAction = nsImapLiteSelectFolder;</span>
<a href="#l11.671"></a><span id="l11.671">       ParseFolderPath(&amp;m_sourceCanonicalFolderPathSubString);</span>
<a href="#l11.672"></a><span id="l11.672" class="difflineminus">-    }</span>
<a href="#l11.673"></a><span id="l11.673" class="difflineminus">-    else if (!PL_strcasecmp(m_urlidSubString, &quot;selectnoop&quot;))</span>
<a href="#l11.674"></a><span id="l11.674" class="difflineminus">-    {</span>
<a href="#l11.675"></a><span id="l11.675" class="difflineplus">+    } else if (!PL_strcasecmp(m_urlidSubString, &quot;selectnoop&quot;)) {</span>
<a href="#l11.676"></a><span id="l11.676">       m_imapAction = nsImapSelectNoopFolder;</span>
<a href="#l11.677"></a><span id="l11.677">       m_listOfMessageIds = PL_strdup(&quot;&quot;);</span>
<a href="#l11.678"></a><span id="l11.678">       ParseFolderPath(&amp;m_sourceCanonicalFolderPathSubString);</span>
<a href="#l11.679"></a><span id="l11.679" class="difflineminus">-    }</span>
<a href="#l11.680"></a><span id="l11.680" class="difflineminus">-    else if (!PL_strcasecmp(m_urlidSubString, &quot;expunge&quot;))</span>
<a href="#l11.681"></a><span id="l11.681" class="difflineminus">-    {</span>
<a href="#l11.682"></a><span id="l11.682" class="difflineplus">+    } else if (!PL_strcasecmp(m_urlidSubString, &quot;expunge&quot;)) {</span>
<a href="#l11.683"></a><span id="l11.683">       m_imapAction = nsImapExpungeFolder;</span>
<a href="#l11.684"></a><span id="l11.684">       ParseFolderPath(&amp;m_sourceCanonicalFolderPathSubString);</span>
<a href="#l11.685"></a><span id="l11.685" class="difflineminus">-      m_listOfMessageIds = PL_strdup(&quot;&quot;);    // no ids to UNDO</span>
<a href="#l11.686"></a><span id="l11.686" class="difflineminus">-    }</span>
<a href="#l11.687"></a><span id="l11.687" class="difflineminus">-    else if (!PL_strcasecmp(m_urlidSubString, &quot;create&quot;))</span>
<a href="#l11.688"></a><span id="l11.688" class="difflineminus">-    {</span>
<a href="#l11.689"></a><span id="l11.689" class="difflineplus">+      m_listOfMessageIds = PL_strdup(&quot;&quot;);  // no ids to UNDO</span>
<a href="#l11.690"></a><span id="l11.690" class="difflineplus">+    } else if (!PL_strcasecmp(m_urlidSubString, &quot;create&quot;)) {</span>
<a href="#l11.691"></a><span id="l11.691">       m_imapAction = nsImapCreateFolder;</span>
<a href="#l11.692"></a><span id="l11.692">       ParseFolderPath(&amp;m_sourceCanonicalFolderPathSubString);</span>
<a href="#l11.693"></a><span id="l11.693" class="difflineminus">-    }</span>
<a href="#l11.694"></a><span id="l11.694" class="difflineminus">-    else if (!PL_strcasecmp(m_urlidSubString, &quot;ensureExists&quot;))</span>
<a href="#l11.695"></a><span id="l11.695" class="difflineminus">-    {</span>
<a href="#l11.696"></a><span id="l11.696" class="difflineplus">+    } else if (!PL_strcasecmp(m_urlidSubString, &quot;ensureExists&quot;)) {</span>
<a href="#l11.697"></a><span id="l11.697">       m_imapAction = nsImapEnsureExistsFolder;</span>
<a href="#l11.698"></a><span id="l11.698">       ParseFolderPath(&amp;m_sourceCanonicalFolderPathSubString);</span>
<a href="#l11.699"></a><span id="l11.699" class="difflineminus">-    }</span>
<a href="#l11.700"></a><span id="l11.700" class="difflineminus">-    else if (!PL_strcasecmp(m_urlidSubString, &quot;discoverchildren&quot;))</span>
<a href="#l11.701"></a><span id="l11.701" class="difflineminus">-    {</span>
<a href="#l11.702"></a><span id="l11.702" class="difflineplus">+    } else if (!PL_strcasecmp(m_urlidSubString, &quot;discoverchildren&quot;)) {</span>
<a href="#l11.703"></a><span id="l11.703">       m_imapAction = nsImapDiscoverChildrenUrl;</span>
<a href="#l11.704"></a><span id="l11.704">       ParseFolderPath(&amp;m_sourceCanonicalFolderPathSubString);</span>
<a href="#l11.705"></a><span id="l11.705" class="difflineminus">-    }</span>
<a href="#l11.706"></a><span id="l11.706" class="difflineminus">-    else if (!PL_strcasecmp(m_urlidSubString, &quot;discoverallboxes&quot;))</span>
<a href="#l11.707"></a><span id="l11.707" class="difflineminus">-    {</span>
<a href="#l11.708"></a><span id="l11.708" class="difflineplus">+    } else if (!PL_strcasecmp(m_urlidSubString, &quot;discoverallboxes&quot;)) {</span>
<a href="#l11.709"></a><span id="l11.709">       m_imapAction = nsImapDiscoverAllBoxesUrl;</span>
<a href="#l11.710"></a><span id="l11.710" class="difflineminus">-    }</span>
<a href="#l11.711"></a><span id="l11.711" class="difflineminus">-    else if (!PL_strcasecmp(m_urlidSubString, &quot;discoverallandsubscribedboxes&quot;))</span>
<a href="#l11.712"></a><span id="l11.712" class="difflineminus">-    {</span>
<a href="#l11.713"></a><span id="l11.713" class="difflineplus">+    } else if (!PL_strcasecmp(m_urlidSubString,</span>
<a href="#l11.714"></a><span id="l11.714" class="difflineplus">+                              &quot;discoverallandsubscribedboxes&quot;)) {</span>
<a href="#l11.715"></a><span id="l11.715">       m_imapAction = nsImapDiscoverAllAndSubscribedBoxesUrl;</span>
<a href="#l11.716"></a><span id="l11.716" class="difflineminus">-    }</span>
<a href="#l11.717"></a><span id="l11.717" class="difflineminus">-    else if (!PL_strcasecmp(m_urlidSubString, &quot;delete&quot;))</span>
<a href="#l11.718"></a><span id="l11.718" class="difflineminus">-    {</span>
<a href="#l11.719"></a><span id="l11.719" class="difflineplus">+    } else if (!PL_strcasecmp(m_urlidSubString, &quot;delete&quot;)) {</span>
<a href="#l11.720"></a><span id="l11.720">       m_imapAction = nsImapDeleteFolder;</span>
<a href="#l11.721"></a><span id="l11.721">       ParseFolderPath(&amp;m_sourceCanonicalFolderPathSubString);</span>
<a href="#l11.722"></a><span id="l11.722" class="difflineminus">-    }</span>
<a href="#l11.723"></a><span id="l11.723" class="difflineminus">-    else if (!PL_strcasecmp(m_urlidSubString, &quot;deletefolder&quot;))</span>
<a href="#l11.724"></a><span id="l11.724" class="difflineminus">-    {</span>
<a href="#l11.725"></a><span id="l11.725" class="difflineplus">+    } else if (!PL_strcasecmp(m_urlidSubString, &quot;deletefolder&quot;)) {</span>
<a href="#l11.726"></a><span id="l11.726">       m_imapAction = nsImapDeleteFolderAndMsgs;</span>
<a href="#l11.727"></a><span id="l11.727">       ParseFolderPath(&amp;m_sourceCanonicalFolderPathSubString);</span>
<a href="#l11.728"></a><span id="l11.728" class="difflineminus">-    }</span>
<a href="#l11.729"></a><span id="l11.729" class="difflineminus">-    else if (!PL_strcasecmp(m_urlidSubString, &quot;rename&quot;))</span>
<a href="#l11.730"></a><span id="l11.730" class="difflineminus">-    {</span>
<a href="#l11.731"></a><span id="l11.731" class="difflineplus">+    } else if (!PL_strcasecmp(m_urlidSubString, &quot;rename&quot;)) {</span>
<a href="#l11.732"></a><span id="l11.732">       m_imapAction = nsImapRenameFolder;</span>
<a href="#l11.733"></a><span id="l11.733">       ParseFolderPath(&amp;m_sourceCanonicalFolderPathSubString);</span>
<a href="#l11.734"></a><span id="l11.734">       ParseFolderPath(&amp;m_destinationCanonicalFolderPathSubString);</span>
<a href="#l11.735"></a><span id="l11.735" class="difflineminus">-    }</span>
<a href="#l11.736"></a><span id="l11.736" class="difflineminus">-    else if (!PL_strcasecmp(m_urlidSubString, &quot;movefolderhierarchy&quot;))</span>
<a href="#l11.737"></a><span id="l11.737" class="difflineminus">-    {</span>
<a href="#l11.738"></a><span id="l11.738" class="difflineplus">+    } else if (!PL_strcasecmp(m_urlidSubString, &quot;movefolderhierarchy&quot;)) {</span>
<a href="#l11.739"></a><span id="l11.739">       m_imapAction = nsImapMoveFolderHierarchy;</span>
<a href="#l11.740"></a><span id="l11.740">       ParseFolderPath(&amp;m_sourceCanonicalFolderPathSubString);</span>
<a href="#l11.741"></a><span id="l11.741">       if (m_tokenPlaceHolder &amp;&amp; *m_tokenPlaceHolder)  // handle promote to root</span>
<a href="#l11.742"></a><span id="l11.742">         ParseFolderPath(&amp;m_destinationCanonicalFolderPathSubString);</span>
<a href="#l11.743"></a><span id="l11.743" class="difflineminus">-    }</span>
<a href="#l11.744"></a><span id="l11.744" class="difflineminus">-    else if (!PL_strcasecmp(m_urlidSubString, &quot;list&quot;))</span>
<a href="#l11.745"></a><span id="l11.745" class="difflineminus">-    {</span>
<a href="#l11.746"></a><span id="l11.746" class="difflineplus">+    } else if (!PL_strcasecmp(m_urlidSubString, &quot;list&quot;)) {</span>
<a href="#l11.747"></a><span id="l11.747">       m_imapAction = nsImapLsubFolders;</span>
<a href="#l11.748"></a><span id="l11.748">       ParseFolderPath(&amp;m_destinationCanonicalFolderPathSubString);</span>
<a href="#l11.749"></a><span id="l11.749" class="difflineminus">-    }</span>
<a href="#l11.750"></a><span id="l11.750" class="difflineminus">-    else if (!PL_strcasecmp(m_urlidSubString, &quot;biff&quot;))</span>
<a href="#l11.751"></a><span id="l11.751" class="difflineminus">-    {</span>
<a href="#l11.752"></a><span id="l11.752" class="difflineplus">+    } else if (!PL_strcasecmp(m_urlidSubString, &quot;biff&quot;)) {</span>
<a href="#l11.753"></a><span id="l11.753">       m_imapAction = nsImapBiff;</span>
<a href="#l11.754"></a><span id="l11.754">       ParseFolderPath(&amp;m_sourceCanonicalFolderPathSubString);</span>
<a href="#l11.755"></a><span id="l11.755">       ParseListOfMessageIds();</span>
<a href="#l11.756"></a><span id="l11.756" class="difflineminus">-    }</span>
<a href="#l11.757"></a><span id="l11.757" class="difflineminus">-    else if (!PL_strcasecmp(m_urlidSubString, &quot;netscape&quot;))</span>
<a href="#l11.758"></a><span id="l11.758" class="difflineminus">-    {</span>
<a href="#l11.759"></a><span id="l11.759" class="difflineplus">+    } else if (!PL_strcasecmp(m_urlidSubString, &quot;netscape&quot;)) {</span>
<a href="#l11.760"></a><span id="l11.760">       m_imapAction = nsImapGetMailAccountUrl;</span>
<a href="#l11.761"></a><span id="l11.761" class="difflineminus">-    }</span>
<a href="#l11.762"></a><span id="l11.762" class="difflineminus">-    else if (!PL_strcasecmp(m_urlidSubString, &quot;appendmsgfromfile&quot;))</span>
<a href="#l11.763"></a><span id="l11.763" class="difflineminus">-    {</span>
<a href="#l11.764"></a><span id="l11.764" class="difflineplus">+    } else if (!PL_strcasecmp(m_urlidSubString, &quot;appendmsgfromfile&quot;)) {</span>
<a href="#l11.765"></a><span id="l11.765">       m_imapAction = nsImapAppendMsgFromFile;</span>
<a href="#l11.766"></a><span id="l11.766">       ParseFolderPath(&amp;m_sourceCanonicalFolderPathSubString);</span>
<a href="#l11.767"></a><span id="l11.767" class="difflineminus">-    }</span>
<a href="#l11.768"></a><span id="l11.768" class="difflineminus">-    else if (!PL_strcasecmp(m_urlidSubString, &quot;appenddraftfromfile&quot;))</span>
<a href="#l11.769"></a><span id="l11.769" class="difflineminus">-    {</span>
<a href="#l11.770"></a><span id="l11.770" class="difflineplus">+    } else if (!PL_strcasecmp(m_urlidSubString, &quot;appenddraftfromfile&quot;)) {</span>
<a href="#l11.771"></a><span id="l11.771">       m_imapAction = nsImapAppendDraftFromFile;</span>
<a href="#l11.772"></a><span id="l11.772">       ParseFolderPath(&amp;m_sourceCanonicalFolderPathSubString);</span>
<a href="#l11.773"></a><span id="l11.773">       ParseUidChoice();</span>
<a href="#l11.774"></a><span id="l11.774">       if (m_tokenPlaceHolder &amp;&amp; *m_tokenPlaceHolder)</span>
<a href="#l11.775"></a><span id="l11.775">         ParseListOfMessageIds();</span>
<a href="#l11.776"></a><span id="l11.776">       else</span>
<a href="#l11.777"></a><span id="l11.777">         m_listOfMessageIds = strdup(&quot;&quot;);</span>
<a href="#l11.778"></a><span id="l11.778" class="difflineminus">-    }</span>
<a href="#l11.779"></a><span id="l11.779" class="difflineminus">-    else if (!PL_strcasecmp(m_urlidSubString, &quot;subscribe&quot;))</span>
<a href="#l11.780"></a><span id="l11.780" class="difflineminus">-    {</span>
<a href="#l11.781"></a><span id="l11.781" class="difflineplus">+    } else if (!PL_strcasecmp(m_urlidSubString, &quot;subscribe&quot;)) {</span>
<a href="#l11.782"></a><span id="l11.782">       m_imapAction = nsImapSubscribe;</span>
<a href="#l11.783"></a><span id="l11.783">       ParseFolderPath(&amp;m_sourceCanonicalFolderPathSubString);</span>
<a href="#l11.784"></a><span id="l11.784" class="difflineminus">-    }</span>
<a href="#l11.785"></a><span id="l11.785" class="difflineminus">-    else if (!PL_strcasecmp(m_urlidSubString, &quot;unsubscribe&quot;))</span>
<a href="#l11.786"></a><span id="l11.786" class="difflineminus">-    {</span>
<a href="#l11.787"></a><span id="l11.787" class="difflineplus">+    } else if (!PL_strcasecmp(m_urlidSubString, &quot;unsubscribe&quot;)) {</span>
<a href="#l11.788"></a><span id="l11.788">       m_imapAction = nsImapUnsubscribe;</span>
<a href="#l11.789"></a><span id="l11.789">       ParseFolderPath(&amp;m_sourceCanonicalFolderPathSubString);</span>
<a href="#l11.790"></a><span id="l11.790" class="difflineminus">-    }</span>
<a href="#l11.791"></a><span id="l11.791" class="difflineminus">-    else if (!PL_strcasecmp(m_urlidSubString, &quot;refreshacl&quot;))</span>
<a href="#l11.792"></a><span id="l11.792" class="difflineminus">-    {</span>
<a href="#l11.793"></a><span id="l11.793" class="difflineplus">+    } else if (!PL_strcasecmp(m_urlidSubString, &quot;refreshacl&quot;)) {</span>
<a href="#l11.794"></a><span id="l11.794">       m_imapAction = nsImapRefreshACL;</span>
<a href="#l11.795"></a><span id="l11.795">       ParseFolderPath(&amp;m_sourceCanonicalFolderPathSubString);</span>
<a href="#l11.796"></a><span id="l11.796" class="difflineminus">-    }</span>
<a href="#l11.797"></a><span id="l11.797" class="difflineminus">-    else if (!PL_strcasecmp(m_urlidSubString, &quot;refreshfolderurls&quot;))</span>
<a href="#l11.798"></a><span id="l11.798" class="difflineminus">-    {</span>
<a href="#l11.799"></a><span id="l11.799" class="difflineplus">+    } else if (!PL_strcasecmp(m_urlidSubString, &quot;refreshfolderurls&quot;)) {</span>
<a href="#l11.800"></a><span id="l11.800">       m_imapAction = nsImapRefreshFolderUrls;</span>
<a href="#l11.801"></a><span id="l11.801">       ParseFolderPath(&amp;m_sourceCanonicalFolderPathSubString);</span>
<a href="#l11.802"></a><span id="l11.802" class="difflineminus">-    }</span>
<a href="#l11.803"></a><span id="l11.803" class="difflineminus">-    else if (!PL_strcasecmp(m_urlidSubString, &quot;refreshallacls&quot;))</span>
<a href="#l11.804"></a><span id="l11.804" class="difflineminus">-    {</span>
<a href="#l11.805"></a><span id="l11.805" class="difflineplus">+    } else if (!PL_strcasecmp(m_urlidSubString, &quot;refreshallacls&quot;)) {</span>
<a href="#l11.806"></a><span id="l11.806">       m_imapAction = nsImapRefreshAllACLs;</span>
<a href="#l11.807"></a><span id="l11.807" class="difflineminus">-    }</span>
<a href="#l11.808"></a><span id="l11.808" class="difflineminus">-    else if (!PL_strcasecmp(m_urlidSubString, &quot;listfolder&quot;))</span>
<a href="#l11.809"></a><span id="l11.809" class="difflineminus">-    {</span>
<a href="#l11.810"></a><span id="l11.810" class="difflineplus">+    } else if (!PL_strcasecmp(m_urlidSubString, &quot;listfolder&quot;)) {</span>
<a href="#l11.811"></a><span id="l11.811">       m_imapAction = nsImapListFolder;</span>
<a href="#l11.812"></a><span id="l11.812">       ParseFolderPath(&amp;m_sourceCanonicalFolderPathSubString);</span>
<a href="#l11.813"></a><span id="l11.813" class="difflineminus">-    }</span>
<a href="#l11.814"></a><span id="l11.814" class="difflineminus">-    else if (!PL_strcasecmp(m_urlidSubString, &quot;upgradetosubscription&quot;))</span>
<a href="#l11.815"></a><span id="l11.815" class="difflineminus">-    {</span>
<a href="#l11.816"></a><span id="l11.816" class="difflineplus">+    } else if (!PL_strcasecmp(m_urlidSubString, &quot;upgradetosubscription&quot;)) {</span>
<a href="#l11.817"></a><span id="l11.817">       m_imapAction = nsImapUpgradeToSubscription;</span>
<a href="#l11.818"></a><span id="l11.818">       ParseFolderPath(&amp;m_sourceCanonicalFolderPathSubString);</span>
<a href="#l11.819"></a><span id="l11.819" class="difflineminus">-    }</span>
<a href="#l11.820"></a><span id="l11.820" class="difflineminus">-    else if (!PL_strcasecmp(m_urlidSubString, &quot;folderstatus&quot;))</span>
<a href="#l11.821"></a><span id="l11.821" class="difflineminus">-    {</span>
<a href="#l11.822"></a><span id="l11.822" class="difflineplus">+    } else if (!PL_strcasecmp(m_urlidSubString, &quot;folderstatus&quot;)) {</span>
<a href="#l11.823"></a><span id="l11.823">       m_imapAction = nsImapFolderStatus;</span>
<a href="#l11.824"></a><span id="l11.824">       ParseFolderPath(&amp;m_sourceCanonicalFolderPathSubString);</span>
<a href="#l11.825"></a><span id="l11.825" class="difflineminus">-    }</span>
<a href="#l11.826"></a><span id="l11.826" class="difflineminus">-    else if (!PL_strcasecmp(m_urlidSubString, &quot;verifyLogon&quot;))</span>
<a href="#l11.827"></a><span id="l11.827" class="difflineminus">-    {</span>
<a href="#l11.828"></a><span id="l11.828" class="difflineplus">+    } else if (!PL_strcasecmp(m_urlidSubString, &quot;verifyLogon&quot;)) {</span>
<a href="#l11.829"></a><span id="l11.829">       m_imapAction = nsImapVerifylogon;</span>
<a href="#l11.830"></a><span id="l11.830" class="difflineminus">-    }</span>
<a href="#l11.831"></a><span id="l11.831" class="difflineminus">-    else if (m_imapAction == nsIImapUrl::nsImapUserDefinedMsgCommand)</span>
<a href="#l11.832"></a><span id="l11.832" class="difflineminus">-    {</span>
<a href="#l11.833"></a><span id="l11.833" class="difflineminus">-      m_command = m_urlidSubString; // save this</span>
<a href="#l11.834"></a><span id="l11.834" class="difflineplus">+    } else if (m_imapAction == nsIImapUrl::nsImapUserDefinedMsgCommand) {</span>
<a href="#l11.835"></a><span id="l11.835" class="difflineplus">+      m_command = m_urlidSubString;  // save this</span>
<a href="#l11.836"></a><span id="l11.836">       ParseUidChoice();</span>
<a href="#l11.837"></a><span id="l11.837">       ParseFolderPath(&amp;m_sourceCanonicalFolderPathSubString);</span>
<a href="#l11.838"></a><span id="l11.838">       ParseListOfMessageIds();</span>
<a href="#l11.839"></a><span id="l11.839" class="difflineminus">-    }</span>
<a href="#l11.840"></a><span id="l11.840" class="difflineminus">-    else if (m_imapAction == nsIImapUrl::nsImapMsgStoreCustomKeywords)</span>
<a href="#l11.841"></a><span id="l11.841" class="difflineminus">-    {</span>
<a href="#l11.842"></a><span id="l11.842" class="difflineplus">+    } else if (m_imapAction == nsIImapUrl::nsImapMsgStoreCustomKeywords) {</span>
<a href="#l11.843"></a><span id="l11.843">       ParseUidChoice();</span>
<a href="#l11.844"></a><span id="l11.844">       ParseFolderPath(&amp;m_sourceCanonicalFolderPathSubString);</span>
<a href="#l11.845"></a><span id="l11.845">       ParseListOfMessageIds();</span>
<a href="#l11.846"></a><span id="l11.846">       bool addKeyword = (m_tokenPlaceHolder &amp;&amp; *m_tokenPlaceHolder != '&gt;');</span>
<a href="#l11.847"></a><span id="l11.847" class="difflineminus">-      // if we're not adding a keyword, m_tokenPlaceHolder will now look like &gt;keywordToSubtract&gt;</span>
<a href="#l11.848"></a><span id="l11.848" class="difflineminus">-      // and strtok will leave flagsPtr pointing to keywordToSubtract. So detect this</span>
<a href="#l11.849"></a><span id="l11.849" class="difflineminus">-      // case and only set the customSubtractFlags.</span>
<a href="#l11.850"></a><span id="l11.850" class="difflineminus">-      char *flagsPtr = m_tokenPlaceHolder ? NS_strtok(IMAP_URL_TOKEN_SEPARATOR, &amp;m_tokenPlaceHolder) : (char *)nullptr;</span>
<a href="#l11.851"></a><span id="l11.851" class="difflineminus">-      if (addKeyword)</span>
<a href="#l11.852"></a><span id="l11.852" class="difflineminus">-      {</span>
<a href="#l11.853"></a><span id="l11.853" class="difflineplus">+      // if we're not adding a keyword, m_tokenPlaceHolder will now look like</span>
<a href="#l11.854"></a><span id="l11.854" class="difflineplus">+      // &gt;keywordToSubtract&gt; and strtok will leave flagsPtr pointing to</span>
<a href="#l11.855"></a><span id="l11.855" class="difflineplus">+      // keywordToSubtract. So detect this case and only set the</span>
<a href="#l11.856"></a><span id="l11.856" class="difflineplus">+      // customSubtractFlags.</span>
<a href="#l11.857"></a><span id="l11.857" class="difflineplus">+      char *flagsPtr = m_tokenPlaceHolder ? NS_strtok(IMAP_URL_TOKEN_SEPARATOR,</span>
<a href="#l11.858"></a><span id="l11.858" class="difflineplus">+                                                      &amp;m_tokenPlaceHolder)</span>
<a href="#l11.859"></a><span id="l11.859" class="difflineplus">+                                          : (char *)nullptr;</span>
<a href="#l11.860"></a><span id="l11.860" class="difflineplus">+      if (addKeyword) {</span>
<a href="#l11.861"></a><span id="l11.861">         m_customAddFlags.Assign(flagsPtr);</span>
<a href="#l11.862"></a><span id="l11.862" class="difflineminus">-        flagsPtr = m_tokenPlaceHolder ? NS_strtok(IMAP_URL_TOKEN_SEPARATOR, &amp;m_tokenPlaceHolder) : (char *)nullptr;</span>
<a href="#l11.863"></a><span id="l11.863" class="difflineplus">+        flagsPtr = m_tokenPlaceHolder ? NS_strtok(IMAP_URL_TOKEN_SEPARATOR,</span>
<a href="#l11.864"></a><span id="l11.864" class="difflineplus">+                                                  &amp;m_tokenPlaceHolder)</span>
<a href="#l11.865"></a><span id="l11.865" class="difflineplus">+                                      : (char *)nullptr;</span>
<a href="#l11.866"></a><span id="l11.866">       }</span>
<a href="#l11.867"></a><span id="l11.867">       m_customSubtractFlags.Assign(flagsPtr);</span>
<a href="#l11.868"></a><span id="l11.868" class="difflineminus">-    }</span>
<a href="#l11.869"></a><span id="l11.869" class="difflineminus">-    else</span>
<a href="#l11.870"></a><span id="l11.870" class="difflineminus">-    {</span>
<a href="#l11.871"></a><span id="l11.871" class="difflineplus">+    } else {</span>
<a href="#l11.872"></a><span id="l11.872">       m_validUrl = false;</span>
<a href="#l11.873"></a><span id="l11.873">     }</span>
<a href="#l11.874"></a><span id="l11.874">   }</span>
<a href="#l11.875"></a><span id="l11.875"> }</span>
<a href="#l11.876"></a><span id="l11.876"> </span>
<a href="#l11.877"></a><span id="l11.877" class="difflineminus">-</span>
<a href="#l11.878"></a><span id="l11.878"> // Returns NULL if nothing was done.</span>
<a href="#l11.879"></a><span id="l11.879"> // Otherwise, returns a newly allocated name.</span>
<a href="#l11.880"></a><span id="l11.880" class="difflineminus">-NS_IMETHODIMP nsImapUrl::AddOnlineDirectoryIfNecessary(const char *onlineMailboxName, char ** directory)</span>
<a href="#l11.881"></a><span id="l11.881" class="difflineminus">-{</span>
<a href="#l11.882"></a><span id="l11.882" class="difflineplus">+NS_IMETHODIMP nsImapUrl::AddOnlineDirectoryIfNecessary(</span>
<a href="#l11.883"></a><span id="l11.883" class="difflineplus">+    const char *onlineMailboxName, char **directory) {</span>
<a href="#l11.884"></a><span id="l11.884">   nsresult rv;</span>
<a href="#l11.885"></a><span id="l11.885">   nsString onlineDirString;</span>
<a href="#l11.886"></a><span id="l11.886">   char *newOnlineName = nullptr;</span>
<a href="#l11.887"></a><span id="l11.887"> </span>
<a href="#l11.888"></a><span id="l11.888">   nsCOMPtr&lt;nsIImapHostSessionList&gt; hostSessionList =</span>
<a href="#l11.889"></a><span id="l11.889" class="difflineminus">-    do_GetService(kCImapHostSessionListCID, &amp;rv);</span>
<a href="#l11.890"></a><span id="l11.890" class="difflineplus">+      do_GetService(kCImapHostSessionListCID, &amp;rv);</span>
<a href="#l11.891"></a><span id="l11.891">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l11.892"></a><span id="l11.892">   rv = hostSessionList-&gt;GetOnlineDirForHost(m_serverKey.get(), onlineDirString);</span>
<a href="#l11.893"></a><span id="l11.893">   nsAutoCString onlineDir;</span>
<a href="#l11.894"></a><span id="l11.894">   LossyCopyUTF16toASCII(onlineDirString, onlineDir);</span>
<a href="#l11.895"></a><span id="l11.895"> </span>
<a href="#l11.896"></a><span id="l11.896">   nsIMAPNamespace *ns = nullptr;</span>
<a href="#l11.897"></a><span id="l11.897">   rv = hostSessionList-&gt;GetNamespaceForMailboxForHost(m_serverKey.get(),</span>
<a href="#l11.898"></a><span id="l11.898">                                                       onlineMailboxName, ns);</span>
<a href="#l11.899"></a><span id="l11.899">   if (!ns)</span>
<a href="#l11.900"></a><span id="l11.900">     hostSessionList-&gt;GetDefaultNamespaceOfTypeForHost(m_serverKey.get(),</span>
<a href="#l11.901"></a><span id="l11.901">                                                       kPersonalNamespace, ns);</span>
<a href="#l11.902"></a><span id="l11.902"> </span>
<a href="#l11.903"></a><span id="l11.903" class="difflineminus">-  if (onlineDir.IsEmpty() &amp;&amp; ns)</span>
<a href="#l11.904"></a><span id="l11.904" class="difflineminus">-    onlineDir = ns-&gt;GetPrefix();</span>
<a href="#l11.905"></a><span id="l11.905" class="difflineplus">+  if (onlineDir.IsEmpty() &amp;&amp; ns) onlineDir = ns-&gt;GetPrefix();</span>
<a href="#l11.906"></a><span id="l11.906"> </span>
<a href="#l11.907"></a><span id="l11.907">   // If this host has an online server directory configured</span>
<a href="#l11.908"></a><span id="l11.908" class="difflineminus">-  if (onlineMailboxName &amp;&amp; !onlineDir.IsEmpty())</span>
<a href="#l11.909"></a><span id="l11.909" class="difflineminus">-  {</span>
<a href="#l11.910"></a><span id="l11.910" class="difflineminus">-    if (PL_strcasecmp(onlineMailboxName, &quot;INBOX&quot;))</span>
<a href="#l11.911"></a><span id="l11.911" class="difflineminus">-    {</span>
<a href="#l11.912"></a><span id="l11.912" class="difflineplus">+  if (onlineMailboxName &amp;&amp; !onlineDir.IsEmpty()) {</span>
<a href="#l11.913"></a><span id="l11.913" class="difflineplus">+    if (PL_strcasecmp(onlineMailboxName, &quot;INBOX&quot;)) {</span>
<a href="#l11.914"></a><span id="l11.914">       NS_ASSERTION(ns, &quot;couldn't find namespace for host&quot;);</span>
<a href="#l11.915"></a><span id="l11.915">       nsAutoCString onlineDirWithDelimiter(onlineDir);</span>
<a href="#l11.916"></a><span id="l11.916">       // make sure the onlineDir ends with the hierarchy delimiter</span>
<a href="#l11.917"></a><span id="l11.917" class="difflineminus">-      if (ns)</span>
<a href="#l11.918"></a><span id="l11.918" class="difflineminus">-      {</span>
<a href="#l11.919"></a><span id="l11.919" class="difflineplus">+      if (ns) {</span>
<a href="#l11.920"></a><span id="l11.920">         char delimiter = ns-&gt;GetDelimiter();</span>
<a href="#l11.921"></a><span id="l11.921" class="difflineminus">-        if ( delimiter &amp;&amp; delimiter != kOnlineHierarchySeparatorUnknown )</span>
<a href="#l11.922"></a><span id="l11.922" class="difflineminus">-        {</span>
<a href="#l11.923"></a><span id="l11.923" class="difflineplus">+        if (delimiter &amp;&amp; delimiter != kOnlineHierarchySeparatorUnknown) {</span>
<a href="#l11.924"></a><span id="l11.924">           // try to change the canonical online dir name to real dir name first</span>
<a href="#l11.925"></a><span id="l11.925">           MsgReplaceChar(onlineDirWithDelimiter, '/', delimiter);</span>
<a href="#l11.926"></a><span id="l11.926">           // make sure the last character is the delimiter</span>
<a href="#l11.927"></a><span id="l11.927" class="difflineminus">-          if ( onlineDirWithDelimiter.Last() != delimiter )</span>
<a href="#l11.928"></a><span id="l11.928" class="difflineplus">+          if (onlineDirWithDelimiter.Last() != delimiter)</span>
<a href="#l11.929"></a><span id="l11.929">             onlineDirWithDelimiter += delimiter;</span>
<a href="#l11.930"></a><span id="l11.930" class="difflineminus">-          if ( !*onlineMailboxName )</span>
<a href="#l11.931"></a><span id="l11.931" class="difflineminus">-            onlineDirWithDelimiter.SetLength(onlineDirWithDelimiter.Length()-1);</span>
<a href="#l11.932"></a><span id="l11.932" class="difflineplus">+          if (!*onlineMailboxName)</span>
<a href="#l11.933"></a><span id="l11.933" class="difflineplus">+            onlineDirWithDelimiter.SetLength(onlineDirWithDelimiter.Length() -</span>
<a href="#l11.934"></a><span id="l11.934" class="difflineplus">+                                             1);</span>
<a href="#l11.935"></a><span id="l11.935">         }</span>
<a href="#l11.936"></a><span id="l11.936">       }</span>
<a href="#l11.937"></a><span id="l11.937" class="difflineminus">-      if (ns &amp;&amp; (PL_strlen(ns-&gt;GetPrefix()) != 0) &amp;&amp; !onlineDirWithDelimiter.Equals(ns-&gt;GetPrefix()))</span>
<a href="#l11.938"></a><span id="l11.938" class="difflineminus">-      {</span>
<a href="#l11.939"></a><span id="l11.939" class="difflineminus">-        // check that onlineMailboxName doesn't start with the namespace. If that's the case,</span>
<a href="#l11.940"></a><span id="l11.940" class="difflineminus">-        // we don't want to prepend the online dir.</span>
<a href="#l11.941"></a><span id="l11.941" class="difflineminus">-        if (PL_strncmp(onlineMailboxName, ns-&gt;GetPrefix(), PL_strlen(ns-&gt;GetPrefix())))</span>
<a href="#l11.942"></a><span id="l11.942" class="difflineminus">-        {</span>
<a href="#l11.943"></a><span id="l11.943" class="difflineplus">+      if (ns &amp;&amp; (PL_strlen(ns-&gt;GetPrefix()) != 0) &amp;&amp;</span>
<a href="#l11.944"></a><span id="l11.944" class="difflineplus">+          !onlineDirWithDelimiter.Equals(ns-&gt;GetPrefix())) {</span>
<a href="#l11.945"></a><span id="l11.945" class="difflineplus">+        // check that onlineMailboxName doesn't start with the namespace. If</span>
<a href="#l11.946"></a><span id="l11.946" class="difflineplus">+        // that's the case, we don't want to prepend the online dir.</span>
<a href="#l11.947"></a><span id="l11.947" class="difflineplus">+        if (PL_strncmp(onlineMailboxName, ns-&gt;GetPrefix(),</span>
<a href="#l11.948"></a><span id="l11.948" class="difflineplus">+                       PL_strlen(ns-&gt;GetPrefix()))) {</span>
<a href="#l11.949"></a><span id="l11.949">           // The namespace for this mailbox is the root (&quot;&quot;).</span>
<a href="#l11.950"></a><span id="l11.950">           // Prepend the online server directory</span>
<a href="#l11.951"></a><span id="l11.951" class="difflineminus">-          int finalLen = onlineDirWithDelimiter.Length() +</span>
<a href="#l11.952"></a><span id="l11.952" class="difflineminus">-            strlen(onlineMailboxName) + 1;</span>
<a href="#l11.953"></a><span id="l11.953" class="difflineplus">+          int finalLen =</span>
<a href="#l11.954"></a><span id="l11.954" class="difflineplus">+              onlineDirWithDelimiter.Length() + strlen(onlineMailboxName) + 1;</span>
<a href="#l11.955"></a><span id="l11.955">           newOnlineName = (char *)PR_Malloc(finalLen);</span>
<a href="#l11.956"></a><span id="l11.956" class="difflineminus">-          if (newOnlineName)</span>
<a href="#l11.957"></a><span id="l11.957" class="difflineminus">-          {</span>
<a href="#l11.958"></a><span id="l11.958" class="difflineplus">+          if (newOnlineName) {</span>
<a href="#l11.959"></a><span id="l11.959">             PL_strcpy(newOnlineName, onlineDirWithDelimiter.get());</span>
<a href="#l11.960"></a><span id="l11.960">             PL_strcat(newOnlineName, onlineMailboxName);</span>
<a href="#l11.961"></a><span id="l11.961">           }</span>
<a href="#l11.962"></a><span id="l11.962">         }</span>
<a href="#l11.963"></a><span id="l11.963" class="difflineminus">-     }</span>
<a href="#l11.964"></a><span id="l11.964" class="difflineminus">-      // just prepend the online server directory if it doesn't start with it already</span>
<a href="#l11.965"></a><span id="l11.965" class="difflineminus">-      else if (strncmp(onlineMailboxName, onlineDirWithDelimiter.get(), onlineDirWithDelimiter.Length()))</span>
<a href="#l11.966"></a><span id="l11.966" class="difflineminus">-      {</span>
<a href="#l11.967"></a><span id="l11.967" class="difflineminus">-        newOnlineName = (char *)PR_Malloc(strlen(onlineMailboxName) + onlineDirWithDelimiter.Length() + 1);</span>
<a href="#l11.968"></a><span id="l11.968" class="difflineminus">-        if (newOnlineName)</span>
<a href="#l11.969"></a><span id="l11.969" class="difflineminus">-        {</span>
<a href="#l11.970"></a><span id="l11.970" class="difflineplus">+      }</span>
<a href="#l11.971"></a><span id="l11.971" class="difflineplus">+      // just prepend the online server directory if it doesn't start with it</span>
<a href="#l11.972"></a><span id="l11.972" class="difflineplus">+      // already</span>
<a href="#l11.973"></a><span id="l11.973" class="difflineplus">+      else if (strncmp(onlineMailboxName, onlineDirWithDelimiter.get(),</span>
<a href="#l11.974"></a><span id="l11.974" class="difflineplus">+                       onlineDirWithDelimiter.Length())) {</span>
<a href="#l11.975"></a><span id="l11.975" class="difflineplus">+        newOnlineName = (char *)PR_Malloc(strlen(onlineMailboxName) +</span>
<a href="#l11.976"></a><span id="l11.976" class="difflineplus">+                                          onlineDirWithDelimiter.Length() + 1);</span>
<a href="#l11.977"></a><span id="l11.977" class="difflineplus">+        if (newOnlineName) {</span>
<a href="#l11.978"></a><span id="l11.978">           PL_strcpy(newOnlineName, onlineDirWithDelimiter.get());</span>
<a href="#l11.979"></a><span id="l11.979">           PL_strcat(newOnlineName, onlineMailboxName);</span>
<a href="#l11.980"></a><span id="l11.980">         }</span>
<a href="#l11.981"></a><span id="l11.981">       }</span>
<a href="#l11.982"></a><span id="l11.982">     }</span>
<a href="#l11.983"></a><span id="l11.983">   }</span>
<a href="#l11.984"></a><span id="l11.984">   if (directory)</span>
<a href="#l11.985"></a><span id="l11.985">     *directory = newOnlineName;</span>
<a href="#l11.986"></a><span id="l11.986">   else if (newOnlineName)</span>
<a href="#l11.987"></a><span id="l11.987">     free(newOnlineName);</span>
<a href="#l11.988"></a><span id="l11.988">   return rv;</span>
<a href="#l11.989"></a><span id="l11.989"> }</span>
<a href="#l11.990"></a><span id="l11.990"> </span>
<a href="#l11.991"></a><span id="l11.991" class="difflineminus">-// Converts from canonical format (hierarchy is indicated by '/' and all real slashes ('/') are escaped)</span>
<a href="#l11.992"></a><span id="l11.992" class="difflineminus">-// to the real online name on the server.</span>
<a href="#l11.993"></a><span id="l11.993" class="difflineminus">-NS_IMETHODIMP nsImapUrl::AllocateServerPath(const char * canonicalPath, char onlineDelimiter, char ** aAllocatedPath)</span>
<a href="#l11.994"></a><span id="l11.994" class="difflineminus">-{</span>
<a href="#l11.995"></a><span id="l11.995" class="difflineplus">+// Converts from canonical format (hierarchy is indicated by '/' and all real</span>
<a href="#l11.996"></a><span id="l11.996" class="difflineplus">+// slashes ('/') are escaped) to the real online name on the server.</span>
<a href="#l11.997"></a><span id="l11.997" class="difflineplus">+NS_IMETHODIMP nsImapUrl::AllocateServerPath(const char *canonicalPath,</span>
<a href="#l11.998"></a><span id="l11.998" class="difflineplus">+                                            char onlineDelimiter,</span>
<a href="#l11.999"></a><span id="l11.999" class="difflineplus">+                                            char **aAllocatedPath) {</span>
<a href="#l11.1000"></a><span id="l11.1000">   nsresult retVal = NS_OK;</span>
<a href="#l11.1001"></a><span id="l11.1001">   char *rv = NULL;</span>
<a href="#l11.1002"></a><span id="l11.1002">   char delimiterToUse = onlineDelimiter;</span>
<a href="#l11.1003"></a><span id="l11.1003">   if (onlineDelimiter == kOnlineHierarchySeparatorUnknown)</span>
<a href="#l11.1004"></a><span id="l11.1004">     GetOnlineSubDirSeparator(&amp;delimiterToUse);</span>
<a href="#l11.1005"></a><span id="l11.1005" class="difflineminus">-  NS_ASSERTION(delimiterToUse != kOnlineHierarchySeparatorUnknown, &quot;hierarchy separator unknown&quot;);</span>
<a href="#l11.1006"></a><span id="l11.1006" class="difflineplus">+  NS_ASSERTION(delimiterToUse != kOnlineHierarchySeparatorUnknown,</span>
<a href="#l11.1007"></a><span id="l11.1007" class="difflineplus">+               &quot;hierarchy separator unknown&quot;);</span>
<a href="#l11.1008"></a><span id="l11.1008">   if (canonicalPath)</span>
<a href="#l11.1009"></a><span id="l11.1009">     rv = ReplaceCharsInCopiedString(canonicalPath, '/', delimiterToUse);</span>
<a href="#l11.1010"></a><span id="l11.1010">   else</span>
<a href="#l11.1011"></a><span id="l11.1011">     rv = strdup(&quot;&quot;);</span>
<a href="#l11.1012"></a><span id="l11.1012"> </span>
<a href="#l11.1013"></a><span id="l11.1013" class="difflineminus">-  if (delimiterToUse != '/')</span>
<a href="#l11.1014"></a><span id="l11.1014" class="difflineminus">-    UnescapeSlashes(rv);</span>
<a href="#l11.1015"></a><span id="l11.1015" class="difflineplus">+  if (delimiterToUse != '/') UnescapeSlashes(rv);</span>
<a href="#l11.1016"></a><span id="l11.1016">   char *onlineNameAdded = nullptr;</span>
<a href="#l11.1017"></a><span id="l11.1017">   AddOnlineDirectoryIfNecessary(rv, &amp;onlineNameAdded);</span>
<a href="#l11.1018"></a><span id="l11.1018" class="difflineminus">-  if (onlineNameAdded)</span>
<a href="#l11.1019"></a><span id="l11.1019" class="difflineminus">-  {</span>
<a href="#l11.1020"></a><span id="l11.1020" class="difflineplus">+  if (onlineNameAdded) {</span>
<a href="#l11.1021"></a><span id="l11.1021">     free(rv);</span>
<a href="#l11.1022"></a><span id="l11.1022">     rv = onlineNameAdded;</span>
<a href="#l11.1023"></a><span id="l11.1023">   }</span>
<a href="#l11.1024"></a><span id="l11.1024"> </span>
<a href="#l11.1025"></a><span id="l11.1025">   if (aAllocatedPath)</span>
<a href="#l11.1026"></a><span id="l11.1026">     *aAllocatedPath = rv;</span>
<a href="#l11.1027"></a><span id="l11.1027">   else</span>
<a href="#l11.1028"></a><span id="l11.1028">     free(rv);</span>
<a href="#l11.1029"></a><span id="l11.1029"> </span>
<a href="#l11.1030"></a><span id="l11.1030">   return retVal;</span>
<a href="#l11.1031"></a><span id="l11.1031"> }</span>
<a href="#l11.1032"></a><span id="l11.1032"> </span>
<a href="#l11.1033"></a><span id="l11.1033"> // escape '/' as ^, ^ -&gt; ^^ - use UnescapeSlashes to revert</span>
<a href="#l11.1034"></a><span id="l11.1034" class="difflineminus">-/* static */ nsresult nsImapUrl::EscapeSlashes(const char *sourcePath, char **resultPath)</span>
<a href="#l11.1035"></a><span id="l11.1035" class="difflineminus">-{</span>
<a href="#l11.1036"></a><span id="l11.1036" class="difflineplus">+/* static */ nsresult nsImapUrl::EscapeSlashes(const char *sourcePath,</span>
<a href="#l11.1037"></a><span id="l11.1037" class="difflineplus">+                                               char **resultPath) {</span>
<a href="#l11.1038"></a><span id="l11.1038">   NS_ENSURE_ARG(sourcePath);</span>
<a href="#l11.1039"></a><span id="l11.1039">   NS_ENSURE_ARG(resultPath);</span>
<a href="#l11.1040"></a><span id="l11.1040">   int32_t extra = 0;</span>
<a href="#l11.1041"></a><span id="l11.1041">   int32_t len = strlen(sourcePath);</span>
<a href="#l11.1042"></a><span id="l11.1042">   const char *src = sourcePath;</span>
<a href="#l11.1043"></a><span id="l11.1043">   int32_t i;</span>
<a href="#l11.1044"></a><span id="l11.1044" class="difflineminus">-  for ( i = 0; i &lt; len; i++)</span>
<a href="#l11.1045"></a><span id="l11.1045" class="difflineminus">-  {</span>
<a href="#l11.1046"></a><span id="l11.1046" class="difflineminus">-    if (*src == '^')</span>
<a href="#l11.1047"></a><span id="l11.1047" class="difflineminus">-      extra += 1; /* ^ -&gt; ^^ */</span>
<a href="#l11.1048"></a><span id="l11.1048" class="difflineplus">+  for (i = 0; i &lt; len; i++) {</span>
<a href="#l11.1049"></a><span id="l11.1049" class="difflineplus">+    if (*src == '^') extra += 1; /* ^ -&gt; ^^ */</span>
<a href="#l11.1050"></a><span id="l11.1050">     src++;</span>
<a href="#l11.1051"></a><span id="l11.1051">   }</span>
<a href="#l11.1052"></a><span id="l11.1052" class="difflineminus">-  char* result = (char *)moz_xmalloc(len + extra + 1);</span>
<a href="#l11.1053"></a><span id="l11.1053" class="difflineminus">-  if (!result)</span>
<a href="#l11.1054"></a><span id="l11.1054" class="difflineminus">-    return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l11.1055"></a><span id="l11.1055" class="difflineplus">+  char *result = (char *)moz_xmalloc(len + extra + 1);</span>
<a href="#l11.1056"></a><span id="l11.1056" class="difflineplus">+  if (!result) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l11.1057"></a><span id="l11.1057"> </span>
<a href="#l11.1058"></a><span id="l11.1058" class="difflineminus">-  unsigned char* dst = (unsigned char *) result;</span>
<a href="#l11.1059"></a><span id="l11.1059" class="difflineplus">+  unsigned char *dst = (unsigned char *)result;</span>
<a href="#l11.1060"></a><span id="l11.1060">   src = sourcePath;</span>
<a href="#l11.1061"></a><span id="l11.1061" class="difflineminus">-  for (i = 0; i &lt; len; i++)</span>
<a href="#l11.1062"></a><span id="l11.1062" class="difflineminus">-  {</span>
<a href="#l11.1063"></a><span id="l11.1063" class="difflineplus">+  for (i = 0; i &lt; len; i++) {</span>
<a href="#l11.1064"></a><span id="l11.1064">     unsigned char c = *src++;</span>
<a href="#l11.1065"></a><span id="l11.1065">     if (c == '/')</span>
<a href="#l11.1066"></a><span id="l11.1066">       *dst++ = '^';</span>
<a href="#l11.1067"></a><span id="l11.1067" class="difflineminus">-    else if (c == '^')</span>
<a href="#l11.1068"></a><span id="l11.1068" class="difflineminus">-    {</span>
<a href="#l11.1069"></a><span id="l11.1069" class="difflineplus">+    else if (c == '^') {</span>
<a href="#l11.1070"></a><span id="l11.1070">       *dst++ = '^';</span>
<a href="#l11.1071"></a><span id="l11.1071">       *dst++ = '^';</span>
<a href="#l11.1072"></a><span id="l11.1072" class="difflineminus">-    }</span>
<a href="#l11.1073"></a><span id="l11.1073" class="difflineminus">-    else</span>
<a href="#l11.1074"></a><span id="l11.1074" class="difflineplus">+    } else</span>
<a href="#l11.1075"></a><span id="l11.1075">       *dst++ = c;</span>
<a href="#l11.1076"></a><span id="l11.1076">   }</span>
<a href="#l11.1077"></a><span id="l11.1077" class="difflineminus">-  *dst = '\0';     /* tack on eos */</span>
<a href="#l11.1078"></a><span id="l11.1078" class="difflineplus">+  *dst = '\0'; /* tack on eos */</span>
<a href="#l11.1079"></a><span id="l11.1079">   *resultPath = result;</span>
<a href="#l11.1080"></a><span id="l11.1080">   return NS_OK;</span>
<a href="#l11.1081"></a><span id="l11.1081"> }</span>
<a href="#l11.1082"></a><span id="l11.1082"> </span>
<a href="#l11.1083"></a><span id="l11.1083" class="difflineminus">-/* static */ nsresult nsImapUrl::UnescapeSlashes(char *sourcePath)</span>
<a href="#l11.1084"></a><span id="l11.1084" class="difflineminus">-{</span>
<a href="#l11.1085"></a><span id="l11.1085" class="difflineminus">-    char *src = sourcePath;</span>
<a href="#l11.1086"></a><span id="l11.1086" class="difflineminus">-    char *dst = sourcePath;</span>
<a href="#l11.1087"></a><span id="l11.1087" class="difflineplus">+/* static */ nsresult nsImapUrl::UnescapeSlashes(char *sourcePath) {</span>
<a href="#l11.1088"></a><span id="l11.1088" class="difflineplus">+  char *src = sourcePath;</span>
<a href="#l11.1089"></a><span id="l11.1089" class="difflineplus">+  char *dst = sourcePath;</span>
<a href="#l11.1090"></a><span id="l11.1090"> </span>
<a href="#l11.1091"></a><span id="l11.1091" class="difflineminus">-    while (*src)</span>
<a href="#l11.1092"></a><span id="l11.1092" class="difflineminus">-    {</span>
<a href="#l11.1093"></a><span id="l11.1093" class="difflineminus">-      if (*src == '^')</span>
<a href="#l11.1094"></a><span id="l11.1094" class="difflineminus">-      {</span>
<a href="#l11.1095"></a><span id="l11.1095" class="difflineminus">-        if (*(src + 1) == '^')</span>
<a href="#l11.1096"></a><span id="l11.1096" class="difflineminus">-        {</span>
<a href="#l11.1097"></a><span id="l11.1097" class="difflineminus">-          *dst++ = '^';</span>
<a href="#l11.1098"></a><span id="l11.1098" class="difflineminus">-          src++;   // skip over second '^'</span>
<a href="#l11.1099"></a><span id="l11.1099" class="difflineminus">-        }</span>
<a href="#l11.1100"></a><span id="l11.1100" class="difflineminus">-        else</span>
<a href="#l11.1101"></a><span id="l11.1101" class="difflineminus">-          *dst++ = '/';</span>
<a href="#l11.1102"></a><span id="l11.1102" class="difflineminus">-        src++;</span>
<a href="#l11.1103"></a><span id="l11.1103" class="difflineminus">-      }</span>
<a href="#l11.1104"></a><span id="l11.1104" class="difflineminus">-      else</span>
<a href="#l11.1105"></a><span id="l11.1105" class="difflineminus">-        *dst++ = *src++;</span>
<a href="#l11.1106"></a><span id="l11.1106" class="difflineminus">-    }</span>
<a href="#l11.1107"></a><span id="l11.1107" class="difflineplus">+  while (*src) {</span>
<a href="#l11.1108"></a><span id="l11.1108" class="difflineplus">+    if (*src == '^') {</span>
<a href="#l11.1109"></a><span id="l11.1109" class="difflineplus">+      if (*(src + 1) == '^') {</span>
<a href="#l11.1110"></a><span id="l11.1110" class="difflineplus">+        *dst++ = '^';</span>
<a href="#l11.1111"></a><span id="l11.1111" class="difflineplus">+        src++;  // skip over second '^'</span>
<a href="#l11.1112"></a><span id="l11.1112" class="difflineplus">+      } else</span>
<a href="#l11.1113"></a><span id="l11.1113" class="difflineplus">+        *dst++ = '/';</span>
<a href="#l11.1114"></a><span id="l11.1114" class="difflineplus">+      src++;</span>
<a href="#l11.1115"></a><span id="l11.1115" class="difflineplus">+    } else</span>
<a href="#l11.1116"></a><span id="l11.1116" class="difflineplus">+      *dst++ = *src++;</span>
<a href="#l11.1117"></a><span id="l11.1117" class="difflineplus">+  }</span>
<a href="#l11.1118"></a><span id="l11.1118"> </span>
<a href="#l11.1119"></a><span id="l11.1119" class="difflineminus">-    *dst = 0;</span>
<a href="#l11.1120"></a><span id="l11.1120" class="difflineminus">-    return NS_OK;</span>
<a href="#l11.1121"></a><span id="l11.1121" class="difflineplus">+  *dst = 0;</span>
<a href="#l11.1122"></a><span id="l11.1122" class="difflineplus">+  return NS_OK;</span>
<a href="#l11.1123"></a><span id="l11.1123"> }</span>
<a href="#l11.1124"></a><span id="l11.1124"> </span>
<a href="#l11.1125"></a><span id="l11.1125" class="difflineminus">-/*  static */ nsresult nsImapUrl::ConvertToCanonicalFormat(const char *folderName, char onlineDelimiter, char **resultingCanonicalPath)</span>
<a href="#l11.1126"></a><span id="l11.1126" class="difflineminus">-{</span>
<a href="#l11.1127"></a><span id="l11.1127" class="difflineplus">+/*  static */ nsresult nsImapUrl::ConvertToCanonicalFormat(</span>
<a href="#l11.1128"></a><span id="l11.1128" class="difflineplus">+    const char *folderName, char onlineDelimiter,</span>
<a href="#l11.1129"></a><span id="l11.1129" class="difflineplus">+    char **resultingCanonicalPath) {</span>
<a href="#l11.1130"></a><span id="l11.1130">   // Now, start the conversion to canonical form.</span>
<a href="#l11.1131"></a><span id="l11.1131"> </span>
<a href="#l11.1132"></a><span id="l11.1132">   char *canonicalPath;</span>
<a href="#l11.1133"></a><span id="l11.1133" class="difflineminus">-  if (onlineDelimiter != '/')</span>
<a href="#l11.1134"></a><span id="l11.1134" class="difflineminus">-  {</span>
<a href="#l11.1135"></a><span id="l11.1135" class="difflineplus">+  if (onlineDelimiter != '/') {</span>
<a href="#l11.1136"></a><span id="l11.1136">     nsCString escapedPath;</span>
<a href="#l11.1137"></a><span id="l11.1137"> </span>
<a href="#l11.1138"></a><span id="l11.1138">     EscapeSlashes(folderName, getter_Copies(escapedPath));</span>
<a href="#l11.1139"></a><span id="l11.1139" class="difflineminus">-    canonicalPath = ReplaceCharsInCopiedString(escapedPath.get(), onlineDelimiter , '/');</span>
<a href="#l11.1140"></a><span id="l11.1140" class="difflineminus">-  }</span>
<a href="#l11.1141"></a><span id="l11.1141" class="difflineminus">-  else</span>
<a href="#l11.1142"></a><span id="l11.1142" class="difflineminus">-  {</span>
<a href="#l11.1143"></a><span id="l11.1143" class="difflineplus">+    canonicalPath =</span>
<a href="#l11.1144"></a><span id="l11.1144" class="difflineplus">+        ReplaceCharsInCopiedString(escapedPath.get(), onlineDelimiter, '/');</span>
<a href="#l11.1145"></a><span id="l11.1145" class="difflineplus">+  } else {</span>
<a href="#l11.1146"></a><span id="l11.1146">     canonicalPath = strdup(folderName);</span>
<a href="#l11.1147"></a><span id="l11.1147">   }</span>
<a href="#l11.1148"></a><span id="l11.1148" class="difflineminus">-  if (canonicalPath)</span>
<a href="#l11.1149"></a><span id="l11.1149" class="difflineminus">-    *resultingCanonicalPath = canonicalPath;</span>
<a href="#l11.1150"></a><span id="l11.1150" class="difflineplus">+  if (canonicalPath) *resultingCanonicalPath = canonicalPath;</span>
<a href="#l11.1151"></a><span id="l11.1151"> </span>
<a href="#l11.1152"></a><span id="l11.1152">   return (canonicalPath) ? NS_OK : NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l11.1153"></a><span id="l11.1153"> }</span>
<a href="#l11.1154"></a><span id="l11.1154"> </span>
<a href="#l11.1155"></a><span id="l11.1155"> // Converts the real online name on the server to canonical format:</span>
<a href="#l11.1156"></a><span id="l11.1156" class="difflineminus">-// result is hierarchy is indicated by '/' and all real slashes ('/') are escaped.</span>
<a href="#l11.1157"></a><span id="l11.1157" class="difflineminus">-// The caller has already converted m-utf-7 to 8 bit ascii, which is a problem.</span>
<a href="#l11.1158"></a><span id="l11.1158" class="difflineminus">-// this method is only called from the imap thread</span>
<a href="#l11.1159"></a><span id="l11.1159" class="difflineminus">-NS_IMETHODIMP nsImapUrl::AllocateCanonicalPath(const char *serverPath, char onlineDelimiter, char **allocatedPath )</span>
<a href="#l11.1160"></a><span id="l11.1160" class="difflineminus">-{</span>
<a href="#l11.1161"></a><span id="l11.1161" class="difflineplus">+// result is hierarchy is indicated by '/' and all real slashes ('/') are</span>
<a href="#l11.1162"></a><span id="l11.1162" class="difflineplus">+// escaped. The caller has already converted m-utf-7 to 8 bit ascii, which is a</span>
<a href="#l11.1163"></a><span id="l11.1163" class="difflineplus">+// problem. this method is only called from the imap thread</span>
<a href="#l11.1164"></a><span id="l11.1164" class="difflineplus">+NS_IMETHODIMP nsImapUrl::AllocateCanonicalPath(const char *serverPath,</span>
<a href="#l11.1165"></a><span id="l11.1165" class="difflineplus">+                                               char onlineDelimiter,</span>
<a href="#l11.1166"></a><span id="l11.1166" class="difflineplus">+                                               char **allocatedPath) {</span>
<a href="#l11.1167"></a><span id="l11.1167">   nsresult rv = NS_ERROR_NULL_POINTER;</span>
<a href="#l11.1168"></a><span id="l11.1168">   char delimiterToUse = onlineDelimiter;</span>
<a href="#l11.1169"></a><span id="l11.1169">   char *serverKey = nullptr;</span>
<a href="#l11.1170"></a><span id="l11.1170">   nsString aString;</span>
<a href="#l11.1171"></a><span id="l11.1171" class="difflineminus">-  char *currentPath = (char *) serverPath;</span>
<a href="#l11.1172"></a><span id="l11.1172" class="difflineplus">+  char *currentPath = (char *)serverPath;</span>
<a href="#l11.1173"></a><span id="l11.1173">   nsAutoCString onlineDir;</span>
<a href="#l11.1174"></a><span id="l11.1174">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l11.1175"></a><span id="l11.1175"> </span>
<a href="#l11.1176"></a><span id="l11.1176">   nsCOMPtr&lt;nsIImapHostSessionList&gt; hostSessionList =</span>
<a href="#l11.1177"></a><span id="l11.1177" class="difflineminus">-    do_GetService(kCImapHostSessionListCID, &amp;rv);</span>
<a href="#l11.1178"></a><span id="l11.1178" class="difflineplus">+      do_GetService(kCImapHostSessionListCID, &amp;rv);</span>
<a href="#l11.1179"></a><span id="l11.1179"> </span>
<a href="#l11.1180"></a><span id="l11.1180">   *allocatedPath = nullptr;</span>
<a href="#l11.1181"></a><span id="l11.1181"> </span>
<a href="#l11.1182"></a><span id="l11.1182">   if (onlineDelimiter == kOnlineHierarchySeparatorUnknown ||</span>
<a href="#l11.1183"></a><span id="l11.1183" class="difflineminus">-    onlineDelimiter == 0)</span>
<a href="#l11.1184"></a><span id="l11.1184" class="difflineplus">+      onlineDelimiter == 0)</span>
<a href="#l11.1185"></a><span id="l11.1185">     GetOnlineSubDirSeparator(&amp;delimiterToUse);</span>
<a href="#l11.1186"></a><span id="l11.1186"> </span>
<a href="#l11.1187"></a><span id="l11.1187" class="difflineminus">-  NS_ASSERTION (serverPath, &quot;Oops... null serverPath&quot;);</span>
<a href="#l11.1188"></a><span id="l11.1188" class="difflineplus">+  NS_ASSERTION(serverPath, &quot;Oops... null serverPath&quot;);</span>
<a href="#l11.1189"></a><span id="l11.1189"> </span>
<a href="#l11.1190"></a><span id="l11.1190" class="difflineminus">-  if (!serverPath || NS_FAILED(rv))</span>
<a href="#l11.1191"></a><span id="l11.1191" class="difflineminus">-    goto done;</span>
<a href="#l11.1192"></a><span id="l11.1192" class="difflineplus">+  if (!serverPath || NS_FAILED(rv)) goto done;</span>
<a href="#l11.1193"></a><span id="l11.1193"> </span>
<a href="#l11.1194"></a><span id="l11.1194">   hostSessionList-&gt;GetOnlineDirForHost(m_serverKey.get(), aString);</span>
<a href="#l11.1195"></a><span id="l11.1195">   // First we have to check to see if we should strip off an online server</span>
<a href="#l11.1196"></a><span id="l11.1196">   // subdirectory</span>
<a href="#l11.1197"></a><span id="l11.1197">   // If this host has an online server directory configured</span>
<a href="#l11.1198"></a><span id="l11.1198">   LossyCopyUTF16toASCII(aString, onlineDir);</span>
<a href="#l11.1199"></a><span id="l11.1199"> </span>
<a href="#l11.1200"></a><span id="l11.1200" class="difflineminus">-  if (currentPath &amp;&amp; !onlineDir.IsEmpty())</span>
<a href="#l11.1201"></a><span id="l11.1201" class="difflineminus">-  {</span>
<a href="#l11.1202"></a><span id="l11.1202" class="difflineplus">+  if (currentPath &amp;&amp; !onlineDir.IsEmpty()) {</span>
<a href="#l11.1203"></a><span id="l11.1203">     // By definition, the online dir must be at the root.</span>
<a href="#l11.1204"></a><span id="l11.1204" class="difflineminus">-    if (delimiterToUse &amp;&amp; delimiterToUse != kOnlineHierarchySeparatorUnknown)</span>
<a href="#l11.1205"></a><span id="l11.1205" class="difflineminus">-    {</span>
<a href="#l11.1206"></a><span id="l11.1206" class="difflineplus">+    if (delimiterToUse &amp;&amp; delimiterToUse != kOnlineHierarchySeparatorUnknown) {</span>
<a href="#l11.1207"></a><span id="l11.1207">       // try to change the canonical online dir name to real dir name first</span>
<a href="#l11.1208"></a><span id="l11.1208">       MsgReplaceChar(onlineDir, '/', delimiterToUse);</span>
<a href="#l11.1209"></a><span id="l11.1209">       // Add the delimiter</span>
<a href="#l11.1210"></a><span id="l11.1210" class="difflineminus">-      if (onlineDir.Last() != delimiterToUse)</span>
<a href="#l11.1211"></a><span id="l11.1211" class="difflineminus">-        onlineDir += delimiterToUse;</span>
<a href="#l11.1212"></a><span id="l11.1212" class="difflineplus">+      if (onlineDir.Last() != delimiterToUse) onlineDir += delimiterToUse;</span>
<a href="#l11.1213"></a><span id="l11.1213">     }</span>
<a href="#l11.1214"></a><span id="l11.1214">     int len = onlineDir.Length();</span>
<a href="#l11.1215"></a><span id="l11.1215" class="difflineminus">-    if (!PL_strncmp(onlineDir.get(), currentPath, len))</span>
<a href="#l11.1216"></a><span id="l11.1216" class="difflineminus">-    {</span>
<a href="#l11.1217"></a><span id="l11.1217" class="difflineplus">+    if (!PL_strncmp(onlineDir.get(), currentPath, len)) {</span>
<a href="#l11.1218"></a><span id="l11.1218">       // This online path begins with the server sub directory</span>
<a href="#l11.1219"></a><span id="l11.1219">       currentPath += len;</span>
<a href="#l11.1220"></a><span id="l11.1220"> </span>
<a href="#l11.1221"></a><span id="l11.1221">       // This might occur, but it's most likely something not good.</span>
<a href="#l11.1222"></a><span id="l11.1222" class="difflineminus">-      // Basically, it means we're doing something on the online sub directory itself.</span>
<a href="#l11.1223"></a><span id="l11.1223" class="difflineminus">-      NS_ASSERTION (*currentPath, &quot;Oops ... null currentPath&quot;);</span>
<a href="#l11.1224"></a><span id="l11.1224" class="difflineplus">+      // Basically, it means we're doing something on the online sub directory</span>
<a href="#l11.1225"></a><span id="l11.1225" class="difflineplus">+      // itself.</span>
<a href="#l11.1226"></a><span id="l11.1226" class="difflineplus">+      NS_ASSERTION(*currentPath, &quot;Oops ... null currentPath&quot;);</span>
<a href="#l11.1227"></a><span id="l11.1227">       // Also make sure that the first character in the mailbox name is not '/'.</span>
<a href="#l11.1228"></a><span id="l11.1228" class="difflineminus">-      NS_ASSERTION (*currentPath != '/',</span>
<a href="#l11.1229"></a><span id="l11.1229" class="difflineminus">-        &quot;Oops ... currentPath starts with a slash&quot;);</span>
<a href="#l11.1230"></a><span id="l11.1230" class="difflineplus">+      NS_ASSERTION(*currentPath != '/',</span>
<a href="#l11.1231"></a><span id="l11.1231" class="difflineplus">+                   &quot;Oops ... currentPath starts with a slash&quot;);</span>
<a href="#l11.1232"></a><span id="l11.1232">     }</span>
<a href="#l11.1233"></a><span id="l11.1233">   }</span>
<a href="#l11.1234"></a><span id="l11.1234"> </span>
<a href="#l11.1235"></a><span id="l11.1235" class="difflineminus">-</span>
<a href="#l11.1236"></a><span id="l11.1236" class="difflineminus">-  if (!currentPath)</span>
<a href="#l11.1237"></a><span id="l11.1237" class="difflineminus">-    goto done;</span>
<a href="#l11.1238"></a><span id="l11.1238" class="difflineplus">+  if (!currentPath) goto done;</span>
<a href="#l11.1239"></a><span id="l11.1239"> </span>
<a href="#l11.1240"></a><span id="l11.1240">   rv = ConvertToCanonicalFormat(currentPath, delimiterToUse, allocatedPath);</span>
<a href="#l11.1241"></a><span id="l11.1241"> </span>
<a href="#l11.1242"></a><span id="l11.1242"> done:</span>
<a href="#l11.1243"></a><span id="l11.1243">   PR_Free(serverKey);</span>
<a href="#l11.1244"></a><span id="l11.1244">   return rv;</span>
<a href="#l11.1245"></a><span id="l11.1245"> }</span>
<a href="#l11.1246"></a><span id="l11.1246"> </span>
<a href="#l11.1247"></a><span id="l11.1247"> // this method is only called from the imap thread</span>
<a href="#l11.1248"></a><span id="l11.1248" class="difflineminus">-NS_IMETHODIMP  nsImapUrl::CreateServerSourceFolderPathString(char **result)</span>
<a href="#l11.1249"></a><span id="l11.1249" class="difflineminus">-{</span>
<a href="#l11.1250"></a><span id="l11.1250" class="difflineplus">+NS_IMETHODIMP nsImapUrl::CreateServerSourceFolderPathString(char **result) {</span>
<a href="#l11.1251"></a><span id="l11.1251">   NS_ENSURE_ARG_POINTER(result);</span>
<a href="#l11.1252"></a><span id="l11.1252" class="difflineminus">-  AllocateServerPath(m_sourceCanonicalFolderPathSubString, kOnlineHierarchySeparatorUnknown, result);</span>
<a href="#l11.1253"></a><span id="l11.1253" class="difflineplus">+  AllocateServerPath(m_sourceCanonicalFolderPathSubString,</span>
<a href="#l11.1254"></a><span id="l11.1254" class="difflineplus">+                     kOnlineHierarchySeparatorUnknown, result);</span>
<a href="#l11.1255"></a><span id="l11.1255">   return NS_OK;</span>
<a href="#l11.1256"></a><span id="l11.1256"> }</span>
<a href="#l11.1257"></a><span id="l11.1257"> </span>
<a href="#l11.1258"></a><span id="l11.1258"> // this method is called from the imap thread AND the UI thread...</span>
<a href="#l11.1259"></a><span id="l11.1259" class="difflineminus">-NS_IMETHODIMP nsImapUrl::CreateCanonicalSourceFolderPathString(char **result)</span>
<a href="#l11.1260"></a><span id="l11.1260" class="difflineminus">-{</span>
<a href="#l11.1261"></a><span id="l11.1261" class="difflineplus">+NS_IMETHODIMP nsImapUrl::CreateCanonicalSourceFolderPathString(char **result) {</span>
<a href="#l11.1262"></a><span id="l11.1262">   NS_ENSURE_ARG_POINTER(result);</span>
<a href="#l11.1263"></a><span id="l11.1263" class="difflineminus">-  MutexAutoLock  mon(mLock);</span>
<a href="#l11.1264"></a><span id="l11.1264" class="difflineminus">-  *result = strdup(m_sourceCanonicalFolderPathSubString ? m_sourceCanonicalFolderPathSubString : &quot;&quot;);</span>
<a href="#l11.1265"></a><span id="l11.1265" class="difflineplus">+  MutexAutoLock mon(mLock);</span>
<a href="#l11.1266"></a><span id="l11.1266" class="difflineplus">+  *result = strdup(m_sourceCanonicalFolderPathSubString</span>
<a href="#l11.1267"></a><span id="l11.1267" class="difflineplus">+                       ? m_sourceCanonicalFolderPathSubString</span>
<a href="#l11.1268"></a><span id="l11.1268" class="difflineplus">+                       : &quot;&quot;);</span>
<a href="#l11.1269"></a><span id="l11.1269">   return (*result) ? NS_OK : NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l11.1270"></a><span id="l11.1270"> }</span>
<a href="#l11.1271"></a><span id="l11.1271"> </span>
<a href="#l11.1272"></a><span id="l11.1272"> // this method is called from the imap thread AND the UI thread...</span>
<a href="#l11.1273"></a><span id="l11.1273" class="difflineminus">-NS_IMETHODIMP nsImapUrl::CreateServerDestinationFolderPathString(char **result)</span>
<a href="#l11.1274"></a><span id="l11.1274" class="difflineminus">-{</span>
<a href="#l11.1275"></a><span id="l11.1275" class="difflineplus">+NS_IMETHODIMP nsImapUrl::CreateServerDestinationFolderPathString(</span>
<a href="#l11.1276"></a><span id="l11.1276" class="difflineplus">+    char **result) {</span>
<a href="#l11.1277"></a><span id="l11.1277">   NS_ENSURE_ARG_POINTER(result);</span>
<a href="#l11.1278"></a><span id="l11.1278">   MutexAutoLock mon(mLock);</span>
<a href="#l11.1279"></a><span id="l11.1279">   nsresult rv = AllocateServerPath(m_destinationCanonicalFolderPathSubString,</span>
<a href="#l11.1280"></a><span id="l11.1280" class="difflineminus">-                                   kOnlineHierarchySeparatorUnknown,</span>
<a href="#l11.1281"></a><span id="l11.1281" class="difflineminus">-                                   result);</span>
<a href="#l11.1282"></a><span id="l11.1282" class="difflineplus">+                                   kOnlineHierarchySeparatorUnknown, result);</span>
<a href="#l11.1283"></a><span id="l11.1283">   return (*result) ? rv : NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l11.1284"></a><span id="l11.1284"> }</span>
<a href="#l11.1285"></a><span id="l11.1285"> </span>
<a href="#l11.1286"></a><span id="l11.1286"> // for enabling or disabling mime parts on demand. Setting this to true says we</span>
<a href="#l11.1287"></a><span id="l11.1287"> // can use mime parts on demand, if we chose.</span>
<a href="#l11.1288"></a><span id="l11.1288" class="difflineminus">-NS_IMETHODIMP nsImapUrl::SetAllowContentChange(bool allowContentChange)</span>
<a href="#l11.1289"></a><span id="l11.1289" class="difflineminus">-{</span>
<a href="#l11.1290"></a><span id="l11.1290" class="difflineplus">+NS_IMETHODIMP nsImapUrl::SetAllowContentChange(bool allowContentChange) {</span>
<a href="#l11.1291"></a><span id="l11.1291">   m_allowContentChange = allowContentChange;</span>
<a href="#l11.1292"></a><span id="l11.1292">   return NS_OK;</span>
<a href="#l11.1293"></a><span id="l11.1293"> }</span>
<a href="#l11.1294"></a><span id="l11.1294"> </span>
<a href="#l11.1295"></a><span id="l11.1295" class="difflineminus">-NS_IMETHODIMP nsImapUrl::SetContentModified(nsImapContentModifiedType contentModified)</span>
<a href="#l11.1296"></a><span id="l11.1296" class="difflineminus">-{</span>
<a href="#l11.1297"></a><span id="l11.1297" class="difflineplus">+NS_IMETHODIMP nsImapUrl::SetContentModified(</span>
<a href="#l11.1298"></a><span id="l11.1298" class="difflineplus">+    nsImapContentModifiedType contentModified) {</span>
<a href="#l11.1299"></a><span id="l11.1299">   m_contentModified = contentModified;</span>
<a href="#l11.1300"></a><span id="l11.1300">   nsCOMPtr&lt;nsICacheEntry&gt; cacheEntry;</span>
<a href="#l11.1301"></a><span id="l11.1301">   nsresult res = GetMemCacheEntry(getter_AddRefs(cacheEntry));</span>
<a href="#l11.1302"></a><span id="l11.1302" class="difflineminus">-  if (NS_SUCCEEDED(res) &amp;&amp; cacheEntry)</span>
<a href="#l11.1303"></a><span id="l11.1303" class="difflineminus">-  {</span>
<a href="#l11.1304"></a><span id="l11.1304" class="difflineplus">+  if (NS_SUCCEEDED(res) &amp;&amp; cacheEntry) {</span>
<a href="#l11.1305"></a><span id="l11.1305">     const char *contentModifiedAnnotation = &quot;&quot;;</span>
<a href="#l11.1306"></a><span id="l11.1306" class="difflineminus">-    switch (m_contentModified)</span>
<a href="#l11.1307"></a><span id="l11.1307" class="difflineminus">-    {</span>
<a href="#l11.1308"></a><span id="l11.1308" class="difflineminus">-    case IMAP_CONTENT_NOT_MODIFIED:</span>
<a href="#l11.1309"></a><span id="l11.1309" class="difflineminus">-      contentModifiedAnnotation = &quot;Not Modified&quot;;</span>
<a href="#l11.1310"></a><span id="l11.1310" class="difflineminus">-      break;</span>
<a href="#l11.1311"></a><span id="l11.1311" class="difflineminus">-    case IMAP_CONTENT_MODIFIED_VIEW_INLINE:</span>
<a href="#l11.1312"></a><span id="l11.1312" class="difflineminus">-      contentModifiedAnnotation = &quot;Modified View Inline&quot;;</span>
<a href="#l11.1313"></a><span id="l11.1313" class="difflineminus">-      break;</span>
<a href="#l11.1314"></a><span id="l11.1314" class="difflineminus">-    case IMAP_CONTENT_MODIFIED_VIEW_AS_LINKS:</span>
<a href="#l11.1315"></a><span id="l11.1315" class="difflineminus">-      contentModifiedAnnotation = &quot;Modified View As Link&quot;;</span>
<a href="#l11.1316"></a><span id="l11.1316" class="difflineminus">-      break;</span>
<a href="#l11.1317"></a><span id="l11.1317" class="difflineminus">-    case IMAP_CONTENT_FORCE_CONTENT_NOT_MODIFIED:</span>
<a href="#l11.1318"></a><span id="l11.1318" class="difflineminus">-      contentModifiedAnnotation = &quot;Force Content Not Modified&quot;;</span>
<a href="#l11.1319"></a><span id="l11.1319" class="difflineminus">-      break;</span>
<a href="#l11.1320"></a><span id="l11.1320" class="difflineplus">+    switch (m_contentModified) {</span>
<a href="#l11.1321"></a><span id="l11.1321" class="difflineplus">+      case IMAP_CONTENT_NOT_MODIFIED:</span>
<a href="#l11.1322"></a><span id="l11.1322" class="difflineplus">+        contentModifiedAnnotation = &quot;Not Modified&quot;;</span>
<a href="#l11.1323"></a><span id="l11.1323" class="difflineplus">+        break;</span>
<a href="#l11.1324"></a><span id="l11.1324" class="difflineplus">+      case IMAP_CONTENT_MODIFIED_VIEW_INLINE:</span>
<a href="#l11.1325"></a><span id="l11.1325" class="difflineplus">+        contentModifiedAnnotation = &quot;Modified View Inline&quot;;</span>
<a href="#l11.1326"></a><span id="l11.1326" class="difflineplus">+        break;</span>
<a href="#l11.1327"></a><span id="l11.1327" class="difflineplus">+      case IMAP_CONTENT_MODIFIED_VIEW_AS_LINKS:</span>
<a href="#l11.1328"></a><span id="l11.1328" class="difflineplus">+        contentModifiedAnnotation = &quot;Modified View As Link&quot;;</span>
<a href="#l11.1329"></a><span id="l11.1329" class="difflineplus">+        break;</span>
<a href="#l11.1330"></a><span id="l11.1330" class="difflineplus">+      case IMAP_CONTENT_FORCE_CONTENT_NOT_MODIFIED:</span>
<a href="#l11.1331"></a><span id="l11.1331" class="difflineplus">+        contentModifiedAnnotation = &quot;Force Content Not Modified&quot;;</span>
<a href="#l11.1332"></a><span id="l11.1332" class="difflineplus">+        break;</span>
<a href="#l11.1333"></a><span id="l11.1333">     }</span>
<a href="#l11.1334"></a><span id="l11.1334">     MOZ_LOG(IMAPCache, LogLevel::Debug,</span>
<a href="#l11.1335"></a><span id="l11.1335" class="difflineminus">-      (&quot;SetContentModified(): Set annotation to |%s|&quot;, contentModifiedAnnotation));</span>
<a href="#l11.1336"></a><span id="l11.1336" class="difflineminus">-    cacheEntry-&gt;SetMetaDataElement(&quot;ContentModified&quot;, contentModifiedAnnotation);</span>
<a href="#l11.1337"></a><span id="l11.1337" class="difflineminus">-  }</span>
<a href="#l11.1338"></a><span id="l11.1338" class="difflineminus">-  else</span>
<a href="#l11.1339"></a><span id="l11.1339" class="difflineminus">-  {</span>
<a href="#l11.1340"></a><span id="l11.1340" class="difflineplus">+            (&quot;SetContentModified(): Set annotation to |%s|&quot;,</span>
<a href="#l11.1341"></a><span id="l11.1341" class="difflineplus">+             contentModifiedAnnotation));</span>
<a href="#l11.1342"></a><span id="l11.1342" class="difflineplus">+    cacheEntry-&gt;SetMetaDataElement(&quot;ContentModified&quot;,</span>
<a href="#l11.1343"></a><span id="l11.1343" class="difflineplus">+                                   contentModifiedAnnotation);</span>
<a href="#l11.1344"></a><span id="l11.1344" class="difflineplus">+  } else {</span>
<a href="#l11.1345"></a><span id="l11.1345">     MOZ_LOG(IMAPCache, LogLevel::Debug,</span>
<a href="#l11.1346"></a><span id="l11.1346" class="difflineminus">-      (&quot;SetContentModified(): Set annotation FAILED -- no cacheEntry&quot;));</span>
<a href="#l11.1347"></a><span id="l11.1347" class="difflineplus">+            (&quot;SetContentModified(): Set annotation FAILED -- no cacheEntry&quot;));</span>
<a href="#l11.1348"></a><span id="l11.1348">   }</span>
<a href="#l11.1349"></a><span id="l11.1349">   return NS_OK;</span>
<a href="#l11.1350"></a><span id="l11.1350"> }</span>
<a href="#l11.1351"></a><span id="l11.1351"> </span>
<a href="#l11.1352"></a><span id="l11.1352" class="difflineminus">-NS_IMETHODIMP nsImapUrl::GetContentModified(nsImapContentModifiedType *contentModified)</span>
<a href="#l11.1353"></a><span id="l11.1353" class="difflineminus">-{</span>
<a href="#l11.1354"></a><span id="l11.1354" class="difflineplus">+NS_IMETHODIMP nsImapUrl::GetContentModified(</span>
<a href="#l11.1355"></a><span id="l11.1355" class="difflineplus">+    nsImapContentModifiedType *contentModified) {</span>
<a href="#l11.1356"></a><span id="l11.1356">   if (!contentModified) return NS_ERROR_NULL_POINTER;</span>
<a href="#l11.1357"></a><span id="l11.1357"> </span>
<a href="#l11.1358"></a><span id="l11.1358">   *contentModified = m_contentModified;</span>
<a href="#l11.1359"></a><span id="l11.1359">   return NS_OK;</span>
<a href="#l11.1360"></a><span id="l11.1360"> }</span>
<a href="#l11.1361"></a><span id="l11.1361"> </span>
<a href="#l11.1362"></a><span id="l11.1362" class="difflineminus">-NS_IMETHODIMP nsImapUrl::SetFetchPartsOnDemand(bool fetchPartsOnDemand)</span>
<a href="#l11.1363"></a><span id="l11.1363" class="difflineminus">-{</span>
<a href="#l11.1364"></a><span id="l11.1364" class="difflineplus">+NS_IMETHODIMP nsImapUrl::SetFetchPartsOnDemand(bool fetchPartsOnDemand) {</span>
<a href="#l11.1365"></a><span id="l11.1365">   m_fetchPartsOnDemand = fetchPartsOnDemand;</span>
<a href="#l11.1366"></a><span id="l11.1366">   return NS_OK;</span>
<a href="#l11.1367"></a><span id="l11.1367"> }</span>
<a href="#l11.1368"></a><span id="l11.1368"> </span>
<a href="#l11.1369"></a><span id="l11.1369" class="difflineminus">-NS_IMETHODIMP nsImapUrl::GetFetchPartsOnDemand(bool *fetchPartsOnDemand)</span>
<a href="#l11.1370"></a><span id="l11.1370" class="difflineminus">-{</span>
<a href="#l11.1371"></a><span id="l11.1371" class="difflineplus">+NS_IMETHODIMP nsImapUrl::GetFetchPartsOnDemand(bool *fetchPartsOnDemand) {</span>
<a href="#l11.1372"></a><span id="l11.1372">   if (!fetchPartsOnDemand) return NS_ERROR_NULL_POINTER;</span>
<a href="#l11.1373"></a><span id="l11.1373"> </span>
<a href="#l11.1374"></a><span id="l11.1374">   *fetchPartsOnDemand = m_fetchPartsOnDemand;</span>
<a href="#l11.1375"></a><span id="l11.1375">   return NS_OK;</span>
<a href="#l11.1376"></a><span id="l11.1376"> }</span>
<a href="#l11.1377"></a><span id="l11.1377"> </span>
<a href="#l11.1378"></a><span id="l11.1378" class="difflineminus">-</span>
<a href="#l11.1379"></a><span id="l11.1379" class="difflineminus">-NS_IMETHODIMP nsImapUrl::SetMimePartSelectorDetected(bool mimePartSelectorDetected)</span>
<a href="#l11.1380"></a><span id="l11.1380" class="difflineminus">-{</span>
<a href="#l11.1381"></a><span id="l11.1381" class="difflineplus">+NS_IMETHODIMP nsImapUrl::SetMimePartSelectorDetected(</span>
<a href="#l11.1382"></a><span id="l11.1382" class="difflineplus">+    bool mimePartSelectorDetected) {</span>
<a href="#l11.1383"></a><span id="l11.1383">   m_mimePartSelectorDetected = mimePartSelectorDetected;</span>
<a href="#l11.1384"></a><span id="l11.1384">   return NS_OK;</span>
<a href="#l11.1385"></a><span id="l11.1385"> }</span>
<a href="#l11.1386"></a><span id="l11.1386"> </span>
<a href="#l11.1387"></a><span id="l11.1387" class="difflineminus">-NS_IMETHODIMP nsImapUrl::GetMimePartSelectorDetected(bool *mimePartSelectorDetected)</span>
<a href="#l11.1388"></a><span id="l11.1388" class="difflineminus">-{</span>
<a href="#l11.1389"></a><span id="l11.1389" class="difflineplus">+NS_IMETHODIMP nsImapUrl::GetMimePartSelectorDetected(</span>
<a href="#l11.1390"></a><span id="l11.1390" class="difflineplus">+    bool *mimePartSelectorDetected) {</span>
<a href="#l11.1391"></a><span id="l11.1391">   if (!mimePartSelectorDetected) return NS_ERROR_NULL_POINTER;</span>
<a href="#l11.1392"></a><span id="l11.1392"> </span>
<a href="#l11.1393"></a><span id="l11.1393">   *mimePartSelectorDetected = m_mimePartSelectorDetected;</span>
<a href="#l11.1394"></a><span id="l11.1394">   return NS_OK;</span>
<a href="#l11.1395"></a><span id="l11.1395"> }</span>
<a href="#l11.1396"></a><span id="l11.1396"> </span>
<a href="#l11.1397"></a><span id="l11.1397" class="difflineminus">-</span>
<a href="#l11.1398"></a><span id="l11.1398"> // this method is only called from the UI thread.</span>
<a href="#l11.1399"></a><span id="l11.1399" class="difflineminus">-NS_IMETHODIMP nsImapUrl::SetCopyState(nsISupports* copyState)</span>
<a href="#l11.1400"></a><span id="l11.1400" class="difflineminus">-{</span>
<a href="#l11.1401"></a><span id="l11.1401" class="difflineminus">-  MutexAutoLock  mon(mLock);</span>
<a href="#l11.1402"></a><span id="l11.1402" class="difflineplus">+NS_IMETHODIMP nsImapUrl::SetCopyState(nsISupports *copyState) {</span>
<a href="#l11.1403"></a><span id="l11.1403" class="difflineplus">+  MutexAutoLock mon(mLock);</span>
<a href="#l11.1404"></a><span id="l11.1404">   m_copyState = copyState;</span>
<a href="#l11.1405"></a><span id="l11.1405">   return NS_OK;</span>
<a href="#l11.1406"></a><span id="l11.1406"> }</span>
<a href="#l11.1407"></a><span id="l11.1407"> </span>
<a href="#l11.1408"></a><span id="l11.1408" class="difflineminus">-//this method is only called from the imap thread..but we still</span>
<a href="#l11.1409"></a><span id="l11.1409" class="difflineplus">+// this method is only called from the imap thread..but we still</span>
<a href="#l11.1410"></a><span id="l11.1410"> // need a monitor 'cause the setter is called from the UI thread.</span>
<a href="#l11.1411"></a><span id="l11.1411" class="difflineminus">-NS_IMETHODIMP nsImapUrl::GetCopyState(nsISupports** copyState)</span>
<a href="#l11.1412"></a><span id="l11.1412" class="difflineminus">-{</span>
<a href="#l11.1413"></a><span id="l11.1413" class="difflineplus">+NS_IMETHODIMP nsImapUrl::GetCopyState(nsISupports **copyState) {</span>
<a href="#l11.1414"></a><span id="l11.1414">   NS_ENSURE_ARG_POINTER(copyState);</span>
<a href="#l11.1415"></a><span id="l11.1415">   MutexAutoLock mon(mLock);</span>
<a href="#l11.1416"></a><span id="l11.1416">   NS_IF_ADDREF(*copyState = m_copyState);</span>
<a href="#l11.1417"></a><span id="l11.1417"> </span>
<a href="#l11.1418"></a><span id="l11.1418">   return NS_OK;</span>
<a href="#l11.1419"></a><span id="l11.1419"> }</span>
<a href="#l11.1420"></a><span id="l11.1420"> </span>
<a href="#l11.1421"></a><span id="l11.1421"> NS_IMETHODIMP</span>
<a href="#l11.1422"></a><span id="l11.1422" class="difflineminus">-nsImapUrl::SetMsgFile(nsIFile* aFile)</span>
<a href="#l11.1423"></a><span id="l11.1423" class="difflineminus">-{</span>
<a href="#l11.1424"></a><span id="l11.1424" class="difflineplus">+nsImapUrl::SetMsgFile(nsIFile *aFile) {</span>
<a href="#l11.1425"></a><span id="l11.1425">   nsresult rv = NS_OK;</span>
<a href="#l11.1426"></a><span id="l11.1426">   MutexAutoLock mon(mLock);</span>
<a href="#l11.1427"></a><span id="l11.1427">   m_file = aFile;</span>
<a href="#l11.1428"></a><span id="l11.1428">   return rv;</span>
<a href="#l11.1429"></a><span id="l11.1429"> }</span>
<a href="#l11.1430"></a><span id="l11.1430"> </span>
<a href="#l11.1431"></a><span id="l11.1431"> NS_IMETHODIMP</span>
<a href="#l11.1432"></a><span id="l11.1432" class="difflineminus">-nsImapUrl::GetMsgFile(nsIFile** aFile)</span>
<a href="#l11.1433"></a><span id="l11.1433" class="difflineminus">-{</span>
<a href="#l11.1434"></a><span id="l11.1434" class="difflineplus">+nsImapUrl::GetMsgFile(nsIFile **aFile) {</span>
<a href="#l11.1435"></a><span id="l11.1435">   NS_ENSURE_ARG_POINTER(aFile);</span>
<a href="#l11.1436"></a><span id="l11.1436"> </span>
<a href="#l11.1437"></a><span id="l11.1437">   MutexAutoLock mon(mLock);</span>
<a href="#l11.1438"></a><span id="l11.1438">   NS_IF_ADDREF(*aFile = m_file);</span>
<a href="#l11.1439"></a><span id="l11.1439">   return NS_OK;</span>
<a href="#l11.1440"></a><span id="l11.1440"> }</span>
<a href="#l11.1441"></a><span id="l11.1441"> </span>
<a href="#l11.1442"></a><span id="l11.1442"> // this method is called from the UI thread..</span>
<a href="#l11.1443"></a><span id="l11.1443" class="difflineminus">-NS_IMETHODIMP nsImapUrl::GetMockChannel(nsIImapMockChannel ** aChannel)</span>
<a href="#l11.1444"></a><span id="l11.1444" class="difflineminus">-{</span>
<a href="#l11.1445"></a><span id="l11.1445" class="difflineplus">+NS_IMETHODIMP nsImapUrl::GetMockChannel(nsIImapMockChannel **aChannel) {</span>
<a href="#l11.1446"></a><span id="l11.1446">   NS_ENSURE_ARG_POINTER(aChannel);</span>
<a href="#l11.1447"></a><span id="l11.1447" class="difflineminus">-  NS_WARNING_ASSERTION(NS_IsMainThread(), &quot;should only access mock channel on ui thread&quot;);</span>
<a href="#l11.1448"></a><span id="l11.1448" class="difflineplus">+  NS_WARNING_ASSERTION(NS_IsMainThread(),</span>
<a href="#l11.1449"></a><span id="l11.1449" class="difflineplus">+                       &quot;should only access mock channel on ui thread&quot;);</span>
<a href="#l11.1450"></a><span id="l11.1450">   *aChannel = nullptr;</span>
<a href="#l11.1451"></a><span id="l11.1451">   nsCOMPtr&lt;nsIImapMockChannel&gt; channel(do_QueryReferent(m_channelWeakPtr));</span>
<a href="#l11.1452"></a><span id="l11.1452">   channel.forget(aChannel);</span>
<a href="#l11.1453"></a><span id="l11.1453">   return *aChannel ? NS_OK : NS_ERROR_FAILURE;</span>
<a href="#l11.1454"></a><span id="l11.1454"> }</span>
<a href="#l11.1455"></a><span id="l11.1455"> </span>
<a href="#l11.1456"></a><span id="l11.1456" class="difflineminus">-NS_IMETHODIMP nsImapUrl::SetMockChannel(nsIImapMockChannel * aChannel)</span>
<a href="#l11.1457"></a><span id="l11.1457" class="difflineminus">-{</span>
<a href="#l11.1458"></a><span id="l11.1458" class="difflineminus">-  NS_WARNING_ASSERTION(NS_IsMainThread(), &quot;should only access mock channel on ui thread&quot;);</span>
<a href="#l11.1459"></a><span id="l11.1459" class="difflineplus">+NS_IMETHODIMP nsImapUrl::SetMockChannel(nsIImapMockChannel *aChannel) {</span>
<a href="#l11.1460"></a><span id="l11.1460" class="difflineplus">+  NS_WARNING_ASSERTION(NS_IsMainThread(),</span>
<a href="#l11.1461"></a><span id="l11.1461" class="difflineplus">+                       &quot;should only access mock channel on ui thread&quot;);</span>
<a href="#l11.1462"></a><span id="l11.1462">   m_channelWeakPtr = do_GetWeakReference(aChannel);</span>
<a href="#l11.1463"></a><span id="l11.1463">   return NS_OK;</span>
<a href="#l11.1464"></a><span id="l11.1464"> }</span>
<a href="#l11.1465"></a><span id="l11.1465"> </span>
<a href="#l11.1466"></a><span id="l11.1466" class="difflineminus">-NS_IMETHODIMP nsImapUrl::GetAllowContentChange(bool *result)</span>
<a href="#l11.1467"></a><span id="l11.1467" class="difflineminus">-{</span>
<a href="#l11.1468"></a><span id="l11.1468" class="difflineplus">+NS_IMETHODIMP nsImapUrl::GetAllowContentChange(bool *result) {</span>
<a href="#l11.1469"></a><span id="l11.1469">   NS_ENSURE_ARG_POINTER(result);</span>
<a href="#l11.1470"></a><span id="l11.1470">   *result = m_allowContentChange;</span>
<a href="#l11.1471"></a><span id="l11.1471">   return NS_OK;</span>
<a href="#l11.1472"></a><span id="l11.1472"> }</span>
<a href="#l11.1473"></a><span id="l11.1473"> </span>
<a href="#l11.1474"></a><span id="l11.1474" class="difflineminus">-nsresult nsImapUrl::Clone(nsIURI** _retval)</span>
<a href="#l11.1475"></a><span id="l11.1475" class="difflineminus">-{</span>
<a href="#l11.1476"></a><span id="l11.1476" class="difflineplus">+nsresult nsImapUrl::Clone(nsIURI **_retval) {</span>
<a href="#l11.1477"></a><span id="l11.1477">   nsresult rv = nsMsgMailNewsUrl::Clone(_retval);</span>
<a href="#l11.1478"></a><span id="l11.1478">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.1479"></a><span id="l11.1479">   // also clone the mURI member, because GetUri below won't work if</span>
<a href="#l11.1480"></a><span id="l11.1480">   // mURI isn't set due to escaping issues.</span>
<a href="#l11.1481"></a><span id="l11.1481" class="difflineminus">-  nsCOMPtr &lt;nsIMsgMessageUrl&gt; clonedUrl = do_QueryInterface(*_retval);</span>
<a href="#l11.1482"></a><span id="l11.1482" class="difflineminus">-  if (clonedUrl)</span>
<a href="#l11.1483"></a><span id="l11.1483" class="difflineminus">-    clonedUrl-&gt;SetUri(mURI.get());</span>
<a href="#l11.1484"></a><span id="l11.1484" class="difflineplus">+  nsCOMPtr&lt;nsIMsgMessageUrl&gt; clonedUrl = do_QueryInterface(*_retval);</span>
<a href="#l11.1485"></a><span id="l11.1485" class="difflineplus">+  if (clonedUrl) clonedUrl-&gt;SetUri(mURI.get());</span>
<a href="#l11.1486"></a><span id="l11.1486">   return rv;</span>
<a href="#l11.1487"></a><span id="l11.1487"> }</span>
<a href="#l11.1488"></a><span id="l11.1488"> </span>
<a href="#l11.1489"></a><span id="l11.1489" class="difflineminus">-NS_IMETHODIMP nsImapUrl::GetNormalizedSpec(nsACString&amp; aPrincipalSpec)</span>
<a href="#l11.1490"></a><span id="l11.1490" class="difflineminus">-{</span>
<a href="#l11.1491"></a><span id="l11.1491" class="difflineplus">+NS_IMETHODIMP nsImapUrl::GetNormalizedSpec(nsACString &amp;aPrincipalSpec) {</span>
<a href="#l11.1492"></a><span id="l11.1492">   // URLs look like this:</span>
<a href="#l11.1493"></a><span id="l11.1493">   // imap://user@domain@server:port/fetch&gt;UID&gt;folder&gt;nn</span>
<a href="#l11.1494"></a><span id="l11.1494">   // We simply strip any query part beginning with ? &amp; or /;</span>
<a href="#l11.1495"></a><span id="l11.1495">   // Normalized spec: imap://user@domain@server:port/fetch&gt;UID&gt;folder&gt;nn</span>
<a href="#l11.1496"></a><span id="l11.1496">   nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsURL;</span>
<a href="#l11.1497"></a><span id="l11.1497">   QueryInterface(NS_GET_IID(nsIMsgMailNewsUrl), getter_AddRefs(mailnewsURL));</span>
<a href="#l11.1498"></a><span id="l11.1498"> </span>
<a href="#l11.1499"></a><span id="l11.1499">   nsAutoCString spec;</span>
<a href="#l11.1500"></a><span id="l11.1500">   mailnewsURL-&gt;GetSpecIgnoringRef(spec);</span>
<a href="#l11.1501"></a><span id="l11.1501"> </span>
<a href="#l11.1502"></a><span id="l11.1502">   // Strip any query part beginning with ? or /;</span>
<a href="#l11.1503"></a><span id="l11.1503">   int32_t ind = spec.Find(&quot;/;&quot;);</span>
<a href="#l11.1504"></a><span id="l11.1504" class="difflineminus">-  if (ind != kNotFound)</span>
<a href="#l11.1505"></a><span id="l11.1505" class="difflineminus">-    spec.SetLength(ind);</span>
<a href="#l11.1506"></a><span id="l11.1506" class="difflineplus">+  if (ind != kNotFound) spec.SetLength(ind);</span>
<a href="#l11.1507"></a><span id="l11.1507"> </span>
<a href="#l11.1508"></a><span id="l11.1508">   ind = spec.FindChar('?');</span>
<a href="#l11.1509"></a><span id="l11.1509" class="difflineminus">-  if (ind != kNotFound)</span>
<a href="#l11.1510"></a><span id="l11.1510" class="difflineminus">-    spec.SetLength(ind);</span>
<a href="#l11.1511"></a><span id="l11.1511" class="difflineplus">+  if (ind != kNotFound) spec.SetLength(ind);</span>
<a href="#l11.1512"></a><span id="l11.1512"> </span>
<a href="#l11.1513"></a><span id="l11.1513">   aPrincipalSpec.Assign(spec);</span>
<a href="#l11.1514"></a><span id="l11.1514">   return NS_OK;</span>
<a href="#l11.1515"></a><span id="l11.1515"> }</span>
<a href="#l11.1516"></a><span id="l11.1516"> </span>
<a href="#l11.1517"></a><span id="l11.1517" class="difflineminus">-NS_IMETHODIMP nsImapUrl::SetUri(const char * aURI)</span>
<a href="#l11.1518"></a><span id="l11.1518" class="difflineminus">-{</span>
<a href="#l11.1519"></a><span id="l11.1519" class="difflineminus">-  mURI= aURI;</span>
<a href="#l11.1520"></a><span id="l11.1520" class="difflineplus">+NS_IMETHODIMP nsImapUrl::SetUri(const char *aURI) {</span>
<a href="#l11.1521"></a><span id="l11.1521" class="difflineplus">+  mURI = aURI;</span>
<a href="#l11.1522"></a><span id="l11.1522">   return NS_OK;</span>
<a href="#l11.1523"></a><span id="l11.1523"> }</span>
<a href="#l11.1524"></a><span id="l11.1524"> </span>
<a href="#l11.1525"></a><span id="l11.1525" class="difflineminus">-NS_IMETHODIMP nsImapUrl::GetUri(char** aURI)</span>
<a href="#l11.1526"></a><span id="l11.1526" class="difflineminus">-{</span>
<a href="#l11.1527"></a><span id="l11.1527" class="difflineplus">+NS_IMETHODIMP nsImapUrl::GetUri(char **aURI) {</span>
<a href="#l11.1528"></a><span id="l11.1528">   nsresult rv = NS_OK;</span>
<a href="#l11.1529"></a><span id="l11.1529">   if (!mURI.IsEmpty())</span>
<a href="#l11.1530"></a><span id="l11.1530">     *aURI = ToNewCString(mURI);</span>
<a href="#l11.1531"></a><span id="l11.1531" class="difflineminus">-  else</span>
<a href="#l11.1532"></a><span id="l11.1532" class="difflineminus">-  {</span>
<a href="#l11.1533"></a><span id="l11.1533" class="difflineplus">+  else {</span>
<a href="#l11.1534"></a><span id="l11.1534">     *aURI = nullptr;</span>
<a href="#l11.1535"></a><span id="l11.1535" class="difflineminus">-    uint32_t key = m_listOfMessageIds ? strtoul(m_listOfMessageIds, nullptr, 10) : 0;</span>
<a href="#l11.1536"></a><span id="l11.1536" class="difflineplus">+    uint32_t key =</span>
<a href="#l11.1537"></a><span id="l11.1537" class="difflineplus">+        m_listOfMessageIds ? strtoul(m_listOfMessageIds, nullptr, 10) : 0;</span>
<a href="#l11.1538"></a><span id="l11.1538">     nsCString canonicalPath;</span>
<a href="#l11.1539"></a><span id="l11.1539" class="difflineminus">-    AllocateCanonicalPath(m_sourceCanonicalFolderPathSubString, m_onlineSubDirSeparator, (getter_Copies(canonicalPath)));</span>
<a href="#l11.1540"></a><span id="l11.1540" class="difflineplus">+    AllocateCanonicalPath(m_sourceCanonicalFolderPathSubString,</span>
<a href="#l11.1541"></a><span id="l11.1541" class="difflineplus">+                          m_onlineSubDirSeparator,</span>
<a href="#l11.1542"></a><span id="l11.1542" class="difflineplus">+                          (getter_Copies(canonicalPath)));</span>
<a href="#l11.1543"></a><span id="l11.1543">     nsCString fullFolderPath(&quot;/&quot;);</span>
<a href="#l11.1544"></a><span id="l11.1544">     fullFolderPath.Append(m_userName);</span>
<a href="#l11.1545"></a><span id="l11.1545">     nsAutoCString hostName;</span>
<a href="#l11.1546"></a><span id="l11.1546">     rv = GetHost(hostName);</span>
<a href="#l11.1547"></a><span id="l11.1547">     fullFolderPath.Append('@');</span>
<a href="#l11.1548"></a><span id="l11.1548">     fullFolderPath.Append(hostName);</span>
<a href="#l11.1549"></a><span id="l11.1549">     fullFolderPath.Append('/');</span>
<a href="#l11.1550"></a><span id="l11.1550">     fullFolderPath.Append(canonicalPath);</span>
<a href="#l11.1551"></a><span id="l11.1551" class="difflineat">@@ -1236,322 +1068,302 @@ NS_IMETHODIMP nsImapUrl::GetUri(char** a</span>
<a href="#l11.1552"></a><span id="l11.1552">     rv = nsBuildImapMessageURI(baseMessageURI.get(), key, uriStr);</span>
<a href="#l11.1553"></a><span id="l11.1553">     *aURI = ToNewCString(uriStr);</span>
<a href="#l11.1554"></a><span id="l11.1554">   }</span>
<a href="#l11.1555"></a><span id="l11.1555">   return rv;</span>
<a href="#l11.1556"></a><span id="l11.1556"> }</span>
<a href="#l11.1557"></a><span id="l11.1557"> </span>
<a href="#l11.1558"></a><span id="l11.1558"> NS_IMPL_GETSET(nsImapUrl, AddDummyEnvelope, bool, m_addDummyEnvelope)</span>
<a href="#l11.1559"></a><span id="l11.1559"> NS_IMPL_GETSET(nsImapUrl, CanonicalLineEnding, bool, m_canonicalLineEnding)</span>
<a href="#l11.1560"></a><span id="l11.1560" class="difflineminus">-NS_IMETHODIMP nsImapUrl::GetMsgLoadingFromCache(bool *result)</span>
<a href="#l11.1561"></a><span id="l11.1561" class="difflineminus">-{</span>
<a href="#l11.1562"></a><span id="l11.1562" class="difflineplus">+NS_IMETHODIMP nsImapUrl::GetMsgLoadingFromCache(bool *result) {</span>
<a href="#l11.1563"></a><span id="l11.1563">   NS_ENSURE_ARG_POINTER(result);</span>
<a href="#l11.1564"></a><span id="l11.1564">   *result = m_msgLoadingFromCache;</span>
<a href="#l11.1565"></a><span id="l11.1565">   return NS_OK;</span>
<a href="#l11.1566"></a><span id="l11.1566"> }</span>
<a href="#l11.1567"></a><span id="l11.1567"> NS_IMPL_GETSET(nsImapUrl, LocalFetchOnly, bool, m_localFetchOnly)</span>
<a href="#l11.1568"></a><span id="l11.1568"> NS_IMPL_GETSET(nsImapUrl, ExternalLinkUrl, bool, m_externalLinkUrl)</span>
<a href="#l11.1569"></a><span id="l11.1569"> NS_IMPL_GETSET(nsImapUrl, RerunningUrl, bool, m_rerunningUrl)</span>
<a href="#l11.1570"></a><span id="l11.1570"> NS_IMPL_GETSET(nsImapUrl, ValidUrl, bool, m_validUrl)</span>
<a href="#l11.1571"></a><span id="l11.1571"> NS_IMPL_GETSET(nsImapUrl, MoreHeadersToDownload, bool, m_moreHeadersToDownload)</span>
<a href="#l11.1572"></a><span id="l11.1572"> </span>
<a href="#l11.1573"></a><span id="l11.1573" class="difflineminus">-NS_IMETHODIMP nsImapUrl::SetMsgLoadingFromCache(bool loadingFromCache)</span>
<a href="#l11.1574"></a><span id="l11.1574" class="difflineminus">-{</span>
<a href="#l11.1575"></a><span id="l11.1575" class="difflineplus">+NS_IMETHODIMP nsImapUrl::SetMsgLoadingFromCache(bool loadingFromCache) {</span>
<a href="#l11.1576"></a><span id="l11.1576">   nsresult rv = NS_OK;</span>
<a href="#l11.1577"></a><span id="l11.1577">   m_msgLoadingFromCache = loadingFromCache;</span>
<a href="#l11.1578"></a><span id="l11.1578">   return rv;</span>
<a href="#l11.1579"></a><span id="l11.1579"> }</span>
<a href="#l11.1580"></a><span id="l11.1580"> </span>
<a href="#l11.1581"></a><span id="l11.1581" class="difflineminus">-NS_IMETHODIMP nsImapUrl::SetMessageFile(nsIFile * aFile)</span>
<a href="#l11.1582"></a><span id="l11.1582" class="difflineminus">-{</span>
<a href="#l11.1583"></a><span id="l11.1583" class="difflineplus">+NS_IMETHODIMP nsImapUrl::SetMessageFile(nsIFile *aFile) {</span>
<a href="#l11.1584"></a><span id="l11.1584">   m_messageFile = aFile;</span>
<a href="#l11.1585"></a><span id="l11.1585">   return NS_OK;</span>
<a href="#l11.1586"></a><span id="l11.1586"> }</span>
<a href="#l11.1587"></a><span id="l11.1587"> </span>
<a href="#l11.1588"></a><span id="l11.1588" class="difflineminus">-NS_IMETHODIMP nsImapUrl::GetMessageFile(nsIFile ** aFile)</span>
<a href="#l11.1589"></a><span id="l11.1589" class="difflineminus">-{</span>
<a href="#l11.1590"></a><span id="l11.1590" class="difflineminus">-  if (aFile)</span>
<a href="#l11.1591"></a><span id="l11.1591" class="difflineminus">-    NS_IF_ADDREF(*aFile = m_messageFile);</span>
<a href="#l11.1592"></a><span id="l11.1592" class="difflineplus">+NS_IMETHODIMP nsImapUrl::GetMessageFile(nsIFile **aFile) {</span>
<a href="#l11.1593"></a><span id="l11.1593" class="difflineplus">+  if (aFile) NS_IF_ADDREF(*aFile = m_messageFile);</span>
<a href="#l11.1594"></a><span id="l11.1594">   return NS_OK;</span>
<a href="#l11.1595"></a><span id="l11.1595"> }</span>
<a href="#l11.1596"></a><span id="l11.1596"> </span>
<a href="#l11.1597"></a><span id="l11.1597" class="difflineminus">-NS_IMETHODIMP nsImapUrl::IsUrlType(uint32_t type, bool *isType)</span>
<a href="#l11.1598"></a><span id="l11.1598" class="difflineminus">-{</span>
<a href="#l11.1599"></a><span id="l11.1599" class="difflineplus">+NS_IMETHODIMP nsImapUrl::IsUrlType(uint32_t type, bool *isType) {</span>
<a href="#l11.1600"></a><span id="l11.1600">   NS_ENSURE_ARG(isType);</span>
<a href="#l11.1601"></a><span id="l11.1601"> </span>
<a href="#l11.1602"></a><span id="l11.1602" class="difflineminus">-  switch(type)</span>
<a href="#l11.1603"></a><span id="l11.1603" class="difflineminus">-  {</span>
<a href="#l11.1604"></a><span id="l11.1604" class="difflineplus">+  switch (type) {</span>
<a href="#l11.1605"></a><span id="l11.1605">     case nsIMsgMailNewsUrl::eCopy:</span>
<a href="#l11.1606"></a><span id="l11.1606">       *isType = ((m_imapAction == nsIImapUrl::nsImapOnlineCopy) ||</span>
<a href="#l11.1607"></a><span id="l11.1607" class="difflineminus">-        (m_imapAction == nsIImapUrl::nsImapOnlineToOfflineCopy) ||</span>
<a href="#l11.1608"></a><span id="l11.1608" class="difflineminus">-        (m_imapAction == nsIImapUrl::nsImapOfflineToOnlineCopy));</span>
<a href="#l11.1609"></a><span id="l11.1609" class="difflineplus">+                 (m_imapAction == nsIImapUrl::nsImapOnlineToOfflineCopy) ||</span>
<a href="#l11.1610"></a><span id="l11.1610" class="difflineplus">+                 (m_imapAction == nsIImapUrl::nsImapOfflineToOnlineCopy));</span>
<a href="#l11.1611"></a><span id="l11.1611">       break;</span>
<a href="#l11.1612"></a><span id="l11.1612">     case nsIMsgMailNewsUrl::eMove:</span>
<a href="#l11.1613"></a><span id="l11.1613">       *isType = ((m_imapAction == nsIImapUrl::nsImapOnlineMove) ||</span>
<a href="#l11.1614"></a><span id="l11.1614" class="difflineminus">-        (m_imapAction == nsIImapUrl::nsImapOnlineToOfflineMove) ||</span>
<a href="#l11.1615"></a><span id="l11.1615" class="difflineminus">-        (m_imapAction == nsIImapUrl::nsImapOfflineToOnlineMove));</span>
<a href="#l11.1616"></a><span id="l11.1616" class="difflineplus">+                 (m_imapAction == nsIImapUrl::nsImapOnlineToOfflineMove) ||</span>
<a href="#l11.1617"></a><span id="l11.1617" class="difflineplus">+                 (m_imapAction == nsIImapUrl::nsImapOfflineToOnlineMove));</span>
<a href="#l11.1618"></a><span id="l11.1618">       break;</span>
<a href="#l11.1619"></a><span id="l11.1619">     case nsIMsgMailNewsUrl::eDisplay:</span>
<a href="#l11.1620"></a><span id="l11.1620">       *isType = (m_imapAction == nsIImapUrl::nsImapMsgFetch ||</span>
<a href="#l11.1621"></a><span id="l11.1621" class="difflineminus">-        m_imapAction == nsIImapUrl::nsImapMsgFetchPeek);</span>
<a href="#l11.1622"></a><span id="l11.1622" class="difflineplus">+                 m_imapAction == nsIImapUrl::nsImapMsgFetchPeek);</span>
<a href="#l11.1623"></a><span id="l11.1623">       break;</span>
<a href="#l11.1624"></a><span id="l11.1624">     default:</span>
<a href="#l11.1625"></a><span id="l11.1625">       *isType = false;</span>
<a href="#l11.1626"></a><span id="l11.1626">   };</span>
<a href="#l11.1627"></a><span id="l11.1627"> </span>
<a href="#l11.1628"></a><span id="l11.1628">   return NS_OK;</span>
<a href="#l11.1629"></a><span id="l11.1629" class="difflineminus">-</span>
<a href="#l11.1630"></a><span id="l11.1630" class="difflineminus">-}</span>
<a href="#l11.1631"></a><span id="l11.1631" class="difflineminus">-</span>
<a href="#l11.1632"></a><span id="l11.1632" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l11.1633"></a><span id="l11.1633" class="difflineminus">-nsImapUrl::GetOriginalSpec(char ** aSpec)</span>
<a href="#l11.1634"></a><span id="l11.1634" class="difflineminus">-{</span>
<a href="#l11.1635"></a><span id="l11.1635" class="difflineminus">-    return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l11.1636"></a><span id="l11.1636"> }</span>
<a href="#l11.1637"></a><span id="l11.1637"> </span>
<a href="#l11.1638"></a><span id="l11.1638"> NS_IMETHODIMP</span>
<a href="#l11.1639"></a><span id="l11.1639" class="difflineminus">-nsImapUrl::SetOriginalSpec(const char *aSpec)</span>
<a href="#l11.1640"></a><span id="l11.1640" class="difflineminus">-{</span>
<a href="#l11.1641"></a><span id="l11.1641" class="difflineminus">-    return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l11.1642"></a><span id="l11.1642" class="difflineplus">+nsImapUrl::GetOriginalSpec(char **aSpec) { return NS_ERROR_NOT_IMPLEMENTED; }</span>
<a href="#l11.1643"></a><span id="l11.1643" class="difflineplus">+</span>
<a href="#l11.1644"></a><span id="l11.1644" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l11.1645"></a><span id="l11.1645" class="difflineplus">+nsImapUrl::SetOriginalSpec(const char *aSpec) {</span>
<a href="#l11.1646"></a><span id="l11.1646" class="difflineplus">+  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l11.1647"></a><span id="l11.1647"> }</span>
<a href="#l11.1648"></a><span id="l11.1648"> </span>
<a href="#l11.1649"></a><span id="l11.1649" class="difflineminus">-char *nsImapUrl::ReplaceCharsInCopiedString(const char *stringToCopy, char oldChar, char newChar)</span>
<a href="#l11.1650"></a><span id="l11.1650" class="difflineminus">-{</span>
<a href="#l11.1651"></a><span id="l11.1651" class="difflineplus">+char *nsImapUrl::ReplaceCharsInCopiedString(const char *stringToCopy,</span>
<a href="#l11.1652"></a><span id="l11.1652" class="difflineplus">+                                            char oldChar, char newChar) {</span>
<a href="#l11.1653"></a><span id="l11.1653">   char oldCharString[2];</span>
<a href="#l11.1654"></a><span id="l11.1654">   *oldCharString = oldChar;</span>
<a href="#l11.1655"></a><span id="l11.1655" class="difflineminus">-  *(oldCharString+1) = 0;</span>
<a href="#l11.1656"></a><span id="l11.1656" class="difflineplus">+  *(oldCharString + 1) = 0;</span>
<a href="#l11.1657"></a><span id="l11.1657"> </span>
<a href="#l11.1658"></a><span id="l11.1658">   char *translatedString = PL_strdup(stringToCopy);</span>
<a href="#l11.1659"></a><span id="l11.1659">   char *currentSeparator = PL_strstr(translatedString, oldCharString);</span>
<a href="#l11.1660"></a><span id="l11.1660"> </span>
<a href="#l11.1661"></a><span id="l11.1661" class="difflineminus">-  while(currentSeparator)</span>
<a href="#l11.1662"></a><span id="l11.1662" class="difflineminus">-  {</span>
<a href="#l11.1663"></a><span id="l11.1663" class="difflineplus">+  while (currentSeparator) {</span>
<a href="#l11.1664"></a><span id="l11.1664">     *currentSeparator = newChar;</span>
<a href="#l11.1665"></a><span id="l11.1665" class="difflineminus">-    currentSeparator = PL_strstr(currentSeparator+1, oldCharString);</span>
<a href="#l11.1666"></a><span id="l11.1666" class="difflineplus">+    currentSeparator = PL_strstr(currentSeparator + 1, oldCharString);</span>
<a href="#l11.1667"></a><span id="l11.1667">   }</span>
<a href="#l11.1668"></a><span id="l11.1668"> </span>
<a href="#l11.1669"></a><span id="l11.1669">   return translatedString;</span>
<a href="#l11.1670"></a><span id="l11.1670"> }</span>
<a href="#l11.1671"></a><span id="l11.1671"> </span>
<a href="#l11.1672"></a><span id="l11.1672" class="difflineminus">-</span>
<a href="#l11.1673"></a><span id="l11.1673"> ////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l11.1674"></a><span id="l11.1674"> // End of functions which should be made obsolete after modifying nsIURI</span>
<a href="#l11.1675"></a><span id="l11.1675"> ////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l11.1676"></a><span id="l11.1676"> </span>
<a href="#l11.1677"></a><span id="l11.1677" class="difflineminus">-void nsImapUrl::ParseFolderPath(char **resultingCanonicalPath)</span>
<a href="#l11.1678"></a><span id="l11.1678" class="difflineminus">-{</span>
<a href="#l11.1679"></a><span id="l11.1679" class="difflineminus">-  char *resultPath = m_tokenPlaceHolder ? NS_strtok(IMAP_URL_TOKEN_SEPARATOR, &amp;m_tokenPlaceHolder) : (char *)NULL;</span>
<a href="#l11.1680"></a><span id="l11.1680" class="difflineplus">+void nsImapUrl::ParseFolderPath(char **resultingCanonicalPath) {</span>
<a href="#l11.1681"></a><span id="l11.1681" class="difflineplus">+  char *resultPath = m_tokenPlaceHolder ? NS_strtok(IMAP_URL_TOKEN_SEPARATOR,</span>
<a href="#l11.1682"></a><span id="l11.1682" class="difflineplus">+                                                    &amp;m_tokenPlaceHolder)</span>
<a href="#l11.1683"></a><span id="l11.1683" class="difflineplus">+                                        : (char *)NULL;</span>
<a href="#l11.1684"></a><span id="l11.1684"> </span>
<a href="#l11.1685"></a><span id="l11.1685" class="difflineminus">-  if (!resultPath)</span>
<a href="#l11.1686"></a><span id="l11.1686" class="difflineminus">-  {</span>
<a href="#l11.1687"></a><span id="l11.1687" class="difflineplus">+  if (!resultPath) {</span>
<a href="#l11.1688"></a><span id="l11.1688">     m_validUrl = false;</span>
<a href="#l11.1689"></a><span id="l11.1689">     return;</span>
<a href="#l11.1690"></a><span id="l11.1690">   }</span>
<a href="#l11.1691"></a><span id="l11.1691">   NS_ASSERTION(*resultingCanonicalPath == nullptr, &quot;whoops, mem leak&quot;);</span>
<a href="#l11.1692"></a><span id="l11.1692"> </span>
<a href="#l11.1693"></a><span id="l11.1693">   char dirSeparator = *resultPath;</span>
<a href="#l11.1694"></a><span id="l11.1694"> </span>
<a href="#l11.1695"></a><span id="l11.1695">   nsCString unescapedResultingCanonicalPath;</span>
<a href="#l11.1696"></a><span id="l11.1696" class="difflineminus">-  MsgUnescapeString(nsDependentCString(resultPath + 1), 0, unescapedResultingCanonicalPath);</span>
<a href="#l11.1697"></a><span id="l11.1697" class="difflineplus">+  MsgUnescapeString(nsDependentCString(resultPath + 1), 0,</span>
<a href="#l11.1698"></a><span id="l11.1698" class="difflineplus">+                    unescapedResultingCanonicalPath);</span>
<a href="#l11.1699"></a><span id="l11.1699">   *resultingCanonicalPath = ToNewCString(unescapedResultingCanonicalPath);</span>
<a href="#l11.1700"></a><span id="l11.1700" class="difflineminus">-  // The delimiter will be set for a given URL, but will not be statically available</span>
<a href="#l11.1701"></a><span id="l11.1701" class="difflineminus">-  // from an arbitrary URL.  It is the creator's responsibility to fill in the correct</span>
<a href="#l11.1702"></a><span id="l11.1702" class="difflineminus">-  // delimiter from the folder's namespace when creating the URL.</span>
<a href="#l11.1703"></a><span id="l11.1703" class="difflineplus">+  // The delimiter will be set for a given URL, but will not be statically</span>
<a href="#l11.1704"></a><span id="l11.1704" class="difflineplus">+  // available from an arbitrary URL.  It is the creator's responsibility to</span>
<a href="#l11.1705"></a><span id="l11.1705" class="difflineplus">+  // fill in the correct delimiter from the folder's namespace when creating the</span>
<a href="#l11.1706"></a><span id="l11.1706" class="difflineplus">+  // URL.</span>
<a href="#l11.1707"></a><span id="l11.1707">   if (dirSeparator != kOnlineHierarchySeparatorUnknown)</span>
<a href="#l11.1708"></a><span id="l11.1708" class="difflineminus">-    SetOnlineSubDirSeparator( dirSeparator);</span>
<a href="#l11.1709"></a><span id="l11.1709" class="difflineplus">+    SetOnlineSubDirSeparator(dirSeparator);</span>
<a href="#l11.1710"></a><span id="l11.1710"> </span>
<a href="#l11.1711"></a><span id="l11.1711" class="difflineminus">-  // if dirSeparator == kOnlineHierarchySeparatorUnknown, then this must be a create</span>
<a href="#l11.1712"></a><span id="l11.1712" class="difflineminus">-  // of a top level imap box.  If there is an online subdir, we will automatically</span>
<a href="#l11.1713"></a><span id="l11.1713" class="difflineminus">-  // use its separator.  If there is not an online subdir, we don't need a separator.</span>
<a href="#l11.1714"></a><span id="l11.1714" class="difflineplus">+  // if dirSeparator == kOnlineHierarchySeparatorUnknown, then this must be a</span>
<a href="#l11.1715"></a><span id="l11.1715" class="difflineplus">+  // create of a top level imap box.  If there is an online subdir, we will</span>
<a href="#l11.1716"></a><span id="l11.1716" class="difflineplus">+  // automatically use its separator.  If there is not an online subdir, we</span>
<a href="#l11.1717"></a><span id="l11.1717" class="difflineplus">+  // don't need a separator.</span>
<a href="#l11.1718"></a><span id="l11.1718"> }</span>
<a href="#l11.1719"></a><span id="l11.1719"> </span>
<a href="#l11.1720"></a><span id="l11.1720" class="difflineminus">-void nsImapUrl::ParseSearchCriteriaString()</span>
<a href="#l11.1721"></a><span id="l11.1721" class="difflineminus">-{</span>
<a href="#l11.1722"></a><span id="l11.1722" class="difflineminus">-  if (m_tokenPlaceHolder)</span>
<a href="#l11.1723"></a><span id="l11.1723" class="difflineminus">-  {</span>
<a href="#l11.1724"></a><span id="l11.1724" class="difflineplus">+void nsImapUrl::ParseSearchCriteriaString() {</span>
<a href="#l11.1725"></a><span id="l11.1725" class="difflineplus">+  if (m_tokenPlaceHolder) {</span>
<a href="#l11.1726"></a><span id="l11.1726">     int quotedFlag = false;</span>
<a href="#l11.1727"></a><span id="l11.1727"> </span>
<a href="#l11.1728"></a><span id="l11.1728" class="difflineminus">-    //skip initial separator</span>
<a href="#l11.1729"></a><span id="l11.1729" class="difflineplus">+    // skip initial separator</span>
<a href="#l11.1730"></a><span id="l11.1730">     while (*m_tokenPlaceHolder == *IMAP_URL_TOKEN_SEPARATOR)</span>
<a href="#l11.1731"></a><span id="l11.1731">       m_tokenPlaceHolder++;</span>
<a href="#l11.1732"></a><span id="l11.1732"> </span>
<a href="#l11.1733"></a><span id="l11.1733" class="difflineminus">-     char *saveTokenPlaceHolder = m_tokenPlaceHolder;</span>
<a href="#l11.1734"></a><span id="l11.1734" class="difflineplus">+    char *saveTokenPlaceHolder = m_tokenPlaceHolder;</span>
<a href="#l11.1735"></a><span id="l11.1735"> </span>
<a href="#l11.1736"></a><span id="l11.1736" class="difflineminus">-//    m_searchCriteriaString = m_tokenPlaceHolder;</span>
<a href="#l11.1737"></a><span id="l11.1737" class="difflineplus">+    //    m_searchCriteriaString = m_tokenPlaceHolder;</span>
<a href="#l11.1738"></a><span id="l11.1738"> </span>
<a href="#l11.1739"></a><span id="l11.1739" class="difflineminus">-    //looking for another separator outside quoted string</span>
<a href="#l11.1740"></a><span id="l11.1740" class="difflineminus">-    while (*m_tokenPlaceHolder)</span>
<a href="#l11.1741"></a><span id="l11.1741" class="difflineminus">-    {</span>
<a href="#l11.1742"></a><span id="l11.1742" class="difflineminus">-      if (*m_tokenPlaceHolder == '\\' &amp;&amp; *(m_tokenPlaceHolder+1) == '&quot;')</span>
<a href="#l11.1743"></a><span id="l11.1743" class="difflineplus">+    // looking for another separator outside quoted string</span>
<a href="#l11.1744"></a><span id="l11.1744" class="difflineplus">+    while (*m_tokenPlaceHolder) {</span>
<a href="#l11.1745"></a><span id="l11.1745" class="difflineplus">+      if (*m_tokenPlaceHolder == '\\' &amp;&amp; *(m_tokenPlaceHolder + 1) == '&quot;')</span>
<a href="#l11.1746"></a><span id="l11.1746">         m_tokenPlaceHolder++;</span>
<a href="#l11.1747"></a><span id="l11.1747">       else if (*m_tokenPlaceHolder == '&quot;')</span>
<a href="#l11.1748"></a><span id="l11.1748">         quotedFlag = !quotedFlag;</span>
<a href="#l11.1749"></a><span id="l11.1749" class="difflineminus">-      else if (!quotedFlag &amp;&amp; *m_tokenPlaceHolder == *IMAP_URL_TOKEN_SEPARATOR)</span>
<a href="#l11.1750"></a><span id="l11.1750" class="difflineminus">-      {</span>
<a href="#l11.1751"></a><span id="l11.1751" class="difflineplus">+      else if (!quotedFlag &amp;&amp;</span>
<a href="#l11.1752"></a><span id="l11.1752" class="difflineplus">+               *m_tokenPlaceHolder == *IMAP_URL_TOKEN_SEPARATOR) {</span>
<a href="#l11.1753"></a><span id="l11.1753">         *m_tokenPlaceHolder = '\0';</span>
<a href="#l11.1754"></a><span id="l11.1754">         m_tokenPlaceHolder++;</span>
<a href="#l11.1755"></a><span id="l11.1755">         break;</span>
<a href="#l11.1756"></a><span id="l11.1756">       }</span>
<a href="#l11.1757"></a><span id="l11.1757">       m_tokenPlaceHolder++;</span>
<a href="#l11.1758"></a><span id="l11.1758">     }</span>
<a href="#l11.1759"></a><span id="l11.1759">     m_searchCriteriaString = PL_strdup(saveTokenPlaceHolder);</span>
<a href="#l11.1760"></a><span id="l11.1760" class="difflineminus">-    if (*m_tokenPlaceHolder == '\0')</span>
<a href="#l11.1761"></a><span id="l11.1761" class="difflineminus">-      m_tokenPlaceHolder = NULL;</span>
<a href="#l11.1762"></a><span id="l11.1762" class="difflineplus">+    if (*m_tokenPlaceHolder == '\0') m_tokenPlaceHolder = NULL;</span>
<a href="#l11.1763"></a><span id="l11.1763"> </span>
<a href="#l11.1764"></a><span id="l11.1764" class="difflineminus">-    if (*m_searchCriteriaString == '\0')</span>
<a href="#l11.1765"></a><span id="l11.1765" class="difflineminus">-      m_searchCriteriaString = (char *)NULL;</span>
<a href="#l11.1766"></a><span id="l11.1766" class="difflineminus">-  }</span>
<a href="#l11.1767"></a><span id="l11.1767" class="difflineminus">-  else</span>
<a href="#l11.1768"></a><span id="l11.1768" class="difflineplus">+    if (*m_searchCriteriaString == '\0') m_searchCriteriaString = (char *)NULL;</span>
<a href="#l11.1769"></a><span id="l11.1769" class="difflineplus">+  } else</span>
<a href="#l11.1770"></a><span id="l11.1770">     m_searchCriteriaString = (char *)NULL;</span>
<a href="#l11.1771"></a><span id="l11.1771" class="difflineminus">-  if (!m_searchCriteriaString)</span>
<a href="#l11.1772"></a><span id="l11.1772" class="difflineminus">-    m_validUrl = false;</span>
<a href="#l11.1773"></a><span id="l11.1773" class="difflineplus">+  if (!m_searchCriteriaString) m_validUrl = false;</span>
<a href="#l11.1774"></a><span id="l11.1774"> }</span>
<a href="#l11.1775"></a><span id="l11.1775"> </span>
<a href="#l11.1776"></a><span id="l11.1776" class="difflineminus">-</span>
<a href="#l11.1777"></a><span id="l11.1777" class="difflineminus">-void nsImapUrl::ParseUidChoice()</span>
<a href="#l11.1778"></a><span id="l11.1778" class="difflineminus">-{</span>
<a href="#l11.1779"></a><span id="l11.1779" class="difflineminus">-  char *uidChoiceString = m_tokenPlaceHolder ? NS_strtok(IMAP_URL_TOKEN_SEPARATOR, &amp;m_tokenPlaceHolder) : (char *)NULL;</span>
<a href="#l11.1780"></a><span id="l11.1780" class="difflineplus">+void nsImapUrl::ParseUidChoice() {</span>
<a href="#l11.1781"></a><span id="l11.1781" class="difflineplus">+  char *uidChoiceString =</span>
<a href="#l11.1782"></a><span id="l11.1782" class="difflineplus">+      m_tokenPlaceHolder</span>
<a href="#l11.1783"></a><span id="l11.1783" class="difflineplus">+          ? NS_strtok(IMAP_URL_TOKEN_SEPARATOR, &amp;m_tokenPlaceHolder)</span>
<a href="#l11.1784"></a><span id="l11.1784" class="difflineplus">+          : (char *)NULL;</span>
<a href="#l11.1785"></a><span id="l11.1785">   if (!uidChoiceString)</span>
<a href="#l11.1786"></a><span id="l11.1786">     m_validUrl = false;</span>
<a href="#l11.1787"></a><span id="l11.1787">   else</span>
<a href="#l11.1788"></a><span id="l11.1788">     m_idsAreUids = strcmp(uidChoiceString, &quot;UID&quot;) == 0;</span>
<a href="#l11.1789"></a><span id="l11.1789"> }</span>
<a href="#l11.1790"></a><span id="l11.1790"> </span>
<a href="#l11.1791"></a><span id="l11.1791" class="difflineminus">-void nsImapUrl::ParseMsgFlags()</span>
<a href="#l11.1792"></a><span id="l11.1792" class="difflineminus">-{</span>
<a href="#l11.1793"></a><span id="l11.1793" class="difflineminus">-  char *flagsPtr = m_tokenPlaceHolder ? NS_strtok(IMAP_URL_TOKEN_SEPARATOR, &amp;m_tokenPlaceHolder) : (char *)NULL;</span>
<a href="#l11.1794"></a><span id="l11.1794" class="difflineminus">-  if (flagsPtr)</span>
<a href="#l11.1795"></a><span id="l11.1795" class="difflineminus">-  {</span>
<a href="#l11.1796"></a><span id="l11.1796" class="difflineplus">+void nsImapUrl::ParseMsgFlags() {</span>
<a href="#l11.1797"></a><span id="l11.1797" class="difflineplus">+  char *flagsPtr = m_tokenPlaceHolder ? NS_strtok(IMAP_URL_TOKEN_SEPARATOR,</span>
<a href="#l11.1798"></a><span id="l11.1798" class="difflineplus">+                                                  &amp;m_tokenPlaceHolder)</span>
<a href="#l11.1799"></a><span id="l11.1799" class="difflineplus">+                                      : (char *)NULL;</span>
<a href="#l11.1800"></a><span id="l11.1800" class="difflineplus">+  if (flagsPtr) {</span>
<a href="#l11.1801"></a><span id="l11.1801">     // the url is encodes the flags byte as ascii</span>
<a href="#l11.1802"></a><span id="l11.1802">     int intFlags = atoi(flagsPtr);</span>
<a href="#l11.1803"></a><span id="l11.1803" class="difflineminus">-    m_flags = (imapMessageFlagsType) intFlags;  // cast here</span>
<a href="#l11.1804"></a><span id="l11.1804" class="difflineminus">-  }</span>
<a href="#l11.1805"></a><span id="l11.1805" class="difflineminus">-  else</span>
<a href="#l11.1806"></a><span id="l11.1806" class="difflineplus">+    m_flags = (imapMessageFlagsType)intFlags;  // cast here</span>
<a href="#l11.1807"></a><span id="l11.1807" class="difflineplus">+  } else</span>
<a href="#l11.1808"></a><span id="l11.1808">     m_flags = 0;</span>
<a href="#l11.1809"></a><span id="l11.1809"> }</span>
<a href="#l11.1810"></a><span id="l11.1810"> </span>
<a href="#l11.1811"></a><span id="l11.1811" class="difflineminus">-void nsImapUrl::ParseListOfMessageIds()</span>
<a href="#l11.1812"></a><span id="l11.1812" class="difflineminus">-{</span>
<a href="#l11.1813"></a><span id="l11.1813" class="difflineminus">-  m_listOfMessageIds = m_tokenPlaceHolder ? NS_strtok(IMAP_URL_TOKEN_SEPARATOR, &amp;m_tokenPlaceHolder) : (char *)NULL;</span>
<a href="#l11.1814"></a><span id="l11.1814" class="difflineplus">+void nsImapUrl::ParseListOfMessageIds() {</span>
<a href="#l11.1815"></a><span id="l11.1815" class="difflineplus">+  m_listOfMessageIds = m_tokenPlaceHolder ? NS_strtok(IMAP_URL_TOKEN_SEPARATOR,</span>
<a href="#l11.1816"></a><span id="l11.1816" class="difflineplus">+                                                      &amp;m_tokenPlaceHolder)</span>
<a href="#l11.1817"></a><span id="l11.1817" class="difflineplus">+                                          : (char *)NULL;</span>
<a href="#l11.1818"></a><span id="l11.1818">   if (!m_listOfMessageIds)</span>
<a href="#l11.1819"></a><span id="l11.1819">     m_validUrl = false;</span>
<a href="#l11.1820"></a><span id="l11.1820" class="difflineminus">-  else</span>
<a href="#l11.1821"></a><span id="l11.1821" class="difflineminus">-  {</span>
<a href="#l11.1822"></a><span id="l11.1822" class="difflineplus">+  else {</span>
<a href="#l11.1823"></a><span id="l11.1823">     m_listOfMessageIds = strdup(m_listOfMessageIds);</span>
<a href="#l11.1824"></a><span id="l11.1824" class="difflineminus">-    m_mimePartSelectorDetected = PL_strstr(m_listOfMessageIds, &quot;&amp;part=&quot;) != 0 || PL_strstr(m_listOfMessageIds, &quot;?part=&quot;) != 0;</span>
<a href="#l11.1825"></a><span id="l11.1825" class="difflineplus">+    m_mimePartSelectorDetected = PL_strstr(m_listOfMessageIds, &quot;&amp;part=&quot;) != 0 ||</span>
<a href="#l11.1826"></a><span id="l11.1826" class="difflineplus">+                                 PL_strstr(m_listOfMessageIds, &quot;?part=&quot;) != 0;</span>
<a href="#l11.1827"></a><span id="l11.1827"> </span>
<a href="#l11.1828"></a><span id="l11.1828">     // if we're asking for just the body, don't download the whole message. see</span>
<a href="#l11.1829"></a><span id="l11.1829" class="difflineminus">-    // nsMsgQuote::QuoteMessage() for the &quot;header=&quot; settings when replying to msgs.</span>
<a href="#l11.1830"></a><span id="l11.1830" class="difflineplus">+    // nsMsgQuote::QuoteMessage() for the &quot;header=&quot; settings when replying to</span>
<a href="#l11.1831"></a><span id="l11.1831" class="difflineplus">+    // msgs.</span>
<a href="#l11.1832"></a><span id="l11.1832">     if (!m_fetchPartsOnDemand)</span>
<a href="#l11.1833"></a><span id="l11.1833" class="difflineminus">-      m_fetchPartsOnDemand = (PL_strstr(m_listOfMessageIds, &quot;?header=quotebody&quot;) != 0 ||</span>
<a href="#l11.1834"></a><span id="l11.1834" class="difflineminus">-      PL_strstr(m_listOfMessageIds, &quot;?header=only&quot;) != 0);</span>
<a href="#l11.1835"></a><span id="l11.1835" class="difflineminus">-    // if it's a spam filter trying to fetch the msg, don't let it get marked read.</span>
<a href="#l11.1836"></a><span id="l11.1836" class="difflineminus">-    if (PL_strstr(m_listOfMessageIds,&quot;?header=filter&quot;) != 0)</span>
<a href="#l11.1837"></a><span id="l11.1837" class="difflineplus">+      m_fetchPartsOnDemand =</span>
<a href="#l11.1838"></a><span id="l11.1838" class="difflineplus">+          (PL_strstr(m_listOfMessageIds, &quot;?header=quotebody&quot;) != 0 ||</span>
<a href="#l11.1839"></a><span id="l11.1839" class="difflineplus">+           PL_strstr(m_listOfMessageIds, &quot;?header=only&quot;) != 0);</span>
<a href="#l11.1840"></a><span id="l11.1840" class="difflineplus">+    // if it's a spam filter trying to fetch the msg, don't let it get marked</span>
<a href="#l11.1841"></a><span id="l11.1841" class="difflineplus">+    // read.</span>
<a href="#l11.1842"></a><span id="l11.1842" class="difflineplus">+    if (PL_strstr(m_listOfMessageIds, &quot;?header=filter&quot;) != 0)</span>
<a href="#l11.1843"></a><span id="l11.1843">       m_imapAction = nsImapMsgFetchPeek;</span>
<a href="#l11.1844"></a><span id="l11.1844">   }</span>
<a href="#l11.1845"></a><span id="l11.1845"> }</span>
<a href="#l11.1846"></a><span id="l11.1846"> </span>
<a href="#l11.1847"></a><span id="l11.1847" class="difflineminus">-void nsImapUrl::ParseCustomMsgFetchAttribute()</span>
<a href="#l11.1848"></a><span id="l11.1848" class="difflineminus">-{</span>
<a href="#l11.1849"></a><span id="l11.1849" class="difflineminus">-  m_msgFetchAttribute = m_tokenPlaceHolder ? NS_strtok(IMAP_URL_TOKEN_SEPARATOR, &amp;m_tokenPlaceHolder) : (char *)nullptr;</span>
<a href="#l11.1850"></a><span id="l11.1850" class="difflineplus">+void nsImapUrl::ParseCustomMsgFetchAttribute() {</span>
<a href="#l11.1851"></a><span id="l11.1851" class="difflineplus">+  m_msgFetchAttribute = m_tokenPlaceHolder ? NS_strtok(IMAP_URL_TOKEN_SEPARATOR,</span>
<a href="#l11.1852"></a><span id="l11.1852" class="difflineplus">+                                                       &amp;m_tokenPlaceHolder)</span>
<a href="#l11.1853"></a><span id="l11.1853" class="difflineplus">+                                           : (char *)nullptr;</span>
<a href="#l11.1854"></a><span id="l11.1854"> }</span>
<a href="#l11.1855"></a><span id="l11.1855"> </span>
<a href="#l11.1856"></a><span id="l11.1856" class="difflineminus">-void nsImapUrl::ParseNumBytes()</span>
<a href="#l11.1857"></a><span id="l11.1857" class="difflineminus">-{</span>
<a href="#l11.1858"></a><span id="l11.1858" class="difflineminus">-  const char *numBytes = (m_tokenPlaceHolder) ? NS_strtok(IMAP_URL_TOKEN_SEPARATOR, &amp;m_tokenPlaceHolder) : 0;</span>
<a href="#l11.1859"></a><span id="l11.1859" class="difflineplus">+void nsImapUrl::ParseNumBytes() {</span>
<a href="#l11.1860"></a><span id="l11.1860" class="difflineplus">+  const char *numBytes =</span>
<a href="#l11.1861"></a><span id="l11.1861" class="difflineplus">+      (m_tokenPlaceHolder)</span>
<a href="#l11.1862"></a><span id="l11.1862" class="difflineplus">+          ? NS_strtok(IMAP_URL_TOKEN_SEPARATOR, &amp;m_tokenPlaceHolder)</span>
<a href="#l11.1863"></a><span id="l11.1863" class="difflineplus">+          : 0;</span>
<a href="#l11.1864"></a><span id="l11.1864">   m_numBytesToFetch = numBytes ? atoi(numBytes) : 0;</span>
<a href="#l11.1865"></a><span id="l11.1865"> }</span>
<a href="#l11.1866"></a><span id="l11.1866"> </span>
<a href="#l11.1867"></a><span id="l11.1867"> // nsIMsgI18NUrl support</span>
<a href="#l11.1868"></a><span id="l11.1868"> </span>
<a href="#l11.1869"></a><span id="l11.1869" class="difflineminus">-nsresult nsImapUrl::GetMsgFolder(nsIMsgFolder **msgFolder)</span>
<a href="#l11.1870"></a><span id="l11.1870" class="difflineminus">-{</span>
<a href="#l11.1871"></a><span id="l11.1871" class="difflineminus">-  // if we have a RDF URI, then try to get the folder for that URI and then ask the folder</span>
<a href="#l11.1872"></a><span id="l11.1872" class="difflineminus">-  // for it's charset....</span>
<a href="#l11.1873"></a><span id="l11.1873" class="difflineplus">+nsresult nsImapUrl::GetMsgFolder(nsIMsgFolder **msgFolder) {</span>
<a href="#l11.1874"></a><span id="l11.1874" class="difflineplus">+  // if we have a RDF URI, then try to get the folder for that URI and then ask</span>
<a href="#l11.1875"></a><span id="l11.1875" class="difflineplus">+  // the folder for it's charset....</span>
<a href="#l11.1876"></a><span id="l11.1876"> </span>
<a href="#l11.1877"></a><span id="l11.1877">   nsCString uri;</span>
<a href="#l11.1878"></a><span id="l11.1878">   GetUri(getter_Copies(uri));</span>
<a href="#l11.1879"></a><span id="l11.1879">   NS_ENSURE_TRUE(!uri.IsEmpty(), NS_ERROR_FAILURE);</span>
<a href="#l11.1880"></a><span id="l11.1880"> </span>
<a href="#l11.1881"></a><span id="l11.1881">   nsCOMPtr&lt;nsIMsgDBHdr&gt; msg;</span>
<a href="#l11.1882"></a><span id="l11.1882">   GetMsgDBHdrFromURI(uri.get(), getter_AddRefs(msg));</span>
<a href="#l11.1883"></a><span id="l11.1883">   NS_ENSURE_TRUE(msg, NS_ERROR_FAILURE);</span>
<a href="#l11.1884"></a><span id="l11.1884">   nsresult rv = msg-&gt;GetFolder(msgFolder);</span>
<a href="#l11.1885"></a><span id="l11.1885" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l11.1886"></a><span id="l11.1886" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.1887"></a><span id="l11.1887">   NS_ENSURE_TRUE(msgFolder, NS_ERROR_FAILURE);</span>
<a href="#l11.1888"></a><span id="l11.1888"> </span>
<a href="#l11.1889"></a><span id="l11.1889">   return NS_OK;</span>
<a href="#l11.1890"></a><span id="l11.1890"> }</span>
<a href="#l11.1891"></a><span id="l11.1891"> </span>
<a href="#l11.1892"></a><span id="l11.1892" class="difflineminus">-NS_IMETHODIMP nsImapUrl::GetFolderCharset(char ** aCharacterSet)</span>
<a href="#l11.1893"></a><span id="l11.1893" class="difflineminus">-{</span>
<a href="#l11.1894"></a><span id="l11.1894" class="difflineplus">+NS_IMETHODIMP nsImapUrl::GetFolderCharset(char **aCharacterSet) {</span>
<a href="#l11.1895"></a><span id="l11.1895">   nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l11.1896"></a><span id="l11.1896">   nsresult rv = GetMsgFolder(getter_AddRefs(folder));</span>
<a href="#l11.1897"></a><span id="l11.1897" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l11.1898"></a><span id="l11.1898" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.1899"></a><span id="l11.1899">   nsCString tmpStr;</span>
<a href="#l11.1900"></a><span id="l11.1900">   folder-&gt;GetCharset(tmpStr);</span>
<a href="#l11.1901"></a><span id="l11.1901">   *aCharacterSet = ToNewCString(tmpStr);</span>
<a href="#l11.1902"></a><span id="l11.1902">   return NS_OK;</span>
<a href="#l11.1903"></a><span id="l11.1903"> }</span>
<a href="#l11.1904"></a><span id="l11.1904"> </span>
<a href="#l11.1905"></a><span id="l11.1905" class="difflineminus">-NS_IMETHODIMP nsImapUrl::GetFolderCharsetOverride(bool * aCharacterSetOverride)</span>
<a href="#l11.1906"></a><span id="l11.1906" class="difflineminus">-{</span>
<a href="#l11.1907"></a><span id="l11.1907" class="difflineplus">+NS_IMETHODIMP nsImapUrl::GetFolderCharsetOverride(bool *aCharacterSetOverride) {</span>
<a href="#l11.1908"></a><span id="l11.1908">   nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l11.1909"></a><span id="l11.1909">   nsresult rv = GetMsgFolder(getter_AddRefs(folder));</span>
<a href="#l11.1910"></a><span id="l11.1910" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l11.1911"></a><span id="l11.1911" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.1912"></a><span id="l11.1912">   NS_ENSURE_TRUE(folder, NS_ERROR_FAILURE);</span>
<a href="#l11.1913"></a><span id="l11.1913">   folder-&gt;GetCharsetOverride(aCharacterSetOverride);</span>
<a href="#l11.1914"></a><span id="l11.1914">   return NS_OK;</span>
<a href="#l11.1915"></a><span id="l11.1915"> }</span>
<a href="#l11.1916"></a><span id="l11.1916"> </span>
<a href="#l11.1917"></a><span id="l11.1917" class="difflineminus">-NS_IMETHODIMP nsImapUrl::GetCharsetOverRide(char ** aCharacterSet)</span>
<a href="#l11.1918"></a><span id="l11.1918" class="difflineminus">-{</span>
<a href="#l11.1919"></a><span id="l11.1919" class="difflineplus">+NS_IMETHODIMP nsImapUrl::GetCharsetOverRide(char **aCharacterSet) {</span>
<a href="#l11.1920"></a><span id="l11.1920">   if (!mCharsetOverride.IsEmpty())</span>
<a href="#l11.1921"></a><span id="l11.1921">     *aCharacterSet = ToNewCString(mCharsetOverride);</span>
<a href="#l11.1922"></a><span id="l11.1922">   else</span>
<a href="#l11.1923"></a><span id="l11.1923">     *aCharacterSet = nullptr;</span>
<a href="#l11.1924"></a><span id="l11.1924">   return NS_OK;</span>
<a href="#l11.1925"></a><span id="l11.1925"> }</span>
<a href="#l11.1926"></a><span id="l11.1926"> </span>
<a href="#l11.1927"></a><span id="l11.1927" class="difflineminus">-NS_IMETHODIMP nsImapUrl::SetCharsetOverRide(const char * aCharacterSet)</span>
<a href="#l11.1928"></a><span id="l11.1928" class="difflineminus">-{</span>
<a href="#l11.1929"></a><span id="l11.1929" class="difflineplus">+NS_IMETHODIMP nsImapUrl::SetCharsetOverRide(const char *aCharacterSet) {</span>
<a href="#l11.1930"></a><span id="l11.1930">   mCharsetOverride = aCharacterSet;</span>
<a href="#l11.1931"></a><span id="l11.1931">   return NS_OK;</span>
<a href="#l11.1932"></a><span id="l11.1932"> }</span>
<a href="#l11.1933"></a><span id="l11.1933"> </span>
<a href="#l11.1934"></a><span id="l11.1934" class="difflineminus">-NS_IMETHODIMP nsImapUrl::GetStoreResultsOffline(bool *aStoreResultsOffline)</span>
<a href="#l11.1935"></a><span id="l11.1935" class="difflineminus">-{</span>
<a href="#l11.1936"></a><span id="l11.1936" class="difflineplus">+NS_IMETHODIMP nsImapUrl::GetStoreResultsOffline(bool *aStoreResultsOffline) {</span>
<a href="#l11.1937"></a><span id="l11.1937">   NS_ENSURE_ARG_POINTER(aStoreResultsOffline);</span>
<a href="#l11.1938"></a><span id="l11.1938">   *aStoreResultsOffline = m_storeResultsOffline;</span>
<a href="#l11.1939"></a><span id="l11.1939">   return NS_OK;</span>
<a href="#l11.1940"></a><span id="l11.1940"> }</span>
<a href="#l11.1941"></a><span id="l11.1941"> </span>
<a href="#l11.1942"></a><span id="l11.1942" class="difflineminus">-NS_IMETHODIMP nsImapUrl::SetStoreResultsOffline(bool aStoreResultsOffline)</span>
<a href="#l11.1943"></a><span id="l11.1943" class="difflineminus">-{</span>
<a href="#l11.1944"></a><span id="l11.1944" class="difflineplus">+NS_IMETHODIMP nsImapUrl::SetStoreResultsOffline(bool aStoreResultsOffline) {</span>
<a href="#l11.1945"></a><span id="l11.1945">   m_storeResultsOffline = aStoreResultsOffline;</span>
<a href="#l11.1946"></a><span id="l11.1946">   return NS_OK;</span>
<a href="#l11.1947"></a><span id="l11.1947"> }</span>
<a href="#l11.1948"></a><span id="l11.1948"> </span>
<a href="#l11.1949"></a><span id="l11.1949" class="difflineminus">-NS_IMETHODIMP nsImapUrl::GetStoreOfflineOnFallback(bool *aStoreOfflineOnFallback)</span>
<a href="#l11.1950"></a><span id="l11.1950" class="difflineminus">-{</span>
<a href="#l11.1951"></a><span id="l11.1951" class="difflineplus">+NS_IMETHODIMP nsImapUrl::GetStoreOfflineOnFallback(</span>
<a href="#l11.1952"></a><span id="l11.1952" class="difflineplus">+    bool *aStoreOfflineOnFallback) {</span>
<a href="#l11.1953"></a><span id="l11.1953">   NS_ENSURE_ARG_POINTER(aStoreOfflineOnFallback);</span>
<a href="#l11.1954"></a><span id="l11.1954">   *aStoreOfflineOnFallback = m_storeOfflineOnFallback;</span>
<a href="#l11.1955"></a><span id="l11.1955">   return NS_OK;</span>
<a href="#l11.1956"></a><span id="l11.1956"> }</span>
<a href="#l11.1957"></a><span id="l11.1957"> </span>
<a href="#l11.1958"></a><span id="l11.1958" class="difflineminus">-NS_IMETHODIMP nsImapUrl::SetStoreOfflineOnFallback(bool aStoreOfflineOnFallback)</span>
<a href="#l11.1959"></a><span id="l11.1959" class="difflineminus">-{</span>
<a href="#l11.1960"></a><span id="l11.1960" class="difflineplus">+NS_IMETHODIMP nsImapUrl::SetStoreOfflineOnFallback(</span>
<a href="#l11.1961"></a><span id="l11.1961" class="difflineplus">+    bool aStoreOfflineOnFallback) {</span>
<a href="#l11.1962"></a><span id="l11.1962">   m_storeOfflineOnFallback = aStoreOfflineOnFallback;</span>
<a href="#l11.1963"></a><span id="l11.1963">   return NS_OK;</span>
<a href="#l11.1964"></a><span id="l11.1964"> }</span>
<a href="#l11.1965"></a><span id="l11.1965"> </span>
<a href="#l11.1966"></a><span id="l11.1966" class="difflineminus">-NS_IMETHODIMP nsImapUrl::GetMessageHeader(nsIMsgDBHdr ** aMsgHdr)</span>
<a href="#l11.1967"></a><span id="l11.1967" class="difflineminus">-{</span>
<a href="#l11.1968"></a><span id="l11.1968" class="difflineplus">+NS_IMETHODIMP nsImapUrl::GetMessageHeader(nsIMsgDBHdr **aMsgHdr) {</span>
<a href="#l11.1969"></a><span id="l11.1969">   nsCString uri;</span>
<a href="#l11.1970"></a><span id="l11.1970">   nsresult rv = GetUri(getter_Copies(uri));</span>
<a href="#l11.1971"></a><span id="l11.1971">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.1972"></a><span id="l11.1972">   return GetMsgDBHdrFromURI(uri.get(), aMsgHdr);</span>
<a href="#l11.1973"></a><span id="l11.1973"> }</span>
<a href="#l11.1974"></a><span id="l11.1974"> </span>
<a href="#l11.1975"></a><span id="l11.1975" class="difflineminus">-NS_IMETHODIMP nsImapUrl::SetMessageHeader(nsIMsgDBHdr *aMsgHdr)</span>
<a href="#l11.1976"></a><span id="l11.1976" class="difflineminus">-{</span>
<a href="#l11.1977"></a><span id="l11.1977" class="difflineplus">+NS_IMETHODIMP nsImapUrl::SetMessageHeader(nsIMsgDBHdr *aMsgHdr) {</span>
<a href="#l11.1978"></a><span id="l11.1978">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l11.1979"></a><span id="l11.1979"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/imap/src/nsImapUrl.h</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapUrl.h</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -9,20 +9,21 @@</span>
<a href="#l12.4"></a><span id="l12.4"> #include &quot;mozilla/Attributes.h&quot;</span>
<a href="#l12.5"></a><span id="l12.5"> #include &quot;nsIImapUrl.h&quot;</span>
<a href="#l12.6"></a><span id="l12.6"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l12.7"></a><span id="l12.7"> #include &quot;nsMsgMailNewsUrl.h&quot;</span>
<a href="#l12.8"></a><span id="l12.8"> #include &quot;nsIWeakReferenceUtils.h&quot;</span>
<a href="#l12.9"></a><span id="l12.9"> #include &quot;nsIFile.h&quot;</span>
<a href="#l12.10"></a><span id="l12.10"> #include &quot;mozilla/Mutex.h&quot;</span>
<a href="#l12.11"></a><span id="l12.11"> </span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-class nsImapUrl : public nsIImapUrl, public nsMsgMailNewsUrl, public nsIMsgMessageUrl, public nsIMsgI18NUrl</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineminus">-{</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineminus">-public:</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineminus">-</span>
<a href="#l12.16"></a><span id="l12.16" class="difflineplus">+class nsImapUrl : public nsIImapUrl,</span>
<a href="#l12.17"></a><span id="l12.17" class="difflineplus">+                  public nsMsgMailNewsUrl,</span>
<a href="#l12.18"></a><span id="l12.18" class="difflineplus">+                  public nsIMsgMessageUrl,</span>
<a href="#l12.19"></a><span id="l12.19" class="difflineplus">+                  public nsIMsgI18NUrl {</span>
<a href="#l12.20"></a><span id="l12.20" class="difflineplus">+ public:</span>
<a href="#l12.21"></a><span id="l12.21">   NS_DECL_ISUPPORTS_INHERITED</span>
<a href="#l12.22"></a><span id="l12.22"> </span>
<a href="#l12.23"></a><span id="l12.23">   // nsMsgMailNewsUrl overrides</span>
<a href="#l12.24"></a><span id="l12.24">   nsresult SetSpecInternal(const nsACString &amp;aSpec) override;</span>
<a href="#l12.25"></a><span id="l12.25">   nsresult SetQuery(const nsACString &amp;aQuery) override;</span>
<a href="#l12.26"></a><span id="l12.26">   nsresult Clone(nsIURI **_retval) override;</span>
<a href="#l12.27"></a><span id="l12.27"> </span>
<a href="#l12.28"></a><span id="l12.28">   //////////////////////////////////////////////////////////////////////////////</span>
<a href="#l12.29"></a><span id="l12.29" class="difflineat">@@ -36,22 +37,25 @@ public:</span>
<a href="#l12.30"></a><span id="l12.30">   NS_IMETHOD SetFolder(nsIMsgFolder *aFolder) override;</span>
<a href="#l12.31"></a><span id="l12.31">   // nsIMsgMessageUrl</span>
<a href="#l12.32"></a><span id="l12.32">   NS_DECL_NSIMSGMESSAGEURL</span>
<a href="#l12.33"></a><span id="l12.33">   NS_DECL_NSIMSGI18NURL</span>
<a href="#l12.34"></a><span id="l12.34"> </span>
<a href="#l12.35"></a><span id="l12.35">   // nsImapUrl</span>
<a href="#l12.36"></a><span id="l12.36">   nsImapUrl();</span>
<a href="#l12.37"></a><span id="l12.37"> </span>
<a href="#l12.38"></a><span id="l12.38" class="difflineminus">-  static nsresult ConvertToCanonicalFormat(const char *folderName, char onlineDelimiter, char **resultingCanonicalPath);</span>
<a href="#l12.39"></a><span id="l12.39" class="difflineplus">+  static nsresult ConvertToCanonicalFormat(const char *folderName,</span>
<a href="#l12.40"></a><span id="l12.40" class="difflineplus">+                                           char onlineDelimiter,</span>
<a href="#l12.41"></a><span id="l12.41" class="difflineplus">+                                           char **resultingCanonicalPath);</span>
<a href="#l12.42"></a><span id="l12.42">   static nsresult EscapeSlashes(const char *sourcePath, char **resultPath);</span>
<a href="#l12.43"></a><span id="l12.43">   static nsresult UnescapeSlashes(char *path);</span>
<a href="#l12.44"></a><span id="l12.44" class="difflineminus">-  static char *  ReplaceCharsInCopiedString(const char *stringToCopy, char oldChar, char newChar);</span>
<a href="#l12.45"></a><span id="l12.45" class="difflineplus">+  static char *ReplaceCharsInCopiedString(const char *stringToCopy,</span>
<a href="#l12.46"></a><span id="l12.46" class="difflineplus">+                                          char oldChar, char newChar);</span>
<a href="#l12.47"></a><span id="l12.47"> </span>
<a href="#l12.48"></a><span id="l12.48" class="difflineminus">-protected:</span>
<a href="#l12.49"></a><span id="l12.49" class="difflineplus">+ protected:</span>
<a href="#l12.50"></a><span id="l12.50">   virtual ~nsImapUrl();</span>
<a href="#l12.51"></a><span id="l12.51">   virtual nsresult ParseUrl();</span>
<a href="#l12.52"></a><span id="l12.52"> </span>
<a href="#l12.53"></a><span id="l12.53">   char *m_listOfMessageIds;</span>
<a href="#l12.54"></a><span id="l12.54"> </span>
<a href="#l12.55"></a><span id="l12.55">   // handle the imap specific parsing</span>
<a href="#l12.56"></a><span id="l12.56">   void ParseImapPart(char *imapPartOfUrl);</span>
<a href="#l12.57"></a><span id="l12.57"> </span>
<a href="#l12.58"></a><span id="l12.58" class="difflineat">@@ -60,67 +64,70 @@ protected:</span>
<a href="#l12.59"></a><span id="l12.59">   void ParseUidChoice();</span>
<a href="#l12.60"></a><span id="l12.60">   void ParseMsgFlags();</span>
<a href="#l12.61"></a><span id="l12.61">   void ParseListOfMessageIds();</span>
<a href="#l12.62"></a><span id="l12.62">   void ParseCustomMsgFetchAttribute();</span>
<a href="#l12.63"></a><span id="l12.63">   void ParseNumBytes();</span>
<a href="#l12.64"></a><span id="l12.64"> </span>
<a href="#l12.65"></a><span id="l12.65">   nsresult GetMsgFolder(nsIMsgFolder **msgFolder);</span>
<a href="#l12.66"></a><span id="l12.66"> </span>
<a href="#l12.67"></a><span id="l12.67" class="difflineminus">-  char        *m_sourceCanonicalFolderPathSubString;</span>
<a href="#l12.68"></a><span id="l12.68" class="difflineminus">-  char        *m_destinationCanonicalFolderPathSubString;</span>
<a href="#l12.69"></a><span id="l12.69" class="difflineminus">-  char        *m_tokenPlaceHolder;</span>
<a href="#l12.70"></a><span id="l12.70" class="difflineminus">-  char        *m_urlidSubString;</span>
<a href="#l12.71"></a><span id="l12.71" class="difflineminus">-  char        m_onlineSubDirSeparator;</span>
<a href="#l12.72"></a><span id="l12.72" class="difflineminus">-  char        *m_searchCriteriaString;  // should we use m_search, or is this special?</span>
<a href="#l12.73"></a><span id="l12.73" class="difflineminus">-  nsCString     m_command;       // for custom commands</span>
<a href="#l12.74"></a><span id="l12.74" class="difflineminus">-  nsCString     m_msgFetchAttribute; // for fetching custom msg attributes</span>
<a href="#l12.75"></a><span id="l12.75" class="difflineminus">-  nsCString     m_customAttributeResult; // for fetching custom msg attributes</span>
<a href="#l12.76"></a><span id="l12.76" class="difflineminus">-  nsCString     m_customCommandResult; // custom command response</span>
<a href="#l12.77"></a><span id="l12.77" class="difflineminus">-  nsCString     m_customAddFlags;       // these two are for setting and clearing custom flags</span>
<a href="#l12.78"></a><span id="l12.78" class="difflineminus">-  nsCString     m_customSubtractFlags;</span>
<a href="#l12.79"></a><span id="l12.79" class="difflineminus">-  int32_t       m_numBytesToFetch; // when doing a msg body preview, how many bytes to read</span>
<a href="#l12.80"></a><span id="l12.80" class="difflineplus">+  char *m_sourceCanonicalFolderPathSubString;</span>
<a href="#l12.81"></a><span id="l12.81" class="difflineplus">+  char *m_destinationCanonicalFolderPathSubString;</span>
<a href="#l12.82"></a><span id="l12.82" class="difflineplus">+  char *m_tokenPlaceHolder;</span>
<a href="#l12.83"></a><span id="l12.83" class="difflineplus">+  char *m_urlidSubString;</span>
<a href="#l12.84"></a><span id="l12.84" class="difflineplus">+  char m_onlineSubDirSeparator;</span>
<a href="#l12.85"></a><span id="l12.85" class="difflineplus">+  char *m_searchCriteriaString;   // should we use m_search, or is this special?</span>
<a href="#l12.86"></a><span id="l12.86" class="difflineplus">+  nsCString m_command;            // for custom commands</span>
<a href="#l12.87"></a><span id="l12.87" class="difflineplus">+  nsCString m_msgFetchAttribute;  // for fetching custom msg attributes</span>
<a href="#l12.88"></a><span id="l12.88" class="difflineplus">+  nsCString m_customAttributeResult;  // for fetching custom msg attributes</span>
<a href="#l12.89"></a><span id="l12.89" class="difflineplus">+  nsCString m_customCommandResult;    // custom command response</span>
<a href="#l12.90"></a><span id="l12.90" class="difflineplus">+  nsCString</span>
<a href="#l12.91"></a><span id="l12.91" class="difflineplus">+      m_customAddFlags;  // these two are for setting and clearing custom flags</span>
<a href="#l12.92"></a><span id="l12.92" class="difflineplus">+  nsCString m_customSubtractFlags;</span>
<a href="#l12.93"></a><span id="l12.93" class="difflineplus">+  int32_t m_numBytesToFetch;  // when doing a msg body preview, how many bytes</span>
<a href="#l12.94"></a><span id="l12.94" class="difflineplus">+                              // to read</span>
<a href="#l12.95"></a><span id="l12.95">   bool m_validUrl;</span>
<a href="#l12.96"></a><span id="l12.96">   bool m_runningUrl;</span>
<a href="#l12.97"></a><span id="l12.97">   bool m_idsAreUids;</span>
<a href="#l12.98"></a><span id="l12.98">   bool m_mimePartSelectorDetected;</span>
<a href="#l12.99"></a><span id="l12.99">   bool m_allowContentChange;  // if false, we can't use Mime parts on demand</span>
<a href="#l12.100"></a><span id="l12.100" class="difflineminus">-  bool m_fetchPartsOnDemand; // if true, we should fetch leave parts on server.</span>
<a href="#l12.101"></a><span id="l12.101" class="difflineminus">-  bool m_msgLoadingFromCache; // if true, we might need to mark read on server</span>
<a href="#l12.102"></a><span id="l12.102" class="difflineminus">-  bool m_externalLinkUrl; // if true, we're running this url because the user</span>
<a href="#l12.103"></a><span id="l12.103" class="difflineplus">+  bool m_fetchPartsOnDemand;  // if true, we should fetch leave parts on server.</span>
<a href="#l12.104"></a><span id="l12.104" class="difflineplus">+  bool m_msgLoadingFromCache;  // if true, we might need to mark read on server</span>
<a href="#l12.105"></a><span id="l12.105" class="difflineplus">+  bool m_externalLinkUrl;  // if true, we're running this url because the user</span>
<a href="#l12.106"></a><span id="l12.106">   // True if the fetch results should be put in the offline store.</span>
<a href="#l12.107"></a><span id="l12.107">   bool m_storeResultsOffline;</span>
<a href="#l12.108"></a><span id="l12.108">   bool m_storeOfflineOnFallback;</span>
<a href="#l12.109"></a><span id="l12.109">   bool m_localFetchOnly;</span>
<a href="#l12.110"></a><span id="l12.110" class="difflineminus">-  bool m_rerunningUrl; // first attempt running this failed with connection error; retrying</span>
<a href="#l12.111"></a><span id="l12.111" class="difflineplus">+  bool m_rerunningUrl;  // first attempt running this failed with connection</span>
<a href="#l12.112"></a><span id="l12.112" class="difflineplus">+                        // error; retrying</span>
<a href="#l12.113"></a><span id="l12.113">   bool m_moreHeadersToDownload;</span>
<a href="#l12.114"></a><span id="l12.114" class="difflineminus">-  nsImapContentModifiedType  m_contentModified;</span>
<a href="#l12.115"></a><span id="l12.115" class="difflineminus">-</span>
<a href="#l12.116"></a><span id="l12.116" class="difflineminus">-  int32_t    m_extraStatus;</span>
<a href="#l12.117"></a><span id="l12.117" class="difflineplus">+  nsImapContentModifiedType m_contentModified;</span>
<a href="#l12.118"></a><span id="l12.118"> </span>
<a href="#l12.119"></a><span id="l12.119" class="difflineminus">-  nsCString  m_userName;</span>
<a href="#l12.120"></a><span id="l12.120" class="difflineminus">-  nsCString  m_serverKey;</span>
<a href="#l12.121"></a><span id="l12.121" class="difflineplus">+  int32_t m_extraStatus;</span>
<a href="#l12.122"></a><span id="l12.122" class="difflineplus">+</span>
<a href="#l12.123"></a><span id="l12.123" class="difflineplus">+  nsCString m_userName;</span>
<a href="#l12.124"></a><span id="l12.124" class="difflineplus">+  nsCString m_serverKey;</span>
<a href="#l12.125"></a><span id="l12.125">   // event sinks</span>
<a href="#l12.126"></a><span id="l12.126" class="difflineminus">-  imapMessageFlagsType  m_flags;</span>
<a href="#l12.127"></a><span id="l12.127" class="difflineminus">-  nsImapAction  m_imapAction;</span>
<a href="#l12.128"></a><span id="l12.128" class="difflineplus">+  imapMessageFlagsType m_flags;</span>
<a href="#l12.129"></a><span id="l12.129" class="difflineplus">+  nsImapAction m_imapAction;</span>
<a href="#l12.130"></a><span id="l12.130"> </span>
<a href="#l12.131"></a><span id="l12.131">   nsWeakPtr m_imapFolder;</span>
<a href="#l12.132"></a><span id="l12.132">   nsWeakPtr m_imapMailFolderSink;</span>
<a href="#l12.133"></a><span id="l12.133">   nsWeakPtr m_imapMessageSink;</span>
<a href="#l12.134"></a><span id="l12.134"> </span>
<a href="#l12.135"></a><span id="l12.135">   nsWeakPtr m_imapServerSink;</span>
<a href="#l12.136"></a><span id="l12.136"> </span>
<a href="#l12.137"></a><span id="l12.137">   // online message copy support; i don't have a better solution yet</span>
<a href="#l12.138"></a><span id="l12.138" class="difflineminus">-  nsCOMPtr &lt;nsISupports&gt; m_copyState;   // now, refcounted.</span>
<a href="#l12.139"></a><span id="l12.139" class="difflineplus">+  nsCOMPtr&lt;nsISupports&gt; m_copyState;  // now, refcounted.</span>
<a href="#l12.140"></a><span id="l12.140">   nsCOMPtr&lt;nsIFile&gt; m_file;</span>
<a href="#l12.141"></a><span id="l12.141">   nsWeakPtr m_channelWeakPtr;</span>
<a href="#l12.142"></a><span id="l12.142"> </span>
<a href="#l12.143"></a><span id="l12.143">   // used by save message to disk</span>
<a href="#l12.144"></a><span id="l12.144">   nsCOMPtr&lt;nsIFile&gt; m_messageFile;</span>
<a href="#l12.145"></a><span id="l12.145" class="difflineminus">-  bool                  m_addDummyEnvelope;</span>
<a href="#l12.146"></a><span id="l12.146" class="difflineminus">-  bool                  m_canonicalLineEnding; // CRLF</span>
<a href="#l12.147"></a><span id="l12.147" class="difflineplus">+  bool m_addDummyEnvelope;</span>
<a href="#l12.148"></a><span id="l12.148" class="difflineplus">+  bool m_canonicalLineEnding;  // CRLF</span>
<a href="#l12.149"></a><span id="l12.149"> </span>
<a href="#l12.150"></a><span id="l12.150" class="difflineminus">-  nsCString mURI; // the RDF URI associated with this url.</span>
<a href="#l12.151"></a><span id="l12.151" class="difflineminus">-  nsCString mCharsetOverride; // used by nsIMsgI18NUrl...</span>
<a href="#l12.152"></a><span id="l12.152" class="difflineplus">+  nsCString mURI;              // the RDF URI associated with this url.</span>
<a href="#l12.153"></a><span id="l12.153" class="difflineplus">+  nsCString mCharsetOverride;  // used by nsIMsgI18NUrl...</span>
<a href="#l12.154"></a><span id="l12.154">   mozilla::Mutex mLock;</span>
<a href="#l12.155"></a><span id="l12.155"> };</span>
<a href="#l12.156"></a><span id="l12.156"> </span>
<a href="#l12.157"></a><span id="l12.157"> #endif /* nsImapUrl_h___ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mailnews/imap/src/nsImapUtils.cpp</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapUtils.cpp</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -11,124 +11,111 @@</span>
<a href="#l13.4"></a><span id="l13.4"> #include &quot;nsNetCID.h&quot;</span>
<a href="#l13.5"></a><span id="l13.5"> </span>
<a href="#l13.6"></a><span id="l13.6"> #include &quot;nsMsgBaseCID.h&quot;</span>
<a href="#l13.7"></a><span id="l13.7"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l13.8"></a><span id="l13.8"> #include &quot;nsImapFlagAndUidState.h&quot;</span>
<a href="#l13.9"></a><span id="l13.9"> #include &quot;nsIMAPNamespace.h&quot;</span>
<a href="#l13.10"></a><span id="l13.10"> #include &quot;nsIImapFlagAndUidState.h&quot;</span>
<a href="#l13.11"></a><span id="l13.11"> </span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-nsresult</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineminus">-nsImapURI2FullName(const char* rootURI, const char* hostName, const char* uriStr,</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineminus">-                   char **name)</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineminus">-{</span>
<a href="#l13.16"></a><span id="l13.16" class="difflineminus">-    nsAutoCString uri(uriStr);</span>
<a href="#l13.17"></a><span id="l13.17" class="difflineminus">-    nsAutoCString fullName;</span>
<a href="#l13.18"></a><span id="l13.18" class="difflineminus">-    if (uri.Find(rootURI) != 0)</span>
<a href="#l13.19"></a><span id="l13.19" class="difflineminus">-      return NS_ERROR_FAILURE;</span>
<a href="#l13.20"></a><span id="l13.20" class="difflineminus">-    fullName = Substring(uri, strlen(rootURI));</span>
<a href="#l13.21"></a><span id="l13.21" class="difflineminus">-    uri = fullName;</span>
<a href="#l13.22"></a><span id="l13.22" class="difflineminus">-    int32_t hostStart = uri.Find(hostName);</span>
<a href="#l13.23"></a><span id="l13.23" class="difflineminus">-    if (hostStart &lt;= 0)</span>
<a href="#l13.24"></a><span id="l13.24" class="difflineminus">-      return NS_ERROR_FAILURE;</span>
<a href="#l13.25"></a><span id="l13.25" class="difflineminus">-    fullName = Substring(uri, hostStart);</span>
<a href="#l13.26"></a><span id="l13.26" class="difflineminus">-    uri = fullName;</span>
<a href="#l13.27"></a><span id="l13.27" class="difflineminus">-    int32_t hostEnd = uri.FindChar('/');</span>
<a href="#l13.28"></a><span id="l13.28" class="difflineminus">-    if (hostEnd &lt;= 0)</span>
<a href="#l13.29"></a><span id="l13.29" class="difflineminus">-      return NS_ERROR_FAILURE;</span>
<a href="#l13.30"></a><span id="l13.30" class="difflineminus">-    fullName = Substring(uri, hostEnd + 1);</span>
<a href="#l13.31"></a><span id="l13.31" class="difflineminus">-    if (fullName.IsEmpty())</span>
<a href="#l13.32"></a><span id="l13.32" class="difflineminus">-      return NS_ERROR_FAILURE;</span>
<a href="#l13.33"></a><span id="l13.33" class="difflineminus">-    *name = ToNewCString(fullName);</span>
<a href="#l13.34"></a><span id="l13.34" class="difflineminus">-    return NS_OK;</span>
<a href="#l13.35"></a><span id="l13.35" class="difflineplus">+nsresult nsImapURI2FullName(const char *rootURI, const char *hostName,</span>
<a href="#l13.36"></a><span id="l13.36" class="difflineplus">+                            const char *uriStr, char **name) {</span>
<a href="#l13.37"></a><span id="l13.37" class="difflineplus">+  nsAutoCString uri(uriStr);</span>
<a href="#l13.38"></a><span id="l13.38" class="difflineplus">+  nsAutoCString fullName;</span>
<a href="#l13.39"></a><span id="l13.39" class="difflineplus">+  if (uri.Find(rootURI) != 0) return NS_ERROR_FAILURE;</span>
<a href="#l13.40"></a><span id="l13.40" class="difflineplus">+  fullName = Substring(uri, strlen(rootURI));</span>
<a href="#l13.41"></a><span id="l13.41" class="difflineplus">+  uri = fullName;</span>
<a href="#l13.42"></a><span id="l13.42" class="difflineplus">+  int32_t hostStart = uri.Find(hostName);</span>
<a href="#l13.43"></a><span id="l13.43" class="difflineplus">+  if (hostStart &lt;= 0) return NS_ERROR_FAILURE;</span>
<a href="#l13.44"></a><span id="l13.44" class="difflineplus">+  fullName = Substring(uri, hostStart);</span>
<a href="#l13.45"></a><span id="l13.45" class="difflineplus">+  uri = fullName;</span>
<a href="#l13.46"></a><span id="l13.46" class="difflineplus">+  int32_t hostEnd = uri.FindChar('/');</span>
<a href="#l13.47"></a><span id="l13.47" class="difflineplus">+  if (hostEnd &lt;= 0) return NS_ERROR_FAILURE;</span>
<a href="#l13.48"></a><span id="l13.48" class="difflineplus">+  fullName = Substring(uri, hostEnd + 1);</span>
<a href="#l13.49"></a><span id="l13.49" class="difflineplus">+  if (fullName.IsEmpty()) return NS_ERROR_FAILURE;</span>
<a href="#l13.50"></a><span id="l13.50" class="difflineplus">+  *name = ToNewCString(fullName);</span>
<a href="#l13.51"></a><span id="l13.51" class="difflineplus">+  return NS_OK;</span>
<a href="#l13.52"></a><span id="l13.52"> }</span>
<a href="#l13.53"></a><span id="l13.53"> </span>
<a href="#l13.54"></a><span id="l13.54"> /* parses ImapMessageURI */</span>
<a href="#l13.55"></a><span id="l13.55" class="difflineminus">-nsresult nsParseImapMessageURI(const char* uri, nsCString&amp; folderURI, uint32_t *key, char **part)</span>
<a href="#l13.56"></a><span id="l13.56" class="difflineminus">-{</span>
<a href="#l13.57"></a><span id="l13.57" class="difflineminus">-  if(!key)</span>
<a href="#l13.58"></a><span id="l13.58" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l13.59"></a><span id="l13.59" class="difflineplus">+nsresult nsParseImapMessageURI(const char *uri, nsCString &amp;folderURI,</span>
<a href="#l13.60"></a><span id="l13.60" class="difflineplus">+                               uint32_t *key, char **part) {</span>
<a href="#l13.61"></a><span id="l13.61" class="difflineplus">+  if (!key) return NS_ERROR_NULL_POINTER;</span>
<a href="#l13.62"></a><span id="l13.62"> </span>
<a href="#l13.63"></a><span id="l13.63">   nsAutoCString uriStr(uri);</span>
<a href="#l13.64"></a><span id="l13.64">   int32_t folderEnd = -1;</span>
<a href="#l13.65"></a><span id="l13.65">   // imap-message uri's can have imap:// url strings tacked on the end,</span>
<a href="#l13.66"></a><span id="l13.66">   // e.g., when opening/saving attachments. We don't want to look for '#'</span>
<a href="#l13.67"></a><span id="l13.67">   // in that part of the uri, if the attachment name contains '#',</span>
<a href="#l13.68"></a><span id="l13.68">   // so check for that here.</span>
<a href="#l13.69"></a><span id="l13.69">   if (StringBeginsWith(uriStr, NS_LITERAL_CSTRING(&quot;imap-message&quot;)))</span>
<a href="#l13.70"></a><span id="l13.70">     folderEnd = uriStr.Find(&quot;imap://&quot;);</span>
<a href="#l13.71"></a><span id="l13.71"> </span>
<a href="#l13.72"></a><span id="l13.72">   int32_t keySeparator = MsgRFindChar(uriStr, '#', folderEnd);</span>
<a href="#l13.73"></a><span id="l13.73" class="difflineminus">-  if(keySeparator != -1)</span>
<a href="#l13.74"></a><span id="l13.74" class="difflineminus">-  {</span>
<a href="#l13.75"></a><span id="l13.75" class="difflineplus">+  if (keySeparator != -1) {</span>
<a href="#l13.76"></a><span id="l13.76">     int32_t keyEndSeparator = MsgFindCharInSet(uriStr, &quot;/?&amp;&quot;, keySeparator);</span>
<a href="#l13.77"></a><span id="l13.77">     nsAutoString folderPath;</span>
<a href="#l13.78"></a><span id="l13.78">     folderURI = StringHead(uriStr, keySeparator);</span>
<a href="#l13.79"></a><span id="l13.79" class="difflineminus">-    folderURI.Cut(4, 8); // cut out the _message part of imap-message:</span>
<a href="#l13.80"></a><span id="l13.80" class="difflineplus">+    folderURI.Cut(4, 8);  // cut out the _message part of imap-message:</span>
<a href="#l13.81"></a><span id="l13.81">     // folder uri's don't have fully escaped usernames.</span>
<a href="#l13.82"></a><span id="l13.82">     int32_t atPos = folderURI.FindChar('@');</span>
<a href="#l13.83"></a><span id="l13.83" class="difflineminus">-    if (atPos != -1)</span>
<a href="#l13.84"></a><span id="l13.84" class="difflineminus">-    {</span>
<a href="#l13.85"></a><span id="l13.85" class="difflineplus">+    if (atPos != -1) {</span>
<a href="#l13.86"></a><span id="l13.86">       nsCString unescapedName, escapedName;</span>
<a href="#l13.87"></a><span id="l13.87">       int32_t userNamePos = folderURI.Find(&quot;//&quot;) + 2;</span>
<a href="#l13.88"></a><span id="l13.88">       uint32_t origUserNameLen = atPos - userNamePos;</span>
<a href="#l13.89"></a><span id="l13.89" class="difflineminus">-      if (NS_SUCCEEDED(MsgUnescapeString(Substring(folderURI, userNamePos,</span>
<a href="#l13.90"></a><span id="l13.90" class="difflineminus">-                                                   origUserNameLen),</span>
<a href="#l13.91"></a><span id="l13.91" class="difflineminus">-                                         0, unescapedName)))</span>
<a href="#l13.92"></a><span id="l13.92" class="difflineminus">-      {</span>
<a href="#l13.93"></a><span id="l13.93" class="difflineplus">+      if (NS_SUCCEEDED(MsgUnescapeString(</span>
<a href="#l13.94"></a><span id="l13.94" class="difflineplus">+              Substring(folderURI, userNamePos, origUserNameLen), 0,</span>
<a href="#l13.95"></a><span id="l13.95" class="difflineplus">+              unescapedName))) {</span>
<a href="#l13.96"></a><span id="l13.96">         // Re-escape the username, matching the way we do it in uris, not the</span>
<a href="#l13.97"></a><span id="l13.97">         // way necko escapes urls. See nsMsgIncomingServer::GetServerURI.</span>
<a href="#l13.98"></a><span id="l13.98">         MsgEscapeString(unescapedName, nsINetUtil::ESCAPE_XALPHAS, escapedName);</span>
<a href="#l13.99"></a><span id="l13.99">         folderURI.Replace(userNamePos, origUserNameLen, escapedName);</span>
<a href="#l13.100"></a><span id="l13.100">       }</span>
<a href="#l13.101"></a><span id="l13.101">     }</span>
<a href="#l13.102"></a><span id="l13.102">     nsAutoCString keyStr;</span>
<a href="#l13.103"></a><span id="l13.103">     if (keyEndSeparator != -1)</span>
<a href="#l13.104"></a><span id="l13.104" class="difflineminus">-      keyStr = Substring(uriStr, keySeparator + 1, keyEndSeparator - (keySeparator + 1));</span>
<a href="#l13.105"></a><span id="l13.105" class="difflineplus">+      keyStr = Substring(uriStr, keySeparator + 1,</span>
<a href="#l13.106"></a><span id="l13.106" class="difflineplus">+                         keyEndSeparator - (keySeparator + 1));</span>
<a href="#l13.107"></a><span id="l13.107">     else</span>
<a href="#l13.108"></a><span id="l13.108">       keyStr = Substring(uriStr, keySeparator + 1);</span>
<a href="#l13.109"></a><span id="l13.109"> </span>
<a href="#l13.110"></a><span id="l13.110">     *key = strtoul(keyStr.get(), nullptr, 10);</span>
<a href="#l13.111"></a><span id="l13.111"> </span>
<a href="#l13.112"></a><span id="l13.112" class="difflineminus">-    if (part &amp;&amp; keyEndSeparator != -1)</span>
<a href="#l13.113"></a><span id="l13.113" class="difflineminus">-    {</span>
<a href="#l13.114"></a><span id="l13.114" class="difflineplus">+    if (part &amp;&amp; keyEndSeparator != -1) {</span>
<a href="#l13.115"></a><span id="l13.115">       int32_t partPos = MsgFind(uriStr, &quot;part=&quot;, false, keyEndSeparator);</span>
<a href="#l13.116"></a><span id="l13.116" class="difflineminus">-      if (partPos != -1)</span>
<a href="#l13.117"></a><span id="l13.117" class="difflineminus">-      {</span>
<a href="#l13.118"></a><span id="l13.118" class="difflineplus">+      if (partPos != -1) {</span>
<a href="#l13.119"></a><span id="l13.119">         *part = ToNewCString(Substring(uriStr, keyEndSeparator));</span>
<a href="#l13.120"></a><span id="l13.120">       }</span>
<a href="#l13.121"></a><span id="l13.121">     }</span>
<a href="#l13.122"></a><span id="l13.122">   }</span>
<a href="#l13.123"></a><span id="l13.123">   return NS_OK;</span>
<a href="#l13.124"></a><span id="l13.124"> }</span>
<a href="#l13.125"></a><span id="l13.125"> </span>
<a href="#l13.126"></a><span id="l13.126" class="difflineminus">-nsresult nsBuildImapMessageURI(const char *baseURI, uint32_t key, nsCString&amp; uri)</span>
<a href="#l13.127"></a><span id="l13.127" class="difflineminus">-{</span>
<a href="#l13.128"></a><span id="l13.128" class="difflineplus">+nsresult nsBuildImapMessageURI(const char *baseURI, uint32_t key,</span>
<a href="#l13.129"></a><span id="l13.129" class="difflineplus">+                               nsCString &amp;uri) {</span>
<a href="#l13.130"></a><span id="l13.130">   uri.Append(baseURI);</span>
<a href="#l13.131"></a><span id="l13.131">   uri.Append('#');</span>
<a href="#l13.132"></a><span id="l13.132">   uri.AppendInt(key);</span>
<a href="#l13.133"></a><span id="l13.133">   return NS_OK;</span>
<a href="#l13.134"></a><span id="l13.134"> }</span>
<a href="#l13.135"></a><span id="l13.135"> </span>
<a href="#l13.136"></a><span id="l13.136" class="difflineminus">-nsresult nsCreateImapBaseMessageURI(const nsACString&amp; baseURI, nsCString &amp;baseMessageURI)</span>
<a href="#l13.137"></a><span id="l13.137" class="difflineminus">-{</span>
<a href="#l13.138"></a><span id="l13.138" class="difflineplus">+nsresult nsCreateImapBaseMessageURI(const nsACString &amp;baseURI,</span>
<a href="#l13.139"></a><span id="l13.139" class="difflineplus">+                                    nsCString &amp;baseMessageURI) {</span>
<a href="#l13.140"></a><span id="l13.140">   nsAutoCString tailURI(baseURI);</span>
<a href="#l13.141"></a><span id="l13.141">   // chop off imap:/</span>
<a href="#l13.142"></a><span id="l13.142" class="difflineminus">-  if (tailURI.Find(kImapRootURI) == 0)</span>
<a href="#l13.143"></a><span id="l13.143" class="difflineminus">-    tailURI.Cut(0, PL_strlen(kImapRootURI));</span>
<a href="#l13.144"></a><span id="l13.144" class="difflineplus">+  if (tailURI.Find(kImapRootURI) == 0) tailURI.Cut(0, PL_strlen(kImapRootURI));</span>
<a href="#l13.145"></a><span id="l13.145">   baseMessageURI = kImapMessageRootURI;</span>
<a href="#l13.146"></a><span id="l13.146">   baseMessageURI += tailURI;</span>
<a href="#l13.147"></a><span id="l13.147">   return NS_OK;</span>
<a href="#l13.148"></a><span id="l13.148"> }</span>
<a href="#l13.149"></a><span id="l13.149"> </span>
<a href="#l13.150"></a><span id="l13.150"> // nsImapMailboxSpec definition</span>
<a href="#l13.151"></a><span id="l13.151"> NS_IMPL_ISUPPORTS(nsImapMailboxSpec, nsIMailboxSpec)</span>
<a href="#l13.152"></a><span id="l13.152"> </span>
<a href="#l13.153"></a><span id="l13.153" class="difflineminus">-nsImapMailboxSpec::nsImapMailboxSpec()</span>
<a href="#l13.154"></a><span id="l13.154" class="difflineminus">-{</span>
<a href="#l13.155"></a><span id="l13.155" class="difflineplus">+nsImapMailboxSpec::nsImapMailboxSpec() {</span>
<a href="#l13.156"></a><span id="l13.156">   mFolder_UIDVALIDITY = 0;</span>
<a href="#l13.157"></a><span id="l13.157">   mHighestModSeq = 0;</span>
<a href="#l13.158"></a><span id="l13.158">   mNumOfMessages = 0;</span>
<a href="#l13.159"></a><span id="l13.159">   mNumOfUnseenMessages = 0;</span>
<a href="#l13.160"></a><span id="l13.160">   mNumOfRecentMessages = 0;</span>
<a href="#l13.161"></a><span id="l13.161">   mNextUID = 0;</span>
<a href="#l13.162"></a><span id="l13.162"> </span>
<a href="#l13.163"></a><span id="l13.163">   mBoxFlags = 0;</span>
<a href="#l13.164"></a><span id="l13.164" class="difflineat">@@ -138,86 +125,87 @@ nsImapMailboxSpec::nsImapMailboxSpec()</span>
<a href="#l13.165"></a><span id="l13.165"> </span>
<a href="#l13.166"></a><span id="l13.166">   mFolderSelected = false;</span>
<a href="#l13.167"></a><span id="l13.167">   mDiscoveredFromLsub = false;</span>
<a href="#l13.168"></a><span id="l13.168"> </span>
<a href="#l13.169"></a><span id="l13.169">   mOnlineVerified = false;</span>
<a href="#l13.170"></a><span id="l13.170">   mNamespaceForFolder = nullptr;</span>
<a href="#l13.171"></a><span id="l13.171"> }</span>
<a href="#l13.172"></a><span id="l13.172"> </span>
<a href="#l13.173"></a><span id="l13.173" class="difflineminus">-nsImapMailboxSpec::~nsImapMailboxSpec()</span>
<a href="#l13.174"></a><span id="l13.174" class="difflineminus">-{</span>
<a href="#l13.175"></a><span id="l13.175" class="difflineminus">-}</span>
<a href="#l13.176"></a><span id="l13.176" class="difflineplus">+nsImapMailboxSpec::~nsImapMailboxSpec() {}</span>
<a href="#l13.177"></a><span id="l13.177"> </span>
<a href="#l13.178"></a><span id="l13.178" class="difflineminus">-NS_IMPL_GETSET(nsImapMailboxSpec, Folder_UIDVALIDITY, int32_t, mFolder_UIDVALIDITY)</span>
<a href="#l13.179"></a><span id="l13.179" class="difflineplus">+NS_IMPL_GETSET(nsImapMailboxSpec, Folder_UIDVALIDITY, int32_t,</span>
<a href="#l13.180"></a><span id="l13.180" class="difflineplus">+               mFolder_UIDVALIDITY)</span>
<a href="#l13.181"></a><span id="l13.181"> NS_IMPL_GETSET(nsImapMailboxSpec, HighestModSeq, uint64_t, mHighestModSeq)</span>
<a href="#l13.182"></a><span id="l13.182"> NS_IMPL_GETSET(nsImapMailboxSpec, NumMessages, int32_t, mNumOfMessages)</span>
<a href="#l13.183"></a><span id="l13.183" class="difflineminus">-NS_IMPL_GETSET(nsImapMailboxSpec, NumUnseenMessages, int32_t, mNumOfUnseenMessages)</span>
<a href="#l13.184"></a><span id="l13.184" class="difflineminus">-NS_IMPL_GETSET(nsImapMailboxSpec, NumRecentMessages, int32_t, mNumOfRecentMessages)</span>
<a href="#l13.185"></a><span id="l13.185" class="difflineplus">+NS_IMPL_GETSET(nsImapMailboxSpec, NumUnseenMessages, int32_t,</span>
<a href="#l13.186"></a><span id="l13.186" class="difflineplus">+               mNumOfUnseenMessages)</span>
<a href="#l13.187"></a><span id="l13.187" class="difflineplus">+NS_IMPL_GETSET(nsImapMailboxSpec, NumRecentMessages, int32_t,</span>
<a href="#l13.188"></a><span id="l13.188" class="difflineplus">+               mNumOfRecentMessages)</span>
<a href="#l13.189"></a><span id="l13.189"> NS_IMPL_GETSET(nsImapMailboxSpec, NextUID, int32_t, mNextUID)</span>
<a href="#l13.190"></a><span id="l13.190"> NS_IMPL_GETSET(nsImapMailboxSpec, HierarchyDelimiter, char, mHierarchySeparator)</span>
<a href="#l13.191"></a><span id="l13.191"> NS_IMPL_GETSET(nsImapMailboxSpec, FolderSelected, bool, mFolderSelected)</span>
<a href="#l13.192"></a><span id="l13.192"> NS_IMPL_GETSET(nsImapMailboxSpec, DiscoveredFromLsub, bool, mDiscoveredFromLsub)</span>
<a href="#l13.193"></a><span id="l13.193"> NS_IMPL_GETSET(nsImapMailboxSpec, OnlineVerified, bool, mOnlineVerified)</span>
<a href="#l13.194"></a><span id="l13.194" class="difflineminus">-NS_IMPL_GETSET(nsImapMailboxSpec, SupportedUserFlags, uint32_t, mSupportedUserFlags)</span>
<a href="#l13.195"></a><span id="l13.195" class="difflineplus">+NS_IMPL_GETSET(nsImapMailboxSpec, SupportedUserFlags, uint32_t,</span>
<a href="#l13.196"></a><span id="l13.196" class="difflineplus">+               mSupportedUserFlags)</span>
<a href="#l13.197"></a><span id="l13.197"> NS_IMPL_GETSET(nsImapMailboxSpec, Box_flags, uint32_t, mBoxFlags)</span>
<a href="#l13.198"></a><span id="l13.198" class="difflineminus">-NS_IMPL_GETSET(nsImapMailboxSpec, NamespaceForFolder, nsIMAPNamespace *, mNamespaceForFolder)</span>
<a href="#l13.199"></a><span id="l13.199" class="difflineplus">+NS_IMPL_GETSET(nsImapMailboxSpec, NamespaceForFolder, nsIMAPNamespace *,</span>
<a href="#l13.200"></a><span id="l13.200" class="difflineplus">+               mNamespaceForFolder)</span>
<a href="#l13.201"></a><span id="l13.201"> </span>
<a href="#l13.202"></a><span id="l13.202" class="difflineminus">-NS_IMETHODIMP nsImapMailboxSpec::GetAllocatedPathName(nsACString &amp;aAllocatedPathName)</span>
<a href="#l13.203"></a><span id="l13.203" class="difflineminus">-{</span>
<a href="#l13.204"></a><span id="l13.204" class="difflineplus">+NS_IMETHODIMP nsImapMailboxSpec::GetAllocatedPathName(</span>
<a href="#l13.205"></a><span id="l13.205" class="difflineplus">+    nsACString &amp;aAllocatedPathName) {</span>
<a href="#l13.206"></a><span id="l13.206">   aAllocatedPathName = mAllocatedPathName;</span>
<a href="#l13.207"></a><span id="l13.207">   return NS_OK;</span>
<a href="#l13.208"></a><span id="l13.208"> }</span>
<a href="#l13.209"></a><span id="l13.209"> </span>
<a href="#l13.210"></a><span id="l13.210" class="difflineminus">-NS_IMETHODIMP nsImapMailboxSpec::SetAllocatedPathName(const nsACString &amp;aAllocatedPathName)</span>
<a href="#l13.211"></a><span id="l13.211" class="difflineminus">-{</span>
<a href="#l13.212"></a><span id="l13.212" class="difflineplus">+NS_IMETHODIMP nsImapMailboxSpec::SetAllocatedPathName(</span>
<a href="#l13.213"></a><span id="l13.213" class="difflineplus">+    const nsACString &amp;aAllocatedPathName) {</span>
<a href="#l13.214"></a><span id="l13.214">   mAllocatedPathName = aAllocatedPathName;</span>
<a href="#l13.215"></a><span id="l13.215">   return NS_OK;</span>
<a href="#l13.216"></a><span id="l13.216"> }</span>
<a href="#l13.217"></a><span id="l13.217"> </span>
<a href="#l13.218"></a><span id="l13.218" class="difflineminus">-NS_IMETHODIMP nsImapMailboxSpec::GetUnicharPathName(nsAString &amp;aUnicharPathName)</span>
<a href="#l13.219"></a><span id="l13.219" class="difflineminus">-{</span>
<a href="#l13.220"></a><span id="l13.220" class="difflineplus">+NS_IMETHODIMP nsImapMailboxSpec::GetUnicharPathName(</span>
<a href="#l13.221"></a><span id="l13.221" class="difflineplus">+    nsAString &amp;aUnicharPathName) {</span>
<a href="#l13.222"></a><span id="l13.222">   aUnicharPathName = mUnicharPathName;</span>
<a href="#l13.223"></a><span id="l13.223">   return NS_OK;</span>
<a href="#l13.224"></a><span id="l13.224"> }</span>
<a href="#l13.225"></a><span id="l13.225"> </span>
<a href="#l13.226"></a><span id="l13.226" class="difflineminus">-NS_IMETHODIMP nsImapMailboxSpec::SetUnicharPathName(const nsAString &amp;aUnicharPathName)</span>
<a href="#l13.227"></a><span id="l13.227" class="difflineminus">-{</span>
<a href="#l13.228"></a><span id="l13.228" class="difflineplus">+NS_IMETHODIMP nsImapMailboxSpec::SetUnicharPathName(</span>
<a href="#l13.229"></a><span id="l13.229" class="difflineplus">+    const nsAString &amp;aUnicharPathName) {</span>
<a href="#l13.230"></a><span id="l13.230">   mUnicharPathName = aUnicharPathName;</span>
<a href="#l13.231"></a><span id="l13.231">   return NS_OK;</span>
<a href="#l13.232"></a><span id="l13.232"> }</span>
<a href="#l13.233"></a><span id="l13.233"> </span>
<a href="#l13.234"></a><span id="l13.234" class="difflineminus">-NS_IMETHODIMP nsImapMailboxSpec::GetHostName(nsACString &amp;aHostName)</span>
<a href="#l13.235"></a><span id="l13.235" class="difflineminus">-{</span>
<a href="#l13.236"></a><span id="l13.236" class="difflineplus">+NS_IMETHODIMP nsImapMailboxSpec::GetHostName(nsACString &amp;aHostName) {</span>
<a href="#l13.237"></a><span id="l13.237">   aHostName = mHostName;</span>
<a href="#l13.238"></a><span id="l13.238">   return NS_OK;</span>
<a href="#l13.239"></a><span id="l13.239"> }</span>
<a href="#l13.240"></a><span id="l13.240"> </span>
<a href="#l13.241"></a><span id="l13.241" class="difflineminus">-NS_IMETHODIMP nsImapMailboxSpec::SetHostName(const nsACString &amp;aHostName)</span>
<a href="#l13.242"></a><span id="l13.242" class="difflineminus">-{</span>
<a href="#l13.243"></a><span id="l13.243" class="difflineplus">+NS_IMETHODIMP nsImapMailboxSpec::SetHostName(const nsACString &amp;aHostName) {</span>
<a href="#l13.244"></a><span id="l13.244">   mHostName = aHostName;</span>
<a href="#l13.245"></a><span id="l13.245">   return NS_OK;</span>
<a href="#l13.246"></a><span id="l13.246"> }</span>
<a href="#l13.247"></a><span id="l13.247"> </span>
<a href="#l13.248"></a><span id="l13.248" class="difflineminus">-NS_IMETHODIMP nsImapMailboxSpec::GetFlagState(nsIImapFlagAndUidState ** aFlagState)</span>
<a href="#l13.249"></a><span id="l13.249" class="difflineminus">-{</span>
<a href="#l13.250"></a><span id="l13.250" class="difflineplus">+NS_IMETHODIMP nsImapMailboxSpec::GetFlagState(</span>
<a href="#l13.251"></a><span id="l13.251" class="difflineplus">+    nsIImapFlagAndUidState **aFlagState) {</span>
<a href="#l13.252"></a><span id="l13.252">   NS_ENSURE_ARG_POINTER(aFlagState);</span>
<a href="#l13.253"></a><span id="l13.253">   NS_IF_ADDREF(*aFlagState = mFlagState);</span>
<a href="#l13.254"></a><span id="l13.254">   return NS_OK;</span>
<a href="#l13.255"></a><span id="l13.255"> }</span>
<a href="#l13.256"></a><span id="l13.256"> </span>
<a href="#l13.257"></a><span id="l13.257" class="difflineminus">-NS_IMETHODIMP nsImapMailboxSpec::SetFlagState(nsIImapFlagAndUidState * aFlagState)</span>
<a href="#l13.258"></a><span id="l13.258" class="difflineminus">-{</span>
<a href="#l13.259"></a><span id="l13.259" class="difflineplus">+NS_IMETHODIMP nsImapMailboxSpec::SetFlagState(</span>
<a href="#l13.260"></a><span id="l13.260" class="difflineplus">+    nsIImapFlagAndUidState *aFlagState) {</span>
<a href="#l13.261"></a><span id="l13.261">   NS_ENSURE_ARG_POINTER(aFlagState);</span>
<a href="#l13.262"></a><span id="l13.262">   mFlagState = aFlagState;</span>
<a href="#l13.263"></a><span id="l13.263">   return NS_OK;</span>
<a href="#l13.264"></a><span id="l13.264"> }</span>
<a href="#l13.265"></a><span id="l13.265"> </span>
<a href="#l13.266"></a><span id="l13.266" class="difflineminus">-nsImapMailboxSpec&amp; nsImapMailboxSpec::operator= (const nsImapMailboxSpec&amp; aCopy)</span>
<a href="#l13.267"></a><span id="l13.267" class="difflineminus">-{</span>
<a href="#l13.268"></a><span id="l13.268" class="difflineplus">+nsImapMailboxSpec &amp;nsImapMailboxSpec::operator=(</span>
<a href="#l13.269"></a><span id="l13.269" class="difflineplus">+    const nsImapMailboxSpec &amp;aCopy) {</span>
<a href="#l13.270"></a><span id="l13.270">   mFolder_UIDVALIDITY = aCopy.mFolder_UIDVALIDITY;</span>
<a href="#l13.271"></a><span id="l13.271">   mHighestModSeq = aCopy.mHighestModSeq;</span>
<a href="#l13.272"></a><span id="l13.272">   mNumOfMessages = aCopy.mNumOfMessages;</span>
<a href="#l13.273"></a><span id="l13.273">   mNumOfUnseenMessages = aCopy.mNumOfUnseenMessages;</span>
<a href="#l13.274"></a><span id="l13.274">   mNumOfRecentMessages = aCopy.mNumOfRecentMessages;</span>
<a href="#l13.275"></a><span id="l13.275"> </span>
<a href="#l13.276"></a><span id="l13.276">   mBoxFlags = aCopy.mBoxFlags;</span>
<a href="#l13.277"></a><span id="l13.277">   mSupportedUserFlags = aCopy.mSupportedUserFlags;</span>
<a href="#l13.278"></a><span id="l13.278" class="difflineat">@@ -232,136 +220,118 @@ nsImapMailboxSpec&amp; nsImapMailboxSpec::op</span>
<a href="#l13.279"></a><span id="l13.279">   mFolderSelected = aCopy.mFolderSelected;</span>
<a href="#l13.280"></a><span id="l13.280">   mDiscoveredFromLsub = aCopy.mDiscoveredFromLsub;</span>
<a href="#l13.281"></a><span id="l13.281"> </span>
<a href="#l13.282"></a><span id="l13.282">   mOnlineVerified = aCopy.mOnlineVerified;</span>
<a href="#l13.283"></a><span id="l13.283"> </span>
<a href="#l13.284"></a><span id="l13.284">   return *this;</span>
<a href="#l13.285"></a><span id="l13.285"> }</span>
<a href="#l13.286"></a><span id="l13.286"> </span>
<a href="#l13.287"></a><span id="l13.287" class="difflineminus">-// use the flagState to determine if the gaps in the msgUids correspond to gaps in the mailbox,</span>
<a href="#l13.288"></a><span id="l13.288" class="difflineminus">-// in which case we can still use ranges. If flagState is null, we won't do this.</span>
<a href="#l13.289"></a><span id="l13.289" class="difflineplus">+// use the flagState to determine if the gaps in the msgUids correspond to gaps</span>
<a href="#l13.290"></a><span id="l13.290" class="difflineplus">+// in the mailbox, in which case we can still use ranges. If flagState is null,</span>
<a href="#l13.291"></a><span id="l13.291" class="difflineplus">+// we won't do this.</span>
<a href="#l13.292"></a><span id="l13.292"> void AllocateImapUidString(uint32_t *msgUids, uint32_t &amp;msgCount,</span>
<a href="#l13.293"></a><span id="l13.293" class="difflineminus">-                           nsImapFlagAndUidState *flagState, nsCString &amp;returnString)</span>
<a href="#l13.294"></a><span id="l13.294" class="difflineminus">-{</span>
<a href="#l13.295"></a><span id="l13.295" class="difflineplus">+                           nsImapFlagAndUidState *flagState,</span>
<a href="#l13.296"></a><span id="l13.296" class="difflineplus">+                           nsCString &amp;returnString) {</span>
<a href="#l13.297"></a><span id="l13.297">   uint32_t startSequence = (msgCount &gt; 0) ? msgUids[0] : 0xFFFFFFFF;</span>
<a href="#l13.298"></a><span id="l13.298">   uint32_t curSequenceEnd = startSequence;</span>
<a href="#l13.299"></a><span id="l13.299">   uint32_t total = msgCount;</span>
<a href="#l13.300"></a><span id="l13.300" class="difflineminus">-  int32_t  curFlagStateIndex = -1;</span>
<a href="#l13.301"></a><span id="l13.301" class="difflineplus">+  int32_t curFlagStateIndex = -1;</span>
<a href="#l13.302"></a><span id="l13.302"> </span>
<a href="#l13.303"></a><span id="l13.303">   // a partial fetch flag state doesn't help us, so don't use it.</span>
<a href="#l13.304"></a><span id="l13.304" class="difflineminus">-  if (flagState &amp;&amp; flagState-&gt;GetPartialUIDFetch())</span>
<a href="#l13.305"></a><span id="l13.305" class="difflineminus">-    flagState = nullptr;</span>
<a href="#l13.306"></a><span id="l13.306" class="difflineminus">-</span>
<a href="#l13.307"></a><span id="l13.307" class="difflineplus">+  if (flagState &amp;&amp; flagState-&gt;GetPartialUIDFetch()) flagState = nullptr;</span>
<a href="#l13.308"></a><span id="l13.308"> </span>
<a href="#l13.309"></a><span id="l13.309" class="difflineminus">-  for (uint32_t keyIndex = 0; keyIndex &lt; total; keyIndex++)</span>
<a href="#l13.310"></a><span id="l13.310" class="difflineminus">-  {</span>
<a href="#l13.311"></a><span id="l13.311" class="difflineplus">+  for (uint32_t keyIndex = 0; keyIndex &lt; total; keyIndex++) {</span>
<a href="#l13.312"></a><span id="l13.312">     uint32_t curKey = msgUids[keyIndex];</span>
<a href="#l13.313"></a><span id="l13.313" class="difflineminus">-    uint32_t nextKey = (keyIndex + 1 &lt; total) ? msgUids[keyIndex + 1] : 0xFFFFFFFF;</span>
<a href="#l13.314"></a><span id="l13.314" class="difflineplus">+    uint32_t nextKey =</span>
<a href="#l13.315"></a><span id="l13.315" class="difflineplus">+        (keyIndex + 1 &lt; total) ? msgUids[keyIndex + 1] : 0xFFFFFFFF;</span>
<a href="#l13.316"></a><span id="l13.316">     bool lastKey = (nextKey == 0xFFFFFFFF);</span>
<a href="#l13.317"></a><span id="l13.317"> </span>
<a href="#l13.318"></a><span id="l13.318" class="difflineminus">-    if (lastKey)</span>
<a href="#l13.319"></a><span id="l13.319" class="difflineminus">-      curSequenceEnd = curKey;</span>
<a href="#l13.320"></a><span id="l13.320" class="difflineplus">+    if (lastKey) curSequenceEnd = curKey;</span>
<a href="#l13.321"></a><span id="l13.321"> </span>
<a href="#l13.322"></a><span id="l13.322" class="difflineminus">-    if (!lastKey)</span>
<a href="#l13.323"></a><span id="l13.323" class="difflineminus">-    {</span>
<a href="#l13.324"></a><span id="l13.324" class="difflineminus">-      if (nextKey == curSequenceEnd + 1)</span>
<a href="#l13.325"></a><span id="l13.325" class="difflineminus">-      {</span>
<a href="#l13.326"></a><span id="l13.326" class="difflineplus">+    if (!lastKey) {</span>
<a href="#l13.327"></a><span id="l13.327" class="difflineplus">+      if (nextKey == curSequenceEnd + 1) {</span>
<a href="#l13.328"></a><span id="l13.328">         curSequenceEnd = nextKey;</span>
<a href="#l13.329"></a><span id="l13.329">         curFlagStateIndex++;</span>
<a href="#l13.330"></a><span id="l13.330">         continue;</span>
<a href="#l13.331"></a><span id="l13.331">       }</span>
<a href="#l13.332"></a><span id="l13.332" class="difflineminus">-      if (flagState)</span>
<a href="#l13.333"></a><span id="l13.333" class="difflineminus">-      {</span>
<a href="#l13.334"></a><span id="l13.334" class="difflineminus">-        if (curFlagStateIndex == -1)</span>
<a href="#l13.335"></a><span id="l13.335" class="difflineminus">-        {</span>
<a href="#l13.336"></a><span id="l13.336" class="difflineplus">+      if (flagState) {</span>
<a href="#l13.337"></a><span id="l13.337" class="difflineplus">+        if (curFlagStateIndex == -1) {</span>
<a href="#l13.338"></a><span id="l13.338">           bool foundIt;</span>
<a href="#l13.339"></a><span id="l13.339" class="difflineminus">-          flagState-&gt;GetMessageFlagsFromUID(curSequenceEnd, &amp;foundIt, &amp;curFlagStateIndex);</span>
<a href="#l13.340"></a><span id="l13.340" class="difflineminus">-          if (!foundIt)</span>
<a href="#l13.341"></a><span id="l13.341" class="difflineminus">-          {</span>
<a href="#l13.342"></a><span id="l13.342" class="difflineplus">+          flagState-&gt;GetMessageFlagsFromUID(curSequenceEnd, &amp;foundIt,</span>
<a href="#l13.343"></a><span id="l13.343" class="difflineplus">+                                            &amp;curFlagStateIndex);</span>
<a href="#l13.344"></a><span id="l13.344" class="difflineplus">+          if (!foundIt) {</span>
<a href="#l13.345"></a><span id="l13.345">             NS_WARNING(&quot;flag state missing key&quot;);</span>
<a href="#l13.346"></a><span id="l13.346">             // The start of this sequence is missing from flag state, so move</span>
<a href="#l13.347"></a><span id="l13.347">             // on to the next key.</span>
<a href="#l13.348"></a><span id="l13.348">             curFlagStateIndex = -1;</span>
<a href="#l13.349"></a><span id="l13.349">             curSequenceEnd = startSequence = nextKey;</span>
<a href="#l13.350"></a><span id="l13.350">             continue;</span>
<a href="#l13.351"></a><span id="l13.351">           }</span>
<a href="#l13.352"></a><span id="l13.352">         }</span>
<a href="#l13.353"></a><span id="l13.353">         curFlagStateIndex++;</span>
<a href="#l13.354"></a><span id="l13.354">         uint32_t nextUidInFlagState;</span>
<a href="#l13.355"></a><span id="l13.355" class="difflineminus">-        nsresult rv = flagState-&gt;GetUidOfMessage(curFlagStateIndex, &amp;nextUidInFlagState);</span>
<a href="#l13.356"></a><span id="l13.356" class="difflineminus">-        if (NS_SUCCEEDED(rv) &amp;&amp; nextUidInFlagState == nextKey)</span>
<a href="#l13.357"></a><span id="l13.357" class="difflineminus">-        {</span>
<a href="#l13.358"></a><span id="l13.358" class="difflineplus">+        nsresult rv =</span>
<a href="#l13.359"></a><span id="l13.359" class="difflineplus">+            flagState-&gt;GetUidOfMessage(curFlagStateIndex, &amp;nextUidInFlagState);</span>
<a href="#l13.360"></a><span id="l13.360" class="difflineplus">+        if (NS_SUCCEEDED(rv) &amp;&amp; nextUidInFlagState == nextKey) {</span>
<a href="#l13.361"></a><span id="l13.361">           curSequenceEnd = nextKey;</span>
<a href="#l13.362"></a><span id="l13.362">           continue;</span>
<a href="#l13.363"></a><span id="l13.363">         }</span>
<a href="#l13.364"></a><span id="l13.364">       }</span>
<a href="#l13.365"></a><span id="l13.365">     }</span>
<a href="#l13.366"></a><span id="l13.366" class="difflineminus">-    if (curSequenceEnd &gt; startSequence)</span>
<a href="#l13.367"></a><span id="l13.367" class="difflineminus">-    {</span>
<a href="#l13.368"></a><span id="l13.368" class="difflineminus">-      returnString.AppendInt((int64_t) startSequence);</span>
<a href="#l13.369"></a><span id="l13.369" class="difflineplus">+    if (curSequenceEnd &gt; startSequence) {</span>
<a href="#l13.370"></a><span id="l13.370" class="difflineplus">+      returnString.AppendInt((int64_t)startSequence);</span>
<a href="#l13.371"></a><span id="l13.371">       returnString += ':';</span>
<a href="#l13.372"></a><span id="l13.372" class="difflineminus">-      returnString.AppendInt((int64_t) curSequenceEnd);</span>
<a href="#l13.373"></a><span id="l13.373" class="difflineplus">+      returnString.AppendInt((int64_t)curSequenceEnd);</span>
<a href="#l13.374"></a><span id="l13.374">       startSequence = nextKey;</span>
<a href="#l13.375"></a><span id="l13.375">       curSequenceEnd = startSequence;</span>
<a href="#l13.376"></a><span id="l13.376">       curFlagStateIndex = -1;</span>
<a href="#l13.377"></a><span id="l13.377" class="difflineminus">-    }</span>
<a href="#l13.378"></a><span id="l13.378" class="difflineminus">-    else</span>
<a href="#l13.379"></a><span id="l13.379" class="difflineminus">-    {</span>
<a href="#l13.380"></a><span id="l13.380" class="difflineplus">+    } else {</span>
<a href="#l13.381"></a><span id="l13.381">       startSequence = nextKey;</span>
<a href="#l13.382"></a><span id="l13.382">       curSequenceEnd = startSequence;</span>
<a href="#l13.383"></a><span id="l13.383" class="difflineminus">-      returnString.AppendInt((int64_t) msgUids[keyIndex]);</span>
<a href="#l13.384"></a><span id="l13.384" class="difflineplus">+      returnString.AppendInt((int64_t)msgUids[keyIndex]);</span>
<a href="#l13.385"></a><span id="l13.385">       curFlagStateIndex = -1;</span>
<a href="#l13.386"></a><span id="l13.386">     }</span>
<a href="#l13.387"></a><span id="l13.387">     // check if we've generated too long a string - if there's no flag state,</span>
<a href="#l13.388"></a><span id="l13.388">     // it means we just need to go ahead and generate a too long string</span>
<a href="#l13.389"></a><span id="l13.389">     // because the calling code won't handle breaking up the strings.</span>
<a href="#l13.390"></a><span id="l13.390" class="difflineminus">-    if (flagState &amp;&amp; returnString.Length() &gt; 950)</span>
<a href="#l13.391"></a><span id="l13.391" class="difflineminus">-    {</span>
<a href="#l13.392"></a><span id="l13.392" class="difflineplus">+    if (flagState &amp;&amp; returnString.Length() &gt; 950) {</span>
<a href="#l13.393"></a><span id="l13.393">       msgCount = keyIndex;</span>
<a href="#l13.394"></a><span id="l13.394">       break;</span>
<a href="#l13.395"></a><span id="l13.395">     }</span>
<a href="#l13.396"></a><span id="l13.396">     // If we are not the last item then we need to add the comma</span>
<a href="#l13.397"></a><span id="l13.397">     // but it's important we do it here, after the length check</span>
<a href="#l13.398"></a><span id="l13.398" class="difflineminus">-    if (!lastKey)</span>
<a href="#l13.399"></a><span id="l13.399" class="difflineminus">-      returnString += ',';</span>
<a href="#l13.400"></a><span id="l13.400" class="difflineplus">+    if (!lastKey) returnString += ',';</span>
<a href="#l13.401"></a><span id="l13.401">   }</span>
<a href="#l13.402"></a><span id="l13.402"> }</span>
<a href="#l13.403"></a><span id="l13.403"> </span>
<a href="#l13.404"></a><span id="l13.404" class="difflineminus">-void ParseUidString(const char *uidString, nsTArray&lt;nsMsgKey&gt; &amp;keys)</span>
<a href="#l13.405"></a><span id="l13.405" class="difflineminus">-{</span>
<a href="#l13.406"></a><span id="l13.406" class="difflineplus">+void ParseUidString(const char *uidString, nsTArray&lt;nsMsgKey&gt; &amp;keys) {</span>
<a href="#l13.407"></a><span id="l13.407">   // This is in the form &lt;id&gt;,&lt;id&gt;, or &lt;id1&gt;:&lt;id2&gt;</span>
<a href="#l13.408"></a><span id="l13.408" class="difflineminus">-  if (!uidString)</span>
<a href="#l13.409"></a><span id="l13.409" class="difflineminus">-    return;</span>
<a href="#l13.410"></a><span id="l13.410" class="difflineplus">+  if (!uidString) return;</span>
<a href="#l13.411"></a><span id="l13.411"> </span>
<a href="#l13.412"></a><span id="l13.412">   char curChar = *uidString;</span>
<a href="#l13.413"></a><span id="l13.413">   bool isRange = false;</span>
<a href="#l13.414"></a><span id="l13.414">   uint32_t curToken;</span>
<a href="#l13.415"></a><span id="l13.415">   uint32_t saveStartToken = 0;</span>
<a href="#l13.416"></a><span id="l13.416"> </span>
<a href="#l13.417"></a><span id="l13.417" class="difflineminus">-  for (const char *curCharPtr = uidString; curChar &amp;&amp; *curCharPtr;)</span>
<a href="#l13.418"></a><span id="l13.418" class="difflineminus">-  {</span>
<a href="#l13.419"></a><span id="l13.419" class="difflineplus">+  for (const char *curCharPtr = uidString; curChar &amp;&amp; *curCharPtr;) {</span>
<a href="#l13.420"></a><span id="l13.420">     const char *currentKeyToken = curCharPtr;</span>
<a href="#l13.421"></a><span id="l13.421">     curChar = *curCharPtr;</span>
<a href="#l13.422"></a><span id="l13.422">     while (curChar != ':' &amp;&amp; curChar != ',' &amp;&amp; curChar != '\0')</span>
<a href="#l13.423"></a><span id="l13.423">       curChar = *curCharPtr++;</span>
<a href="#l13.424"></a><span id="l13.424"> </span>
<a href="#l13.425"></a><span id="l13.425">     // we don't need to null terminate currentKeyToken because strtoul</span>
<a href="#l13.426"></a><span id="l13.426">     // stops at non-numeric chars.</span>
<a href="#l13.427"></a><span id="l13.427">     curToken = strtoul(currentKeyToken, nullptr, 10);</span>
<a href="#l13.428"></a><span id="l13.428" class="difflineminus">-    if (isRange)</span>
<a href="#l13.429"></a><span id="l13.429" class="difflineminus">-    {</span>
<a href="#l13.430"></a><span id="l13.430" class="difflineminus">-      while (saveStartToken &lt; curToken)</span>
<a href="#l13.431"></a><span id="l13.431" class="difflineminus">-        keys.AppendElement(saveStartToken++);</span>
<a href="#l13.432"></a><span id="l13.432" class="difflineplus">+    if (isRange) {</span>
<a href="#l13.433"></a><span id="l13.433" class="difflineplus">+      while (saveStartToken &lt; curToken) keys.AppendElement(saveStartToken++);</span>
<a href="#l13.434"></a><span id="l13.434">     }</span>
<a href="#l13.435"></a><span id="l13.435">     keys.AppendElement(curToken);</span>
<a href="#l13.436"></a><span id="l13.436">     isRange = (curChar == ':');</span>
<a href="#l13.437"></a><span id="l13.437" class="difflineminus">-    if (isRange)</span>
<a href="#l13.438"></a><span id="l13.438" class="difflineminus">-      saveStartToken = curToken + 1;</span>
<a href="#l13.439"></a><span id="l13.439" class="difflineplus">+    if (isRange) saveStartToken = curToken + 1;</span>
<a href="#l13.440"></a><span id="l13.440">   }</span>
<a href="#l13.441"></a><span id="l13.441"> }</span>
<a href="#l13.442"></a><span id="l13.442"> </span>
<a href="#l13.443"></a><span id="l13.443" class="difflineminus">-void AppendUid(nsCString &amp;msgIds, uint32_t uid)</span>
<a href="#l13.444"></a><span id="l13.444" class="difflineminus">-{</span>
<a href="#l13.445"></a><span id="l13.445" class="difflineplus">+void AppendUid(nsCString &amp;msgIds, uint32_t uid) {</span>
<a href="#l13.446"></a><span id="l13.446">   char buf[20];</span>
<a href="#l13.447"></a><span id="l13.447">   PR_snprintf(buf, sizeof(buf), &quot;%u&quot;, uid);</span>
<a href="#l13.448"></a><span id="l13.448">   msgIds.Append(buf);</span>
<a href="#l13.449"></a><span id="l13.449"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mailnews/imap/src/nsImapUtils.h</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapUtils.h</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -16,61 +16,61 @@ class nsImapFlagAndUidState;</span>
<a href="#l14.4"></a><span id="l14.4"> class nsImapProtocol;</span>
<a href="#l14.5"></a><span id="l14.5"> </span>
<a href="#l14.6"></a><span id="l14.6"> static const char kImapRootURI[] = &quot;imap:/&quot;;</span>
<a href="#l14.7"></a><span id="l14.7"> static const char kImapMessageRootURI[] = &quot;imap-message:/&quot;;</span>
<a href="#l14.8"></a><span id="l14.8"> static const char kModSeqPropertyName[] = &quot;highestModSeq&quot;;</span>
<a href="#l14.9"></a><span id="l14.9"> static const char kHighestRecordedUIDPropertyName[] = &quot;highestRecordedUID&quot;;</span>
<a href="#l14.10"></a><span id="l14.10"> static const char kDeletedHdrCountPropertyName[] = &quot;numDeletedHeaders&quot;;</span>
<a href="#l14.11"></a><span id="l14.11"> </span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-extern nsresult</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineminus">-nsImapURI2FullName(const char* rootURI, const char* hostname, const char* uriStr,</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineminus">-                   char **name);</span>
<a href="#l14.15"></a><span id="l14.15" class="difflineplus">+extern nsresult nsImapURI2FullName(const char *rootURI, const char *hostname,</span>
<a href="#l14.16"></a><span id="l14.16" class="difflineplus">+                                   const char *uriStr, char **name);</span>
<a href="#l14.17"></a><span id="l14.17"> </span>
<a href="#l14.18"></a><span id="l14.18" class="difflineminus">-extern nsresult</span>
<a href="#l14.19"></a><span id="l14.19" class="difflineminus">-nsParseImapMessageURI(const char* uri, nsCString&amp; folderURI, uint32_t *key, char **part);</span>
<a href="#l14.20"></a><span id="l14.20" class="difflineplus">+extern nsresult nsParseImapMessageURI(const char *uri, nsCString &amp;folderURI,</span>
<a href="#l14.21"></a><span id="l14.21" class="difflineplus">+                                      uint32_t *key, char **part);</span>
<a href="#l14.22"></a><span id="l14.22"> </span>
<a href="#l14.23"></a><span id="l14.23" class="difflineminus">-extern nsresult</span>
<a href="#l14.24"></a><span id="l14.24" class="difflineminus">-nsBuildImapMessageURI(const char *baseURI, uint32_t key, nsCString&amp; uri);</span>
<a href="#l14.25"></a><span id="l14.25" class="difflineplus">+extern nsresult nsBuildImapMessageURI(const char *baseURI, uint32_t key,</span>
<a href="#l14.26"></a><span id="l14.26" class="difflineplus">+                                      nsCString &amp;uri);</span>
<a href="#l14.27"></a><span id="l14.27"> </span>
<a href="#l14.28"></a><span id="l14.28" class="difflineminus">-extern nsresult</span>
<a href="#l14.29"></a><span id="l14.29" class="difflineminus">-nsCreateImapBaseMessageURI(const nsACString&amp; baseURI, nsCString&amp; baseMessageURI);</span>
<a href="#l14.30"></a><span id="l14.30" class="difflineplus">+extern nsresult nsCreateImapBaseMessageURI(const nsACString &amp;baseURI,</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineplus">+                                           nsCString &amp;baseMessageURI);</span>
<a href="#l14.32"></a><span id="l14.32"> </span>
<a href="#l14.33"></a><span id="l14.33" class="difflineminus">-void AllocateImapUidString(uint32_t *msgUids, uint32_t &amp;msgCount, nsImapFlagAndUidState *flagState, nsCString &amp;returnString);</span>
<a href="#l14.34"></a><span id="l14.34" class="difflineplus">+void AllocateImapUidString(uint32_t *msgUids, uint32_t &amp;msgCount,</span>
<a href="#l14.35"></a><span id="l14.35" class="difflineplus">+                           nsImapFlagAndUidState *flagState,</span>
<a href="#l14.36"></a><span id="l14.36" class="difflineplus">+                           nsCString &amp;returnString);</span>
<a href="#l14.37"></a><span id="l14.37"> void ParseUidString(const char *uidString, nsTArray&lt;nsMsgKey&gt; &amp;keys);</span>
<a href="#l14.38"></a><span id="l14.38"> void AppendUid(nsCString &amp;msgIds, uint32_t uid);</span>
<a href="#l14.39"></a><span id="l14.39"> </span>
<a href="#l14.40"></a><span id="l14.40" class="difflineminus">-class nsImapMailboxSpec : public nsIMailboxSpec</span>
<a href="#l14.41"></a><span id="l14.41" class="difflineminus">-{</span>
<a href="#l14.42"></a><span id="l14.42" class="difflineminus">-public:</span>
<a href="#l14.43"></a><span id="l14.43" class="difflineplus">+class nsImapMailboxSpec : public nsIMailboxSpec {</span>
<a href="#l14.44"></a><span id="l14.44" class="difflineplus">+ public:</span>
<a href="#l14.45"></a><span id="l14.45">   nsImapMailboxSpec();</span>
<a href="#l14.46"></a><span id="l14.46"> </span>
<a href="#l14.47"></a><span id="l14.47">   NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l14.48"></a><span id="l14.48">   NS_DECL_NSIMAILBOXSPEC</span>
<a href="#l14.49"></a><span id="l14.49"> </span>
<a href="#l14.50"></a><span id="l14.50" class="difflineminus">-  nsImapMailboxSpec&amp; operator= (const nsImapMailboxSpec&amp; aCopy);</span>
<a href="#l14.51"></a><span id="l14.51" class="difflineplus">+  nsImapMailboxSpec &amp;operator=(const nsImapMailboxSpec &amp;aCopy);</span>
<a href="#l14.52"></a><span id="l14.52"> </span>
<a href="#l14.53"></a><span id="l14.53">   nsCOMPtr&lt;nsIImapFlagAndUidState&gt; mFlagState;</span>
<a href="#l14.54"></a><span id="l14.54" class="difflineminus">-  nsIMAPNamespace                  *mNamespaceForFolder;</span>
<a href="#l14.55"></a><span id="l14.55" class="difflineplus">+  nsIMAPNamespace *mNamespaceForFolder;</span>
<a href="#l14.56"></a><span id="l14.56"> </span>
<a href="#l14.57"></a><span id="l14.57" class="difflineminus">-  uint32_t  mBoxFlags;</span>
<a href="#l14.58"></a><span id="l14.58" class="difflineminus">-  uint32_t  mSupportedUserFlags;</span>
<a href="#l14.59"></a><span id="l14.59" class="difflineminus">-  int32_t   mFolder_UIDVALIDITY;</span>
<a href="#l14.60"></a><span id="l14.60" class="difflineminus">-  uint64_t  mHighestModSeq;</span>
<a href="#l14.61"></a><span id="l14.61" class="difflineminus">-  int32_t   mNumOfMessages;</span>
<a href="#l14.62"></a><span id="l14.62" class="difflineminus">-  int32_t   mNumOfUnseenMessages;</span>
<a href="#l14.63"></a><span id="l14.63" class="difflineminus">-  int32_t   mNumOfRecentMessages;</span>
<a href="#l14.64"></a><span id="l14.64" class="difflineminus">-  int32_t   mNextUID;</span>
<a href="#l14.65"></a><span id="l14.65" class="difflineplus">+  uint32_t mBoxFlags;</span>
<a href="#l14.66"></a><span id="l14.66" class="difflineplus">+  uint32_t mSupportedUserFlags;</span>
<a href="#l14.67"></a><span id="l14.67" class="difflineplus">+  int32_t mFolder_UIDVALIDITY;</span>
<a href="#l14.68"></a><span id="l14.68" class="difflineplus">+  uint64_t mHighestModSeq;</span>
<a href="#l14.69"></a><span id="l14.69" class="difflineplus">+  int32_t mNumOfMessages;</span>
<a href="#l14.70"></a><span id="l14.70" class="difflineplus">+  int32_t mNumOfUnseenMessages;</span>
<a href="#l14.71"></a><span id="l14.71" class="difflineplus">+  int32_t mNumOfRecentMessages;</span>
<a href="#l14.72"></a><span id="l14.72" class="difflineplus">+  int32_t mNextUID;</span>
<a href="#l14.73"></a><span id="l14.73">   nsCString mAllocatedPathName;</span>
<a href="#l14.74"></a><span id="l14.74">   nsCString mHostName;</span>
<a href="#l14.75"></a><span id="l14.75" class="difflineminus">-  nsString  mUnicharPathName;</span>
<a href="#l14.76"></a><span id="l14.76" class="difflineminus">-  char      mHierarchySeparator;</span>
<a href="#l14.77"></a><span id="l14.77" class="difflineminus">-  bool      mFolderSelected;</span>
<a href="#l14.78"></a><span id="l14.78" class="difflineminus">-  bool      mDiscoveredFromLsub;</span>
<a href="#l14.79"></a><span id="l14.79" class="difflineminus">-  bool      mOnlineVerified;</span>
<a href="#l14.80"></a><span id="l14.80" class="difflineplus">+  nsString mUnicharPathName;</span>
<a href="#l14.81"></a><span id="l14.81" class="difflineplus">+  char mHierarchySeparator;</span>
<a href="#l14.82"></a><span id="l14.82" class="difflineplus">+  bool mFolderSelected;</span>
<a href="#l14.83"></a><span id="l14.83" class="difflineplus">+  bool mDiscoveredFromLsub;</span>
<a href="#l14.84"></a><span id="l14.84" class="difflineplus">+  bool mOnlineVerified;</span>
<a href="#l14.85"></a><span id="l14.85"> </span>
<a href="#l14.86"></a><span id="l14.86">   nsImapProtocol *mConnection;  // do we need this? It seems evil</span>
<a href="#l14.87"></a><span id="l14.87"> </span>
<a href="#l14.88"></a><span id="l14.88" class="difflineminus">-private:</span>
<a href="#l14.89"></a><span id="l14.89" class="difflineplus">+ private:</span>
<a href="#l14.90"></a><span id="l14.90">   virtual ~nsImapMailboxSpec();</span>
<a href="#l14.91"></a><span id="l14.91"> };</span>
<a href="#l14.92"></a><span id="l14.92"> </span>
<a href="#l14.93"></a><span id="l14.93" class="difflineminus">-#endif //NS_IMAPUTILS_H</span>
<a href="#l14.94"></a><span id="l14.94" class="difflineplus">+#endif  // NS_IMAPUTILS_H</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mailnews/imap/src/nsSyncRunnableHelpers.cpp</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mailnews/imap/src/nsSyncRunnableHelpers.cpp</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -9,363 +9,315 @@</span>
<a href="#l15.4"></a><span id="l15.4"> #include &quot;nsIMsgWindow.h&quot;</span>
<a href="#l15.5"></a><span id="l15.5"> #include &quot;nsIImapMailFolderSink.h&quot;</span>
<a href="#l15.6"></a><span id="l15.6"> </span>
<a href="#l15.7"></a><span id="l15.7"> #include &quot;mozilla/Monitor.h&quot;</span>
<a href="#l15.8"></a><span id="l15.8"> </span>
<a href="#l15.9"></a><span id="l15.9"> NS_IMPL_ISUPPORTS(StreamListenerProxy, nsIStreamListener)</span>
<a href="#l15.10"></a><span id="l15.10"> NS_IMPL_ISUPPORTS(ImapMailFolderSinkProxy, nsIImapMailFolderSink)</span>
<a href="#l15.11"></a><span id="l15.11"> NS_IMPL_ISUPPORTS(ImapServerSinkProxy, nsIImapServerSink)</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-NS_IMPL_ISUPPORTS(ImapMessageSinkProxy,</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineminus">-                              nsIImapMessageSink)</span>
<a href="#l15.14"></a><span id="l15.14" class="difflineminus">-NS_IMPL_ISUPPORTS(ImapProtocolSinkProxy,</span>
<a href="#l15.15"></a><span id="l15.15" class="difflineminus">-                              nsIImapProtocolSink)</span>
<a href="#l15.16"></a><span id="l15.16" class="difflineplus">+NS_IMPL_ISUPPORTS(ImapMessageSinkProxy, nsIImapMessageSink)</span>
<a href="#l15.17"></a><span id="l15.17" class="difflineplus">+NS_IMPL_ISUPPORTS(ImapProtocolSinkProxy, nsIImapProtocolSink)</span>
<a href="#l15.18"></a><span id="l15.18"> namespace {</span>
<a href="#l15.19"></a><span id="l15.19"> </span>
<a href="#l15.20"></a><span id="l15.20"> // Traits class for a reference type, specialized for parameters which are</span>
<a href="#l15.21"></a><span id="l15.21"> // already references.</span>
<a href="#l15.22"></a><span id="l15.22" class="difflineminus">-template&lt;typename T&gt;</span>
<a href="#l15.23"></a><span id="l15.23" class="difflineminus">-struct RefType</span>
<a href="#l15.24"></a><span id="l15.24" class="difflineminus">-{</span>
<a href="#l15.25"></a><span id="l15.25" class="difflineminus">-  typedef T&amp; type;</span>
<a href="#l15.26"></a><span id="l15.26" class="difflineplus">+template &lt;typename T&gt;</span>
<a href="#l15.27"></a><span id="l15.27" class="difflineplus">+struct RefType {</span>
<a href="#l15.28"></a><span id="l15.28" class="difflineplus">+  typedef T &amp;type;</span>
<a href="#l15.29"></a><span id="l15.29"> };</span>
<a href="#l15.30"></a><span id="l15.30"> </span>
<a href="#l15.31"></a><span id="l15.31" class="difflineminus">-template&lt;&gt;</span>
<a href="#l15.32"></a><span id="l15.32" class="difflineminus">-struct RefType&lt;nsAString&amp;&gt;</span>
<a href="#l15.33"></a><span id="l15.33" class="difflineminus">-{</span>
<a href="#l15.34"></a><span id="l15.34" class="difflineminus">-  typedef nsAString&amp; type;</span>
<a href="#l15.35"></a><span id="l15.35" class="difflineplus">+template &lt;&gt;</span>
<a href="#l15.36"></a><span id="l15.36" class="difflineplus">+struct RefType&lt;nsAString &amp;&gt; {</span>
<a href="#l15.37"></a><span id="l15.37" class="difflineplus">+  typedef nsAString &amp;type;</span>
<a href="#l15.38"></a><span id="l15.38"> };</span>
<a href="#l15.39"></a><span id="l15.39"> </span>
<a href="#l15.40"></a><span id="l15.40" class="difflineminus">-template&lt;&gt;</span>
<a href="#l15.41"></a><span id="l15.41" class="difflineminus">-struct RefType&lt;const nsAString&amp;&gt;</span>
<a href="#l15.42"></a><span id="l15.42" class="difflineminus">-{</span>
<a href="#l15.43"></a><span id="l15.43" class="difflineminus">-  typedef const nsAString&amp; type;</span>
<a href="#l15.44"></a><span id="l15.44" class="difflineplus">+template &lt;&gt;</span>
<a href="#l15.45"></a><span id="l15.45" class="difflineplus">+struct RefType&lt;const nsAString &amp;&gt; {</span>
<a href="#l15.46"></a><span id="l15.46" class="difflineplus">+  typedef const nsAString &amp;type;</span>
<a href="#l15.47"></a><span id="l15.47"> };</span>
<a href="#l15.48"></a><span id="l15.48"> </span>
<a href="#l15.49"></a><span id="l15.49" class="difflineminus">-template&lt;&gt;</span>
<a href="#l15.50"></a><span id="l15.50" class="difflineminus">-struct RefType&lt;nsACString&amp;&gt;</span>
<a href="#l15.51"></a><span id="l15.51" class="difflineminus">-{</span>
<a href="#l15.52"></a><span id="l15.52" class="difflineminus">-  typedef nsACString&amp; type;</span>
<a href="#l15.53"></a><span id="l15.53" class="difflineplus">+template &lt;&gt;</span>
<a href="#l15.54"></a><span id="l15.54" class="difflineplus">+struct RefType&lt;nsACString &amp;&gt; {</span>
<a href="#l15.55"></a><span id="l15.55" class="difflineplus">+  typedef nsACString &amp;type;</span>
<a href="#l15.56"></a><span id="l15.56"> };</span>
<a href="#l15.57"></a><span id="l15.57"> </span>
<a href="#l15.58"></a><span id="l15.58" class="difflineminus">-template&lt;&gt;</span>
<a href="#l15.59"></a><span id="l15.59" class="difflineminus">-struct RefType&lt;const nsACString&amp;&gt;</span>
<a href="#l15.60"></a><span id="l15.60" class="difflineminus">-{</span>
<a href="#l15.61"></a><span id="l15.61" class="difflineminus">-  typedef const nsACString&amp; type;</span>
<a href="#l15.62"></a><span id="l15.62" class="difflineplus">+template &lt;&gt;</span>
<a href="#l15.63"></a><span id="l15.63" class="difflineplus">+struct RefType&lt;const nsACString &amp;&gt; {</span>
<a href="#l15.64"></a><span id="l15.64" class="difflineplus">+  typedef const nsACString &amp;type;</span>
<a href="#l15.65"></a><span id="l15.65"> };</span>
<a href="#l15.66"></a><span id="l15.66"> </span>
<a href="#l15.67"></a><span id="l15.67" class="difflineminus">-template&lt;&gt;</span>
<a href="#l15.68"></a><span id="l15.68" class="difflineminus">-struct RefType&lt;const nsIID&amp;&gt;</span>
<a href="#l15.69"></a><span id="l15.69" class="difflineminus">-{</span>
<a href="#l15.70"></a><span id="l15.70" class="difflineminus">-  typedef const nsIID&amp; type;</span>
<a href="#l15.71"></a><span id="l15.71" class="difflineplus">+template &lt;&gt;</span>
<a href="#l15.72"></a><span id="l15.72" class="difflineplus">+struct RefType&lt;const nsIID &amp;&gt; {</span>
<a href="#l15.73"></a><span id="l15.73" class="difflineplus">+  typedef const nsIID &amp;type;</span>
<a href="#l15.74"></a><span id="l15.74"> };</span>
<a href="#l15.75"></a><span id="l15.75"> </span>
<a href="#l15.76"></a><span id="l15.76" class="difflineminus">-class SyncRunnableBase : public mozilla::Runnable</span>
<a href="#l15.77"></a><span id="l15.77" class="difflineminus">-{</span>
<a href="#l15.78"></a><span id="l15.78" class="difflineminus">-public:</span>
<a href="#l15.79"></a><span id="l15.79" class="difflineminus">-  nsresult Result() {</span>
<a href="#l15.80"></a><span id="l15.80" class="difflineminus">-    return mResult;</span>
<a href="#l15.81"></a><span id="l15.81" class="difflineminus">-  }</span>
<a href="#l15.82"></a><span id="l15.82" class="difflineplus">+class SyncRunnableBase : public mozilla::Runnable {</span>
<a href="#l15.83"></a><span id="l15.83" class="difflineplus">+ public:</span>
<a href="#l15.84"></a><span id="l15.84" class="difflineplus">+  nsresult Result() { return mResult; }</span>
<a href="#l15.85"></a><span id="l15.85" class="difflineplus">+</span>
<a href="#l15.86"></a><span id="l15.86" class="difflineplus">+  mozilla::Monitor &amp;Monitor() { return mMonitor; }</span>
<a href="#l15.87"></a><span id="l15.87"> </span>
<a href="#l15.88"></a><span id="l15.88" class="difflineminus">-  mozilla::Monitor&amp; Monitor() {</span>
<a href="#l15.89"></a><span id="l15.89" class="difflineminus">-    return mMonitor;</span>
<a href="#l15.90"></a><span id="l15.90" class="difflineminus">-  }</span>
<a href="#l15.91"></a><span id="l15.91" class="difflineminus">-</span>
<a href="#l15.92"></a><span id="l15.92" class="difflineminus">-protected:</span>
<a href="#l15.93"></a><span id="l15.93" class="difflineplus">+ protected:</span>
<a href="#l15.94"></a><span id="l15.94">   SyncRunnableBase()</span>
<a href="#l15.95"></a><span id="l15.95" class="difflineminus">-    : mozilla::Runnable(&quot;SyncRunnableBase&quot;)</span>
<a href="#l15.96"></a><span id="l15.96" class="difflineminus">-    , mResult(NS_ERROR_UNEXPECTED)</span>
<a href="#l15.97"></a><span id="l15.97" class="difflineminus">-    , mMonitor(&quot;SyncRunnableBase&quot;)</span>
<a href="#l15.98"></a><span id="l15.98" class="difflineminus">-  { }</span>
<a href="#l15.99"></a><span id="l15.99" class="difflineplus">+      : mozilla::Runnable(&quot;SyncRunnableBase&quot;),</span>
<a href="#l15.100"></a><span id="l15.100" class="difflineplus">+        mResult(NS_ERROR_UNEXPECTED),</span>
<a href="#l15.101"></a><span id="l15.101" class="difflineplus">+        mMonitor(&quot;SyncRunnableBase&quot;) {}</span>
<a href="#l15.102"></a><span id="l15.102"> </span>
<a href="#l15.103"></a><span id="l15.103">   nsresult mResult;</span>
<a href="#l15.104"></a><span id="l15.104">   mozilla::Monitor mMonitor;</span>
<a href="#l15.105"></a><span id="l15.105"> };</span>
<a href="#l15.106"></a><span id="l15.106"> </span>
<a href="#l15.107"></a><span id="l15.107" class="difflineminus">-template&lt;typename Receiver&gt;</span>
<a href="#l15.108"></a><span id="l15.108" class="difflineminus">-class SyncRunnable0 : public SyncRunnableBase</span>
<a href="#l15.109"></a><span id="l15.109" class="difflineminus">-{</span>
<a href="#l15.110"></a><span id="l15.110" class="difflineminus">-public:</span>
<a href="#l15.111"></a><span id="l15.111" class="difflineplus">+template &lt;typename Receiver&gt;</span>
<a href="#l15.112"></a><span id="l15.112" class="difflineplus">+class SyncRunnable0 : public SyncRunnableBase {</span>
<a href="#l15.113"></a><span id="l15.113" class="difflineplus">+ public:</span>
<a href="#l15.114"></a><span id="l15.114">   typedef nsresult (NS_STDCALL Receiver::*ReceiverMethod)();</span>
<a href="#l15.115"></a><span id="l15.115"> </span>
<a href="#l15.116"></a><span id="l15.116" class="difflineminus">-  SyncRunnable0(Receiver* receiver, ReceiverMethod method)</span>
<a href="#l15.117"></a><span id="l15.117" class="difflineminus">-    : mReceiver(receiver)</span>
<a href="#l15.118"></a><span id="l15.118" class="difflineminus">-    , mMethod(method)</span>
<a href="#l15.119"></a><span id="l15.119" class="difflineminus">-  { }</span>
<a href="#l15.120"></a><span id="l15.120" class="difflineplus">+  SyncRunnable0(Receiver *receiver, ReceiverMethod method)</span>
<a href="#l15.121"></a><span id="l15.121" class="difflineplus">+      : mReceiver(receiver), mMethod(method) {}</span>
<a href="#l15.122"></a><span id="l15.122"> </span>
<a href="#l15.123"></a><span id="l15.123">   NS_IMETHOD Run() {</span>
<a href="#l15.124"></a><span id="l15.124">     mResult = (mReceiver-&gt;*mMethod)();</span>
<a href="#l15.125"></a><span id="l15.125">     mozilla::MonitorAutoLock(mMonitor).Notify();</span>
<a href="#l15.126"></a><span id="l15.126">     return NS_OK;</span>
<a href="#l15.127"></a><span id="l15.127">   }</span>
<a href="#l15.128"></a><span id="l15.128"> </span>
<a href="#l15.129"></a><span id="l15.129" class="difflineminus">-private:</span>
<a href="#l15.130"></a><span id="l15.130" class="difflineminus">-  Receiver* mReceiver;</span>
<a href="#l15.131"></a><span id="l15.131" class="difflineplus">+ private:</span>
<a href="#l15.132"></a><span id="l15.132" class="difflineplus">+  Receiver *mReceiver;</span>
<a href="#l15.133"></a><span id="l15.133">   ReceiverMethod mMethod;</span>
<a href="#l15.134"></a><span id="l15.134"> };</span>
<a href="#l15.135"></a><span id="l15.135"> </span>
<a href="#l15.136"></a><span id="l15.136" class="difflineminus">-</span>
<a href="#l15.137"></a><span id="l15.137" class="difflineminus">-template&lt;typename Receiver, typename Arg1&gt;</span>
<a href="#l15.138"></a><span id="l15.138" class="difflineminus">-class SyncRunnable1 : public SyncRunnableBase</span>
<a href="#l15.139"></a><span id="l15.139" class="difflineminus">-{</span>
<a href="#l15.140"></a><span id="l15.140" class="difflineminus">-public:</span>
<a href="#l15.141"></a><span id="l15.141" class="difflineplus">+template &lt;typename Receiver, typename Arg1&gt;</span>
<a href="#l15.142"></a><span id="l15.142" class="difflineplus">+class SyncRunnable1 : public SyncRunnableBase {</span>
<a href="#l15.143"></a><span id="l15.143" class="difflineplus">+ public:</span>
<a href="#l15.144"></a><span id="l15.144">   typedef nsresult (NS_STDCALL Receiver::*ReceiverMethod)(Arg1);</span>
<a href="#l15.145"></a><span id="l15.145">   typedef typename RefType&lt;Arg1&gt;::type Arg1Ref;</span>
<a href="#l15.146"></a><span id="l15.146"> </span>
<a href="#l15.147"></a><span id="l15.147" class="difflineminus">-  SyncRunnable1(Receiver* receiver, ReceiverMethod method,</span>
<a href="#l15.148"></a><span id="l15.148" class="difflineminus">-                Arg1Ref arg1)</span>
<a href="#l15.149"></a><span id="l15.149" class="difflineminus">-    : mReceiver(receiver)</span>
<a href="#l15.150"></a><span id="l15.150" class="difflineminus">-    , mMethod(method)</span>
<a href="#l15.151"></a><span id="l15.151" class="difflineminus">-    , mArg1(arg1)</span>
<a href="#l15.152"></a><span id="l15.152" class="difflineminus">-  { }</span>
<a href="#l15.153"></a><span id="l15.153" class="difflineplus">+  SyncRunnable1(Receiver *receiver, ReceiverMethod method, Arg1Ref arg1)</span>
<a href="#l15.154"></a><span id="l15.154" class="difflineplus">+      : mReceiver(receiver), mMethod(method), mArg1(arg1) {}</span>
<a href="#l15.155"></a><span id="l15.155"> </span>
<a href="#l15.156"></a><span id="l15.156">   NS_IMETHOD Run() {</span>
<a href="#l15.157"></a><span id="l15.157">     mResult = (mReceiver-&gt;*mMethod)(mArg1);</span>
<a href="#l15.158"></a><span id="l15.158">     mozilla::MonitorAutoLock(mMonitor).Notify();</span>
<a href="#l15.159"></a><span id="l15.159">     return NS_OK;</span>
<a href="#l15.160"></a><span id="l15.160">   }</span>
<a href="#l15.161"></a><span id="l15.161"> </span>
<a href="#l15.162"></a><span id="l15.162" class="difflineminus">-private:</span>
<a href="#l15.163"></a><span id="l15.163" class="difflineminus">-  Receiver* mReceiver;</span>
<a href="#l15.164"></a><span id="l15.164" class="difflineplus">+ private:</span>
<a href="#l15.165"></a><span id="l15.165" class="difflineplus">+  Receiver *mReceiver;</span>
<a href="#l15.166"></a><span id="l15.166">   ReceiverMethod mMethod;</span>
<a href="#l15.167"></a><span id="l15.167">   Arg1Ref mArg1;</span>
<a href="#l15.168"></a><span id="l15.168"> };</span>
<a href="#l15.169"></a><span id="l15.169"> </span>
<a href="#l15.170"></a><span id="l15.170" class="difflineminus">-template&lt;typename Receiver, typename Arg1, typename Arg2&gt;</span>
<a href="#l15.171"></a><span id="l15.171" class="difflineminus">-class SyncRunnable2 : public SyncRunnableBase</span>
<a href="#l15.172"></a><span id="l15.172" class="difflineminus">-{</span>
<a href="#l15.173"></a><span id="l15.173" class="difflineminus">-public:</span>
<a href="#l15.174"></a><span id="l15.174" class="difflineplus">+template &lt;typename Receiver, typename Arg1, typename Arg2&gt;</span>
<a href="#l15.175"></a><span id="l15.175" class="difflineplus">+class SyncRunnable2 : public SyncRunnableBase {</span>
<a href="#l15.176"></a><span id="l15.176" class="difflineplus">+ public:</span>
<a href="#l15.177"></a><span id="l15.177">   typedef nsresult (NS_STDCALL Receiver::*ReceiverMethod)(Arg1, Arg2);</span>
<a href="#l15.178"></a><span id="l15.178">   typedef typename RefType&lt;Arg1&gt;::type Arg1Ref;</span>
<a href="#l15.179"></a><span id="l15.179">   typedef typename RefType&lt;Arg2&gt;::type Arg2Ref;</span>
<a href="#l15.180"></a><span id="l15.180"> </span>
<a href="#l15.181"></a><span id="l15.181" class="difflineminus">-  SyncRunnable2(Receiver* receiver, ReceiverMethod method,</span>
<a href="#l15.182"></a><span id="l15.182" class="difflineminus">-                Arg1Ref arg1, Arg2Ref arg2)</span>
<a href="#l15.183"></a><span id="l15.183" class="difflineminus">-    : mReceiver(receiver)</span>
<a href="#l15.184"></a><span id="l15.184" class="difflineminus">-    , mMethod(method)</span>
<a href="#l15.185"></a><span id="l15.185" class="difflineminus">-    , mArg1(arg1)</span>
<a href="#l15.186"></a><span id="l15.186" class="difflineminus">-    , mArg2(arg2)</span>
<a href="#l15.187"></a><span id="l15.187" class="difflineminus">-  { }</span>
<a href="#l15.188"></a><span id="l15.188" class="difflineplus">+  SyncRunnable2(Receiver *receiver, ReceiverMethod method, Arg1Ref arg1,</span>
<a href="#l15.189"></a><span id="l15.189" class="difflineplus">+                Arg2Ref arg2)</span>
<a href="#l15.190"></a><span id="l15.190" class="difflineplus">+      : mReceiver(receiver), mMethod(method), mArg1(arg1), mArg2(arg2) {}</span>
<a href="#l15.191"></a><span id="l15.191"> </span>
<a href="#l15.192"></a><span id="l15.192">   NS_IMETHOD Run() {</span>
<a href="#l15.193"></a><span id="l15.193">     mResult = (mReceiver-&gt;*mMethod)(mArg1, mArg2);</span>
<a href="#l15.194"></a><span id="l15.194">     mozilla::MonitorAutoLock(mMonitor).Notify();</span>
<a href="#l15.195"></a><span id="l15.195">     return NS_OK;</span>
<a href="#l15.196"></a><span id="l15.196">   }</span>
<a href="#l15.197"></a><span id="l15.197"> </span>
<a href="#l15.198"></a><span id="l15.198" class="difflineminus">-private:</span>
<a href="#l15.199"></a><span id="l15.199" class="difflineminus">-  Receiver* mReceiver;</span>
<a href="#l15.200"></a><span id="l15.200" class="difflineplus">+ private:</span>
<a href="#l15.201"></a><span id="l15.201" class="difflineplus">+  Receiver *mReceiver;</span>
<a href="#l15.202"></a><span id="l15.202">   ReceiverMethod mMethod;</span>
<a href="#l15.203"></a><span id="l15.203">   Arg1Ref mArg1;</span>
<a href="#l15.204"></a><span id="l15.204">   Arg2Ref mArg2;</span>
<a href="#l15.205"></a><span id="l15.205"> };</span>
<a href="#l15.206"></a><span id="l15.206"> </span>
<a href="#l15.207"></a><span id="l15.207" class="difflineminus">-template&lt;typename Receiver, typename Arg1, typename Arg2, typename Arg3&gt;</span>
<a href="#l15.208"></a><span id="l15.208" class="difflineminus">-class SyncRunnable3 : public SyncRunnableBase</span>
<a href="#l15.209"></a><span id="l15.209" class="difflineminus">-{</span>
<a href="#l15.210"></a><span id="l15.210" class="difflineminus">-public:</span>
<a href="#l15.211"></a><span id="l15.211" class="difflineplus">+template &lt;typename Receiver, typename Arg1, typename Arg2, typename Arg3&gt;</span>
<a href="#l15.212"></a><span id="l15.212" class="difflineplus">+class SyncRunnable3 : public SyncRunnableBase {</span>
<a href="#l15.213"></a><span id="l15.213" class="difflineplus">+ public:</span>
<a href="#l15.214"></a><span id="l15.214">   typedef nsresult (NS_STDCALL Receiver::*ReceiverMethod)(Arg1, Arg2, Arg3);</span>
<a href="#l15.215"></a><span id="l15.215">   typedef typename RefType&lt;Arg1&gt;::type Arg1Ref;</span>
<a href="#l15.216"></a><span id="l15.216">   typedef typename RefType&lt;Arg2&gt;::type Arg2Ref;</span>
<a href="#l15.217"></a><span id="l15.217">   typedef typename RefType&lt;Arg3&gt;::type Arg3Ref;</span>
<a href="#l15.218"></a><span id="l15.218"> </span>
<a href="#l15.219"></a><span id="l15.219" class="difflineminus">-  SyncRunnable3(Receiver* receiver, ReceiverMethod method,</span>
<a href="#l15.220"></a><span id="l15.220" class="difflineminus">-                Arg1Ref arg1, Arg2Ref arg2, Arg3Ref arg3)</span>
<a href="#l15.221"></a><span id="l15.221" class="difflineminus">-    : mReceiver(receiver)</span>
<a href="#l15.222"></a><span id="l15.222" class="difflineminus">-    , mMethod(method)</span>
<a href="#l15.223"></a><span id="l15.223" class="difflineminus">-    , mArg1(arg1)</span>
<a href="#l15.224"></a><span id="l15.224" class="difflineminus">-    , mArg2(arg2)</span>
<a href="#l15.225"></a><span id="l15.225" class="difflineminus">-    , mArg3(arg3)</span>
<a href="#l15.226"></a><span id="l15.226" class="difflineminus">-  { }</span>
<a href="#l15.227"></a><span id="l15.227" class="difflineplus">+  SyncRunnable3(Receiver *receiver, ReceiverMethod method, Arg1Ref arg1,</span>
<a href="#l15.228"></a><span id="l15.228" class="difflineplus">+                Arg2Ref arg2, Arg3Ref arg3)</span>
<a href="#l15.229"></a><span id="l15.229" class="difflineplus">+      : mReceiver(receiver),</span>
<a href="#l15.230"></a><span id="l15.230" class="difflineplus">+        mMethod(method),</span>
<a href="#l15.231"></a><span id="l15.231" class="difflineplus">+        mArg1(arg1),</span>
<a href="#l15.232"></a><span id="l15.232" class="difflineplus">+        mArg2(arg2),</span>
<a href="#l15.233"></a><span id="l15.233" class="difflineplus">+        mArg3(arg3) {}</span>
<a href="#l15.234"></a><span id="l15.234"> </span>
<a href="#l15.235"></a><span id="l15.235">   NS_IMETHOD Run() {</span>
<a href="#l15.236"></a><span id="l15.236">     mResult = (mReceiver-&gt;*mMethod)(mArg1, mArg2, mArg3);</span>
<a href="#l15.237"></a><span id="l15.237">     mozilla::MonitorAutoLock(mMonitor).Notify();</span>
<a href="#l15.238"></a><span id="l15.238">     return NS_OK;</span>
<a href="#l15.239"></a><span id="l15.239">   }</span>
<a href="#l15.240"></a><span id="l15.240"> </span>
<a href="#l15.241"></a><span id="l15.241" class="difflineminus">-private:</span>
<a href="#l15.242"></a><span id="l15.242" class="difflineminus">-  Receiver* mReceiver;</span>
<a href="#l15.243"></a><span id="l15.243" class="difflineplus">+ private:</span>
<a href="#l15.244"></a><span id="l15.244" class="difflineplus">+  Receiver *mReceiver;</span>
<a href="#l15.245"></a><span id="l15.245">   ReceiverMethod mMethod;</span>
<a href="#l15.246"></a><span id="l15.246">   Arg1Ref mArg1;</span>
<a href="#l15.247"></a><span id="l15.247">   Arg2Ref mArg2;</span>
<a href="#l15.248"></a><span id="l15.248">   Arg3Ref mArg3;</span>
<a href="#l15.249"></a><span id="l15.249"> };</span>
<a href="#l15.250"></a><span id="l15.250"> </span>
<a href="#l15.251"></a><span id="l15.251" class="difflineminus">-template&lt;typename Receiver, typename Arg1, typename Arg2, typename Arg3,</span>
<a href="#l15.252"></a><span id="l15.252" class="difflineminus">-         typename Arg4&gt;</span>
<a href="#l15.253"></a><span id="l15.253" class="difflineminus">-class SyncRunnable4 : public SyncRunnableBase</span>
<a href="#l15.254"></a><span id="l15.254" class="difflineminus">-{</span>
<a href="#l15.255"></a><span id="l15.255" class="difflineminus">-public:</span>
<a href="#l15.256"></a><span id="l15.256" class="difflineminus">-  typedef nsresult (NS_STDCALL Receiver::*ReceiverMethod)(Arg1, Arg2, Arg3, Arg4);</span>
<a href="#l15.257"></a><span id="l15.257" class="difflineplus">+template &lt;typename Receiver, typename Arg1, typename Arg2, typename Arg3,</span>
<a href="#l15.258"></a><span id="l15.258" class="difflineplus">+          typename Arg4&gt;</span>
<a href="#l15.259"></a><span id="l15.259" class="difflineplus">+class SyncRunnable4 : public SyncRunnableBase {</span>
<a href="#l15.260"></a><span id="l15.260" class="difflineplus">+ public:</span>
<a href="#l15.261"></a><span id="l15.261" class="difflineplus">+  typedef nsresult (NS_STDCALL Receiver::*ReceiverMethod)(Arg1, Arg2, Arg3,</span>
<a href="#l15.262"></a><span id="l15.262" class="difflineplus">+                                                          Arg4);</span>
<a href="#l15.263"></a><span id="l15.263">   typedef typename RefType&lt;Arg1&gt;::type Arg1Ref;</span>
<a href="#l15.264"></a><span id="l15.264">   typedef typename RefType&lt;Arg2&gt;::type Arg2Ref;</span>
<a href="#l15.265"></a><span id="l15.265">   typedef typename RefType&lt;Arg3&gt;::type Arg3Ref;</span>
<a href="#l15.266"></a><span id="l15.266">   typedef typename RefType&lt;Arg4&gt;::type Arg4Ref;</span>
<a href="#l15.267"></a><span id="l15.267"> </span>
<a href="#l15.268"></a><span id="l15.268" class="difflineminus">-  SyncRunnable4(Receiver* receiver, ReceiverMethod method,</span>
<a href="#l15.269"></a><span id="l15.269" class="difflineminus">-                Arg1Ref arg1, Arg2Ref arg2, Arg3Ref arg3, Arg4Ref arg4)</span>
<a href="#l15.270"></a><span id="l15.270" class="difflineminus">-    : mReceiver(receiver)</span>
<a href="#l15.271"></a><span id="l15.271" class="difflineminus">-    , mMethod(method)</span>
<a href="#l15.272"></a><span id="l15.272" class="difflineminus">-    , mArg1(arg1)</span>
<a href="#l15.273"></a><span id="l15.273" class="difflineminus">-    , mArg2(arg2)</span>
<a href="#l15.274"></a><span id="l15.274" class="difflineminus">-    , mArg3(arg3)</span>
<a href="#l15.275"></a><span id="l15.275" class="difflineminus">-    , mArg4(arg4)</span>
<a href="#l15.276"></a><span id="l15.276" class="difflineminus">-  { }</span>
<a href="#l15.277"></a><span id="l15.277" class="difflineplus">+  SyncRunnable4(Receiver *receiver, ReceiverMethod method, Arg1Ref arg1,</span>
<a href="#l15.278"></a><span id="l15.278" class="difflineplus">+                Arg2Ref arg2, Arg3Ref arg3, Arg4Ref arg4)</span>
<a href="#l15.279"></a><span id="l15.279" class="difflineplus">+      : mReceiver(receiver),</span>
<a href="#l15.280"></a><span id="l15.280" class="difflineplus">+        mMethod(method),</span>
<a href="#l15.281"></a><span id="l15.281" class="difflineplus">+        mArg1(arg1),</span>
<a href="#l15.282"></a><span id="l15.282" class="difflineplus">+        mArg2(arg2),</span>
<a href="#l15.283"></a><span id="l15.283" class="difflineplus">+        mArg3(arg3),</span>
<a href="#l15.284"></a><span id="l15.284" class="difflineplus">+        mArg4(arg4) {}</span>
<a href="#l15.285"></a><span id="l15.285"> </span>
<a href="#l15.286"></a><span id="l15.286">   NS_IMETHOD Run() {</span>
<a href="#l15.287"></a><span id="l15.287">     mResult = (mReceiver-&gt;*mMethod)(mArg1, mArg2, mArg3, mArg4);</span>
<a href="#l15.288"></a><span id="l15.288">     mozilla::MonitorAutoLock(mMonitor).Notify();</span>
<a href="#l15.289"></a><span id="l15.289">     return NS_OK;</span>
<a href="#l15.290"></a><span id="l15.290">   }</span>
<a href="#l15.291"></a><span id="l15.291"> </span>
<a href="#l15.292"></a><span id="l15.292" class="difflineminus">-private:</span>
<a href="#l15.293"></a><span id="l15.293" class="difflineminus">-  Receiver* mReceiver;</span>
<a href="#l15.294"></a><span id="l15.294" class="difflineplus">+ private:</span>
<a href="#l15.295"></a><span id="l15.295" class="difflineplus">+  Receiver *mReceiver;</span>
<a href="#l15.296"></a><span id="l15.296">   ReceiverMethod mMethod;</span>
<a href="#l15.297"></a><span id="l15.297">   Arg1Ref mArg1;</span>
<a href="#l15.298"></a><span id="l15.298">   Arg2Ref mArg2;</span>
<a href="#l15.299"></a><span id="l15.299">   Arg3Ref mArg3;</span>
<a href="#l15.300"></a><span id="l15.300">   Arg4Ref mArg4;</span>
<a href="#l15.301"></a><span id="l15.301"> };</span>
<a href="#l15.302"></a><span id="l15.302"> </span>
<a href="#l15.303"></a><span id="l15.303" class="difflineminus">-template&lt;typename Receiver, typename Arg1, typename Arg2, typename Arg3,</span>
<a href="#l15.304"></a><span id="l15.304" class="difflineminus">-         typename Arg4, typename Arg5&gt;</span>
<a href="#l15.305"></a><span id="l15.305" class="difflineminus">-class SyncRunnable5 : public SyncRunnableBase</span>
<a href="#l15.306"></a><span id="l15.306" class="difflineminus">-{</span>
<a href="#l15.307"></a><span id="l15.307" class="difflineminus">-public:</span>
<a href="#l15.308"></a><span id="l15.308" class="difflineminus">-  typedef nsresult (NS_STDCALL Receiver::*ReceiverMethod)(Arg1, Arg2, Arg3, Arg4, Arg5);</span>
<a href="#l15.309"></a><span id="l15.309" class="difflineplus">+template &lt;typename Receiver, typename Arg1, typename Arg2, typename Arg3,</span>
<a href="#l15.310"></a><span id="l15.310" class="difflineplus">+          typename Arg4, typename Arg5&gt;</span>
<a href="#l15.311"></a><span id="l15.311" class="difflineplus">+class SyncRunnable5 : public SyncRunnableBase {</span>
<a href="#l15.312"></a><span id="l15.312" class="difflineplus">+ public:</span>
<a href="#l15.313"></a><span id="l15.313" class="difflineplus">+  typedef nsresult (NS_STDCALL Receiver::*ReceiverMethod)(Arg1, Arg2, Arg3,</span>
<a href="#l15.314"></a><span id="l15.314" class="difflineplus">+                                                          Arg4, Arg5);</span>
<a href="#l15.315"></a><span id="l15.315">   typedef typename RefType&lt;Arg1&gt;::type Arg1Ref;</span>
<a href="#l15.316"></a><span id="l15.316">   typedef typename RefType&lt;Arg2&gt;::type Arg2Ref;</span>
<a href="#l15.317"></a><span id="l15.317">   typedef typename RefType&lt;Arg3&gt;::type Arg3Ref;</span>
<a href="#l15.318"></a><span id="l15.318">   typedef typename RefType&lt;Arg4&gt;::type Arg4Ref;</span>
<a href="#l15.319"></a><span id="l15.319">   typedef typename RefType&lt;Arg5&gt;::type Arg5Ref;</span>
<a href="#l15.320"></a><span id="l15.320"> </span>
<a href="#l15.321"></a><span id="l15.321" class="difflineminus">-  SyncRunnable5(Receiver* receiver, ReceiverMethod method,</span>
<a href="#l15.322"></a><span id="l15.322" class="difflineminus">-                Arg1Ref arg1, Arg2Ref arg2, Arg3Ref arg3, Arg4Ref arg4, Arg5Ref arg5)</span>
<a href="#l15.323"></a><span id="l15.323" class="difflineminus">-    : mReceiver(receiver)</span>
<a href="#l15.324"></a><span id="l15.324" class="difflineminus">-    , mMethod(method)</span>
<a href="#l15.325"></a><span id="l15.325" class="difflineminus">-    , mArg1(arg1)</span>
<a href="#l15.326"></a><span id="l15.326" class="difflineminus">-    , mArg2(arg2)</span>
<a href="#l15.327"></a><span id="l15.327" class="difflineminus">-    , mArg3(arg3)</span>
<a href="#l15.328"></a><span id="l15.328" class="difflineminus">-    , mArg4(arg4)</span>
<a href="#l15.329"></a><span id="l15.329" class="difflineminus">-    , mArg5(arg5)</span>
<a href="#l15.330"></a><span id="l15.330" class="difflineminus">-  { }</span>
<a href="#l15.331"></a><span id="l15.331" class="difflineplus">+  SyncRunnable5(Receiver *receiver, ReceiverMethod method, Arg1Ref arg1,</span>
<a href="#l15.332"></a><span id="l15.332" class="difflineplus">+                Arg2Ref arg2, Arg3Ref arg3, Arg4Ref arg4, Arg5Ref arg5)</span>
<a href="#l15.333"></a><span id="l15.333" class="difflineplus">+      : mReceiver(receiver),</span>
<a href="#l15.334"></a><span id="l15.334" class="difflineplus">+        mMethod(method),</span>
<a href="#l15.335"></a><span id="l15.335" class="difflineplus">+        mArg1(arg1),</span>
<a href="#l15.336"></a><span id="l15.336" class="difflineplus">+        mArg2(arg2),</span>
<a href="#l15.337"></a><span id="l15.337" class="difflineplus">+        mArg3(arg3),</span>
<a href="#l15.338"></a><span id="l15.338" class="difflineplus">+        mArg4(arg4),</span>
<a href="#l15.339"></a><span id="l15.339" class="difflineplus">+        mArg5(arg5) {}</span>
<a href="#l15.340"></a><span id="l15.340"> </span>
<a href="#l15.341"></a><span id="l15.341">   NS_IMETHOD Run() {</span>
<a href="#l15.342"></a><span id="l15.342">     mResult = (mReceiver-&gt;*mMethod)(mArg1, mArg2, mArg3, mArg4, mArg5);</span>
<a href="#l15.343"></a><span id="l15.343">     mozilla::MonitorAutoLock(mMonitor).Notify();</span>
<a href="#l15.344"></a><span id="l15.344">     return NS_OK;</span>
<a href="#l15.345"></a><span id="l15.345">   }</span>
<a href="#l15.346"></a><span id="l15.346"> </span>
<a href="#l15.347"></a><span id="l15.347" class="difflineminus">-private:</span>
<a href="#l15.348"></a><span id="l15.348" class="difflineminus">-  Receiver* mReceiver;</span>
<a href="#l15.349"></a><span id="l15.349" class="difflineplus">+ private:</span>
<a href="#l15.350"></a><span id="l15.350" class="difflineplus">+  Receiver *mReceiver;</span>
<a href="#l15.351"></a><span id="l15.351">   ReceiverMethod mMethod;</span>
<a href="#l15.352"></a><span id="l15.352">   Arg1Ref mArg1;</span>
<a href="#l15.353"></a><span id="l15.353">   Arg2Ref mArg2;</span>
<a href="#l15.354"></a><span id="l15.354">   Arg3Ref mArg3;</span>
<a href="#l15.355"></a><span id="l15.355">   Arg4Ref mArg4;</span>
<a href="#l15.356"></a><span id="l15.356">   Arg5Ref mArg5;</span>
<a href="#l15.357"></a><span id="l15.357"> };</span>
<a href="#l15.358"></a><span id="l15.358"> </span>
<a href="#l15.359"></a><span id="l15.359" class="difflineminus">-nsresult</span>
<a href="#l15.360"></a><span id="l15.360" class="difflineminus">-DispatchSyncRunnable(SyncRunnableBase* r)</span>
<a href="#l15.361"></a><span id="l15.361" class="difflineminus">-{</span>
<a href="#l15.362"></a><span id="l15.362" class="difflineplus">+nsresult DispatchSyncRunnable(SyncRunnableBase *r) {</span>
<a href="#l15.363"></a><span id="l15.363">   if (NS_IsMainThread()) {</span>
<a href="#l15.364"></a><span id="l15.364">     r-&gt;Run();</span>
<a href="#l15.365"></a><span id="l15.365" class="difflineminus">-  }</span>
<a href="#l15.366"></a><span id="l15.366" class="difflineminus">-  else {</span>
<a href="#l15.367"></a><span id="l15.367" class="difflineplus">+  } else {</span>
<a href="#l15.368"></a><span id="l15.368">     mozilla::MonitorAutoLock lock(r-&gt;Monitor());</span>
<a href="#l15.369"></a><span id="l15.369">     nsresult rv = NS_DispatchToMainThread(r);</span>
<a href="#l15.370"></a><span id="l15.370" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l15.371"></a><span id="l15.371" class="difflineminus">-      return rv;</span>
<a href="#l15.372"></a><span id="l15.372" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l15.373"></a><span id="l15.373">     lock.Wait();</span>
<a href="#l15.374"></a><span id="l15.374">   }</span>
<a href="#l15.375"></a><span id="l15.375">   return r-&gt;Result();</span>
<a href="#l15.376"></a><span id="l15.376"> }</span>
<a href="#l15.377"></a><span id="l15.377"> </span>
<a href="#l15.378"></a><span id="l15.378" class="difflineminus">-} // anonymous namespace</span>
<a href="#l15.379"></a><span id="l15.379" class="difflineplus">+}  // anonymous namespace</span>
<a href="#l15.380"></a><span id="l15.380"> </span>
<a href="#l15.381"></a><span id="l15.381" class="difflineminus">-#define NS_SYNCRUNNABLEMETHOD0(iface, method)                       \</span>
<a href="#l15.382"></a><span id="l15.382" class="difflineminus">-  NS_IMETHODIMP iface##Proxy::method() {                     \</span>
<a href="#l15.383"></a><span id="l15.383" class="difflineminus">-    RefPtr&lt;SyncRunnableBase&gt; r =                                  \</span>
<a href="#l15.384"></a><span id="l15.384" class="difflineminus">-      new SyncRunnable0&lt;nsI##iface&gt;                           \</span>
<a href="#l15.385"></a><span id="l15.385" class="difflineminus">-      (mReceiver, &amp;nsI##iface::method);                         \</span>
<a href="#l15.386"></a><span id="l15.386" class="difflineminus">-    return DispatchSyncRunnable(r);                                 \</span>
<a href="#l15.387"></a><span id="l15.387" class="difflineplus">+#define NS_SYNCRUNNABLEMETHOD0(iface, method)                          \</span>
<a href="#l15.388"></a><span id="l15.388" class="difflineplus">+  NS_IMETHODIMP iface##Proxy::method() {                               \</span>
<a href="#l15.389"></a><span id="l15.389" class="difflineplus">+    RefPtr&lt;SyncRunnableBase&gt; r =                                       \</span>
<a href="#l15.390"></a><span id="l15.390" class="difflineplus">+        new SyncRunnable0&lt;nsI##iface&gt;(mReceiver, &amp;nsI##iface::method); \</span>
<a href="#l15.391"></a><span id="l15.391" class="difflineplus">+    return DispatchSyncRunnable(r);                                    \</span>
<a href="#l15.392"></a><span id="l15.392">   }</span>
<a href="#l15.393"></a><span id="l15.393"> </span>
<a href="#l15.394"></a><span id="l15.394" class="difflineminus">-</span>
<a href="#l15.395"></a><span id="l15.395" class="difflineminus">-#define NS_SYNCRUNNABLEMETHOD1(iface, method,                       \</span>
<a href="#l15.396"></a><span id="l15.396" class="difflineminus">-                               arg1)                                \</span>
<a href="#l15.397"></a><span id="l15.397" class="difflineminus">-  NS_IMETHODIMP iface##Proxy::method(arg1 a1) {                     \</span>
<a href="#l15.398"></a><span id="l15.398" class="difflineminus">-    RefPtr&lt;SyncRunnableBase&gt; r =                                  \</span>
<a href="#l15.399"></a><span id="l15.399" class="difflineminus">-      new SyncRunnable1&lt;nsI##iface, arg1&gt;                           \</span>
<a href="#l15.400"></a><span id="l15.400" class="difflineminus">-      (mReceiver, &amp;nsI##iface::method, a1);                         \</span>
<a href="#l15.401"></a><span id="l15.401" class="difflineminus">-    return DispatchSyncRunnable(r);                                 \</span>
<a href="#l15.402"></a><span id="l15.402" class="difflineplus">+#define NS_SYNCRUNNABLEMETHOD1(iface, method, arg1)                   \</span>
<a href="#l15.403"></a><span id="l15.403" class="difflineplus">+  NS_IMETHODIMP iface##Proxy::method(arg1 a1) {                       \</span>
<a href="#l15.404"></a><span id="l15.404" class="difflineplus">+    RefPtr&lt;SyncRunnableBase&gt; r = new SyncRunnable1&lt;nsI##iface, arg1&gt;( \</span>
<a href="#l15.405"></a><span id="l15.405" class="difflineplus">+        mReceiver, &amp;nsI##iface::method, a1);                          \</span>
<a href="#l15.406"></a><span id="l15.406" class="difflineplus">+    return DispatchSyncRunnable(r);                                   \</span>
<a href="#l15.407"></a><span id="l15.407">   }</span>
<a href="#l15.408"></a><span id="l15.408"> </span>
<a href="#l15.409"></a><span id="l15.409" class="difflineminus">-#define NS_SYNCRUNNABLEMETHOD2(iface, method,                       \</span>
<a href="#l15.410"></a><span id="l15.410" class="difflineminus">-                               arg1, arg2)                          \</span>
<a href="#l15.411"></a><span id="l15.411" class="difflineminus">-  NS_IMETHODIMP iface##Proxy::method(arg1 a1, arg2 a2) {            \</span>
<a href="#l15.412"></a><span id="l15.412" class="difflineminus">-    RefPtr&lt;SyncRunnableBase&gt; r =                                  \</span>
<a href="#l15.413"></a><span id="l15.413" class="difflineminus">-      new SyncRunnable2&lt;nsI##iface, arg1, arg2&gt;                     \</span>
<a href="#l15.414"></a><span id="l15.414" class="difflineminus">-      (mReceiver, &amp;nsI##iface::method, a1, a2);                     \</span>
<a href="#l15.415"></a><span id="l15.415" class="difflineminus">-    return DispatchSyncRunnable(r);                                 \</span>
<a href="#l15.416"></a><span id="l15.416" class="difflineplus">+#define NS_SYNCRUNNABLEMETHOD2(iface, method, arg1, arg2)                   \</span>
<a href="#l15.417"></a><span id="l15.417" class="difflineplus">+  NS_IMETHODIMP iface##Proxy::method(arg1 a1, arg2 a2) {                    \</span>
<a href="#l15.418"></a><span id="l15.418" class="difflineplus">+    RefPtr&lt;SyncRunnableBase&gt; r = new SyncRunnable2&lt;nsI##iface, arg1, arg2&gt;( \</span>
<a href="#l15.419"></a><span id="l15.419" class="difflineplus">+        mReceiver, &amp;nsI##iface::method, a1, a2);                            \</span>
<a href="#l15.420"></a><span id="l15.420" class="difflineplus">+    return DispatchSyncRunnable(r);                                         \</span>
<a href="#l15.421"></a><span id="l15.421">   }</span>
<a href="#l15.422"></a><span id="l15.422"> </span>
<a href="#l15.423"></a><span id="l15.423" class="difflineminus">-#define NS_SYNCRUNNABLEMETHOD3(iface, method,                       \</span>
<a href="#l15.424"></a><span id="l15.424" class="difflineminus">-                               arg1, arg2, arg3)                    \</span>
<a href="#l15.425"></a><span id="l15.425" class="difflineminus">-  NS_IMETHODIMP iface##Proxy::method(arg1 a1, arg2 a2, arg3 a3) {   \</span>
<a href="#l15.426"></a><span id="l15.426" class="difflineplus">+#define NS_SYNCRUNNABLEMETHOD3(iface, method, arg1, arg2, arg3)   \</span>
<a href="#l15.427"></a><span id="l15.427" class="difflineplus">+  NS_IMETHODIMP iface##Proxy::method(arg1 a1, arg2 a2, arg3 a3) { \</span>
<a href="#l15.428"></a><span id="l15.428">     RefPtr&lt;SyncRunnableBase&gt; r =                                  \</span>
<a href="#l15.429"></a><span id="l15.429" class="difflineminus">-      new SyncRunnable3&lt;nsI##iface, arg1, arg2, arg3&gt;               \</span>
<a href="#l15.430"></a><span id="l15.430" class="difflineminus">-      (mReceiver, &amp;nsI##iface::method,                              \</span>
<a href="#l15.431"></a><span id="l15.431" class="difflineminus">-       a1, a2, a3);                                                 \</span>
<a href="#l15.432"></a><span id="l15.432" class="difflineminus">-    return DispatchSyncRunnable(r);                                 \</span>
<a href="#l15.433"></a><span id="l15.433" class="difflineplus">+        new SyncRunnable3&lt;nsI##iface, arg1, arg2, arg3&gt;(          \</span>
<a href="#l15.434"></a><span id="l15.434" class="difflineplus">+            mReceiver, &amp;nsI##iface::method, a1, a2, a3);          \</span>
<a href="#l15.435"></a><span id="l15.435" class="difflineplus">+    return DispatchSyncRunnable(r);                               \</span>
<a href="#l15.436"></a><span id="l15.436">   }</span>
<a href="#l15.437"></a><span id="l15.437"> </span>
<a href="#l15.438"></a><span id="l15.438" class="difflineminus">-#define NS_SYNCRUNNABLEMETHOD4(iface, method,                       \</span>
<a href="#l15.439"></a><span id="l15.439" class="difflineminus">-                               arg1, arg2, arg3, arg4)              \</span>
<a href="#l15.440"></a><span id="l15.440" class="difflineplus">+#define NS_SYNCRUNNABLEMETHOD4(iface, method, arg1, arg2, arg3, arg4)      \</span>
<a href="#l15.441"></a><span id="l15.441">   NS_IMETHODIMP iface##Proxy::method(arg1 a1, arg2 a2, arg3 a3, arg4 a4) { \</span>
<a href="#l15.442"></a><span id="l15.442" class="difflineminus">-    RefPtr&lt;SyncRunnableBase&gt; r =                                  \</span>
<a href="#l15.443"></a><span id="l15.443" class="difflineminus">-      new SyncRunnable4&lt;nsI##iface, arg1, arg2, arg3, arg4&gt;         \</span>
<a href="#l15.444"></a><span id="l15.444" class="difflineminus">-      (mReceiver, &amp;nsI##iface::method,                              \</span>
<a href="#l15.445"></a><span id="l15.445" class="difflineminus">-       a1, a2, a3, a4);                                             \</span>
<a href="#l15.446"></a><span id="l15.446" class="difflineminus">-    return DispatchSyncRunnable(r);                                 \</span>
<a href="#l15.447"></a><span id="l15.447" class="difflineplus">+    RefPtr&lt;SyncRunnableBase&gt; r =                                           \</span>
<a href="#l15.448"></a><span id="l15.448" class="difflineplus">+        new SyncRunnable4&lt;nsI##iface, arg1, arg2, arg3, arg4&gt;(             \</span>
<a href="#l15.449"></a><span id="l15.449" class="difflineplus">+            mReceiver, &amp;nsI##iface::method, a1, a2, a3, a4);               \</span>
<a href="#l15.450"></a><span id="l15.450" class="difflineplus">+    return DispatchSyncRunnable(r);                                        \</span>
<a href="#l15.451"></a><span id="l15.451">   }</span>
<a href="#l15.452"></a><span id="l15.452"> </span>
<a href="#l15.453"></a><span id="l15.453" class="difflineminus">-#define NS_SYNCRUNNABLEMETHOD5(iface, method,                       \</span>
<a href="#l15.454"></a><span id="l15.454" class="difflineminus">-                               arg1, arg2, arg3, arg4, arg5)        \</span>
<a href="#l15.455"></a><span id="l15.455" class="difflineminus">-  NS_IMETHODIMP iface##Proxy::method(arg1 a1, arg2 a2, arg3 a3, arg4 a4, arg5 a5) {   \</span>
<a href="#l15.456"></a><span id="l15.456" class="difflineminus">-    RefPtr&lt;SyncRunnableBase&gt; r =                                  \</span>
<a href="#l15.457"></a><span id="l15.457" class="difflineminus">-      new SyncRunnable5&lt;nsI##iface, arg1, arg2, arg3, arg4, arg5&gt;   \</span>
<a href="#l15.458"></a><span id="l15.458" class="difflineminus">-      (mReceiver, &amp;nsI##iface::method,                              \</span>
<a href="#l15.459"></a><span id="l15.459" class="difflineminus">-       a1, a2, a3, a4, a5);                                         \</span>
<a href="#l15.460"></a><span id="l15.460" class="difflineminus">-    return DispatchSyncRunnable(r);                                 \</span>
<a href="#l15.461"></a><span id="l15.461" class="difflineplus">+#define NS_SYNCRUNNABLEMETHOD5(iface, method, arg1, arg2, arg3, arg4, arg5) \</span>
<a href="#l15.462"></a><span id="l15.462" class="difflineplus">+  NS_IMETHODIMP iface##Proxy::method(arg1 a1, arg2 a2, arg3 a3, arg4 a4,    \</span>
<a href="#l15.463"></a><span id="l15.463" class="difflineplus">+                                     arg5 a5) {                             \</span>
<a href="#l15.464"></a><span id="l15.464" class="difflineplus">+    RefPtr&lt;SyncRunnableBase&gt; r =                                            \</span>
<a href="#l15.465"></a><span id="l15.465" class="difflineplus">+        new SyncRunnable5&lt;nsI##iface, arg1, arg2, arg3, arg4, arg5&gt;(        \</span>
<a href="#l15.466"></a><span id="l15.466" class="difflineplus">+            mReceiver, &amp;nsI##iface::method, a1, a2, a3, a4, a5);            \</span>
<a href="#l15.467"></a><span id="l15.467" class="difflineplus">+    return DispatchSyncRunnable(r);                                         \</span>
<a href="#l15.468"></a><span id="l15.468">   }</span>
<a href="#l15.469"></a><span id="l15.469"> </span>
<a href="#l15.470"></a><span id="l15.470" class="difflineminus">-#define NS_SYNCRUNNABLEATTRIBUTE(iface, attribute,                       \</span>
<a href="#l15.471"></a><span id="l15.471" class="difflineminus">-                                 type)                                \</span>
<a href="#l15.472"></a><span id="l15.472" class="difflineminus">-NS_IMETHODIMP iface##Proxy::Get##attribute(type *a1) {                     \</span>
<a href="#l15.473"></a><span id="l15.473" class="difflineminus">-    RefPtr&lt;SyncRunnableBase&gt; r =                                  \</span>
<a href="#l15.474"></a><span id="l15.474" class="difflineminus">-      new SyncRunnable1&lt;nsI##iface, type *&gt;                           \</span>
<a href="#l15.475"></a><span id="l15.475" class="difflineminus">-      (mReceiver, &amp;nsI##iface::Get##attribute, a1);                         \</span>
<a href="#l15.476"></a><span id="l15.476" class="difflineminus">-    return DispatchSyncRunnable(r);                                 \</span>
<a href="#l15.477"></a><span id="l15.477" class="difflineminus">-  } \</span>
<a href="#l15.478"></a><span id="l15.478" class="difflineminus">-NS_IMETHODIMP iface##Proxy::Set##attribute(type a1) {                     \</span>
<a href="#l15.479"></a><span id="l15.479" class="difflineminus">-    RefPtr&lt;SyncRunnableBase&gt; r =                                  \</span>
<a href="#l15.480"></a><span id="l15.480" class="difflineminus">-      new SyncRunnable1&lt;nsI##iface, type&gt;                           \</span>
<a href="#l15.481"></a><span id="l15.481" class="difflineminus">-      (mReceiver, &amp;nsI##iface::Set##attribute, a1);                         \</span>
<a href="#l15.482"></a><span id="l15.482" class="difflineminus">-    return DispatchSyncRunnable(r);                                 \</span>
<a href="#l15.483"></a><span id="l15.483" class="difflineplus">+#define NS_SYNCRUNNABLEATTRIBUTE(iface, attribute, type)                \</span>
<a href="#l15.484"></a><span id="l15.484" class="difflineplus">+  NS_IMETHODIMP iface##Proxy::Get##attribute(type *a1) {                \</span>
<a href="#l15.485"></a><span id="l15.485" class="difflineplus">+    RefPtr&lt;SyncRunnableBase&gt; r = new SyncRunnable1&lt;nsI##iface, type *&gt;( \</span>
<a href="#l15.486"></a><span id="l15.486" class="difflineplus">+        mReceiver, &amp;nsI##iface::Get##attribute, a1);                    \</span>
<a href="#l15.487"></a><span id="l15.487" class="difflineplus">+    return DispatchSyncRunnable(r);                                     \</span>
<a href="#l15.488"></a><span id="l15.488" class="difflineplus">+  }                                                                     \</span>
<a href="#l15.489"></a><span id="l15.489" class="difflineplus">+  NS_IMETHODIMP iface##Proxy::Set##attribute(type a1) {                 \</span>
<a href="#l15.490"></a><span id="l15.490" class="difflineplus">+    RefPtr&lt;SyncRunnableBase&gt; r = new SyncRunnable1&lt;nsI##iface, type&gt;(   \</span>
<a href="#l15.491"></a><span id="l15.491" class="difflineplus">+        mReceiver, &amp;nsI##iface::Set##attribute, a1);                    \</span>
<a href="#l15.492"></a><span id="l15.492" class="difflineplus">+    return DispatchSyncRunnable(r);                                     \</span>
<a href="#l15.493"></a><span id="l15.493">   }</span>
<a href="#l15.494"></a><span id="l15.494"> </span>
<a href="#l15.495"></a><span id="l15.495" class="difflineplus">+#define NS_NOTIMPLEMENTED               \</span>
<a href="#l15.496"></a><span id="l15.496" class="difflineplus">+  {                                     \</span>
<a href="#l15.497"></a><span id="l15.497" class="difflineplus">+    NS_RUNTIMEABORT(&quot;Not implemented&quot;); \</span>
<a href="#l15.498"></a><span id="l15.498" class="difflineplus">+    return NS_ERROR_UNEXPECTED;         \</span>
<a href="#l15.499"></a><span id="l15.499" class="difflineplus">+  }</span>
<a href="#l15.500"></a><span id="l15.500"> </span>
<a href="#l15.501"></a><span id="l15.501" class="difflineminus">-#define NS_NOTIMPLEMENTED \</span>
<a href="#l15.502"></a><span id="l15.502" class="difflineminus">-  { NS_RUNTIMEABORT(&quot;Not implemented&quot;); return NS_ERROR_UNEXPECTED; }</span>
<a href="#l15.503"></a><span id="l15.503" class="difflineminus">-</span>
<a href="#l15.504"></a><span id="l15.504" class="difflineminus">-NS_SYNCRUNNABLEMETHOD4(StreamListener, OnDataAvailable,</span>
<a href="#l15.505"></a><span id="l15.505" class="difflineminus">-                       nsIRequest *, nsIInputStream *, uint64_t, uint32_t)</span>
<a href="#l15.506"></a><span id="l15.506" class="difflineplus">+NS_SYNCRUNNABLEMETHOD4(StreamListener, OnDataAvailable, nsIRequest *,</span>
<a href="#l15.507"></a><span id="l15.507" class="difflineplus">+                       nsIInputStream *, uint64_t, uint32_t)</span>
<a href="#l15.508"></a><span id="l15.508"> </span>
<a href="#l15.509"></a><span id="l15.509"> NS_SYNCRUNNABLEMETHOD1(StreamListener, OnStartRequest, nsIRequest *)</span>
<a href="#l15.510"></a><span id="l15.510"> </span>
<a href="#l15.511"></a><span id="l15.511"> NS_SYNCRUNNABLEMETHOD2(StreamListener, OnStopRequest, nsIRequest *, nsresult)</span>
<a href="#l15.512"></a><span id="l15.512"> </span>
<a href="#l15.513"></a><span id="l15.513"> NS_SYNCRUNNABLEMETHOD2(ImapProtocolSink, GetUrlWindow, nsIMsgMailNewsUrl *,</span>
<a href="#l15.514"></a><span id="l15.514">                        nsIMsgWindow **)</span>
<a href="#l15.515"></a><span id="l15.515"> </span>
<a href="#l15.516"></a><span id="l15.516" class="difflineat">@@ -373,229 +325,256 @@ NS_SYNCRUNNABLEMETHOD0(ImapProtocolSink,</span>
<a href="#l15.517"></a><span id="l15.517"> NS_SYNCRUNNABLEMETHOD0(ImapProtocolSink, SetupMainThreadProxies)</span>
<a href="#l15.518"></a><span id="l15.518"> </span>
<a href="#l15.519"></a><span id="l15.519"> NS_SYNCRUNNABLEATTRIBUTE(ImapMailFolderSink, FolderNeedsACLListed, bool)</span>
<a href="#l15.520"></a><span id="l15.520"> NS_SYNCRUNNABLEATTRIBUTE(ImapMailFolderSink, FolderNeedsSubscribing, bool)</span>
<a href="#l15.521"></a><span id="l15.521"> NS_SYNCRUNNABLEATTRIBUTE(ImapMailFolderSink, FolderNeedsAdded, bool)</span>
<a href="#l15.522"></a><span id="l15.522"> NS_SYNCRUNNABLEATTRIBUTE(ImapMailFolderSink, AclFlags, uint32_t)</span>
<a href="#l15.523"></a><span id="l15.523"> NS_SYNCRUNNABLEATTRIBUTE(ImapMailFolderSink, UidValidity, int32_t)</span>
<a href="#l15.524"></a><span id="l15.524"> NS_SYNCRUNNABLEATTRIBUTE(ImapMailFolderSink, FolderQuotaCommandIssued, bool)</span>
<a href="#l15.525"></a><span id="l15.525" class="difflineminus">-NS_SYNCRUNNABLEMETHOD3(ImapMailFolderSink, SetFolderQuotaData, const nsACString &amp;, uint32_t, uint32_t)</span>
<a href="#l15.526"></a><span id="l15.526" class="difflineplus">+NS_SYNCRUNNABLEMETHOD3(ImapMailFolderSink, SetFolderQuotaData,</span>
<a href="#l15.527"></a><span id="l15.527" class="difflineplus">+                       const nsACString &amp;, uint32_t, uint32_t)</span>
<a href="#l15.528"></a><span id="l15.528"> NS_SYNCRUNNABLEMETHOD1(ImapMailFolderSink, GetShouldDownloadAllHeaders, bool *)</span>
<a href="#l15.529"></a><span id="l15.529"> NS_SYNCRUNNABLEMETHOD1(ImapMailFolderSink, GetOnlineDelimiter, char *)</span>
<a href="#l15.530"></a><span id="l15.530"> NS_SYNCRUNNABLEMETHOD0(ImapMailFolderSink, OnNewIdleMessages)</span>
<a href="#l15.531"></a><span id="l15.531" class="difflineminus">-NS_SYNCRUNNABLEMETHOD2(ImapMailFolderSink, UpdateImapMailboxStatus, nsIImapProtocol *, nsIMailboxSpec *)</span>
<a href="#l15.532"></a><span id="l15.532" class="difflineminus">-NS_SYNCRUNNABLEMETHOD2(ImapMailFolderSink, UpdateImapMailboxInfo, nsIImapProtocol *, nsIMailboxSpec *)</span>
<a href="#l15.533"></a><span id="l15.533" class="difflineminus">-NS_SYNCRUNNABLEMETHOD4(ImapMailFolderSink, GetMsgHdrsToDownload, bool *, int32_t *, uint32_t *, nsMsgKey **)</span>
<a href="#l15.534"></a><span id="l15.534" class="difflineminus">-NS_SYNCRUNNABLEMETHOD2(ImapMailFolderSink, ParseMsgHdrs, nsIImapProtocol *, nsIImapHeaderXferInfo *)</span>
<a href="#l15.535"></a><span id="l15.535" class="difflineminus">-NS_SYNCRUNNABLEMETHOD1(ImapMailFolderSink, AbortHeaderParseStream, nsIImapProtocol *)</span>
<a href="#l15.536"></a><span id="l15.536" class="difflineminus">-NS_SYNCRUNNABLEMETHOD2(ImapMailFolderSink, OnlineCopyCompleted, nsIImapProtocol *, ImapOnlineCopyState)</span>
<a href="#l15.537"></a><span id="l15.537" class="difflineplus">+NS_SYNCRUNNABLEMETHOD2(ImapMailFolderSink, UpdateImapMailboxStatus,</span>
<a href="#l15.538"></a><span id="l15.538" class="difflineplus">+                       nsIImapProtocol *, nsIMailboxSpec *)</span>
<a href="#l15.539"></a><span id="l15.539" class="difflineplus">+NS_SYNCRUNNABLEMETHOD2(ImapMailFolderSink, UpdateImapMailboxInfo,</span>
<a href="#l15.540"></a><span id="l15.540" class="difflineplus">+                       nsIImapProtocol *, nsIMailboxSpec *)</span>
<a href="#l15.541"></a><span id="l15.541" class="difflineplus">+NS_SYNCRUNNABLEMETHOD4(ImapMailFolderSink, GetMsgHdrsToDownload, bool *,</span>
<a href="#l15.542"></a><span id="l15.542" class="difflineplus">+                       int32_t *, uint32_t *, nsMsgKey **)</span>
<a href="#l15.543"></a><span id="l15.543" class="difflineplus">+NS_SYNCRUNNABLEMETHOD2(ImapMailFolderSink, ParseMsgHdrs, nsIImapProtocol *,</span>
<a href="#l15.544"></a><span id="l15.544" class="difflineplus">+                       nsIImapHeaderXferInfo *)</span>
<a href="#l15.545"></a><span id="l15.545" class="difflineplus">+NS_SYNCRUNNABLEMETHOD1(ImapMailFolderSink, AbortHeaderParseStream,</span>
<a href="#l15.546"></a><span id="l15.546" class="difflineplus">+                       nsIImapProtocol *)</span>
<a href="#l15.547"></a><span id="l15.547" class="difflineplus">+NS_SYNCRUNNABLEMETHOD2(ImapMailFolderSink, OnlineCopyCompleted,</span>
<a href="#l15.548"></a><span id="l15.548" class="difflineplus">+                       nsIImapProtocol *, ImapOnlineCopyState)</span>
<a href="#l15.549"></a><span id="l15.549"> NS_SYNCRUNNABLEMETHOD1(ImapMailFolderSink, StartMessage, nsIMsgMailNewsUrl *)</span>
<a href="#l15.550"></a><span id="l15.550" class="difflineminus">-NS_SYNCRUNNABLEMETHOD2(ImapMailFolderSink, EndMessage, nsIMsgMailNewsUrl *, nsMsgKey)</span>
<a href="#l15.551"></a><span id="l15.551" class="difflineminus">-NS_SYNCRUNNABLEMETHOD2(ImapMailFolderSink, NotifySearchHit, nsIMsgMailNewsUrl *, const char *)</span>
<a href="#l15.552"></a><span id="l15.552" class="difflineminus">-NS_SYNCRUNNABLEMETHOD2(ImapMailFolderSink, CopyNextStreamMessage, bool, nsISupports *)</span>
<a href="#l15.553"></a><span id="l15.553" class="difflineminus">-NS_SYNCRUNNABLEMETHOD1(ImapMailFolderSink, CloseMockChannel, nsIImapMockChannel *)</span>
<a href="#l15.554"></a><span id="l15.554" class="difflineminus">-NS_SYNCRUNNABLEMETHOD5(ImapMailFolderSink, SetUrlState, nsIImapProtocol *, nsIMsgMailNewsUrl *,</span>
<a href="#l15.555"></a><span id="l15.555" class="difflineminus">-                       bool, bool, nsresult)</span>
<a href="#l15.556"></a><span id="l15.556" class="difflineminus">-NS_SYNCRUNNABLEMETHOD1(ImapMailFolderSink, ReleaseUrlCacheEntry, nsIMsgMailNewsUrl *)</span>
<a href="#l15.557"></a><span id="l15.557" class="difflineminus">-NS_SYNCRUNNABLEMETHOD1(ImapMailFolderSink, HeaderFetchCompleted, nsIImapProtocol *)</span>
<a href="#l15.558"></a><span id="l15.558" class="difflineplus">+NS_SYNCRUNNABLEMETHOD2(ImapMailFolderSink, EndMessage, nsIMsgMailNewsUrl *,</span>
<a href="#l15.559"></a><span id="l15.559" class="difflineplus">+                       nsMsgKey)</span>
<a href="#l15.560"></a><span id="l15.560" class="difflineplus">+NS_SYNCRUNNABLEMETHOD2(ImapMailFolderSink, NotifySearchHit, nsIMsgMailNewsUrl *,</span>
<a href="#l15.561"></a><span id="l15.561" class="difflineplus">+                       const char *)</span>
<a href="#l15.562"></a><span id="l15.562" class="difflineplus">+NS_SYNCRUNNABLEMETHOD2(ImapMailFolderSink, CopyNextStreamMessage, bool,</span>
<a href="#l15.563"></a><span id="l15.563" class="difflineplus">+                       nsISupports *)</span>
<a href="#l15.564"></a><span id="l15.564" class="difflineplus">+NS_SYNCRUNNABLEMETHOD1(ImapMailFolderSink, CloseMockChannel,</span>
<a href="#l15.565"></a><span id="l15.565" class="difflineplus">+                       nsIImapMockChannel *)</span>
<a href="#l15.566"></a><span id="l15.566" class="difflineplus">+NS_SYNCRUNNABLEMETHOD5(ImapMailFolderSink, SetUrlState, nsIImapProtocol *,</span>
<a href="#l15.567"></a><span id="l15.567" class="difflineplus">+                       nsIMsgMailNewsUrl *, bool, bool, nsresult)</span>
<a href="#l15.568"></a><span id="l15.568" class="difflineplus">+NS_SYNCRUNNABLEMETHOD1(ImapMailFolderSink, ReleaseUrlCacheEntry,</span>
<a href="#l15.569"></a><span id="l15.569" class="difflineplus">+                       nsIMsgMailNewsUrl *)</span>
<a href="#l15.570"></a><span id="l15.570" class="difflineplus">+NS_SYNCRUNNABLEMETHOD1(ImapMailFolderSink, HeaderFetchCompleted,</span>
<a href="#l15.571"></a><span id="l15.571" class="difflineplus">+                       nsIImapProtocol *)</span>
<a href="#l15.572"></a><span id="l15.572"> NS_SYNCRUNNABLEMETHOD1(ImapMailFolderSink, SetBiffStateAndUpdate, int32_t)</span>
<a href="#l15.573"></a><span id="l15.573" class="difflineminus">-NS_SYNCRUNNABLEMETHOD3(ImapMailFolderSink, ProgressStatusString, nsIImapProtocol*, const char*, const char16_t *)</span>
<a href="#l15.574"></a><span id="l15.574" class="difflineminus">-NS_SYNCRUNNABLEMETHOD4(ImapMailFolderSink, PercentProgress, nsIImapProtocol*, const char16_t *, int64_t, int64_t)</span>
<a href="#l15.575"></a><span id="l15.575" class="difflineplus">+NS_SYNCRUNNABLEMETHOD3(ImapMailFolderSink, ProgressStatusString,</span>
<a href="#l15.576"></a><span id="l15.576" class="difflineplus">+                       nsIImapProtocol *, const char *, const char16_t *)</span>
<a href="#l15.577"></a><span id="l15.577" class="difflineplus">+NS_SYNCRUNNABLEMETHOD4(ImapMailFolderSink, PercentProgress, nsIImapProtocol *,</span>
<a href="#l15.578"></a><span id="l15.578" class="difflineplus">+                       const char16_t *, int64_t, int64_t)</span>
<a href="#l15.579"></a><span id="l15.579"> NS_SYNCRUNNABLEMETHOD0(ImapMailFolderSink, ClearFolderRights)</span>
<a href="#l15.580"></a><span id="l15.580" class="difflineminus">-NS_SYNCRUNNABLEMETHOD2(ImapMailFolderSink, SetCopyResponseUid, const char *, nsIImapUrl *)</span>
<a href="#l15.581"></a><span id="l15.581" class="difflineminus">-NS_SYNCRUNNABLEMETHOD2(ImapMailFolderSink, SetAppendMsgUid, nsMsgKey, nsIImapUrl *)</span>
<a href="#l15.582"></a><span id="l15.582" class="difflineminus">-NS_SYNCRUNNABLEMETHOD2(ImapMailFolderSink, GetMessageId, nsIImapUrl *, nsACString &amp;)</span>
<a href="#l15.583"></a><span id="l15.583" class="difflineplus">+NS_SYNCRUNNABLEMETHOD2(ImapMailFolderSink, SetCopyResponseUid, const char *,</span>
<a href="#l15.584"></a><span id="l15.584" class="difflineplus">+                       nsIImapUrl *)</span>
<a href="#l15.585"></a><span id="l15.585" class="difflineplus">+NS_SYNCRUNNABLEMETHOD2(ImapMailFolderSink, SetAppendMsgUid, nsMsgKey,</span>
<a href="#l15.586"></a><span id="l15.586" class="difflineplus">+                       nsIImapUrl *)</span>
<a href="#l15.587"></a><span id="l15.587" class="difflineplus">+NS_SYNCRUNNABLEMETHOD2(ImapMailFolderSink, GetMessageId, nsIImapUrl *,</span>
<a href="#l15.588"></a><span id="l15.588" class="difflineplus">+                       nsACString &amp;)</span>
<a href="#l15.589"></a><span id="l15.589"> </span>
<a href="#l15.590"></a><span id="l15.590"> NS_SYNCRUNNABLEMETHOD2(ImapMessageSink, SetupMsgWriteStream, nsIFile *, bool)</span>
<a href="#l15.591"></a><span id="l15.591" class="difflineminus">-NS_SYNCRUNNABLEMETHOD3(ImapMessageSink, ParseAdoptedMsgLine, const char *, nsMsgKey, nsIImapUrl *)</span>
<a href="#l15.592"></a><span id="l15.592" class="difflineminus">-NS_SYNCRUNNABLEMETHOD4(ImapMessageSink, NormalEndMsgWriteStream, nsMsgKey, bool, nsIImapUrl *, int32_t)</span>
<a href="#l15.593"></a><span id="l15.593" class="difflineplus">+NS_SYNCRUNNABLEMETHOD3(ImapMessageSink, ParseAdoptedMsgLine, const char *,</span>
<a href="#l15.594"></a><span id="l15.594" class="difflineplus">+                       nsMsgKey, nsIImapUrl *)</span>
<a href="#l15.595"></a><span id="l15.595" class="difflineplus">+NS_SYNCRUNNABLEMETHOD4(ImapMessageSink, NormalEndMsgWriteStream, nsMsgKey, bool,</span>
<a href="#l15.596"></a><span id="l15.596" class="difflineplus">+                       nsIImapUrl *, int32_t)</span>
<a href="#l15.597"></a><span id="l15.597"> NS_SYNCRUNNABLEMETHOD0(ImapMessageSink, AbortMsgWriteStream)</span>
<a href="#l15.598"></a><span id="l15.598"> NS_SYNCRUNNABLEMETHOD0(ImapMessageSink, BeginMessageUpload)</span>
<a href="#l15.599"></a><span id="l15.599" class="difflineminus">-NS_SYNCRUNNABLEMETHOD4(ImapMessageSink, NotifyMessageFlags, uint32_t, const nsACString &amp;, nsMsgKey, uint64_t)</span>
<a href="#l15.600"></a><span id="l15.600" class="difflineminus">-NS_SYNCRUNNABLEMETHOD3(ImapMessageSink, NotifyMessageDeleted, const char *, bool, const char *)</span>
<a href="#l15.601"></a><span id="l15.601" class="difflineminus">-NS_SYNCRUNNABLEMETHOD2(ImapMessageSink, GetMessageSizeFromDB, const char *, uint32_t *)</span>
<a href="#l15.602"></a><span id="l15.602" class="difflineminus">-NS_SYNCRUNNABLEMETHOD2(ImapMessageSink, SetContentModified, nsIImapUrl *, nsImapContentModifiedType)</span>
<a href="#l15.603"></a><span id="l15.603" class="difflineminus">-NS_SYNCRUNNABLEMETHOD4(ImapMessageSink, GetCurMoveCopyMessageInfo, nsIImapUrl *, PRTime *, nsACString &amp;, uint32_t *)</span>
<a href="#l15.604"></a><span id="l15.604" class="difflineplus">+NS_SYNCRUNNABLEMETHOD4(ImapMessageSink, NotifyMessageFlags, uint32_t,</span>
<a href="#l15.605"></a><span id="l15.605" class="difflineplus">+                       const nsACString &amp;, nsMsgKey, uint64_t)</span>
<a href="#l15.606"></a><span id="l15.606" class="difflineplus">+NS_SYNCRUNNABLEMETHOD3(ImapMessageSink, NotifyMessageDeleted, const char *,</span>
<a href="#l15.607"></a><span id="l15.607" class="difflineplus">+                       bool, const char *)</span>
<a href="#l15.608"></a><span id="l15.608" class="difflineplus">+NS_SYNCRUNNABLEMETHOD2(ImapMessageSink, GetMessageSizeFromDB, const char *,</span>
<a href="#l15.609"></a><span id="l15.609" class="difflineplus">+                       uint32_t *)</span>
<a href="#l15.610"></a><span id="l15.610" class="difflineplus">+NS_SYNCRUNNABLEMETHOD2(ImapMessageSink, SetContentModified, nsIImapUrl *,</span>
<a href="#l15.611"></a><span id="l15.611" class="difflineplus">+                       nsImapContentModifiedType)</span>
<a href="#l15.612"></a><span id="l15.612" class="difflineplus">+NS_SYNCRUNNABLEMETHOD4(ImapMessageSink, GetCurMoveCopyMessageInfo, nsIImapUrl *,</span>
<a href="#l15.613"></a><span id="l15.613" class="difflineplus">+                       PRTime *, nsACString &amp;, uint32_t *)</span>
<a href="#l15.614"></a><span id="l15.614"> </span>
<a href="#l15.615"></a><span id="l15.615" class="difflineminus">-NS_SYNCRUNNABLEMETHOD4(ImapServerSink, PossibleImapMailbox, const nsACString &amp;, char, int32_t, bool *)</span>
<a href="#l15.616"></a><span id="l15.616" class="difflineminus">-NS_SYNCRUNNABLEMETHOD2(ImapServerSink, FolderNeedsACLInitialized, const nsACString &amp;, bool *)</span>
<a href="#l15.617"></a><span id="l15.617" class="difflineminus">-NS_SYNCRUNNABLEMETHOD3(ImapServerSink, AddFolderRights, const nsACString &amp;, const nsACString &amp;, const nsACString &amp;)</span>
<a href="#l15.618"></a><span id="l15.618" class="difflineplus">+NS_SYNCRUNNABLEMETHOD4(ImapServerSink, PossibleImapMailbox, const nsACString &amp;,</span>
<a href="#l15.619"></a><span id="l15.619" class="difflineplus">+                       char, int32_t, bool *)</span>
<a href="#l15.620"></a><span id="l15.620" class="difflineplus">+NS_SYNCRUNNABLEMETHOD2(ImapServerSink, FolderNeedsACLInitialized,</span>
<a href="#l15.621"></a><span id="l15.621" class="difflineplus">+                       const nsACString &amp;, bool *)</span>
<a href="#l15.622"></a><span id="l15.622" class="difflineplus">+NS_SYNCRUNNABLEMETHOD3(ImapServerSink, AddFolderRights, const nsACString &amp;,</span>
<a href="#l15.623"></a><span id="l15.623" class="difflineplus">+                       const nsACString &amp;, const nsACString &amp;)</span>
<a href="#l15.624"></a><span id="l15.624"> NS_SYNCRUNNABLEMETHOD1(ImapServerSink, RefreshFolderRights, const nsACString &amp;)</span>
<a href="#l15.625"></a><span id="l15.625"> NS_SYNCRUNNABLEMETHOD0(ImapServerSink, DiscoveryDone)</span>
<a href="#l15.626"></a><span id="l15.626"> NS_SYNCRUNNABLEMETHOD1(ImapServerSink, OnlineFolderDelete, const nsACString &amp;)</span>
<a href="#l15.627"></a><span id="l15.627" class="difflineminus">-NS_SYNCRUNNABLEMETHOD1(ImapServerSink, OnlineFolderCreateFailed, const nsACString &amp;)</span>
<a href="#l15.628"></a><span id="l15.628" class="difflineminus">-NS_SYNCRUNNABLEMETHOD3(ImapServerSink, OnlineFolderRename, nsIMsgWindow *, const nsACString &amp;, const nsACString &amp;)</span>
<a href="#l15.629"></a><span id="l15.629" class="difflineminus">-NS_SYNCRUNNABLEMETHOD2(ImapServerSink, FolderIsNoSelect, const nsACString &amp;, bool *)</span>
<a href="#l15.630"></a><span id="l15.630" class="difflineminus">-NS_SYNCRUNNABLEMETHOD2(ImapServerSink, SetFolderAdminURL, const nsACString &amp;, const nsACString &amp;)</span>
<a href="#l15.631"></a><span id="l15.631" class="difflineminus">-NS_SYNCRUNNABLEMETHOD2(ImapServerSink, FolderVerifiedOnline, const nsACString &amp;, bool *)</span>
<a href="#l15.632"></a><span id="l15.632" class="difflineplus">+NS_SYNCRUNNABLEMETHOD1(ImapServerSink, OnlineFolderCreateFailed,</span>
<a href="#l15.633"></a><span id="l15.633" class="difflineplus">+                       const nsACString &amp;)</span>
<a href="#l15.634"></a><span id="l15.634" class="difflineplus">+NS_SYNCRUNNABLEMETHOD3(ImapServerSink, OnlineFolderRename, nsIMsgWindow *,</span>
<a href="#l15.635"></a><span id="l15.635" class="difflineplus">+                       const nsACString &amp;, const nsACString &amp;)</span>
<a href="#l15.636"></a><span id="l15.636" class="difflineplus">+NS_SYNCRUNNABLEMETHOD2(ImapServerSink, FolderIsNoSelect, const nsACString &amp;,</span>
<a href="#l15.637"></a><span id="l15.637" class="difflineplus">+                       bool *)</span>
<a href="#l15.638"></a><span id="l15.638" class="difflineplus">+NS_SYNCRUNNABLEMETHOD2(ImapServerSink, SetFolderAdminURL, const nsACString &amp;,</span>
<a href="#l15.639"></a><span id="l15.639" class="difflineplus">+                       const nsACString &amp;)</span>
<a href="#l15.640"></a><span id="l15.640" class="difflineplus">+NS_SYNCRUNNABLEMETHOD2(ImapServerSink, FolderVerifiedOnline, const nsACString &amp;,</span>
<a href="#l15.641"></a><span id="l15.641" class="difflineplus">+                       bool *)</span>
<a href="#l15.642"></a><span id="l15.642"> NS_SYNCRUNNABLEMETHOD1(ImapServerSink, SetCapability, eIMAPCapabilityFlags)</span>
<a href="#l15.643"></a><span id="l15.643"> NS_SYNCRUNNABLEMETHOD1(ImapServerSink, SetServerID, const nsACString &amp;)</span>
<a href="#l15.644"></a><span id="l15.644" class="difflineminus">-NS_SYNCRUNNABLEMETHOD2(ImapServerSink, LoadNextQueuedUrl, nsIImapProtocol *, bool *)</span>
<a href="#l15.645"></a><span id="l15.645" class="difflineminus">-NS_SYNCRUNNABLEMETHOD2(ImapServerSink, PrepareToRetryUrl, nsIImapUrl *, nsIImapMockChannel **)</span>
<a href="#l15.646"></a><span id="l15.646" class="difflineplus">+NS_SYNCRUNNABLEMETHOD2(ImapServerSink, LoadNextQueuedUrl, nsIImapProtocol *,</span>
<a href="#l15.647"></a><span id="l15.647" class="difflineplus">+                       bool *)</span>
<a href="#l15.648"></a><span id="l15.648" class="difflineplus">+NS_SYNCRUNNABLEMETHOD2(ImapServerSink, PrepareToRetryUrl, nsIImapUrl *,</span>
<a href="#l15.649"></a><span id="l15.649" class="difflineplus">+                       nsIImapMockChannel **)</span>
<a href="#l15.650"></a><span id="l15.650"> NS_SYNCRUNNABLEMETHOD1(ImapServerSink, SuspendUrl, nsIImapUrl *)</span>
<a href="#l15.651"></a><span id="l15.651" class="difflineminus">-NS_SYNCRUNNABLEMETHOD2(ImapServerSink, RetryUrl, nsIImapUrl *, nsIImapMockChannel *)</span>
<a href="#l15.652"></a><span id="l15.652" class="difflineplus">+NS_SYNCRUNNABLEMETHOD2(ImapServerSink, RetryUrl, nsIImapUrl *,</span>
<a href="#l15.653"></a><span id="l15.653" class="difflineplus">+                       nsIImapMockChannel *)</span>
<a href="#l15.654"></a><span id="l15.654"> NS_SYNCRUNNABLEMETHOD0(ImapServerSink, AbortQueuedUrls)</span>
<a href="#l15.655"></a><span id="l15.655" class="difflineminus">-NS_SYNCRUNNABLEMETHOD2(ImapServerSink, GetImapStringByName, const char*, nsAString &amp;)</span>
<a href="#l15.656"></a><span id="l15.656" class="difflineminus">-NS_SYNCRUNNABLEMETHOD2(ImapServerSink, PromptLoginFailed, nsIMsgWindow *, int32_t *)</span>
<a href="#l15.657"></a><span id="l15.657" class="difflineminus">-NS_SYNCRUNNABLEMETHOD2(ImapServerSink, FEAlert, const nsAString &amp;, nsIMsgMailNewsUrl *)</span>
<a href="#l15.658"></a><span id="l15.658" class="difflineminus">-NS_SYNCRUNNABLEMETHOD2(ImapServerSink, FEAlertWithName, const char*, nsIMsgMailNewsUrl *)</span>
<a href="#l15.659"></a><span id="l15.659" class="difflineminus">-NS_SYNCRUNNABLEMETHOD2(ImapServerSink, FEAlertFromServer, const nsACString &amp;, nsIMsgMailNewsUrl *)</span>
<a href="#l15.660"></a><span id="l15.660" class="difflineplus">+NS_SYNCRUNNABLEMETHOD2(ImapServerSink, GetImapStringByName, const char *,</span>
<a href="#l15.661"></a><span id="l15.661" class="difflineplus">+                       nsAString &amp;)</span>
<a href="#l15.662"></a><span id="l15.662" class="difflineplus">+NS_SYNCRUNNABLEMETHOD2(ImapServerSink, PromptLoginFailed, nsIMsgWindow *,</span>
<a href="#l15.663"></a><span id="l15.663" class="difflineplus">+                       int32_t *)</span>
<a href="#l15.664"></a><span id="l15.664" class="difflineplus">+NS_SYNCRUNNABLEMETHOD2(ImapServerSink, FEAlert, const nsAString &amp;,</span>
<a href="#l15.665"></a><span id="l15.665" class="difflineplus">+                       nsIMsgMailNewsUrl *)</span>
<a href="#l15.666"></a><span id="l15.666" class="difflineplus">+NS_SYNCRUNNABLEMETHOD2(ImapServerSink, FEAlertWithName, const char *,</span>
<a href="#l15.667"></a><span id="l15.667" class="difflineplus">+                       nsIMsgMailNewsUrl *)</span>
<a href="#l15.668"></a><span id="l15.668" class="difflineplus">+NS_SYNCRUNNABLEMETHOD2(ImapServerSink, FEAlertFromServer, const nsACString &amp;,</span>
<a href="#l15.669"></a><span id="l15.669" class="difflineplus">+                       nsIMsgMailNewsUrl *)</span>
<a href="#l15.670"></a><span id="l15.670"> NS_SYNCRUNNABLEMETHOD0(ImapServerSink, CommitNamespaces)</span>
<a href="#l15.671"></a><span id="l15.671" class="difflineminus">-NS_SYNCRUNNABLEMETHOD3(ImapServerSink, AsyncGetPassword, nsIImapProtocol *, bool, nsAString &amp;)</span>
<a href="#l15.672"></a><span id="l15.672" class="difflineplus">+NS_SYNCRUNNABLEMETHOD3(ImapServerSink, AsyncGetPassword, nsIImapProtocol *,</span>
<a href="#l15.673"></a><span id="l15.673" class="difflineplus">+                       bool, nsAString &amp;)</span>
<a href="#l15.674"></a><span id="l15.674"> NS_SYNCRUNNABLEATTRIBUTE(ImapServerSink, UserAuthenticated, bool)</span>
<a href="#l15.675"></a><span id="l15.675" class="difflineminus">-NS_SYNCRUNNABLEMETHOD3(ImapServerSink, SetMailServerUrls, const nsACString &amp;, const nsACString &amp;, const nsACString &amp;)</span>
<a href="#l15.676"></a><span id="l15.676" class="difflineplus">+NS_SYNCRUNNABLEMETHOD3(ImapServerSink, SetMailServerUrls, const nsACString &amp;,</span>
<a href="#l15.677"></a><span id="l15.677" class="difflineplus">+                       const nsACString &amp;, const nsACString &amp;)</span>
<a href="#l15.678"></a><span id="l15.678"> NS_SYNCRUNNABLEMETHOD1(ImapServerSink, GetArbitraryHeaders, nsACString &amp;)</span>
<a href="#l15.679"></a><span id="l15.679"> NS_SYNCRUNNABLEMETHOD0(ImapServerSink, ForgetPassword)</span>
<a href="#l15.680"></a><span id="l15.680"> NS_SYNCRUNNABLEMETHOD1(ImapServerSink, GetShowAttachmentsInline, bool *)</span>
<a href="#l15.681"></a><span id="l15.681" class="difflineminus">-NS_SYNCRUNNABLEMETHOD3(ImapServerSink, CramMD5Hash, const char *, const char *, char **)</span>
<a href="#l15.682"></a><span id="l15.682" class="difflineplus">+NS_SYNCRUNNABLEMETHOD3(ImapServerSink, CramMD5Hash, const char *, const char *,</span>
<a href="#l15.683"></a><span id="l15.683" class="difflineplus">+                       char **)</span>
<a href="#l15.684"></a><span id="l15.684"> NS_SYNCRUNNABLEMETHOD1(ImapServerSink, GetLoginUsername, nsACString &amp;)</span>
<a href="#l15.685"></a><span id="l15.685"> NS_SYNCRUNNABLEMETHOD1(ImapServerSink, UpdateTrySTARTTLSPref, bool)</span>
<a href="#l15.686"></a><span id="l15.686"> NS_SYNCRUNNABLEMETHOD1(ImapServerSink, GetOriginalUsername, nsACString &amp;)</span>
<a href="#l15.687"></a><span id="l15.687"> NS_SYNCRUNNABLEMETHOD1(ImapServerSink, GetServerKey, nsACString &amp;)</span>
<a href="#l15.688"></a><span id="l15.688"> NS_SYNCRUNNABLEMETHOD1(ImapServerSink, GetServerPassword, nsAString &amp;)</span>
<a href="#l15.689"></a><span id="l15.689" class="difflineminus">-NS_SYNCRUNNABLEMETHOD1(ImapServerSink, RemoveServerConnection, nsIImapProtocol *)</span>
<a href="#l15.690"></a><span id="l15.690" class="difflineplus">+NS_SYNCRUNNABLEMETHOD1(ImapServerSink, RemoveServerConnection,</span>
<a href="#l15.691"></a><span id="l15.691" class="difflineplus">+                       nsIImapProtocol *)</span>
<a href="#l15.692"></a><span id="l15.692"> NS_SYNCRUNNABLEMETHOD1(ImapServerSink, GetServerShuttingDown, bool *)</span>
<a href="#l15.693"></a><span id="l15.693" class="difflineminus">-NS_SYNCRUNNABLEMETHOD1(ImapServerSink, ResetServerConnection, const nsACString &amp;)</span>
<a href="#l15.694"></a><span id="l15.694" class="difflineplus">+NS_SYNCRUNNABLEMETHOD1(ImapServerSink, ResetServerConnection,</span>
<a href="#l15.695"></a><span id="l15.695" class="difflineplus">+                       const nsACString &amp;)</span>
<a href="#l15.696"></a><span id="l15.696"> NS_SYNCRUNNABLEMETHOD1(ImapServerSink, SetServerDoingLsub, bool)</span>
<a href="#l15.697"></a><span id="l15.697"> NS_SYNCRUNNABLEMETHOD1(ImapServerSink, SetServerForceSelect, const nsACString &amp;)</span>
<a href="#l15.698"></a><span id="l15.698"> </span>
<a href="#l15.699"></a><span id="l15.699" class="difflineminus">-</span>
<a href="#l15.700"></a><span id="l15.700"> namespace mozilla {</span>
<a href="#l15.701"></a><span id="l15.701"> namespace mailnews {</span>
<a href="#l15.702"></a><span id="l15.702"> </span>
<a href="#l15.703"></a><span id="l15.703"> NS_IMPL_ISUPPORTS(OAuth2ThreadHelper, msgIOAuth2ModuleListener)</span>
<a href="#l15.704"></a><span id="l15.704"> </span>
<a href="#l15.705"></a><span id="l15.705"> OAuth2ThreadHelper::OAuth2ThreadHelper(nsIMsgIncomingServer *aServer)</span>
<a href="#l15.706"></a><span id="l15.706" class="difflineminus">-: mMonitor(&quot;OAuth thread lock&quot;),</span>
<a href="#l15.707"></a><span id="l15.707" class="difflineminus">-  mServer(aServer)</span>
<a href="#l15.708"></a><span id="l15.708" class="difflineminus">-{</span>
<a href="#l15.709"></a><span id="l15.709" class="difflineminus">-}</span>
<a href="#l15.710"></a><span id="l15.710" class="difflineplus">+    : mMonitor(&quot;OAuth thread lock&quot;), mServer(aServer) {}</span>
<a href="#l15.711"></a><span id="l15.711"> </span>
<a href="#l15.712"></a><span id="l15.712" class="difflineminus">-OAuth2ThreadHelper::~OAuth2ThreadHelper()</span>
<a href="#l15.713"></a><span id="l15.713" class="difflineminus">-{</span>
<a href="#l15.714"></a><span id="l15.714" class="difflineminus">-  if (mOAuth2Support)</span>
<a href="#l15.715"></a><span id="l15.715" class="difflineminus">-  {</span>
<a href="#l15.716"></a><span id="l15.716" class="difflineminus">-    NS_ReleaseOnMainThreadSystemGroup(&quot;OAuth2ThreadHelper::mOAuth2Support&quot;, mOAuth2Support.forget());</span>
<a href="#l15.717"></a><span id="l15.717" class="difflineplus">+OAuth2ThreadHelper::~OAuth2ThreadHelper() {</span>
<a href="#l15.718"></a><span id="l15.718" class="difflineplus">+  if (mOAuth2Support) {</span>
<a href="#l15.719"></a><span id="l15.719" class="difflineplus">+    NS_ReleaseOnMainThreadSystemGroup(&quot;OAuth2ThreadHelper::mOAuth2Support&quot;,</span>
<a href="#l15.720"></a><span id="l15.720" class="difflineplus">+                                      mOAuth2Support.forget());</span>
<a href="#l15.721"></a><span id="l15.721">   }</span>
<a href="#l15.722"></a><span id="l15.722"> }</span>
<a href="#l15.723"></a><span id="l15.723"> </span>
<a href="#l15.724"></a><span id="l15.724" class="difflineminus">-bool OAuth2ThreadHelper::SupportsOAuth2()</span>
<a href="#l15.725"></a><span id="l15.725" class="difflineminus">-{</span>
<a href="#l15.726"></a><span id="l15.726" class="difflineplus">+bool OAuth2ThreadHelper::SupportsOAuth2() {</span>
<a href="#l15.727"></a><span id="l15.727">   // Acquire a lock early, before reading anything. Guarantees memory visibility</span>
<a href="#l15.728"></a><span id="l15.728">   // issues.</span>
<a href="#l15.729"></a><span id="l15.729">   MonitorAutoLock lockGuard(mMonitor);</span>
<a href="#l15.730"></a><span id="l15.730"> </span>
<a href="#l15.731"></a><span id="l15.731">   // If we don't have a server, we can't init, and therefore, we don't support</span>
<a href="#l15.732"></a><span id="l15.732">   // OAuth2.</span>
<a href="#l15.733"></a><span id="l15.733" class="difflineminus">-  if (!mServer)</span>
<a href="#l15.734"></a><span id="l15.734" class="difflineminus">-    return false;</span>
<a href="#l15.735"></a><span id="l15.735" class="difflineplus">+  if (!mServer) return false;</span>
<a href="#l15.736"></a><span id="l15.736"> </span>
<a href="#l15.737"></a><span id="l15.737">   // If we have this, then we support OAuth2.</span>
<a href="#l15.738"></a><span id="l15.738" class="difflineminus">-  if (mOAuth2Support)</span>
<a href="#l15.739"></a><span id="l15.739" class="difflineminus">-    return true;</span>
<a href="#l15.740"></a><span id="l15.740" class="difflineplus">+  if (mOAuth2Support) return true;</span>
<a href="#l15.741"></a><span id="l15.741"> </span>
<a href="#l15.742"></a><span id="l15.742">   // Initialize. This needs to be done on-main-thread: if we're off that thread,</span>
<a href="#l15.743"></a><span id="l15.743">   // synchronously dispatch to the main thread.</span>
<a href="#l15.744"></a><span id="l15.744" class="difflineminus">-  if (NS_IsMainThread())</span>
<a href="#l15.745"></a><span id="l15.745" class="difflineminus">-  {</span>
<a href="#l15.746"></a><span id="l15.746" class="difflineplus">+  if (NS_IsMainThread()) {</span>
<a href="#l15.747"></a><span id="l15.747">     MonitorAutoUnlock lockGuard(mMonitor);</span>
<a href="#l15.748"></a><span id="l15.748">     Init();</span>
<a href="#l15.749"></a><span id="l15.749" class="difflineminus">-  }</span>
<a href="#l15.750"></a><span id="l15.750" class="difflineminus">-  else</span>
<a href="#l15.751"></a><span id="l15.751" class="difflineminus">-  {</span>
<a href="#l15.752"></a><span id="l15.752" class="difflineminus">-    nsCOMPtr&lt;nsIRunnable&gt; runInit =</span>
<a href="#l15.753"></a><span id="l15.753" class="difflineminus">-      NewRunnableMethod(&quot;OAuth2ThreadHelper::SupportsOAuth2&quot;, this, &amp;OAuth2ThreadHelper::Init);</span>
<a href="#l15.754"></a><span id="l15.754" class="difflineplus">+  } else {</span>
<a href="#l15.755"></a><span id="l15.755" class="difflineplus">+    nsCOMPtr&lt;nsIRunnable&gt; runInit = NewRunnableMethod(</span>
<a href="#l15.756"></a><span id="l15.756" class="difflineplus">+        &quot;OAuth2ThreadHelper::SupportsOAuth2&quot;, this, &amp;OAuth2ThreadHelper::Init);</span>
<a href="#l15.757"></a><span id="l15.757">     NS_DispatchToMainThread(runInit);</span>
<a href="#l15.758"></a><span id="l15.758">     mMonitor.Wait();</span>
<a href="#l15.759"></a><span id="l15.759">   }</span>
<a href="#l15.760"></a><span id="l15.760"> </span>
<a href="#l15.761"></a><span id="l15.761">   // After synchronously initializing, if we didn't get an object, then we don't</span>
<a href="#l15.762"></a><span id="l15.762">   // support XOAuth2.</span>
<a href="#l15.763"></a><span id="l15.763">   return mOAuth2Support != nullptr;</span>
<a href="#l15.764"></a><span id="l15.764"> }</span>
<a href="#l15.765"></a><span id="l15.765"> </span>
<a href="#l15.766"></a><span id="l15.766" class="difflineminus">-void OAuth2ThreadHelper::GetXOAuth2String(nsACString &amp;base64Str)</span>
<a href="#l15.767"></a><span id="l15.767" class="difflineminus">-{</span>
<a href="#l15.768"></a><span id="l15.768" class="difflineplus">+void OAuth2ThreadHelper::GetXOAuth2String(nsACString &amp;base64Str) {</span>
<a href="#l15.769"></a><span id="l15.769">   MOZ_ASSERT(!NS_IsMainThread(), &quot;This method cannot run on the main thread&quot;);</span>
<a href="#l15.770"></a><span id="l15.770"> </span>
<a href="#l15.771"></a><span id="l15.771">   // Acquire a lock early, before reading anything. Guarantees memory visibility</span>
<a href="#l15.772"></a><span id="l15.772">   // issues.</span>
<a href="#l15.773"></a><span id="l15.773">   MonitorAutoLock lockGuard(mMonitor);</span>
<a href="#l15.774"></a><span id="l15.774"> </span>
<a href="#l15.775"></a><span id="l15.775">   // Umm... what are you trying to do?</span>
<a href="#l15.776"></a><span id="l15.776" class="difflineminus">-  if (!mOAuth2Support)</span>
<a href="#l15.777"></a><span id="l15.777" class="difflineminus">-    return;</span>
<a href="#l15.778"></a><span id="l15.778" class="difflineplus">+  if (!mOAuth2Support) return;</span>
<a href="#l15.779"></a><span id="l15.779"> </span>
<a href="#l15.780"></a><span id="l15.780">   nsCOMPtr&lt;nsIRunnable&gt; runInit =</span>
<a href="#l15.781"></a><span id="l15.781" class="difflineminus">-    NewRunnableMethod(&quot;OAuth2ThreadHelper::GetXOAuth2String&quot;, this, &amp;OAuth2ThreadHelper::Connect);</span>
<a href="#l15.782"></a><span id="l15.782" class="difflineplus">+      NewRunnableMethod(&quot;OAuth2ThreadHelper::GetXOAuth2String&quot;, this,</span>
<a href="#l15.783"></a><span id="l15.783" class="difflineplus">+                        &amp;OAuth2ThreadHelper::Connect);</span>
<a href="#l15.784"></a><span id="l15.784">   NS_DispatchToMainThread(runInit);</span>
<a href="#l15.785"></a><span id="l15.785">   mMonitor.Wait();</span>
<a href="#l15.786"></a><span id="l15.786"> </span>
<a href="#l15.787"></a><span id="l15.787">   // Now we either have the string, or we failed (in which case the string is</span>
<a href="#l15.788"></a><span id="l15.788">   // empty).</span>
<a href="#l15.789"></a><span id="l15.789">   base64Str = mOAuth2String;</span>
<a href="#l15.790"></a><span id="l15.790"> }</span>
<a href="#l15.791"></a><span id="l15.791"> </span>
<a href="#l15.792"></a><span id="l15.792" class="difflineminus">-void OAuth2ThreadHelper::Init()</span>
<a href="#l15.793"></a><span id="l15.793" class="difflineminus">-{</span>
<a href="#l15.794"></a><span id="l15.794" class="difflineplus">+void OAuth2ThreadHelper::Init() {</span>
<a href="#l15.795"></a><span id="l15.795">   MOZ_ASSERT(NS_IsMainThread(), &quot;Can't touch JS off-main-thread&quot;);</span>
<a href="#l15.796"></a><span id="l15.796">   MonitorAutoLock lockGuard(mMonitor);</span>
<a href="#l15.797"></a><span id="l15.797"> </span>
<a href="#l15.798"></a><span id="l15.798">   // Create the OAuth2 helper module and initialize it. If the preferences are</span>
<a href="#l15.799"></a><span id="l15.799">   // not set up on this server, we don't support OAuth2, and we nullify our</span>
<a href="#l15.800"></a><span id="l15.800">   // members to indicate this.</span>
<a href="#l15.801"></a><span id="l15.801">   mOAuth2Support = do_CreateInstance(MSGIOAUTH2MODULE_CONTRACTID);</span>
<a href="#l15.802"></a><span id="l15.802" class="difflineminus">-  if (mOAuth2Support)</span>
<a href="#l15.803"></a><span id="l15.803" class="difflineminus">-  {</span>
<a href="#l15.804"></a><span id="l15.804" class="difflineplus">+  if (mOAuth2Support) {</span>
<a href="#l15.805"></a><span id="l15.805">     bool supportsOAuth = false;</span>
<a href="#l15.806"></a><span id="l15.806">     mOAuth2Support-&gt;InitFromMail(mServer, &amp;supportsOAuth);</span>
<a href="#l15.807"></a><span id="l15.807" class="difflineminus">-    if (!supportsOAuth)</span>
<a href="#l15.808"></a><span id="l15.808" class="difflineminus">-      mOAuth2Support = nullptr;</span>
<a href="#l15.809"></a><span id="l15.809" class="difflineplus">+    if (!supportsOAuth) mOAuth2Support = nullptr;</span>
<a href="#l15.810"></a><span id="l15.810">   }</span>
<a href="#l15.811"></a><span id="l15.811"> </span>
<a href="#l15.812"></a><span id="l15.812">   // There is now no longer any need for the server. Kill it now--this helps</span>
<a href="#l15.813"></a><span id="l15.813">   // prevent us from maintaining a refcount cycle.</span>
<a href="#l15.814"></a><span id="l15.814">   mServer = nullptr;</span>
<a href="#l15.815"></a><span id="l15.815"> </span>
<a href="#l15.816"></a><span id="l15.816">   // Notify anyone waiting that we're done.</span>
<a href="#l15.817"></a><span id="l15.817">   mMonitor.Notify();</span>
<a href="#l15.818"></a><span id="l15.818"> }</span>
<a href="#l15.819"></a><span id="l15.819"> </span>
<a href="#l15.820"></a><span id="l15.820" class="difflineminus">-void OAuth2ThreadHelper::Connect()</span>
<a href="#l15.821"></a><span id="l15.821" class="difflineminus">-{</span>
<a href="#l15.822"></a><span id="l15.822" class="difflineplus">+void OAuth2ThreadHelper::Connect() {</span>
<a href="#l15.823"></a><span id="l15.823">   MOZ_ASSERT(NS_IsMainThread(), &quot;Can't touch JS off-main-thread&quot;);</span>
<a href="#l15.824"></a><span id="l15.824">   MOZ_ASSERT(mOAuth2Support, &quot;Should not be here if no OAuth2 support&quot;);</span>
<a href="#l15.825"></a><span id="l15.825"> </span>
<a href="#l15.826"></a><span id="l15.826">   // OK to delay lock since mOAuth2Support is only written on main thread.</span>
<a href="#l15.827"></a><span id="l15.827">   nsresult rv = mOAuth2Support-&gt;Connect(true, this);</span>
<a href="#l15.828"></a><span id="l15.828">   // If the method failed, we'll never get a callback, so notify the monitor</span>
<a href="#l15.829"></a><span id="l15.829">   // immediately so that IMAP can react.</span>
<a href="#l15.830"></a><span id="l15.830" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l15.831"></a><span id="l15.831" class="difflineminus">-  {</span>
<a href="#l15.832"></a><span id="l15.832" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l15.833"></a><span id="l15.833">     MonitorAutoLock lockGuard(mMonitor);</span>
<a href="#l15.834"></a><span id="l15.834">     mMonitor.Notify();</span>
<a href="#l15.835"></a><span id="l15.835">   }</span>
<a href="#l15.836"></a><span id="l15.836"> }</span>
<a href="#l15.837"></a><span id="l15.837"> </span>
<a href="#l15.838"></a><span id="l15.838" class="difflineminus">-nsresult OAuth2ThreadHelper::OnSuccess(const nsACString &amp;aOAuth2String)</span>
<a href="#l15.839"></a><span id="l15.839" class="difflineminus">-{</span>
<a href="#l15.840"></a><span id="l15.840" class="difflineplus">+nsresult OAuth2ThreadHelper::OnSuccess(const nsACString &amp;aOAuth2String) {</span>
<a href="#l15.841"></a><span id="l15.841">   MOZ_ASSERT(NS_IsMainThread(), &quot;Can't touch JS off-main-thread&quot;);</span>
<a href="#l15.842"></a><span id="l15.842">   MonitorAutoLock lockGuard(mMonitor);</span>
<a href="#l15.843"></a><span id="l15.843"> </span>
<a href="#l15.844"></a><span id="l15.844">   MOZ_ASSERT(mOAuth2Support, &quot;Should not be here if no OAuth2 support&quot;);</span>
<a href="#l15.845"></a><span id="l15.845">   mOAuth2String = aOAuth2String;</span>
<a href="#l15.846"></a><span id="l15.846">   mMonitor.Notify();</span>
<a href="#l15.847"></a><span id="l15.847">   return NS_OK;</span>
<a href="#l15.848"></a><span id="l15.848"> }</span>
<a href="#l15.849"></a><span id="l15.849"> </span>
<a href="#l15.850"></a><span id="l15.850" class="difflineminus">-nsresult OAuth2ThreadHelper::OnFailure(nsresult aError)</span>
<a href="#l15.851"></a><span id="l15.851" class="difflineminus">-{</span>
<a href="#l15.852"></a><span id="l15.852" class="difflineplus">+nsresult OAuth2ThreadHelper::OnFailure(nsresult aError) {</span>
<a href="#l15.853"></a><span id="l15.853">   MOZ_ASSERT(NS_IsMainThread(), &quot;Can't touch JS off-main-thread&quot;);</span>
<a href="#l15.854"></a><span id="l15.854">   MonitorAutoLock lockGuard(mMonitor);</span>
<a href="#l15.855"></a><span id="l15.855"> </span>
<a href="#l15.856"></a><span id="l15.856">   mOAuth2String.Truncate();</span>
<a href="#l15.857"></a><span id="l15.857">   mMonitor.Notify();</span>
<a href="#l15.858"></a><span id="l15.858">   return NS_OK;</span>
<a href="#l15.859"></a><span id="l15.859"> }</span>
<a href="#l15.860"></a><span id="l15.860"> </span>
<a href="#l15.861"></a><span id="l15.861" class="difflineminus">-} // namespace mailnews</span>
<a href="#l15.862"></a><span id="l15.862" class="difflineminus">-} // namespace mozilla</span>
<a href="#l15.863"></a><span id="l15.863" class="difflineplus">+}  // namespace mailnews</span>
<a href="#l15.864"></a><span id="l15.864" class="difflineplus">+}  // namespace mozilla</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mailnews/imap/src/nsSyncRunnableHelpers.h</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mailnews/imap/src/nsSyncRunnableHelpers.h</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -15,137 +15,135 @@</span>
<a href="#l16.4"></a><span id="l16.4"> #include &quot;nsIImapServerSink.h&quot;</span>
<a href="#l16.5"></a><span id="l16.5"> #include &quot;nsIImapProtocolSink.h&quot;</span>
<a href="#l16.6"></a><span id="l16.6"> #include &quot;nsIImapMessageSink.h&quot;</span>
<a href="#l16.7"></a><span id="l16.7"> </span>
<a href="#l16.8"></a><span id="l16.8"> // The classes in this file proxy method calls to the main thread</span>
<a href="#l16.9"></a><span id="l16.9"> // synchronously. The main thread must not block on this thread, or a</span>
<a href="#l16.10"></a><span id="l16.10"> // deadlock condition can occur.</span>
<a href="#l16.11"></a><span id="l16.11"> </span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-class StreamListenerProxy final : public nsIStreamListener</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineminus">-{</span>
<a href="#l16.14"></a><span id="l16.14" class="difflineminus">-public:</span>
<a href="#l16.15"></a><span id="l16.15" class="difflineplus">+class StreamListenerProxy final : public nsIStreamListener {</span>
<a href="#l16.16"></a><span id="l16.16" class="difflineplus">+ public:</span>
<a href="#l16.17"></a><span id="l16.17">   explicit StreamListenerProxy(nsIStreamListener* receiver)</span>
<a href="#l16.18"></a><span id="l16.18" class="difflineminus">-    : mReceiver(receiver)</span>
<a href="#l16.19"></a><span id="l16.19" class="difflineminus">-  {</span>
<a href="#l16.20"></a><span id="l16.20" class="difflineminus">-    MOZ_DIAGNOSTIC_ASSERT(receiver, &quot;Null receiver, crash now to get feedback instead of later&quot;);</span>
<a href="#l16.21"></a><span id="l16.21" class="difflineplus">+      : mReceiver(receiver) {</span>
<a href="#l16.22"></a><span id="l16.22" class="difflineplus">+    MOZ_DIAGNOSTIC_ASSERT(</span>
<a href="#l16.23"></a><span id="l16.23" class="difflineplus">+        receiver, &quot;Null receiver, crash now to get feedback instead of later&quot;);</span>
<a href="#l16.24"></a><span id="l16.24">   }</span>
<a href="#l16.25"></a><span id="l16.25"> </span>
<a href="#l16.26"></a><span id="l16.26">   NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l16.27"></a><span id="l16.27">   NS_DECL_NSIREQUESTOBSERVER</span>
<a href="#l16.28"></a><span id="l16.28">   NS_DECL_NSISTREAMLISTENER</span>
<a href="#l16.29"></a><span id="l16.29"> </span>
<a href="#l16.30"></a><span id="l16.30" class="difflineminus">-private:</span>
<a href="#l16.31"></a><span id="l16.31" class="difflineplus">+ private:</span>
<a href="#l16.32"></a><span id="l16.32">   ~StreamListenerProxy() {</span>
<a href="#l16.33"></a><span id="l16.33" class="difflineminus">-    NS_ReleaseOnMainThreadSystemGroup(&quot;StreamListenerProxy::mReceiver&quot;, mReceiver.forget());</span>
<a href="#l16.34"></a><span id="l16.34" class="difflineplus">+    NS_ReleaseOnMainThreadSystemGroup(&quot;StreamListenerProxy::mReceiver&quot;,</span>
<a href="#l16.35"></a><span id="l16.35" class="difflineplus">+                                      mReceiver.forget());</span>
<a href="#l16.36"></a><span id="l16.36">   }</span>
<a href="#l16.37"></a><span id="l16.37">   nsCOMPtr&lt;nsIStreamListener&gt; mReceiver;</span>
<a href="#l16.38"></a><span id="l16.38"> };</span>
<a href="#l16.39"></a><span id="l16.39"> </span>
<a href="#l16.40"></a><span id="l16.40" class="difflineminus">-class ImapMailFolderSinkProxy final : public nsIImapMailFolderSink</span>
<a href="#l16.41"></a><span id="l16.41" class="difflineminus">-{</span>
<a href="#l16.42"></a><span id="l16.42" class="difflineminus">-public:</span>
<a href="#l16.43"></a><span id="l16.43" class="difflineplus">+class ImapMailFolderSinkProxy final : public nsIImapMailFolderSink {</span>
<a href="#l16.44"></a><span id="l16.44" class="difflineplus">+ public:</span>
<a href="#l16.45"></a><span id="l16.45">   explicit ImapMailFolderSinkProxy(nsIImapMailFolderSink* receiver)</span>
<a href="#l16.46"></a><span id="l16.46" class="difflineminus">-    : mReceiver(receiver)</span>
<a href="#l16.47"></a><span id="l16.47" class="difflineminus">-  {</span>
<a href="#l16.48"></a><span id="l16.48" class="difflineminus">-    MOZ_DIAGNOSTIC_ASSERT(receiver, &quot;Null receiver, crash now to get feedback instead of later&quot;);</span>
<a href="#l16.49"></a><span id="l16.49" class="difflineplus">+      : mReceiver(receiver) {</span>
<a href="#l16.50"></a><span id="l16.50" class="difflineplus">+    MOZ_DIAGNOSTIC_ASSERT(</span>
<a href="#l16.51"></a><span id="l16.51" class="difflineplus">+        receiver, &quot;Null receiver, crash now to get feedback instead of later&quot;);</span>
<a href="#l16.52"></a><span id="l16.52">   }</span>
<a href="#l16.53"></a><span id="l16.53"> </span>
<a href="#l16.54"></a><span id="l16.54">   NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l16.55"></a><span id="l16.55">   NS_DECL_NSIIMAPMAILFOLDERSINK</span>
<a href="#l16.56"></a><span id="l16.56"> </span>
<a href="#l16.57"></a><span id="l16.57" class="difflineminus">-private:</span>
<a href="#l16.58"></a><span id="l16.58" class="difflineplus">+ private:</span>
<a href="#l16.59"></a><span id="l16.59">   ~ImapMailFolderSinkProxy() {</span>
<a href="#l16.60"></a><span id="l16.60" class="difflineminus">-    NS_ReleaseOnMainThreadSystemGroup(&quot;ImapMailFolderSinkProxy::mReceiver&quot;, mReceiver.forget());</span>
<a href="#l16.61"></a><span id="l16.61" class="difflineplus">+    NS_ReleaseOnMainThreadSystemGroup(&quot;ImapMailFolderSinkProxy::mReceiver&quot;,</span>
<a href="#l16.62"></a><span id="l16.62" class="difflineplus">+                                      mReceiver.forget());</span>
<a href="#l16.63"></a><span id="l16.63">   }</span>
<a href="#l16.64"></a><span id="l16.64">   nsCOMPtr&lt;nsIImapMailFolderSink&gt; mReceiver;</span>
<a href="#l16.65"></a><span id="l16.65"> };</span>
<a href="#l16.66"></a><span id="l16.66"> </span>
<a href="#l16.67"></a><span id="l16.67" class="difflineminus">-class ImapServerSinkProxy final : public nsIImapServerSink</span>
<a href="#l16.68"></a><span id="l16.68" class="difflineminus">-{</span>
<a href="#l16.69"></a><span id="l16.69" class="difflineminus">-public:</span>
<a href="#l16.70"></a><span id="l16.70" class="difflineplus">+class ImapServerSinkProxy final : public nsIImapServerSink {</span>
<a href="#l16.71"></a><span id="l16.71" class="difflineplus">+ public:</span>
<a href="#l16.72"></a><span id="l16.72">   explicit ImapServerSinkProxy(nsIImapServerSink* receiver)</span>
<a href="#l16.73"></a><span id="l16.73" class="difflineminus">-    : mReceiver(receiver)</span>
<a href="#l16.74"></a><span id="l16.74" class="difflineminus">-  {</span>
<a href="#l16.75"></a><span id="l16.75" class="difflineminus">-    MOZ_DIAGNOSTIC_ASSERT(receiver, &quot;Null receiver, crash now to get feedback instead of later&quot;);</span>
<a href="#l16.76"></a><span id="l16.76" class="difflineplus">+      : mReceiver(receiver) {</span>
<a href="#l16.77"></a><span id="l16.77" class="difflineplus">+    MOZ_DIAGNOSTIC_ASSERT(</span>
<a href="#l16.78"></a><span id="l16.78" class="difflineplus">+        receiver, &quot;Null receiver, crash now to get feedback instead of later&quot;);</span>
<a href="#l16.79"></a><span id="l16.79">   }</span>
<a href="#l16.80"></a><span id="l16.80"> </span>
<a href="#l16.81"></a><span id="l16.81">   NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l16.82"></a><span id="l16.82">   NS_DECL_NSIIMAPSERVERSINK</span>
<a href="#l16.83"></a><span id="l16.83"> </span>
<a href="#l16.84"></a><span id="l16.84" class="difflineminus">-private:</span>
<a href="#l16.85"></a><span id="l16.85" class="difflineplus">+ private:</span>
<a href="#l16.86"></a><span id="l16.86">   ~ImapServerSinkProxy() {</span>
<a href="#l16.87"></a><span id="l16.87" class="difflineminus">-    NS_ReleaseOnMainThreadSystemGroup(&quot;ImapServerSinkProxy::mReceiver&quot;, mReceiver.forget());</span>
<a href="#l16.88"></a><span id="l16.88" class="difflineplus">+    NS_ReleaseOnMainThreadSystemGroup(&quot;ImapServerSinkProxy::mReceiver&quot;,</span>
<a href="#l16.89"></a><span id="l16.89" class="difflineplus">+                                      mReceiver.forget());</span>
<a href="#l16.90"></a><span id="l16.90">   }</span>
<a href="#l16.91"></a><span id="l16.91">   nsCOMPtr&lt;nsIImapServerSink&gt; mReceiver;</span>
<a href="#l16.92"></a><span id="l16.92"> };</span>
<a href="#l16.93"></a><span id="l16.93"> </span>
<a href="#l16.94"></a><span id="l16.94" class="difflineminus">-</span>
<a href="#l16.95"></a><span id="l16.95" class="difflineminus">-class ImapMessageSinkProxy final : public nsIImapMessageSink</span>
<a href="#l16.96"></a><span id="l16.96" class="difflineminus">-{</span>
<a href="#l16.97"></a><span id="l16.97" class="difflineminus">-public:</span>
<a href="#l16.98"></a><span id="l16.98" class="difflineplus">+class ImapMessageSinkProxy final : public nsIImapMessageSink {</span>
<a href="#l16.99"></a><span id="l16.99" class="difflineplus">+ public:</span>
<a href="#l16.100"></a><span id="l16.100">   explicit ImapMessageSinkProxy(nsIImapMessageSink* receiver)</span>
<a href="#l16.101"></a><span id="l16.101" class="difflineminus">-    : mReceiver(receiver)</span>
<a href="#l16.102"></a><span id="l16.102" class="difflineminus">-  {</span>
<a href="#l16.103"></a><span id="l16.103" class="difflineminus">-    MOZ_DIAGNOSTIC_ASSERT(receiver, &quot;Null receiver, crash now to get feedback instead of later&quot;);</span>
<a href="#l16.104"></a><span id="l16.104" class="difflineplus">+      : mReceiver(receiver) {</span>
<a href="#l16.105"></a><span id="l16.105" class="difflineplus">+    MOZ_DIAGNOSTIC_ASSERT(</span>
<a href="#l16.106"></a><span id="l16.106" class="difflineplus">+        receiver, &quot;Null receiver, crash now to get feedback instead of later&quot;);</span>
<a href="#l16.107"></a><span id="l16.107">   }</span>
<a href="#l16.108"></a><span id="l16.108"> </span>
<a href="#l16.109"></a><span id="l16.109">   NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l16.110"></a><span id="l16.110">   NS_DECL_NSIIMAPMESSAGESINK</span>
<a href="#l16.111"></a><span id="l16.111"> </span>
<a href="#l16.112"></a><span id="l16.112" class="difflineminus">-private:</span>
<a href="#l16.113"></a><span id="l16.113" class="difflineplus">+ private:</span>
<a href="#l16.114"></a><span id="l16.114">   ~ImapMessageSinkProxy() {</span>
<a href="#l16.115"></a><span id="l16.115" class="difflineminus">-    NS_ReleaseOnMainThreadSystemGroup(&quot;ImapMessageSinkProxy::mReceiver&quot;, mReceiver.forget());</span>
<a href="#l16.116"></a><span id="l16.116" class="difflineplus">+    NS_ReleaseOnMainThreadSystemGroup(&quot;ImapMessageSinkProxy::mReceiver&quot;,</span>
<a href="#l16.117"></a><span id="l16.117" class="difflineplus">+                                      mReceiver.forget());</span>
<a href="#l16.118"></a><span id="l16.118">   }</span>
<a href="#l16.119"></a><span id="l16.119">   nsCOMPtr&lt;nsIImapMessageSink&gt; mReceiver;</span>
<a href="#l16.120"></a><span id="l16.120"> };</span>
<a href="#l16.121"></a><span id="l16.121"> </span>
<a href="#l16.122"></a><span id="l16.122" class="difflineminus">-class ImapProtocolSinkProxy final : public nsIImapProtocolSink</span>
<a href="#l16.123"></a><span id="l16.123" class="difflineminus">-{</span>
<a href="#l16.124"></a><span id="l16.124" class="difflineminus">-public:</span>
<a href="#l16.125"></a><span id="l16.125" class="difflineplus">+class ImapProtocolSinkProxy final : public nsIImapProtocolSink {</span>
<a href="#l16.126"></a><span id="l16.126" class="difflineplus">+ public:</span>
<a href="#l16.127"></a><span id="l16.127">   explicit ImapProtocolSinkProxy(nsIImapProtocolSink* receiver)</span>
<a href="#l16.128"></a><span id="l16.128" class="difflineminus">-    : mReceiver(receiver)</span>
<a href="#l16.129"></a><span id="l16.129" class="difflineminus">-  {</span>
<a href="#l16.130"></a><span id="l16.130" class="difflineminus">-    MOZ_DIAGNOSTIC_ASSERT(receiver, &quot;Null receiver, crash now to get feedback instead of later&quot;);</span>
<a href="#l16.131"></a><span id="l16.131" class="difflineplus">+      : mReceiver(receiver) {</span>
<a href="#l16.132"></a><span id="l16.132" class="difflineplus">+    MOZ_DIAGNOSTIC_ASSERT(</span>
<a href="#l16.133"></a><span id="l16.133" class="difflineplus">+        receiver, &quot;Null receiver, crash now to get feedback instead of later&quot;);</span>
<a href="#l16.134"></a><span id="l16.134">   }</span>
<a href="#l16.135"></a><span id="l16.135"> </span>
<a href="#l16.136"></a><span id="l16.136">   NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l16.137"></a><span id="l16.137">   NS_DECL_NSIIMAPPROTOCOLSINK</span>
<a href="#l16.138"></a><span id="l16.138"> </span>
<a href="#l16.139"></a><span id="l16.139" class="difflineminus">-private:</span>
<a href="#l16.140"></a><span id="l16.140" class="difflineplus">+ private:</span>
<a href="#l16.141"></a><span id="l16.141">   ~ImapProtocolSinkProxy() {</span>
<a href="#l16.142"></a><span id="l16.142" class="difflineminus">-    NS_ReleaseOnMainThreadSystemGroup(&quot;ImapProtocolSinkProxy::mReceiver&quot;, mReceiver.forget());</span>
<a href="#l16.143"></a><span id="l16.143" class="difflineplus">+    NS_ReleaseOnMainThreadSystemGroup(&quot;ImapProtocolSinkProxy::mReceiver&quot;,</span>
<a href="#l16.144"></a><span id="l16.144" class="difflineplus">+                                      mReceiver.forget());</span>
<a href="#l16.145"></a><span id="l16.145">   }</span>
<a href="#l16.146"></a><span id="l16.146">   nsCOMPtr&lt;nsIImapProtocolSink&gt; mReceiver;</span>
<a href="#l16.147"></a><span id="l16.147"> };</span>
<a href="#l16.148"></a><span id="l16.148"> </span>
<a href="#l16.149"></a><span id="l16.149"> class msgIOAuth2Module;</span>
<a href="#l16.150"></a><span id="l16.150"> class nsIMsgIncomingServer;</span>
<a href="#l16.151"></a><span id="l16.151"> </span>
<a href="#l16.152"></a><span id="l16.152"> namespace mozilla {</span>
<a href="#l16.153"></a><span id="l16.153"> namespace mailnews {</span>
<a href="#l16.154"></a><span id="l16.154"> </span>
<a href="#l16.155"></a><span id="l16.155" class="difflineminus">-class OAuth2ThreadHelper final : public msgIOAuth2ModuleListener</span>
<a href="#l16.156"></a><span id="l16.156" class="difflineminus">-{</span>
<a href="#l16.157"></a><span id="l16.157" class="difflineminus">-public:</span>
<a href="#l16.158"></a><span id="l16.158" class="difflineminus">-  explicit OAuth2ThreadHelper(nsIMsgIncomingServer *aServer);</span>
<a href="#l16.159"></a><span id="l16.159" class="difflineplus">+class OAuth2ThreadHelper final : public msgIOAuth2ModuleListener {</span>
<a href="#l16.160"></a><span id="l16.160" class="difflineplus">+ public:</span>
<a href="#l16.161"></a><span id="l16.161" class="difflineplus">+  explicit OAuth2ThreadHelper(nsIMsgIncomingServer* aServer);</span>
<a href="#l16.162"></a><span id="l16.162"> </span>
<a href="#l16.163"></a><span id="l16.163">   NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l16.164"></a><span id="l16.164">   NS_DECL_MSGIOAUTH2MODULELISTENER</span>
<a href="#l16.165"></a><span id="l16.165"> </span>
<a href="#l16.166"></a><span id="l16.166">   bool SupportsOAuth2();</span>
<a href="#l16.167"></a><span id="l16.167" class="difflineminus">-  void GetXOAuth2String(nsACString &amp;base64Str);</span>
<a href="#l16.168"></a><span id="l16.168" class="difflineplus">+  void GetXOAuth2String(nsACString&amp; base64Str);</span>
<a href="#l16.169"></a><span id="l16.169"> </span>
<a href="#l16.170"></a><span id="l16.170" class="difflineminus">-private:</span>
<a href="#l16.171"></a><span id="l16.171" class="difflineplus">+ private:</span>
<a href="#l16.172"></a><span id="l16.172">   ~OAuth2ThreadHelper();</span>
<a href="#l16.173"></a><span id="l16.173">   void Init();</span>
<a href="#l16.174"></a><span id="l16.174">   void Connect();</span>
<a href="#l16.175"></a><span id="l16.175"> </span>
<a href="#l16.176"></a><span id="l16.176">   Monitor mMonitor;</span>
<a href="#l16.177"></a><span id="l16.177">   nsCOMPtr&lt;msgIOAuth2Module&gt; mOAuth2Support;</span>
<a href="#l16.178"></a><span id="l16.178">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; mServer;</span>
<a href="#l16.179"></a><span id="l16.179">   nsCString mOAuth2String;</span>
<a href="#l16.180"></a><span id="l16.180"> };</span>
<a href="#l16.181"></a><span id="l16.181"> </span>
<a href="#l16.182"></a><span id="l16.182" class="difflineminus">-} // namespace mailnews</span>
<a href="#l16.183"></a><span id="l16.183" class="difflineminus">-} // namespace mozilla</span>
<a href="#l16.184"></a><span id="l16.184" class="difflineplus">+}  // namespace mailnews</span>
<a href="#l16.185"></a><span id="l16.185" class="difflineplus">+}  // namespace mozilla</span>
<a href="#l16.186"></a><span id="l16.186"> </span>
<a href="#l16.187"></a><span id="l16.187" class="difflineminus">-#endif // nsSyncRunnableHelpers_h</span>
<a href="#l16.188"></a><span id="l16.188" class="difflineplus">+#endif  // nsSyncRunnableHelpers_h</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mailnews/imap/test/TestImapFlagAndUidState.cpp</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mailnews/imap/test/TestImapFlagAndUidState.cpp</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -11,171 +11,156 @@</span>
<a href="#l17.4"></a><span id="l17.4"> struct msgState {</span>
<a href="#l17.5"></a><span id="l17.5">   uint32_t uid;</span>
<a href="#l17.6"></a><span id="l17.6">   uint16_t flag;</span>
<a href="#l17.7"></a><span id="l17.7">   uint32_t index;</span>
<a href="#l17.8"></a><span id="l17.8"> };</span>
<a href="#l17.9"></a><span id="l17.9"> </span>
<a href="#l17.10"></a><span id="l17.10"> char errorMsg[200];</span>
<a href="#l17.11"></a><span id="l17.11"> </span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-const char * MainChecks(nsImapFlagAndUidState* flagState, struct msgState *expectedState,</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineminus">-               uint32_t numMessages, uint32_t expectedNumUnread)</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineminus">-{</span>
<a href="#l17.15"></a><span id="l17.15" class="difflineplus">+const char* MainChecks(nsImapFlagAndUidState* flagState,</span>
<a href="#l17.16"></a><span id="l17.16" class="difflineplus">+                       struct msgState* expectedState, uint32_t numMessages,</span>
<a href="#l17.17"></a><span id="l17.17" class="difflineplus">+                       uint32_t expectedNumUnread) {</span>
<a href="#l17.18"></a><span id="l17.18">   // Verify that flag state matches the expected state.</span>
<a href="#l17.19"></a><span id="l17.19" class="difflineminus">-  for (uint32_t i = 0; i &lt; numMessages; i ++)</span>
<a href="#l17.20"></a><span id="l17.20" class="difflineminus">-  {</span>
<a href="#l17.21"></a><span id="l17.21" class="difflineplus">+  for (uint32_t i = 0; i &lt; numMessages; i++) {</span>
<a href="#l17.22"></a><span id="l17.22">     uint32_t uid;</span>
<a href="#l17.23"></a><span id="l17.23">     uint16_t flag;</span>
<a href="#l17.24"></a><span id="l17.24">     flagState-&gt;GetUidOfMessage(expectedState[i].index, &amp;uid);</span>
<a href="#l17.25"></a><span id="l17.25">     flagState-&gt;GetMessageFlags(expectedState[i].index, &amp;flag);</span>
<a href="#l17.26"></a><span id="l17.26" class="difflineminus">-    if (uid != expectedState[i].uid)</span>
<a href="#l17.27"></a><span id="l17.27" class="difflineminus">-    {</span>
<a href="#l17.28"></a><span id="l17.28" class="difflineplus">+    if (uid != expectedState[i].uid) {</span>
<a href="#l17.29"></a><span id="l17.29">       PR_snprintf(errorMsg, sizeof(errorMsg),</span>
<a href="#l17.30"></a><span id="l17.30">                   &quot;expected uid %d, got %d at index %d\n&quot;, expectedState[i].uid,</span>
<a href="#l17.31"></a><span id="l17.31">                   uid, i);</span>
<a href="#l17.32"></a><span id="l17.32">       return errorMsg;</span>
<a href="#l17.33"></a><span id="l17.33">     }</span>
<a href="#l17.34"></a><span id="l17.34" class="difflineminus">-    if (flag != expectedState[i].flag)</span>
<a href="#l17.35"></a><span id="l17.35" class="difflineminus">-    {</span>
<a href="#l17.36"></a><span id="l17.36" class="difflineplus">+    if (flag != expectedState[i].flag) {</span>
<a href="#l17.37"></a><span id="l17.37">       PR_snprintf(errorMsg, sizeof(errorMsg),</span>
<a href="#l17.38"></a><span id="l17.38" class="difflineminus">-                  &quot;expected flag %d, got %d at index %d\n&quot;, expectedState[i].flag,</span>
<a href="#l17.39"></a><span id="l17.39" class="difflineminus">-                  flag, i);</span>
<a href="#l17.40"></a><span id="l17.40" class="difflineplus">+                  &quot;expected flag %d, got %d at index %d\n&quot;,</span>
<a href="#l17.41"></a><span id="l17.41" class="difflineplus">+                  expectedState[i].flag, flag, i);</span>
<a href="#l17.42"></a><span id="l17.42">       return errorMsg;</span>
<a href="#l17.43"></a><span id="l17.43">     }</span>
<a href="#l17.44"></a><span id="l17.44">   }</span>
<a href="#l17.45"></a><span id="l17.45">   int32_t numMsgsInFlagState;</span>
<a href="#l17.46"></a><span id="l17.46">   int32_t numUnread = 0;</span>
<a href="#l17.47"></a><span id="l17.47">   int32_t expectedMsgIndex = 0;</span>
<a href="#l17.48"></a><span id="l17.48"> </span>
<a href="#l17.49"></a><span id="l17.49">   flagState-&gt;GetNumberOfMessages(&amp;numMsgsInFlagState);</span>
<a href="#l17.50"></a><span id="l17.50" class="difflineminus">-  for (int32_t msgIndex = 0; msgIndex &lt; numMsgsInFlagState; msgIndex++)</span>
<a href="#l17.51"></a><span id="l17.51" class="difflineminus">-  {</span>
<a href="#l17.52"></a><span id="l17.52" class="difflineplus">+  for (int32_t msgIndex = 0; msgIndex &lt; numMsgsInFlagState; msgIndex++) {</span>
<a href="#l17.53"></a><span id="l17.53">     uint32_t uidOfMessage;</span>
<a href="#l17.54"></a><span id="l17.54">     flagState-&gt;GetUidOfMessage(msgIndex, &amp;uidOfMessage);</span>
<a href="#l17.55"></a><span id="l17.55" class="difflineminus">-    if (!uidOfMessage || uidOfMessage == nsMsgKey_None)</span>
<a href="#l17.56"></a><span id="l17.56" class="difflineminus">-      continue;</span>
<a href="#l17.57"></a><span id="l17.57" class="difflineminus">-    if (uidOfMessage != expectedState[expectedMsgIndex++].uid)</span>
<a href="#l17.58"></a><span id="l17.58" class="difflineminus">-    {</span>
<a href="#l17.59"></a><span id="l17.59" class="difflineminus">-      PR_snprintf(errorMsg, sizeof(errorMsg),</span>
<a href="#l17.60"></a><span id="l17.60" class="difflineminus">-                  &quot;got a uid w/o a match in expected state, uid %d at index %d\n&quot;,</span>
<a href="#l17.61"></a><span id="l17.61" class="difflineminus">-                  uidOfMessage, msgIndex);</span>
<a href="#l17.62"></a><span id="l17.62" class="difflineplus">+    if (!uidOfMessage || uidOfMessage == nsMsgKey_None) continue;</span>
<a href="#l17.63"></a><span id="l17.63" class="difflineplus">+    if (uidOfMessage != expectedState[expectedMsgIndex++].uid) {</span>
<a href="#l17.64"></a><span id="l17.64" class="difflineplus">+      PR_snprintf(</span>
<a href="#l17.65"></a><span id="l17.65" class="difflineplus">+          errorMsg, sizeof(errorMsg),</span>
<a href="#l17.66"></a><span id="l17.66" class="difflineplus">+          &quot;got a uid w/o a match in expected state, uid %d at index %d\n&quot;,</span>
<a href="#l17.67"></a><span id="l17.67" class="difflineplus">+          uidOfMessage, msgIndex);</span>
<a href="#l17.68"></a><span id="l17.68">       return errorMsg;</span>
<a href="#l17.69"></a><span id="l17.69">     }</span>
<a href="#l17.70"></a><span id="l17.70">     imapMessageFlagsType flags;</span>
<a href="#l17.71"></a><span id="l17.71">     flagState-&gt;GetMessageFlags(msgIndex, &amp;flags);</span>
<a href="#l17.72"></a><span id="l17.72" class="difflineminus">-    if (! (flags &amp; kImapMsgSeenFlag))</span>
<a href="#l17.73"></a><span id="l17.73" class="difflineminus">-      numUnread++;</span>
<a href="#l17.74"></a><span id="l17.74" class="difflineplus">+    if (!(flags &amp; kImapMsgSeenFlag)) numUnread++;</span>
<a href="#l17.75"></a><span id="l17.75">   }</span>
<a href="#l17.76"></a><span id="l17.76" class="difflineminus">-  if (numUnread != expectedNumUnread)</span>
<a href="#l17.77"></a><span id="l17.77" class="difflineminus">-  {</span>
<a href="#l17.78"></a><span id="l17.78" class="difflineminus">-      PR_snprintf(errorMsg, sizeof(errorMsg),</span>
<a href="#l17.79"></a><span id="l17.79" class="difflineminus">-                  &quot;expected %d unread message, got %d\n&quot;, expectedNumUnread,</span>
<a href="#l17.80"></a><span id="l17.80" class="difflineminus">-                  numUnread);</span>
<a href="#l17.81"></a><span id="l17.81" class="difflineminus">-      return errorMsg;</span>
<a href="#l17.82"></a><span id="l17.82" class="difflineplus">+  if (numUnread != expectedNumUnread) {</span>
<a href="#l17.83"></a><span id="l17.83" class="difflineplus">+    PR_snprintf(errorMsg, sizeof(errorMsg),</span>
<a href="#l17.84"></a><span id="l17.84" class="difflineplus">+                &quot;expected %d unread message, got %d\n&quot;, expectedNumUnread,</span>
<a href="#l17.85"></a><span id="l17.85" class="difflineplus">+                numUnread);</span>
<a href="#l17.86"></a><span id="l17.86" class="difflineplus">+    return errorMsg;</span>
<a href="#l17.87"></a><span id="l17.87">   }</span>
<a href="#l17.88"></a><span id="l17.88">   return nullptr;</span>
<a href="#l17.89"></a><span id="l17.89"> }</span>
<a href="#l17.90"></a><span id="l17.90"> </span>
<a href="#l17.91"></a><span id="l17.91"> // General note about return values:</span>
<a href="#l17.92"></a><span id="l17.92"> // return 1 for a setup or xpcom type failure, return 2 for a real test failure</span>
<a href="#l17.93"></a><span id="l17.93" class="difflineminus">-int main(int argc, char** argv)</span>
<a href="#l17.94"></a><span id="l17.94" class="difflineminus">-{</span>
<a href="#l17.95"></a><span id="l17.95" class="difflineplus">+int main(int argc, char** argv) {</span>
<a href="#l17.96"></a><span id="l17.96">   ScopedXPCOM xpcom(&quot;TestImapFlagAndUidState.cpp&quot;);</span>
<a href="#l17.97"></a><span id="l17.97" class="difflineminus">-  if (xpcom.failed())</span>
<a href="#l17.98"></a><span id="l17.98" class="difflineminus">-    return 1;</span>
<a href="#l17.99"></a><span id="l17.99" class="difflineplus">+  if (xpcom.failed()) return 1;</span>
<a href="#l17.100"></a><span id="l17.100"> </span>
<a href="#l17.101"></a><span id="l17.101" class="difflineminus">-  struct msgState msgState1[] = {</span>
<a href="#l17.102"></a><span id="l17.102" class="difflineminus">-  {10, kImapMsgSeenFlag, 0},</span>
<a href="#l17.103"></a><span id="l17.103" class="difflineminus">-  {15, kImapMsgSeenFlag, 1},</span>
<a href="#l17.104"></a><span id="l17.104" class="difflineminus">-  {16, kImapMsgSeenFlag, 2},</span>
<a href="#l17.105"></a><span id="l17.105" class="difflineminus">-  {17, kImapMsgSeenFlag, 3},</span>
<a href="#l17.106"></a><span id="l17.106" class="difflineminus">-  {18, kImapMsgSeenFlag, 4}};</span>
<a href="#l17.107"></a><span id="l17.107" class="difflineplus">+  struct msgState msgState1[] = {{10, kImapMsgSeenFlag, 0},</span>
<a href="#l17.108"></a><span id="l17.108" class="difflineplus">+                                 {15, kImapMsgSeenFlag, 1},</span>
<a href="#l17.109"></a><span id="l17.109" class="difflineplus">+                                 {16, kImapMsgSeenFlag, 2},</span>
<a href="#l17.110"></a><span id="l17.110" class="difflineplus">+                                 {17, kImapMsgSeenFlag, 3},</span>
<a href="#l17.111"></a><span id="l17.111" class="difflineplus">+                                 {18, kImapMsgSeenFlag, 4}};</span>
<a href="#l17.112"></a><span id="l17.112"> </span>
<a href="#l17.113"></a><span id="l17.113">   RefPtr&lt;nsImapFlagAndUidState&gt; flagState = new nsImapFlagAndUidState(10);</span>
<a href="#l17.114"></a><span id="l17.114">   int32_t numMsgs = sizeof(msgState1) / sizeof(msgState1[0]);</span>
<a href="#l17.115"></a><span id="l17.115">   for (int32_t i = 0; i &lt; numMsgs; i++)</span>
<a href="#l17.116"></a><span id="l17.116" class="difflineminus">-        flagState-&gt;AddUidFlagPair(msgState1[i].uid, msgState1[i].flag,</span>
<a href="#l17.117"></a><span id="l17.117" class="difflineminus">-                                  msgState1[i].index);</span>
<a href="#l17.118"></a><span id="l17.118" class="difflineplus">+    flagState-&gt;AddUidFlagPair(msgState1[i].uid, msgState1[i].flag,</span>
<a href="#l17.119"></a><span id="l17.119" class="difflineplus">+                              msgState1[i].index);</span>
<a href="#l17.120"></a><span id="l17.120"> </span>
<a href="#l17.121"></a><span id="l17.121" class="difflineminus">-  const char * error = MainChecks(flagState, msgState1, numMsgs, 0);</span>
<a href="#l17.122"></a><span id="l17.122" class="difflineminus">-  if (error)</span>
<a href="#l17.123"></a><span id="l17.123" class="difflineminus">-  {</span>
<a href="#l17.124"></a><span id="l17.124" class="difflineplus">+  const char* error = MainChecks(flagState, msgState1, numMsgs, 0);</span>
<a href="#l17.125"></a><span id="l17.125" class="difflineplus">+  if (error) {</span>
<a href="#l17.126"></a><span id="l17.126">     printf(&quot;TEST-UNEXPECTED-FAIL | %s | %s\n&quot;, __FILE__, error);</span>
<a href="#l17.127"></a><span id="l17.127">     return 1;</span>
<a href="#l17.128"></a><span id="l17.128">   }</span>
<a href="#l17.129"></a><span id="l17.129"> </span>
<a href="#l17.130"></a><span id="l17.130">   // Now reset all</span>
<a href="#l17.131"></a><span id="l17.131">   flagState-&gt;Reset();</span>
<a href="#l17.132"></a><span id="l17.132"> </span>
<a href="#l17.133"></a><span id="l17.133">   // This tests adding some messages to a partial uid flag state,</span>
<a href="#l17.134"></a><span id="l17.134">   // i.e., CONDSTORE.</span>
<a href="#l17.135"></a><span id="l17.135" class="difflineminus">-  struct msgState msgState2[] = {</span>
<a href="#l17.136"></a><span id="l17.136" class="difflineminus">-    {68, kImapMsgSeenFlag, 69},</span>
<a href="#l17.137"></a><span id="l17.137" class="difflineminus">-    {71, kImapMsgSeenFlag, 70},</span>
<a href="#l17.138"></a><span id="l17.138" class="difflineminus">-    {73, kImapMsgSeenFlag, 71}};</span>
<a href="#l17.139"></a><span id="l17.139" class="difflineplus">+  struct msgState msgState2[] = {{68, kImapMsgSeenFlag, 69},</span>
<a href="#l17.140"></a><span id="l17.140" class="difflineplus">+                                 {71, kImapMsgSeenFlag, 70},</span>
<a href="#l17.141"></a><span id="l17.141" class="difflineplus">+                                 {73, kImapMsgSeenFlag, 71}};</span>
<a href="#l17.142"></a><span id="l17.142">   numMsgs = sizeof(msgState2) / sizeof(msgState2[0]);</span>
<a href="#l17.143"></a><span id="l17.143">   for (int32_t i = 0; i &lt; numMsgs; i++)</span>
<a href="#l17.144"></a><span id="l17.144">     flagState-&gt;AddUidFlagPair(msgState2[i].uid, msgState2[i].flag,</span>
<a href="#l17.145"></a><span id="l17.145">                               msgState2[i].index);</span>
<a href="#l17.146"></a><span id="l17.146">   error = MainChecks(flagState, msgState2, numMsgs, 0);</span>
<a href="#l17.147"></a><span id="l17.147" class="difflineminus">-  if (error)</span>
<a href="#l17.148"></a><span id="l17.148" class="difflineminus">-  {</span>
<a href="#l17.149"></a><span id="l17.149" class="difflineplus">+  if (error) {</span>
<a href="#l17.150"></a><span id="l17.150">     printf(&quot;TEST-UNEXPECTED-FAIL | %s | %s\n&quot;, __FILE__, error);</span>
<a href="#l17.151"></a><span id="l17.151">     return 1;</span>
<a href="#l17.152"></a><span id="l17.152">   }</span>
<a href="#l17.153"></a><span id="l17.153">   // Reset all</span>
<a href="#l17.154"></a><span id="l17.154">   flagState-&gt;Reset();</span>
<a href="#l17.155"></a><span id="l17.155">   // This tests generating a uid string from a non-sequential set of</span>
<a href="#l17.156"></a><span id="l17.156">   // messages where the first message is not in the flag state, but the</span>
<a href="#l17.157"></a><span id="l17.157">   // missing message from the sequence is in the set. I.e., we're</span>
<a href="#l17.158"></a><span id="l17.158">   // generating a uid string from 69,71, but only 70 and 71 are in</span>
<a href="#l17.159"></a><span id="l17.159">   // the flag state.</span>
<a href="#l17.160"></a><span id="l17.160" class="difflineminus">-  struct msgState msgState3[] = {</span>
<a href="#l17.161"></a><span id="l17.161" class="difflineminus">-    {10, kImapMsgSeenFlag, 0},</span>
<a href="#l17.162"></a><span id="l17.162" class="difflineminus">-    {69, kImapMsgSeenFlag, 1},</span>
<a href="#l17.163"></a><span id="l17.163" class="difflineminus">-    {70, kImapMsgSeenFlag, 2},</span>
<a href="#l17.164"></a><span id="l17.164" class="difflineminus">-    {71, kImapMsgSeenFlag, 3}};</span>
<a href="#l17.165"></a><span id="l17.165" class="difflineplus">+  struct msgState msgState3[] = {{10, kImapMsgSeenFlag, 0},</span>
<a href="#l17.166"></a><span id="l17.166" class="difflineplus">+                                 {69, kImapMsgSeenFlag, 1},</span>
<a href="#l17.167"></a><span id="l17.167" class="difflineplus">+                                 {70, kImapMsgSeenFlag, 2},</span>
<a href="#l17.168"></a><span id="l17.168" class="difflineplus">+                                 {71, kImapMsgSeenFlag, 3}};</span>
<a href="#l17.169"></a><span id="l17.169"> </span>
<a href="#l17.170"></a><span id="l17.170">   flagState-&gt;SetPartialUIDFetch(false);</span>
<a href="#l17.171"></a><span id="l17.171">   numMsgs = sizeof(msgState3) / sizeof(msgState3[0]);</span>
<a href="#l17.172"></a><span id="l17.172">   for (int32_t i = 0; i &lt; numMsgs; i++)</span>
<a href="#l17.173"></a><span id="l17.173">     flagState-&gt;AddUidFlagPair(msgState3[i].uid, msgState3[i].flag,</span>
<a href="#l17.174"></a><span id="l17.174">                               msgState3[i].index);</span>
<a href="#l17.175"></a><span id="l17.175">   flagState-&gt;ExpungeByIndex(2);</span>
<a href="#l17.176"></a><span id="l17.176">   nsCString uidString;</span>
<a href="#l17.177"></a><span id="l17.177" class="difflineminus">-  uint32_t msgUids[] = {69,71};</span>
<a href="#l17.178"></a><span id="l17.178" class="difflineplus">+  uint32_t msgUids[] = {69, 71};</span>
<a href="#l17.179"></a><span id="l17.179">   uint32_t msgCount = 2;</span>
<a href="#l17.180"></a><span id="l17.180">   AllocateImapUidString(&amp;msgUids[0], msgCount, flagState, uidString);</span>
<a href="#l17.181"></a><span id="l17.181" class="difflineminus">-  if (!uidString.EqualsLiteral(&quot;71&quot;))</span>
<a href="#l17.182"></a><span id="l17.182" class="difflineminus">-  {</span>
<a href="#l17.183"></a><span id="l17.183" class="difflineminus">-    printf(&quot;TEST-UNEXPECTED-FAIL | uid String is %s, not 71 | %s\n&quot;, uidString.get(), __FILE__);</span>
<a href="#l17.184"></a><span id="l17.184" class="difflineplus">+  if (!uidString.EqualsLiteral(&quot;71&quot;)) {</span>
<a href="#l17.185"></a><span id="l17.185" class="difflineplus">+    printf(&quot;TEST-UNEXPECTED-FAIL | uid String is %s, not 71 | %s\n&quot;,</span>
<a href="#l17.186"></a><span id="l17.186" class="difflineplus">+           uidString.get(), __FILE__);</span>
<a href="#l17.187"></a><span id="l17.187">     return -1;</span>
<a href="#l17.188"></a><span id="l17.188">   }</span>
<a href="#l17.189"></a><span id="l17.189">   // Reset all</span>
<a href="#l17.190"></a><span id="l17.190">   flagState-&gt;Reset();</span>
<a href="#l17.191"></a><span id="l17.191">   // This tests the middle message missing from the flag state.</span>
<a href="#l17.192"></a><span id="l17.192" class="difflineminus">-  struct msgState msgState4[] = {</span>
<a href="#l17.193"></a><span id="l17.193" class="difflineminus">-    {10, kImapMsgSeenFlag, 0},</span>
<a href="#l17.194"></a><span id="l17.194" class="difflineminus">-    {69, kImapMsgSeenFlag, 1},</span>
<a href="#l17.195"></a><span id="l17.195" class="difflineminus">-    {70, kImapMsgSeenFlag, 2},</span>
<a href="#l17.196"></a><span id="l17.196" class="difflineminus">-    {71, kImapMsgSeenFlag, 3},</span>
<a href="#l17.197"></a><span id="l17.197" class="difflineminus">-    {73, kImapMsgSeenFlag, 4}};</span>
<a href="#l17.198"></a><span id="l17.198" class="difflineplus">+  struct msgState msgState4[] = {{10, kImapMsgSeenFlag, 0},</span>
<a href="#l17.199"></a><span id="l17.199" class="difflineplus">+                                 {69, kImapMsgSeenFlag, 1},</span>
<a href="#l17.200"></a><span id="l17.200" class="difflineplus">+                                 {70, kImapMsgSeenFlag, 2},</span>
<a href="#l17.201"></a><span id="l17.201" class="difflineplus">+                                 {71, kImapMsgSeenFlag, 3},</span>
<a href="#l17.202"></a><span id="l17.202" class="difflineplus">+                                 {73, kImapMsgSeenFlag, 4}};</span>
<a href="#l17.203"></a><span id="l17.203"> </span>
<a href="#l17.204"></a><span id="l17.204">   flagState-&gt;SetPartialUIDFetch(false);</span>
<a href="#l17.205"></a><span id="l17.205">   numMsgs = sizeof(msgState4) / sizeof(msgState4[0]);</span>
<a href="#l17.206"></a><span id="l17.206">   for (int32_t i = 0; i &lt; numMsgs; i++)</span>
<a href="#l17.207"></a><span id="l17.207">     flagState-&gt;AddUidFlagPair(msgState4[i].uid, msgState4[i].flag,</span>
<a href="#l17.208"></a><span id="l17.208">                               msgState4[i].index);</span>
<a href="#l17.209"></a><span id="l17.209">   flagState-&gt;ExpungeByIndex(4);</span>
<a href="#l17.210"></a><span id="l17.210" class="difflineminus">-  uint32_t msgUids2[] = {69,71,73};</span>
<a href="#l17.211"></a><span id="l17.211" class="difflineplus">+  uint32_t msgUids2[] = {69, 71, 73};</span>
<a href="#l17.212"></a><span id="l17.212">   msgCount = 3;</span>
<a href="#l17.213"></a><span id="l17.213">   nsCString uidString2;</span>
<a href="#l17.214"></a><span id="l17.214"> </span>
<a href="#l17.215"></a><span id="l17.215">   AllocateImapUidString(&amp;msgUids2[0], msgCount, flagState, uidString2);</span>
<a href="#l17.216"></a><span id="l17.216" class="difflineminus">-  if (!uidString2.EqualsLiteral(&quot;69,73&quot;))</span>
<a href="#l17.217"></a><span id="l17.217" class="difflineminus">-  {</span>
<a href="#l17.218"></a><span id="l17.218" class="difflineminus">-    printf(&quot;TEST-UNEXPECTED-FAIL | uid String is %s, not 71 | %s\n&quot;, uidString.get(), __FILE__);</span>
<a href="#l17.219"></a><span id="l17.219" class="difflineplus">+  if (!uidString2.EqualsLiteral(&quot;69,73&quot;)) {</span>
<a href="#l17.220"></a><span id="l17.220" class="difflineplus">+    printf(&quot;TEST-UNEXPECTED-FAIL | uid String is %s, not 71 | %s\n&quot;,</span>
<a href="#l17.221"></a><span id="l17.221" class="difflineplus">+           uidString.get(), __FILE__);</span>
<a href="#l17.222"></a><span id="l17.222">     return -1;</span>
<a href="#l17.223"></a><span id="l17.223">   }</span>
<a href="#l17.224"></a><span id="l17.224"> </span>
<a href="#l17.225"></a><span id="l17.225">   printf(&quot;TEST-PASS | %s | all tests passed\n&quot;, __FILE__);</span>
<a href="#l17.226"></a><span id="l17.226">   return 0;</span>
<a href="#l17.227"></a><span id="l17.227"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mailnews/imap/test/TestImapHdrXferInfo.cpp</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mailnews/imap/test/TestImapHdrXferInfo.cpp</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -4,121 +4,97 @@</span>
<a href="#l18.4"></a><span id="l18.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l18.5"></a><span id="l18.5"> #include &lt;stdio.h&gt;</span>
<a href="#l18.6"></a><span id="l18.6"> #include &quot;TestHarness.h&quot;</span>
<a href="#l18.7"></a><span id="l18.7"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l18.8"></a><span id="l18.8"> #include &quot;msgCore.h&quot;</span>
<a href="#l18.9"></a><span id="l18.9"> #include &quot;nsImapProtocol.h&quot;</span>
<a href="#l18.10"></a><span id="l18.10"> </span>
<a href="#l18.11"></a><span id="l18.11"> // What to check</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-enum EHdrArrayCheck</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineminus">-{</span>
<a href="#l18.14"></a><span id="l18.14" class="difflineminus">-  eAddNoCheck,</span>
<a href="#l18.15"></a><span id="l18.15" class="difflineminus">-  eCheckSame</span>
<a href="#l18.16"></a><span id="l18.16" class="difflineminus">-};</span>
<a href="#l18.17"></a><span id="l18.17" class="difflineplus">+enum EHdrArrayCheck { eAddNoCheck, eCheckSame };</span>
<a href="#l18.18"></a><span id="l18.18"> </span>
<a href="#l18.19"></a><span id="l18.19" class="difflineminus">-int MainChecks(nsMsgImapHdrXferInfo* hdrInfo, nsIImapHeaderInfo **hdrArray,</span>
<a href="#l18.20"></a><span id="l18.20" class="difflineminus">-               EHdrArrayCheck hdrArrayCheck)</span>
<a href="#l18.21"></a><span id="l18.21" class="difflineminus">-{</span>
<a href="#l18.22"></a><span id="l18.22" class="difflineplus">+int MainChecks(nsMsgImapHdrXferInfo* hdrInfo, nsIImapHeaderInfo** hdrArray,</span>
<a href="#l18.23"></a><span id="l18.23" class="difflineplus">+               EHdrArrayCheck hdrArrayCheck) {</span>
<a href="#l18.24"></a><span id="l18.24">   nsCOMPtr&lt;nsIImapHeaderInfo&gt; hdr;</span>
<a href="#l18.25"></a><span id="l18.25">   int32_t numHdrs = -1;</span>
<a href="#l18.26"></a><span id="l18.26"> </span>
<a href="#l18.27"></a><span id="l18.27">   // Check the number of headers initially is zero</span>
<a href="#l18.28"></a><span id="l18.28" class="difflineminus">-  if (NS_FAILED(hdrInfo-&gt;GetNumHeaders(&amp;numHdrs)))</span>
<a href="#l18.29"></a><span id="l18.29" class="difflineminus">-    return 1;</span>
<a href="#l18.30"></a><span id="l18.30" class="difflineplus">+  if (NS_FAILED(hdrInfo-&gt;GetNumHeaders(&amp;numHdrs))) return 1;</span>
<a href="#l18.31"></a><span id="l18.31"> </span>
<a href="#l18.32"></a><span id="l18.32" class="difflineminus">-  if (numHdrs != 0)</span>
<a href="#l18.33"></a><span id="l18.33" class="difflineminus">-    return 2;</span>
<a href="#l18.34"></a><span id="l18.34" class="difflineplus">+  if (numHdrs != 0) return 2;</span>
<a href="#l18.35"></a><span id="l18.35"> </span>
<a href="#l18.36"></a><span id="l18.36">   // Get a header that doesn't exist</span>
<a href="#l18.37"></a><span id="l18.37">   if (hdrInfo-&gt;GetHeader(1, getter_AddRefs(hdr)) != NS_ERROR_NULL_POINTER)</span>
<a href="#l18.38"></a><span id="l18.38">     return 3;</span>
<a href="#l18.39"></a><span id="l18.39"> </span>
<a href="#l18.40"></a><span id="l18.40">   int32_t i;</span>
<a href="#l18.41"></a><span id="l18.41" class="difflineminus">-  for (i = 0; i &lt; kNumHdrsToXfer; ++i)</span>
<a href="#l18.42"></a><span id="l18.42" class="difflineminus">-  {</span>
<a href="#l18.43"></a><span id="l18.43" class="difflineplus">+  for (i = 0; i &lt; kNumHdrsToXfer; ++i) {</span>
<a href="#l18.44"></a><span id="l18.44">     // Now kick off a new one.</span>
<a href="#l18.45"></a><span id="l18.45">     hdr = hdrInfo-&gt;StartNewHdr();</span>
<a href="#l18.46"></a><span id="l18.46" class="difflineminus">-    if (!hdr)</span>
<a href="#l18.47"></a><span id="l18.47" class="difflineminus">-      return 4;</span>
<a href="#l18.48"></a><span id="l18.48" class="difflineplus">+    if (!hdr) return 4;</span>
<a href="#l18.49"></a><span id="l18.49"> </span>
<a href="#l18.50"></a><span id="l18.50">     // Check pointers are different or not depending on which cycle we are in</span>
<a href="#l18.51"></a><span id="l18.51" class="difflineminus">-    switch (hdrArrayCheck)</span>
<a href="#l18.52"></a><span id="l18.52" class="difflineminus">-    {</span>
<a href="#l18.53"></a><span id="l18.53" class="difflineminus">-    case eAddNoCheck:</span>
<a href="#l18.54"></a><span id="l18.54" class="difflineminus">-      hdrArray[i] = hdr;</span>
<a href="#l18.55"></a><span id="l18.55" class="difflineminus">-      break;</span>
<a href="#l18.56"></a><span id="l18.56" class="difflineminus">-    case eCheckSame:</span>
<a href="#l18.57"></a><span id="l18.57" class="difflineminus">-      if (hdrArray[i] != hdr)</span>
<a href="#l18.58"></a><span id="l18.58" class="difflineminus">-        return 5;</span>
<a href="#l18.59"></a><span id="l18.59" class="difflineminus">-      break;</span>
<a href="#l18.60"></a><span id="l18.60" class="difflineminus">-    default:</span>
<a href="#l18.61"></a><span id="l18.61" class="difflineminus">-      return 1;</span>
<a href="#l18.62"></a><span id="l18.62" class="difflineplus">+    switch (hdrArrayCheck) {</span>
<a href="#l18.63"></a><span id="l18.63" class="difflineplus">+      case eAddNoCheck:</span>
<a href="#l18.64"></a><span id="l18.64" class="difflineplus">+        hdrArray[i] = hdr;</span>
<a href="#l18.65"></a><span id="l18.65" class="difflineplus">+        break;</span>
<a href="#l18.66"></a><span id="l18.66" class="difflineplus">+      case eCheckSame:</span>
<a href="#l18.67"></a><span id="l18.67" class="difflineplus">+        if (hdrArray[i] != hdr) return 5;</span>
<a href="#l18.68"></a><span id="l18.68" class="difflineplus">+        break;</span>
<a href="#l18.69"></a><span id="l18.69" class="difflineplus">+      default:</span>
<a href="#l18.70"></a><span id="l18.70" class="difflineplus">+        return 1;</span>
<a href="#l18.71"></a><span id="l18.71">     }</span>
<a href="#l18.72"></a><span id="l18.72"> </span>
<a href="#l18.73"></a><span id="l18.73" class="difflineminus">-    if (NS_FAILED(hdrInfo-&gt;GetNumHeaders(&amp;numHdrs)))</span>
<a href="#l18.74"></a><span id="l18.74" class="difflineminus">-      return 1;</span>
<a href="#l18.75"></a><span id="l18.75" class="difflineplus">+    if (NS_FAILED(hdrInfo-&gt;GetNumHeaders(&amp;numHdrs))) return 1;</span>
<a href="#l18.76"></a><span id="l18.76"> </span>
<a href="#l18.77"></a><span id="l18.77" class="difflineminus">-    if (numHdrs != i + 1)</span>
<a href="#l18.78"></a><span id="l18.78" class="difflineminus">-      return 7;</span>
<a href="#l18.79"></a><span id="l18.79" class="difflineplus">+    if (numHdrs != i + 1) return 7;</span>
<a href="#l18.80"></a><span id="l18.80">   }</span>
<a href="#l18.81"></a><span id="l18.81"> </span>
<a href="#l18.82"></a><span id="l18.82">   // Now try and get one more (this should return null)</span>
<a href="#l18.83"></a><span id="l18.83" class="difflineminus">-  if (hdrInfo-&gt;StartNewHdr())</span>
<a href="#l18.84"></a><span id="l18.84" class="difflineminus">-    return 8;</span>
<a href="#l18.85"></a><span id="l18.85" class="difflineplus">+  if (hdrInfo-&gt;StartNewHdr()) return 8;</span>
<a href="#l18.86"></a><span id="l18.86"> </span>
<a href="#l18.87"></a><span id="l18.87">   // Now check the number of headers</span>
<a href="#l18.88"></a><span id="l18.88" class="difflineminus">-  if (NS_FAILED(hdrInfo-&gt;GetNumHeaders(&amp;numHdrs)))</span>
<a href="#l18.89"></a><span id="l18.89" class="difflineminus">-    return 1;</span>
<a href="#l18.90"></a><span id="l18.90" class="difflineplus">+  if (NS_FAILED(hdrInfo-&gt;GetNumHeaders(&amp;numHdrs))) return 1;</span>
<a href="#l18.91"></a><span id="l18.91"> </span>
<a href="#l18.92"></a><span id="l18.92" class="difflineminus">-  if (numHdrs != kNumHdrsToXfer)</span>
<a href="#l18.93"></a><span id="l18.93" class="difflineminus">-    return 9;</span>
<a href="#l18.94"></a><span id="l18.94" class="difflineplus">+  if (numHdrs != kNumHdrsToXfer) return 9;</span>
<a href="#l18.95"></a><span id="l18.95"> </span>
<a href="#l18.96"></a><span id="l18.96">   // Now check our pointers align with those from GetHeader</span>
<a href="#l18.97"></a><span id="l18.97" class="difflineminus">-  if (hdrArrayCheck != 2)</span>
<a href="#l18.98"></a><span id="l18.98" class="difflineminus">-  {</span>
<a href="#l18.99"></a><span id="l18.99" class="difflineminus">-    for (i = 0; i &lt; kNumHdrsToXfer; ++i)</span>
<a href="#l18.100"></a><span id="l18.100" class="difflineminus">-    {</span>
<a href="#l18.101"></a><span id="l18.101" class="difflineminus">-      if (NS_FAILED(hdrInfo-&gt;GetHeader(i, getter_AddRefs(hdr))))</span>
<a href="#l18.102"></a><span id="l18.102" class="difflineminus">-        return 1;</span>
<a href="#l18.103"></a><span id="l18.103" class="difflineplus">+  if (hdrArrayCheck != 2) {</span>
<a href="#l18.104"></a><span id="l18.104" class="difflineplus">+    for (i = 0; i &lt; kNumHdrsToXfer; ++i) {</span>
<a href="#l18.105"></a><span id="l18.105" class="difflineplus">+      if (NS_FAILED(hdrInfo-&gt;GetHeader(i, getter_AddRefs(hdr)))) return 1;</span>
<a href="#l18.106"></a><span id="l18.106"> </span>
<a href="#l18.107"></a><span id="l18.107" class="difflineminus">-      if (hdr != hdrArray[i])</span>
<a href="#l18.108"></a><span id="l18.108" class="difflineminus">-        return 10;</span>
<a href="#l18.109"></a><span id="l18.109" class="difflineplus">+      if (hdr != hdrArray[i]) return 10;</span>
<a href="#l18.110"></a><span id="l18.110">     }</span>
<a href="#l18.111"></a><span id="l18.111">   }</span>
<a href="#l18.112"></a><span id="l18.112">   return 0;</span>
<a href="#l18.113"></a><span id="l18.113"> }</span>
<a href="#l18.114"></a><span id="l18.114"> </span>
<a href="#l18.115"></a><span id="l18.115"> // General note about return values:</span>
<a href="#l18.116"></a><span id="l18.116"> // return 1 for a setup or xpcom type failure, return 2 for a real test failure</span>
<a href="#l18.117"></a><span id="l18.117" class="difflineminus">-int main(int argc, char** argv)</span>
<a href="#l18.118"></a><span id="l18.118" class="difflineminus">-{</span>
<a href="#l18.119"></a><span id="l18.119" class="difflineplus">+int main(int argc, char** argv) {</span>
<a href="#l18.120"></a><span id="l18.120">   ScopedXPCOM xpcom(&quot;TestImapHdrXferInfo.cpp&quot;);</span>
<a href="#l18.121"></a><span id="l18.121" class="difflineminus">-  if (xpcom.failed())</span>
<a href="#l18.122"></a><span id="l18.122" class="difflineminus">-    return 1;</span>
<a href="#l18.123"></a><span id="l18.123" class="difflineplus">+  if (xpcom.failed()) return 1;</span>
<a href="#l18.124"></a><span id="l18.124"> </span>
<a href="#l18.125"></a><span id="l18.125">   RefPtr&lt;nsMsgImapHdrXferInfo&gt; hdrInfo = new nsMsgImapHdrXferInfo();</span>
<a href="#l18.126"></a><span id="l18.126">   // Purposely not reference counted to ensure we get the same pointers the</span>
<a href="#l18.127"></a><span id="l18.127">   // second time round MainChecks.</span>
<a href="#l18.128"></a><span id="l18.128" class="difflineminus">-  nsIImapHeaderInfo* hdrArray[kNumHdrsToXfer] = { nullptr };</span>
<a href="#l18.129"></a><span id="l18.129" class="difflineplus">+  nsIImapHeaderInfo* hdrArray[kNumHdrsToXfer] = {nullptr};</span>
<a href="#l18.130"></a><span id="l18.130"> </span>
<a href="#l18.131"></a><span id="l18.131">   int result = MainChecks(hdrInfo, hdrArray, eAddNoCheck);</span>
<a href="#l18.132"></a><span id="l18.132" class="difflineminus">-  if (result)</span>
<a href="#l18.133"></a><span id="l18.133" class="difflineminus">-  {</span>
<a href="#l18.134"></a><span id="l18.134" class="difflineplus">+  if (result) {</span>
<a href="#l18.135"></a><span id="l18.135">     printf(&quot;TEST-UNEXPECTED-FAIL | %s | %d\n&quot;, __FILE__, result);</span>
<a href="#l18.136"></a><span id="l18.136">     return result;</span>
<a href="#l18.137"></a><span id="l18.137">   }</span>
<a href="#l18.138"></a><span id="l18.138"> </span>
<a href="#l18.139"></a><span id="l18.139">   // Now reset all</span>
<a href="#l18.140"></a><span id="l18.140">   hdrInfo-&gt;ResetAll();</span>
<a href="#l18.141"></a><span id="l18.141"> </span>
<a href="#l18.142"></a><span id="l18.142">   // and repeat</span>
<a href="#l18.143"></a><span id="l18.143">   result = MainChecks(hdrInfo, hdrArray, eCheckSame);</span>
<a href="#l18.144"></a><span id="l18.144" class="difflineminus">-  if (result)</span>
<a href="#l18.145"></a><span id="l18.145" class="difflineminus">-  {</span>
<a href="#l18.146"></a><span id="l18.146" class="difflineplus">+  if (result) {</span>
<a href="#l18.147"></a><span id="l18.147">     // add 100 to differentiate results</span>
<a href="#l18.148"></a><span id="l18.148">     result += 100;</span>
<a href="#l18.149"></a><span id="l18.149">     printf(&quot;TEST-UNEXPECTED-FAIL | %s | %d\n&quot;, __FILE__, result);</span>
<a href="#l18.150"></a><span id="l18.150">     return result;</span>
<a href="#l18.151"></a><span id="l18.151">   }</span>
<a href="#l18.152"></a><span id="l18.152"> </span>
<a href="#l18.153"></a><span id="l18.153">   printf(&quot;TEST-PASS | %s | all tests passed\n&quot;, __FILE__);</span>
<a href="#l18.154"></a><span id="l18.154">   return result;</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:33Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

