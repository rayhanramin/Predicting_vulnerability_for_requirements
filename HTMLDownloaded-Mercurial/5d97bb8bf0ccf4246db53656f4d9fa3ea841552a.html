<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 5203:5d97bb8bf0ccf4246db53656f4d9fa3ea841552a</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 5d97bb8bf0ccf4246db53656f4d9fa3ea841552a" />
<meta property="og:url" content="/comm-central/rev/5d97bb8bf0ccf4246db53656f4d9fa3ea841552a" />
<meta property="og:description" content="Bug 525537 - Gloda search tokenizer should perform case-folding and accent-folding to be case-insensitive and accent-insensitive, also handle half-width katakana. review changes patch v1 on top of m_kato's v4 patch. r=m_kato" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 5d97bb8bf0ccf4246db53656f4d9fa3ea841552a 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/5d97bb8bf0ccf4246db53656f4d9fa3ea841552a">shortlog</a> |
<a href="/comm-central/log/5d97bb8bf0ccf4246db53656f4d9fa3ea841552a">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/5d97bb8bf0ccf4246db53656f4d9fa3ea841552a">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/5d97bb8bf0ccf4246db53656f4d9fa3ea841552a">files</a> |
changeset |
<a href="/comm-central/raw-rev/5d97bb8bf0ccf4246db53656f4d9fa3ea841552a">raw</a>  | <a href="/comm-central/archive/5d97bb8bf0ccf4246db53656f4d9fa3ea841552a.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=525537">Bug 525537</a> - Gloda search tokenizer should perform case-folding and accent-folding to be case-insensitive and accent-insensitive, also handle half-width katakana. review changes patch v1 on top of m_kato's v4 patch. r=m_kato
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#65;&#110;&#100;&#114;&#101;&#119;&#32;&#83;&#117;&#116;&#104;&#101;&#114;&#108;&#97;&#110;&#100;&#32;&#60;&#97;&#115;&#117;&#116;&#104;&#101;&#114;&#108;&#97;&#110;&#100;&#64;&#97;&#115;&#117;&#116;&#104;&#101;&#114;&#108;&#97;&#110;&#100;&#46;&#111;&#114;&#103;&#62;</td></tr>
<tr><td></td><td class="date age">Wed, 17 Mar 2010 19:31:23 -0700</td></tr>

<tr>
 <td>changeset 5203</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/5d97bb8bf0ccf4246db53656f4d9fa3ea841552a">5d97bb8bf0ccf4246db53656f4d9fa3ea841552a</a></td>
</tr>



<tr>
<td>parent 5202</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/d67ca271fb2dc5a0aabf5df728d110760e2cce61">d67ca271fb2dc5a0aabf5df728d110760e2cce61</a>
</td>
</tr>

<tr>
<td>child 5204</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/7b60a657c20cd1055afe1b0c3308b1e224cab034">7b60a657c20cd1055afe1b0c3308b1e224cab034</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=5d97bb8bf0ccf4246db53656f4d9fa3ea841552a">4015</a></td></tr>
<tr><td>push user</td><td>bugmail@asutherland.org</td></tr>
<tr><td>push date</td><td class="date age">Thu, 18 Mar 2010 02:31:37 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@5d97bb8bf0cc [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=5d97bb8bf0ccf4246db53656f4d9fa3ea841552a">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=5d97bb8bf0ccf4246db53656f4d9fa3ea841552a&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=5d97bb8bf0ccf4246db53656f4d9fa3ea841552a&newProject=comm-central&newRevision=d67ca271fb2dc5a0aabf5df728d110760e2cce61&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=5d97bb8bf0ccf4246db53656f4d9fa3ea841552a&newProject=comm-central&newRevision=d67ca271fb2dc5a0aabf5df728d110760e2cce61&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=5d97bb8bf0ccf4246db53656f4d9fa3ea841552a&newProject=comm-central&newRevision=d67ca271fb2dc5a0aabf5df728d110760e2cce61&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28m_kato%29&revcount=50">m_kato</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=525537">525537</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=525537">Bug 525537</a> - Gloda search tokenizer should perform case-folding and accent-folding to be case-insensitive and accent-insensitive, also handle half-width katakana. review changes patch v1 on top of m_kato's v4 patch. r=m_kato</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5d97bb8bf0ccf4246db53656f4d9fa3ea841552a/mailnews/db/gloda/modules/datastore.js">mailnews/db/gloda/modules/datastore.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5d97bb8bf0ccf4246db53656f4d9fa3ea841552a/mailnews/db/gloda/modules/datastore.js">file</a> |
<a href="/comm-central/annotate/5d97bb8bf0ccf4246db53656f4d9fa3ea841552a/mailnews/db/gloda/modules/datastore.js">annotate</a> |
<a href="/comm-central/diff/5d97bb8bf0ccf4246db53656f4d9fa3ea841552a/mailnews/db/gloda/modules/datastore.js">diff</a> |
<a href="/comm-central/comparison/5d97bb8bf0ccf4246db53656f4d9fa3ea841552a/mailnews/db/gloda/modules/datastore.js">comparison</a> |
<a href="/comm-central/log/5d97bb8bf0ccf4246db53656f4d9fa3ea841552a/mailnews/db/gloda/modules/datastore.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5d97bb8bf0ccf4246db53656f4d9fa3ea841552a/mailnews/db/gloda/test/unit/test_intl.js">mailnews/db/gloda/test/unit/test_intl.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5d97bb8bf0ccf4246db53656f4d9fa3ea841552a/mailnews/db/gloda/test/unit/test_intl.js">file</a> |
<a href="/comm-central/annotate/5d97bb8bf0ccf4246db53656f4d9fa3ea841552a/mailnews/db/gloda/test/unit/test_intl.js">annotate</a> |
<a href="/comm-central/diff/5d97bb8bf0ccf4246db53656f4d9fa3ea841552a/mailnews/db/gloda/test/unit/test_intl.js">diff</a> |
<a href="/comm-central/comparison/5d97bb8bf0ccf4246db53656f4d9fa3ea841552a/mailnews/db/gloda/test/unit/test_intl.js">comparison</a> |
<a href="/comm-central/log/5d97bb8bf0ccf4246db53656f4d9fa3ea841552a/mailnews/db/gloda/test/unit/test_intl.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5d97bb8bf0ccf4246db53656f4d9fa3ea841552a/mailnews/extensions/fts3/data/README">mailnews/extensions/fts3/data/README</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5d97bb8bf0ccf4246db53656f4d9fa3ea841552a/mailnews/extensions/fts3/data/README">file</a> |
<a href="/comm-central/annotate/5d97bb8bf0ccf4246db53656f4d9fa3ea841552a/mailnews/extensions/fts3/data/README">annotate</a> |
<a href="/comm-central/diff/5d97bb8bf0ccf4246db53656f4d9fa3ea841552a/mailnews/extensions/fts3/data/README">diff</a> |
<a href="/comm-central/comparison/5d97bb8bf0ccf4246db53656f4d9fa3ea841552a/mailnews/extensions/fts3/data/README">comparison</a> |
<a href="/comm-central/log/5d97bb8bf0ccf4246db53656f4d9fa3ea841552a/mailnews/extensions/fts3/data/README">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5d97bb8bf0ccf4246db53656f4d9fa3ea841552a/mailnews/extensions/fts3/data/generate_table.py">mailnews/extensions/fts3/data/generate_table.py</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5d97bb8bf0ccf4246db53656f4d9fa3ea841552a/mailnews/extensions/fts3/data/generate_table.py">file</a> |
<a href="/comm-central/annotate/5d97bb8bf0ccf4246db53656f4d9fa3ea841552a/mailnews/extensions/fts3/data/generate_table.py">annotate</a> |
<a href="/comm-central/diff/5d97bb8bf0ccf4246db53656f4d9fa3ea841552a/mailnews/extensions/fts3/data/generate_table.py">diff</a> |
<a href="/comm-central/comparison/5d97bb8bf0ccf4246db53656f4d9fa3ea841552a/mailnews/extensions/fts3/data/generate_table.py">comparison</a> |
<a href="/comm-central/log/5d97bb8bf0ccf4246db53656f4d9fa3ea841552a/mailnews/extensions/fts3/data/generate_table.py">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5d97bb8bf0ccf4246db53656f4d9fa3ea841552a/mailnews/extensions/fts3/src/Normalize.c">mailnews/extensions/fts3/src/Normalize.c</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5d97bb8bf0ccf4246db53656f4d9fa3ea841552a/mailnews/extensions/fts3/src/Normalize.c">file</a> |
<a href="/comm-central/annotate/5d97bb8bf0ccf4246db53656f4d9fa3ea841552a/mailnews/extensions/fts3/src/Normalize.c">annotate</a> |
<a href="/comm-central/diff/5d97bb8bf0ccf4246db53656f4d9fa3ea841552a/mailnews/extensions/fts3/src/Normalize.c">diff</a> |
<a href="/comm-central/comparison/5d97bb8bf0ccf4246db53656f4d9fa3ea841552a/mailnews/extensions/fts3/src/Normalize.c">comparison</a> |
<a href="/comm-central/log/5d97bb8bf0ccf4246db53656f4d9fa3ea841552a/mailnews/extensions/fts3/src/Normalize.c">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5d97bb8bf0ccf4246db53656f4d9fa3ea841552a/mailnews/extensions/fts3/src/fts3_porter.c">mailnews/extensions/fts3/src/fts3_porter.c</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5d97bb8bf0ccf4246db53656f4d9fa3ea841552a/mailnews/extensions/fts3/src/fts3_porter.c">file</a> |
<a href="/comm-central/annotate/5d97bb8bf0ccf4246db53656f4d9fa3ea841552a/mailnews/extensions/fts3/src/fts3_porter.c">annotate</a> |
<a href="/comm-central/diff/5d97bb8bf0ccf4246db53656f4d9fa3ea841552a/mailnews/extensions/fts3/src/fts3_porter.c">diff</a> |
<a href="/comm-central/comparison/5d97bb8bf0ccf4246db53656f4d9fa3ea841552a/mailnews/extensions/fts3/src/fts3_porter.c">comparison</a> |
<a href="/comm-central/log/5d97bb8bf0ccf4246db53656f4d9fa3ea841552a/mailnews/extensions/fts3/src/fts3_porter.c">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/db/gloda/modules/datastore.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/db/gloda/modules/datastore.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -564,17 +564,17 @@ var GlodaDatastore = {</span>
<a href="#l1.4"></a><span id="l1.4">   kConstraintIn: 1,</span>
<a href="#l1.5"></a><span id="l1.5">   kConstraintRanges: 2,</span>
<a href="#l1.6"></a><span id="l1.6">   kConstraintEquals: 3,</span>
<a href="#l1.7"></a><span id="l1.7">   kConstraintStringLike: 4,</span>
<a href="#l1.8"></a><span id="l1.8">   kConstraintFulltext: 5,</span>
<a href="#l1.9"></a><span id="l1.9"> </span>
<a href="#l1.10"></a><span id="l1.10">   /* ******************* SCHEMA ******************* */</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-  _schemaVersion: 19,</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+  _schemaVersion: 20,</span>
<a href="#l1.14"></a><span id="l1.14">   _schema: {</span>
<a href="#l1.15"></a><span id="l1.15">     tables: {</span>
<a href="#l1.16"></a><span id="l1.16"> </span>
<a href="#l1.17"></a><span id="l1.17">       // ----- Messages</span>
<a href="#l1.18"></a><span id="l1.18">       folderLocations: {</span>
<a href="#l1.19"></a><span id="l1.19">         columns: [</span>
<a href="#l1.20"></a><span id="l1.20">           [&quot;id&quot;, &quot;INTEGER PRIMARY KEY&quot;],</span>
<a href="#l1.21"></a><span id="l1.21">           [&quot;folderURI&quot;, &quot;TEXT NOT NULL&quot;],</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineat">@@ -1105,30 +1105,35 @@ var GlodaDatastore = {</span>
<a href="#l1.23"></a><span id="l1.23">     // - all kinds of correctness changes (blow away)</span>
<a href="#l1.24"></a><span id="l1.24">     // version 17</span>
<a href="#l1.25"></a><span id="l1.25">     // - more correctness fixes. (blow away)</span>
<a href="#l1.26"></a><span id="l1.26">     // version 18</span>
<a href="#l1.27"></a><span id="l1.27">     // - significant empty set support (blow away)</span>
<a href="#l1.28"></a><span id="l1.28">     // version 19</span>
<a href="#l1.29"></a><span id="l1.29">     // - there was a typo that was resulting in deleted getting set to the</span>
<a href="#l1.30"></a><span id="l1.30">     //  numeric value of the javascript undefined value.  (migrate-able)</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineminus">-</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineminus">-    // 1) Blow away if it's old enough that we can't patch things up below.</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineminus">-    // 2) Blow away if it's from the future.</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineminus">-    if (aCurVersion &lt; 18 || aCurVersion &gt; aNewVersion) {</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineplus">+    // version 20</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineplus">+    // - tokenizer changes to provide for case/accent-folding. (blow away)</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineplus">+</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineplus">+    // If it's not the current version, we must blow it away.</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineplus">+    if (aCurVersion != aNewVersion) {</span>
<a href="#l1.40"></a><span id="l1.40">       aDBConnection.close();</span>
<a href="#l1.41"></a><span id="l1.41">       aDBFile.remove(false);</span>
<a href="#l1.42"></a><span id="l1.42">       this._log.warn(&quot;Global database has been purged due to schema change.&quot;);</span>
<a href="#l1.43"></a><span id="l1.43">       return this._createDB(aDBService, aDBFile);</span>
<a href="#l1.44"></a><span id="l1.44">     }</span>
<a href="#l1.45"></a><span id="l1.45"> </span>
<a href="#l1.46"></a><span id="l1.46" class="difflineplus">+    // Let's leave this code around as a template for the next time we can</span>
<a href="#l1.47"></a><span id="l1.47" class="difflineplus">+    // migrate stuff.</span>
<a href="#l1.48"></a><span id="l1.48" class="difflineplus">+    /*</span>
<a href="#l1.49"></a><span id="l1.49">     this._log.warn(&quot;Global database performing schema update.&quot;);</span>
<a href="#l1.50"></a><span id="l1.50">     // version 19</span>
<a href="#l1.51"></a><span id="l1.51">     aDBConnection.executeSimpleSQL(&quot;UPDATE messages set deleted = 1 WHERE &quot; +</span>
<a href="#l1.52"></a><span id="l1.52">                                    &quot;deleted &lt; 0 or deleted &gt; 1&quot;);</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineplus">+    */</span>
<a href="#l1.54"></a><span id="l1.54"> </span>
<a href="#l1.55"></a><span id="l1.55">     aDBConnection.schemaVersion = aNewVersion;</span>
<a href="#l1.56"></a><span id="l1.56">     return aDBConnection;</span>
<a href="#l1.57"></a><span id="l1.57">   },</span>
<a href="#l1.58"></a><span id="l1.58"> </span>
<a href="#l1.59"></a><span id="l1.59">   _outstandingAsyncStatements: [],</span>
<a href="#l1.60"></a><span id="l1.60"> </span>
<a href="#l1.61"></a><span id="l1.61">   _createAsyncStatement: function gloda_ds_createAsyncStatement(aSQLString,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/db/gloda/test/unit/test_intl.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/db/gloda/test/unit/test_intl.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -47,17 +47,17 @@</span>
<a href="#l2.4"></a><span id="l2.4"> load(&quot;resources/glodaTestHelper.js&quot;);</span>
<a href="#l2.5"></a><span id="l2.5"> </span>
<a href="#l2.6"></a><span id="l2.6"> /* ===== Tests ===== */</span>
<a href="#l2.7"></a><span id="l2.7"> </span>
<a href="#l2.8"></a><span id="l2.8"> /**</span>
<a href="#l2.9"></a><span id="l2.9">  * To make the encoding pairs:</span>
<a href="#l2.10"></a><span id="l2.10">  * - For the subject bit:</span>
<a href="#l2.11"></a><span id="l2.11">  *   import email</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">- *   h = email.header.Header(charset=CHARSET)</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+ *   h = email.Header.Header(charset=CHARSET)</span>
<a href="#l2.14"></a><span id="l2.14">  *   h.append(STRING)</span>
<a href="#l2.15"></a><span id="l2.15">  *   h.encode()</span>
<a href="#l2.16"></a><span id="l2.16">  * - For the body bit</span>
<a href="#l2.17"></a><span id="l2.17">  *   s.encode(CHARSET)</span>
<a href="#l2.18"></a><span id="l2.18">  */</span>
<a href="#l2.19"></a><span id="l2.19"> var intlPhrases = [</span>
<a href="#l2.20"></a><span id="l2.20">   // -- CJK case</span>
<a href="#l2.21"></a><span id="l2.21">   {</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineat">@@ -137,16 +137,47 @@ var intlPhrases = [</span>
<a href="#l2.23"></a><span id="l2.23">     encodings: {</span>
<a href="#l2.24"></a><span id="l2.24">       &quot;utf-8&quot;: [&quot;=?UTF-8?B?0J3QvtCy0L7QtQ==?=&quot;,</span>
<a href="#l2.25"></a><span id="l2.25">                 &quot;\xd0\x9d\xd0\xbe\xd0\xb2\xd0\xbe\xd0\xb5&quot;]</span>
<a href="#l2.26"></a><span id="l2.26">     },</span>
<a href="#l2.27"></a><span id="l2.27">     searchPhrases: [</span>
<a href="#l2.28"></a><span id="l2.28">       {body: &quot;\u043d\u043e\u0432\u043e\u0435&quot;, match: true},</span>
<a href="#l2.29"></a><span id="l2.29">     ]</span>
<a href="#l2.30"></a><span id="l2.30">   },</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineplus">+  // case-folding happens after decomposition</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineplus">+  {</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineplus">+    name: &quot;Awesome where A has a bar over it&quot;,</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineplus">+    actual: &quot;\u0100wesome&quot;,</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineplus">+    encodings: {</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineplus">+      &quot;utf-8&quot;: [&quot;=?utf-8?q?=C4=80wesome?=&quot;,</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineplus">+                &quot;\xc4\x80wesome&quot;]</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineplus">+    },</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineplus">+    searchPhrases: [</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineplus">+      {body: &quot;\u0100wesome&quot;, match: true}, // upper A-bar</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineplus">+      {body: &quot;\u0101wesome&quot;, match: true}, // lower a-bar</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineplus">+      {body: &quot;Awesome&quot;, match: true}, // upper A</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineplus">+      {body: &quot;awesome&quot;, match: true}, // lower a</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineplus">+    ]</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineplus">+  },</span>
<a href="#l2.46"></a><span id="l2.46" class="difflineplus">+  // deep decomposition happens and after that, case folding</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineplus">+  {</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineplus">+    name: &quot;Upper case upsilon with diaeresis and hook goes to small upsilon&quot;,</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineplus">+    actual: &quot;\u03d4esterday&quot;,</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineplus">+    encodings: {</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineplus">+      &quot;utf-8&quot;: [&quot;=?utf-8?q?=CF=94esterday?=&quot;,</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineplus">+                &quot;\xcf\x94esterday&quot;]</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineplus">+    },</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineplus">+    searchPhrases: [</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineplus">+      {body: &quot;\u03d4esterday&quot;, match: true}, // Y_: 03d4 =&gt; 03d2 (decomposed)</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineplus">+      {body: &quot;\u03d3esterday&quot;, match: true}, // Y_' 03d3 =&gt; 03d2 (decomposed)</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineplus">+      {body: &quot;\u03d2esterday&quot;, match: true}, // Y_  03d2 =&gt; 03a5 (decomposed)</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineplus">+      {body: &quot;\u03a5esterday&quot;, match: true}, // Y   03a5 =&gt; 03c5 (lowercase)</span>
<a href="#l2.59"></a><span id="l2.59" class="difflineplus">+      {body: &quot;\u03c5esterday&quot;, match: true}, // y   03c5 (final state)</span>
<a href="#l2.60"></a><span id="l2.60" class="difflineplus">+    ]</span>
<a href="#l2.61"></a><span id="l2.61" class="difflineplus">+  },</span>
<a href="#l2.62"></a><span id="l2.62">   // full-width alphabet</span>
<a href="#l2.63"></a><span id="l2.63">   // Even if search phrases are ASCII, it has to hit.</span>
<a href="#l2.64"></a><span id="l2.64">   {</span>
<a href="#l2.65"></a><span id="l2.65">     name: &quot;Full-width Thunderbird&quot;,</span>
<a href="#l2.66"></a><span id="l2.66">     actual: &quot;\uff34\uff48\uff55\uff4e\uff44\uff45\uff52\uff42\uff49\uff52\uff44&quot;,</span>
<a href="#l2.67"></a><span id="l2.67">     encodings: {</span>
<a href="#l2.68"></a><span id="l2.68">       &quot;utf-8&quot;: [&quot;=?UTF-8?B?77y0772I772V772O772E772F772S772C772J772S772E?=&quot;,</span>
<a href="#l2.69"></a><span id="l2.69">                 &quot;\xef\xbc\xb4\xef\xbd\x88\xef\xbd\x95\xef\xbd\x8e\xef\xbd\x84\xef\xbd\x85\xef\xbd\x92\xef\xbd\x82\xef\xbd\x89\xef\xbd\x92\xef\xbd\x84&quot;]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1">new file mode 100644</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineminus">--- /dev/null</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineplus">+++ b/mailnews/extensions/fts3/data/README</span>
<a href="#l3.4"></a><span id="l3.4" class="difflineat">@@ -0,0 +1,5 @@</span>
<a href="#l3.5"></a><span id="l3.5" class="difflineplus">+The data files in this directory come from the ICU project:</span>
<a href="#l3.6"></a><span id="l3.6" class="difflineplus">+http://bugs.icu-project.org/trac/browser/icu/trunk/source/data/unidata/norm2</span>
<a href="#l3.7"></a><span id="l3.7" class="difflineplus">+</span>
<a href="#l3.8"></a><span id="l3.8" class="difflineplus">+They are intended to be consumed by the ICU project's gennorm2 script.  We have</span>
<a href="#l3.9"></a><span id="l3.9" class="difflineplus">+our own script that processes them.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/extensions/fts3/data/generate_table.py</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/extensions/fts3/data/generate_table.py</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -7,24 +7,25 @@</span>
<a href="#l4.4"></a><span id="l4.4"> # the License. You may obtain a copy of the License at</span>
<a href="#l4.5"></a><span id="l4.5"> # http://www.mozilla.org/MPL/</span>
<a href="#l4.6"></a><span id="l4.6"> #</span>
<a href="#l4.7"></a><span id="l4.7"> # Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l4.8"></a><span id="l4.8"> # WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l4.9"></a><span id="l4.9"> # for the specific language governing rights and limitations under the</span>
<a href="#l4.10"></a><span id="l4.10"> # License.</span>
<a href="#l4.11"></a><span id="l4.11"> #</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-# The Original Code is the Calendar code</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+# The Original Code is Mozilla Thunderbird.</span>
<a href="#l4.14"></a><span id="l4.14"> #</span>
<a href="#l4.15"></a><span id="l4.15"> # The Initial Developer of the Original Code is Mozilla Japan.</span>
<a href="#l4.16"></a><span id="l4.16"> # Portions created by the Initial Developer are Copyright (C) 2010</span>
<a href="#l4.17"></a><span id="l4.17"> # the Initial Developer. All Rights Reserved.</span>
<a href="#l4.18"></a><span id="l4.18"> #</span>
<a href="#l4.19"></a><span id="l4.19"> # Contributor(s):</span>
<a href="#l4.20"></a><span id="l4.20"> #   Makoto Kato &lt;m_kato@ga2.so-net.ne.jp&gt;</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineplus">+#   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l4.22"></a><span id="l4.22"> #</span>
<a href="#l4.23"></a><span id="l4.23"> # Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l4.24"></a><span id="l4.24"> # either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l4.25"></a><span id="l4.25"> # the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l4.26"></a><span id="l4.26"> # in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l4.27"></a><span id="l4.27"> # of those above. If you wish to allow use of your version of this file only</span>
<a href="#l4.28"></a><span id="l4.28"> # under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l4.29"></a><span id="l4.29"> # use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineat">@@ -63,16 +64,17 @@ print '''/* -*- Mode: C++; tab-width: 4;</span>
<a href="#l4.31"></a><span id="l4.31">  * The Original Code is mozilla.org code.</span>
<a href="#l4.32"></a><span id="l4.32">  *</span>
<a href="#l4.33"></a><span id="l4.33">  * The Initial Developer of the Original Code is Mozilla Japan.</span>
<a href="#l4.34"></a><span id="l4.34">  * Portions created by the Initial Developer are Copyright (C) 2010</span>
<a href="#l4.35"></a><span id="l4.35">  * the Initial Developer. All Rights Reserved.</span>
<a href="#l4.36"></a><span id="l4.36">  *</span>
<a href="#l4.37"></a><span id="l4.37">  * Contributor(s):</span>
<a href="#l4.38"></a><span id="l4.38">  *   Makoto Kato &lt;m_kato@ga2.so-net.ne.jp&gt;</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineplus">+ *   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l4.40"></a><span id="l4.40">  *</span>
<a href="#l4.41"></a><span id="l4.41">  * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l4.42"></a><span id="l4.42">  * either of the GNU General Public License Version 2 or later (the &quot;GPL&quot;),</span>
<a href="#l4.43"></a><span id="l4.43">  * or the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l4.44"></a><span id="l4.44">  * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l4.45"></a><span id="l4.45">  * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l4.46"></a><span id="l4.46">  * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l4.47"></a><span id="l4.47">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l4.48"></a><span id="l4.48" class="difflineat">@@ -81,63 +83,133 @@ print '''/* -*- Mode: C++; tab-width: 4;</span>
<a href="#l4.49"></a><span id="l4.49">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l4.50"></a><span id="l4.50">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l4.51"></a><span id="l4.51">  *</span>
<a href="#l4.52"></a><span id="l4.52">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l4.53"></a><span id="l4.53"> </span>
<a href="#l4.54"></a><span id="l4.54"> /* THIS FILE IS GENERATED BY generate_table.py.  DON'T EDIT THIS */</span>
<a href="#l4.55"></a><span id="l4.55"> '''</span>
<a href="#l4.56"></a><span id="l4.56"> </span>
<a href="#l4.57"></a><span id="l4.57" class="difflineminus">-p = re.compile('([0-9A-F]{4,5})[=\&gt;]([0-9A-F]{4,5})')</span>
<a href="#l4.58"></a><span id="l4.58" class="difflineplus">+p = re.compile('([0-9A-F]{4,5})(?:\.\.([0-9A-F]{4,5}))?[=\&gt;]([0-9A-F]{4,5})?')</span>
<a href="#l4.59"></a><span id="l4.59" class="difflineplus">+G_FROM = 1</span>
<a href="#l4.60"></a><span id="l4.60" class="difflineplus">+G_TO = 2</span>
<a href="#l4.61"></a><span id="l4.61" class="difflineplus">+G_FIRSTVAL = 3</span>
<a href="#l4.62"></a><span id="l4.62" class="difflineplus">+</span>
<a href="#l4.63"></a><span id="l4.63" class="difflineplus">+# Array whose value at index i is the unicode value unicode character i should</span>
<a href="#l4.64"></a><span id="l4.64" class="difflineplus">+# map to.</span>
<a href="#l4.65"></a><span id="l4.65"> array = []</span>
<a href="#l4.66"></a><span id="l4.66" class="difflineplus">+# Contents of gNormalizeTable.  We insert zero entries for sub-pages where we</span>
<a href="#l4.67"></a><span id="l4.67" class="difflineplus">+# have no mappings.  We insert references to the tables where we do have</span>
<a href="#l4.68"></a><span id="l4.68" class="difflineplus">+# such tables.</span>
<a href="#l4.69"></a><span id="l4.69"> globalTable = []</span>
<a href="#l4.70"></a><span id="l4.70"> globalTable.append(&quot;0&quot;)</span>
<a href="#l4.71"></a><span id="l4.71" class="difflineplus">+# The (exclusive) upper bound of the conversion table, unicode character-wise.</span>
<a href="#l4.72"></a><span id="l4.72" class="difflineplus">+# This is 0x10000 because our generated table is only 16-bit.  This also limits</span>
<a href="#l4.73"></a><span id="l4.73" class="difflineplus">+# the values we can map to; we perform an identity mapping for target values</span>
<a href="#l4.74"></a><span id="l4.74" class="difflineplus">+# that &gt;= maxmapping.</span>
<a href="#l4.75"></a><span id="l4.75"> maxmapping = 0x10000</span>
<a href="#l4.76"></a><span id="l4.76"> sizePerTable = 64</span>
<a href="#l4.77"></a><span id="l4.77"> </span>
<a href="#l4.78"></a><span id="l4.78" class="difflineminus">-# loading case insensitive table</span>
<a href="#l4.79"></a><span id="l4.79" class="difflineplus">+# Map characters that the mapping tells us to obliterate to the NUKE_CHAR</span>
<a href="#l4.80"></a><span id="l4.80" class="difflineplus">+# (such lines look like &quot;FFF0..FFF8&gt;&quot;)</span>
<a href="#l4.81"></a><span id="l4.81" class="difflineplus">+# We do this because if we didn't do this, we would emit these characters as</span>
<a href="#l4.82"></a><span id="l4.82" class="difflineplus">+# part of a token, which we definitely don't want.</span>
<a href="#l4.83"></a><span id="l4.83" class="difflineplus">+NUKE_CHAR = 0x20</span>
<a href="#l4.84"></a><span id="l4.84" class="difflineplus">+</span>
<a href="#l4.85"></a><span id="l4.85" class="difflineplus">+# --- load case folding table</span>
<a href="#l4.86"></a><span id="l4.86" class="difflineplus">+# entries in the file look like:</span>
<a href="#l4.87"></a><span id="l4.87" class="difflineplus">+#  0041&gt;0061</span>
<a href="#l4.88"></a><span id="l4.88" class="difflineplus">+#  02D8&gt;0020 0306</span>
<a href="#l4.89"></a><span id="l4.89" class="difflineplus">+#  2000..200A&gt;0020</span>
<a href="#l4.90"></a><span id="l4.90" class="difflineplus">+#</span>
<a href="#l4.91"></a><span id="l4.91" class="difflineplus">+# The 0041 (uppercase A) tells us it lowercases to 0061 (lowercase a).</span>
<a href="#l4.92"></a><span id="l4.92" class="difflineplus">+# The 02D8 is a &quot;spacing clone[s] of diacritic&quot; breve which gets decomposed into</span>
<a href="#l4.93"></a><span id="l4.93" class="difflineplus">+#  a space character and a breve.  This entry/type of entry also shows up in</span>
<a href="#l4.94"></a><span id="l4.94" class="difflineplus">+#  'nfkc.txt'.</span>
<a href="#l4.95"></a><span id="l4.95" class="difflineplus">+# The 2000..200A covers a range of space characters and maps them down to the</span>
<a href="#l4.96"></a><span id="l4.96" class="difflineplus">+#  'normal' space character.</span>
<a href="#l4.97"></a><span id="l4.97"> </span>
<a href="#l4.98"></a><span id="l4.98"> file = open('nfkc_cf.txt')</span>
<a href="#l4.99"></a><span id="l4.99" class="difflineminus">-line = file.readline()</span>
<a href="#l4.100"></a><span id="l4.100" class="difflineminus">-m = p.match(line)</span>
<a href="#l4.101"></a><span id="l4.101" class="difflineplus">+</span>
<a href="#l4.102"></a><span id="l4.102" class="difflineplus">+m = None</span>
<a href="#l4.103"></a><span id="l4.103" class="difflineplus">+line = &quot;\n&quot;</span>
<a href="#l4.104"></a><span id="l4.104"> i = 0x0</span>
<a href="#l4.105"></a><span id="l4.105"> while i &lt; maxmapping and line:</span>
<a href="#l4.106"></a><span id="l4.106" class="difflineminus">-	if not m:</span>
<a href="#l4.107"></a><span id="l4.107" class="difflineminus">-		line = file.readline()</span>
<a href="#l4.108"></a><span id="l4.108" class="difflineminus">-		m = p.match(line)</span>
<a href="#l4.109"></a><span id="l4.109" class="difflineplus">+        if not m:</span>
<a href="#l4.110"></a><span id="l4.110" class="difflineplus">+                line = file.readline()</span>
<a href="#l4.111"></a><span id="l4.111" class="difflineplus">+                m = p.match(line)</span>
<a href="#l4.112"></a><span id="l4.112" class="difflineplus">+                if not m:</span>
<a href="#l4.113"></a><span id="l4.113" class="difflineplus">+                        continue</span>
<a href="#l4.114"></a><span id="l4.114" class="difflineplus">+                low = int(m.group(G_FROM), 16)</span>
<a href="#l4.115"></a><span id="l4.115" class="difflineplus">+                # if G_TO is present, use it, otherwise fallback to low</span>
<a href="#l4.116"></a><span id="l4.116" class="difflineplus">+                high = m.group(G_TO) and int(m.group(G_TO), 16) or low</span>
<a href="#l4.117"></a><span id="l4.117" class="difflineplus">+                # if G_FIRSTVAL is present use it, otherwise use NUKE_CHAR</span>
<a href="#l4.118"></a><span id="l4.118" class="difflineplus">+                val = (m.group(G_FIRSTVAL) and int(m.group(G_FIRSTVAL), 16)</span>
<a href="#l4.119"></a><span id="l4.119" class="difflineplus">+                                           or NUKE_CHAR)</span>
<a href="#l4.120"></a><span id="l4.120"> 		continue</span>
<a href="#l4.121"></a><span id="l4.121"> </span>
<a href="#l4.122"></a><span id="l4.122" class="difflineminus">-	if i == int(m.group(1), 16):</span>
<a href="#l4.123"></a><span id="l4.123" class="difflineminus">-		if int(m.group(2), 16) &gt;= maxmapping:</span>
<a href="#l4.124"></a><span id="l4.124" class="difflineplus">+</span>
<a href="#l4.125"></a><span id="l4.125" class="difflineplus">+        if i &gt;= low and i &lt;= high:</span>
<a href="#l4.126"></a><span id="l4.126" class="difflineplus">+		if val &gt;= maxmapping:</span>
<a href="#l4.127"></a><span id="l4.127"> 			array.append(i)</span>
<a href="#l4.128"></a><span id="l4.128"> 		else:</span>
<a href="#l4.129"></a><span id="l4.129" class="difflineminus">-			array.append(int(m.group(2), 16))</span>
<a href="#l4.130"></a><span id="l4.130" class="difflineminus">-		m = None</span>
<a href="#l4.131"></a><span id="l4.131" class="difflineplus">+			array.append(val)</span>
<a href="#l4.132"></a><span id="l4.132" class="difflineplus">+                if i == high:</span>
<a href="#l4.133"></a><span id="l4.133" class="difflineplus">+                        m = None</span>
<a href="#l4.134"></a><span id="l4.134"> 	else:</span>
<a href="#l4.135"></a><span id="l4.135"> 		array.append(i)</span>
<a href="#l4.136"></a><span id="l4.136"> 	i = i + 1</span>
<a href="#l4.137"></a><span id="l4.137"> file.close()</span>
<a href="#l4.138"></a><span id="l4.138"> </span>
<a href="#l4.139"></a><span id="l4.139" class="difflineminus">-# loading normalized table</span>
<a href="#l4.140"></a><span id="l4.140" class="difflineminus">-</span>
<a href="#l4.141"></a><span id="l4.141" class="difflineplus">+# --- load normalization / decomposition table</span>
<a href="#l4.142"></a><span id="l4.142" class="difflineplus">+# It is important that this file gets processed second because the other table</span>
<a href="#l4.143"></a><span id="l4.143" class="difflineplus">+# will tell us about mappings from uppercase U with diaeresis to lowercase u</span>
<a href="#l4.144"></a><span id="l4.144" class="difflineplus">+# with diaeresis.  We obviously don't want that clobbering our value.  (Although</span>
<a href="#l4.145"></a><span id="l4.145" class="difflineplus">+# this would work out if we propagated backwards rather than forwards...)</span>
<a href="#l4.146"></a><span id="l4.146" class="difflineplus">+#</span>
<a href="#l4.147"></a><span id="l4.147" class="difflineplus">+# - entries in this file that we care about look like:</span>
<a href="#l4.148"></a><span id="l4.148" class="difflineplus">+#  00A0&gt;0020</span>
<a href="#l4.149"></a><span id="l4.149" class="difflineplus">+#  0100=0041 0304</span>
<a href="#l4.150"></a><span id="l4.150" class="difflineplus">+#</span>
<a href="#l4.151"></a><span id="l4.151" class="difflineplus">+# They are found in the &quot;Canonical and compatibility decomposition mappings&quot;</span>
<a href="#l4.152"></a><span id="l4.152" class="difflineplus">+# section.</span>
<a href="#l4.153"></a><span id="l4.153" class="difflineplus">+#</span>
<a href="#l4.154"></a><span id="l4.154" class="difflineplus">+# The 00A0 is mapping NBSP to the normal space character.</span>
<a href="#l4.155"></a><span id="l4.155" class="difflineplus">+# The 0100 (a capital A with a bar over top of) is equivalent to 0041 (capital</span>
<a href="#l4.156"></a><span id="l4.156" class="difflineplus">+#  A) plus a 0304 (combining overline).  We do not care about the combining</span>
<a href="#l4.157"></a><span id="l4.157" class="difflineplus">+#  marks which is why our regular expression does not capture it.</span>
<a href="#l4.158"></a><span id="l4.158" class="difflineplus">+#</span>
<a href="#l4.159"></a><span id="l4.159" class="difflineplus">+#</span>
<a href="#l4.160"></a><span id="l4.160" class="difflineplus">+# - entries that we do not care about look like:</span>
<a href="#l4.161"></a><span id="l4.161" class="difflineplus">+#  0300..0314:230</span>
<a href="#l4.162"></a><span id="l4.162" class="difflineplus">+#</span>
<a href="#l4.163"></a><span id="l4.163" class="difflineplus">+# These map marks to their canonical combining class which appears to be a way</span>
<a href="#l4.164"></a><span id="l4.164" class="difflineplus">+# of specifying the precedence / order in which marks should be combined.  The</span>
<a href="#l4.165"></a><span id="l4.165" class="difflineplus">+# key thing is we don't care about them.</span>
<a href="#l4.166"></a><span id="l4.166"> file = open('nfkc.txt')</span>
<a href="#l4.167"></a><span id="l4.167"> line = file.readline()</span>
<a href="#l4.168"></a><span id="l4.168"> m = p.match(line)</span>
<a href="#l4.169"></a><span id="l4.169"> while line:</span>
<a href="#l4.170"></a><span id="l4.170"> 	if not m:</span>
<a href="#l4.171"></a><span id="l4.171"> 		line = file.readline()</span>
<a href="#l4.172"></a><span id="l4.172"> 		m = p.match(line)</span>
<a href="#l4.173"></a><span id="l4.173"> 		continue</span>
<a href="#l4.174"></a><span id="l4.174"> </span>
<a href="#l4.175"></a><span id="l4.175" class="difflineminus">-	if m and (int(m.group(1), 16) &lt; maxmapping) and (int(m.group(2), 16) &lt; maxmapping):</span>
<a href="#l4.176"></a><span id="l4.176" class="difflineminus">-		array[int(m.group(1), 16)] = int(m.group(2), 16)</span>
<a href="#l4.177"></a><span id="l4.177" class="difflineplus">+        low = int(m.group(G_FROM), 16)</span>
<a href="#l4.178"></a><span id="l4.178" class="difflineplus">+        # if G_TO is present, use it, otherwise fallback to low</span>
<a href="#l4.179"></a><span id="l4.179" class="difflineplus">+        high = m.group(G_TO) and int(m.group(G_TO), 16) or low</span>
<a href="#l4.180"></a><span id="l4.180" class="difflineplus">+        # if G_FIRSTVAL is present use it, otherwise fall back to NUKE_CHAR</span>
<a href="#l4.181"></a><span id="l4.181" class="difflineplus">+        val = m.group(G_FIRSTVAL) and int(m.group(G_FIRSTVAL), 16) or NUKE_CHAR</span>
<a href="#l4.182"></a><span id="l4.182" class="difflineplus">+        for i in range(low, high+1):</span>
<a href="#l4.183"></a><span id="l4.183" class="difflineplus">+                if i &lt; maxmapping and val &lt; maxmapping:</span>
<a href="#l4.184"></a><span id="l4.184" class="difflineplus">+                        array[i] = val</span>
<a href="#l4.185"></a><span id="l4.185"> 	m = None</span>
<a href="#l4.186"></a><span id="l4.186"> file.close()</span>
<a href="#l4.187"></a><span id="l4.187"> </span>
<a href="#l4.188"></a><span id="l4.188" class="difflineminus">-# generate a noamlzied table to support case insensitive and accent</span>
<a href="#l4.189"></a><span id="l4.189" class="difflineplus">+# --- generate a normalized table to support case and accent folding</span>
<a href="#l4.190"></a><span id="l4.190"> </span>
<a href="#l4.191"></a><span id="l4.191"> i = 0</span>
<a href="#l4.192"></a><span id="l4.192"> needTerm = False;</span>
<a href="#l4.193"></a><span id="l4.193"> while i &lt; maxmapping:</span>
<a href="#l4.194"></a><span id="l4.194"> 	if not i % sizePerTable:</span>
<a href="#l4.195"></a><span id="l4.195"> 		# table is empty?</span>
<a href="#l4.196"></a><span id="l4.196"> 		j = i</span>
<a href="#l4.197"></a><span id="l4.197"> 		while j &lt; i + sizePerTable:</span>
<a href="#l4.198"></a><span id="l4.198" class="difflineat">@@ -152,22 +224,26 @@ while i &lt; maxmapping:</span>
<a href="#l4.199"></a><span id="l4.199"> 			continue</span>
<a href="#l4.200"></a><span id="l4.200"> </span>
<a href="#l4.201"></a><span id="l4.201"> 		if needTerm:</span>
<a href="#l4.202"></a><span id="l4.202"> 			print &quot;};\n&quot;</span>
<a href="#l4.203"></a><span id="l4.203"> 		globalTable.append(&quot;gNormalizeTable%04x&quot; % i)</span>
<a href="#l4.204"></a><span id="l4.204"> 		print &quot;static const unsigned short gNormalizeTable%04x[] = {\n\t&quot; % i,</span>
<a href="#l4.205"></a><span id="l4.205"> 		print &quot;/* U+%04x */\n\t&quot; % i,</span>
<a href="#l4.206"></a><span id="l4.206"> 		needTerm = True</span>
<a href="#l4.207"></a><span id="l4.207" class="difflineminus">-	try:</span>
<a href="#l4.208"></a><span id="l4.208" class="difflineminus">-		c = array[array[i]]</span>
<a href="#l4.209"></a><span id="l4.209" class="difflineminus">-	except:</span>
<a href="#l4.210"></a><span id="l4.210" class="difflineminus">-		c = array[i]</span>
<a href="#l4.211"></a><span id="l4.211" class="difflineplus">+        # Decomposition does not case-fold, so we want to compensate by</span>
<a href="#l4.212"></a><span id="l4.212" class="difflineplus">+        # performing a lookup here.  Because decomposition chains can be</span>
<a href="#l4.213"></a><span id="l4.213" class="difflineplus">+        # example: 01d5, a capital U with a diaeresis and a bar. yes, really.</span>
<a href="#l4.214"></a><span id="l4.214" class="difflineplus">+        # 01d5 -&gt; 00dc -&gt; 0055 (U) -&gt; 0075 (u)</span>
<a href="#l4.215"></a><span id="l4.215" class="difflineplus">+        c = array[i]</span>
<a href="#l4.216"></a><span id="l4.216" class="difflineplus">+        while c != array[c]:</span>
<a href="#l4.217"></a><span id="l4.217" class="difflineplus">+                c = array[c]</span>
<a href="#l4.218"></a><span id="l4.218">         if c &gt;= 0x41 and c &lt;= 0x5a:</span>
<a href="#l4.219"></a><span id="l4.219" class="difflineminus">-            c = c + 0x20</span>
<a href="#l4.220"></a><span id="l4.220" class="difflineplus">+                raise Exception('got an uppercase character somehow: %x =&gt; %x'</span>
<a href="#l4.221"></a><span id="l4.221" class="difflineplus">+                                % (i, c))</span>
<a href="#l4.222"></a><span id="l4.222"> 	print &quot;0x%04x,&quot; % c,</span>
<a href="#l4.223"></a><span id="l4.223"> 	i = i + 1</span>
<a href="#l4.224"></a><span id="l4.224"> 	if not i % 8:</span>
<a href="#l4.225"></a><span id="l4.225"> 		print &quot;\n\t&quot;,</span>
<a href="#l4.226"></a><span id="l4.226"> </span>
<a href="#l4.227"></a><span id="l4.227"> print &quot;};\n\nstatic const unsigned short* gNormalizeTable[] = {&quot;,</span>
<a href="#l4.228"></a><span id="l4.228"> i = 0</span>
<a href="#l4.229"></a><span id="l4.229"> while i &lt; (maxmapping / sizePerTable):</span>
<a href="#l4.230"></a><span id="l4.230" class="difflineat">@@ -176,13 +252,13 @@ while i &lt; (maxmapping / sizePerTable):</span>
<a href="#l4.231"></a><span id="l4.231"> 	print globalTable[i] + &quot;,&quot;, </span>
<a href="#l4.232"></a><span id="l4.232"> 	i += 1</span>
<a href="#l4.233"></a><span id="l4.233"> </span>
<a href="#l4.234"></a><span id="l4.234"> print '''</span>
<a href="#l4.235"></a><span id="l4.235"> };</span>
<a href="#l4.236"></a><span id="l4.236"> </span>
<a href="#l4.237"></a><span id="l4.237"> unsigned int normalize_character(const unsigned int c)</span>
<a href="#l4.238"></a><span id="l4.238"> {</span>
<a href="#l4.239"></a><span id="l4.239" class="difflineminus">-  if (c &gt; 0x10000 || !gNormalizeTable[c &gt;&gt; 6])</span>
<a href="#l4.240"></a><span id="l4.240" class="difflineplus">+  if (c &gt; ''' + ('0x%x' % (maxmapping,)) + ''' || !gNormalizeTable[c &gt;&gt; 6])</span>
<a href="#l4.241"></a><span id="l4.241">     return c;</span>
<a href="#l4.242"></a><span id="l4.242">   return gNormalizeTable[c &gt;&gt; 6][c &amp; 0x3f];</span>
<a href="#l4.243"></a><span id="l4.243"> }</span>
<a href="#l4.244"></a><span id="l4.244"> '''</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/extensions/fts3/src/Normalize.c</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/extensions/fts3/src/Normalize.c</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -15,16 +15,17 @@</span>
<a href="#l5.4"></a><span id="l5.4">  * The Original Code is mozilla.org code.</span>
<a href="#l5.5"></a><span id="l5.5">  *</span>
<a href="#l5.6"></a><span id="l5.6">  * The Initial Developer of the Original Code is Mozilla Japan.</span>
<a href="#l5.7"></a><span id="l5.7">  * Portions created by the Initial Developer are Copyright (C) 2010</span>
<a href="#l5.8"></a><span id="l5.8">  * the Initial Developer. All Rights Reserved.</span>
<a href="#l5.9"></a><span id="l5.9">  *</span>
<a href="#l5.10"></a><span id="l5.10">  * Contributor(s):</span>
<a href="#l5.11"></a><span id="l5.11">  *   Makoto Kato &lt;m_kato@ga2.so-net.ne.jp&gt;</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+ *   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l5.13"></a><span id="l5.13">  *</span>
<a href="#l5.14"></a><span id="l5.14">  * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l5.15"></a><span id="l5.15">  * either of the GNU General Public License Version 2 or later (the &quot;GPL&quot;),</span>
<a href="#l5.16"></a><span id="l5.16">  * or the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l5.17"></a><span id="l5.17">  * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l5.18"></a><span id="l5.18">  * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l5.19"></a><span id="l5.19">  * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l5.20"></a><span id="l5.20">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineat">@@ -51,17 +52,17 @@ static const unsigned short gNormalizeTa</span>
<a href="#l5.22"></a><span id="l5.22"> </span>
<a href="#l5.23"></a><span id="l5.23"> static const unsigned short gNormalizeTable0080[] = {</span>
<a href="#l5.24"></a><span id="l5.24"> 	/* U+0080 */</span>
<a href="#l5.25"></a><span id="l5.25"> 	0x0080, 0x0081, 0x0082, 0x0083, 0x0084, 0x0085, 0x0086, 0x0087, </span>
<a href="#l5.26"></a><span id="l5.26"> 	0x0088, 0x0089, 0x008a, 0x008b, 0x008c, 0x008d, 0x008e, 0x008f, </span>
<a href="#l5.27"></a><span id="l5.27"> 	0x0090, 0x0091, 0x0092, 0x0093, 0x0094, 0x0095, 0x0096, 0x0097, </span>
<a href="#l5.28"></a><span id="l5.28"> 	0x0098, 0x0099, 0x009a, 0x009b, 0x009c, 0x009d, 0x009e, 0x009f, </span>
<a href="#l5.29"></a><span id="l5.29"> 	0x0020, 0x00a1, 0x00a2, 0x00a3, 0x00a4, 0x00a5, 0x00a6, 0x00a7, </span>
<a href="#l5.30"></a><span id="l5.30" class="difflineminus">-	0x0020, 0x00a9, 0x0061, 0x00ab, 0x00ac, 0x00ad, 0x00ae, 0x0020, </span>
<a href="#l5.31"></a><span id="l5.31" class="difflineplus">+	0x0020, 0x00a9, 0x0061, 0x00ab, 0x00ac, 0x0020, 0x00ae, 0x0020, </span>
<a href="#l5.32"></a><span id="l5.32"> 	0x00b0, 0x00b1, 0x0032, 0x0033, 0x0020, 0x03bc, 0x00b6, 0x00b7, </span>
<a href="#l5.33"></a><span id="l5.33"> 	0x0020, 0x0031, 0x006f, 0x00bb, 0x0031, 0x0031, 0x0033, 0x00bf, </span>
<a href="#l5.34"></a><span id="l5.34"> 	};</span>
<a href="#l5.35"></a><span id="l5.35"> </span>
<a href="#l5.36"></a><span id="l5.36"> static const unsigned short gNormalizeTable00c0[] = {</span>
<a href="#l5.37"></a><span id="l5.37"> 	/* U+00c0 */</span>
<a href="#l5.38"></a><span id="l5.38"> 	0x0061, 0x0061, 0x0061, 0x0061, 0x0061, 0x0061, 0x00e6, 0x0063, </span>
<a href="#l5.39"></a><span id="l5.39"> 	0x0065, 0x0065, 0x0065, 0x0065, 0x0069, 0x0069, 0x0069, 0x0069, </span>
<a href="#l5.40"></a><span id="l5.40" class="difflineat">@@ -167,17 +168,17 @@ static const unsigned short gNormalizeTa</span>
<a href="#l5.41"></a><span id="l5.41"> 	0x02e8, 0x02e9, 0x02ea, 0x02eb, 0x02ec, 0x02ed, 0x02ee, 0x02ef, </span>
<a href="#l5.42"></a><span id="l5.42"> 	0x02f0, 0x02f1, 0x02f2, 0x02f3, 0x02f4, 0x02f5, 0x02f6, 0x02f7, </span>
<a href="#l5.43"></a><span id="l5.43"> 	0x02f8, 0x02f9, 0x02fa, 0x02fb, 0x02fc, 0x02fd, 0x02fe, 0x02ff, </span>
<a href="#l5.44"></a><span id="l5.44"> 	};</span>
<a href="#l5.45"></a><span id="l5.45"> </span>
<a href="#l5.46"></a><span id="l5.46"> static const unsigned short gNormalizeTable0340[] = {</span>
<a href="#l5.47"></a><span id="l5.47"> 	/* U+0340 */</span>
<a href="#l5.48"></a><span id="l5.48"> 	0x0300, 0x0301, 0x0342, 0x0313, 0x0308, 0x03b9, 0x0346, 0x0347, </span>
<a href="#l5.49"></a><span id="l5.49" class="difflineminus">-	0x0348, 0x0349, 0x034a, 0x034b, 0x034c, 0x034d, 0x034e, 0x034f, </span>
<a href="#l5.50"></a><span id="l5.50" class="difflineplus">+	0x0348, 0x0349, 0x034a, 0x034b, 0x034c, 0x034d, 0x034e, 0x0020, </span>
<a href="#l5.51"></a><span id="l5.51"> 	0x0350, 0x0351, 0x0352, 0x0353, 0x0354, 0x0355, 0x0356, 0x0357, </span>
<a href="#l5.52"></a><span id="l5.52"> 	0x0358, 0x0359, 0x035a, 0x035b, 0x035c, 0x035d, 0x035e, 0x035f, </span>
<a href="#l5.53"></a><span id="l5.53"> 	0x0360, 0x0361, 0x0362, 0x0363, 0x0364, 0x0365, 0x0366, 0x0367, </span>
<a href="#l5.54"></a><span id="l5.54"> 	0x0368, 0x0369, 0x036a, 0x036b, 0x036c, 0x036d, 0x036e, 0x036f, </span>
<a href="#l5.55"></a><span id="l5.55"> 	0x0371, 0x0371, 0x0373, 0x0373, 0x02b9, 0x0375, 0x0377, 0x0377, </span>
<a href="#l5.56"></a><span id="l5.56"> 	0x0378, 0x0379, 0x0020, 0x037b, 0x037c, 0x037d, 0x003b, 0x037f, </span>
<a href="#l5.57"></a><span id="l5.57"> 	};</span>
<a href="#l5.58"></a><span id="l5.58"> </span>
<a href="#l5.59"></a><span id="l5.59" class="difflineat">@@ -192,17 +193,17 @@ static const unsigned short gNormalizeTa</span>
<a href="#l5.60"></a><span id="l5.60"> 	0x03c5, 0x03b1, 0x03b2, 0x03b3, 0x03b4, 0x03b5, 0x03b6, 0x03b7, </span>
<a href="#l5.61"></a><span id="l5.61"> 	0x03b8, 0x03b9, 0x03ba, 0x03bb, 0x03bc, 0x03bd, 0x03be, 0x03bf, </span>
<a href="#l5.62"></a><span id="l5.62"> 	};</span>
<a href="#l5.63"></a><span id="l5.63"> </span>
<a href="#l5.64"></a><span id="l5.64"> static const unsigned short gNormalizeTable03c0[] = {</span>
<a href="#l5.65"></a><span id="l5.65"> 	/* U+03c0 */</span>
<a href="#l5.66"></a><span id="l5.66"> 	0x03c0, 0x03c1, 0x03c3, 0x03c3, 0x03c4, 0x03c5, 0x03c6, 0x03c7, </span>
<a href="#l5.67"></a><span id="l5.67"> 	0x03c8, 0x03c9, 0x03b9, 0x03c5, 0x03bf, 0x03c5, 0x03c9, 0x03d7, </span>
<a href="#l5.68"></a><span id="l5.68" class="difflineminus">-	0x03b2, 0x03b8, 0x03c5, 0x03a5, 0x03a5, 0x03c6, 0x03c0, 0x03d7, </span>
<a href="#l5.69"></a><span id="l5.69" class="difflineplus">+	0x03b2, 0x03b8, 0x03c5, 0x03c5, 0x03c5, 0x03c6, 0x03c0, 0x03d7, </span>
<a href="#l5.70"></a><span id="l5.70"> 	0x03d9, 0x03d9, 0x03db, 0x03db, 0x03dd, 0x03dd, 0x03df, 0x03df, </span>
<a href="#l5.71"></a><span id="l5.71"> 	0x03e1, 0x03e1, 0x03e3, 0x03e3, 0x03e5, 0x03e5, 0x03e7, 0x03e7, </span>
<a href="#l5.72"></a><span id="l5.72"> 	0x03e9, 0x03e9, 0x03eb, 0x03eb, 0x03ed, 0x03ed, 0x03ef, 0x03ef, </span>
<a href="#l5.73"></a><span id="l5.73"> 	0x03ba, 0x03c1, 0x03c3, 0x03f3, 0x03b8, 0x03b5, 0x03f6, 0x03f8, </span>
<a href="#l5.74"></a><span id="l5.74"> 	0x03f8, 0x03c3, 0x03fb, 0x03fb, 0x03fc, 0x037b, 0x037c, 0x037d, </span>
<a href="#l5.75"></a><span id="l5.75"> 	};</span>
<a href="#l5.76"></a><span id="l5.76"> </span>
<a href="#l5.77"></a><span id="l5.77"> static const unsigned short gNormalizeTable0400[] = {</span>
<a href="#l5.78"></a><span id="l5.78" class="difflineat">@@ -572,16 +573,52 @@ static const unsigned short gNormalizeTa</span>
<a href="#l5.79"></a><span id="l5.79"> 	0x10d0, 0x10d1, 0x10d2, 0x10d3, 0x10d4, 0x10d5, 0x10d6, 0x10d7, </span>
<a href="#l5.80"></a><span id="l5.80"> 	0x10d8, 0x10d9, 0x10da, 0x10db, 0x10dc, 0x10dd, 0x10de, 0x10df, </span>
<a href="#l5.81"></a><span id="l5.81"> 	0x10e0, 0x10e1, 0x10e2, 0x10e3, 0x10e4, 0x10e5, 0x10e6, 0x10e7, </span>
<a href="#l5.82"></a><span id="l5.82"> 	0x10e8, 0x10e9, 0x10ea, 0x10eb, 0x10ec, 0x10ed, 0x10ee, 0x10ef, </span>
<a href="#l5.83"></a><span id="l5.83"> 	0x10f0, 0x10f1, 0x10f2, 0x10f3, 0x10f4, 0x10f5, 0x10f6, 0x10f7, </span>
<a href="#l5.84"></a><span id="l5.84"> 	0x10f8, 0x10f9, 0x10fa, 0x10fb, 0x10dc, 0x10fd, 0x10fe, 0x10ff, </span>
<a href="#l5.85"></a><span id="l5.85"> 	};</span>
<a href="#l5.86"></a><span id="l5.86"> </span>
<a href="#l5.87"></a><span id="l5.87" class="difflineplus">+static const unsigned short gNormalizeTable1140[] = {</span>
<a href="#l5.88"></a><span id="l5.88" class="difflineplus">+	/* U+1140 */</span>
<a href="#l5.89"></a><span id="l5.89" class="difflineplus">+	0x1140, 0x1141, 0x1142, 0x1143, 0x1144, 0x1145, 0x1146, 0x1147, </span>
<a href="#l5.90"></a><span id="l5.90" class="difflineplus">+	0x1148, 0x1149, 0x114a, 0x114b, 0x114c, 0x114d, 0x114e, 0x114f, </span>
<a href="#l5.91"></a><span id="l5.91" class="difflineplus">+	0x1150, 0x1151, 0x1152, 0x1153, 0x1154, 0x1155, 0x1156, 0x1157, </span>
<a href="#l5.92"></a><span id="l5.92" class="difflineplus">+	0x1158, 0x1159, 0x115a, 0x115b, 0x115c, 0x115d, 0x115e, 0x0020, </span>
<a href="#l5.93"></a><span id="l5.93" class="difflineplus">+	0x0020, 0x1161, 0x1162, 0x1163, 0x1164, 0x1165, 0x1166, 0x1167, </span>
<a href="#l5.94"></a><span id="l5.94" class="difflineplus">+	0x1168, 0x1169, 0x116a, 0x116b, 0x116c, 0x116d, 0x116e, 0x116f, </span>
<a href="#l5.95"></a><span id="l5.95" class="difflineplus">+	0x1170, 0x1171, 0x1172, 0x1173, 0x1174, 0x1175, 0x1176, 0x1177, </span>
<a href="#l5.96"></a><span id="l5.96" class="difflineplus">+	0x1178, 0x1179, 0x117a, 0x117b, 0x117c, 0x117d, 0x117e, 0x117f, </span>
<a href="#l5.97"></a><span id="l5.97" class="difflineplus">+	};</span>
<a href="#l5.98"></a><span id="l5.98" class="difflineplus">+</span>
<a href="#l5.99"></a><span id="l5.99" class="difflineplus">+static const unsigned short gNormalizeTable1780[] = {</span>
<a href="#l5.100"></a><span id="l5.100" class="difflineplus">+	/* U+1780 */</span>
<a href="#l5.101"></a><span id="l5.101" class="difflineplus">+	0x1780, 0x1781, 0x1782, 0x1783, 0x1784, 0x1785, 0x1786, 0x1787, </span>
<a href="#l5.102"></a><span id="l5.102" class="difflineplus">+	0x1788, 0x1789, 0x178a, 0x178b, 0x178c, 0x178d, 0x178e, 0x178f, </span>
<a href="#l5.103"></a><span id="l5.103" class="difflineplus">+	0x1790, 0x1791, 0x1792, 0x1793, 0x1794, 0x1795, 0x1796, 0x1797, </span>
<a href="#l5.104"></a><span id="l5.104" class="difflineplus">+	0x1798, 0x1799, 0x179a, 0x179b, 0x179c, 0x179d, 0x179e, 0x179f, </span>
<a href="#l5.105"></a><span id="l5.105" class="difflineplus">+	0x17a0, 0x17a1, 0x17a2, 0x17a3, 0x17a4, 0x17a5, 0x17a6, 0x17a7, </span>
<a href="#l5.106"></a><span id="l5.106" class="difflineplus">+	0x17a8, 0x17a9, 0x17aa, 0x17ab, 0x17ac, 0x17ad, 0x17ae, 0x17af, </span>
<a href="#l5.107"></a><span id="l5.107" class="difflineplus">+	0x17b0, 0x17b1, 0x17b2, 0x17b3, 0x0020, 0x0020, 0x17b6, 0x17b7, </span>
<a href="#l5.108"></a><span id="l5.108" class="difflineplus">+	0x17b8, 0x17b9, 0x17ba, 0x17bb, 0x17bc, 0x17bd, 0x17be, 0x17bf, </span>
<a href="#l5.109"></a><span id="l5.109" class="difflineplus">+	};</span>
<a href="#l5.110"></a><span id="l5.110" class="difflineplus">+</span>
<a href="#l5.111"></a><span id="l5.111" class="difflineplus">+static const unsigned short gNormalizeTable1800[] = {</span>
<a href="#l5.112"></a><span id="l5.112" class="difflineplus">+	/* U+1800 */</span>
<a href="#l5.113"></a><span id="l5.113" class="difflineplus">+	0x1800, 0x1801, 0x1802, 0x1803, 0x1804, 0x1805, 0x1806, 0x1807, </span>
<a href="#l5.114"></a><span id="l5.114" class="difflineplus">+	0x1808, 0x1809, 0x180a, 0x0020, 0x0020, 0x0020, 0x180e, 0x180f, </span>
<a href="#l5.115"></a><span id="l5.115" class="difflineplus">+	0x1810, 0x1811, 0x1812, 0x1813, 0x1814, 0x1815, 0x1816, 0x1817, </span>
<a href="#l5.116"></a><span id="l5.116" class="difflineplus">+	0x1818, 0x1819, 0x181a, 0x181b, 0x181c, 0x181d, 0x181e, 0x181f, </span>
<a href="#l5.117"></a><span id="l5.117" class="difflineplus">+	0x1820, 0x1821, 0x1822, 0x1823, 0x1824, 0x1825, 0x1826, 0x1827, </span>
<a href="#l5.118"></a><span id="l5.118" class="difflineplus">+	0x1828, 0x1829, 0x182a, 0x182b, 0x182c, 0x182d, 0x182e, 0x182f, </span>
<a href="#l5.119"></a><span id="l5.119" class="difflineplus">+	0x1830, 0x1831, 0x1832, 0x1833, 0x1834, 0x1835, 0x1836, 0x1837, </span>
<a href="#l5.120"></a><span id="l5.120" class="difflineplus">+	0x1838, 0x1839, 0x183a, 0x183b, 0x183c, 0x183d, 0x183e, 0x183f, </span>
<a href="#l5.121"></a><span id="l5.121" class="difflineplus">+	};</span>
<a href="#l5.122"></a><span id="l5.122" class="difflineplus">+</span>
<a href="#l5.123"></a><span id="l5.123"> static const unsigned short gNormalizeTable1b00[] = {</span>
<a href="#l5.124"></a><span id="l5.124"> 	/* U+1b00 */</span>
<a href="#l5.125"></a><span id="l5.125"> 	0x1b00, 0x1b01, 0x1b02, 0x1b03, 0x1b04, 0x1b05, 0x1b05, 0x1b07, </span>
<a href="#l5.126"></a><span id="l5.126"> 	0x1b07, 0x1b09, 0x1b09, 0x1b0b, 0x1b0b, 0x1b0d, 0x1b0d, 0x1b0f, </span>
<a href="#l5.127"></a><span id="l5.127"> 	0x1b10, 0x1b11, 0x1b11, 0x1b13, 0x1b14, 0x1b15, 0x1b16, 0x1b17, </span>
<a href="#l5.128"></a><span id="l5.128"> 	0x1b18, 0x1b19, 0x1b1a, 0x1b1b, 0x1b1c, 0x1b1d, 0x1b1e, 0x1b1f, </span>
<a href="#l5.129"></a><span id="l5.129"> 	0x1b20, 0x1b21, 0x1b22, 0x1b23, 0x1b24, 0x1b25, 0x1b26, 0x1b27, </span>
<a href="#l5.130"></a><span id="l5.130"> 	0x1b28, 0x1b29, 0x1b2a, 0x1b2b, 0x1b2c, 0x1b2d, 0x1b2e, 0x1b2f, </span>
<a href="#l5.131"></a><span id="l5.131" class="difflineat">@@ -683,81 +720,81 @@ static const unsigned short gNormalizeTa</span>
<a href="#l5.132"></a><span id="l5.132"> 	0x0075, 0x0075, 0x0075, 0x0075, 0x0075, 0x0075, 0x0075, 0x0075, </span>
<a href="#l5.133"></a><span id="l5.133"> 	0x0075, 0x0075, 0x0079, 0x0079, 0x0079, 0x0079, 0x0079, 0x0079, </span>
<a href="#l5.134"></a><span id="l5.134"> 	0x0079, 0x0079, 0x1efb, 0x1efb, 0x1efd, 0x1efd, 0x1eff, 0x1eff, </span>
<a href="#l5.135"></a><span id="l5.135"> 	};</span>
<a href="#l5.136"></a><span id="l5.136"> </span>
<a href="#l5.137"></a><span id="l5.137"> static const unsigned short gNormalizeTable1f00[] = {</span>
<a href="#l5.138"></a><span id="l5.138"> 	/* U+1f00 */</span>
<a href="#l5.139"></a><span id="l5.139"> 	0x03b1, 0x03b1, 0x03b1, 0x03b1, 0x03b1, 0x03b1, 0x03b1, 0x03b1, </span>
<a href="#l5.140"></a><span id="l5.140" class="difflineminus">-	0x03b1, 0x03b1, 0x0391, 0x0391, 0x0391, 0x0391, 0x0391, 0x0391, </span>
<a href="#l5.141"></a><span id="l5.141" class="difflineplus">+	0x03b1, 0x03b1, 0x03b1, 0x03b1, 0x03b1, 0x03b1, 0x03b1, 0x03b1, </span>
<a href="#l5.142"></a><span id="l5.142"> 	0x03b5, 0x03b5, 0x03b5, 0x03b5, 0x03b5, 0x03b5, 0x1f16, 0x1f17, </span>
<a href="#l5.143"></a><span id="l5.143" class="difflineminus">-	0x03b5, 0x03b5, 0x0395, 0x0395, 0x0395, 0x0395, 0x1f1e, 0x1f1f, </span>
<a href="#l5.144"></a><span id="l5.144" class="difflineplus">+	0x03b5, 0x03b5, 0x03b5, 0x03b5, 0x03b5, 0x03b5, 0x1f1e, 0x1f1f, </span>
<a href="#l5.145"></a><span id="l5.145"> 	0x03b7, 0x03b7, 0x03b7, 0x03b7, 0x03b7, 0x03b7, 0x03b7, 0x03b7, </span>
<a href="#l5.146"></a><span id="l5.146" class="difflineminus">-	0x03b7, 0x03b7, 0x0397, 0x0397, 0x0397, 0x0397, 0x0397, 0x0397, </span>
<a href="#l5.147"></a><span id="l5.147" class="difflineplus">+	0x03b7, 0x03b7, 0x03b7, 0x03b7, 0x03b7, 0x03b7, 0x03b7, 0x03b7, </span>
<a href="#l5.148"></a><span id="l5.148"> 	0x03b9, 0x03b9, 0x03b9, 0x03b9, 0x03b9, 0x03b9, 0x03b9, 0x03b9, </span>
<a href="#l5.149"></a><span id="l5.149" class="difflineminus">-	0x03b9, 0x03b9, 0x0399, 0x0399, 0x0399, 0x0399, 0x0399, 0x0399, </span>
<a href="#l5.150"></a><span id="l5.150" class="difflineplus">+	0x03b9, 0x03b9, 0x03b9, 0x03b9, 0x03b9, 0x03b9, 0x03b9, 0x03b9, </span>
<a href="#l5.151"></a><span id="l5.151"> 	};</span>
<a href="#l5.152"></a><span id="l5.152"> </span>
<a href="#l5.153"></a><span id="l5.153"> static const unsigned short gNormalizeTable1f40[] = {</span>
<a href="#l5.154"></a><span id="l5.154"> 	/* U+1f40 */</span>
<a href="#l5.155"></a><span id="l5.155"> 	0x03bf, 0x03bf, 0x03bf, 0x03bf, 0x03bf, 0x03bf, 0x1f46, 0x1f47, </span>
<a href="#l5.156"></a><span id="l5.156" class="difflineminus">-	0x03bf, 0x03bf, 0x039f, 0x039f, 0x039f, 0x039f, 0x1f4e, 0x1f4f, </span>
<a href="#l5.157"></a><span id="l5.157" class="difflineplus">+	0x03bf, 0x03bf, 0x03bf, 0x03bf, 0x03bf, 0x03bf, 0x1f4e, 0x1f4f, </span>
<a href="#l5.158"></a><span id="l5.158"> 	0x03c5, 0x03c5, 0x03c5, 0x03c5, 0x03c5, 0x03c5, 0x03c5, 0x03c5, </span>
<a href="#l5.159"></a><span id="l5.159" class="difflineminus">-	0x1f58, 0x03c5, 0x1f5a, 0x03a5, 0x1f5c, 0x03a5, 0x1f5e, 0x03a5, </span>
<a href="#l5.160"></a><span id="l5.160" class="difflineplus">+	0x1f58, 0x03c5, 0x1f5a, 0x03c5, 0x1f5c, 0x03c5, 0x1f5e, 0x03c5, </span>
<a href="#l5.161"></a><span id="l5.161"> 	0x03c9, 0x03c9, 0x03c9, 0x03c9, 0x03c9, 0x03c9, 0x03c9, 0x03c9, </span>
<a href="#l5.162"></a><span id="l5.162" class="difflineminus">-	0x03c9, 0x03c9, 0x03a9, 0x03a9, 0x03a9, 0x03a9, 0x03a9, 0x03a9, </span>
<a href="#l5.163"></a><span id="l5.163" class="difflineplus">+	0x03c9, 0x03c9, 0x03c9, 0x03c9, 0x03c9, 0x03c9, 0x03c9, 0x03c9, </span>
<a href="#l5.164"></a><span id="l5.164"> 	0x03b1, 0x03b1, 0x03b5, 0x03b5, 0x03b7, 0x03b7, 0x03b9, 0x03b9, </span>
<a href="#l5.165"></a><span id="l5.165"> 	0x03bf, 0x03bf, 0x03c5, 0x03c5, 0x03c9, 0x03c9, 0x1f7e, 0x1f7f, </span>
<a href="#l5.166"></a><span id="l5.166"> 	};</span>
<a href="#l5.167"></a><span id="l5.167"> </span>
<a href="#l5.168"></a><span id="l5.168"> static const unsigned short gNormalizeTable1f80[] = {</span>
<a href="#l5.169"></a><span id="l5.169"> 	/* U+1f80 */</span>
<a href="#l5.170"></a><span id="l5.170" class="difflineminus">-	0x03b1, 0x03b1, 0x1f00, 0x1f01, 0x1f00, 0x1f01, 0x1f00, 0x1f01, </span>
<a href="#l5.171"></a><span id="l5.171" class="difflineminus">-	0x0391, 0x0391, 0x1f08, 0x1f09, 0x1f08, 0x1f09, 0x1f08, 0x1f09, </span>
<a href="#l5.172"></a><span id="l5.172" class="difflineminus">-	0x03b7, 0x03b7, 0x1f20, 0x1f21, 0x1f20, 0x1f21, 0x1f20, 0x1f21, </span>
<a href="#l5.173"></a><span id="l5.173" class="difflineminus">-	0x0397, 0x0397, 0x1f28, 0x1f29, 0x1f28, 0x1f29, 0x1f28, 0x1f29, </span>
<a href="#l5.174"></a><span id="l5.174" class="difflineminus">-	0x03c9, 0x03c9, 0x1f60, 0x1f61, 0x1f60, 0x1f61, 0x1f60, 0x1f61, </span>
<a href="#l5.175"></a><span id="l5.175" class="difflineminus">-	0x03a9, 0x03a9, 0x1f68, 0x1f69, 0x1f68, 0x1f69, 0x1f68, 0x1f69, </span>
<a href="#l5.176"></a><span id="l5.176" class="difflineplus">+	0x03b1, 0x03b1, 0x03b1, 0x03b1, 0x03b1, 0x03b1, 0x03b1, 0x03b1, </span>
<a href="#l5.177"></a><span id="l5.177" class="difflineplus">+	0x03b1, 0x03b1, 0x03b1, 0x03b1, 0x03b1, 0x03b1, 0x03b1, 0x03b1, </span>
<a href="#l5.178"></a><span id="l5.178" class="difflineplus">+	0x03b7, 0x03b7, 0x03b7, 0x03b7, 0x03b7, 0x03b7, 0x03b7, 0x03b7, </span>
<a href="#l5.179"></a><span id="l5.179" class="difflineplus">+	0x03b7, 0x03b7, 0x03b7, 0x03b7, 0x03b7, 0x03b7, 0x03b7, 0x03b7, </span>
<a href="#l5.180"></a><span id="l5.180" class="difflineplus">+	0x03c9, 0x03c9, 0x03c9, 0x03c9, 0x03c9, 0x03c9, 0x03c9, 0x03c9, </span>
<a href="#l5.181"></a><span id="l5.181" class="difflineplus">+	0x03c9, 0x03c9, 0x03c9, 0x03c9, 0x03c9, 0x03c9, 0x03c9, 0x03c9, </span>
<a href="#l5.182"></a><span id="l5.182"> 	0x03b1, 0x03b1, 0x03b1, 0x03b1, 0x03b1, 0x1fb5, 0x03b1, 0x03b1, </span>
<a href="#l5.183"></a><span id="l5.183" class="difflineminus">-	0x03b1, 0x03b1, 0x03b1, 0x0391, 0x03b1, 0x0020, 0x03b9, 0x0020, </span>
<a href="#l5.184"></a><span id="l5.184" class="difflineplus">+	0x03b1, 0x03b1, 0x03b1, 0x03b1, 0x03b1, 0x0020, 0x03b9, 0x0020, </span>
<a href="#l5.185"></a><span id="l5.185"> 	};</span>
<a href="#l5.186"></a><span id="l5.186"> </span>
<a href="#l5.187"></a><span id="l5.187"> static const unsigned short gNormalizeTable1fc0[] = {</span>
<a href="#l5.188"></a><span id="l5.188"> 	/* U+1fc0 */</span>
<a href="#l5.189"></a><span id="l5.189"> 	0x0020, 0x0020, 0x03b7, 0x03b7, 0x03b7, 0x1fc5, 0x03b7, 0x03b7, </span>
<a href="#l5.190"></a><span id="l5.190" class="difflineminus">-	0x03b5, 0x0395, 0x03b7, 0x0397, 0x03b7, 0x0020, 0x0020, 0x0020, </span>
<a href="#l5.191"></a><span id="l5.191" class="difflineminus">-	0x03b9, 0x03b9, 0x03b9, 0x03ca, 0x1fd4, 0x1fd5, 0x03b9, 0x03b9, </span>
<a href="#l5.192"></a><span id="l5.192" class="difflineminus">-	0x03b9, 0x03b9, 0x03b9, 0x0399, 0x1fdc, 0x0020, 0x0020, 0x0020, </span>
<a href="#l5.193"></a><span id="l5.193" class="difflineminus">-	0x03c5, 0x03c5, 0x03c5, 0x03cb, 0x03c1, 0x03c1, 0x03c5, 0x03c5, </span>
<a href="#l5.194"></a><span id="l5.194" class="difflineminus">-	0x03c5, 0x03c5, 0x03c5, 0x03a5, 0x03c1, 0x0020, 0x00a8, 0x0060, </span>
<a href="#l5.195"></a><span id="l5.195" class="difflineplus">+	0x03b5, 0x03b5, 0x03b7, 0x03b7, 0x03b7, 0x0020, 0x0020, 0x0020, </span>
<a href="#l5.196"></a><span id="l5.196" class="difflineplus">+	0x03b9, 0x03b9, 0x03b9, 0x03b9, 0x1fd4, 0x1fd5, 0x03b9, 0x03b9, </span>
<a href="#l5.197"></a><span id="l5.197" class="difflineplus">+	0x03b9, 0x03b9, 0x03b9, 0x03b9, 0x1fdc, 0x0020, 0x0020, 0x0020, </span>
<a href="#l5.198"></a><span id="l5.198" class="difflineplus">+	0x03c5, 0x03c5, 0x03c5, 0x03c5, 0x03c1, 0x03c1, 0x03c5, 0x03c5, </span>
<a href="#l5.199"></a><span id="l5.199" class="difflineplus">+	0x03c5, 0x03c5, 0x03c5, 0x03c5, 0x03c1, 0x0020, 0x0020, 0x0060, </span>
<a href="#l5.200"></a><span id="l5.200"> 	0x1ff0, 0x1ff1, 0x03c9, 0x03c9, 0x03c9, 0x1ff5, 0x03c9, 0x03c9, </span>
<a href="#l5.201"></a><span id="l5.201" class="difflineminus">-	0x03bf, 0x039f, 0x03c9, 0x03a9, 0x03c9, 0x0020, 0x0020, 0x1fff, </span>
<a href="#l5.202"></a><span id="l5.202" class="difflineplus">+	0x03bf, 0x03bf, 0x03c9, 0x03c9, 0x03c9, 0x0020, 0x0020, 0x1fff, </span>
<a href="#l5.203"></a><span id="l5.203"> 	};</span>
<a href="#l5.204"></a><span id="l5.204"> </span>
<a href="#l5.205"></a><span id="l5.205"> static const unsigned short gNormalizeTable2000[] = {</span>
<a href="#l5.206"></a><span id="l5.206"> 	/* U+2000 */</span>
<a href="#l5.207"></a><span id="l5.207"> 	0x0020, 0x0020, 0x0020, 0x0020, 0x0020, 0x0020, 0x0020, 0x0020, </span>
<a href="#l5.208"></a><span id="l5.208" class="difflineminus">-	0x0020, 0x0020, 0x0020, 0x200b, 0x200c, 0x200d, 0x200e, 0x200f, </span>
<a href="#l5.209"></a><span id="l5.209" class="difflineplus">+	0x0020, 0x0020, 0x0020, 0x0020, 0x0020, 0x0020, 0x0020, 0x0020, </span>
<a href="#l5.210"></a><span id="l5.210"> 	0x2010, 0x2010, 0x2012, 0x2013, 0x2014, 0x2015, 0x2016, 0x0020, </span>
<a href="#l5.211"></a><span id="l5.211"> 	0x2018, 0x2019, 0x201a, 0x201b, 0x201c, 0x201d, 0x201e, 0x201f, </span>
<a href="#l5.212"></a><span id="l5.212"> 	0x2020, 0x2021, 0x2022, 0x2023, 0x002e, 0x002e, 0x002e, 0x2027, </span>
<a href="#l5.213"></a><span id="l5.213" class="difflineminus">-	0x2028, 0x2029, 0x202a, 0x202b, 0x202c, 0x202d, 0x202e, 0x0020, </span>
<a href="#l5.214"></a><span id="l5.214" class="difflineplus">+	0x2028, 0x2029, 0x0020, 0x0020, 0x0020, 0x0020, 0x0020, 0x0020, </span>
<a href="#l5.215"></a><span id="l5.215"> 	0x2030, 0x2031, 0x2032, 0x2032, 0x2032, 0x2035, 0x2035, 0x2035, </span>
<a href="#l5.216"></a><span id="l5.216"> 	0x2038, 0x2039, 0x203a, 0x203b, 0x0021, 0x203d, 0x0020, 0x203f, </span>
<a href="#l5.217"></a><span id="l5.217"> 	};</span>
<a href="#l5.218"></a><span id="l5.218"> </span>
<a href="#l5.219"></a><span id="l5.219"> static const unsigned short gNormalizeTable2040[] = {</span>
<a href="#l5.220"></a><span id="l5.220"> 	/* U+2040 */</span>
<a href="#l5.221"></a><span id="l5.221"> 	0x2040, 0x2041, 0x2042, 0x2043, 0x2044, 0x2045, 0x2046, 0x003f, </span>
<a href="#l5.222"></a><span id="l5.222"> 	0x003f, 0x0021, 0x204a, 0x204b, 0x204c, 0x204d, 0x204e, 0x204f, </span>
<a href="#l5.223"></a><span id="l5.223"> 	0x2050, 0x2051, 0x2052, 0x2053, 0x2054, 0x2055, 0x2056, 0x2032, </span>
<a href="#l5.224"></a><span id="l5.224"> 	0x2058, 0x2059, 0x205a, 0x205b, 0x205c, 0x205d, 0x205e, 0x0020, </span>
<a href="#l5.225"></a><span id="l5.225" class="difflineminus">-	0x2060, 0x2061, 0x2062, 0x2063, 0x2064, 0x2065, 0x2066, 0x2067, </span>
<a href="#l5.226"></a><span id="l5.226" class="difflineminus">-	0x2068, 0x2069, 0x206a, 0x206b, 0x206c, 0x206d, 0x206e, 0x206f, </span>
<a href="#l5.227"></a><span id="l5.227" class="difflineplus">+	0x0020, 0x0020, 0x0020, 0x0020, 0x0020, 0x0020, 0x0020, 0x0020, </span>
<a href="#l5.228"></a><span id="l5.228" class="difflineplus">+	0x0020, 0x0020, 0x0020, 0x0020, 0x0020, 0x0020, 0x0020, 0x0020, </span>
<a href="#l5.229"></a><span id="l5.229"> 	0x0030, 0x0069, 0x2072, 0x2073, 0x0034, 0x0035, 0x0036, 0x0037, </span>
<a href="#l5.230"></a><span id="l5.230"> 	0x0038, 0x0039, 0x002b, 0x2212, 0x003d, 0x0028, 0x0029, 0x006e, </span>
<a href="#l5.231"></a><span id="l5.231"> 	};</span>
<a href="#l5.232"></a><span id="l5.232"> </span>
<a href="#l5.233"></a><span id="l5.233"> static const unsigned short gNormalizeTable2080[] = {</span>
<a href="#l5.234"></a><span id="l5.234"> 	/* U+2080 */</span>
<a href="#l5.235"></a><span id="l5.235"> 	0x0030, 0x0031, 0x0032, 0x0033, 0x0034, 0x0035, 0x0036, 0x0037, </span>
<a href="#l5.236"></a><span id="l5.236"> 	0x0038, 0x0039, 0x002b, 0x2212, 0x003d, 0x0028, 0x0029, 0x208f, </span>
<a href="#l5.237"></a><span id="l5.237" class="difflineat">@@ -1142,17 +1179,17 @@ static const unsigned short gNormalizeTa</span>
<a href="#l5.238"></a><span id="l5.238"> 	};</span>
<a href="#l5.239"></a><span id="l5.239"> </span>
<a href="#l5.240"></a><span id="l5.240"> static const unsigned short gNormalizeTable3140[] = {</span>
<a href="#l5.241"></a><span id="l5.241"> 	/* U+3140 */</span>
<a href="#l5.242"></a><span id="l5.242"> 	0x111a, 0x1106, 0x1107, 0x1108, 0x1121, 0x1109, 0x110a, 0x110b, </span>
<a href="#l5.243"></a><span id="l5.243"> 	0x110c, 0x110d, 0x110e, 0x110f, 0x1110, 0x1111, 0x1112, 0x1161, </span>
<a href="#l5.244"></a><span id="l5.244"> 	0x1162, 0x1163, 0x1164, 0x1165, 0x1166, 0x1167, 0x1168, 0x1169, </span>
<a href="#l5.245"></a><span id="l5.245"> 	0x116a, 0x116b, 0x116c, 0x116d, 0x116e, 0x116f, 0x1170, 0x1171, </span>
<a href="#l5.246"></a><span id="l5.246" class="difflineminus">-	0x1172, 0x1173, 0x1174, 0x1175, 0x1160, 0x1114, 0x1115, 0x11c7, </span>
<a href="#l5.247"></a><span id="l5.247" class="difflineplus">+	0x1172, 0x1173, 0x1174, 0x1175, 0x0020, 0x1114, 0x1115, 0x11c7, </span>
<a href="#l5.248"></a><span id="l5.248"> 	0x11c8, 0x11cc, 0x11ce, 0x11d3, 0x11d7, 0x11d9, 0x111c, 0x11dd, </span>
<a href="#l5.249"></a><span id="l5.249"> 	0x11df, 0x111d, 0x111e, 0x1120, 0x1122, 0x1123, 0x1127, 0x1129, </span>
<a href="#l5.250"></a><span id="l5.250"> 	0x112b, 0x112c, 0x112d, 0x112e, 0x112f, 0x1132, 0x1136, 0x1140, </span>
<a href="#l5.251"></a><span id="l5.251"> 	};</span>
<a href="#l5.252"></a><span id="l5.252"> </span>
<a href="#l5.253"></a><span id="l5.253"> static const unsigned short gNormalizeTable3180[] = {</span>
<a href="#l5.254"></a><span id="l5.254"> 	/* U+3180 */</span>
<a href="#l5.255"></a><span id="l5.255"> 	0x1147, 0x114c, 0x11f1, 0x11f2, 0x1157, 0x1158, 0x1159, 0x1184, </span>
<a href="#l5.256"></a><span id="l5.256" class="difflineat">@@ -1558,18 +1595,18 @@ static const unsigned short gNormalizeTa</span>
<a href="#l5.257"></a><span id="l5.257"> 	0xfde0, 0xfde1, 0xfde2, 0xfde3, 0xfde4, 0xfde5, 0xfde6, 0xfde7, </span>
<a href="#l5.258"></a><span id="l5.258"> 	0xfde8, 0xfde9, 0xfdea, 0xfdeb, 0xfdec, 0xfded, 0xfdee, 0xfdef, </span>
<a href="#l5.259"></a><span id="l5.259"> 	0x0635, 0x0642, 0x0627, 0x0627, 0x0645, 0x0635, 0x0631, 0x0639, </span>
<a href="#l5.260"></a><span id="l5.260"> 	0x0648, 0x0635, 0x0635, 0x062c, 0x0631, 0xfdfd, 0xfdfe, 0xfdff, </span>
<a href="#l5.261"></a><span id="l5.261"> 	};</span>
<a href="#l5.262"></a><span id="l5.262"> </span>
<a href="#l5.263"></a><span id="l5.263"> static const unsigned short gNormalizeTablefe00[] = {</span>
<a href="#l5.264"></a><span id="l5.264"> 	/* U+fe00 */</span>
<a href="#l5.265"></a><span id="l5.265" class="difflineminus">-	0xfe00, 0xfe01, 0xfe02, 0xfe03, 0xfe04, 0xfe05, 0xfe06, 0xfe07, </span>
<a href="#l5.266"></a><span id="l5.266" class="difflineminus">-	0xfe08, 0xfe09, 0xfe0a, 0xfe0b, 0xfe0c, 0xfe0d, 0xfe0e, 0xfe0f, </span>
<a href="#l5.267"></a><span id="l5.267" class="difflineplus">+	0x0020, 0x0020, 0x0020, 0x0020, 0x0020, 0x0020, 0x0020, 0x0020, </span>
<a href="#l5.268"></a><span id="l5.268" class="difflineplus">+	0x0020, 0x0020, 0x0020, 0x0020, 0x0020, 0x0020, 0x0020, 0x0020, </span>
<a href="#l5.269"></a><span id="l5.269"> 	0x002c, 0x3001, 0x3002, 0x003a, 0x003b, 0x0021, 0x003f, 0x3016, </span>
<a href="#l5.270"></a><span id="l5.270"> 	0x3017, 0x002e, 0xfe1a, 0xfe1b, 0xfe1c, 0xfe1d, 0xfe1e, 0xfe1f, </span>
<a href="#l5.271"></a><span id="l5.271"> 	0xfe20, 0xfe21, 0xfe22, 0xfe23, 0xfe24, 0xfe25, 0xfe26, 0xfe27, </span>
<a href="#l5.272"></a><span id="l5.272"> 	0xfe28, 0xfe29, 0xfe2a, 0xfe2b, 0xfe2c, 0xfe2d, 0xfe2e, 0xfe2f, </span>
<a href="#l5.273"></a><span id="l5.273"> 	0x002e, 0x2014, 0x2013, 0x005f, 0x005f, 0x0028, 0x0029, 0x007b, </span>
<a href="#l5.274"></a><span id="l5.274"> 	0x007d, 0x3014, 0x3015, 0x3010, 0x3011, 0x300a, 0x300b, 0x3008, </span>
<a href="#l5.275"></a><span id="l5.275"> 	};</span>
<a href="#l5.276"></a><span id="l5.276"> </span>
<a href="#l5.277"></a><span id="l5.277" class="difflineat">@@ -1601,17 +1638,17 @@ static const unsigned short gNormalizeTa</span>
<a href="#l5.278"></a><span id="l5.278"> 	/* U+fec0 */</span>
<a href="#l5.279"></a><span id="l5.279"> 	0x0636, 0x0637, 0x0637, 0x0637, 0x0637, 0x0638, 0x0638, 0x0638, </span>
<a href="#l5.280"></a><span id="l5.280"> 	0x0638, 0x0639, 0x0639, 0x0639, 0x0639, 0x063a, 0x063a, 0x063a, </span>
<a href="#l5.281"></a><span id="l5.281"> 	0x063a, 0x0641, 0x0641, 0x0641, 0x0641, 0x0642, 0x0642, 0x0642, </span>
<a href="#l5.282"></a><span id="l5.282"> 	0x0642, 0x0643, 0x0643, 0x0643, 0x0643, 0x0644, 0x0644, 0x0644, </span>
<a href="#l5.283"></a><span id="l5.283"> 	0x0644, 0x0645, 0x0645, 0x0645, 0x0645, 0x0646, 0x0646, 0x0646, </span>
<a href="#l5.284"></a><span id="l5.284"> 	0x0646, 0x0647, 0x0647, 0x0647, 0x0647, 0x0648, 0x0648, 0x0649, </span>
<a href="#l5.285"></a><span id="l5.285"> 	0x0649, 0x064a, 0x064a, 0x064a, 0x064a, 0x0644, 0x0644, 0x0644, </span>
<a href="#l5.286"></a><span id="l5.286" class="difflineminus">-	0x0644, 0x0644, 0x0644, 0x0644, 0x0644, 0xfefd, 0xfefe, 0xfeff, </span>
<a href="#l5.287"></a><span id="l5.287" class="difflineplus">+	0x0644, 0x0644, 0x0644, 0x0644, 0x0644, 0xfefd, 0xfefe, 0x0020, </span>
<a href="#l5.288"></a><span id="l5.288"> 	};</span>
<a href="#l5.289"></a><span id="l5.289"> </span>
<a href="#l5.290"></a><span id="l5.290"> static const unsigned short gNormalizeTableff00[] = {</span>
<a href="#l5.291"></a><span id="l5.291"> 	/* U+ff00 */</span>
<a href="#l5.292"></a><span id="l5.292"> 	0xff00, 0x0021, 0x0022, 0x0023, 0x0024, 0x0025, 0x0026, 0x0027, </span>
<a href="#l5.293"></a><span id="l5.293"> 	0x0028, 0x0029, 0x002a, 0x002b, 0x002c, 0x002d, 0x002e, 0x002f, </span>
<a href="#l5.294"></a><span id="l5.294"> 	0x0030, 0x0031, 0x0032, 0x0033, 0x0034, 0x0035, 0x0036, 0x0037, </span>
<a href="#l5.295"></a><span id="l5.295"> 	0x0038, 0x0039, 0x003a, 0x003b, 0x003c, 0x003d, 0x003e, 0x003f, </span>
<a href="#l5.296"></a><span id="l5.296" class="difflineat">@@ -1634,32 +1671,32 @@ static const unsigned short gNormalizeTa</span>
<a href="#l5.297"></a><span id="l5.297"> 	};</span>
<a href="#l5.298"></a><span id="l5.298"> </span>
<a href="#l5.299"></a><span id="l5.299"> static const unsigned short gNormalizeTableff80[] = {</span>
<a href="#l5.300"></a><span id="l5.300"> 	/* U+ff80 */</span>
<a href="#l5.301"></a><span id="l5.301"> 	0x30bf, 0x30c1, 0x30c4, 0x30c6, 0x30c8, 0x30ca, 0x30cb, 0x30cc, </span>
<a href="#l5.302"></a><span id="l5.302"> 	0x30cd, 0x30ce, 0x30cf, 0x30d2, 0x30d5, 0x30d8, 0x30db, 0x30de, </span>
<a href="#l5.303"></a><span id="l5.303"> 	0x30df, 0x30e0, 0x30e1, 0x30e2, 0x30e4, 0x30e6, 0x30e8, 0x30e9, </span>
<a href="#l5.304"></a><span id="l5.304"> 	0x30ea, 0x30eb, 0x30ec, 0x30ed, 0x30ef, 0x30f3, 0x3099, 0x309a, </span>
<a href="#l5.305"></a><span id="l5.305" class="difflineminus">-	0x1160, 0x1100, 0x1101, 0x11aa, 0x1102, 0x11ac, 0x11ad, 0x1103, </span>
<a href="#l5.306"></a><span id="l5.306" class="difflineplus">+	0x0020, 0x1100, 0x1101, 0x11aa, 0x1102, 0x11ac, 0x11ad, 0x1103, </span>
<a href="#l5.307"></a><span id="l5.307"> 	0x1104, 0x1105, 0x11b0, 0x11b1, 0x11b2, 0x11b3, 0x11b4, 0x11b5, </span>
<a href="#l5.308"></a><span id="l5.308"> 	0x111a, 0x1106, 0x1107, 0x1108, 0x1121, 0x1109, 0x110a, 0x110b, </span>
<a href="#l5.309"></a><span id="l5.309"> 	0x110c, 0x110d, 0x110e, 0x110f, 0x1110, 0x1111, 0x1112, 0xffbf, </span>
<a href="#l5.310"></a><span id="l5.310"> 	};</span>
<a href="#l5.311"></a><span id="l5.311"> </span>
<a href="#l5.312"></a><span id="l5.312"> static const unsigned short gNormalizeTableffc0[] = {</span>
<a href="#l5.313"></a><span id="l5.313"> 	/* U+ffc0 */</span>
<a href="#l5.314"></a><span id="l5.314"> 	0xffc0, 0xffc1, 0x1161, 0x1162, 0x1163, 0x1164, 0x1165, 0x1166, </span>
<a href="#l5.315"></a><span id="l5.315"> 	0xffc8, 0xffc9, 0x1167, 0x1168, 0x1169, 0x116a, 0x116b, 0x116c, </span>
<a href="#l5.316"></a><span id="l5.316"> 	0xffd0, 0xffd1, 0x116d, 0x116e, 0x116f, 0x1170, 0x1171, 0x1172, </span>
<a href="#l5.317"></a><span id="l5.317"> 	0xffd8, 0xffd9, 0x1173, 0x1174, 0x1175, 0xffdd, 0xffde, 0xffdf, </span>
<a href="#l5.318"></a><span id="l5.318"> 	0x00a2, 0x00a3, 0x00ac, 0x0020, 0x00a6, 0x00a5, 0x20a9, 0xffe7, </span>
<a href="#l5.319"></a><span id="l5.319"> 	0x2502, 0x2190, 0x2191, 0x2192, 0x2193, 0x25a0, 0x25cb, 0xffef, </span>
<a href="#l5.320"></a><span id="l5.320" class="difflineminus">-	0xfff0, 0xfff1, 0xfff2, 0xfff3, 0xfff4, 0xfff5, 0xfff6, 0xfff7, </span>
<a href="#l5.321"></a><span id="l5.321" class="difflineminus">-	0xfff8, 0xfff9, 0xfffa, 0xfffb, 0xfffc, 0xfffd, 0xfffe, 0xffff, </span>
<a href="#l5.322"></a><span id="l5.322" class="difflineplus">+	0x0020, 0x0020, 0x0020, 0x0020, 0x0020, 0x0020, 0x0020, 0x0020, </span>
<a href="#l5.323"></a><span id="l5.323" class="difflineplus">+	0x0020, 0xfff9, 0xfffa, 0xfffb, 0xfffc, 0xfffd, 0xfffe, 0xffff, </span>
<a href="#l5.324"></a><span id="l5.324"> 	};</span>
<a href="#l5.325"></a><span id="l5.325"> </span>
<a href="#l5.326"></a><span id="l5.326"> static const unsigned short* gNormalizeTable[] = { </span>
<a href="#l5.327"></a><span id="l5.327"> 	0, gNormalizeTable0040, gNormalizeTable0080, gNormalizeTable00c0, </span>
<a href="#l5.328"></a><span id="l5.328"> 	gNormalizeTable0100, gNormalizeTable0140, gNormalizeTable0180, gNormalizeTable01c0, </span>
<a href="#l5.329"></a><span id="l5.329"> 	gNormalizeTable0200, gNormalizeTable0240, gNormalizeTable0280, gNormalizeTable02c0, </span>
<a href="#l5.330"></a><span id="l5.330"> 	0, gNormalizeTable0340, gNormalizeTable0380, gNormalizeTable03c0, </span>
<a href="#l5.331"></a><span id="l5.331"> 	gNormalizeTable0400, gNormalizeTable0440, gNormalizeTable0480, gNormalizeTable04c0, </span>
<a href="#l5.332"></a><span id="l5.332" class="difflineat">@@ -1670,24 +1707,24 @@ static const unsigned short* gNormalizeT</span>
<a href="#l5.333"></a><span id="l5.333"> 	gNormalizeTable0900, gNormalizeTable0940, 0, gNormalizeTable09c0, </span>
<a href="#l5.334"></a><span id="l5.334"> 	gNormalizeTable0a00, gNormalizeTable0a40, 0, 0, </span>
<a href="#l5.335"></a><span id="l5.335"> 	0, gNormalizeTable0b40, gNormalizeTable0b80, gNormalizeTable0bc0, </span>
<a href="#l5.336"></a><span id="l5.336"> 	0, gNormalizeTable0c40, 0, gNormalizeTable0cc0, </span>
<a href="#l5.337"></a><span id="l5.337"> 	0, gNormalizeTable0d40, 0, gNormalizeTable0dc0, </span>
<a href="#l5.338"></a><span id="l5.338"> 	gNormalizeTable0e00, 0, gNormalizeTable0e80, gNormalizeTable0ec0, </span>
<a href="#l5.339"></a><span id="l5.339"> 	gNormalizeTable0f00, gNormalizeTable0f40, gNormalizeTable0f80, 0, </span>
<a href="#l5.340"></a><span id="l5.340"> 	gNormalizeTable1000, 0, gNormalizeTable1080, gNormalizeTable10c0, </span>
<a href="#l5.341"></a><span id="l5.341" class="difflineplus">+	0, gNormalizeTable1140, 0, 0, </span>
<a href="#l5.342"></a><span id="l5.342"> 	0, 0, 0, 0, </span>
<a href="#l5.343"></a><span id="l5.343"> 	0, 0, 0, 0, </span>
<a href="#l5.344"></a><span id="l5.344"> 	0, 0, 0, 0, </span>
<a href="#l5.345"></a><span id="l5.345"> 	0, 0, 0, 0, </span>
<a href="#l5.346"></a><span id="l5.346"> 	0, 0, 0, 0, </span>
<a href="#l5.347"></a><span id="l5.347" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l5.348"></a><span id="l5.348" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l5.349"></a><span id="l5.349" class="difflineminus">-	0, 0, 0, 0, </span>
<a href="#l5.350"></a><span id="l5.350" class="difflineplus">+	0, 0, gNormalizeTable1780, 0, </span>
<a href="#l5.351"></a><span id="l5.351" class="difflineplus">+	gNormalizeTable1800, 0, 0, 0, </span>
<a href="#l5.352"></a><span id="l5.352"> 	0, 0, 0, 0, </span>
<a href="#l5.353"></a><span id="l5.353"> 	0, 0, 0, 0, </span>
<a href="#l5.354"></a><span id="l5.354"> 	gNormalizeTable1b00, gNormalizeTable1b40, 0, 0, </span>
<a href="#l5.355"></a><span id="l5.355"> 	0, 0, 0, 0, </span>
<a href="#l5.356"></a><span id="l5.356"> 	gNormalizeTable1d00, gNormalizeTable1d40, gNormalizeTable1d80, 0, </span>
<a href="#l5.357"></a><span id="l5.357"> 	gNormalizeTable1e00, gNormalizeTable1e40, gNormalizeTable1e80, gNormalizeTable1ec0, </span>
<a href="#l5.358"></a><span id="l5.358"> 	gNormalizeTable1f00, gNormalizeTable1f40, gNormalizeTable1f80, gNormalizeTable1fc0, </span>
<a href="#l5.359"></a><span id="l5.359"> 	gNormalizeTable2000, gNormalizeTable2040, gNormalizeTable2080, 0, </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/extensions/fts3/src/fts3_porter.c</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/extensions/fts3/src/fts3_porter.c</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -78,16 +78,25 @@ static const unsigned char sqlite3Utf8Tr</span>
<a href="#l6.4"></a><span id="l6.4">   0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07,</span>
<a href="#l6.5"></a><span id="l6.5">   0x08, 0x09, 0x0a, 0x0b, 0x0c, 0x0d, 0x0e, 0x0f,</span>
<a href="#l6.6"></a><span id="l6.6">   0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07,</span>
<a href="#l6.7"></a><span id="l6.7">   0x00, 0x01, 0x02, 0x03, 0x00, 0x01, 0x00, 0x00,</span>
<a href="#l6.8"></a><span id="l6.8"> };</span>
<a href="#l6.9"></a><span id="l6.9"> </span>
<a href="#l6.10"></a><span id="l6.10"> typedef unsigned char u8;</span>
<a href="#l6.11"></a><span id="l6.11"> </span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+/**</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+ * SQLite helper macro from sqlite3.c (really utf.c) to encode a unicode</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+ * character into utf8.</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+ *</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineplus">+ * @param zOut A pointer to the current write position that is updated by</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineplus">+ *     the routine.  At entry it should point to one-past the last valid</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineplus">+ *     encoded byte.  The same holds true at exit.</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineplus">+ * @param c The character to encode; this should be an unsigned int.</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineplus">+ */</span>
<a href="#l6.21"></a><span id="l6.21"> #define WRITE_UTF8(zOut, c) {                          \</span>
<a href="#l6.22"></a><span id="l6.22">   if( c&lt;0x0080 ){                                      \</span>
<a href="#l6.23"></a><span id="l6.23">     *zOut++ = (u8)(c&amp;0xff);                            \</span>
<a href="#l6.24"></a><span id="l6.24">   }                                                    \</span>
<a href="#l6.25"></a><span id="l6.25">   else if( c&lt;0x0800 ){                                 \</span>
<a href="#l6.26"></a><span id="l6.26">     *zOut++ = 0xC0 + (u8)((c&gt;&gt;6) &amp; 0x1F);              \</span>
<a href="#l6.27"></a><span id="l6.27">     *zOut++ = 0x80 + (u8)(c &amp; 0x3F);                   \</span>
<a href="#l6.28"></a><span id="l6.28">   }                                                    \</span>
<a href="#l6.29"></a><span id="l6.29" class="difflineat">@@ -99,16 +108,31 @@ typedef unsigned char u8;</span>
<a href="#l6.30"></a><span id="l6.30">     *zOut++ = 0xf0 + (u8)((c&gt;&gt;18) &amp; 0x07);             \</span>
<a href="#l6.31"></a><span id="l6.31">     *zOut++ = 0x80 + (u8)((c&gt;&gt;12) &amp; 0x3F);             \</span>
<a href="#l6.32"></a><span id="l6.32">     *zOut++ = 0x80 + (u8)((c&gt;&gt;6) &amp; 0x3F);              \</span>
<a href="#l6.33"></a><span id="l6.33">     *zOut++ = 0x80 + (u8)(c &amp; 0x3F);                   \</span>
<a href="#l6.34"></a><span id="l6.34">   }                                                    \</span>
<a href="#l6.35"></a><span id="l6.35"> }</span>
<a href="#l6.36"></a><span id="l6.36"> </span>
<a href="#l6.37"></a><span id="l6.37"> /**</span>
<a href="#l6.38"></a><span id="l6.38" class="difflineplus">+ * Fudge factor to avoid buffer overwrites when WRITE_UTF8 is involved.</span>
<a href="#l6.39"></a><span id="l6.39" class="difflineplus">+ *</span>
<a href="#l6.40"></a><span id="l6.40" class="difflineplus">+ * Our normalization table includes entries that may result in a larger</span>
<a href="#l6.41"></a><span id="l6.41" class="difflineplus">+ *  utf-8 encoding.  Namely, 023a maps to 2c65.  This is a growth from 2 bytes</span>
<a href="#l6.42"></a><span id="l6.42" class="difflineplus">+ *  as utf-8 encoded to 3 bytes.  This is currently the only transition possible</span>
<a href="#l6.43"></a><span id="l6.43" class="difflineplus">+ *  because 1-byte encodings are known to stay 1-byte and our normalization</span>
<a href="#l6.44"></a><span id="l6.44" class="difflineplus">+ *  table is 16-bit and so can't generate a 4-byte encoded output.</span>
<a href="#l6.45"></a><span id="l6.45" class="difflineplus">+ *</span>
<a href="#l6.46"></a><span id="l6.46" class="difflineplus">+ * For simplicity, we just multiple by 2 which covers the current case and</span>
<a href="#l6.47"></a><span id="l6.47" class="difflineplus">+ *  potential growth for 2-byte to 4-byte growth.  We can afford to do this</span>
<a href="#l6.48"></a><span id="l6.48" class="difflineplus">+ *  because we're not talking about a lot of memory here as a rule.</span>
<a href="#l6.49"></a><span id="l6.49" class="difflineplus">+ */</span>
<a href="#l6.50"></a><span id="l6.50" class="difflineplus">+#define MAX_UTF8_GROWTH_FACTOR 2</span>
<a href="#l6.51"></a><span id="l6.51" class="difflineplus">+</span>
<a href="#l6.52"></a><span id="l6.52" class="difflineplus">+/**</span>
<a href="#l6.53"></a><span id="l6.53">  * Helper from sqlite3.c to read a single UTF8 character.</span>
<a href="#l6.54"></a><span id="l6.54">  *</span>
<a href="#l6.55"></a><span id="l6.55">  * The clever bit with multi-byte reading is that you keep going until you find</span>
<a href="#l6.56"></a><span id="l6.56">  *  a byte whose top bits are not '10'.  A single-byte UTF8 character will have</span>
<a href="#l6.57"></a><span id="l6.57">  *  '00' or '01', and a multi-byte UTF8 character must start with '11'.</span>
<a href="#l6.58"></a><span id="l6.58">  *</span>
<a href="#l6.59"></a><span id="l6.59">  * In the event of illegal UTF-8 this macro may read an arbitrary number of</span>
<a href="#l6.60"></a><span id="l6.60">  *  characters but will never read past zTerm.  The resulting character value</span>
<a href="#l6.61"></a><span id="l6.61" class="difflineat">@@ -116,27 +140,28 @@ typedef unsigned char u8;</span>
<a href="#l6.62"></a><span id="l6.62">  *  illegal character (0xfffd) for UTF-16 surrogates.</span>
<a href="#l6.63"></a><span id="l6.63">  *</span>
<a href="#l6.64"></a><span id="l6.64">  * @param zIn A pointer to the current position that is updated by the routine,</span>
<a href="#l6.65"></a><span id="l6.65">  *     pointing at the start of the next character when the routine returns.</span>
<a href="#l6.66"></a><span id="l6.66">  * @param zTerm A pointer one past the end of the buffer.</span>
<a href="#l6.67"></a><span id="l6.67">  * @param c The 'unsigned int' to hold the resulting character value.  Do not</span>
<a href="#l6.68"></a><span id="l6.68">  *      use a short or a char.</span>
<a href="#l6.69"></a><span id="l6.69">  */</span>
<a href="#l6.70"></a><span id="l6.70" class="difflineminus">-#define READ_UTF8(zIn, zTerm, c)                           \</span>
<a href="#l6.71"></a><span id="l6.71" class="difflineplus">+#define READ_UTF8(zIn, zTerm, c) {                         \</span>
<a href="#l6.72"></a><span id="l6.72">   c = *(zIn++);                                            \</span>
<a href="#l6.73"></a><span id="l6.73">   if( c&gt;=0xc0 ){                                           \</span>
<a href="#l6.74"></a><span id="l6.74">     c = sqlite3Utf8Trans1[c-0xc0];                         \</span>
<a href="#l6.75"></a><span id="l6.75">     while( zIn!=zTerm &amp;&amp; (*zIn &amp; 0xc0)==0x80 ){            \</span>
<a href="#l6.76"></a><span id="l6.76">       c = (c&lt;&lt;6) + (0x3f &amp; *(zIn++));                      \</span>
<a href="#l6.77"></a><span id="l6.77">     }                                                      \</span>
<a href="#l6.78"></a><span id="l6.78">     if( c&lt;0x80                                             \</span>
<a href="#l6.79"></a><span id="l6.79">         || (c&amp;0xFFFFF800)==0xD800                          \</span>
<a href="#l6.80"></a><span id="l6.80">         || (c&amp;0xFFFFFFFE)==0xFFFE ){  c = 0xFFFD; }        \</span>
<a href="#l6.81"></a><span id="l6.81" class="difflineminus">-  }</span>
<a href="#l6.82"></a><span id="l6.82" class="difflineplus">+  }                                                        \</span>
<a href="#l6.83"></a><span id="l6.83" class="difflineplus">+}</span>
<a href="#l6.84"></a><span id="l6.84"> </span>
<a href="#l6.85"></a><span id="l6.85"> /* end of compatible block to complie codes */</span>
<a href="#l6.86"></a><span id="l6.86"> </span>
<a href="#l6.87"></a><span id="l6.87"> /*</span>
<a href="#l6.88"></a><span id="l6.88"> ** Class derived from sqlite3_tokenizer</span>
<a href="#l6.89"></a><span id="l6.89"> */</span>
<a href="#l6.90"></a><span id="l6.90"> typedef struct porter_tokenizer {</span>
<a href="#l6.91"></a><span id="l6.91">   sqlite3_tokenizer base;      /* Base class */</span>
<a href="#l6.92"></a><span id="l6.92" class="difflineat">@@ -146,17 +171,17 @@ typedef struct porter_tokenizer {</span>
<a href="#l6.93"></a><span id="l6.93"> ** Class derived from sqlit3_tokenizer_cursor</span>
<a href="#l6.94"></a><span id="l6.94"> */</span>
<a href="#l6.95"></a><span id="l6.95"> typedef struct porter_tokenizer_cursor {</span>
<a href="#l6.96"></a><span id="l6.96">   sqlite3_tokenizer_cursor base;</span>
<a href="#l6.97"></a><span id="l6.97">   const char *zInput;          /* input we are tokenizing */</span>
<a href="#l6.98"></a><span id="l6.98">   int nInput;                  /* size of the input */</span>
<a href="#l6.99"></a><span id="l6.99">   int iOffset;                 /* current position in zInput */</span>
<a href="#l6.100"></a><span id="l6.100">   int iToken;                  /* index of next token to be returned */</span>
<a href="#l6.101"></a><span id="l6.101" class="difflineminus">-  char *zToken;                /* storage for current token */</span>
<a href="#l6.102"></a><span id="l6.102" class="difflineplus">+  unsigned char *zToken;       /* storage for current token */</span>
<a href="#l6.103"></a><span id="l6.103">   int nAllocated;              /* space allocated to zToken buffer */</span>
<a href="#l6.104"></a><span id="l6.104">   /**</span>
<a href="#l6.105"></a><span id="l6.105">    * Store the offset of the second character in the bi-gram pair that we just</span>
<a href="#l6.106"></a><span id="l6.106">    *  emitted so that we can consider it being the first character in a bi-gram</span>
<a href="#l6.107"></a><span id="l6.107">    *  pair.</span>
<a href="#l6.108"></a><span id="l6.108">    * The value 0 indicates that there is no previous such character.  This is</span>
<a href="#l6.109"></a><span id="l6.109">    *  an acceptable sentinel value because the 0th offset can never be the</span>
<a href="#l6.110"></a><span id="l6.110">    *  offset of the second in a bi-gram pair.</span>
<a href="#l6.111"></a><span id="l6.111" class="difflineat">@@ -402,65 +427,112 @@ static int stem(</span>
<a href="#l6.112"></a><span id="l6.112">   if( xCond &amp;&amp; !xCond(z) ) return 1;</span>
<a href="#l6.113"></a><span id="l6.113">   while( *zTo ){</span>
<a href="#l6.114"></a><span id="l6.114">     *(--z) = *(zTo++);</span>
<a href="#l6.115"></a><span id="l6.115">   }</span>
<a href="#l6.116"></a><span id="l6.116">   *pz = z;</span>
<a href="#l6.117"></a><span id="l6.117">   return 1;</span>
<a href="#l6.118"></a><span id="l6.118"> }</span>
<a href="#l6.119"></a><span id="l6.119"> </span>
<a href="#l6.120"></a><span id="l6.120" class="difflineplus">+/**</span>
<a href="#l6.121"></a><span id="l6.121" class="difflineplus">+ * Voiced sound mark is only on Japanese.  It is like accent.  It combines with</span>
<a href="#l6.122"></a><span id="l6.122" class="difflineplus">+ * previous character.  Example, &quot;サ&quot; (Katakana) with &quot;゛&quot; (voiced sound mark) is</span>
<a href="#l6.123"></a><span id="l6.123" class="difflineplus">+ * &quot;ザ&quot;.  Although full-width character mapping has combined character like &quot;ザ&quot;,</span>
<a href="#l6.124"></a><span id="l6.124" class="difflineplus">+ * there is no combined character on half-width Katanaka character mapping.</span>
<a href="#l6.125"></a><span id="l6.125" class="difflineplus">+ */</span>
<a href="#l6.126"></a><span id="l6.126"> static int isVoicedSoundMark(const unsigned int c)</span>
<a href="#l6.127"></a><span id="l6.127"> {</span>
<a href="#l6.128"></a><span id="l6.128">   if (c == 0xff9e || c == 0xff9f || c == 0x3099 || c == 0x309a)</span>
<a href="#l6.129"></a><span id="l6.129">     return 1;</span>
<a href="#l6.130"></a><span id="l6.130">   return 0;</span>
<a href="#l6.131"></a><span id="l6.131"> }</span>
<a href="#l6.132"></a><span id="l6.132"> </span>
<a href="#l6.133"></a><span id="l6.133" class="difflineminus">-/*</span>
<a href="#l6.134"></a><span id="l6.134" class="difflineminus">-** This is the fallback stemmer used when the porter stemmer is</span>
<a href="#l6.135"></a><span id="l6.135" class="difflineminus">-** inappropriate.  The input word is copied into the output with</span>
<a href="#l6.136"></a><span id="l6.136" class="difflineminus">-** US-ASCII case folding.  If the input word is too long (more</span>
<a href="#l6.137"></a><span id="l6.137" class="difflineminus">-** than 20 bytes if it contains no digits or more than 6 bytes if</span>
<a href="#l6.138"></a><span id="l6.138" class="difflineminus">-** it contains digits) then word is truncated to 20 or 6 bytes</span>
<a href="#l6.139"></a><span id="l6.139" class="difflineminus">-** by taking 10 or 3 bytes from the beginning and end.</span>
<a href="#l6.140"></a><span id="l6.140" class="difflineminus">-**</span>
<a href="#l6.141"></a><span id="l6.141" class="difflineminus">-** Note:</span>
<a href="#l6.142"></a><span id="l6.142" class="difflineminus">-** This is UTF-8 safe-ish.  If truncation occurs bytes can get mashed together</span>
<a href="#l6.143"></a><span id="l6.143" class="difflineminus">-** in ways that produce illegal UTF-8.  The resulting mashed-up byte strings</span>
<a href="#l6.144"></a><span id="l6.144" class="difflineminus">-** will not be directly exposed to the user and will not do anything dangerous,</span>
<a href="#l6.145"></a><span id="l6.145" class="difflineminus">-** but could result in confusing behavior if queries using wildcard support</span>
<a href="#l6.146"></a><span id="l6.146" class="difflineminus">-** (&quot;*&quot;) are involved.  This is sufficiently harmless that we're not going to</span>
<a href="#l6.147"></a><span id="l6.147" class="difflineminus">-** worry about it for now.</span>
<a href="#l6.148"></a><span id="l6.148" class="difflineminus">-*/</span>
<a href="#l6.149"></a><span id="l6.149" class="difflineminus">-static void copy_stemmer(const unsigned char *zIn, const int nIn, unsigned char *zOut, int *pnOut){</span>
<a href="#l6.150"></a><span id="l6.150" class="difflineminus">-  int i, mx;</span>
<a href="#l6.151"></a><span id="l6.151" class="difflineminus">-  int hasDigit = 0;</span>
<a href="#l6.152"></a><span id="l6.152" class="difflineminus">-  const unsigned char *zInTerm = zIn + nIn;</span>
<a href="#l6.153"></a><span id="l6.153" class="difflineplus">+/**</span>
<a href="#l6.154"></a><span id="l6.154" class="difflineplus">+ * How many unicode characters to take from the front and back of a term in</span>
<a href="#l6.155"></a><span id="l6.155" class="difflineplus">+ * |copy_stemmer|.</span>
<a href="#l6.156"></a><span id="l6.156" class="difflineplus">+ */</span>
<a href="#l6.157"></a><span id="l6.157" class="difflineplus">+#define COPY_STEMMER_COPY_HALF_LEN 10</span>
<a href="#l6.158"></a><span id="l6.158" class="difflineplus">+</span>
<a href="#l6.159"></a><span id="l6.159" class="difflineplus">+/**</span>
<a href="#l6.160"></a><span id="l6.160" class="difflineplus">+ * Normalizing but non-stemming term copying.</span>
<a href="#l6.161"></a><span id="l6.161" class="difflineplus">+ *</span>
<a href="#l6.162"></a><span id="l6.162" class="difflineplus">+ * The original function would take 10 bytes from the front and 10 bytes from</span>
<a href="#l6.163"></a><span id="l6.163" class="difflineplus">+ * the back if there were no digits in the string and it was more than 20</span>
<a href="#l6.164"></a><span id="l6.164" class="difflineplus">+ * bytes long.  If there were digits involved that would decrease to 3 bytes</span>
<a href="#l6.165"></a><span id="l6.165" class="difflineplus">+ * from the front and 3 from the back.  This would potentially corrupt utf-8</span>
<a href="#l6.166"></a><span id="l6.166" class="difflineplus">+ * encoded characters, which is fine from the perspective of the FTS3 logic.</span>
<a href="#l6.167"></a><span id="l6.167" class="difflineplus">+ *</span>
<a href="#l6.168"></a><span id="l6.168" class="difflineplus">+ * In our revised form we now operate on a unicode character basis rather than</span>
<a href="#l6.169"></a><span id="l6.169" class="difflineplus">+ * a byte basis.  Additionally we use the same length limit even if there are</span>
<a href="#l6.170"></a><span id="l6.170" class="difflineplus">+ * digits involved because it's not clear digit token-space reduction is saving</span>
<a href="#l6.171"></a><span id="l6.171" class="difflineplus">+ * us from anything and could be hurting.  Specifically, if no one is ever</span>
<a href="#l6.172"></a><span id="l6.172" class="difflineplus">+ * going to search on things with digits, then we should just remove them.</span>
<a href="#l6.173"></a><span id="l6.173" class="difflineplus">+ * Right now, the space reduction is going to increase false positives when</span>
<a href="#l6.174"></a><span id="l6.174" class="difflineplus">+ * people do search on them and increase the number of collisions sufficiently</span>
<a href="#l6.175"></a><span id="l6.175" class="difflineplus">+ * to make it really expensive.  The caveat is there will be some increase in</span>
<a href="#l6.176"></a><span id="l6.176" class="difflineplus">+ * index size which could be meaningful if people are receiving lots of emails</span>
<a href="#l6.177"></a><span id="l6.177" class="difflineplus">+ * full of distinct numbers.</span>
<a href="#l6.178"></a><span id="l6.178" class="difflineplus">+ *</span>
<a href="#l6.179"></a><span id="l6.179" class="difflineplus">+ * In order to do the copy-from-the-front and copy-from-the-back trick, once</span>
<a href="#l6.180"></a><span id="l6.180" class="difflineplus">+ * we reach N characters in, we set zFrontEnd to the current value of zOut</span>
<a href="#l6.181"></a><span id="l6.181" class="difflineplus">+ * (which represents the termination of the first part of the result string)</span>
<a href="#l6.182"></a><span id="l6.182" class="difflineplus">+ * and set zBackStart to the value of zOutStart.  We then advanced zBackStart</span>
<a href="#l6.183"></a><span id="l6.183" class="difflineplus">+ * along a character at a time as we write more characters.  Once we have</span>
<a href="#l6.184"></a><span id="l6.184" class="difflineplus">+ * traversed the entire string, if zBackStart &gt; zFrontEnd, then we know</span>
<a href="#l6.185"></a><span id="l6.185" class="difflineplus">+ * the string should be shrunk using the characters in the two ranges.</span>
<a href="#l6.186"></a><span id="l6.186" class="difflineplus">+ *</span>
<a href="#l6.187"></a><span id="l6.187" class="difflineplus">+ * (It would be faster to scan from the back with specialized logic but that</span>
<a href="#l6.188"></a><span id="l6.188" class="difflineplus">+ * particular logic seems easy to screw up and we don't have unit tests in here</span>
<a href="#l6.189"></a><span id="l6.189" class="difflineplus">+ * to the extent required.)</span>
<a href="#l6.190"></a><span id="l6.190" class="difflineplus">+ *</span>
<a href="#l6.191"></a><span id="l6.191" class="difflineplus">+ * @param zIn Input string to normalize and potentially shrink.</span>
<a href="#l6.192"></a><span id="l6.192" class="difflineplus">+ * @param nBytesIn The number of bytes in zIn, distinct from the number of</span>
<a href="#l6.193"></a><span id="l6.193" class="difflineplus">+ *     unicode characters encoded in zIn.</span>
<a href="#l6.194"></a><span id="l6.194" class="difflineplus">+ * @param zOut The string to write our output into.  This must have at least</span>
<a href="#l6.195"></a><span id="l6.195" class="difflineplus">+ *     nBytesIn * MAX_UTF8_GROWTH_FACTOR in order to compensate for</span>
<a href="#l6.196"></a><span id="l6.196" class="difflineplus">+ *     normalization that results in a larger utf-8 encoding.</span>
<a href="#l6.197"></a><span id="l6.197" class="difflineplus">+ * @param pnBytesOut Integer to write the number of bytes in zOut into.</span>
<a href="#l6.198"></a><span id="l6.198" class="difflineplus">+ */</span>
<a href="#l6.199"></a><span id="l6.199" class="difflineplus">+static void copy_stemmer(const unsigned char *zIn, const int nBytesIn,</span>
<a href="#l6.200"></a><span id="l6.200" class="difflineplus">+                         unsigned char *zOut, int *pnBytesOut){</span>
<a href="#l6.201"></a><span id="l6.201" class="difflineplus">+  const unsigned char *zInTerm = zIn + nBytesIn;</span>
<a href="#l6.202"></a><span id="l6.202">   unsigned char *zOutStart = zOut;</span>
<a href="#l6.203"></a><span id="l6.203">   unsigned int c;</span>
<a href="#l6.204"></a><span id="l6.204" class="difflineplus">+  unsigned int charCount = 0;</span>
<a href="#l6.205"></a><span id="l6.205" class="difflineplus">+  unsigned char *zFrontEnd = NULL, *zBackStart = NULL;</span>
<a href="#l6.206"></a><span id="l6.206" class="difflineplus">+  unsigned int trashC;</span>
<a href="#l6.207"></a><span id="l6.207"> </span>
<a href="#l6.208"></a><span id="l6.208">   /* copy normalized character */</span>
<a href="#l6.209"></a><span id="l6.209">   while (zIn &lt; zInTerm) {</span>
<a href="#l6.210"></a><span id="l6.210">     READ_UTF8(zIn, zInTerm, c);</span>
<a href="#l6.211"></a><span id="l6.211">     c = normalize_character(c);</span>
<a href="#l6.212"></a><span id="l6.212" class="difflineplus">+</span>
<a href="#l6.213"></a><span id="l6.213">     /* ignore voiced/semi-voiced sound mark */</span>
<a href="#l6.214"></a><span id="l6.214">     if (!isVoicedSoundMark(c)) {</span>
<a href="#l6.215"></a><span id="l6.215" class="difflineminus">-      if( c&gt;='0' &amp;&amp; c&lt;='9' ) hasDigit = 1;</span>
<a href="#l6.216"></a><span id="l6.216" class="difflineplus">+      /* advance one non-voiced sound mark character. */</span>
<a href="#l6.217"></a><span id="l6.217" class="difflineplus">+      if (zBackStart)</span>
<a href="#l6.218"></a><span id="l6.218" class="difflineplus">+        READ_UTF8(zBackStart, zOut, trashC);</span>
<a href="#l6.219"></a><span id="l6.219" class="difflineplus">+</span>
<a href="#l6.220"></a><span id="l6.220">       WRITE_UTF8(zOut, c);</span>
<a href="#l6.221"></a><span id="l6.221" class="difflineplus">+      charCount++;</span>
<a href="#l6.222"></a><span id="l6.222" class="difflineplus">+      if (charCount == COPY_STEMMER_COPY_HALF_LEN) {</span>
<a href="#l6.223"></a><span id="l6.223" class="difflineplus">+        zFrontEnd = zOut;</span>
<a href="#l6.224"></a><span id="l6.224" class="difflineplus">+        zBackStart = zOutStart;</span>
<a href="#l6.225"></a><span id="l6.225" class="difflineplus">+      }</span>
<a href="#l6.226"></a><span id="l6.226">     }</span>
<a href="#l6.227"></a><span id="l6.227">   }</span>
<a href="#l6.228"></a><span id="l6.228" class="difflineminus">-  mx = hasDigit ? 3 : 10;</span>
<a href="#l6.229"></a><span id="l6.229" class="difflineminus">-  if ((zOut - zOutStart) &gt; mx * 2) {</span>
<a href="#l6.230"></a><span id="l6.230" class="difflineminus">-    zOut = zOutStart + mx;</span>
<a href="#l6.231"></a><span id="l6.231" class="difflineminus">-    for (i = nIn - mx; i &lt; nIn; i++) {</span>
<a href="#l6.232"></a><span id="l6.232" class="difflineminus">-      *zOut++ = zOutStart[i];</span>
<a href="#l6.233"></a><span id="l6.233" class="difflineminus">-    }</span>
<a href="#l6.234"></a><span id="l6.234" class="difflineplus">+</span>
<a href="#l6.235"></a><span id="l6.235" class="difflineplus">+  /* if we need to shrink the string, transplant the back bytes */</span>
<a href="#l6.236"></a><span id="l6.236" class="difflineplus">+  if (zBackStart &gt; zFrontEnd) { /* this handles when both are null too */</span>
<a href="#l6.237"></a><span id="l6.237" class="difflineplus">+    size_t backBytes = zOut - zBackStart;</span>
<a href="#l6.238"></a><span id="l6.238" class="difflineplus">+    memmove(zFrontEnd, zBackStart, backBytes);</span>
<a href="#l6.239"></a><span id="l6.239" class="difflineplus">+    zOut = zFrontEnd + backBytes;</span>
<a href="#l6.240"></a><span id="l6.240">   }</span>
<a href="#l6.241"></a><span id="l6.241">   *zOut = 0;</span>
<a href="#l6.242"></a><span id="l6.242" class="difflineminus">-  *pnOut = zOut - zOutStart;</span>
<a href="#l6.243"></a><span id="l6.243" class="difflineplus">+  *pnBytesOut = zOut - zOutStart;</span>
<a href="#l6.244"></a><span id="l6.244"> }</span>
<a href="#l6.245"></a><span id="l6.245"> </span>
<a href="#l6.246"></a><span id="l6.246"> </span>
<a href="#l6.247"></a><span id="l6.247"> /*</span>
<a href="#l6.248"></a><span id="l6.248"> ** Stem the input word zIn[0..nIn-1].  Store the output in zOut.</span>
<a href="#l6.249"></a><span id="l6.249"> ** zOut is at least big enough to hold nIn bytes.  Write the actual</span>
<a href="#l6.250"></a><span id="l6.250"> ** size of the output word (exclusive of the '\0' terminator) into *pnOut.</span>
<a href="#l6.251"></a><span id="l6.251"> **</span>
<a href="#l6.252"></a><span id="l6.252" class="difflineat">@@ -477,17 +549,17 @@ static void copy_stemmer(const unsigned </span>
<a href="#l6.253"></a><span id="l6.253"> ** If the input word contains not digits but does characters not </span>
<a href="#l6.254"></a><span id="l6.254"> ** in [a-zA-Z] then no stemming is attempted and this routine just </span>
<a href="#l6.255"></a><span id="l6.255"> ** copies the input into the input into the output with US-ASCII</span>
<a href="#l6.256"></a><span id="l6.256"> ** case folding.</span>
<a href="#l6.257"></a><span id="l6.257"> **</span>
<a href="#l6.258"></a><span id="l6.258"> ** Stemming never increases the length of the word.  So there is</span>
<a href="#l6.259"></a><span id="l6.259"> ** no chance of overflowing the zOut buffer.</span>
<a href="#l6.260"></a><span id="l6.260"> */</span>
<a href="#l6.261"></a><span id="l6.261" class="difflineminus">-static void porter_stemmer(const unsigned char *zIn, unsigned int nIn, char *zOut, int *pnOut){</span>
<a href="#l6.262"></a><span id="l6.262" class="difflineplus">+static void porter_stemmer(const unsigned char *zIn, unsigned int nIn, unsigned char *zOut, int *pnOut){</span>
<a href="#l6.263"></a><span id="l6.263">   unsigned int i, j, c;</span>
<a href="#l6.264"></a><span id="l6.264">   char zReverse[28];</span>
<a href="#l6.265"></a><span id="l6.265">   char *z, *z2;</span>
<a href="#l6.266"></a><span id="l6.266">   const unsigned char *zTerm = zIn + nIn;</span>
<a href="#l6.267"></a><span id="l6.267">   unsigned char *zTmp = zIn;</span>
<a href="#l6.268"></a><span id="l6.268"> </span>
<a href="#l6.269"></a><span id="l6.269">   if( nIn&lt;3 || nIn&gt;=sizeof(zReverse)-7 ){</span>
<a href="#l6.270"></a><span id="l6.270">     /* The word is too big or too small for the porter stemmer.</span>
<a href="#l6.271"></a><span id="l6.271" class="difflineat">@@ -858,20 +930,20 @@ static int isDelim(</span>
<a href="#l6.272"></a><span id="l6.272">  *    characters.  We run the porter stemmer algorithm against the word.</span>
<a href="#l6.273"></a><span id="l6.273">  *    Because we have no way to know what is and is not an English word</span>
<a href="#l6.274"></a><span id="l6.274">  *    (the only language for which the porter stemmer was designed), this</span>
<a href="#l6.275"></a><span id="l6.275">  *    could theoretically map multiple words that are not variations of the</span>
<a href="#l6.276"></a><span id="l6.276">  *    same word down to the same root, resulting in potentially unexpected</span>
<a href="#l6.277"></a><span id="l6.277">  *    result inclusions in the search results.  We accept this result because</span>
<a href="#l6.278"></a><span id="l6.278">  *    there's not a lot we can do about it and false positives are much</span>
<a href="#l6.279"></a><span id="l6.279">  *    better than false negatives.</span>
<a href="#l6.280"></a><span id="l6.280" class="difflineminus">- * - A copied token; ASCII case-folded but not stemmed.  We call the porter</span>
<a href="#l6.281"></a><span id="l6.281" class="difflineplus">+ * - A copied token; case/accent-folded but not stemmed.  We call the porter</span>
<a href="#l6.282"></a><span id="l6.282">  *    stemmer for all non-CJK cases and it diverts to the copy stemmer if it</span>
<a href="#l6.283"></a><span id="l6.283" class="difflineminus">- *    sees any non-ASCII characters or the string is too long.  The copy</span>
<a href="#l6.284"></a><span id="l6.284" class="difflineminus">- *    stemmer will truncate the string if it is deemed too long.</span>
<a href="#l6.285"></a><span id="l6.285" class="difflineplus">+ *    sees any non-ASCII characters (after folding) or if the string is too</span>
<a href="#l6.286"></a><span id="l6.286" class="difflineplus">+ *    long.  The copy stemmer will shrink the string if it is deemed too long.</span>
<a href="#l6.287"></a><span id="l6.287">  * - A bi-gram token; two CJK-ish characters.  For query reasons we generate a</span>
<a href="#l6.288"></a><span id="l6.288">  *    series of overlapping bi-grams.  (We can't require the user to start their</span>
<a href="#l6.289"></a><span id="l6.289">  *    search based on the arbitrary context of the indexed documents.)</span>
<a href="#l6.290"></a><span id="l6.290">  *</span>
<a href="#l6.291"></a><span id="l6.291">  * It may be useful to think of this function as operating at the points between</span>
<a href="#l6.292"></a><span id="l6.292">  *  characters.  While we are considering the 'current' character (the one after</span>
<a href="#l6.293"></a><span id="l6.293">  *  the 'point'), we are also interested in the 'previous' character (the one</span>
<a href="#l6.294"></a><span id="l6.294">  *  preceding the point).</span>
<a href="#l6.295"></a><span id="l6.295" class="difflineat">@@ -1009,18 +1081,18 @@ static int porterNext(</span>
<a href="#l6.296"></a><span id="l6.296">         // wildcard case:</span>
<a href="#l6.297"></a><span id="l6.297">         (numChars == 1 &amp;&amp; iStartOffset == 0 &amp;&amp;</span>
<a href="#l6.298"></a><span id="l6.298">          (c-&gt;iOffset &gt;= 3) &amp;&amp;</span>
<a href="#l6.299"></a><span id="l6.299">          (c-&gt;iOffset == c-&gt;nInput - 1) &amp;&amp;</span>
<a href="#l6.300"></a><span id="l6.300">          (z[c-&gt;iOffset] == '*'))) {</span>
<a href="#l6.301"></a><span id="l6.301">       /* figure out the number of bytes to copy/stem */</span>
<a href="#l6.302"></a><span id="l6.302">       int n = c-&gt;iOffset - iStartOffset;</span>
<a href="#l6.303"></a><span id="l6.303">       /* make sure there is enough buffer space */</span>
<a href="#l6.304"></a><span id="l6.304" class="difflineminus">-      if (n &gt; c-&gt;nAllocated) {</span>
<a href="#l6.305"></a><span id="l6.305" class="difflineminus">-        c-&gt;nAllocated = n + 20;</span>
<a href="#l6.306"></a><span id="l6.306" class="difflineplus">+      if (n * MAX_UTF8_GROWTH_FACTOR &gt; c-&gt;nAllocated) {</span>
<a href="#l6.307"></a><span id="l6.307" class="difflineplus">+        c-&gt;nAllocated = n * MAX_UTF8_GROWTH_FACTOR + 20;</span>
<a href="#l6.308"></a><span id="l6.308">         c-&gt;zToken = sqlite3_realloc(c-&gt;zToken, c-&gt;nAllocated);</span>
<a href="#l6.309"></a><span id="l6.309">         if (c-&gt;zToken == NULL)</span>
<a href="#l6.310"></a><span id="l6.310">           return SQLITE_NOMEM;</span>
<a href="#l6.311"></a><span id="l6.311">       }</span>
<a href="#l6.312"></a><span id="l6.312"> </span>
<a href="#l6.313"></a><span id="l6.313">       if (state == BIGRAM_USE) {</span>
<a href="#l6.314"></a><span id="l6.314">         /* This is by bigram. So it is unnecessary to convert word */</span>
<a href="#l6.315"></a><span id="l6.315">         copy_stemmer(&amp;z[iStartOffset], n, c-&gt;zToken, pnBytes);</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

