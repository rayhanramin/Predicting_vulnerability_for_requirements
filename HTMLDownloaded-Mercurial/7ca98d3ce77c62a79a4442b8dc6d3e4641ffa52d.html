<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 19432:7ca98d3ce77c62a79a4442b8dc6d3e4641ffa52d</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 7ca98d3ce77c62a79a4442b8dc6d3e4641ffa52d" />
<meta property="og:url" content="/comm-central/rev/7ca98d3ce77c62a79a4442b8dc6d3e4641ffa52d" />
<meta property="og:description" content="Bug 1267649 - Support SASL SCRAM authentication mechanism. r=aleth,clokep" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 7ca98d3ce77c62a79a4442b8dc6d3e4641ffa52d 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/7ca98d3ce77c62a79a4442b8dc6d3e4641ffa52d">shortlog</a> |
<a href="/comm-central/log/7ca98d3ce77c62a79a4442b8dc6d3e4641ffa52d">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/7ca98d3ce77c62a79a4442b8dc6d3e4641ffa52d">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/7ca98d3ce77c62a79a4442b8dc6d3e4641ffa52d">files</a> |
changeset |
<a href="/comm-central/raw-rev/7ca98d3ce77c62a79a4442b8dc6d3e4641ffa52d">raw</a>  | <a href="/comm-central/archive/7ca98d3ce77c62a79a4442b8dc6d3e4641ffa52d.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1267649">Bug 1267649</a> - Support SASL SCRAM authentication mechanism. r=aleth,clokep
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#65;&#98;&#100;&#101;&#108;&#114;&#104;&#109;&#97;&#110;&#32;&#65;&#104;&#109;&#101;&#100;&#32;&#60;&#97;&#98;&#64;&#97;&#98;&#97;&#104;&#109;&#101;&#100;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Sat, 04 Jun 2016 06:34:00 +0200</td></tr>

<tr>
 <td>changeset 19432</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/7ca98d3ce77c62a79a4442b8dc6d3e4641ffa52d">7ca98d3ce77c62a79a4442b8dc6d3e4641ffa52d</a></td>
</tr>



<tr>
<td>parent 19431</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/71291aefc43aa28f26e6b37e76e142ee232ebb31">71291aefc43aa28f26e6b37e76e142ee232ebb31</a>
</td>
</tr>

<tr>
<td>child 19433</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/c37795888b0e9e92bbb145403b72bf14a201285e">c37795888b0e9e92bbb145403b72bf14a201285e</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=7ca98d3ce77c62a79a4442b8dc6d3e4641ffa52d">11961</a></td></tr>
<tr><td>push user</td><td>aleth@instantbird.org</td></tr>
<tr><td>push date</td><td class="date age">Tue, 07 Jun 2016 19:14:08 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@7ca98d3ce77c [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=7ca98d3ce77c62a79a4442b8dc6d3e4641ffa52d">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=7ca98d3ce77c62a79a4442b8dc6d3e4641ffa52d&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=7ca98d3ce77c62a79a4442b8dc6d3e4641ffa52d&newProject=comm-central&newRevision=71291aefc43aa28f26e6b37e76e142ee232ebb31&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=7ca98d3ce77c62a79a4442b8dc6d3e4641ffa52d&newProject=comm-central&newRevision=71291aefc43aa28f26e6b37e76e142ee232ebb31&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=7ca98d3ce77c62a79a4442b8dc6d3e4641ffa52d&newProject=comm-central&newRevision=71291aefc43aa28f26e6b37e76e142ee232ebb31&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28aleth%29&revcount=50">aleth</a>, <a href="/comm-central/log?rev=reviewer%28clokep%29&revcount=50">clokep</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1267649">1267649</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1267649">Bug 1267649</a> - Support SASL SCRAM authentication mechanism. r=aleth,clokep</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7ca98d3ce77c62a79a4442b8dc6d3e4641ffa52d/chat/protocols/xmpp/test/test_saslPrep.js">chat/protocols/xmpp/test/test_saslPrep.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7ca98d3ce77c62a79a4442b8dc6d3e4641ffa52d/chat/protocols/xmpp/test/test_saslPrep.js">file</a> |
<a href="/comm-central/annotate/7ca98d3ce77c62a79a4442b8dc6d3e4641ffa52d/chat/protocols/xmpp/test/test_saslPrep.js">annotate</a> |
<a href="/comm-central/diff/7ca98d3ce77c62a79a4442b8dc6d3e4641ffa52d/chat/protocols/xmpp/test/test_saslPrep.js">diff</a> |
<a href="/comm-central/comparison/7ca98d3ce77c62a79a4442b8dc6d3e4641ffa52d/chat/protocols/xmpp/test/test_saslPrep.js">comparison</a> |
<a href="/comm-central/log/7ca98d3ce77c62a79a4442b8dc6d3e4641ffa52d/chat/protocols/xmpp/test/test_saslPrep.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7ca98d3ce77c62a79a4442b8dc6d3e4641ffa52d/chat/protocols/xmpp/test/xpcshell.ini">chat/protocols/xmpp/test/xpcshell.ini</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7ca98d3ce77c62a79a4442b8dc6d3e4641ffa52d/chat/protocols/xmpp/test/xpcshell.ini">file</a> |
<a href="/comm-central/annotate/7ca98d3ce77c62a79a4442b8dc6d3e4641ffa52d/chat/protocols/xmpp/test/xpcshell.ini">annotate</a> |
<a href="/comm-central/diff/7ca98d3ce77c62a79a4442b8dc6d3e4641ffa52d/chat/protocols/xmpp/test/xpcshell.ini">diff</a> |
<a href="/comm-central/comparison/7ca98d3ce77c62a79a4442b8dc6d3e4641ffa52d/chat/protocols/xmpp/test/xpcshell.ini">comparison</a> |
<a href="/comm-central/log/7ca98d3ce77c62a79a4442b8dc6d3e4641ffa52d/chat/protocols/xmpp/test/xpcshell.ini">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7ca98d3ce77c62a79a4442b8dc6d3e4641ffa52d/chat/protocols/xmpp/xmpp-authmechs.jsm">chat/protocols/xmpp/xmpp-authmechs.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7ca98d3ce77c62a79a4442b8dc6d3e4641ffa52d/chat/protocols/xmpp/xmpp-authmechs.jsm">file</a> |
<a href="/comm-central/annotate/7ca98d3ce77c62a79a4442b8dc6d3e4641ffa52d/chat/protocols/xmpp/xmpp-authmechs.jsm">annotate</a> |
<a href="/comm-central/diff/7ca98d3ce77c62a79a4442b8dc6d3e4641ffa52d/chat/protocols/xmpp/xmpp-authmechs.jsm">diff</a> |
<a href="/comm-central/comparison/7ca98d3ce77c62a79a4442b8dc6d3e4641ffa52d/chat/protocols/xmpp/xmpp-authmechs.jsm">comparison</a> |
<a href="/comm-central/log/7ca98d3ce77c62a79a4442b8dc6d3e4641ffa52d/chat/protocols/xmpp/xmpp-authmechs.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7ca98d3ce77c62a79a4442b8dc6d3e4641ffa52d/chat/protocols/xmpp/xmpp-session.jsm">chat/protocols/xmpp/xmpp-session.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7ca98d3ce77c62a79a4442b8dc6d3e4641ffa52d/chat/protocols/xmpp/xmpp-session.jsm">file</a> |
<a href="/comm-central/annotate/7ca98d3ce77c62a79a4442b8dc6d3e4641ffa52d/chat/protocols/xmpp/xmpp-session.jsm">annotate</a> |
<a href="/comm-central/diff/7ca98d3ce77c62a79a4442b8dc6d3e4641ffa52d/chat/protocols/xmpp/xmpp-session.jsm">diff</a> |
<a href="/comm-central/comparison/7ca98d3ce77c62a79a4442b8dc6d3e4641ffa52d/chat/protocols/xmpp/xmpp-session.jsm">comparison</a> |
<a href="/comm-central/log/7ca98d3ce77c62a79a4442b8dc6d3e4641ffa52d/chat/protocols/xmpp/xmpp-session.jsm">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1">new file mode 100644</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineminus">--- /dev/null</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineplus">+++ b/chat/protocols/xmpp/test/test_saslPrep.js</span>
<a href="#l1.4"></a><span id="l1.4" class="difflineat">@@ -0,0 +1,68 @@</span>
<a href="#l1.5"></a><span id="l1.5" class="difflineplus">+/* Any copyright is dedicated to the Public Domain.</span>
<a href="#l1.6"></a><span id="l1.6" class="difflineplus">+* http://creativecommons.org/publicdomain/zero/1.0/ */</span>
<a href="#l1.7"></a><span id="l1.7" class="difflineplus">+</span>
<a href="#l1.8"></a><span id="l1.8" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l1.9"></a><span id="l1.9" class="difflineplus">+</span>
<a href="#l1.10"></a><span id="l1.10" class="difflineplus">+var xmppAuth = {};</span>
<a href="#l1.11"></a><span id="l1.11" class="difflineplus">+Services.scriptloader.loadSubScript(&quot;resource:///modules/xmpp-authmechs.jsm&quot;,</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+                                    xmppAuth);</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+// RFC 4013 3.Examples</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+var TEST_DATA = [</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineplus">+  {</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineplus">+    // SOFT HYPHEN mapped to nothing.</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineplus">+    input: &quot;I\u00adX&quot;,</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineplus">+    output: &quot;IX&quot;,</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineplus">+    isError: false</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineplus">+  },</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineplus">+  {</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineplus">+    // No transformation.</span>
<a href="#l1.24"></a><span id="l1.24" class="difflineplus">+    input: &quot;user&quot;,</span>
<a href="#l1.25"></a><span id="l1.25" class="difflineplus">+    output: &quot;user&quot;,</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineplus">+    isError: false</span>
<a href="#l1.27"></a><span id="l1.27" class="difflineplus">+  },</span>
<a href="#l1.28"></a><span id="l1.28" class="difflineplus">+  {</span>
<a href="#l1.29"></a><span id="l1.29" class="difflineplus">+    // Case preserved, will not match #2.</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineplus">+    input: &quot;USER&quot;,</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineplus">+    output: &quot;USER&quot;,</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineplus">+    isError: false</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineplus">+  },</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineplus">+  {</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineplus">+    // Output is NFKC, input in ISO 8859-1.</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineplus">+    input: &quot;\u00aa&quot;,</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineplus">+    output: &quot;a&quot;,</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineplus">+    isError: false</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineplus">+  },</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineplus">+  {</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineplus">+    // Output is NFKC, will match #1.</span>
<a href="#l1.42"></a><span id="l1.42" class="difflineplus">+    input: &quot;\u2168&quot;,</span>
<a href="#l1.43"></a><span id="l1.43" class="difflineplus">+    output: &quot;IX&quot;,</span>
<a href="#l1.44"></a><span id="l1.44" class="difflineplus">+    isError: false</span>
<a href="#l1.45"></a><span id="l1.45" class="difflineplus">+  },</span>
<a href="#l1.46"></a><span id="l1.46" class="difflineplus">+  {</span>
<a href="#l1.47"></a><span id="l1.47" class="difflineplus">+    // Error - prohibited character.</span>
<a href="#l1.48"></a><span id="l1.48" class="difflineplus">+    input: &quot;\u0007&quot;,</span>
<a href="#l1.49"></a><span id="l1.49" class="difflineplus">+    output: &quot;&quot;,</span>
<a href="#l1.50"></a><span id="l1.50" class="difflineplus">+    isError: true</span>
<a href="#l1.51"></a><span id="l1.51" class="difflineplus">+  },</span>
<a href="#l1.52"></a><span id="l1.52" class="difflineplus">+  {</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineplus">+    // Error - bidirectional check.</span>
<a href="#l1.54"></a><span id="l1.54" class="difflineplus">+    input: &quot;\u0627\u0031&quot;,</span>
<a href="#l1.55"></a><span id="l1.55" class="difflineplus">+    output: &quot;&quot;,</span>
<a href="#l1.56"></a><span id="l1.56" class="difflineplus">+    isError: true</span>
<a href="#l1.57"></a><span id="l1.57" class="difflineplus">+  }</span>
<a href="#l1.58"></a><span id="l1.58" class="difflineplus">+];</span>
<a href="#l1.59"></a><span id="l1.59" class="difflineplus">+</span>
<a href="#l1.60"></a><span id="l1.60" class="difflineplus">+function run_test() {</span>
<a href="#l1.61"></a><span id="l1.61" class="difflineplus">+  for (let current of TEST_DATA) {</span>
<a href="#l1.62"></a><span id="l1.62" class="difflineplus">+    try{</span>
<a href="#l1.63"></a><span id="l1.63" class="difflineplus">+      let result = xmppAuth.saslPrep(current.input);</span>
<a href="#l1.64"></a><span id="l1.64" class="difflineplus">+      equal(current.isError, false);</span>
<a href="#l1.65"></a><span id="l1.65" class="difflineplus">+      equal(result, current.output);</span>
<a href="#l1.66"></a><span id="l1.66" class="difflineplus">+    } catch (e) {</span>
<a href="#l1.67"></a><span id="l1.67" class="difflineplus">+      equal(current.isError, true);</span>
<a href="#l1.68"></a><span id="l1.68" class="difflineplus">+    }</span>
<a href="#l1.69"></a><span id="l1.69" class="difflineplus">+  }</span>
<a href="#l1.70"></a><span id="l1.70" class="difflineplus">+</span>
<a href="#l1.71"></a><span id="l1.71" class="difflineplus">+  run_next_test();</span>
<a href="#l1.72"></a><span id="l1.72" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/chat/protocols/xmpp/test/xpcshell.ini</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/chat/protocols/xmpp/test/xpcshell.ini</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -1,6 +1,7 @@</span>
<a href="#l2.4"></a><span id="l2.4"> [DEFAULT]</span>
<a href="#l2.5"></a><span id="l2.5"> head =</span>
<a href="#l2.6"></a><span id="l2.6"> tail =</span>
<a href="#l2.7"></a><span id="l2.7"> </span>
<a href="#l2.8"></a><span id="l2.8"> [test_dnsSrv.js]</span>
<a href="#l2.9"></a><span id="l2.9"> [test_parseJidAndNormalization.js]</span>
<a href="#l2.10"></a><span id="l2.10" class="difflineplus">+[test_saslPrep.js]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/chat/protocols/xmpp/xmpp-authmechs.jsm</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/chat/protocols/xmpp/xmpp-authmechs.jsm</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -9,28 +9,409 @@</span>
<a href="#l3.4"></a><span id="l3.4"> // detail of the XMPP implementation, but exporting it is valuable so that</span>
<a href="#l3.5"></a><span id="l3.5"> // add-ons can add support for more auth mechanisms easily by adding them</span>
<a href="#l3.6"></a><span id="l3.6"> // in XMPPAuthMechanisms without having to modify XMPPSession.</span>
<a href="#l3.7"></a><span id="l3.7"> </span>
<a href="#l3.8"></a><span id="l3.8"> this.EXPORTED_SYMBOLS = [&quot;XMPPAuthMechanisms&quot;];</span>
<a href="#l3.9"></a><span id="l3.9"> </span>
<a href="#l3.10"></a><span id="l3.10"> var {classes: Cc, interfaces: Ci, utils: Cu} = Components;</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+Cu.import(&quot;resource://services-crypto/utils.js&quot;);</span>
<a href="#l3.13"></a><span id="l3.13"> Cu.import(&quot;resource:///modules/xmpp-xml.jsm&quot;);</span>
<a href="#l3.14"></a><span id="l3.14"> </span>
<a href="#l3.15"></a><span id="l3.15" class="difflineminus">-/* Handle PLAIN authorization mechanism */</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineminus">-function PlainAuth(username, password, domain) {</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineminus">-  let data = &quot;\0&quot;+ username + &quot;\0&quot; + password;</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineplus">+// Handle PLAIN authorization mechanism.</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineplus">+function* PlainAuth(aUsername, aPassword, aDomain) {</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineplus">+  let data = &quot;\0&quot;+ aUsername + &quot;\0&quot; + aPassword;</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineplus">+</span>
<a href="#l3.22"></a><span id="l3.22">   // btoa for Unicode, see https://developer.mozilla.org/en-US/docs/DOM/window.btoa</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineminus">-  this._base64Data = btoa(unescape(encodeURIComponent(data)));</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineplus">+  let base64Data = btoa(unescape(encodeURIComponent(data)));</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineplus">+</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineplus">+  let stanza = yield {</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineplus">+    send: Stanza.node(&quot;auth&quot;, Stanza.NS.sasl, {mechanism: &quot;PLAIN&quot;},</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineplus">+                      base64Data),</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineplus">+    log: '&lt;auth mechanism:=&quot;PLAIN&quot;/&gt; (base64 encoded username and password not logged)'</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineplus">+  };</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineplus">+</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineplus">+  if (stanza.localName != &quot;success&quot;)</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineplus">+    throw &quot;Didn't receive the expected auth success stanza.&quot;;</span>
<a href="#l3.34"></a><span id="l3.34"> }</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineminus">-PlainAuth.prototype = {</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineminus">-  next: function(aStanza) {</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineminus">-    return {</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineminus">-      done: true,</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineminus">-      send: Stanza.node(&quot;auth&quot;, Stanza.NS.sasl, {mechanism: &quot;PLAIN&quot;},</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineminus">-                        this._base64Data),</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineminus">-      log: '&lt;auth mechanism:=&quot;PLAIN&quot;/&gt; (base64 encoded username and password not logged)'</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineminus">-    };</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineminus">-  }</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineplus">+</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineplus">+// Handle SCRAM-SHA-1 authorization mechanism.</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineplus">+const RFC3454 = {</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineplus">+  A1: &quot;\u0221|[\u0234-\u024f]|[\u02ae-\u02af]|[\u02ef-\u02ff]|\</span>
<a href="#l3.48"></a><span id="l3.48" class="difflineplus">+[\u0350-\u035f]|[\u0370-\u0373]|[\u0376-\u0379]|[\u037b-\u037d]|\</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineplus">+[\u037f-\u0383]|\u038b|\u038d|\u03a2|\u03cf|[\u03f7-\u03ff]|\u0487|\</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineplus">+\u04cf|[\u04f6-\u04f7]|[\u04fa-\u04ff]|[\u0510-\u0530]|\</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineplus">+[\u0557-\u0558]|\u0560|\u0588|[\u058b-\u0590]|\u05a2|\u05ba|\</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineplus">+[\u05c5-\u05cf]|[\u05eb-\u05ef]|[\u05f5-\u060b]|[\u060d-\u061a]|\</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineplus">+[\u061c-\u061e]|\u0620|[\u063b-\u063f]|[\u0656-\u065f]|\</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineplus">+[\u06ee-\u06ef]|\u06ff|\u070e|[\u072d-\u072f]|[\u074b-\u077f]|\</span>
<a href="#l3.55"></a><span id="l3.55" class="difflineplus">+[\u07b2-\u0900]|\u0904|[\u093a-\u093b]|[\u094e-\u094f]|\</span>
<a href="#l3.56"></a><span id="l3.56" class="difflineplus">+[\u0955-\u0957]|[\u0971-\u0980]|\u0984|[\u098d-\u098e]|\</span>
<a href="#l3.57"></a><span id="l3.57" class="difflineplus">+[\u0991-\u0992]|\u09a9|\u09b1|[\u09b3-\u09b5]|[\u09ba-\u09bb]|\u09bd|\</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineplus">+[\u09c5-\u09c6]|[\u09c9-\u09ca]|[\u09ce-\u09d6]|[\u09d8-\u09db]|\</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineplus">+\u09de|[\u09e4-\u09e5]|[\u09fb-\u0a01]|[\u0a03-\u0a04]|\</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineplus">+[\u0a0b-\u0a0e]|[\u0a11-\u0a12]|\u0a29|\u0a31|\u0a34|\u0a37|\</span>
<a href="#l3.61"></a><span id="l3.61" class="difflineplus">+[\u0a3a-\u0a3b]|\u0a3d|[\u0a43-\u0a46]|[\u0a49-\u0a4a]|\</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineplus">+[\u0a4e-\u0a58]|\u0a5d|[\u0a5f-\u0a65]|[\u0a75-\u0a80]|\u0a84|\u0a8c|\</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineplus">+\u0a8e|\u0a92|\u0aa9|\u0ab1|\u0ab4|[\u0aba-\u0abb]|\u0ac6|\u0aca|\</span>
<a href="#l3.64"></a><span id="l3.64" class="difflineplus">+[\u0ace-\u0acf]|[\u0ad1-\u0adf]|[\u0ae1-\u0ae5]|[\u0af0-\u0b00]|\</span>
<a href="#l3.65"></a><span id="l3.65" class="difflineplus">+\u0b04|[\u0b0d-\u0b0e]|[\u0b11-\u0b12]|\u0b29|\u0b31|[\u0b34-\u0b35]|\</span>
<a href="#l3.66"></a><span id="l3.66" class="difflineplus">+[\u0b3a-\u0b3b]|[\u0b44-\u0b46]|[\u0b49-\u0b4a]|[\u0b4e-\u0b55]|\</span>
<a href="#l3.67"></a><span id="l3.67" class="difflineplus">+[\u0b58-\u0b5b]|\u0b5e|[\u0b62-\u0b65]|[\u0b71-\u0b81]|\u0b84|\</span>
<a href="#l3.68"></a><span id="l3.68" class="difflineplus">+[\u0b8b-\u0b8d]|\u0b91|[\u0b96-\u0b98]|\u0b9b|\u0b9d|[\u0ba0-\u0ba2]|\</span>
<a href="#l3.69"></a><span id="l3.69" class="difflineplus">+[\u0ba5-\u0ba7]|[\u0bab-\u0bad]|\u0bb6|[\u0bba-\u0bbd]|\</span>
<a href="#l3.70"></a><span id="l3.70" class="difflineplus">+[\u0bc3-\u0bc5]|\u0bc9|[\u0bce-\u0bd6]|[\u0bd8-\u0be6]|\</span>
<a href="#l3.71"></a><span id="l3.71" class="difflineplus">+[\u0bf3-\u0c00]|\u0c04|\u0c0d|\u0c11|\u0c29|\u0c34|[\u0c3a-\u0c3d]|\</span>
<a href="#l3.72"></a><span id="l3.72" class="difflineplus">+\u0c45|\u0c49|[\u0c4e-\u0c54]|[\u0c57-\u0c5f]|[\u0c62-\u0c65]|\</span>
<a href="#l3.73"></a><span id="l3.73" class="difflineplus">+[\u0c70-\u0c81]|\u0c84|\u0c8d|\u0c91|\u0ca9|\u0cb4|[\u0cba-\u0cbd]|\</span>
<a href="#l3.74"></a><span id="l3.74" class="difflineplus">+\u0cc5|\u0cc9|[\u0cce-\u0cd4]|[\u0cd7-\u0cdd]|\u0cdf|[\u0ce2-\u0ce5]|\</span>
<a href="#l3.75"></a><span id="l3.75" class="difflineplus">+[\u0cf0-\u0d01]|\u0d04|\u0d0d|\u0d11|\u0d29|[\u0d3a-\u0d3d]|\</span>
<a href="#l3.76"></a><span id="l3.76" class="difflineplus">+[\u0d44-\u0d45]|\u0d49|[\u0d4e-\u0d56]|[\u0d58-\u0d5f]|\</span>
<a href="#l3.77"></a><span id="l3.77" class="difflineplus">+[\u0d62-\u0d65]|[\u0d70-\u0d81]|\u0d84|[\u0d97-\u0d99]|\u0db2|\u0dbc|\</span>
<a href="#l3.78"></a><span id="l3.78" class="difflineplus">+[\u0dbe-\u0dbf]|[\u0dc7-\u0dc9]|[\u0dcb-\u0dce]|\u0dd5|\u0dd7|\</span>
<a href="#l3.79"></a><span id="l3.79" class="difflineplus">+[\u0de0-\u0df1]|[\u0df5-\u0e00]|[\u0e3b-\u0e3e]|[\u0e5c-\u0e80]|\</span>
<a href="#l3.80"></a><span id="l3.80" class="difflineplus">+\u0e83|[\u0e85-\u0e86]|\u0e89|[\u0e8b-\u0e8c]|[\u0e8e-\u0e93]|\u0e98|\</span>
<a href="#l3.81"></a><span id="l3.81" class="difflineplus">+\u0ea0|\u0ea4|\u0ea6|[\u0ea8-\u0ea9]|\u0eac|\u0eba|[\u0ebe-\u0ebf]|\</span>
<a href="#l3.82"></a><span id="l3.82" class="difflineplus">+\u0ec5|\u0ec7|[\u0ece-\u0ecf]|[\u0eda-\u0edb]|[\u0ede-\u0eff]|\u0f48|\</span>
<a href="#l3.83"></a><span id="l3.83" class="difflineplus">+[\u0f6b-\u0f70]|[\u0f8c-\u0f8f]|\u0f98|\u0fbd|[\u0fcd-\u0fce]|\</span>
<a href="#l3.84"></a><span id="l3.84" class="difflineplus">+[\u0fd0-\u0fff]|\u1022|\u1028|\u102b|[\u1033-\u1035]|[\u103a-\u103f]|\</span>
<a href="#l3.85"></a><span id="l3.85" class="difflineplus">+[\u105a-\u109f]|[\u10c6-\u10cf]|[\u10f9-\u10fa]|[\u10fc-\u10ff]|\</span>
<a href="#l3.86"></a><span id="l3.86" class="difflineplus">+[\u115a-\u115e]|[\u11a3-\u11a7]|[\u11fa-\u11ff]|\u1207|\u1247|\u1249|\</span>
<a href="#l3.87"></a><span id="l3.87" class="difflineplus">+[\u124e-\u124f]|\u1257|\u1259|[\u125e-\u125f]|\u1287|\u1289|\</span>
<a href="#l3.88"></a><span id="l3.88" class="difflineplus">+[\u128e-\u128f]|\u12af|\u12b1|[\u12b6-\u12b7]|\u12bf|\u12c1|\</span>
<a href="#l3.89"></a><span id="l3.89" class="difflineplus">+[\u12c6-\u12c7]|\u12cf|\u12d7|\u12ef|\u130f|\u1311|[\u1316-\u1317]|\</span>
<a href="#l3.90"></a><span id="l3.90" class="difflineplus">+\u131f|\u1347|[\u135b-\u1360]|[\u137d-\u139f]|[\u13f5-\u1400]|\</span>
<a href="#l3.91"></a><span id="l3.91" class="difflineplus">+[\u1677-\u167f]|[\u169d-\u169f]|[\u16f1-\u16ff]|\u170d|\</span>
<a href="#l3.92"></a><span id="l3.92" class="difflineplus">+[\u1715-\u171f]|[\u1737-\u173f]|[\u1754-\u175f]|\u176d|\u1771|\</span>
<a href="#l3.93"></a><span id="l3.93" class="difflineplus">+[\u1774-\u177f]|[\u17dd-\u17df]|[\u17ea-\u17ff]|\u180f|\</span>
<a href="#l3.94"></a><span id="l3.94" class="difflineplus">+[\u181a-\u181f]|[\u1878-\u187f]|[\u18aa-\u1dff]|[\u1e9c-\u1e9f]|\</span>
<a href="#l3.95"></a><span id="l3.95" class="difflineplus">+[\u1efa-\u1eff]|[\u1f16-\u1f17]|[\u1f1e-\u1f1f]|[\u1f46-\u1f47]|\</span>
<a href="#l3.96"></a><span id="l3.96" class="difflineplus">+[\u1f4e-\u1f4f]|\u1f58|\u1f5a|\u1f5c|\u1f5e|[\u1f7e-\u1f7f]|\u1fb5|\</span>
<a href="#l3.97"></a><span id="l3.97" class="difflineplus">+\u1fc5|[\u1fd4-\u1fd5]|\u1fdc|[\u1ff0-\u1ff1]|\u1ff5|\u1fff|\</span>
<a href="#l3.98"></a><span id="l3.98" class="difflineplus">+[\u2053-\u2056]|[\u2058-\u205e]|[\u2064-\u2069]|[\u2072-\u2073]|\</span>
<a href="#l3.99"></a><span id="l3.99" class="difflineplus">+[\u208f-\u209f]|[\u20b2-\u20cf]|[\u20eb-\u20ff]|[\u213b-\u213c]|\</span>
<a href="#l3.100"></a><span id="l3.100" class="difflineplus">+[\u214c-\u2152]|[\u2184-\u218f]|[\u23cf-\u23ff]|[\u2427-\u243f]|\</span>
<a href="#l3.101"></a><span id="l3.101" class="difflineplus">+[\u244b-\u245f]|\u24ff|[\u2614-\u2615]|\u2618|[\u267e-\u267f]|\</span>
<a href="#l3.102"></a><span id="l3.102" class="difflineplus">+[\u268a-\u2700]|\u2705|[\u270a-\u270b]|\u2728|\u274c|\u274e|\</span>
<a href="#l3.103"></a><span id="l3.103" class="difflineplus">+[\u2753-\u2755]|\u2757|[\u275f-\u2760]|[\u2795-\u2797]|\u27b0|\</span>
<a href="#l3.104"></a><span id="l3.104" class="difflineplus">+[\u27bf-\u27cf]|[\u27ec-\u27ef]|[\u2b00-\u2e7f]|\u2e9a|\</span>
<a href="#l3.105"></a><span id="l3.105" class="difflineplus">+[\u2ef4-\u2eff]|[\u2fd6-\u2fef]|[\u2ffc-\u2fff]|\u3040|\</span>
<a href="#l3.106"></a><span id="l3.106" class="difflineplus">+[\u3097-\u3098]|[\u3100-\u3104]|[\u312d-\u3130]|\u318f|\</span>
<a href="#l3.107"></a><span id="l3.107" class="difflineplus">+[\u31b8-\u31ef]|[\u321d-\u321f]|[\u3244-\u3250]|[\u327c-\u327e]|\</span>
<a href="#l3.108"></a><span id="l3.108" class="difflineplus">+[\u32cc-\u32cf]|\u32ff|[\u3377-\u337a]|[\u33de-\u33df]|\u33ff|\</span>
<a href="#l3.109"></a><span id="l3.109" class="difflineplus">+[\u4db6-\u4dff]|[\u9fa6-\u9fff]|[\ua48d-\ua48f]|[\ua4c7-\uabff]|\</span>
<a href="#l3.110"></a><span id="l3.110" class="difflineplus">+[\ud7a4-\ud7ff]|[\ufa2e-\ufa2f]|[\ufa6b-\ufaff]|[\ufb07-\ufb12]|\</span>
<a href="#l3.111"></a><span id="l3.111" class="difflineplus">+[\ufb18-\ufb1c]|\ufb37|\ufb3d|\ufb3f|\ufb42|\ufb45|[\ufbb2-\ufbd2]|\</span>
<a href="#l3.112"></a><span id="l3.112" class="difflineplus">+[\ufd40-\ufd4f]|[\ufd90-\ufd91]|[\ufdc8-\ufdcf]|[\ufdfd-\ufdff]|\</span>
<a href="#l3.113"></a><span id="l3.113" class="difflineplus">+[\ufe10-\ufe1f]|[\ufe24-\ufe2f]|[\ufe47-\ufe48]|\ufe53|\ufe67|\</span>
<a href="#l3.114"></a><span id="l3.114" class="difflineplus">+[\ufe6c-\ufe6f]|\ufe75|[\ufefd-\ufefe]|\uff00|[\uffbf-\uffc1]|\</span>
<a href="#l3.115"></a><span id="l3.115" class="difflineplus">+[\uffc8-\uffc9]|[\uffd0-\uffd1]|[\uffd8-\uffd9]|[\uffdd-\uffdf]|\</span>
<a href="#l3.116"></a><span id="l3.116" class="difflineplus">+\uffe7|[\uffef-\ufff8]|[\u{10000}-\u{102ff}]|\u{1031f}|\</span>
<a href="#l3.117"></a><span id="l3.117" class="difflineplus">+[\u{10324}-\u{1032f}]|[\u{1034b}-\u{103ff}]|[\u{10426}-\u{10427}]|\</span>
<a href="#l3.118"></a><span id="l3.118" class="difflineplus">+[\u{1044e}-\u{1cfff}]|[\u{1d0f6}-\u{1d0ff}]|[\u{1d127}-\u{1d129}]|\</span>
<a href="#l3.119"></a><span id="l3.119" class="difflineplus">+[\u{1d1de}-\u{1d3ff}]|\u{1d455}|\u{1d49d}|[\u{1d4a0}-\u{1d4a1}]|\</span>
<a href="#l3.120"></a><span id="l3.120" class="difflineplus">+[\u{1d4a3}-\u{1d4a4}]|[\u{1d4a7}-\u{1d4a8}]|\u{1d4ad}|\u{1d4ba}|\</span>
<a href="#l3.121"></a><span id="l3.121" class="difflineplus">+\u{1d4bc}|\u{1d4c1}|\u{1d4c4}|\u{1d506}|[\u{1d50b}-\u{1d50c}]|\</span>
<a href="#l3.122"></a><span id="l3.122" class="difflineplus">+\u{1d515}|\u{1d51d}|\u{1d53a}|\u{1d53f}|\u{1d545}|\</span>
<a href="#l3.123"></a><span id="l3.123" class="difflineplus">+[\u{1d547}-\u{1d549}]|\u{1d551}|[\u{1d6a4}-\u{1d6a7}]|\</span>
<a href="#l3.124"></a><span id="l3.124" class="difflineplus">+[\u{1d7ca}-\u{1d7cd}]|[\u{1d800}-\u{1fffd}]|[\u{2a6d7}-\u{2f7ff}]|\</span>
<a href="#l3.125"></a><span id="l3.125" class="difflineplus">+[\u{2fa1e}-\u{2fffd}]|[\u{30000}-\u{3fffd}]|[\u{40000}-\u{4fffd}]|\</span>
<a href="#l3.126"></a><span id="l3.126" class="difflineplus">+[\u{50000}-\u{5fffd}]|[\u{60000}-\u{6fffd}]|[\u{70000}-\u{7fffd}]|\</span>
<a href="#l3.127"></a><span id="l3.127" class="difflineplus">+[\u{80000}-\u{8fffd}]|[\u{90000}-\u{9fffd}]|[\u{a0000}-\u{afffd}]|\</span>
<a href="#l3.128"></a><span id="l3.128" class="difflineplus">+[\u{b0000}-\u{bfffd}]|[\u{c0000}-\u{cfffd}]|[\u{d0000}-\u{dfffd}]|\</span>
<a href="#l3.129"></a><span id="l3.129" class="difflineplus">+\u{e0000}|[\u{e0002}-\u{e001f}]|[\u{e0080}-\u{efffd}]&quot;,</span>
<a href="#l3.130"></a><span id="l3.130" class="difflineplus">+  B1: &quot;\u00ad|\u034f|\u1806|[\u180b-\u180d]|[\u200b-\u200d]|\u2060|\</span>
<a href="#l3.131"></a><span id="l3.131" class="difflineplus">+[\ufe00-\ufe0f]|\ufeff&quot;,</span>
<a href="#l3.132"></a><span id="l3.132" class="difflineplus">+  C12: &quot;\u00a0|\u1680|[\u2000-\u200b]|\u202f|\u205f|\u3000&quot;,</span>
<a href="#l3.133"></a><span id="l3.133" class="difflineplus">+  C21: &quot;[\u0000-\u001f]|\u007f&quot;,</span>
<a href="#l3.134"></a><span id="l3.134" class="difflineplus">+  C22: &quot;[\u0080-\u009f]|\u06dd|\u070f|\u180e|\u200c|\u200d|\u2028|\u2029|\</span>
<a href="#l3.135"></a><span id="l3.135" class="difflineplus">+[\u2060-\u2063]|[\u206a-\u206f]|\ufeff|[\ufff9-\ufffc]&quot;,</span>
<a href="#l3.136"></a><span id="l3.136" class="difflineplus">+  C3: &quot;[\ue000-\uf8ff]|[\u{f0000}-\u{ffffd}]|[\u{100000}-\u{10fffd}]&quot;,</span>
<a href="#l3.137"></a><span id="l3.137" class="difflineplus">+  C4: &quot;[\ufdd0-\ufdef]|[\ufffe-\uffff]|[\u{1fffe}-\u{1ffff}]|\</span>
<a href="#l3.138"></a><span id="l3.138" class="difflineplus">+[\u{2fffe}-\u{2ffff}]|[\u{3fffe}-\u{3ffff}]|[\u{4fffe}-\u{4ffff}]|\</span>
<a href="#l3.139"></a><span id="l3.139" class="difflineplus">+[\u{5fffe}-\u{5ffff}]|[\u{6fffe}-\u{6ffff}]|[\u{7fffe}-\u{7ffff}]|\</span>
<a href="#l3.140"></a><span id="l3.140" class="difflineplus">+[\u{8fffe}-\u{8ffff}]|[\u{9fffe}-\u{9ffff}]|[\u{afffe}-\u{affff}]|\</span>
<a href="#l3.141"></a><span id="l3.141" class="difflineplus">+[\u{bfffe}-\u{bffff}]|[\u{cfffe}-\u{cffff}]|[\u{dfffe}-\u{dffff}]|\</span>
<a href="#l3.142"></a><span id="l3.142" class="difflineplus">+[\u{efffe}-\u{effff}]|[\u{ffffe}-\u{fffff}]|[\u{10fffe}-\u{10ffff}]&quot;,</span>
<a href="#l3.143"></a><span id="l3.143" class="difflineplus">+  C5: &quot;[\ud800-\udfff]&quot;,</span>
<a href="#l3.144"></a><span id="l3.144" class="difflineplus">+  C6: &quot;\ufff9|[\ufffa-\ufffd]&quot;,</span>
<a href="#l3.145"></a><span id="l3.145" class="difflineplus">+  C7: &quot;[\u2ff0-\u2ffb]&quot;,</span>
<a href="#l3.146"></a><span id="l3.146" class="difflineplus">+  C8: &quot;\u0340|\u0341|\u200e|\u200f|[\u202a-\u202e]|[\u206a-\u206f]&quot;,</span>
<a href="#l3.147"></a><span id="l3.147" class="difflineplus">+  C9: &quot;\u{e0001}|[\u{e0020}-\u{e007f}]&quot;,</span>
<a href="#l3.148"></a><span id="l3.148" class="difflineplus">+  D1: &quot;\u05be|\u05c0|\u05c3|[\u05d0-\u05ea]|[\u05f0-\u05f4]|\u061b|\u061f|\</span>
<a href="#l3.149"></a><span id="l3.149" class="difflineplus">+[\u0621-\u063a]|[\u0640-\u064a]|[\u066d-\u066f]|[\u0671-\u06d5]|\</span>
<a href="#l3.150"></a><span id="l3.150" class="difflineplus">+\u06dd|[\u06e5-\u06e6]|[\u06fa-\u06fe]|[\u0700-\u070d]|\u0710|\</span>
<a href="#l3.151"></a><span id="l3.151" class="difflineplus">+[\u0712-\u072c]|[\u0780-\u07a5]|\u07b1|\u200f|\ufb1d|[\ufb1f-\ufb28]|\</span>
<a href="#l3.152"></a><span id="l3.152" class="difflineplus">+[\ufb2a-\ufb36]|[\ufb38-\ufb3c]|\ufb3e|[\ufb40-\ufb41]|\</span>
<a href="#l3.153"></a><span id="l3.153" class="difflineplus">+[\ufb43-\ufb44]|[\ufb46-\ufbb1]|[\ufbd3-\ufd3d]|[\ufd50-\ufd8f]|\</span>
<a href="#l3.154"></a><span id="l3.154" class="difflineplus">+[\ufd92-\ufdc7]|[\ufdf0-\ufdfc]|[\ufe70-\ufe74]|[\ufe76-\ufefc]&quot;,</span>
<a href="#l3.155"></a><span id="l3.155" class="difflineplus">+  D2: &quot;[\u0041-\u005a]|[\u0061-\u007a]|\u00aa|\u00b5|\u00ba|[\u00c0-\u00d6]|\</span>
<a href="#l3.156"></a><span id="l3.156" class="difflineplus">+[\u00d8-\u00f6]|[\u00f8-\u0220]|[\u0222-\u0233]|[\u0250-\u02ad]|\</span>
<a href="#l3.157"></a><span id="l3.157" class="difflineplus">+[\u02b0-\u02b8]|[\u02bb-\u02c1]|[\u02d0-\u02d1]|[\u02e0-\u02e4]|\</span>
<a href="#l3.158"></a><span id="l3.158" class="difflineplus">+\u02ee|\u037a|\u0386|[\u0388-\u038a]|\u038c|[\u038e-\u03a1]|\</span>
<a href="#l3.159"></a><span id="l3.159" class="difflineplus">+[\u03a3-\u03ce]|[\u03d0-\u03f5]|[\u0400-\u0482]|[\u048a-\u04ce]|\</span>
<a href="#l3.160"></a><span id="l3.160" class="difflineplus">+[\u04d0-\u04f5]|[\u04f8-\u04f9]|[\u0500-\u050f]|[\u0531-\u0556]|\</span>
<a href="#l3.161"></a><span id="l3.161" class="difflineplus">+[\u0559-\u055f]|[\u0561-\u0587]|\u0589|\u0903|[\u0905-\u0939]|\</span>
<a href="#l3.162"></a><span id="l3.162" class="difflineplus">+[\u093d-\u0940]|[\u0949-\u094c]|\u0950|[\u0958-\u0961]|\</span>
<a href="#l3.163"></a><span id="l3.163" class="difflineplus">+[\u0964-\u0970]|[\u0982-\u0983]|[\u0985-\u098c]|[\u098f-\u0990]|\</span>
<a href="#l3.164"></a><span id="l3.164" class="difflineplus">+[\u0993-\u09a8]|[\u09aa-\u09b0]|\u09b2|[\u09b6-\u09b9]|\</span>
<a href="#l3.165"></a><span id="l3.165" class="difflineplus">+[\u09be-\u09c0]|[\u09c7-\u09c8]|[\u09cb-\u09cc]|\u09d7|\</span>
<a href="#l3.166"></a><span id="l3.166" class="difflineplus">+[\u09dc-\u09dd]|[\u09df-\u09e1]|[\u09e6-\u09f1]|[\u09f4-\u09fa]|\</span>
<a href="#l3.167"></a><span id="l3.167" class="difflineplus">+[\u0a05-\u0a0a]|[\u0a0f-\u0a10]|[\u0a13-\u0a28]|[\u0a2a-\u0a30]|\</span>
<a href="#l3.168"></a><span id="l3.168" class="difflineplus">+[\u0a32-\u0a33]|[\u0a35-\u0a36]|[\u0a38-\u0a39]|[\u0a3e-\u0a40]|\</span>
<a href="#l3.169"></a><span id="l3.169" class="difflineplus">+[\u0a59-\u0a5c]|\u0a5e|[\u0a66-\u0a6f]|[\u0a72-\u0a74]|\u0a83|\</span>
<a href="#l3.170"></a><span id="l3.170" class="difflineplus">+[\u0a85-\u0a8b]|\u0a8d|[\u0a8f-\u0a91]|[\u0a93-\u0aa8]|\</span>
<a href="#l3.171"></a><span id="l3.171" class="difflineplus">+[\u0aaa-\u0ab0]|[\u0ab2-\u0ab3]|[\u0ab5-\u0ab9]|[\u0abd-\u0ac0]|\</span>
<a href="#l3.172"></a><span id="l3.172" class="difflineplus">+\u0ac9|[\u0acb-\u0acc]|\u0ad0|\u0ae0|[\u0ae6-\u0aef]|[\u0b02-\u0b03]|\</span>
<a href="#l3.173"></a><span id="l3.173" class="difflineplus">+[\u0b05-\u0b0c]|[\u0b0f-\u0b10]|[\u0b13-\u0b28]|[\u0b2a-\u0b30]|\</span>
<a href="#l3.174"></a><span id="l3.174" class="difflineplus">+[\u0b32-\u0b33]|[\u0b36-\u0b39]|[\u0b3d-\u0b3e]|\u0b40|\</span>
<a href="#l3.175"></a><span id="l3.175" class="difflineplus">+[\u0b47-\u0b48]|[\u0b4b-\u0b4c]|\u0b57|[\u0b5c-\u0b5d]|\</span>
<a href="#l3.176"></a><span id="l3.176" class="difflineplus">+[\u0b5f-\u0b61]|[\u0b66-\u0b70]|\u0b83|[\u0b85-\u0b8a]|\</span>
<a href="#l3.177"></a><span id="l3.177" class="difflineplus">+[\u0b8e-\u0b90]|[\u0b92-\u0b95]|[\u0b99-\u0b9a]|\u0b9c|\</span>
<a href="#l3.178"></a><span id="l3.178" class="difflineplus">+[\u0b9e-\u0b9f]|[\u0ba3-\u0ba4]|[\u0ba8-\u0baa]|[\u0bae-\u0bb5]|\</span>
<a href="#l3.179"></a><span id="l3.179" class="difflineplus">+[\u0bb7-\u0bb9]|[\u0bbe-\u0bbf]|[\u0bc1-\u0bc2]|[\u0bc6-\u0bc8]|\</span>
<a href="#l3.180"></a><span id="l3.180" class="difflineplus">+[\u0bca-\u0bcc]|\u0bd7|[\u0be7-\u0bf2]|[\u0c01-\u0c03]|\</span>
<a href="#l3.181"></a><span id="l3.181" class="difflineplus">+[\u0c05-\u0c0c]|[\u0c0e-\u0c10]|[\u0c12-\u0c28]|[\u0c2a-\u0c33]|\</span>
<a href="#l3.182"></a><span id="l3.182" class="difflineplus">+[\u0c35-\u0c39]|[\u0c41-\u0c44]|[\u0c60-\u0c61]|[\u0c66-\u0c6f]|\</span>
<a href="#l3.183"></a><span id="l3.183" class="difflineplus">+[\u0c82-\u0c83]|[\u0c85-\u0c8c]|[\u0c8e-\u0c90]|[\u0c92-\u0ca8]|\</span>
<a href="#l3.184"></a><span id="l3.184" class="difflineplus">+[\u0caa-\u0cb3]|[\u0cb5-\u0cb9]|\u0cbe|[\u0cc0-\u0cc4]|\</span>
<a href="#l3.185"></a><span id="l3.185" class="difflineplus">+[\u0cc7-\u0cc8]|[\u0cca-\u0ccb]|[\u0cd5-\u0cd6]|\u0cde|\</span>
<a href="#l3.186"></a><span id="l3.186" class="difflineplus">+[\u0ce0-\u0ce1]|[\u0ce6-\u0cef]|[\u0d02-\u0d03]|[\u0d05-\u0d0c]|\</span>
<a href="#l3.187"></a><span id="l3.187" class="difflineplus">+[\u0d0e-\u0d10]|[\u0d12-\u0d28]|[\u0d2a-\u0d39]|[\u0d3e-\u0d40]|\</span>
<a href="#l3.188"></a><span id="l3.188" class="difflineplus">+[\u0d46-\u0d48]|[\u0d4a-\u0d4c]|\u0d57|[\u0d60-\u0d61]|\</span>
<a href="#l3.189"></a><span id="l3.189" class="difflineplus">+[\u0d66-\u0d6f]|[\u0d82-\u0d83]|[\u0d85-\u0d96]|[\u0d9a-\u0db1]|\</span>
<a href="#l3.190"></a><span id="l3.190" class="difflineplus">+[\u0db3-\u0dbb]|\u0dbd|[\u0dc0-\u0dc6]|[\u0dcf-\u0dd1]|\</span>
<a href="#l3.191"></a><span id="l3.191" class="difflineplus">+[\u0dd8-\u0ddf]|[\u0df2-\u0df4]|[\u0e01-\u0e30]|[\u0e32-\u0e33]|\</span>
<a href="#l3.192"></a><span id="l3.192" class="difflineplus">+[\u0e40-\u0e46]|[\u0e4f-\u0e5b]|[\u0e81-\u0e82]|\u0e84|\</span>
<a href="#l3.193"></a><span id="l3.193" class="difflineplus">+[\u0e87-\u0e88]|\u0e8a|\u0e8d|[\u0e94-\u0e97]|[\u0e99-\u0e9f]|\</span>
<a href="#l3.194"></a><span id="l3.194" class="difflineplus">+[\u0ea1-\u0ea3]|\u0ea5|\u0ea7|[\u0eaa-\u0eab]|[\u0ead-\u0eb0]|\</span>
<a href="#l3.195"></a><span id="l3.195" class="difflineplus">+[\u0eb2-\u0eb3]|\u0ebd|[\u0ec0-\u0ec4]|\u0ec6|[\u0ed0-\u0ed9]|\</span>
<a href="#l3.196"></a><span id="l3.196" class="difflineplus">+[\u0edc-\u0edd]|[\u0f00-\u0f17]|[\u0f1a-\u0f34]|\u0f36|\u0f38|\</span>
<a href="#l3.197"></a><span id="l3.197" class="difflineplus">+[\u0f3e-\u0f47]|[\u0f49-\u0f6a]|\u0f7f|\u0f85|[\u0f88-\u0f8b]|\</span>
<a href="#l3.198"></a><span id="l3.198" class="difflineplus">+[\u0fbe-\u0fc5]|[\u0fc7-\u0fcc]|\u0fcf|[\u1000-\u1021]|\</span>
<a href="#l3.199"></a><span id="l3.199" class="difflineplus">+[\u1023-\u1027]|[\u1029-\u102a]|\u102c|\u1031|\u1038|[\u1040-\u1057]|\</span>
<a href="#l3.200"></a><span id="l3.200" class="difflineplus">+[\u10a0-\u10c5]|[\u10d0-\u10f8]|\u10fb|[\u1100-\u1159]|\</span>
<a href="#l3.201"></a><span id="l3.201" class="difflineplus">+[\u115f-\u11a2]|[\u11a8-\u11f9]|[\u1200-\u1206]|[\u1208-\u1246]|\</span>
<a href="#l3.202"></a><span id="l3.202" class="difflineplus">+\u1248|[\u124a-\u124d]|[\u1250-\u1256]|\u1258|[\u125a-\u125d]|\</span>
<a href="#l3.203"></a><span id="l3.203" class="difflineplus">+[\u1260-\u1286]|\u1288|[\u128a-\u128d]|[\u1290-\u12ae]|\u12b0|\</span>
<a href="#l3.204"></a><span id="l3.204" class="difflineplus">+[\u12b2-\u12b5]|[\u12b8-\u12be]|\u12c0|[\u12c2-\u12c5]|\</span>
<a href="#l3.205"></a><span id="l3.205" class="difflineplus">+[\u12c8-\u12ce]|[\u12d0-\u12d6]|[\u12d8-\u12ee]|[\u12f0-\u130e]|\</span>
<a href="#l3.206"></a><span id="l3.206" class="difflineplus">+\u1310|[\u1312-\u1315]|[\u1318-\u131e]|[\u1320-\u1346]|\</span>
<a href="#l3.207"></a><span id="l3.207" class="difflineplus">+[\u1348-\u135a]|[\u1361-\u137c]|[\u13a0-\u13f4]|[\u1401-\u1676]|\</span>
<a href="#l3.208"></a><span id="l3.208" class="difflineplus">+[\u1681-\u169a]|[\u16a0-\u16f0]|[\u1700-\u170c]|[\u170e-\u1711]|\</span>
<a href="#l3.209"></a><span id="l3.209" class="difflineplus">+[\u1720-\u1731]|[\u1735-\u1736]|[\u1740-\u1751]|[\u1760-\u176c]|\</span>
<a href="#l3.210"></a><span id="l3.210" class="difflineplus">+[\u176e-\u1770]|[\u1780-\u17b6]|[\u17be-\u17c5]|[\u17c7-\u17c8]|\</span>
<a href="#l3.211"></a><span id="l3.211" class="difflineplus">+[\u17d4-\u17da]|\u17dc|[\u17e0-\u17e9]|[\u1810-\u1819]|\</span>
<a href="#l3.212"></a><span id="l3.212" class="difflineplus">+[\u1820-\u1877]|[\u1880-\u18a8]|[\u1e00-\u1e9b]|[\u1ea0-\u1ef9]|\</span>
<a href="#l3.213"></a><span id="l3.213" class="difflineplus">+[\u1f00-\u1f15]|[\u1f18-\u1f1d]|[\u1f20-\u1f45]|[\u1f48-\u1f4d]|\</span>
<a href="#l3.214"></a><span id="l3.214" class="difflineplus">+[\u1f50-\u1f57]|\u1f59|\u1f5b|\u1f5d|[\u1f5f-\u1f7d]|[\u1f80-\u1fb4]|\</span>
<a href="#l3.215"></a><span id="l3.215" class="difflineplus">+[\u1fb6-\u1fbc]|\u1fbe|[\u1fc2-\u1fc4]|[\u1fc6-\u1fcc]|\</span>
<a href="#l3.216"></a><span id="l3.216" class="difflineplus">+[\u1fd0-\u1fd3]|[\u1fd6-\u1fdb]|[\u1fe0-\u1fec]|[\u1ff2-\u1ff4]|\</span>
<a href="#l3.217"></a><span id="l3.217" class="difflineplus">+[\u1ff6-\u1ffc]|\u200e|\u2071|\u207f|\u2102|\u2107|[\u210a-\u2113]|\</span>
<a href="#l3.218"></a><span id="l3.218" class="difflineplus">+\u2115|[\u2119-\u211d]|\u2124|\u2126|\u2128|[\u212a-\u212d]|\</span>
<a href="#l3.219"></a><span id="l3.219" class="difflineplus">+[\u212f-\u2131]|[\u2133-\u2139]|[\u213d-\u213f]|[\u2145-\u2149]|\</span>
<a href="#l3.220"></a><span id="l3.220" class="difflineplus">+[\u2160-\u2183]|[\u2336-\u237a]|\u2395|[\u249c-\u24e9]|\</span>
<a href="#l3.221"></a><span id="l3.221" class="difflineplus">+[\u3005-\u3007]|[\u3021-\u3029]|[\u3031-\u3035]|[\u3038-\u303c]|\</span>
<a href="#l3.222"></a><span id="l3.222" class="difflineplus">+[\u3041-\u3096]|[\u309d-\u309f]|[\u30a1-\u30fa]|[\u30fc-\u30ff]|\</span>
<a href="#l3.223"></a><span id="l3.223" class="difflineplus">+[\u3105-\u312c]|[\u3131-\u318e]|[\u3190-\u31b7]|[\u31f0-\u321c]|\</span>
<a href="#l3.224"></a><span id="l3.224" class="difflineplus">+[\u3220-\u3243]|[\u3260-\u327b]|[\u327f-\u32b0]|[\u32c0-\u32cb]|\</span>
<a href="#l3.225"></a><span id="l3.225" class="difflineplus">+[\u32d0-\u32fe]|[\u3300-\u3376]|[\u337b-\u33dd]|[\u33e0-\u33fe]|\</span>
<a href="#l3.226"></a><span id="l3.226" class="difflineplus">+[\u3400-\u4db5]|[\u4e00-\u9fa5]|[\ua000-\ua48c]|[\uac00-\ud7a3]|\</span>
<a href="#l3.227"></a><span id="l3.227" class="difflineplus">+[\ud800-\ufa2d]|[\ufa30-\ufa6a]|[\ufb00-\ufb06]|[\ufb13-\ufb17]|\</span>
<a href="#l3.228"></a><span id="l3.228" class="difflineplus">+[\uff21-\uff3a]|[\uff41-\uff5a]|[\uff66-\uffbe]|[\uffc2-\uffc7]|\</span>
<a href="#l3.229"></a><span id="l3.229" class="difflineplus">+[\uffca-\uffcf]|[\uffd2-\uffd7]|[\uffda-\uffdc]|[\u{10300}-\u{1031e}]|\</span>
<a href="#l3.230"></a><span id="l3.230" class="difflineplus">+[\u{10320}-\u{10323}]|[\u{10330}-\u{1034a}]|[\u{10400}-\u{10425}]|\</span>
<a href="#l3.231"></a><span id="l3.231" class="difflineplus">+[\u{10428}-\u{1044d}]|[\u{1d000}-\u{1d0f5}]|[\u{1d100}-\u{1d126}]|\</span>
<a href="#l3.232"></a><span id="l3.232" class="difflineplus">+[\u{1d12a}-\u{1d166}]|[\u{1d16a}-\u{1d172}]|[\u{1d183}-\u{1d184}]|\</span>
<a href="#l3.233"></a><span id="l3.233" class="difflineplus">+[\u{1d18c}-\u{1d1a9}]|[\u{1d1ae}-\u{1d1dd}]|[\u{1d400}-\u{1d454}]|\</span>
<a href="#l3.234"></a><span id="l3.234" class="difflineplus">+[\u{1d456}-\u{1d49c}]|[\u{1d49e}-\u{1d49f}]|\u{1d4a2}|\</span>
<a href="#l3.235"></a><span id="l3.235" class="difflineplus">+[\u{1d4a5}-\u{1d4a6}]|[\u{1d4a9}-\u{1d4ac}]|[\u{1d4ae}-\u{1d4b9}]|\</span>
<a href="#l3.236"></a><span id="l3.236" class="difflineplus">+\u{1d4bb}|[\u{1d4bd}-\u{1d4c0}]|[\u{1d4c2}-\u{1d4c3}]|\</span>
<a href="#l3.237"></a><span id="l3.237" class="difflineplus">+[\u{1d4c5}-\u{1d505}]|[\u{1d507}-\u{1d50a}]|[\u{1d50d}-\u{1d514}]|\</span>
<a href="#l3.238"></a><span id="l3.238" class="difflineplus">+[\u{1d516}-\u{1d51c}]|[\u{1d51e}-\u{1d539}]|[\u{1d53b}-\u{1d53e}]|\</span>
<a href="#l3.239"></a><span id="l3.239" class="difflineplus">+[\u{1d540}-\u{1d544}]|\u{1d546}|[\u{1d54a}-\u{1d550}]|\</span>
<a href="#l3.240"></a><span id="l3.240" class="difflineplus">+[\u{1d552}-\u{1d6a3}]|[\u{1d6a8}-\u{1d7c9}]|[\u{20000}-\u{2a6d6}]|\</span>
<a href="#l3.241"></a><span id="l3.241" class="difflineplus">+[\u{2f800}-\u{2fa1d}]|[\u{f0000}-\u{ffffd}]|[\u{100000}-\u{10fffd}]&quot;</span>
<a href="#l3.242"></a><span id="l3.242"> };</span>
<a href="#l3.243"></a><span id="l3.243"> </span>
<a href="#l3.244"></a><span id="l3.244" class="difflineminus">-var XMPPAuthMechanisms = {&quot;PLAIN&quot;: PlainAuth};</span>
<a href="#l3.245"></a><span id="l3.245" class="difflineplus">+// Generates a random nonce and returns a base64 encoded string.</span>
<a href="#l3.246"></a><span id="l3.246" class="difflineplus">+// aLength in bytes.</span>
<a href="#l3.247"></a><span id="l3.247" class="difflineplus">+function createNonce(aLength) {</span>
<a href="#l3.248"></a><span id="l3.248" class="difflineplus">+  // RFC 5802 (5.1): Printable ASCII except &quot;,&quot;.</span>
<a href="#l3.249"></a><span id="l3.249" class="difflineplus">+  // We guarantee a vaild nonce value using base64 encoding.</span>
<a href="#l3.250"></a><span id="l3.250" class="difflineplus">+  return btoa(CryptoUtils.generateRandomBytes(aLength));</span>
<a href="#l3.251"></a><span id="l3.251" class="difflineplus">+}</span>
<a href="#l3.252"></a><span id="l3.252" class="difflineplus">+</span>
<a href="#l3.253"></a><span id="l3.253" class="difflineplus">+// Parses the string of server's response (aChallenge) into an object.</span>
<a href="#l3.254"></a><span id="l3.254" class="difflineplus">+function parseChallenge(aChallenge) {</span>
<a href="#l3.255"></a><span id="l3.255" class="difflineplus">+  let attributes = {};</span>
<a href="#l3.256"></a><span id="l3.256" class="difflineplus">+  aChallenge.split(&quot;,&quot;).forEach(value =&gt; {</span>
<a href="#l3.257"></a><span id="l3.257" class="difflineplus">+    let match =  /^(\w)=([\s\S]*)$/.exec(value);</span>
<a href="#l3.258"></a><span id="l3.258" class="difflineplus">+    if (match)</span>
<a href="#l3.259"></a><span id="l3.259" class="difflineplus">+      attributes[match[1]] = match[2];</span>
<a href="#l3.260"></a><span id="l3.260" class="difflineplus">+  });</span>
<a href="#l3.261"></a><span id="l3.261" class="difflineplus">+  return attributes;</span>
<a href="#l3.262"></a><span id="l3.262" class="difflineplus">+}</span>
<a href="#l3.263"></a><span id="l3.263" class="difflineplus">+</span>
<a href="#l3.264"></a><span id="l3.264" class="difflineplus">+// RFC 4013 and RFC 3454: Stringprep Profile for User Names and Passwords.</span>
<a href="#l3.265"></a><span id="l3.265" class="difflineplus">+function saslPrep(aString) {</span>
<a href="#l3.266"></a><span id="l3.266" class="difflineplus">+  // RFC 4013 2.1: non-ASCII space characters (RFC 3454 C.1.2) mapped to space.</span>
<a href="#l3.267"></a><span id="l3.267" class="difflineplus">+  let retVal = aString.replace(new RegExp(RFC3454.C12, &quot;u&quot;), &quot; &quot;);</span>
<a href="#l3.268"></a><span id="l3.268" class="difflineplus">+</span>
<a href="#l3.269"></a><span id="l3.269" class="difflineplus">+  // RFC 4013 2.1: RFC 3454 3.1, B.1: Map certain codepoints to nothing.</span>
<a href="#l3.270"></a><span id="l3.270" class="difflineplus">+  retVal = retVal.replace(new RegExp(RFC3454.B1, &quot;u&quot;), &quot;&quot;);</span>
<a href="#l3.271"></a><span id="l3.271" class="difflineplus">+</span>
<a href="#l3.272"></a><span id="l3.272" class="difflineplus">+  // RFC 4013 2.2 asks for Unicode normalization form KC, which corresponds to</span>
<a href="#l3.273"></a><span id="l3.273" class="difflineplus">+  // RFC 3454 B.2.</span>
<a href="#l3.274"></a><span id="l3.274" class="difflineplus">+  retVal = retVal.normalize(&quot;NFKC&quot;);</span>
<a href="#l3.275"></a><span id="l3.275" class="difflineplus">+</span>
<a href="#l3.276"></a><span id="l3.276" class="difflineplus">+  // RFC 4013 2.3: Prohibited Output and 2.5: Unassigned Code Points.</span>
<a href="#l3.277"></a><span id="l3.277" class="difflineplus">+  let matchStr =</span>
<a href="#l3.278"></a><span id="l3.278" class="difflineplus">+    RFC3454.C12 + &quot;|&quot; + RFC3454.C21 + &quot;|&quot; + RFC3454.C22 + &quot;|&quot; + RFC3454.C3 +</span>
<a href="#l3.279"></a><span id="l3.279" class="difflineplus">+    &quot;|&quot; + RFC3454.C4 + &quot;|&quot; + RFC3454.C5 + &quot;|&quot; + RFC3454.C6 + &quot;|&quot; + RFC3454.C7 +</span>
<a href="#l3.280"></a><span id="l3.280" class="difflineplus">+    &quot;|&quot; + RFC3454.C8 + &quot;|&quot; + RFC3454.C9 + &quot;|&quot; + RFC3454.A1;</span>
<a href="#l3.281"></a><span id="l3.281" class="difflineplus">+  let match = new RegExp(matchStr, &quot;u&quot;).test(retVal);</span>
<a href="#l3.282"></a><span id="l3.282" class="difflineplus">+  if (match)</span>
<a href="#l3.283"></a><span id="l3.283" class="difflineplus">+    throw &quot;String contains prohibited characters&quot;;</span>
<a href="#l3.284"></a><span id="l3.284" class="difflineplus">+</span>
<a href="#l3.285"></a><span id="l3.285" class="difflineplus">+  // RFC 4013 2.4: Bidirectional Characters.</span>
<a href="#l3.286"></a><span id="l3.286" class="difflineplus">+  let r = new RegExp(RFC3454.D1, &quot;u&quot;).test(retVal);</span>
<a href="#l3.287"></a><span id="l3.287" class="difflineplus">+  let l = new RegExp(RFC3454.D2, &quot;u&quot;).test(retVal);</span>
<a href="#l3.288"></a><span id="l3.288" class="difflineplus">+  if (l &amp;&amp; r)</span>
<a href="#l3.289"></a><span id="l3.289" class="difflineplus">+    throw &quot;String must not contain LCat and RandALCat characters together&quot;;</span>
<a href="#l3.290"></a><span id="l3.290" class="difflineplus">+  else if (r) {</span>
<a href="#l3.291"></a><span id="l3.291" class="difflineplus">+    let matchFirst = new RegExp(&quot;^(&quot; + RFC3454.D1 + &quot;)&quot;, &quot;u&quot;).test(retVal);</span>
<a href="#l3.292"></a><span id="l3.292" class="difflineplus">+    let matchLast = new RegExp(&quot;(&quot; + RFC3454.D1 + &quot;)$&quot;, &quot;u&quot;).test(retVal);</span>
<a href="#l3.293"></a><span id="l3.293" class="difflineplus">+    if (!matchFirst || !matchLast)</span>
<a href="#l3.294"></a><span id="l3.294" class="difflineplus">+      throw &quot;A RandALCat character must be the first and the last character&quot;;</span>
<a href="#l3.295"></a><span id="l3.295" class="difflineplus">+  }</span>
<a href="#l3.296"></a><span id="l3.296" class="difflineplus">+</span>
<a href="#l3.297"></a><span id="l3.297" class="difflineplus">+  return retVal;</span>
<a href="#l3.298"></a><span id="l3.298" class="difflineplus">+}</span>
<a href="#l3.299"></a><span id="l3.299" class="difflineplus">+</span>
<a href="#l3.300"></a><span id="l3.300" class="difflineplus">+// Converts aName to saslname.</span>
<a href="#l3.301"></a><span id="l3.301" class="difflineplus">+function saslName(aName) {</span>
<a href="#l3.302"></a><span id="l3.302" class="difflineplus">+  // RFC 5802 (5.1): the client SHOULD prepare the username using the &quot;SASLprep&quot;.</span>
<a href="#l3.303"></a><span id="l3.303" class="difflineplus">+  // The characters ’,’ or ’=’ in usernames are sent as ’=2C’ and</span>
<a href="#l3.304"></a><span id="l3.304" class="difflineplus">+  // ’=3D’ respectively.</span>
<a href="#l3.305"></a><span id="l3.305" class="difflineplus">+  let saslName = saslPrep(aName).replace(/=/g,&quot;=3D&quot;).replace(/,/g, &quot;=2C&quot;);</span>
<a href="#l3.306"></a><span id="l3.306" class="difflineplus">+  if (!saslName)</span>
<a href="#l3.307"></a><span id="l3.307" class="difflineplus">+    throw &quot;Name is not valid&quot;;</span>
<a href="#l3.308"></a><span id="l3.308" class="difflineplus">+</span>
<a href="#l3.309"></a><span id="l3.309" class="difflineplus">+  return saslName;</span>
<a href="#l3.310"></a><span id="l3.310" class="difflineplus">+}</span>
<a href="#l3.311"></a><span id="l3.311" class="difflineplus">+</span>
<a href="#l3.312"></a><span id="l3.312" class="difflineplus">+// Converts aMessage to array of bytes then apply SHA-1 hashing.</span>
<a href="#l3.313"></a><span id="l3.313" class="difflineplus">+function bytesAndSHA1(aMessage) {</span>
<a href="#l3.314"></a><span id="l3.314" class="difflineplus">+  let hasher =</span>
<a href="#l3.315"></a><span id="l3.315" class="difflineplus">+    Cc[&quot;@mozilla.org/security/hash;1&quot;].createInstance(Ci.nsICryptoHash);</span>
<a href="#l3.316"></a><span id="l3.316" class="difflineplus">+  hasher.init(hasher.SHA1);</span>
<a href="#l3.317"></a><span id="l3.317" class="difflineplus">+</span>
<a href="#l3.318"></a><span id="l3.318" class="difflineplus">+  return CryptoUtils.digestBytes(aMessage, hasher);</span>
<a href="#l3.319"></a><span id="l3.319" class="difflineplus">+}</span>
<a href="#l3.320"></a><span id="l3.320" class="difflineplus">+</span>
<a href="#l3.321"></a><span id="l3.321" class="difflineplus">+function* scramSHA1Auth(aUsername, aPassword, aDomain) {</span>
<a href="#l3.322"></a><span id="l3.322" class="difflineplus">+  // RFC 5802 (5): SCRAM Authentication Exchange.</span>
<a href="#l3.323"></a><span id="l3.323" class="difflineplus">+  const gs2Header = &quot;n,,&quot;;</span>
<a href="#l3.324"></a><span id="l3.324" class="difflineplus">+  let cNonce = createNonce(32);</span>
<a href="#l3.325"></a><span id="l3.325" class="difflineplus">+</span>
<a href="#l3.326"></a><span id="l3.326" class="difflineplus">+  let clientFirstMessageBare =</span>
<a href="#l3.327"></a><span id="l3.327" class="difflineplus">+    &quot;n=&quot; + saslName(aUsername) + &quot;,r=&quot; + cNonce;</span>
<a href="#l3.328"></a><span id="l3.328" class="difflineplus">+  let clientFirstMessage = gs2Header + clientFirstMessageBare;</span>
<a href="#l3.329"></a><span id="l3.329" class="difflineplus">+</span>
<a href="#l3.330"></a><span id="l3.330" class="difflineplus">+  let receivedStanza = yield {</span>
<a href="#l3.331"></a><span id="l3.331" class="difflineplus">+    send: Stanza.node(&quot;auth&quot;, Stanza.NS.sasl, {mechanism: &quot;SCRAM-SHA-1&quot;},</span>
<a href="#l3.332"></a><span id="l3.332" class="difflineplus">+                      btoa(clientFirstMessage))</span>
<a href="#l3.333"></a><span id="l3.333" class="difflineplus">+  };</span>
<a href="#l3.334"></a><span id="l3.334" class="difflineplus">+</span>
<a href="#l3.335"></a><span id="l3.335" class="difflineplus">+  if (receivedStanza.localName != &quot;challenge&quot;)</span>
<a href="#l3.336"></a><span id="l3.336" class="difflineplus">+    throw &quot;Not authorized&quot;;</span>
<a href="#l3.337"></a><span id="l3.337" class="difflineplus">+</span>
<a href="#l3.338"></a><span id="l3.338" class="difflineplus">+  // RFC 5802 (3): SCRAM Algorithm Overview.</span>
<a href="#l3.339"></a><span id="l3.339" class="difflineplus">+  let decodedChallenge = atob(receivedStanza.innerText);</span>
<a href="#l3.340"></a><span id="l3.340" class="difflineplus">+</span>
<a href="#l3.341"></a><span id="l3.341" class="difflineplus">+  // Expected to contain the user’s iteration count (i) and the user’s</span>
<a href="#l3.342"></a><span id="l3.342" class="difflineplus">+  // salt (s), and the server appends its own nonce to the client-specified</span>
<a href="#l3.343"></a><span id="l3.343" class="difflineplus">+  // one (r).</span>
<a href="#l3.344"></a><span id="l3.344" class="difflineplus">+  let attributes = parseChallenge(decodedChallenge);</span>
<a href="#l3.345"></a><span id="l3.345" class="difflineplus">+  if (attributes.hasOwnProperty(&quot;e&quot;))</span>
<a href="#l3.346"></a><span id="l3.346" class="difflineplus">+    throw &quot;Authentication failed: &quot; + attributes.e;</span>
<a href="#l3.347"></a><span id="l3.347" class="difflineplus">+  else if (!attributes.hasOwnProperty(&quot;i&quot;) ||</span>
<a href="#l3.348"></a><span id="l3.348" class="difflineplus">+           !attributes.hasOwnProperty(&quot;s&quot;) ||</span>
<a href="#l3.349"></a><span id="l3.349" class="difflineplus">+           !attributes.hasOwnProperty(&quot;r&quot;)) {</span>
<a href="#l3.350"></a><span id="l3.350" class="difflineplus">+    throw &quot;Unexpected response: &quot; + decodedChallenge;</span>
<a href="#l3.351"></a><span id="l3.351" class="difflineplus">+  }</span>
<a href="#l3.352"></a><span id="l3.352" class="difflineplus">+  if (!attributes.r.startsWith(cNonce))</span>
<a href="#l3.353"></a><span id="l3.353" class="difflineplus">+    throw &quot;Nonce is not correct&quot;;</span>
<a href="#l3.354"></a><span id="l3.354" class="difflineplus">+</span>
<a href="#l3.355"></a><span id="l3.355" class="difflineplus">+  let clientFinalMessageWithoutProof =</span>
<a href="#l3.356"></a><span id="l3.356" class="difflineplus">+    &quot;c=&quot; + btoa(gs2Header) + &quot;,r=&quot; + attributes.r;</span>
<a href="#l3.357"></a><span id="l3.357" class="difflineplus">+</span>
<a href="#l3.358"></a><span id="l3.358" class="difflineplus">+  // Calculate ClientProof.</span>
<a href="#l3.359"></a><span id="l3.359" class="difflineplus">+</span>
<a href="#l3.360"></a><span id="l3.360" class="difflineplus">+  // SaltedPassword := Hi(Normalize(password), salt, i)</span>
<a href="#l3.361"></a><span id="l3.361" class="difflineplus">+  // Normalize using saslPrep.</span>
<a href="#l3.362"></a><span id="l3.362" class="difflineplus">+  // dkLen MUST be equal to the SHA-1 digest size.</span>
<a href="#l3.363"></a><span id="l3.363" class="difflineplus">+  let saltedPassword =</span>
<a href="#l3.364"></a><span id="l3.364" class="difflineplus">+    CryptoUtils.pbkdf2Generate(saslPrep(aPassword), atob(attributes.s),</span>
<a href="#l3.365"></a><span id="l3.365" class="difflineplus">+                               parseInt(attributes.i), 20);</span>
<a href="#l3.366"></a><span id="l3.366" class="difflineplus">+</span>
<a href="#l3.367"></a><span id="l3.367" class="difflineplus">+  // ClientKey := HMAC(SaltedPassword, &quot;Client Key&quot;)</span>
<a href="#l3.368"></a><span id="l3.368" class="difflineplus">+  let saltedPasswordHasher =</span>
<a href="#l3.369"></a><span id="l3.369" class="difflineplus">+    CryptoUtils.makeHMACHasher(Ci.nsICryptoHMAC.SHA1,</span>
<a href="#l3.370"></a><span id="l3.370" class="difflineplus">+                               CryptoUtils.makeHMACKey(saltedPassword));</span>
<a href="#l3.371"></a><span id="l3.371" class="difflineplus">+  let clientKey = CryptoUtils.digestBytes(&quot;Client Key&quot;, saltedPasswordHasher);</span>
<a href="#l3.372"></a><span id="l3.372" class="difflineplus">+</span>
<a href="#l3.373"></a><span id="l3.373" class="difflineplus">+  // StoredKey := H(ClientKey)</span>
<a href="#l3.374"></a><span id="l3.374" class="difflineplus">+  let storedKey = bytesAndSHA1(clientKey);</span>
<a href="#l3.375"></a><span id="l3.375" class="difflineplus">+</span>
<a href="#l3.376"></a><span id="l3.376" class="difflineplus">+  let authMessage =</span>
<a href="#l3.377"></a><span id="l3.377" class="difflineplus">+    clientFirstMessageBare + &quot;,&quot; + decodedChallenge + &quot;,&quot; +</span>
<a href="#l3.378"></a><span id="l3.378" class="difflineplus">+    clientFinalMessageWithoutProof;</span>
<a href="#l3.379"></a><span id="l3.379" class="difflineplus">+</span>
<a href="#l3.380"></a><span id="l3.380" class="difflineplus">+  // ClientSignature := HMAC(StoredKey, AuthMessage)</span>
<a href="#l3.381"></a><span id="l3.381" class="difflineplus">+  let storedKeyHasher =</span>
<a href="#l3.382"></a><span id="l3.382" class="difflineplus">+    CryptoUtils.makeHMACHasher(Ci.nsICryptoHMAC.SHA1,</span>
<a href="#l3.383"></a><span id="l3.383" class="difflineplus">+                               CryptoUtils.makeHMACKey(storedKey));</span>
<a href="#l3.384"></a><span id="l3.384" class="difflineplus">+  let clientSignature = CryptoUtils.digestBytes(authMessage, storedKeyHasher);</span>
<a href="#l3.385"></a><span id="l3.385" class="difflineplus">+</span>
<a href="#l3.386"></a><span id="l3.386" class="difflineplus">+  // ClientProof := ClientKey XOR ClientSignature</span>
<a href="#l3.387"></a><span id="l3.387" class="difflineplus">+  let clientProof = CryptoUtils.xor(clientKey, clientSignature);</span>
<a href="#l3.388"></a><span id="l3.388" class="difflineplus">+</span>
<a href="#l3.389"></a><span id="l3.389" class="difflineplus">+  // Calculate ServerSignature.</span>
<a href="#l3.390"></a><span id="l3.390" class="difflineplus">+</span>
<a href="#l3.391"></a><span id="l3.391" class="difflineplus">+  // ServerKey := HMAC(SaltedPassword, &quot;Server Key&quot;)</span>
<a href="#l3.392"></a><span id="l3.392" class="difflineplus">+  let serverKey = CryptoUtils.digestBytes(&quot;Server Key&quot;, saltedPasswordHasher);</span>
<a href="#l3.393"></a><span id="l3.393" class="difflineplus">+</span>
<a href="#l3.394"></a><span id="l3.394" class="difflineplus">+  // ServerSignature := HMAC(ServerKey, AuthMessage)</span>
<a href="#l3.395"></a><span id="l3.395" class="difflineplus">+  let serverKeyHasher =</span>
<a href="#l3.396"></a><span id="l3.396" class="difflineplus">+    CryptoUtils.makeHMACHasher(Ci.nsICryptoHMAC.SHA1,</span>
<a href="#l3.397"></a><span id="l3.397" class="difflineplus">+                               CryptoUtils.makeHMACKey(serverKey));</span>
<a href="#l3.398"></a><span id="l3.398" class="difflineplus">+  let serverSignature = CryptoUtils.digestBytes(authMessage, serverKeyHasher);</span>
<a href="#l3.399"></a><span id="l3.399" class="difflineplus">+</span>
<a href="#l3.400"></a><span id="l3.400" class="difflineplus">+  let clientFinalMessage =</span>
<a href="#l3.401"></a><span id="l3.401" class="difflineplus">+    clientFinalMessageWithoutProof + &quot;,p=&quot; + btoa(clientProof);</span>
<a href="#l3.402"></a><span id="l3.402" class="difflineplus">+</span>
<a href="#l3.403"></a><span id="l3.403" class="difflineplus">+  receivedStanza = yield {</span>
<a href="#l3.404"></a><span id="l3.404" class="difflineplus">+    send: Stanza.node(&quot;response&quot;, Stanza.NS.sasl, null, btoa(clientFinalMessage)),</span>
<a href="#l3.405"></a><span id="l3.405" class="difflineplus">+    log: '&lt;response/&gt; (base64 encoded SCRAM response containing password not logged)'</span>
<a href="#l3.406"></a><span id="l3.406" class="difflineplus">+  };</span>
<a href="#l3.407"></a><span id="l3.407" class="difflineplus">+</span>
<a href="#l3.408"></a><span id="l3.408" class="difflineplus">+  // Only check server signature if we succeed to authenticate.</span>
<a href="#l3.409"></a><span id="l3.409" class="difflineplus">+  if (receivedStanza.localName != &quot;success&quot;)</span>
<a href="#l3.410"></a><span id="l3.410" class="difflineplus">+    throw &quot;Didn't receive the expected auth success stanza.&quot;;</span>
<a href="#l3.411"></a><span id="l3.411" class="difflineplus">+</span>
<a href="#l3.412"></a><span id="l3.412" class="difflineplus">+  let decodedResponse = atob(receivedStanza.innerText);</span>
<a href="#l3.413"></a><span id="l3.413" class="difflineplus">+</span>
<a href="#l3.414"></a><span id="l3.414" class="difflineplus">+  // Expected to contain a base64-encoded ServerSignature (v).</span>
<a href="#l3.415"></a><span id="l3.415" class="difflineplus">+  attributes = parseChallenge(decodedResponse);</span>
<a href="#l3.416"></a><span id="l3.416" class="difflineplus">+  if (!attributes.hasOwnProperty(&quot;v&quot;))</span>
<a href="#l3.417"></a><span id="l3.417" class="difflineplus">+    throw &quot;Unexpected response: &quot; + decodedResponse;</span>
<a href="#l3.418"></a><span id="l3.418" class="difflineplus">+</span>
<a href="#l3.419"></a><span id="l3.419" class="difflineplus">+  // Compare ServerSignature with our ServerSignature which we calculated in</span>
<a href="#l3.420"></a><span id="l3.420" class="difflineplus">+  // _generateResponse.</span>
<a href="#l3.421"></a><span id="l3.421" class="difflineplus">+  let serverSignatureResponse = atob(attributes.v);</span>
<a href="#l3.422"></a><span id="l3.422" class="difflineplus">+  if (serverSignature != serverSignatureResponse)</span>
<a href="#l3.423"></a><span id="l3.423" class="difflineplus">+    throw &quot;Server signature does not match&quot;;</span>
<a href="#l3.424"></a><span id="l3.424" class="difflineplus">+}</span>
<a href="#l3.425"></a><span id="l3.425" class="difflineplus">+</span>
<a href="#l3.426"></a><span id="l3.426" class="difflineplus">+var XMPPAuthMechanisms = {&quot;PLAIN&quot;: PlainAuth, &quot;SCRAM-SHA-1&quot;: scramSHA1Auth};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/chat/protocols/xmpp/xmpp-session.jsm</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/chat/protocols/xmpp/xmpp-session.jsm</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -420,59 +420,53 @@ XMPPSession.prototype = {</span>
<a href="#l4.4"></a><span id="l4.4">           return;</span>
<a href="#l4.5"></a><span id="l4.5">         }</span>
<a href="#l4.6"></a><span id="l4.6">       }</span>
<a href="#l4.7"></a><span id="l4.7">       if (!selectedMech) {</span>
<a href="#l4.8"></a><span id="l4.8">         this.onError(Ci.prplIAccount.ERROR_AUTHENTICATION_IMPOSSIBLE,</span>
<a href="#l4.9"></a><span id="l4.9">                      _(&quot;connection.error.noCompatibleAuthMec&quot;));</span>
<a href="#l4.10"></a><span id="l4.10">         return;</span>
<a href="#l4.11"></a><span id="l4.11">       }</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-      let authMec = new authMechanisms[selectedMech](this._jid.node,</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-                                                     this._password,</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineminus">-                                                     this._domain);</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+      let authMec = authMechanisms[selectedMech](this._jid.node,</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineplus">+                                                 this._password,</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineplus">+                                                 this._domain);</span>
<a href="#l4.18"></a><span id="l4.18">       this._password = null;</span>
<a href="#l4.19"></a><span id="l4.19"> </span>
<a href="#l4.20"></a><span id="l4.20">       this._account.reportConnecting(_(&quot;connection.authenticating&quot;));</span>
<a href="#l4.21"></a><span id="l4.21">       this.onXmppStanza = this.stanzaListeners.authDialog.bind(this, authMec);</span>
<a href="#l4.22"></a><span id="l4.22">       this.onXmppStanza(null); // the first auth step doesn't read anything</span>
<a href="#l4.23"></a><span id="l4.23">     },</span>
<a href="#l4.24"></a><span id="l4.24">     authDialog: function(aAuthMec, aStanza) {</span>
<a href="#l4.25"></a><span id="l4.25">       if (aStanza &amp;&amp; aStanza.localName == &quot;failure&quot;) {</span>
<a href="#l4.26"></a><span id="l4.26">         let errorMsg = &quot;authenticationFailure&quot;;</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineminus">-        if (aStanza.getElement([&quot;not-authorized&quot;]))</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineplus">+        if (aStanza.getElement([&quot;not-authorized&quot;]) ||</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineplus">+            aStanza.getElement([&quot;bad-auth&quot;])) {</span>
<a href="#l4.30"></a><span id="l4.30">           errorMsg = &quot;notAuthorized&quot;;</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineplus">+        }</span>
<a href="#l4.32"></a><span id="l4.32">         this.onError(Ci.prplIAccount.ERROR_AUTHENTICATION_FAILED,</span>
<a href="#l4.33"></a><span id="l4.33">                      _(&quot;connection.error.&quot; + errorMsg));</span>
<a href="#l4.34"></a><span id="l4.34">         return;</span>
<a href="#l4.35"></a><span id="l4.35">       }</span>
<a href="#l4.36"></a><span id="l4.36"> </span>
<a href="#l4.37"></a><span id="l4.37">       let result;</span>
<a href="#l4.38"></a><span id="l4.38">       try {</span>
<a href="#l4.39"></a><span id="l4.39">         result = aAuthMec.next(aStanza);</span>
<a href="#l4.40"></a><span id="l4.40">       } catch(e) {</span>
<a href="#l4.41"></a><span id="l4.41">         this.ERROR(e);</span>
<a href="#l4.42"></a><span id="l4.42">         this.onError(Ci.prplIAccount.ERROR_AUTHENTICATION_FAILED,</span>
<a href="#l4.43"></a><span id="l4.43">                      _(&quot;connection.error.authenticationFailure&quot;));</span>
<a href="#l4.44"></a><span id="l4.44">         return;</span>
<a href="#l4.45"></a><span id="l4.45">       }</span>
<a href="#l4.46"></a><span id="l4.46"> </span>
<a href="#l4.47"></a><span id="l4.47" class="difflineminus">-      if (result.send)</span>
<a href="#l4.48"></a><span id="l4.48" class="difflineminus">-        this.send(result.send.getXML(), result.log);</span>
<a href="#l4.49"></a><span id="l4.49" class="difflineminus">-      if (result.done)</span>
<a href="#l4.50"></a><span id="l4.50" class="difflineminus">-        this.onXmppStanza = this.stanzaListeners.authResult;</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineminus">-    },</span>
<a href="#l4.52"></a><span id="l4.52" class="difflineminus">-    authResult: function(aStanza) {</span>
<a href="#l4.53"></a><span id="l4.53" class="difflineminus">-      if (aStanza.localName != &quot;success&quot;) {</span>
<a href="#l4.54"></a><span id="l4.54" class="difflineminus">-        this.onError(Ci.prplIAccount.ERROR_AUTHENTICATION_FAILED,</span>
<a href="#l4.55"></a><span id="l4.55" class="difflineminus">-                     _(&quot;connection.error.notAuthorized&quot;));</span>
<a href="#l4.56"></a><span id="l4.56" class="difflineminus">-        return;</span>
<a href="#l4.57"></a><span id="l4.57" class="difflineplus">+      if (result.value &amp;&amp; result.value.send)</span>
<a href="#l4.58"></a><span id="l4.58" class="difflineplus">+        this.send(result.value.send.getXML(), result.value.log);</span>
<a href="#l4.59"></a><span id="l4.59" class="difflineplus">+      if (result.done) {</span>
<a href="#l4.60"></a><span id="l4.60" class="difflineplus">+        this.startStream();</span>
<a href="#l4.61"></a><span id="l4.61" class="difflineplus">+        this.onXmppStanza = this.stanzaListeners.startBind;</span>
<a href="#l4.62"></a><span id="l4.62">       }</span>
<a href="#l4.63"></a><span id="l4.63" class="difflineminus">-</span>
<a href="#l4.64"></a><span id="l4.64" class="difflineminus">-      this.startStream();</span>
<a href="#l4.65"></a><span id="l4.65" class="difflineminus">-      this.onXmppStanza = this.stanzaListeners.startBind;</span>
<a href="#l4.66"></a><span id="l4.66">     },</span>
<a href="#l4.67"></a><span id="l4.67">     startBind: function(aStanza) {</span>
<a href="#l4.68"></a><span id="l4.68">       if (!aStanza.getElement([&quot;bind&quot;])) {</span>
<a href="#l4.69"></a><span id="l4.69">         this.ERROR(&quot;Unexpected lack of the bind feature&quot;);</span>
<a href="#l4.70"></a><span id="l4.70">         this._networkError(_(&quot;connection.error.incorrectResponse&quot;));</span>
<a href="#l4.71"></a><span id="l4.71">         return;</span>
<a href="#l4.72"></a><span id="l4.72">       }</span>
<a href="#l4.73"></a><span id="l4.73"> </span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

