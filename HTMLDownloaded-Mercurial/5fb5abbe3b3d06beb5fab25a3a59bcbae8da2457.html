<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 12124:5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457" />
<meta property="og:url" content="/comm-central/rev/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457" />
<meta property="og:description" content="Bug 834757 - Remove [noscript] from nsIMimeConverter, part 1: move the encoders to a C++-only interface. r=irving, sr=Neil." />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457">shortlog</a> |
<a href="/comm-central/log/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457">files</a> |
changeset |
<a href="/comm-central/raw-rev/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457">raw</a>  | <a href="/comm-central/archive/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=834757">Bug 834757</a> - Remove [noscript] from nsIMimeConverter, part 1: move the encoders to a C++-only interface. r=irving, sr=Neil.
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#74;&#111;&#115;&#104;&#117;&#97;&#32;&#67;&#114;&#97;&#110;&#109;&#101;&#114;&#32;&#60;&#80;&#105;&#100;&#103;&#101;&#111;&#116;&#49;&#56;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Tue, 15 Jan 2013 13:16:56 -0600</td></tr>

<tr>
 <td>changeset 12124</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457">5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457</a></td>
</tr>



<tr>
<td>parent 12123</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/bbf12a153816bedd9b69294155d04599c3505e27">bbf12a153816bedd9b69294155d04599c3505e27</a>
</td>
</tr>

<tr>
<td>child 12125</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/93e89494abfdb6f7589fffc5e204c315fa87f60d">93e89494abfdb6f7589fffc5e204c315fa87f60d</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457">8999</a></td></tr>
<tr><td>push user</td><td>Pidgeot18@gmail.com</td></tr>
<tr><td>push date</td><td class="date age">Fri, 15 Mar 2013 18:19:30 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@93e89494abfd [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=93e89494abfdb6f7589fffc5e204c315fa87f60d">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=93e89494abfdb6f7589fffc5e204c315fa87f60d&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=93e89494abfdb6f7589fffc5e204c315fa87f60d&newProject=comm-central&newRevision=5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=93e89494abfdb6f7589fffc5e204c315fa87f60d&newProject=comm-central&newRevision=5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=93e89494abfdb6f7589fffc5e204c315fa87f60d&newProject=comm-central&newRevision=5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28irving%29&revcount=50">irving</a>, <a href="/comm-central/log?rev=reviewer%28Neil%29&revcount=50">Neil</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=834757">834757</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=834757">Bug 834757</a> - Remove [noscript] from nsIMimeConverter, part 1: move the encoders to a C++-only interface. r=irving, sr=Neil.</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/compose/src/Makefile.in">mailnews/compose/src/Makefile.in</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/compose/src/Makefile.in">file</a> |
<a href="/comm-central/annotate/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/compose/src/Makefile.in">annotate</a> |
<a href="/comm-central/diff/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/compose/src/Makefile.in">diff</a> |
<a href="/comm-central/comparison/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/compose/src/Makefile.in">comparison</a> |
<a href="/comm-central/log/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/compose/src/Makefile.in">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/compose/src/nsMsgAttachmentHandler.cpp">mailnews/compose/src/nsMsgAttachmentHandler.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/compose/src/nsMsgAttachmentHandler.cpp">file</a> |
<a href="/comm-central/annotate/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/compose/src/nsMsgAttachmentHandler.cpp">annotate</a> |
<a href="/comm-central/diff/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/compose/src/nsMsgAttachmentHandler.cpp">diff</a> |
<a href="/comm-central/comparison/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/compose/src/nsMsgAttachmentHandler.cpp">comparison</a> |
<a href="/comm-central/log/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/compose/src/nsMsgAttachmentHandler.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/compose/src/nsMsgAttachmentHandler.h">mailnews/compose/src/nsMsgAttachmentHandler.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/compose/src/nsMsgAttachmentHandler.h">file</a> |
<a href="/comm-central/annotate/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/compose/src/nsMsgAttachmentHandler.h">annotate</a> |
<a href="/comm-central/diff/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/compose/src/nsMsgAttachmentHandler.h">diff</a> |
<a href="/comm-central/comparison/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/compose/src/nsMsgAttachmentHandler.h">comparison</a> |
<a href="/comm-central/log/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/compose/src/nsMsgAttachmentHandler.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/compose/src/nsMsgEncoders.cpp">mailnews/compose/src/nsMsgEncoders.cpp</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/compose/src/nsMsgEncoders.cpp">diff</a> |
<a href="/comm-central/comparison/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/compose/src/nsMsgEncoders.cpp">comparison</a> |
<a href="/comm-central/log/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/compose/src/nsMsgEncoders.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/compose/src/nsMsgEncoders.h">mailnews/compose/src/nsMsgEncoders.h</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/compose/src/nsMsgEncoders.h">diff</a> |
<a href="/comm-central/comparison/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/compose/src/nsMsgEncoders.h">comparison</a> |
<a href="/comm-central/log/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/compose/src/nsMsgEncoders.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/compose/src/nsMsgSend.cpp">mailnews/compose/src/nsMsgSend.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/compose/src/nsMsgSend.cpp">file</a> |
<a href="/comm-central/annotate/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/compose/src/nsMsgSend.cpp">annotate</a> |
<a href="/comm-central/diff/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/compose/src/nsMsgSend.cpp">diff</a> |
<a href="/comm-central/comparison/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/compose/src/nsMsgSend.cpp">comparison</a> |
<a href="/comm-central/log/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/compose/src/nsMsgSend.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/compose/src/nsMsgSend.h">mailnews/compose/src/nsMsgSend.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/compose/src/nsMsgSend.h">file</a> |
<a href="/comm-central/annotate/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/compose/src/nsMsgSend.h">annotate</a> |
<a href="/comm-central/diff/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/compose/src/nsMsgSend.h">diff</a> |
<a href="/comm-central/comparison/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/compose/src/nsMsgSend.h">comparison</a> |
<a href="/comm-central/log/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/compose/src/nsMsgSend.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/compose/src/nsMsgSendPart.cpp">mailnews/compose/src/nsMsgSendPart.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/compose/src/nsMsgSendPart.cpp">file</a> |
<a href="/comm-central/annotate/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/compose/src/nsMsgSendPart.cpp">annotate</a> |
<a href="/comm-central/diff/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/compose/src/nsMsgSendPart.cpp">diff</a> |
<a href="/comm-central/comparison/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/compose/src/nsMsgSendPart.cpp">comparison</a> |
<a href="/comm-central/log/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/compose/src/nsMsgSendPart.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/compose/src/nsMsgSendPart.h">mailnews/compose/src/nsMsgSendPart.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/compose/src/nsMsgSendPart.h">file</a> |
<a href="/comm-central/annotate/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/compose/src/nsMsgSendPart.h">annotate</a> |
<a href="/comm-central/diff/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/compose/src/nsMsgSendPart.h">diff</a> |
<a href="/comm-central/comparison/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/compose/src/nsMsgSendPart.h">comparison</a> |
<a href="/comm-central/log/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/compose/src/nsMsgSendPart.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/extensions/smime/src/nsMsgComposeSecure.cpp">mailnews/extensions/smime/src/nsMsgComposeSecure.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/extensions/smime/src/nsMsgComposeSecure.cpp">file</a> |
<a href="/comm-central/annotate/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/extensions/smime/src/nsMsgComposeSecure.cpp">annotate</a> |
<a href="/comm-central/diff/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/extensions/smime/src/nsMsgComposeSecure.cpp">diff</a> |
<a href="/comm-central/comparison/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/extensions/smime/src/nsMsgComposeSecure.cpp">comparison</a> |
<a href="/comm-central/log/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/extensions/smime/src/nsMsgComposeSecure.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/extensions/smime/src/nsMsgComposeSecure.h">mailnews/extensions/smime/src/nsMsgComposeSecure.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/extensions/smime/src/nsMsgComposeSecure.h">file</a> |
<a href="/comm-central/annotate/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/extensions/smime/src/nsMsgComposeSecure.h">annotate</a> |
<a href="/comm-central/diff/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/extensions/smime/src/nsMsgComposeSecure.h">diff</a> |
<a href="/comm-central/comparison/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/extensions/smime/src/nsMsgComposeSecure.h">comparison</a> |
<a href="/comm-central/log/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/extensions/smime/src/nsMsgComposeSecure.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/mime/public/Makefile.in">mailnews/mime/public/Makefile.in</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/mime/public/Makefile.in">file</a> |
<a href="/comm-central/annotate/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/mime/public/Makefile.in">annotate</a> |
<a href="/comm-central/diff/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/mime/public/Makefile.in">diff</a> |
<a href="/comm-central/comparison/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/mime/public/Makefile.in">comparison</a> |
<a href="/comm-central/log/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/mime/public/Makefile.in">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/mime/public/MimeEncoder.h">mailnews/mime/public/MimeEncoder.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/mime/public/MimeEncoder.h">file</a> |
<a href="/comm-central/annotate/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/mime/public/MimeEncoder.h">annotate</a> |
<a href="/comm-central/diff/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/mime/public/MimeEncoder.h">diff</a> |
<a href="/comm-central/comparison/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/mime/public/MimeEncoder.h">comparison</a> |
<a href="/comm-central/log/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/mime/public/MimeEncoder.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/mime/public/nsIMimeConverter.idl">mailnews/mime/public/nsIMimeConverter.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/mime/public/nsIMimeConverter.idl">file</a> |
<a href="/comm-central/annotate/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/mime/public/nsIMimeConverter.idl">annotate</a> |
<a href="/comm-central/diff/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/mime/public/nsIMimeConverter.idl">diff</a> |
<a href="/comm-central/comparison/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/mime/public/nsIMimeConverter.idl">comparison</a> |
<a href="/comm-central/log/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/mime/public/nsIMimeConverter.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/mime/src/mimeenc.cpp">mailnews/mime/src/mimeenc.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/mime/src/mimeenc.cpp">file</a> |
<a href="/comm-central/annotate/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/mime/src/mimeenc.cpp">annotate</a> |
<a href="/comm-central/diff/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/mime/src/mimeenc.cpp">diff</a> |
<a href="/comm-central/comparison/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/mime/src/mimeenc.cpp">comparison</a> |
<a href="/comm-central/log/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/mime/src/mimeenc.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/mime/src/mimemoz2.h">mailnews/mime/src/mimemoz2.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/mime/src/mimemoz2.h">file</a> |
<a href="/comm-central/annotate/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/mime/src/mimemoz2.h">annotate</a> |
<a href="/comm-central/diff/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/mime/src/mimemoz2.h">diff</a> |
<a href="/comm-central/comparison/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/mime/src/mimemoz2.h">comparison</a> |
<a href="/comm-central/log/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/mime/src/mimemoz2.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/mime/src/mimepbuf.h">mailnews/mime/src/mimepbuf.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/mime/src/mimepbuf.h">file</a> |
<a href="/comm-central/annotate/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/mime/src/mimepbuf.h">annotate</a> |
<a href="/comm-central/diff/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/mime/src/mimepbuf.h">diff</a> |
<a href="/comm-central/comparison/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/mime/src/mimepbuf.h">comparison</a> |
<a href="/comm-central/log/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/mime/src/mimepbuf.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/mime/src/modlmime.h">mailnews/mime/src/modlmime.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/mime/src/modlmime.h">file</a> |
<a href="/comm-central/annotate/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/mime/src/modlmime.h">annotate</a> |
<a href="/comm-central/diff/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/mime/src/modlmime.h">diff</a> |
<a href="/comm-central/comparison/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/mime/src/modlmime.h">comparison</a> |
<a href="/comm-central/log/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/mime/src/modlmime.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/mime/src/modmimee.h">mailnews/mime/src/modmimee.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/mime/src/modmimee.h">file</a> |
<a href="/comm-central/annotate/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/mime/src/modmimee.h">annotate</a> |
<a href="/comm-central/diff/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/mime/src/modmimee.h">diff</a> |
<a href="/comm-central/comparison/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/mime/src/modmimee.h">comparison</a> |
<a href="/comm-central/log/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/mime/src/modmimee.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/mime/src/nsMimeConverter.cpp">mailnews/mime/src/nsMimeConverter.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/mime/src/nsMimeConverter.cpp">file</a> |
<a href="/comm-central/annotate/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/mime/src/nsMimeConverter.cpp">annotate</a> |
<a href="/comm-central/diff/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/mime/src/nsMimeConverter.cpp">diff</a> |
<a href="/comm-central/comparison/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/mime/src/nsMimeConverter.cpp">comparison</a> |
<a href="/comm-central/log/5fb5abbe3b3d06beb5fab25a3a59bcbae8da2457/mailnews/mime/src/nsMimeConverter.cpp">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/compose/src/Makefile.in</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/compose/src/Makefile.in</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -27,17 +27,16 @@ CPPSRCS		= \</span>
<a href="#l1.4"></a><span id="l1.4"> 		nsSmtpUrl.cpp \</span>
<a href="#l1.5"></a><span id="l1.5"> 		nsSmtpProtocol.cpp \</span>
<a href="#l1.6"></a><span id="l1.6"> 		nsMsgSend.cpp \</span>
<a href="#l1.7"></a><span id="l1.7"> 		nsMsgSendPart.cpp \</span>
<a href="#l1.8"></a><span id="l1.8"> 		nsMsgSendReport.cpp \</span>
<a href="#l1.9"></a><span id="l1.9"> 		nsSmtpService.cpp \</span>
<a href="#l1.10"></a><span id="l1.10"> 		nsMsgCopy.cpp \</span>
<a href="#l1.11"></a><span id="l1.11"> 		nsMsgSendLater.cpp \</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-		nsMsgEncoders.cpp \</span>
<a href="#l1.13"></a><span id="l1.13"> 		nsMsgCompUtils.cpp \</span>
<a href="#l1.14"></a><span id="l1.14"> 		nsMsgAttachment.cpp \</span>
<a href="#l1.15"></a><span id="l1.15"> 		nsMsgAttachmentHandler.cpp \</span>
<a href="#l1.16"></a><span id="l1.16"> 		nsMsgPrompts.cpp \</span>
<a href="#l1.17"></a><span id="l1.17"> 		nsMsgComposeService.cpp \</span>
<a href="#l1.18"></a><span id="l1.18"> 		nsMsgComposeParams.cpp \</span>
<a href="#l1.19"></a><span id="l1.19"> 		nsMsgComposeProgressParams.cpp \</span>
<a href="#l1.20"></a><span id="l1.20"> 		nsMsgComposeContentHandler.cpp \</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgAttachmentHandler.cpp</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgAttachmentHandler.cpp</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -7,17 +7,16 @@</span>
<a href="#l2.4"></a><span id="l2.4"> #include &quot;nsILineInputStream.h&quot;</span>
<a href="#l2.5"></a><span id="l2.5"> #include &quot;nsMsgAttachmentHandler.h&quot;</span>
<a href="#l2.6"></a><span id="l2.6"> #include &quot;prmem.h&quot;</span>
<a href="#l2.7"></a><span id="l2.7"> #include &quot;nsMsgCopy.h&quot;</span>
<a href="#l2.8"></a><span id="l2.8"> #include &quot;nsIPrefService.h&quot;</span>
<a href="#l2.9"></a><span id="l2.9"> #include &quot;nsIPrefBranch.h&quot;</span>
<a href="#l2.10"></a><span id="l2.10"> #include &quot;nsMsgSend.h&quot;</span>
<a href="#l2.11"></a><span id="l2.11"> #include &quot;nsMsgCompUtils.h&quot;</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-#include &quot;nsMsgEncoders.h&quot;</span>
<a href="#l2.13"></a><span id="l2.13"> #include &quot;nsMsgI18N.h&quot;</span>
<a href="#l2.14"></a><span id="l2.14"> #include &quot;nsURLFetcher.h&quot;</span>
<a href="#l2.15"></a><span id="l2.15"> #include &quot;nsMimeTypes.h&quot;</span>
<a href="#l2.16"></a><span id="l2.16"> #include &quot;nsMsgCompCID.h&quot;</span>
<a href="#l2.17"></a><span id="l2.17"> #include &quot;nsIMsgMessageService.h&quot;</span>
<a href="#l2.18"></a><span id="l2.18"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l2.19"></a><span id="l2.19"> #include &quot;nsMsgPrompts.h&quot;</span>
<a href="#l2.20"></a><span id="l2.20"> #include &quot;nsTextFormatter.h&quot;</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineat">@@ -29,16 +28,17 @@</span>
<a href="#l2.22"></a><span id="l2.22"> #include &quot;nsIMimeStreamConverter.h&quot;</span>
<a href="#l2.23"></a><span id="l2.23"> #include &quot;nsMsgMimeCID.h&quot;</span>
<a href="#l2.24"></a><span id="l2.24"> #include &quot;nsNetUtil.h&quot;</span>
<a href="#l2.25"></a><span id="l2.25"> #include &quot;nsNativeCharsetUtils.h&quot;</span>
<a href="#l2.26"></a><span id="l2.26"> #include &quot;nsComposeStrings.h&quot;</span>
<a href="#l2.27"></a><span id="l2.27"> #include &quot;nsIZipWriter.h&quot;</span>
<a href="#l2.28"></a><span id="l2.28"> #include &quot;nsIDirectoryEnumerator.h&quot;</span>
<a href="#l2.29"></a><span id="l2.29"> #include &quot;mozilla/Services.h&quot;</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineplus">+#include &quot;mozilla/mailnews/MimeEncoder.h&quot;</span>
<a href="#l2.31"></a><span id="l2.31"> </span>
<a href="#l2.32"></a><span id="l2.32"> ///////////////////////////////////////////////////////////////////////////</span>
<a href="#l2.33"></a><span id="l2.33"> // Mac Specific Attachment Handling for AppleDouble Encoded Files</span>
<a href="#l2.34"></a><span id="l2.34"> ///////////////////////////////////////////////////////////////////////////</span>
<a href="#l2.35"></a><span id="l2.35"> #ifdef XP_MACOSX</span>
<a href="#l2.36"></a><span id="l2.36"> </span>
<a href="#l2.37"></a><span id="l2.37"> #define AD_WORKING_BUFF_SIZE                  8192</span>
<a href="#l2.38"></a><span id="l2.38"> </span>
<a href="#l2.39"></a><span id="l2.39" class="difflineat">@@ -133,17 +133,17 @@ nsMsgAttachmentHandler::nsMsgAttachmentH</span>
<a href="#l2.40"></a><span id="l2.40">   m_have_crlf(0),</span>
<a href="#l2.41"></a><span id="l2.41">   m_prev_char_was_cr(false),</span>
<a href="#l2.42"></a><span id="l2.42">   m_current_column(0),</span>
<a href="#l2.43"></a><span id="l2.43">   m_max_column(0),</span>
<a href="#l2.44"></a><span id="l2.44">   m_lines(0),</span>
<a href="#l2.45"></a><span id="l2.45">   m_file_analyzed(false),</span>
<a href="#l2.46"></a><span id="l2.46"> </span>
<a href="#l2.47"></a><span id="l2.47">   // Mime</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineminus">-  m_encoder_data(nullptr)</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineplus">+  m_encoder(nullptr)</span>
<a href="#l2.50"></a><span id="l2.50"> {</span>
<a href="#l2.51"></a><span id="l2.51"> }</span>
<a href="#l2.52"></a><span id="l2.52"> </span>
<a href="#l2.53"></a><span id="l2.53"> nsMsgAttachmentHandler::~nsMsgAttachmentHandler()</span>
<a href="#l2.54"></a><span id="l2.54"> {</span>
<a href="#l2.55"></a><span id="l2.55">   if (mTmpFile &amp;&amp; mDeleteFile)</span>
<a href="#l2.56"></a><span id="l2.56">     mTmpFile-&gt;Remove(false);</span>
<a href="#l2.57"></a><span id="l2.57"> </span>
<a href="#l2.58"></a><span id="l2.58" class="difflineat">@@ -368,32 +368,30 @@ nsMsgAttachmentHandler::PickEncoding(con</span>
<a href="#l2.59"></a><span id="l2.59">   }</span>
<a href="#l2.60"></a><span id="l2.60"> </span>
<a href="#l2.61"></a><span id="l2.61">   // always base64 binary data.</span>
<a href="#l2.62"></a><span id="l2.62">   if (needsB64)</span>
<a href="#l2.63"></a><span id="l2.63">     m_encoding = ENCODING_BASE64;</span>
<a href="#l2.64"></a><span id="l2.64"> </span>
<a href="#l2.65"></a><span id="l2.65">   /* Now that we've picked an encoding, initialize the filter.</span>
<a href="#l2.66"></a><span id="l2.66">   */</span>
<a href="#l2.67"></a><span id="l2.67" class="difflineminus">-  NS_ASSERTION(!m_encoder_data, &quot;not-null m_encoder_data&quot;);</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineplus">+  NS_ASSERTION(!m_encoder, &quot;not-null m_encoder&quot;);</span>
<a href="#l2.69"></a><span id="l2.69">   if (m_encoding.LowerCaseEqualsLiteral(ENCODING_BASE64))</span>
<a href="#l2.70"></a><span id="l2.70">   {</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineminus">-    m_encoder_data = MIME_B64EncoderInit(mime_encoder_output_fn,</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineplus">+    m_encoder = MimeEncoder::GetBase64Encoder(mime_encoder_output_fn,</span>
<a href="#l2.73"></a><span id="l2.73">       mime_delivery_state);</span>
<a href="#l2.74"></a><span id="l2.74" class="difflineminus">-    if (!m_encoder_data) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l2.75"></a><span id="l2.75">   }</span>
<a href="#l2.76"></a><span id="l2.76">   else if (m_encoding.LowerCaseEqualsLiteral(ENCODING_QUOTED_PRINTABLE))</span>
<a href="#l2.77"></a><span id="l2.77">   {</span>
<a href="#l2.78"></a><span id="l2.78" class="difflineminus">-    m_encoder_data = MIME_QPEncoderInit(mime_encoder_output_fn,</span>
<a href="#l2.79"></a><span id="l2.79" class="difflineplus">+    m_encoder = MimeEncoder::GetQPEncoder(mime_encoder_output_fn,</span>
<a href="#l2.80"></a><span id="l2.80">       mime_delivery_state);</span>
<a href="#l2.81"></a><span id="l2.81" class="difflineminus">-    if (!m_encoder_data) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l2.82"></a><span id="l2.82">   }</span>
<a href="#l2.83"></a><span id="l2.83">   else</span>
<a href="#l2.84"></a><span id="l2.84">   {</span>
<a href="#l2.85"></a><span id="l2.85" class="difflineminus">-    m_encoder_data = 0;</span>
<a href="#l2.86"></a><span id="l2.86" class="difflineplus">+    m_encoder = nullptr;</span>
<a href="#l2.87"></a><span id="l2.87">   }</span>
<a href="#l2.88"></a><span id="l2.88"> </span>
<a href="#l2.89"></a><span id="l2.89">   /* Do some cleanup for documents with unknown content type.</span>
<a href="#l2.90"></a><span id="l2.90">     There are two issues: how they look to MIME users, and how they look to</span>
<a href="#l2.91"></a><span id="l2.91">     non-MIME users.</span>
<a href="#l2.92"></a><span id="l2.92"> </span>
<a href="#l2.93"></a><span id="l2.93">       If the user attaches a &quot;README&quot; file, which has unknown type because it</span>
<a href="#l2.94"></a><span id="l2.94">       has no extension, we still need to send it with no encoding, so that it</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgAttachmentHandler.h</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgAttachmentHandler.h</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -2,23 +2,23 @@</span>
<a href="#l3.4"></a><span id="l3.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l3.5"></a><span id="l3.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l3.6"></a><span id="l3.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l3.7"></a><span id="l3.7"> </span>
<a href="#l3.8"></a><span id="l3.8"> #ifndef _nsMsgAttachmentHandler_H_</span>
<a href="#l3.9"></a><span id="l3.9"> #define _nsMsgAttachmentHandler_H_</span>
<a href="#l3.10"></a><span id="l3.10"> </span>
<a href="#l3.11"></a><span id="l3.11"> #include &quot;nsIURL.h&quot;</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-#include &quot;nsIMimeConverter.h&quot;</span>
<a href="#l3.13"></a><span id="l3.13"> #include &quot;nsMsgCompFields.h&quot;</span>
<a href="#l3.14"></a><span id="l3.14"> #include &quot;nsIMsgStatusFeedback.h&quot;</span>
<a href="#l3.15"></a><span id="l3.15"> #include &quot;nsIChannel.h&quot;</span>
<a href="#l3.16"></a><span id="l3.16"> #include &quot;nsIMsgSend.h&quot;</span>
<a href="#l3.17"></a><span id="l3.17"> #include &quot;nsIFileStreams.h&quot;</span>
<a href="#l3.18"></a><span id="l3.18"> #include &quot;nsIStreamConverter.h&quot;</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineplus">+#include &quot;nsAutoPtr.h&quot;</span>
<a href="#l3.20"></a><span id="l3.20"> </span>
<a href="#l3.21"></a><span id="l3.21"> #ifdef XP_MACOSX</span>
<a href="#l3.22"></a><span id="l3.22"> </span>
<a href="#l3.23"></a><span id="l3.23"> #include &quot;nsMsgAppleDouble.h&quot;</span>
<a href="#l3.24"></a><span id="l3.24"> #include &quot;nsILocalFileMac.h&quot;</span>
<a href="#l3.25"></a><span id="l3.25"> </span>
<a href="#l3.26"></a><span id="l3.26"> class AppleDoubleEncodeObject</span>
<a href="#l3.27"></a><span id="l3.27"> {</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineat">@@ -46,22 +46,29 @@ class nsSimpleZipper</span>
<a href="#l3.29"></a><span id="l3.29">     </span>
<a href="#l3.30"></a><span id="l3.30">     // Recursively adds the file or folder to aZipWriter.</span>
<a href="#l3.31"></a><span id="l3.31">     static nsresult AddToZip(nsIZipWriter *aZipWriter,</span>
<a href="#l3.32"></a><span id="l3.32">                              nsIFile *aFile,</span>
<a href="#l3.33"></a><span id="l3.33">                              const nsACString &amp;aPath);</span>
<a href="#l3.34"></a><span id="l3.34"> };</span>
<a href="#l3.35"></a><span id="l3.35"> #endif  // XP_MACOSX</span>
<a href="#l3.36"></a><span id="l3.36"> </span>
<a href="#l3.37"></a><span id="l3.37" class="difflineplus">+namespace mozilla {</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineplus">+namespace mailnews {</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineplus">+class MimeEncoder;</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineplus">+}</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineplus">+}</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineplus">+</span>
<a href="#l3.43"></a><span id="l3.43"> //</span>
<a href="#l3.44"></a><span id="l3.44"> // This is a class that deals with processing remote attachments. It implements</span>
<a href="#l3.45"></a><span id="l3.45"> // an nsIStreamListener interface to deal with incoming data</span>
<a href="#l3.46"></a><span id="l3.46"> //</span>
<a href="#l3.47"></a><span id="l3.47"> class nsMsgAttachmentHandler</span>
<a href="#l3.48"></a><span id="l3.48"> {</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineplus">+  typedef mozilla::mailnews::MimeEncoder MimeEncoder;</span>
<a href="#l3.50"></a><span id="l3.50"> public:</span>
<a href="#l3.51"></a><span id="l3.51">   nsMsgAttachmentHandler();</span>
<a href="#l3.52"></a><span id="l3.52">   ~nsMsgAttachmentHandler();</span>
<a href="#l3.53"></a><span id="l3.53"> public:</span>
<a href="#l3.54"></a><span id="l3.54">   nsresult              SnarfAttachment(nsMsgCompFields *compFields);</span>
<a href="#l3.55"></a><span id="l3.55">   nsresult              PickEncoding(const char *charset, nsIMsgSend* mime_delivery_state);</span>
<a href="#l3.56"></a><span id="l3.56">   nsresult              PickCharset();</span>
<a href="#l3.57"></a><span id="l3.57">   void                  AnalyzeSnarfedFile ();      // Analyze a previously-snarfed file.</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineat">@@ -162,17 +169,17 @@ public:</span>
<a href="#l3.59"></a><span id="l3.59">   uint32_t              m_null_count;</span>
<a href="#l3.60"></a><span id="l3.60">   uint8_t               m_have_cr, m_have_lf, m_have_crlf; </span>
<a href="#l3.61"></a><span id="l3.61">   bool                  m_prev_char_was_cr;</span>
<a href="#l3.62"></a><span id="l3.62">   uint32_t              m_current_column;</span>
<a href="#l3.63"></a><span id="l3.63">   uint32_t              m_max_column;</span>
<a href="#l3.64"></a><span id="l3.64">   uint32_t              m_lines;</span>
<a href="#l3.65"></a><span id="l3.65">   bool                  m_file_analyzed;</span>
<a href="#l3.66"></a><span id="l3.66"> </span>
<a href="#l3.67"></a><span id="l3.67" class="difflineminus">-  MimeEncoderData       *m_encoder_data;  /* Opaque state for base64/qp encoder. */</span>
<a href="#l3.68"></a><span id="l3.68" class="difflineplus">+  nsAutoPtr&lt;MimeEncoder&gt; m_encoder;</span>
<a href="#l3.69"></a><span id="l3.69">   nsCString             m_uri; // original uri string</span>
<a href="#l3.70"></a><span id="l3.70"> </span>
<a href="#l3.71"></a><span id="l3.71">   nsresult              GetMimeDeliveryState(nsIMsgSend** _retval);</span>
<a href="#l3.72"></a><span id="l3.72">   nsresult              SetMimeDeliveryState(nsIMsgSend* mime_delivery_state);</span>
<a href="#l3.73"></a><span id="l3.73"> private:</span>
<a href="#l3.74"></a><span id="l3.74">   nsCOMPtr&lt;nsIMsgSend&gt;  m_mime_delivery_state;</span>
<a href="#l3.75"></a><span id="l3.75">   nsCOMPtr&lt;nsIStreamConverter&gt; m_mime_parser;</span>
<a href="#l3.76"></a><span id="l3.76">   nsCOMPtr&lt;nsIChannel&gt;  m_converter_channel;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1">deleted file mode 100644</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineminus">--- a/mailnews/compose/src/nsMsgEncoders.cpp</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineplus">+++ /dev/null</span>
<a href="#l4.4"></a><span id="l4.4" class="difflineat">@@ -1,55 +0,0 @@</span>
<a href="#l4.5"></a><span id="l4.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l4.6"></a><span id="l4.6" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l4.7"></a><span id="l4.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l4.8"></a><span id="l4.8" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l4.9"></a><span id="l4.9" class="difflineminus">-#include &quot;prprf.h&quot;</span>
<a href="#l4.10"></a><span id="l4.10" class="difflineminus">-#include &quot;prmem.h&quot;</span>
<a href="#l4.11"></a><span id="l4.11" class="difflineminus">-#include &quot;nsCOMPtr.h&quot;</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-#include &quot;nsIStringBundle.h&quot;</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-#include &quot;nsIServiceManager.h&quot;</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineminus">-#include &quot;nsMsgMimeCID.h&quot;</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineminus">-#include &quot;nsIMimeConverter.h&quot;</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineminus">-#include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineminus">-</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineminus">-extern &quot;C&quot; MimeEncoderData *</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineminus">-MIME_B64EncoderInit(MimeConverterOutputCallback output_fn, void *closure)</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineminus">-{</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineminus">-  MimeEncoderData *returnEncoderData = nullptr;</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineminus">-  nsCOMPtr&lt;nsIMimeConverter&gt; converter = do_GetService(NS_MIME_CONVERTER_CONTRACTID);</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineminus">-  NS_ENSURE_TRUE(converter, nullptr);</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineminus">-</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineminus">-  nsresult res = converter-&gt;B64EncoderInit(output_fn, closure, &amp;returnEncoderData);</span>
<a href="#l4.26"></a><span id="l4.26" class="difflineminus">-  return NS_SUCCEEDED(res) ? returnEncoderData : nullptr;</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineminus">-}</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineminus">-</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineminus">-extern &quot;C&quot; MimeEncoderData *</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineminus">-MIME_QPEncoderInit(MimeConverterOutputCallback output_fn, void *closure)</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineminus">-{</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineminus">-  MimeEncoderData *returnEncoderData = nullptr;</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineminus">-  nsCOMPtr&lt;nsIMimeConverter&gt; converter = do_GetService(NS_MIME_CONVERTER_CONTRACTID);</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineminus">-  NS_ENSURE_TRUE(converter, nullptr);</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineminus">-</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineminus">-  nsresult res = converter-&gt;QPEncoderInit(output_fn, closure, &amp;returnEncoderData);</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineminus">-  return NS_SUCCEEDED(res) ? returnEncoderData : nullptr;</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineminus">-}</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineminus">-</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineminus">-extern &quot;C&quot; nsresult</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineminus">-MIME_EncoderDestroy(MimeEncoderData *data, bool abort_p)</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineminus">-{</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineminus">-  nsresult rv;</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineminus">-  nsCOMPtr&lt;nsIMimeConverter&gt; converter = do_GetService(NS_MIME_CONVERTER_CONTRACTID, &amp;rv);</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.46"></a><span id="l4.46" class="difflineminus">-</span>
<a href="#l4.47"></a><span id="l4.47" class="difflineminus">-  return converter-&gt;EncoderDestroy(data, abort_p);</span>
<a href="#l4.48"></a><span id="l4.48" class="difflineminus">-}</span>
<a href="#l4.49"></a><span id="l4.49" class="difflineminus">-</span>
<a href="#l4.50"></a><span id="l4.50" class="difflineminus">-extern &quot;C&quot; nsresult</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineminus">-MIME_EncoderWrite(MimeEncoderData *data, const char *buffer, int32_t size)</span>
<a href="#l4.52"></a><span id="l4.52" class="difflineminus">-{</span>
<a href="#l4.53"></a><span id="l4.53" class="difflineminus">-  nsresult rv;</span>
<a href="#l4.54"></a><span id="l4.54" class="difflineminus">-  nsCOMPtr&lt;nsIMimeConverter&gt; converter = do_GetService(NS_MIME_CONVERTER_CONTRACTID, &amp;rv);</span>
<a href="#l4.55"></a><span id="l4.55" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.56"></a><span id="l4.56" class="difflineminus">-</span>
<a href="#l4.57"></a><span id="l4.57" class="difflineminus">-  int32_t written = 0;</span>
<a href="#l4.58"></a><span id="l4.58" class="difflineminus">-  return converter-&gt;EncoderWrite(data, buffer, size, &amp;written);</span>
<a href="#l4.59"></a><span id="l4.59" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1">deleted file mode 100644</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineminus">--- a/mailnews/compose/src/nsMsgEncoders.h</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineplus">+++ /dev/null</span>
<a href="#l5.4"></a><span id="l5.4" class="difflineat">@@ -1,24 +0,0 @@</span>
<a href="#l5.5"></a><span id="l5.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l5.6"></a><span id="l5.6" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l5.7"></a><span id="l5.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l5.8"></a><span id="l5.8" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l5.9"></a><span id="l5.9" class="difflineminus">-</span>
<a href="#l5.10"></a><span id="l5.10" class="difflineminus">-#ifndef _nsMsgEncoders_H_</span>
<a href="#l5.11"></a><span id="l5.11" class="difflineminus">-#define _nsMsgEncoders_H_</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineminus">-extern &quot;C&quot; MimeEncoderData *</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineminus">-MIME_B64EncoderInit(nsresult (*output_fn) (const char *buf, int32_t size, void *closure), void *closure); </span>
<a href="#l5.15"></a><span id="l5.15" class="difflineminus">-</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineminus">-extern &quot;C&quot; MimeEncoderData *	</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineminus">-MIME_QPEncoderInit(nsresult (*output_fn) (const char *buf, int32_t size, void *closure), void *closure);</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineminus">-</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineminus">-extern &quot;C&quot; MimeEncoderData *	</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineminus">-MIME_UUEncoderInit(char *filename, nsresult (*output_fn) (const char *buf, int32_t size, void *closure), void *closure);</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineminus">-</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineminus">-extern &quot;C&quot; nsresult</span>
<a href="#l5.23"></a><span id="l5.23" class="difflineminus">-MIME_EncoderDestroy(MimeEncoderData *data, bool abort_p);</span>
<a href="#l5.24"></a><span id="l5.24" class="difflineminus">-</span>
<a href="#l5.25"></a><span id="l5.25" class="difflineminus">-extern &quot;C&quot; nsresult</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineminus">-MIME_EncoderWrite(MimeEncoderData *data, const char *buffer, int32_t size);</span>
<a href="#l5.27"></a><span id="l5.27" class="difflineminus">-</span>
<a href="#l5.28"></a><span id="l5.28" class="difflineminus">-#endif /* _nsMsgEncoders_H_ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgSend.cpp</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgSend.cpp</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -11,17 +11,16 @@</span>
<a href="#l6.4"></a><span id="l6.4"> #include &quot;nsIMsgHeaderParser.h&quot;</span>
<a href="#l6.5"></a><span id="l6.5"> #include &quot;nsISmtpService.h&quot;  // for actually sending the message...</span>
<a href="#l6.6"></a><span id="l6.6"> #include &quot;nsINntpService.h&quot;  // for actually posting the message...</span>
<a href="#l6.7"></a><span id="l6.7"> #include &quot;nsIMsgMailSession.h&quot;</span>
<a href="#l6.8"></a><span id="l6.8"> #include &quot;nsIMsgIdentity.h&quot;</span>
<a href="#l6.9"></a><span id="l6.9"> #include &quot;nsIPrefService.h&quot;</span>
<a href="#l6.10"></a><span id="l6.10"> #include &quot;nsIPrefBranch.h&quot;</span>
<a href="#l6.11"></a><span id="l6.11"> #include &quot;nsIMsgMailNewsUrl.h&quot;</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-#include &quot;nsMsgEncoders.h&quot;</span>
<a href="#l6.13"></a><span id="l6.13"> #include &quot;nsMsgCompUtils.h&quot;</span>
<a href="#l6.14"></a><span id="l6.14"> #include &quot;nsMsgI18N.h&quot;</span>
<a href="#l6.15"></a><span id="l6.15"> #include &quot;nsICharsetConverterManager.h&quot;</span>
<a href="#l6.16"></a><span id="l6.16"> #include &quot;nsIMsgSendListener.h&quot;</span>
<a href="#l6.17"></a><span id="l6.17"> #include &quot;nsIMsgCopyServiceListener.h&quot;</span>
<a href="#l6.18"></a><span id="l6.18"> #include &quot;nsIFile.h&quot;</span>
<a href="#l6.19"></a><span id="l6.19"> #include &quot;nsIURL.h&quot;</span>
<a href="#l6.20"></a><span id="l6.20"> #include &quot;nsNetUtil.h&quot;</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineat">@@ -71,16 +70,17 @@</span>
<a href="#l6.22"></a><span id="l6.22"> #include &quot;nsIMsgHdr.h&quot;</span>
<a href="#l6.23"></a><span id="l6.23"> #include &quot;nsIMsgFolder.h&quot;</span>
<a href="#l6.24"></a><span id="l6.24"> #include &quot;nsComposeStrings.h&quot;</span>
<a href="#l6.25"></a><span id="l6.25"> #include &quot;nsStringGlue.h&quot;</span>
<a href="#l6.26"></a><span id="l6.26"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l6.27"></a><span id="l6.27"> #include &quot;nsIArray.h&quot;</span>
<a href="#l6.28"></a><span id="l6.28"> #include &quot;nsArrayUtils.h&quot;</span>
<a href="#l6.29"></a><span id="l6.29"> #include &quot;mozilla/Services.h&quot;</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineplus">+#include &quot;mozilla/mailnews/MimeEncoder.h&quot;</span>
<a href="#l6.31"></a><span id="l6.31"> </span>
<a href="#l6.32"></a><span id="l6.32"> static NS_DEFINE_CID(kRDFServiceCID, NS_RDFSERVICE_CID);</span>
<a href="#l6.33"></a><span id="l6.33"> </span>
<a href="#l6.34"></a><span id="l6.34"> #define PREF_MAIL_SEND_STRUCT &quot;mail.send_struct&quot;</span>
<a href="#l6.35"></a><span id="l6.35"> #define PREF_MAIL_STRICTLY_MIME &quot;mail.strictly_mime&quot;</span>
<a href="#l6.36"></a><span id="l6.36"> #define PREF_MAIL_MESSAGE_WARNING_SIZE &quot;mailnews.message_warning_size&quot;</span>
<a href="#l6.37"></a><span id="l6.37"> #define PREF_MAIL_COLLECT_EMAIL_ADDRESS_OUTGOING &quot;mail.collect_email_address_outgoing&quot;</span>
<a href="#l6.38"></a><span id="l6.38"> #define PREF_MAIL_DONT_ATTACH_SOURCE &quot;mail.compose.dont_attach_source_of_local_network_links&quot;</span>
<a href="#l6.39"></a><span id="l6.39" class="difflineat">@@ -260,17 +260,16 @@ nsMsgComposeAndSend::nsMsgComposeAndSend</span>
<a href="#l6.40"></a><span id="l6.40">   m_dont_deliver_p = false;</span>
<a href="#l6.41"></a><span id="l6.41">   m_deliver_mode = nsMsgDeliverNow;</span>
<a href="#l6.42"></a><span id="l6.42"> </span>
<a href="#l6.43"></a><span id="l6.43">   m_pre_snarfed_attachments_p = false;</span>
<a href="#l6.44"></a><span id="l6.44">   m_digest_p = false;</span>
<a href="#l6.45"></a><span id="l6.45">   m_be_synchronous_p = false;</span>
<a href="#l6.46"></a><span id="l6.46">   m_attachment1_type = 0;</span>
<a href="#l6.47"></a><span id="l6.47">   m_attachment1_encoding = 0;</span>
<a href="#l6.48"></a><span id="l6.48" class="difflineminus">-  m_attachment1_encoder_data = nullptr;</span>
<a href="#l6.49"></a><span id="l6.49">   m_attachment1_body = 0;</span>
<a href="#l6.50"></a><span id="l6.50">   m_attachment1_body_length = 0;</span>
<a href="#l6.51"></a><span id="l6.51">   m_attachment_count = 0;</span>
<a href="#l6.52"></a><span id="l6.52">   m_attachment_pending_count = 0;</span>
<a href="#l6.53"></a><span id="l6.53">   m_attachments = nullptr;</span>
<a href="#l6.54"></a><span id="l6.54">   m_status = NS_OK;</span>
<a href="#l6.55"></a><span id="l6.55">   m_plaintext = nullptr;</span>
<a href="#l6.56"></a><span id="l6.56">   m_related_part = nullptr;</span>
<a href="#l6.57"></a><span id="l6.57" class="difflineat">@@ -290,19 +289,16 @@ nsMsgComposeAndSend::nsMsgComposeAndSend</span>
<a href="#l6.58"></a><span id="l6.58"> </span>
<a href="#l6.59"></a><span id="l6.59"> nsMsgComposeAndSend::~nsMsgComposeAndSend()</span>
<a href="#l6.60"></a><span id="l6.60"> {</span>
<a href="#l6.61"></a><span id="l6.61">   PR_Free(m_attachment1_type);</span>
<a href="#l6.62"></a><span id="l6.62">   PR_Free(m_attachment1_encoding);</span>
<a href="#l6.63"></a><span id="l6.63">   PR_Free(m_attachment1_body);</span>
<a href="#l6.64"></a><span id="l6.64">   PR_Free(mOriginalHTMLBody);</span>
<a href="#l6.65"></a><span id="l6.65"> </span>
<a href="#l6.66"></a><span id="l6.66" class="difflineminus">-  if (m_attachment1_encoder_data)</span>
<a href="#l6.67"></a><span id="l6.67" class="difflineminus">-    MIME_EncoderDestroy(m_attachment1_encoder_data, true);</span>
<a href="#l6.68"></a><span id="l6.68" class="difflineminus">-</span>
<a href="#l6.69"></a><span id="l6.69">   if (m_plaintext)</span>
<a href="#l6.70"></a><span id="l6.70">   {</span>
<a href="#l6.71"></a><span id="l6.71">     if (m_plaintext-&gt;mTmpFile)</span>
<a href="#l6.72"></a><span id="l6.72">       m_plaintext-&gt;mTmpFile-&gt;Remove(false);</span>
<a href="#l6.73"></a><span id="l6.73"> </span>
<a href="#l6.74"></a><span id="l6.74">     delete m_plaintext;</span>
<a href="#l6.75"></a><span id="l6.75">   }</span>
<a href="#l6.76"></a><span id="l6.76"> </span>
<a href="#l6.77"></a><span id="l6.77" class="difflineat">@@ -315,23 +311,16 @@ nsMsgComposeAndSend::~nsMsgComposeAndSen</span>
<a href="#l6.78"></a><span id="l6.78">   if (mCopyFile2)</span>
<a href="#l6.79"></a><span id="l6.79">     mCopyFile2-&gt;Remove(false);</span>
<a href="#l6.80"></a><span id="l6.80"> </span>
<a href="#l6.81"></a><span id="l6.81">   if (mTempFile &amp;&amp; !mReturnFile)</span>
<a href="#l6.82"></a><span id="l6.82">     mTempFile-&gt;Remove(false);</span>
<a href="#l6.83"></a><span id="l6.83"> </span>
<a href="#l6.84"></a><span id="l6.84">   if (m_attachments)</span>
<a href="#l6.85"></a><span id="l6.85">   {</span>
<a href="#l6.86"></a><span id="l6.86" class="difflineminus">-    uint32_t i;</span>
<a href="#l6.87"></a><span id="l6.87" class="difflineminus">-    for (i = 0; i &lt; m_attachment_count; i++)</span>
<a href="#l6.88"></a><span id="l6.88" class="difflineminus">-    {</span>
<a href="#l6.89"></a><span id="l6.89" class="difflineminus">-      if (m_attachments [i].m_encoder_data)</span>
<a href="#l6.90"></a><span id="l6.90" class="difflineminus">-        MIME_EncoderDestroy(m_attachments[i].m_encoder_data, true);</span>
<a href="#l6.91"></a><span id="l6.91" class="difflineminus">-    }</span>
<a href="#l6.92"></a><span id="l6.92" class="difflineminus">-</span>
<a href="#l6.93"></a><span id="l6.93">     delete[] m_attachments;</span>
<a href="#l6.94"></a><span id="l6.94">   }</span>
<a href="#l6.95"></a><span id="l6.95"> }</span>
<a href="#l6.96"></a><span id="l6.96"> </span>
<a href="#l6.97"></a><span id="l6.97"> NS_IMETHODIMP nsMsgComposeAndSend::GetDefaultPrompt(nsIPrompt ** aPrompt)</span>
<a href="#l6.98"></a><span id="l6.98"> {</span>
<a href="#l6.99"></a><span id="l6.99">   NS_ENSURE_ARG(aPrompt);</span>
<a href="#l6.100"></a><span id="l6.100">   *aPrompt = nullptr;</span>
<a href="#l6.101"></a><span id="l6.101" class="difflineat">@@ -724,33 +713,23 @@ nsMsgComposeAndSend::GatherMimeAttachmen</span>
<a href="#l6.102"></a><span id="l6.102">       // Create the encoder for the plaintext part here,</span>
<a href="#l6.103"></a><span id="l6.103">       // because we aren't the main part (attachment1).</span>
<a href="#l6.104"></a><span id="l6.104">       // (This, along with the rest of the routine, should really</span>
<a href="#l6.105"></a><span id="l6.105">       // be restructured so that no special treatment is given to</span>
<a href="#l6.106"></a><span id="l6.106">       // the main body text that came in. Best to put attachment1_text</span>
<a href="#l6.107"></a><span id="l6.107">       // etc. into a nsMsgSendPart, then reshuffle the parts. Sigh.)</span>
<a href="#l6.108"></a><span id="l6.108">       if (m_plaintext-&gt;m_encoding.LowerCaseEqualsLiteral(ENCODING_QUOTED_PRINTABLE))</span>
<a href="#l6.109"></a><span id="l6.109">       {</span>
<a href="#l6.110"></a><span id="l6.110" class="difflineminus">-        MimeEncoderData *plaintext_enc = MIME_QPEncoderInit(mime_encoder_output_fn, this);</span>
<a href="#l6.111"></a><span id="l6.111" class="difflineminus">-        if (!plaintext_enc)</span>
<a href="#l6.112"></a><span id="l6.112" class="difflineminus">-        {</span>
<a href="#l6.113"></a><span id="l6.113" class="difflineminus">-          status = NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l6.114"></a><span id="l6.114" class="difflineminus">-          goto FAIL;</span>
<a href="#l6.115"></a><span id="l6.115" class="difflineminus">-        }</span>
<a href="#l6.116"></a><span id="l6.116" class="difflineminus">-        plainpart-&gt;SetEncoderData(plaintext_enc);</span>
<a href="#l6.117"></a><span id="l6.117" class="difflineplus">+        plainpart-&gt;SetEncoder(MimeEncoder::GetQPEncoder(</span>
<a href="#l6.118"></a><span id="l6.118" class="difflineplus">+          mime_encoder_output_fn, this));</span>
<a href="#l6.119"></a><span id="l6.119">       }</span>
<a href="#l6.120"></a><span id="l6.120">       else if (m_plaintext-&gt;m_encoding.LowerCaseEqualsLiteral(ENCODING_BASE64))</span>
<a href="#l6.121"></a><span id="l6.121">       {</span>
<a href="#l6.122"></a><span id="l6.122" class="difflineminus">-        MimeEncoderData *plaintext_enc = MIME_B64EncoderInit(mime_encoder_output_fn, this);</span>
<a href="#l6.123"></a><span id="l6.123" class="difflineminus">-        if (!plaintext_enc)</span>
<a href="#l6.124"></a><span id="l6.124" class="difflineminus">-        {</span>
<a href="#l6.125"></a><span id="l6.125" class="difflineminus">-          status = NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l6.126"></a><span id="l6.126" class="difflineminus">-          goto FAIL;</span>
<a href="#l6.127"></a><span id="l6.127" class="difflineminus">-        }</span>
<a href="#l6.128"></a><span id="l6.128" class="difflineminus">-        plainpart-&gt;SetEncoderData(plaintext_enc);</span>
<a href="#l6.129"></a><span id="l6.129" class="difflineplus">+        plainpart-&gt;SetEncoder(MimeEncoder::GetBase64Encoder(</span>
<a href="#l6.130"></a><span id="l6.130" class="difflineplus">+          mime_encoder_output_fn, this));</span>
<a href="#l6.131"></a><span id="l6.131">       }</span>
<a href="#l6.132"></a><span id="l6.132">     }</span>
<a href="#l6.133"></a><span id="l6.133">     else</span>
<a href="#l6.134"></a><span id="l6.134">     {</span>
<a href="#l6.135"></a><span id="l6.135">       delete maincontainer;</span>
<a href="#l6.136"></a><span id="l6.136">       if (maincontainerISrelatedpart)</span>
<a href="#l6.137"></a><span id="l6.137">         m_related_part = nullptr; // in that case, m_related_part == maincontainer which we have just deleted!</span>
<a href="#l6.138"></a><span id="l6.138">       maincontainer = plainpart;</span>
<a href="#l6.139"></a><span id="l6.139" class="difflineat">@@ -832,27 +811,27 @@ nsMsgComposeAndSend::GatherMimeAttachmen</span>
<a href="#l6.140"></a><span id="l6.140">   if (NS_FAILED(status))</span>
<a href="#l6.141"></a><span id="l6.141">     goto FAIL;</span>
<a href="#l6.142"></a><span id="l6.142"> </span>
<a href="#l6.143"></a><span id="l6.143">   // Set up the first part (user-typed.)  For now, do it even if the first</span>
<a href="#l6.144"></a><span id="l6.144">   // part is empty; we need to add things to skip it if this part is empty.</span>
<a href="#l6.145"></a><span id="l6.145"> </span>
<a href="#l6.146"></a><span id="l6.146">   // Set up encoder for the first part (message body.)</span>
<a href="#l6.147"></a><span id="l6.147">   //</span>
<a href="#l6.148"></a><span id="l6.148" class="difflineminus">-  NS_ASSERTION(!m_attachment1_encoder_data, &quot;not-null m_attachment1_encoder_data&quot;);</span>
<a href="#l6.149"></a><span id="l6.149" class="difflineplus">+  NS_ASSERTION(!m_attachment1_encoder, &quot;not-null m_attachment1_encoder&quot;);</span>
<a href="#l6.150"></a><span id="l6.150">   if (!PL_strcasecmp(m_attachment1_encoding, ENCODING_BASE64))</span>
<a href="#l6.151"></a><span id="l6.151">   {</span>
<a href="#l6.152"></a><span id="l6.152" class="difflineminus">-    m_attachment1_encoder_data = MIME_B64EncoderInit(mime_encoder_output_fn, this);</span>
<a href="#l6.153"></a><span id="l6.153" class="difflineminus">-    if (!m_attachment1_encoder_data) goto FAILMEM;</span>
<a href="#l6.154"></a><span id="l6.154" class="difflineplus">+    m_attachment1_encoder = MimeEncoder::GetBase64Encoder(</span>
<a href="#l6.155"></a><span id="l6.155" class="difflineplus">+      mime_encoder_output_fn, this);</span>
<a href="#l6.156"></a><span id="l6.156">   }</span>
<a href="#l6.157"></a><span id="l6.157" class="difflineminus">-  else</span>
<a href="#l6.158"></a><span id="l6.158" class="difflineminus">-    if (!PL_strcasecmp(m_attachment1_encoding, ENCODING_QUOTED_PRINTABLE)) {</span>
<a href="#l6.159"></a><span id="l6.159" class="difflineminus">-      m_attachment1_encoder_data =</span>
<a href="#l6.160"></a><span id="l6.160" class="difflineminus">-      MIME_QPEncoderInit(mime_encoder_output_fn, this);</span>
<a href="#l6.161"></a><span id="l6.161" class="difflineminus">-    }</span>
<a href="#l6.162"></a><span id="l6.162" class="difflineplus">+  else if (!PL_strcasecmp(m_attachment1_encoding, ENCODING_QUOTED_PRINTABLE))</span>
<a href="#l6.163"></a><span id="l6.163" class="difflineplus">+  {</span>
<a href="#l6.164"></a><span id="l6.164" class="difflineplus">+    m_attachment1_encoder = MimeEncoder::GetQPEncoder(mime_encoder_output_fn,</span>
<a href="#l6.165"></a><span id="l6.165" class="difflineplus">+      this);</span>
<a href="#l6.166"></a><span id="l6.166" class="difflineplus">+  }</span>
<a href="#l6.167"></a><span id="l6.167"> </span>
<a href="#l6.168"></a><span id="l6.168">   // If we converted HTML into plaintext, the plaintext part</span>
<a href="#l6.169"></a><span id="l6.169">   // already has its type/encoding headers set. So, in the specific</span>
<a href="#l6.170"></a><span id="l6.170">   // case where such a plaintext part is the main message body</span>
<a href="#l6.171"></a><span id="l6.171">   // (iff an HTML message is being sent as text only)</span>
<a href="#l6.172"></a><span id="l6.172">   // we want to avoid generating type/encoding/digest headers;</span>
<a href="#l6.173"></a><span id="l6.173">   // in all other cases, generate such headers here.</span>
<a href="#l6.174"></a><span id="l6.174">   //</span>
<a href="#l6.175"></a><span id="l6.175" class="difflineat">@@ -877,20 +856,17 @@ nsMsgComposeAndSend::GatherMimeAttachmen</span>
<a href="#l6.176"></a><span id="l6.176">       goto FAILMEM;</span>
<a href="#l6.177"></a><span id="l6.177">     status = mainbody-&gt;AppendOtherHeaders(hdrs);</span>
<a href="#l6.178"></a><span id="l6.178">     if (NS_FAILED(status))</span>
<a href="#l6.179"></a><span id="l6.179">       goto FAIL;</span>
<a href="#l6.180"></a><span id="l6.180">   }</span>
<a href="#l6.181"></a><span id="l6.181"> </span>
<a href="#l6.182"></a><span id="l6.182">   PR_FREEIF(hdrs);</span>
<a href="#l6.183"></a><span id="l6.183"> </span>
<a href="#l6.184"></a><span id="l6.184" class="difflineminus">-  status = mainbody-&gt;SetEncoderData(m_attachment1_encoder_data);</span>
<a href="#l6.185"></a><span id="l6.185" class="difflineminus">-  m_attachment1_encoder_data = nullptr;</span>
<a href="#l6.186"></a><span id="l6.186" class="difflineminus">-  if (NS_FAILED(status))</span>
<a href="#l6.187"></a><span id="l6.187" class="difflineminus">-    goto FAIL;</span>
<a href="#l6.188"></a><span id="l6.188" class="difflineplus">+  mainbody-&gt;SetEncoder(m_attachment1_encoder.forget());</span>
<a href="#l6.189"></a><span id="l6.189"> </span>
<a href="#l6.190"></a><span id="l6.190">   //</span>
<a href="#l6.191"></a><span id="l6.191">   // Now we need to process attachments and slot them in the</span>
<a href="#l6.192"></a><span id="l6.192">   // correct hierarchy.</span>
<a href="#l6.193"></a><span id="l6.193">   //</span>
<a href="#l6.194"></a><span id="l6.194">   if (m_attachment_count &gt; 0)</span>
<a href="#l6.195"></a><span id="l6.195">   {</span>
<a href="#l6.196"></a><span id="l6.196">     // Kludge to avoid having to allocate memory on the toy computers...</span>
<a href="#l6.197"></a><span id="l6.197" class="difflineat">@@ -1152,22 +1128,19 @@ nsMsgComposeAndSend::PreProcessPart(nsMs</span>
<a href="#l6.198"></a><span id="l6.198">     part-&gt;SetType(&quot;application/octet-stream&quot;);</span>
<a href="#l6.199"></a><span id="l6.199">     part-&gt;SetBuffer(&quot;&quot;);</span>
<a href="#l6.200"></a><span id="l6.200">   }</span>
<a href="#l6.201"></a><span id="l6.201">   if (NS_FAILED(status))</span>
<a href="#l6.202"></a><span id="l6.202">     return 0;</span>
<a href="#l6.203"></a><span id="l6.203">   status = part-&gt;SetFile(ma-&gt;mTmpFile);</span>
<a href="#l6.204"></a><span id="l6.204">   if (NS_FAILED(status))</span>
<a href="#l6.205"></a><span id="l6.205">     return 0;</span>
<a href="#l6.206"></a><span id="l6.206" class="difflineminus">-  if (ma-&gt;m_encoder_data)</span>
<a href="#l6.207"></a><span id="l6.207" class="difflineplus">+  if (ma-&gt;m_encoder)</span>
<a href="#l6.208"></a><span id="l6.208">   {</span>
<a href="#l6.209"></a><span id="l6.209" class="difflineminus">-    status = part-&gt;SetEncoderData(ma-&gt;m_encoder_data);</span>
<a href="#l6.210"></a><span id="l6.210" class="difflineminus">-    if (NS_FAILED(status))</span>
<a href="#l6.211"></a><span id="l6.211" class="difflineminus">-      return 0;</span>
<a href="#l6.212"></a><span id="l6.212" class="difflineminus">-    ma-&gt;m_encoder_data = nullptr;</span>
<a href="#l6.213"></a><span id="l6.213" class="difflineplus">+    part-&gt;SetEncoder(ma-&gt;m_encoder.forget());</span>
<a href="#l6.214"></a><span id="l6.214">   }</span>
<a href="#l6.215"></a><span id="l6.215"> </span>
<a href="#l6.216"></a><span id="l6.216">   ma-&gt;m_current_column = 0;</span>
<a href="#l6.217"></a><span id="l6.217"> </span>
<a href="#l6.218"></a><span id="l6.218">   if (ma-&gt;m_type.LowerCaseEqualsLiteral(MESSAGE_RFC822) ||</span>
<a href="#l6.219"></a><span id="l6.219">       ma-&gt;m_type.LowerCaseEqualsLiteral(MESSAGE_NEWS)) {</span>
<a href="#l6.220"></a><span id="l6.220">     part-&gt;SetStripSensitiveHeaders(true);</span>
<a href="#l6.221"></a><span id="l6.221">   }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgSend.h</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgSend.h</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -151,18 +151,25 @@</span>
<a href="#l7.4"></a><span id="l7.4"> //</span>
<a href="#l7.5"></a><span id="l7.5"> // Forward declarations...</span>
<a href="#l7.6"></a><span id="l7.6"> //</span>
<a href="#l7.7"></a><span id="l7.7"> class nsMsgSendPart;</span>
<a href="#l7.8"></a><span id="l7.8"> class nsMsgCopy;</span>
<a href="#l7.9"></a><span id="l7.9"> class nsIPrompt;</span>
<a href="#l7.10"></a><span id="l7.10"> class nsIInterfaceRequestor;</span>
<a href="#l7.11"></a><span id="l7.11"> </span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+namespace mozilla {</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+namespace mailnews {</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+class MimeEncoder;</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+}</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineplus">+}</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineplus">+</span>
<a href="#l7.18"></a><span id="l7.18"> class nsMsgComposeAndSend : public nsIMsgSend</span>
<a href="#l7.19"></a><span id="l7.19"> {</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineplus">+  typedef mozilla::mailnews::MimeEncoder MimeEncoder;</span>
<a href="#l7.21"></a><span id="l7.21"> public:</span>
<a href="#l7.22"></a><span id="l7.22">   //</span>
<a href="#l7.23"></a><span id="l7.23">   // Define QueryInterface, AddRef and Release for this class</span>
<a href="#l7.24"></a><span id="l7.24">   //</span>
<a href="#l7.25"></a><span id="l7.25">   NS_DECL_ISUPPORTS</span>
<a href="#l7.26"></a><span id="l7.26"> </span>
<a href="#l7.27"></a><span id="l7.27">   nsMsgComposeAndSend();</span>
<a href="#l7.28"></a><span id="l7.28">   virtual     ~nsMsgComposeAndSend();</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineat">@@ -302,17 +309,17 @@ public:</span>
<a href="#l7.30"></a><span id="l7.30">   // For MHTML message creation</span>
<a href="#l7.31"></a><span id="l7.31">   nsCOMPtr&lt;nsIEditor&gt;       mEditor;</span>
<a href="#l7.32"></a><span id="l7.32"> </span>
<a href="#l7.33"></a><span id="l7.33">   //</span>
<a href="#l7.34"></a><span id="l7.34">   // The first attachment, if any (typed in by the user.)</span>
<a href="#l7.35"></a><span id="l7.35">   //</span>
<a href="#l7.36"></a><span id="l7.36">   char                    *m_attachment1_type;</span>
<a href="#l7.37"></a><span id="l7.37">   char                    *m_attachment1_encoding;</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineminus">-  MimeEncoderData         *m_attachment1_encoder_data;</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineplus">+  nsAutoPtr&lt;MimeEncoder&gt;  m_attachment1_encoder;</span>
<a href="#l7.40"></a><span id="l7.40">   char                    *m_attachment1_body;</span>
<a href="#l7.41"></a><span id="l7.41">   uint32_t                m_attachment1_body_length;</span>
<a href="#l7.42"></a><span id="l7.42">   char                    *mOriginalHTMLBody;</span>
<a href="#l7.43"></a><span id="l7.43"> </span>
<a href="#l7.44"></a><span id="l7.44">   // The plaintext form of the first attachment, if needed.</span>
<a href="#l7.45"></a><span id="l7.45">   nsMsgAttachmentHandler  *m_plaintext;</span>
<a href="#l7.46"></a><span id="l7.46"> </span>
<a href="#l7.47"></a><span id="l7.47">   // The multipart/related save object for HTML text.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgSendPart.cpp</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgSendPart.cpp</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -3,29 +3,29 @@</span>
<a href="#l8.4"></a><span id="l8.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l8.5"></a><span id="l8.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l8.6"></a><span id="l8.6"> #include &quot;nsMsgLocalFolderHdrs.h&quot;</span>
<a href="#l8.7"></a><span id="l8.7"> #include &quot;nsMsgSend.h&quot;</span>
<a href="#l8.8"></a><span id="l8.8"> #include &quot;nsMsgSendPart.h&quot;</span>
<a href="#l8.9"></a><span id="l8.9"> #include &quot;nsIMimeConverter.h&quot;</span>
<a href="#l8.10"></a><span id="l8.10"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l8.11"></a><span id="l8.11"> #include &quot;nsIComponentManager.h&quot;</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-#include &quot;nsMsgEncoders.h&quot;</span>
<a href="#l8.13"></a><span id="l8.13"> #include &quot;nsMsgI18N.h&quot;</span>
<a href="#l8.14"></a><span id="l8.14"> #include &quot;nsMsgCompUtils.h&quot;</span>
<a href="#l8.15"></a><span id="l8.15"> #include &quot;nsMsgMimeCID.h&quot;</span>
<a href="#l8.16"></a><span id="l8.16"> #include &quot;nsMimeTypes.h&quot;</span>
<a href="#l8.17"></a><span id="l8.17"> #include &quot;prmem.h&quot;</span>
<a href="#l8.18"></a><span id="l8.18"> #include &quot;nsMsgPrompts.h&quot;</span>
<a href="#l8.19"></a><span id="l8.19"> #include &quot;nsNativeCharsetUtils.h&quot;</span>
<a href="#l8.20"></a><span id="l8.20"> #include &quot;nsNetUtil.h&quot;</span>
<a href="#l8.21"></a><span id="l8.21"> #include &quot;nsISeekableStream.h&quot;</span>
<a href="#l8.22"></a><span id="l8.22"> #include &quot;nsReadLine.h&quot;</span>
<a href="#l8.23"></a><span id="l8.23"> #include &quot;nsILineInputStream.h&quot;</span>
<a href="#l8.24"></a><span id="l8.24"> #include &quot;nsComposeStrings.h&quot;</span>
<a href="#l8.25"></a><span id="l8.25" class="difflineplus">+#include &quot;mozilla/mailnews/MimeEncoder.h&quot;</span>
<a href="#l8.26"></a><span id="l8.26"> </span>
<a href="#l8.27"></a><span id="l8.27"> static char *mime_mailto_stream_read_buffer = 0;</span>
<a href="#l8.28"></a><span id="l8.28"> </span>
<a href="#l8.29"></a><span id="l8.29"> int32_t nsMsgSendPart::M_counter = 0;</span>
<a href="#l8.30"></a><span id="l8.30"> </span>
<a href="#l8.31"></a><span id="l8.31"> nsMsgSendPart::nsMsgSendPart(nsIMsgSend* state, const char *part_charset)</span>
<a href="#l8.32"></a><span id="l8.32"> {</span>
<a href="#l8.33"></a><span id="l8.33">   PL_strncpy(m_charset_name, (part_charset ? part_charset : &quot;us-ascii&quot;), sizeof(m_charset_name)-1);</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineat">@@ -36,32 +36,27 @@ nsMsgSendPart::nsMsgSendPart(nsIMsgSend*</span>
<a href="#l8.35"></a><span id="l8.35">   m_partNum = &quot;1&quot;;</span>
<a href="#l8.36"></a><span id="l8.36">   SetMimeDeliveryState(state);</span>
<a href="#l8.37"></a><span id="l8.37"> </span>
<a href="#l8.38"></a><span id="l8.38">   m_parent = nullptr;</span>
<a href="#l8.39"></a><span id="l8.39">   m_buffer = nullptr;</span>
<a href="#l8.40"></a><span id="l8.40">   m_type = nullptr;</span>
<a href="#l8.41"></a><span id="l8.41">   m_other = nullptr;</span>
<a href="#l8.42"></a><span id="l8.42">   m_strip_sensitive_headers = false;</span>
<a href="#l8.43"></a><span id="l8.43" class="difflineminus">-  m_encoder_data = nullptr;</span>
<a href="#l8.44"></a><span id="l8.44">   </span>
<a href="#l8.45"></a><span id="l8.45">   m_firstBlock = false;</span>
<a href="#l8.46"></a><span id="l8.46">   m_needIntlConversion = false;</span>
<a href="#l8.47"></a><span id="l8.47">   </span>
<a href="#l8.48"></a><span id="l8.48">   m_mainpart = false;</span>
<a href="#l8.49"></a><span id="l8.49">   m_just_hit_CR = false;</span>
<a href="#l8.50"></a><span id="l8.50"> }</span>
<a href="#l8.51"></a><span id="l8.51"> </span>
<a href="#l8.52"></a><span id="l8.52"> </span>
<a href="#l8.53"></a><span id="l8.53"> nsMsgSendPart::~nsMsgSendPart()</span>
<a href="#l8.54"></a><span id="l8.54"> {</span>
<a href="#l8.55"></a><span id="l8.55" class="difflineminus">-  if (m_encoder_data) {</span>
<a href="#l8.56"></a><span id="l8.56" class="difflineminus">-    MIME_EncoderDestroy(m_encoder_data, false);</span>
<a href="#l8.57"></a><span id="l8.57" class="difflineminus">-    m_encoder_data = nullptr;</span>
<a href="#l8.58"></a><span id="l8.58" class="difflineminus">-  }</span>
<a href="#l8.59"></a><span id="l8.59">   for (int i=0 ; i &lt; m_numchildren; i++)</span>
<a href="#l8.60"></a><span id="l8.60">     delete m_children[i];</span>
<a href="#l8.61"></a><span id="l8.61"> </span>
<a href="#l8.62"></a><span id="l8.62">   delete [] m_children;</span>
<a href="#l8.63"></a><span id="l8.63">     PR_FREEIF(m_buffer);</span>
<a href="#l8.64"></a><span id="l8.64">   PR_FREEIF(m_other);</span>
<a href="#l8.65"></a><span id="l8.65">   PR_FREEIF(m_type);</span>
<a href="#l8.66"></a><span id="l8.66"> }</span>
<a href="#l8.67"></a><span id="l8.67" class="difflineat">@@ -138,22 +133,16 @@ nsresult nsMsgSendPart::AppendOtherHeade</span>
<a href="#l8.68"></a><span id="l8.68">   PL_strcat(tmp, more);</span>
<a href="#l8.69"></a><span id="l8.69">   PR_FREEIF(m_other);</span>
<a href="#l8.70"></a><span id="l8.70">   m_other = tmp;</span>
<a href="#l8.71"></a><span id="l8.71"> </span>
<a href="#l8.72"></a><span id="l8.72">   return NS_OK;</span>
<a href="#l8.73"></a><span id="l8.73"> }</span>
<a href="#l8.74"></a><span id="l8.74"> </span>
<a href="#l8.75"></a><span id="l8.75"> </span>
<a href="#l8.76"></a><span id="l8.76" class="difflineminus">-nsresult nsMsgSendPart::SetEncoderData(MimeEncoderData* data)</span>
<a href="#l8.77"></a><span id="l8.77" class="difflineminus">-{</span>
<a href="#l8.78"></a><span id="l8.78" class="difflineminus">-  m_encoder_data = data;</span>
<a href="#l8.79"></a><span id="l8.79" class="difflineminus">-  return NS_OK;</span>
<a href="#l8.80"></a><span id="l8.80" class="difflineminus">-}</span>
<a href="#l8.81"></a><span id="l8.81" class="difflineminus">-</span>
<a href="#l8.82"></a><span id="l8.82"> nsresult nsMsgSendPart::SetMainPart(bool value)</span>
<a href="#l8.83"></a><span id="l8.83"> {</span>
<a href="#l8.84"></a><span id="l8.84">   m_mainpart = value;</span>
<a href="#l8.85"></a><span id="l8.85">   return NS_OK;</span>
<a href="#l8.86"></a><span id="l8.86"> }</span>
<a href="#l8.87"></a><span id="l8.87"> </span>
<a href="#l8.88"></a><span id="l8.88"> nsresult nsMsgSendPart::AddChild(nsMsgSendPart* child)</span>
<a href="#l8.89"></a><span id="l8.89"> {</span>
<a href="#l8.90"></a><span id="l8.90" class="difflineat">@@ -226,19 +215,19 @@ nsMsgSendPart* nsMsgSendPart::GetChild(i</span>
<a href="#l8.91"></a><span id="l8.91"> </span>
<a href="#l8.92"></a><span id="l8.92"> </span>
<a href="#l8.93"></a><span id="l8.93"> </span>
<a href="#l8.94"></a><span id="l8.94"> nsresult nsMsgSendPart::PushBody(const char* buffer, int32_t length)</span>
<a href="#l8.95"></a><span id="l8.95"> {</span>
<a href="#l8.96"></a><span id="l8.96">   nsresult status = NS_OK;</span>
<a href="#l8.97"></a><span id="l8.97">   const char* encoded_data = buffer;</span>
<a href="#l8.98"></a><span id="l8.98"> </span>
<a href="#l8.99"></a><span id="l8.99" class="difflineminus">-  if (m_encoder_data)</span>
<a href="#l8.100"></a><span id="l8.100" class="difflineplus">+  if (m_encoder)</span>
<a href="#l8.101"></a><span id="l8.101">   {</span>
<a href="#l8.102"></a><span id="l8.102" class="difflineminus">-    status = MIME_EncoderWrite(m_encoder_data, encoded_data, length);</span>
<a href="#l8.103"></a><span id="l8.103" class="difflineplus">+    status = m_encoder-&gt;Write(encoded_data, length);</span>
<a href="#l8.104"></a><span id="l8.104">   }</span>
<a href="#l8.105"></a><span id="l8.105">   else</span>
<a href="#l8.106"></a><span id="l8.106">   {</span>
<a href="#l8.107"></a><span id="l8.107">     // Merely translate all linebreaks to CRLF.</span>
<a href="#l8.108"></a><span id="l8.108">     const char *in = encoded_data;</span>
<a href="#l8.109"></a><span id="l8.109">     const char *end = in + length;</span>
<a href="#l8.110"></a><span id="l8.110">     char *buffer, *out;</span>
<a href="#l8.111"></a><span id="l8.111"> </span>
<a href="#l8.112"></a><span id="l8.112" class="difflineat">@@ -726,20 +715,20 @@ nsMsgSendPart::Write()</span>
<a href="#l8.113"></a><span id="l8.113">       status = PushBody(buffer, bytesRead);</span>
<a href="#l8.114"></a><span id="l8.114">       if (NS_FAILED(status))</span>
<a href="#l8.115"></a><span id="l8.115">         goto FAIL;</span>
<a href="#l8.116"></a><span id="l8.116">       if (bytesRead &lt; MIME_BUFFER_SIZE)</span>
<a href="#l8.117"></a><span id="l8.117">         break;</span>
<a href="#l8.118"></a><span id="l8.118">     }</span>
<a href="#l8.119"></a><span id="l8.119">   }</span>
<a href="#l8.120"></a><span id="l8.120"> </span>
<a href="#l8.121"></a><span id="l8.121" class="difflineminus">-  if (m_encoder_data)</span>
<a href="#l8.122"></a><span id="l8.122" class="difflineplus">+  if (m_encoder)</span>
<a href="#l8.123"></a><span id="l8.123">   {</span>
<a href="#l8.124"></a><span id="l8.124" class="difflineminus">-    nsresult rv  = MIME_EncoderDestroy(m_encoder_data, false);</span>
<a href="#l8.125"></a><span id="l8.125" class="difflineminus">-    m_encoder_data = nullptr;</span>
<a href="#l8.126"></a><span id="l8.126" class="difflineplus">+    nsresult rv = m_encoder-&gt;Flush();</span>
<a href="#l8.127"></a><span id="l8.127" class="difflineplus">+    m_encoder = nullptr;</span>
<a href="#l8.128"></a><span id="l8.128">     needToWriteCRLFAfterEncodedBody = !m_parent;</span>
<a href="#l8.129"></a><span id="l8.129">     if (NS_FAILED(rv))</span>
<a href="#l8.130"></a><span id="l8.130">     {</span>
<a href="#l8.131"></a><span id="l8.131">       // XXX -1 is not a valid nsresult</span>
<a href="#l8.132"></a><span id="l8.132">       status = static_cast&lt;nsresult&gt;(-1);</span>
<a href="#l8.133"></a><span id="l8.133">       goto FAIL;</span>
<a href="#l8.134"></a><span id="l8.134">     }</span>
<a href="#l8.135"></a><span id="l8.135">   }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgSendPart.h</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgSendPart.h</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -5,20 +5,27 @@</span>
<a href="#l9.4"></a><span id="l9.4"> </span>
<a href="#l9.5"></a><span id="l9.5"> #ifndef _MsgSendPart_H_</span>
<a href="#l9.6"></a><span id="l9.6"> #define _MsgSendPart_H_</span>
<a href="#l9.7"></a><span id="l9.7"> </span>
<a href="#l9.8"></a><span id="l9.8"> #include &quot;msgCore.h&quot;</span>
<a href="#l9.9"></a><span id="l9.9"> #include &quot;prprf.h&quot; /* should be defined into msgCore.h? */</span>
<a href="#l9.10"></a><span id="l9.10"> #include &quot;nsMsgSend.h&quot;</span>
<a href="#l9.11"></a><span id="l9.11"> </span>
<a href="#l9.12"></a><span id="l9.12" class="difflineplus">+namespace mozilla {</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+namespace mailnews {</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineplus">+class MimeEncoder;</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineplus">+}</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineplus">+}</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineplus">+</span>
<a href="#l9.18"></a><span id="l9.18"> typedef int (*MSG_SendPartWriteFunc)(const char* line, int32_t size,</span>
<a href="#l9.19"></a><span id="l9.19"> 									                   bool isheader, void* closure);</span>
<a href="#l9.20"></a><span id="l9.20"> </span>
<a href="#l9.21"></a><span id="l9.21"> class nsMsgSendPart {</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineplus">+  typedef mozilla::mailnews::MimeEncoder MimeEncoder;</span>
<a href="#l9.23"></a><span id="l9.23"> public:</span>
<a href="#l9.24"></a><span id="l9.24">     nsMsgSendPart(nsIMsgSend* state, const char *part_charset = NULL);</span>
<a href="#l9.25"></a><span id="l9.25">     virtual ~nsMsgSendPart();	  // Note that the destructor also destroys</span>
<a href="#l9.26"></a><span id="l9.26"> 								                // any children that were added.</span>
<a href="#l9.27"></a><span id="l9.27"> </span>
<a href="#l9.28"></a><span id="l9.28">     virtual nsresult  Write();</span>
<a href="#l9.29"></a><span id="l9.29"> </span>
<a href="#l9.30"></a><span id="l9.30">     virtual nsresult    SetFile(nsIFile *filename);</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineat">@@ -33,22 +40,22 @@ public:</span>
<a href="#l9.32"></a><span id="l9.32">     const char        *GetCharsetName() {return m_charset_name;}</span>
<a href="#l9.33"></a><span id="l9.33"> </span>
<a href="#l9.34"></a><span id="l9.34">     virtual nsresult  SetOtherHeaders(const char* other);</span>
<a href="#l9.35"></a><span id="l9.35">     const char        *SetOtherHeaders() {return m_other;}</span>
<a href="#l9.36"></a><span id="l9.36"> 	  virtual nsresult  AppendOtherHeaders(const char* moreother);</span>
<a href="#l9.37"></a><span id="l9.37"> </span>
<a href="#l9.38"></a><span id="l9.38"> 	  virtual nsresult  SetMimeDeliveryState(nsIMsgSend* state);</span>
<a href="#l9.39"></a><span id="l9.39"> </span>
<a href="#l9.40"></a><span id="l9.40" class="difflineminus">-	// Note that the nsMsgSendPart class will take over ownership of the</span>
<a href="#l9.41"></a><span id="l9.41" class="difflineminus">-	// MimeEncoderData* object, deleting it when it chooses.  (This is</span>
<a href="#l9.42"></a><span id="l9.42" class="difflineminus">-	// necessary because deleting these objects is the only current way to</span>
<a href="#l9.43"></a><span id="l9.43" class="difflineminus">-	// flush out the data in them.)</span>
<a href="#l9.44"></a><span id="l9.44" class="difflineminus">-	nsresult            SetEncoderData(MimeEncoderData* data);</span>
<a href="#l9.45"></a><span id="l9.45" class="difflineminus">-	MimeEncoderData     *GetEncoderData() {return m_encoder_data;}</span>
<a href="#l9.46"></a><span id="l9.46" class="difflineplus">+  // Note that the nsMsgSendPart class will take over ownership of the</span>
<a href="#l9.47"></a><span id="l9.47" class="difflineplus">+  // MimeEncoderData* object, deleting it when it chooses.  (This is</span>
<a href="#l9.48"></a><span id="l9.48" class="difflineplus">+  // necessary because deleting these objects is the only current way to</span>
<a href="#l9.49"></a><span id="l9.49" class="difflineplus">+  // flush out the data in them.)</span>
<a href="#l9.50"></a><span id="l9.50" class="difflineplus">+  void                SetEncoder(MimeEncoder* encoder) {m_encoder = encoder;}</span>
<a href="#l9.51"></a><span id="l9.51" class="difflineplus">+  MimeEncoder         *GetEncoder() {return m_encoder;}</span>
<a href="#l9.52"></a><span id="l9.52"> </span>
<a href="#l9.53"></a><span id="l9.53"> 	void                SetStripSensitiveHeaders(bool value)</span>
<a href="#l9.54"></a><span id="l9.54">                       {</span>
<a href="#l9.55"></a><span id="l9.55"> 		                    m_strip_sensitive_headers = value;</span>
<a href="#l9.56"></a><span id="l9.56"> 	                    }</span>
<a href="#l9.57"></a><span id="l9.57"> 	bool                GetStripSensitiveHeaders() {return m_strip_sensitive_headers;}</span>
<a href="#l9.58"></a><span id="l9.58"> </span>
<a href="#l9.59"></a><span id="l9.59">   virtual nsresult    AddChild(nsMsgSendPart* child);</span>
<a href="#l9.60"></a><span id="l9.60" class="difflineat">@@ -70,17 +77,17 @@ protected:</span>
<a href="#l9.61"></a><span id="l9.61"> 	nsCOMPtr&lt;nsIMsgSend&gt; m_state;</span>
<a href="#l9.62"></a><span id="l9.62"> 	nsMsgSendPart       *m_parent;</span>
<a href="#l9.63"></a><span id="l9.63">   nsCOMPtr &lt;nsIFile&gt;   m_file;</span>
<a href="#l9.64"></a><span id="l9.64"> 	char                *m_buffer;</span>
<a href="#l9.65"></a><span id="l9.65">   char                *m_type;</span>
<a href="#l9.66"></a><span id="l9.66">   char                *m_other;</span>
<a href="#l9.67"></a><span id="l9.67">   char                m_charset_name[64+1];        // charset name associated with this part</span>
<a href="#l9.68"></a><span id="l9.68"> 	bool                m_strip_sensitive_headers;</span>
<a href="#l9.69"></a><span id="l9.69" class="difflineminus">-	MimeEncoderData     *m_encoder_data;  /* Opaque state for base64/qp encoder. */</span>
<a href="#l9.70"></a><span id="l9.70" class="difflineplus">+  nsAutoPtr&lt;MimeEncoder&gt; m_encoder;</span>
<a href="#l9.71"></a><span id="l9.71"> </span>
<a href="#l9.72"></a><span id="l9.72"> 	nsMsgSendPart       **m_children;</span>
<a href="#l9.73"></a><span id="l9.73"> 	int32_t             m_numchildren;</span>
<a href="#l9.74"></a><span id="l9.74"> </span>
<a href="#l9.75"></a><span id="l9.75"> 	// Data used while actually writing.</span>
<a href="#l9.76"></a><span id="l9.76">   bool                m_firstBlock;</span>
<a href="#l9.77"></a><span id="l9.77">   bool                m_needIntlConversion;</span>
<a href="#l9.78"></a><span id="l9.78"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/extensions/smime/src/nsMsgComposeSecure.cpp</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/extensions/smime/src/nsMsgComposeSecure.cpp</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -15,81 +15,42 @@</span>
<a href="#l10.4"></a><span id="l10.4"> #include &quot;nsMimeTypes.h&quot;</span>
<a href="#l10.5"></a><span id="l10.5"> #include &quot;nsMsgMimeCID.h&quot;</span>
<a href="#l10.6"></a><span id="l10.6"> #include &quot;nspr.h&quot;</span>
<a href="#l10.7"></a><span id="l10.7"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l10.8"></a><span id="l10.8"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l10.9"></a><span id="l10.9"> #include &quot;nsMemory.h&quot;</span>
<a href="#l10.10"></a><span id="l10.10"> #include &quot;nsAlgorithm.h&quot;</span>
<a href="#l10.11"></a><span id="l10.11"> #include &quot;mozilla/Services.h&quot;</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineplus">+#include &quot;mozilla/mailnews/MimeEncoder.h&quot;</span>
<a href="#l10.13"></a><span id="l10.13"> #include &lt;algorithm&gt;</span>
<a href="#l10.14"></a><span id="l10.14"> </span>
<a href="#l10.15"></a><span id="l10.15" class="difflineplus">+using mozilla::mailnews::MimeEncoder;</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineplus">+</span>
<a href="#l10.17"></a><span id="l10.17"> #define MK_MIME_ERROR_WRITING_FILE -1</span>
<a href="#l10.18"></a><span id="l10.18"> </span>
<a href="#l10.19"></a><span id="l10.19"> #define SMIME_STRBUNDLE_URL &quot;chrome://messenger/locale/am-smime.properties&quot;</span>
<a href="#l10.20"></a><span id="l10.20"> </span>
<a href="#l10.21"></a><span id="l10.21"> // It doesn't make sense to encode the message because the message will be</span>
<a href="#l10.22"></a><span id="l10.22"> // displayed only if the MUA doesn't support MIME.</span>
<a href="#l10.23"></a><span id="l10.23"> // We need to consider what to do in case the server doesn't support 8BITMIME.</span>
<a href="#l10.24"></a><span id="l10.24"> // In short, we can't use non-ASCII characters here.</span>
<a href="#l10.25"></a><span id="l10.25"> static const char crypto_multipart_blurb[] = &quot;This is a cryptographically signed message in MIME format.&quot;;</span>
<a href="#l10.26"></a><span id="l10.26"> </span>
<a href="#l10.27"></a><span id="l10.27"> static void mime_crypto_write_base64 (void *closure, const char *buf,</span>
<a href="#l10.28"></a><span id="l10.28">               unsigned long size);</span>
<a href="#l10.29"></a><span id="l10.29" class="difflineminus">-static int mime_encoder_output_fn(const char *buf, int32_t size, void *closure);</span>
<a href="#l10.30"></a><span id="l10.30" class="difflineminus">-static int mime_nested_encoder_output_fn (const char *buf, int32_t size, void *closure);</span>
<a href="#l10.31"></a><span id="l10.31" class="difflineplus">+static nsresult mime_encoder_output_fn(const char *buf, int32_t size,</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineplus">+                                       void *closure);</span>
<a href="#l10.33"></a><span id="l10.33" class="difflineplus">+static nsresult mime_nested_encoder_output_fn(const char *buf, int32_t size,</span>
<a href="#l10.34"></a><span id="l10.34" class="difflineplus">+                                              void *closure);</span>
<a href="#l10.35"></a><span id="l10.35"> static nsresult make_multipart_signed_header_string(bool outer_p,</span>
<a href="#l10.36"></a><span id="l10.36">                   char **header_return,</span>
<a href="#l10.37"></a><span id="l10.37">                   char **boundary_return);</span>
<a href="#l10.38"></a><span id="l10.38"> static char *mime_make_separator(const char *prefix);</span>
<a href="#l10.39"></a><span id="l10.39"> </span>
<a href="#l10.40"></a><span id="l10.40" class="difflineminus">-// mscott --&gt; FIX ME...for now cloning code from compose\nsMsgEncode.h/.cpp</span>
<a href="#l10.41"></a><span id="l10.41" class="difflineminus">-</span>
<a href="#l10.42"></a><span id="l10.42" class="difflineminus">-MimeEncoderData *</span>
<a href="#l10.43"></a><span id="l10.43" class="difflineminus">-MIME_B64EncoderInit(MimeConverterOutputCallback output_fn, void *closure)</span>
<a href="#l10.44"></a><span id="l10.44" class="difflineminus">-{</span>
<a href="#l10.45"></a><span id="l10.45" class="difflineminus">-  MimeEncoderData *returnEncoderData = nullptr;</span>
<a href="#l10.46"></a><span id="l10.46" class="difflineminus">-  nsCOMPtr&lt;nsIMimeConverter&gt; converter = do_GetService(NS_MIME_CONVERTER_CONTRACTID);</span>
<a href="#l10.47"></a><span id="l10.47" class="difflineminus">-  NS_ENSURE_TRUE(converter, nullptr);</span>
<a href="#l10.48"></a><span id="l10.48" class="difflineminus">-</span>
<a href="#l10.49"></a><span id="l10.49" class="difflineminus">-  nsresult res = converter-&gt;B64EncoderInit(output_fn, closure, &amp;returnEncoderData);</span>
<a href="#l10.50"></a><span id="l10.50" class="difflineminus">-  return NS_SUCCEEDED(res) ? returnEncoderData : nullptr;</span>
<a href="#l10.51"></a><span id="l10.51" class="difflineminus">-}</span>
<a href="#l10.52"></a><span id="l10.52" class="difflineminus">-</span>
<a href="#l10.53"></a><span id="l10.53" class="difflineminus">-MimeEncoderData *</span>
<a href="#l10.54"></a><span id="l10.54" class="difflineminus">-MIME_QPEncoderInit(MimeConverterOutputCallback output_fn, void *closure)</span>
<a href="#l10.55"></a><span id="l10.55" class="difflineminus">-{</span>
<a href="#l10.56"></a><span id="l10.56" class="difflineminus">-  MimeEncoderData *returnEncoderData = nullptr;</span>
<a href="#l10.57"></a><span id="l10.57" class="difflineminus">-  nsCOMPtr&lt;nsIMimeConverter&gt; converter = do_GetService(NS_MIME_CONVERTER_CONTRACTID);</span>
<a href="#l10.58"></a><span id="l10.58" class="difflineminus">-  NS_ENSURE_TRUE(converter, nullptr);</span>
<a href="#l10.59"></a><span id="l10.59" class="difflineminus">-</span>
<a href="#l10.60"></a><span id="l10.60" class="difflineminus">-  nsresult res = converter-&gt;QPEncoderInit(output_fn, closure, &amp;returnEncoderData);</span>
<a href="#l10.61"></a><span id="l10.61" class="difflineminus">-  return NS_SUCCEEDED(res) ? returnEncoderData : nullptr;</span>
<a href="#l10.62"></a><span id="l10.62" class="difflineminus">-}</span>
<a href="#l10.63"></a><span id="l10.63" class="difflineminus">-</span>
<a href="#l10.64"></a><span id="l10.64" class="difflineminus">-nsresult</span>
<a href="#l10.65"></a><span id="l10.65" class="difflineminus">-MIME_EncoderDestroy(MimeEncoderData *data, bool abort_p) </span>
<a href="#l10.66"></a><span id="l10.66" class="difflineminus">-{</span>
<a href="#l10.67"></a><span id="l10.67" class="difflineminus">-  nsresult rv = NS_OK;</span>
<a href="#l10.68"></a><span id="l10.68" class="difflineminus">-  nsCOMPtr&lt;nsIMimeConverter&gt; converter = do_GetService(NS_MIME_CONVERTER_CONTRACTID, &amp;rv);</span>
<a href="#l10.69"></a><span id="l10.69" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.70"></a><span id="l10.70" class="difflineminus">-</span>
<a href="#l10.71"></a><span id="l10.71" class="difflineminus">-  return converter-&gt;EncoderDestroy(data, abort_p);</span>
<a href="#l10.72"></a><span id="l10.72" class="difflineminus">-}</span>
<a href="#l10.73"></a><span id="l10.73" class="difflineminus">-</span>
<a href="#l10.74"></a><span id="l10.74" class="difflineminus">-nsresult</span>
<a href="#l10.75"></a><span id="l10.75" class="difflineminus">-MIME_EncoderWrite(MimeEncoderData *data, const char *buffer, int32_t size) </span>
<a href="#l10.76"></a><span id="l10.76" class="difflineminus">-{</span>
<a href="#l10.77"></a><span id="l10.77" class="difflineminus">-  nsresult rv;</span>
<a href="#l10.78"></a><span id="l10.78" class="difflineminus">-  nsCOMPtr&lt;nsIMimeConverter&gt; converter = do_GetService(NS_MIME_CONVERTER_CONTRACTID, &amp;rv);</span>
<a href="#l10.79"></a><span id="l10.79" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.80"></a><span id="l10.80" class="difflineminus">-</span>
<a href="#l10.81"></a><span id="l10.81" class="difflineminus">-  int32_t written = 0;</span>
<a href="#l10.82"></a><span id="l10.82" class="difflineminus">-  return converter-&gt;EncoderWrite(data, buffer, size, &amp;written);</span>
<a href="#l10.83"></a><span id="l10.83" class="difflineminus">-}</span>
<a href="#l10.84"></a><span id="l10.84"> </span>
<a href="#l10.85"></a><span id="l10.85"> static void</span>
<a href="#l10.86"></a><span id="l10.86"> GenerateGlobalRandomBytes(unsigned char *buf, int32_t len)</span>
<a href="#l10.87"></a><span id="l10.87"> {</span>
<a href="#l10.88"></a><span id="l10.88">   static bool      firstTime = true;</span>
<a href="#l10.89"></a><span id="l10.89">   </span>
<a href="#l10.90"></a><span id="l10.90">   if (firstTime)</span>
<a href="#l10.91"></a><span id="l10.91">   {</span>
<a href="#l10.92"></a><span id="l10.92" class="difflineat">@@ -164,41 +125,32 @@ NS_IMETHODIMP nsMsgSMIMEComposeFields::G</span>
<a href="#l10.93"></a><span id="l10.93"> // Implementation of nsMsgComposeSecure</span>
<a href="#l10.94"></a><span id="l10.94"> /////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l10.95"></a><span id="l10.95"> </span>
<a href="#l10.96"></a><span id="l10.96"> NS_IMPL_ISUPPORTS1(nsMsgComposeSecure, nsIMsgComposeSecure)</span>
<a href="#l10.97"></a><span id="l10.97"> </span>
<a href="#l10.98"></a><span id="l10.98"> nsMsgComposeSecure::nsMsgComposeSecure()</span>
<a href="#l10.99"></a><span id="l10.99"> {</span>
<a href="#l10.100"></a><span id="l10.100">   /* member initializers and constructor code */</span>
<a href="#l10.101"></a><span id="l10.101" class="difflineminus">-  mSigEncoderData = 0;</span>
<a href="#l10.102"></a><span id="l10.102">   mMultipartSignedBoundary  = 0;</span>
<a href="#l10.103"></a><span id="l10.103" class="difflineminus">-  mCryptoEncoderData = 0;</span>
<a href="#l10.104"></a><span id="l10.104">   mBuffer = 0;</span>
<a href="#l10.105"></a><span id="l10.105">   mBufferedBytes = 0;</span>
<a href="#l10.106"></a><span id="l10.106"> }</span>
<a href="#l10.107"></a><span id="l10.107"> </span>
<a href="#l10.108"></a><span id="l10.108"> nsMsgComposeSecure::~nsMsgComposeSecure()</span>
<a href="#l10.109"></a><span id="l10.109"> {</span>
<a href="#l10.110"></a><span id="l10.110">   /* destructor code */</span>
<a href="#l10.111"></a><span id="l10.111">   if (mEncryptionContext) {</span>
<a href="#l10.112"></a><span id="l10.112">     if (mBufferedBytes) {</span>
<a href="#l10.113"></a><span id="l10.113">       mEncryptionContext-&gt;Update(mBuffer, mBufferedBytes);</span>
<a href="#l10.114"></a><span id="l10.114">       mBufferedBytes = 0;</span>
<a href="#l10.115"></a><span id="l10.115">     }</span>
<a href="#l10.116"></a><span id="l10.116">     mEncryptionContext-&gt;Finish();</span>
<a href="#l10.117"></a><span id="l10.117">   }</span>
<a href="#l10.118"></a><span id="l10.118"> </span>
<a href="#l10.119"></a><span id="l10.119" class="difflineminus">-  if (mSigEncoderData) {</span>
<a href="#l10.120"></a><span id="l10.120" class="difflineminus">-    MIME_EncoderDestroy (mSigEncoderData, true);</span>
<a href="#l10.121"></a><span id="l10.121" class="difflineminus">-  }</span>
<a href="#l10.122"></a><span id="l10.122" class="difflineminus">-  if (mCryptoEncoderData) {</span>
<a href="#l10.123"></a><span id="l10.123" class="difflineminus">-    MIME_EncoderDestroy (mCryptoEncoderData, true);</span>
<a href="#l10.124"></a><span id="l10.124" class="difflineminus">-  }</span>
<a href="#l10.125"></a><span id="l10.125" class="difflineminus">-</span>
<a href="#l10.126"></a><span id="l10.126">   delete [] mBuffer;</span>
<a href="#l10.127"></a><span id="l10.127"> </span>
<a href="#l10.128"></a><span id="l10.128">   PR_FREEIF(mMultipartSignedBoundary);</span>
<a href="#l10.129"></a><span id="l10.129"> }</span>
<a href="#l10.130"></a><span id="l10.130"> </span>
<a href="#l10.131"></a><span id="l10.131"> NS_IMETHODIMP nsMsgComposeSecure::RequiresCryptoEncapsulation(nsIMsgIdentity * aIdentity, nsIMsgCompFields * aCompFields, bool * aRequiresEncryptionWork)</span>
<a href="#l10.132"></a><span id="l10.132"> {</span>
<a href="#l10.133"></a><span id="l10.133">   NS_ENSURE_ARG_POINTER(aRequiresEncryptionWork);</span>
<a href="#l10.134"></a><span id="l10.134" class="difflineat">@@ -546,23 +498,20 @@ nsresult nsMsgComposeSecure::MimeInitEnc</span>
<a href="#l10.135"></a><span id="l10.135"> </span>
<a href="#l10.136"></a><span id="l10.136">   if (!mIsDraft) {</span>
<a href="#l10.137"></a><span id="l10.137">     uint32_t numCerts;</span>
<a href="#l10.138"></a><span id="l10.138">     mCerts-&gt;GetLength(&amp;numCerts);</span>
<a href="#l10.139"></a><span id="l10.139">     PR_ASSERT(numCerts &gt; 0);</span>
<a href="#l10.140"></a><span id="l10.140">     if (numCerts == 0) return NS_ERROR_FAILURE;</span>
<a href="#l10.141"></a><span id="l10.141">   }</span>
<a href="#l10.142"></a><span id="l10.142"> </span>
<a href="#l10.143"></a><span id="l10.143" class="difflineminus">-  /* Initialize the base64 encoder. */</span>
<a href="#l10.144"></a><span id="l10.144" class="difflineminus">-  PR_ASSERT(!mCryptoEncoderData);</span>
<a href="#l10.145"></a><span id="l10.145" class="difflineminus">-  mCryptoEncoderData = MIME_B64EncoderInit(mime_encoder_output_fn,</span>
<a href="#l10.146"></a><span id="l10.146" class="difflineplus">+  // Initialize the base64 encoder</span>
<a href="#l10.147"></a><span id="l10.147" class="difflineplus">+  MOZ_ASSERT(!mCryptoEncoder, &quot;Shouldn't have an encoder already&quot;);</span>
<a href="#l10.148"></a><span id="l10.148" class="difflineplus">+  mCryptoEncoder = MimeEncoder::GetBase64Encoder(mime_encoder_output_fn,</span>
<a href="#l10.149"></a><span id="l10.149">                           this);</span>
<a href="#l10.150"></a><span id="l10.150" class="difflineminus">-  if (!mCryptoEncoderData) {</span>
<a href="#l10.151"></a><span id="l10.151" class="difflineminus">-    return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l10.152"></a><span id="l10.152" class="difflineminus">-  }</span>
<a href="#l10.153"></a><span id="l10.153"> </span>
<a href="#l10.154"></a><span id="l10.154">   /* Initialize the encrypter (and add the sender's cert.) */</span>
<a href="#l10.155"></a><span id="l10.155">   PR_ASSERT(mSelfEncryptionCert);</span>
<a href="#l10.156"></a><span id="l10.156">   PR_SetError(0,0);</span>
<a href="#l10.157"></a><span id="l10.157">   mEncryptionCinfo = do_CreateInstance(NS_CMSMESSAGE_CONTRACTID, &amp;rv);</span>
<a href="#l10.158"></a><span id="l10.158">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l10.159"></a><span id="l10.159">   rv = mEncryptionCinfo-&gt;CreateEncrypted(mCerts);</span>
<a href="#l10.160"></a><span id="l10.160">   if (NS_FAILED(rv)) {</span>
<a href="#l10.161"></a><span id="l10.161" class="difflineat">@@ -576,17 +525,17 @@ nsresult nsMsgComposeSecure::MimeInitEnc</span>
<a href="#l10.162"></a><span id="l10.162">   if (!mBuffer) {</span>
<a href="#l10.163"></a><span id="l10.163">     mBuffer = new char[eBufferSize];</span>
<a href="#l10.164"></a><span id="l10.164">     if (!mBuffer)</span>
<a href="#l10.165"></a><span id="l10.165">       return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l10.166"></a><span id="l10.166">   }</span>
<a href="#l10.167"></a><span id="l10.167"> </span>
<a href="#l10.168"></a><span id="l10.168">   mBufferedBytes = 0;</span>
<a href="#l10.169"></a><span id="l10.169"> </span>
<a href="#l10.170"></a><span id="l10.170" class="difflineminus">-  rv = mEncryptionContext-&gt;Start(mEncryptionCinfo, mime_crypto_write_base64, mCryptoEncoderData);</span>
<a href="#l10.171"></a><span id="l10.171" class="difflineplus">+  rv = mEncryptionContext-&gt;Start(mEncryptionCinfo, mime_crypto_write_base64, mCryptoEncoder);</span>
<a href="#l10.172"></a><span id="l10.172">   if (NS_FAILED(rv)) {</span>
<a href="#l10.173"></a><span id="l10.173">     SetError(sendReport, NS_LITERAL_STRING(&quot;ErrorCanNotEncrypt&quot;).get());</span>
<a href="#l10.174"></a><span id="l10.174">     goto FAIL;</span>
<a href="#l10.175"></a><span id="l10.175">   }</span>
<a href="#l10.176"></a><span id="l10.176"> </span>
<a href="#l10.177"></a><span id="l10.177">   /* If we're signing, tack a multipart/signed header onto the front of</span>
<a href="#l10.178"></a><span id="l10.178">    the data to be encrypted, and initialize the sign-hashing code too.</span>
<a href="#l10.179"></a><span id="l10.179">    */</span>
<a href="#l10.180"></a><span id="l10.180" class="difflineat">@@ -684,49 +633,40 @@ nsresult nsMsgComposeSecure::MimeFinishM</span>
<a href="#l10.181"></a><span id="l10.181">   PR_SetError(0,0);</span>
<a href="#l10.182"></a><span id="l10.182"> </span>
<a href="#l10.183"></a><span id="l10.183">   rv = cinfo-&gt;CreateSigned(mSelfSigningCert, mSelfEncryptionCert, (unsigned char*)hashString.get(), hashString.Length());</span>
<a href="#l10.184"></a><span id="l10.184">   if (NS_FAILED(rv))  {</span>
<a href="#l10.185"></a><span id="l10.185">     SetError(sendReport, NS_LITERAL_STRING(&quot;ErrorCanNotSign&quot;).get());</span>
<a href="#l10.186"></a><span id="l10.186">     goto FAIL;</span>
<a href="#l10.187"></a><span id="l10.187">   }</span>
<a href="#l10.188"></a><span id="l10.188"> </span>
<a href="#l10.189"></a><span id="l10.189" class="difflineminus">-  /* Initialize the base64 encoder for the signature data.</span>
<a href="#l10.190"></a><span id="l10.190" class="difflineminus">-   */</span>
<a href="#l10.191"></a><span id="l10.191" class="difflineminus">-  PR_ASSERT(!mSigEncoderData);</span>
<a href="#l10.192"></a><span id="l10.192" class="difflineminus">-  mSigEncoderData =</span>
<a href="#l10.193"></a><span id="l10.193" class="difflineminus">-  MIME_B64EncoderInit((aOuter</span>
<a href="#l10.194"></a><span id="l10.194" class="difflineminus">-            ? mime_encoder_output_fn</span>
<a href="#l10.195"></a><span id="l10.195" class="difflineminus">-            : mime_nested_encoder_output_fn),</span>
<a href="#l10.196"></a><span id="l10.196" class="difflineminus">-             this);</span>
<a href="#l10.197"></a><span id="l10.197" class="difflineminus">-  if (!mSigEncoderData) {</span>
<a href="#l10.198"></a><span id="l10.198" class="difflineminus">-    rv = NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l10.199"></a><span id="l10.199" class="difflineminus">-    goto FAIL;</span>
<a href="#l10.200"></a><span id="l10.200" class="difflineminus">-  }</span>
<a href="#l10.201"></a><span id="l10.201" class="difflineplus">+  // Initialize the base64 encoder for the signature data.</span>
<a href="#l10.202"></a><span id="l10.202" class="difflineplus">+  MOZ_ASSERT(!mSigEncoder, &quot;Shouldn't already have a mSigEncoder&quot;);</span>
<a href="#l10.203"></a><span id="l10.203" class="difflineplus">+  mSigEncoder = MimeEncoder::GetBase64Encoder(</span>
<a href="#l10.204"></a><span id="l10.204" class="difflineplus">+    (aOuter ? mime_encoder_output_fn : mime_nested_encoder_output_fn), this);</span>
<a href="#l10.205"></a><span id="l10.205"> </span>
<a href="#l10.206"></a><span id="l10.206">   /* Write out the signature.</span>
<a href="#l10.207"></a><span id="l10.207">    */</span>
<a href="#l10.208"></a><span id="l10.208">   PR_SetError(0,0);</span>
<a href="#l10.209"></a><span id="l10.209" class="difflineminus">-  rv = encoder-&gt;Start(cinfo, mime_crypto_write_base64, mSigEncoderData);</span>
<a href="#l10.210"></a><span id="l10.210" class="difflineplus">+  rv = encoder-&gt;Start(cinfo, mime_crypto_write_base64, mSigEncoder);</span>
<a href="#l10.211"></a><span id="l10.211">   if (NS_FAILED(rv)) {</span>
<a href="#l10.212"></a><span id="l10.212">     SetError(sendReport, NS_LITERAL_STRING(&quot;ErrorCanNotSign&quot;).get());</span>
<a href="#l10.213"></a><span id="l10.213">     goto FAIL;</span>
<a href="#l10.214"></a><span id="l10.214">   }</span>
<a href="#l10.215"></a><span id="l10.215"> </span>
<a href="#l10.216"></a><span id="l10.216">   // We're not passing in any data, so no update needed.</span>
<a href="#l10.217"></a><span id="l10.217">   rv = encoder-&gt;Finish();</span>
<a href="#l10.218"></a><span id="l10.218">   if (NS_FAILED(rv)) {</span>
<a href="#l10.219"></a><span id="l10.219">     SetError(sendReport, NS_LITERAL_STRING(&quot;ErrorCanNotSign&quot;).get());</span>
<a href="#l10.220"></a><span id="l10.220">     goto FAIL;</span>
<a href="#l10.221"></a><span id="l10.221">   }</span>
<a href="#l10.222"></a><span id="l10.222"> </span>
<a href="#l10.223"></a><span id="l10.223" class="difflineminus">-  /* Shut down the sig's base64 encoder.</span>
<a href="#l10.224"></a><span id="l10.224" class="difflineminus">-   */</span>
<a href="#l10.225"></a><span id="l10.225" class="difflineminus">-  rv = MIME_EncoderDestroy(mSigEncoderData, false);</span>
<a href="#l10.226"></a><span id="l10.226" class="difflineminus">-  mSigEncoderData = 0;</span>
<a href="#l10.227"></a><span id="l10.227" class="difflineplus">+  // Shut down the sig's base64 encoder.</span>
<a href="#l10.228"></a><span id="l10.228" class="difflineplus">+  rv = mSigEncoder-&gt;Flush();</span>
<a href="#l10.229"></a><span id="l10.229" class="difflineplus">+  mSigEncoder = nullptr;</span>
<a href="#l10.230"></a><span id="l10.230">   if (NS_FAILED(rv)) {</span>
<a href="#l10.231"></a><span id="l10.231">     goto FAIL;</span>
<a href="#l10.232"></a><span id="l10.232">   }</span>
<a href="#l10.233"></a><span id="l10.233"> </span>
<a href="#l10.234"></a><span id="l10.234">   /* Now write out the terminating boundary.</span>
<a href="#l10.235"></a><span id="l10.235">    */</span>
<a href="#l10.236"></a><span id="l10.236">   {</span>
<a href="#l10.237"></a><span id="l10.237">   uint32_t L;</span>
<a href="#l10.238"></a><span id="l10.238" class="difflineat">@@ -798,19 +738,19 @@ nsresult nsMsgComposeSecure::MimeFinishE</span>
<a href="#l10.239"></a><span id="l10.239">   PR_ASSERT(mEncryptionCinfo);</span>
<a href="#l10.240"></a><span id="l10.240">   if (!mEncryptionCinfo) {</span>
<a href="#l10.241"></a><span id="l10.241">     rv = NS_ERROR_FAILURE;</span>
<a href="#l10.242"></a><span id="l10.242">   }</span>
<a href="#l10.243"></a><span id="l10.243">   if (mEncryptionCinfo) {</span>
<a href="#l10.244"></a><span id="l10.244">     mEncryptionCinfo = 0;</span>
<a href="#l10.245"></a><span id="l10.245">   }</span>
<a href="#l10.246"></a><span id="l10.246"> </span>
<a href="#l10.247"></a><span id="l10.247" class="difflineminus">-  /* Shut down the base64 encoder. */</span>
<a href="#l10.248"></a><span id="l10.248" class="difflineminus">-  rv = MIME_EncoderDestroy(mCryptoEncoderData, false);</span>
<a href="#l10.249"></a><span id="l10.249" class="difflineminus">-  mCryptoEncoderData = 0;</span>
<a href="#l10.250"></a><span id="l10.250" class="difflineplus">+  // Shut down the base64 encoder.</span>
<a href="#l10.251"></a><span id="l10.251" class="difflineplus">+  mCryptoEncoder-&gt;Flush();</span>
<a href="#l10.252"></a><span id="l10.252" class="difflineplus">+  mCryptoEncoder = nullptr;</span>
<a href="#l10.253"></a><span id="l10.253"> </span>
<a href="#l10.254"></a><span id="l10.254">   uint32_t n;</span>
<a href="#l10.255"></a><span id="l10.255">   rv = mStream-&gt;Write(CRLF, 2, &amp;n);</span>
<a href="#l10.256"></a><span id="l10.256">   if (NS_FAILED(rv) || n &lt; 2)</span>
<a href="#l10.257"></a><span id="l10.257">     rv = NS_ERROR_FAILURE;</span>
<a href="#l10.258"></a><span id="l10.258"> </span>
<a href="#l10.259"></a><span id="l10.259">  FAIL:</span>
<a href="#l10.260"></a><span id="l10.260">   return rv;</span>
<a href="#l10.261"></a><span id="l10.261" class="difflineat">@@ -1052,52 +992,51 @@ make_multipart_signed_header_string(bool</span>
<a href="#l10.262"></a><span id="l10.262"> 	}</span>
<a href="#l10.263"></a><span id="l10.263"> </span>
<a href="#l10.264"></a><span id="l10.264">   return NS_OK;</span>
<a href="#l10.265"></a><span id="l10.265"> }</span>
<a href="#l10.266"></a><span id="l10.266"> </span>
<a href="#l10.267"></a><span id="l10.267"> /* Used as the output function of a SEC_PKCS7EncoderContext -- we feed</span>
<a href="#l10.268"></a><span id="l10.268">    plaintext into the crypto engine, and it calls this function with encrypted</span>
<a href="#l10.269"></a><span id="l10.269">    data; then this function writes a base64-encoded representation of that</span>
<a href="#l10.270"></a><span id="l10.270" class="difflineminus">-   data to the file (by filtering it through the given MimeEncoderData object.)</span>
<a href="#l10.271"></a><span id="l10.271" class="difflineplus">+   data to the file (by filtering it through the given MimeEncoder object.)</span>
<a href="#l10.272"></a><span id="l10.272"> </span>
<a href="#l10.273"></a><span id="l10.273">    Also used as the output function of SEC_PKCS7Encode() -- but in that case,</span>
<a href="#l10.274"></a><span id="l10.274">    it's used to write the encoded representation of the signature.  The only</span>
<a href="#l10.275"></a><span id="l10.275" class="difflineminus">-   difference is which MimeEncoderData object is used.</span>
<a href="#l10.276"></a><span id="l10.276" class="difflineplus">+   difference is which MimeEncoder object is used.</span>
<a href="#l10.277"></a><span id="l10.277">  */</span>
<a href="#l10.278"></a><span id="l10.278"> static void</span>
<a href="#l10.279"></a><span id="l10.279"> mime_crypto_write_base64 (void *closure, const char *buf, unsigned long size)</span>
<a href="#l10.280"></a><span id="l10.280"> {</span>
<a href="#l10.281"></a><span id="l10.281" class="difflineminus">-  MimeEncoderData *data = (MimeEncoderData *) closure;</span>
<a href="#l10.282"></a><span id="l10.282" class="difflineminus">-  nsresult rv = MIME_EncoderWrite (data, buf, size);</span>
<a href="#l10.283"></a><span id="l10.283" class="difflineplus">+  MimeEncoder *encoder = (MimeEncoder *) closure;</span>
<a href="#l10.284"></a><span id="l10.284" class="difflineplus">+  nsresult rv = encoder-&gt;Write(buf, size);</span>
<a href="#l10.285"></a><span id="l10.285">   PR_SetError(NS_FAILED(rv) ? static_cast&lt;uint32_t&gt;(rv) : 0, 0);</span>
<a href="#l10.286"></a><span id="l10.286"> }</span>
<a href="#l10.287"></a><span id="l10.287"> </span>
<a href="#l10.288"></a><span id="l10.288"> </span>
<a href="#l10.289"></a><span id="l10.289" class="difflineminus">-/* Used as the output function of MimeEncoderData -- when we have generated</span>
<a href="#l10.290"></a><span id="l10.290" class="difflineplus">+/* Used as the output function of MimeEncoder -- when we have generated</span>
<a href="#l10.291"></a><span id="l10.291">    the signature for a multipart/signed object, this is used to write the</span>
<a href="#l10.292"></a><span id="l10.292">    base64-encoded representation of the signature to the file.</span>
<a href="#l10.293"></a><span id="l10.293">  */</span>
<a href="#l10.294"></a><span id="l10.294" class="difflineminus">-int mime_encoder_output_fn(const char *buf, int32_t size, void *closure)</span>
<a href="#l10.295"></a><span id="l10.295" class="difflineplus">+nsresult mime_encoder_output_fn(const char *buf, int32_t size, void *closure)</span>
<a href="#l10.296"></a><span id="l10.296"> {</span>
<a href="#l10.297"></a><span id="l10.297">   nsMsgComposeSecure *state = (nsMsgComposeSecure *) closure;</span>
<a href="#l10.298"></a><span id="l10.298">   nsCOMPtr&lt;nsIOutputStream&gt; stream;</span>
<a href="#l10.299"></a><span id="l10.299">   state-&gt;GetOutputStream(getter_AddRefs(stream));</span>
<a href="#l10.300"></a><span id="l10.300">   uint32_t n;</span>
<a href="#l10.301"></a><span id="l10.301">   nsresult rv = stream-&gt;Write((char *) buf, size, &amp;n);</span>
<a href="#l10.302"></a><span id="l10.302">   if (NS_FAILED(rv) || n &lt; size)</span>
<a href="#l10.303"></a><span id="l10.303" class="difflineminus">-    return MK_MIME_ERROR_WRITING_FILE;</span>
<a href="#l10.304"></a><span id="l10.304" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l10.305"></a><span id="l10.305">   else</span>
<a href="#l10.306"></a><span id="l10.306" class="difflineminus">-    return 0;</span>
<a href="#l10.307"></a><span id="l10.307" class="difflineplus">+    return NS_OK;</span>
<a href="#l10.308"></a><span id="l10.308"> }</span>
<a href="#l10.309"></a><span id="l10.309"> </span>
<a href="#l10.310"></a><span id="l10.310"> /* Like mime_encoder_output_fn, except this is used for the case where we</span>
<a href="#l10.311"></a><span id="l10.311">    are both signing and encrypting -- the base64-encoded output of the</span>
<a href="#l10.312"></a><span id="l10.312">    signature should be fed into the crypto engine, rather than being written</span>
<a href="#l10.313"></a><span id="l10.313">    directly to the file.</span>
<a href="#l10.314"></a><span id="l10.314">  */</span>
<a href="#l10.315"></a><span id="l10.315" class="difflineminus">-static int</span>
<a href="#l10.316"></a><span id="l10.316" class="difflineplus">+static nsresult</span>
<a href="#l10.317"></a><span id="l10.317"> mime_nested_encoder_output_fn (const char *buf, int32_t size, void *closure)</span>
<a href="#l10.318"></a><span id="l10.318"> {</span>
<a href="#l10.319"></a><span id="l10.319">   nsMsgComposeSecure *state = (nsMsgComposeSecure *) closure;</span>
<a href="#l10.320"></a><span id="l10.320" class="difflineminus">-  // XXX MimeCryptoWriteBlock doesn't really return an nsresult, cast to int</span>
<a href="#l10.321"></a><span id="l10.321" class="difflineminus">-  return static_cast&lt;int&gt;(state-&gt;MimeCryptoWriteBlock ((char *) buf, size));</span>
<a href="#l10.322"></a><span id="l10.322" class="difflineplus">+  return state-&gt;MimeCryptoWriteBlock((char *) buf, size);</span>
<a href="#l10.323"></a><span id="l10.323"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/extensions/smime/src/nsMsgComposeSecure.h</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/extensions/smime/src/nsMsgComposeSecure.h</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -6,25 +6,30 @@</span>
<a href="#l11.4"></a><span id="l11.4"> #ifndef _nsMsgComposeSecure_H_</span>
<a href="#l11.5"></a><span id="l11.5"> #define _nsMsgComposeSecure_H_</span>
<a href="#l11.6"></a><span id="l11.6"> </span>
<a href="#l11.7"></a><span id="l11.7"> #include &quot;nsIMsgComposeSecure.h&quot;</span>
<a href="#l11.8"></a><span id="l11.8"> #include &quot;nsIMsgSMIMECompFields.h&quot;</span>
<a href="#l11.9"></a><span id="l11.9"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l11.10"></a><span id="l11.10"> #include &quot;nsICMSEncoder.h&quot;</span>
<a href="#l11.11"></a><span id="l11.11"> #include &quot;nsIX509Cert.h&quot;</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-#include &quot;nsIMimeConverter.h&quot;</span>
<a href="#l11.13"></a><span id="l11.13"> #include &quot;nsIStringBundle.h&quot;</span>
<a href="#l11.14"></a><span id="l11.14"> #include &quot;nsICryptoHash.h&quot;</span>
<a href="#l11.15"></a><span id="l11.15"> #include &quot;nsICMSMessage.h&quot;</span>
<a href="#l11.16"></a><span id="l11.16"> #include &quot;nsIMutableArray.h&quot;</span>
<a href="#l11.17"></a><span id="l11.17"> #include &quot;nsStringGlue.h&quot;</span>
<a href="#l11.18"></a><span id="l11.18"> #include &quot;nsIOutputStream.h&quot;</span>
<a href="#l11.19"></a><span id="l11.19" class="difflineplus">+#include &quot;nsAutoPtr.h&quot;</span>
<a href="#l11.20"></a><span id="l11.20"> </span>
<a href="#l11.21"></a><span id="l11.21"> class nsIMsgCompFields;</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineplus">+namespace mozilla {</span>
<a href="#l11.23"></a><span id="l11.23" class="difflineplus">+namespace mailnews {</span>
<a href="#l11.24"></a><span id="l11.24" class="difflineplus">+class MimeEncoder;</span>
<a href="#l11.25"></a><span id="l11.25" class="difflineplus">+}</span>
<a href="#l11.26"></a><span id="l11.26" class="difflineplus">+}</span>
<a href="#l11.27"></a><span id="l11.27"> </span>
<a href="#l11.28"></a><span id="l11.28"> class nsMsgSMIMEComposeFields : public nsIMsgSMIMECompFields</span>
<a href="#l11.29"></a><span id="l11.29"> {</span>
<a href="#l11.30"></a><span id="l11.30"> public:</span>
<a href="#l11.31"></a><span id="l11.31">   NS_DECL_ISUPPORTS</span>
<a href="#l11.32"></a><span id="l11.32">   NS_DECL_NSIMSGSMIMECOMPFIELDS</span>
<a href="#l11.33"></a><span id="l11.33"> </span>
<a href="#l11.34"></a><span id="l11.34">   nsMsgSMIMEComposeFields();</span>
<a href="#l11.35"></a><span id="l11.35" class="difflineat">@@ -49,16 +54,17 @@ public:</span>
<a href="#l11.36"></a><span id="l11.36">   NS_DECL_ISUPPORTS</span>
<a href="#l11.37"></a><span id="l11.37">   NS_DECL_NSIMSGCOMPOSESECURE</span>
<a href="#l11.38"></a><span id="l11.38"> </span>
<a href="#l11.39"></a><span id="l11.39">   nsMsgComposeSecure();</span>
<a href="#l11.40"></a><span id="l11.40">   virtual ~nsMsgComposeSecure();</span>
<a href="#l11.41"></a><span id="l11.41">   /* additional members */</span>
<a href="#l11.42"></a><span id="l11.42">   void GetOutputStream(nsIOutputStream **stream) { NS_IF_ADDREF(*stream = mStream);}</span>
<a href="#l11.43"></a><span id="l11.43"> private:</span>
<a href="#l11.44"></a><span id="l11.44" class="difflineplus">+  typedef mozilla::mailnews::MimeEncoder MimeEncoder;</span>
<a href="#l11.45"></a><span id="l11.45">   nsresult MimeInitMultipartSigned(bool aOuter, nsIMsgSendReport *sendReport);</span>
<a href="#l11.46"></a><span id="l11.46">   nsresult MimeInitEncryption(bool aSign, nsIMsgSendReport *sendReport);</span>
<a href="#l11.47"></a><span id="l11.47">   nsresult MimeFinishMultipartSigned (bool aOuter, nsIMsgSendReport *sendReport);</span>
<a href="#l11.48"></a><span id="l11.48">   nsresult MimeFinishEncryption (bool aSign, nsIMsgSendReport *sendReport);</span>
<a href="#l11.49"></a><span id="l11.49">   nsresult MimeCryptoHackCerts(const char *aRecipients, nsIMsgSendReport *sendReport, bool aEncrypt, bool aSign);</span>
<a href="#l11.50"></a><span id="l11.50">   bool InitializeSMIMEBundle();</span>
<a href="#l11.51"></a><span id="l11.51">   nsresult GetSMIMEBundleString(const PRUnichar *name,</span>
<a href="#l11.52"></a><span id="l11.52"> 				PRUnichar **outString);</span>
<a href="#l11.53"></a><span id="l11.53" class="difflineat">@@ -67,28 +73,28 @@ private:</span>
<a href="#l11.54"></a><span id="l11.54"> 					   uint32_t numParams,</span>
<a href="#l11.55"></a><span id="l11.55"> 					   PRUnichar **outString);</span>
<a href="#l11.56"></a><span id="l11.56">   nsresult ExtractEncryptionState(nsIMsgIdentity * aIdentity, nsIMsgCompFields * aComposeFields, bool * aSignMessage, bool * aEncrypt);</span>
<a href="#l11.57"></a><span id="l11.57"> </span>
<a href="#l11.58"></a><span id="l11.58">   mimeDeliveryCryptoState mCryptoState;</span>
<a href="#l11.59"></a><span id="l11.59">   nsCOMPtr&lt;nsIOutputStream&gt; mStream;</span>
<a href="#l11.60"></a><span id="l11.60">   int16_t mHashType;</span>
<a href="#l11.61"></a><span id="l11.61">   nsCOMPtr&lt;nsICryptoHash&gt; mDataHash;</span>
<a href="#l11.62"></a><span id="l11.62" class="difflineminus">-  MimeEncoderData *mSigEncoderData;</span>
<a href="#l11.63"></a><span id="l11.63" class="difflineplus">+  nsAutoPtr&lt;MimeEncoder&gt; mSigEncoder;</span>
<a href="#l11.64"></a><span id="l11.64">   char *mMultipartSignedBoundary;</span>
<a href="#l11.65"></a><span id="l11.65">   nsString mSigningCertName;</span>
<a href="#l11.66"></a><span id="l11.66">   nsCOMPtr&lt;nsIX509Cert&gt; mSelfSigningCert;</span>
<a href="#l11.67"></a><span id="l11.67">   nsString mEncryptionCertName;</span>
<a href="#l11.68"></a><span id="l11.68">   nsCOMPtr&lt;nsIX509Cert&gt; mSelfEncryptionCert;</span>
<a href="#l11.69"></a><span id="l11.69">   nsCOMPtr&lt;nsIMutableArray&gt; mCerts;</span>
<a href="#l11.70"></a><span id="l11.70">   nsCOMPtr&lt;nsICMSMessage&gt; mEncryptionCinfo;</span>
<a href="#l11.71"></a><span id="l11.71">   nsCOMPtr&lt;nsICMSEncoder&gt; mEncryptionContext;</span>
<a href="#l11.72"></a><span id="l11.72">   nsCOMPtr&lt;nsIStringBundle&gt; mSMIMEBundle;</span>
<a href="#l11.73"></a><span id="l11.73"> </span>
<a href="#l11.74"></a><span id="l11.74" class="difflineminus">-  MimeEncoderData *mCryptoEncoderData;</span>
<a href="#l11.75"></a><span id="l11.75" class="difflineplus">+  nsAutoPtr&lt;MimeEncoder&gt; mCryptoEncoder;</span>
<a href="#l11.76"></a><span id="l11.76">   bool mIsDraft;</span>
<a href="#l11.77"></a><span id="l11.77"> </span>
<a href="#l11.78"></a><span id="l11.78">   enum {eBufferSize = 8192};</span>
<a href="#l11.79"></a><span id="l11.79">   char *mBuffer;</span>
<a href="#l11.80"></a><span id="l11.80">   uint32_t mBufferedBytes;</span>
<a href="#l11.81"></a><span id="l11.81"> </span>
<a href="#l11.82"></a><span id="l11.82">   bool mErrorAlreadyReported;</span>
<a href="#l11.83"></a><span id="l11.83">   void SetError(nsIMsgSendReport *sendReport, const PRUnichar *bundle_string);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/mime/public/Makefile.in</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/mime/public/Makefile.in</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -14,10 +14,16 @@ MODULE		= mime</span>
<a href="#l12.4"></a><span id="l12.4"> </span>
<a href="#l12.5"></a><span id="l12.5"> EXPORTS		= \</span>
<a href="#l12.6"></a><span id="l12.6">                 nsMsgMimeCID.h \</span>
<a href="#l12.7"></a><span id="l12.7"> 		nsIMimeObjectClassAccess.h \</span>
<a href="#l12.8"></a><span id="l12.8"> 		nsMailHeaders.h \</span>
<a href="#l12.9"></a><span id="l12.9"> 		nsIMimeContentTypeHandler.h \</span>
<a href="#l12.10"></a><span id="l12.10"> 		$(NULL)</span>
<a href="#l12.11"></a><span id="l12.11"> </span>
<a href="#l12.12"></a><span id="l12.12" class="difflineplus">+EXPORTS_mozilla/mailnews = \</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+	MimeEncoder.h \</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineplus">+	$(NULL)</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineplus">+</span>
<a href="#l12.16"></a><span id="l12.16" class="difflineplus">+EXPORTS_NAMESPACES = mozilla/mailnews</span>
<a href="#l12.17"></a><span id="l12.17" class="difflineplus">+</span>
<a href="#l12.18"></a><span id="l12.18"> include $(topsrcdir)/config/rules.mk</span>
<a href="#l12.19"></a><span id="l12.19"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1">new file mode 100644</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineminus">--- /dev/null</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineplus">+++ b/mailnews/mime/public/MimeEncoder.h</span>
<a href="#l13.4"></a><span id="l13.4" class="difflineat">@@ -0,0 +1,44 @@</span>
<a href="#l13.5"></a><span id="l13.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l13.6"></a><span id="l13.6" class="difflineplus">+/* vim: set ts=8 sts=2 et sw=2 tw=80: */</span>
<a href="#l13.7"></a><span id="l13.7" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l13.8"></a><span id="l13.8" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l13.9"></a><span id="l13.9" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l13.10"></a><span id="l13.10" class="difflineplus">+</span>
<a href="#l13.11"></a><span id="l13.11" class="difflineplus">+#ifndef MimeEncoder_h__</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineplus">+#define MimeEncoder_h__</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineplus">+#include &quot;nscore.h&quot;</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineplus">+</span>
<a href="#l13.16"></a><span id="l13.16" class="difflineplus">+namespace mozilla {</span>
<a href="#l13.17"></a><span id="l13.17" class="difflineplus">+namespace mailnews {</span>
<a href="#l13.18"></a><span id="l13.18" class="difflineplus">+</span>
<a href="#l13.19"></a><span id="l13.19" class="difflineplus">+/// A class for encoding the bodies of MIME parts.</span>
<a href="#l13.20"></a><span id="l13.20" class="difflineplus">+class MimeEncoder {</span>
<a href="#l13.21"></a><span id="l13.21" class="difflineplus">+public:</span>
<a href="#l13.22"></a><span id="l13.22" class="difflineplus">+  virtual ~MimeEncoder() {}</span>
<a href="#l13.23"></a><span id="l13.23" class="difflineplus">+</span>
<a href="#l13.24"></a><span id="l13.24" class="difflineplus">+  /// A callback for writing the encoded output</span>
<a href="#l13.25"></a><span id="l13.25" class="difflineplus">+  typedef nsresult (*OutputCallback)</span>
<a href="#l13.26"></a><span id="l13.26" class="difflineplus">+    (const char *buf, int32_t size, void *closure);</span>
<a href="#l13.27"></a><span id="l13.27" class="difflineplus">+</span>
<a href="#l13.28"></a><span id="l13.28" class="difflineplus">+  /// Encodes the string in the buffer and sends it to the callback</span>
<a href="#l13.29"></a><span id="l13.29" class="difflineplus">+  virtual nsresult Write(const char *buffer, int32_t size) = 0;</span>
<a href="#l13.30"></a><span id="l13.30" class="difflineplus">+  /// Flush all pending data when no more data exists</span>
<a href="#l13.31"></a><span id="l13.31" class="difflineplus">+  virtual nsresult Flush() { return NS_OK; }</span>
<a href="#l13.32"></a><span id="l13.32" class="difflineplus">+</span>
<a href="#l13.33"></a><span id="l13.33" class="difflineplus">+  /// Get an encoder that outputs Base64-encoded data</span>
<a href="#l13.34"></a><span id="l13.34" class="difflineplus">+  static MimeEncoder *GetBase64Encoder(OutputCallback callback, void *closure);</span>
<a href="#l13.35"></a><span id="l13.35" class="difflineplus">+  /// Get an encoder that outputs quoted-printable data</span>
<a href="#l13.36"></a><span id="l13.36" class="difflineplus">+  static MimeEncoder *GetQPEncoder(OutputCallback callback, void *closure);</span>
<a href="#l13.37"></a><span id="l13.37" class="difflineplus">+</span>
<a href="#l13.38"></a><span id="l13.38" class="difflineplus">+protected:</span>
<a href="#l13.39"></a><span id="l13.39" class="difflineplus">+  MimeEncoder(OutputCallback callback, void *closure);</span>
<a href="#l13.40"></a><span id="l13.40" class="difflineplus">+  OutputCallback mCallback;</span>
<a href="#l13.41"></a><span id="l13.41" class="difflineplus">+  void *mClosure;</span>
<a href="#l13.42"></a><span id="l13.42" class="difflineplus">+  uint32_t mCurrentColumn;</span>
<a href="#l13.43"></a><span id="l13.43" class="difflineplus">+};</span>
<a href="#l13.44"></a><span id="l13.44" class="difflineplus">+</span>
<a href="#l13.45"></a><span id="l13.45" class="difflineplus">+} // namespace mailnews</span>
<a href="#l13.46"></a><span id="l13.46" class="difflineplus">+} // namespace mozilla</span>
<a href="#l13.47"></a><span id="l13.47" class="difflineplus">+</span>
<a href="#l13.48"></a><span id="l13.48" class="difflineplus">+#endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mailnews/mime/public/nsIMimeConverter.idl</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mailnews/mime/public/nsIMimeConverter.idl</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -1,34 +1,19 @@</span>
<a href="#l14.4"></a><span id="l14.4"> /* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l14.5"></a><span id="l14.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l14.6"></a><span id="l14.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l14.7"></a><span id="l14.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l14.8"></a><span id="l14.8"> </span>
<a href="#l14.9"></a><span id="l14.9"> #include &quot;nsISupports.idl&quot;</span>
<a href="#l14.10"></a><span id="l14.10"> </span>
<a href="#l14.11"></a><span id="l14.11" class="difflineminus">-%{C++</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineminus">-/* Opaque objects used by the encoder/decoder to store state. */</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineminus">-typedef struct MimeDecoderData MimeDecoderData;</span>
<a href="#l14.15"></a><span id="l14.15" class="difflineminus">-typedef struct MimeEncoderData MimeEncoderData;</span>
<a href="#l14.16"></a><span id="l14.16" class="difflineminus">-</span>
<a href="#l14.17"></a><span id="l14.17" class="difflineminus">-typedef int (*PR_CALLBACK MimeConverterOutputCallback)</span>
<a href="#l14.18"></a><span id="l14.18" class="difflineminus">-    (const char *buf, int32_t size, void *closure);</span>
<a href="#l14.19"></a><span id="l14.19" class="difflineminus">-</span>
<a href="#l14.20"></a><span id="l14.20" class="difflineminus">-%}</span>
<a href="#l14.21"></a><span id="l14.21" class="difflineminus">-</span>
<a href="#l14.22"></a><span id="l14.22" class="difflineminus">-[ptr] native MimeDecoderDataPtr(MimeDecoderData);</span>
<a href="#l14.23"></a><span id="l14.23" class="difflineminus">-[ptr] native MimeEncoderDataPtr(MimeEncoderData);</span>
<a href="#l14.24"></a><span id="l14.24" class="difflineminus">-native MimeConverterOutputCallback(MimeConverterOutputCallback);</span>
<a href="#l14.25"></a><span id="l14.25" class="difflineminus">-</span>
<a href="#l14.26"></a><span id="l14.26"> /**</span>
<a href="#l14.27"></a><span id="l14.27">  * Encode/decode mail headers (via libmime).</span>
<a href="#l14.28"></a><span id="l14.28">  */</span>
<a href="#l14.29"></a><span id="l14.29" class="difflineminus">-[scriptable, uuid(879f3aeb-b48a-40c1-ae94-ed8f6ecdbc90)]</span>
<a href="#l14.30"></a><span id="l14.30" class="difflineplus">+[scriptable, uuid(a2f56836-0de6-41b9-8902-ac33e4993e6b)]</span>
<a href="#l14.31"></a><span id="l14.31"> interface nsIMimeConverter : nsISupports {</span>
<a href="#l14.32"></a><span id="l14.32">   /**</span>
<a href="#l14.33"></a><span id="l14.33">    * Suggested byte length limit for use when calling</span>
<a href="#l14.34"></a><span id="l14.34">    * encodeMimePartIIStr(_UTF8).</span>
<a href="#l14.35"></a><span id="l14.35">    */</span>
<a href="#l14.36"></a><span id="l14.36">   const long MIME_ENCODED_WORD_SIZE = 72;</span>
<a href="#l14.37"></a><span id="l14.37">   const long MAX_CHARSET_NAME_LENGTH = 64;</span>
<a href="#l14.38"></a><span id="l14.38"> </span>
<a href="#l14.39"></a><span id="l14.39" class="difflineat">@@ -97,26 +82,10 @@ interface nsIMimeConverter : nsISupports</span>
<a href="#l14.40"></a><span id="l14.40">    * @param eatContinuations If true, unfold headers.</span>
<a href="#l14.41"></a><span id="l14.41">    *</span>
<a href="#l14.42"></a><span id="l14.42">    * @return UTF-16 encoded value as an AString.</span>
<a href="#l14.43"></a><span id="l14.43">    */</span>
<a href="#l14.44"></a><span id="l14.44">   AString decodeMimeHeader(in string header,</span>
<a href="#l14.45"></a><span id="l14.45">                            in string default_charset,</span>
<a href="#l14.46"></a><span id="l14.46">                            in boolean override_charset,</span>
<a href="#l14.47"></a><span id="l14.47">                            in boolean eatContinuations);</span>
<a href="#l14.48"></a><span id="l14.48" class="difflineminus">-</span>
<a href="#l14.49"></a><span id="l14.49" class="difflineminus">-  [noscript]</span>
<a href="#l14.50"></a><span id="l14.50" class="difflineminus">-  MimeEncoderDataPtr B64EncoderInit(in MimeConverterOutputCallback output_fn,</span>
<a href="#l14.51"></a><span id="l14.51" class="difflineminus">-                                    in voidPtr closure);</span>
<a href="#l14.52"></a><span id="l14.52" class="difflineminus">-</span>
<a href="#l14.53"></a><span id="l14.53" class="difflineminus">-  [noscript]</span>
<a href="#l14.54"></a><span id="l14.54" class="difflineminus">-  MimeEncoderDataPtr QPEncoderInit(in MimeConverterOutputCallback output_fn,</span>
<a href="#l14.55"></a><span id="l14.55" class="difflineminus">-                                   in voidPtr closure);</span>
<a href="#l14.56"></a><span id="l14.56" class="difflineminus">-</span>
<a href="#l14.57"></a><span id="l14.57" class="difflineminus">-  [noscript]</span>
<a href="#l14.58"></a><span id="l14.58" class="difflineminus">-  void EncoderDestroy(in MimeEncoderDataPtr data, in boolean abort_p);</span>
<a href="#l14.59"></a><span id="l14.59" class="difflineminus">-</span>
<a href="#l14.60"></a><span id="l14.60" class="difflineminus">-  [noscript]</span>
<a href="#l14.61"></a><span id="l14.61" class="difflineminus">-  long EncoderWrite(in MimeEncoderDataPtr data, in string buffer,</span>
<a href="#l14.62"></a><span id="l14.62" class="difflineminus">-                    in long size);</span>
<a href="#l14.63"></a><span id="l14.63" class="difflineminus">-</span>
<a href="#l14.64"></a><span id="l14.64"> };</span>
<a href="#l14.65"></a><span id="l14.65"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mailnews/mime/src/mimeenc.cpp</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mailnews/mime/src/mimeenc.cpp</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -1,21 +1,18 @@</span>
<a href="#l15.4"></a><span id="l15.4"> /* -*- Mode: C; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l15.5"></a><span id="l15.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l15.6"></a><span id="l15.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l15.7"></a><span id="l15.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l15.8"></a><span id="l15.8"> #include &lt;stdio.h&gt;</span>
<a href="#l15.9"></a><span id="l15.9" class="difflineminus">-#include &quot;modmimee.h&quot;</span>
<a href="#l15.10"></a><span id="l15.10"> #include &quot;mimei.h&quot;</span>
<a href="#l15.11"></a><span id="l15.11"> #include &quot;prmem.h&quot;</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-#include &quot;plstr.h&quot;</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineminus">-#include &quot;prlog.h&quot;</span>
<a href="#l15.14"></a><span id="l15.14" class="difflineminus">-#include &quot;prprf.h&quot;</span>
<a href="#l15.15"></a><span id="l15.15"> #include &quot;mimeobj.h&quot;</span>
<a href="#l15.16"></a><span id="l15.16" class="difflineminus">-#include &quot;nsIMimeConverter.h&quot; // for MimeConverterOutputCallback</span>
<a href="#l15.17"></a><span id="l15.17" class="difflineplus">+#include &quot;mozilla/RangedPtr.h&quot;</span>
<a href="#l15.18"></a><span id="l15.18" class="difflineplus">+#include &quot;mozilla/mailnews/MimeEncoder.h&quot;</span>
<a href="#l15.19"></a><span id="l15.19"> </span>
<a href="#l15.20"></a><span id="l15.20"> typedef enum mime_encoding {</span>
<a href="#l15.21"></a><span id="l15.21">   mime_Base64, mime_QuotedPrintable, mime_uuencode, mime_yencode</span>
<a href="#l15.22"></a><span id="l15.22"> } mime_encoding;</span>
<a href="#l15.23"></a><span id="l15.23"> </span>
<a href="#l15.24"></a><span id="l15.24"> typedef enum mime_decoder_state {</span>
<a href="#l15.25"></a><span id="l15.25">   DS_BEGIN, DS_BODY, DS_END</span>
<a href="#l15.26"></a><span id="l15.26"> } mime_decoder_state;</span>
<a href="#l15.27"></a><span id="l15.27" class="difflineat">@@ -828,389 +825,283 @@ MimeDecoderWrite (MimeDecoderData *data,</span>
<a href="#l15.28"></a><span id="l15.28">     return mime_decode_yenc_buffer (data, buffer, size, outSize);</span>
<a href="#l15.29"></a><span id="l15.29">   default:</span>
<a href="#l15.30"></a><span id="l15.30">     NS_ERROR(&quot;Invalid decoding&quot;);</span>
<a href="#l15.31"></a><span id="l15.31">     return -1;</span>
<a href="#l15.32"></a><span id="l15.32">   }</span>
<a href="#l15.33"></a><span id="l15.33"> }</span>
<a href="#l15.34"></a><span id="l15.34"> </span>
<a href="#l15.35"></a><span id="l15.35"> </span>
<a href="#l15.36"></a><span id="l15.36" class="difflineminus">-/* ================== Encoders.</span>
<a href="#l15.37"></a><span id="l15.37" class="difflineminus">- */</span>
<a href="#l15.38"></a><span id="l15.38" class="difflineplus">+namespace mozilla {</span>
<a href="#l15.39"></a><span id="l15.39" class="difflineplus">+namespace mailnews {</span>
<a href="#l15.40"></a><span id="l15.40"> </span>
<a href="#l15.41"></a><span id="l15.41" class="difflineminus">-struct MimeEncoderData {</span>
<a href="#l15.42"></a><span id="l15.42" class="difflineminus">-  mime_encoding encoding;    /* Which encoding to use */</span>
<a href="#l15.43"></a><span id="l15.43" class="difflineplus">+MimeEncoder::MimeEncoder(OutputCallback callback, void *closure)</span>
<a href="#l15.44"></a><span id="l15.44" class="difflineplus">+: mCallback(callback),</span>
<a href="#l15.45"></a><span id="l15.45" class="difflineplus">+  mClosure(closure),</span>
<a href="#l15.46"></a><span id="l15.46" class="difflineplus">+  mCurrentColumn(0)</span>
<a href="#l15.47"></a><span id="l15.47" class="difflineplus">+{}</span>
<a href="#l15.48"></a><span id="l15.48"> </span>
<a href="#l15.49"></a><span id="l15.49" class="difflineminus">-  /* Buffer for the base64 encoder. */</span>
<a href="#l15.50"></a><span id="l15.50" class="difflineplus">+class Base64Encoder : public MimeEncoder {</span>
<a href="#l15.51"></a><span id="l15.51">   unsigned char in_buffer[3];</span>
<a href="#l15.52"></a><span id="l15.52">   int32_t in_buffer_count;</span>
<a href="#l15.53"></a><span id="l15.53"> </span>
<a href="#l15.54"></a><span id="l15.54" class="difflineminus">-  /* Buffer for uuencoded data. (Need a line because of the length byte.) */</span>
<a href="#l15.55"></a><span id="l15.55" class="difflineminus">-  unsigned char uue_line_buf[128];</span>
<a href="#l15.56"></a><span id="l15.56" class="difflineminus">-  bool uue_wrote_begin;</span>
<a href="#l15.57"></a><span id="l15.57" class="difflineminus">-</span>
<a href="#l15.58"></a><span id="l15.58" class="difflineminus">-  int32_t current_column, line_byte_count;</span>
<a href="#l15.59"></a><span id="l15.59" class="difflineplus">+public:</span>
<a href="#l15.60"></a><span id="l15.60" class="difflineplus">+  Base64Encoder(OutputCallback callback, void *closure)</span>
<a href="#l15.61"></a><span id="l15.61" class="difflineplus">+    : MimeEncoder(callback, closure),</span>
<a href="#l15.62"></a><span id="l15.62" class="difflineplus">+      in_buffer_count(0) {}</span>
<a href="#l15.63"></a><span id="l15.63" class="difflineplus">+  virtual ~Base64Encoder() {}</span>
<a href="#l15.64"></a><span id="l15.64"> </span>
<a href="#l15.65"></a><span id="l15.65" class="difflineminus">-  char *filename; /* filename for use with uuencoding */</span>
<a href="#l15.66"></a><span id="l15.66" class="difflineplus">+  virtual nsresult Write(const char *buffer, int32_t size) MOZ_OVERRIDE;</span>
<a href="#l15.67"></a><span id="l15.67" class="difflineplus">+  virtual nsresult Flush() MOZ_OVERRIDE;</span>
<a href="#l15.68"></a><span id="l15.68"> </span>
<a href="#l15.69"></a><span id="l15.69" class="difflineminus">-  /* Where to write the encoded data */</span>
<a href="#l15.70"></a><span id="l15.70" class="difflineminus">-  MimeConverterOutputCallback write_buffer;</span>
<a href="#l15.71"></a><span id="l15.71" class="difflineminus">-  void *closure;</span>
<a href="#l15.72"></a><span id="l15.72" class="difflineplus">+private:</span>
<a href="#l15.73"></a><span id="l15.73" class="difflineplus">+  static void Base64EncodeBits(RangedPtr&lt;char&gt; &amp;out, uint32_t bits);</span>
<a href="#l15.74"></a><span id="l15.74"> };</span>
<a href="#l15.75"></a><span id="l15.75"> </span>
<a href="#l15.76"></a><span id="l15.76" class="difflineminus">-</span>
<a href="#l15.77"></a><span id="l15.77" class="difflineminus">-int</span>
<a href="#l15.78"></a><span id="l15.78" class="difflineminus">-mime_encode_base64_buffer (MimeEncoderData *data,</span>
<a href="#l15.79"></a><span id="l15.79" class="difflineminus">-               const char *buffer, int32_t size)</span>
<a href="#l15.80"></a><span id="l15.80" class="difflineplus">+nsresult Base64Encoder::Write(const char *buffer, int32_t size)</span>
<a href="#l15.81"></a><span id="l15.81"> {</span>
<a href="#l15.82"></a><span id="l15.82" class="difflineminus">-  int status = 0;</span>
<a href="#l15.83"></a><span id="l15.83" class="difflineminus">-  const unsigned char *in = (unsigned char *) buffer;</span>
<a href="#l15.84"></a><span id="l15.84" class="difflineminus">-  const unsigned char *end = in + size;</span>
<a href="#l15.85"></a><span id="l15.85" class="difflineminus">-  char out_buffer[80];</span>
<a href="#l15.86"></a><span id="l15.86" class="difflineminus">-  char *out = out_buffer;</span>
<a href="#l15.87"></a><span id="l15.87" class="difflineminus">-  uint32_t i = 0, n = 0;</span>
<a href="#l15.88"></a><span id="l15.88" class="difflineminus">-  uint32_t off;</span>
<a href="#l15.89"></a><span id="l15.89" class="difflineminus">-</span>
<a href="#l15.90"></a><span id="l15.90">   if (size == 0)</span>
<a href="#l15.91"></a><span id="l15.91" class="difflineminus">-  return 0;</span>
<a href="#l15.92"></a><span id="l15.92" class="difflineplus">+    return NS_OK;</span>
<a href="#l15.93"></a><span id="l15.93">   else if (size &lt; 0)</span>
<a href="#l15.94"></a><span id="l15.94">   {</span>
<a href="#l15.95"></a><span id="l15.95">     NS_ERROR(&quot;Size is less than 0&quot;);</span>
<a href="#l15.96"></a><span id="l15.96" class="difflineminus">-    return -1;</span>
<a href="#l15.97"></a><span id="l15.97" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l15.98"></a><span id="l15.98">   }</span>
<a href="#l15.99"></a><span id="l15.99"> </span>
<a href="#l15.100"></a><span id="l15.100" class="difflineminus">-</span>
<a href="#l15.101"></a><span id="l15.101" class="difflineminus">-  /* If this input buffer is too small, wait until next time. */</span>
<a href="#l15.102"></a><span id="l15.102" class="difflineminus">-  if (size &lt; (3 - data-&gt;in_buffer_count))</span>
<a href="#l15.103"></a><span id="l15.103" class="difflineplus">+  // If this input buffer is too small, wait until next time.</span>
<a href="#l15.104"></a><span id="l15.104" class="difflineplus">+  if (size &lt; (3 - in_buffer_count))</span>
<a href="#l15.105"></a><span id="l15.105">   {</span>
<a href="#l15.106"></a><span id="l15.106" class="difflineminus">-    NS_ASSERTION(size &lt; 3 &amp;&amp; size &gt; 0, &quot;1.1 &lt;rhp@netscape.com&gt; 19 Mar 1999 12:00&quot;);</span>
<a href="#l15.107"></a><span id="l15.107" class="difflineminus">-    data-&gt;in_buffer[data-&gt;in_buffer_count++] = buffer[0];</span>
<a href="#l15.108"></a><span id="l15.108" class="difflineminus">-    if (size &gt; 1)</span>
<a href="#l15.109"></a><span id="l15.109" class="difflineminus">-    data-&gt;in_buffer[data-&gt;in_buffer_count++] = buffer[1];</span>
<a href="#l15.110"></a><span id="l15.110" class="difflineminus">-    NS_ASSERTION(data-&gt;in_buffer_count &lt; 3, &quot;1.1 &lt;rhp@netscape.com&gt; 19 Mar 1999 12:00&quot;);</span>
<a href="#l15.111"></a><span id="l15.111" class="difflineminus">-    return 0;</span>
<a href="#l15.112"></a><span id="l15.112" class="difflineplus">+    NS_ASSERTION(size == 1 || size == 2, &quot;Unexpected size&quot;);</span>
<a href="#l15.113"></a><span id="l15.113" class="difflineplus">+    in_buffer[in_buffer_count++] = buffer[0];</span>
<a href="#l15.114"></a><span id="l15.114" class="difflineplus">+    if (size == 2)</span>
<a href="#l15.115"></a><span id="l15.115" class="difflineplus">+      in_buffer[in_buffer_count++] = buffer[1];</span>
<a href="#l15.116"></a><span id="l15.116" class="difflineplus">+    NS_ASSERTION(in_buffer_count &lt; 3, &quot;Unexpected out buffer size&quot;);</span>
<a href="#l15.117"></a><span id="l15.117" class="difflineplus">+    return NS_OK;</span>
<a href="#l15.118"></a><span id="l15.118">   }</span>
<a href="#l15.119"></a><span id="l15.119"> </span>
<a href="#l15.120"></a><span id="l15.120"> </span>
<a href="#l15.121"></a><span id="l15.121" class="difflineminus">-  /* If there are bytes that were put back last time, take them now.</span>
<a href="#l15.122"></a><span id="l15.122" class="difflineminus">-   */</span>
<a href="#l15.123"></a><span id="l15.123" class="difflineminus">-  i = 0;</span>
<a href="#l15.124"></a><span id="l15.124" class="difflineminus">-  if (data-&gt;in_buffer_count &gt; 0) n = data-&gt;in_buffer[0];</span>
<a href="#l15.125"></a><span id="l15.125" class="difflineminus">-  if (data-&gt;in_buffer_count &gt; 1) n = (n &lt;&lt; 8) + data-&gt;in_buffer[1];</span>
<a href="#l15.126"></a><span id="l15.126" class="difflineminus">-  i = data-&gt;in_buffer_count;</span>
<a href="#l15.127"></a><span id="l15.127" class="difflineminus">-  data-&gt;in_buffer_count = 0;</span>
<a href="#l15.128"></a><span id="l15.128" class="difflineplus">+  // If there are bytes that were put back last time, take them now.</span>
<a href="#l15.129"></a><span id="l15.129" class="difflineplus">+  uint32_t i = in_buffer_count, bits = 0;</span>
<a href="#l15.130"></a><span id="l15.130" class="difflineplus">+  if (in_buffer_count &gt; 0) bits = in_buffer[0];</span>
<a href="#l15.131"></a><span id="l15.131" class="difflineplus">+  if (in_buffer_count &gt; 1) bits = (bits &lt;&lt; 8) + in_buffer[1];</span>
<a href="#l15.132"></a><span id="l15.132" class="difflineplus">+  in_buffer_count = 0;</span>
<a href="#l15.133"></a><span id="l15.133"> </span>
<a href="#l15.134"></a><span id="l15.134" class="difflineminus">-  /* If this buffer is not a multiple of three, put one or two bytes back.</span>
<a href="#l15.135"></a><span id="l15.135" class="difflineminus">-   */</span>
<a href="#l15.136"></a><span id="l15.136" class="difflineminus">-  off = ((size + i) % 3);</span>
<a href="#l15.137"></a><span id="l15.137" class="difflineminus">-  if (off)</span>
<a href="#l15.138"></a><span id="l15.138" class="difflineplus">+  // If this buffer is not a multiple of three, put one or two bytes back.</span>
<a href="#l15.139"></a><span id="l15.139" class="difflineplus">+  uint32_t excess = ((size + i) % 3);</span>
<a href="#l15.140"></a><span id="l15.140" class="difflineplus">+  if (excess)</span>
<a href="#l15.141"></a><span id="l15.141">   {</span>
<a href="#l15.142"></a><span id="l15.142" class="difflineminus">-    data-&gt;in_buffer[0] = buffer [size - off];</span>
<a href="#l15.143"></a><span id="l15.143" class="difflineminus">-    if (off &gt; 1)</span>
<a href="#l15.144"></a><span id="l15.144" class="difflineminus">-    data-&gt;in_buffer [1] = buffer [size - off + 1];</span>
<a href="#l15.145"></a><span id="l15.145" class="difflineminus">-    data-&gt;in_buffer_count = off;</span>
<a href="#l15.146"></a><span id="l15.146" class="difflineminus">-    size -= off;</span>
<a href="#l15.147"></a><span id="l15.147" class="difflineplus">+    in_buffer[0] = buffer[size - excess];</span>
<a href="#l15.148"></a><span id="l15.148" class="difflineplus">+    if (excess &gt; 1)</span>
<a href="#l15.149"></a><span id="l15.149" class="difflineplus">+      in_buffer [1] = buffer[size - excess + 1];</span>
<a href="#l15.150"></a><span id="l15.150" class="difflineplus">+    in_buffer_count = excess;</span>
<a href="#l15.151"></a><span id="l15.151" class="difflineplus">+    size -= excess;</span>
<a href="#l15.152"></a><span id="l15.152">     NS_ASSERTION (! ((size + i) % 3), &quot;1.1 &lt;rhp@netscape.com&gt; 19 Mar 1999 12:00&quot;);</span>
<a href="#l15.153"></a><span id="l15.153" class="difflineminus">-    end = (unsigned char *) (buffer + size);</span>
<a href="#l15.154"></a><span id="l15.154">   }</span>
<a href="#l15.155"></a><span id="l15.155"> </span>
<a href="#l15.156"></a><span id="l15.156" class="difflineminus">-  /* Populate the out_buffer with base64 data, one line at a time.</span>
<a href="#l15.157"></a><span id="l15.157" class="difflineminus">-   */</span>
<a href="#l15.158"></a><span id="l15.158" class="difflineplus">+  const uint8_t *in = (const uint8_t *)buffer;</span>
<a href="#l15.159"></a><span id="l15.159" class="difflineplus">+  const uint8_t *end = (const uint8_t *)(buffer + size);</span>
<a href="#l15.160"></a><span id="l15.160" class="difflineplus">+  MOZ_ASSERT((end - in + i) % 3 == 0, &quot;Need a multiple of 3 bytes to decode&quot;);</span>
<a href="#l15.161"></a><span id="l15.161" class="difflineplus">+</span>
<a href="#l15.162"></a><span id="l15.162" class="difflineplus">+  // Populate the out_buffer with base64 data, one line at a time.</span>
<a href="#l15.163"></a><span id="l15.163" class="difflineplus">+  char out_buffer[80]; // Max line length will be 80, so this is safe.</span>
<a href="#l15.164"></a><span id="l15.164" class="difflineplus">+  RangedPtr&lt;char&gt; out(out_buffer);</span>
<a href="#l15.165"></a><span id="l15.165">   while (in &lt; end)</span>
<a href="#l15.166"></a><span id="l15.166">   {</span>
<a href="#l15.167"></a><span id="l15.167" class="difflineminus">-    int32_t j;</span>
<a href="#l15.168"></a><span id="l15.168" class="difflineminus">-</span>
<a href="#l15.169"></a><span id="l15.169" class="difflineplus">+    // Accumulate the input bits.</span>
<a href="#l15.170"></a><span id="l15.170">     while (i &lt; 3)</span>
<a href="#l15.171"></a><span id="l15.171">     {</span>
<a href="#l15.172"></a><span id="l15.172" class="difflineminus">-      n = (n &lt;&lt; 8) | *in++;</span>
<a href="#l15.173"></a><span id="l15.173" class="difflineplus">+      bits = (bits &lt;&lt; 8) | *in++;</span>
<a href="#l15.174"></a><span id="l15.174">       i++;</span>
<a href="#l15.175"></a><span id="l15.175">     }</span>
<a href="#l15.176"></a><span id="l15.176">     i = 0;</span>
<a href="#l15.177"></a><span id="l15.177"> </span>
<a href="#l15.178"></a><span id="l15.178" class="difflineminus">-    for (j = 18; j &gt;= 0; j -= 6)</span>
<a href="#l15.179"></a><span id="l15.179" class="difflineminus">-    {</span>
<a href="#l15.180"></a><span id="l15.180" class="difflineminus">-      unsigned int k = (n &gt;&gt; j) &amp; 0x3F;</span>
<a href="#l15.181"></a><span id="l15.181" class="difflineminus">-      if (k &lt; 26)       *out++ = k      + 'A';</span>
<a href="#l15.182"></a><span id="l15.182" class="difflineminus">-      else if (k &lt; 52)  *out++ = k - 26 + 'a';</span>
<a href="#l15.183"></a><span id="l15.183" class="difflineminus">-      else if (k &lt; 62)  *out++ = k - 52 + '0';</span>
<a href="#l15.184"></a><span id="l15.184" class="difflineminus">-      else if (k == 62) *out++ = '+';</span>
<a href="#l15.185"></a><span id="l15.185" class="difflineminus">-      else if (k == 63) *out++ = '/';</span>
<a href="#l15.186"></a><span id="l15.186" class="difflineminus">-      else abort ();</span>
<a href="#l15.187"></a><span id="l15.187" class="difflineminus">-    }</span>
<a href="#l15.188"></a><span id="l15.188" class="difflineplus">+    Base64EncodeBits(out, bits);</span>
<a href="#l15.189"></a><span id="l15.189"> </span>
<a href="#l15.190"></a><span id="l15.190" class="difflineminus">-    data-&gt;current_column += 4;</span>
<a href="#l15.191"></a><span id="l15.191" class="difflineminus">-    if (data-&gt;current_column &gt;= 72)</span>
<a href="#l15.192"></a><span id="l15.192" class="difflineplus">+    mCurrentColumn += 4;</span>
<a href="#l15.193"></a><span id="l15.193" class="difflineplus">+    if (mCurrentColumn &gt;= 72)</span>
<a href="#l15.194"></a><span id="l15.194">     {</span>
<a href="#l15.195"></a><span id="l15.195" class="difflineminus">-      /* Do a linebreak before column 76.  Flush out the line buffer. */</span>
<a href="#l15.196"></a><span id="l15.196" class="difflineminus">-      data-&gt;current_column = 0;</span>
<a href="#l15.197"></a><span id="l15.197" class="difflineminus">-      *out++ = '\015';</span>
<a href="#l15.198"></a><span id="l15.198" class="difflineminus">-      *out++ = '\012';</span>
<a href="#l15.199"></a><span id="l15.199" class="difflineminus">-      status = data-&gt;write_buffer (out_buffer, (out - out_buffer),</span>
<a href="#l15.200"></a><span id="l15.200" class="difflineminus">-                     data-&gt;closure);</span>
<a href="#l15.201"></a><span id="l15.201" class="difflineplus">+      // Do a linebreak before column 76.  Flush out the line buffer.</span>
<a href="#l15.202"></a><span id="l15.202" class="difflineplus">+      mCurrentColumn = 0;</span>
<a href="#l15.203"></a><span id="l15.203" class="difflineplus">+      *out++ = '\x0D';</span>
<a href="#l15.204"></a><span id="l15.204" class="difflineplus">+      *out++ = '\x0A';</span>
<a href="#l15.205"></a><span id="l15.205" class="difflineplus">+      nsresult rv = mCallback(out_buffer, (out.get() - out_buffer), mClosure);</span>
<a href="#l15.206"></a><span id="l15.206" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.207"></a><span id="l15.207">       out = out_buffer;</span>
<a href="#l15.208"></a><span id="l15.208" class="difflineminus">-      if (status &lt; 0) return status;</span>
<a href="#l15.209"></a><span id="l15.209">     }</span>
<a href="#l15.210"></a><span id="l15.210">   }</span>
<a href="#l15.211"></a><span id="l15.211"> </span>
<a href="#l15.212"></a><span id="l15.212" class="difflineminus">-  /* Write out the unwritten portion of the last line buffer. */</span>
<a href="#l15.213"></a><span id="l15.213" class="difflineminus">-  if (out &gt; out_buffer)</span>
<a href="#l15.214"></a><span id="l15.214" class="difflineplus">+  // Write out the unwritten portion of the last line buffer.</span>
<a href="#l15.215"></a><span id="l15.215" class="difflineplus">+  if (out.get() &gt; out_buffer)</span>
<a href="#l15.216"></a><span id="l15.216">   {</span>
<a href="#l15.217"></a><span id="l15.217" class="difflineminus">-    status = data-&gt;write_buffer (out_buffer, (out - out_buffer),</span>
<a href="#l15.218"></a><span id="l15.218" class="difflineminus">-                   data-&gt;closure);</span>
<a href="#l15.219"></a><span id="l15.219" class="difflineminus">-    if (status &lt; 0) return status;</span>
<a href="#l15.220"></a><span id="l15.220" class="difflineplus">+    nsresult rv = mCallback(out_buffer, out.get() - out_buffer, mClosure);</span>
<a href="#l15.221"></a><span id="l15.221" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.222"></a><span id="l15.222">   }</span>
<a href="#l15.223"></a><span id="l15.223"> </span>
<a href="#l15.224"></a><span id="l15.224" class="difflineminus">-  return 0;</span>
<a href="#l15.225"></a><span id="l15.225" class="difflineplus">+  return NS_OK;</span>
<a href="#l15.226"></a><span id="l15.226" class="difflineplus">+}</span>
<a href="#l15.227"></a><span id="l15.227" class="difflineplus">+</span>
<a href="#l15.228"></a><span id="l15.228" class="difflineplus">+nsresult Base64Encoder::Flush()</span>
<a href="#l15.229"></a><span id="l15.229" class="difflineplus">+{</span>
<a href="#l15.230"></a><span id="l15.230" class="difflineplus">+  if (in_buffer_count == 0)</span>
<a href="#l15.231"></a><span id="l15.231" class="difflineplus">+    return NS_OK;</span>
<a href="#l15.232"></a><span id="l15.232" class="difflineplus">+</span>
<a href="#l15.233"></a><span id="l15.233" class="difflineplus">+  // Since we need to some buffering to get a multiple of three bytes on each</span>
<a href="#l15.234"></a><span id="l15.234" class="difflineplus">+  // block, there may be a few bytes left in the buffer after the last block has</span>
<a href="#l15.235"></a><span id="l15.235" class="difflineplus">+  // been written. We need to flush those out now.</span>
<a href="#l15.236"></a><span id="l15.236" class="difflineplus">+  char buf[4];</span>
<a href="#l15.237"></a><span id="l15.237" class="difflineplus">+  RangedPtr&lt;char&gt; out(buf);</span>
<a href="#l15.238"></a><span id="l15.238" class="difflineplus">+  uint32_t bits = ((uint32_t)in_buffer[0]) &lt;&lt; 16;</span>
<a href="#l15.239"></a><span id="l15.239" class="difflineplus">+  if (in_buffer_count &gt; 1)</span>
<a href="#l15.240"></a><span id="l15.240" class="difflineplus">+    bits |= (((uint32_t)in_buffer[1]) &lt;&lt; 8);</span>
<a href="#l15.241"></a><span id="l15.241" class="difflineplus">+</span>
<a href="#l15.242"></a><span id="l15.242" class="difflineplus">+  Base64EncodeBits(out, bits);</span>
<a href="#l15.243"></a><span id="l15.243" class="difflineplus">+</span>
<a href="#l15.244"></a><span id="l15.244" class="difflineplus">+  // Pad with equal-signs.</span>
<a href="#l15.245"></a><span id="l15.245" class="difflineplus">+  if (in_buffer_count == 1)</span>
<a href="#l15.246"></a><span id="l15.246" class="difflineplus">+    buf[2] = '=';</span>
<a href="#l15.247"></a><span id="l15.247" class="difflineplus">+  buf[3] = '=';</span>
<a href="#l15.248"></a><span id="l15.248" class="difflineplus">+</span>
<a href="#l15.249"></a><span id="l15.249" class="difflineplus">+  return mCallback(buf, 4, mClosure);</span>
<a href="#l15.250"></a><span id="l15.250"> }</span>
<a href="#l15.251"></a><span id="l15.251"> </span>
<a href="#l15.252"></a><span id="l15.252" class="difflineminus">-</span>
<a href="#l15.253"></a><span id="l15.253" class="difflineminus">-int</span>
<a href="#l15.254"></a><span id="l15.254" class="difflineminus">-mime_encode_qp_buffer (MimeEncoderData *data, const char *buffer, int32_t size)</span>
<a href="#l15.255"></a><span id="l15.255" class="difflineplus">+void Base64Encoder::Base64EncodeBits(RangedPtr&lt;char&gt; &amp;out, uint32_t bits)</span>
<a href="#l15.256"></a><span id="l15.256"> {</span>
<a href="#l15.257"></a><span id="l15.257" class="difflineminus">-  int status = 0;</span>
<a href="#l15.258"></a><span id="l15.258" class="difflineminus">-  static const char hexdigits[] = &quot;0123456789ABCDEF&quot;;</span>
<a href="#l15.259"></a><span id="l15.259" class="difflineminus">-  const unsigned char *in = (unsigned char *) buffer;</span>
<a href="#l15.260"></a><span id="l15.260" class="difflineminus">-  const unsigned char *end = in + size;</span>
<a href="#l15.261"></a><span id="l15.261" class="difflineplus">+  // Convert 3 bytes to 4 base64 bytes</span>
<a href="#l15.262"></a><span id="l15.262" class="difflineplus">+  for (int32_t j = 18; j &gt;= 0; j -= 6)</span>
<a href="#l15.263"></a><span id="l15.263" class="difflineplus">+  {</span>
<a href="#l15.264"></a><span id="l15.264" class="difflineplus">+    unsigned int k = (bits &gt;&gt; j) &amp; 0x3F;</span>
<a href="#l15.265"></a><span id="l15.265" class="difflineplus">+    if (k &lt; 26)       *out++ = k      + 'A';</span>
<a href="#l15.266"></a><span id="l15.266" class="difflineplus">+    else if (k &lt; 52)  *out++ = k - 26 + 'a';</span>
<a href="#l15.267"></a><span id="l15.267" class="difflineplus">+    else if (k &lt; 62)  *out++ = k - 52 + '0';</span>
<a href="#l15.268"></a><span id="l15.268" class="difflineplus">+    else if (k == 62) *out++ = '+';</span>
<a href="#l15.269"></a><span id="l15.269" class="difflineplus">+    else if (k == 63) *out++ = '/';</span>
<a href="#l15.270"></a><span id="l15.270" class="difflineplus">+    else MOZ_NOT_REACHED(&quot;6 bits should only be between 0 and 64&quot;);</span>
<a href="#l15.271"></a><span id="l15.271" class="difflineplus">+  }</span>
<a href="#l15.272"></a><span id="l15.272" class="difflineplus">+}</span>
<a href="#l15.273"></a><span id="l15.273" class="difflineplus">+</span>
<a href="#l15.274"></a><span id="l15.274" class="difflineplus">+class QPEncoder : public MimeEncoder {</span>
<a href="#l15.275"></a><span id="l15.275" class="difflineplus">+public:</span>
<a href="#l15.276"></a><span id="l15.276" class="difflineplus">+  QPEncoder(OutputCallback callback, void *closure)</span>
<a href="#l15.277"></a><span id="l15.277" class="difflineplus">+    : MimeEncoder(callback, closure) {}</span>
<a href="#l15.278"></a><span id="l15.278" class="difflineplus">+  virtual ~QPEncoder() {}</span>
<a href="#l15.279"></a><span id="l15.279" class="difflineplus">+</span>
<a href="#l15.280"></a><span id="l15.280" class="difflineplus">+  virtual nsresult Write(const char *buffer, int32_t size) MOZ_OVERRIDE;</span>
<a href="#l15.281"></a><span id="l15.281" class="difflineplus">+};</span>
<a href="#l15.282"></a><span id="l15.282" class="difflineplus">+</span>
<a href="#l15.283"></a><span id="l15.283" class="difflineplus">+nsresult QPEncoder::Write(const char *buffer, int32_t size)</span>
<a href="#l15.284"></a><span id="l15.284" class="difflineplus">+{</span>
<a href="#l15.285"></a><span id="l15.285" class="difflineplus">+  nsresult rv = NS_OK;</span>
<a href="#l15.286"></a><span id="l15.286" class="difflineplus">+  static const char *hexdigits = &quot;0123456789ABCDEF&quot;;</span>
<a href="#l15.287"></a><span id="l15.287">   char out_buffer[80];</span>
<a href="#l15.288"></a><span id="l15.288" class="difflineminus">-  char *out = out_buffer;</span>
<a href="#l15.289"></a><span id="l15.289" class="difflineplus">+  RangedPtr&lt;char&gt; out(out_buffer);</span>
<a href="#l15.290"></a><span id="l15.290">   bool white = false;</span>
<a href="#l15.291"></a><span id="l15.291" class="difflineminus">-  bool mb_p = false;</span>
<a href="#l15.292"></a><span id="l15.292"> </span>
<a href="#l15.293"></a><span id="l15.293" class="difflineminus">-  /*</span>
<a href="#l15.294"></a><span id="l15.294" class="difflineminus">-  #### I don't know how to hook this back up:</span>
<a href="#l15.295"></a><span id="l15.295" class="difflineminus">-  ####  mb_p = INTL_DefaultWinCharSetID(state-&gt;context) &amp; 0x300 ;</span>
<a href="#l15.296"></a><span id="l15.296" class="difflineminus">-  */</span>
<a href="#l15.297"></a><span id="l15.297" class="difflineminus">-</span>
<a href="#l15.298"></a><span id="l15.298" class="difflineminus">-</span>
<a href="#l15.299"></a><span id="l15.299" class="difflineminus">-  NS_ASSERTION(data-&gt;in_buffer_count == 0, &quot;1.1 &lt;rhp@netscape.com&gt; 19 Mar 1999 12:00&quot;);</span>
<a href="#l15.300"></a><span id="l15.300" class="difflineminus">-</span>
<a href="#l15.301"></a><span id="l15.301" class="difflineminus">-  /* Populate the out_buffer with quoted-printable data, one line at a time.</span>
<a href="#l15.302"></a><span id="l15.302" class="difflineminus">-  */</span>
<a href="#l15.303"></a><span id="l15.303" class="difflineplus">+  // Populate the out_buffer with quoted-printable data, one line at a time.</span>
<a href="#l15.304"></a><span id="l15.304" class="difflineplus">+  const uint8_t *in = (uint8_t *)buffer;</span>
<a href="#l15.305"></a><span id="l15.305" class="difflineplus">+  const uint8_t *end = in + size;</span>
<a href="#l15.306"></a><span id="l15.306">   for (; in &lt; end; in++)</span>
<a href="#l15.307"></a><span id="l15.307">   {</span>
<a href="#l15.308"></a><span id="l15.308">     if (*in == '\r' || *in == '\n')</span>
<a href="#l15.309"></a><span id="l15.309">     {</span>
<a href="#l15.310"></a><span id="l15.310" class="difflineplus">+      // If it's CRLF, swallow two chars instead of one.</span>
<a href="#l15.311"></a><span id="l15.311" class="difflineplus">+      if (in + 1 &lt; end &amp;&amp; in[0] == '\r' &amp;&amp; in[1] == '\n')</span>
<a href="#l15.312"></a><span id="l15.312" class="difflineplus">+        in++;</span>
<a href="#l15.313"></a><span id="l15.313"> </span>
<a href="#l15.314"></a><span id="l15.314" class="difflineminus">-    /* Whitespace cannot be allowed to occur at the end of</span>
<a href="#l15.315"></a><span id="l15.315" class="difflineminus">-    the line, so we backup and replace the whitespace with</span>
<a href="#l15.316"></a><span id="l15.316" class="difflineminus">-    its code.</span>
<a href="#l15.317"></a><span id="l15.317" class="difflineminus">-      */</span>
<a href="#l15.318"></a><span id="l15.318" class="difflineplus">+      // Whitespace cannot be allowed to occur at the end of the line, so we</span>
<a href="#l15.319"></a><span id="l15.319" class="difflineplus">+      // back up and replace the whitespace with its code.</span>
<a href="#l15.320"></a><span id="l15.320">       if (white)</span>
<a href="#l15.321"></a><span id="l15.321">       {</span>
<a href="#l15.322"></a><span id="l15.322">         out--;</span>
<a href="#l15.323"></a><span id="l15.323">         char whitespace_char = *out;</span>
<a href="#l15.324"></a><span id="l15.324">         *out++ = '=';</span>
<a href="#l15.325"></a><span id="l15.325">         *out++ = hexdigits[whitespace_char &gt;&gt; 4];</span>
<a href="#l15.326"></a><span id="l15.326">         *out++ = hexdigits[whitespace_char &amp; 0xF];</span>
<a href="#l15.327"></a><span id="l15.327">       }</span>
<a href="#l15.328"></a><span id="l15.328"> </span>
<a href="#l15.329"></a><span id="l15.329" class="difflineminus">-      /* Now write out the newline. */</span>
<a href="#l15.330"></a><span id="l15.330" class="difflineplus">+      // Now write out the newline.</span>
<a href="#l15.331"></a><span id="l15.331">       *out++ = '\r';</span>
<a href="#l15.332"></a><span id="l15.332">       *out++ = '\n';</span>
<a href="#l15.333"></a><span id="l15.333">       white = false;</span>
<a href="#l15.334"></a><span id="l15.334"> </span>
<a href="#l15.335"></a><span id="l15.335" class="difflineminus">-      status = data-&gt;write_buffer (out_buffer, (out - out_buffer),</span>
<a href="#l15.336"></a><span id="l15.336" class="difflineminus">-        data-&gt;closure);</span>
<a href="#l15.337"></a><span id="l15.337" class="difflineminus">-      if (status &lt; 0) return status;</span>
<a href="#l15.338"></a><span id="l15.338" class="difflineplus">+      rv = mCallback(out_buffer, out.get() - out_buffer, mClosure);</span>
<a href="#l15.339"></a><span id="l15.339" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.340"></a><span id="l15.340">       out = out_buffer;</span>
<a href="#l15.341"></a><span id="l15.341" class="difflineminus">-</span>
<a href="#l15.342"></a><span id="l15.342" class="difflineminus">-      /* If it's CRLF, swallow two chars instead of one. */</span>
<a href="#l15.343"></a><span id="l15.343" class="difflineminus">-      if (in + 1 &lt; end &amp;&amp; in[0] == '\r' &amp;&amp; in[1] == '\n')</span>
<a href="#l15.344"></a><span id="l15.344" class="difflineminus">-        in++;</span>
<a href="#l15.345"></a><span id="l15.345" class="difflineminus">-</span>
<a href="#l15.346"></a><span id="l15.346" class="difflineminus">-      out = out_buffer;</span>
<a href="#l15.347"></a><span id="l15.347" class="difflineminus">-      white = false;</span>
<a href="#l15.348"></a><span id="l15.348" class="difflineminus">-      data-&gt;current_column = 0;</span>
<a href="#l15.349"></a><span id="l15.349" class="difflineplus">+      mCurrentColumn = 0;</span>
<a href="#l15.350"></a><span id="l15.350">     }</span>
<a href="#l15.351"></a><span id="l15.351" class="difflineminus">-    else if (data-&gt;current_column == 0 &amp;&amp; *in == '.')</span>
<a href="#l15.352"></a><span id="l15.352" class="difflineplus">+    else if (mCurrentColumn == 0 &amp;&amp; *in == '.')</span>
<a href="#l15.353"></a><span id="l15.353">     {</span>
<a href="#l15.354"></a><span id="l15.354" class="difflineminus">-      /* Just to be SMTP-safe, if &quot;.&quot; appears in column 0, encode it.</span>
<a href="#l15.355"></a><span id="l15.355" class="difflineminus">-                  (mmencode does this too.)</span>
<a href="#l15.356"></a><span id="l15.356" class="difflineminus">-      */</span>
<a href="#l15.357"></a><span id="l15.357" class="difflineplus">+      // Just to be SMTP-safe, if &quot;.&quot; appears in column 0, encode it.</span>
<a href="#l15.358"></a><span id="l15.358">       goto HEX;</span>
<a href="#l15.359"></a><span id="l15.359">     }</span>
<a href="#l15.360"></a><span id="l15.360" class="difflineminus">-    else if (data-&gt;current_column == 0 &amp;&amp; *in == 'F'</span>
<a href="#l15.361"></a><span id="l15.361" class="difflineminus">-         &amp;&amp; (in &gt;= end-1 || in[1] == 'r')</span>
<a href="#l15.362"></a><span id="l15.362" class="difflineminus">-                           &amp;&amp; (in &gt;= end-2 || in[2] == 'o')</span>
<a href="#l15.363"></a><span id="l15.363" class="difflineminus">-                           &amp;&amp; (in &gt;= end-3 || in[3] == 'm')</span>
<a href="#l15.364"></a><span id="l15.364" class="difflineminus">-                           &amp;&amp; (in &gt;= end-4 || in[4] == ' '))</span>
<a href="#l15.365"></a><span id="l15.365" class="difflineplus">+    else if (mCurrentColumn == 0 &amp;&amp; *in == 'F'</span>
<a href="#l15.366"></a><span id="l15.366" class="difflineplus">+               &amp;&amp; (in &gt;= end-1 || in[1] == 'r')</span>
<a href="#l15.367"></a><span id="l15.367" class="difflineplus">+               &amp;&amp; (in &gt;= end-2 || in[2] == 'o')</span>
<a href="#l15.368"></a><span id="l15.368" class="difflineplus">+               &amp;&amp; (in &gt;= end-3 || in[3] == 'm')</span>
<a href="#l15.369"></a><span id="l15.369" class="difflineplus">+               &amp;&amp; (in &gt;= end-4 || in[4] == ' '))</span>
<a href="#l15.370"></a><span id="l15.370">     {</span>
<a href="#l15.371"></a><span id="l15.371" class="difflineminus">-      /* If this line begins with 'F' and we cannot determine that</span>
<a href="#l15.372"></a><span id="l15.372" class="difflineminus">-                  this line does not begin with &quot;From &quot; then do the safe thing</span>
<a href="#l15.373"></a><span id="l15.373" class="difflineminus">-                  and assume that it does, and encode the 'F' in hex to avoid</span>
<a href="#l15.374"></a><span id="l15.374" class="difflineminus">-                  BSD mailbox lossage.  (We might not be able to tell that it</span>
<a href="#l15.375"></a><span id="l15.375" class="difflineminus">-                  is really &quot;From &quot; if the end of the buffer was early.  So</span>
<a href="#l15.376"></a><span id="l15.376" class="difflineminus">-                  this means that &quot;\nFoot&quot; will have the F encoded if the end of</span>
<a href="#l15.377"></a><span id="l15.377" class="difflineminus">-                  the buffer happens to fall just after the F; but will not have</span>
<a href="#l15.378"></a><span id="l15.378" class="difflineminus">-                  it encoded if it's after the first &quot;o&quot; or later.  Oh well.</span>
<a href="#l15.379"></a><span id="l15.379" class="difflineminus">-                  It's a little inconsistent, but it errs on the safe side.)</span>
<a href="#l15.380"></a><span id="l15.380" class="difflineminus">-      */</span>
<a href="#l15.381"></a><span id="l15.381" class="difflineplus">+      // If this line begins with &quot;From &quot; (or it could but we don't have enough</span>
<a href="#l15.382"></a><span id="l15.382" class="difflineplus">+      // data in the buffer to be certain), encode the 'F' in hex to avoid</span>
<a href="#l15.383"></a><span id="l15.383" class="difflineplus">+      // potential problems with BSD mailbox formats.</span>
<a href="#l15.384"></a><span id="l15.384">       goto HEX;</span>
<a href="#l15.385"></a><span id="l15.385">     }</span>
<a href="#l15.386"></a><span id="l15.386" class="difflineminus">-    else if ((*in &gt;= 33 &amp;&amp; *in &lt;= 60) ||    /* safe printing chars */</span>
<a href="#l15.387"></a><span id="l15.387" class="difflineminus">-         (*in &gt;= 62 &amp;&amp; *in &lt;= 126) ||</span>
<a href="#l15.388"></a><span id="l15.388" class="difflineminus">-                           (mb_p &amp;&amp; (*in == 61 || *in == 127 || *in == 0x1B)))</span>
<a href="#l15.389"></a><span id="l15.389" class="difflineplus">+    else if ((*in &gt;= 33 &amp;&amp; *in &lt;= 60) |</span>
<a href="#l15.390"></a><span id="l15.390" class="difflineplus">+             (*in &gt;= 62 &amp;&amp; *in &lt;= 126)) // Printable characters except for '='</span>
<a href="#l15.391"></a><span id="l15.391">     {</span>
<a href="#l15.392"></a><span id="l15.392">       white = false;</span>
<a href="#l15.393"></a><span id="l15.393">       *out++ = *in;</span>
<a href="#l15.394"></a><span id="l15.394" class="difflineminus">-      data-&gt;current_column++;</span>
<a href="#l15.395"></a><span id="l15.395" class="difflineplus">+      mCurrentColumn++;</span>
<a href="#l15.396"></a><span id="l15.396">     }</span>
<a href="#l15.397"></a><span id="l15.397" class="difflineminus">-    else if (*in == ' ' || *in == '\t')    /* whitespace */</span>
<a href="#l15.398"></a><span id="l15.398" class="difflineplus">+    else if (*in == ' ' || *in == '\t') // Whitespace</span>
<a href="#l15.399"></a><span id="l15.399">     {</span>
<a href="#l15.400"></a><span id="l15.400">       white = true;</span>
<a href="#l15.401"></a><span id="l15.401">       *out++ = *in;</span>
<a href="#l15.402"></a><span id="l15.402" class="difflineminus">-      data-&gt;current_column++;</span>
<a href="#l15.403"></a><span id="l15.403" class="difflineplus">+      mCurrentColumn++;</span>
<a href="#l15.404"></a><span id="l15.404">     }</span>
<a href="#l15.405"></a><span id="l15.405" class="difflineminus">-    else                    /* print as =FF */</span>
<a href="#l15.406"></a><span id="l15.406" class="difflineplus">+    else</span>
<a href="#l15.407"></a><span id="l15.407">     {</span>
<a href="#l15.408"></a><span id="l15.408" class="difflineplus">+      // Encode the characters here</span>
<a href="#l15.409"></a><span id="l15.409"> HEX:</span>
<a href="#l15.410"></a><span id="l15.410">       white = false;</span>
<a href="#l15.411"></a><span id="l15.411" class="difflineminus">-                  *out++ = '=';</span>
<a href="#l15.412"></a><span id="l15.412" class="difflineminus">-                  *out++ = hexdigits[*in &gt;&gt; 4];</span>
<a href="#l15.413"></a><span id="l15.413" class="difflineminus">-                  *out++ = hexdigits[*in &amp; 0xF];</span>
<a href="#l15.414"></a><span id="l15.414" class="difflineminus">-                  data-&gt;current_column += 3;</span>
<a href="#l15.415"></a><span id="l15.415" class="difflineplus">+      *out++ = '=';</span>
<a href="#l15.416"></a><span id="l15.416" class="difflineplus">+      *out++ = hexdigits[*in &gt;&gt; 4];</span>
<a href="#l15.417"></a><span id="l15.417" class="difflineplus">+      *out++ = hexdigits[*in &amp; 0xF];</span>
<a href="#l15.418"></a><span id="l15.418" class="difflineplus">+      mCurrentColumn += 3;</span>
<a href="#l15.419"></a><span id="l15.419">     }</span>
<a href="#l15.420"></a><span id="l15.420"> </span>
<a href="#l15.421"></a><span id="l15.421" class="difflineminus">-    NS_ASSERTION (data-&gt;current_column &lt;= 76, &quot;1.1 &lt;rhp@netscape.com&gt; 19 Mar 1999 12:00&quot;); /* Hard limit required by spec */</span>
<a href="#l15.422"></a><span id="l15.422" class="difflineplus">+    MOZ_ASSERT(mCurrentColumn &lt;= 76, &quot;Why haven't we added a line break yet?&quot;);</span>
<a href="#l15.423"></a><span id="l15.423"> </span>
<a href="#l15.424"></a><span id="l15.424" class="difflineminus">-    if (data-&gt;current_column &gt;= 73)    /* soft line break: &quot;=\r\n&quot; */</span>
<a href="#l15.425"></a><span id="l15.425" class="difflineplus">+    if (mCurrentColumn &gt;= 73) // Soft line break for readability</span>
<a href="#l15.426"></a><span id="l15.426">     {</span>
<a href="#l15.427"></a><span id="l15.427">       *out++ = '=';</span>
<a href="#l15.428"></a><span id="l15.428">       *out++ = '\r';</span>
<a href="#l15.429"></a><span id="l15.429">       *out++ = '\n';</span>
<a href="#l15.430"></a><span id="l15.430"> </span>
<a href="#l15.431"></a><span id="l15.431" class="difflineminus">-      status = data-&gt;write_buffer (out_buffer, (out - out_buffer),</span>
<a href="#l15.432"></a><span id="l15.432" class="difflineminus">-        data-&gt;closure);</span>
<a href="#l15.433"></a><span id="l15.433" class="difflineminus">-      if (status &lt; 0) return status;</span>
<a href="#l15.434"></a><span id="l15.434" class="difflineplus">+      rv = mCallback(out_buffer, out.get() - out_buffer, mClosure);</span>
<a href="#l15.435"></a><span id="l15.435" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.436"></a><span id="l15.436">       out = out_buffer;</span>
<a href="#l15.437"></a><span id="l15.437">       white = false;</span>
<a href="#l15.438"></a><span id="l15.438" class="difflineminus">-      data-&gt;current_column = 0;</span>
<a href="#l15.439"></a><span id="l15.439" class="difflineplus">+      mCurrentColumn = 0;</span>
<a href="#l15.440"></a><span id="l15.440">     }</span>
<a href="#l15.441"></a><span id="l15.441">   }</span>
<a href="#l15.442"></a><span id="l15.442"> </span>
<a href="#l15.443"></a><span id="l15.443" class="difflineminus">-  /* Write out the unwritten portion of the last line buffer. */</span>
<a href="#l15.444"></a><span id="l15.444" class="difflineminus">-  if (out &gt; out_buffer)</span>
<a href="#l15.445"></a><span id="l15.445" class="difflineplus">+  // Write out the unwritten portion of the last line buffer.</span>
<a href="#l15.446"></a><span id="l15.446" class="difflineplus">+  if (out.get() != out_buffer)</span>
<a href="#l15.447"></a><span id="l15.447">   {</span>
<a href="#l15.448"></a><span id="l15.448" class="difflineminus">-    status = data-&gt;write_buffer (out_buffer, (out - out_buffer),</span>
<a href="#l15.449"></a><span id="l15.449" class="difflineminus">-      data-&gt;closure);</span>
<a href="#l15.450"></a><span id="l15.450" class="difflineminus">-    if (status &lt; 0) return status;</span>
<a href="#l15.451"></a><span id="l15.451" class="difflineplus">+    rv = mCallback(out_buffer, out.get() - out_buffer, mClosure);</span>
<a href="#l15.452"></a><span id="l15.452" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.453"></a><span id="l15.453">   }</span>
<a href="#l15.454"></a><span id="l15.454"> </span>
<a href="#l15.455"></a><span id="l15.455" class="difflineminus">-  return 0;</span>
<a href="#l15.456"></a><span id="l15.456" class="difflineplus">+  return NS_OK;</span>
<a href="#l15.457"></a><span id="l15.457"> }</span>
<a href="#l15.458"></a><span id="l15.458"> </span>
<a href="#l15.459"></a><span id="l15.459" class="difflineminus">-</span>
<a href="#l15.460"></a><span id="l15.460" class="difflineminus">-</span>
<a href="#l15.461"></a><span id="l15.461" class="difflineminus">-int</span>
<a href="#l15.462"></a><span id="l15.462" class="difflineminus">-MimeEncoderDestroy (MimeEncoderData *data, bool abort_p)</span>
<a href="#l15.463"></a><span id="l15.463" class="difflineplus">+MimeEncoder *MimeEncoder::GetBase64Encoder(OutputCallback callback,</span>
<a href="#l15.464"></a><span id="l15.464" class="difflineplus">+    void *closure)</span>
<a href="#l15.465"></a><span id="l15.465"> {</span>
<a href="#l15.466"></a><span id="l15.466" class="difflineminus">-  int status = 0;</span>
<a href="#l15.467"></a><span id="l15.467" class="difflineminus">-</span>
<a href="#l15.468"></a><span id="l15.468" class="difflineminus">-  /* Since Base64 output needs to do some buffering to get</span>
<a href="#l15.469"></a><span id="l15.469" class="difflineminus">-   a multiple of three bytes on each block, there may be a few bytes</span>
<a href="#l15.470"></a><span id="l15.470" class="difflineminus">-   left in the buffer after the last block has been written.  We need to</span>
<a href="#l15.471"></a><span id="l15.471" class="difflineminus">-   flush those out now.</span>
<a href="#l15.472"></a><span id="l15.472" class="difflineminus">-   */</span>
<a href="#l15.473"></a><span id="l15.473" class="difflineminus">-</span>
<a href="#l15.474"></a><span id="l15.474" class="difflineminus">-  NS_ASSERTION (data-&gt;encoding == mime_Base64 ||</span>
<a href="#l15.475"></a><span id="l15.475" class="difflineminus">-       data-&gt;in_buffer_count == 0, &quot;1.1 &lt;rhp@netscape.com&gt; 19 Mar 1999 12:00&quot;);</span>
<a href="#l15.476"></a><span id="l15.476" class="difflineminus">-</span>
<a href="#l15.477"></a><span id="l15.477" class="difflineminus">-  if (!abort_p &amp;&amp;</span>
<a href="#l15.478"></a><span id="l15.478" class="difflineminus">-    data-&gt;in_buffer_count &gt; 0)</span>
<a href="#l15.479"></a><span id="l15.479" class="difflineminus">-  {</span>
<a href="#l15.480"></a><span id="l15.480" class="difflineminus">-    char buf2 [6];</span>
<a href="#l15.481"></a><span id="l15.481" class="difflineminus">-    char *buf = buf2 + 2;</span>
<a href="#l15.482"></a><span id="l15.482" class="difflineminus">-    char *out = buf;</span>
<a href="#l15.483"></a><span id="l15.483" class="difflineminus">-    int j;</span>
<a href="#l15.484"></a><span id="l15.484" class="difflineminus">-    /* fixed bug 55998, 61302, 61866</span>
<a href="#l15.485"></a><span id="l15.485" class="difflineminus">-     * type casting to uint32_t before shifting</span>
<a href="#l15.486"></a><span id="l15.486" class="difflineminus">-     */</span>
<a href="#l15.487"></a><span id="l15.487" class="difflineminus">-    uint32_t n = ((uint32_t) data-&gt;in_buffer[0]) &lt;&lt; 16;</span>
<a href="#l15.488"></a><span id="l15.488" class="difflineminus">-    if (data-&gt;in_buffer_count &gt; 1)</span>
<a href="#l15.489"></a><span id="l15.489" class="difflineminus">-    n = n | (((uint32_t) data-&gt;in_buffer[1]) &lt;&lt; 8);</span>
<a href="#l15.490"></a><span id="l15.490" class="difflineminus">-</span>
<a href="#l15.491"></a><span id="l15.491" class="difflineminus">-    buf2[0] = '\r';</span>
<a href="#l15.492"></a><span id="l15.492" class="difflineminus">-    buf2[1] = '\n';</span>
<a href="#l15.493"></a><span id="l15.493" class="difflineminus">-</span>
<a href="#l15.494"></a><span id="l15.494" class="difflineminus">-    for (j = 18; j &gt;= 0; j -= 6)</span>
<a href="#l15.495"></a><span id="l15.495" class="difflineminus">-    {</span>
<a href="#l15.496"></a><span id="l15.496" class="difflineminus">-      unsigned int k = (n &gt;&gt; j) &amp; 0x3F;</span>
<a href="#l15.497"></a><span id="l15.497" class="difflineminus">-      if (k &lt; 26)       *out++ = k      + 'A';</span>
<a href="#l15.498"></a><span id="l15.498" class="difflineminus">-      else if (k &lt; 52)  *out++ = k - 26 + 'a';</span>
<a href="#l15.499"></a><span id="l15.499" class="difflineminus">-      else if (k &lt; 62)  *out++ = k - 52 + '0';</span>
<a href="#l15.500"></a><span id="l15.500" class="difflineminus">-      else if (k == 62) *out++ = '+';</span>
<a href="#l15.501"></a><span id="l15.501" class="difflineminus">-      else if (k == 63) *out++ = '/';</span>
<a href="#l15.502"></a><span id="l15.502" class="difflineminus">-      else abort ();</span>
<a href="#l15.503"></a><span id="l15.503" class="difflineminus">-    }</span>
<a href="#l15.504"></a><span id="l15.504" class="difflineminus">-</span>
<a href="#l15.505"></a><span id="l15.505" class="difflineminus">-    /* Pad with equal-signs. */</span>
<a href="#l15.506"></a><span id="l15.506" class="difflineminus">-    if (data-&gt;in_buffer_count == 1)</span>
<a href="#l15.507"></a><span id="l15.507" class="difflineminus">-    buf[2] = '=';</span>
<a href="#l15.508"></a><span id="l15.508" class="difflineminus">-    buf[3] = '=';</span>
<a href="#l15.509"></a><span id="l15.509" class="difflineminus">-</span>
<a href="#l15.510"></a><span id="l15.510" class="difflineminus">-    if (data-&gt;current_column &gt;= 72)</span>
<a href="#l15.511"></a><span id="l15.511" class="difflineminus">-    status = data-&gt;write_buffer (buf2, 6, data-&gt;closure);</span>
<a href="#l15.512"></a><span id="l15.512" class="difflineminus">-    else</span>
<a href="#l15.513"></a><span id="l15.513" class="difflineminus">-    status = data-&gt;write_buffer (buf,  4, data-&gt;closure);</span>
<a href="#l15.514"></a><span id="l15.514" class="difflineminus">-  }</span>
<a href="#l15.515"></a><span id="l15.515" class="difflineminus">-</span>
<a href="#l15.516"></a><span id="l15.516" class="difflineminus">-  PR_FREEIF(data-&gt;filename);</span>
<a href="#l15.517"></a><span id="l15.517" class="difflineminus">-  PR_Free (data);</span>
<a href="#l15.518"></a><span id="l15.518" class="difflineminus">-  return status;</span>
<a href="#l15.519"></a><span id="l15.519" class="difflineplus">+  return new Base64Encoder(callback, closure);</span>
<a href="#l15.520"></a><span id="l15.520"> }</span>
<a href="#l15.521"></a><span id="l15.521"> </span>
<a href="#l15.522"></a><span id="l15.522" class="difflineminus">-</span>
<a href="#l15.523"></a><span id="l15.523" class="difflineminus">-static MimeEncoderData *</span>
<a href="#l15.524"></a><span id="l15.524" class="difflineminus">-mime_encoder_init (mime_encoding which,</span>
<a href="#l15.525"></a><span id="l15.525" class="difflineminus">-           MimeConverterOutputCallback output_fn,</span>
<a href="#l15.526"></a><span id="l15.526" class="difflineminus">-           void *closure)</span>
<a href="#l15.527"></a><span id="l15.527" class="difflineplus">+MimeEncoder *MimeEncoder::GetQPEncoder(OutputCallback callback, void *closure)</span>
<a href="#l15.528"></a><span id="l15.528"> {</span>
<a href="#l15.529"></a><span id="l15.529" class="difflineminus">-  MimeEncoderData *data = PR_NEW(MimeEncoderData);</span>
<a href="#l15.530"></a><span id="l15.530" class="difflineminus">-  if (!data) return 0;</span>
<a href="#l15.531"></a><span id="l15.531" class="difflineminus">-  memset(data, 0, sizeof(*data));</span>
<a href="#l15.532"></a><span id="l15.532" class="difflineminus">-  data-&gt;encoding = which;</span>
<a href="#l15.533"></a><span id="l15.533" class="difflineminus">-  data-&gt;write_buffer = output_fn;</span>
<a href="#l15.534"></a><span id="l15.534" class="difflineminus">-  data-&gt;closure = closure;</span>
<a href="#l15.535"></a><span id="l15.535" class="difflineminus">-  return data;</span>
<a href="#l15.536"></a><span id="l15.536" class="difflineminus">-}</span>
<a href="#l15.537"></a><span id="l15.537" class="difflineminus">-</span>
<a href="#l15.538"></a><span id="l15.538" class="difflineminus">-MimeEncoderData *</span>
<a href="#l15.539"></a><span id="l15.539" class="difflineminus">-MimeB64EncoderInit (MimeConverterOutputCallback output_fn, void *closure)</span>
<a href="#l15.540"></a><span id="l15.540" class="difflineminus">-{</span>
<a href="#l15.541"></a><span id="l15.541" class="difflineminus">-  return mime_encoder_init (mime_Base64, output_fn, closure);</span>
<a href="#l15.542"></a><span id="l15.542" class="difflineminus">-}</span>
<a href="#l15.543"></a><span id="l15.543" class="difflineminus">-</span>
<a href="#l15.544"></a><span id="l15.544" class="difflineminus">-MimeEncoderData *</span>
<a href="#l15.545"></a><span id="l15.545" class="difflineminus">-MimeQPEncoderInit (MimeConverterOutputCallback output_fn,</span>
<a href="#l15.546"></a><span id="l15.546" class="difflineminus">-           void *closure)</span>
<a href="#l15.547"></a><span id="l15.547" class="difflineminus">-{</span>
<a href="#l15.548"></a><span id="l15.548" class="difflineminus">-  return mime_encoder_init (mime_QuotedPrintable, output_fn, closure);</span>
<a href="#l15.549"></a><span id="l15.549" class="difflineplus">+  return new QPEncoder(callback, closure);</span>
<a href="#l15.550"></a><span id="l15.550"> }</span>
<a href="#l15.551"></a><span id="l15.551"> </span>
<a href="#l15.552"></a><span id="l15.552" class="difflineminus">-MimeEncoderData *</span>
<a href="#l15.553"></a><span id="l15.553" class="difflineminus">-MimeUUEncoderInit (const char *filename,</span>
<a href="#l15.554"></a><span id="l15.554" class="difflineminus">-          MimeConverterOutputCallback output_fn,</span>
<a href="#l15.555"></a><span id="l15.555" class="difflineminus">-          void *closure)</span>
<a href="#l15.556"></a><span id="l15.556" class="difflineminus">-{</span>
<a href="#l15.557"></a><span id="l15.557" class="difflineminus">-  MimeEncoderData *enc = mime_encoder_init (mime_uuencode, output_fn, closure);</span>
<a href="#l15.558"></a><span id="l15.558" class="difflineminus">-</span>
<a href="#l15.559"></a><span id="l15.559" class="difflineminus">-  if (filename)</span>
<a href="#l15.560"></a><span id="l15.560" class="difflineminus">-    enc-&gt;filename = strdup(filename);</span>
<a href="#l15.561"></a><span id="l15.561" class="difflineminus">-</span>
<a href="#l15.562"></a><span id="l15.562" class="difflineminus">-  return enc;</span>
<a href="#l15.563"></a><span id="l15.563" class="difflineminus">-}</span>
<a href="#l15.564"></a><span id="l15.564" class="difflineminus">-</span>
<a href="#l15.565"></a><span id="l15.565" class="difflineminus">-int</span>
<a href="#l15.566"></a><span id="l15.566" class="difflineminus">-MimeEncoderWrite (MimeEncoderData *data, const char *buffer, int32_t size)</span>
<a href="#l15.567"></a><span id="l15.567" class="difflineminus">-{</span>
<a href="#l15.568"></a><span id="l15.568" class="difflineminus">-  NS_ASSERTION(data, &quot;1.1 &lt;rhp@netscape.com&gt; 19 Mar 1999 12:00&quot;);</span>
<a href="#l15.569"></a><span id="l15.569" class="difflineminus">-  if (!data) return -1;</span>
<a href="#l15.570"></a><span id="l15.570" class="difflineminus">-  switch(data-&gt;encoding)</span>
<a href="#l15.571"></a><span id="l15.571" class="difflineminus">-  {</span>
<a href="#l15.572"></a><span id="l15.572" class="difflineminus">-  case mime_Base64:</span>
<a href="#l15.573"></a><span id="l15.573" class="difflineminus">-    return mime_encode_base64_buffer (data, buffer, size);</span>
<a href="#l15.574"></a><span id="l15.574" class="difflineminus">-  case mime_QuotedPrintable:</span>
<a href="#l15.575"></a><span id="l15.575" class="difflineminus">-    return mime_encode_qp_buffer (data, buffer, size);</span>
<a href="#l15.576"></a><span id="l15.576" class="difflineminus">-  default:</span>
<a href="#l15.577"></a><span id="l15.577" class="difflineminus">-    NS_ERROR(&quot;Invalid encoding&quot;);</span>
<a href="#l15.578"></a><span id="l15.578" class="difflineminus">-    return -1;</span>
<a href="#l15.579"></a><span id="l15.579" class="difflineminus">-  }</span>
<a href="#l15.580"></a><span id="l15.580" class="difflineminus">-}</span>
<a href="#l15.581"></a><span id="l15.581" class="difflineplus">+} // namespace mailnews</span>
<a href="#l15.582"></a><span id="l15.582" class="difflineplus">+} // namespace mozilla</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mailnews/mime/src/mimemoz2.h</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mailnews/mime/src/mimemoz2.h</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -6,17 +6,17 @@</span>
<a href="#l16.4"></a><span id="l16.4"> #ifndef _MIMEMOZ_H_</span>
<a href="#l16.5"></a><span id="l16.5"> #define _MIMEMOZ_H_</span>
<a href="#l16.6"></a><span id="l16.6"> </span>
<a href="#l16.7"></a><span id="l16.7"> #include &quot;nsStreamConverter.h&quot;</span>
<a href="#l16.8"></a><span id="l16.8"> #include &quot;nsIMimeEmitter.h&quot;</span>
<a href="#l16.9"></a><span id="l16.9"> #include &quot;nsIURI.h&quot;</span>
<a href="#l16.10"></a><span id="l16.10"> #include &quot;mozITXTToHTMLConv.h&quot;</span>
<a href="#l16.11"></a><span id="l16.11"> #include &quot;nsIMsgSend.h&quot;</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-#include &quot;nsIMimeConverter.h&quot;</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineplus">+#include &quot;modmimee.h&quot;</span>
<a href="#l16.14"></a><span id="l16.14"> #include &quot;nsMsgAttachmentData.h&quot;</span>
<a href="#l16.15"></a><span id="l16.15"> </span>
<a href="#l16.16"></a><span id="l16.16"> // SHERRY - Need to get these out of here eventually</span>
<a href="#l16.17"></a><span id="l16.17"> </span>
<a href="#l16.18"></a><span id="l16.18"> #ifdef XP_UNIX</span>
<a href="#l16.19"></a><span id="l16.19"> #undef Bool</span>
<a href="#l16.20"></a><span id="l16.20"> #endif</span>
<a href="#l16.21"></a><span id="l16.21"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mailnews/mime/src/mimepbuf.h</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mailnews/mime/src/mimepbuf.h</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -2,17 +2,17 @@</span>
<a href="#l17.4"></a><span id="l17.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l17.5"></a><span id="l17.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l17.6"></a><span id="l17.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l17.7"></a><span id="l17.7"> </span>
<a href="#l17.8"></a><span id="l17.8"> #ifndef _MIMEPBUF_H_</span>
<a href="#l17.9"></a><span id="l17.9"> #define _MIMEPBUF_H_</span>
<a href="#l17.10"></a><span id="l17.10"> </span>
<a href="#l17.11"></a><span id="l17.11"> #include &quot;mimei.h&quot;</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-#include &quot;nsIMimeConverter.h&quot; // for MimeConverterOutputCallback</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineplus">+#include &quot;modmimee.h&quot; // for MimeConverterOutputCallback</span>
<a href="#l17.14"></a><span id="l17.14"> </span>
<a href="#l17.15"></a><span id="l17.15"> /* This file provides the ability to save up the entire contents of a MIME</span>
<a href="#l17.16"></a><span id="l17.16">    object (of arbitrary size), and then emit it all at once later.  The</span>
<a href="#l17.17"></a><span id="l17.17">    buffering is done in an efficient way that works well for both very large</span>
<a href="#l17.18"></a><span id="l17.18">    and very small objects.</span>
<a href="#l17.19"></a><span id="l17.19"> </span>
<a href="#l17.20"></a><span id="l17.20">    This is used in two places:</span>
<a href="#l17.21"></a><span id="l17.21"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mailnews/mime/src/modlmime.h</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mailnews/mime/src/modlmime.h</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -13,17 +13,17 @@</span>
<a href="#l18.4"></a><span id="l18.4"> #include &quot;nsStringGlue.h&quot;</span>
<a href="#l18.5"></a><span id="l18.5"> #include &quot;nsMailHeaders.h&quot;</span>
<a href="#l18.6"></a><span id="l18.6"> #include &quot;nsIMimeStreamConverter.h&quot;</span>
<a href="#l18.7"></a><span id="l18.7"> #include &quot;nsIUnicodeDecoder.h&quot;</span>
<a href="#l18.8"></a><span id="l18.8"> #include &quot;nsIUnicodeEncoder.h&quot;</span>
<a href="#l18.9"></a><span id="l18.9"> #include &quot;nsIPrefBranch.h&quot;</span>
<a href="#l18.10"></a><span id="l18.10"> #include &quot;mozITXTToHTMLConv.h&quot;</span>
<a href="#l18.11"></a><span id="l18.11"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-#include &quot;nsIMimeConverter.h&quot; // for MimeConverterOutputCallback</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineplus">+#include &quot;modmimee.h&quot; // for MimeConverterOutputCallback</span>
<a href="#l18.14"></a><span id="l18.14"> </span>
<a href="#l18.15"></a><span id="l18.15"> #define MIME_DRAFTS</span>
<a href="#l18.16"></a><span id="l18.16"> </span>
<a href="#l18.17"></a><span id="l18.17"> /* Opaque object describing a block of message headers, and a couple of</span>
<a href="#l18.18"></a><span id="l18.18">    routines for extracting data from one.</span>
<a href="#l18.19"></a><span id="l18.19">  */</span>
<a href="#l18.20"></a><span id="l18.20"> </span>
<a href="#l18.21"></a><span id="l18.21"> typedef struct MimeHeaders</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mailnews/mime/src/modmimee.h</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mailnews/mime/src/modmimee.h</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -8,27 +8,28 @@</span>
<a href="#l19.4"></a><span id="l19.4">    Created: Jamie Zawinski &lt;jwz@netscape.com&gt;, 15-May-96.</span>
<a href="#l19.5"></a><span id="l19.5">  */</span>
<a href="#l19.6"></a><span id="l19.6"> </span>
<a href="#l19.7"></a><span id="l19.7"> #ifndef _MIMEENC_H_</span>
<a href="#l19.8"></a><span id="l19.8"> #define _MIMEENC_H_</span>
<a href="#l19.9"></a><span id="l19.9"> </span>
<a href="#l19.10"></a><span id="l19.10"> #include &quot;nsError.h&quot;</span>
<a href="#l19.11"></a><span id="l19.11"> #include &quot;nscore.h&quot; // for nullptr</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-#include &quot;nsIMimeConverter.h&quot; // for MimeConverterOutputCallback</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineplus">+</span>
<a href="#l19.14"></a><span id="l19.14" class="difflineplus">+typedef int (*MimeConverterOutputCallback)</span>
<a href="#l19.15"></a><span id="l19.15" class="difflineplus">+  (const char *buf, int32_t size, void *closure);</span>
<a href="#l19.16"></a><span id="l19.16"> </span>
<a href="#l19.17"></a><span id="l19.17"> /* This file defines interfaces to generic implementations of Base64,</span>
<a href="#l19.18"></a><span id="l19.18">    Quoted-Printable, and UU decoders; and of Base64 and Quoted-Printable</span>
<a href="#l19.19"></a><span id="l19.19">    encoders.</span>
<a href="#l19.20"></a><span id="l19.20">  */</span>
<a href="#l19.21"></a><span id="l19.21"> </span>
<a href="#l19.22"></a><span id="l19.22"> </span>
<a href="#l19.23"></a><span id="l19.23"> /* Opaque objects used by the encoder/decoder to store state. */</span>
<a href="#l19.24"></a><span id="l19.24"> typedef struct MimeDecoderData MimeDecoderData;</span>
<a href="#l19.25"></a><span id="l19.25" class="difflineminus">-typedef struct MimeEncoderData MimeEncoderData;</span>
<a href="#l19.26"></a><span id="l19.26"> </span>
<a href="#l19.27"></a><span id="l19.27"> struct MimeObject;</span>
<a href="#l19.28"></a><span id="l19.28"> </span>
<a href="#l19.29"></a><span id="l19.29"> </span>
<a href="#l19.30"></a><span id="l19.30"> /* functions for creating that opaque data.</span>
<a href="#l19.31"></a><span id="l19.31">  */</span>
<a href="#l19.32"></a><span id="l19.32"> MimeDecoderData *MimeB64DecoderInit(MimeConverterOutputCallback output_fn,</span>
<a href="#l19.33"></a><span id="l19.33">                   void *closure);</span>
<a href="#l19.34"></a><span id="l19.34" class="difflineat">@@ -36,30 +37,20 @@ MimeDecoderData *MimeB64DecoderInit(Mime</span>
<a href="#l19.35"></a><span id="l19.35"> MimeDecoderData *MimeQPDecoderInit (MimeConverterOutputCallback output_fn,</span>
<a href="#l19.36"></a><span id="l19.36">                   void *closure, MimeObject *object = nullptr);</span>
<a href="#l19.37"></a><span id="l19.37"> </span>
<a href="#l19.38"></a><span id="l19.38"> MimeDecoderData *MimeUUDecoderInit (MimeConverterOutputCallback output_fn,</span>
<a href="#l19.39"></a><span id="l19.39">                   void *closure);</span>
<a href="#l19.40"></a><span id="l19.40"> MimeDecoderData *MimeYDecoderInit (MimeConverterOutputCallback output_fn,</span>
<a href="#l19.41"></a><span id="l19.41">                   void *closure);</span>
<a href="#l19.42"></a><span id="l19.42"> </span>
<a href="#l19.43"></a><span id="l19.43" class="difflineminus">-MimeEncoderData *MimeB64EncoderInit(MimeConverterOutputCallback output_fn,</span>
<a href="#l19.44"></a><span id="l19.44" class="difflineminus">-                  void *closure);</span>
<a href="#l19.45"></a><span id="l19.45" class="difflineminus">-MimeEncoderData *MimeQPEncoderInit (MimeConverterOutputCallback output_fn,</span>
<a href="#l19.46"></a><span id="l19.46" class="difflineminus">-                  void *closure);</span>
<a href="#l19.47"></a><span id="l19.47" class="difflineminus">-MimeEncoderData *MimeUUEncoderInit (const char *filename,</span>
<a href="#l19.48"></a><span id="l19.48" class="difflineminus">-                  MimeConverterOutputCallback output_fn,</span>
<a href="#l19.49"></a><span id="l19.49" class="difflineminus">-                  void *closure);</span>
<a href="#l19.50"></a><span id="l19.50" class="difflineminus">-</span>
<a href="#l19.51"></a><span id="l19.51"> /* Push data through the encoder/decoder, causing the above-provided write_fn</span>
<a href="#l19.52"></a><span id="l19.52">    to be called with encoded/decoded data. */</span>
<a href="#l19.53"></a><span id="l19.53"> int MimeDecoderWrite (MimeDecoderData *data, const char *buffer, int32_t size,</span>
<a href="#l19.54"></a><span id="l19.54">                   int32_t *outSize);</span>
<a href="#l19.55"></a><span id="l19.55" class="difflineminus">-int MimeEncoderWrite (MimeEncoderData *data, const char *buffer, int32_t size);</span>
<a href="#l19.56"></a><span id="l19.56"> </span>
<a href="#l19.57"></a><span id="l19.57"> /* When you're done encoding/decoding, call this to free the data.  If</span>
<a href="#l19.58"></a><span id="l19.58">    abort_p is false, then calling this may cause the write_fn to be called</span>
<a href="#l19.59"></a><span id="l19.59">    one last time (as the last buffered data is flushed out.)</span>
<a href="#l19.60"></a><span id="l19.60">  */</span>
<a href="#l19.61"></a><span id="l19.61"> int MimeDecoderDestroy(MimeDecoderData *data, bool abort_p);</span>
<a href="#l19.62"></a><span id="l19.62" class="difflineminus">-int MimeEncoderDestroy(MimeEncoderData *data, bool abort_p);</span>
<a href="#l19.63"></a><span id="l19.63"> </span>
<a href="#l19.64"></a><span id="l19.64"> #endif /* _MODMIMEE_H_ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/mailnews/mime/src/nsMimeConverter.cpp</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/mailnews/mime/src/nsMimeConverter.cpp</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -105,60 +105,8 @@ nsMimeConverter::EncodeMimePartIIStr_UTF</span>
<a href="#l20.4"></a><span id="l20.4">   char *retString = MIME_EncodeMimePartIIStr(PromiseFlatCString(header).get(),</span>
<a href="#l20.5"></a><span id="l20.5">                                              structured, mailCharset,</span>
<a href="#l20.6"></a><span id="l20.6">                                              fieldnamelen, encodedWordSize);</span>
<a href="#l20.7"></a><span id="l20.7">   NS_ENSURE_TRUE(retString, NS_ERROR_FAILURE);</span>
<a href="#l20.8"></a><span id="l20.8"> </span>
<a href="#l20.9"></a><span id="l20.9">   *encodedString = retString;</span>
<a href="#l20.10"></a><span id="l20.10">   return NS_OK;</span>
<a href="#l20.11"></a><span id="l20.11"> }</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineminus">-</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineminus">-</span>
<a href="#l20.14"></a><span id="l20.14" class="difflineminus">-nsresult</span>
<a href="#l20.15"></a><span id="l20.15" class="difflineminus">-nsMimeConverter::B64EncoderInit(MimeConverterOutputCallback output_fn,</span>
<a href="#l20.16"></a><span id="l20.16" class="difflineminus">-                                void *closure,</span>
<a href="#l20.17"></a><span id="l20.17" class="difflineminus">-                                MimeEncoderData **returnEncoderData)</span>
<a href="#l20.18"></a><span id="l20.18" class="difflineminus">-{</span>
<a href="#l20.19"></a><span id="l20.19" class="difflineminus">-  NS_ENSURE_ARG_POINTER(returnEncoderData);</span>
<a href="#l20.20"></a><span id="l20.20" class="difflineminus">-</span>
<a href="#l20.21"></a><span id="l20.21" class="difflineminus">-  MimeEncoderData   *ptr;</span>
<a href="#l20.22"></a><span id="l20.22" class="difflineminus">-</span>
<a href="#l20.23"></a><span id="l20.23" class="difflineminus">-  ptr = MimeB64EncoderInit(output_fn, closure);</span>
<a href="#l20.24"></a><span id="l20.24" class="difflineminus">-  NS_ENSURE_TRUE(ptr, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l20.25"></a><span id="l20.25" class="difflineminus">-</span>
<a href="#l20.26"></a><span id="l20.26" class="difflineminus">-  *returnEncoderData = ptr;</span>
<a href="#l20.27"></a><span id="l20.27" class="difflineminus">-  return NS_OK;</span>
<a href="#l20.28"></a><span id="l20.28" class="difflineminus">-}</span>
<a href="#l20.29"></a><span id="l20.29" class="difflineminus">-</span>
<a href="#l20.30"></a><span id="l20.30" class="difflineminus">-nsresult</span>
<a href="#l20.31"></a><span id="l20.31" class="difflineminus">-nsMimeConverter::QPEncoderInit(MimeConverterOutputCallback output_fn,</span>
<a href="#l20.32"></a><span id="l20.32" class="difflineminus">-                               void *closure,</span>
<a href="#l20.33"></a><span id="l20.33" class="difflineminus">-                               MimeEncoderData **returnEncoderData)</span>
<a href="#l20.34"></a><span id="l20.34" class="difflineminus">-{</span>
<a href="#l20.35"></a><span id="l20.35" class="difflineminus">-  NS_ENSURE_ARG_POINTER(returnEncoderData);</span>
<a href="#l20.36"></a><span id="l20.36" class="difflineminus">-</span>
<a href="#l20.37"></a><span id="l20.37" class="difflineminus">-  MimeEncoderData *ptr;</span>
<a href="#l20.38"></a><span id="l20.38" class="difflineminus">-</span>
<a href="#l20.39"></a><span id="l20.39" class="difflineminus">-  ptr = MimeQPEncoderInit(output_fn, closure);</span>
<a href="#l20.40"></a><span id="l20.40" class="difflineminus">-  NS_ENSURE_TRUE(ptr, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l20.41"></a><span id="l20.41" class="difflineminus">-</span>
<a href="#l20.42"></a><span id="l20.42" class="difflineminus">-  *returnEncoderData = ptr;</span>
<a href="#l20.43"></a><span id="l20.43" class="difflineminus">-  return NS_OK;</span>
<a href="#l20.44"></a><span id="l20.44" class="difflineminus">-}</span>
<a href="#l20.45"></a><span id="l20.45" class="difflineminus">-</span>
<a href="#l20.46"></a><span id="l20.46" class="difflineminus">-nsresult</span>
<a href="#l20.47"></a><span id="l20.47" class="difflineminus">-nsMimeConverter::EncoderDestroy(MimeEncoderData *data, bool abort_p)</span>
<a href="#l20.48"></a><span id="l20.48" class="difflineminus">-{</span>
<a href="#l20.49"></a><span id="l20.49" class="difflineminus">-  MimeEncoderDestroy(data, abort_p);</span>
<a href="#l20.50"></a><span id="l20.50" class="difflineminus">-  return NS_OK;</span>
<a href="#l20.51"></a><span id="l20.51" class="difflineminus">-}</span>
<a href="#l20.52"></a><span id="l20.52" class="difflineminus">-</span>
<a href="#l20.53"></a><span id="l20.53" class="difflineminus">-nsresult</span>
<a href="#l20.54"></a><span id="l20.54" class="difflineminus">-nsMimeConverter::EncoderWrite(MimeEncoderData *data, const char *buffer,</span>
<a href="#l20.55"></a><span id="l20.55" class="difflineminus">-                              int32_t size, int32_t *written)</span>
<a href="#l20.56"></a><span id="l20.56" class="difflineminus">-{</span>
<a href="#l20.57"></a><span id="l20.57" class="difflineminus">-  NS_ENSURE_ARG_POINTER(written);</span>
<a href="#l20.58"></a><span id="l20.58" class="difflineminus">-</span>
<a href="#l20.59"></a><span id="l20.59" class="difflineminus">-  int32_t writeCount;</span>
<a href="#l20.60"></a><span id="l20.60" class="difflineminus">-  writeCount = MimeEncoderWrite(data, buffer, size);</span>
<a href="#l20.61"></a><span id="l20.61" class="difflineminus">-  *written = writeCount;</span>
<a href="#l20.62"></a><span id="l20.62" class="difflineminus">-  return NS_OK;</span>
<a href="#l20.63"></a><span id="l20.63" class="difflineminus">-}</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

