<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 27882:328093467a6516099d5bdc111f8e3129674b5926</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 328093467a6516099d5bdc111f8e3129674b5926" />
<meta property="og:url" content="/comm-central/rev/328093467a6516099d5bdc111f8e3129674b5926" />
<meta property="og:description" content="Bug 1463266 - remove \n in MOZ_LOG and NS_ERROR. r=me DONTBUILD" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 328093467a6516099d5bdc111f8e3129674b5926 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/328093467a6516099d5bdc111f8e3129674b5926">shortlog</a> |
<a href="/comm-central/log/328093467a6516099d5bdc111f8e3129674b5926">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/328093467a6516099d5bdc111f8e3129674b5926">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/328093467a6516099d5bdc111f8e3129674b5926">files</a> |
changeset |
<a href="/comm-central/raw-rev/328093467a6516099d5bdc111f8e3129674b5926">raw</a>  | <a href="/comm-central/archive/328093467a6516099d5bdc111f8e3129674b5926.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1463266">Bug 1463266</a> - remove \n in MOZ_LOG and NS_ERROR. r=me DONTBUILD
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#74;&#111;&#114;&#103;&#32;&#75;&#32;&#60;&#106;&#111;&#114;&#103;&#107;&#64;&#106;&#111;&#114;&#103;&#107;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Wed, 09 Oct 2019 11:43:54 +0200</td></tr>

<tr>
 <td>changeset 27882</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/328093467a6516099d5bdc111f8e3129674b5926">328093467a6516099d5bdc111f8e3129674b5926</a></td>
</tr>



<tr>
<td>parent 27881</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/58c46e562118f7abfe56eca1b3e43bee42d4430e">58c46e562118f7abfe56eca1b3e43bee42d4430e</a>
</td>
</tr>

<tr>
<td>child 27883</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/405b859c20d740773221def38155930710d1ef85">405b859c20d740773221def38155930710d1ef85</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=328093467a6516099d5bdc111f8e3129674b5926">16534</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Wed, 09 Oct 2019 09:46:24 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@328093467a65 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=328093467a6516099d5bdc111f8e3129674b5926">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=328093467a6516099d5bdc111f8e3129674b5926&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=328093467a6516099d5bdc111f8e3129674b5926&newProject=comm-central&newRevision=58c46e562118f7abfe56eca1b3e43bee42d4430e&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=328093467a6516099d5bdc111f8e3129674b5926&newProject=comm-central&newRevision=58c46e562118f7abfe56eca1b3e43bee42d4430e&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=328093467a6516099d5bdc111f8e3129674b5926&newProject=comm-central&newRevision=58c46e562118f7abfe56eca1b3e43bee42d4430e&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28me%29&revcount=50">me</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1463266">1463266</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1463266">Bug 1463266</a> - remove \n in MOZ_LOG and NS_ERROR. r=me DONTBUILD</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/328093467a6516099d5bdc111f8e3129674b5926/ldap/xpcom/src/nsLDAPConnection.cpp">ldap/xpcom/src/nsLDAPConnection.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/328093467a6516099d5bdc111f8e3129674b5926/ldap/xpcom/src/nsLDAPConnection.cpp">file</a> |
<a href="/comm-central/annotate/328093467a6516099d5bdc111f8e3129674b5926/ldap/xpcom/src/nsLDAPConnection.cpp">annotate</a> |
<a href="/comm-central/diff/328093467a6516099d5bdc111f8e3129674b5926/ldap/xpcom/src/nsLDAPConnection.cpp">diff</a> |
<a href="/comm-central/comparison/328093467a6516099d5bdc111f8e3129674b5926/ldap/xpcom/src/nsLDAPConnection.cpp">comparison</a> |
<a href="/comm-central/log/328093467a6516099d5bdc111f8e3129674b5926/ldap/xpcom/src/nsLDAPConnection.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/328093467a6516099d5bdc111f8e3129674b5926/mailnews/db/msgdb/src/nsMsgDatabase.cpp">mailnews/db/msgdb/src/nsMsgDatabase.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/328093467a6516099d5bdc111f8e3129674b5926/mailnews/db/msgdb/src/nsMsgDatabase.cpp">file</a> |
<a href="/comm-central/annotate/328093467a6516099d5bdc111f8e3129674b5926/mailnews/db/msgdb/src/nsMsgDatabase.cpp">annotate</a> |
<a href="/comm-central/diff/328093467a6516099d5bdc111f8e3129674b5926/mailnews/db/msgdb/src/nsMsgDatabase.cpp">diff</a> |
<a href="/comm-central/comparison/328093467a6516099d5bdc111f8e3129674b5926/mailnews/db/msgdb/src/nsMsgDatabase.cpp">comparison</a> |
<a href="/comm-central/log/328093467a6516099d5bdc111f8e3129674b5926/mailnews/db/msgdb/src/nsMsgDatabase.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/328093467a6516099d5bdc111f8e3129674b5926/mailnews/local/src/nsMailboxProtocol.cpp">mailnews/local/src/nsMailboxProtocol.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/328093467a6516099d5bdc111f8e3129674b5926/mailnews/local/src/nsMailboxProtocol.cpp">file</a> |
<a href="/comm-central/annotate/328093467a6516099d5bdc111f8e3129674b5926/mailnews/local/src/nsMailboxProtocol.cpp">annotate</a> |
<a href="/comm-central/diff/328093467a6516099d5bdc111f8e3129674b5926/mailnews/local/src/nsMailboxProtocol.cpp">diff</a> |
<a href="/comm-central/comparison/328093467a6516099d5bdc111f8e3129674b5926/mailnews/local/src/nsMailboxProtocol.cpp">comparison</a> |
<a href="/comm-central/log/328093467a6516099d5bdc111f8e3129674b5926/mailnews/local/src/nsMailboxProtocol.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/328093467a6516099d5bdc111f8e3129674b5926/mailnews/local/src/nsMsgMaildirStore.cpp">mailnews/local/src/nsMsgMaildirStore.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/328093467a6516099d5bdc111f8e3129674b5926/mailnews/local/src/nsMsgMaildirStore.cpp">file</a> |
<a href="/comm-central/annotate/328093467a6516099d5bdc111f8e3129674b5926/mailnews/local/src/nsMsgMaildirStore.cpp">annotate</a> |
<a href="/comm-central/diff/328093467a6516099d5bdc111f8e3129674b5926/mailnews/local/src/nsMsgMaildirStore.cpp">diff</a> |
<a href="/comm-central/comparison/328093467a6516099d5bdc111f8e3129674b5926/mailnews/local/src/nsMsgMaildirStore.cpp">comparison</a> |
<a href="/comm-central/log/328093467a6516099d5bdc111f8e3129674b5926/mailnews/local/src/nsMsgMaildirStore.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/328093467a6516099d5bdc111f8e3129674b5926/mailnews/mapi/mapihook/src/msgMapiImp.cpp">mailnews/mapi/mapihook/src/msgMapiImp.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/328093467a6516099d5bdc111f8e3129674b5926/mailnews/mapi/mapihook/src/msgMapiImp.cpp">file</a> |
<a href="/comm-central/annotate/328093467a6516099d5bdc111f8e3129674b5926/mailnews/mapi/mapihook/src/msgMapiImp.cpp">annotate</a> |
<a href="/comm-central/diff/328093467a6516099d5bdc111f8e3129674b5926/mailnews/mapi/mapihook/src/msgMapiImp.cpp">diff</a> |
<a href="/comm-central/comparison/328093467a6516099d5bdc111f8e3129674b5926/mailnews/mapi/mapihook/src/msgMapiImp.cpp">comparison</a> |
<a href="/comm-central/log/328093467a6516099d5bdc111f8e3129674b5926/mailnews/mapi/mapihook/src/msgMapiImp.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/328093467a6516099d5bdc111f8e3129674b5926/mailnews/news/src/nsNNTPProtocol.cpp">mailnews/news/src/nsNNTPProtocol.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/328093467a6516099d5bdc111f8e3129674b5926/mailnews/news/src/nsNNTPProtocol.cpp">file</a> |
<a href="/comm-central/annotate/328093467a6516099d5bdc111f8e3129674b5926/mailnews/news/src/nsNNTPProtocol.cpp">annotate</a> |
<a href="/comm-central/diff/328093467a6516099d5bdc111f8e3129674b5926/mailnews/news/src/nsNNTPProtocol.cpp">diff</a> |
<a href="/comm-central/comparison/328093467a6516099d5bdc111f8e3129674b5926/mailnews/news/src/nsNNTPProtocol.cpp">comparison</a> |
<a href="/comm-central/log/328093467a6516099d5bdc111f8e3129674b5926/mailnews/news/src/nsNNTPProtocol.cpp">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/ldap/xpcom/src/nsLDAPConnection.cpp</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/ldap/xpcom/src/nsLDAPConnection.cpp</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -86,17 +86,17 @@ nsLDAPConnection::Init(nsILDAPURL *aUrl,</span>
<a href="#l1.4"></a><span id="l1.4">   mBindName.Assign(aBindName);</span>
<a href="#l1.5"></a><span id="l1.5">   mClosure = aClosure;</span>
<a href="#l1.6"></a><span id="l1.6">   mInitListener = aMessageListener;</span>
<a href="#l1.7"></a><span id="l1.7"> </span>
<a href="#l1.8"></a><span id="l1.8">   // Make sure we haven't called Init earlier, i.e. there's a DNS</span>
<a href="#l1.9"></a><span id="l1.9">   // request pending.</span>
<a href="#l1.10"></a><span id="l1.10">   NS_ASSERTION(!mDNSRequest,</span>
<a href="#l1.11"></a><span id="l1.11">                &quot;nsLDAPConnection::Init() &quot;</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-               &quot;Connection was already initialized\n&quot;);</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+               &quot;Connection was already initialized&quot;);</span>
<a href="#l1.14"></a><span id="l1.14"> </span>
<a href="#l1.15"></a><span id="l1.15">   // Check and save the version number</span>
<a href="#l1.16"></a><span id="l1.16">   if (aVersion != nsILDAPConnection::VERSION2 &amp;&amp;</span>
<a href="#l1.17"></a><span id="l1.17">       aVersion != nsILDAPConnection::VERSION3) {</span>
<a href="#l1.18"></a><span id="l1.18">     NS_ERROR(&quot;nsLDAPConnection::Init(): illegal version&quot;);</span>
<a href="#l1.19"></a><span id="l1.19">     return NS_ERROR_ILLEGAL_VALUE;</span>
<a href="#l1.20"></a><span id="l1.20">   }</span>
<a href="#l1.21"></a><span id="l1.21">   mVersion = aVersion;</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineat">@@ -166,32 +166,32 @@ nsLDAPConnection::Init(nsILDAPURL *aUrl,</span>
<a href="#l1.23"></a><span id="l1.23">   }</span>
<a href="#l1.24"></a><span id="l1.24">   return rv;</span>
<a href="#l1.25"></a><span id="l1.25"> }</span>
<a href="#l1.26"></a><span id="l1.26"> </span>
<a href="#l1.27"></a><span id="l1.27"> // this might get exposed to clients, so we've broken it</span>
<a href="#l1.28"></a><span id="l1.28"> // out of the destructor.</span>
<a href="#l1.29"></a><span id="l1.29"> void nsLDAPConnection::Close() {</span>
<a href="#l1.30"></a><span id="l1.30">   int rc;</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineminus">-  MOZ_LOG(gLDAPLogModule, mozilla::LogLevel::Debug, (&quot;unbinding\n&quot;));</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineplus">+  MOZ_LOG(gLDAPLogModule, mozilla::LogLevel::Debug, (&quot;unbinding&quot;));</span>
<a href="#l1.33"></a><span id="l1.33"> </span>
<a href="#l1.34"></a><span id="l1.34">   if (mConnectionHandle) {</span>
<a href="#l1.35"></a><span id="l1.35">     // note that the ldap_unbind() call in the 5.0 version of the LDAP C SDK</span>
<a href="#l1.36"></a><span id="l1.36">     // appears to be exactly identical to ldap_unbind_s(), so it may in fact</span>
<a href="#l1.37"></a><span id="l1.37">     // still be synchronous</span>
<a href="#l1.38"></a><span id="l1.38">     //</span>
<a href="#l1.39"></a><span id="l1.39">     rc = ldap_unbind(mConnectionHandle);</span>
<a href="#l1.40"></a><span id="l1.40">     if (rc != LDAP_SUCCESS) {</span>
<a href="#l1.41"></a><span id="l1.41">       MOZ_LOG(gLDAPLogModule, mozilla::LogLevel::Warning,</span>
<a href="#l1.42"></a><span id="l1.42" class="difflineminus">-              (&quot;nsLDAPConnection::Close(): %s\n&quot;, ldap_err2string(rc)));</span>
<a href="#l1.43"></a><span id="l1.43" class="difflineplus">+              (&quot;nsLDAPConnection::Close(): %s&quot;, ldap_err2string(rc)));</span>
<a href="#l1.44"></a><span id="l1.44">     }</span>
<a href="#l1.45"></a><span id="l1.45">     mConnectionHandle = nullptr;</span>
<a href="#l1.46"></a><span id="l1.46">   }</span>
<a href="#l1.47"></a><span id="l1.47"> </span>
<a href="#l1.48"></a><span id="l1.48" class="difflineminus">-  MOZ_LOG(gLDAPLogModule, mozilla::LogLevel::Debug, (&quot;unbound\n&quot;));</span>
<a href="#l1.49"></a><span id="l1.49" class="difflineplus">+  MOZ_LOG(gLDAPLogModule, mozilla::LogLevel::Debug, (&quot;unbound&quot;));</span>
<a href="#l1.50"></a><span id="l1.50"> </span>
<a href="#l1.51"></a><span id="l1.51">   NS_ASSERTION(!mThread || NS_SUCCEEDED(mThread-&gt;Shutdown()),</span>
<a href="#l1.52"></a><span id="l1.52">                &quot;Failed to shutdown thread cleanly&quot;);</span>
<a href="#l1.53"></a><span id="l1.53"> </span>
<a href="#l1.54"></a><span id="l1.54">   // Cancel the DNS lookup if needed, and also drop the reference to the</span>
<a href="#l1.55"></a><span id="l1.55">   // Init listener (if still there).</span>
<a href="#l1.56"></a><span id="l1.56">   //</span>
<a href="#l1.57"></a><span id="l1.57">   if (mDNSRequest) {</span>
<a href="#l1.58"></a><span id="l1.58" class="difflineat">@@ -305,17 +305,17 @@ nsresult nsLDAPConnection::AddPendingOpe</span>
<a href="#l1.59"></a><span id="l1.59">   NS_ENSURE_ARG_POINTER(aOperation);</span>
<a href="#l1.60"></a><span id="l1.60"> </span>
<a href="#l1.61"></a><span id="l1.61">   nsIRunnable *runnable =</span>
<a href="#l1.62"></a><span id="l1.62">       new nsLDAPConnectionRunnable(aOperationID, aOperation, this);</span>
<a href="#l1.63"></a><span id="l1.63">   {</span>
<a href="#l1.64"></a><span id="l1.64">     MutexAutoLock lock(mPendingOperationsMutex);</span>
<a href="#l1.65"></a><span id="l1.65">     mPendingOperations.Put((uint32_t)aOperationID, aOperation);</span>
<a href="#l1.66"></a><span id="l1.66">     MOZ_LOG(gLDAPLogModule, mozilla::LogLevel::Debug,</span>
<a href="#l1.67"></a><span id="l1.67" class="difflineminus">-            (&quot;pending operation added; total pending operations now = %d\n&quot;,</span>
<a href="#l1.68"></a><span id="l1.68" class="difflineplus">+            (&quot;pending operation added; total pending operations now = %d&quot;,</span>
<a href="#l1.69"></a><span id="l1.69">              mPendingOperations.Count()));</span>
<a href="#l1.70"></a><span id="l1.70">   }</span>
<a href="#l1.71"></a><span id="l1.71"> </span>
<a href="#l1.72"></a><span id="l1.72">   nsresult rv;</span>
<a href="#l1.73"></a><span id="l1.73">   if (!mThread) {</span>
<a href="#l1.74"></a><span id="l1.74">     rv = NS_NewThread(getter_AddRefs(mThread), runnable);</span>
<a href="#l1.75"></a><span id="l1.75">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.76"></a><span id="l1.76">   } else {</span>
<a href="#l1.77"></a><span id="l1.77" class="difflineat">@@ -336,24 +336,24 @@ nsresult nsLDAPConnection::AddPendingOpe</span>
<a href="#l1.78"></a><span id="l1.78">  * @exception NS_ERROR_FAILURE      could not delete the operation</span>
<a href="#l1.79"></a><span id="l1.79">  *</span>
<a href="#l1.80"></a><span id="l1.80">  * void removePendingOperation(in nsILDAPOperation aOperation);</span>
<a href="#l1.81"></a><span id="l1.81">  */</span>
<a href="#l1.82"></a><span id="l1.82"> nsresult nsLDAPConnection::RemovePendingOperation(uint32_t aOperationID) {</span>
<a href="#l1.83"></a><span id="l1.83">   NS_ENSURE_TRUE(aOperationID &gt; 0, NS_ERROR_UNEXPECTED);</span>
<a href="#l1.84"></a><span id="l1.84"> </span>
<a href="#l1.85"></a><span id="l1.85">   MOZ_LOG(gLDAPLogModule, mozilla::LogLevel::Debug,</span>
<a href="#l1.86"></a><span id="l1.86" class="difflineminus">-          (&quot;nsLDAPConnection::RemovePendingOperation(): operation removed\n&quot;));</span>
<a href="#l1.87"></a><span id="l1.87" class="difflineplus">+          (&quot;nsLDAPConnection::RemovePendingOperation(): operation removed&quot;));</span>
<a href="#l1.88"></a><span id="l1.88"> </span>
<a href="#l1.89"></a><span id="l1.89">   {</span>
<a href="#l1.90"></a><span id="l1.90">     MutexAutoLock lock(mPendingOperationsMutex);</span>
<a href="#l1.91"></a><span id="l1.91">     mPendingOperations.Remove(aOperationID);</span>
<a href="#l1.92"></a><span id="l1.92">     MOZ_LOG(gLDAPLogModule, mozilla::LogLevel::Debug,</span>
<a href="#l1.93"></a><span id="l1.93">             (&quot;nsLDAPConnection::RemovePendingOperation(): operation &quot;</span>
<a href="#l1.94"></a><span id="l1.94" class="difflineminus">-             &quot;removed; total pending operations now = %d\n&quot;,</span>
<a href="#l1.95"></a><span id="l1.95" class="difflineplus">+             &quot;removed; total pending operations now = %d&quot;,</span>
<a href="#l1.96"></a><span id="l1.96">              mPendingOperations.Count()));</span>
<a href="#l1.97"></a><span id="l1.97">   }</span>
<a href="#l1.98"></a><span id="l1.98"> </span>
<a href="#l1.99"></a><span id="l1.99">   return NS_OK;</span>
<a href="#l1.100"></a><span id="l1.100"> }</span>
<a href="#l1.101"></a><span id="l1.101"> </span>
<a href="#l1.102"></a><span id="l1.102"> class nsOnLDAPMessageRunnable : public Runnable {</span>
<a href="#l1.103"></a><span id="l1.103">  public:</span>
<a href="#l1.104"></a><span id="l1.104" class="difflineat">@@ -390,17 +390,17 @@ NS_IMETHODIMP nsOnLDAPMessageRunnable::R</span>
<a href="#l1.105"></a><span id="l1.105"> nsresult nsLDAPConnection::InvokeMessageCallback(LDAPMessage *aMsgHandle,</span>
<a href="#l1.106"></a><span id="l1.106">                                                  nsILDAPMessage *aMsg,</span>
<a href="#l1.107"></a><span id="l1.107">                                                  int32_t aOperation,</span>
<a href="#l1.108"></a><span id="l1.108">                                                  bool aRemoveOpFromConnQ) {</span>
<a href="#l1.109"></a><span id="l1.109"> #if defined(DEBUG)</span>
<a href="#l1.110"></a><span id="l1.110">   // We only want this being logged for debug builds so as not to affect</span>
<a href="#l1.111"></a><span id="l1.111">   // performance too much.</span>
<a href="#l1.112"></a><span id="l1.112">   MOZ_LOG(gLDAPLogModule, mozilla::LogLevel::Debug,</span>
<a href="#l1.113"></a><span id="l1.113" class="difflineminus">-          (&quot;InvokeMessageCallback entered\n&quot;));</span>
<a href="#l1.114"></a><span id="l1.114" class="difflineplus">+          (&quot;InvokeMessageCallback entered&quot;));</span>
<a href="#l1.115"></a><span id="l1.115"> #endif</span>
<a href="#l1.116"></a><span id="l1.116"> </span>
<a href="#l1.117"></a><span id="l1.117">   // Get the operation.</span>
<a href="#l1.118"></a><span id="l1.118">   nsCOMPtr&lt;nsILDAPOperation&gt; operation;</span>
<a href="#l1.119"></a><span id="l1.119">   {</span>
<a href="#l1.120"></a><span id="l1.120">     MutexAutoLock lock(mPendingOperationsMutex);</span>
<a href="#l1.121"></a><span id="l1.121">     mPendingOperations.Get((uint32_t)aOperation, getter_AddRefs(operation));</span>
<a href="#l1.122"></a><span id="l1.122">   }</span>
<a href="#l1.123"></a><span id="l1.123" class="difflineat">@@ -418,18 +418,17 @@ nsresult nsLDAPConnection::InvokeMessage</span>
<a href="#l1.124"></a><span id="l1.124"> </span>
<a href="#l1.125"></a><span id="l1.125">   // if requested (ie the operation is done), remove the operation</span>
<a href="#l1.126"></a><span id="l1.126">   // from the connection queue.</span>
<a href="#l1.127"></a><span id="l1.127">   if (aRemoveOpFromConnQ) {</span>
<a href="#l1.128"></a><span id="l1.128">     MutexAutoLock lock(mPendingOperationsMutex);</span>
<a href="#l1.129"></a><span id="l1.129">     mPendingOperations.Remove(aOperation);</span>
<a href="#l1.130"></a><span id="l1.130"> </span>
<a href="#l1.131"></a><span id="l1.131">     MOZ_LOG(gLDAPLogModule, mozilla::LogLevel::Debug,</span>
<a href="#l1.132"></a><span id="l1.132" class="difflineminus">-            (&quot;pending operation removed; total pending operations now =&quot;</span>
<a href="#l1.133"></a><span id="l1.133" class="difflineminus">-             &quot; %d\n&quot;,</span>
<a href="#l1.134"></a><span id="l1.134" class="difflineplus">+            (&quot;pending operation removed; total pending operations now = %d&quot;,</span>
<a href="#l1.135"></a><span id="l1.135">              mPendingOperations.Count()));</span>
<a href="#l1.136"></a><span id="l1.136">   }</span>
<a href="#l1.137"></a><span id="l1.137"> </span>
<a href="#l1.138"></a><span id="l1.138">   return NS_OK;</span>
<a href="#l1.139"></a><span id="l1.139"> }</span>
<a href="#l1.140"></a><span id="l1.140"> </span>
<a href="#l1.141"></a><span id="l1.141"> NS_IMETHODIMP</span>
<a href="#l1.142"></a><span id="l1.142"> nsLDAPConnection::OnLookupComplete(nsICancelable *aRequest,</span>
<a href="#l1.143"></a><span id="l1.143" class="difflineat">@@ -489,17 +488,17 @@ nsLDAPConnection::OnLookupComplete(nsICa</span>
<a href="#l1.144"></a><span id="l1.144">         break;</span>
<a href="#l1.145"></a><span id="l1.145">     }</span>
<a href="#l1.146"></a><span id="l1.146">   } else if (!mResolvedIP.Length()) {</span>
<a href="#l1.147"></a><span id="l1.147">     // We have no host resolved, that is very bad, and should most</span>
<a href="#l1.148"></a><span id="l1.148">     // likely have been caught earlier.</span>
<a href="#l1.149"></a><span id="l1.149">     //</span>
<a href="#l1.150"></a><span id="l1.150">     NS_ERROR(</span>
<a href="#l1.151"></a><span id="l1.151">         &quot;nsLDAPConnection::OnStopLookup(): the resolved IP &quot;</span>
<a href="#l1.152"></a><span id="l1.152" class="difflineminus">-        &quot;string is empty.\n&quot;);</span>
<a href="#l1.153"></a><span id="l1.153" class="difflineplus">+        &quot;string is empty.&quot;);</span>
<a href="#l1.154"></a><span id="l1.154"> </span>
<a href="#l1.155"></a><span id="l1.155">     rv = NS_ERROR_UNKNOWN_HOST;</span>
<a href="#l1.156"></a><span id="l1.156">   } else {</span>
<a href="#l1.157"></a><span id="l1.157">     // We've got the IP(s) for the hostname, now lets setup the</span>
<a href="#l1.158"></a><span id="l1.158">     // LDAP connection using this information. Note that if the</span>
<a href="#l1.159"></a><span id="l1.159">     // LDAP server returns a referral, the C-SDK will perform a</span>
<a href="#l1.160"></a><span id="l1.160">     // new, synchronous DNS lookup, which might hang (but hopefully</span>
<a href="#l1.161"></a><span id="l1.161">     // if we've come this far, DNS is working properly).</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/db/msgdb/src/nsMsgDatabase.cpp</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/db/msgdb/src/nsMsgDatabase.cpp</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -851,21 +851,21 @@ void nsMsgDBService::AddToCache(nsMsgDat</span>
<a href="#l2.4"></a><span id="l2.4">   m_dbCache.AppendElement(pMessageDB);</span>
<a href="#l2.5"></a><span id="l2.5"> }</span>
<a href="#l2.6"></a><span id="l2.6"> </span>
<a href="#l2.7"></a><span id="l2.7"> /**</span>
<a href="#l2.8"></a><span id="l2.8">  * Log the open db's, and how many headers are in memory.</span>
<a href="#l2.9"></a><span id="l2.9">  */</span>
<a href="#l2.10"></a><span id="l2.10"> void nsMsgDBService::DumpCache() {</span>
<a href="#l2.11"></a><span id="l2.11">   nsMsgDatabase *db = nullptr;</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-  MOZ_LOG(DBLog, LogLevel::Info, (&quot;%zu open DBs\n&quot;, m_dbCache.Length()));</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+  MOZ_LOG(DBLog, LogLevel::Info, (&quot;%zu open DBs&quot;, m_dbCache.Length()));</span>
<a href="#l2.14"></a><span id="l2.14">   for (uint32_t i = 0; i &lt; m_dbCache.Length(); i++) {</span>
<a href="#l2.15"></a><span id="l2.15">     db = m_dbCache.ElementAt(i);</span>
<a href="#l2.16"></a><span id="l2.16">     MOZ_LOG(DBLog, LogLevel::Info,</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineminus">-            (&quot;%s - %&quot; PRIu32 &quot; hdrs in use\n&quot;,</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineplus">+            (&quot;%s - %&quot; PRIu32 &quot; hdrs in use&quot;,</span>
<a href="#l2.19"></a><span id="l2.19">              db-&gt;m_dbFile-&gt;HumanReadablePath().get(),</span>
<a href="#l2.20"></a><span id="l2.20">              db-&gt;m_headersInUse ? db-&gt;m_headersInUse-&gt;EntryCount() : 0));</span>
<a href="#l2.21"></a><span id="l2.21">   }</span>
<a href="#l2.22"></a><span id="l2.22"> }</span>
<a href="#l2.23"></a><span id="l2.23"> </span>
<a href="#l2.24"></a><span id="l2.24"> // Memory Reporting implementations</span>
<a href="#l2.25"></a><span id="l2.25"> </span>
<a href="#l2.26"></a><span id="l2.26"> size_t nsMsgDatabase::SizeOfExcludingThis(</span>
<a href="#l2.27"></a><span id="l2.27" class="difflineat">@@ -1014,17 +1014,17 @@ nsMsgDatabase::~nsMsgDatabase() {</span>
<a href="#l2.28"></a><span id="l2.28">   delete m_headersInUse;</span>
<a href="#l2.29"></a><span id="l2.29"> </span>
<a href="#l2.30"></a><span id="l2.30">   if (m_msgReferences) {</span>
<a href="#l2.31"></a><span id="l2.31">     delete m_msgReferences;</span>
<a href="#l2.32"></a><span id="l2.32">     m_msgReferences = nullptr;</span>
<a href="#l2.33"></a><span id="l2.33">   }</span>
<a href="#l2.34"></a><span id="l2.34"> </span>
<a href="#l2.35"></a><span id="l2.35">   MOZ_LOG(DBLog, LogLevel::Info,</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineminus">-          (&quot;closing database    %s\n&quot;, m_dbFile-&gt;HumanReadablePath().get()));</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineplus">+          (&quot;closing database    %s&quot;, m_dbFile-&gt;HumanReadablePath().get()));</span>
<a href="#l2.38"></a><span id="l2.38"> </span>
<a href="#l2.39"></a><span id="l2.39">   nsCOMPtr&lt;nsIMsgDBService&gt; serv(do_GetService(NS_MSGDB_SERVICE_CONTRACTID));</span>
<a href="#l2.40"></a><span id="l2.40">   if (serv) static_cast&lt;nsMsgDBService *&gt;(serv.get())-&gt;RemoveFromCache(this);</span>
<a href="#l2.41"></a><span id="l2.41"> </span>
<a href="#l2.42"></a><span id="l2.42">   // if the db folder info refers to the mdb db, we must clear it because</span>
<a href="#l2.43"></a><span id="l2.43">   // the reference will be a dangling one soon.</span>
<a href="#l2.44"></a><span id="l2.44">   if (m_dbFolderInfo) m_dbFolderInfo-&gt;ReleaseExternalReferences();</span>
<a href="#l2.45"></a><span id="l2.45">   m_dbFolderInfo = nullptr;</span>
<a href="#l2.46"></a><span id="l2.46" class="difflineat">@@ -1068,17 +1068,17 @@ nsresult nsMsgDatabase::Open(nsMsgDBServ</span>
<a href="#l2.47"></a><span id="l2.47">                                      aLeaveInvalidDB,</span>
<a href="#l2.48"></a><span id="l2.48">                                      true /* open synchronously */);</span>
<a href="#l2.49"></a><span id="l2.49"> }</span>
<a href="#l2.50"></a><span id="l2.50"> </span>
<a href="#l2.51"></a><span id="l2.51"> nsresult nsMsgDatabase::OpenInternal(nsMsgDBService *aDBService,</span>
<a href="#l2.52"></a><span id="l2.52">                                      nsIFile *summaryFile, bool aCreate,</span>
<a href="#l2.53"></a><span id="l2.53">                                      bool aLeaveInvalidDB, bool sync) {</span>
<a href="#l2.54"></a><span id="l2.54">   MOZ_LOG(DBLog, LogLevel::Info,</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineminus">-          (&quot;nsMsgDatabase::Open(%s, %s, %p, %s)\n&quot;,</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineplus">+          (&quot;nsMsgDatabase::Open(%s, %s, %p, %s)&quot;,</span>
<a href="#l2.57"></a><span id="l2.57">            summaryFile-&gt;HumanReadablePath().get(), aCreate ? &quot;TRUE&quot; : &quot;FALSE&quot;,</span>
<a href="#l2.58"></a><span id="l2.58">            this, aLeaveInvalidDB ? &quot;TRUE&quot; : &quot;FALSE&quot;));</span>
<a href="#l2.59"></a><span id="l2.59"> </span>
<a href="#l2.60"></a><span id="l2.60">   nsresult rv = OpenMDB(summaryFile, aCreate, sync);</span>
<a href="#l2.61"></a><span id="l2.61">   if (NS_FAILED(rv))</span>
<a href="#l2.62"></a><span id="l2.62">     MOZ_LOG(DBLog, LogLevel::Info,</span>
<a href="#l2.63"></a><span id="l2.63">             (&quot;error opening db %&quot; PRIx32, static_cast&lt;uint32_t&gt;(rv)));</span>
<a href="#l2.64"></a><span id="l2.64"> </span>
<a href="#l2.65"></a><span id="l2.65" class="difflineat">@@ -4005,18 +4005,17 @@ nsIMsgThread *nsMsgDatabase::GetThreadFo</span>
<a href="#l2.66"></a><span id="l2.66">         if (!table) break;</span>
<a href="#l2.67"></a><span id="l2.67">         if (NS_FAILED(rv)) break;</span>
<a href="#l2.68"></a><span id="l2.68"> </span>
<a href="#l2.69"></a><span id="l2.69">         pThread = new nsMsgThread(this, table);</span>
<a href="#l2.70"></a><span id="l2.70">         if (pThread) {</span>
<a href="#l2.71"></a><span id="l2.71">           nsCString curSubject;</span>
<a href="#l2.72"></a><span id="l2.72">           pThread-&gt;GetSubject(curSubject);</span>
<a href="#l2.73"></a><span id="l2.73">           if (subject.Equals(curSubject)) {</span>
<a href="#l2.74"></a><span id="l2.74" class="difflineminus">-            NS_ERROR(</span>
<a href="#l2.75"></a><span id="l2.75" class="difflineminus">-                &quot;thread with subject exists, but FindRow didn't find it\n&quot;);</span>
<a href="#l2.76"></a><span id="l2.76" class="difflineplus">+            NS_ERROR(&quot;thread with subject exists, but FindRow didn't find it&quot;);</span>
<a href="#l2.77"></a><span id="l2.77">             break;</span>
<a href="#l2.78"></a><span id="l2.78">           }</span>
<a href="#l2.79"></a><span id="l2.79">         } else</span>
<a href="#l2.80"></a><span id="l2.80">           break;</span>
<a href="#l2.81"></a><span id="l2.81">       }</span>
<a href="#l2.82"></a><span id="l2.82">     }</span>
<a href="#l2.83"></a><span id="l2.83"> #endif</span>
<a href="#l2.84"></a><span id="l2.84">   }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/local/src/nsMailboxProtocol.cpp</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/local/src/nsMailboxProtocol.cpp</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -364,17 +364,17 @@ NS_IMETHODIMP nsMailboxProtocol::OnStopR</span>
<a href="#l3.4"></a><span id="l3.4">   m_nextState = MAILBOX_DONE;</span>
<a href="#l3.5"></a><span id="l3.5"> </span>
<a href="#l3.6"></a><span id="l3.6">   // the following is for smoke test purposes. QA is looking at this &quot;Mailbox</span>
<a href="#l3.7"></a><span id="l3.7">   // Done&quot; string which is printed out to the console and determining if the</span>
<a href="#l3.8"></a><span id="l3.8">   // mail app loaded up correctly...obviously this solution is not very good so</span>
<a href="#l3.9"></a><span id="l3.9">   // we should look at something better, but don't remove this line before</span>
<a href="#l3.10"></a><span id="l3.10">   // talking to me (mscott) and mailnews QA....</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-  MOZ_LOG(MAILBOX, LogLevel::Info, (&quot;Mailbox Done\n&quot;));</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+  MOZ_LOG(MAILBOX, LogLevel::Info, (&quot;Mailbox Done&quot;));</span>
<a href="#l3.14"></a><span id="l3.14"> </span>
<a href="#l3.15"></a><span id="l3.15">   // when on stop binding is called, we as the protocol are done...let's close</span>
<a href="#l3.16"></a><span id="l3.16">   // down the connection releasing all of our interfaces. It's important to</span>
<a href="#l3.17"></a><span id="l3.17">   // remember that this on stop binding call is coming from netlib so they are</span>
<a href="#l3.18"></a><span id="l3.18">   // never going to ping us again with on data available. This means we'll never</span>
<a href="#l3.19"></a><span id="l3.19">   // be going through the Process loop...</span>
<a href="#l3.20"></a><span id="l3.20"> </span>
<a href="#l3.21"></a><span id="l3.21">   if (m_multipleMsgMoveCopyStream) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/local/src/nsMsgMaildirStore.cpp</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/local/src/nsMsgMaildirStore.cpp</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -242,17 +242,17 @@ NS_IMETHODIMP nsMsgMaildirStore::CreateF</span>
<a href="#l4.4"></a><span id="l4.4">       rv = unusedDB-&gt;GetDBFolderInfo(getter_AddRefs(folderInfo));</span>
<a href="#l4.5"></a><span id="l4.5">       if (NS_SUCCEEDED(rv)) folderInfo-&gt;SetMailboxName(safeFolderName);</span>
<a href="#l4.6"></a><span id="l4.6"> </span>
<a href="#l4.7"></a><span id="l4.7">       unusedDB-&gt;SetSummaryValid(true);</span>
<a href="#l4.8"></a><span id="l4.8">       unusedDB-&gt;Close(true);</span>
<a href="#l4.9"></a><span id="l4.9">       aParent-&gt;UpdateSummaryTotals(true);</span>
<a href="#l4.10"></a><span id="l4.10">     } else {</span>
<a href="#l4.11"></a><span id="l4.11">       MOZ_LOG(MailDirLog, mozilla::LogLevel::Info,</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-              (&quot;CreateFolder - failed creating db for new folder\n&quot;));</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+              (&quot;CreateFolder - failed creating db for new folder&quot;));</span>
<a href="#l4.14"></a><span id="l4.14">       path-&gt;Remove(true);  // recursive</span>
<a href="#l4.15"></a><span id="l4.15">       rv = NS_MSG_CANT_CREATE_FOLDER;</span>
<a href="#l4.16"></a><span id="l4.16">     }</span>
<a href="#l4.17"></a><span id="l4.17">   }</span>
<a href="#l4.18"></a><span id="l4.18">   child.forget(aResult);</span>
<a href="#l4.19"></a><span id="l4.19">   return rv;</span>
<a href="#l4.20"></a><span id="l4.20"> }</span>
<a href="#l4.21"></a><span id="l4.21"> </span>
<a href="#l4.22"></a><span id="l4.22" class="difflineat">@@ -589,17 +589,17 @@ nsMsgMaildirStore::GetNewMsgOutputStream</span>
<a href="#l4.23"></a><span id="l4.23">   newFile-&gt;Append(NS_LITERAL_STRING(&quot;tmp&quot;));</span>
<a href="#l4.24"></a><span id="l4.24"> </span>
<a href="#l4.25"></a><span id="l4.25">   // let's check if the folder exists</span>
<a href="#l4.26"></a><span id="l4.26">   // XXX TODO: kill this and make sure maildir creation includes cur/tmp</span>
<a href="#l4.27"></a><span id="l4.27">   bool exists;</span>
<a href="#l4.28"></a><span id="l4.28">   newFile-&gt;Exists(&amp;exists);</span>
<a href="#l4.29"></a><span id="l4.29">   if (!exists) {</span>
<a href="#l4.30"></a><span id="l4.30">     MOZ_LOG(MailDirLog, mozilla::LogLevel::Info,</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineminus">-            (&quot;GetNewMsgOutputStream - tmp subfolder does not exist!!\n&quot;));</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineplus">+            (&quot;GetNewMsgOutputStream - tmp subfolder does not exist!!&quot;));</span>
<a href="#l4.33"></a><span id="l4.33">     rv = newFile-&gt;Create(nsIFile::DIRECTORY_TYPE, 0755);</span>
<a href="#l4.34"></a><span id="l4.34">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.35"></a><span id="l4.35">   }</span>
<a href="#l4.36"></a><span id="l4.36"> </span>
<a href="#l4.37"></a><span id="l4.37">   // Generate the 'tmp' file name based on timestamp.</span>
<a href="#l4.38"></a><span id="l4.38">   // (We'll use the Message-ID as the basis for the final filename,</span>
<a href="#l4.39"></a><span id="l4.39">   // but we don't have headers at this point).</span>
<a href="#l4.40"></a><span id="l4.40">   nsAutoCString newName;</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineat">@@ -657,17 +657,17 @@ nsMsgMaildirStore::FinishNewMessage(nsIO</span>
<a href="#l4.42"></a><span id="l4.42">   rv = folder-&gt;GetFilePath(getter_AddRefs(folderPath));</span>
<a href="#l4.43"></a><span id="l4.43">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.44"></a><span id="l4.44"> </span>
<a href="#l4.45"></a><span id="l4.45">   // tmp filename is stored in &quot;storeToken&quot;.</span>
<a href="#l4.46"></a><span id="l4.46">   // By now we'll have the Message-ID, which we'll base the final filename on.</span>
<a href="#l4.47"></a><span id="l4.47">   nsAutoCString tmpName;</span>
<a href="#l4.48"></a><span id="l4.48">   aNewHdr-&gt;GetStringProperty(&quot;storeToken&quot;, getter_Copies(tmpName));</span>
<a href="#l4.49"></a><span id="l4.49">   if (tmpName.IsEmpty()) {</span>
<a href="#l4.50"></a><span id="l4.50" class="difflineminus">-    NS_ERROR(&quot;FinishNewMessage - no storeToken in msg hdr!!\n&quot;);</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineplus">+    NS_ERROR(&quot;FinishNewMessage - no storeToken in msg hdr!!&quot;);</span>
<a href="#l4.52"></a><span id="l4.52">     return NS_ERROR_FAILURE;</span>
<a href="#l4.53"></a><span id="l4.53">   }</span>
<a href="#l4.54"></a><span id="l4.54"> </span>
<a href="#l4.55"></a><span id="l4.55">   // path to the new destination</span>
<a href="#l4.56"></a><span id="l4.56">   nsCOMPtr&lt;nsIFile&gt; curPath;</span>
<a href="#l4.57"></a><span id="l4.57">   folderPath-&gt;Clone(getter_AddRefs(curPath));</span>
<a href="#l4.58"></a><span id="l4.58">   curPath-&gt;Append(NS_LITERAL_STRING(&quot;cur&quot;));</span>
<a href="#l4.59"></a><span id="l4.59"> </span>
<a href="#l4.60"></a><span id="l4.60" class="difflineat">@@ -772,17 +772,17 @@ nsMsgMaildirStore::MoveNewlyDownloadedMe</span>
<a href="#l4.61"></a><span id="l4.61">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.62"></a><span id="l4.62">   rv = folder-&gt;GetFilePath(getter_AddRefs(folderPath));</span>
<a href="#l4.63"></a><span id="l4.63">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.64"></a><span id="l4.64"> </span>
<a href="#l4.65"></a><span id="l4.65">   // file path is stored in message header property</span>
<a href="#l4.66"></a><span id="l4.66">   nsAutoCString fileName;</span>
<a href="#l4.67"></a><span id="l4.67">   aHdr-&gt;GetStringProperty(&quot;storeToken&quot;, getter_Copies(fileName));</span>
<a href="#l4.68"></a><span id="l4.68">   if (fileName.IsEmpty()) {</span>
<a href="#l4.69"></a><span id="l4.69" class="difflineminus">-    NS_ERROR(&quot;FinishNewMessage - no storeToken in msg hdr!!\n&quot;);</span>
<a href="#l4.70"></a><span id="l4.70" class="difflineplus">+    NS_ERROR(&quot;FinishNewMessage - no storeToken in msg hdr!!&quot;);</span>
<a href="#l4.71"></a><span id="l4.71">     return NS_ERROR_FAILURE;</span>
<a href="#l4.72"></a><span id="l4.72">   }</span>
<a href="#l4.73"></a><span id="l4.73"> </span>
<a href="#l4.74"></a><span id="l4.74">   // path to the downloaded message</span>
<a href="#l4.75"></a><span id="l4.75">   nsCOMPtr&lt;nsIFile&gt; fromPath;</span>
<a href="#l4.76"></a><span id="l4.76">   folderPath-&gt;Clone(getter_AddRefs(fromPath));</span>
<a href="#l4.77"></a><span id="l4.77">   fromPath-&gt;Append(NS_LITERAL_STRING(&quot;cur&quot;));</span>
<a href="#l4.78"></a><span id="l4.78">   fromPath-&gt;AppendNative(fileName);</span>
<a href="#l4.79"></a><span id="l4.79" class="difflineat">@@ -907,29 +907,29 @@ nsMsgMaildirStore::GetMsgInputStream(nsI</span>
<a href="#l4.80"></a><span id="l4.80"> </span>
<a href="#l4.81"></a><span id="l4.81">   // construct path to file</span>
<a href="#l4.82"></a><span id="l4.82">   nsCOMPtr&lt;nsIFile&gt; path;</span>
<a href="#l4.83"></a><span id="l4.83">   nsresult rv = aMsgFolder-&gt;GetFilePath(getter_AddRefs(path));</span>
<a href="#l4.84"></a><span id="l4.84">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.85"></a><span id="l4.85"> </span>
<a href="#l4.86"></a><span id="l4.86">   if (aMsgToken.IsEmpty()) {</span>
<a href="#l4.87"></a><span id="l4.87">     MOZ_LOG(MailDirLog, mozilla::LogLevel::Info,</span>
<a href="#l4.88"></a><span id="l4.88" class="difflineminus">-            (&quot;GetMsgInputStream - empty storeToken!!\n&quot;));</span>
<a href="#l4.89"></a><span id="l4.89" class="difflineplus">+            (&quot;GetMsgInputStream - empty storeToken!!&quot;));</span>
<a href="#l4.90"></a><span id="l4.90">     return NS_ERROR_FAILURE;</span>
<a href="#l4.91"></a><span id="l4.91">   }</span>
<a href="#l4.92"></a><span id="l4.92"> </span>
<a href="#l4.93"></a><span id="l4.93">   path-&gt;Append(NS_LITERAL_STRING(&quot;cur&quot;));</span>
<a href="#l4.94"></a><span id="l4.94"> </span>
<a href="#l4.95"></a><span id="l4.95">   // let's check if the folder exists</span>
<a href="#l4.96"></a><span id="l4.96">   // XXX TODO: kill this and make sure maildir creation includes cur/tmp</span>
<a href="#l4.97"></a><span id="l4.97">   bool exists;</span>
<a href="#l4.98"></a><span id="l4.98">   path-&gt;Exists(&amp;exists);</span>
<a href="#l4.99"></a><span id="l4.99">   if (!exists) {</span>
<a href="#l4.100"></a><span id="l4.100">     MOZ_LOG(MailDirLog, mozilla::LogLevel::Info,</span>
<a href="#l4.101"></a><span id="l4.101" class="difflineminus">-            (&quot;GetMsgInputStream - oops! cur subfolder does not exist!\n&quot;));</span>
<a href="#l4.102"></a><span id="l4.102" class="difflineplus">+            (&quot;GetMsgInputStream - oops! cur subfolder does not exist!&quot;));</span>
<a href="#l4.103"></a><span id="l4.103">     rv = path-&gt;Create(nsIFile::DIRECTORY_TYPE, 0755);</span>
<a href="#l4.104"></a><span id="l4.104">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.105"></a><span id="l4.105">   }</span>
<a href="#l4.106"></a><span id="l4.106"> </span>
<a href="#l4.107"></a><span id="l4.107">   path-&gt;AppendNative(aMsgToken);</span>
<a href="#l4.108"></a><span id="l4.108">   return NS_NewLocalFileInputStream(aResult, path);</span>
<a href="#l4.109"></a><span id="l4.109"> }</span>
<a href="#l4.110"></a><span id="l4.110"> </span>
<a href="#l4.111"></a><span id="l4.111" class="difflineat">@@ -946,30 +946,30 @@ NS_IMETHODIMP nsMsgMaildirStore::DeleteM</span>
<a href="#l4.112"></a><span id="l4.112">     nsCOMPtr&lt;nsIFile&gt; path;</span>
<a href="#l4.113"></a><span id="l4.113">     rv = folder-&gt;GetFilePath(getter_AddRefs(path));</span>
<a href="#l4.114"></a><span id="l4.114">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.115"></a><span id="l4.115">     nsAutoCString fileName;</span>
<a href="#l4.116"></a><span id="l4.116">     msgHdr-&gt;GetStringProperty(&quot;storeToken&quot;, getter_Copies(fileName));</span>
<a href="#l4.117"></a><span id="l4.117"> </span>
<a href="#l4.118"></a><span id="l4.118">     if (fileName.IsEmpty()) {</span>
<a href="#l4.119"></a><span id="l4.119">       MOZ_LOG(MailDirLog, mozilla::LogLevel::Info,</span>
<a href="#l4.120"></a><span id="l4.120" class="difflineminus">-              (&quot;DeleteMessages - empty storeToken!!\n&quot;));</span>
<a href="#l4.121"></a><span id="l4.121" class="difflineplus">+              (&quot;DeleteMessages - empty storeToken!!&quot;));</span>
<a href="#l4.122"></a><span id="l4.122">       // Perhaps an offline store has not downloaded this particular message.</span>
<a href="#l4.123"></a><span id="l4.123">       continue;</span>
<a href="#l4.124"></a><span id="l4.124">     }</span>
<a href="#l4.125"></a><span id="l4.125"> </span>
<a href="#l4.126"></a><span id="l4.126">     path-&gt;Append(NS_LITERAL_STRING(&quot;cur&quot;));</span>
<a href="#l4.127"></a><span id="l4.127">     path-&gt;AppendNative(fileName);</span>
<a href="#l4.128"></a><span id="l4.128"> </span>
<a href="#l4.129"></a><span id="l4.129">     // Let's check if the message exists.</span>
<a href="#l4.130"></a><span id="l4.130">     bool exists;</span>
<a href="#l4.131"></a><span id="l4.131">     path-&gt;Exists(&amp;exists);</span>
<a href="#l4.132"></a><span id="l4.132">     if (!exists) {</span>
<a href="#l4.133"></a><span id="l4.133">       MOZ_LOG(MailDirLog, mozilla::LogLevel::Info,</span>
<a href="#l4.134"></a><span id="l4.134" class="difflineminus">-              (&quot;DeleteMessages - file does not exist !!\n&quot;));</span>
<a href="#l4.135"></a><span id="l4.135" class="difflineplus">+              (&quot;DeleteMessages - file does not exist !!&quot;));</span>
<a href="#l4.136"></a><span id="l4.136">       // Perhaps an offline store has not downloaded this particular message.</span>
<a href="#l4.137"></a><span id="l4.137">       continue;</span>
<a href="#l4.138"></a><span id="l4.138">     }</span>
<a href="#l4.139"></a><span id="l4.139">     path-&gt;Remove(false);</span>
<a href="#l4.140"></a><span id="l4.140">   }</span>
<a href="#l4.141"></a><span id="l4.141">   return NS_OK;</span>
<a href="#l4.142"></a><span id="l4.142"> }</span>
<a href="#l4.143"></a><span id="l4.143"> </span>
<a href="#l4.144"></a><span id="l4.144" class="difflineat">@@ -1047,27 +1047,27 @@ nsMsgMaildirStore::CopyMessages(bool aIs</span>
<a href="#l4.145"></a><span id="l4.145">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.146"></a><span id="l4.146">   uint32_t messageCount;</span>
<a href="#l4.147"></a><span id="l4.147">   rv = aHdrArray-&gt;GetLength(&amp;messageCount);</span>
<a href="#l4.148"></a><span id="l4.148">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.149"></a><span id="l4.149"> </span>
<a href="#l4.150"></a><span id="l4.150">   for (uint32_t i = 0; i &lt; messageCount; i++) {</span>
<a href="#l4.151"></a><span id="l4.151">     nsCOMPtr&lt;nsIMsgDBHdr&gt; srcHdr = do_QueryElementAt(aHdrArray, i, &amp;rv);</span>
<a href="#l4.152"></a><span id="l4.152">     if (NS_FAILED(rv)) {</span>
<a href="#l4.153"></a><span id="l4.153" class="difflineminus">-      MOZ_LOG(MailDirLog, mozilla::LogLevel::Info, (&quot;srcHdr null\n&quot;));</span>
<a href="#l4.154"></a><span id="l4.154" class="difflineplus">+      MOZ_LOG(MailDirLog, mozilla::LogLevel::Info, (&quot;srcHdr null&quot;));</span>
<a href="#l4.155"></a><span id="l4.155">       continue;</span>
<a href="#l4.156"></a><span id="l4.156">     }</span>
<a href="#l4.157"></a><span id="l4.157">     nsMsgKey srcKey;</span>
<a href="#l4.158"></a><span id="l4.158">     srcHdr-&gt;GetMessageKey(&amp;srcKey);</span>
<a href="#l4.159"></a><span id="l4.159">     msgTxn-&gt;AddSrcKey(srcKey);</span>
<a href="#l4.160"></a><span id="l4.160">     nsAutoCString fileName;</span>
<a href="#l4.161"></a><span id="l4.161">     srcHdr-&gt;GetStringProperty(&quot;storeToken&quot;, getter_Copies(fileName));</span>
<a href="#l4.162"></a><span id="l4.162">     if (fileName.IsEmpty()) {</span>
<a href="#l4.163"></a><span id="l4.163">       MOZ_LOG(MailDirLog, mozilla::LogLevel::Info,</span>
<a href="#l4.164"></a><span id="l4.164" class="difflineminus">-              (&quot;GetMsgInputStream - empty storeToken!!\n&quot;));</span>
<a href="#l4.165"></a><span id="l4.165" class="difflineplus">+              (&quot;GetMsgInputStream - empty storeToken!!&quot;));</span>
<a href="#l4.166"></a><span id="l4.166">       return NS_ERROR_FAILURE;</span>
<a href="#l4.167"></a><span id="l4.167">     }</span>
<a href="#l4.168"></a><span id="l4.168"> </span>
<a href="#l4.169"></a><span id="l4.169">     nsCOMPtr&lt;nsIFile&gt; srcFile;</span>
<a href="#l4.170"></a><span id="l4.170">     rv = srcFolderPath-&gt;Clone(getter_AddRefs(srcFile));</span>
<a href="#l4.171"></a><span id="l4.171">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.172"></a><span id="l4.172">     srcFile-&gt;AppendNative(fileName);</span>
<a href="#l4.173"></a><span id="l4.173"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/mapi/mapihook/src/msgMapiImp.cpp</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/mapi/mapihook/src/msgMapiImp.cpp</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -99,25 +99,25 @@ STDMETHODIMP CMapiImp::Initialize() {</span>
<a href="#l5.4"></a><span id="l5.4"> STDMETHODIMP CMapiImp::Login(unsigned long aUIArg, LPSTR aLogin,</span>
<a href="#l5.5"></a><span id="l5.5">                              LPSTR aPassWord, unsigned long aFlags,</span>
<a href="#l5.6"></a><span id="l5.6">                              unsigned long *aSessionId) {</span>
<a href="#l5.7"></a><span id="l5.7">   HRESULT hr = E_FAIL;</span>
<a href="#l5.8"></a><span id="l5.8">   bool bNewSession = false;</span>
<a href="#l5.9"></a><span id="l5.9">   nsCString id_key;</span>
<a href="#l5.10"></a><span id="l5.10"> </span>
<a href="#l5.11"></a><span id="l5.11">   MOZ_LOG(MAPI, mozilla::LogLevel::Debug,</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-          (&quot;CMapiImp::Login using flags %d\n&quot;, aFlags));</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+          (&quot;CMapiImp::Login using flags %d&quot;, aFlags));</span>
<a href="#l5.14"></a><span id="l5.14">   if (aFlags &amp; MAPI_NEW_SESSION) bNewSession = true;</span>
<a href="#l5.15"></a><span id="l5.15"> </span>
<a href="#l5.16"></a><span id="l5.16">   // Check For Profile Name</span>
<a href="#l5.17"></a><span id="l5.17">   if (aLogin != nullptr &amp;&amp; aLogin[0] != '\0') {</span>
<a href="#l5.18"></a><span id="l5.18">     if (!nsMapiHook::VerifyUserName(nsDependentCString(aLogin), id_key)) {</span>
<a href="#l5.19"></a><span id="l5.19">       *aSessionId = MAPI_E_LOGIN_FAILURE;</span>
<a href="#l5.20"></a><span id="l5.20">       MOZ_LOG(MAPI, mozilla::LogLevel::Debug,</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineminus">-              (&quot;CMapiImp::Login failed for username %s\n&quot;, aLogin));</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineplus">+              (&quot;CMapiImp::Login failed for username %s&quot;, aLogin));</span>
<a href="#l5.23"></a><span id="l5.23">       NS_ASSERTION(false, &quot;failed verifying user name&quot;);</span>
<a href="#l5.24"></a><span id="l5.24">       return hr;</span>
<a href="#l5.25"></a><span id="l5.25">     }</span>
<a href="#l5.26"></a><span id="l5.26">   } else {</span>
<a href="#l5.27"></a><span id="l5.27">     // get default account</span>
<a href="#l5.28"></a><span id="l5.28">     nsresult rv;</span>
<a href="#l5.29"></a><span id="l5.29">     nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l5.30"></a><span id="l5.30">         do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineat">@@ -152,29 +152,29 @@ STDMETHODIMP CMapiImp::Login(unsigned lo</span>
<a href="#l5.32"></a><span id="l5.32">       return hr;</span>
<a href="#l5.33"></a><span id="l5.33">     }</span>
<a href="#l5.34"></a><span id="l5.34">     case 0: {</span>
<a href="#l5.35"></a><span id="l5.35">       *aSessionId = MAPI_E_INSUFFICIENT_MEMORY;</span>
<a href="#l5.36"></a><span id="l5.36">       return hr;</span>
<a href="#l5.37"></a><span id="l5.37">     }</span>
<a href="#l5.38"></a><span id="l5.38">     default: {</span>
<a href="#l5.39"></a><span id="l5.39">       *aSessionId = nSession_Id;</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineminus">-      MOZ_LOG(MAPI, mozilla::LogLevel::Debug, (&quot;CMapiImp::Login succeeded\n&quot;));</span>
<a href="#l5.41"></a><span id="l5.41" class="difflineplus">+      MOZ_LOG(MAPI, mozilla::LogLevel::Debug, (&quot;CMapiImp::Login succeeded&quot;));</span>
<a href="#l5.42"></a><span id="l5.42">       break;</span>
<a href="#l5.43"></a><span id="l5.43">     }</span>
<a href="#l5.44"></a><span id="l5.44">   }</span>
<a href="#l5.45"></a><span id="l5.45"> </span>
<a href="#l5.46"></a><span id="l5.46">   return S_OK;</span>
<a href="#l5.47"></a><span id="l5.47"> }</span>
<a href="#l5.48"></a><span id="l5.48"> </span>
<a href="#l5.49"></a><span id="l5.49"> STDMETHODIMP CMapiImp::SendMail(unsigned long aSession,</span>
<a href="#l5.50"></a><span id="l5.50">                                 lpnsMapiMessage aMessage, unsigned long aFlags,</span>
<a href="#l5.51"></a><span id="l5.51">                                 unsigned long aReserved) {</span>
<a href="#l5.52"></a><span id="l5.52">   MOZ_LOG(MAPI, mozilla::LogLevel::Debug,</span>
<a href="#l5.53"></a><span id="l5.53" class="difflineminus">-          (&quot;CMapiImp::SendMail flags=%lx subject: %s sender: %s\n&quot;, aFlags,</span>
<a href="#l5.54"></a><span id="l5.54" class="difflineplus">+          (&quot;CMapiImp::SendMail flags=%lx subject: %s sender: %s&quot;, aFlags,</span>
<a href="#l5.55"></a><span id="l5.55">            (aMessage &amp;&amp; aMessage-&gt;lpszSubject) ? aMessage-&gt;lpszSubject</span>
<a href="#l5.56"></a><span id="l5.56">                                                : &quot;(no subject)&quot;,</span>
<a href="#l5.57"></a><span id="l5.57">            (aMessage &amp;&amp; aMessage-&gt;lpOriginator &amp;&amp;</span>
<a href="#l5.58"></a><span id="l5.58">             aMessage-&gt;lpOriginator-&gt;lpszAddress)</span>
<a href="#l5.59"></a><span id="l5.59">                ? aMessage-&gt;lpOriginator-&gt;lpszAddress</span>
<a href="#l5.60"></a><span id="l5.60">                : &quot;(no sender)&quot;));</span>
<a href="#l5.61"></a><span id="l5.61"> </span>
<a href="#l5.62"></a><span id="l5.62">   /** create nsIMsgCompFields obj and populate it **/</span>
<a href="#l5.63"></a><span id="l5.63" class="difflineat">@@ -199,17 +199,17 @@ STDMETHODIMP CMapiImp::SendMail(unsigned</span>
<a href="#l5.64"></a><span id="l5.64"> }</span>
<a href="#l5.65"></a><span id="l5.65"> </span>
<a href="#l5.66"></a><span id="l5.66"> STDMETHODIMP CMapiImp::SendMailW(unsigned long aSession,</span>
<a href="#l5.67"></a><span id="l5.67">                                  lpnsMapiMessageW aMessage,</span>
<a href="#l5.68"></a><span id="l5.68">                                  unsigned long aFlags,</span>
<a href="#l5.69"></a><span id="l5.69">                                  unsigned long aReserved) {</span>
<a href="#l5.70"></a><span id="l5.70">   MOZ_LOG(</span>
<a href="#l5.71"></a><span id="l5.71">       MAPI, mozilla::LogLevel::Debug,</span>
<a href="#l5.72"></a><span id="l5.72" class="difflineminus">-      (&quot;CMapiImp::SendMailW flags=%lx subject: %s sender: %s\n&quot;, aFlags,</span>
<a href="#l5.73"></a><span id="l5.73" class="difflineplus">+      (&quot;CMapiImp::SendMailW flags=%lx subject: %s sender: %s&quot;, aFlags,</span>
<a href="#l5.74"></a><span id="l5.74">        (aMessage &amp;&amp; aMessage-&gt;lpszSubject)</span>
<a href="#l5.75"></a><span id="l5.75">            ? NS_ConvertUTF16toUTF8(aMessage-&gt;lpszSubject).get()</span>
<a href="#l5.76"></a><span id="l5.76">            : &quot;(no subject)&quot;,</span>
<a href="#l5.77"></a><span id="l5.77">        (aMessage &amp;&amp; aMessage-&gt;lpOriginator &amp;&amp;</span>
<a href="#l5.78"></a><span id="l5.78">         aMessage-&gt;lpOriginator-&gt;lpszAddress)</span>
<a href="#l5.79"></a><span id="l5.79">            ? NS_ConvertUTF16toUTF8(aMessage-&gt;lpOriginator-&gt;lpszAddress).get()</span>
<a href="#l5.80"></a><span id="l5.80">            : &quot;(no sender)&quot;));</span>
<a href="#l5.81"></a><span id="l5.81"> </span>
<a href="#l5.82"></a><span id="l5.82" class="difflineat">@@ -234,33 +234,33 @@ STDMETHODIMP CMapiImp::SendMailW(unsigne</span>
<a href="#l5.83"></a><span id="l5.83"> }</span>
<a href="#l5.84"></a><span id="l5.84"> </span>
<a href="#l5.85"></a><span id="l5.85"> STDMETHODIMP CMapiImp::SendDocuments(unsigned long aSession, LPSTR aDelimChar,</span>
<a href="#l5.86"></a><span id="l5.86">                                      LPSTR aFilePaths, LPSTR aFileNames,</span>
<a href="#l5.87"></a><span id="l5.87">                                      ULONG aFlags) {</span>
<a href="#l5.88"></a><span id="l5.88">   nsresult rv = NS_OK;</span>
<a href="#l5.89"></a><span id="l5.89"> </span>
<a href="#l5.90"></a><span id="l5.90">   MOZ_LOG(MAPI, mozilla::LogLevel::Debug,</span>
<a href="#l5.91"></a><span id="l5.91" class="difflineminus">-          (&quot;CMapiImp::SendDocument using flags %d\n&quot;, aFlags));</span>
<a href="#l5.92"></a><span id="l5.92" class="difflineplus">+          (&quot;CMapiImp::SendDocument using flags %d&quot;, aFlags));</span>
<a href="#l5.93"></a><span id="l5.93">   /** create nsIMsgCompFields obj and populate it **/</span>
<a href="#l5.94"></a><span id="l5.94">   nsCOMPtr&lt;nsIMsgCompFields&gt; pCompFields =</span>
<a href="#l5.95"></a><span id="l5.95">       do_CreateInstance(NS_MSGCOMPFIELDS_CONTRACTID, &amp;rv);</span>
<a href="#l5.96"></a><span id="l5.96">   if (NS_FAILED(rv) || (!pCompFields)) return MAPI_E_INSUFFICIENT_MEMORY;</span>
<a href="#l5.97"></a><span id="l5.97"> </span>
<a href="#l5.98"></a><span id="l5.98">   if (aFilePaths) {</span>
<a href="#l5.99"></a><span id="l5.99">     rv = nsMapiHook::PopulateCompFieldsForSendDocs(pCompFields, aFlags,</span>
<a href="#l5.100"></a><span id="l5.100">                                                    aDelimChar, aFilePaths);</span>
<a href="#l5.101"></a><span id="l5.101">   }</span>
<a href="#l5.102"></a><span id="l5.102"> </span>
<a href="#l5.103"></a><span id="l5.103">   if (NS_SUCCEEDED(rv))</span>
<a href="#l5.104"></a><span id="l5.104">     rv = nsMapiHook::ShowComposerWindow(aSession, pCompFields);</span>
<a href="#l5.105"></a><span id="l5.105">   else</span>
<a href="#l5.106"></a><span id="l5.106">     MOZ_LOG(MAPI, mozilla::LogLevel::Debug,</span>
<a href="#l5.107"></a><span id="l5.107" class="difflineminus">-            (&quot;CMapiImp::SendDocument error rv = %lx, paths = %s names = %s\n&quot;,</span>
<a href="#l5.108"></a><span id="l5.108" class="difflineminus">-             rv, aFilePaths, aFileNames));</span>
<a href="#l5.109"></a><span id="l5.109" class="difflineplus">+            (&quot;CMapiImp::SendDocument error rv = %lx, paths = %s names = %s&quot;, rv,</span>
<a href="#l5.110"></a><span id="l5.110" class="difflineplus">+             aFilePaths, aFileNames));</span>
<a href="#l5.111"></a><span id="l5.111"> </span>
<a href="#l5.112"></a><span id="l5.112">   return nsMAPIConfiguration::GetMAPIErrorFromNSError(rv);</span>
<a href="#l5.113"></a><span id="l5.113"> }</span>
<a href="#l5.114"></a><span id="l5.114"> </span>
<a href="#l5.115"></a><span id="l5.115"> nsresult CMapiImp::GetDefaultInbox(nsIMsgFolder **inboxFolder) {</span>
<a href="#l5.116"></a><span id="l5.116">   // get default account</span>
<a href="#l5.117"></a><span id="l5.117">   nsresult rv;</span>
<a href="#l5.118"></a><span id="l5.118">   nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l5.119"></a><span id="l5.119" class="difflineat">@@ -390,28 +390,28 @@ STDMETHODIMP CMapiImp::FindNext(unsigned</span>
<a href="#l5.120"></a><span id="l5.120">     }</span>
<a href="#l5.121"></a><span id="l5.121"> </span>
<a href="#l5.122"></a><span id="l5.122">     //    TRACE(&quot;MAPI: ProcessMAPIFindNext() Found message id = %d\n&quot;, nextKey);</span>
<a href="#l5.123"></a><span id="l5.123"> </span>
<a href="#l5.124"></a><span id="l5.124">     sprintf((char *)lpszMessageID, &quot;%d&quot;, nextKey);</span>
<a href="#l5.125"></a><span id="l5.125">   }</span>
<a href="#l5.126"></a><span id="l5.126"> </span>
<a href="#l5.127"></a><span id="l5.127">   MOZ_LOG(MAPI, mozilla::LogLevel::Debug,</span>
<a href="#l5.128"></a><span id="l5.128" class="difflineminus">-          (&quot;CMapiImp::FindNext returning key %s\n&quot;, (char *)lpszMessageID));</span>
<a href="#l5.129"></a><span id="l5.129" class="difflineplus">+          (&quot;CMapiImp::FindNext returning key %s&quot;, (char *)lpszMessageID));</span>
<a href="#l5.130"></a><span id="l5.130">   return (SUCCESS_SUCCESS);</span>
<a href="#l5.131"></a><span id="l5.131"> }</span>
<a href="#l5.132"></a><span id="l5.132"> </span>
<a href="#l5.133"></a><span id="l5.133"> STDMETHODIMP CMapiImp::ReadMail(unsigned long aSession, unsigned long ulUIParam,</span>
<a href="#l5.134"></a><span id="l5.134">                                 LPSTR lpszMessageID, unsigned long flFlags,</span>
<a href="#l5.135"></a><span id="l5.135">                                 unsigned long ulReserved,</span>
<a href="#l5.136"></a><span id="l5.136">                                 lpnsMapiMessage *lppMessage) {</span>
<a href="#l5.137"></a><span id="l5.137">   nsresult irv;</span>
<a href="#l5.138"></a><span id="l5.138">   nsAutoCString keyString((char *)lpszMessageID);</span>
<a href="#l5.139"></a><span id="l5.139">   MOZ_LOG(MAPI, mozilla::LogLevel::Debug,</span>
<a href="#l5.140"></a><span id="l5.140" class="difflineminus">-          (&quot;CMapiImp::ReadMail asking for key %s\n&quot;, (char *)lpszMessageID));</span>
<a href="#l5.141"></a><span id="l5.141" class="difflineplus">+          (&quot;CMapiImp::ReadMail asking for key %s&quot;, (char *)lpszMessageID));</span>
<a href="#l5.142"></a><span id="l5.142">   nsMsgKey msgKey = keyString.ToInteger(&amp;irv);</span>
<a href="#l5.143"></a><span id="l5.143">   if (NS_FAILED(irv)) {</span>
<a href="#l5.144"></a><span id="l5.144">     NS_ASSERTION(false, &quot;invalid lpszMessageID&quot;);</span>
<a href="#l5.145"></a><span id="l5.145">     return MAPI_E_INVALID_MESSAGE;</span>
<a href="#l5.146"></a><span id="l5.146">   }</span>
<a href="#l5.147"></a><span id="l5.147">   MsgMapiListContext *listContext;</span>
<a href="#l5.148"></a><span id="l5.148">   LONG ret = InitContext(aSession, &amp;listContext);</span>
<a href="#l5.149"></a><span id="l5.149">   if (ret != SUCCESS_SUCCESS) {</span>
<a href="#l5.150"></a><span id="l5.150" class="difflineat">@@ -586,17 +586,17 @@ lpnsMapiMessage MsgMapiListContext::GetM</span>
<a href="#l5.151"></a><span id="l5.151">         ConvertRecipientsToMapiFormat(parsedToRecips, message-&gt;lpRecips,</span>
<a href="#l5.152"></a><span id="l5.152">                                       MAPI_TO);</span>
<a href="#l5.153"></a><span id="l5.153">         ConvertRecipientsToMapiFormat(parsedCCRecips,</span>
<a href="#l5.154"></a><span id="l5.154">                                       &amp;message-&gt;lpRecips[numToRecips], MAPI_CC);</span>
<a href="#l5.155"></a><span id="l5.155">       }</span>
<a href="#l5.156"></a><span id="l5.156"> </span>
<a href="#l5.157"></a><span id="l5.157">       MOZ_LOG(MAPI, mozilla::LogLevel::Debug,</span>
<a href="#l5.158"></a><span id="l5.158">               (&quot;MsgMapiListContext::GetMessage flags=%x subject %s date %s &quot;</span>
<a href="#l5.159"></a><span id="l5.159" class="difflineminus">-               &quot;sender %s\n&quot;,</span>
<a href="#l5.160"></a><span id="l5.160" class="difflineplus">+               &quot;sender %s&quot;,</span>
<a href="#l5.161"></a><span id="l5.161">                flFlags, (char *)message-&gt;lpszSubject,</span>
<a href="#l5.162"></a><span id="l5.162">                (char *)message-&gt;lpszDateReceived, author.get()));</span>
<a href="#l5.163"></a><span id="l5.163"> </span>
<a href="#l5.164"></a><span id="l5.164">       // Convert any body text that we have locally</span>
<a href="#l5.165"></a><span id="l5.165">       if (!(flFlags &amp; MAPI_ENVELOPE_ONLY))</span>
<a href="#l5.166"></a><span id="l5.166">         message-&gt;lpszNoteText = (char *)ConvertBodyToMapiFormat(msgHdr);</span>
<a href="#l5.167"></a><span id="l5.167">     }</span>
<a href="#l5.168"></a><span id="l5.168">     if (!(flFlags &amp; (MAPI_PEEK | MAPI_ENVELOPE_ONLY)))</span>
<a href="#l5.169"></a><span id="l5.169" class="difflineat">@@ -698,20 +698,19 @@ char *MsgMapiListContext::ConvertBodyToM</span>
<a href="#l5.170"></a><span id="l5.170">     if (NS_FAILED(rv)) break;</span>
<a href="#l5.171"></a><span id="l5.171">     curLine.Append(CRLF);</span>
<a href="#l5.172"></a><span id="l5.172">     // make sure we have room left</span>
<a href="#l5.173"></a><span id="l5.173">     if (bytesCopied + curLine.Length() &lt; msgSize) {</span>
<a href="#l5.174"></a><span id="l5.174">       strcpy(body + bytesCopied, curLine.get());</span>
<a href="#l5.175"></a><span id="l5.175">       bytesCopied += curLine.Length();</span>
<a href="#l5.176"></a><span id="l5.176">     }</span>
<a href="#l5.177"></a><span id="l5.177">   }</span>
<a href="#l5.178"></a><span id="l5.178" class="difflineminus">-  MOZ_LOG(</span>
<a href="#l5.179"></a><span id="l5.179" class="difflineminus">-      MAPI, mozilla::LogLevel::Debug,</span>
<a href="#l5.180"></a><span id="l5.180" class="difflineminus">-      (&quot;ConvertBodyToMapiFormat size=%x allocated size %x body = %100.100s\n&quot;,</span>
<a href="#l5.181"></a><span id="l5.181" class="difflineminus">-       bytesCopied, msgSize + 1, (char *)body));</span>
<a href="#l5.182"></a><span id="l5.182" class="difflineplus">+  MOZ_LOG(MAPI, mozilla::LogLevel::Debug,</span>
<a href="#l5.183"></a><span id="l5.183" class="difflineplus">+          (&quot;ConvertBodyToMapiFormat size=%x allocated size %x body = %100.100s&quot;,</span>
<a href="#l5.184"></a><span id="l5.184" class="difflineplus">+           bytesCopied, msgSize + 1, (char *)body));</span>
<a href="#l5.185"></a><span id="l5.185">   body[bytesCopied] = '\0';  // rhp - fix last line garbage...</span>
<a href="#l5.186"></a><span id="l5.186">   return body;</span>
<a href="#l5.187"></a><span id="l5.187"> }</span>
<a href="#l5.188"></a><span id="l5.188"> </span>
<a href="#l5.189"></a><span id="l5.189"> //*****************************************************************************</span>
<a href="#l5.190"></a><span id="l5.190"> // MSGMAPI API implementation</span>
<a href="#l5.191"></a><span id="l5.191"> </span>
<a href="#l5.192"></a><span id="l5.192"> static void msg_FreeMAPIFile(lpMapiFileDesc f) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/news/src/nsNNTPProtocol.cpp</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/news/src/nsNNTPProtocol.cpp</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -2707,17 +2707,17 @@ NS_IMETHODIMP</span>
<a href="#l6.4"></a><span id="l6.4"> nsNNTPProtocol::Notify(nsITimer *timer) {</span>
<a href="#l6.5"></a><span id="l6.5">   NS_ASSERTION(timer == mUpdateTimer.get(), &quot;Hey, this ain't my timer!&quot;);</span>
<a href="#l6.6"></a><span id="l6.6">   mUpdateTimer = nullptr;  // release my hold</span>
<a href="#l6.7"></a><span id="l6.7">   TimerCallback();</span>
<a href="#l6.8"></a><span id="l6.8">   return NS_OK;</span>
<a href="#l6.9"></a><span id="l6.9"> }</span>
<a href="#l6.10"></a><span id="l6.10"> </span>
<a href="#l6.11"></a><span id="l6.11"> void nsNNTPProtocol::TimerCallback() {</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-  MOZ_LOG(NNTP, LogLevel::Info, (&quot;nsNNTPProtocol::TimerCallback\n&quot;));</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+  MOZ_LOG(NNTP, LogLevel::Info, (&quot;nsNNTPProtocol::TimerCallback&quot;));</span>
<a href="#l6.14"></a><span id="l6.14">   m_nextState = NNTP_READ_LIST;</span>
<a href="#l6.15"></a><span id="l6.15"> </span>
<a href="#l6.16"></a><span id="l6.16">   // process whatever is already in the buffer at least once.</span>
<a href="#l6.17"></a><span id="l6.17">   //</span>
<a href="#l6.18"></a><span id="l6.18">   // NOTE: while downloading, it would almost be enough to just</span>
<a href="#l6.19"></a><span id="l6.19">   // resume necko since it will call us again with data.  however,</span>
<a href="#l6.20"></a><span id="l6.20">   // if we are at the end of the data stream then we must call</span>
<a href="#l6.21"></a><span id="l6.21">   // ProcessProtocolState since necko will not call us again.</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:31Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

