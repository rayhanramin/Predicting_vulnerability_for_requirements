<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 27267:16c3cbd617513c848568915c5995def8d5d59bb9</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 16c3cbd617513c848568915c5995def8d5d59bb9" />
<meta property="og:url" content="/comm-central/rev/16c3cbd617513c848568915c5995def8d5d59bb9" />
<meta property="og:description" content="Bug 1554629 - [de-xbl] convert the tabmail binding to a custom element. r=mkmelin" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 16c3cbd617513c848568915c5995def8d5d59bb9 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/16c3cbd617513c848568915c5995def8d5d59bb9">shortlog</a> |
<a href="/comm-central/log/16c3cbd617513c848568915c5995def8d5d59bb9">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/16c3cbd617513c848568915c5995def8d5d59bb9">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/16c3cbd617513c848568915c5995def8d5d59bb9">files</a> |
changeset |
<a href="/comm-central/raw-rev/16c3cbd617513c848568915c5995def8d5d59bb9">raw</a>  | <a href="/comm-central/archive/16c3cbd617513c848568915c5995def8d5d59bb9.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1554629">Bug 1554629</a> - [de-xbl] convert the tabmail binding to a custom element. r=mkmelin
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#65;&#108;&#101;&#115;&#115;&#97;&#110;&#100;&#114;&#111;&#32;&#67;&#97;&#115;&#116;&#101;&#108;&#108;&#97;&#110;&#105;&#32;&#60;&#97;&#108;&#101;&#115;&#115;&#97;&#110;&#100;&#114;&#111;&#64;&#116;&#104;&#117;&#110;&#100;&#101;&#114;&#98;&#105;&#114;&#100;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Tue, 06 Aug 2019 10:45:31 -0700</td></tr>

<tr>
 <td>changeset 27267</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/16c3cbd617513c848568915c5995def8d5d59bb9">16c3cbd617513c848568915c5995def8d5d59bb9</a></td>
</tr>



<tr>
<td>parent 27266</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/c423618c2ac68e4da05d5b9ed1801eba165deca3">c423618c2ac68e4da05d5b9ed1801eba165deca3</a>
</td>
</tr>

<tr>
<td>child 27268</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/f7afb221aa108f42bcd2842146376f0e8f899e6b">f7afb221aa108f42bcd2842146376f0e8f899e6b</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=16c3cbd617513c848568915c5995def8d5d59bb9">16260</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Tue, 06 Aug 2019 21:48:32 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@16c3cbd61751 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=16c3cbd617513c848568915c5995def8d5d59bb9">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=16c3cbd617513c848568915c5995def8d5d59bb9&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=16c3cbd617513c848568915c5995def8d5d59bb9&newProject=comm-central&newRevision=c423618c2ac68e4da05d5b9ed1801eba165deca3&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=16c3cbd617513c848568915c5995def8d5d59bb9&newProject=comm-central&newRevision=c423618c2ac68e4da05d5b9ed1801eba165deca3&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=16c3cbd617513c848568915c5995def8d5d59bb9&newProject=comm-central&newRevision=c423618c2ac68e4da05d5b9ed1801eba165deca3&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28mkmelin%29&revcount=50">mkmelin</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1554629">1554629</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1554629">Bug 1554629</a> - [de-xbl] convert the tabmail binding to a custom element. r=mkmelin</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/16c3cbd617513c848568915c5995def8d5d59bb9/calendar/base/content/calendar-common-sets.js">calendar/base/content/calendar-common-sets.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/16c3cbd617513c848568915c5995def8d5d59bb9/calendar/base/content/calendar-common-sets.js">file</a> |
<a href="/comm-central/annotate/16c3cbd617513c848568915c5995def8d5d59bb9/calendar/base/content/calendar-common-sets.js">annotate</a> |
<a href="/comm-central/diff/16c3cbd617513c848568915c5995def8d5d59bb9/calendar/base/content/calendar-common-sets.js">diff</a> |
<a href="/comm-central/comparison/16c3cbd617513c848568915c5995def8d5d59bb9/calendar/base/content/calendar-common-sets.js">comparison</a> |
<a href="/comm-central/log/16c3cbd617513c848568915c5995def8d5d59bb9/calendar/base/content/calendar-common-sets.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/16c3cbd617513c848568915c5995def8d5d59bb9/calendar/lightning/content/messenger-overlay-sidebar.js">calendar/lightning/content/messenger-overlay-sidebar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/16c3cbd617513c848568915c5995def8d5d59bb9/calendar/lightning/content/messenger-overlay-sidebar.js">file</a> |
<a href="/comm-central/annotate/16c3cbd617513c848568915c5995def8d5d59bb9/calendar/lightning/content/messenger-overlay-sidebar.js">annotate</a> |
<a href="/comm-central/diff/16c3cbd617513c848568915c5995def8d5d59bb9/calendar/lightning/content/messenger-overlay-sidebar.js">diff</a> |
<a href="/comm-central/comparison/16c3cbd617513c848568915c5995def8d5d59bb9/calendar/lightning/content/messenger-overlay-sidebar.js">comparison</a> |
<a href="/comm-central/log/16c3cbd617513c848568915c5995def8d5d59bb9/calendar/lightning/content/messenger-overlay-sidebar.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/16c3cbd617513c848568915c5995def8d5d59bb9/mail/base/content/messenger.css">mail/base/content/messenger.css</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/16c3cbd617513c848568915c5995def8d5d59bb9/mail/base/content/messenger.css">file</a> |
<a href="/comm-central/annotate/16c3cbd617513c848568915c5995def8d5d59bb9/mail/base/content/messenger.css">annotate</a> |
<a href="/comm-central/diff/16c3cbd617513c848568915c5995def8d5d59bb9/mail/base/content/messenger.css">diff</a> |
<a href="/comm-central/comparison/16c3cbd617513c848568915c5995def8d5d59bb9/mail/base/content/messenger.css">comparison</a> |
<a href="/comm-central/log/16c3cbd617513c848568915c5995def8d5d59bb9/mail/base/content/messenger.css">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/16c3cbd617513c848568915c5995def8d5d59bb9/mail/base/content/messenger.xul">mail/base/content/messenger.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/16c3cbd617513c848568915c5995def8d5d59bb9/mail/base/content/messenger.xul">file</a> |
<a href="/comm-central/annotate/16c3cbd617513c848568915c5995def8d5d59bb9/mail/base/content/messenger.xul">annotate</a> |
<a href="/comm-central/diff/16c3cbd617513c848568915c5995def8d5d59bb9/mail/base/content/messenger.xul">diff</a> |
<a href="/comm-central/comparison/16c3cbd617513c848568915c5995def8d5d59bb9/mail/base/content/messenger.xul">comparison</a> |
<a href="/comm-central/log/16c3cbd617513c848568915c5995def8d5d59bb9/mail/base/content/messenger.xul">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/16c3cbd617513c848568915c5995def8d5d59bb9/mail/base/content/tabmail.js">mail/base/content/tabmail.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/16c3cbd617513c848568915c5995def8d5d59bb9/mail/base/content/tabmail.js">file</a> |
<a href="/comm-central/annotate/16c3cbd617513c848568915c5995def8d5d59bb9/mail/base/content/tabmail.js">annotate</a> |
<a href="/comm-central/diff/16c3cbd617513c848568915c5995def8d5d59bb9/mail/base/content/tabmail.js">diff</a> |
<a href="/comm-central/comparison/16c3cbd617513c848568915c5995def8d5d59bb9/mail/base/content/tabmail.js">comparison</a> |
<a href="/comm-central/log/16c3cbd617513c848568915c5995def8d5d59bb9/mail/base/content/tabmail.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/16c3cbd617513c848568915c5995def8d5d59bb9/mail/base/content/tabmail.xml">mail/base/content/tabmail.xml</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/16c3cbd617513c848568915c5995def8d5d59bb9/mail/base/content/tabmail.xml">diff</a> |
<a href="/comm-central/comparison/16c3cbd617513c848568915c5995def8d5d59bb9/mail/base/content/tabmail.xml">comparison</a> |
<a href="/comm-central/log/16c3cbd617513c848568915c5995def8d5d59bb9/mail/base/content/tabmail.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/16c3cbd617513c848568915c5995def8d5d59bb9/mail/base/jar.mn">mail/base/jar.mn</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/16c3cbd617513c848568915c5995def8d5d59bb9/mail/base/jar.mn">file</a> |
<a href="/comm-central/annotate/16c3cbd617513c848568915c5995def8d5d59bb9/mail/base/jar.mn">annotate</a> |
<a href="/comm-central/diff/16c3cbd617513c848568915c5995def8d5d59bb9/mail/base/jar.mn">diff</a> |
<a href="/comm-central/comparison/16c3cbd617513c848568915c5995def8d5d59bb9/mail/base/jar.mn">comparison</a> |
<a href="/comm-central/log/16c3cbd617513c848568915c5995def8d5d59bb9/mail/base/jar.mn">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/calendar/base/content/calendar-common-sets.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/calendar/base/content/calendar-common-sets.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -787,17 +787,17 @@ var calendarController2 = {</span>
<a href="#l1.4"></a><span id="l1.4"> };</span>
<a href="#l1.5"></a><span id="l1.5"> </span>
<a href="#l1.6"></a><span id="l1.6"> /**</span>
<a href="#l1.7"></a><span id="l1.7">  * Inserts the command controller into the document. On Lightning, also make</span>
<a href="#l1.8"></a><span id="l1.8">  * sure that it is inserted before the conflicting Thunderbird command</span>
<a href="#l1.9"></a><span id="l1.9">  * controller.</span>
<a href="#l1.10"></a><span id="l1.10">  */</span>
<a href="#l1.11"></a><span id="l1.11"> function injectCalendarCommandController() {</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-    calendarController.defaultController = document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+    calendarController.defaultController = document.getElementById(&quot;tabmail&quot;).tabController;</span>
<a href="#l1.14"></a><span id="l1.14">     top.controllers.insertControllerAt(0, calendarController);</span>
<a href="#l1.15"></a><span id="l1.15">     document.commandDispatcher.updateCommands(&quot;calendar_commands&quot;);</span>
<a href="#l1.16"></a><span id="l1.16"> }</span>
<a href="#l1.17"></a><span id="l1.17"> </span>
<a href="#l1.18"></a><span id="l1.18"> /**</span>
<a href="#l1.19"></a><span id="l1.19">  * Remove the calendar command controller from the document.</span>
<a href="#l1.20"></a><span id="l1.20">  */</span>
<a href="#l1.21"></a><span id="l1.21"> function removeCalendarCommandController() {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/calendar/lightning/content/messenger-overlay-sidebar.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/calendar/lightning/content/messenger-overlay-sidebar.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -163,18 +163,18 @@ var calendarTabType = {</span>
<a href="#l2.4"></a><span id="l2.4">      */</span>
<a href="#l2.5"></a><span id="l2.5">     saveTabState: function(aTab) {</span>
<a href="#l2.6"></a><span id="l2.6">         ltnSwitch2Mail();</span>
<a href="#l2.7"></a><span id="l2.7">     }</span>
<a href="#l2.8"></a><span id="l2.8"> };</span>
<a href="#l2.9"></a><span id="l2.9"> </span>
<a href="#l2.10"></a><span id="l2.10"> /**</span>
<a href="#l2.11"></a><span id="l2.11">  * For details about tab info objects and the tabmail interface see:</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">- * comm-central/mail/base/content/mailTabs.js</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">- * comm-central/mail/base/content/tabmail.xml</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+ * comm/mail/base/content/mailTabs.js</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+ * comm/mail/base/content/tabmail.js</span>
<a href="#l2.16"></a><span id="l2.16">  */</span>
<a href="#l2.17"></a><span id="l2.17"> var calendarItemTabType = {</span>
<a href="#l2.18"></a><span id="l2.18">     name: &quot;calendarItem&quot;,</span>
<a href="#l2.19"></a><span id="l2.19">     perTabPanel: &quot;vbox&quot;,</span>
<a href="#l2.20"></a><span id="l2.20">     idNumber: 0,</span>
<a href="#l2.21"></a><span id="l2.21">     modes: {</span>
<a href="#l2.22"></a><span id="l2.22">         calendarEvent: { type: &quot;calendarEvent&quot; },</span>
<a href="#l2.23"></a><span id="l2.23">         calendarTask: { type: &quot;calendarTask&quot; }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/base/content/messenger.css</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/base/content/messenger.css</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -49,20 +49,16 @@ search-value {</span>
<a href="#l3.4"></a><span id="l3.4"> .remote-gloda-search {</span>
<a href="#l3.5"></a><span id="l3.5">   -moz-binding: url(&quot;chrome://messenger/content/search.xml#glodaSearch&quot;) !important;</span>
<a href="#l3.6"></a><span id="l3.6"> }</span>
<a href="#l3.7"></a><span id="l3.7"> </span>
<a href="#l3.8"></a><span id="l3.8"> .remote-gloda-search-container {</span>
<a href="#l3.9"></a><span id="l3.9">   min-width: 10em;</span>
<a href="#l3.10"></a><span id="l3.10"> }</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-tabmail {</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-  -moz-binding: url(&quot;chrome://messenger/content/tabmail.xml#tabmail&quot;);</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineminus">-}</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineminus">-</span>
<a href="#l3.16"></a><span id="l3.16"> .chromeclass-toolbar {</span>
<a href="#l3.17"></a><span id="l3.17">   overflow-x: hidden;</span>
<a href="#l3.18"></a><span id="l3.18"> }</span>
<a href="#l3.19"></a><span id="l3.19"> </span>
<a href="#l3.20"></a><span id="l3.20"> /* Lightweight themes support */</span>
<a href="#l3.21"></a><span id="l3.21"> </span>
<a href="#l3.22"></a><span id="l3.22"> :root:-moz-lwtheme {</span>
<a href="#l3.23"></a><span id="l3.23">   --toolbar-color: var(--lwt-text-color, inherit);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mail/base/content/messenger.xul</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mail/base/content/messenger.xul</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -468,18 +468,18 @@</span>
<a href="#l4.4"></a><span id="l4.4"> </span>
<a href="#l4.5"></a><span id="l4.5">   &lt;/toolbox&gt;</span>
<a href="#l4.6"></a><span id="l4.6"> </span>
<a href="#l4.7"></a><span id="l4.7">   &lt;!-- XXX This extension point (tabmail-container) is only temporary!</span>
<a href="#l4.8"></a><span id="l4.8">        Horizontal space shouldn't be wasted if it isn't absolutely critical.</span>
<a href="#l4.9"></a><span id="l4.9">        A mechanism for adding sidebar panes will be added in bug 476154. --&gt;</span>
<a href="#l4.10"></a><span id="l4.10">   &lt;hbox id=&quot;tabmail-container&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l4.11"></a><span id="l4.11">     &lt;!-- Beware!  Do NOT use overlays to append nodes directly to tabmail (children</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-         of tabmail is OK though).  This will break Ctrl-tab switching because</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-         the XBL binding will choke when it finds a child of tabmail that is</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+         of tabmail is OK though). This will break Ctrl-tab switching because</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+         the Custom Element will choke when it finds a child of tabmail that is</span>
<a href="#l4.16"></a><span id="l4.16">          not a tabpanels node. --&gt;</span>
<a href="#l4.17"></a><span id="l4.17">     &lt;tabmail id=&quot;tabmail&quot; flex=&quot;1&quot; panelcontainer=&quot;tabpanelcontainer&quot; tabcontainer=&quot;tabmail-tabs&quot;&gt;</span>
<a href="#l4.18"></a><span id="l4.18">      &lt;tabbox id=&quot;tabmail-tabbox&quot; flex=&quot;1&quot; eventnode=&quot;document&quot; tabcontainer=&quot;tabmail-tabs&quot;&gt;</span>
<a href="#l4.19"></a><span id="l4.19">       &lt;tabpanels id=&quot;tabpanelcontainer&quot; flex=&quot;1&quot; class=&quot;plain&quot; selectedIndex=&quot;0&quot;&gt;</span>
<a href="#l4.20"></a><span id="l4.20"> </span>
<a href="#l4.21"></a><span id="l4.21">         &lt;!-- mailContent is the container used for the &quot;wide&quot; layout. Normally,</span>
<a href="#l4.22"></a><span id="l4.22">              all it contains is the &quot;messengerBox&quot; box.  However, in &quot;wide&quot; mode</span>
<a href="#l4.23"></a><span id="l4.23">              the message pane and its splitter transplant themselves into the box</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mail/base/content/tabmail.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mail/base/content/tabmail.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -1,17 +1,22 @@</span>
<a href="#l5.4"></a><span id="l5.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l5.5"></a><span id="l5.5"> * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l5.6"></a><span id="l5.6"> * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l5.7"></a><span id="l5.7"> </span>
<a href="#l5.8"></a><span id="l5.8"> &quot;use strict&quot;;</span>
<a href="#l5.9"></a><span id="l5.9"> </span>
<a href="#l5.10"></a><span id="l5.10"> /* global MozElements, MozXULElement */</span>
<a href="#l5.11"></a><span id="l5.11"> </span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+/* import-globals-from commandglue.js */</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+/* import-globals-from mailWindow.js */</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+</span>
<a href="#l5.15"></a><span id="l5.15"> {</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineplus">+  const { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineplus">+</span>
<a href="#l5.18"></a><span id="l5.18">   /**</span>
<a href="#l5.19"></a><span id="l5.19">    * The MozTabmailAlltabsMenuPopup widget is used as a menupopup to list all the</span>
<a href="#l5.20"></a><span id="l5.20">    * currently opened tabs.</span>
<a href="#l5.21"></a><span id="l5.21">    *</span>
<a href="#l5.22"></a><span id="l5.22">    * @extends {MozElements.MozMenuPopup}</span>
<a href="#l5.23"></a><span id="l5.23">    * @implements {EventListener}</span>
<a href="#l5.24"></a><span id="l5.24">    */</span>
<a href="#l5.25"></a><span id="l5.25">   class MozTabmailAlltabsMenuPopup extends MozElements.MozMenuPopup {</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineat">@@ -171,9 +176,1623 @@</span>
<a href="#l5.27"></a><span id="l5.27">       } else {</span>
<a href="#l5.28"></a><span id="l5.28">         aMenuitem.removeAttribute(&quot;selected&quot;);</span>
<a href="#l5.29"></a><span id="l5.29">       }</span>
<a href="#l5.30"></a><span id="l5.30">     }</span>
<a href="#l5.31"></a><span id="l5.31">   }</span>
<a href="#l5.32"></a><span id="l5.32"> </span>
<a href="#l5.33"></a><span id="l5.33">   customElements.define(&quot;tabmail-alltabs-menupopup&quot;, MozTabmailAlltabsMenuPopup,</span>
<a href="#l5.34"></a><span id="l5.34">     { &quot;extends&quot;: &quot;menupopup&quot; });</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineplus">+</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineplus">+  /**</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineplus">+   * Thunderbird's tab UI mechanism.</span>
<a href="#l5.38"></a><span id="l5.38" class="difflineplus">+   *</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineplus">+   * We expect to be instantiated with the following children:</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineplus">+   * * One &quot;tabpanels&quot; child element whose id must be placed in the</span>
<a href="#l5.41"></a><span id="l5.41" class="difflineplus">+   *   &quot;panelcontainer&quot; attribute on the element we are being bound to. We do</span>
<a href="#l5.42"></a><span id="l5.42" class="difflineplus">+   *   this because it is important to allow overlays to contribute panels.</span>
<a href="#l5.43"></a><span id="l5.43" class="difflineplus">+   *   When we attempted to have the immediate children of the bound element</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineplus">+   *   be propagated through use of the &quot;children&quot; tag, we found that children</span>
<a href="#l5.45"></a><span id="l5.45" class="difflineplus">+   *   contributed by overlays did not propagate.</span>
<a href="#l5.46"></a><span id="l5.46" class="difflineplus">+   * * Any children you want added to the right side of the tab bar.  This is</span>
<a href="#l5.47"></a><span id="l5.47" class="difflineplus">+   *   primarily intended to allow for &quot;open a BLANK tab&quot; buttons, namely</span>
<a href="#l5.48"></a><span id="l5.48" class="difflineplus">+   *   calendar and tasks.  For reasons similar to the tabpanels case, we</span>
<a href="#l5.49"></a><span id="l5.49" class="difflineplus">+   *   expect the instantiating element to provide a child hbox for overlays</span>
<a href="#l5.50"></a><span id="l5.50" class="difflineplus">+   *   to contribute buttons to.</span>
<a href="#l5.51"></a><span id="l5.51" class="difflineplus">+   *</span>
<a href="#l5.52"></a><span id="l5.52" class="difflineplus">+   * From a javascript perspective, there are three types of code that we</span>
<a href="#l5.53"></a><span id="l5.53" class="difflineplus">+   *  expect to interact with:</span>
<a href="#l5.54"></a><span id="l5.54" class="difflineplus">+   * 1) Code that wants to open new tabs.</span>
<a href="#l5.55"></a><span id="l5.55" class="difflineplus">+   * 2) Code that wants to contribute one or more varieties of tabs.</span>
<a href="#l5.56"></a><span id="l5.56" class="difflineplus">+   * 3) Code that wants to monitor to know when the active tab changes.</span>
<a href="#l5.57"></a><span id="l5.57" class="difflineplus">+   *</span>
<a href="#l5.58"></a><span id="l5.58" class="difflineplus">+   * Consumer code should use the following methods:</span>
<a href="#l5.59"></a><span id="l5.59" class="difflineplus">+   * * openTab(aTabModeName, aArgs)</span>
<a href="#l5.60"></a><span id="l5.60" class="difflineplus">+   *     Open a tab of the given &quot;mode&quot;, passing the provided arguments as an</span>
<a href="#l5.61"></a><span id="l5.61" class="difflineplus">+   *     object. The tab type author should tell you the modes they implement</span>
<a href="#l5.62"></a><span id="l5.62" class="difflineplus">+   *     and the required/optional arguments.</span>
<a href="#l5.63"></a><span id="l5.63" class="difflineplus">+   *</span>
<a href="#l5.64"></a><span id="l5.64" class="difflineplus">+   *     Each tab type can define the set of arguments that it expects, but</span>
<a href="#l5.65"></a><span id="l5.65" class="difflineplus">+   *     there are also a few common ones that all should obey, including:</span>
<a href="#l5.66"></a><span id="l5.66" class="difflineplus">+   *</span>
<a href="#l5.67"></a><span id="l5.67" class="difflineplus">+   *     * &quot;background&quot;: if this is true, the tab will be loaded in the</span>
<a href="#l5.68"></a><span id="l5.68" class="difflineplus">+   *       background.</span>
<a href="#l5.69"></a><span id="l5.69" class="difflineplus">+   *     * &quot;disregardOpener&quot;: if this is true, then the tab opener will not</span>
<a href="#l5.70"></a><span id="l5.70" class="difflineplus">+   *       be switched to automatically by tabmail if the new tab is immediately</span>
<a href="#l5.71"></a><span id="l5.71" class="difflineplus">+   *       closed.</span>
<a href="#l5.72"></a><span id="l5.72" class="difflineplus">+   *</span>
<a href="#l5.73"></a><span id="l5.73" class="difflineplus">+   * * closeTab(aOptionalTabIndexInfoOrTabNode, aNoUndo):</span>
<a href="#l5.74"></a><span id="l5.74" class="difflineplus">+   *     If no argument is provided, the current tab is closed. The first</span>
<a href="#l5.75"></a><span id="l5.75" class="difflineplus">+   *     argument specifies a specific tab to be closed. It can be a tab index,</span>
<a href="#l5.76"></a><span id="l5.76" class="difflineplus">+   *     a tab info object, or a tab's DOM element. In case the second</span>
<a href="#l5.77"></a><span id="l5.77" class="difflineplus">+   *     argument is true, the closed tab can't be restored by calling</span>
<a href="#l5.78"></a><span id="l5.78" class="difflineplus">+   *     undoCloseTab().</span>
<a href="#l5.79"></a><span id="l5.79" class="difflineplus">+   *     Please note, some tabs cannot be closed. Trying to close such tab,</span>
<a href="#l5.80"></a><span id="l5.80" class="difflineplus">+   *     will fail silently.</span>
<a href="#l5.81"></a><span id="l5.81" class="difflineplus">+   * * undoCloseTab():</span>
<a href="#l5.82"></a><span id="l5.82" class="difflineplus">+   *     Restores the most recent tab closed by the user.</span>
<a href="#l5.83"></a><span id="l5.83" class="difflineplus">+   * * switchToTab(aTabIndexInfoOrTabNode):</span>
<a href="#l5.84"></a><span id="l5.84" class="difflineplus">+   *     Switch to the tab by providing a tab index, tab info object, or tab</span>
<a href="#l5.85"></a><span id="l5.85" class="difflineplus">+   *     node (tabmail-tab bound element.) Instead of calling this method,</span>
<a href="#l5.86"></a><span id="l5.86" class="difflineplus">+   *     you can also just poke at tabmail.tabContainer and its selectedIndex</span>
<a href="#l5.87"></a><span id="l5.87" class="difflineplus">+   *     and selectedItem properties.</span>
<a href="#l5.88"></a><span id="l5.88" class="difflineplus">+   * * setTabIcon(aTabNodeorInfo, aIcon): Sets the tab icon to the specified</span>
<a href="#l5.89"></a><span id="l5.89" class="difflineplus">+   *     url or removes the icon if no url is specified. Note that this may</span>
<a href="#l5.90"></a><span id="l5.90" class="difflineplus">+   *     override css-provided images.</span>
<a href="#l5.91"></a><span id="l5.91" class="difflineplus">+   * * replaceTabWithWindow(aTab):</span>
<a href="#l5.92"></a><span id="l5.92" class="difflineplus">+   *     Detaches a tab from this tabbar to new window. The argument &quot;aTab&quot; is</span>
<a href="#l5.93"></a><span id="l5.93" class="difflineplus">+   *     required and can be a tab index, a tab info object or a tabs's</span>
<a href="#l5.94"></a><span id="l5.94" class="difflineplus">+   *     DOM element. Calling this method works only for tabs implementing</span>
<a href="#l5.95"></a><span id="l5.95" class="difflineplus">+   *     session restore.</span>
<a href="#l5.96"></a><span id="l5.96" class="difflineplus">+   * * moveTabTo(aTab, aIndex):</span>
<a href="#l5.97"></a><span id="l5.97" class="difflineplus">+   *     moves the given tab to the given Index. The first argument can be</span>
<a href="#l5.98"></a><span id="l5.98" class="difflineplus">+   *     a tab index, a tab info object or a tab's DOM element. The second</span>
<a href="#l5.99"></a><span id="l5.99" class="difflineplus">+   *     argument specifies the tabs new absolute position within the tabbar.</span>
<a href="#l5.100"></a><span id="l5.100" class="difflineplus">+   *</span>
<a href="#l5.101"></a><span id="l5.101" class="difflineplus">+   * Less-friendly consumer methods:</span>
<a href="#l5.102"></a><span id="l5.102" class="difflineplus">+   * * persistTab(tab):</span>
<a href="#l5.103"></a><span id="l5.103" class="difflineplus">+   *     serializes a tab into an object, by passing  a tab info object as</span>
<a href="#l5.104"></a><span id="l5.104" class="difflineplus">+   *     argument. It is used for session restore and moving tabs between</span>
<a href="#l5.105"></a><span id="l5.105" class="difflineplus">+   *     windows. Returns null in case persist fails.</span>
<a href="#l5.106"></a><span id="l5.106" class="difflineplus">+   * * removeCurrentTab():</span>
<a href="#l5.107"></a><span id="l5.107" class="difflineplus">+   *     Close the current tab.</span>
<a href="#l5.108"></a><span id="l5.108" class="difflineplus">+   * * removeTabByNode(aTabElement):</span>
<a href="#l5.109"></a><span id="l5.109" class="difflineplus">+   *     Close the tab whose tabmail-tab bound element is passed in.</span>
<a href="#l5.110"></a><span id="l5.110" class="difflineplus">+   * Changing the currently displayed tab is accomplished by changing</span>
<a href="#l5.111"></a><span id="l5.111" class="difflineplus">+   *  tabmail.tabContainer's selectedIndex or selectedItem property.</span>
<a href="#l5.112"></a><span id="l5.112" class="difflineplus">+   *</span>
<a href="#l5.113"></a><span id="l5.113" class="difflineplus">+   * Code that lives in a tab should use the following methods:</span>
<a href="#l5.114"></a><span id="l5.114" class="difflineplus">+   * * setTabTitle([aOptionalTabInfo]): Tells us that the title of the current</span>
<a href="#l5.115"></a><span id="l5.115" class="difflineplus">+   *   tab (if no argument is provided) or provided tab needs to be updated.</span>
<a href="#l5.116"></a><span id="l5.116" class="difflineplus">+   *   This will result in a call to the tab mode's logic to update the title.</span>
<a href="#l5.117"></a><span id="l5.117" class="difflineplus">+   *   In the event this is not for the current tab, the caller is responsible</span>
<a href="#l5.118"></a><span id="l5.118" class="difflineplus">+   *   for ensuring that the underlying tab mode is capable of providing a tab</span>
<a href="#l5.119"></a><span id="l5.119" class="difflineplus">+   *   title when it is in the background.  (The is currently not the case for</span>
<a href="#l5.120"></a><span id="l5.120" class="difflineplus">+   *   &quot;folder&quot; and &quot;mail&quot; modes because of their implementation.)</span>
<a href="#l5.121"></a><span id="l5.121" class="difflineplus">+   * * setTabBusy(aTabNode, aBusyState): Tells us that the tab in question</span>
<a href="#l5.122"></a><span id="l5.122" class="difflineplus">+   *   is now busy or not busy.  &quot;Busy&quot; means that it is occupied and</span>
<a href="#l5.123"></a><span id="l5.123" class="difflineplus">+   *   will not be able to respond to you until it is no longer busy.</span>
<a href="#l5.124"></a><span id="l5.124" class="difflineplus">+   *   This impacts the cursor display, as well as potentially</span>
<a href="#l5.125"></a><span id="l5.125" class="difflineplus">+   *   providing tab display hints.</span>
<a href="#l5.126"></a><span id="l5.126" class="difflineplus">+   * * setTabThinking(aTabNode, aThinkingState): Tells us that the</span>
<a href="#l5.127"></a><span id="l5.127" class="difflineplus">+   *   tab in question is now thinking or not thinking.  &quot;Thinking&quot; means</span>
<a href="#l5.128"></a><span id="l5.128" class="difflineplus">+   *   that the tab is involved in some ongoing process but you can still</span>
<a href="#l5.129"></a><span id="l5.129" class="difflineplus">+   *   interact with the tab while it is thinking.  A search would be an</span>
<a href="#l5.130"></a><span id="l5.130" class="difflineplus">+   *   example of thinking.  This impacts spinny-thing feedback as well as</span>
<a href="#l5.131"></a><span id="l5.131" class="difflineplus">+   *   potential providing tab display hints.  aThinkingState may be a</span>
<a href="#l5.132"></a><span id="l5.132" class="difflineplus">+   *   boolean or a localized string explaining what you are thinking about.</span>
<a href="#l5.133"></a><span id="l5.133" class="difflineplus">+   *</span>
<a href="#l5.134"></a><span id="l5.134" class="difflineplus">+   * Tab contributing code should define a tab type object and register it</span>
<a href="#l5.135"></a><span id="l5.135" class="difflineplus">+   *  with us by calling registerTabType. You can remove a registered tab</span>
<a href="#l5.136"></a><span id="l5.136" class="difflineplus">+   *  type (eg when unloading a restartless addon) by calling unregisterTabType.</span>
<a href="#l5.137"></a><span id="l5.137" class="difflineplus">+   *  Each tab type can provide multiple tab modes. The rationale behind this</span>
<a href="#l5.138"></a><span id="l5.138" class="difflineplus">+   *  organization is that Thunderbird historically/currently uses a single</span>
<a href="#l5.139"></a><span id="l5.139" class="difflineplus">+   *  3-pane view to display both three-pane folder browsing and single message</span>
<a href="#l5.140"></a><span id="l5.140" class="difflineplus">+   *  browsing across multiple tabs. Each tab type has the ability to use a</span>
<a href="#l5.141"></a><span id="l5.141" class="difflineplus">+   *  single tab panel for all of its display needs. So Thunderbird's &quot;mail&quot;</span>
<a href="#l5.142"></a><span id="l5.142" class="difflineplus">+   *  tab type covers both the &quot;folder&quot; (3-pane folder-based browsing) and</span>
<a href="#l5.143"></a><span id="l5.143" class="difflineplus">+   *  &quot;message&quot; (just a single message) tab modes. Likewise, calendar/lightning</span>
<a href="#l5.144"></a><span id="l5.144" class="difflineplus">+   *  currently displays both its calendar and tasks in the same panel. A tab</span>
<a href="#l5.145"></a><span id="l5.145" class="difflineplus">+   *  type can also create a new tabpanel for each tab as it is created. In</span>
<a href="#l5.146"></a><span id="l5.146" class="difflineplus">+   *  that case, the tab type should probably only have a single mode unless</span>
<a href="#l5.147"></a><span id="l5.147" class="difflineplus">+   *  there are a number of similar modes that can gain from code sharing.</span>
<a href="#l5.148"></a><span id="l5.148" class="difflineplus">+   *</span>
<a href="#l5.149"></a><span id="l5.149" class="difflineplus">+   * The tab type definition should include the following attributes:</span>
<a href="#l5.150"></a><span id="l5.150" class="difflineplus">+   * * name: The name of the tab-type, mainly to aid in debugging.</span>
<a href="#l5.151"></a><span id="l5.151" class="difflineplus">+   * * panelId or perTabPanel: If using a single tab panel, the id of the</span>
<a href="#l5.152"></a><span id="l5.152" class="difflineplus">+   *     panel must be provided in panelId.  If using one tab panel per tab,</span>
<a href="#l5.153"></a><span id="l5.153" class="difflineplus">+   *     perTabPanel should be either the XUL element name that should be</span>
<a href="#l5.154"></a><span id="l5.154" class="difflineplus">+   *     created for each tab, or a helper function to create and return the</span>
<a href="#l5.155"></a><span id="l5.155" class="difflineplus">+   *     element.</span>
<a href="#l5.156"></a><span id="l5.156" class="difflineplus">+   * * modes: An object whose attributes are mode names (which are</span>
<a href="#l5.157"></a><span id="l5.157" class="difflineplus">+   *     automatically propagated to a 'name' attribute for debugging) and</span>
<a href="#l5.158"></a><span id="l5.158" class="difflineplus">+   *     values are objects with the following attributes...</span>
<a href="#l5.159"></a><span id="l5.159" class="difflineplus">+   * * any of the openTab/closeTab/saveTabState/showTab/onTitleChanged</span>
<a href="#l5.160"></a><span id="l5.160" class="difflineplus">+   *     functions as described on the mode definitions.  These will only be</span>
<a href="#l5.161"></a><span id="l5.161" class="difflineplus">+   *     called if the mode does not provide the functions.  Note that because</span>
<a href="#l5.162"></a><span id="l5.162" class="difflineplus">+   *     the 'this' variable passed to the functions will always reference the</span>
<a href="#l5.163"></a><span id="l5.163" class="difflineplus">+   *     tab type definition (rather than the mode definition), the mode</span>
<a href="#l5.164"></a><span id="l5.164" class="difflineplus">+   *     functions can defer to the tab type functions by calling</span>
<a href="#l5.165"></a><span id="l5.165" class="difflineplus">+   *     this.functionName().  (This should prove convenient.)</span>
<a href="#l5.166"></a><span id="l5.166" class="difflineplus">+   * Mode definition attributes:</span>
<a href="#l5.167"></a><span id="l5.167" class="difflineplus">+   * * type: The &quot;type&quot; attribute to set on the displayed tab for CSS purposes.</span>
<a href="#l5.168"></a><span id="l5.168" class="difflineplus">+   *     Generally, this would be the same as the mode name, but you can do as</span>
<a href="#l5.169"></a><span id="l5.169" class="difflineplus">+   *     you please.</span>
<a href="#l5.170"></a><span id="l5.170" class="difflineplus">+   * * isDefault: This should only be present and should be true for the tab</span>
<a href="#l5.171"></a><span id="l5.171" class="difflineplus">+   *     mode that is the tab displayed automatically on startup.</span>
<a href="#l5.172"></a><span id="l5.172" class="difflineplus">+   * * maxTabs: The maximum number of this mode that can be opened at a time.</span>
<a href="#l5.173"></a><span id="l5.173" class="difflineplus">+   *     If this limit is reached, any additional calls to openTab for this</span>
<a href="#l5.174"></a><span id="l5.174" class="difflineplus">+   *     mode will simply result in the first existing tab of this mode being</span>
<a href="#l5.175"></a><span id="l5.175" class="difflineplus">+   *     displayed.</span>
<a href="#l5.176"></a><span id="l5.176" class="difflineplus">+   * * shouldSwitchTo(aArgs): Optional function. Called when openTab is called</span>
<a href="#l5.177"></a><span id="l5.177" class="difflineplus">+   *     on the top-level tabmail binding. It is used to decide if the openTab</span>
<a href="#l5.178"></a><span id="l5.178" class="difflineplus">+   *     function should switch to an existing tab or actually open a new tab.</span>
<a href="#l5.179"></a><span id="l5.179" class="difflineplus">+   *     If the openTab function should switch to an existing tab, return the</span>
<a href="#l5.180"></a><span id="l5.180" class="difflineplus">+   *     index of that tab; otherwise return -1.</span>
<a href="#l5.181"></a><span id="l5.181" class="difflineplus">+   *     aArgs is a set of named parameters (the ones that are later passed to</span>
<a href="#l5.182"></a><span id="l5.182" class="difflineplus">+   *     openTab).</span>
<a href="#l5.183"></a><span id="l5.183" class="difflineplus">+   * * openTab(aTab, aArgs): Called when a tab of the given mode is in the</span>
<a href="#l5.184"></a><span id="l5.184" class="difflineplus">+   *     process of being opened.  aTab will have its &quot;mode&quot; attribute</span>
<a href="#l5.185"></a><span id="l5.185" class="difflineplus">+   *     set to the mode definition of the tab mode being opened.  You should</span>
<a href="#l5.186"></a><span id="l5.186" class="difflineplus">+   *     set the &quot;title&quot; attribute on it, and may set any other attributes</span>
<a href="#l5.187"></a><span id="l5.187" class="difflineplus">+   *     you wish for your own use in subsequent functions.  Note that 'this'</span>
<a href="#l5.188"></a><span id="l5.188" class="difflineplus">+   *     points to the tab type definition, not the mode definition as you</span>
<a href="#l5.189"></a><span id="l5.189" class="difflineplus">+   *     might expect.  This allows you to place common logic code on the</span>
<a href="#l5.190"></a><span id="l5.190" class="difflineplus">+   *     tab type for use by multiple modes and to defer to it.  Any arguments</span>
<a href="#l5.191"></a><span id="l5.191" class="difflineplus">+   *     provided to the caller of tabmail.openTab will be passed to your</span>
<a href="#l5.192"></a><span id="l5.192" class="difflineplus">+   *     function as well, including background.</span>
<a href="#l5.193"></a><span id="l5.193" class="difflineplus">+   * * closeTab(aTab): Called when aTab is being closed.  The tab need not be</span>
<a href="#l5.194"></a><span id="l5.194" class="difflineplus">+   *     currently displayed.  You are responsible for properly cleaning up</span>
<a href="#l5.195"></a><span id="l5.195" class="difflineplus">+   *     any state you preserved in aTab.</span>
<a href="#l5.196"></a><span id="l5.196" class="difflineplus">+   * * saveTabState(aTab): Called when aTab is being switched away from so that</span>
<a href="#l5.197"></a><span id="l5.197" class="difflineplus">+   *     you can preserve its state on aTab.  This is primarily for single</span>
<a href="#l5.198"></a><span id="l5.198" class="difflineplus">+   *     tab panel implementations; you may not have much state to save if your</span>
<a href="#l5.199"></a><span id="l5.199" class="difflineplus">+   *     tab has its own tab panel.</span>
<a href="#l5.200"></a><span id="l5.200" class="difflineplus">+   * * showTab(aTab): Called when aTab is being displayed and you should</span>
<a href="#l5.201"></a><span id="l5.201" class="difflineplus">+   *     restore its state (if required).</span>
<a href="#l5.202"></a><span id="l5.202" class="difflineplus">+   * * persistTab(aTab): Called when we want to persist the tab because we are</span>
<a href="#l5.203"></a><span id="l5.203" class="difflineplus">+   *     saving the session state.  You should return an object suitable for</span>
<a href="#l5.204"></a><span id="l5.204" class="difflineplus">+   *     JSON serialization.  The object will be provided to your restoreTab</span>
<a href="#l5.205"></a><span id="l5.205" class="difflineplus">+   *     method when we attempt to restore the session.  If your code is</span>
<a href="#l5.206"></a><span id="l5.206" class="difflineplus">+   *     unable or unwilling to persist the tab (some of the time), you should</span>
<a href="#l5.207"></a><span id="l5.207" class="difflineplus">+   *     return null in that case.  If your code never wants to persist the tab</span>
<a href="#l5.208"></a><span id="l5.208" class="difflineplus">+   *     you should not implement this method.  You must implement restoreTab</span>
<a href="#l5.209"></a><span id="l5.209" class="difflineplus">+   *     if you implement this method.</span>
<a href="#l5.210"></a><span id="l5.210" class="difflineplus">+   * * restoreTab(aTabmail, aPersistedState): Called when we are restoring a</span>
<a href="#l5.211"></a><span id="l5.211" class="difflineplus">+   *     tab session and a tab with your mode was previously persisted via a</span>
<a href="#l5.212"></a><span id="l5.212" class="difflineplus">+   *     call to your persistTab implementation.  You are provided with a</span>
<a href="#l5.213"></a><span id="l5.213" class="difflineplus">+   *     reference to this tabmail instance and the (deserialized) state object</span>
<a href="#l5.214"></a><span id="l5.214" class="difflineplus">+   *     you returned from your persistTab implementation.  It is your</span>
<a href="#l5.215"></a><span id="l5.215" class="difflineplus">+   *     function's job to determine if you can restore the tab, and if so,</span>
<a href="#l5.216"></a><span id="l5.216" class="difflineplus">+   *     you should invoke aTabmail.openTab to actually cause your tab to be</span>
<a href="#l5.217"></a><span id="l5.217" class="difflineplus">+   *     opened.  This may seem odd, but it should help keep your code simple</span>
<a href="#l5.218"></a><span id="l5.218" class="difflineplus">+   *     while letting you do whatever you want.  Since openTab is synchronous</span>
<a href="#l5.219"></a><span id="l5.219" class="difflineplus">+   *     and returns the tabInfo structure built for the tab, you can perform</span>
<a href="#l5.220"></a><span id="l5.220" class="difflineplus">+   *     any additional work you need after the call to openTab.</span>
<a href="#l5.221"></a><span id="l5.221" class="difflineplus">+   * * onTitleChanged(aTab): Called when someone calls tabmail.setTabTitle() to</span>
<a href="#l5.222"></a><span id="l5.222" class="difflineplus">+   *     hint that the tab's title needs to be updated.  This function should</span>
<a href="#l5.223"></a><span id="l5.223" class="difflineplus">+   *     update aTab.title if it can.</span>
<a href="#l5.224"></a><span id="l5.224" class="difflineplus">+   * Mode definition functions to do with menu/toolbar commands:</span>
<a href="#l5.225"></a><span id="l5.225" class="difflineplus">+   * * supportsCommand(aCommand, aTab): Called when a menu or toolbar needs to</span>
<a href="#l5.226"></a><span id="l5.226" class="difflineplus">+   *     be updated. Return true if you support that command in</span>
<a href="#l5.227"></a><span id="l5.227" class="difflineplus">+   *     isCommandEnabled and doCommand, return false otherwise.</span>
<a href="#l5.228"></a><span id="l5.228" class="difflineplus">+   * * isCommandEnabled(aCommand, aTab): Called when a menu or toolbar needs</span>
<a href="#l5.229"></a><span id="l5.229" class="difflineplus">+   *     to be updated. Return true if the command can be executed at the</span>
<a href="#l5.230"></a><span id="l5.230" class="difflineplus">+   *     current time, false otherwise.</span>
<a href="#l5.231"></a><span id="l5.231" class="difflineplus">+   * * doCommand(aCommand, aTab): Called when a menu or toolbar command is to</span>
<a href="#l5.232"></a><span id="l5.232" class="difflineplus">+   *     be executed. Perform the action appropriate to the command.</span>
<a href="#l5.233"></a><span id="l5.233" class="difflineplus">+   * * onEvent(aEvent, aTab): This can be used to handle different events on</span>
<a href="#l5.234"></a><span id="l5.234" class="difflineplus">+   *     the window.</span>
<a href="#l5.235"></a><span id="l5.235" class="difflineplus">+   * * getBrowser(aTab): This function should return the browser element for</span>
<a href="#l5.236"></a><span id="l5.236" class="difflineplus">+   *     your tab if there is one (return null or don't define this function</span>
<a href="#l5.237"></a><span id="l5.237" class="difflineplus">+   *     otherwise). It is used for some toolkit functions that require a</span>
<a href="#l5.238"></a><span id="l5.238" class="difflineplus">+   *     global &quot;getBrowser&quot; function, e.g. ZoomManager.</span>
<a href="#l5.239"></a><span id="l5.239" class="difflineplus">+   *</span>
<a href="#l5.240"></a><span id="l5.240" class="difflineplus">+   * Tab monitoring code is expected to be used for widgets on the screen</span>
<a href="#l5.241"></a><span id="l5.241" class="difflineplus">+   *  outside of the tab box that need to update themselves as the active tab</span>
<a href="#l5.242"></a><span id="l5.242" class="difflineplus">+   *  changes.</span>
<a href="#l5.243"></a><span id="l5.243" class="difflineplus">+   * Tab monitoring code (un)registers itself via (un)registerTabMonitor.</span>
<a href="#l5.244"></a><span id="l5.244" class="difflineplus">+   *  The following attributes should be provided on the monitor object:</span>
<a href="#l5.245"></a><span id="l5.245" class="difflineplus">+   * * monitorName: A string value naming the tab monitor/extension.  This is</span>
<a href="#l5.246"></a><span id="l5.246" class="difflineplus">+   *     the canonical name for the tab monitor for all persistence purposes.</span>
<a href="#l5.247"></a><span id="l5.247" class="difflineplus">+   *     If the tab monitor wants to store data in the tab info object and its</span>
<a href="#l5.248"></a><span id="l5.248" class="difflineplus">+   *     name is FOO it should store it in 'tabInfo._ext.FOO'.  This is the</span>
<a href="#l5.249"></a><span id="l5.249" class="difflineplus">+   *     only place the tab monitor should store information on the tab info</span>
<a href="#l5.250"></a><span id="l5.250" class="difflineplus">+   *     object.  The FOO attribute will not be automatically created; it is</span>
<a href="#l5.251"></a><span id="l5.251" class="difflineplus">+   *     up to the code.  The _ext attribute will be there, reliably, however.</span>
<a href="#l5.252"></a><span id="l5.252" class="difflineplus">+   *     The name is also used when persisting state, but the tab monitor</span>
<a href="#l5.253"></a><span id="l5.253" class="difflineplus">+   *     does not need to do anything in that case; the name is automatically</span>
<a href="#l5.254"></a><span id="l5.254" class="difflineplus">+   *     used in the course of wrapping the object.</span>
<a href="#l5.255"></a><span id="l5.255" class="difflineplus">+   *  The following functions should be provided on the monitor object:</span>
<a href="#l5.256"></a><span id="l5.256" class="difflineplus">+   * * onTabTitleChanged(aTab): Called when the tab's title changes.</span>
<a href="#l5.257"></a><span id="l5.257" class="difflineplus">+   * * onTabSwitched(aTab, aOldTab): Called when a new tab is made active.  If</span>
<a href="#l5.258"></a><span id="l5.258" class="difflineplus">+   *     this is the first tab ever, aOldTab will be null, otherwise aOldTab</span>
<a href="#l5.259"></a><span id="l5.259" class="difflineplus">+   *     will be the previously active tab.</span>
<a href="#l5.260"></a><span id="l5.260" class="difflineplus">+   * * onTabOpened(aTab, aIsFirstTab, aWasCurrentTab): Called when a new tab is</span>
<a href="#l5.261"></a><span id="l5.261" class="difflineplus">+   *     opened.  This method is invoked after the tab mode's openTab method</span>
<a href="#l5.262"></a><span id="l5.262" class="difflineplus">+   *     is invoked.  This method is invoked before the tab monitor</span>
<a href="#l5.263"></a><span id="l5.263" class="difflineplus">+   *     onTabSwitched method in the case where it will be invoked.  (It is</span>
<a href="#l5.264"></a><span id="l5.264" class="difflineplus">+   *     not invoked if the tab is opened in the background.)</span>
<a href="#l5.265"></a><span id="l5.265" class="difflineplus">+   * * onTabClosing(aTab): Called when a tab is being closed.  This method is</span>
<a href="#l5.266"></a><span id="l5.266" class="difflineplus">+   *     is invoked before the call to the tab mode's closeTab function.</span>
<a href="#l5.267"></a><span id="l5.267" class="difflineplus">+   * * onTabPersist(aTab): Return a JSON-representable object to persist for</span>
<a href="#l5.268"></a><span id="l5.268" class="difflineplus">+   *     the tab.  Return null if you do not have anything to persist.</span>
<a href="#l5.269"></a><span id="l5.269" class="difflineplus">+   * * onTabRestored(aTab, aState, aIsFirstTab): Called when a tab is being</span>
<a href="#l5.270"></a><span id="l5.270" class="difflineplus">+   *     restored and there is data previously persisted by the tab monitor.</span>
<a href="#l5.271"></a><span id="l5.271" class="difflineplus">+   *     This method is called instead of invoking onTabOpened.  This is done</span>
<a href="#l5.272"></a><span id="l5.272" class="difflineplus">+   *     because the restoreTab method (potentially) uses the tabmail openTab</span>
<a href="#l5.273"></a><span id="l5.273" class="difflineplus">+   *     API to effect restoration.  (Note: the first opened tab is special;</span>
<a href="#l5.274"></a><span id="l5.274" class="difflineplus">+   *     it will produce an onTabOpened notification potentially followed by</span>
<a href="#l5.275"></a><span id="l5.275" class="difflineplus">+   *     an onTabRestored notification.)</span>
<a href="#l5.276"></a><span id="l5.276" class="difflineplus">+   * Tab monitor code is also allowed to hook into the command processing</span>
<a href="#l5.277"></a><span id="l5.277" class="difflineplus">+   *  logic.  We support the standard supportsCommand/isCommandEnabled/</span>
<a href="#l5.278"></a><span id="l5.278" class="difflineplus">+   *  doCommand functions but with a twist to indicate when other tab monitors</span>
<a href="#l5.279"></a><span id="l5.279" class="difflineplus">+   *  and the actual tab itself should get a chance to process: supportsCommand</span>
<a href="#l5.280"></a><span id="l5.280" class="difflineplus">+   *  and isCommandEnabled should return null when they are not handling the</span>
<a href="#l5.281"></a><span id="l5.281" class="difflineplus">+   *  case.  doCommand should return true if it handled the case, null</span>
<a href="#l5.282"></a><span id="l5.282" class="difflineplus">+   *  otherwise.</span>
<a href="#l5.283"></a><span id="l5.283" class="difflineplus">+   */</span>
<a href="#l5.284"></a><span id="l5.284" class="difflineplus">+</span>
<a href="#l5.285"></a><span id="l5.285" class="difflineplus">+  /**</span>
<a href="#l5.286"></a><span id="l5.286" class="difflineplus">+   * The MozTabmail widget handles the Tab UI mechanism.</span>
<a href="#l5.287"></a><span id="l5.287" class="difflineplus">+   *</span>
<a href="#l5.288"></a><span id="l5.288" class="difflineplus">+   * @extends {MozXULElement}</span>
<a href="#l5.289"></a><span id="l5.289" class="difflineplus">+   */</span>
<a href="#l5.290"></a><span id="l5.290" class="difflineplus">+  class MozTabmail extends MozXULElement {</span>
<a href="#l5.291"></a><span id="l5.291" class="difflineplus">+    connectedCallback() {</span>
<a href="#l5.292"></a><span id="l5.292" class="difflineplus">+      if (this.delayConnectedCallback()) {</span>
<a href="#l5.293"></a><span id="l5.293" class="difflineplus">+        return;</span>
<a href="#l5.294"></a><span id="l5.294" class="difflineplus">+      }</span>
<a href="#l5.295"></a><span id="l5.295" class="difflineplus">+</span>
<a href="#l5.296"></a><span id="l5.296" class="difflineplus">+      this.tabbox = this.getElementsByTagName(&quot;tabbox&quot;).item(0);</span>
<a href="#l5.297"></a><span id="l5.297" class="difflineplus">+      this.currentTabInfo = null;</span>
<a href="#l5.298"></a><span id="l5.298" class="difflineplus">+</span>
<a href="#l5.299"></a><span id="l5.299" class="difflineplus">+      /**</span>
<a href="#l5.300"></a><span id="l5.300" class="difflineplus">+       * Temporary field that only has a non-null value during a call to</span>
<a href="#l5.301"></a><span id="l5.301" class="difflineplus">+       * openTab, and whose value is the currentTabInfo of the tab that was</span>
<a href="#l5.302"></a><span id="l5.302" class="difflineplus">+       * open when we received the call to openTab.</span>
<a href="#l5.303"></a><span id="l5.303" class="difflineplus">+       */</span>
<a href="#l5.304"></a><span id="l5.304" class="difflineplus">+      this._mostRecentTabInfo = null;</span>
<a href="#l5.305"></a><span id="l5.305" class="difflineplus">+      this.tabTypes = {};</span>
<a href="#l5.306"></a><span id="l5.306" class="difflineplus">+      this.tabModes = {};</span>
<a href="#l5.307"></a><span id="l5.307" class="difflineplus">+      this.defaultTabMode = null;</span>
<a href="#l5.308"></a><span id="l5.308" class="difflineplus">+      this.tabInfo = [];</span>
<a href="#l5.309"></a><span id="l5.309" class="difflineplus">+      this.tabContainer = document.getElementById(this.getAttribute(&quot;tabcontainer&quot;));</span>
<a href="#l5.310"></a><span id="l5.310" class="difflineplus">+      this.panelContainer = document.getElementById(this.getAttribute(&quot;panelcontainer&quot;));</span>
<a href="#l5.311"></a><span id="l5.311" class="difflineplus">+      this.tabMonitors = [];</span>
<a href="#l5.312"></a><span id="l5.312" class="difflineplus">+      this.recentlyClosedTabs = [];</span>
<a href="#l5.313"></a><span id="l5.313" class="difflineplus">+      this.mLastTabOpener = null;</span>
<a href="#l5.314"></a><span id="l5.314" class="difflineplus">+      this.mTabsProgressListeners = new Set();</span>
<a href="#l5.315"></a><span id="l5.315" class="difflineplus">+      this.unrestoredTabs = [];</span>
<a href="#l5.316"></a><span id="l5.316" class="difflineplus">+</span>
<a href="#l5.317"></a><span id="l5.317" class="difflineplus">+      // @implements {nsIController}</span>
<a href="#l5.318"></a><span id="l5.318" class="difflineplus">+      this.tabController = {</span>
<a href="#l5.319"></a><span id="l5.319" class="difflineplus">+        supportsCommand: (aCommand) =&gt; {</span>
<a href="#l5.320"></a><span id="l5.320" class="difflineplus">+          let tab = this.currentTabInfo;</span>
<a href="#l5.321"></a><span id="l5.321" class="difflineplus">+          // This can happen if we're starting up and haven't got a tab</span>
<a href="#l5.322"></a><span id="l5.322" class="difflineplus">+          // loaded yet.</span>
<a href="#l5.323"></a><span id="l5.323" class="difflineplus">+          if (!tab) {</span>
<a href="#l5.324"></a><span id="l5.324" class="difflineplus">+            return false;</span>
<a href="#l5.325"></a><span id="l5.325" class="difflineplus">+          }</span>
<a href="#l5.326"></a><span id="l5.326" class="difflineplus">+</span>
<a href="#l5.327"></a><span id="l5.327" class="difflineplus">+          for (let tabMonitor of this.tabMonitors) {</span>
<a href="#l5.328"></a><span id="l5.328" class="difflineplus">+            if (&quot;supportsCommand&quot; in tabMonitor) {</span>
<a href="#l5.329"></a><span id="l5.329" class="difflineplus">+              let result = tabMonitor.supportsCommand(aCommand, tab);</span>
<a href="#l5.330"></a><span id="l5.330" class="difflineplus">+              if (result !== null) {</span>
<a href="#l5.331"></a><span id="l5.331" class="difflineplus">+                return result;</span>
<a href="#l5.332"></a><span id="l5.332" class="difflineplus">+              }</span>
<a href="#l5.333"></a><span id="l5.333" class="difflineplus">+            }</span>
<a href="#l5.334"></a><span id="l5.334" class="difflineplus">+          }</span>
<a href="#l5.335"></a><span id="l5.335" class="difflineplus">+</span>
<a href="#l5.336"></a><span id="l5.336" class="difflineplus">+          let supportsCommandFunc = tab.mode.supportsCommand ||</span>
<a href="#l5.337"></a><span id="l5.337" class="difflineplus">+            tab.mode.tabType.supportsCommand;</span>
<a href="#l5.338"></a><span id="l5.338" class="difflineplus">+          if (supportsCommandFunc) {</span>
<a href="#l5.339"></a><span id="l5.339" class="difflineplus">+            return supportsCommandFunc.call(tab.mode.tabType, aCommand, tab);</span>
<a href="#l5.340"></a><span id="l5.340" class="difflineplus">+          }</span>
<a href="#l5.341"></a><span id="l5.341" class="difflineplus">+</span>
<a href="#l5.342"></a><span id="l5.342" class="difflineplus">+          return false;</span>
<a href="#l5.343"></a><span id="l5.343" class="difflineplus">+        },</span>
<a href="#l5.344"></a><span id="l5.344" class="difflineplus">+</span>
<a href="#l5.345"></a><span id="l5.345" class="difflineplus">+        isCommandEnabled: (aCommand) =&gt; {</span>
<a href="#l5.346"></a><span id="l5.346" class="difflineplus">+          let tab = this.currentTabInfo;</span>
<a href="#l5.347"></a><span id="l5.347" class="difflineplus">+          // This can happen if we're starting up and haven't got a tab</span>
<a href="#l5.348"></a><span id="l5.348" class="difflineplus">+          // loaded yet.</span>
<a href="#l5.349"></a><span id="l5.349" class="difflineplus">+          if (!tab) {</span>
<a href="#l5.350"></a><span id="l5.350" class="difflineplus">+            return false;</span>
<a href="#l5.351"></a><span id="l5.351" class="difflineplus">+          }</span>
<a href="#l5.352"></a><span id="l5.352" class="difflineplus">+</span>
<a href="#l5.353"></a><span id="l5.353" class="difflineplus">+          for (let tabMonitor of this.tabMonitors) {</span>
<a href="#l5.354"></a><span id="l5.354" class="difflineplus">+            if (&quot;isCommandEnabled&quot; in tabMonitor) {</span>
<a href="#l5.355"></a><span id="l5.355" class="difflineplus">+              let result = tabMonitor.isCommandEnabled(aCommand, tab);</span>
<a href="#l5.356"></a><span id="l5.356" class="difflineplus">+              if (result !== null) {</span>
<a href="#l5.357"></a><span id="l5.357" class="difflineplus">+                return result;</span>
<a href="#l5.358"></a><span id="l5.358" class="difflineplus">+              }</span>
<a href="#l5.359"></a><span id="l5.359" class="difflineplus">+            }</span>
<a href="#l5.360"></a><span id="l5.360" class="difflineplus">+          }</span>
<a href="#l5.361"></a><span id="l5.361" class="difflineplus">+</span>
<a href="#l5.362"></a><span id="l5.362" class="difflineplus">+          let isCommandEnabledFunc = tab.mode.isCommandEnabled ||</span>
<a href="#l5.363"></a><span id="l5.363" class="difflineplus">+            tab.mode.tabType.isCommandEnabled;</span>
<a href="#l5.364"></a><span id="l5.364" class="difflineplus">+          if (isCommandEnabledFunc) {</span>
<a href="#l5.365"></a><span id="l5.365" class="difflineplus">+            return isCommandEnabledFunc.call(tab.mode.tabType, aCommand, tab);</span>
<a href="#l5.366"></a><span id="l5.366" class="difflineplus">+          }</span>
<a href="#l5.367"></a><span id="l5.367" class="difflineplus">+</span>
<a href="#l5.368"></a><span id="l5.368" class="difflineplus">+          return false;</span>
<a href="#l5.369"></a><span id="l5.369" class="difflineplus">+        },</span>
<a href="#l5.370"></a><span id="l5.370" class="difflineplus">+</span>
<a href="#l5.371"></a><span id="l5.371" class="difflineplus">+        doCommand: (aCommand) =&gt; {</span>
<a href="#l5.372"></a><span id="l5.372" class="difflineplus">+          let tab = this.currentTabInfo;</span>
<a href="#l5.373"></a><span id="l5.373" class="difflineplus">+          // This can happen if we're starting up and haven't got a tab</span>
<a href="#l5.374"></a><span id="l5.374" class="difflineplus">+          // loaded yet.</span>
<a href="#l5.375"></a><span id="l5.375" class="difflineplus">+          if (!tab) {</span>
<a href="#l5.376"></a><span id="l5.376" class="difflineplus">+            return;</span>
<a href="#l5.377"></a><span id="l5.377" class="difflineplus">+          }</span>
<a href="#l5.378"></a><span id="l5.378" class="difflineplus">+</span>
<a href="#l5.379"></a><span id="l5.379" class="difflineplus">+          for (let tabMonitor of this.tabMonitors) {</span>
<a href="#l5.380"></a><span id="l5.380" class="difflineplus">+            if (&quot;doCommand&quot; in tabMonitor) {</span>
<a href="#l5.381"></a><span id="l5.381" class="difflineplus">+              let result = tabMonitor.doCommand(aCommand, tab);</span>
<a href="#l5.382"></a><span id="l5.382" class="difflineplus">+              if (result === true) {</span>
<a href="#l5.383"></a><span id="l5.383" class="difflineplus">+                return;</span>
<a href="#l5.384"></a><span id="l5.384" class="difflineplus">+              }</span>
<a href="#l5.385"></a><span id="l5.385" class="difflineplus">+            }</span>
<a href="#l5.386"></a><span id="l5.386" class="difflineplus">+          }</span>
<a href="#l5.387"></a><span id="l5.387" class="difflineplus">+</span>
<a href="#l5.388"></a><span id="l5.388" class="difflineplus">+          let doCommandFunc = tab.mode.doCommand || tab.mode.tabType.doCommand;</span>
<a href="#l5.389"></a><span id="l5.389" class="difflineplus">+          if (doCommandFunc) {</span>
<a href="#l5.390"></a><span id="l5.390" class="difflineplus">+            doCommandFunc.call(tab.mode.tabType, aCommand, tab);</span>
<a href="#l5.391"></a><span id="l5.391" class="difflineplus">+          }</span>
<a href="#l5.392"></a><span id="l5.392" class="difflineplus">+        },</span>
<a href="#l5.393"></a><span id="l5.393" class="difflineplus">+</span>
<a href="#l5.394"></a><span id="l5.394" class="difflineplus">+        onEvent: (aEvent) =&gt; {</span>
<a href="#l5.395"></a><span id="l5.395" class="difflineplus">+          let tab = this.currentTabInfo;</span>
<a href="#l5.396"></a><span id="l5.396" class="difflineplus">+          // This can happen if we're starting up and haven't got a tab</span>
<a href="#l5.397"></a><span id="l5.397" class="difflineplus">+          // loaded yet.</span>
<a href="#l5.398"></a><span id="l5.398" class="difflineplus">+          if (!tab) {</span>
<a href="#l5.399"></a><span id="l5.399" class="difflineplus">+            return null;</span>
<a href="#l5.400"></a><span id="l5.400" class="difflineplus">+          }</span>
<a href="#l5.401"></a><span id="l5.401" class="difflineplus">+</span>
<a href="#l5.402"></a><span id="l5.402" class="difflineplus">+          let onEventFunc = tab.mode.onEvent || tab.mode.tabType.onEvent;</span>
<a href="#l5.403"></a><span id="l5.403" class="difflineplus">+          if (onEventFunc) {</span>
<a href="#l5.404"></a><span id="l5.404" class="difflineplus">+            return onEventFunc.call(tab.mode.tabType, aEvent, tab);</span>
<a href="#l5.405"></a><span id="l5.405" class="difflineplus">+          }</span>
<a href="#l5.406"></a><span id="l5.406" class="difflineplus">+</span>
<a href="#l5.407"></a><span id="l5.407" class="difflineplus">+          return false;</span>
<a href="#l5.408"></a><span id="l5.408" class="difflineplus">+        },</span>
<a href="#l5.409"></a><span id="l5.409" class="difflineplus">+</span>
<a href="#l5.410"></a><span id="l5.410" class="difflineplus">+        QueryInterface: ChromeUtils.generateQI([Ci.nsIController]),</span>
<a href="#l5.411"></a><span id="l5.411" class="difflineplus">+      };</span>
<a href="#l5.412"></a><span id="l5.412" class="difflineplus">+</span>
<a href="#l5.413"></a><span id="l5.413" class="difflineplus">+      window.controllers.insertControllerAt(0, this.tabController);</span>
<a href="#l5.414"></a><span id="l5.414" class="difflineplus">+      this._restoringTabState = null;</span>
<a href="#l5.415"></a><span id="l5.415" class="difflineplus">+</span>
<a href="#l5.416"></a><span id="l5.416" class="difflineplus">+      // @implements {nsIWebProgressListener}</span>
<a href="#l5.417"></a><span id="l5.417" class="difflineplus">+      this.progressListener = {</span>
<a href="#l5.418"></a><span id="l5.418" class="difflineplus">+        onProgressChange: (aWebProgress, aRequest, aCurSelf, aMaxSelf, aCurTotal, aMaxTotal) =&gt; {</span>
<a href="#l5.419"></a><span id="l5.419" class="difflineplus">+          let browser = aWebProgress.QueryInterface(Ci.nsIDocShellTreeItem)</span>
<a href="#l5.420"></a><span id="l5.420" class="difflineplus">+                                    .sameTypeRootTreeItem</span>
<a href="#l5.421"></a><span id="l5.421" class="difflineplus">+                                    .chromeEventHandler;</span>
<a href="#l5.422"></a><span id="l5.422" class="difflineplus">+          this._callTabListeners(&quot;onProgressChange&quot;, [browser, ...arguments]);</span>
<a href="#l5.423"></a><span id="l5.423" class="difflineplus">+        },</span>
<a href="#l5.424"></a><span id="l5.424" class="difflineplus">+</span>
<a href="#l5.425"></a><span id="l5.425" class="difflineplus">+        onProgressChange64: (aWebProgress, aRequest, aCurSelf, aMaxSelf, aCurTotal, aMaxTotal) =&gt; {</span>
<a href="#l5.426"></a><span id="l5.426" class="difflineplus">+          let browser = aWebProgress.QueryInterface(Ci.nsIDocShellTreeItem)</span>
<a href="#l5.427"></a><span id="l5.427" class="difflineplus">+                                    .sameTypeRootTreeItem</span>
<a href="#l5.428"></a><span id="l5.428" class="difflineplus">+                                    .chromeEventHandler;</span>
<a href="#l5.429"></a><span id="l5.429" class="difflineplus">+          this._callTabListeners(&quot;onProgressChange64&quot;, [browser, ...arguments]);</span>
<a href="#l5.430"></a><span id="l5.430" class="difflineplus">+        },</span>
<a href="#l5.431"></a><span id="l5.431" class="difflineplus">+</span>
<a href="#l5.432"></a><span id="l5.432" class="difflineplus">+        onLocationChange: (aWebProgress, aRequest, aLocationURI, aFlags) =&gt; {</span>
<a href="#l5.433"></a><span id="l5.433" class="difflineplus">+          let browser = aWebProgress.QueryInterface(Ci.nsIDocShellTreeItem)</span>
<a href="#l5.434"></a><span id="l5.434" class="difflineplus">+                                    .sameTypeRootTreeItem</span>
<a href="#l5.435"></a><span id="l5.435" class="difflineplus">+                                    .chromeEventHandler;</span>
<a href="#l5.436"></a><span id="l5.436" class="difflineplus">+          this._callTabListeners(&quot;onLocationChange&quot;, [browser, ...arguments]);</span>
<a href="#l5.437"></a><span id="l5.437" class="difflineplus">+        },</span>
<a href="#l5.438"></a><span id="l5.438" class="difflineplus">+</span>
<a href="#l5.439"></a><span id="l5.439" class="difflineplus">+        onStateChange: (aWebProgress, aRequest, aStateFlags, aStatus) =&gt; {</span>
<a href="#l5.440"></a><span id="l5.440" class="difflineplus">+          let browser = aWebProgress.QueryInterface(Ci.nsIDocShellTreeItem)</span>
<a href="#l5.441"></a><span id="l5.441" class="difflineplus">+                                    .sameTypeRootTreeItem</span>
<a href="#l5.442"></a><span id="l5.442" class="difflineplus">+                                    .chromeEventHandler;</span>
<a href="#l5.443"></a><span id="l5.443" class="difflineplus">+          this._callTabListeners(&quot;onStateChange&quot;, [browser, ...arguments]);</span>
<a href="#l5.444"></a><span id="l5.444" class="difflineplus">+        },</span>
<a href="#l5.445"></a><span id="l5.445" class="difflineplus">+</span>
<a href="#l5.446"></a><span id="l5.446" class="difflineplus">+        onStatusChange: (aWebProgress, aRequest, aStatus, aMessage) =&gt; {</span>
<a href="#l5.447"></a><span id="l5.447" class="difflineplus">+          let browser = aWebProgress.QueryInterface(Ci.nsIDocShellTreeItem)</span>
<a href="#l5.448"></a><span id="l5.448" class="difflineplus">+                                    .sameTypeRootTreeItem</span>
<a href="#l5.449"></a><span id="l5.449" class="difflineplus">+                                    .chromeEventHandler;</span>
<a href="#l5.450"></a><span id="l5.450" class="difflineplus">+          this._callTabListeners(&quot;onStatusChange&quot;, [browser, ...arguments]);</span>
<a href="#l5.451"></a><span id="l5.451" class="difflineplus">+        },</span>
<a href="#l5.452"></a><span id="l5.452" class="difflineplus">+</span>
<a href="#l5.453"></a><span id="l5.453" class="difflineplus">+        onSecurityChange: (aWebProgress, aRequest, aState) =&gt; {</span>
<a href="#l5.454"></a><span id="l5.454" class="difflineplus">+          let browser = aWebProgress.QueryInterface(Ci.nsIDocShellTreeItem)</span>
<a href="#l5.455"></a><span id="l5.455" class="difflineplus">+                                    .sameTypeRootTreeItem</span>
<a href="#l5.456"></a><span id="l5.456" class="difflineplus">+                                    .chromeEventHandler;</span>
<a href="#l5.457"></a><span id="l5.457" class="difflineplus">+          this._callTabListeners(&quot;onSecurityChange&quot;, [browser, ...arguments]);</span>
<a href="#l5.458"></a><span id="l5.458" class="difflineplus">+        },</span>
<a href="#l5.459"></a><span id="l5.459" class="difflineplus">+</span>
<a href="#l5.460"></a><span id="l5.460" class="difflineplus">+        onContentBlockingEvent: (aWebProgress, aRequest, aEvent) =&gt; {</span>
<a href="#l5.461"></a><span id="l5.461" class="difflineplus">+          let browser = aWebProgress.QueryInterface(Ci.nsIDocShellTreeItem)</span>
<a href="#l5.462"></a><span id="l5.462" class="difflineplus">+                                    .sameTypeRootTreeItem</span>
<a href="#l5.463"></a><span id="l5.463" class="difflineplus">+                                    .chromeEventHandler;</span>
<a href="#l5.464"></a><span id="l5.464" class="difflineplus">+          this._callTabListeners(&quot;onContentBlockingEvent&quot;, [browser, ...arguments]);</span>
<a href="#l5.465"></a><span id="l5.465" class="difflineplus">+        },</span>
<a href="#l5.466"></a><span id="l5.466" class="difflineplus">+</span>
<a href="#l5.467"></a><span id="l5.467" class="difflineplus">+        onRefreshAttempted: (aWebProgress, aURI, aDelay, aSameURI) =&gt; {</span>
<a href="#l5.468"></a><span id="l5.468" class="difflineplus">+          let browser = aWebProgress.QueryInterface(Ci.nsIDocShellTreeItem)</span>
<a href="#l5.469"></a><span id="l5.469" class="difflineplus">+                                    .sameTypeRootTreeItem</span>
<a href="#l5.470"></a><span id="l5.470" class="difflineplus">+                                    .chromeEventHandler;</span>
<a href="#l5.471"></a><span id="l5.471" class="difflineplus">+          this._callTabListeners(&quot;onRefreshAttempted&quot;, [browser, ...arguments]);</span>
<a href="#l5.472"></a><span id="l5.472" class="difflineplus">+        },</span>
<a href="#l5.473"></a><span id="l5.473" class="difflineplus">+</span>
<a href="#l5.474"></a><span id="l5.474" class="difflineplus">+        QueryInterface: ChromeUtils.generateQI([</span>
<a href="#l5.475"></a><span id="l5.475" class="difflineplus">+          Ci.nsIWebProgressListener,</span>
<a href="#l5.476"></a><span id="l5.476" class="difflineplus">+          Ci.nsIWebProgressListener2,</span>
<a href="#l5.477"></a><span id="l5.477" class="difflineplus">+          Ci.nsISupportsWeakReference,</span>
<a href="#l5.478"></a><span id="l5.478" class="difflineplus">+        ]),</span>
<a href="#l5.479"></a><span id="l5.479" class="difflineplus">+      };</span>
<a href="#l5.480"></a><span id="l5.480" class="difflineplus">+    }</span>
<a href="#l5.481"></a><span id="l5.481" class="difflineplus">+</span>
<a href="#l5.482"></a><span id="l5.482" class="difflineplus">+    set selectedTab(val) {</span>
<a href="#l5.483"></a><span id="l5.483" class="difflineplus">+      this.switchToTab(val);</span>
<a href="#l5.484"></a><span id="l5.484" class="difflineplus">+    }</span>
<a href="#l5.485"></a><span id="l5.485" class="difflineplus">+</span>
<a href="#l5.486"></a><span id="l5.486" class="difflineplus">+    get selectedTab() {</span>
<a href="#l5.487"></a><span id="l5.487" class="difflineplus">+      if (!this.currentTabInfo) {</span>
<a href="#l5.488"></a><span id="l5.488" class="difflineplus">+        this.currentTabInfo = this.tabInfo[0];</span>
<a href="#l5.489"></a><span id="l5.489" class="difflineplus">+      }</span>
<a href="#l5.490"></a><span id="l5.490" class="difflineplus">+</span>
<a href="#l5.491"></a><span id="l5.491" class="difflineplus">+      return this.currentTabInfo;</span>
<a href="#l5.492"></a><span id="l5.492" class="difflineplus">+    }</span>
<a href="#l5.493"></a><span id="l5.493" class="difflineplus">+</span>
<a href="#l5.494"></a><span id="l5.494" class="difflineplus">+    get selectedBrowser() {</span>
<a href="#l5.495"></a><span id="l5.495" class="difflineplus">+      return this.getBrowserForSelectedTab();</span>
<a href="#l5.496"></a><span id="l5.496" class="difflineplus">+    }</span>
<a href="#l5.497"></a><span id="l5.497" class="difflineplus">+</span>
<a href="#l5.498"></a><span id="l5.498" class="difflineplus">+    createTooltip(event) {</span>
<a href="#l5.499"></a><span id="l5.499" class="difflineplus">+      let tab = document.tooltipNode ? document.tooltipNode.closest(&quot;tab&quot;) : null;</span>
<a href="#l5.500"></a><span id="l5.500" class="difflineplus">+      if (!tab) {</span>
<a href="#l5.501"></a><span id="l5.501" class="difflineplus">+        event.preventDefault();</span>
<a href="#l5.502"></a><span id="l5.502" class="difflineplus">+        return;</span>
<a href="#l5.503"></a><span id="l5.503" class="difflineplus">+      }</span>
<a href="#l5.504"></a><span id="l5.504" class="difflineplus">+</span>
<a href="#l5.505"></a><span id="l5.505" class="difflineplus">+      event.stopPropagation();</span>
<a href="#l5.506"></a><span id="l5.506" class="difflineplus">+      if (tab.localName != &quot;tab&quot; || this.tabContainer.draggedTab) {</span>
<a href="#l5.507"></a><span id="l5.507" class="difflineplus">+        event.preventDefault();</span>
<a href="#l5.508"></a><span id="l5.508" class="difflineplus">+        return;</span>
<a href="#l5.509"></a><span id="l5.509" class="difflineplus">+      }</span>
<a href="#l5.510"></a><span id="l5.510" class="difflineplus">+</span>
<a href="#l5.511"></a><span id="l5.511" class="difflineplus">+      event.target.setAttribute(&quot;label&quot;, tab.mOverCloseButton ?</span>
<a href="#l5.512"></a><span id="l5.512" class="difflineplus">+        tab.firstChild.getAttribute(&quot;closetabtext&quot;) : tab.getAttribute(&quot;label&quot;));</span>
<a href="#l5.513"></a><span id="l5.513" class="difflineplus">+    }</span>
<a href="#l5.514"></a><span id="l5.514" class="difflineplus">+</span>
<a href="#l5.515"></a><span id="l5.515" class="difflineplus">+    registerTabType(aTabType) {</span>
<a href="#l5.516"></a><span id="l5.516" class="difflineplus">+      if (aTabType.name in this.tabTypes) {</span>
<a href="#l5.517"></a><span id="l5.517" class="difflineplus">+        return;</span>
<a href="#l5.518"></a><span id="l5.518" class="difflineplus">+      }</span>
<a href="#l5.519"></a><span id="l5.519" class="difflineplus">+</span>
<a href="#l5.520"></a><span id="l5.520" class="difflineplus">+      this.tabTypes[aTabType.name] = aTabType;</span>
<a href="#l5.521"></a><span id="l5.521" class="difflineplus">+      for (let [modeName, modeDetails] of Object.entries(aTabType.modes)) {</span>
<a href="#l5.522"></a><span id="l5.522" class="difflineplus">+        modeDetails.name = modeName;</span>
<a href="#l5.523"></a><span id="l5.523" class="difflineplus">+        modeDetails.tabType = aTabType;</span>
<a href="#l5.524"></a><span id="l5.524" class="difflineplus">+        modeDetails.tabs = [];</span>
<a href="#l5.525"></a><span id="l5.525" class="difflineplus">+        this.tabModes[modeName] = modeDetails;</span>
<a href="#l5.526"></a><span id="l5.526" class="difflineplus">+        if (modeDetails.isDefault) {</span>
<a href="#l5.527"></a><span id="l5.527" class="difflineplus">+          this.defaultTabMode = modeDetails;</span>
<a href="#l5.528"></a><span id="l5.528" class="difflineplus">+        }</span>
<a href="#l5.529"></a><span id="l5.529" class="difflineplus">+      }</span>
<a href="#l5.530"></a><span id="l5.530" class="difflineplus">+</span>
<a href="#l5.531"></a><span id="l5.531" class="difflineplus">+      if (aTabType.panelId) {</span>
<a href="#l5.532"></a><span id="l5.532" class="difflineplus">+        aTabType.panel = document.getElementById(aTabType.panelId);</span>
<a href="#l5.533"></a><span id="l5.533" class="difflineplus">+      } else if (!aTabType.perTabPanel) {</span>
<a href="#l5.534"></a><span id="l5.534" class="difflineplus">+        throw new Error(&quot;Trying to register a tab type with neither panelId &quot; +</span>
<a href="#l5.535"></a><span id="l5.535" class="difflineplus">+          &quot;nor perTabPanel attributes.&quot;);</span>
<a href="#l5.536"></a><span id="l5.536" class="difflineplus">+      }</span>
<a href="#l5.537"></a><span id="l5.537" class="difflineplus">+</span>
<a href="#l5.538"></a><span id="l5.538" class="difflineplus">+      setTimeout(() =&gt; {</span>
<a href="#l5.539"></a><span id="l5.539" class="difflineplus">+        for (let modeName of Object.keys(aTabType.modes)) {</span>
<a href="#l5.540"></a><span id="l5.540" class="difflineplus">+          for (let i = 0; i &lt; this.unrestoredTabs.length;) {</span>
<a href="#l5.541"></a><span id="l5.541" class="difflineplus">+            let state = this.unrestoredTabs[i];</span>
<a href="#l5.542"></a><span id="l5.542" class="difflineplus">+            if (state.mode == modeName) {</span>
<a href="#l5.543"></a><span id="l5.543" class="difflineplus">+              this.restoreTab(state);</span>
<a href="#l5.544"></a><span id="l5.544" class="difflineplus">+              this.unrestoredTabs.splice(i, 1);</span>
<a href="#l5.545"></a><span id="l5.545" class="difflineplus">+            } else {</span>
<a href="#l5.546"></a><span id="l5.546" class="difflineplus">+              i++;</span>
<a href="#l5.547"></a><span id="l5.547" class="difflineplus">+            }</span>
<a href="#l5.548"></a><span id="l5.548" class="difflineplus">+          }</span>
<a href="#l5.549"></a><span id="l5.549" class="difflineplus">+        }</span>
<a href="#l5.550"></a><span id="l5.550" class="difflineplus">+      }, 0);</span>
<a href="#l5.551"></a><span id="l5.551" class="difflineplus">+    }</span>
<a href="#l5.552"></a><span id="l5.552" class="difflineplus">+</span>
<a href="#l5.553"></a><span id="l5.553" class="difflineplus">+    unregisterTabType(aTabType) {</span>
<a href="#l5.554"></a><span id="l5.554" class="difflineplus">+      // we can skip if the tab type was never registered...</span>
<a href="#l5.555"></a><span id="l5.555" class="difflineplus">+      if (!(aTabType.name in this.tabTypes)) {</span>
<a href="#l5.556"></a><span id="l5.556" class="difflineplus">+        return;</span>
<a href="#l5.557"></a><span id="l5.557" class="difflineplus">+      }</span>
<a href="#l5.558"></a><span id="l5.558" class="difflineplus">+</span>
<a href="#l5.559"></a><span id="l5.559" class="difflineplus">+      // ... if the tab type is still in use, we can not remove it without</span>
<a href="#l5.560"></a><span id="l5.560" class="difflineplus">+      // breaking the UI. So we throw an exception.</span>
<a href="#l5.561"></a><span id="l5.561" class="difflineplus">+      for (let modeName of Object.keys(aTabType.modes)) {</span>
<a href="#l5.562"></a><span id="l5.562" class="difflineplus">+        if (this.tabModes[modeName].tabs.length) {</span>
<a href="#l5.563"></a><span id="l5.563" class="difflineplus">+          throw new Error(&quot;Tab mode &quot; + modeName + &quot; still in use. Close tabs&quot;);</span>
<a href="#l5.564"></a><span id="l5.564" class="difflineplus">+        }</span>
<a href="#l5.565"></a><span id="l5.565" class="difflineplus">+      }</span>
<a href="#l5.566"></a><span id="l5.566" class="difflineplus">+      // ... finally get rid of the tab type</span>
<a href="#l5.567"></a><span id="l5.567" class="difflineplus">+      for (let modeName of Object.keys(aTabType.modes)) {</span>
<a href="#l5.568"></a><span id="l5.568" class="difflineplus">+        delete this.tabModes[modeName];</span>
<a href="#l5.569"></a><span id="l5.569" class="difflineplus">+      }</span>
<a href="#l5.570"></a><span id="l5.570" class="difflineplus">+</span>
<a href="#l5.571"></a><span id="l5.571" class="difflineplus">+      delete this.tabTypes[aTabType.name];</span>
<a href="#l5.572"></a><span id="l5.572" class="difflineplus">+    }</span>
<a href="#l5.573"></a><span id="l5.573" class="difflineplus">+</span>
<a href="#l5.574"></a><span id="l5.574" class="difflineplus">+    registerTabMonitor(aTabMonitor) {</span>
<a href="#l5.575"></a><span id="l5.575" class="difflineplus">+      if (!this.tabMonitors.includes(aTabMonitor)) {</span>
<a href="#l5.576"></a><span id="l5.576" class="difflineplus">+        this.tabMonitors.push(aTabMonitor);</span>
<a href="#l5.577"></a><span id="l5.577" class="difflineplus">+      }</span>
<a href="#l5.578"></a><span id="l5.578" class="difflineplus">+    }</span>
<a href="#l5.579"></a><span id="l5.579" class="difflineplus">+</span>
<a href="#l5.580"></a><span id="l5.580" class="difflineplus">+    unregisterTabMonitor(aTabMonitor) {</span>
<a href="#l5.581"></a><span id="l5.581" class="difflineplus">+      if (this.tabMonitors.includes(aTabMonitor)) {</span>
<a href="#l5.582"></a><span id="l5.582" class="difflineplus">+        this.tabMonitors.splice(this.tabMonitors.indexOf(aTabMonitor), 1);</span>
<a href="#l5.583"></a><span id="l5.583" class="difflineplus">+      }</span>
<a href="#l5.584"></a><span id="l5.584" class="difflineplus">+    }</span>
<a href="#l5.585"></a><span id="l5.585" class="difflineplus">+</span>
<a href="#l5.586"></a><span id="l5.586" class="difflineplus">+    /**</span>
<a href="#l5.587"></a><span id="l5.587" class="difflineplus">+     * Given an index, tab node or tab info object, return a tuple of</span>
<a href="#l5.588"></a><span id="l5.588" class="difflineplus">+     * [iTab, tab info dictionary, tab DOM node].  If</span>
<a href="#l5.589"></a><span id="l5.589" class="difflineplus">+     * aTabIndexNodeOrInfo is not specified and aDefaultToCurrent is</span>
<a href="#l5.590"></a><span id="l5.590" class="difflineplus">+     * true, the current tab will be returned.  Otherwise, an</span>
<a href="#l5.591"></a><span id="l5.591" class="difflineplus">+     * exception will be thrown.</span>
<a href="#l5.592"></a><span id="l5.592" class="difflineplus">+     */</span>
<a href="#l5.593"></a><span id="l5.593" class="difflineplus">+    _getTabContextForTabbyThing(aTabIndexNodeOrInfo, aDefaultToCurrent) {</span>
<a href="#l5.594"></a><span id="l5.594" class="difflineplus">+      let iTab;</span>
<a href="#l5.595"></a><span id="l5.595" class="difflineplus">+      let tab;</span>
<a href="#l5.596"></a><span id="l5.596" class="difflineplus">+      let tabNode;</span>
<a href="#l5.597"></a><span id="l5.597" class="difflineplus">+      if (aTabIndexNodeOrInfo == null) {</span>
<a href="#l5.598"></a><span id="l5.598" class="difflineplus">+        if (!aDefaultToCurrent) {</span>
<a href="#l5.599"></a><span id="l5.599" class="difflineplus">+          throw new Error(&quot;You need to specify a tab!&quot;);</span>
<a href="#l5.600"></a><span id="l5.600" class="difflineplus">+        }</span>
<a href="#l5.601"></a><span id="l5.601" class="difflineplus">+        iTab = this.tabContainer.selectedIndex;</span>
<a href="#l5.602"></a><span id="l5.602" class="difflineplus">+        return [iTab, this.tabInfo[iTab], this.tabContainer.allTabs[iTab]];</span>
<a href="#l5.603"></a><span id="l5.603" class="difflineplus">+      }</span>
<a href="#l5.604"></a><span id="l5.604" class="difflineplus">+      if (typeof(aTabIndexNodeOrInfo) == &quot;number&quot;) {</span>
<a href="#l5.605"></a><span id="l5.605" class="difflineplus">+        iTab = aTabIndexNodeOrInfo;</span>
<a href="#l5.606"></a><span id="l5.606" class="difflineplus">+        tabNode = this.tabContainer.allTabs[iTab];</span>
<a href="#l5.607"></a><span id="l5.607" class="difflineplus">+        tab = this.tabInfo[iTab];</span>
<a href="#l5.608"></a><span id="l5.608" class="difflineplus">+      } else if (aTabIndexNodeOrInfo.tagName &amp;&amp; aTabIndexNodeOrInfo.tagName == &quot;tab&quot;) {</span>
<a href="#l5.609"></a><span id="l5.609" class="difflineplus">+        tabNode = aTabIndexNodeOrInfo;</span>
<a href="#l5.610"></a><span id="l5.610" class="difflineplus">+        iTab = this.tabContainer.getIndexOfItem(tabNode);</span>
<a href="#l5.611"></a><span id="l5.611" class="difflineplus">+        tab = this.tabInfo[iTab];</span>
<a href="#l5.612"></a><span id="l5.612" class="difflineplus">+      } else {</span>
<a href="#l5.613"></a><span id="l5.613" class="difflineplus">+        tab = aTabIndexNodeOrInfo;</span>
<a href="#l5.614"></a><span id="l5.614" class="difflineplus">+        iTab = this.tabInfo.indexOf(tab);</span>
<a href="#l5.615"></a><span id="l5.615" class="difflineplus">+        tabNode = (iTab &gt;= 0) ? this.tabContainer.allTabs[iTab] : null;</span>
<a href="#l5.616"></a><span id="l5.616" class="difflineplus">+      }</span>
<a href="#l5.617"></a><span id="l5.617" class="difflineplus">+      return [iTab, tab, tabNode];</span>
<a href="#l5.618"></a><span id="l5.618" class="difflineplus">+    }</span>
<a href="#l5.619"></a><span id="l5.619" class="difflineplus">+</span>
<a href="#l5.620"></a><span id="l5.620" class="difflineplus">+    openFirstTab() {</span>
<a href="#l5.621"></a><span id="l5.621" class="difflineplus">+      // From the moment of creation, our customElement already has a visible</span>
<a href="#l5.622"></a><span id="l5.622" class="difflineplus">+      // tab.  We need to create a tab information structure for this tab.</span>
<a href="#l5.623"></a><span id="l5.623" class="difflineplus">+      // In the process we also generate a synthetic tab title changed</span>
<a href="#l5.624"></a><span id="l5.624" class="difflineplus">+      // event to ensure we have an accurate title.  We assume the tab</span>
<a href="#l5.625"></a><span id="l5.625" class="difflineplus">+      // contents will set themselves up correctly.</span>
<a href="#l5.626"></a><span id="l5.626" class="difflineplus">+      if (this.tabInfo.length == 0) {</span>
<a href="#l5.627"></a><span id="l5.627" class="difflineplus">+        let firstTab = {</span>
<a href="#l5.628"></a><span id="l5.628" class="difflineplus">+          mode: this.defaultTabMode,</span>
<a href="#l5.629"></a><span id="l5.629" class="difflineplus">+          busy: false,</span>
<a href="#l5.630"></a><span id="l5.630" class="difflineplus">+          canClose: false,</span>
<a href="#l5.631"></a><span id="l5.631" class="difflineplus">+          thinking: false,</span>
<a href="#l5.632"></a><span id="l5.632" class="difflineplus">+          _ext: {},</span>
<a href="#l5.633"></a><span id="l5.633" class="difflineplus">+          get linkedBrowser() {</span>
<a href="#l5.634"></a><span id="l5.634" class="difflineplus">+            // This is a hack to make Marionette work. It needs a linkedBrowser</span>
<a href="#l5.635"></a><span id="l5.635" class="difflineplus">+            // from the first tab before it will start. Because linkedBrowser is</span>
<a href="#l5.636"></a><span id="l5.636" class="difflineplus">+            // implemented as a getter, it's ignored by anything that</span>
<a href="#l5.637"></a><span id="l5.637" class="difflineplus">+            // JSON-serializes this tab.</span>
<a href="#l5.638"></a><span id="l5.638" class="difflineplus">+            let browserFunc = this.mode.getBrowser || this.mode.tabType.getBrowser;</span>
<a href="#l5.639"></a><span id="l5.639" class="difflineplus">+            let browser = browserFunc ? browserFunc.call(this.mode.tabType, this) : null;</span>
<a href="#l5.640"></a><span id="l5.640" class="difflineplus">+            if (browser &amp;&amp; !(&quot;permanentKey&quot; in browser)) {</span>
<a href="#l5.641"></a><span id="l5.641" class="difflineplus">+              // The permanentKey property is a unique Object, thus allowing this</span>
<a href="#l5.642"></a><span id="l5.642" class="difflineplus">+              // browser to be stored in a WeakMap.</span>
<a href="#l5.643"></a><span id="l5.643" class="difflineplus">+              // Use the JSM global to create the permanentKey, so that if the</span>
<a href="#l5.644"></a><span id="l5.644" class="difflineplus">+              // permanentKey is held by something after this window closes, it</span>
<a href="#l5.645"></a><span id="l5.645" class="difflineplus">+              // doesn't keep the window alive.</span>
<a href="#l5.646"></a><span id="l5.646" class="difflineplus">+              browser.permanentKey = new (Cu.getGlobalForObject(Services).Object);</span>
<a href="#l5.647"></a><span id="l5.647" class="difflineplus">+            }</span>
<a href="#l5.648"></a><span id="l5.648" class="difflineplus">+            return browser;</span>
<a href="#l5.649"></a><span id="l5.649" class="difflineplus">+          },</span>
<a href="#l5.650"></a><span id="l5.650" class="difflineplus">+        };</span>
<a href="#l5.651"></a><span id="l5.651" class="difflineplus">+</span>
<a href="#l5.652"></a><span id="l5.652" class="difflineplus">+        firstTab.mode.tabs.push(firstTab);</span>
<a href="#l5.653"></a><span id="l5.653" class="difflineplus">+        this.tabInfo[0] = this.currentTabInfo = firstTab;</span>
<a href="#l5.654"></a><span id="l5.654" class="difflineplus">+        let tabOpenFirstFunc = firstTab.mode.openFirstTab ||</span>
<a href="#l5.655"></a><span id="l5.655" class="difflineplus">+          firstTab.mode.tabType.openFirstTab;</span>
<a href="#l5.656"></a><span id="l5.656" class="difflineplus">+        tabOpenFirstFunc.call(firstTab.mode.tabType, firstTab);</span>
<a href="#l5.657"></a><span id="l5.657" class="difflineplus">+        this.setTabTitle(null);</span>
<a href="#l5.658"></a><span id="l5.658" class="difflineplus">+        for (let tabMonitor of this.tabMonitors) {</span>
<a href="#l5.659"></a><span id="l5.659" class="difflineplus">+          if (&quot;onTabOpened&quot; in tabMonitor) {</span>
<a href="#l5.660"></a><span id="l5.660" class="difflineplus">+            tabMonitor.onTabOpened(firstTab, true);</span>
<a href="#l5.661"></a><span id="l5.661" class="difflineplus">+          }</span>
<a href="#l5.662"></a><span id="l5.662" class="difflineplus">+          tabMonitor.onTabSwitched(firstTab, null);</span>
<a href="#l5.663"></a><span id="l5.663" class="difflineplus">+        }</span>
<a href="#l5.664"></a><span id="l5.664" class="difflineplus">+      }</span>
<a href="#l5.665"></a><span id="l5.665" class="difflineplus">+    }</span>
<a href="#l5.666"></a><span id="l5.666" class="difflineplus">+</span>
<a href="#l5.667"></a><span id="l5.667" class="difflineplus">+    // eslint-disable-next-line complexity</span>
<a href="#l5.668"></a><span id="l5.668" class="difflineplus">+    openTab(aTabModeName, aArgs) {</span>
<a href="#l5.669"></a><span id="l5.669" class="difflineplus">+      try {</span>
<a href="#l5.670"></a><span id="l5.670" class="difflineplus">+        if (!(aTabModeName in this.tabModes)) {</span>
<a href="#l5.671"></a><span id="l5.671" class="difflineplus">+          throw new Error(&quot;No such tab mode: &quot; + aTabModeName);</span>
<a href="#l5.672"></a><span id="l5.672" class="difflineplus">+        }</span>
<a href="#l5.673"></a><span id="l5.673" class="difflineplus">+</span>
<a href="#l5.674"></a><span id="l5.674" class="difflineplus">+        let tabMode = this.tabModes[aTabModeName];</span>
<a href="#l5.675"></a><span id="l5.675" class="difflineplus">+        // if we are already at our limit for this mode, show an existing one</span>
<a href="#l5.676"></a><span id="l5.676" class="difflineplus">+        if (tabMode.tabs.length == tabMode.maxTabs) {</span>
<a href="#l5.677"></a><span id="l5.677" class="difflineplus">+          let desiredTab = tabMode.tabs[0];</span>
<a href="#l5.678"></a><span id="l5.678" class="difflineplus">+          this.tabContainer.selectedIndex = this.tabInfo.indexOf(desiredTab);</span>
<a href="#l5.679"></a><span id="l5.679" class="difflineplus">+          return null;</span>
<a href="#l5.680"></a><span id="l5.680" class="difflineplus">+        }</span>
<a href="#l5.681"></a><span id="l5.681" class="difflineplus">+</span>
<a href="#l5.682"></a><span id="l5.682" class="difflineplus">+        // For &quot;glodaFacet&quot; tab mode, if aArgs is omitted,</span>
<a href="#l5.683"></a><span id="l5.683" class="difflineplus">+        // default to a blank user search.</span>
<a href="#l5.684"></a><span id="l5.684" class="difflineplus">+        if (aTabModeName == &quot;glodaFacet&quot; &amp;&amp; !aArgs) {</span>
<a href="#l5.685"></a><span id="l5.685" class="difflineplus">+          aArgs = { searcher: new GlodaMsgSearcher(null, &quot;&quot;) };</span>
<a href="#l5.686"></a><span id="l5.686" class="difflineplus">+        }</span>
<a href="#l5.687"></a><span id="l5.687" class="difflineplus">+</span>
<a href="#l5.688"></a><span id="l5.688" class="difflineplus">+        // Do this so that we don't generate strict warnings</span>
<a href="#l5.689"></a><span id="l5.689" class="difflineplus">+        let background = (&quot;background&quot; in aArgs) &amp;&amp; aArgs.background;</span>
<a href="#l5.690"></a><span id="l5.690" class="difflineplus">+        // If the mode wants us to, we should switch to an existing tab</span>
<a href="#l5.691"></a><span id="l5.691" class="difflineplus">+        // rather than open a new one. We shouldn't switch to the tab if</span>
<a href="#l5.692"></a><span id="l5.692" class="difflineplus">+        // we're opening it in the background, though.</span>
<a href="#l5.693"></a><span id="l5.693" class="difflineplus">+        let shouldSwitchToFunc = tabMode.shouldSwitchTo ||</span>
<a href="#l5.694"></a><span id="l5.694" class="difflineplus">+          tabMode.tabType.shouldSwitchTo;</span>
<a href="#l5.695"></a><span id="l5.695" class="difflineplus">+        if (shouldSwitchToFunc) {</span>
<a href="#l5.696"></a><span id="l5.696" class="difflineplus">+          let tabIndex = shouldSwitchToFunc.apply(tabMode.tabType, [aArgs]);</span>
<a href="#l5.697"></a><span id="l5.697" class="difflineplus">+          if (tabIndex &gt;= 0) {</span>
<a href="#l5.698"></a><span id="l5.698" class="difflineplus">+            if (!background) {</span>
<a href="#l5.699"></a><span id="l5.699" class="difflineplus">+              this.selectTabByIndex(null, tabIndex);</span>
<a href="#l5.700"></a><span id="l5.700" class="difflineplus">+            }</span>
<a href="#l5.701"></a><span id="l5.701" class="difflineplus">+            return null;</span>
<a href="#l5.702"></a><span id="l5.702" class="difflineplus">+          }</span>
<a href="#l5.703"></a><span id="l5.703" class="difflineplus">+        }</span>
<a href="#l5.704"></a><span id="l5.704" class="difflineplus">+</span>
<a href="#l5.705"></a><span id="l5.705" class="difflineplus">+        if (!background) {</span>
<a href="#l5.706"></a><span id="l5.706" class="difflineplus">+          // we need to save the state before it gets corrupted</span>
<a href="#l5.707"></a><span id="l5.707" class="difflineplus">+          this.saveCurrentTabState();</span>
<a href="#l5.708"></a><span id="l5.708" class="difflineplus">+        }</span>
<a href="#l5.709"></a><span id="l5.709" class="difflineplus">+</span>
<a href="#l5.710"></a><span id="l5.710" class="difflineplus">+        let tab = {</span>
<a href="#l5.711"></a><span id="l5.711" class="difflineplus">+          mode: tabMode,</span>
<a href="#l5.712"></a><span id="l5.712" class="difflineplus">+          busy: false,</span>
<a href="#l5.713"></a><span id="l5.713" class="difflineplus">+          canClose: true,</span>
<a href="#l5.714"></a><span id="l5.714" class="difflineplus">+          thinking: false,</span>
<a href="#l5.715"></a><span id="l5.715" class="difflineplus">+          beforeTabOpen: true,</span>
<a href="#l5.716"></a><span id="l5.716" class="difflineplus">+          _ext: {},</span>
<a href="#l5.717"></a><span id="l5.717" class="difflineplus">+        };</span>
<a href="#l5.718"></a><span id="l5.718" class="difflineplus">+</span>
<a href="#l5.719"></a><span id="l5.719" class="difflineplus">+        tabMode.tabs.push(tab);</span>
<a href="#l5.720"></a><span id="l5.720" class="difflineplus">+        var t = document.createXULElement(&quot;tab&quot;, { is: &quot;tabmail-tab&quot; });</span>
<a href="#l5.721"></a><span id="l5.721" class="difflineplus">+        tab.tabNode = t;</span>
<a href="#l5.722"></a><span id="l5.722" class="difflineplus">+        t.maxWidth = this.tabContainer.mTabMaxWidth;</span>
<a href="#l5.723"></a><span id="l5.723" class="difflineplus">+        t.minWidth = this.tabContainer.mTabMinWidth;</span>
<a href="#l5.724"></a><span id="l5.724" class="difflineplus">+        t.width = 0;</span>
<a href="#l5.725"></a><span id="l5.725" class="difflineplus">+        t.setAttribute(&quot;flex&quot;, &quot;100&quot;);</span>
<a href="#l5.726"></a><span id="l5.726" class="difflineplus">+        t.setAttribute(&quot;validate&quot;, &quot;never&quot;);</span>
<a href="#l5.727"></a><span id="l5.727" class="difflineplus">+        t.className = &quot;tabmail-tab&quot;;</span>
<a href="#l5.728"></a><span id="l5.728" class="difflineplus">+        this.tabContainer.appendChild(t);</span>
<a href="#l5.729"></a><span id="l5.729" class="difflineplus">+</span>
<a href="#l5.730"></a><span id="l5.730" class="difflineplus">+        if (this.tabContainer.mCollapseToolbar.collapsed) {</span>
<a href="#l5.731"></a><span id="l5.731" class="difflineplus">+          this.tabContainer.mCollapseToolbar.collapsed = false;</span>
<a href="#l5.732"></a><span id="l5.732" class="difflineplus">+          this.tabContainer._updateCloseButtons();</span>
<a href="#l5.733"></a><span id="l5.733" class="difflineplus">+        }</span>
<a href="#l5.734"></a><span id="l5.734" class="difflineplus">+</span>
<a href="#l5.735"></a><span id="l5.735" class="difflineplus">+        let oldTab = this._mostRecentTabInfo = this.currentTabInfo;</span>
<a href="#l5.736"></a><span id="l5.736" class="difflineplus">+        let disregardOpener = (&quot;disregardOpener&quot; in aArgs) &amp;&amp; aArgs.disregardOpener;</span>
<a href="#l5.737"></a><span id="l5.737" class="difflineplus">+        // If we're not disregarding the opening, hold a reference to opener</span>
<a href="#l5.738"></a><span id="l5.738" class="difflineplus">+        // so that if the new tab is closed without switching, we can switch</span>
<a href="#l5.739"></a><span id="l5.739" class="difflineplus">+        // back to the opener tab.</span>
<a href="#l5.740"></a><span id="l5.740" class="difflineplus">+        if (disregardOpener) {</span>
<a href="#l5.741"></a><span id="l5.741" class="difflineplus">+          this.mLastTabOpener = null;</span>
<a href="#l5.742"></a><span id="l5.742" class="difflineplus">+        } else {</span>
<a href="#l5.743"></a><span id="l5.743" class="difflineplus">+          this.mLastTabOpener = oldTab;</span>
<a href="#l5.744"></a><span id="l5.744" class="difflineplus">+        }</span>
<a href="#l5.745"></a><span id="l5.745" class="difflineplus">+</span>
<a href="#l5.746"></a><span id="l5.746" class="difflineplus">+        // the order of the following statements is important</span>
<a href="#l5.747"></a><span id="l5.747" class="difflineplus">+        this.tabInfo[this.tabContainer.allTabs.length - 1] = tab;</span>
<a href="#l5.748"></a><span id="l5.748" class="difflineplus">+        if (!background) {</span>
<a href="#l5.749"></a><span id="l5.749" class="difflineplus">+          this.currentTabInfo = tab;</span>
<a href="#l5.750"></a><span id="l5.750" class="difflineplus">+          // this has a side effect of calling updateCurrentTab, but our</span>
<a href="#l5.751"></a><span id="l5.751" class="difflineplus">+          //  setting currentTabInfo above will cause it to take no action.</span>
<a href="#l5.752"></a><span id="l5.752" class="difflineplus">+          this.tabContainer.selectedIndex = this.tabContainer.allTabs.length - 1;</span>
<a href="#l5.753"></a><span id="l5.753" class="difflineplus">+        }</span>
<a href="#l5.754"></a><span id="l5.754" class="difflineplus">+</span>
<a href="#l5.755"></a><span id="l5.755" class="difflineplus">+        // make sure we are on the right panel</span>
<a href="#l5.756"></a><span id="l5.756" class="difflineplus">+        if (tab.mode.tabType.perTabPanel) {</span>
<a href="#l5.757"></a><span id="l5.757" class="difflineplus">+          // should we create the element for them, or will they do it?</span>
<a href="#l5.758"></a><span id="l5.758" class="difflineplus">+          if (typeof(tab.mode.tabType.perTabPanel) == &quot;string&quot;) {</span>
<a href="#l5.759"></a><span id="l5.759" class="difflineplus">+            tab.panel = document.createXULElement(tab.mode.tabType.perTabPanel);</span>
<a href="#l5.760"></a><span id="l5.760" class="difflineplus">+          } else {</span>
<a href="#l5.761"></a><span id="l5.761" class="difflineplus">+            tab.panel = tab.mode.tabType.perTabPanel(tab);</span>
<a href="#l5.762"></a><span id="l5.762" class="difflineplus">+          }</span>
<a href="#l5.763"></a><span id="l5.763" class="difflineplus">+</span>
<a href="#l5.764"></a><span id="l5.764" class="difflineplus">+          this.panelContainer.appendChild(tab.panel);</span>
<a href="#l5.765"></a><span id="l5.765" class="difflineplus">+</span>
<a href="#l5.766"></a><span id="l5.766" class="difflineplus">+          if (!background) {</span>
<a href="#l5.767"></a><span id="l5.767" class="difflineplus">+            this.panelContainer.selectedPanel = tab.panel;</span>
<a href="#l5.768"></a><span id="l5.768" class="difflineplus">+          }</span>
<a href="#l5.769"></a><span id="l5.769" class="difflineplus">+        } else {</span>
<a href="#l5.770"></a><span id="l5.770" class="difflineplus">+          if (!background) {</span>
<a href="#l5.771"></a><span id="l5.771" class="difflineplus">+            this.panelContainer.selectedPanel = tab.mode.tabType.panel;</span>
<a href="#l5.772"></a><span id="l5.772" class="difflineplus">+          }</span>
<a href="#l5.773"></a><span id="l5.773" class="difflineplus">+          t.linkedPanel = tab.mode.tabType.panelId;</span>
<a href="#l5.774"></a><span id="l5.774" class="difflineplus">+        }</span>
<a href="#l5.775"></a><span id="l5.775" class="difflineplus">+</span>
<a href="#l5.776"></a><span id="l5.776" class="difflineplus">+        // Make sure the new panel is marked selected.</span>
<a href="#l5.777"></a><span id="l5.777" class="difflineplus">+        let oldPanel = [...this.panelContainer.children].find(p =&gt;</span>
<a href="#l5.778"></a><span id="l5.778" class="difflineplus">+          p.hasAttribute(&quot;selected&quot;));</span>
<a href="#l5.779"></a><span id="l5.779" class="difflineplus">+        if (oldPanel) {</span>
<a href="#l5.780"></a><span id="l5.780" class="difflineplus">+          oldPanel.removeAttribute(&quot;selected&quot;);</span>
<a href="#l5.781"></a><span id="l5.781" class="difflineplus">+        }</span>
<a href="#l5.782"></a><span id="l5.782" class="difflineplus">+</span>
<a href="#l5.783"></a><span id="l5.783" class="difflineplus">+        this.panelContainer.selectedPanel.setAttribute(&quot;selected&quot;, &quot;true&quot;);</span>
<a href="#l5.784"></a><span id="l5.784" class="difflineplus">+        let tabOpenFunc = tab.mode.openTab || tab.mode.tabType.openTab;</span>
<a href="#l5.785"></a><span id="l5.785" class="difflineplus">+        tabOpenFunc.apply(tab.mode.tabType, [tab, aArgs]);</span>
<a href="#l5.786"></a><span id="l5.786" class="difflineplus">+</span>
<a href="#l5.787"></a><span id="l5.787" class="difflineplus">+        if (!t.linkedPanel) {</span>
<a href="#l5.788"></a><span id="l5.788" class="difflineplus">+          if (!tab.panel.id) {</span>
<a href="#l5.789"></a><span id="l5.789" class="difflineplus">+            // No id set. Create our own.</span>
<a href="#l5.790"></a><span id="l5.790" class="difflineplus">+            tab.panel.id = &quot;unnamedTab&quot; + Math.random().toString().substring(2);</span>
<a href="#l5.791"></a><span id="l5.791" class="difflineplus">+            console.warn(`Tab mode ${aTabModeName} should set an id</span>
<a href="#l5.792"></a><span id="l5.792" class="difflineplus">+            on the first argument of openTab.`);</span>
<a href="#l5.793"></a><span id="l5.793" class="difflineplus">+          }</span>
<a href="#l5.794"></a><span id="l5.794" class="difflineplus">+          t.linkedPanel = tab.panel.id;</span>
<a href="#l5.795"></a><span id="l5.795" class="difflineplus">+        }</span>
<a href="#l5.796"></a><span id="l5.796" class="difflineplus">+</span>
<a href="#l5.797"></a><span id="l5.797" class="difflineplus">+        let restoreState = this._restoringTabState;</span>
<a href="#l5.798"></a><span id="l5.798" class="difflineplus">+        for (let tabMonitor of this.tabMonitors) {</span>
<a href="#l5.799"></a><span id="l5.799" class="difflineplus">+          if ((&quot;onTabRestored&quot; in tabMonitor) &amp;&amp; restoreState &amp;&amp;</span>
<a href="#l5.800"></a><span id="l5.800" class="difflineplus">+            (tabMonitor.monitorName in restoreState.ext)) {</span>
<a href="#l5.801"></a><span id="l5.801" class="difflineplus">+            tabMonitor.onTabRestored(tab, restoreState.ext[tabMonitor.monitorName],</span>
<a href="#l5.802"></a><span id="l5.802" class="difflineplus">+              false);</span>
<a href="#l5.803"></a><span id="l5.803" class="difflineplus">+          } else if (&quot;onTabOpened&quot; in tabMonitor) {</span>
<a href="#l5.804"></a><span id="l5.804" class="difflineplus">+            tabMonitor.onTabOpened(tab, false, oldTab);</span>
<a href="#l5.805"></a><span id="l5.805" class="difflineplus">+          }</span>
<a href="#l5.806"></a><span id="l5.806" class="difflineplus">+          if (!background) {</span>
<a href="#l5.807"></a><span id="l5.807" class="difflineplus">+            tabMonitor.onTabSwitched(tab, oldTab);</span>
<a href="#l5.808"></a><span id="l5.808" class="difflineplus">+          }</span>
<a href="#l5.809"></a><span id="l5.809" class="difflineplus">+        }</span>
<a href="#l5.810"></a><span id="l5.810" class="difflineplus">+</span>
<a href="#l5.811"></a><span id="l5.811" class="difflineplus">+        // clear _mostRecentTabInfo; we only needed it during the call to</span>
<a href="#l5.812"></a><span id="l5.812" class="difflineplus">+        //  openTab.</span>
<a href="#l5.813"></a><span id="l5.813" class="difflineplus">+        this._mostRecentTabInfo = null;</span>
<a href="#l5.814"></a><span id="l5.814" class="difflineplus">+        t.setAttribute(&quot;label&quot;, tab.title);</span>
<a href="#l5.815"></a><span id="l5.815" class="difflineplus">+        if (!background) {</span>
<a href="#l5.816"></a><span id="l5.816" class="difflineplus">+          this.setDocumentTitle(tab);</span>
<a href="#l5.817"></a><span id="l5.817" class="difflineplus">+        }</span>
<a href="#l5.818"></a><span id="l5.818" class="difflineplus">+</span>
<a href="#l5.819"></a><span id="l5.819" class="difflineplus">+        // for styling purposes, apply the type to the tab...</span>
<a href="#l5.820"></a><span id="l5.820" class="difflineplus">+        t.setAttribute(&quot;type&quot;, tab.mode.type);</span>
<a href="#l5.821"></a><span id="l5.821" class="difflineplus">+        if (!background) {</span>
<a href="#l5.822"></a><span id="l5.822" class="difflineplus">+          // Update the toolbar status - we don't need to do menus as they</span>
<a href="#l5.823"></a><span id="l5.823" class="difflineplus">+          // do themselves when we open them.</span>
<a href="#l5.824"></a><span id="l5.824" class="difflineplus">+          UpdateMailToolbar(&quot;tabmail&quot;);</span>
<a href="#l5.825"></a><span id="l5.825" class="difflineplus">+        }</span>
<a href="#l5.826"></a><span id="l5.826" class="difflineplus">+</span>
<a href="#l5.827"></a><span id="l5.827" class="difflineplus">+        let moving = restoreState ? restoreState.moving : null;</span>
<a href="#l5.828"></a><span id="l5.828" class="difflineplus">+        // Dispatch tab opening event</span>
<a href="#l5.829"></a><span id="l5.829" class="difflineplus">+        let evt = new CustomEvent(&quot;TabOpen&quot;, {</span>
<a href="#l5.830"></a><span id="l5.830" class="difflineplus">+          bubbles: true, detail: { tabInfo: tab, moving }});</span>
<a href="#l5.831"></a><span id="l5.831" class="difflineplus">+        t.dispatchEvent(evt);</span>
<a href="#l5.832"></a><span id="l5.832" class="difflineplus">+        delete tab.beforeTabOpen;</span>
<a href="#l5.833"></a><span id="l5.833" class="difflineplus">+        // Register browser progress listeners</span>
<a href="#l5.834"></a><span id="l5.834" class="difflineplus">+        let browser = this.getBrowserForTab(tab);</span>
<a href="#l5.835"></a><span id="l5.835" class="difflineplus">+</span>
<a href="#l5.836"></a><span id="l5.836" class="difflineplus">+        if (browser &amp;&amp; !browser._progressListenerAdded) {</span>
<a href="#l5.837"></a><span id="l5.837" class="difflineplus">+          // It would probably be better to have the tabs register this listener, since the</span>
<a href="#l5.838"></a><span id="l5.838" class="difflineplus">+          // browser can change. This wasn't trivial to do while implementing basic WebExtension</span>
<a href="#l5.839"></a><span id="l5.839" class="difflineplus">+          // support, so let's assume one browser only for now.</span>
<a href="#l5.840"></a><span id="l5.840" class="difflineplus">+          browser.webProgress.addProgressListener(this.progressListener,</span>
<a href="#l5.841"></a><span id="l5.841" class="difflineplus">+            Ci.nsIWebProgress.NOTIFY_ALL);</span>
<a href="#l5.842"></a><span id="l5.842" class="difflineplus">+          browser._progressListenerAdded = true;</span>
<a href="#l5.843"></a><span id="l5.843" class="difflineplus">+        }</span>
<a href="#l5.844"></a><span id="l5.844" class="difflineplus">+</span>
<a href="#l5.845"></a><span id="l5.845" class="difflineplus">+        return tab;</span>
<a href="#l5.846"></a><span id="l5.846" class="difflineplus">+      } catch (e) {</span>
<a href="#l5.847"></a><span id="l5.847" class="difflineplus">+        logException(e);</span>
<a href="#l5.848"></a><span id="l5.848" class="difflineplus">+        return null;</span>
<a href="#l5.849"></a><span id="l5.849" class="difflineplus">+      }</span>
<a href="#l5.850"></a><span id="l5.850" class="difflineplus">+    }</span>
<a href="#l5.851"></a><span id="l5.851" class="difflineplus">+</span>
<a href="#l5.852"></a><span id="l5.852" class="difflineplus">+    selectTabByMode(aTabModeName) {</span>
<a href="#l5.853"></a><span id="l5.853" class="difflineplus">+      let tabMode = this.tabModes[aTabModeName];</span>
<a href="#l5.854"></a><span id="l5.854" class="difflineplus">+      if (tabMode.tabs.length) {</span>
<a href="#l5.855"></a><span id="l5.855" class="difflineplus">+        let desiredTab = tabMode.tabs[0];</span>
<a href="#l5.856"></a><span id="l5.856" class="difflineplus">+        this.tabContainer.selectedIndex = this.tabInfo.indexOf(desiredTab);</span>
<a href="#l5.857"></a><span id="l5.857" class="difflineplus">+      }</span>
<a href="#l5.858"></a><span id="l5.858" class="difflineplus">+    }</span>
<a href="#l5.859"></a><span id="l5.859" class="difflineplus">+</span>
<a href="#l5.860"></a><span id="l5.860" class="difflineplus">+    selectTabByIndex(aEvent, aIndex) {</span>
<a href="#l5.861"></a><span id="l5.861" class="difflineplus">+      // count backwards for aIndex &lt; 0</span>
<a href="#l5.862"></a><span id="l5.862" class="difflineplus">+      if (aIndex &lt; 0) {</span>
<a href="#l5.863"></a><span id="l5.863" class="difflineplus">+        aIndex += this.tabInfo.length;</span>
<a href="#l5.864"></a><span id="l5.864" class="difflineplus">+      }</span>
<a href="#l5.865"></a><span id="l5.865" class="difflineplus">+</span>
<a href="#l5.866"></a><span id="l5.866" class="difflineplus">+      if (aIndex &gt;= 0 &amp;&amp;</span>
<a href="#l5.867"></a><span id="l5.867" class="difflineplus">+        aIndex &lt; this.tabInfo.length &amp;&amp;</span>
<a href="#l5.868"></a><span id="l5.868" class="difflineplus">+        aIndex != this.tabContainer.selectedIndex) {</span>
<a href="#l5.869"></a><span id="l5.869" class="difflineplus">+        this.tabContainer.selectedIndex = aIndex;</span>
<a href="#l5.870"></a><span id="l5.870" class="difflineplus">+      }</span>
<a href="#l5.871"></a><span id="l5.871" class="difflineplus">+</span>
<a href="#l5.872"></a><span id="l5.872" class="difflineplus">+      if (aEvent) {</span>
<a href="#l5.873"></a><span id="l5.873" class="difflineplus">+        aEvent.preventDefault();</span>
<a href="#l5.874"></a><span id="l5.874" class="difflineplus">+        aEvent.stopPropagation();</span>
<a href="#l5.875"></a><span id="l5.875" class="difflineplus">+      }</span>
<a href="#l5.876"></a><span id="l5.876" class="difflineplus">+    }</span>
<a href="#l5.877"></a><span id="l5.877" class="difflineplus">+</span>
<a href="#l5.878"></a><span id="l5.878" class="difflineplus">+    /**</span>
<a href="#l5.879"></a><span id="l5.879" class="difflineplus">+     * If the current/most recent tab is of mode aTabModeName, return its</span>
<a href="#l5.880"></a><span id="l5.880" class="difflineplus">+     *  tab info, otherwise return the tab info for the first tab of the</span>
<a href="#l5.881"></a><span id="l5.881" class="difflineplus">+     *  given mode.</span>
<a href="#l5.882"></a><span id="l5.882" class="difflineplus">+     * You would want to use this method when you would like to mimic the</span>
<a href="#l5.883"></a><span id="l5.883" class="difflineplus">+     *  settings of an existing instance of your mode.  In such a case,</span>
<a href="#l5.884"></a><span id="l5.884" class="difflineplus">+     *  it is reasonable to assume that if the 'current' tab was of the</span>
<a href="#l5.885"></a><span id="l5.885" class="difflineplus">+     *  same mode that its settings should be used.  Otherwise, we must</span>
<a href="#l5.886"></a><span id="l5.886" class="difflineplus">+     *  fall back to another tab.  We currently choose the first tab of</span>
<a href="#l5.887"></a><span id="l5.887" class="difflineplus">+     *  the instance, because for the &quot;folder&quot; tab, it is the canonical tab.</span>
<a href="#l5.888"></a><span id="l5.888" class="difflineplus">+     *  In other cases, having an MRU order and choosing the MRU tab might</span>
<a href="#l5.889"></a><span id="l5.889" class="difflineplus">+     *  be more appropriate.</span>
<a href="#l5.890"></a><span id="l5.890" class="difflineplus">+     *</span>
<a href="#l5.891"></a><span id="l5.891" class="difflineplus">+     * @return the tab info object for the tab meeting the above criteria,</span>
<a href="#l5.892"></a><span id="l5.892" class="difflineplus">+     *     or null if no such tab exists.</span>
<a href="#l5.893"></a><span id="l5.893" class="difflineplus">+     */</span>
<a href="#l5.894"></a><span id="l5.894" class="difflineplus">+    getTabInfoForCurrentOrFirstModeInstance(aTabMode) {</span>
<a href="#l5.895"></a><span id="l5.895" class="difflineplus">+      // If we're in the middle of opening a new tab</span>
<a href="#l5.896"></a><span id="l5.896" class="difflineplus">+      // (this._mostRecentTabInfo is non-null), we shouldn't consider the</span>
<a href="#l5.897"></a><span id="l5.897" class="difflineplus">+      // current tab</span>
<a href="#l5.898"></a><span id="l5.898" class="difflineplus">+      let tabToConsider = this._mostRecentTabInfo || this.currentTabInfo;</span>
<a href="#l5.899"></a><span id="l5.899" class="difflineplus">+      if (tabToConsider &amp;&amp; tabToConsider.mode == aTabMode) {</span>
<a href="#l5.900"></a><span id="l5.900" class="difflineplus">+        return tabToConsider;</span>
<a href="#l5.901"></a><span id="l5.901" class="difflineplus">+      } else if (aTabMode.tabs.length) {</span>
<a href="#l5.902"></a><span id="l5.902" class="difflineplus">+        return aTabMode.tabs[0];</span>
<a href="#l5.903"></a><span id="l5.903" class="difflineplus">+      }</span>
<a href="#l5.904"></a><span id="l5.904" class="difflineplus">+</span>
<a href="#l5.905"></a><span id="l5.905" class="difflineplus">+      return null;</span>
<a href="#l5.906"></a><span id="l5.906" class="difflineplus">+    }</span>
<a href="#l5.907"></a><span id="l5.907" class="difflineplus">+</span>
<a href="#l5.908"></a><span id="l5.908" class="difflineplus">+    undoCloseTab(aIdx) {</span>
<a href="#l5.909"></a><span id="l5.909" class="difflineplus">+      if (!this.recentlyClosedTabs.length) {</span>
<a href="#l5.910"></a><span id="l5.910" class="difflineplus">+        return;</span>
<a href="#l5.911"></a><span id="l5.911" class="difflineplus">+      }</span>
<a href="#l5.912"></a><span id="l5.912" class="difflineplus">+      if (aIdx &gt;= this.recentlyClosedTabs.length) {</span>
<a href="#l5.913"></a><span id="l5.913" class="difflineplus">+        aIdx = this.recentlyClosedTabs.length - 1;</span>
<a href="#l5.914"></a><span id="l5.914" class="difflineplus">+      }</span>
<a href="#l5.915"></a><span id="l5.915" class="difflineplus">+      // splice always returns an array</span>
<a href="#l5.916"></a><span id="l5.916" class="difflineplus">+      let history = (this.recentlyClosedTabs.splice(aIdx, 1))[0];</span>
<a href="#l5.917"></a><span id="l5.917" class="difflineplus">+      if (!history.tab) {</span>
<a href="#l5.918"></a><span id="l5.918" class="difflineplus">+        return;</span>
<a href="#l5.919"></a><span id="l5.919" class="difflineplus">+      }</span>
<a href="#l5.920"></a><span id="l5.920" class="difflineplus">+</span>
<a href="#l5.921"></a><span id="l5.921" class="difflineplus">+      if (!this.restoreTab(JSON.parse(history.tab))) {</span>
<a href="#l5.922"></a><span id="l5.922" class="difflineplus">+        return;</span>
<a href="#l5.923"></a><span id="l5.923" class="difflineplus">+      }</span>
<a href="#l5.924"></a><span id="l5.924" class="difflineplus">+</span>
<a href="#l5.925"></a><span id="l5.925" class="difflineplus">+      let idx = Math.min(history.idx, this.tabInfo.length);</span>
<a href="#l5.926"></a><span id="l5.926" class="difflineplus">+      let tab = this.tabContainer.allTabs[this.tabInfo.length - 1];</span>
<a href="#l5.927"></a><span id="l5.927" class="difflineplus">+      this.moveTabTo(tab, idx);</span>
<a href="#l5.928"></a><span id="l5.928" class="difflineplus">+      this.switchToTab(tab);</span>
<a href="#l5.929"></a><span id="l5.929" class="difflineplus">+    }</span>
<a href="#l5.930"></a><span id="l5.930" class="difflineplus">+</span>
<a href="#l5.931"></a><span id="l5.931" class="difflineplus">+    closeTab(aOptTabIndexNodeOrInfo, aNoUndo) {</span>
<a href="#l5.932"></a><span id="l5.932" class="difflineplus">+      let [iTab, tab, tabNode] =</span>
<a href="#l5.933"></a><span id="l5.933" class="difflineplus">+        this._getTabContextForTabbyThing(aOptTabIndexNodeOrInfo, true);</span>
<a href="#l5.934"></a><span id="l5.934" class="difflineplus">+      if (!tab.canClose) {</span>
<a href="#l5.935"></a><span id="l5.935" class="difflineplus">+        return;</span>
<a href="#l5.936"></a><span id="l5.936" class="difflineplus">+      }</span>
<a href="#l5.937"></a><span id="l5.937" class="difflineplus">+</span>
<a href="#l5.938"></a><span id="l5.938" class="difflineplus">+      // Give the tab type a chance to make its own decisions about</span>
<a href="#l5.939"></a><span id="l5.939" class="difflineplus">+      // whether its tabs can be closed or not. For instance, contentTabs</span>
<a href="#l5.940"></a><span id="l5.940" class="difflineplus">+      // and chromeTabs run onbeforeunload event handlers that may</span>
<a href="#l5.941"></a><span id="l5.941" class="difflineplus">+      // exercise their right to prompt the user for confirmation before</span>
<a href="#l5.942"></a><span id="l5.942" class="difflineplus">+      // closing.</span>
<a href="#l5.943"></a><span id="l5.943" class="difflineplus">+      let tryCloseFunc = tab.mode.tryCloseTab || tab.mode.tabType.tryCloseTab;</span>
<a href="#l5.944"></a><span id="l5.944" class="difflineplus">+      if (tryCloseFunc &amp;&amp; !tryCloseFunc.call(tab.mode.tabType, tab)) {</span>
<a href="#l5.945"></a><span id="l5.945" class="difflineplus">+        return;</span>
<a href="#l5.946"></a><span id="l5.946" class="difflineplus">+      }</span>
<a href="#l5.947"></a><span id="l5.947" class="difflineplus">+</span>
<a href="#l5.948"></a><span id="l5.948" class="difflineplus">+      let evt = new CustomEvent(&quot;TabClose&quot;, {</span>
<a href="#l5.949"></a><span id="l5.949" class="difflineplus">+        bubbles: true,</span>
<a href="#l5.950"></a><span id="l5.950" class="difflineplus">+        detail: { tabInfo: tab, moving: tab.moving },</span>
<a href="#l5.951"></a><span id="l5.951" class="difflineplus">+      });</span>
<a href="#l5.952"></a><span id="l5.952" class="difflineplus">+</span>
<a href="#l5.953"></a><span id="l5.953" class="difflineplus">+      tabNode.dispatchEvent(evt);</span>
<a href="#l5.954"></a><span id="l5.954" class="difflineplus">+      for (let tabMonitor of this.tabMonitors) {</span>
<a href="#l5.955"></a><span id="l5.955" class="difflineplus">+        if (&quot;onTabClosing&quot; in tabMonitor) {</span>
<a href="#l5.956"></a><span id="l5.956" class="difflineplus">+          tabMonitor.onTabClosing(tab);</span>
<a href="#l5.957"></a><span id="l5.957" class="difflineplus">+        }</span>
<a href="#l5.958"></a><span id="l5.958" class="difflineplus">+      }</span>
<a href="#l5.959"></a><span id="l5.959" class="difflineplus">+</span>
<a href="#l5.960"></a><span id="l5.960" class="difflineplus">+      if (!aNoUndo) {</span>
<a href="#l5.961"></a><span id="l5.961" class="difflineplus">+        // Allow user to undo accidentally closed tabs</span>
<a href="#l5.962"></a><span id="l5.962" class="difflineplus">+        let session = this.persistTab(tab);</span>
<a href="#l5.963"></a><span id="l5.963" class="difflineplus">+        if (session) {</span>
<a href="#l5.964"></a><span id="l5.964" class="difflineplus">+          this.recentlyClosedTabs.unshift({</span>
<a href="#l5.965"></a><span id="l5.965" class="difflineplus">+            tab: JSON.stringify(session),</span>
<a href="#l5.966"></a><span id="l5.966" class="difflineplus">+            idx: iTab,</span>
<a href="#l5.967"></a><span id="l5.967" class="difflineplus">+            title: tab.title,</span>
<a href="#l5.968"></a><span id="l5.968" class="difflineplus">+          });</span>
<a href="#l5.969"></a><span id="l5.969" class="difflineplus">+          if (this.recentlyClosedTabs.length &gt; 10) {</span>
<a href="#l5.970"></a><span id="l5.970" class="difflineplus">+            this.recentlyClosedTabs.pop();</span>
<a href="#l5.971"></a><span id="l5.971" class="difflineplus">+          }</span>
<a href="#l5.972"></a><span id="l5.972" class="difflineplus">+        }</span>
<a href="#l5.973"></a><span id="l5.973" class="difflineplus">+      }</span>
<a href="#l5.974"></a><span id="l5.974" class="difflineplus">+</span>
<a href="#l5.975"></a><span id="l5.975" class="difflineplus">+      let closeFunc = tab.mode.closeTab || tab.mode.tabType.closeTab;</span>
<a href="#l5.976"></a><span id="l5.976" class="difflineplus">+      closeFunc.call(tab.mode.tabType, tab);</span>
<a href="#l5.977"></a><span id="l5.977" class="difflineplus">+      this.tabInfo.splice(iTab, 1);</span>
<a href="#l5.978"></a><span id="l5.978" class="difflineplus">+      tab.mode.tabs.splice(tab.mode.tabs.indexOf(tab), 1);</span>
<a href="#l5.979"></a><span id="l5.979" class="difflineplus">+      tabNode.remove();</span>
<a href="#l5.980"></a><span id="l5.980" class="difflineplus">+</span>
<a href="#l5.981"></a><span id="l5.981" class="difflineplus">+      if (this.tabContainer.selectedIndex == -1) {</span>
<a href="#l5.982"></a><span id="l5.982" class="difflineplus">+        if (this.mLastTabOpener &amp;&amp; this.tabInfo.includes(this.mLastTabOpener)) {</span>
<a href="#l5.983"></a><span id="l5.983" class="difflineplus">+          this.tabContainer.selectedIndex = this.tabInfo.indexOf(this.mLastTabOpener);</span>
<a href="#l5.984"></a><span id="l5.984" class="difflineplus">+        } else {</span>
<a href="#l5.985"></a><span id="l5.985" class="difflineplus">+          this.tabContainer.selectedIndex =</span>
<a href="#l5.986"></a><span id="l5.986" class="difflineplus">+            (iTab == this.tabContainer.allTabs.length) ? iTab - 1 : iTab;</span>
<a href="#l5.987"></a><span id="l5.987" class="difflineplus">+        }</span>
<a href="#l5.988"></a><span id="l5.988" class="difflineplus">+      }</span>
<a href="#l5.989"></a><span id="l5.989" class="difflineplus">+</span>
<a href="#l5.990"></a><span id="l5.990" class="difflineplus">+      // Clear the last tab opener - we don't need this anymore.</span>
<a href="#l5.991"></a><span id="l5.991" class="difflineplus">+      this.mLastTabOpener = null;</span>
<a href="#l5.992"></a><span id="l5.992" class="difflineplus">+      if (this.currentTabInfo == tab) {</span>
<a href="#l5.993"></a><span id="l5.993" class="difflineplus">+        this.updateCurrentTab();</span>
<a href="#l5.994"></a><span id="l5.994" class="difflineplus">+      }</span>
<a href="#l5.995"></a><span id="l5.995" class="difflineplus">+</span>
<a href="#l5.996"></a><span id="l5.996" class="difflineplus">+      if (tab.panel) {</span>
<a href="#l5.997"></a><span id="l5.997" class="difflineplus">+        tab.panel.remove();</span>
<a href="#l5.998"></a><span id="l5.998" class="difflineplus">+        delete tab.panel;</span>
<a href="#l5.999"></a><span id="l5.999" class="difflineplus">+        // Ensure current tab is still selected and displayed in the</span>
<a href="#l5.1000"></a><span id="l5.1000" class="difflineplus">+        // panelContainer.</span>
<a href="#l5.1001"></a><span id="l5.1001" class="difflineplus">+        this.panelContainer.selectedPanel =</span>
<a href="#l5.1002"></a><span id="l5.1002" class="difflineplus">+          this.currentTabInfo.panel || this.currentTabInfo.mode.tabType.panel;</span>
<a href="#l5.1003"></a><span id="l5.1003" class="difflineplus">+      }</span>
<a href="#l5.1004"></a><span id="l5.1004" class="difflineplus">+</span>
<a href="#l5.1005"></a><span id="l5.1005" class="difflineplus">+      if (this.tabContainer.allTabs.length == 1 &amp;&amp; this.tabContainer.mAutoHide) {</span>
<a href="#l5.1006"></a><span id="l5.1006" class="difflineplus">+        this.tabContainer.mCollapseToolbar.collapsed = true;</span>
<a href="#l5.1007"></a><span id="l5.1007" class="difflineplus">+      }</span>
<a href="#l5.1008"></a><span id="l5.1008" class="difflineplus">+    }</span>
<a href="#l5.1009"></a><span id="l5.1009" class="difflineplus">+</span>
<a href="#l5.1010"></a><span id="l5.1010" class="difflineplus">+    removeTabByNode(aTabNode) {</span>
<a href="#l5.1011"></a><span id="l5.1011" class="difflineplus">+      this.closeTab(aTabNode);</span>
<a href="#l5.1012"></a><span id="l5.1012" class="difflineplus">+    }</span>
<a href="#l5.1013"></a><span id="l5.1013" class="difflineplus">+</span>
<a href="#l5.1014"></a><span id="l5.1014" class="difflineplus">+    /**</span>
<a href="#l5.1015"></a><span id="l5.1015" class="difflineplus">+     * Given a tabNode (or tabby thing), close all of the other tabs</span>
<a href="#l5.1016"></a><span id="l5.1016" class="difflineplus">+     * that are closeable.</span>
<a href="#l5.1017"></a><span id="l5.1017" class="difflineplus">+     */</span>
<a href="#l5.1018"></a><span id="l5.1018" class="difflineplus">+    closeOtherTabs(aTabNode, aNoUndo) {</span>
<a href="#l5.1019"></a><span id="l5.1019" class="difflineplus">+      let [, thisTab] = this._getTabContextForTabbyThing(aTabNode, false);</span>
<a href="#l5.1020"></a><span id="l5.1020" class="difflineplus">+      // closeTab mutates the tabInfo array, so start from the end.</span>
<a href="#l5.1021"></a><span id="l5.1021" class="difflineplus">+      for (let i = this.tabInfo.length - 1; i &gt;= 0; i--) {</span>
<a href="#l5.1022"></a><span id="l5.1022" class="difflineplus">+        let tab = this.tabInfo[i];</span>
<a href="#l5.1023"></a><span id="l5.1023" class="difflineplus">+        if ((tab != thisTab) &amp;&amp; tab.canClose) {</span>
<a href="#l5.1024"></a><span id="l5.1024" class="difflineplus">+          this.closeTab(tab, aNoUndo);</span>
<a href="#l5.1025"></a><span id="l5.1025" class="difflineplus">+        }</span>
<a href="#l5.1026"></a><span id="l5.1026" class="difflineplus">+      }</span>
<a href="#l5.1027"></a><span id="l5.1027" class="difflineplus">+    }</span>
<a href="#l5.1028"></a><span id="l5.1028" class="difflineplus">+</span>
<a href="#l5.1029"></a><span id="l5.1029" class="difflineplus">+    replaceTabWithWindow(aTab, aTargetWindow, aTargetPosition) {</span>
<a href="#l5.1030"></a><span id="l5.1030" class="difflineplus">+      if (this.tabInfo.length &lt;= 1) {</span>
<a href="#l5.1031"></a><span id="l5.1031" class="difflineplus">+        return null;</span>
<a href="#l5.1032"></a><span id="l5.1032" class="difflineplus">+      }</span>
<a href="#l5.1033"></a><span id="l5.1033" class="difflineplus">+</span>
<a href="#l5.1034"></a><span id="l5.1034" class="difflineplus">+      let tab = this._getTabContextForTabbyThing(aTab, false)[1];</span>
<a href="#l5.1035"></a><span id="l5.1035" class="difflineplus">+      if (!tab.canClose) {</span>
<a href="#l5.1036"></a><span id="l5.1036" class="difflineplus">+        return null;</span>
<a href="#l5.1037"></a><span id="l5.1037" class="difflineplus">+      }</span>
<a href="#l5.1038"></a><span id="l5.1038" class="difflineplus">+</span>
<a href="#l5.1039"></a><span id="l5.1039" class="difflineplus">+      // We use JSON and session restore transfer the tab to the new window.</span>
<a href="#l5.1040"></a><span id="l5.1040" class="difflineplus">+      tab = this.persistTab(tab);</span>
<a href="#l5.1041"></a><span id="l5.1041" class="difflineplus">+      if (!tab) {</span>
<a href="#l5.1042"></a><span id="l5.1042" class="difflineplus">+        return null;</span>
<a href="#l5.1043"></a><span id="l5.1043" class="difflineplus">+      }</span>
<a href="#l5.1044"></a><span id="l5.1044" class="difflineplus">+</span>
<a href="#l5.1045"></a><span id="l5.1045" class="difflineplus">+      // Converting to JSON and back again creates clean javascript</span>
<a href="#l5.1046"></a><span id="l5.1046" class="difflineplus">+      // object with absolutely no references to our current window.</span>
<a href="#l5.1047"></a><span id="l5.1047" class="difflineplus">+      tab = JSON.parse(JSON.stringify(tab));</span>
<a href="#l5.1048"></a><span id="l5.1048" class="difflineplus">+      // Set up an identifier for the move, consumers may want to correlate TabClose and</span>
<a href="#l5.1049"></a><span id="l5.1049" class="difflineplus">+      // TabOpen events.</span>
<a href="#l5.1050"></a><span id="l5.1050" class="difflineplus">+      let moveSession = Cc[&quot;@mozilla.org/uuid-generator;1&quot;]</span>
<a href="#l5.1051"></a><span id="l5.1051" class="difflineplus">+                          .getService(Ci.nsIUUIDGenerator)</span>
<a href="#l5.1052"></a><span id="l5.1052" class="difflineplus">+                          .generateUUID()</span>
<a href="#l5.1053"></a><span id="l5.1053" class="difflineplus">+                          .toString();</span>
<a href="#l5.1054"></a><span id="l5.1054" class="difflineplus">+      tab.moving = moveSession;</span>
<a href="#l5.1055"></a><span id="l5.1055" class="difflineplus">+      aTab.moving = moveSession;</span>
<a href="#l5.1056"></a><span id="l5.1056" class="difflineplus">+      this.closeTab(aTab, true);</span>
<a href="#l5.1057"></a><span id="l5.1057" class="difflineplus">+</span>
<a href="#l5.1058"></a><span id="l5.1058" class="difflineplus">+      if (aTargetWindow &amp;&amp; aTargetWindow !== &quot;popup&quot;) {</span>
<a href="#l5.1059"></a><span id="l5.1059" class="difflineplus">+        let targetTabmail = aTargetWindow.document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l5.1060"></a><span id="l5.1060" class="difflineplus">+        targetTabmail.restoreTab(tab);</span>
<a href="#l5.1061"></a><span id="l5.1061" class="difflineplus">+        if (aTargetPosition) {</span>
<a href="#l5.1062"></a><span id="l5.1062" class="difflineplus">+          let droppedTab = targetTabmail.tabInfo[targetTabmail.tabInfo.length - 1];</span>
<a href="#l5.1063"></a><span id="l5.1063" class="difflineplus">+          targetTabmail.moveTabTo(droppedTab, aTargetPosition);</span>
<a href="#l5.1064"></a><span id="l5.1064" class="difflineplus">+        }</span>
<a href="#l5.1065"></a><span id="l5.1065" class="difflineplus">+        return aTargetWindow;</span>
<a href="#l5.1066"></a><span id="l5.1066" class="difflineplus">+      }</span>
<a href="#l5.1067"></a><span id="l5.1067" class="difflineplus">+</span>
<a href="#l5.1068"></a><span id="l5.1068" class="difflineplus">+      let features = [&quot;chrome&quot;];</span>
<a href="#l5.1069"></a><span id="l5.1069" class="difflineplus">+      if (aTargetWindow === &quot;popup&quot;) {</span>
<a href="#l5.1070"></a><span id="l5.1070" class="difflineplus">+        features.push(&quot;dialog&quot;, &quot;resizable&quot;, &quot;minimizable&quot;, &quot;centerscreen&quot;, &quot;titlebar&quot;, &quot;close&quot;);</span>
<a href="#l5.1071"></a><span id="l5.1071" class="difflineplus">+      } else {</span>
<a href="#l5.1072"></a><span id="l5.1072" class="difflineplus">+        features.push(&quot;dialog=no&quot;, &quot;all&quot;, &quot;status&quot;, &quot;toolbar&quot;);</span>
<a href="#l5.1073"></a><span id="l5.1073" class="difflineplus">+      }</span>
<a href="#l5.1074"></a><span id="l5.1074" class="difflineplus">+</span>
<a href="#l5.1075"></a><span id="l5.1075" class="difflineplus">+      return window.openDialog(&quot;chrome://messenger/content/&quot;, &quot;_blank&quot;,</span>
<a href="#l5.1076"></a><span id="l5.1076" class="difflineplus">+        features.join(&quot;,&quot;), null, { action: &quot;restore&quot;, tabs: [tab] }).focus();</span>
<a href="#l5.1077"></a><span id="l5.1077" class="difflineplus">+    }</span>
<a href="#l5.1078"></a><span id="l5.1078" class="difflineplus">+</span>
<a href="#l5.1079"></a><span id="l5.1079" class="difflineplus">+    moveTabTo(aTabIndexNodeOrInfo, aIndex) {</span>
<a href="#l5.1080"></a><span id="l5.1080" class="difflineplus">+      let [oldIdx, tab, tabNode] =</span>
<a href="#l5.1081"></a><span id="l5.1081" class="difflineplus">+        this._getTabContextForTabbyThing(aTabIndexNodeOrInfo, false);</span>
<a href="#l5.1082"></a><span id="l5.1082" class="difflineplus">+      if (!tab || !tabNode || tabNode.tagName != &quot;tab&quot; || oldIdx &lt; 0 || oldIdx == aIndex) {</span>
<a href="#l5.1083"></a><span id="l5.1083" class="difflineplus">+        return -1;</span>
<a href="#l5.1084"></a><span id="l5.1084" class="difflineplus">+      }</span>
<a href="#l5.1085"></a><span id="l5.1085" class="difflineplus">+</span>
<a href="#l5.1086"></a><span id="l5.1086" class="difflineplus">+      // remove the entries from tabInfo, tabMode and the tabContainer</span>
<a href="#l5.1087"></a><span id="l5.1087" class="difflineplus">+      this.tabInfo.splice(oldIdx, 1);</span>
<a href="#l5.1088"></a><span id="l5.1088" class="difflineplus">+      tab.mode.tabs.splice(tab.mode.tabs.indexOf(tab), 1);</span>
<a href="#l5.1089"></a><span id="l5.1089" class="difflineplus">+      tabNode.remove();</span>
<a href="#l5.1090"></a><span id="l5.1090" class="difflineplus">+      // as we removed items, we might need to update indices</span>
<a href="#l5.1091"></a><span id="l5.1091" class="difflineplus">+      if (oldIdx &lt; aIndex) {</span>
<a href="#l5.1092"></a><span id="l5.1092" class="difflineplus">+        aIndex--;</span>
<a href="#l5.1093"></a><span id="l5.1093" class="difflineplus">+      }</span>
<a href="#l5.1094"></a><span id="l5.1094" class="difflineplus">+</span>
<a href="#l5.1095"></a><span id="l5.1095" class="difflineplus">+      // Read it into tabInfo and the tabContainer</span>
<a href="#l5.1096"></a><span id="l5.1096" class="difflineplus">+      this.tabInfo.splice(aIndex, 0, tab);</span>
<a href="#l5.1097"></a><span id="l5.1097" class="difflineplus">+      this.tabContainer.insertBefore(tabNode, this.tabContainer.allTabs[aIndex]);</span>
<a href="#l5.1098"></a><span id="l5.1098" class="difflineplus">+      // Now it's getting a bit ugly, as tabModes stores redundant</span>
<a href="#l5.1099"></a><span id="l5.1099" class="difflineplus">+      // information we need to get it in sync with tabInfo.</span>
<a href="#l5.1100"></a><span id="l5.1100" class="difflineplus">+      //</span>
<a href="#l5.1101"></a><span id="l5.1101" class="difflineplus">+      // As tabModes.tabs is a subset of tabInfo, every tab can be mapped</span>
<a href="#l5.1102"></a><span id="l5.1102" class="difflineplus">+      // to a tabInfo index. So we check for each tab in tabModes if it is</span>
<a href="#l5.1103"></a><span id="l5.1103" class="difflineplus">+      // directly in front of our moved tab. We do this by looking up the</span>
<a href="#l5.1104"></a><span id="l5.1104" class="difflineplus">+      // index in tabInfo and compare it with the moved tab's index. If we</span>
<a href="#l5.1105"></a><span id="l5.1105" class="difflineplus">+      // found our tab, we insert the moved tab directly behind into tabModes</span>
<a href="#l5.1106"></a><span id="l5.1106" class="difflineplus">+      // In case find no tab we simply append it</span>
<a href="#l5.1107"></a><span id="l5.1107" class="difflineplus">+      let modeIdx = tab.mode.tabs.length + 1;</span>
<a href="#l5.1108"></a><span id="l5.1108" class="difflineplus">+      for (let i = 0; i &lt; tab.mode.tabs.length; i++) {</span>
<a href="#l5.1109"></a><span id="l5.1109" class="difflineplus">+        if (this.tabInfo.indexOf(tab.mode.tabs[i]) &lt; aIndex) {</span>
<a href="#l5.1110"></a><span id="l5.1110" class="difflineplus">+          continue;</span>
<a href="#l5.1111"></a><span id="l5.1111" class="difflineplus">+        }</span>
<a href="#l5.1112"></a><span id="l5.1112" class="difflineplus">+        modeIdx = i;</span>
<a href="#l5.1113"></a><span id="l5.1113" class="difflineplus">+        break;</span>
<a href="#l5.1114"></a><span id="l5.1114" class="difflineplus">+      }</span>
<a href="#l5.1115"></a><span id="l5.1115" class="difflineplus">+</span>
<a href="#l5.1116"></a><span id="l5.1116" class="difflineplus">+      tab.mode.tabs.splice(modeIdx, 0, tab);</span>
<a href="#l5.1117"></a><span id="l5.1117" class="difflineplus">+      let evt = new CustomEvent(&quot;TabMove&quot;, {</span>
<a href="#l5.1118"></a><span id="l5.1118" class="difflineplus">+        bubbles: true,</span>
<a href="#l5.1119"></a><span id="l5.1119" class="difflineplus">+        view: window,</span>
<a href="#l5.1120"></a><span id="l5.1120" class="difflineplus">+        detail: { idx: oldIdx, tabInfo: tab },</span>
<a href="#l5.1121"></a><span id="l5.1121" class="difflineplus">+      });</span>
<a href="#l5.1122"></a><span id="l5.1122" class="difflineplus">+      tabNode.dispatchEvent(evt);</span>
<a href="#l5.1123"></a><span id="l5.1123" class="difflineplus">+</span>
<a href="#l5.1124"></a><span id="l5.1124" class="difflineplus">+      return aIndex;</span>
<a href="#l5.1125"></a><span id="l5.1125" class="difflineplus">+    }</span>
<a href="#l5.1126"></a><span id="l5.1126" class="difflineplus">+</span>
<a href="#l5.1127"></a><span id="l5.1127" class="difflineplus">+    // Returns null in case persist fails.</span>
<a href="#l5.1128"></a><span id="l5.1128" class="difflineplus">+    persistTab(tab) {</span>
<a href="#l5.1129"></a><span id="l5.1129" class="difflineplus">+      let persistFunc = tab.mode.persistTab || tab.mode.tabType.persistTab;</span>
<a href="#l5.1130"></a><span id="l5.1130" class="difflineplus">+      // if we can't restore the tab we can't move it</span>
<a href="#l5.1131"></a><span id="l5.1131" class="difflineplus">+      if (!persistFunc) {</span>
<a href="#l5.1132"></a><span id="l5.1132" class="difflineplus">+        return null;</span>
<a href="#l5.1133"></a><span id="l5.1133" class="difflineplus">+      }</span>
<a href="#l5.1134"></a><span id="l5.1134" class="difflineplus">+</span>
<a href="#l5.1135"></a><span id="l5.1135" class="difflineplus">+      //  If there is a non-null tab-state, then persisting succeeded and</span>
<a href="#l5.1136"></a><span id="l5.1136" class="difflineplus">+      //  we should store it.  We store the tab's persisted state in its</span>
<a href="#l5.1137"></a><span id="l5.1137" class="difflineplus">+      //  own distinct object rather than mixing things up in a dictionary</span>
<a href="#l5.1138"></a><span id="l5.1138" class="difflineplus">+      //  to avoid bugs and because we may eventually let extensions store</span>
<a href="#l5.1139"></a><span id="l5.1139" class="difflineplus">+      //  per-tab information in the persisted state.</span>
<a href="#l5.1140"></a><span id="l5.1140" class="difflineplus">+      let tabState;</span>
<a href="#l5.1141"></a><span id="l5.1141" class="difflineplus">+      // Wrap this in an exception handler so that if the persistence</span>
<a href="#l5.1142"></a><span id="l5.1142" class="difflineplus">+      // logic fails, things like tab closure still run to completion.</span>
<a href="#l5.1143"></a><span id="l5.1143" class="difflineplus">+      try {</span>
<a href="#l5.1144"></a><span id="l5.1144" class="difflineplus">+        tabState = persistFunc.call(tab.mode.tabType, tab);</span>
<a href="#l5.1145"></a><span id="l5.1145" class="difflineplus">+      } catch (ex) {</span>
<a href="#l5.1146"></a><span id="l5.1146" class="difflineplus">+        // Report this so that our unit testing framework sees this</span>
<a href="#l5.1147"></a><span id="l5.1147" class="difflineplus">+        // error and (extension) developers likewise can see when their</span>
<a href="#l5.1148"></a><span id="l5.1148" class="difflineplus">+        // extensions are ill-behaved.</span>
<a href="#l5.1149"></a><span id="l5.1149" class="difflineplus">+        Cu.reportError(ex);</span>
<a href="#l5.1150"></a><span id="l5.1150" class="difflineplus">+      }</span>
<a href="#l5.1151"></a><span id="l5.1151" class="difflineplus">+</span>
<a href="#l5.1152"></a><span id="l5.1152" class="difflineplus">+      if (!tabState) {</span>
<a href="#l5.1153"></a><span id="l5.1153" class="difflineplus">+        return null;</span>
<a href="#l5.1154"></a><span id="l5.1154" class="difflineplus">+      }</span>
<a href="#l5.1155"></a><span id="l5.1155" class="difflineplus">+</span>
<a href="#l5.1156"></a><span id="l5.1156" class="difflineplus">+      let ext = {};</span>
<a href="#l5.1157"></a><span id="l5.1157" class="difflineplus">+      for (let tabMonitor of this.tabMonitors) {</span>
<a href="#l5.1158"></a><span id="l5.1158" class="difflineplus">+        if (&quot;onTabPersist&quot; in tabMonitor) {</span>
<a href="#l5.1159"></a><span id="l5.1159" class="difflineplus">+          let monState = tabMonitor.onTabPersist(tab);</span>
<a href="#l5.1160"></a><span id="l5.1160" class="difflineplus">+          if (monState !== null) {</span>
<a href="#l5.1161"></a><span id="l5.1161" class="difflineplus">+            ext[tabMonitor.monitorName] = monState;</span>
<a href="#l5.1162"></a><span id="l5.1162" class="difflineplus">+          }</span>
<a href="#l5.1163"></a><span id="l5.1163" class="difflineplus">+        }</span>
<a href="#l5.1164"></a><span id="l5.1164" class="difflineplus">+      }</span>
<a href="#l5.1165"></a><span id="l5.1165" class="difflineplus">+</span>
<a href="#l5.1166"></a><span id="l5.1166" class="difflineplus">+      return { mode: tab.mode.name, state: tabState, ext };</span>
<a href="#l5.1167"></a><span id="l5.1167" class="difflineplus">+    }</span>
<a href="#l5.1168"></a><span id="l5.1168" class="difflineplus">+</span>
<a href="#l5.1169"></a><span id="l5.1169" class="difflineplus">+    /**</span>
<a href="#l5.1170"></a><span id="l5.1170" class="difflineplus">+     * Persist the state of all tab modes implementing persistTab methods</span>
<a href="#l5.1171"></a><span id="l5.1171" class="difflineplus">+     *  to a JSON-serializable object representation and return it.  Call</span>
<a href="#l5.1172"></a><span id="l5.1172" class="difflineplus">+     *  restoreTabs with the result to restore the tab state.</span>
<a href="#l5.1173"></a><span id="l5.1173" class="difflineplus">+     * Calling this method should have no side effects; tabs will not be</span>
<a href="#l5.1174"></a><span id="l5.1174" class="difflineplus">+     *  closed, displays will not change, etc.  This means the method is</span>
<a href="#l5.1175"></a><span id="l5.1175" class="difflineplus">+     *  safe to use in an auto-save style so that if we crash we can</span>
<a href="#l5.1176"></a><span id="l5.1176" class="difflineplus">+     *  restore the (approximate) state at the time of the crash.</span>
<a href="#l5.1177"></a><span id="l5.1177" class="difflineplus">+     *</span>
<a href="#l5.1178"></a><span id="l5.1178" class="difflineplus">+     * @return {Object} The persisted tab states.</span>
<a href="#l5.1179"></a><span id="l5.1179" class="difflineplus">+     */</span>
<a href="#l5.1180"></a><span id="l5.1180" class="difflineplus">+    persistTabs() {</span>
<a href="#l5.1181"></a><span id="l5.1181" class="difflineplus">+      let state = {</span>
<a href="#l5.1182"></a><span id="l5.1182" class="difflineplus">+        // Explicitly specify a revision so we don't wish we had later.</span>
<a href="#l5.1183"></a><span id="l5.1183" class="difflineplus">+        rev: 0,</span>
<a href="#l5.1184"></a><span id="l5.1184" class="difflineplus">+        // If our currently selected tab gets persisted, we will update this</span>
<a href="#l5.1185"></a><span id="l5.1185" class="difflineplus">+        selectedIndex: null,</span>
<a href="#l5.1186"></a><span id="l5.1186" class="difflineplus">+      };</span>
<a href="#l5.1187"></a><span id="l5.1187" class="difflineplus">+</span>
<a href="#l5.1188"></a><span id="l5.1188" class="difflineplus">+      let tabs = state.tabs = [];</span>
<a href="#l5.1189"></a><span id="l5.1189" class="difflineplus">+      for (let [iTab, tab] of this.tabInfo.entries()) {</span>
<a href="#l5.1190"></a><span id="l5.1190" class="difflineplus">+        let persistTab = this.persistTab(tab);</span>
<a href="#l5.1191"></a><span id="l5.1191" class="difflineplus">+        if (!persistTab) {</span>
<a href="#l5.1192"></a><span id="l5.1192" class="difflineplus">+          continue;</span>
<a href="#l5.1193"></a><span id="l5.1193" class="difflineplus">+        }</span>
<a href="#l5.1194"></a><span id="l5.1194" class="difflineplus">+        tabs.push(persistTab);</span>
<a href="#l5.1195"></a><span id="l5.1195" class="difflineplus">+        // Mark this persisted tab as selected</span>
<a href="#l5.1196"></a><span id="l5.1196" class="difflineplus">+        if (iTab == this.tabContainer.selectedIndex) {</span>
<a href="#l5.1197"></a><span id="l5.1197" class="difflineplus">+          state.selectedIndex = tabs.length - 1;</span>
<a href="#l5.1198"></a><span id="l5.1198" class="difflineplus">+        }</span>
<a href="#l5.1199"></a><span id="l5.1199" class="difflineplus">+      }</span>
<a href="#l5.1200"></a><span id="l5.1200" class="difflineplus">+</span>
<a href="#l5.1201"></a><span id="l5.1201" class="difflineplus">+      return state;</span>
<a href="#l5.1202"></a><span id="l5.1202" class="difflineplus">+    }</span>
<a href="#l5.1203"></a><span id="l5.1203" class="difflineplus">+</span>
<a href="#l5.1204"></a><span id="l5.1204" class="difflineplus">+    restoreTab(aState) {</span>
<a href="#l5.1205"></a><span id="l5.1205" class="difflineplus">+      // if we no longer know about the mode, we can't restore the tab</span>
<a href="#l5.1206"></a><span id="l5.1206" class="difflineplus">+      let mode = this.tabModes[aState.mode];</span>
<a href="#l5.1207"></a><span id="l5.1207" class="difflineplus">+      if (!mode) {</span>
<a href="#l5.1208"></a><span id="l5.1208" class="difflineplus">+        this.unrestoredTabs.push(aState);</span>
<a href="#l5.1209"></a><span id="l5.1209" class="difflineplus">+        return false;</span>
<a href="#l5.1210"></a><span id="l5.1210" class="difflineplus">+      }</span>
<a href="#l5.1211"></a><span id="l5.1211" class="difflineplus">+</span>
<a href="#l5.1212"></a><span id="l5.1212" class="difflineplus">+      let restoreFunc = mode.restoreTab || mode.tabType.restoreTab;</span>
<a href="#l5.1213"></a><span id="l5.1213" class="difflineplus">+      if (!restoreFunc) {</span>
<a href="#l5.1214"></a><span id="l5.1214" class="difflineplus">+        return false;</span>
<a href="#l5.1215"></a><span id="l5.1215" class="difflineplus">+      }</span>
<a href="#l5.1216"></a><span id="l5.1216" class="difflineplus">+</span>
<a href="#l5.1217"></a><span id="l5.1217" class="difflineplus">+      // normalize the state to have an ext attribute if it does not.</span>
<a href="#l5.1218"></a><span id="l5.1218" class="difflineplus">+      if (!(&quot;ext&quot; in aState)) {</span>
<a href="#l5.1219"></a><span id="l5.1219" class="difflineplus">+        aState.ext = {};</span>
<a href="#l5.1220"></a><span id="l5.1220" class="difflineplus">+      }</span>
<a href="#l5.1221"></a><span id="l5.1221" class="difflineplus">+</span>
<a href="#l5.1222"></a><span id="l5.1222" class="difflineplus">+      this._restoringTabState = aState;</span>
<a href="#l5.1223"></a><span id="l5.1223" class="difflineplus">+      restoreFunc.call(mode.tabType, this, aState.state);</span>
<a href="#l5.1224"></a><span id="l5.1224" class="difflineplus">+      this._restoringTabState = null;</span>
<a href="#l5.1225"></a><span id="l5.1225" class="difflineplus">+</span>
<a href="#l5.1226"></a><span id="l5.1226" class="difflineplus">+      return true;</span>
<a href="#l5.1227"></a><span id="l5.1227" class="difflineplus">+    }</span>
<a href="#l5.1228"></a><span id="l5.1228" class="difflineplus">+</span>
<a href="#l5.1229"></a><span id="l5.1229" class="difflineplus">+    /**</span>
<a href="#l5.1230"></a><span id="l5.1230" class="difflineplus">+     * Attempts to restore tabs persisted from a prior call to</span>
<a href="#l5.1231"></a><span id="l5.1231" class="difflineplus">+     * |persistTabs|.  This is currently a synchronous operation, but in</span>
<a href="#l5.1232"></a><span id="l5.1232" class="difflineplus">+     * the future this may kick off an asynchronous mechanism to restore</span>
<a href="#l5.1233"></a><span id="l5.1233" class="difflineplus">+     * the tabs one-by-one.</span>
<a href="#l5.1234"></a><span id="l5.1234" class="difflineplus">+     */</span>
<a href="#l5.1235"></a><span id="l5.1235" class="difflineplus">+    restoreTabs(aPersistedState, aDontRestoreFirstTab) {</span>
<a href="#l5.1236"></a><span id="l5.1236" class="difflineplus">+      let tabs = aPersistedState.tabs;</span>
<a href="#l5.1237"></a><span id="l5.1237" class="difflineplus">+      let indexToSelect = null;</span>
<a href="#l5.1238"></a><span id="l5.1238" class="difflineplus">+</span>
<a href="#l5.1239"></a><span id="l5.1239" class="difflineplus">+      for (let [iTab, tabState] of tabs.entries()) {</span>
<a href="#l5.1240"></a><span id="l5.1240" class="difflineplus">+        if (tabState.state.firstTab &amp;&amp; aDontRestoreFirstTab) {</span>
<a href="#l5.1241"></a><span id="l5.1241" class="difflineplus">+          tabState.state.dontRestoreFirstTab = aDontRestoreFirstTab;</span>
<a href="#l5.1242"></a><span id="l5.1242" class="difflineplus">+        }</span>
<a href="#l5.1243"></a><span id="l5.1243" class="difflineplus">+</span>
<a href="#l5.1244"></a><span id="l5.1244" class="difflineplus">+        if (!this.restoreTab(tabState)) {</span>
<a href="#l5.1245"></a><span id="l5.1245" class="difflineplus">+          continue;</span>
<a href="#l5.1246"></a><span id="l5.1246" class="difflineplus">+        }</span>
<a href="#l5.1247"></a><span id="l5.1247" class="difflineplus">+</span>
<a href="#l5.1248"></a><span id="l5.1248" class="difflineplus">+        // If this persisted tab was the selected one, then mark the newest</span>
<a href="#l5.1249"></a><span id="l5.1249" class="difflineplus">+        //  tab as the guy to select.</span>
<a href="#l5.1250"></a><span id="l5.1250" class="difflineplus">+        if (iTab == aPersistedState.selectedIndex) {</span>
<a href="#l5.1251"></a><span id="l5.1251" class="difflineplus">+          indexToSelect = this.tabInfo.length - 1;</span>
<a href="#l5.1252"></a><span id="l5.1252" class="difflineplus">+        }</span>
<a href="#l5.1253"></a><span id="l5.1253" class="difflineplus">+      }</span>
<a href="#l5.1254"></a><span id="l5.1254" class="difflineplus">+</span>
<a href="#l5.1255"></a><span id="l5.1255" class="difflineplus">+      if (indexToSelect != null &amp;&amp; !aDontRestoreFirstTab) {</span>
<a href="#l5.1256"></a><span id="l5.1256" class="difflineplus">+        this.tabContainer.selectedIndex = indexToSelect;</span>
<a href="#l5.1257"></a><span id="l5.1257" class="difflineplus">+      } else {</span>
<a href="#l5.1258"></a><span id="l5.1258" class="difflineplus">+        this.tabContainer.selectedIndex = 0;</span>
<a href="#l5.1259"></a><span id="l5.1259" class="difflineplus">+      }</span>
<a href="#l5.1260"></a><span id="l5.1260" class="difflineplus">+    }</span>
<a href="#l5.1261"></a><span id="l5.1261" class="difflineplus">+</span>
<a href="#l5.1262"></a><span id="l5.1262" class="difflineplus">+    clearRecentlyClosedTabs() {</span>
<a href="#l5.1263"></a><span id="l5.1263" class="difflineplus">+      this.recentlyClosedTabs.length = 0;</span>
<a href="#l5.1264"></a><span id="l5.1264" class="difflineplus">+    }</span>
<a href="#l5.1265"></a><span id="l5.1265" class="difflineplus">+    /**</span>
<a href="#l5.1266"></a><span id="l5.1266" class="difflineplus">+     * Called when the window is being unloaded, this calls the close</span>
<a href="#l5.1267"></a><span id="l5.1267" class="difflineplus">+     * function for every tab.</span>
<a href="#l5.1268"></a><span id="l5.1268" class="difflineplus">+     */</span>
<a href="#l5.1269"></a><span id="l5.1269" class="difflineplus">+    _teardown() {</span>
<a href="#l5.1270"></a><span id="l5.1270" class="difflineplus">+      for (var i = 0; i &lt; this.tabInfo.length; i++) {</span>
<a href="#l5.1271"></a><span id="l5.1271" class="difflineplus">+        let tab = this.tabInfo[i];</span>
<a href="#l5.1272"></a><span id="l5.1272" class="difflineplus">+        let tabCloseFunc = tab.mode.closeTab || tab.mode.tabType.closeTab;</span>
<a href="#l5.1273"></a><span id="l5.1273" class="difflineplus">+        tabCloseFunc.call(tab.mode.tabType, tab);</span>
<a href="#l5.1274"></a><span id="l5.1274" class="difflineplus">+      }</span>
<a href="#l5.1275"></a><span id="l5.1275" class="difflineplus">+    }</span>
<a href="#l5.1276"></a><span id="l5.1276" class="difflineplus">+</span>
<a href="#l5.1277"></a><span id="l5.1277" class="difflineplus">+    /**</span>
<a href="#l5.1278"></a><span id="l5.1278" class="difflineplus">+     * getBrowserForSelectedTab is required as some toolkit functions</span>
<a href="#l5.1279"></a><span id="l5.1279" class="difflineplus">+     * require a getBrowser() function.</span>
<a href="#l5.1280"></a><span id="l5.1280" class="difflineplus">+     */</span>
<a href="#l5.1281"></a><span id="l5.1281" class="difflineplus">+    getBrowserForSelectedTab() {</span>
<a href="#l5.1282"></a><span id="l5.1282" class="difflineplus">+      if (!this.tabInfo) {</span>
<a href="#l5.1283"></a><span id="l5.1283" class="difflineplus">+        return null;</span>
<a href="#l5.1284"></a><span id="l5.1284" class="difflineplus">+      }</span>
<a href="#l5.1285"></a><span id="l5.1285" class="difflineplus">+</span>
<a href="#l5.1286"></a><span id="l5.1286" class="difflineplus">+      if (!this.currentTabInfo) {</span>
<a href="#l5.1287"></a><span id="l5.1287" class="difflineplus">+        this.currentTabInfo = this.tabInfo[0];</span>
<a href="#l5.1288"></a><span id="l5.1288" class="difflineplus">+      }</span>
<a href="#l5.1289"></a><span id="l5.1289" class="difflineplus">+</span>
<a href="#l5.1290"></a><span id="l5.1290" class="difflineplus">+      if (this.currentTabInfo) {</span>
<a href="#l5.1291"></a><span id="l5.1291" class="difflineplus">+        return this.getBrowserForTab(this.currentTabInfo);</span>
<a href="#l5.1292"></a><span id="l5.1292" class="difflineplus">+      }</span>
<a href="#l5.1293"></a><span id="l5.1293" class="difflineplus">+</span>
<a href="#l5.1294"></a><span id="l5.1294" class="difflineplus">+      return null;</span>
<a href="#l5.1295"></a><span id="l5.1295" class="difflineplus">+    }</span>
<a href="#l5.1296"></a><span id="l5.1296" class="difflineplus">+</span>
<a href="#l5.1297"></a><span id="l5.1297" class="difflineplus">+    getBrowserForTab(aTab) {</span>
<a href="#l5.1298"></a><span id="l5.1298" class="difflineplus">+      let browserFunc = aTab ? aTab.mode.getBrowser || aTab.mode.tabType.getBrowser : null;</span>
<a href="#l5.1299"></a><span id="l5.1299" class="difflineplus">+      return browserFunc ? browserFunc.call(aTab.mode.tabType, aTab) : null;</span>
<a href="#l5.1300"></a><span id="l5.1300" class="difflineplus">+    }</span>
<a href="#l5.1301"></a><span id="l5.1301" class="difflineplus">+</span>
<a href="#l5.1302"></a><span id="l5.1302" class="difflineplus">+    /**</span>
<a href="#l5.1303"></a><span id="l5.1303" class="difflineplus">+     * getBrowserForDocument is used to find the browser for a specific</span>
<a href="#l5.1304"></a><span id="l5.1304" class="difflineplus">+     * document that's been loaded</span>
<a href="#l5.1305"></a><span id="l5.1305" class="difflineplus">+     */</span>
<a href="#l5.1306"></a><span id="l5.1306" class="difflineplus">+    getBrowserForDocument(aDocument) {</span>
<a href="#l5.1307"></a><span id="l5.1307" class="difflineplus">+      for (let i = 0; i &lt; this.tabInfo.length; ++i) {</span>
<a href="#l5.1308"></a><span id="l5.1308" class="difflineplus">+        let browserFunc = this.tabInfo[i].mode.getBrowser ||</span>
<a href="#l5.1309"></a><span id="l5.1309" class="difflineplus">+          this.tabInfo[i].mode.tabType.getBrowser;</span>
<a href="#l5.1310"></a><span id="l5.1310" class="difflineplus">+</span>
<a href="#l5.1311"></a><span id="l5.1311" class="difflineplus">+        if (browserFunc) {</span>
<a href="#l5.1312"></a><span id="l5.1312" class="difflineplus">+          let possBrowser = browserFunc.call(this.tabInfo[i].mode.tabType,</span>
<a href="#l5.1313"></a><span id="l5.1313" class="difflineplus">+            this.tabInfo[i]);</span>
<a href="#l5.1314"></a><span id="l5.1314" class="difflineplus">+          if (possBrowser &amp;&amp; possBrowser.contentWindow == aDocument) {</span>
<a href="#l5.1315"></a><span id="l5.1315" class="difflineplus">+            return this.tabInfo[i];</span>
<a href="#l5.1316"></a><span id="l5.1316" class="difflineplus">+          }</span>
<a href="#l5.1317"></a><span id="l5.1317" class="difflineplus">+        }</span>
<a href="#l5.1318"></a><span id="l5.1318" class="difflineplus">+      }</span>
<a href="#l5.1319"></a><span id="l5.1319" class="difflineplus">+</span>
<a href="#l5.1320"></a><span id="l5.1320" class="difflineplus">+      return null;</span>
<a href="#l5.1321"></a><span id="l5.1321" class="difflineplus">+    }</span>
<a href="#l5.1322"></a><span id="l5.1322" class="difflineplus">+</span>
<a href="#l5.1323"></a><span id="l5.1323" class="difflineplus">+    /**</span>
<a href="#l5.1324"></a><span id="l5.1324" class="difflineplus">+     * getBrowserForDocumentId is used to find the browser for a specific</span>
<a href="#l5.1325"></a><span id="l5.1325" class="difflineplus">+     * document via its id attribute.</span>
<a href="#l5.1326"></a><span id="l5.1326" class="difflineplus">+     */</span>
<a href="#l5.1327"></a><span id="l5.1327" class="difflineplus">+    getBrowserForDocumentId(aDocumentId) {</span>
<a href="#l5.1328"></a><span id="l5.1328" class="difflineplus">+      for (let i = 0; i &lt; this.tabInfo.length; ++i) {</span>
<a href="#l5.1329"></a><span id="l5.1329" class="difflineplus">+        let browserFunc = this.tabInfo[i].mode.getBrowser ||</span>
<a href="#l5.1330"></a><span id="l5.1330" class="difflineplus">+          this.tabInfo[i].mode.tabType.getBrowser;</span>
<a href="#l5.1331"></a><span id="l5.1331" class="difflineplus">+        if (browserFunc) {</span>
<a href="#l5.1332"></a><span id="l5.1332" class="difflineplus">+          let possBrowser = browserFunc.call(this.tabInfo[i].mode.tabType,</span>
<a href="#l5.1333"></a><span id="l5.1333" class="difflineplus">+            this.tabInfo[i]);</span>
<a href="#l5.1334"></a><span id="l5.1334" class="difflineplus">+          if (possBrowser &amp;&amp;</span>
<a href="#l5.1335"></a><span id="l5.1335" class="difflineplus">+            possBrowser.contentDocument.documentElement.id == aDocumentId) {</span>
<a href="#l5.1336"></a><span id="l5.1336" class="difflineplus">+            return this.tabInfo[i];</span>
<a href="#l5.1337"></a><span id="l5.1337" class="difflineplus">+          }</span>
<a href="#l5.1338"></a><span id="l5.1338" class="difflineplus">+        }</span>
<a href="#l5.1339"></a><span id="l5.1339" class="difflineplus">+      }</span>
<a href="#l5.1340"></a><span id="l5.1340" class="difflineplus">+</span>
<a href="#l5.1341"></a><span id="l5.1341" class="difflineplus">+      return null;</span>
<a href="#l5.1342"></a><span id="l5.1342" class="difflineplus">+    }</span>
<a href="#l5.1343"></a><span id="l5.1343" class="difflineplus">+</span>
<a href="#l5.1344"></a><span id="l5.1344" class="difflineplus">+    getTabForBrowser(aBrowser) {</span>
<a href="#l5.1345"></a><span id="l5.1345" class="difflineplus">+      for (let tabInfo of this.tabInfo) {</span>
<a href="#l5.1346"></a><span id="l5.1346" class="difflineplus">+        if (this.getBrowserForTab(tabInfo) == aBrowser) {</span>
<a href="#l5.1347"></a><span id="l5.1347" class="difflineplus">+          return tabInfo;</span>
<a href="#l5.1348"></a><span id="l5.1348" class="difflineplus">+        }</span>
<a href="#l5.1349"></a><span id="l5.1349" class="difflineplus">+      }</span>
<a href="#l5.1350"></a><span id="l5.1350" class="difflineplus">+      return null;</span>
<a href="#l5.1351"></a><span id="l5.1351" class="difflineplus">+    }</span>
<a href="#l5.1352"></a><span id="l5.1352" class="difflineplus">+</span>
<a href="#l5.1353"></a><span id="l5.1353" class="difflineplus">+    removeCurrentTab() {</span>
<a href="#l5.1354"></a><span id="l5.1354" class="difflineplus">+      this.removeTabByNode(this.tabContainer.allTabs[this.tabContainer.selectedIndex]);</span>
<a href="#l5.1355"></a><span id="l5.1355" class="difflineplus">+    }</span>
<a href="#l5.1356"></a><span id="l5.1356" class="difflineplus">+</span>
<a href="#l5.1357"></a><span id="l5.1357" class="difflineplus">+    switchToTab(aTabIndexNodeOrInfo) {</span>
<a href="#l5.1358"></a><span id="l5.1358" class="difflineplus">+      let [iTab] = this._getTabContextForTabbyThing(aTabIndexNodeOrInfo, false);</span>
<a href="#l5.1359"></a><span id="l5.1359" class="difflineplus">+      this.tabContainer.selectedIndex = iTab;</span>
<a href="#l5.1360"></a><span id="l5.1360" class="difflineplus">+    }</span>
<a href="#l5.1361"></a><span id="l5.1361" class="difflineplus">+</span>
<a href="#l5.1362"></a><span id="l5.1362" class="difflineplus">+    /**</span>
<a href="#l5.1363"></a><span id="l5.1363" class="difflineplus">+     * UpdateCurrentTab - called in response to changing the current tab.</span>
<a href="#l5.1364"></a><span id="l5.1364" class="difflineplus">+     */</span>
<a href="#l5.1365"></a><span id="l5.1365" class="difflineplus">+    updateCurrentTab() {</span>
<a href="#l5.1366"></a><span id="l5.1366" class="difflineplus">+      if (this.currentTabInfo != this.tabInfo[this.tabContainer.selectedIndex]) {</span>
<a href="#l5.1367"></a><span id="l5.1367" class="difflineplus">+        if (this.currentTabInfo) {</span>
<a href="#l5.1368"></a><span id="l5.1368" class="difflineplus">+          this.saveCurrentTabState();</span>
<a href="#l5.1369"></a><span id="l5.1369" class="difflineplus">+        }</span>
<a href="#l5.1370"></a><span id="l5.1370" class="difflineplus">+</span>
<a href="#l5.1371"></a><span id="l5.1371" class="difflineplus">+        let oldTab = this.currentTabInfo;</span>
<a href="#l5.1372"></a><span id="l5.1372" class="difflineplus">+        let oldPanel = [...this.panelContainer.children].find(p =&gt;</span>
<a href="#l5.1373"></a><span id="l5.1373" class="difflineplus">+          p.hasAttribute(&quot;selected&quot;));</span>
<a href="#l5.1374"></a><span id="l5.1374" class="difflineplus">+        let tab = this.currentTabInfo = this.tabInfo[this.tabContainer.selectedIndex];</span>
<a href="#l5.1375"></a><span id="l5.1375" class="difflineplus">+        // Update the selected attribute on the current and old tab panel.</span>
<a href="#l5.1376"></a><span id="l5.1376" class="difflineplus">+        if (oldPanel) {</span>
<a href="#l5.1377"></a><span id="l5.1377" class="difflineplus">+          oldPanel.removeAttribute(&quot;selected&quot;);</span>
<a href="#l5.1378"></a><span id="l5.1378" class="difflineplus">+        }</span>
<a href="#l5.1379"></a><span id="l5.1379" class="difflineplus">+</span>
<a href="#l5.1380"></a><span id="l5.1380" class="difflineplus">+        this.panelContainer.selectedPanel.setAttribute(&quot;selected&quot;, &quot;true&quot;);</span>
<a href="#l5.1381"></a><span id="l5.1381" class="difflineplus">+        let showTabFunc = tab.mode.showTab || tab.mode.tabType.showTab;</span>
<a href="#l5.1382"></a><span id="l5.1382" class="difflineplus">+        showTabFunc.call(tab.mode.tabType, tab);</span>
<a href="#l5.1383"></a><span id="l5.1383" class="difflineplus">+</span>
<a href="#l5.1384"></a><span id="l5.1384" class="difflineplus">+        for (let tabMonitor of this.tabMonitors) {</span>
<a href="#l5.1385"></a><span id="l5.1385" class="difflineplus">+          tabMonitor.onTabSwitched(tab, oldTab);</span>
<a href="#l5.1386"></a><span id="l5.1386" class="difflineplus">+        }</span>
<a href="#l5.1387"></a><span id="l5.1387" class="difflineplus">+</span>
<a href="#l5.1388"></a><span id="l5.1388" class="difflineplus">+        // always update the cursor status when we switch tabs</span>
<a href="#l5.1389"></a><span id="l5.1389" class="difflineplus">+        SetBusyCursor(window, tab.busy);</span>
<a href="#l5.1390"></a><span id="l5.1390" class="difflineplus">+        // active tabs should not have the wasBusy attribute</span>
<a href="#l5.1391"></a><span id="l5.1391" class="difflineplus">+        this.tabContainer.selectedItem.removeAttribute(&quot;wasBusy&quot;);</span>
<a href="#l5.1392"></a><span id="l5.1392" class="difflineplus">+        // update the thinking status when we switch tabs</span>
<a href="#l5.1393"></a><span id="l5.1393" class="difflineplus">+        this._setActiveThinkingState(tab.thinking);</span>
<a href="#l5.1394"></a><span id="l5.1394" class="difflineplus">+        // active tabs should not have the wasThinking attribute</span>
<a href="#l5.1395"></a><span id="l5.1395" class="difflineplus">+        this.tabContainer.selectedItem.removeAttribute(&quot;wasThinking&quot;);</span>
<a href="#l5.1396"></a><span id="l5.1396" class="difflineplus">+        this.setDocumentTitle(tab);</span>
<a href="#l5.1397"></a><span id="l5.1397" class="difflineplus">+</span>
<a href="#l5.1398"></a><span id="l5.1398" class="difflineplus">+        // Update the toolbar status - we don't need to do menus as they</span>
<a href="#l5.1399"></a><span id="l5.1399" class="difflineplus">+        // do themselves when we open them.</span>
<a href="#l5.1400"></a><span id="l5.1400" class="difflineplus">+        UpdateMailToolbar(&quot;tabmail&quot;);</span>
<a href="#l5.1401"></a><span id="l5.1401" class="difflineplus">+</span>
<a href="#l5.1402"></a><span id="l5.1402" class="difflineplus">+        // We switched tabs, so we don't need to know the last tab</span>
<a href="#l5.1403"></a><span id="l5.1403" class="difflineplus">+        // opener anymore.</span>
<a href="#l5.1404"></a><span id="l5.1404" class="difflineplus">+        this.mLastTabOpener = null;</span>
<a href="#l5.1405"></a><span id="l5.1405" class="difflineplus">+        let evt = new CustomEvent(&quot;TabSelect&quot;, { bubbles: true, detail: { tabInfo: tab } });</span>
<a href="#l5.1406"></a><span id="l5.1406" class="difflineplus">+        this.tabContainer.selectedItem.dispatchEvent(evt);</span>
<a href="#l5.1407"></a><span id="l5.1407" class="difflineplus">+      }</span>
<a href="#l5.1408"></a><span id="l5.1408" class="difflineplus">+    }</span>
<a href="#l5.1409"></a><span id="l5.1409" class="difflineplus">+</span>
<a href="#l5.1410"></a><span id="l5.1410" class="difflineplus">+    saveCurrentTabState() {</span>
<a href="#l5.1411"></a><span id="l5.1411" class="difflineplus">+      if (!this.currentTabInfo) {</span>
<a href="#l5.1412"></a><span id="l5.1412" class="difflineplus">+        this.currentTabInfo = this.tabInfo[0];</span>
<a href="#l5.1413"></a><span id="l5.1413" class="difflineplus">+      }</span>
<a href="#l5.1414"></a><span id="l5.1414" class="difflineplus">+</span>
<a href="#l5.1415"></a><span id="l5.1415" class="difflineplus">+      let tab = this.currentTabInfo;</span>
<a href="#l5.1416"></a><span id="l5.1416" class="difflineplus">+      // save the old tab state before we change the current tab</span>
<a href="#l5.1417"></a><span id="l5.1417" class="difflineplus">+      let saveTabFunc = tab.mode.saveTabState || tab.mode.tabType.saveTabState;</span>
<a href="#l5.1418"></a><span id="l5.1418" class="difflineplus">+      saveTabFunc.call(tab.mode.tabType, tab);</span>
<a href="#l5.1419"></a><span id="l5.1419" class="difflineplus">+    }</span>
<a href="#l5.1420"></a><span id="l5.1420" class="difflineplus">+</span>
<a href="#l5.1421"></a><span id="l5.1421" class="difflineplus">+    onTabClick(event) {</span>
<a href="#l5.1422"></a><span id="l5.1422" class="difflineplus">+      // a middle mouse button click on a tab is a short cut for closing a tab</span>
<a href="#l5.1423"></a><span id="l5.1423" class="difflineplus">+      if (event.button != 1 || document.tab.localName != &quot;tab&quot;) {</span>
<a href="#l5.1424"></a><span id="l5.1424" class="difflineplus">+        return;</span>
<a href="#l5.1425"></a><span id="l5.1425" class="difflineplus">+      }</span>
<a href="#l5.1426"></a><span id="l5.1426" class="difflineplus">+</span>
<a href="#l5.1427"></a><span id="l5.1427" class="difflineplus">+      this.removeTabByNode(document.tab);</span>
<a href="#l5.1428"></a><span id="l5.1428" class="difflineplus">+      event.stopPropagation();</span>
<a href="#l5.1429"></a><span id="l5.1429" class="difflineplus">+    }</span>
<a href="#l5.1430"></a><span id="l5.1430" class="difflineplus">+</span>
<a href="#l5.1431"></a><span id="l5.1431" class="difflineplus">+    setTabTitle(aTabNodeOrInfo) {</span>
<a href="#l5.1432"></a><span id="l5.1432" class="difflineplus">+      let [iTab, tab] = this._getTabContextForTabbyThing(aTabNodeOrInfo, true);</span>
<a href="#l5.1433"></a><span id="l5.1433" class="difflineplus">+      if (tab) {</span>
<a href="#l5.1434"></a><span id="l5.1434" class="difflineplus">+        let tabNode = this.tabContainer.allTabs[iTab];</span>
<a href="#l5.1435"></a><span id="l5.1435" class="difflineplus">+        let titleChangeFunc = tab.mode.onTitleChanged ||</span>
<a href="#l5.1436"></a><span id="l5.1436" class="difflineplus">+          tab.mode.tabType.onTitleChanged;</span>
<a href="#l5.1437"></a><span id="l5.1437" class="difflineplus">+        if (titleChangeFunc) {</span>
<a href="#l5.1438"></a><span id="l5.1438" class="difflineplus">+          titleChangeFunc.call(tab.mode.tabType, tab, tabNode);</span>
<a href="#l5.1439"></a><span id="l5.1439" class="difflineplus">+        }</span>
<a href="#l5.1440"></a><span id="l5.1440" class="difflineplus">+</span>
<a href="#l5.1441"></a><span id="l5.1441" class="difflineplus">+        let defaultTabTitle = document.documentElement.getAttribute(&quot;defaultTabTitle&quot;);</span>
<a href="#l5.1442"></a><span id="l5.1442" class="difflineplus">+        let oldLabel = tabNode.getAttribute(&quot;label&quot;);</span>
<a href="#l5.1443"></a><span id="l5.1443" class="difflineplus">+        let newLabel = aTabNodeOrInfo ? tab.title : defaultTabTitle;</span>
<a href="#l5.1444"></a><span id="l5.1444" class="difflineplus">+        if (oldLabel == newLabel) {</span>
<a href="#l5.1445"></a><span id="l5.1445" class="difflineplus">+          return;</span>
<a href="#l5.1446"></a><span id="l5.1446" class="difflineplus">+        }</span>
<a href="#l5.1447"></a><span id="l5.1447" class="difflineplus">+</span>
<a href="#l5.1448"></a><span id="l5.1448" class="difflineplus">+        for (let tabMonitor of this.tabMonitors) {</span>
<a href="#l5.1449"></a><span id="l5.1449" class="difflineplus">+          tabMonitor.onTabTitleChanged(tab);</span>
<a href="#l5.1450"></a><span id="l5.1450" class="difflineplus">+        }</span>
<a href="#l5.1451"></a><span id="l5.1451" class="difflineplus">+</span>
<a href="#l5.1452"></a><span id="l5.1452" class="difflineplus">+        // If the displayed tab is the one at the moment of creation</span>
<a href="#l5.1453"></a><span id="l5.1453" class="difflineplus">+        // (aTabNodeOrInfo is null), set the default title as its title.</span>
<a href="#l5.1454"></a><span id="l5.1454" class="difflineplus">+        tabNode.setAttribute(&quot;label&quot;, newLabel);</span>
<a href="#l5.1455"></a><span id="l5.1455" class="difflineplus">+        // Update the window title if we're the displayed tab.</span>
<a href="#l5.1456"></a><span id="l5.1456" class="difflineplus">+        if (iTab == this.tabContainer.selectedIndex) {</span>
<a href="#l5.1457"></a><span id="l5.1457" class="difflineplus">+          this.setDocumentTitle(tab);</span>
<a href="#l5.1458"></a><span id="l5.1458" class="difflineplus">+        }</span>
<a href="#l5.1459"></a><span id="l5.1459" class="difflineplus">+</span>
<a href="#l5.1460"></a><span id="l5.1460" class="difflineplus">+        // Notify tab title change</span>
<a href="#l5.1461"></a><span id="l5.1461" class="difflineplus">+        if (!tab.beforeTabOpen) {</span>
<a href="#l5.1462"></a><span id="l5.1462" class="difflineplus">+          let evt = new CustomEvent(&quot;TabAttrModified&quot;, {</span>
<a href="#l5.1463"></a><span id="l5.1463" class="difflineplus">+            bubbles: true,</span>
<a href="#l5.1464"></a><span id="l5.1464" class="difflineplus">+            cancelable: false,</span>
<a href="#l5.1465"></a><span id="l5.1465" class="difflineplus">+            detail: { changed: [&quot;label&quot;], tabInfo: tab },</span>
<a href="#l5.1466"></a><span id="l5.1466" class="difflineplus">+          });</span>
<a href="#l5.1467"></a><span id="l5.1467" class="difflineplus">+          tabNode.dispatchEvent(evt);</span>
<a href="#l5.1468"></a><span id="l5.1468" class="difflineplus">+        }</span>
<a href="#l5.1469"></a><span id="l5.1469" class="difflineplus">+      }</span>
<a href="#l5.1470"></a><span id="l5.1470" class="difflineplus">+    }</span>
<a href="#l5.1471"></a><span id="l5.1471" class="difflineplus">+</span>
<a href="#l5.1472"></a><span id="l5.1472" class="difflineplus">+    /**</span>
<a href="#l5.1473"></a><span id="l5.1473" class="difflineplus">+     * Sets the tab icon to the specified url, or removes the icon if no</span>
<a href="#l5.1474"></a><span id="l5.1474" class="difflineplus">+     * url is specified. Note that this may override css provided images.</span>
<a href="#l5.1475"></a><span id="l5.1475" class="difflineplus">+     */</span>
<a href="#l5.1476"></a><span id="l5.1476" class="difflineplus">+    setTabIcon(aTabNodeOrInfo, aIcon) {</span>
<a href="#l5.1477"></a><span id="l5.1477" class="difflineplus">+      let [iTab, tab] = this._getTabContextForTabbyThing(aTabNodeOrInfo, true);</span>
<a href="#l5.1478"></a><span id="l5.1478" class="difflineplus">+      if (tab) {</span>
<a href="#l5.1479"></a><span id="l5.1479" class="difflineplus">+        let tabNode = this.tabContainer.allTabs[iTab];</span>
<a href="#l5.1480"></a><span id="l5.1480" class="difflineplus">+        let oldIcon = tabNode.getAttribute(&quot;image&quot;);</span>
<a href="#l5.1481"></a><span id="l5.1481" class="difflineplus">+        if (oldIcon != aIcon &amp;&amp; !tab.beforeTabOpen) {</span>
<a href="#l5.1482"></a><span id="l5.1482" class="difflineplus">+          let evt = new CustomEvent(&quot;TabAttrModified&quot;, {</span>
<a href="#l5.1483"></a><span id="l5.1483" class="difflineplus">+            bubbles: true,</span>
<a href="#l5.1484"></a><span id="l5.1484" class="difflineplus">+            cancelable: false,</span>
<a href="#l5.1485"></a><span id="l5.1485" class="difflineplus">+            detail: { changed: [&quot;image&quot;], tabInfo: tab },</span>
<a href="#l5.1486"></a><span id="l5.1486" class="difflineplus">+          });</span>
<a href="#l5.1487"></a><span id="l5.1487" class="difflineplus">+          tabNode.dispatchEvent(evt);</span>
<a href="#l5.1488"></a><span id="l5.1488" class="difflineplus">+        }</span>
<a href="#l5.1489"></a><span id="l5.1489" class="difflineplus">+</span>
<a href="#l5.1490"></a><span id="l5.1490" class="difflineplus">+        if (aIcon) {</span>
<a href="#l5.1491"></a><span id="l5.1491" class="difflineplus">+          tabNode.setAttribute(&quot;image&quot;, aIcon);</span>
<a href="#l5.1492"></a><span id="l5.1492" class="difflineplus">+        } else {</span>
<a href="#l5.1493"></a><span id="l5.1493" class="difflineplus">+          tabNode.removeAttribute(&quot;image&quot;);</span>
<a href="#l5.1494"></a><span id="l5.1494" class="difflineplus">+        }</span>
<a href="#l5.1495"></a><span id="l5.1495" class="difflineplus">+      }</span>
<a href="#l5.1496"></a><span id="l5.1496" class="difflineplus">+    }</span>
<a href="#l5.1497"></a><span id="l5.1497" class="difflineplus">+</span>
<a href="#l5.1498"></a><span id="l5.1498" class="difflineplus">+    /**</span>
<a href="#l5.1499"></a><span id="l5.1499" class="difflineplus">+     * Updates the global state to reflect the active tab's thinking</span>
<a href="#l5.1500"></a><span id="l5.1500" class="difflineplus">+     * state (which the caller provides).</span>
<a href="#l5.1501"></a><span id="l5.1501" class="difflineplus">+     */</span>
<a href="#l5.1502"></a><span id="l5.1502" class="difflineplus">+    _setActiveThinkingState(aThinkingState) {</span>
<a href="#l5.1503"></a><span id="l5.1503" class="difflineplus">+      if (aThinkingState) {</span>
<a href="#l5.1504"></a><span id="l5.1504" class="difflineplus">+        statusFeedback.showProgress(0);</span>
<a href="#l5.1505"></a><span id="l5.1505" class="difflineplus">+        if (typeof(aThinkingState) == &quot;string&quot;) {</span>
<a href="#l5.1506"></a><span id="l5.1506" class="difflineplus">+          statusFeedback.showStatusString(aThinkingState);</span>
<a href="#l5.1507"></a><span id="l5.1507" class="difflineplus">+        }</span>
<a href="#l5.1508"></a><span id="l5.1508" class="difflineplus">+        gStatusBar.removeAttribute(&quot;value&quot;);</span>
<a href="#l5.1509"></a><span id="l5.1509" class="difflineplus">+      } else {</span>
<a href="#l5.1510"></a><span id="l5.1510" class="difflineplus">+        statusFeedback.showProgress(0);</span>
<a href="#l5.1511"></a><span id="l5.1511" class="difflineplus">+        gStatusBar.value = 0;</span>
<a href="#l5.1512"></a><span id="l5.1512" class="difflineplus">+      }</span>
<a href="#l5.1513"></a><span id="l5.1513" class="difflineplus">+    }</span>
<a href="#l5.1514"></a><span id="l5.1514" class="difflineplus">+</span>
<a href="#l5.1515"></a><span id="l5.1515" class="difflineplus">+    setTabThinking(aTabNodeOrInfo, aThinking) {</span>
<a href="#l5.1516"></a><span id="l5.1516" class="difflineplus">+      let [iTab, tab, tabNode] =</span>
<a href="#l5.1517"></a><span id="l5.1517" class="difflineplus">+        this._getTabContextForTabbyThing(aTabNodeOrInfo, false);</span>
<a href="#l5.1518"></a><span id="l5.1518" class="difflineplus">+      let isSelected = (iTab == this.tabContainer.selectedIndex);</span>
<a href="#l5.1519"></a><span id="l5.1519" class="difflineplus">+      // if we are the current tab, update the cursor</span>
<a href="#l5.1520"></a><span id="l5.1520" class="difflineplus">+      if (isSelected) {</span>
<a href="#l5.1521"></a><span id="l5.1521" class="difflineplus">+        this._setActiveThinkingState(aThinking);</span>
<a href="#l5.1522"></a><span id="l5.1522" class="difflineplus">+      }</span>
<a href="#l5.1523"></a><span id="l5.1523" class="difflineplus">+</span>
<a href="#l5.1524"></a><span id="l5.1524" class="difflineplus">+      // if we are busy, hint our tab</span>
<a href="#l5.1525"></a><span id="l5.1525" class="difflineplus">+      if (aThinking) {</span>
<a href="#l5.1526"></a><span id="l5.1526" class="difflineplus">+        tabNode.setAttribute(&quot;thinking&quot;, &quot;true&quot;);</span>
<a href="#l5.1527"></a><span id="l5.1527" class="difflineplus">+      } else {</span>
<a href="#l5.1528"></a><span id="l5.1528" class="difflineplus">+        // if we were thinking and are not selected, set the</span>
<a href="#l5.1529"></a><span id="l5.1529" class="difflineplus">+        //  &quot;wasThinking&quot; attribute.</span>
<a href="#l5.1530"></a><span id="l5.1530" class="difflineplus">+        if (tab.thinking &amp;&amp; !isSelected) {</span>
<a href="#l5.1531"></a><span id="l5.1531" class="difflineplus">+          tabNode.setAttribute(&quot;wasThinking&quot;, &quot;true&quot;);</span>
<a href="#l5.1532"></a><span id="l5.1532" class="difflineplus">+        }</span>
<a href="#l5.1533"></a><span id="l5.1533" class="difflineplus">+        tabNode.removeAttribute(&quot;thinking&quot;);</span>
<a href="#l5.1534"></a><span id="l5.1534" class="difflineplus">+      }</span>
<a href="#l5.1535"></a><span id="l5.1535" class="difflineplus">+</span>
<a href="#l5.1536"></a><span id="l5.1536" class="difflineplus">+      // update the tab info to store the busy state.</span>
<a href="#l5.1537"></a><span id="l5.1537" class="difflineplus">+      tab.thinking = aThinking;</span>
<a href="#l5.1538"></a><span id="l5.1538" class="difflineplus">+    }</span>
<a href="#l5.1539"></a><span id="l5.1539" class="difflineplus">+</span>
<a href="#l5.1540"></a><span id="l5.1540" class="difflineplus">+    setTabBusy(aTabNodeOrInfo, aBusy) {</span>
<a href="#l5.1541"></a><span id="l5.1541" class="difflineplus">+      let [iTab, tab, tabNode] =</span>
<a href="#l5.1542"></a><span id="l5.1542" class="difflineplus">+        this._getTabContextForTabbyThing(aTabNodeOrInfo, false);</span>
<a href="#l5.1543"></a><span id="l5.1543" class="difflineplus">+      let isSelected = (iTab == this.tabContainer.selectedIndex);</span>
<a href="#l5.1544"></a><span id="l5.1544" class="difflineplus">+</span>
<a href="#l5.1545"></a><span id="l5.1545" class="difflineplus">+      // if we are the current tab, update the cursor</span>
<a href="#l5.1546"></a><span id="l5.1546" class="difflineplus">+      if (isSelected) {</span>
<a href="#l5.1547"></a><span id="l5.1547" class="difflineplus">+        SetBusyCursor(window, aBusy);</span>
<a href="#l5.1548"></a><span id="l5.1548" class="difflineplus">+      }</span>
<a href="#l5.1549"></a><span id="l5.1549" class="difflineplus">+</span>
<a href="#l5.1550"></a><span id="l5.1550" class="difflineplus">+      // if we are busy, hint our tab</span>
<a href="#l5.1551"></a><span id="l5.1551" class="difflineplus">+      if (aBusy) {</span>
<a href="#l5.1552"></a><span id="l5.1552" class="difflineplus">+        tabNode.setAttribute(&quot;busy&quot;, &quot;true&quot;);</span>
<a href="#l5.1553"></a><span id="l5.1553" class="difflineplus">+      } else {</span>
<a href="#l5.1554"></a><span id="l5.1554" class="difflineplus">+        // if we were busy and are not selected, set the</span>
<a href="#l5.1555"></a><span id="l5.1555" class="difflineplus">+        //  &quot;wasBusy&quot; attribute.</span>
<a href="#l5.1556"></a><span id="l5.1556" class="difflineplus">+        if (tab.busy &amp;&amp; !isSelected) {</span>
<a href="#l5.1557"></a><span id="l5.1557" class="difflineplus">+          tabNode.setAttribute(&quot;wasBusy&quot;, &quot;true&quot;);</span>
<a href="#l5.1558"></a><span id="l5.1558" class="difflineplus">+        }</span>
<a href="#l5.1559"></a><span id="l5.1559" class="difflineplus">+        tabNode.removeAttribute(&quot;busy&quot;);</span>
<a href="#l5.1560"></a><span id="l5.1560" class="difflineplus">+      }</span>
<a href="#l5.1561"></a><span id="l5.1561" class="difflineplus">+</span>
<a href="#l5.1562"></a><span id="l5.1562" class="difflineplus">+      // update the tab info to store the busy state.</span>
<a href="#l5.1563"></a><span id="l5.1563" class="difflineplus">+      tab.busy = aBusy;</span>
<a href="#l5.1564"></a><span id="l5.1564" class="difflineplus">+    }</span>
<a href="#l5.1565"></a><span id="l5.1565" class="difflineplus">+</span>
<a href="#l5.1566"></a><span id="l5.1566" class="difflineplus">+    onTabContextMenuShowing(aTabNode) {</span>
<a href="#l5.1567"></a><span id="l5.1567" class="difflineplus">+      // this happens when the user did not actually-click on a tab but</span>
<a href="#l5.1568"></a><span id="l5.1568" class="difflineplus">+      // instead on the strip behind it.</span>
<a href="#l5.1569"></a><span id="l5.1569" class="difflineplus">+      if (aTabNode.localName != &quot;tab&quot;) {</span>
<a href="#l5.1570"></a><span id="l5.1570" class="difflineplus">+        return false;</span>
<a href="#l5.1571"></a><span id="l5.1571" class="difflineplus">+      }</span>
<a href="#l5.1572"></a><span id="l5.1572" class="difflineplus">+</span>
<a href="#l5.1573"></a><span id="l5.1573" class="difflineplus">+      let tabContextMenu = document.getElementById(&quot;tabContextMenu&quot;);</span>
<a href="#l5.1574"></a><span id="l5.1574" class="difflineplus">+      let tab = this._getTabContextForTabbyThing(aTabNode, true)[1];</span>
<a href="#l5.1575"></a><span id="l5.1575" class="difflineplus">+      // by default &quot;close other tabs&quot; is disabled...</span>
<a href="#l5.1576"></a><span id="l5.1576" class="difflineplus">+      tabContextMenu.querySelector(`[anonid=&quot;closeOtherTabs&quot;]`)</span>
<a href="#l5.1577"></a><span id="l5.1577" class="difflineplus">+                    .setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l5.1578"></a><span id="l5.1578" class="difflineplus">+      // ... except if we find at least one other tab that can be closed.</span>
<a href="#l5.1579"></a><span id="l5.1579" class="difflineplus">+      for (let i = 0; i &lt; this.tabInfo.length; i++) {</span>
<a href="#l5.1580"></a><span id="l5.1580" class="difflineplus">+        if (this.tabInfo[i].canClose &amp;&amp; this.tabInfo[i] != tab) {</span>
<a href="#l5.1581"></a><span id="l5.1581" class="difflineplus">+          tabContextMenu.querySelector(`[anonid=&quot;closeOtherTabs&quot;]`)</span>
<a href="#l5.1582"></a><span id="l5.1582" class="difflineplus">+                        .setAttribute(&quot;disabled&quot;, &quot;false&quot;);</span>
<a href="#l5.1583"></a><span id="l5.1583" class="difflineplus">+          break;</span>
<a href="#l5.1584"></a><span id="l5.1584" class="difflineplus">+        }</span>
<a href="#l5.1585"></a><span id="l5.1585" class="difflineplus">+      }</span>
<a href="#l5.1586"></a><span id="l5.1586" class="difflineplus">+</span>
<a href="#l5.1587"></a><span id="l5.1587" class="difflineplus">+      tabContextMenu.querySelector(`[anonid=&quot;closeTab&quot;]`)</span>
<a href="#l5.1588"></a><span id="l5.1588" class="difflineplus">+                    .setAttribute(&quot;disabled&quot;, tab.canClose ? &quot;false&quot; : &quot;true&quot;);</span>
<a href="#l5.1589"></a><span id="l5.1589" class="difflineplus">+      // enable &quot;Open in new Window&quot; iff tab is closable and...</span>
<a href="#l5.1590"></a><span id="l5.1590" class="difflineplus">+      // ... it can persist its state. Other wise it would get destroyed...</span>
<a href="#l5.1591"></a><span id="l5.1591" class="difflineplus">+      // ... while moving it to a new window.</span>
<a href="#l5.1592"></a><span id="l5.1592" class="difflineplus">+      tabContextMenu.querySelector(`[anonid=&quot;openTabInWindow&quot;]`)</span>
<a href="#l5.1593"></a><span id="l5.1593" class="difflineplus">+                    .setAttribute(&quot;disabled&quot;,</span>
<a href="#l5.1594"></a><span id="l5.1594" class="difflineplus">+                      (tab.canClose &amp;&amp; this.persistTab(tab)) ? &quot;false&quot; : &quot;true&quot;);</span>
<a href="#l5.1595"></a><span id="l5.1595" class="difflineplus">+      // If the tab history is empty, disable &quot;Undo Close Tab&quot;</span>
<a href="#l5.1596"></a><span id="l5.1596" class="difflineplus">+      tabContextMenu.querySelector(`[anonid=&quot;recentlyClosedTabs&quot;]`)</span>
<a href="#l5.1597"></a><span id="l5.1597" class="difflineplus">+                    .setAttribute(&quot;disabled&quot;,</span>
<a href="#l5.1598"></a><span id="l5.1598" class="difflineplus">+                      (this.recentlyClosedTabs.length) ? &quot;false&quot; : &quot;true&quot;);</span>
<a href="#l5.1599"></a><span id="l5.1599" class="difflineplus">+</span>
<a href="#l5.1600"></a><span id="l5.1600" class="difflineplus">+      return true;</span>
<a href="#l5.1601"></a><span id="l5.1601" class="difflineplus">+    }</span>
<a href="#l5.1602"></a><span id="l5.1602" class="difflineplus">+</span>
<a href="#l5.1603"></a><span id="l5.1603" class="difflineplus">+    /**</span>
<a href="#l5.1604"></a><span id="l5.1604" class="difflineplus">+     * Set the document title based on the tab title</span>
<a href="#l5.1605"></a><span id="l5.1605" class="difflineplus">+     */</span>
<a href="#l5.1606"></a><span id="l5.1606" class="difflineplus">+    setDocumentTitle(aTab) {</span>
<a href="#l5.1607"></a><span id="l5.1607" class="difflineplus">+      let docTitle = aTab.title ? aTab.title.trim() : &quot;&quot;;</span>
<a href="#l5.1608"></a><span id="l5.1608" class="difflineplus">+      let docElement = document.documentElement;</span>
<a href="#l5.1609"></a><span id="l5.1609" class="difflineplus">+      // If the document title is blank, add the default title.</span>
<a href="#l5.1610"></a><span id="l5.1610" class="difflineplus">+      if (!docTitle) {</span>
<a href="#l5.1611"></a><span id="l5.1611" class="difflineplus">+        docTitle = docElement.getAttribute(&quot;defaultTabTitle&quot;);</span>
<a href="#l5.1612"></a><span id="l5.1612" class="difflineplus">+      }</span>
<a href="#l5.1613"></a><span id="l5.1613" class="difflineplus">+</span>
<a href="#l5.1614"></a><span id="l5.1614" class="difflineplus">+      // If we're on Mac, don't display the separator and the modifier.</span>
<a href="#l5.1615"></a><span id="l5.1615" class="difflineplus">+      if (AppConstants.platform != &quot;macosx&quot;) {</span>
<a href="#l5.1616"></a><span id="l5.1616" class="difflineplus">+        docTitle += docElement.getAttribute(&quot;titlemenuseparator&quot;) +</span>
<a href="#l5.1617"></a><span id="l5.1617" class="difflineplus">+          docElement.getAttribute(&quot;titlemodifier&quot;);</span>
<a href="#l5.1618"></a><span id="l5.1618" class="difflineplus">+      }</span>
<a href="#l5.1619"></a><span id="l5.1619" class="difflineplus">+</span>
<a href="#l5.1620"></a><span id="l5.1620" class="difflineplus">+      document.title = docTitle;</span>
<a href="#l5.1621"></a><span id="l5.1621" class="difflineplus">+    }</span>
<a href="#l5.1622"></a><span id="l5.1622" class="difflineplus">+</span>
<a href="#l5.1623"></a><span id="l5.1623" class="difflineplus">+    addTabsProgressListener(aListener) {</span>
<a href="#l5.1624"></a><span id="l5.1624" class="difflineplus">+      this.mTabsProgressListeners.add(aListener);</span>
<a href="#l5.1625"></a><span id="l5.1625" class="difflineplus">+    }</span>
<a href="#l5.1626"></a><span id="l5.1626" class="difflineplus">+</span>
<a href="#l5.1627"></a><span id="l5.1627" class="difflineplus">+    removeTabsProgressListener(aListener) {</span>
<a href="#l5.1628"></a><span id="l5.1628" class="difflineplus">+      this.mTabsProgressListeners.delete(aListener);</span>
<a href="#l5.1629"></a><span id="l5.1629" class="difflineplus">+    }</span>
<a href="#l5.1630"></a><span id="l5.1630" class="difflineplus">+</span>
<a href="#l5.1631"></a><span id="l5.1631" class="difflineplus">+    _callTabListeners(aMethod, aArgs) {</span>
<a href="#l5.1632"></a><span id="l5.1632" class="difflineplus">+      for (let listener of this.mTabsProgressListeners.values()) {</span>
<a href="#l5.1633"></a><span id="l5.1633" class="difflineplus">+        if (aMethod in listener) {</span>
<a href="#l5.1634"></a><span id="l5.1634" class="difflineplus">+          try {</span>
<a href="#l5.1635"></a><span id="l5.1635" class="difflineplus">+            listener[aMethod](...aArgs);</span>
<a href="#l5.1636"></a><span id="l5.1636" class="difflineplus">+          } catch (e) {</span>
<a href="#l5.1637"></a><span id="l5.1637" class="difflineplus">+            Cu.reportError(e);</span>
<a href="#l5.1638"></a><span id="l5.1638" class="difflineplus">+          }</span>
<a href="#l5.1639"></a><span id="l5.1639" class="difflineplus">+        }</span>
<a href="#l5.1640"></a><span id="l5.1640" class="difflineplus">+      }</span>
<a href="#l5.1641"></a><span id="l5.1641" class="difflineplus">+    }</span>
<a href="#l5.1642"></a><span id="l5.1642" class="difflineplus">+</span>
<a href="#l5.1643"></a><span id="l5.1643" class="difflineplus">+    disconnectedCallback() {</span>
<a href="#l5.1644"></a><span id="l5.1644" class="difflineplus">+      window.controllers.removeController(this.tabController);</span>
<a href="#l5.1645"></a><span id="l5.1645" class="difflineplus">+    }</span>
<a href="#l5.1646"></a><span id="l5.1646" class="difflineplus">+  }</span>
<a href="#l5.1647"></a><span id="l5.1647" class="difflineplus">+</span>
<a href="#l5.1648"></a><span id="l5.1648" class="difflineplus">+  customElements.define(&quot;tabmail&quot;, MozTabmail);</span>
<a href="#l5.1649"></a><span id="l5.1649"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1">deleted file mode 100644</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineminus">--- a/mail/base/content/tabmail.xml</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineplus">+++ /dev/null</span>
<a href="#l6.4"></a><span id="l6.4" class="difflineat">@@ -1,1796 +0,0 @@</span>
<a href="#l6.5"></a><span id="l6.5" class="difflineminus">-&lt;?xml version=&quot;1.0&quot;?&gt;</span>
<a href="#l6.6"></a><span id="l6.6" class="difflineminus">-&lt;!-- This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l6.7"></a><span id="l6.7" class="difflineminus">-  - License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l6.8"></a><span id="l6.8" class="difflineminus">-  - file, You can obtain one at http://mozilla.org/MPL/2.0/. --&gt;</span>
<a href="#l6.9"></a><span id="l6.9" class="difflineminus">-</span>
<a href="#l6.10"></a><span id="l6.10" class="difflineminus">-&lt;!-- import-globals-from commandglue.js --&gt;</span>
<a href="#l6.11"></a><span id="l6.11" class="difflineminus">-&lt;!-- import-globals-from mailWindow.js --&gt;</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-&lt;!DOCTYPE bindings [</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineminus">-&lt;!ENTITY % messengerDTD SYSTEM &quot;chrome://messenger/locale/messenger.dtd&quot; &gt;</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineminus">-%messengerDTD;</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineminus">-&lt;!ENTITY % tabMailDTD SYSTEM &quot;chrome://messenger/locale/tabmail.dtd&quot; &gt;</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineminus">- %tabMailDTD;</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineminus">-]&gt;</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineminus">-</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineminus">-&lt;bindings id=&quot;tabmailBindings&quot;</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineminus">-   xmlns=&quot;http://www.mozilla.org/xbl&quot;</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineminus">-   xmlns:xul=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineminus">-   xmlns:xbl=&quot;http://www.mozilla.org/xbl&quot;&gt;</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineminus">-</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineminus">-  &lt;!-- Thunderbird's tab UI mechanism.</span>
<a href="#l6.26"></a><span id="l6.26" class="difflineminus">-    -</span>
<a href="#l6.27"></a><span id="l6.27" class="difflineminus">-    - We expect to be instantiated with the following children:</span>
<a href="#l6.28"></a><span id="l6.28" class="difflineminus">-    - * One &quot;tabpanels&quot; child element whose id must be placed in the</span>
<a href="#l6.29"></a><span id="l6.29" class="difflineminus">-    -   &quot;panelcontainer&quot; attribute on the element we are being bound to. We do</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineminus">-    -   this because it is important to allow overlays to contribute panels.</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineminus">-    -   When we attempted to have the immediate children of the bound element</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineminus">-    -   be propagated through use of the &quot;children&quot; tag, we found that children</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineminus">-    -   contributed by overlays did not propagate.</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineminus">-    - * Any children you want added to the right side of the tab bar.  This is</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineminus">-    -   primarily intended to allow for &quot;open a BLANK tab&quot; buttons, namely</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineminus">-    -   calendar and tasks.  For reasons similar to the tabpanels case, we</span>
<a href="#l6.37"></a><span id="l6.37" class="difflineminus">-    -   expect the instantiating element to provide a child hbox for overlays</span>
<a href="#l6.38"></a><span id="l6.38" class="difflineminus">-    -   to contribute buttons to.</span>
<a href="#l6.39"></a><span id="l6.39" class="difflineminus">-    -</span>
<a href="#l6.40"></a><span id="l6.40" class="difflineminus">-    - From a javascript perspective, there are three types of code that we</span>
<a href="#l6.41"></a><span id="l6.41" class="difflineminus">-    -  expect to interact with:</span>
<a href="#l6.42"></a><span id="l6.42" class="difflineminus">-    - 1) Code that wants to open new tabs.</span>
<a href="#l6.43"></a><span id="l6.43" class="difflineminus">-    - 2) Code that wants to contribute one or more varieties of tabs.</span>
<a href="#l6.44"></a><span id="l6.44" class="difflineminus">-    - 3) Code that wants to monitor to know when the active tab changes.</span>
<a href="#l6.45"></a><span id="l6.45" class="difflineminus">-    -</span>
<a href="#l6.46"></a><span id="l6.46" class="difflineminus">-    - Consumer code should use the following methods:</span>
<a href="#l6.47"></a><span id="l6.47" class="difflineminus">-    - * openTab(aTabModeName, aArgs)</span>
<a href="#l6.48"></a><span id="l6.48" class="difflineminus">-    -     Open a tab of the given &quot;mode&quot;, passing the provided arguments as an</span>
<a href="#l6.49"></a><span id="l6.49" class="difflineminus">-    -     object. The tab type author should tell you the modes they implement</span>
<a href="#l6.50"></a><span id="l6.50" class="difflineminus">-    -     and the required/optional arguments.</span>
<a href="#l6.51"></a><span id="l6.51" class="difflineminus">-    -</span>
<a href="#l6.52"></a><span id="l6.52" class="difflineminus">-    -     Each tab type can define the set of arguments that it expects, but</span>
<a href="#l6.53"></a><span id="l6.53" class="difflineminus">-    -     there are also a few common ones that all should obey, including:</span>
<a href="#l6.54"></a><span id="l6.54" class="difflineminus">-    -</span>
<a href="#l6.55"></a><span id="l6.55" class="difflineminus">-    -     * &quot;background&quot;: if this is true, the tab will be loaded in the</span>
<a href="#l6.56"></a><span id="l6.56" class="difflineminus">-    -       background.</span>
<a href="#l6.57"></a><span id="l6.57" class="difflineminus">-    -     * &quot;disregardOpener&quot;: if this is true, then the tab opener will not</span>
<a href="#l6.58"></a><span id="l6.58" class="difflineminus">-    -       be switched to automatically by tabmail if the new tab is immediately</span>
<a href="#l6.59"></a><span id="l6.59" class="difflineminus">-    -       closed.</span>
<a href="#l6.60"></a><span id="l6.60" class="difflineminus">-    -</span>
<a href="#l6.61"></a><span id="l6.61" class="difflineminus">-    - * closeTab(aOptionalTabIndexInfoOrTabNode, aNoUndo):</span>
<a href="#l6.62"></a><span id="l6.62" class="difflineminus">-    -     If no argument is provided, the current tab is closed. The first</span>
<a href="#l6.63"></a><span id="l6.63" class="difflineminus">-    -     argument specifies a specific tab to be closed. It can be a tab index,</span>
<a href="#l6.64"></a><span id="l6.64" class="difflineminus">-    -     a tab info object, or a tab's DOM element. In case the second</span>
<a href="#l6.65"></a><span id="l6.65" class="difflineminus">-    -     argument is true, the closed tab can't be restored by calling</span>
<a href="#l6.66"></a><span id="l6.66" class="difflineminus">-    -     undoCloseTab().</span>
<a href="#l6.67"></a><span id="l6.67" class="difflineminus">-    -     Please note, some tabs cannot be closed. Trying to close such tab,</span>
<a href="#l6.68"></a><span id="l6.68" class="difflineminus">-    -     will fail silently.</span>
<a href="#l6.69"></a><span id="l6.69" class="difflineminus">-    - * undoCloseTab():</span>
<a href="#l6.70"></a><span id="l6.70" class="difflineminus">-    -     Restores the most recent tab closed by the user.</span>
<a href="#l6.71"></a><span id="l6.71" class="difflineminus">-    - * switchToTab(aTabIndexInfoOrTabNode):</span>
<a href="#l6.72"></a><span id="l6.72" class="difflineminus">-    -     Switch to the tab by providing a tab index, tab info object, or tab</span>
<a href="#l6.73"></a><span id="l6.73" class="difflineminus">-    -     node (tabmail-tab bound element.) Instead of calling this method,</span>
<a href="#l6.74"></a><span id="l6.74" class="difflineminus">-    -     you can also just poke at tabmail.tabContainer and its selectedIndex</span>
<a href="#l6.75"></a><span id="l6.75" class="difflineminus">-    -     and selectedItem properties.</span>
<a href="#l6.76"></a><span id="l6.76" class="difflineminus">-    - * setTabIcon(aTabNodeorInfo, aIcon): Sets the tab icon to the specified</span>
<a href="#l6.77"></a><span id="l6.77" class="difflineminus">-    -     url or removes the icon if no url is specified. Note that this may</span>
<a href="#l6.78"></a><span id="l6.78" class="difflineminus">-    -     override css-provided images.</span>
<a href="#l6.79"></a><span id="l6.79" class="difflineminus">-    - * replaceTabWithWindow(aTab):</span>
<a href="#l6.80"></a><span id="l6.80" class="difflineminus">-    -     Detaches a tab from this tabbar to new window. The argument &quot;aTab&quot; is</span>
<a href="#l6.81"></a><span id="l6.81" class="difflineminus">-    -     required and can be a tab index, a tab info object or a tabs's</span>
<a href="#l6.82"></a><span id="l6.82" class="difflineminus">-    -     DOM element. Calling this method works only for tabs implementing</span>
<a href="#l6.83"></a><span id="l6.83" class="difflineminus">-    -     session restore.</span>
<a href="#l6.84"></a><span id="l6.84" class="difflineminus">-    - * moveTabTo(aTab, aIndex):</span>
<a href="#l6.85"></a><span id="l6.85" class="difflineminus">-    -     moves the given tab to the given Index. The first argument can be</span>
<a href="#l6.86"></a><span id="l6.86" class="difflineminus">-    -     a tab index, a tab info object or a tab's DOM element. The second</span>
<a href="#l6.87"></a><span id="l6.87" class="difflineminus">-    -     argument specifies the tabs new absolute position within the tabbar.</span>
<a href="#l6.88"></a><span id="l6.88" class="difflineminus">-    -</span>
<a href="#l6.89"></a><span id="l6.89" class="difflineminus">-    - Less-friendly consumer methods:</span>
<a href="#l6.90"></a><span id="l6.90" class="difflineminus">-    - * persistTab(tab):</span>
<a href="#l6.91"></a><span id="l6.91" class="difflineminus">-    -     serializes a tab into an object, by passing  a tab info object as</span>
<a href="#l6.92"></a><span id="l6.92" class="difflineminus">-    -     argument. It is used for session restore and moving tabs between</span>
<a href="#l6.93"></a><span id="l6.93" class="difflineminus">-    -     windows. Returns null in case persist fails.</span>
<a href="#l6.94"></a><span id="l6.94" class="difflineminus">-    - * removeCurrentTab():</span>
<a href="#l6.95"></a><span id="l6.95" class="difflineminus">-    -     Close the current tab.</span>
<a href="#l6.96"></a><span id="l6.96" class="difflineminus">-    - * removeTabByNode(aTabElement):</span>
<a href="#l6.97"></a><span id="l6.97" class="difflineminus">-    -     Close the tab whose tabmail-tab bound element is passed in.</span>
<a href="#l6.98"></a><span id="l6.98" class="difflineminus">-    - Changing the currently displayed tab is accomplished by changing</span>
<a href="#l6.99"></a><span id="l6.99" class="difflineminus">-    -  tabmail.tabContainer's selectedIndex or selectedItem property.</span>
<a href="#l6.100"></a><span id="l6.100" class="difflineminus">-    -</span>
<a href="#l6.101"></a><span id="l6.101" class="difflineminus">-    - Code that lives in a tab should use the following methods:</span>
<a href="#l6.102"></a><span id="l6.102" class="difflineminus">-    - * setTabTitle([aOptionalTabInfo]): Tells us that the title of the current</span>
<a href="#l6.103"></a><span id="l6.103" class="difflineminus">-    -   tab (if no argument is provided) or provided tab needs to be updated.</span>
<a href="#l6.104"></a><span id="l6.104" class="difflineminus">-    -   This will result in a call to the tab mode's logic to update the title.</span>
<a href="#l6.105"></a><span id="l6.105" class="difflineminus">-    -   In the event this is not for the current tab, the caller is responsible</span>
<a href="#l6.106"></a><span id="l6.106" class="difflineminus">-    -   for ensuring that the underlying tab mode is capable of providing a tab</span>
<a href="#l6.107"></a><span id="l6.107" class="difflineminus">-    -   title when it is in the background.  (The is currently not the case for</span>
<a href="#l6.108"></a><span id="l6.108" class="difflineminus">-    -   &quot;folder&quot; and &quot;mail&quot; modes because of their implementation.)</span>
<a href="#l6.109"></a><span id="l6.109" class="difflineminus">-    - * setTabBusy(aTabNode, aBusyState): Tells us that the tab in question</span>
<a href="#l6.110"></a><span id="l6.110" class="difflineminus">-    -   is now busy or not busy.  &quot;Busy&quot; means that it is occupied and</span>
<a href="#l6.111"></a><span id="l6.111" class="difflineminus">-    -   will not be able to respond to you until it is no longer busy.</span>
<a href="#l6.112"></a><span id="l6.112" class="difflineminus">-    -   This impacts the cursor display, as well as potentially</span>
<a href="#l6.113"></a><span id="l6.113" class="difflineminus">-    -   providing tab display hints.</span>
<a href="#l6.114"></a><span id="l6.114" class="difflineminus">-    - * setTabThinking(aTabNode, aThinkingState): Tells us that the</span>
<a href="#l6.115"></a><span id="l6.115" class="difflineminus">-    -   tab in question is now thinking or not thinking.  &quot;Thinking&quot; means</span>
<a href="#l6.116"></a><span id="l6.116" class="difflineminus">-    -   that the tab is involved in some ongoing process but you can still</span>
<a href="#l6.117"></a><span id="l6.117" class="difflineminus">-    -   interact with the tab while it is thinking.  A search would be an</span>
<a href="#l6.118"></a><span id="l6.118" class="difflineminus">-    -   example of thinking.  This impacts spinny-thing feedback as well as</span>
<a href="#l6.119"></a><span id="l6.119" class="difflineminus">-    -   potential providing tab display hints.  aThinkingState may be a</span>
<a href="#l6.120"></a><span id="l6.120" class="difflineminus">-    -   boolean or a localized string explaining what you are thinking about.</span>
<a href="#l6.121"></a><span id="l6.121" class="difflineminus">-    -</span>
<a href="#l6.122"></a><span id="l6.122" class="difflineminus">-    - Tab contributing code should define a tab type object and register it</span>
<a href="#l6.123"></a><span id="l6.123" class="difflineminus">-    -  with us by calling registerTabType. You can remove a registered tab</span>
<a href="#l6.124"></a><span id="l6.124" class="difflineminus">-    -  type (eg when unloading a restartless addon) by calling unregisterTabType.</span>
<a href="#l6.125"></a><span id="l6.125" class="difflineminus">-    -  Each tab type can provide multiple tab modes. The rationale behind this</span>
<a href="#l6.126"></a><span id="l6.126" class="difflineminus">-    -  organization is that Thunderbird historically/currently uses a single</span>
<a href="#l6.127"></a><span id="l6.127" class="difflineminus">-    -  3-pane view to display both three-pane folder browsing and single message</span>
<a href="#l6.128"></a><span id="l6.128" class="difflineminus">-    -  browsing across multiple tabs. Each tab type has the ability to use a</span>
<a href="#l6.129"></a><span id="l6.129" class="difflineminus">-    -  single tab panel for all of its display needs. So Thunderbird's &quot;mail&quot;</span>
<a href="#l6.130"></a><span id="l6.130" class="difflineminus">-    -  tab type covers both the &quot;folder&quot; (3-pane folder-based browsing) and</span>
<a href="#l6.131"></a><span id="l6.131" class="difflineminus">-    -  &quot;message&quot; (just a single message) tab modes. Likewise, calendar/lightning</span>
<a href="#l6.132"></a><span id="l6.132" class="difflineminus">-    -  currently displays both its calendar and tasks in the same panel. A tab</span>
<a href="#l6.133"></a><span id="l6.133" class="difflineminus">-    -  type can also create a new tabpanel for each tab as it is created. In</span>
<a href="#l6.134"></a><span id="l6.134" class="difflineminus">-    -  that case, the tab type should probably only have a single mode unless</span>
<a href="#l6.135"></a><span id="l6.135" class="difflineminus">-    -  there are a number of similar modes that can gain from code sharing.</span>
<a href="#l6.136"></a><span id="l6.136" class="difflineminus">-    -</span>
<a href="#l6.137"></a><span id="l6.137" class="difflineminus">-    - The tab type definition should include the following attributes:</span>
<a href="#l6.138"></a><span id="l6.138" class="difflineminus">-    - * name: The name of the tab-type, mainly to aid in debugging.</span>
<a href="#l6.139"></a><span id="l6.139" class="difflineminus">-    - * panelId or perTabPanel: If using a single tab panel, the id of the</span>
<a href="#l6.140"></a><span id="l6.140" class="difflineminus">-    -     panel must be provided in panelId.  If using one tab panel per tab,</span>
<a href="#l6.141"></a><span id="l6.141" class="difflineminus">-    -     perTabPanel should be either the XUL element name that should be</span>
<a href="#l6.142"></a><span id="l6.142" class="difflineminus">-    -     created for each tab, or a helper function to create and return the</span>
<a href="#l6.143"></a><span id="l6.143" class="difflineminus">-    -     element.</span>
<a href="#l6.144"></a><span id="l6.144" class="difflineminus">-    - * modes: An object whose attributes are mode names (which are</span>
<a href="#l6.145"></a><span id="l6.145" class="difflineminus">-    -     automatically propagated to a 'name' attribute for debugging) and</span>
<a href="#l6.146"></a><span id="l6.146" class="difflineminus">-    -     values are objects with the following attributes...</span>
<a href="#l6.147"></a><span id="l6.147" class="difflineminus">-    - * any of the openTab/closeTab/saveTabState/showTab/onTitleChanged</span>
<a href="#l6.148"></a><span id="l6.148" class="difflineminus">-    -     functions as described on the mode definitions.  These will only be</span>
<a href="#l6.149"></a><span id="l6.149" class="difflineminus">-    -     called if the mode does not provide the functions.  Note that because</span>
<a href="#l6.150"></a><span id="l6.150" class="difflineminus">-    -     the 'this' variable passed to the functions will always reference the</span>
<a href="#l6.151"></a><span id="l6.151" class="difflineminus">-    -     tab type definition (rather than the mode definition), the mode</span>
<a href="#l6.152"></a><span id="l6.152" class="difflineminus">-    -     functions can defer to the tab type functions by calling</span>
<a href="#l6.153"></a><span id="l6.153" class="difflineminus">-    -     this.functionName().  (This should prove convenient.)</span>
<a href="#l6.154"></a><span id="l6.154" class="difflineminus">-    - Mode definition attributes:</span>
<a href="#l6.155"></a><span id="l6.155" class="difflineminus">-    - * type: The &quot;type&quot; attribute to set on the displayed tab for CSS purposes.</span>
<a href="#l6.156"></a><span id="l6.156" class="difflineminus">-    -     Generally, this would be the same as the mode name, but you can do as</span>
<a href="#l6.157"></a><span id="l6.157" class="difflineminus">-    -     you please.</span>
<a href="#l6.158"></a><span id="l6.158" class="difflineminus">-    - * isDefault: This should only be present and should be true for the tab</span>
<a href="#l6.159"></a><span id="l6.159" class="difflineminus">-    -     mode that is the tab displayed automatically on startup.</span>
<a href="#l6.160"></a><span id="l6.160" class="difflineminus">-    - * maxTabs: The maximum number of this mode that can be opened at a time.</span>
<a href="#l6.161"></a><span id="l6.161" class="difflineminus">-    -     If this limit is reached, any additional calls to openTab for this</span>
<a href="#l6.162"></a><span id="l6.162" class="difflineminus">-    -     mode will simply result in the first existing tab of this mode being</span>
<a href="#l6.163"></a><span id="l6.163" class="difflineminus">-    -     displayed.</span>
<a href="#l6.164"></a><span id="l6.164" class="difflineminus">-    - * shouldSwitchTo(aArgs): Optional function. Called when openTab is called</span>
<a href="#l6.165"></a><span id="l6.165" class="difflineminus">-    -     on the top-level tabmail binding. It is used to decide if the openTab</span>
<a href="#l6.166"></a><span id="l6.166" class="difflineminus">-    -     function should switch to an existing tab or actually open a new tab.</span>
<a href="#l6.167"></a><span id="l6.167" class="difflineminus">-    -     If the openTab function should switch to an existing tab, return the</span>
<a href="#l6.168"></a><span id="l6.168" class="difflineminus">-    -     index of that tab; otherwise return -1.</span>
<a href="#l6.169"></a><span id="l6.169" class="difflineminus">-    -     aArgs is a set of named parameters (the ones that are later passed to</span>
<a href="#l6.170"></a><span id="l6.170" class="difflineminus">-    -     openTab).</span>
<a href="#l6.171"></a><span id="l6.171" class="difflineminus">-    - * openTab(aTab, aArgs): Called when a tab of the given mode is in the</span>
<a href="#l6.172"></a><span id="l6.172" class="difflineminus">-    -     process of being opened.  aTab will have its &quot;mode&quot; attribute</span>
<a href="#l6.173"></a><span id="l6.173" class="difflineminus">-    -     set to the mode definition of the tab mode being opened.  You should</span>
<a href="#l6.174"></a><span id="l6.174" class="difflineminus">-    -     set the &quot;title&quot; attribute on it, and may set any other attributes</span>
<a href="#l6.175"></a><span id="l6.175" class="difflineminus">-    -     you wish for your own use in subsequent functions.  Note that 'this'</span>
<a href="#l6.176"></a><span id="l6.176" class="difflineminus">-    -     points to the tab type definition, not the mode definition as you</span>
<a href="#l6.177"></a><span id="l6.177" class="difflineminus">-    -     might expect.  This allows you to place common logic code on the</span>
<a href="#l6.178"></a><span id="l6.178" class="difflineminus">-    -     tab type for use by multiple modes and to defer to it.  Any arguments</span>
<a href="#l6.179"></a><span id="l6.179" class="difflineminus">-    -     provided to the caller of tabmail.openTab will be passed to your</span>
<a href="#l6.180"></a><span id="l6.180" class="difflineminus">-    -     function as well, including background.</span>
<a href="#l6.181"></a><span id="l6.181" class="difflineminus">-    - * closeTab(aTab): Called when aTab is being closed.  The tab need not be</span>
<a href="#l6.182"></a><span id="l6.182" class="difflineminus">-    -     currently displayed.  You are responsible for properly cleaning up</span>
<a href="#l6.183"></a><span id="l6.183" class="difflineminus">-    -     any state you preserved in aTab.</span>
<a href="#l6.184"></a><span id="l6.184" class="difflineminus">-    - * saveTabState(aTab): Called when aTab is being switched away from so that</span>
<a href="#l6.185"></a><span id="l6.185" class="difflineminus">-    -     you can preserve its state on aTab.  This is primarily for single</span>
<a href="#l6.186"></a><span id="l6.186" class="difflineminus">-    -     tab panel implementations; you may not have much state to save if your</span>
<a href="#l6.187"></a><span id="l6.187" class="difflineminus">-    -     tab has its own tab panel.</span>
<a href="#l6.188"></a><span id="l6.188" class="difflineminus">-    - * showTab(aTab): Called when aTab is being displayed and you should</span>
<a href="#l6.189"></a><span id="l6.189" class="difflineminus">-    -     restore its state (if required).</span>
<a href="#l6.190"></a><span id="l6.190" class="difflineminus">-    - * persistTab(aTab): Called when we want to persist the tab because we are</span>
<a href="#l6.191"></a><span id="l6.191" class="difflineminus">-    -     saving the session state.  You should return an object suitable for</span>
<a href="#l6.192"></a><span id="l6.192" class="difflineminus">-    -     JSON serialization.  The object will be provided to your restoreTab</span>
<a href="#l6.193"></a><span id="l6.193" class="difflineminus">-    -     method when we attempt to restore the session.  If your code is</span>
<a href="#l6.194"></a><span id="l6.194" class="difflineminus">-    -     unable or unwilling to persist the tab (some of the time), you should</span>
<a href="#l6.195"></a><span id="l6.195" class="difflineminus">-    -     return null in that case.  If your code never wants to persist the tab</span>
<a href="#l6.196"></a><span id="l6.196" class="difflineminus">-    -     you should not implement this method.  You must implement restoreTab</span>
<a href="#l6.197"></a><span id="l6.197" class="difflineminus">-    -     if you implement this method.</span>
<a href="#l6.198"></a><span id="l6.198" class="difflineminus">-    - * restoreTab(aTabmail, aPersistedState): Called when we are restoring a</span>
<a href="#l6.199"></a><span id="l6.199" class="difflineminus">-    -     tab session and a tab with your mode was previously persisted via a</span>
<a href="#l6.200"></a><span id="l6.200" class="difflineminus">-    -     call to your persistTab implementation.  You are provided with a</span>
<a href="#l6.201"></a><span id="l6.201" class="difflineminus">-    -     reference to this tabmail instance and the (deserialized) state object</span>
<a href="#l6.202"></a><span id="l6.202" class="difflineminus">-    -     you returned from your persistTab implementation.  It is your</span>
<a href="#l6.203"></a><span id="l6.203" class="difflineminus">-    -     function's job to determine if you can restore the tab, and if so,</span>
<a href="#l6.204"></a><span id="l6.204" class="difflineminus">-    -     you should invoke aTabmail.openTab to actually cause your tab to be</span>
<a href="#l6.205"></a><span id="l6.205" class="difflineminus">-    -     opened.  This may seem odd, but it should help keep your code simple</span>
<a href="#l6.206"></a><span id="l6.206" class="difflineminus">-    -     while letting you do whatever you want.  Since openTab is synchronous</span>
<a href="#l6.207"></a><span id="l6.207" class="difflineminus">-    -     and returns the tabInfo structure built for the tab, you can perform</span>
<a href="#l6.208"></a><span id="l6.208" class="difflineminus">-    -     any additional work you need after the call to openTab.</span>
<a href="#l6.209"></a><span id="l6.209" class="difflineminus">-    - * onTitleChanged(aTab): Called when someone calls tabmail.setTabTitle() to</span>
<a href="#l6.210"></a><span id="l6.210" class="difflineminus">-    -     hint that the tab's title needs to be updated.  This function should</span>
<a href="#l6.211"></a><span id="l6.211" class="difflineminus">-    -     update aTab.title if it can.</span>
<a href="#l6.212"></a><span id="l6.212" class="difflineminus">-    - Mode definition functions to do with menu/toolbar commands:</span>
<a href="#l6.213"></a><span id="l6.213" class="difflineminus">-    - * supportsCommand(aCommand, aTab): Called when a menu or toolbar needs to</span>
<a href="#l6.214"></a><span id="l6.214" class="difflineminus">-    -     be updated. Return true if you support that command in</span>
<a href="#l6.215"></a><span id="l6.215" class="difflineminus">-    -     isCommandEnabled and doCommand, return false otherwise.</span>
<a href="#l6.216"></a><span id="l6.216" class="difflineminus">-    - * isCommandEnabled(aCommand, aTab): Called when a menu or toolbar needs</span>
<a href="#l6.217"></a><span id="l6.217" class="difflineminus">-    -     to be updated. Return true if the command can be executed at the</span>
<a href="#l6.218"></a><span id="l6.218" class="difflineminus">-    -     current time, false otherwise.</span>
<a href="#l6.219"></a><span id="l6.219" class="difflineminus">-    - * doCommand(aCommand, aTab): Called when a menu or toolbar command is to</span>
<a href="#l6.220"></a><span id="l6.220" class="difflineminus">-    -     be executed. Perform the action appropriate to the command.</span>
<a href="#l6.221"></a><span id="l6.221" class="difflineminus">-    - * onEvent(aEvent, aTab): This can be used to handle different events on</span>
<a href="#l6.222"></a><span id="l6.222" class="difflineminus">-    -     the window.</span>
<a href="#l6.223"></a><span id="l6.223" class="difflineminus">-    - * getBrowser(aTab): This function should return the browser element for</span>
<a href="#l6.224"></a><span id="l6.224" class="difflineminus">-    -     your tab if there is one (return null or don't define this function</span>
<a href="#l6.225"></a><span id="l6.225" class="difflineminus">-    -     otherwise). It is used for some toolkit functions that require a</span>
<a href="#l6.226"></a><span id="l6.226" class="difflineminus">-    -     global &quot;getBrowser&quot; function, e.g. ZoomManager.</span>
<a href="#l6.227"></a><span id="l6.227" class="difflineminus">-    -</span>
<a href="#l6.228"></a><span id="l6.228" class="difflineminus">-    - Tab monitoring code is expected to be used for widgets on the screen</span>
<a href="#l6.229"></a><span id="l6.229" class="difflineminus">-    -  outside of the tab box that need to update themselves as the active tab</span>
<a href="#l6.230"></a><span id="l6.230" class="difflineminus">-    -  changes.</span>
<a href="#l6.231"></a><span id="l6.231" class="difflineminus">-    - Tab monitoring code (un)registers itself via (un)registerTabMonitor.</span>
<a href="#l6.232"></a><span id="l6.232" class="difflineminus">-    -  The following attributes should be provided on the monitor object:</span>
<a href="#l6.233"></a><span id="l6.233" class="difflineminus">-    - * monitorName: A string value naming the tab monitor/extension.  This is</span>
<a href="#l6.234"></a><span id="l6.234" class="difflineminus">-    -     the canonical name for the tab monitor for all persistence purposes.</span>
<a href="#l6.235"></a><span id="l6.235" class="difflineminus">-    -     If the tab monitor wants to store data in the tab info object and its</span>
<a href="#l6.236"></a><span id="l6.236" class="difflineminus">-    -     name is FOO it should store it in 'tabInfo._ext.FOO'.  This is the</span>
<a href="#l6.237"></a><span id="l6.237" class="difflineminus">-    -     only place the tab monitor should store information on the tab info</span>
<a href="#l6.238"></a><span id="l6.238" class="difflineminus">-    -     object.  The FOO attribute will not be automatically created; it is</span>
<a href="#l6.239"></a><span id="l6.239" class="difflineminus">-    -     up to the code.  The _ext attribute will be there, reliably, however.</span>
<a href="#l6.240"></a><span id="l6.240" class="difflineminus">-    -     The name is also used when persisting state, but the tab monitor</span>
<a href="#l6.241"></a><span id="l6.241" class="difflineminus">-    -     does not need to do anything in that case; the name is automatically</span>
<a href="#l6.242"></a><span id="l6.242" class="difflineminus">-    -     used in the course of wrapping the object.</span>
<a href="#l6.243"></a><span id="l6.243" class="difflineminus">-    -  The following functions should be provided on the monitor object:</span>
<a href="#l6.244"></a><span id="l6.244" class="difflineminus">-    - * onTabTitleChanged(aTab): Called when the tab's title changes.</span>
<a href="#l6.245"></a><span id="l6.245" class="difflineminus">-    - * onTabSwitched(aTab, aOldTab): Called when a new tab is made active.  If</span>
<a href="#l6.246"></a><span id="l6.246" class="difflineminus">-    -     this is the first tab ever, aOldTab will be null, otherwise aOldTab</span>
<a href="#l6.247"></a><span id="l6.247" class="difflineminus">-    -     will be the previously active tab.</span>
<a href="#l6.248"></a><span id="l6.248" class="difflineminus">-    - * onTabOpened(aTab, aIsFirstTab, aWasCurrentTab): Called when a new tab is</span>
<a href="#l6.249"></a><span id="l6.249" class="difflineminus">-    -     opened.  This method is invoked after the tab mode's openTab method</span>
<a href="#l6.250"></a><span id="l6.250" class="difflineminus">-    -     is invoked.  This method is invoked before the tab monitor</span>
<a href="#l6.251"></a><span id="l6.251" class="difflineminus">-    -     onTabSwitched method in the case where it will be invoked.  (It is</span>
<a href="#l6.252"></a><span id="l6.252" class="difflineminus">-    -     not invoked if the tab is opened in the background.)</span>
<a href="#l6.253"></a><span id="l6.253" class="difflineminus">-    - * onTabClosing(aTab): Called when a tab is being closed.  This method is</span>
<a href="#l6.254"></a><span id="l6.254" class="difflineminus">-    -     is invoked before the call to the tab mode's closeTab function.</span>
<a href="#l6.255"></a><span id="l6.255" class="difflineminus">-    - * onTabPersist(aTab): Return a JSON-representable object to persist for</span>
<a href="#l6.256"></a><span id="l6.256" class="difflineminus">-    -     the tab.  Return null if you do not have anything to persist.</span>
<a href="#l6.257"></a><span id="l6.257" class="difflineminus">-    - * onTabRestored(aTab, aState, aIsFirstTab): Called when a tab is being</span>
<a href="#l6.258"></a><span id="l6.258" class="difflineminus">-    -     restored and there is data previously persisted by the tab monitor.</span>
<a href="#l6.259"></a><span id="l6.259" class="difflineminus">-    -     This method is called instead of invoking onTabOpened.  This is done</span>
<a href="#l6.260"></a><span id="l6.260" class="difflineminus">-    -     because the restoreTab method (potentially) uses the tabmail openTab</span>
<a href="#l6.261"></a><span id="l6.261" class="difflineminus">-    -     API to effect restoration.  (Note: the first opened tab is special;</span>
<a href="#l6.262"></a><span id="l6.262" class="difflineminus">-    -     it will produce an onTabOpened notification potentially followed by</span>
<a href="#l6.263"></a><span id="l6.263" class="difflineminus">-    -     an onTabRestored notification.)</span>
<a href="#l6.264"></a><span id="l6.264" class="difflineminus">-    - Tab monitor code is also allowed to hook into the command processing</span>
<a href="#l6.265"></a><span id="l6.265" class="difflineminus">-    -  logic.  We support the standard supportsCommand/isCommandEnabled/</span>
<a href="#l6.266"></a><span id="l6.266" class="difflineminus">-    -  doCommand functions but with a twist to indicate when other tab monitors</span>
<a href="#l6.267"></a><span id="l6.267" class="difflineminus">-    -  and the actual tab itself should get a chance to process: supportsCommand</span>
<a href="#l6.268"></a><span id="l6.268" class="difflineminus">-    -  and isCommandEnabled should return null when they are not handling the</span>
<a href="#l6.269"></a><span id="l6.269" class="difflineminus">-    -  case.  doCommand should return true if it handled the case, null</span>
<a href="#l6.270"></a><span id="l6.270" class="difflineminus">-    -  otherwise.</span>
<a href="#l6.271"></a><span id="l6.271" class="difflineminus">-    --&gt;</span>
<a href="#l6.272"></a><span id="l6.272" class="difflineminus">-  &lt;binding id=&quot;tabmail&quot;&gt;</span>
<a href="#l6.273"></a><span id="l6.273" class="difflineminus">-    &lt;implementation implements=&quot;nsIController, nsIWebProgressListener, nsIWebProgressListener2&quot;&gt;</span>
<a href="#l6.274"></a><span id="l6.274" class="difflineminus">-      &lt;constructor&gt;</span>
<a href="#l6.275"></a><span id="l6.275" class="difflineminus">-        window.controllers.insertControllerAt(0, this);</span>
<a href="#l6.276"></a><span id="l6.276" class="difflineminus">-        this._restoringTabState = null;</span>
<a href="#l6.277"></a><span id="l6.277" class="difflineminus">-      &lt;/constructor&gt;</span>
<a href="#l6.278"></a><span id="l6.278" class="difflineminus">-      &lt;destructor&gt;</span>
<a href="#l6.279"></a><span id="l6.279" class="difflineminus">-        window.controllers.removeController(this);</span>
<a href="#l6.280"></a><span id="l6.280" class="difflineminus">-      &lt;/destructor&gt;</span>
<a href="#l6.281"></a><span id="l6.281" class="difflineminus">-      &lt;field name=&quot;tabbox&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l6.282"></a><span id="l6.282" class="difflineminus">-        this.getElementsByTagName(&quot;tabbox&quot;).item(0)</span>
<a href="#l6.283"></a><span id="l6.283" class="difflineminus">-      &lt;/field&gt;</span>
<a href="#l6.284"></a><span id="l6.284" class="difflineminus">-      &lt;field name=&quot;currentTabInfo&quot;&gt;</span>
<a href="#l6.285"></a><span id="l6.285" class="difflineminus">-        null</span>
<a href="#l6.286"></a><span id="l6.286" class="difflineminus">-      &lt;/field&gt;</span>
<a href="#l6.287"></a><span id="l6.287" class="difflineminus">-      &lt;!-- Temporary field that only has a non-null value during a call to</span>
<a href="#l6.288"></a><span id="l6.288" class="difflineminus">-           openTab, and whose value is the currentTabInfo of the tab that was</span>
<a href="#l6.289"></a><span id="l6.289" class="difflineminus">-           open when we received the call to openTab. --&gt;</span>
<a href="#l6.290"></a><span id="l6.290" class="difflineminus">-      &lt;field name=&quot;_mostRecentTabInfo&quot;&gt;</span>
<a href="#l6.291"></a><span id="l6.291" class="difflineminus">-        null</span>
<a href="#l6.292"></a><span id="l6.292" class="difflineminus">-      &lt;/field&gt;</span>
<a href="#l6.293"></a><span id="l6.293" class="difflineminus">-      &lt;field name=&quot;tabTypes&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l6.294"></a><span id="l6.294" class="difflineminus">-        ({})</span>
<a href="#l6.295"></a><span id="l6.295" class="difflineminus">-      &lt;/field&gt;</span>
<a href="#l6.296"></a><span id="l6.296" class="difflineminus">-      &lt;field name=&quot;tabModes&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l6.297"></a><span id="l6.297" class="difflineminus">-        ({})</span>
<a href="#l6.298"></a><span id="l6.298" class="difflineminus">-      &lt;/field&gt;</span>
<a href="#l6.299"></a><span id="l6.299" class="difflineminus">-      &lt;field name=&quot;defaultTabMode&quot;&gt;</span>
<a href="#l6.300"></a><span id="l6.300" class="difflineminus">-        null</span>
<a href="#l6.301"></a><span id="l6.301" class="difflineminus">-      &lt;/field&gt;</span>
<a href="#l6.302"></a><span id="l6.302" class="difflineminus">-      &lt;field name=&quot;tabInfo&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l6.303"></a><span id="l6.303" class="difflineminus">-        []</span>
<a href="#l6.304"></a><span id="l6.304" class="difflineminus">-      &lt;/field&gt;</span>
<a href="#l6.305"></a><span id="l6.305" class="difflineminus">-      &lt;field name=&quot;tabContainer&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l6.306"></a><span id="l6.306" class="difflineminus">-        document.getElementById(this.getAttribute(&quot;tabcontainer&quot;));</span>
<a href="#l6.307"></a><span id="l6.307" class="difflineminus">-      &lt;/field&gt;</span>
<a href="#l6.308"></a><span id="l6.308" class="difflineminus">-      &lt;field name=&quot;panelContainer&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l6.309"></a><span id="l6.309" class="difflineminus">-        document.getElementById(this.getAttribute(&quot;panelcontainer&quot;));</span>
<a href="#l6.310"></a><span id="l6.310" class="difflineminus">-      &lt;/field&gt;</span>
<a href="#l6.311"></a><span id="l6.311" class="difflineminus">-      &lt;field name=&quot;tabMonitors&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l6.312"></a><span id="l6.312" class="difflineminus">-        []</span>
<a href="#l6.313"></a><span id="l6.313" class="difflineminus">-      &lt;/field&gt;</span>
<a href="#l6.314"></a><span id="l6.314" class="difflineminus">-      &lt;field name=&quot;recentlyClosedTabs&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l6.315"></a><span id="l6.315" class="difflineminus">-        [];</span>
<a href="#l6.316"></a><span id="l6.316" class="difflineminus">-      &lt;/field&gt;</span>
<a href="#l6.317"></a><span id="l6.317" class="difflineminus">-      &lt;field name=&quot;mLastTabOpener&quot;&gt;</span>
<a href="#l6.318"></a><span id="l6.318" class="difflineminus">-        null</span>
<a href="#l6.319"></a><span id="l6.319" class="difflineminus">-      &lt;/field&gt;</span>
<a href="#l6.320"></a><span id="l6.320" class="difflineminus">-      &lt;field name=&quot;mTabsProgressListeners&quot;&gt;</span>
<a href="#l6.321"></a><span id="l6.321" class="difflineminus">-        new Set();</span>
<a href="#l6.322"></a><span id="l6.322" class="difflineminus">-      &lt;/field&gt;</span>
<a href="#l6.323"></a><span id="l6.323" class="difflineminus">-      &lt;field name=&quot;unrestoredTabs&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l6.324"></a><span id="l6.324" class="difflineminus">-        [];</span>
<a href="#l6.325"></a><span id="l6.325" class="difflineminus">-      &lt;/field&gt;</span>
<a href="#l6.326"></a><span id="l6.326" class="difflineminus">-      &lt;method name=&quot;createTooltip&quot;&gt;</span>
<a href="#l6.327"></a><span id="l6.327" class="difflineminus">-        &lt;parameter name=&quot;event&quot;/&gt;</span>
<a href="#l6.328"></a><span id="l6.328" class="difflineminus">-        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l6.329"></a><span id="l6.329" class="difflineminus">-          let tab = document.tooltipNode ? document.tooltipNode.closest(&quot;tab&quot;) : null;</span>
<a href="#l6.330"></a><span id="l6.330" class="difflineminus">-          if (!tab) {</span>
<a href="#l6.331"></a><span id="l6.331" class="difflineminus">-            event.preventDefault();</span>
<a href="#l6.332"></a><span id="l6.332" class="difflineminus">-            return;</span>
<a href="#l6.333"></a><span id="l6.333" class="difflineminus">-          }</span>
<a href="#l6.334"></a><span id="l6.334" class="difflineminus">-          event.stopPropagation();</span>
<a href="#l6.335"></a><span id="l6.335" class="difflineminus">-</span>
<a href="#l6.336"></a><span id="l6.336" class="difflineminus">-          if (tab.localName != &quot;tab&quot; || this.tabContainer.draggedTab) {</span>
<a href="#l6.337"></a><span id="l6.337" class="difflineminus">-            event.preventDefault();</span>
<a href="#l6.338"></a><span id="l6.338" class="difflineminus">-            return;</span>
<a href="#l6.339"></a><span id="l6.339" class="difflineminus">-          }</span>
<a href="#l6.340"></a><span id="l6.340" class="difflineminus">-          event.target.setAttribute(&quot;label&quot;, tab.mOverCloseButton ?</span>
<a href="#l6.341"></a><span id="l6.341" class="difflineminus">-                                             tab.firstChild.getAttribute(&quot;closetabtext&quot;) :</span>
<a href="#l6.342"></a><span id="l6.342" class="difflineminus">-                                             tab.getAttribute(&quot;label&quot;));</span>
<a href="#l6.343"></a><span id="l6.343" class="difflineminus">-</span>
<a href="#l6.344"></a><span id="l6.344" class="difflineminus">-          ]]&gt;</span>
<a href="#l6.345"></a><span id="l6.345" class="difflineminus">-        &lt;/body&gt;</span>
<a href="#l6.346"></a><span id="l6.346" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l6.347"></a><span id="l6.347" class="difflineminus">-      &lt;method name=&quot;registerTabType&quot;&gt;</span>
<a href="#l6.348"></a><span id="l6.348" class="difflineminus">-        &lt;parameter name=&quot;aTabType&quot;/&gt;</span>
<a href="#l6.349"></a><span id="l6.349" class="difflineminus">-        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l6.350"></a><span id="l6.350" class="difflineminus">-          if (aTabType.name in this.tabTypes)</span>
<a href="#l6.351"></a><span id="l6.351" class="difflineminus">-            return;</span>
<a href="#l6.352"></a><span id="l6.352" class="difflineminus">-</span>
<a href="#l6.353"></a><span id="l6.353" class="difflineminus">-          this.tabTypes[aTabType.name] = aTabType;</span>
<a href="#l6.354"></a><span id="l6.354" class="difflineminus">-          for (let [modeName, modeDetails] of Object.entries(aTabType.modes)) {</span>
<a href="#l6.355"></a><span id="l6.355" class="difflineminus">-            modeDetails.name = modeName;</span>
<a href="#l6.356"></a><span id="l6.356" class="difflineminus">-            modeDetails.tabType = aTabType;</span>
<a href="#l6.357"></a><span id="l6.357" class="difflineminus">-            modeDetails.tabs = [];</span>
<a href="#l6.358"></a><span id="l6.358" class="difflineminus">-            this.tabModes[modeName] = modeDetails;</span>
<a href="#l6.359"></a><span id="l6.359" class="difflineminus">-            if (modeDetails.isDefault)</span>
<a href="#l6.360"></a><span id="l6.360" class="difflineminus">-              this.defaultTabMode = modeDetails;</span>
<a href="#l6.361"></a><span id="l6.361" class="difflineminus">-          }</span>
<a href="#l6.362"></a><span id="l6.362" class="difflineminus">-          if (aTabType.panelId) {</span>
<a href="#l6.363"></a><span id="l6.363" class="difflineminus">-            aTabType.panel = document.getElementById(aTabType.panelId);</span>
<a href="#l6.364"></a><span id="l6.364" class="difflineminus">-          } else if (!aTabType.perTabPanel) {</span>
<a href="#l6.365"></a><span id="l6.365" class="difflineminus">-            throw new Error(&quot;Trying to register a tab type with neither panelId &quot; +</span>
<a href="#l6.366"></a><span id="l6.366" class="difflineminus">-                            &quot;nor perTabPanel attributes.&quot;);</span>
<a href="#l6.367"></a><span id="l6.367" class="difflineminus">-          }</span>
<a href="#l6.368"></a><span id="l6.368" class="difflineminus">-</span>
<a href="#l6.369"></a><span id="l6.369" class="difflineminus">-          setTimeout(() =&gt; {</span>
<a href="#l6.370"></a><span id="l6.370" class="difflineminus">-            for (let modeName of Object.keys(aTabType.modes)) {</span>
<a href="#l6.371"></a><span id="l6.371" class="difflineminus">-              for (let i = 0; i &lt; this.unrestoredTabs.length;) {</span>
<a href="#l6.372"></a><span id="l6.372" class="difflineminus">-                let state = this.unrestoredTabs[i];</span>
<a href="#l6.373"></a><span id="l6.373" class="difflineminus">-                if (state.mode == modeName) {</span>
<a href="#l6.374"></a><span id="l6.374" class="difflineminus">-                  this.restoreTab(state);</span>
<a href="#l6.375"></a><span id="l6.375" class="difflineminus">-                  this.unrestoredTabs.splice(i, 1);</span>
<a href="#l6.376"></a><span id="l6.376" class="difflineminus">-                } else {</span>
<a href="#l6.377"></a><span id="l6.377" class="difflineminus">-                  i++;</span>
<a href="#l6.378"></a><span id="l6.378" class="difflineminus">-                }</span>
<a href="#l6.379"></a><span id="l6.379" class="difflineminus">-              }</span>
<a href="#l6.380"></a><span id="l6.380" class="difflineminus">-            }</span>
<a href="#l6.381"></a><span id="l6.381" class="difflineminus">-          }, 0);</span>
<a href="#l6.382"></a><span id="l6.382" class="difflineminus">-        ]]&gt;&lt;/body&gt;</span>
<a href="#l6.383"></a><span id="l6.383" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l6.384"></a><span id="l6.384" class="difflineminus">-      &lt;method name=&quot;unregisterTabType&quot;&gt;</span>
<a href="#l6.385"></a><span id="l6.385" class="difflineminus">-        &lt;parameter name=&quot;aTabType&quot;/&gt;</span>
<a href="#l6.386"></a><span id="l6.386" class="difflineminus">-        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l6.387"></a><span id="l6.387" class="difflineminus">-          // we can skip if the tab type was never registered...</span>
<a href="#l6.388"></a><span id="l6.388" class="difflineminus">-          if (!(aTabType.name in this.tabTypes))</span>
<a href="#l6.389"></a><span id="l6.389" class="difflineminus">-             return;</span>
<a href="#l6.390"></a><span id="l6.390" class="difflineminus">-</span>
<a href="#l6.391"></a><span id="l6.391" class="difflineminus">-          // ... if the tab type is still in use, we can not remove it without</span>
<a href="#l6.392"></a><span id="l6.392" class="difflineminus">-          // breaking the UI. So we throw an exception.</span>
<a href="#l6.393"></a><span id="l6.393" class="difflineminus">-          for (let modeName of Object.keys(aTabType.modes))</span>
<a href="#l6.394"></a><span id="l6.394" class="difflineminus">-            if (this.tabModes[modeName].tabs.length)</span>
<a href="#l6.395"></a><span id="l6.395" class="difflineminus">-              throw new Error(&quot;Tab mode &quot; + modeName + &quot; still in use. Close tabs&quot;);</span>
<a href="#l6.396"></a><span id="l6.396" class="difflineminus">-</span>
<a href="#l6.397"></a><span id="l6.397" class="difflineminus">-          // ... finally get rid of the tab type</span>
<a href="#l6.398"></a><span id="l6.398" class="difflineminus">-          for (let modeName of Object.keys(aTabType.modes))</span>
<a href="#l6.399"></a><span id="l6.399" class="difflineminus">-            delete this.tabModes[modeName];</span>
<a href="#l6.400"></a><span id="l6.400" class="difflineminus">-</span>
<a href="#l6.401"></a><span id="l6.401" class="difflineminus">-          delete this.tabTypes[aTabType.name];</span>
<a href="#l6.402"></a><span id="l6.402" class="difflineminus">-        ]]&gt;&lt;/body&gt;</span>
<a href="#l6.403"></a><span id="l6.403" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l6.404"></a><span id="l6.404" class="difflineminus">-      &lt;method name=&quot;registerTabMonitor&quot;&gt;</span>
<a href="#l6.405"></a><span id="l6.405" class="difflineminus">-        &lt;parameter name=&quot;aTabMonitor&quot;/&gt;</span>
<a href="#l6.406"></a><span id="l6.406" class="difflineminus">-        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l6.407"></a><span id="l6.407" class="difflineminus">-          if (!this.tabMonitors.includes(aTabMonitor))</span>
<a href="#l6.408"></a><span id="l6.408" class="difflineminus">-            this.tabMonitors.push(aTabMonitor);</span>
<a href="#l6.409"></a><span id="l6.409" class="difflineminus">-        ]]&gt;&lt;/body&gt;</span>
<a href="#l6.410"></a><span id="l6.410" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l6.411"></a><span id="l6.411" class="difflineminus">-      &lt;method name=&quot;unregisterTabMonitor&quot;&gt;</span>
<a href="#l6.412"></a><span id="l6.412" class="difflineminus">-        &lt;parameter name=&quot;aTabMonitor&quot;/&gt;</span>
<a href="#l6.413"></a><span id="l6.413" class="difflineminus">-        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l6.414"></a><span id="l6.414" class="difflineminus">-          if (this.tabMonitors.includes(aTabMonitor))</span>
<a href="#l6.415"></a><span id="l6.415" class="difflineminus">-            this.tabMonitors.splice(this.tabMonitors.indexOf(aTabMonitor), 1);</span>
<a href="#l6.416"></a><span id="l6.416" class="difflineminus">-        ]]&gt;&lt;/body&gt;</span>
<a href="#l6.417"></a><span id="l6.417" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l6.418"></a><span id="l6.418" class="difflineminus">-      &lt;!-- Given an index, tab node or tab info object, return a tuple of</span>
<a href="#l6.419"></a><span id="l6.419" class="difflineminus">-           [iTab, tab info dictionary, tab DOM node].  If</span>
<a href="#l6.420"></a><span id="l6.420" class="difflineminus">-           aTabIndexNodeOrInfo is not specified and aDefaultToCurrent is</span>
<a href="#l6.421"></a><span id="l6.421" class="difflineminus">-           true, the current tab will be returned.  Otherwise, an</span>
<a href="#l6.422"></a><span id="l6.422" class="difflineminus">-           exception will be thrown.</span>
<a href="#l6.423"></a><span id="l6.423" class="difflineminus">-        --&gt;</span>
<a href="#l6.424"></a><span id="l6.424" class="difflineminus">-      &lt;method name=&quot;_getTabContextForTabbyThing&quot;&gt;</span>
<a href="#l6.425"></a><span id="l6.425" class="difflineminus">-        &lt;parameter name=&quot;aTabIndexNodeOrInfo&quot;/&gt;</span>
<a href="#l6.426"></a><span id="l6.426" class="difflineminus">-        &lt;parameter name=&quot;aDefaultToCurrent&quot;/&gt;</span>
<a href="#l6.427"></a><span id="l6.427" class="difflineminus">-        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l6.428"></a><span id="l6.428" class="difflineminus">-          let iTab, tab, tabNode;</span>
<a href="#l6.429"></a><span id="l6.429" class="difflineminus">-          if (aTabIndexNodeOrInfo == null) {</span>
<a href="#l6.430"></a><span id="l6.430" class="difflineminus">-            if (!aDefaultToCurrent)</span>
<a href="#l6.431"></a><span id="l6.431" class="difflineminus">-              throw new Error(&quot;You need to specify a tab!&quot;);</span>
<a href="#l6.432"></a><span id="l6.432" class="difflineminus">-            iTab = this.tabContainer.selectedIndex;</span>
<a href="#l6.433"></a><span id="l6.433" class="difflineminus">-            return [iTab, this.tabInfo[iTab],</span>
<a href="#l6.434"></a><span id="l6.434" class="difflineminus">-                    this.tabContainer.allTabs[iTab]];</span>
<a href="#l6.435"></a><span id="l6.435" class="difflineminus">-          }</span>
<a href="#l6.436"></a><span id="l6.436" class="difflineminus">-</span>
<a href="#l6.437"></a><span id="l6.437" class="difflineminus">-          if (typeof(aTabIndexNodeOrInfo) == &quot;number&quot;) {</span>
<a href="#l6.438"></a><span id="l6.438" class="difflineminus">-            iTab = aTabIndexNodeOrInfo;</span>
<a href="#l6.439"></a><span id="l6.439" class="difflineminus">-            tabNode = this.tabContainer.allTabs[iTab];</span>
<a href="#l6.440"></a><span id="l6.440" class="difflineminus">-            tab = this.tabInfo[iTab];</span>
<a href="#l6.441"></a><span id="l6.441" class="difflineminus">-          } else if (aTabIndexNodeOrInfo.tagName &amp;&amp; aTabIndexNodeOrInfo.tagName == &quot;tab&quot;) {</span>
<a href="#l6.442"></a><span id="l6.442" class="difflineminus">-            tabNode = aTabIndexNodeOrInfo;</span>
<a href="#l6.443"></a><span id="l6.443" class="difflineminus">-            iTab = this.tabContainer.getIndexOfItem(tabNode);</span>
<a href="#l6.444"></a><span id="l6.444" class="difflineminus">-            tab = this.tabInfo[iTab];</span>
<a href="#l6.445"></a><span id="l6.445" class="difflineminus">-          } else {</span>
<a href="#l6.446"></a><span id="l6.446" class="difflineminus">-            tab = aTabIndexNodeOrInfo;</span>
<a href="#l6.447"></a><span id="l6.447" class="difflineminus">-            iTab = this.tabInfo.indexOf(tab);</span>
<a href="#l6.448"></a><span id="l6.448" class="difflineminus">-            tabNode = (iTab &gt;= 0) ? this.tabContainer.allTabs[iTab] : null;</span>
<a href="#l6.449"></a><span id="l6.449" class="difflineminus">-          }</span>
<a href="#l6.450"></a><span id="l6.450" class="difflineminus">-</span>
<a href="#l6.451"></a><span id="l6.451" class="difflineminus">-          return [iTab, tab, tabNode];</span>
<a href="#l6.452"></a><span id="l6.452" class="difflineminus">-        ]]&gt;&lt;/body&gt;</span>
<a href="#l6.453"></a><span id="l6.453" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l6.454"></a><span id="l6.454" class="difflineminus">-      &lt;method name=&quot;openFirstTab&quot;&gt;</span>
<a href="#l6.455"></a><span id="l6.455" class="difflineminus">-        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l6.456"></a><span id="l6.456" class="difflineminus">-          // From the moment of creation, our XBL binding already has a visible</span>
<a href="#l6.457"></a><span id="l6.457" class="difflineminus">-          //  tab.  We need to create a tab information structure for this tab.</span>
<a href="#l6.458"></a><span id="l6.458" class="difflineminus">-          //  In the process we also generate a synthetic tab title changed</span>
<a href="#l6.459"></a><span id="l6.459" class="difflineminus">-          //  event to ensure we have an accurate title.  We assume the tab</span>
<a href="#l6.460"></a><span id="l6.460" class="difflineminus">-          //  contents will set themselves up correctly.</span>
<a href="#l6.461"></a><span id="l6.461" class="difflineminus">-          if (this.tabInfo.length == 0) {</span>
<a href="#l6.462"></a><span id="l6.462" class="difflineminus">-            let firstTab = {</span>
<a href="#l6.463"></a><span id="l6.463" class="difflineminus">-              mode: this.defaultTabMode,</span>
<a href="#l6.464"></a><span id="l6.464" class="difflineminus">-              busy: false,</span>
<a href="#l6.465"></a><span id="l6.465" class="difflineminus">-              canClose: false,</span>
<a href="#l6.466"></a><span id="l6.466" class="difflineminus">-              thinking: false,</span>
<a href="#l6.467"></a><span id="l6.467" class="difflineminus">-              _ext: {},</span>
<a href="#l6.468"></a><span id="l6.468" class="difflineminus">-              get linkedBrowser() {</span>
<a href="#l6.469"></a><span id="l6.469" class="difflineminus">-                // This is a hack to make Marionette work. It needs a linkedBrowser</span>
<a href="#l6.470"></a><span id="l6.470" class="difflineminus">-                // from the first tab before it will start. Because linkedBrowser is</span>
<a href="#l6.471"></a><span id="l6.471" class="difflineminus">-                // implemented as a getter, it's ignored by anything that</span>
<a href="#l6.472"></a><span id="l6.472" class="difflineminus">-                // JSON-serializes this tab.</span>
<a href="#l6.473"></a><span id="l6.473" class="difflineminus">-                let browserFunc = this.mode.getBrowser || this.mode.tabType.getBrowser;</span>
<a href="#l6.474"></a><span id="l6.474" class="difflineminus">-                let browser = browserFunc ? browserFunc.call(this.mode.tabType, this) : null;</span>
<a href="#l6.475"></a><span id="l6.475" class="difflineminus">-</span>
<a href="#l6.476"></a><span id="l6.476" class="difflineminus">-                if (browser &amp;&amp; !(&quot;permanentKey&quot; in browser)) {</span>
<a href="#l6.477"></a><span id="l6.477" class="difflineminus">-                  // The permanentKey property is a unique Object, thus allowing this</span>
<a href="#l6.478"></a><span id="l6.478" class="difflineminus">-                  // browser to be stored in a WeakMap.</span>
<a href="#l6.479"></a><span id="l6.479" class="difflineminus">-                  // Use the JSM global to create the permanentKey, so that if the</span>
<a href="#l6.480"></a><span id="l6.480" class="difflineminus">-                  // permanentKey is held by something after this window closes, it</span>
<a href="#l6.481"></a><span id="l6.481" class="difflineminus">-                  // doesn't keep the window alive.</span>
<a href="#l6.482"></a><span id="l6.482" class="difflineminus">-                  browser.permanentKey = new (Cu.getGlobalForObject(Services).Object);</span>
<a href="#l6.483"></a><span id="l6.483" class="difflineminus">-                }</span>
<a href="#l6.484"></a><span id="l6.484" class="difflineminus">-</span>
<a href="#l6.485"></a><span id="l6.485" class="difflineminus">-                return browser;</span>
<a href="#l6.486"></a><span id="l6.486" class="difflineminus">-              },</span>
<a href="#l6.487"></a><span id="l6.487" class="difflineminus">-            };</span>
<a href="#l6.488"></a><span id="l6.488" class="difflineminus">-            firstTab.mode.tabs.push(firstTab);</span>
<a href="#l6.489"></a><span id="l6.489" class="difflineminus">-</span>
<a href="#l6.490"></a><span id="l6.490" class="difflineminus">-            this.tabInfo[0] = this.currentTabInfo = firstTab;</span>
<a href="#l6.491"></a><span id="l6.491" class="difflineminus">-</span>
<a href="#l6.492"></a><span id="l6.492" class="difflineminus">-            let tabOpenFirstFunc = firstTab.mode.openFirstTab ||</span>
<a href="#l6.493"></a><span id="l6.493" class="difflineminus">-                                   firstTab.mode.tabType.openFirstTab;</span>
<a href="#l6.494"></a><span id="l6.494" class="difflineminus">-            tabOpenFirstFunc.call(firstTab.mode.tabType, firstTab);</span>
<a href="#l6.495"></a><span id="l6.495" class="difflineminus">-            this.setTabTitle(null);</span>
<a href="#l6.496"></a><span id="l6.496" class="difflineminus">-</span>
<a href="#l6.497"></a><span id="l6.497" class="difflineminus">-            for (let tabMonitor of this.tabMonitors) {</span>
<a href="#l6.498"></a><span id="l6.498" class="difflineminus">-              if (&quot;onTabOpened&quot; in tabMonitor)</span>
<a href="#l6.499"></a><span id="l6.499" class="difflineminus">-                tabMonitor.onTabOpened(firstTab, true);</span>
<a href="#l6.500"></a><span id="l6.500" class="difflineminus">-              tabMonitor.onTabSwitched(firstTab, null);</span>
<a href="#l6.501"></a><span id="l6.501" class="difflineminus">-            }</span>
<a href="#l6.502"></a><span id="l6.502" class="difflineminus">-          }</span>
<a href="#l6.503"></a><span id="l6.503" class="difflineminus">-        ]]&gt;&lt;/body&gt;</span>
<a href="#l6.504"></a><span id="l6.504" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l6.505"></a><span id="l6.505" class="difflineminus">-      &lt;method name=&quot;openTab&quot;&gt;</span>
<a href="#l6.506"></a><span id="l6.506" class="difflineminus">-        &lt;parameter name=&quot;aTabModeName&quot;/&gt;</span>
<a href="#l6.507"></a><span id="l6.507" class="difflineminus">-        &lt;parameter name=&quot;aArgs&quot;/&gt;</span>
<a href="#l6.508"></a><span id="l6.508" class="difflineminus">-        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l6.509"></a><span id="l6.509" class="difflineminus">-        try {</span>
<a href="#l6.510"></a><span id="l6.510" class="difflineminus">-          if (!(aTabModeName in this.tabModes))</span>
<a href="#l6.511"></a><span id="l6.511" class="difflineminus">-            throw new Error(&quot;No such tab mode: &quot; + aTabModeName);</span>
<a href="#l6.512"></a><span id="l6.512" class="difflineminus">-          let tabMode = this.tabModes[aTabModeName];</span>
<a href="#l6.513"></a><span id="l6.513" class="difflineminus">-          // if we are already at our limit for this mode, show an existing one</span>
<a href="#l6.514"></a><span id="l6.514" class="difflineminus">-          if (tabMode.tabs.length == tabMode.maxTabs) {</span>
<a href="#l6.515"></a><span id="l6.515" class="difflineminus">-            let desiredTab = tabMode.tabs[0];</span>
<a href="#l6.516"></a><span id="l6.516" class="difflineminus">-            this.tabContainer.selectedIndex = this.tabInfo.indexOf(desiredTab);</span>
<a href="#l6.517"></a><span id="l6.517" class="difflineminus">-            return null;</span>
<a href="#l6.518"></a><span id="l6.518" class="difflineminus">-          }</span>
<a href="#l6.519"></a><span id="l6.519" class="difflineminus">-</span>
<a href="#l6.520"></a><span id="l6.520" class="difflineminus">-          // For &quot;glodaFacet&quot; tab mode, if aArgs is omitted,</span>
<a href="#l6.521"></a><span id="l6.521" class="difflineminus">-          // default to a blank user search.</span>
<a href="#l6.522"></a><span id="l6.522" class="difflineminus">-          if (aTabModeName == &quot;glodaFacet&quot; &amp;&amp; !aArgs) {</span>
<a href="#l6.523"></a><span id="l6.523" class="difflineminus">-            aArgs = { searcher: new GlodaMsgSearcher(null, &quot;&quot;) };</span>
<a href="#l6.524"></a><span id="l6.524" class="difflineminus">-          }</span>
<a href="#l6.525"></a><span id="l6.525" class="difflineminus">-</span>
<a href="#l6.526"></a><span id="l6.526" class="difflineminus">-          // Do this so that we don't generate strict warnings</span>
<a href="#l6.527"></a><span id="l6.527" class="difflineminus">-          let background = (&quot;background&quot; in aArgs) &amp;&amp; aArgs.background;</span>
<a href="#l6.528"></a><span id="l6.528" class="difflineminus">-</span>
<a href="#l6.529"></a><span id="l6.529" class="difflineminus">-          // If the mode wants us to, we should switch to an existing tab</span>
<a href="#l6.530"></a><span id="l6.530" class="difflineminus">-          // rather than open a new one. We shouldn't switch to the tab if</span>
<a href="#l6.531"></a><span id="l6.531" class="difflineminus">-          // we're opening it in the background, though.</span>
<a href="#l6.532"></a><span id="l6.532" class="difflineminus">-          let shouldSwitchToFunc = tabMode.shouldSwitchTo ||</span>
<a href="#l6.533"></a><span id="l6.533" class="difflineminus">-                                   tabMode.tabType.shouldSwitchTo;</span>
<a href="#l6.534"></a><span id="l6.534" class="difflineminus">-</span>
<a href="#l6.535"></a><span id="l6.535" class="difflineminus">-          if (shouldSwitchToFunc) {</span>
<a href="#l6.536"></a><span id="l6.536" class="difflineminus">-            let tabIndex = shouldSwitchToFunc.apply(tabMode.tabType, [aArgs]);</span>
<a href="#l6.537"></a><span id="l6.537" class="difflineminus">-            if (tabIndex &gt;= 0) {</span>
<a href="#l6.538"></a><span id="l6.538" class="difflineminus">-              if (!background)</span>
<a href="#l6.539"></a><span id="l6.539" class="difflineminus">-                this.selectTabByIndex(null, tabIndex);</span>
<a href="#l6.540"></a><span id="l6.540" class="difflineminus">-              return null;</span>
<a href="#l6.541"></a><span id="l6.541" class="difflineminus">-            }</span>
<a href="#l6.542"></a><span id="l6.542" class="difflineminus">-          }</span>
<a href="#l6.543"></a><span id="l6.543" class="difflineminus">-</span>
<a href="#l6.544"></a><span id="l6.544" class="difflineminus">-          if (!background)</span>
<a href="#l6.545"></a><span id="l6.545" class="difflineminus">-            // we need to save the state before it gets corrupted</span>
<a href="#l6.546"></a><span id="l6.546" class="difflineminus">-            this.saveCurrentTabState();</span>
<a href="#l6.547"></a><span id="l6.547" class="difflineminus">-</span>
<a href="#l6.548"></a><span id="l6.548" class="difflineminus">-          let tab = {mode: tabMode, busy: false, canClose: true,</span>
<a href="#l6.549"></a><span id="l6.549" class="difflineminus">-                     thinking: false, beforeTabOpen: true, _ext: {}};</span>
<a href="#l6.550"></a><span id="l6.550" class="difflineminus">-          tabMode.tabs.push(tab);</span>
<a href="#l6.551"></a><span id="l6.551" class="difflineminus">-</span>
<a href="#l6.552"></a><span id="l6.552" class="difflineminus">-          var t = document.createXULElement(&quot;tab&quot;, { is: &quot;tabmail-tab&quot; });</span>
<a href="#l6.553"></a><span id="l6.553" class="difflineminus">-          tab.tabNode = t;</span>
<a href="#l6.554"></a><span id="l6.554" class="difflineminus">-          t.maxWidth = this.tabContainer.mTabMaxWidth;</span>
<a href="#l6.555"></a><span id="l6.555" class="difflineminus">-          t.minWidth = this.tabContainer.mTabMinWidth;</span>
<a href="#l6.556"></a><span id="l6.556" class="difflineminus">-          t.width = 0;</span>
<a href="#l6.557"></a><span id="l6.557" class="difflineminus">-          t.setAttribute(&quot;flex&quot;, &quot;100&quot;);</span>
<a href="#l6.558"></a><span id="l6.558" class="difflineminus">-          t.setAttribute(&quot;validate&quot;, &quot;never&quot;);</span>
<a href="#l6.559"></a><span id="l6.559" class="difflineminus">-          t.className = &quot;tabmail-tab&quot;;</span>
<a href="#l6.560"></a><span id="l6.560" class="difflineminus">-          this.tabContainer.appendChild(t);</span>
<a href="#l6.561"></a><span id="l6.561" class="difflineminus">-          if (this.tabContainer.mCollapseToolbar.collapsed) {</span>
<a href="#l6.562"></a><span id="l6.562" class="difflineminus">-            this.tabContainer.mCollapseToolbar.collapsed = false;</span>
<a href="#l6.563"></a><span id="l6.563" class="difflineminus">-            this.tabContainer._updateCloseButtons();</span>
<a href="#l6.564"></a><span id="l6.564" class="difflineminus">-          }</span>
<a href="#l6.565"></a><span id="l6.565" class="difflineminus">-</span>
<a href="#l6.566"></a><span id="l6.566" class="difflineminus">-          let oldTab = this._mostRecentTabInfo = this.currentTabInfo;</span>
<a href="#l6.567"></a><span id="l6.567" class="difflineminus">-</span>
<a href="#l6.568"></a><span id="l6.568" class="difflineminus">-          let disregardOpener = (&quot;disregardOpener&quot; in aArgs)</span>
<a href="#l6.569"></a><span id="l6.569" class="difflineminus">-                                &amp;&amp; aArgs.disregardOpener;</span>
<a href="#l6.570"></a><span id="l6.570" class="difflineminus">-</span>
<a href="#l6.571"></a><span id="l6.571" class="difflineminus">-          // If we're not disregarding the opening, hold a reference to opener</span>
<a href="#l6.572"></a><span id="l6.572" class="difflineminus">-          // so that if the new tab is closed without switching, we can switch</span>
<a href="#l6.573"></a><span id="l6.573" class="difflineminus">-          // back to the opener tab.</span>
<a href="#l6.574"></a><span id="l6.574" class="difflineminus">-          if (disregardOpener)</span>
<a href="#l6.575"></a><span id="l6.575" class="difflineminus">-            this.mLastTabOpener = null;</span>
<a href="#l6.576"></a><span id="l6.576" class="difflineminus">-          else</span>
<a href="#l6.577"></a><span id="l6.577" class="difflineminus">-            this.mLastTabOpener = oldTab;</span>
<a href="#l6.578"></a><span id="l6.578" class="difflineminus">-</span>
<a href="#l6.579"></a><span id="l6.579" class="difflineminus">-          // the order of the following statements is important</span>
<a href="#l6.580"></a><span id="l6.580" class="difflineminus">-          this.tabInfo[this.tabContainer.allTabs.length - 1] = tab;</span>
<a href="#l6.581"></a><span id="l6.581" class="difflineminus">-          if (!background) {</span>
<a href="#l6.582"></a><span id="l6.582" class="difflineminus">-            this.currentTabInfo = tab;</span>
<a href="#l6.583"></a><span id="l6.583" class="difflineminus">-            // this has a side effect of calling updateCurrentTab, but our</span>
<a href="#l6.584"></a><span id="l6.584" class="difflineminus">-            //  setting currentTabInfo above will cause it to take no action.</span>
<a href="#l6.585"></a><span id="l6.585" class="difflineminus">-            this.tabContainer.selectedIndex =</span>
<a href="#l6.586"></a><span id="l6.586" class="difflineminus">-              this.tabContainer.allTabs.length - 1;</span>
<a href="#l6.587"></a><span id="l6.587" class="difflineminus">-          }</span>
<a href="#l6.588"></a><span id="l6.588" class="difflineminus">-</span>
<a href="#l6.589"></a><span id="l6.589" class="difflineminus">-          // make sure we are on the right panel</span>
<a href="#l6.590"></a><span id="l6.590" class="difflineminus">-          if (tab.mode.tabType.perTabPanel) {</span>
<a href="#l6.591"></a><span id="l6.591" class="difflineminus">-            // should we create the element for them, or will they do it?</span>
<a href="#l6.592"></a><span id="l6.592" class="difflineminus">-            if (typeof(tab.mode.tabType.perTabPanel) == &quot;string&quot;) {</span>
<a href="#l6.593"></a><span id="l6.593" class="difflineminus">-              tab.panel = document.createXULElement(tab.mode.tabType.perTabPanel);</span>
<a href="#l6.594"></a><span id="l6.594" class="difflineminus">-            } else {</span>
<a href="#l6.595"></a><span id="l6.595" class="difflineminus">-              tab.panel = tab.mode.tabType.perTabPanel(tab);</span>
<a href="#l6.596"></a><span id="l6.596" class="difflineminus">-            }</span>
<a href="#l6.597"></a><span id="l6.597" class="difflineminus">-            this.panelContainer.appendChild(tab.panel);</span>
<a href="#l6.598"></a><span id="l6.598" class="difflineminus">-            if (!background) {</span>
<a href="#l6.599"></a><span id="l6.599" class="difflineminus">-              this.panelContainer.selectedPanel = tab.panel;</span>
<a href="#l6.600"></a><span id="l6.600" class="difflineminus">-            }</span>
<a href="#l6.601"></a><span id="l6.601" class="difflineminus">-          } else {</span>
<a href="#l6.602"></a><span id="l6.602" class="difflineminus">-            if (!background) {</span>
<a href="#l6.603"></a><span id="l6.603" class="difflineminus">-              this.panelContainer.selectedPanel = tab.mode.tabType.panel;</span>
<a href="#l6.604"></a><span id="l6.604" class="difflineminus">-            }</span>
<a href="#l6.605"></a><span id="l6.605" class="difflineminus">-            t.linkedPanel = tab.mode.tabType.panelId;</span>
<a href="#l6.606"></a><span id="l6.606" class="difflineminus">-          }</span>
<a href="#l6.607"></a><span id="l6.607" class="difflineminus">-</span>
<a href="#l6.608"></a><span id="l6.608" class="difflineminus">-          // Make sure the new panel is marked selected.</span>
<a href="#l6.609"></a><span id="l6.609" class="difflineminus">-          let oldPanel = [...this.panelContainer.children].find(p =&gt; p.hasAttribute(&quot;selected&quot;));</span>
<a href="#l6.610"></a><span id="l6.610" class="difflineminus">-          if (oldPanel) {</span>
<a href="#l6.611"></a><span id="l6.611" class="difflineminus">-            oldPanel.removeAttribute(&quot;selected&quot;);</span>
<a href="#l6.612"></a><span id="l6.612" class="difflineminus">-          }</span>
<a href="#l6.613"></a><span id="l6.613" class="difflineminus">-          this.panelContainer.selectedPanel.setAttribute(&quot;selected&quot;, &quot;true&quot;);</span>
<a href="#l6.614"></a><span id="l6.614" class="difflineminus">-</span>
<a href="#l6.615"></a><span id="l6.615" class="difflineminus">-          let tabOpenFunc = tab.mode.openTab || tab.mode.tabType.openTab;</span>
<a href="#l6.616"></a><span id="l6.616" class="difflineminus">-          tabOpenFunc.apply(tab.mode.tabType, [tab, aArgs]);</span>
<a href="#l6.617"></a><span id="l6.617" class="difflineminus">-          if (!t.linkedPanel) {</span>
<a href="#l6.618"></a><span id="l6.618" class="difflineminus">-            if (!tab.panel.id) {</span>
<a href="#l6.619"></a><span id="l6.619" class="difflineminus">-              // No id set. Create our own.</span>
<a href="#l6.620"></a><span id="l6.620" class="difflineminus">-              tab.panel.id = &quot;unnamedTab&quot; + Math.random().toString().substring(2);</span>
<a href="#l6.621"></a><span id="l6.621" class="difflineminus">-              console.warn(`Tab mode ${aTabModeName} should set an id on the first argument of openTab.`);</span>
<a href="#l6.622"></a><span id="l6.622" class="difflineminus">-            }</span>
<a href="#l6.623"></a><span id="l6.623" class="difflineminus">-            t.linkedPanel = tab.panel.id;</span>
<a href="#l6.624"></a><span id="l6.624" class="difflineminus">-          }</span>
<a href="#l6.625"></a><span id="l6.625" class="difflineminus">-</span>
<a href="#l6.626"></a><span id="l6.626" class="difflineminus">-          let restoreState = this._restoringTabState;</span>
<a href="#l6.627"></a><span id="l6.627" class="difflineminus">-          for (let tabMonitor of this.tabMonitors) {</span>
<a href="#l6.628"></a><span id="l6.628" class="difflineminus">-            if ((&quot;onTabRestored&quot; in tabMonitor) &amp;&amp; restoreState &amp;&amp;</span>
<a href="#l6.629"></a><span id="l6.629" class="difflineminus">-                (tabMonitor.monitorName in restoreState.ext))</span>
<a href="#l6.630"></a><span id="l6.630" class="difflineminus">-              tabMonitor.onTabRestored(tab,</span>
<a href="#l6.631"></a><span id="l6.631" class="difflineminus">-                                       restoreState.ext[tabMonitor.monitorName],</span>
<a href="#l6.632"></a><span id="l6.632" class="difflineminus">-                                       false);</span>
<a href="#l6.633"></a><span id="l6.633" class="difflineminus">-            else if (&quot;onTabOpened&quot; in tabMonitor)</span>
<a href="#l6.634"></a><span id="l6.634" class="difflineminus">-              tabMonitor.onTabOpened(tab, false, oldTab);</span>
<a href="#l6.635"></a><span id="l6.635" class="difflineminus">-            if (!background)</span>
<a href="#l6.636"></a><span id="l6.636" class="difflineminus">-              tabMonitor.onTabSwitched(tab, oldTab);</span>
<a href="#l6.637"></a><span id="l6.637" class="difflineminus">-          }</span>
<a href="#l6.638"></a><span id="l6.638" class="difflineminus">-</span>
<a href="#l6.639"></a><span id="l6.639" class="difflineminus">-          // clear _mostRecentTabInfo; we only needed it during the call to</span>
<a href="#l6.640"></a><span id="l6.640" class="difflineminus">-          //  openTab.</span>
<a href="#l6.641"></a><span id="l6.641" class="difflineminus">-          this._mostRecentTabInfo = null;</span>
<a href="#l6.642"></a><span id="l6.642" class="difflineminus">-</span>
<a href="#l6.643"></a><span id="l6.643" class="difflineminus">-          t.setAttribute(&quot;label&quot;, tab.title);</span>
<a href="#l6.644"></a><span id="l6.644" class="difflineminus">-</span>
<a href="#l6.645"></a><span id="l6.645" class="difflineminus">-          if (!background)</span>
<a href="#l6.646"></a><span id="l6.646" class="difflineminus">-            this.setDocumentTitle(tab);</span>
<a href="#l6.647"></a><span id="l6.647" class="difflineminus">-</span>
<a href="#l6.648"></a><span id="l6.648" class="difflineminus">-          // for styling purposes, apply the type to the tab...</span>
<a href="#l6.649"></a><span id="l6.649" class="difflineminus">-          t.setAttribute(&quot;type&quot;, tab.mode.type);</span>
<a href="#l6.650"></a><span id="l6.650" class="difflineminus">-</span>
<a href="#l6.651"></a><span id="l6.651" class="difflineminus">-          if (!background)</span>
<a href="#l6.652"></a><span id="l6.652" class="difflineminus">-            // Update the toolbar status - we don't need to do menus as they</span>
<a href="#l6.653"></a><span id="l6.653" class="difflineminus">-            // do themselves when we open them.</span>
<a href="#l6.654"></a><span id="l6.654" class="difflineminus">-            UpdateMailToolbar(&quot;tabmail&quot;);</span>
<a href="#l6.655"></a><span id="l6.655" class="difflineminus">-</span>
<a href="#l6.656"></a><span id="l6.656" class="difflineminus">-          let moving = restoreState ? restoreState.moving : null;</span>
<a href="#l6.657"></a><span id="l6.657" class="difflineminus">-</span>
<a href="#l6.658"></a><span id="l6.658" class="difflineminus">-          // Dispatch tab opening event</span>
<a href="#l6.659"></a><span id="l6.659" class="difflineminus">-          let evt = new CustomEvent(&quot;TabOpen&quot;, { bubbles: true, detail: { tabInfo: tab, moving } });</span>
<a href="#l6.660"></a><span id="l6.660" class="difflineminus">-          t.dispatchEvent(evt);</span>
<a href="#l6.661"></a><span id="l6.661" class="difflineminus">-          delete tab.beforeTabOpen;</span>
<a href="#l6.662"></a><span id="l6.662" class="difflineminus">-</span>
<a href="#l6.663"></a><span id="l6.663" class="difflineminus">-          // Register browser progress listeners</span>
<a href="#l6.664"></a><span id="l6.664" class="difflineminus">-          let browser = this.getBrowserForTab(tab);</span>
<a href="#l6.665"></a><span id="l6.665" class="difflineminus">-          if (browser &amp;&amp; !browser._progressListenerAdded) {</span>
<a href="#l6.666"></a><span id="l6.666" class="difflineminus">-            // It would probably be better to have the tabs register this listener, since the</span>
<a href="#l6.667"></a><span id="l6.667" class="difflineminus">-            // browser can change. This wasn't trivial to do while implementing basic WebExtension</span>
<a href="#l6.668"></a><span id="l6.668" class="difflineminus">-            // support, so let's assume one browser only for now.</span>
<a href="#l6.669"></a><span id="l6.669" class="difflineminus">-            browser.webProgress.addProgressListener(this, Ci.nsIWebProgress.NOTIFY_ALL);</span>
<a href="#l6.670"></a><span id="l6.670" class="difflineminus">-            browser._progressListenerAdded = true;</span>
<a href="#l6.671"></a><span id="l6.671" class="difflineminus">-          }</span>
<a href="#l6.672"></a><span id="l6.672" class="difflineminus">-</span>
<a href="#l6.673"></a><span id="l6.673" class="difflineminus">-          return tab;</span>
<a href="#l6.674"></a><span id="l6.674" class="difflineminus">-        } catch (e) {</span>
<a href="#l6.675"></a><span id="l6.675" class="difflineminus">-          logException(e);</span>
<a href="#l6.676"></a><span id="l6.676" class="difflineminus">-          return null;</span>
<a href="#l6.677"></a><span id="l6.677" class="difflineminus">-        }</span>
<a href="#l6.678"></a><span id="l6.678" class="difflineminus">-        ]]&gt;&lt;/body&gt;</span>
<a href="#l6.679"></a><span id="l6.679" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l6.680"></a><span id="l6.680" class="difflineminus">-      &lt;method name=&quot;selectTabByMode&quot;&gt;</span>
<a href="#l6.681"></a><span id="l6.681" class="difflineminus">-        &lt;parameter name=&quot;aTabModeName&quot;/&gt;</span>
<a href="#l6.682"></a><span id="l6.682" class="difflineminus">-        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l6.683"></a><span id="l6.683" class="difflineminus">-          let tabMode = this.tabModes[aTabModeName];</span>
<a href="#l6.684"></a><span id="l6.684" class="difflineminus">-          if (tabMode.tabs.length) {</span>
<a href="#l6.685"></a><span id="l6.685" class="difflineminus">-            let desiredTab = tabMode.tabs[0];</span>
<a href="#l6.686"></a><span id="l6.686" class="difflineminus">-            this.tabContainer.selectedIndex = this.tabInfo.indexOf(desiredTab);</span>
<a href="#l6.687"></a><span id="l6.687" class="difflineminus">-          }</span>
<a href="#l6.688"></a><span id="l6.688" class="difflineminus">-        ]]&gt;&lt;/body&gt;</span>
<a href="#l6.689"></a><span id="l6.689" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l6.690"></a><span id="l6.690" class="difflineminus">-      &lt;method name=&quot;selectTabByIndex&quot;&gt;</span>
<a href="#l6.691"></a><span id="l6.691" class="difflineminus">-        &lt;parameter name=&quot;aEvent&quot;/&gt;</span>
<a href="#l6.692"></a><span id="l6.692" class="difflineminus">-        &lt;parameter name=&quot;aIndex&quot;/&gt;</span>
<a href="#l6.693"></a><span id="l6.693" class="difflineminus">-        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l6.694"></a><span id="l6.694" class="difflineminus">-          // count backwards for aIndex &lt; 0</span>
<a href="#l6.695"></a><span id="l6.695" class="difflineminus">-          if (aIndex &lt; 0)</span>
<a href="#l6.696"></a><span id="l6.696" class="difflineminus">-            aIndex += this.tabInfo.length;</span>
<a href="#l6.697"></a><span id="l6.697" class="difflineminus">-</span>
<a href="#l6.698"></a><span id="l6.698" class="difflineminus">-          if (aIndex &gt;= 0 &amp;&amp;</span>
<a href="#l6.699"></a><span id="l6.699" class="difflineminus">-              aIndex &lt; this.tabInfo.length &amp;&amp;</span>
<a href="#l6.700"></a><span id="l6.700" class="difflineminus">-              aIndex != this.tabContainer.selectedIndex) {</span>
<a href="#l6.701"></a><span id="l6.701" class="difflineminus">-            this.tabContainer.selectedIndex = aIndex;</span>
<a href="#l6.702"></a><span id="l6.702" class="difflineminus">-          }</span>
<a href="#l6.703"></a><span id="l6.703" class="difflineminus">-</span>
<a href="#l6.704"></a><span id="l6.704" class="difflineminus">-          if (aEvent) {</span>
<a href="#l6.705"></a><span id="l6.705" class="difflineminus">-            aEvent.preventDefault();</span>
<a href="#l6.706"></a><span id="l6.706" class="difflineminus">-            aEvent.stopPropagation();</span>
<a href="#l6.707"></a><span id="l6.707" class="difflineminus">-          }</span>
<a href="#l6.708"></a><span id="l6.708" class="difflineminus">-        ]]&gt;&lt;/body&gt;</span>
<a href="#l6.709"></a><span id="l6.709" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l6.710"></a><span id="l6.710" class="difflineminus">-      &lt;method name=&quot;getTabInfoForCurrentOrFirstModeInstance&quot;&gt;</span>
<a href="#l6.711"></a><span id="l6.711" class="difflineminus">-        &lt;parameter name=&quot;aTabMode&quot;/&gt;</span>
<a href="#l6.712"></a><span id="l6.712" class="difflineminus">-        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l6.713"></a><span id="l6.713" class="difflineminus">-        /**</span>
<a href="#l6.714"></a><span id="l6.714" class="difflineminus">-         * If the current/most recent tab is of mode aTabModeName, return its</span>
<a href="#l6.715"></a><span id="l6.715" class="difflineminus">-         *  tab info, otherwise return the tab info for the first tab of the</span>
<a href="#l6.716"></a><span id="l6.716" class="difflineminus">-         *  given mode.</span>
<a href="#l6.717"></a><span id="l6.717" class="difflineminus">-         * You would want to use this method when you would like to mimic the</span>
<a href="#l6.718"></a><span id="l6.718" class="difflineminus">-         *  settings of an existing instance of your mode.  In such a case,</span>
<a href="#l6.719"></a><span id="l6.719" class="difflineminus">-         *  it is reasonable to assume that if the 'current' tab was of the</span>
<a href="#l6.720"></a><span id="l6.720" class="difflineminus">-         *  same mode that its settings should be used.  Otherwise, we must</span>
<a href="#l6.721"></a><span id="l6.721" class="difflineminus">-         *  fall back to another tab.  We currently choose the first tab of</span>
<a href="#l6.722"></a><span id="l6.722" class="difflineminus">-         *  the instance, because for the &quot;folder&quot; tab, it is the canonical tab.</span>
<a href="#l6.723"></a><span id="l6.723" class="difflineminus">-         *  In other cases, having an MRU order and choosing the MRU tab might</span>
<a href="#l6.724"></a><span id="l6.724" class="difflineminus">-         *  be more appropriate.</span>
<a href="#l6.725"></a><span id="l6.725" class="difflineminus">-         *</span>
<a href="#l6.726"></a><span id="l6.726" class="difflineminus">-         * @return the tab info object for the tab meeting the above criteria,</span>
<a href="#l6.727"></a><span id="l6.727" class="difflineminus">-         *     or null if no such tab exists.</span>
<a href="#l6.728"></a><span id="l6.728" class="difflineminus">-         */</span>
<a href="#l6.729"></a><span id="l6.729" class="difflineminus">-          // If we're in the middle of opening a new tab</span>
<a href="#l6.730"></a><span id="l6.730" class="difflineminus">-          // (this._mostRecentTabInfo is non-null), we shouldn't consider the</span>
<a href="#l6.731"></a><span id="l6.731" class="difflineminus">-          // current tab</span>
<a href="#l6.732"></a><span id="l6.732" class="difflineminus">-          let tabToConsider = this._mostRecentTabInfo || this.currentTabInfo;</span>
<a href="#l6.733"></a><span id="l6.733" class="difflineminus">-          if (tabToConsider &amp;&amp; tabToConsider.mode == aTabMode)</span>
<a href="#l6.734"></a><span id="l6.734" class="difflineminus">-            return tabToConsider;</span>
<a href="#l6.735"></a><span id="l6.735" class="difflineminus">-          else if (aTabMode.tabs.length)</span>
<a href="#l6.736"></a><span id="l6.736" class="difflineminus">-            return aTabMode.tabs[0];</span>
<a href="#l6.737"></a><span id="l6.737" class="difflineminus">-          return null;</span>
<a href="#l6.738"></a><span id="l6.738" class="difflineminus">-        ]]&gt;&lt;/body&gt;</span>
<a href="#l6.739"></a><span id="l6.739" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l6.740"></a><span id="l6.740" class="difflineminus">-      &lt;method name=&quot;undoCloseTab&quot;&gt;</span>
<a href="#l6.741"></a><span id="l6.741" class="difflineminus">-        &lt;parameter name=&quot;aIdx&quot;/&gt;</span>
<a href="#l6.742"></a><span id="l6.742" class="difflineminus">-        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l6.743"></a><span id="l6.743" class="difflineminus">-</span>
<a href="#l6.744"></a><span id="l6.744" class="difflineminus">-          if (!this.recentlyClosedTabs.length)</span>
<a href="#l6.745"></a><span id="l6.745" class="difflineminus">-            return;</span>
<a href="#l6.746"></a><span id="l6.746" class="difflineminus">-</span>
<a href="#l6.747"></a><span id="l6.747" class="difflineminus">-          if (aIdx &gt;= this.recentlyClosedTabs.length)</span>
<a href="#l6.748"></a><span id="l6.748" class="difflineminus">-            aIdx = this.recentlyClosedTabs.length - 1;</span>
<a href="#l6.749"></a><span id="l6.749" class="difflineminus">-</span>
<a href="#l6.750"></a><span id="l6.750" class="difflineminus">-          // splice always returns an array</span>
<a href="#l6.751"></a><span id="l6.751" class="difflineminus">-          let history = (this.recentlyClosedTabs.splice(aIdx, 1))[0];</span>
<a href="#l6.752"></a><span id="l6.752" class="difflineminus">-</span>
<a href="#l6.753"></a><span id="l6.753" class="difflineminus">-          if (!history.tab)</span>
<a href="#l6.754"></a><span id="l6.754" class="difflineminus">-            return;</span>
<a href="#l6.755"></a><span id="l6.755" class="difflineminus">-</span>
<a href="#l6.756"></a><span id="l6.756" class="difflineminus">-          if (!this.restoreTab(JSON.parse(history.tab)))</span>
<a href="#l6.757"></a><span id="l6.757" class="difflineminus">-            return;</span>
<a href="#l6.758"></a><span id="l6.758" class="difflineminus">-</span>
<a href="#l6.759"></a><span id="l6.759" class="difflineminus">-          let idx = Math.min(history.idx, this.tabInfo.length);</span>
<a href="#l6.760"></a><span id="l6.760" class="difflineminus">-          let tab = this.tabContainer.allTabs[this.tabInfo.length - 1];</span>
<a href="#l6.761"></a><span id="l6.761" class="difflineminus">-          this.moveTabTo(tab, idx);</span>
<a href="#l6.762"></a><span id="l6.762" class="difflineminus">-</span>
<a href="#l6.763"></a><span id="l6.763" class="difflineminus">-          this.switchToTab(tab);</span>
<a href="#l6.764"></a><span id="l6.764" class="difflineminus">-</span>
<a href="#l6.765"></a><span id="l6.765" class="difflineminus">-        ]]&gt;&lt;/body&gt;</span>
<a href="#l6.766"></a><span id="l6.766" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l6.767"></a><span id="l6.767" class="difflineminus">-      &lt;method name=&quot;closeTab&quot;&gt;</span>
<a href="#l6.768"></a><span id="l6.768" class="difflineminus">-        &lt;parameter name=&quot;aOptTabIndexNodeOrInfo&quot;/&gt;</span>
<a href="#l6.769"></a><span id="l6.769" class="difflineminus">-        &lt;parameter name=&quot;aNoUndo&quot; /&gt;</span>
<a href="#l6.770"></a><span id="l6.770" class="difflineminus">-        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l6.771"></a><span id="l6.771" class="difflineminus">-</span>
<a href="#l6.772"></a><span id="l6.772" class="difflineminus">-            let [iTab, tab, tabNode] =</span>
<a href="#l6.773"></a><span id="l6.773" class="difflineminus">-              this._getTabContextForTabbyThing(aOptTabIndexNodeOrInfo, true);</span>
<a href="#l6.774"></a><span id="l6.774" class="difflineminus">-</span>
<a href="#l6.775"></a><span id="l6.775" class="difflineminus">-            if (!tab.canClose)</span>
<a href="#l6.776"></a><span id="l6.776" class="difflineminus">-              return;</span>
<a href="#l6.777"></a><span id="l6.777" class="difflineminus">-</span>
<a href="#l6.778"></a><span id="l6.778" class="difflineminus">-            // Give the tab type a chance to make its own decisions about</span>
<a href="#l6.779"></a><span id="l6.779" class="difflineminus">-            // whether its tabs can be closed or not. For instance, contentTabs</span>
<a href="#l6.780"></a><span id="l6.780" class="difflineminus">-            // and chromeTabs run onbeforeunload event handlers that may</span>
<a href="#l6.781"></a><span id="l6.781" class="difflineminus">-            // exercise their right to prompt the user for confirmation before</span>
<a href="#l6.782"></a><span id="l6.782" class="difflineminus">-            // closing.</span>
<a href="#l6.783"></a><span id="l6.783" class="difflineminus">-            let tryCloseFunc = tab.mode.tryCloseTab || tab.mode.tabType.tryCloseTab;</span>
<a href="#l6.784"></a><span id="l6.784" class="difflineminus">-            if (tryCloseFunc &amp;&amp; !tryCloseFunc.call(tab.mode.tabType, tab))</span>
<a href="#l6.785"></a><span id="l6.785" class="difflineminus">-              return;</span>
<a href="#l6.786"></a><span id="l6.786" class="difflineminus">-</span>
<a href="#l6.787"></a><span id="l6.787" class="difflineminus">-            let evt = new CustomEvent(&quot;TabClose&quot;, {</span>
<a href="#l6.788"></a><span id="l6.788" class="difflineminus">-              bubbles: true,</span>
<a href="#l6.789"></a><span id="l6.789" class="difflineminus">-              detail: { tabInfo: tab, moving: tab.moving },</span>
<a href="#l6.790"></a><span id="l6.790" class="difflineminus">-            });</span>
<a href="#l6.791"></a><span id="l6.791" class="difflineminus">-            tabNode.dispatchEvent(evt);</span>
<a href="#l6.792"></a><span id="l6.792" class="difflineminus">-</span>
<a href="#l6.793"></a><span id="l6.793" class="difflineminus">-            for (let tabMonitor of this.tabMonitors) {</span>
<a href="#l6.794"></a><span id="l6.794" class="difflineminus">-              if (&quot;onTabClosing&quot; in tabMonitor)</span>
<a href="#l6.795"></a><span id="l6.795" class="difflineminus">-                tabMonitor.onTabClosing(tab);</span>
<a href="#l6.796"></a><span id="l6.796" class="difflineminus">-            }</span>
<a href="#l6.797"></a><span id="l6.797" class="difflineminus">-</span>
<a href="#l6.798"></a><span id="l6.798" class="difflineminus">-            if (!aNoUndo) {</span>
<a href="#l6.799"></a><span id="l6.799" class="difflineminus">-              // Allow user to undo accidentally closed tabs</span>
<a href="#l6.800"></a><span id="l6.800" class="difflineminus">-              let session = this.persistTab(tab);</span>
<a href="#l6.801"></a><span id="l6.801" class="difflineminus">-</span>
<a href="#l6.802"></a><span id="l6.802" class="difflineminus">-              if (session) {</span>
<a href="#l6.803"></a><span id="l6.803" class="difflineminus">-                this.recentlyClosedTabs.unshift(</span>
<a href="#l6.804"></a><span id="l6.804" class="difflineminus">-                  { tab: JSON.stringify(session), idx: iTab, title: tab.title });</span>
<a href="#l6.805"></a><span id="l6.805" class="difflineminus">-</span>
<a href="#l6.806"></a><span id="l6.806" class="difflineminus">-                if (this.recentlyClosedTabs.length &gt; 10)</span>
<a href="#l6.807"></a><span id="l6.807" class="difflineminus">-                  this.recentlyClosedTabs.pop();</span>
<a href="#l6.808"></a><span id="l6.808" class="difflineminus">-              }</span>
<a href="#l6.809"></a><span id="l6.809" class="difflineminus">-            }</span>
<a href="#l6.810"></a><span id="l6.810" class="difflineminus">-</span>
<a href="#l6.811"></a><span id="l6.811" class="difflineminus">-            let closeFunc = tab.mode.closeTab || tab.mode.tabType.closeTab;</span>
<a href="#l6.812"></a><span id="l6.812" class="difflineminus">-            closeFunc.call(tab.mode.tabType, tab);</span>
<a href="#l6.813"></a><span id="l6.813" class="difflineminus">-</span>
<a href="#l6.814"></a><span id="l6.814" class="difflineminus">-            this.tabInfo.splice(iTab, 1);</span>
<a href="#l6.815"></a><span id="l6.815" class="difflineminus">-            tab.mode.tabs.splice(tab.mode.tabs.indexOf(tab), 1);</span>
<a href="#l6.816"></a><span id="l6.816" class="difflineminus">-            tabNode.remove();</span>
<a href="#l6.817"></a><span id="l6.817" class="difflineminus">-</span>
<a href="#l6.818"></a><span id="l6.818" class="difflineminus">-            if (this.tabContainer.selectedIndex == -1) {</span>
<a href="#l6.819"></a><span id="l6.819" class="difflineminus">-              if (this.mLastTabOpener &amp;&amp; this.tabInfo.includes(this.mLastTabOpener)) {</span>
<a href="#l6.820"></a><span id="l6.820" class="difflineminus">-                this.tabContainer.selectedIndex = this.tabInfo.indexOf(this.mLastTabOpener);</span>
<a href="#l6.821"></a><span id="l6.821" class="difflineminus">-              } else {</span>
<a href="#l6.822"></a><span id="l6.822" class="difflineminus">-                this.tabContainer.selectedIndex =</span>
<a href="#l6.823"></a><span id="l6.823" class="difflineminus">-                  (iTab == this.tabContainer.allTabs.length) ? iTab - 1 : iTab;</span>
<a href="#l6.824"></a><span id="l6.824" class="difflineminus">-              }</span>
<a href="#l6.825"></a><span id="l6.825" class="difflineminus">-            }</span>
<a href="#l6.826"></a><span id="l6.826" class="difflineminus">-</span>
<a href="#l6.827"></a><span id="l6.827" class="difflineminus">-            // Clear the last tab opener - we don't need this anymore.</span>
<a href="#l6.828"></a><span id="l6.828" class="difflineminus">-            this.mLastTabOpener = null;</span>
<a href="#l6.829"></a><span id="l6.829" class="difflineminus">-</span>
<a href="#l6.830"></a><span id="l6.830" class="difflineminus">-            if (this.currentTabInfo == tab)</span>
<a href="#l6.831"></a><span id="l6.831" class="difflineminus">-              this.updateCurrentTab();</span>
<a href="#l6.832"></a><span id="l6.832" class="difflineminus">-</span>
<a href="#l6.833"></a><span id="l6.833" class="difflineminus">-            if (tab.panel) {</span>
<a href="#l6.834"></a><span id="l6.834" class="difflineminus">-              tab.panel.remove();</span>
<a href="#l6.835"></a><span id="l6.835" class="difflineminus">-              delete tab.panel;</span>
<a href="#l6.836"></a><span id="l6.836" class="difflineminus">-</span>
<a href="#l6.837"></a><span id="l6.837" class="difflineminus">-              // Ensure current tab is still selected and displayed in the</span>
<a href="#l6.838"></a><span id="l6.838" class="difflineminus">-              // panelContainer.</span>
<a href="#l6.839"></a><span id="l6.839" class="difflineminus">-              this.panelContainer.selectedPanel =</span>
<a href="#l6.840"></a><span id="l6.840" class="difflineminus">-                this.currentTabInfo.panel || this.currentTabInfo.mode.tabType.panel;</span>
<a href="#l6.841"></a><span id="l6.841" class="difflineminus">-            }</span>
<a href="#l6.842"></a><span id="l6.842" class="difflineminus">-            if (this.tabContainer.allTabs.length == 1 &amp;&amp;</span>
<a href="#l6.843"></a><span id="l6.843" class="difflineminus">-                this.tabContainer.mAutoHide)</span>
<a href="#l6.844"></a><span id="l6.844" class="difflineminus">-              this.tabContainer.mCollapseToolbar.collapsed = true;</span>
<a href="#l6.845"></a><span id="l6.845" class="difflineminus">-          ]]&gt;</span>
<a href="#l6.846"></a><span id="l6.846" class="difflineminus">-        &lt;/body&gt;</span>
<a href="#l6.847"></a><span id="l6.847" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l6.848"></a><span id="l6.848" class="difflineminus">-      &lt;method name=&quot;removeTabByNode&quot;&gt;</span>
<a href="#l6.849"></a><span id="l6.849" class="difflineminus">-        &lt;parameter name=&quot;aTabNode&quot;/&gt;</span>
<a href="#l6.850"></a><span id="l6.850" class="difflineminus">-        &lt;body&gt;</span>
<a href="#l6.851"></a><span id="l6.851" class="difflineminus">-          &lt;![CDATA[</span>
<a href="#l6.852"></a><span id="l6.852" class="difflineminus">-            this.closeTab(aTabNode);</span>
<a href="#l6.853"></a><span id="l6.853" class="difflineminus">-          ]]&gt;</span>
<a href="#l6.854"></a><span id="l6.854" class="difflineminus">-        &lt;/body&gt;</span>
<a href="#l6.855"></a><span id="l6.855" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l6.856"></a><span id="l6.856" class="difflineminus">-      &lt;method name=&quot;closeOtherTabs&quot;&gt;</span>
<a href="#l6.857"></a><span id="l6.857" class="difflineminus">-        &lt;parameter name=&quot;aTabNode&quot;/&gt;</span>
<a href="#l6.858"></a><span id="l6.858" class="difflineminus">-        &lt;parameter name=&quot;aNoUndo&quot;/&gt;</span>
<a href="#l6.859"></a><span id="l6.859" class="difflineminus">-        &lt;body&gt;</span>
<a href="#l6.860"></a><span id="l6.860" class="difflineminus">-          &lt;![CDATA[</span>
<a href="#l6.861"></a><span id="l6.861" class="difflineminus">-            /**</span>
<a href="#l6.862"></a><span id="l6.862" class="difflineminus">-             * Given a tabNode (or tabby thing), close all of the other tabs</span>
<a href="#l6.863"></a><span id="l6.863" class="difflineminus">-             *  that are closeable.</span>
<a href="#l6.864"></a><span id="l6.864" class="difflineminus">-             */</span>
<a href="#l6.865"></a><span id="l6.865" class="difflineminus">-            let [, thisTab] = this._getTabContextForTabbyThing(aTabNode, false);</span>
<a href="#l6.866"></a><span id="l6.866" class="difflineminus">-</span>
<a href="#l6.867"></a><span id="l6.867" class="difflineminus">-            // closeTab mutates the tabInfo array, so start from the end.</span>
<a href="#l6.868"></a><span id="l6.868" class="difflineminus">-            for (let i = this.tabInfo.length - 1; i &gt;= 0; i--) {</span>
<a href="#l6.869"></a><span id="l6.869" class="difflineminus">-              let tab = this.tabInfo[i];</span>
<a href="#l6.870"></a><span id="l6.870" class="difflineminus">-              if ((tab != thisTab) &amp;&amp; tab.canClose)</span>
<a href="#l6.871"></a><span id="l6.871" class="difflineminus">-                this.closeTab(tab, aNoUndo);</span>
<a href="#l6.872"></a><span id="l6.872" class="difflineminus">-            }</span>
<a href="#l6.873"></a><span id="l6.873" class="difflineminus">-          ]]&gt;</span>
<a href="#l6.874"></a><span id="l6.874" class="difflineminus">-        &lt;/body&gt;</span>
<a href="#l6.875"></a><span id="l6.875" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l6.876"></a><span id="l6.876" class="difflineminus">-      &lt;method name=&quot;replaceTabWithWindow&quot;&gt;</span>
<a href="#l6.877"></a><span id="l6.877" class="difflineminus">-        &lt;parameter name=&quot;aTab&quot;/&gt;</span>
<a href="#l6.878"></a><span id="l6.878" class="difflineminus">-        &lt;parameter name=&quot;aTargetWindow&quot;/&gt;</span>
<a href="#l6.879"></a><span id="l6.879" class="difflineminus">-        &lt;parameter name=&quot;aTargetPosition&quot;/&gt;</span>
<a href="#l6.880"></a><span id="l6.880" class="difflineminus">-        &lt;body&gt;</span>
<a href="#l6.881"></a><span id="l6.881" class="difflineminus">-          &lt;![CDATA[</span>
<a href="#l6.882"></a><span id="l6.882" class="difflineminus">-            if (this.tabInfo.length &lt;= 1)</span>
<a href="#l6.883"></a><span id="l6.883" class="difflineminus">-              return null;</span>
<a href="#l6.884"></a><span id="l6.884" class="difflineminus">-</span>
<a href="#l6.885"></a><span id="l6.885" class="difflineminus">-            let tab = this._getTabContextForTabbyThing(aTab, false)[1];</span>
<a href="#l6.886"></a><span id="l6.886" class="difflineminus">-</span>
<a href="#l6.887"></a><span id="l6.887" class="difflineminus">-            if (!tab.canClose)</span>
<a href="#l6.888"></a><span id="l6.888" class="difflineminus">-              return null;</span>
<a href="#l6.889"></a><span id="l6.889" class="difflineminus">-</span>
<a href="#l6.890"></a><span id="l6.890" class="difflineminus">-            // We use Json and session restore transfer the tab to the new window.</span>
<a href="#l6.891"></a><span id="l6.891" class="difflineminus">-            tab = this.persistTab(tab);</span>
<a href="#l6.892"></a><span id="l6.892" class="difflineminus">-            if (!tab)</span>
<a href="#l6.893"></a><span id="l6.893" class="difflineminus">-              return null;</span>
<a href="#l6.894"></a><span id="l6.894" class="difflineminus">-</span>
<a href="#l6.895"></a><span id="l6.895" class="difflineminus">-            // Converting to JSON and back again creates clean javascript</span>
<a href="#l6.896"></a><span id="l6.896" class="difflineminus">-            // object with absolutely no references to our current window.</span>
<a href="#l6.897"></a><span id="l6.897" class="difflineminus">-            tab = JSON.parse(JSON.stringify(tab));</span>
<a href="#l6.898"></a><span id="l6.898" class="difflineminus">-</span>
<a href="#l6.899"></a><span id="l6.899" class="difflineminus">-            // Set up an identifier for the move, consumers may want to correlate TabClose and</span>
<a href="#l6.900"></a><span id="l6.900" class="difflineminus">-            // TabOpen events.</span>
<a href="#l6.901"></a><span id="l6.901" class="difflineminus">-            let moveSession = Cc[&quot;@mozilla.org/uuid-generator;1&quot;]</span>
<a href="#l6.902"></a><span id="l6.902" class="difflineminus">-              .getService(Ci.nsIUUIDGenerator)</span>
<a href="#l6.903"></a><span id="l6.903" class="difflineminus">-              .generateUUID().toString();</span>
<a href="#l6.904"></a><span id="l6.904" class="difflineminus">-</span>
<a href="#l6.905"></a><span id="l6.905" class="difflineminus">-            tab.moving = moveSession;</span>
<a href="#l6.906"></a><span id="l6.906" class="difflineminus">-            aTab.moving = moveSession;</span>
<a href="#l6.907"></a><span id="l6.907" class="difflineminus">-</span>
<a href="#l6.908"></a><span id="l6.908" class="difflineminus">-            this.closeTab(aTab, true);</span>
<a href="#l6.909"></a><span id="l6.909" class="difflineminus">-</span>
<a href="#l6.910"></a><span id="l6.910" class="difflineminus">-            if (aTargetWindow &amp;&amp; aTargetWindow !== &quot;popup&quot;) {</span>
<a href="#l6.911"></a><span id="l6.911" class="difflineminus">-              let targetTabmail = aTargetWindow.document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l6.912"></a><span id="l6.912" class="difflineminus">-              targetTabmail.restoreTab(tab);</span>
<a href="#l6.913"></a><span id="l6.913" class="difflineminus">-</span>
<a href="#l6.914"></a><span id="l6.914" class="difflineminus">-              if (aTargetPosition) {</span>
<a href="#l6.915"></a><span id="l6.915" class="difflineminus">-                let droppedTab = targetTabmail.tabInfo[targetTabmail.tabInfo.length - 1];</span>
<a href="#l6.916"></a><span id="l6.916" class="difflineminus">-                targetTabmail.moveTabTo(droppedTab, aTargetPosition);</span>
<a href="#l6.917"></a><span id="l6.917" class="difflineminus">-              }</span>
<a href="#l6.918"></a><span id="l6.918" class="difflineminus">-              return aTargetWindow;</span>
<a href="#l6.919"></a><span id="l6.919" class="difflineminus">-            }</span>
<a href="#l6.920"></a><span id="l6.920" class="difflineminus">-            let features = [&quot;chrome&quot;];</span>
<a href="#l6.921"></a><span id="l6.921" class="difflineminus">-            if (aTargetWindow === &quot;popup&quot;) {</span>
<a href="#l6.922"></a><span id="l6.922" class="difflineminus">-              features.push(&quot;dialog&quot;, &quot;resizable&quot;, &quot;minimizable&quot;, &quot;centerscreen&quot;, &quot;titlebar&quot;, &quot;close&quot;);</span>
<a href="#l6.923"></a><span id="l6.923" class="difflineminus">-            } else {</span>
<a href="#l6.924"></a><span id="l6.924" class="difflineminus">-              features.push(&quot;dialog=no&quot;, &quot;all&quot;, &quot;status&quot;, &quot;toolbar&quot;);</span>
<a href="#l6.925"></a><span id="l6.925" class="difflineminus">-            }</span>
<a href="#l6.926"></a><span id="l6.926" class="difflineminus">-</span>
<a href="#l6.927"></a><span id="l6.927" class="difflineminus">-            return window.openDialog(&quot;chrome://messenger/content/&quot;, &quot;_blank&quot;,</span>
<a href="#l6.928"></a><span id="l6.928" class="difflineminus">-              features.join(&quot;,&quot;), null,</span>
<a href="#l6.929"></a><span id="l6.929" class="difflineminus">-              { action: &quot;restore&quot;, tabs: [tab] }).focus();</span>
<a href="#l6.930"></a><span id="l6.930" class="difflineminus">-          ]]&gt;</span>
<a href="#l6.931"></a><span id="l6.931" class="difflineminus">-        &lt;/body&gt;</span>
<a href="#l6.932"></a><span id="l6.932" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l6.933"></a><span id="l6.933" class="difflineminus">-      &lt;method name=&quot;moveTabTo&quot;&gt;</span>
<a href="#l6.934"></a><span id="l6.934" class="difflineminus">-        &lt;parameter name=&quot;aTabIndexNodeOrInfo&quot;/&gt;</span>
<a href="#l6.935"></a><span id="l6.935" class="difflineminus">-        &lt;parameter name=&quot;aIndex&quot;/&gt;</span>
<a href="#l6.936"></a><span id="l6.936" class="difflineminus">-        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l6.937"></a><span id="l6.937" class="difflineminus">-          let [oldIdx, tab, tabNode] =</span>
<a href="#l6.938"></a><span id="l6.938" class="difflineminus">-            this._getTabContextForTabbyThing(aTabIndexNodeOrInfo, false);</span>
<a href="#l6.939"></a><span id="l6.939" class="difflineminus">-</span>
<a href="#l6.940"></a><span id="l6.940" class="difflineminus">-          if (!tab || !tabNode || tabNode.tagName != &quot;tab&quot; || oldIdx &lt; 0 || oldIdx == aIndex) {</span>
<a href="#l6.941"></a><span id="l6.941" class="difflineminus">-            return -1;</span>
<a href="#l6.942"></a><span id="l6.942" class="difflineminus">-          }</span>
<a href="#l6.943"></a><span id="l6.943" class="difflineminus">-</span>
<a href="#l6.944"></a><span id="l6.944" class="difflineminus">-          // remove the entries from tabInfo, tabMode and the tabContainer</span>
<a href="#l6.945"></a><span id="l6.945" class="difflineminus">-          this.tabInfo.splice(oldIdx, 1);</span>
<a href="#l6.946"></a><span id="l6.946" class="difflineminus">-          tab.mode.tabs.splice(tab.mode.tabs.indexOf(tab), 1);</span>
<a href="#l6.947"></a><span id="l6.947" class="difflineminus">-          tabNode.remove();</span>
<a href="#l6.948"></a><span id="l6.948" class="difflineminus">-</span>
<a href="#l6.949"></a><span id="l6.949" class="difflineminus">-          // as we removed items, we might need to update indices</span>
<a href="#l6.950"></a><span id="l6.950" class="difflineminus">-          if (oldIdx &lt; aIndex) {</span>
<a href="#l6.951"></a><span id="l6.951" class="difflineminus">-            aIndex--;</span>
<a href="#l6.952"></a><span id="l6.952" class="difflineminus">-          }</span>
<a href="#l6.953"></a><span id="l6.953" class="difflineminus">-</span>
<a href="#l6.954"></a><span id="l6.954" class="difflineminus">-          // Read it into tabInfo and the tabContainer</span>
<a href="#l6.955"></a><span id="l6.955" class="difflineminus">-          this.tabInfo.splice(aIndex, 0, tab);</span>
<a href="#l6.956"></a><span id="l6.956" class="difflineminus">-          this.tabContainer.insertBefore(tabNode, this.tabContainer.allTabs[aIndex]);</span>
<a href="#l6.957"></a><span id="l6.957" class="difflineminus">-</span>
<a href="#l6.958"></a><span id="l6.958" class="difflineminus">-          // Now it's getting a bit ugly, as tabModes stores redundant</span>
<a href="#l6.959"></a><span id="l6.959" class="difflineminus">-          // information we need to get it in sync with tabInfo.</span>
<a href="#l6.960"></a><span id="l6.960" class="difflineminus">-          //</span>
<a href="#l6.961"></a><span id="l6.961" class="difflineminus">-          // As tabModes.tabs is a subset of tabInfo, every tab can be mapped</span>
<a href="#l6.962"></a><span id="l6.962" class="difflineminus">-          // to a tabInfo index. So we check for each tab in tabModes if it is</span>
<a href="#l6.963"></a><span id="l6.963" class="difflineminus">-          // directly in front of our moved tab. We do this by looking up the</span>
<a href="#l6.964"></a><span id="l6.964" class="difflineminus">-          // index in tabInfo and compare it with the moved tab's index. If we</span>
<a href="#l6.965"></a><span id="l6.965" class="difflineminus">-          // found our tab, we insert the moved tab directly behind into tabModes</span>
<a href="#l6.966"></a><span id="l6.966" class="difflineminus">-</span>
<a href="#l6.967"></a><span id="l6.967" class="difflineminus">-          // In case find no tab we simply append it</span>
<a href="#l6.968"></a><span id="l6.968" class="difflineminus">-          let modeIdx = tab.mode.tabs.length + 1;</span>
<a href="#l6.969"></a><span id="l6.969" class="difflineminus">-</span>
<a href="#l6.970"></a><span id="l6.970" class="difflineminus">-          for (let i = 0; i &lt; tab.mode.tabs.length; i++) {</span>
<a href="#l6.971"></a><span id="l6.971" class="difflineminus">-            if (this.tabInfo.indexOf(tab.mode.tabs[i]) &lt; aIndex)</span>
<a href="#l6.972"></a><span id="l6.972" class="difflineminus">-              continue;</span>
<a href="#l6.973"></a><span id="l6.973" class="difflineminus">-</span>
<a href="#l6.974"></a><span id="l6.974" class="difflineminus">-            modeIdx = i;</span>
<a href="#l6.975"></a><span id="l6.975" class="difflineminus">-            break;</span>
<a href="#l6.976"></a><span id="l6.976" class="difflineminus">-          }</span>
<a href="#l6.977"></a><span id="l6.977" class="difflineminus">-</span>
<a href="#l6.978"></a><span id="l6.978" class="difflineminus">-          tab.mode.tabs.splice(modeIdx, 0, tab);</span>
<a href="#l6.979"></a><span id="l6.979" class="difflineminus">-</span>
<a href="#l6.980"></a><span id="l6.980" class="difflineminus">-          let evt = new CustomEvent(&quot;TabMove&quot;, {</span>
<a href="#l6.981"></a><span id="l6.981" class="difflineminus">-            bubbles: true, view: window, detail: { idx: oldIdx, tabInfo: tab },</span>
<a href="#l6.982"></a><span id="l6.982" class="difflineminus">-          });</span>
<a href="#l6.983"></a><span id="l6.983" class="difflineminus">-          tabNode.dispatchEvent(evt);</span>
<a href="#l6.984"></a><span id="l6.984" class="difflineminus">-</span>
<a href="#l6.985"></a><span id="l6.985" class="difflineminus">-          return aIndex;</span>
<a href="#l6.986"></a><span id="l6.986" class="difflineminus">-        ]]&gt;&lt;/body&gt;</span>
<a href="#l6.987"></a><span id="l6.987" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l6.988"></a><span id="l6.988" class="difflineminus">-      &lt;method name=&quot;persistTab&quot;&gt;</span>
<a href="#l6.989"></a><span id="l6.989" class="difflineminus">-        &lt;parameter name=&quot;tab&quot;/&gt;</span>
<a href="#l6.990"></a><span id="l6.990" class="difflineminus">-        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l6.991"></a><span id="l6.991" class="difflineminus">-           /* Returns null in case persist fails */</span>
<a href="#l6.992"></a><span id="l6.992" class="difflineminus">-</span>
<a href="#l6.993"></a><span id="l6.993" class="difflineminus">-           let persistFunc = tab.mode.persistTab || tab.mode.tabType.persistTab;</span>
<a href="#l6.994"></a><span id="l6.994" class="difflineminus">-</span>
<a href="#l6.995"></a><span id="l6.995" class="difflineminus">-           // if we can't restore the tab we can't move it</span>
<a href="#l6.996"></a><span id="l6.996" class="difflineminus">-           if (!persistFunc)</span>
<a href="#l6.997"></a><span id="l6.997" class="difflineminus">-             return null;</span>
<a href="#l6.998"></a><span id="l6.998" class="difflineminus">-</span>
<a href="#l6.999"></a><span id="l6.999" class="difflineminus">-           //  If there is a non-null tab-state, then persisting succeeded and</span>
<a href="#l6.1000"></a><span id="l6.1000" class="difflineminus">-           //  we should store it.  We store the tab's persisted state in its</span>
<a href="#l6.1001"></a><span id="l6.1001" class="difflineminus">-           //  own distinct object rather than mixing things up in a dictionary</span>
<a href="#l6.1002"></a><span id="l6.1002" class="difflineminus">-           //  to avoid bugs and because we may eventually let extensions store</span>
<a href="#l6.1003"></a><span id="l6.1003" class="difflineminus">-           //  per-tab information in the persisted state.</span>
<a href="#l6.1004"></a><span id="l6.1004" class="difflineminus">-</span>
<a href="#l6.1005"></a><span id="l6.1005" class="difflineminus">-           let tabState;</span>
<a href="#l6.1006"></a><span id="l6.1006" class="difflineminus">-           // Wrap this in an exception handler so that if the persistence</span>
<a href="#l6.1007"></a><span id="l6.1007" class="difflineminus">-           // logic fails, things like tab closure still run to completion.</span>
<a href="#l6.1008"></a><span id="l6.1008" class="difflineminus">-           try {</span>
<a href="#l6.1009"></a><span id="l6.1009" class="difflineminus">-             tabState = persistFunc.call(tab.mode.tabType, tab);</span>
<a href="#l6.1010"></a><span id="l6.1010" class="difflineminus">-           } catch (ex) {</span>
<a href="#l6.1011"></a><span id="l6.1011" class="difflineminus">-             // Report this so that our unit testing framework sees this</span>
<a href="#l6.1012"></a><span id="l6.1012" class="difflineminus">-             // error and (extension) developers likewise can see when their</span>
<a href="#l6.1013"></a><span id="l6.1013" class="difflineminus">-             // extensions are ill-behaved.</span>
<a href="#l6.1014"></a><span id="l6.1014" class="difflineminus">-             Cu.reportError(ex);</span>
<a href="#l6.1015"></a><span id="l6.1015" class="difflineminus">-           }</span>
<a href="#l6.1016"></a><span id="l6.1016" class="difflineminus">-</span>
<a href="#l6.1017"></a><span id="l6.1017" class="difflineminus">-           if (!tabState)</span>
<a href="#l6.1018"></a><span id="l6.1018" class="difflineminus">-             return null;</span>
<a href="#l6.1019"></a><span id="l6.1019" class="difflineminus">-</span>
<a href="#l6.1020"></a><span id="l6.1020" class="difflineminus">-           let ext = {};</span>
<a href="#l6.1021"></a><span id="l6.1021" class="difflineminus">-</span>
<a href="#l6.1022"></a><span id="l6.1022" class="difflineminus">-           for (let tabMonitor of this.tabMonitors) {</span>
<a href="#l6.1023"></a><span id="l6.1023" class="difflineminus">-             if (&quot;onTabPersist&quot; in tabMonitor) {</span>
<a href="#l6.1024"></a><span id="l6.1024" class="difflineminus">-               let monState = tabMonitor.onTabPersist(tab);</span>
<a href="#l6.1025"></a><span id="l6.1025" class="difflineminus">-               if (monState !== null)</span>
<a href="#l6.1026"></a><span id="l6.1026" class="difflineminus">-                 ext[tabMonitor.monitorName] = monState;</span>
<a href="#l6.1027"></a><span id="l6.1027" class="difflineminus">-             }</span>
<a href="#l6.1028"></a><span id="l6.1028" class="difflineminus">-           }</span>
<a href="#l6.1029"></a><span id="l6.1029" class="difflineminus">-</span>
<a href="#l6.1030"></a><span id="l6.1030" class="difflineminus">-           return {mode: tab.mode.name, state: tabState, ext};</span>
<a href="#l6.1031"></a><span id="l6.1031" class="difflineminus">-        ]]&gt;&lt;/body&gt;</span>
<a href="#l6.1032"></a><span id="l6.1032" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l6.1033"></a><span id="l6.1033" class="difflineminus">-</span>
<a href="#l6.1034"></a><span id="l6.1034" class="difflineminus">-      &lt;method name=&quot;persistTabs&quot;&gt;</span>
<a href="#l6.1035"></a><span id="l6.1035" class="difflineminus">-        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l6.1036"></a><span id="l6.1036" class="difflineminus">-          /**</span>
<a href="#l6.1037"></a><span id="l6.1037" class="difflineminus">-           * Persist the state of all tab modes implementing persistTab methods</span>
<a href="#l6.1038"></a><span id="l6.1038" class="difflineminus">-           *  to a JSON-serializable object representation and return it.  Call</span>
<a href="#l6.1039"></a><span id="l6.1039" class="difflineminus">-           *  restoreTabs with the result to restore the tab state.</span>
<a href="#l6.1040"></a><span id="l6.1040" class="difflineminus">-           * Calling this method should have no side effects; tabs will not be</span>
<a href="#l6.1041"></a><span id="l6.1041" class="difflineminus">-           *  closed, displays will not change, etc.  This means the method is</span>
<a href="#l6.1042"></a><span id="l6.1042" class="difflineminus">-           *  safe to use in an auto-save style so that if we crash we can</span>
<a href="#l6.1043"></a><span id="l6.1043" class="difflineminus">-           *  restore the (approximate) state at the time of the crash.</span>
<a href="#l6.1044"></a><span id="l6.1044" class="difflineminus">-           *</span>
<a href="#l6.1045"></a><span id="l6.1045" class="difflineminus">-           * @return {Object} The persisted tab states.</span>
<a href="#l6.1046"></a><span id="l6.1046" class="difflineminus">-           */</span>
<a href="#l6.1047"></a><span id="l6.1047" class="difflineminus">-          let state = {</span>
<a href="#l6.1048"></a><span id="l6.1048" class="difflineminus">-            // Explicitly specify a revision so we don't wish we had later.</span>
<a href="#l6.1049"></a><span id="l6.1049" class="difflineminus">-            rev: 0,</span>
<a href="#l6.1050"></a><span id="l6.1050" class="difflineminus">-            // If our currently selected tab gets persisted, we will update this</span>
<a href="#l6.1051"></a><span id="l6.1051" class="difflineminus">-            selectedIndex: null,</span>
<a href="#l6.1052"></a><span id="l6.1052" class="difflineminus">-          };</span>
<a href="#l6.1053"></a><span id="l6.1053" class="difflineminus">-</span>
<a href="#l6.1054"></a><span id="l6.1054" class="difflineminus">-          let tabs = state.tabs = [];</span>
<a href="#l6.1055"></a><span id="l6.1055" class="difflineminus">-</span>
<a href="#l6.1056"></a><span id="l6.1056" class="difflineminus">-          for (let [iTab, tab] of this.tabInfo.entries()) {</span>
<a href="#l6.1057"></a><span id="l6.1057" class="difflineminus">-            let persistTab = this.persistTab(tab);</span>
<a href="#l6.1058"></a><span id="l6.1058" class="difflineminus">-</span>
<a href="#l6.1059"></a><span id="l6.1059" class="difflineminus">-            if (!persistTab)</span>
<a href="#l6.1060"></a><span id="l6.1060" class="difflineminus">-              continue;</span>
<a href="#l6.1061"></a><span id="l6.1061" class="difflineminus">-</span>
<a href="#l6.1062"></a><span id="l6.1062" class="difflineminus">-            tabs.push(persistTab);</span>
<a href="#l6.1063"></a><span id="l6.1063" class="difflineminus">-</span>
<a href="#l6.1064"></a><span id="l6.1064" class="difflineminus">-            // Mark this persisted tab as selected</span>
<a href="#l6.1065"></a><span id="l6.1065" class="difflineminus">-            if (iTab == this.tabContainer.selectedIndex)</span>
<a href="#l6.1066"></a><span id="l6.1066" class="difflineminus">-              state.selectedIndex = tabs.length - 1;</span>
<a href="#l6.1067"></a><span id="l6.1067" class="difflineminus">-          }</span>
<a href="#l6.1068"></a><span id="l6.1068" class="difflineminus">-</span>
<a href="#l6.1069"></a><span id="l6.1069" class="difflineminus">-          return state;</span>
<a href="#l6.1070"></a><span id="l6.1070" class="difflineminus">-        ]]&gt;&lt;/body&gt;</span>
<a href="#l6.1071"></a><span id="l6.1071" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l6.1072"></a><span id="l6.1072" class="difflineminus">-      &lt;method name=&quot;restoreTab&quot;&gt;</span>
<a href="#l6.1073"></a><span id="l6.1073" class="difflineminus">-        &lt;parameter name=&quot;aState&quot;/&gt;</span>
<a href="#l6.1074"></a><span id="l6.1074" class="difflineminus">-        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l6.1075"></a><span id="l6.1075" class="difflineminus">-</span>
<a href="#l6.1076"></a><span id="l6.1076" class="difflineminus">-          // if we no longer know about the mode, we can't restore the tab</span>
<a href="#l6.1077"></a><span id="l6.1077" class="difflineminus">-          let mode = this.tabModes[aState.mode];</span>
<a href="#l6.1078"></a><span id="l6.1078" class="difflineminus">-          if (!mode) {</span>
<a href="#l6.1079"></a><span id="l6.1079" class="difflineminus">-            this.unrestoredTabs.push(aState);</span>
<a href="#l6.1080"></a><span id="l6.1080" class="difflineminus">-            return false;</span>
<a href="#l6.1081"></a><span id="l6.1081" class="difflineminus">-          }</span>
<a href="#l6.1082"></a><span id="l6.1082" class="difflineminus">-</span>
<a href="#l6.1083"></a><span id="l6.1083" class="difflineminus">-          let restoreFunc = mode.restoreTab || mode.tabType.restoreTab;</span>
<a href="#l6.1084"></a><span id="l6.1084" class="difflineminus">-</span>
<a href="#l6.1085"></a><span id="l6.1085" class="difflineminus">-          if (!restoreFunc)</span>
<a href="#l6.1086"></a><span id="l6.1086" class="difflineminus">-            return false;</span>
<a href="#l6.1087"></a><span id="l6.1087" class="difflineminus">-</span>
<a href="#l6.1088"></a><span id="l6.1088" class="difflineminus">-          // normalize the state to have an ext attribute if it does not.</span>
<a href="#l6.1089"></a><span id="l6.1089" class="difflineminus">-          if (!(&quot;ext&quot; in aState))</span>
<a href="#l6.1090"></a><span id="l6.1090" class="difflineminus">-            aState.ext = {};</span>
<a href="#l6.1091"></a><span id="l6.1091" class="difflineminus">-</span>
<a href="#l6.1092"></a><span id="l6.1092" class="difflineminus">-          this._restoringTabState = aState;</span>
<a href="#l6.1093"></a><span id="l6.1093" class="difflineminus">-          restoreFunc.call(mode.tabType, this, aState.state);</span>
<a href="#l6.1094"></a><span id="l6.1094" class="difflineminus">-          this._restoringTabState = null;</span>
<a href="#l6.1095"></a><span id="l6.1095" class="difflineminus">-</span>
<a href="#l6.1096"></a><span id="l6.1096" class="difflineminus">-          return true;</span>
<a href="#l6.1097"></a><span id="l6.1097" class="difflineminus">-</span>
<a href="#l6.1098"></a><span id="l6.1098" class="difflineminus">-        ]]&gt;&lt;/body&gt;</span>
<a href="#l6.1099"></a><span id="l6.1099" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l6.1100"></a><span id="l6.1100" class="difflineminus">-      &lt;method name=&quot;restoreTabs&quot;&gt;</span>
<a href="#l6.1101"></a><span id="l6.1101" class="difflineminus">-        &lt;parameter name=&quot;aPersistedState&quot;/&gt;</span>
<a href="#l6.1102"></a><span id="l6.1102" class="difflineminus">-        &lt;parameter name=&quot;aDontRestoreFirstTab&quot;/&gt;</span>
<a href="#l6.1103"></a><span id="l6.1103" class="difflineminus">-        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l6.1104"></a><span id="l6.1104" class="difflineminus">-          /**</span>
<a href="#l6.1105"></a><span id="l6.1105" class="difflineminus">-           * Attempts to restore tabs persisted from a prior call to</span>
<a href="#l6.1106"></a><span id="l6.1106" class="difflineminus">-           *  |persistTabs|.  This is currently a synchronous operation, but in</span>
<a href="#l6.1107"></a><span id="l6.1107" class="difflineminus">-           *  the future this may kick off an asynchronous mechanism to restore</span>
<a href="#l6.1108"></a><span id="l6.1108" class="difflineminus">-           *  the tabs one-by-one.</span>
<a href="#l6.1109"></a><span id="l6.1109" class="difflineminus">-           */</span>
<a href="#l6.1110"></a><span id="l6.1110" class="difflineminus">-          let tabs = aPersistedState.tabs;</span>
<a href="#l6.1111"></a><span id="l6.1111" class="difflineminus">-          let indexToSelect = null;</span>
<a href="#l6.1112"></a><span id="l6.1112" class="difflineminus">-          for (let [iTab, tabState] of tabs.entries()) {</span>
<a href="#l6.1113"></a><span id="l6.1113" class="difflineminus">-            if (tabState.state.firstTab &amp;&amp; aDontRestoreFirstTab)</span>
<a href="#l6.1114"></a><span id="l6.1114" class="difflineminus">-              tabState.state.dontRestoreFirstTab = aDontRestoreFirstTab;</span>
<a href="#l6.1115"></a><span id="l6.1115" class="difflineminus">-</span>
<a href="#l6.1116"></a><span id="l6.1116" class="difflineminus">-            if (!this.restoreTab(tabState))</span>
<a href="#l6.1117"></a><span id="l6.1117" class="difflineminus">-              continue;</span>
<a href="#l6.1118"></a><span id="l6.1118" class="difflineminus">-</span>
<a href="#l6.1119"></a><span id="l6.1119" class="difflineminus">-            // If this persisted tab was the selected one, then mark the newest</span>
<a href="#l6.1120"></a><span id="l6.1120" class="difflineminus">-            //  tab as the guy to select.</span>
<a href="#l6.1121"></a><span id="l6.1121" class="difflineminus">-            if (iTab == aPersistedState.selectedIndex)</span>
<a href="#l6.1122"></a><span id="l6.1122" class="difflineminus">-              indexToSelect = this.tabInfo.length - 1;</span>
<a href="#l6.1123"></a><span id="l6.1123" class="difflineminus">-          }</span>
<a href="#l6.1124"></a><span id="l6.1124" class="difflineminus">-</span>
<a href="#l6.1125"></a><span id="l6.1125" class="difflineminus">-          if (indexToSelect != null &amp;&amp; !aDontRestoreFirstTab)</span>
<a href="#l6.1126"></a><span id="l6.1126" class="difflineminus">-            this.tabContainer.selectedIndex = indexToSelect;</span>
<a href="#l6.1127"></a><span id="l6.1127" class="difflineminus">-          else</span>
<a href="#l6.1128"></a><span id="l6.1128" class="difflineminus">-            this.tabContainer.selectedIndex = 0;</span>
<a href="#l6.1129"></a><span id="l6.1129" class="difflineminus">-        ]]&gt;&lt;/body&gt;</span>
<a href="#l6.1130"></a><span id="l6.1130" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l6.1131"></a><span id="l6.1131" class="difflineminus">-      &lt;method name=&quot;clearRecentlyClosedTabs&quot;&gt;</span>
<a href="#l6.1132"></a><span id="l6.1132" class="difflineminus">-        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l6.1133"></a><span id="l6.1133" class="difflineminus">-          this.recentlyClosedTabs.length = 0;</span>
<a href="#l6.1134"></a><span id="l6.1134" class="difflineminus">-        ]]&gt;&lt;/body&gt;</span>
<a href="#l6.1135"></a><span id="l6.1135" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l6.1136"></a><span id="l6.1136" class="difflineminus">-</span>
<a href="#l6.1137"></a><span id="l6.1137" class="difflineminus">-      &lt;!-- Called when the window is being unloaded, this calls the close</span>
<a href="#l6.1138"></a><span id="l6.1138" class="difflineminus">-           function for every tab. --&gt;</span>
<a href="#l6.1139"></a><span id="l6.1139" class="difflineminus">-      &lt;method name=&quot;_teardown&quot;&gt;</span>
<a href="#l6.1140"></a><span id="l6.1140" class="difflineminus">-        &lt;body&gt;</span>
<a href="#l6.1141"></a><span id="l6.1141" class="difflineminus">-          &lt;![CDATA[</span>
<a href="#l6.1142"></a><span id="l6.1142" class="difflineminus">-            for (var i = 0; i &lt; this.tabInfo.length; i++) {</span>
<a href="#l6.1143"></a><span id="l6.1143" class="difflineminus">-              let tab = this.tabInfo[i];</span>
<a href="#l6.1144"></a><span id="l6.1144" class="difflineminus">-</span>
<a href="#l6.1145"></a><span id="l6.1145" class="difflineminus">-              let tabCloseFunc = tab.mode.closeTab || tab.mode.tabType.closeTab;</span>
<a href="#l6.1146"></a><span id="l6.1146" class="difflineminus">-              tabCloseFunc.call(tab.mode.tabType, tab);</span>
<a href="#l6.1147"></a><span id="l6.1147" class="difflineminus">-            }</span>
<a href="#l6.1148"></a><span id="l6.1148" class="difflineminus">-          ]]&gt;</span>
<a href="#l6.1149"></a><span id="l6.1149" class="difflineminus">-        &lt;/body&gt;</span>
<a href="#l6.1150"></a><span id="l6.1150" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l6.1151"></a><span id="l6.1151" class="difflineminus">-</span>
<a href="#l6.1152"></a><span id="l6.1152" class="difflineminus">-      &lt;property name=&quot;selectedTab&quot;&gt;</span>
<a href="#l6.1153"></a><span id="l6.1153" class="difflineminus">-        &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l6.1154"></a><span id="l6.1154" class="difflineminus">-          if (!this.currentTabInfo)</span>
<a href="#l6.1155"></a><span id="l6.1155" class="difflineminus">-            this.currentTabInfo = this.tabInfo[0];</span>
<a href="#l6.1156"></a><span id="l6.1156" class="difflineminus">-</span>
<a href="#l6.1157"></a><span id="l6.1157" class="difflineminus">-          return this.currentTabInfo;</span>
<a href="#l6.1158"></a><span id="l6.1158" class="difflineminus">-        ]]&gt;&lt;/getter&gt;</span>
<a href="#l6.1159"></a><span id="l6.1159" class="difflineminus">-        &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l6.1160"></a><span id="l6.1160" class="difflineminus">-          this.switchToTab(val);</span>
<a href="#l6.1161"></a><span id="l6.1161" class="difflineminus">-        ]]&gt;&lt;/setter&gt;</span>
<a href="#l6.1162"></a><span id="l6.1162" class="difflineminus">-      &lt;/property&gt;</span>
<a href="#l6.1163"></a><span id="l6.1163" class="difflineminus">-</span>
<a href="#l6.1164"></a><span id="l6.1164" class="difflineminus">-      &lt;property name=&quot;selectedBrowser&quot; onget=&quot;return this.getBrowserForSelectedTab();&quot; /&gt;</span>
<a href="#l6.1165"></a><span id="l6.1165" class="difflineminus">-</span>
<a href="#l6.1166"></a><span id="l6.1166" class="difflineminus">-      &lt;!-- getBrowserForSelectedTab is required as some toolkit functions</span>
<a href="#l6.1167"></a><span id="l6.1167" class="difflineminus">-           require a getBrowser() function. --&gt;</span>
<a href="#l6.1168"></a><span id="l6.1168" class="difflineminus">-      &lt;method name=&quot;getBrowserForSelectedTab&quot;&gt;</span>
<a href="#l6.1169"></a><span id="l6.1169" class="difflineminus">-        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l6.1170"></a><span id="l6.1170" class="difflineminus">-          if (!this.currentTabInfo)</span>
<a href="#l6.1171"></a><span id="l6.1171" class="difflineminus">-            this.currentTabInfo = this.tabInfo[0];</span>
<a href="#l6.1172"></a><span id="l6.1172" class="difflineminus">-</span>
<a href="#l6.1173"></a><span id="l6.1173" class="difflineminus">-          let tab = this.currentTabInfo;</span>
<a href="#l6.1174"></a><span id="l6.1174" class="difflineminus">-          if (!tab)</span>
<a href="#l6.1175"></a><span id="l6.1175" class="difflineminus">-            return null;</span>
<a href="#l6.1176"></a><span id="l6.1176" class="difflineminus">-</span>
<a href="#l6.1177"></a><span id="l6.1177" class="difflineminus">-          return this.getBrowserForTab(tab);</span>
<a href="#l6.1178"></a><span id="l6.1178" class="difflineminus">-        ]]&gt;&lt;/body&gt;</span>
<a href="#l6.1179"></a><span id="l6.1179" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l6.1180"></a><span id="l6.1180" class="difflineminus">-</span>
<a href="#l6.1181"></a><span id="l6.1181" class="difflineminus">-      &lt;method name=&quot;getBrowserForTab&quot;&gt;</span>
<a href="#l6.1182"></a><span id="l6.1182" class="difflineminus">-        &lt;parameter name=&quot;aTab&quot;/&gt;</span>
<a href="#l6.1183"></a><span id="l6.1183" class="difflineminus">-        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l6.1184"></a><span id="l6.1184" class="difflineminus">-          let browserFunc = aTab ? aTab.mode.getBrowser || aTab.mode.tabType.getBrowser : null;</span>
<a href="#l6.1185"></a><span id="l6.1185" class="difflineminus">-          return browserFunc ? browserFunc.call(aTab.mode.tabType, aTab) : null;</span>
<a href="#l6.1186"></a><span id="l6.1186" class="difflineminus">-        ]]&gt;&lt;/body&gt;</span>
<a href="#l6.1187"></a><span id="l6.1187" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l6.1188"></a><span id="l6.1188" class="difflineminus">-</span>
<a href="#l6.1189"></a><span id="l6.1189" class="difflineminus">-      &lt;!-- getBrowserForDocument is used to find the browser for a specific</span>
<a href="#l6.1190"></a><span id="l6.1190" class="difflineminus">-           document that's been loaded --&gt;</span>
<a href="#l6.1191"></a><span id="l6.1191" class="difflineminus">-      &lt;method name=&quot;getBrowserForDocument&quot;&gt;</span>
<a href="#l6.1192"></a><span id="l6.1192" class="difflineminus">-        &lt;parameter name=&quot;aDocument&quot;/&gt;</span>
<a href="#l6.1193"></a><span id="l6.1193" class="difflineminus">-        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l6.1194"></a><span id="l6.1194" class="difflineminus">-          for (let i = 0; i &lt; this.tabInfo.length; ++i) {</span>
<a href="#l6.1195"></a><span id="l6.1195" class="difflineminus">-            let browserFunc = this.tabInfo[i].mode.getBrowser ||</span>
<a href="#l6.1196"></a><span id="l6.1196" class="difflineminus">-                              this.tabInfo[i].mode.tabType.getBrowser;</span>
<a href="#l6.1197"></a><span id="l6.1197" class="difflineminus">-            if (browserFunc) {</span>
<a href="#l6.1198"></a><span id="l6.1198" class="difflineminus">-              let possBrowser = browserFunc.call(this.tabInfo[i].mode.tabType,</span>
<a href="#l6.1199"></a><span id="l6.1199" class="difflineminus">-                                                 this.tabInfo[i]);</span>
<a href="#l6.1200"></a><span id="l6.1200" class="difflineminus">-              if (possBrowser &amp;&amp;</span>
<a href="#l6.1201"></a><span id="l6.1201" class="difflineminus">-                  possBrowser.contentWindow == aDocument)</span>
<a href="#l6.1202"></a><span id="l6.1202" class="difflineminus">-                return this.tabInfo[i];</span>
<a href="#l6.1203"></a><span id="l6.1203" class="difflineminus">-            }</span>
<a href="#l6.1204"></a><span id="l6.1204" class="difflineminus">-          }</span>
<a href="#l6.1205"></a><span id="l6.1205" class="difflineminus">-          return null;</span>
<a href="#l6.1206"></a><span id="l6.1206" class="difflineminus">-        ]]&gt;&lt;/body&gt;</span>
<a href="#l6.1207"></a><span id="l6.1207" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l6.1208"></a><span id="l6.1208" class="difflineminus">-      &lt;!-- getBrowserForDocumentId is used to find the browser for a specific</span>
<a href="#l6.1209"></a><span id="l6.1209" class="difflineminus">-           document via its id attribute --&gt;</span>
<a href="#l6.1210"></a><span id="l6.1210" class="difflineminus">-      &lt;method name=&quot;getBrowserForDocumentId&quot;&gt;</span>
<a href="#l6.1211"></a><span id="l6.1211" class="difflineminus">-        &lt;parameter name=&quot;aDocumentId&quot;/&gt;</span>
<a href="#l6.1212"></a><span id="l6.1212" class="difflineminus">-        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l6.1213"></a><span id="l6.1213" class="difflineminus">-          for (let i = 0; i &lt; this.tabInfo.length; ++i) {</span>
<a href="#l6.1214"></a><span id="l6.1214" class="difflineminus">-            let browserFunc = this.tabInfo[i].mode.getBrowser ||</span>
<a href="#l6.1215"></a><span id="l6.1215" class="difflineminus">-                              this.tabInfo[i].mode.tabType.getBrowser;</span>
<a href="#l6.1216"></a><span id="l6.1216" class="difflineminus">-            if (browserFunc) {</span>
<a href="#l6.1217"></a><span id="l6.1217" class="difflineminus">-              let possBrowser = browserFunc.call(this.tabInfo[i].mode.tabType,</span>
<a href="#l6.1218"></a><span id="l6.1218" class="difflineminus">-                                                 this.tabInfo[i]);</span>
<a href="#l6.1219"></a><span id="l6.1219" class="difflineminus">-              if (possBrowser &amp;&amp;</span>
<a href="#l6.1220"></a><span id="l6.1220" class="difflineminus">-                  possBrowser.contentDocument.documentElement.id == aDocumentId)</span>
<a href="#l6.1221"></a><span id="l6.1221" class="difflineminus">-                return this.tabInfo[i];</span>
<a href="#l6.1222"></a><span id="l6.1222" class="difflineminus">-            }</span>
<a href="#l6.1223"></a><span id="l6.1223" class="difflineminus">-          }</span>
<a href="#l6.1224"></a><span id="l6.1224" class="difflineminus">-          return null;</span>
<a href="#l6.1225"></a><span id="l6.1225" class="difflineminus">-        ]]&gt;&lt;/body&gt;</span>
<a href="#l6.1226"></a><span id="l6.1226" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l6.1227"></a><span id="l6.1227" class="difflineminus">-      &lt;method name=&quot;getTabForBrowser&quot;&gt;</span>
<a href="#l6.1228"></a><span id="l6.1228" class="difflineminus">-        &lt;parameter name=&quot;aBrowser&quot;/&gt;</span>
<a href="#l6.1229"></a><span id="l6.1229" class="difflineminus">-        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l6.1230"></a><span id="l6.1230" class="difflineminus">-          for (let tabInfo of this.tabInfo) {</span>
<a href="#l6.1231"></a><span id="l6.1231" class="difflineminus">-            if (this.getBrowserForTab(tabInfo) == aBrowser) {</span>
<a href="#l6.1232"></a><span id="l6.1232" class="difflineminus">-              return tabInfo;</span>
<a href="#l6.1233"></a><span id="l6.1233" class="difflineminus">-            }</span>
<a href="#l6.1234"></a><span id="l6.1234" class="difflineminus">-          }</span>
<a href="#l6.1235"></a><span id="l6.1235" class="difflineminus">-          return null;</span>
<a href="#l6.1236"></a><span id="l6.1236" class="difflineminus">-        ]]&gt;&lt;/body&gt;</span>
<a href="#l6.1237"></a><span id="l6.1237" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l6.1238"></a><span id="l6.1238" class="difflineminus">-      &lt;method name=&quot;removeCurrentTab&quot;&gt;</span>
<a href="#l6.1239"></a><span id="l6.1239" class="difflineminus">-        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l6.1240"></a><span id="l6.1240" class="difflineminus">-          this.removeTabByNode(</span>
<a href="#l6.1241"></a><span id="l6.1241" class="difflineminus">-            this.tabContainer.allTabs[this.tabContainer.selectedIndex]);</span>
<a href="#l6.1242"></a><span id="l6.1242" class="difflineminus">-        ]]&gt;&lt;/body&gt;</span>
<a href="#l6.1243"></a><span id="l6.1243" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l6.1244"></a><span id="l6.1244" class="difflineminus">-      &lt;method name=&quot;switchToTab&quot;&gt;</span>
<a href="#l6.1245"></a><span id="l6.1245" class="difflineminus">-        &lt;parameter name=&quot;aTabIndexNodeOrInfo&quot;/&gt;</span>
<a href="#l6.1246"></a><span id="l6.1246" class="difflineminus">-        &lt;body&gt;</span>
<a href="#l6.1247"></a><span id="l6.1247" class="difflineminus">-          &lt;![CDATA[</span>
<a href="#l6.1248"></a><span id="l6.1248" class="difflineminus">-            let [iTab] =</span>
<a href="#l6.1249"></a><span id="l6.1249" class="difflineminus">-              this._getTabContextForTabbyThing(aTabIndexNodeOrInfo, false);</span>
<a href="#l6.1250"></a><span id="l6.1250" class="difflineminus">-</span>
<a href="#l6.1251"></a><span id="l6.1251" class="difflineminus">-            this.tabContainer.selectedIndex = iTab;</span>
<a href="#l6.1252"></a><span id="l6.1252" class="difflineminus">-          ]]&gt;</span>
<a href="#l6.1253"></a><span id="l6.1253" class="difflineminus">-        &lt;/body&gt;</span>
<a href="#l6.1254"></a><span id="l6.1254" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l6.1255"></a><span id="l6.1255" class="difflineminus">-      &lt;!--  UpdateCurrentTab - called in response to changing the current tab --&gt;</span>
<a href="#l6.1256"></a><span id="l6.1256" class="difflineminus">-      &lt;method name=&quot;updateCurrentTab&quot;&gt;</span>
<a href="#l6.1257"></a><span id="l6.1257" class="difflineminus">-        &lt;body&gt;</span>
<a href="#l6.1258"></a><span id="l6.1258" class="difflineminus">-          &lt;![CDATA[</span>
<a href="#l6.1259"></a><span id="l6.1259" class="difflineminus">-            if (this.currentTabInfo != this.tabInfo[this.tabContainer.selectedIndex]) {</span>
<a href="#l6.1260"></a><span id="l6.1260" class="difflineminus">-              if (this.currentTabInfo)</span>
<a href="#l6.1261"></a><span id="l6.1261" class="difflineminus">-                this.saveCurrentTabState();</span>
<a href="#l6.1262"></a><span id="l6.1262" class="difflineminus">-</span>
<a href="#l6.1263"></a><span id="l6.1263" class="difflineminus">-              let oldTab = this.currentTabInfo;</span>
<a href="#l6.1264"></a><span id="l6.1264" class="difflineminus">-              let oldPanel = [...this.panelContainer.children].find(p =&gt; p.hasAttribute(&quot;selected&quot;));</span>
<a href="#l6.1265"></a><span id="l6.1265" class="difflineminus">-              let tab = this.currentTabInfo =</span>
<a href="#l6.1266"></a><span id="l6.1266" class="difflineminus">-                this.tabInfo[this.tabContainer.selectedIndex];</span>
<a href="#l6.1267"></a><span id="l6.1267" class="difflineminus">-</span>
<a href="#l6.1268"></a><span id="l6.1268" class="difflineminus">-              // Update the selected attribute on the current and old tab panel.</span>
<a href="#l6.1269"></a><span id="l6.1269" class="difflineminus">-              if (oldPanel) {</span>
<a href="#l6.1270"></a><span id="l6.1270" class="difflineminus">-                oldPanel.removeAttribute(&quot;selected&quot;);</span>
<a href="#l6.1271"></a><span id="l6.1271" class="difflineminus">-              }</span>
<a href="#l6.1272"></a><span id="l6.1272" class="difflineminus">-              this.panelContainer.selectedPanel.setAttribute(&quot;selected&quot;, &quot;true&quot;);</span>
<a href="#l6.1273"></a><span id="l6.1273" class="difflineminus">-</span>
<a href="#l6.1274"></a><span id="l6.1274" class="difflineminus">-              let showTabFunc = tab.mode.showTab || tab.mode.tabType.showTab;</span>
<a href="#l6.1275"></a><span id="l6.1275" class="difflineminus">-              showTabFunc.call(tab.mode.tabType, tab);</span>
<a href="#l6.1276"></a><span id="l6.1276" class="difflineminus">-</span>
<a href="#l6.1277"></a><span id="l6.1277" class="difflineminus">-              for (let tabMonitor of this.tabMonitors) {</span>
<a href="#l6.1278"></a><span id="l6.1278" class="difflineminus">-                tabMonitor.onTabSwitched(tab, oldTab);</span>
<a href="#l6.1279"></a><span id="l6.1279" class="difflineminus">-              }</span>
<a href="#l6.1280"></a><span id="l6.1280" class="difflineminus">-</span>
<a href="#l6.1281"></a><span id="l6.1281" class="difflineminus">-              // always update the cursor status when we switch tabs</span>
<a href="#l6.1282"></a><span id="l6.1282" class="difflineminus">-              SetBusyCursor(window, tab.busy);</span>
<a href="#l6.1283"></a><span id="l6.1283" class="difflineminus">-              // active tabs should not have the wasBusy attribute</span>
<a href="#l6.1284"></a><span id="l6.1284" class="difflineminus">-              this.tabContainer.selectedItem.removeAttribute(&quot;wasBusy&quot;);</span>
<a href="#l6.1285"></a><span id="l6.1285" class="difflineminus">-</span>
<a href="#l6.1286"></a><span id="l6.1286" class="difflineminus">-              // update the thinking status when we switch tabs</span>
<a href="#l6.1287"></a><span id="l6.1287" class="difflineminus">-              this._setActiveThinkingState(tab.thinking);</span>
<a href="#l6.1288"></a><span id="l6.1288" class="difflineminus">-              // active tabs should not have the wasThinking attribute</span>
<a href="#l6.1289"></a><span id="l6.1289" class="difflineminus">-              this.tabContainer.selectedItem.removeAttribute(&quot;wasThinking&quot;);</span>
<a href="#l6.1290"></a><span id="l6.1290" class="difflineminus">-</span>
<a href="#l6.1291"></a><span id="l6.1291" class="difflineminus">-              this.setDocumentTitle(tab);</span>
<a href="#l6.1292"></a><span id="l6.1292" class="difflineminus">-</span>
<a href="#l6.1293"></a><span id="l6.1293" class="difflineminus">-              // Update the toolbar status - we don't need to do menus as they</span>
<a href="#l6.1294"></a><span id="l6.1294" class="difflineminus">-              // do themselves when we open them.</span>
<a href="#l6.1295"></a><span id="l6.1295" class="difflineminus">-              UpdateMailToolbar(&quot;tabmail&quot;);</span>
<a href="#l6.1296"></a><span id="l6.1296" class="difflineminus">-</span>
<a href="#l6.1297"></a><span id="l6.1297" class="difflineminus">-              // We switched tabs, so we don't need to know the last tab</span>
<a href="#l6.1298"></a><span id="l6.1298" class="difflineminus">-              // opener anymore.</span>
<a href="#l6.1299"></a><span id="l6.1299" class="difflineminus">-              this.mLastTabOpener = null;</span>
<a href="#l6.1300"></a><span id="l6.1300" class="difflineminus">-</span>
<a href="#l6.1301"></a><span id="l6.1301" class="difflineminus">-              let evt = new CustomEvent(&quot;TabSelect&quot;, { bubbles: true, detail: { tabInfo: tab } });</span>
<a href="#l6.1302"></a><span id="l6.1302" class="difflineminus">-              this.tabContainer.selectedItem.dispatchEvent(evt);</span>
<a href="#l6.1303"></a><span id="l6.1303" class="difflineminus">-            }</span>
<a href="#l6.1304"></a><span id="l6.1304" class="difflineminus">-          ]]&gt;</span>
<a href="#l6.1305"></a><span id="l6.1305" class="difflineminus">-        &lt;/body&gt;</span>
<a href="#l6.1306"></a><span id="l6.1306" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l6.1307"></a><span id="l6.1307" class="difflineminus">-      &lt;method name=&quot;saveCurrentTabState&quot;&gt;</span>
<a href="#l6.1308"></a><span id="l6.1308" class="difflineminus">-        &lt;body&gt;</span>
<a href="#l6.1309"></a><span id="l6.1309" class="difflineminus">-          &lt;![CDATA[</span>
<a href="#l6.1310"></a><span id="l6.1310" class="difflineminus">-            if (!this.currentTabInfo)</span>
<a href="#l6.1311"></a><span id="l6.1311" class="difflineminus">-              this.currentTabInfo = this.tabInfo[0];</span>
<a href="#l6.1312"></a><span id="l6.1312" class="difflineminus">-            let tab = this.currentTabInfo;</span>
<a href="#l6.1313"></a><span id="l6.1313" class="difflineminus">-</span>
<a href="#l6.1314"></a><span id="l6.1314" class="difflineminus">-            // save the old tab state before we change the current tab</span>
<a href="#l6.1315"></a><span id="l6.1315" class="difflineminus">-            let saveTabFunc = tab.mode.saveTabState ||</span>
<a href="#l6.1316"></a><span id="l6.1316" class="difflineminus">-                              tab.mode.tabType.saveTabState;</span>
<a href="#l6.1317"></a><span id="l6.1317" class="difflineminus">-            saveTabFunc.call(tab.mode.tabType, tab);</span>
<a href="#l6.1318"></a><span id="l6.1318" class="difflineminus">-          ]]&gt;</span>
<a href="#l6.1319"></a><span id="l6.1319" class="difflineminus">-        &lt;/body&gt;</span>
<a href="#l6.1320"></a><span id="l6.1320" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l6.1321"></a><span id="l6.1321" class="difflineminus">-      &lt;method name=&quot;onTabClick&quot;&gt;</span>
<a href="#l6.1322"></a><span id="l6.1322" class="difflineminus">-        &lt;parameter name=&quot;event&quot;/&gt;</span>
<a href="#l6.1323"></a><span id="l6.1323" class="difflineminus">-        &lt;body&gt;</span>
<a href="#l6.1324"></a><span id="l6.1324" class="difflineminus">-          &lt;![CDATA[</span>
<a href="#l6.1325"></a><span id="l6.1325" class="difflineminus">-            // a middle mouse button click on a tab is a short cut for closing a tab</span>
<a href="#l6.1326"></a><span id="l6.1326" class="difflineminus">-            if (event.button != 1 || document.tab.localName != &quot;tab&quot;)</span>
<a href="#l6.1327"></a><span id="l6.1327" class="difflineminus">-              return;</span>
<a href="#l6.1328"></a><span id="l6.1328" class="difflineminus">-            this.removeTabByNode(document.tab);</span>
<a href="#l6.1329"></a><span id="l6.1329" class="difflineminus">-            event.stopPropagation();</span>
<a href="#l6.1330"></a><span id="l6.1330" class="difflineminus">-          ]]&gt;</span>
<a href="#l6.1331"></a><span id="l6.1331" class="difflineminus">-        &lt;/body&gt;</span>
<a href="#l6.1332"></a><span id="l6.1332" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l6.1333"></a><span id="l6.1333" class="difflineminus">-      &lt;method name=&quot;setTabTitle&quot;&gt;</span>
<a href="#l6.1334"></a><span id="l6.1334" class="difflineminus">-        &lt;parameter name=&quot;aTabNodeOrInfo&quot;/&gt;</span>
<a href="#l6.1335"></a><span id="l6.1335" class="difflineminus">-        &lt;body&gt;</span>
<a href="#l6.1336"></a><span id="l6.1336" class="difflineminus">-          &lt;![CDATA[</span>
<a href="#l6.1337"></a><span id="l6.1337" class="difflineminus">-            let [iTab, tab] =</span>
<a href="#l6.1338"></a><span id="l6.1338" class="difflineminus">-              this._getTabContextForTabbyThing(aTabNodeOrInfo, true);</span>
<a href="#l6.1339"></a><span id="l6.1339" class="difflineminus">-</span>
<a href="#l6.1340"></a><span id="l6.1340" class="difflineminus">-            if (tab) {</span>
<a href="#l6.1341"></a><span id="l6.1341" class="difflineminus">-              let tabNode =</span>
<a href="#l6.1342"></a><span id="l6.1342" class="difflineminus">-                this.tabContainer.allTabs[iTab];</span>
<a href="#l6.1343"></a><span id="l6.1343" class="difflineminus">-</span>
<a href="#l6.1344"></a><span id="l6.1344" class="difflineminus">-              let titleChangeFunc = tab.mode.onTitleChanged ||</span>
<a href="#l6.1345"></a><span id="l6.1345" class="difflineminus">-                                    tab.mode.tabType.onTitleChanged;</span>
<a href="#l6.1346"></a><span id="l6.1346" class="difflineminus">-              if (titleChangeFunc) {</span>
<a href="#l6.1347"></a><span id="l6.1347" class="difflineminus">-                titleChangeFunc.call(tab.mode.tabType, tab, tabNode);</span>
<a href="#l6.1348"></a><span id="l6.1348" class="difflineminus">-              }</span>
<a href="#l6.1349"></a><span id="l6.1349" class="difflineminus">-</span>
<a href="#l6.1350"></a><span id="l6.1350" class="difflineminus">-              let defaultTabTitle = document.documentElement.getAttribute(&quot;defaultTabTitle&quot;);</span>
<a href="#l6.1351"></a><span id="l6.1351" class="difflineminus">-              let oldLabel = tabNode.getAttribute(&quot;label&quot;);</span>
<a href="#l6.1352"></a><span id="l6.1352" class="difflineminus">-              let newLabel = aTabNodeOrInfo ? tab.title : defaultTabTitle;</span>
<a href="#l6.1353"></a><span id="l6.1353" class="difflineminus">-</span>
<a href="#l6.1354"></a><span id="l6.1354" class="difflineminus">-              if (oldLabel == newLabel) {</span>
<a href="#l6.1355"></a><span id="l6.1355" class="difflineminus">-                return;</span>
<a href="#l6.1356"></a><span id="l6.1356" class="difflineminus">-              }</span>
<a href="#l6.1357"></a><span id="l6.1357" class="difflineminus">-</span>
<a href="#l6.1358"></a><span id="l6.1358" class="difflineminus">-              for (let tabMonitor of this.tabMonitors) {</span>
<a href="#l6.1359"></a><span id="l6.1359" class="difflineminus">-                tabMonitor.onTabTitleChanged(tab);</span>
<a href="#l6.1360"></a><span id="l6.1360" class="difflineminus">-              }</span>
<a href="#l6.1361"></a><span id="l6.1361" class="difflineminus">-</span>
<a href="#l6.1362"></a><span id="l6.1362" class="difflineminus">-              // If the displayed tab is the one at the moment of creation</span>
<a href="#l6.1363"></a><span id="l6.1363" class="difflineminus">-              // (aTabNodeOrInfo is null), set the default title as its title.</span>
<a href="#l6.1364"></a><span id="l6.1364" class="difflineminus">-              tabNode.setAttribute(&quot;label&quot;, newLabel);</span>
<a href="#l6.1365"></a><span id="l6.1365" class="difflineminus">-</span>
<a href="#l6.1366"></a><span id="l6.1366" class="difflineminus">-              // Update the window title if we're the displayed tab.</span>
<a href="#l6.1367"></a><span id="l6.1367" class="difflineminus">-              if (iTab == this.tabContainer.selectedIndex)</span>
<a href="#l6.1368"></a><span id="l6.1368" class="difflineminus">-                this.setDocumentTitle(tab);</span>
<a href="#l6.1369"></a><span id="l6.1369" class="difflineminus">-</span>
<a href="#l6.1370"></a><span id="l6.1370" class="difflineminus">-              // Notify tab title change</span>
<a href="#l6.1371"></a><span id="l6.1371" class="difflineminus">-              if (!tab.beforeTabOpen) {</span>
<a href="#l6.1372"></a><span id="l6.1372" class="difflineminus">-                let evt = new CustomEvent(&quot;TabAttrModified&quot;, {</span>
<a href="#l6.1373"></a><span id="l6.1373" class="difflineminus">-                  bubbles: true,</span>
<a href="#l6.1374"></a><span id="l6.1374" class="difflineminus">-                  cancelable: false,</span>
<a href="#l6.1375"></a><span id="l6.1375" class="difflineminus">-                  detail: { changed: [&quot;label&quot;], tabInfo: tab },</span>
<a href="#l6.1376"></a><span id="l6.1376" class="difflineminus">-                });</span>
<a href="#l6.1377"></a><span id="l6.1377" class="difflineminus">-                tabNode.dispatchEvent(evt);</span>
<a href="#l6.1378"></a><span id="l6.1378" class="difflineminus">-              }</span>
<a href="#l6.1379"></a><span id="l6.1379" class="difflineminus">-            }</span>
<a href="#l6.1380"></a><span id="l6.1380" class="difflineminus">-          ]]&gt;</span>
<a href="#l6.1381"></a><span id="l6.1381" class="difflineminus">-        &lt;/body&gt;</span>
<a href="#l6.1382"></a><span id="l6.1382" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l6.1383"></a><span id="l6.1383" class="difflineminus">-      &lt;!--</span>
<a href="#l6.1384"></a><span id="l6.1384" class="difflineminus">-        - Sets the tab icon to the specified url, or removes the icon if no</span>
<a href="#l6.1385"></a><span id="l6.1385" class="difflineminus">-        - url is specified. Note that this may override css provided images.</span>
<a href="#l6.1386"></a><span id="l6.1386" class="difflineminus">-        --&gt;</span>
<a href="#l6.1387"></a><span id="l6.1387" class="difflineminus">-      &lt;method name=&quot;setTabIcon&quot;&gt;</span>
<a href="#l6.1388"></a><span id="l6.1388" class="difflineminus">-        &lt;parameter name=&quot;aTabNodeOrInfo&quot;/&gt;</span>
<a href="#l6.1389"></a><span id="l6.1389" class="difflineminus">-        &lt;parameter name=&quot;aIcon&quot;/&gt;</span>
<a href="#l6.1390"></a><span id="l6.1390" class="difflineminus">-        &lt;body&gt;</span>
<a href="#l6.1391"></a><span id="l6.1391" class="difflineminus">-          &lt;![CDATA[</span>
<a href="#l6.1392"></a><span id="l6.1392" class="difflineminus">-            let [iTab, tab] =</span>
<a href="#l6.1393"></a><span id="l6.1393" class="difflineminus">-              this._getTabContextForTabbyThing(aTabNodeOrInfo, true);</span>
<a href="#l6.1394"></a><span id="l6.1394" class="difflineminus">-</span>
<a href="#l6.1395"></a><span id="l6.1395" class="difflineminus">-            if (tab) {</span>
<a href="#l6.1396"></a><span id="l6.1396" class="difflineminus">-              let tabNode = this.tabContainer.allTabs[iTab];</span>
<a href="#l6.1397"></a><span id="l6.1397" class="difflineminus">-              let oldIcon = tabNode.getAttribute(&quot;image&quot;);</span>
<a href="#l6.1398"></a><span id="l6.1398" class="difflineminus">-</span>
<a href="#l6.1399"></a><span id="l6.1399" class="difflineminus">-              if (oldIcon != aIcon &amp;&amp; !tab.beforeTabOpen) {</span>
<a href="#l6.1400"></a><span id="l6.1400" class="difflineminus">-                let evt = new CustomEvent(&quot;TabAttrModified&quot;, {</span>
<a href="#l6.1401"></a><span id="l6.1401" class="difflineminus">-                  bubbles: true,</span>
<a href="#l6.1402"></a><span id="l6.1402" class="difflineminus">-                  cancelable: false,</span>
<a href="#l6.1403"></a><span id="l6.1403" class="difflineminus">-                  detail: { changed: [&quot;image&quot;], tabInfo: tab },</span>
<a href="#l6.1404"></a><span id="l6.1404" class="difflineminus">-                });</span>
<a href="#l6.1405"></a><span id="l6.1405" class="difflineminus">-                tabNode.dispatchEvent(evt);</span>
<a href="#l6.1406"></a><span id="l6.1406" class="difflineminus">-              }</span>
<a href="#l6.1407"></a><span id="l6.1407" class="difflineminus">-</span>
<a href="#l6.1408"></a><span id="l6.1408" class="difflineminus">-              if (aIcon)</span>
<a href="#l6.1409"></a><span id="l6.1409" class="difflineminus">-                tabNode.setAttribute(&quot;image&quot;, aIcon);</span>
<a href="#l6.1410"></a><span id="l6.1410" class="difflineminus">-              else</span>
<a href="#l6.1411"></a><span id="l6.1411" class="difflineminus">-                tabNode.removeAttribute(&quot;image&quot;);</span>
<a href="#l6.1412"></a><span id="l6.1412" class="difflineminus">-            }</span>
<a href="#l6.1413"></a><span id="l6.1413" class="difflineminus">-          ]]&gt;</span>
<a href="#l6.1414"></a><span id="l6.1414" class="difflineminus">-        &lt;/body&gt;</span>
<a href="#l6.1415"></a><span id="l6.1415" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l6.1416"></a><span id="l6.1416" class="difflineminus">-      &lt;!--</span>
<a href="#l6.1417"></a><span id="l6.1417" class="difflineminus">-        - Updates the global state to reflect the active tab's thinking</span>
<a href="#l6.1418"></a><span id="l6.1418" class="difflineminus">-        -   state (which the caller provides).</span>
<a href="#l6.1419"></a><span id="l6.1419" class="difflineminus">-        --&gt;</span>
<a href="#l6.1420"></a><span id="l6.1420" class="difflineminus">-      &lt;method name=&quot;_setActiveThinkingState&quot;&gt;</span>
<a href="#l6.1421"></a><span id="l6.1421" class="difflineminus">-        &lt;parameter name=&quot;aThinkingState&quot;/&gt;</span>
<a href="#l6.1422"></a><span id="l6.1422" class="difflineminus">-        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l6.1423"></a><span id="l6.1423" class="difflineminus">-          if (aThinkingState) {</span>
<a href="#l6.1424"></a><span id="l6.1424" class="difflineminus">-            statusFeedback.showProgress(0);</span>
<a href="#l6.1425"></a><span id="l6.1425" class="difflineminus">-            if (typeof(aThinkingState) == &quot;string&quot;)</span>
<a href="#l6.1426"></a><span id="l6.1426" class="difflineminus">-              statusFeedback.showStatusString(aThinkingState);</span>
<a href="#l6.1427"></a><span id="l6.1427" class="difflineminus">-            gStatusBar.removeAttribute(&quot;value&quot;);</span>
<a href="#l6.1428"></a><span id="l6.1428" class="difflineminus">-          } else {</span>
<a href="#l6.1429"></a><span id="l6.1429" class="difflineminus">-            statusFeedback.showProgress(0);</span>
<a href="#l6.1430"></a><span id="l6.1430" class="difflineminus">-            gStatusBar.value = 0;</span>
<a href="#l6.1431"></a><span id="l6.1431" class="difflineminus">-          }</span>
<a href="#l6.1432"></a><span id="l6.1432" class="difflineminus">-        ]]&gt;&lt;/body&gt;</span>
<a href="#l6.1433"></a><span id="l6.1433" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l6.1434"></a><span id="l6.1434" class="difflineminus">-      &lt;method name=&quot;setTabThinking&quot;&gt;</span>
<a href="#l6.1435"></a><span id="l6.1435" class="difflineminus">-        &lt;parameter name=&quot;aTabNodeOrInfo&quot;/&gt;</span>
<a href="#l6.1436"></a><span id="l6.1436" class="difflineminus">-        &lt;parameter name=&quot;aThinking&quot;/&gt;</span>
<a href="#l6.1437"></a><span id="l6.1437" class="difflineminus">-        &lt;body&gt;</span>
<a href="#l6.1438"></a><span id="l6.1438" class="difflineminus">-          &lt;![CDATA[</span>
<a href="#l6.1439"></a><span id="l6.1439" class="difflineminus">-            let [iTab, tab, tabNode] = this._getTabContextForTabbyThing(</span>
<a href="#l6.1440"></a><span id="l6.1440" class="difflineminus">-                                         aTabNodeOrInfo, false);</span>
<a href="#l6.1441"></a><span id="l6.1441" class="difflineminus">-            let isSelected = (iTab == this.tabContainer.selectedIndex);</span>
<a href="#l6.1442"></a><span id="l6.1442" class="difflineminus">-</span>
<a href="#l6.1443"></a><span id="l6.1443" class="difflineminus">-            // if we are the current tab, update the cursor</span>
<a href="#l6.1444"></a><span id="l6.1444" class="difflineminus">-            if (isSelected)</span>
<a href="#l6.1445"></a><span id="l6.1445" class="difflineminus">-              this._setActiveThinkingState(aThinking);</span>
<a href="#l6.1446"></a><span id="l6.1446" class="difflineminus">-</span>
<a href="#l6.1447"></a><span id="l6.1447" class="difflineminus">-            // if we are busy, hint our tab</span>
<a href="#l6.1448"></a><span id="l6.1448" class="difflineminus">-            if (aThinking) {</span>
<a href="#l6.1449"></a><span id="l6.1449" class="difflineminus">-              tabNode.setAttribute(&quot;thinking&quot;, &quot;true&quot;);</span>
<a href="#l6.1450"></a><span id="l6.1450" class="difflineminus">-            } else {</span>
<a href="#l6.1451"></a><span id="l6.1451" class="difflineminus">-              // if we were thinking and are not selected, set the</span>
<a href="#l6.1452"></a><span id="l6.1452" class="difflineminus">-              //  &quot;wasThinking&quot; attribute.</span>
<a href="#l6.1453"></a><span id="l6.1453" class="difflineminus">-              if (tab.thinking &amp;&amp; !isSelected)</span>
<a href="#l6.1454"></a><span id="l6.1454" class="difflineminus">-                tabNode.setAttribute(&quot;wasThinking&quot;, &quot;true&quot;);</span>
<a href="#l6.1455"></a><span id="l6.1455" class="difflineminus">-              tabNode.removeAttribute(&quot;thinking&quot;);</span>
<a href="#l6.1456"></a><span id="l6.1456" class="difflineminus">-            }</span>
<a href="#l6.1457"></a><span id="l6.1457" class="difflineminus">-</span>
<a href="#l6.1458"></a><span id="l6.1458" class="difflineminus">-            // update the tab info to store the busy state.</span>
<a href="#l6.1459"></a><span id="l6.1459" class="difflineminus">-            tab.thinking = aThinking;</span>
<a href="#l6.1460"></a><span id="l6.1460" class="difflineminus">-          ]]&gt;</span>
<a href="#l6.1461"></a><span id="l6.1461" class="difflineminus">-        &lt;/body&gt;</span>
<a href="#l6.1462"></a><span id="l6.1462" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l6.1463"></a><span id="l6.1463" class="difflineminus">-      &lt;method name=&quot;setTabBusy&quot;&gt;</span>
<a href="#l6.1464"></a><span id="l6.1464" class="difflineminus">-        &lt;parameter name=&quot;aTabNodeOrInfo&quot;/&gt;</span>
<a href="#l6.1465"></a><span id="l6.1465" class="difflineminus">-        &lt;parameter name=&quot;aBusy&quot;/&gt;</span>
<a href="#l6.1466"></a><span id="l6.1466" class="difflineminus">-        &lt;body&gt;</span>
<a href="#l6.1467"></a><span id="l6.1467" class="difflineminus">-          &lt;![CDATA[</span>
<a href="#l6.1468"></a><span id="l6.1468" class="difflineminus">-            let [iTab, tab, tabNode] = this._getTabContextForTabbyThing(</span>
<a href="#l6.1469"></a><span id="l6.1469" class="difflineminus">-                                         aTabNodeOrInfo, false);</span>
<a href="#l6.1470"></a><span id="l6.1470" class="difflineminus">-            let isSelected = (iTab == this.tabContainer.selectedIndex);</span>
<a href="#l6.1471"></a><span id="l6.1471" class="difflineminus">-</span>
<a href="#l6.1472"></a><span id="l6.1472" class="difflineminus">-            // if we are the current tab, update the cursor</span>
<a href="#l6.1473"></a><span id="l6.1473" class="difflineminus">-            if (isSelected)</span>
<a href="#l6.1474"></a><span id="l6.1474" class="difflineminus">-              SetBusyCursor(window, aBusy);</span>
<a href="#l6.1475"></a><span id="l6.1475" class="difflineminus">-</span>
<a href="#l6.1476"></a><span id="l6.1476" class="difflineminus">-            // if we are busy, hint our tab</span>
<a href="#l6.1477"></a><span id="l6.1477" class="difflineminus">-            if (aBusy) {</span>
<a href="#l6.1478"></a><span id="l6.1478" class="difflineminus">-              tabNode.setAttribute(&quot;busy&quot;, &quot;true&quot;);</span>
<a href="#l6.1479"></a><span id="l6.1479" class="difflineminus">-            } else {</span>
<a href="#l6.1480"></a><span id="l6.1480" class="difflineminus">-              // if we were busy and are not selected, set the</span>
<a href="#l6.1481"></a><span id="l6.1481" class="difflineminus">-              //  &quot;wasBusy&quot; attribute.</span>
<a href="#l6.1482"></a><span id="l6.1482" class="difflineminus">-              if (tab.busy &amp;&amp; !isSelected)</span>
<a href="#l6.1483"></a><span id="l6.1483" class="difflineminus">-                tabNode.setAttribute(&quot;wasBusy&quot;, &quot;true&quot;);</span>
<a href="#l6.1484"></a><span id="l6.1484" class="difflineminus">-              tabNode.removeAttribute(&quot;busy&quot;);</span>
<a href="#l6.1485"></a><span id="l6.1485" class="difflineminus">-            }</span>
<a href="#l6.1486"></a><span id="l6.1486" class="difflineminus">-</span>
<a href="#l6.1487"></a><span id="l6.1487" class="difflineminus">-            // update the tab info to store the busy state.</span>
<a href="#l6.1488"></a><span id="l6.1488" class="difflineminus">-            tab.busy = aBusy;</span>
<a href="#l6.1489"></a><span id="l6.1489" class="difflineminus">-          ]]&gt;</span>
<a href="#l6.1490"></a><span id="l6.1490" class="difflineminus">-        &lt;/body&gt;</span>
<a href="#l6.1491"></a><span id="l6.1491" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l6.1492"></a><span id="l6.1492" class="difflineminus">-      &lt;method name=&quot;onTabContextMenuShowing&quot;&gt;</span>
<a href="#l6.1493"></a><span id="l6.1493" class="difflineminus">-        &lt;parameter name=&quot;aTabNode&quot;/&gt;</span>
<a href="#l6.1494"></a><span id="l6.1494" class="difflineminus">-        &lt;body&gt;</span>
<a href="#l6.1495"></a><span id="l6.1495" class="difflineminus">-          &lt;![CDATA[</span>
<a href="#l6.1496"></a><span id="l6.1496" class="difflineminus">-            // this happens when the user did not actually-click on a tab but</span>
<a href="#l6.1497"></a><span id="l6.1497" class="difflineminus">-            // instead on the strip behind it.</span>
<a href="#l6.1498"></a><span id="l6.1498" class="difflineminus">-            if (aTabNode.localName != &quot;tab&quot;)</span>
<a href="#l6.1499"></a><span id="l6.1499" class="difflineminus">-              return false;</span>
<a href="#l6.1500"></a><span id="l6.1500" class="difflineminus">-</span>
<a href="#l6.1501"></a><span id="l6.1501" class="difflineminus">-            let tabContextMenu = document.getElementById(&quot;tabContextMenu&quot;);</span>
<a href="#l6.1502"></a><span id="l6.1502" class="difflineminus">-</span>
<a href="#l6.1503"></a><span id="l6.1503" class="difflineminus">-            let tab = this._getTabContextForTabbyThing(aTabNode, true)[1];</span>
<a href="#l6.1504"></a><span id="l6.1504" class="difflineminus">-</span>
<a href="#l6.1505"></a><span id="l6.1505" class="difflineminus">-            // by default &quot;close other tabs&quot; is disabled...</span>
<a href="#l6.1506"></a><span id="l6.1506" class="difflineminus">-            tabContextMenu</span>
<a href="#l6.1507"></a><span id="l6.1507" class="difflineminus">-              .querySelector(`[anonid=&quot;closeOtherTabs&quot;]`)</span>
<a href="#l6.1508"></a><span id="l6.1508" class="difflineminus">-              .setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l6.1509"></a><span id="l6.1509" class="difflineminus">-</span>
<a href="#l6.1510"></a><span id="l6.1510" class="difflineminus">-            // ... except if we find at least one other tab that can be closed.</span>
<a href="#l6.1511"></a><span id="l6.1511" class="difflineminus">-            for (let i = 0; i &lt; this.tabInfo.length; i++) {</span>
<a href="#l6.1512"></a><span id="l6.1512" class="difflineminus">-              if (this.tabInfo[i].canClose &amp;&amp; this.tabInfo[i] != tab) {</span>
<a href="#l6.1513"></a><span id="l6.1513" class="difflineminus">-                tabContextMenu</span>
<a href="#l6.1514"></a><span id="l6.1514" class="difflineminus">-                  .querySelector(`[anonid=&quot;closeOtherTabs&quot;]`)</span>
<a href="#l6.1515"></a><span id="l6.1515" class="difflineminus">-                  .setAttribute(&quot;disabled&quot;, &quot;false&quot;);</span>
<a href="#l6.1516"></a><span id="l6.1516" class="difflineminus">-                break;</span>
<a href="#l6.1517"></a><span id="l6.1517" class="difflineminus">-              }</span>
<a href="#l6.1518"></a><span id="l6.1518" class="difflineminus">-            }</span>
<a href="#l6.1519"></a><span id="l6.1519" class="difflineminus">-</span>
<a href="#l6.1520"></a><span id="l6.1520" class="difflineminus">-</span>
<a href="#l6.1521"></a><span id="l6.1521" class="difflineminus">-            tabContextMenu</span>
<a href="#l6.1522"></a><span id="l6.1522" class="difflineminus">-              .querySelector(`[anonid=&quot;closeTab&quot;]`)</span>
<a href="#l6.1523"></a><span id="l6.1523" class="difflineminus">-              .setAttribute(&quot;disabled&quot;, tab.canClose ? &quot;false&quot; : &quot;true&quot;);</span>
<a href="#l6.1524"></a><span id="l6.1524" class="difflineminus">-</span>
<a href="#l6.1525"></a><span id="l6.1525" class="difflineminus">-            // enable &quot;Open in new Window&quot; iff tab is closable and...</span>
<a href="#l6.1526"></a><span id="l6.1526" class="difflineminus">-            // ... it can persist its state. Other wise it would get destroyed...</span>
<a href="#l6.1527"></a><span id="l6.1527" class="difflineminus">-            // ... while moving it to a new window.</span>
<a href="#l6.1528"></a><span id="l6.1528" class="difflineminus">-            tabContextMenu</span>
<a href="#l6.1529"></a><span id="l6.1529" class="difflineminus">-              .querySelector(`[anonid=&quot;openTabInWindow&quot;]`)</span>
<a href="#l6.1530"></a><span id="l6.1530" class="difflineminus">-              .setAttribute(&quot;disabled&quot;,</span>
<a href="#l6.1531"></a><span id="l6.1531" class="difflineminus">-                            (tab.canClose &amp;&amp; this.persistTab(tab)) ? &quot;false&quot; : &quot;true&quot;);</span>
<a href="#l6.1532"></a><span id="l6.1532" class="difflineminus">-</span>
<a href="#l6.1533"></a><span id="l6.1533" class="difflineminus">-            // If the tab history is empty, disable &quot;Undo Close Tab&quot;</span>
<a href="#l6.1534"></a><span id="l6.1534" class="difflineminus">-            tabContextMenu</span>
<a href="#l6.1535"></a><span id="l6.1535" class="difflineminus">-              .querySelector(`[anonid=&quot;recentlyClosedTabs&quot;]`)</span>
<a href="#l6.1536"></a><span id="l6.1536" class="difflineminus">-              .setAttribute(&quot;disabled&quot;,</span>
<a href="#l6.1537"></a><span id="l6.1537" class="difflineminus">-                            (this.recentlyClosedTabs.length) ? &quot;false&quot; : &quot;true&quot;);</span>
<a href="#l6.1538"></a><span id="l6.1538" class="difflineminus">-</span>
<a href="#l6.1539"></a><span id="l6.1539" class="difflineminus">-            return true;</span>
<a href="#l6.1540"></a><span id="l6.1540" class="difflineminus">-          ]]&gt;</span>
<a href="#l6.1541"></a><span id="l6.1541" class="difflineminus">-        &lt;/body&gt;</span>
<a href="#l6.1542"></a><span id="l6.1542" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l6.1543"></a><span id="l6.1543" class="difflineminus">-      &lt;method name=&quot;supportsCommand&quot;&gt;</span>
<a href="#l6.1544"></a><span id="l6.1544" class="difflineminus">-        &lt;parameter name=&quot;aCommand&quot;/&gt;</span>
<a href="#l6.1545"></a><span id="l6.1545" class="difflineminus">-        &lt;body&gt;</span>
<a href="#l6.1546"></a><span id="l6.1546" class="difflineminus">-          &lt;![CDATA[</span>
<a href="#l6.1547"></a><span id="l6.1547" class="difflineminus">-            let tab = this.currentTabInfo;</span>
<a href="#l6.1548"></a><span id="l6.1548" class="difflineminus">-</span>
<a href="#l6.1549"></a><span id="l6.1549" class="difflineminus">-            // This can happen if we're starting up and haven't got a tab</span>
<a href="#l6.1550"></a><span id="l6.1550" class="difflineminus">-            // loaded yet.</span>
<a href="#l6.1551"></a><span id="l6.1551" class="difflineminus">-            if (!tab)</span>
<a href="#l6.1552"></a><span id="l6.1552" class="difflineminus">-              return false;</span>
<a href="#l6.1553"></a><span id="l6.1553" class="difflineminus">-</span>
<a href="#l6.1554"></a><span id="l6.1554" class="difflineminus">-            for (let tabMonitor of this.tabMonitors) {</span>
<a href="#l6.1555"></a><span id="l6.1555" class="difflineminus">-              if (&quot;supportsCommand&quot; in tabMonitor) {</span>
<a href="#l6.1556"></a><span id="l6.1556" class="difflineminus">-                let result = tabMonitor.supportsCommand(aCommand, tab);</span>
<a href="#l6.1557"></a><span id="l6.1557" class="difflineminus">-                if (result !== null)</span>
<a href="#l6.1558"></a><span id="l6.1558" class="difflineminus">-                  return result;</span>
<a href="#l6.1559"></a><span id="l6.1559" class="difflineminus">-              }</span>
<a href="#l6.1560"></a><span id="l6.1560" class="difflineminus">-            }</span>
<a href="#l6.1561"></a><span id="l6.1561" class="difflineminus">-</span>
<a href="#l6.1562"></a><span id="l6.1562" class="difflineminus">-            let supportsCommandFunc = tab.mode.supportsCommand ||</span>
<a href="#l6.1563"></a><span id="l6.1563" class="difflineminus">-                                      tab.mode.tabType.supportsCommand;</span>
<a href="#l6.1564"></a><span id="l6.1564" class="difflineminus">-            if (supportsCommandFunc)</span>
<a href="#l6.1565"></a><span id="l6.1565" class="difflineminus">-              return supportsCommandFunc.call(tab.mode.tabType, aCommand, tab);</span>
<a href="#l6.1566"></a><span id="l6.1566" class="difflineminus">-</span>
<a href="#l6.1567"></a><span id="l6.1567" class="difflineminus">-            return false;</span>
<a href="#l6.1568"></a><span id="l6.1568" class="difflineminus">-          ]]&gt;</span>
<a href="#l6.1569"></a><span id="l6.1569" class="difflineminus">-        &lt;/body&gt;</span>
<a href="#l6.1570"></a><span id="l6.1570" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l6.1571"></a><span id="l6.1571" class="difflineminus">-      &lt;method name=&quot;isCommandEnabled&quot;&gt;</span>
<a href="#l6.1572"></a><span id="l6.1572" class="difflineminus">-        &lt;parameter name=&quot;aCommand&quot;/&gt;</span>
<a href="#l6.1573"></a><span id="l6.1573" class="difflineminus">-        &lt;body&gt;</span>
<a href="#l6.1574"></a><span id="l6.1574" class="difflineminus">-          &lt;![CDATA[</span>
<a href="#l6.1575"></a><span id="l6.1575" class="difflineminus">-            let tab = this.currentTabInfo;</span>
<a href="#l6.1576"></a><span id="l6.1576" class="difflineminus">-</span>
<a href="#l6.1577"></a><span id="l6.1577" class="difflineminus">-            // This can happen if we're starting up and haven't got a tab</span>
<a href="#l6.1578"></a><span id="l6.1578" class="difflineminus">-            // loaded yet.</span>
<a href="#l6.1579"></a><span id="l6.1579" class="difflineminus">-            if (!tab)</span>
<a href="#l6.1580"></a><span id="l6.1580" class="difflineminus">-              return false;</span>
<a href="#l6.1581"></a><span id="l6.1581" class="difflineminus">-</span>
<a href="#l6.1582"></a><span id="l6.1582" class="difflineminus">-            for (let tabMonitor of this.tabMonitors) {</span>
<a href="#l6.1583"></a><span id="l6.1583" class="difflineminus">-              if (&quot;isCommandEnabled&quot; in tabMonitor) {</span>
<a href="#l6.1584"></a><span id="l6.1584" class="difflineminus">-                let result = tabMonitor.isCommandEnabled(aCommand, tab);</span>
<a href="#l6.1585"></a><span id="l6.1585" class="difflineminus">-                if (result !== null)</span>
<a href="#l6.1586"></a><span id="l6.1586" class="difflineminus">-                  return result;</span>
<a href="#l6.1587"></a><span id="l6.1587" class="difflineminus">-              }</span>
<a href="#l6.1588"></a><span id="l6.1588" class="difflineminus">-            }</span>
<a href="#l6.1589"></a><span id="l6.1589" class="difflineminus">-</span>
<a href="#l6.1590"></a><span id="l6.1590" class="difflineminus">-            let isCommandEnabledFunc = tab.mode.isCommandEnabled ||</span>
<a href="#l6.1591"></a><span id="l6.1591" class="difflineminus">-                                       tab.mode.tabType.isCommandEnabled;</span>
<a href="#l6.1592"></a><span id="l6.1592" class="difflineminus">-            if (isCommandEnabledFunc)</span>
<a href="#l6.1593"></a><span id="l6.1593" class="difflineminus">-              return isCommandEnabledFunc.call(tab.mode.tabType, aCommand, tab);</span>
<a href="#l6.1594"></a><span id="l6.1594" class="difflineminus">-</span>
<a href="#l6.1595"></a><span id="l6.1595" class="difflineminus">-            return false;</span>
<a href="#l6.1596"></a><span id="l6.1596" class="difflineminus">-          ]]&gt;</span>
<a href="#l6.1597"></a><span id="l6.1597" class="difflineminus">-        &lt;/body&gt;</span>
<a href="#l6.1598"></a><span id="l6.1598" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l6.1599"></a><span id="l6.1599" class="difflineminus">-      &lt;method name=&quot;doCommand&quot;&gt;</span>
<a href="#l6.1600"></a><span id="l6.1600" class="difflineminus">-        &lt;parameter name=&quot;aCommand&quot;/&gt;</span>
<a href="#l6.1601"></a><span id="l6.1601" class="difflineminus">-        &lt;body&gt;</span>
<a href="#l6.1602"></a><span id="l6.1602" class="difflineminus">-          &lt;![CDATA[</span>
<a href="#l6.1603"></a><span id="l6.1603" class="difflineminus">-            let tab = this.currentTabInfo;</span>
<a href="#l6.1604"></a><span id="l6.1604" class="difflineminus">-</span>
<a href="#l6.1605"></a><span id="l6.1605" class="difflineminus">-            // This can happen if we're starting up and haven't got a tab</span>
<a href="#l6.1606"></a><span id="l6.1606" class="difflineminus">-            // loaded yet.</span>
<a href="#l6.1607"></a><span id="l6.1607" class="difflineminus">-            if (!tab)</span>
<a href="#l6.1608"></a><span id="l6.1608" class="difflineminus">-              return;</span>
<a href="#l6.1609"></a><span id="l6.1609" class="difflineminus">-</span>
<a href="#l6.1610"></a><span id="l6.1610" class="difflineminus">-            for (let tabMonitor of this.tabMonitors) {</span>
<a href="#l6.1611"></a><span id="l6.1611" class="difflineminus">-              if (&quot;doCommand&quot; in tabMonitor) {</span>
<a href="#l6.1612"></a><span id="l6.1612" class="difflineminus">-                let result = tabMonitor.doCommand(aCommand, tab);</span>
<a href="#l6.1613"></a><span id="l6.1613" class="difflineminus">-                if (result === true)</span>
<a href="#l6.1614"></a><span id="l6.1614" class="difflineminus">-                  return;</span>
<a href="#l6.1615"></a><span id="l6.1615" class="difflineminus">-              }</span>
<a href="#l6.1616"></a><span id="l6.1616" class="difflineminus">-            }</span>
<a href="#l6.1617"></a><span id="l6.1617" class="difflineminus">-</span>
<a href="#l6.1618"></a><span id="l6.1618" class="difflineminus">-            let doCommandFunc = tab.mode.doCommand ||</span>
<a href="#l6.1619"></a><span id="l6.1619" class="difflineminus">-                                tab.mode.tabType.doCommand;</span>
<a href="#l6.1620"></a><span id="l6.1620" class="difflineminus">-            if (doCommandFunc)</span>
<a href="#l6.1621"></a><span id="l6.1621" class="difflineminus">-              doCommandFunc.call(tab.mode.tabType, aCommand, tab);</span>
<a href="#l6.1622"></a><span id="l6.1622" class="difflineminus">-          ]]&gt;</span>
<a href="#l6.1623"></a><span id="l6.1623" class="difflineminus">-        &lt;/body&gt;</span>
<a href="#l6.1624"></a><span id="l6.1624" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l6.1625"></a><span id="l6.1625" class="difflineminus">-      &lt;method name=&quot;onEvent&quot;&gt;</span>
<a href="#l6.1626"></a><span id="l6.1626" class="difflineminus">-        &lt;parameter name=&quot;aEvent&quot;/&gt;</span>
<a href="#l6.1627"></a><span id="l6.1627" class="difflineminus">-        &lt;body&gt;</span>
<a href="#l6.1628"></a><span id="l6.1628" class="difflineminus">-          &lt;![CDATA[</span>
<a href="#l6.1629"></a><span id="l6.1629" class="difflineminus">-            let tab = this.currentTabInfo;</span>
<a href="#l6.1630"></a><span id="l6.1630" class="difflineminus">-</span>
<a href="#l6.1631"></a><span id="l6.1631" class="difflineminus">-            // This can happen if we're starting up and haven't got a tab</span>
<a href="#l6.1632"></a><span id="l6.1632" class="difflineminus">-            // loaded yet.</span>
<a href="#l6.1633"></a><span id="l6.1633" class="difflineminus">-            if (!tab)</span>
<a href="#l6.1634"></a><span id="l6.1634" class="difflineminus">-              return null;</span>
<a href="#l6.1635"></a><span id="l6.1635" class="difflineminus">-</span>
<a href="#l6.1636"></a><span id="l6.1636" class="difflineminus">-            let onEventFunc = tab.mode.onEvent ||</span>
<a href="#l6.1637"></a><span id="l6.1637" class="difflineminus">-                              tab.mode.tabType.onEvent;</span>
<a href="#l6.1638"></a><span id="l6.1638" class="difflineminus">-            if (onEventFunc)</span>
<a href="#l6.1639"></a><span id="l6.1639" class="difflineminus">-              return onEventFunc.call(tab.mode.tabType, aEvent, tab);</span>
<a href="#l6.1640"></a><span id="l6.1640" class="difflineminus">-</span>
<a href="#l6.1641"></a><span id="l6.1641" class="difflineminus">-            return false;</span>
<a href="#l6.1642"></a><span id="l6.1642" class="difflineminus">-          ]]&gt;</span>
<a href="#l6.1643"></a><span id="l6.1643" class="difflineminus">-        &lt;/body&gt;</span>
<a href="#l6.1644"></a><span id="l6.1644" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l6.1645"></a><span id="l6.1645" class="difflineminus">-      &lt;!-- Set the document title based on the tab title --&gt;</span>
<a href="#l6.1646"></a><span id="l6.1646" class="difflineminus">-      &lt;method name=&quot;setDocumentTitle&quot;&gt;</span>
<a href="#l6.1647"></a><span id="l6.1647" class="difflineminus">-        &lt;parameter name=&quot;aTab&quot;/&gt;</span>
<a href="#l6.1648"></a><span id="l6.1648" class="difflineminus">-        &lt;body&gt;</span>
<a href="#l6.1649"></a><span id="l6.1649" class="difflineminus">-          &lt;![CDATA[</span>
<a href="#l6.1650"></a><span id="l6.1650" class="difflineminus">-            let docTitle = aTab.title ? aTab.title.trim() : &quot;&quot;;</span>
<a href="#l6.1651"></a><span id="l6.1651" class="difflineminus">-            let docElement = document.documentElement;</span>
<a href="#l6.1652"></a><span id="l6.1652" class="difflineminus">-            // If the document title is blank, add the default title.</span>
<a href="#l6.1653"></a><span id="l6.1653" class="difflineminus">-            if (!docTitle)</span>
<a href="#l6.1654"></a><span id="l6.1654" class="difflineminus">-              docTitle = docElement.getAttribute(&quot;defaultTabTitle&quot;);</span>
<a href="#l6.1655"></a><span id="l6.1655" class="difflineminus">-</span>
<a href="#l6.1656"></a><span id="l6.1656" class="difflineminus">-            // If we're on Mac, don't display the separator and the modifier.</span>
<a href="#l6.1657"></a><span id="l6.1657" class="difflineminus">-            if (AppConstants.platform != &quot;macosx&quot;) {</span>
<a href="#l6.1658"></a><span id="l6.1658" class="difflineminus">-              docTitle += docElement.getAttribute(&quot;titlemenuseparator&quot;) +</span>
<a href="#l6.1659"></a><span id="l6.1659" class="difflineminus">-                          docElement.getAttribute(&quot;titlemodifier&quot;);</span>
<a href="#l6.1660"></a><span id="l6.1660" class="difflineminus">-            }</span>
<a href="#l6.1661"></a><span id="l6.1661" class="difflineminus">-</span>
<a href="#l6.1662"></a><span id="l6.1662" class="difflineminus">-            document.title = docTitle;</span>
<a href="#l6.1663"></a><span id="l6.1663" class="difflineminus">-          ]]&gt;</span>
<a href="#l6.1664"></a><span id="l6.1664" class="difflineminus">-        &lt;/body&gt;</span>
<a href="#l6.1665"></a><span id="l6.1665" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l6.1666"></a><span id="l6.1666" class="difflineminus">-      &lt;method name=&quot;addTabsProgressListener&quot;&gt;</span>
<a href="#l6.1667"></a><span id="l6.1667" class="difflineminus">-        &lt;parameter name=&quot;aListener&quot;/&gt;</span>
<a href="#l6.1668"></a><span id="l6.1668" class="difflineminus">-        &lt;body&gt;</span>
<a href="#l6.1669"></a><span id="l6.1669" class="difflineminus">-          &lt;![CDATA[</span>
<a href="#l6.1670"></a><span id="l6.1670" class="difflineminus">-            this.mTabsProgressListeners.add(aListener);</span>
<a href="#l6.1671"></a><span id="l6.1671" class="difflineminus">-          ]]&gt;</span>
<a href="#l6.1672"></a><span id="l6.1672" class="difflineminus">-        &lt;/body&gt;</span>
<a href="#l6.1673"></a><span id="l6.1673" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l6.1674"></a><span id="l6.1674" class="difflineminus">-      &lt;method name=&quot;removeTabsProgressListener&quot;&gt;</span>
<a href="#l6.1675"></a><span id="l6.1675" class="difflineminus">-        &lt;parameter name=&quot;aListener&quot;/&gt;</span>
<a href="#l6.1676"></a><span id="l6.1676" class="difflineminus">-        &lt;body&gt;</span>
<a href="#l6.1677"></a><span id="l6.1677" class="difflineminus">-          &lt;![CDATA[</span>
<a href="#l6.1678"></a><span id="l6.1678" class="difflineminus">-            this.mTabsProgressListeners.delete(aListener);</span>
<a href="#l6.1679"></a><span id="l6.1679" class="difflineminus">-          ]]&gt;</span>
<a href="#l6.1680"></a><span id="l6.1680" class="difflineminus">-        &lt;/body&gt;</span>
<a href="#l6.1681"></a><span id="l6.1681" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l6.1682"></a><span id="l6.1682" class="difflineminus">-      &lt;method name=&quot;_callTabListeners&quot;&gt;</span>
<a href="#l6.1683"></a><span id="l6.1683" class="difflineminus">-        &lt;parameter name=&quot;aMethod&quot;/&gt;</span>
<a href="#l6.1684"></a><span id="l6.1684" class="difflineminus">-        &lt;parameter name=&quot;aArgs&quot;/&gt;</span>
<a href="#l6.1685"></a><span id="l6.1685" class="difflineminus">-        &lt;body&gt;</span>
<a href="#l6.1686"></a><span id="l6.1686" class="difflineminus">-          &lt;![CDATA[</span>
<a href="#l6.1687"></a><span id="l6.1687" class="difflineminus">-            for (let listener of this.mTabsProgressListeners.values()) {</span>
<a href="#l6.1688"></a><span id="l6.1688" class="difflineminus">-              if (aMethod in listener) {</span>
<a href="#l6.1689"></a><span id="l6.1689" class="difflineminus">-                try {</span>
<a href="#l6.1690"></a><span id="l6.1690" class="difflineminus">-                  listener[aMethod](...aArgs);</span>
<a href="#l6.1691"></a><span id="l6.1691" class="difflineminus">-                } catch (e) {</span>
<a href="#l6.1692"></a><span id="l6.1692" class="difflineminus">-                  Cu.reportError(e);</span>
<a href="#l6.1693"></a><span id="l6.1693" class="difflineminus">-                }</span>
<a href="#l6.1694"></a><span id="l6.1694" class="difflineminus">-              }</span>
<a href="#l6.1695"></a><span id="l6.1695" class="difflineminus">-            }</span>
<a href="#l6.1696"></a><span id="l6.1696" class="difflineminus">-          ]]&gt;</span>
<a href="#l6.1697"></a><span id="l6.1697" class="difflineminus">-        &lt;/body&gt;</span>
<a href="#l6.1698"></a><span id="l6.1698" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l6.1699"></a><span id="l6.1699" class="difflineminus">-      &lt;method name=&quot;onProgressChange&quot;&gt;</span>
<a href="#l6.1700"></a><span id="l6.1700" class="difflineminus">-        &lt;parameter name=&quot;aWebProgress&quot;/&gt;</span>
<a href="#l6.1701"></a><span id="l6.1701" class="difflineminus">-        &lt;parameter name=&quot;aRequest&quot;/&gt;</span>
<a href="#l6.1702"></a><span id="l6.1702" class="difflineminus">-        &lt;parameter name=&quot;aCurSelf&quot;/&gt;</span>
<a href="#l6.1703"></a><span id="l6.1703" class="difflineminus">-        &lt;parameter name=&quot;aMaxSelf&quot;/&gt;</span>
<a href="#l6.1704"></a><span id="l6.1704" class="difflineminus">-        &lt;parameter name=&quot;aCurTotal&quot;/&gt;</span>
<a href="#l6.1705"></a><span id="l6.1705" class="difflineminus">-        &lt;parameter name=&quot;aMaxTotal&quot;/&gt;</span>
<a href="#l6.1706"></a><span id="l6.1706" class="difflineminus">-        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l6.1707"></a><span id="l6.1707" class="difflineminus">-          let browser = aWebProgress.QueryInterface(Ci.nsIDocShellTreeItem)</span>
<a href="#l6.1708"></a><span id="l6.1708" class="difflineminus">-                                    .sameTypeRootTreeItem</span>
<a href="#l6.1709"></a><span id="l6.1709" class="difflineminus">-                                    .chromeEventHandler;</span>
<a href="#l6.1710"></a><span id="l6.1710" class="difflineminus">-          this._callTabListeners(&quot;onProgressChange&quot;, [browser, ...arguments]);</span>
<a href="#l6.1711"></a><span id="l6.1711" class="difflineminus">-        ]]&gt;&lt;/body&gt;</span>
<a href="#l6.1712"></a><span id="l6.1712" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l6.1713"></a><span id="l6.1713" class="difflineminus">-      &lt;method name=&quot;onProgressChange64&quot;&gt;</span>
<a href="#l6.1714"></a><span id="l6.1714" class="difflineminus">-        &lt;parameter name=&quot;aWebProgress&quot;/&gt;</span>
<a href="#l6.1715"></a><span id="l6.1715" class="difflineminus">-        &lt;parameter name=&quot;aRequest&quot;/&gt;</span>
<a href="#l6.1716"></a><span id="l6.1716" class="difflineminus">-        &lt;parameter name=&quot;aCurSelf&quot;/&gt;</span>
<a href="#l6.1717"></a><span id="l6.1717" class="difflineminus">-        &lt;parameter name=&quot;aMaxSelf&quot;/&gt;</span>
<a href="#l6.1718"></a><span id="l6.1718" class="difflineminus">-        &lt;parameter name=&quot;aCurTotal&quot;/&gt;</span>
<a href="#l6.1719"></a><span id="l6.1719" class="difflineminus">-        &lt;parameter name=&quot;aMaxTotal&quot;/&gt;</span>
<a href="#l6.1720"></a><span id="l6.1720" class="difflineminus">-        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l6.1721"></a><span id="l6.1721" class="difflineminus">-          let browser = aWebProgress.QueryInterface(Ci.nsIDocShellTreeItem)</span>
<a href="#l6.1722"></a><span id="l6.1722" class="difflineminus">-                                    .sameTypeRootTreeItem</span>
<a href="#l6.1723"></a><span id="l6.1723" class="difflineminus">-                                    .chromeEventHandler;</span>
<a href="#l6.1724"></a><span id="l6.1724" class="difflineminus">-          this._callTabListeners(&quot;onProgressChange64&quot;, [browser, ...arguments]);</span>
<a href="#l6.1725"></a><span id="l6.1725" class="difflineminus">-        ]]&gt;&lt;/body&gt;</span>
<a href="#l6.1726"></a><span id="l6.1726" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l6.1727"></a><span id="l6.1727" class="difflineminus">-      &lt;method name=&quot;onLocationChange&quot;&gt;</span>
<a href="#l6.1728"></a><span id="l6.1728" class="difflineminus">-        &lt;parameter name=&quot;aWebProgress&quot;/&gt;</span>
<a href="#l6.1729"></a><span id="l6.1729" class="difflineminus">-        &lt;parameter name=&quot;aRequest&quot;/&gt;</span>
<a href="#l6.1730"></a><span id="l6.1730" class="difflineminus">-        &lt;parameter name=&quot;aLocationURI&quot;/&gt;</span>
<a href="#l6.1731"></a><span id="l6.1731" class="difflineminus">-        &lt;parameter name=&quot;aFlags&quot;/&gt;</span>
<a href="#l6.1732"></a><span id="l6.1732" class="difflineminus">-        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l6.1733"></a><span id="l6.1733" class="difflineminus">-          let browser = aWebProgress.QueryInterface(Ci.nsIDocShellTreeItem)</span>
<a href="#l6.1734"></a><span id="l6.1734" class="difflineminus">-                                    .sameTypeRootTreeItem</span>
<a href="#l6.1735"></a><span id="l6.1735" class="difflineminus">-                                    .chromeEventHandler;</span>
<a href="#l6.1736"></a><span id="l6.1736" class="difflineminus">-          this._callTabListeners(&quot;onLocationChange&quot;, [browser, ...arguments]);</span>
<a href="#l6.1737"></a><span id="l6.1737" class="difflineminus">-        ]]&gt;&lt;/body&gt;</span>
<a href="#l6.1738"></a><span id="l6.1738" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l6.1739"></a><span id="l6.1739" class="difflineminus">-      &lt;method name=&quot;onStateChange&quot;&gt;</span>
<a href="#l6.1740"></a><span id="l6.1740" class="difflineminus">-        &lt;parameter name=&quot;aWebProgress&quot;/&gt;</span>
<a href="#l6.1741"></a><span id="l6.1741" class="difflineminus">-        &lt;parameter name=&quot;aRequest&quot;/&gt;</span>
<a href="#l6.1742"></a><span id="l6.1742" class="difflineminus">-        &lt;parameter name=&quot;aStateFlags&quot;/&gt;</span>
<a href="#l6.1743"></a><span id="l6.1743" class="difflineminus">-        &lt;parameter name=&quot;aStatus&quot;/&gt;</span>
<a href="#l6.1744"></a><span id="l6.1744" class="difflineminus">-        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l6.1745"></a><span id="l6.1745" class="difflineminus">-          let browser = aWebProgress.QueryInterface(Ci.nsIDocShellTreeItem)</span>
<a href="#l6.1746"></a><span id="l6.1746" class="difflineminus">-                                    .sameTypeRootTreeItem</span>
<a href="#l6.1747"></a><span id="l6.1747" class="difflineminus">-                                    .chromeEventHandler;</span>
<a href="#l6.1748"></a><span id="l6.1748" class="difflineminus">-          this._callTabListeners(&quot;onStateChange&quot;, [browser, ...arguments]);</span>
<a href="#l6.1749"></a><span id="l6.1749" class="difflineminus">-        ]]&gt;&lt;/body&gt;</span>
<a href="#l6.1750"></a><span id="l6.1750" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l6.1751"></a><span id="l6.1751" class="difflineminus">-      &lt;method name=&quot;onStatusChange&quot;&gt;</span>
<a href="#l6.1752"></a><span id="l6.1752" class="difflineminus">-        &lt;parameter name=&quot;aWebProgress&quot;/&gt;</span>
<a href="#l6.1753"></a><span id="l6.1753" class="difflineminus">-        &lt;parameter name=&quot;aRequest&quot;/&gt;</span>
<a href="#l6.1754"></a><span id="l6.1754" class="difflineminus">-        &lt;parameter name=&quot;aStatus&quot;/&gt;</span>
<a href="#l6.1755"></a><span id="l6.1755" class="difflineminus">-        &lt;parameter name=&quot;aMessage&quot;/&gt;</span>
<a href="#l6.1756"></a><span id="l6.1756" class="difflineminus">-        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l6.1757"></a><span id="l6.1757" class="difflineminus">-          let browser = aWebProgress.QueryInterface(Ci.nsIDocShellTreeItem)</span>
<a href="#l6.1758"></a><span id="l6.1758" class="difflineminus">-                                    .sameTypeRootTreeItem</span>
<a href="#l6.1759"></a><span id="l6.1759" class="difflineminus">-                                    .chromeEventHandler;</span>
<a href="#l6.1760"></a><span id="l6.1760" class="difflineminus">-          this._callTabListeners(&quot;onStatusChange&quot;, [browser, ...arguments]);</span>
<a href="#l6.1761"></a><span id="l6.1761" class="difflineminus">-        ]]&gt;&lt;/body&gt;</span>
<a href="#l6.1762"></a><span id="l6.1762" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l6.1763"></a><span id="l6.1763" class="difflineminus">-      &lt;method name=&quot;onSecurityChange&quot;&gt;</span>
<a href="#l6.1764"></a><span id="l6.1764" class="difflineminus">-        &lt;parameter name=&quot;aWebProgress&quot;/&gt;</span>
<a href="#l6.1765"></a><span id="l6.1765" class="difflineminus">-        &lt;parameter name=&quot;aRequest&quot;/&gt;</span>
<a href="#l6.1766"></a><span id="l6.1766" class="difflineminus">-        &lt;parameter name=&quot;aState&quot;/&gt;</span>
<a href="#l6.1767"></a><span id="l6.1767" class="difflineminus">-        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l6.1768"></a><span id="l6.1768" class="difflineminus">-          let browser = aWebProgress.QueryInterface(Ci.nsIDocShellTreeItem)</span>
<a href="#l6.1769"></a><span id="l6.1769" class="difflineminus">-                                    .sameTypeRootTreeItem</span>
<a href="#l6.1770"></a><span id="l6.1770" class="difflineminus">-                                    .chromeEventHandler;</span>
<a href="#l6.1771"></a><span id="l6.1771" class="difflineminus">-          this._callTabListeners(&quot;onSecurityChange&quot;, [browser, ...arguments]);</span>
<a href="#l6.1772"></a><span id="l6.1772" class="difflineminus">-        ]]&gt;&lt;/body&gt;</span>
<a href="#l6.1773"></a><span id="l6.1773" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l6.1774"></a><span id="l6.1774" class="difflineminus">-      &lt;method name=&quot;onContentBlockingEvent&quot;&gt;</span>
<a href="#l6.1775"></a><span id="l6.1775" class="difflineminus">-        &lt;parameter name=&quot;aWebProgress&quot;/&gt;</span>
<a href="#l6.1776"></a><span id="l6.1776" class="difflineminus">-        &lt;parameter name=&quot;aRequest&quot;/&gt;</span>
<a href="#l6.1777"></a><span id="l6.1777" class="difflineminus">-        &lt;parameter name=&quot;aEvent&quot;/&gt;</span>
<a href="#l6.1778"></a><span id="l6.1778" class="difflineminus">-        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l6.1779"></a><span id="l6.1779" class="difflineminus">-          let browser = aWebProgress.QueryInterface(Ci.nsIDocShellTreeItem)</span>
<a href="#l6.1780"></a><span id="l6.1780" class="difflineminus">-                                    .sameTypeRootTreeItem</span>
<a href="#l6.1781"></a><span id="l6.1781" class="difflineminus">-                                    .chromeEventHandler;</span>
<a href="#l6.1782"></a><span id="l6.1782" class="difflineminus">-          this._callTabListeners(&quot;onContentBlockingEvent&quot;, [browser, ...arguments]);</span>
<a href="#l6.1783"></a><span id="l6.1783" class="difflineminus">-        ]]&gt;&lt;/body&gt;</span>
<a href="#l6.1784"></a><span id="l6.1784" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l6.1785"></a><span id="l6.1785" class="difflineminus">-      &lt;method name=&quot;onRefreshAttempted&quot;&gt;</span>
<a href="#l6.1786"></a><span id="l6.1786" class="difflineminus">-        &lt;parameter name=&quot;aWebProgress&quot;/&gt;</span>
<a href="#l6.1787"></a><span id="l6.1787" class="difflineminus">-        &lt;parameter name=&quot;aURI&quot;/&gt;</span>
<a href="#l6.1788"></a><span id="l6.1788" class="difflineminus">-        &lt;parameter name=&quot;aDelay&quot;/&gt;</span>
<a href="#l6.1789"></a><span id="l6.1789" class="difflineminus">-        &lt;parameter name=&quot;aSameURI&quot;/&gt;</span>
<a href="#l6.1790"></a><span id="l6.1790" class="difflineminus">-        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l6.1791"></a><span id="l6.1791" class="difflineminus">-          let browser = aWebProgress.QueryInterface(Ci.nsIDocShellTreeItem)</span>
<a href="#l6.1792"></a><span id="l6.1792" class="difflineminus">-                                    .sameTypeRootTreeItem</span>
<a href="#l6.1793"></a><span id="l6.1793" class="difflineminus">-                                    .chromeEventHandler;</span>
<a href="#l6.1794"></a><span id="l6.1794" class="difflineminus">-          this._callTabListeners(&quot;onRefreshAttempted&quot;, [browser, ...arguments]);</span>
<a href="#l6.1795"></a><span id="l6.1795" class="difflineminus">-        ]]&gt;&lt;/body&gt;</span>
<a href="#l6.1796"></a><span id="l6.1796" class="difflineminus">-      &lt;/method&gt;</span>
<a href="#l6.1797"></a><span id="l6.1797" class="difflineminus">-</span>
<a href="#l6.1798"></a><span id="l6.1798" class="difflineminus">-    &lt;/implementation&gt;</span>
<a href="#l6.1799"></a><span id="l6.1799" class="difflineminus">-  &lt;/binding&gt;</span>
<a href="#l6.1800"></a><span id="l6.1800" class="difflineminus">-&lt;/bindings&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mail/base/jar.mn</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mail/base/jar.mn</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -67,17 +67,16 @@ messenger.jar:</span>
<a href="#l7.4"></a><span id="l7.4">     content/messenger/searchBar.js                  (content/searchBar.js)</span>
<a href="#l7.5"></a><span id="l7.5">     content/messenger/phishingDetector.js           (content/phishingDetector.js)</span>
<a href="#l7.6"></a><span id="l7.6">     content/messenger/mail-offline.js               (content/mail-offline.js)</span>
<a href="#l7.7"></a><span id="l7.7">     content/messenger/aboutDialog.css               (content/aboutDialog.css)</span>
<a href="#l7.8"></a><span id="l7.8">     content/messenger/converterDialog.css           (content/converterDialog.css)</span>
<a href="#l7.9"></a><span id="l7.9">     content/messenger/notification.css              (content/notification.css)</span>
<a href="#l7.10"></a><span id="l7.10"> *   content/messenger/messenger.css                 (content/messenger.css)</span>
<a href="#l7.11"></a><span id="l7.11">     content/messenger/search.xml                    (content/search.xml)</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-    content/messenger/tabmail.xml                   (content/tabmail.xml)</span>
<a href="#l7.13"></a><span id="l7.13">     content/messenger/tabmail.js                    (content/tabmail.js)</span>
<a href="#l7.14"></a><span id="l7.14">     content/messenger/tabmail-tabs.js               (content/tabmail-tabs.js)</span>
<a href="#l7.15"></a><span id="l7.15">     content/messenger/tabbrowser-tab.js             (content/tabbrowser-tab.js)</span>
<a href="#l7.16"></a><span id="l7.16">     content/messenger/tabmail.css                   (content/tabmail.css)</span>
<a href="#l7.17"></a><span id="l7.17">     content/messenger/statuspanel.js                (content/statuspanel.js)</span>
<a href="#l7.18"></a><span id="l7.18">     content/messenger/newTagDialog.xul              (content/newTagDialog.xul)</span>
<a href="#l7.19"></a><span id="l7.19">     content/messenger/newTagDialog.js               (content/newTagDialog.js)</span>
<a href="#l7.20"></a><span id="l7.20">     content/messenger/composerOverlay.css           (content/composerOverlay.css)</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:33Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

