<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 26607:164c011c89855c703d299865724962532f6b705b</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 164c011c89855c703d299865724962532f6b705b" />
<meta property="og:url" content="/comm-central/rev/164c011c89855c703d299865724962532f6b705b" />
<meta property="og:description" content="Bug 555448 - [autoconfig] Show real error message during account verification. r=Neil" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 164c011c89855c703d299865724962532f6b705b 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/164c011c89855c703d299865724962532f6b705b">shortlog</a> |
<a href="/comm-central/log/164c011c89855c703d299865724962532f6b705b">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/164c011c89855c703d299865724962532f6b705b">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/164c011c89855c703d299865724962532f6b705b">files</a> |
changeset |
<a href="/comm-central/raw-rev/164c011c89855c703d299865724962532f6b705b">raw</a>  | <a href="/comm-central/archive/164c011c89855c703d299865724962532f6b705b.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=555448">Bug 555448</a> - [autoconfig] Show real error message during account verification. r=Neil
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#66;&#101;&#110;&#32;&#66;&#117;&#99;&#107;&#115;&#99;&#104;&#32;&#60;&#98;&#101;&#110;&#46;&#98;&#117;&#99;&#107;&#115;&#99;&#104;&#64;&#98;&#101;&#111;&#110;&#101;&#120;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Tue, 14 May 2019 19:06:28 +0200</td></tr>

<tr>
 <td>changeset 26607</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/164c011c89855c703d299865724962532f6b705b">164c011c89855c703d299865724962532f6b705b</a></td>
</tr>



<tr>
<td>parent 26606</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/7a1ad9265b0ce7c0e01a9a55dd26bcec93222f5a">7a1ad9265b0ce7c0e01a9a55dd26bcec93222f5a</a>
</td>
</tr>

<tr>
<td>child 26608</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/e2cf3f7382328809a1983e42a660e227e68f84a7">e2cf3f7382328809a1983e42a660e227e68f84a7</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=164c011c89855c703d299865724962532f6b705b">15914</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Tue, 14 May 2019 17:24:15 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@e2cf3f738232 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=e2cf3f7382328809a1983e42a660e227e68f84a7">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=e2cf3f7382328809a1983e42a660e227e68f84a7&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=e2cf3f7382328809a1983e42a660e227e68f84a7&newProject=comm-central&newRevision=7a1ad9265b0ce7c0e01a9a55dd26bcec93222f5a&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=e2cf3f7382328809a1983e42a660e227e68f84a7&newProject=comm-central&newRevision=7a1ad9265b0ce7c0e01a9a55dd26bcec93222f5a&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=e2cf3f7382328809a1983e42a660e227e68f84a7&newProject=comm-central&newRevision=7a1ad9265b0ce7c0e01a9a55dd26bcec93222f5a&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28Neil%29&revcount=50">Neil</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=555448">555448</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=555448">Bug 555448</a> - [autoconfig] Show real error message during account verification. r=Neil

Summary:
The account creation dialog verifies the password before creating the account,
by contacting the real server and attempting a login. The bug is that it always
says &quot;Verify username or password&quot;, it always blames the password,
no matter what error there was. This is not only wrong and misleading for
end users, because they hunt the wrong end. It's also dangerous,
because they will re-attempt the password multiple times, then try other
passwords, thereby exposing other passwords to the server.

Now we show the correct and real error message.

More specifically: If it's a wrong username or password, we maintain the
same error message as before. If it's any other error, we show the real error
message.

Reproduction:
 1. File | New | Mail account...
 2. Enter foo@gmx.com and continue
 3. Disconnect your local network, or provoke any other error
 4. Click on &quot;Create account&quot;

Old result:
Dialog says &quot;username and/or password invalid&quot;

New result:
The actual error is shown, whatever was the cause for the failed verification.</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/164c011c89855c703d299865724962532f6b705b/mail/components/accountcreation/content/emailWizard.js">mail/components/accountcreation/content/emailWizard.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/164c011c89855c703d299865724962532f6b705b/mail/components/accountcreation/content/emailWizard.js">file</a> |
<a href="/comm-central/annotate/164c011c89855c703d299865724962532f6b705b/mail/components/accountcreation/content/emailWizard.js">annotate</a> |
<a href="/comm-central/diff/164c011c89855c703d299865724962532f6b705b/mail/components/accountcreation/content/emailWizard.js">diff</a> |
<a href="/comm-central/comparison/164c011c89855c703d299865724962532f6b705b/mail/components/accountcreation/content/emailWizard.js">comparison</a> |
<a href="/comm-central/log/164c011c89855c703d299865724962532f6b705b/mail/components/accountcreation/content/emailWizard.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/164c011c89855c703d299865724962532f6b705b/mail/components/accountcreation/content/verifyConfig.js">mail/components/accountcreation/content/verifyConfig.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/164c011c89855c703d299865724962532f6b705b/mail/components/accountcreation/content/verifyConfig.js">file</a> |
<a href="/comm-central/annotate/164c011c89855c703d299865724962532f6b705b/mail/components/accountcreation/content/verifyConfig.js">annotate</a> |
<a href="/comm-central/diff/164c011c89855c703d299865724962532f6b705b/mail/components/accountcreation/content/verifyConfig.js">diff</a> |
<a href="/comm-central/comparison/164c011c89855c703d299865724962532f6b705b/mail/components/accountcreation/content/verifyConfig.js">comparison</a> |
<a href="/comm-central/log/164c011c89855c703d299865724962532f6b705b/mail/components/accountcreation/content/verifyConfig.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/164c011c89855c703d299865724962532f6b705b/mail/themes/shared/mail/accountCreation.css">mail/themes/shared/mail/accountCreation.css</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/164c011c89855c703d299865724962532f6b705b/mail/themes/shared/mail/accountCreation.css">file</a> |
<a href="/comm-central/annotate/164c011c89855c703d299865724962532f6b705b/mail/themes/shared/mail/accountCreation.css">annotate</a> |
<a href="/comm-central/diff/164c011c89855c703d299865724962532f6b705b/mail/themes/shared/mail/accountCreation.css">diff</a> |
<a href="/comm-central/comparison/164c011c89855c703d299865724962532f6b705b/mail/themes/shared/mail/accountCreation.css">comparison</a> |
<a href="/comm-central/log/164c011c89855c703d299865724962532f6b705b/mail/themes/shared/mail/accountCreation.css">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/164c011c89855c703d299865724962532f6b705b/mailnews/base/public/nsIMsgMailNewsUrl.idl">mailnews/base/public/nsIMsgMailNewsUrl.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/164c011c89855c703d299865724962532f6b705b/mailnews/base/public/nsIMsgMailNewsUrl.idl">file</a> |
<a href="/comm-central/annotate/164c011c89855c703d299865724962532f6b705b/mailnews/base/public/nsIMsgMailNewsUrl.idl">annotate</a> |
<a href="/comm-central/diff/164c011c89855c703d299865724962532f6b705b/mailnews/base/public/nsIMsgMailNewsUrl.idl">diff</a> |
<a href="/comm-central/comparison/164c011c89855c703d299865724962532f6b705b/mailnews/base/public/nsIMsgMailNewsUrl.idl">comparison</a> |
<a href="/comm-central/log/164c011c89855c703d299865724962532f6b705b/mailnews/base/public/nsIMsgMailNewsUrl.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/164c011c89855c703d299865724962532f6b705b/mailnews/base/util/nsMsgMailNewsUrl.cpp">mailnews/base/util/nsMsgMailNewsUrl.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/164c011c89855c703d299865724962532f6b705b/mailnews/base/util/nsMsgMailNewsUrl.cpp">file</a> |
<a href="/comm-central/annotate/164c011c89855c703d299865724962532f6b705b/mailnews/base/util/nsMsgMailNewsUrl.cpp">annotate</a> |
<a href="/comm-central/diff/164c011c89855c703d299865724962532f6b705b/mailnews/base/util/nsMsgMailNewsUrl.cpp">diff</a> |
<a href="/comm-central/comparison/164c011c89855c703d299865724962532f6b705b/mailnews/base/util/nsMsgMailNewsUrl.cpp">comparison</a> |
<a href="/comm-central/log/164c011c89855c703d299865724962532f6b705b/mailnews/base/util/nsMsgMailNewsUrl.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/164c011c89855c703d299865724962532f6b705b/mailnews/base/util/nsMsgMailNewsUrl.h">mailnews/base/util/nsMsgMailNewsUrl.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/164c011c89855c703d299865724962532f6b705b/mailnews/base/util/nsMsgMailNewsUrl.h">file</a> |
<a href="/comm-central/annotate/164c011c89855c703d299865724962532f6b705b/mailnews/base/util/nsMsgMailNewsUrl.h">annotate</a> |
<a href="/comm-central/diff/164c011c89855c703d299865724962532f6b705b/mailnews/base/util/nsMsgMailNewsUrl.h">diff</a> |
<a href="/comm-central/comparison/164c011c89855c703d299865724962532f6b705b/mailnews/base/util/nsMsgMailNewsUrl.h">comparison</a> |
<a href="/comm-central/log/164c011c89855c703d299865724962532f6b705b/mailnews/base/util/nsMsgMailNewsUrl.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/164c011c89855c703d299865724962532f6b705b/mailnews/imap/src/nsImapIncomingServer.cpp">mailnews/imap/src/nsImapIncomingServer.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/164c011c89855c703d299865724962532f6b705b/mailnews/imap/src/nsImapIncomingServer.cpp">file</a> |
<a href="/comm-central/annotate/164c011c89855c703d299865724962532f6b705b/mailnews/imap/src/nsImapIncomingServer.cpp">annotate</a> |
<a href="/comm-central/diff/164c011c89855c703d299865724962532f6b705b/mailnews/imap/src/nsImapIncomingServer.cpp">diff</a> |
<a href="/comm-central/comparison/164c011c89855c703d299865724962532f6b705b/mailnews/imap/src/nsImapIncomingServer.cpp">comparison</a> |
<a href="/comm-central/log/164c011c89855c703d299865724962532f6b705b/mailnews/imap/src/nsImapIncomingServer.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/164c011c89855c703d299865724962532f6b705b/mailnews/local/src/nsPop3Protocol.cpp">mailnews/local/src/nsPop3Protocol.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/164c011c89855c703d299865724962532f6b705b/mailnews/local/src/nsPop3Protocol.cpp">file</a> |
<a href="/comm-central/annotate/164c011c89855c703d299865724962532f6b705b/mailnews/local/src/nsPop3Protocol.cpp">annotate</a> |
<a href="/comm-central/diff/164c011c89855c703d299865724962532f6b705b/mailnews/local/src/nsPop3Protocol.cpp">diff</a> |
<a href="/comm-central/comparison/164c011c89855c703d299865724962532f6b705b/mailnews/local/src/nsPop3Protocol.cpp">comparison</a> |
<a href="/comm-central/log/164c011c89855c703d299865724962532f6b705b/mailnews/local/src/nsPop3Protocol.cpp">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/components/accountcreation/content/emailWizard.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/components/accountcreation/content/emailWizard.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -1742,20 +1742,22 @@ EmailConfigWizard.prototype = {</span>
<a href="#l1.4"></a><span id="l1.4">         // We loaded dynamic client registration, fill this data back in to the</span>
<a href="#l1.5"></a><span id="l1.5">         // config set.</span>
<a href="#l1.6"></a><span id="l1.6">         if (successfulConfig.oauthSettings)</span>
<a href="#l1.7"></a><span id="l1.7">           self._currentConfig.oauthSettings = successfulConfig.oauthSettings;</span>
<a href="#l1.8"></a><span id="l1.8"> </span>
<a href="#l1.9"></a><span id="l1.9">         self.finish(configFilledIn);</span>
<a href="#l1.10"></a><span id="l1.10">       },</span>
<a href="#l1.11"></a><span id="l1.11">       function(e) { // failed</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-        self.showErrorStatus(&quot;config_unverifiable&quot;);</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-        // TODO bug 555448: wrong error msg, there may be a 1000 other</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineminus">-        // reasons why this failed, and this is misleading users.</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineminus">-        self.setError(&quot;passworderror&quot;, &quot;user_pass_invalid&quot;);</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineplus">+        // Could be a wrong password, but there are 1000 other</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineplus">+        // reasons why this failed. Only the backend knows.</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineplus">+        // If we got no message, then something other than VerifyLogon failed.</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineplus">+        self.showErrorMsg(e.message || e.toString());</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineplus">+</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineplus">+        window.sizeToContent();</span>
<a href="#l1.22"></a><span id="l1.22">         // TODO use switchToMode(), see above</span>
<a href="#l1.23"></a><span id="l1.23">         // give user something to proceed after fixing</span>
<a href="#l1.24"></a><span id="l1.24">         _enable(&quot;create_button&quot;);</span>
<a href="#l1.25"></a><span id="l1.25">         // hidden in non-manual mode, so it's fine to enable</span>
<a href="#l1.26"></a><span id="l1.26">         _enable(&quot;half-manual-test_button&quot;);</span>
<a href="#l1.27"></a><span id="l1.27">         _enable(&quot;advanced-setup_button&quot;);</span>
<a href="#l1.28"></a><span id="l1.28">       });</span>
<a href="#l1.29"></a><span id="l1.29">   },</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/components/accountcreation/content/verifyConfig.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/components/accountcreation/content/verifyConfig.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -174,29 +174,25 @@ urlListener.prototype = {</span>
<a href="#l2.4"></a><span id="l2.4"> </span>
<a href="#l2.5"></a><span id="l2.5">   OnStopRunningUrl(aUrl, aExitCode) {</span>
<a href="#l2.6"></a><span id="l2.6">     this._log.info(&quot;Finished verifyConfig resulted in &quot; + aExitCode);</span>
<a href="#l2.7"></a><span id="l2.7">     if (Components.isSuccessCode(aExitCode)) {</span>
<a href="#l2.8"></a><span id="l2.8">       this._cleanup();</span>
<a href="#l2.9"></a><span id="l2.9">       this.mSuccessCallback(this.mConfig);</span>
<a href="#l2.10"></a><span id="l2.10">     } else if (!this.mAlter) {</span>
<a href="#l2.11"></a><span id="l2.11">       // Logon failed, and we aren't supposed to try other variations.</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-      this._cleanup();</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-      var errorMsg = getStringBundle(</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineminus">-          &quot;chrome://messenger/locale/accountCreationModel.properties&quot;)</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineminus">-          .GetStringFromName(&quot;cannot_login.error&quot;);</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineminus">-      this.mErrorCallback(new Exception(errorMsg));</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineplus">+      this._failed(aUrl);</span>
<a href="#l2.18"></a><span id="l2.18">     } else if (!this.mCertError) {</span>
<a href="#l2.19"></a><span id="l2.19">       // Try other variations, unless there's a cert error, in which</span>
<a href="#l2.20"></a><span id="l2.20">       // case we'll see what the user chooses.</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineminus">-      this.tryNextLogon();</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineplus">+      this.tryNextLogon(aUrl);</span>
<a href="#l2.23"></a><span id="l2.23">     }</span>
<a href="#l2.24"></a><span id="l2.24">   },</span>
<a href="#l2.25"></a><span id="l2.25"> </span>
<a href="#l2.26"></a><span id="l2.26" class="difflineminus">-  tryNextLogon() {</span>
<a href="#l2.27"></a><span id="l2.27" class="difflineplus">+  tryNextLogon(aPreviousUrl) {</span>
<a href="#l2.28"></a><span id="l2.28">     this._log.info(&quot;tryNextLogon()&quot;);</span>
<a href="#l2.29"></a><span id="l2.29">     this._log.info(&quot;  username=&quot; + (this.mConfig.incoming.username !=</span>
<a href="#l2.30"></a><span id="l2.30">                           this.mConfig.identity.emailAddress) +</span>
<a href="#l2.31"></a><span id="l2.31">                           &quot;, have savedUsername=&quot; +</span>
<a href="#l2.32"></a><span id="l2.32">                           (this.mConfig.usernameSaved ? &quot;true&quot; : &quot;false&quot;));</span>
<a href="#l2.33"></a><span id="l2.33">     this._log.info(&quot;  authMethod=&quot; + this.mServer.authMethod);</span>
<a href="#l2.34"></a><span id="l2.34">     // check if we tried full email address as username</span>
<a href="#l2.35"></a><span id="l2.35">     if (this.mConfig.incoming.username != this.mConfig.identity.emailAddress) {</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineat">@@ -255,33 +251,52 @@ urlListener.prototype = {</span>
<a href="#l2.37"></a><span id="l2.37">       this._log.info(&quot;  outgoing auth: &quot; + this.mConfig.outgoing.auth);</span>
<a href="#l2.38"></a><span id="l2.38">       verifyLogon(this.mConfig, this.mServer, this.mAlter, this.mMsgWindow,</span>
<a href="#l2.39"></a><span id="l2.39">                   this.mSuccessCallback, this.mErrorCallback);</span>
<a href="#l2.40"></a><span id="l2.40">       return;</span>
<a href="#l2.41"></a><span id="l2.41">     }</span>
<a href="#l2.42"></a><span id="l2.42"> </span>
<a href="#l2.43"></a><span id="l2.43">     // Tried all variations we can. Give up.</span>
<a href="#l2.44"></a><span id="l2.44">     this._log.info(&quot;Giving up.&quot;);</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineminus">-    this._cleanup();</span>
<a href="#l2.46"></a><span id="l2.46" class="difflineminus">-    let errorMsg = getStringBundle(</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineminus">-        &quot;chrome://messenger/locale/accountCreationModel.properties&quot;)</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineminus">-        .GetStringFromName(&quot;cannot_login.error&quot;);</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineminus">-    this.mErrorCallback(new Exception(errorMsg));</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineplus">+    this._failed(aPreviousUrl);</span>
<a href="#l2.51"></a><span id="l2.51">   },</span>
<a href="#l2.52"></a><span id="l2.52"> </span>
<a href="#l2.53"></a><span id="l2.53">   _cleanup() {</span>
<a href="#l2.54"></a><span id="l2.54">     try {</span>
<a href="#l2.55"></a><span id="l2.55">       // Avoid pref pollution, clear out server prefs.</span>
<a href="#l2.56"></a><span id="l2.56">       if (this.mServer) {</span>
<a href="#l2.57"></a><span id="l2.57">         MailServices.accounts.removeIncomingServer(this.mServer, true);</span>
<a href="#l2.58"></a><span id="l2.58">         this.mServer = null;</span>
<a href="#l2.59"></a><span id="l2.59">       }</span>
<a href="#l2.60"></a><span id="l2.60">     } catch (e) { this._log.error(e); }</span>
<a href="#l2.61"></a><span id="l2.61">   },</span>
<a href="#l2.62"></a><span id="l2.62"> </span>
<a href="#l2.63"></a><span id="l2.63" class="difflineplus">+  _failed(aUrl) {</span>
<a href="#l2.64"></a><span id="l2.64" class="difflineplus">+    this._cleanup();</span>
<a href="#l2.65"></a><span id="l2.65" class="difflineplus">+    var code = aUrl.errorCode || &quot;login-error-unknown&quot;;</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineplus">+    var msg = aUrl.errorMessage;</span>
<a href="#l2.67"></a><span id="l2.67" class="difflineplus">+    // *Only* for known (!) username/password errors, show our message.</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineplus">+    // But there are 1000 other reasons why it could have failed, e.g.</span>
<a href="#l2.69"></a><span id="l2.69" class="difflineplus">+    // server not reachable, bad auth method, server hiccups, or even</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineplus">+    // custom server messages that tell the user to do something,</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineplus">+    // so show the backend error message, unless we are certain</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineplus">+    // that it's a wrong username or password.</span>
<a href="#l2.73"></a><span id="l2.73" class="difflineplus">+    if (!msg || // Normal IMAP login error sets no error msg</span>
<a href="#l2.74"></a><span id="l2.74" class="difflineplus">+         code == &quot;pop3UsernameFailure&quot; ||</span>
<a href="#l2.75"></a><span id="l2.75" class="difflineplus">+         code == &quot;pop3PasswordFailed&quot; ||</span>
<a href="#l2.76"></a><span id="l2.76" class="difflineplus">+         code == &quot;imapOAuth2Error&quot;) {</span>
<a href="#l2.77"></a><span id="l2.77" class="difflineplus">+      msg = getStringBundle(</span>
<a href="#l2.78"></a><span id="l2.78" class="difflineplus">+        &quot;chrome://messenger/locale/accountCreationModel.properties&quot;)</span>
<a href="#l2.79"></a><span id="l2.79" class="difflineplus">+        .GetStringFromName(&quot;cannot_login.error&quot;);</span>
<a href="#l2.80"></a><span id="l2.80" class="difflineplus">+    }</span>
<a href="#l2.81"></a><span id="l2.81" class="difflineplus">+    var ex = new Exception(msg);</span>
<a href="#l2.82"></a><span id="l2.82" class="difflineplus">+    ex.code = code;</span>
<a href="#l2.83"></a><span id="l2.83" class="difflineplus">+    this.mErrorCallback(ex);</span>
<a href="#l2.84"></a><span id="l2.84" class="difflineplus">+  },</span>
<a href="#l2.85"></a><span id="l2.85" class="difflineplus">+</span>
<a href="#l2.86"></a><span id="l2.86">   // Suppress any certificate errors</span>
<a href="#l2.87"></a><span id="l2.87">   notifyCertProblem(socketInfo, status, targetSite) {</span>
<a href="#l2.88"></a><span id="l2.88">     this.mCertError = true;</span>
<a href="#l2.89"></a><span id="l2.89">     this._log.error(&quot;cert error&quot;);</span>
<a href="#l2.90"></a><span id="l2.90">     let self = this;</span>
<a href="#l2.91"></a><span id="l2.91">     setTimeout(function() {</span>
<a href="#l2.92"></a><span id="l2.92">       try {</span>
<a href="#l2.93"></a><span id="l2.93">         self.informUserOfCertError(socketInfo, status, targetSite);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/themes/shared/mail/accountCreation.css</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/themes/shared/mail/accountCreation.css</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -158,16 +158,17 @@ textbox.username {</span>
<a href="#l3.4"></a><span id="l3.4"> #manual-edit_area {</span>
<a href="#l3.5"></a><span id="l3.5">   margin-bottom: 2em;</span>
<a href="#l3.6"></a><span id="l3.6"> }</span>
<a href="#l3.7"></a><span id="l3.7"> </span>
<a href="#l3.8"></a><span id="l3.8"> /* status area */</span>
<a href="#l3.9"></a><span id="l3.9"> </span>
<a href="#l3.10"></a><span id="l3.10"> #status_msg {</span>
<a href="#l3.11"></a><span id="l3.11">   min-height: 1.5em;</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+  max-width: 30em;</span>
<a href="#l3.13"></a><span id="l3.13"> }</span>
<a href="#l3.14"></a><span id="l3.14"> </span>
<a href="#l3.15"></a><span id="l3.15"> #status-lines {</span>
<a href="#l3.16"></a><span id="l3.16">   -moz-box-pack: start;</span>
<a href="#l3.17"></a><span id="l3.17">   -moz-box-flex: 10;</span>
<a href="#l3.18"></a><span id="l3.18">   margin-left: 10em;</span>
<a href="#l3.19"></a><span id="l3.19"> }</span>
<a href="#l3.20"></a><span id="l3.20"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/base/public/nsIMsgMailNewsUrl.idl</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/base/public/nsIMsgMailNewsUrl.idl</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -83,16 +83,39 @@ interface nsIMsgMailNewsUrl : nsIURL {</span>
<a href="#l4.4"></a><span id="l4.4">   readonly attribute nsILoadGroup loadGroup;</span>
<a href="#l4.5"></a><span id="l4.5"> </span>
<a href="#l4.6"></a><span id="l4.6">   // search session, if we're running a search.</span>
<a href="#l4.7"></a><span id="l4.7">   attribute nsIMsgSearchSession searchSession;</span>
<a href="#l4.8"></a><span id="l4.8">   attribute boolean updatingFolder;</span>
<a href="#l4.9"></a><span id="l4.9">   attribute boolean msgIsInLocalCache;</span>
<a href="#l4.10"></a><span id="l4.10">   attribute boolean suppressErrorMsgs; // used to avoid displaying biff error messages</span>
<a href="#l4.11"></a><span id="l4.11"> </span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+  /**</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+   * Set after an error occurred.</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+   * It is not translated and contains no parameters.</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+   * It is unique to each different kind of error, i.e. the same</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineplus">+   * error has the same code, but a different error has a different code.</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineplus">+   * This allows to recover from specific errors programmatically,</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineplus">+   * or to keep error statistics.</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineplus">+   * If the error comes from a server, the implementor should make</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineplus">+   * efforts to pass on comparable server error identifiers and include</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineplus">+   * them here, e.g. as suffixes. Example: &quot;imap-sasl-S474&quot;, where-as &quot;S474&quot;</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineplus">+   * comes from the server annd &quot;imap-sasl-&quot; is the prefix for where the</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineplus">+   * server reports appears.</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineplus">+   */</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineplus">+  attribute ACString errorCode;</span>
<a href="#l4.26"></a><span id="l4.26" class="difflineplus">+  /**</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineplus">+   * Set after an error occurred.</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineplus">+   * An error message that can be displayed directly</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineplus">+   * to the end user without further processing.</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineplus">+   * It must have been translated.</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineplus">+   * It may contain contain values as part of the message.</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineplus">+   */</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineplus">+  attribute AString errorMessage;</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineplus">+</span>
<a href="#l4.35"></a><span id="l4.35">   attribute nsICacheEntry memCacheEntry;</span>
<a href="#l4.36"></a><span id="l4.36"> </span>
<a href="#l4.37"></a><span id="l4.37">   const unsigned long eCopy     = 0;</span>
<a href="#l4.38"></a><span id="l4.38">   const unsigned long eMove     = 1;</span>
<a href="#l4.39"></a><span id="l4.39">   const unsigned long eDisplay  = 2;</span>
<a href="#l4.40"></a><span id="l4.40">   boolean IsUrlType(in unsigned long type);</span>
<a href="#l4.41"></a><span id="l4.41">   nsIStreamListener getSaveAsListener(in boolean addDummyEnvelope, in nsIFile aFile);</span>
<a href="#l4.42"></a><span id="l4.42"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/base/util/nsMsgMailNewsUrl.cpp</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgMailNewsUrl.cpp</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -399,16 +399,37 @@ NS_IMETHODIMP nsMsgMailNewsUrl::GetSuppr</span>
<a href="#l5.4"></a><span id="l5.4">   return NS_OK;</span>
<a href="#l5.5"></a><span id="l5.5"> }</span>
<a href="#l5.6"></a><span id="l5.6"> </span>
<a href="#l5.7"></a><span id="l5.7"> NS_IMETHODIMP nsMsgMailNewsUrl::SetSuppressErrorMsgs(bool aSuppressErrorMsgs) {</span>
<a href="#l5.8"></a><span id="l5.8">   m_suppressErrorMsgs = aSuppressErrorMsgs;</span>
<a href="#l5.9"></a><span id="l5.9">   return NS_OK;</span>
<a href="#l5.10"></a><span id="l5.10"> }</span>
<a href="#l5.11"></a><span id="l5.11"> </span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+NS_IMETHODIMP nsMsgMailNewsUrl::GetErrorCode(nsACString &amp;aErrorCode) {</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+  aErrorCode = m_errorCode;</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+  return NS_OK;</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineplus">+}</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineplus">+</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineplus">+NS_IMETHODIMP nsMsgMailNewsUrl::SetErrorCode(const nsACString &amp;aErrorCode) {</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineplus">+  m_errorCode.Assign(aErrorCode);</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineplus">+  return NS_OK;</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineplus">+}</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineplus">+</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineplus">+NS_IMETHODIMP nsMsgMailNewsUrl::GetErrorMessage(nsAString &amp;aErrorMessage) {</span>
<a href="#l5.23"></a><span id="l5.23" class="difflineplus">+  aErrorMessage = m_errorMessage;</span>
<a href="#l5.24"></a><span id="l5.24" class="difflineplus">+  return NS_OK;</span>
<a href="#l5.25"></a><span id="l5.25" class="difflineplus">+}</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineplus">+</span>
<a href="#l5.27"></a><span id="l5.27" class="difflineplus">+NS_IMETHODIMP nsMsgMailNewsUrl::SetErrorMessage(</span>
<a href="#l5.28"></a><span id="l5.28" class="difflineplus">+    const nsAString &amp;aErrorMessage) {</span>
<a href="#l5.29"></a><span id="l5.29" class="difflineplus">+  m_errorMessage.Assign(aErrorMessage);</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineplus">+  return NS_OK;</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineplus">+}</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineplus">+</span>
<a href="#l5.33"></a><span id="l5.33"> NS_IMETHODIMP nsMsgMailNewsUrl::IsUrlType(uint32_t type, bool *isType) {</span>
<a href="#l5.34"></a><span id="l5.34">   // base class doesn't know about any specific types</span>
<a href="#l5.35"></a><span id="l5.35">   NS_ENSURE_ARG(isType);</span>
<a href="#l5.36"></a><span id="l5.36">   *isType = false;</span>
<a href="#l5.37"></a><span id="l5.37">   return NS_OK;</span>
<a href="#l5.38"></a><span id="l5.38"> }</span>
<a href="#l5.39"></a><span id="l5.39"> </span>
<a href="#l5.40"></a><span id="l5.40"> NS_IMETHODIMP nsMsgMailNewsUrl::SetSearchSession(</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/base/util/nsMsgMailNewsUrl.h</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgMailNewsUrl.h</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -107,17 +107,19 @@ class NS_MSG_BASE nsMsgMailNewsUrl : pub</span>
<a href="#l6.4"></a><span id="l6.4">   nsCOMPtr&lt;nsIURI&gt; m_normalizedOrigin;</span>
<a href="#l6.5"></a><span id="l6.5">   nsWeakPtr m_statusFeedbackWeak;</span>
<a href="#l6.6"></a><span id="l6.6">   nsWeakPtr m_msgWindowWeak;</span>
<a href="#l6.7"></a><span id="l6.7">   nsWeakPtr m_loadGroupWeak;</span>
<a href="#l6.8"></a><span id="l6.8">   nsCOMPtr&lt;nsIMimeHeaders&gt; mMimeHeaders;</span>
<a href="#l6.9"></a><span id="l6.9">   nsCOMPtr&lt;nsIMsgSearchSession&gt; m_searchSession;</span>
<a href="#l6.10"></a><span id="l6.10">   nsCOMPtr&lt;nsICacheEntry&gt; m_memCacheEntry;</span>
<a href="#l6.11"></a><span id="l6.11">   nsCOMPtr&lt;nsIMsgHeaderSink&gt; mMsgHeaderSink;</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-  char *m_errorMessage;</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+  nsCString m_errorCode;</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+  nsString m_errorMessage;</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+  nsString m_errorParameters;</span>
<a href="#l6.16"></a><span id="l6.16">   int64_t mMaxProgress;</span>
<a href="#l6.17"></a><span id="l6.17">   bool m_runningUrl;</span>
<a href="#l6.18"></a><span id="l6.18">   bool m_updatingFolder;</span>
<a href="#l6.19"></a><span id="l6.19">   bool m_msgIsInLocalCache;</span>
<a href="#l6.20"></a><span id="l6.20">   bool m_suppressErrorMsgs;</span>
<a href="#l6.21"></a><span id="l6.21">   bool m_hasNormalizedOrigin;</span>
<a href="#l6.22"></a><span id="l6.22"> </span>
<a href="#l6.23"></a><span id="l6.23">   // the following field is really a bit of a hack to make</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/imap/src/nsImapIncomingServer.cpp</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapIncomingServer.cpp</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -1683,17 +1683,22 @@ nsImapIncomingServer::FEAlert(const nsAS</span>
<a href="#l7.4"></a><span id="l7.4">     nsresult rv = GetPrettyName(hostName);</span>
<a href="#l7.5"></a><span id="l7.5">     if (NS_SUCCEEDED(rv)) {</span>
<a href="#l7.6"></a><span id="l7.6">       nsString message;</span>
<a href="#l7.7"></a><span id="l7.7">       nsString tempString(aAlertString);</span>
<a href="#l7.8"></a><span id="l7.8">       const char16_t *params[] = {hostName.get(), tempString.get()};</span>
<a href="#l7.9"></a><span id="l7.9"> </span>
<a href="#l7.10"></a><span id="l7.10">       rv = m_stringBundle-&gt;FormatStringFromName(&quot;imapServerAlert&quot;, params, 2,</span>
<a href="#l7.11"></a><span id="l7.11">                                                 message);</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-      if (NS_SUCCEEDED(rv)) return AlertUser(message, aUrl);</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+      if (NS_SUCCEEDED(rv)) {</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+        aUrl-&gt;SetErrorCode(NS_LITERAL_CSTRING(&quot;imap-server-alert&quot;));</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+        aUrl-&gt;SetErrorMessage(message);</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineplus">+</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineplus">+        return AlertUser(message, aUrl);</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineplus">+      }</span>
<a href="#l7.19"></a><span id="l7.19">     }</span>
<a href="#l7.20"></a><span id="l7.20">   }</span>
<a href="#l7.21"></a><span id="l7.21">   return AlertUser(aAlertString, aUrl);</span>
<a href="#l7.22"></a><span id="l7.22"> }</span>
<a href="#l7.23"></a><span id="l7.23"> </span>
<a href="#l7.24"></a><span id="l7.24"> nsresult nsImapIncomingServer::AlertUser(const nsAString &amp;aString,</span>
<a href="#l7.25"></a><span id="l7.25">                                          nsIMsgMailNewsUrl *aUrl) {</span>
<a href="#l7.26"></a><span id="l7.26">   nsresult rv;</span>
<a href="#l7.27"></a><span id="l7.27" class="difflineat">@@ -1716,17 +1721,22 @@ nsImapIncomingServer::FEAlertWithName(co</span>
<a href="#l7.28"></a><span id="l7.28"> </span>
<a href="#l7.29"></a><span id="l7.29">   if (m_stringBundle) {</span>
<a href="#l7.30"></a><span id="l7.30">     nsAutoCString hostName;</span>
<a href="#l7.31"></a><span id="l7.31">     nsresult rv = GetHostName(hostName);</span>
<a href="#l7.32"></a><span id="l7.32">     if (NS_SUCCEEDED(rv)) {</span>
<a href="#l7.33"></a><span id="l7.33">       const NS_ConvertUTF8toUTF16 hostName16(hostName);</span>
<a href="#l7.34"></a><span id="l7.34">       const char16_t *params[] = {hostName16.get()};</span>
<a href="#l7.35"></a><span id="l7.35">       rv = m_stringBundle-&gt;FormatStringFromName(aMsgName, params, 1, message);</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineminus">-      if (NS_SUCCEEDED(rv)) return AlertUser(message, aUrl);</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineplus">+      if (NS_SUCCEEDED(rv)) {</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineplus">+        aUrl-&gt;SetErrorCode(nsDependentCString(aMsgName));</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineplus">+        aUrl-&gt;SetErrorMessage(message);</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineplus">+</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineplus">+        return AlertUser(message, aUrl);</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineplus">+      }</span>
<a href="#l7.43"></a><span id="l7.43">     }</span>
<a href="#l7.44"></a><span id="l7.44">   }</span>
<a href="#l7.45"></a><span id="l7.45"> </span>
<a href="#l7.46"></a><span id="l7.46">   // Error condition</span>
<a href="#l7.47"></a><span id="l7.47">   message.AssignLiteral(&quot;String Name &quot;);</span>
<a href="#l7.48"></a><span id="l7.48">   message.AppendASCII(aMsgName);</span>
<a href="#l7.49"></a><span id="l7.49">   FEAlert(message, aUrl);</span>
<a href="#l7.50"></a><span id="l7.50">   return NS_OK;</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineat">@@ -1765,16 +1775,19 @@ NS_IMETHODIMP nsImapIncomingServer::FEAl</span>
<a href="#l7.52"></a><span id="l7.52">   nsImapAction imapAction;</span>
<a href="#l7.53"></a><span id="l7.53"> </span>
<a href="#l7.54"></a><span id="l7.54">   imapUrl-&gt;GetRequiredImapState(&amp;imapState);</span>
<a href="#l7.55"></a><span id="l7.55">   imapUrl-&gt;GetImapAction(&amp;imapAction);</span>
<a href="#l7.56"></a><span id="l7.56">   nsString folderName;</span>
<a href="#l7.57"></a><span id="l7.57"> </span>
<a href="#l7.58"></a><span id="l7.58">   NS_ConvertUTF8toUTF16 unicodeMsg(message);</span>
<a href="#l7.59"></a><span id="l7.59"> </span>
<a href="#l7.60"></a><span id="l7.60" class="difflineplus">+  aUrl-&gt;SetErrorCode(NS_LITERAL_CSTRING(&quot;imap-server-error&quot;));</span>
<a href="#l7.61"></a><span id="l7.61" class="difflineplus">+  aUrl-&gt;SetErrorMessage(unicodeMsg);</span>
<a href="#l7.62"></a><span id="l7.62" class="difflineplus">+</span>
<a href="#l7.63"></a><span id="l7.63">   nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l7.64"></a><span id="l7.64">   if (imapState == nsIImapUrl::nsImapSelectedState ||</span>
<a href="#l7.65"></a><span id="l7.65">       imapAction == nsIImapUrl::nsImapFolderStatus) {</span>
<a href="#l7.66"></a><span id="l7.66">     aUrl-&gt;GetFolder(getter_AddRefs(folder));</span>
<a href="#l7.67"></a><span id="l7.67">     if (folder) folder-&gt;GetPrettyName(folderName);</span>
<a href="#l7.68"></a><span id="l7.68">     numStrings = 3;</span>
<a href="#l7.69"></a><span id="l7.69">     msgName = &quot;imapFolderCommandFailed&quot;;</span>
<a href="#l7.70"></a><span id="l7.70">     formatStrings[1] = folderName.get();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/local/src/nsPop3Protocol.cpp</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/local/src/nsPop3Protocol.cpp</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -1176,69 +1176,73 @@ int32_t nsPop3Protocol::WaitForResponse(</span>
<a href="#l8.4"></a><span id="l8.4"> </span>
<a href="#l8.5"></a><span id="l8.5">   PR_Free(line);</span>
<a href="#l8.6"></a><span id="l8.6">   return (1); /* everything ok */</span>
<a href="#l8.7"></a><span id="l8.7"> }</span>
<a href="#l8.8"></a><span id="l8.8"> </span>
<a href="#l8.9"></a><span id="l8.9"> int32_t nsPop3Protocol::Error(const char *err_code, const char16_t **params,</span>
<a href="#l8.10"></a><span id="l8.10">                               uint32_t length) {</span>
<a href="#l8.11"></a><span id="l8.11">   MOZ_LOG(POP3LOGMODULE, LogLevel::Info, (POP3LOG(&quot;ERROR: %s&quot;), err_code));</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+  nsresult rv = NS_OK;</span>
<a href="#l8.13"></a><span id="l8.13"> </span>
<a href="#l8.14"></a><span id="l8.14">   // the error code is just the resource name for the error string...</span>
<a href="#l8.15"></a><span id="l8.15">   // so print out that error message!</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineplus">+  nsAutoString message;</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineplus">+  // Format the alert string if parameter list isn't empty</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineplus">+  if (params) {</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineplus">+    mLocalBundle-&gt;FormatStringFromName(err_code, params, length, message);</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineplus">+  } else {</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineplus">+    mLocalBundle-&gt;GetStringFromName(err_code, message);</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineplus">+  }</span>
<a href="#l8.23"></a><span id="l8.23" class="difflineplus">+  if (!m_pop3ConData-&gt;command_succeeded) {</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineplus">+    // Server error message</span>
<a href="#l8.25"></a><span id="l8.25" class="difflineplus">+    nsString serverSaidPrefix;</span>
<a href="#l8.26"></a><span id="l8.26" class="difflineplus">+    nsCOMPtr&lt;nsIMsgIncomingServer&gt; server = do_QueryInterface(m_pop3Server);</span>
<a href="#l8.27"></a><span id="l8.27" class="difflineplus">+    nsCString hostName;</span>
<a href="#l8.28"></a><span id="l8.28" class="difflineplus">+    // Format string with hostname.</span>
<a href="#l8.29"></a><span id="l8.29" class="difflineplus">+    if (server) {</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineplus">+      rv = server-&gt;GetRealHostName(hostName);</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineplus">+    }</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineplus">+      nsAutoString hostStr;</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineplus">+      CopyASCIItoUTF16(hostName, hostStr);</span>
<a href="#l8.35"></a><span id="l8.35" class="difflineplus">+      const char16_t *params[] = {hostStr.get()};</span>
<a href="#l8.36"></a><span id="l8.36" class="difflineplus">+      mLocalBundle-&gt;FormatStringFromName(&quot;pop3ServerSaid&quot;, params, 1,</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineplus">+                                         serverSaidPrefix);</span>
<a href="#l8.38"></a><span id="l8.38" class="difflineplus">+    }</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineplus">+</span>
<a href="#l8.40"></a><span id="l8.40" class="difflineplus">+    message.Append(' ');</span>
<a href="#l8.41"></a><span id="l8.41" class="difflineplus">+    message.Append(serverSaidPrefix);</span>
<a href="#l8.42"></a><span id="l8.42" class="difflineplus">+    message.Append(' ');</span>
<a href="#l8.43"></a><span id="l8.43" class="difflineplus">+    message.Append(NS_ConvertASCIItoUTF16(m_commandResponse));</span>
<a href="#l8.44"></a><span id="l8.44" class="difflineplus">+  }</span>
<a href="#l8.45"></a><span id="l8.45" class="difflineplus">+</span>
<a href="#l8.46"></a><span id="l8.46" class="difflineplus">+  nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsUrl = do_QueryInterface(m_url, &amp;rv);</span>
<a href="#l8.47"></a><span id="l8.47" class="difflineplus">+  mailnewsUrl-&gt;SetErrorCode(nsDependentCString(err_code));</span>
<a href="#l8.48"></a><span id="l8.48" class="difflineplus">+  mailnewsUrl-&gt;SetErrorMessage(message);</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineplus">+</span>
<a href="#l8.50"></a><span id="l8.50">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server = do_QueryInterface(m_pop3Server);</span>
<a href="#l8.51"></a><span id="l8.51">   nsString accountName;</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineminus">-  nsresult rv = server-&gt;GetPrettyName(accountName);</span>
<a href="#l8.53"></a><span id="l8.53" class="difflineplus">+  rv = server-&gt;GetPrettyName(accountName);</span>
<a href="#l8.54"></a><span id="l8.54">   NS_ENSURE_SUCCESS(rv, -1);</span>
<a href="#l8.55"></a><span id="l8.55">   const char16_t *titleParams[] = {accountName.get()};</span>
<a href="#l8.56"></a><span id="l8.56">   nsString dialogTitle;</span>
<a href="#l8.57"></a><span id="l8.57">   mLocalBundle-&gt;FormatStringFromName(&quot;pop3ErrorDialogTitle&quot;, titleParams, 1,</span>
<a href="#l8.58"></a><span id="l8.58">                                      dialogTitle);</span>
<a href="#l8.59"></a><span id="l8.59" class="difflineminus">-  nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsUrl = do_QueryInterface(m_url, &amp;rv);</span>
<a href="#l8.60"></a><span id="l8.60">   // we handle &quot;pop3TmpDownloadError&quot; earlier...</span>
<a href="#l8.61"></a><span id="l8.61">   if (strcmp(err_code, &quot;pop3TmpDownloadError&quot;) &amp;&amp; NS_SUCCEEDED(rv)) {</span>
<a href="#l8.62"></a><span id="l8.62">     nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow;</span>
<a href="#l8.63"></a><span id="l8.63">     nsCOMPtr&lt;nsIPrompt&gt; dialog;</span>
<a href="#l8.64"></a><span id="l8.64">     rv = mailnewsUrl-&gt;GetMsgWindow(</span>
<a href="#l8.65"></a><span id="l8.65">         getter_AddRefs(msgWindow));  // it is ok to have null msgWindow, for</span>
<a href="#l8.66"></a><span id="l8.66">                                      // example when biffing</span>
<a href="#l8.67"></a><span id="l8.67">     if (NS_SUCCEEDED(rv) &amp;&amp; msgWindow) {</span>
<a href="#l8.68"></a><span id="l8.68">       rv = msgWindow-&gt;GetPromptDialog(getter_AddRefs(dialog));</span>
<a href="#l8.69"></a><span id="l8.69">       if (NS_SUCCEEDED(rv)) {</span>
<a href="#l8.70"></a><span id="l8.70" class="difflineminus">-        nsString alertString;</span>
<a href="#l8.71"></a><span id="l8.71" class="difflineminus">-        // Format the alert string if parameter list isn't empty</span>
<a href="#l8.72"></a><span id="l8.72" class="difflineminus">-        if (params)</span>
<a href="#l8.73"></a><span id="l8.73" class="difflineminus">-          mLocalBundle-&gt;FormatStringFromName(err_code, params, length,</span>
<a href="#l8.74"></a><span id="l8.74" class="difflineminus">-                                             alertString);</span>
<a href="#l8.75"></a><span id="l8.75" class="difflineminus">-        else</span>
<a href="#l8.76"></a><span id="l8.76" class="difflineminus">-          mLocalBundle-&gt;GetStringFromName(err_code, alertString);</span>
<a href="#l8.77"></a><span id="l8.77" class="difflineminus">-        if (m_pop3ConData-&gt;command_succeeded)  // not a server error message</span>
<a href="#l8.78"></a><span id="l8.78" class="difflineminus">-          dialog-&gt;Alert(dialogTitle.get(), alertString.get());</span>
<a href="#l8.79"></a><span id="l8.79" class="difflineminus">-        else {</span>
<a href="#l8.80"></a><span id="l8.80" class="difflineminus">-          nsString serverSaidPrefix;</span>
<a href="#l8.81"></a><span id="l8.81" class="difflineminus">-          nsCOMPtr&lt;nsIMsgIncomingServer&gt; server =</span>
<a href="#l8.82"></a><span id="l8.82" class="difflineminus">-              do_QueryInterface(m_pop3Server);</span>
<a href="#l8.83"></a><span id="l8.83" class="difflineminus">-          nsCString hostName;</span>
<a href="#l8.84"></a><span id="l8.84" class="difflineminus">-          // Fomat string with hostname.</span>
<a href="#l8.85"></a><span id="l8.85" class="difflineminus">-          if (server) rv = server-&gt;GetRealHostName(hostName);</span>
<a href="#l8.86"></a><span id="l8.86" class="difflineminus">-          if (NS_SUCCEEDED(rv)) {</span>
<a href="#l8.87"></a><span id="l8.87" class="difflineminus">-            nsAutoString hostStr;</span>
<a href="#l8.88"></a><span id="l8.88" class="difflineminus">-            CopyASCIItoUTF16(hostName, hostStr);</span>
<a href="#l8.89"></a><span id="l8.89" class="difflineminus">-            const char16_t *params[] = {hostStr.get()};</span>
<a href="#l8.90"></a><span id="l8.90" class="difflineminus">-            mLocalBundle-&gt;FormatStringFromName(&quot;pop3ServerSaid&quot;, params, 1,</span>
<a href="#l8.91"></a><span id="l8.91" class="difflineminus">-                                               serverSaidPrefix);</span>
<a href="#l8.92"></a><span id="l8.92" class="difflineminus">-          }</span>
<a href="#l8.93"></a><span id="l8.93" class="difflineminus">-</span>
<a href="#l8.94"></a><span id="l8.94" class="difflineminus">-          nsAutoString message(alertString);</span>
<a href="#l8.95"></a><span id="l8.95" class="difflineminus">-          message.Append(' ');</span>
<a href="#l8.96"></a><span id="l8.96" class="difflineminus">-          message.Append(serverSaidPrefix);</span>
<a href="#l8.97"></a><span id="l8.97" class="difflineminus">-          message.Append(' ');</span>
<a href="#l8.98"></a><span id="l8.98" class="difflineminus">-          message.Append(NS_ConvertASCIItoUTF16(m_commandResponse));</span>
<a href="#l8.99"></a><span id="l8.99" class="difflineminus">-          dialog-&gt;Alert(dialogTitle.get(), message.get());</span>
<a href="#l8.100"></a><span id="l8.100" class="difflineminus">-        }</span>
<a href="#l8.101"></a><span id="l8.101" class="difflineplus">+        dialog-&gt;Alert(dialogTitle.get(), message.get());</span>
<a href="#l8.102"></a><span id="l8.102">       }</span>
<a href="#l8.103"></a><span id="l8.103">     }</span>
<a href="#l8.104"></a><span id="l8.104">   }</span>
<a href="#l8.105"></a><span id="l8.105">   m_pop3ConData-&gt;next_state = POP3_ERROR_DONE;</span>
<a href="#l8.106"></a><span id="l8.106">   m_pop3ConData-&gt;pause_for_read = false;</span>
<a href="#l8.107"></a><span id="l8.107">   return -1;</span>
<a href="#l8.108"></a><span id="l8.108"> }</span>
<a href="#l8.109"></a><span id="l8.109"> </span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:32Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

