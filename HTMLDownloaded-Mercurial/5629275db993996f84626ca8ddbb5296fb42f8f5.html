<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 28274:5629275db993996f84626ca8ddbb5296fb42f8f5</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 5629275db993996f84626ca8ddbb5296fb42f8f5" />
<meta property="og:url" content="/comm-central/rev/5629275db993996f84626ca8ddbb5296fb42f8f5" />
<meta property="og:description" content="Bug 1599031 - Protect keyring using an automatic password that's protected with the master password. r=patrick DONTBUILD" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 5629275db993996f84626ca8ddbb5296fb42f8f5 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/5629275db993996f84626ca8ddbb5296fb42f8f5">shortlog</a> |
<a href="/comm-central/log/5629275db993996f84626ca8ddbb5296fb42f8f5">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/5629275db993996f84626ca8ddbb5296fb42f8f5">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/5629275db993996f84626ca8ddbb5296fb42f8f5">files</a> |
changeset |
<a href="/comm-central/raw-rev/5629275db993996f84626ca8ddbb5296fb42f8f5">raw</a>  | <a href="/comm-central/archive/5629275db993996f84626ca8ddbb5296fb42f8f5.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1599031">Bug 1599031</a> - Protect keyring using an automatic password that's protected with the master password. r=patrick DONTBUILD
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#75;&#97;&#105;&#32;&#69;&#110;&#103;&#101;&#114;&#116;&#32;&#60;&#107;&#97;&#105;&#101;&#64;&#107;&#117;&#105;&#120;&#46;&#100;&#101;&#62;</td></tr>
<tr><td></td><td class="date age">Wed, 27 Nov 2019 11:17:34 +0100</td></tr>

<tr>
 <td>changeset 28274</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/5629275db993996f84626ca8ddbb5296fb42f8f5">5629275db993996f84626ca8ddbb5296fb42f8f5</a></td>
</tr>



<tr>
<td>parent 28273</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/01810b29d5ec858b90d01ce47999cccae993ae3e">01810b29d5ec858b90d01ce47999cccae993ae3e</a>
</td>
</tr>

<tr>
<td>child 28275</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/388b8b71c9cf8b7a0e50812c2acfc3d0d9f864da">388b8b71c9cf8b7a0e50812c2acfc3d0d9f864da</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=5629275db993996f84626ca8ddbb5296fb42f8f5">16733</a></td></tr>
<tr><td>push user</td><td>kaie@kuix.de</td></tr>
<tr><td>push date</td><td class="date age">Wed, 27 Nov 2019 10:20:07 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@10abecc1ae80 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=10abecc1ae80917bc510391bdaa96060e8401440">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=10abecc1ae80917bc510391bdaa96060e8401440&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=10abecc1ae80917bc510391bdaa96060e8401440&newProject=comm-central&newRevision=4213d50b5bfcc46f65d4ac64903ff21ee0105e05&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=10abecc1ae80917bc510391bdaa96060e8401440&newProject=comm-central&newRevision=4213d50b5bfcc46f65d4ac64903ff21ee0105e05&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=10abecc1ae80917bc510391bdaa96060e8401440&newProject=comm-central&newRevision=4213d50b5bfcc46f65d4ac64903ff21ee0105e05&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28patrick%29&revcount=50">patrick</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1599031">1599031</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1599031">Bug 1599031</a> - Protect keyring using an automatic password that's protected with the master password. r=patrick DONTBUILD</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5629275db993996f84626ca8ddbb5296fb42f8f5/mail/extensions/openpgp/content/modules/decryption.jsm">mail/extensions/openpgp/content/modules/decryption.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5629275db993996f84626ca8ddbb5296fb42f8f5/mail/extensions/openpgp/content/modules/decryption.jsm">file</a> |
<a href="/comm-central/annotate/5629275db993996f84626ca8ddbb5296fb42f8f5/mail/extensions/openpgp/content/modules/decryption.jsm">annotate</a> |
<a href="/comm-central/diff/5629275db993996f84626ca8ddbb5296fb42f8f5/mail/extensions/openpgp/content/modules/decryption.jsm">diff</a> |
<a href="/comm-central/comparison/5629275db993996f84626ca8ddbb5296fb42f8f5/mail/extensions/openpgp/content/modules/decryption.jsm">comparison</a> |
<a href="/comm-central/log/5629275db993996f84626ca8ddbb5296fb42f8f5/mail/extensions/openpgp/content/modules/decryption.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5629275db993996f84626ca8ddbb5296fb42f8f5/mail/extensions/openpgp/content/modules/masterpass.jsm">mail/extensions/openpgp/content/modules/masterpass.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5629275db993996f84626ca8ddbb5296fb42f8f5/mail/extensions/openpgp/content/modules/masterpass.jsm">file</a> |
<a href="/comm-central/annotate/5629275db993996f84626ca8ddbb5296fb42f8f5/mail/extensions/openpgp/content/modules/masterpass.jsm">annotate</a> |
<a href="/comm-central/diff/5629275db993996f84626ca8ddbb5296fb42f8f5/mail/extensions/openpgp/content/modules/masterpass.jsm">diff</a> |
<a href="/comm-central/comparison/5629275db993996f84626ca8ddbb5296fb42f8f5/mail/extensions/openpgp/content/modules/masterpass.jsm">comparison</a> |
<a href="/comm-central/log/5629275db993996f84626ca8ddbb5296fb42f8f5/mail/extensions/openpgp/content/modules/masterpass.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5629275db993996f84626ca8ddbb5296fb42f8f5/mail/extensions/openpgp/content/modules/rnp.jsm">mail/extensions/openpgp/content/modules/rnp.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5629275db993996f84626ca8ddbb5296fb42f8f5/mail/extensions/openpgp/content/modules/rnp.jsm">file</a> |
<a href="/comm-central/annotate/5629275db993996f84626ca8ddbb5296fb42f8f5/mail/extensions/openpgp/content/modules/rnp.jsm">annotate</a> |
<a href="/comm-central/diff/5629275db993996f84626ca8ddbb5296fb42f8f5/mail/extensions/openpgp/content/modules/rnp.jsm">diff</a> |
<a href="/comm-central/comparison/5629275db993996f84626ca8ddbb5296fb42f8f5/mail/extensions/openpgp/content/modules/rnp.jsm">comparison</a> |
<a href="/comm-central/log/5629275db993996f84626ca8ddbb5296fb42f8f5/mail/extensions/openpgp/content/modules/rnp.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5629275db993996f84626ca8ddbb5296fb42f8f5/mail/extensions/openpgp/content/modules/rnpLib.jsm">mail/extensions/openpgp/content/modules/rnpLib.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5629275db993996f84626ca8ddbb5296fb42f8f5/mail/extensions/openpgp/content/modules/rnpLib.jsm">file</a> |
<a href="/comm-central/annotate/5629275db993996f84626ca8ddbb5296fb42f8f5/mail/extensions/openpgp/content/modules/rnpLib.jsm">annotate</a> |
<a href="/comm-central/diff/5629275db993996f84626ca8ddbb5296fb42f8f5/mail/extensions/openpgp/content/modules/rnpLib.jsm">diff</a> |
<a href="/comm-central/comparison/5629275db993996f84626ca8ddbb5296fb42f8f5/mail/extensions/openpgp/content/modules/rnpLib.jsm">comparison</a> |
<a href="/comm-central/log/5629275db993996f84626ca8ddbb5296fb42f8f5/mail/extensions/openpgp/content/modules/rnpLib.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5629275db993996f84626ca8ddbb5296fb42f8f5/mail/extensions/openpgp/content/ui/enigmailCommon.js">mail/extensions/openpgp/content/ui/enigmailCommon.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5629275db993996f84626ca8ddbb5296fb42f8f5/mail/extensions/openpgp/content/ui/enigmailCommon.js">file</a> |
<a href="/comm-central/annotate/5629275db993996f84626ca8ddbb5296fb42f8f5/mail/extensions/openpgp/content/ui/enigmailCommon.js">annotate</a> |
<a href="/comm-central/diff/5629275db993996f84626ca8ddbb5296fb42f8f5/mail/extensions/openpgp/content/ui/enigmailCommon.js">diff</a> |
<a href="/comm-central/comparison/5629275db993996f84626ca8ddbb5296fb42f8f5/mail/extensions/openpgp/content/ui/enigmailCommon.js">comparison</a> |
<a href="/comm-central/log/5629275db993996f84626ca8ddbb5296fb42f8f5/mail/extensions/openpgp/content/ui/enigmailCommon.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5629275db993996f84626ca8ddbb5296fb42f8f5/mail/extensions/openpgp/content/ui/enigmailKeygen.js">mail/extensions/openpgp/content/ui/enigmailKeygen.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5629275db993996f84626ca8ddbb5296fb42f8f5/mail/extensions/openpgp/content/ui/enigmailKeygen.js">file</a> |
<a href="/comm-central/annotate/5629275db993996f84626ca8ddbb5296fb42f8f5/mail/extensions/openpgp/content/ui/enigmailKeygen.js">annotate</a> |
<a href="/comm-central/diff/5629275db993996f84626ca8ddbb5296fb42f8f5/mail/extensions/openpgp/content/ui/enigmailKeygen.js">diff</a> |
<a href="/comm-central/comparison/5629275db993996f84626ca8ddbb5296fb42f8f5/mail/extensions/openpgp/content/ui/enigmailKeygen.js">comparison</a> |
<a href="/comm-central/log/5629275db993996f84626ca8ddbb5296fb42f8f5/mail/extensions/openpgp/content/ui/enigmailKeygen.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5629275db993996f84626ca8ddbb5296fb42f8f5/mail/extensions/openpgp/content/ui/enigmailKeygen.xul">mail/extensions/openpgp/content/ui/enigmailKeygen.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5629275db993996f84626ca8ddbb5296fb42f8f5/mail/extensions/openpgp/content/ui/enigmailKeygen.xul">file</a> |
<a href="/comm-central/annotate/5629275db993996f84626ca8ddbb5296fb42f8f5/mail/extensions/openpgp/content/ui/enigmailKeygen.xul">annotate</a> |
<a href="/comm-central/diff/5629275db993996f84626ca8ddbb5296fb42f8f5/mail/extensions/openpgp/content/ui/enigmailKeygen.xul">diff</a> |
<a href="/comm-central/comparison/5629275db993996f84626ca8ddbb5296fb42f8f5/mail/extensions/openpgp/content/ui/enigmailKeygen.xul">comparison</a> |
<a href="/comm-central/log/5629275db993996f84626ca8ddbb5296fb42f8f5/mail/extensions/openpgp/content/ui/enigmailKeygen.xul">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/decryption.jsm</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/decryption.jsm</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -225,16 +225,17 @@ var EnigmailDecryption = {</span>
<a href="#l1.4"></a><span id="l1.4"> </span>
<a href="#l1.5"></a><span id="l1.5">     // do not return anything if gpg signales DECRYPTION_FAILED</span>
<a href="#l1.6"></a><span id="l1.6">     // (which could be possible in case of MDC errors)</span>
<a href="#l1.7"></a><span id="l1.7">     if ((uiFlags &amp; EnigmailConstants.UI_IGNORE_MDC_ERROR) &amp;&amp;</span>
<a href="#l1.8"></a><span id="l1.8">       (result.statusFlags &amp; EnigmailConstants.MISSING_MDC)) {</span>
<a href="#l1.9"></a><span id="l1.9">       EnigmailLog.DEBUG(&quot;decryption.jsm: decryptMessage: ignoring MDC error\n&quot;);</span>
<a href="#l1.10"></a><span id="l1.10">     }</span>
<a href="#l1.11"></a><span id="l1.11">     else if (result.statusFlags &amp; EnigmailConstants.DECRYPTION_FAILED) {</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+      EnigmailLog.DEBUG(&quot;decryption.jsm: decryptMessage: failed\n&quot;);</span>
<a href="#l1.13"></a><span id="l1.13">       plainText = &quot;&quot;;</span>
<a href="#l1.14"></a><span id="l1.14">     }</span>
<a href="#l1.15"></a><span id="l1.15"> </span>
<a href="#l1.16"></a><span id="l1.16">     userIdObj.value = result.userId;</span>
<a href="#l1.17"></a><span id="l1.17">     keyIdObj.value = result.keyId;</span>
<a href="#l1.18"></a><span id="l1.18">     sigDetailsObj.value = result.sigDetails;</span>
<a href="#l1.19"></a><span id="l1.19">     if (encToDetailsObj) {</span>
<a href="#l1.20"></a><span id="l1.20">       encToDetailsObj.value = result.encToDetails;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/masterpass.jsm</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/masterpass.jsm</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -46,16 +46,18 @@ var OpenPGPMasterpass = {</span>
<a href="#l2.4"></a><span id="l2.4">     } catch (ex) {</span>
<a href="#l2.5"></a><span id="l2.5">       EnigmailLog.writeException(&quot;masterpass.jsm&quot;, ex);</span>
<a href="#l2.6"></a><span id="l2.6">       throw ex;</span>
<a href="#l2.7"></a><span id="l2.7">     }</span>
<a href="#l2.8"></a><span id="l2.8">     EnigmailLog.DEBUG(&quot;masterpass.jsm: ensureMasterPassword(): ok\n&quot;);</span>
<a href="#l2.9"></a><span id="l2.9">   },</span>
<a href="#l2.10"></a><span id="l2.10"> </span>
<a href="#l2.11"></a><span id="l2.11">   generatePassword: function() {</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+    // TODO: Patrick suggested to replace with</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+    //       EnigmailRNG.getRandomString(numChars)</span>
<a href="#l2.14"></a><span id="l2.14">     const random_bytes = new Uint8Array(32);</span>
<a href="#l2.15"></a><span id="l2.15">     crypto.getRandomValues(random_bytes);</span>
<a href="#l2.16"></a><span id="l2.16">     let result = &quot;&quot;;</span>
<a href="#l2.17"></a><span id="l2.17">     for (let i = 0; i &lt; 32; i++) {</span>
<a href="#l2.18"></a><span id="l2.18">       result += (random_bytes[i] % 16).toString(16);</span>
<a href="#l2.19"></a><span id="l2.19">     }</span>
<a href="#l2.20"></a><span id="l2.20">     return result;</span>
<a href="#l2.21"></a><span id="l2.21">   },</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/rnp.jsm</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/rnp.jsm</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -342,16 +342,20 @@ console.log(&quot;rnp_key_get_subkey_count: &quot;</span>
<a href="#l3.4"></a><span id="l3.4">         ).contents;</span>
<a href="#l3.5"></a><span id="l3.5"> </span>
<a href="#l3.6"></a><span id="l3.6">         result.statusFlags |= EnigmailConstants.DECRYPTION_OKAY;</span>
<a href="#l3.7"></a><span id="l3.7">         result.decryptedData = char_array.readString();</span>
<a href="#l3.8"></a><span id="l3.8">         console.log(result.decryptedData);</span>
<a href="#l3.9"></a><span id="l3.9">       }</span>
<a href="#l3.10"></a><span id="l3.10">     }</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+    if (!(result.statusFlags &amp; EnigmailConstants.DECRYPTION_OKAY)) {</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+      result.statusFlags |= EnigmailConstants.DECRYPTION_FAILED;</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+    }</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+</span>
<a href="#l3.16"></a><span id="l3.16">     RNPLib.rnp_input_destroy(input_from_memory);</span>
<a href="#l3.17"></a><span id="l3.17">     RNPLib.rnp_output_destroy(output_to_memory);</span>
<a href="#l3.18"></a><span id="l3.18"> </span>
<a href="#l3.19"></a><span id="l3.19">     return result;</span>
<a href="#l3.20"></a><span id="l3.20">   },</span>
<a href="#l3.21"></a><span id="l3.21">   </span>
<a href="#l3.22"></a><span id="l3.22">   genKey(userId, keyType, keyBits, expiryDays, passphrase) {</span>
<a href="#l3.23"></a><span id="l3.23">     </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/rnpLib.jsm</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/rnpLib.jsm</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -5,16 +5,19 @@</span>
<a href="#l4.4"></a><span id="l4.4"> const { ctypes } = ChromeUtils.import(&quot;resource://gre/modules/ctypes.jsm&quot;);</span>
<a href="#l4.5"></a><span id="l4.5"> const { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l4.6"></a><span id="l4.6"> var systemOS = Services.appinfo.OS.toLowerCase();</span>
<a href="#l4.7"></a><span id="l4.7"> const { OS } = ChromeUtils.import(&quot;resource://gre/modules/osfile.jsm&quot;);</span>
<a href="#l4.8"></a><span id="l4.8"> var abi = ctypes.default_abi;</span>
<a href="#l4.9"></a><span id="l4.9"> const EnigmailApp = ChromeUtils.import(</span>
<a href="#l4.10"></a><span id="l4.10">   &quot;chrome://openpgp/content/modules/app.jsm&quot;</span>
<a href="#l4.11"></a><span id="l4.11"> ).EnigmailApp;</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+var OpenPGPMasterpass = ChromeUtils.import(</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+  &quot;chrome://openpgp/content/modules/masterpass.jsm&quot;</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+).OpenPGPMasterpass;</span>
<a href="#l4.15"></a><span id="l4.15"> </span>
<a href="#l4.16"></a><span id="l4.16"> // Open librnp. Determine the path to the chrome directory and look for it</span>
<a href="#l4.17"></a><span id="l4.17"> // there first. If not, fallback to searching the standard locations.</span>
<a href="#l4.18"></a><span id="l4.18"> var librnp, librnpPath;</span>
<a href="#l4.19"></a><span id="l4.19"> </span>
<a href="#l4.20"></a><span id="l4.20"> function tryLoadRNP(name, suffix) {</span>
<a href="#l4.21"></a><span id="l4.21">   let filename = ctypes.libraryName(name) + suffix;</span>
<a href="#l4.22"></a><span id="l4.22">   let binPath = Services.dirsvc.get(&quot;XpcomLib&quot;, Ci.nsIFile).path;</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineat">@@ -205,27 +208,34 @@ function enableRNPLibJS() {</span>
<a href="#l4.24"></a><span id="l4.24">     },</span>
<a href="#l4.25"></a><span id="l4.25"> </span>
<a href="#l4.26"></a><span id="l4.26">     keep_password_cb_alive: null,</span>
<a href="#l4.27"></a><span id="l4.27"> </span>
<a href="#l4.28"></a><span id="l4.28">     password_cb(ffi, app_ctx, key, pgp_context, buf, buf_len) {</span>
<a href="#l4.29"></a><span id="l4.29">       console.log(</span>
<a href="#l4.30"></a><span id="l4.30">         &quot;in RNPLib.password_cb, context: &quot; + pgp_context.readString()</span>
<a href="#l4.31"></a><span id="l4.31">       );</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineminus">-      //console.log(&quot;max_len: &quot; + buf_len);</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineminus">-      //console.log(buf);</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineplus">+      console.log(&quot;max_len: &quot; + buf_len);</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineplus">+      </span>
<a href="#l4.36"></a><span id="l4.36" class="difflineplus">+      let pass = OpenPGPMasterpass.retrieveOpenPGPPassword();</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineplus">+      var passCTypes = ctypes.char.array()(pass); // UTF-8</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineplus">+      let passLen = passCTypes.length;</span>
<a href="#l4.39"></a><span id="l4.39"> </span>
<a href="#l4.40"></a><span id="l4.40" class="difflineminus">-      /*</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineplus">+      if (buf_len &lt; passLen) {</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineplus">+        return false;</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineplus">+      }</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineplus">+</span>
<a href="#l4.45"></a><span id="l4.45">       let char_array = ctypes.cast(buf, ctypes.char.array(buf_len).ptr)</span>
<a href="#l4.46"></a><span id="l4.46">         .contents;</span>
<a href="#l4.47"></a><span id="l4.47" class="difflineminus">-      */</span>
<a href="#l4.48"></a><span id="l4.48" class="difflineminus">-      //char_array[0] = 0;</span>
<a href="#l4.49"></a><span id="l4.49" class="difflineminus">-      //console.log(char_array.readString());</span>
<a href="#l4.50"></a><span id="l4.50"> </span>
<a href="#l4.51"></a><span id="l4.51" class="difflineminus">-      //buf[0] = 0;</span>
<a href="#l4.52"></a><span id="l4.52" class="difflineplus">+      let i;</span>
<a href="#l4.53"></a><span id="l4.53" class="difflineplus">+      for (i = 0; i &lt; passLen; ++i) {</span>
<a href="#l4.54"></a><span id="l4.54" class="difflineplus">+        char_array[i] = passCTypes[i];</span>
<a href="#l4.55"></a><span id="l4.55" class="difflineplus">+      }</span>
<a href="#l4.56"></a><span id="l4.56" class="difflineplus">+      char_array[passLen] = 0;</span>
<a href="#l4.57"></a><span id="l4.57">       return true;</span>
<a href="#l4.58"></a><span id="l4.58">     },</span>
<a href="#l4.59"></a><span id="l4.59"> </span>
<a href="#l4.60"></a><span id="l4.60">     // Get a RNP library handle.</span>
<a href="#l4.61"></a><span id="l4.61">     rnp_ffi_create: librnp.declare(</span>
<a href="#l4.62"></a><span id="l4.62">       &quot;rnp_ffi_create&quot;,</span>
<a href="#l4.63"></a><span id="l4.63">       abi,</span>
<a href="#l4.64"></a><span id="l4.64">       rnp_result_t,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mail/extensions/openpgp/content/ui/enigmailCommon.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/ui/enigmailCommon.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -42,16 +42,17 @@ var EnigmailConstants = ChromeUtils.impo</span>
<a href="#l5.4"></a><span id="l5.4"> var EnigmailErrorHandling = ChromeUtils.import(&quot;chrome://openpgp/content/modules/errorHandling.jsm&quot;).EnigmailErrorHandling;</span>
<a href="#l5.5"></a><span id="l5.5"> var EnigmailKeyServer = ChromeUtils.import(&quot;chrome://openpgp/content/modules/keyserver.jsm&quot;).EnigmailKeyServer;</span>
<a href="#l5.6"></a><span id="l5.6"> var EnigmailEvents = ChromeUtils.import(&quot;chrome://openpgp/content/modules/events.jsm&quot;).EnigmailEvents;</span>
<a href="#l5.7"></a><span id="l5.7"> var EnigmailGpg = ChromeUtils.import(&quot;chrome://openpgp/content/modules/gpg.jsm&quot;).EnigmailGpg;</span>
<a href="#l5.8"></a><span id="l5.8"> var EnigmailGpgAgent = ChromeUtils.import(&quot;chrome://openpgp/content/modules/gpgAgent.jsm&quot;).EnigmailGpgAgent;</span>
<a href="#l5.9"></a><span id="l5.9"> var EnigmailStreams = ChromeUtils.import(&quot;chrome://openpgp/content/modules/streams.jsm&quot;).EnigmailStreams;</span>
<a href="#l5.10"></a><span id="l5.10"> var EnigmailCryptoAPI = ChromeUtils.import(&quot;chrome://openpgp/content/modules/cryptoAPI.jsm&quot;).EnigmailCryptoAPI;</span>
<a href="#l5.11"></a><span id="l5.11"> </span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+var OpenPGPMasterpass = ChromeUtils.import(&quot;chrome://openpgp/content/modules/masterpass.jsm&quot;).OpenPGPMasterpass;</span>
<a href="#l5.13"></a><span id="l5.13"> var RNP = ChromeUtils.import(&quot;chrome://openpgp/content/modules/rnp.jsm&quot;).RNP;</span>
<a href="#l5.14"></a><span id="l5.14"> </span>
<a href="#l5.15"></a><span id="l5.15"> </span>
<a href="#l5.16"></a><span id="l5.16"> // The compatible Enigmime version</span>
<a href="#l5.17"></a><span id="l5.17"> var gEnigmailSvc;</span>
<a href="#l5.18"></a><span id="l5.18"> var gEnigPromptSvc;</span>
<a href="#l5.19"></a><span id="l5.19"> </span>
<a href="#l5.20"></a><span id="l5.20"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mail/extensions/openpgp/content/ui/enigmailKeygen.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/ui/enigmailKeygen.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -41,47 +41,33 @@ const KEYGEN_CANCELLED = &quot;cancelled&quot;;</span>
<a href="#l6.4"></a><span id="l6.4"> </span>
<a href="#l6.5"></a><span id="l6.5"> function enigmailKeygenLoad() {</span>
<a href="#l6.6"></a><span id="l6.6">   EnigmailLog.DEBUG(&quot;enigmailKeygen.js: Load\n&quot;);</span>
<a href="#l6.7"></a><span id="l6.7"> </span>
<a href="#l6.8"></a><span id="l6.8">   gUserIdentityList = document.getElementById(&quot;userIdentity&quot;);</span>
<a href="#l6.9"></a><span id="l6.9">   gUserIdentityListPopup = document.getElementById(&quot;userIdentityPopup&quot;);</span>
<a href="#l6.10"></a><span id="l6.10">   gUseForSigning = document.getElementById(&quot;useForSigning&quot;);</span>
<a href="#l6.11"></a><span id="l6.11"> </span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-  var noPassphrase = document.getElementById(&quot;noPassphrase&quot;);</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineminus">-  /*</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineminus">-  if (!EnigmailGpg.getGpgFeature(&quot;keygen-passphrase&quot;)) {</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineminus">-    document.getElementById(&quot;passphraseRow&quot;).setAttribute(&quot;collapsed&quot;, &quot;true&quot;);</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineminus">-    noPassphrase.setAttribute(&quot;collapsed&quot;, &quot;true&quot;);</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineminus">-  }</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineminus">-  */</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineminus">-</span>
<a href="#l6.21"></a><span id="l6.21">   //if (EnigmailGpg.getGpgFeature(&quot;supports-ecc-keys&quot;))</span>
<a href="#l6.22"></a><span id="l6.22">   let eccElem = document.getElementById(&quot;keyType_ecc&quot;);</span>
<a href="#l6.23"></a><span id="l6.23">   eccElem.removeAttribute(&quot;hidden&quot;);</span>
<a href="#l6.24"></a><span id="l6.24">   updateKeySizeSel(eccElem);</span>
<a href="#l6.25"></a><span id="l6.25">   document.getElementById(&quot;keyType&quot;).selectedItem = eccElem;</span>
<a href="#l6.26"></a><span id="l6.26"> </span>
<a href="#l6.27"></a><span id="l6.27">   if (gUserIdentityListPopup) {</span>
<a href="#l6.28"></a><span id="l6.28">     fillIdentityListPopup();</span>
<a href="#l6.29"></a><span id="l6.29">   }</span>
<a href="#l6.30"></a><span id="l6.30">   gUserIdentityList.focus();</span>
<a href="#l6.31"></a><span id="l6.31"> </span>
<a href="#l6.32"></a><span id="l6.32">   // restore safe setting, which you ALWAYS explicitly have to overrule,</span>
<a href="#l6.33"></a><span id="l6.33">   // if you don't want them:</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineminus">-  // - specify passphrase</span>
<a href="#l6.35"></a><span id="l6.35">   // - specify expiry date</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineminus">-  noPassphrase.checked = false;</span>
<a href="#l6.37"></a><span id="l6.37" class="difflineminus">-  EnigSetPref(&quot;noPassphrase&quot;, noPassphrase.checked);</span>
<a href="#l6.38"></a><span id="l6.38">   var noExpiry = document.getElementById(&quot;noExpiry&quot;);</span>
<a href="#l6.39"></a><span id="l6.39">   noExpiry.checked = false;</span>
<a href="#l6.40"></a><span id="l6.40"> </span>
<a href="#l6.41"></a><span id="l6.41" class="difflineminus">-  enigmailKeygenUpdate(true, false);</span>
<a href="#l6.42"></a><span id="l6.42" class="difflineminus">-</span>
<a href="#l6.43"></a><span id="l6.43">   var enigmailSvc = GetEnigmailSvc();</span>
<a href="#l6.44"></a><span id="l6.44">   if (!enigmailSvc) {</span>
<a href="#l6.45"></a><span id="l6.45">     EnigAlert(EnigGetString(&quot;accessError&quot;));</span>
<a href="#l6.46"></a><span id="l6.46">   }</span>
<a href="#l6.47"></a><span id="l6.47"> </span>
<a href="#l6.48"></a><span id="l6.48">   if (EnigmailGpgAgent.agentType != &quot;gpg&quot;) {</span>
<a href="#l6.49"></a><span id="l6.49">     EnigAlert(EnigGetString(&quot;onlyGPG&quot;));</span>
<a href="#l6.50"></a><span id="l6.50">     return;</span>
<a href="#l6.51"></a><span id="l6.51" class="difflineat">@@ -106,35 +92,16 @@ function enigmailOnClose() {</span>
<a href="#l6.52"></a><span id="l6.52"> }</span>
<a href="#l6.53"></a><span id="l6.53"> </span>
<a href="#l6.54"></a><span id="l6.54"> function enigmailKeygenUnload() {</span>
<a href="#l6.55"></a><span id="l6.55">   EnigmailLog.DEBUG(&quot;enigmailKeygen.js: Unload\n&quot;);</span>
<a href="#l6.56"></a><span id="l6.56"> </span>
<a href="#l6.57"></a><span id="l6.57">   enigmailKeygenCloseRequest();</span>
<a href="#l6.58"></a><span id="l6.58"> }</span>
<a href="#l6.59"></a><span id="l6.59"> </span>
<a href="#l6.60"></a><span id="l6.60" class="difflineminus">-</span>
<a href="#l6.61"></a><span id="l6.61" class="difflineminus">-function enigmailKeygenUpdate(getPrefs, setPrefs) {</span>
<a href="#l6.62"></a><span id="l6.62" class="difflineminus">-  EnigmailLog.DEBUG(&quot;enigmailKeygen.js: Update: &quot; + getPrefs + &quot;, &quot; + setPrefs + &quot;\n&quot;);</span>
<a href="#l6.63"></a><span id="l6.63" class="difflineminus">-</span>
<a href="#l6.64"></a><span id="l6.64" class="difflineminus">-  var noPassphrase = document.getElementById(&quot;noPassphrase&quot;);</span>
<a href="#l6.65"></a><span id="l6.65" class="difflineminus">-  var noPassphraseChecked = getPrefs ? EnigGetPref(&quot;noPassphrase&quot;) : noPassphrase.checked;</span>
<a href="#l6.66"></a><span id="l6.66" class="difflineminus">-</span>
<a href="#l6.67"></a><span id="l6.67" class="difflineminus">-  if (setPrefs) {</span>
<a href="#l6.68"></a><span id="l6.68" class="difflineminus">-    EnigSetPref(&quot;noPassphrase&quot;, noPassphraseChecked);</span>
<a href="#l6.69"></a><span id="l6.69" class="difflineminus">-  }</span>
<a href="#l6.70"></a><span id="l6.70" class="difflineminus">-</span>
<a href="#l6.71"></a><span id="l6.71" class="difflineminus">-  noPassphrase.checked = noPassphraseChecked;</span>
<a href="#l6.72"></a><span id="l6.72" class="difflineminus">-</span>
<a href="#l6.73"></a><span id="l6.73" class="difflineminus">-  var passphrase1 = document.getElementById(&quot;passphrase&quot;);</span>
<a href="#l6.74"></a><span id="l6.74" class="difflineminus">-  var passphrase2 = document.getElementById(&quot;passphraseRepeat&quot;);</span>
<a href="#l6.75"></a><span id="l6.75" class="difflineminus">-  passphrase1.disabled = noPassphraseChecked;</span>
<a href="#l6.76"></a><span id="l6.76" class="difflineminus">-  passphrase2.disabled = noPassphraseChecked;</span>
<a href="#l6.77"></a><span id="l6.77" class="difflineminus">-}</span>
<a href="#l6.78"></a><span id="l6.78" class="difflineminus">-</span>
<a href="#l6.79"></a><span id="l6.79"> function enigmailKeygenTerminate(exitCode) {</span>
<a href="#l6.80"></a><span id="l6.80">   EnigmailLog.DEBUG(&quot;enigmailKeygen.js: Terminate:\n&quot;);</span>
<a href="#l6.81"></a><span id="l6.81"> </span>
<a href="#l6.82"></a><span id="l6.82">   var curId = gUsedId;</span>
<a href="#l6.83"></a><span id="l6.83"> </span>
<a href="#l6.84"></a><span id="l6.84">   gKeygenRequest = null;</span>
<a href="#l6.85"></a><span id="l6.85"> </span>
<a href="#l6.86"></a><span id="l6.86">   if ((!gGeneratedKey) || gGeneratedKey == KEYGEN_CANCELLED) {</span>
<a href="#l6.87"></a><span id="l6.87" class="difflineat">@@ -147,18 +114,16 @@ function enigmailKeygenTerminate(exitCod</span>
<a href="#l6.88"></a><span id="l6.88">   progMeter.setAttribute(&quot;value&quot;, 100);</span>
<a href="#l6.89"></a><span id="l6.89"> </span>
<a href="#l6.90"></a><span id="l6.90">   if (gGeneratedKey) {</span>
<a href="#l6.91"></a><span id="l6.91">     if (gUseForSigning.checked) {</span>
<a href="#l6.92"></a><span id="l6.92">       curId.setBoolAttribute(&quot;enablePgp&quot;, true);</span>
<a href="#l6.93"></a><span id="l6.93">       curId.setIntAttribute(&quot;pgpKeyMode&quot;, 1);</span>
<a href="#l6.94"></a><span id="l6.94">       curId.setCharAttribute(&quot;pgpkeyId&quot;, &quot;0x&quot; + gGeneratedKey);</span>
<a href="#l6.95"></a><span id="l6.95"> </span>
<a href="#l6.96"></a><span id="l6.96" class="difflineminus">-      enigmailKeygenUpdate(false, true);</span>
<a href="#l6.97"></a><span id="l6.97" class="difflineminus">-</span>
<a href="#l6.98"></a><span id="l6.98">       EnigSavePrefs();</span>
<a href="#l6.99"></a><span id="l6.99"> </span>
<a href="#l6.100"></a><span id="l6.100">       EnigmailWindows.keyManReloadKeys();</span>
<a href="#l6.101"></a><span id="l6.101"> </span>
<a href="#l6.102"></a><span id="l6.102">       if (EnigConfirm(EnigGetString(&quot;keygenComplete&quot;, curId.email) + &quot;\n\n&quot; + EnigGetString(&quot;revokeCertRecommended&quot;), EnigGetString(&quot;keyMan.button.generateCert&quot;))) {</span>
<a href="#l6.103"></a><span id="l6.103">         EnigCreateRevokeCert(gGeneratedKey, curId.email, closeAndReset);</span>
<a href="#l6.104"></a><span id="l6.104">       } else {</span>
<a href="#l6.105"></a><span id="l6.105">         closeAndReset();</span>
<a href="#l6.106"></a><span id="l6.106" class="difflineat">@@ -247,43 +212,16 @@ function enigmailKeygenCloseRequest() {</span>
<a href="#l6.107"></a><span id="l6.107"> </span>
<a href="#l6.108"></a><span id="l6.108">   if (gKeygenRequest) {</span>
<a href="#l6.109"></a><span id="l6.109">     var p = gKeygenRequest;</span>
<a href="#l6.110"></a><span id="l6.110">     gKeygenRequest = null;</span>
<a href="#l6.111"></a><span id="l6.111">     p.kill(false);</span>
<a href="#l6.112"></a><span id="l6.112">   }</span>
<a href="#l6.113"></a><span id="l6.113"> }</span>
<a href="#l6.114"></a><span id="l6.114"> </span>
<a href="#l6.115"></a><span id="l6.115" class="difflineminus">-function enigmailCheckPassphrase() {</span>
<a href="#l6.116"></a><span id="l6.116" class="difflineminus">-  var passphraseElement = document.getElementById(&quot;passphrase&quot;);</span>
<a href="#l6.117"></a><span id="l6.117" class="difflineminus">-  var passphrase2Element = document.getElementById(&quot;passphraseRepeat&quot;);</span>
<a href="#l6.118"></a><span id="l6.118" class="difflineminus">-</span>
<a href="#l6.119"></a><span id="l6.119" class="difflineminus">-  var passphrase = passphraseElement.value;</span>
<a href="#l6.120"></a><span id="l6.120" class="difflineminus">-</span>
<a href="#l6.121"></a><span id="l6.121" class="difflineminus">-  if (passphrase != passphrase2Element.value) {</span>
<a href="#l6.122"></a><span id="l6.122" class="difflineminus">-    EnigAlert(EnigGetString(&quot;passNoMatch&quot;));</span>
<a href="#l6.123"></a><span id="l6.123" class="difflineminus">-    return null;</span>
<a href="#l6.124"></a><span id="l6.124" class="difflineminus">-  }</span>
<a href="#l6.125"></a><span id="l6.125" class="difflineminus">-</span>
<a href="#l6.126"></a><span id="l6.126" class="difflineminus">-  if (passphrase.search(/[^\x20-\x7E]/) &gt;= 0) {</span>
<a href="#l6.127"></a><span id="l6.127" class="difflineminus">-    if (!EnigmailDialog.confirmDlg(window, EnigmailLocale.getString(&quot;keygen.passCharProblem&quot;),</span>
<a href="#l6.128"></a><span id="l6.128" class="difflineminus">-        EnigmailLocale.getString(&quot;dlg.button.ignore&quot;), EnigmailLocale.getString(&quot;dlg.button.cancel&quot;))) {</span>
<a href="#l6.129"></a><span id="l6.129" class="difflineminus">-      return null;</span>
<a href="#l6.130"></a><span id="l6.130" class="difflineminus">-    }</span>
<a href="#l6.131"></a><span id="l6.131" class="difflineminus">-  }</span>
<a href="#l6.132"></a><span id="l6.132" class="difflineminus">-  if ((passphrase.search(/^\s/) === 0) || (passphrase.search(/\s$/) &gt;= 0)) {</span>
<a href="#l6.133"></a><span id="l6.133" class="difflineminus">-    EnigAlert(EnigGetString(&quot;passSpaceProblem&quot;));</span>
<a href="#l6.134"></a><span id="l6.134" class="difflineminus">-    return null;</span>
<a href="#l6.135"></a><span id="l6.135" class="difflineminus">-  }</span>
<a href="#l6.136"></a><span id="l6.136" class="difflineminus">-</span>
<a href="#l6.137"></a><span id="l6.137" class="difflineminus">-  return passphrase;</span>
<a href="#l6.138"></a><span id="l6.138" class="difflineminus">-}</span>
<a href="#l6.139"></a><span id="l6.139" class="difflineminus">-</span>
<a href="#l6.140"></a><span id="l6.140" class="difflineminus">-</span>
<a href="#l6.141"></a><span id="l6.141" class="difflineminus">-</span>
<a href="#l6.142"></a><span id="l6.142"> function enigmailKeygenStart() {</span>
<a href="#l6.143"></a><span id="l6.143">   EnigmailLog.DEBUG(&quot;enigmailKeygen.js: Start\n&quot;);</span>
<a href="#l6.144"></a><span id="l6.144"> </span>
<a href="#l6.145"></a><span id="l6.145">   if (gKeygenRequest) {</span>
<a href="#l6.146"></a><span id="l6.146">     let req = gKeygenRequest.QueryInterface(Components.interfaces.nsIRequest);</span>
<a href="#l6.147"></a><span id="l6.147">     if (req.isPending()) {</span>
<a href="#l6.148"></a><span id="l6.148">       EnigmailDialog.info(window, EnigGetString(&quot;genGoing&quot;));</span>
<a href="#l6.149"></a><span id="l6.149">       return;</span>
<a href="#l6.150"></a><span id="l6.150" class="difflineat">@@ -294,33 +232,16 @@ function enigmailKeygenStart() {</span>
<a href="#l6.151"></a><span id="l6.151">   gAllData = &quot;&quot;;</span>
<a href="#l6.152"></a><span id="l6.152"> </span>
<a href="#l6.153"></a><span id="l6.153">   var enigmailSvc = GetEnigmailSvc();</span>
<a href="#l6.154"></a><span id="l6.154">   if (!enigmailSvc) {</span>
<a href="#l6.155"></a><span id="l6.155">     EnigAlert(EnigGetString(&quot;accessError&quot;));</span>
<a href="#l6.156"></a><span id="l6.156">     return;</span>
<a href="#l6.157"></a><span id="l6.157">   }</span>
<a href="#l6.158"></a><span id="l6.158"> </span>
<a href="#l6.159"></a><span id="l6.159" class="difflineminus">-  var passphrase = &quot;&quot;;</span>
<a href="#l6.160"></a><span id="l6.160" class="difflineminus">-  // gpg &gt;= 2.1 queries passphrase using gpg-agent only</span>
<a href="#l6.161"></a><span id="l6.161" class="difflineminus">-  //if (EnigmailGpg.getGpgFeature(&quot;keygen-passphrase&quot;))</span>
<a href="#l6.162"></a><span id="l6.162" class="difflineminus">-</span>
<a href="#l6.163"></a><span id="l6.163" class="difflineminus">-  var noPassphraseElement = document.getElementById(&quot;noPassphrase&quot;);</span>
<a href="#l6.164"></a><span id="l6.164" class="difflineminus">-  var passphraseElement = document.getElementById(&quot;passphrase&quot;);</span>
<a href="#l6.165"></a><span id="l6.165" class="difflineminus">-</span>
<a href="#l6.166"></a><span id="l6.166" class="difflineminus">-  if (!noPassphraseElement.checked) {</span>
<a href="#l6.167"></a><span id="l6.167" class="difflineminus">-    if (passphraseElement.value.trim() === &quot;&quot;) {</span>
<a href="#l6.168"></a><span id="l6.168" class="difflineminus">-      EnigmailDialog.info(window, EnigGetString(&quot;passCheckBox&quot;));</span>
<a href="#l6.169"></a><span id="l6.169" class="difflineminus">-      return;</span>
<a href="#l6.170"></a><span id="l6.170" class="difflineminus">-    }</span>
<a href="#l6.171"></a><span id="l6.171" class="difflineminus">-</span>
<a href="#l6.172"></a><span id="l6.172" class="difflineminus">-    passphrase = enigmailCheckPassphrase();</span>
<a href="#l6.173"></a><span id="l6.173" class="difflineminus">-    if (passphrase === null) return;</span>
<a href="#l6.174"></a><span id="l6.174" class="difflineminus">-  }</span>
<a href="#l6.175"></a><span id="l6.175" class="difflineminus">-</span>
<a href="#l6.176"></a><span id="l6.176">   var noExpiry = document.getElementById(&quot;noExpiry&quot;);</span>
<a href="#l6.177"></a><span id="l6.177">   var expireInput = document.getElementById(&quot;expireInput&quot;);</span>
<a href="#l6.178"></a><span id="l6.178">   var timeScale = document.getElementById(&quot;timeScale&quot;);</span>
<a href="#l6.179"></a><span id="l6.179"> </span>
<a href="#l6.180"></a><span id="l6.180">   var expiryTime = 0;</span>
<a href="#l6.181"></a><span id="l6.181">   if (!noExpiry.checked) {</span>
<a href="#l6.182"></a><span id="l6.182">     expiryTime = Number(expireInput.value) * Number(timeScale.value);</span>
<a href="#l6.183"></a><span id="l6.183">     if (expiryTime &gt; 36500) {</span>
<a href="#l6.184"></a><span id="l6.184" class="difflineat">@@ -353,17 +274,18 @@ function enigmailKeygenStart() {</span>
<a href="#l6.185"></a><span id="l6.185">   var confirmMsg = EnigGetString(&quot;keyConfirm&quot;, idString);</span>
<a href="#l6.186"></a><span id="l6.186"> </span>
<a href="#l6.187"></a><span id="l6.187">   if (!EnigConfirm(confirmMsg, EnigGetString(&quot;keyMan.button.generateKey&quot;))) {</span>
<a href="#l6.188"></a><span id="l6.188">     return;</span>
<a href="#l6.189"></a><span id="l6.189">   }</span>
<a href="#l6.190"></a><span id="l6.190"> </span>
<a href="#l6.191"></a><span id="l6.191">   try {</span>
<a href="#l6.192"></a><span id="l6.192">     const cApi = EnigmailCryptoAPI();</span>
<a href="#l6.193"></a><span id="l6.193" class="difflineminus">-    let newId = cApi.sync(cApi.genKey(idString, keyType, keySize, expiryTime, passphrase));</span>
<a href="#l6.194"></a><span id="l6.194" class="difflineplus">+    let newId = cApi.sync(cApi.genKey(idString, keyType, keySize, expiryTime,</span>
<a href="#l6.195"></a><span id="l6.195" class="difflineplus">+                                      OpenPGPMasterpass.retrieveOpenPGPPassword()));</span>
<a href="#l6.196"></a><span id="l6.196">     console.log(&quot;created new key with id: &quot; + newId);</span>
<a href="#l6.197"></a><span id="l6.197">   } catch(ex) {</span>
<a href="#l6.198"></a><span id="l6.198">     console.log(ex);</span>
<a href="#l6.199"></a><span id="l6.199">   } </span>
<a href="#l6.200"></a><span id="l6.200"> </span>
<a href="#l6.201"></a><span id="l6.201">   EnigmailWindows.keyManReloadKeys();</span>
<a href="#l6.202"></a><span id="l6.202">   closeAndReset();</span>
<a href="#l6.203"></a><span id="l6.203"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mail/extensions/openpgp/content/ui/enigmailKeygen.xul</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/ui/enigmailKeygen.xul</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -38,39 +38,16 @@</span>
<a href="#l7.4"></a><span id="l7.4">     &lt;/menulist&gt;</span>
<a href="#l7.5"></a><span id="l7.5">   &lt;/hbox&gt;</span>
<a href="#l7.6"></a><span id="l7.6"> </span>
<a href="#l7.7"></a><span id="l7.7">   &lt;checkbox id=&quot;useForSigning&quot;</span>
<a href="#l7.8"></a><span id="l7.8">             label=&quot;&amp;enigmail.useForSigning.label;&quot;</span>
<a href="#l7.9"></a><span id="l7.9">             checked=&quot;true&quot; /&gt;</span>
<a href="#l7.10"></a><span id="l7.10"> &lt;/vbox&gt;</span>
<a href="#l7.11"></a><span id="l7.11"> </span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-&lt;checkbox id=&quot;noPassphrase&quot;</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">-          label=&quot;&amp;enigmail.keyNoPassphrase.label;&quot;</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineminus">-          oncommand=&quot;enigmailKeygenUpdate(false, false);&quot; /&gt;</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineminus">-</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineminus">-&lt;grid&gt;</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineminus">-  &lt;columns&gt;</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineminus">-    &lt;column /&gt;</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineminus">-    &lt;column flex=&quot;1&quot;/&gt;</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineminus">-  &lt;/columns&gt;</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineminus">-</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineminus">-  &lt;rows&gt;</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineminus">-    &lt;row id=&quot;passphraseRow&quot;&gt;</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineminus">-      &lt;hbox id=&quot;passphraseBox&quot; align=&quot;center&quot;&gt;</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineminus">-        &lt;label control=&quot;passphrase&quot; value=&quot;&amp;enigmail.keyPassphrase.label;&quot; /&gt;</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineminus">-      &lt;/hbox&gt;</span>
<a href="#l7.27"></a><span id="l7.27" class="difflineminus">-      &lt;hbox align=&quot;center&quot;&gt;</span>
<a href="#l7.28"></a><span id="l7.28" class="difflineminus">-        &lt;html:input id=&quot;passphrase&quot; type=&quot;password&quot; /&gt;</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineminus">-        &lt;label control=&quot;passphraseRepeat&quot; value=&quot;&amp;enigmail.keyPassphraseRepeat.label;&quot; /&gt;</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineminus">-        &lt;html:input id=&quot;passphraseRepeat&quot; type=&quot;password&quot; /&gt;</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineminus">-      &lt;/hbox&gt;</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineminus">-    &lt;/row&gt;</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineminus">-  &lt;/rows&gt;</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineminus">-&lt;/grid&gt;</span>
<a href="#l7.35"></a><span id="l7.35"> </span>
<a href="#l7.36"></a><span id="l7.36"> &lt;tabbox flex=&quot;1&quot;&gt;</span>
<a href="#l7.37"></a><span id="l7.37">   &lt;tabs id=&quot;settingsTabBox&quot;&gt;</span>
<a href="#l7.38"></a><span id="l7.38">     &lt;tab id=&quot;basicTab&quot;    label=&quot;&amp;enigmail.keyGen.expiry.title;&quot;/&gt;</span>
<a href="#l7.39"></a><span id="l7.39">     &lt;tab id=&quot;advancedTab&quot; label=&quot;&amp;enigmail.advancedPrefsButton.label;&quot;/&gt;</span>
<a href="#l7.40"></a><span id="l7.40">   &lt;/tabs&gt;</span>
<a href="#l7.41"></a><span id="l7.41"> </span>
<a href="#l7.42"></a><span id="l7.42">   &lt;tabpanels flex=&quot;1&quot;&gt;</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:31Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

