<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 18587:c460d51c3548885903f40c61ecdd5cd737134766</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ c460d51c3548885903f40c61ecdd5cd737134766" />
<meta property="og:url" content="/comm-central/rev/c460d51c3548885903f40c61ecdd5cd737134766" />
<meta property="og:description" content="Fix bug 1213823 - Activity Manager entries show batch maximum instead of total item count. r=redDragon,a=philipp" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / c460d51c3548885903f40c61ecdd5cd737134766 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/c460d51c3548885903f40c61ecdd5cd737134766">shortlog</a> |
<a href="/comm-central/log/c460d51c3548885903f40c61ecdd5cd737134766">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/c460d51c3548885903f40c61ecdd5cd737134766">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/c460d51c3548885903f40c61ecdd5cd737134766">files</a> |
changeset |
<a href="/comm-central/raw-rev/c460d51c3548885903f40c61ecdd5cd737134766">raw</a>  | <a href="/comm-central/archive/c460d51c3548885903f40c61ecdd5cd737134766.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
Fix <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1213823">bug 1213823</a> - Activity Manager entries show batch maximum instead of total item count. r=redDragon,a=philipp
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#80;&#104;&#105;&#108;&#105;&#112;&#112;&#32;&#75;&#101;&#119;&#105;&#115;&#99;&#104;&#32;&#60;&#109;&#111;&#122;&#105;&#108;&#108;&#97;&#64;&#107;&#101;&#119;&#105;&#115;&#46;&#99;&#104;&#62;</td></tr>
<tr><td></td><td class="date age">Thu, 12 Nov 2015 23:44:10 +0100</td></tr>

<tr>
 <td>changeset 18587</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/c460d51c3548885903f40c61ecdd5cd737134766">c460d51c3548885903f40c61ecdd5cd737134766</a></td>
</tr>



<tr>
<td>parent 18586</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/27df23ea2d73c729570ca2dbf24068b81a060a1f">27df23ea2d73c729570ca2dbf24068b81a060a1f</a>
</td>
</tr>

<tr>
<td>child 18588</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/28a2cb4d3c0760fc198466f7d4dbee71a87af796">28a2cb4d3c0760fc198466f7d4dbee71a87af796</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=c460d51c3548885903f40c61ecdd5cd737134766">11378</a></td></tr>
<tr><td>push user</td><td>mozilla@kewis.ch</td></tr>
<tr><td>push date</td><td class="date age">Thu, 12 Nov 2015 22:45:38 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@c460d51c3548 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=c460d51c3548885903f40c61ecdd5cd737134766">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=c460d51c3548885903f40c61ecdd5cd737134766&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=c460d51c3548885903f40c61ecdd5cd737134766&newProject=comm-central&newRevision=b5f568bee812a06a0e86f107196b6d82cee97862&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=c460d51c3548885903f40c61ecdd5cd737134766&newProject=comm-central&newRevision=b5f568bee812a06a0e86f107196b6d82cee97862&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=c460d51c3548885903f40c61ecdd5cd737134766&newProject=comm-central&newRevision=b5f568bee812a06a0e86f107196b6d82cee97862&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28redDragon%29&revcount=50">redDragon</a>, <a href="/comm-central/log?rev=reviewer%28philipp%29&revcount=50">philipp</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1213823">1213823</a></td></tr>




</table></div>

<div class="page_body description">Fix <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1213823">bug 1213823</a> - Activity Manager entries show batch maximum instead of total item count. r=redDragon,a=philipp</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c460d51c3548885903f40c61ecdd5cd737134766/calendar/providers/gdata/components/calGoogleCalendar.js">calendar/providers/gdata/components/calGoogleCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c460d51c3548885903f40c61ecdd5cd737134766/calendar/providers/gdata/components/calGoogleCalendar.js">file</a> |
<a href="/comm-central/annotate/c460d51c3548885903f40c61ecdd5cd737134766/calendar/providers/gdata/components/calGoogleCalendar.js">annotate</a> |
<a href="/comm-central/diff/c460d51c3548885903f40c61ecdd5cd737134766/calendar/providers/gdata/components/calGoogleCalendar.js">diff</a> |
<a href="/comm-central/comparison/c460d51c3548885903f40c61ecdd5cd737134766/calendar/providers/gdata/components/calGoogleCalendar.js">comparison</a> |
<a href="/comm-central/log/c460d51c3548885903f40c61ecdd5cd737134766/calendar/providers/gdata/components/calGoogleCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c460d51c3548885903f40c61ecdd5cd737134766/calendar/providers/gdata/modules/gdataUtils.jsm">calendar/providers/gdata/modules/gdataUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c460d51c3548885903f40c61ecdd5cd737134766/calendar/providers/gdata/modules/gdataUtils.jsm">file</a> |
<a href="/comm-central/annotate/c460d51c3548885903f40c61ecdd5cd737134766/calendar/providers/gdata/modules/gdataUtils.jsm">annotate</a> |
<a href="/comm-central/diff/c460d51c3548885903f40c61ecdd5cd737134766/calendar/providers/gdata/modules/gdataUtils.jsm">diff</a> |
<a href="/comm-central/comparison/c460d51c3548885903f40c61ecdd5cd737134766/calendar/providers/gdata/modules/gdataUtils.jsm">comparison</a> |
<a href="/comm-central/log/c460d51c3548885903f40c61ecdd5cd737134766/calendar/providers/gdata/modules/gdataUtils.jsm">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/calendar/providers/gdata/components/calGoogleCalendar.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/calendar/providers/gdata/components/calGoogleCalendar.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -732,17 +732,17 @@ calGoogleCalendar.prototype = {</span>
<a href="#l1.4"></a><span id="l1.4">         }</span>
<a href="#l1.5"></a><span id="l1.5">         if (eventsRequest.uri &amp;&amp; this.checkThrottle(&quot;events&quot;)) {</span>
<a href="#l1.6"></a><span id="l1.6">             let saver = new ItemSaver(this);</span>
<a href="#l1.7"></a><span id="l1.7">             eventsPromise = this.session.asyncPaginatedRequest(eventsRequest, null, function(aData) {</span>
<a href="#l1.8"></a><span id="l1.8">                 // On each request...</span>
<a href="#l1.9"></a><span id="l1.9">                 return saver.parseItemStream(aData);</span>
<a href="#l1.10"></a><span id="l1.10">             }.bind(this), function(aData) {</span>
<a href="#l1.11"></a><span id="l1.11">                 // On last request...</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-                return saver.processRemainingExceptions().then(function() {</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+                return saver.complete().then(function() {</span>
<a href="#l1.14"></a><span id="l1.14">                     if (aData.nextSyncToken) {</span>
<a href="#l1.15"></a><span id="l1.15">                         cal.LOG(&quot;[calGoogleCalendar] New sync token for &quot; +</span>
<a href="#l1.16"></a><span id="l1.16">                                 this.name + &quot;(events) is now: &quot; + aData.nextSyncToken);</span>
<a href="#l1.17"></a><span id="l1.17">                         this.setProperty(&quot;syncToken.events&quot;, aData.nextSyncToken);</span>
<a href="#l1.18"></a><span id="l1.18">                     }</span>
<a href="#l1.19"></a><span id="l1.19">                 }.bind(this));</span>
<a href="#l1.20"></a><span id="l1.20">             }.bind(this));</span>
<a href="#l1.21"></a><span id="l1.21">         }</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineat">@@ -756,25 +756,30 @@ calGoogleCalendar.prototype = {</span>
<a href="#l1.23"></a><span id="l1.23">         tasksRequest.addQueryParameter(&quot;maxResults&quot;, maxResults);</span>
<a href="#l1.24"></a><span id="l1.24">         let lastUpdated = this.getUpdatedMin(&quot;tasks&quot;);</span>
<a href="#l1.25"></a><span id="l1.25">         if (lastUpdated) {</span>
<a href="#l1.26"></a><span id="l1.26">             tasksRequest.addQueryParameter(&quot;updatedMin&quot;, cal.toRFC3339(lastUpdated));</span>
<a href="#l1.27"></a><span id="l1.27">             tasksRequest.addQueryParameter(&quot;showDeleted&quot;, &quot;true&quot;);</span>
<a href="#l1.28"></a><span id="l1.28">         }</span>
<a href="#l1.29"></a><span id="l1.29">         if (tasksRequest.uri &amp;&amp; this.checkThrottle(&quot;tasks&quot;)) {</span>
<a href="#l1.30"></a><span id="l1.30">             let saver = new ItemSaver(this);</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineplus">+            let lastUpdated = null;</span>
<a href="#l1.32"></a><span id="l1.32">             tasksPromise = this.session.asyncPaginatedRequest(tasksRequest, function(aData) {</span>
<a href="#l1.33"></a><span id="l1.33">                 // On the first request...</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineminus">-                cal.LOG(&quot;[calGoogleCalendar] Last sync date for &quot; + this.name +</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineminus">-                        &quot;(tasks) is now: &quot; + tasksRequest.requestDate.toString());</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineminus">-                let lastUpdated = tasksRequest.requestDate.icalString;</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineminus">-                this.setProperty(&quot;lastUpdated.tasks&quot;, lastUpdated);</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineplus">+                lastUpdated = tasksRequest.requestDate.icalString;</span>
<a href="#l1.39"></a><span id="l1.39">             }.bind(this), function(aData) {</span>
<a href="#l1.40"></a><span id="l1.40">                 // On each request...</span>
<a href="#l1.41"></a><span id="l1.41">                 return saver.parseItemStream(aData);</span>
<a href="#l1.42"></a><span id="l1.42" class="difflineplus">+            }.bind(this), function(aData) {</span>
<a href="#l1.43"></a><span id="l1.43" class="difflineplus">+                // On last request...</span>
<a href="#l1.44"></a><span id="l1.44" class="difflineplus">+                return saver.complete().then(function() {</span>
<a href="#l1.45"></a><span id="l1.45" class="difflineplus">+                    cal.LOG(&quot;[calGoogleCalendar] Last sync date for &quot; + this.name +</span>
<a href="#l1.46"></a><span id="l1.46" class="difflineplus">+                            &quot;(tasks) is now: &quot; + tasksRequest.requestDate.toString());</span>
<a href="#l1.47"></a><span id="l1.47" class="difflineplus">+                    this.setProperty(&quot;lastUpdated.tasks&quot;, lastUpdated);</span>
<a href="#l1.48"></a><span id="l1.48" class="difflineplus">+                }.bind(this));</span>
<a href="#l1.49"></a><span id="l1.49">             }.bind(this));</span>
<a href="#l1.50"></a><span id="l1.50">         }</span>
<a href="#l1.51"></a><span id="l1.51"> </span>
<a href="#l1.52"></a><span id="l1.52">         return PromiseAll([calendarPromise, eventsPromise, tasksPromise]).then(function() {</span>
<a href="#l1.53"></a><span id="l1.53">             this.mOfflineStorage.endBatch();</span>
<a href="#l1.54"></a><span id="l1.54">             aListener.onResult({ status: Components.results.NS_OK }, null);</span>
<a href="#l1.55"></a><span id="l1.55">         }.bind(this), function(e) {</span>
<a href="#l1.56"></a><span id="l1.56">             this.mOfflineStorage.endBatch();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/calendar/providers/gdata/modules/gdataUtils.jsm</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/calendar/providers/gdata/modules/gdataUtils.jsm</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -945,32 +945,35 @@ function JSONToItem(aEntry, aCalendar, a</span>
<a href="#l2.4"></a><span id="l2.4">  */</span>
<a href="#l2.5"></a><span id="l2.5"> function ItemSaver(aCalendar) {</span>
<a href="#l2.6"></a><span id="l2.6">     this.calendar = aCalendar;</span>
<a href="#l2.7"></a><span id="l2.7">     this.offlineStorage = this.calendar.offlineStorage;</span>
<a href="#l2.8"></a><span id="l2.8">     this.promiseOfflineStorage = promisifyCalendar(this.calendar.offlineStorage);</span>
<a href="#l2.9"></a><span id="l2.9">     this.missingParents = [];</span>
<a href="#l2.10"></a><span id="l2.10">     this.masterItems = Object.create(null);</span>
<a href="#l2.11"></a><span id="l2.11">     this.metaData = Object.create(null);</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+    this.activity = new ActivityShell(aCalendar);</span>
<a href="#l2.13"></a><span id="l2.13"> }</span>
<a href="#l2.14"></a><span id="l2.14"> ItemSaver.prototype = {</span>
<a href="#l2.15"></a><span id="l2.15">     masterItems: null,</span>
<a href="#l2.16"></a><span id="l2.16">     missingParents: null,</span>
<a href="#l2.17"></a><span id="l2.17"> </span>
<a href="#l2.18"></a><span id="l2.18">     /**</span>
<a href="#l2.19"></a><span id="l2.19">      * Convenience function to apply a list of items (task/event) in JSON form to</span>
<a href="#l2.20"></a><span id="l2.20">      * the given calendar.</span>
<a href="#l2.21"></a><span id="l2.21">      *</span>
<a href="#l2.22"></a><span id="l2.22">      * @param aData         The JS Object from the list response.</span>
<a href="#l2.23"></a><span id="l2.23">      * @return              A promise resolved when completed.</span>
<a href="#l2.24"></a><span id="l2.24">      */</span>
<a href="#l2.25"></a><span id="l2.25">     parseItemStream: function(aData) {</span>
<a href="#l2.26"></a><span id="l2.26">         if (aData.kind == &quot;calendar#events&quot;) {</span>
<a href="#l2.27"></a><span id="l2.27" class="difflineplus">+            this.activity.type = &quot;Event&quot;;</span>
<a href="#l2.28"></a><span id="l2.28">             return this.parseEventStream(aData);</span>
<a href="#l2.29"></a><span id="l2.29">         } else if (aData.kind == &quot;tasks#tasks&quot;) {</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineplus">+            this.activity.type = &quot;Task&quot;;</span>
<a href="#l2.31"></a><span id="l2.31">             return this.parseTaskStream(aData);</span>
<a href="#l2.32"></a><span id="l2.32">         } else {</span>
<a href="#l2.33"></a><span id="l2.33">             let message = &quot;Invalid Stream type: &quot; + (aData ? aData.kind || aData.toSource() : null);</span>
<a href="#l2.34"></a><span id="l2.34">             throw new Components.Exception(message, Components.results.NS_ERROR_FAILURE);</span>
<a href="#l2.35"></a><span id="l2.35">         }</span>
<a href="#l2.36"></a><span id="l2.36">     },</span>
<a href="#l2.37"></a><span id="l2.37"> </span>
<a href="#l2.38"></a><span id="l2.38">     /**</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineat">@@ -982,32 +985,34 @@ ItemSaver.prototype = {</span>
<a href="#l2.40"></a><span id="l2.40">      */</span>
<a href="#l2.41"></a><span id="l2.41">     parseTaskStream: function(aData) {</span>
<a href="#l2.42"></a><span id="l2.42">         return Task.spawn(function() {</span>
<a href="#l2.43"></a><span id="l2.43">             if (!aData.items || !aData.items.length) {</span>
<a href="#l2.44"></a><span id="l2.44">                 cal.LOG(&quot;[calGoogleCalendar] No tasks have been changed on &quot; + this.calendar.name);</span>
<a href="#l2.45"></a><span id="l2.45">             } else {</span>
<a href="#l2.46"></a><span id="l2.46">                 cal.LOG(&quot;[calGoogleCalendar] Parsing &quot; + aData.items.length + &quot; received tasks&quot;);</span>
<a href="#l2.47"></a><span id="l2.47"> </span>
<a href="#l2.48"></a><span id="l2.48" class="difflineminus">-                let act = new ActivityShell(this.calendar, &quot;Task&quot;);</span>
<a href="#l2.49"></a><span id="l2.49">                 let total = aData.items.length;</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineplus">+                let committedUnits = 0;</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineplus">+                this.activity.addTotal(total);</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineplus">+</span>
<a href="#l2.53"></a><span id="l2.53">                 for (let cur = 0; cur &lt; total; cur++) {</span>
<a href="#l2.54"></a><span id="l2.54">                     let entry = aData.items[cur];</span>
<a href="#l2.55"></a><span id="l2.55">                     //let metaData = Object.create(null);</span>
<a href="#l2.56"></a><span id="l2.56">                     let metaData = {};</span>
<a href="#l2.57"></a><span id="l2.57">                     let item = JSONToTask(entry, this.calendar, null, null, metaData);</span>
<a href="#l2.58"></a><span id="l2.58">                     this.metaData[item.hashId] = metaData;</span>
<a href="#l2.59"></a><span id="l2.59"> </span>
<a href="#l2.60"></a><span id="l2.60">                     yield this.commitItem(item);</span>
<a href="#l2.61"></a><span id="l2.61"> </span>
<a href="#l2.62"></a><span id="l2.62">                     if (yield spinEventLoop()) {</span>
<a href="#l2.63"></a><span id="l2.63" class="difflineminus">-                        act.setProgress(cur, total);</span>
<a href="#l2.64"></a><span id="l2.64" class="difflineplus">+                        this.activity.addProgress(cur - committedUnits);</span>
<a href="#l2.65"></a><span id="l2.65" class="difflineplus">+                        committedUnits = cur;</span>
<a href="#l2.66"></a><span id="l2.66">                     }</span>
<a href="#l2.67"></a><span id="l2.67">                 }</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineminus">-                act.complete();</span>
<a href="#l2.69"></a><span id="l2.69">             }</span>
<a href="#l2.70"></a><span id="l2.70">         }.bind(this));</span>
<a href="#l2.71"></a><span id="l2.71">     },</span>
<a href="#l2.72"></a><span id="l2.72"> </span>
<a href="#l2.73"></a><span id="l2.73">     /**</span>
<a href="#l2.74"></a><span id="l2.74">      * Parse the response from Google's list command into events.</span>
<a href="#l2.75"></a><span id="l2.75">      *</span>
<a href="#l2.76"></a><span id="l2.76">      * @param aData         The JS Object from the list response.</span>
<a href="#l2.77"></a><span id="l2.77" class="difflineat">@@ -1029,38 +1034,40 @@ ItemSaver.prototype = {</span>
<a href="#l2.78"></a><span id="l2.78"> </span>
<a href="#l2.79"></a><span id="l2.79">             let exceptionItems = [];</span>
<a href="#l2.80"></a><span id="l2.80">             let defaultReminders = (aData.defaultReminders || []).map(function(x) { return JSONToAlarm(x, true); });</span>
<a href="#l2.81"></a><span id="l2.81"> </span>
<a href="#l2.82"></a><span id="l2.82">             // In the first pass, we go through the data and sort into master items and</span>
<a href="#l2.83"></a><span id="l2.83">             // exception items, as the master item might be after the exception in the</span>
<a href="#l2.84"></a><span id="l2.84">             // stream.</span>
<a href="#l2.85"></a><span id="l2.85"> </span>
<a href="#l2.86"></a><span id="l2.86" class="difflineminus">-            let act = new ActivityShell(this.calendar, &quot;Event&quot;);</span>
<a href="#l2.87"></a><span id="l2.87">             let total = aData.items.length;</span>
<a href="#l2.88"></a><span id="l2.88" class="difflineplus">+            let committedUnits = 0;</span>
<a href="#l2.89"></a><span id="l2.89" class="difflineplus">+            this.activity.addTotal(total);</span>
<a href="#l2.90"></a><span id="l2.90" class="difflineplus">+</span>
<a href="#l2.91"></a><span id="l2.91">             for (let cur = 0; cur &lt; total; cur++) {</span>
<a href="#l2.92"></a><span id="l2.92">                 let entry = aData.items[cur];</span>
<a href="#l2.93"></a><span id="l2.93">                 let metaData = Object.create(null);</span>
<a href="#l2.94"></a><span id="l2.94">                 let item = JSONToEvent(entry, this.calendar, defaultReminders, null, metaData);</span>
<a href="#l2.95"></a><span id="l2.95">                 LOGitem(item);</span>
<a href="#l2.96"></a><span id="l2.96"> </span>
<a href="#l2.97"></a><span id="l2.97">                 this.metaData[item.hashId] = metaData;</span>
<a href="#l2.98"></a><span id="l2.98"> </span>
<a href="#l2.99"></a><span id="l2.99">                 if (item.recurrenceId) {</span>
<a href="#l2.100"></a><span id="l2.100">                     exceptionItems.push(item);</span>
<a href="#l2.101"></a><span id="l2.101">                 } else {</span>
<a href="#l2.102"></a><span id="l2.102">                     this.masterItems[item.id] = item;</span>
<a href="#l2.103"></a><span id="l2.103">                     yield this.commitItem(item);</span>
<a href="#l2.104"></a><span id="l2.104">                 }</span>
<a href="#l2.105"></a><span id="l2.105"> </span>
<a href="#l2.106"></a><span id="l2.106">                 if (yield spinEventLoop()) {</span>
<a href="#l2.107"></a><span id="l2.107" class="difflineminus">-                    act.setProgress(cur, total);</span>
<a href="#l2.108"></a><span id="l2.108" class="difflineplus">+                    this.activity.addProgress(cur - committedUnits);</span>
<a href="#l2.109"></a><span id="l2.109" class="difflineplus">+                    committedUnits = cur;</span>
<a href="#l2.110"></a><span id="l2.110">                 }</span>
<a href="#l2.111"></a><span id="l2.111">             }</span>
<a href="#l2.112"></a><span id="l2.112" class="difflineminus">-            act.complete();</span>
<a href="#l2.113"></a><span id="l2.113"> </span>
<a href="#l2.114"></a><span id="l2.114">             // Go through all exceptions and attempt to find the master item in the</span>
<a href="#l2.115"></a><span id="l2.115">             // item stream. If it can't be found there, the offline storage is asked</span>
<a href="#l2.116"></a><span id="l2.116">             // for the parent item. If it still can't be found, then we have to do</span>
<a href="#l2.117"></a><span id="l2.117">             // this at the end.</span>
<a href="#l2.118"></a><span id="l2.118">             for each (let exc in exceptionItems) {</span>
<a href="#l2.119"></a><span id="l2.119">                 // If we have the master item in our cache then use it. Otherwise</span>
<a href="#l2.120"></a><span id="l2.120">                 // attempt to get it from the offline storage.</span>
<a href="#l2.121"></a><span id="l2.121" class="difflineat">@@ -1142,18 +1149,27 @@ ItemSaver.prototype = {</span>
<a href="#l2.122"></a><span id="l2.122">             if (item.hashId in this.metaData) {</span>
<a href="#l2.123"></a><span id="l2.123">                 // Make sure the metadata is up to date for the next request</span>
<a href="#l2.124"></a><span id="l2.124">                 saveItemMetadata(this.offlineStorage, item.hashId, this.metaData[item.hashId]);</span>
<a href="#l2.125"></a><span id="l2.125">             }</span>
<a href="#l2.126"></a><span id="l2.126">         }.bind(this));</span>
<a href="#l2.127"></a><span id="l2.127">     },</span>
<a href="#l2.128"></a><span id="l2.128"> </span>
<a href="#l2.129"></a><span id="l2.129">     /**</span>
<a href="#l2.130"></a><span id="l2.130" class="difflineminus">-     * Handle all remaining exceptions in the item saver. Call this at the end</span>
<a href="#l2.131"></a><span id="l2.131" class="difflineminus">-     * when all items and exceptions have been loaded to ensure that any</span>
<a href="#l2.132"></a><span id="l2.132" class="difflineplus">+     * Complete the item saving, this will take care of all steps required</span>
<a href="#l2.133"></a><span id="l2.133" class="difflineplus">+     * after the last request.</span>
<a href="#l2.134"></a><span id="l2.134" class="difflineplus">+     */</span>
<a href="#l2.135"></a><span id="l2.135" class="difflineplus">+    complete: function() {</span>
<a href="#l2.136"></a><span id="l2.136" class="difflineplus">+        return this.processRemainingExceptions().then(function() {</span>
<a href="#l2.137"></a><span id="l2.137" class="difflineplus">+            this.activity.complete();</span>
<a href="#l2.138"></a><span id="l2.138" class="difflineplus">+        }.bind(this));</span>
<a href="#l2.139"></a><span id="l2.139" class="difflineplus">+    },</span>
<a href="#l2.140"></a><span id="l2.140" class="difflineplus">+</span>
<a href="#l2.141"></a><span id="l2.141" class="difflineplus">+    /**</span>
<a href="#l2.142"></a><span id="l2.142" class="difflineplus">+     * Handle all remaining exceptions in the item saver. Ensures that any</span>
<a href="#l2.143"></a><span id="l2.143">      * missing master items are searched for or created.</span>
<a href="#l2.144"></a><span id="l2.144">      *</span>
<a href="#l2.145"></a><span id="l2.145">      * @return          A promise resolved on completion</span>
<a href="#l2.146"></a><span id="l2.146">      */</span>
<a href="#l2.147"></a><span id="l2.147">     processRemainingExceptions: function() {</span>
<a href="#l2.148"></a><span id="l2.148">         return Task.spawn(function() {</span>
<a href="#l2.149"></a><span id="l2.149">             for each (let exc in this.missingParents) {</span>
<a href="#l2.150"></a><span id="l2.150">                 let item = (yield this.promiseOfflineStorage.getItem(exc.id))[0];</span>
<a href="#l2.151"></a><span id="l2.151" class="difflineat">@@ -1187,19 +1203,18 @@ ItemSaver.prototype = {</span>
<a href="#l2.152"></a><span id="l2.152">     }</span>
<a href="#l2.153"></a><span id="l2.153"> };</span>
<a href="#l2.154"></a><span id="l2.154"> </span>
<a href="#l2.155"></a><span id="l2.155"> /**</span>
<a href="#l2.156"></a><span id="l2.156">  * A wrapper for nsIActivity to handle the synchronization process.</span>
<a href="#l2.157"></a><span id="l2.157">  *</span>
<a href="#l2.158"></a><span id="l2.158">  * @param aCalendar     The calendar for this activity.</span>
<a href="#l2.159"></a><span id="l2.159">  */</span>
<a href="#l2.160"></a><span id="l2.160" class="difflineminus">-function ActivityShell(aCalendar, aType) {</span>
<a href="#l2.161"></a><span id="l2.161" class="difflineplus">+function ActivityShell(aCalendar) {</span>
<a href="#l2.162"></a><span id="l2.162">     this.calendar = aCalendar;</span>
<a href="#l2.163"></a><span id="l2.163" class="difflineminus">-    this.type = aType;</span>
<a href="#l2.164"></a><span id="l2.164"> </span>
<a href="#l2.165"></a><span id="l2.165">     if ('@mozilla.org/activity-process;1' in Components.classes) {</span>
<a href="#l2.166"></a><span id="l2.166">         this.init();</span>
<a href="#l2.167"></a><span id="l2.167">     }</span>
<a href="#l2.168"></a><span id="l2.168"> }</span>
<a href="#l2.169"></a><span id="l2.169"> </span>
<a href="#l2.170"></a><span id="l2.170"> ActivityShell.prototype = {</span>
<a href="#l2.171"></a><span id="l2.171">     act: null,</span>
<a href="#l2.172"></a><span id="l2.172" class="difflineat">@@ -1212,30 +1227,41 @@ ActivityShell.prototype = {</span>
<a href="#l2.173"></a><span id="l2.173">                                 .getService(Components.interfaces.nsIActivityManager);</span>
<a href="#l2.174"></a><span id="l2.174">         this.act =  Components.classes['@mozilla.org/activity-process;1']</span>
<a href="#l2.175"></a><span id="l2.175">                               .createInstance(Components.interfaces.nsIActivityProcess);</span>
<a href="#l2.176"></a><span id="l2.176">         this.act.init(getProviderString(&quot;syncStatus&quot;, this.calendar.name), this);</span>
<a href="#l2.177"></a><span id="l2.177">         this.act.iconClass = &quot;syncMail&quot;;</span>
<a href="#l2.178"></a><span id="l2.178">         this.act.contextType = &quot;gdata-calendar&quot;;</span>
<a href="#l2.179"></a><span id="l2.179">         this.act.contextObj = this.calendar;</span>
<a href="#l2.180"></a><span id="l2.180">         this.act.contextDisplayText = this.calendar.name;</span>
<a href="#l2.181"></a><span id="l2.181" class="difflineplus">+        this.act.state = Components.interfaces.nsIActivityProcess.STATE_INPROGRESS;</span>
<a href="#l2.182"></a><span id="l2.182"> </span>
<a href="#l2.183"></a><span id="l2.183">         this.actMgr.addActivity(this.act);</span>
<a href="#l2.184"></a><span id="l2.184">     },</span>
<a href="#l2.185"></a><span id="l2.185"> </span>
<a href="#l2.186"></a><span id="l2.186" class="difflineplus">+    addProgress: function(units) {</span>
<a href="#l2.187"></a><span id="l2.187" class="difflineplus">+        if (!this.act) {</span>
<a href="#l2.188"></a><span id="l2.188" class="difflineplus">+            return;</span>
<a href="#l2.189"></a><span id="l2.189" class="difflineplus">+        }</span>
<a href="#l2.190"></a><span id="l2.190" class="difflineplus">+        this.setProgress(this.act.workUnitComplete + units, this.act.totalWorkUnits);</span>
<a href="#l2.191"></a><span id="l2.191" class="difflineplus">+    },</span>
<a href="#l2.192"></a><span id="l2.192" class="difflineplus">+</span>
<a href="#l2.193"></a><span id="l2.193" class="difflineplus">+    addTotal: function(units) {</span>
<a href="#l2.194"></a><span id="l2.194" class="difflineplus">+        if (!this.act) {</span>
<a href="#l2.195"></a><span id="l2.195" class="difflineplus">+            return;</span>
<a href="#l2.196"></a><span id="l2.196" class="difflineplus">+        }</span>
<a href="#l2.197"></a><span id="l2.197" class="difflineplus">+        this.setProgress(this.act.workUnitComplete, this.act.totalWorkUnits + units);</span>
<a href="#l2.198"></a><span id="l2.198" class="difflineplus">+    },</span>
<a href="#l2.199"></a><span id="l2.199" class="difflineplus">+</span>
<a href="#l2.200"></a><span id="l2.200">     setProgress: function(cur, total) {</span>
<a href="#l2.201"></a><span id="l2.201">         if (!this.act) {</span>
<a href="#l2.202"></a><span id="l2.202">             return;</span>
<a href="#l2.203"></a><span id="l2.203">         }</span>
<a href="#l2.204"></a><span id="l2.204" class="difflineminus">-        if (cur == total) {</span>
<a href="#l2.205"></a><span id="l2.205" class="difflineminus">-            this.complete();</span>
<a href="#l2.206"></a><span id="l2.206" class="difflineminus">-        } else {</span>
<a href="#l2.207"></a><span id="l2.207" class="difflineminus">-            let str = getProviderString(&quot;syncProgress&quot; + this.type, this.calendar.name, cur, total);</span>
<a href="#l2.208"></a><span id="l2.208" class="difflineminus">-            this.act.setProgress(str, cur, total);</span>
<a href="#l2.209"></a><span id="l2.209" class="difflineminus">-        }</span>
<a href="#l2.210"></a><span id="l2.210" class="difflineplus">+        let str = getProviderString(&quot;syncProgress&quot; + this.type, this.calendar.name, cur, total);</span>
<a href="#l2.211"></a><span id="l2.211" class="difflineplus">+        this.act.setProgress(str, cur, total);</span>
<a href="#l2.212"></a><span id="l2.212">     },</span>
<a href="#l2.213"></a><span id="l2.213"> </span>
<a href="#l2.214"></a><span id="l2.214">     complete: function() {</span>
<a href="#l2.215"></a><span id="l2.215">         if (!this.act) {</span>
<a href="#l2.216"></a><span id="l2.216">             return;</span>
<a href="#l2.217"></a><span id="l2.217">         }</span>
<a href="#l2.218"></a><span id="l2.218">         let total = this.act.totalWorkUnits;</span>
<a href="#l2.219"></a><span id="l2.219">         this.act.setProgress(&quot;&quot;, total, total);</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

