<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 4845:7f00e1ae066df70f017463f99f3b18f3ad071956</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 7f00e1ae066df70f017463f99f3b18f3ad071956" />
<meta property="og:url" content="/comm-central/rev/7f00e1ae066df70f017463f99f3b18f3ad071956" />
<meta property="og:description" content="Bug 487610 - Messages marked manually as Junk are never moved to Junk folder (if user doesn't check &quot;Enable adaptive junk mail controls for this account&quot;), r/sr=bienvenu" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 7f00e1ae066df70f017463f99f3b18f3ad071956 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/7f00e1ae066df70f017463f99f3b18f3ad071956">shortlog</a> |
<a href="/comm-central/log/7f00e1ae066df70f017463f99f3b18f3ad071956">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/7f00e1ae066df70f017463f99f3b18f3ad071956">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/7f00e1ae066df70f017463f99f3b18f3ad071956">files</a> |
changeset |
<a href="/comm-central/raw-rev/7f00e1ae066df70f017463f99f3b18f3ad071956">raw</a>  | <a href="/comm-central/archive/7f00e1ae066df70f017463f99f3b18f3ad071956.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=487610">Bug 487610</a> - Messages marked manually as Junk are never moved to Junk folder (if user doesn't check &quot;Enable adaptive junk mail controls for this account&quot;), r/sr=bienvenu
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#75;&#101;&#110;&#116;&#32;&#74;&#97;&#109;&#101;&#115;&#32;&#60;&#107;&#101;&#110;&#116;&#64;&#99;&#97;&#115;&#112;&#105;&#97;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Fri, 05 Feb 2010 16:25:07 -0800</td></tr>

<tr>
 <td>changeset 4845</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/7f00e1ae066df70f017463f99f3b18f3ad071956">7f00e1ae066df70f017463f99f3b18f3ad071956</a></td>
</tr>



<tr>
<td>parent 4844</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/d201355754281b0fa79e00d356e527a53e3bbff4">d201355754281b0fa79e00d356e527a53e3bbff4</a>
</td>
</tr>

<tr>
<td>child 4846</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/789dd6cd45eff273c7754622e0a0da6e6a6750a6">789dd6cd45eff273c7754622e0a0da6e6a6750a6</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=7f00e1ae066df70f017463f99f3b18f3ad071956">3784</a></td></tr>
<tr><td>push user</td><td>kent@caspia.com</td></tr>
<tr><td>push date</td><td class="date age">Sat, 06 Feb 2010 00:28:08 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@7f00e1ae066d [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=7f00e1ae066df70f017463f99f3b18f3ad071956">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=7f00e1ae066df70f017463f99f3b18f3ad071956&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=7f00e1ae066df70f017463f99f3b18f3ad071956&newProject=comm-central&newRevision=7f00e1ae066df70f017463f99f3b18f3ad071956&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=7f00e1ae066df70f017463f99f3b18f3ad071956&newProject=comm-central&newRevision=7f00e1ae066df70f017463f99f3b18f3ad071956&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=7f00e1ae066df70f017463f99f3b18f3ad071956&newProject=comm-central&newRevision=7f00e1ae066df70f017463f99f3b18f3ad071956&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>

<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=487610">487610</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=487610">Bug 487610</a> - Messages marked manually as Junk are never moved to Junk folder (if user doesn't check &quot;Enable adaptive junk mail controls for this account&quot;), r/sr=bienvenu</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7f00e1ae066df70f017463f99f3b18f3ad071956/mailnews/base/src/nsMsgDBView.cpp">mailnews/base/src/nsMsgDBView.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7f00e1ae066df70f017463f99f3b18f3ad071956/mailnews/base/src/nsMsgDBView.cpp">file</a> |
<a href="/comm-central/annotate/7f00e1ae066df70f017463f99f3b18f3ad071956/mailnews/base/src/nsMsgDBView.cpp">annotate</a> |
<a href="/comm-central/diff/7f00e1ae066df70f017463f99f3b18f3ad071956/mailnews/base/src/nsMsgDBView.cpp">diff</a> |
<a href="/comm-central/comparison/7f00e1ae066df70f017463f99f3b18f3ad071956/mailnews/base/src/nsMsgDBView.cpp">comparison</a> |
<a href="/comm-central/log/7f00e1ae066df70f017463f99f3b18f3ad071956/mailnews/base/src/nsMsgDBView.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7f00e1ae066df70f017463f99f3b18f3ad071956/mailnews/base/test/unit/test_junkingWhenDisabled.js">mailnews/base/test/unit/test_junkingWhenDisabled.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7f00e1ae066df70f017463f99f3b18f3ad071956/mailnews/base/test/unit/test_junkingWhenDisabled.js">file</a> |
<a href="/comm-central/annotate/7f00e1ae066df70f017463f99f3b18f3ad071956/mailnews/base/test/unit/test_junkingWhenDisabled.js">annotate</a> |
<a href="/comm-central/diff/7f00e1ae066df70f017463f99f3b18f3ad071956/mailnews/base/test/unit/test_junkingWhenDisabled.js">diff</a> |
<a href="/comm-central/comparison/7f00e1ae066df70f017463f99f3b18f3ad071956/mailnews/base/test/unit/test_junkingWhenDisabled.js">comparison</a> |
<a href="/comm-central/log/7f00e1ae066df70f017463f99f3b18f3ad071956/mailnews/base/test/unit/test_junkingWhenDisabled.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/base/src/nsMsgDBView.cpp</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgDBView.cpp</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -3382,33 +3382,23 @@ nsMsgDBView::DetermineActionsForJunkChan</span>
<a href="#l1.4"></a><span id="l1.4">     }</span>
<a href="#l1.5"></a><span id="l1.5">     return NS_OK;</span>
<a href="#l1.6"></a><span id="l1.6">   }</span>
<a href="#l1.7"></a><span id="l1.7"> </span>
<a href="#l1.8"></a><span id="l1.8">   nsCOMPtr &lt;nsISpamSettings&gt; spamSettings;</span>
<a href="#l1.9"></a><span id="l1.9">   rv = server-&gt;GetSpamSettings(getter_AddRefs(spamSettings));</span>
<a href="#l1.10"></a><span id="l1.10">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-  // if the spam system is completely disabled we won't do anything</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-  // question: is this a valid choice?</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineminus">-  PRInt32 spamLevel;</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineminus">-  (void)spamSettings-&gt;GetLevel(&amp;spamLevel);</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineminus">-  if (!spamLevel)</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineminus">-    return NS_OK;</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineminus">-</span>
<a href="#l1.19"></a><span id="l1.19">   // When the user explicitly marks a message as junk, we can mark it as read,</span>
<a href="#l1.20"></a><span id="l1.20">   // too. This is independent of the &quot;markAsReadOnSpam&quot; pref, which applies</span>
<a href="#l1.21"></a><span id="l1.21">   // only to automatically-classified messages.</span>
<a href="#l1.22"></a><span id="l1.22">   // Note that this behaviour should match the one in the front end for marking</span>
<a href="#l1.23"></a><span id="l1.23">   // as junk via toolbar/context menu.</span>
<a href="#l1.24"></a><span id="l1.24" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l1.25"></a><span id="l1.25" class="difflineminus">-  {</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineminus">-    prefBranch-&gt;GetBoolPref(&quot;mailnews.ui.junk.manualMarkAsJunkMarksRead&quot;,</span>
<a href="#l1.27"></a><span id="l1.27" class="difflineminus">-                            &amp;changeReadState);</span>
<a href="#l1.28"></a><span id="l1.28" class="difflineminus">-  }</span>
<a href="#l1.29"></a><span id="l1.29" class="difflineplus">+  prefBranch-&gt;GetBoolPref(&quot;mailnews.ui.junk.manualMarkAsJunkMarksRead&quot;,</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineplus">+                          &amp;changeReadState);</span>
<a href="#l1.31"></a><span id="l1.31"> </span>
<a href="#l1.32"></a><span id="l1.32">   // now let's determine whether we'll be taking the second action,</span>
<a href="#l1.33"></a><span id="l1.33">   // the move / deletion (and also determine which of these two)</span>
<a href="#l1.34"></a><span id="l1.34"> </span>
<a href="#l1.35"></a><span id="l1.35">   PRBool manualMark;</span>
<a href="#l1.36"></a><span id="l1.36">   (void)spamSettings-&gt;GetManualMark(&amp;manualMark);</span>
<a href="#l1.37"></a><span id="l1.37">   if (!manualMark)</span>
<a href="#l1.38"></a><span id="l1.38">     return NS_OK;</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineat">@@ -3430,19 +3420,32 @@ nsMsgDBView::DetermineActionsForJunkChan</span>
<a href="#l1.40"></a><span id="l1.40">     nsCString spamFolderURI;</span>
<a href="#l1.41"></a><span id="l1.41">     rv = spamSettings-&gt;GetSpamFolderURI(getter_Copies(spamFolderURI));</span>
<a href="#l1.42"></a><span id="l1.42">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.43"></a><span id="l1.43"> </span>
<a href="#l1.44"></a><span id="l1.44">     NS_ASSERTION(!spamFolderURI.IsEmpty(), &quot;spam folder URI is empty, can't move&quot;);</span>
<a href="#l1.45"></a><span id="l1.45">     if (!spamFolderURI.IsEmpty())</span>
<a href="#l1.46"></a><span id="l1.46">     {</span>
<a href="#l1.47"></a><span id="l1.47">       rv = GetExistingFolder(spamFolderURI, targetFolder);</span>
<a href="#l1.48"></a><span id="l1.48" class="difflineminus">-      NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.49"></a><span id="l1.49" class="difflineminus">-</span>
<a href="#l1.50"></a><span id="l1.50" class="difflineminus">-      moveMessages = true;</span>
<a href="#l1.51"></a><span id="l1.51" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; *targetFolder)</span>
<a href="#l1.52"></a><span id="l1.52" class="difflineplus">+      {</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineplus">+        moveMessages = true;</span>
<a href="#l1.54"></a><span id="l1.54" class="difflineplus">+      }</span>
<a href="#l1.55"></a><span id="l1.55" class="difflineplus">+      else</span>
<a href="#l1.56"></a><span id="l1.56" class="difflineplus">+      {</span>
<a href="#l1.57"></a><span id="l1.57" class="difflineplus">+        // XXX ToDo: GetOrCreateFolder will only create a folder with localized</span>
<a href="#l1.58"></a><span id="l1.58" class="difflineplus">+        //           name &quot;Junk&quot; regardless of spamFolderURI. So if someone</span>
<a href="#l1.59"></a><span id="l1.59" class="difflineplus">+        //           sets the junk folder to an existing folder of a different</span>
<a href="#l1.60"></a><span id="l1.60" class="difflineplus">+        //           name, then deletes that folder, this will fail to create</span>
<a href="#l1.61"></a><span id="l1.61" class="difflineplus">+        //           the correct folder.</span>
<a href="#l1.62"></a><span id="l1.62" class="difflineplus">+        rv = GetOrCreateFolder(spamFolderURI, nsnull /* aListener */);</span>
<a href="#l1.63"></a><span id="l1.63" class="difflineplus">+        if (NS_SUCCEEDED(rv))</span>
<a href="#l1.64"></a><span id="l1.64" class="difflineplus">+          rv = GetExistingFolder(spamFolderURI, targetFolder);</span>
<a href="#l1.65"></a><span id="l1.65" class="difflineplus">+        NS_ASSERTION(NS_SUCCEEDED(rv) &amp;&amp; *targetFolder, &quot;GetOrCreateFolder failed&quot;);</span>
<a href="#l1.66"></a><span id="l1.66" class="difflineplus">+      }</span>
<a href="#l1.67"></a><span id="l1.67">     }</span>
<a href="#l1.68"></a><span id="l1.68">     return NS_OK;</span>
<a href="#l1.69"></a><span id="l1.69">   }</span>
<a href="#l1.70"></a><span id="l1.70"> </span>
<a href="#l1.71"></a><span id="l1.71">   // at this point manualMarkMode == nsISpamSettings::MANUAL_MARK_MODE_DELETE)</span>
<a href="#l1.72"></a><span id="l1.72"> </span>
<a href="#l1.73"></a><span id="l1.73">   // if this is in the trash, let's not delete</span>
<a href="#l1.74"></a><span id="l1.74">   if (folderFlags &amp; nsMsgFolderFlags::Trash)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1">new file mode 100644</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineminus">--- /dev/null</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineplus">+++ b/mailnews/base/test/unit/test_junkingWhenDisabled.js</span>
<a href="#l2.4"></a><span id="l2.4" class="difflineat">@@ -0,0 +1,209 @@</span>
<a href="#l2.5"></a><span id="l2.5" class="difflineplus">+/*</span>
<a href="#l2.6"></a><span id="l2.6" class="difflineplus">+ * Test that junk actions work even when the bayes filtering of incoming</span>
<a href="#l2.7"></a><span id="l2.7" class="difflineplus">+ *  messages is disabled, as fixed in bug 487610. Test developed by Kent</span>
<a href="#l2.8"></a><span id="l2.8" class="difflineplus">+ *  James using test_nsMsgDBView.js as a base.</span>
<a href="#l2.9"></a><span id="l2.9" class="difflineplus">+ */</span>
<a href="#l2.10"></a><span id="l2.10" class="difflineplus">+</span>
<a href="#l2.11"></a><span id="l2.11" class="difflineplus">+load(&quot;../../mailnews/resources/logHelper.js&quot;);</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+load(&quot;../../mailnews/resources/asyncTestUtils.js&quot;);</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+load(&quot;../../mailnews/resources/messageGenerator.js&quot;);</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+load(&quot;../../mailnews/resources/messageModifier.js&quot;);</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+load(&quot;../../mailnews/resources/messageInjection.js&quot;);</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineplus">+</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineplus">+Components.utils.import(&quot;resource://app/modules/jsTreeSelection.js&quot;);</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineplus">+</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineplus">+const nsIMFNService = Ci.nsIMsgFolderNotificationService;</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineplus">+var gMFNService = Cc[&quot;@mozilla.org/messenger/msgnotificationservice;1&quot;]</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineplus">+                    .getService(nsIMFNService);</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineplus">+</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineplus">+// fake objects needed to get nsMsgDBView to operate on selected messages.</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineplus">+// Warning: these are partial implementations. If someone adds additional</span>
<a href="#l2.27"></a><span id="l2.27" class="difflineplus">+// calls to these objects in nsMsgDBView and friends, it will also</span>
<a href="#l2.28"></a><span id="l2.28" class="difflineplus">+// be necessary to add fake versions of those calls here.</span>
<a href="#l2.29"></a><span id="l2.29" class="difflineplus">+</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineplus">+var gFakeView = {</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineplus">+  rowCount: 1,</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineplus">+  selectionChanged: function() {</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineplus">+  },</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineplus">+  QueryInterface: XPCOMUtils.generateQI([Ci.nsITreeView]),</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineplus">+};</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineplus">+</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineplus">+var gFakeBox = {</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineplus">+  view: gFakeView,</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineplus">+  invalidate: function() {},</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineplus">+  invalidateRow: function() {},</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineplus">+  beginUpdateBatch: function() {},</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineplus">+  endUpdateBatch: function() {},</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineplus">+  invalidateRange: function(startIndex, endIndex) {},</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineplus">+  rowCountChanged: function (index, count) {},</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineplus">+</span>
<a href="#l2.46"></a><span id="l2.46" class="difflineplus">+  QueryInterface: XPCOMUtils.generateQI([Ci.nsITreeBoxObject]),</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineplus">+};</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineplus">+</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineplus">+var gFakeSelection = new JSTreeSelection(gFakeBox);</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineplus">+</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineplus">+// Items used to add messages to the folder</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineplus">+</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineplus">+var gMessageGenerator = new MessageGenerator();</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineplus">+var gScenarioFactory = new MessageScenarioFactory(gMessageGenerator);</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineplus">+</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineplus">+var gLocalInboxFolder;</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineplus">+</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineplus">+function setup_globals(aNextFunc) {</span>
<a href="#l2.59"></a><span id="l2.59" class="difflineplus">+  // build up a message</span>
<a href="#l2.60"></a><span id="l2.60" class="difflineplus">+  let messages = [];</span>
<a href="#l2.61"></a><span id="l2.61" class="difflineplus">+  let msg1 = gMessageGenerator.makeMessage();</span>
<a href="#l2.62"></a><span id="l2.62" class="difflineplus">+  messages = messages.concat([msg1]);</span>
<a href="#l2.63"></a><span id="l2.63" class="difflineplus">+  let msgSet = new SyntheticMessageSet(messages);</span>
<a href="#l2.64"></a><span id="l2.64" class="difflineplus">+</span>
<a href="#l2.65"></a><span id="l2.65" class="difflineplus">+  return add_sets_to_folders(gLocalInboxFolder, [msgSet]);</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineplus">+}</span>
<a href="#l2.67"></a><span id="l2.67" class="difflineplus">+</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineplus">+var gCommandUpdater = {</span>
<a href="#l2.69"></a><span id="l2.69" class="difflineplus">+  updateCommandStatus : function()</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineplus">+  {</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineplus">+    // the back end is smart and is only telling us to update command status</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineplus">+    // when the # of items in the selection has actually changed.</span>
<a href="#l2.73"></a><span id="l2.73" class="difflineplus">+  },</span>
<a href="#l2.74"></a><span id="l2.74" class="difflineplus">+</span>
<a href="#l2.75"></a><span id="l2.75" class="difflineplus">+  displayMessageChanged : function(aFolder, aSubject, aKeywords)</span>
<a href="#l2.76"></a><span id="l2.76" class="difflineplus">+  {</span>
<a href="#l2.77"></a><span id="l2.77" class="difflineplus">+  },</span>
<a href="#l2.78"></a><span id="l2.78" class="difflineplus">+</span>
<a href="#l2.79"></a><span id="l2.79" class="difflineplus">+  updateNextMessageAfterDelete : function()</span>
<a href="#l2.80"></a><span id="l2.80" class="difflineplus">+  {</span>
<a href="#l2.81"></a><span id="l2.81" class="difflineplus">+  },</span>
<a href="#l2.82"></a><span id="l2.82" class="difflineplus">+  summarizeSelection : function() {return false;}</span>
<a href="#l2.83"></a><span id="l2.83" class="difflineplus">+};</span>
<a href="#l2.84"></a><span id="l2.84" class="difflineplus">+</span>
<a href="#l2.85"></a><span id="l2.85" class="difflineplus">+var gDBView;</span>
<a href="#l2.86"></a><span id="l2.86" class="difflineplus">+var gTreeView;</span>
<a href="#l2.87"></a><span id="l2.87" class="difflineplus">+</span>
<a href="#l2.88"></a><span id="l2.88" class="difflineplus">+var SortType = Components.interfaces.nsMsgViewSortType;</span>
<a href="#l2.89"></a><span id="l2.89" class="difflineplus">+var SortOrder = Components.interfaces.nsMsgViewSortOrder;</span>
<a href="#l2.90"></a><span id="l2.90" class="difflineplus">+var ViewFlags = Components.interfaces.nsMsgViewFlagsType;</span>
<a href="#l2.91"></a><span id="l2.91" class="difflineplus">+</span>
<a href="#l2.92"></a><span id="l2.92" class="difflineplus">+function setup_view(aViewType, aViewFlags) {</span>
<a href="#l2.93"></a><span id="l2.93" class="difflineplus">+  let dbviewContractId = &quot;@mozilla.org/messenger/msgdbview;1?type=&quot; + aViewType;</span>
<a href="#l2.94"></a><span id="l2.94" class="difflineplus">+</span>
<a href="#l2.95"></a><span id="l2.95" class="difflineplus">+  // always start out fully expanded</span>
<a href="#l2.96"></a><span id="l2.96" class="difflineplus">+  aViewFlags |= ViewFlags.kExpandAll;</span>
<a href="#l2.97"></a><span id="l2.97" class="difflineplus">+</span>
<a href="#l2.98"></a><span id="l2.98" class="difflineplus">+  gDBView = Components.classes[dbviewContractId]</span>
<a href="#l2.99"></a><span id="l2.99" class="difflineplus">+                      .createInstance(Components.interfaces.nsIMsgDBView);</span>
<a href="#l2.100"></a><span id="l2.100" class="difflineplus">+  gDBView.init(null, null, gCommandUpdater);</span>
<a href="#l2.101"></a><span id="l2.101" class="difflineplus">+  var outCount = {};</span>
<a href="#l2.102"></a><span id="l2.102" class="difflineplus">+  gDBView.open(gLocalInboxFolder, SortType.byDate, SortOrder.ascending, aViewFlags, outCount);</span>
<a href="#l2.103"></a><span id="l2.103" class="difflineplus">+  dump(&quot;  View Out Count: &quot; + outCount.value + &quot;\n&quot;);</span>
<a href="#l2.104"></a><span id="l2.104" class="difflineplus">+</span>
<a href="#l2.105"></a><span id="l2.105" class="difflineplus">+  gTreeView = gDBView.QueryInterface(Components.interfaces.nsITreeView);</span>
<a href="#l2.106"></a><span id="l2.106" class="difflineplus">+  gTreeView.setTree(gFakeBox);</span>
<a href="#l2.107"></a><span id="l2.107" class="difflineplus">+  gTreeView.selection = gFakeSelection;</span>
<a href="#l2.108"></a><span id="l2.108" class="difflineplus">+}</span>
<a href="#l2.109"></a><span id="l2.109" class="difflineplus">+</span>
<a href="#l2.110"></a><span id="l2.110" class="difflineplus">+var tests_for_all_views = [</span>
<a href="#l2.111"></a><span id="l2.111" class="difflineplus">+  // In the proposed fix for bug 487610, the first call to junk messages</span>
<a href="#l2.112"></a><span id="l2.112" class="difflineplus">+  //  only creates the junk folder, it does not actually successfully move</span>
<a href="#l2.113"></a><span id="l2.113" class="difflineplus">+  //  messages. So we junk messages twice so we can really see a move. But</span>
<a href="#l2.114"></a><span id="l2.114" class="difflineplus">+  //  if that gets fixed and the messages actually move on the first call,</span>
<a href="#l2.115"></a><span id="l2.115" class="difflineplus">+  //  I want this test to succeed as well. So I don't actually count how</span>
<a href="#l2.116"></a><span id="l2.116" class="difflineplus">+  //  many messages get moved, just that some do on the second move.</span>
<a href="#l2.117"></a><span id="l2.117" class="difflineplus">+  junkMessages,</span>
<a href="#l2.118"></a><span id="l2.118" class="difflineplus">+  addMessages,</span>
<a href="#l2.119"></a><span id="l2.119" class="difflineplus">+  junkMessages</span>
<a href="#l2.120"></a><span id="l2.120" class="difflineplus">+];</span>
<a href="#l2.121"></a><span id="l2.121" class="difflineplus">+</span>
<a href="#l2.122"></a><span id="l2.122" class="difflineplus">+function addMessages() {</span>
<a href="#l2.123"></a><span id="l2.123" class="difflineplus">+  // add another message in case the first one moved</span>
<a href="#l2.124"></a><span id="l2.124" class="difflineplus">+  let messages = [];</span>
<a href="#l2.125"></a><span id="l2.125" class="difflineplus">+  let msg1 = gMessageGenerator.makeMessage();</span>
<a href="#l2.126"></a><span id="l2.126" class="difflineplus">+  messages = messages.concat([msg1]);</span>
<a href="#l2.127"></a><span id="l2.127" class="difflineplus">+  let msgSet = new SyntheticMessageSet(messages);</span>
<a href="#l2.128"></a><span id="l2.128" class="difflineplus">+  return add_sets_to_folders(gLocalInboxFolder, [msgSet]);</span>
<a href="#l2.129"></a><span id="l2.129" class="difflineplus">+}</span>
<a href="#l2.130"></a><span id="l2.130" class="difflineplus">+</span>
<a href="#l2.131"></a><span id="l2.131" class="difflineplus">+function junkMessages() {</span>
<a href="#l2.132"></a><span id="l2.132" class="difflineplus">+</span>
<a href="#l2.133"></a><span id="l2.133" class="difflineplus">+  // select and junk all messages</span>
<a href="#l2.134"></a><span id="l2.134" class="difflineplus">+  gDBView.doCommand(Ci.nsMsgViewCommandType.selectAll);</span>
<a href="#l2.135"></a><span id="l2.135" class="difflineplus">+  gDBView.doCommand(Ci.nsMsgViewCommandType.junk);</span>
<a href="#l2.136"></a><span id="l2.136" class="difflineplus">+  yield false;</span>
<a href="#l2.137"></a><span id="l2.137" class="difflineplus">+}</span>
<a href="#l2.138"></a><span id="l2.138" class="difflineplus">+</span>
<a href="#l2.139"></a><span id="l2.139" class="difflineplus">+// Our listener, which captures events and does the real tests.</span>
<a href="#l2.140"></a><span id="l2.140" class="difflineplus">+function gMFListener() {}</span>
<a href="#l2.141"></a><span id="l2.141" class="difflineplus">+gMFListener.prototype =</span>
<a href="#l2.142"></a><span id="l2.142" class="difflineplus">+{</span>
<a href="#l2.143"></a><span id="l2.143" class="difflineplus">+</span>
<a href="#l2.144"></a><span id="l2.144" class="difflineplus">+  msgsMoveCopyCompleted: function (aMove, aSrcMsgs, aDestFolder, aDestMsgs)</span>
<a href="#l2.145"></a><span id="l2.145" class="difflineplus">+  {</span>
<a href="#l2.146"></a><span id="l2.146" class="difflineplus">+    do_check_true(aDestFolder.getFlag(Ci.nsMsgFolderFlags.Junk));</span>
<a href="#l2.147"></a><span id="l2.147" class="difflineplus">+    // I tried to test this by counting messages in the folder, didn't work.</span>
<a href="#l2.148"></a><span id="l2.148" class="difflineplus">+    //  Maybe all updates are not completed yet. Anyway I do it by just</span>
<a href="#l2.149"></a><span id="l2.149" class="difflineplus">+    //  making sure there is something in the destination array.</span>
<a href="#l2.150"></a><span id="l2.150" class="difflineplus">+    do_check_true(aDestMsgs.length &gt; 0);</span>
<a href="#l2.151"></a><span id="l2.151" class="difflineplus">+    async_driver();</span>
<a href="#l2.152"></a><span id="l2.152" class="difflineplus">+  },</span>
<a href="#l2.153"></a><span id="l2.153" class="difflineplus">+</span>
<a href="#l2.154"></a><span id="l2.154" class="difflineplus">+  folderAdded: function (aFolder)</span>
<a href="#l2.155"></a><span id="l2.155" class="difflineplus">+  {</span>
<a href="#l2.156"></a><span id="l2.156" class="difflineplus">+    // this should be a junk folder</span>
<a href="#l2.157"></a><span id="l2.157" class="difflineplus">+    do_check_true(aFolder.getFlag(Ci.nsMsgFolderFlags.Junk));</span>
<a href="#l2.158"></a><span id="l2.158" class="difflineplus">+    async_driver();</span>
<a href="#l2.159"></a><span id="l2.159" class="difflineplus">+  },</span>
<a href="#l2.160"></a><span id="l2.160" class="difflineplus">+</span>
<a href="#l2.161"></a><span id="l2.161" class="difflineplus">+};</span>
<a href="#l2.162"></a><span id="l2.162" class="difflineplus">+</span>
<a href="#l2.163"></a><span id="l2.163" class="difflineplus">+function run_test() {</span>
<a href="#l2.164"></a><span id="l2.164" class="difflineplus">+  gLocalInboxFolder = configure_message_injection({mode: &quot;local&quot;});</span>
<a href="#l2.165"></a><span id="l2.165" class="difflineplus">+</span>
<a href="#l2.166"></a><span id="l2.166" class="difflineplus">+  // Set option so that when messages are marked as junk, they move to the junk folder</span>
<a href="#l2.167"></a><span id="l2.167" class="difflineplus">+  let prefSvc = Cc[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l2.168"></a><span id="l2.168" class="difflineplus">+                  .getService(Ci.nsIPrefBranch);</span>
<a href="#l2.169"></a><span id="l2.169" class="difflineplus">+  prefSvc.setBoolPref(&quot;mail.spam.manualMark&quot;, true);</span>
<a href="#l2.170"></a><span id="l2.170" class="difflineplus">+  prefSvc.setIntPref(&quot;mail.spam.manualMarkMode&quot;, 0); // 0 == &quot;move to junk folder&quot;, 1 == &quot;delete&quot;</span>
<a href="#l2.171"></a><span id="l2.171" class="difflineplus">+</span>
<a href="#l2.172"></a><span id="l2.172" class="difflineplus">+  // Disable bayes filtering on the local account. That's the whole point of this test,</span>
<a href="#l2.173"></a><span id="l2.173" class="difflineplus">+  //  to make sure that the junk move happens anyway.</span>
<a href="#l2.174"></a><span id="l2.174" class="difflineplus">+  gLocalInboxFolder.server.spamSettings.level = 0;</span>
<a href="#l2.175"></a><span id="l2.175" class="difflineplus">+</span>
<a href="#l2.176"></a><span id="l2.176" class="difflineplus">+  // Spam settings needs to know the server to create the junk folder, and move to it</span>
<a href="#l2.177"></a><span id="l2.177" class="difflineplus">+  gLocalInboxFolder.server.spamSettings.actionTargetAccount = gLocalInboxFolder.server.serverURI;</span>
<a href="#l2.178"></a><span id="l2.178" class="difflineplus">+</span>
<a href="#l2.179"></a><span id="l2.179" class="difflineplus">+  do_test_pending();</span>
<a href="#l2.180"></a><span id="l2.180" class="difflineplus">+</span>
<a href="#l2.181"></a><span id="l2.181" class="difflineplus">+  // Add folder listeners that will capture async events</span>
<a href="#l2.182"></a><span id="l2.182" class="difflineplus">+  let flags =</span>
<a href="#l2.183"></a><span id="l2.183" class="difflineplus">+        nsIMFNService.msgsMoveCopyCompleted |</span>
<a href="#l2.184"></a><span id="l2.184" class="difflineplus">+        nsIMFNService.folderAdded;</span>
<a href="#l2.185"></a><span id="l2.185" class="difflineplus">+  let listener = new gMFListener();</span>
<a href="#l2.186"></a><span id="l2.186" class="difflineplus">+  gMFNService.addListener(listener, flags);</span>
<a href="#l2.187"></a><span id="l2.187" class="difflineplus">+</span>
<a href="#l2.188"></a><span id="l2.188" class="difflineplus">+  async_run({func: actually_run_test});</span>
<a href="#l2.189"></a><span id="l2.189" class="difflineplus">+}</span>
<a href="#l2.190"></a><span id="l2.190" class="difflineplus">+</span>
<a href="#l2.191"></a><span id="l2.191" class="difflineplus">+var view_types = [</span>
<a href="#l2.192"></a><span id="l2.192" class="difflineplus">+  [&quot;threaded&quot;, ViewFlags.kThreadedDisplay],</span>
<a href="#l2.193"></a><span id="l2.193" class="difflineplus">+];</span>
<a href="#l2.194"></a><span id="l2.194" class="difflineplus">+</span>
<a href="#l2.195"></a><span id="l2.195" class="difflineplus">+function actually_run_test() {</span>
<a href="#l2.196"></a><span id="l2.196" class="difflineplus">+  yield async_run({func: setup_globals});</span>
<a href="#l2.197"></a><span id="l2.197" class="difflineplus">+  dump(&quot;Num Messages: &quot; + gLocalInboxFolder.msgDatabase.dBFolderInfo.numMessages + &quot;\n&quot;);</span>
<a href="#l2.198"></a><span id="l2.198" class="difflineplus">+</span>
<a href="#l2.199"></a><span id="l2.199" class="difflineplus">+  // for each view type...</span>
<a href="#l2.200"></a><span id="l2.200" class="difflineplus">+  for (let [, view_type_and_flags] in Iterator(view_types)) {</span>
<a href="#l2.201"></a><span id="l2.201" class="difflineplus">+    let [view_type, view_flags] = view_type_and_flags;</span>
<a href="#l2.202"></a><span id="l2.202" class="difflineplus">+</span>
<a href="#l2.203"></a><span id="l2.203" class="difflineplus">+    // ... run each test</span>
<a href="#l2.204"></a><span id="l2.204" class="difflineplus">+    setup_view(view_type, view_flags);</span>
<a href="#l2.205"></a><span id="l2.205" class="difflineplus">+</span>
<a href="#l2.206"></a><span id="l2.206" class="difflineplus">+    for (let [, testFunc] in Iterator(tests_for_all_views)) {</span>
<a href="#l2.207"></a><span id="l2.207" class="difflineplus">+      dump(&quot;=== Running generic test: &quot; + testFunc.name + &quot;\n&quot;);</span>
<a href="#l2.208"></a><span id="l2.208" class="difflineplus">+      yield async_run({func: testFunc});</span>
<a href="#l2.209"></a><span id="l2.209" class="difflineplus">+    }</span>
<a href="#l2.210"></a><span id="l2.210" class="difflineplus">+  }</span>
<a href="#l2.211"></a><span id="l2.211" class="difflineplus">+</span>
<a href="#l2.212"></a><span id="l2.212" class="difflineplus">+  do_test_finished();</span>
<a href="#l2.213"></a><span id="l2.213" class="difflineplus">+}</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

