<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 24971:436e28c477f716f6f30716f16aee3f67584e6b88</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 436e28c477f716f6f30716f16aee3f67584e6b88" />
<meta property="og:url" content="/comm-central/rev/436e28c477f716f6f30716f16aee3f67584e6b88" />
<meta property="og:description" content="Bug 1498041 - Turn on ESLint in mail/base/modules. r=aceman" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 436e28c477f716f6f30716f16aee3f67584e6b88 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/436e28c477f716f6f30716f16aee3f67584e6b88">shortlog</a> |
<a href="/comm-central/log/436e28c477f716f6f30716f16aee3f67584e6b88">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/436e28c477f716f6f30716f16aee3f67584e6b88">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/436e28c477f716f6f30716f16aee3f67584e6b88">files</a> |
changeset |
<a href="/comm-central/raw-rev/436e28c477f716f6f30716f16aee3f67584e6b88">raw</a>  | <a href="/comm-central/archive/436e28c477f716f6f30716f16aee3f67584e6b88.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1498041">Bug 1498041</a> - Turn on ESLint in mail/base/modules. r=aceman
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#71;&#101;&#111;&#102;&#102;&#32;&#76;&#97;&#110;&#107;&#111;&#119;&#32;&#60;&#103;&#101;&#111;&#102;&#102;&#64;&#100;&#97;&#114;&#107;&#116;&#114;&#111;&#106;&#97;&#110;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Mon, 15 Oct 2018 20:47:51 +1300</td></tr>

<tr>
 <td>changeset 24971</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/436e28c477f716f6f30716f16aee3f67584e6b88">436e28c477f716f6f30716f16aee3f67584e6b88</a></td>
</tr>



<tr>
<td>parent 24970</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/6dda9a7770fc8002defb8324162fcbe3c5420c7f">6dda9a7770fc8002defb8324162fcbe3c5420c7f</a>
</td>
</tr>

<tr>
<td>child 24972</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/09c71123e1fac034addde969cbd595fb9435fd4f">09c71123e1fac034addde969cbd595fb9435fd4f</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=436e28c477f716f6f30716f16aee3f67584e6b88">15016</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Wed, 17 Oct 2018 08:32:07 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@436e28c477f7 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=436e28c477f716f6f30716f16aee3f67584e6b88">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=436e28c477f716f6f30716f16aee3f67584e6b88&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=436e28c477f716f6f30716f16aee3f67584e6b88&newProject=comm-central&newRevision=6dda9a7770fc8002defb8324162fcbe3c5420c7f&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=436e28c477f716f6f30716f16aee3f67584e6b88&newProject=comm-central&newRevision=6dda9a7770fc8002defb8324162fcbe3c5420c7f&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=436e28c477f716f6f30716f16aee3f67584e6b88&newProject=comm-central&newRevision=6dda9a7770fc8002defb8324162fcbe3c5420c7f&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28aceman%29&revcount=50">aceman</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1498041">1498041</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1498041">Bug 1498041</a> - Turn on ESLint in mail/base/modules. r=aceman</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/436e28c477f716f6f30716f16aee3f67584e6b88/.eslintignore">.eslintignore</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/436e28c477f716f6f30716f16aee3f67584e6b88/.eslintignore">file</a> |
<a href="/comm-central/annotate/436e28c477f716f6f30716f16aee3f67584e6b88/.eslintignore">annotate</a> |
<a href="/comm-central/diff/436e28c477f716f6f30716f16aee3f67584e6b88/.eslintignore">diff</a> |
<a href="/comm-central/comparison/436e28c477f716f6f30716f16aee3f67584e6b88/.eslintignore">comparison</a> |
<a href="/comm-central/log/436e28c477f716f6f30716f16aee3f67584e6b88/.eslintignore">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/436e28c477f716f6f30716f16aee3f67584e6b88/mail/base/modules/AttachmentChecker.jsm">mail/base/modules/AttachmentChecker.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/436e28c477f716f6f30716f16aee3f67584e6b88/mail/base/modules/AttachmentChecker.jsm">file</a> |
<a href="/comm-central/annotate/436e28c477f716f6f30716f16aee3f67584e6b88/mail/base/modules/AttachmentChecker.jsm">annotate</a> |
<a href="/comm-central/diff/436e28c477f716f6f30716f16aee3f67584e6b88/mail/base/modules/AttachmentChecker.jsm">diff</a> |
<a href="/comm-central/comparison/436e28c477f716f6f30716f16aee3f67584e6b88/mail/base/modules/AttachmentChecker.jsm">comparison</a> |
<a href="/comm-central/log/436e28c477f716f6f30716f16aee3f67584e6b88/mail/base/modules/AttachmentChecker.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/436e28c477f716f6f30716f16aee3f67584e6b88/mail/base/modules/DBViewWrapper.jsm">mail/base/modules/DBViewWrapper.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/436e28c477f716f6f30716f16aee3f67584e6b88/mail/base/modules/DBViewWrapper.jsm">file</a> |
<a href="/comm-central/annotate/436e28c477f716f6f30716f16aee3f67584e6b88/mail/base/modules/DBViewWrapper.jsm">annotate</a> |
<a href="/comm-central/diff/436e28c477f716f6f30716f16aee3f67584e6b88/mail/base/modules/DBViewWrapper.jsm">diff</a> |
<a href="/comm-central/comparison/436e28c477f716f6f30716f16aee3f67584e6b88/mail/base/modules/DBViewWrapper.jsm">comparison</a> |
<a href="/comm-central/log/436e28c477f716f6f30716f16aee3f67584e6b88/mail/base/modules/DBViewWrapper.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/436e28c477f716f6f30716f16aee3f67584e6b88/mail/base/modules/DisplayNameUtils.jsm">mail/base/modules/DisplayNameUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/436e28c477f716f6f30716f16aee3f67584e6b88/mail/base/modules/DisplayNameUtils.jsm">file</a> |
<a href="/comm-central/annotate/436e28c477f716f6f30716f16aee3f67584e6b88/mail/base/modules/DisplayNameUtils.jsm">annotate</a> |
<a href="/comm-central/diff/436e28c477f716f6f30716f16aee3f67584e6b88/mail/base/modules/DisplayNameUtils.jsm">diff</a> |
<a href="/comm-central/comparison/436e28c477f716f6f30716f16aee3f67584e6b88/mail/base/modules/DisplayNameUtils.jsm">comparison</a> |
<a href="/comm-central/log/436e28c477f716f6f30716f16aee3f67584e6b88/mail/base/modules/DisplayNameUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/436e28c477f716f6f30716f16aee3f67584e6b88/mail/base/modules/MailConsts.jsm">mail/base/modules/MailConsts.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/436e28c477f716f6f30716f16aee3f67584e6b88/mail/base/modules/MailConsts.jsm">file</a> |
<a href="/comm-central/annotate/436e28c477f716f6f30716f16aee3f67584e6b88/mail/base/modules/MailConsts.jsm">annotate</a> |
<a href="/comm-central/diff/436e28c477f716f6f30716f16aee3f67584e6b88/mail/base/modules/MailConsts.jsm">diff</a> |
<a href="/comm-central/comparison/436e28c477f716f6f30716f16aee3f67584e6b88/mail/base/modules/MailConsts.jsm">comparison</a> |
<a href="/comm-central/log/436e28c477f716f6f30716f16aee3f67584e6b88/mail/base/modules/MailConsts.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/436e28c477f716f6f30716f16aee3f67584e6b88/mail/base/modules/MailInstrumentation.jsm">mail/base/modules/MailInstrumentation.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/436e28c477f716f6f30716f16aee3f67584e6b88/mail/base/modules/MailInstrumentation.jsm">file</a> |
<a href="/comm-central/annotate/436e28c477f716f6f30716f16aee3f67584e6b88/mail/base/modules/MailInstrumentation.jsm">annotate</a> |
<a href="/comm-central/diff/436e28c477f716f6f30716f16aee3f67584e6b88/mail/base/modules/MailInstrumentation.jsm">diff</a> |
<a href="/comm-central/comparison/436e28c477f716f6f30716f16aee3f67584e6b88/mail/base/modules/MailInstrumentation.jsm">comparison</a> |
<a href="/comm-central/log/436e28c477f716f6f30716f16aee3f67584e6b88/mail/base/modules/MailInstrumentation.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/436e28c477f716f6f30716f16aee3f67584e6b88/mail/base/modules/MailMigrator.jsm">mail/base/modules/MailMigrator.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/436e28c477f716f6f30716f16aee3f67584e6b88/mail/base/modules/MailMigrator.jsm">file</a> |
<a href="/comm-central/annotate/436e28c477f716f6f30716f16aee3f67584e6b88/mail/base/modules/MailMigrator.jsm">annotate</a> |
<a href="/comm-central/diff/436e28c477f716f6f30716f16aee3f67584e6b88/mail/base/modules/MailMigrator.jsm">diff</a> |
<a href="/comm-central/comparison/436e28c477f716f6f30716f16aee3f67584e6b88/mail/base/modules/MailMigrator.jsm">comparison</a> |
<a href="/comm-central/log/436e28c477f716f6f30716f16aee3f67584e6b88/mail/base/modules/MailMigrator.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/436e28c477f716f6f30716f16aee3f67584e6b88/mail/base/modules/MailUtils.jsm">mail/base/modules/MailUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/436e28c477f716f6f30716f16aee3f67584e6b88/mail/base/modules/MailUtils.jsm">file</a> |
<a href="/comm-central/annotate/436e28c477f716f6f30716f16aee3f67584e6b88/mail/base/modules/MailUtils.jsm">annotate</a> |
<a href="/comm-central/diff/436e28c477f716f6f30716f16aee3f67584e6b88/mail/base/modules/MailUtils.jsm">diff</a> |
<a href="/comm-central/comparison/436e28c477f716f6f30716f16aee3f67584e6b88/mail/base/modules/MailUtils.jsm">comparison</a> |
<a href="/comm-central/log/436e28c477f716f6f30716f16aee3f67584e6b88/mail/base/modules/MailUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/436e28c477f716f6f30716f16aee3f67584e6b88/mail/base/modules/MailViewManager.jsm">mail/base/modules/MailViewManager.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/436e28c477f716f6f30716f16aee3f67584e6b88/mail/base/modules/MailViewManager.jsm">file</a> |
<a href="/comm-central/annotate/436e28c477f716f6f30716f16aee3f67584e6b88/mail/base/modules/MailViewManager.jsm">annotate</a> |
<a href="/comm-central/diff/436e28c477f716f6f30716f16aee3f67584e6b88/mail/base/modules/MailViewManager.jsm">diff</a> |
<a href="/comm-central/comparison/436e28c477f716f6f30716f16aee3f67584e6b88/mail/base/modules/MailViewManager.jsm">comparison</a> |
<a href="/comm-central/log/436e28c477f716f6f30716f16aee3f67584e6b88/mail/base/modules/MailViewManager.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/436e28c477f716f6f30716f16aee3f67584e6b88/mail/base/modules/MsgHdrSyntheticView.jsm">mail/base/modules/MsgHdrSyntheticView.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/436e28c477f716f6f30716f16aee3f67584e6b88/mail/base/modules/MsgHdrSyntheticView.jsm">file</a> |
<a href="/comm-central/annotate/436e28c477f716f6f30716f16aee3f67584e6b88/mail/base/modules/MsgHdrSyntheticView.jsm">annotate</a> |
<a href="/comm-central/diff/436e28c477f716f6f30716f16aee3f67584e6b88/mail/base/modules/MsgHdrSyntheticView.jsm">diff</a> |
<a href="/comm-central/comparison/436e28c477f716f6f30716f16aee3f67584e6b88/mail/base/modules/MsgHdrSyntheticView.jsm">comparison</a> |
<a href="/comm-central/log/436e28c477f716f6f30716f16aee3f67584e6b88/mail/base/modules/MsgHdrSyntheticView.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/436e28c477f716f6f30716f16aee3f67584e6b88/mail/base/modules/QuickFilterManager.jsm">mail/base/modules/QuickFilterManager.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/436e28c477f716f6f30716f16aee3f67584e6b88/mail/base/modules/QuickFilterManager.jsm">file</a> |
<a href="/comm-central/annotate/436e28c477f716f6f30716f16aee3f67584e6b88/mail/base/modules/QuickFilterManager.jsm">annotate</a> |
<a href="/comm-central/diff/436e28c477f716f6f30716f16aee3f67584e6b88/mail/base/modules/QuickFilterManager.jsm">diff</a> |
<a href="/comm-central/comparison/436e28c477f716f6f30716f16aee3f67584e6b88/mail/base/modules/QuickFilterManager.jsm">comparison</a> |
<a href="/comm-central/log/436e28c477f716f6f30716f16aee3f67584e6b88/mail/base/modules/QuickFilterManager.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/436e28c477f716f6f30716f16aee3f67584e6b88/mail/base/modules/SearchSpec.jsm">mail/base/modules/SearchSpec.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/436e28c477f716f6f30716f16aee3f67584e6b88/mail/base/modules/SearchSpec.jsm">file</a> |
<a href="/comm-central/annotate/436e28c477f716f6f30716f16aee3f67584e6b88/mail/base/modules/SearchSpec.jsm">annotate</a> |
<a href="/comm-central/diff/436e28c477f716f6f30716f16aee3f67584e6b88/mail/base/modules/SearchSpec.jsm">diff</a> |
<a href="/comm-central/comparison/436e28c477f716f6f30716f16aee3f67584e6b88/mail/base/modules/SearchSpec.jsm">comparison</a> |
<a href="/comm-central/log/436e28c477f716f6f30716f16aee3f67584e6b88/mail/base/modules/SearchSpec.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/436e28c477f716f6f30716f16aee3f67584e6b88/mail/base/modules/SessionStoreManager.jsm">mail/base/modules/SessionStoreManager.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/436e28c477f716f6f30716f16aee3f67584e6b88/mail/base/modules/SessionStoreManager.jsm">file</a> |
<a href="/comm-central/annotate/436e28c477f716f6f30716f16aee3f67584e6b88/mail/base/modules/SessionStoreManager.jsm">annotate</a> |
<a href="/comm-central/diff/436e28c477f716f6f30716f16aee3f67584e6b88/mail/base/modules/SessionStoreManager.jsm">diff</a> |
<a href="/comm-central/comparison/436e28c477f716f6f30716f16aee3f67584e6b88/mail/base/modules/SessionStoreManager.jsm">comparison</a> |
<a href="/comm-central/log/436e28c477f716f6f30716f16aee3f67584e6b88/mail/base/modules/SessionStoreManager.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/436e28c477f716f6f30716f16aee3f67584e6b88/mail/base/modules/SummaryFrameManager.jsm">mail/base/modules/SummaryFrameManager.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/436e28c477f716f6f30716f16aee3f67584e6b88/mail/base/modules/SummaryFrameManager.jsm">file</a> |
<a href="/comm-central/annotate/436e28c477f716f6f30716f16aee3f67584e6b88/mail/base/modules/SummaryFrameManager.jsm">annotate</a> |
<a href="/comm-central/diff/436e28c477f716f6f30716f16aee3f67584e6b88/mail/base/modules/SummaryFrameManager.jsm">diff</a> |
<a href="/comm-central/comparison/436e28c477f716f6f30716f16aee3f67584e6b88/mail/base/modules/SummaryFrameManager.jsm">comparison</a> |
<a href="/comm-central/log/436e28c477f716f6f30716f16aee3f67584e6b88/mail/base/modules/SummaryFrameManager.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/436e28c477f716f6f30716f16aee3f67584e6b88/mail/base/modules/TBDistCustomizer.jsm">mail/base/modules/TBDistCustomizer.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/436e28c477f716f6f30716f16aee3f67584e6b88/mail/base/modules/TBDistCustomizer.jsm">file</a> |
<a href="/comm-central/annotate/436e28c477f716f6f30716f16aee3f67584e6b88/mail/base/modules/TBDistCustomizer.jsm">annotate</a> |
<a href="/comm-central/diff/436e28c477f716f6f30716f16aee3f67584e6b88/mail/base/modules/TBDistCustomizer.jsm">diff</a> |
<a href="/comm-central/comparison/436e28c477f716f6f30716f16aee3f67584e6b88/mail/base/modules/TBDistCustomizer.jsm">comparison</a> |
<a href="/comm-central/log/436e28c477f716f6f30716f16aee3f67584e6b88/mail/base/modules/TBDistCustomizer.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/436e28c477f716f6f30716f16aee3f67584e6b88/mail/base/modules/ThemeVariableMap.jsm">mail/base/modules/ThemeVariableMap.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/436e28c477f716f6f30716f16aee3f67584e6b88/mail/base/modules/ThemeVariableMap.jsm">file</a> |
<a href="/comm-central/annotate/436e28c477f716f6f30716f16aee3f67584e6b88/mail/base/modules/ThemeVariableMap.jsm">annotate</a> |
<a href="/comm-central/diff/436e28c477f716f6f30716f16aee3f67584e6b88/mail/base/modules/ThemeVariableMap.jsm">diff</a> |
<a href="/comm-central/comparison/436e28c477f716f6f30716f16aee3f67584e6b88/mail/base/modules/ThemeVariableMap.jsm">comparison</a> |
<a href="/comm-central/log/436e28c477f716f6f30716f16aee3f67584e6b88/mail/base/modules/ThemeVariableMap.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/436e28c477f716f6f30716f16aee3f67584e6b88/mail/base/modules/Windows8WindowFrameColor.jsm">mail/base/modules/Windows8WindowFrameColor.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/436e28c477f716f6f30716f16aee3f67584e6b88/mail/base/modules/Windows8WindowFrameColor.jsm">file</a> |
<a href="/comm-central/annotate/436e28c477f716f6f30716f16aee3f67584e6b88/mail/base/modules/Windows8WindowFrameColor.jsm">annotate</a> |
<a href="/comm-central/diff/436e28c477f716f6f30716f16aee3f67584e6b88/mail/base/modules/Windows8WindowFrameColor.jsm">diff</a> |
<a href="/comm-central/comparison/436e28c477f716f6f30716f16aee3f67584e6b88/mail/base/modules/Windows8WindowFrameColor.jsm">comparison</a> |
<a href="/comm-central/log/436e28c477f716f6f30716f16aee3f67584e6b88/mail/base/modules/Windows8WindowFrameColor.jsm">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/.eslintignore</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/.eslintignore</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -44,17 +44,18 @@ mailnews/news/*</span>
<a href="#l1.4"></a><span id="l1.4"> mailnews/test/*</span>
<a href="#l1.5"></a><span id="l1.5"> </span>
<a href="#l1.6"></a><span id="l1.6"> # mailnews/extensions exclusions</span>
<a href="#l1.7"></a><span id="l1.7"> mailnews/extensions/*</span>
<a href="#l1.8"></a><span id="l1.8"> !mailnews/extensions/newsblog</span>
<a href="#l1.9"></a><span id="l1.9"> </span>
<a href="#l1.10"></a><span id="l1.10"> # mail exclusions</span>
<a href="#l1.11"></a><span id="l1.11"> mail/app/**</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-mail/base/**</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+mail/base/content/**</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+mail/base/test/**</span>
<a href="#l1.15"></a><span id="l1.15"> mail/branding/**</span>
<a href="#l1.16"></a><span id="l1.16"> mail/config/**</span>
<a href="#l1.17"></a><span id="l1.17"> mail/extensions/**</span>
<a href="#l1.18"></a><span id="l1.18"> mail/installer/**</span>
<a href="#l1.19"></a><span id="l1.19"> mail/locales/**</span>
<a href="#l1.20"></a><span id="l1.20"> mail/test/**</span>
<a href="#l1.21"></a><span id="l1.21"> mail/themes/**</span>
<a href="#l1.22"></a><span id="l1.22"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/base/modules/AttachmentChecker.jsm</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/base/modules/AttachmentChecker.jsm</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -8,95 +8,92 @@ var AttachmentChecker = {</span>
<a href="#l2.4"></a><span id="l2.4">   getAttachmentKeywords,</span>
<a href="#l2.5"></a><span id="l2.5"> };</span>
<a href="#l2.6"></a><span id="l2.6"> </span>
<a href="#l2.7"></a><span id="l2.7"> /**</span>
<a href="#l2.8"></a><span id="l2.8">  * Check whether the character is a CJK character or not.</span>
<a href="#l2.9"></a><span id="l2.9">  *</span>
<a href="#l2.10"></a><span id="l2.10">  * @return true if it is a CJK character.</span>
<a href="#l2.11"></a><span id="l2.11">  */</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-function IsCJK(code)</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-{</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+function IsCJK(code) {</span>
<a href="#l2.15"></a><span id="l2.15">   if (code &gt;= 0x2000 &amp;&amp; code &lt;= 0x9fff) {</span>
<a href="#l2.16"></a><span id="l2.16">     // Hiragana, Katakana and Kanaji</span>
<a href="#l2.17"></a><span id="l2.17">     return true;</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineminus">-  }</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineminus">-  else if (code &gt;= 0xac00 &amp;&amp; code &lt;= 0xd7ff) {</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineplus">+  } else if (code &gt;= 0xac00 &amp;&amp; code &lt;= 0xd7ff) {</span>
<a href="#l2.21"></a><span id="l2.21">     // Hangul</span>
<a href="#l2.22"></a><span id="l2.22">     return true;</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineminus">-  }</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineminus">-  else if (code &gt;= 0xf900 &amp;&amp; code &lt;= 0xffff) {</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineplus">+  } else if (code &gt;= 0xf900 &amp;&amp; code &lt;= 0xffff) {</span>
<a href="#l2.26"></a><span id="l2.26">     // Hiragana, Katakana and Kanaji</span>
<a href="#l2.27"></a><span id="l2.27">     return true;</span>
<a href="#l2.28"></a><span id="l2.28">   }</span>
<a href="#l2.29"></a><span id="l2.29">   return false;</span>
<a href="#l2.30"></a><span id="l2.30"> }</span>
<a href="#l2.31"></a><span id="l2.31"> </span>
<a href="#l2.32"></a><span id="l2.32"> /**</span>
<a href="#l2.33"></a><span id="l2.33">  * Get the (possibly-empty) list of attachment keywords in this message.</span>
<a href="#l2.34"></a><span id="l2.34">  *</span>
<a href="#l2.35"></a><span id="l2.35">  * @return the (possibly-empty) list of attachment keywords in this message</span>
<a href="#l2.36"></a><span id="l2.36">  **/</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineminus">-function getAttachmentKeywords(mailData,keywordsInCsv)</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineminus">-{</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineplus">+function getAttachmentKeywords(mailData, keywordsInCsv) {</span>
<a href="#l2.40"></a><span id="l2.40">   // The empty string would get split to an array of size 1.  Avoid that...</span>
<a href="#l2.41"></a><span id="l2.41">   var keywordsArray = (keywordsInCsv) ? keywordsInCsv.split(&quot;,&quot;) : [];</span>
<a href="#l2.42"></a><span id="l2.42"> </span>
<a href="#l2.43"></a><span id="l2.43" class="difflineminus">-  function escapeRegxpSpecials(inputString)</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineminus">-  {</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineplus">+  function escapeRegxpSpecials(inputString) {</span>
<a href="#l2.46"></a><span id="l2.46">     const specials = [&quot;.&quot;, &quot;\\&quot;, &quot;^&quot;, &quot;$&quot;, &quot;*&quot;, &quot;+&quot;, &quot;?&quot;, &quot;|&quot;,</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineminus">-                      &quot;(&quot;, &quot;)&quot; , &quot;[&quot;, &quot;]&quot;, &quot;{&quot;, &quot;}&quot;];</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineminus">-    var re = new RegExp(&quot;(\\&quot;+specials.join(&quot;|\\&quot;)+&quot;)&quot;, &quot;g&quot;);</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineplus">+                      &quot;(&quot;, &quot;)&quot;, &quot;[&quot;, &quot;]&quot;, &quot;{&quot;, &quot;}&quot;];</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineplus">+    var re = new RegExp(&quot;(\\&quot; + specials.join(&quot;|\\&quot;) + &quot;)&quot;, &quot;g&quot;);</span>
<a href="#l2.51"></a><span id="l2.51">     inputString = inputString.replace(re, &quot;\\$1&quot;);</span>
<a href="#l2.52"></a><span id="l2.52">     return inputString.replace(&quot; &quot;, &quot;\\s+&quot;);</span>
<a href="#l2.53"></a><span id="l2.53">   }</span>
<a href="#l2.54"></a><span id="l2.54"> </span>
<a href="#l2.55"></a><span id="l2.55">   // NOT_W is the character class that isn't in the Unicode classes &quot;Ll&quot;,</span>
<a href="#l2.56"></a><span id="l2.56">   // &quot;Lu&quot; and &quot;Lt&quot;.  It should work like \W, if \W knew about Unicode.</span>
<a href="#l2.57"></a><span id="l2.57">   const NOT_W = &quot;[^\\u0041-\\u005a\\u0061-\\u007a\\u00aa\\u00b5\\u00ba\\u00c0-\\u00d6\\u00d8-\\u00f6\\u00f8-\\u01ba\\u01bc-\\u01bf\\u01c4-\\u02ad\\u0386\\u0388-\\u0481\\u048c-\\u0556\\u0561-\\u0587\\u10a0-\\u10c5\\u1e00-\\u1fbc\\u1fbe\\u1fc2-\\u1fcc\\u1fd0-\\u1fdb\\u1fe0-\\u1fec\\u1ff2-\\u1ffc\\u207f\\u2102\\u2107\\u210a-\\u2113\\u2115\\u2119-\\u211d\\u2124\\u2126\\u2128\\u212a-\\u212d\\u212f-\\u2131\\u2133\\u2134\\u2139\\ufb00-\\ufb17\\uff21-\\uff3a\\uff41-\\uff5a]&quot;;</span>
<a href="#l2.58"></a><span id="l2.58"> </span>
<a href="#l2.59"></a><span id="l2.59">   var keywordsFound = [];</span>
<a href="#l2.60"></a><span id="l2.60">   for (var i = 0; i &lt; keywordsArray.length; i++) {</span>
<a href="#l2.61"></a><span id="l2.61">     var kw = escapeRegxpSpecials(keywordsArray[i]);</span>
<a href="#l2.62"></a><span id="l2.62">     // If the keyword starts (ends) with a CJK character, we don't care</span>
<a href="#l2.63"></a><span id="l2.63">     // what the previous (next) character is, because the words aren't</span>
<a href="#l2.64"></a><span id="l2.64">     // space delimited.</span>
<a href="#l2.65"></a><span id="l2.65">     if (keywordsArray[i].charAt(0) == &quot;.&quot;) { // like .pdf</span>
<a href="#l2.66"></a><span id="l2.66">       // For this case we want to match the whole document name.</span>
<a href="#l2.67"></a><span id="l2.67" class="difflineminus">-      var start = &quot;(([^\\s]*)\\b)&quot;;</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineminus">-      var end = IsCJK(kw.charCodeAt(kw.length - 1)) ? &quot;&quot; : &quot;(\\s|$)&quot;;</span>
<a href="#l2.69"></a><span id="l2.69" class="difflineminus">-      var re = new RegExp(start + kw + end, &quot;ig&quot;);</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineminus">-      var matching = mailData.match(re);</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineplus">+      let start = &quot;(([^\\s]*)\\b)&quot;;</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineplus">+      let end = IsCJK(kw.charCodeAt(kw.length - 1)) ? &quot;&quot; : &quot;(\\s|$)&quot;;</span>
<a href="#l2.73"></a><span id="l2.73" class="difflineplus">+      let re = new RegExp(start + kw + end, &quot;ig&quot;);</span>
<a href="#l2.74"></a><span id="l2.74" class="difflineplus">+      let matching = mailData.match(re);</span>
<a href="#l2.75"></a><span id="l2.75">       if (matching) {</span>
<a href="#l2.76"></a><span id="l2.76">         for (var j = 0; j &lt; matching.length; j++) {</span>
<a href="#l2.77"></a><span id="l2.77">           // Ignore the match if it was in a URL.</span>
<a href="#l2.78"></a><span id="l2.78">           if (!(/^(https?|ftp):\/\//i.test(matching[j]))) {</span>
<a href="#l2.79"></a><span id="l2.79">             // We can have several *different* matches for one dot-keyword.</span>
<a href="#l2.80"></a><span id="l2.80">             // E.g. foo.pdf and bar.pdf would both match for .pdf.</span>
<a href="#l2.81"></a><span id="l2.81">             var m = matching[j].trim();</span>
<a href="#l2.82"></a><span id="l2.82">             if (!keywordsFound.includes(m))</span>
<a href="#l2.83"></a><span id="l2.83">               keywordsFound.push(m);</span>
<a href="#l2.84"></a><span id="l2.84">           }</span>
<a href="#l2.85"></a><span id="l2.85">         }</span>
<a href="#l2.86"></a><span id="l2.86">       }</span>
<a href="#l2.87"></a><span id="l2.87" class="difflineminus">-    }</span>
<a href="#l2.88"></a><span id="l2.88" class="difflineminus">-    else {</span>
<a href="#l2.89"></a><span id="l2.89" class="difflineminus">-      var start = IsCJK(kw.charCodeAt(0)) ? &quot;&quot; : (&quot;((^|\\s)\\S*)&quot;);</span>
<a href="#l2.90"></a><span id="l2.90" class="difflineminus">-      var end = IsCJK(kw.charCodeAt(kw.length - 1)) ? &quot;&quot; : &quot;(&quot; + NOT_W + &quot;|$)&quot;;</span>
<a href="#l2.91"></a><span id="l2.91" class="difflineminus">-      var re = new RegExp(start + kw + end, &quot;ig&quot;);</span>
<a href="#l2.92"></a><span id="l2.92" class="difflineminus">-      var matching;</span>
<a href="#l2.93"></a><span id="l2.93" class="difflineplus">+    } else {</span>
<a href="#l2.94"></a><span id="l2.94" class="difflineplus">+      let start = IsCJK(kw.charCodeAt(0)) ? &quot;&quot; : (&quot;((^|\\s)\\S*)&quot;);</span>
<a href="#l2.95"></a><span id="l2.95" class="difflineplus">+      let end = IsCJK(kw.charCodeAt(kw.length - 1)) ? &quot;&quot; : &quot;(&quot; + NOT_W + &quot;|$)&quot;;</span>
<a href="#l2.96"></a><span id="l2.96" class="difflineplus">+      let re = new RegExp(start + kw + end, &quot;ig&quot;);</span>
<a href="#l2.97"></a><span id="l2.97" class="difflineplus">+      let matching;</span>
<a href="#l2.98"></a><span id="l2.98">       while ((matching = re.exec(mailData)) !== null) {</span>
<a href="#l2.99"></a><span id="l2.99">         // Ignore the match if it was in a URL.</span>
<a href="#l2.100"></a><span id="l2.100">         if (!(/^(https?|ftp):\/\//i.test(matching[0].trim()))) {</span>
<a href="#l2.101"></a><span id="l2.101">           keywordsFound.push(keywordsArray[i]);</span>
<a href="#l2.102"></a><span id="l2.102">           break;</span>
<a href="#l2.103"></a><span id="l2.103">         }</span>
<a href="#l2.104"></a><span id="l2.104">       }</span>
<a href="#l2.105"></a><span id="l2.105">     }</span>
<a href="#l2.106"></a><span id="l2.106">   }</span>
<a href="#l2.107"></a><span id="l2.107">   return keywordsFound;</span>
<a href="#l2.108"></a><span id="l2.108"> }</span>
<a href="#l2.109"></a><span id="l2.109"> </span>
<a href="#l2.110"></a><span id="l2.110" class="difflineplus">+// This file is also used as a Worker.</span>
<a href="#l2.111"></a><span id="l2.111" class="difflineplus">+/* exported onmessage */</span>
<a href="#l2.112"></a><span id="l2.112" class="difflineplus">+/* globals postMessage */</span>
<a href="#l2.113"></a><span id="l2.113"> var onmessage = function(event) {</span>
<a href="#l2.114"></a><span id="l2.114">   var keywordsFound = AttachmentChecker.getAttachmentKeywords(event.data[0], event.data[1]);</span>
<a href="#l2.115"></a><span id="l2.115">   postMessage(keywordsFound);</span>
<a href="#l2.116"></a><span id="l2.116"> };</span>
<a href="#l2.117"></a><span id="l2.117"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/base/modules/DBViewWrapper.jsm</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/base/modules/DBViewWrapper.jsm</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -1,25 +1,23 @@</span>
<a href="#l3.4"></a><span id="l3.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l3.5"></a><span id="l3.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l3.6"></a><span id="l3.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l3.7"></a><span id="l3.7"> </span>
<a href="#l3.8"></a><span id="l3.8" class="difflineminus">-this.EXPORTED_SYMBOLS = ['DBViewWrapper', 'IDBViewWrapperListener'];</span>
<a href="#l3.9"></a><span id="l3.9" class="difflineplus">+this.EXPORTED_SYMBOLS = [&quot;DBViewWrapper&quot;, &quot;IDBViewWrapperListener&quot;];</span>
<a href="#l3.10"></a><span id="l3.10"> </span>
<a href="#l3.11"></a><span id="l3.11"> ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/MailViewManager.jsm&quot;);</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+const {</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+  MailViewConstants,</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+  MailViewManager,</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+} = ChromeUtils.import(&quot;resource:///modules/MailViewManager.jsm&quot;, null);</span>
<a href="#l3.17"></a><span id="l3.17"> ChromeUtils.import(&quot;resource:///modules/SearchSpec.jsm&quot;);</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/virtualFolderWrapper.js&quot;);</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineminus">-</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineminus">-var nsMsgFolderFlags = Ci.nsMsgFolderFlags;</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineminus">-var nsMsgViewType = Ci.nsMsgViewType;</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineminus">-var nsMsgViewFlagsType = Ci.nsMsgViewFlagsType;</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineminus">-var nsMsgViewSortType = Ci.nsMsgViewSortType;</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineminus">-var nsMsgViewSortOrder = Ci.nsMsgViewSortOrder;</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineminus">-var nsMsgMessageFlags = Ci.nsMsgMessageFlags;</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineplus">+const {</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineplus">+  VirtualFolderHelper,</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineplus">+} = ChromeUtils.import(&quot;resource:///modules/virtualFolderWrapper.js&quot;, null);</span>
<a href="#l3.29"></a><span id="l3.29"> </span>
<a href="#l3.30"></a><span id="l3.30"> var MSG_VIEW_FLAG_DUMMY = 0x20000000;</span>
<a href="#l3.31"></a><span id="l3.31"> </span>
<a href="#l3.32"></a><span id="l3.32"> var nsMsgViewIndex_None = 0xffffffff;</span>
<a href="#l3.33"></a><span id="l3.33"> </span>
<a href="#l3.34"></a><span id="l3.34"> /**</span>
<a href="#l3.35"></a><span id="l3.35">  * Helper singleton for DBViewWrapper that tells instances when something</span>
<a href="#l3.36"></a><span id="l3.36">  *  interesting is happening to the folder(s) they care about.  The rationale</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineat">@@ -49,17 +47,17 @@ var FolderNotificationHelper = {</span>
<a href="#l3.38"></a><span id="l3.38">    */</span>
<a href="#l3.39"></a><span id="l3.39">    _curiousWrappers: [],</span>
<a href="#l3.40"></a><span id="l3.40"> </span>
<a href="#l3.41"></a><span id="l3.41">   /**</span>
<a href="#l3.42"></a><span id="l3.42">    * Initialize our listeners.  We currently don't bother cleaning these up</span>
<a href="#l3.43"></a><span id="l3.43">    *  because we are a singleton and if anyone imports us, they probably want</span>
<a href="#l3.44"></a><span id="l3.44">    *  us for as long as their application so shall live.</span>
<a href="#l3.45"></a><span id="l3.45">    */</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineminus">-  _init: function FolderNotificationHelper__init() {</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineplus">+  _init() {</span>
<a href="#l3.48"></a><span id="l3.48">     // register with the session for our folded loaded notifications</span>
<a href="#l3.49"></a><span id="l3.49">     MailServices.mailSession.AddFolderListener(this,</span>
<a href="#l3.50"></a><span id="l3.50">                                                Ci.nsIFolderListener.event |</span>
<a href="#l3.51"></a><span id="l3.51">                                                Ci.nsIFolderListener.intPropertyChanged);</span>
<a href="#l3.52"></a><span id="l3.52"> </span>
<a href="#l3.53"></a><span id="l3.53">     // register with the notification service for deleted folder notifications</span>
<a href="#l3.54"></a><span id="l3.54">     MailServices.mfn.addListener(this,</span>
<a href="#l3.55"></a><span id="l3.55">       Ci.nsIMsgFolderNotificationService.folderDeleted |</span>
<a href="#l3.56"></a><span id="l3.56" class="difflineat">@@ -69,47 +67,42 @@ var FolderNotificationHelper = {</span>
<a href="#l3.57"></a><span id="l3.57">   },</span>
<a href="#l3.58"></a><span id="l3.58"> </span>
<a href="#l3.59"></a><span id="l3.59">   /**</span>
<a href="#l3.60"></a><span id="l3.60">    * Call updateFolder, and assuming all goes well, request that the provided</span>
<a href="#l3.61"></a><span id="l3.61">    *  FolderDisplayWidget be notified when the folder is loaded.  This method</span>
<a href="#l3.62"></a><span id="l3.62">    *  performs the updateFolder call for you so there is less chance of leaking.</span>
<a href="#l3.63"></a><span id="l3.63">    * In the event the updateFolder call fails, we will propagate the exception.</span>
<a href="#l3.64"></a><span id="l3.64">    */</span>
<a href="#l3.65"></a><span id="l3.65" class="difflineminus">-  updateFolderAndNotifyOnLoad:</span>
<a href="#l3.66"></a><span id="l3.66" class="difflineminus">-      function FolderNotificationHelper_notifyOnLoad(aFolder,</span>
<a href="#l3.67"></a><span id="l3.67" class="difflineminus">-                                                     aFolderDisplay,</span>
<a href="#l3.68"></a><span id="l3.68" class="difflineminus">-                                                     aMsgWindow) {</span>
<a href="#l3.69"></a><span id="l3.69" class="difflineplus">+  updateFolderAndNotifyOnLoad(aFolder, aFolderDisplay, aMsgWindow) {</span>
<a href="#l3.70"></a><span id="l3.70">     // set up our datastructure first in case of wacky event sequences</span>
<a href="#l3.71"></a><span id="l3.71">     let folderURI = aFolder.URI;</span>
<a href="#l3.72"></a><span id="l3.72">     let wrappers = this._pendingFolderUriToViewWrapperLists[folderURI];</span>
<a href="#l3.73"></a><span id="l3.73">     if (wrappers == null)</span>
<a href="#l3.74"></a><span id="l3.74">       wrappers = this._pendingFolderUriToViewWrapperLists[folderURI] = [];</span>
<a href="#l3.75"></a><span id="l3.75">     wrappers.push(aFolderDisplay);</span>
<a href="#l3.76"></a><span id="l3.76">     try {</span>
<a href="#l3.77"></a><span id="l3.77">       aFolder.updateFolder(aMsgWindow);</span>
<a href="#l3.78"></a><span id="l3.78" class="difflineminus">-    }</span>
<a href="#l3.79"></a><span id="l3.79" class="difflineminus">-    catch (ex) {</span>
<a href="#l3.80"></a><span id="l3.80" class="difflineplus">+    } catch (ex) {</span>
<a href="#l3.81"></a><span id="l3.81">       // uh-oh, that didn't work.  tear down the data structure...</span>
<a href="#l3.82"></a><span id="l3.82">       wrappers.pop();</span>
<a href="#l3.83"></a><span id="l3.83">       if (wrappers.length == 0)</span>
<a href="#l3.84"></a><span id="l3.84">         delete this._pendingFolderUriToViewWrapperLists[folderURI];</span>
<a href="#l3.85"></a><span id="l3.85">       throw ex;</span>
<a href="#l3.86"></a><span id="l3.86">     }</span>
<a href="#l3.87"></a><span id="l3.87">   },</span>
<a href="#l3.88"></a><span id="l3.88"> </span>
<a href="#l3.89"></a><span id="l3.89">   /**</span>
<a href="#l3.90"></a><span id="l3.90">    * Request notification of every little thing these folders do.</span>
<a href="#l3.91"></a><span id="l3.91">    *</span>
<a href="#l3.92"></a><span id="l3.92">    * @param aFolders The folders.</span>
<a href="#l3.93"></a><span id="l3.93">    * @param aNotherFolder A folder that may or may not be in aFolders.</span>
<a href="#l3.94"></a><span id="l3.94">    * @param aViewWrapper The view wrapper that is up to no good.</span>
<a href="#l3.95"></a><span id="l3.95">    */</span>
<a href="#l3.96"></a><span id="l3.96" class="difflineminus">-  stalkFolders: function FolderNotificationHelper_stalkFolders(</span>
<a href="#l3.97"></a><span id="l3.97" class="difflineminus">-      aFolders, aNotherFolder, aViewWrapper) {</span>
<a href="#l3.98"></a><span id="l3.98" class="difflineplus">+  stalkFolders(aFolders, aNotherFolder, aViewWrapper) {</span>
<a href="#l3.99"></a><span id="l3.99">     let folders = aFolders ? aFolders.concat() : [];</span>
<a href="#l3.100"></a><span id="l3.100">     if (aNotherFolder &amp;&amp; !folders.includes(aNotherFolder))</span>
<a href="#l3.101"></a><span id="l3.101">       folders.push(aNotherFolder);</span>
<a href="#l3.102"></a><span id="l3.102">     for (let folder of folders) {</span>
<a href="#l3.103"></a><span id="l3.103">       let wrappers = this._interestedWrappers[folder.URI];</span>
<a href="#l3.104"></a><span id="l3.104">       if (wrappers == null)</span>
<a href="#l3.105"></a><span id="l3.105">         wrappers = this._interestedWrappers[folder.URI] = [];</span>
<a href="#l3.106"></a><span id="l3.106">       wrappers.push(aViewWrapper);</span>
<a href="#l3.107"></a><span id="l3.107" class="difflineat">@@ -117,43 +110,42 @@ var FolderNotificationHelper = {</span>
<a href="#l3.108"></a><span id="l3.108">   },</span>
<a href="#l3.109"></a><span id="l3.109"> </span>
<a href="#l3.110"></a><span id="l3.110">   /**</span>
<a href="#l3.111"></a><span id="l3.111">    * Request notification of every little thing every folder does.</span>
<a href="#l3.112"></a><span id="l3.112">    *</span>
<a href="#l3.113"></a><span id="l3.113">    * @param aViewWrapper - the viewWrapper interested in every notification.</span>
<a href="#l3.114"></a><span id="l3.114">    *                       This will be a search results view of some sort.</span>
<a href="#l3.115"></a><span id="l3.115">    */</span>
<a href="#l3.116"></a><span id="l3.116" class="difflineminus">-  noteCuriosity: function FolderNotificationHelper_noteCuriosity(aViewWrapper) {</span>
<a href="#l3.117"></a><span id="l3.117" class="difflineplus">+  noteCuriosity(aViewWrapper) {</span>
<a href="#l3.118"></a><span id="l3.118">     this._curiousWrappers.push(aViewWrapper);</span>
<a href="#l3.119"></a><span id="l3.119">   },</span>
<a href="#l3.120"></a><span id="l3.120"> </span>
<a href="#l3.121"></a><span id="l3.121">   /**</span>
<a href="#l3.122"></a><span id="l3.122">    * Removal helper for use by removeNotifications.</span>
<a href="#l3.123"></a><span id="l3.123">    *</span>
<a href="#l3.124"></a><span id="l3.124">    * @param aTable The table mapping URIs to list of view wrappers.</span>
<a href="#l3.125"></a><span id="l3.125">    * @param aFolder The folder we care about.</span>
<a href="#l3.126"></a><span id="l3.126">    * @param aViewWrapper The view wrapper of interest.</span>
<a href="#l3.127"></a><span id="l3.127">    */</span>
<a href="#l3.128"></a><span id="l3.128" class="difflineminus">-  _removeWrapperFromListener: function(aTable, aFolder, aViewWrapper) {</span>
<a href="#l3.129"></a><span id="l3.129" class="difflineplus">+  _removeWrapperFromListener(aTable, aFolder, aViewWrapper) {</span>
<a href="#l3.130"></a><span id="l3.130">     let wrappers = aTable[aFolder.URI];</span>
<a href="#l3.131"></a><span id="l3.131">     if (wrappers) {</span>
<a href="#l3.132"></a><span id="l3.132">       let index = wrappers.indexOf(aViewWrapper);</span>
<a href="#l3.133"></a><span id="l3.133">       if (index &gt;= 0)</span>
<a href="#l3.134"></a><span id="l3.134">       wrappers.splice(index, 1);</span>
<a href="#l3.135"></a><span id="l3.135">       if (wrappers.length == 0)</span>
<a href="#l3.136"></a><span id="l3.136">         delete aTable[aFolder.URI];</span>
<a href="#l3.137"></a><span id="l3.137">     }</span>
<a href="#l3.138"></a><span id="l3.138">   },</span>
<a href="#l3.139"></a><span id="l3.139">   /**</span>
<a href="#l3.140"></a><span id="l3.140">    * Remove notification requests on the provided folders by the given view</span>
<a href="#l3.141"></a><span id="l3.141">    *  wrapper.</span>
<a href="#l3.142"></a><span id="l3.142">    */</span>
<a href="#l3.143"></a><span id="l3.143" class="difflineminus">-  removeNotifications: function FolderNotificationHelper_removeNotifications(</span>
<a href="#l3.144"></a><span id="l3.144" class="difflineminus">-      aFolders, aViewWrapper) {</span>
<a href="#l3.145"></a><span id="l3.145" class="difflineplus">+  removeNotifications(aFolders, aViewWrapper) {</span>
<a href="#l3.146"></a><span id="l3.146">     if (!aFolders) {</span>
<a href="#l3.147"></a><span id="l3.147">       this._curiousWrappers.splice(this._curiousWrappers.indexOf(aViewWrapper), 1);</span>
<a href="#l3.148"></a><span id="l3.148">       return;</span>
<a href="#l3.149"></a><span id="l3.149">     }</span>
<a href="#l3.150"></a><span id="l3.150">     for (let folder of aFolders) {</span>
<a href="#l3.151"></a><span id="l3.151">       this._removeWrapperFromListener(</span>
<a href="#l3.152"></a><span id="l3.152">         this._interestedWrappers, folder, aViewWrapper);</span>
<a href="#l3.153"></a><span id="l3.153">       this._removeWrapperFromListener(</span>
<a href="#l3.154"></a><span id="l3.154" class="difflineat">@@ -161,90 +153,78 @@ var FolderNotificationHelper = {</span>
<a href="#l3.155"></a><span id="l3.155">     }</span>
<a href="#l3.156"></a><span id="l3.156">   },</span>
<a href="#l3.157"></a><span id="l3.157"> </span>
<a href="#l3.158"></a><span id="l3.158">   /**</span>
<a href="#l3.159"></a><span id="l3.159">    * @return true if there are any listeners still registered.  This is intended</span>
<a href="#l3.160"></a><span id="l3.160">    *     to support debugging code.  If you are not debug code, you are a bad</span>
<a href="#l3.161"></a><span id="l3.161">    *     person/code.</span>
<a href="#l3.162"></a><span id="l3.162">    */</span>
<a href="#l3.163"></a><span id="l3.163" class="difflineminus">-  haveListeners: function FolderNotificationHelper_haveListeners() {</span>
<a href="#l3.164"></a><span id="l3.164" class="difflineminus">-    for (let folderURI in this._pendingFolderUriToViewWrapperLists) {</span>
<a href="#l3.165"></a><span id="l3.165" class="difflineminus">-      let wrappers = this._pendingFolderUriToViewWrapperLists[folderURI];</span>
<a href="#l3.166"></a><span id="l3.166" class="difflineplus">+  haveListeners() {</span>
<a href="#l3.167"></a><span id="l3.167" class="difflineplus">+    if (Object.keys(this._pendingFolderUriToViewWrapperLists).length &gt; 0)</span>
<a href="#l3.168"></a><span id="l3.168">       return true;</span>
<a href="#l3.169"></a><span id="l3.169" class="difflineminus">-    }</span>
<a href="#l3.170"></a><span id="l3.170" class="difflineminus">-    for (let folderURI in this._interestedWrappers) {</span>
<a href="#l3.171"></a><span id="l3.171" class="difflineminus">-      let wrappers = this._interestedWrappers[folderURI];</span>
<a href="#l3.172"></a><span id="l3.172" class="difflineplus">+    if (Object.keys(this._interestedWrappers).length &gt; 0)</span>
<a href="#l3.173"></a><span id="l3.173">       return true;</span>
<a href="#l3.174"></a><span id="l3.174" class="difflineminus">-    }</span>
<a href="#l3.175"></a><span id="l3.175">     return this._curiousWrappers.length != 0;</span>
<a href="#l3.176"></a><span id="l3.176">   },</span>
<a href="#l3.177"></a><span id="l3.177"> </span>
<a href="#l3.178"></a><span id="l3.178">   /* ***** Notifications ***** */</span>
<a href="#l3.179"></a><span id="l3.179" class="difflineminus">-  _notifyHelper: function FolderNotificationHelper__notifyHelper(aFolder,</span>
<a href="#l3.180"></a><span id="l3.180" class="difflineminus">-                                                                 aHandlerName) {</span>
<a href="#l3.181"></a><span id="l3.181" class="difflineplus">+  _notifyHelper(aFolder, aHandlerName) {</span>
<a href="#l3.182"></a><span id="l3.182">     let wrappers = this._interestedWrappers[aFolder.URI];</span>
<a href="#l3.183"></a><span id="l3.183">     if (wrappers) {</span>
<a href="#l3.184"></a><span id="l3.184">       // clone the list to avoid confusing mutation by listeners</span>
<a href="#l3.185"></a><span id="l3.185">       for (let wrapper of wrappers.concat()) {</span>
<a href="#l3.186"></a><span id="l3.186">         wrapper[aHandlerName](aFolder);</span>
<a href="#l3.187"></a><span id="l3.187">       }</span>
<a href="#l3.188"></a><span id="l3.188">     }</span>
<a href="#l3.189"></a><span id="l3.189">     for (let wrapper of this._curiousWrappers)</span>
<a href="#l3.190"></a><span id="l3.190">       wrapper[aHandlerName](aFolder);</span>
<a href="#l3.191"></a><span id="l3.191">   },</span>
<a href="#l3.192"></a><span id="l3.192"> </span>
<a href="#l3.193"></a><span id="l3.193" class="difflineminus">-  OnItemEvent: function FolderNotificationHelper_OnItemEvent(</span>
<a href="#l3.194"></a><span id="l3.194" class="difflineminus">-      aFolder, aEvent) {</span>
<a href="#l3.195"></a><span id="l3.195" class="difflineplus">+  OnItemEvent(aFolder, aEvent) {</span>
<a href="#l3.196"></a><span id="l3.196">     if (aEvent == &quot;FolderLoaded&quot;) {</span>
<a href="#l3.197"></a><span id="l3.197">       let folderURI = aFolder.URI;</span>
<a href="#l3.198"></a><span id="l3.198">       let widgets = this._pendingFolderUriToViewWrapperLists[folderURI];</span>
<a href="#l3.199"></a><span id="l3.199">       if (widgets) {</span>
<a href="#l3.200"></a><span id="l3.200">         for (let widget of widgets) {</span>
<a href="#l3.201"></a><span id="l3.201">           // we are friends, this is an explicit relationship.</span>
<a href="#l3.202"></a><span id="l3.202">           // (we don't use a generic callback mechanism because the 'this' stuff</span>
<a href="#l3.203"></a><span id="l3.203">           //  gets ugly and no one else should be hooking in at this level.)</span>
<a href="#l3.204"></a><span id="l3.204">           try {</span>
<a href="#l3.205"></a><span id="l3.205">             widget._folderLoaded(aFolder);</span>
<a href="#l3.206"></a><span id="l3.206" class="difflineminus">-          }</span>
<a href="#l3.207"></a><span id="l3.207" class="difflineminus">-          catch (ex) {</span>
<a href="#l3.208"></a><span id="l3.208" class="difflineplus">+          } catch (ex) {</span>
<a href="#l3.209"></a><span id="l3.209">             dump(&quot;``` EXCEPTION DURING NOTIFY: &quot; + ex.fileName + &quot;:&quot; +</span>
<a href="#l3.210"></a><span id="l3.210">                  ex.lineNumber + &quot;: &quot; + ex + &quot;\n&quot;);</span>
<a href="#l3.211"></a><span id="l3.211">             if (ex.stack)</span>
<a href="#l3.212"></a><span id="l3.212">               dump(&quot;STACK: &quot; + ex.stack + &quot;\n&quot;);</span>
<a href="#l3.213"></a><span id="l3.213">             Cu.reportError(ex);</span>
<a href="#l3.214"></a><span id="l3.214">           }</span>
<a href="#l3.215"></a><span id="l3.215">         }</span>
<a href="#l3.216"></a><span id="l3.216">         delete this._pendingFolderUriToViewWrapperLists[folderURI];</span>
<a href="#l3.217"></a><span id="l3.217">       }</span>
<a href="#l3.218"></a><span id="l3.218" class="difflineminus">-    }</span>
<a href="#l3.219"></a><span id="l3.219" class="difflineminus">-    else if (aEvent == &quot;AboutToCompact&quot;) {</span>
<a href="#l3.220"></a><span id="l3.220" class="difflineplus">+    } else if (aEvent == &quot;AboutToCompact&quot;) {</span>
<a href="#l3.221"></a><span id="l3.221">       this._notifyHelper(aFolder, &quot;_aboutToCompactFolder&quot;);</span>
<a href="#l3.222"></a><span id="l3.222" class="difflineminus">-    }</span>
<a href="#l3.223"></a><span id="l3.223" class="difflineminus">-    else if (aEvent == &quot;CompactCompleted&quot;) {</span>
<a href="#l3.224"></a><span id="l3.224" class="difflineplus">+    } else if (aEvent == &quot;CompactCompleted&quot;) {</span>
<a href="#l3.225"></a><span id="l3.225">       this._notifyHelper(aFolder, &quot;_compactedFolder&quot;);</span>
<a href="#l3.226"></a><span id="l3.226" class="difflineminus">-    }</span>
<a href="#l3.227"></a><span id="l3.227" class="difflineminus">-    else if (aEvent == &quot;DeleteOrMoveMsgCompleted&quot;) {</span>
<a href="#l3.228"></a><span id="l3.228" class="difflineplus">+    } else if (aEvent == &quot;DeleteOrMoveMsgCompleted&quot;) {</span>
<a href="#l3.229"></a><span id="l3.229">       this._notifyHelper(aFolder, &quot;_deleteCompleted&quot;);</span>
<a href="#l3.230"></a><span id="l3.230" class="difflineminus">-    }</span>
<a href="#l3.231"></a><span id="l3.231" class="difflineminus">-    else if (aEvent == &quot;DeleteOrMoveMsgFailed&quot;) {</span>
<a href="#l3.232"></a><span id="l3.232" class="difflineplus">+    } else if (aEvent == &quot;DeleteOrMoveMsgFailed&quot;) {</span>
<a href="#l3.233"></a><span id="l3.233">       this._notifyHelper(aFolder, &quot;_deleteFailed&quot;);</span>
<a href="#l3.234"></a><span id="l3.234" class="difflineminus">-    }</span>
<a href="#l3.235"></a><span id="l3.235" class="difflineminus">-    else if (aEvent == &quot;RenameCompleted&quot;) {</span>
<a href="#l3.236"></a><span id="l3.236" class="difflineplus">+    } else if (aEvent == &quot;RenameCompleted&quot;) {</span>
<a href="#l3.237"></a><span id="l3.237">       this._notifyHelper(aFolder, &quot;_renameCompleted&quot;);</span>
<a href="#l3.238"></a><span id="l3.238">     }</span>
<a href="#l3.239"></a><span id="l3.239">   },</span>
<a href="#l3.240"></a><span id="l3.240"> </span>
<a href="#l3.241"></a><span id="l3.241" class="difflineminus">-  OnItemIntPropertyChanged: function(aFolder, aProperty, aOldValue, aNewValue) {</span>
<a href="#l3.242"></a><span id="l3.242" class="difflineplus">+  OnItemIntPropertyChanged(aFolder, aProperty, aOldValue, aNewValue) {</span>
<a href="#l3.243"></a><span id="l3.243">     if ((aProperty == &quot;TotalMessages&quot;) ||</span>
<a href="#l3.244"></a><span id="l3.244">         (aProperty == &quot;TotalUnreadMessages&quot;))</span>
<a href="#l3.245"></a><span id="l3.245">       this._notifyHelper(aFolder, &quot;_messageCountsChanged&quot;);</span>
<a href="#l3.246"></a><span id="l3.246">   },</span>
<a href="#l3.247"></a><span id="l3.247"> </span>
<a href="#l3.248"></a><span id="l3.248" class="difflineminus">-  _folderMoveHelper: function(aOldFolder, aNewFolder) {</span>
<a href="#l3.249"></a><span id="l3.249" class="difflineplus">+  _folderMoveHelper(aOldFolder, aNewFolder) {</span>
<a href="#l3.250"></a><span id="l3.250">     let oldURI = aOldFolder.URI;</span>
<a href="#l3.251"></a><span id="l3.251">     let newURI = aNewFolder.URI;</span>
<a href="#l3.252"></a><span id="l3.252">     // fix up our listener tables.</span>
<a href="#l3.253"></a><span id="l3.253">     if (oldURI in this._pendingFolderUriToViewWrapperLists) {</span>
<a href="#l3.254"></a><span id="l3.254">       this._pendingFolderUriToViewWrapperLists[newURI] =</span>
<a href="#l3.255"></a><span id="l3.255">         this._pendingFolderUriToViewWrapperLists[oldURI];</span>
<a href="#l3.256"></a><span id="l3.256">       delete this._pendingFolderUriToViewWrapperLists[oldURI];</span>
<a href="#l3.257"></a><span id="l3.257">     }</span>
<a href="#l3.258"></a><span id="l3.258" class="difflineat">@@ -261,32 +241,28 @@ var FolderNotificationHelper = {</span>
<a href="#l3.259"></a><span id="l3.259">         wrapper._folderMoved(aOldFolder, aNewFolder);</span>
<a href="#l3.260"></a><span id="l3.260">       }</span>
<a href="#l3.261"></a><span id="l3.261">     }</span>
<a href="#l3.262"></a><span id="l3.262">   },</span>
<a href="#l3.263"></a><span id="l3.263"> </span>
<a href="#l3.264"></a><span id="l3.264">   /**</span>
<a href="#l3.265"></a><span id="l3.265">    * Update our URI mapping tables when renames happen.</span>
<a href="#l3.266"></a><span id="l3.266">    */</span>
<a href="#l3.267"></a><span id="l3.267" class="difflineminus">-  folderRenamed: function FolderNotificationHelper_folderRenamed(aOrigFolder,</span>
<a href="#l3.268"></a><span id="l3.268" class="difflineminus">-                                                                 aNewFolder) {</span>
<a href="#l3.269"></a><span id="l3.269" class="difflineplus">+  folderRenamed(aOrigFolder, aNewFolder) {</span>
<a href="#l3.270"></a><span id="l3.270">     this._folderMoveHelper(aOrigFolder, aNewFolder);</span>
<a href="#l3.271"></a><span id="l3.271">   },</span>
<a href="#l3.272"></a><span id="l3.272"> </span>
<a href="#l3.273"></a><span id="l3.273" class="difflineminus">-  folderMoveCopyCompleted:</span>
<a href="#l3.274"></a><span id="l3.274" class="difflineminus">-      function FolderNotificationHelper_folderMoveCopyCompleted(aMove,</span>
<a href="#l3.275"></a><span id="l3.275" class="difflineminus">-                                                                aSrcFolder,</span>
<a href="#l3.276"></a><span id="l3.276" class="difflineminus">-                                                                aDestFolder) {</span>
<a href="#l3.277"></a><span id="l3.277" class="difflineplus">+  folderMoveCopyCompleted(aMove, aSrcFolder, aDestFolder) {</span>
<a href="#l3.278"></a><span id="l3.278">      if (aMove) {</span>
<a href="#l3.279"></a><span id="l3.279">        let aNewFolder = aDestFolder.getChildNamed(aSrcFolder.prettyName);</span>
<a href="#l3.280"></a><span id="l3.280">        this._folderMoveHelper(aSrcFolder, aNewFolder);</span>
<a href="#l3.281"></a><span id="l3.281">      }</span>
<a href="#l3.282"></a><span id="l3.282">   },</span>
<a href="#l3.283"></a><span id="l3.283"> </span>
<a href="#l3.284"></a><span id="l3.284" class="difflineminus">-  folderDeleted: function FolderNotificationHelper_folderDeleted(aFolder) {</span>
<a href="#l3.285"></a><span id="l3.285" class="difflineplus">+  folderDeleted(aFolder) {</span>
<a href="#l3.286"></a><span id="l3.286">     let wrappers = this._interestedWrappers[aFolder.URI];</span>
<a href="#l3.287"></a><span id="l3.287">     if (wrappers) {</span>
<a href="#l3.288"></a><span id="l3.288">       // clone the list to avoid confusing mutation by listeners</span>
<a href="#l3.289"></a><span id="l3.289">       for (let wrapper of wrappers.concat()) {</span>
<a href="#l3.290"></a><span id="l3.290">         wrapper._folderDeleted(aFolder);</span>
<a href="#l3.291"></a><span id="l3.291">       }</span>
<a href="#l3.292"></a><span id="l3.292">       // if the folder is deleted, it's not going to ever do anything again</span>
<a href="#l3.293"></a><span id="l3.293">       delete this._interestedWrappers[aFolder.URI];</span>
<a href="#l3.294"></a><span id="l3.294" class="difflineat">@@ -340,142 +316,140 @@ IDBViewWrapperListener.prototype = {</span>
<a href="#l3.295"></a><span id="l3.295">    * For the record, this functionality should not remotely be in the core.</span>
<a href="#l3.296"></a><span id="l3.296">    *</span>
<a href="#l3.297"></a><span id="l3.297">    * @param aMsgFolder The folder we are leaving and are unsure if we should</span>
<a href="#l3.298"></a><span id="l3.298">    *     mark all its messages read.  I pass the folder instead of the server</span>
<a href="#l3.299"></a><span id="l3.299">    *     type because having a crazy feature like this will inevitably lead to</span>
<a href="#l3.300"></a><span id="l3.300">    *     a more full-featured crazy feature (why not on a per-folder basis, eh?)</span>
<a href="#l3.301"></a><span id="l3.301">    * @return true if we should mark all the dudes as read, false if not.</span>
<a href="#l3.302"></a><span id="l3.302">    */</span>
<a href="#l3.303"></a><span id="l3.303" class="difflineminus">-  shouldMarkMessagesReadOnLeavingFolder: function (aMsgFolder) {</span>
<a href="#l3.304"></a><span id="l3.304" class="difflineplus">+  shouldMarkMessagesReadOnLeavingFolder(aMsgFolder) {</span>
<a href="#l3.305"></a><span id="l3.305">     return false;</span>
<a href="#l3.306"></a><span id="l3.306">   },</span>
<a href="#l3.307"></a><span id="l3.307"> </span>
<a href="#l3.308"></a><span id="l3.308">   /* ===== Event Notifications ===== */</span>
<a href="#l3.309"></a><span id="l3.309">   /* === Status Changes === */</span>
<a href="#l3.310"></a><span id="l3.310">   /**</span>
<a href="#l3.311"></a><span id="l3.311">    * We tell you when we start and stop loading the folder.  This is a good</span>
<a href="#l3.312"></a><span id="l3.312">    *  time to mess with the hour-glass cursor machinery if you are inclined to</span>
<a href="#l3.313"></a><span id="l3.313">    *  do so.</span>
<a href="#l3.314"></a><span id="l3.314">    */</span>
<a href="#l3.315"></a><span id="l3.315" class="difflineminus">-  onFolderLoading: function (aIsFolderLoading) {</span>
<a href="#l3.316"></a><span id="l3.316" class="difflineminus">-</span>
<a href="#l3.317"></a><span id="l3.317" class="difflineplus">+  onFolderLoading(aIsFolderLoading) {</span>
<a href="#l3.318"></a><span id="l3.318">   },</span>
<a href="#l3.319"></a><span id="l3.319"> </span>
<a href="#l3.320"></a><span id="l3.320">   /**</span>
<a href="#l3.321"></a><span id="l3.321">    * We tell you when we start and stop searching.  This is a good time to mess</span>
<a href="#l3.322"></a><span id="l3.322">    *  with progress spinners (meteors) and the like, if you are so inclined.</span>
<a href="#l3.323"></a><span id="l3.323">    */</span>
<a href="#l3.324"></a><span id="l3.324" class="difflineminus">-  onSearching: function (aIsSearching) {</span>
<a href="#l3.325"></a><span id="l3.325" class="difflineminus">-</span>
<a href="#l3.326"></a><span id="l3.326" class="difflineplus">+  onSearching(aIsSearching) {</span>
<a href="#l3.327"></a><span id="l3.327">   },</span>
<a href="#l3.328"></a><span id="l3.328"> </span>
<a href="#l3.329"></a><span id="l3.329">   /**</span>
<a href="#l3.330"></a><span id="l3.330">    * This event is generated when a new view has been created.  It is intended</span>
<a href="#l3.331"></a><span id="l3.331">    *  to be used to provide the MsgCreateDBView notification so that custom</span>
<a href="#l3.332"></a><span id="l3.332">    *  columns can add themselves to the view.</span>
<a href="#l3.333"></a><span id="l3.333">    * The notification is not generated by the DBViewWrapper itself because this</span>
<a href="#l3.334"></a><span id="l3.334">    *  is fundamentally a UI issue.  Additionally, because the MsgCreateDBView</span>
<a href="#l3.335"></a><span id="l3.335">    *  notification consumers assume gDBView whose exposure is affected by tabs,</span>
<a href="#l3.336"></a><span id="l3.336">    *  the tab logic needs to be involved.</span>
<a href="#l3.337"></a><span id="l3.337">    */</span>
<a href="#l3.338"></a><span id="l3.338" class="difflineminus">-  onCreatedView: function() {</span>
<a href="#l3.339"></a><span id="l3.339" class="difflineplus">+  onCreatedView() {</span>
<a href="#l3.340"></a><span id="l3.340">   },</span>
<a href="#l3.341"></a><span id="l3.341"> </span>
<a href="#l3.342"></a><span id="l3.342">   /**</span>
<a href="#l3.343"></a><span id="l3.343">    * This event is generated just before we close/destroy a message view.</span>
<a href="#l3.344"></a><span id="l3.344">    *</span>
<a href="#l3.345"></a><span id="l3.345">    * @param aFolderIsComingBack Indicates whether we are planning to create a</span>
<a href="#l3.346"></a><span id="l3.346">    *     new view to display the same folder after we destroy this view.  This</span>
<a href="#l3.347"></a><span id="l3.347">    *     will be the case unless we are switching to display a new folder or</span>
<a href="#l3.348"></a><span id="l3.348">    *     closing the view wrapper entirely.</span>
<a href="#l3.349"></a><span id="l3.349">    */</span>
<a href="#l3.350"></a><span id="l3.350" class="difflineminus">-  onDestroyingView: function(aFolderIsComingBack) {</span>
<a href="#l3.351"></a><span id="l3.351" class="difflineplus">+  onDestroyingView(aFolderIsComingBack) {</span>
<a href="#l3.352"></a><span id="l3.352">   },</span>
<a href="#l3.353"></a><span id="l3.353"> </span>
<a href="#l3.354"></a><span id="l3.354">   /**</span>
<a href="#l3.355"></a><span id="l3.355">    * Generated when we are loading information about the folder from its</span>
<a href="#l3.356"></a><span id="l3.356">    *  dbFolderInfo.  The dbFolderInfo object is passed in.</span>
<a href="#l3.357"></a><span id="l3.357">    * The DBViewWrapper has already restored its state when this function is</span>
<a href="#l3.358"></a><span id="l3.358">    *  called, but has not yet created the dbView.  A view update is in process,</span>
<a href="#l3.359"></a><span id="l3.359">    *  so the view settings can be changed and will take effect when the update</span>
<a href="#l3.360"></a><span id="l3.360">    *  is closed.</span>
<a href="#l3.361"></a><span id="l3.361">    * |onDisplayingFolder| is the next expected notification following this</span>
<a href="#l3.362"></a><span id="l3.362">    *  notification.</span>
<a href="#l3.363"></a><span id="l3.363">    */</span>
<a href="#l3.364"></a><span id="l3.364" class="difflineminus">-  onLoadingFolder: function(aDbFolderInfo) {</span>
<a href="#l3.365"></a><span id="l3.365" class="difflineplus">+  onLoadingFolder(aDbFolderInfo) {</span>
<a href="#l3.366"></a><span id="l3.366">   },</span>
<a href="#l3.367"></a><span id="l3.367"> </span>
<a href="#l3.368"></a><span id="l3.368">   /**</span>
<a href="#l3.369"></a><span id="l3.369">    * Generated when the folder is being entered for display.  This is the chance</span>
<a href="#l3.370"></a><span id="l3.370">    *  for the listener to affect any UI-related changes to the folder required.</span>
<a href="#l3.371"></a><span id="l3.371">    *  Currently, this just means setting the header cache size (which needs to</span>
<a href="#l3.372"></a><span id="l3.372">    *  be proportional to the number of lines in the tree view, and is thus a</span>
<a href="#l3.373"></a><span id="l3.373">    *  UI issue.)</span>
<a href="#l3.374"></a><span id="l3.374">    * The dbView has already been created and is valid when this function is</span>
<a href="#l3.375"></a><span id="l3.375">    *  called.</span>
<a href="#l3.376"></a><span id="l3.376">    * |onLoadingFolder| is called before this notification.</span>
<a href="#l3.377"></a><span id="l3.377">    */</span>
<a href="#l3.378"></a><span id="l3.378" class="difflineminus">-  onDisplayingFolder: function() {</span>
<a href="#l3.379"></a><span id="l3.379" class="difflineplus">+  onDisplayingFolder() {</span>
<a href="#l3.380"></a><span id="l3.380">   },</span>
<a href="#l3.381"></a><span id="l3.381"> </span>
<a href="#l3.382"></a><span id="l3.382">   /**</span>
<a href="#l3.383"></a><span id="l3.383">    * Generated when we are leaving a folder.</span>
<a href="#l3.384"></a><span id="l3.384">    */</span>
<a href="#l3.385"></a><span id="l3.385" class="difflineminus">-  onLeavingFolder: function() {</span>
<a href="#l3.386"></a><span id="l3.386" class="difflineplus">+  onLeavingFolder() {</span>
<a href="#l3.387"></a><span id="l3.387">   },</span>
<a href="#l3.388"></a><span id="l3.388"> </span>
<a href="#l3.389"></a><span id="l3.389">   /**</span>
<a href="#l3.390"></a><span id="l3.390">    * Things to do once all the messages that should show up in a folder have</span>
<a href="#l3.391"></a><span id="l3.391">    *  shown up.  For a real folder, this happens when the folder is entered.</span>
<a href="#l3.392"></a><span id="l3.392">    *  For a (multi-folder) virtual folder, this happens when the search</span>
<a href="#l3.393"></a><span id="l3.393">    *  completes.</span>
<a href="#l3.394"></a><span id="l3.394">    * You may get onMessagesLoaded called with aAll false immediately after</span>
<a href="#l3.395"></a><span id="l3.395">    * the view is opened. You will definitely get onMessagesLoaded(true)</span>
<a href="#l3.396"></a><span id="l3.396">    * when we've finished getting the headers for the view.</span>
<a href="#l3.397"></a><span id="l3.397">    */</span>
<a href="#l3.398"></a><span id="l3.398" class="difflineminus">-  onMessagesLoaded: function(aAll) {</span>
<a href="#l3.399"></a><span id="l3.399" class="difflineplus">+  onMessagesLoaded(aAll) {</span>
<a href="#l3.400"></a><span id="l3.400">   },</span>
<a href="#l3.401"></a><span id="l3.401"> </span>
<a href="#l3.402"></a><span id="l3.402">   /**</span>
<a href="#l3.403"></a><span id="l3.403">    * The mail view changed.  The mail view widget is likely to care about this.</span>
<a href="#l3.404"></a><span id="l3.404">    */</span>
<a href="#l3.405"></a><span id="l3.405" class="difflineminus">-  onMailViewChanged: function() {</span>
<a href="#l3.406"></a><span id="l3.406" class="difflineplus">+  onMailViewChanged() {</span>
<a href="#l3.407"></a><span id="l3.407">   },</span>
<a href="#l3.408"></a><span id="l3.408"> </span>
<a href="#l3.409"></a><span id="l3.409">   /**</span>
<a href="#l3.410"></a><span id="l3.410">    * The active sort changed, and that is all that changed.  If the sort is</span>
<a href="#l3.411"></a><span id="l3.411">    *  changing because the view is being destroyed and re-created, this event</span>
<a href="#l3.412"></a><span id="l3.412">    *  will not be generated.</span>
<a href="#l3.413"></a><span id="l3.413">    */</span>
<a href="#l3.414"></a><span id="l3.414" class="difflineminus">-  onSortChanged: function() {</span>
<a href="#l3.415"></a><span id="l3.415" class="difflineplus">+  onSortChanged() {</span>
<a href="#l3.416"></a><span id="l3.416">   },</span>
<a href="#l3.417"></a><span id="l3.417"> </span>
<a href="#l3.418"></a><span id="l3.418">   /**</span>
<a href="#l3.419"></a><span id="l3.419">    * This event is generated when messages in one of the folders backing the</span>
<a href="#l3.420"></a><span id="l3.420">    *  view have been removed by message moves / deletion.  If there is a search</span>
<a href="#l3.421"></a><span id="l3.421">    *  in effect, it is possible that the removed messages were not visible in</span>
<a href="#l3.422"></a><span id="l3.422">    *  the view in the first place.</span>
<a href="#l3.423"></a><span id="l3.423">    */</span>
<a href="#l3.424"></a><span id="l3.424" class="difflineminus">-  onMessagesRemoved: function () {</span>
<a href="#l3.425"></a><span id="l3.425" class="difflineplus">+  onMessagesRemoved() {</span>
<a href="#l3.426"></a><span id="l3.426">   },</span>
<a href="#l3.427"></a><span id="l3.427"> </span>
<a href="#l3.428"></a><span id="l3.428">   /**</span>
<a href="#l3.429"></a><span id="l3.429">    * Like onMessagesRemoved, but something went awry in the move/deletion and</span>
<a href="#l3.430"></a><span id="l3.430">    *  it failed.  Although this is not a very interesting event on its own,</span>
<a href="#l3.431"></a><span id="l3.431">    *  it is useful in cases where the listener was expecting an</span>
<a href="#l3.432"></a><span id="l3.432">    *  onMessagesRemoved and might need to clean some state up.</span>
<a href="#l3.433"></a><span id="l3.433">    */</span>
<a href="#l3.434"></a><span id="l3.434" class="difflineminus">-  onMessageRemovalFailed: function () {</span>
<a href="#l3.435"></a><span id="l3.435" class="difflineplus">+  onMessageRemovalFailed() {</span>
<a href="#l3.436"></a><span id="l3.436">   },</span>
<a href="#l3.437"></a><span id="l3.437"> </span>
<a href="#l3.438"></a><span id="l3.438">   /**</span>
<a href="#l3.439"></a><span id="l3.439">    * The total message count or total unread message counts changed.</span>
<a href="#l3.440"></a><span id="l3.440">    */</span>
<a href="#l3.441"></a><span id="l3.441" class="difflineminus">-  onMessageCountsChanged: function () {</span>
<a href="#l3.442"></a><span id="l3.442" class="difflineplus">+  onMessageCountsChanged() {</span>
<a href="#l3.443"></a><span id="l3.443">   },</span>
<a href="#l3.444"></a><span id="l3.444"> };</span>
<a href="#l3.445"></a><span id="l3.445"> </span>
<a href="#l3.446"></a><span id="l3.446"> /**</span>
<a href="#l3.447"></a><span id="l3.447">  * Encapsulates everything related to working with our nsIMsgDBView</span>
<a href="#l3.448"></a><span id="l3.448">  *  implementations.</span>
<a href="#l3.449"></a><span id="l3.449">  *</span>
<a href="#l3.450"></a><span id="l3.450">  * Things we do not do and why we do not do them:</span>
<a href="#l3.451"></a><span id="l3.451" class="difflineat">@@ -502,17 +476,17 @@ function DBViewWrapper(aListener) {</span>
<a href="#l3.452"></a><span id="l3.452">   // see the _viewFlags getter and setter for info on our use of __viewFlags.</span>
<a href="#l3.453"></a><span id="l3.453">   this.__viewFlags = null;</span>
<a href="#l3.454"></a><span id="l3.454"> </span>
<a href="#l3.455"></a><span id="l3.455">   /**</span>
<a href="#l3.456"></a><span id="l3.456">    * It's possible to support grouped view thread expand/collapse, and also sort</span>
<a href="#l3.457"></a><span id="l3.457">    * by thread despite the back end (see nsMsgQuickSearchDBView::SortThreads).</span>
<a href="#l3.458"></a><span id="l3.458">    * Also, nsMsgQuickSearchDBView does not respect the kExpandAll flag, fix that.</span>
<a href="#l3.459"></a><span id="l3.459">    */</span>
<a href="#l3.460"></a><span id="l3.460" class="difflineminus">-  this._threadExpandAll = true,</span>
<a href="#l3.461"></a><span id="l3.461" class="difflineplus">+  this._threadExpandAll = true;</span>
<a href="#l3.462"></a><span id="l3.462"> </span>
<a href="#l3.463"></a><span id="l3.463">   this.dbView = null;</span>
<a href="#l3.464"></a><span id="l3.464">   this.search = null;</span>
<a href="#l3.465"></a><span id="l3.465"> </span>
<a href="#l3.466"></a><span id="l3.466">   this._folderLoading = false;</span>
<a href="#l3.467"></a><span id="l3.467">   this._searching = false;</span>
<a href="#l3.468"></a><span id="l3.468"> }</span>
<a href="#l3.469"></a><span id="l3.469"> DBViewWrapper.prototype = {</span>
<a href="#l3.470"></a><span id="l3.470" class="difflineat">@@ -573,31 +547,31 @@ DBViewWrapper.prototype = {</span>
<a href="#l3.471"></a><span id="l3.471">   /**</span>
<a href="#l3.472"></a><span id="l3.472">    * Check if the folder in question backs the currently displayed folder.  For</span>
<a href="#l3.473"></a><span id="l3.473">    *  a virtual folder, this is a test of whether the virtual folder includes</span>
<a href="#l3.474"></a><span id="l3.474">    *  messages from the given folder.  For a 'real' single folder, this is</span>
<a href="#l3.475"></a><span id="l3.475">    *  effectively a test against displayedFolder.</span>
<a href="#l3.476"></a><span id="l3.476">    * If you want to see if the displayed folder is a folder, just compare</span>
<a href="#l3.477"></a><span id="l3.477">    *  against the displayedFolder attribute.</span>
<a href="#l3.478"></a><span id="l3.478">    */</span>
<a href="#l3.479"></a><span id="l3.479" class="difflineminus">-  isUnderlyingFolder: function DBViewWrapper_isUnderlyingFolder(aFolder) {</span>
<a href="#l3.480"></a><span id="l3.480" class="difflineplus">+  isUnderlyingFolder(aFolder) {</span>
<a href="#l3.481"></a><span id="l3.481">     return this._underlyingFolders.some(underlyingFolder =&gt; aFolder == underlyingFolder);</span>
<a href="#l3.482"></a><span id="l3.482">   },</span>
<a href="#l3.483"></a><span id="l3.483"> </span>
<a href="#l3.484"></a><span id="l3.484">   /**</span>
<a href="#l3.485"></a><span id="l3.485">    * Refresh the view by re-creating the view.  You would do this to get rid of</span>
<a href="#l3.486"></a><span id="l3.486">    *  messages that no longer match the view but are kept around for view</span>
<a href="#l3.487"></a><span id="l3.487">    *  stability reasons.  (In other words, in an unread-messages view, you would</span>
<a href="#l3.488"></a><span id="l3.488">    *  go insane if when you clicked on a message it immediately disappeared</span>
<a href="#l3.489"></a><span id="l3.489">    *  because it no longer matched.)</span>
<a href="#l3.490"></a><span id="l3.490">    * This method was adding for testing purposes and does not have a (legacy) UI</span>
<a href="#l3.491"></a><span id="l3.491">    *  reason for existing.  (The 'open' method is intended to behave identically</span>
<a href="#l3.492"></a><span id="l3.492">    *  to the legacy UI if you click on the currently displayed folder.)</span>
<a href="#l3.493"></a><span id="l3.493">    */</span>
<a href="#l3.494"></a><span id="l3.494" class="difflineminus">-  refresh: function DBViewWrapper_refresh() {</span>
<a href="#l3.495"></a><span id="l3.495" class="difflineplus">+  refresh() {</span>
<a href="#l3.496"></a><span id="l3.496">     this._applyViewChanges();</span>
<a href="#l3.497"></a><span id="l3.497">   },</span>
<a href="#l3.498"></a><span id="l3.498"> </span>
<a href="#l3.499"></a><span id="l3.499">   /**</span>
<a href="#l3.500"></a><span id="l3.500">    * Null out the folder's database to avoid memory bloat if we don't have a</span>
<a href="#l3.501"></a><span id="l3.501">    *  reason to keep the database around.  Currently, we keep all Inboxes</span>
<a href="#l3.502"></a><span id="l3.502">    *  around and null out everyone else.  This is a standard stopgap measure</span>
<a href="#l3.503"></a><span id="l3.503">    *  until we have something more clever going on.</span>
<a href="#l3.504"></a><span id="l3.504" class="difflineat">@@ -610,27 +584,27 @@ DBViewWrapper.prototype = {</span>
<a href="#l3.505"></a><span id="l3.505">    *</span>
<a href="#l3.506"></a><span id="l3.506">    * Another heuristic we could theoretically use is use the mail session's</span>
<a href="#l3.507"></a><span id="l3.507">    *  isFolderOpenInWindow call, except that uses the outmoded concept that each</span>
<a href="#l3.508"></a><span id="l3.508">    *  window will have at most one folder open.  So nuts to that.</span>
<a href="#l3.509"></a><span id="l3.509">    *</span>
<a href="#l3.510"></a><span id="l3.510">    * Note: regrettably a unit test cannot verify that we did this; msgDatabase</span>
<a href="#l3.511"></a><span id="l3.511">    *  is a getter that will always try and load the message database!</span>
<a href="#l3.512"></a><span id="l3.512">    */</span>
<a href="#l3.513"></a><span id="l3.513" class="difflineminus">-  _releaseFolderDatabase: function DBViewWrapper__nullFolderDatabase(aFolder) {</span>
<a href="#l3.514"></a><span id="l3.514" class="difflineminus">-    if (!aFolder.isSpecialFolder(nsMsgFolderFlags.Inbox, false))</span>
<a href="#l3.515"></a><span id="l3.515" class="difflineplus">+  _releaseFolderDatabase(aFolder) {</span>
<a href="#l3.516"></a><span id="l3.516" class="difflineplus">+    if (!aFolder.isSpecialFolder(Ci.nsMsgFolderFlags.Inbox, false))</span>
<a href="#l3.517"></a><span id="l3.517">       aFolder.msgDatabase = null;</span>
<a href="#l3.518"></a><span id="l3.518">   },</span>
<a href="#l3.519"></a><span id="l3.519"> </span>
<a href="#l3.520"></a><span id="l3.520">   /**</span>
<a href="#l3.521"></a><span id="l3.521">    * Clone this DBViewWrapper and its underlying nsIMsgDBView.</span>
<a href="#l3.522"></a><span id="l3.522">    *</span>
<a href="#l3.523"></a><span id="l3.523">    * @param aListener {IDBViewWrapperListener} The listener to use on the new view.</span>
<a href="#l3.524"></a><span id="l3.524">    */</span>
<a href="#l3.525"></a><span id="l3.525" class="difflineminus">-  clone: function DBViewWrapper_clone(aListener) {</span>
<a href="#l3.526"></a><span id="l3.526" class="difflineplus">+  clone(aListener) {</span>
<a href="#l3.527"></a><span id="l3.527">     let doppel = new DBViewWrapper(aListener);</span>
<a href="#l3.528"></a><span id="l3.528"> </span>
<a href="#l3.529"></a><span id="l3.529">     // -- copy attributes</span>
<a href="#l3.530"></a><span id="l3.530">     doppel.displayedFolder = this.displayedFolder;</span>
<a href="#l3.531"></a><span id="l3.531">     doppel._underlyingData = this._underlyingData;</span>
<a href="#l3.532"></a><span id="l3.532">     doppel._underlyingFolders = this._underlyingFolders ?</span>
<a href="#l3.533"></a><span id="l3.533">                                   this._underlyingFolders.concat() : null;</span>
<a href="#l3.534"></a><span id="l3.534">     doppel._syntheticView = this._syntheticView;</span>
<a href="#l3.535"></a><span id="l3.535" class="difflineat">@@ -674,17 +648,17 @@ DBViewWrapper.prototype = {</span>
<a href="#l3.536"></a><span id="l3.536">    *  the resources associated with this view wrapper.  You would not do this</span>
<a href="#l3.537"></a><span id="l3.537">    *  for UI reasons like the user de-selecting the node in the tree; we should</span>
<a href="#l3.538"></a><span id="l3.538">    *  always be displaying something when used in a UI context!</span>
<a href="#l3.539"></a><span id="l3.539">    *</span>
<a href="#l3.540"></a><span id="l3.540">    * @param aFolderIsDead If true, tells us not to try and tidy up on our way</span>
<a href="#l3.541"></a><span id="l3.541">    *     out by virtue of the fact that the folder is dead and should not be</span>
<a href="#l3.542"></a><span id="l3.542">    *     messed with.</span>
<a href="#l3.543"></a><span id="l3.543">    */</span>
<a href="#l3.544"></a><span id="l3.544" class="difflineminus">-  close: function DBViewWrapper_close(aFolderIsDead) {</span>
<a href="#l3.545"></a><span id="l3.545" class="difflineplus">+  close(aFolderIsDead) {</span>
<a href="#l3.546"></a><span id="l3.546">     if (this.displayedFolder != null) {</span>
<a href="#l3.547"></a><span id="l3.547">       // onLeavingFolder does all the application-level stuff related to leaving</span>
<a href="#l3.548"></a><span id="l3.548">       //  the folder (marking as read, etc.)  We only do this when the folder</span>
<a href="#l3.549"></a><span id="l3.549">       //  is not dead (for obvious reasons).</span>
<a href="#l3.550"></a><span id="l3.550">       if (!aFolderIsDead) {</span>
<a href="#l3.551"></a><span id="l3.551">         // onLeavingFolder must be called before we potentially null out its</span>
<a href="#l3.552"></a><span id="l3.552">         //  msgDatabase, which we will do in the upcoming underlyingFolders loop</span>
<a href="#l3.553"></a><span id="l3.553">         this.onLeavingFolder(); // application logic</span>
<a href="#l3.554"></a><span id="l3.554" class="difflineat">@@ -740,17 +714,17 @@ DBViewWrapper.prototype = {</span>
<a href="#l3.555"></a><span id="l3.555"> </span>
<a href="#l3.556"></a><span id="l3.556">     this.search = null;</span>
<a href="#l3.557"></a><span id="l3.557">   },</span>
<a href="#l3.558"></a><span id="l3.558"> </span>
<a href="#l3.559"></a><span id="l3.559">   /**</span>
<a href="#l3.560"></a><span id="l3.560">    * Open the passed-in nsIMsgFolder folder.  Use openSynthetic for synthetic</span>
<a href="#l3.561"></a><span id="l3.561">    *  view providers.</span>
<a href="#l3.562"></a><span id="l3.562">    */</span>
<a href="#l3.563"></a><span id="l3.563" class="difflineminus">-  open: function DBViewWrapper_open(aFolder) {</span>
<a href="#l3.564"></a><span id="l3.564" class="difflineplus">+  open(aFolder) {</span>
<a href="#l3.565"></a><span id="l3.565">     if (aFolder == null) {</span>
<a href="#l3.566"></a><span id="l3.566">       this.close();</span>
<a href="#l3.567"></a><span id="l3.567">       return;</span>
<a href="#l3.568"></a><span id="l3.568">     }</span>
<a href="#l3.569"></a><span id="l3.569"> </span>
<a href="#l3.570"></a><span id="l3.570">     // If we are in the same folder, there is nothing to do unless we are a</span>
<a href="#l3.571"></a><span id="l3.571">     //  virtual folder.  Virtual folders apparently want to try and get updated.</span>
<a href="#l3.572"></a><span id="l3.572">     if (this.displayedFolder == aFolder) {</span>
<a href="#l3.573"></a><span id="l3.573" class="difflineat">@@ -794,17 +768,17 @@ DBViewWrapper.prototype = {</span>
<a href="#l3.574"></a><span id="l3.574">     //  is already outstanding.</span>
<a href="#l3.575"></a><span id="l3.575">     if (this.shouldShowMessagesForFolderImmediately())</span>
<a href="#l3.576"></a><span id="l3.576">       this._enterFolder();</span>
<a href="#l3.577"></a><span id="l3.577">   },</span>
<a href="#l3.578"></a><span id="l3.578"> </span>
<a href="#l3.579"></a><span id="l3.579">   /**</span>
<a href="#l3.580"></a><span id="l3.580">    * Open a synthetic view provider as backing our view.</span>
<a href="#l3.581"></a><span id="l3.581">    */</span>
<a href="#l3.582"></a><span id="l3.582" class="difflineminus">-  openSynthetic: function DBViewWrapper_openSynthetic(aSyntheticView) {</span>
<a href="#l3.583"></a><span id="l3.583" class="difflineplus">+  openSynthetic(aSyntheticView) {</span>
<a href="#l3.584"></a><span id="l3.584">     this.close();</span>
<a href="#l3.585"></a><span id="l3.585"> </span>
<a href="#l3.586"></a><span id="l3.586">     this._underlyingData = this.kUnderlyingSynthetic;</span>
<a href="#l3.587"></a><span id="l3.587">     this._syntheticView = aSyntheticView;</span>
<a href="#l3.588"></a><span id="l3.588"> </span>
<a href="#l3.589"></a><span id="l3.589">     this.search = new SearchSpec(this);</span>
<a href="#l3.590"></a><span id="l3.590">     this._sort = this._syntheticView.defaultSort.concat();</span>
<a href="#l3.591"></a><span id="l3.591"> </span>
<a href="#l3.592"></a><span id="l3.592" class="difflineat">@@ -815,35 +789,35 @@ DBViewWrapper.prototype = {</span>
<a href="#l3.593"></a><span id="l3.593"> </span>
<a href="#l3.594"></a><span id="l3.594">   /**</span>
<a href="#l3.595"></a><span id="l3.595">    * Makes us irrevocavbly be a search view, for use in search windows.</span>
<a href="#l3.596"></a><span id="l3.596">    *  Once you call this, you are not allowed to use us for anything</span>
<a href="#l3.597"></a><span id="l3.597">    *  but a search view!</span>
<a href="#l3.598"></a><span id="l3.598">    * We add a 'searchFolders' property that allows you to control what</span>
<a href="#l3.599"></a><span id="l3.599">    *  folders we are searching over.</span>
<a href="#l3.600"></a><span id="l3.600">    */</span>
<a href="#l3.601"></a><span id="l3.601" class="difflineminus">-  openSearchView: function DBViewWrapper_openSearchView() {</span>
<a href="#l3.602"></a><span id="l3.602" class="difflineplus">+  openSearchView() {</span>
<a href="#l3.603"></a><span id="l3.603">     this.close();</span>
<a href="#l3.604"></a><span id="l3.604"> </span>
<a href="#l3.605"></a><span id="l3.605">     this._underlyingData = this.kUnderlyingSearchView;</span>
<a href="#l3.606"></a><span id="l3.606">     this._underlyingFolders = [];</span>
<a href="#l3.607"></a><span id="l3.607"> </span>
<a href="#l3.608"></a><span id="l3.608">     let dis = this;</span>
<a href="#l3.609"></a><span id="l3.609" class="difflineminus">-    this.__defineGetter__('searchFolders', function() {</span>
<a href="#l3.610"></a><span id="l3.610" class="difflineplus">+    this.__defineGetter__(&quot;searchFolders&quot;, function() {</span>
<a href="#l3.611"></a><span id="l3.611">                             return dis._underlyingFolders;</span>
<a href="#l3.612"></a><span id="l3.612">                           });</span>
<a href="#l3.613"></a><span id="l3.613" class="difflineminus">-    this.__defineSetter__('searchFolders', function(aSearchFolders) {</span>
<a href="#l3.614"></a><span id="l3.614" class="difflineplus">+    this.__defineSetter__(&quot;searchFolders&quot;, function(aSearchFolders) {</span>
<a href="#l3.615"></a><span id="l3.615">                             dis._underlyingFolders = aSearchFolders;</span>
<a href="#l3.616"></a><span id="l3.616">                             dis._applyViewChanges();</span>
<a href="#l3.617"></a><span id="l3.617">                           });</span>
<a href="#l3.618"></a><span id="l3.618"> </span>
<a href="#l3.619"></a><span id="l3.619">     this.search = new SearchSpec(this);</span>
<a href="#l3.620"></a><span id="l3.620">     // the search view uses the order in which messages are added as the</span>
<a href="#l3.621"></a><span id="l3.621">     //  order by default.</span>
<a href="#l3.622"></a><span id="l3.622" class="difflineminus">-    this._sort = [[nsMsgViewSortType.byNone, nsMsgViewSortOrder.ascending]];</span>
<a href="#l3.623"></a><span id="l3.623" class="difflineplus">+    this._sort = [[Ci.nsMsgViewSortType.byNone, Ci.nsMsgViewSortOrder.ascending]];</span>
<a href="#l3.624"></a><span id="l3.624"> </span>
<a href="#l3.625"></a><span id="l3.625">     FolderNotificationHelper.noteCuriosity(this);</span>
<a href="#l3.626"></a><span id="l3.626">     this._applyViewChanges();</span>
<a href="#l3.627"></a><span id="l3.627">   },</span>
<a href="#l3.628"></a><span id="l3.628"> </span>
<a href="#l3.629"></a><span id="l3.629">   get folderLoading() {</span>
<a href="#l3.630"></a><span id="l3.630">     return this._folderLoading;</span>
<a href="#l3.631"></a><span id="l3.631">   },</span>
<a href="#l3.632"></a><span id="l3.632" class="difflineat">@@ -888,77 +862,74 @@ DBViewWrapper.prototype = {</span>
<a href="#l3.633"></a><span id="l3.633">    *   there is an obvious hole in this logic because of the virtual folder case</span>
<a href="#l3.634"></a><span id="l3.634">    *   above.</span>
<a href="#l3.635"></a><span id="l3.635">    *</span>
<a href="#l3.636"></a><span id="l3.636">    * @pre this.folderDisplayed is the folder we are talking about.</span>
<a href="#l3.637"></a><span id="l3.637">    *</span>
<a href="#l3.638"></a><span id="l3.638">    * @return true if the folder should be shown immediately, false if we should</span>
<a href="#l3.639"></a><span id="l3.639">    *     wait for updateFolder to complete.</span>
<a href="#l3.640"></a><span id="l3.640">    */</span>
<a href="#l3.641"></a><span id="l3.641" class="difflineminus">-  shouldShowMessagesForFolderImmediately:</span>
<a href="#l3.642"></a><span id="l3.642" class="difflineminus">-      function DBViewWrapper_showShowMessagesForFolderImmediately() {</span>
<a href="#l3.643"></a><span id="l3.643" class="difflineplus">+  shouldShowMessagesForFolderImmediately() {</span>
<a href="#l3.644"></a><span id="l3.644">     return (this.isVirtual ||</span>
<a href="#l3.645"></a><span id="l3.645">             !(this._underlyingFolders == null ||</span>
<a href="#l3.646"></a><span id="l3.646">               this.listener.shouldDeferMessageDisplayUntilAfterServerConnect));</span>
<a href="#l3.647"></a><span id="l3.647">   },</span>
<a href="#l3.648"></a><span id="l3.648">   /**</span>
<a href="#l3.649"></a><span id="l3.649">    * Extract information about the view from the dbFolderInfo (e.g., sort type,</span>
<a href="#l3.650"></a><span id="l3.650">    * sort order, current view flags, etc), and save in the view wrapper.</span>
<a href="#l3.651"></a><span id="l3.651">    */</span>
<a href="#l3.652"></a><span id="l3.652" class="difflineminus">-  _prepareToLoadView:</span>
<a href="#l3.653"></a><span id="l3.653" class="difflineminus">-      function DBViewWrapper_prepareToLoadView(msgDatabase, aFolder) {</span>
<a href="#l3.654"></a><span id="l3.654" class="difflineplus">+  _prepareToLoadView(msgDatabase, aFolder) {</span>
<a href="#l3.655"></a><span id="l3.655">     let dbFolderInfo = msgDatabase.dBFolderInfo;</span>
<a href="#l3.656"></a><span id="l3.656">     // - retrieve persisted sort information</span>
<a href="#l3.657"></a><span id="l3.657">     this._sort = [[dbFolderInfo.sortType, dbFolderInfo.sortOrder]];</span>
<a href="#l3.658"></a><span id="l3.658"> </span>
<a href="#l3.659"></a><span id="l3.659">     // - retrieve persisted display settings</span>
<a href="#l3.660"></a><span id="l3.660">     this.__viewFlags = dbFolderInfo.viewFlags;</span>
<a href="#l3.661"></a><span id="l3.661">     // - retrieve persisted thread last expanded state.</span>
<a href="#l3.662"></a><span id="l3.662" class="difflineminus">-    this._threadExpandAll = Boolean(this.__viewFlags &amp; nsMsgViewFlagsType.kExpandAll);</span>
<a href="#l3.663"></a><span id="l3.663" class="difflineplus">+    this._threadExpandAll = Boolean(this.__viewFlags &amp; Ci.nsMsgViewFlagsType.kExpandAll);</span>
<a href="#l3.664"></a><span id="l3.664"> </span>
<a href="#l3.665"></a><span id="l3.665">     // Make sure the threaded bit is set if group-by-sort is set.  The views</span>
<a href="#l3.666"></a><span id="l3.666">     //  encode 3 states in 2-bits, and we want to avoid that odd-man-out</span>
<a href="#l3.667"></a><span id="l3.667">     //  state.</span>
<a href="#l3.668"></a><span id="l3.668">     // The expand flag must be set when opening a single virtual folder</span>
<a href="#l3.669"></a><span id="l3.669">     //  (quicksearch) in grouped view. The user's last set expand/collapse state</span>
<a href="#l3.670"></a><span id="l3.670">     //  for grouped/threaded in this use case is restored later.</span>
<a href="#l3.671"></a><span id="l3.671" class="difflineminus">-    if (this.__viewFlags &amp; nsMsgViewFlagsType.kGroupBySort) {</span>
<a href="#l3.672"></a><span id="l3.672" class="difflineminus">-      this.__viewFlags |= nsMsgViewFlagsType.kThreadedDisplay;</span>
<a href="#l3.673"></a><span id="l3.673" class="difflineminus">-      this.__viewFlags |= nsMsgViewFlagsType.kExpandAll;</span>
<a href="#l3.674"></a><span id="l3.674" class="difflineplus">+    if (this.__viewFlags &amp; Ci.nsMsgViewFlagsType.kGroupBySort) {</span>
<a href="#l3.675"></a><span id="l3.675" class="difflineplus">+      this.__viewFlags |= Ci.nsMsgViewFlagsType.kThreadedDisplay;</span>
<a href="#l3.676"></a><span id="l3.676" class="difflineplus">+      this.__viewFlags |= Ci.nsMsgViewFlagsType.kExpandAll;</span>
<a href="#l3.677"></a><span id="l3.677">       this._ensureValidSort();</span>
<a href="#l3.678"></a><span id="l3.678">     }</span>
<a href="#l3.679"></a><span id="l3.679"> </span>
<a href="#l3.680"></a><span id="l3.680">     // See if the last-used view was one of the special views.  If so, put us in</span>
<a href="#l3.681"></a><span id="l3.681">     //  that special view mode.  We intentionally do this after restoring the</span>
<a href="#l3.682"></a><span id="l3.682">     //  view flags because _setSpecialView enforces threading.</span>
<a href="#l3.683"></a><span id="l3.683">     // The nsMsgDBView is the one who persists this information for us.  In this</span>
<a href="#l3.684"></a><span id="l3.684">     //  case the nsMsgThreadedDBView superclass of the special views triggers it</span>
<a href="#l3.685"></a><span id="l3.685">     //  when opened.</span>
<a href="#l3.686"></a><span id="l3.686">     let viewType = dbFolderInfo.viewType;</span>
<a href="#l3.687"></a><span id="l3.687" class="difflineminus">-    if ((viewType == nsMsgViewType.eShowThreadsWithUnread) ||</span>
<a href="#l3.688"></a><span id="l3.688" class="difflineminus">-        (viewType == nsMsgViewType.eShowWatchedThreadsWithUnread))</span>
<a href="#l3.689"></a><span id="l3.689" class="difflineplus">+    if ((viewType == Ci.nsMsgViewType.eShowThreadsWithUnread) ||</span>
<a href="#l3.690"></a><span id="l3.690" class="difflineplus">+        (viewType == Ci.nsMsgViewType.eShowWatchedThreadsWithUnread))</span>
<a href="#l3.691"></a><span id="l3.691">       this._setSpecialView(viewType);</span>
<a href="#l3.692"></a><span id="l3.692"> </span>
<a href="#l3.693"></a><span id="l3.693">     // - retrieve virtual folder configuration</span>
<a href="#l3.694"></a><span id="l3.694" class="difflineminus">-    if (aFolder.flags &amp; nsMsgFolderFlags.Virtual) {</span>
<a href="#l3.695"></a><span id="l3.695" class="difflineplus">+    if (aFolder.flags &amp; Ci.nsMsgFolderFlags.Virtual) {</span>
<a href="#l3.696"></a><span id="l3.696">       let virtFolder = VirtualFolderHelper.wrapVirtualFolder(aFolder);</span>
<a href="#l3.697"></a><span id="l3.697">       // Filter out the server roots; they only exist for UI reasons.</span>
<a href="#l3.698"></a><span id="l3.698">       this._underlyingFolders =</span>
<a href="#l3.699"></a><span id="l3.699">         virtFolder.searchFolders.filter(folder =&gt; !folder.isServer);</span>
<a href="#l3.700"></a><span id="l3.700">       this._underlyingData = (this._underlyingFolders.length &gt; 1) ?</span>
<a href="#l3.701"></a><span id="l3.701">                              this.kUnderlyingMultipleFolder :</span>
<a href="#l3.702"></a><span id="l3.702">                              this.kUnderlyingRealFolder;</span>
<a href="#l3.703"></a><span id="l3.703"> </span>
<a href="#l3.704"></a><span id="l3.704">       // figure out if we are using online IMAP searching</span>
<a href="#l3.705"></a><span id="l3.705">       this.search.onlineSearch = virtFolder.onlineSearch;</span>
<a href="#l3.706"></a><span id="l3.706"> </span>
<a href="#l3.707"></a><span id="l3.707">       // retrieve and chew the search query</span>
<a href="#l3.708"></a><span id="l3.708">       this.search.virtualFolderTerms = virtFolder.searchTerms;</span>
<a href="#l3.709"></a><span id="l3.709" class="difflineminus">-    }</span>
<a href="#l3.710"></a><span id="l3.710" class="difflineminus">-    else {</span>
<a href="#l3.711"></a><span id="l3.711" class="difflineplus">+    } else {</span>
<a href="#l3.712"></a><span id="l3.712">       this._underlyingData = this.kUnderlyingRealFolder;</span>
<a href="#l3.713"></a><span id="l3.713">       this._underlyingFolders = [this.displayedFolder];</span>
<a href="#l3.714"></a><span id="l3.714">     }</span>
<a href="#l3.715"></a><span id="l3.715"> </span>
<a href="#l3.716"></a><span id="l3.716">     FolderNotificationHelper.stalkFolders(this._underlyingFolders,</span>
<a href="#l3.717"></a><span id="l3.717">                                           this.displayedFolder,</span>
<a href="#l3.718"></a><span id="l3.718">                                           this);</span>
<a href="#l3.719"></a><span id="l3.719"> </span>
<a href="#l3.720"></a><span id="l3.720" class="difflineat">@@ -971,45 +942,44 @@ DBViewWrapper.prototype = {</span>
<a href="#l3.721"></a><span id="l3.721">       // &quot;0&quot; and &quot;1&quot; are all and unread views, respectively, from 2.0</span>
<a href="#l3.722"></a><span id="l3.722">       if (mailViewTag &amp;&amp; mailViewTag != &quot;0&quot; &amp;&amp; mailViewTag != &quot;1&quot;) {</span>
<a href="#l3.723"></a><span id="l3.723">         // the tag gets stored with a &quot;:&quot; on the front, presumably done</span>
<a href="#l3.724"></a><span id="l3.724">         //  as a means of name-spacing that was never subsequently leveraged.</span>
<a href="#l3.725"></a><span id="l3.725">         if (mailViewTag.startsWith(&quot;:&quot;))</span>
<a href="#l3.726"></a><span id="l3.726">           mailViewTag = mailViewTag.substr(1);</span>
<a href="#l3.727"></a><span id="l3.727">         // (the true is so we don't persist)</span>
<a href="#l3.728"></a><span id="l3.728">         this.setMailView(MailViewConstants.kViewItemTags, mailViewTag, true);</span>
<a href="#l3.729"></a><span id="l3.729" class="difflineminus">-      }</span>
<a href="#l3.730"></a><span id="l3.730" class="difflineminus">-      // otherwise it's just an index. we kinda-sorta migrate from old-school</span>
<a href="#l3.731"></a><span id="l3.731" class="difflineminus">-      //  $label tags, except someone reused one of the indices for</span>
<a href="#l3.732"></a><span id="l3.732" class="difflineminus">-      //  kViewItemNotDeleted, which means that $label2 can no longer be</span>
<a href="#l3.733"></a><span id="l3.733" class="difflineminus">-      //  migrated.</span>
<a href="#l3.734"></a><span id="l3.734" class="difflineminus">-      else {</span>
<a href="#l3.735"></a><span id="l3.735" class="difflineplus">+      } else {</span>
<a href="#l3.736"></a><span id="l3.736" class="difflineplus">+        // otherwise it's just an index. we kinda-sorta migrate from old-school</span>
<a href="#l3.737"></a><span id="l3.737" class="difflineplus">+        //  $label tags, except someone reused one of the indices for</span>
<a href="#l3.738"></a><span id="l3.738" class="difflineplus">+        //  kViewItemNotDeleted, which means that $label2 can no longer be</span>
<a href="#l3.739"></a><span id="l3.739" class="difflineplus">+        //  migrated.</span>
<a href="#l3.740"></a><span id="l3.740">         let mailViewIndex = dbFolderInfo.getUint32Property(</span>
<a href="#l3.741"></a><span id="l3.741">                               MailViewConstants.kViewCurrent,</span>
<a href="#l3.742"></a><span id="l3.742">                               MailViewConstants.kViewItemAll);</span>
<a href="#l3.743"></a><span id="l3.743">         // label migration per above</span>
<a href="#l3.744"></a><span id="l3.744">         if ((mailViewIndex == MailViewConstants.kViewItemTags) ||</span>
<a href="#l3.745"></a><span id="l3.745">             ((MailViewConstants.kViewItemTags + 2 &lt;= mailViewIndex) &amp;&amp;</span>
<a href="#l3.746"></a><span id="l3.746">              (mailViewIndex &lt; MailViewConstants.kViewItemVirtual)))</span>
<a href="#l3.747"></a><span id="l3.747">           this.setMailView(MailViewConstants.kViewItemTags,</span>
<a href="#l3.748"></a><span id="l3.748" class="difflineminus">-                           &quot;$label&quot; + (mailViewIndex-1));</span>
<a href="#l3.749"></a><span id="l3.749" class="difflineplus">+                           &quot;$label&quot; + (mailViewIndex - 1));</span>
<a href="#l3.750"></a><span id="l3.750">         else</span>
<a href="#l3.751"></a><span id="l3.751">           this.setMailView(mailViewIndex);</span>
<a href="#l3.752"></a><span id="l3.752">       }</span>
<a href="#l3.753"></a><span id="l3.753">     }</span>
<a href="#l3.754"></a><span id="l3.754"> </span>
<a href="#l3.755"></a><span id="l3.755">     this.listener.onLoadingFolder(dbFolderInfo);</span>
<a href="#l3.756"></a><span id="l3.756">   },</span>
<a href="#l3.757"></a><span id="l3.757"> </span>
<a href="#l3.758"></a><span id="l3.758">   /**</span>
<a href="#l3.759"></a><span id="l3.759">    * Creates a view appropriate to the current settings of the folder display</span>
<a href="#l3.760"></a><span id="l3.760">    *  widget, returning it.  The caller is responsible to assign the result to</span>
<a href="#l3.761"></a><span id="l3.761">    *  this.dbView (or whatever it wants to do with it.)</span>
<a href="#l3.762"></a><span id="l3.762">    */</span>
<a href="#l3.763"></a><span id="l3.763" class="difflineminus">-  _createView: function DBViewWrapper__createView() {</span>
<a href="#l3.764"></a><span id="l3.764" class="difflineplus">+  _createView() {</span>
<a href="#l3.765"></a><span id="l3.765">     let dbviewContractId = &quot;@mozilla.org/messenger/msgdbview;1?type=&quot;;</span>
<a href="#l3.766"></a><span id="l3.766"> </span>
<a href="#l3.767"></a><span id="l3.767">     // we will have saved these off when closing our view</span>
<a href="#l3.768"></a><span id="l3.768">     let viewFlags = this.__viewFlags || 0;</span>
<a href="#l3.769"></a><span id="l3.769"> </span>
<a href="#l3.770"></a><span id="l3.770">     // real folders are subject to the most interest set of possibilities...</span>
<a href="#l3.771"></a><span id="l3.771">     if (this._underlyingData == this.kUnderlyingRealFolder) {</span>
<a href="#l3.772"></a><span id="l3.772">       // quick-search inherits from threaded which inherits from group, so this</span>
<a href="#l3.773"></a><span id="l3.773" class="difflineat">@@ -1019,36 +989,34 @@ DBViewWrapper.prototype = {</span>
<a href="#l3.774"></a><span id="l3.774">       else if (this.showGroupedBySort)</span>
<a href="#l3.775"></a><span id="l3.775">         dbviewContractId += &quot;group&quot;;</span>
<a href="#l3.776"></a><span id="l3.776">       else if (this.specialViewThreadsWithUnread)</span>
<a href="#l3.777"></a><span id="l3.777">         dbviewContractId += &quot;threadswithunread&quot;;</span>
<a href="#l3.778"></a><span id="l3.778">       else if (this.specialViewWatchedThreadsWithUnread)</span>
<a href="#l3.779"></a><span id="l3.779">         dbviewContractId += &quot;watchedthreadswithunread&quot;;</span>
<a href="#l3.780"></a><span id="l3.780">       else</span>
<a href="#l3.781"></a><span id="l3.781">         dbviewContractId += &quot;threaded&quot;;</span>
<a href="#l3.782"></a><span id="l3.782" class="difflineminus">-    }</span>
<a href="#l3.783"></a><span id="l3.783" class="difflineminus">-    // if we're dealing with virtual folders, the answer is always an xfvf</span>
<a href="#l3.784"></a><span id="l3.784" class="difflineminus">-    else if (this._underlyingData == this.kUnderlyingMultipleFolder) {</span>
<a href="#l3.785"></a><span id="l3.785" class="difflineplus">+    } else if (this._underlyingData == this.kUnderlyingMultipleFolder) {</span>
<a href="#l3.786"></a><span id="l3.786" class="difflineplus">+      // if we're dealing with virtual folders, the answer is always an xfvf</span>
<a href="#l3.787"></a><span id="l3.787">       dbviewContractId += &quot;xfvf&quot;;</span>
<a href="#l3.788"></a><span id="l3.788" class="difflineminus">-    }</span>
<a href="#l3.789"></a><span id="l3.789" class="difflineminus">-    else { // kUnderlyingSynthetic or kUnderlyingSearchView</span>
<a href="#l3.790"></a><span id="l3.790" class="difflineplus">+    } else { // kUnderlyingSynthetic or kUnderlyingSearchView</span>
<a href="#l3.791"></a><span id="l3.791">       dbviewContractId += &quot;search&quot;;</span>
<a href="#l3.792"></a><span id="l3.792">     }</span>
<a href="#l3.793"></a><span id="l3.793"> </span>
<a href="#l3.794"></a><span id="l3.794">     // and now zero the saved-off flags.</span>
<a href="#l3.795"></a><span id="l3.795">     this.__viewFlags = null;</span>
<a href="#l3.796"></a><span id="l3.796"> </span>
<a href="#l3.797"></a><span id="l3.797">     let dbView = Cc[dbviewContractId]</span>
<a href="#l3.798"></a><span id="l3.798">                    .createInstance(Ci.nsIMsgDBView);</span>
<a href="#l3.799"></a><span id="l3.799">     dbView.init(this.listener.messenger, this.listener.msgWindow,</span>
<a href="#l3.800"></a><span id="l3.800">                 this.listener.threadPaneCommandUpdater);</span>
<a href="#l3.801"></a><span id="l3.801">     // use the least-specific sort so we can clock them back through to build up</span>
<a href="#l3.802"></a><span id="l3.802">     //  the correct sort order...</span>
<a href="#l3.803"></a><span id="l3.803">     let [sortType, sortOrder, sortCustomCol] =</span>
<a href="#l3.804"></a><span id="l3.804" class="difflineminus">-      this._getSortDetails(this._sort.length-1);</span>
<a href="#l3.805"></a><span id="l3.805" class="difflineplus">+      this._getSortDetails(this._sort.length - 1);</span>
<a href="#l3.806"></a><span id="l3.806">     let outCount = {};</span>
<a href="#l3.807"></a><span id="l3.807">     // when the underlying folder is a single real folder (virtual or no), we</span>
<a href="#l3.808"></a><span id="l3.808">     //  tell the view about the underlying folder.</span>
<a href="#l3.809"></a><span id="l3.809">     if (this.isSingleFolder) {</span>
<a href="#l3.810"></a><span id="l3.810">       // If the folder is virtual, m_viewFolder needs to be set before the</span>
<a href="#l3.811"></a><span id="l3.811">       //  folder is opened, otherwise persisted sort info will not be restored</span>
<a href="#l3.812"></a><span id="l3.812">       //  from the right dbFolderInfo. The use case is for a single folder</span>
<a href="#l3.813"></a><span id="l3.813">       //  backed saved search. Currently, sort etc. changes in quick filter are</span>
<a href="#l3.814"></a><span id="l3.814" class="difflineat">@@ -1066,49 +1034,48 @@ DBViewWrapper.prototype = {</span>
<a href="#l3.815"></a><span id="l3.815">       //  dbFolderInfo.)  This also goes for cases where the quick search is</span>
<a href="#l3.816"></a><span id="l3.816">       //  active; the C++ code explicitly nulls out the view folder for no</span>
<a href="#l3.817"></a><span id="l3.817">       //  good/documented reason, so we need to set it again if we want changes</span>
<a href="#l3.818"></a><span id="l3.818">       //  made with the quick filter applied.  (We don't just change the C++</span>
<a href="#l3.819"></a><span id="l3.819">       //  code because there could be SeaMonkey fallout.)  See bug 502767 for</span>
<a href="#l3.820"></a><span id="l3.820">       //  info about the quick-search part of the problem.</span>
<a href="#l3.821"></a><span id="l3.821">       if (this.search.hasSearchTerms)</span>
<a href="#l3.822"></a><span id="l3.822">         dbView.viewFolder = this.displayedFolder;</span>
<a href="#l3.823"></a><span id="l3.823" class="difflineminus">-    }</span>
<a href="#l3.824"></a><span id="l3.824" class="difflineminus">-    // when we're dealing with a multi-folder virtual folder, we just tell the</span>
<a href="#l3.825"></a><span id="l3.825" class="difflineminus">-    //  db view about the display folder.  (It gets its own XFVF view, so it</span>
<a href="#l3.826"></a><span id="l3.826" class="difflineminus">-    //  knows what to do.)</span>
<a href="#l3.827"></a><span id="l3.827" class="difflineminus">-    // and for a synthetic folder, displayedFolder is null anyways</span>
<a href="#l3.828"></a><span id="l3.828" class="difflineminus">-    else {</span>
<a href="#l3.829"></a><span id="l3.829" class="difflineplus">+    } else {</span>
<a href="#l3.830"></a><span id="l3.830" class="difflineplus">+      // when we're dealing with a multi-folder virtual folder, we just tell the</span>
<a href="#l3.831"></a><span id="l3.831" class="difflineplus">+      //  db view about the display folder.  (It gets its own XFVF view, so it</span>
<a href="#l3.832"></a><span id="l3.832" class="difflineplus">+      //  knows what to do.)</span>
<a href="#l3.833"></a><span id="l3.833" class="difflineplus">+      // and for a synthetic folder, displayedFolder is null anyways</span>
<a href="#l3.834"></a><span id="l3.834">       dbView.open(this.displayedFolder, sortType, sortOrder, viewFlags,</span>
<a href="#l3.835"></a><span id="l3.835">                   outCount);</span>
<a href="#l3.836"></a><span id="l3.836">     }</span>
<a href="#l3.837"></a><span id="l3.837">     if (sortCustomCol)</span>
<a href="#l3.838"></a><span id="l3.838">       dbView.curCustomColumn = sortCustomCol;</span>
<a href="#l3.839"></a><span id="l3.839"> </span>
<a href="#l3.840"></a><span id="l3.840">     // we all know it's a tree view, make sure the interface is available</span>
<a href="#l3.841"></a><span id="l3.841">     //  so no one else has to do this.</span>
<a href="#l3.842"></a><span id="l3.842">     dbView.QueryInterface(Ci.nsITreeView);</span>
<a href="#l3.843"></a><span id="l3.843"> </span>
<a href="#l3.844"></a><span id="l3.844">     // clock through the rest of the sorts, if there are any</span>
<a href="#l3.845"></a><span id="l3.845" class="difflineminus">-    for (let iSort = this._sort.length - 2; iSort &gt;=0; iSort--) {</span>
<a href="#l3.846"></a><span id="l3.846" class="difflineplus">+    for (let iSort = this._sort.length - 2; iSort &gt;= 0; iSort--) {</span>
<a href="#l3.847"></a><span id="l3.847">       [sortType, sortOrder, sortCustomCol] = this._getSortDetails(iSort);</span>
<a href="#l3.848"></a><span id="l3.848">       if (sortCustomCol)</span>
<a href="#l3.849"></a><span id="l3.849">         dbView.curCustomColumn = sortCustomCol;</span>
<a href="#l3.850"></a><span id="l3.850">       dbView.sort(sortType, sortOrder);</span>
<a href="#l3.851"></a><span id="l3.851">     }</span>
<a href="#l3.852"></a><span id="l3.852"> </span>
<a href="#l3.853"></a><span id="l3.853">     return dbView;</span>
<a href="#l3.854"></a><span id="l3.854">   },</span>
<a href="#l3.855"></a><span id="l3.855"> </span>
<a href="#l3.856"></a><span id="l3.856">   /**</span>
<a href="#l3.857"></a><span id="l3.857">    * Callback method invoked by FolderNotificationHelper when our folder is</span>
<a href="#l3.858"></a><span id="l3.858">    *  loaded.  Assuming we are still interested in the folder, we enter the</span>
<a href="#l3.859"></a><span id="l3.859">    *  folder via _enterFolder.</span>
<a href="#l3.860"></a><span id="l3.860">    */</span>
<a href="#l3.861"></a><span id="l3.861" class="difflineminus">-  _folderLoaded: function DBViewWrapper__folderLoaded(aFolder) {</span>
<a href="#l3.862"></a><span id="l3.862" class="difflineplus">+  _folderLoaded(aFolder) {</span>
<a href="#l3.863"></a><span id="l3.863">     if (aFolder == this.displayedFolder) {</span>
<a href="#l3.864"></a><span id="l3.864">       this.folderLoading = false;</span>
<a href="#l3.865"></a><span id="l3.865">       // If _underlyingFolders is null, DBViewWrapper_open probably got</span>
<a href="#l3.866"></a><span id="l3.866">       // an exception trying to open the db, but after reparsing the local</span>
<a href="#l3.867"></a><span id="l3.867">       // folder, we should have a db, so set up the view based on info</span>
<a href="#l3.868"></a><span id="l3.868">       // from the db.</span>
<a href="#l3.869"></a><span id="l3.869">       if (this._underlyingFolders == null) {</span>
<a href="#l3.870"></a><span id="l3.870">         this._prepareToLoadView(aFolder.msgDatabase, aFolder);</span>
<a href="#l3.871"></a><span id="l3.871" class="difflineat">@@ -1120,17 +1087,17 @@ DBViewWrapper.prototype = {</span>
<a href="#l3.872"></a><span id="l3.872"> </span>
<a href="#l3.873"></a><span id="l3.873">   /**</span>
<a href="#l3.874"></a><span id="l3.874">    * Enter this.displayedFolder if we have not yet entered it.</span>
<a href="#l3.875"></a><span id="l3.875">    *</span>
<a href="#l3.876"></a><span id="l3.876">    * Things we do on entering a folder:</span>
<a href="#l3.877"></a><span id="l3.877">    * - clear the folder's biffState!</span>
<a href="#l3.878"></a><span id="l3.878">    * - set the message database's header cache size</span>
<a href="#l3.879"></a><span id="l3.879">    */</span>
<a href="#l3.880"></a><span id="l3.880" class="difflineminus">-  _enterFolder: function DBViewWrapper__enterFolder() {</span>
<a href="#l3.881"></a><span id="l3.881" class="difflineplus">+  _enterFolder() {</span>
<a href="#l3.882"></a><span id="l3.882">     if (this._enteredFolder)</span>
<a href="#l3.883"></a><span id="l3.883">       return;</span>
<a href="#l3.884"></a><span id="l3.884"> </span>
<a href="#l3.885"></a><span id="l3.885">     this.displayedFolder.biffState =</span>
<a href="#l3.886"></a><span id="l3.886">       Ci.nsIMsgFolder.nsMsgBiffState_NoMail;</span>
<a href="#l3.887"></a><span id="l3.887"> </span>
<a href="#l3.888"></a><span id="l3.888">     // we definitely want a view at this point; force the view.</span>
<a href="#l3.889"></a><span id="l3.889">     this._viewUpdateDepth = 0;</span>
<a href="#l3.890"></a><span id="l3.890" class="difflineat">@@ -1140,17 +1107,17 @@ DBViewWrapper.prototype = {</span>
<a href="#l3.891"></a><span id="l3.891"> </span>
<a href="#l3.892"></a><span id="l3.892">     this._enteredFolder = true;</span>
<a href="#l3.893"></a><span id="l3.893">   },</span>
<a href="#l3.894"></a><span id="l3.894"> </span>
<a href="#l3.895"></a><span id="l3.895">   /**</span>
<a href="#l3.896"></a><span id="l3.896">    * Renames, moves to the trash, it's all crazy.  We have to update all our</span>
<a href="#l3.897"></a><span id="l3.897">    *  references when this happens.</span>
<a href="#l3.898"></a><span id="l3.898">    */</span>
<a href="#l3.899"></a><span id="l3.899" class="difflineminus">-  _folderMoved: function DBViewWrapper__folderMoved(aOldFolder, aNewFolder) {</span>
<a href="#l3.900"></a><span id="l3.900" class="difflineplus">+  _folderMoved(aOldFolder, aNewFolder) {</span>
<a href="#l3.901"></a><span id="l3.901">     if (aOldFolder == this.displayedFolder)</span>
<a href="#l3.902"></a><span id="l3.902">       this.displayedFolder = aNewFolder;</span>
<a href="#l3.903"></a><span id="l3.903"> </span>
<a href="#l3.904"></a><span id="l3.904">     // indexOf doesn't work for this (reliably)</span>
<a href="#l3.905"></a><span id="l3.905">     for (let [i, underlyingFolder] of this._underlyingFolders.entries()) {</span>
<a href="#l3.906"></a><span id="l3.906">       if (aOldFolder == underlyingFolder) {</span>
<a href="#l3.907"></a><span id="l3.907">         this._underlyingFolders[i] = aNewFolder;</span>
<a href="#l3.908"></a><span id="l3.908">         break;</span>
<a href="#l3.909"></a><span id="l3.909" class="difflineat">@@ -1167,33 +1134,33 @@ DBViewWrapper.prototype = {</span>
<a href="#l3.910"></a><span id="l3.910">    *  displaying (real or virtual), this closes it.  If we are virtual and</span>
<a href="#l3.911"></a><span id="l3.911">    *  backed by a single folder, this closes us.  If we are backed by multiple</span>
<a href="#l3.912"></a><span id="l3.912">    *  folders, we just update ourselves.  (Currently, cross-folder views are</span>
<a href="#l3.913"></a><span id="l3.913">    *  not clever enough to purge the mooted messages, so we need to do this to</span>
<a href="#l3.914"></a><span id="l3.914">    *  help them out.)</span>
<a href="#l3.915"></a><span id="l3.915">    * We do not update virtual folder definitions as a result of deletion; we are</span>
<a href="#l3.916"></a><span id="l3.916">    *  a display abstraction.  That (hopefully) happens elsewhere.</span>
<a href="#l3.917"></a><span id="l3.917">    */</span>
<a href="#l3.918"></a><span id="l3.918" class="difflineminus">-  _folderDeleted: function DBViewWrapper__folderDeleted(aFolder) {</span>
<a href="#l3.919"></a><span id="l3.919" class="difflineplus">+  _folderDeleted(aFolder) {</span>
<a href="#l3.920"></a><span id="l3.920">     // XXX When we empty the trash, we're actually sending a folder deleted</span>
<a href="#l3.921"></a><span id="l3.921">     // notification around. This check ensures we don't think we've really</span>
<a href="#l3.922"></a><span id="l3.922">     // deleted the trash folder in the DBViewWrapper, and that stops nasty</span>
<a href="#l3.923"></a><span id="l3.923">     // things happening, like forgetting we've got the trash folder selected.</span>
<a href="#l3.924"></a><span id="l3.924" class="difflineminus">-    if (aFolder.isSpecialFolder(nsMsgFolderFlags.Trash, false))</span>
<a href="#l3.925"></a><span id="l3.925" class="difflineplus">+    if (aFolder.isSpecialFolder(Ci.nsMsgFolderFlags.Trash, false))</span>
<a href="#l3.926"></a><span id="l3.926">       return;</span>
<a href="#l3.927"></a><span id="l3.927"> </span>
<a href="#l3.928"></a><span id="l3.928">     if (aFolder == this.displayedFolder) {</span>
<a href="#l3.929"></a><span id="l3.929">       this.close();</span>
<a href="#l3.930"></a><span id="l3.930">       return;</span>
<a href="#l3.931"></a><span id="l3.931">     }</span>
<a href="#l3.932"></a><span id="l3.932"> </span>
<a href="#l3.933"></a><span id="l3.933">     // indexOf doesn't work for this (reliably)</span>
<a href="#l3.934"></a><span id="l3.934">     for (let [i, underlyingFolder] of this._underlyingFolders.entries()) {</span>
<a href="#l3.935"></a><span id="l3.935">       if (aFolder == underlyingFolder) {</span>
<a href="#l3.936"></a><span id="l3.936" class="difflineminus">-        this._underlyingFolders.splice(i,1);</span>
<a href="#l3.937"></a><span id="l3.937" class="difflineplus">+        this._underlyingFolders.splice(i, 1);</span>
<a href="#l3.938"></a><span id="l3.938">         break;</span>
<a href="#l3.939"></a><span id="l3.939">       }</span>
<a href="#l3.940"></a><span id="l3.940">     }</span>
<a href="#l3.941"></a><span id="l3.941"> </span>
<a href="#l3.942"></a><span id="l3.942">     if (this._underlyingFolders.length == 0) {</span>
<a href="#l3.943"></a><span id="l3.943">       this.close();</span>
<a href="#l3.944"></a><span id="l3.944">       return;</span>
<a href="#l3.945"></a><span id="l3.945">     }</span>
<a href="#l3.946"></a><span id="l3.946" class="difflineat">@@ -1203,17 +1170,17 @@ DBViewWrapper.prototype = {</span>
<a href="#l3.947"></a><span id="l3.947">   },</span>
<a href="#l3.948"></a><span id="l3.948"> </span>
<a href="#l3.949"></a><span id="l3.949">   /**</span>
<a href="#l3.950"></a><span id="l3.950">    * Compacting a local folder nukes its message keys, requiring the view to be</span>
<a href="#l3.951"></a><span id="l3.951">    *  rebuilt.  If the folder is IMAP, it doesn't matter because the UIDs are</span>
<a href="#l3.952"></a><span id="l3.952">    *  the message keys and we can ignore it.  In the local case we want to</span>
<a href="#l3.953"></a><span id="l3.953">    *  notify our listener so they have a chance to save the selected messages.</span>
<a href="#l3.954"></a><span id="l3.954">    */</span>
<a href="#l3.955"></a><span id="l3.955" class="difflineminus">-  _aboutToCompactFolder: function DBViewWrapper__aboutToCompactFolder(aFolder) {</span>
<a href="#l3.956"></a><span id="l3.956" class="difflineplus">+  _aboutToCompactFolder(aFolder) {</span>
<a href="#l3.957"></a><span id="l3.957">     // IMAP compaction does not affect us unless we are holding headers</span>
<a href="#l3.958"></a><span id="l3.958">     if (aFolder.server.type == &quot;imap&quot;)</span>
<a href="#l3.959"></a><span id="l3.959">       return;</span>
<a href="#l3.960"></a><span id="l3.960"> </span>
<a href="#l3.961"></a><span id="l3.961">     // we will have to re-create the view, so nuke the view now.</span>
<a href="#l3.962"></a><span id="l3.962">     if (this.dbView) {</span>
<a href="#l3.963"></a><span id="l3.963">       this.listener.onDestroyingView(true);</span>
<a href="#l3.964"></a><span id="l3.964">       this.search.dissociateView(this.dbView);</span>
<a href="#l3.965"></a><span id="l3.965" class="difflineat">@@ -1221,62 +1188,62 @@ DBViewWrapper.prototype = {</span>
<a href="#l3.966"></a><span id="l3.966">       this.dbView = null;</span>
<a href="#l3.967"></a><span id="l3.967">     }</span>
<a href="#l3.968"></a><span id="l3.968">   },</span>
<a href="#l3.969"></a><span id="l3.969"> </span>
<a href="#l3.970"></a><span id="l3.970">   /**</span>
<a href="#l3.971"></a><span id="l3.971">    * Compaction is all done, let's re-create the view!  (Unless the folder is</span>
<a href="#l3.972"></a><span id="l3.972">    *  IMAP, in which case we are ignoring this event sequence.)</span>
<a href="#l3.973"></a><span id="l3.973">    */</span>
<a href="#l3.974"></a><span id="l3.974" class="difflineminus">-  _compactedFolder: function DBViewWrapper__compactedFolder(aFolder) {</span>
<a href="#l3.975"></a><span id="l3.975" class="difflineplus">+  _compactedFolder(aFolder) {</span>
<a href="#l3.976"></a><span id="l3.976">     // IMAP compaction does not affect us unless we are holding headers</span>
<a href="#l3.977"></a><span id="l3.977">     if (aFolder.server.type == &quot;imap&quot;)</span>
<a href="#l3.978"></a><span id="l3.978">       return;</span>
<a href="#l3.979"></a><span id="l3.979"> </span>
<a href="#l3.980"></a><span id="l3.980">     this.refresh();</span>
<a href="#l3.981"></a><span id="l3.981">   },</span>
<a href="#l3.982"></a><span id="l3.982"> </span>
<a href="#l3.983"></a><span id="l3.983">   /**</span>
<a href="#l3.984"></a><span id="l3.984">    * DB Views need help to know when their move / deletion operations complete.</span>
<a href="#l3.985"></a><span id="l3.985">    *  This happens in both single-folder and multiple-folder backed searches.</span>
<a href="#l3.986"></a><span id="l3.986">    *  In the latter case, there is potential danger that we tell a view that did</span>
<a href="#l3.987"></a><span id="l3.987">    *  not initiate the move / deletion but has kicked off its own about the</span>
<a href="#l3.988"></a><span id="l3.988">    *  completion and confuse it.  However, that's on the view code.</span>
<a href="#l3.989"></a><span id="l3.989">    */</span>
<a href="#l3.990"></a><span id="l3.990" class="difflineminus">-  _deleteCompleted: function DBViewWrapper__deleteCompleted(aFolder) {</span>
<a href="#l3.991"></a><span id="l3.991" class="difflineplus">+  _deleteCompleted(aFolder) {</span>
<a href="#l3.992"></a><span id="l3.992">     if (this.dbView)</span>
<a href="#l3.993"></a><span id="l3.993">       this.dbView.onDeleteCompleted(true);</span>
<a href="#l3.994"></a><span id="l3.994">     this.listener.onMessagesRemoved();</span>
<a href="#l3.995"></a><span id="l3.995">   },</span>
<a href="#l3.996"></a><span id="l3.996"> </span>
<a href="#l3.997"></a><span id="l3.997">   /**</span>
<a href="#l3.998"></a><span id="l3.998">    * See _deleteCompleted for an explanation of what is going on.</span>
<a href="#l3.999"></a><span id="l3.999">    */</span>
<a href="#l3.1000"></a><span id="l3.1000" class="difflineminus">-  _deleteFailed: function DBViewWrapper__deleteFailed(aFolder) {</span>
<a href="#l3.1001"></a><span id="l3.1001" class="difflineplus">+  _deleteFailed(aFolder) {</span>
<a href="#l3.1002"></a><span id="l3.1002">     if (this.dbView)</span>
<a href="#l3.1003"></a><span id="l3.1003">       this.dbView.onDeleteCompleted(false);</span>
<a href="#l3.1004"></a><span id="l3.1004">     this.listener.onMessageRemovalFailed();</span>
<a href="#l3.1005"></a><span id="l3.1005">   },</span>
<a href="#l3.1006"></a><span id="l3.1006"> </span>
<a href="#l3.1007"></a><span id="l3.1007" class="difflineminus">-  _forceOpen: function DBViewWrapper__forceOpen(aFolder) {</span>
<a href="#l3.1008"></a><span id="l3.1008" class="difflineplus">+  _forceOpen(aFolder) {</span>
<a href="#l3.1009"></a><span id="l3.1009">     this.displayedFolder = null;</span>
<a href="#l3.1010"></a><span id="l3.1010">     this.open(aFolder);</span>
<a href="#l3.1011"></a><span id="l3.1011">   },</span>
<a href="#l3.1012"></a><span id="l3.1012"> </span>
<a href="#l3.1013"></a><span id="l3.1013" class="difflineminus">-  _renameCompleted: function DBViewWrapper__renameCompleted(aFolder) {</span>
<a href="#l3.1014"></a><span id="l3.1014" class="difflineplus">+  _renameCompleted(aFolder) {</span>
<a href="#l3.1015"></a><span id="l3.1015">     if (aFolder == this.displayedFolder)</span>
<a href="#l3.1016"></a><span id="l3.1016">       this._forceOpen(aFolder);</span>
<a href="#l3.1017"></a><span id="l3.1017">   },</span>
<a href="#l3.1018"></a><span id="l3.1018"> </span>
<a href="#l3.1019"></a><span id="l3.1019">   /**</span>
<a href="#l3.1020"></a><span id="l3.1020">    * If the displayed folder had its total message count or total unread message</span>
<a href="#l3.1021"></a><span id="l3.1021">    *  count change, notify the listener.  (Note: only for the display folder;</span>
<a href="#l3.1022"></a><span id="l3.1022">    *  not the underlying folders!)</span>
<a href="#l3.1023"></a><span id="l3.1023">    */</span>
<a href="#l3.1024"></a><span id="l3.1024" class="difflineminus">-  _messageCountsChanged: function DBViewWrapper__messageCountsChanged(aFolder) {</span>
<a href="#l3.1025"></a><span id="l3.1025" class="difflineplus">+  _messageCountsChanged(aFolder) {</span>
<a href="#l3.1026"></a><span id="l3.1026">     if (aFolder == this.displayedFolder)</span>
<a href="#l3.1027"></a><span id="l3.1027">       this.listener.onMessageCountsChanged();</span>
<a href="#l3.1028"></a><span id="l3.1028">   },</span>
<a href="#l3.1029"></a><span id="l3.1029"> </span>
<a href="#l3.1030"></a><span id="l3.1030">   /**</span>
<a href="#l3.1031"></a><span id="l3.1031">    * @return the current set of viewFlags.  This may be:</span>
<a href="#l3.1032"></a><span id="l3.1032">    * - A modified set of flags that are pending application because a view</span>
<a href="#l3.1033"></a><span id="l3.1033">    *    update is in effect and we don't want to modify the view when it's just</span>
<a href="#l3.1034"></a><span id="l3.1034" class="difflineat">@@ -1320,51 +1287,49 @@ DBViewWrapper.prototype = {</span>
<a href="#l3.1035"></a><span id="l3.1035"> </span>
<a href="#l3.1036"></a><span id="l3.1036">     let setViewFlags = true;</span>
<a href="#l3.1037"></a><span id="l3.1037">     let reSort = false;</span>
<a href="#l3.1038"></a><span id="l3.1038">     let oldFlags = this.dbView.viewFlags;</span>
<a href="#l3.1039"></a><span id="l3.1039">     let changedFlags = oldFlags ^ aViewFlags;</span>
<a href="#l3.1040"></a><span id="l3.1040"> </span>
<a href="#l3.1041"></a><span id="l3.1041">     if (this.isVirtual) {</span>
<a href="#l3.1042"></a><span id="l3.1042">       if (this.isMultiFolder &amp;&amp;</span>
<a href="#l3.1043"></a><span id="l3.1043" class="difflineminus">-          (changedFlags &amp; nsMsgViewFlagsType.kThreadedDisplay &amp;&amp;</span>
<a href="#l3.1044"></a><span id="l3.1044" class="difflineminus">-           !(changedFlags &amp; nsMsgViewFlagsType.kGroupBySort)))</span>
<a href="#l3.1045"></a><span id="l3.1045" class="difflineplus">+          (changedFlags &amp; Ci.nsMsgViewFlagsType.kThreadedDisplay &amp;&amp;</span>
<a href="#l3.1046"></a><span id="l3.1046" class="difflineplus">+           !(changedFlags &amp; Ci.nsMsgViewFlagsType.kGroupBySort)))</span>
<a href="#l3.1047"></a><span id="l3.1047">         reSort = true;</span>
<a href="#l3.1048"></a><span id="l3.1048">       if (this.isSingleFolder)</span>
<a href="#l3.1049"></a><span id="l3.1049">         // ugh, and the single folder case needs us to re-apply his sort...</span>
<a href="#l3.1050"></a><span id="l3.1050">         reSort = true;</span>
<a href="#l3.1051"></a><span id="l3.1051" class="difflineminus">-    }</span>
<a href="#l3.1052"></a><span id="l3.1052" class="difflineminus">-    else {</span>
<a href="#l3.1053"></a><span id="l3.1053" class="difflineplus">+    } else {</span>
<a href="#l3.1054"></a><span id="l3.1054">       // The regular single folder case.</span>
<a href="#l3.1055"></a><span id="l3.1055" class="difflineminus">-      if (changedFlags &amp; (nsMsgViewFlagsType.kGroupBySort |</span>
<a href="#l3.1056"></a><span id="l3.1056" class="difflineminus">-                          nsMsgViewFlagsType.kUnreadOnly |</span>
<a href="#l3.1057"></a><span id="l3.1057" class="difflineminus">-                          nsMsgViewFlagsType.kShowIgnored)) {</span>
<a href="#l3.1058"></a><span id="l3.1058" class="difflineplus">+      if (changedFlags &amp; (Ci.nsMsgViewFlagsType.kGroupBySort |</span>
<a href="#l3.1059"></a><span id="l3.1059" class="difflineplus">+                          Ci.nsMsgViewFlagsType.kUnreadOnly |</span>
<a href="#l3.1060"></a><span id="l3.1060" class="difflineplus">+                          Ci.nsMsgViewFlagsType.kShowIgnored)) {</span>
<a href="#l3.1061"></a><span id="l3.1061">         setViewFlags = false;</span>
<a href="#l3.1062"></a><span id="l3.1062">       }</span>
<a href="#l3.1063"></a><span id="l3.1063">       // ugh, and the single folder case needs us to re-apply his sort...</span>
<a href="#l3.1064"></a><span id="l3.1064">       reSort = true;</span>
<a href="#l3.1065"></a><span id="l3.1065">     }</span>
<a href="#l3.1066"></a><span id="l3.1066"> </span>
<a href="#l3.1067"></a><span id="l3.1067">     if (setViewFlags) {</span>
<a href="#l3.1068"></a><span id="l3.1068">       this.dbView.viewFlags = aViewFlags;</span>
<a href="#l3.1069"></a><span id="l3.1069">       if (reSort)</span>
<a href="#l3.1070"></a><span id="l3.1070">         this.dbView.sort(this.dbView.sortType, this.dbView.sortOrder);</span>
<a href="#l3.1071"></a><span id="l3.1071">       this.listener.onSortChanged();</span>
<a href="#l3.1072"></a><span id="l3.1072" class="difflineminus">-    }</span>
<a href="#l3.1073"></a><span id="l3.1073" class="difflineminus">-    else {</span>
<a href="#l3.1074"></a><span id="l3.1074" class="difflineplus">+    } else {</span>
<a href="#l3.1075"></a><span id="l3.1075">       this.__viewFlags = aViewFlags;</span>
<a href="#l3.1076"></a><span id="l3.1076">       this._applyViewChanges();</span>
<a href="#l3.1077"></a><span id="l3.1077">     }</span>
<a href="#l3.1078"></a><span id="l3.1078">   },</span>
<a href="#l3.1079"></a><span id="l3.1079"> </span>
<a href="#l3.1080"></a><span id="l3.1080">   /**</span>
<a href="#l3.1081"></a><span id="l3.1081">    * Apply accumulated changes to the view.  If we are in a batch, we do</span>
<a href="#l3.1082"></a><span id="l3.1082">    *  nothing, relying on endDisplayUpdate to call us.</span>
<a href="#l3.1083"></a><span id="l3.1083">    */</span>
<a href="#l3.1084"></a><span id="l3.1084" class="difflineminus">-  _applyViewChanges: function DBViewWrapper__applyViewChanges() {</span>
<a href="#l3.1085"></a><span id="l3.1085" class="difflineplus">+  _applyViewChanges() {</span>
<a href="#l3.1086"></a><span id="l3.1086">     // if we are in a batch, wait for endDisplayUpdate to be called to get us</span>
<a href="#l3.1087"></a><span id="l3.1087">     //  out to zero.</span>
<a href="#l3.1088"></a><span id="l3.1088">     if (this._viewUpdateDepth)</span>
<a href="#l3.1089"></a><span id="l3.1089">       return;</span>
<a href="#l3.1090"></a><span id="l3.1090">     // make the dbView stop being a search listener if it is one</span>
<a href="#l3.1091"></a><span id="l3.1091">     if (this.dbView) {</span>
<a href="#l3.1092"></a><span id="l3.1092">       // save the view's flags if it has any and we haven't already overridden</span>
<a href="#l3.1093"></a><span id="l3.1093">       //  them.</span>
<a href="#l3.1094"></a><span id="l3.1094" class="difflineat">@@ -1400,33 +1365,33 @@ DBViewWrapper.prototype = {</span>
<a href="#l3.1095"></a><span id="l3.1095">     if (!this.searching &amp;&amp; !this.folderLoading)</span>
<a href="#l3.1096"></a><span id="l3.1096">       this.listener.onMessagesLoaded(true);</span>
<a href="#l3.1097"></a><span id="l3.1097">     else if (this.dbView.numMsgsInView &gt; 0)</span>
<a href="#l3.1098"></a><span id="l3.1098">       this.listener.onMessagesLoaded(false);</span>
<a href="#l3.1099"></a><span id="l3.1099">   },</span>
<a href="#l3.1100"></a><span id="l3.1100"> </span>
<a href="#l3.1101"></a><span id="l3.1101">   get isMailFolder() {</span>
<a href="#l3.1102"></a><span id="l3.1102">     return Boolean(this.displayedFolder &amp;&amp;</span>
<a href="#l3.1103"></a><span id="l3.1103" class="difflineminus">-                   (this.displayedFolder.flags &amp; nsMsgFolderFlags.Mail));</span>
<a href="#l3.1104"></a><span id="l3.1104" class="difflineplus">+                   (this.displayedFolder.flags &amp; Ci.nsMsgFolderFlags.Mail));</span>
<a href="#l3.1105"></a><span id="l3.1105">   },</span>
<a href="#l3.1106"></a><span id="l3.1106"> </span>
<a href="#l3.1107"></a><span id="l3.1107">   get isNewsFolder() {</span>
<a href="#l3.1108"></a><span id="l3.1108">     return Boolean(this.displayedFolder &amp;&amp;</span>
<a href="#l3.1109"></a><span id="l3.1109" class="difflineminus">-                   (this.displayedFolder.flags &amp; nsMsgFolderFlags.Newsgroup));</span>
<a href="#l3.1110"></a><span id="l3.1110" class="difflineplus">+                   (this.displayedFolder.flags &amp; Ci.nsMsgFolderFlags.Newsgroup));</span>
<a href="#l3.1111"></a><span id="l3.1111">   },</span>
<a href="#l3.1112"></a><span id="l3.1112"> </span>
<a href="#l3.1113"></a><span id="l3.1113">   get isFeedFolder() {</span>
<a href="#l3.1114"></a><span id="l3.1114">     return Boolean(this.displayedFolder &amp;&amp;</span>
<a href="#l3.1115"></a><span id="l3.1115">                    this.displayedFolder.server.type == &quot;rss&quot;);</span>
<a href="#l3.1116"></a><span id="l3.1116">   },</span>
<a href="#l3.1117"></a><span id="l3.1117"> </span>
<a href="#l3.1118"></a><span id="l3.1118" class="difflineminus">-  OUTGOING_FOLDER_FLAGS: nsMsgFolderFlags.SentMail |</span>
<a href="#l3.1119"></a><span id="l3.1119" class="difflineminus">-                         nsMsgFolderFlags.Drafts |</span>
<a href="#l3.1120"></a><span id="l3.1120" class="difflineminus">-                         nsMsgFolderFlags.Queue |</span>
<a href="#l3.1121"></a><span id="l3.1121" class="difflineminus">-                         nsMsgFolderFlags.Templates,</span>
<a href="#l3.1122"></a><span id="l3.1122" class="difflineplus">+  OUTGOING_FOLDER_FLAGS: Ci.nsMsgFolderFlags.SentMail |</span>
<a href="#l3.1123"></a><span id="l3.1123" class="difflineplus">+                         Ci.nsMsgFolderFlags.Drafts |</span>
<a href="#l3.1124"></a><span id="l3.1124" class="difflineplus">+                         Ci.nsMsgFolderFlags.Queue |</span>
<a href="#l3.1125"></a><span id="l3.1125" class="difflineplus">+                         Ci.nsMsgFolderFlags.Templates,</span>
<a href="#l3.1126"></a><span id="l3.1126">   /**</span>
<a href="#l3.1127"></a><span id="l3.1127">    * @return true if the folder is an outgoing folder by virtue of being a</span>
<a href="#l3.1128"></a><span id="l3.1128">    *     sent mail folder, drafts folder, queue folder, or template folder,</span>
<a href="#l3.1129"></a><span id="l3.1129">    *     or being a sub-folder of one of those types of folders.</span>
<a href="#l3.1130"></a><span id="l3.1130">    */</span>
<a href="#l3.1131"></a><span id="l3.1131">   get isOutgoingFolder() {</span>
<a href="#l3.1132"></a><span id="l3.1132">     return this.displayedFolder &amp;&amp;</span>
<a href="#l3.1133"></a><span id="l3.1133">            this.displayedFolder.isSpecialFolder(this.OUTGOING_FOLDER_FLAGS,</span>
<a href="#l3.1134"></a><span id="l3.1134" class="difflineat">@@ -1437,40 +1402,40 @@ DBViewWrapper.prototype = {</span>
<a href="#l3.1135"></a><span id="l3.1135">    *     or the descendent of a special outgoing folder.</span>
<a href="#l3.1136"></a><span id="l3.1136">    */</span>
<a href="#l3.1137"></a><span id="l3.1137">   get isIncomingFolder() {</span>
<a href="#l3.1138"></a><span id="l3.1138">     return !this.isOutgoingFolder;</span>
<a href="#l3.1139"></a><span id="l3.1139">   },</span>
<a href="#l3.1140"></a><span id="l3.1140"> </span>
<a href="#l3.1141"></a><span id="l3.1141">   get isVirtual() {</span>
<a href="#l3.1142"></a><span id="l3.1142">     return Boolean(this.displayedFolder &amp;&amp;</span>
<a href="#l3.1143"></a><span id="l3.1143" class="difflineminus">-                   (this.displayedFolder.flags &amp; nsMsgFolderFlags.Virtual));</span>
<a href="#l3.1144"></a><span id="l3.1144" class="difflineplus">+                   (this.displayedFolder.flags &amp; Ci.nsMsgFolderFlags.Virtual));</span>
<a href="#l3.1145"></a><span id="l3.1145">   },</span>
<a href="#l3.1146"></a><span id="l3.1146"> </span>
<a href="#l3.1147"></a><span id="l3.1147">   /**</span>
<a href="#l3.1148"></a><span id="l3.1148">    * Prevent view updates from running until a paired |endViewUpdate| call is</span>
<a href="#l3.1149"></a><span id="l3.1149">    *  made.  This is an advisory method intended to aid us in performing</span>
<a href="#l3.1150"></a><span id="l3.1150">    *  redundant view re-computations and does not forbid us from building the</span>
<a href="#l3.1151"></a><span id="l3.1151">    *  view earlier if we have a good reason.</span>
<a href="#l3.1152"></a><span id="l3.1152">    * Since calling endViewUpdate will compel a view update when the update</span>
<a href="#l3.1153"></a><span id="l3.1153">    *  depth reaches 0, you should only call this method if you are sure that</span>
<a href="#l3.1154"></a><span id="l3.1154">    *  you will need the view to be re-built.  If you are doing things like</span>
<a href="#l3.1155"></a><span id="l3.1155">    *  changing to/from threaded mode that do not cause the view to be rebuilt,</span>
<a href="#l3.1156"></a><span id="l3.1156">    *  you should just set those attributes directly.</span>
<a href="#l3.1157"></a><span id="l3.1157">    */</span>
<a href="#l3.1158"></a><span id="l3.1158" class="difflineminus">-  beginViewUpdate: function DBViewWrapper_beginViewUpdate() {</span>
<a href="#l3.1159"></a><span id="l3.1159" class="difflineplus">+  beginViewUpdate() {</span>
<a href="#l3.1160"></a><span id="l3.1160">     this._viewUpdateDepth++;</span>
<a href="#l3.1161"></a><span id="l3.1161">   },</span>
<a href="#l3.1162"></a><span id="l3.1162"> </span>
<a href="#l3.1163"></a><span id="l3.1163">   /**</span>
<a href="#l3.1164"></a><span id="l3.1164">    * Conclude a paired call to |beginViewUpdate|.  Assuming the view depth has</span>
<a href="#l3.1165"></a><span id="l3.1165">    *  reached 0 with this call, the view will be re-created with the current</span>
<a href="#l3.1166"></a><span id="l3.1166">    *  settings.</span>
<a href="#l3.1167"></a><span id="l3.1167">    */</span>
<a href="#l3.1168"></a><span id="l3.1168" class="difflineminus">-  endViewUpdate: function DBViewWrapper_endViewUpdate(aForceLevel) {</span>
<a href="#l3.1169"></a><span id="l3.1169" class="difflineplus">+  endViewUpdate(aForceLevel) {</span>
<a href="#l3.1170"></a><span id="l3.1170">     if (--this._viewUpdateDepth == 0)</span>
<a href="#l3.1171"></a><span id="l3.1171">       this._applyViewChanges();</span>
<a href="#l3.1172"></a><span id="l3.1172">     // Avoid pathological situations.</span>
<a href="#l3.1173"></a><span id="l3.1173">     if (this._viewUpdateDepth &lt; 0)</span>
<a href="#l3.1174"></a><span id="l3.1174">       this._viewUpdateDepth = 0;</span>
<a href="#l3.1175"></a><span id="l3.1175">   },</span>
<a href="#l3.1176"></a><span id="l3.1176"> </span>
<a href="#l3.1177"></a><span id="l3.1177">   /**</span>
<a href="#l3.1178"></a><span id="l3.1178" class="difflineat">@@ -1489,74 +1454,73 @@ DBViewWrapper.prototype = {</span>
<a href="#l3.1179"></a><span id="l3.1179">     return this._sort[0][1];</span>
<a href="#l3.1180"></a><span id="l3.1180">   },</span>
<a href="#l3.1181"></a><span id="l3.1181"> </span>
<a href="#l3.1182"></a><span id="l3.1182">   /**</span>
<a href="#l3.1183"></a><span id="l3.1183">    * @return true if the dominant sort is ascending.</span>
<a href="#l3.1184"></a><span id="l3.1184">    */</span>
<a href="#l3.1185"></a><span id="l3.1185">   get isSortedAscending() {</span>
<a href="#l3.1186"></a><span id="l3.1186">     return this._sort.length &amp;&amp;</span>
<a href="#l3.1187"></a><span id="l3.1187" class="difflineminus">-           this._sort[0][1] == nsMsgViewSortOrder.ascending;</span>
<a href="#l3.1188"></a><span id="l3.1188" class="difflineplus">+           this._sort[0][1] == Ci.nsMsgViewSortOrder.ascending;</span>
<a href="#l3.1189"></a><span id="l3.1189">   },</span>
<a href="#l3.1190"></a><span id="l3.1190">   /**</span>
<a href="#l3.1191"></a><span id="l3.1191">    * @return true if the dominant sort is descending.</span>
<a href="#l3.1192"></a><span id="l3.1192">    */</span>
<a href="#l3.1193"></a><span id="l3.1193">   get isSortedDescending() {</span>
<a href="#l3.1194"></a><span id="l3.1194">     return this._sort.length &amp;&amp;</span>
<a href="#l3.1195"></a><span id="l3.1195" class="difflineminus">-           this._sort[0][1] == nsMsgViewSortOrder.descending;</span>
<a href="#l3.1196"></a><span id="l3.1196" class="difflineplus">+           this._sort[0][1] == Ci.nsMsgViewSortOrder.descending;</span>
<a href="#l3.1197"></a><span id="l3.1197">   },</span>
<a href="#l3.1198"></a><span id="l3.1198">   /**</span>
<a href="#l3.1199"></a><span id="l3.1199">    * Indicate if we are sorting by time or something correlated with time.</span>
<a href="#l3.1200"></a><span id="l3.1200">    *</span>
<a href="#l3.1201"></a><span id="l3.1201">    * @return true if the dominant sort is by time.</span>
<a href="#l3.1202"></a><span id="l3.1202">    */</span>
<a href="#l3.1203"></a><span id="l3.1203">   get sortImpliesTemporalOrdering() {</span>
<a href="#l3.1204"></a><span id="l3.1204">     if (!this._sort.length)</span>
<a href="#l3.1205"></a><span id="l3.1205">       return false;</span>
<a href="#l3.1206"></a><span id="l3.1206">     let sortType = this._sort[0][0];</span>
<a href="#l3.1207"></a><span id="l3.1207" class="difflineminus">-    return sortType == nsMsgViewSortType.byDate ||</span>
<a href="#l3.1208"></a><span id="l3.1208" class="difflineminus">-           sortType == nsMsgViewSortType.byReceived ||</span>
<a href="#l3.1209"></a><span id="l3.1209" class="difflineminus">-           sortType == nsMsgViewSortType.byId ||</span>
<a href="#l3.1210"></a><span id="l3.1210" class="difflineminus">-           sortType == nsMsgViewSortType.byThread;</span>
<a href="#l3.1211"></a><span id="l3.1211" class="difflineplus">+    return sortType == Ci.nsMsgViewSortType.byDate ||</span>
<a href="#l3.1212"></a><span id="l3.1212" class="difflineplus">+           sortType == Ci.nsMsgViewSortType.byReceived ||</span>
<a href="#l3.1213"></a><span id="l3.1213" class="difflineplus">+           sortType == Ci.nsMsgViewSortType.byId ||</span>
<a href="#l3.1214"></a><span id="l3.1214" class="difflineplus">+           sortType == Ci.nsMsgViewSortType.byThread;</span>
<a href="#l3.1215"></a><span id="l3.1215">   },</span>
<a href="#l3.1216"></a><span id="l3.1216"> </span>
<a href="#l3.1217"></a><span id="l3.1217" class="difflineminus">-  sortAscending: function() {</span>
<a href="#l3.1218"></a><span id="l3.1218" class="difflineplus">+  sortAscending() {</span>
<a href="#l3.1219"></a><span id="l3.1219">     if (!this.isSortedAscending)</span>
<a href="#l3.1220"></a><span id="l3.1220" class="difflineminus">-      this.magicSort(this._sort[0][0], nsMsgViewSortOrder.ascending);</span>
<a href="#l3.1221"></a><span id="l3.1221" class="difflineplus">+      this.magicSort(this._sort[0][0], Ci.nsMsgViewSortOrder.ascending);</span>
<a href="#l3.1222"></a><span id="l3.1222">   },</span>
<a href="#l3.1223"></a><span id="l3.1223" class="difflineminus">-  sortDescending: function() {</span>
<a href="#l3.1224"></a><span id="l3.1224" class="difflineplus">+  sortDescending() {</span>
<a href="#l3.1225"></a><span id="l3.1225">     if (!this.isSortedDescending)</span>
<a href="#l3.1226"></a><span id="l3.1226" class="difflineminus">-      this.magicSort(this._sort[0][0], nsMsgViewSortOrder.descending);</span>
<a href="#l3.1227"></a><span id="l3.1227" class="difflineplus">+      this.magicSort(this._sort[0][0], Ci.nsMsgViewSortOrder.descending);</span>
<a href="#l3.1228"></a><span id="l3.1228">   },</span>
<a href="#l3.1229"></a><span id="l3.1229"> </span>
<a href="#l3.1230"></a><span id="l3.1230">   /**</span>
<a href="#l3.1231"></a><span id="l3.1231">    * Explicit sort command.  We ignore all previous sort state and only apply</span>
<a href="#l3.1232"></a><span id="l3.1232">    *  what you tell us.  If you want implied secondary sort, use |magicSort|.</span>
<a href="#l3.1233"></a><span id="l3.1233">    * You must use this sort command, and never directly call the sort commands</span>
<a href="#l3.1234"></a><span id="l3.1234">    *  on the underlying db view!  If you do not, make sure to fight us every</span>
<a href="#l3.1235"></a><span id="l3.1235">    *   step of the way, because we will keep clobbering your manually applied</span>
<a href="#l3.1236"></a><span id="l3.1236">    *   sort.</span>
<a href="#l3.1237"></a><span id="l3.1237">    * For secondary and multiple custom column support, a byCustom aSortType and</span>
<a href="#l3.1238"></a><span id="l3.1238">    *  aSecondaryType must be the column name string.</span>
<a href="#l3.1239"></a><span id="l3.1239">    */</span>
<a href="#l3.1240"></a><span id="l3.1240" class="difflineminus">-  sort: function DBViewWrapper_sort(aSortType, aSortOrder,</span>
<a href="#l3.1241"></a><span id="l3.1241" class="difflineminus">-                                    aSecondaryType, aSecondaryOrder) {</span>
<a href="#l3.1242"></a><span id="l3.1242" class="difflineplus">+  sort(aSortType, aSortOrder, aSecondaryType, aSecondaryOrder) {</span>
<a href="#l3.1243"></a><span id="l3.1243">     // For sort changes, do not make a random selection if there is not</span>
<a href="#l3.1244"></a><span id="l3.1244">     // actually anything selected; some views do this (looking at xfvf).</span>
<a href="#l3.1245"></a><span id="l3.1245">     if (this.dbView.selection &amp;&amp; this.dbView.selection.count == 0)</span>
<a href="#l3.1246"></a><span id="l3.1246">       this.dbView.selection.currentIndex = -1;</span>
<a href="#l3.1247"></a><span id="l3.1247"> </span>
<a href="#l3.1248"></a><span id="l3.1248">     this._sort = [[aSortType, aSortOrder]];</span>
<a href="#l3.1249"></a><span id="l3.1249">     if (aSecondaryType != null &amp;&amp; aSecondaryOrder != null)</span>
<a href="#l3.1250"></a><span id="l3.1250">       this._sort.push([aSecondaryType, aSecondaryOrder]);</span>
<a href="#l3.1251"></a><span id="l3.1251">     // make sure the sort won't make the view angry...</span>
<a href="#l3.1252"></a><span id="l3.1252">     this._ensureValidSort();</span>
<a href="#l3.1253"></a><span id="l3.1253">     // if we are not in a view update, invoke the sort.</span>
<a href="#l3.1254"></a><span id="l3.1254">     if ((this._viewUpdateDepth == 0) &amp;&amp; this.dbView) {</span>
<a href="#l3.1255"></a><span id="l3.1255" class="difflineminus">-      for (let iSort = this._sort.length - 1; iSort &gt;=0; iSort--) {</span>
<a href="#l3.1256"></a><span id="l3.1256" class="difflineplus">+      for (let iSort = this._sort.length - 1; iSort &gt;= 0; iSort--) {</span>
<a href="#l3.1257"></a><span id="l3.1257">         // apply them in the reverse order</span>
<a href="#l3.1258"></a><span id="l3.1258">         let [sortType, sortOrder, sortCustomCol] = this._getSortDetails(iSort);</span>
<a href="#l3.1259"></a><span id="l3.1259">         if (sortCustomCol)</span>
<a href="#l3.1260"></a><span id="l3.1260">           this.dbView.curCustomColumn = sortCustomCol;</span>
<a href="#l3.1261"></a><span id="l3.1261">         this.dbView.sort(sortType, sortOrder);</span>
<a href="#l3.1262"></a><span id="l3.1262">       }</span>
<a href="#l3.1263"></a><span id="l3.1263">       // (only generate the event since we're not in a update batch)</span>
<a href="#l3.1264"></a><span id="l3.1264">       this.listener.onSortChanged();</span>
<a href="#l3.1265"></a><span id="l3.1265" class="difflineat">@@ -1566,38 +1530,38 @@ DBViewWrapper.prototype = {</span>
<a href="#l3.1266"></a><span id="l3.1266">   },</span>
<a href="#l3.1267"></a><span id="l3.1267"> </span>
<a href="#l3.1268"></a><span id="l3.1268">   /**</span>
<a href="#l3.1269"></a><span id="l3.1269">    * Logic that compensates for custom column identifiers being provided as</span>
<a href="#l3.1270"></a><span id="l3.1270">    *  sort types.</span>
<a href="#l3.1271"></a><span id="l3.1271">    *</span>
<a href="#l3.1272"></a><span id="l3.1272">    * @return [sort type, sort order, sort custom column name]</span>
<a href="#l3.1273"></a><span id="l3.1273">    */</span>
<a href="#l3.1274"></a><span id="l3.1274" class="difflineminus">-  _getSortDetails: function(aIndex) {</span>
<a href="#l3.1275"></a><span id="l3.1275" class="difflineplus">+  _getSortDetails(aIndex) {</span>
<a href="#l3.1276"></a><span id="l3.1276">     let [sortType, sortOrder] = this._sort[aIndex];</span>
<a href="#l3.1277"></a><span id="l3.1277">     let sortCustomColumn = null;</span>
<a href="#l3.1278"></a><span id="l3.1278">     let sortTypeType = typeof(sortType);</span>
<a href="#l3.1279"></a><span id="l3.1279">     if (sortTypeType != &quot;number&quot;) {</span>
<a href="#l3.1280"></a><span id="l3.1280">       sortCustomColumn = (sortTypeType == &quot;string&quot;) ? sortType : sortType.id;</span>
<a href="#l3.1281"></a><span id="l3.1281" class="difflineminus">-      sortType = nsMsgViewSortType.byCustom;</span>
<a href="#l3.1282"></a><span id="l3.1282" class="difflineplus">+      sortType = Ci.nsMsgViewSortType.byCustom;</span>
<a href="#l3.1283"></a><span id="l3.1283">     }</span>
<a href="#l3.1284"></a><span id="l3.1284"> </span>
<a href="#l3.1285"></a><span id="l3.1285">     return [sortType, sortOrder, sortCustomColumn];</span>
<a href="#l3.1286"></a><span id="l3.1286">   },</span>
<a href="#l3.1287"></a><span id="l3.1287"> </span>
<a href="#l3.1288"></a><span id="l3.1288">   /**</span>
<a href="#l3.1289"></a><span id="l3.1289">    * Accumulates implied secondary sorts based on multiple calls to this method.</span>
<a href="#l3.1290"></a><span id="l3.1290">    *  This is intended to be hooked up to be controlled by the UI.</span>
<a href="#l3.1291"></a><span id="l3.1291">    * Because we are lazy, we actually just poke the view's sort method and save</span>
<a href="#l3.1292"></a><span id="l3.1292">    *  the apparent secondary sort.  This also allows perfect compliance with the</span>
<a href="#l3.1293"></a><span id="l3.1293">    *  way this used to be implemented!</span>
<a href="#l3.1294"></a><span id="l3.1294">    * For secondary and multiple custom column support, a byCustom aSortType must</span>
<a href="#l3.1295"></a><span id="l3.1295">    *  be the column name string.</span>
<a href="#l3.1296"></a><span id="l3.1296">    */</span>
<a href="#l3.1297"></a><span id="l3.1297" class="difflineminus">-  magicSort: function DBViewWrapper_magicSort(aSortType, aSortOrder) {</span>
<a href="#l3.1298"></a><span id="l3.1298" class="difflineplus">+  magicSort(aSortType, aSortOrder) {</span>
<a href="#l3.1299"></a><span id="l3.1299">     if (this.dbView) {</span>
<a href="#l3.1300"></a><span id="l3.1300">       // For sort changes, do not make a random selection if there is not</span>
<a href="#l3.1301"></a><span id="l3.1301">       // actually anything selected; some views do this (looking at xfvf).</span>
<a href="#l3.1302"></a><span id="l3.1302">       if (this.dbView.selection &amp;&amp; this.dbView.selection.count == 0)</span>
<a href="#l3.1303"></a><span id="l3.1303">         this.dbView.selection.currentIndex = -1;</span>
<a href="#l3.1304"></a><span id="l3.1304"> </span>
<a href="#l3.1305"></a><span id="l3.1305">       // so, the thing we just set obviously will be there</span>
<a href="#l3.1306"></a><span id="l3.1306">       this._sort = [[aSortType, aSortOrder]];</span>
<a href="#l3.1307"></a><span id="l3.1307" class="difflineat">@@ -1605,19 +1569,19 @@ DBViewWrapper.prototype = {</span>
<a href="#l3.1308"></a><span id="l3.1308">       this._ensureValidSort();</span>
<a href="#l3.1309"></a><span id="l3.1309">       // get sort details, handle custom column as string sortType</span>
<a href="#l3.1310"></a><span id="l3.1310">       let [sortType, sortOrder, sortCustomCol] = this._getSortDetails(0);</span>
<a href="#l3.1311"></a><span id="l3.1311">       if (sortCustomCol)</span>
<a href="#l3.1312"></a><span id="l3.1312">         this.dbView.curCustomColumn = sortCustomCol;</span>
<a href="#l3.1313"></a><span id="l3.1313">       // apply the sort to see what happens secondary-wise</span>
<a href="#l3.1314"></a><span id="l3.1314">       this.dbView.sort(sortType, sortOrder);</span>
<a href="#l3.1315"></a><span id="l3.1315">       // there is only a secondary sort if it's not none and not the same.</span>
<a href="#l3.1316"></a><span id="l3.1316" class="difflineminus">-      if (this.dbView.secondarySortType != nsMsgViewSortType.byNone &amp;&amp;</span>
<a href="#l3.1317"></a><span id="l3.1317" class="difflineplus">+      if (this.dbView.secondarySortType != Ci.nsMsgViewSortType.byNone &amp;&amp;</span>
<a href="#l3.1318"></a><span id="l3.1318">           (this.dbView.secondarySortType != sortType ||</span>
<a href="#l3.1319"></a><span id="l3.1319" class="difflineminus">-           (this.dbView.secondarySortType == nsMsgViewSortType.byCustom &amp;&amp;</span>
<a href="#l3.1320"></a><span id="l3.1320" class="difflineplus">+           (this.dbView.secondarySortType == Ci.nsMsgViewSortType.byCustom &amp;&amp;</span>
<a href="#l3.1321"></a><span id="l3.1321">             this.dbView.secondaryCustomColumn != sortCustomCol)))</span>
<a href="#l3.1322"></a><span id="l3.1322">         this._sort.push([this.dbView.secondaryCustomColumn || this.dbView.secondarySortType,</span>
<a href="#l3.1323"></a><span id="l3.1323">                          this.dbView.secondarySortOrder]);</span>
<a href="#l3.1324"></a><span id="l3.1324">       // only tell our listener if we're not in a view update batch</span>
<a href="#l3.1325"></a><span id="l3.1325">       if (this._viewUpdateDepth == 0)</span>
<a href="#l3.1326"></a><span id="l3.1326">         this.listener.onSortChanged();</span>
<a href="#l3.1327"></a><span id="l3.1327">     }</span>
<a href="#l3.1328"></a><span id="l3.1328">   },</span>
<a href="#l3.1329"></a><span id="l3.1329" class="difflineat">@@ -1625,145 +1589,145 @@ DBViewWrapper.prototype = {</span>
<a href="#l3.1330"></a><span id="l3.1330">   /**</span>
<a href="#l3.1331"></a><span id="l3.1331">    * Make sure the current sort is valid under our other constraints, make it</span>
<a href="#l3.1332"></a><span id="l3.1332">    *  safe if it is not.  Most specifically, some sorts are illegal when</span>
<a href="#l3.1333"></a><span id="l3.1333">    *  grouping by sort, and we reset the sort to date in those cases.</span>
<a href="#l3.1334"></a><span id="l3.1334">    *</span>
<a href="#l3.1335"></a><span id="l3.1335">    * @param aViewFlags Optional set of view flags to consider instead of the</span>
<a href="#l3.1336"></a><span id="l3.1336">    *     potentially live view flags.</span>
<a href="#l3.1337"></a><span id="l3.1337">    */</span>
<a href="#l3.1338"></a><span id="l3.1338" class="difflineminus">-  _ensureValidSort: function DBViewWrapper_ensureValidSort(aViewFlags) {</span>
<a href="#l3.1339"></a><span id="l3.1339" class="difflineplus">+  _ensureValidSort(aViewFlags) {</span>
<a href="#l3.1340"></a><span id="l3.1340">     if ((aViewFlags != null ? aViewFlags : this._viewFlags) &amp;</span>
<a href="#l3.1341"></a><span id="l3.1341" class="difflineminus">-        nsMsgViewFlagsType.kGroupBySort) {</span>
<a href="#l3.1342"></a><span id="l3.1342" class="difflineplus">+        Ci.nsMsgViewFlagsType.kGroupBySort) {</span>
<a href="#l3.1343"></a><span id="l3.1343">       // We cannot be sorting by thread, id, none, or size.  If we are, switch</span>
<a href="#l3.1344"></a><span id="l3.1344">       //  to sorting by date.</span>
<a href="#l3.1345"></a><span id="l3.1345">       for (let sortPair of this._sort) {</span>
<a href="#l3.1346"></a><span id="l3.1346">         let sortType = sortPair[0];</span>
<a href="#l3.1347"></a><span id="l3.1347" class="difflineminus">-        if (sortType == nsMsgViewSortType.byThread ||</span>
<a href="#l3.1348"></a><span id="l3.1348" class="difflineminus">-            sortType == nsMsgViewSortType.byId ||</span>
<a href="#l3.1349"></a><span id="l3.1349" class="difflineminus">-            sortType == nsMsgViewSortType.byNone ||</span>
<a href="#l3.1350"></a><span id="l3.1350" class="difflineminus">-            sortType == nsMsgViewSortType.bySize) {</span>
<a href="#l3.1351"></a><span id="l3.1351" class="difflineminus">-          this._sort = [[nsMsgViewSortType.byDate, this._sort[0][1]]];</span>
<a href="#l3.1352"></a><span id="l3.1352" class="difflineplus">+        if (sortType == Ci.nsMsgViewSortType.byThread ||</span>
<a href="#l3.1353"></a><span id="l3.1353" class="difflineplus">+            sortType == Ci.nsMsgViewSortType.byId ||</span>
<a href="#l3.1354"></a><span id="l3.1354" class="difflineplus">+            sortType == Ci.nsMsgViewSortType.byNone ||</span>
<a href="#l3.1355"></a><span id="l3.1355" class="difflineplus">+            sortType == Ci.nsMsgViewSortType.bySize) {</span>
<a href="#l3.1356"></a><span id="l3.1356" class="difflineplus">+          this._sort = [[Ci.nsMsgViewSortType.byDate, this._sort[0][1]]];</span>
<a href="#l3.1357"></a><span id="l3.1357">           break;</span>
<a href="#l3.1358"></a><span id="l3.1358">         }</span>
<a href="#l3.1359"></a><span id="l3.1359">       }</span>
<a href="#l3.1360"></a><span id="l3.1360">     }</span>
<a href="#l3.1361"></a><span id="l3.1361">   },</span>
<a href="#l3.1362"></a><span id="l3.1362"> </span>
<a href="#l3.1363"></a><span id="l3.1363">   /**</span>
<a href="#l3.1364"></a><span id="l3.1364">    * @return true if we are grouped-by-sort, false if not.  If we are not</span>
<a href="#l3.1365"></a><span id="l3.1365">    *     grouped by sort, then we are either threaded or unthreaded; check</span>
<a href="#l3.1366"></a><span id="l3.1366">    *     the showThreaded property to find out which of those it is.</span>
<a href="#l3.1367"></a><span id="l3.1367">    */</span>
<a href="#l3.1368"></a><span id="l3.1368">   get showGroupedBySort() {</span>
<a href="#l3.1369"></a><span id="l3.1369" class="difflineminus">-    return Boolean(this._viewFlags &amp; nsMsgViewFlagsType.kGroupBySort);</span>
<a href="#l3.1370"></a><span id="l3.1370" class="difflineplus">+    return Boolean(this._viewFlags &amp; Ci.nsMsgViewFlagsType.kGroupBySort);</span>
<a href="#l3.1371"></a><span id="l3.1371">   },</span>
<a href="#l3.1372"></a><span id="l3.1372">   /**</span>
<a href="#l3.1373"></a><span id="l3.1373">    * Enable grouped-by-sort which is mutually exclusive with threaded display</span>
<a href="#l3.1374"></a><span id="l3.1374">    *  (as controlled/exposed by showThreaded).  Grouped-by-sort is not legal</span>
<a href="#l3.1375"></a><span id="l3.1375">    *  for sorts by thread/id/size/none and enabling this will cause us to change</span>
<a href="#l3.1376"></a><span id="l3.1376">    *  our sort to by date in those cases.</span>
<a href="#l3.1377"></a><span id="l3.1377">    */</span>
<a href="#l3.1378"></a><span id="l3.1378">   set showGroupedBySort(aShowGroupBySort) {</span>
<a href="#l3.1379"></a><span id="l3.1379">     if (this.showGroupedBySort != aShowGroupBySort) {</span>
<a href="#l3.1380"></a><span id="l3.1380">       if (aShowGroupBySort) {</span>
<a href="#l3.1381"></a><span id="l3.1381">         // For virtual single folders, the kExpandAll flag must be set.</span>
<a href="#l3.1382"></a><span id="l3.1382">         // Do not apply the flag change until we have made the sort safe.</span>
<a href="#l3.1383"></a><span id="l3.1383">         let viewFlags = this._viewFlags |</span>
<a href="#l3.1384"></a><span id="l3.1384" class="difflineminus">-                        nsMsgViewFlagsType.kGroupBySort |</span>
<a href="#l3.1385"></a><span id="l3.1385" class="difflineminus">-                        nsMsgViewFlagsType.kExpandAll |</span>
<a href="#l3.1386"></a><span id="l3.1386" class="difflineminus">-                        nsMsgViewFlagsType.kThreadedDisplay;</span>
<a href="#l3.1387"></a><span id="l3.1387" class="difflineplus">+                        Ci.nsMsgViewFlagsType.kGroupBySort |</span>
<a href="#l3.1388"></a><span id="l3.1388" class="difflineplus">+                        Ci.nsMsgViewFlagsType.kExpandAll |</span>
<a href="#l3.1389"></a><span id="l3.1389" class="difflineplus">+                        Ci.nsMsgViewFlagsType.kThreadedDisplay;</span>
<a href="#l3.1390"></a><span id="l3.1390">         this._ensureValidSort(viewFlags);</span>
<a href="#l3.1391"></a><span id="l3.1391">         this._viewFlags = viewFlags;</span>
<a href="#l3.1392"></a><span id="l3.1392" class="difflineplus">+      } else {</span>
<a href="#l3.1393"></a><span id="l3.1393" class="difflineplus">+        // maybe we shouldn't do anything in this case?</span>
<a href="#l3.1394"></a><span id="l3.1394" class="difflineplus">+        this._viewFlags &amp;= ~(Ci.nsMsgViewFlagsType.kGroupBySort |</span>
<a href="#l3.1395"></a><span id="l3.1395" class="difflineplus">+                             Ci.nsMsgViewFlagsType.kThreadedDisplay);</span>
<a href="#l3.1396"></a><span id="l3.1396">       }</span>
<a href="#l3.1397"></a><span id="l3.1397" class="difflineminus">-      // maybe we shouldn't do anything in this case?</span>
<a href="#l3.1398"></a><span id="l3.1398" class="difflineminus">-      else</span>
<a href="#l3.1399"></a><span id="l3.1399" class="difflineminus">-        this._viewFlags &amp;= ~(nsMsgViewFlagsType.kGroupBySort |</span>
<a href="#l3.1400"></a><span id="l3.1400" class="difflineminus">-                             nsMsgViewFlagsType.kThreadedDisplay);</span>
<a href="#l3.1401"></a><span id="l3.1401">     }</span>
<a href="#l3.1402"></a><span id="l3.1402">   },</span>
<a href="#l3.1403"></a><span id="l3.1403"> </span>
<a href="#l3.1404"></a><span id="l3.1404">   /**</span>
<a href="#l3.1405"></a><span id="l3.1405">    * Are we showing ignored/killed threads?</span>
<a href="#l3.1406"></a><span id="l3.1406">    */</span>
<a href="#l3.1407"></a><span id="l3.1407">   get showIgnored() {</span>
<a href="#l3.1408"></a><span id="l3.1408" class="difflineminus">-    return Boolean(this._viewFlags &amp; nsMsgViewFlagsType.kShowIgnored);</span>
<a href="#l3.1409"></a><span id="l3.1409" class="difflineplus">+    return Boolean(this._viewFlags &amp; Ci.nsMsgViewFlagsType.kShowIgnored);</span>
<a href="#l3.1410"></a><span id="l3.1410">   },</span>
<a href="#l3.1411"></a><span id="l3.1411">   /**</span>
<a href="#l3.1412"></a><span id="l3.1412">    * Set whether we are showing ignored/killed threads.</span>
<a href="#l3.1413"></a><span id="l3.1413">    */</span>
<a href="#l3.1414"></a><span id="l3.1414">   set showIgnored(aShowIgnored) {</span>
<a href="#l3.1415"></a><span id="l3.1415">     if (this.showIgnored == aShowIgnored)</span>
<a href="#l3.1416"></a><span id="l3.1416">       return;</span>
<a href="#l3.1417"></a><span id="l3.1417"> </span>
<a href="#l3.1418"></a><span id="l3.1418">     if (aShowIgnored)</span>
<a href="#l3.1419"></a><span id="l3.1419" class="difflineminus">-      this._viewFlags |= nsMsgViewFlagsType.kShowIgnored;</span>
<a href="#l3.1420"></a><span id="l3.1420" class="difflineplus">+      this._viewFlags |= Ci.nsMsgViewFlagsType.kShowIgnored;</span>
<a href="#l3.1421"></a><span id="l3.1421">     else</span>
<a href="#l3.1422"></a><span id="l3.1422" class="difflineminus">-      this._viewFlags &amp;= ~nsMsgViewFlagsType.kShowIgnored;</span>
<a href="#l3.1423"></a><span id="l3.1423" class="difflineplus">+      this._viewFlags &amp;= ~Ci.nsMsgViewFlagsType.kShowIgnored;</span>
<a href="#l3.1424"></a><span id="l3.1424">   },</span>
<a href="#l3.1425"></a><span id="l3.1425"> </span>
<a href="#l3.1426"></a><span id="l3.1426">   /**</span>
<a href="#l3.1427"></a><span id="l3.1427">    * @return true if we are in threaded display (as opposed to grouped or</span>
<a href="#l3.1428"></a><span id="l3.1428">    *     unthreaded.)</span>
<a href="#l3.1429"></a><span id="l3.1429">    */</span>
<a href="#l3.1430"></a><span id="l3.1430">   get showThreaded() {</span>
<a href="#l3.1431"></a><span id="l3.1431" class="difflineminus">-    return (this._viewFlags &amp; nsMsgViewFlagsType.kThreadedDisplay) &amp;&amp;</span>
<a href="#l3.1432"></a><span id="l3.1432" class="difflineminus">-           !(this._viewFlags &amp; nsMsgViewFlagsType.kGroupBySort);</span>
<a href="#l3.1433"></a><span id="l3.1433" class="difflineplus">+    return (this._viewFlags &amp; Ci.nsMsgViewFlagsType.kThreadedDisplay) &amp;&amp;</span>
<a href="#l3.1434"></a><span id="l3.1434" class="difflineplus">+           !(this._viewFlags &amp; Ci.nsMsgViewFlagsType.kGroupBySort);</span>
<a href="#l3.1435"></a><span id="l3.1435">   },</span>
<a href="#l3.1436"></a><span id="l3.1436">   /**</span>
<a href="#l3.1437"></a><span id="l3.1437">    * Set us to threaded display mode when set to true.  If we are already in</span>
<a href="#l3.1438"></a><span id="l3.1438">    *  threaded display mode, we do nothing.  If you want to set us to unthreaded</span>
<a href="#l3.1439"></a><span id="l3.1439">    *  mode, set |showUnthreaded| to true.  (Because we have three modes of</span>
<a href="#l3.1440"></a><span id="l3.1440">    *  operation: unthreaded, threaded, and grouped-by-sort, we are a tri-state</span>
<a href="#l3.1441"></a><span id="l3.1441">    *  and setting us to false is ambiguous.  We should probably be using a</span>
<a href="#l3.1442"></a><span id="l3.1442">    *  single attribute with three constants...)</span>
<a href="#l3.1443"></a><span id="l3.1443">    */</span>
<a href="#l3.1444"></a><span id="l3.1444">   set showThreaded(aShowThreaded) {</span>
<a href="#l3.1445"></a><span id="l3.1445">     if (this.showThreaded != aShowThreaded) {</span>
<a href="#l3.1446"></a><span id="l3.1446">       let viewFlags = this._viewFlags;</span>
<a href="#l3.1447"></a><span id="l3.1447">       if (aShowThreaded)</span>
<a href="#l3.1448"></a><span id="l3.1448" class="difflineminus">-        viewFlags |= nsMsgViewFlagsType.kThreadedDisplay;</span>
<a href="#l3.1449"></a><span id="l3.1449" class="difflineplus">+        viewFlags |= Ci.nsMsgViewFlagsType.kThreadedDisplay;</span>
<a href="#l3.1450"></a><span id="l3.1450">       // maybe we shouldn't do anything in this case?</span>
<a href="#l3.1451"></a><span id="l3.1451">       else</span>
<a href="#l3.1452"></a><span id="l3.1452" class="difflineminus">-        viewFlags &amp;= ~nsMsgViewFlagsType.kThreadedDisplay;</span>
<a href="#l3.1453"></a><span id="l3.1453" class="difflineplus">+        viewFlags &amp;= ~Ci.nsMsgViewFlagsType.kThreadedDisplay;</span>
<a href="#l3.1454"></a><span id="l3.1454">       // lose the group bit...</span>
<a href="#l3.1455"></a><span id="l3.1455" class="difflineminus">-      viewFlags &amp;= ~nsMsgViewFlagsType.kGroupBySort;</span>
<a href="#l3.1456"></a><span id="l3.1456" class="difflineplus">+      viewFlags &amp;= ~Ci.nsMsgViewFlagsType.kGroupBySort;</span>
<a href="#l3.1457"></a><span id="l3.1457">       this._viewFlags = viewFlags;</span>
<a href="#l3.1458"></a><span id="l3.1458">     }</span>
<a href="#l3.1459"></a><span id="l3.1459">   },</span>
<a href="#l3.1460"></a><span id="l3.1460"> </span>
<a href="#l3.1461"></a><span id="l3.1461">   /**</span>
<a href="#l3.1462"></a><span id="l3.1462">    * @return true if we are in unthreaded mode (which means not threaded and</span>
<a href="#l3.1463"></a><span id="l3.1463">    *     not grouped by sort).</span>
<a href="#l3.1464"></a><span id="l3.1464">    */</span>
<a href="#l3.1465"></a><span id="l3.1465">   get showUnthreaded() {</span>
<a href="#l3.1466"></a><span id="l3.1466" class="difflineminus">-    return Boolean(!(this._viewFlags &amp; (nsMsgViewFlagsType.kGroupBySort |</span>
<a href="#l3.1467"></a><span id="l3.1467" class="difflineminus">-                                        nsMsgViewFlagsType.kThreadedDisplay)));</span>
<a href="#l3.1468"></a><span id="l3.1468" class="difflineplus">+    return Boolean(!(this._viewFlags &amp; (Ci.nsMsgViewFlagsType.kGroupBySort |</span>
<a href="#l3.1469"></a><span id="l3.1469" class="difflineplus">+                                        Ci.nsMsgViewFlagsType.kThreadedDisplay)));</span>
<a href="#l3.1470"></a><span id="l3.1470">   },</span>
<a href="#l3.1471"></a><span id="l3.1471">   /**</span>
<a href="#l3.1472"></a><span id="l3.1472">    * Set to true to put us in unthreaded mode (which means not threaded and</span>
<a href="#l3.1473"></a><span id="l3.1473">    *  not grouped by sort).</span>
<a href="#l3.1474"></a><span id="l3.1474">    */</span>
<a href="#l3.1475"></a><span id="l3.1475">   set showUnthreaded(aShowUnthreaded) {</span>
<a href="#l3.1476"></a><span id="l3.1476">     if (this.showUnthreaded != aShowUnthreaded) {</span>
<a href="#l3.1477"></a><span id="l3.1477">       if (aShowUnthreaded)</span>
<a href="#l3.1478"></a><span id="l3.1478" class="difflineminus">-        this._viewFlags &amp;= ~(nsMsgViewFlagsType.kGroupBySort |</span>
<a href="#l3.1479"></a><span id="l3.1479" class="difflineminus">-                             nsMsgViewFlagsType.kThreadedDisplay);</span>
<a href="#l3.1480"></a><span id="l3.1480" class="difflineplus">+        this._viewFlags &amp;= ~(Ci.nsMsgViewFlagsType.kGroupBySort |</span>
<a href="#l3.1481"></a><span id="l3.1481" class="difflineplus">+                             Ci.nsMsgViewFlagsType.kThreadedDisplay);</span>
<a href="#l3.1482"></a><span id="l3.1482">       // maybe we shouldn't do anything in this case?</span>
<a href="#l3.1483"></a><span id="l3.1483">       else</span>
<a href="#l3.1484"></a><span id="l3.1484" class="difflineminus">-        this._viewFlags = (this._viewFlags &amp; ~nsMsgViewFlagsType.kGroupBySort) |</span>
<a href="#l3.1485"></a><span id="l3.1485" class="difflineminus">-                            nsMsgViewFlagsType.kThreadedDisplay;</span>
<a href="#l3.1486"></a><span id="l3.1486" class="difflineplus">+        this._viewFlags = (this._viewFlags &amp; ~Ci.nsMsgViewFlagsType.kGroupBySort) |</span>
<a href="#l3.1487"></a><span id="l3.1487" class="difflineplus">+                            Ci.nsMsgViewFlagsType.kThreadedDisplay;</span>
<a href="#l3.1488"></a><span id="l3.1488">     }</span>
<a href="#l3.1489"></a><span id="l3.1489">   },</span>
<a href="#l3.1490"></a><span id="l3.1490"> </span>
<a href="#l3.1491"></a><span id="l3.1491">   /**</span>
<a href="#l3.1492"></a><span id="l3.1492">    * @return true if we are showing only unread messages.</span>
<a href="#l3.1493"></a><span id="l3.1493">    */</span>
<a href="#l3.1494"></a><span id="l3.1494">   get showUnreadOnly() {</span>
<a href="#l3.1495"></a><span id="l3.1495" class="difflineminus">-    return Boolean(this._viewFlags &amp; nsMsgViewFlagsType.kUnreadOnly);</span>
<a href="#l3.1496"></a><span id="l3.1496" class="difflineplus">+    return Boolean(this._viewFlags &amp; Ci.nsMsgViewFlagsType.kUnreadOnly);</span>
<a href="#l3.1497"></a><span id="l3.1497">   },</span>
<a href="#l3.1498"></a><span id="l3.1498">   /**</span>
<a href="#l3.1499"></a><span id="l3.1499">    * Enable/disable showing only unread messages using the view's flag-based</span>
<a href="#l3.1500"></a><span id="l3.1500">    *  mechanism.  This functionality can also be approximated using a mail</span>
<a href="#l3.1501"></a><span id="l3.1501">    *  view (or other search) for unread messages.  There also exist special</span>
<a href="#l3.1502"></a><span id="l3.1502">    *  views for showing messages with unread threads which is different and</span>
<a href="#l3.1503"></a><span id="l3.1503">    *  has serious limitations because of its nature.</span>
<a href="#l3.1504"></a><span id="l3.1504">    * Setting anything to this value clears any active special view because the</span>
<a href="#l3.1505"></a><span id="l3.1505" class="difflineat">@@ -1773,19 +1737,19 @@ DBViewWrapper.prototype = {</span>
<a href="#l3.1506"></a><span id="l3.1506">   set showUnreadOnly(aShowUnreadOnly) {</span>
<a href="#l3.1507"></a><span id="l3.1507">     if (this._specialView || (this.showUnreadOnly != aShowUnreadOnly)) {</span>
<a href="#l3.1508"></a><span id="l3.1508">       let viewRebuildRequired = (this._specialView != null);</span>
<a href="#l3.1509"></a><span id="l3.1509">       this._specialView = null;</span>
<a href="#l3.1510"></a><span id="l3.1510">       if (viewRebuildRequired)</span>
<a href="#l3.1511"></a><span id="l3.1511">         this.beginViewUpdate();</span>
<a href="#l3.1512"></a><span id="l3.1512"> </span>
<a href="#l3.1513"></a><span id="l3.1513">       if (aShowUnreadOnly)</span>
<a href="#l3.1514"></a><span id="l3.1514" class="difflineminus">-        this._viewFlags |= nsMsgViewFlagsType.kUnreadOnly;</span>
<a href="#l3.1515"></a><span id="l3.1515" class="difflineplus">+        this._viewFlags |= Ci.nsMsgViewFlagsType.kUnreadOnly;</span>
<a href="#l3.1516"></a><span id="l3.1516">       else</span>
<a href="#l3.1517"></a><span id="l3.1517" class="difflineminus">-        this._viewFlags &amp;= ~nsMsgViewFlagsType.kUnreadOnly;</span>
<a href="#l3.1518"></a><span id="l3.1518" class="difflineplus">+        this._viewFlags &amp;= ~Ci.nsMsgViewFlagsType.kUnreadOnly;</span>
<a href="#l3.1519"></a><span id="l3.1519"> </span>
<a href="#l3.1520"></a><span id="l3.1520">       if (viewRebuildRequired)</span>
<a href="#l3.1521"></a><span id="l3.1521">         this.endViewUpdate();</span>
<a href="#l3.1522"></a><span id="l3.1522">     }</span>
<a href="#l3.1523"></a><span id="l3.1523">   },</span>
<a href="#l3.1524"></a><span id="l3.1524"> </span>
<a href="#l3.1525"></a><span id="l3.1525">   /**</span>
<a href="#l3.1526"></a><span id="l3.1526">    * Read-only attribute indicating if a 'special view' is in use.  There are</span>
<a href="#l3.1527"></a><span id="l3.1527" class="difflineat">@@ -1799,63 +1763,63 @@ DBViewWrapper.prototype = {</span>
<a href="#l3.1528"></a><span id="l3.1528">     return this._specialView != null;</span>
<a href="#l3.1529"></a><span id="l3.1529">   },</span>
<a href="#l3.1530"></a><span id="l3.1530">   /**</span>
<a href="#l3.1531"></a><span id="l3.1531">    * Private helper for use by the specialView* setters that handles the common</span>
<a href="#l3.1532"></a><span id="l3.1532">    *  logic.  We don't want this method to be public because we want it to be</span>
<a href="#l3.1533"></a><span id="l3.1533">    *  feasible for the view hierarchy and its enumerations to go away without</span>
<a href="#l3.1534"></a><span id="l3.1534">    *  code outside this class having to care so much.</span>
<a href="#l3.1535"></a><span id="l3.1535">    */</span>
<a href="#l3.1536"></a><span id="l3.1536" class="difflineminus">-  _setSpecialView: function DBViewWrapper__setSpecialView(aViewEnum) {</span>
<a href="#l3.1537"></a><span id="l3.1537" class="difflineplus">+  _setSpecialView(aViewEnum) {</span>
<a href="#l3.1538"></a><span id="l3.1538">     // special views simply cannot work for virtual folders.  explode.</span>
<a href="#l3.1539"></a><span id="l3.1539">     if (this.isVirtual)</span>
<a href="#l3.1540"></a><span id="l3.1540" class="difflineminus">-      throw new Exception(&quot;Virtual folders cannot use special views!&quot;);</span>
<a href="#l3.1541"></a><span id="l3.1541" class="difflineplus">+      throw new Error(&quot;Virtual folders cannot use special views!&quot;);</span>
<a href="#l3.1542"></a><span id="l3.1542">     this.beginViewUpdate();</span>
<a href="#l3.1543"></a><span id="l3.1543">     // all special views imply a threaded view</span>
<a href="#l3.1544"></a><span id="l3.1544">     this.showThreaded = true;</span>
<a href="#l3.1545"></a><span id="l3.1545">     this._specialView = aViewEnum;</span>
<a href="#l3.1546"></a><span id="l3.1546">     // We clear the search for paranoia/correctness reasons.  However, the UI</span>
<a href="#l3.1547"></a><span id="l3.1547">     //  layer is currently responsible for making sure these are already zeroed</span>
<a href="#l3.1548"></a><span id="l3.1548">     //  out.</span>
<a href="#l3.1549"></a><span id="l3.1549">     this.search.clear();</span>
<a href="#l3.1550"></a><span id="l3.1550">     this.endViewUpdate();</span>
<a href="#l3.1551"></a><span id="l3.1551">   },</span>
<a href="#l3.1552"></a><span id="l3.1552">   /**</span>
<a href="#l3.1553"></a><span id="l3.1553">    * @return true if the special view that shows threads with unread messages</span>
<a href="#l3.1554"></a><span id="l3.1554">    *     in them is active.</span>
<a href="#l3.1555"></a><span id="l3.1555">    */</span>
<a href="#l3.1556"></a><span id="l3.1556">   get specialViewThreadsWithUnread() {</span>
<a href="#l3.1557"></a><span id="l3.1557" class="difflineminus">-    return this._specialView == nsMsgViewType.eShowThreadsWithUnread;</span>
<a href="#l3.1558"></a><span id="l3.1558" class="difflineplus">+    return this._specialView == Ci.nsMsgViewType.eShowThreadsWithUnread;</span>
<a href="#l3.1559"></a><span id="l3.1559">   },</span>
<a href="#l3.1560"></a><span id="l3.1560">   /**</span>
<a href="#l3.1561"></a><span id="l3.1561">    * If true is assigned, attempts to enable the special view that shows threads</span>
<a href="#l3.1562"></a><span id="l3.1562">    *  with unread messages in them.  This will not work on virtual folders</span>
<a href="#l3.1563"></a><span id="l3.1563">    *  because of the inheritance hierarchy.</span>
<a href="#l3.1564"></a><span id="l3.1564">    * Any mechanism that requires search terms (quick search, mailviews) will be</span>
<a href="#l3.1565"></a><span id="l3.1565">    *  reset/disabled when enabling this view.</span>
<a href="#l3.1566"></a><span id="l3.1566">    */</span>
<a href="#l3.1567"></a><span id="l3.1567">   set specialViewThreadsWithUnread(aSpecial) {</span>
<a href="#l3.1568"></a><span id="l3.1568" class="difflineminus">-    this._setSpecialView(nsMsgViewType.eShowThreadsWithUnread);</span>
<a href="#l3.1569"></a><span id="l3.1569" class="difflineplus">+    this._setSpecialView(Ci.nsMsgViewType.eShowThreadsWithUnread);</span>
<a href="#l3.1570"></a><span id="l3.1570">   },</span>
<a href="#l3.1571"></a><span id="l3.1571">   /**</span>
<a href="#l3.1572"></a><span id="l3.1572">    * @return true if the special view that shows watched threads with unread</span>
<a href="#l3.1573"></a><span id="l3.1573">    *     messages in them is active.</span>
<a href="#l3.1574"></a><span id="l3.1574">    */</span>
<a href="#l3.1575"></a><span id="l3.1575">   get specialViewWatchedThreadsWithUnread() {</span>
<a href="#l3.1576"></a><span id="l3.1576" class="difflineminus">-    return this._specialView == nsMsgViewType.eShowWatchedThreadsWithUnread;</span>
<a href="#l3.1577"></a><span id="l3.1577" class="difflineplus">+    return this._specialView == Ci.nsMsgViewType.eShowWatchedThreadsWithUnread;</span>
<a href="#l3.1578"></a><span id="l3.1578">   },</span>
<a href="#l3.1579"></a><span id="l3.1579">   /**</span>
<a href="#l3.1580"></a><span id="l3.1580">    * If true is assigned, attempts to enable the special view that shows watched</span>
<a href="#l3.1581"></a><span id="l3.1581">    *  threads with unread messages in them.  This will not work on virtual</span>
<a href="#l3.1582"></a><span id="l3.1582">    *  folders because of the inheritance hierarchy.</span>
<a href="#l3.1583"></a><span id="l3.1583">    * Any mechanism that requires search terms (quick search, mailviews) will be</span>
<a href="#l3.1584"></a><span id="l3.1584">    *  reset/disabled when enabling this view.</span>
<a href="#l3.1585"></a><span id="l3.1585">    */</span>
<a href="#l3.1586"></a><span id="l3.1586">   set specialViewWatchedThreadsWithUnread(aSpecial) {</span>
<a href="#l3.1587"></a><span id="l3.1587" class="difflineminus">-    this._setSpecialView(nsMsgViewType.eShowWatchedThreadsWithUnread);</span>
<a href="#l3.1588"></a><span id="l3.1588" class="difflineplus">+    this._setSpecialView(Ci.nsMsgViewType.eShowWatchedThreadsWithUnread);</span>
<a href="#l3.1589"></a><span id="l3.1589">   },</span>
<a href="#l3.1590"></a><span id="l3.1590"> </span>
<a href="#l3.1591"></a><span id="l3.1591">   get mailViewIndex() {</span>
<a href="#l3.1592"></a><span id="l3.1592">     return this._mailViewIndex;</span>
<a href="#l3.1593"></a><span id="l3.1593">   },</span>
<a href="#l3.1594"></a><span id="l3.1594"> </span>
<a href="#l3.1595"></a><span id="l3.1595">   get mailViewData() {</span>
<a href="#l3.1596"></a><span id="l3.1596">     return this._mailViewData;</span>
<a href="#l3.1597"></a><span id="l3.1597" class="difflineat">@@ -1869,18 +1833,17 @@ DBViewWrapper.prototype = {</span>
<a href="#l3.1598"></a><span id="l3.1598">    * @param aMailViewIndex The view to use, one of the kViewItem* constants from</span>
<a href="#l3.1599"></a><span id="l3.1599">    *     msgViewPickerOverlay.js OR the name of a custom view.  (It's really up</span>
<a href="#l3.1600"></a><span id="l3.1600">    *     to MailViewManager.getMailViewByIndex...)</span>
<a href="#l3.1601"></a><span id="l3.1601">    * @param aData Some piece of data appropriate to the mail view, currently</span>
<a href="#l3.1602"></a><span id="l3.1602">    *     this is only used for the tag name for kViewItemTags (sans the &quot;:&quot;).</span>
<a href="#l3.1603"></a><span id="l3.1603">    * @param aDoNotPersist If true, we don't save this change to the db folder</span>
<a href="#l3.1604"></a><span id="l3.1604">    *     info.  This is intended for internal use only.</span>
<a href="#l3.1605"></a><span id="l3.1605">    */</span>
<a href="#l3.1606"></a><span id="l3.1606" class="difflineminus">-  setMailView: function DBViewWrapper_setMailView(aMailViewIndex, aData,</span>
<a href="#l3.1607"></a><span id="l3.1607" class="difflineminus">-                                                  aDoNotPersist) {</span>
<a href="#l3.1608"></a><span id="l3.1608" class="difflineplus">+  setMailView(aMailViewIndex, aData, aDoNotPersist) {</span>
<a href="#l3.1609"></a><span id="l3.1609">     let mailViewDef = MailViewManager.getMailViewByIndex(aMailViewIndex);</span>
<a href="#l3.1610"></a><span id="l3.1610"> </span>
<a href="#l3.1611"></a><span id="l3.1611">     this._mailViewIndex = aMailViewIndex;</span>
<a href="#l3.1612"></a><span id="l3.1612">     this._mailViewData = aData;</span>
<a href="#l3.1613"></a><span id="l3.1613"> </span>
<a href="#l3.1614"></a><span id="l3.1614">     // - update the search terms</span>
<a href="#l3.1615"></a><span id="l3.1615">     // (this triggers a view update if we are not in a batch)</span>
<a href="#l3.1616"></a><span id="l3.1616">     this.search.viewTerms = mailViewDef.makeTerms(this.search.session,</span>
<a href="#l3.1617"></a><span id="l3.1617" class="difflineat">@@ -1907,44 +1870,43 @@ DBViewWrapper.prototype = {</span>
<a href="#l3.1618"></a><span id="l3.1618">     // we don't need to notify the view picker to update because the makeActive</span>
<a href="#l3.1619"></a><span id="l3.1619">     //  that cascades out of the view update will do it for us.</span>
<a href="#l3.1620"></a><span id="l3.1620">   },</span>
<a href="#l3.1621"></a><span id="l3.1621"> </span>
<a href="#l3.1622"></a><span id="l3.1622">   /**</span>
<a href="#l3.1623"></a><span id="l3.1623">    * @return true if the row at the given index contains a collapsed thread,</span>
<a href="#l3.1624"></a><span id="l3.1624">    *     false if the row is a collapsed group or anything else.</span>
<a href="#l3.1625"></a><span id="l3.1625">    */</span>
<a href="#l3.1626"></a><span id="l3.1626" class="difflineminus">-  isCollapsedThreadAtIndex:</span>
<a href="#l3.1627"></a><span id="l3.1627" class="difflineminus">-      function DBViewWrapper_isCollapsedThreadAtIndex(aViewIndex) {</span>
<a href="#l3.1628"></a><span id="l3.1628" class="difflineplus">+  isCollapsedThreadAtIndex(aViewIndex) {</span>
<a href="#l3.1629"></a><span id="l3.1629">     let flags = this.dbView.getFlagsAt(aViewIndex);</span>
<a href="#l3.1630"></a><span id="l3.1630" class="difflineminus">-    return (flags &amp; nsMsgMessageFlags.Elided) &amp;&amp;</span>
<a href="#l3.1631"></a><span id="l3.1631" class="difflineplus">+    return (flags &amp; Ci.nsMsgMessageFlags.Elided) &amp;&amp;</span>
<a href="#l3.1632"></a><span id="l3.1632">            !(flags &amp; MSG_VIEW_FLAG_DUMMY) &amp;&amp;</span>
<a href="#l3.1633"></a><span id="l3.1633">            this.dbView.isContainer(aViewIndex);</span>
<a href="#l3.1634"></a><span id="l3.1634">   },</span>
<a href="#l3.1635"></a><span id="l3.1635"> </span>
<a href="#l3.1636"></a><span id="l3.1636">   /**</span>
<a href="#l3.1637"></a><span id="l3.1637">    * @return true if the row at the given index is a grouped view dummy header</span>
<a href="#l3.1638"></a><span id="l3.1638">    *     row, false if anything else.</span>
<a href="#l3.1639"></a><span id="l3.1639">    */</span>
<a href="#l3.1640"></a><span id="l3.1640" class="difflineminus">-  isGroupedByHeaderAtIndex: function(aViewIndex) {</span>
<a href="#l3.1641"></a><span id="l3.1641" class="difflineplus">+  isGroupedByHeaderAtIndex(aViewIndex) {</span>
<a href="#l3.1642"></a><span id="l3.1642">     if (aViewIndex &lt; 0 || aViewIndex &gt;= this.dbView.rowCount ||</span>
<a href="#l3.1643"></a><span id="l3.1643">         !this.showGroupedBySort)</span>
<a href="#l3.1644"></a><span id="l3.1644">       return false;</span>
<a href="#l3.1645"></a><span id="l3.1645">     return Boolean(this.dbView.getFlagsAt(aViewIndex) &amp; MSG_VIEW_FLAG_DUMMY);</span>
<a href="#l3.1646"></a><span id="l3.1646">   },</span>
<a href="#l3.1647"></a><span id="l3.1647"> </span>
<a href="#l3.1648"></a><span id="l3.1648">   /**</span>
<a href="#l3.1649"></a><span id="l3.1649">    * Perform application-level behaviors related to leaving a folder that have</span>
<a href="#l3.1650"></a><span id="l3.1650">    *  nothing to do with our abstraction.</span>
<a href="#l3.1651"></a><span id="l3.1651">    *</span>
<a href="#l3.1652"></a><span id="l3.1652">    * Things we do on leaving a folder:</span>
<a href="#l3.1653"></a><span id="l3.1653">    * - Mark the folder's messages as no longer new</span>
<a href="#l3.1654"></a><span id="l3.1654">    * - Mark all messages read in the folder _if so configured_.</span>
<a href="#l3.1655"></a><span id="l3.1655">    */</span>
<a href="#l3.1656"></a><span id="l3.1656" class="difflineminus">-  onLeavingFolder: function DBViewWrapper_onLeavingFolder() {</span>
<a href="#l3.1657"></a><span id="l3.1657" class="difflineplus">+  onLeavingFolder() {</span>
<a href="#l3.1658"></a><span id="l3.1658">     // Suppress useless InvalidateRange calls to the tree by the dbView.</span>
<a href="#l3.1659"></a><span id="l3.1659">     if (this.dbView)</span>
<a href="#l3.1660"></a><span id="l3.1660">       this.dbView.suppressChangeNotifications = true;</span>
<a href="#l3.1661"></a><span id="l3.1661">     this.displayedFolder.clearNewMessages();</span>
<a href="#l3.1662"></a><span id="l3.1662">     this.displayedFolder.hasNewMessages = false;</span>
<a href="#l3.1663"></a><span id="l3.1663">     try {</span>
<a href="#l3.1664"></a><span id="l3.1664">       // For legacy reasons, we support marking all messages as read when we</span>
<a href="#l3.1665"></a><span id="l3.1665">       //  leave a folder based on the server type.  It's this listener's job</span>
<a href="#l3.1666"></a><span id="l3.1666" class="difflineat">@@ -1953,18 +1915,18 @@ DBViewWrapper.prototype = {</span>
<a href="#l3.1667"></a><span id="l3.1667">       // Mark all messages of aFolder as read:</span>
<a href="#l3.1668"></a><span id="l3.1668">       // We can't use the command controller, because it is already tuned in to</span>
<a href="#l3.1669"></a><span id="l3.1669">       // the new folder, so we just mimic its behaviour wrt</span>
<a href="#l3.1670"></a><span id="l3.1670">       // goDoCommand('cmd_markAllRead').</span>
<a href="#l3.1671"></a><span id="l3.1671">       if (this.dbView &amp;&amp;</span>
<a href="#l3.1672"></a><span id="l3.1672">           this.listener.shouldMarkMessagesReadOnLeavingFolder(</span>
<a href="#l3.1673"></a><span id="l3.1673">             this.displayedFolder))</span>
<a href="#l3.1674"></a><span id="l3.1674">         this.dbView.doCommand(Ci.nsMsgViewCommandType.markAllRead);</span>
<a href="#l3.1675"></a><span id="l3.1675" class="difflineplus">+    } catch (e) {</span>
<a href="#l3.1676"></a><span id="l3.1676">     }</span>
<a href="#l3.1677"></a><span id="l3.1677" class="difflineminus">-    catch(e){/* ignore */}</span>
<a href="#l3.1678"></a><span id="l3.1678">   },</span>
<a href="#l3.1679"></a><span id="l3.1679"> </span>
<a href="#l3.1680"></a><span id="l3.1680">   /**</span>
<a href="#l3.1681"></a><span id="l3.1681">    * Returns the view index for this message header in this view.</span>
<a href="#l3.1682"></a><span id="l3.1682">    *</span>
<a href="#l3.1683"></a><span id="l3.1683">    * - If this is a single folder view, we first check whether the folder is the</span>
<a href="#l3.1684"></a><span id="l3.1684">    *   right one. If it is, we call the db view's findIndexOfMsgHdr. We do the</span>
<a href="#l3.1685"></a><span id="l3.1685">    *   first check because findIndexOfMsgHdr only checks for whether the message</span>
<a href="#l3.1686"></a><span id="l3.1686" class="difflineat">@@ -1979,18 +1941,17 @@ DBViewWrapper.prototype = {</span>
<a href="#l3.1687"></a><span id="l3.1687">    *                     message. The dropping of view filters is persistent, so</span>
<a href="#l3.1688"></a><span id="l3.1688">    *                     use with care. Defaults to false.</span>
<a href="#l3.1689"></a><span id="l3.1689">    *</span>
<a href="#l3.1690"></a><span id="l3.1690">    * @returns the view index for this header, or nsMsgViewIndex_None if it isn't</span>
<a href="#l3.1691"></a><span id="l3.1691">    *          found.</span>
<a href="#l3.1692"></a><span id="l3.1692">    *</span>
<a href="#l3.1693"></a><span id="l3.1693">    * @public</span>
<a href="#l3.1694"></a><span id="l3.1694">    */</span>
<a href="#l3.1695"></a><span id="l3.1695" class="difflineminus">-  getViewIndexForMsgHdr: function DBViewWrapper_getViewIndexForMsgHdr(aMsgHdr,</span>
<a href="#l3.1696"></a><span id="l3.1696" class="difflineminus">-      aForceFind) {</span>
<a href="#l3.1697"></a><span id="l3.1697" class="difflineplus">+  getViewIndexForMsgHdr(aMsgHdr, aForceFind) {</span>
<a href="#l3.1698"></a><span id="l3.1698">     if (this.dbView) {</span>
<a href="#l3.1699"></a><span id="l3.1699">       if (this.isSingleFolder &amp;&amp; aMsgHdr.folder != this.dbView.msgFolder)</span>
<a href="#l3.1700"></a><span id="l3.1700">         return nsMsgViewIndex_None;</span>
<a href="#l3.1701"></a><span id="l3.1701"> </span>
<a href="#l3.1702"></a><span id="l3.1702">       let viewIndex = this.dbView.findIndexOfMsgHdr(aMsgHdr, true);</span>
<a href="#l3.1703"></a><span id="l3.1703"> </span>
<a href="#l3.1704"></a><span id="l3.1704">       if (aForceFind &amp;&amp; viewIndex == nsMsgViewIndex_None) {</span>
<a href="#l3.1705"></a><span id="l3.1705">         // Consider dropping view filters.</span>
<a href="#l3.1706"></a><span id="l3.1706" class="difflineat">@@ -2029,18 +1990,17 @@ DBViewWrapper.prototype = {</span>
<a href="#l3.1707"></a><span id="l3.1707">    *  our semantics are limited to telling you about only the first one we find.</span>
<a href="#l3.1708"></a><span id="l3.1708">    *</span>
<a href="#l3.1709"></a><span id="l3.1709">    * @param aMessageId The message-id of the message you want.</span>
<a href="#l3.1710"></a><span id="l3.1710">    * @return The first nsIMsgDBHdr found in any of the underlying folders with</span>
<a href="#l3.1711"></a><span id="l3.1711">    *     the given message header, null if none are found.  The fact that we</span>
<a href="#l3.1712"></a><span id="l3.1712">    *     return something does not guarantee that it is actually visible in the</span>
<a href="#l3.1713"></a><span id="l3.1713">    *     view.  (The search may be filtering it out.)</span>
<a href="#l3.1714"></a><span id="l3.1714">    */</span>
<a href="#l3.1715"></a><span id="l3.1715" class="difflineminus">-  getMsgHdrForMessageID: function DBViewWrapper_getMsgHdrForMessageID(</span>
<a href="#l3.1716"></a><span id="l3.1716" class="difflineminus">-      aMessageId) {</span>
<a href="#l3.1717"></a><span id="l3.1717" class="difflineplus">+  getMsgHdrForMessageID(aMessageId) {</span>
<a href="#l3.1718"></a><span id="l3.1718">     if (this._syntheticView)</span>
<a href="#l3.1719"></a><span id="l3.1719">       return this._syntheticView.getMsgHdrForMessageID(aMessageId);</span>
<a href="#l3.1720"></a><span id="l3.1720">     if (!this._underlyingFolders)</span>
<a href="#l3.1721"></a><span id="l3.1721">       return null;</span>
<a href="#l3.1722"></a><span id="l3.1722">     for (let folder of this._underlyingFolders) {</span>
<a href="#l3.1723"></a><span id="l3.1723">       let msgHdr = folder.msgDatabase.getMsgHdrForMessageID(aMessageId);</span>
<a href="#l3.1724"></a><span id="l3.1724">       if (msgHdr)</span>
<a href="#l3.1725"></a><span id="l3.1725">         return msgHdr;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mail/base/modules/DisplayNameUtils.jsm</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mail/base/modules/DisplayNameUtils.jsm</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -1,13 +1,13 @@</span>
<a href="#l4.4"></a><span id="l4.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l4.5"></a><span id="l4.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l4.6"></a><span id="l4.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l4.7"></a><span id="l4.7"> </span>
<a href="#l4.8"></a><span id="l4.8" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;);</span>
<a href="#l4.9"></a><span id="l4.9" class="difflineplus">+const { fixIterator } = ChromeUtils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;, null);</span>
<a href="#l4.10"></a><span id="l4.10"> ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l4.11"></a><span id="l4.11"> ChromeUtils.import(&quot;resource:///modules/StringBundle.js&quot;);</span>
<a href="#l4.12"></a><span id="l4.12"> </span>
<a href="#l4.13"></a><span id="l4.13"> var EXPORTED_SYMBOLS = [&quot;DisplayNameUtils&quot;];</span>
<a href="#l4.14"></a><span id="l4.14"> </span>
<a href="#l4.15"></a><span id="l4.15"> var DisplayNameUtils = {</span>
<a href="#l4.16"></a><span id="l4.16">   formatDisplayName,</span>
<a href="#l4.17"></a><span id="l4.17">   formatDisplayNameList,</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineat">@@ -32,19 +32,18 @@ function getCardForEmail(aEmailAddress) </span>
<a href="#l4.19"></a><span id="l4.19">   // Email address is searched for in any of the address books that support</span>
<a href="#l4.20"></a><span id="l4.20">   // the cardForEmailAddress function.</span>
<a href="#l4.21"></a><span id="l4.21">   // Future expansion could be to domain matches</span>
<a href="#l4.22"></a><span id="l4.22">   let books = MailServices.ab.directories;</span>
<a href="#l4.23"></a><span id="l4.23">   for (let book of fixIterator(books, Ci.nsIAbDirectory)) {</span>
<a href="#l4.24"></a><span id="l4.24">     try {</span>
<a href="#l4.25"></a><span id="l4.25">       let card = book.cardForEmailAddress(aEmailAddress);</span>
<a href="#l4.26"></a><span id="l4.26">       if (card)</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineminus">-        return { book: book, card: card };</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineminus">-    }</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineminus">-    catch (ex) {}</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineplus">+        return { book, card };</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineplus">+    } catch (ex) {}</span>
<a href="#l4.32"></a><span id="l4.32">   }</span>
<a href="#l4.33"></a><span id="l4.33"> </span>
<a href="#l4.34"></a><span id="l4.34">   return { book: null, card: null };</span>
<a href="#l4.35"></a><span id="l4.35"> }</span>
<a href="#l4.36"></a><span id="l4.36"> </span>
<a href="#l4.37"></a><span id="l4.37"> function _getIdentityForAddress(aEmailAddress) {</span>
<a href="#l4.38"></a><span id="l4.38">   let emailAddress = aEmailAddress.toLowerCase();</span>
<a href="#l4.39"></a><span id="l4.39">   for (let identity of fixIterator(MailServices.accounts.allIdentities,</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineat">@@ -66,18 +65,17 @@ function _getIdentityForAddress(aEmailAd</span>
<a href="#l4.41"></a><span id="l4.41">  * @param aEmailAddress      The email address to format.</span>
<a href="#l4.42"></a><span id="l4.42">  * @param aHeaderDisplayName The display name from the header, if any</span>
<a href="#l4.43"></a><span id="l4.43">  *                           (unused, maintained for add-ons, previously used</span>
<a href="#l4.44"></a><span id="l4.44">  *                           as a fallback).</span>
<a href="#l4.45"></a><span id="l4.45">  * @param aContext           The field being formatted (e.g. &quot;to&quot;, &quot;from&quot;).</span>
<a href="#l4.46"></a><span id="l4.46">  * @param aCard              The address book card, if any.</span>
<a href="#l4.47"></a><span id="l4.47">  * @return The formatted display name, or null.</span>
<a href="#l4.48"></a><span id="l4.48">  */</span>
<a href="#l4.49"></a><span id="l4.49" class="difflineminus">-function formatDisplayName(aEmailAddress, aHeaderDisplayName, aContext, aCard)</span>
<a href="#l4.50"></a><span id="l4.50" class="difflineminus">-{</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineplus">+function formatDisplayName(aEmailAddress, aHeaderDisplayName, aContext, aCard) {</span>
<a href="#l4.52"></a><span id="l4.52">   var displayName = null;</span>
<a href="#l4.53"></a><span id="l4.53">   var identity = _getIdentityForAddress(aEmailAddress);</span>
<a href="#l4.54"></a><span id="l4.54">   var card = aCard || getCardForEmail(aEmailAddress).card;</span>
<a href="#l4.55"></a><span id="l4.55"> </span>
<a href="#l4.56"></a><span id="l4.56">   // If this address is one of the user's identities...</span>
<a href="#l4.57"></a><span id="l4.57">   if (identity) {</span>
<a href="#l4.58"></a><span id="l4.58">     // ...pick a localized version of the word &quot;Me&quot; appropriate to this</span>
<a href="#l4.59"></a><span id="l4.59">     // specific header; fall back to the version used by the &quot;to&quot; header</span>
<a href="#l4.60"></a><span id="l4.60" class="difflineat">@@ -95,17 +93,17 @@ function formatDisplayName(aEmailAddress</span>
<a href="#l4.61"></a><span id="l4.61">                                                    identity.email).toString();</span>
<a href="#l4.62"></a><span id="l4.62">   }</span>
<a href="#l4.63"></a><span id="l4.63"> </span>
<a href="#l4.64"></a><span id="l4.64">   // If we don't have a card, refuse to generate a display name. Places calling</span>
<a href="#l4.65"></a><span id="l4.65">   // this are then responsible for falling back to something else (e.g. the</span>
<a href="#l4.66"></a><span id="l4.66">   // value from the message header).</span>
<a href="#l4.67"></a><span id="l4.67">   if (card) {</span>
<a href="#l4.68"></a><span id="l4.68">     // getProperty may return a &quot;1&quot; or &quot;0&quot; string, we want a boolean</span>
<a href="#l4.69"></a><span id="l4.69" class="difflineminus">-    if (card.getProperty(&quot;PreferDisplayName&quot;, true) != false)</span>
<a href="#l4.70"></a><span id="l4.70" class="difflineplus">+    if (card.getProperty(&quot;PreferDisplayName&quot;, &quot;1&quot;) == &quot;1&quot;)</span>
<a href="#l4.71"></a><span id="l4.71">       displayName = card.displayName || null;</span>
<a href="#l4.72"></a><span id="l4.72"> </span>
<a href="#l4.73"></a><span id="l4.73">     // Note: aHeaderDisplayName is not used as a fallback as confusion could be</span>
<a href="#l4.74"></a><span id="l4.74">     // caused by a collected address using an e-mail address as display name.</span>
<a href="#l4.75"></a><span id="l4.75">   }</span>
<a href="#l4.76"></a><span id="l4.76"> </span>
<a href="#l4.77"></a><span id="l4.77">   return displayName;</span>
<a href="#l4.78"></a><span id="l4.78"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mail/base/modules/MailConsts.jsm</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mail/base/modules/MailConsts.jsm</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -4,18 +4,17 @@</span>
<a href="#l5.4"></a><span id="l5.4"> </span>
<a href="#l5.5"></a><span id="l5.5"> /**</span>
<a href="#l5.6"></a><span id="l5.6">  * This is a place to store constants and enumerations that are needed only by</span>
<a href="#l5.7"></a><span id="l5.7">  * JavaScript code, especially component/module code.</span>
<a href="#l5.8"></a><span id="l5.8">  */</span>
<a href="#l5.9"></a><span id="l5.9"> </span>
<a href="#l5.10"></a><span id="l5.10"> var EXPORTED_SYMBOLS = [&quot;MailConsts&quot;];</span>
<a href="#l5.11"></a><span id="l5.11"> </span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-var MailConsts =</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineminus">-{</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+var MailConsts = {</span>
<a href="#l5.15"></a><span id="l5.15">   /**</span>
<a href="#l5.16"></a><span id="l5.16">    * Determine how to open a message when it is double-clicked or selected and</span>
<a href="#l5.17"></a><span id="l5.17">    * Enter pressed. The preference to set this is mail.openMessageBehavior.</span>
<a href="#l5.18"></a><span id="l5.18">    */</span>
<a href="#l5.19"></a><span id="l5.19">   OpenMessageBehavior: {</span>
<a href="#l5.20"></a><span id="l5.20">     /**</span>
<a href="#l5.21"></a><span id="l5.21">      * Open the message in a new window. If multiple messages are selected, all</span>
<a href="#l5.22"></a><span id="l5.22">      * of them are opened in separate windows.</span>
<a href="#l5.23"></a><span id="l5.23" class="difflineat">@@ -30,11 +29,11 @@ var MailConsts =</span>
<a href="#l5.24"></a><span id="l5.24">     EXISTING_WINDOW: 1,</span>
<a href="#l5.25"></a><span id="l5.25"> </span>
<a href="#l5.26"></a><span id="l5.26">     /**</span>
<a href="#l5.27"></a><span id="l5.27">      * Open the message in a new tab. If multiple messages are selected, all of</span>
<a href="#l5.28"></a><span id="l5.28">      * them are opened as tabs, with the last tab in the foreground and all the</span>
<a href="#l5.29"></a><span id="l5.29">      * rest in the background. If no 3-pane window is open, the message is</span>
<a href="#l5.30"></a><span id="l5.30">      * opened in a new standalone window.</span>
<a href="#l5.31"></a><span id="l5.31">      */</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineminus">-    NEW_TAB: 2</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineminus">-  }</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineplus">+    NEW_TAB: 2,</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineplus">+  },</span>
<a href="#l5.36"></a><span id="l5.36"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mail/base/modules/MailInstrumentation.jsm</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mail/base/modules/MailInstrumentation.jsm</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -7,96 +7,97 @@</span>
<a href="#l6.4"></a><span id="l6.4">  */</span>
<a href="#l6.5"></a><span id="l6.5"> </span>
<a href="#l6.6"></a><span id="l6.6"> /* :::::::: Constants and Helpers ::::::::::::::: */</span>
<a href="#l6.7"></a><span id="l6.7"> </span>
<a href="#l6.8"></a><span id="l6.8"> this.EXPORTED_SYMBOLS = [&quot;MailInstrumentation&quot;];</span>
<a href="#l6.9"></a><span id="l6.9"> </span>
<a href="#l6.10"></a><span id="l6.10"> var nsIMFNService = Ci.nsIMsgFolderNotificationService;</span>
<a href="#l6.11"></a><span id="l6.11"> </span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/errUtils.js&quot;);</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+const { logException } = ChromeUtils.import(&quot;resource:///modules/errUtils.js&quot;, null);</span>
<a href="#l6.14"></a><span id="l6.14"> ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l6.15"></a><span id="l6.15"> ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l6.16"></a><span id="l6.16"> </span>
<a href="#l6.17"></a><span id="l6.17"> Cu.importGlobalProperties([&quot;XMLHttpRequest&quot;]);</span>
<a href="#l6.18"></a><span id="l6.18"> </span>
<a href="#l6.19"></a><span id="l6.19"> /* :::::::: The Module ::::::::::::::: */</span>
<a href="#l6.20"></a><span id="l6.20"> </span>
<a href="#l6.21"></a><span id="l6.21" class="difflineminus">-var MailInstrumentation =</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineminus">-{</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineplus">+var MailInstrumentation = {</span>
<a href="#l6.24"></a><span id="l6.24">   // JS object containing the current state object</span>
<a href="#l6.25"></a><span id="l6.25">   _currentState: null,</span>
<a href="#l6.26"></a><span id="l6.26"> </span>
<a href="#l6.27"></a><span id="l6.27">   /**</span>
<a href="#l6.28"></a><span id="l6.28">    * The string containing the JSON stringified representation of the last</span>
<a href="#l6.29"></a><span id="l6.29">    * state we uploaded.</span>
<a href="#l6.30"></a><span id="l6.30">    */</span>
<a href="#l6.31"></a><span id="l6.31">   _lastStateString: null,</span>
<a href="#l6.32"></a><span id="l6.32"> </span>
<a href="#l6.33"></a><span id="l6.33">   // if true, need to remove ourselves as a folder notification listener</span>
<a href="#l6.34"></a><span id="l6.34">   _mfnListener: false,</span>
<a href="#l6.35"></a><span id="l6.35"> </span>
<a href="#l6.36"></a><span id="l6.36">   // if true, we need to remove our observers in uninit.</span>
<a href="#l6.37"></a><span id="l6.37">   _observersRegistered: false,</span>
<a href="#l6.38"></a><span id="l6.38"> </span>
<a href="#l6.39"></a><span id="l6.39" class="difflineminus">-  observe: function (aSubject, aTopic, aState) {</span>
<a href="#l6.40"></a><span id="l6.40" class="difflineplus">+  observe(aSubject, aTopic, aState) {</span>
<a href="#l6.41"></a><span id="l6.41">     if (aTopic == &quot;mail:composeSendSucceeded&quot;)</span>
<a href="#l6.42"></a><span id="l6.42">       MailInstrumentation.addEvent(&quot;msgSent&quot;, true);</span>
<a href="#l6.43"></a><span id="l6.43">     else if (aTopic == &quot;mail:setAsDefault&quot;)</span>
<a href="#l6.44"></a><span id="l6.44">       MailInstrumentation.addEvent(&quot;setAsDefault&quot;, true);</span>
<a href="#l6.45"></a><span id="l6.45"> </span>
<a href="#l6.46"></a><span id="l6.46">   },</span>
<a href="#l6.47"></a><span id="l6.47" class="difflineminus">-  msgAdded: function (aMsg) {</span>
<a href="#l6.48"></a><span id="l6.48" class="difflineplus">+  msgAdded(aMsg) {</span>
<a href="#l6.49"></a><span id="l6.49">     MailServices.mfn.removeListener(this);</span>
<a href="#l6.50"></a><span id="l6.50">     this._mfnListener = false;</span>
<a href="#l6.51"></a><span id="l6.51">     MailInstrumentation.addEvent(&quot;msgDownloaded&quot;, true);</span>
<a href="#l6.52"></a><span id="l6.52">   },</span>
<a href="#l6.53"></a><span id="l6.53"> </span>
<a href="#l6.54"></a><span id="l6.54" class="difflineminus">-  _accountsChanged: function() {</span>
<a href="#l6.55"></a><span id="l6.55" class="difflineplus">+  _accountsChanged() {</span>
<a href="#l6.56"></a><span id="l6.56">     // check if there are at least two accounts - one is local folders account</span>
<a href="#l6.57"></a><span id="l6.57" class="difflineminus">-    if (Services.prefs.getCharPref(&quot;mail.accountmanager.accounts&quot;).includes(',', 1)) {</span>
<a href="#l6.58"></a><span id="l6.58" class="difflineplus">+    if (Services.prefs.getCharPref(&quot;mail.accountmanager.accounts&quot;).includes(&quot;,&quot;, 1)) {</span>
<a href="#l6.59"></a><span id="l6.59">       MailInstrumentation.addEvent(&quot;accountAdded&quot;, true);</span>
<a href="#l6.60"></a><span id="l6.60">       MailInstrumentation._removeObserver(</span>
<a href="#l6.61"></a><span id="l6.61">         &quot;mail.accountmanager.accounts&quot;,</span>
<a href="#l6.62"></a><span id="l6.62">         MailInstrumentation._accountsChanged);</span>
<a href="#l6.63"></a><span id="l6.63"> </span>
<a href="#l6.64"></a><span id="l6.64">     }</span>
<a href="#l6.65"></a><span id="l6.65">   },</span>
<a href="#l6.66"></a><span id="l6.66" class="difflineminus">-  _smtpServerAdded: function() {</span>
<a href="#l6.67"></a><span id="l6.67" class="difflineplus">+  _smtpServerAdded() {</span>
<a href="#l6.68"></a><span id="l6.68">     MailInstrumentation.addEvent(&quot;smtpServerAdded&quot;, true);</span>
<a href="#l6.69"></a><span id="l6.69">     MailInstrumentation._removeObserver(&quot;mail.smtpservers&quot;,</span>
<a href="#l6.70"></a><span id="l6.70">       MailInstrumentation._smtpServerAdded);</span>
<a href="#l6.71"></a><span id="l6.71">   },</span>
<a href="#l6.72"></a><span id="l6.72" class="difflineminus">-  _userOptedIn: function() {</span>
<a href="#l6.73"></a><span id="l6.73" class="difflineplus">+  _userOptedIn() {</span>
<a href="#l6.74"></a><span id="l6.74">     try {</span>
<a href="#l6.75"></a><span id="l6.75">       if (Services.prefs.getBoolPref(&quot;mail.instrumentation.userOptedIn&quot;))</span>
<a href="#l6.76"></a><span id="l6.76">         MailInstrumentation._postStateObject();</span>
<a href="#l6.77"></a><span id="l6.77" class="difflineminus">-    } catch (ex) {logException(ex);}</span>
<a href="#l6.78"></a><span id="l6.78" class="difflineplus">+    } catch (ex) {</span>
<a href="#l6.79"></a><span id="l6.79" class="difflineplus">+      logException(ex);</span>
<a href="#l6.80"></a><span id="l6.80" class="difflineplus">+    }</span>
<a href="#l6.81"></a><span id="l6.81">   },</span>
<a href="#l6.82"></a><span id="l6.82"> </span>
<a href="#l6.83"></a><span id="l6.83">   /**</span>
<a href="#l6.84"></a><span id="l6.84">    * Loads the last saved state. This should only be called by</span>
<a href="#l6.85"></a><span id="l6.85">    * _init and a unit test.</span>
<a href="#l6.86"></a><span id="l6.86">    */</span>
<a href="#l6.87"></a><span id="l6.87" class="difflineminus">-  _loadState: function minst_loadState() {</span>
<a href="#l6.88"></a><span id="l6.88" class="difflineplus">+  _loadState() {</span>
<a href="#l6.89"></a><span id="l6.89">     let data = Services.prefs.getCharPref(&quot;mail.instrumentation.lastNotificationSent&quot;);</span>
<a href="#l6.90"></a><span id="l6.90">     if (data) {</span>
<a href="#l6.91"></a><span id="l6.91">       try {</span>
<a href="#l6.92"></a><span id="l6.92">         // parse the session state into JS objects</span>
<a href="#l6.93"></a><span id="l6.93">         this._currentState = JSON.parse(data);</span>
<a href="#l6.94"></a><span id="l6.94">         return;</span>
<a href="#l6.95"></a><span id="l6.95">       } catch (ex) {}</span>
<a href="#l6.96"></a><span id="l6.96">     }</span>
<a href="#l6.97"></a><span id="l6.97">     this._currentState = this._createStateObject();</span>
<a href="#l6.98"></a><span id="l6.98">   },</span>
<a href="#l6.99"></a><span id="l6.99"> </span>
<a href="#l6.100"></a><span id="l6.100">   /**</span>
<a href="#l6.101"></a><span id="l6.101">    * Writes the state object to disk.</span>
<a href="#l6.102"></a><span id="l6.102">    */</span>
<a href="#l6.103"></a><span id="l6.103" class="difflineminus">-  _postStateObject: function minst_postStateObject() {</span>
<a href="#l6.104"></a><span id="l6.104" class="difflineplus">+  _postStateObject() {</span>
<a href="#l6.105"></a><span id="l6.105">     // Getting defaultAccount will throw an exception if no account is set up.</span>
<a href="#l6.106"></a><span id="l6.106">     // This method runs for the smtp server before the account has been set up.</span>
<a href="#l6.107"></a><span id="l6.107">     if (MailServices.accounts.accounts.length == 0)</span>
<a href="#l6.108"></a><span id="l6.108">       return;</span>
<a href="#l6.109"></a><span id="l6.109"> </span>
<a href="#l6.110"></a><span id="l6.110">     let defaultAccount;</span>
<a href="#l6.111"></a><span id="l6.111">     try {</span>
<a href="#l6.112"></a><span id="l6.112">       defaultAccount = MailServices.accounts.defaultAccount;</span>
<a href="#l6.113"></a><span id="l6.113" class="difflineat">@@ -121,82 +122,82 @@ var MailInstrumentation =</span>
<a href="#l6.114"></a><span id="l6.114">       let userOptedIn = Services.prefs.getBoolPref(&quot;mail.instrumentation.userOptedIn&quot;);</span>
<a href="#l6.115"></a><span id="l6.115">       if (userOptedIn)</span>
<a href="#l6.116"></a><span id="l6.116">         this._postData();</span>
<a href="#l6.117"></a><span id="l6.117">   },</span>
<a href="#l6.118"></a><span id="l6.118"> </span>
<a href="#l6.119"></a><span id="l6.119">   /**</span>
<a href="#l6.120"></a><span id="l6.120">    * @return an empty state object that can be populated with window states.</span>
<a href="#l6.121"></a><span id="l6.121">    */</span>
<a href="#l6.122"></a><span id="l6.122" class="difflineminus">-  _createStateObject: function minst_createStateObject() {</span>
<a href="#l6.123"></a><span id="l6.123" class="difflineplus">+  _createStateObject() {</span>
<a href="#l6.124"></a><span id="l6.124">     return {</span>
<a href="#l6.125"></a><span id="l6.125">       rev: 0,</span>
<a href="#l6.126"></a><span id="l6.126">       userEmailHash: &quot;&quot;,</span>
<a href="#l6.127"></a><span id="l6.127">       // these will be a tuple, time stamp and answer, indexed by question key.</span>
<a href="#l6.128"></a><span id="l6.128" class="difflineminus">-      events: new Object,</span>
<a href="#l6.129"></a><span id="l6.129" class="difflineplus">+      events: {},</span>
<a href="#l6.130"></a><span id="l6.130">     };</span>
<a href="#l6.131"></a><span id="l6.131">   },</span>
<a href="#l6.132"></a><span id="l6.132">   // Convert each hashed byte into 2-hex strings, then combine them.</span>
<a href="#l6.133"></a><span id="l6.133" class="difflineminus">-  _bytesAsHex: function minst_bytesAsHex(bytes) {</span>
<a href="#l6.134"></a><span id="l6.134" class="difflineplus">+  _bytesAsHex(bytes) {</span>
<a href="#l6.135"></a><span id="l6.135">     return Array.from(bytes).</span>
<a href="#l6.136"></a><span id="l6.136">       map(byte =&gt; (&quot;0&quot; + byte.charCodeAt().toString(16)).slice(-2)).join(&quot;&quot;);</span>
<a href="#l6.137"></a><span id="l6.137">   },</span>
<a href="#l6.138"></a><span id="l6.138">   /**</span>
<a href="#l6.139"></a><span id="l6.139">    * Return sha-256 hash of the passed in e-mail address</span>
<a href="#l6.140"></a><span id="l6.140">    */</span>
<a href="#l6.141"></a><span id="l6.141" class="difflineminus">-  _hashEmailAddress: function minst_hashEmailAddress(address) {</span>
<a href="#l6.142"></a><span id="l6.142" class="difflineplus">+  _hashEmailAddress(address) {</span>
<a href="#l6.143"></a><span id="l6.143">     let ch = Cc[&quot;@mozilla.org/security/hash;1&quot;]</span>
<a href="#l6.144"></a><span id="l6.144">                .createInstance(Ci.nsICryptoHash);</span>
<a href="#l6.145"></a><span id="l6.145">     ch.init(ch.SHA256);</span>
<a href="#l6.146"></a><span id="l6.146">     let converter = Cc[&quot;@mozilla.org/intl/scriptableunicodeconverter&quot;]</span>
<a href="#l6.147"></a><span id="l6.147">                        .createInstance(Ci.nsIScriptableUnicodeConverter);</span>
<a href="#l6.148"></a><span id="l6.148">     converter.charset = &quot;UTF-8&quot;;</span>
<a href="#l6.149"></a><span id="l6.149"> </span>
<a href="#l6.150"></a><span id="l6.150">     let byteArray = converter.convertToByteArray(address, {});</span>
<a href="#l6.151"></a><span id="l6.151">     ch.update(byteArray, byteArray.length);</span>
<a href="#l6.152"></a><span id="l6.152">     let hashedData = ch.finish(false);</span>
<a href="#l6.153"></a><span id="l6.153">     return this._bytesAsHex(hashedData);</span>
<a href="#l6.154"></a><span id="l6.154">   },</span>
<a href="#l6.155"></a><span id="l6.155"> </span>
<a href="#l6.156"></a><span id="l6.156" class="difflineminus">-  _postData: function minst_postData() {</span>
<a href="#l6.157"></a><span id="l6.157" class="difflineplus">+  _postData() {</span>
<a href="#l6.158"></a><span id="l6.158">     let req = new XMLHttpRequest();</span>
<a href="#l6.159"></a><span id="l6.159">     let url = Services.prefs.getCharPref(&quot;mail.instrumentation.postUrl&quot;);</span>
<a href="#l6.160"></a><span id="l6.160">     if (!url.length)</span>
<a href="#l6.161"></a><span id="l6.161">       return;</span>
<a href="#l6.162"></a><span id="l6.162">     let dataToPost = this._lastStateString;</span>
<a href="#l6.163"></a><span id="l6.163">     req.open(&quot;POST&quot;, url, true);</span>
<a href="#l6.164"></a><span id="l6.164">     req.onerror = this._onError;</span>
<a href="#l6.165"></a><span id="l6.165">     req.onload = this._onLoad;</span>
<a href="#l6.166"></a><span id="l6.166">     req.send(dataToPost);</span>
<a href="#l6.167"></a><span id="l6.167">   },</span>
<a href="#l6.168"></a><span id="l6.168" class="difflineminus">-  _onError: function minst_onError(e) {</span>
<a href="#l6.169"></a><span id="l6.169" class="difflineplus">+  _onError(e) {</span>
<a href="#l6.170"></a><span id="l6.170">     logException(e);</span>
<a href="#l6.171"></a><span id="l6.171">   },</span>
<a href="#l6.172"></a><span id="l6.172" class="difflineminus">-  _onLoad: function minst_onLoad() {</span>
<a href="#l6.173"></a><span id="l6.173" class="difflineplus">+  _onLoad() {</span>
<a href="#l6.174"></a><span id="l6.174">     Services.prefs.setCharPref(&quot;mail.instrumentation.lastNotificationSent&quot;,</span>
<a href="#l6.175"></a><span id="l6.175">                                this._lastStateString);</span>
<a href="#l6.176"></a><span id="l6.176">   },</span>
<a href="#l6.177"></a><span id="l6.177">   // keeps track of whether or not we've removed the observer for a given</span>
<a href="#l6.178"></a><span id="l6.178">   // pref name.</span>
<a href="#l6.179"></a><span id="l6.179" class="difflineminus">-  _prefsObserved : new Map(),</span>
<a href="#l6.180"></a><span id="l6.180" class="difflineminus">-  _addObserver : function(pref, observer) {</span>
<a href="#l6.181"></a><span id="l6.181" class="difflineplus">+  _prefsObserved: new Map(),</span>
<a href="#l6.182"></a><span id="l6.182" class="difflineplus">+  _addObserver(pref, observer) {</span>
<a href="#l6.183"></a><span id="l6.183">     Services.prefs.addObserver(pref, observer);</span>
<a href="#l6.184"></a><span id="l6.184">     this._prefsObserved.set(pref, true);</span>
<a href="#l6.185"></a><span id="l6.185">   },</span>
<a href="#l6.186"></a><span id="l6.186" class="difflineminus">-  _removeObserver : function(pref, observer) {</span>
<a href="#l6.187"></a><span id="l6.187" class="difflineplus">+  _removeObserver(pref, observer) {</span>
<a href="#l6.188"></a><span id="l6.188">     if (this._prefsObserved.has(pref)) {</span>
<a href="#l6.189"></a><span id="l6.189">       Services.prefs.removeObserver(pref, observer);</span>
<a href="#l6.190"></a><span id="l6.190">       this._prefsObserved.set(pref, false);</span>
<a href="#l6.191"></a><span id="l6.191">     }</span>
<a href="#l6.192"></a><span id="l6.192">   },</span>
<a href="#l6.193"></a><span id="l6.193"> /* ........ Public API ................*/</span>
<a href="#l6.194"></a><span id="l6.194">   /**</span>
<a href="#l6.195"></a><span id="l6.195">    * This is called to initialize the instrumentation.</span>
<a href="#l6.196"></a><span id="l6.196">    */</span>
<a href="#l6.197"></a><span id="l6.197" class="difflineminus">-  init: function minst_init() {</span>
<a href="#l6.198"></a><span id="l6.198" class="difflineplus">+  init() {</span>
<a href="#l6.199"></a><span id="l6.199">     // If we're done with instrumentation, or this is not a first run,</span>
<a href="#l6.200"></a><span id="l6.200">     // we should just return immediately.</span>
<a href="#l6.201"></a><span id="l6.201">     if (!Services.prefs.getBoolPref(&quot;mail.instrumentation.askUser&quot;))</span>
<a href="#l6.202"></a><span id="l6.202">       return;</span>
<a href="#l6.203"></a><span id="l6.203">     if (MailServices.accounts.accounts.length &gt; 0)</span>
<a href="#l6.204"></a><span id="l6.204">       return;</span>
<a href="#l6.205"></a><span id="l6.205"> </span>
<a href="#l6.206"></a><span id="l6.206">     this._loadState();</span>
<a href="#l6.207"></a><span id="l6.207" class="difflineat">@@ -206,35 +207,37 @@ var MailInstrumentation =</span>
<a href="#l6.208"></a><span id="l6.208">                                this._accountsChanged);</span>
<a href="#l6.209"></a><span id="l6.209">     Services.prefs.addObserver(&quot;mail.instrumentation.userOptedIn&quot;,</span>
<a href="#l6.210"></a><span id="l6.210">                                this._userOptedIn);</span>
<a href="#l6.211"></a><span id="l6.211">     Services.prefs.addObserver(&quot;mail.smtpservers&quot;, this._smtpServerAdded);</span>
<a href="#l6.212"></a><span id="l6.212">     MailServices.mfn.addListener(this, nsIMFNService.msgAdded);</span>
<a href="#l6.213"></a><span id="l6.213">     this._observersRegistered = true;</span>
<a href="#l6.214"></a><span id="l6.214">     this._mfnListener = true;</span>
<a href="#l6.215"></a><span id="l6.215">   },</span>
<a href="#l6.216"></a><span id="l6.216" class="difflineminus">-  uninit: function() {</span>
<a href="#l6.217"></a><span id="l6.217" class="difflineplus">+  uninit() {</span>
<a href="#l6.218"></a><span id="l6.218">     if (!this._observersRegistered)</span>
<a href="#l6.219"></a><span id="l6.219">       return;</span>
<a href="#l6.220"></a><span id="l6.220">     Services.obs.removeObserver(this, &quot;mail:composeSendSucceeded&quot;);</span>
<a href="#l6.221"></a><span id="l6.221">     Services.obs.removeObserver(this, &quot;mail:setAsDefault&quot;);</span>
<a href="#l6.222"></a><span id="l6.222">     if (this._mfnListener)</span>
<a href="#l6.223"></a><span id="l6.223">       MailServices.mfn.removeListener(this);</span>
<a href="#l6.224"></a><span id="l6.224">     Services.prefs.removeObserver(&quot;mail.accountmanager.accounts&quot;, this);</span>
<a href="#l6.225"></a><span id="l6.225">     Services.prefs.removeObserver(&quot;mail.instrumentation.userOptedIn&quot;, this);</span>
<a href="#l6.226"></a><span id="l6.226">     Services.prefs.removeObserver(&quot;mail.smtpservers&quot;, this);</span>
<a href="#l6.227"></a><span id="l6.227">   },</span>
<a href="#l6.228"></a><span id="l6.228">   /**</span>
<a href="#l6.229"></a><span id="l6.229">    * This adds an event to the current state, if it doesn't exist.</span>
<a href="#l6.230"></a><span id="l6.230">    */</span>
<a href="#l6.231"></a><span id="l6.231" class="difflineminus">-  addEvent: function minst_addEvent(aEventKey, aData) {</span>
<a href="#l6.232"></a><span id="l6.232" class="difflineplus">+  addEvent(aEventKey, aData) {</span>
<a href="#l6.233"></a><span id="l6.233">     try {</span>
<a href="#l6.234"></a><span id="l6.234">       if (!(aEventKey in this._currentState.events)) {</span>
<a href="#l6.235"></a><span id="l6.235" class="difflineminus">-        let newEvent = new Object;</span>
<a href="#l6.236"></a><span id="l6.236" class="difflineplus">+        let newEvent = {};</span>
<a href="#l6.237"></a><span id="l6.237">         newEvent.time = Date.now();</span>
<a href="#l6.238"></a><span id="l6.238">         newEvent.data = aData;</span>
<a href="#l6.239"></a><span id="l6.239">         this._currentState.events[aEventKey] = newEvent;</span>
<a href="#l6.240"></a><span id="l6.240">         this._postStateObject();</span>
<a href="#l6.241"></a><span id="l6.241">       }</span>
<a href="#l6.242"></a><span id="l6.242" class="difflineminus">-    } catch(ex) {logException(ex);}</span>
<a href="#l6.243"></a><span id="l6.243" class="difflineplus">+    } catch (ex) {</span>
<a href="#l6.244"></a><span id="l6.244" class="difflineplus">+      logException(ex);</span>
<a href="#l6.245"></a><span id="l6.245" class="difflineplus">+    }</span>
<a href="#l6.246"></a><span id="l6.246">   },</span>
<a href="#l6.247"></a><span id="l6.247"> };</span>
<a href="#l6.248"></a><span id="l6.248"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mail/base/modules/MailMigrator.jsm</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mail/base/modules/MailMigrator.jsm</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -7,29 +7,24 @@</span>
<a href="#l7.4"></a><span id="l7.4">  * This module handles migrating mail-specific preferences, etc. Migration has</span>
<a href="#l7.5"></a><span id="l7.5">  * traditionally been a part of msgMail3PaneWindow.js, but separating the code</span>
<a href="#l7.6"></a><span id="l7.6">  * out into a module makes unit testing much easier.</span>
<a href="#l7.7"></a><span id="l7.7">  */</span>
<a href="#l7.8"></a><span id="l7.8"> </span>
<a href="#l7.9"></a><span id="l7.9"> var EXPORTED_SYMBOLS = [&quot;MailMigrator&quot;];</span>
<a href="#l7.10"></a><span id="l7.10"> </span>
<a href="#l7.11"></a><span id="l7.11"> ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l7.13"></a><span id="l7.13"> ChromeUtils.import(&quot;resource:///modules/IOUtils.js&quot;);</span>
<a href="#l7.14"></a><span id="l7.14"> </span>
<a href="#l7.15"></a><span id="l7.15" class="difflineminus">-ChromeUtils.defineModuleGetter(this, &quot;LoginHelper&quot;,</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineminus">-                               &quot;resource://gre/modules/LoginHelper.jsm&quot;);</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineminus">-</span>
<a href="#l7.18"></a><span id="l7.18"> var MailMigrator = {</span>
<a href="#l7.19"></a><span id="l7.19">   /**</span>
<a href="#l7.20"></a><span id="l7.20">    * Switch the given fonts to the given encodings, but only if the current fonts</span>
<a href="#l7.21"></a><span id="l7.21">    * are defaults.</span>
<a href="#l7.22"></a><span id="l7.22">    */</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineminus">-  _switchDefaultFonts: function MailMigrator__switchDefaultFonts(aFonts,</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineminus">-                                                                 aEncodings) {</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineplus">+  _switchDefaultFonts(aFonts, aEncodings) {</span>
<a href="#l7.26"></a><span id="l7.26">     for (let encoding of aEncodings) {</span>
<a href="#l7.27"></a><span id="l7.27">       let serifPref = &quot;font.name.serif.&quot; + encoding;</span>
<a href="#l7.28"></a><span id="l7.28">       let sansPref = &quot;font.name.sans-serif.&quot; + encoding;</span>
<a href="#l7.29"></a><span id="l7.29">       let variableSizePref = &quot;font.size.variable.&quot; + encoding;</span>
<a href="#l7.30"></a><span id="l7.30">       // This is expected to be one of sans-serif or serif, and determines what</span>
<a href="#l7.31"></a><span id="l7.31">       // we'll link the variable font size to.</span>
<a href="#l7.32"></a><span id="l7.32">       let isSansDefault = Services.prefs.getCharPref(&quot;font.default.&quot; + encoding) ==</span>
<a href="#l7.33"></a><span id="l7.33">                             &quot;sans-serif&quot;;</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineat">@@ -54,17 +49,17 @@ var MailMigrator = {</span>
<a href="#l7.35"></a><span id="l7.35">       }</span>
<a href="#l7.36"></a><span id="l7.36">     }</span>
<a href="#l7.37"></a><span id="l7.37">   },</span>
<a href="#l7.38"></a><span id="l7.38"> </span>
<a href="#l7.39"></a><span id="l7.39">   /**</span>
<a href="#l7.40"></a><span id="l7.40">    * Migrate to ClearType fonts (Cambria, Calibri and Consolas) on Windows Vista</span>
<a href="#l7.41"></a><span id="l7.41">    * and above.</span>
<a href="#l7.42"></a><span id="l7.42">    */</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineminus">-  migrateToClearTypeFonts: function MailMigrator_migrateToClearTypeFonts() {</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineplus">+  migrateToClearTypeFonts() {</span>
<a href="#l7.45"></a><span id="l7.45">     // Windows...</span>
<a href="#l7.46"></a><span id="l7.46">     if (&quot;@mozilla.org/windows-registry-key;1&quot; in Cc) {</span>
<a href="#l7.47"></a><span id="l7.47">       // Only migrate on Vista (Windows version 6.0) and above</span>
<a href="#l7.48"></a><span id="l7.48">       if (Services.sysinfo.getPropertyAsDouble(&quot;version&quot;) &gt;= 6.0) {</span>
<a href="#l7.49"></a><span id="l7.49">         let fontPrefVersion =</span>
<a href="#l7.50"></a><span id="l7.50">           Services.prefs.getIntPref(&quot;mail.font.windows.version&quot;);</span>
<a href="#l7.51"></a><span id="l7.51">         if (fontPrefVersion &lt; 2) {</span>
<a href="#l7.52"></a><span id="l7.52">           let fonts = {</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineat">@@ -89,28 +84,25 @@ var MailMigrator = {</span>
<a href="#l7.54"></a><span id="l7.54">       }</span>
<a href="#l7.55"></a><span id="l7.55">     }</span>
<a href="#l7.56"></a><span id="l7.56">   },</span>
<a href="#l7.57"></a><span id="l7.57"> </span>
<a href="#l7.58"></a><span id="l7.58">   /**</span>
<a href="#l7.59"></a><span id="l7.59">    * Determine if the UI has been upgraded in a way that requires us to reset</span>
<a href="#l7.60"></a><span id="l7.60">    * some user configuration.  If so, performs the resets.</span>
<a href="#l7.61"></a><span id="l7.61">    */</span>
<a href="#l7.62"></a><span id="l7.62" class="difflineminus">-  _migrateUI: function() {</span>
<a href="#l7.63"></a><span id="l7.63" class="difflineplus">+  /* eslint-disable complexity */</span>
<a href="#l7.64"></a><span id="l7.64" class="difflineplus">+  _migrateUI() {</span>
<a href="#l7.65"></a><span id="l7.65">     // The code for this was ported from</span>
<a href="#l7.66"></a><span id="l7.66">     // mozilla/browser/components/nsBrowserGlue.js</span>
<a href="#l7.67"></a><span id="l7.67">     const UI_VERSION = 17;</span>
<a href="#l7.68"></a><span id="l7.68">     const MESSENGER_DOCURL = &quot;chrome://messenger/content/messenger.xul&quot;;</span>
<a href="#l7.69"></a><span id="l7.69">     const MESSENGERCOMPOSE_DOCURL = &quot;chrome://messenger/content/messengercompose/messengercompose.xul&quot;;</span>
<a href="#l7.70"></a><span id="l7.70">     const UI_VERSION_PREF = &quot;mail.ui-rdf.version&quot;;</span>
<a href="#l7.71"></a><span id="l7.71" class="difflineminus">-    let currentUIVersion = 0;</span>
<a href="#l7.72"></a><span id="l7.72" class="difflineminus">-</span>
<a href="#l7.73"></a><span id="l7.73" class="difflineminus">-    try {</span>
<a href="#l7.74"></a><span id="l7.74" class="difflineminus">-      currentUIVersion = Services.prefs.getIntPref(UI_VERSION_PREF);</span>
<a href="#l7.75"></a><span id="l7.75" class="difflineminus">-    } catch(ex) {}</span>
<a href="#l7.76"></a><span id="l7.76" class="difflineplus">+    let currentUIVersion = Services.prefs.getIntPref(UI_VERSION_PREF, 0);</span>
<a href="#l7.77"></a><span id="l7.77"> </span>
<a href="#l7.78"></a><span id="l7.78">     if (currentUIVersion &gt;= UI_VERSION)</span>
<a href="#l7.79"></a><span id="l7.79">       return;</span>
<a href="#l7.80"></a><span id="l7.80"> </span>
<a href="#l7.81"></a><span id="l7.81">     let xulStore = Services.xulStore;</span>
<a href="#l7.82"></a><span id="l7.82"> </span>
<a href="#l7.83"></a><span id="l7.83">     let newProfile = (currentUIVersion == 0);</span>
<a href="#l7.84"></a><span id="l7.84">     if (newProfile) {</span>
<a href="#l7.85"></a><span id="l7.85" class="difflineat">@@ -131,33 +123,32 @@ var MailMigrator = {</span>
<a href="#l7.86"></a><span id="l7.86">       // support those version here, see bug 1371898.</span>
<a href="#l7.87"></a><span id="l7.87"> </span>
<a href="#l7.88"></a><span id="l7.88">       // In UI version 6, we move the otherActionsButton button to the</span>
<a href="#l7.89"></a><span id="l7.89">       // header-view-toolbar.</span>
<a href="#l7.90"></a><span id="l7.90">       if (currentUIVersion &lt; 6) {</span>
<a href="#l7.91"></a><span id="l7.91">         let cs = xulStore.getValue(MESSENGER_DOCURL, &quot;header-view-toolbar&quot;, &quot;currentset&quot;);</span>
<a href="#l7.92"></a><span id="l7.92">         if (cs &amp;&amp; !cs.includes(&quot;otherActionsButton&quot;)) {</span>
<a href="#l7.93"></a><span id="l7.93">           // Put the otherActionsButton button at the end.</span>
<a href="#l7.94"></a><span id="l7.94" class="difflineminus">-          cs = cs + &quot;,&quot; + &quot;otherActionsButton&quot;;</span>
<a href="#l7.95"></a><span id="l7.95" class="difflineplus">+          cs = cs + &quot;,otherActionsButton&quot;;</span>
<a href="#l7.96"></a><span id="l7.96">           xulStore.setValue(MESSENGER_DOCURL, &quot;header-view-toolbar&quot;, &quot;currentset&quot;, cs);</span>
<a href="#l7.97"></a><span id="l7.97">         }</span>
<a href="#l7.98"></a><span id="l7.98">       }</span>
<a href="#l7.99"></a><span id="l7.99"> </span>
<a href="#l7.100"></a><span id="l7.100">       // In UI version 7, the three-state doNotTrack setting was reverted back</span>
<a href="#l7.101"></a><span id="l7.101">       // to two-state. This reverts a (no longer supported) setting of &quot;please</span>
<a href="#l7.102"></a><span id="l7.102">       // track me&quot; to the default &quot;don't say anything&quot;.</span>
<a href="#l7.103"></a><span id="l7.103">       if (currentUIVersion &lt; 7) {</span>
<a href="#l7.104"></a><span id="l7.104">         try {</span>
<a href="#l7.105"></a><span id="l7.105">           if (Services.prefs.getBoolPref(&quot;privacy.donottrackheader.enabled&quot;) &amp;&amp;</span>
<a href="#l7.106"></a><span id="l7.106">               Services.prefs.getIntPref(&quot;privacy.donottrackheader.value&quot;) != 1) {</span>
<a href="#l7.107"></a><span id="l7.107">             Services.prefs.clearUserPref(&quot;privacy.donottrackheader.enabled&quot;);</span>
<a href="#l7.108"></a><span id="l7.108">             Services.prefs.clearUserPref(&quot;privacy.donottrackheader.value&quot;);</span>
<a href="#l7.109"></a><span id="l7.109">           }</span>
<a href="#l7.110"></a><span id="l7.110" class="difflineminus">-        }</span>
<a href="#l7.111"></a><span id="l7.111" class="difflineminus">-        catch (ex) {}</span>
<a href="#l7.112"></a><span id="l7.112" class="difflineplus">+        } catch (ex) {}</span>
<a href="#l7.113"></a><span id="l7.113">       }</span>
<a href="#l7.114"></a><span id="l7.114"> </span>
<a href="#l7.115"></a><span id="l7.115">       // In UI version 8, we change from boolean browser.display.use_document_colors</span>
<a href="#l7.116"></a><span id="l7.116">       // to the tri-state browser.display.document_color_use.</span>
<a href="#l7.117"></a><span id="l7.117">       if (currentUIVersion &lt; 8) {</span>
<a href="#l7.118"></a><span id="l7.118">         const kOldColorPref = &quot;browser.display.use_document_colors&quot;;</span>
<a href="#l7.119"></a><span id="l7.119">         if (Services.prefs.prefHasUserValue(kOldColorPref) &amp;&amp;</span>
<a href="#l7.120"></a><span id="l7.120">             !Services.prefs.getBoolPref(kOldColorPref)) {</span>
<a href="#l7.121"></a><span id="l7.121" class="difflineat">@@ -166,17 +157,17 @@ var MailMigrator = {</span>
<a href="#l7.122"></a><span id="l7.122">       }</span>
<a href="#l7.123"></a><span id="l7.123"> </span>
<a href="#l7.124"></a><span id="l7.124">       // Limit the charset detector pref to values (now) available from the UI.</span>
<a href="#l7.125"></a><span id="l7.125">       if (currentUIVersion &lt; 9) {</span>
<a href="#l7.126"></a><span id="l7.126">         let detector = null;</span>
<a href="#l7.127"></a><span id="l7.127">         try {</span>
<a href="#l7.128"></a><span id="l7.128">           detector = Services.prefs.getComplexValue(&quot;intl.charset.detector&quot;,</span>
<a href="#l7.129"></a><span id="l7.129">                                                     Ci.nsIPrefLocalizedString).data;</span>
<a href="#l7.130"></a><span id="l7.130" class="difflineminus">-        } catch (ex) { }</span>
<a href="#l7.131"></a><span id="l7.131" class="difflineplus">+        } catch (ex) {}</span>
<a href="#l7.132"></a><span id="l7.132">         if (!(detector == &quot;&quot; ||</span>
<a href="#l7.133"></a><span id="l7.133">               detector == &quot;ja_parallel_state_machine&quot; ||</span>
<a href="#l7.134"></a><span id="l7.134">               detector == &quot;ruprob&quot; ||</span>
<a href="#l7.135"></a><span id="l7.135">               detector == &quot;ukprob&quot;)) {</span>
<a href="#l7.136"></a><span id="l7.136">           // If the encoding detector pref value is not reachable from the UI,</span>
<a href="#l7.137"></a><span id="l7.137">           // reset to default (varies by localization).</span>
<a href="#l7.138"></a><span id="l7.138">           Services.prefs.clearUserPref(&quot;intl.charset.detector&quot;);</span>
<a href="#l7.139"></a><span id="l7.139">         }</span>
<a href="#l7.140"></a><span id="l7.140" class="difflineat">@@ -191,18 +182,17 @@ var MailMigrator = {</span>
<a href="#l7.141"></a><span id="l7.141">         // and save it, else, just write the &quot;All ABs&quot; URI to the file.</span>
<a href="#l7.142"></a><span id="l7.142">         let data = IOUtils.loadFileToString(DIR_TREE_FILE);</span>
<a href="#l7.143"></a><span id="l7.143">         if (!data || data == &quot;[]&quot;) {</span>
<a href="#l7.144"></a><span id="l7.144">           data = &quot;&quot;;</span>
<a href="#l7.145"></a><span id="l7.145">         } else if (data.length &gt; 0) {</span>
<a href="#l7.146"></a><span id="l7.146">           data = data.substring(1, data.length - 1);</span>
<a href="#l7.147"></a><span id="l7.147">         }</span>
<a href="#l7.148"></a><span id="l7.148"> </span>
<a href="#l7.149"></a><span id="l7.149" class="difflineminus">-        data = &quot;[&quot; + &quot;\&quot;moz-abdirectory://?\&quot;&quot; +</span>
<a href="#l7.150"></a><span id="l7.150" class="difflineminus">-               ((data.length &gt; 0) ? (&quot;,&quot; + data) : &quot;&quot;) + &quot;]&quot;;</span>
<a href="#l7.151"></a><span id="l7.151" class="difflineplus">+        data = &quot;[\&quot;moz-abdirectory://?\&quot;&quot; + ((data.length &gt; 0) ? (&quot;,&quot; + data) : &quot;&quot;) + &quot;]&quot;;</span>
<a href="#l7.152"></a><span id="l7.152"> </span>
<a href="#l7.153"></a><span id="l7.153">         IOUtils.saveStringToFile(DIR_TREE_FILE, data);</span>
<a href="#l7.154"></a><span id="l7.154">       }</span>
<a href="#l7.155"></a><span id="l7.155"> </span>
<a href="#l7.156"></a><span id="l7.156">       // Several Latin language groups were consolidated into x-western.</span>
<a href="#l7.157"></a><span id="l7.157">       if (currentUIVersion &lt; 11) {</span>
<a href="#l7.158"></a><span id="l7.158">         let group = null;</span>
<a href="#l7.159"></a><span id="l7.159">         try {</span>
<a href="#l7.160"></a><span id="l7.160" class="difflineat">@@ -223,17 +213,17 @@ var MailMigrator = {</span>
<a href="#l7.161"></a><span id="l7.161">           Services.prefs.getBoolPref(&quot;editor.CR_creates_new_p&quot;));</span>
<a href="#l7.162"></a><span id="l7.162">         Services.prefs.clearUserPref(&quot;editor.CR_creates_new_p&quot;);</span>
<a href="#l7.163"></a><span id="l7.163">       }</span>
<a href="#l7.164"></a><span id="l7.164"> </span>
<a href="#l7.165"></a><span id="l7.165">       // Migrate remote content exceptions for email addresses which are</span>
<a href="#l7.166"></a><span id="l7.166">       // encoded as chrome URIs.</span>
<a href="#l7.167"></a><span id="l7.167">       if (currentUIVersion &lt; 14) {</span>
<a href="#l7.168"></a><span id="l7.168">         let permissionsDB =</span>
<a href="#l7.169"></a><span id="l7.169" class="difflineminus">-          Services.dirsvc.get(&quot;ProfD&quot;,Ci.nsIFile);</span>
<a href="#l7.170"></a><span id="l7.170" class="difflineplus">+          Services.dirsvc.get(&quot;ProfD&quot;, Ci.nsIFile);</span>
<a href="#l7.171"></a><span id="l7.171">         permissionsDB.append(&quot;permissions.sqlite&quot;);</span>
<a href="#l7.172"></a><span id="l7.172">         let db = Services.storage.openDatabase(permissionsDB);</span>
<a href="#l7.173"></a><span id="l7.173"> </span>
<a href="#l7.174"></a><span id="l7.174">         try {</span>
<a href="#l7.175"></a><span id="l7.175">           let statement = db.createStatement(</span>
<a href="#l7.176"></a><span id="l7.176">             &quot;select origin,permission from moz_perms where &quot; +</span>
<a href="#l7.177"></a><span id="l7.177">             // Avoid 'like' here which needs to be escaped.</span>
<a href="#l7.178"></a><span id="l7.178">             &quot;substr(origin, 1, 28)='chrome://messenger/content/?';&quot;);</span>
<a href="#l7.179"></a><span id="l7.179" class="difflineat">@@ -336,31 +326,32 @@ var MailMigrator = {</span>
<a href="#l7.180"></a><span id="l7.180">           xulStore.setValue(MESSENGERCOMPOSE_DOCURL, &quot;composeToolbar2&quot;,</span>
<a href="#l7.181"></a><span id="l7.181">                             &quot;currentset&quot;, cs);</span>
<a href="#l7.182"></a><span id="l7.182">         }</span>
<a href="#l7.183"></a><span id="l7.183">       }</span>
<a href="#l7.184"></a><span id="l7.184"> </span>
<a href="#l7.185"></a><span id="l7.185">       // Update the migration version.</span>
<a href="#l7.186"></a><span id="l7.186">       Services.prefs.setIntPref(UI_VERSION_PREF, UI_VERSION);</span>
<a href="#l7.187"></a><span id="l7.187"> </span>
<a href="#l7.188"></a><span id="l7.188" class="difflineminus">-    } catch(e) {</span>
<a href="#l7.189"></a><span id="l7.189" class="difflineplus">+    } catch (e) {</span>
<a href="#l7.190"></a><span id="l7.190">       Cu.reportError(&quot;Migrating from UI version &quot; + currentUIVersion + &quot; to &quot; +</span>
<a href="#l7.191"></a><span id="l7.191">                      UI_VERSION + &quot; failed. Error message was: &quot; + e + &quot; -- &quot; +</span>
<a href="#l7.192"></a><span id="l7.192">                      &quot;Will reattempt on next start.&quot;);</span>
<a href="#l7.193"></a><span id="l7.193">     }</span>
<a href="#l7.194"></a><span id="l7.194">   },</span>
<a href="#l7.195"></a><span id="l7.195" class="difflineplus">+  /* eslint-enable complexity */</span>
<a href="#l7.196"></a><span id="l7.196"> </span>
<a href="#l7.197"></a><span id="l7.197">   /**</span>
<a href="#l7.198"></a><span id="l7.198">    * Perform any migration work that needs to occur after the Account Wizard</span>
<a href="#l7.199"></a><span id="l7.199">    * has had a chance to appear.</span>
<a href="#l7.200"></a><span id="l7.200">    */</span>
<a href="#l7.201"></a><span id="l7.201" class="difflineminus">-  migratePostAccountWizard: function MailMigrator_migratePostAccountWizard() {</span>
<a href="#l7.202"></a><span id="l7.202" class="difflineplus">+  migratePostAccountWizard() {</span>
<a href="#l7.203"></a><span id="l7.203">     this.migrateToClearTypeFonts();</span>
<a href="#l7.204"></a><span id="l7.204">   },</span>
<a href="#l7.205"></a><span id="l7.205"> </span>
<a href="#l7.206"></a><span id="l7.206">   /**</span>
<a href="#l7.207"></a><span id="l7.207">    * Perform any migration work that needs to occur once the user profile has</span>
<a href="#l7.208"></a><span id="l7.208">    * been loaded.</span>
<a href="#l7.209"></a><span id="l7.209">    */</span>
<a href="#l7.210"></a><span id="l7.210" class="difflineminus">-  migrateAtProfileStartup: function MailMigrator_migrateAtProfileStartup() {</span>
<a href="#l7.211"></a><span id="l7.211" class="difflineplus">+  migrateAtProfileStartup() {</span>
<a href="#l7.212"></a><span id="l7.212">     this._migrateUI();</span>
<a href="#l7.213"></a><span id="l7.213">   },</span>
<a href="#l7.214"></a><span id="l7.214"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mail/base/modules/MailUtils.jsm</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mail/base/modules/MailUtils.jsm</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -1,43 +1,44 @@</span>
<a href="#l8.4"></a><span id="l8.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l8.5"></a><span id="l8.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l8.6"></a><span id="l8.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l8.7"></a><span id="l8.7"> </span>
<a href="#l8.8"></a><span id="l8.8"> var EXPORTED_SYMBOLS = [&quot;MailUtils&quot;];</span>
<a href="#l8.9"></a><span id="l8.9"> </span>
<a href="#l8.10"></a><span id="l8.10" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;);</span>
<a href="#l8.11"></a><span id="l8.11" class="difflineplus">+const {</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+  fixIterator,</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+  toXPCOMArray,</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineplus">+} = ChromeUtils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;, null);</span>
<a href="#l8.15"></a><span id="l8.15"> ChromeUtils.import(&quot;resource:///modules/MailConsts.jsm&quot;);</span>
<a href="#l8.16"></a><span id="l8.16"> ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l8.17"></a><span id="l8.17"> ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l8.18"></a><span id="l8.18"> ChromeUtils.import(&quot;resource://gre/modules/PluralForm.jsm&quot;);</span>
<a href="#l8.19"></a><span id="l8.19"> </span>
<a href="#l8.20"></a><span id="l8.20"> var MC = MailConsts;</span>
<a href="#l8.21"></a><span id="l8.21"> </span>
<a href="#l8.22"></a><span id="l8.22"> /**</span>
<a href="#l8.23"></a><span id="l8.23">  * This module has several utility functions for use by both core and</span>
<a href="#l8.24"></a><span id="l8.24">  * third-party code. Some functions are aimed at code that doesn't have a</span>
<a href="#l8.25"></a><span id="l8.25">  * window context, while others can be used anywhere.</span>
<a href="#l8.26"></a><span id="l8.26">  */</span>
<a href="#l8.27"></a><span id="l8.27" class="difflineminus">-var MailUtils =</span>
<a href="#l8.28"></a><span id="l8.28" class="difflineminus">-{</span>
<a href="#l8.29"></a><span id="l8.29" class="difflineplus">+var MailUtils = {</span>
<a href="#l8.30"></a><span id="l8.30">   /**</span>
<a href="#l8.31"></a><span id="l8.31">    * Discover all folders. This is useful during startup, when you have code</span>
<a href="#l8.32"></a><span id="l8.32">    * that deals with folders and that executes before the main 3pane window is</span>
<a href="#l8.33"></a><span id="l8.33">    * open (the folder tree wouldn't have been initialized yet).</span>
<a href="#l8.34"></a><span id="l8.34">    */</span>
<a href="#l8.35"></a><span id="l8.35" class="difflineminus">-  discoverFolders: function MailUtils_discoverFolders() {</span>
<a href="#l8.36"></a><span id="l8.36" class="difflineplus">+  discoverFolders() {</span>
<a href="#l8.37"></a><span id="l8.37">     let servers = MailServices.accounts.allServers;</span>
<a href="#l8.38"></a><span id="l8.38">     for (let server of fixIterator(servers, Ci.nsIMsgIncomingServer)) {</span>
<a href="#l8.39"></a><span id="l8.39">       // Bug 466311 Sometimes this can throw file not found, we're unsure</span>
<a href="#l8.40"></a><span id="l8.40">       // why, but catch it and log the fact.</span>
<a href="#l8.41"></a><span id="l8.41">       try {</span>
<a href="#l8.42"></a><span id="l8.42">         server.rootFolder.subFolders;</span>
<a href="#l8.43"></a><span id="l8.43" class="difflineminus">-      }</span>
<a href="#l8.44"></a><span id="l8.44" class="difflineminus">-      catch (ex) {</span>
<a href="#l8.45"></a><span id="l8.45" class="difflineplus">+      } catch (ex) {</span>
<a href="#l8.46"></a><span id="l8.46">         Services.console.logStringMessage(&quot;Discovering folders for account failed with &quot; +</span>
<a href="#l8.47"></a><span id="l8.47">                                           &quot;exception: &quot; + ex);</span>
<a href="#l8.48"></a><span id="l8.48">       }</span>
<a href="#l8.49"></a><span id="l8.49">     }</span>
<a href="#l8.50"></a><span id="l8.50">   },</span>
<a href="#l8.51"></a><span id="l8.51"> </span>
<a href="#l8.52"></a><span id="l8.52">   /**</span>
<a href="#l8.53"></a><span id="l8.53">    * Get the nsIMsgFolder corresponding to this file. This just looks at all</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineat">@@ -46,18 +47,17 @@ var MailUtils =</span>
<a href="#l8.55"></a><span id="l8.55">    * One of the places this is used is desktop search integration -- to open</span>
<a href="#l8.56"></a><span id="l8.56">    * the search result corresponding to a mozeml/wdseml file, we need to figure</span>
<a href="#l8.57"></a><span id="l8.57">    * out the folder using the file's path.</span>
<a href="#l8.58"></a><span id="l8.58">    *</span>
<a href="#l8.59"></a><span id="l8.59">    * @param aFile the nsIFile to convert to a folder</span>
<a href="#l8.60"></a><span id="l8.60">    * @returns the nsIMsgFolder corresponding to aFile, or null if the folder</span>
<a href="#l8.61"></a><span id="l8.61">    *          isn't found</span>
<a href="#l8.62"></a><span id="l8.62">    */</span>
<a href="#l8.63"></a><span id="l8.63" class="difflineminus">-  getFolderForFileInProfile:</span>
<a href="#l8.64"></a><span id="l8.64" class="difflineminus">-      function MailUtils_getFolderForFileInProfile(aFile) {</span>
<a href="#l8.65"></a><span id="l8.65" class="difflineplus">+  getFolderForFileInProfile(aFile) {</span>
<a href="#l8.66"></a><span id="l8.66">     let folders = MailServices.accounts.allFolders;</span>
<a href="#l8.67"></a><span id="l8.67"> </span>
<a href="#l8.68"></a><span id="l8.68">     for (let folder of fixIterator(folders, Ci.nsIMsgFolder)) {</span>
<a href="#l8.69"></a><span id="l8.69">       if (folder.filePath.equals(aFile))</span>
<a href="#l8.70"></a><span id="l8.70">         return folder;</span>
<a href="#l8.71"></a><span id="l8.71">     }</span>
<a href="#l8.72"></a><span id="l8.72">     return null;</span>
<a href="#l8.73"></a><span id="l8.73">   },</span>
<a href="#l8.74"></a><span id="l8.74" class="difflineat">@@ -68,28 +68,26 @@ var MailUtils =</span>
<a href="#l8.75"></a><span id="l8.75">    *</span>
<a href="#l8.76"></a><span id="l8.76">    * @param aFolderURI the URI to convert into a folder</span>
<a href="#l8.77"></a><span id="l8.77">    * @param aCheckFolderAttributes whether to check that the folder either has</span>
<a href="#l8.78"></a><span id="l8.78">    *                              a parent or isn't a server</span>
<a href="#l8.79"></a><span id="l8.79">    * @returns the nsIMsgFolder corresponding to this URI, or null if</span>
<a href="#l8.80"></a><span id="l8.80">    *          aCheckFolderAttributes is true and the folder doesn't have a</span>
<a href="#l8.81"></a><span id="l8.81">    *          parent or is a server</span>
<a href="#l8.82"></a><span id="l8.82">    */</span>
<a href="#l8.83"></a><span id="l8.83" class="difflineminus">-  getFolderForURI: function MailUtils_getFolderForURI(aFolderURI,</span>
<a href="#l8.84"></a><span id="l8.84" class="difflineminus">-                       aCheckFolderAttributes) {</span>
<a href="#l8.85"></a><span id="l8.85" class="difflineplus">+  getFolderForURI(aFolderURI, aCheckFolderAttributes) {</span>
<a href="#l8.86"></a><span id="l8.86">     let folder = null;</span>
<a href="#l8.87"></a><span id="l8.87" class="difflineminus">-    let rdfService = Cc['@mozilla.org/rdf/rdf-service;1']</span>
<a href="#l8.88"></a><span id="l8.88" class="difflineplus">+    let rdfService = Cc[&quot;@mozilla.org/rdf/rdf-service;1&quot;]</span>
<a href="#l8.89"></a><span id="l8.89">                        .getService(Ci.nsIRDFService);</span>
<a href="#l8.90"></a><span id="l8.90">     folder = rdfService.GetResource(aFolderURI);</span>
<a href="#l8.91"></a><span id="l8.91">     // This is going to QI the folder to an nsIMsgFolder as well</span>
<a href="#l8.92"></a><span id="l8.92">     if (folder &amp;&amp; folder instanceof Ci.nsIMsgFolder) {</span>
<a href="#l8.93"></a><span id="l8.93">       if (aCheckFolderAttributes &amp;&amp; !(folder.parent || folder.isServer))</span>
<a href="#l8.94"></a><span id="l8.94">         return null;</span>
<a href="#l8.95"></a><span id="l8.95" class="difflineminus">-    }</span>
<a href="#l8.96"></a><span id="l8.96" class="difflineminus">-    else {</span>
<a href="#l8.97"></a><span id="l8.97" class="difflineplus">+    } else {</span>
<a href="#l8.98"></a><span id="l8.98">       return null;</span>
<a href="#l8.99"></a><span id="l8.99">     }</span>
<a href="#l8.100"></a><span id="l8.100"> </span>
<a href="#l8.101"></a><span id="l8.101">     return folder;</span>
<a href="#l8.102"></a><span id="l8.102">   },</span>
<a href="#l8.103"></a><span id="l8.103"> </span>
<a href="#l8.104"></a><span id="l8.104">   /**</span>
<a href="#l8.105"></a><span id="l8.105">    * Display this message header in a new tab, a new window or an existing</span>
<a href="#l8.106"></a><span id="l8.106" class="difflineat">@@ -106,30 +104,29 @@ var MailUtils =</span>
<a href="#l8.107"></a><span id="l8.107">    *                              view will be used</span>
<a href="#l8.108"></a><span id="l8.108">    * @param [aTabmail] a tabmail element to use in case we need to open tabs.</span>
<a href="#l8.109"></a><span id="l8.109">    *                   If null or not given:</span>
<a href="#l8.110"></a><span id="l8.110">    *                   - if one or more 3pane windows are open, the most recent</span>
<a href="#l8.111"></a><span id="l8.111">    *                     one's tabmail is used</span>
<a href="#l8.112"></a><span id="l8.112">    *                   - if no 3pane windows are open, a standalone window is</span>
<a href="#l8.113"></a><span id="l8.113">    *                     opened instead of a tab</span>
<a href="#l8.114"></a><span id="l8.114">    */</span>
<a href="#l8.115"></a><span id="l8.115" class="difflineminus">-  displayMessage: function MailUtils_displayMessage(aMsgHdr,</span>
<a href="#l8.116"></a><span id="l8.116" class="difflineminus">-                      aViewWrapperToClone, aTabmail) {</span>
<a href="#l8.117"></a><span id="l8.117" class="difflineplus">+  displayMessage(aMsgHdr, aViewWrapperToClone, aTabmail) {</span>
<a href="#l8.118"></a><span id="l8.118">     this.displayMessages([aMsgHdr], aViewWrapperToClone, aTabmail);</span>
<a href="#l8.119"></a><span id="l8.119">   },</span>
<a href="#l8.120"></a><span id="l8.120"> </span>
<a href="#l8.121"></a><span id="l8.121">   /**</span>
<a href="#l8.122"></a><span id="l8.122">    * Display the warning if the number of messages to be displayed is greater than</span>
<a href="#l8.123"></a><span id="l8.123">    * the limit set in preferences.</span>
<a href="#l8.124"></a><span id="l8.124">    * @param aNumMessages: number of messages to be displayed</span>
<a href="#l8.125"></a><span id="l8.125">    * @param aConfirmTitle: title ID</span>
<a href="#l8.126"></a><span id="l8.126">    * @param aConfirmMsg: message ID</span>
<a href="#l8.127"></a><span id="l8.127">    * @param aLiitingPref: the name of the pref to retrieve the limit from</span>
<a href="#l8.128"></a><span id="l8.128">    */</span>
<a href="#l8.129"></a><span id="l8.129" class="difflineminus">-  confirmAction: function (aNumMessages, aConfirmTitle, aConfirmMsg, aLimitingPref) {</span>
<a href="#l8.130"></a><span id="l8.130" class="difflineplus">+  confirmAction(aNumMessages, aConfirmTitle, aConfirmMsg, aLimitingPref) {</span>
<a href="#l8.131"></a><span id="l8.131">     let openWarning = Services.prefs.getIntPref(aLimitingPref);</span>
<a href="#l8.132"></a><span id="l8.132">     if ((openWarning &gt; 1) &amp;&amp; (aNumMessages &gt;= openWarning)) {</span>
<a href="#l8.133"></a><span id="l8.133">       let bundle = Services.strings.createBundle(</span>
<a href="#l8.134"></a><span id="l8.134">         &quot;chrome://messenger/locale/messenger.properties&quot;);</span>
<a href="#l8.135"></a><span id="l8.135">       let title = bundle.GetStringFromName(aConfirmTitle);</span>
<a href="#l8.136"></a><span id="l8.136">       let message = PluralForm.get(aNumMessages,</span>
<a href="#l8.137"></a><span id="l8.137">         bundle.GetStringFromName(aConfirmMsg))</span>
<a href="#l8.138"></a><span id="l8.138">                 .replace(&quot;#1&quot;, aNumMessages);</span>
<a href="#l8.139"></a><span id="l8.139" class="difflineat">@@ -153,91 +150,85 @@ var MailUtils =</span>
<a href="#l8.140"></a><span id="l8.140">    *                   If given, the window containing the tabmail is assumed</span>
<a href="#l8.141"></a><span id="l8.141">    *                   to be in front. If null or not given:</span>
<a href="#l8.142"></a><span id="l8.142">    *                   - if one or more 3pane windows are open, the most recent</span>
<a href="#l8.143"></a><span id="l8.143">    *                     one's tabmail is used, and the window is brought to the</span>
<a href="#l8.144"></a><span id="l8.144">    *                     front</span>
<a href="#l8.145"></a><span id="l8.145">    *                   - if no 3pane windows are open, standalone windows are</span>
<a href="#l8.146"></a><span id="l8.146">    *                     opened instead of tabs</span>
<a href="#l8.147"></a><span id="l8.147">    */</span>
<a href="#l8.148"></a><span id="l8.148" class="difflineminus">-  displayMessages: function MailUtils_displayMessages(aMsgHdrs,</span>
<a href="#l8.149"></a><span id="l8.149" class="difflineminus">-                       aViewWrapperToClone, aTabmail) {</span>
<a href="#l8.150"></a><span id="l8.150" class="difflineplus">+  displayMessages(aMsgHdrs, aViewWrapperToClone, aTabmail) {</span>
<a href="#l8.151"></a><span id="l8.151">     let openMessageBehavior = Services.prefs.getIntPref(</span>
<a href="#l8.152"></a><span id="l8.152">                                   &quot;mail.openMessageBehavior&quot;);</span>
<a href="#l8.153"></a><span id="l8.153"> </span>
<a href="#l8.154"></a><span id="l8.154">     if (openMessageBehavior == MC.OpenMessageBehavior.NEW_WINDOW) {</span>
<a href="#l8.155"></a><span id="l8.155">       this.openMessagesInNewWindows(aMsgHdrs, aViewWrapperToClone);</span>
<a href="#l8.156"></a><span id="l8.156" class="difflineminus">-    }</span>
<a href="#l8.157"></a><span id="l8.157" class="difflineminus">-    else if (openMessageBehavior == MC.OpenMessageBehavior.EXISTING_WINDOW) {</span>
<a href="#l8.158"></a><span id="l8.158" class="difflineplus">+    } else if (openMessageBehavior == MC.OpenMessageBehavior.EXISTING_WINDOW) {</span>
<a href="#l8.159"></a><span id="l8.159">       // Try reusing an existing window. If we can't, fall back to opening new</span>
<a href="#l8.160"></a><span id="l8.160">       // windows</span>
<a href="#l8.161"></a><span id="l8.161">       if (aMsgHdrs.length &gt; 1 || !this.openMessageInExistingWindow(aMsgHdrs[0]))</span>
<a href="#l8.162"></a><span id="l8.162">         this.openMessagesInNewWindows(aMsgHdrs, aViewWrapperToClone);</span>
<a href="#l8.163"></a><span id="l8.163" class="difflineminus">-    }</span>
<a href="#l8.164"></a><span id="l8.164" class="difflineminus">-    else if (openMessageBehavior == MC.OpenMessageBehavior.NEW_TAB) {</span>
<a href="#l8.165"></a><span id="l8.165" class="difflineplus">+    } else if (openMessageBehavior == MC.OpenMessageBehavior.NEW_TAB) {</span>
<a href="#l8.166"></a><span id="l8.166">       let mail3PaneWindow = null;</span>
<a href="#l8.167"></a><span id="l8.167">       if (!aTabmail) {</span>
<a href="#l8.168"></a><span id="l8.168">         // Try opening new tabs in a 3pane window</span>
<a href="#l8.169"></a><span id="l8.169">         mail3PaneWindow = Services.wm.getMostRecentWindow(&quot;mail:3pane&quot;);</span>
<a href="#l8.170"></a><span id="l8.170">         if (mail3PaneWindow)</span>
<a href="#l8.171"></a><span id="l8.171">           aTabmail = mail3PaneWindow.document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l8.172"></a><span id="l8.172">       }</span>
<a href="#l8.173"></a><span id="l8.173"> </span>
<a href="#l8.174"></a><span id="l8.174">       if (aTabmail) {</span>
<a href="#l8.175"></a><span id="l8.175">         if (this.confirmAction(aMsgHdrs.length, &quot;openTabWarningTitle&quot;,</span>
<a href="#l8.176"></a><span id="l8.176">                                &quot;openTabWarningConfirmation&quot;,</span>
<a href="#l8.177"></a><span id="l8.177">                                &quot;mailnews.open_tab_warning&quot;))</span>
<a href="#l8.178"></a><span id="l8.178">           return;</span>
<a href="#l8.179"></a><span id="l8.179">         for (let [i, msgHdr] of aMsgHdrs.entries())</span>
<a href="#l8.180"></a><span id="l8.180">           // Open all the tabs in the background, except for the last one</span>
<a href="#l8.181"></a><span id="l8.181" class="difflineminus">-          aTabmail.openTab(&quot;message&quot;, {msgHdr: msgHdr,</span>
<a href="#l8.182"></a><span id="l8.182" class="difflineminus">-              viewWrapperToClone: aViewWrapperToClone,</span>
<a href="#l8.183"></a><span id="l8.183" class="difflineminus">-              background: (i &lt; (aMsgHdrs.length - 1)),</span>
<a href="#l8.184"></a><span id="l8.184" class="difflineminus">-              disregardOpener: (aMsgHdrs.length &gt; 1),</span>
<a href="#l8.185"></a><span id="l8.185" class="difflineplus">+          aTabmail.openTab(&quot;message&quot;, {</span>
<a href="#l8.186"></a><span id="l8.186" class="difflineplus">+            msgHdr,</span>
<a href="#l8.187"></a><span id="l8.187" class="difflineplus">+            viewWrapperToClone: aViewWrapperToClone,</span>
<a href="#l8.188"></a><span id="l8.188" class="difflineplus">+            background: (i &lt; (aMsgHdrs.length - 1)),</span>
<a href="#l8.189"></a><span id="l8.189" class="difflineplus">+            disregardOpener: (aMsgHdrs.length &gt; 1),</span>
<a href="#l8.190"></a><span id="l8.190">           });</span>
<a href="#l8.191"></a><span id="l8.191"> </span>
<a href="#l8.192"></a><span id="l8.192">         if (mail3PaneWindow)</span>
<a href="#l8.193"></a><span id="l8.193">           mail3PaneWindow.focus();</span>
<a href="#l8.194"></a><span id="l8.194" class="difflineminus">-      }</span>
<a href="#l8.195"></a><span id="l8.195" class="difflineminus">-      else {</span>
<a href="#l8.196"></a><span id="l8.196" class="difflineplus">+      } else {</span>
<a href="#l8.197"></a><span id="l8.197">         // We still haven't found a tabmail, so we'll need to open new windows</span>
<a href="#l8.198"></a><span id="l8.198">         this.openMessagesInNewWindows(aMsgHdrs, aViewWrapperToClone);</span>
<a href="#l8.199"></a><span id="l8.199">       }</span>
<a href="#l8.200"></a><span id="l8.200">     }</span>
<a href="#l8.201"></a><span id="l8.201">   },</span>
<a href="#l8.202"></a><span id="l8.202"> </span>
<a href="#l8.203"></a><span id="l8.203">   /**</span>
<a href="#l8.204"></a><span id="l8.204">    * Show this message in an existing window.</span>
<a href="#l8.205"></a><span id="l8.205">    *</span>
<a href="#l8.206"></a><span id="l8.206">    * @param aMsgHdr the message header to display</span>
<a href="#l8.207"></a><span id="l8.207">    * @param [aViewWrapperToClone] a DB view wrapper to clone for the message</span>
<a href="#l8.208"></a><span id="l8.208">    *                              window</span>
<a href="#l8.209"></a><span id="l8.209">    * @returns true if an existing window was found and the message header was</span>
<a href="#l8.210"></a><span id="l8.210">    *          displayed, false otherwise</span>
<a href="#l8.211"></a><span id="l8.211">    */</span>
<a href="#l8.212"></a><span id="l8.212" class="difflineminus">-  openMessageInExistingWindow:</span>
<a href="#l8.213"></a><span id="l8.213" class="difflineminus">-      function MailUtils_openMessageInExistingWindow(aMsgHdr,</span>
<a href="#l8.214"></a><span id="l8.214" class="difflineminus">-                                                     aViewWrapperToClone) {</span>
<a href="#l8.215"></a><span id="l8.215" class="difflineplus">+  openMessageInExistingWindow(aMsgHdr, aViewWrapperToClone) {</span>
<a href="#l8.216"></a><span id="l8.216">     let messageWindow = Services.wm.getMostRecentWindow(&quot;mail:messageWindow&quot;);</span>
<a href="#l8.217"></a><span id="l8.217">     if (messageWindow) {</span>
<a href="#l8.218"></a><span id="l8.218">       messageWindow.displayMessage(aMsgHdr, aViewWrapperToClone);</span>
<a href="#l8.219"></a><span id="l8.219">       return true;</span>
<a href="#l8.220"></a><span id="l8.220">     }</span>
<a href="#l8.221"></a><span id="l8.221">     return false;</span>
<a href="#l8.222"></a><span id="l8.222">   },</span>
<a href="#l8.223"></a><span id="l8.223"> </span>
<a href="#l8.224"></a><span id="l8.224">   /**</span>
<a href="#l8.225"></a><span id="l8.225">    * Open a new standalone message window with this header.</span>
<a href="#l8.226"></a><span id="l8.226">    *</span>
<a href="#l8.227"></a><span id="l8.227">    * @param aMsgHdr the message header to display</span>
<a href="#l8.228"></a><span id="l8.228">    * @param [aViewWrapperToClone] a DB view wrapper to clone for the message</span>
<a href="#l8.229"></a><span id="l8.229">    *                              window</span>
<a href="#l8.230"></a><span id="l8.230">    */</span>
<a href="#l8.231"></a><span id="l8.231" class="difflineminus">-  openMessageInNewWindow:</span>
<a href="#l8.232"></a><span id="l8.232" class="difflineminus">-      function MailUtils_openMessageInNewWindow(aMsgHdr, aViewWrapperToClone) {</span>
<a href="#l8.233"></a><span id="l8.233" class="difflineplus">+  openMessageInNewWindow(aMsgHdr, aViewWrapperToClone) {</span>
<a href="#l8.234"></a><span id="l8.234">     // It sucks that we have to go through XPCOM for this</span>
<a href="#l8.235"></a><span id="l8.235">     let args = {msgHdr: aMsgHdr, viewWrapperToClone: aViewWrapperToClone};</span>
<a href="#l8.236"></a><span id="l8.236">     args.wrappedJSObject = args;</span>
<a href="#l8.237"></a><span id="l8.237"> </span>
<a href="#l8.238"></a><span id="l8.238">     Services.ww.openWindow(null,</span>
<a href="#l8.239"></a><span id="l8.239">         &quot;chrome://messenger/content/messageWindow.xul&quot;, &quot;&quot;,</span>
<a href="#l8.240"></a><span id="l8.240">         &quot;all,chrome,dialog=no,status,toolbar&quot;, args);</span>
<a href="#l8.241"></a><span id="l8.241">   },</span>
<a href="#l8.242"></a><span id="l8.242" class="difflineat">@@ -246,43 +237,39 @@ var MailUtils =</span>
<a href="#l8.243"></a><span id="l8.243">    * Open new standalone message windows for these headers. This will prompt</span>
<a href="#l8.244"></a><span id="l8.244">    * for confirmation if the number of windows to be opened is greater than the</span>
<a href="#l8.245"></a><span id="l8.245">    * value of the mailnews.open_window_warning preference.</span>
<a href="#l8.246"></a><span id="l8.246">    *</span>
<a href="#l8.247"></a><span id="l8.247">    * @param aMsgHdrs an array containing the message headers to display</span>
<a href="#l8.248"></a><span id="l8.248">    * @param [aViewWrapperToClone] a DB view wrapper to clone for each message</span>
<a href="#l8.249"></a><span id="l8.249">    *                              window</span>
<a href="#l8.250"></a><span id="l8.250">    */</span>
<a href="#l8.251"></a><span id="l8.251" class="difflineminus">-   openMessagesInNewWindows:</span>
<a href="#l8.252"></a><span id="l8.252" class="difflineminus">-       function MailUtils_openMessagesInNewWindows(aMsgHdrs,</span>
<a href="#l8.253"></a><span id="l8.253" class="difflineminus">-                                                   aViewWrapperToClone) {</span>
<a href="#l8.254"></a><span id="l8.254" class="difflineplus">+  openMessagesInNewWindows(aMsgHdrs, aViewWrapperToClone) {</span>
<a href="#l8.255"></a><span id="l8.255">     if (this.confirmAction(aMsgHdrs.length, &quot;openWindowWarningTitle&quot;,</span>
<a href="#l8.256"></a><span id="l8.256">                            &quot;openWindowWarningConfirmation&quot;,</span>
<a href="#l8.257"></a><span id="l8.257">                            &quot;mailnews.open_window_warning&quot;))</span>
<a href="#l8.258"></a><span id="l8.258">       return;</span>
<a href="#l8.259"></a><span id="l8.259"> </span>
<a href="#l8.260"></a><span id="l8.260">     for (let msgHdr of aMsgHdrs)</span>
<a href="#l8.261"></a><span id="l8.261">       this.openMessageInNewWindow(msgHdr, aViewWrapperToClone);</span>
<a href="#l8.262"></a><span id="l8.262">   },</span>
<a href="#l8.263"></a><span id="l8.263"> </span>
<a href="#l8.264"></a><span id="l8.264">   /**</span>
<a href="#l8.265"></a><span id="l8.265">    * Display this message header in a folder tab in a 3pane window. This is</span>
<a href="#l8.266"></a><span id="l8.266">    * useful when the message needs to be displayed in the context of its folder</span>
<a href="#l8.267"></a><span id="l8.267">    * or thread.</span>
<a href="#l8.268"></a><span id="l8.268">    *</span>
<a href="#l8.269"></a><span id="l8.269">    * @param aMsgHdr the message header to display</span>
<a href="#l8.270"></a><span id="l8.270">    */</span>
<a href="#l8.271"></a><span id="l8.271" class="difflineminus">-  displayMessageInFolderTab: function MailUtils_displayMessageInFolderTab(</span>
<a href="#l8.272"></a><span id="l8.272" class="difflineminus">-                                 aMsgHdr) {</span>
<a href="#l8.273"></a><span id="l8.273" class="difflineplus">+  displayMessageInFolderTab(aMsgHdr) {</span>
<a href="#l8.274"></a><span id="l8.274">     // Try opening new tabs in a 3pane window</span>
<a href="#l8.275"></a><span id="l8.275">     let mail3PaneWindow = Services.wm.getMostRecentWindow(&quot;mail:3pane&quot;);</span>
<a href="#l8.276"></a><span id="l8.276">     if (mail3PaneWindow) {</span>
<a href="#l8.277"></a><span id="l8.277">       mail3PaneWindow.MsgDisplayMessageInFolderTab(aMsgHdr);</span>
<a href="#l8.278"></a><span id="l8.278" class="difflineminus">-    }</span>
<a href="#l8.279"></a><span id="l8.279" class="difflineminus">-    else {</span>
<a href="#l8.280"></a><span id="l8.280" class="difflineplus">+    } else {</span>
<a href="#l8.281"></a><span id="l8.281">       let args = {msgHdr: aMsgHdr};</span>
<a href="#l8.282"></a><span id="l8.282">       args.wrappedJSObject = args;</span>
<a href="#l8.283"></a><span id="l8.283">       Services.ww.openWindow(null,</span>
<a href="#l8.284"></a><span id="l8.284">           &quot;chrome://messenger/content/&quot;, &quot;&quot;,</span>
<a href="#l8.285"></a><span id="l8.285">           &quot;all,chrome,dialog=no,status,toolbar&quot;, args);</span>
<a href="#l8.286"></a><span id="l8.286">     }</span>
<a href="#l8.287"></a><span id="l8.287">   },</span>
<a href="#l8.288"></a><span id="l8.288"> </span>
<a href="#l8.289"></a><span id="l8.289" class="difflineat">@@ -332,21 +319,17 @@ var MailUtils =</span>
<a href="#l8.290"></a><span id="l8.290">    *     returns a string value.</span>
<a href="#l8.291"></a><span id="l8.291">    * @param aFolder The parent folder; we set the string property on it and all</span>
<a href="#l8.292"></a><span id="l8.292">    *     of its descendents.</span>
<a href="#l8.293"></a><span id="l8.293">    * @param [aCallback] The optional callback to invoke once we finish our work.</span>
<a href="#l8.294"></a><span id="l8.294">    *     The callback is provided a boolean success value; true means we</span>
<a href="#l8.295"></a><span id="l8.295">    *     managed to set the values on all folders, false means we encountered a</span>
<a href="#l8.296"></a><span id="l8.296">    *     problem.</span>
<a href="#l8.297"></a><span id="l8.297">    */</span>
<a href="#l8.298"></a><span id="l8.298" class="difflineminus">-  setStringPropertyOnFolderAndDescendents:</span>
<a href="#l8.299"></a><span id="l8.299" class="difflineminus">-      function MailUtils_setStringPropertyOnFolderAndDescendents(aPropertyName,</span>
<a href="#l8.300"></a><span id="l8.300" class="difflineminus">-                                                                 aPropertyValue,</span>
<a href="#l8.301"></a><span id="l8.301" class="difflineminus">-                                                                 aFolder,</span>
<a href="#l8.302"></a><span id="l8.302" class="difflineminus">-                                                                 aCallback) {</span>
<a href="#l8.303"></a><span id="l8.303" class="difflineplus">+  setStringPropertyOnFolderAndDescendents(aPropertyName, aPropertyValue, aFolder, aCallback) {</span>
<a href="#l8.304"></a><span id="l8.304">     // We need to add the base folder as it does not get added by ListDescendants.</span>
<a href="#l8.305"></a><span id="l8.305">     let allFolders = toXPCOMArray([aFolder], Ci.nsIMutableArray);</span>
<a href="#l8.306"></a><span id="l8.306">     // - get all the descendants</span>
<a href="#l8.307"></a><span id="l8.307">     aFolder.ListDescendants(allFolders);</span>
<a href="#l8.308"></a><span id="l8.308"> </span>
<a href="#l8.309"></a><span id="l8.309">     // - worker function</span>
<a href="#l8.310"></a><span id="l8.310">     function* folder_string_setter_worker() {</span>
<a href="#l8.311"></a><span id="l8.311">       for (let folder of fixIterator(allFolders, Ci.nsIMsgFolder)) {</span>
<a href="#l8.312"></a><span id="l8.312" class="difflineat">@@ -365,18 +348,17 @@ var MailUtils =</span>
<a href="#l8.313"></a><span id="l8.313">     let timer = Cc[&quot;@mozilla.org/timer;1&quot;].createInstance(Ci.nsITimer);</span>
<a href="#l8.314"></a><span id="l8.314">     function folder_string_setter_driver() {</span>
<a href="#l8.315"></a><span id="l8.315">       try {</span>
<a href="#l8.316"></a><span id="l8.316">         if (worker.next().done) {</span>
<a href="#l8.317"></a><span id="l8.317">           timer.cancel();</span>
<a href="#l8.318"></a><span id="l8.318">           if (aCallback)</span>
<a href="#l8.319"></a><span id="l8.319">             aCallback(true);</span>
<a href="#l8.320"></a><span id="l8.320">         }</span>
<a href="#l8.321"></a><span id="l8.321" class="difflineminus">-      }</span>
<a href="#l8.322"></a><span id="l8.322" class="difflineminus">-      catch (ex) {</span>
<a href="#l8.323"></a><span id="l8.323" class="difflineplus">+      } catch (ex) {</span>
<a href="#l8.324"></a><span id="l8.324">         // Any type of exception kills the generator.</span>
<a href="#l8.325"></a><span id="l8.325">         timer.cancel();</span>
<a href="#l8.326"></a><span id="l8.326">         if (aCallback)</span>
<a href="#l8.327"></a><span id="l8.327">           aCallback(false);</span>
<a href="#l8.328"></a><span id="l8.328">       }</span>
<a href="#l8.329"></a><span id="l8.329">     }</span>
<a href="#l8.330"></a><span id="l8.330">     // make sure there is at least 100 ms of not us between doing things.</span>
<a href="#l8.331"></a><span id="l8.331">     timer.initWithCallback(folder_string_setter_driver,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mail/base/modules/MailViewManager.jsm</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mail/base/modules/MailViewManager.jsm</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -1,19 +1,13 @@</span>
<a href="#l9.4"></a><span id="l9.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l9.5"></a><span id="l9.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l9.6"></a><span id="l9.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l9.7"></a><span id="l9.7"> </span>
<a href="#l9.8"></a><span id="l9.8" class="difflineminus">-this.EXPORTED_SYMBOLS = ['MailViewManager', 'MailViewConstants'];</span>
<a href="#l9.9"></a><span id="l9.9" class="difflineminus">-</span>
<a href="#l9.10"></a><span id="l9.10" class="difflineminus">-var nsMsgSearchScope  = Ci.nsMsgSearchScope;</span>
<a href="#l9.11"></a><span id="l9.11" class="difflineminus">-var nsMsgSearchAttrib = Ci.nsMsgSearchAttrib;</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-var nsMsgSearchOp     = Ci.nsMsgSearchOp;</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineminus">-</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineminus">-var nsMsgMessageFlags = Ci.nsMsgMessageFlags;</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineplus">+this.EXPORTED_SYMBOLS = [&quot;MailViewManager&quot;, &quot;MailViewConstants&quot;];</span>
<a href="#l9.16"></a><span id="l9.16"> </span>
<a href="#l9.17"></a><span id="l9.17"> /**</span>
<a href="#l9.18"></a><span id="l9.18">  * Put the MailViewConstants in an object so we can export them to</span>
<a href="#l9.19"></a><span id="l9.19">  *  msgViewPickerOverlay in one blob without contaminating everyone's address</span>
<a href="#l9.20"></a><span id="l9.20">  *  space who might want to import us.</span>
<a href="#l9.21"></a><span id="l9.21">  */</span>
<a href="#l9.22"></a><span id="l9.22"> var MailViewConstants = {</span>
<a href="#l9.23"></a><span id="l9.23">   // tag views have kViewTagMarker + their key as value</span>
<a href="#l9.24"></a><span id="l9.24" class="difflineat">@@ -51,38 +45,38 @@ var MailViewManager = {</span>
<a href="#l9.25"></a><span id="l9.25">    *  functionality may want to be generalized to be usable by gloda as well.</span>
<a href="#l9.26"></a><span id="l9.26">    *</span>
<a href="#l9.27"></a><span id="l9.27">    * @param aViewDef The view definition, three attributes are required:</span>
<a href="#l9.28"></a><span id="l9.28">    * - name: A string name for the view, for debugging purposes only.  This</span>
<a href="#l9.29"></a><span id="l9.29">    *         should not be localized!</span>
<a href="#l9.30"></a><span id="l9.30">    * - index: The index to assign to the view.</span>
<a href="#l9.31"></a><span id="l9.31">    * - makeTerms: A function to invoke that returns a list of search terms.</span>
<a href="#l9.32"></a><span id="l9.32">    */</span>
<a href="#l9.33"></a><span id="l9.33" class="difflineminus">-  defineView: function MailViewManager_defineView(aViewDef) {</span>
<a href="#l9.34"></a><span id="l9.34" class="difflineplus">+  defineView(aViewDef) {</span>
<a href="#l9.35"></a><span id="l9.35">     this._views[aViewDef.index] = aViewDef;</span>
<a href="#l9.36"></a><span id="l9.36">   },</span>
<a href="#l9.37"></a><span id="l9.37"> </span>
<a href="#l9.38"></a><span id="l9.38">   /**</span>
<a href="#l9.39"></a><span id="l9.39">    * Wrap a custom view into our cute little view abstraction.  We do not cache</span>
<a href="#l9.40"></a><span id="l9.40">    *  these because views should not change often enough for it to matter from</span>
<a href="#l9.41"></a><span id="l9.41">    *  a performance perspective, but they will change enough to make stale</span>
<a href="#l9.42"></a><span id="l9.42">    *  caches a potential issue.</span>
<a href="#l9.43"></a><span id="l9.43">    */</span>
<a href="#l9.44"></a><span id="l9.44" class="difflineminus">-  _wrapCustomView: function MailViewManager_wrapCustomView(aCustomViewIndex) {</span>
<a href="#l9.45"></a><span id="l9.45" class="difflineplus">+  _wrapCustomView(aCustomViewIndex) {</span>
<a href="#l9.46"></a><span id="l9.46">     let mailView = this._customMailViews.getMailViewAt(aCustomViewIndex);</span>
<a href="#l9.47"></a><span id="l9.47">     return {</span>
<a href="#l9.48"></a><span id="l9.48">       name: mailView.prettyName, // since the user created it it's localized</span>
<a href="#l9.49"></a><span id="l9.49">       index: aCustomViewIndex,</span>
<a href="#l9.50"></a><span id="l9.50" class="difflineminus">-      makeTerms: function(aSession, aData) {</span>
<a href="#l9.51"></a><span id="l9.51" class="difflineplus">+      makeTerms(aSession, aData) {</span>
<a href="#l9.52"></a><span id="l9.52">         return mailView.searchTerms;</span>
<a href="#l9.53"></a><span id="l9.53" class="difflineminus">-      }</span>
<a href="#l9.54"></a><span id="l9.54" class="difflineplus">+      },</span>
<a href="#l9.55"></a><span id="l9.55">     };</span>
<a href="#l9.56"></a><span id="l9.56">   },</span>
<a href="#l9.57"></a><span id="l9.57"> </span>
<a href="#l9.58"></a><span id="l9.58" class="difflineminus">-  _findCustomViewByName: function MailViewManager_findCustomViewByName(aName) {</span>
<a href="#l9.59"></a><span id="l9.59" class="difflineplus">+  _findCustomViewByName(aName) {</span>
<a href="#l9.60"></a><span id="l9.60">     let count = this._customMailViews.mailViewCount;</span>
<a href="#l9.61"></a><span id="l9.61">     for (let i = 0; i &lt; count; i++) {</span>
<a href="#l9.62"></a><span id="l9.62">       let mailView = this._customMailViews.getMailViewAt(i);</span>
<a href="#l9.63"></a><span id="l9.63">       if (mailView.mailViewName == aName)</span>
<a href="#l9.64"></a><span id="l9.64">         return this._wrapCustomView(i);</span>
<a href="#l9.65"></a><span id="l9.65">     }</span>
<a href="#l9.66"></a><span id="l9.66">     throw new Error(&quot;No custom view with name: &quot; + aName);</span>
<a href="#l9.67"></a><span id="l9.67">   },</span>
<a href="#l9.68"></a><span id="l9.68" class="difflineat">@@ -92,80 +86,78 @@ var MailViewManager = {</span>
<a href="#l9.69"></a><span id="l9.69">    *</span>
<a href="#l9.70"></a><span id="l9.70">    * @param aViewIndex If the value is an integer it references the built-in</span>
<a href="#l9.71"></a><span id="l9.71">    *      view with the view index from MailViewConstants, or if the index</span>
<a href="#l9.72"></a><span id="l9.72">    *      is &gt;= MailViewConstants.kViewItemFirstCustom, it is a reference to</span>
<a href="#l9.73"></a><span id="l9.73">    *      a custom view definition.  If the value is a string, it is the name</span>
<a href="#l9.74"></a><span id="l9.74">    *      of a custom view.  The string case is mainly intended for testing</span>
<a href="#l9.75"></a><span id="l9.75">    *      purposes.</span>
<a href="#l9.76"></a><span id="l9.76">    */</span>
<a href="#l9.77"></a><span id="l9.77" class="difflineminus">-  getMailViewByIndex: function MailViewManager_getMailViewByIndex(aViewIndex) {</span>
<a href="#l9.78"></a><span id="l9.78" class="difflineplus">+  getMailViewByIndex(aViewIndex) {</span>
<a href="#l9.79"></a><span id="l9.79">     if (typeof(aViewIndex) == &quot;string&quot;)</span>
<a href="#l9.80"></a><span id="l9.80">       return this._findCustomViewByName(aViewIndex);</span>
<a href="#l9.81"></a><span id="l9.81">     if (aViewIndex &lt; MailViewConstants.kViewItemFirstCustom)</span>
<a href="#l9.82"></a><span id="l9.82">       return this._views[aViewIndex];</span>
<a href="#l9.83"></a><span id="l9.83" class="difflineminus">-    else</span>
<a href="#l9.84"></a><span id="l9.84" class="difflineminus">-      return this._wrapCustomView(aViewIndex -</span>
<a href="#l9.85"></a><span id="l9.85" class="difflineminus">-                                  MailViewConstants.kViewItemFirstCustom);</span>
<a href="#l9.86"></a><span id="l9.86" class="difflineplus">+    return this._wrapCustomView(aViewIndex - MailViewConstants.kViewItemFirstCustom);</span>
<a href="#l9.87"></a><span id="l9.87">   },</span>
<a href="#l9.88"></a><span id="l9.88"> };</span>
<a href="#l9.89"></a><span id="l9.89"> </span>
<a href="#l9.90"></a><span id="l9.90"> MailViewManager.defineView({</span>
<a href="#l9.91"></a><span id="l9.91">   name: &quot;all mail&quot;, // debugging assistance only! not localized!</span>
<a href="#l9.92"></a><span id="l9.92">   index: MailViewConstants.kViewItemAll,</span>
<a href="#l9.93"></a><span id="l9.93" class="difflineminus">-  makeTerms: function(aSession, aData) {</span>
<a href="#l9.94"></a><span id="l9.94" class="difflineplus">+  makeTerms(aSession, aData) {</span>
<a href="#l9.95"></a><span id="l9.95">     return null;</span>
<a href="#l9.96"></a><span id="l9.96" class="difflineminus">-  }</span>
<a href="#l9.97"></a><span id="l9.97" class="difflineplus">+  },</span>
<a href="#l9.98"></a><span id="l9.98"> });</span>
<a href="#l9.99"></a><span id="l9.99"> </span>
<a href="#l9.100"></a><span id="l9.100"> MailViewManager.defineView({</span>
<a href="#l9.101"></a><span id="l9.101">   name: &quot;new mail / unread&quot;, // debugging assistance only! not localized!</span>
<a href="#l9.102"></a><span id="l9.102">   index: MailViewConstants.kViewItemUnread,</span>
<a href="#l9.103"></a><span id="l9.103" class="difflineminus">-  makeTerms: function(aSession, aData) {</span>
<a href="#l9.104"></a><span id="l9.104" class="difflineplus">+  makeTerms(aSession, aData) {</span>
<a href="#l9.105"></a><span id="l9.105">     let term = aSession.createTerm();</span>
<a href="#l9.106"></a><span id="l9.106">     let value = term.value;</span>
<a href="#l9.107"></a><span id="l9.107"> </span>
<a href="#l9.108"></a><span id="l9.108" class="difflineminus">-    value.status = nsMsgMessageFlags.Read;</span>
<a href="#l9.109"></a><span id="l9.109" class="difflineminus">-    value.attrib = nsMsgSearchAttrib.MsgStatus;</span>
<a href="#l9.110"></a><span id="l9.110" class="difflineplus">+    value.status = Ci.nsMsgMessageFlags.Read;</span>
<a href="#l9.111"></a><span id="l9.111" class="difflineplus">+    value.attrib = Ci.nsMsgSearchAttrib.MsgStatus;</span>
<a href="#l9.112"></a><span id="l9.112">     term.value = value;</span>
<a href="#l9.113"></a><span id="l9.113" class="difflineminus">-    term.attrib = nsMsgSearchAttrib.MsgStatus;</span>
<a href="#l9.114"></a><span id="l9.114" class="difflineminus">-    term.op = nsMsgSearchOp.Isnt;</span>
<a href="#l9.115"></a><span id="l9.115" class="difflineplus">+    term.attrib = Ci.nsMsgSearchAttrib.MsgStatus;</span>
<a href="#l9.116"></a><span id="l9.116" class="difflineplus">+    term.op = Ci.nsMsgSearchOp.Isnt;</span>
<a href="#l9.117"></a><span id="l9.117">     term.booleanAnd = true;</span>
<a href="#l9.118"></a><span id="l9.118"> </span>
<a href="#l9.119"></a><span id="l9.119">     return [term];</span>
<a href="#l9.120"></a><span id="l9.120" class="difflineminus">-  }</span>
<a href="#l9.121"></a><span id="l9.121" class="difflineplus">+  },</span>
<a href="#l9.122"></a><span id="l9.122"> });</span>
<a href="#l9.123"></a><span id="l9.123"> </span>
<a href="#l9.124"></a><span id="l9.124"> MailViewManager.defineView({</span>
<a href="#l9.125"></a><span id="l9.125">   name: &quot;tags&quot;, // debugging assistance only! not localized!</span>
<a href="#l9.126"></a><span id="l9.126">   index: MailViewConstants.kViewItemTags,</span>
<a href="#l9.127"></a><span id="l9.127" class="difflineminus">-  makeTerms: function(aSession, aKeyword) {</span>
<a href="#l9.128"></a><span id="l9.128" class="difflineplus">+  makeTerms(aSession, aKeyword) {</span>
<a href="#l9.129"></a><span id="l9.129">     let term = aSession.createTerm();</span>
<a href="#l9.130"></a><span id="l9.130">     let value = term.value;</span>
<a href="#l9.131"></a><span id="l9.131"> </span>
<a href="#l9.132"></a><span id="l9.132">     value.str = aKeyword;</span>
<a href="#l9.133"></a><span id="l9.133" class="difflineminus">-    value.attrib = nsMsgSearchAttrib.Keywords;</span>
<a href="#l9.134"></a><span id="l9.134" class="difflineplus">+    value.attrib = Ci.nsMsgSearchAttrib.Keywords;</span>
<a href="#l9.135"></a><span id="l9.135">     term.value = value;</span>
<a href="#l9.136"></a><span id="l9.136" class="difflineminus">-    term.attrib = nsMsgSearchAttrib.Keywords;</span>
<a href="#l9.137"></a><span id="l9.137" class="difflineminus">-    term.op = nsMsgSearchOp.Contains;</span>
<a href="#l9.138"></a><span id="l9.138" class="difflineplus">+    term.attrib = Ci.nsMsgSearchAttrib.Keywords;</span>
<a href="#l9.139"></a><span id="l9.139" class="difflineplus">+    term.op = Ci.nsMsgSearchOp.Contains;</span>
<a href="#l9.140"></a><span id="l9.140">     term.booleanAnd = true;</span>
<a href="#l9.141"></a><span id="l9.141"> </span>
<a href="#l9.142"></a><span id="l9.142">     return [term];</span>
<a href="#l9.143"></a><span id="l9.143" class="difflineminus">-  }</span>
<a href="#l9.144"></a><span id="l9.144" class="difflineplus">+  },</span>
<a href="#l9.145"></a><span id="l9.145"> });</span>
<a href="#l9.146"></a><span id="l9.146"> </span>
<a href="#l9.147"></a><span id="l9.147"> MailViewManager.defineView({</span>
<a href="#l9.148"></a><span id="l9.148">   name: &quot;not deleted&quot;, // debugging assistance only! not localized!</span>
<a href="#l9.149"></a><span id="l9.149">   index: MailViewConstants.kViewItemNotDeleted,</span>
<a href="#l9.150"></a><span id="l9.150" class="difflineminus">-  makeTerms: function(aSession, aKeyword) {</span>
<a href="#l9.151"></a><span id="l9.151" class="difflineplus">+  makeTerms(aSession, aKeyword) {</span>
<a href="#l9.152"></a><span id="l9.152">     let term = aSession.createTerm();</span>
<a href="#l9.153"></a><span id="l9.153">     let value = term.value;</span>
<a href="#l9.154"></a><span id="l9.154"> </span>
<a href="#l9.155"></a><span id="l9.155" class="difflineminus">-    value.status = nsMsgMessageFlags.IMAPDeleted;</span>
<a href="#l9.156"></a><span id="l9.156" class="difflineminus">-    value.attrib = nsMsgSearchAttrib.MsgStatus;</span>
<a href="#l9.157"></a><span id="l9.157" class="difflineplus">+    value.status = Ci.nsMsgMessageFlags.IMAPDeleted;</span>
<a href="#l9.158"></a><span id="l9.158" class="difflineplus">+    value.attrib = Ci.nsMsgSearchAttrib.MsgStatus;</span>
<a href="#l9.159"></a><span id="l9.159">     term.value = value;</span>
<a href="#l9.160"></a><span id="l9.160" class="difflineminus">-    term.attrib = nsMsgSearchAttrib.MsgStatus;</span>
<a href="#l9.161"></a><span id="l9.161" class="difflineminus">-    term.op = nsMsgSearchOp.Isnt;</span>
<a href="#l9.162"></a><span id="l9.162" class="difflineplus">+    term.attrib = Ci.nsMsgSearchAttrib.MsgStatus;</span>
<a href="#l9.163"></a><span id="l9.163" class="difflineplus">+    term.op = Ci.nsMsgSearchOp.Isnt;</span>
<a href="#l9.164"></a><span id="l9.164">     term.booleanAnd = true;</span>
<a href="#l9.165"></a><span id="l9.165"> </span>
<a href="#l9.166"></a><span id="l9.166">     return [term];</span>
<a href="#l9.167"></a><span id="l9.167" class="difflineminus">-  }</span>
<a href="#l9.168"></a><span id="l9.168" class="difflineplus">+  },</span>
<a href="#l9.169"></a><span id="l9.169"> });</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mail/base/modules/MsgHdrSyntheticView.jsm</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mail/base/modules/MsgHdrSyntheticView.jsm</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -24,41 +24,39 @@ function MsgHdrSyntheticView(aMsgHdr) {</span>
<a href="#l10.4"></a><span id="l10.4"> MsgHdrSyntheticView.prototype = {</span>
<a href="#l10.5"></a><span id="l10.5">   defaultSort: [[Ci.nsMsgViewSortType.byDate, Ci.nsMsgViewSortOrder.descending]],</span>
<a href="#l10.6"></a><span id="l10.6"> </span>
<a href="#l10.7"></a><span id="l10.7">   /**</span>
<a href="#l10.8"></a><span id="l10.8">    * Request the search be performed and notifications provided to</span>
<a href="#l10.9"></a><span id="l10.9">    * aSearchListener. Since we already have the result with us, this is</span>
<a href="#l10.10"></a><span id="l10.10">    * synchronous.</span>
<a href="#l10.11"></a><span id="l10.11">    */</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-  search: function MsgHdrSyntheticView_search(aSearchListener,</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineminus">-                                              aCompletionCallback) {</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineplus">+  search(aSearchListener, aCompletionCallback) {</span>
<a href="#l10.15"></a><span id="l10.15">     this.searchListener = aSearchListener;</span>
<a href="#l10.16"></a><span id="l10.16">     this.completionCallback = aCompletionCallback;</span>
<a href="#l10.17"></a><span id="l10.17">     aSearchListener.onNewSearch();</span>
<a href="#l10.18"></a><span id="l10.18">     aSearchListener.onSearchHit(this.msgHdr, this.msgHdr.folder);</span>
<a href="#l10.19"></a><span id="l10.19">     // we're not really aborting, but it closes things out nicely</span>
<a href="#l10.20"></a><span id="l10.20">     this.abortSearch();</span>
<a href="#l10.21"></a><span id="l10.21">   },</span>
<a href="#l10.22"></a><span id="l10.22"> </span>
<a href="#l10.23"></a><span id="l10.23">   /**</span>
<a href="#l10.24"></a><span id="l10.24">    * Aborts or completes the search -- we do not make a distinction.</span>
<a href="#l10.25"></a><span id="l10.25">    */</span>
<a href="#l10.26"></a><span id="l10.26" class="difflineminus">-  abortSearch: function MsgHdrSyntheticView_abortSearch() {</span>
<a href="#l10.27"></a><span id="l10.27" class="difflineplus">+  abortSearch() {</span>
<a href="#l10.28"></a><span id="l10.28">     if (this.searchListener)</span>
<a href="#l10.29"></a><span id="l10.29">       this.searchListener.onSearchDone(Cr.NS_OK);</span>
<a href="#l10.30"></a><span id="l10.30">     if (this.completionCallback)</span>
<a href="#l10.31"></a><span id="l10.31">       this.completionCallback();</span>
<a href="#l10.32"></a><span id="l10.32">     this.searchListener = null;</span>
<a href="#l10.33"></a><span id="l10.33">     this.completionCallback = null;</span>
<a href="#l10.34"></a><span id="l10.34">   },</span>
<a href="#l10.35"></a><span id="l10.35"> </span>
<a href="#l10.36"></a><span id="l10.36">   /**</span>
<a href="#l10.37"></a><span id="l10.37">    * Helper function used by |DBViewWrapper.getMsgHdrForMessageID|.</span>
<a href="#l10.38"></a><span id="l10.38">    */</span>
<a href="#l10.39"></a><span id="l10.39" class="difflineminus">-  getMsgHdrForMessageID: function MsgHdrSyntheticView_getMsgHdrForMessageID(</span>
<a href="#l10.40"></a><span id="l10.40" class="difflineminus">-      aMessageId) {</span>
<a href="#l10.41"></a><span id="l10.41" class="difflineplus">+  getMsgHdrForMessageID(aMessageId) {</span>
<a href="#l10.42"></a><span id="l10.42">     if (this.msgHdr.messageId == aMessageId)</span>
<a href="#l10.43"></a><span id="l10.43">       return this.msgHdr;</span>
<a href="#l10.44"></a><span id="l10.44"> </span>
<a href="#l10.45"></a><span id="l10.45">     return null;</span>
<a href="#l10.46"></a><span id="l10.46" class="difflineminus">-  }</span>
<a href="#l10.47"></a><span id="l10.47" class="difflineplus">+  },</span>
<a href="#l10.48"></a><span id="l10.48"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mail/base/modules/QuickFilterManager.jsm</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mail/base/modules/QuickFilterManager.jsm</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -4,30 +4,27 @@</span>
<a href="#l11.4"></a><span id="l11.4"> </span>
<a href="#l11.5"></a><span id="l11.5"> this.EXPORTED_SYMBOLS = [&quot;QuickFilterState&quot;, &quot;QuickFilterManager&quot;,</span>
<a href="#l11.6"></a><span id="l11.6">                           &quot;MessageTextFilter&quot;, &quot;QuickFilterSearchListener&quot;];</span>
<a href="#l11.7"></a><span id="l11.7"> </span>
<a href="#l11.8"></a><span id="l11.8"> ChromeUtils.import(&quot;resource://gre/modules/PluralForm.jsm&quot;);</span>
<a href="#l11.9"></a><span id="l11.9"> ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l11.10"></a><span id="l11.10"> ChromeUtils.import(&quot;resource://gre/modules/AppConstants.jsm&quot;);</span>
<a href="#l11.11"></a><span id="l11.11"> </span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;);</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/errUtils.js&quot;);</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineplus">+const {</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineplus">+  logException,</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineplus">+  logObject,</span>
<a href="#l11.17"></a><span id="l11.17" class="difflineplus">+} = ChromeUtils.import(&quot;resource:///modules/errUtils.js&quot;, null);</span>
<a href="#l11.18"></a><span id="l11.18"> ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l11.19"></a><span id="l11.19" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/SearchSpec.jsm&quot;);</span>
<a href="#l11.20"></a><span id="l11.20" class="difflineminus">-</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineminus">-var nsMsgSearchAttrib = Ci.nsMsgSearchAttrib;</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineminus">-var nsMsgMessageFlags = Ci.nsMsgMessageFlags;</span>
<a href="#l11.23"></a><span id="l11.23" class="difflineminus">-var nsMsgSearchOp = Ci.nsMsgSearchOp;</span>
<a href="#l11.24"></a><span id="l11.24"> </span>
<a href="#l11.25"></a><span id="l11.25"> // XXX we need to know whether the gloda indexer is enabled for upsell reasons,</span>
<a href="#l11.26"></a><span id="l11.26"> // but this should really just be exposed on the main Gloda public interface.</span>
<a href="#l11.27"></a><span id="l11.27" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/gloda/indexer.js&quot;);</span>
<a href="#l11.28"></a><span id="l11.28" class="difflineplus">+const { GlodaIndexer } = ChromeUtils.import(&quot;resource:///modules/gloda/indexer.js&quot;, null);</span>
<a href="#l11.29"></a><span id="l11.29"> // we need to be able to create gloda message searcher instances for upsells:</span>
<a href="#l11.30"></a><span id="l11.30" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/gloda/msg_search.js&quot;);</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineplus">+const { GlodaMsgSearcher } = ChromeUtils.import(&quot;resource:///modules/gloda/msg_search.js&quot;, null);</span>
<a href="#l11.32"></a><span id="l11.32"> </span>
<a href="#l11.33"></a><span id="l11.33"> </span>
<a href="#l11.34"></a><span id="l11.34"> /**</span>
<a href="#l11.35"></a><span id="l11.35">  * Shallow object copy.</span>
<a href="#l11.36"></a><span id="l11.36">  */</span>
<a href="#l11.37"></a><span id="l11.37"> function shallowObjCopy(obj) {</span>
<a href="#l11.38"></a><span id="l11.38">   let newObj = {};</span>
<a href="#l11.39"></a><span id="l11.39">   for (let key in obj) {</span>
<a href="#l11.40"></a><span id="l11.40" class="difflineat">@@ -49,23 +46,21 @@ var FILTER_VISIBILITY_DEFAULT = true;</span>
<a href="#l11.41"></a><span id="l11.41">  * Represents the state of a quick filter bar.  This mainly decorates the</span>
<a href="#l11.42"></a><span id="l11.42">  *  manipulation of the filter states with support of tracking the filter most</span>
<a href="#l11.43"></a><span id="l11.43">  *  recently manipulated so we can maintain a very limited undo stack of sorts.</span>
<a href="#l11.44"></a><span id="l11.44">  */</span>
<a href="#l11.45"></a><span id="l11.45"> function QuickFilterState(aTemplateState, aJsonedState) {</span>
<a href="#l11.46"></a><span id="l11.46">   if (aJsonedState) {</span>
<a href="#l11.47"></a><span id="l11.47">     this.filterValues = aJsonedState.filterValues;</span>
<a href="#l11.48"></a><span id="l11.48">     this.visible = aJsonedState.visible;</span>
<a href="#l11.49"></a><span id="l11.49" class="difflineminus">-  }</span>
<a href="#l11.50"></a><span id="l11.50" class="difflineminus">-  else if (aTemplateState) {</span>
<a href="#l11.51"></a><span id="l11.51" class="difflineplus">+  } else if (aTemplateState) {</span>
<a href="#l11.52"></a><span id="l11.52">     this.filterValues = QuickFilterManager.propagateValues(</span>
<a href="#l11.53"></a><span id="l11.53">                           aTemplateState.filterValues);</span>
<a href="#l11.54"></a><span id="l11.54">     this.visible = aTemplateState.visible;</span>
<a href="#l11.55"></a><span id="l11.55" class="difflineminus">-  }</span>
<a href="#l11.56"></a><span id="l11.56" class="difflineminus">-  else {</span>
<a href="#l11.57"></a><span id="l11.57" class="difflineplus">+  } else {</span>
<a href="#l11.58"></a><span id="l11.58">     this.filterValues = QuickFilterManager.getDefaultValues();</span>
<a href="#l11.59"></a><span id="l11.59">     this.visible = FILTER_VISIBILITY_DEFAULT;</span>
<a href="#l11.60"></a><span id="l11.60">   }</span>
<a href="#l11.61"></a><span id="l11.61">   this._lastFilterAttr = null;</span>
<a href="#l11.62"></a><span id="l11.62"> }</span>
<a href="#l11.63"></a><span id="l11.63"> QuickFilterState.prototype = {</span>
<a href="#l11.64"></a><span id="l11.64">   /**</span>
<a href="#l11.65"></a><span id="l11.65">    * Maps filter names to their current states.  We rely on QuickFilterManager</span>
<a href="#l11.66"></a><span id="l11.66" class="difflineat">@@ -82,31 +77,31 @@ QuickFilterState.prototype = {</span>
<a href="#l11.67"></a><span id="l11.67">    * Get a filter state and update lastFilterAttr appropriately.  This is</span>
<a href="#l11.68"></a><span id="l11.68">    *  intended for use when the filter state is a rich object whose state</span>
<a href="#l11.69"></a><span id="l11.69">    *  cannot be updated just by clobbering as provided by |setFilterValue|.</span>
<a href="#l11.70"></a><span id="l11.70">    *</span>
<a href="#l11.71"></a><span id="l11.71">    * @param aName The name of the filter we are retrieving.</span>
<a href="#l11.72"></a><span id="l11.72">    * @param [aNoChange=false] Is this actually a change for the purposes of</span>
<a href="#l11.73"></a><span id="l11.73">    *     lastFilterAttr purposes?</span>
<a href="#l11.74"></a><span id="l11.74">    */</span>
<a href="#l11.75"></a><span id="l11.75" class="difflineminus">-  getFilterValue: function MFS_getFilterValue(aName, aNoChange) {</span>
<a href="#l11.76"></a><span id="l11.76" class="difflineplus">+  getFilterValue(aName, aNoChange) {</span>
<a href="#l11.77"></a><span id="l11.77">     if (!aNoChange)</span>
<a href="#l11.78"></a><span id="l11.78">       this._lastFilterAttr = aName;</span>
<a href="#l11.79"></a><span id="l11.79">     return this.filterValues[aName];</span>
<a href="#l11.80"></a><span id="l11.80">   },</span>
<a href="#l11.81"></a><span id="l11.81"> </span>
<a href="#l11.82"></a><span id="l11.82">   /**</span>
<a href="#l11.83"></a><span id="l11.83">    * Set a filter state and update lastFilterAttr appropriately.</span>
<a href="#l11.84"></a><span id="l11.84">    *</span>
<a href="#l11.85"></a><span id="l11.85">    * @param aName The name of the filter we are setting.</span>
<a href="#l11.86"></a><span id="l11.86">    * @param aValue The value to set; null/undefined implies deletion.</span>
<a href="#l11.87"></a><span id="l11.87">    * @param [aNoChange=false] Is this actually a change for the purposes of</span>
<a href="#l11.88"></a><span id="l11.88">    *     lastFilterAttr purposes?</span>
<a href="#l11.89"></a><span id="l11.89">    */</span>
<a href="#l11.90"></a><span id="l11.90" class="difflineminus">-  setFilterValue: function MFS_setFilterValue(aName, aValue, aNoChange) {</span>
<a href="#l11.91"></a><span id="l11.91" class="difflineplus">+  setFilterValue(aName, aValue, aNoChange) {</span>
<a href="#l11.92"></a><span id="l11.92">     if (aValue == null) {</span>
<a href="#l11.93"></a><span id="l11.93">       delete this.filterValues[aName];</span>
<a href="#l11.94"></a><span id="l11.94">       return;</span>
<a href="#l11.95"></a><span id="l11.95">     }</span>
<a href="#l11.96"></a><span id="l11.96"> </span>
<a href="#l11.97"></a><span id="l11.97">     this.filterValues[aName] = aValue;</span>
<a href="#l11.98"></a><span id="l11.98">     if (!aNoChange)</span>
<a href="#l11.99"></a><span id="l11.99">       this._lastFilterAttr = aName;</span>
<a href="#l11.100"></a><span id="l11.100" class="difflineat">@@ -122,17 +117,17 @@ QuickFilterState.prototype = {</span>
<a href="#l11.101"></a><span id="l11.101">   /**</span>
<a href="#l11.102"></a><span id="l11.102">    * The user hit escape; based on _lastFilterAttr and whether there are any</span>
<a href="#l11.103"></a><span id="l11.103">    *  applied filters, change our constraints.  First press clears the last</span>
<a href="#l11.104"></a><span id="l11.104">    *  added constraint (if any), second press (or if no last constraint) clears</span>
<a href="#l11.105"></a><span id="l11.105">    *  the state entirely.</span>
<a href="#l11.106"></a><span id="l11.106">    *</span>
<a href="#l11.107"></a><span id="l11.107">    * @return true if we relaxed the state, false if there was nothing to relax.</span>
<a href="#l11.108"></a><span id="l11.108">    */</span>
<a href="#l11.109"></a><span id="l11.109" class="difflineminus">-  userHitEscape: function MFS_userHitEscape() {</span>
<a href="#l11.110"></a><span id="l11.110" class="difflineplus">+  userHitEscape() {</span>
<a href="#l11.111"></a><span id="l11.111">     if (this._lastFilterAttr) {</span>
<a href="#l11.112"></a><span id="l11.112">       // it's possible the UI state the last attribute has already been cleared,</span>
<a href="#l11.113"></a><span id="l11.113">       //  in which case we want to fall through...</span>
<a href="#l11.114"></a><span id="l11.114">       if (QuickFilterManager.clearFilterValue(this._lastFilterAttr,</span>
<a href="#l11.115"></a><span id="l11.115">                                               this.filterValues)) {</span>
<a href="#l11.116"></a><span id="l11.116">         this._lastFilterAttr = null;</span>
<a href="#l11.117"></a><span id="l11.117">         return true;</span>
<a href="#l11.118"></a><span id="l11.118">       }</span>
<a href="#l11.119"></a><span id="l11.119" class="difflineat">@@ -140,29 +135,29 @@ QuickFilterState.prototype = {</span>
<a href="#l11.120"></a><span id="l11.120"> </span>
<a href="#l11.121"></a><span id="l11.121">     return QuickFilterManager.clearAllFilterValues(this.filterValues);</span>
<a href="#l11.122"></a><span id="l11.122">   },</span>
<a href="#l11.123"></a><span id="l11.123"> </span>
<a href="#l11.124"></a><span id="l11.124">   /**</span>
<a href="#l11.125"></a><span id="l11.125">    * Clear the state without going through any undo-ish steps like</span>
<a href="#l11.126"></a><span id="l11.126">    *  |userHitEscape| tries to do.</span>
<a href="#l11.127"></a><span id="l11.127">    */</span>
<a href="#l11.128"></a><span id="l11.128" class="difflineminus">-  clear: function MFS_clear() {</span>
<a href="#l11.129"></a><span id="l11.129" class="difflineplus">+  clear() {</span>
<a href="#l11.130"></a><span id="l11.130">     QuickFilterManager.clearAllFilterValues(this.filterValues);</span>
<a href="#l11.131"></a><span id="l11.131">   },</span>
<a href="#l11.132"></a><span id="l11.132"> </span>
<a href="#l11.133"></a><span id="l11.133">   /**</span>
<a href="#l11.134"></a><span id="l11.134">    * Create the search terms appropriate to the current filter states.</span>
<a href="#l11.135"></a><span id="l11.135">    */</span>
<a href="#l11.136"></a><span id="l11.136" class="difflineminus">-  createSearchTerms: function MFS_createSearchTerms(aTermCreator) {</span>
<a href="#l11.137"></a><span id="l11.137" class="difflineplus">+  createSearchTerms(aTermCreator) {</span>
<a href="#l11.138"></a><span id="l11.138">     return QuickFilterManager.createSearchTerms(this.filterValues,</span>
<a href="#l11.139"></a><span id="l11.139">                                                 aTermCreator);</span>
<a href="#l11.140"></a><span id="l11.140">   },</span>
<a href="#l11.141"></a><span id="l11.141"> </span>
<a href="#l11.142"></a><span id="l11.142" class="difflineminus">-  persistToObj: function MFS_persistToObj() {</span>
<a href="#l11.143"></a><span id="l11.143" class="difflineplus">+  persistToObj() {</span>
<a href="#l11.144"></a><span id="l11.144">     return {</span>
<a href="#l11.145"></a><span id="l11.145">       filterValues: this.filterValues,</span>
<a href="#l11.146"></a><span id="l11.146">       visible: this.visible,</span>
<a href="#l11.147"></a><span id="l11.147">     };</span>
<a href="#l11.148"></a><span id="l11.148">   },</span>
<a href="#l11.149"></a><span id="l11.149"> };</span>
<a href="#l11.150"></a><span id="l11.150"> </span>
<a href="#l11.151"></a><span id="l11.151"> /**</span>
<a href="#l11.152"></a><span id="l11.152" class="difflineat">@@ -219,45 +214,43 @@ function QuickFilterSearchListener(aFold</span>
<a href="#l11.153"></a><span id="l11.153">   this.scratch = null;</span>
<a href="#l11.154"></a><span id="l11.154">   this.count = 0;</span>
<a href="#l11.155"></a><span id="l11.155">   this.started = false;</span>
<a href="#l11.156"></a><span id="l11.156"> </span>
<a href="#l11.157"></a><span id="l11.157">   this.session.registerListener(this,</span>
<a href="#l11.158"></a><span id="l11.158">                                 Ci.nsIMsgSearchSession.allNotifications);</span>
<a href="#l11.159"></a><span id="l11.159"> }</span>
<a href="#l11.160"></a><span id="l11.160"> QuickFilterSearchListener.prototype = {</span>
<a href="#l11.161"></a><span id="l11.161" class="difflineminus">-  onNewSearch: function QuickFilterSearchListener_onNewSearch() {</span>
<a href="#l11.162"></a><span id="l11.162" class="difflineplus">+  onNewSearch() {</span>
<a href="#l11.163"></a><span id="l11.163">     this.started = true;</span>
<a href="#l11.164"></a><span id="l11.164">     let curState = (this.filterDef.name in this.filterer.filterValues) ?</span>
<a href="#l11.165"></a><span id="l11.165">                      this.filterer.filterValues[this.filterDef.name] : null;</span>
<a href="#l11.166"></a><span id="l11.166">     this.scratch = this.listener.onSearchStart(curState);</span>
<a href="#l11.167"></a><span id="l11.167">   },</span>
<a href="#l11.168"></a><span id="l11.168"> </span>
<a href="#l11.169"></a><span id="l11.169" class="difflineminus">-  onSearchHit: function QuickFilterSearchListener_onSearchHit(aMsgHdr,</span>
<a href="#l11.170"></a><span id="l11.170" class="difflineminus">-                                                              aFolder) {</span>
<a href="#l11.171"></a><span id="l11.171" class="difflineplus">+  onSearchHit(aMsgHdr, aFolder) {</span>
<a href="#l11.172"></a><span id="l11.172">     // GC sanity demands that we trigger a GC if we have seen a large number</span>
<a href="#l11.173"></a><span id="l11.173">     //  of headers.  Because we are driven by the search mechanism which likes</span>
<a href="#l11.174"></a><span id="l11.174">     //  to time-slice when it has a lot of messages on its plate, it is</span>
<a href="#l11.175"></a><span id="l11.175">     //  conceivable something else may trigger a GC for us.  Unfortunately,</span>
<a href="#l11.176"></a><span id="l11.176">     //  we can't guarantee it, as XPConnect does not inform memory pressure,</span>
<a href="#l11.177"></a><span id="l11.177">     //  so it's us to stop-gap it.</span>
<a href="#l11.178"></a><span id="l11.178">     this.count++;</span>
<a href="#l11.179"></a><span id="l11.179">     if (!(this.count % 4096))</span>
<a href="#l11.180"></a><span id="l11.180">       Cu.forceGC();</span>
<a href="#l11.181"></a><span id="l11.181"> </span>
<a href="#l11.182"></a><span id="l11.182">     try {</span>
<a href="#l11.183"></a><span id="l11.183">       this.listener.onSearchMessage(this.scratch, aMsgHdr, aFolder);</span>
<a href="#l11.184"></a><span id="l11.184" class="difflineminus">-    }</span>
<a href="#l11.185"></a><span id="l11.185" class="difflineminus">-    catch (ex) {</span>
<a href="#l11.186"></a><span id="l11.186" class="difflineplus">+    } catch (ex) {</span>
<a href="#l11.187"></a><span id="l11.187">       logException(ex);</span>
<a href="#l11.188"></a><span id="l11.188">       logObject(this.scratch, &quot;scratch object&quot;);</span>
<a href="#l11.189"></a><span id="l11.189">     }</span>
<a href="#l11.190"></a><span id="l11.190">   },</span>
<a href="#l11.191"></a><span id="l11.191"> </span>
<a href="#l11.192"></a><span id="l11.192" class="difflineminus">-  onSearchDone: function QuickFilterSearchListener_onSearchDone(aStatus) {</span>
<a href="#l11.193"></a><span id="l11.193" class="difflineplus">+  onSearchDone(aStatus) {</span>
<a href="#l11.194"></a><span id="l11.194">     // it's possible we will see the tail end of an existing search. ignore.</span>
<a href="#l11.195"></a><span id="l11.195">     if (!this.started)</span>
<a href="#l11.196"></a><span id="l11.196">       return;</span>
<a href="#l11.197"></a><span id="l11.197"> </span>
<a href="#l11.198"></a><span id="l11.198">     this.session.unregisterListener(this);</span>
<a href="#l11.199"></a><span id="l11.199"> </span>
<a href="#l11.200"></a><span id="l11.200">     let curState = (this.filterDef.name in this.filterer.filterValues) ?</span>
<a href="#l11.201"></a><span id="l11.201">                      this.filterer.filterValues[this.filterDef.name] : null;</span>
<a href="#l11.202"></a><span id="l11.202" class="difflineat">@@ -383,68 +376,67 @@ var QuickFilterManager = {</span>
<a href="#l11.203"></a><span id="l11.203">    *     aFiltering; true means we have applied some terms, false means not.</span>
<a href="#l11.204"></a><span id="l11.204">    *     It's vitally important that you do not just facet things willy nilly</span>
<a href="#l11.205"></a><span id="l11.205">    *     unless there is expected user payoff and they opted in.  Our tagging UI</span>
<a href="#l11.206"></a><span id="l11.206">    *     only facets when the user clicked the tag facet.  If you write an</span>
<a href="#l11.207"></a><span id="l11.207">    *     extension that provides really sweet visualizations or something like</span>
<a href="#l11.208"></a><span id="l11.208">    *     that and the user installs you knowing what's what, that is also cool,</span>
<a href="#l11.209"></a><span id="l11.209">    *     we just can't do it in core for now.</span>
<a href="#l11.210"></a><span id="l11.210">    */</span>
<a href="#l11.211"></a><span id="l11.211" class="difflineminus">-  defineFilter: function MFM_defineFilter(aFilterDef) {</span>
<a href="#l11.212"></a><span id="l11.212" class="difflineplus">+  defineFilter(aFilterDef) {</span>
<a href="#l11.213"></a><span id="l11.213">     this.filterDefs.push(aFilterDef);</span>
<a href="#l11.214"></a><span id="l11.214">     this.filterDefsByName[aFilterDef.name] = aFilterDef;</span>
<a href="#l11.215"></a><span id="l11.215">   },</span>
<a href="#l11.216"></a><span id="l11.216"> </span>
<a href="#l11.217"></a><span id="l11.217">   /**</span>
<a href="#l11.218"></a><span id="l11.218">    * Remove a filter from existence by name.  This is for extensions to disable</span>
<a href="#l11.219"></a><span id="l11.219">    *  existing filters and not a dynamic jetpack-like lifecycle.  It falls to</span>
<a href="#l11.220"></a><span id="l11.220">    *  the code calling killFilter to deal with the DOM nodes themselves for now.</span>
<a href="#l11.221"></a><span id="l11.221">    *</span>
<a href="#l11.222"></a><span id="l11.222">    * @param aName The name of the filter to kill.</span>
<a href="#l11.223"></a><span id="l11.223">    */</span>
<a href="#l11.224"></a><span id="l11.224" class="difflineminus">-  killFilter: function MFM_killFilter(aName) {</span>
<a href="#l11.225"></a><span id="l11.225" class="difflineplus">+  killFilter(aName) {</span>
<a href="#l11.226"></a><span id="l11.226">     let filterDef = this.filterDefsByName[aName];</span>
<a href="#l11.227"></a><span id="l11.227">     this.filterDefs.splice(this.filterDefs.indexOf(filterDef), 1);</span>
<a href="#l11.228"></a><span id="l11.228">     delete this.filterDefsByName[aName];</span>
<a href="#l11.229"></a><span id="l11.229">   },</span>
<a href="#l11.230"></a><span id="l11.230"> </span>
<a href="#l11.231"></a><span id="l11.231">   /**</span>
<a href="#l11.232"></a><span id="l11.232">    * Propagate values from an existing state into a new state based on</span>
<a href="#l11.233"></a><span id="l11.233">    *  propagation rules.  For use by QuickFilterState.</span>
<a href="#l11.234"></a><span id="l11.234">    *</span>
<a href="#l11.235"></a><span id="l11.235">    * @param aTemplValues A set of existing filterValues.</span>
<a href="#l11.236"></a><span id="l11.236">    * @return The new filterValues state.</span>
<a href="#l11.237"></a><span id="l11.237">    */</span>
<a href="#l11.238"></a><span id="l11.238" class="difflineminus">-  propagateValues: function MFM_propagateValues(aTemplValues) {</span>
<a href="#l11.239"></a><span id="l11.239" class="difflineplus">+  propagateValues(aTemplValues) {</span>
<a href="#l11.240"></a><span id="l11.240">     let values = {};</span>
<a href="#l11.241"></a><span id="l11.241">     let sticky = (&quot;sticky&quot; in aTemplValues) ? aTemplValues.sticky : false;</span>
<a href="#l11.242"></a><span id="l11.242"> </span>
<a href="#l11.243"></a><span id="l11.243">     for (let filterDef of this.filterDefs) {</span>
<a href="#l11.244"></a><span id="l11.244">       if (&quot;propagateState&quot; in filterDef) {</span>
<a href="#l11.245"></a><span id="l11.245">         let curValue = (filterDef.name in aTemplValues) ?</span>
<a href="#l11.246"></a><span id="l11.246">                          aTemplValues[filterDef.name] : undefined;</span>
<a href="#l11.247"></a><span id="l11.247">         let newValue = filterDef.propagateState(curValue, sticky);</span>
<a href="#l11.248"></a><span id="l11.248">         if (newValue != null)</span>
<a href="#l11.249"></a><span id="l11.249">           values[filterDef.name] = newValue;</span>
<a href="#l11.250"></a><span id="l11.250" class="difflineminus">-      }</span>
<a href="#l11.251"></a><span id="l11.251" class="difflineminus">-      // always propagate the value if sticky and there was no handler</span>
<a href="#l11.252"></a><span id="l11.252" class="difflineminus">-      else if (sticky) {</span>
<a href="#l11.253"></a><span id="l11.253" class="difflineplus">+      } else if (sticky) {</span>
<a href="#l11.254"></a><span id="l11.254" class="difflineplus">+        // Always propagate the value if sticky and there was no handler.</span>
<a href="#l11.255"></a><span id="l11.255">         if (filterDef.name in aTemplValues)</span>
<a href="#l11.256"></a><span id="l11.256">           values[filterDef.name] = aTemplValues[filterDef.name];</span>
<a href="#l11.257"></a><span id="l11.257">       }</span>
<a href="#l11.258"></a><span id="l11.258">     }</span>
<a href="#l11.259"></a><span id="l11.259"> </span>
<a href="#l11.260"></a><span id="l11.260">     return values;</span>
<a href="#l11.261"></a><span id="l11.261">   },</span>
<a href="#l11.262"></a><span id="l11.262">   /**</span>
<a href="#l11.263"></a><span id="l11.263">    * Get the set of default filterValues for the current set of defined filters.</span>
<a href="#l11.264"></a><span id="l11.264">    *</span>
<a href="#l11.265"></a><span id="l11.265">    * @return Thew new filterValues state.</span>
<a href="#l11.266"></a><span id="l11.266">    */</span>
<a href="#l11.267"></a><span id="l11.267" class="difflineminus">-  getDefaultValues: function MFM_getDefaultValues() {</span>
<a href="#l11.268"></a><span id="l11.268" class="difflineplus">+  getDefaultValues() {</span>
<a href="#l11.269"></a><span id="l11.269">     let values = {};</span>
<a href="#l11.270"></a><span id="l11.270">     for (let filterDef of this.filterDefs) {</span>
<a href="#l11.271"></a><span id="l11.271">       if (&quot;getDefaults&quot; in filterDef) {</span>
<a href="#l11.272"></a><span id="l11.272">         let newValue = filterDef.getDefaults();</span>
<a href="#l11.273"></a><span id="l11.273">         if (newValue != null)</span>
<a href="#l11.274"></a><span id="l11.274">           values[filterDef.name] = newValue;</span>
<a href="#l11.275"></a><span id="l11.275">       }</span>
<a href="#l11.276"></a><span id="l11.276">     }</span>
<a href="#l11.277"></a><span id="l11.277" class="difflineat">@@ -452,17 +444,17 @@ var QuickFilterManager = {</span>
<a href="#l11.278"></a><span id="l11.278">   },</span>
<a href="#l11.279"></a><span id="l11.279"> </span>
<a href="#l11.280"></a><span id="l11.280">   /**</span>
<a href="#l11.281"></a><span id="l11.281">    * Reset the state of a single filter given the provided values.</span>
<a href="#l11.282"></a><span id="l11.282">    *</span>
<a href="#l11.283"></a><span id="l11.283">    * @return true if we actually cleared some state, false if there was nothing</span>
<a href="#l11.284"></a><span id="l11.284">    *     to clear.</span>
<a href="#l11.285"></a><span id="l11.285">    */</span>
<a href="#l11.286"></a><span id="l11.286" class="difflineminus">-  clearFilterValue: function MFM_clearFilterValue(aFilterName, aValues) {</span>
<a href="#l11.287"></a><span id="l11.287" class="difflineplus">+  clearFilterValue(aFilterName, aValues) {</span>
<a href="#l11.288"></a><span id="l11.288">     let filterDef = this.filterDefsByName[aFilterName];</span>
<a href="#l11.289"></a><span id="l11.289">     if (!(&quot;clearState&quot; in filterDef)) {</span>
<a href="#l11.290"></a><span id="l11.290">       if (aFilterName in aValues) {</span>
<a href="#l11.291"></a><span id="l11.291">         delete aValues[aFilterName];</span>
<a href="#l11.292"></a><span id="l11.292">         return true;</span>
<a href="#l11.293"></a><span id="l11.293">       }</span>
<a href="#l11.294"></a><span id="l11.294">       return false;</span>
<a href="#l11.295"></a><span id="l11.295">     }</span>
<a href="#l11.296"></a><span id="l11.296" class="difflineat">@@ -479,142 +471,140 @@ var QuickFilterManager = {</span>
<a href="#l11.297"></a><span id="l11.297">   },</span>
<a href="#l11.298"></a><span id="l11.298"> </span>
<a href="#l11.299"></a><span id="l11.299">   /**</span>
<a href="#l11.300"></a><span id="l11.300">    * Reset the state of all filters given the provided values.</span>
<a href="#l11.301"></a><span id="l11.301">    *</span>
<a href="#l11.302"></a><span id="l11.302">    * @return true if we actually cleared something, false if there was nothing</span>
<a href="#l11.303"></a><span id="l11.303">    *     to clear.</span>
<a href="#l11.304"></a><span id="l11.304">    */</span>
<a href="#l11.305"></a><span id="l11.305" class="difflineminus">-  clearAllFilterValues: function MFM_clearFilterValues(aFilterValues) {</span>
<a href="#l11.306"></a><span id="l11.306" class="difflineplus">+  clearAllFilterValues(aFilterValues) {</span>
<a href="#l11.307"></a><span id="l11.307">     let didClearSomething = false;</span>
<a href="#l11.308"></a><span id="l11.308">     for (let filterDef of this.filterDefs) {</span>
<a href="#l11.309"></a><span id="l11.309">       if (this.clearFilterValue(filterDef.name, aFilterValues))</span>
<a href="#l11.310"></a><span id="l11.310">         didClearSomething = true;</span>
<a href="#l11.311"></a><span id="l11.311">     }</span>
<a href="#l11.312"></a><span id="l11.312">     return didClearSomething;</span>
<a href="#l11.313"></a><span id="l11.313">   },</span>
<a href="#l11.314"></a><span id="l11.314"> </span>
<a href="#l11.315"></a><span id="l11.315">   /**</span>
<a href="#l11.316"></a><span id="l11.316">    * Populate and return a list of search terms given the provided state.</span>
<a href="#l11.317"></a><span id="l11.317">    *</span>
<a href="#l11.318"></a><span id="l11.318">    * We only invoke appendTerms on filters that have state in aFilterValues,</span>
<a href="#l11.319"></a><span id="l11.319">    * as per the contract.</span>
<a href="#l11.320"></a><span id="l11.320">    */</span>
<a href="#l11.321"></a><span id="l11.321" class="difflineminus">-  createSearchTerms: function MFM_createSearchTerms(aFilterValues,</span>
<a href="#l11.322"></a><span id="l11.322" class="difflineminus">-                                                    aTermCreator) {</span>
<a href="#l11.323"></a><span id="l11.323" class="difflineplus">+  createSearchTerms(aFilterValues, aTermCreator) {</span>
<a href="#l11.324"></a><span id="l11.324">     let searchTerms = [], listeners = [];</span>
<a href="#l11.325"></a><span id="l11.325">     for (let filterName in aFilterValues) {</span>
<a href="#l11.326"></a><span id="l11.326">       let filterValue = aFilterValues[filterName];</span>
<a href="#l11.327"></a><span id="l11.327">       let filterDef = this.filterDefsByName[filterName];</span>
<a href="#l11.328"></a><span id="l11.328">       try {</span>
<a href="#l11.329"></a><span id="l11.329">         let listener =</span>
<a href="#l11.330"></a><span id="l11.330">           filterDef.appendTerms(aTermCreator, searchTerms, filterValue);</span>
<a href="#l11.331"></a><span id="l11.331">         if (listener)</span>
<a href="#l11.332"></a><span id="l11.332">           listeners.push([listener, filterDef]);</span>
<a href="#l11.333"></a><span id="l11.333" class="difflineminus">-      }</span>
<a href="#l11.334"></a><span id="l11.334" class="difflineminus">-      catch(ex) {</span>
<a href="#l11.335"></a><span id="l11.335" class="difflineplus">+      } catch (ex) {</span>
<a href="#l11.336"></a><span id="l11.336">         logException(ex);</span>
<a href="#l11.337"></a><span id="l11.337">       }</span>
<a href="#l11.338"></a><span id="l11.338">     }</span>
<a href="#l11.339"></a><span id="l11.339">     return searchTerms.length ? [searchTerms, listeners] : [null, listeners];</span>
<a href="#l11.340"></a><span id="l11.340" class="difflineminus">-  }</span>
<a href="#l11.341"></a><span id="l11.341" class="difflineplus">+  },</span>
<a href="#l11.342"></a><span id="l11.342"> };</span>
<a href="#l11.343"></a><span id="l11.343"> </span>
<a href="#l11.344"></a><span id="l11.344"> /**</span>
<a href="#l11.345"></a><span id="l11.345">  * Meta-filter, just handles whether or not things are sticky.</span>
<a href="#l11.346"></a><span id="l11.346">  */</span>
<a href="#l11.347"></a><span id="l11.347"> QuickFilterManager.defineFilter({</span>
<a href="#l11.348"></a><span id="l11.348">   name: &quot;sticky&quot;,</span>
<a href="#l11.349"></a><span id="l11.349">   domId: &quot;qfb-sticky&quot;,</span>
<a href="#l11.350"></a><span id="l11.350" class="difflineminus">-  appendTerms: function(aTermCreator, aTerms, aFilterValue) {</span>
<a href="#l11.351"></a><span id="l11.351" class="difflineplus">+  appendTerms(aTermCreator, aTerms, aFilterValue) {</span>
<a href="#l11.352"></a><span id="l11.352">   },</span>
<a href="#l11.353"></a><span id="l11.353">   /**</span>
<a href="#l11.354"></a><span id="l11.354">    * This should not cause an update, otherwise default logic.</span>
<a href="#l11.355"></a><span id="l11.355">    */</span>
<a href="#l11.356"></a><span id="l11.356" class="difflineminus">-  onCommand: function(aState, aNode, aEvent, aDocument) {</span>
<a href="#l11.357"></a><span id="l11.357" class="difflineplus">+  onCommand(aState, aNode, aEvent, aDocument) {</span>
<a href="#l11.358"></a><span id="l11.358">     let checked = aNode.checked ? true : null;</span>
<a href="#l11.359"></a><span id="l11.359">     return [checked, false];</span>
<a href="#l11.360"></a><span id="l11.360">   },</span>
<a href="#l11.361"></a><span id="l11.361"> });</span>
<a href="#l11.362"></a><span id="l11.362"> </span>
<a href="#l11.363"></a><span id="l11.363"> /**</span>
<a href="#l11.364"></a><span id="l11.364">  * true: must be unread, false: must be read.</span>
<a href="#l11.365"></a><span id="l11.365">  */</span>
<a href="#l11.366"></a><span id="l11.366"> QuickFilterManager.defineFilter({</span>
<a href="#l11.367"></a><span id="l11.367">   name: &quot;unread&quot;,</span>
<a href="#l11.368"></a><span id="l11.368">   domId: &quot;qfb-unread&quot;,</span>
<a href="#l11.369"></a><span id="l11.369" class="difflineminus">-  appendTerms: function(aTermCreator, aTerms, aFilterValue) {</span>
<a href="#l11.370"></a><span id="l11.370" class="difflineplus">+  appendTerms(aTermCreator, aTerms, aFilterValue) {</span>
<a href="#l11.371"></a><span id="l11.371">     let term, value;</span>
<a href="#l11.372"></a><span id="l11.372">     term = aTermCreator.createTerm();</span>
<a href="#l11.373"></a><span id="l11.373" class="difflineminus">-    term.attrib = nsMsgSearchAttrib.MsgStatus;</span>
<a href="#l11.374"></a><span id="l11.374" class="difflineplus">+    term.attrib = Ci.nsMsgSearchAttrib.MsgStatus;</span>
<a href="#l11.375"></a><span id="l11.375">     value = term.value;</span>
<a href="#l11.376"></a><span id="l11.376">     value.attrib = term.attrib;</span>
<a href="#l11.377"></a><span id="l11.377" class="difflineminus">-    value.status = nsMsgMessageFlags.Read;</span>
<a href="#l11.378"></a><span id="l11.378" class="difflineplus">+    value.status = Ci.nsMsgMessageFlags.Read;</span>
<a href="#l11.379"></a><span id="l11.379">     term.value = value;</span>
<a href="#l11.380"></a><span id="l11.380" class="difflineminus">-    term.op = aFilterValue ? nsMsgSearchOp.Isnt : nsMsgSearchOp.Is;</span>
<a href="#l11.381"></a><span id="l11.381" class="difflineplus">+    term.op = aFilterValue ? Ci.nsMsgSearchOp.Isnt : Ci.nsMsgSearchOp.Is;</span>
<a href="#l11.382"></a><span id="l11.382">     term.booleanAnd = true;</span>
<a href="#l11.383"></a><span id="l11.383">     aTerms.push(term);</span>
<a href="#l11.384"></a><span id="l11.384" class="difflineminus">-  }</span>
<a href="#l11.385"></a><span id="l11.385" class="difflineplus">+  },</span>
<a href="#l11.386"></a><span id="l11.386"> });</span>
<a href="#l11.387"></a><span id="l11.387"> </span>
<a href="#l11.388"></a><span id="l11.388"> /**</span>
<a href="#l11.389"></a><span id="l11.389">  * true: must be starred, false: must not be starred.</span>
<a href="#l11.390"></a><span id="l11.390">  */</span>
<a href="#l11.391"></a><span id="l11.391"> QuickFilterManager.defineFilter({</span>
<a href="#l11.392"></a><span id="l11.392">   name: &quot;starred&quot;,</span>
<a href="#l11.393"></a><span id="l11.393">   domId: &quot;qfb-starred&quot;,</span>
<a href="#l11.394"></a><span id="l11.394" class="difflineminus">-  appendTerms: function(aTermCreator, aTerms, aFilterValue) {</span>
<a href="#l11.395"></a><span id="l11.395" class="difflineplus">+  appendTerms(aTermCreator, aTerms, aFilterValue) {</span>
<a href="#l11.396"></a><span id="l11.396">     let term, value;</span>
<a href="#l11.397"></a><span id="l11.397">     term = aTermCreator.createTerm();</span>
<a href="#l11.398"></a><span id="l11.398" class="difflineminus">-    term.attrib = nsMsgSearchAttrib.MsgStatus;</span>
<a href="#l11.399"></a><span id="l11.399" class="difflineplus">+    term.attrib = Ci.nsMsgSearchAttrib.MsgStatus;</span>
<a href="#l11.400"></a><span id="l11.400">     value = term.value;</span>
<a href="#l11.401"></a><span id="l11.401">     value.attrib = term.attrib;</span>
<a href="#l11.402"></a><span id="l11.402" class="difflineminus">-    value.status = nsMsgMessageFlags.Marked;</span>
<a href="#l11.403"></a><span id="l11.403" class="difflineplus">+    value.status = Ci.nsMsgMessageFlags.Marked;</span>
<a href="#l11.404"></a><span id="l11.404">     term.value = value;</span>
<a href="#l11.405"></a><span id="l11.405" class="difflineminus">-    term.op = aFilterValue ? nsMsgSearchOp.Is : nsMsgSearchOp.Isnt;</span>
<a href="#l11.406"></a><span id="l11.406" class="difflineplus">+    term.op = aFilterValue ? Ci.nsMsgSearchOp.Is : Ci.nsMsgSearchOp.Isnt;</span>
<a href="#l11.407"></a><span id="l11.407">     term.booleanAnd = true;</span>
<a href="#l11.408"></a><span id="l11.408">     aTerms.push(term);</span>
<a href="#l11.409"></a><span id="l11.409" class="difflineminus">-  }</span>
<a href="#l11.410"></a><span id="l11.410" class="difflineplus">+  },</span>
<a href="#l11.411"></a><span id="l11.411"> });</span>
<a href="#l11.412"></a><span id="l11.412"> </span>
<a href="#l11.413"></a><span id="l11.413"> /**</span>
<a href="#l11.414"></a><span id="l11.414">  * true: sender must be in a local address book, false: sender must not be.</span>
<a href="#l11.415"></a><span id="l11.415">  */</span>
<a href="#l11.416"></a><span id="l11.416"> QuickFilterManager.defineFilter({</span>
<a href="#l11.417"></a><span id="l11.417">   name: &quot;addrBook&quot;,</span>
<a href="#l11.418"></a><span id="l11.418">   domId: &quot;qfb-inaddrbook&quot;,</span>
<a href="#l11.419"></a><span id="l11.419" class="difflineminus">-  appendTerms: function(aTermCreator, aTerms, aFilterValue) {</span>
<a href="#l11.420"></a><span id="l11.420" class="difflineplus">+  appendTerms(aTermCreator, aTerms, aFilterValue) {</span>
<a href="#l11.421"></a><span id="l11.421">     let term, value;</span>
<a href="#l11.422"></a><span id="l11.422">     let enumerator = MailServices.ab.directories;</span>
<a href="#l11.423"></a><span id="l11.423">     let firstBook = true;</span>
<a href="#l11.424"></a><span id="l11.424">     term = null;</span>
<a href="#l11.425"></a><span id="l11.425">     while (enumerator.hasMoreElements()) {</span>
<a href="#l11.426"></a><span id="l11.426">       let addrbook = enumerator.getNext();</span>
<a href="#l11.427"></a><span id="l11.427">       if (addrbook instanceof Ci.nsIAbDirectory &amp;&amp;</span>
<a href="#l11.428"></a><span id="l11.428">           !addrbook.isRemote) {</span>
<a href="#l11.429"></a><span id="l11.429">         term = aTermCreator.createTerm();</span>
<a href="#l11.430"></a><span id="l11.430">         term.attrib = Ci.nsMsgSearchAttrib.Sender;</span>
<a href="#l11.431"></a><span id="l11.431">         value = term.value;</span>
<a href="#l11.432"></a><span id="l11.432">         value.attrib = term.attrib;</span>
<a href="#l11.433"></a><span id="l11.433">         value.str = addrbook.URI;</span>
<a href="#l11.434"></a><span id="l11.434">         term.value = value;</span>
<a href="#l11.435"></a><span id="l11.435" class="difflineminus">-        term.op = aFilterValue ? nsMsgSearchOp.IsInAB : nsMsgSearchOp.IsntInAB;</span>
<a href="#l11.436"></a><span id="l11.436" class="difflineplus">+        term.op = aFilterValue ? Ci.nsMsgSearchOp.IsInAB : Ci.nsMsgSearchOp.IsntInAB;</span>
<a href="#l11.437"></a><span id="l11.437">         // It's an AND if we're the first book (so the boolean affects the</span>
<a href="#l11.438"></a><span id="l11.438">         //  group as a whole.)</span>
<a href="#l11.439"></a><span id="l11.439">         // It's the negation of whether we're filtering otherwise; demorgans.</span>
<a href="#l11.440"></a><span id="l11.440">         term.booleanAnd = firstBook || !aFilterValue;</span>
<a href="#l11.441"></a><span id="l11.441">         term.beginsGrouping = firstBook;</span>
<a href="#l11.442"></a><span id="l11.442">         aTerms.push(term);</span>
<a href="#l11.443"></a><span id="l11.443">         firstBook = false;</span>
<a href="#l11.444"></a><span id="l11.444">       }</span>
<a href="#l11.445"></a><span id="l11.445">     }</span>
<a href="#l11.446"></a><span id="l11.446">     if (term)</span>
<a href="#l11.447"></a><span id="l11.447">       term.endsGrouping = true;</span>
<a href="#l11.448"></a><span id="l11.448" class="difflineminus">-  }</span>
<a href="#l11.449"></a><span id="l11.449" class="difflineplus">+  },</span>
<a href="#l11.450"></a><span id="l11.450"> });</span>
<a href="#l11.451"></a><span id="l11.451"> </span>
<a href="#l11.452"></a><span id="l11.452"> /**</span>
<a href="#l11.453"></a><span id="l11.453">  * It's a tag filter that sorta facets! Stealing gloda's thunder! Woo!</span>
<a href="#l11.454"></a><span id="l11.454">  *</span>
<a href="#l11.455"></a><span id="l11.455">  * Filter on message tags?  Meanings:</span>
<a href="#l11.456"></a><span id="l11.456">  * - true: Yes, must have at least one tag on it.</span>
<a href="#l11.457"></a><span id="l11.457">  * - false: No, no tags on it!</span>
<a href="#l11.458"></a><span id="l11.458" class="difflineat">@@ -625,17 +615,17 @@ QuickFilterManager.defineFilter({</span>
<a href="#l11.459"></a><span id="l11.459"> var TagFacetingFilter = {</span>
<a href="#l11.460"></a><span id="l11.460">   name: &quot;tags&quot;,</span>
<a href="#l11.461"></a><span id="l11.461">   domId: &quot;qfb-tags&quot;,</span>
<a href="#l11.462"></a><span id="l11.462"> </span>
<a href="#l11.463"></a><span id="l11.463">   /**</span>
<a href="#l11.464"></a><span id="l11.464">    * @return true if the constaint is only on has tags/does not have tags,</span>
<a href="#l11.465"></a><span id="l11.465">    *     false if there are specific tag constraints in play.</span>
<a href="#l11.466"></a><span id="l11.466">    */</span>
<a href="#l11.467"></a><span id="l11.467" class="difflineminus">-  isSimple: function(aFilterValue) {</span>
<a href="#l11.468"></a><span id="l11.468" class="difflineplus">+  isSimple(aFilterValue) {</span>
<a href="#l11.469"></a><span id="l11.469">     // it's the simple case if the value is just a boolean</span>
<a href="#l11.470"></a><span id="l11.470">     if (typeof(aFilterValue) != &quot;object&quot;)</span>
<a href="#l11.471"></a><span id="l11.471">       return true;</span>
<a href="#l11.472"></a><span id="l11.472">     // but also if the object contains no non-null values</span>
<a href="#l11.473"></a><span id="l11.473">     let simpleCase = true;</span>
<a href="#l11.474"></a><span id="l11.474">     for (let key in aFilterValue.tags) {</span>
<a href="#l11.475"></a><span id="l11.475">       let value = aFilterValue.tags[key];</span>
<a href="#l11.476"></a><span id="l11.476">       if (value !== null) {</span>
<a href="#l11.477"></a><span id="l11.477" class="difflineat">@@ -648,17 +638,17 @@ var TagFacetingFilter = {</span>
<a href="#l11.478"></a><span id="l11.478"> </span>
<a href="#l11.479"></a><span id="l11.479">   /**</span>
<a href="#l11.480"></a><span id="l11.480">    * Because we support both inclusion and exclusion we can produce up to two</span>
<a href="#l11.481"></a><span id="l11.481">    *  groups.  One group for inclusion, one group for exclusion.  To get listed</span>
<a href="#l11.482"></a><span id="l11.482">    *  the message must have any/all of the tags marked for inclusion,</span>
<a href="#l11.483"></a><span id="l11.483">    *  (depending on mode), but it cannot have any of the tags marked for</span>
<a href="#l11.484"></a><span id="l11.484">    *  exclusion.</span>
<a href="#l11.485"></a><span id="l11.485">    */</span>
<a href="#l11.486"></a><span id="l11.486" class="difflineminus">-  appendTerms: function TFF_appendTerms(aTermCreator, aTerms, aFilterValue) {</span>
<a href="#l11.487"></a><span id="l11.487" class="difflineplus">+  appendTerms(aTermCreator, aTerms, aFilterValue) {</span>
<a href="#l11.488"></a><span id="l11.488">     if (aFilterValue == null)</span>
<a href="#l11.489"></a><span id="l11.489">       return null;</span>
<a href="#l11.490"></a><span id="l11.490"> </span>
<a href="#l11.491"></a><span id="l11.491">     let term, value;</span>
<a href="#l11.492"></a><span id="l11.492"> </span>
<a href="#l11.493"></a><span id="l11.493">     // just the true/false case</span>
<a href="#l11.494"></a><span id="l11.494">     if (this.isSimple(aFilterValue)) {</span>
<a href="#l11.495"></a><span id="l11.495">       term = aTermCreator.createTerm();</span>
<a href="#l11.496"></a><span id="l11.496" class="difflineat">@@ -670,18 +660,17 @@ var TagFacetingFilter = {</span>
<a href="#l11.497"></a><span id="l11.497">                   Ci.nsMsgSearchOp.IsntEmpty :</span>
<a href="#l11.498"></a><span id="l11.498">                   Ci.nsMsgSearchOp.IsEmpty;</span>
<a href="#l11.499"></a><span id="l11.499">       term.booleanAnd = true;</span>
<a href="#l11.500"></a><span id="l11.500">       aTerms.push(term);</span>
<a href="#l11.501"></a><span id="l11.501"> </span>
<a href="#l11.502"></a><span id="l11.502">       // we need to perform faceting if the value is literally true.</span>
<a href="#l11.503"></a><span id="l11.503">       if (aFilterValue === true)</span>
<a href="#l11.504"></a><span id="l11.504">         return this;</span>
<a href="#l11.505"></a><span id="l11.505" class="difflineminus">-    }</span>
<a href="#l11.506"></a><span id="l11.506" class="difflineminus">-    else {</span>
<a href="#l11.507"></a><span id="l11.507" class="difflineplus">+    } else {</span>
<a href="#l11.508"></a><span id="l11.508">       let firstIncludeClause = true, firstExcludeClause = true;</span>
<a href="#l11.509"></a><span id="l11.509">       let lastIncludeTerm = null;</span>
<a href="#l11.510"></a><span id="l11.510">       term = null;</span>
<a href="#l11.511"></a><span id="l11.511"> </span>
<a href="#l11.512"></a><span id="l11.512">       let excludeTerms = [];</span>
<a href="#l11.513"></a><span id="l11.513"> </span>
<a href="#l11.514"></a><span id="l11.514">       let mode = aFilterValue.mode;</span>
<a href="#l11.515"></a><span id="l11.515">       for (let key in aFilterValue.tags) {</span>
<a href="#l11.516"></a><span id="l11.516" class="difflineat">@@ -689,27 +678,26 @@ var TagFacetingFilter = {</span>
<a href="#l11.517"></a><span id="l11.517">         if (shouldFilter !== null) {</span>
<a href="#l11.518"></a><span id="l11.518">           term = aTermCreator.createTerm();</span>
<a href="#l11.519"></a><span id="l11.519">           term.attrib = Ci.nsMsgSearchAttrib.Keywords;</span>
<a href="#l11.520"></a><span id="l11.520">           value = term.value;</span>
<a href="#l11.521"></a><span id="l11.521">           value.attrib = term.attrib;</span>
<a href="#l11.522"></a><span id="l11.522">           value.str = key;</span>
<a href="#l11.523"></a><span id="l11.523">           term.value = value;</span>
<a href="#l11.524"></a><span id="l11.524">           if (shouldFilter) {</span>
<a href="#l11.525"></a><span id="l11.525" class="difflineminus">-            term.op = nsMsgSearchOp.Contains;</span>
<a href="#l11.526"></a><span id="l11.526" class="difflineplus">+            term.op = Ci.nsMsgSearchOp.Contains;</span>
<a href="#l11.527"></a><span id="l11.527">             // AND for the group. Inside the group we also want AND if the</span>
<a href="#l11.528"></a><span id="l11.528">             // mode is set to &quot;All of&quot;.</span>
<a href="#l11.529"></a><span id="l11.529">             term.booleanAnd = firstIncludeClause || (mode === &quot;AND&quot;);</span>
<a href="#l11.530"></a><span id="l11.530">             term.beginsGrouping = firstIncludeClause;</span>
<a href="#l11.531"></a><span id="l11.531">             aTerms.push(term);</span>
<a href="#l11.532"></a><span id="l11.532">             firstIncludeClause = false;</span>
<a href="#l11.533"></a><span id="l11.533">             lastIncludeTerm = term;</span>
<a href="#l11.534"></a><span id="l11.534" class="difflineminus">-          }</span>
<a href="#l11.535"></a><span id="l11.535" class="difflineminus">-          else {</span>
<a href="#l11.536"></a><span id="l11.536" class="difflineminus">-            term.op = nsMsgSearchOp.DoesntContain;</span>
<a href="#l11.537"></a><span id="l11.537" class="difflineplus">+          } else {</span>
<a href="#l11.538"></a><span id="l11.538" class="difflineplus">+            term.op = Ci.nsMsgSearchOp.DoesntContain;</span>
<a href="#l11.539"></a><span id="l11.539">             // you need to not include all of the tags marked excluded.</span>
<a href="#l11.540"></a><span id="l11.540">             term.booleanAnd = true;</span>
<a href="#l11.541"></a><span id="l11.541">             term.beginsGrouping = firstExcludeClause;</span>
<a href="#l11.542"></a><span id="l11.542">             excludeTerms.push(term);</span>
<a href="#l11.543"></a><span id="l11.543">             firstExcludeClause = false;</span>
<a href="#l11.544"></a><span id="l11.544">           }</span>
<a href="#l11.545"></a><span id="l11.545">         }</span>
<a href="#l11.546"></a><span id="l11.546">       }</span>
<a href="#l11.547"></a><span id="l11.547" class="difflineat">@@ -729,36 +717,36 @@ var TagFacetingFilter = {</span>
<a href="#l11.548"></a><span id="l11.548">           value.str = &quot;&quot;;</span>
<a href="#l11.549"></a><span id="l11.549">           term.value = value;</span>
<a href="#l11.550"></a><span id="l11.550">           term.op = Ci.nsMsgSearchOp.IsntEmpty;</span>
<a href="#l11.551"></a><span id="l11.551">           term.booleanAnd = true;</span>
<a href="#l11.552"></a><span id="l11.552">           aTerms.push(term);</span>
<a href="#l11.553"></a><span id="l11.553">         }</span>
<a href="#l11.554"></a><span id="l11.554"> </span>
<a href="#l11.555"></a><span id="l11.555">         // (extend in the exclusions)</span>
<a href="#l11.556"></a><span id="l11.556" class="difflineminus">-        excludeTerms[excludeTerms.length-1].endsGrouping = true;</span>
<a href="#l11.557"></a><span id="l11.557" class="difflineplus">+        excludeTerms[excludeTerms.length - 1].endsGrouping = true;</span>
<a href="#l11.558"></a><span id="l11.558">         aTerms.push.apply(aTerms, excludeTerms);</span>
<a href="#l11.559"></a><span id="l11.559">       }</span>
<a href="#l11.560"></a><span id="l11.560">     }</span>
<a href="#l11.561"></a><span id="l11.561">     return null;</span>
<a href="#l11.562"></a><span id="l11.562">   },</span>
<a href="#l11.563"></a><span id="l11.563"> </span>
<a href="#l11.564"></a><span id="l11.564" class="difflineminus">-  onSearchStart: function(aCurState) {</span>
<a href="#l11.565"></a><span id="l11.565" class="difflineplus">+  onSearchStart(aCurState) {</span>
<a href="#l11.566"></a><span id="l11.566">     // this becomes aKeywordMap; we want to start with an empty one</span>
<a href="#l11.567"></a><span id="l11.567">     return {};</span>
<a href="#l11.568"></a><span id="l11.568">   },</span>
<a href="#l11.569"></a><span id="l11.569" class="difflineminus">-  onSearchMessage: function(aKeywordMap, aMsgHdr, aFolder) {</span>
<a href="#l11.570"></a><span id="l11.570" class="difflineplus">+  onSearchMessage(aKeywordMap, aMsgHdr, aFolder) {</span>
<a href="#l11.571"></a><span id="l11.571">     let keywords = aMsgHdr.getStringProperty(&quot;keywords&quot;);</span>
<a href="#l11.572"></a><span id="l11.572" class="difflineminus">-    let keywordList = keywords.split(' ');</span>
<a href="#l11.573"></a><span id="l11.573" class="difflineplus">+    let keywordList = keywords.split(&quot; &quot;);</span>
<a href="#l11.574"></a><span id="l11.574">     for (let iKeyword = 0; iKeyword &lt; keywordList.length; iKeyword++) {</span>
<a href="#l11.575"></a><span id="l11.575">       let keyword = keywordList[iKeyword];</span>
<a href="#l11.576"></a><span id="l11.576">       aKeywordMap[keyword] = null;</span>
<a href="#l11.577"></a><span id="l11.577">     }</span>
<a href="#l11.578"></a><span id="l11.578">   },</span>
<a href="#l11.579"></a><span id="l11.579" class="difflineminus">-  onSearchDone: function(aCurState, aKeywordMap, aStatus) {</span>
<a href="#l11.580"></a><span id="l11.580" class="difflineplus">+  onSearchDone(aCurState, aKeywordMap, aStatus) {</span>
<a href="#l11.581"></a><span id="l11.581">     // we are an async operation; if the user turned off the tag facet already,</span>
<a href="#l11.582"></a><span id="l11.582">     //  then leave that state intact...</span>
<a href="#l11.583"></a><span id="l11.583">     if (aCurState == null)</span>
<a href="#l11.584"></a><span id="l11.584">       return [null, false, false];</span>
<a href="#l11.585"></a><span id="l11.585"> </span>
<a href="#l11.586"></a><span id="l11.586">     // only propagate things that are actually tags though!</span>
<a href="#l11.587"></a><span id="l11.587">     let outKeyMap = {tags: {}};</span>
<a href="#l11.588"></a><span id="l11.588">     let tags = MailServices.tags.getAllTags({});</span>
<a href="#l11.589"></a><span id="l11.589" class="difflineat">@@ -770,62 +758,61 @@ var TagFacetingFilter = {</span>
<a href="#l11.590"></a><span id="l11.590">         outKeyMap.tags[tag.key] = aKeywordMap[tag.key];</span>
<a href="#l11.591"></a><span id="l11.591">     }</span>
<a href="#l11.592"></a><span id="l11.592">     return [outKeyMap, true, false];</span>
<a href="#l11.593"></a><span id="l11.593">   },</span>
<a href="#l11.594"></a><span id="l11.594"> </span>
<a href="#l11.595"></a><span id="l11.595">   /**</span>
<a href="#l11.596"></a><span id="l11.596">    * We need to clone our state if it's an object to avoid bad sharing.</span>
<a href="#l11.597"></a><span id="l11.597">    */</span>
<a href="#l11.598"></a><span id="l11.598" class="difflineminus">-  propagateState: function(aOld, aSticky) {</span>
<a href="#l11.599"></a><span id="l11.599" class="difflineplus">+  propagateState(aOld, aSticky) {</span>
<a href="#l11.600"></a><span id="l11.600">     // stay disabled when disabled, get disabled when not sticky</span>
<a href="#l11.601"></a><span id="l11.601">     if (aOld == null || !aSticky)</span>
<a href="#l11.602"></a><span id="l11.602">       return null;</span>
<a href="#l11.603"></a><span id="l11.603">     if (this.isSimple(aOld))</span>
<a href="#l11.604"></a><span id="l11.604" class="difflineminus">-      return aOld ? true : false; // could be an object, need to convert.</span>
<a href="#l11.605"></a><span id="l11.605" class="difflineplus">+      return !!aOld; // could be an object, need to convert.</span>
<a href="#l11.606"></a><span id="l11.606">     return shallowObjCopy(aOld);</span>
<a href="#l11.607"></a><span id="l11.607">   },</span>
<a href="#l11.608"></a><span id="l11.608"> </span>
<a href="#l11.609"></a><span id="l11.609">   /**</span>
<a href="#l11.610"></a><span id="l11.610">    * Default behaviour but:</span>
<a href="#l11.611"></a><span id="l11.611">    * - We collapse our expando if we get unchecked.</span>
<a href="#l11.612"></a><span id="l11.612">    * - We want to initiate a faceting pass if we just got checked.</span>
<a href="#l11.613"></a><span id="l11.613">    */</span>
<a href="#l11.614"></a><span id="l11.614" class="difflineminus">-  onCommand: function(aState, aNode, aEvent, aDocument) {</span>
<a href="#l11.615"></a><span id="l11.615" class="difflineplus">+  onCommand(aState, aNode, aEvent, aDocument) {</span>
<a href="#l11.616"></a><span id="l11.616">     let checked = aNode.checked ? true : null;</span>
<a href="#l11.617"></a><span id="l11.617">     if (!checked)</span>
<a href="#l11.618"></a><span id="l11.618">       aDocument.getElementById(&quot;quick-filter-bar-tab-bar&quot;).collapsed = true;</span>
<a href="#l11.619"></a><span id="l11.619"> </span>
<a href="#l11.620"></a><span id="l11.620">     // return ourselves if we just got checked to have</span>
<a href="#l11.621"></a><span id="l11.621">     //  onSearchStart/onSearchMessage/onSearchDone get to do their thing.</span>
<a href="#l11.622"></a><span id="l11.622">     return [checked, true];</span>
<a href="#l11.623"></a><span id="l11.623">   },</span>
<a href="#l11.624"></a><span id="l11.624"> </span>
<a href="#l11.625"></a><span id="l11.625" class="difflineminus">-  domBindExtra: function(aDocument, aMuxer, aNode) {</span>
<a href="#l11.626"></a><span id="l11.626" class="difflineplus">+  domBindExtra(aDocument, aMuxer, aNode) {</span>
<a href="#l11.627"></a><span id="l11.627">     // Tag filtering mode menu (All of/Any of)</span>
<a href="#l11.628"></a><span id="l11.628">     function commandHandler(aEvent) {</span>
<a href="#l11.629"></a><span id="l11.629">       let filterValue = aMuxer.getFilterValueForMutation(TagFacetingFilter.name);</span>
<a href="#l11.630"></a><span id="l11.630">       filterValue.mode = aEvent.target.value;</span>
<a href="#l11.631"></a><span id="l11.631">       aMuxer.updateSearch();</span>
<a href="#l11.632"></a><span id="l11.632">     }</span>
<a href="#l11.633"></a><span id="l11.633">     aDocument.getElementById(&quot;qfb-boolean-mode&quot;).addEventListener(</span>
<a href="#l11.634"></a><span id="l11.634">       &quot;ValueChange&quot;, commandHandler);</span>
<a href="#l11.635"></a><span id="l11.635">   },</span>
<a href="#l11.636"></a><span id="l11.636"> </span>
<a href="#l11.637"></a><span id="l11.637" class="difflineminus">-  reflectInDOM: function TFF_reflectInDOM(aNode, aFilterValue,</span>
<a href="#l11.638"></a><span id="l11.638" class="difflineminus">-                                          aDocument, aMuxer) {</span>
<a href="#l11.639"></a><span id="l11.639" class="difflineminus">-    aNode.checked = aFilterValue ? true : false;</span>
<a href="#l11.640"></a><span id="l11.640" class="difflineplus">+  reflectInDOM(aNode, aFilterValue, aDocument, aMuxer) {</span>
<a href="#l11.641"></a><span id="l11.641" class="difflineplus">+    aNode.checked = !!aFilterValue;</span>
<a href="#l11.642"></a><span id="l11.642">     if ((aFilterValue != null) &amp;&amp;</span>
<a href="#l11.643"></a><span id="l11.643">         (typeof(aFilterValue) == &quot;object&quot;))</span>
<a href="#l11.644"></a><span id="l11.644">       this._populateTagBar(aFilterValue, aDocument, aMuxer);</span>
<a href="#l11.645"></a><span id="l11.645">     else</span>
<a href="#l11.646"></a><span id="l11.646">       aDocument.getElementById(&quot;quick-filter-bar-tab-bar&quot;).collapsed = true;</span>
<a href="#l11.647"></a><span id="l11.647">   },</span>
<a href="#l11.648"></a><span id="l11.648"> </span>
<a href="#l11.649"></a><span id="l11.649" class="difflineminus">-  _populateTagBar: function TFF__populateTagMenu(aState, aDocument, aMuxer) {</span>
<a href="#l11.650"></a><span id="l11.650" class="difflineplus">+  _populateTagBar(aState, aDocument, aMuxer) {</span>
<a href="#l11.651"></a><span id="l11.651">     let tagbar = aDocument.getElementById(&quot;quick-filter-bar-tab-bar&quot;);</span>
<a href="#l11.652"></a><span id="l11.652">     let keywordMap = aState.tags;</span>
<a href="#l11.653"></a><span id="l11.653"> </span>
<a href="#l11.654"></a><span id="l11.654">     // If we have a mode stored use that. If we don't have a mode, then update</span>
<a href="#l11.655"></a><span id="l11.655">     // our state to agree with what the UI is currently displaying;</span>
<a href="#l11.656"></a><span id="l11.656">     // this will happen for fresh profiles.</span>
<a href="#l11.657"></a><span id="l11.657">     let qbm = aDocument.getElementById(&quot;qfb-boolean-mode&quot;);</span>
<a href="#l11.658"></a><span id="l11.658">     if (aState.mode)</span>
<a href="#l11.659"></a><span id="l11.659" class="difflineat">@@ -834,17 +821,17 @@ var TagFacetingFilter = {</span>
<a href="#l11.660"></a><span id="l11.660">       aState.mode = qbm.value;</span>
<a href="#l11.661"></a><span id="l11.661"> </span>
<a href="#l11.662"></a><span id="l11.662">     function commandHandler(aEvent) {</span>
<a href="#l11.663"></a><span id="l11.663">       let tagKey = aEvent.target.getAttribute(&quot;value&quot;);</span>
<a href="#l11.664"></a><span id="l11.664">       let state = aMuxer.getFilterValueForMutation(TagFacetingFilter.name);</span>
<a href="#l11.665"></a><span id="l11.665">       state.tags[tagKey] = aEvent.target.checked ? true : null;</span>
<a href="#l11.666"></a><span id="l11.666">       aEvent.target.removeAttribute(&quot;inverted&quot;);</span>
<a href="#l11.667"></a><span id="l11.667">       aMuxer.updateSearch();</span>
<a href="#l11.668"></a><span id="l11.668" class="difflineminus">-    };</span>
<a href="#l11.669"></a><span id="l11.669" class="difflineplus">+    }</span>
<a href="#l11.670"></a><span id="l11.670"> </span>
<a href="#l11.671"></a><span id="l11.671">     function rightClickHandler(aEvent) {</span>
<a href="#l11.672"></a><span id="l11.672">       // Only do something if this is a right-click, otherwise commandHandler</span>
<a href="#l11.673"></a><span id="l11.673">       //  will pick up on it.</span>
<a href="#l11.674"></a><span id="l11.674">       if (aEvent.button == 2) {</span>
<a href="#l11.675"></a><span id="l11.675">         // we need to toggle the checked state ourselves</span>
<a href="#l11.676"></a><span id="l11.676">         aEvent.target.checked = !aEvent.target.checked;</span>
<a href="#l11.677"></a><span id="l11.677"> </span>
<a href="#l11.678"></a><span id="l11.678" class="difflineat">@@ -908,28 +895,28 @@ var TagFacetingFilter = {</span>
<a href="#l11.679"></a><span id="l11.679"> QuickFilterManager.defineFilter(TagFacetingFilter);</span>
<a href="#l11.680"></a><span id="l11.680"> </span>
<a href="#l11.681"></a><span id="l11.681"> /**</span>
<a href="#l11.682"></a><span id="l11.682">  * true: must have attachment, false: must not have attachment.</span>
<a href="#l11.683"></a><span id="l11.683">  */</span>
<a href="#l11.684"></a><span id="l11.684"> QuickFilterManager.defineFilter({</span>
<a href="#l11.685"></a><span id="l11.685">   name: &quot;attachment&quot;,</span>
<a href="#l11.686"></a><span id="l11.686">   domId: &quot;qfb-attachment&quot;,</span>
<a href="#l11.687"></a><span id="l11.687" class="difflineminus">-  appendTerms: function(aTermCreator, aTerms, aFilterValue) {</span>
<a href="#l11.688"></a><span id="l11.688" class="difflineplus">+  appendTerms(aTermCreator, aTerms, aFilterValue) {</span>
<a href="#l11.689"></a><span id="l11.689">     let term, value;</span>
<a href="#l11.690"></a><span id="l11.690">     term = aTermCreator.createTerm();</span>
<a href="#l11.691"></a><span id="l11.691">     term.attrib = Ci.nsMsgSearchAttrib.MsgStatus;</span>
<a href="#l11.692"></a><span id="l11.692">     value = term.value;</span>
<a href="#l11.693"></a><span id="l11.693">     value.attrib = term.attrib;</span>
<a href="#l11.694"></a><span id="l11.694">     value.status = Ci.nsMsgMessageFlags.Attachment;</span>
<a href="#l11.695"></a><span id="l11.695">     term.value = value;</span>
<a href="#l11.696"></a><span id="l11.696" class="difflineminus">-    term.op = aFilterValue ? nsMsgSearchOp.Is : nsMsgSearchOp.Isnt;</span>
<a href="#l11.697"></a><span id="l11.697" class="difflineplus">+    term.op = aFilterValue ? Ci.nsMsgSearchOp.Is : Ci.nsMsgSearchOp.Isnt;</span>
<a href="#l11.698"></a><span id="l11.698">     term.booleanAnd = true;</span>
<a href="#l11.699"></a><span id="l11.699">     aTerms.push(term);</span>
<a href="#l11.700"></a><span id="l11.700" class="difflineminus">-  }</span>
<a href="#l11.701"></a><span id="l11.701" class="difflineplus">+  },</span>
<a href="#l11.702"></a><span id="l11.702"> });</span>
<a href="#l11.703"></a><span id="l11.703"> </span>
<a href="#l11.704"></a><span id="l11.704"> /**</span>
<a href="#l11.705"></a><span id="l11.705">  * The traditional quick-search text filter now with added gloda upsell!  We</span>
<a href="#l11.706"></a><span id="l11.706">  * are mildly extensible in case someone wants to add more specific text filter</span>
<a href="#l11.707"></a><span id="l11.707">  * criteria to toggle, but otherwise are intended to be taken out of the</span>
<a href="#l11.708"></a><span id="l11.708">  * picture entirely by extensions implementing more featureful text searches.</span>
<a href="#l11.709"></a><span id="l11.709">  *</span>
<a href="#l11.710"></a><span id="l11.710" class="difflineat">@@ -946,17 +933,17 @@ var MessageTextFilter = {</span>
<a href="#l11.711"></a><span id="l11.711">    * update using a timer and this results in stable behavior.)</span>
<a href="#l11.712"></a><span id="l11.712">    *</span>
<a href="#l11.713"></a><span id="l11.713">    * This code is cloned from gloda's msg_search.js and known good (enough :).</span>
<a href="#l11.714"></a><span id="l11.714">    * I did change the friendless quote situation, though.</span>
<a href="#l11.715"></a><span id="l11.715">    *</span>
<a href="#l11.716"></a><span id="l11.716">    * @param aSearchString The phrase to parse up.</span>
<a href="#l11.717"></a><span id="l11.717">    * @return A list of terms.</span>
<a href="#l11.718"></a><span id="l11.718">    */</span>
<a href="#l11.719"></a><span id="l11.719" class="difflineminus">-  _parseSearchString: function MTF__parseSearchString(aSearchString) {</span>
<a href="#l11.720"></a><span id="l11.720" class="difflineplus">+  _parseSearchString(aSearchString) {</span>
<a href="#l11.721"></a><span id="l11.721">     aSearchString = aSearchString.trim();</span>
<a href="#l11.722"></a><span id="l11.722">     let terms = [];</span>
<a href="#l11.723"></a><span id="l11.723"> </span>
<a href="#l11.724"></a><span id="l11.724">     /*</span>
<a href="#l11.725"></a><span id="l11.725">      * Add the term as long as the trim on the way in didn't obliterate it.</span>
<a href="#l11.726"></a><span id="l11.726">      *</span>
<a href="#l11.727"></a><span id="l11.727">      * In the future this might have other helper logic; it did once before.</span>
<a href="#l11.728"></a><span id="l11.728">      */</span>
<a href="#l11.729"></a><span id="l11.729" class="difflineat">@@ -992,17 +979,17 @@ var MessageTextFilter = {</span>
<a href="#l11.730"></a><span id="l11.730">   },</span>
<a href="#l11.731"></a><span id="l11.731"> </span>
<a href="#l11.732"></a><span id="l11.732">   /**</span>
<a href="#l11.733"></a><span id="l11.733">    * For each search phrase, build a group that contains all our active text</span>
<a href="#l11.734"></a><span id="l11.734">    *  filters OR'ed together.  So if the user queries for 'foo bar' with</span>
<a href="#l11.735"></a><span id="l11.735">    *  sender and recipient enabled, we build:</span>
<a href="#l11.736"></a><span id="l11.736">    * (&quot;foo&quot; sender OR &quot;foo&quot; recipient) AND (&quot;bar&quot; sender OR &quot;bar&quot; recipient)</span>
<a href="#l11.737"></a><span id="l11.737">    */</span>
<a href="#l11.738"></a><span id="l11.738" class="difflineminus">-  appendTerms: function(aTermCreator, aTerms, aFilterValue) {</span>
<a href="#l11.739"></a><span id="l11.739" class="difflineplus">+  appendTerms(aTermCreator, aTerms, aFilterValue) {</span>
<a href="#l11.740"></a><span id="l11.740">     let term, value;</span>
<a href="#l11.741"></a><span id="l11.741"> </span>
<a href="#l11.742"></a><span id="l11.742">     if (aFilterValue.text) {</span>
<a href="#l11.743"></a><span id="l11.743">       let phrases = this._parseSearchString(aFilterValue.text);</span>
<a href="#l11.744"></a><span id="l11.744">       for (let groupedPhrases of phrases) {</span>
<a href="#l11.745"></a><span id="l11.745">         let firstClause = true;</span>
<a href="#l11.746"></a><span id="l11.746">         term = null;</span>
<a href="#l11.747"></a><span id="l11.747">         let splitPhrases = groupedPhrases.split(&quot;|&quot;);</span>
<a href="#l11.748"></a><span id="l11.748" class="difflineat">@@ -1013,57 +1000,57 @@ var MessageTextFilter = {</span>
<a href="#l11.749"></a><span id="l11.749">             let tfDef = this.textFilterDefs[tfName];</span>
<a href="#l11.750"></a><span id="l11.750"> </span>
<a href="#l11.751"></a><span id="l11.751">             term = aTermCreator.createTerm();</span>
<a href="#l11.752"></a><span id="l11.752">             term.attrib = tfDef.attrib;</span>
<a href="#l11.753"></a><span id="l11.753">             value = term.value;</span>
<a href="#l11.754"></a><span id="l11.754">             value.attrib = tfDef.attrib;</span>
<a href="#l11.755"></a><span id="l11.755">             value.str = phrase;</span>
<a href="#l11.756"></a><span id="l11.756">             term.value = value;</span>
<a href="#l11.757"></a><span id="l11.757" class="difflineminus">-            term.op = nsMsgSearchOp.Contains;</span>
<a href="#l11.758"></a><span id="l11.758" class="difflineplus">+            term.op = Ci.nsMsgSearchOp.Contains;</span>
<a href="#l11.759"></a><span id="l11.759">             // AND for the group, but OR inside the group</span>
<a href="#l11.760"></a><span id="l11.760">             term.booleanAnd = firstClause;</span>
<a href="#l11.761"></a><span id="l11.761">             term.beginsGrouping = firstClause;</span>
<a href="#l11.762"></a><span id="l11.762">             aTerms.push(term);</span>
<a href="#l11.763"></a><span id="l11.763">             firstClause = false;</span>
<a href="#l11.764"></a><span id="l11.764">           }</span>
<a href="#l11.765"></a><span id="l11.765">         }</span>
<a href="#l11.766"></a><span id="l11.766">         if (term)</span>
<a href="#l11.767"></a><span id="l11.767">           term.endsGrouping = true;</span>
<a href="#l11.768"></a><span id="l11.768">       }</span>
<a href="#l11.769"></a><span id="l11.769">     }</span>
<a href="#l11.770"></a><span id="l11.770">   },</span>
<a href="#l11.771"></a><span id="l11.771" class="difflineminus">-  getDefaults: function() {</span>
<a href="#l11.772"></a><span id="l11.772" class="difflineplus">+  getDefaults() {</span>
<a href="#l11.773"></a><span id="l11.773">     let states = {};</span>
<a href="#l11.774"></a><span id="l11.774">     for (let name in this._defaultStates) {</span>
<a href="#l11.775"></a><span id="l11.775">       states[name] = this._defaultStates[name];</span>
<a href="#l11.776"></a><span id="l11.776">     }</span>
<a href="#l11.777"></a><span id="l11.777">     return {</span>
<a href="#l11.778"></a><span id="l11.778">       text: null,</span>
<a href="#l11.779"></a><span id="l11.779" class="difflineminus">-      states: states,</span>
<a href="#l11.780"></a><span id="l11.780" class="difflineplus">+      states,</span>
<a href="#l11.781"></a><span id="l11.781">     };</span>
<a href="#l11.782"></a><span id="l11.782">   },</span>
<a href="#l11.783"></a><span id="l11.783" class="difflineminus">-  propagateState: function(aOld, aSticky) {</span>
<a href="#l11.784"></a><span id="l11.784" class="difflineplus">+  propagateState(aOld, aSticky) {</span>
<a href="#l11.785"></a><span id="l11.785">     return {</span>
<a href="#l11.786"></a><span id="l11.786">       text: aSticky ? aOld.text : null,</span>
<a href="#l11.787"></a><span id="l11.787">       states: shallowObjCopy(aOld.states),</span>
<a href="#l11.788"></a><span id="l11.788">     };</span>
<a href="#l11.789"></a><span id="l11.789">   },</span>
<a href="#l11.790"></a><span id="l11.790" class="difflineminus">-  clearState: function(aState) {</span>
<a href="#l11.791"></a><span id="l11.791" class="difflineplus">+  clearState(aState) {</span>
<a href="#l11.792"></a><span id="l11.792">     let hadState = Boolean(aState.text);</span>
<a href="#l11.793"></a><span id="l11.793">     aState.text = null;</span>
<a href="#l11.794"></a><span id="l11.794">     return [aState, hadState];</span>
<a href="#l11.795"></a><span id="l11.795">   },</span>
<a href="#l11.796"></a><span id="l11.796"> </span>
<a href="#l11.797"></a><span id="l11.797">   /**</span>
<a href="#l11.798"></a><span id="l11.798">    * We need to create and bind our expando-bar toggle buttons.  We also need to</span>
<a href="#l11.799"></a><span id="l11.799">    *  add a special down keypress handler that escapes the textbox into the</span>
<a href="#l11.800"></a><span id="l11.800">    *  thread pane.</span>
<a href="#l11.801"></a><span id="l11.801">    */</span>
<a href="#l11.802"></a><span id="l11.802" class="difflineminus">-  domBindExtra: function MessageTextFilter_domBind(aDocument, aMuxer, aNode) {</span>
<a href="#l11.803"></a><span id="l11.803" class="difflineplus">+  domBindExtra(aDocument, aMuxer, aNode) {</span>
<a href="#l11.804"></a><span id="l11.804">     // -- platform-dependent placeholder setup</span>
<a href="#l11.805"></a><span id="l11.805">     aNode.setAttribute(</span>
<a href="#l11.806"></a><span id="l11.806">       &quot;placeholder&quot;,</span>
<a href="#l11.807"></a><span id="l11.807">       aNode.getAttribute(&quot;emptytextbase&quot;)</span>
<a href="#l11.808"></a><span id="l11.808">            .replace(&quot;#1&quot;, aNode.getAttribute((AppConstants.platform == &quot;macosx&quot;) ?</span>
<a href="#l11.809"></a><span id="l11.809">                                              &quot;keyLabelMac&quot; : &quot;keyLabelNonMac&quot;)));</span>
<a href="#l11.810"></a><span id="l11.810">     // force an update of the emptytext now that we've updated it.</span>
<a href="#l11.811"></a><span id="l11.811">     aNode.value = &quot;&quot;;</span>
<a href="#l11.812"></a><span id="l11.812" class="difflineat">@@ -1074,19 +1061,16 @@ var MessageTextFilter = {</span>
<a href="#l11.813"></a><span id="l11.813">       if (aEvent.keyCode == aEvent.DOM_VK_DOWN) {</span>
<a href="#l11.814"></a><span id="l11.814">         let threadPane = aDocument.getElementById(&quot;threadTree&quot;);</span>
<a href="#l11.815"></a><span id="l11.815">         // focusing does not actually select the row...</span>
<a href="#l11.816"></a><span id="l11.816">         threadPane.focus();</span>
<a href="#l11.817"></a><span id="l11.817">         // ...so explicitly select the current index.</span>
<a href="#l11.818"></a><span id="l11.818">         threadPane.view.selection.select(threadPane.currentIndex);</span>
<a href="#l11.819"></a><span id="l11.819">         return false;</span>
<a href="#l11.820"></a><span id="l11.820">       }</span>
<a href="#l11.821"></a><span id="l11.821" class="difflineminus">-      // - Enter when upsell is actively proposed...</span>
<a href="#l11.822"></a><span id="l11.822" class="difflineminus">-      else if (aEvent.keyCode == aEvent.DOM_VK_RETURN) {</span>
<a href="#l11.823"></a><span id="l11.823" class="difflineminus">-      }</span>
<a href="#l11.824"></a><span id="l11.824">       return true;</span>
<a href="#l11.825"></a><span id="l11.825">     });</span>
<a href="#l11.826"></a><span id="l11.826"> </span>
<a href="#l11.827"></a><span id="l11.827">     // -- Blurring kills upsell.</span>
<a href="#l11.828"></a><span id="l11.828">     aNode.addEventListener(&quot;blur&quot;, function(aEvent) {</span>
<a href="#l11.829"></a><span id="l11.829">       let panel = aDocument.getElementById(&quot;qfb-text-search-upsell&quot;);</span>
<a href="#l11.830"></a><span id="l11.830">       if ((Services.focus.activeWindow != aDocument.defaultView ||</span>
<a href="#l11.831"></a><span id="l11.831">            aDocument.commandDispatcher.focusedElement != aNode.inputField) &amp;&amp;</span>
<a href="#l11.832"></a><span id="l11.832" class="difflineat">@@ -1105,56 +1089,54 @@ var MessageTextFilter = {</span>
<a href="#l11.833"></a><span id="l11.833"> </span>
<a href="#l11.834"></a><span id="l11.834">     for (let name in this.textFilterDefs) {</span>
<a href="#l11.835"></a><span id="l11.835">       let textFilter  = this.textFilterDefs[name];</span>
<a href="#l11.836"></a><span id="l11.836">       aDocument.getElementById(textFilter.domId).addEventListener(</span>
<a href="#l11.837"></a><span id="l11.837">         &quot;command&quot;, commandHandler);</span>
<a href="#l11.838"></a><span id="l11.838">     }</span>
<a href="#l11.839"></a><span id="l11.839">   },</span>
<a href="#l11.840"></a><span id="l11.840"> </span>
<a href="#l11.841"></a><span id="l11.841" class="difflineminus">-  onCommand: function(aState, aNode, aEvent, aDocument) {</span>
<a href="#l11.842"></a><span id="l11.842" class="difflineplus">+  onCommand(aState, aNode, aEvent, aDocument) {</span>
<a href="#l11.843"></a><span id="l11.843">     let text = aNode.value.length ? aNode.value : null;</span>
<a href="#l11.844"></a><span id="l11.844">     if (text == aState.text) {</span>
<a href="#l11.845"></a><span id="l11.845">       let upsell = aDocument.getElementById(&quot;qfb-text-search-upsell&quot;);</span>
<a href="#l11.846"></a><span id="l11.846">       if (upsell.state == &quot;open&quot;) {</span>
<a href="#l11.847"></a><span id="l11.847">         upsell.hidePopup();</span>
<a href="#l11.848"></a><span id="l11.848">         let tabmail = aDocument.getElementById(&quot;tabmail&quot;);</span>
<a href="#l11.849"></a><span id="l11.849">         tabmail.openTab(&quot;glodaFacet&quot;, {</span>
<a href="#l11.850"></a><span id="l11.850" class="difflineminus">-                          searcher: new GlodaMsgSearcher(null, aState.text)</span>
<a href="#l11.851"></a><span id="l11.851" class="difflineplus">+                          searcher: new GlodaMsgSearcher(null, aState.text),</span>
<a href="#l11.852"></a><span id="l11.852">                         });</span>
<a href="#l11.853"></a><span id="l11.853">       }</span>
<a href="#l11.854"></a><span id="l11.854">       return [aState, false];</span>
<a href="#l11.855"></a><span id="l11.855">     }</span>
<a href="#l11.856"></a><span id="l11.856"> </span>
<a href="#l11.857"></a><span id="l11.857">     aState.text = text;</span>
<a href="#l11.858"></a><span id="l11.858">     aDocument.getElementById(&quot;quick-filter-bar-filter-text-bar&quot;).collapsed =</span>
<a href="#l11.859"></a><span id="l11.859">       (text == null);</span>
<a href="#l11.860"></a><span id="l11.860">     return [aState, true];</span>
<a href="#l11.861"></a><span id="l11.861">   },</span>
<a href="#l11.862"></a><span id="l11.862"> </span>
<a href="#l11.863"></a><span id="l11.863" class="difflineminus">-  reflectInDOM: function MessageTextFilter_reflectInDOM(aNode, aFilterValue,</span>
<a href="#l11.864"></a><span id="l11.864" class="difflineminus">-                                                        aDocument, aMuxer,</span>
<a href="#l11.865"></a><span id="l11.865" class="difflineminus">-                                                        aFromPFP) {</span>
<a href="#l11.866"></a><span id="l11.866" class="difflineplus">+  reflectInDOM(aNode, aFilterValue, aDocument, aMuxer, aFromPFP) {</span>
<a href="#l11.867"></a><span id="l11.867">     if (aFromPFP == &quot;nosale&quot;) {</span>
<a href="#l11.868"></a><span id="l11.868">       let panel = aDocument.getElementById(&quot;qfb-text-search-upsell&quot;);</span>
<a href="#l11.869"></a><span id="l11.869">       if (panel.state != &quot;closed&quot;)</span>
<a href="#l11.870"></a><span id="l11.870">         panel.hidePopup();</span>
<a href="#l11.871"></a><span id="l11.871">       return;</span>
<a href="#l11.872"></a><span id="l11.872">     }</span>
<a href="#l11.873"></a><span id="l11.873">     if (aFromPFP == &quot;upsell&quot;) {</span>
<a href="#l11.874"></a><span id="l11.874">       let panel = aDocument.getElementById(&quot;qfb-text-search-upsell&quot;);</span>
<a href="#l11.875"></a><span id="l11.875">       let line1 = aDocument.getElementById(&quot;qfb-upsell-line-one&quot;);</span>
<a href="#l11.876"></a><span id="l11.876">       let line2 = aDocument.getElementById(&quot;qfb-upsell-line-two&quot;);</span>
<a href="#l11.877"></a><span id="l11.877">       line1.value = line1.getAttribute(&quot;fmt&quot;).replace(&quot;#1&quot;, aFilterValue.text);</span>
<a href="#l11.878"></a><span id="l11.878">       line2.value = line2.getAttribute(&quot;fmt&quot;).replace(&quot;#1&quot;, aFilterValue.text);</span>
<a href="#l11.879"></a><span id="l11.879"> </span>
<a href="#l11.880"></a><span id="l11.880">       if (panel.state == &quot;closed&quot; &amp;&amp;</span>
<a href="#l11.881"></a><span id="l11.881">           aDocument.commandDispatcher.focusedElement == aNode.inputField) {</span>
<a href="#l11.882"></a><span id="l11.882">         let filterBar = aDocument.getElementById(&quot;quick-filter-bar&quot;);</span>
<a href="#l11.883"></a><span id="l11.883" class="difflineminus">-        //panel.sizeTo(filterBar.clientWidth - 20, filterBar.clientHeight - 20);</span>
<a href="#l11.884"></a><span id="l11.884" class="difflineplus">+        // panel.sizeTo(filterBar.clientWidth - 20, filterBar.clientHeight - 20);</span>
<a href="#l11.885"></a><span id="l11.885">         panel.openPopup(filterBar, &quot;after_end&quot;, -7, 7, false, true);</span>
<a href="#l11.886"></a><span id="l11.886">       }</span>
<a href="#l11.887"></a><span id="l11.887">       return;</span>
<a href="#l11.888"></a><span id="l11.888">     }</span>
<a href="#l11.889"></a><span id="l11.889"> </span>
<a href="#l11.890"></a><span id="l11.890">     // Make sure we have no visible upsell on state change while our textbox</span>
<a href="#l11.891"></a><span id="l11.891">     //  retains focus.</span>
<a href="#l11.892"></a><span id="l11.892">     let panel = aDocument.getElementById(&quot;qfb-text-search-upsell&quot;);</span>
<a href="#l11.893"></a><span id="l11.893" class="difflineat">@@ -1179,19 +1161,17 @@ var MessageTextFilter = {</span>
<a href="#l11.894"></a><span id="l11.894">     aDocument.getElementById(&quot;quick-filter-bar-filter-text-bar&quot;).collapsed =</span>
<a href="#l11.895"></a><span id="l11.895">       (aFilterValue.text == null);</span>
<a href="#l11.896"></a><span id="l11.896">   },</span>
<a href="#l11.897"></a><span id="l11.897"> </span>
<a href="#l11.898"></a><span id="l11.898">   /**</span>
<a href="#l11.899"></a><span id="l11.899">    * In order to do our upsell we need to know when we are not getting any</span>
<a href="#l11.900"></a><span id="l11.900">    *  results.</span>
<a href="#l11.901"></a><span id="l11.901">    */</span>
<a href="#l11.902"></a><span id="l11.902" class="difflineminus">-  postFilterProcess: function MessageTextFilter_postFilterProcess(aState,</span>
<a href="#l11.903"></a><span id="l11.903" class="difflineminus">-                                                                  aViewWrapper,</span>
<a href="#l11.904"></a><span id="l11.904" class="difflineminus">-                                                                  aFiltering) {</span>
<a href="#l11.905"></a><span id="l11.905" class="difflineplus">+  postFilterProcess(aState, aViewWrapper, aFiltering) {</span>
<a href="#l11.906"></a><span id="l11.906">     // If we're not filtering, not filtering on text, there are results, or</span>
<a href="#l11.907"></a><span id="l11.907">     //  gloda is not enabled so upselling makes no sense, then bail.</span>
<a href="#l11.908"></a><span id="l11.908">     // (Currently we always return &quot;nosale&quot; to make sure our panel is closed;</span>
<a href="#l11.909"></a><span id="l11.909">     //  this might be overkill but unless it becomes a performance problem, it</span>
<a href="#l11.910"></a><span id="l11.910">     //  keeps us safe from weird stuff.)</span>
<a href="#l11.911"></a><span id="l11.911">     if (!aFiltering || !aState.text || aViewWrapper.dbView.numMsgsInView ||</span>
<a href="#l11.912"></a><span id="l11.912">         !GlodaIndexer.enabled)</span>
<a href="#l11.913"></a><span id="l11.913">       return [aState, &quot;nosale&quot;, false];</span>
<a href="#l11.914"></a><span id="l11.914" class="difflineat">@@ -1202,149 +1182,145 @@ var MessageTextFilter = {</span>
<a href="#l11.915"></a><span id="l11.915">   },</span>
<a href="#l11.916"></a><span id="l11.916"> </span>
<a href="#l11.917"></a><span id="l11.917">   /** maps text filter names to whether they are enabled by default (bool)  */</span>
<a href="#l11.918"></a><span id="l11.918">   _defaultStates: {},</span>
<a href="#l11.919"></a><span id="l11.919">   /** maps text filter name to text filter def */</span>
<a href="#l11.920"></a><span id="l11.920">   textFilterDefs: {},</span>
<a href="#l11.921"></a><span id="l11.921">   /** maps dom id to text filter def */</span>
<a href="#l11.922"></a><span id="l11.922">   textFilterDefsByDomId: {},</span>
<a href="#l11.923"></a><span id="l11.923" class="difflineminus">-  defineTextFilter: function MessageTextFilter_defineTextFilter(aTextDef) {</span>
<a href="#l11.924"></a><span id="l11.924" class="difflineplus">+  defineTextFilter(aTextDef) {</span>
<a href="#l11.925"></a><span id="l11.925">     this.textFilterDefs[aTextDef.name] = aTextDef;</span>
<a href="#l11.926"></a><span id="l11.926">     this.textFilterDefsByDomId[aTextDef.domId] = aTextDef;</span>
<a href="#l11.927"></a><span id="l11.927">     if (aTextDef.defaultState)</span>
<a href="#l11.928"></a><span id="l11.928">       this._defaultStates[aTextDef.name] = true;</span>
<a href="#l11.929"></a><span id="l11.929">   },</span>
<a href="#l11.930"></a><span id="l11.930"> };</span>
<a href="#l11.931"></a><span id="l11.931"> // Note that we definitely want this filter defined AFTER the cheap message</span>
<a href="#l11.932"></a><span id="l11.932"> // status filters, so don't reorder this invocation willy nilly.</span>
<a href="#l11.933"></a><span id="l11.933"> QuickFilterManager.defineFilter(MessageTextFilter);</span>
<a href="#l11.934"></a><span id="l11.934"> QuickFilterManager.textBoxDomId = &quot;qfb-qs-textbox&quot;;</span>
<a href="#l11.935"></a><span id="l11.935"> </span>
<a href="#l11.936"></a><span id="l11.936"> MessageTextFilter.defineTextFilter({</span>
<a href="#l11.937"></a><span id="l11.937">   name: &quot;sender&quot;,</span>
<a href="#l11.938"></a><span id="l11.938">   domId: &quot;qfb-qs-sender&quot;,</span>
<a href="#l11.939"></a><span id="l11.939" class="difflineminus">-  attrib: nsMsgSearchAttrib.Sender,</span>
<a href="#l11.940"></a><span id="l11.940" class="difflineplus">+  attrib: Ci.nsMsgSearchAttrib.Sender,</span>
<a href="#l11.941"></a><span id="l11.941">   defaultState: true,</span>
<a href="#l11.942"></a><span id="l11.942"> });</span>
<a href="#l11.943"></a><span id="l11.943"> MessageTextFilter.defineTextFilter({</span>
<a href="#l11.944"></a><span id="l11.944">   name: &quot;recipients&quot;,</span>
<a href="#l11.945"></a><span id="l11.945">   domId: &quot;qfb-qs-recipients&quot;,</span>
<a href="#l11.946"></a><span id="l11.946" class="difflineminus">-  attrib: nsMsgSearchAttrib.ToOrCC,</span>
<a href="#l11.947"></a><span id="l11.947" class="difflineplus">+  attrib: Ci.nsMsgSearchAttrib.ToOrCC,</span>
<a href="#l11.948"></a><span id="l11.948">   defaultState: true,</span>
<a href="#l11.949"></a><span id="l11.949"> });</span>
<a href="#l11.950"></a><span id="l11.950"> MessageTextFilter.defineTextFilter({</span>
<a href="#l11.951"></a><span id="l11.951">   name: &quot;subject&quot;,</span>
<a href="#l11.952"></a><span id="l11.952">   domId: &quot;qfb-qs-subject&quot;,</span>
<a href="#l11.953"></a><span id="l11.953" class="difflineminus">-  attrib: nsMsgSearchAttrib.Subject,</span>
<a href="#l11.954"></a><span id="l11.954" class="difflineplus">+  attrib: Ci.nsMsgSearchAttrib.Subject,</span>
<a href="#l11.955"></a><span id="l11.955">   defaultState: true,</span>
<a href="#l11.956"></a><span id="l11.956"> });</span>
<a href="#l11.957"></a><span id="l11.957"> MessageTextFilter.defineTextFilter({</span>
<a href="#l11.958"></a><span id="l11.958">   name: &quot;body&quot;,</span>
<a href="#l11.959"></a><span id="l11.959">   domId: &quot;qfb-qs-body&quot;,</span>
<a href="#l11.960"></a><span id="l11.960" class="difflineminus">-  attrib: nsMsgSearchAttrib.Body,</span>
<a href="#l11.961"></a><span id="l11.961" class="difflineplus">+  attrib: Ci.nsMsgSearchAttrib.Body,</span>
<a href="#l11.962"></a><span id="l11.962">   defaultState: false,</span>
<a href="#l11.963"></a><span id="l11.963"> });</span>
<a href="#l11.964"></a><span id="l11.964"> </span>
<a href="#l11.965"></a><span id="l11.965"> /**</span>
<a href="#l11.966"></a><span id="l11.966">  * We need to be parameterized by folder/muxer to provide update notifications</span>
<a href="#l11.967"></a><span id="l11.967">  * and this is the cleanest way given the current FolderDisplayWidget assumption</span>
<a href="#l11.968"></a><span id="l11.968">  * that everyone knows the window they are in already.</span>
<a href="#l11.969"></a><span id="l11.969">  */</span>
<a href="#l11.970"></a><span id="l11.970"> function ResultsLabelFolderDisplayListener(aMuxer) {</span>
<a href="#l11.971"></a><span id="l11.971">   this.muxer = aMuxer;</span>
<a href="#l11.972"></a><span id="l11.972"> }</span>
<a href="#l11.973"></a><span id="l11.973"> ResultsLabelFolderDisplayListener.prototype = {</span>
<a href="#l11.974"></a><span id="l11.974" class="difflineminus">-  _update: function ResultsLabelFolderDisplayListener__update(aFolderDisplay) {</span>
<a href="#l11.975"></a><span id="l11.975" class="difflineplus">+  _update(aFolderDisplay) {</span>
<a href="#l11.976"></a><span id="l11.976">     let filterer = aFolderDisplay._tabInfo._ext.quickFilter;</span>
<a href="#l11.977"></a><span id="l11.977">     if (!filterer)</span>
<a href="#l11.978"></a><span id="l11.978">       return;</span>
<a href="#l11.979"></a><span id="l11.979">     let oldCount = (&quot;results&quot; in filterer.filterValues) ?</span>
<a href="#l11.980"></a><span id="l11.980">                      filterer.filterValues.results : null;</span>
<a href="#l11.981"></a><span id="l11.981">     // (we only display the tally when the filter is active; don't change that)</span>
<a href="#l11.982"></a><span id="l11.982">     if (oldCount == null)</span>
<a href="#l11.983"></a><span id="l11.983">       return;</span>
<a href="#l11.984"></a><span id="l11.984">     let newCount = aFolderDisplay.view.dbView.numMsgsInView;</span>
<a href="#l11.985"></a><span id="l11.985">     if (oldCount == newCount)</span>
<a href="#l11.986"></a><span id="l11.986">       return;</span>
<a href="#l11.987"></a><span id="l11.987">     filterer.setFilterValue(&quot;results&quot;, newCount, true);</span>
<a href="#l11.988"></a><span id="l11.988">     if (aFolderDisplay.active)</span>
<a href="#l11.989"></a><span id="l11.989">       this.muxer.reflectFiltererState(filterer, aFolderDisplay, &quot;results&quot;);</span>
<a href="#l11.990"></a><span id="l11.990">   },</span>
<a href="#l11.991"></a><span id="l11.991"> </span>
<a href="#l11.992"></a><span id="l11.992" class="difflineminus">-  //////////////////////////////////////////////////////////////////////////////</span>
<a href="#l11.993"></a><span id="l11.993" class="difflineminus">-  //// FolderDisplayListener</span>
<a href="#l11.994"></a><span id="l11.994" class="difflineplus">+  // ---------------------</span>
<a href="#l11.995"></a><span id="l11.995" class="difflineplus">+  // FolderDisplayListener</span>
<a href="#l11.996"></a><span id="l11.996"> </span>
<a href="#l11.997"></a><span id="l11.997">   // We want to make sure that anything that would change the count of displayed</span>
<a href="#l11.998"></a><span id="l11.998">   //  messages causes us to update our displayed value.</span>
<a href="#l11.999"></a><span id="l11.999"> </span>
<a href="#l11.1000"></a><span id="l11.1000" class="difflineminus">-  onMessageCountsChanged: function(aFolderDisplay) {</span>
<a href="#l11.1001"></a><span id="l11.1001" class="difflineplus">+  onMessageCountsChanged(aFolderDisplay) {</span>
<a href="#l11.1002"></a><span id="l11.1002">     this._update(aFolderDisplay);</span>
<a href="#l11.1003"></a><span id="l11.1003">   },</span>
<a href="#l11.1004"></a><span id="l11.1004"> </span>
<a href="#l11.1005"></a><span id="l11.1005" class="difflineminus">-  onMessagesRemoved: function(aFolderDisplay) {</span>
<a href="#l11.1006"></a><span id="l11.1006" class="difflineplus">+  onMessagesRemoved(aFolderDisplay) {</span>
<a href="#l11.1007"></a><span id="l11.1007">     this._update(aFolderDisplay);</span>
<a href="#l11.1008"></a><span id="l11.1008">   },</span>
<a href="#l11.1009"></a><span id="l11.1009"> };</span>
<a href="#l11.1010"></a><span id="l11.1010"> </span>
<a href="#l11.1011"></a><span id="l11.1011"> /**</span>
<a href="#l11.1012"></a><span id="l11.1012">  * The results label says whether there were any matches and, if so, how many.</span>
<a href="#l11.1013"></a><span id="l11.1013">  */</span>
<a href="#l11.1014"></a><span id="l11.1014"> QuickFilterManager.defineFilter({</span>
<a href="#l11.1015"></a><span id="l11.1015">   name: &quot;results&quot;,</span>
<a href="#l11.1016"></a><span id="l11.1016">   domId: &quot;qfb-results-label&quot;,</span>
<a href="#l11.1017"></a><span id="l11.1017" class="difflineminus">-  appendTerms: function(aTermCreator, aTerms, aFilterValue) {</span>
<a href="#l11.1018"></a><span id="l11.1018" class="difflineplus">+  appendTerms(aTermCreator, aTerms, aFilterValue) {</span>
<a href="#l11.1019"></a><span id="l11.1019">   },</span>
<a href="#l11.1020"></a><span id="l11.1020"> </span>
<a href="#l11.1021"></a><span id="l11.1021">   /**</span>
<a href="#l11.1022"></a><span id="l11.1022">    * Our state is meaningless; we implement this to avoid clearState ever</span>
<a href="#l11.1023"></a><span id="l11.1023">    *  thinking we were a facet.</span>
<a href="#l11.1024"></a><span id="l11.1024">    */</span>
<a href="#l11.1025"></a><span id="l11.1025" class="difflineminus">-  clearState: function(aState) {</span>
<a href="#l11.1026"></a><span id="l11.1026" class="difflineplus">+  clearState(aState) {</span>
<a href="#l11.1027"></a><span id="l11.1027">     return [null, false];</span>
<a href="#l11.1028"></a><span id="l11.1028">   },</span>
<a href="#l11.1029"></a><span id="l11.1029"> </span>
<a href="#l11.1030"></a><span id="l11.1030">   /**</span>
<a href="#l11.1031"></a><span id="l11.1031">    * We never have any state to propagate!</span>
<a href="#l11.1032"></a><span id="l11.1032">    */</span>
<a href="#l11.1033"></a><span id="l11.1033" class="difflineminus">-  propagateState: function(aOld, aSticky) {</span>
<a href="#l11.1034"></a><span id="l11.1034" class="difflineplus">+  propagateState(aOld, aSticky) {</span>
<a href="#l11.1035"></a><span id="l11.1035">     return null;</span>
<a href="#l11.1036"></a><span id="l11.1036">   },</span>
<a href="#l11.1037"></a><span id="l11.1037"> </span>
<a href="#l11.1038"></a><span id="l11.1038">   /**</span>
<a href="#l11.1039"></a><span id="l11.1039">    * Hook us up as a folder display listener so we can get information on when</span>
<a href="#l11.1040"></a><span id="l11.1040">    * the counts change.</span>
<a href="#l11.1041"></a><span id="l11.1041">    */</span>
<a href="#l11.1042"></a><span id="l11.1042" class="difflineminus">-  domBindExtra: function MessageTextFilter_domBind(aDocument, aMuxer, aNode) {</span>
<a href="#l11.1043"></a><span id="l11.1043" class="difflineplus">+  domBindExtra(aDocument, aMuxer, aNode) {</span>
<a href="#l11.1044"></a><span id="l11.1044">     aDocument.defaultView.FolderDisplayListenerManager.registerListener(</span>
<a href="#l11.1045"></a><span id="l11.1045">       new ResultsLabelFolderDisplayListener(aMuxer));</span>
<a href="#l11.1046"></a><span id="l11.1046">   },</span>
<a href="#l11.1047"></a><span id="l11.1047" class="difflineminus">-  reflectInDOM: function MessageTextFilter_reflectInDOM(aNode, aFilterValue,</span>
<a href="#l11.1048"></a><span id="l11.1048" class="difflineminus">-                                                        aDocument) {</span>
<a href="#l11.1049"></a><span id="l11.1049" class="difflineplus">+  reflectInDOM(aNode, aFilterValue, aDocument) {</span>
<a href="#l11.1050"></a><span id="l11.1050">     if (aFilterValue == null) {</span>
<a href="#l11.1051"></a><span id="l11.1051">       aNode.value = &quot;&quot;;</span>
<a href="#l11.1052"></a><span id="l11.1052">       aNode.style.visibility = &quot;hidden&quot;;</span>
<a href="#l11.1053"></a><span id="l11.1053" class="difflineminus">-    }</span>
<a href="#l11.1054"></a><span id="l11.1054" class="difflineminus">-    else if (aFilterValue == 0) {</span>
<a href="#l11.1055"></a><span id="l11.1055" class="difflineplus">+    } else if (aFilterValue == 0) {</span>
<a href="#l11.1056"></a><span id="l11.1056">       aNode.value = aNode.getAttribute(&quot;noresultsstring&quot;);</span>
<a href="#l11.1057"></a><span id="l11.1057">       aNode.style.visibility = &quot;visible&quot;;</span>
<a href="#l11.1058"></a><span id="l11.1058" class="difflineminus">-    }</span>
<a href="#l11.1059"></a><span id="l11.1059" class="difflineminus">-    else {</span>
<a href="#l11.1060"></a><span id="l11.1060" class="difflineplus">+    } else {</span>
<a href="#l11.1061"></a><span id="l11.1061">       let fmtstring = aNode.getAttribute(&quot;somefmtstring&quot;);</span>
<a href="#l11.1062"></a><span id="l11.1062"> </span>
<a href="#l11.1063"></a><span id="l11.1063">       aNode.value = PluralForm.get(aFilterValue, fmtstring)</span>
<a href="#l11.1064"></a><span id="l11.1064">                               .replace(&quot;#1&quot;, aFilterValue.toString());</span>
<a href="#l11.1065"></a><span id="l11.1065">       aNode.style.visibility = &quot;visible&quot;;</span>
<a href="#l11.1066"></a><span id="l11.1066">     }</span>
<a href="#l11.1067"></a><span id="l11.1067">   },</span>
<a href="#l11.1068"></a><span id="l11.1068">   /**</span>
<a href="#l11.1069"></a><span id="l11.1069">    * We slightly abuse the filtering hook to figure out how many messages there</span>
<a href="#l11.1070"></a><span id="l11.1070">    *  are and whether a filter is active.  What makes this reasonable is that</span>
<a href="#l11.1071"></a><span id="l11.1071">    *  a more complicated widget that visualized the results as a timeline would</span>
<a href="#l11.1072"></a><span id="l11.1072">    *  definitely want to be hooked up like this.  (Although they would want</span>
<a href="#l11.1073"></a><span id="l11.1073">    *  to implement propagateState since the state they store would be pretty</span>
<a href="#l11.1074"></a><span id="l11.1074">    *  expensive.)</span>
<a href="#l11.1075"></a><span id="l11.1075">    */</span>
<a href="#l11.1076"></a><span id="l11.1076" class="difflineminus">-  postFilterProcess: function TFF_postFilterProcess(aState, aViewWrapper,</span>
<a href="#l11.1077"></a><span id="l11.1077" class="difflineminus">-                                                    aFiltering) {</span>
<a href="#l11.1078"></a><span id="l11.1078" class="difflineplus">+  postFilterProcess(aState, aViewWrapper, aFiltering) {</span>
<a href="#l11.1079"></a><span id="l11.1079">     return [aFiltering ? aViewWrapper.dbView.numMsgsInView : null, true, false];</span>
<a href="#l11.1080"></a><span id="l11.1080">   },</span>
<a href="#l11.1081"></a><span id="l11.1081"> });</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mail/base/modules/SearchSpec.jsm</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mail/base/modules/SearchSpec.jsm</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -1,26 +1,18 @@</span>
<a href="#l12.4"></a><span id="l12.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l12.5"></a><span id="l12.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l12.6"></a><span id="l12.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l12.7"></a><span id="l12.7"> </span>
<a href="#l12.8"></a><span id="l12.8" class="difflineminus">-this.EXPORTED_SYMBOLS = ['SearchSpec'];</span>
<a href="#l12.9"></a><span id="l12.9" class="difflineplus">+this.EXPORTED_SYMBOLS = [&quot;SearchSpec&quot;];</span>
<a href="#l12.10"></a><span id="l12.10"> </span>
<a href="#l12.11"></a><span id="l12.11" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;);</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineplus">+const { fixIterator } = ChromeUtils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;, null);</span>
<a href="#l12.13"></a><span id="l12.13"> ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l12.14"></a><span id="l12.14"> ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l12.15"></a><span id="l12.15"> </span>
<a href="#l12.16"></a><span id="l12.16" class="difflineminus">-var nsMsgSearchScope = Ci.nsMsgSearchScope;</span>
<a href="#l12.17"></a><span id="l12.17" class="difflineminus">-var nsIMsgSearchTerm = Ci.nsIMsgSearchTerm;</span>
<a href="#l12.18"></a><span id="l12.18" class="difflineminus">-var nsIMsgLocalMailFolder = Ci.nsIMsgLocalMailFolder;</span>
<a href="#l12.19"></a><span id="l12.19" class="difflineminus">-var nsMsgFolderFlags = Ci.nsMsgFolderFlags;</span>
<a href="#l12.20"></a><span id="l12.20" class="difflineminus">-var nsMsgSearchAttrib = Ci.nsMsgSearchAttrib;</span>
<a href="#l12.21"></a><span id="l12.21" class="difflineminus">-</span>
<a href="#l12.22"></a><span id="l12.22" class="difflineminus">-var NS_MSG_SEARCH_INTERRUPTED = 0x00550002;</span>
<a href="#l12.23"></a><span id="l12.23" class="difflineminus">-</span>
<a href="#l12.24"></a><span id="l12.24"> /**</span>
<a href="#l12.25"></a><span id="l12.25">  * Wrapper abstraction around a view's search session.  This is basically a</span>
<a href="#l12.26"></a><span id="l12.26">  *  friend class of FolderDisplayWidget and is privy to some of its internals.</span>
<a href="#l12.27"></a><span id="l12.27">  */</span>
<a href="#l12.28"></a><span id="l12.28"> function SearchSpec(aViewWrapper) {</span>
<a href="#l12.29"></a><span id="l12.29">   this.owner = aViewWrapper;</span>
<a href="#l12.30"></a><span id="l12.30"> </span>
<a href="#l12.31"></a><span id="l12.31">   this._viewTerms = null;</span>
<a href="#l12.32"></a><span id="l12.32" class="difflineat">@@ -32,17 +24,17 @@ function SearchSpec(aViewWrapper) {</span>
<a href="#l12.33"></a><span id="l12.33">   this._listenersRegistered = false;</span>
<a href="#l12.34"></a><span id="l12.34"> </span>
<a href="#l12.35"></a><span id="l12.35">   this._onlineSearch = false;</span>
<a href="#l12.36"></a><span id="l12.36"> }</span>
<a href="#l12.37"></a><span id="l12.37"> SearchSpec.prototype = {</span>
<a href="#l12.38"></a><span id="l12.38">   /**</span>
<a href="#l12.39"></a><span id="l12.39">    * Clone this SearchSpec; intended to be used by DBViewWrapper.clone().</span>
<a href="#l12.40"></a><span id="l12.40">    */</span>
<a href="#l12.41"></a><span id="l12.41" class="difflineminus">-  clone: function SearchSpec_clone(aViewWrapper) {</span>
<a href="#l12.42"></a><span id="l12.42" class="difflineplus">+  clone(aViewWrapper) {</span>
<a href="#l12.43"></a><span id="l12.43">     let doppel = new SearchSpec(aViewWrapper);</span>
<a href="#l12.44"></a><span id="l12.44"> </span>
<a href="#l12.45"></a><span id="l12.45">     // we can just copy the terms since we never mutate them</span>
<a href="#l12.46"></a><span id="l12.46">     doppel._viewTerms = this._viewTerms;</span>
<a href="#l12.47"></a><span id="l12.47">     doppel._virtualFolderTerms = this._virtualFolderTerms;</span>
<a href="#l12.48"></a><span id="l12.48">     doppel._userTerms = this._userTerms;</span>
<a href="#l12.49"></a><span id="l12.49"> </span>
<a href="#l12.50"></a><span id="l12.50">     // _session can stay null</span>
<a href="#l12.51"></a><span id="l12.51" class="difflineat">@@ -83,54 +75,52 @@ SearchSpec.prototype = {</span>
<a href="#l12.52"></a><span id="l12.52">    * (Potentially) add the db view as a search listener and kick off the search.</span>
<a href="#l12.53"></a><span id="l12.53">    *  We only do that if we have search terms.  The intent is to allow you to</span>
<a href="#l12.54"></a><span id="l12.54">    *  call this all the time, even if you don't need to.</span>
<a href="#l12.55"></a><span id="l12.55">    * DBViewWrapper._applyViewChanges used to handle a lot more of this, but our</span>
<a href="#l12.56"></a><span id="l12.56">    *  need to make sure that the session listener gets added after the DBView</span>
<a href="#l12.57"></a><span id="l12.57">    *  caused us to introduce this method.  (We want the DB View's OnDone method</span>
<a href="#l12.58"></a><span id="l12.58">    *  to run before our listener, as it may do important work.)</span>
<a href="#l12.59"></a><span id="l12.59">    */</span>
<a href="#l12.60"></a><span id="l12.60" class="difflineminus">-  associateView: function SearchSpec_associateView(aDBView) {</span>
<a href="#l12.61"></a><span id="l12.61" class="difflineplus">+  associateView(aDBView) {</span>
<a href="#l12.62"></a><span id="l12.62">     if (this.hasSearchTerms) {</span>
<a href="#l12.63"></a><span id="l12.63">       this.updateSession();</span>
<a href="#l12.64"></a><span id="l12.64"> </span>
<a href="#l12.65"></a><span id="l12.65">       if (this.owner.isSynthetic) {</span>
<a href="#l12.66"></a><span id="l12.66">         this.owner._syntheticView.search(new FilteringSyntheticListener(this));</span>
<a href="#l12.67"></a><span id="l12.67" class="difflineminus">-      }</span>
<a href="#l12.68"></a><span id="l12.68" class="difflineminus">-      else {</span>
<a href="#l12.69"></a><span id="l12.69" class="difflineplus">+      } else {</span>
<a href="#l12.70"></a><span id="l12.70">         if (!this._sessionListener)</span>
<a href="#l12.71"></a><span id="l12.71">           this._sessionListener = new SearchSpecListener(this);</span>
<a href="#l12.72"></a><span id="l12.72"> </span>
<a href="#l12.73"></a><span id="l12.73">         this.session.registerListener(aDBView,</span>
<a href="#l12.74"></a><span id="l12.74">                                       Ci.nsIMsgSearchSession.allNotifications);</span>
<a href="#l12.75"></a><span id="l12.75">         aDBView.searchSession = this._session;</span>
<a href="#l12.76"></a><span id="l12.76">         this._session.registerListener(this._sessionListener,</span>
<a href="#l12.77"></a><span id="l12.77">                                        Ci.nsIMsgSearchSession.onNewSearch |</span>
<a href="#l12.78"></a><span id="l12.78">                                        Ci.nsIMsgSearchSession.onSearchDone);</span>
<a href="#l12.79"></a><span id="l12.79">         this._listenersRegistered = true;</span>
<a href="#l12.80"></a><span id="l12.80"> </span>
<a href="#l12.81"></a><span id="l12.81">         this.owner.searching = true;</span>
<a href="#l12.82"></a><span id="l12.82">         this.session.search(this.owner.listener.msgWindow);</span>
<a href="#l12.83"></a><span id="l12.83">       }</span>
<a href="#l12.84"></a><span id="l12.84" class="difflineminus">-    }</span>
<a href="#l12.85"></a><span id="l12.85" class="difflineminus">-    // if it's synthetic but we have no search terms, hook the output of the</span>
<a href="#l12.86"></a><span id="l12.86" class="difflineminus">-    //  synthetic view directly up to the search nsIMsgDBView</span>
<a href="#l12.87"></a><span id="l12.87" class="difflineminus">-    else if (this.owner.isSynthetic) {</span>
<a href="#l12.88"></a><span id="l12.88" class="difflineplus">+    } else if (this.owner.isSynthetic) {</span>
<a href="#l12.89"></a><span id="l12.89" class="difflineplus">+      // If it's synthetic but we have no search terms, hook the output of the</span>
<a href="#l12.90"></a><span id="l12.90" class="difflineplus">+      // synthetic view directly up to the search nsIMsgDBView.</span>
<a href="#l12.91"></a><span id="l12.91">       let owner = this.owner;</span>
<a href="#l12.92"></a><span id="l12.92">       owner.searching = true;</span>
<a href="#l12.93"></a><span id="l12.93">       this.owner._syntheticView.search(</span>
<a href="#l12.94"></a><span id="l12.94">         aDBView.QueryInterface(Ci.nsIMsgSearchNotify),</span>
<a href="#l12.95"></a><span id="l12.95">         function() { owner.searching = false; });</span>
<a href="#l12.96"></a><span id="l12.96">     }</span>
<a href="#l12.97"></a><span id="l12.97">   },</span>
<a href="#l12.98"></a><span id="l12.98">   /**</span>
<a href="#l12.99"></a><span id="l12.99">    * Stop any active search and stop the db view being a search listener (if it</span>
<a href="#l12.100"></a><span id="l12.100">    *  is one).</span>
<a href="#l12.101"></a><span id="l12.101">    */</span>
<a href="#l12.102"></a><span id="l12.102" class="difflineminus">-  dissociateView: function SearchSpec_dissociateView(aDBView) {</span>
<a href="#l12.103"></a><span id="l12.103" class="difflineplus">+  dissociateView(aDBView) {</span>
<a href="#l12.104"></a><span id="l12.104">     // If we are currently searching, interrupt the search.  This will</span>
<a href="#l12.105"></a><span id="l12.105">     //  immediately notify the listeners that the search is done with and</span>
<a href="#l12.106"></a><span id="l12.106">     //  clear the searching flag for us.</span>
<a href="#l12.107"></a><span id="l12.107">     if (this.owner.searching) {</span>
<a href="#l12.108"></a><span id="l12.108">       if (this.owner.isSynthetic)</span>
<a href="#l12.109"></a><span id="l12.109">         this.owner._syntheticView.abortSearch();</span>
<a href="#l12.110"></a><span id="l12.110">       else</span>
<a href="#l12.111"></a><span id="l12.111">         this.session.interruptSearch();</span>
<a href="#l12.112"></a><span id="l12.112" class="difflineat">@@ -146,18 +136,17 @@ SearchSpec.prototype = {</span>
<a href="#l12.113"></a><span id="l12.113"> </span>
<a href="#l12.114"></a><span id="l12.114">   /**</span>
<a href="#l12.115"></a><span id="l12.115">    * Given a list of terms, mutate them so that they form a single boolean</span>
<a href="#l12.116"></a><span id="l12.116">    *  group.</span>
<a href="#l12.117"></a><span id="l12.117">    *</span>
<a href="#l12.118"></a><span id="l12.118">    * @param aTerms The search terms</span>
<a href="#l12.119"></a><span id="l12.119">    * @param aCloneTerms Do we need to clone the terms?</span>
<a href="#l12.120"></a><span id="l12.120">    */</span>
<a href="#l12.121"></a><span id="l12.121" class="difflineminus">-  _flattenGroupifyTerms: function SearchSpec__flattenGroupifyTerms(aTerms,</span>
<a href="#l12.122"></a><span id="l12.122" class="difflineminus">-                                                                   aCloneTerms){</span>
<a href="#l12.123"></a><span id="l12.123" class="difflineplus">+  _flattenGroupifyTerms(aTerms, aCloneTerms) {</span>
<a href="#l12.124"></a><span id="l12.124">     let iTerm = 0, term;</span>
<a href="#l12.125"></a><span id="l12.125">     let outTerms = aCloneTerms ? [] : aTerms;</span>
<a href="#l12.126"></a><span id="l12.126">     for (term of fixIterator(aTerms, Ci.nsIMsgSearchTerm)) {</span>
<a href="#l12.127"></a><span id="l12.127">       if (aCloneTerms) {</span>
<a href="#l12.128"></a><span id="l12.128">         let cloneTerm = this.session.createTerm();</span>
<a href="#l12.129"></a><span id="l12.129">         cloneTerm.value = term.value;</span>
<a href="#l12.130"></a><span id="l12.130">         cloneTerm.attrib = term.attrib;</span>
<a href="#l12.131"></a><span id="l12.131">         cloneTerm.arbitraryHeader = term.arbitraryHeader;</span>
<a href="#l12.132"></a><span id="l12.132" class="difflineat">@@ -168,18 +157,17 @@ SearchSpec.prototype = {</span>
<a href="#l12.133"></a><span id="l12.133">         cloneTerm.matchAll = term.matchAll;</span>
<a href="#l12.134"></a><span id="l12.134">         term = cloneTerm;</span>
<a href="#l12.135"></a><span id="l12.135">         outTerms.push(term);</span>
<a href="#l12.136"></a><span id="l12.136">       }</span>
<a href="#l12.137"></a><span id="l12.137">       if (iTerm == 0) {</span>
<a href="#l12.138"></a><span id="l12.138">         term.beginsGrouping = true;</span>
<a href="#l12.139"></a><span id="l12.139">         term.endsGrouping = false;</span>
<a href="#l12.140"></a><span id="l12.140">         term.booleanAnd = true;</span>
<a href="#l12.141"></a><span id="l12.141" class="difflineminus">-      }</span>
<a href="#l12.142"></a><span id="l12.142" class="difflineminus">-      else {</span>
<a href="#l12.143"></a><span id="l12.143" class="difflineplus">+      } else {</span>
<a href="#l12.144"></a><span id="l12.144">         term.beginsGrouping = false;</span>
<a href="#l12.145"></a><span id="l12.145">         term.endsGrouping = false;</span>
<a href="#l12.146"></a><span id="l12.146">       }</span>
<a href="#l12.147"></a><span id="l12.147">       iTerm++;</span>
<a href="#l12.148"></a><span id="l12.148">     }</span>
<a href="#l12.149"></a><span id="l12.149">     if (term)</span>
<a href="#l12.150"></a><span id="l12.150">       term.endsGrouping = true;</span>
<a href="#l12.151"></a><span id="l12.151"> </span>
<a href="#l12.152"></a><span id="l12.152" class="difflineat">@@ -193,32 +181,31 @@ SearchSpec.prototype = {</span>
<a href="#l12.153"></a><span id="l12.153">    *  a single group, maintaining the booleanAnd state of terms.</span>
<a href="#l12.154"></a><span id="l12.154">    *</span>
<a href="#l12.155"></a><span id="l12.155">    * This particular logic is desired because it allows the quick filter bar to</span>
<a href="#l12.156"></a><span id="l12.156">    *  produce interesting and useful filters.</span>
<a href="#l12.157"></a><span id="l12.157">    *</span>
<a href="#l12.158"></a><span id="l12.158">    * @param aTerms The search terms</span>
<a href="#l12.159"></a><span id="l12.159">    * @param aCloneTerms Do we need to clone the terms?</span>
<a href="#l12.160"></a><span id="l12.160">    */</span>
<a href="#l12.161"></a><span id="l12.161" class="difflineminus">-  _groupifyTerms: function SearchSpec__groupifyTerms(aTerms, aCloneTerms) {</span>
<a href="#l12.162"></a><span id="l12.162" class="difflineplus">+  _groupifyTerms(aTerms, aCloneTerms) {</span>
<a href="#l12.163"></a><span id="l12.163">     let term;</span>
<a href="#l12.164"></a><span id="l12.164">     let outTerms = aCloneTerms ? [] : aTerms;</span>
<a href="#l12.165"></a><span id="l12.165">     let inGroup = false;</span>
<a href="#l12.166"></a><span id="l12.166">     for (term of fixIterator(aTerms, Ci.nsIMsgSearchTerm)) {</span>
<a href="#l12.167"></a><span id="l12.167">       // If we're in a group, all that is forbidden is the creation of new</span>
<a href="#l12.168"></a><span id="l12.168">       // groups.</span>
<a href="#l12.169"></a><span id="l12.169">       if (inGroup) {</span>
<a href="#l12.170"></a><span id="l12.170">         if (term.beginsGrouping) // forbidden!</span>
<a href="#l12.171"></a><span id="l12.171">           return this._flattenGroupifyTerms(aTerms, aCloneTerms);</span>
<a href="#l12.172"></a><span id="l12.172">         else if (term.endsGrouping)</span>
<a href="#l12.173"></a><span id="l12.173">           inGroup = false;</span>
<a href="#l12.174"></a><span id="l12.174" class="difflineminus">-      }</span>
<a href="#l12.175"></a><span id="l12.175" class="difflineminus">-      // If we're not in a group, the boolean must be AND.  It's okay for a group</span>
<a href="#l12.176"></a><span id="l12.176" class="difflineminus">-      // to start.</span>
<a href="#l12.177"></a><span id="l12.177" class="difflineminus">-      else {</span>
<a href="#l12.178"></a><span id="l12.178" class="difflineplus">+      } else {</span>
<a href="#l12.179"></a><span id="l12.179" class="difflineplus">+        // If we're not in a group, the boolean must be AND.  It's okay for a group</span>
<a href="#l12.180"></a><span id="l12.180" class="difflineplus">+        // to start.</span>
<a href="#l12.181"></a><span id="l12.181">         // If it's not an AND then it needs to be in a group and we use the other</span>
<a href="#l12.182"></a><span id="l12.182">         //  function to take care of it.  (This function can't back up...)</span>
<a href="#l12.183"></a><span id="l12.183">         if (!term.booleanAnd)</span>
<a href="#l12.184"></a><span id="l12.184">           return this._flattenGroupifyTerms(aTerms, aCloneTerms);</span>
<a href="#l12.185"></a><span id="l12.185"> </span>
<a href="#l12.186"></a><span id="l12.186">         inGroup = term.beginsGrouping;</span>
<a href="#l12.187"></a><span id="l12.187">       }</span>
<a href="#l12.188"></a><span id="l12.188"> </span>
<a href="#l12.189"></a><span id="l12.189" class="difflineat">@@ -312,17 +299,17 @@ SearchSpec.prototype = {</span>
<a href="#l12.190"></a><span id="l12.190">   /**</span>
<a href="#l12.191"></a><span id="l12.191">    * @return the user terms currently in effect as set via the |userTerms|</span>
<a href="#l12.192"></a><span id="l12.192">    *     attribute or via the |quickSearch| method.  Do not mutate this.</span>
<a href="#l12.193"></a><span id="l12.193">    */</span>
<a href="#l12.194"></a><span id="l12.194">   get userTerms() {</span>
<a href="#l12.195"></a><span id="l12.195">     return this._userTerms;</span>
<a href="#l12.196"></a><span id="l12.196">   },</span>
<a href="#l12.197"></a><span id="l12.197"> </span>
<a href="#l12.198"></a><span id="l12.198" class="difflineminus">-  clear: function SearchSpec_clear() {</span>
<a href="#l12.199"></a><span id="l12.199" class="difflineplus">+  clear() {</span>
<a href="#l12.200"></a><span id="l12.200">     if (this.hasSearchTerms) {</span>
<a href="#l12.201"></a><span id="l12.201">       this._viewTerms = null;</span>
<a href="#l12.202"></a><span id="l12.202">       this._virtualFolderTerms = null;</span>
<a href="#l12.203"></a><span id="l12.203">       this._userTerms = null;</span>
<a href="#l12.204"></a><span id="l12.204">       this.owner._applyViewChanges();</span>
<a href="#l12.205"></a><span id="l12.205">     }</span>
<a href="#l12.206"></a><span id="l12.206">   },</span>
<a href="#l12.207"></a><span id="l12.207"> </span>
<a href="#l12.208"></a><span id="l12.208" class="difflineat">@@ -347,107 +334,94 @@ SearchSpec.prototype = {</span>
<a href="#l12.209"></a><span id="l12.209">   },</span>
<a href="#l12.210"></a><span id="l12.210"> </span>
<a href="#l12.211"></a><span id="l12.211">   /**</span>
<a href="#l12.212"></a><span id="l12.212">    * Populate the search session using viewTerms, virtualFolderTerms, and</span>
<a href="#l12.213"></a><span id="l12.213">    *  userTerms.  The way this works is that each of the 'context' sets of</span>
<a href="#l12.214"></a><span id="l12.214">    *  terms gets wrapped into a group which is boolean anded together with</span>
<a href="#l12.215"></a><span id="l12.215">    *  everything else.</span>
<a href="#l12.216"></a><span id="l12.216">    */</span>
<a href="#l12.217"></a><span id="l12.217" class="difflineminus">-  updateSession: function SearchSpec_applySearch() {</span>
<a href="#l12.218"></a><span id="l12.218" class="difflineplus">+  updateSession() {</span>
<a href="#l12.219"></a><span id="l12.219">     let session = this.session;</span>
<a href="#l12.220"></a><span id="l12.220"> </span>
<a href="#l12.221"></a><span id="l12.221">     // clear out our current terms and scope</span>
<a href="#l12.222"></a><span id="l12.222">     session.searchTerms.clear();</span>
<a href="#l12.223"></a><span id="l12.223">     session.clearScopes();</span>
<a href="#l12.224"></a><span id="l12.224"> </span>
<a href="#l12.225"></a><span id="l12.225" class="difflineminus">-    // the scope logic needs to know if any terms look at the body attribute.</span>
<a href="#l12.226"></a><span id="l12.226" class="difflineminus">-    let haveBodyTerm = false;</span>
<a href="#l12.227"></a><span id="l12.227" class="difflineminus">-</span>
<a href="#l12.228"></a><span id="l12.228">     // -- apply terms</span>
<a href="#l12.229"></a><span id="l12.229">     if (this._virtualFolderTerms) {</span>
<a href="#l12.230"></a><span id="l12.230" class="difflineminus">-      for (let term of fixIterator(this._virtualFolderTerms,</span>
<a href="#l12.231"></a><span id="l12.231" class="difflineminus">-                                   nsIMsgSearchTerm)) {</span>
<a href="#l12.232"></a><span id="l12.232" class="difflineminus">-        if (term.attrib == nsMsgSearchAttrib.Body)</span>
<a href="#l12.233"></a><span id="l12.233" class="difflineminus">-          haveBodyTerm = true;</span>
<a href="#l12.234"></a><span id="l12.234" class="difflineplus">+      for (let term of fixIterator(this._virtualFolderTerms, Ci.nsIMsgSearchTerm)) {</span>
<a href="#l12.235"></a><span id="l12.235">         session.appendTerm(term);</span>
<a href="#l12.236"></a><span id="l12.236">       }</span>
<a href="#l12.237"></a><span id="l12.237">     }</span>
<a href="#l12.238"></a><span id="l12.238"> </span>
<a href="#l12.239"></a><span id="l12.239">     if (this._viewTerms) {</span>
<a href="#l12.240"></a><span id="l12.240" class="difflineminus">-      for (let term of fixIterator(this._viewTerms,</span>
<a href="#l12.241"></a><span id="l12.241" class="difflineminus">-                                   nsIMsgSearchTerm)) {</span>
<a href="#l12.242"></a><span id="l12.242" class="difflineminus">-        if (term.attrib == nsMsgSearchAttrib.Body)</span>
<a href="#l12.243"></a><span id="l12.243" class="difflineminus">-          haveBodyTerm = true;</span>
<a href="#l12.244"></a><span id="l12.244" class="difflineplus">+      for (let term of fixIterator(this._viewTerms, Ci.nsIMsgSearchTerm)) {</span>
<a href="#l12.245"></a><span id="l12.245">         session.appendTerm(term);</span>
<a href="#l12.246"></a><span id="l12.246">       }</span>
<a href="#l12.247"></a><span id="l12.247">     }</span>
<a href="#l12.248"></a><span id="l12.248"> </span>
<a href="#l12.249"></a><span id="l12.249">     if (this._userTerms) {</span>
<a href="#l12.250"></a><span id="l12.250" class="difflineminus">-      for (let term of fixIterator(this._userTerms,</span>
<a href="#l12.251"></a><span id="l12.251" class="difflineminus">-                                   nsIMsgSearchTerm)) {</span>
<a href="#l12.252"></a><span id="l12.252" class="difflineminus">-        if (term.attrib == nsMsgSearchAttrib.Body)</span>
<a href="#l12.253"></a><span id="l12.253" class="difflineminus">-          haveBodyTerm = true;</span>
<a href="#l12.254"></a><span id="l12.254" class="difflineplus">+      for (let term of fixIterator(this._userTerms, Ci.nsIMsgSearchTerm)) {</span>
<a href="#l12.255"></a><span id="l12.255">         session.appendTerm(term);</span>
<a href="#l12.256"></a><span id="l12.256">       }</span>
<a href="#l12.257"></a><span id="l12.257">     }</span>
<a href="#l12.258"></a><span id="l12.258"> </span>
<a href="#l12.259"></a><span id="l12.259">     // -- apply scopes</span>
<a href="#l12.260"></a><span id="l12.260">     // If it is a synthetic view, create a single bogus scope so that we can use</span>
<a href="#l12.261"></a><span id="l12.261">     //  MatchHdr.</span>
<a href="#l12.262"></a><span id="l12.262">     if (this.owner.isSynthetic) {</span>
<a href="#l12.263"></a><span id="l12.263">       // We don't want to pass in a folder, and we don't want to use the</span>
<a href="#l12.264"></a><span id="l12.264">       //  allSearchableGroups scope, so we cheat and use AddDirectoryScopeTerm.</span>
<a href="#l12.265"></a><span id="l12.265" class="difflineminus">-      session.addDirectoryScopeTerm(nsMsgSearchScope.offlineMail);</span>
<a href="#l12.266"></a><span id="l12.266" class="difflineplus">+      session.addDirectoryScopeTerm(Ci.nsMsgSearchScope.offlineMail);</span>
<a href="#l12.267"></a><span id="l12.267">       return;</span>
<a href="#l12.268"></a><span id="l12.268">     }</span>
<a href="#l12.269"></a><span id="l12.269"> </span>
<a href="#l12.270"></a><span id="l12.270">     let filtering = this._userTerms != null || this._viewTerms != null;</span>
<a href="#l12.271"></a><span id="l12.271" class="difflineminus">-    let validityManager = Cc['@mozilla.org/mail/search/validityManager;1']</span>
<a href="#l12.272"></a><span id="l12.272" class="difflineplus">+    let validityManager = Cc[&quot;@mozilla.org/mail/search/validityManager;1&quot;]</span>
<a href="#l12.273"></a><span id="l12.273">                             .getService(Ci.nsIMsgSearchValidityManager);</span>
<a href="#l12.274"></a><span id="l12.274">     for (let folder of this.owner._underlyingFolders) {</span>
<a href="#l12.275"></a><span id="l12.275">       // we do not need to check isServer here because _underlyingFolders</span>
<a href="#l12.276"></a><span id="l12.276">       //  filtered it out when it was initialized.</span>
<a href="#l12.277"></a><span id="l12.277"> </span>
<a href="#l12.278"></a><span id="l12.278">       let scope;</span>
<a href="#l12.279"></a><span id="l12.279">       let serverScope = folder.server.searchScope;</span>
<a href="#l12.280"></a><span id="l12.280">       // If we're offline, or this is a local folder, or there's no separate</span>
<a href="#l12.281"></a><span id="l12.281">       //  online scope, use server scope.</span>
<a href="#l12.282"></a><span id="l12.282" class="difflineminus">-      if (Services.io.offline || (serverScope == nsMsgSearchScope.offlineMail) ||</span>
<a href="#l12.283"></a><span id="l12.283" class="difflineminus">-                                 (folder instanceof nsIMsgLocalMailFolder))</span>
<a href="#l12.284"></a><span id="l12.284" class="difflineplus">+      if (Services.io.offline || (serverScope == Ci.nsMsgSearchScope.offlineMail) ||</span>
<a href="#l12.285"></a><span id="l12.285" class="difflineplus">+                                 (folder instanceof Ci.nsIMsgLocalMailFolder)) {</span>
<a href="#l12.286"></a><span id="l12.286">         scope = serverScope;</span>
<a href="#l12.287"></a><span id="l12.287" class="difflineminus">-      else {</span>
<a href="#l12.288"></a><span id="l12.288" class="difflineplus">+      } else {</span>
<a href="#l12.289"></a><span id="l12.289">         // we need to test the validity in online and offline tables</span>
<a href="#l12.290"></a><span id="l12.290">         let onlineValidityTable = validityManager.getTable(serverScope);</span>
<a href="#l12.291"></a><span id="l12.291"> </span>
<a href="#l12.292"></a><span id="l12.292">         let offlineScope;</span>
<a href="#l12.293"></a><span id="l12.293" class="difflineminus">-        if (folder.flags &amp; nsMsgFolderFlags.Offline)</span>
<a href="#l12.294"></a><span id="l12.294" class="difflineminus">-          offlineScope = nsMsgSearchScope.offlineMail;</span>
<a href="#l12.295"></a><span id="l12.295" class="difflineplus">+        if (folder.flags &amp; Ci.nsMsgFolderFlags.Offline)</span>
<a href="#l12.296"></a><span id="l12.296" class="difflineplus">+          offlineScope = Ci.nsMsgSearchScope.offlineMail;</span>
<a href="#l12.297"></a><span id="l12.297">         else</span>
<a href="#l12.298"></a><span id="l12.298">           // The onlineManual table is used for local search when there is no</span>
<a href="#l12.299"></a><span id="l12.299">           //  body available.</span>
<a href="#l12.300"></a><span id="l12.300" class="difflineminus">-          offlineScope = nsMsgSearchScope.onlineManual;</span>
<a href="#l12.301"></a><span id="l12.301" class="difflineplus">+          offlineScope = Ci.nsMsgSearchScope.onlineManual;</span>
<a href="#l12.302"></a><span id="l12.302"> </span>
<a href="#l12.303"></a><span id="l12.303">         let offlineValidityTable = validityManager.getTable(offlineScope);</span>
<a href="#l12.304"></a><span id="l12.304">         let offlineAvailable = true;</span>
<a href="#l12.305"></a><span id="l12.305">         let onlineAvailable = true;</span>
<a href="#l12.306"></a><span id="l12.306">         for (let term of fixIterator(session.searchTerms,</span>
<a href="#l12.307"></a><span id="l12.307" class="difflineminus">-                                     nsIMsgSearchTerm)) {</span>
<a href="#l12.308"></a><span id="l12.308" class="difflineplus">+                                     Ci.nsIMsgSearchTerm)) {</span>
<a href="#l12.309"></a><span id="l12.309">           if (!term.matchAll) {</span>
<a href="#l12.310"></a><span id="l12.310">             // for custom terms, we need to getAvailable from the custom term</span>
<a href="#l12.311"></a><span id="l12.311">             if (term.attrib == Ci.nsMsgSearchAttrib.Custom) {</span>
<a href="#l12.312"></a><span id="l12.312">               let customTerm = MailServices.filters.getCustomTerm(term.customId);</span>
<a href="#l12.313"></a><span id="l12.313">               if (customTerm) {</span>
<a href="#l12.314"></a><span id="l12.314">                 offlineAvailable = customTerm.getAvailable(offlineScope, term.op);</span>
<a href="#l12.315"></a><span id="l12.315">                 onlineAvailable = customTerm.getAvailable(serverScope, term.op);</span>
<a href="#l12.316"></a><span id="l12.316" class="difflineminus">-              }</span>
<a href="#l12.317"></a><span id="l12.317" class="difflineminus">-              else // maybe an extension with a custom term was unloaded?</span>
<a href="#l12.318"></a><span id="l12.318" class="difflineplus">+              } else { // maybe an extension with a custom term was unloaded?</span>
<a href="#l12.319"></a><span id="l12.319">                 Cu.reportError(&quot;Custom search term &quot; + term.customId + &quot; missing&quot;);</span>
<a href="#l12.320"></a><span id="l12.320" class="difflineminus">-            }</span>
<a href="#l12.321"></a><span id="l12.321" class="difflineminus">-            else {</span>
<a href="#l12.322"></a><span id="l12.322" class="difflineplus">+              }</span>
<a href="#l12.323"></a><span id="l12.323" class="difflineplus">+            } else {</span>
<a href="#l12.324"></a><span id="l12.324">               if (!offlineValidityTable.getAvailable(term.attrib, term.op))</span>
<a href="#l12.325"></a><span id="l12.325">                 offlineAvailable = false;</span>
<a href="#l12.326"></a><span id="l12.326">               if (!onlineValidityTable.getAvailable(term.attrib, term.op))</span>
<a href="#l12.327"></a><span id="l12.327">                 onlineAvailable = false;</span>
<a href="#l12.328"></a><span id="l12.328">             }</span>
<a href="#l12.329"></a><span id="l12.329">           }</span>
<a href="#l12.330"></a><span id="l12.330">         }</span>
<a href="#l12.331"></a><span id="l12.331">         // If both scopes work, honor the onlineSearch request, unless we're</span>
<a href="#l12.332"></a><span id="l12.332" class="difflineat">@@ -459,67 +433,67 @@ SearchSpec.prototype = {</span>
<a href="#l12.333"></a><span id="l12.333">           scope = serverScope;</span>
<a href="#l12.334"></a><span id="l12.334">         else</span>
<a href="#l12.335"></a><span id="l12.335">           scope = offlineScope;</span>
<a href="#l12.336"></a><span id="l12.336">       }</span>
<a href="#l12.337"></a><span id="l12.337">       session.addScopeTerm(scope, folder);</span>
<a href="#l12.338"></a><span id="l12.338">     }</span>
<a href="#l12.339"></a><span id="l12.339">   },</span>
<a href="#l12.340"></a><span id="l12.340"> </span>
<a href="#l12.341"></a><span id="l12.341" class="difflineminus">-  prettyStringOfSearchTerms: function(aSearchTerms) {</span>
<a href="#l12.342"></a><span id="l12.342" class="difflineplus">+  prettyStringOfSearchTerms(aSearchTerms) {</span>
<a href="#l12.343"></a><span id="l12.343">     if (aSearchTerms == null)</span>
<a href="#l12.344"></a><span id="l12.344" class="difflineminus">-      return '      (none)\n';</span>
<a href="#l12.345"></a><span id="l12.345" class="difflineplus">+      return &quot;      (none)\n&quot;;</span>
<a href="#l12.346"></a><span id="l12.346"> </span>
<a href="#l12.347"></a><span id="l12.347" class="difflineminus">-    let s = '';</span>
<a href="#l12.348"></a><span id="l12.348" class="difflineplus">+    let s = &quot;&quot;;</span>
<a href="#l12.349"></a><span id="l12.349"> </span>
<a href="#l12.350"></a><span id="l12.350" class="difflineminus">-    for (let term of fixIterator(aSearchTerms, nsIMsgSearchTerm)) {</span>
<a href="#l12.351"></a><span id="l12.351" class="difflineminus">-      s += '      ' + term.termAsString + '\n';</span>
<a href="#l12.352"></a><span id="l12.352" class="difflineplus">+    for (let term of fixIterator(aSearchTerms, Ci.nsIMsgSearchTerm)) {</span>
<a href="#l12.353"></a><span id="l12.353" class="difflineplus">+      s += &quot;      &quot; + term.termAsString + &quot;\n&quot;;</span>
<a href="#l12.354"></a><span id="l12.354">     }</span>
<a href="#l12.355"></a><span id="l12.355"> </span>
<a href="#l12.356"></a><span id="l12.356">     return s;</span>
<a href="#l12.357"></a><span id="l12.357">   },</span>
<a href="#l12.358"></a><span id="l12.358"> </span>
<a href="#l12.359"></a><span id="l12.359" class="difflineminus">-  prettyString: function() {</span>
<a href="#l12.360"></a><span id="l12.360" class="difflineminus">-    let s = '  Search Terms:\n';</span>
<a href="#l12.361"></a><span id="l12.361" class="difflineminus">-    s += '    Virtual Folder Terms:\n';</span>
<a href="#l12.362"></a><span id="l12.362" class="difflineplus">+  prettyString() {</span>
<a href="#l12.363"></a><span id="l12.363" class="difflineplus">+    let s = &quot;  Search Terms:\n&quot;;</span>
<a href="#l12.364"></a><span id="l12.364" class="difflineplus">+    s += &quot;    Virtual Folder Terms:\n&quot;;</span>
<a href="#l12.365"></a><span id="l12.365">     s += this.prettyStringOfSearchTerms(this._virtualFolderTerms);</span>
<a href="#l12.366"></a><span id="l12.366" class="difflineminus">-    s += '    View Terms:\n';</span>
<a href="#l12.367"></a><span id="l12.367" class="difflineplus">+    s += &quot;    View Terms:\n&quot;;</span>
<a href="#l12.368"></a><span id="l12.368">     s += this.prettyStringOfSearchTerms(this._viewTerms);</span>
<a href="#l12.369"></a><span id="l12.369" class="difflineminus">-    s += '    User Terms:\n';</span>
<a href="#l12.370"></a><span id="l12.370" class="difflineplus">+    s += &quot;    User Terms:\n&quot;;</span>
<a href="#l12.371"></a><span id="l12.371">     s += this.prettyStringOfSearchTerms(this._userTerms);</span>
<a href="#l12.372"></a><span id="l12.372" class="difflineminus">-    s += '    Scope (Folders):\n';</span>
<a href="#l12.373"></a><span id="l12.373" class="difflineplus">+    s += &quot;    Scope (Folders):\n&quot;;</span>
<a href="#l12.374"></a><span id="l12.374">     for (let folder of this.owner._underlyingFolders) {</span>
<a href="#l12.375"></a><span id="l12.375" class="difflineminus">-      s += '      ' + folder.prettyName + '\n';</span>
<a href="#l12.376"></a><span id="l12.376" class="difflineplus">+      s += &quot;      &quot; + folder.prettyName + &quot;\n&quot;;</span>
<a href="#l12.377"></a><span id="l12.377">     }</span>
<a href="#l12.378"></a><span id="l12.378">     return s;</span>
<a href="#l12.379"></a><span id="l12.379">   },</span>
<a href="#l12.380"></a><span id="l12.380"> };</span>
<a href="#l12.381"></a><span id="l12.381"> </span>
<a href="#l12.382"></a><span id="l12.382"> /**</span>
<a href="#l12.383"></a><span id="l12.383">  * A simple nsIMsgSearchNotify listener that only listens for search start/stop</span>
<a href="#l12.384"></a><span id="l12.384">  *  so that it can tell the DBViewWrapper when the search has completed.</span>
<a href="#l12.385"></a><span id="l12.385">  */</span>
<a href="#l12.386"></a><span id="l12.386"> function SearchSpecListener(aSearchSpec) {</span>
<a href="#l12.387"></a><span id="l12.387">   this.searchSpec = aSearchSpec;</span>
<a href="#l12.388"></a><span id="l12.388"> }</span>
<a href="#l12.389"></a><span id="l12.389"> SearchSpecListener.prototype = {</span>
<a href="#l12.390"></a><span id="l12.390" class="difflineminus">-  onNewSearch: function SearchSpecListener_onNewSearch() {</span>
<a href="#l12.391"></a><span id="l12.391" class="difflineplus">+  onNewSearch() {</span>
<a href="#l12.392"></a><span id="l12.392">     // searching should already be true by the time this happens.  if it's not,</span>
<a href="#l12.393"></a><span id="l12.393">     //  it means some code is poking at the search session.  bad!</span>
<a href="#l12.394"></a><span id="l12.394">     if (!this.searchSpec.owner.searching) {</span>
<a href="#l12.395"></a><span id="l12.395">       Cu.reportErrror(&quot;Search originated from unknown initiator! Confusion!&quot;);</span>
<a href="#l12.396"></a><span id="l12.396">       this.searchSpec.owner.searching = true;</span>
<a href="#l12.397"></a><span id="l12.397">     }</span>
<a href="#l12.398"></a><span id="l12.398">   },</span>
<a href="#l12.399"></a><span id="l12.399"> </span>
<a href="#l12.400"></a><span id="l12.400" class="difflineminus">-  onSearchHit: function SearchSpecListener_onSearchHit(aMsgHdr, aFolder) {</span>
<a href="#l12.401"></a><span id="l12.401" class="difflineplus">+  onSearchHit(aMsgHdr, aFolder) {</span>
<a href="#l12.402"></a><span id="l12.402">     // this method is never invoked!</span>
<a href="#l12.403"></a><span id="l12.403">   },</span>
<a href="#l12.404"></a><span id="l12.404"> </span>
<a href="#l12.405"></a><span id="l12.405" class="difflineminus">-  onSearchDone: function SearchSpecListener_onSearchDone(aStatus) {</span>
<a href="#l12.406"></a><span id="l12.406" class="difflineplus">+  onSearchDone(aStatus) {</span>
<a href="#l12.407"></a><span id="l12.407">     this.searchSpec.owner.searching = false;</span>
<a href="#l12.408"></a><span id="l12.408">   },</span>
<a href="#l12.409"></a><span id="l12.409"> };</span>
<a href="#l12.410"></a><span id="l12.410"> </span>
<a href="#l12.411"></a><span id="l12.411"> /**</span>
<a href="#l12.412"></a><span id="l12.412">  * Pretend to implement the nsIMsgSearchNotify interface, checking all matches</span>
<a href="#l12.413"></a><span id="l12.413">  *  we are given against the search session on the search spec.  If they pass,</span>
<a href="#l12.414"></a><span id="l12.414">  *  relay them to the underlying db view, otherwise quietly eat them.</span>
<a href="#l12.415"></a><span id="l12.415" class="difflineat">@@ -528,25 +502,24 @@ SearchSpecListener.prototype = {</span>
<a href="#l12.416"></a><span id="l12.416">  */</span>
<a href="#l12.417"></a><span id="l12.417"> function FilteringSyntheticListener(aSearchSpec) {</span>
<a href="#l12.418"></a><span id="l12.418">   this.searchSpec = aSearchSpec;</span>
<a href="#l12.419"></a><span id="l12.419">   this.session = this.searchSpec.session;</span>
<a href="#l12.420"></a><span id="l12.420">   this.dbView =</span>
<a href="#l12.421"></a><span id="l12.421">     this.searchSpec.owner.dbView.QueryInterface(Ci.nsIMsgSearchNotify);</span>
<a href="#l12.422"></a><span id="l12.422"> }</span>
<a href="#l12.423"></a><span id="l12.423"> FilteringSyntheticListener.prototype = {</span>
<a href="#l12.424"></a><span id="l12.424" class="difflineminus">-  onNewSearch: function FilteringSyntheticListener_onNewSearch() {</span>
<a href="#l12.425"></a><span id="l12.425" class="difflineplus">+  onNewSearch() {</span>
<a href="#l12.426"></a><span id="l12.426">     this.searchSpec.owner.searching = true;</span>
<a href="#l12.427"></a><span id="l12.427">     this.dbView.onNewSearch();</span>
<a href="#l12.428"></a><span id="l12.428">   },</span>
<a href="#l12.429"></a><span id="l12.429" class="difflineminus">-  onSearchHit:</span>
<a href="#l12.430"></a><span id="l12.430" class="difflineminus">-      function FilteringSyntheticListener_onSearchHit(aMsgHdr, aFolder) {</span>
<a href="#l12.431"></a><span id="l12.431" class="difflineplus">+  onSearchHit(aMsgHdr, aFolder) {</span>
<a href="#l12.432"></a><span id="l12.432">     // We don't need to worry about msgDatabase opening the database.</span>
<a href="#l12.433"></a><span id="l12.433">     // It is (obviously) already open, and presumably gloda is already on the</span>
<a href="#l12.434"></a><span id="l12.434">     //  hook to perform the cleanup (assuming gloda is backing this search).</span>
<a href="#l12.435"></a><span id="l12.435">     if (this.session.MatchHdr(aMsgHdr, aFolder.msgDatabase))</span>
<a href="#l12.436"></a><span id="l12.436">       this.dbView.onSearchHit(aMsgHdr, aFolder);</span>
<a href="#l12.437"></a><span id="l12.437">   },</span>
<a href="#l12.438"></a><span id="l12.438" class="difflineminus">-  onSearchDone: function FilteringSyntheticListener_OnSearchDone(aStatus) {</span>
<a href="#l12.439"></a><span id="l12.439" class="difflineplus">+  onSearchDone(aStatus) {</span>
<a href="#l12.440"></a><span id="l12.440">     this.searchSpec.owner.searching = false;</span>
<a href="#l12.441"></a><span id="l12.441">     this.dbView.onSearchDone(aStatus);</span>
<a href="#l12.442"></a><span id="l12.442" class="difflineminus">-  }</span>
<a href="#l12.443"></a><span id="l12.443" class="difflineplus">+  },</span>
<a href="#l12.444"></a><span id="l12.444"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mail/base/modules/SessionStoreManager.jsm</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mail/base/modules/SessionStoreManager.jsm</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -1,34 +1,25 @@</span>
<a href="#l13.4"></a><span id="l13.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l13.5"></a><span id="l13.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l13.6"></a><span id="l13.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l13.7"></a><span id="l13.7"> </span>
<a href="#l13.8"></a><span id="l13.8" class="difflineminus">-/**</span>
<a href="#l13.9"></a><span id="l13.9" class="difflineminus">- * Session Storage and Restoration</span>
<a href="#l13.10"></a><span id="l13.10" class="difflineminus">- */</span>
<a href="#l13.11"></a><span id="l13.11" class="difflineminus">-</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-/* :::::::: Constants and Helpers ::::::::::::::: */</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineminus">-</span>
<a href="#l13.14"></a><span id="l13.14"> this.EXPORTED_SYMBOLS = [&quot;SessionStoreManager&quot;];</span>
<a href="#l13.15"></a><span id="l13.15"> </span>
<a href="#l13.16"></a><span id="l13.16"> ChromeUtils.import(&quot;resource://gre/modules/JSONFile.jsm&quot;);</span>
<a href="#l13.17"></a><span id="l13.17"> ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l13.18"></a><span id="l13.18"> </span>
<a href="#l13.19"></a><span id="l13.19"> /**</span>
<a href="#l13.20"></a><span id="l13.20">  * asuth arbitrarily chose this value to trade-off powersaving,</span>
<a href="#l13.21"></a><span id="l13.21">  * processor usage, and recency of state in the face of the impossibility of</span>
<a href="#l13.22"></a><span id="l13.22">  * our crashing; he also worded this.</span>
<a href="#l13.23"></a><span id="l13.23">  */</span>
<a href="#l13.24"></a><span id="l13.24"> var SESSION_AUTO_SAVE_DEFAULT_MS = 300000; // 5 minutes</span>
<a href="#l13.25"></a><span id="l13.25"> </span>
<a href="#l13.26"></a><span id="l13.26" class="difflineminus">-/* :::::::: The Module ::::::::::::::: */</span>
<a href="#l13.27"></a><span id="l13.27" class="difflineminus">-</span>
<a href="#l13.28"></a><span id="l13.28" class="difflineminus">-var SessionStoreManager =</span>
<a href="#l13.29"></a><span id="l13.29" class="difflineminus">-{</span>
<a href="#l13.30"></a><span id="l13.30" class="difflineplus">+var SessionStoreManager = {</span>
<a href="#l13.31"></a><span id="l13.31">   _initialized: false,</span>
<a href="#l13.32"></a><span id="l13.32"> </span>
<a href="#l13.33"></a><span id="l13.33">   /**</span>
<a href="#l13.34"></a><span id="l13.34">    * Session restored successfully on startup; use this to test for an early</span>
<a href="#l13.35"></a><span id="l13.35">    * failed startup which does not restore user tab state to ensure a session</span>
<a href="#l13.36"></a><span id="l13.36">    * save on close will not overwrite the last good session state.</span>
<a href="#l13.37"></a><span id="l13.37">    */</span>
<a href="#l13.38"></a><span id="l13.38">   _restored: false,</span>
<a href="#l13.39"></a><span id="l13.39" class="difflineat">@@ -49,94 +40,88 @@ var SessionStoreManager =</span>
<a href="#l13.40"></a><span id="l13.40">    * session has been persisted to disk. See |observe| and |unloadingWindow|</span>
<a href="#l13.41"></a><span id="l13.41">    * for justification on why we need this.</span>
<a href="#l13.42"></a><span id="l13.42">    */</span>
<a href="#l13.43"></a><span id="l13.43">   _shutdownStateSaved: false,</span>
<a href="#l13.44"></a><span id="l13.44"> </span>
<a href="#l13.45"></a><span id="l13.45">   /**</span>
<a href="#l13.46"></a><span id="l13.46">    * The JSONFile store object.</span>
<a href="#l13.47"></a><span id="l13.47">    */</span>
<a href="#l13.48"></a><span id="l13.48" class="difflineminus">-  get store()</span>
<a href="#l13.49"></a><span id="l13.49" class="difflineminus">-  {</span>
<a href="#l13.50"></a><span id="l13.50" class="difflineplus">+  get store() {</span>
<a href="#l13.51"></a><span id="l13.51">     if (this._store)</span>
<a href="#l13.52"></a><span id="l13.52">       return this._store;</span>
<a href="#l13.53"></a><span id="l13.53"> </span>
<a href="#l13.54"></a><span id="l13.54">     return this._store = new JSONFile({path: this.sessionFile.path});</span>
<a href="#l13.55"></a><span id="l13.55">   },</span>
<a href="#l13.56"></a><span id="l13.56"> </span>
<a href="#l13.57"></a><span id="l13.57">   /**</span>
<a href="#l13.58"></a><span id="l13.58">    * Gets the nsIFile used for session storage.</span>
<a href="#l13.59"></a><span id="l13.59">    */</span>
<a href="#l13.60"></a><span id="l13.60" class="difflineminus">-  get sessionFile()</span>
<a href="#l13.61"></a><span id="l13.61" class="difflineminus">-  {</span>
<a href="#l13.62"></a><span id="l13.62" class="difflineplus">+  get sessionFile() {</span>
<a href="#l13.63"></a><span id="l13.63">     let sessionFile = Services.dirsvc.get(&quot;ProfD&quot;, Ci.nsIFile);</span>
<a href="#l13.64"></a><span id="l13.64">     sessionFile.append(&quot;session.json&quot;);</span>
<a href="#l13.65"></a><span id="l13.65">     return sessionFile;</span>
<a href="#l13.66"></a><span id="l13.66">   },</span>
<a href="#l13.67"></a><span id="l13.67"> </span>
<a href="#l13.68"></a><span id="l13.68">   /**</span>
<a href="#l13.69"></a><span id="l13.69">    * This is called on startup, and when a new 3 pane window is opened after</span>
<a href="#l13.70"></a><span id="l13.70">    * the last 3 pane window was closed (e.g., on the mac, closing the last</span>
<a href="#l13.71"></a><span id="l13.71">    * window doesn't shut down the app).</span>
<a href="#l13.72"></a><span id="l13.72">    */</span>
<a href="#l13.73"></a><span id="l13.73" class="difflineminus">-  async _init()</span>
<a href="#l13.74"></a><span id="l13.74" class="difflineminus">-  {</span>
<a href="#l13.75"></a><span id="l13.75" class="difflineplus">+  async _init() {</span>
<a href="#l13.76"></a><span id="l13.76">     await this._loadSessionFile();</span>
<a href="#l13.77"></a><span id="l13.77"> </span>
<a href="#l13.78"></a><span id="l13.78">     // we listen for &quot;quit-application-granted&quot; instead of</span>
<a href="#l13.79"></a><span id="l13.79">     // &quot;quit-application-requested&quot; because other observers of the</span>
<a href="#l13.80"></a><span id="l13.80">     // latter can cancel the shutdown.</span>
<a href="#l13.81"></a><span id="l13.81">     Services.obs.addObserver(this, &quot;quit-application-granted&quot;);</span>
<a href="#l13.82"></a><span id="l13.82"> </span>
<a href="#l13.83"></a><span id="l13.83">     this.startPeriodicSave();</span>
<a href="#l13.84"></a><span id="l13.84"> </span>
<a href="#l13.85"></a><span id="l13.85">     this._initialized = true;</span>
<a href="#l13.86"></a><span id="l13.86">   },</span>
<a href="#l13.87"></a><span id="l13.87"> </span>
<a href="#l13.88"></a><span id="l13.88">   /**</span>
<a href="#l13.89"></a><span id="l13.89">    * Loads the session file into _initialState. This should only be called by</span>
<a href="#l13.90"></a><span id="l13.90">    * _init and a unit test.</span>
<a href="#l13.91"></a><span id="l13.91">    */</span>
<a href="#l13.92"></a><span id="l13.92" class="difflineminus">-  async _loadSessionFile()</span>
<a href="#l13.93"></a><span id="l13.93" class="difflineminus">-  {</span>
<a href="#l13.94"></a><span id="l13.94" class="difflineplus">+  async _loadSessionFile() {</span>
<a href="#l13.95"></a><span id="l13.95">     if (!this.sessionFile.exists())</span>
<a href="#l13.96"></a><span id="l13.96">       return;</span>
<a href="#l13.97"></a><span id="l13.97"> </span>
<a href="#l13.98"></a><span id="l13.98">     // Read the session state data from file, asynchronously.</span>
<a href="#l13.99"></a><span id="l13.99">     // An error on the json file returns an empty object which corresponds</span>
<a href="#l13.100"></a><span id="l13.100">     // to a null |_initialState|.</span>
<a href="#l13.101"></a><span id="l13.101">     await this.store.load();</span>
<a href="#l13.102"></a><span id="l13.102">     this._initialState = this.store.data.toSource() == {}.toSource() ?</span>
<a href="#l13.103"></a><span id="l13.103">                            null : this.store.data;</span>
<a href="#l13.104"></a><span id="l13.104"> </span>
<a href="#l13.105"></a><span id="l13.105">   },</span>
<a href="#l13.106"></a><span id="l13.106"> </span>
<a href="#l13.107"></a><span id="l13.107">   /**</span>
<a href="#l13.108"></a><span id="l13.108">    * Opens the windows that were open in the previous session.</span>
<a href="#l13.109"></a><span id="l13.109">    */</span>
<a href="#l13.110"></a><span id="l13.110" class="difflineminus">-  _openOtherRequiredWindows: function ssm_openOtherRequiredWindows(aWindow)</span>
<a href="#l13.111"></a><span id="l13.111" class="difflineminus">-  {</span>
<a href="#l13.112"></a><span id="l13.112" class="difflineplus">+  _openOtherRequiredWindows(aWindow) {</span>
<a href="#l13.113"></a><span id="l13.113">     // XXX we might want to display a restore page and let the user decide</span>
<a href="#l13.114"></a><span id="l13.114">     // whether to restore the other windows, just like Firefox does.</span>
<a href="#l13.115"></a><span id="l13.115"> </span>
<a href="#l13.116"></a><span id="l13.116">     if (!this._initialState || !this._initialState.windows || !aWindow)</span>
<a href="#l13.117"></a><span id="l13.117">       return;</span>
<a href="#l13.118"></a><span id="l13.118"> </span>
<a href="#l13.119"></a><span id="l13.119">     for (var i = 0; i &lt; this._initialState.windows.length; ++i)</span>
<a href="#l13.120"></a><span id="l13.120">       aWindow.open(</span>
<a href="#l13.121"></a><span id="l13.121">              &quot;chrome://messenger/content/messenger.xul&quot;,</span>
<a href="#l13.122"></a><span id="l13.122">              &quot;_blank&quot;,</span>
<a href="#l13.123"></a><span id="l13.123">              &quot;chrome,extrachrome,menubar,resizable,scrollbars,status,toolbar&quot;);</span>
<a href="#l13.124"></a><span id="l13.124">   },</span>
<a href="#l13.125"></a><span id="l13.125"> </span>
<a href="#l13.126"></a><span id="l13.126">   /**</span>
<a href="#l13.127"></a><span id="l13.127">    * Writes the state object to disk.</span>
<a href="#l13.128"></a><span id="l13.128">    */</span>
<a href="#l13.129"></a><span id="l13.129" class="difflineminus">-  _saveStateObject: function ssm_saveStateObject(aStateObj)</span>
<a href="#l13.130"></a><span id="l13.130" class="difflineminus">-  {</span>
<a href="#l13.131"></a><span id="l13.131" class="difflineplus">+  _saveStateObject(aStateObj) {</span>
<a href="#l13.132"></a><span id="l13.132">     if (!this.store) {</span>
<a href="#l13.133"></a><span id="l13.133">       Cu.reportError(&quot;SessionStoreManager: could not create data store from file&quot;);</span>
<a href="#l13.134"></a><span id="l13.134">       return;</span>
<a href="#l13.135"></a><span id="l13.135">     }</span>
<a href="#l13.136"></a><span id="l13.136"> </span>
<a href="#l13.137"></a><span id="l13.137">     let currentStateString = JSON.stringify(aStateObj);</span>
<a href="#l13.138"></a><span id="l13.138">     let storedStateString = this.store.dataReady &amp;&amp; this.store.data ?</span>
<a href="#l13.139"></a><span id="l13.139">                               JSON.stringify(this.store.data) : null;</span>
<a href="#l13.140"></a><span id="l13.140" class="difflineat">@@ -148,54 +133,49 @@ var SessionStoreManager =</span>
<a href="#l13.141"></a><span id="l13.141"> </span>
<a href="#l13.142"></a><span id="l13.142">     this.store.data = aStateObj;</span>
<a href="#l13.143"></a><span id="l13.143">     this.store.saveSoon();</span>
<a href="#l13.144"></a><span id="l13.144">   },</span>
<a href="#l13.145"></a><span id="l13.145"> </span>
<a href="#l13.146"></a><span id="l13.146">   /**</span>
<a href="#l13.147"></a><span id="l13.147">    * @return an empty state object that can be populated with window states.</span>
<a href="#l13.148"></a><span id="l13.148">    */</span>
<a href="#l13.149"></a><span id="l13.149" class="difflineminus">-  _createStateObject: function ssm_createStateObject()</span>
<a href="#l13.150"></a><span id="l13.150" class="difflineminus">-  {</span>
<a href="#l13.151"></a><span id="l13.151" class="difflineplus">+  _createStateObject() {</span>
<a href="#l13.152"></a><span id="l13.152">     return {</span>
<a href="#l13.153"></a><span id="l13.153">       rev: 0,</span>
<a href="#l13.154"></a><span id="l13.154" class="difflineminus">-      windows: []</span>
<a href="#l13.155"></a><span id="l13.155" class="difflineplus">+      windows: [],</span>
<a href="#l13.156"></a><span id="l13.156">     };</span>
<a href="#l13.157"></a><span id="l13.157">   },</span>
<a href="#l13.158"></a><span id="l13.158"> </span>
<a href="#l13.159"></a><span id="l13.159">   /**</span>
<a href="#l13.160"></a><span id="l13.160">    * Writes the state of all currently open 3pane windows to disk.</span>
<a href="#l13.161"></a><span id="l13.161">    */</span>
<a href="#l13.162"></a><span id="l13.162" class="difflineminus">-  _saveState: function ssm_saveState()</span>
<a href="#l13.163"></a><span id="l13.163" class="difflineminus">-  {</span>
<a href="#l13.164"></a><span id="l13.164" class="difflineplus">+  _saveState() {</span>
<a href="#l13.165"></a><span id="l13.165">     let state = this._createStateObject();</span>
<a href="#l13.166"></a><span id="l13.166"> </span>
<a href="#l13.167"></a><span id="l13.167">     // XXX we'd like to support other window types in future, but for now</span>
<a href="#l13.168"></a><span id="l13.168">     // only get the 3pane windows.</span>
<a href="#l13.169"></a><span id="l13.169">     let enumerator = Services.wm.getEnumerator(&quot;mail:3pane&quot;);</span>
<a href="#l13.170"></a><span id="l13.170">     while (enumerator.hasMoreElements()) {</span>
<a href="#l13.171"></a><span id="l13.171">       let win = enumerator.getNext();</span>
<a href="#l13.172"></a><span id="l13.172">       if (win &amp;&amp; &quot;complete&quot; == win.document.readyState &amp;&amp;</span>
<a href="#l13.173"></a><span id="l13.173">           win.getWindowStateForSessionPersistence)</span>
<a href="#l13.174"></a><span id="l13.174">         state.windows.push(win.getWindowStateForSessionPersistence());</span>
<a href="#l13.175"></a><span id="l13.175">     }</span>
<a href="#l13.176"></a><span id="l13.176"> </span>
<a href="#l13.177"></a><span id="l13.177">     this._saveStateObject(state);</span>
<a href="#l13.178"></a><span id="l13.178">   },</span>
<a href="#l13.179"></a><span id="l13.179"> </span>
<a href="#l13.180"></a><span id="l13.180" class="difflineminus">-/* ........ Timer Callback ................*/</span>
<a href="#l13.181"></a><span id="l13.181" class="difflineminus">-</span>
<a href="#l13.182"></a><span id="l13.182" class="difflineminus">-  _sessionAutoSaveTimerCallback: function ssm_sessionAutoSaveTimerCallback()</span>
<a href="#l13.183"></a><span id="l13.183" class="difflineminus">-  {</span>
<a href="#l13.184"></a><span id="l13.184" class="difflineplus">+  // Timer Callback</span>
<a href="#l13.185"></a><span id="l13.185" class="difflineplus">+  _sessionAutoSaveTimerCallback() {</span>
<a href="#l13.186"></a><span id="l13.186">     SessionStoreManager._saveState();</span>
<a href="#l13.187"></a><span id="l13.187">   },</span>
<a href="#l13.188"></a><span id="l13.188"> </span>
<a href="#l13.189"></a><span id="l13.189" class="difflineminus">-/* ........ Observer Notification Handler ................*/</span>
<a href="#l13.190"></a><span id="l13.190" class="difflineminus">-</span>
<a href="#l13.191"></a><span id="l13.191" class="difflineminus">-  observe: function ssm_observe(aSubject, aTopic, aData) {</span>
<a href="#l13.192"></a><span id="l13.192" class="difflineplus">+  // Observer Notification Handler</span>
<a href="#l13.193"></a><span id="l13.193" class="difflineplus">+  observe(aSubject, aTopic, aData) {</span>
<a href="#l13.194"></a><span id="l13.194">     switch (aTopic) {</span>
<a href="#l13.195"></a><span id="l13.195">     // This is observed before any windows start unloading if something other</span>
<a href="#l13.196"></a><span id="l13.196">     // than the last 3pane window closing requested the application be</span>
<a href="#l13.197"></a><span id="l13.197">     // shutdown. For example, when the user quits via the file menu.</span>
<a href="#l13.198"></a><span id="l13.198">     case &quot;quit-application-granted&quot;:</span>
<a href="#l13.199"></a><span id="l13.199">       if (!this._shutdownStateSaved) {</span>
<a href="#l13.200"></a><span id="l13.200">         this.stopPeriodicSave();</span>
<a href="#l13.201"></a><span id="l13.201">         this._saveState();</span>
<a href="#l13.202"></a><span id="l13.202" class="difflineat">@@ -203,26 +183,25 @@ var SessionStoreManager =</span>
<a href="#l13.203"></a><span id="l13.203">         // this is to ensure we don't clobber the saved state when the</span>
<a href="#l13.204"></a><span id="l13.204">         // 3pane windows unload.</span>
<a href="#l13.205"></a><span id="l13.205">         this._shutdownStateSaved = true;</span>
<a href="#l13.206"></a><span id="l13.206">       }</span>
<a href="#l13.207"></a><span id="l13.207">       break;</span>
<a href="#l13.208"></a><span id="l13.208">     }</span>
<a href="#l13.209"></a><span id="l13.209">   },</span>
<a href="#l13.210"></a><span id="l13.210"> </span>
<a href="#l13.211"></a><span id="l13.211" class="difflineminus">-/* ........ Public API ................*/</span>
<a href="#l13.212"></a><span id="l13.212" class="difflineplus">+  // Public API</span>
<a href="#l13.213"></a><span id="l13.213"> </span>
<a href="#l13.214"></a><span id="l13.214">   /**</span>
<a href="#l13.215"></a><span id="l13.215">    * Called by each 3pane window instance when it loads.</span>
<a href="#l13.216"></a><span id="l13.216">    *</span>
<a href="#l13.217"></a><span id="l13.217">    * @return a window state object if aWindow was opened as a result of a</span>
<a href="#l13.218"></a><span id="l13.218">    *         session restoration, null otherwise.</span>
<a href="#l13.219"></a><span id="l13.219">    */</span>
<a href="#l13.220"></a><span id="l13.220" class="difflineminus">-  async loadingWindow(aWindow)</span>
<a href="#l13.221"></a><span id="l13.221" class="difflineminus">-  {</span>
<a href="#l13.222"></a><span id="l13.222" class="difflineplus">+  async loadingWindow(aWindow) {</span>
<a href="#l13.223"></a><span id="l13.223">     let firstWindow = !this._initialized || this._shutdownStateSaved;</span>
<a href="#l13.224"></a><span id="l13.224">     if (firstWindow)</span>
<a href="#l13.225"></a><span id="l13.225">       await this._init();</span>
<a href="#l13.226"></a><span id="l13.226"> </span>
<a href="#l13.227"></a><span id="l13.227">     // If we are seeing a new 3-pane, we are obviously not in a shutdown</span>
<a href="#l13.228"></a><span id="l13.228">     // state anymore.  (This would happen if all the 3panes got closed but</span>
<a href="#l13.229"></a><span id="l13.229">     // we did not quit because another window was open and then a 3pane showed</span>
<a href="#l13.230"></a><span id="l13.230">     // up again.  This can happen in both unit tests and real life.)</span>
<a href="#l13.231"></a><span id="l13.231" class="difflineat">@@ -242,18 +221,17 @@ var SessionStoreManager =</span>
<a href="#l13.232"></a><span id="l13.232">     return windowState;</span>
<a href="#l13.233"></a><span id="l13.233">   },</span>
<a href="#l13.234"></a><span id="l13.234"> </span>
<a href="#l13.235"></a><span id="l13.235">   /**</span>
<a href="#l13.236"></a><span id="l13.236">    * Called by each 3pane window instance when it unloads. If aWindow is the</span>
<a href="#l13.237"></a><span id="l13.237">    * last 3pane window, its state is persisted. The last 3pane window unloads</span>
<a href="#l13.238"></a><span id="l13.238">    * first before the &quot;quit-application-granted&quot; event is generated.</span>
<a href="#l13.239"></a><span id="l13.239">    */</span>
<a href="#l13.240"></a><span id="l13.240" class="difflineminus">-  unloadingWindow: function ssm_unloadingWindow(aWindow)</span>
<a href="#l13.241"></a><span id="l13.241" class="difflineminus">-  {</span>
<a href="#l13.242"></a><span id="l13.242" class="difflineplus">+  unloadingWindow(aWindow) {</span>
<a href="#l13.243"></a><span id="l13.243">     if (!this._shutdownStateSaved) {</span>
<a href="#l13.244"></a><span id="l13.244">       // determine whether aWindow is the last open window</span>
<a href="#l13.245"></a><span id="l13.245">       let lastWindow = true;</span>
<a href="#l13.246"></a><span id="l13.246">       let enumerator = Services.wm.getEnumerator(&quot;mail:3pane&quot;);</span>
<a href="#l13.247"></a><span id="l13.247">       while (enumerator.hasMoreElements()) {</span>
<a href="#l13.248"></a><span id="l13.248">         if (enumerator.getNext() != aWindow)</span>
<a href="#l13.249"></a><span id="l13.249">           lastWindow = false;</span>
<a href="#l13.250"></a><span id="l13.250">       }</span>
<a href="#l13.251"></a><span id="l13.251" class="difflineat">@@ -273,34 +251,32 @@ var SessionStoreManager =</span>
<a href="#l13.252"></a><span id="l13.252">         this._shutdownStateSaved = true;</span>
<a href="#l13.253"></a><span id="l13.253">       }</span>
<a href="#l13.254"></a><span id="l13.254">     }</span>
<a href="#l13.255"></a><span id="l13.255">   },</span>
<a href="#l13.256"></a><span id="l13.256"> </span>
<a href="#l13.257"></a><span id="l13.257">   /**</span>
<a href="#l13.258"></a><span id="l13.258">    * Stops periodic session persistence.</span>
<a href="#l13.259"></a><span id="l13.259">    */</span>
<a href="#l13.260"></a><span id="l13.260" class="difflineminus">-  stopPeriodicSave: function ssm_stopPeriodicSave()</span>
<a href="#l13.261"></a><span id="l13.261" class="difflineminus">-  {</span>
<a href="#l13.262"></a><span id="l13.262" class="difflineplus">+  stopPeriodicSave() {</span>
<a href="#l13.263"></a><span id="l13.263">     if (this._sessionAutoSaveTimer) {</span>
<a href="#l13.264"></a><span id="l13.264">       this._sessionAutoSaveTimer.cancel();</span>
<a href="#l13.265"></a><span id="l13.265"> </span>
<a href="#l13.266"></a><span id="l13.266">       delete this._sessionAutoSaveTimer;</span>
<a href="#l13.267"></a><span id="l13.267">       this._sessionAutoSaveTimer = null;</span>
<a href="#l13.268"></a><span id="l13.268">     }</span>
<a href="#l13.269"></a><span id="l13.269">   },</span>
<a href="#l13.270"></a><span id="l13.270"> </span>
<a href="#l13.271"></a><span id="l13.271">   /**</span>
<a href="#l13.272"></a><span id="l13.272">    * Starts periodic session persistence.</span>
<a href="#l13.273"></a><span id="l13.273">    */</span>
<a href="#l13.274"></a><span id="l13.274" class="difflineminus">-  startPeriodicSave: function ssm_startPeriodicSave()</span>
<a href="#l13.275"></a><span id="l13.275" class="difflineminus">-  {</span>
<a href="#l13.276"></a><span id="l13.276" class="difflineplus">+  startPeriodicSave() {</span>
<a href="#l13.277"></a><span id="l13.277">     if (!this._sessionAutoSaveTimer) {</span>
<a href="#l13.278"></a><span id="l13.278">       this._sessionAutoSaveTimer = Cc[&quot;@mozilla.org/timer;1&quot;]</span>
<a href="#l13.279"></a><span id="l13.279">                                    .createInstance(Ci.nsITimer);</span>
<a href="#l13.280"></a><span id="l13.280"> </span>
<a href="#l13.281"></a><span id="l13.281">       this._sessionAutoSaveTimer.initWithCallback(</span>
<a href="#l13.282"></a><span id="l13.282">                                    this._sessionAutoSaveTimerCallback,</span>
<a href="#l13.283"></a><span id="l13.283">                                    this._sessionAutoSaveTimerIntervalMS,</span>
<a href="#l13.284"></a><span id="l13.284">                                    Ci.nsITimer.TYPE_REPEATING_SLACK);</span>
<a href="#l13.285"></a><span id="l13.285">     }</span>
<a href="#l13.286"></a><span id="l13.286" class="difflineminus">-  }</span>
<a href="#l13.287"></a><span id="l13.287" class="difflineplus">+  },</span>
<a href="#l13.288"></a><span id="l13.288"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mail/base/modules/SummaryFrameManager.jsm</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mail/base/modules/SummaryFrameManager.jsm</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -25,71 +25,66 @@ function SummaryFrameManager(aFrame) {</span>
<a href="#l14.4"></a><span id="l14.4">   this.callback = null;</span>
<a href="#l14.5"></a><span id="l14.5">   this.url = &quot;&quot;;</span>
<a href="#l14.6"></a><span id="l14.6"> }</span>
<a href="#l14.7"></a><span id="l14.7"> </span>
<a href="#l14.8"></a><span id="l14.8"> SummaryFrameManager.prototype = {</span>
<a href="#l14.9"></a><span id="l14.9">   /**</span>
<a href="#l14.10"></a><span id="l14.10">    * Clear the summary frame.</span>
<a href="#l14.11"></a><span id="l14.11">    */</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-  clear: function() {</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+  clear() {</span>
<a href="#l14.14"></a><span id="l14.14">     this.loadAndCallback(&quot;about:blank&quot;);</span>
<a href="#l14.15"></a><span id="l14.15">   },</span>
<a href="#l14.16"></a><span id="l14.16"> </span>
<a href="#l14.17"></a><span id="l14.17">   /**</span>
<a href="#l14.18"></a><span id="l14.18">    * Load the specified URL if necessary, and cause the specified callback to be</span>
<a href="#l14.19"></a><span id="l14.19">    * called either when the document is loaded, or immediately if the document</span>
<a href="#l14.20"></a><span id="l14.20">    * is already loaded.</span>
<a href="#l14.21"></a><span id="l14.21">    *</span>
<a href="#l14.22"></a><span id="l14.22">    * @param aUrl the URL to load</span>
<a href="#l14.23"></a><span id="l14.23">    * @param aCallback the callback to run when the URL has loaded; this function</span>
<a href="#l14.24"></a><span id="l14.24">    *        is passed a single boolean indicating if the URL was changed</span>
<a href="#l14.25"></a><span id="l14.25">    */</span>
<a href="#l14.26"></a><span id="l14.26" class="difflineminus">-  loadAndCallback: function(aUrl, aCallback) {</span>
<a href="#l14.27"></a><span id="l14.27" class="difflineplus">+  loadAndCallback(aUrl, aCallback) {</span>
<a href="#l14.28"></a><span id="l14.28">     this.url = aUrl;</span>
<a href="#l14.29"></a><span id="l14.29">     if (this.pendingOrLoadedUrl != aUrl) {</span>
<a href="#l14.30"></a><span id="l14.30">       // We're changing the document. Stash the callback that we want to call</span>
<a href="#l14.31"></a><span id="l14.31">       // when it's done loading</span>
<a href="#l14.32"></a><span id="l14.32">       this.pendingCallback = aCallback;</span>
<a href="#l14.33"></a><span id="l14.33">       this.callback = null; // clear it</span>
<a href="#l14.34"></a><span id="l14.34">       this.iframe.contentDocument.location.href = aUrl;</span>
<a href="#l14.35"></a><span id="l14.35">       this.pendingOrLoadedUrl = aUrl;</span>
<a href="#l14.36"></a><span id="l14.36" class="difflineminus">-    }</span>
<a href="#l14.37"></a><span id="l14.37" class="difflineminus">-    else {</span>
<a href="#l14.38"></a><span id="l14.38" class="difflineplus">+    } else if (!this.pendingCallback) {</span>
<a href="#l14.39"></a><span id="l14.39">       // We're being called, but the document has been set already -- either</span>
<a href="#l14.40"></a><span id="l14.40">       // we've already received the DOMContentLoaded event, in which case we can</span>
<a href="#l14.41"></a><span id="l14.41">       // just call the callback directly, or we're still loading in which case</span>
<a href="#l14.42"></a><span id="l14.42">       // we should just wait for the dom event handler, but update the callback.</span>
<a href="#l14.43"></a><span id="l14.43"> </span>
<a href="#l14.44"></a><span id="l14.44" class="difflineminus">-      if (!this.pendingCallback) {</span>
<a href="#l14.45"></a><span id="l14.45" class="difflineminus">-        this.callback = aCallback;</span>
<a href="#l14.46"></a><span id="l14.46" class="difflineminus">-        if (this.callback) {</span>
<a href="#l14.47"></a><span id="l14.47" class="difflineminus">-          this.callback(false);</span>
<a href="#l14.48"></a><span id="l14.48" class="difflineminus">-        }</span>
<a href="#l14.49"></a><span id="l14.49" class="difflineplus">+      this.callback = aCallback;</span>
<a href="#l14.50"></a><span id="l14.50" class="difflineplus">+      if (this.callback) {</span>
<a href="#l14.51"></a><span id="l14.51" class="difflineplus">+        this.callback(false);</span>
<a href="#l14.52"></a><span id="l14.52">       }</span>
<a href="#l14.53"></a><span id="l14.53" class="difflineminus">-      else {</span>
<a href="#l14.54"></a><span id="l14.54" class="difflineminus">-        this.pendingCallback = aCallback;</span>
<a href="#l14.55"></a><span id="l14.55" class="difflineminus">-      }</span>
<a href="#l14.56"></a><span id="l14.56" class="difflineplus">+    } else {</span>
<a href="#l14.57"></a><span id="l14.57" class="difflineplus">+      this.pendingCallback = aCallback;</span>
<a href="#l14.58"></a><span id="l14.58">     }</span>
<a href="#l14.59"></a><span id="l14.59">   },</span>
<a href="#l14.60"></a><span id="l14.60"> </span>
<a href="#l14.61"></a><span id="l14.61" class="difflineminus">-  _onLoad: function(event) {</span>
<a href="#l14.62"></a><span id="l14.62" class="difflineplus">+  _onLoad(event) {</span>
<a href="#l14.63"></a><span id="l14.63">     try {</span>
<a href="#l14.64"></a><span id="l14.64">       // Make sure we're responding to the summary frame being loaded, and not</span>
<a href="#l14.65"></a><span id="l14.65">       // some subnode.</span>
<a href="#l14.66"></a><span id="l14.66">       if (event.originalTarget != this.iframe.contentDocument ||</span>
<a href="#l14.67"></a><span id="l14.67">           this.pendingOrLoadedUrl == &quot;about:blank&quot;)</span>
<a href="#l14.68"></a><span id="l14.68">         return;</span>
<a href="#l14.69"></a><span id="l14.69"> </span>
<a href="#l14.70"></a><span id="l14.70">       this.callback = this.pendingCallback;</span>
<a href="#l14.71"></a><span id="l14.71">       this.pendingCallback = null;</span>
<a href="#l14.72"></a><span id="l14.72">       if (this.pendingOrLoadedUrl != this.iframe.contentDocument.location.href)</span>
<a href="#l14.73"></a><span id="l14.73">         Cu.reportError(</span>
<a href="#l14.74"></a><span id="l14.74" class="difflineminus">-          &quot;Please do not load stuff in the multimessage browser directly, &quot;+</span>
<a href="#l14.75"></a><span id="l14.75" class="difflineplus">+          &quot;Please do not load stuff in the multimessage browser directly, &quot; +</span>
<a href="#l14.76"></a><span id="l14.76">           &quot;use the SummaryFrameManager instead.&quot;);</span>
<a href="#l14.77"></a><span id="l14.77">       else if (this.callback)</span>
<a href="#l14.78"></a><span id="l14.78">         this.callback(true);</span>
<a href="#l14.79"></a><span id="l14.79" class="difflineminus">-    }</span>
<a href="#l14.80"></a><span id="l14.80" class="difflineminus">-    catch (e) {</span>
<a href="#l14.81"></a><span id="l14.81" class="difflineplus">+    } catch (e) {</span>
<a href="#l14.82"></a><span id="l14.82">       Cu.reportError(e);</span>
<a href="#l14.83"></a><span id="l14.83">     }</span>
<a href="#l14.84"></a><span id="l14.84" class="difflineminus">-  }</span>
<a href="#l14.85"></a><span id="l14.85" class="difflineplus">+  },</span>
<a href="#l14.86"></a><span id="l14.86"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mail/base/modules/TBDistCustomizer.jsm</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mail/base/modules/TBDistCustomizer.jsm</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -1,38 +1,38 @@</span>
<a href="#l15.4"></a><span id="l15.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l15.5"></a><span id="l15.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l15.6"></a><span id="l15.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l15.7"></a><span id="l15.7"> </span>
<a href="#l15.8"></a><span id="l15.8" class="difflineplus">+// This file uses eval, but really shouldn't. See bug 1498497.</span>
<a href="#l15.9"></a><span id="l15.9" class="difflineplus">+/* eslint-disable no-eval */</span>
<a href="#l15.10"></a><span id="l15.10" class="difflineplus">+</span>
<a href="#l15.11"></a><span id="l15.11"> this.EXPORTED_SYMBOLS = [&quot;TBDistCustomizer&quot;];</span>
<a href="#l15.12"></a><span id="l15.12"> </span>
<a href="#l15.13"></a><span id="l15.13"> ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l15.14"></a><span id="l15.14"> ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l15.15"></a><span id="l15.15"> </span>
<a href="#l15.16"></a><span id="l15.16" class="difflineminus">-var DISTRIBUTION_CUSTOMIZATION_COMPLETE_TOPIC =</span>
<a href="#l15.17"></a><span id="l15.17" class="difflineminus">-  &quot;distribution-customization-complete&quot;;</span>
<a href="#l15.18"></a><span id="l15.18" class="difflineminus">-</span>
<a href="#l15.19"></a><span id="l15.19"> var TBDistCustomizer = {</span>
<a href="#l15.20"></a><span id="l15.20" class="difflineminus">-  applyPrefDefaults: function TBDistCustomizer_applyPrefDefaults() {</span>
<a href="#l15.21"></a><span id="l15.21" class="difflineplus">+  applyPrefDefaults() {</span>
<a href="#l15.22"></a><span id="l15.22">     this._prefDefaultsApplied = true;</span>
<a href="#l15.23"></a><span id="l15.23">     if (!this._ini) {</span>
<a href="#l15.24"></a><span id="l15.24">       return;</span>
<a href="#l15.25"></a><span id="l15.25">     }</span>
<a href="#l15.26"></a><span id="l15.26">     // Grab the sections of the ini file</span>
<a href="#l15.27"></a><span id="l15.27">     let sections = enumToObject(this._ini.getSections());</span>
<a href="#l15.28"></a><span id="l15.28"> </span>
<a href="#l15.29"></a><span id="l15.29">     // The global section, and several of its fields, is required</span>
<a href="#l15.30"></a><span id="l15.30">     // Function exits if this section and its fields are not present</span>
<a href="#l15.31"></a><span id="l15.31" class="difflineminus">-    if (!sections[&quot;Global&quot;]) {</span>
<a href="#l15.32"></a><span id="l15.32" class="difflineplus">+    if (!sections.Global) {</span>
<a href="#l15.33"></a><span id="l15.33">       return;</span>
<a href="#l15.34"></a><span id="l15.34">     }</span>
<a href="#l15.35"></a><span id="l15.35"> </span>
<a href="#l15.36"></a><span id="l15.36">     // Get the keys in the &quot;Global&quot; section  of the ini file</span>
<a href="#l15.37"></a><span id="l15.37">     let globalPrefs = enumToObject(this._ini.getKeys(&quot;Global&quot;));</span>
<a href="#l15.38"></a><span id="l15.38" class="difflineminus">-    if (!(globalPrefs[&quot;id&quot;] &amp;&amp; globalPrefs[&quot;version&quot;] &amp;&amp; globalPrefs[&quot;about&quot;])) {</span>
<a href="#l15.39"></a><span id="l15.39" class="difflineplus">+    if (!(globalPrefs.id &amp;&amp; globalPrefs.version &amp;&amp; globalPrefs.about)) {</span>
<a href="#l15.40"></a><span id="l15.40">       return;</span>
<a href="#l15.41"></a><span id="l15.41">     }</span>
<a href="#l15.42"></a><span id="l15.42"> </span>
<a href="#l15.43"></a><span id="l15.43">     // Get the entire preferences tree (defaults is an instance of nsIPrefBranch)</span>
<a href="#l15.44"></a><span id="l15.44">     let defaults = Services.prefs.getDefaultBranch(null);</span>
<a href="#l15.45"></a><span id="l15.45"> </span>
<a href="#l15.46"></a><span id="l15.46">     // Set the following user prefs</span>
<a href="#l15.47"></a><span id="l15.47">     defaults.setCharPref(&quot;distribution.id&quot;, this._ini.getString(&quot;Global&quot;, &quot;id&quot;));</span>
<a href="#l15.48"></a><span id="l15.48" class="difflineat">@@ -41,17 +41,17 @@ var TBDistCustomizer = {</span>
<a href="#l15.49"></a><span id="l15.49">     let partnerAbout;</span>
<a href="#l15.50"></a><span id="l15.50">     if (globalPrefs[&quot;about.&quot; + this._locale]) {</span>
<a href="#l15.51"></a><span id="l15.51">       partnerAbout = this._ini.getString(&quot;Global&quot;, &quot;about.&quot; + this._locale);</span>
<a href="#l15.52"></a><span id="l15.52">     } else {</span>
<a href="#l15.53"></a><span id="l15.53">       partnerAbout = this._ini.getString(&quot;Global&quot;, &quot;about&quot;);</span>
<a href="#l15.54"></a><span id="l15.54">     }</span>
<a href="#l15.55"></a><span id="l15.55">     defaults.setStringPref(&quot;distribution.about&quot;, partnerAbout);</span>
<a href="#l15.56"></a><span id="l15.56"> </span>
<a href="#l15.57"></a><span id="l15.57" class="difflineminus">-    if (sections[&quot;Preferences&quot;]) {</span>
<a href="#l15.58"></a><span id="l15.58" class="difflineplus">+    if (sections.Preferences) {</span>
<a href="#l15.59"></a><span id="l15.59">       let keys = this._ini.getKeys(&quot;Preferences&quot;);</span>
<a href="#l15.60"></a><span id="l15.60">       while (keys.hasMore()) {</span>
<a href="#l15.61"></a><span id="l15.61">         let key = keys.getNext();</span>
<a href="#l15.62"></a><span id="l15.62">         try {</span>
<a href="#l15.63"></a><span id="l15.63">           // Get the string value of the key</span>
<a href="#l15.64"></a><span id="l15.64">           let value = eval(this._ini.getString(&quot;Preferences&quot;, key));</span>
<a href="#l15.65"></a><span id="l15.65">           // After determining what type it is, set the pref</span>
<a href="#l15.66"></a><span id="l15.66">           switch (typeof value) {</span>
<a href="#l15.67"></a><span id="l15.67" class="difflineat">@@ -79,17 +79,17 @@ var TBDistCustomizer = {</span>
<a href="#l15.68"></a><span id="l15.68"> </span>
<a href="#l15.69"></a><span id="l15.69">     // We eval() the localizable prefs as well (even though they'll</span>
<a href="#l15.70"></a><span id="l15.70">     // always get set as a string) to keep the INI format consistent:</span>
<a href="#l15.71"></a><span id="l15.71">     // string prefs always need to be in quotes</span>
<a href="#l15.72"></a><span id="l15.72"> </span>
<a href="#l15.73"></a><span id="l15.73">     let localizedStr = Cc[&quot;@mozilla.org/pref-localizedstring;1&quot;]</span>
<a href="#l15.74"></a><span id="l15.74">                          .createInstance(Ci.nsIPrefLocalizedString);</span>
<a href="#l15.75"></a><span id="l15.75"> </span>
<a href="#l15.76"></a><span id="l15.76" class="difflineminus">-    if (sections[&quot;LocalizablePreferences&quot;]) {</span>
<a href="#l15.77"></a><span id="l15.77" class="difflineplus">+    if (sections.LocalizablePreferences) {</span>
<a href="#l15.78"></a><span id="l15.78">       let keys = this._ini.getKeys(&quot;LocalizablePreferences&quot;);</span>
<a href="#l15.79"></a><span id="l15.79">       while (keys.hasMore()) {</span>
<a href="#l15.80"></a><span id="l15.80">         let key = keys.getNext();</span>
<a href="#l15.81"></a><span id="l15.81">         try {</span>
<a href="#l15.82"></a><span id="l15.82">           let value = eval(this._ini.getString(&quot;LocalizablePreferences&quot;, key));</span>
<a href="#l15.83"></a><span id="l15.83">           value = value.replace(/%LOCALE%/g, this._locale);</span>
<a href="#l15.84"></a><span id="l15.84">           localizedStr.data = &quot;data:text/plain,&quot; + key + &quot;=&quot; + value;</span>
<a href="#l15.85"></a><span id="l15.85">           defaults.setComplexValue(key, Ci.nsIPrefLocalizedString, localizedStr);</span>
<a href="#l15.86"></a><span id="l15.86" class="difflineat">@@ -107,38 +107,35 @@ var TBDistCustomizer = {</span>
<a href="#l15.87"></a><span id="l15.87">           let value = eval(this._ini.getString(&quot;LocalizablePreferences-&quot; + this._locale, key));</span>
<a href="#l15.88"></a><span id="l15.88">           localizedStr.data = &quot;data:text/plain,&quot; + key + &quot;=&quot; + value;</span>
<a href="#l15.89"></a><span id="l15.89">           defaults.setComplexValue(key, Ci.nsIPrefLocalizedString, localizedStr);</span>
<a href="#l15.90"></a><span id="l15.90">         } catch (e) {</span>
<a href="#l15.91"></a><span id="l15.91">           Cu.reportError(e);</span>
<a href="#l15.92"></a><span id="l15.92">         }</span>
<a href="#l15.93"></a><span id="l15.93">       }</span>
<a href="#l15.94"></a><span id="l15.94">     }</span>
<a href="#l15.95"></a><span id="l15.95" class="difflineminus">-    return true;</span>
<a href="#l15.96"></a><span id="l15.96" class="difflineminus">-  }</span>
<a href="#l15.97"></a><span id="l15.97" class="difflineplus">+  },</span>
<a href="#l15.98"></a><span id="l15.98"> };</span>
<a href="#l15.99"></a><span id="l15.99"> </span>
<a href="#l15.100"></a><span id="l15.100" class="difflineminus">-XPCOMUtils.defineLazyGetter(TBDistCustomizer, &quot;_ini&quot;,</span>
<a href="#l15.101"></a><span id="l15.101" class="difflineminus">-  function TBDistCustomizer_get__ini() {</span>
<a href="#l15.102"></a><span id="l15.102" class="difflineminus">-    let ini = null;</span>
<a href="#l15.103"></a><span id="l15.103" class="difflineminus">-    let iniFile = Services.dirsvc.get(&quot;XCurProcD&quot;, Ci.nsIFile);</span>
<a href="#l15.104"></a><span id="l15.104" class="difflineminus">-    iniFile.append(&quot;distribution&quot;);</span>
<a href="#l15.105"></a><span id="l15.105" class="difflineminus">-    iniFile.append(&quot;distribution.ini&quot;);</span>
<a href="#l15.106"></a><span id="l15.106" class="difflineminus">-    if (iniFile.exists()) {</span>
<a href="#l15.107"></a><span id="l15.107" class="difflineminus">-      ini = Cc[&quot;@mozilla.org/xpcom/ini-parser-factory;1&quot;]</span>
<a href="#l15.108"></a><span id="l15.108" class="difflineminus">-              .getService(Ci.nsIINIParserFactory)</span>
<a href="#l15.109"></a><span id="l15.109" class="difflineminus">-              .createINIParser(iniFile);</span>
<a href="#l15.110"></a><span id="l15.110" class="difflineminus">-    }</span>
<a href="#l15.111"></a><span id="l15.111" class="difflineminus">-    return ini;</span>
<a href="#l15.112"></a><span id="l15.112" class="difflineplus">+XPCOMUtils.defineLazyGetter(TBDistCustomizer, &quot;_ini&quot;, function() {</span>
<a href="#l15.113"></a><span id="l15.113" class="difflineplus">+  let ini = null;</span>
<a href="#l15.114"></a><span id="l15.114" class="difflineplus">+  let iniFile = Services.dirsvc.get(&quot;XCurProcD&quot;, Ci.nsIFile);</span>
<a href="#l15.115"></a><span id="l15.115" class="difflineplus">+  iniFile.append(&quot;distribution&quot;);</span>
<a href="#l15.116"></a><span id="l15.116" class="difflineplus">+  iniFile.append(&quot;distribution.ini&quot;);</span>
<a href="#l15.117"></a><span id="l15.117" class="difflineplus">+  if (iniFile.exists()) {</span>
<a href="#l15.118"></a><span id="l15.118" class="difflineplus">+    ini = Cc[&quot;@mozilla.org/xpcom/ini-parser-factory;1&quot;]</span>
<a href="#l15.119"></a><span id="l15.119" class="difflineplus">+            .getService(Ci.nsIINIParserFactory)</span>
<a href="#l15.120"></a><span id="l15.120" class="difflineplus">+            .createINIParser(iniFile);</span>
<a href="#l15.121"></a><span id="l15.121" class="difflineplus">+  }</span>
<a href="#l15.122"></a><span id="l15.122" class="difflineplus">+  return ini;</span>
<a href="#l15.123"></a><span id="l15.123"> });</span>
<a href="#l15.124"></a><span id="l15.124"> </span>
<a href="#l15.125"></a><span id="l15.125" class="difflineminus">-XPCOMUtils.defineLazyGetter(TBDistCustomizer, &quot;_locale&quot;,</span>
<a href="#l15.126"></a><span id="l15.126" class="difflineminus">-  function TBDistCustomizer_get__locale() {</span>
<a href="#l15.127"></a><span id="l15.127" class="difflineminus">-    return Services.locale.requestedLocale;</span>
<a href="#l15.128"></a><span id="l15.128" class="difflineplus">+XPCOMUtils.defineLazyGetter(TBDistCustomizer, &quot;_locale&quot;, function() {</span>
<a href="#l15.129"></a><span id="l15.129" class="difflineplus">+  return Services.locale.requestedLocale;</span>
<a href="#l15.130"></a><span id="l15.130"> });</span>
<a href="#l15.131"></a><span id="l15.131"> </span>
<a href="#l15.132"></a><span id="l15.132"> function enumToObject(UTF8Enumerator) {</span>
<a href="#l15.133"></a><span id="l15.133">   let ret = {};</span>
<a href="#l15.134"></a><span id="l15.134">   while (UTF8Enumerator.hasMore()) {</span>
<a href="#l15.135"></a><span id="l15.135" class="difflineminus">-    ret[UTF8Enumerator.getNext()] = 1</span>
<a href="#l15.136"></a><span id="l15.136" class="difflineplus">+    ret[UTF8Enumerator.getNext()] = 1;</span>
<a href="#l15.137"></a><span id="l15.137">   }</span>
<a href="#l15.138"></a><span id="l15.138">   return ret;</span>
<a href="#l15.139"></a><span id="l15.139"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mail/base/modules/ThemeVariableMap.jsm</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mail/base/modules/ThemeVariableMap.jsm</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -5,85 +5,85 @@</span>
<a href="#l16.4"></a><span id="l16.4"> var EXPORTED_SYMBOLS = [&quot;ThemeVariableMap&quot;, &quot;ThemeContentPropertyList&quot;];</span>
<a href="#l16.5"></a><span id="l16.5"> </span>
<a href="#l16.6"></a><span id="l16.6"> function _isTextColorDark(r, g, b) {</span>
<a href="#l16.7"></a><span id="l16.7">   return (0.2125 * r + 0.7154 * g + 0.0721 * b) &lt;= 110;</span>
<a href="#l16.8"></a><span id="l16.8"> }</span>
<a href="#l16.9"></a><span id="l16.9"> </span>
<a href="#l16.10"></a><span id="l16.10"> const ThemeVariableMap = [</span>
<a href="#l16.11"></a><span id="l16.11">   [&quot;--lwt-accent-color-inactive&quot;, {</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-    lwtProperty: &quot;accentcolorInactive&quot;</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineplus">+    lwtProperty: &quot;accentcolorInactive&quot;,</span>
<a href="#l16.14"></a><span id="l16.14">   }],</span>
<a href="#l16.15"></a><span id="l16.15">   [&quot;--lwt-background-alignment&quot;, {</span>
<a href="#l16.16"></a><span id="l16.16">     isColor: false,</span>
<a href="#l16.17"></a><span id="l16.17" class="difflineminus">-    lwtProperty: &quot;backgroundsAlignment&quot;</span>
<a href="#l16.18"></a><span id="l16.18" class="difflineplus">+    lwtProperty: &quot;backgroundsAlignment&quot;,</span>
<a href="#l16.19"></a><span id="l16.19">   }],</span>
<a href="#l16.20"></a><span id="l16.20">   [&quot;--lwt-background-tiling&quot;, {</span>
<a href="#l16.21"></a><span id="l16.21">     isColor: false,</span>
<a href="#l16.22"></a><span id="l16.22" class="difflineminus">-    lwtProperty: &quot;backgroundsTiling&quot;</span>
<a href="#l16.23"></a><span id="l16.23" class="difflineplus">+    lwtProperty: &quot;backgroundsTiling&quot;,</span>
<a href="#l16.24"></a><span id="l16.24">   }],</span>
<a href="#l16.25"></a><span id="l16.25">   [&quot;--tab-loading-fill&quot;, {</span>
<a href="#l16.26"></a><span id="l16.26">     lwtProperty: &quot;tab_loading&quot;,</span>
<a href="#l16.27"></a><span id="l16.27">   }],</span>
<a href="#l16.28"></a><span id="l16.28">   [&quot;--lwt-tab-text&quot;, {</span>
<a href="#l16.29"></a><span id="l16.29" class="difflineminus">-    lwtProperty: &quot;tab_text&quot;</span>
<a href="#l16.30"></a><span id="l16.30" class="difflineplus">+    lwtProperty: &quot;tab_text&quot;,</span>
<a href="#l16.31"></a><span id="l16.31">   }],</span>
<a href="#l16.32"></a><span id="l16.32">   [&quot;--tab-line-color&quot;, {</span>
<a href="#l16.33"></a><span id="l16.33">     lwtProperty: &quot;tab_line&quot;,</span>
<a href="#l16.34"></a><span id="l16.34">   }],</span>
<a href="#l16.35"></a><span id="l16.35">   [&quot;--lwt-background-tab-separator-color&quot;, {</span>
<a href="#l16.36"></a><span id="l16.36">     lwtProperty: &quot;tab_background_separator&quot;,</span>
<a href="#l16.37"></a><span id="l16.37">   }],</span>
<a href="#l16.38"></a><span id="l16.38">   [&quot;--toolbar-bgcolor&quot;, {</span>
<a href="#l16.39"></a><span id="l16.39" class="difflineminus">-    lwtProperty: &quot;toolbarColor&quot;</span>
<a href="#l16.40"></a><span id="l16.40" class="difflineplus">+    lwtProperty: &quot;toolbarColor&quot;,</span>
<a href="#l16.41"></a><span id="l16.41">   }],</span>
<a href="#l16.42"></a><span id="l16.42">   [&quot;--toolbar-color&quot;, {</span>
<a href="#l16.43"></a><span id="l16.43" class="difflineminus">-    lwtProperty: &quot;toolbar_text&quot;</span>
<a href="#l16.44"></a><span id="l16.44" class="difflineplus">+    lwtProperty: &quot;toolbar_text&quot;,</span>
<a href="#l16.45"></a><span id="l16.45">   }],</span>
<a href="#l16.46"></a><span id="l16.46">   [&quot;--urlbar-separator-color&quot;, {</span>
<a href="#l16.47"></a><span id="l16.47" class="difflineminus">-    lwtProperty: &quot;toolbar_field_separator&quot;</span>
<a href="#l16.48"></a><span id="l16.48" class="difflineplus">+    lwtProperty: &quot;toolbar_field_separator&quot;,</span>
<a href="#l16.49"></a><span id="l16.49">   }],</span>
<a href="#l16.50"></a><span id="l16.50">   [&quot;--tabs-border-color&quot;, {</span>
<a href="#l16.51"></a><span id="l16.51">     lwtProperty: &quot;toolbar_top_separator&quot;,</span>
<a href="#l16.52"></a><span id="l16.52">   }],</span>
<a href="#l16.53"></a><span id="l16.53">   [&quot;--lwt-toolbar-vertical-separator&quot;, {</span>
<a href="#l16.54"></a><span id="l16.54" class="difflineminus">-    lwtProperty: &quot;toolbar_vertical_separator&quot;</span>
<a href="#l16.55"></a><span id="l16.55" class="difflineplus">+    lwtProperty: &quot;toolbar_vertical_separator&quot;,</span>
<a href="#l16.56"></a><span id="l16.56">   }],</span>
<a href="#l16.57"></a><span id="l16.57">   [&quot;--toolbox-border-bottom-color&quot;, {</span>
<a href="#l16.58"></a><span id="l16.58" class="difflineminus">-    lwtProperty: &quot;toolbar_bottom_separator&quot;</span>
<a href="#l16.59"></a><span id="l16.59" class="difflineplus">+    lwtProperty: &quot;toolbar_bottom_separator&quot;,</span>
<a href="#l16.60"></a><span id="l16.60">   }],</span>
<a href="#l16.61"></a><span id="l16.61">   [&quot;--lwt-toolbarbutton-icon-fill&quot;, {</span>
<a href="#l16.62"></a><span id="l16.62" class="difflineminus">-    lwtProperty: &quot;icon_color&quot;</span>
<a href="#l16.63"></a><span id="l16.63" class="difflineplus">+    lwtProperty: &quot;icon_color&quot;,</span>
<a href="#l16.64"></a><span id="l16.64">   }],</span>
<a href="#l16.65"></a><span id="l16.65">   [&quot;--lwt-toolbarbutton-icon-fill-attention&quot;, {</span>
<a href="#l16.66"></a><span id="l16.66" class="difflineminus">-    lwtProperty: &quot;icon_attention_color&quot;</span>
<a href="#l16.67"></a><span id="l16.67" class="difflineplus">+    lwtProperty: &quot;icon_attention_color&quot;,</span>
<a href="#l16.68"></a><span id="l16.68">   }],</span>
<a href="#l16.69"></a><span id="l16.69">   [&quot;--lwt-toolbarbutton-hover-background&quot;, {</span>
<a href="#l16.70"></a><span id="l16.70" class="difflineminus">-    lwtProperty: &quot;button_background_hover&quot;</span>
<a href="#l16.71"></a><span id="l16.71" class="difflineplus">+    lwtProperty: &quot;button_background_hover&quot;,</span>
<a href="#l16.72"></a><span id="l16.72">   }],</span>
<a href="#l16.73"></a><span id="l16.73">   [&quot;--lwt-toolbarbutton-active-background&quot;, {</span>
<a href="#l16.74"></a><span id="l16.74" class="difflineminus">-    lwtProperty: &quot;button_background_active&quot;</span>
<a href="#l16.75"></a><span id="l16.75" class="difflineplus">+    lwtProperty: &quot;button_background_active&quot;,</span>
<a href="#l16.76"></a><span id="l16.76">   }],</span>
<a href="#l16.77"></a><span id="l16.77">   [&quot;--lwt-selected-tab-background-color&quot;, {</span>
<a href="#l16.78"></a><span id="l16.78" class="difflineminus">-    lwtProperty: &quot;tab_selected&quot;</span>
<a href="#l16.79"></a><span id="l16.79" class="difflineplus">+    lwtProperty: &quot;tab_selected&quot;,</span>
<a href="#l16.80"></a><span id="l16.80">   }],</span>
<a href="#l16.81"></a><span id="l16.81">   [&quot;--autocomplete-popup-background&quot;, {</span>
<a href="#l16.82"></a><span id="l16.82" class="difflineminus">-    lwtProperty: &quot;popup&quot;</span>
<a href="#l16.83"></a><span id="l16.83" class="difflineplus">+    lwtProperty: &quot;popup&quot;,</span>
<a href="#l16.84"></a><span id="l16.84">   }],</span>
<a href="#l16.85"></a><span id="l16.85">   [&quot;--autocomplete-popup-color&quot;, {</span>
<a href="#l16.86"></a><span id="l16.86" class="difflineminus">-    lwtProperty: &quot;popup_text&quot;</span>
<a href="#l16.87"></a><span id="l16.87" class="difflineplus">+    lwtProperty: &quot;popup_text&quot;,</span>
<a href="#l16.88"></a><span id="l16.88">   }],</span>
<a href="#l16.89"></a><span id="l16.89">   [&quot;--autocomplete-popup-border-color&quot;, {</span>
<a href="#l16.90"></a><span id="l16.90" class="difflineminus">-    lwtProperty: &quot;popup_border&quot;</span>
<a href="#l16.91"></a><span id="l16.91" class="difflineplus">+    lwtProperty: &quot;popup_border&quot;,</span>
<a href="#l16.92"></a><span id="l16.92">   }],</span>
<a href="#l16.93"></a><span id="l16.93">   [&quot;--autocomplete-popup-highlight-background&quot;, {</span>
<a href="#l16.94"></a><span id="l16.94" class="difflineminus">-    lwtProperty: &quot;popup_highlight&quot;</span>
<a href="#l16.95"></a><span id="l16.95" class="difflineplus">+    lwtProperty: &quot;popup_highlight&quot;,</span>
<a href="#l16.96"></a><span id="l16.96">   }],</span>
<a href="#l16.97"></a><span id="l16.97">   [&quot;--autocomplete-popup-highlight-color&quot;, {</span>
<a href="#l16.98"></a><span id="l16.98" class="difflineminus">-    lwtProperty: &quot;popup_highlight_text&quot;</span>
<a href="#l16.99"></a><span id="l16.99" class="difflineplus">+    lwtProperty: &quot;popup_highlight_text&quot;,</span>
<a href="#l16.100"></a><span id="l16.100">   }],</span>
<a href="#l16.101"></a><span id="l16.101">   [&quot;--sidebar-background-color&quot;, {</span>
<a href="#l16.102"></a><span id="l16.102">     lwtProperty: &quot;sidebar&quot;,</span>
<a href="#l16.103"></a><span id="l16.103">   }],</span>
<a href="#l16.104"></a><span id="l16.104">   [&quot;--sidebar-text-color&quot;, {</span>
<a href="#l16.105"></a><span id="l16.105">     lwtProperty: &quot;sidebar_text&quot;,</span>
<a href="#l16.106"></a><span id="l16.106">     processColor(rgbaChannels, element) {</span>
<a href="#l16.107"></a><span id="l16.107">       if (!rgbaChannels) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mail/base/modules/Windows8WindowFrameColor.jsm</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mail/base/modules/Windows8WindowFrameColor.jsm</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -1,24 +1,22 @@</span>
<a href="#l17.4"></a><span id="l17.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l17.5"></a><span id="l17.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l17.6"></a><span id="l17.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l17.7"></a><span id="l17.7"> </span>
<a href="#l17.8"></a><span id="l17.8"> &quot;use strict&quot;;</span>
<a href="#l17.9"></a><span id="l17.9"> </span>
<a href="#l17.10"></a><span id="l17.10"> this.EXPORTED_SYMBOLS = [&quot;Windows8WindowFrameColor&quot;];</span>
<a href="#l17.11"></a><span id="l17.11"> </span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineminus">-ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineminus">-const { WindowsRegistry } = ChromeUtils.import(&quot;resource://gre/modules/WindowsRegistry.jsm&quot;, null);</span>
<a href="#l17.15"></a><span id="l17.15" class="difflineplus">+ChromeUtils.import(&quot;resource://gre/modules/WindowsRegistry.jsm&quot;);</span>
<a href="#l17.16"></a><span id="l17.16"> </span>
<a href="#l17.17"></a><span id="l17.17"> var Windows8WindowFrameColor = {</span>
<a href="#l17.18"></a><span id="l17.18">   _windowFrameColor: null,</span>
<a href="#l17.19"></a><span id="l17.19"> </span>
<a href="#l17.20"></a><span id="l17.20" class="difflineminus">-  get: function() {</span>
<a href="#l17.21"></a><span id="l17.21" class="difflineplus">+  get() {</span>
<a href="#l17.22"></a><span id="l17.22">     if (this._windowFrameColor)</span>
<a href="#l17.23"></a><span id="l17.23">       return this._windowFrameColor;</span>
<a href="#l17.24"></a><span id="l17.24"> </span>
<a href="#l17.25"></a><span id="l17.25">     const HKCU = Ci.nsIWindowsRegKey.ROOT_KEY_CURRENT_USER;</span>
<a href="#l17.26"></a><span id="l17.26">     const dwmKey = &quot;Software\\Microsoft\\Windows\\DWM&quot;;</span>
<a href="#l17.27"></a><span id="l17.27">     let customizationColor = WindowsRegistry.readRegKey(HKCU, dwmKey,</span>
<a href="#l17.28"></a><span id="l17.28">                                                         &quot;ColorizationColor&quot;);</span>
<a href="#l17.29"></a><span id="l17.29">     if (customizationColor == undefined) {</span>
<a href="#l17.30"></a><span id="l17.30" class="difflineat">@@ -27,17 +25,17 @@ var Windows8WindowFrameColor = {</span>
<a href="#l17.31"></a><span id="l17.31">     }</span>
<a href="#l17.32"></a><span id="l17.32"> </span>
<a href="#l17.33"></a><span id="l17.33">     // The color returned from the Registry is in decimal form.</span>
<a href="#l17.34"></a><span id="l17.34">     let customizationColorHex = customizationColor.toString(16);</span>
<a href="#l17.35"></a><span id="l17.35"> </span>
<a href="#l17.36"></a><span id="l17.36">     // Zero-pad the number just to make sure that it is 8 digits.</span>
<a href="#l17.37"></a><span id="l17.37">     customizationColorHex = (&quot;00000000&quot; + customizationColorHex).substr(-8);</span>
<a href="#l17.38"></a><span id="l17.38">     let customizationColorArray = customizationColorHex.match(/../g);</span>
<a href="#l17.39"></a><span id="l17.39" class="difflineminus">-    let [unused, fgR, fgG, fgB] = customizationColorArray.map(val =&gt; parseInt(val, 16));</span>
<a href="#l17.40"></a><span id="l17.40" class="difflineplus">+    let [, fgR, fgG, fgB] = customizationColorArray.map(val =&gt; parseInt(val, 16));</span>
<a href="#l17.41"></a><span id="l17.41">     let colorizationColorBalance = WindowsRegistry.readRegKey(HKCU, dwmKey,</span>
<a href="#l17.42"></a><span id="l17.42">                                                               &quot;ColorizationColorBalance&quot;);</span>
<a href="#l17.43"></a><span id="l17.43">     if (colorizationColorBalance == undefined) {</span>
<a href="#l17.44"></a><span id="l17.44">       colorizationColorBalance = 78;</span>
<a href="#l17.45"></a><span id="l17.45">     }</span>
<a href="#l17.46"></a><span id="l17.46"> </span>
<a href="#l17.47"></a><span id="l17.47">     // Window frame base color when Color Intensity is at 0, see bug 1004576.</span>
<a href="#l17.48"></a><span id="l17.48">     let frameBaseColor = 217;</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:33Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

