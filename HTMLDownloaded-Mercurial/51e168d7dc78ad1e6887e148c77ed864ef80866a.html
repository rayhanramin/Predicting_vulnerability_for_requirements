<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 19843:51e168d7dc78ad1e6887e148c77ed864ef80866a</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 51e168d7dc78ad1e6887e148c77ed864ef80866a" />
<meta property="og:url" content="/comm-central/rev/51e168d7dc78ad1e6887e148c77ed864ef80866a" />
<meta property="og:description" content="Bug 964070 - Support Jabber/XMPP Message Carbons (XEP-280). r=aleth" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 51e168d7dc78ad1e6887e148c77ed864ef80866a 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/51e168d7dc78ad1e6887e148c77ed864ef80866a">shortlog</a> |
<a href="/comm-central/log/51e168d7dc78ad1e6887e148c77ed864ef80866a">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/51e168d7dc78ad1e6887e148c77ed864ef80866a">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/51e168d7dc78ad1e6887e148c77ed864ef80866a">files</a> |
changeset |
<a href="/comm-central/raw-rev/51e168d7dc78ad1e6887e148c77ed864ef80866a">raw</a>  | <a href="/comm-central/archive/51e168d7dc78ad1e6887e148c77ed864ef80866a.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=964070">Bug 964070</a> - Support Jabber/XMPP Message Carbons (XEP-280). r=aleth
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#65;&#98;&#100;&#101;&#108;&#114;&#104;&#109;&#97;&#110;&#32;&#65;&#104;&#109;&#101;&#100;&#32;&#60;&#97;&#98;&#64;&#97;&#98;&#97;&#104;&#109;&#101;&#100;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Fri, 05 Aug 2016 17:19:48 +0200</td></tr>

<tr>
 <td>changeset 19843</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/51e168d7dc78ad1e6887e148c77ed864ef80866a">51e168d7dc78ad1e6887e148c77ed864ef80866a</a></td>
</tr>



<tr>
<td>parent 19842</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/8958f6e9f53709552e47aacb2a7ed620ffea3f09">8958f6e9f53709552e47aacb2a7ed620ffea3f09</a>
</td>
</tr>

<tr>
<td>child 19844</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/9ef2d357bda404a9d676ca04a1e3bfa51ae99fe2">9ef2d357bda404a9d676ca04a1e3bfa51ae99fe2</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=51e168d7dc78ad1e6887e148c77ed864ef80866a">12151</a></td></tr>
<tr><td>push user</td><td>ab@abahmed.com</td></tr>
<tr><td>push date</td><td class="date age">Fri, 05 Aug 2016 22:51:35 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@51e168d7dc78 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=51e168d7dc78ad1e6887e148c77ed864ef80866a">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=51e168d7dc78ad1e6887e148c77ed864ef80866a&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=51e168d7dc78ad1e6887e148c77ed864ef80866a&newProject=comm-central&newRevision=51e168d7dc78ad1e6887e148c77ed864ef80866a&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=51e168d7dc78ad1e6887e148c77ed864ef80866a&newProject=comm-central&newRevision=51e168d7dc78ad1e6887e148c77ed864ef80866a&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=51e168d7dc78ad1e6887e148c77ed864ef80866a&newProject=comm-central&newRevision=51e168d7dc78ad1e6887e148c77ed864ef80866a&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28aleth%29&revcount=50">aleth</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=964070">964070</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=964070">Bug 964070</a> - Support Jabber/XMPP Message Carbons (XEP-280). r=aleth</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/51e168d7dc78ad1e6887e148c77ed864ef80866a/chat/chat-prefs.js">chat/chat-prefs.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/51e168d7dc78ad1e6887e148c77ed864ef80866a/chat/chat-prefs.js">file</a> |
<a href="/comm-central/annotate/51e168d7dc78ad1e6887e148c77ed864ef80866a/chat/chat-prefs.js">annotate</a> |
<a href="/comm-central/diff/51e168d7dc78ad1e6887e148c77ed864ef80866a/chat/chat-prefs.js">diff</a> |
<a href="/comm-central/comparison/51e168d7dc78ad1e6887e148c77ed864ef80866a/chat/chat-prefs.js">comparison</a> |
<a href="/comm-central/log/51e168d7dc78ad1e6887e148c77ed864ef80866a/chat/chat-prefs.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/51e168d7dc78ad1e6887e148c77ed864ef80866a/chat/protocols/xmpp/xmpp-xml.jsm">chat/protocols/xmpp/xmpp-xml.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/51e168d7dc78ad1e6887e148c77ed864ef80866a/chat/protocols/xmpp/xmpp-xml.jsm">file</a> |
<a href="/comm-central/annotate/51e168d7dc78ad1e6887e148c77ed864ef80866a/chat/protocols/xmpp/xmpp-xml.jsm">annotate</a> |
<a href="/comm-central/diff/51e168d7dc78ad1e6887e148c77ed864ef80866a/chat/protocols/xmpp/xmpp-xml.jsm">diff</a> |
<a href="/comm-central/comparison/51e168d7dc78ad1e6887e148c77ed864ef80866a/chat/protocols/xmpp/xmpp-xml.jsm">comparison</a> |
<a href="/comm-central/log/51e168d7dc78ad1e6887e148c77ed864ef80866a/chat/protocols/xmpp/xmpp-xml.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/51e168d7dc78ad1e6887e148c77ed864ef80866a/chat/protocols/xmpp/xmpp.jsm">chat/protocols/xmpp/xmpp.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/51e168d7dc78ad1e6887e148c77ed864ef80866a/chat/protocols/xmpp/xmpp.jsm">file</a> |
<a href="/comm-central/annotate/51e168d7dc78ad1e6887e148c77ed864ef80866a/chat/protocols/xmpp/xmpp.jsm">annotate</a> |
<a href="/comm-central/diff/51e168d7dc78ad1e6887e148c77ed864ef80866a/chat/protocols/xmpp/xmpp.jsm">diff</a> |
<a href="/comm-central/comparison/51e168d7dc78ad1e6887e148c77ed864ef80866a/chat/protocols/xmpp/xmpp.jsm">comparison</a> |
<a href="/comm-central/log/51e168d7dc78ad1e6887e148c77ed864ef80866a/chat/protocols/xmpp/xmpp.jsm">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/chat/chat-prefs.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/chat/chat-prefs.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -75,16 +75,18 @@ pref(&quot;messenger.status.userIconFileName&quot;</span>
<a href="#l1.4"></a><span id="l1.4"> pref(&quot;messenger.status.userDisplayName&quot;, &quot;&quot;);</span>
<a href="#l1.5"></a><span id="l1.5"> </span>
<a href="#l1.6"></a><span id="l1.6"> // Default message used when quitting IRC. This is overridable per account.</span>
<a href="#l1.7"></a><span id="l1.7"> pref(&quot;chat.irc.defaultQuitMessage&quot;, &quot;&quot;);</span>
<a href="#l1.8"></a><span id="l1.8"> // If this is true, requestRooomInfo will return LIST results when it is</span>
<a href="#l1.9"></a><span id="l1.9"> // called automatically by the awesometab. Otherwise, requestRoomInfo will</span>
<a href="#l1.10"></a><span id="l1.10"> // only do so when explicitly requested by the user, e.g. via the /list command.</span>
<a href="#l1.11"></a><span id="l1.11"> pref(&quot;chat.irc.automaticList&quot;, true);</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+// Whether to enable or disable message carbons protocol (XEP-0280).</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+pref(&quot;chat.xmpp.messageCarbons&quot;, true);</span>
<a href="#l1.14"></a><span id="l1.14"> // Disable Skype until it can be tested further.</span>
<a href="#l1.15"></a><span id="l1.15"> pref(&quot;chat.prpls.prpl-skype.disable&quot;, true);</span>
<a href="#l1.16"></a><span id="l1.16"> // Disable Facebook as the XMPP gateway no longer exists.</span>
<a href="#l1.17"></a><span id="l1.17"> pref(&quot;chat.prpls.prpl-facebook.disable&quot;, true);</span>
<a href="#l1.18"></a><span id="l1.18"> // Whether to disable SRV lookups that use the system DNS library.</span>
<a href="#l1.19"></a><span id="l1.19"> pref(&quot;chat.dns.srv.disable&quot;, false);</span>
<a href="#l1.20"></a><span id="l1.20"> </span>
<a href="#l1.21"></a><span id="l1.21"> // loglevel is the minimum severity level that a libpurple message</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/chat/protocols/xmpp/xmpp-xml.jsm</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/chat/protocols/xmpp/xmpp-xml.jsm</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -55,16 +55,17 @@ var NS = {</span>
<a href="#l2.4"></a><span id="l2.4">   delay_legacy              : &quot;jabber:x:delay&quot;,</span>
<a href="#l2.5"></a><span id="l2.5">   bookmarks                 : &quot;storage:bookmarks&quot;,</span>
<a href="#l2.6"></a><span id="l2.6">   chatstates                : &quot;http://jabber.org/protocol/chatstates&quot;,</span>
<a href="#l2.7"></a><span id="l2.7">   event                     : &quot;jabber:x:event&quot;,</span>
<a href="#l2.8"></a><span id="l2.8">   stanzas                   : &quot;urn:ietf:params:xml:ns:xmpp-stanzas&quot;,</span>
<a href="#l2.9"></a><span id="l2.9">   vcard                     : &quot;vcard-temp&quot;,</span>
<a href="#l2.10"></a><span id="l2.10">   vcard_update              : &quot;vcard-temp:x:update&quot;,</span>
<a href="#l2.11"></a><span id="l2.11">   ping                      : &quot;urn:xmpp:ping&quot;,</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+  carbons                   : &quot;urn:xmpp:carbons:2&quot;,</span>
<a href="#l2.13"></a><span id="l2.13"> </span>
<a href="#l2.14"></a><span id="l2.14">   geoloc                    : &quot;http://jabber.org/protocol/geoloc&quot;,</span>
<a href="#l2.15"></a><span id="l2.15">   geoloc_notify             : &quot;http://jabber.org/protocol/geoloc+notify&quot;,</span>
<a href="#l2.16"></a><span id="l2.16">   mood                      : &quot;http://jabber.org/protocol/mood&quot;,</span>
<a href="#l2.17"></a><span id="l2.17">   tune                      : &quot;http://jabber.org/protocol/tune&quot;,</span>
<a href="#l2.18"></a><span id="l2.18">   nick                      : &quot;http://jabber.org/protocol/nick&quot;,</span>
<a href="#l2.19"></a><span id="l2.19">   nick_notify               : &quot;http://jabber.org/protocol/nick+notify&quot;,</span>
<a href="#l2.20"></a><span id="l2.20">   activity                  : &quot;http://jabber.org/protocol/activity&quot;,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/chat/protocols/xmpp/xmpp.jsm</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/chat/protocols/xmpp/xmpp.jsm</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -95,16 +95,35 @@ function _getDelay(aStanza) {</span>
<a href="#l3.4"></a><span id="l3.4">       date = new Date(delay.attributes[&quot;stamp&quot;]);</span>
<a href="#l3.5"></a><span id="l3.5">   }</span>
<a href="#l3.6"></a><span id="l3.6">   if (date &amp;&amp; isNaN(date.getTime()))</span>
<a href="#l3.7"></a><span id="l3.7">     return undefined;</span>
<a href="#l3.8"></a><span id="l3.8"> </span>
<a href="#l3.9"></a><span id="l3.9">   return date;</span>
<a href="#l3.10"></a><span id="l3.10"> }</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+// Writes aMsg in aConv as an outgoing message with optional date as the</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+// message may be sent from another client.</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+function _displaySentMsg(aConv, aMsg, aDate) {</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+  let who;</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+  if (aConv._account._connection)</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+    who = aConv._account._connection._jid.jid;</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineplus">+  if (!who)</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineplus">+    who = aConv._account.name;</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineplus">+</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineplus">+  let flags = {outgoing: true};</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineplus">+  flags._alias = aConv.account.alias || aConv.account.statusInfo.displayName;</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineplus">+</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineplus">+  if (aDate) {</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineplus">+    flags.time = aDate / 1000;</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineplus">+    flags.delayed = true;</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineplus">+  }</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineplus">+  aConv.writeMessage(who, aMsg, flags);</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineplus">+}</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineplus">+</span>
<a href="#l3.31"></a><span id="l3.31"> // The timespan after which we consider roomInfo to be stale.</span>
<a href="#l3.32"></a><span id="l3.32"> var kListRefreshInterval = 12 * 60 * 60 * 1000; // 12 hours.</span>
<a href="#l3.33"></a><span id="l3.33"> </span>
<a href="#l3.34"></a><span id="l3.34"> /* This is an ordered list, used to determine chat buddy flags:</span>
<a href="#l3.35"></a><span id="l3.35">  *  index &lt; member    -&gt; noFlags</span>
<a href="#l3.36"></a><span id="l3.36">  *  index = member    -&gt; voiced</span>
<a href="#l3.37"></a><span id="l3.37">  *          moderator -&gt; halfOp</span>
<a href="#l3.38"></a><span id="l3.38">  *          admin     -&gt; op</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineat">@@ -670,23 +689,17 @@ var XMPPConversationPrototype = {</span>
<a href="#l3.40"></a><span id="l3.40">   },</span>
<a href="#l3.41"></a><span id="l3.41"> </span>
<a href="#l3.42"></a><span id="l3.42">   /* Called when the user enters a chat message */</span>
<a href="#l3.43"></a><span id="l3.43">   sendMsg: function(aMsg) {</span>
<a href="#l3.44"></a><span id="l3.44">     this._cancelTypingTimer();</span>
<a href="#l3.45"></a><span id="l3.45">     let cs = this.shouldSendTypingNotifications ? &quot;active&quot; : null;</span>
<a href="#l3.46"></a><span id="l3.46">     let s = Stanza.message(this.to, aMsg, cs);</span>
<a href="#l3.47"></a><span id="l3.47">     this._account.sendStanza(s);</span>
<a href="#l3.48"></a><span id="l3.48" class="difflineminus">-    let who;</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineminus">-    if (this._account._connection)</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineminus">-      who = this._account._connection._jid.jid;</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineminus">-    if (!who)</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineminus">-      who = this._account.name;</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineminus">-    let alias = this.account.alias || this.account.statusInfo.displayName;</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineminus">-    this.writeMessage(who, aMsg, {outgoing: true, _alias: alias});</span>
<a href="#l3.55"></a><span id="l3.55" class="difflineplus">+    _displaySentMsg(this, aMsg);</span>
<a href="#l3.56"></a><span id="l3.56">     delete this._typingState;</span>
<a href="#l3.57"></a><span id="l3.57">   },</span>
<a href="#l3.58"></a><span id="l3.58"> </span>
<a href="#l3.59"></a><span id="l3.59">   // Invites the contact to a MUC room.</span>
<a href="#l3.60"></a><span id="l3.60">   invite: function(aRoomJid, aPassword = null) {</span>
<a href="#l3.61"></a><span id="l3.61">     // XEP-0045 (7.8): Inviting Another User to a Room.</span>
<a href="#l3.62"></a><span id="l3.62">     // XEP-0045 (7.8.1) and XEP-0249: Direct Invitation.</span>
<a href="#l3.63"></a><span id="l3.63">     let x = Stanza.node(&quot;x&quot;, Stanza.NS.conference, {jid: aRoomJid,</span>
<a href="#l3.64"></a><span id="l3.64" class="difflineat">@@ -1161,16 +1174,20 @@ var XMPPAccountPrototype = {</span>
<a href="#l3.65"></a><span id="l3.65">   get isRoomInfoStale() { return Date.now() - this._lastListTime &gt; kListRefreshInterval; },</span>
<a href="#l3.66"></a><span id="l3.66"> </span>
<a href="#l3.67"></a><span id="l3.67">   // If true, we are waiting for replies.</span>
<a href="#l3.68"></a><span id="l3.68">   _pendingList: false,</span>
<a href="#l3.69"></a><span id="l3.69"> </span>
<a href="#l3.70"></a><span id="l3.70">   // An array of jids for which we still need to request vCards.</span>
<a href="#l3.71"></a><span id="l3.71">   _pendingVCardRequests: [],</span>
<a href="#l3.72"></a><span id="l3.72"> </span>
<a href="#l3.73"></a><span id="l3.73" class="difflineplus">+  // XEP-0280: Message Carbons.</span>
<a href="#l3.74"></a><span id="l3.74" class="difflineplus">+  // If true, message carbons are currently enabled.</span>
<a href="#l3.75"></a><span id="l3.75" class="difflineplus">+  _isCarbonsEnabled: false,</span>
<a href="#l3.76"></a><span id="l3.76" class="difflineplus">+</span>
<a href="#l3.77"></a><span id="l3.77">   /* Generate unique id for a stanza. Using id and unique sid is defined in</span>
<a href="#l3.78"></a><span id="l3.78">    * RFC 6120 (Section 8.2.3, 4.7.3).</span>
<a href="#l3.79"></a><span id="l3.79">    */</span>
<a href="#l3.80"></a><span id="l3.80">   generateId: () =&gt; UuidGenerator.generateUUID().toString().slice(1, -1),</span>
<a href="#l3.81"></a><span id="l3.81"> </span>
<a href="#l3.82"></a><span id="l3.82">   _init: function(aProtoInstance, aImAccount) {</span>
<a href="#l3.83"></a><span id="l3.83">     GenericAccountPrototype._init.call(this, aProtoInstance, aImAccount);</span>
<a href="#l3.84"></a><span id="l3.84"> </span>
<a href="#l3.85"></a><span id="l3.85" class="difflineat">@@ -1664,16 +1681,21 @@ var XMPPAccountPrototype = {</span>
<a href="#l3.86"></a><span id="l3.86">     let s = Stanza.iq(&quot;get&quot;, null, null, Stanza.node(&quot;query&quot;, Stanza.NS.roster));</span>
<a href="#l3.87"></a><span id="l3.87">     this.sendStanza(s, this.onRoster, this);</span>
<a href="#l3.88"></a><span id="l3.88"> </span>
<a href="#l3.89"></a><span id="l3.89">     // XEP-0030 and XEP-0045 (6): Service Discovery.</span>
<a href="#l3.90"></a><span id="l3.90">     // Queries Server for Associated Services.</span>
<a href="#l3.91"></a><span id="l3.91">     let iq = Stanza.iq(&quot;get&quot;, null, this._jid.domain,</span>
<a href="#l3.92"></a><span id="l3.92">                        Stanza.node(&quot;query&quot;, Stanza.NS.disco_items));</span>
<a href="#l3.93"></a><span id="l3.93">     this.sendStanza(iq, this.onServiceDiscovery, this);</span>
<a href="#l3.94"></a><span id="l3.94" class="difflineplus">+</span>
<a href="#l3.95"></a><span id="l3.95" class="difflineplus">+    // XEP-0030: Service Discovery Information Features.</span>
<a href="#l3.96"></a><span id="l3.96" class="difflineplus">+    iq = Stanza.iq(&quot;get&quot;, null, this._jid.domain,</span>
<a href="#l3.97"></a><span id="l3.97" class="difflineplus">+                       Stanza.node(&quot;query&quot;, Stanza.NS.disco_info));</span>
<a href="#l3.98"></a><span id="l3.98" class="difflineplus">+    this.sendStanza(iq, this.onServiceDiscoveryInfo, this);</span>
<a href="#l3.99"></a><span id="l3.99">   },</span>
<a href="#l3.100"></a><span id="l3.100"> </span>
<a href="#l3.101"></a><span id="l3.101">   /* Called whenever a stanza is received */</span>
<a href="#l3.102"></a><span id="l3.102">   onXmppStanza: function(aStanza) {</span>
<a href="#l3.103"></a><span id="l3.103">   },</span>
<a href="#l3.104"></a><span id="l3.104"> </span>
<a href="#l3.105"></a><span id="l3.105">   /* Called when a iq stanza is received */</span>
<a href="#l3.106"></a><span id="l3.106">   onIQStanza: function(aStanza) {</span>
<a href="#l3.107"></a><span id="l3.107" class="difflineat">@@ -1798,26 +1820,70 @@ var XMPPAccountPrototype = {</span>
<a href="#l3.108"></a><span id="l3.108">         let from = receivedStanza.attributes[&quot;from&quot;];</span>
<a href="#l3.109"></a><span id="l3.109">         if (aStanza.attributes[&quot;type&quot;] != &quot;result&quot; || !query ||</span>
<a href="#l3.110"></a><span id="l3.110">             query.uri != Stanza.NS.disco_info) {</span>
<a href="#l3.111"></a><span id="l3.111">           this.LOG(&quot;Could not get features for this service: &quot; + from);</span>
<a href="#l3.112"></a><span id="l3.112">           return true;</span>
<a href="#l3.113"></a><span id="l3.113">         }</span>
<a href="#l3.114"></a><span id="l3.114">         let features = query.getElements([&quot;feature&quot;])</span>
<a href="#l3.115"></a><span id="l3.115">                             .map(elt =&gt; elt.attributes[&quot;var&quot;]);</span>
<a href="#l3.116"></a><span id="l3.116" class="difflineminus">-        if (features.indexOf(Stanza.NS.muc) != -1) {</span>
<a href="#l3.117"></a><span id="l3.117" class="difflineplus">+        if (features.includes(Stanza.NS.muc)) {</span>
<a href="#l3.118"></a><span id="l3.118">           // XEP-0045 (6.2): this feature is for a MUC Service.</span>
<a href="#l3.119"></a><span id="l3.119">           this._mucService = from;</span>
<a href="#l3.120"></a><span id="l3.120">         }</span>
<a href="#l3.121"></a><span id="l3.121">         // TODO: Handle other services that are supported by XMPP through</span>
<a href="#l3.122"></a><span id="l3.122">         // their features.</span>
<a href="#l3.123"></a><span id="l3.123"> </span>
<a href="#l3.124"></a><span id="l3.124">         return true;</span>
<a href="#l3.125"></a><span id="l3.125">       });</span>
<a href="#l3.126"></a><span id="l3.126">     });</span>
<a href="#l3.127"></a><span id="l3.127" class="difflineplus">+    return true;</span>
<a href="#l3.128"></a><span id="l3.128" class="difflineplus">+  },</span>
<a href="#l3.129"></a><span id="l3.129" class="difflineplus">+</span>
<a href="#l3.130"></a><span id="l3.130" class="difflineplus">+  // XEP-0030: Discovering Service Information and its features that are</span>
<a href="#l3.131"></a><span id="l3.131" class="difflineplus">+  // supported by the server.</span>
<a href="#l3.132"></a><span id="l3.132" class="difflineplus">+  onServiceDiscoveryInfo: function(aStanza) {</span>
<a href="#l3.133"></a><span id="l3.133" class="difflineplus">+    let query = aStanza.getElement([&quot;query&quot;]);</span>
<a href="#l3.134"></a><span id="l3.134" class="difflineplus">+    if (aStanza.attributes[&quot;type&quot;] != &quot;result&quot; || !query ||</span>
<a href="#l3.135"></a><span id="l3.135" class="difflineplus">+        query.uri != Stanza.NS.disco_info) {</span>
<a href="#l3.136"></a><span id="l3.136" class="difflineplus">+      this.LOG(&quot;Could not get features for this server: &quot; + this._jid.domain);</span>
<a href="#l3.137"></a><span id="l3.137" class="difflineplus">+      return true;</span>
<a href="#l3.138"></a><span id="l3.138" class="difflineplus">+    }</span>
<a href="#l3.139"></a><span id="l3.139" class="difflineplus">+</span>
<a href="#l3.140"></a><span id="l3.140" class="difflineplus">+    let features = query.getElements([&quot;feature&quot;])</span>
<a href="#l3.141"></a><span id="l3.141" class="difflineplus">+                        .map(elt =&gt; elt.attributes[&quot;var&quot;]);</span>
<a href="#l3.142"></a><span id="l3.142" class="difflineplus">+    if (features.includes(Stanza.NS.carbons)) {</span>
<a href="#l3.143"></a><span id="l3.143" class="difflineplus">+      // XEP-0280: Message Carbons.</span>
<a href="#l3.144"></a><span id="l3.144" class="difflineplus">+      // Enabling Carbons on server, as it's disabled by default on server.</span>
<a href="#l3.145"></a><span id="l3.145" class="difflineplus">+      if (Services.prefs.getBoolPref(&quot;chat.xmpp.messageCarbons&quot;)) {</span>
<a href="#l3.146"></a><span id="l3.146" class="difflineplus">+        let iqStanza = Stanza.iq(&quot;set&quot;, null, null,</span>
<a href="#l3.147"></a><span id="l3.147" class="difflineplus">+                                 Stanza.node(&quot;enable&quot;, Stanza.NS.carbons));</span>
<a href="#l3.148"></a><span id="l3.148" class="difflineplus">+        this.sendStanza(iqStanza, aStanza =&gt; {</span>
<a href="#l3.149"></a><span id="l3.149" class="difflineplus">+          let error = this.parseError(aStanza);</span>
<a href="#l3.150"></a><span id="l3.150" class="difflineplus">+          if (error) {</span>
<a href="#l3.151"></a><span id="l3.151" class="difflineplus">+            this.WARN(&quot;Unable to enable message carbons due to &quot; +</span>
<a href="#l3.152"></a><span id="l3.152" class="difflineplus">+                      error.condition + &quot; error.&quot;);</span>
<a href="#l3.153"></a><span id="l3.153" class="difflineplus">+            return true;</span>
<a href="#l3.154"></a><span id="l3.154" class="difflineplus">+          }</span>
<a href="#l3.155"></a><span id="l3.155" class="difflineplus">+</span>
<a href="#l3.156"></a><span id="l3.156" class="difflineplus">+          let type = aStanza.attributes[&quot;type&quot;];</span>
<a href="#l3.157"></a><span id="l3.157" class="difflineplus">+          if (type != &quot;result&quot;) {</span>
<a href="#l3.158"></a><span id="l3.158" class="difflineplus">+            this.WARN(&quot;Received unexpected stanza with &quot; + type + &quot; type &quot; +</span>
<a href="#l3.159"></a><span id="l3.159" class="difflineplus">+                      &quot;while enabling message carbons.&quot;);</span>
<a href="#l3.160"></a><span id="l3.160" class="difflineplus">+            return true;</span>
<a href="#l3.161"></a><span id="l3.161" class="difflineplus">+          }</span>
<a href="#l3.162"></a><span id="l3.162" class="difflineplus">+</span>
<a href="#l3.163"></a><span id="l3.163" class="difflineplus">+          this.LOG(&quot;Message carbons enabled.&quot;);</span>
<a href="#l3.164"></a><span id="l3.164" class="difflineplus">+          this._isCarbonsEnabled = true;</span>
<a href="#l3.165"></a><span id="l3.165" class="difflineplus">+          return true;</span>
<a href="#l3.166"></a><span id="l3.166" class="difflineplus">+        });</span>
<a href="#l3.167"></a><span id="l3.167" class="difflineplus">+      }</span>
<a href="#l3.168"></a><span id="l3.168" class="difflineplus">+    }</span>
<a href="#l3.169"></a><span id="l3.169" class="difflineplus">+    // TODO: Handle other features that are supported by the server.</span>
<a href="#l3.170"></a><span id="l3.170" class="difflineplus">+    return true;</span>
<a href="#l3.171"></a><span id="l3.171">   },</span>
<a href="#l3.172"></a><span id="l3.172"> </span>
<a href="#l3.173"></a><span id="l3.173">   requestRoomInfo: function(aCallback) {</span>
<a href="#l3.174"></a><span id="l3.174">     if (this._roomInfoCallbacks.has(aCallback))</span>
<a href="#l3.175"></a><span id="l3.175">       return;</span>
<a href="#l3.176"></a><span id="l3.176"> </span>
<a href="#l3.177"></a><span id="l3.177">     if (this.isRoomInfoStale &amp;&amp; !this._pendingList) {</span>
<a href="#l3.178"></a><span id="l3.178">       this._roomList = new Map();</span>
<a href="#l3.179"></a><span id="l3.179" class="difflineat">@@ -1930,19 +1996,46 @@ var XMPPAccountPrototype = {</span>
<a href="#l3.180"></a><span id="l3.180">         return retVal;</span>
<a href="#l3.181"></a><span id="l3.181">       }</span>
<a href="#l3.182"></a><span id="l3.182"> </span>
<a href="#l3.183"></a><span id="l3.183">       return null;</span>
<a href="#l3.184"></a><span id="l3.184">   },</span>
<a href="#l3.185"></a><span id="l3.185"> </span>
<a href="#l3.186"></a><span id="l3.186">   /* Called when a message stanza is received */</span>
<a href="#l3.187"></a><span id="l3.187">   onMessageStanza: function(aStanza) {</span>
<a href="#l3.188"></a><span id="l3.188" class="difflineminus">-    let from = aStanza.attributes[&quot;from&quot;];</span>
<a href="#l3.189"></a><span id="l3.189" class="difflineminus">-    let norm = this.normalize(from);</span>
<a href="#l3.190"></a><span id="l3.190" class="difflineminus">-    let isMuc = this._mucs.has(norm);</span>
<a href="#l3.191"></a><span id="l3.191" class="difflineplus">+    // XEP-0280: Message Carbons.</span>
<a href="#l3.192"></a><span id="l3.192" class="difflineplus">+    // Sending and Receiving Messages.</span>
<a href="#l3.193"></a><span id="l3.193" class="difflineplus">+    // Indicates that the forwarded message was sent or received.</span>
<a href="#l3.194"></a><span id="l3.194" class="difflineplus">+    let isSent = false;</span>
<a href="#l3.195"></a><span id="l3.195" class="difflineplus">+    let carbonStanza =</span>
<a href="#l3.196"></a><span id="l3.196" class="difflineplus">+      aStanza.getElement([&quot;sent&quot;]) || aStanza.getElement([&quot;received&quot;]);</span>
<a href="#l3.197"></a><span id="l3.197" class="difflineplus">+    if (carbonStanza) {</span>
<a href="#l3.198"></a><span id="l3.198" class="difflineplus">+      if (carbonStanza.uri != Stanza.NS.carbons) {</span>
<a href="#l3.199"></a><span id="l3.199" class="difflineplus">+        this.WARN(&quot;Received a forwarded message which does not '&quot; +</span>
<a href="#l3.200"></a><span id="l3.200" class="difflineplus">+                  Stanza.NS.carbons + &quot;' namespace.&quot;);</span>
<a href="#l3.201"></a><span id="l3.201" class="difflineplus">+        return;</span>
<a href="#l3.202"></a><span id="l3.202" class="difflineplus">+      }</span>
<a href="#l3.203"></a><span id="l3.203" class="difflineplus">+</span>
<a href="#l3.204"></a><span id="l3.204" class="difflineplus">+      isSent = carbonStanza.localName == &quot;sent&quot;;</span>
<a href="#l3.205"></a><span id="l3.205" class="difflineplus">+      carbonStanza = carbonStanza.getElement([&quot;forwarded&quot;, &quot;message&quot;]);</span>
<a href="#l3.206"></a><span id="l3.206" class="difflineplus">+      if (this._isCarbonsEnabled)</span>
<a href="#l3.207"></a><span id="l3.207" class="difflineplus">+        aStanza = carbonStanza;</span>
<a href="#l3.208"></a><span id="l3.208" class="difflineplus">+      else {</span>
<a href="#l3.209"></a><span id="l3.209" class="difflineplus">+        this.WARN(&quot;Received an unexpected forwarded message while message &quot; +</span>
<a href="#l3.210"></a><span id="l3.210" class="difflineplus">+                  &quot;carbons are not enabled.&quot;);</span>
<a href="#l3.211"></a><span id="l3.211" class="difflineplus">+        return;</span>
<a href="#l3.212"></a><span id="l3.212" class="difflineplus">+      }</span>
<a href="#l3.213"></a><span id="l3.213" class="difflineplus">+    }</span>
<a href="#l3.214"></a><span id="l3.214" class="difflineplus">+</span>
<a href="#l3.215"></a><span id="l3.215" class="difflineplus">+    // For forwarded sent messages, we need to use &quot;to&quot; attribute to</span>
<a href="#l3.216"></a><span id="l3.216" class="difflineplus">+    // get the right conversation as from in this case is this account.</span>
<a href="#l3.217"></a><span id="l3.217" class="difflineplus">+    let convJid = isSent ? aStanza.attributes[&quot;to&quot;] : aStanza.attributes[&quot;from&quot;];</span>
<a href="#l3.218"></a><span id="l3.218" class="difflineplus">+</span>
<a href="#l3.219"></a><span id="l3.219" class="difflineplus">+    let normConvJid = this.normalize(convJid);</span>
<a href="#l3.220"></a><span id="l3.220" class="difflineplus">+    let isMuc = this._mucs.has(normConvJid);</span>
<a href="#l3.221"></a><span id="l3.221"> </span>
<a href="#l3.222"></a><span id="l3.222">     let type = aStanza.attributes[&quot;type&quot;];</span>
<a href="#l3.223"></a><span id="l3.223">     let x = aStanza.getElement([&quot;x&quot;]);</span>
<a href="#l3.224"></a><span id="l3.224">     let body;</span>
<a href="#l3.225"></a><span id="l3.225">     let b = aStanza.getElement([&quot;body&quot;]);</span>
<a href="#l3.226"></a><span id="l3.226">     if (b) {</span>
<a href="#l3.227"></a><span id="l3.227">       // If there's a &lt;body&gt; child we have more than just typing notifications.</span>
<a href="#l3.228"></a><span id="l3.228">       // Prefer HTML (in &lt;html&gt;&lt;body&gt;) and use plain text (&lt;body&gt;) as fallback.</span>
<a href="#l3.229"></a><span id="l3.229" class="difflineat">@@ -1964,18 +2057,18 @@ var XMPPAccountPrototype = {</span>
<a href="#l3.230"></a><span id="l3.230">     // stanzas.</span>
<a href="#l3.231"></a><span id="l3.231">     if (subject &amp;&amp; isMuc) {</span>
<a href="#l3.232"></a><span id="l3.232">       // XEP-0045 (7.2.16): Check for a subject element in the stanza and update</span>
<a href="#l3.233"></a><span id="l3.233">       // the topic if it exists.</span>
<a href="#l3.234"></a><span id="l3.234">       // We are breaking the spec because only a message that contains a</span>
<a href="#l3.235"></a><span id="l3.235">       // &lt;subject/&gt; but no &lt;body/&gt; element shall be considered a subject change</span>
<a href="#l3.236"></a><span id="l3.236">       // for MUC, but we ignore that to be compatible with ejabberd versions</span>
<a href="#l3.237"></a><span id="l3.237">       // before 15.06.</span>
<a href="#l3.238"></a><span id="l3.238" class="difflineminus">-      let muc = this._mucs.get(norm);</span>
<a href="#l3.239"></a><span id="l3.239" class="difflineminus">-      let nick = this._parseJID(from).resource;</span>
<a href="#l3.240"></a><span id="l3.240" class="difflineplus">+      let muc = this._mucs.get(normConvJid);</span>
<a href="#l3.241"></a><span id="l3.241" class="difflineplus">+      let nick = this._parseJID(convJid).resource;</span>
<a href="#l3.242"></a><span id="l3.242">       // TODO There can be multiple subject elements with different xml:lang</span>
<a href="#l3.243"></a><span id="l3.243">       // attributes.</span>
<a href="#l3.244"></a><span id="l3.244">       muc.setTopic(subject.innerText, nick);</span>
<a href="#l3.245"></a><span id="l3.245">       return;</span>
<a href="#l3.246"></a><span id="l3.246">     }</span>
<a href="#l3.247"></a><span id="l3.247"> </span>
<a href="#l3.248"></a><span id="l3.248">     let invitation = this.parseInvitation(aStanza);</span>
<a href="#l3.249"></a><span id="l3.249">     if (invitation) {</span>
<a href="#l3.250"></a><span id="l3.250" class="difflineat">@@ -2005,48 +2098,57 @@ var XMPPAccountPrototype = {</span>
<a href="#l3.251"></a><span id="l3.251">         if (conv)</span>
<a href="#l3.252"></a><span id="l3.252">           conv.writeMessage(invitation.from, message, {system: true});</span>
<a href="#l3.253"></a><span id="l3.253">       }</span>
<a href="#l3.254"></a><span id="l3.254">     }</span>
<a href="#l3.255"></a><span id="l3.255"> </span>
<a href="#l3.256"></a><span id="l3.256">     if (body) {</span>
<a href="#l3.257"></a><span id="l3.257">       let date = _getDelay(aStanza);</span>
<a href="#l3.258"></a><span id="l3.258">       if (type == &quot;groupchat&quot; ||</span>
<a href="#l3.259"></a><span id="l3.259" class="difflineminus">-          (type == &quot;error&quot; &amp;&amp; isMuc &amp;&amp; !this._conv.has(from))) {</span>
<a href="#l3.260"></a><span id="l3.260" class="difflineplus">+          (type == &quot;error&quot; &amp;&amp; isMuc &amp;&amp; !this._conv.has(convJid))) {</span>
<a href="#l3.261"></a><span id="l3.261">         if (!isMuc) {</span>
<a href="#l3.262"></a><span id="l3.262" class="difflineminus">-          this.WARN(&quot;Received a groupchat message for unknown MUC &quot; + norm);</span>
<a href="#l3.263"></a><span id="l3.263" class="difflineplus">+          this.WARN(&quot;Received a groupchat message for unknown MUC &quot; + normConvJid);</span>
<a href="#l3.264"></a><span id="l3.264">           return;</span>
<a href="#l3.265"></a><span id="l3.265">         }</span>
<a href="#l3.266"></a><span id="l3.266" class="difflineminus">-        let muc = this._mucs.get(norm);</span>
<a href="#l3.267"></a><span id="l3.267" class="difflineplus">+        let muc = this._mucs.get(normConvJid);</span>
<a href="#l3.268"></a><span id="l3.268">         muc.incomingMessage(body, aStanza, date);</span>
<a href="#l3.269"></a><span id="l3.269">         return;</span>
<a href="#l3.270"></a><span id="l3.270">       }</span>
<a href="#l3.271"></a><span id="l3.271"> </span>
<a href="#l3.272"></a><span id="l3.272" class="difflineminus">-      let conv = this.createConversation(from);</span>
<a href="#l3.273"></a><span id="l3.273" class="difflineplus">+      let conv = this.createConversation(convJid);</span>
<a href="#l3.274"></a><span id="l3.274">       if (!conv)</span>
<a href="#l3.275"></a><span id="l3.275">         return;</span>
<a href="#l3.276"></a><span id="l3.276" class="difflineplus">+</span>
<a href="#l3.277"></a><span id="l3.277" class="difflineplus">+      if (isSent) {</span>
<a href="#l3.278"></a><span id="l3.278" class="difflineplus">+        _displaySentMsg(conv, body, date);</span>
<a href="#l3.279"></a><span id="l3.279" class="difflineplus">+        return;</span>
<a href="#l3.280"></a><span id="l3.280" class="difflineplus">+      }</span>
<a href="#l3.281"></a><span id="l3.281">       conv.incomingMessage(body, aStanza, date);</span>
<a href="#l3.282"></a><span id="l3.282">     }</span>
<a href="#l3.283"></a><span id="l3.283">     else if (type == &quot;error&quot;) {</span>
<a href="#l3.284"></a><span id="l3.284" class="difflineminus">-      let conv = this.createConversation(from);</span>
<a href="#l3.285"></a><span id="l3.285" class="difflineplus">+      let conv = this.createConversation(convJid);</span>
<a href="#l3.286"></a><span id="l3.286">       if (conv)</span>
<a href="#l3.287"></a><span id="l3.287">         conv.incomingMessage(null, aStanza);</span>
<a href="#l3.288"></a><span id="l3.288">     }</span>
<a href="#l3.289"></a><span id="l3.289">     else if (x &amp;&amp; x.uri == Stanza.NS.muc_user) {</span>
<a href="#l3.290"></a><span id="l3.290" class="difflineminus">-      let muc = this._mucs.get(norm);</span>
<a href="#l3.291"></a><span id="l3.291" class="difflineplus">+      let muc = this._mucs.get(normConvJid);</span>
<a href="#l3.292"></a><span id="l3.292">       if (!muc) {</span>
<a href="#l3.293"></a><span id="l3.293" class="difflineminus">-        this.WARN(&quot;Received a groupchat message for unknown MUC &quot; + norm);</span>
<a href="#l3.294"></a><span id="l3.294" class="difflineplus">+        this.WARN(&quot;Received a groupchat message for unknown MUC &quot; + normConvJid);</span>
<a href="#l3.295"></a><span id="l3.295">         return;</span>
<a href="#l3.296"></a><span id="l3.296">       }</span>
<a href="#l3.297"></a><span id="l3.297">       muc.onMessageStanza(aStanza);</span>
<a href="#l3.298"></a><span id="l3.298">       return;</span>
<a href="#l3.299"></a><span id="l3.299">     }</span>
<a href="#l3.300"></a><span id="l3.300"> </span>
<a href="#l3.301"></a><span id="l3.301" class="difflineplus">+    // If this is a sent message carbon, the user is typing on another client.</span>
<a href="#l3.302"></a><span id="l3.302" class="difflineplus">+    if (isSent)</span>
<a href="#l3.303"></a><span id="l3.303" class="difflineplus">+      return;</span>
<a href="#l3.304"></a><span id="l3.304" class="difflineplus">+</span>
<a href="#l3.305"></a><span id="l3.305">     // Don't create a conversation to only display the typing notifications.</span>
<a href="#l3.306"></a><span id="l3.306" class="difflineminus">-    if (!this._conv.has(norm) &amp;&amp; !this._conv.has(from))</span>
<a href="#l3.307"></a><span id="l3.307" class="difflineplus">+    if (!this._conv.has(normConvJid) &amp;&amp; !this._conv.has(convJid))</span>
<a href="#l3.308"></a><span id="l3.308">       return;</span>
<a href="#l3.309"></a><span id="l3.309"> </span>
<a href="#l3.310"></a><span id="l3.310">     // Ignore errors while delivering typing notifications.</span>
<a href="#l3.311"></a><span id="l3.311">     if (type == &quot;error&quot;)</span>
<a href="#l3.312"></a><span id="l3.312">       return;</span>
<a href="#l3.313"></a><span id="l3.313"> </span>
<a href="#l3.314"></a><span id="l3.314">     let typingState = Ci.prplIConvIM.NOT_TYPING;</span>
<a href="#l3.315"></a><span id="l3.315">     let state;</span>
<a href="#l3.316"></a><span id="l3.316" class="difflineat">@@ -2055,19 +2157,23 @@ var XMPPAccountPrototype = {</span>
<a href="#l3.317"></a><span id="l3.317">       state = s[0].localName;</span>
<a href="#l3.318"></a><span id="l3.318">     if (state) {</span>
<a href="#l3.319"></a><span id="l3.319">       this.DEBUG(state);</span>
<a href="#l3.320"></a><span id="l3.320">       if (state == &quot;composing&quot;)</span>
<a href="#l3.321"></a><span id="l3.321">         typingState = Ci.prplIConvIM.TYPING;</span>
<a href="#l3.322"></a><span id="l3.322">       else if (state == &quot;paused&quot;)</span>
<a href="#l3.323"></a><span id="l3.323">         typingState = Ci.prplIConvIM.TYPED;</span>
<a href="#l3.324"></a><span id="l3.324">     }</span>
<a href="#l3.325"></a><span id="l3.325" class="difflineminus">-    let convName = norm;</span>
<a href="#l3.326"></a><span id="l3.326" class="difflineplus">+    let convName = normConvJid;</span>
<a href="#l3.327"></a><span id="l3.327" class="difflineplus">+</span>
<a href="#l3.328"></a><span id="l3.328" class="difflineplus">+    // If the bare JID is a MUC that we have joined, use the full JID as this</span>
<a href="#l3.329"></a><span id="l3.329" class="difflineplus">+    // is a private message to a MUC participant.</span>
<a href="#l3.330"></a><span id="l3.330">     if (isMuc)</span>
<a href="#l3.331"></a><span id="l3.331" class="difflineminus">-      convName = from;</span>
<a href="#l3.332"></a><span id="l3.332" class="difflineplus">+      convName = convJid;</span>
<a href="#l3.333"></a><span id="l3.333" class="difflineplus">+</span>
<a href="#l3.334"></a><span id="l3.334">     let conv = this._conv.get(convName);</span>
<a href="#l3.335"></a><span id="l3.335">     if (!conv)</span>
<a href="#l3.336"></a><span id="l3.336">       return;</span>
<a href="#l3.337"></a><span id="l3.337">     conv.updateTyping(typingState, conv.shortName);</span>
<a href="#l3.338"></a><span id="l3.338">     conv.supportChatStateNotifications = !!state;</span>
<a href="#l3.339"></a><span id="l3.339">   },</span>
<a href="#l3.340"></a><span id="l3.340"> </span>
<a href="#l3.341"></a><span id="l3.341">   /* Called when there is an error in the xmpp session */</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

