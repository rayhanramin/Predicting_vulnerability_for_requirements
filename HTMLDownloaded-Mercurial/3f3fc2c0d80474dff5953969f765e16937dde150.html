<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 28729:3f3fc2c0d80474dff5953969f765e16937dde150</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 3f3fc2c0d80474dff5953969f765e16937dde150" />
<meta property="og:url" content="/comm-central/rev/3f3fc2c0d80474dff5953969f765e16937dde150" />
<meta property="og:description" content="Bug 1614237 - Remove legacy extensions API. r=mkmelin" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 3f3fc2c0d80474dff5953969f765e16937dde150 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/3f3fc2c0d80474dff5953969f765e16937dde150">shortlog</a> |
<a href="/comm-central/log/3f3fc2c0d80474dff5953969f765e16937dde150">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/3f3fc2c0d80474dff5953969f765e16937dde150">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/3f3fc2c0d80474dff5953969f765e16937dde150">files</a> |
changeset |
<a href="/comm-central/raw-rev/3f3fc2c0d80474dff5953969f765e16937dde150">raw</a>  | <a href="/comm-central/archive/3f3fc2c0d80474dff5953969f765e16937dde150.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1614237">Bug 1614237</a> - Remove legacy extensions API. r=mkmelin
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#71;&#101;&#111;&#102;&#102;&#32;&#76;&#97;&#110;&#107;&#111;&#119;&#32;&#60;&#103;&#101;&#111;&#102;&#102;&#64;&#100;&#97;&#114;&#107;&#116;&#114;&#111;&#106;&#97;&#110;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Mon, 10 Feb 2020 10:54:05 +1300</td></tr>

<tr>
 <td>changeset 28729</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/3f3fc2c0d80474dff5953969f765e16937dde150">3f3fc2c0d80474dff5953969f765e16937dde150</a></td>
</tr>



<tr>
<td>parent 28728</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/9f1fae8a80cd64a52f57b33a475df7bc2d4e306b">9f1fae8a80cd64a52f57b33a475df7bc2d4e306b</a>
</td>
</tr>

<tr>
<td>child 28730</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/5c29bf6eb78be3eda24e484bc4bf8ed5f7cfe3aa">5c29bf6eb78be3eda24e484bc4bf8ed5f7cfe3aa</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=3f3fc2c0d80474dff5953969f765e16937dde150">17002</a></td></tr>
<tr><td>push user</td><td>geoff@darktrojan.net</td></tr>
<tr><td>push date</td><td class="date age">Mon, 10 Feb 2020 08:48:31 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@5c29bf6eb78b [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=5c29bf6eb78be3eda24e484bc4bf8ed5f7cfe3aa">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=5c29bf6eb78be3eda24e484bc4bf8ed5f7cfe3aa&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=5c29bf6eb78be3eda24e484bc4bf8ed5f7cfe3aa&newProject=comm-central&newRevision=e0dbdcb71075c5e620718d95f6b3c45ebe1ea2b0&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=5c29bf6eb78be3eda24e484bc4bf8ed5f7cfe3aa&newProject=comm-central&newRevision=e0dbdcb71075c5e620718d95f6b3c45ebe1ea2b0&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=5c29bf6eb78be3eda24e484bc4bf8ed5f7cfe3aa&newProject=comm-central&newRevision=e0dbdcb71075c5e620718d95f6b3c45ebe1ea2b0&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28mkmelin%29&revcount=50">mkmelin</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1614237">1614237</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1614237">Bug 1614237</a> - Remove legacy extensions API. r=mkmelin</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/3f3fc2c0d80474dff5953969f765e16937dde150/common/moz.build">common/moz.build</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/3f3fc2c0d80474dff5953969f765e16937dde150/common/moz.build">file</a> |
<a href="/comm-central/annotate/3f3fc2c0d80474dff5953969f765e16937dde150/common/moz.build">annotate</a> |
<a href="/comm-central/diff/3f3fc2c0d80474dff5953969f765e16937dde150/common/moz.build">diff</a> |
<a href="/comm-central/comparison/3f3fc2c0d80474dff5953969f765e16937dde150/common/moz.build">comparison</a> |
<a href="/comm-central/log/3f3fc2c0d80474dff5953969f765e16937dde150/common/moz.build">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/3f3fc2c0d80474dff5953969f765e16937dde150/common/src/ExtensionSupport.jsm">common/src/ExtensionSupport.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/3f3fc2c0d80474dff5953969f765e16937dde150/common/src/ExtensionSupport.jsm">file</a> |
<a href="/comm-central/annotate/3f3fc2c0d80474dff5953969f765e16937dde150/common/src/ExtensionSupport.jsm">annotate</a> |
<a href="/comm-central/diff/3f3fc2c0d80474dff5953969f765e16937dde150/common/src/ExtensionSupport.jsm">diff</a> |
<a href="/comm-central/comparison/3f3fc2c0d80474dff5953969f765e16937dde150/common/src/ExtensionSupport.jsm">comparison</a> |
<a href="/comm-central/log/3f3fc2c0d80474dff5953969f765e16937dde150/common/src/ExtensionSupport.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/3f3fc2c0d80474dff5953969f765e16937dde150/common/src/Overlays.jsm">common/src/Overlays.jsm</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/3f3fc2c0d80474dff5953969f765e16937dde150/common/src/Overlays.jsm">diff</a> |
<a href="/comm-central/comparison/3f3fc2c0d80474dff5953969f765e16937dde150/common/src/Overlays.jsm">comparison</a> |
<a href="/comm-central/log/3f3fc2c0d80474dff5953969f765e16937dde150/common/src/Overlays.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/3f3fc2c0d80474dff5953969f765e16937dde150/common/src/moz.build">common/src/moz.build</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/3f3fc2c0d80474dff5953969f765e16937dde150/common/src/moz.build">file</a> |
<a href="/comm-central/annotate/3f3fc2c0d80474dff5953969f765e16937dde150/common/src/moz.build">annotate</a> |
<a href="/comm-central/diff/3f3fc2c0d80474dff5953969f765e16937dde150/common/src/moz.build">diff</a> |
<a href="/comm-central/comparison/3f3fc2c0d80474dff5953969f765e16937dde150/common/src/moz.build">comparison</a> |
<a href="/comm-central/log/3f3fc2c0d80474dff5953969f765e16937dde150/common/src/moz.build">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/3f3fc2c0d80474dff5953969f765e16937dde150/common/test/xpcshell/data/BootstrapMonitor.jsm">common/test/xpcshell/data/BootstrapMonitor.jsm</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/3f3fc2c0d80474dff5953969f765e16937dde150/common/test/xpcshell/data/BootstrapMonitor.jsm">diff</a> |
<a href="/comm-central/comparison/3f3fc2c0d80474dff5953969f765e16937dde150/common/test/xpcshell/data/BootstrapMonitor.jsm">comparison</a> |
<a href="/comm-central/log/3f3fc2c0d80474dff5953969f765e16937dde150/common/test/xpcshell/data/BootstrapMonitor.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/3f3fc2c0d80474dff5953969f765e16937dde150/common/test/xpcshell/head_addons.js">common/test/xpcshell/head_addons.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/3f3fc2c0d80474dff5953969f765e16937dde150/common/test/xpcshell/head_addons.js">diff</a> |
<a href="/comm-central/comparison/3f3fc2c0d80474dff5953969f765e16937dde150/common/test/xpcshell/head_addons.js">comparison</a> |
<a href="/comm-central/log/3f3fc2c0d80474dff5953969f765e16937dde150/common/test/xpcshell/head_addons.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/3f3fc2c0d80474dff5953969f765e16937dde150/common/test/xpcshell/test_bootstrap.js">common/test/xpcshell/test_bootstrap.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/3f3fc2c0d80474dff5953969f765e16937dde150/common/test/xpcshell/test_bootstrap.js">diff</a> |
<a href="/comm-central/comparison/3f3fc2c0d80474dff5953969f765e16937dde150/common/test/xpcshell/test_bootstrap.js">comparison</a> |
<a href="/comm-central/log/3f3fc2c0d80474dff5953969f765e16937dde150/common/test/xpcshell/test_bootstrap.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/3f3fc2c0d80474dff5953969f765e16937dde150/common/test/xpcshell/test_bootstrap_const.js">common/test/xpcshell/test_bootstrap_const.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/3f3fc2c0d80474dff5953969f765e16937dde150/common/test/xpcshell/test_bootstrap_const.js">diff</a> |
<a href="/comm-central/comparison/3f3fc2c0d80474dff5953969f765e16937dde150/common/test/xpcshell/test_bootstrap_const.js">comparison</a> |
<a href="/comm-central/log/3f3fc2c0d80474dff5953969f765e16937dde150/common/test/xpcshell/test_bootstrap_const.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/3f3fc2c0d80474dff5953969f765e16937dde150/common/test/xpcshell/test_bootstrap_globals.js">common/test/xpcshell/test_bootstrap_globals.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/3f3fc2c0d80474dff5953969f765e16937dde150/common/test/xpcshell/test_bootstrap_globals.js">diff</a> |
<a href="/comm-central/comparison/3f3fc2c0d80474dff5953969f765e16937dde150/common/test/xpcshell/test_bootstrap_globals.js">comparison</a> |
<a href="/comm-central/log/3f3fc2c0d80474dff5953969f765e16937dde150/common/test/xpcshell/test_bootstrap_globals.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/3f3fc2c0d80474dff5953969f765e16937dde150/common/test/xpcshell/test_bootstrapped_chrome_manifest.js">common/test/xpcshell/test_bootstrapped_chrome_manifest.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/3f3fc2c0d80474dff5953969f765e16937dde150/common/test/xpcshell/test_bootstrapped_chrome_manifest.js">diff</a> |
<a href="/comm-central/comparison/3f3fc2c0d80474dff5953969f765e16937dde150/common/test/xpcshell/test_bootstrapped_chrome_manifest.js">comparison</a> |
<a href="/comm-central/log/3f3fc2c0d80474dff5953969f765e16937dde150/common/test/xpcshell/test_bootstrapped_chrome_manifest.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/3f3fc2c0d80474dff5953969f765e16937dde150/common/test/xpcshell/xpcshell.ini">common/test/xpcshell/xpcshell.ini</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/3f3fc2c0d80474dff5953969f765e16937dde150/common/test/xpcshell/xpcshell.ini">diff</a> |
<a href="/comm-central/comparison/3f3fc2c0d80474dff5953969f765e16937dde150/common/test/xpcshell/xpcshell.ini">comparison</a> |
<a href="/comm-central/log/3f3fc2c0d80474dff5953969f765e16937dde150/common/test/xpcshell/xpcshell.ini">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/3f3fc2c0d80474dff5953969f765e16937dde150/mail/base/content/aboutAddonsExtra.js">mail/base/content/aboutAddonsExtra.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/3f3fc2c0d80474dff5953969f765e16937dde150/mail/base/content/aboutAddonsExtra.js">file</a> |
<a href="/comm-central/annotate/3f3fc2c0d80474dff5953969f765e16937dde150/mail/base/content/aboutAddonsExtra.js">annotate</a> |
<a href="/comm-central/diff/3f3fc2c0d80474dff5953969f765e16937dde150/mail/base/content/aboutAddonsExtra.js">diff</a> |
<a href="/comm-central/comparison/3f3fc2c0d80474dff5953969f765e16937dde150/mail/base/content/aboutAddonsExtra.js">comparison</a> |
<a href="/comm-central/log/3f3fc2c0d80474dff5953969f765e16937dde150/mail/base/content/aboutAddonsExtra.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/3f3fc2c0d80474dff5953969f765e16937dde150/mail/base/content/mailWindowOverlay.js">mail/base/content/mailWindowOverlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/3f3fc2c0d80474dff5953969f765e16937dde150/mail/base/content/mailWindowOverlay.js">file</a> |
<a href="/comm-central/annotate/3f3fc2c0d80474dff5953969f765e16937dde150/mail/base/content/mailWindowOverlay.js">annotate</a> |
<a href="/comm-central/diff/3f3fc2c0d80474dff5953969f765e16937dde150/mail/base/content/mailWindowOverlay.js">diff</a> |
<a href="/comm-central/comparison/3f3fc2c0d80474dff5953969f765e16937dde150/mail/base/content/mailWindowOverlay.js">comparison</a> |
<a href="/comm-central/log/3f3fc2c0d80474dff5953969f765e16937dde150/mail/base/content/mailWindowOverlay.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/3f3fc2c0d80474dff5953969f765e16937dde150/mail/base/content/messenger.xhtml">mail/base/content/messenger.xhtml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/3f3fc2c0d80474dff5953969f765e16937dde150/mail/base/content/messenger.xhtml">file</a> |
<a href="/comm-central/annotate/3f3fc2c0d80474dff5953969f765e16937dde150/mail/base/content/messenger.xhtml">annotate</a> |
<a href="/comm-central/diff/3f3fc2c0d80474dff5953969f765e16937dde150/mail/base/content/messenger.xhtml">diff</a> |
<a href="/comm-central/comparison/3f3fc2c0d80474dff5953969f765e16937dde150/mail/base/content/messenger.xhtml">comparison</a> |
<a href="/comm-central/log/3f3fc2c0d80474dff5953969f765e16937dde150/mail/base/content/messenger.xhtml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/3f3fc2c0d80474dff5953969f765e16937dde150/mail/base/modules/ExtensionsUI.jsm">mail/base/modules/ExtensionsUI.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/3f3fc2c0d80474dff5953969f765e16937dde150/mail/base/modules/ExtensionsUI.jsm">file</a> |
<a href="/comm-central/annotate/3f3fc2c0d80474dff5953969f765e16937dde150/mail/base/modules/ExtensionsUI.jsm">annotate</a> |
<a href="/comm-central/diff/3f3fc2c0d80474dff5953969f765e16937dde150/mail/base/modules/ExtensionsUI.jsm">diff</a> |
<a href="/comm-central/comparison/3f3fc2c0d80474dff5953969f765e16937dde150/mail/base/modules/ExtensionsUI.jsm">comparison</a> |
<a href="/comm-central/log/3f3fc2c0d80474dff5953969f765e16937dde150/mail/base/modules/ExtensionsUI.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/3f3fc2c0d80474dff5953969f765e16937dde150/mail/components/extensions/ext-mail.json">mail/components/extensions/ext-mail.json</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/3f3fc2c0d80474dff5953969f765e16937dde150/mail/components/extensions/ext-mail.json">file</a> |
<a href="/comm-central/annotate/3f3fc2c0d80474dff5953969f765e16937dde150/mail/components/extensions/ext-mail.json">annotate</a> |
<a href="/comm-central/diff/3f3fc2c0d80474dff5953969f765e16937dde150/mail/components/extensions/ext-mail.json">diff</a> |
<a href="/comm-central/comparison/3f3fc2c0d80474dff5953969f765e16937dde150/mail/components/extensions/ext-mail.json">comparison</a> |
<a href="/comm-central/log/3f3fc2c0d80474dff5953969f765e16937dde150/mail/components/extensions/ext-mail.json">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/3f3fc2c0d80474dff5953969f765e16937dde150/mail/components/extensions/jar.mn">mail/components/extensions/jar.mn</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/3f3fc2c0d80474dff5953969f765e16937dde150/mail/components/extensions/jar.mn">file</a> |
<a href="/comm-central/annotate/3f3fc2c0d80474dff5953969f765e16937dde150/mail/components/extensions/jar.mn">annotate</a> |
<a href="/comm-central/diff/3f3fc2c0d80474dff5953969f765e16937dde150/mail/components/extensions/jar.mn">diff</a> |
<a href="/comm-central/comparison/3f3fc2c0d80474dff5953969f765e16937dde150/mail/components/extensions/jar.mn">comparison</a> |
<a href="/comm-central/log/3f3fc2c0d80474dff5953969f765e16937dde150/mail/components/extensions/jar.mn">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/3f3fc2c0d80474dff5953969f765e16937dde150/mail/components/extensions/parent/ext-legacy.js">mail/components/extensions/parent/ext-legacy.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/3f3fc2c0d80474dff5953969f765e16937dde150/mail/components/extensions/parent/ext-legacy.js">diff</a> |
<a href="/comm-central/comparison/3f3fc2c0d80474dff5953969f765e16937dde150/mail/components/extensions/parent/ext-legacy.js">comparison</a> |
<a href="/comm-central/log/3f3fc2c0d80474dff5953969f765e16937dde150/mail/components/extensions/parent/ext-legacy.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/3f3fc2c0d80474dff5953969f765e16937dde150/mail/components/extensions/schemas/legacy.json">mail/components/extensions/schemas/legacy.json</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/3f3fc2c0d80474dff5953969f765e16937dde150/mail/components/extensions/schemas/legacy.json">diff</a> |
<a href="/comm-central/comparison/3f3fc2c0d80474dff5953969f765e16937dde150/mail/components/extensions/schemas/legacy.json">comparison</a> |
<a href="/comm-central/log/3f3fc2c0d80474dff5953969f765e16937dde150/mail/components/extensions/schemas/legacy.json">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/3f3fc2c0d80474dff5953969f765e16937dde150/mail/locales/en-US/chrome/messenger/addons.properties">mail/locales/en-US/chrome/messenger/addons.properties</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/3f3fc2c0d80474dff5953969f765e16937dde150/mail/locales/en-US/chrome/messenger/addons.properties">file</a> |
<a href="/comm-central/annotate/3f3fc2c0d80474dff5953969f765e16937dde150/mail/locales/en-US/chrome/messenger/addons.properties">annotate</a> |
<a href="/comm-central/diff/3f3fc2c0d80474dff5953969f765e16937dde150/mail/locales/en-US/chrome/messenger/addons.properties">diff</a> |
<a href="/comm-central/comparison/3f3fc2c0d80474dff5953969f765e16937dde150/mail/locales/en-US/chrome/messenger/addons.properties">comparison</a> |
<a href="/comm-central/log/3f3fc2c0d80474dff5953969f765e16937dde150/mail/locales/en-US/chrome/messenger/addons.properties">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/3f3fc2c0d80474dff5953969f765e16937dde150/mail/locales/en-US/chrome/messenger/extensionsOverlay.properties">mail/locales/en-US/chrome/messenger/extensionsOverlay.properties</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/3f3fc2c0d80474dff5953969f765e16937dde150/mail/locales/en-US/chrome/messenger/extensionsOverlay.properties">diff</a> |
<a href="/comm-central/comparison/3f3fc2c0d80474dff5953969f765e16937dde150/mail/locales/en-US/chrome/messenger/extensionsOverlay.properties">comparison</a> |
<a href="/comm-central/log/3f3fc2c0d80474dff5953969f765e16937dde150/mail/locales/en-US/chrome/messenger/extensionsOverlay.properties">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/3f3fc2c0d80474dff5953969f765e16937dde150/mail/locales/jar.mn">mail/locales/jar.mn</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/3f3fc2c0d80474dff5953969f765e16937dde150/mail/locales/jar.mn">file</a> |
<a href="/comm-central/annotate/3f3fc2c0d80474dff5953969f765e16937dde150/mail/locales/jar.mn">annotate</a> |
<a href="/comm-central/diff/3f3fc2c0d80474dff5953969f765e16937dde150/mail/locales/jar.mn">diff</a> |
<a href="/comm-central/comparison/3f3fc2c0d80474dff5953969f765e16937dde150/mail/locales/jar.mn">comparison</a> |
<a href="/comm-central/log/3f3fc2c0d80474dff5953969f765e16937dde150/mail/locales/jar.mn">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/common/moz.build</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/common/moz.build</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -3,12 +3,8 @@</span>
<a href="#l1.4"></a><span id="l1.4"> # License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l1.5"></a><span id="l1.5"> # file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l1.6"></a><span id="l1.6"> </span>
<a href="#l1.7"></a><span id="l1.7"> DIRS += [</span>
<a href="#l1.8"></a><span id="l1.8">     'public',</span>
<a href="#l1.9"></a><span id="l1.9">     'src',</span>
<a href="#l1.10"></a><span id="l1.10">     'saxparser'</span>
<a href="#l1.11"></a><span id="l1.11"> ]</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-XPCSHELL_TESTS_MANIFESTS += [</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineminus">-    'test/xpcshell/xpcshell.ini',</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineminus">-]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/common/src/ExtensionSupport.jsm</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/common/src/ExtensionSupport.jsm</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -4,205 +4,23 @@</span>
<a href="#l2.4"></a><span id="l2.4"> </span>
<a href="#l2.5"></a><span id="l2.5"> /**</span>
<a href="#l2.6"></a><span id="l2.6">  * Helper functions for use by extensions that should ease them plug</span>
<a href="#l2.7"></a><span id="l2.7">  * into the application.</span>
<a href="#l2.8"></a><span id="l2.8">  */</span>
<a href="#l2.9"></a><span id="l2.9"> </span>
<a href="#l2.10"></a><span id="l2.10"> this.EXPORTED_SYMBOLS = [&quot;ExtensionSupport&quot;];</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-const { AddonManager } = ChromeUtils.import(</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-  &quot;resource://gre/modules/AddonManager.jsm&quot;</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineminus">-);</span>
<a href="#l2.15"></a><span id="l2.15"> const { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineminus">-// ChromeUtils.import(&quot;resource://gre/modules/Deprecated.jsm&quot;) - needed for warning.</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineminus">-const { NetUtil } = ChromeUtils.import(&quot;resource://gre/modules/NetUtil.jsm&quot;);</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineminus">-</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineminus">-var { fixIterator } = ChromeUtils.import(</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineminus">-  &quot;resource:///modules/iteratorUtils.jsm&quot;</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineminus">-);</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineminus">-const { IOUtils } = ChromeUtils.import(&quot;resource:///modules/IOUtils.jsm&quot;);</span>
<a href="#l2.23"></a><span id="l2.23"> </span>
<a href="#l2.24"></a><span id="l2.24"> var extensionHooks = new Map();</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineminus">-var legacyExtensions = new Map();</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineminus">-var bootstrapExtensions = new Set();</span>
<a href="#l2.27"></a><span id="l2.27"> var openWindowList;</span>
<a href="#l2.28"></a><span id="l2.28"> </span>
<a href="#l2.29"></a><span id="l2.29"> var ExtensionSupport = {</span>
<a href="#l2.30"></a><span id="l2.30">   /**</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineminus">-   * A Map-like object which tracks legacy extension status. The &quot;has&quot; method</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineminus">-   * returns only active extensions for compatibility with existing code.</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineminus">-   */</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineminus">-  loadedLegacyExtensions: {</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineminus">-    set(id, state) {</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineminus">-      legacyExtensions.set(id, state);</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineminus">-    },</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineminus">-    get(id) {</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineminus">-      return legacyExtensions.get(id);</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineminus">-    },</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineminus">-    has(id) {</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineminus">-      if (!legacyExtensions.has(id)) {</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineminus">-        return false;</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineminus">-      }</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineminus">-</span>
<a href="#l2.46"></a><span id="l2.46" class="difflineminus">-      let state = legacyExtensions.get(id);</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineminus">-      return ![&quot;install&quot;, &quot;enable&quot;].includes(state.pendingOperation);</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineminus">-    },</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineminus">-    hasAnyState(id) {</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineminus">-      return legacyExtensions.has(id);</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineminus">-    },</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineminus">-    _maybeDelete(id, newPendingOperation) {</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineminus">-      if (!legacyExtensions.has(id)) {</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineminus">-        return;</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineminus">-      }</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineminus">-</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineminus">-      let state = legacyExtensions.get(id);</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineminus">-      if (</span>
<a href="#l2.59"></a><span id="l2.59" class="difflineminus">-        state.pendingOperation == &quot;enable&quot; &amp;&amp;</span>
<a href="#l2.60"></a><span id="l2.60" class="difflineminus">-        newPendingOperation == &quot;disable&quot;</span>
<a href="#l2.61"></a><span id="l2.61" class="difflineminus">-      ) {</span>
<a href="#l2.62"></a><span id="l2.62" class="difflineminus">-        legacyExtensions.delete(id);</span>
<a href="#l2.63"></a><span id="l2.63" class="difflineminus">-        this.notifyObservers(state);</span>
<a href="#l2.64"></a><span id="l2.64" class="difflineminus">-      } else if (</span>
<a href="#l2.65"></a><span id="l2.65" class="difflineminus">-        state.pendingOperation == &quot;install&quot; &amp;&amp;</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineminus">-        newPendingOperation == &quot;uninstall&quot;</span>
<a href="#l2.67"></a><span id="l2.67" class="difflineminus">-      ) {</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineminus">-        legacyExtensions.delete(id);</span>
<a href="#l2.69"></a><span id="l2.69" class="difflineminus">-        this.notifyObservers(state);</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineminus">-      }</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineminus">-    },</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineminus">-    notifyObservers(state) {</span>
<a href="#l2.73"></a><span id="l2.73" class="difflineminus">-      let wrappedState = { wrappedJSObject: state };</span>
<a href="#l2.74"></a><span id="l2.74" class="difflineminus">-      Services.obs.notifyObservers(wrappedState, &quot;legacy-addon-status-changed&quot;);</span>
<a href="#l2.75"></a><span id="l2.75" class="difflineminus">-    },</span>
<a href="#l2.76"></a><span id="l2.76" class="difflineminus">-    // AddonListener</span>
<a href="#l2.77"></a><span id="l2.77" class="difflineminus">-    onDisabled(ev) {</span>
<a href="#l2.78"></a><span id="l2.78" class="difflineminus">-      this._maybeDelete(ev.id, &quot;disable&quot;);</span>
<a href="#l2.79"></a><span id="l2.79" class="difflineminus">-    },</span>
<a href="#l2.80"></a><span id="l2.80" class="difflineminus">-    onUninstalled(ev) {</span>
<a href="#l2.81"></a><span id="l2.81" class="difflineminus">-      this._maybeDelete(ev.id, &quot;uninstall&quot;);</span>
<a href="#l2.82"></a><span id="l2.82" class="difflineminus">-    },</span>
<a href="#l2.83"></a><span id="l2.83" class="difflineminus">-    async listRemoved() {</span>
<a href="#l2.84"></a><span id="l2.84" class="difflineminus">-      let running = [...legacyExtensions.keys()];</span>
<a href="#l2.85"></a><span id="l2.85" class="difflineminus">-      let installed = await AddonManager.getAddonsByIDs(running);</span>
<a href="#l2.86"></a><span id="l2.86" class="difflineminus">-      let runningButNotInstalled = [];</span>
<a href="#l2.87"></a><span id="l2.87" class="difflineminus">-      for (let i = 0; i &lt; running.length; i++) {</span>
<a href="#l2.88"></a><span id="l2.88" class="difflineminus">-        if (installed[i] === null) {</span>
<a href="#l2.89"></a><span id="l2.89" class="difflineminus">-          runningButNotInstalled.push(legacyExtensions.get(running[i]));</span>
<a href="#l2.90"></a><span id="l2.90" class="difflineminus">-        }</span>
<a href="#l2.91"></a><span id="l2.91" class="difflineminus">-      }</span>
<a href="#l2.92"></a><span id="l2.92" class="difflineminus">-      return runningButNotInstalled;</span>
<a href="#l2.93"></a><span id="l2.93" class="difflineminus">-    },</span>
<a href="#l2.94"></a><span id="l2.94" class="difflineminus">-  },</span>
<a href="#l2.95"></a><span id="l2.95" class="difflineminus">-</span>
<a href="#l2.96"></a><span id="l2.96" class="difflineminus">-  loadedBootstrapExtensions: bootstrapExtensions,</span>
<a href="#l2.97"></a><span id="l2.97" class="difflineminus">-</span>
<a href="#l2.98"></a><span id="l2.98" class="difflineminus">-  loadAddonPrefs(addonFile) {</span>
<a href="#l2.99"></a><span id="l2.99" class="difflineminus">-    function setPref(preferDefault, name, value) {</span>
<a href="#l2.100"></a><span id="l2.100" class="difflineminus">-      let branch = preferDefault</span>
<a href="#l2.101"></a><span id="l2.101" class="difflineminus">-        ? Services.prefs.getDefaultBranch(&quot;&quot;)</span>
<a href="#l2.102"></a><span id="l2.102" class="difflineminus">-        : Services.prefs.getBranch(&quot;&quot;);</span>
<a href="#l2.103"></a><span id="l2.103" class="difflineminus">-</span>
<a href="#l2.104"></a><span id="l2.104" class="difflineminus">-      if (typeof value == &quot;boolean&quot;) {</span>
<a href="#l2.105"></a><span id="l2.105" class="difflineminus">-        branch.setBoolPref(name, value);</span>
<a href="#l2.106"></a><span id="l2.106" class="difflineminus">-      } else if (typeof value == &quot;string&quot;) {</span>
<a href="#l2.107"></a><span id="l2.107" class="difflineminus">-        if (value.startsWith(&quot;chrome://&quot;) &amp;&amp; value.endsWith(&quot;.properties&quot;)) {</span>
<a href="#l2.108"></a><span id="l2.108" class="difflineminus">-          let valueLocal = Cc[</span>
<a href="#l2.109"></a><span id="l2.109" class="difflineminus">-            &quot;@mozilla.org/pref-localizedstring;1&quot;</span>
<a href="#l2.110"></a><span id="l2.110" class="difflineminus">-          ].createInstance(Ci.nsIPrefLocalizedString);</span>
<a href="#l2.111"></a><span id="l2.111" class="difflineminus">-          valueLocal.data = value;</span>
<a href="#l2.112"></a><span id="l2.112" class="difflineminus">-          branch.setComplexValue(name, Ci.nsIPrefLocalizedString, valueLocal);</span>
<a href="#l2.113"></a><span id="l2.113" class="difflineminus">-        } else {</span>
<a href="#l2.114"></a><span id="l2.114" class="difflineminus">-          branch.setStringPref(name, value);</span>
<a href="#l2.115"></a><span id="l2.115" class="difflineminus">-        }</span>
<a href="#l2.116"></a><span id="l2.116" class="difflineminus">-      } else if (typeof value == &quot;number&quot; &amp;&amp; Number.isInteger(value)) {</span>
<a href="#l2.117"></a><span id="l2.117" class="difflineminus">-        branch.setIntPref(name, value);</span>
<a href="#l2.118"></a><span id="l2.118" class="difflineminus">-      } else if (typeof value == &quot;number&quot; &amp;&amp; Number.isFloat(value)) {</span>
<a href="#l2.119"></a><span id="l2.119" class="difflineminus">-        // Floats are set as char prefs, then retrieved using getFloatPref</span>
<a href="#l2.120"></a><span id="l2.120" class="difflineminus">-        branch.setCharPref(name, value);</span>
<a href="#l2.121"></a><span id="l2.121" class="difflineminus">-      }</span>
<a href="#l2.122"></a><span id="l2.122" class="difflineminus">-    }</span>
<a href="#l2.123"></a><span id="l2.123" class="difflineminus">-</span>
<a href="#l2.124"></a><span id="l2.124" class="difflineminus">-    function walkExtensionPrefs(extensionRoot) {</span>
<a href="#l2.125"></a><span id="l2.125" class="difflineminus">-      let prefFile = extensionRoot.clone();</span>
<a href="#l2.126"></a><span id="l2.126" class="difflineminus">-      let foundPrefStrings = [];</span>
<a href="#l2.127"></a><span id="l2.127" class="difflineminus">-      if (!prefFile.exists()) {</span>
<a href="#l2.128"></a><span id="l2.128" class="difflineminus">-        return [];</span>
<a href="#l2.129"></a><span id="l2.129" class="difflineminus">-      }</span>
<a href="#l2.130"></a><span id="l2.130" class="difflineminus">-</span>
<a href="#l2.131"></a><span id="l2.131" class="difflineminus">-      if (prefFile.isDirectory()) {</span>
<a href="#l2.132"></a><span id="l2.132" class="difflineminus">-        prefFile.append(&quot;defaults&quot;);</span>
<a href="#l2.133"></a><span id="l2.133" class="difflineminus">-        prefFile.append(&quot;preferences&quot;);</span>
<a href="#l2.134"></a><span id="l2.134" class="difflineminus">-        if (!prefFile.exists() || !prefFile.isDirectory()) {</span>
<a href="#l2.135"></a><span id="l2.135" class="difflineminus">-          return [];</span>
<a href="#l2.136"></a><span id="l2.136" class="difflineminus">-        }</span>
<a href="#l2.137"></a><span id="l2.137" class="difflineminus">-</span>
<a href="#l2.138"></a><span id="l2.138" class="difflineminus">-        let unsortedFiles = [];</span>
<a href="#l2.139"></a><span id="l2.139" class="difflineminus">-        for (let file of fixIterator(prefFile.directoryEntries, Ci.nsIFile)) {</span>
<a href="#l2.140"></a><span id="l2.140" class="difflineminus">-          if (file.isFile() &amp;&amp; file.leafName.toLowerCase().endsWith(&quot;.js&quot;)) {</span>
<a href="#l2.141"></a><span id="l2.141" class="difflineminus">-            unsortedFiles.push(file);</span>
<a href="#l2.142"></a><span id="l2.142" class="difflineminus">-          }</span>
<a href="#l2.143"></a><span id="l2.143" class="difflineminus">-        }</span>
<a href="#l2.144"></a><span id="l2.144" class="difflineminus">-</span>
<a href="#l2.145"></a><span id="l2.145" class="difflineminus">-        for (let file of unsortedFiles.sort((a, b) =&gt;</span>
<a href="#l2.146"></a><span id="l2.146" class="difflineminus">-          a.path &lt; b.path ? 1 : -1</span>
<a href="#l2.147"></a><span id="l2.147" class="difflineminus">-        )) {</span>
<a href="#l2.148"></a><span id="l2.148" class="difflineminus">-          foundPrefStrings.push(IOUtils.loadFileToString(file));</span>
<a href="#l2.149"></a><span id="l2.149" class="difflineminus">-        }</span>
<a href="#l2.150"></a><span id="l2.150" class="difflineminus">-      } else if (prefFile.isFile() &amp;&amp; prefFile.leafName.endsWith(&quot;xpi&quot;)) {</span>
<a href="#l2.151"></a><span id="l2.151" class="difflineminus">-        let zipReader = Cc[&quot;@mozilla.org/libjar/zip-reader;1&quot;].createInstance(</span>
<a href="#l2.152"></a><span id="l2.152" class="difflineminus">-          Ci.nsIZipReader</span>
<a href="#l2.153"></a><span id="l2.153" class="difflineminus">-        );</span>
<a href="#l2.154"></a><span id="l2.154" class="difflineminus">-        zipReader.open(prefFile);</span>
<a href="#l2.155"></a><span id="l2.155" class="difflineminus">-        let entries = zipReader.findEntries(&quot;defaults/preferences/*.js&quot;);</span>
<a href="#l2.156"></a><span id="l2.156" class="difflineminus">-</span>
<a href="#l2.157"></a><span id="l2.157" class="difflineminus">-        for (let entryName of [...entries].sort().reverse()) {</span>
<a href="#l2.158"></a><span id="l2.158" class="difflineminus">-          let stream = zipReader.getInputStream(entryName);</span>
<a href="#l2.159"></a><span id="l2.159" class="difflineminus">-          let entrySize = zipReader.getEntry(entryName).realSize;</span>
<a href="#l2.160"></a><span id="l2.160" class="difflineminus">-          if (entrySize &gt; 0) {</span>
<a href="#l2.161"></a><span id="l2.161" class="difflineminus">-            let content = NetUtil.readInputStreamToString(stream, entrySize, {</span>
<a href="#l2.162"></a><span id="l2.162" class="difflineminus">-              charset: &quot;utf-8&quot;,</span>
<a href="#l2.163"></a><span id="l2.163" class="difflineminus">-              replacement: &quot;?&quot;,</span>
<a href="#l2.164"></a><span id="l2.164" class="difflineminus">-            });</span>
<a href="#l2.165"></a><span id="l2.165" class="difflineminus">-            foundPrefStrings.push(content);</span>
<a href="#l2.166"></a><span id="l2.166" class="difflineminus">-          }</span>
<a href="#l2.167"></a><span id="l2.167" class="difflineminus">-        }</span>
<a href="#l2.168"></a><span id="l2.168" class="difflineminus">-      }</span>
<a href="#l2.169"></a><span id="l2.169" class="difflineminus">-</span>
<a href="#l2.170"></a><span id="l2.170" class="difflineminus">-      return foundPrefStrings;</span>
<a href="#l2.171"></a><span id="l2.171" class="difflineminus">-    }</span>
<a href="#l2.172"></a><span id="l2.172" class="difflineminus">-</span>
<a href="#l2.173"></a><span id="l2.173" class="difflineminus">-    let sandbox = new Cu.Sandbox(null);</span>
<a href="#l2.174"></a><span id="l2.174" class="difflineminus">-    sandbox.pref = setPref.bind(undefined, true);</span>
<a href="#l2.175"></a><span id="l2.175" class="difflineminus">-    sandbox.user_pref = setPref.bind(undefined, false);</span>
<a href="#l2.176"></a><span id="l2.176" class="difflineminus">-</span>
<a href="#l2.177"></a><span id="l2.177" class="difflineminus">-    let prefDataStrings = walkExtensionPrefs(addonFile);</span>
<a href="#l2.178"></a><span id="l2.178" class="difflineminus">-    for (let prefDataString of prefDataStrings) {</span>
<a href="#l2.179"></a><span id="l2.179" class="difflineminus">-      try {</span>
<a href="#l2.180"></a><span id="l2.180" class="difflineminus">-        Cu.evalInSandbox(prefDataString, sandbox);</span>
<a href="#l2.181"></a><span id="l2.181" class="difflineminus">-      } catch (e) {</span>
<a href="#l2.182"></a><span id="l2.182" class="difflineminus">-        Cu.reportError(</span>
<a href="#l2.183"></a><span id="l2.183" class="difflineminus">-          &quot;Error reading default prefs of addon &quot; +</span>
<a href="#l2.184"></a><span id="l2.184" class="difflineminus">-            addonFile.leafName +</span>
<a href="#l2.185"></a><span id="l2.185" class="difflineminus">-            &quot;: &quot; +</span>
<a href="#l2.186"></a><span id="l2.186" class="difflineminus">-            e</span>
<a href="#l2.187"></a><span id="l2.187" class="difflineminus">-        );</span>
<a href="#l2.188"></a><span id="l2.188" class="difflineminus">-      }</span>
<a href="#l2.189"></a><span id="l2.189" class="difflineminus">-    }</span>
<a href="#l2.190"></a><span id="l2.190" class="difflineminus">-</span>
<a href="#l2.191"></a><span id="l2.191" class="difflineminus">-    /*</span>
<a href="#l2.192"></a><span id="l2.192" class="difflineminus">-    TODO: decide whether we need to warn the user/make addon authors to migrate away from these pref files.</span>
<a href="#l2.193"></a><span id="l2.193" class="difflineminus">-    if (prefDataStrings.length &gt; 0) {</span>
<a href="#l2.194"></a><span id="l2.194" class="difflineminus">-      Deprecated.warning(addon.defaultLocale.name + &quot; uses defaults/preferences/*.js files to load prefs&quot;,</span>
<a href="#l2.195"></a><span id="l2.195" class="difflineminus">-                         &quot;https://bugzilla.mozilla.org/show_bug.cgi?id=1414398&quot;);</span>
<a href="#l2.196"></a><span id="l2.196" class="difflineminus">-    }</span>
<a href="#l2.197"></a><span id="l2.197" class="difflineminus">-    */</span>
<a href="#l2.198"></a><span id="l2.198" class="difflineminus">-  },</span>
<a href="#l2.199"></a><span id="l2.199" class="difflineminus">-</span>
<a href="#l2.200"></a><span id="l2.200" class="difflineminus">-  /**</span>
<a href="#l2.201"></a><span id="l2.201">    * Register listening for windows getting opened that will run the specified callback function</span>
<a href="#l2.202"></a><span id="l2.202">    * when a matching window is loaded.</span>
<a href="#l2.203"></a><span id="l2.203">    *</span>
<a href="#l2.204"></a><span id="l2.204">    * @param aID {String}  Some identification of the caller, usually the extension ID.</span>
<a href="#l2.205"></a><span id="l2.205">    * @param aExtensionHook {Object}  The object describing the hook the caller wants to register.</span>
<a href="#l2.206"></a><span id="l2.206">    *        Members of the object can be (all optional, but one callback must be supplied):</span>
<a href="#l2.207"></a><span id="l2.207">    *        chromeURLs {Array}         An array of strings of document URLs on which</span>
<a href="#l2.208"></a><span id="l2.208">    *                                   the given callback should run. If not specified,</span>
<a href="#l2.209"></a><span id="l2.209" class="difflineat">@@ -410,10 +228,8 @@ var ExtensionSupport = {</span>
<a href="#l2.210"></a><span id="l2.210">       }</span>
<a href="#l2.211"></a><span id="l2.211">     }</span>
<a href="#l2.212"></a><span id="l2.212">   },</span>
<a href="#l2.213"></a><span id="l2.213"> </span>
<a href="#l2.214"></a><span id="l2.214">   get registeredWindowListenerCount() {</span>
<a href="#l2.215"></a><span id="l2.215">     return extensionHooks.size;</span>
<a href="#l2.216"></a><span id="l2.216">   },</span>
<a href="#l2.217"></a><span id="l2.217"> };</span>
<a href="#l2.218"></a><span id="l2.218" class="difflineminus">-</span>
<a href="#l2.219"></a><span id="l2.219" class="difflineminus">-AddonManager.addAddonListener(ExtensionSupport.loadedLegacyExtensions);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1">deleted file mode 100644</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineminus">--- a/common/src/Overlays.jsm</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineplus">+++ /dev/null</span>
<a href="#l3.4"></a><span id="l3.4" class="difflineat">@@ -1,603 +0,0 @@</span>
<a href="#l3.5"></a><span id="l3.5" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l3.6"></a><span id="l3.6" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l3.7"></a><span id="l3.7" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l3.8"></a><span id="l3.8" class="difflineminus">-</span>
<a href="#l3.9"></a><span id="l3.9" class="difflineminus">-/**</span>
<a href="#l3.10"></a><span id="l3.10" class="difflineminus">- * Load overlays in a similar way as XUL did for legacy XUL add-ons.</span>
<a href="#l3.11"></a><span id="l3.11" class="difflineminus">- */</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-&quot;use strict&quot;;</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineminus">-</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineminus">-this.EXPORTED_SYMBOLS = [&quot;Overlays&quot;];</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineminus">-</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineminus">-const { ConsoleAPI } = ChromeUtils.import(&quot;resource://gre/modules/Console.jsm&quot;);</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineminus">-ChromeUtils.defineModuleGetter(</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineminus">-  this,</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineminus">-  &quot;Services&quot;,</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineminus">-  &quot;resource://gre/modules/Services.jsm&quot;</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineminus">-);</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineminus">-ChromeUtils.defineModuleGetter(</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineminus">-  this,</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineminus">-  &quot;setTimeout&quot;,</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineminus">-  &quot;resource://gre/modules/Timer.jsm&quot;</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineminus">-);</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineminus">-</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineminus">-let oconsole = new ConsoleAPI({</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineminus">-  prefix: &quot;Overlays.jsm&quot;,</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineminus">-  consoleID: &quot;overlays-jsm&quot;,</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineminus">-  maxLogLevelPref: &quot;extensions.overlayloader.loglevel&quot;,</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineminus">-});</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineminus">-</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineminus">-/**</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineminus">- * The overlays class, providing support for loading overlays like they used to work. This class</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineminus">- * should likely be called through its static method Overlays.load()</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineminus">- */</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineminus">-class Overlays {</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineminus">-  /**</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineminus">-   * Load overlays for the given window using the overlay provider, which can for example be a</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineminus">-   * ChromeManifest object.</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineminus">-   *</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineminus">-   * @param {ChromeManifest} overlayProvider        The overlay provider that contains information</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineminus">-   *                                                  about styles and overlays.</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineminus">-   * @param {DOMWindow} window                      The window to load into</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineminus">-   */</span>
<a href="#l3.48"></a><span id="l3.48" class="difflineminus">-  static load(overlayProvider, window) {</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineminus">-    let instance = new Overlays(overlayProvider, window);</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineminus">-</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineminus">-    let urls = overlayProvider.overlay.get(instance.location, false);</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineminus">-    instance.load(urls);</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineminus">-  }</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineminus">-</span>
<a href="#l3.55"></a><span id="l3.55" class="difflineminus">-  /**</span>
<a href="#l3.56"></a><span id="l3.56" class="difflineminus">-   * Constructs the overlays instance. This class should be called via Overlays.load() instead.</span>
<a href="#l3.57"></a><span id="l3.57" class="difflineminus">-   *</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineminus">-   * @param {ChromeManifest} overlayProvider        The overlay provider that contains information</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineminus">-   *                                                  about styles and overlays.</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineminus">-   * @param {DOMWindow} window                      The window to load into</span>
<a href="#l3.61"></a><span id="l3.61" class="difflineminus">-   */</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineminus">-  constructor(overlayProvider, window) {</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineminus">-    this.overlayProvider = overlayProvider;</span>
<a href="#l3.64"></a><span id="l3.64" class="difflineminus">-    this.window = window;</span>
<a href="#l3.65"></a><span id="l3.65" class="difflineminus">-    if (window.location.protocol == &quot;about:&quot;) {</span>
<a href="#l3.66"></a><span id="l3.66" class="difflineminus">-      this.location = window.location.protocol + window.location.pathname;</span>
<a href="#l3.67"></a><span id="l3.67" class="difflineminus">-    } else {</span>
<a href="#l3.68"></a><span id="l3.68" class="difflineminus">-      this.location = window.location.origin + window.location.pathname;</span>
<a href="#l3.69"></a><span id="l3.69" class="difflineminus">-    }</span>
<a href="#l3.70"></a><span id="l3.70" class="difflineminus">-  }</span>
<a href="#l3.71"></a><span id="l3.71" class="difflineminus">-</span>
<a href="#l3.72"></a><span id="l3.72" class="difflineminus">-  /**</span>
<a href="#l3.73"></a><span id="l3.73" class="difflineminus">-   * A shorthand to this.window.document</span>
<a href="#l3.74"></a><span id="l3.74" class="difflineminus">-   */</span>
<a href="#l3.75"></a><span id="l3.75" class="difflineminus">-  get document() {</span>
<a href="#l3.76"></a><span id="l3.76" class="difflineminus">-    return this.window.document;</span>
<a href="#l3.77"></a><span id="l3.77" class="difflineminus">-  }</span>
<a href="#l3.78"></a><span id="l3.78" class="difflineminus">-</span>
<a href="#l3.79"></a><span id="l3.79" class="difflineminus">-  /**</span>
<a href="#l3.80"></a><span id="l3.80" class="difflineminus">-   * Loads the given urls into the window, recursively loading further overlays as provided by the</span>
<a href="#l3.81"></a><span id="l3.81" class="difflineminus">-   * overlayProvider.</span>
<a href="#l3.82"></a><span id="l3.82" class="difflineminus">-   *</span>
<a href="#l3.83"></a><span id="l3.83" class="difflineminus">-   * @param {String[]} urls                         The urls to load</span>
<a href="#l3.84"></a><span id="l3.84" class="difflineminus">-   */</span>
<a href="#l3.85"></a><span id="l3.85" class="difflineminus">-  load(urls) {</span>
<a href="#l3.86"></a><span id="l3.86" class="difflineminus">-    let unloadedOverlays = this._collectOverlays(this.document).concat(urls);</span>
<a href="#l3.87"></a><span id="l3.87" class="difflineminus">-    let forwardReferences = [];</span>
<a href="#l3.88"></a><span id="l3.88" class="difflineminus">-    let unloadedScripts = [];</span>
<a href="#l3.89"></a><span id="l3.89" class="difflineminus">-    let unloadedSheets = [];</span>
<a href="#l3.90"></a><span id="l3.90" class="difflineminus">-    this._toolbarsToResolve = [];</span>
<a href="#l3.91"></a><span id="l3.91" class="difflineminus">-    let xulStore = Services.xulStore;</span>
<a href="#l3.92"></a><span id="l3.92" class="difflineminus">-    this.persistedIDs = new Set();</span>
<a href="#l3.93"></a><span id="l3.93" class="difflineminus">-</span>
<a href="#l3.94"></a><span id="l3.94" class="difflineminus">-    // Load css styles from the registry</span>
<a href="#l3.95"></a><span id="l3.95" class="difflineminus">-    for (let sheet of this.overlayProvider.style.get(this.location, false)) {</span>
<a href="#l3.96"></a><span id="l3.96" class="difflineminus">-      unloadedSheets.push(sheet);</span>
<a href="#l3.97"></a><span id="l3.97" class="difflineminus">-    }</span>
<a href="#l3.98"></a><span id="l3.98" class="difflineminus">-</span>
<a href="#l3.99"></a><span id="l3.99" class="difflineminus">-    if (!unloadedOverlays.length &amp;&amp; !unloadedSheets.length) {</span>
<a href="#l3.100"></a><span id="l3.100" class="difflineminus">-      return;</span>
<a href="#l3.101"></a><span id="l3.101" class="difflineminus">-    }</span>
<a href="#l3.102"></a><span id="l3.102" class="difflineminus">-</span>
<a href="#l3.103"></a><span id="l3.103" class="difflineminus">-    while (unloadedOverlays.length) {</span>
<a href="#l3.104"></a><span id="l3.104" class="difflineminus">-      let url = unloadedOverlays.shift();</span>
<a href="#l3.105"></a><span id="l3.105" class="difflineminus">-      let xhr = this.fetchOverlay(url);</span>
<a href="#l3.106"></a><span id="l3.106" class="difflineminus">-      let doc = xhr.responseXML;</span>
<a href="#l3.107"></a><span id="l3.107" class="difflineminus">-</span>
<a href="#l3.108"></a><span id="l3.108" class="difflineminus">-      oconsole.debug(`Applying ${url} to ${this.location}`);</span>
<a href="#l3.109"></a><span id="l3.109" class="difflineminus">-</span>
<a href="#l3.110"></a><span id="l3.110" class="difflineminus">-      // clean the document a bit</span>
<a href="#l3.111"></a><span id="l3.111" class="difflineminus">-      let emptyNodes = doc.evaluate(</span>
<a href="#l3.112"></a><span id="l3.112" class="difflineminus">-        &quot;//text()[normalize-space(.) = '']&quot;,</span>
<a href="#l3.113"></a><span id="l3.113" class="difflineminus">-        doc,</span>
<a href="#l3.114"></a><span id="l3.114" class="difflineminus">-        null,</span>
<a href="#l3.115"></a><span id="l3.115" class="difflineminus">-        7,</span>
<a href="#l3.116"></a><span id="l3.116" class="difflineminus">-        null</span>
<a href="#l3.117"></a><span id="l3.117" class="difflineminus">-      );</span>
<a href="#l3.118"></a><span id="l3.118" class="difflineminus">-      for (let i = 0, len = emptyNodes.snapshotLength; i &lt; len; ++i) {</span>
<a href="#l3.119"></a><span id="l3.119" class="difflineminus">-        let node = emptyNodes.snapshotItem(i);</span>
<a href="#l3.120"></a><span id="l3.120" class="difflineminus">-        node.remove();</span>
<a href="#l3.121"></a><span id="l3.121" class="difflineminus">-      }</span>
<a href="#l3.122"></a><span id="l3.122" class="difflineminus">-</span>
<a href="#l3.123"></a><span id="l3.123" class="difflineminus">-      let commentNodes = doc.evaluate(&quot;//comment()&quot;, doc, null, 7, null);</span>
<a href="#l3.124"></a><span id="l3.124" class="difflineminus">-      for (let i = 0, len = commentNodes.snapshotLength; i &lt; len; ++i) {</span>
<a href="#l3.125"></a><span id="l3.125" class="difflineminus">-        let node = commentNodes.snapshotItem(i);</span>
<a href="#l3.126"></a><span id="l3.126" class="difflineminus">-        node.remove();</span>
<a href="#l3.127"></a><span id="l3.127" class="difflineminus">-      }</span>
<a href="#l3.128"></a><span id="l3.128" class="difflineminus">-</span>
<a href="#l3.129"></a><span id="l3.129" class="difflineminus">-      // Force a re-evaluation of inline styles to work around an issue</span>
<a href="#l3.130"></a><span id="l3.130" class="difflineminus">-      // causing inline styles to be initially ignored.</span>
<a href="#l3.131"></a><span id="l3.131" class="difflineminus">-      let styledNodes = doc.evaluate(&quot;//*[@style]&quot;, doc, null, 7, null);</span>
<a href="#l3.132"></a><span id="l3.132" class="difflineminus">-      for (let i = 0, len = styledNodes.snapshotLength; i &lt; len; ++i) {</span>
<a href="#l3.133"></a><span id="l3.133" class="difflineminus">-        let node = styledNodes.snapshotItem(i);</span>
<a href="#l3.134"></a><span id="l3.134" class="difflineminus">-        node.style.display = node.style.display; // eslint-disable-line no-self-assign</span>
<a href="#l3.135"></a><span id="l3.135" class="difflineminus">-      }</span>
<a href="#l3.136"></a><span id="l3.136" class="difflineminus">-</span>
<a href="#l3.137"></a><span id="l3.137" class="difflineminus">-      // Load css styles from the registry</span>
<a href="#l3.138"></a><span id="l3.138" class="difflineminus">-      for (let sheet of this.overlayProvider.style.get(url, false)) {</span>
<a href="#l3.139"></a><span id="l3.139" class="difflineminus">-        unloadedSheets.push(sheet);</span>
<a href="#l3.140"></a><span id="l3.140" class="difflineminus">-      }</span>
<a href="#l3.141"></a><span id="l3.141" class="difflineminus">-</span>
<a href="#l3.142"></a><span id="l3.142" class="difflineminus">-      // Load css processing instructions from the overlay</span>
<a href="#l3.143"></a><span id="l3.143" class="difflineminus">-      let stylesheets = doc.evaluate(</span>
<a href="#l3.144"></a><span id="l3.144" class="difflineminus">-        &quot;/processing-instruction('xml-stylesheet')&quot;,</span>
<a href="#l3.145"></a><span id="l3.145" class="difflineminus">-        doc,</span>
<a href="#l3.146"></a><span id="l3.146" class="difflineminus">-        null,</span>
<a href="#l3.147"></a><span id="l3.147" class="difflineminus">-        7,</span>
<a href="#l3.148"></a><span id="l3.148" class="difflineminus">-        null</span>
<a href="#l3.149"></a><span id="l3.149" class="difflineminus">-      );</span>
<a href="#l3.150"></a><span id="l3.150" class="difflineminus">-      for (let i = 0, len = stylesheets.snapshotLength; i &lt; len; ++i) {</span>
<a href="#l3.151"></a><span id="l3.151" class="difflineminus">-        let node = stylesheets.snapshotItem(i);</span>
<a href="#l3.152"></a><span id="l3.152" class="difflineminus">-        let match = node.nodeValue.match(/href=[&quot;']([^&quot;']*)[&quot;']/);</span>
<a href="#l3.153"></a><span id="l3.153" class="difflineminus">-        if (match) {</span>
<a href="#l3.154"></a><span id="l3.154" class="difflineminus">-          unloadedSheets.push(new URL(match[1], node.baseURI).href);</span>
<a href="#l3.155"></a><span id="l3.155" class="difflineminus">-        }</span>
<a href="#l3.156"></a><span id="l3.156" class="difflineminus">-      }</span>
<a href="#l3.157"></a><span id="l3.157" class="difflineminus">-</span>
<a href="#l3.158"></a><span id="l3.158" class="difflineminus">-      // Prepare loading further nested xul overlays from the overlay</span>
<a href="#l3.159"></a><span id="l3.159" class="difflineminus">-      unloadedOverlays.push(...this._collectOverlays(doc));</span>
<a href="#l3.160"></a><span id="l3.160" class="difflineminus">-</span>
<a href="#l3.161"></a><span id="l3.161" class="difflineminus">-      // Prepare loading further nested xul overlays from the registry</span>
<a href="#l3.162"></a><span id="l3.162" class="difflineminus">-      for (let overlayUrl of this.overlayProvider.overlay.get(url, false)) {</span>
<a href="#l3.163"></a><span id="l3.163" class="difflineminus">-        unloadedOverlays.push(overlayUrl);</span>
<a href="#l3.164"></a><span id="l3.164" class="difflineminus">-      }</span>
<a href="#l3.165"></a><span id="l3.165" class="difflineminus">-</span>
<a href="#l3.166"></a><span id="l3.166" class="difflineminus">-      // Run through all overlay nodes on the first level (hookup nodes). Scripts will be deferred</span>
<a href="#l3.167"></a><span id="l3.167" class="difflineminus">-      // until later for simplicity (c++ code seems to process them earlier?).</span>
<a href="#l3.168"></a><span id="l3.168" class="difflineminus">-      for (let node of doc.documentElement.children) {</span>
<a href="#l3.169"></a><span id="l3.169" class="difflineminus">-        if (node.localName == &quot;script&quot;) {</span>
<a href="#l3.170"></a><span id="l3.170" class="difflineminus">-          unloadedScripts.push(node);</span>
<a href="#l3.171"></a><span id="l3.171" class="difflineminus">-        } else {</span>
<a href="#l3.172"></a><span id="l3.172" class="difflineminus">-          forwardReferences.push(node);</span>
<a href="#l3.173"></a><span id="l3.173" class="difflineminus">-        }</span>
<a href="#l3.174"></a><span id="l3.174" class="difflineminus">-      }</span>
<a href="#l3.175"></a><span id="l3.175" class="difflineminus">-    }</span>
<a href="#l3.176"></a><span id="l3.176" class="difflineminus">-</span>
<a href="#l3.177"></a><span id="l3.177" class="difflineminus">-    let ids = xulStore.getIDsEnumerator(this.location);</span>
<a href="#l3.178"></a><span id="l3.178" class="difflineminus">-    while (ids.hasMore()) {</span>
<a href="#l3.179"></a><span id="l3.179" class="difflineminus">-      this.persistedIDs.add(ids.getNext());</span>
<a href="#l3.180"></a><span id="l3.180" class="difflineminus">-    }</span>
<a href="#l3.181"></a><span id="l3.181" class="difflineminus">-</span>
<a href="#l3.182"></a><span id="l3.182" class="difflineminus">-    // At this point, all (recursive) overlays are loaded. Unloaded scripts and sheets are ready and</span>
<a href="#l3.183"></a><span id="l3.183" class="difflineminus">-    // in order, and forward references are good to process.</span>
<a href="#l3.184"></a><span id="l3.184" class="difflineminus">-    let previous = 0;</span>
<a href="#l3.185"></a><span id="l3.185" class="difflineminus">-    while (forwardReferences.length &amp;&amp; forwardReferences.length != previous) {</span>
<a href="#l3.186"></a><span id="l3.186" class="difflineminus">-      previous = forwardReferences.length;</span>
<a href="#l3.187"></a><span id="l3.187" class="difflineminus">-      let unresolved = [];</span>
<a href="#l3.188"></a><span id="l3.188" class="difflineminus">-</span>
<a href="#l3.189"></a><span id="l3.189" class="difflineminus">-      for (let ref of forwardReferences) {</span>
<a href="#l3.190"></a><span id="l3.190" class="difflineminus">-        if (!this._resolveForwardReference(ref)) {</span>
<a href="#l3.191"></a><span id="l3.191" class="difflineminus">-          unresolved.push(ref);</span>
<a href="#l3.192"></a><span id="l3.192" class="difflineminus">-        }</span>
<a href="#l3.193"></a><span id="l3.193" class="difflineminus">-      }</span>
<a href="#l3.194"></a><span id="l3.194" class="difflineminus">-</span>
<a href="#l3.195"></a><span id="l3.195" class="difflineminus">-      forwardReferences = unresolved;</span>
<a href="#l3.196"></a><span id="l3.196" class="difflineminus">-    }</span>
<a href="#l3.197"></a><span id="l3.197" class="difflineminus">-</span>
<a href="#l3.198"></a><span id="l3.198" class="difflineminus">-    if (forwardReferences.length) {</span>
<a href="#l3.199"></a><span id="l3.199" class="difflineminus">-      oconsole.warn(</span>
<a href="#l3.200"></a><span id="l3.200" class="difflineminus">-        `Could not resolve ${forwardReferences.length} references`,</span>
<a href="#l3.201"></a><span id="l3.201" class="difflineminus">-        forwardReferences</span>
<a href="#l3.202"></a><span id="l3.202" class="difflineminus">-      );</span>
<a href="#l3.203"></a><span id="l3.203" class="difflineminus">-    }</span>
<a href="#l3.204"></a><span id="l3.204" class="difflineminus">-</span>
<a href="#l3.205"></a><span id="l3.205" class="difflineminus">-    // Loading the sheets now to avoid race conditions with xbl bindings</span>
<a href="#l3.206"></a><span id="l3.206" class="difflineminus">-    for (let sheet of unloadedSheets) {</span>
<a href="#l3.207"></a><span id="l3.207" class="difflineminus">-      this.loadCSS(sheet);</span>
<a href="#l3.208"></a><span id="l3.208" class="difflineminus">-    }</span>
<a href="#l3.209"></a><span id="l3.209" class="difflineminus">-</span>
<a href="#l3.210"></a><span id="l3.210" class="difflineminus">-    this._decksToResolve = new Map();</span>
<a href="#l3.211"></a><span id="l3.211" class="difflineminus">-    for (let id of this.persistedIDs.values()) {</span>
<a href="#l3.212"></a><span id="l3.212" class="difflineminus">-      let element = this.document.getElementById(id);</span>
<a href="#l3.213"></a><span id="l3.213" class="difflineminus">-      if (element) {</span>
<a href="#l3.214"></a><span id="l3.214" class="difflineminus">-        let attrNames = xulStore.getAttributeEnumerator(this.location, id);</span>
<a href="#l3.215"></a><span id="l3.215" class="difflineminus">-        while (attrNames.hasMore()) {</span>
<a href="#l3.216"></a><span id="l3.216" class="difflineminus">-          let attrName = attrNames.getNext();</span>
<a href="#l3.217"></a><span id="l3.217" class="difflineminus">-          let attrValue = xulStore.getValue(this.location, id, attrName);</span>
<a href="#l3.218"></a><span id="l3.218" class="difflineminus">-          if (attrName == &quot;selectedIndex&quot; &amp;&amp; element.localName == &quot;deck&quot;) {</span>
<a href="#l3.219"></a><span id="l3.219" class="difflineminus">-            this._decksToResolve.set(element, attrValue);</span>
<a href="#l3.220"></a><span id="l3.220" class="difflineminus">-          } else if (</span>
<a href="#l3.221"></a><span id="l3.221" class="difflineminus">-            element != this.document.documentElement ||</span>
<a href="#l3.222"></a><span id="l3.222" class="difflineminus">-            ![&quot;height&quot;, &quot;screenX&quot;, &quot;screenY&quot;, &quot;sizemode&quot;, &quot;width&quot;].includes(</span>
<a href="#l3.223"></a><span id="l3.223" class="difflineminus">-              attrName</span>
<a href="#l3.224"></a><span id="l3.224" class="difflineminus">-            )</span>
<a href="#l3.225"></a><span id="l3.225" class="difflineminus">-          ) {</span>
<a href="#l3.226"></a><span id="l3.226" class="difflineminus">-            element.setAttribute(attrName, attrValue);</span>
<a href="#l3.227"></a><span id="l3.227" class="difflineminus">-          }</span>
<a href="#l3.228"></a><span id="l3.228" class="difflineminus">-        }</span>
<a href="#l3.229"></a><span id="l3.229" class="difflineminus">-      }</span>
<a href="#l3.230"></a><span id="l3.230" class="difflineminus">-    }</span>
<a href="#l3.231"></a><span id="l3.231" class="difflineminus">-</span>
<a href="#l3.232"></a><span id="l3.232" class="difflineminus">-    // We've resolved all the forward references we can, we can now go ahead and load the scripts</span>
<a href="#l3.233"></a><span id="l3.233" class="difflineminus">-    let deferredLoad = [];</span>
<a href="#l3.234"></a><span id="l3.234" class="difflineminus">-    for (let script of unloadedScripts) {</span>
<a href="#l3.235"></a><span id="l3.235" class="difflineminus">-      deferredLoad.push(...this.loadScript(script));</span>
<a href="#l3.236"></a><span id="l3.236" class="difflineminus">-    }</span>
<a href="#l3.237"></a><span id="l3.237" class="difflineminus">-</span>
<a href="#l3.238"></a><span id="l3.238" class="difflineminus">-    if (this.document.readyState == &quot;complete&quot;) {</span>
<a href="#l3.239"></a><span id="l3.239" class="difflineminus">-      setTimeout(() =&gt; {</span>
<a href="#l3.240"></a><span id="l3.240" class="difflineminus">-        this._finish();</span>
<a href="#l3.241"></a><span id="l3.241" class="difflineminus">-</span>
<a href="#l3.242"></a><span id="l3.242" class="difflineminus">-        // Now execute load handlers since we are done loading scripts</span>
<a href="#l3.243"></a><span id="l3.243" class="difflineminus">-        let bubbles = [];</span>
<a href="#l3.244"></a><span id="l3.244" class="difflineminus">-        for (let { listener, useCapture } of deferredLoad) {</span>
<a href="#l3.245"></a><span id="l3.245" class="difflineminus">-          if (useCapture) {</span>
<a href="#l3.246"></a><span id="l3.246" class="difflineminus">-            this._fireEventListener(listener);</span>
<a href="#l3.247"></a><span id="l3.247" class="difflineminus">-          } else {</span>
<a href="#l3.248"></a><span id="l3.248" class="difflineminus">-            bubbles.push(listener);</span>
<a href="#l3.249"></a><span id="l3.249" class="difflineminus">-          }</span>
<a href="#l3.250"></a><span id="l3.250" class="difflineminus">-        }</span>
<a href="#l3.251"></a><span id="l3.251" class="difflineminus">-</span>
<a href="#l3.252"></a><span id="l3.252" class="difflineminus">-        for (let listener of bubbles) {</span>
<a href="#l3.253"></a><span id="l3.253" class="difflineminus">-          this._fireEventListener(listener);</span>
<a href="#l3.254"></a><span id="l3.254" class="difflineminus">-        }</span>
<a href="#l3.255"></a><span id="l3.255" class="difflineminus">-      });</span>
<a href="#l3.256"></a><span id="l3.256" class="difflineminus">-    } else {</span>
<a href="#l3.257"></a><span id="l3.257" class="difflineminus">-      this.document.defaultView.addEventListener(</span>
<a href="#l3.258"></a><span id="l3.258" class="difflineminus">-        &quot;load&quot;,</span>
<a href="#l3.259"></a><span id="l3.259" class="difflineminus">-        this._finish.bind(this),</span>
<a href="#l3.260"></a><span id="l3.260" class="difflineminus">-        { once: true }</span>
<a href="#l3.261"></a><span id="l3.261" class="difflineminus">-      );</span>
<a href="#l3.262"></a><span id="l3.262" class="difflineminus">-    }</span>
<a href="#l3.263"></a><span id="l3.263" class="difflineminus">-  }</span>
<a href="#l3.264"></a><span id="l3.264" class="difflineminus">-</span>
<a href="#l3.265"></a><span id="l3.265" class="difflineminus">-  _finish() {</span>
<a href="#l3.266"></a><span id="l3.266" class="difflineminus">-    for (let [deck, selectedIndex] of this._decksToResolve.entries()) {</span>
<a href="#l3.267"></a><span id="l3.267" class="difflineminus">-      deck.setAttribute(&quot;selectedIndex&quot;, selectedIndex);</span>
<a href="#l3.268"></a><span id="l3.268" class="difflineminus">-    }</span>
<a href="#l3.269"></a><span id="l3.269" class="difflineminus">-</span>
<a href="#l3.270"></a><span id="l3.270" class="difflineminus">-    for (let bar of this._toolbarsToResolve) {</span>
<a href="#l3.271"></a><span id="l3.271" class="difflineminus">-      let currentset = Services.xulStore.getValue(</span>
<a href="#l3.272"></a><span id="l3.272" class="difflineminus">-        this.location,</span>
<a href="#l3.273"></a><span id="l3.273" class="difflineminus">-        bar.id,</span>
<a href="#l3.274"></a><span id="l3.274" class="difflineminus">-        &quot;currentset&quot;</span>
<a href="#l3.275"></a><span id="l3.275" class="difflineminus">-      );</span>
<a href="#l3.276"></a><span id="l3.276" class="difflineminus">-      if (currentset) {</span>
<a href="#l3.277"></a><span id="l3.277" class="difflineminus">-        bar.currentSet = currentset;</span>
<a href="#l3.278"></a><span id="l3.278" class="difflineminus">-      } else if (bar.getAttribute(&quot;defaultset&quot;)) {</span>
<a href="#l3.279"></a><span id="l3.279" class="difflineminus">-        bar.currentSet = bar.getAttribute(&quot;defaultset&quot;);</span>
<a href="#l3.280"></a><span id="l3.280" class="difflineminus">-      }</span>
<a href="#l3.281"></a><span id="l3.281" class="difflineminus">-    }</span>
<a href="#l3.282"></a><span id="l3.282" class="difflineminus">-  }</span>
<a href="#l3.283"></a><span id="l3.283" class="difflineminus">-</span>
<a href="#l3.284"></a><span id="l3.284" class="difflineminus">-  /**</span>
<a href="#l3.285"></a><span id="l3.285" class="difflineminus">-   * Gets the overlays referenced by processing instruction on a document.</span>
<a href="#l3.286"></a><span id="l3.286" class="difflineminus">-   *</span>
<a href="#l3.287"></a><span id="l3.287" class="difflineminus">-   * @param {DOMDocument} document  The document to read instuctions from</span>
<a href="#l3.288"></a><span id="l3.288" class="difflineminus">-   * @return {String[]}             URLs of the overlays from the document</span>
<a href="#l3.289"></a><span id="l3.289" class="difflineminus">-   */</span>
<a href="#l3.290"></a><span id="l3.290" class="difflineminus">-  _collectOverlays(doc) {</span>
<a href="#l3.291"></a><span id="l3.291" class="difflineminus">-    let urls = [];</span>
<a href="#l3.292"></a><span id="l3.292" class="difflineminus">-    let instructions = doc.evaluate(</span>
<a href="#l3.293"></a><span id="l3.293" class="difflineminus">-      &quot;/processing-instruction('xul-overlay')&quot;,</span>
<a href="#l3.294"></a><span id="l3.294" class="difflineminus">-      doc,</span>
<a href="#l3.295"></a><span id="l3.295" class="difflineminus">-      null,</span>
<a href="#l3.296"></a><span id="l3.296" class="difflineminus">-      7,</span>
<a href="#l3.297"></a><span id="l3.297" class="difflineminus">-      null</span>
<a href="#l3.298"></a><span id="l3.298" class="difflineminus">-    );</span>
<a href="#l3.299"></a><span id="l3.299" class="difflineminus">-    for (let i = 0, len = instructions.snapshotLength; i &lt; len; ++i) {</span>
<a href="#l3.300"></a><span id="l3.300" class="difflineminus">-      let node = instructions.snapshotItem(i);</span>
<a href="#l3.301"></a><span id="l3.301" class="difflineminus">-      let match = node.nodeValue.match(/href=[&quot;']([^&quot;']*)[&quot;']/);</span>
<a href="#l3.302"></a><span id="l3.302" class="difflineminus">-      if (match) {</span>
<a href="#l3.303"></a><span id="l3.303" class="difflineminus">-        urls.push(match[1]);</span>
<a href="#l3.304"></a><span id="l3.304" class="difflineminus">-      }</span>
<a href="#l3.305"></a><span id="l3.305" class="difflineminus">-    }</span>
<a href="#l3.306"></a><span id="l3.306" class="difflineminus">-    return urls;</span>
<a href="#l3.307"></a><span id="l3.307" class="difflineminus">-  }</span>
<a href="#l3.308"></a><span id="l3.308" class="difflineminus">-</span>
<a href="#l3.309"></a><span id="l3.309" class="difflineminus">-  /**</span>
<a href="#l3.310"></a><span id="l3.310" class="difflineminus">-   * Fires a &quot;load&quot; event for the given listener, using the current window</span>
<a href="#l3.311"></a><span id="l3.311" class="difflineminus">-   *</span>
<a href="#l3.312"></a><span id="l3.312" class="difflineminus">-   * @param {EventListener|Function} listener       The event listener to call</span>
<a href="#l3.313"></a><span id="l3.313" class="difflineminus">-   */</span>
<a href="#l3.314"></a><span id="l3.314" class="difflineminus">-  _fireEventListener(listener) {</span>
<a href="#l3.315"></a><span id="l3.315" class="difflineminus">-    let fakeEvent = new this.window.UIEvent(&quot;load&quot;, { view: this.window });</span>
<a href="#l3.316"></a><span id="l3.316" class="difflineminus">-    if (typeof listener == &quot;function&quot;) {</span>
<a href="#l3.317"></a><span id="l3.317" class="difflineminus">-      listener(fakeEvent);</span>
<a href="#l3.318"></a><span id="l3.318" class="difflineminus">-    } else if (listener &amp;&amp; typeof listener == &quot;object&quot;) {</span>
<a href="#l3.319"></a><span id="l3.319" class="difflineminus">-      listener.handleEvent(fakeEvent);</span>
<a href="#l3.320"></a><span id="l3.320" class="difflineminus">-    } else {</span>
<a href="#l3.321"></a><span id="l3.321" class="difflineminus">-      oconsole.error(&quot;Unknown listener type&quot;, listener);</span>
<a href="#l3.322"></a><span id="l3.322" class="difflineminus">-    }</span>
<a href="#l3.323"></a><span id="l3.323" class="difflineminus">-  }</span>
<a href="#l3.324"></a><span id="l3.324" class="difflineminus">-</span>
<a href="#l3.325"></a><span id="l3.325" class="difflineminus">-  /**</span>
<a href="#l3.326"></a><span id="l3.326" class="difflineminus">-   * Resolves forward references for the given node. If the node exists in the target document, it</span>
<a href="#l3.327"></a><span id="l3.327" class="difflineminus">-   * is merged in with the target node. If the node has no id it is inserted at documentElement</span>
<a href="#l3.328"></a><span id="l3.328" class="difflineminus">-   * level.</span>
<a href="#l3.329"></a><span id="l3.329" class="difflineminus">-   *</span>
<a href="#l3.330"></a><span id="l3.330" class="difflineminus">-   * @param {Element} node          The DOM Element to resolve in the target document.</span>
<a href="#l3.331"></a><span id="l3.331" class="difflineminus">-   * @return {Boolean}              True, if the node was merged/inserted, false otherwise</span>
<a href="#l3.332"></a><span id="l3.332" class="difflineminus">-   */</span>
<a href="#l3.333"></a><span id="l3.333" class="difflineminus">-  _resolveForwardReference(node) {</span>
<a href="#l3.334"></a><span id="l3.334" class="difflineminus">-    if (node.id) {</span>
<a href="#l3.335"></a><span id="l3.335" class="difflineminus">-      let target = this.document.getElementById(node.id);</span>
<a href="#l3.336"></a><span id="l3.336" class="difflineminus">-      if (node.localName == &quot;toolbarpalette&quot;) {</span>
<a href="#l3.337"></a><span id="l3.337" class="difflineminus">-        let box;</span>
<a href="#l3.338"></a><span id="l3.338" class="difflineminus">-        if (target) {</span>
<a href="#l3.339"></a><span id="l3.339" class="difflineminus">-          box = target.closest(&quot;toolbox&quot;);</span>
<a href="#l3.340"></a><span id="l3.340" class="difflineminus">-        } else {</span>
<a href="#l3.341"></a><span id="l3.341" class="difflineminus">-          // These vanish from the document but still exist via the palette property</span>
<a href="#l3.342"></a><span id="l3.342" class="difflineminus">-          let boxes = [...this.document.getElementsByTagName(&quot;toolbox&quot;)];</span>
<a href="#l3.343"></a><span id="l3.343" class="difflineminus">-          box = boxes.find(box =&gt; box.palette &amp;&amp; box.palette.id == node.id);</span>
<a href="#l3.344"></a><span id="l3.344" class="difflineminus">-          let palette = box ? box.palette : null;</span>
<a href="#l3.345"></a><span id="l3.345" class="difflineminus">-</span>
<a href="#l3.346"></a><span id="l3.346" class="difflineminus">-          if (!palette) {</span>
<a href="#l3.347"></a><span id="l3.347" class="difflineminus">-            oconsole.debug(</span>
<a href="#l3.348"></a><span id="l3.348" class="difflineminus">-              `The palette for ${</span>
<a href="#l3.349"></a><span id="l3.349" class="difflineminus">-                node.id</span>
<a href="#l3.350"></a><span id="l3.350" class="difflineminus">-              } could not be found, deferring to later`</span>
<a href="#l3.351"></a><span id="l3.351" class="difflineminus">-            );</span>
<a href="#l3.352"></a><span id="l3.352" class="difflineminus">-            return false;</span>
<a href="#l3.353"></a><span id="l3.353" class="difflineminus">-          }</span>
<a href="#l3.354"></a><span id="l3.354" class="difflineminus">-</span>
<a href="#l3.355"></a><span id="l3.355" class="difflineminus">-          target = palette;</span>
<a href="#l3.356"></a><span id="l3.356" class="difflineminus">-        }</span>
<a href="#l3.357"></a><span id="l3.357" class="difflineminus">-</span>
<a href="#l3.358"></a><span id="l3.358" class="difflineminus">-        this._toolbarsToResolve.push(...box.querySelectorAll(&quot;toolbar&quot;));</span>
<a href="#l3.359"></a><span id="l3.359" class="difflineminus">-        this._toolbarsToResolve.push(</span>
<a href="#l3.360"></a><span id="l3.360" class="difflineminus">-          ...this.document.querySelectorAll(`toolbar[toolboxid=&quot;${box.id}&quot;]`)</span>
<a href="#l3.361"></a><span id="l3.361" class="difflineminus">-        );</span>
<a href="#l3.362"></a><span id="l3.362" class="difflineminus">-      } else if (!target) {</span>
<a href="#l3.363"></a><span id="l3.363" class="difflineminus">-        oconsole.debug(</span>
<a href="#l3.364"></a><span id="l3.364" class="difflineminus">-          `The node ${node.id} could not be found, deferring to later`</span>
<a href="#l3.365"></a><span id="l3.365" class="difflineminus">-        );</span>
<a href="#l3.366"></a><span id="l3.366" class="difflineminus">-        return false;</span>
<a href="#l3.367"></a><span id="l3.367" class="difflineminus">-      }</span>
<a href="#l3.368"></a><span id="l3.368" class="difflineminus">-</span>
<a href="#l3.369"></a><span id="l3.369" class="difflineminus">-      this._mergeElement(target, node);</span>
<a href="#l3.370"></a><span id="l3.370" class="difflineminus">-    } else {</span>
<a href="#l3.371"></a><span id="l3.371" class="difflineminus">-      this._insertElement(this.document.documentElement, node);</span>
<a href="#l3.372"></a><span id="l3.372" class="difflineminus">-    }</span>
<a href="#l3.373"></a><span id="l3.373" class="difflineminus">-    return true;</span>
<a href="#l3.374"></a><span id="l3.374" class="difflineminus">-  }</span>
<a href="#l3.375"></a><span id="l3.375" class="difflineminus">-</span>
<a href="#l3.376"></a><span id="l3.376" class="difflineminus">-  /**</span>
<a href="#l3.377"></a><span id="l3.377" class="difflineminus">-   * Insert the node in the given parent, observing the insertbefore/insertafter/position attributes</span>
<a href="#l3.378"></a><span id="l3.378" class="difflineminus">-   *</span>
<a href="#l3.379"></a><span id="l3.379" class="difflineminus">-   * @param {Element} parent        The parent element to insert the node into.</span>
<a href="#l3.380"></a><span id="l3.380" class="difflineminus">-   * @param {Element} node          The node to insert.</span>
<a href="#l3.381"></a><span id="l3.381" class="difflineminus">-   */</span>
<a href="#l3.382"></a><span id="l3.382" class="difflineminus">-  _insertElement(parent, node) {</span>
<a href="#l3.383"></a><span id="l3.383" class="difflineminus">-    // These elements need their values set before they are added to</span>
<a href="#l3.384"></a><span id="l3.384" class="difflineminus">-    // the document, or bad things happen.</span>
<a href="#l3.385"></a><span id="l3.385" class="difflineminus">-    for (let element of node.querySelectorAll(&quot;menulist&quot;)) {</span>
<a href="#l3.386"></a><span id="l3.386" class="difflineminus">-      if (element.id &amp;&amp; this.persistedIDs.has(element.id)) {</span>
<a href="#l3.387"></a><span id="l3.387" class="difflineminus">-        element.setAttribute(</span>
<a href="#l3.388"></a><span id="l3.388" class="difflineminus">-          &quot;value&quot;,</span>
<a href="#l3.389"></a><span id="l3.389" class="difflineminus">-          Services.xulStore.getValue(this.location, element.id, &quot;value&quot;)</span>
<a href="#l3.390"></a><span id="l3.390" class="difflineminus">-        );</span>
<a href="#l3.391"></a><span id="l3.391" class="difflineminus">-      }</span>
<a href="#l3.392"></a><span id="l3.392" class="difflineminus">-    }</span>
<a href="#l3.393"></a><span id="l3.393" class="difflineminus">-</span>
<a href="#l3.394"></a><span id="l3.394" class="difflineminus">-    if (node.localName == &quot;toolbar&quot;) {</span>
<a href="#l3.395"></a><span id="l3.395" class="difflineminus">-      this._toolbarsToResolve.push(node);</span>
<a href="#l3.396"></a><span id="l3.396" class="difflineminus">-    } else {</span>
<a href="#l3.397"></a><span id="l3.397" class="difflineminus">-      this._toolbarsToResolve.push(...node.querySelectorAll(&quot;toolbar&quot;));</span>
<a href="#l3.398"></a><span id="l3.398" class="difflineminus">-    }</span>
<a href="#l3.399"></a><span id="l3.399" class="difflineminus">-</span>
<a href="#l3.400"></a><span id="l3.400" class="difflineminus">-    let wasInserted = false;</span>
<a href="#l3.401"></a><span id="l3.401" class="difflineminus">-    let pos = node.getAttribute(&quot;insertafter&quot;);</span>
<a href="#l3.402"></a><span id="l3.402" class="difflineminus">-    let after = true;</span>
<a href="#l3.403"></a><span id="l3.403" class="difflineminus">-</span>
<a href="#l3.404"></a><span id="l3.404" class="difflineminus">-    if (!pos) {</span>
<a href="#l3.405"></a><span id="l3.405" class="difflineminus">-      pos = node.getAttribute(&quot;insertbefore&quot;);</span>
<a href="#l3.406"></a><span id="l3.406" class="difflineminus">-      after = false;</span>
<a href="#l3.407"></a><span id="l3.407" class="difflineminus">-    }</span>
<a href="#l3.408"></a><span id="l3.408" class="difflineminus">-</span>
<a href="#l3.409"></a><span id="l3.409" class="difflineminus">-    if (pos) {</span>
<a href="#l3.410"></a><span id="l3.410" class="difflineminus">-      for (let id of pos.split(&quot;,&quot;)) {</span>
<a href="#l3.411"></a><span id="l3.411" class="difflineminus">-        let targetchild = this.document.getElementById(id);</span>
<a href="#l3.412"></a><span id="l3.412" class="difflineminus">-        if (targetchild &amp;&amp; targetchild.parentNode == parent) {</span>
<a href="#l3.413"></a><span id="l3.413" class="difflineminus">-          parent.insertBefore(</span>
<a href="#l3.414"></a><span id="l3.414" class="difflineminus">-            node,</span>
<a href="#l3.415"></a><span id="l3.415" class="difflineminus">-            after ? targetchild.nextElementSibling : targetchild</span>
<a href="#l3.416"></a><span id="l3.416" class="difflineminus">-          );</span>
<a href="#l3.417"></a><span id="l3.417" class="difflineminus">-          wasInserted = true;</span>
<a href="#l3.418"></a><span id="l3.418" class="difflineminus">-          break;</span>
<a href="#l3.419"></a><span id="l3.419" class="difflineminus">-        }</span>
<a href="#l3.420"></a><span id="l3.420" class="difflineminus">-      }</span>
<a href="#l3.421"></a><span id="l3.421" class="difflineminus">-    }</span>
<a href="#l3.422"></a><span id="l3.422" class="difflineminus">-</span>
<a href="#l3.423"></a><span id="l3.423" class="difflineminus">-    if (!wasInserted) {</span>
<a href="#l3.424"></a><span id="l3.424" class="difflineminus">-      // position is 1-based</span>
<a href="#l3.425"></a><span id="l3.425" class="difflineminus">-      let position = parseInt(node.getAttribute(&quot;position&quot;), 10);</span>
<a href="#l3.426"></a><span id="l3.426" class="difflineminus">-      if (position &gt; 0 &amp;&amp; position - 1 &lt;= parent.children.length) {</span>
<a href="#l3.427"></a><span id="l3.427" class="difflineminus">-        parent.insertBefore(node, parent.children[position - 1]);</span>
<a href="#l3.428"></a><span id="l3.428" class="difflineminus">-        wasInserted = true;</span>
<a href="#l3.429"></a><span id="l3.429" class="difflineminus">-      }</span>
<a href="#l3.430"></a><span id="l3.430" class="difflineminus">-    }</span>
<a href="#l3.431"></a><span id="l3.431" class="difflineminus">-</span>
<a href="#l3.432"></a><span id="l3.432" class="difflineminus">-    if (!wasInserted) {</span>
<a href="#l3.433"></a><span id="l3.433" class="difflineminus">-      parent.appendChild(node);</span>
<a href="#l3.434"></a><span id="l3.434" class="difflineminus">-    }</span>
<a href="#l3.435"></a><span id="l3.435" class="difflineminus">-  }</span>
<a href="#l3.436"></a><span id="l3.436" class="difflineminus">-</span>
<a href="#l3.437"></a><span id="l3.437" class="difflineminus">-  /**</span>
<a href="#l3.438"></a><span id="l3.438" class="difflineminus">-   * Merge the node into the target, adhering to the removeelement attribute, merging further</span>
<a href="#l3.439"></a><span id="l3.439" class="difflineminus">-   * attributes into the target node, and merging children as appropriate for xul nodes. If a child</span>
<a href="#l3.440"></a><span id="l3.440" class="difflineminus">-   * has an id, it will be searched in the target document and recursively merged.</span>
<a href="#l3.441"></a><span id="l3.441" class="difflineminus">-   *</span>
<a href="#l3.442"></a><span id="l3.442" class="difflineminus">-   * @param {Element} target        The node to merge into</span>
<a href="#l3.443"></a><span id="l3.443" class="difflineminus">-   * @param {Element} node          The node that is being merged</span>
<a href="#l3.444"></a><span id="l3.444" class="difflineminus">-   */</span>
<a href="#l3.445"></a><span id="l3.445" class="difflineminus">-  _mergeElement(target, node) {</span>
<a href="#l3.446"></a><span id="l3.446" class="difflineminus">-    for (let attribute of node.attributes) {</span>
<a href="#l3.447"></a><span id="l3.447" class="difflineminus">-      if (attribute.name == &quot;id&quot;) {</span>
<a href="#l3.448"></a><span id="l3.448" class="difflineminus">-        continue;</span>
<a href="#l3.449"></a><span id="l3.449" class="difflineminus">-      }</span>
<a href="#l3.450"></a><span id="l3.450" class="difflineminus">-</span>
<a href="#l3.451"></a><span id="l3.451" class="difflineminus">-      if (attribute.name == &quot;removeelement&quot; &amp;&amp; attribute.value == &quot;true&quot;) {</span>
<a href="#l3.452"></a><span id="l3.452" class="difflineminus">-        target.remove();</span>
<a href="#l3.453"></a><span id="l3.453" class="difflineminus">-        return;</span>
<a href="#l3.454"></a><span id="l3.454" class="difflineminus">-      }</span>
<a href="#l3.455"></a><span id="l3.455" class="difflineminus">-</span>
<a href="#l3.456"></a><span id="l3.456" class="difflineminus">-      target.setAttributeNS(</span>
<a href="#l3.457"></a><span id="l3.457" class="difflineminus">-        attribute.namespaceURI,</span>
<a href="#l3.458"></a><span id="l3.458" class="difflineminus">-        attribute.name,</span>
<a href="#l3.459"></a><span id="l3.459" class="difflineminus">-        attribute.value</span>
<a href="#l3.460"></a><span id="l3.460" class="difflineminus">-      );</span>
<a href="#l3.461"></a><span id="l3.461" class="difflineminus">-    }</span>
<a href="#l3.462"></a><span id="l3.462" class="difflineminus">-</span>
<a href="#l3.463"></a><span id="l3.463" class="difflineminus">-    for (let i = 0, len = node.childElementCount; i &lt; len; i++) {</span>
<a href="#l3.464"></a><span id="l3.464" class="difflineminus">-      let child = node.firstElementChild;</span>
<a href="#l3.465"></a><span id="l3.465" class="difflineminus">-      child.remove();</span>
<a href="#l3.466"></a><span id="l3.466" class="difflineminus">-</span>
<a href="#l3.467"></a><span id="l3.467" class="difflineminus">-      let elementInDocument = child.id</span>
<a href="#l3.468"></a><span id="l3.468" class="difflineminus">-        ? this.document.getElementById(child.id)</span>
<a href="#l3.469"></a><span id="l3.469" class="difflineminus">-        : null;</span>
<a href="#l3.470"></a><span id="l3.470" class="difflineminus">-      let parentId = elementInDocument ? elementInDocument.parentNode.id : null;</span>
<a href="#l3.471"></a><span id="l3.471" class="difflineminus">-</span>
<a href="#l3.472"></a><span id="l3.472" class="difflineminus">-      if (parentId &amp;&amp; parentId == target.id) {</span>
<a href="#l3.473"></a><span id="l3.473" class="difflineminus">-        this._mergeElement(elementInDocument, child);</span>
<a href="#l3.474"></a><span id="l3.474" class="difflineminus">-      } else {</span>
<a href="#l3.475"></a><span id="l3.475" class="difflineminus">-        this._insertElement(target, child);</span>
<a href="#l3.476"></a><span id="l3.476" class="difflineminus">-      }</span>
<a href="#l3.477"></a><span id="l3.477" class="difflineminus">-    }</span>
<a href="#l3.478"></a><span id="l3.478" class="difflineminus">-  }</span>
<a href="#l3.479"></a><span id="l3.479" class="difflineminus">-</span>
<a href="#l3.480"></a><span id="l3.480" class="difflineminus">-  /**</span>
<a href="#l3.481"></a><span id="l3.481" class="difflineminus">-   * Fetches the overlay from the given chrome:// or resource:// URL. This happen synchronously so</span>
<a href="#l3.482"></a><span id="l3.482" class="difflineminus">-   * we have a chance to complete before the load event.</span>
<a href="#l3.483"></a><span id="l3.483" class="difflineminus">-   *</span>
<a href="#l3.484"></a><span id="l3.484" class="difflineminus">-   * @param {String} srcUrl                         The URL to load</span>
<a href="#l3.485"></a><span id="l3.485" class="difflineminus">-   * @return {XMLHttpRequest}                       The completed XHR.</span>
<a href="#l3.486"></a><span id="l3.486" class="difflineminus">-   */</span>
<a href="#l3.487"></a><span id="l3.487" class="difflineminus">-  fetchOverlay(srcUrl) {</span>
<a href="#l3.488"></a><span id="l3.488" class="difflineminus">-    if (!srcUrl.startsWith(&quot;chrome://&quot;) &amp;&amp; !srcUrl.startsWith(&quot;resource://&quot;)) {</span>
<a href="#l3.489"></a><span id="l3.489" class="difflineminus">-      throw new Error(</span>
<a href="#l3.490"></a><span id="l3.490" class="difflineminus">-        &quot;May only load overlays from chrome:// or resource:// uris&quot;</span>
<a href="#l3.491"></a><span id="l3.491" class="difflineminus">-      );</span>
<a href="#l3.492"></a><span id="l3.492" class="difflineminus">-    }</span>
<a href="#l3.493"></a><span id="l3.493" class="difflineminus">-</span>
<a href="#l3.494"></a><span id="l3.494" class="difflineminus">-    let xhr = new this.window.XMLHttpRequest();</span>
<a href="#l3.495"></a><span id="l3.495" class="difflineminus">-    xhr.overrideMimeType(&quot;application/xml&quot;);</span>
<a href="#l3.496"></a><span id="l3.496" class="difflineminus">-    xhr.open(&quot;GET&quot;, srcUrl, false);</span>
<a href="#l3.497"></a><span id="l3.497" class="difflineminus">-</span>
<a href="#l3.498"></a><span id="l3.498" class="difflineminus">-    // Elevate the request, so DTDs will work. Should not be a security issue since we</span>
<a href="#l3.499"></a><span id="l3.499" class="difflineminus">-    // only load chrome, resource and file URLs, and that is our privileged chrome package.</span>
<a href="#l3.500"></a><span id="l3.500" class="difflineminus">-    try {</span>
<a href="#l3.501"></a><span id="l3.501" class="difflineminus">-      xhr.channel.owner = Services.scriptSecurityManager.getSystemPrincipal();</span>
<a href="#l3.502"></a><span id="l3.502" class="difflineminus">-    } catch (ex) {</span>
<a href="#l3.503"></a><span id="l3.503" class="difflineminus">-      oconsole.error(</span>
<a href="#l3.504"></a><span id="l3.504" class="difflineminus">-        &quot;Failed to set system principal while fetching overlay &quot; + srcUrl</span>
<a href="#l3.505"></a><span id="l3.505" class="difflineminus">-      );</span>
<a href="#l3.506"></a><span id="l3.506" class="difflineminus">-      xhr.close();</span>
<a href="#l3.507"></a><span id="l3.507" class="difflineminus">-      throw new Error(&quot;Failed to set system principal&quot;);</span>
<a href="#l3.508"></a><span id="l3.508" class="difflineminus">-    }</span>
<a href="#l3.509"></a><span id="l3.509" class="difflineminus">-</span>
<a href="#l3.510"></a><span id="l3.510" class="difflineminus">-    xhr.send(null);</span>
<a href="#l3.511"></a><span id="l3.511" class="difflineminus">-    return xhr;</span>
<a href="#l3.512"></a><span id="l3.512" class="difflineminus">-  }</span>
<a href="#l3.513"></a><span id="l3.513" class="difflineminus">-</span>
<a href="#l3.514"></a><span id="l3.514" class="difflineminus">-  /**</span>
<a href="#l3.515"></a><span id="l3.515" class="difflineminus">-   * Loads scripts described by the given script node. The node can either have a src attribute, or</span>
<a href="#l3.516"></a><span id="l3.516" class="difflineminus">-   * be an inline script with textContent.</span>
<a href="#l3.517"></a><span id="l3.517" class="difflineminus">-   *</span>
<a href="#l3.518"></a><span id="l3.518" class="difflineminus">-   * @param {Element} node                          The &lt;script&gt; element to load the script from</span>
<a href="#l3.519"></a><span id="l3.519" class="difflineminus">-   * @return {Object[]}                             An object with listener and useCapture,</span>
<a href="#l3.520"></a><span id="l3.520" class="difflineminus">-   *                                                  describing load handlers the script creates</span>
<a href="#l3.521"></a><span id="l3.521" class="difflineminus">-   *                                                  when first run.</span>
<a href="#l3.522"></a><span id="l3.522" class="difflineminus">-   */</span>
<a href="#l3.523"></a><span id="l3.523" class="difflineminus">-  loadScript(node) {</span>
<a href="#l3.524"></a><span id="l3.524" class="difflineminus">-    let deferredLoad = [];</span>
<a href="#l3.525"></a><span id="l3.525" class="difflineminus">-</span>
<a href="#l3.526"></a><span id="l3.526" class="difflineminus">-    let oldAddEventListener = this.window.addEventListener;</span>
<a href="#l3.527"></a><span id="l3.527" class="difflineminus">-    if (this.document.readyState == &quot;complete&quot;) {</span>
<a href="#l3.528"></a><span id="l3.528" class="difflineminus">-      this.window.addEventListener = function(</span>
<a href="#l3.529"></a><span id="l3.529" class="difflineminus">-        type,</span>
<a href="#l3.530"></a><span id="l3.530" class="difflineminus">-        listener,</span>
<a href="#l3.531"></a><span id="l3.531" class="difflineminus">-        useCapture,</span>
<a href="#l3.532"></a><span id="l3.532" class="difflineminus">-        ...args</span>
<a href="#l3.533"></a><span id="l3.533" class="difflineminus">-      ) {</span>
<a href="#l3.534"></a><span id="l3.534" class="difflineminus">-        if (type == &quot;load&quot;) {</span>
<a href="#l3.535"></a><span id="l3.535" class="difflineminus">-          if (typeof useCapture == &quot;object&quot;) {</span>
<a href="#l3.536"></a><span id="l3.536" class="difflineminus">-            useCapture = useCapture.capture;</span>
<a href="#l3.537"></a><span id="l3.537" class="difflineminus">-          }</span>
<a href="#l3.538"></a><span id="l3.538" class="difflineminus">-</span>
<a href="#l3.539"></a><span id="l3.539" class="difflineminus">-          if (typeof useCapture == &quot;undefined&quot;) {</span>
<a href="#l3.540"></a><span id="l3.540" class="difflineminus">-            useCapture = true;</span>
<a href="#l3.541"></a><span id="l3.541" class="difflineminus">-          }</span>
<a href="#l3.542"></a><span id="l3.542" class="difflineminus">-          deferredLoad.push({ listener, useCapture });</span>
<a href="#l3.543"></a><span id="l3.543" class="difflineminus">-          return null;</span>
<a href="#l3.544"></a><span id="l3.544" class="difflineminus">-        }</span>
<a href="#l3.545"></a><span id="l3.545" class="difflineminus">-        return oldAddEventListener.call(</span>
<a href="#l3.546"></a><span id="l3.546" class="difflineminus">-          this,</span>
<a href="#l3.547"></a><span id="l3.547" class="difflineminus">-          type,</span>
<a href="#l3.548"></a><span id="l3.548" class="difflineminus">-          listener,</span>
<a href="#l3.549"></a><span id="l3.549" class="difflineminus">-          useCapture,</span>
<a href="#l3.550"></a><span id="l3.550" class="difflineminus">-          ...args</span>
<a href="#l3.551"></a><span id="l3.551" class="difflineminus">-        );</span>
<a href="#l3.552"></a><span id="l3.552" class="difflineminus">-      };</span>
<a href="#l3.553"></a><span id="l3.553" class="difflineminus">-    }</span>
<a href="#l3.554"></a><span id="l3.554" class="difflineminus">-</span>
<a href="#l3.555"></a><span id="l3.555" class="difflineminus">-    if (node.hasAttribute(&quot;src&quot;)) {</span>
<a href="#l3.556"></a><span id="l3.556" class="difflineminus">-      let url = new URL(node.getAttribute(&quot;src&quot;), node.baseURI).href;</span>
<a href="#l3.557"></a><span id="l3.557" class="difflineminus">-      oconsole.debug(`Loading script ${url} into ${this.window.location}`);</span>
<a href="#l3.558"></a><span id="l3.558" class="difflineminus">-      try {</span>
<a href="#l3.559"></a><span id="l3.559" class="difflineminus">-        Services.scriptloader.loadSubScript(url, this.window);</span>
<a href="#l3.560"></a><span id="l3.560" class="difflineminus">-      } catch (ex) {</span>
<a href="#l3.561"></a><span id="l3.561" class="difflineminus">-        Cu.reportError(ex);</span>
<a href="#l3.562"></a><span id="l3.562" class="difflineminus">-      }</span>
<a href="#l3.563"></a><span id="l3.563" class="difflineminus">-    } else if (node.textContent) {</span>
<a href="#l3.564"></a><span id="l3.564" class="difflineminus">-      oconsole.debug(`Loading eval'd script into ${this.window.location}`);</span>
<a href="#l3.565"></a><span id="l3.565" class="difflineminus">-      try {</span>
<a href="#l3.566"></a><span id="l3.566" class="difflineminus">-        let dataURL =</span>
<a href="#l3.567"></a><span id="l3.567" class="difflineminus">-          &quot;data:application/javascript,&quot; + encodeURIComponent(node.textContent);</span>
<a href="#l3.568"></a><span id="l3.568" class="difflineminus">-        // It would be great if we could have script errors show the right url, but for now</span>
<a href="#l3.569"></a><span id="l3.569" class="difflineminus">-        // loadSubScript will have to do.</span>
<a href="#l3.570"></a><span id="l3.570" class="difflineminus">-        Services.scriptloader.loadSubScript(dataURL, this.window);</span>
<a href="#l3.571"></a><span id="l3.571" class="difflineminus">-      } catch (ex) {</span>
<a href="#l3.572"></a><span id="l3.572" class="difflineminus">-        Cu.reportError(ex);</span>
<a href="#l3.573"></a><span id="l3.573" class="difflineminus">-      }</span>
<a href="#l3.574"></a><span id="l3.574" class="difflineminus">-    }</span>
<a href="#l3.575"></a><span id="l3.575" class="difflineminus">-</span>
<a href="#l3.576"></a><span id="l3.576" class="difflineminus">-    if (this.document.readyState == &quot;complete&quot;) {</span>
<a href="#l3.577"></a><span id="l3.577" class="difflineminus">-      this.window.addEventListener = oldAddEventListener;</span>
<a href="#l3.578"></a><span id="l3.578" class="difflineminus">-    }</span>
<a href="#l3.579"></a><span id="l3.579" class="difflineminus">-</span>
<a href="#l3.580"></a><span id="l3.580" class="difflineminus">-    // This works because we only care about immediately executed addEventListener calls and</span>
<a href="#l3.581"></a><span id="l3.581" class="difflineminus">-    // loadSubScript is synchronous. Everyone else should be checking readyState anyway.</span>
<a href="#l3.582"></a><span id="l3.582" class="difflineminus">-    return deferredLoad;</span>
<a href="#l3.583"></a><span id="l3.583" class="difflineminus">-  }</span>
<a href="#l3.584"></a><span id="l3.584" class="difflineminus">-</span>
<a href="#l3.585"></a><span id="l3.585" class="difflineminus">-  /**</span>
<a href="#l3.586"></a><span id="l3.586" class="difflineminus">-   * Load the CSS stylesheet from the given url</span>
<a href="#l3.587"></a><span id="l3.587" class="difflineminus">-   *</span>
<a href="#l3.588"></a><span id="l3.588" class="difflineminus">-   * @param {String} url        The url to load from</span>
<a href="#l3.589"></a><span id="l3.589" class="difflineminus">-   * @return {Element}          An HTML link element for this stylesheet</span>
<a href="#l3.590"></a><span id="l3.590" class="difflineminus">-   */</span>
<a href="#l3.591"></a><span id="l3.591" class="difflineminus">-  loadCSS(url) {</span>
<a href="#l3.592"></a><span id="l3.592" class="difflineminus">-    oconsole.debug(`Loading ${url} into ${this.window.location}`);</span>
<a href="#l3.593"></a><span id="l3.593" class="difflineminus">-</span>
<a href="#l3.594"></a><span id="l3.594" class="difflineminus">-    // domWindowUtils.loadSheetUsingURIString doesn't record the sheet in document.styleSheets,</span>
<a href="#l3.595"></a><span id="l3.595" class="difflineminus">-    // adding a html link element seems to do so.</span>
<a href="#l3.596"></a><span id="l3.596" class="difflineminus">-    let link = this.document.createElementNS(</span>
<a href="#l3.597"></a><span id="l3.597" class="difflineminus">-      &quot;http://www.w3.org/1999/xhtml&quot;,</span>
<a href="#l3.598"></a><span id="l3.598" class="difflineminus">-      &quot;link&quot;</span>
<a href="#l3.599"></a><span id="l3.599" class="difflineminus">-    );</span>
<a href="#l3.600"></a><span id="l3.600" class="difflineminus">-    link.setAttribute(&quot;rel&quot;, &quot;stylesheet&quot;);</span>
<a href="#l3.601"></a><span id="l3.601" class="difflineminus">-    link.setAttribute(&quot;type&quot;, &quot;text/css&quot;);</span>
<a href="#l3.602"></a><span id="l3.602" class="difflineminus">-    link.setAttribute(&quot;href&quot;, url);</span>
<a href="#l3.603"></a><span id="l3.603" class="difflineminus">-</span>
<a href="#l3.604"></a><span id="l3.604" class="difflineminus">-    this.document.documentElement.appendChild(link);</span>
<a href="#l3.605"></a><span id="l3.605" class="difflineminus">-    return link;</span>
<a href="#l3.606"></a><span id="l3.606" class="difflineminus">-  }</span>
<a href="#l3.607"></a><span id="l3.607" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/common/src/moz.build</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/common/src/moz.build</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -1,17 +1,16 @@</span>
<a href="#l4.4"></a><span id="l4.4"> # vim: set filetype=python:</span>
<a href="#l4.5"></a><span id="l4.5"> # This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l4.6"></a><span id="l4.6"> # License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l4.7"></a><span id="l4.7"> # file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l4.8"></a><span id="l4.8"> </span>
<a href="#l4.9"></a><span id="l4.9"> EXTRA_JS_MODULES += [</span>
<a href="#l4.10"></a><span id="l4.10">     'ChromeManifest.jsm',</span>
<a href="#l4.11"></a><span id="l4.11">     'ExtensionSupport.jsm',</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-    'Overlays.jsm',</span>
<a href="#l4.13"></a><span id="l4.13"> ]</span>
<a href="#l4.14"></a><span id="l4.14"> </span>
<a href="#l4.15"></a><span id="l4.15"> SOURCES += [</span>
<a href="#l4.16"></a><span id="l4.16">     'nsCommonModule.cpp',</span>
<a href="#l4.17"></a><span id="l4.17">     'nsComponentManagerExtra.cpp',</span>
<a href="#l4.18"></a><span id="l4.18"> ]</span>
<a href="#l4.19"></a><span id="l4.19"> </span>
<a href="#l4.20"></a><span id="l4.20"> if CONFIG['OS_ARCH'] == 'WINNT':</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1">deleted file mode 100644</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineminus">--- a/common/test/xpcshell/data/BootstrapMonitor.jsm</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineplus">+++ /dev/null</span>
<a href="#l5.4"></a><span id="l5.4" class="difflineat">@@ -1,41 +0,0 @@</span>
<a href="#l5.5"></a><span id="l5.5" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l5.6"></a><span id="l5.6" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l5.7"></a><span id="l5.7" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l5.8"></a><span id="l5.8" class="difflineminus">-</span>
<a href="#l5.9"></a><span id="l5.9" class="difflineminus">-const { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l5.10"></a><span id="l5.10" class="difflineminus">-</span>
<a href="#l5.11"></a><span id="l5.11" class="difflineminus">-var EXPORTED_SYMBOLS = [&quot;monitor&quot;];</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineminus">-function notify(event, originalMethod, data, reason) {</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineminus">-  let info = {</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineminus">-    event,</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineminus">-    data: Object.assign({}, data, {</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineminus">-      resourceURI: data.resourceURI.spec,</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineminus">-    }),</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineminus">-    reason,</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineminus">-  };</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineminus">-</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineminus">-  let subject = { wrappedJSObject: { data } };</span>
<a href="#l5.23"></a><span id="l5.23" class="difflineminus">-</span>
<a href="#l5.24"></a><span id="l5.24" class="difflineminus">-  Services.obs.notifyObservers(</span>
<a href="#l5.25"></a><span id="l5.25" class="difflineminus">-    subject,</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineminus">-    &quot;bootstrapmonitor-event&quot;,</span>
<a href="#l5.27"></a><span id="l5.27" class="difflineminus">-    JSON.stringify(info)</span>
<a href="#l5.28"></a><span id="l5.28" class="difflineminus">-  );</span>
<a href="#l5.29"></a><span id="l5.29" class="difflineminus">-</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineminus">-  // If the bootstrap scope already declares a method call it</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineminus">-  if (originalMethod) {</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineminus">-    originalMethod(data, reason);</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineminus">-  }</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineminus">-}</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineminus">-</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineminus">-// Allows a simple one-line bootstrap script:</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineminus">-// Components.utils.import(&quot;resource://xpcshelldata/bootstrapmonitor.jsm&quot;).monitor(this);</span>
<a href="#l5.38"></a><span id="l5.38" class="difflineminus">-var monitor = function(</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineminus">-  scope,</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineminus">-  methods = [&quot;install&quot;, &quot;startup&quot;, &quot;shutdown&quot;, &quot;uninstall&quot;]</span>
<a href="#l5.41"></a><span id="l5.41" class="difflineminus">-) {</span>
<a href="#l5.42"></a><span id="l5.42" class="difflineminus">-  for (let event of methods) {</span>
<a href="#l5.43"></a><span id="l5.43" class="difflineminus">-    scope[event] = notify.bind(null, event, scope[event]);</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineminus">-  }</span>
<a href="#l5.45"></a><span id="l5.45" class="difflineminus">-};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1">deleted file mode 100644</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineminus">--- a/common/test/xpcshell/head_addons.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineplus">+++ /dev/null</span>
<a href="#l6.4"></a><span id="l6.4" class="difflineat">@@ -1,1534 +0,0 @@</span>
<a href="#l6.5"></a><span id="l6.5" class="difflineminus">-/* Any copyright is dedicated to the Public Domain.</span>
<a href="#l6.6"></a><span id="l6.6" class="difflineminus">- * http://creativecommons.org/publicdomain/zero/1.0/</span>
<a href="#l6.7"></a><span id="l6.7" class="difflineminus">- */</span>
<a href="#l6.8"></a><span id="l6.8" class="difflineminus">-</span>
<a href="#l6.9"></a><span id="l6.9" class="difflineminus">-const PREF_EM_CHECK_UPDATE_SECURITY = &quot;extensions.checkUpdateSecurity&quot;;</span>
<a href="#l6.10"></a><span id="l6.10" class="difflineminus">-const PREF_EM_STRICT_COMPATIBILITY = &quot;extensions.strictCompatibility&quot;;</span>
<a href="#l6.11"></a><span id="l6.11" class="difflineminus">-const PREF_GETADDONS_BYIDS = &quot;extensions.getAddons.get.url&quot;;</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-const PREF_COMPAT_OVERRIDES = &quot;extensions.getAddons.compatOverides.url&quot;;</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-const PREF_XPI_SIGNATURES_REQUIRED = &quot;xpinstall.signatures.required&quot;;</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineminus">-</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineminus">-const PREF_DISABLE_SECURITY =</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineminus">-  &quot;security.turn_off_all_security_so_that_&quot; +</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineminus">-  &quot;viruses_can_take_over_this_computer&quot;;</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineminus">-</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineminus">-// Maximum error in file modification times. Some file systems don't store</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineminus">-// modification times exactly. As long as we are closer than this then it</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineminus">-// still passes.</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineminus">-const MAX_TIME_DIFFERENCE = 3000;</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineminus">-</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineminus">-// Time to reset file modified time relative to Date.now() so we can test that</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineminus">-// times are modified (10 hours old).</span>
<a href="#l6.26"></a><span id="l6.26" class="difflineminus">-const MAKE_FILE_OLD_DIFFERENCE = 10 * 3600 * 1000;</span>
<a href="#l6.27"></a><span id="l6.27" class="difflineminus">-</span>
<a href="#l6.28"></a><span id="l6.28" class="difflineminus">-var { AppConstants } = ChromeUtils.import(</span>
<a href="#l6.29"></a><span id="l6.29" class="difflineminus">-  &quot;resource://gre/modules/AppConstants.jsm&quot;</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineminus">-);</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineminus">-var { FileUtils } = ChromeUtils.import(&quot;resource://gre/modules/FileUtils.jsm&quot;);</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineminus">-var { NetUtil } = ChromeUtils.import(&quot;resource://gre/modules/NetUtil.jsm&quot;);</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineminus">-var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineminus">-var { XPCOMUtils } = ChromeUtils.import(</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineminus">-  &quot;resource://gre/modules/XPCOMUtils.jsm&quot;</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineminus">-);</span>
<a href="#l6.37"></a><span id="l6.37" class="difflineminus">-var { AddonRepository } = ChromeUtils.import(</span>
<a href="#l6.38"></a><span id="l6.38" class="difflineminus">-  &quot;resource://gre/modules/addons/AddonRepository.jsm&quot;</span>
<a href="#l6.39"></a><span id="l6.39" class="difflineminus">-);</span>
<a href="#l6.40"></a><span id="l6.40" class="difflineminus">-var { OS } = ChromeUtils.import(&quot;resource://gre/modules/osfile.jsm&quot;);</span>
<a href="#l6.41"></a><span id="l6.41" class="difflineminus">-</span>
<a href="#l6.42"></a><span id="l6.42" class="difflineminus">-var { AddonTestUtils, MockAsyncShutdown } = ChromeUtils.import(</span>
<a href="#l6.43"></a><span id="l6.43" class="difflineminus">-  &quot;resource://testing-common/AddonTestUtils.jsm&quot;</span>
<a href="#l6.44"></a><span id="l6.44" class="difflineminus">-);</span>
<a href="#l6.45"></a><span id="l6.45" class="difflineminus">-</span>
<a href="#l6.46"></a><span id="l6.46" class="difflineminus">-ChromeUtils.defineModuleGetter(</span>
<a href="#l6.47"></a><span id="l6.47" class="difflineminus">-  this,</span>
<a href="#l6.48"></a><span id="l6.48" class="difflineminus">-  &quot;Blocklist&quot;,</span>
<a href="#l6.49"></a><span id="l6.49" class="difflineminus">-  &quot;resource://gre/modules/Blocklist.jsm&quot;</span>
<a href="#l6.50"></a><span id="l6.50" class="difflineminus">-);</span>
<a href="#l6.51"></a><span id="l6.51" class="difflineminus">-ChromeUtils.defineModuleGetter(</span>
<a href="#l6.52"></a><span id="l6.52" class="difflineminus">-  this,</span>
<a href="#l6.53"></a><span id="l6.53" class="difflineminus">-  &quot;Extension&quot;,</span>
<a href="#l6.54"></a><span id="l6.54" class="difflineminus">-  &quot;resource://gre/modules/Extension.jsm&quot;</span>
<a href="#l6.55"></a><span id="l6.55" class="difflineminus">-);</span>
<a href="#l6.56"></a><span id="l6.56" class="difflineminus">-ChromeUtils.defineModuleGetter(</span>
<a href="#l6.57"></a><span id="l6.57" class="difflineminus">-  this,</span>
<a href="#l6.58"></a><span id="l6.58" class="difflineminus">-  &quot;ExtensionTestUtils&quot;,</span>
<a href="#l6.59"></a><span id="l6.59" class="difflineminus">-  &quot;resource://testing-common/ExtensionXPCShellUtils.jsm&quot;</span>
<a href="#l6.60"></a><span id="l6.60" class="difflineminus">-);</span>
<a href="#l6.61"></a><span id="l6.61" class="difflineminus">-ChromeUtils.defineModuleGetter(</span>
<a href="#l6.62"></a><span id="l6.62" class="difflineminus">-  this,</span>
<a href="#l6.63"></a><span id="l6.63" class="difflineminus">-  &quot;ExtensionTestCommon&quot;,</span>
<a href="#l6.64"></a><span id="l6.64" class="difflineminus">-  &quot;resource://testing-common/ExtensionTestCommon.jsm&quot;</span>
<a href="#l6.65"></a><span id="l6.65" class="difflineminus">-);</span>
<a href="#l6.66"></a><span id="l6.66" class="difflineminus">-ChromeUtils.defineModuleGetter(</span>
<a href="#l6.67"></a><span id="l6.67" class="difflineminus">-  this,</span>
<a href="#l6.68"></a><span id="l6.68" class="difflineminus">-  &quot;HttpServer&quot;,</span>
<a href="#l6.69"></a><span id="l6.69" class="difflineminus">-  &quot;resource://testing-common/httpd.js&quot;</span>
<a href="#l6.70"></a><span id="l6.70" class="difflineminus">-);</span>
<a href="#l6.71"></a><span id="l6.71" class="difflineminus">-ChromeUtils.defineModuleGetter(</span>
<a href="#l6.72"></a><span id="l6.72" class="difflineminus">-  this,</span>
<a href="#l6.73"></a><span id="l6.73" class="difflineminus">-  &quot;MockRegistrar&quot;,</span>
<a href="#l6.74"></a><span id="l6.74" class="difflineminus">-  &quot;resource://testing-common/MockRegistrar.jsm&quot;</span>
<a href="#l6.75"></a><span id="l6.75" class="difflineminus">-);</span>
<a href="#l6.76"></a><span id="l6.76" class="difflineminus">-ChromeUtils.defineModuleGetter(</span>
<a href="#l6.77"></a><span id="l6.77" class="difflineminus">-  this,</span>
<a href="#l6.78"></a><span id="l6.78" class="difflineminus">-  &quot;MockRegistry&quot;,</span>
<a href="#l6.79"></a><span id="l6.79" class="difflineminus">-  &quot;resource://testing-common/MockRegistry.jsm&quot;</span>
<a href="#l6.80"></a><span id="l6.80" class="difflineminus">-);</span>
<a href="#l6.81"></a><span id="l6.81" class="difflineminus">-ChromeUtils.defineModuleGetter(</span>
<a href="#l6.82"></a><span id="l6.82" class="difflineminus">-  this,</span>
<a href="#l6.83"></a><span id="l6.83" class="difflineminus">-  &quot;PromiseTestUtils&quot;,</span>
<a href="#l6.84"></a><span id="l6.84" class="difflineminus">-  &quot;resource://testing-common/PromiseTestUtils.jsm&quot;</span>
<a href="#l6.85"></a><span id="l6.85" class="difflineminus">-);</span>
<a href="#l6.86"></a><span id="l6.86" class="difflineminus">-ChromeUtils.defineModuleGetter(</span>
<a href="#l6.87"></a><span id="l6.87" class="difflineminus">-  this,</span>
<a href="#l6.88"></a><span id="l6.88" class="difflineminus">-  &quot;TestUtils&quot;,</span>
<a href="#l6.89"></a><span id="l6.89" class="difflineminus">-  &quot;resource://testing-common/TestUtils.jsm&quot;</span>
<a href="#l6.90"></a><span id="l6.90" class="difflineminus">-);</span>
<a href="#l6.91"></a><span id="l6.91" class="difflineminus">-</span>
<a href="#l6.92"></a><span id="l6.92" class="difflineminus">-XPCOMUtils.defineLazyServiceGetter(</span>
<a href="#l6.93"></a><span id="l6.93" class="difflineminus">-  this,</span>
<a href="#l6.94"></a><span id="l6.94" class="difflineminus">-  &quot;aomStartup&quot;,</span>
<a href="#l6.95"></a><span id="l6.95" class="difflineminus">-  &quot;@mozilla.org/addons/addon-manager-startup;1&quot;,</span>
<a href="#l6.96"></a><span id="l6.96" class="difflineminus">-  &quot;amIAddonManagerStartup&quot;</span>
<a href="#l6.97"></a><span id="l6.97" class="difflineminus">-);</span>
<a href="#l6.98"></a><span id="l6.98" class="difflineminus">-</span>
<a href="#l6.99"></a><span id="l6.99" class="difflineminus">-const {</span>
<a href="#l6.100"></a><span id="l6.100" class="difflineminus">-  createAppInfo,</span>
<a href="#l6.101"></a><span id="l6.101" class="difflineminus">-  createHttpServer,</span>
<a href="#l6.102"></a><span id="l6.102" class="difflineminus">-  createTempWebExtensionFile,</span>
<a href="#l6.103"></a><span id="l6.103" class="difflineminus">-  getFileForAddon,</span>
<a href="#l6.104"></a><span id="l6.104" class="difflineminus">-  manuallyInstall,</span>
<a href="#l6.105"></a><span id="l6.105" class="difflineminus">-  manuallyUninstall,</span>
<a href="#l6.106"></a><span id="l6.106" class="difflineminus">-  overrideBuiltIns,</span>
<a href="#l6.107"></a><span id="l6.107" class="difflineminus">-  promiseAddonEvent,</span>
<a href="#l6.108"></a><span id="l6.108" class="difflineminus">-  promiseCompleteAllInstalls,</span>
<a href="#l6.109"></a><span id="l6.109" class="difflineminus">-  promiseCompleteInstall,</span>
<a href="#l6.110"></a><span id="l6.110" class="difflineminus">-  promiseConsoleOutput,</span>
<a href="#l6.111"></a><span id="l6.111" class="difflineminus">-  promiseFindAddonUpdates,</span>
<a href="#l6.112"></a><span id="l6.112" class="difflineminus">-  promiseInstallAllFiles,</span>
<a href="#l6.113"></a><span id="l6.113" class="difflineminus">-  promiseInstallFile,</span>
<a href="#l6.114"></a><span id="l6.114" class="difflineminus">-  promiseRestartManager,</span>
<a href="#l6.115"></a><span id="l6.115" class="difflineminus">-  promiseSetExtensionModifiedTime,</span>
<a href="#l6.116"></a><span id="l6.116" class="difflineminus">-  promiseShutdownManager,</span>
<a href="#l6.117"></a><span id="l6.117" class="difflineminus">-  promiseStartupManager,</span>
<a href="#l6.118"></a><span id="l6.118" class="difflineminus">-  promiseWebExtensionStartup,</span>
<a href="#l6.119"></a><span id="l6.119" class="difflineminus">-  promiseWriteProxyFileToDir,</span>
<a href="#l6.120"></a><span id="l6.120" class="difflineminus">-  registerDirectory,</span>
<a href="#l6.121"></a><span id="l6.121" class="difflineminus">-  setExtensionModifiedTime,</span>
<a href="#l6.122"></a><span id="l6.122" class="difflineminus">-  writeFilesToZip,</span>
<a href="#l6.123"></a><span id="l6.123" class="difflineminus">-} = AddonTestUtils;</span>
<a href="#l6.124"></a><span id="l6.124" class="difflineminus">-</span>
<a href="#l6.125"></a><span id="l6.125" class="difflineminus">-// WebExtension wrapper for ease of testing</span>
<a href="#l6.126"></a><span id="l6.126" class="difflineminus">-ExtensionTestUtils.init(this);</span>
<a href="#l6.127"></a><span id="l6.127" class="difflineminus">-</span>
<a href="#l6.128"></a><span id="l6.128" class="difflineminus">-AddonTestUtils.init(this, false);</span>
<a href="#l6.129"></a><span id="l6.129" class="difflineminus">-AddonTestUtils.overrideCertDB();</span>
<a href="#l6.130"></a><span id="l6.130" class="difflineminus">-</span>
<a href="#l6.131"></a><span id="l6.131" class="difflineminus">-XPCOMUtils.defineLazyGetter(</span>
<a href="#l6.132"></a><span id="l6.132" class="difflineminus">-  this,</span>
<a href="#l6.133"></a><span id="l6.133" class="difflineminus">-  &quot;BOOTSTRAP_REASONS&quot;,</span>
<a href="#l6.134"></a><span id="l6.134" class="difflineminus">-  () =&gt; AddonManagerPrivate.BOOTSTRAP_REASONS</span>
<a href="#l6.135"></a><span id="l6.135" class="difflineminus">-);</span>
<a href="#l6.136"></a><span id="l6.136" class="difflineminus">-</span>
<a href="#l6.137"></a><span id="l6.137" class="difflineminus">-function getReasonName(reason) {</span>
<a href="#l6.138"></a><span id="l6.138" class="difflineminus">-  for (let key of Object.keys(BOOTSTRAP_REASONS)) {</span>
<a href="#l6.139"></a><span id="l6.139" class="difflineminus">-    if (BOOTSTRAP_REASONS[key] == reason) {</span>
<a href="#l6.140"></a><span id="l6.140" class="difflineminus">-      return key;</span>
<a href="#l6.141"></a><span id="l6.141" class="difflineminus">-    }</span>
<a href="#l6.142"></a><span id="l6.142" class="difflineminus">-  }</span>
<a href="#l6.143"></a><span id="l6.143" class="difflineminus">-  throw new Error(&quot;This shouldn't happen.&quot;);</span>
<a href="#l6.144"></a><span id="l6.144" class="difflineminus">-}</span>
<a href="#l6.145"></a><span id="l6.145" class="difflineminus">-</span>
<a href="#l6.146"></a><span id="l6.146" class="difflineminus">-Object.defineProperty(this, &quot;gAppInfo&quot;, {</span>
<a href="#l6.147"></a><span id="l6.147" class="difflineminus">-  get() {</span>
<a href="#l6.148"></a><span id="l6.148" class="difflineminus">-    return AddonTestUtils.appInfo;</span>
<a href="#l6.149"></a><span id="l6.149" class="difflineminus">-  },</span>
<a href="#l6.150"></a><span id="l6.150" class="difflineminus">-});</span>
<a href="#l6.151"></a><span id="l6.151" class="difflineminus">-</span>
<a href="#l6.152"></a><span id="l6.152" class="difflineminus">-Object.defineProperty(this, &quot;gAddonStartup&quot;, {</span>
<a href="#l6.153"></a><span id="l6.153" class="difflineminus">-  get() {</span>
<a href="#l6.154"></a><span id="l6.154" class="difflineminus">-    return AddonTestUtils.addonStartup.clone();</span>
<a href="#l6.155"></a><span id="l6.155" class="difflineminus">-  },</span>
<a href="#l6.156"></a><span id="l6.156" class="difflineminus">-});</span>
<a href="#l6.157"></a><span id="l6.157" class="difflineminus">-</span>
<a href="#l6.158"></a><span id="l6.158" class="difflineminus">-Object.defineProperty(this, &quot;gInternalManager&quot;, {</span>
<a href="#l6.159"></a><span id="l6.159" class="difflineminus">-  get() {</span>
<a href="#l6.160"></a><span id="l6.160" class="difflineminus">-    return AddonTestUtils.addonIntegrationService.QueryInterface(</span>
<a href="#l6.161"></a><span id="l6.161" class="difflineminus">-      Ci.nsITimerCallback</span>
<a href="#l6.162"></a><span id="l6.162" class="difflineminus">-    );</span>
<a href="#l6.163"></a><span id="l6.163" class="difflineminus">-  },</span>
<a href="#l6.164"></a><span id="l6.164" class="difflineminus">-});</span>
<a href="#l6.165"></a><span id="l6.165" class="difflineminus">-</span>
<a href="#l6.166"></a><span id="l6.166" class="difflineminus">-Object.defineProperty(this, &quot;gProfD&quot;, {</span>
<a href="#l6.167"></a><span id="l6.167" class="difflineminus">-  get() {</span>
<a href="#l6.168"></a><span id="l6.168" class="difflineminus">-    return AddonTestUtils.profileDir.clone();</span>
<a href="#l6.169"></a><span id="l6.169" class="difflineminus">-  },</span>
<a href="#l6.170"></a><span id="l6.170" class="difflineminus">-});</span>
<a href="#l6.171"></a><span id="l6.171" class="difflineminus">-</span>
<a href="#l6.172"></a><span id="l6.172" class="difflineminus">-Object.defineProperty(this, &quot;gTmpD&quot;, {</span>
<a href="#l6.173"></a><span id="l6.173" class="difflineminus">-  get() {</span>
<a href="#l6.174"></a><span id="l6.174" class="difflineminus">-    return AddonTestUtils.tempDir.clone();</span>
<a href="#l6.175"></a><span id="l6.175" class="difflineminus">-  },</span>
<a href="#l6.176"></a><span id="l6.176" class="difflineminus">-});</span>
<a href="#l6.177"></a><span id="l6.177" class="difflineminus">-</span>
<a href="#l6.178"></a><span id="l6.178" class="difflineminus">-Object.defineProperty(this, &quot;gUseRealCertChecks&quot;, {</span>
<a href="#l6.179"></a><span id="l6.179" class="difflineminus">-  get() {</span>
<a href="#l6.180"></a><span id="l6.180" class="difflineminus">-    return AddonTestUtils.useRealCertChecks;</span>
<a href="#l6.181"></a><span id="l6.181" class="difflineminus">-  },</span>
<a href="#l6.182"></a><span id="l6.182" class="difflineminus">-  set(val) {</span>
<a href="#l6.183"></a><span id="l6.183" class="difflineminus">-    return (AddonTestUtils.useRealCertChecks = val);</span>
<a href="#l6.184"></a><span id="l6.184" class="difflineminus">-  },</span>
<a href="#l6.185"></a><span id="l6.185" class="difflineminus">-});</span>
<a href="#l6.186"></a><span id="l6.186" class="difflineminus">-</span>
<a href="#l6.187"></a><span id="l6.187" class="difflineminus">-Object.defineProperty(this, &quot;TEST_UNPACKED&quot;, {</span>
<a href="#l6.188"></a><span id="l6.188" class="difflineminus">-  get() {</span>
<a href="#l6.189"></a><span id="l6.189" class="difflineminus">-    return AddonTestUtils.testUnpacked;</span>
<a href="#l6.190"></a><span id="l6.190" class="difflineminus">-  },</span>
<a href="#l6.191"></a><span id="l6.191" class="difflineminus">-  set(val) {</span>
<a href="#l6.192"></a><span id="l6.192" class="difflineminus">-    return (AddonTestUtils.testUnpacked = val);</span>
<a href="#l6.193"></a><span id="l6.193" class="difflineminus">-  },</span>
<a href="#l6.194"></a><span id="l6.194" class="difflineminus">-});</span>
<a href="#l6.195"></a><span id="l6.195" class="difflineminus">-</span>
<a href="#l6.196"></a><span id="l6.196" class="difflineminus">-// We need some internal bits of AddonManager</span>
<a href="#l6.197"></a><span id="l6.197" class="difflineminus">-var {</span>
<a href="#l6.198"></a><span id="l6.198" class="difflineminus">-  AddonManager,</span>
<a href="#l6.199"></a><span id="l6.199" class="difflineminus">-  AddonManagerInternal,</span>
<a href="#l6.200"></a><span id="l6.200" class="difflineminus">-  AddonManagerPrivate,</span>
<a href="#l6.201"></a><span id="l6.201" class="difflineminus">-} = ChromeUtils.import(&quot;resource://gre/modules/AddonManager.jsm&quot;);</span>
<a href="#l6.202"></a><span id="l6.202" class="difflineminus">-</span>
<a href="#l6.203"></a><span id="l6.203" class="difflineminus">-const promiseAddonByID = AddonManager.getAddonByID;</span>
<a href="#l6.204"></a><span id="l6.204" class="difflineminus">-const promiseAddonsByIDs = AddonManager.getAddonsByIDs;</span>
<a href="#l6.205"></a><span id="l6.205" class="difflineminus">-</span>
<a href="#l6.206"></a><span id="l6.206" class="difflineminus">-var gPort = null;</span>
<a href="#l6.207"></a><span id="l6.207" class="difflineminus">-var gUrlToFileMap = {};</span>
<a href="#l6.208"></a><span id="l6.208" class="difflineminus">-</span>
<a href="#l6.209"></a><span id="l6.209" class="difflineminus">-// Map resource://xpcshell-data/ to the data directory</span>
<a href="#l6.210"></a><span id="l6.210" class="difflineminus">-var resHandler = Services.io</span>
<a href="#l6.211"></a><span id="l6.211" class="difflineminus">-  .getProtocolHandler(&quot;resource&quot;)</span>
<a href="#l6.212"></a><span id="l6.212" class="difflineminus">-  .QueryInterface(Ci.nsISubstitutingProtocolHandler);</span>
<a href="#l6.213"></a><span id="l6.213" class="difflineminus">-// Allow non-existent files because of bug 1207735</span>
<a href="#l6.214"></a><span id="l6.214" class="difflineminus">-var dataURI = NetUtil.newURI(do_get_file(&quot;data&quot;, true));</span>
<a href="#l6.215"></a><span id="l6.215" class="difflineminus">-resHandler.setSubstitution(&quot;xpcshell-data&quot;, dataURI);</span>
<a href="#l6.216"></a><span id="l6.216" class="difflineminus">-</span>
<a href="#l6.217"></a><span id="l6.217" class="difflineminus">-function isManifestRegistered(file) {</span>
<a href="#l6.218"></a><span id="l6.218" class="difflineminus">-  let manifests = Components.manager.getManifestLocations();</span>
<a href="#l6.219"></a><span id="l6.219" class="difflineminus">-  for (let i = 0; i &lt; manifests.length; i++) {</span>
<a href="#l6.220"></a><span id="l6.220" class="difflineminus">-    let manifest = manifests.queryElementAt(i, Ci.nsIURI);</span>
<a href="#l6.221"></a><span id="l6.221" class="difflineminus">-</span>
<a href="#l6.222"></a><span id="l6.222" class="difflineminus">-    // manifest is the url to the manifest file either in an XPI or a directory.</span>
<a href="#l6.223"></a><span id="l6.223" class="difflineminus">-    // We want the location of the XPI or directory itself.</span>
<a href="#l6.224"></a><span id="l6.224" class="difflineminus">-    if (manifest instanceof Ci.nsIJARURI) {</span>
<a href="#l6.225"></a><span id="l6.225" class="difflineminus">-      manifest = manifest.JARFile.QueryInterface(Ci.nsIFileURL).file;</span>
<a href="#l6.226"></a><span id="l6.226" class="difflineminus">-    } else if (manifest instanceof Ci.nsIFileURL) {</span>
<a href="#l6.227"></a><span id="l6.227" class="difflineminus">-      manifest = manifest.file.parent;</span>
<a href="#l6.228"></a><span id="l6.228" class="difflineminus">-    } else {</span>
<a href="#l6.229"></a><span id="l6.229" class="difflineminus">-      continue;</span>
<a href="#l6.230"></a><span id="l6.230" class="difflineminus">-    }</span>
<a href="#l6.231"></a><span id="l6.231" class="difflineminus">-</span>
<a href="#l6.232"></a><span id="l6.232" class="difflineminus">-    if (manifest.equals(file)) {</span>
<a href="#l6.233"></a><span id="l6.233" class="difflineminus">-      return true;</span>
<a href="#l6.234"></a><span id="l6.234" class="difflineminus">-    }</span>
<a href="#l6.235"></a><span id="l6.235" class="difflineminus">-  }</span>
<a href="#l6.236"></a><span id="l6.236" class="difflineminus">-  return false;</span>
<a href="#l6.237"></a><span id="l6.237" class="difflineminus">-}</span>
<a href="#l6.238"></a><span id="l6.238" class="difflineminus">-</span>
<a href="#l6.239"></a><span id="l6.239" class="difflineminus">-const BOOTSTRAP_MONITOR_BOOTSTRAP_JS = `</span>
<a href="#l6.240"></a><span id="l6.240" class="difflineminus">-  ChromeUtils.import(&quot;resource://xpcshell-data/BootstrapMonitor.jsm&quot;).monitor(this);</span>
<a href="#l6.241"></a><span id="l6.241" class="difflineminus">-`;</span>
<a href="#l6.242"></a><span id="l6.242" class="difflineminus">-</span>
<a href="#l6.243"></a><span id="l6.243" class="difflineminus">-// Listens to messages from bootstrap.js telling us what add-ons were started</span>
<a href="#l6.244"></a><span id="l6.244" class="difflineminus">-// and stopped etc. and performs some sanity checks that only installed add-ons</span>
<a href="#l6.245"></a><span id="l6.245" class="difflineminus">-// are started etc.</span>
<a href="#l6.246"></a><span id="l6.246" class="difflineminus">-this.BootstrapMonitor = {</span>
<a href="#l6.247"></a><span id="l6.247" class="difflineminus">-  inited: false,</span>
<a href="#l6.248"></a><span id="l6.248" class="difflineminus">-</span>
<a href="#l6.249"></a><span id="l6.249" class="difflineminus">-  // Contain the current state of add-ons in the system</span>
<a href="#l6.250"></a><span id="l6.250" class="difflineminus">-  installed: new Map(),</span>
<a href="#l6.251"></a><span id="l6.251" class="difflineminus">-  started: new Map(),</span>
<a href="#l6.252"></a><span id="l6.252" class="difflineminus">-</span>
<a href="#l6.253"></a><span id="l6.253" class="difflineminus">-  // Contain the last state of shutdown and uninstall calls for an add-on</span>
<a href="#l6.254"></a><span id="l6.254" class="difflineminus">-  stopped: new Map(),</span>
<a href="#l6.255"></a><span id="l6.255" class="difflineminus">-  uninstalled: new Map(),</span>
<a href="#l6.256"></a><span id="l6.256" class="difflineminus">-</span>
<a href="#l6.257"></a><span id="l6.257" class="difflineminus">-  startupPromises: [],</span>
<a href="#l6.258"></a><span id="l6.258" class="difflineminus">-  installPromises: [],</span>
<a href="#l6.259"></a><span id="l6.259" class="difflineminus">-</span>
<a href="#l6.260"></a><span id="l6.260" class="difflineminus">-  restartfulIds: new Set(),</span>
<a href="#l6.261"></a><span id="l6.261" class="difflineminus">-</span>
<a href="#l6.262"></a><span id="l6.262" class="difflineminus">-  init() {</span>
<a href="#l6.263"></a><span id="l6.263" class="difflineminus">-    this.inited = true;</span>
<a href="#l6.264"></a><span id="l6.264" class="difflineminus">-    Services.obs.addObserver(this, &quot;bootstrapmonitor-event&quot;);</span>
<a href="#l6.265"></a><span id="l6.265" class="difflineminus">-  },</span>
<a href="#l6.266"></a><span id="l6.266" class="difflineminus">-</span>
<a href="#l6.267"></a><span id="l6.267" class="difflineminus">-  shutdownCheck() {</span>
<a href="#l6.268"></a><span id="l6.268" class="difflineminus">-    if (!this.inited) {</span>
<a href="#l6.269"></a><span id="l6.269" class="difflineminus">-      return;</span>
<a href="#l6.270"></a><span id="l6.270" class="difflineminus">-    }</span>
<a href="#l6.271"></a><span id="l6.271" class="difflineminus">-</span>
<a href="#l6.272"></a><span id="l6.272" class="difflineminus">-    Assert.equal(this.started.size, 0);</span>
<a href="#l6.273"></a><span id="l6.273" class="difflineminus">-  },</span>
<a href="#l6.274"></a><span id="l6.274" class="difflineminus">-</span>
<a href="#l6.275"></a><span id="l6.275" class="difflineminus">-  clear(id) {</span>
<a href="#l6.276"></a><span id="l6.276" class="difflineminus">-    this.installed.delete(id);</span>
<a href="#l6.277"></a><span id="l6.277" class="difflineminus">-    this.started.delete(id);</span>
<a href="#l6.278"></a><span id="l6.278" class="difflineminus">-    this.stopped.delete(id);</span>
<a href="#l6.279"></a><span id="l6.279" class="difflineminus">-    this.uninstalled.delete(id);</span>
<a href="#l6.280"></a><span id="l6.280" class="difflineminus">-  },</span>
<a href="#l6.281"></a><span id="l6.281" class="difflineminus">-</span>
<a href="#l6.282"></a><span id="l6.282" class="difflineminus">-  promiseAddonStartup(id) {</span>
<a href="#l6.283"></a><span id="l6.283" class="difflineminus">-    return new Promise(resolve =&gt; {</span>
<a href="#l6.284"></a><span id="l6.284" class="difflineminus">-      this.startupPromises.push(resolve);</span>
<a href="#l6.285"></a><span id="l6.285" class="difflineminus">-    });</span>
<a href="#l6.286"></a><span id="l6.286" class="difflineminus">-  },</span>
<a href="#l6.287"></a><span id="l6.287" class="difflineminus">-</span>
<a href="#l6.288"></a><span id="l6.288" class="difflineminus">-  promiseAddonInstall(id) {</span>
<a href="#l6.289"></a><span id="l6.289" class="difflineminus">-    return new Promise(resolve =&gt; {</span>
<a href="#l6.290"></a><span id="l6.290" class="difflineminus">-      this.installPromises.push(resolve);</span>
<a href="#l6.291"></a><span id="l6.291" class="difflineminus">-    });</span>
<a href="#l6.292"></a><span id="l6.292" class="difflineminus">-  },</span>
<a href="#l6.293"></a><span id="l6.293" class="difflineminus">-</span>
<a href="#l6.294"></a><span id="l6.294" class="difflineminus">-  checkMatches(cached, current) {</span>
<a href="#l6.295"></a><span id="l6.295" class="difflineminus">-    Assert.notEqual(cached, undefined);</span>
<a href="#l6.296"></a><span id="l6.296" class="difflineminus">-    Assert.equal(current.data.version, cached.data.version);</span>
<a href="#l6.297"></a><span id="l6.297" class="difflineminus">-    Assert.equal(current.data.installPath, cached.data.installPath);</span>
<a href="#l6.298"></a><span id="l6.298" class="difflineminus">-    Assert.ok(</span>
<a href="#l6.299"></a><span id="l6.299" class="difflineminus">-      Services.io</span>
<a href="#l6.300"></a><span id="l6.300" class="difflineminus">-        .newURI(current.data.resourceURI)</span>
<a href="#l6.301"></a><span id="l6.301" class="difflineminus">-        .equals(Services.io.newURI(cached.data.resourceURI)),</span>
<a href="#l6.302"></a><span id="l6.302" class="difflineminus">-      `Resource URIs match: &quot;${current.data.resourceURI}&quot; == &quot;${</span>
<a href="#l6.303"></a><span id="l6.303" class="difflineminus">-        cached.data.resourceURI</span>
<a href="#l6.304"></a><span id="l6.304" class="difflineminus">-      }&quot;`</span>
<a href="#l6.305"></a><span id="l6.305" class="difflineminus">-    );</span>
<a href="#l6.306"></a><span id="l6.306" class="difflineminus">-  },</span>
<a href="#l6.307"></a><span id="l6.307" class="difflineminus">-</span>
<a href="#l6.308"></a><span id="l6.308" class="difflineminus">-  checkAddonStarted(id, version = undefined) {</span>
<a href="#l6.309"></a><span id="l6.309" class="difflineminus">-    let started = this.started.get(id);</span>
<a href="#l6.310"></a><span id="l6.310" class="difflineminus">-    Assert.notEqual(started, undefined);</span>
<a href="#l6.311"></a><span id="l6.311" class="difflineminus">-    if (version != undefined) {</span>
<a href="#l6.312"></a><span id="l6.312" class="difflineminus">-      Assert.equal(started.data.version, version);</span>
<a href="#l6.313"></a><span id="l6.313" class="difflineminus">-    }</span>
<a href="#l6.314"></a><span id="l6.314" class="difflineminus">-</span>
<a href="#l6.315"></a><span id="l6.315" class="difflineminus">-    // Chrome should be registered by now</span>
<a href="#l6.316"></a><span id="l6.316" class="difflineminus">-    // Get the install path from the resource URI, since it is not passed any longer.</span>
<a href="#l6.317"></a><span id="l6.317" class="difflineminus">-    let uri = Services.io.newURI(started.data.resourceURI);</span>
<a href="#l6.318"></a><span id="l6.318" class="difflineminus">-    let jarFile = uri.QueryInterface(Ci.nsIJARURI).JARFile;</span>
<a href="#l6.319"></a><span id="l6.319" class="difflineminus">-    let installPath = jarFile.QueryInterface(Ci.nsIFileURL).file;</span>
<a href="#l6.320"></a><span id="l6.320" class="difflineminus">-</span>
<a href="#l6.321"></a><span id="l6.321" class="difflineminus">-    let isRegistered = isManifestRegistered(installPath);</span>
<a href="#l6.322"></a><span id="l6.322" class="difflineminus">-    Assert.ok(isRegistered);</span>
<a href="#l6.323"></a><span id="l6.323" class="difflineminus">-  },</span>
<a href="#l6.324"></a><span id="l6.324" class="difflineminus">-</span>
<a href="#l6.325"></a><span id="l6.325" class="difflineminus">-  checkAddonNotStarted(id) {</span>
<a href="#l6.326"></a><span id="l6.326" class="difflineminus">-    Assert.ok(!this.started.has(id));</span>
<a href="#l6.327"></a><span id="l6.327" class="difflineminus">-  },</span>
<a href="#l6.328"></a><span id="l6.328" class="difflineminus">-</span>
<a href="#l6.329"></a><span id="l6.329" class="difflineminus">-  checkAddonInstalled(id, version = undefined) {</span>
<a href="#l6.330"></a><span id="l6.330" class="difflineminus">-    const installed = this.installed.get(id);</span>
<a href="#l6.331"></a><span id="l6.331" class="difflineminus">-    notEqual(installed, undefined);</span>
<a href="#l6.332"></a><span id="l6.332" class="difflineminus">-    if (version !== undefined) {</span>
<a href="#l6.333"></a><span id="l6.333" class="difflineminus">-      equal(installed.data.version, version);</span>
<a href="#l6.334"></a><span id="l6.334" class="difflineminus">-    }</span>
<a href="#l6.335"></a><span id="l6.335" class="difflineminus">-    return installed;</span>
<a href="#l6.336"></a><span id="l6.336" class="difflineminus">-  },</span>
<a href="#l6.337"></a><span id="l6.337" class="difflineminus">-</span>
<a href="#l6.338"></a><span id="l6.338" class="difflineminus">-  checkAddonNotInstalled(id) {</span>
<a href="#l6.339"></a><span id="l6.339" class="difflineminus">-    Assert.ok(!this.installed.has(id));</span>
<a href="#l6.340"></a><span id="l6.340" class="difflineminus">-  },</span>
<a href="#l6.341"></a><span id="l6.341" class="difflineminus">-</span>
<a href="#l6.342"></a><span id="l6.342" class="difflineminus">-  observe(subject, topic, data) {</span>
<a href="#l6.343"></a><span id="l6.343" class="difflineminus">-    let info = JSON.parse(data);</span>
<a href="#l6.344"></a><span id="l6.344" class="difflineminus">-    let id = info.data.id;</span>
<a href="#l6.345"></a><span id="l6.345" class="difflineminus">-</span>
<a href="#l6.346"></a><span id="l6.346" class="difflineminus">-    // Get the install path from the resource URI, since it is not passed any longer.</span>
<a href="#l6.347"></a><span id="l6.347" class="difflineminus">-    let uri = Services.io.newURI(info.data.resourceURI);</span>
<a href="#l6.348"></a><span id="l6.348" class="difflineminus">-    let jarFile = uri.QueryInterface(Ci.nsIJARURI).JARFile;</span>
<a href="#l6.349"></a><span id="l6.349" class="difflineminus">-    let installPath = jarFile.QueryInterface(Ci.nsIFileURL).file;</span>
<a href="#l6.350"></a><span id="l6.350" class="difflineminus">-</span>
<a href="#l6.351"></a><span id="l6.351" class="difflineminus">-    if (subject &amp;&amp; subject.wrappedJSObject) {</span>
<a href="#l6.352"></a><span id="l6.352" class="difflineminus">-      // NOTE: in some of the new tests, we need to received the real objects instead of</span>
<a href="#l6.353"></a><span id="l6.353" class="difflineminus">-      // their JSON representations, but most of the current tests expect intallPath</span>
<a href="#l6.354"></a><span id="l6.354" class="difflineminus">-      // and resourceURI to have been converted to strings.</span>
<a href="#l6.355"></a><span id="l6.355" class="difflineminus">-      info.data = Object.assign({}, subject.wrappedJSObject.data, {</span>
<a href="#l6.356"></a><span id="l6.356" class="difflineminus">-        installPath: info.data.installPath,</span>
<a href="#l6.357"></a><span id="l6.357" class="difflineminus">-        resourceURI: info.data.resourceURI,</span>
<a href="#l6.358"></a><span id="l6.358" class="difflineminus">-      });</span>
<a href="#l6.359"></a><span id="l6.359" class="difflineminus">-    }</span>
<a href="#l6.360"></a><span id="l6.360" class="difflineminus">-</span>
<a href="#l6.361"></a><span id="l6.361" class="difflineminus">-    // If this is the install event the add-ons shouldn't already be installed</span>
<a href="#l6.362"></a><span id="l6.362" class="difflineminus">-    if (info.event == &quot;install&quot;) {</span>
<a href="#l6.363"></a><span id="l6.363" class="difflineminus">-      this.checkAddonNotInstalled(id);</span>
<a href="#l6.364"></a><span id="l6.364" class="difflineminus">-</span>
<a href="#l6.365"></a><span id="l6.365" class="difflineminus">-      this.installed.set(id, info);</span>
<a href="#l6.366"></a><span id="l6.366" class="difflineminus">-</span>
<a href="#l6.367"></a><span id="l6.367" class="difflineminus">-      for (let resolve of this.installPromises) {</span>
<a href="#l6.368"></a><span id="l6.368" class="difflineminus">-        resolve();</span>
<a href="#l6.369"></a><span id="l6.369" class="difflineminus">-      }</span>
<a href="#l6.370"></a><span id="l6.370" class="difflineminus">-      this.installPromises = [];</span>
<a href="#l6.371"></a><span id="l6.371" class="difflineminus">-    } else {</span>
<a href="#l6.372"></a><span id="l6.372" class="difflineminus">-      this.checkMatches(this.installed.get(id), info);</span>
<a href="#l6.373"></a><span id="l6.373" class="difflineminus">-    }</span>
<a href="#l6.374"></a><span id="l6.374" class="difflineminus">-</span>
<a href="#l6.375"></a><span id="l6.375" class="difflineminus">-    // If this is the shutdown event than the add-on should already be started</span>
<a href="#l6.376"></a><span id="l6.376" class="difflineminus">-    if (info.event == &quot;shutdown&quot;) {</span>
<a href="#l6.377"></a><span id="l6.377" class="difflineminus">-      this.checkMatches(this.started.get(id), info);</span>
<a href="#l6.378"></a><span id="l6.378" class="difflineminus">-</span>
<a href="#l6.379"></a><span id="l6.379" class="difflineminus">-      this.started.delete(id);</span>
<a href="#l6.380"></a><span id="l6.380" class="difflineminus">-      this.stopped.set(id, info);</span>
<a href="#l6.381"></a><span id="l6.381" class="difflineminus">-</span>
<a href="#l6.382"></a><span id="l6.382" class="difflineminus">-      // Chrome should still be registered at this point</span>
<a href="#l6.383"></a><span id="l6.383" class="difflineminus">-      let isRegistered = isManifestRegistered(installPath);</span>
<a href="#l6.384"></a><span id="l6.384" class="difflineminus">-      Assert.ok(isRegistered);</span>
<a href="#l6.385"></a><span id="l6.385" class="difflineminus">-</span>
<a href="#l6.386"></a><span id="l6.386" class="difflineminus">-      // XPIProvider doesn't bother unregistering chrome on app shutdown but</span>
<a href="#l6.387"></a><span id="l6.387" class="difflineminus">-      // since we simulate restarts we must do so manually to keep the registry</span>
<a href="#l6.388"></a><span id="l6.388" class="difflineminus">-      // consistent.</span>
<a href="#l6.389"></a><span id="l6.389" class="difflineminus">-      if (info.reason == 2 /* APP_SHUTDOWN */) {</span>
<a href="#l6.390"></a><span id="l6.390" class="difflineminus">-        Components.manager.removeBootstrappedManifestLocation(installPath);</span>
<a href="#l6.391"></a><span id="l6.391" class="difflineminus">-      }</span>
<a href="#l6.392"></a><span id="l6.392" class="difflineminus">-    } else {</span>
<a href="#l6.393"></a><span id="l6.393" class="difflineminus">-      this.checkAddonNotStarted(id);</span>
<a href="#l6.394"></a><span id="l6.394" class="difflineminus">-    }</span>
<a href="#l6.395"></a><span id="l6.395" class="difflineminus">-</span>
<a href="#l6.396"></a><span id="l6.396" class="difflineminus">-    if (info.event == &quot;uninstall&quot;) {</span>
<a href="#l6.397"></a><span id="l6.397" class="difflineminus">-      // We currently support registering, but not unregistering,</span>
<a href="#l6.398"></a><span id="l6.398" class="difflineminus">-      // restartful add-on manifests during xpcshell AOM &quot;restarts&quot;.</span>
<a href="#l6.399"></a><span id="l6.399" class="difflineminus">-      if (!this.restartfulIds.has(id)) {</span>
<a href="#l6.400"></a><span id="l6.400" class="difflineminus">-        // Chrome should be unregistered at this point</span>
<a href="#l6.401"></a><span id="l6.401" class="difflineminus">-        let isRegistered = isManifestRegistered(installPath);</span>
<a href="#l6.402"></a><span id="l6.402" class="difflineminus">-        Assert.ok(!isRegistered);</span>
<a href="#l6.403"></a><span id="l6.403" class="difflineminus">-      }</span>
<a href="#l6.404"></a><span id="l6.404" class="difflineminus">-</span>
<a href="#l6.405"></a><span id="l6.405" class="difflineminus">-      this.installed.delete(id);</span>
<a href="#l6.406"></a><span id="l6.406" class="difflineminus">-      this.uninstalled.set(id, info);</span>
<a href="#l6.407"></a><span id="l6.407" class="difflineminus">-    } else if (info.event == &quot;startup&quot;) {</span>
<a href="#l6.408"></a><span id="l6.408" class="difflineminus">-      this.started.set(id, info);</span>
<a href="#l6.409"></a><span id="l6.409" class="difflineminus">-</span>
<a href="#l6.410"></a><span id="l6.410" class="difflineminus">-      // Chrome should be registered at this point</span>
<a href="#l6.411"></a><span id="l6.411" class="difflineminus">-      let isRegistered = isManifestRegistered(installPath);</span>
<a href="#l6.412"></a><span id="l6.412" class="difflineminus">-      Assert.ok(isRegistered);</span>
<a href="#l6.413"></a><span id="l6.413" class="difflineminus">-</span>
<a href="#l6.414"></a><span id="l6.414" class="difflineminus">-      for (let resolve of this.startupPromises) {</span>
<a href="#l6.415"></a><span id="l6.415" class="difflineminus">-        resolve();</span>
<a href="#l6.416"></a><span id="l6.416" class="difflineminus">-      }</span>
<a href="#l6.417"></a><span id="l6.417" class="difflineminus">-      this.startupPromises = [];</span>
<a href="#l6.418"></a><span id="l6.418" class="difflineminus">-    }</span>
<a href="#l6.419"></a><span id="l6.419" class="difflineminus">-  },</span>
<a href="#l6.420"></a><span id="l6.420" class="difflineminus">-};</span>
<a href="#l6.421"></a><span id="l6.421" class="difflineminus">-</span>
<a href="#l6.422"></a><span id="l6.422" class="difflineminus">-AddonTestUtils.on(&quot;addon-manager-shutdown&quot;, () =&gt; {</span>
<a href="#l6.423"></a><span id="l6.423" class="difflineminus">-  BootstrapMonitor.shutdownCheck();</span>
<a href="#l6.424"></a><span id="l6.424" class="difflineminus">-  Cu.unload(&quot;resource:///modules/BootstrapLoader.jsm&quot;);</span>
<a href="#l6.425"></a><span id="l6.425" class="difflineminus">-});</span>
<a href="#l6.426"></a><span id="l6.426" class="difflineminus">-</span>
<a href="#l6.427"></a><span id="l6.427" class="difflineminus">-var SlightlyLessDodgyBootstrapMonitor = {</span>
<a href="#l6.428"></a><span id="l6.428" class="difflineminus">-  started: new Map(),</span>
<a href="#l6.429"></a><span id="l6.429" class="difflineminus">-  stopped: new Map(),</span>
<a href="#l6.430"></a><span id="l6.430" class="difflineminus">-  installed: new Map(),</span>
<a href="#l6.431"></a><span id="l6.431" class="difflineminus">-  uninstalled: new Map(),</span>
<a href="#l6.432"></a><span id="l6.432" class="difflineminus">-</span>
<a href="#l6.433"></a><span id="l6.433" class="difflineminus">-  init() {</span>
<a href="#l6.434"></a><span id="l6.434" class="difflineminus">-    this.onEvent = this.onEvent.bind(this);</span>
<a href="#l6.435"></a><span id="l6.435" class="difflineminus">-</span>
<a href="#l6.436"></a><span id="l6.436" class="difflineminus">-    AddonTestUtils.on(&quot;addon-manager-shutdown&quot;, this.onEvent);</span>
<a href="#l6.437"></a><span id="l6.437" class="difflineminus">-    AddonTestUtils.on(&quot;bootstrap-method&quot;, this.onEvent);</span>
<a href="#l6.438"></a><span id="l6.438" class="difflineminus">-  },</span>
<a href="#l6.439"></a><span id="l6.439" class="difflineminus">-</span>
<a href="#l6.440"></a><span id="l6.440" class="difflineminus">-  shutdownCheck() {</span>
<a href="#l6.441"></a><span id="l6.441" class="difflineminus">-    equal(</span>
<a href="#l6.442"></a><span id="l6.442" class="difflineminus">-      this.started.size,</span>
<a href="#l6.443"></a><span id="l6.443" class="difflineminus">-      0,</span>
<a href="#l6.444"></a><span id="l6.444" class="difflineminus">-      &quot;Should have no add-ons that were started but not shutdown&quot;</span>
<a href="#l6.445"></a><span id="l6.445" class="difflineminus">-    );</span>
<a href="#l6.446"></a><span id="l6.446" class="difflineminus">-  },</span>
<a href="#l6.447"></a><span id="l6.447" class="difflineminus">-</span>
<a href="#l6.448"></a><span id="l6.448" class="difflineminus">-  onEvent(msg, data) {</span>
<a href="#l6.449"></a><span id="l6.449" class="difflineminus">-    switch (msg) {</span>
<a href="#l6.450"></a><span id="l6.450" class="difflineminus">-      case &quot;addon-manager-shutdown&quot;:</span>
<a href="#l6.451"></a><span id="l6.451" class="difflineminus">-        this.shutdownCheck();</span>
<a href="#l6.452"></a><span id="l6.452" class="difflineminus">-        break;</span>
<a href="#l6.453"></a><span id="l6.453" class="difflineminus">-      case &quot;bootstrap-method&quot;:</span>
<a href="#l6.454"></a><span id="l6.454" class="difflineminus">-        this.onBootstrapMethod(data.method, data.params, data.reason);</span>
<a href="#l6.455"></a><span id="l6.455" class="difflineminus">-        break;</span>
<a href="#l6.456"></a><span id="l6.456" class="difflineminus">-    }</span>
<a href="#l6.457"></a><span id="l6.457" class="difflineminus">-  },</span>
<a href="#l6.458"></a><span id="l6.458" class="difflineminus">-</span>
<a href="#l6.459"></a><span id="l6.459" class="difflineminus">-  onBootstrapMethod(method, params, reason) {</span>
<a href="#l6.460"></a><span id="l6.460" class="difflineminus">-    let { id } = params;</span>
<a href="#l6.461"></a><span id="l6.461" class="difflineminus">-</span>
<a href="#l6.462"></a><span id="l6.462" class="difflineminus">-    info(</span>
<a href="#l6.463"></a><span id="l6.463" class="difflineminus">-      `Bootstrap method ${method} for ${params.id} version ${params.version}`</span>
<a href="#l6.464"></a><span id="l6.464" class="difflineminus">-    );</span>
<a href="#l6.465"></a><span id="l6.465" class="difflineminus">-</span>
<a href="#l6.466"></a><span id="l6.466" class="difflineminus">-    if (method !== &quot;install&quot;) {</span>
<a href="#l6.467"></a><span id="l6.467" class="difflineminus">-      this.checkInstalled(id);</span>
<a href="#l6.468"></a><span id="l6.468" class="difflineminus">-    }</span>
<a href="#l6.469"></a><span id="l6.469" class="difflineminus">-</span>
<a href="#l6.470"></a><span id="l6.470" class="difflineminus">-    switch (method) {</span>
<a href="#l6.471"></a><span id="l6.471" class="difflineminus">-      case &quot;install&quot;:</span>
<a href="#l6.472"></a><span id="l6.472" class="difflineminus">-        this.checkNotInstalled(id);</span>
<a href="#l6.473"></a><span id="l6.473" class="difflineminus">-        this.installed.set(id, { reason, params });</span>
<a href="#l6.474"></a><span id="l6.474" class="difflineminus">-        this.uninstalled.delete(id);</span>
<a href="#l6.475"></a><span id="l6.475" class="difflineminus">-        break;</span>
<a href="#l6.476"></a><span id="l6.476" class="difflineminus">-      case &quot;startup&quot;:</span>
<a href="#l6.477"></a><span id="l6.477" class="difflineminus">-        this.checkNotStarted(id);</span>
<a href="#l6.478"></a><span id="l6.478" class="difflineminus">-        this.started.set(id, { reason, params });</span>
<a href="#l6.479"></a><span id="l6.479" class="difflineminus">-        this.stopped.delete(id);</span>
<a href="#l6.480"></a><span id="l6.480" class="difflineminus">-        break;</span>
<a href="#l6.481"></a><span id="l6.481" class="difflineminus">-      case &quot;shutdown&quot;:</span>
<a href="#l6.482"></a><span id="l6.482" class="difflineminus">-        this.checkMatches(&quot;shutdown&quot;, &quot;startup&quot;, params, this.started.get(id));</span>
<a href="#l6.483"></a><span id="l6.483" class="difflineminus">-        this.checkStarted(id);</span>
<a href="#l6.484"></a><span id="l6.484" class="difflineminus">-        this.stopped.set(id, { reason, params });</span>
<a href="#l6.485"></a><span id="l6.485" class="difflineminus">-        this.started.delete(id);</span>
<a href="#l6.486"></a><span id="l6.486" class="difflineminus">-        break;</span>
<a href="#l6.487"></a><span id="l6.487" class="difflineminus">-      case &quot;uninstall&quot;:</span>
<a href="#l6.488"></a><span id="l6.488" class="difflineminus">-        this.checkMatches(</span>
<a href="#l6.489"></a><span id="l6.489" class="difflineminus">-          &quot;uninstall&quot;,</span>
<a href="#l6.490"></a><span id="l6.490" class="difflineminus">-          &quot;install&quot;,</span>
<a href="#l6.491"></a><span id="l6.491" class="difflineminus">-          params,</span>
<a href="#l6.492"></a><span id="l6.492" class="difflineminus">-          this.installed.get(id)</span>
<a href="#l6.493"></a><span id="l6.493" class="difflineminus">-        );</span>
<a href="#l6.494"></a><span id="l6.494" class="difflineminus">-        this.uninstalled.set(id, { reason, params });</span>
<a href="#l6.495"></a><span id="l6.495" class="difflineminus">-        this.installed.delete(id);</span>
<a href="#l6.496"></a><span id="l6.496" class="difflineminus">-        break;</span>
<a href="#l6.497"></a><span id="l6.497" class="difflineminus">-      case &quot;update&quot;:</span>
<a href="#l6.498"></a><span id="l6.498" class="difflineminus">-        this.checkMatches(&quot;update&quot;, &quot;install&quot;, params, this.installed.get(id));</span>
<a href="#l6.499"></a><span id="l6.499" class="difflineminus">-        this.installed.set(id, { reason, params });</span>
<a href="#l6.500"></a><span id="l6.500" class="difflineminus">-        break;</span>
<a href="#l6.501"></a><span id="l6.501" class="difflineminus">-    }</span>
<a href="#l6.502"></a><span id="l6.502" class="difflineminus">-  },</span>
<a href="#l6.503"></a><span id="l6.503" class="difflineminus">-</span>
<a href="#l6.504"></a><span id="l6.504" class="difflineminus">-  clear(id) {</span>
<a href="#l6.505"></a><span id="l6.505" class="difflineminus">-    this.installed.delete(id);</span>
<a href="#l6.506"></a><span id="l6.506" class="difflineminus">-    this.started.delete(id);</span>
<a href="#l6.507"></a><span id="l6.507" class="difflineminus">-    this.stopped.delete(id);</span>
<a href="#l6.508"></a><span id="l6.508" class="difflineminus">-    this.uninstalled.delete(id);</span>
<a href="#l6.509"></a><span id="l6.509" class="difflineminus">-  },</span>
<a href="#l6.510"></a><span id="l6.510" class="difflineminus">-</span>
<a href="#l6.511"></a><span id="l6.511" class="difflineminus">-  checkMatches(method, lastMethod, params, { params: lastParams } = {}) {</span>
<a href="#l6.512"></a><span id="l6.512" class="difflineminus">-    ok(</span>
<a href="#l6.513"></a><span id="l6.513" class="difflineminus">-      lastParams,</span>
<a href="#l6.514"></a><span id="l6.514" class="difflineminus">-      `Expecting matching ${lastMethod} call for add-on ${</span>
<a href="#l6.515"></a><span id="l6.515" class="difflineminus">-        params.id</span>
<a href="#l6.516"></a><span id="l6.516" class="difflineminus">-      } ${method} call`</span>
<a href="#l6.517"></a><span id="l6.517" class="difflineminus">-    );</span>
<a href="#l6.518"></a><span id="l6.518" class="difflineminus">-</span>
<a href="#l6.519"></a><span id="l6.519" class="difflineminus">-    if (method == &quot;update&quot;) {</span>
<a href="#l6.520"></a><span id="l6.520" class="difflineminus">-      equal(</span>
<a href="#l6.521"></a><span id="l6.521" class="difflineminus">-        params.oldVersion,</span>
<a href="#l6.522"></a><span id="l6.522" class="difflineminus">-        lastParams.version,</span>
<a href="#l6.523"></a><span id="l6.523" class="difflineminus">-        &quot;params.version should match last call&quot;</span>
<a href="#l6.524"></a><span id="l6.524" class="difflineminus">-      );</span>
<a href="#l6.525"></a><span id="l6.525" class="difflineminus">-    } else {</span>
<a href="#l6.526"></a><span id="l6.526" class="difflineminus">-      equal(</span>
<a href="#l6.527"></a><span id="l6.527" class="difflineminus">-        params.version,</span>
<a href="#l6.528"></a><span id="l6.528" class="difflineminus">-        lastParams.version,</span>
<a href="#l6.529"></a><span id="l6.529" class="difflineminus">-        &quot;params.version should match last call&quot;</span>
<a href="#l6.530"></a><span id="l6.530" class="difflineminus">-      );</span>
<a href="#l6.531"></a><span id="l6.531" class="difflineminus">-    }</span>
<a href="#l6.532"></a><span id="l6.532" class="difflineminus">-</span>
<a href="#l6.533"></a><span id="l6.533" class="difflineminus">-    if (method !== &quot;update&quot; &amp;&amp; method !== &quot;uninstall&quot;) {</span>
<a href="#l6.534"></a><span id="l6.534" class="difflineminus">-      equal(</span>
<a href="#l6.535"></a><span id="l6.535" class="difflineminus">-        params.installPath.path,</span>
<a href="#l6.536"></a><span id="l6.536" class="difflineminus">-        lastParams.installPath.path,</span>
<a href="#l6.537"></a><span id="l6.537" class="difflineminus">-        `params.installPath should match last call`</span>
<a href="#l6.538"></a><span id="l6.538" class="difflineminus">-      );</span>
<a href="#l6.539"></a><span id="l6.539" class="difflineminus">-</span>
<a href="#l6.540"></a><span id="l6.540" class="difflineminus">-      ok(</span>
<a href="#l6.541"></a><span id="l6.541" class="difflineminus">-        params.resourceURI.equals(lastParams.resourceURI),</span>
<a href="#l6.542"></a><span id="l6.542" class="difflineminus">-        `params.resourceURI should match: &quot;${params.resourceURI.spec}&quot; == &quot;${</span>
<a href="#l6.543"></a><span id="l6.543" class="difflineminus">-          lastParams.resourceURI.spec</span>
<a href="#l6.544"></a><span id="l6.544" class="difflineminus">-        }&quot;`</span>
<a href="#l6.545"></a><span id="l6.545" class="difflineminus">-      );</span>
<a href="#l6.546"></a><span id="l6.546" class="difflineminus">-    }</span>
<a href="#l6.547"></a><span id="l6.547" class="difflineminus">-  },</span>
<a href="#l6.548"></a><span id="l6.548" class="difflineminus">-</span>
<a href="#l6.549"></a><span id="l6.549" class="difflineminus">-  checkStarted(id, version = undefined) {</span>
<a href="#l6.550"></a><span id="l6.550" class="difflineminus">-    let started = this.started.get(id);</span>
<a href="#l6.551"></a><span id="l6.551" class="difflineminus">-    ok(started, `Should have seen startup method call for ${id}`);</span>
<a href="#l6.552"></a><span id="l6.552" class="difflineminus">-</span>
<a href="#l6.553"></a><span id="l6.553" class="difflineminus">-    if (version !== undefined) {</span>
<a href="#l6.554"></a><span id="l6.554" class="difflineminus">-      equal(started.params.version, version, &quot;Expected version number&quot;);</span>
<a href="#l6.555"></a><span id="l6.555" class="difflineminus">-    }</span>
<a href="#l6.556"></a><span id="l6.556" class="difflineminus">-  },</span>
<a href="#l6.557"></a><span id="l6.557" class="difflineminus">-</span>
<a href="#l6.558"></a><span id="l6.558" class="difflineminus">-  checkNotStarted(id) {</span>
<a href="#l6.559"></a><span id="l6.559" class="difflineminus">-    ok(</span>
<a href="#l6.560"></a><span id="l6.560" class="difflineminus">-      !this.started.has(id),</span>
<a href="#l6.561"></a><span id="l6.561" class="difflineminus">-      `Should not have seen startup method call for ${id}`</span>
<a href="#l6.562"></a><span id="l6.562" class="difflineminus">-    );</span>
<a href="#l6.563"></a><span id="l6.563" class="difflineminus">-  },</span>
<a href="#l6.564"></a><span id="l6.564" class="difflineminus">-</span>
<a href="#l6.565"></a><span id="l6.565" class="difflineminus">-  checkInstalled(id, version = undefined) {</span>
<a href="#l6.566"></a><span id="l6.566" class="difflineminus">-    const installed = this.installed.get(id);</span>
<a href="#l6.567"></a><span id="l6.567" class="difflineminus">-    ok(installed, `Should have seen install call for ${id}`);</span>
<a href="#l6.568"></a><span id="l6.568" class="difflineminus">-</span>
<a href="#l6.569"></a><span id="l6.569" class="difflineminus">-    if (version !== undefined) {</span>
<a href="#l6.570"></a><span id="l6.570" class="difflineminus">-      equal(installed.params.version, version, &quot;Expected version number&quot;);</span>
<a href="#l6.571"></a><span id="l6.571" class="difflineminus">-    }</span>
<a href="#l6.572"></a><span id="l6.572" class="difflineminus">-</span>
<a href="#l6.573"></a><span id="l6.573" class="difflineminus">-    return installed;</span>
<a href="#l6.574"></a><span id="l6.574" class="difflineminus">-  },</span>
<a href="#l6.575"></a><span id="l6.575" class="difflineminus">-</span>
<a href="#l6.576"></a><span id="l6.576" class="difflineminus">-  checkNotInstalled(id) {</span>
<a href="#l6.577"></a><span id="l6.577" class="difflineminus">-    ok(</span>
<a href="#l6.578"></a><span id="l6.578" class="difflineminus">-      !this.installed.has(id),</span>
<a href="#l6.579"></a><span id="l6.579" class="difflineminus">-      `Should not have seen install method call for ${id}`</span>
<a href="#l6.580"></a><span id="l6.580" class="difflineminus">-    );</span>
<a href="#l6.581"></a><span id="l6.581" class="difflineminus">-  },</span>
<a href="#l6.582"></a><span id="l6.582" class="difflineminus">-};</span>
<a href="#l6.583"></a><span id="l6.583" class="difflineminus">-</span>
<a href="#l6.584"></a><span id="l6.584" class="difflineminus">-function isNightlyChannel() {</span>
<a href="#l6.585"></a><span id="l6.585" class="difflineminus">-  var channel = Services.prefs.getCharPref(&quot;app.update.channel&quot;, &quot;default&quot;);</span>
<a href="#l6.586"></a><span id="l6.586" class="difflineminus">-</span>
<a href="#l6.587"></a><span id="l6.587" class="difflineminus">-  return (</span>
<a href="#l6.588"></a><span id="l6.588" class="difflineminus">-    channel != &quot;aurora&quot; &amp;&amp;</span>
<a href="#l6.589"></a><span id="l6.589" class="difflineminus">-    channel != &quot;beta&quot; &amp;&amp;</span>
<a href="#l6.590"></a><span id="l6.590" class="difflineminus">-    channel != &quot;release&quot; &amp;&amp;</span>
<a href="#l6.591"></a><span id="l6.591" class="difflineminus">-    channel != &quot;esr&quot;</span>
<a href="#l6.592"></a><span id="l6.592" class="difflineminus">-  );</span>
<a href="#l6.593"></a><span id="l6.593" class="difflineminus">-}</span>
<a href="#l6.594"></a><span id="l6.594" class="difflineminus">-</span>
<a href="#l6.595"></a><span id="l6.595" class="difflineminus">-async function restartWithLocales(locales) {</span>
<a href="#l6.596"></a><span id="l6.596" class="difflineminus">-  Services.locale.requestedLocales = locales;</span>
<a href="#l6.597"></a><span id="l6.597" class="difflineminus">-  await promiseRestartManager();</span>
<a href="#l6.598"></a><span id="l6.598" class="difflineminus">-}</span>
<a href="#l6.599"></a><span id="l6.599" class="difflineminus">-</span>
<a href="#l6.600"></a><span id="l6.600" class="difflineminus">-/**</span>
<a href="#l6.601"></a><span id="l6.601" class="difflineminus">- * Returns a map of Addon objects for installed add-ons with the given</span>
<a href="#l6.602"></a><span id="l6.602" class="difflineminus">- * IDs. The returned map contains a key for the ID of each add-on that</span>
<a href="#l6.603"></a><span id="l6.603" class="difflineminus">- * is found. IDs for add-ons which do not exist are not present in the</span>
<a href="#l6.604"></a><span id="l6.604" class="difflineminus">- * map.</span>
<a href="#l6.605"></a><span id="l6.605" class="difflineminus">- *</span>
<a href="#l6.606"></a><span id="l6.606" class="difflineminus">- * @param {sequence&lt;string&gt;} ids</span>
<a href="#l6.607"></a><span id="l6.607" class="difflineminus">- *        The list of add-on IDs to get.</span>
<a href="#l6.608"></a><span id="l6.608" class="difflineminus">- * @returns {Promise&lt;string, Addon&gt;}</span>
<a href="#l6.609"></a><span id="l6.609" class="difflineminus">- *        Map of add-ons that were found.</span>
<a href="#l6.610"></a><span id="l6.610" class="difflineminus">- */</span>
<a href="#l6.611"></a><span id="l6.611" class="difflineminus">-async function getAddons(ids) {</span>
<a href="#l6.612"></a><span id="l6.612" class="difflineminus">-  let addons = new Map();</span>
<a href="#l6.613"></a><span id="l6.613" class="difflineminus">-  for (let addon of await AddonManager.getAddonsByIDs(ids)) {</span>
<a href="#l6.614"></a><span id="l6.614" class="difflineminus">-    if (addon) {</span>
<a href="#l6.615"></a><span id="l6.615" class="difflineminus">-      addons.set(addon.id, addon);</span>
<a href="#l6.616"></a><span id="l6.616" class="difflineminus">-    }</span>
<a href="#l6.617"></a><span id="l6.617" class="difflineminus">-  }</span>
<a href="#l6.618"></a><span id="l6.618" class="difflineminus">-  return addons;</span>
<a href="#l6.619"></a><span id="l6.619" class="difflineminus">-}</span>
<a href="#l6.620"></a><span id="l6.620" class="difflineminus">-</span>
<a href="#l6.621"></a><span id="l6.621" class="difflineminus">-/**</span>
<a href="#l6.622"></a><span id="l6.622" class="difflineminus">- * Checks that the given add-on has the given expected properties.</span>
<a href="#l6.623"></a><span id="l6.623" class="difflineminus">- *</span>
<a href="#l6.624"></a><span id="l6.624" class="difflineminus">- * @param {string} id</span>
<a href="#l6.625"></a><span id="l6.625" class="difflineminus">- *        The id of the add-on.</span>
<a href="#l6.626"></a><span id="l6.626" class="difflineminus">- * @param {Addon?} addon</span>
<a href="#l6.627"></a><span id="l6.627" class="difflineminus">- *        The add-on object, or null if the add-on does not exist.</span>
<a href="#l6.628"></a><span id="l6.628" class="difflineminus">- * @param {object?} expected</span>
<a href="#l6.629"></a><span id="l6.629" class="difflineminus">- *        An object containing the expected values for properties of the</span>
<a href="#l6.630"></a><span id="l6.630" class="difflineminus">- *        add-on, or null if the add-on is expected not to exist.</span>
<a href="#l6.631"></a><span id="l6.631" class="difflineminus">- */</span>
<a href="#l6.632"></a><span id="l6.632" class="difflineminus">-function checkAddon(id, addon, expected) {</span>
<a href="#l6.633"></a><span id="l6.633" class="difflineminus">-  info(`Checking state of addon ${id}`);</span>
<a href="#l6.634"></a><span id="l6.634" class="difflineminus">-</span>
<a href="#l6.635"></a><span id="l6.635" class="difflineminus">-  if (expected === null) {</span>
<a href="#l6.636"></a><span id="l6.636" class="difflineminus">-    ok(!addon, `Addon ${id} should not exist`);</span>
<a href="#l6.637"></a><span id="l6.637" class="difflineminus">-  } else {</span>
<a href="#l6.638"></a><span id="l6.638" class="difflineminus">-    ok(addon, `Addon ${id} should exist`);</span>
<a href="#l6.639"></a><span id="l6.639" class="difflineminus">-    for (let [key, value] of Object.entries(expected)) {</span>
<a href="#l6.640"></a><span id="l6.640" class="difflineminus">-      if (value instanceof Ci.nsIURI) {</span>
<a href="#l6.641"></a><span id="l6.641" class="difflineminus">-        equal(</span>
<a href="#l6.642"></a><span id="l6.642" class="difflineminus">-          addon[key] &amp;&amp; addon[key].spec,</span>
<a href="#l6.643"></a><span id="l6.643" class="difflineminus">-          value.spec,</span>
<a href="#l6.644"></a><span id="l6.644" class="difflineminus">-          `Expected value of addon.${key}`</span>
<a href="#l6.645"></a><span id="l6.645" class="difflineminus">-        );</span>
<a href="#l6.646"></a><span id="l6.646" class="difflineminus">-      } else {</span>
<a href="#l6.647"></a><span id="l6.647" class="difflineminus">-        deepEqual(addon[key], value, `Expected value of addon.${key}`);</span>
<a href="#l6.648"></a><span id="l6.648" class="difflineminus">-      }</span>
<a href="#l6.649"></a><span id="l6.649" class="difflineminus">-    }</span>
<a href="#l6.650"></a><span id="l6.650" class="difflineminus">-  }</span>
<a href="#l6.651"></a><span id="l6.651" class="difflineminus">-}</span>
<a href="#l6.652"></a><span id="l6.652" class="difflineminus">-</span>
<a href="#l6.653"></a><span id="l6.653" class="difflineminus">-/**</span>
<a href="#l6.654"></a><span id="l6.654" class="difflineminus">- * Tests that an add-on does appear in the crash report annotations, if</span>
<a href="#l6.655"></a><span id="l6.655" class="difflineminus">- * crash reporting is enabled. The test will fail if the add-on is not in the</span>
<a href="#l6.656"></a><span id="l6.656" class="difflineminus">- * annotation.</span>
<a href="#l6.657"></a><span id="l6.657" class="difflineminus">- * @param  aId</span>
<a href="#l6.658"></a><span id="l6.658" class="difflineminus">- *         The ID of the add-on</span>
<a href="#l6.659"></a><span id="l6.659" class="difflineminus">- * @param  aVersion</span>
<a href="#l6.660"></a><span id="l6.660" class="difflineminus">- *         The version of the add-on</span>
<a href="#l6.661"></a><span id="l6.661" class="difflineminus">- */</span>
<a href="#l6.662"></a><span id="l6.662" class="difflineminus">-function do_check_in_crash_annotation(aId, aVersion) {</span>
<a href="#l6.663"></a><span id="l6.663" class="difflineminus">-  if (!AppConstants.MOZ_CRASHREPORTER) {</span>
<a href="#l6.664"></a><span id="l6.664" class="difflineminus">-    return;</span>
<a href="#l6.665"></a><span id="l6.665" class="difflineminus">-  }</span>
<a href="#l6.666"></a><span id="l6.666" class="difflineminus">-</span>
<a href="#l6.667"></a><span id="l6.667" class="difflineminus">-  if (!(&quot;Add-ons&quot; in gAppInfo.annotations)) {</span>
<a href="#l6.668"></a><span id="l6.668" class="difflineminus">-    Assert.ok(false, &quot;Cannot find Add-ons entry in crash annotations&quot;);</span>
<a href="#l6.669"></a><span id="l6.669" class="difflineminus">-    return;</span>
<a href="#l6.670"></a><span id="l6.670" class="difflineminus">-  }</span>
<a href="#l6.671"></a><span id="l6.671" class="difflineminus">-</span>
<a href="#l6.672"></a><span id="l6.672" class="difflineminus">-  let addons = gAppInfo.annotations[&quot;Add-ons&quot;].split(&quot;,&quot;);</span>
<a href="#l6.673"></a><span id="l6.673" class="difflineminus">-  Assert.ok(</span>
<a href="#l6.674"></a><span id="l6.674" class="difflineminus">-    addons.includes(</span>
<a href="#l6.675"></a><span id="l6.675" class="difflineminus">-      `${encodeURIComponent(aId)}:${encodeURIComponent(aVersion)}`</span>
<a href="#l6.676"></a><span id="l6.676" class="difflineminus">-    )</span>
<a href="#l6.677"></a><span id="l6.677" class="difflineminus">-  );</span>
<a href="#l6.678"></a><span id="l6.678" class="difflineminus">-}</span>
<a href="#l6.679"></a><span id="l6.679" class="difflineminus">-</span>
<a href="#l6.680"></a><span id="l6.680" class="difflineminus">-/**</span>
<a href="#l6.681"></a><span id="l6.681" class="difflineminus">- * Tests that an add-on does not appear in the crash report annotations, if</span>
<a href="#l6.682"></a><span id="l6.682" class="difflineminus">- * crash reporting is enabled. The test will fail if the add-on is in the</span>
<a href="#l6.683"></a><span id="l6.683" class="difflineminus">- * annotation.</span>
<a href="#l6.684"></a><span id="l6.684" class="difflineminus">- * @param  aId</span>
<a href="#l6.685"></a><span id="l6.685" class="difflineminus">- *         The ID of the add-on</span>
<a href="#l6.686"></a><span id="l6.686" class="difflineminus">- * @param  aVersion</span>
<a href="#l6.687"></a><span id="l6.687" class="difflineminus">- *         The version of the add-on</span>
<a href="#l6.688"></a><span id="l6.688" class="difflineminus">- */</span>
<a href="#l6.689"></a><span id="l6.689" class="difflineminus">-function do_check_not_in_crash_annotation(aId, aVersion) {</span>
<a href="#l6.690"></a><span id="l6.690" class="difflineminus">-  if (!AppConstants.MOZ_CRASHREPORTER) {</span>
<a href="#l6.691"></a><span id="l6.691" class="difflineminus">-    return;</span>
<a href="#l6.692"></a><span id="l6.692" class="difflineminus">-  }</span>
<a href="#l6.693"></a><span id="l6.693" class="difflineminus">-</span>
<a href="#l6.694"></a><span id="l6.694" class="difflineminus">-  if (!(&quot;Add-ons&quot; in gAppInfo.annotations)) {</span>
<a href="#l6.695"></a><span id="l6.695" class="difflineminus">-    Assert.ok(true);</span>
<a href="#l6.696"></a><span id="l6.696" class="difflineminus">-    return;</span>
<a href="#l6.697"></a><span id="l6.697" class="difflineminus">-  }</span>
<a href="#l6.698"></a><span id="l6.698" class="difflineminus">-</span>
<a href="#l6.699"></a><span id="l6.699" class="difflineminus">-  let addons = gAppInfo.annotations[&quot;Add-ons&quot;].split(&quot;,&quot;);</span>
<a href="#l6.700"></a><span id="l6.700" class="difflineminus">-  Assert.ok(</span>
<a href="#l6.701"></a><span id="l6.701" class="difflineminus">-    !addons.includes(</span>
<a href="#l6.702"></a><span id="l6.702" class="difflineminus">-      `${encodeURIComponent(aId)}:${encodeURIComponent(aVersion)}`</span>
<a href="#l6.703"></a><span id="l6.703" class="difflineminus">-    )</span>
<a href="#l6.704"></a><span id="l6.704" class="difflineminus">-  );</span>
<a href="#l6.705"></a><span id="l6.705" class="difflineminus">-}</span>
<a href="#l6.706"></a><span id="l6.706" class="difflineminus">-</span>
<a href="#l6.707"></a><span id="l6.707" class="difflineminus">-function do_get_file_hash(aFile, aAlgorithm) {</span>
<a href="#l6.708"></a><span id="l6.708" class="difflineminus">-  if (!aAlgorithm) {</span>
<a href="#l6.709"></a><span id="l6.709" class="difflineminus">-    aAlgorithm = &quot;sha1&quot;;</span>
<a href="#l6.710"></a><span id="l6.710" class="difflineminus">-  }</span>
<a href="#l6.711"></a><span id="l6.711" class="difflineminus">-</span>
<a href="#l6.712"></a><span id="l6.712" class="difflineminus">-  let crypto = Cc[&quot;@mozilla.org/security/hash;1&quot;].createInstance(</span>
<a href="#l6.713"></a><span id="l6.713" class="difflineminus">-    Ci.nsICryptoHash</span>
<a href="#l6.714"></a><span id="l6.714" class="difflineminus">-  );</span>
<a href="#l6.715"></a><span id="l6.715" class="difflineminus">-  crypto.initWithString(aAlgorithm);</span>
<a href="#l6.716"></a><span id="l6.716" class="difflineminus">-  let fis = Cc[&quot;@mozilla.org/network/file-input-stream;1&quot;].createInstance(</span>
<a href="#l6.717"></a><span id="l6.717" class="difflineminus">-    Ci.nsIFileInputStream</span>
<a href="#l6.718"></a><span id="l6.718" class="difflineminus">-  );</span>
<a href="#l6.719"></a><span id="l6.719" class="difflineminus">-  fis.init(aFile, -1, -1, false);</span>
<a href="#l6.720"></a><span id="l6.720" class="difflineminus">-  crypto.updateFromStream(fis, aFile.fileSize);</span>
<a href="#l6.721"></a><span id="l6.721" class="difflineminus">-</span>
<a href="#l6.722"></a><span id="l6.722" class="difflineminus">-  // return the two-digit hexadecimal code for a byte</span>
<a href="#l6.723"></a><span id="l6.723" class="difflineminus">-  let toHexString = charCode =&gt; (&quot;0&quot; + charCode.toString(16)).slice(-2);</span>
<a href="#l6.724"></a><span id="l6.724" class="difflineminus">-</span>
<a href="#l6.725"></a><span id="l6.725" class="difflineminus">-  let binary = crypto.finish(false);</span>
<a href="#l6.726"></a><span id="l6.726" class="difflineminus">-  let hash = Array.from(binary, c =&gt; toHexString(c.charCodeAt(0)));</span>
<a href="#l6.727"></a><span id="l6.727" class="difflineminus">-  return aAlgorithm + &quot;:&quot; + hash.join(&quot;&quot;);</span>
<a href="#l6.728"></a><span id="l6.728" class="difflineminus">-}</span>
<a href="#l6.729"></a><span id="l6.729" class="difflineminus">-</span>
<a href="#l6.730"></a><span id="l6.730" class="difflineminus">-/**</span>
<a href="#l6.731"></a><span id="l6.731" class="difflineminus">- * Returns an extension uri spec</span>
<a href="#l6.732"></a><span id="l6.732" class="difflineminus">- *</span>
<a href="#l6.733"></a><span id="l6.733" class="difflineminus">- * @param  aProfileDir</span>
<a href="#l6.734"></a><span id="l6.734" class="difflineminus">- *         The extension install directory</span>
<a href="#l6.735"></a><span id="l6.735" class="difflineminus">- * @return a uri spec pointing to the root of the extension</span>
<a href="#l6.736"></a><span id="l6.736" class="difflineminus">- */</span>
<a href="#l6.737"></a><span id="l6.737" class="difflineminus">-function do_get_addon_root_uri(aProfileDir, aId) {</span>
<a href="#l6.738"></a><span id="l6.738" class="difflineminus">-  let path = aProfileDir.clone();</span>
<a href="#l6.739"></a><span id="l6.739" class="difflineminus">-  path.append(aId);</span>
<a href="#l6.740"></a><span id="l6.740" class="difflineminus">-  if (!path.exists()) {</span>
<a href="#l6.741"></a><span id="l6.741" class="difflineminus">-    path.leafName += &quot;.xpi&quot;;</span>
<a href="#l6.742"></a><span id="l6.742" class="difflineminus">-    return &quot;jar:&quot; + Services.io.newFileURI(path).spec + &quot;!/&quot;;</span>
<a href="#l6.743"></a><span id="l6.743" class="difflineminus">-  }</span>
<a href="#l6.744"></a><span id="l6.744" class="difflineminus">-  return Services.io.newFileURI(path).spec;</span>
<a href="#l6.745"></a><span id="l6.745" class="difflineminus">-}</span>
<a href="#l6.746"></a><span id="l6.746" class="difflineminus">-</span>
<a href="#l6.747"></a><span id="l6.747" class="difflineminus">-function do_get_expected_addon_name(aId) {</span>
<a href="#l6.748"></a><span id="l6.748" class="difflineminus">-  if (TEST_UNPACKED) {</span>
<a href="#l6.749"></a><span id="l6.749" class="difflineminus">-    return aId;</span>
<a href="#l6.750"></a><span id="l6.750" class="difflineminus">-  }</span>
<a href="#l6.751"></a><span id="l6.751" class="difflineminus">-  return aId + &quot;.xpi&quot;;</span>
<a href="#l6.752"></a><span id="l6.752" class="difflineminus">-}</span>
<a href="#l6.753"></a><span id="l6.753" class="difflineminus">-</span>
<a href="#l6.754"></a><span id="l6.754" class="difflineminus">-/**</span>
<a href="#l6.755"></a><span id="l6.755" class="difflineminus">- * Check that an array of actual add-ons is the same as an array of</span>
<a href="#l6.756"></a><span id="l6.756" class="difflineminus">- * expected add-ons.</span>
<a href="#l6.757"></a><span id="l6.757" class="difflineminus">- *</span>
<a href="#l6.758"></a><span id="l6.758" class="difflineminus">- * @param  aActualAddons</span>
<a href="#l6.759"></a><span id="l6.759" class="difflineminus">- *         The array of actual add-ons to check.</span>
<a href="#l6.760"></a><span id="l6.760" class="difflineminus">- * @param  aExpectedAddons</span>
<a href="#l6.761"></a><span id="l6.761" class="difflineminus">- *         The array of expected add-ons to check against.</span>
<a href="#l6.762"></a><span id="l6.762" class="difflineminus">- * @param  aProperties</span>
<a href="#l6.763"></a><span id="l6.763" class="difflineminus">- *         An array of properties to check.</span>
<a href="#l6.764"></a><span id="l6.764" class="difflineminus">- */</span>
<a href="#l6.765"></a><span id="l6.765" class="difflineminus">-function do_check_addons(aActualAddons, aExpectedAddons, aProperties) {</span>
<a href="#l6.766"></a><span id="l6.766" class="difflineminus">-  Assert.notEqual(aActualAddons, null);</span>
<a href="#l6.767"></a><span id="l6.767" class="difflineminus">-  Assert.equal(aActualAddons.length, aExpectedAddons.length);</span>
<a href="#l6.768"></a><span id="l6.768" class="difflineminus">-  for (let i = 0; i &lt; aActualAddons.length; i++) {</span>
<a href="#l6.769"></a><span id="l6.769" class="difflineminus">-    do_check_addon(aActualAddons[i], aExpectedAddons[i], aProperties);</span>
<a href="#l6.770"></a><span id="l6.770" class="difflineminus">-  }</span>
<a href="#l6.771"></a><span id="l6.771" class="difflineminus">-}</span>
<a href="#l6.772"></a><span id="l6.772" class="difflineminus">-</span>
<a href="#l6.773"></a><span id="l6.773" class="difflineminus">-/**</span>
<a href="#l6.774"></a><span id="l6.774" class="difflineminus">- * Check that the actual add-on is the same as the expected add-on.</span>
<a href="#l6.775"></a><span id="l6.775" class="difflineminus">- *</span>
<a href="#l6.776"></a><span id="l6.776" class="difflineminus">- * @param  aActualAddon</span>
<a href="#l6.777"></a><span id="l6.777" class="difflineminus">- *         The actual add-on to check.</span>
<a href="#l6.778"></a><span id="l6.778" class="difflineminus">- * @param  aExpectedAddon</span>
<a href="#l6.779"></a><span id="l6.779" class="difflineminus">- *         The expected add-on to check against.</span>
<a href="#l6.780"></a><span id="l6.780" class="difflineminus">- * @param  aProperties</span>
<a href="#l6.781"></a><span id="l6.781" class="difflineminus">- *         An array of properties to check.</span>
<a href="#l6.782"></a><span id="l6.782" class="difflineminus">- */</span>
<a href="#l6.783"></a><span id="l6.783" class="difflineminus">-function do_check_addon(aActualAddon, aExpectedAddon, aProperties) {</span>
<a href="#l6.784"></a><span id="l6.784" class="difflineminus">-  Assert.notEqual(aActualAddon, null);</span>
<a href="#l6.785"></a><span id="l6.785" class="difflineminus">-</span>
<a href="#l6.786"></a><span id="l6.786" class="difflineminus">-  aProperties.forEach(function(aProperty) {</span>
<a href="#l6.787"></a><span id="l6.787" class="difflineminus">-    let actualValue = aActualAddon[aProperty];</span>
<a href="#l6.788"></a><span id="l6.788" class="difflineminus">-    let expectedValue = aExpectedAddon[aProperty];</span>
<a href="#l6.789"></a><span id="l6.789" class="difflineminus">-</span>
<a href="#l6.790"></a><span id="l6.790" class="difflineminus">-    // Check that all undefined expected properties are null on actual add-on</span>
<a href="#l6.791"></a><span id="l6.791" class="difflineminus">-    if (!(aProperty in aExpectedAddon)) {</span>
<a href="#l6.792"></a><span id="l6.792" class="difflineminus">-      if (actualValue !== undefined &amp;&amp; actualValue !== null) {</span>
<a href="#l6.793"></a><span id="l6.793" class="difflineminus">-        do_throw(</span>
<a href="#l6.794"></a><span id="l6.794" class="difflineminus">-          &quot;Unexpected defined/non-null property for add-on &quot; +</span>
<a href="#l6.795"></a><span id="l6.795" class="difflineminus">-            aExpectedAddon.id +</span>
<a href="#l6.796"></a><span id="l6.796" class="difflineminus">-            &quot; (addon[&quot; +</span>
<a href="#l6.797"></a><span id="l6.797" class="difflineminus">-            aProperty +</span>
<a href="#l6.798"></a><span id="l6.798" class="difflineminus">-            &quot;] = &quot; +</span>
<a href="#l6.799"></a><span id="l6.799" class="difflineminus">-            actualValue.toSource() +</span>
<a href="#l6.800"></a><span id="l6.800" class="difflineminus">-            &quot;)&quot;</span>
<a href="#l6.801"></a><span id="l6.801" class="difflineminus">-        );</span>
<a href="#l6.802"></a><span id="l6.802" class="difflineminus">-      }</span>
<a href="#l6.803"></a><span id="l6.803" class="difflineminus">-</span>
<a href="#l6.804"></a><span id="l6.804" class="difflineminus">-      return;</span>
<a href="#l6.805"></a><span id="l6.805" class="difflineminus">-    }</span>
<a href="#l6.806"></a><span id="l6.806" class="difflineminus">-    if (expectedValue &amp;&amp; !actualValue) {</span>
<a href="#l6.807"></a><span id="l6.807" class="difflineminus">-      do_throw(</span>
<a href="#l6.808"></a><span id="l6.808" class="difflineminus">-        &quot;Missing property for add-on &quot; +</span>
<a href="#l6.809"></a><span id="l6.809" class="difflineminus">-          aExpectedAddon.id +</span>
<a href="#l6.810"></a><span id="l6.810" class="difflineminus">-          &quot;: expected addon[&quot; +</span>
<a href="#l6.811"></a><span id="l6.811" class="difflineminus">-          aProperty +</span>
<a href="#l6.812"></a><span id="l6.812" class="difflineminus">-          &quot;] = &quot; +</span>
<a href="#l6.813"></a><span id="l6.813" class="difflineminus">-          expectedValue</span>
<a href="#l6.814"></a><span id="l6.814" class="difflineminus">-      );</span>
<a href="#l6.815"></a><span id="l6.815" class="difflineminus">-      return;</span>
<a href="#l6.816"></a><span id="l6.816" class="difflineminus">-    }</span>
<a href="#l6.817"></a><span id="l6.817" class="difflineminus">-</span>
<a href="#l6.818"></a><span id="l6.818" class="difflineminus">-    switch (aProperty) {</span>
<a href="#l6.819"></a><span id="l6.819" class="difflineminus">-      case &quot;creator&quot;:</span>
<a href="#l6.820"></a><span id="l6.820" class="difflineminus">-        do_check_author(actualValue, expectedValue);</span>
<a href="#l6.821"></a><span id="l6.821" class="difflineminus">-        break;</span>
<a href="#l6.822"></a><span id="l6.822" class="difflineminus">-</span>
<a href="#l6.823"></a><span id="l6.823" class="difflineminus">-      case &quot;developers&quot;:</span>
<a href="#l6.824"></a><span id="l6.824" class="difflineminus">-        Assert.equal(actualValue.length, expectedValue.length);</span>
<a href="#l6.825"></a><span id="l6.825" class="difflineminus">-        for (let i = 0; i &lt; actualValue.length; i++) {</span>
<a href="#l6.826"></a><span id="l6.826" class="difflineminus">-          do_check_author(actualValue[i], expectedValue[i]);</span>
<a href="#l6.827"></a><span id="l6.827" class="difflineminus">-        }</span>
<a href="#l6.828"></a><span id="l6.828" class="difflineminus">-        break;</span>
<a href="#l6.829"></a><span id="l6.829" class="difflineminus">-</span>
<a href="#l6.830"></a><span id="l6.830" class="difflineminus">-      case &quot;screenshots&quot;:</span>
<a href="#l6.831"></a><span id="l6.831" class="difflineminus">-        Assert.equal(actualValue.length, expectedValue.length);</span>
<a href="#l6.832"></a><span id="l6.832" class="difflineminus">-        for (let i = 0; i &lt; actualValue.length; i++) {</span>
<a href="#l6.833"></a><span id="l6.833" class="difflineminus">-          do_check_screenshot(actualValue[i], expectedValue[i]);</span>
<a href="#l6.834"></a><span id="l6.834" class="difflineminus">-        }</span>
<a href="#l6.835"></a><span id="l6.835" class="difflineminus">-        break;</span>
<a href="#l6.836"></a><span id="l6.836" class="difflineminus">-</span>
<a href="#l6.837"></a><span id="l6.837" class="difflineminus">-      case &quot;sourceURI&quot;:</span>
<a href="#l6.838"></a><span id="l6.838" class="difflineminus">-        Assert.equal(actualValue.spec, expectedValue);</span>
<a href="#l6.839"></a><span id="l6.839" class="difflineminus">-        break;</span>
<a href="#l6.840"></a><span id="l6.840" class="difflineminus">-</span>
<a href="#l6.841"></a><span id="l6.841" class="difflineminus">-      case &quot;updateDate&quot;:</span>
<a href="#l6.842"></a><span id="l6.842" class="difflineminus">-        Assert.equal(actualValue.getTime(), expectedValue.getTime());</span>
<a href="#l6.843"></a><span id="l6.843" class="difflineminus">-        break;</span>
<a href="#l6.844"></a><span id="l6.844" class="difflineminus">-</span>
<a href="#l6.845"></a><span id="l6.845" class="difflineminus">-      case &quot;compatibilityOverrides&quot;:</span>
<a href="#l6.846"></a><span id="l6.846" class="difflineminus">-        Assert.equal(actualValue.length, expectedValue.length);</span>
<a href="#l6.847"></a><span id="l6.847" class="difflineminus">-        for (let i = 0; i &lt; actualValue.length; i++) {</span>
<a href="#l6.848"></a><span id="l6.848" class="difflineminus">-          do_check_compatibilityoverride(actualValue[i], expectedValue[i]);</span>
<a href="#l6.849"></a><span id="l6.849" class="difflineminus">-        }</span>
<a href="#l6.850"></a><span id="l6.850" class="difflineminus">-        break;</span>
<a href="#l6.851"></a><span id="l6.851" class="difflineminus">-</span>
<a href="#l6.852"></a><span id="l6.852" class="difflineminus">-      case &quot;icons&quot;:</span>
<a href="#l6.853"></a><span id="l6.853" class="difflineminus">-        do_check_icons(actualValue, expectedValue);</span>
<a href="#l6.854"></a><span id="l6.854" class="difflineminus">-        break;</span>
<a href="#l6.855"></a><span id="l6.855" class="difflineminus">-</span>
<a href="#l6.856"></a><span id="l6.856" class="difflineminus">-      default:</span>
<a href="#l6.857"></a><span id="l6.857" class="difflineminus">-        if (actualValue !== expectedValue) {</span>
<a href="#l6.858"></a><span id="l6.858" class="difflineminus">-          do_throw(</span>
<a href="#l6.859"></a><span id="l6.859" class="difflineminus">-            &quot;Failed for &quot; +</span>
<a href="#l6.860"></a><span id="l6.860" class="difflineminus">-              aProperty +</span>
<a href="#l6.861"></a><span id="l6.861" class="difflineminus">-              &quot; for add-on &quot; +</span>
<a href="#l6.862"></a><span id="l6.862" class="difflineminus">-              aExpectedAddon.id +</span>
<a href="#l6.863"></a><span id="l6.863" class="difflineminus">-              &quot; (&quot; +</span>
<a href="#l6.864"></a><span id="l6.864" class="difflineminus">-              actualValue +</span>
<a href="#l6.865"></a><span id="l6.865" class="difflineminus">-              &quot; === &quot; +</span>
<a href="#l6.866"></a><span id="l6.866" class="difflineminus">-              expectedValue +</span>
<a href="#l6.867"></a><span id="l6.867" class="difflineminus">-              &quot;)&quot;</span>
<a href="#l6.868"></a><span id="l6.868" class="difflineminus">-          );</span>
<a href="#l6.869"></a><span id="l6.869" class="difflineminus">-        }</span>
<a href="#l6.870"></a><span id="l6.870" class="difflineminus">-    }</span>
<a href="#l6.871"></a><span id="l6.871" class="difflineminus">-  });</span>
<a href="#l6.872"></a><span id="l6.872" class="difflineminus">-}</span>
<a href="#l6.873"></a><span id="l6.873" class="difflineminus">-</span>
<a href="#l6.874"></a><span id="l6.874" class="difflineminus">-/**</span>
<a href="#l6.875"></a><span id="l6.875" class="difflineminus">- * Check that the actual author is the same as the expected author.</span>
<a href="#l6.876"></a><span id="l6.876" class="difflineminus">- *</span>
<a href="#l6.877"></a><span id="l6.877" class="difflineminus">- * @param  aActual</span>
<a href="#l6.878"></a><span id="l6.878" class="difflineminus">- *         The actual author to check.</span>
<a href="#l6.879"></a><span id="l6.879" class="difflineminus">- * @param  aExpected</span>
<a href="#l6.880"></a><span id="l6.880" class="difflineminus">- *         The expected author to check against.</span>
<a href="#l6.881"></a><span id="l6.881" class="difflineminus">- */</span>
<a href="#l6.882"></a><span id="l6.882" class="difflineminus">-function do_check_author(aActual, aExpected) {</span>
<a href="#l6.883"></a><span id="l6.883" class="difflineminus">-  Assert.equal(aActual.toString(), aExpected.name);</span>
<a href="#l6.884"></a><span id="l6.884" class="difflineminus">-  Assert.equal(aActual.name, aExpected.name);</span>
<a href="#l6.885"></a><span id="l6.885" class="difflineminus">-  Assert.equal(aActual.url, aExpected.url);</span>
<a href="#l6.886"></a><span id="l6.886" class="difflineminus">-}</span>
<a href="#l6.887"></a><span id="l6.887" class="difflineminus">-</span>
<a href="#l6.888"></a><span id="l6.888" class="difflineminus">-/**</span>
<a href="#l6.889"></a><span id="l6.889" class="difflineminus">- * Check that the actual screenshot is the same as the expected screenshot.</span>
<a href="#l6.890"></a><span id="l6.890" class="difflineminus">- *</span>
<a href="#l6.891"></a><span id="l6.891" class="difflineminus">- * @param  aActual</span>
<a href="#l6.892"></a><span id="l6.892" class="difflineminus">- *         The actual screenshot to check.</span>
<a href="#l6.893"></a><span id="l6.893" class="difflineminus">- * @param  aExpected</span>
<a href="#l6.894"></a><span id="l6.894" class="difflineminus">- *         The expected screenshot to check against.</span>
<a href="#l6.895"></a><span id="l6.895" class="difflineminus">- */</span>
<a href="#l6.896"></a><span id="l6.896" class="difflineminus">-function do_check_screenshot(aActual, aExpected) {</span>
<a href="#l6.897"></a><span id="l6.897" class="difflineminus">-  Assert.equal(aActual.toString(), aExpected.url);</span>
<a href="#l6.898"></a><span id="l6.898" class="difflineminus">-  Assert.equal(aActual.url, aExpected.url);</span>
<a href="#l6.899"></a><span id="l6.899" class="difflineminus">-  Assert.equal(aActual.width, aExpected.width);</span>
<a href="#l6.900"></a><span id="l6.900" class="difflineminus">-  Assert.equal(aActual.height, aExpected.height);</span>
<a href="#l6.901"></a><span id="l6.901" class="difflineminus">-  Assert.equal(aActual.thumbnailURL, aExpected.thumbnailURL);</span>
<a href="#l6.902"></a><span id="l6.902" class="difflineminus">-  Assert.equal(aActual.thumbnailWidth, aExpected.thumbnailWidth);</span>
<a href="#l6.903"></a><span id="l6.903" class="difflineminus">-  Assert.equal(aActual.thumbnailHeight, aExpected.thumbnailHeight);</span>
<a href="#l6.904"></a><span id="l6.904" class="difflineminus">-  Assert.equal(aActual.caption, aExpected.caption);</span>
<a href="#l6.905"></a><span id="l6.905" class="difflineminus">-}</span>
<a href="#l6.906"></a><span id="l6.906" class="difflineminus">-</span>
<a href="#l6.907"></a><span id="l6.907" class="difflineminus">-/**</span>
<a href="#l6.908"></a><span id="l6.908" class="difflineminus">- * Check that the actual compatibility override is the same as the expected</span>
<a href="#l6.909"></a><span id="l6.909" class="difflineminus">- * compatibility override.</span>
<a href="#l6.910"></a><span id="l6.910" class="difflineminus">- *</span>
<a href="#l6.911"></a><span id="l6.911" class="difflineminus">- * @param  aAction</span>
<a href="#l6.912"></a><span id="l6.912" class="difflineminus">- *         The actual compatibility override to check.</span>
<a href="#l6.913"></a><span id="l6.913" class="difflineminus">- * @param  aExpected</span>
<a href="#l6.914"></a><span id="l6.914" class="difflineminus">- *         The expected compatibility override to check against.</span>
<a href="#l6.915"></a><span id="l6.915" class="difflineminus">- */</span>
<a href="#l6.916"></a><span id="l6.916" class="difflineminus">-function do_check_compatibilityoverride(aActual, aExpected) {</span>
<a href="#l6.917"></a><span id="l6.917" class="difflineminus">-  Assert.equal(aActual.type, aExpected.type);</span>
<a href="#l6.918"></a><span id="l6.918" class="difflineminus">-  Assert.equal(aActual.minVersion, aExpected.minVersion);</span>
<a href="#l6.919"></a><span id="l6.919" class="difflineminus">-  Assert.equal(aActual.maxVersion, aExpected.maxVersion);</span>
<a href="#l6.920"></a><span id="l6.920" class="difflineminus">-  Assert.equal(aActual.appID, aExpected.appID);</span>
<a href="#l6.921"></a><span id="l6.921" class="difflineminus">-  Assert.equal(aActual.appMinVersion, aExpected.appMinVersion);</span>
<a href="#l6.922"></a><span id="l6.922" class="difflineminus">-  Assert.equal(aActual.appMaxVersion, aExpected.appMaxVersion);</span>
<a href="#l6.923"></a><span id="l6.923" class="difflineminus">-}</span>
<a href="#l6.924"></a><span id="l6.924" class="difflineminus">-</span>
<a href="#l6.925"></a><span id="l6.925" class="difflineminus">-function do_check_icons(aActual, aExpected) {</span>
<a href="#l6.926"></a><span id="l6.926" class="difflineminus">-  for (var size in aExpected) {</span>
<a href="#l6.927"></a><span id="l6.927" class="difflineminus">-    Assert.equal(aActual[size], aExpected[size]);</span>
<a href="#l6.928"></a><span id="l6.928" class="difflineminus">-  }</span>
<a href="#l6.929"></a><span id="l6.929" class="difflineminus">-}</span>
<a href="#l6.930"></a><span id="l6.930" class="difflineminus">-</span>
<a href="#l6.931"></a><span id="l6.931" class="difflineminus">-function isThemeInAddonsList(aDir, aId) {</span>
<a href="#l6.932"></a><span id="l6.932" class="difflineminus">-  return AddonTestUtils.addonsList.hasTheme(aDir, aId);</span>
<a href="#l6.933"></a><span id="l6.933" class="difflineminus">-}</span>
<a href="#l6.934"></a><span id="l6.934" class="difflineminus">-</span>
<a href="#l6.935"></a><span id="l6.935" class="difflineminus">-function isExtensionInBootstrappedList(aDir, aId) {</span>
<a href="#l6.936"></a><span id="l6.936" class="difflineminus">-  return AddonTestUtils.addonsList.hasExtension(aDir, aId);</span>
<a href="#l6.937"></a><span id="l6.937" class="difflineminus">-}</span>
<a href="#l6.938"></a><span id="l6.938" class="difflineminus">-</span>
<a href="#l6.939"></a><span id="l6.939" class="difflineminus">-/**</span>
<a href="#l6.940"></a><span id="l6.940" class="difflineminus">- * Writes a manifest.json manifest into an extension using the properties passed</span>
<a href="#l6.941"></a><span id="l6.941" class="difflineminus">- * in a JS object.</span>
<a href="#l6.942"></a><span id="l6.942" class="difflineminus">- *</span>
<a href="#l6.943"></a><span id="l6.943" class="difflineminus">- * @param   aManifest</span>
<a href="#l6.944"></a><span id="l6.944" class="difflineminus">- *          The data to write</span>
<a href="#l6.945"></a><span id="l6.945" class="difflineminus">- * @param   aDir</span>
<a href="#l6.946"></a><span id="l6.946" class="difflineminus">- *          The install directory to add the extension to</span>
<a href="#l6.947"></a><span id="l6.947" class="difflineminus">- * @param   aId</span>
<a href="#l6.948"></a><span id="l6.948" class="difflineminus">- *          An optional string to override the default installation aId</span>
<a href="#l6.949"></a><span id="l6.949" class="difflineminus">- * @return  A file pointing to where the extension was installed</span>
<a href="#l6.950"></a><span id="l6.950" class="difflineminus">- */</span>
<a href="#l6.951"></a><span id="l6.951" class="difflineminus">-function promiseWriteWebManifestForExtension(</span>
<a href="#l6.952"></a><span id="l6.952" class="difflineminus">-  aData,</span>
<a href="#l6.953"></a><span id="l6.953" class="difflineminus">-  aDir,</span>
<a href="#l6.954"></a><span id="l6.954" class="difflineminus">-  aId = aData.applications.gecko.id</span>
<a href="#l6.955"></a><span id="l6.955" class="difflineminus">-) {</span>
<a href="#l6.956"></a><span id="l6.956" class="difflineminus">-  let files = {</span>
<a href="#l6.957"></a><span id="l6.957" class="difflineminus">-    &quot;manifest.json&quot;: JSON.stringify(aData),</span>
<a href="#l6.958"></a><span id="l6.958" class="difflineminus">-  };</span>
<a href="#l6.959"></a><span id="l6.959" class="difflineminus">-  return AddonTestUtils.promiseWriteFilesToExtension(aDir.path, aId, files);</span>
<a href="#l6.960"></a><span id="l6.960" class="difflineminus">-}</span>
<a href="#l6.961"></a><span id="l6.961" class="difflineminus">-</span>
<a href="#l6.962"></a><span id="l6.962" class="difflineminus">-/**</span>
<a href="#l6.963"></a><span id="l6.963" class="difflineminus">- * Creates an XPI file for some manifest data in the temporary directory and</span>
<a href="#l6.964"></a><span id="l6.964" class="difflineminus">- * returns the nsIFile for it. The file will be deleted when the test completes.</span>
<a href="#l6.965"></a><span id="l6.965" class="difflineminus">- *</span>
<a href="#l6.966"></a><span id="l6.966" class="difflineminus">- * @param   aData</span>
<a href="#l6.967"></a><span id="l6.967" class="difflineminus">- *          The object holding data about the add-on</span>
<a href="#l6.968"></a><span id="l6.968" class="difflineminus">- * @return  A file pointing to the created XPI file</span>
<a href="#l6.969"></a><span id="l6.969" class="difflineminus">- */</span>
<a href="#l6.970"></a><span id="l6.970" class="difflineminus">-function createTempXPIFile(aData, aExtraFile) {</span>
<a href="#l6.971"></a><span id="l6.971" class="difflineminus">-  let files = {</span>
<a href="#l6.972"></a><span id="l6.972" class="difflineminus">-    &quot;install.rdf&quot;: aData,</span>
<a href="#l6.973"></a><span id="l6.973" class="difflineminus">-  };</span>
<a href="#l6.974"></a><span id="l6.974" class="difflineminus">-  if (typeof aExtraFile == &quot;object&quot;) {</span>
<a href="#l6.975"></a><span id="l6.975" class="difflineminus">-    Object.assign(files, aExtraFile);</span>
<a href="#l6.976"></a><span id="l6.976" class="difflineminus">-  } else if (aExtraFile) {</span>
<a href="#l6.977"></a><span id="l6.977" class="difflineminus">-    files[aExtraFile] = &quot;&quot;;</span>
<a href="#l6.978"></a><span id="l6.978" class="difflineminus">-  }</span>
<a href="#l6.979"></a><span id="l6.979" class="difflineminus">-</span>
<a href="#l6.980"></a><span id="l6.980" class="difflineminus">-  return AddonTestUtils.createTempXPIFile(files);</span>
<a href="#l6.981"></a><span id="l6.981" class="difflineminus">-}</span>
<a href="#l6.982"></a><span id="l6.982" class="difflineminus">-</span>
<a href="#l6.983"></a><span id="l6.983" class="difflineminus">-var gExpectedEvents = {};</span>
<a href="#l6.984"></a><span id="l6.984" class="difflineminus">-var gExpectedInstalls = [];</span>
<a href="#l6.985"></a><span id="l6.985" class="difflineminus">-var gNext = null;</span>
<a href="#l6.986"></a><span id="l6.986" class="difflineminus">-</span>
<a href="#l6.987"></a><span id="l6.987" class="difflineminus">-function getExpectedEvent(aId) {</span>
<a href="#l6.988"></a><span id="l6.988" class="difflineminus">-  if (!(aId in gExpectedEvents)) {</span>
<a href="#l6.989"></a><span id="l6.989" class="difflineminus">-    do_throw(&quot;Wasn't expecting events for &quot; + aId);</span>
<a href="#l6.990"></a><span id="l6.990" class="difflineminus">-  }</span>
<a href="#l6.991"></a><span id="l6.991" class="difflineminus">-  if (gExpectedEvents[aId].length == 0) {</span>
<a href="#l6.992"></a><span id="l6.992" class="difflineminus">-    do_throw(&quot;Too many events for &quot; + aId);</span>
<a href="#l6.993"></a><span id="l6.993" class="difflineminus">-  }</span>
<a href="#l6.994"></a><span id="l6.994" class="difflineminus">-  let event = gExpectedEvents[aId].shift();</span>
<a href="#l6.995"></a><span id="l6.995" class="difflineminus">-  if (event instanceof Array) {</span>
<a href="#l6.996"></a><span id="l6.996" class="difflineminus">-    return event;</span>
<a href="#l6.997"></a><span id="l6.997" class="difflineminus">-  }</span>
<a href="#l6.998"></a><span id="l6.998" class="difflineminus">-  return [event, true];</span>
<a href="#l6.999"></a><span id="l6.999" class="difflineminus">-}</span>
<a href="#l6.1000"></a><span id="l6.1000" class="difflineminus">-</span>
<a href="#l6.1001"></a><span id="l6.1001" class="difflineminus">-function getExpectedInstall(aAddon) {</span>
<a href="#l6.1002"></a><span id="l6.1002" class="difflineminus">-  if (gExpectedInstalls instanceof Array) {</span>
<a href="#l6.1003"></a><span id="l6.1003" class="difflineminus">-    return gExpectedInstalls.shift();</span>
<a href="#l6.1004"></a><span id="l6.1004" class="difflineminus">-  }</span>
<a href="#l6.1005"></a><span id="l6.1005" class="difflineminus">-  if (!aAddon || !aAddon.id) {</span>
<a href="#l6.1006"></a><span id="l6.1006" class="difflineminus">-    return gExpectedInstalls.NO_ID.shift();</span>
<a href="#l6.1007"></a><span id="l6.1007" class="difflineminus">-  }</span>
<a href="#l6.1008"></a><span id="l6.1008" class="difflineminus">-  let id = aAddon.id;</span>
<a href="#l6.1009"></a><span id="l6.1009" class="difflineminus">-  if (!(id in gExpectedInstalls) || !(gExpectedInstalls[id] instanceof Array)) {</span>
<a href="#l6.1010"></a><span id="l6.1010" class="difflineminus">-    do_throw(&quot;Wasn't expecting events for &quot; + id);</span>
<a href="#l6.1011"></a><span id="l6.1011" class="difflineminus">-  }</span>
<a href="#l6.1012"></a><span id="l6.1012" class="difflineminus">-  if (gExpectedInstalls[id].length == 0) {</span>
<a href="#l6.1013"></a><span id="l6.1013" class="difflineminus">-    do_throw(&quot;Too many events for &quot; + id);</span>
<a href="#l6.1014"></a><span id="l6.1014" class="difflineminus">-  }</span>
<a href="#l6.1015"></a><span id="l6.1015" class="difflineminus">-  return gExpectedInstalls[id].shift();</span>
<a href="#l6.1016"></a><span id="l6.1016" class="difflineminus">-}</span>
<a href="#l6.1017"></a><span id="l6.1017" class="difflineminus">-</span>
<a href="#l6.1018"></a><span id="l6.1018" class="difflineminus">-const AddonListener = {</span>
<a href="#l6.1019"></a><span id="l6.1019" class="difflineminus">-  onPropertyChanged(aAddon, aProperties) {</span>
<a href="#l6.1020"></a><span id="l6.1020" class="difflineminus">-    info(`Got onPropertyChanged event for ${aAddon.id}`);</span>
<a href="#l6.1021"></a><span id="l6.1021" class="difflineminus">-    let [event, properties] = getExpectedEvent(aAddon.id);</span>
<a href="#l6.1022"></a><span id="l6.1022" class="difflineminus">-    Assert.equal(&quot;onPropertyChanged&quot;, event);</span>
<a href="#l6.1023"></a><span id="l6.1023" class="difflineminus">-    Assert.equal(aProperties.length, properties.length);</span>
<a href="#l6.1024"></a><span id="l6.1024" class="difflineminus">-    properties.forEach(function(aProperty) {</span>
<a href="#l6.1025"></a><span id="l6.1025" class="difflineminus">-      // Only test that the expected properties are listed, having additional</span>
<a href="#l6.1026"></a><span id="l6.1026" class="difflineminus">-      // properties listed is not necessary a problem</span>
<a href="#l6.1027"></a><span id="l6.1027" class="difflineminus">-      if (!aProperties.includes(aProperty)) {</span>
<a href="#l6.1028"></a><span id="l6.1028" class="difflineminus">-        do_throw(&quot;Did not see property change for &quot; + aProperty);</span>
<a href="#l6.1029"></a><span id="l6.1029" class="difflineminus">-      }</span>
<a href="#l6.1030"></a><span id="l6.1030" class="difflineminus">-    });</span>
<a href="#l6.1031"></a><span id="l6.1031" class="difflineminus">-    return check_test_completed(arguments);</span>
<a href="#l6.1032"></a><span id="l6.1032" class="difflineminus">-  },</span>
<a href="#l6.1033"></a><span id="l6.1033" class="difflineminus">-</span>
<a href="#l6.1034"></a><span id="l6.1034" class="difflineminus">-  onEnabling(aAddon, aRequiresRestart) {</span>
<a href="#l6.1035"></a><span id="l6.1035" class="difflineminus">-    info(`Got onEnabling event for ${aAddon.id}`);</span>
<a href="#l6.1036"></a><span id="l6.1036" class="difflineminus">-    let [event, expectedRestart] = getExpectedEvent(aAddon.id);</span>
<a href="#l6.1037"></a><span id="l6.1037" class="difflineminus">-    Assert.equal(&quot;onEnabling&quot;, event);</span>
<a href="#l6.1038"></a><span id="l6.1038" class="difflineminus">-    Assert.equal(aRequiresRestart, expectedRestart);</span>
<a href="#l6.1039"></a><span id="l6.1039" class="difflineminus">-    if (expectedRestart) {</span>
<a href="#l6.1040"></a><span id="l6.1040" class="difflineminus">-      Assert.ok(hasFlag(aAddon.pendingOperations, AddonManager.PENDING_ENABLE));</span>
<a href="#l6.1041"></a><span id="l6.1041" class="difflineminus">-    }</span>
<a href="#l6.1042"></a><span id="l6.1042" class="difflineminus">-    Assert.ok(!hasFlag(aAddon.permissions, AddonManager.PERM_CAN_ENABLE));</span>
<a href="#l6.1043"></a><span id="l6.1043" class="difflineminus">-    return check_test_completed(arguments);</span>
<a href="#l6.1044"></a><span id="l6.1044" class="difflineminus">-  },</span>
<a href="#l6.1045"></a><span id="l6.1045" class="difflineminus">-</span>
<a href="#l6.1046"></a><span id="l6.1046" class="difflineminus">-  onEnabled(aAddon) {</span>
<a href="#l6.1047"></a><span id="l6.1047" class="difflineminus">-    info(`Got onEnabled event for ${aAddon.id}`);</span>
<a href="#l6.1048"></a><span id="l6.1048" class="difflineminus">-    let [event] = getExpectedEvent(aAddon.id);</span>
<a href="#l6.1049"></a><span id="l6.1049" class="difflineminus">-    Assert.equal(&quot;onEnabled&quot;, event);</span>
<a href="#l6.1050"></a><span id="l6.1050" class="difflineminus">-    Assert.ok(!hasFlag(aAddon.permissions, AddonManager.PERM_CAN_ENABLE));</span>
<a href="#l6.1051"></a><span id="l6.1051" class="difflineminus">-    return check_test_completed(arguments);</span>
<a href="#l6.1052"></a><span id="l6.1052" class="difflineminus">-  },</span>
<a href="#l6.1053"></a><span id="l6.1053" class="difflineminus">-</span>
<a href="#l6.1054"></a><span id="l6.1054" class="difflineminus">-  onDisabling(aAddon, aRequiresRestart) {</span>
<a href="#l6.1055"></a><span id="l6.1055" class="difflineminus">-    info(`Got onDisabling event for ${aAddon.id}`);</span>
<a href="#l6.1056"></a><span id="l6.1056" class="difflineminus">-    let [event, expectedRestart] = getExpectedEvent(aAddon.id);</span>
<a href="#l6.1057"></a><span id="l6.1057" class="difflineminus">-    Assert.equal(&quot;onDisabling&quot;, event);</span>
<a href="#l6.1058"></a><span id="l6.1058" class="difflineminus">-    Assert.equal(aRequiresRestart, expectedRestart);</span>
<a href="#l6.1059"></a><span id="l6.1059" class="difflineminus">-    if (expectedRestart) {</span>
<a href="#l6.1060"></a><span id="l6.1060" class="difflineminus">-      Assert.ok(</span>
<a href="#l6.1061"></a><span id="l6.1061" class="difflineminus">-        hasFlag(aAddon.pendingOperations, AddonManager.PENDING_DISABLE)</span>
<a href="#l6.1062"></a><span id="l6.1062" class="difflineminus">-      );</span>
<a href="#l6.1063"></a><span id="l6.1063" class="difflineminus">-    }</span>
<a href="#l6.1064"></a><span id="l6.1064" class="difflineminus">-    Assert.ok(!hasFlag(aAddon.permissions, AddonManager.PERM_CAN_DISABLE));</span>
<a href="#l6.1065"></a><span id="l6.1065" class="difflineminus">-    return check_test_completed(arguments);</span>
<a href="#l6.1066"></a><span id="l6.1066" class="difflineminus">-  },</span>
<a href="#l6.1067"></a><span id="l6.1067" class="difflineminus">-</span>
<a href="#l6.1068"></a><span id="l6.1068" class="difflineminus">-  onDisabled(aAddon) {</span>
<a href="#l6.1069"></a><span id="l6.1069" class="difflineminus">-    info(`Got onDisabled event for ${aAddon.id}`);</span>
<a href="#l6.1070"></a><span id="l6.1070" class="difflineminus">-    let [event] = getExpectedEvent(aAddon.id);</span>
<a href="#l6.1071"></a><span id="l6.1071" class="difflineminus">-    Assert.equal(&quot;onDisabled&quot;, event);</span>
<a href="#l6.1072"></a><span id="l6.1072" class="difflineminus">-    Assert.ok(!hasFlag(aAddon.permissions, AddonManager.PERM_CAN_DISABLE));</span>
<a href="#l6.1073"></a><span id="l6.1073" class="difflineminus">-    return check_test_completed(arguments);</span>
<a href="#l6.1074"></a><span id="l6.1074" class="difflineminus">-  },</span>
<a href="#l6.1075"></a><span id="l6.1075" class="difflineminus">-</span>
<a href="#l6.1076"></a><span id="l6.1076" class="difflineminus">-  onInstalling(aAddon, aRequiresRestart) {</span>
<a href="#l6.1077"></a><span id="l6.1077" class="difflineminus">-    info(`Got onInstalling event for ${aAddon.id}`);</span>
<a href="#l6.1078"></a><span id="l6.1078" class="difflineminus">-    let [event, expectedRestart] = getExpectedEvent(aAddon.id);</span>
<a href="#l6.1079"></a><span id="l6.1079" class="difflineminus">-    Assert.equal(&quot;onInstalling&quot;, event);</span>
<a href="#l6.1080"></a><span id="l6.1080" class="difflineminus">-    Assert.equal(aRequiresRestart, expectedRestart);</span>
<a href="#l6.1081"></a><span id="l6.1081" class="difflineminus">-    if (expectedRestart) {</span>
<a href="#l6.1082"></a><span id="l6.1082" class="difflineminus">-      Assert.ok(</span>
<a href="#l6.1083"></a><span id="l6.1083" class="difflineminus">-        hasFlag(aAddon.pendingOperations, AddonManager.PENDING_INSTALL)</span>
<a href="#l6.1084"></a><span id="l6.1084" class="difflineminus">-      );</span>
<a href="#l6.1085"></a><span id="l6.1085" class="difflineminus">-    }</span>
<a href="#l6.1086"></a><span id="l6.1086" class="difflineminus">-    return check_test_completed(arguments);</span>
<a href="#l6.1087"></a><span id="l6.1087" class="difflineminus">-  },</span>
<a href="#l6.1088"></a><span id="l6.1088" class="difflineminus">-</span>
<a href="#l6.1089"></a><span id="l6.1089" class="difflineminus">-  onInstalled(aAddon) {</span>
<a href="#l6.1090"></a><span id="l6.1090" class="difflineminus">-    info(`Got onInstalled event for ${aAddon.id}`);</span>
<a href="#l6.1091"></a><span id="l6.1091" class="difflineminus">-    let [event] = getExpectedEvent(aAddon.id);</span>
<a href="#l6.1092"></a><span id="l6.1092" class="difflineminus">-    Assert.equal(&quot;onInstalled&quot;, event);</span>
<a href="#l6.1093"></a><span id="l6.1093" class="difflineminus">-    return check_test_completed(arguments);</span>
<a href="#l6.1094"></a><span id="l6.1094" class="difflineminus">-  },</span>
<a href="#l6.1095"></a><span id="l6.1095" class="difflineminus">-</span>
<a href="#l6.1096"></a><span id="l6.1096" class="difflineminus">-  onUninstalling(aAddon, aRequiresRestart) {</span>
<a href="#l6.1097"></a><span id="l6.1097" class="difflineminus">-    info(`Got onUninstalling event for ${aAddon.id}`);</span>
<a href="#l6.1098"></a><span id="l6.1098" class="difflineminus">-    let [event, expectedRestart] = getExpectedEvent(aAddon.id);</span>
<a href="#l6.1099"></a><span id="l6.1099" class="difflineminus">-    Assert.equal(&quot;onUninstalling&quot;, event);</span>
<a href="#l6.1100"></a><span id="l6.1100" class="difflineminus">-    Assert.equal(aRequiresRestart, expectedRestart);</span>
<a href="#l6.1101"></a><span id="l6.1101" class="difflineminus">-    if (expectedRestart) {</span>
<a href="#l6.1102"></a><span id="l6.1102" class="difflineminus">-      Assert.ok(</span>
<a href="#l6.1103"></a><span id="l6.1103" class="difflineminus">-        hasFlag(aAddon.pendingOperations, AddonManager.PENDING_UNINSTALL)</span>
<a href="#l6.1104"></a><span id="l6.1104" class="difflineminus">-      );</span>
<a href="#l6.1105"></a><span id="l6.1105" class="difflineminus">-    }</span>
<a href="#l6.1106"></a><span id="l6.1106" class="difflineminus">-    return check_test_completed(arguments);</span>
<a href="#l6.1107"></a><span id="l6.1107" class="difflineminus">-  },</span>
<a href="#l6.1108"></a><span id="l6.1108" class="difflineminus">-</span>
<a href="#l6.1109"></a><span id="l6.1109" class="difflineminus">-  onUninstalled(aAddon) {</span>
<a href="#l6.1110"></a><span id="l6.1110" class="difflineminus">-    info(`Got onUninstalled event for ${aAddon.id}`);</span>
<a href="#l6.1111"></a><span id="l6.1111" class="difflineminus">-    let [event] = getExpectedEvent(aAddon.id);</span>
<a href="#l6.1112"></a><span id="l6.1112" class="difflineminus">-    Assert.equal(&quot;onUninstalled&quot;, event);</span>
<a href="#l6.1113"></a><span id="l6.1113" class="difflineminus">-    return check_test_completed(arguments);</span>
<a href="#l6.1114"></a><span id="l6.1114" class="difflineminus">-  },</span>
<a href="#l6.1115"></a><span id="l6.1115" class="difflineminus">-</span>
<a href="#l6.1116"></a><span id="l6.1116" class="difflineminus">-  onOperationCancelled(aAddon) {</span>
<a href="#l6.1117"></a><span id="l6.1117" class="difflineminus">-    info(`Got onOperationCancelled event for ${aAddon.id}`);</span>
<a href="#l6.1118"></a><span id="l6.1118" class="difflineminus">-    let [event] = getExpectedEvent(aAddon.id);</span>
<a href="#l6.1119"></a><span id="l6.1119" class="difflineminus">-    Assert.equal(&quot;onOperationCancelled&quot;, event);</span>
<a href="#l6.1120"></a><span id="l6.1120" class="difflineminus">-    return check_test_completed(arguments);</span>
<a href="#l6.1121"></a><span id="l6.1121" class="difflineminus">-  },</span>
<a href="#l6.1122"></a><span id="l6.1122" class="difflineminus">-};</span>
<a href="#l6.1123"></a><span id="l6.1123" class="difflineminus">-</span>
<a href="#l6.1124"></a><span id="l6.1124" class="difflineminus">-const InstallListener = {</span>
<a href="#l6.1125"></a><span id="l6.1125" class="difflineminus">-  onNewInstall(install) {</span>
<a href="#l6.1126"></a><span id="l6.1126" class="difflineminus">-    if (</span>
<a href="#l6.1127"></a><span id="l6.1127" class="difflineminus">-      install.state != AddonManager.STATE_DOWNLOADED &amp;&amp;</span>
<a href="#l6.1128"></a><span id="l6.1128" class="difflineminus">-      install.state != AddonManager.STATE_DOWNLOAD_FAILED &amp;&amp;</span>
<a href="#l6.1129"></a><span id="l6.1129" class="difflineminus">-      install.state != AddonManager.STATE_AVAILABLE</span>
<a href="#l6.1130"></a><span id="l6.1130" class="difflineminus">-    ) {</span>
<a href="#l6.1131"></a><span id="l6.1131" class="difflineminus">-      do_throw(&quot;Bad install state &quot; + install.state);</span>
<a href="#l6.1132"></a><span id="l6.1132" class="difflineminus">-    }</span>
<a href="#l6.1133"></a><span id="l6.1133" class="difflineminus">-    if (install.state != AddonManager.STATE_DOWNLOAD_FAILED) {</span>
<a href="#l6.1134"></a><span id="l6.1134" class="difflineminus">-      Assert.equal(install.error, 0);</span>
<a href="#l6.1135"></a><span id="l6.1135" class="difflineminus">-    } else {</span>
<a href="#l6.1136"></a><span id="l6.1136" class="difflineminus">-      Assert.notEqual(install.error, 0);</span>
<a href="#l6.1137"></a><span id="l6.1137" class="difflineminus">-    }</span>
<a href="#l6.1138"></a><span id="l6.1138" class="difflineminus">-    Assert.equal(&quot;onNewInstall&quot;, getExpectedInstall());</span>
<a href="#l6.1139"></a><span id="l6.1139" class="difflineminus">-    return check_test_completed(arguments);</span>
<a href="#l6.1140"></a><span id="l6.1140" class="difflineminus">-  },</span>
<a href="#l6.1141"></a><span id="l6.1141" class="difflineminus">-</span>
<a href="#l6.1142"></a><span id="l6.1142" class="difflineminus">-  onDownloadStarted(install) {</span>
<a href="#l6.1143"></a><span id="l6.1143" class="difflineminus">-    Assert.equal(install.state, AddonManager.STATE_DOWNLOADING);</span>
<a href="#l6.1144"></a><span id="l6.1144" class="difflineminus">-    Assert.equal(install.error, 0);</span>
<a href="#l6.1145"></a><span id="l6.1145" class="difflineminus">-    Assert.equal(&quot;onDownloadStarted&quot;, getExpectedInstall());</span>
<a href="#l6.1146"></a><span id="l6.1146" class="difflineminus">-    return check_test_completed(arguments);</span>
<a href="#l6.1147"></a><span id="l6.1147" class="difflineminus">-  },</span>
<a href="#l6.1148"></a><span id="l6.1148" class="difflineminus">-</span>
<a href="#l6.1149"></a><span id="l6.1149" class="difflineminus">-  onDownloadEnded(install) {</span>
<a href="#l6.1150"></a><span id="l6.1150" class="difflineminus">-    Assert.equal(install.state, AddonManager.STATE_DOWNLOADED);</span>
<a href="#l6.1151"></a><span id="l6.1151" class="difflineminus">-    Assert.equal(install.error, 0);</span>
<a href="#l6.1152"></a><span id="l6.1152" class="difflineminus">-    Assert.equal(&quot;onDownloadEnded&quot;, getExpectedInstall());</span>
<a href="#l6.1153"></a><span id="l6.1153" class="difflineminus">-    return check_test_completed(arguments);</span>
<a href="#l6.1154"></a><span id="l6.1154" class="difflineminus">-  },</span>
<a href="#l6.1155"></a><span id="l6.1155" class="difflineminus">-</span>
<a href="#l6.1156"></a><span id="l6.1156" class="difflineminus">-  onDownloadFailed(install) {</span>
<a href="#l6.1157"></a><span id="l6.1157" class="difflineminus">-    Assert.equal(install.state, AddonManager.STATE_DOWNLOAD_FAILED);</span>
<a href="#l6.1158"></a><span id="l6.1158" class="difflineminus">-    Assert.equal(&quot;onDownloadFailed&quot;, getExpectedInstall());</span>
<a href="#l6.1159"></a><span id="l6.1159" class="difflineminus">-    return check_test_completed(arguments);</span>
<a href="#l6.1160"></a><span id="l6.1160" class="difflineminus">-  },</span>
<a href="#l6.1161"></a><span id="l6.1161" class="difflineminus">-</span>
<a href="#l6.1162"></a><span id="l6.1162" class="difflineminus">-  onDownloadCancelled(install) {</span>
<a href="#l6.1163"></a><span id="l6.1163" class="difflineminus">-    Assert.equal(install.state, AddonManager.STATE_CANCELLED);</span>
<a href="#l6.1164"></a><span id="l6.1164" class="difflineminus">-    Assert.equal(install.error, 0);</span>
<a href="#l6.1165"></a><span id="l6.1165" class="difflineminus">-    Assert.equal(&quot;onDownloadCancelled&quot;, getExpectedInstall());</span>
<a href="#l6.1166"></a><span id="l6.1166" class="difflineminus">-    return check_test_completed(arguments);</span>
<a href="#l6.1167"></a><span id="l6.1167" class="difflineminus">-  },</span>
<a href="#l6.1168"></a><span id="l6.1168" class="difflineminus">-</span>
<a href="#l6.1169"></a><span id="l6.1169" class="difflineminus">-  onInstallStarted(install) {</span>
<a href="#l6.1170"></a><span id="l6.1170" class="difflineminus">-    Assert.equal(install.state, AddonManager.STATE_INSTALLING);</span>
<a href="#l6.1171"></a><span id="l6.1171" class="difflineminus">-    Assert.equal(install.error, 0);</span>
<a href="#l6.1172"></a><span id="l6.1172" class="difflineminus">-    Assert.equal(&quot;onInstallStarted&quot;, getExpectedInstall(install.addon));</span>
<a href="#l6.1173"></a><span id="l6.1173" class="difflineminus">-    return check_test_completed(arguments);</span>
<a href="#l6.1174"></a><span id="l6.1174" class="difflineminus">-  },</span>
<a href="#l6.1175"></a><span id="l6.1175" class="difflineminus">-</span>
<a href="#l6.1176"></a><span id="l6.1176" class="difflineminus">-  onInstallEnded(install, newAddon) {</span>
<a href="#l6.1177"></a><span id="l6.1177" class="difflineminus">-    Assert.equal(install.state, AddonManager.STATE_INSTALLED);</span>
<a href="#l6.1178"></a><span id="l6.1178" class="difflineminus">-    Assert.equal(install.error, 0);</span>
<a href="#l6.1179"></a><span id="l6.1179" class="difflineminus">-    Assert.equal(&quot;onInstallEnded&quot;, getExpectedInstall(install.addon));</span>
<a href="#l6.1180"></a><span id="l6.1180" class="difflineminus">-    return check_test_completed(arguments);</span>
<a href="#l6.1181"></a><span id="l6.1181" class="difflineminus">-  },</span>
<a href="#l6.1182"></a><span id="l6.1182" class="difflineminus">-</span>
<a href="#l6.1183"></a><span id="l6.1183" class="difflineminus">-  onInstallFailed(install) {</span>
<a href="#l6.1184"></a><span id="l6.1184" class="difflineminus">-    Assert.equal(install.state, AddonManager.STATE_INSTALL_FAILED);</span>
<a href="#l6.1185"></a><span id="l6.1185" class="difflineminus">-    Assert.equal(&quot;onInstallFailed&quot;, getExpectedInstall(install.addon));</span>
<a href="#l6.1186"></a><span id="l6.1186" class="difflineminus">-    return check_test_completed(arguments);</span>
<a href="#l6.1187"></a><span id="l6.1187" class="difflineminus">-  },</span>
<a href="#l6.1188"></a><span id="l6.1188" class="difflineminus">-</span>
<a href="#l6.1189"></a><span id="l6.1189" class="difflineminus">-  onInstallCancelled(install) {</span>
<a href="#l6.1190"></a><span id="l6.1190" class="difflineminus">-    // If the install was cancelled by a listener returning false from</span>
<a href="#l6.1191"></a><span id="l6.1191" class="difflineminus">-    // onInstallStarted, then the state will revert to STATE_DOWNLOADED.</span>
<a href="#l6.1192"></a><span id="l6.1192" class="difflineminus">-    let possibleStates = [</span>
<a href="#l6.1193"></a><span id="l6.1193" class="difflineminus">-      AddonManager.STATE_CANCELLED,</span>
<a href="#l6.1194"></a><span id="l6.1194" class="difflineminus">-      AddonManager.STATE_DOWNLOADED,</span>
<a href="#l6.1195"></a><span id="l6.1195" class="difflineminus">-    ];</span>
<a href="#l6.1196"></a><span id="l6.1196" class="difflineminus">-    Assert.ok(possibleStates.includes(install.state));</span>
<a href="#l6.1197"></a><span id="l6.1197" class="difflineminus">-    Assert.equal(install.error, 0);</span>
<a href="#l6.1198"></a><span id="l6.1198" class="difflineminus">-    Assert.equal(&quot;onInstallCancelled&quot;, getExpectedInstall(install.addon));</span>
<a href="#l6.1199"></a><span id="l6.1199" class="difflineminus">-    return check_test_completed(arguments);</span>
<a href="#l6.1200"></a><span id="l6.1200" class="difflineminus">-  },</span>
<a href="#l6.1201"></a><span id="l6.1201" class="difflineminus">-</span>
<a href="#l6.1202"></a><span id="l6.1202" class="difflineminus">-  onExternalInstall(aAddon, existingAddon, aRequiresRestart) {</span>
<a href="#l6.1203"></a><span id="l6.1203" class="difflineminus">-    Assert.equal(&quot;onExternalInstall&quot;, getExpectedInstall(aAddon));</span>
<a href="#l6.1204"></a><span id="l6.1204" class="difflineminus">-    Assert.ok(!aRequiresRestart);</span>
<a href="#l6.1205"></a><span id="l6.1205" class="difflineminus">-    return check_test_completed(arguments);</span>
<a href="#l6.1206"></a><span id="l6.1206" class="difflineminus">-  },</span>
<a href="#l6.1207"></a><span id="l6.1207" class="difflineminus">-};</span>
<a href="#l6.1208"></a><span id="l6.1208" class="difflineminus">-</span>
<a href="#l6.1209"></a><span id="l6.1209" class="difflineminus">-function hasFlag(aBits, aFlag) {</span>
<a href="#l6.1210"></a><span id="l6.1210" class="difflineminus">-  return (aBits &amp; aFlag) != 0;</span>
<a href="#l6.1211"></a><span id="l6.1211" class="difflineminus">-}</span>
<a href="#l6.1212"></a><span id="l6.1212" class="difflineminus">-</span>
<a href="#l6.1213"></a><span id="l6.1213" class="difflineminus">-// Just a wrapper around setting the expected events.</span>
<a href="#l6.1214"></a><span id="l6.1214" class="difflineminus">-function prepare_test(aExpectedEvents, aExpectedInstalls, aNext) {</span>
<a href="#l6.1215"></a><span id="l6.1215" class="difflineminus">-  AddonManager.addAddonListener(AddonListener);</span>
<a href="#l6.1216"></a><span id="l6.1216" class="difflineminus">-  AddonManager.addInstallListener(InstallListener);</span>
<a href="#l6.1217"></a><span id="l6.1217" class="difflineminus">-</span>
<a href="#l6.1218"></a><span id="l6.1218" class="difflineminus">-  gExpectedInstalls = aExpectedInstalls;</span>
<a href="#l6.1219"></a><span id="l6.1219" class="difflineminus">-  gExpectedEvents = aExpectedEvents;</span>
<a href="#l6.1220"></a><span id="l6.1220" class="difflineminus">-  gNext = aNext;</span>
<a href="#l6.1221"></a><span id="l6.1221" class="difflineminus">-}</span>
<a href="#l6.1222"></a><span id="l6.1222" class="difflineminus">-</span>
<a href="#l6.1223"></a><span id="l6.1223" class="difflineminus">-function clearListeners() {</span>
<a href="#l6.1224"></a><span id="l6.1224" class="difflineminus">-  AddonManager.removeAddonListener(AddonListener);</span>
<a href="#l6.1225"></a><span id="l6.1225" class="difflineminus">-  AddonManager.removeInstallListener(InstallListener);</span>
<a href="#l6.1226"></a><span id="l6.1226" class="difflineminus">-}</span>
<a href="#l6.1227"></a><span id="l6.1227" class="difflineminus">-</span>
<a href="#l6.1228"></a><span id="l6.1228" class="difflineminus">-function end_test() {</span>
<a href="#l6.1229"></a><span id="l6.1229" class="difflineminus">-  clearListeners();</span>
<a href="#l6.1230"></a><span id="l6.1230" class="difflineminus">-}</span>
<a href="#l6.1231"></a><span id="l6.1231" class="difflineminus">-</span>
<a href="#l6.1232"></a><span id="l6.1232" class="difflineminus">-// Checks if all expected events have been seen and if so calls the callback.</span>
<a href="#l6.1233"></a><span id="l6.1233" class="difflineminus">-function check_test_completed(aArgs) {</span>
<a href="#l6.1234"></a><span id="l6.1234" class="difflineminus">-  if (!gNext) {</span>
<a href="#l6.1235"></a><span id="l6.1235" class="difflineminus">-    return undefined;</span>
<a href="#l6.1236"></a><span id="l6.1236" class="difflineminus">-  }</span>
<a href="#l6.1237"></a><span id="l6.1237" class="difflineminus">-</span>
<a href="#l6.1238"></a><span id="l6.1238" class="difflineminus">-  if (gExpectedInstalls instanceof Array &amp;&amp; gExpectedInstalls.length &gt; 0) {</span>
<a href="#l6.1239"></a><span id="l6.1239" class="difflineminus">-    return undefined;</span>
<a href="#l6.1240"></a><span id="l6.1240" class="difflineminus">-  }</span>
<a href="#l6.1241"></a><span id="l6.1241" class="difflineminus">-</span>
<a href="#l6.1242"></a><span id="l6.1242" class="difflineminus">-  for (let id in gExpectedInstalls) {</span>
<a href="#l6.1243"></a><span id="l6.1243" class="difflineminus">-    let installList = gExpectedInstalls[id];</span>
<a href="#l6.1244"></a><span id="l6.1244" class="difflineminus">-    if (installList.length &gt; 0) {</span>
<a href="#l6.1245"></a><span id="l6.1245" class="difflineminus">-      return undefined;</span>
<a href="#l6.1246"></a><span id="l6.1246" class="difflineminus">-    }</span>
<a href="#l6.1247"></a><span id="l6.1247" class="difflineminus">-  }</span>
<a href="#l6.1248"></a><span id="l6.1248" class="difflineminus">-</span>
<a href="#l6.1249"></a><span id="l6.1249" class="difflineminus">-  for (let id in gExpectedEvents) {</span>
<a href="#l6.1250"></a><span id="l6.1250" class="difflineminus">-    if (gExpectedEvents[id].length &gt; 0) {</span>
<a href="#l6.1251"></a><span id="l6.1251" class="difflineminus">-      return undefined;</span>
<a href="#l6.1252"></a><span id="l6.1252" class="difflineminus">-    }</span>
<a href="#l6.1253"></a><span id="l6.1253" class="difflineminus">-  }</span>
<a href="#l6.1254"></a><span id="l6.1254" class="difflineminus">-</span>
<a href="#l6.1255"></a><span id="l6.1255" class="difflineminus">-  return gNext.apply(null, aArgs);</span>
<a href="#l6.1256"></a><span id="l6.1256" class="difflineminus">-}</span>
<a href="#l6.1257"></a><span id="l6.1257" class="difflineminus">-</span>
<a href="#l6.1258"></a><span id="l6.1258" class="difflineminus">-// Verifies that all the expected events for all add-ons were seen.</span>
<a href="#l6.1259"></a><span id="l6.1259" class="difflineminus">-function ensure_test_completed() {</span>
<a href="#l6.1260"></a><span id="l6.1260" class="difflineminus">-  for (let i in gExpectedEvents) {</span>
<a href="#l6.1261"></a><span id="l6.1261" class="difflineminus">-    if (gExpectedEvents[i].length &gt; 0) {</span>
<a href="#l6.1262"></a><span id="l6.1262" class="difflineminus">-      do_throw(</span>
<a href="#l6.1263"></a><span id="l6.1263" class="difflineminus">-        `Didn't see all the expected events for ${i}: Still expecting ${</span>
<a href="#l6.1264"></a><span id="l6.1264" class="difflineminus">-          gExpectedEvents[i]</span>
<a href="#l6.1265"></a><span id="l6.1265" class="difflineminus">-        }`</span>
<a href="#l6.1266"></a><span id="l6.1266" class="difflineminus">-      );</span>
<a href="#l6.1267"></a><span id="l6.1267" class="difflineminus">-    }</span>
<a href="#l6.1268"></a><span id="l6.1268" class="difflineminus">-  }</span>
<a href="#l6.1269"></a><span id="l6.1269" class="difflineminus">-  gExpectedEvents = {};</span>
<a href="#l6.1270"></a><span id="l6.1270" class="difflineminus">-  if (gExpectedInstalls) {</span>
<a href="#l6.1271"></a><span id="l6.1271" class="difflineminus">-    Assert.equal(gExpectedInstalls.length, 0);</span>
<a href="#l6.1272"></a><span id="l6.1272" class="difflineminus">-  }</span>
<a href="#l6.1273"></a><span id="l6.1273" class="difflineminus">-}</span>
<a href="#l6.1274"></a><span id="l6.1274" class="difflineminus">-</span>
<a href="#l6.1275"></a><span id="l6.1275" class="difflineminus">-/**</span>
<a href="#l6.1276"></a><span id="l6.1276" class="difflineminus">- * A helper method to install an array of AddonInstall to completion and then</span>
<a href="#l6.1277"></a><span id="l6.1277" class="difflineminus">- * call a provided callback.</span>
<a href="#l6.1278"></a><span id="l6.1278" class="difflineminus">- *</span>
<a href="#l6.1279"></a><span id="l6.1279" class="difflineminus">- * @param   aInstalls</span>
<a href="#l6.1280"></a><span id="l6.1280" class="difflineminus">- *          The array of AddonInstalls to install</span>
<a href="#l6.1281"></a><span id="l6.1281" class="difflineminus">- * @param   aCallback</span>
<a href="#l6.1282"></a><span id="l6.1282" class="difflineminus">- *          The callback to call when all installs have finished</span>
<a href="#l6.1283"></a><span id="l6.1283" class="difflineminus">- */</span>
<a href="#l6.1284"></a><span id="l6.1284" class="difflineminus">-function completeAllInstalls(aInstalls, aCallback) {</span>
<a href="#l6.1285"></a><span id="l6.1285" class="difflineminus">-  promiseCompleteAllInstalls(aInstalls).then(aCallback);</span>
<a href="#l6.1286"></a><span id="l6.1286" class="difflineminus">-}</span>
<a href="#l6.1287"></a><span id="l6.1287" class="difflineminus">-</span>
<a href="#l6.1288"></a><span id="l6.1288" class="difflineminus">-/**</span>
<a href="#l6.1289"></a><span id="l6.1289" class="difflineminus">- * A helper method to install an array of files and call a callback after the</span>
<a href="#l6.1290"></a><span id="l6.1290" class="difflineminus">- * installs are completed.</span>
<a href="#l6.1291"></a><span id="l6.1291" class="difflineminus">- *</span>
<a href="#l6.1292"></a><span id="l6.1292" class="difflineminus">- * @param   aFiles</span>
<a href="#l6.1293"></a><span id="l6.1293" class="difflineminus">- *          The array of files to install</span>
<a href="#l6.1294"></a><span id="l6.1294" class="difflineminus">- * @param   aCallback</span>
<a href="#l6.1295"></a><span id="l6.1295" class="difflineminus">- *          The callback to call when all installs have finished</span>
<a href="#l6.1296"></a><span id="l6.1296" class="difflineminus">- * @param   aIgnoreIncompatible</span>
<a href="#l6.1297"></a><span id="l6.1297" class="difflineminus">- *          Optional parameter to ignore add-ons that are incompatible in</span>
<a href="#l6.1298"></a><span id="l6.1298" class="difflineminus">- *          aome way with the application</span>
<a href="#l6.1299"></a><span id="l6.1299" class="difflineminus">- */</span>
<a href="#l6.1300"></a><span id="l6.1300" class="difflineminus">-function installAllFiles(aFiles, aCallback, aIgnoreIncompatible) {</span>
<a href="#l6.1301"></a><span id="l6.1301" class="difflineminus">-  promiseInstallAllFiles(aFiles, aIgnoreIncompatible).then(aCallback);</span>
<a href="#l6.1302"></a><span id="l6.1302" class="difflineminus">-}</span>
<a href="#l6.1303"></a><span id="l6.1303" class="difflineminus">-</span>
<a href="#l6.1304"></a><span id="l6.1304" class="difflineminus">-const EXTENSIONS_DB = &quot;extensions.json&quot;;</span>
<a href="#l6.1305"></a><span id="l6.1305" class="difflineminus">-var gExtensionsJSON = gProfD.clone();</span>
<a href="#l6.1306"></a><span id="l6.1306" class="difflineminus">-gExtensionsJSON.append(EXTENSIONS_DB);</span>
<a href="#l6.1307"></a><span id="l6.1307" class="difflineminus">-</span>
<a href="#l6.1308"></a><span id="l6.1308" class="difflineminus">-async function promiseInstallWebExtension(aData) {</span>
<a href="#l6.1309"></a><span id="l6.1309" class="difflineminus">-  let addonFile = createTempWebExtensionFile(aData);</span>
<a href="#l6.1310"></a><span id="l6.1310" class="difflineminus">-</span>
<a href="#l6.1311"></a><span id="l6.1311" class="difflineminus">-  let { addon } = await promiseInstallFile(addonFile);</span>
<a href="#l6.1312"></a><span id="l6.1312" class="difflineminus">-  return addon;</span>
<a href="#l6.1313"></a><span id="l6.1313" class="difflineminus">-}</span>
<a href="#l6.1314"></a><span id="l6.1314" class="difflineminus">-</span>
<a href="#l6.1315"></a><span id="l6.1315" class="difflineminus">-// By default use strict compatibility.</span>
<a href="#l6.1316"></a><span id="l6.1316" class="difflineminus">-Services.prefs.setBoolPref(&quot;extensions.strictCompatibility&quot;, true);</span>
<a href="#l6.1317"></a><span id="l6.1317" class="difflineminus">-</span>
<a href="#l6.1318"></a><span id="l6.1318" class="difflineminus">-// Ensure signature checks are enabled by default.</span>
<a href="#l6.1319"></a><span id="l6.1319" class="difflineminus">-Services.prefs.setBoolPref(PREF_XPI_SIGNATURES_REQUIRED, false);</span>
<a href="#l6.1320"></a><span id="l6.1320" class="difflineminus">-</span>
<a href="#l6.1321"></a><span id="l6.1321" class="difflineminus">-Services.prefs.setBoolPref(&quot;extensions.legacy.enabled&quot;, true);</span>
<a href="#l6.1322"></a><span id="l6.1322" class="difflineminus">-</span>
<a href="#l6.1323"></a><span id="l6.1323" class="difflineminus">-// Copies blocklistFile (an nsIFile) to gProfD/blocklist.xml.</span>
<a href="#l6.1324"></a><span id="l6.1324" class="difflineminus">-function copyBlocklistToProfile(blocklistFile) {</span>
<a href="#l6.1325"></a><span id="l6.1325" class="difflineminus">-  var dest = gProfD.clone();</span>
<a href="#l6.1326"></a><span id="l6.1326" class="difflineminus">-  dest.append(&quot;blocklist.xml&quot;);</span>
<a href="#l6.1327"></a><span id="l6.1327" class="difflineminus">-  if (dest.exists()) {</span>
<a href="#l6.1328"></a><span id="l6.1328" class="difflineminus">-    dest.remove(false);</span>
<a href="#l6.1329"></a><span id="l6.1329" class="difflineminus">-  }</span>
<a href="#l6.1330"></a><span id="l6.1330" class="difflineminus">-  blocklistFile.copyTo(gProfD, &quot;blocklist.xml&quot;);</span>
<a href="#l6.1331"></a><span id="l6.1331" class="difflineminus">-  dest.lastModifiedTime = Date.now();</span>
<a href="#l6.1332"></a><span id="l6.1332" class="difflineminus">-}</span>
<a href="#l6.1333"></a><span id="l6.1333" class="difflineminus">-</span>
<a href="#l6.1334"></a><span id="l6.1334" class="difflineminus">-// Make sure that a given path does not exist.</span>
<a href="#l6.1335"></a><span id="l6.1335" class="difflineminus">-function pathShouldntExist(file) {</span>
<a href="#l6.1336"></a><span id="l6.1336" class="difflineminus">-  if (file.exists()) {</span>
<a href="#l6.1337"></a><span id="l6.1337" class="difflineminus">-    do_throw(`Test cleanup: path ${file.path} exists when it should not`);</span>
<a href="#l6.1338"></a><span id="l6.1338" class="difflineminus">-  }</span>
<a href="#l6.1339"></a><span id="l6.1339" class="difflineminus">-}</span>
<a href="#l6.1340"></a><span id="l6.1340" class="difflineminus">-</span>
<a href="#l6.1341"></a><span id="l6.1341" class="difflineminus">-// Wrap a function (typically a callback) to catch and report exceptions.</span>
<a href="#l6.1342"></a><span id="l6.1342" class="difflineminus">-function do_exception_wrap(func) {</span>
<a href="#l6.1343"></a><span id="l6.1343" class="difflineminus">-  return function() {</span>
<a href="#l6.1344"></a><span id="l6.1344" class="difflineminus">-    try {</span>
<a href="#l6.1345"></a><span id="l6.1345" class="difflineminus">-      func.apply(null, arguments);</span>
<a href="#l6.1346"></a><span id="l6.1346" class="difflineminus">-    } catch (e) {</span>
<a href="#l6.1347"></a><span id="l6.1347" class="difflineminus">-      do_report_unexpected_exception(e);</span>
<a href="#l6.1348"></a><span id="l6.1348" class="difflineminus">-    }</span>
<a href="#l6.1349"></a><span id="l6.1349" class="difflineminus">-  };</span>
<a href="#l6.1350"></a><span id="l6.1350" class="difflineminus">-}</span>
<a href="#l6.1351"></a><span id="l6.1351" class="difflineminus">-</span>
<a href="#l6.1352"></a><span id="l6.1352" class="difflineminus">-/**</span>
<a href="#l6.1353"></a><span id="l6.1353" class="difflineminus">- * Change the schema version of the JSON extensions database.</span>
<a href="#l6.1354"></a><span id="l6.1354" class="difflineminus">- */</span>
<a href="#l6.1355"></a><span id="l6.1355" class="difflineminus">-async function changeXPIDBVersion(aNewVersion) {</span>
<a href="#l6.1356"></a><span id="l6.1356" class="difflineminus">-  let json = await loadJSON(gExtensionsJSON.path);</span>
<a href="#l6.1357"></a><span id="l6.1357" class="difflineminus">-  json.schemaVersion = aNewVersion;</span>
<a href="#l6.1358"></a><span id="l6.1358" class="difflineminus">-  await saveJSON(json, gExtensionsJSON.path);</span>
<a href="#l6.1359"></a><span id="l6.1359" class="difflineminus">-}</span>
<a href="#l6.1360"></a><span id="l6.1360" class="difflineminus">-</span>
<a href="#l6.1361"></a><span id="l6.1361" class="difflineminus">-/**</span>
<a href="#l6.1362"></a><span id="l6.1362" class="difflineminus">- * Load a file into a string.</span>
<a href="#l6.1363"></a><span id="l6.1363" class="difflineminus">- */</span>
<a href="#l6.1364"></a><span id="l6.1364" class="difflineminus">-async function loadFile(aFile) {</span>
<a href="#l6.1365"></a><span id="l6.1365" class="difflineminus">-  let buffer = await OS.File.read(aFile);</span>
<a href="#l6.1366"></a><span id="l6.1366" class="difflineminus">-  return new TextDecoder().decode(buffer);</span>
<a href="#l6.1367"></a><span id="l6.1367" class="difflineminus">-}</span>
<a href="#l6.1368"></a><span id="l6.1368" class="difflineminus">-</span>
<a href="#l6.1369"></a><span id="l6.1369" class="difflineminus">-/**</span>
<a href="#l6.1370"></a><span id="l6.1370" class="difflineminus">- * Raw load of a JSON file.</span>
<a href="#l6.1371"></a><span id="l6.1371" class="difflineminus">- */</span>
<a href="#l6.1372"></a><span id="l6.1372" class="difflineminus">-async function loadJSON(aFile) {</span>
<a href="#l6.1373"></a><span id="l6.1373" class="difflineminus">-  let data = await loadFile(aFile);</span>
<a href="#l6.1374"></a><span id="l6.1374" class="difflineminus">-  info(&quot;Loaded JSON file &quot; + aFile);</span>
<a href="#l6.1375"></a><span id="l6.1375" class="difflineminus">-  return JSON.parse(data);</span>
<a href="#l6.1376"></a><span id="l6.1376" class="difflineminus">-}</span>
<a href="#l6.1377"></a><span id="l6.1377" class="difflineminus">-</span>
<a href="#l6.1378"></a><span id="l6.1378" class="difflineminus">-/**</span>
<a href="#l6.1379"></a><span id="l6.1379" class="difflineminus">- * Raw save of a JSON blob to file.</span>
<a href="#l6.1380"></a><span id="l6.1380" class="difflineminus">- */</span>
<a href="#l6.1381"></a><span id="l6.1381" class="difflineminus">-async function saveJSON(aData, aFile) {</span>
<a href="#l6.1382"></a><span id="l6.1382" class="difflineminus">-  info(&quot;Starting to save JSON file &quot; + aFile);</span>
<a href="#l6.1383"></a><span id="l6.1383" class="difflineminus">-  await OS.File.writeAtomic(</span>
<a href="#l6.1384"></a><span id="l6.1384" class="difflineminus">-    aFile,</span>
<a href="#l6.1385"></a><span id="l6.1385" class="difflineminus">-    new TextEncoder().encode(JSON.stringify(aData, null, 2))</span>
<a href="#l6.1386"></a><span id="l6.1386" class="difflineminus">-  );</span>
<a href="#l6.1387"></a><span id="l6.1387" class="difflineminus">-  info(&quot;Done saving JSON file &quot; + aFile.path);</span>
<a href="#l6.1388"></a><span id="l6.1388" class="difflineminus">-}</span>
<a href="#l6.1389"></a><span id="l6.1389" class="difflineminus">-</span>
<a href="#l6.1390"></a><span id="l6.1390" class="difflineminus">-/**</span>
<a href="#l6.1391"></a><span id="l6.1391" class="difflineminus">- * Create a callback function that calls do_execute_soon on an actual callback and arguments.</span>
<a href="#l6.1392"></a><span id="l6.1392" class="difflineminus">- */</span>
<a href="#l6.1393"></a><span id="l6.1393" class="difflineminus">-function callback_soon(aFunction) {</span>
<a href="#l6.1394"></a><span id="l6.1394" class="difflineminus">-  return function(...args) {</span>
<a href="#l6.1395"></a><span id="l6.1395" class="difflineminus">-    executeSoon(</span>
<a href="#l6.1396"></a><span id="l6.1396" class="difflineminus">-      function() {</span>
<a href="#l6.1397"></a><span id="l6.1397" class="difflineminus">-        aFunction.apply(null, args);</span>
<a href="#l6.1398"></a><span id="l6.1398" class="difflineminus">-      },</span>
<a href="#l6.1399"></a><span id="l6.1399" class="difflineminus">-      aFunction.name ? &quot;delayed callback &quot; + aFunction.name : &quot;delayed callback&quot;</span>
<a href="#l6.1400"></a><span id="l6.1400" class="difflineminus">-    );</span>
<a href="#l6.1401"></a><span id="l6.1401" class="difflineminus">-  };</span>
<a href="#l6.1402"></a><span id="l6.1402" class="difflineminus">-}</span>
<a href="#l6.1403"></a><span id="l6.1403" class="difflineminus">-</span>
<a href="#l6.1404"></a><span id="l6.1404" class="difflineminus">-XPCOMUtils.defineLazyServiceGetter(</span>
<a href="#l6.1405"></a><span id="l6.1405" class="difflineminus">-  this,</span>
<a href="#l6.1406"></a><span id="l6.1406" class="difflineminus">-  &quot;pluginHost&quot;,</span>
<a href="#l6.1407"></a><span id="l6.1407" class="difflineminus">-  &quot;@mozilla.org/plugin/host;1&quot;,</span>
<a href="#l6.1408"></a><span id="l6.1408" class="difflineminus">-  &quot;nsIPluginHost&quot;</span>
<a href="#l6.1409"></a><span id="l6.1409" class="difflineminus">-);</span>
<a href="#l6.1410"></a><span id="l6.1410" class="difflineminus">-</span>
<a href="#l6.1411"></a><span id="l6.1411" class="difflineminus">-class MockPluginTag {</span>
<a href="#l6.1412"></a><span id="l6.1412" class="difflineminus">-  constructor(opts, enabledState = Ci.nsIPluginTag.STATE_ENABLED) {</span>
<a href="#l6.1413"></a><span id="l6.1413" class="difflineminus">-    this.pluginTag = pluginHost.createFakePlugin({</span>
<a href="#l6.1414"></a><span id="l6.1414" class="difflineminus">-      handlerURI: &quot;resource://fake-plugin/${Math.random()}.xhtml&quot;,</span>
<a href="#l6.1415"></a><span id="l6.1415" class="difflineminus">-      mimeEntries: [{ type: &quot;application/x-fake-plugin&quot; }],</span>
<a href="#l6.1416"></a><span id="l6.1416" class="difflineminus">-      fileName: `${opts.name}.so`,</span>
<a href="#l6.1417"></a><span id="l6.1417" class="difflineminus">-      ...opts,</span>
<a href="#l6.1418"></a><span id="l6.1418" class="difflineminus">-    });</span>
<a href="#l6.1419"></a><span id="l6.1419" class="difflineminus">-    this.pluginTag.enabledState = enabledState;</span>
<a href="#l6.1420"></a><span id="l6.1420" class="difflineminus">-</span>
<a href="#l6.1421"></a><span id="l6.1421" class="difflineminus">-    this.name = opts.name;</span>
<a href="#l6.1422"></a><span id="l6.1422" class="difflineminus">-    this.version = opts.version;</span>
<a href="#l6.1423"></a><span id="l6.1423" class="difflineminus">-  }</span>
<a href="#l6.1424"></a><span id="l6.1424" class="difflineminus">-  async isBlocklisted() {</span>
<a href="#l6.1425"></a><span id="l6.1425" class="difflineminus">-    let state = await Blocklist.getPluginBlocklistState(this.pluginTag);</span>
<a href="#l6.1426"></a><span id="l6.1426" class="difflineminus">-    return state == Services.blocklist.STATE_BLOCKED;</span>
<a href="#l6.1427"></a><span id="l6.1427" class="difflineminus">-  }</span>
<a href="#l6.1428"></a><span id="l6.1428" class="difflineminus">-  get disabled() {</span>
<a href="#l6.1429"></a><span id="l6.1429" class="difflineminus">-    return this.pluginTag.enabledState == Ci.nsIPluginTag.STATE_DISABLED;</span>
<a href="#l6.1430"></a><span id="l6.1430" class="difflineminus">-  }</span>
<a href="#l6.1431"></a><span id="l6.1431" class="difflineminus">-  set disabled(val) {</span>
<a href="#l6.1432"></a><span id="l6.1432" class="difflineminus">-    this.enabledState =</span>
<a href="#l6.1433"></a><span id="l6.1433" class="difflineminus">-      Ci.nsIPluginTag[val ? &quot;STATE_DISABLED&quot; : &quot;STATE_ENABLED&quot;];</span>
<a href="#l6.1434"></a><span id="l6.1434" class="difflineminus">-  }</span>
<a href="#l6.1435"></a><span id="l6.1435" class="difflineminus">-  get enabledState() {</span>
<a href="#l6.1436"></a><span id="l6.1436" class="difflineminus">-    return this.pluginTag.enabledState;</span>
<a href="#l6.1437"></a><span id="l6.1437" class="difflineminus">-  }</span>
<a href="#l6.1438"></a><span id="l6.1438" class="difflineminus">-  set enabledState(val) {</span>
<a href="#l6.1439"></a><span id="l6.1439" class="difflineminus">-    this.pluginTag.enabledState = val;</span>
<a href="#l6.1440"></a><span id="l6.1440" class="difflineminus">-  }</span>
<a href="#l6.1441"></a><span id="l6.1441" class="difflineminus">-}</span>
<a href="#l6.1442"></a><span id="l6.1442" class="difflineminus">-</span>
<a href="#l6.1443"></a><span id="l6.1443" class="difflineminus">-function mockPluginHost(plugins) {</span>
<a href="#l6.1444"></a><span id="l6.1444" class="difflineminus">-  let PluginHost = {</span>
<a href="#l6.1445"></a><span id="l6.1445" class="difflineminus">-    getPluginTags(count) {</span>
<a href="#l6.1446"></a><span id="l6.1446" class="difflineminus">-      count.value = plugins.length;</span>
<a href="#l6.1447"></a><span id="l6.1447" class="difflineminus">-      return plugins.map(p =&gt; p.pluginTag);</span>
<a href="#l6.1448"></a><span id="l6.1448" class="difflineminus">-    },</span>
<a href="#l6.1449"></a><span id="l6.1449" class="difflineminus">-</span>
<a href="#l6.1450"></a><span id="l6.1450" class="difflineminus">-    QueryInterface: ChromeUtils.generateQI([&quot;nsIPluginHost&quot;]),</span>
<a href="#l6.1451"></a><span id="l6.1451" class="difflineminus">-  };</span>
<a href="#l6.1452"></a><span id="l6.1452" class="difflineminus">-</span>
<a href="#l6.1453"></a><span id="l6.1453" class="difflineminus">-  MockRegistrar.register(&quot;@mozilla.org/plugin/host;1&quot;, PluginHost);</span>
<a href="#l6.1454"></a><span id="l6.1454" class="difflineminus">-}</span>
<a href="#l6.1455"></a><span id="l6.1455" class="difflineminus">-</span>
<a href="#l6.1456"></a><span id="l6.1456" class="difflineminus">-async function setInitialState(addon, initialState) {</span>
<a href="#l6.1457"></a><span id="l6.1457" class="difflineminus">-  if (initialState.userDisabled) {</span>
<a href="#l6.1458"></a><span id="l6.1458" class="difflineminus">-    await addon.disable();</span>
<a href="#l6.1459"></a><span id="l6.1459" class="difflineminus">-  } else if (initialState.userDisabled === false) {</span>
<a href="#l6.1460"></a><span id="l6.1460" class="difflineminus">-    await addon.enable();</span>
<a href="#l6.1461"></a><span id="l6.1461" class="difflineminus">-  }</span>
<a href="#l6.1462"></a><span id="l6.1462" class="difflineminus">-}</span>
<a href="#l6.1463"></a><span id="l6.1463" class="difflineminus">-</span>
<a href="#l6.1464"></a><span id="l6.1464" class="difflineminus">-/**</span>
<a href="#l6.1465"></a><span id="l6.1465" class="difflineminus">- * Escapes any occurrences of &amp;, &quot;, &lt; or &gt; with XML entities.</span>
<a href="#l6.1466"></a><span id="l6.1466" class="difflineminus">- *</span>
<a href="#l6.1467"></a><span id="l6.1467" class="difflineminus">- * @param {string} str</span>
<a href="#l6.1468"></a><span id="l6.1468" class="difflineminus">- *        The string to escape.</span>
<a href="#l6.1469"></a><span id="l6.1469" class="difflineminus">- * @returns {string} The escaped string.</span>
<a href="#l6.1470"></a><span id="l6.1470" class="difflineminus">- */</span>
<a href="#l6.1471"></a><span id="l6.1471" class="difflineminus">-function escapeXML(str) {</span>
<a href="#l6.1472"></a><span id="l6.1472" class="difflineminus">-  let replacements = {</span>
<a href="#l6.1473"></a><span id="l6.1473" class="difflineminus">-    &quot;&amp;&quot;: &quot;&amp;amp;&quot;,</span>
<a href="#l6.1474"></a><span id="l6.1474" class="difflineminus">-    '&quot;': &quot;&amp;quot;&quot;,</span>
<a href="#l6.1475"></a><span id="l6.1475" class="difflineminus">-    &quot;'&quot;: &quot;&amp;apos;&quot;,</span>
<a href="#l6.1476"></a><span id="l6.1476" class="difflineminus">-    &quot;&lt;&quot;: &quot;&amp;lt;&quot;,</span>
<a href="#l6.1477"></a><span id="l6.1477" class="difflineminus">-    &quot;&gt;&quot;: &quot;&amp;gt;&quot;,</span>
<a href="#l6.1478"></a><span id="l6.1478" class="difflineminus">-  };</span>
<a href="#l6.1479"></a><span id="l6.1479" class="difflineminus">-  return String(str).replace(/[&amp;&quot;''&lt;&gt;]/g, m =&gt; replacements[m]);</span>
<a href="#l6.1480"></a><span id="l6.1480" class="difflineminus">-}</span>
<a href="#l6.1481"></a><span id="l6.1481" class="difflineminus">-</span>
<a href="#l6.1482"></a><span id="l6.1482" class="difflineminus">-/**</span>
<a href="#l6.1483"></a><span id="l6.1483" class="difflineminus">- * A tagged template function which escapes any XML metacharacters in</span>
<a href="#l6.1484"></a><span id="l6.1484" class="difflineminus">- * interpolated values.</span>
<a href="#l6.1485"></a><span id="l6.1485" class="difflineminus">- *</span>
<a href="#l6.1486"></a><span id="l6.1486" class="difflineminus">- * @param {Array&lt;string&gt;} strings</span>
<a href="#l6.1487"></a><span id="l6.1487" class="difflineminus">- *        An array of literal strings extracted from the templates.</span>
<a href="#l6.1488"></a><span id="l6.1488" class="difflineminus">- * @param {Array} values</span>
<a href="#l6.1489"></a><span id="l6.1489" class="difflineminus">- *        An array of interpolated values extracted from the template.</span>
<a href="#l6.1490"></a><span id="l6.1490" class="difflineminus">- * @returns {string}</span>
<a href="#l6.1491"></a><span id="l6.1491" class="difflineminus">- *        The result of the escaped values interpolated with the literal</span>
<a href="#l6.1492"></a><span id="l6.1492" class="difflineminus">- *        strings.</span>
<a href="#l6.1493"></a><span id="l6.1493" class="difflineminus">- */</span>
<a href="#l6.1494"></a><span id="l6.1494" class="difflineminus">-function escaped(strings, ...values) {</span>
<a href="#l6.1495"></a><span id="l6.1495" class="difflineminus">-  let result = [];</span>
<a href="#l6.1496"></a><span id="l6.1496" class="difflineminus">-</span>
<a href="#l6.1497"></a><span id="l6.1497" class="difflineminus">-  for (let [i, string] of strings.entries()) {</span>
<a href="#l6.1498"></a><span id="l6.1498" class="difflineminus">-    result.push(string);</span>
<a href="#l6.1499"></a><span id="l6.1499" class="difflineminus">-    if (i &lt; values.length) {</span>
<a href="#l6.1500"></a><span id="l6.1500" class="difflineminus">-      result.push(escapeXML(values[i]));</span>
<a href="#l6.1501"></a><span id="l6.1501" class="difflineminus">-    }</span>
<a href="#l6.1502"></a><span id="l6.1502" class="difflineminus">-  }</span>
<a href="#l6.1503"></a><span id="l6.1503" class="difflineminus">-</span>
<a href="#l6.1504"></a><span id="l6.1504" class="difflineminus">-  return result.join(&quot;&quot;);</span>
<a href="#l6.1505"></a><span id="l6.1505" class="difflineminus">-}</span>
<a href="#l6.1506"></a><span id="l6.1506" class="difflineminus">-</span>
<a href="#l6.1507"></a><span id="l6.1507" class="difflineminus">-function _writeProps(obj, props, indent = &quot;  &quot;) {</span>
<a href="#l6.1508"></a><span id="l6.1508" class="difflineminus">-  let items = [];</span>
<a href="#l6.1509"></a><span id="l6.1509" class="difflineminus">-  for (let prop of props) {</span>
<a href="#l6.1510"></a><span id="l6.1510" class="difflineminus">-    if (obj[prop] !== undefined) {</span>
<a href="#l6.1511"></a><span id="l6.1511" class="difflineminus">-      items.push(escaped`${indent}&lt;em:${prop}&gt;${obj[prop]}&lt;/em:${prop}&gt;\n`);</span>
<a href="#l6.1512"></a><span id="l6.1512" class="difflineminus">-    }</span>
<a href="#l6.1513"></a><span id="l6.1513" class="difflineminus">-  }</span>
<a href="#l6.1514"></a><span id="l6.1514" class="difflineminus">-  return items.join(&quot;&quot;);</span>
<a href="#l6.1515"></a><span id="l6.1515" class="difflineminus">-}</span>
<a href="#l6.1516"></a><span id="l6.1516" class="difflineminus">-</span>
<a href="#l6.1517"></a><span id="l6.1517" class="difflineminus">-function _writeArrayProps(obj, props, indent = &quot;  &quot;) {</span>
<a href="#l6.1518"></a><span id="l6.1518" class="difflineminus">-  let items = [];</span>
<a href="#l6.1519"></a><span id="l6.1519" class="difflineminus">-  for (let prop of props) {</span>
<a href="#l6.1520"></a><span id="l6.1520" class="difflineminus">-    for (let val of obj[prop] || []) {</span>
<a href="#l6.1521"></a><span id="l6.1521" class="difflineminus">-      items.push(escaped`${indent}&lt;em:${prop}&gt;${val}&lt;/em:${prop}&gt;\n`);</span>
<a href="#l6.1522"></a><span id="l6.1522" class="difflineminus">-    }</span>
<a href="#l6.1523"></a><span id="l6.1523" class="difflineminus">-  }</span>
<a href="#l6.1524"></a><span id="l6.1524" class="difflineminus">-  return items.join(&quot;&quot;);</span>
<a href="#l6.1525"></a><span id="l6.1525" class="difflineminus">-}</span>
<a href="#l6.1526"></a><span id="l6.1526" class="difflineminus">-</span>
<a href="#l6.1527"></a><span id="l6.1527" class="difflineminus">-function _writeLocaleStrings(data) {</span>
<a href="#l6.1528"></a><span id="l6.1528" class="difflineminus">-  let items = [];</span>
<a href="#l6.1529"></a><span id="l6.1529" class="difflineminus">-</span>
<a href="#l6.1530"></a><span id="l6.1530" class="difflineminus">-  items.push(</span>
<a href="#l6.1531"></a><span id="l6.1531" class="difflineminus">-    this._writeProps(data, [&quot;name&quot;, &quot;description&quot;, &quot;creator&quot;, &quot;homepageURL&quot;])</span>
<a href="#l6.1532"></a><span id="l6.1532" class="difflineminus">-  );</span>
<a href="#l6.1533"></a><span id="l6.1533" class="difflineminus">-  items.push(</span>
<a href="#l6.1534"></a><span id="l6.1534" class="difflineminus">-    this._writeArrayProps(data, [&quot;developer&quot;, &quot;translator&quot;, &quot;contributor&quot;])</span>
<a href="#l6.1535"></a><span id="l6.1535" class="difflineminus">-  );</span>
<a href="#l6.1536"></a><span id="l6.1536" class="difflineminus">-</span>
<a href="#l6.1537"></a><span id="l6.1537" class="difflineminus">-  return items.join(&quot;&quot;);</span>
<a href="#l6.1538"></a><span id="l6.1538" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1">deleted file mode 100644</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineminus">--- a/common/test/xpcshell/test_bootstrap.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineplus">+++ /dev/null</span>
<a href="#l7.4"></a><span id="l7.4" class="difflineat">@@ -1,819 +0,0 @@</span>
<a href="#l7.5"></a><span id="l7.5" class="difflineminus">-/* Any copyright is dedicated to the Public Domain.</span>
<a href="#l7.6"></a><span id="l7.6" class="difflineminus">- * http://creativecommons.org/publicdomain/zero/1.0/</span>
<a href="#l7.7"></a><span id="l7.7" class="difflineminus">- */</span>
<a href="#l7.8"></a><span id="l7.8" class="difflineminus">-</span>
<a href="#l7.9"></a><span id="l7.9" class="difflineminus">-const APP_STARTUP = 1;</span>
<a href="#l7.10"></a><span id="l7.10" class="difflineminus">-const APP_SHUTDOWN = 2;</span>
<a href="#l7.11"></a><span id="l7.11" class="difflineminus">-const ADDON_ENABLE = 3;</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-const ADDON_DISABLE = 4;</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">-const ADDON_INSTALL = 5;</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineminus">-const ADDON_UNINSTALL = 6;</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineminus">-const ADDON_UPGRADE = 7;</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineminus">-const ADDON_DOWNGRADE = 8;</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineminus">-</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineminus">-const ID1 = &quot;bootstrap1@tests.mozilla.org&quot;;</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineminus">-const ID2 = &quot;bootstrap2@tests.mozilla.org&quot;;</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineminus">-</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineminus">-// This verifies that bootstrappable add-ons can be used without restarts.</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineminus">-var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineminus">-</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineminus">-// Enable loading extensions from the user scopes</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineminus">-Services.prefs.setIntPref(</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineminus">-  &quot;extensions.enabledScopes&quot;,</span>
<a href="#l7.27"></a><span id="l7.27" class="difflineminus">-  AddonManager.SCOPE_PROFILE + AddonManager.SCOPE_USER</span>
<a href="#l7.28"></a><span id="l7.28" class="difflineminus">-);</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineminus">-</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineminus">-// Make Cu.isInAutomation true.</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineminus">-Services.prefs.setBoolPref(</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineminus">-  &quot;security.turn_off_all_security_so_that_viruses_can_take_over_this_computer&quot;,</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineminus">-  true</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineminus">-);</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineminus">-Services.prefs.setIntPref(&quot;extensions.sideloadScopes&quot;, AddonManager.SCOPE_ALL);</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineminus">-</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineminus">-BootstrapMonitor.init();</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineminus">-</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineminus">-createAppInfo(&quot;xpcshell@tests.mozilla.org&quot;, &quot;XPCShell&quot;, &quot;1&quot;, &quot;1.9.2&quot;);</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineminus">-</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineminus">-const profileDir = gProfD.clone();</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineminus">-profileDir.append(&quot;extensions&quot;);</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineminus">-const userExtDir = gProfD.clone();</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineminus">-userExtDir.append(&quot;extensions2&quot;);</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineminus">-userExtDir.append(gAppInfo.ID);</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineminus">-registerDirectory(&quot;XREUSysExt&quot;, userExtDir.parent);</span>
<a href="#l7.47"></a><span id="l7.47" class="difflineminus">-</span>
<a href="#l7.48"></a><span id="l7.48" class="difflineminus">-const ADDONS = {</span>
<a href="#l7.49"></a><span id="l7.49" class="difflineminus">-  test_bootstrap1_1: {</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineminus">-    &quot;manifest.json&quot;: JSON.stringify({</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineminus">-      applications: {</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineminus">-        gecko: {</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineminus">-          id: &quot;bootstrap1@tests.mozilla.org&quot;,</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineminus">-        },</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineminus">-      },</span>
<a href="#l7.56"></a><span id="l7.56" class="difflineminus">-      legacy: {</span>
<a href="#l7.57"></a><span id="l7.57" class="difflineminus">-        type: &quot;bootstrap&quot;,</span>
<a href="#l7.58"></a><span id="l7.58" class="difflineminus">-      },</span>
<a href="#l7.59"></a><span id="l7.59" class="difflineminus">-      manifest_version: 2,</span>
<a href="#l7.60"></a><span id="l7.60" class="difflineminus">-</span>
<a href="#l7.61"></a><span id="l7.61" class="difflineminus">-      name: &quot;Test Bootstrap 1&quot;,</span>
<a href="#l7.62"></a><span id="l7.62" class="difflineminus">-      version: &quot;1.0&quot;,</span>
<a href="#l7.63"></a><span id="l7.63" class="difflineminus">-    }),</span>
<a href="#l7.64"></a><span id="l7.64" class="difflineminus">-    &quot;bootstrap.js&quot;: BOOTSTRAP_MONITOR_BOOTSTRAP_JS,</span>
<a href="#l7.65"></a><span id="l7.65" class="difflineminus">-  },</span>
<a href="#l7.66"></a><span id="l7.66" class="difflineminus">-  test_bootstrap1_2: {</span>
<a href="#l7.67"></a><span id="l7.67" class="difflineminus">-    &quot;manifest.json&quot;: JSON.stringify({</span>
<a href="#l7.68"></a><span id="l7.68" class="difflineminus">-      applications: {</span>
<a href="#l7.69"></a><span id="l7.69" class="difflineminus">-        gecko: {</span>
<a href="#l7.70"></a><span id="l7.70" class="difflineminus">-          id: &quot;bootstrap1@tests.mozilla.org&quot;,</span>
<a href="#l7.71"></a><span id="l7.71" class="difflineminus">-        },</span>
<a href="#l7.72"></a><span id="l7.72" class="difflineminus">-      },</span>
<a href="#l7.73"></a><span id="l7.73" class="difflineminus">-      legacy: {</span>
<a href="#l7.74"></a><span id="l7.74" class="difflineminus">-        type: &quot;bootstrap&quot;,</span>
<a href="#l7.75"></a><span id="l7.75" class="difflineminus">-      },</span>
<a href="#l7.76"></a><span id="l7.76" class="difflineminus">-      manifest_version: 2,</span>
<a href="#l7.77"></a><span id="l7.77" class="difflineminus">-      version: &quot;2.0&quot;,</span>
<a href="#l7.78"></a><span id="l7.78" class="difflineminus">-</span>
<a href="#l7.79"></a><span id="l7.79" class="difflineminus">-      name: &quot;Test Bootstrap 1&quot;,</span>
<a href="#l7.80"></a><span id="l7.80" class="difflineminus">-    }),</span>
<a href="#l7.81"></a><span id="l7.81" class="difflineminus">-    &quot;bootstrap.js&quot;: BOOTSTRAP_MONITOR_BOOTSTRAP_JS,</span>
<a href="#l7.82"></a><span id="l7.82" class="difflineminus">-  },</span>
<a href="#l7.83"></a><span id="l7.83" class="difflineminus">-  test_bootstrap1_3: {</span>
<a href="#l7.84"></a><span id="l7.84" class="difflineminus">-    &quot;manifest.json&quot;: JSON.stringify({</span>
<a href="#l7.85"></a><span id="l7.85" class="difflineminus">-      applications: {</span>
<a href="#l7.86"></a><span id="l7.86" class="difflineminus">-        gecko: {</span>
<a href="#l7.87"></a><span id="l7.87" class="difflineminus">-          id: &quot;bootstrap1@tests.mozilla.org&quot;,</span>
<a href="#l7.88"></a><span id="l7.88" class="difflineminus">-        },</span>
<a href="#l7.89"></a><span id="l7.89" class="difflineminus">-      },</span>
<a href="#l7.90"></a><span id="l7.90" class="difflineminus">-      legacy: {</span>
<a href="#l7.91"></a><span id="l7.91" class="difflineminus">-        type: &quot;bootstrap&quot;,</span>
<a href="#l7.92"></a><span id="l7.92" class="difflineminus">-      },</span>
<a href="#l7.93"></a><span id="l7.93" class="difflineminus">-      manifest_version: 2,</span>
<a href="#l7.94"></a><span id="l7.94" class="difflineminus">-      version: &quot;3.0&quot;,</span>
<a href="#l7.95"></a><span id="l7.95" class="difflineminus">-</span>
<a href="#l7.96"></a><span id="l7.96" class="difflineminus">-      name: &quot;Test Bootstrap 1&quot;,</span>
<a href="#l7.97"></a><span id="l7.97" class="difflineminus">-</span>
<a href="#l7.98"></a><span id="l7.98" class="difflineminus">-      targetApplications: [</span>
<a href="#l7.99"></a><span id="l7.99" class="difflineminus">-        {</span>
<a href="#l7.100"></a><span id="l7.100" class="difflineminus">-          applications: {</span>
<a href="#l7.101"></a><span id="l7.101" class="difflineminus">-            gecko: {</span>
<a href="#l7.102"></a><span id="l7.102" class="difflineminus">-              id: &quot;undefined&quot;,</span>
<a href="#l7.103"></a><span id="l7.103" class="difflineminus">-            },</span>
<a href="#l7.104"></a><span id="l7.104" class="difflineminus">-          },</span>
<a href="#l7.105"></a><span id="l7.105" class="difflineminus">-          legacy: {</span>
<a href="#l7.106"></a><span id="l7.106" class="difflineminus">-            type: &quot;bootstrap&quot;,</span>
<a href="#l7.107"></a><span id="l7.107" class="difflineminus">-          },</span>
<a href="#l7.108"></a><span id="l7.108" class="difflineminus">-          manifest_version: 2,</span>
<a href="#l7.109"></a><span id="l7.109" class="difflineminus">-          minVersion: &quot;1&quot;,</span>
<a href="#l7.110"></a><span id="l7.110" class="difflineminus">-          maxVersion: &quot;1&quot;,</span>
<a href="#l7.111"></a><span id="l7.111" class="difflineminus">-        },</span>
<a href="#l7.112"></a><span id="l7.112" class="difflineminus">-      ],</span>
<a href="#l7.113"></a><span id="l7.113" class="difflineminus">-    }),</span>
<a href="#l7.114"></a><span id="l7.114" class="difflineminus">-    &quot;bootstrap.js&quot;: BOOTSTRAP_MONITOR_BOOTSTRAP_JS,</span>
<a href="#l7.115"></a><span id="l7.115" class="difflineminus">-  },</span>
<a href="#l7.116"></a><span id="l7.116" class="difflineminus">-  test_bootstrap2_1: {</span>
<a href="#l7.117"></a><span id="l7.117" class="difflineminus">-    &quot;manifest.json&quot;: JSON.stringify({</span>
<a href="#l7.118"></a><span id="l7.118" class="difflineminus">-      applications: {</span>
<a href="#l7.119"></a><span id="l7.119" class="difflineminus">-        gecko: {</span>
<a href="#l7.120"></a><span id="l7.120" class="difflineminus">-          id: &quot;bootstrap2@tests.mozilla.org&quot;,</span>
<a href="#l7.121"></a><span id="l7.121" class="difflineminus">-        },</span>
<a href="#l7.122"></a><span id="l7.122" class="difflineminus">-      },</span>
<a href="#l7.123"></a><span id="l7.123" class="difflineminus">-      legacy: {</span>
<a href="#l7.124"></a><span id="l7.124" class="difflineminus">-        type: &quot;bootstrap&quot;,</span>
<a href="#l7.125"></a><span id="l7.125" class="difflineminus">-      },</span>
<a href="#l7.126"></a><span id="l7.126" class="difflineminus">-      manifest_version: 2,</span>
<a href="#l7.127"></a><span id="l7.127" class="difflineminus">-    }),</span>
<a href="#l7.128"></a><span id="l7.128" class="difflineminus">-    &quot;bootstrap.js&quot;: BOOTSTRAP_MONITOR_BOOTSTRAP_JS,</span>
<a href="#l7.129"></a><span id="l7.129" class="difflineminus">-  },</span>
<a href="#l7.130"></a><span id="l7.130" class="difflineminus">-};</span>
<a href="#l7.131"></a><span id="l7.131" class="difflineminus">-</span>
<a href="#l7.132"></a><span id="l7.132" class="difflineminus">-var startupCacheMonitor = {</span>
<a href="#l7.133"></a><span id="l7.133" class="difflineminus">-  notificationFired: false,</span>
<a href="#l7.134"></a><span id="l7.134" class="difflineminus">-  observe() {</span>
<a href="#l7.135"></a><span id="l7.135" class="difflineminus">-    this.notificationFired = true;</span>
<a href="#l7.136"></a><span id="l7.136" class="difflineminus">-  },</span>
<a href="#l7.137"></a><span id="l7.137" class="difflineminus">-  // Checks that the notification has been fired since the last time this was called.</span>
<a href="#l7.138"></a><span id="l7.138" class="difflineminus">-  check(expected) {</span>
<a href="#l7.139"></a><span id="l7.139" class="difflineminus">-    equal(this.notificationFired, expected);</span>
<a href="#l7.140"></a><span id="l7.140" class="difflineminus">-    this.notificationFired = false;</span>
<a href="#l7.141"></a><span id="l7.141" class="difflineminus">-  },</span>
<a href="#l7.142"></a><span id="l7.142" class="difflineminus">-};</span>
<a href="#l7.143"></a><span id="l7.143" class="difflineminus">-Services.obs.addObserver(startupCacheMonitor, &quot;startupcache-invalidate&quot;);</span>
<a href="#l7.144"></a><span id="l7.144" class="difflineminus">-</span>
<a href="#l7.145"></a><span id="l7.145" class="difflineminus">-var testserver = AddonTestUtils.createHttpServer({ hosts: [&quot;example.com&quot;] });</span>
<a href="#l7.146"></a><span id="l7.146" class="difflineminus">-</span>
<a href="#l7.147"></a><span id="l7.147" class="difflineminus">-const XPIS = {};</span>
<a href="#l7.148"></a><span id="l7.148" class="difflineminus">-for (let [name, addon] of Object.entries(ADDONS)) {</span>
<a href="#l7.149"></a><span id="l7.149" class="difflineminus">-  XPIS[name] = AddonTestUtils.createTempXPIFile(addon);</span>
<a href="#l7.150"></a><span id="l7.150" class="difflineminus">-  testserver.registerFile(`/addons/${name}.xpi`, XPIS[name]);</span>
<a href="#l7.151"></a><span id="l7.151" class="difflineminus">-}</span>
<a href="#l7.152"></a><span id="l7.152" class="difflineminus">-</span>
<a href="#l7.153"></a><span id="l7.153" class="difflineminus">-function getStartupReason() {</span>
<a href="#l7.154"></a><span id="l7.154" class="difflineminus">-  let info = BootstrapMonitor.started.get(ID1);</span>
<a href="#l7.155"></a><span id="l7.155" class="difflineminus">-  return info ? info.reason : undefined;</span>
<a href="#l7.156"></a><span id="l7.156" class="difflineminus">-}</span>
<a href="#l7.157"></a><span id="l7.157" class="difflineminus">-</span>
<a href="#l7.158"></a><span id="l7.158" class="difflineminus">-function getShutdownReason() {</span>
<a href="#l7.159"></a><span id="l7.159" class="difflineminus">-  let info = BootstrapMonitor.stopped.get(ID1);</span>
<a href="#l7.160"></a><span id="l7.160" class="difflineminus">-  return info ? info.reason : undefined;</span>
<a href="#l7.161"></a><span id="l7.161" class="difflineminus">-}</span>
<a href="#l7.162"></a><span id="l7.162" class="difflineminus">-</span>
<a href="#l7.163"></a><span id="l7.163" class="difflineminus">-function getInstallReason() {</span>
<a href="#l7.164"></a><span id="l7.164" class="difflineminus">-  let info = BootstrapMonitor.installed.get(ID1);</span>
<a href="#l7.165"></a><span id="l7.165" class="difflineminus">-  return info ? info.reason : undefined;</span>
<a href="#l7.166"></a><span id="l7.166" class="difflineminus">-}</span>
<a href="#l7.167"></a><span id="l7.167" class="difflineminus">-</span>
<a href="#l7.168"></a><span id="l7.168" class="difflineminus">-function getUninstallReason() {</span>
<a href="#l7.169"></a><span id="l7.169" class="difflineminus">-  let info = BootstrapMonitor.uninstalled.get(ID1);</span>
<a href="#l7.170"></a><span id="l7.170" class="difflineminus">-  return info ? info.reason : undefined;</span>
<a href="#l7.171"></a><span id="l7.171" class="difflineminus">-}</span>
<a href="#l7.172"></a><span id="l7.172" class="difflineminus">-</span>
<a href="#l7.173"></a><span id="l7.173" class="difflineminus">-function getStartupOldVersion() {</span>
<a href="#l7.174"></a><span id="l7.174" class="difflineminus">-  let info = BootstrapMonitor.started.get(ID1);</span>
<a href="#l7.175"></a><span id="l7.175" class="difflineminus">-  return info ? info.data.oldVersion : undefined;</span>
<a href="#l7.176"></a><span id="l7.176" class="difflineminus">-}</span>
<a href="#l7.177"></a><span id="l7.177" class="difflineminus">-</span>
<a href="#l7.178"></a><span id="l7.178" class="difflineminus">-function getShutdownNewVersion() {</span>
<a href="#l7.179"></a><span id="l7.179" class="difflineminus">-  let info = BootstrapMonitor.stopped.get(ID1);</span>
<a href="#l7.180"></a><span id="l7.180" class="difflineminus">-  return info ? info.data.newVersion : undefined;</span>
<a href="#l7.181"></a><span id="l7.181" class="difflineminus">-}</span>
<a href="#l7.182"></a><span id="l7.182" class="difflineminus">-</span>
<a href="#l7.183"></a><span id="l7.183" class="difflineminus">-function getInstallOldVersion() {</span>
<a href="#l7.184"></a><span id="l7.184" class="difflineminus">-  let info = BootstrapMonitor.installed.get(ID1);</span>
<a href="#l7.185"></a><span id="l7.185" class="difflineminus">-  return info ? info.data.oldVersion : undefined;</span>
<a href="#l7.186"></a><span id="l7.186" class="difflineminus">-}</span>
<a href="#l7.187"></a><span id="l7.187" class="difflineminus">-</span>
<a href="#l7.188"></a><span id="l7.188" class="difflineminus">-function getUninstallNewVersion() {</span>
<a href="#l7.189"></a><span id="l7.189" class="difflineminus">-  let info = BootstrapMonitor.uninstalled.get(ID1);</span>
<a href="#l7.190"></a><span id="l7.190" class="difflineminus">-  return info ? info.data.newVersion : undefined;</span>
<a href="#l7.191"></a><span id="l7.191" class="difflineminus">-}</span>
<a href="#l7.192"></a><span id="l7.192" class="difflineminus">-</span>
<a href="#l7.193"></a><span id="l7.193" class="difflineminus">-async function checkBootstrappedPref() {</span>
<a href="#l7.194"></a><span id="l7.194" class="difflineminus">-  let { XPIInternal } = ChromeUtils.import(</span>
<a href="#l7.195"></a><span id="l7.195" class="difflineminus">-    &quot;resource://gre/modules/addons/XPIProvider.jsm&quot;</span>
<a href="#l7.196"></a><span id="l7.196" class="difflineminus">-  );</span>
<a href="#l7.197"></a><span id="l7.197" class="difflineminus">-</span>
<a href="#l7.198"></a><span id="l7.198" class="difflineminus">-  let data = new Map();</span>
<a href="#l7.199"></a><span id="l7.199" class="difflineminus">-  for (let entry of XPIInternal.XPIStates.enabledAddons()) {</span>
<a href="#l7.200"></a><span id="l7.200" class="difflineminus">-    data.set(entry.id, entry);</span>
<a href="#l7.201"></a><span id="l7.201" class="difflineminus">-  }</span>
<a href="#l7.202"></a><span id="l7.202" class="difflineminus">-</span>
<a href="#l7.203"></a><span id="l7.203" class="difflineminus">-  let addons = await AddonManager.getAddonsByTypes([&quot;extension&quot;]);</span>
<a href="#l7.204"></a><span id="l7.204" class="difflineminus">-  for (let addon of addons) {</span>
<a href="#l7.205"></a><span id="l7.205" class="difflineminus">-    if (!addon.id.endsWith(&quot;@tests.mozilla.org&quot;)) {</span>
<a href="#l7.206"></a><span id="l7.206" class="difflineminus">-      continue;</span>
<a href="#l7.207"></a><span id="l7.207" class="difflineminus">-    }</span>
<a href="#l7.208"></a><span id="l7.208" class="difflineminus">-    if (!addon.isActive) {</span>
<a href="#l7.209"></a><span id="l7.209" class="difflineminus">-      continue;</span>
<a href="#l7.210"></a><span id="l7.210" class="difflineminus">-    }</span>
<a href="#l7.211"></a><span id="l7.211" class="difflineminus">-    if (</span>
<a href="#l7.212"></a><span id="l7.212" class="difflineminus">-      addon.operationsRequiringRestart != AddonManager.OP_NEEDS_RESTART_NONE</span>
<a href="#l7.213"></a><span id="l7.213" class="difflineminus">-    ) {</span>
<a href="#l7.214"></a><span id="l7.214" class="difflineminus">-      continue;</span>
<a href="#l7.215"></a><span id="l7.215" class="difflineminus">-    }</span>
<a href="#l7.216"></a><span id="l7.216" class="difflineminus">-</span>
<a href="#l7.217"></a><span id="l7.217" class="difflineminus">-    ok(data.has(addon.id));</span>
<a href="#l7.218"></a><span id="l7.218" class="difflineminus">-    let addonData = data.get(addon.id);</span>
<a href="#l7.219"></a><span id="l7.219" class="difflineminus">-    data.delete(addon.id);</span>
<a href="#l7.220"></a><span id="l7.220" class="difflineminus">-</span>
<a href="#l7.221"></a><span id="l7.221" class="difflineminus">-    equal(addonData.version, addon.version);</span>
<a href="#l7.222"></a><span id="l7.222" class="difflineminus">-    equal(addonData.type, addon.type);</span>
<a href="#l7.223"></a><span id="l7.223" class="difflineminus">-</span>
<a href="#l7.224"></a><span id="l7.224" class="difflineminus">-    let resourceURI = addon.getResourceURI();</span>
<a href="#l7.225"></a><span id="l7.225" class="difflineminus">-    if (resourceURI instanceof Ci.nsIJARURI) {</span>
<a href="#l7.226"></a><span id="l7.226" class="difflineminus">-      resourceURI = resourceURI.JARFile;</span>
<a href="#l7.227"></a><span id="l7.227" class="difflineminus">-    }</span>
<a href="#l7.228"></a><span id="l7.228" class="difflineminus">-    let file = resourceURI.QueryInterface(Ci.nsIFileURL).file;</span>
<a href="#l7.229"></a><span id="l7.229" class="difflineminus">-    equal(addonData.path, file.path);</span>
<a href="#l7.230"></a><span id="l7.230" class="difflineminus">-  }</span>
<a href="#l7.231"></a><span id="l7.231" class="difflineminus">-  equal(data.size, 0);</span>
<a href="#l7.232"></a><span id="l7.232" class="difflineminus">-}</span>
<a href="#l7.233"></a><span id="l7.233" class="difflineminus">-</span>
<a href="#l7.234"></a><span id="l7.234" class="difflineminus">-add_task(async function run_test() {</span>
<a href="#l7.235"></a><span id="l7.235" class="difflineminus">-  promiseStartupManager();</span>
<a href="#l7.236"></a><span id="l7.236" class="difflineminus">-</span>
<a href="#l7.237"></a><span id="l7.237" class="difflineminus">-  ok(!gExtensionsJSON.exists());</span>
<a href="#l7.238"></a><span id="l7.238" class="difflineminus">-  ok(!gAddonStartup.exists());</span>
<a href="#l7.239"></a><span id="l7.239" class="difflineminus">-});</span>
<a href="#l7.240"></a><span id="l7.240" class="difflineminus">-</span>
<a href="#l7.241"></a><span id="l7.241" class="difflineminus">-// Tests that installing doesn't require a restart</span>
<a href="#l7.242"></a><span id="l7.242" class="difflineminus">-add_task(async function test_1() {</span>
<a href="#l7.243"></a><span id="l7.243" class="difflineminus">-  prepare_test({}, [&quot;onNewInstall&quot;]);</span>
<a href="#l7.244"></a><span id="l7.244" class="difflineminus">-</span>
<a href="#l7.245"></a><span id="l7.245" class="difflineminus">-  let install = await AddonManager.getInstallForFile(XPIS.test_bootstrap1_1);</span>
<a href="#l7.246"></a><span id="l7.246" class="difflineminus">-  ensure_test_completed();</span>
<a href="#l7.247"></a><span id="l7.247" class="difflineminus">-</span>
<a href="#l7.248"></a><span id="l7.248" class="difflineminus">-  notEqual(install, null);</span>
<a href="#l7.249"></a><span id="l7.249" class="difflineminus">-  equal(install.type, &quot;extension&quot;);</span>
<a href="#l7.250"></a><span id="l7.250" class="difflineminus">-  equal(install.version, &quot;1.0&quot;);</span>
<a href="#l7.251"></a><span id="l7.251" class="difflineminus">-  equal(install.name, &quot;Test Bootstrap 1&quot;);</span>
<a href="#l7.252"></a><span id="l7.252" class="difflineminus">-  equal(install.state, AddonManager.STATE_DOWNLOADED);</span>
<a href="#l7.253"></a><span id="l7.253" class="difflineminus">-  notEqual(install.addon.syncGUID, null);</span>
<a href="#l7.254"></a><span id="l7.254" class="difflineminus">-  equal(</span>
<a href="#l7.255"></a><span id="l7.255" class="difflineminus">-    install.addon.operationsRequiringRestart &amp;</span>
<a href="#l7.256"></a><span id="l7.256" class="difflineminus">-      AddonManager.OP_NEEDS_RESTART_INSTALL,</span>
<a href="#l7.257"></a><span id="l7.257" class="difflineminus">-    0</span>
<a href="#l7.258"></a><span id="l7.258" class="difflineminus">-  );</span>
<a href="#l7.259"></a><span id="l7.259" class="difflineminus">-  do_check_not_in_crash_annotation(ID1, &quot;1.0&quot;);</span>
<a href="#l7.260"></a><span id="l7.260" class="difflineminus">-</span>
<a href="#l7.261"></a><span id="l7.261" class="difflineminus">-  let addon = install.addon;</span>
<a href="#l7.262"></a><span id="l7.262" class="difflineminus">-</span>
<a href="#l7.263"></a><span id="l7.263" class="difflineminus">-  await Promise.all([</span>
<a href="#l7.264"></a><span id="l7.264" class="difflineminus">-    BootstrapMonitor.promiseAddonStartup(ID1),</span>
<a href="#l7.265"></a><span id="l7.265" class="difflineminus">-    new Promise(resolve =&gt; {</span>
<a href="#l7.266"></a><span id="l7.266" class="difflineminus">-      prepare_test(</span>
<a href="#l7.267"></a><span id="l7.267" class="difflineminus">-        {</span>
<a href="#l7.268"></a><span id="l7.268" class="difflineminus">-          [ID1]: [[&quot;onInstalling&quot;, false], &quot;onInstalled&quot;],</span>
<a href="#l7.269"></a><span id="l7.269" class="difflineminus">-        },</span>
<a href="#l7.270"></a><span id="l7.270" class="difflineminus">-        [&quot;onInstallStarted&quot;, &quot;onInstallEnded&quot;],</span>
<a href="#l7.271"></a><span id="l7.271" class="difflineminus">-        function() {</span>
<a href="#l7.272"></a><span id="l7.272" class="difflineminus">-          // startup should not have been called yet.</span>
<a href="#l7.273"></a><span id="l7.273" class="difflineminus">-          BootstrapMonitor.checkAddonNotStarted(ID1);</span>
<a href="#l7.274"></a><span id="l7.274" class="difflineminus">-          resolve();</span>
<a href="#l7.275"></a><span id="l7.275" class="difflineminus">-        }</span>
<a href="#l7.276"></a><span id="l7.276" class="difflineminus">-      );</span>
<a href="#l7.277"></a><span id="l7.277" class="difflineminus">-      install.install();</span>
<a href="#l7.278"></a><span id="l7.278" class="difflineminus">-    }),</span>
<a href="#l7.279"></a><span id="l7.279" class="difflineminus">-  ]);</span>
<a href="#l7.280"></a><span id="l7.280" class="difflineminus">-</span>
<a href="#l7.281"></a><span id="l7.281" class="difflineminus">-  await checkBootstrappedPref();</span>
<a href="#l7.282"></a><span id="l7.282" class="difflineminus">-  let installSyncGUID = addon.syncGUID;</span>
<a href="#l7.283"></a><span id="l7.283" class="difflineminus">-</span>
<a href="#l7.284"></a><span id="l7.284" class="difflineminus">-  let installs = await AddonManager.getAllInstalls();</span>
<a href="#l7.285"></a><span id="l7.285" class="difflineminus">-  // There should be no active installs now since the install completed and</span>
<a href="#l7.286"></a><span id="l7.286" class="difflineminus">-  // doesn't require a restart.</span>
<a href="#l7.287"></a><span id="l7.287" class="difflineminus">-  equal(installs.length, 0);</span>
<a href="#l7.288"></a><span id="l7.288" class="difflineminus">-</span>
<a href="#l7.289"></a><span id="l7.289" class="difflineminus">-  let b1 = await AddonManager.getAddonByID(ID1);</span>
<a href="#l7.290"></a><span id="l7.290" class="difflineminus">-  notEqual(b1, null);</span>
<a href="#l7.291"></a><span id="l7.291" class="difflineminus">-  equal(b1.version, &quot;1.0&quot;);</span>
<a href="#l7.292"></a><span id="l7.292" class="difflineminus">-  notEqual(b1.syncGUID, null);</span>
<a href="#l7.293"></a><span id="l7.293" class="difflineminus">-  equal(b1.syncGUID, installSyncGUID);</span>
<a href="#l7.294"></a><span id="l7.294" class="difflineminus">-  ok(!b1.appDisabled);</span>
<a href="#l7.295"></a><span id="l7.295" class="difflineminus">-  ok(!b1.userDisabled);</span>
<a href="#l7.296"></a><span id="l7.296" class="difflineminus">-  ok(b1.isActive);</span>
<a href="#l7.297"></a><span id="l7.297" class="difflineminus">-  ok(!b1.isSystem);</span>
<a href="#l7.298"></a><span id="l7.298" class="difflineminus">-  BootstrapMonitor.checkAddonInstalled(ID1, &quot;1.0&quot;);</span>
<a href="#l7.299"></a><span id="l7.299" class="difflineminus">-  BootstrapMonitor.checkAddonStarted(ID1, &quot;1.0&quot;);</span>
<a href="#l7.300"></a><span id="l7.300" class="difflineminus">-  equal(getStartupReason(), ADDON_INSTALL);</span>
<a href="#l7.301"></a><span id="l7.301" class="difflineminus">-  equal(getStartupOldVersion(), undefined);</span>
<a href="#l7.302"></a><span id="l7.302" class="difflineminus">-  do_check_in_crash_annotation(ID1, &quot;1.0&quot;);</span>
<a href="#l7.303"></a><span id="l7.303" class="difflineminus">-</span>
<a href="#l7.304"></a><span id="l7.304" class="difflineminus">-  let dir = do_get_addon_root_uri(profileDir, ID1);</span>
<a href="#l7.305"></a><span id="l7.305" class="difflineminus">-  equal(b1.getResourceURI(&quot;bootstrap.js&quot;).spec, dir + &quot;bootstrap.js&quot;);</span>
<a href="#l7.306"></a><span id="l7.306" class="difflineminus">-</span>
<a href="#l7.307"></a><span id="l7.307" class="difflineminus">-  startupCacheMonitor.check(false);</span>
<a href="#l7.308"></a><span id="l7.308" class="difflineminus">-});</span>
<a href="#l7.309"></a><span id="l7.309" class="difflineminus">-</span>
<a href="#l7.310"></a><span id="l7.310" class="difflineminus">-// Tests that disabling doesn't require a restart</span>
<a href="#l7.311"></a><span id="l7.311" class="difflineminus">-add_task(async function test_2() {</span>
<a href="#l7.312"></a><span id="l7.312" class="difflineminus">-  let b1 = await AddonManager.getAddonByID(ID1);</span>
<a href="#l7.313"></a><span id="l7.313" class="difflineminus">-  prepare_test({</span>
<a href="#l7.314"></a><span id="l7.314" class="difflineminus">-    [ID1]: [[&quot;onDisabling&quot;, false], &quot;onDisabled&quot;],</span>
<a href="#l7.315"></a><span id="l7.315" class="difflineminus">-  });</span>
<a href="#l7.316"></a><span id="l7.316" class="difflineminus">-</span>
<a href="#l7.317"></a><span id="l7.317" class="difflineminus">-  equal(</span>
<a href="#l7.318"></a><span id="l7.318" class="difflineminus">-    b1.operationsRequiringRestart &amp; AddonManager.OP_NEEDS_RESTART_DISABLE,</span>
<a href="#l7.319"></a><span id="l7.319" class="difflineminus">-    0</span>
<a href="#l7.320"></a><span id="l7.320" class="difflineminus">-  );</span>
<a href="#l7.321"></a><span id="l7.321" class="difflineminus">-  await b1.disable();</span>
<a href="#l7.322"></a><span id="l7.322" class="difflineminus">-  ensure_test_completed();</span>
<a href="#l7.323"></a><span id="l7.323" class="difflineminus">-</span>
<a href="#l7.324"></a><span id="l7.324" class="difflineminus">-  await new Promise(executeSoon);</span>
<a href="#l7.325"></a><span id="l7.325" class="difflineminus">-</span>
<a href="#l7.326"></a><span id="l7.326" class="difflineminus">-  notEqual(b1, null);</span>
<a href="#l7.327"></a><span id="l7.327" class="difflineminus">-  equal(b1.version, &quot;1.0&quot;);</span>
<a href="#l7.328"></a><span id="l7.328" class="difflineminus">-  ok(!b1.appDisabled);</span>
<a href="#l7.329"></a><span id="l7.329" class="difflineminus">-  ok(b1.userDisabled);</span>
<a href="#l7.330"></a><span id="l7.330" class="difflineminus">-  ok(!b1.isActive);</span>
<a href="#l7.331"></a><span id="l7.331" class="difflineminus">-  BootstrapMonitor.checkAddonInstalled(ID1, &quot;1.0&quot;);</span>
<a href="#l7.332"></a><span id="l7.332" class="difflineminus">-  BootstrapMonitor.checkAddonNotStarted(ID1);</span>
<a href="#l7.333"></a><span id="l7.333" class="difflineminus">-  equal(getShutdownReason(), ADDON_DISABLE);</span>
<a href="#l7.334"></a><span id="l7.334" class="difflineminus">-  equal(getShutdownNewVersion(), undefined);</span>
<a href="#l7.335"></a><span id="l7.335" class="difflineminus">-  do_check_not_in_crash_annotation(ID1, &quot;1.0&quot;);</span>
<a href="#l7.336"></a><span id="l7.336" class="difflineminus">-</span>
<a href="#l7.337"></a><span id="l7.337" class="difflineminus">-  let newb1 = await AddonManager.getAddonByID(ID1);</span>
<a href="#l7.338"></a><span id="l7.338" class="difflineminus">-  notEqual(newb1, null);</span>
<a href="#l7.339"></a><span id="l7.339" class="difflineminus">-  equal(newb1.version, &quot;1.0&quot;);</span>
<a href="#l7.340"></a><span id="l7.340" class="difflineminus">-  ok(!newb1.appDisabled);</span>
<a href="#l7.341"></a><span id="l7.341" class="difflineminus">-  ok(newb1.userDisabled);</span>
<a href="#l7.342"></a><span id="l7.342" class="difflineminus">-  ok(!newb1.isActive);</span>
<a href="#l7.343"></a><span id="l7.343" class="difflineminus">-</span>
<a href="#l7.344"></a><span id="l7.344" class="difflineminus">-  await checkBootstrappedPref();</span>
<a href="#l7.345"></a><span id="l7.345" class="difflineminus">-  startupCacheMonitor.check(false);</span>
<a href="#l7.346"></a><span id="l7.346" class="difflineminus">-});</span>
<a href="#l7.347"></a><span id="l7.347" class="difflineminus">-</span>
<a href="#l7.348"></a><span id="l7.348" class="difflineminus">-// Test that restarting doesn't accidentally re-enable</span>
<a href="#l7.349"></a><span id="l7.349" class="difflineminus">-add_task(async function test_3() {</span>
<a href="#l7.350"></a><span id="l7.350" class="difflineminus">-  await promiseShutdownManager();</span>
<a href="#l7.351"></a><span id="l7.351" class="difflineminus">-</span>
<a href="#l7.352"></a><span id="l7.352" class="difflineminus">-  BootstrapMonitor.checkAddonInstalled(ID1, &quot;1.0&quot;);</span>
<a href="#l7.353"></a><span id="l7.353" class="difflineminus">-  BootstrapMonitor.checkAddonNotStarted(ID1);</span>
<a href="#l7.354"></a><span id="l7.354" class="difflineminus">-  equal(getShutdownReason(), ADDON_DISABLE);</span>
<a href="#l7.355"></a><span id="l7.355" class="difflineminus">-  equal(getShutdownNewVersion(), undefined);</span>
<a href="#l7.356"></a><span id="l7.356" class="difflineminus">-</span>
<a href="#l7.357"></a><span id="l7.357" class="difflineminus">-  await promiseStartupManager();</span>
<a href="#l7.358"></a><span id="l7.358" class="difflineminus">-</span>
<a href="#l7.359"></a><span id="l7.359" class="difflineminus">-  BootstrapMonitor.checkAddonInstalled(ID1, &quot;1.0&quot;);</span>
<a href="#l7.360"></a><span id="l7.360" class="difflineminus">-  BootstrapMonitor.checkAddonNotStarted(ID1);</span>
<a href="#l7.361"></a><span id="l7.361" class="difflineminus">-  equal(getShutdownReason(), ADDON_DISABLE);</span>
<a href="#l7.362"></a><span id="l7.362" class="difflineminus">-  equal(getShutdownNewVersion(), undefined);</span>
<a href="#l7.363"></a><span id="l7.363" class="difflineminus">-  do_check_not_in_crash_annotation(ID1, &quot;1.0&quot;);</span>
<a href="#l7.364"></a><span id="l7.364" class="difflineminus">-</span>
<a href="#l7.365"></a><span id="l7.365" class="difflineminus">-  ok(gAddonStartup.exists());</span>
<a href="#l7.366"></a><span id="l7.366" class="difflineminus">-</span>
<a href="#l7.367"></a><span id="l7.367" class="difflineminus">-  let b1 = await AddonManager.getAddonByID(ID1);</span>
<a href="#l7.368"></a><span id="l7.368" class="difflineminus">-  notEqual(b1, null);</span>
<a href="#l7.369"></a><span id="l7.369" class="difflineminus">-  equal(b1.version, &quot;1.0&quot;);</span>
<a href="#l7.370"></a><span id="l7.370" class="difflineminus">-  ok(!b1.appDisabled);</span>
<a href="#l7.371"></a><span id="l7.371" class="difflineminus">-  ok(b1.userDisabled);</span>
<a href="#l7.372"></a><span id="l7.372" class="difflineminus">-  ok(!b1.isActive);</span>
<a href="#l7.373"></a><span id="l7.373" class="difflineminus">-</span>
<a href="#l7.374"></a><span id="l7.374" class="difflineminus">-  await checkBootstrappedPref();</span>
<a href="#l7.375"></a><span id="l7.375" class="difflineminus">-  startupCacheMonitor.check(false);</span>
<a href="#l7.376"></a><span id="l7.376" class="difflineminus">-});</span>
<a href="#l7.377"></a><span id="l7.377" class="difflineminus">-</span>
<a href="#l7.378"></a><span id="l7.378" class="difflineminus">-// Tests that enabling doesn't require a restart</span>
<a href="#l7.379"></a><span id="l7.379" class="difflineminus">-add_task(async function test_4() {</span>
<a href="#l7.380"></a><span id="l7.380" class="difflineminus">-  let b1 = await AddonManager.getAddonByID(ID1);</span>
<a href="#l7.381"></a><span id="l7.381" class="difflineminus">-  prepare_test({</span>
<a href="#l7.382"></a><span id="l7.382" class="difflineminus">-    [ID1]: [[&quot;onEnabling&quot;, false], &quot;onEnabled&quot;],</span>
<a href="#l7.383"></a><span id="l7.383" class="difflineminus">-  });</span>
<a href="#l7.384"></a><span id="l7.384" class="difflineminus">-</span>
<a href="#l7.385"></a><span id="l7.385" class="difflineminus">-  equal(</span>
<a href="#l7.386"></a><span id="l7.386" class="difflineminus">-    b1.operationsRequiringRestart &amp; AddonManager.OP_NEEDS_RESTART_ENABLE,</span>
<a href="#l7.387"></a><span id="l7.387" class="difflineminus">-    0</span>
<a href="#l7.388"></a><span id="l7.388" class="difflineminus">-  );</span>
<a href="#l7.389"></a><span id="l7.389" class="difflineminus">-  await b1.enable();</span>
<a href="#l7.390"></a><span id="l7.390" class="difflineminus">-  ensure_test_completed();</span>
<a href="#l7.391"></a><span id="l7.391" class="difflineminus">-</span>
<a href="#l7.392"></a><span id="l7.392" class="difflineminus">-  notEqual(b1, null);</span>
<a href="#l7.393"></a><span id="l7.393" class="difflineminus">-  equal(b1.version, &quot;1.0&quot;);</span>
<a href="#l7.394"></a><span id="l7.394" class="difflineminus">-  ok(!b1.appDisabled);</span>
<a href="#l7.395"></a><span id="l7.395" class="difflineminus">-  ok(!b1.userDisabled);</span>
<a href="#l7.396"></a><span id="l7.396" class="difflineminus">-  ok(b1.isActive);</span>
<a href="#l7.397"></a><span id="l7.397" class="difflineminus">-  ok(!b1.isSystem);</span>
<a href="#l7.398"></a><span id="l7.398" class="difflineminus">-  BootstrapMonitor.checkAddonInstalled(ID1, &quot;1.0&quot;);</span>
<a href="#l7.399"></a><span id="l7.399" class="difflineminus">-  BootstrapMonitor.checkAddonStarted(ID1, &quot;1.0&quot;);</span>
<a href="#l7.400"></a><span id="l7.400" class="difflineminus">-  equal(getStartupReason(), ADDON_ENABLE);</span>
<a href="#l7.401"></a><span id="l7.401" class="difflineminus">-  equal(getStartupOldVersion(), undefined);</span>
<a href="#l7.402"></a><span id="l7.402" class="difflineminus">-  do_check_in_crash_annotation(ID1, &quot;1.0&quot;);</span>
<a href="#l7.403"></a><span id="l7.403" class="difflineminus">-</span>
<a href="#l7.404"></a><span id="l7.404" class="difflineminus">-  let newb1 = await AddonManager.getAddonByID(ID1);</span>
<a href="#l7.405"></a><span id="l7.405" class="difflineminus">-  notEqual(newb1, null);</span>
<a href="#l7.406"></a><span id="l7.406" class="difflineminus">-  equal(newb1.version, &quot;1.0&quot;);</span>
<a href="#l7.407"></a><span id="l7.407" class="difflineminus">-  ok(!newb1.appDisabled);</span>
<a href="#l7.408"></a><span id="l7.408" class="difflineminus">-  ok(!newb1.userDisabled);</span>
<a href="#l7.409"></a><span id="l7.409" class="difflineminus">-  ok(newb1.isActive);</span>
<a href="#l7.410"></a><span id="l7.410" class="difflineminus">-</span>
<a href="#l7.411"></a><span id="l7.411" class="difflineminus">-  await checkBootstrappedPref();</span>
<a href="#l7.412"></a><span id="l7.412" class="difflineminus">-  startupCacheMonitor.check(false);</span>
<a href="#l7.413"></a><span id="l7.413" class="difflineminus">-});</span>
<a href="#l7.414"></a><span id="l7.414" class="difflineminus">-</span>
<a href="#l7.415"></a><span id="l7.415" class="difflineminus">-// Tests that a restart shuts down and restarts the add-on</span>
<a href="#l7.416"></a><span id="l7.416" class="difflineminus">-add_task(async function test_5() {</span>
<a href="#l7.417"></a><span id="l7.417" class="difflineminus">-  await promiseShutdownManager();</span>
<a href="#l7.418"></a><span id="l7.418" class="difflineminus">-  // By the time we've shut down, the database must have been written</span>
<a href="#l7.419"></a><span id="l7.419" class="difflineminus">-  ok(gExtensionsJSON.exists());</span>
<a href="#l7.420"></a><span id="l7.420" class="difflineminus">-</span>
<a href="#l7.421"></a><span id="l7.421" class="difflineminus">-  BootstrapMonitor.checkAddonInstalled(ID1, &quot;1.0&quot;);</span>
<a href="#l7.422"></a><span id="l7.422" class="difflineminus">-  BootstrapMonitor.checkAddonNotStarted(ID1);</span>
<a href="#l7.423"></a><span id="l7.423" class="difflineminus">-  equal(getShutdownReason(), APP_SHUTDOWN);</span>
<a href="#l7.424"></a><span id="l7.424" class="difflineminus">-  equal(getShutdownNewVersion(), undefined);</span>
<a href="#l7.425"></a><span id="l7.425" class="difflineminus">-  do_check_not_in_crash_annotation(ID1, &quot;1.0&quot;);</span>
<a href="#l7.426"></a><span id="l7.426" class="difflineminus">-  await promiseStartupManager();</span>
<a href="#l7.427"></a><span id="l7.427" class="difflineminus">-  BootstrapMonitor.checkAddonInstalled(ID1, &quot;1.0&quot;);</span>
<a href="#l7.428"></a><span id="l7.428" class="difflineminus">-  BootstrapMonitor.checkAddonStarted(ID1, &quot;1.0&quot;);</span>
<a href="#l7.429"></a><span id="l7.429" class="difflineminus">-  equal(getStartupReason(), APP_STARTUP);</span>
<a href="#l7.430"></a><span id="l7.430" class="difflineminus">-  equal(getStartupOldVersion(), undefined);</span>
<a href="#l7.431"></a><span id="l7.431" class="difflineminus">-  do_check_in_crash_annotation(ID1, &quot;1.0&quot;);</span>
<a href="#l7.432"></a><span id="l7.432" class="difflineminus">-</span>
<a href="#l7.433"></a><span id="l7.433" class="difflineminus">-  let b1 = await AddonManager.getAddonByID(ID1);</span>
<a href="#l7.434"></a><span id="l7.434" class="difflineminus">-  notEqual(b1, null);</span>
<a href="#l7.435"></a><span id="l7.435" class="difflineminus">-  equal(b1.version, &quot;1.0&quot;);</span>
<a href="#l7.436"></a><span id="l7.436" class="difflineminus">-  ok(!b1.appDisabled);</span>
<a href="#l7.437"></a><span id="l7.437" class="difflineminus">-  ok(!b1.userDisabled);</span>
<a href="#l7.438"></a><span id="l7.438" class="difflineminus">-  ok(b1.isActive);</span>
<a href="#l7.439"></a><span id="l7.439" class="difflineminus">-  ok(!b1.isSystem);</span>
<a href="#l7.440"></a><span id="l7.440" class="difflineminus">-</span>
<a href="#l7.441"></a><span id="l7.441" class="difflineminus">-  await checkBootstrappedPref();</span>
<a href="#l7.442"></a><span id="l7.442" class="difflineminus">-  startupCacheMonitor.check(false);</span>
<a href="#l7.443"></a><span id="l7.443" class="difflineminus">-});</span>
<a href="#l7.444"></a><span id="l7.444" class="difflineminus">-</span>
<a href="#l7.445"></a><span id="l7.445" class="difflineminus">-// Tests that installing an upgrade doesn't require a restart</span>
<a href="#l7.446"></a><span id="l7.446" class="difflineminus">-add_task(async function test_6() {</span>
<a href="#l7.447"></a><span id="l7.447" class="difflineminus">-  prepare_test({}, [&quot;onNewInstall&quot;]);</span>
<a href="#l7.448"></a><span id="l7.448" class="difflineminus">-</span>
<a href="#l7.449"></a><span id="l7.449" class="difflineminus">-  let install = await AddonManager.getInstallForFile(XPIS.test_bootstrap1_2);</span>
<a href="#l7.450"></a><span id="l7.450" class="difflineminus">-  ensure_test_completed();</span>
<a href="#l7.451"></a><span id="l7.451" class="difflineminus">-</span>
<a href="#l7.452"></a><span id="l7.452" class="difflineminus">-  notEqual(install, null);</span>
<a href="#l7.453"></a><span id="l7.453" class="difflineminus">-  equal(install.type, &quot;extension&quot;);</span>
<a href="#l7.454"></a><span id="l7.454" class="difflineminus">-  equal(install.version, &quot;2.0&quot;);</span>
<a href="#l7.455"></a><span id="l7.455" class="difflineminus">-  equal(install.name, &quot;Test Bootstrap 1&quot;);</span>
<a href="#l7.456"></a><span id="l7.456" class="difflineminus">-  equal(install.state, AddonManager.STATE_DOWNLOADED);</span>
<a href="#l7.457"></a><span id="l7.457" class="difflineminus">-</span>
<a href="#l7.458"></a><span id="l7.458" class="difflineminus">-  await Promise.all([</span>
<a href="#l7.459"></a><span id="l7.459" class="difflineminus">-    BootstrapMonitor.promiseAddonStartup(ID1),</span>
<a href="#l7.460"></a><span id="l7.460" class="difflineminus">-    new Promise(resolve =&gt; {</span>
<a href="#l7.461"></a><span id="l7.461" class="difflineminus">-      prepare_test(</span>
<a href="#l7.462"></a><span id="l7.462" class="difflineminus">-        {</span>
<a href="#l7.463"></a><span id="l7.463" class="difflineminus">-          [ID1]: [[&quot;onInstalling&quot;, false], &quot;onInstalled&quot;],</span>
<a href="#l7.464"></a><span id="l7.464" class="difflineminus">-        },</span>
<a href="#l7.465"></a><span id="l7.465" class="difflineminus">-        [&quot;onInstallStarted&quot;, &quot;onInstallEnded&quot;],</span>
<a href="#l7.466"></a><span id="l7.466" class="difflineminus">-        resolve</span>
<a href="#l7.467"></a><span id="l7.467" class="difflineminus">-      );</span>
<a href="#l7.468"></a><span id="l7.468" class="difflineminus">-      install.install();</span>
<a href="#l7.469"></a><span id="l7.469" class="difflineminus">-    }),</span>
<a href="#l7.470"></a><span id="l7.470" class="difflineminus">-  ]);</span>
<a href="#l7.471"></a><span id="l7.471" class="difflineminus">-</span>
<a href="#l7.472"></a><span id="l7.472" class="difflineminus">-  startupCacheMonitor.check(true);</span>
<a href="#l7.473"></a><span id="l7.473" class="difflineminus">-</span>
<a href="#l7.474"></a><span id="l7.474" class="difflineminus">-  let b1 = await AddonManager.getAddonByID(ID1);</span>
<a href="#l7.475"></a><span id="l7.475" class="difflineminus">-  notEqual(b1, null);</span>
<a href="#l7.476"></a><span id="l7.476" class="difflineminus">-  equal(b1.version, &quot;2.0&quot;);</span>
<a href="#l7.477"></a><span id="l7.477" class="difflineminus">-  ok(!b1.appDisabled);</span>
<a href="#l7.478"></a><span id="l7.478" class="difflineminus">-  ok(!b1.userDisabled);</span>
<a href="#l7.479"></a><span id="l7.479" class="difflineminus">-  ok(b1.isActive);</span>
<a href="#l7.480"></a><span id="l7.480" class="difflineminus">-  ok(!b1.isSystem);</span>
<a href="#l7.481"></a><span id="l7.481" class="difflineminus">-  BootstrapMonitor.checkAddonInstalled(ID1, &quot;2.0&quot;);</span>
<a href="#l7.482"></a><span id="l7.482" class="difflineminus">-  BootstrapMonitor.checkAddonStarted(ID1, &quot;2.0&quot;);</span>
<a href="#l7.483"></a><span id="l7.483" class="difflineminus">-  equal(getStartupReason(), ADDON_UPGRADE);</span>
<a href="#l7.484"></a><span id="l7.484" class="difflineminus">-  equal(getInstallOldVersion(), 1);</span>
<a href="#l7.485"></a><span id="l7.485" class="difflineminus">-  equal(getStartupOldVersion(), 1);</span>
<a href="#l7.486"></a><span id="l7.486" class="difflineminus">-  equal(getShutdownReason(), ADDON_UPGRADE);</span>
<a href="#l7.487"></a><span id="l7.487" class="difflineminus">-  equal(getShutdownNewVersion(), 2);</span>
<a href="#l7.488"></a><span id="l7.488" class="difflineminus">-  equal(getUninstallNewVersion(), 2);</span>
<a href="#l7.489"></a><span id="l7.489" class="difflineminus">-  do_check_not_in_crash_annotation(ID1, &quot;1.0&quot;);</span>
<a href="#l7.490"></a><span id="l7.490" class="difflineminus">-  do_check_in_crash_annotation(ID1, &quot;2.0&quot;);</span>
<a href="#l7.491"></a><span id="l7.491" class="difflineminus">-</span>
<a href="#l7.492"></a><span id="l7.492" class="difflineminus">-  await checkBootstrappedPref();</span>
<a href="#l7.493"></a><span id="l7.493" class="difflineminus">-});</span>
<a href="#l7.494"></a><span id="l7.494" class="difflineminus">-</span>
<a href="#l7.495"></a><span id="l7.495" class="difflineminus">-// Tests that uninstalling doesn't require a restart</span>
<a href="#l7.496"></a><span id="l7.496" class="difflineminus">-add_task(async function test_7() {</span>
<a href="#l7.497"></a><span id="l7.497" class="difflineminus">-  let b1 = await AddonManager.getAddonByID(ID1);</span>
<a href="#l7.498"></a><span id="l7.498" class="difflineminus">-  prepare_test({</span>
<a href="#l7.499"></a><span id="l7.499" class="difflineminus">-    [ID1]: [[&quot;onUninstalling&quot;, false], &quot;onUninstalled&quot;],</span>
<a href="#l7.500"></a><span id="l7.500" class="difflineminus">-  });</span>
<a href="#l7.501"></a><span id="l7.501" class="difflineminus">-</span>
<a href="#l7.502"></a><span id="l7.502" class="difflineminus">-  equal(</span>
<a href="#l7.503"></a><span id="l7.503" class="difflineminus">-    b1.operationsRequiringRestart &amp; AddonManager.OP_NEEDS_RESTART_UNINSTALL,</span>
<a href="#l7.504"></a><span id="l7.504" class="difflineminus">-    0</span>
<a href="#l7.505"></a><span id="l7.505" class="difflineminus">-  );</span>
<a href="#l7.506"></a><span id="l7.506" class="difflineminus">-  await b1.uninstall();</span>
<a href="#l7.507"></a><span id="l7.507" class="difflineminus">-</span>
<a href="#l7.508"></a><span id="l7.508" class="difflineminus">-  await checkBootstrappedPref();</span>
<a href="#l7.509"></a><span id="l7.509" class="difflineminus">-  startupCacheMonitor.check(true);</span>
<a href="#l7.510"></a><span id="l7.510" class="difflineminus">-</span>
<a href="#l7.511"></a><span id="l7.511" class="difflineminus">-  ensure_test_completed();</span>
<a href="#l7.512"></a><span id="l7.512" class="difflineminus">-  BootstrapMonitor.checkAddonNotInstalled(ID1);</span>
<a href="#l7.513"></a><span id="l7.513" class="difflineminus">-  BootstrapMonitor.checkAddonNotStarted(ID1);</span>
<a href="#l7.514"></a><span id="l7.514" class="difflineminus">-  equal(getShutdownReason(), ADDON_DISABLE);</span>
<a href="#l7.515"></a><span id="l7.515" class="difflineminus">-  equal(getShutdownNewVersion(), undefined);</span>
<a href="#l7.516"></a><span id="l7.516" class="difflineminus">-  do_check_not_in_crash_annotation(ID1, &quot;2.0&quot;);</span>
<a href="#l7.517"></a><span id="l7.517" class="difflineminus">-</span>
<a href="#l7.518"></a><span id="l7.518" class="difflineminus">-  b1 = await AddonManager.getAddonByID(ID1);</span>
<a href="#l7.519"></a><span id="l7.519" class="difflineminus">-  equal(b1, null);</span>
<a href="#l7.520"></a><span id="l7.520" class="difflineminus">-</span>
<a href="#l7.521"></a><span id="l7.521" class="difflineminus">-  await promiseRestartManager();</span>
<a href="#l7.522"></a><span id="l7.522" class="difflineminus">-</span>
<a href="#l7.523"></a><span id="l7.523" class="difflineminus">-  let newb1 = await AddonManager.getAddonByID(ID1);</span>
<a href="#l7.524"></a><span id="l7.524" class="difflineminus">-  equal(newb1, null);</span>
<a href="#l7.525"></a><span id="l7.525" class="difflineminus">-</span>
<a href="#l7.526"></a><span id="l7.526" class="difflineminus">-  await checkBootstrappedPref();</span>
<a href="#l7.527"></a><span id="l7.527" class="difflineminus">-  startupCacheMonitor.check(false);</span>
<a href="#l7.528"></a><span id="l7.528" class="difflineminus">-});</span>
<a href="#l7.529"></a><span id="l7.529" class="difflineminus">-</span>
<a href="#l7.530"></a><span id="l7.530" class="difflineminus">-// Test that a bootstrapped extension dropped into the profile loads properly</span>
<a href="#l7.531"></a><span id="l7.531" class="difflineminus">-// on startup and doesn't cause an EM restart</span>
<a href="#l7.532"></a><span id="l7.532" class="difflineminus">-add_task(async function test_8() {</span>
<a href="#l7.533"></a><span id="l7.533" class="difflineminus">-  await promiseShutdownManager();</span>
<a href="#l7.534"></a><span id="l7.534" class="difflineminus">-</span>
<a href="#l7.535"></a><span id="l7.535" class="difflineminus">-  await manuallyInstall(XPIS.test_bootstrap1_1, profileDir, ID1);</span>
<a href="#l7.536"></a><span id="l7.536" class="difflineminus">-</span>
<a href="#l7.537"></a><span id="l7.537" class="difflineminus">-  startupCacheMonitor.check(false);</span>
<a href="#l7.538"></a><span id="l7.538" class="difflineminus">-  await promiseStartupManager();</span>
<a href="#l7.539"></a><span id="l7.539" class="difflineminus">-</span>
<a href="#l7.540"></a><span id="l7.540" class="difflineminus">-  let b1 = await AddonManager.getAddonByID(ID1);</span>
<a href="#l7.541"></a><span id="l7.541" class="difflineminus">-  notEqual(b1, null);</span>
<a href="#l7.542"></a><span id="l7.542" class="difflineminus">-  equal(b1.version, &quot;1.0&quot;);</span>
<a href="#l7.543"></a><span id="l7.543" class="difflineminus">-  ok(!b1.appDisabled);</span>
<a href="#l7.544"></a><span id="l7.544" class="difflineminus">-  ok(!b1.userDisabled);</span>
<a href="#l7.545"></a><span id="l7.545" class="difflineminus">-  ok(b1.isActive);</span>
<a href="#l7.546"></a><span id="l7.546" class="difflineminus">-  ok(!b1.isSystem);</span>
<a href="#l7.547"></a><span id="l7.547" class="difflineminus">-  BootstrapMonitor.checkAddonInstalled(ID1, &quot;1.0&quot;);</span>
<a href="#l7.548"></a><span id="l7.548" class="difflineminus">-  BootstrapMonitor.checkAddonStarted(ID1, &quot;1.0&quot;);</span>
<a href="#l7.549"></a><span id="l7.549" class="difflineminus">-  equal(getStartupReason(), ADDON_INSTALL);</span>
<a href="#l7.550"></a><span id="l7.550" class="difflineminus">-  equal(getStartupOldVersion(), undefined);</span>
<a href="#l7.551"></a><span id="l7.551" class="difflineminus">-  do_check_in_crash_annotation(ID1, &quot;1.0&quot;);</span>
<a href="#l7.552"></a><span id="l7.552" class="difflineminus">-</span>
<a href="#l7.553"></a><span id="l7.553" class="difflineminus">-  await checkBootstrappedPref();</span>
<a href="#l7.554"></a><span id="l7.554" class="difflineminus">-});</span>
<a href="#l7.555"></a><span id="l7.555" class="difflineminus">-</span>
<a href="#l7.556"></a><span id="l7.556" class="difflineminus">-// Test that items detected as removed during startup get removed properly</span>
<a href="#l7.557"></a><span id="l7.557" class="difflineminus">-add_task(async function test_9() {</span>
<a href="#l7.558"></a><span id="l7.558" class="difflineminus">-  await promiseShutdownManager();</span>
<a href="#l7.559"></a><span id="l7.559" class="difflineminus">-</span>
<a href="#l7.560"></a><span id="l7.560" class="difflineminus">-  manuallyUninstall(profileDir, ID1);</span>
<a href="#l7.561"></a><span id="l7.561" class="difflineminus">-</span>
<a href="#l7.562"></a><span id="l7.562" class="difflineminus">-  await promiseStartupManager();</span>
<a href="#l7.563"></a><span id="l7.563" class="difflineminus">-  startupCacheMonitor.check(true);</span>
<a href="#l7.564"></a><span id="l7.564" class="difflineminus">-  BootstrapMonitor.clear(ID1);</span>
<a href="#l7.565"></a><span id="l7.565" class="difflineminus">-</span>
<a href="#l7.566"></a><span id="l7.566" class="difflineminus">-  let b1 = await AddonManager.getAddonByID(ID1);</span>
<a href="#l7.567"></a><span id="l7.567" class="difflineminus">-  equal(b1, null);</span>
<a href="#l7.568"></a><span id="l7.568" class="difflineminus">-  do_check_not_in_crash_annotation(ID1, &quot;1.0&quot;);</span>
<a href="#l7.569"></a><span id="l7.569" class="difflineminus">-</span>
<a href="#l7.570"></a><span id="l7.570" class="difflineminus">-  await checkBootstrappedPref();</span>
<a href="#l7.571"></a><span id="l7.571" class="difflineminus">-  startupCacheMonitor.check(false);</span>
<a href="#l7.572"></a><span id="l7.572" class="difflineminus">-});</span>
<a href="#l7.573"></a><span id="l7.573" class="difflineminus">-</span>
<a href="#l7.574"></a><span id="l7.574" class="difflineminus">-// Tests that installing a downgrade sends the right reason</span>
<a href="#l7.575"></a><span id="l7.575" class="difflineminus">-add_task(async function test_10() {</span>
<a href="#l7.576"></a><span id="l7.576" class="difflineminus">-  prepare_test({}, [&quot;onNewInstall&quot;]);</span>
<a href="#l7.577"></a><span id="l7.577" class="difflineminus">-</span>
<a href="#l7.578"></a><span id="l7.578" class="difflineminus">-  let install = await AddonManager.getInstallForFile(XPIS.test_bootstrap1_2);</span>
<a href="#l7.579"></a><span id="l7.579" class="difflineminus">-  ensure_test_completed();</span>
<a href="#l7.580"></a><span id="l7.580" class="difflineminus">-</span>
<a href="#l7.581"></a><span id="l7.581" class="difflineminus">-  notEqual(install, null);</span>
<a href="#l7.582"></a><span id="l7.582" class="difflineminus">-  equal(install.type, &quot;extension&quot;);</span>
<a href="#l7.583"></a><span id="l7.583" class="difflineminus">-  equal(install.version, &quot;2.0&quot;);</span>
<a href="#l7.584"></a><span id="l7.584" class="difflineminus">-  equal(install.name, &quot;Test Bootstrap 1&quot;);</span>
<a href="#l7.585"></a><span id="l7.585" class="difflineminus">-  equal(install.state, AddonManager.STATE_DOWNLOADED);</span>
<a href="#l7.586"></a><span id="l7.586" class="difflineminus">-  do_check_not_in_crash_annotation(ID1, &quot;2.0&quot;);</span>
<a href="#l7.587"></a><span id="l7.587" class="difflineminus">-</span>
<a href="#l7.588"></a><span id="l7.588" class="difflineminus">-  await Promise.all([</span>
<a href="#l7.589"></a><span id="l7.589" class="difflineminus">-    BootstrapMonitor.promiseAddonStartup(ID1),</span>
<a href="#l7.590"></a><span id="l7.590" class="difflineminus">-    new Promise(resolve =&gt; {</span>
<a href="#l7.591"></a><span id="l7.591" class="difflineminus">-      prepare_test(</span>
<a href="#l7.592"></a><span id="l7.592" class="difflineminus">-        {</span>
<a href="#l7.593"></a><span id="l7.593" class="difflineminus">-          [ID1]: [[&quot;onInstalling&quot;, false], &quot;onInstalled&quot;],</span>
<a href="#l7.594"></a><span id="l7.594" class="difflineminus">-        },</span>
<a href="#l7.595"></a><span id="l7.595" class="difflineminus">-        [&quot;onInstallStarted&quot;, &quot;onInstallEnded&quot;],</span>
<a href="#l7.596"></a><span id="l7.596" class="difflineminus">-        resolve</span>
<a href="#l7.597"></a><span id="l7.597" class="difflineminus">-      );</span>
<a href="#l7.598"></a><span id="l7.598" class="difflineminus">-      install.install();</span>
<a href="#l7.599"></a><span id="l7.599" class="difflineminus">-    }),</span>
<a href="#l7.600"></a><span id="l7.600" class="difflineminus">-  ]);</span>
<a href="#l7.601"></a><span id="l7.601" class="difflineminus">-</span>
<a href="#l7.602"></a><span id="l7.602" class="difflineminus">-  startupCacheMonitor.check(false);</span>
<a href="#l7.603"></a><span id="l7.603" class="difflineminus">-</span>
<a href="#l7.604"></a><span id="l7.604" class="difflineminus">-  let b1 = await AddonManager.getAddonByID(ID1);</span>
<a href="#l7.605"></a><span id="l7.605" class="difflineminus">-  notEqual(b1, null);</span>
<a href="#l7.606"></a><span id="l7.606" class="difflineminus">-  equal(b1.version, &quot;2.0&quot;);</span>
<a href="#l7.607"></a><span id="l7.607" class="difflineminus">-  ok(!b1.appDisabled);</span>
<a href="#l7.608"></a><span id="l7.608" class="difflineminus">-  ok(!b1.userDisabled);</span>
<a href="#l7.609"></a><span id="l7.609" class="difflineminus">-  ok(b1.isActive);</span>
<a href="#l7.610"></a><span id="l7.610" class="difflineminus">-  ok(!b1.isSystem);</span>
<a href="#l7.611"></a><span id="l7.611" class="difflineminus">-  BootstrapMonitor.checkAddonInstalled(ID1, &quot;2.0&quot;);</span>
<a href="#l7.612"></a><span id="l7.612" class="difflineminus">-  BootstrapMonitor.checkAddonStarted(ID1, &quot;2.0&quot;);</span>
<a href="#l7.613"></a><span id="l7.613" class="difflineminus">-  equal(getStartupReason(), ADDON_INSTALL);</span>
<a href="#l7.614"></a><span id="l7.614" class="difflineminus">-  equal(getStartupOldVersion(), undefined);</span>
<a href="#l7.615"></a><span id="l7.615" class="difflineminus">-  do_check_in_crash_annotation(ID1, &quot;2.0&quot;);</span>
<a href="#l7.616"></a><span id="l7.616" class="difflineminus">-</span>
<a href="#l7.617"></a><span id="l7.617" class="difflineminus">-  prepare_test({}, [&quot;onNewInstall&quot;]);</span>
<a href="#l7.618"></a><span id="l7.618" class="difflineminus">-</span>
<a href="#l7.619"></a><span id="l7.619" class="difflineminus">-  install = await AddonManager.getInstallForFile(XPIS.test_bootstrap1_1);</span>
<a href="#l7.620"></a><span id="l7.620" class="difflineminus">-  ensure_test_completed();</span>
<a href="#l7.621"></a><span id="l7.621" class="difflineminus">-</span>
<a href="#l7.622"></a><span id="l7.622" class="difflineminus">-  notEqual(install, null);</span>
<a href="#l7.623"></a><span id="l7.623" class="difflineminus">-  equal(install.type, &quot;extension&quot;);</span>
<a href="#l7.624"></a><span id="l7.624" class="difflineminus">-  equal(install.version, &quot;1.0&quot;);</span>
<a href="#l7.625"></a><span id="l7.625" class="difflineminus">-  equal(install.name, &quot;Test Bootstrap 1&quot;);</span>
<a href="#l7.626"></a><span id="l7.626" class="difflineminus">-  equal(install.state, AddonManager.STATE_DOWNLOADED);</span>
<a href="#l7.627"></a><span id="l7.627" class="difflineminus">-</span>
<a href="#l7.628"></a><span id="l7.628" class="difflineminus">-  await Promise.all([</span>
<a href="#l7.629"></a><span id="l7.629" class="difflineminus">-    BootstrapMonitor.promiseAddonStartup(ID1),</span>
<a href="#l7.630"></a><span id="l7.630" class="difflineminus">-    new Promise(resolve =&gt; {</span>
<a href="#l7.631"></a><span id="l7.631" class="difflineminus">-      prepare_test(</span>
<a href="#l7.632"></a><span id="l7.632" class="difflineminus">-        {</span>
<a href="#l7.633"></a><span id="l7.633" class="difflineminus">-          [ID1]: [[&quot;onInstalling&quot;, false], &quot;onInstalled&quot;],</span>
<a href="#l7.634"></a><span id="l7.634" class="difflineminus">-        },</span>
<a href="#l7.635"></a><span id="l7.635" class="difflineminus">-        [&quot;onInstallStarted&quot;, &quot;onInstallEnded&quot;],</span>
<a href="#l7.636"></a><span id="l7.636" class="difflineminus">-        resolve</span>
<a href="#l7.637"></a><span id="l7.637" class="difflineminus">-      );</span>
<a href="#l7.638"></a><span id="l7.638" class="difflineminus">-      install.install();</span>
<a href="#l7.639"></a><span id="l7.639" class="difflineminus">-    }),</span>
<a href="#l7.640"></a><span id="l7.640" class="difflineminus">-  ]);</span>
<a href="#l7.641"></a><span id="l7.641" class="difflineminus">-</span>
<a href="#l7.642"></a><span id="l7.642" class="difflineminus">-  startupCacheMonitor.check(true);</span>
<a href="#l7.643"></a><span id="l7.643" class="difflineminus">-</span>
<a href="#l7.644"></a><span id="l7.644" class="difflineminus">-  b1 = await AddonManager.getAddonByID(ID1);</span>
<a href="#l7.645"></a><span id="l7.645" class="difflineminus">-  notEqual(b1, null);</span>
<a href="#l7.646"></a><span id="l7.646" class="difflineminus">-  equal(b1.version, &quot;1.0&quot;);</span>
<a href="#l7.647"></a><span id="l7.647" class="difflineminus">-  ok(!b1.appDisabled);</span>
<a href="#l7.648"></a><span id="l7.648" class="difflineminus">-  ok(!b1.userDisabled);</span>
<a href="#l7.649"></a><span id="l7.649" class="difflineminus">-  ok(b1.isActive);</span>
<a href="#l7.650"></a><span id="l7.650" class="difflineminus">-  ok(!b1.isSystem);</span>
<a href="#l7.651"></a><span id="l7.651" class="difflineminus">-  BootstrapMonitor.checkAddonInstalled(ID1, &quot;1.0&quot;);</span>
<a href="#l7.652"></a><span id="l7.652" class="difflineminus">-  BootstrapMonitor.checkAddonStarted(ID1, &quot;1.0&quot;);</span>
<a href="#l7.653"></a><span id="l7.653" class="difflineminus">-  equal(getStartupReason(), ADDON_DOWNGRADE);</span>
<a href="#l7.654"></a><span id="l7.654" class="difflineminus">-  equal(getInstallOldVersion(), 2);</span>
<a href="#l7.655"></a><span id="l7.655" class="difflineminus">-  equal(getStartupOldVersion(), 2);</span>
<a href="#l7.656"></a><span id="l7.656" class="difflineminus">-  equal(getShutdownReason(), ADDON_DOWNGRADE);</span>
<a href="#l7.657"></a><span id="l7.657" class="difflineminus">-  equal(getShutdownNewVersion(), 1);</span>
<a href="#l7.658"></a><span id="l7.658" class="difflineminus">-  equal(getUninstallNewVersion(), 1);</span>
<a href="#l7.659"></a><span id="l7.659" class="difflineminus">-  do_check_in_crash_annotation(ID1, &quot;1.0&quot;);</span>
<a href="#l7.660"></a><span id="l7.660" class="difflineminus">-  do_check_not_in_crash_annotation(ID1, &quot;2.0&quot;);</span>
<a href="#l7.661"></a><span id="l7.661" class="difflineminus">-</span>
<a href="#l7.662"></a><span id="l7.662" class="difflineminus">-  await checkBootstrappedPref();</span>
<a href="#l7.663"></a><span id="l7.663" class="difflineminus">-  startupCacheMonitor.check(false);</span>
<a href="#l7.664"></a><span id="l7.664" class="difflineminus">-});</span>
<a href="#l7.665"></a><span id="l7.665" class="difflineminus">-</span>
<a href="#l7.666"></a><span id="l7.666" class="difflineminus">-// Tests that uninstalling a disabled add-on still calls the uninstall method</span>
<a href="#l7.667"></a><span id="l7.667" class="difflineminus">-add_task(async function test_11() {</span>
<a href="#l7.668"></a><span id="l7.668" class="difflineminus">-  let b1 = await AddonManager.getAddonByID(ID1);</span>
<a href="#l7.669"></a><span id="l7.669" class="difflineminus">-  prepare_test({</span>
<a href="#l7.670"></a><span id="l7.670" class="difflineminus">-    [ID1]: [</span>
<a href="#l7.671"></a><span id="l7.671" class="difflineminus">-      [&quot;onDisabling&quot;, false],</span>
<a href="#l7.672"></a><span id="l7.672" class="difflineminus">-      &quot;onDisabled&quot;,</span>
<a href="#l7.673"></a><span id="l7.673" class="difflineminus">-      [&quot;onUninstalling&quot;, false],</span>
<a href="#l7.674"></a><span id="l7.674" class="difflineminus">-      &quot;onUninstalled&quot;,</span>
<a href="#l7.675"></a><span id="l7.675" class="difflineminus">-    ],</span>
<a href="#l7.676"></a><span id="l7.676" class="difflineminus">-  });</span>
<a href="#l7.677"></a><span id="l7.677" class="difflineminus">-</span>
<a href="#l7.678"></a><span id="l7.678" class="difflineminus">-  await b1.disable();</span>
<a href="#l7.679"></a><span id="l7.679" class="difflineminus">-</span>
<a href="#l7.680"></a><span id="l7.680" class="difflineminus">-  BootstrapMonitor.checkAddonInstalled(ID1, &quot;1.0&quot;);</span>
<a href="#l7.681"></a><span id="l7.681" class="difflineminus">-  BootstrapMonitor.checkAddonNotStarted(ID1);</span>
<a href="#l7.682"></a><span id="l7.682" class="difflineminus">-  equal(getShutdownReason(), ADDON_DISABLE);</span>
<a href="#l7.683"></a><span id="l7.683" class="difflineminus">-  equal(getShutdownNewVersion(), undefined);</span>
<a href="#l7.684"></a><span id="l7.684" class="difflineminus">-  do_check_not_in_crash_annotation(ID1, &quot;1.0&quot;);</span>
<a href="#l7.685"></a><span id="l7.685" class="difflineminus">-</span>
<a href="#l7.686"></a><span id="l7.686" class="difflineminus">-  await b1.uninstall();</span>
<a href="#l7.687"></a><span id="l7.687" class="difflineminus">-  startupCacheMonitor.check(true);</span>
<a href="#l7.688"></a><span id="l7.688" class="difflineminus">-</span>
<a href="#l7.689"></a><span id="l7.689" class="difflineminus">-  ensure_test_completed();</span>
<a href="#l7.690"></a><span id="l7.690" class="difflineminus">-  BootstrapMonitor.checkAddonNotInstalled(ID1);</span>
<a href="#l7.691"></a><span id="l7.691" class="difflineminus">-  BootstrapMonitor.checkAddonNotStarted(ID1);</span>
<a href="#l7.692"></a><span id="l7.692" class="difflineminus">-  do_check_not_in_crash_annotation(ID1, &quot;1.0&quot;);</span>
<a href="#l7.693"></a><span id="l7.693" class="difflineminus">-</span>
<a href="#l7.694"></a><span id="l7.694" class="difflineminus">-  await checkBootstrappedPref();</span>
<a href="#l7.695"></a><span id="l7.695" class="difflineminus">-});</span>
<a href="#l7.696"></a><span id="l7.696" class="difflineminus">-</span>
<a href="#l7.697"></a><span id="l7.697" class="difflineminus">-// Tests that bootstrapped extensions are correctly loaded even if the app is</span>
<a href="#l7.698"></a><span id="l7.698" class="difflineminus">-// upgraded at the same time</span>
<a href="#l7.699"></a><span id="l7.699" class="difflineminus">-add_task(async function test_12() {</span>
<a href="#l7.700"></a><span id="l7.700" class="difflineminus">-  await promiseShutdownManager();</span>
<a href="#l7.701"></a><span id="l7.701" class="difflineminus">-</span>
<a href="#l7.702"></a><span id="l7.702" class="difflineminus">-  await manuallyInstall(XPIS.test_bootstrap1_1, profileDir, ID1);</span>
<a href="#l7.703"></a><span id="l7.703" class="difflineminus">-</span>
<a href="#l7.704"></a><span id="l7.704" class="difflineminus">-  await promiseStartupManager();</span>
<a href="#l7.705"></a><span id="l7.705" class="difflineminus">-</span>
<a href="#l7.706"></a><span id="l7.706" class="difflineminus">-  let b1 = await AddonManager.getAddonByID(ID1);</span>
<a href="#l7.707"></a><span id="l7.707" class="difflineminus">-  notEqual(b1, null);</span>
<a href="#l7.708"></a><span id="l7.708" class="difflineminus">-  equal(b1.version, &quot;1.0&quot;);</span>
<a href="#l7.709"></a><span id="l7.709" class="difflineminus">-  ok(!b1.appDisabled);</span>
<a href="#l7.710"></a><span id="l7.710" class="difflineminus">-  ok(!b1.userDisabled);</span>
<a href="#l7.711"></a><span id="l7.711" class="difflineminus">-  ok(b1.isActive);</span>
<a href="#l7.712"></a><span id="l7.712" class="difflineminus">-  ok(!b1.isSystem);</span>
<a href="#l7.713"></a><span id="l7.713" class="difflineminus">-  BootstrapMonitor.checkAddonInstalled(ID1, &quot;1.0&quot;);</span>
<a href="#l7.714"></a><span id="l7.714" class="difflineminus">-  BootstrapMonitor.checkAddonStarted(ID1, &quot;1.0&quot;);</span>
<a href="#l7.715"></a><span id="l7.715" class="difflineminus">-  equal(getStartupReason(), ADDON_INSTALL);</span>
<a href="#l7.716"></a><span id="l7.716" class="difflineminus">-  equal(getStartupOldVersion(), undefined);</span>
<a href="#l7.717"></a><span id="l7.717" class="difflineminus">-  do_check_in_crash_annotation(ID1, &quot;1.0&quot;);</span>
<a href="#l7.718"></a><span id="l7.718" class="difflineminus">-</span>
<a href="#l7.719"></a><span id="l7.719" class="difflineminus">-  await b1.uninstall();</span>
<a href="#l7.720"></a><span id="l7.720" class="difflineminus">-  startupCacheMonitor.check(true);</span>
<a href="#l7.721"></a><span id="l7.721" class="difflineminus">-</span>
<a href="#l7.722"></a><span id="l7.722" class="difflineminus">-  await promiseRestartManager();</span>
<a href="#l7.723"></a><span id="l7.723" class="difflineminus">-  await checkBootstrappedPref();</span>
<a href="#l7.724"></a><span id="l7.724" class="difflineminus">-});</span>
<a href="#l7.725"></a><span id="l7.725" class="difflineminus">-</span>
<a href="#l7.726"></a><span id="l7.726" class="difflineminus">-// Check that a bootstrapped extension in a non-profile location is loaded</span>
<a href="#l7.727"></a><span id="l7.727" class="difflineminus">-add_task(async function test_17() {</span>
<a href="#l7.728"></a><span id="l7.728" class="difflineminus">-  await promiseShutdownManager();</span>
<a href="#l7.729"></a><span id="l7.729" class="difflineminus">-</span>
<a href="#l7.730"></a><span id="l7.730" class="difflineminus">-  await manuallyInstall(XPIS.test_bootstrap1_1, userExtDir, ID1);</span>
<a href="#l7.731"></a><span id="l7.731" class="difflineminus">-</span>
<a href="#l7.732"></a><span id="l7.732" class="difflineminus">-  await promiseStartupManager();</span>
<a href="#l7.733"></a><span id="l7.733" class="difflineminus">-</span>
<a href="#l7.734"></a><span id="l7.734" class="difflineminus">-  let b1 = await AddonManager.getAddonByID(ID1);</span>
<a href="#l7.735"></a><span id="l7.735" class="difflineminus">-  // Should have installed and started</span>
<a href="#l7.736"></a><span id="l7.736" class="difflineminus">-  BootstrapMonitor.checkAddonInstalled(ID1, &quot;1.0&quot;);</span>
<a href="#l7.737"></a><span id="l7.737" class="difflineminus">-  BootstrapMonitor.checkAddonStarted(ID1, &quot;1.0&quot;);</span>
<a href="#l7.738"></a><span id="l7.738" class="difflineminus">-  notEqual(b1, null);</span>
<a href="#l7.739"></a><span id="l7.739" class="difflineminus">-  equal(b1.version, &quot;1.0&quot;);</span>
<a href="#l7.740"></a><span id="l7.740" class="difflineminus">-  ok(b1.isActive);</span>
<a href="#l7.741"></a><span id="l7.741" class="difflineminus">-  ok(!b1.isSystem);</span>
<a href="#l7.742"></a><span id="l7.742" class="difflineminus">-</span>
<a href="#l7.743"></a><span id="l7.743" class="difflineminus">-  await checkBootstrappedPref();</span>
<a href="#l7.744"></a><span id="l7.744" class="difflineminus">-  startupCacheMonitor.check(false);</span>
<a href="#l7.745"></a><span id="l7.745" class="difflineminus">-});</span>
<a href="#l7.746"></a><span id="l7.746" class="difflineminus">-</span>
<a href="#l7.747"></a><span id="l7.747" class="difflineminus">-// Check that installing a new bootstrapped extension in the profile replaces</span>
<a href="#l7.748"></a><span id="l7.748" class="difflineminus">-// the existing one</span>
<a href="#l7.749"></a><span id="l7.749" class="difflineminus">-add_task(async function test_18() {</span>
<a href="#l7.750"></a><span id="l7.750" class="difflineminus">-  await Promise.all([</span>
<a href="#l7.751"></a><span id="l7.751" class="difflineminus">-    BootstrapMonitor.promiseAddonStartup(ID1),</span>
<a href="#l7.752"></a><span id="l7.752" class="difflineminus">-    promiseInstallFile(XPIS.test_bootstrap1_2),</span>
<a href="#l7.753"></a><span id="l7.753" class="difflineminus">-  ]);</span>
<a href="#l7.754"></a><span id="l7.754" class="difflineminus">-  startupCacheMonitor.check(true);</span>
<a href="#l7.755"></a><span id="l7.755" class="difflineminus">-</span>
<a href="#l7.756"></a><span id="l7.756" class="difflineminus">-  let b1 = await AddonManager.getAddonByID(ID1);</span>
<a href="#l7.757"></a><span id="l7.757" class="difflineminus">-  // Should have installed and started</span>
<a href="#l7.758"></a><span id="l7.758" class="difflineminus">-  BootstrapMonitor.checkAddonInstalled(ID1, &quot;2.0&quot;);</span>
<a href="#l7.759"></a><span id="l7.759" class="difflineminus">-  BootstrapMonitor.checkAddonStarted(ID1, &quot;2.0&quot;);</span>
<a href="#l7.760"></a><span id="l7.760" class="difflineminus">-  notEqual(b1, null);</span>
<a href="#l7.761"></a><span id="l7.761" class="difflineminus">-  equal(b1.version, &quot;2.0&quot;);</span>
<a href="#l7.762"></a><span id="l7.762" class="difflineminus">-  ok(b1.isActive);</span>
<a href="#l7.763"></a><span id="l7.763" class="difflineminus">-  ok(!b1.isSystem);</span>
<a href="#l7.764"></a><span id="l7.764" class="difflineminus">-</span>
<a href="#l7.765"></a><span id="l7.765" class="difflineminus">-  equal(getShutdownReason(), ADDON_UPGRADE);</span>
<a href="#l7.766"></a><span id="l7.766" class="difflineminus">-  equal(getUninstallReason(), ADDON_UPGRADE);</span>
<a href="#l7.767"></a><span id="l7.767" class="difflineminus">-  equal(getInstallReason(), ADDON_UPGRADE);</span>
<a href="#l7.768"></a><span id="l7.768" class="difflineminus">-  equal(getStartupReason(), ADDON_UPGRADE);</span>
<a href="#l7.769"></a><span id="l7.769" class="difflineminus">-</span>
<a href="#l7.770"></a><span id="l7.770" class="difflineminus">-  equal(getShutdownNewVersion(), 2);</span>
<a href="#l7.771"></a><span id="l7.771" class="difflineminus">-  equal(getUninstallNewVersion(), 2);</span>
<a href="#l7.772"></a><span id="l7.772" class="difflineminus">-  equal(getInstallOldVersion(), 1);</span>
<a href="#l7.773"></a><span id="l7.773" class="difflineminus">-  equal(getStartupOldVersion(), 1);</span>
<a href="#l7.774"></a><span id="l7.774" class="difflineminus">-</span>
<a href="#l7.775"></a><span id="l7.775" class="difflineminus">-  await checkBootstrappedPref();</span>
<a href="#l7.776"></a><span id="l7.776" class="difflineminus">-  startupCacheMonitor.check(false);</span>
<a href="#l7.777"></a><span id="l7.777" class="difflineminus">-});</span>
<a href="#l7.778"></a><span id="l7.778" class="difflineminus">-</span>
<a href="#l7.779"></a><span id="l7.779" class="difflineminus">-// Check that uninstalling the profile version reveals the non-profile one</span>
<a href="#l7.780"></a><span id="l7.780" class="difflineminus">-add_task(async function test_19() {</span>
<a href="#l7.781"></a><span id="l7.781" class="difflineminus">-  let b1 = await AddonManager.getAddonByID(ID1);</span>
<a href="#l7.782"></a><span id="l7.782" class="difflineminus">-  // The revealed add-on gets activated asynchronously</span>
<a href="#l7.783"></a><span id="l7.783" class="difflineminus">-  await new Promise(resolve =&gt; {</span>
<a href="#l7.784"></a><span id="l7.784" class="difflineminus">-    prepare_test(</span>
<a href="#l7.785"></a><span id="l7.785" class="difflineminus">-      {</span>
<a href="#l7.786"></a><span id="l7.786" class="difflineminus">-        [ID1]: [</span>
<a href="#l7.787"></a><span id="l7.787" class="difflineminus">-          [&quot;onUninstalling&quot;, false],</span>
<a href="#l7.788"></a><span id="l7.788" class="difflineminus">-          &quot;onUninstalled&quot;,</span>
<a href="#l7.789"></a><span id="l7.789" class="difflineminus">-          [&quot;onInstalling&quot;, false],</span>
<a href="#l7.790"></a><span id="l7.790" class="difflineminus">-          &quot;onInstalled&quot;,</span>
<a href="#l7.791"></a><span id="l7.791" class="difflineminus">-        ],</span>
<a href="#l7.792"></a><span id="l7.792" class="difflineminus">-      },</span>
<a href="#l7.793"></a><span id="l7.793" class="difflineminus">-      [],</span>
<a href="#l7.794"></a><span id="l7.794" class="difflineminus">-      resolve</span>
<a href="#l7.795"></a><span id="l7.795" class="difflineminus">-    );</span>
<a href="#l7.796"></a><span id="l7.796" class="difflineminus">-</span>
<a href="#l7.797"></a><span id="l7.797" class="difflineminus">-    b1.uninstall();</span>
<a href="#l7.798"></a><span id="l7.798" class="difflineminus">-  });</span>
<a href="#l7.799"></a><span id="l7.799" class="difflineminus">-</span>
<a href="#l7.800"></a><span id="l7.800" class="difflineminus">-  startupCacheMonitor.check(true);</span>
<a href="#l7.801"></a><span id="l7.801" class="difflineminus">-</span>
<a href="#l7.802"></a><span id="l7.802" class="difflineminus">-  b1 = await AddonManager.getAddonByID(ID1);</span>
<a href="#l7.803"></a><span id="l7.803" class="difflineminus">-  // Should have reverted to the older version</span>
<a href="#l7.804"></a><span id="l7.804" class="difflineminus">-  BootstrapMonitor.checkAddonInstalled(ID1, &quot;1.0&quot;);</span>
<a href="#l7.805"></a><span id="l7.805" class="difflineminus">-  BootstrapMonitor.checkAddonStarted(ID1, &quot;1.0&quot;);</span>
<a href="#l7.806"></a><span id="l7.806" class="difflineminus">-  notEqual(b1, null);</span>
<a href="#l7.807"></a><span id="l7.807" class="difflineminus">-  equal(b1.version, &quot;1.0&quot;);</span>
<a href="#l7.808"></a><span id="l7.808" class="difflineminus">-  ok(b1.isActive);</span>
<a href="#l7.809"></a><span id="l7.809" class="difflineminus">-  ok(!b1.isSystem);</span>
<a href="#l7.810"></a><span id="l7.810" class="difflineminus">-</span>
<a href="#l7.811"></a><span id="l7.811" class="difflineminus">-  equal(getShutdownReason(), ADDON_DOWNGRADE);</span>
<a href="#l7.812"></a><span id="l7.812" class="difflineminus">-  equal(getUninstallReason(), ADDON_DOWNGRADE);</span>
<a href="#l7.813"></a><span id="l7.813" class="difflineminus">-  equal(getInstallReason(), ADDON_DOWNGRADE);</span>
<a href="#l7.814"></a><span id="l7.814" class="difflineminus">-  equal(getStartupReason(), ADDON_DOWNGRADE);</span>
<a href="#l7.815"></a><span id="l7.815" class="difflineminus">-</span>
<a href="#l7.816"></a><span id="l7.816" class="difflineminus">-  equal(getShutdownNewVersion(), &quot;1.0&quot;);</span>
<a href="#l7.817"></a><span id="l7.817" class="difflineminus">-  equal(getUninstallNewVersion(), &quot;1.0&quot;);</span>
<a href="#l7.818"></a><span id="l7.818" class="difflineminus">-  equal(getInstallOldVersion(), &quot;2.0&quot;);</span>
<a href="#l7.819"></a><span id="l7.819" class="difflineminus">-  equal(getStartupOldVersion(), &quot;2.0&quot;);</span>
<a href="#l7.820"></a><span id="l7.820" class="difflineminus">-</span>
<a href="#l7.821"></a><span id="l7.821" class="difflineminus">-  await checkBootstrappedPref();</span>
<a href="#l7.822"></a><span id="l7.822" class="difflineminus">-  startupCacheMonitor.check(false);</span>
<a href="#l7.823"></a><span id="l7.823" class="difflineminus">-});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1">deleted file mode 100644</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineminus">--- a/common/test/xpcshell/test_bootstrap_const.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineplus">+++ /dev/null</span>
<a href="#l8.4"></a><span id="l8.4" class="difflineat">@@ -1,38 +0,0 @@</span>
<a href="#l8.5"></a><span id="l8.5" class="difflineminus">-/* Any copyright is dedicated to the Public Domain.</span>
<a href="#l8.6"></a><span id="l8.6" class="difflineminus">- * http://creativecommons.org/publicdomain/zero/1.0/</span>
<a href="#l8.7"></a><span id="l8.7" class="difflineminus">- */</span>
<a href="#l8.8"></a><span id="l8.8" class="difflineminus">-</span>
<a href="#l8.9"></a><span id="l8.9" class="difflineminus">-createAppInfo(&quot;xpcshell@tests.mozilla.org&quot;, &quot;XPCShell&quot;, &quot;1&quot;, &quot;1&quot;);</span>
<a href="#l8.10"></a><span id="l8.10" class="difflineminus">-</span>
<a href="#l8.11"></a><span id="l8.11" class="difflineminus">-const ADDONS = {</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-  test_bootstrap_const: {</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineminus">-    &quot;manifest.json&quot;: JSON.stringify({</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineminus">-      applications: {</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineminus">-        gecko: {</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineminus">-          id: &quot;bootstrap@tests.mozilla.org&quot;,</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineminus">-        },</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineminus">-      },</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineminus">-      legacy: {</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineminus">-        type: &quot;bootstrap&quot;,</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineminus">-      },</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineminus">-      manifest_version: 2,</span>
<a href="#l8.23"></a><span id="l8.23" class="difflineminus">-      name: &quot;Test Bootstrap 1&quot;,</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineminus">-      version: &quot;1.0&quot;,</span>
<a href="#l8.25"></a><span id="l8.25" class="difflineminus">-    }),</span>
<a href="#l8.26"></a><span id="l8.26" class="difflineminus">-    &quot;bootstrap.js&quot;:</span>
<a href="#l8.27"></a><span id="l8.27" class="difflineminus">-      'var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);\n\nconst install = function() {\n  Services.obs.notifyObservers(null, &quot;addon-install&quot;);\n};\n',</span>
<a href="#l8.28"></a><span id="l8.28" class="difflineminus">-  },</span>
<a href="#l8.29"></a><span id="l8.29" class="difflineminus">-};</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineminus">-</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineminus">-add_task(async function() {</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineminus">-  await promiseStartupManager();</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineminus">-</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineminus">-  let sawInstall = false;</span>
<a href="#l8.35"></a><span id="l8.35" class="difflineminus">-  Services.obs.addObserver(function() {</span>
<a href="#l8.36"></a><span id="l8.36" class="difflineminus">-    sawInstall = true;</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineminus">-  }, &quot;addon-install&quot;);</span>
<a href="#l8.38"></a><span id="l8.38" class="difflineminus">-</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineminus">-  await AddonTestUtils.promiseInstallXPI(ADDONS.test_bootstrap_const);</span>
<a href="#l8.40"></a><span id="l8.40" class="difflineminus">-</span>
<a href="#l8.41"></a><span id="l8.41" class="difflineminus">-  ok(sawInstall);</span>
<a href="#l8.42"></a><span id="l8.42" class="difflineminus">-});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1">deleted file mode 100644</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineminus">--- a/common/test/xpcshell/test_bootstrap_globals.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineplus">+++ /dev/null</span>
<a href="#l9.4"></a><span id="l9.4" class="difflineat">@@ -1,74 +0,0 @@</span>
<a href="#l9.5"></a><span id="l9.5" class="difflineminus">-/* Any copyright is dedicated to the Public Domain.</span>
<a href="#l9.6"></a><span id="l9.6" class="difflineminus">- * http://creativecommons.org/publicdomain/zero/1.0/</span>
<a href="#l9.7"></a><span id="l9.7" class="difflineminus">- */</span>
<a href="#l9.8"></a><span id="l9.8" class="difflineminus">-</span>
<a href="#l9.9"></a><span id="l9.9" class="difflineminus">-// This verifies that bootstrap.js has the expected globals defined</span>
<a href="#l9.10"></a><span id="l9.10" class="difflineminus">-var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l9.11"></a><span id="l9.11" class="difflineminus">-</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-createAppInfo(&quot;xpcshell@tests.mozilla.org&quot;, &quot;XPCShell&quot;, &quot;1&quot;, &quot;1&quot;);</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineminus">-</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineminus">-const ADDONS = {</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineminus">-  bootstrap_globals: {</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineminus">-    &quot;manifest.json&quot;: JSON.stringify({</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineminus">-      applications: {</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineminus">-        gecko: {</span>
<a href="#l9.19"></a><span id="l9.19" class="difflineminus">-          id: &quot;bootstrap_globals@tests.mozilla.org&quot;,</span>
<a href="#l9.20"></a><span id="l9.20" class="difflineminus">-        },</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineminus">-      },</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineminus">-      legacy: {</span>
<a href="#l9.23"></a><span id="l9.23" class="difflineminus">-        type: &quot;bootstrap&quot;,</span>
<a href="#l9.24"></a><span id="l9.24" class="difflineminus">-      },</span>
<a href="#l9.25"></a><span id="l9.25" class="difflineminus">-      manifest_version: 2,</span>
<a href="#l9.26"></a><span id="l9.26" class="difflineminus">-      name: &quot;Test Bootstrap 1&quot;,</span>
<a href="#l9.27"></a><span id="l9.27" class="difflineminus">-      version: &quot;1.0&quot;,</span>
<a href="#l9.28"></a><span id="l9.28" class="difflineminus">-    }),</span>
<a href="#l9.29"></a><span id="l9.29" class="difflineminus">-    &quot;bootstrap.js&quot;: String.raw`var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l9.30"></a><span id="l9.30" class="difflineminus">-</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineminus">-var seenGlobals = new Set();</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineminus">-var scope = this;</span>
<a href="#l9.33"></a><span id="l9.33" class="difflineminus">-function checkGlobal(name, type) {</span>
<a href="#l9.34"></a><span id="l9.34" class="difflineminus">-  if (scope[name] &amp;&amp; typeof(scope[name]) == type)</span>
<a href="#l9.35"></a><span id="l9.35" class="difflineminus">-    seenGlobals.add(name);</span>
<a href="#l9.36"></a><span id="l9.36" class="difflineminus">-}</span>
<a href="#l9.37"></a><span id="l9.37" class="difflineminus">-</span>
<a href="#l9.38"></a><span id="l9.38" class="difflineminus">-var wrapped = {};</span>
<a href="#l9.39"></a><span id="l9.39" class="difflineminus">-Services.obs.notifyObservers({ wrappedJSObject: wrapped }, &quot;bootstrap-request-globals&quot;);</span>
<a href="#l9.40"></a><span id="l9.40" class="difflineminus">-for (let [name, type] of wrapped.expectedGlobals) {</span>
<a href="#l9.41"></a><span id="l9.41" class="difflineminus">-  checkGlobal(name, type);</span>
<a href="#l9.42"></a><span id="l9.42" class="difflineminus">-}</span>
<a href="#l9.43"></a><span id="l9.43" class="difflineminus">-</span>
<a href="#l9.44"></a><span id="l9.44" class="difflineminus">-function startup(data, reason) {</span>
<a href="#l9.45"></a><span id="l9.45" class="difflineminus">-  Services.obs.notifyObservers({ wrappedJSObject: seenGlobals }, &quot;bootstrap-seen-globals&quot;);</span>
<a href="#l9.46"></a><span id="l9.46" class="difflineminus">-}</span>
<a href="#l9.47"></a><span id="l9.47" class="difflineminus">-</span>
<a href="#l9.48"></a><span id="l9.48" class="difflineminus">-function install(data, reason) {}</span>
<a href="#l9.49"></a><span id="l9.49" class="difflineminus">-function shutdown(data, reason) {}</span>
<a href="#l9.50"></a><span id="l9.50" class="difflineminus">-function uninstall(data, reason) {}</span>
<a href="#l9.51"></a><span id="l9.51" class="difflineminus">-`,</span>
<a href="#l9.52"></a><span id="l9.52" class="difflineminus">-  },</span>
<a href="#l9.53"></a><span id="l9.53" class="difflineminus">-};</span>
<a href="#l9.54"></a><span id="l9.54" class="difflineminus">-</span>
<a href="#l9.55"></a><span id="l9.55" class="difflineminus">-const EXPECTED_GLOBALS = [[&quot;console&quot;, &quot;object&quot;]];</span>
<a href="#l9.56"></a><span id="l9.56" class="difflineminus">-</span>
<a href="#l9.57"></a><span id="l9.57" class="difflineminus">-async function run_test() {</span>
<a href="#l9.58"></a><span id="l9.58" class="difflineminus">-  do_test_pending();</span>
<a href="#l9.59"></a><span id="l9.59" class="difflineminus">-  await promiseStartupManager();</span>
<a href="#l9.60"></a><span id="l9.60" class="difflineminus">-  let sawGlobals = false;</span>
<a href="#l9.61"></a><span id="l9.61" class="difflineminus">-</span>
<a href="#l9.62"></a><span id="l9.62" class="difflineminus">-  Services.obs.addObserver(function(subject) {</span>
<a href="#l9.63"></a><span id="l9.63" class="difflineminus">-    subject.wrappedJSObject.expectedGlobals = EXPECTED_GLOBALS;</span>
<a href="#l9.64"></a><span id="l9.64" class="difflineminus">-  }, &quot;bootstrap-request-globals&quot;);</span>
<a href="#l9.65"></a><span id="l9.65" class="difflineminus">-</span>
<a href="#l9.66"></a><span id="l9.66" class="difflineminus">-  Services.obs.addObserver(function({ wrappedJSObject: seenGlobals }) {</span>
<a href="#l9.67"></a><span id="l9.67" class="difflineminus">-    for (let [name] of EXPECTED_GLOBALS) {</span>
<a href="#l9.68"></a><span id="l9.68" class="difflineminus">-      Assert.ok(seenGlobals.has(name));</span>
<a href="#l9.69"></a><span id="l9.69" class="difflineminus">-    }</span>
<a href="#l9.70"></a><span id="l9.70" class="difflineminus">-</span>
<a href="#l9.71"></a><span id="l9.71" class="difflineminus">-    sawGlobals = true;</span>
<a href="#l9.72"></a><span id="l9.72" class="difflineminus">-  }, &quot;bootstrap-seen-globals&quot;);</span>
<a href="#l9.73"></a><span id="l9.73" class="difflineminus">-</span>
<a href="#l9.74"></a><span id="l9.74" class="difflineminus">-  await AddonTestUtils.promiseInstallXPI(ADDONS.bootstrap_globals);</span>
<a href="#l9.75"></a><span id="l9.75" class="difflineminus">-  Assert.ok(sawGlobals);</span>
<a href="#l9.76"></a><span id="l9.76" class="difflineminus">-  await promiseShutdownManager();</span>
<a href="#l9.77"></a><span id="l9.77" class="difflineminus">-  do_test_finished();</span>
<a href="#l9.78"></a><span id="l9.78" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1">deleted file mode 100644</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineminus">--- a/common/test/xpcshell/test_bootstrapped_chrome_manifest.js</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineplus">+++ /dev/null</span>
<a href="#l10.4"></a><span id="l10.4" class="difflineat">@@ -1,63 +0,0 @@</span>
<a href="#l10.5"></a><span id="l10.5" class="difflineminus">-/* Any copyright is dedicated to the Public Domain.</span>
<a href="#l10.6"></a><span id="l10.6" class="difflineminus">- * http://creativecommons.org/publicdomain/zero/1.0/</span>
<a href="#l10.7"></a><span id="l10.7" class="difflineminus">- */</span>
<a href="#l10.8"></a><span id="l10.8" class="difflineminus">-</span>
<a href="#l10.9"></a><span id="l10.9" class="difflineminus">-const ADDON = {</span>
<a href="#l10.10"></a><span id="l10.10" class="difflineminus">-  &quot;manifest.json&quot;: JSON.stringify({</span>
<a href="#l10.11"></a><span id="l10.11" class="difflineminus">-    applications: {</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-      gecko: {</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineminus">-        id: &quot;bug675371@tests.mozilla.org&quot;,</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineminus">-      },</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineminus">-    },</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineminus">-    legacy: {</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineminus">-      type: &quot;bootstrap&quot;,</span>
<a href="#l10.18"></a><span id="l10.18" class="difflineminus">-    },</span>
<a href="#l10.19"></a><span id="l10.19" class="difflineminus">-    manifest_version: 2,</span>
<a href="#l10.20"></a><span id="l10.20" class="difflineminus">-    name: &quot;Test Bootstrap 1&quot;,</span>
<a href="#l10.21"></a><span id="l10.21" class="difflineminus">-    version: &quot;1.0&quot;,</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineminus">-  }),</span>
<a href="#l10.23"></a><span id="l10.23" class="difflineminus">-  &quot;chrome.manifest&quot;: `content bug675371 .`,</span>
<a href="#l10.24"></a><span id="l10.24" class="difflineminus">-  &quot;test.js&quot;: `var active = true;`,</span>
<a href="#l10.25"></a><span id="l10.25" class="difflineminus">-};</span>
<a href="#l10.26"></a><span id="l10.26" class="difflineminus">-</span>
<a href="#l10.27"></a><span id="l10.27" class="difflineminus">-add_task(async function run_test() {</span>
<a href="#l10.28"></a><span id="l10.28" class="difflineminus">-  createAppInfo(&quot;xpcshell@tests.mozilla.org&quot;, &quot;XPCShell&quot;, &quot;1&quot;, &quot;1.9.2&quot;);</span>
<a href="#l10.29"></a><span id="l10.29" class="difflineminus">-  await promiseStartupManager();</span>
<a href="#l10.30"></a><span id="l10.30" class="difflineminus">-});</span>
<a href="#l10.31"></a><span id="l10.31" class="difflineminus">-</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineminus">-function checkActive(expected) {</span>
<a href="#l10.33"></a><span id="l10.33" class="difflineminus">-  let target = { active: false };</span>
<a href="#l10.34"></a><span id="l10.34" class="difflineminus">-  let load = () =&gt; {</span>
<a href="#l10.35"></a><span id="l10.35" class="difflineminus">-    Services.scriptloader.loadSubScript(</span>
<a href="#l10.36"></a><span id="l10.36" class="difflineminus">-      &quot;chrome://bug675371/content/test.js&quot;,</span>
<a href="#l10.37"></a><span id="l10.37" class="difflineminus">-      target</span>
<a href="#l10.38"></a><span id="l10.38" class="difflineminus">-    );</span>
<a href="#l10.39"></a><span id="l10.39" class="difflineminus">-  };</span>
<a href="#l10.40"></a><span id="l10.40" class="difflineminus">-</span>
<a href="#l10.41"></a><span id="l10.41" class="difflineminus">-  if (expected) {</span>
<a href="#l10.42"></a><span id="l10.42" class="difflineminus">-    load();</span>
<a href="#l10.43"></a><span id="l10.43" class="difflineminus">-  } else {</span>
<a href="#l10.44"></a><span id="l10.44" class="difflineminus">-    Assert.throws(load, /Error opening input stream/);</span>
<a href="#l10.45"></a><span id="l10.45" class="difflineminus">-  }</span>
<a href="#l10.46"></a><span id="l10.46" class="difflineminus">-  equal(target.active, expected, &quot;Manifest is active?&quot;);</span>
<a href="#l10.47"></a><span id="l10.47" class="difflineminus">-}</span>
<a href="#l10.48"></a><span id="l10.48" class="difflineminus">-</span>
<a href="#l10.49"></a><span id="l10.49" class="difflineminus">-add_task(async function test() {</span>
<a href="#l10.50"></a><span id="l10.50" class="difflineminus">-  let { addon } = await AddonTestUtils.promiseInstallXPI(ADDON);</span>
<a href="#l10.51"></a><span id="l10.51" class="difflineminus">-</span>
<a href="#l10.52"></a><span id="l10.52" class="difflineminus">-  Assert.ok(addon.isActive);</span>
<a href="#l10.53"></a><span id="l10.53" class="difflineminus">-</span>
<a href="#l10.54"></a><span id="l10.54" class="difflineminus">-  // Tests that chrome.manifest is registered when the addon is installed.</span>
<a href="#l10.55"></a><span id="l10.55" class="difflineminus">-  checkActive(true);</span>
<a href="#l10.56"></a><span id="l10.56" class="difflineminus">-</span>
<a href="#l10.57"></a><span id="l10.57" class="difflineminus">-  await addon.disable();</span>
<a href="#l10.58"></a><span id="l10.58" class="difflineminus">-  checkActive(false);</span>
<a href="#l10.59"></a><span id="l10.59" class="difflineminus">-</span>
<a href="#l10.60"></a><span id="l10.60" class="difflineminus">-  await addon.enable();</span>
<a href="#l10.61"></a><span id="l10.61" class="difflineminus">-  checkActive(true);</span>
<a href="#l10.62"></a><span id="l10.62" class="difflineminus">-</span>
<a href="#l10.63"></a><span id="l10.63" class="difflineminus">-  await promiseShutdownManager();</span>
<a href="#l10.64"></a><span id="l10.64" class="difflineminus">-</span>
<a href="#l10.65"></a><span id="l10.65" class="difflineminus">-  // Tests that chrome.manifest remains registered at app shutdown.</span>
<a href="#l10.66"></a><span id="l10.66" class="difflineminus">-  checkActive(true);</span>
<a href="#l10.67"></a><span id="l10.67" class="difflineminus">-});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1">deleted file mode 100644</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineminus">--- a/common/test/xpcshell/xpcshell.ini</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineplus">+++ /dev/null</span>
<a href="#l11.4"></a><span id="l11.4" class="difflineat">@@ -1,10 +0,0 @@</span>
<a href="#l11.5"></a><span id="l11.5" class="difflineminus">-[DEFAULT]</span>
<a href="#l11.6"></a><span id="l11.6" class="difflineminus">-tags = addons</span>
<a href="#l11.7"></a><span id="l11.7" class="difflineminus">-head = head_addons.js</span>
<a href="#l11.8"></a><span id="l11.8" class="difflineminus">-support-files =</span>
<a href="#l11.9"></a><span id="l11.9" class="difflineminus">-  data/**</span>
<a href="#l11.10"></a><span id="l11.10" class="difflineminus">-</span>
<a href="#l11.11"></a><span id="l11.11" class="difflineminus">-[test_bootstrap.js]</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-[test_bootstrap_const.js]</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineminus">-[test_bootstrap_globals.js]</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineminus">-[test_bootstrapped_chrome_manifest.js]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mail/base/content/aboutAddonsExtra.js</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mail/base/content/aboutAddonsExtra.js</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -1,26 +1,14 @@</span>
<a href="#l12.4"></a><span id="l12.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l12.5"></a><span id="l12.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l12.6"></a><span id="l12.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l12.7"></a><span id="l12.7"> </span>
<a href="#l12.8"></a><span id="l12.8"> /* import-globals-from ../../../../toolkit/mozapps/extensions/content/aboutaddons.js */</span>
<a href="#l12.9"></a><span id="l12.9"> </span>
<a href="#l12.10"></a><span id="l12.10" class="difflineminus">-var { ExtensionSupport } = ChromeUtils.import(</span>
<a href="#l12.11"></a><span id="l12.11" class="difflineminus">-  &quot;resource:///modules/ExtensionSupport.jsm&quot;</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-);</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineminus">-var { BrowserUtils } = ChromeUtils.import(</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineminus">-  &quot;resource://gre/modules/BrowserUtils.jsm&quot;</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineminus">-);</span>
<a href="#l12.16"></a><span id="l12.16" class="difflineminus">-</span>
<a href="#l12.17"></a><span id="l12.17" class="difflineminus">-var mailExtBundle = Services.strings.createBundle(</span>
<a href="#l12.18"></a><span id="l12.18" class="difflineminus">-  &quot;chrome://messenger/locale/extensionsOverlay.properties&quot;</span>
<a href="#l12.19"></a><span id="l12.19" class="difflineminus">-);</span>
<a href="#l12.20"></a><span id="l12.20" class="difflineminus">-var extensionsNeedingRestart = new Set();</span>
<a href="#l12.21"></a><span id="l12.21" class="difflineminus">-</span>
<a href="#l12.22"></a><span id="l12.22"> const THUNDERBIRD_THEME_PREVIEWS = new Map([</span>
<a href="#l12.23"></a><span id="l12.23">   [</span>
<a href="#l12.24"></a><span id="l12.24">     &quot;thunderbird-compact-light@mozilla.org&quot;,</span>
<a href="#l12.25"></a><span id="l12.25">     &quot;chrome://mozapps/content/extensions/firefox-compact-light.svg&quot;,</span>
<a href="#l12.26"></a><span id="l12.26">   ],</span>
<a href="#l12.27"></a><span id="l12.27">   [</span>
<a href="#l12.28"></a><span id="l12.28">     &quot;thunderbird-compact-dark@mozilla.org&quot;,</span>
<a href="#l12.29"></a><span id="l12.29">     &quot;chrome://mozapps/content/extensions/firefox-compact-dark.svg&quot;,</span>
<a href="#l12.30"></a><span id="l12.30" class="difflineat">@@ -62,136 +50,9 @@ const THUNDERBIRD_THEME_PREVIEWS = new M</span>
<a href="#l12.31"></a><span id="l12.31"> </span>
<a href="#l12.32"></a><span id="l12.32">   let _getScreenshotUrlForAddon = getScreenshotUrlForAddon;</span>
<a href="#l12.33"></a><span id="l12.33">   getScreenshotUrlForAddon = function(addon) {</span>
<a href="#l12.34"></a><span id="l12.34">     if (THUNDERBIRD_THEME_PREVIEWS.has(addon.id)) {</span>
<a href="#l12.35"></a><span id="l12.35">       return THUNDERBIRD_THEME_PREVIEWS.get(addon.id);</span>
<a href="#l12.36"></a><span id="l12.36">     }</span>
<a href="#l12.37"></a><span id="l12.37">     return _getScreenshotUrlForAddon(addon);</span>
<a href="#l12.38"></a><span id="l12.38">   };</span>
<a href="#l12.39"></a><span id="l12.39" class="difflineminus">-</span>
<a href="#l12.40"></a><span id="l12.40" class="difflineminus">-  let _getAddonMessageInfo = getAddonMessageInfo;</span>
<a href="#l12.41"></a><span id="l12.41" class="difflineminus">-  getAddonMessageInfo = async function(addon) {</span>
<a href="#l12.42"></a><span id="l12.42" class="difflineminus">-    let result = await _getAddonMessageInfo(addon);</span>
<a href="#l12.43"></a><span id="l12.43" class="difflineminus">-    if (!result.message) {</span>
<a href="#l12.44"></a><span id="l12.44" class="difflineminus">-      let { stringName } = getTrueState(addon, &quot;gDetailView._addon&quot;);</span>
<a href="#l12.45"></a><span id="l12.45" class="difflineminus">-      if (stringName) {</span>
<a href="#l12.46"></a><span id="l12.46" class="difflineminus">-        result.message = mailExtBundle.formatStringFromName(stringName, [</span>
<a href="#l12.47"></a><span id="l12.47" class="difflineminus">-          addon.name,</span>
<a href="#l12.48"></a><span id="l12.48" class="difflineminus">-          brandBundle.GetStringFromName(&quot;brandShortName&quot;),</span>
<a href="#l12.49"></a><span id="l12.49" class="difflineminus">-        ]);</span>
<a href="#l12.50"></a><span id="l12.50" class="difflineminus">-        result.type = &quot;success&quot;;</span>
<a href="#l12.51"></a><span id="l12.51" class="difflineminus">-        extensionsNeedingRestart.add(addon.id);</span>
<a href="#l12.52"></a><span id="l12.52" class="difflineminus">-      } else {</span>
<a href="#l12.53"></a><span id="l12.53" class="difflineminus">-        extensionsNeedingRestart.delete(addon.id);</span>
<a href="#l12.54"></a><span id="l12.54" class="difflineminus">-      }</span>
<a href="#l12.55"></a><span id="l12.55" class="difflineminus">-      setRestartBar();</span>
<a href="#l12.56"></a><span id="l12.56" class="difflineminus">-    }</span>
<a href="#l12.57"></a><span id="l12.57" class="difflineminus">-    return result;</span>
<a href="#l12.58"></a><span id="l12.58" class="difflineminus">-  };</span>
<a href="#l12.59"></a><span id="l12.59" class="difflineminus">-</span>
<a href="#l12.60"></a><span id="l12.60" class="difflineminus">-  let listener = {</span>
<a href="#l12.61"></a><span id="l12.61" class="difflineminus">-    onUninstalling(addon) {</span>
<a href="#l12.62"></a><span id="l12.62" class="difflineminus">-      if (ExtensionSupport.loadedLegacyExtensions.hasAnyState(addon.id)) {</span>
<a href="#l12.63"></a><span id="l12.63" class="difflineminus">-        extensionsNeedingRestart.add(addon.id);</span>
<a href="#l12.64"></a><span id="l12.64" class="difflineminus">-        setRestartBar();</span>
<a href="#l12.65"></a><span id="l12.65" class="difflineminus">-      }</span>
<a href="#l12.66"></a><span id="l12.66" class="difflineminus">-    },</span>
<a href="#l12.67"></a><span id="l12.67" class="difflineminus">-    onUninstalled(addon) {</span>
<a href="#l12.68"></a><span id="l12.68" class="difflineminus">-      if (ExtensionSupport.loadedLegacyExtensions.hasAnyState(addon.id)) {</span>
<a href="#l12.69"></a><span id="l12.69" class="difflineminus">-        extensionsNeedingRestart.add(addon.id);</span>
<a href="#l12.70"></a><span id="l12.70" class="difflineminus">-        setRestartBar();</span>
<a href="#l12.71"></a><span id="l12.71" class="difflineminus">-      }</span>
<a href="#l12.72"></a><span id="l12.72" class="difflineminus">-    },</span>
<a href="#l12.73"></a><span id="l12.73" class="difflineminus">-  };</span>
<a href="#l12.74"></a><span id="l12.74" class="difflineminus">-  AddonManager.addAddonListener(listener);</span>
<a href="#l12.75"></a><span id="l12.75" class="difflineminus">-  window.addEventListener(&quot;unload&quot;, () =&gt;</span>
<a href="#l12.76"></a><span id="l12.76" class="difflineminus">-    AddonManager.removeAddonListener(listener)</span>
<a href="#l12.77"></a><span id="l12.77" class="difflineminus">-  );</span>
<a href="#l12.78"></a><span id="l12.78" class="difflineminus">-</span>
<a href="#l12.79"></a><span id="l12.79" class="difflineminus">-  // If a legacy extension has been removed, it needs a restart but is not in the list</span>
<a href="#l12.80"></a><span id="l12.80" class="difflineminus">-  // - show the restart bar anyway.</span>
<a href="#l12.81"></a><span id="l12.81" class="difflineminus">-  let removed = await ExtensionSupport.loadedLegacyExtensions.listRemoved();</span>
<a href="#l12.82"></a><span id="l12.82" class="difflineminus">-  for (let removedExtension of removed) {</span>
<a href="#l12.83"></a><span id="l12.83" class="difflineminus">-    extensionsNeedingRestart.add(removedExtension.id);</span>
<a href="#l12.84"></a><span id="l12.84" class="difflineminus">-  }</span>
<a href="#l12.85"></a><span id="l12.85" class="difflineminus">-  setRestartBar();</span>
<a href="#l12.86"></a><span id="l12.86"> })();</span>
<a href="#l12.87"></a><span id="l12.87" class="difflineminus">-</span>
<a href="#l12.88"></a><span id="l12.88" class="difflineminus">-function setRestartBar() {</span>
<a href="#l12.89"></a><span id="l12.89" class="difflineminus">-  let list = document.querySelector(&quot;addon-list&quot;);</span>
<a href="#l12.90"></a><span id="l12.90" class="difflineminus">-  if (!list || list.type != &quot;extension&quot;) {</span>
<a href="#l12.91"></a><span id="l12.91" class="difflineminus">-    return;</span>
<a href="#l12.92"></a><span id="l12.92" class="difflineminus">-  }</span>
<a href="#l12.93"></a><span id="l12.93" class="difflineminus">-</span>
<a href="#l12.94"></a><span id="l12.94" class="difflineminus">-  let restartBar = document.getElementById(&quot;restartBar&quot;);</span>
<a href="#l12.95"></a><span id="l12.95" class="difflineminus">-  if (extensionsNeedingRestart.size == 0) {</span>
<a href="#l12.96"></a><span id="l12.96" class="difflineminus">-    if (restartBar) {</span>
<a href="#l12.97"></a><span id="l12.97" class="difflineminus">-      restartBar.remove();</span>
<a href="#l12.98"></a><span id="l12.98" class="difflineminus">-    }</span>
<a href="#l12.99"></a><span id="l12.99" class="difflineminus">-    return;</span>
<a href="#l12.100"></a><span id="l12.100" class="difflineminus">-  }</span>
<a href="#l12.101"></a><span id="l12.101" class="difflineminus">-  if (restartBar) {</span>
<a href="#l12.102"></a><span id="l12.102" class="difflineminus">-    return;</span>
<a href="#l12.103"></a><span id="l12.103" class="difflineminus">-  }</span>
<a href="#l12.104"></a><span id="l12.104" class="difflineminus">-</span>
<a href="#l12.105"></a><span id="l12.105" class="difflineminus">-  restartBar = document.createElement(&quot;message-bar&quot;);</span>
<a href="#l12.106"></a><span id="l12.106" class="difflineminus">-  restartBar.id = &quot;restartBar&quot;;</span>
<a href="#l12.107"></a><span id="l12.107" class="difflineminus">-  restartBar.setAttribute(&quot;type&quot;, &quot;warning&quot;);</span>
<a href="#l12.108"></a><span id="l12.108" class="difflineminus">-</span>
<a href="#l12.109"></a><span id="l12.109" class="difflineminus">-  const message = document.createElement(&quot;span&quot;);</span>
<a href="#l12.110"></a><span id="l12.110" class="difflineminus">-  message.textContent = mailExtBundle.formatStringFromName(</span>
<a href="#l12.111"></a><span id="l12.111" class="difflineminus">-    &quot;globalRestartMessage&quot;,</span>
<a href="#l12.112"></a><span id="l12.112" class="difflineminus">-    [brandBundle.GetStringFromName(&quot;brandShortName&quot;)]</span>
<a href="#l12.113"></a><span id="l12.113" class="difflineminus">-  );</span>
<a href="#l12.114"></a><span id="l12.114" class="difflineminus">-</span>
<a href="#l12.115"></a><span id="l12.115" class="difflineminus">-  const restart = document.createElement(&quot;button&quot;);</span>
<a href="#l12.116"></a><span id="l12.116" class="difflineminus">-  restart.textContent = mailExtBundle.GetStringFromName(&quot;globalRestartButton&quot;);</span>
<a href="#l12.117"></a><span id="l12.117" class="difflineminus">-  restart.addEventListener(&quot;click&quot;, () =&gt; {</span>
<a href="#l12.118"></a><span id="l12.118" class="difflineminus">-    BrowserUtils.restartApplication();</span>
<a href="#l12.119"></a><span id="l12.119" class="difflineminus">-  });</span>
<a href="#l12.120"></a><span id="l12.120" class="difflineminus">-</span>
<a href="#l12.121"></a><span id="l12.121" class="difflineminus">-  restartBar.append(message, restart);</span>
<a href="#l12.122"></a><span id="l12.122" class="difflineminus">-  list.pendingUninstallStack.append(restartBar);</span>
<a href="#l12.123"></a><span id="l12.123" class="difflineminus">-}</span>
<a href="#l12.124"></a><span id="l12.124" class="difflineminus">-</span>
<a href="#l12.125"></a><span id="l12.125" class="difflineminus">-/**</span>
<a href="#l12.126"></a><span id="l12.126" class="difflineminus">- * The true status of legacy extensions, which AddonManager doesn't know</span>
<a href="#l12.127"></a><span id="l12.127" class="difflineminus">- * about because it thinks all extensions are restartless.</span>
<a href="#l12.128"></a><span id="l12.128" class="difflineminus">- *</span>
<a href="#l12.129"></a><span id="l12.129" class="difflineminus">- * @return An object of three properties:</span>
<a href="#l12.130"></a><span id="l12.130" class="difflineminus">- *         stringName: a string to display to the user, from extensionsOverlay.properties.</span>
<a href="#l12.131"></a><span id="l12.131" class="difflineminus">- *         undoFunction: function to call, should the user want to return to the previous state.</span>
<a href="#l12.132"></a><span id="l12.132" class="difflineminus">- *         version: the current version of the extension.</span>
<a href="#l12.133"></a><span id="l12.133" class="difflineminus">- */</span>
<a href="#l12.134"></a><span id="l12.134" class="difflineminus">-function getTrueState(addon) {</span>
<a href="#l12.135"></a><span id="l12.135" class="difflineminus">-  let state = ExtensionSupport.loadedLegacyExtensions.get(addon.id);</span>
<a href="#l12.136"></a><span id="l12.136" class="difflineminus">-  let returnObject = {};</span>
<a href="#l12.137"></a><span id="l12.137" class="difflineminus">-</span>
<a href="#l12.138"></a><span id="l12.138" class="difflineminus">-  if (!state) {</span>
<a href="#l12.139"></a><span id="l12.139" class="difflineminus">-    return returnObject;</span>
<a href="#l12.140"></a><span id="l12.140" class="difflineminus">-  }</span>
<a href="#l12.141"></a><span id="l12.141" class="difflineminus">-</span>
<a href="#l12.142"></a><span id="l12.142" class="difflineminus">-  if (</span>
<a href="#l12.143"></a><span id="l12.143" class="difflineminus">-    addon.pendingOperations &amp; AddonManager.PENDING_UNINSTALL &amp;&amp;</span>
<a href="#l12.144"></a><span id="l12.144" class="difflineminus">-    ExtensionSupport.loadedLegacyExtensions.has(addon.id)</span>
<a href="#l12.145"></a><span id="l12.145" class="difflineminus">-  ) {</span>
<a href="#l12.146"></a><span id="l12.146" class="difflineminus">-    returnObject.stringName = &quot;warnLegacyUninstall&quot;;</span>
<a href="#l12.147"></a><span id="l12.147" class="difflineminus">-    returnObject.undoFunction = addon.cancelUninstall;</span>
<a href="#l12.148"></a><span id="l12.148" class="difflineminus">-  } else if (state.pendingOperation == &quot;install&quot;) {</span>
<a href="#l12.149"></a><span id="l12.149" class="difflineminus">-    returnObject.stringName = &quot;warnLegacyInstall&quot;;</span>
<a href="#l12.150"></a><span id="l12.150" class="difflineminus">-    returnObject.undoFunction = addon.uninstall;</span>
<a href="#l12.151"></a><span id="l12.151" class="difflineminus">-  } else if (addon.userDisabled) {</span>
<a href="#l12.152"></a><span id="l12.152" class="difflineminus">-    returnObject.stringName = &quot;warnLegacyDisable&quot;;</span>
<a href="#l12.153"></a><span id="l12.153" class="difflineminus">-    returnObject.undoFunction = addon.enable;</span>
<a href="#l12.154"></a><span id="l12.154" class="difflineminus">-  } else if (state.pendingOperation == &quot;enable&quot;) {</span>
<a href="#l12.155"></a><span id="l12.155" class="difflineminus">-    returnObject.stringName = &quot;warnLegacyEnable&quot;;</span>
<a href="#l12.156"></a><span id="l12.156" class="difflineminus">-    returnObject.undoFunction = addon.disable;</span>
<a href="#l12.157"></a><span id="l12.157" class="difflineminus">-  } else if (state.pendingOperation == &quot;upgrade&quot;) {</span>
<a href="#l12.158"></a><span id="l12.158" class="difflineminus">-    returnObject.stringName = &quot;warnLegacyUpgrade&quot;;</span>
<a href="#l12.159"></a><span id="l12.159" class="difflineminus">-    returnObject.version = state.version;</span>
<a href="#l12.160"></a><span id="l12.160" class="difflineminus">-  } else if (state.pendingOperation == &quot;downgrade&quot;) {</span>
<a href="#l12.161"></a><span id="l12.161" class="difflineminus">-    returnObject.stringName = &quot;warnLegacyDowngrade&quot;;</span>
<a href="#l12.162"></a><span id="l12.162" class="difflineminus">-    returnObject.version = state.version;</span>
<a href="#l12.163"></a><span id="l12.163" class="difflineminus">-  }</span>
<a href="#l12.164"></a><span id="l12.164" class="difflineminus">-</span>
<a href="#l12.165"></a><span id="l12.165" class="difflineminus">-  return returnObject;</span>
<a href="#l12.166"></a><span id="l12.166" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mail/base/content/mailWindowOverlay.js</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mail/base/content/mailWindowOverlay.js</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -3968,35 +3968,16 @@ async function initAddonPrefsMenu(</span>
<a href="#l13.4"></a><span id="l13.4">       } else if (addon.optionsType === null || addon.optionsType == 3) {</span>
<a href="#l13.5"></a><span id="l13.5">         addonsFound.push({</span>
<a href="#l13.6"></a><span id="l13.6">           addon,</span>
<a href="#l13.7"></a><span id="l13.7">           optionsURL: addon.optionsURL,</span>
<a href="#l13.8"></a><span id="l13.8">           optionsOpenInTab: addon.optionsType == 3,</span>
<a href="#l13.9"></a><span id="l13.9">         });</span>
<a href="#l13.10"></a><span id="l13.10">       }</span>
<a href="#l13.11"></a><span id="l13.11">     }</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-    if (</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineminus">-      ExtensionSupport.loadedLegacyExtensions.has(addon.id) ||</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineminus">-      ExtensionSupport.loadedBootstrapExtensions.has(addon.id)</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineminus">-    ) {</span>
<a href="#l13.16"></a><span id="l13.16" class="difflineminus">-      let webextension = ExtensionParent.GlobalManager.getExtension(addon.id);</span>
<a href="#l13.17"></a><span id="l13.17" class="difflineminus">-      let legacy = webextension.manifest.legacy;</span>
<a href="#l13.18"></a><span id="l13.18" class="difflineminus">-      if (</span>
<a href="#l13.19"></a><span id="l13.19" class="difflineminus">-        typeof legacy == &quot;boolean&quot; ||</span>
<a href="#l13.20"></a><span id="l13.20" class="difflineminus">-        !legacy.options ||</span>
<a href="#l13.21"></a><span id="l13.21" class="difflineminus">-        !legacy.options.page</span>
<a href="#l13.22"></a><span id="l13.22" class="difflineminus">-      ) {</span>
<a href="#l13.23"></a><span id="l13.23" class="difflineminus">-        continue;</span>
<a href="#l13.24"></a><span id="l13.24" class="difflineminus">-      }</span>
<a href="#l13.25"></a><span id="l13.25" class="difflineminus">-      addonsFound.push({</span>
<a href="#l13.26"></a><span id="l13.26" class="difflineminus">-        addon,</span>
<a href="#l13.27"></a><span id="l13.27" class="difflineminus">-        optionsURL: legacy.options.page,</span>
<a href="#l13.28"></a><span id="l13.28" class="difflineminus">-        optionsOpenInTab: legacy.options.open_in_tab,</span>
<a href="#l13.29"></a><span id="l13.29" class="difflineminus">-      });</span>
<a href="#l13.30"></a><span id="l13.30" class="difflineminus">-    }</span>
<a href="#l13.31"></a><span id="l13.31">   }</span>
<a href="#l13.32"></a><span id="l13.32"> </span>
<a href="#l13.33"></a><span id="l13.33">   // Populate the menu with addon names and icons.</span>
<a href="#l13.34"></a><span id="l13.34">   // Note: Having the following code in the getAddonsByTypes() async callback</span>
<a href="#l13.35"></a><span id="l13.35">   // above works on Windows and Linux but doesn't work on Mac, see bug 1419145.</span>
<a href="#l13.36"></a><span id="l13.36">   if (addonsFound.length &gt; 0) {</span>
<a href="#l13.37"></a><span id="l13.37">     addonsFound.sort((a, b) =&gt; a.addon.name.localeCompare(b.addon.name));</span>
<a href="#l13.38"></a><span id="l13.38">     for (let {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mail/base/content/messenger.xhtml</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mail/base/content/messenger.xhtml</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -484,17 +484,16 @@</span>
<a href="#l14.4"></a><span id="l14.4">       &lt;label id=&quot;addon-webext-perm-intro&quot; class=&quot;addon-webext-perm-text&quot;/&gt;</span>
<a href="#l14.5"></a><span id="l14.5">       &lt;html:ul id=&quot;addon-webext-perm-list&quot; class=&quot;addon-webext-perm-list&quot;/&gt;</span>
<a href="#l14.6"></a><span id="l14.6">     &lt;/popupnotificationcontent&gt;</span>
<a href="#l14.7"></a><span id="l14.7">   &lt;/popupnotification&gt;</span>
<a href="#l14.8"></a><span id="l14.8"> </span>
<a href="#l14.9"></a><span id="l14.9">   &lt;popupnotification id=&quot;addon-installed-notification&quot; hidden=&quot;true&quot;&gt;</span>
<a href="#l14.10"></a><span id="l14.10">     &lt;popupnotificationcontent class=&quot;addon-installed-notification-content&quot; orient=&quot;vertical&quot;&gt;</span>
<a href="#l14.11"></a><span id="l14.11">       &lt;html:ul id=&quot;addon-installed-list&quot; class=&quot;addon-installed-list&quot;/&gt;</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-      &lt;description id=&quot;addon-installed-restart-text&quot; class=&quot;addon-installed-restart-text&quot;/&gt;</span>
<a href="#l14.13"></a><span id="l14.13">     &lt;/popupnotificationcontent&gt;</span>
<a href="#l14.14"></a><span id="l14.14">   &lt;/popupnotification&gt;</span>
<a href="#l14.15"></a><span id="l14.15"> </span>
<a href="#l14.16"></a><span id="l14.16"> #ifdef MOZ_UPDATER</span>
<a href="#l14.17"></a><span id="l14.17">   &lt;popupnotification id=&quot;app-update-notification&quot; hidden=&quot;true&quot;&gt;</span>
<a href="#l14.18"></a><span id="l14.18">     &lt;popupnotificationcontent class=&quot;app-update-notification-content&quot; orient=&quot;vertical&quot;&gt;</span>
<a href="#l14.19"></a><span id="l14.19">       &lt;description id=&quot;app-update-text&quot; class=&quot;app-update-text&quot;/&gt;</span>
<a href="#l14.20"></a><span id="l14.20">     &lt;/popupnotificationcontent&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mail/base/modules/ExtensionsUI.jsm</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mail/base/modules/ExtensionsUI.jsm</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -9,19 +9,16 @@ const ADDONS_PROPERTIES = &quot;chrome://mess</span>
<a href="#l15.4"></a><span id="l15.4"> const BRAND_PROPERTIES = &quot;chrome://branding/locale/brand.properties&quot;;</span>
<a href="#l15.5"></a><span id="l15.5"> const DEFAULT_EXTENSION_ICON =</span>
<a href="#l15.6"></a><span id="l15.6">   &quot;chrome://mozapps/skin/extensions/extensionGeneric.svg&quot;;</span>
<a href="#l15.7"></a><span id="l15.7"> const HTML_NS = &quot;http://www.w3.org/1999/xhtml&quot;;</span>
<a href="#l15.8"></a><span id="l15.8"> </span>
<a href="#l15.9"></a><span id="l15.9"> const { XPCOMUtils } = ChromeUtils.import(</span>
<a href="#l15.10"></a><span id="l15.10">   &quot;resource://gre/modules/XPCOMUtils.jsm&quot;</span>
<a href="#l15.11"></a><span id="l15.11"> );</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-const { BrowserUtils } = ChromeUtils.import(</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineminus">-  &quot;resource://gre/modules/BrowserUtils.jsm&quot;</span>
<a href="#l15.14"></a><span id="l15.14" class="difflineminus">-);</span>
<a href="#l15.15"></a><span id="l15.15"> XPCOMUtils.defineLazyModuleGetters(this, {</span>
<a href="#l15.16"></a><span id="l15.16">   AddonManager: &quot;resource://gre/modules/AddonManager.jsm&quot;,</span>
<a href="#l15.17"></a><span id="l15.17">   AddonManagerPrivate: &quot;resource://gre/modules/AddonManager.jsm&quot;,</span>
<a href="#l15.18"></a><span id="l15.18">   ExtensionData: &quot;resource://gre/modules/Extension.jsm&quot;,</span>
<a href="#l15.19"></a><span id="l15.19">   PluralForm: &quot;resource://gre/modules/PluralForm.jsm&quot;,</span>
<a href="#l15.20"></a><span id="l15.20">   Services: &quot;resource://gre/modules/Services.jsm&quot;,</span>
<a href="#l15.21"></a><span id="l15.21">   setTimeout: &quot;resource://gre/modules/Timer.jsm&quot;,</span>
<a href="#l15.22"></a><span id="l15.22">   StringBundle: &quot;resource:///modules/StringBundle.jsm&quot;,</span>
<a href="#l15.23"></a><span id="l15.23" class="difflineat">@@ -323,82 +320,46 @@ var gXPInstallObserver = {</span>
<a href="#l15.24"></a><span id="l15.24">     let brandBundle = document.getElementById(&quot;bundle_brand&quot;);</span>
<a href="#l15.25"></a><span id="l15.25">     let appName = brandBundle.getString(&quot;brandShortName&quot;);</span>
<a href="#l15.26"></a><span id="l15.26"> </span>
<a href="#l15.27"></a><span id="l15.27">     let message = addonsBundle.getFormattedString(&quot;addonPostInstall.message1&quot;, [</span>
<a href="#l15.28"></a><span id="l15.28">       &quot;&lt;&gt;&quot;,</span>
<a href="#l15.29"></a><span id="l15.29">       appName,</span>
<a href="#l15.30"></a><span id="l15.30">     ]);</span>
<a href="#l15.31"></a><span id="l15.31"> </span>
<a href="#l15.32"></a><span id="l15.32" class="difflineminus">-    let restartRequired = await this._installRequiresRestart(addon);</span>
<a href="#l15.33"></a><span id="l15.33">     let icon = DEFAULT_EXTENSION_ICON;</span>
<a href="#l15.34"></a><span id="l15.34">     if (addon.isWebExtension) {</span>
<a href="#l15.35"></a><span id="l15.35">       icon = AddonManager.getPreferredIconURL(addon, 32, window) || icon;</span>
<a href="#l15.36"></a><span id="l15.36">     }</span>
<a href="#l15.37"></a><span id="l15.37"> </span>
<a href="#l15.38"></a><span id="l15.38">     let options = {</span>
<a href="#l15.39"></a><span id="l15.39">       hideClose: true,</span>
<a href="#l15.40"></a><span id="l15.40">       timeout: Date.now() + 30000,</span>
<a href="#l15.41"></a><span id="l15.41">       popupIconURL: icon,</span>
<a href="#l15.42"></a><span id="l15.42">       name: addon.name,</span>
<a href="#l15.43"></a><span id="l15.43">     };</span>
<a href="#l15.44"></a><span id="l15.44"> </span>
<a href="#l15.45"></a><span id="l15.45">     let list = document.getElementById(&quot;addon-installed-list&quot;);</span>
<a href="#l15.46"></a><span id="l15.46">     list.hidden = true;</span>
<a href="#l15.47"></a><span id="l15.47"> </span>
<a href="#l15.48"></a><span id="l15.48" class="difflineminus">-    this._showInstallNotification(browser, restartRequired, message, options);</span>
<a href="#l15.49"></a><span id="l15.49" class="difflineplus">+    this._showInstallNotification(browser, message, options);</span>
<a href="#l15.50"></a><span id="l15.50">   },</span>
<a href="#l15.51"></a><span id="l15.51"> </span>
<a href="#l15.52"></a><span id="l15.52" class="difflineminus">-  _showInstallNotification(browser, restartRequired, message, options) {</span>
<a href="#l15.53"></a><span id="l15.53" class="difflineminus">-    let document = getTopWindow().document;</span>
<a href="#l15.54"></a><span id="l15.54" class="difflineminus">-</span>
<a href="#l15.55"></a><span id="l15.55" class="difflineminus">-    let brandBundle = document.getElementById(&quot;bundle_brand&quot;);</span>
<a href="#l15.56"></a><span id="l15.56" class="difflineminus">-    let appName = brandBundle.getString(&quot;brandShortName&quot;);</span>
<a href="#l15.57"></a><span id="l15.57" class="difflineminus">-</span>
<a href="#l15.58"></a><span id="l15.58" class="difflineminus">-    let action;</span>
<a href="#l15.59"></a><span id="l15.59" class="difflineminus">-    let secondaryActions = null;</span>
<a href="#l15.60"></a><span id="l15.60" class="difflineminus">-    let textEl = document.getElementById(&quot;addon-installed-restart-text&quot;);</span>
<a href="#l15.61"></a><span id="l15.61" class="difflineminus">-    if (restartRequired) {</span>
<a href="#l15.62"></a><span id="l15.62" class="difflineminus">-      action = {</span>
<a href="#l15.63"></a><span id="l15.63" class="difflineminus">-        label: addonsBundle.getString(&quot;addonPostInstall.restart.label&quot;),</span>
<a href="#l15.64"></a><span id="l15.64" class="difflineminus">-        accessKey: addonsBundle.getString(&quot;addonPostInstall.restart.accesskey&quot;),</span>
<a href="#l15.65"></a><span id="l15.65" class="difflineminus">-        callback: () =&gt; {</span>
<a href="#l15.66"></a><span id="l15.66" class="difflineminus">-          BrowserUtils.restartApplication();</span>
<a href="#l15.67"></a><span id="l15.67" class="difflineminus">-        },</span>
<a href="#l15.68"></a><span id="l15.68" class="difflineminus">-      };</span>
<a href="#l15.69"></a><span id="l15.69" class="difflineminus">-      secondaryActions = [</span>
<a href="#l15.70"></a><span id="l15.70" class="difflineminus">-        {</span>
<a href="#l15.71"></a><span id="l15.71" class="difflineminus">-          label: addonsBundle.getString(&quot;addonPostInstall.noRestart.label&quot;),</span>
<a href="#l15.72"></a><span id="l15.72" class="difflineminus">-          accessKey: addonsBundle.getString(</span>
<a href="#l15.73"></a><span id="l15.73" class="difflineminus">-            &quot;addonPostInstall.noRestart.accesskey&quot;</span>
<a href="#l15.74"></a><span id="l15.74" class="difflineminus">-          ),</span>
<a href="#l15.75"></a><span id="l15.75" class="difflineminus">-          callback: () =&gt; {},</span>
<a href="#l15.76"></a><span id="l15.76" class="difflineminus">-        },</span>
<a href="#l15.77"></a><span id="l15.77" class="difflineminus">-      ];</span>
<a href="#l15.78"></a><span id="l15.78" class="difflineminus">-      textEl.textContent = addonsBundle.getFormattedString(</span>
<a href="#l15.79"></a><span id="l15.79" class="difflineminus">-        &quot;addonPostInstall.restartRequired.message&quot;,</span>
<a href="#l15.80"></a><span id="l15.80" class="difflineminus">-        [appName]</span>
<a href="#l15.81"></a><span id="l15.81" class="difflineminus">-      );</span>
<a href="#l15.82"></a><span id="l15.82" class="difflineminus">-      textEl.hidden = false;</span>
<a href="#l15.83"></a><span id="l15.83" class="difflineminus">-    } else {</span>
<a href="#l15.84"></a><span id="l15.84" class="difflineminus">-      action = {</span>
<a href="#l15.85"></a><span id="l15.85" class="difflineminus">-        label: addonsBundle.getString(&quot;addonPostInstall.okay.label&quot;),</span>
<a href="#l15.86"></a><span id="l15.86" class="difflineminus">-        accessKey: addonsBundle.getString(&quot;addonPostInstall.okay.accesskey&quot;),</span>
<a href="#l15.87"></a><span id="l15.87" class="difflineminus">-        callback: () =&gt; {},</span>
<a href="#l15.88"></a><span id="l15.88" class="difflineminus">-      };</span>
<a href="#l15.89"></a><span id="l15.89" class="difflineminus">-      textEl.hidden = true;</span>
<a href="#l15.90"></a><span id="l15.90" class="difflineminus">-    }</span>
<a href="#l15.91"></a><span id="l15.91" class="difflineminus">-</span>
<a href="#l15.92"></a><span id="l15.92" class="difflineplus">+  _showInstallNotification(browser, message, options) {</span>
<a href="#l15.93"></a><span id="l15.93">     showNotification(</span>
<a href="#l15.94"></a><span id="l15.94">       browser,</span>
<a href="#l15.95"></a><span id="l15.95">       &quot;addon-installed&quot;,</span>
<a href="#l15.96"></a><span id="l15.96">       message,</span>
<a href="#l15.97"></a><span id="l15.97">       &quot;addons-notification-icon&quot;,</span>
<a href="#l15.98"></a><span id="l15.98" class="difflineminus">-      action,</span>
<a href="#l15.99"></a><span id="l15.99" class="difflineminus">-      secondaryActions,</span>
<a href="#l15.100"></a><span id="l15.100" class="difflineplus">+      {</span>
<a href="#l15.101"></a><span id="l15.101" class="difflineplus">+        label: addonsBundle.getString(&quot;addonPostInstall.okay.label&quot;),</span>
<a href="#l15.102"></a><span id="l15.102" class="difflineplus">+        accessKey: addonsBundle.getString(&quot;addonPostInstall.okay.accesskey&quot;),</span>
<a href="#l15.103"></a><span id="l15.103" class="difflineplus">+        callback: () =&gt; {},</span>
<a href="#l15.104"></a><span id="l15.104" class="difflineplus">+      },</span>
<a href="#l15.105"></a><span id="l15.105" class="difflineplus">+      null,</span>
<a href="#l15.106"></a><span id="l15.106">       options</span>
<a href="#l15.107"></a><span id="l15.107">     );</span>
<a href="#l15.108"></a><span id="l15.108">   },</span>
<a href="#l15.109"></a><span id="l15.109"> </span>
<a href="#l15.110"></a><span id="l15.110">   /* eslint-disable complexity */</span>
<a href="#l15.111"></a><span id="l15.111">   observe(subject, topic, data) {</span>
<a href="#l15.112"></a><span id="l15.112">     let installInfo = subject.wrappedJSObject;</span>
<a href="#l15.113"></a><span id="l15.113">     let browser = installInfo.browser || installInfo.target;</span>
<a href="#l15.114"></a><span id="l15.114" class="difflineat">@@ -783,40 +744,16 @@ var gXPInstallObserver = {</span>
<a href="#l15.115"></a><span id="l15.115"> </span>
<a href="#l15.116"></a><span id="l15.116">   _removeProgressNotification(browser) {</span>
<a href="#l15.117"></a><span id="l15.117">     let notification = getNotification(&quot;addon-progress&quot;, browser);</span>
<a href="#l15.118"></a><span id="l15.118">     if (notification) {</span>
<a href="#l15.119"></a><span id="l15.119">       notification.remove();</span>
<a href="#l15.120"></a><span id="l15.120">     }</span>
<a href="#l15.121"></a><span id="l15.121">   },</span>
<a href="#l15.122"></a><span id="l15.122"> </span>
<a href="#l15.123"></a><span id="l15.123" class="difflineminus">-  async _installRequiresRestart(addon) {</span>
<a href="#l15.124"></a><span id="l15.124" class="difflineminus">-    if (!addon.isWebExtension) {</span>
<a href="#l15.125"></a><span id="l15.125" class="difflineminus">-      return false;</span>
<a href="#l15.126"></a><span id="l15.126" class="difflineminus">-    }</span>
<a href="#l15.127"></a><span id="l15.127" class="difflineminus">-</span>
<a href="#l15.128"></a><span id="l15.128" class="difflineminus">-    let data = new ExtensionData(addon.getResourceURI());</span>
<a href="#l15.129"></a><span id="l15.129" class="difflineminus">-    await data.loadManifest();</span>
<a href="#l15.130"></a><span id="l15.130" class="difflineminus">-</span>
<a href="#l15.131"></a><span id="l15.131" class="difflineminus">-    if (!data.manifest.legacy) {</span>
<a href="#l15.132"></a><span id="l15.132" class="difflineminus">-      return false;</span>
<a href="#l15.133"></a><span id="l15.133" class="difflineminus">-    }</span>
<a href="#l15.134"></a><span id="l15.134" class="difflineminus">-</span>
<a href="#l15.135"></a><span id="l15.135" class="difflineminus">-    switch (typeof data.manifest.legacy) {</span>
<a href="#l15.136"></a><span id="l15.136" class="difflineminus">-      case &quot;boolean&quot;:</span>
<a href="#l15.137"></a><span id="l15.137" class="difflineminus">-        return data.manifest.legacy;</span>
<a href="#l15.138"></a><span id="l15.138" class="difflineminus">-      case &quot;object&quot;:</span>
<a href="#l15.139"></a><span id="l15.139" class="difflineminus">-        return !(</span>
<a href="#l15.140"></a><span id="l15.140" class="difflineminus">-          data.manifest.legacy.type &amp;&amp; data.manifest.legacy.type == &quot;bootstrap&quot;</span>
<a href="#l15.141"></a><span id="l15.141" class="difflineminus">-        );</span>
<a href="#l15.142"></a><span id="l15.142" class="difflineminus">-      default:</span>
<a href="#l15.143"></a><span id="l15.143" class="difflineminus">-        return false;</span>
<a href="#l15.144"></a><span id="l15.144" class="difflineminus">-    }</span>
<a href="#l15.145"></a><span id="l15.145" class="difflineminus">-  },</span>
<a href="#l15.146"></a><span id="l15.146" class="difflineminus">-</span>
<a href="#l15.147"></a><span id="l15.147">   async _checkForSideloaded(browser) {</span>
<a href="#l15.148"></a><span id="l15.148">     let sideloaded = await AddonManagerPrivate.getNewSideloads();</span>
<a href="#l15.149"></a><span id="l15.149">     if (sideloaded.length == 0) {</span>
<a href="#l15.150"></a><span id="l15.150">       return;</span>
<a href="#l15.151"></a><span id="l15.151">     }</span>
<a href="#l15.152"></a><span id="l15.152"> </span>
<a href="#l15.153"></a><span id="l15.153">     // Check if the user wants any sideloaded add-ons installed.</span>
<a href="#l15.154"></a><span id="l15.154"> </span>
<a href="#l15.155"></a><span id="l15.155" class="difflineat">@@ -859,39 +796,30 @@ var gXPInstallObserver = {</span>
<a href="#l15.156"></a><span id="l15.156">       [appName]</span>
<a href="#l15.157"></a><span id="l15.157">     );</span>
<a href="#l15.158"></a><span id="l15.158"> </span>
<a href="#l15.159"></a><span id="l15.159">     let list = document.getElementById(&quot;addon-installed-list&quot;);</span>
<a href="#l15.160"></a><span id="l15.160">     list.hidden = false;</span>
<a href="#l15.161"></a><span id="l15.161">     while (list.lastChild) {</span>
<a href="#l15.162"></a><span id="l15.162">       list.lastChild.remove();</span>
<a href="#l15.163"></a><span id="l15.163">     }</span>
<a href="#l15.164"></a><span id="l15.164" class="difflineminus">-    let textEl = document.getElementById(&quot;addon-installed-restart-text&quot;);</span>
<a href="#l15.165"></a><span id="l15.165" class="difflineminus">-    textEl.textContent = addonsBundle.getFormattedString(</span>
<a href="#l15.166"></a><span id="l15.166" class="difflineminus">-      &quot;addonPostInstall.restartRequired.message&quot;,</span>
<a href="#l15.167"></a><span id="l15.167" class="difflineminus">-      [appName]</span>
<a href="#l15.168"></a><span id="l15.168" class="difflineminus">-    );</span>
<a href="#l15.169"></a><span id="l15.169" class="difflineminus">-    textEl.hidden = false;</span>
<a href="#l15.170"></a><span id="l15.170"> </span>
<a href="#l15.171"></a><span id="l15.171" class="difflineminus">-    let restartRequired = false;</span>
<a href="#l15.172"></a><span id="l15.172">     for (let addon of enabled) {</span>
<a href="#l15.173"></a><span id="l15.173">       let item = document.createElementNS(HTML_NS, &quot;li&quot;);</span>
<a href="#l15.174"></a><span id="l15.174">       item.textContent = addon.name;</span>
<a href="#l15.175"></a><span id="l15.175">       list.appendChild(item);</span>
<a href="#l15.176"></a><span id="l15.176" class="difflineminus">-      restartRequired =</span>
<a href="#l15.177"></a><span id="l15.177" class="difflineminus">-        restartRequired || (await this._installRequiresRestart(addon));</span>
<a href="#l15.178"></a><span id="l15.178">     }</span>
<a href="#l15.179"></a><span id="l15.179"> </span>
<a href="#l15.180"></a><span id="l15.180">     let options = {</span>
<a href="#l15.181"></a><span id="l15.181">       popupIconURL: DEFAULT_EXTENSION_ICON,</span>
<a href="#l15.182"></a><span id="l15.182">       hideClose: true,</span>
<a href="#l15.183"></a><span id="l15.183">       timeout: Date.now() + 30000,</span>
<a href="#l15.184"></a><span id="l15.184">     };</span>
<a href="#l15.185"></a><span id="l15.185"> </span>
<a href="#l15.186"></a><span id="l15.186" class="difflineminus">-    this._showInstallNotification(browser, restartRequired, message, options);</span>
<a href="#l15.187"></a><span id="l15.187" class="difflineplus">+    this._showInstallNotification(browser, message, options);</span>
<a href="#l15.188"></a><span id="l15.188">   },</span>
<a href="#l15.189"></a><span id="l15.189"> };</span>
<a href="#l15.190"></a><span id="l15.190"> </span>
<a href="#l15.191"></a><span id="l15.191"> Services.obs.addObserver(gXPInstallObserver, &quot;addon-install-disabled&quot;);</span>
<a href="#l15.192"></a><span id="l15.192"> Services.obs.addObserver(gXPInstallObserver, &quot;addon-install-origin-blocked&quot;);</span>
<a href="#l15.193"></a><span id="l15.193"> Services.obs.addObserver(gXPInstallObserver, &quot;addon-install-blocked&quot;);</span>
<a href="#l15.194"></a><span id="l15.194"> Services.obs.addObserver(gXPInstallObserver, &quot;addon-install-started&quot;);</span>
<a href="#l15.195"></a><span id="l15.195"> Services.obs.addObserver(gXPInstallObserver, &quot;addon-install-failed&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mail/components/extensions/ext-mail.json</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mail/components/extensions/ext-mail.json</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -80,23 +80,16 @@</span>
<a href="#l16.4"></a><span id="l16.4">   &quot;geckoProfiler&quot;: {</span>
<a href="#l16.5"></a><span id="l16.5">     &quot;url&quot;: &quot;chrome://extensions/content/parent/ext-geckoProfiler.js&quot;,</span>
<a href="#l16.6"></a><span id="l16.6">     &quot;schema&quot;: &quot;chrome://extensions/content/schemas/geckoProfiler.json&quot;,</span>
<a href="#l16.7"></a><span id="l16.7">     &quot;scopes&quot;: [&quot;addon_parent&quot;],</span>
<a href="#l16.8"></a><span id="l16.8">     &quot;paths&quot;: [</span>
<a href="#l16.9"></a><span id="l16.9">       [&quot;geckoProfiler&quot;]</span>
<a href="#l16.10"></a><span id="l16.10">     ]</span>
<a href="#l16.11"></a><span id="l16.11">   },</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-  &quot;legacy&quot;: {</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineminus">-    &quot;url&quot;: &quot;chrome://messenger/content/parent/ext-legacy.js&quot;,</span>
<a href="#l16.14"></a><span id="l16.14" class="difflineminus">-    &quot;schema&quot;: &quot;chrome://messenger/content/schemas/legacy.json&quot;,</span>
<a href="#l16.15"></a><span id="l16.15" class="difflineminus">-    &quot;scopes&quot;: [&quot;addon_parent&quot;],</span>
<a href="#l16.16"></a><span id="l16.16" class="difflineminus">-    &quot;events&quot;: [&quot;disable&quot;, &quot;uninstall&quot;, &quot;update&quot;],</span>
<a href="#l16.17"></a><span id="l16.17" class="difflineminus">-    &quot;manifest&quot;: [&quot;legacy&quot;]</span>
<a href="#l16.18"></a><span id="l16.18" class="difflineminus">-  },</span>
<a href="#l16.19"></a><span id="l16.19">   &quot;mailTabs&quot;: {</span>
<a href="#l16.20"></a><span id="l16.20">     &quot;url&quot;: &quot;chrome://messenger/content/parent/ext-mailTabs.js&quot;,</span>
<a href="#l16.21"></a><span id="l16.21">     &quot;schema&quot;: &quot;chrome://messenger/content/schemas/mailTabs.json&quot;,</span>
<a href="#l16.22"></a><span id="l16.22">     &quot;scopes&quot;: [&quot;addon_parent&quot;],</span>
<a href="#l16.23"></a><span id="l16.23">     &quot;manifest&quot;: [&quot;mailTabs&quot;],</span>
<a href="#l16.24"></a><span id="l16.24">     &quot;paths&quot;: [</span>
<a href="#l16.25"></a><span id="l16.25">       [&quot;mailTabs&quot;]</span>
<a href="#l16.26"></a><span id="l16.26">     ]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mail/components/extensions/jar.mn</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mail/components/extensions/jar.mn</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -15,17 +15,16 @@ messenger.jar:</span>
<a href="#l17.4"></a><span id="l17.4">     content/messenger/parent/ext-addressBook.js    (parent/ext-addressBook.js)</span>
<a href="#l17.5"></a><span id="l17.5">     content/messenger/parent/ext-browserAction.js  (parent/ext-browserAction.js)</span>
<a href="#l17.6"></a><span id="l17.6">     content/messenger/parent/ext-chrome-settings-overrides.js      (parent/ext-chrome-settings-overrides.js)</span>
<a href="#l17.7"></a><span id="l17.7">     content/messenger/parent/ext-cloudFile.js      (parent/ext-cloudFile.js)</span>
<a href="#l17.8"></a><span id="l17.8">     content/messenger/parent/ext-commands.js       (../../../../browser/components/extensions/parent/ext-commands.js)</span>
<a href="#l17.9"></a><span id="l17.9">     content/messenger/parent/ext-compose.js        (parent/ext-compose.js)</span>
<a href="#l17.10"></a><span id="l17.10">     content/messenger/parent/ext-composeAction.js  (parent/ext-composeAction.js)</span>
<a href="#l17.11"></a><span id="l17.11">     content/messenger/parent/ext-folders.js        (parent/ext-folders.js)</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-    content/messenger/parent/ext-legacy.js         (parent/ext-legacy.js)</span>
<a href="#l17.13"></a><span id="l17.13">     content/messenger/parent/ext-mail.js           (parent/ext-mail.js)</span>
<a href="#l17.14"></a><span id="l17.14">     content/messenger/parent/ext-mailTabs.js       (parent/ext-mailTabs.js)</span>
<a href="#l17.15"></a><span id="l17.15">     content/messenger/parent/ext-menus.js          (parent/ext-menus.js)</span>
<a href="#l17.16"></a><span id="l17.16">     content/messenger/parent/ext-messageDisplay.js (parent/ext-messageDisplay.js)</span>
<a href="#l17.17"></a><span id="l17.17">     content/messenger/parent/ext-messageDisplayAction.js  (parent/ext-messageDisplayAction.js)</span>
<a href="#l17.18"></a><span id="l17.18">     content/messenger/parent/ext-messages.js       (parent/ext-messages.js)</span>
<a href="#l17.19"></a><span id="l17.19">     content/messenger/parent/ext-pkcs11.js         (../../../../browser/components/extensions/parent/ext-pkcs11.js)</span>
<a href="#l17.20"></a><span id="l17.20">     content/messenger/parent/ext-tabs.js           (parent/ext-tabs.js)</span>
<a href="#l17.21"></a><span id="l17.21" class="difflineat">@@ -35,17 +34,16 @@ messenger.jar:</span>
<a href="#l17.22"></a><span id="l17.22">     content/messenger/schemas/addressBook.json     (schemas/addressBook.json)</span>
<a href="#l17.23"></a><span id="l17.23">     content/messenger/schemas/browserAction.json   (schemas/browserAction.json)</span>
<a href="#l17.24"></a><span id="l17.24">     content/messenger/schemas/chrome_settings_overrides.json       (schemas/chrome_settings_overrides.json)</span>
<a href="#l17.25"></a><span id="l17.25">     content/messenger/schemas/cloudFile.json       (schemas/cloudFile.json)</span>
<a href="#l17.26"></a><span id="l17.26">     content/messenger/schemas/commands.json        (../../../../browser/components/extensions/schemas/commands.json)</span>
<a href="#l17.27"></a><span id="l17.27">     content/messenger/schemas/compose.json         (schemas/compose.json)</span>
<a href="#l17.28"></a><span id="l17.28">     content/messenger/schemas/composeAction.json   (schemas/composeAction.json)</span>
<a href="#l17.29"></a><span id="l17.29">     content/messenger/schemas/folders.json         (schemas/folders.json)</span>
<a href="#l17.30"></a><span id="l17.30" class="difflineminus">-    content/messenger/schemas/legacy.json          (schemas/legacy.json)</span>
<a href="#l17.31"></a><span id="l17.31">     content/messenger/schemas/mailTabs.json        (schemas/mailTabs.json)</span>
<a href="#l17.32"></a><span id="l17.32">     content/messenger/schemas/menus.json           (schemas/menus.json)</span>
<a href="#l17.33"></a><span id="l17.33">     content/messenger/schemas/menus_child.json     (schemas/menus_child.json)</span>
<a href="#l17.34"></a><span id="l17.34">     content/messenger/schemas/messageDisplay.json  (schemas/messageDisplay.json)</span>
<a href="#l17.35"></a><span id="l17.35">     content/messenger/schemas/messageDisplayAction.json  (schemas/messageDisplayAction.json)</span>
<a href="#l17.36"></a><span id="l17.36">     content/messenger/schemas/messages.json        (schemas/messages.json)</span>
<a href="#l17.37"></a><span id="l17.37">     content/messenger/schemas/pkcs11.json          (../../../../browser/components/extensions/schemas/pkcs11.json)</span>
<a href="#l17.38"></a><span id="l17.38">     content/messenger/schemas/tabs.json            (schemas/tabs.json)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1">deleted file mode 100644</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineminus">--- a/mail/components/extensions/parent/ext-legacy.js</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineplus">+++ /dev/null</span>
<a href="#l18.4"></a><span id="l18.4" class="difflineat">@@ -1,469 +0,0 @@</span>
<a href="#l18.5"></a><span id="l18.5" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l18.6"></a><span id="l18.6" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l18.7"></a><span id="l18.7" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l18.8"></a><span id="l18.8" class="difflineminus">-</span>
<a href="#l18.9"></a><span id="l18.9" class="difflineminus">-ChromeUtils.defineModuleGetter(</span>
<a href="#l18.10"></a><span id="l18.10" class="difflineminus">-  this,</span>
<a href="#l18.11"></a><span id="l18.11" class="difflineminus">-  &quot;ChromeManifest&quot;,</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-  &quot;resource:///modules/ChromeManifest.jsm&quot;</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineminus">-);</span>
<a href="#l18.14"></a><span id="l18.14" class="difflineminus">-ChromeUtils.defineModuleGetter(</span>
<a href="#l18.15"></a><span id="l18.15" class="difflineminus">-  this,</span>
<a href="#l18.16"></a><span id="l18.16" class="difflineminus">-  &quot;ExtensionSupport&quot;,</span>
<a href="#l18.17"></a><span id="l18.17" class="difflineminus">-  &quot;resource:///modules/ExtensionSupport.jsm&quot;</span>
<a href="#l18.18"></a><span id="l18.18" class="difflineminus">-);</span>
<a href="#l18.19"></a><span id="l18.19" class="difflineminus">-ChromeUtils.defineModuleGetter(</span>
<a href="#l18.20"></a><span id="l18.20" class="difflineminus">-  this,</span>
<a href="#l18.21"></a><span id="l18.21" class="difflineminus">-  &quot;Overlays&quot;,</span>
<a href="#l18.22"></a><span id="l18.22" class="difflineminus">-  &quot;resource:///modules/Overlays.jsm&quot;</span>
<a href="#l18.23"></a><span id="l18.23" class="difflineminus">-);</span>
<a href="#l18.24"></a><span id="l18.24" class="difflineminus">-ChromeUtils.defineModuleGetter(</span>
<a href="#l18.25"></a><span id="l18.25" class="difflineminus">-  this,</span>
<a href="#l18.26"></a><span id="l18.26" class="difflineminus">-  &quot;XPIInternal&quot;,</span>
<a href="#l18.27"></a><span id="l18.27" class="difflineminus">-  &quot;resource://gre/modules/addons/XPIProvider.jsm&quot;</span>
<a href="#l18.28"></a><span id="l18.28" class="difflineminus">-);</span>
<a href="#l18.29"></a><span id="l18.29" class="difflineminus">-</span>
<a href="#l18.30"></a><span id="l18.30" class="difflineminus">-Cu.importGlobalProperties([&quot;fetch&quot;]);</span>
<a href="#l18.31"></a><span id="l18.31" class="difflineminus">-</span>
<a href="#l18.32"></a><span id="l18.32" class="difflineminus">-var { XPCOMUtils } = ChromeUtils.import(</span>
<a href="#l18.33"></a><span id="l18.33" class="difflineminus">-  &quot;resource://gre/modules/XPCOMUtils.jsm&quot;</span>
<a href="#l18.34"></a><span id="l18.34" class="difflineminus">-);</span>
<a href="#l18.35"></a><span id="l18.35" class="difflineminus">-var { ConsoleAPI } = ChromeUtils.import(&quot;resource://gre/modules/Console.jsm&quot;);</span>
<a href="#l18.36"></a><span id="l18.36" class="difflineminus">-</span>
<a href="#l18.37"></a><span id="l18.37" class="difflineminus">-XPCOMUtils.defineLazyGetter(this, &quot;BOOTSTRAP_REASONS&quot;, () =&gt; {</span>
<a href="#l18.38"></a><span id="l18.38" class="difflineminus">-  const { XPIProvider } = ChromeUtils.import(</span>
<a href="#l18.39"></a><span id="l18.39" class="difflineminus">-    &quot;resource://gre/modules/addons/XPIProvider.jsm&quot;</span>
<a href="#l18.40"></a><span id="l18.40" class="difflineminus">-  );</span>
<a href="#l18.41"></a><span id="l18.41" class="difflineminus">-  return XPIProvider.BOOTSTRAP_REASONS;</span>
<a href="#l18.42"></a><span id="l18.42" class="difflineminus">-});</span>
<a href="#l18.43"></a><span id="l18.43" class="difflineminus">-</span>
<a href="#l18.44"></a><span id="l18.44" class="difflineminus">-const { Log } = ChromeUtils.import(&quot;resource://gre/modules/Log.jsm&quot;);</span>
<a href="#l18.45"></a><span id="l18.45" class="difflineminus">-var logger = Log.repository.getLogger(&quot;addons.bootstrap&quot;);</span>
<a href="#l18.46"></a><span id="l18.46" class="difflineminus">-</span>
<a href="#l18.47"></a><span id="l18.47" class="difflineminus">-let bootstrapScopes = new Map();</span>
<a href="#l18.48"></a><span id="l18.48" class="difflineminus">-let cachedParams = new Map();</span>
<a href="#l18.49"></a><span id="l18.49" class="difflineminus">-</span>
<a href="#l18.50"></a><span id="l18.50" class="difflineminus">-Services.obs.addObserver(() =&gt; {</span>
<a href="#l18.51"></a><span id="l18.51" class="difflineminus">-  for (let [id, scope] of bootstrapScopes.entries()) {</span>
<a href="#l18.52"></a><span id="l18.52" class="difflineminus">-    if (ExtensionSupport.loadedBootstrapExtensions.has(id)) {</span>
<a href="#l18.53"></a><span id="l18.53" class="difflineminus">-      scope.shutdown(</span>
<a href="#l18.54"></a><span id="l18.54" class="difflineminus">-        { ...cachedParams.get(id) },</span>
<a href="#l18.55"></a><span id="l18.55" class="difflineminus">-        BOOTSTRAP_REASONS.APP_SHUTDOWN</span>
<a href="#l18.56"></a><span id="l18.56" class="difflineminus">-      );</span>
<a href="#l18.57"></a><span id="l18.57" class="difflineminus">-    }</span>
<a href="#l18.58"></a><span id="l18.58" class="difflineminus">-  }</span>
<a href="#l18.59"></a><span id="l18.59" class="difflineminus">-}, &quot;quit-application-granted&quot;);</span>
<a href="#l18.60"></a><span id="l18.60" class="difflineminus">-</span>
<a href="#l18.61"></a><span id="l18.61" class="difflineminus">-var { ExtensionError } = ExtensionUtils;</span>
<a href="#l18.62"></a><span id="l18.62" class="difflineminus">-</span>
<a href="#l18.63"></a><span id="l18.63" class="difflineminus">-this.legacy = class extends ExtensionAPI {</span>
<a href="#l18.64"></a><span id="l18.64" class="difflineminus">-  async onManifestEntry(entryName) {</span>
<a href="#l18.65"></a><span id="l18.65" class="difflineminus">-    if (this.extension.manifest.legacy) {</span>
<a href="#l18.66"></a><span id="l18.66" class="difflineminus">-      if (this.extension.manifest.legacy.type == &quot;bootstrap&quot;) {</span>
<a href="#l18.67"></a><span id="l18.67" class="difflineminus">-        await this.registerBootstrapped();</span>
<a href="#l18.68"></a><span id="l18.68" class="difflineminus">-      } else {</span>
<a href="#l18.69"></a><span id="l18.69" class="difflineminus">-        await this.registerNonBootstrapped();</span>
<a href="#l18.70"></a><span id="l18.70" class="difflineminus">-      }</span>
<a href="#l18.71"></a><span id="l18.71" class="difflineminus">-    }</span>
<a href="#l18.72"></a><span id="l18.72" class="difflineminus">-  }</span>
<a href="#l18.73"></a><span id="l18.73" class="difflineminus">-</span>
<a href="#l18.74"></a><span id="l18.74" class="difflineminus">-  // This function is for non-bootstrapped add-ons.</span>
<a href="#l18.75"></a><span id="l18.75" class="difflineminus">-</span>
<a href="#l18.76"></a><span id="l18.76" class="difflineminus">-  async registerNonBootstrapped() {</span>
<a href="#l18.77"></a><span id="l18.77" class="difflineminus">-    this.extension.legacyLoaded = true;</span>
<a href="#l18.78"></a><span id="l18.78" class="difflineminus">-</span>
<a href="#l18.79"></a><span id="l18.79" class="difflineminus">-    let state = {</span>
<a href="#l18.80"></a><span id="l18.80" class="difflineminus">-      id: this.extension.id,</span>
<a href="#l18.81"></a><span id="l18.81" class="difflineminus">-      pendingOperation: null,</span>
<a href="#l18.82"></a><span id="l18.82" class="difflineminus">-      version: this.extension.version,</span>
<a href="#l18.83"></a><span id="l18.83" class="difflineminus">-    };</span>
<a href="#l18.84"></a><span id="l18.84" class="difflineminus">-    if (ExtensionSupport.loadedLegacyExtensions.has(this.extension.id)) {</span>
<a href="#l18.85"></a><span id="l18.85" class="difflineminus">-      state = ExtensionSupport.loadedLegacyExtensions.get(this.extension.id);</span>
<a href="#l18.86"></a><span id="l18.86" class="difflineminus">-      let versionComparison = Services.vc.compare(</span>
<a href="#l18.87"></a><span id="l18.87" class="difflineminus">-        this.extension.version,</span>
<a href="#l18.88"></a><span id="l18.88" class="difflineminus">-        state.version</span>
<a href="#l18.89"></a><span id="l18.89" class="difflineminus">-      );</span>
<a href="#l18.90"></a><span id="l18.90" class="difflineminus">-      if (versionComparison != 0) {</span>
<a href="#l18.91"></a><span id="l18.91" class="difflineminus">-        if (versionComparison &gt; 0) {</span>
<a href="#l18.92"></a><span id="l18.92" class="difflineminus">-          state.pendingOperation = &quot;upgrade&quot;;</span>
<a href="#l18.93"></a><span id="l18.93" class="difflineminus">-          ExtensionSupport.loadedLegacyExtensions.notifyObservers(state);</span>
<a href="#l18.94"></a><span id="l18.94" class="difflineminus">-        } else if (versionComparison &lt; 0) {</span>
<a href="#l18.95"></a><span id="l18.95" class="difflineminus">-          state.pendingOperation = &quot;downgrade&quot;;</span>
<a href="#l18.96"></a><span id="l18.96" class="difflineminus">-          ExtensionSupport.loadedLegacyExtensions.notifyObservers(state);</span>
<a href="#l18.97"></a><span id="l18.97" class="difflineminus">-        }</span>
<a href="#l18.98"></a><span id="l18.98" class="difflineminus">-</span>
<a href="#l18.99"></a><span id="l18.99" class="difflineminus">-        // Forget any cached files we might've had from another version of this extension.</span>
<a href="#l18.100"></a><span id="l18.100" class="difflineminus">-        Services.obs.notifyObservers(null, &quot;startupcache-invalidate&quot;);</span>
<a href="#l18.101"></a><span id="l18.101" class="difflineminus">-      }</span>
<a href="#l18.102"></a><span id="l18.102" class="difflineminus">-      console.log(</span>
<a href="#l18.103"></a><span id="l18.103" class="difflineminus">-        `Legacy WebExtension ${</span>
<a href="#l18.104"></a><span id="l18.104" class="difflineminus">-          this.extension.id</span>
<a href="#l18.105"></a><span id="l18.105" class="difflineminus">-        } has already been loaded in this run, refusing to do so again. Please restart.`</span>
<a href="#l18.106"></a><span id="l18.106" class="difflineminus">-      );</span>
<a href="#l18.107"></a><span id="l18.107" class="difflineminus">-      return;</span>
<a href="#l18.108"></a><span id="l18.108" class="difflineminus">-    }</span>
<a href="#l18.109"></a><span id="l18.109" class="difflineminus">-</span>
<a href="#l18.110"></a><span id="l18.110" class="difflineminus">-    ExtensionSupport.loadedLegacyExtensions.set(this.extension.id, state);</span>
<a href="#l18.111"></a><span id="l18.111" class="difflineminus">-    if (this.extension.startupReason == &quot;ADDON_INSTALL&quot;) {</span>
<a href="#l18.112"></a><span id="l18.112" class="difflineminus">-      // Usually, sideloaded extensions are disabled when they first appear,</span>
<a href="#l18.113"></a><span id="l18.113" class="difflineminus">-      // but to run calendar tests, we disable this.</span>
<a href="#l18.114"></a><span id="l18.114" class="difflineminus">-      let scope = XPIInternal.XPIStates.findAddon(this.extension.id).location</span>
<a href="#l18.115"></a><span id="l18.115" class="difflineminus">-        .scope;</span>
<a href="#l18.116"></a><span id="l18.116" class="difflineminus">-      let autoDisableScopes = Services.prefs.getIntPref(</span>
<a href="#l18.117"></a><span id="l18.117" class="difflineminus">-        &quot;extensions.autoDisableScopes&quot;</span>
<a href="#l18.118"></a><span id="l18.118" class="difflineminus">-      );</span>
<a href="#l18.119"></a><span id="l18.119" class="difflineminus">-</span>
<a href="#l18.120"></a><span id="l18.120" class="difflineminus">-      // If the extension was just installed from the distribution folder,</span>
<a href="#l18.121"></a><span id="l18.121" class="difflineminus">-      // it's in the profile extensions folder. We don't want to disable it.</span>
<a href="#l18.122"></a><span id="l18.122" class="difflineminus">-      let isDistroAddon = Services.prefs.getBoolPref(</span>
<a href="#l18.123"></a><span id="l18.123" class="difflineminus">-        &quot;extensions.installedDistroAddon.&quot; + this.extension.id,</span>
<a href="#l18.124"></a><span id="l18.124" class="difflineminus">-        false</span>
<a href="#l18.125"></a><span id="l18.125" class="difflineminus">-      );</span>
<a href="#l18.126"></a><span id="l18.126" class="difflineminus">-</span>
<a href="#l18.127"></a><span id="l18.127" class="difflineminus">-      if (!isDistroAddon &amp;&amp; scope &amp; autoDisableScopes) {</span>
<a href="#l18.128"></a><span id="l18.128" class="difflineminus">-        state.pendingOperation = &quot;install&quot;;</span>
<a href="#l18.129"></a><span id="l18.129" class="difflineminus">-        console.log(</span>
<a href="#l18.130"></a><span id="l18.130" class="difflineminus">-          `Legacy WebExtension ${</span>
<a href="#l18.131"></a><span id="l18.131" class="difflineminus">-            this.extension.id</span>
<a href="#l18.132"></a><span id="l18.132" class="difflineminus">-          } loading for other reason than startup (${</span>
<a href="#l18.133"></a><span id="l18.133" class="difflineminus">-            this.extension.startupReason</span>
<a href="#l18.134"></a><span id="l18.134" class="difflineminus">-          }), refusing to load immediately.`</span>
<a href="#l18.135"></a><span id="l18.135" class="difflineminus">-        );</span>
<a href="#l18.136"></a><span id="l18.136" class="difflineminus">-        ExtensionSupport.loadedLegacyExtensions.notifyObservers(state);</span>
<a href="#l18.137"></a><span id="l18.137" class="difflineminus">-</span>
<a href="#l18.138"></a><span id="l18.138" class="difflineminus">-        // Forget any cached files we might've had if this extension was previously installed.</span>
<a href="#l18.139"></a><span id="l18.139" class="difflineminus">-        Services.obs.notifyObservers(null, &quot;startupcache-invalidate&quot;);</span>
<a href="#l18.140"></a><span id="l18.140" class="difflineminus">-        return;</span>
<a href="#l18.141"></a><span id="l18.141" class="difflineminus">-      }</span>
<a href="#l18.142"></a><span id="l18.142" class="difflineminus">-    }</span>
<a href="#l18.143"></a><span id="l18.143" class="difflineminus">-    if (this.extension.startupReason == &quot;ADDON_ENABLE&quot;) {</span>
<a href="#l18.144"></a><span id="l18.144" class="difflineminus">-      state.pendingOperation = &quot;enable&quot;;</span>
<a href="#l18.145"></a><span id="l18.145" class="difflineminus">-      console.log(</span>
<a href="#l18.146"></a><span id="l18.146" class="difflineminus">-        `Legacy WebExtension ${</span>
<a href="#l18.147"></a><span id="l18.147" class="difflineminus">-          this.extension.id</span>
<a href="#l18.148"></a><span id="l18.148" class="difflineminus">-        } loading for other reason than startup (${</span>
<a href="#l18.149"></a><span id="l18.149" class="difflineminus">-          this.extension.startupReason</span>
<a href="#l18.150"></a><span id="l18.150" class="difflineminus">-        }), refusing to load immediately.`</span>
<a href="#l18.151"></a><span id="l18.151" class="difflineminus">-      );</span>
<a href="#l18.152"></a><span id="l18.152" class="difflineminus">-      ExtensionSupport.loadedLegacyExtensions.notifyObservers(state);</span>
<a href="#l18.153"></a><span id="l18.153" class="difflineminus">-      return;</span>
<a href="#l18.154"></a><span id="l18.154" class="difflineminus">-    }</span>
<a href="#l18.155"></a><span id="l18.155" class="difflineminus">-</span>
<a href="#l18.156"></a><span id="l18.156" class="difflineminus">-    let extensionRoot;</span>
<a href="#l18.157"></a><span id="l18.157" class="difflineminus">-    if (this.extension.rootURI instanceof Ci.nsIJARURI) {</span>
<a href="#l18.158"></a><span id="l18.158" class="difflineminus">-      extensionRoot = this.extension.rootURI.JARFile.QueryInterface(</span>
<a href="#l18.159"></a><span id="l18.159" class="difflineminus">-        Ci.nsIFileURL</span>
<a href="#l18.160"></a><span id="l18.160" class="difflineminus">-      ).file;</span>
<a href="#l18.161"></a><span id="l18.161" class="difflineminus">-      console.log(&quot;Loading packed extension from&quot;, extensionRoot.path);</span>
<a href="#l18.162"></a><span id="l18.162" class="difflineminus">-    } else {</span>
<a href="#l18.163"></a><span id="l18.163" class="difflineminus">-      extensionRoot = this.extension.rootURI.QueryInterface(Ci.nsIFileURL).file;</span>
<a href="#l18.164"></a><span id="l18.164" class="difflineminus">-      console.log(&quot;Loading unpacked extension from&quot;, extensionRoot.path);</span>
<a href="#l18.165"></a><span id="l18.165" class="difflineminus">-    }</span>
<a href="#l18.166"></a><span id="l18.166" class="difflineminus">-</span>
<a href="#l18.167"></a><span id="l18.167" class="difflineminus">-    // Have Gecko do as much loading as is still possible</span>
<a href="#l18.168"></a><span id="l18.168" class="difflineminus">-    try {</span>
<a href="#l18.169"></a><span id="l18.169" class="difflineminus">-      Cc[&quot;@mozilla.org/component-manager-extra;1&quot;]</span>
<a href="#l18.170"></a><span id="l18.170" class="difflineminus">-        .getService(Ci.nsIComponentManagerExtra)</span>
<a href="#l18.171"></a><span id="l18.171" class="difflineminus">-        .addLegacyExtensionManifestLocation(extensionRoot);</span>
<a href="#l18.172"></a><span id="l18.172" class="difflineminus">-    } catch (e) {</span>
<a href="#l18.173"></a><span id="l18.173" class="difflineminus">-      throw new ExtensionError(e.message, e.fileName, e.lineNumber);</span>
<a href="#l18.174"></a><span id="l18.174" class="difflineminus">-    }</span>
<a href="#l18.175"></a><span id="l18.175" class="difflineminus">-</span>
<a href="#l18.176"></a><span id="l18.176" class="difflineminus">-    // Load chrome.manifest</span>
<a href="#l18.177"></a><span id="l18.177" class="difflineminus">-    let appinfo = Services.appinfo;</span>
<a href="#l18.178"></a><span id="l18.178" class="difflineminus">-    let options = {</span>
<a href="#l18.179"></a><span id="l18.179" class="difflineminus">-      application: appinfo.ID,</span>
<a href="#l18.180"></a><span id="l18.180" class="difflineminus">-      appversion: appinfo.version,</span>
<a href="#l18.181"></a><span id="l18.181" class="difflineminus">-      platformversion: appinfo.platformVersion,</span>
<a href="#l18.182"></a><span id="l18.182" class="difflineminus">-      os: appinfo.OS,</span>
<a href="#l18.183"></a><span id="l18.183" class="difflineminus">-      osversion: Services.sysinfo.getProperty(&quot;version&quot;),</span>
<a href="#l18.184"></a><span id="l18.184" class="difflineminus">-      abi: appinfo.XPCOMABI,</span>
<a href="#l18.185"></a><span id="l18.185" class="difflineminus">-    };</span>
<a href="#l18.186"></a><span id="l18.186" class="difflineminus">-    let loader = async filename =&gt; {</span>
<a href="#l18.187"></a><span id="l18.187" class="difflineminus">-      let url = this.extension.getURL(filename);</span>
<a href="#l18.188"></a><span id="l18.188" class="difflineminus">-      return fetch(url).then(response =&gt; response.text());</span>
<a href="#l18.189"></a><span id="l18.189" class="difflineminus">-    };</span>
<a href="#l18.190"></a><span id="l18.190" class="difflineminus">-    let chromeManifest = new ChromeManifest(loader, options);</span>
<a href="#l18.191"></a><span id="l18.191" class="difflineminus">-    await chromeManifest.parse(&quot;chrome.manifest&quot;);</span>
<a href="#l18.192"></a><span id="l18.192" class="difflineminus">-</span>
<a href="#l18.193"></a><span id="l18.193" class="difflineminus">-    // Load preference files</span>
<a href="#l18.194"></a><span id="l18.194" class="difflineminus">-    console.log(&quot;Loading add-on preferences from &quot;, extensionRoot.path);</span>
<a href="#l18.195"></a><span id="l18.195" class="difflineminus">-    ExtensionSupport.loadAddonPrefs(extensionRoot);</span>
<a href="#l18.196"></a><span id="l18.196" class="difflineminus">-</span>
<a href="#l18.197"></a><span id="l18.197" class="difflineminus">-    // Fire profile-after-change notifications, because we are past that event by now</span>
<a href="#l18.198"></a><span id="l18.198" class="difflineminus">-    console.log(&quot;Firing profile-after-change listeners for&quot;, this.extension.id);</span>
<a href="#l18.199"></a><span id="l18.199" class="difflineminus">-    let profileAfterChange = chromeManifest.category.get(</span>
<a href="#l18.200"></a><span id="l18.200" class="difflineminus">-      &quot;profile-after-change&quot;</span>
<a href="#l18.201"></a><span id="l18.201" class="difflineminus">-    );</span>
<a href="#l18.202"></a><span id="l18.202" class="difflineminus">-    for (let contractid of profileAfterChange.values()) {</span>
<a href="#l18.203"></a><span id="l18.203" class="difflineminus">-      let service = contractid.startsWith(&quot;service,&quot;);</span>
<a href="#l18.204"></a><span id="l18.204" class="difflineminus">-      let instance;</span>
<a href="#l18.205"></a><span id="l18.205" class="difflineminus">-      try {</span>
<a href="#l18.206"></a><span id="l18.206" class="difflineminus">-        if (service) {</span>
<a href="#l18.207"></a><span id="l18.207" class="difflineminus">-          instance = Cc[contractid.substr(8)].getService(Ci.nsIObserver);</span>
<a href="#l18.208"></a><span id="l18.208" class="difflineminus">-        } else {</span>
<a href="#l18.209"></a><span id="l18.209" class="difflineminus">-          instance = Cc[contractid].createInstance(Ci.nsIObserver);</span>
<a href="#l18.210"></a><span id="l18.210" class="difflineminus">-        }</span>
<a href="#l18.211"></a><span id="l18.211" class="difflineminus">-</span>
<a href="#l18.212"></a><span id="l18.212" class="difflineminus">-        instance.observe(null, &quot;profile-after-change&quot;, null);</span>
<a href="#l18.213"></a><span id="l18.213" class="difflineminus">-      } catch (e) {</span>
<a href="#l18.214"></a><span id="l18.214" class="difflineminus">-        console.error(</span>
<a href="#l18.215"></a><span id="l18.215" class="difflineminus">-          &quot;Error firing profile-after-change listener for&quot;,</span>
<a href="#l18.216"></a><span id="l18.216" class="difflineminus">-          contractid</span>
<a href="#l18.217"></a><span id="l18.217" class="difflineminus">-        );</span>
<a href="#l18.218"></a><span id="l18.218" class="difflineminus">-      }</span>
<a href="#l18.219"></a><span id="l18.219" class="difflineminus">-    }</span>
<a href="#l18.220"></a><span id="l18.220" class="difflineminus">-</span>
<a href="#l18.221"></a><span id="l18.221" class="difflineminus">-    // Overlays.load must only be called once per window per extension.</span>
<a href="#l18.222"></a><span id="l18.222" class="difflineminus">-    // We use this WeakSet to remember all windows we've already seen.</span>
<a href="#l18.223"></a><span id="l18.223" class="difflineminus">-    let seenDocuments = new WeakSet();</span>
<a href="#l18.224"></a><span id="l18.224" class="difflineminus">-</span>
<a href="#l18.225"></a><span id="l18.225" class="difflineminus">-    // Listen for new windows to overlay.</span>
<a href="#l18.226"></a><span id="l18.226" class="difflineminus">-    let documentObserver = {</span>
<a href="#l18.227"></a><span id="l18.227" class="difflineminus">-      observe(doc) {</span>
<a href="#l18.228"></a><span id="l18.228" class="difflineminus">-        if (</span>
<a href="#l18.229"></a><span id="l18.229" class="difflineminus">-          ExtensionCommon.instanceOf(doc, &quot;HTMLDocument&quot;) &amp;&amp;</span>
<a href="#l18.230"></a><span id="l18.230" class="difflineminus">-          !seenDocuments.has(doc)</span>
<a href="#l18.231"></a><span id="l18.231" class="difflineminus">-        ) {</span>
<a href="#l18.232"></a><span id="l18.232" class="difflineminus">-          seenDocuments.add(doc);</span>
<a href="#l18.233"></a><span id="l18.233" class="difflineminus">-          Overlays.load(chromeManifest, doc.defaultView);</span>
<a href="#l18.234"></a><span id="l18.234" class="difflineminus">-        }</span>
<a href="#l18.235"></a><span id="l18.235" class="difflineminus">-      },</span>
<a href="#l18.236"></a><span id="l18.236" class="difflineminus">-    };</span>
<a href="#l18.237"></a><span id="l18.237" class="difflineminus">-    Services.obs.addObserver(documentObserver, &quot;chrome-document-interactive&quot;);</span>
<a href="#l18.238"></a><span id="l18.238" class="difflineminus">-</span>
<a href="#l18.239"></a><span id="l18.239" class="difflineminus">-    // Add overlays to all existing windows.</span>
<a href="#l18.240"></a><span id="l18.240" class="difflineminus">-    getAllWindows().forEach(win =&gt; {</span>
<a href="#l18.241"></a><span id="l18.241" class="difflineminus">-      if (</span>
<a href="#l18.242"></a><span id="l18.242" class="difflineminus">-        [&quot;interactive&quot;, &quot;complete&quot;].includes(win.document.readyState) &amp;&amp;</span>
<a href="#l18.243"></a><span id="l18.243" class="difflineminus">-        !seenDocuments.has(win.document)</span>
<a href="#l18.244"></a><span id="l18.244" class="difflineminus">-      ) {</span>
<a href="#l18.245"></a><span id="l18.245" class="difflineminus">-        seenDocuments.add(win.document);</span>
<a href="#l18.246"></a><span id="l18.246" class="difflineminus">-        Overlays.load(chromeManifest, win);</span>
<a href="#l18.247"></a><span id="l18.247" class="difflineminus">-      }</span>
<a href="#l18.248"></a><span id="l18.248" class="difflineminus">-    });</span>
<a href="#l18.249"></a><span id="l18.249" class="difflineminus">-</span>
<a href="#l18.250"></a><span id="l18.250" class="difflineminus">-    this.extension.callOnClose({</span>
<a href="#l18.251"></a><span id="l18.251" class="difflineminus">-      close: () =&gt; {</span>
<a href="#l18.252"></a><span id="l18.252" class="difflineminus">-        Services.obs.removeObserver(</span>
<a href="#l18.253"></a><span id="l18.253" class="difflineminus">-          documentObserver,</span>
<a href="#l18.254"></a><span id="l18.254" class="difflineminus">-          &quot;chrome-document-interactive&quot;</span>
<a href="#l18.255"></a><span id="l18.255" class="difflineminus">-        );</span>
<a href="#l18.256"></a><span id="l18.256" class="difflineminus">-      },</span>
<a href="#l18.257"></a><span id="l18.257" class="difflineminus">-    });</span>
<a href="#l18.258"></a><span id="l18.258" class="difflineminus">-  }</span>
<a href="#l18.259"></a><span id="l18.259" class="difflineminus">-</span>
<a href="#l18.260"></a><span id="l18.260" class="difflineminus">-  // The following functions are for bootstrapped add-ons.</span>
<a href="#l18.261"></a><span id="l18.261" class="difflineminus">-</span>
<a href="#l18.262"></a><span id="l18.262" class="difflineminus">-  async registerBootstrapped() {</span>
<a href="#l18.263"></a><span id="l18.263" class="difflineminus">-    let oldParams = cachedParams.get(this.extension.id);</span>
<a href="#l18.264"></a><span id="l18.264" class="difflineminus">-    let params = {</span>
<a href="#l18.265"></a><span id="l18.265" class="difflineminus">-      id: this.extension.id,</span>
<a href="#l18.266"></a><span id="l18.266" class="difflineminus">-      version: this.extension.version,</span>
<a href="#l18.267"></a><span id="l18.267" class="difflineminus">-      resourceURI: Services.io.newURI(this.extension.resourceURL),</span>
<a href="#l18.268"></a><span id="l18.268" class="difflineminus">-      installPath: this.extensionFile.path,</span>
<a href="#l18.269"></a><span id="l18.269" class="difflineminus">-    };</span>
<a href="#l18.270"></a><span id="l18.270" class="difflineminus">-    cachedParams.set(this.extension.id, { ...params });</span>
<a href="#l18.271"></a><span id="l18.271" class="difflineminus">-</span>
<a href="#l18.272"></a><span id="l18.272" class="difflineminus">-    if (</span>
<a href="#l18.273"></a><span id="l18.273" class="difflineminus">-      oldParams &amp;&amp;</span>
<a href="#l18.274"></a><span id="l18.274" class="difflineminus">-      [&quot;ADDON_UPGRADE&quot;, &quot;ADDON_DOWNGRADE&quot;].includes(</span>
<a href="#l18.275"></a><span id="l18.275" class="difflineminus">-        this.extension.startupReason</span>
<a href="#l18.276"></a><span id="l18.276" class="difflineminus">-      )</span>
<a href="#l18.277"></a><span id="l18.277" class="difflineminus">-    ) {</span>
<a href="#l18.278"></a><span id="l18.278" class="difflineminus">-      params.oldVersion = oldParams.version;</span>
<a href="#l18.279"></a><span id="l18.279" class="difflineminus">-    }</span>
<a href="#l18.280"></a><span id="l18.280" class="difflineminus">-</span>
<a href="#l18.281"></a><span id="l18.281" class="difflineminus">-    let scope = await this.loadScope();</span>
<a href="#l18.282"></a><span id="l18.282" class="difflineminus">-    bootstrapScopes.set(this.extension.id, scope);</span>
<a href="#l18.283"></a><span id="l18.283" class="difflineminus">-</span>
<a href="#l18.284"></a><span id="l18.284" class="difflineminus">-    if (</span>
<a href="#l18.285"></a><span id="l18.285" class="difflineminus">-      [&quot;ADDON_INSTALL&quot;, &quot;ADDON_UPGRADE&quot;, &quot;ADDON_DOWNGRADE&quot;].includes(</span>
<a href="#l18.286"></a><span id="l18.286" class="difflineminus">-        this.extension.startupReason</span>
<a href="#l18.287"></a><span id="l18.287" class="difflineminus">-      )</span>
<a href="#l18.288"></a><span id="l18.288" class="difflineminus">-    ) {</span>
<a href="#l18.289"></a><span id="l18.289" class="difflineminus">-      scope.install(params, BOOTSTRAP_REASONS[this.extension.startupReason]);</span>
<a href="#l18.290"></a><span id="l18.290" class="difflineminus">-    }</span>
<a href="#l18.291"></a><span id="l18.291" class="difflineminus">-    scope.startup(params, BOOTSTRAP_REASONS[this.extension.startupReason]);</span>
<a href="#l18.292"></a><span id="l18.292" class="difflineminus">-    ExtensionSupport.loadedBootstrapExtensions.add(this.extension.id);</span>
<a href="#l18.293"></a><span id="l18.293" class="difflineminus">-  }</span>
<a href="#l18.294"></a><span id="l18.294" class="difflineminus">-</span>
<a href="#l18.295"></a><span id="l18.295" class="difflineminus">-  static onDisable(id) {</span>
<a href="#l18.296"></a><span id="l18.296" class="difflineminus">-    if (bootstrapScopes.has(id)) {</span>
<a href="#l18.297"></a><span id="l18.297" class="difflineminus">-      bootstrapScopes</span>
<a href="#l18.298"></a><span id="l18.298" class="difflineminus">-        .get(id)</span>
<a href="#l18.299"></a><span id="l18.299" class="difflineminus">-        .shutdown({ ...cachedParams.get(id) }, BOOTSTRAP_REASONS.ADDON_DISABLE);</span>
<a href="#l18.300"></a><span id="l18.300" class="difflineminus">-      ExtensionSupport.loadedBootstrapExtensions.delete(id);</span>
<a href="#l18.301"></a><span id="l18.301" class="difflineminus">-    }</span>
<a href="#l18.302"></a><span id="l18.302" class="difflineminus">-  }</span>
<a href="#l18.303"></a><span id="l18.303" class="difflineminus">-</span>
<a href="#l18.304"></a><span id="l18.304" class="difflineminus">-  static onUpdate(id, manifest) {</span>
<a href="#l18.305"></a><span id="l18.305" class="difflineminus">-    if (bootstrapScopes.has(id)) {</span>
<a href="#l18.306"></a><span id="l18.306" class="difflineminus">-      let params = {</span>
<a href="#l18.307"></a><span id="l18.307" class="difflineminus">-        ...cachedParams.get(id),</span>
<a href="#l18.308"></a><span id="l18.308" class="difflineminus">-        newVersion: manifest.version,</span>
<a href="#l18.309"></a><span id="l18.309" class="difflineminus">-      };</span>
<a href="#l18.310"></a><span id="l18.310" class="difflineminus">-      let reason = BOOTSTRAP_REASONS.ADDON_UPGRADE;</span>
<a href="#l18.311"></a><span id="l18.311" class="difflineminus">-      if (Services.vc.compare(params.newVersion, params.version) &lt; 0) {</span>
<a href="#l18.312"></a><span id="l18.312" class="difflineminus">-        reason = BOOTSTRAP_REASONS.ADDON_DOWNGRADE;</span>
<a href="#l18.313"></a><span id="l18.313" class="difflineminus">-      }</span>
<a href="#l18.314"></a><span id="l18.314" class="difflineminus">-</span>
<a href="#l18.315"></a><span id="l18.315" class="difflineminus">-      let scope = bootstrapScopes.get(id);</span>
<a href="#l18.316"></a><span id="l18.316" class="difflineminus">-      scope.shutdown(params, reason);</span>
<a href="#l18.317"></a><span id="l18.317" class="difflineminus">-      scope.uninstall(params, reason);</span>
<a href="#l18.318"></a><span id="l18.318" class="difflineminus">-      ExtensionSupport.loadedBootstrapExtensions.delete(id);</span>
<a href="#l18.319"></a><span id="l18.319" class="difflineminus">-      bootstrapScopes.delete(id);</span>
<a href="#l18.320"></a><span id="l18.320" class="difflineminus">-    }</span>
<a href="#l18.321"></a><span id="l18.321" class="difflineminus">-  }</span>
<a href="#l18.322"></a><span id="l18.322" class="difflineminus">-</span>
<a href="#l18.323"></a><span id="l18.323" class="difflineminus">-  static onUninstall(id) {</span>
<a href="#l18.324"></a><span id="l18.324" class="difflineminus">-    if (bootstrapScopes.has(id)) {</span>
<a href="#l18.325"></a><span id="l18.325" class="difflineminus">-      bootstrapScopes</span>
<a href="#l18.326"></a><span id="l18.326" class="difflineminus">-        .get(id)</span>
<a href="#l18.327"></a><span id="l18.327" class="difflineminus">-        .uninstall(</span>
<a href="#l18.328"></a><span id="l18.328" class="difflineminus">-          { ...cachedParams.get(id) },</span>
<a href="#l18.329"></a><span id="l18.329" class="difflineminus">-          BOOTSTRAP_REASONS.ADDON_UNINSTALL</span>
<a href="#l18.330"></a><span id="l18.330" class="difflineminus">-        );</span>
<a href="#l18.331"></a><span id="l18.331" class="difflineminus">-      bootstrapScopes.delete(id);</span>
<a href="#l18.332"></a><span id="l18.332" class="difflineminus">-    }</span>
<a href="#l18.333"></a><span id="l18.333" class="difflineminus">-  }</span>
<a href="#l18.334"></a><span id="l18.334" class="difflineminus">-</span>
<a href="#l18.335"></a><span id="l18.335" class="difflineminus">-  get extensionFile() {</span>
<a href="#l18.336"></a><span id="l18.336" class="difflineminus">-    let uri = Services.io.newURI(this.extension.resourceURL);</span>
<a href="#l18.337"></a><span id="l18.337" class="difflineminus">-    if (uri instanceof Ci.nsIJARURI) {</span>
<a href="#l18.338"></a><span id="l18.338" class="difflineminus">-      uri = uri.QueryInterface(Ci.nsIJARURI).JARFile;</span>
<a href="#l18.339"></a><span id="l18.339" class="difflineminus">-    }</span>
<a href="#l18.340"></a><span id="l18.340" class="difflineminus">-    return uri.QueryInterface(Ci.nsIFileURL).file;</span>
<a href="#l18.341"></a><span id="l18.341" class="difflineminus">-  }</span>
<a href="#l18.342"></a><span id="l18.342" class="difflineminus">-</span>
<a href="#l18.343"></a><span id="l18.343" class="difflineminus">-  loadScope() {</span>
<a href="#l18.344"></a><span id="l18.344" class="difflineminus">-    let { extension } = this;</span>
<a href="#l18.345"></a><span id="l18.345" class="difflineminus">-    let file = this.extensionFile;</span>
<a href="#l18.346"></a><span id="l18.346" class="difflineminus">-    let uri = this.extension.getURL(&quot;bootstrap.js&quot;);</span>
<a href="#l18.347"></a><span id="l18.347" class="difflineminus">-    let principal = Services.scriptSecurityManager.getSystemPrincipal();</span>
<a href="#l18.348"></a><span id="l18.348" class="difflineminus">-</span>
<a href="#l18.349"></a><span id="l18.349" class="difflineminus">-    let sandbox = new Cu.Sandbox(principal, {</span>
<a href="#l18.350"></a><span id="l18.350" class="difflineminus">-      sandboxName: uri,</span>
<a href="#l18.351"></a><span id="l18.351" class="difflineminus">-      addonId: this.extension.id,</span>
<a href="#l18.352"></a><span id="l18.352" class="difflineminus">-      wantGlobalProperties: [&quot;ChromeUtils&quot;],</span>
<a href="#l18.353"></a><span id="l18.353" class="difflineminus">-      metadata: { addonID: this.extension.id, URI: uri },</span>
<a href="#l18.354"></a><span id="l18.354" class="difflineminus">-    });</span>
<a href="#l18.355"></a><span id="l18.355" class="difflineminus">-</span>
<a href="#l18.356"></a><span id="l18.356" class="difflineminus">-    try {</span>
<a href="#l18.357"></a><span id="l18.357" class="difflineminus">-      Object.assign(sandbox, BOOTSTRAP_REASONS);</span>
<a href="#l18.358"></a><span id="l18.358" class="difflineminus">-</span>
<a href="#l18.359"></a><span id="l18.359" class="difflineminus">-      XPCOMUtils.defineLazyGetter(</span>
<a href="#l18.360"></a><span id="l18.360" class="difflineminus">-        sandbox,</span>
<a href="#l18.361"></a><span id="l18.361" class="difflineminus">-        &quot;console&quot;,</span>
<a href="#l18.362"></a><span id="l18.362" class="difflineminus">-        () =&gt; new ConsoleAPI({ consoleID: `addon/${this.extension.id}` })</span>
<a href="#l18.363"></a><span id="l18.363" class="difflineminus">-      );</span>
<a href="#l18.364"></a><span id="l18.364" class="difflineminus">-</span>
<a href="#l18.365"></a><span id="l18.365" class="difflineminus">-      Services.scriptloader.loadSubScript(uri, sandbox);</span>
<a href="#l18.366"></a><span id="l18.366" class="difflineminus">-    } catch (e) {</span>
<a href="#l18.367"></a><span id="l18.367" class="difflineminus">-      logger.warn(`Error loading bootstrap.js for ${this.extension.id}`, e);</span>
<a href="#l18.368"></a><span id="l18.368" class="difflineminus">-    }</span>
<a href="#l18.369"></a><span id="l18.369" class="difflineminus">-</span>
<a href="#l18.370"></a><span id="l18.370" class="difflineminus">-    function findMethod(name) {</span>
<a href="#l18.371"></a><span id="l18.371" class="difflineminus">-      if (sandbox.name) {</span>
<a href="#l18.372"></a><span id="l18.372" class="difflineminus">-        return sandbox.name;</span>
<a href="#l18.373"></a><span id="l18.373" class="difflineminus">-      }</span>
<a href="#l18.374"></a><span id="l18.374" class="difflineminus">-</span>
<a href="#l18.375"></a><span id="l18.375" class="difflineminus">-      try {</span>
<a href="#l18.376"></a><span id="l18.376" class="difflineminus">-        let method = Cu.evalInSandbox(name, sandbox);</span>
<a href="#l18.377"></a><span id="l18.377" class="difflineminus">-        return method;</span>
<a href="#l18.378"></a><span id="l18.378" class="difflineminus">-      } catch (err) {}</span>
<a href="#l18.379"></a><span id="l18.379" class="difflineminus">-</span>
<a href="#l18.380"></a><span id="l18.380" class="difflineminus">-      return () =&gt; {</span>
<a href="#l18.381"></a><span id="l18.381" class="difflineminus">-        logger.warn(</span>
<a href="#l18.382"></a><span id="l18.382" class="difflineminus">-          `Add-on ${extension.id} is missing bootstrap method ${name}`</span>
<a href="#l18.383"></a><span id="l18.383" class="difflineminus">-        );</span>
<a href="#l18.384"></a><span id="l18.384" class="difflineminus">-      };</span>
<a href="#l18.385"></a><span id="l18.385" class="difflineminus">-    }</span>
<a href="#l18.386"></a><span id="l18.386" class="difflineminus">-</span>
<a href="#l18.387"></a><span id="l18.387" class="difflineminus">-    let install = findMethod(&quot;install&quot;);</span>
<a href="#l18.388"></a><span id="l18.388" class="difflineminus">-    let uninstall = findMethod(&quot;uninstall&quot;);</span>
<a href="#l18.389"></a><span id="l18.389" class="difflineminus">-    let startup = findMethod(&quot;startup&quot;);</span>
<a href="#l18.390"></a><span id="l18.390" class="difflineminus">-    let shutdown = findMethod(&quot;shutdown&quot;);</span>
<a href="#l18.391"></a><span id="l18.391" class="difflineminus">-</span>
<a href="#l18.392"></a><span id="l18.392" class="difflineminus">-    return {</span>
<a href="#l18.393"></a><span id="l18.393" class="difflineminus">-      install(...args) {</span>
<a href="#l18.394"></a><span id="l18.394" class="difflineminus">-        try {</span>
<a href="#l18.395"></a><span id="l18.395" class="difflineminus">-          install(...args);</span>
<a href="#l18.396"></a><span id="l18.396" class="difflineminus">-        } catch (ex) {</span>
<a href="#l18.397"></a><span id="l18.397" class="difflineminus">-          logger.warn(</span>
<a href="#l18.398"></a><span id="l18.398" class="difflineminus">-            `Exception running bootstrap method install on ${extension.id}`,</span>
<a href="#l18.399"></a><span id="l18.399" class="difflineminus">-            ex</span>
<a href="#l18.400"></a><span id="l18.400" class="difflineminus">-          );</span>
<a href="#l18.401"></a><span id="l18.401" class="difflineminus">-        }</span>
<a href="#l18.402"></a><span id="l18.402" class="difflineminus">-      },</span>
<a href="#l18.403"></a><span id="l18.403" class="difflineminus">-</span>
<a href="#l18.404"></a><span id="l18.404" class="difflineminus">-      uninstall(...args) {</span>
<a href="#l18.405"></a><span id="l18.405" class="difflineminus">-        try {</span>
<a href="#l18.406"></a><span id="l18.406" class="difflineminus">-          uninstall(...args);</span>
<a href="#l18.407"></a><span id="l18.407" class="difflineminus">-        } catch (ex) {</span>
<a href="#l18.408"></a><span id="l18.408" class="difflineminus">-          logger.warn(</span>
<a href="#l18.409"></a><span id="l18.409" class="difflineminus">-            `Exception running bootstrap method uninstall on ${extension.id}`,</span>
<a href="#l18.410"></a><span id="l18.410" class="difflineminus">-            ex</span>
<a href="#l18.411"></a><span id="l18.411" class="difflineminus">-          );</span>
<a href="#l18.412"></a><span id="l18.412" class="difflineminus">-        } finally {</span>
<a href="#l18.413"></a><span id="l18.413" class="difflineminus">-          // Forget any cached files we might've had from this extension.</span>
<a href="#l18.414"></a><span id="l18.414" class="difflineminus">-          Services.obs.notifyObservers(null, &quot;startupcache-invalidate&quot;);</span>
<a href="#l18.415"></a><span id="l18.415" class="difflineminus">-        }</span>
<a href="#l18.416"></a><span id="l18.416" class="difflineminus">-      },</span>
<a href="#l18.417"></a><span id="l18.417" class="difflineminus">-</span>
<a href="#l18.418"></a><span id="l18.418" class="difflineminus">-      startup(...args) {</span>
<a href="#l18.419"></a><span id="l18.419" class="difflineminus">-        logger.debug(`Registering manifest for ${file.path}\n`);</span>
<a href="#l18.420"></a><span id="l18.420" class="difflineminus">-        Components.manager.addBootstrappedManifestLocation(file);</span>
<a href="#l18.421"></a><span id="l18.421" class="difflineminus">-        try {</span>
<a href="#l18.422"></a><span id="l18.422" class="difflineminus">-          startup(...args);</span>
<a href="#l18.423"></a><span id="l18.423" class="difflineminus">-        } catch (ex) {</span>
<a href="#l18.424"></a><span id="l18.424" class="difflineminus">-          logger.warn(</span>
<a href="#l18.425"></a><span id="l18.425" class="difflineminus">-            `Exception running bootstrap method startup on ${extension.id}`,</span>
<a href="#l18.426"></a><span id="l18.426" class="difflineminus">-            ex</span>
<a href="#l18.427"></a><span id="l18.427" class="difflineminus">-          );</span>
<a href="#l18.428"></a><span id="l18.428" class="difflineminus">-        }</span>
<a href="#l18.429"></a><span id="l18.429" class="difflineminus">-      },</span>
<a href="#l18.430"></a><span id="l18.430" class="difflineminus">-</span>
<a href="#l18.431"></a><span id="l18.431" class="difflineminus">-      shutdown(data, reason) {</span>
<a href="#l18.432"></a><span id="l18.432" class="difflineminus">-        try {</span>
<a href="#l18.433"></a><span id="l18.433" class="difflineminus">-          shutdown(data, reason);</span>
<a href="#l18.434"></a><span id="l18.434" class="difflineminus">-        } catch (ex) {</span>
<a href="#l18.435"></a><span id="l18.435" class="difflineminus">-          logger.warn(</span>
<a href="#l18.436"></a><span id="l18.436" class="difflineminus">-            `Exception running bootstrap method shutdown on ${extension.id}`,</span>
<a href="#l18.437"></a><span id="l18.437" class="difflineminus">-            ex</span>
<a href="#l18.438"></a><span id="l18.438" class="difflineminus">-          );</span>
<a href="#l18.439"></a><span id="l18.439" class="difflineminus">-        } finally {</span>
<a href="#l18.440"></a><span id="l18.440" class="difflineminus">-          if (reason != BOOTSTRAP_REASONS.APP_SHUTDOWN) {</span>
<a href="#l18.441"></a><span id="l18.441" class="difflineminus">-            logger.debug(`Removing manifest for ${file.path}\n`);</span>
<a href="#l18.442"></a><span id="l18.442" class="difflineminus">-            Components.manager.removeBootstrappedManifestLocation(file);</span>
<a href="#l18.443"></a><span id="l18.443" class="difflineminus">-          }</span>
<a href="#l18.444"></a><span id="l18.444" class="difflineminus">-        }</span>
<a href="#l18.445"></a><span id="l18.445" class="difflineminus">-      },</span>
<a href="#l18.446"></a><span id="l18.446" class="difflineminus">-    };</span>
<a href="#l18.447"></a><span id="l18.447" class="difflineminus">-  }</span>
<a href="#l18.448"></a><span id="l18.448" class="difflineminus">-};</span>
<a href="#l18.449"></a><span id="l18.449" class="difflineminus">-</span>
<a href="#l18.450"></a><span id="l18.450" class="difflineminus">-function getAllWindows() {</span>
<a href="#l18.451"></a><span id="l18.451" class="difflineminus">-  function getChildDocShells(parentDocShell) {</span>
<a href="#l18.452"></a><span id="l18.452" class="difflineminus">-    let docShells = parentDocShell.getAllDocShellsInSubtree(</span>
<a href="#l18.453"></a><span id="l18.453" class="difflineminus">-      Ci.nsIDocShellTreeItem.typeAll,</span>
<a href="#l18.454"></a><span id="l18.454" class="difflineminus">-      Ci.nsIDocShell.ENUMERATE_FORWARDS</span>
<a href="#l18.455"></a><span id="l18.455" class="difflineminus">-    );</span>
<a href="#l18.456"></a><span id="l18.456" class="difflineminus">-</span>
<a href="#l18.457"></a><span id="l18.457" class="difflineminus">-    for (let docShell of docShells) {</span>
<a href="#l18.458"></a><span id="l18.458" class="difflineminus">-      docShell</span>
<a href="#l18.459"></a><span id="l18.459" class="difflineminus">-        .QueryInterface(Ci.nsIInterfaceRequestor)</span>
<a href="#l18.460"></a><span id="l18.460" class="difflineminus">-        .getInterface(Ci.nsIWebProgress);</span>
<a href="#l18.461"></a><span id="l18.461" class="difflineminus">-      domWindows.push(docShell.domWindow);</span>
<a href="#l18.462"></a><span id="l18.462" class="difflineminus">-    }</span>
<a href="#l18.463"></a><span id="l18.463" class="difflineminus">-  }</span>
<a href="#l18.464"></a><span id="l18.464" class="difflineminus">-</span>
<a href="#l18.465"></a><span id="l18.465" class="difflineminus">-  let domWindows = [];</span>
<a href="#l18.466"></a><span id="l18.466" class="difflineminus">-  for (let win of Services.ww.getWindowEnumerator()) {</span>
<a href="#l18.467"></a><span id="l18.467" class="difflineminus">-    let parentDocShell = win</span>
<a href="#l18.468"></a><span id="l18.468" class="difflineminus">-      .getInterface(Ci.nsIWebNavigation)</span>
<a href="#l18.469"></a><span id="l18.469" class="difflineminus">-      .QueryInterface(Ci.nsIDocShell);</span>
<a href="#l18.470"></a><span id="l18.470" class="difflineminus">-    getChildDocShells(parentDocShell);</span>
<a href="#l18.471"></a><span id="l18.471" class="difflineminus">-  }</span>
<a href="#l18.472"></a><span id="l18.472" class="difflineminus">-  return domWindows;</span>
<a href="#l18.473"></a><span id="l18.473" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1">deleted file mode 100644</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineminus">--- a/mail/components/extensions/schemas/legacy.json</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineplus">+++ /dev/null</span>
<a href="#l19.4"></a><span id="l19.4" class="difflineat">@@ -1,43 +0,0 @@</span>
<a href="#l19.5"></a><span id="l19.5" class="difflineminus">-[</span>
<a href="#l19.6"></a><span id="l19.6" class="difflineminus">-  {</span>
<a href="#l19.7"></a><span id="l19.7" class="difflineminus">-    &quot;namespace&quot;: &quot;manifest&quot;,</span>
<a href="#l19.8"></a><span id="l19.8" class="difflineminus">-    &quot;types&quot;: [</span>
<a href="#l19.9"></a><span id="l19.9" class="difflineminus">-      {</span>
<a href="#l19.10"></a><span id="l19.10" class="difflineminus">-        &quot;$extend&quot;: &quot;WebExtensionManifest&quot;,</span>
<a href="#l19.11"></a><span id="l19.11" class="difflineminus">-        &quot;properties&quot;: {</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-          &quot;legacy&quot;: {</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineminus">-            &quot;optional&quot;: true,</span>
<a href="#l19.14"></a><span id="l19.14" class="difflineminus">-            &quot;choices&quot;: [</span>
<a href="#l19.15"></a><span id="l19.15" class="difflineminus">-              {</span>
<a href="#l19.16"></a><span id="l19.16" class="difflineminus">-                &quot;type&quot;: &quot;boolean&quot;</span>
<a href="#l19.17"></a><span id="l19.17" class="difflineminus">-              },</span>
<a href="#l19.18"></a><span id="l19.18" class="difflineminus">-              {</span>
<a href="#l19.19"></a><span id="l19.19" class="difflineminus">-                &quot;type&quot;: &quot;object&quot;,</span>
<a href="#l19.20"></a><span id="l19.20" class="difflineminus">-                &quot;properties&quot;: {</span>
<a href="#l19.21"></a><span id="l19.21" class="difflineminus">-                  &quot;type&quot;: {</span>
<a href="#l19.22"></a><span id="l19.22" class="difflineminus">-                    &quot;type&quot;: &quot;string&quot;,</span>
<a href="#l19.23"></a><span id="l19.23" class="difflineminus">-                    &quot;enum&quot;: [&quot;xul&quot;, &quot;bootstrap&quot;],</span>
<a href="#l19.24"></a><span id="l19.24" class="difflineminus">-                    &quot;optional&quot;: true</span>
<a href="#l19.25"></a><span id="l19.25" class="difflineminus">-                  },</span>
<a href="#l19.26"></a><span id="l19.26" class="difflineminus">-                  &quot;options&quot;: {</span>
<a href="#l19.27"></a><span id="l19.27" class="difflineminus">-                    &quot;type&quot;: &quot;object&quot;,</span>
<a href="#l19.28"></a><span id="l19.28" class="difflineminus">-                    &quot;properties&quot;: {</span>
<a href="#l19.29"></a><span id="l19.29" class="difflineminus">-                      &quot;page&quot;: {</span>
<a href="#l19.30"></a><span id="l19.30" class="difflineminus">-                        &quot;type&quot;: &quot;string&quot;</span>
<a href="#l19.31"></a><span id="l19.31" class="difflineminus">-                      },</span>
<a href="#l19.32"></a><span id="l19.32" class="difflineminus">-                      &quot;open_in_tab&quot;: {</span>
<a href="#l19.33"></a><span id="l19.33" class="difflineminus">-                        &quot;type&quot;: &quot;boolean&quot;,</span>
<a href="#l19.34"></a><span id="l19.34" class="difflineminus">-                        &quot;optional&quot;: true</span>
<a href="#l19.35"></a><span id="l19.35" class="difflineminus">-                      }</span>
<a href="#l19.36"></a><span id="l19.36" class="difflineminus">-                    },</span>
<a href="#l19.37"></a><span id="l19.37" class="difflineminus">-                    &quot;optional&quot;: true</span>
<a href="#l19.38"></a><span id="l19.38" class="difflineminus">-                  }</span>
<a href="#l19.39"></a><span id="l19.39" class="difflineminus">-                }</span>
<a href="#l19.40"></a><span id="l19.40" class="difflineminus">-              }</span>
<a href="#l19.41"></a><span id="l19.41" class="difflineminus">-            ]</span>
<a href="#l19.42"></a><span id="l19.42" class="difflineminus">-          }</span>
<a href="#l19.43"></a><span id="l19.43" class="difflineminus">-        }</span>
<a href="#l19.44"></a><span id="l19.44" class="difflineminus">-      }</span>
<a href="#l19.45"></a><span id="l19.45" class="difflineminus">-    ]</span>
<a href="#l19.46"></a><span id="l19.46" class="difflineminus">-  }</span>
<a href="#l19.47"></a><span id="l19.47" class="difflineminus">-]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/mail/locales/en-US/chrome/messenger/addons.properties</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/mail/locales/en-US/chrome/messenger/addons.properties</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -17,24 +17,16 @@ xpinstallDisabledButton.accesskey=n</span>
<a href="#l20.4"></a><span id="l20.4"> # %2$S is replaced with the localized name of the application.</span>
<a href="#l20.5"></a><span id="l20.5"> addonPostInstall.message1=%1$S has been added to %2$S.</span>
<a href="#l20.6"></a><span id="l20.6"> # LOCALIZATION NOTE (addonPostInstall.multiple.message1)</span>
<a href="#l20.7"></a><span id="l20.7"> # %1$S is replaced with the localized name of the application.</span>
<a href="#l20.8"></a><span id="l20.8"> addonPostInstall.multiple.message=These add-ons have been added to %1$S:</span>
<a href="#l20.9"></a><span id="l20.9"> addonPostInstall.okay.label=OK</span>
<a href="#l20.10"></a><span id="l20.10"> addonPostInstall.okay.accesskey=O</span>
<a href="#l20.11"></a><span id="l20.11"> </span>
<a href="#l20.12"></a><span id="l20.12" class="difflineminus">-# LOCALIZATION NOTE (addonPostInstall.restartRequired.message)</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineminus">-# %S is the application name</span>
<a href="#l20.14"></a><span id="l20.14" class="difflineminus">-addonPostInstall.restartRequired.message=%S must be restarted to complete the installation.</span>
<a href="#l20.15"></a><span id="l20.15" class="difflineminus">-addonPostInstall.restart.label=Restart now</span>
<a href="#l20.16"></a><span id="l20.16" class="difflineminus">-addonPostInstall.restart.accesskey=R</span>
<a href="#l20.17"></a><span id="l20.17" class="difflineminus">-addonPostInstall.noRestart.label=Not now</span>
<a href="#l20.18"></a><span id="l20.18" class="difflineminus">-addonPostInstall.noRestart.accesskey=N</span>
<a href="#l20.19"></a><span id="l20.19" class="difflineminus">-</span>
<a href="#l20.20"></a><span id="l20.20"> # LOCALIZATION NOTE (addonDownloadingAndVerifying):</span>
<a href="#l20.21"></a><span id="l20.21"> # Semicolon-separated list of plural forms. See:</span>
<a href="#l20.22"></a><span id="l20.22"> # http://developer.mozilla.org/en/docs/Localization_and_Plurals</span>
<a href="#l20.23"></a><span id="l20.23"> # Also see https://bugzilla.mozilla.org/show_bug.cgi?id=570012 for mockups</span>
<a href="#l20.24"></a><span id="l20.24"> addonDownloadingAndVerifying=Downloading and verifying add-on;Downloading and verifying #1 add-ons</span>
<a href="#l20.25"></a><span id="l20.25"> addonDownloadVerifying=Verifying</span>
<a href="#l20.26"></a><span id="l20.26"> </span>
<a href="#l20.27"></a><span id="l20.27"> addonInstall.unsigned=(Unverified)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1">deleted file mode 100644</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineminus">--- a/mail/locales/en-US/chrome/messenger/extensionsOverlay.properties</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineplus">+++ /dev/null</span>
<a href="#l21.4"></a><span id="l21.4" class="difflineat">@@ -1,17 +0,0 @@</span>
<a href="#l21.5"></a><span id="l21.5" class="difflineminus">-# This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l21.6"></a><span id="l21.6" class="difflineminus">-# License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l21.7"></a><span id="l21.7" class="difflineminus">-# file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l21.8"></a><span id="l21.8" class="difflineminus">-</span>
<a href="#l21.9"></a><span id="l21.9" class="difflineminus">-# LOCALIZATION NOTE (warnLegacyUpgrade, warnLegacyDowngrade, warnLegacyEnable, warnLegacyDisable, warnLegacyInstall, warnLegacyUninstall)</span>
<a href="#l21.10"></a><span id="l21.10" class="difflineminus">-# %1$S is the add-on name, %2$S is brand name</span>
<a href="#l21.11"></a><span id="l21.11" class="difflineminus">-warnLegacyUpgrade=%1$S will be upgraded after you restart %2$S.</span>
<a href="#l21.12"></a><span id="l21.12" class="difflineminus">-warnLegacyDowngrade=%1$S will be downgraded after you restart %2$S.</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineminus">-warnLegacyEnable=%1$S will be enabled after you restart %2$S.</span>
<a href="#l21.14"></a><span id="l21.14" class="difflineminus">-warnLegacyDisable=%1$S will be disabled after you restart %2$S.</span>
<a href="#l21.15"></a><span id="l21.15" class="difflineminus">-warnLegacyInstall=%1$S will be installed after you restart %2$S.</span>
<a href="#l21.16"></a><span id="l21.16" class="difflineminus">-warnLegacyUninstall=%1$S will be uninstalled after you restart %2$S.</span>
<a href="#l21.17"></a><span id="l21.17" class="difflineminus">-warnLegacyRestartButton=Restart</span>
<a href="#l21.18"></a><span id="l21.18" class="difflineminus">-warnLegacyUndoButton=Undo</span>
<a href="#l21.19"></a><span id="l21.19" class="difflineminus">-</span>
<a href="#l21.20"></a><span id="l21.20" class="difflineminus">-globalRestartMessage=Some operations will not be completed until you restart %S.</span>
<a href="#l21.21"></a><span id="l21.21" class="difflineminus">-globalRestartButton=Restart Now</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/mail/locales/jar.mn</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/mail/locales/jar.mn</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -83,17 +83,16 @@</span>
<a href="#l22.4"></a><span id="l22.4">   locale/@AB_CD@/messenger/folderpane.dtd                               (%chrome/messenger/folderpane.dtd)</span>
<a href="#l22.5"></a><span id="l22.5">   locale/@AB_CD@/messenger/folderProps.dtd                              (%chrome/messenger/folderProps.dtd)</span>
<a href="#l22.6"></a><span id="l22.6">   locale/@AB_CD@/messenger/folderWidgets.properties                     (%chrome/messenger/folderWidgets.properties)</span>
<a href="#l22.7"></a><span id="l22.7">   locale/@AB_CD@/messenger/subscribe.dtd                                (%chrome/messenger/subscribe.dtd)</span>
<a href="#l22.8"></a><span id="l22.8">   locale/@AB_CD@/messenger/subscribe.properties                         (%chrome/messenger/subscribe.properties)</span>
<a href="#l22.9"></a><span id="l22.9">   locale/@AB_CD@/messenger/msgHdrViewOverlay.dtd                        (%chrome/messenger/msgHdrViewOverlay.dtd)</span>
<a href="#l22.10"></a><span id="l22.10">   locale/@AB_CD@/messenger/editContactOverlay.dtd                       (%chrome/messenger/editContactOverlay.dtd)</span>
<a href="#l22.11"></a><span id="l22.11">   locale/@AB_CD@/messenger/editContactOverlay.properties                (%chrome/messenger/editContactOverlay.properties)</span>
<a href="#l22.12"></a><span id="l22.12" class="difflineminus">-  locale/@AB_CD@/messenger/extensionsOverlay.properties                 (%chrome/messenger/extensionsOverlay.properties)</span>
<a href="#l22.13"></a><span id="l22.13">   locale/@AB_CD@/messenger/mailEditorOverlay.dtd                        (%chrome/messenger/mailEditorOverlay.dtd)</span>
<a href="#l22.14"></a><span id="l22.14">   locale/@AB_CD@/messenger/msgSynchronize.dtd                           (%chrome/messenger/msgSynchronize.dtd)</span>
<a href="#l22.15"></a><span id="l22.15">   locale/@AB_CD@/messenger/offline.properties                           (%chrome/messenger/offline.properties)</span>
<a href="#l22.16"></a><span id="l22.16">   locale/@AB_CD@/messenger/junkMailInfo.dtd                             (%chrome/messenger/junkMailInfo.dtd)</span>
<a href="#l22.17"></a><span id="l22.17">   locale/@AB_CD@/messenger/viewLog.dtd                                  (%chrome/messenger/viewLog.dtd)</span>
<a href="#l22.18"></a><span id="l22.18">   locale/@AB_CD@/messenger/FilterListDialog.dtd                         (%chrome/messenger/FilterListDialog.dtd)</span>
<a href="#l22.19"></a><span id="l22.19">   locale/@AB_CD@/messenger/CustomHeaders.dtd                            (%chrome/messenger/CustomHeaders.dtd)</span>
<a href="#l22.20"></a><span id="l22.20">   locale/@AB_CD@/messenger/FilterEditor.dtd                             (%chrome/messenger/FilterEditor.dtd)</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:32Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

