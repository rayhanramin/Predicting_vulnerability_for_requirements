<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 3538:1ebec2bae790867f0a3248fb7425aef28d67eb84</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 1ebec2bae790867f0a3248fb7425aef28d67eb84" />
<meta property="og:url" content="/comm-central/rev/1ebec2bae790867f0a3248fb7425aef28d67eb84" />
<meta property="og:description" content="Bug 127250 - &quot;&quot;Body&quot; filter for IMAP messages downloaded for offline use.&quot; - implement filter functions. [r+sr=bienvenu]" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 1ebec2bae790867f0a3248fb7425aef28d67eb84 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/1ebec2bae790867f0a3248fb7425aef28d67eb84">shortlog</a> |
<a href="/comm-central/log/1ebec2bae790867f0a3248fb7425aef28d67eb84">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/1ebec2bae790867f0a3248fb7425aef28d67eb84">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/1ebec2bae790867f0a3248fb7425aef28d67eb84">files</a> |
changeset |
<a href="/comm-central/raw-rev/1ebec2bae790867f0a3248fb7425aef28d67eb84">raw</a>  | <a href="/comm-central/archive/1ebec2bae790867f0a3248fb7425aef28d67eb84.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=127250">Bug 127250</a> - &quot;&quot;Body&quot; filter for IMAP messages downloaded for offline use.&quot; - implement filter functions. [r+sr=bienvenu]
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#75;&#101;&#110;&#116;&#32;&#74;&#97;&#109;&#101;&#115;&#32;&#60;&#107;&#101;&#110;&#116;&#64;&#99;&#97;&#115;&#112;&#105;&#97;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Fri, 04 Sep 2009 22:14:23 +0100</td></tr>

<tr>
 <td>changeset 3538</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/1ebec2bae790867f0a3248fb7425aef28d67eb84">1ebec2bae790867f0a3248fb7425aef28d67eb84</a></td>
</tr>



<tr>
<td>parent 3537</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/35517958abb838fd57fdffb7afff6c488332f2a9">35517958abb838fd57fdffb7afff6c488332f2a9</a>
</td>
</tr>

<tr>
<td>child 3539</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/658e53329043e4ace7b0fb65ea5a6bf1b6438872">658e53329043e4ace7b0fb65ea5a6bf1b6438872</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=1ebec2bae790867f0a3248fb7425aef28d67eb84">2868</a></td></tr>
<tr><td>push user</td><td>bugzilla@standard8.plus.com</td></tr>
<tr><td>push date</td><td class="date age">Fri, 04 Sep 2009 21:15:52 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@b11a45aa831d [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=b11a45aa831d50594e7f23968bda9bc010103ef1">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=b11a45aa831d50594e7f23968bda9bc010103ef1&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=b11a45aa831d50594e7f23968bda9bc010103ef1&newProject=comm-central&newRevision=1268379f1c021037291bcf0790e4ac9eb4a52593&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=b11a45aa831d50594e7f23968bda9bc010103ef1&newProject=comm-central&newRevision=1268379f1c021037291bcf0790e4ac9eb4a52593&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=b11a45aa831d50594e7f23968bda9bc010103ef1&newProject=comm-central&newRevision=1268379f1c021037291bcf0790e4ac9eb4a52593&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>

<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=127250">127250</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=127250">Bug 127250</a> - &quot;&quot;Body&quot; filter for IMAP messages downloaded for offline use.&quot; - implement filter functions. [r+sr=bienvenu]</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1ebec2bae790867f0a3248fb7425aef28d67eb84/mailnews/base/search/public/nsIMsgSearchCustomTerm.idl">mailnews/base/search/public/nsIMsgSearchCustomTerm.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1ebec2bae790867f0a3248fb7425aef28d67eb84/mailnews/base/search/public/nsIMsgSearchCustomTerm.idl">file</a> |
<a href="/comm-central/annotate/1ebec2bae790867f0a3248fb7425aef28d67eb84/mailnews/base/search/public/nsIMsgSearchCustomTerm.idl">annotate</a> |
<a href="/comm-central/diff/1ebec2bae790867f0a3248fb7425aef28d67eb84/mailnews/base/search/public/nsIMsgSearchCustomTerm.idl">diff</a> |
<a href="/comm-central/comparison/1ebec2bae790867f0a3248fb7425aef28d67eb84/mailnews/base/search/public/nsIMsgSearchCustomTerm.idl">comparison</a> |
<a href="/comm-central/log/1ebec2bae790867f0a3248fb7425aef28d67eb84/mailnews/base/search/public/nsIMsgSearchCustomTerm.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1ebec2bae790867f0a3248fb7425aef28d67eb84/mailnews/base/util/nsMsgDBFolder.cpp">mailnews/base/util/nsMsgDBFolder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1ebec2bae790867f0a3248fb7425aef28d67eb84/mailnews/base/util/nsMsgDBFolder.cpp">file</a> |
<a href="/comm-central/annotate/1ebec2bae790867f0a3248fb7425aef28d67eb84/mailnews/base/util/nsMsgDBFolder.cpp">annotate</a> |
<a href="/comm-central/diff/1ebec2bae790867f0a3248fb7425aef28d67eb84/mailnews/base/util/nsMsgDBFolder.cpp">diff</a> |
<a href="/comm-central/comparison/1ebec2bae790867f0a3248fb7425aef28d67eb84/mailnews/base/util/nsMsgDBFolder.cpp">comparison</a> |
<a href="/comm-central/log/1ebec2bae790867f0a3248fb7425aef28d67eb84/mailnews/base/util/nsMsgDBFolder.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1ebec2bae790867f0a3248fb7425aef28d67eb84/mailnews/base/util/nsMsgDBFolder.h">mailnews/base/util/nsMsgDBFolder.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1ebec2bae790867f0a3248fb7425aef28d67eb84/mailnews/base/util/nsMsgDBFolder.h">file</a> |
<a href="/comm-central/annotate/1ebec2bae790867f0a3248fb7425aef28d67eb84/mailnews/base/util/nsMsgDBFolder.h">annotate</a> |
<a href="/comm-central/diff/1ebec2bae790867f0a3248fb7425aef28d67eb84/mailnews/base/util/nsMsgDBFolder.h">diff</a> |
<a href="/comm-central/comparison/1ebec2bae790867f0a3248fb7425aef28d67eb84/mailnews/base/util/nsMsgDBFolder.h">comparison</a> |
<a href="/comm-central/log/1ebec2bae790867f0a3248fb7425aef28d67eb84/mailnews/base/util/nsMsgDBFolder.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1ebec2bae790867f0a3248fb7425aef28d67eb84/mailnews/imap/src/nsImapIncomingServer.cpp">mailnews/imap/src/nsImapIncomingServer.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1ebec2bae790867f0a3248fb7425aef28d67eb84/mailnews/imap/src/nsImapIncomingServer.cpp">file</a> |
<a href="/comm-central/annotate/1ebec2bae790867f0a3248fb7425aef28d67eb84/mailnews/imap/src/nsImapIncomingServer.cpp">annotate</a> |
<a href="/comm-central/diff/1ebec2bae790867f0a3248fb7425aef28d67eb84/mailnews/imap/src/nsImapIncomingServer.cpp">diff</a> |
<a href="/comm-central/comparison/1ebec2bae790867f0a3248fb7425aef28d67eb84/mailnews/imap/src/nsImapIncomingServer.cpp">comparison</a> |
<a href="/comm-central/log/1ebec2bae790867f0a3248fb7425aef28d67eb84/mailnews/imap/src/nsImapIncomingServer.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1ebec2bae790867f0a3248fb7425aef28d67eb84/mailnews/imap/src/nsImapMailFolder.cpp">mailnews/imap/src/nsImapMailFolder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1ebec2bae790867f0a3248fb7425aef28d67eb84/mailnews/imap/src/nsImapMailFolder.cpp">file</a> |
<a href="/comm-central/annotate/1ebec2bae790867f0a3248fb7425aef28d67eb84/mailnews/imap/src/nsImapMailFolder.cpp">annotate</a> |
<a href="/comm-central/diff/1ebec2bae790867f0a3248fb7425aef28d67eb84/mailnews/imap/src/nsImapMailFolder.cpp">diff</a> |
<a href="/comm-central/comparison/1ebec2bae790867f0a3248fb7425aef28d67eb84/mailnews/imap/src/nsImapMailFolder.cpp">comparison</a> |
<a href="/comm-central/log/1ebec2bae790867f0a3248fb7425aef28d67eb84/mailnews/imap/src/nsImapMailFolder.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1ebec2bae790867f0a3248fb7425aef28d67eb84/mailnews/imap/src/nsImapMailFolder.h">mailnews/imap/src/nsImapMailFolder.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1ebec2bae790867f0a3248fb7425aef28d67eb84/mailnews/imap/src/nsImapMailFolder.h">file</a> |
<a href="/comm-central/annotate/1ebec2bae790867f0a3248fb7425aef28d67eb84/mailnews/imap/src/nsImapMailFolder.h">annotate</a> |
<a href="/comm-central/diff/1ebec2bae790867f0a3248fb7425aef28d67eb84/mailnews/imap/src/nsImapMailFolder.h">diff</a> |
<a href="/comm-central/comparison/1ebec2bae790867f0a3248fb7425aef28d67eb84/mailnews/imap/src/nsImapMailFolder.h">comparison</a> |
<a href="/comm-central/log/1ebec2bae790867f0a3248fb7425aef28d67eb84/mailnews/imap/src/nsImapMailFolder.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1ebec2bae790867f0a3248fb7425aef28d67eb84/mailnews/imap/test/unit/test_imapFilterActions.js">mailnews/imap/test/unit/test_imapFilterActions.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1ebec2bae790867f0a3248fb7425aef28d67eb84/mailnews/imap/test/unit/test_imapFilterActions.js">file</a> |
<a href="/comm-central/annotate/1ebec2bae790867f0a3248fb7425aef28d67eb84/mailnews/imap/test/unit/test_imapFilterActions.js">annotate</a> |
<a href="/comm-central/diff/1ebec2bae790867f0a3248fb7425aef28d67eb84/mailnews/imap/test/unit/test_imapFilterActions.js">diff</a> |
<a href="/comm-central/comparison/1ebec2bae790867f0a3248fb7425aef28d67eb84/mailnews/imap/test/unit/test_imapFilterActions.js">comparison</a> |
<a href="/comm-central/log/1ebec2bae790867f0a3248fb7425aef28d67eb84/mailnews/imap/test/unit/test_imapFilterActions.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1ebec2bae790867f0a3248fb7425aef28d67eb84/mailnews/local/src/nsLocalMailFolder.cpp">mailnews/local/src/nsLocalMailFolder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1ebec2bae790867f0a3248fb7425aef28d67eb84/mailnews/local/src/nsLocalMailFolder.cpp">file</a> |
<a href="/comm-central/annotate/1ebec2bae790867f0a3248fb7425aef28d67eb84/mailnews/local/src/nsLocalMailFolder.cpp">annotate</a> |
<a href="/comm-central/diff/1ebec2bae790867f0a3248fb7425aef28d67eb84/mailnews/local/src/nsLocalMailFolder.cpp">diff</a> |
<a href="/comm-central/comparison/1ebec2bae790867f0a3248fb7425aef28d67eb84/mailnews/local/src/nsLocalMailFolder.cpp">comparison</a> |
<a href="/comm-central/log/1ebec2bae790867f0a3248fb7425aef28d67eb84/mailnews/local/src/nsLocalMailFolder.cpp">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/base/search/public/nsIMsgSearchCustomTerm.idl</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/base/search/public/nsIMsgSearchCustomTerm.idl</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -34,32 +34,35 @@</span>
<a href="#l1.4"></a><span id="l1.4">  *</span>
<a href="#l1.5"></a><span id="l1.5">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l1.6"></a><span id="l1.6"> </span>
<a href="#l1.7"></a><span id="l1.7"> #include &quot;nsMsgSearchCore.idl&quot;</span>
<a href="#l1.8"></a><span id="l1.8"> </span>
<a href="#l1.9"></a><span id="l1.9"> /**</span>
<a href="#l1.10"></a><span id="l1.10">  * describes a custom term added to a message search or filter</span>
<a href="#l1.11"></a><span id="l1.11">  */</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-[scriptable,uuid(8DD6E135-6790-475e-9547-3C1408CF2F08)]</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+[scriptable,uuid(925DB5AA-21AF-494c-8652-984BC7BAD13A)]</span>
<a href="#l1.14"></a><span id="l1.14"> interface nsIMsgSearchCustomTerm : nsISupports</span>
<a href="#l1.15"></a><span id="l1.15"> {</span>
<a href="#l1.16"></a><span id="l1.16">   /**</span>
<a href="#l1.17"></a><span id="l1.17">    * globally unique string to identify this search term.</span>
<a href="#l1.18"></a><span id="l1.18">    * recommended form: ExtensionName@example.com#TermName</span>
<a href="#l1.19"></a><span id="l1.19">    * Commas and quotes are not allowed, the id must not</span>
<a href="#l1.20"></a><span id="l1.20">    * parse to an integer, and names of standard search</span>
<a href="#l1.21"></a><span id="l1.21">    * attributes in SearchAttribEntryTable in nsMsgSearchTerm.cpp</span>
<a href="#l1.22"></a><span id="l1.22">    * are not allowed.</span>
<a href="#l1.23"></a><span id="l1.23">    */</span>
<a href="#l1.24"></a><span id="l1.24">   readonly attribute ACString id;</span>
<a href="#l1.25"></a><span id="l1.25"> </span>
<a href="#l1.26"></a><span id="l1.26">   /// name to display in term list. This should be localized. */</span>
<a href="#l1.27"></a><span id="l1.27">   readonly attribute AString name;</span>
<a href="#l1.28"></a><span id="l1.28"> </span>
<a href="#l1.29"></a><span id="l1.29" class="difflineplus">+  /// Does this term need the message body?</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineplus">+  readonly attribute boolean needsBody;</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineplus">+</span>
<a href="#l1.32"></a><span id="l1.32">   /**</span>
<a href="#l1.33"></a><span id="l1.33">    * Is this custom term enabled?</span>
<a href="#l1.34"></a><span id="l1.34">    *</span>
<a href="#l1.35"></a><span id="l1.35">    * @param scope          search scope (nsMsgSearchScope)</span>
<a href="#l1.36"></a><span id="l1.36">    * @param op             search operator (nsMsgSearchOp). If null, determine</span>
<a href="#l1.37"></a><span id="l1.37">    *                       if term is available for any operator.</span>
<a href="#l1.38"></a><span id="l1.38">    *</span>
<a href="#l1.39"></a><span id="l1.39">    * @return               true if enabled</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/base/util/nsMsgDBFolder.cpp</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgDBFolder.cpp</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -128,16 +128,17 @@ nsIAtom* nsMsgDBFolder::kNumNewBiffMessa</span>
<a href="#l2.4"></a><span id="l2.4"> nsIAtom* nsMsgDBFolder::kTotalUnreadMessagesAtom=nsnull;</span>
<a href="#l2.5"></a><span id="l2.5"> nsIAtom* nsMsgDBFolder::kFlaggedAtom=nsnull;</span>
<a href="#l2.6"></a><span id="l2.6"> nsIAtom* nsMsgDBFolder::kStatusAtom=nsnull;</span>
<a href="#l2.7"></a><span id="l2.7"> nsIAtom* nsMsgDBFolder::kNameAtom=nsnull;</span>
<a href="#l2.8"></a><span id="l2.8"> nsIAtom* nsMsgDBFolder::kSynchronizeAtom=nsnull;</span>
<a href="#l2.9"></a><span id="l2.9"> nsIAtom* nsMsgDBFolder::kOpenAtom=nsnull;</span>
<a href="#l2.10"></a><span id="l2.10"> nsIAtom* nsMsgDBFolder::kIsDeferred=nsnull;</span>
<a href="#l2.11"></a><span id="l2.11"> nsIAtom* nsMsgDBFolder::kKeywords=nsnull;</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+nsIAtom* nsMsgDBFolder::mFiltersAppliedAtom=nsnull;</span>
<a href="#l2.13"></a><span id="l2.13"> </span>
<a href="#l2.14"></a><span id="l2.14"> nsICollation * nsMsgDBFolder::gCollationKeyGenerator = nsnull;</span>
<a href="#l2.15"></a><span id="l2.15"> </span>
<a href="#l2.16"></a><span id="l2.16"> PRUnichar *nsMsgDBFolder::kLocalizedInboxName;</span>
<a href="#l2.17"></a><span id="l2.17"> PRUnichar *nsMsgDBFolder::kLocalizedTrashName;</span>
<a href="#l2.18"></a><span id="l2.18"> PRUnichar *nsMsgDBFolder::kLocalizedSentName;</span>
<a href="#l2.19"></a><span id="l2.19"> PRUnichar *nsMsgDBFolder::kLocalizedDraftsName;</span>
<a href="#l2.20"></a><span id="l2.20"> PRUnichar *nsMsgDBFolder::kLocalizedTemplatesName;</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineat">@@ -169,17 +170,18 @@ const nsStaticAtom nsMsgDBFolder::folder</span>
<a href="#l2.22"></a><span id="l2.22">   { &quot;TotalUnreadMessages&quot;, &amp;nsMsgDBFolder::kTotalUnreadMessagesAtom },</span>
<a href="#l2.23"></a><span id="l2.23">   { &quot;TotalMessages&quot;, &amp;nsMsgDBFolder::kTotalMessagesAtom },</span>
<a href="#l2.24"></a><span id="l2.24">   { &quot;FolderSize&quot;, &amp;nsMsgDBFolder::kFolderSizeAtom },</span>
<a href="#l2.25"></a><span id="l2.25">   { &quot;Status&quot;, &amp;nsMsgDBFolder::kStatusAtom },</span>
<a href="#l2.26"></a><span id="l2.26">   { &quot;Flagged&quot;, &amp;nsMsgDBFolder::kFlaggedAtom },</span>
<a href="#l2.27"></a><span id="l2.27">   { &quot;Synchronize&quot;, &amp;nsMsgDBFolder::kSynchronizeAtom },</span>
<a href="#l2.28"></a><span id="l2.28">   { &quot;open&quot;, &amp;nsMsgDBFolder::kOpenAtom },</span>
<a href="#l2.29"></a><span id="l2.29">   { &quot;isDeferred&quot;, &amp;nsMsgDBFolder::kIsDeferred },</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineminus">-  { &quot;Keywords&quot;, &amp;nsMsgDBFolder::kKeywords }</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineplus">+  { &quot;Keywords&quot;, &amp;nsMsgDBFolder::kKeywords },</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineplus">+  { &quot;FiltersApplied&quot;, &amp;nsMsgDBFolder::mFiltersAppliedAtom }</span>
<a href="#l2.33"></a><span id="l2.33"> };</span>
<a href="#l2.34"></a><span id="l2.34"> </span>
<a href="#l2.35"></a><span id="l2.35"> nsMsgDBFolder::nsMsgDBFolder(void)</span>
<a href="#l2.36"></a><span id="l2.36"> : mAddListener(PR_TRUE),</span>
<a href="#l2.37"></a><span id="l2.37">   mNewMessages(PR_FALSE),</span>
<a href="#l2.38"></a><span id="l2.38">   mGettingNewMessages(PR_FALSE),</span>
<a href="#l2.39"></a><span id="l2.39">   mLastMessageLoaded(nsMsgKey_None),</span>
<a href="#l2.40"></a><span id="l2.40">   mFlags(0),</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineat">@@ -1698,17 +1700,18 @@ nsresult nsMsgDBFolder::CompactOfflineSt</span>
<a href="#l2.42"></a><span id="l2.42">   nsCOMPtr &lt;nsIMsgFolderCompactor&gt; folderCompactor =  do_CreateInstance(NS_MSGOFFLINESTORECOMPACTOR_CONTRACTID, &amp;rv);</span>
<a href="#l2.43"></a><span id="l2.43">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.44"></a><span id="l2.44">   return folderCompactor-&gt;Compact(this, PR_TRUE, aListener, inWindow);</span>
<a href="#l2.45"></a><span id="l2.45"> }</span>
<a href="#l2.46"></a><span id="l2.46"> </span>
<a href="#l2.47"></a><span id="l2.47"> nsresult</span>
<a href="#l2.48"></a><span id="l2.48"> nsMsgDBFolder::AutoCompact(nsIMsgWindow *aWindow)</span>
<a href="#l2.49"></a><span id="l2.49"> {</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aWindow);</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineplus">+  // we don't check for null aWindow, because this routine can get called</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineplus">+  // in unit tests where we have no window. Just assume not OK if no window.</span>
<a href="#l2.53"></a><span id="l2.53">   PRBool prompt;</span>
<a href="#l2.54"></a><span id="l2.54">   nsresult rv = GetPromptPurgeThreshold(&amp;prompt);</span>
<a href="#l2.55"></a><span id="l2.55">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.56"></a><span id="l2.56">   PRTime timeNow = PR_Now();   //time in microseconds</span>
<a href="#l2.57"></a><span id="l2.57">   PRTime timeAfterOneHourOfLastPurgeCheck;</span>
<a href="#l2.58"></a><span id="l2.58">   LL_ADD(timeAfterOneHourOfLastPurgeCheck, gtimeOfLastPurgeCheck, oneHour);</span>
<a href="#l2.59"></a><span id="l2.59">   if (LL_CMP(timeAfterOneHourOfLastPurgeCheck, &lt;, timeNow) &amp;&amp; prompt)</span>
<a href="#l2.60"></a><span id="l2.60">   {</span>
<a href="#l2.61"></a><span id="l2.61" class="difflineat">@@ -1790,17 +1793,17 @@ nsMsgDBFolder::AutoCompact(nsIMsgWindow </span>
<a href="#l2.62"></a><span id="l2.62">        {</span>
<a href="#l2.63"></a><span id="l2.63">          PRBool okToCompact = PR_FALSE;</span>
<a href="#l2.64"></a><span id="l2.64">          nsCOMPtr&lt;nsIPrefService&gt; pref = do_GetService(NS_PREFSERVICE_CONTRACTID);</span>
<a href="#l2.65"></a><span id="l2.65">          nsCOMPtr&lt;nsIPrefBranch&gt; branch;</span>
<a href="#l2.66"></a><span id="l2.66">          pref-&gt;GetBranch(&quot;&quot;, getter_AddRefs(branch));</span>
<a href="#l2.67"></a><span id="l2.67"> </span>
<a href="#l2.68"></a><span id="l2.68">          PRBool askBeforePurge;</span>
<a href="#l2.69"></a><span id="l2.69">          branch-&gt;GetBoolPref(PREF_MAIL_PURGE_ASK, &amp;askBeforePurge);</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineminus">-         if (askBeforePurge)</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineplus">+         if (askBeforePurge &amp;&amp; aWindow)</span>
<a href="#l2.72"></a><span id="l2.72">          {</span>
<a href="#l2.73"></a><span id="l2.73">            nsCOMPtr &lt;nsIStringBundle&gt; bundle;</span>
<a href="#l2.74"></a><span id="l2.74">            rv = GetBaseStringBundle(getter_AddRefs(bundle));</span>
<a href="#l2.75"></a><span id="l2.75">            NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.76"></a><span id="l2.76">            nsString dialogTitle;</span>
<a href="#l2.77"></a><span id="l2.77">            nsString confirmString;</span>
<a href="#l2.78"></a><span id="l2.78">            nsString checkboxText;</span>
<a href="#l2.79"></a><span id="l2.79">            nsString buttonCompactNowText;</span>
<a href="#l2.80"></a><span id="l2.80" class="difflineat">@@ -1831,17 +1834,17 @@ nsMsgDBFolder::AutoCompact(nsIMsgWindow </span>
<a href="#l2.81"></a><span id="l2.81">            if (!buttonPressed)</span>
<a href="#l2.82"></a><span id="l2.82">            {</span>
<a href="#l2.83"></a><span id="l2.83">              okToCompact = PR_TRUE;</span>
<a href="#l2.84"></a><span id="l2.84">              if (!alwaysAsk) // [ ] Always ask me before compacting folders automatically</span>
<a href="#l2.85"></a><span id="l2.85">                branch-&gt;SetBoolPref(PREF_MAIL_PURGE_ASK, PR_FALSE);</span>
<a href="#l2.86"></a><span id="l2.86">            }</span>
<a href="#l2.87"></a><span id="l2.87">          }</span>
<a href="#l2.88"></a><span id="l2.88">          else</span>
<a href="#l2.89"></a><span id="l2.89" class="difflineminus">-           okToCompact = PR_TRUE;</span>
<a href="#l2.90"></a><span id="l2.90" class="difflineplus">+           okToCompact = aWindow || !askBeforePurge;</span>
<a href="#l2.91"></a><span id="l2.91"> </span>
<a href="#l2.92"></a><span id="l2.92">          if (okToCompact)</span>
<a href="#l2.93"></a><span id="l2.93">          {</span>
<a href="#l2.94"></a><span id="l2.94">             nsCOMPtr &lt;nsIAtom&gt; aboutToCompactAtom = do_GetAtom(&quot;AboutToCompact&quot;);</span>
<a href="#l2.95"></a><span id="l2.95">             NotifyFolderEvent(aboutToCompactAtom);</span>
<a href="#l2.96"></a><span id="l2.96"> </span>
<a href="#l2.97"></a><span id="l2.97">            if ( localExpungedBytes &gt; 0)</span>
<a href="#l2.98"></a><span id="l2.98">            {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/base/util/nsMsgDBFolder.h</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgDBFolder.h</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -193,16 +193,17 @@ protected:</span>
<a href="#l3.4"></a><span id="l3.4">   nsCOMPtr&lt;nsIOutputStream&gt; m_tempMessageStream;</span>
<a href="#l3.5"></a><span id="l3.5"> </span>
<a href="#l3.6"></a><span id="l3.6">   nsCOMPtr &lt;nsIMsgRetentionSettings&gt; m_retentionSettings;</span>
<a href="#l3.7"></a><span id="l3.7">   nsCOMPtr &lt;nsIMsgDownloadSettings&gt; m_downloadSettings;</span>
<a href="#l3.8"></a><span id="l3.8">   static NS_MSG_BASE_STATIC_MEMBER_(nsIAtom*) mFolderLoadedAtom;</span>
<a href="#l3.9"></a><span id="l3.9">   static NS_MSG_BASE_STATIC_MEMBER_(nsIAtom*) mDeleteOrMoveMsgCompletedAtom;</span>
<a href="#l3.10"></a><span id="l3.10">   static NS_MSG_BASE_STATIC_MEMBER_(nsIAtom*) mDeleteOrMoveMsgFailedAtom;</span>
<a href="#l3.11"></a><span id="l3.11">   static NS_MSG_BASE_STATIC_MEMBER_(nsIAtom*) mJunkStatusChangedAtom;</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+  static NS_MSG_BASE_STATIC_MEMBER_(nsIAtom*) mFiltersAppliedAtom;</span>
<a href="#l3.13"></a><span id="l3.13">   static NS_MSG_BASE_STATIC_MEMBER_(nsrefcnt) mInstanceCount;</span>
<a href="#l3.14"></a><span id="l3.14"> </span>
<a href="#l3.15"></a><span id="l3.15"> protected:</span>
<a href="#l3.16"></a><span id="l3.16">   PRUint32 mFlags;</span>
<a href="#l3.17"></a><span id="l3.17">   nsWeakPtr mParent;     //This won't be refcounted for ownership reasons.</span>
<a href="#l3.18"></a><span id="l3.18">   PRInt32 mNumUnreadMessages;        /* count of unread messages (-1 means unknown; -2 means unknown but we already tried to find out.) */</span>
<a href="#l3.19"></a><span id="l3.19">   PRInt32 mNumTotalMessages;         /* count of existing messages. */</span>
<a href="#l3.20"></a><span id="l3.20">   PRBool mNotifyCountChanges;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/imap/src/nsImapIncomingServer.cpp</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapIncomingServer.cpp</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -2918,17 +2918,35 @@ nsImapIncomingServer::GetSupportsSubscri</span>
<a href="#l4.4"></a><span id="l4.4">   *retVal = PR_FALSE;</span>
<a href="#l4.5"></a><span id="l4.5">   return NS_OK;</span>
<a href="#l4.6"></a><span id="l4.6"> }</span>
<a href="#l4.7"></a><span id="l4.7"> </span>
<a href="#l4.8"></a><span id="l4.8"> NS_IMETHODIMP</span>
<a href="#l4.9"></a><span id="l4.9"> nsImapIncomingServer::GetFilterScope(nsMsgSearchScopeValue *filterScope)</span>
<a href="#l4.10"></a><span id="l4.10"> {</span>
<a href="#l4.11"></a><span id="l4.11">   NS_ENSURE_ARG_POINTER(filterScope);</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-  *filterScope = nsMsgSearchScope::onlineMailFilter;</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+  // If the inbox is enabled for offline use, then use the offline filter</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+  // scope, else use the online filter scope.</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+  //</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineplus">+  // XXX We use the same scope for all folders with the same incoming server,</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineplus">+  // yet it is possible to set the offline flag separately for each folder.</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineplus">+  // Manual filters could perhaps check the offline status of each folder,</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineplus">+  // though it's hard to see how to make that work since we only store filters</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineplus">+  // per server.</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineplus">+  // </span>
<a href="#l4.22"></a><span id="l4.22" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; rootMsgFolder;</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineplus">+  nsresult rv = GetRootMsgFolder(getter_AddRefs(rootMsgFolder));</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; offlineInboxMsgFolder;</span>
<a href="#l4.26"></a><span id="l4.26" class="difflineplus">+  rv = rootMsgFolder-&gt;GetFolderWithFlags(nsMsgFolderFlags::Inbox |</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineplus">+                                           nsMsgFolderFlags::Offline,</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineplus">+                                         getter_AddRefs(offlineInboxMsgFolder));</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineplus">+</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineplus">+  *filterScope = offlineInboxMsgFolder ? nsMsgSearchScope::offlineMailFilter</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineplus">+                                       : nsMsgSearchScope::onlineMailFilter;</span>
<a href="#l4.32"></a><span id="l4.32">   return NS_OK;</span>
<a href="#l4.33"></a><span id="l4.33"> }</span>
<a href="#l4.34"></a><span id="l4.34"> </span>
<a href="#l4.35"></a><span id="l4.35"> NS_IMETHODIMP</span>
<a href="#l4.36"></a><span id="l4.36"> nsImapIncomingServer::GetSearchScope(nsMsgSearchScopeValue *searchScope)</span>
<a href="#l4.37"></a><span id="l4.37"> {</span>
<a href="#l4.38"></a><span id="l4.38">   NS_ENSURE_ARG_POINTER(searchScope);</span>
<a href="#l4.39"></a><span id="l4.39">  *searchScope = WeAreOffline() ? nsMsgSearchScope::offlineMail : nsMsgSearchScope::onlineMail;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/imap/src/nsImapMailFolder.cpp</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapMailFolder.cpp</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -71,16 +71,18 @@</span>
<a href="#l5.4"></a><span id="l5.4"> #include &quot;nsTextFormatter.h&quot;</span>
<a href="#l5.5"></a><span id="l5.5"> #include &quot;nsIPrefBranch.h&quot;</span>
<a href="#l5.6"></a><span id="l5.6"> #include &quot;nsIPrefService.h&quot;</span>
<a href="#l5.7"></a><span id="l5.7"> #include &quot;nsMsgI18N.h&quot;</span>
<a href="#l5.8"></a><span id="l5.8"> #include &quot;nsICacheSession.h&quot;</span>
<a href="#l5.9"></a><span id="l5.9"> #include &quot;nsEscape.h&quot;</span>
<a href="#l5.10"></a><span id="l5.10"> #include &quot;nsIDOMWindowInternal.h&quot;</span>
<a href="#l5.11"></a><span id="l5.11"> #include &quot;nsIMsgFilter.h&quot;</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+#include &quot;nsIMsgFilterService.h&quot;</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+#include &quot;nsIMsgSearchCustomTerm.h&quot;</span>
<a href="#l5.14"></a><span id="l5.14"> #include &quot;nsImapMoveCoalescer.h&quot;</span>
<a href="#l5.15"></a><span id="l5.15"> #include &quot;nsIPrompt.h&quot;</span>
<a href="#l5.16"></a><span id="l5.16"> #include &quot;nsIPromptService.h&quot;</span>
<a href="#l5.17"></a><span id="l5.17"> #include &quot;nsIDocShell.h&quot;</span>
<a href="#l5.18"></a><span id="l5.18"> #include &quot;nsIInterfaceRequestor.h&quot;</span>
<a href="#l5.19"></a><span id="l5.19"> #include &quot;nsIInterfaceRequestorUtils.h&quot;</span>
<a href="#l5.20"></a><span id="l5.20"> #include &quot;nsReadableUtils.h&quot;</span>
<a href="#l5.21"></a><span id="l5.21"> #include &quot;nsUnicharUtils.h&quot;</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineat">@@ -217,17 +219,18 @@ nsImapMailFolder::nsImapMailFolder() :</span>
<a href="#l5.23"></a><span id="l5.23">     m_folderNeedsACLListed(PR_TRUE),</span>
<a href="#l5.24"></a><span id="l5.24">     m_performingBiff(PR_FALSE),</span>
<a href="#l5.25"></a><span id="l5.25">     m_folderQuotaCommandIssued(PR_FALSE),</span>
<a href="#l5.26"></a><span id="l5.26">     m_folderQuotaDataIsValid(PR_FALSE),</span>
<a href="#l5.27"></a><span id="l5.27">     m_updatingFolder(PR_FALSE),</span>
<a href="#l5.28"></a><span id="l5.28">     m_downloadingFolderForOfflineUse(PR_FALSE),</span>
<a href="#l5.29"></a><span id="l5.29">     m_folderQuotaUsedKB(0),</span>
<a href="#l5.30"></a><span id="l5.30">     m_folderQuotaMaxKB(0),</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineminus">-    m_applyIncomingFilters(PR_FALSE)</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineplus">+    m_applyIncomingFilters(PR_FALSE),</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineplus">+    m_filterListRequiresBody(PR_FALSE)</span>
<a href="#l5.34"></a><span id="l5.34"> {</span>
<a href="#l5.35"></a><span id="l5.35">   MOZ_COUNT_CTOR(nsImapMailFolder); // double count these for now.</span>
<a href="#l5.36"></a><span id="l5.36"> </span>
<a href="#l5.37"></a><span id="l5.37">   if (mImapHdrDownloadedAtom == nsnull)</span>
<a href="#l5.38"></a><span id="l5.38">     mImapHdrDownloadedAtom = NS_NewAtom(&quot;ImapHdrDownloaded&quot;);</span>
<a href="#l5.39"></a><span id="l5.39">   m_appendMsgMonitor = nsnull;  // since we're not using this (yet?) make it null.</span>
<a href="#l5.40"></a><span id="l5.40">   // if we do start using it, it should be created lazily</span>
<a href="#l5.41"></a><span id="l5.41"> </span>
<a href="#l5.42"></a><span id="l5.42" class="difflineat">@@ -721,16 +724,78 @@ NS_IMETHODIMP nsImapMailFolder::UpdateFo</span>
<a href="#l5.43"></a><span id="l5.43">     // the mdn filter is for filing return receipts into the sent folder</span>
<a href="#l5.44"></a><span id="l5.44">     // some servers (like AOL mail servers)</span>
<a href="#l5.45"></a><span id="l5.45">     // can't file to the sent folder, so we don't add the filter for those servers</span>
<a href="#l5.46"></a><span id="l5.46">     if (canFileMessagesOnServer)</span>
<a href="#l5.47"></a><span id="l5.47">     {</span>
<a href="#l5.48"></a><span id="l5.48">       rv = server-&gt;ConfigureTemporaryFilters(m_filterList);</span>
<a href="#l5.49"></a><span id="l5.49">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.50"></a><span id="l5.50">     }</span>
<a href="#l5.51"></a><span id="l5.51" class="difflineplus">+</span>
<a href="#l5.52"></a><span id="l5.52" class="difflineplus">+    // If a body filter is enabled for an offline folder, delay the filter</span>
<a href="#l5.53"></a><span id="l5.53" class="difflineplus">+    // application until after message has been downloaded.</span>
<a href="#l5.54"></a><span id="l5.54" class="difflineplus">+    m_filterListRequiresBody = PR_FALSE;</span>
<a href="#l5.55"></a><span id="l5.55" class="difflineplus">+</span>
<a href="#l5.56"></a><span id="l5.56" class="difflineplus">+    if (mFlags &amp; nsMsgFolderFlags::Offline)</span>
<a href="#l5.57"></a><span id="l5.57" class="difflineplus">+    {</span>
<a href="#l5.58"></a><span id="l5.58" class="difflineplus">+      nsCOMPtr&lt;nsIMsgFilterService&gt; filterService =</span>
<a href="#l5.59"></a><span id="l5.59" class="difflineplus">+        do_GetService(NS_MSGFILTERSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l5.60"></a><span id="l5.60" class="difflineplus">+      PRUint32 filterCount = 0;</span>
<a href="#l5.61"></a><span id="l5.61" class="difflineplus">+      m_filterList-&gt;GetFilterCount(&amp;filterCount);</span>
<a href="#l5.62"></a><span id="l5.62" class="difflineplus">+      for (PRUint32 index = 0;</span>
<a href="#l5.63"></a><span id="l5.63" class="difflineplus">+           index &lt; filterCount &amp;&amp; !m_filterListRequiresBody;</span>
<a href="#l5.64"></a><span id="l5.64" class="difflineplus">+           ++index)</span>
<a href="#l5.65"></a><span id="l5.65" class="difflineplus">+      {</span>
<a href="#l5.66"></a><span id="l5.66" class="difflineplus">+        nsCOMPtr&lt;nsIMsgFilter&gt; filter;</span>
<a href="#l5.67"></a><span id="l5.67" class="difflineplus">+        m_filterList-&gt;GetFilterAt(index, getter_AddRefs(filter));</span>
<a href="#l5.68"></a><span id="l5.68" class="difflineplus">+        if (!filter)</span>
<a href="#l5.69"></a><span id="l5.69" class="difflineplus">+          continue;</span>
<a href="#l5.70"></a><span id="l5.70" class="difflineplus">+        nsMsgFilterTypeType filterType;</span>
<a href="#l5.71"></a><span id="l5.71" class="difflineplus">+        filter-&gt;GetFilterType(&amp;filterType);</span>
<a href="#l5.72"></a><span id="l5.72" class="difflineplus">+        if (!(filterType &amp; nsMsgFilterType::Incoming))</span>
<a href="#l5.73"></a><span id="l5.73" class="difflineplus">+          continue;</span>
<a href="#l5.74"></a><span id="l5.74" class="difflineplus">+        PRBool enabled = PR_FALSE;</span>
<a href="#l5.75"></a><span id="l5.75" class="difflineplus">+        filter-&gt;GetEnabled(&amp;enabled);</span>
<a href="#l5.76"></a><span id="l5.76" class="difflineplus">+        if (!enabled)</span>
<a href="#l5.77"></a><span id="l5.77" class="difflineplus">+          continue;</span>
<a href="#l5.78"></a><span id="l5.78" class="difflineplus">+        nsCOMPtr&lt;nsISupportsArray&gt; searchTerms;</span>
<a href="#l5.79"></a><span id="l5.79" class="difflineplus">+        PRUint32 numSearchTerms = 0;</span>
<a href="#l5.80"></a><span id="l5.80" class="difflineplus">+        filter-&gt;GetSearchTerms(getter_AddRefs(searchTerms));</span>
<a href="#l5.81"></a><span id="l5.81" class="difflineplus">+        if (searchTerms)</span>
<a href="#l5.82"></a><span id="l5.82" class="difflineplus">+          searchTerms-&gt;Count(&amp;numSearchTerms);</span>
<a href="#l5.83"></a><span id="l5.83" class="difflineplus">+        for (PRUint32 termIndex = 0;</span>
<a href="#l5.84"></a><span id="l5.84" class="difflineplus">+             termIndex &lt; numSearchTerms &amp;&amp; !m_filterListRequiresBody;</span>
<a href="#l5.85"></a><span id="l5.85" class="difflineplus">+             termIndex++)</span>
<a href="#l5.86"></a><span id="l5.86" class="difflineplus">+        {</span>
<a href="#l5.87"></a><span id="l5.87" class="difflineplus">+          nsCOMPtr&lt;nsIMsgSearchTerm&gt; term;</span>
<a href="#l5.88"></a><span id="l5.88" class="difflineplus">+          rv = searchTerms-&gt;QueryElementAt(termIndex,</span>
<a href="#l5.89"></a><span id="l5.89" class="difflineplus">+                                           NS_GET_IID(nsIMsgSearchTerm),</span>
<a href="#l5.90"></a><span id="l5.90" class="difflineplus">+                                           getter_AddRefs(term));</span>
<a href="#l5.91"></a><span id="l5.91" class="difflineplus">+          nsMsgSearchAttribValue attrib;</span>
<a href="#l5.92"></a><span id="l5.92" class="difflineplus">+          rv = term-&gt;GetAttrib(&amp;attrib);</span>
<a href="#l5.93"></a><span id="l5.93" class="difflineplus">+          NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.94"></a><span id="l5.94" class="difflineplus">+          if (attrib == nsMsgSearchAttrib::Body)</span>
<a href="#l5.95"></a><span id="l5.95" class="difflineplus">+            m_filterListRequiresBody = PR_TRUE;</span>
<a href="#l5.96"></a><span id="l5.96" class="difflineplus">+          else if (attrib == nsMsgSearchAttrib::Custom)</span>
<a href="#l5.97"></a><span id="l5.97" class="difflineplus">+          {</span>
<a href="#l5.98"></a><span id="l5.98" class="difflineplus">+            nsCAutoString customId;</span>
<a href="#l5.99"></a><span id="l5.99" class="difflineplus">+            rv = term-&gt;GetCustomId(customId);</span>
<a href="#l5.100"></a><span id="l5.100" class="difflineplus">+            nsCOMPtr&lt;nsIMsgSearchCustomTerm&gt; customTerm;</span>
<a href="#l5.101"></a><span id="l5.101" class="difflineplus">+            if (NS_SUCCEEDED(rv) &amp;&amp; filterService)</span>
<a href="#l5.102"></a><span id="l5.102" class="difflineplus">+              rv = filterService-&gt;GetCustomTerm(customId,</span>
<a href="#l5.103"></a><span id="l5.103" class="difflineplus">+                                                getter_AddRefs(customTerm));</span>
<a href="#l5.104"></a><span id="l5.104" class="difflineplus">+            PRBool needsBody = PR_FALSE;</span>
<a href="#l5.105"></a><span id="l5.105" class="difflineplus">+            if (NS_SUCCEEDED(rv))</span>
<a href="#l5.106"></a><span id="l5.106" class="difflineplus">+              rv = customTerm-&gt;GetNeedsBody(&amp;needsBody);</span>
<a href="#l5.107"></a><span id="l5.107" class="difflineplus">+            if (NS_SUCCEEDED(rv) &amp;&amp; needsBody)</span>
<a href="#l5.108"></a><span id="l5.108" class="difflineplus">+              m_filterListRequiresBody = PR_TRUE;</span>
<a href="#l5.109"></a><span id="l5.109" class="difflineplus">+          }</span>
<a href="#l5.110"></a><span id="l5.110" class="difflineplus">+        }</span>
<a href="#l5.111"></a><span id="l5.111" class="difflineplus">+      }</span>
<a href="#l5.112"></a><span id="l5.112" class="difflineplus">+    }</span>
<a href="#l5.113"></a><span id="l5.113">   }</span>
<a href="#l5.114"></a><span id="l5.114"> </span>
<a href="#l5.115"></a><span id="l5.115">   selectFolder = PR_TRUE;</span>
<a href="#l5.116"></a><span id="l5.116"> </span>
<a href="#l5.117"></a><span id="l5.117">   PRBool isServer;</span>
<a href="#l5.118"></a><span id="l5.118">   rv = GetIsServer(&amp;isServer);</span>
<a href="#l5.119"></a><span id="l5.119">   if (NS_SUCCEEDED(rv) &amp;&amp; isServer)</span>
<a href="#l5.120"></a><span id="l5.120">   {</span>
<a href="#l5.121"></a><span id="l5.121" class="difflineat">@@ -3046,23 +3111,25 @@ nsresult nsImapMailFolder::NormalEndHead</span>
<a href="#l5.122"></a><span id="l5.122">           }</span>
<a href="#l5.123"></a><span id="l5.123">           PRInt32 numNewMessages;</span>
<a href="#l5.124"></a><span id="l5.124">           GetNumNewMessages(PR_FALSE, &amp;numNewMessages);</span>
<a href="#l5.125"></a><span id="l5.125">           SetNumNewMessages(numNewMessages - 1);</span>
<a href="#l5.126"></a><span id="l5.126">         }</span>
<a href="#l5.127"></a><span id="l5.127">       }</span>
<a href="#l5.128"></a><span id="l5.128">       rv = m_msgParser-&gt;GetAllHeaders(&amp;headers, &amp;headersSize);</span>
<a href="#l5.129"></a><span id="l5.129"> </span>
<a href="#l5.130"></a><span id="l5.130" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp; headers &amp;&amp; !m_msgMovedByFilter)</span>
<a href="#l5.131"></a><span id="l5.131" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; headers &amp;&amp; !m_msgMovedByFilter &amp;&amp;</span>
<a href="#l5.132"></a><span id="l5.132" class="difflineplus">+          !m_filterListRequiresBody)</span>
<a href="#l5.133"></a><span id="l5.133">       {</span>
<a href="#l5.134"></a><span id="l5.134">         if (m_filterList)</span>
<a href="#l5.135"></a><span id="l5.135">         {</span>
<a href="#l5.136"></a><span id="l5.136">           GetMoveCoalescer();  // not sure why we're doing this here.</span>
<a href="#l5.137"></a><span id="l5.137">           m_filterList-&gt;ApplyFiltersToHdr(nsMsgFilterType::InboxRule, newMsgHdr, this, mDatabase,</span>
<a href="#l5.138"></a><span id="l5.138">                                           headers, headersSize, this, msgWindow, nsnull);</span>
<a href="#l5.139"></a><span id="l5.139" class="difflineplus">+          NotifyFolderEvent(mFiltersAppliedAtom);</span>
<a href="#l5.140"></a><span id="l5.140">         }</span>
<a href="#l5.141"></a><span id="l5.141">       }</span>
<a href="#l5.142"></a><span id="l5.142">     }</span>
<a href="#l5.143"></a><span id="l5.143">   }</span>
<a href="#l5.144"></a><span id="l5.144">   // here we need to tweak flags from uid state..</span>
<a href="#l5.145"></a><span id="l5.145">   if (mDatabase &amp;&amp; (!m_msgMovedByFilter || ShowDeletedMessages()))</span>
<a href="#l5.146"></a><span id="l5.146">   {</span>
<a href="#l5.147"></a><span id="l5.147">     mDatabase-&gt;AddNewHdrToDB(newMsgHdr, PR_TRUE);</span>
<a href="#l5.148"></a><span id="l5.148" class="difflineat">@@ -3259,30 +3326,46 @@ NS_IMETHODIMP nsImapMailFolder::StartMes</span>
<a href="#l5.149"></a><span id="l5.149"> // just finished the current message.</span>
<a href="#l5.150"></a><span id="l5.150"> NS_IMETHODIMP nsImapMailFolder::EndMessage(nsMsgKey key)</span>
<a href="#l5.151"></a><span id="l5.151"> {</span>
<a href="#l5.152"></a><span id="l5.152">   return NS_OK;</span>
<a href="#l5.153"></a><span id="l5.153"> }</span>
<a href="#l5.154"></a><span id="l5.154"> </span>
<a href="#l5.155"></a><span id="l5.155"> NS_IMETHODIMP nsImapMailFolder::ApplyFilterHit(nsIMsgFilter *filter, nsIMsgWindow *msgWindow, PRBool *applyMore)</span>
<a href="#l5.156"></a><span id="l5.156"> {</span>
<a href="#l5.157"></a><span id="l5.157" class="difflineplus">+  //</span>
<a href="#l5.158"></a><span id="l5.158" class="difflineplus">+  //  This routine is called indirectly from ApplyFiltersToHdr in two</span>
<a href="#l5.159"></a><span id="l5.159" class="difflineplus">+  //  circumstances, controlled by m_filterListRequiresBody:</span>
<a href="#l5.160"></a><span id="l5.160" class="difflineplus">+  //</span>
<a href="#l5.161"></a><span id="l5.161" class="difflineplus">+  //  If false, after headers are parsed in NormalEndHeaderParseStream.</span>
<a href="#l5.162"></a><span id="l5.162" class="difflineplus">+  //  If true, after the message body is downloaded in NormalEndMsgWriteStream.</span>
<a href="#l5.163"></a><span id="l5.163" class="difflineplus">+  //</span>
<a href="#l5.164"></a><span id="l5.164" class="difflineplus">+  //  In NormalEndHeaderParseStream, the message has not been added to the</span>
<a href="#l5.165"></a><span id="l5.165" class="difflineplus">+  //  database, and it is important that database notifications and count </span>
<a href="#l5.166"></a><span id="l5.166" class="difflineplus">+  //  updates do not occur. In NormalEndMsgWriteStream, the message has been</span>
<a href="#l5.167"></a><span id="l5.167" class="difflineplus">+  //  added to the database, and database notifications and count updates</span>
<a href="#l5.168"></a><span id="l5.168" class="difflineplus">+  //  should be performed.</span>
<a href="#l5.169"></a><span id="l5.169" class="difflineplus">+  //</span>
<a href="#l5.170"></a><span id="l5.170" class="difflineplus">+</span>
<a href="#l5.171"></a><span id="l5.171">   NS_ENSURE_ARG_POINTER(applyMore);</span>
<a href="#l5.172"></a><span id="l5.172"> </span>
<a href="#l5.173"></a><span id="l5.173">   nsMsgRuleActionType actionType;</span>
<a href="#l5.174"></a><span id="l5.174">   nsCString actionTargetFolderUri;</span>
<a href="#l5.175"></a><span id="l5.175">   PRUint32  newFlags;</span>
<a href="#l5.176"></a><span id="l5.176">   nsresult rv = NS_OK;</span>
<a href="#l5.177"></a><span id="l5.177"> </span>
<a href="#l5.178"></a><span id="l5.178">   // look at action - currently handle move</span>
<a href="#l5.179"></a><span id="l5.179"> #ifdef DEBUG_bienvenu</span>
<a href="#l5.180"></a><span id="l5.180">   printf(&quot;got a rule hit!\n&quot;);</span>
<a href="#l5.181"></a><span id="l5.181"> #endif</span>
<a href="#l5.182"></a><span id="l5.182"> </span>
<a href="#l5.183"></a><span id="l5.183">   nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l5.184"></a><span id="l5.184" class="difflineminus">-  if (m_msgParser)</span>
<a href="#l5.185"></a><span id="l5.185" class="difflineplus">+  if (m_filterListRequiresBody)</span>
<a href="#l5.186"></a><span id="l5.186" class="difflineplus">+    GetMessageHeader(m_curMsgUid, getter_AddRefs(msgHdr));</span>
<a href="#l5.187"></a><span id="l5.187" class="difflineplus">+  else if (m_msgParser)</span>
<a href="#l5.188"></a><span id="l5.188">     m_msgParser-&gt;GetNewMsgHdr(getter_AddRefs(msgHdr));</span>
<a href="#l5.189"></a><span id="l5.189">   if (!msgHdr)</span>
<a href="#l5.190"></a><span id="l5.190">     return NS_ERROR_NULL_POINTER; //fatal error, cannot apply filters</span>
<a href="#l5.191"></a><span id="l5.191"> </span>
<a href="#l5.192"></a><span id="l5.192">   PRBool deleteToTrash = DeleteIsMoveToTrash();</span>
<a href="#l5.193"></a><span id="l5.193">   nsCOMPtr&lt;nsISupportsArray&gt; filterActionList = do_CreateInstance(NS_SUPPORTSARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l5.194"></a><span id="l5.194">   NS_ENSURE_TRUE(filterActionList, rv);</span>
<a href="#l5.195"></a><span id="l5.195">   rv = filter-&gt;GetSortedActionList(filterActionList);</span>
<a href="#l5.196"></a><span id="l5.196" class="difflineat">@@ -3334,17 +3417,18 @@ NS_IMETHODIMP nsImapMailFolder::ApplyFil</span>
<a href="#l5.197"></a><span id="l5.197">             nsCOMPtr &lt;nsIMsgFolder&gt; mailTrash;</span>
<a href="#l5.198"></a><span id="l5.198">             rv = GetTrashFolder(getter_AddRefs(mailTrash));</span>
<a href="#l5.199"></a><span id="l5.199">             if (NS_SUCCEEDED(rv) &amp;&amp; mailTrash)</span>
<a href="#l5.200"></a><span id="l5.200">               rv = mailTrash-&gt;GetURI(actionTargetFolderUri);</span>
<a href="#l5.201"></a><span id="l5.201">             // msgHdr-&gt;OrFlags(nsMsgMessageFlags::Read, &amp;newFlags);  // mark read in trash.</span>
<a href="#l5.202"></a><span id="l5.202">           }</span>
<a href="#l5.203"></a><span id="l5.203">           else  // (!deleteToTrash)</span>
<a href="#l5.204"></a><span id="l5.204">           {</span>
<a href="#l5.205"></a><span id="l5.205" class="difflineminus">-            msgHdr-&gt;OrFlags(nsMsgMessageFlags::Read | nsMsgMessageFlags::IMAPDeleted, &amp;newFlags);</span>
<a href="#l5.206"></a><span id="l5.206" class="difflineplus">+            mDatabase-&gt;MarkHdrRead(msgHdr, PR_TRUE, nsnull);</span>
<a href="#l5.207"></a><span id="l5.207" class="difflineplus">+            mDatabase-&gt;MarkImapDeleted(msgKey, PR_TRUE, nsnull);</span>
<a href="#l5.208"></a><span id="l5.208">             StoreImapFlags(kImapMsgSeenFlag | kImapMsgDeletedFlag, PR_TRUE,</span>
<a href="#l5.209"></a><span id="l5.209">                            &amp;msgKey, 1, nsnull);</span>
<a href="#l5.210"></a><span id="l5.210">             m_msgMovedByFilter = PR_TRUE; // this will prevent us from adding the header to the db.</span>
<a href="#l5.211"></a><span id="l5.211">           }</span>
<a href="#l5.212"></a><span id="l5.212">           msgIsNew = PR_FALSE;</span>
<a href="#l5.213"></a><span id="l5.213">         }</span>
<a href="#l5.214"></a><span id="l5.214">         // note that delete falls through to move.</span>
<a href="#l5.215"></a><span id="l5.215">         case nsMsgFilterAction::MoveToFolder:</span>
<a href="#l5.216"></a><span id="l5.216" class="difflineat">@@ -3354,18 +3438,18 @@ NS_IMETHODIMP nsImapMailFolder::ApplyFil</span>
<a href="#l5.217"></a><span id="l5.217">           rv = GetURI(uri);</span>
<a href="#l5.218"></a><span id="l5.218"> </span>
<a href="#l5.219"></a><span id="l5.219">           if (!actionTargetFolderUri.Equals(uri))</span>
<a href="#l5.220"></a><span id="l5.220">           {</span>
<a href="#l5.221"></a><span id="l5.221">             msgHdr-&gt;GetFlags(&amp;msgFlags);</span>
<a href="#l5.222"></a><span id="l5.222"> </span>
<a href="#l5.223"></a><span id="l5.223">             if (msgFlags &amp; nsMsgMessageFlags::MDNReportNeeded &amp;&amp; !isRead)</span>
<a href="#l5.224"></a><span id="l5.224">             {</span>
<a href="#l5.225"></a><span id="l5.225" class="difflineminus">-               msgHdr-&gt;SetFlags(msgFlags &amp; ~nsMsgMessageFlags::MDNReportNeeded);</span>
<a href="#l5.226"></a><span id="l5.226" class="difflineminus">-               msgHdr-&gt;OrFlags(nsMsgMessageFlags::MDNReportSent, &amp;newFlags);</span>
<a href="#l5.227"></a><span id="l5.227" class="difflineplus">+               mDatabase-&gt;MarkMDNNeeded(msgKey, PR_FALSE, nsnull);</span>
<a href="#l5.228"></a><span id="l5.228" class="difflineplus">+               mDatabase-&gt;MarkMDNSent(msgKey, PR_TRUE, nsnull);</span>
<a href="#l5.229"></a><span id="l5.229">             }</span>
<a href="#l5.230"></a><span id="l5.230">             nsresult err = MoveIncorporatedMessage(msgHdr, mDatabase, actionTargetFolderUri, filter, msgWindow);</span>
<a href="#l5.231"></a><span id="l5.231">             if (NS_SUCCEEDED(err))</span>
<a href="#l5.232"></a><span id="l5.232">               m_msgMovedByFilter = PR_TRUE;</span>
<a href="#l5.233"></a><span id="l5.233">           }</span>
<a href="#l5.234"></a><span id="l5.234">           // don't apply any more filters, even if it was a move to the same folder</span>
<a href="#l5.235"></a><span id="l5.235">           *applyMore = PR_FALSE; </span>
<a href="#l5.236"></a><span id="l5.236">         }</span>
<a href="#l5.237"></a><span id="l5.237" class="difflineat">@@ -3378,18 +3462,18 @@ NS_IMETHODIMP nsImapMailFolder::ApplyFil</span>
<a href="#l5.238"></a><span id="l5.238">           if (!actionTargetFolderUri.Equals(uri))</span>
<a href="#l5.239"></a><span id="l5.239">           {</span>
<a href="#l5.240"></a><span id="l5.240">             // XXXshaver I'm not actually 100% what the right semantics are for</span>
<a href="#l5.241"></a><span id="l5.241">             // MDNs and copied messages, but I suspect deep down inside that</span>
<a href="#l5.242"></a><span id="l5.242">             // we probably want to suppress them only on the copies.</span>
<a href="#l5.243"></a><span id="l5.243">             msgHdr-&gt;GetFlags(&amp;msgFlags);</span>
<a href="#l5.244"></a><span id="l5.244">             if (msgFlags &amp; nsMsgMessageFlags::MDNReportNeeded &amp;&amp; !isRead)</span>
<a href="#l5.245"></a><span id="l5.245">             {</span>
<a href="#l5.246"></a><span id="l5.246" class="difflineminus">-               msgHdr-&gt;SetFlags(msgFlags &amp; ~nsMsgMessageFlags::MDNReportNeeded);</span>
<a href="#l5.247"></a><span id="l5.247" class="difflineminus">-               msgHdr-&gt;OrFlags(nsMsgMessageFlags::MDNReportSent, &amp;newFlags);</span>
<a href="#l5.248"></a><span id="l5.248" class="difflineplus">+               mDatabase-&gt;MarkMDNNeeded(msgKey, PR_FALSE, nsnull);</span>
<a href="#l5.249"></a><span id="l5.249" class="difflineplus">+               mDatabase-&gt;MarkMDNSent(msgKey, PR_TRUE, nsnull);</span>
<a href="#l5.250"></a><span id="l5.250">             }</span>
<a href="#l5.251"></a><span id="l5.251"> </span>
<a href="#l5.252"></a><span id="l5.252">             nsCOMPtr&lt;nsIMutableArray&gt; messageArray(do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l5.253"></a><span id="l5.253">             NS_ENSURE_TRUE(messageArray, rv);</span>
<a href="#l5.254"></a><span id="l5.254">             messageArray-&gt;AppendElement(msgHdr, PR_FALSE);</span>
<a href="#l5.255"></a><span id="l5.255"> </span>
<a href="#l5.256"></a><span id="l5.256">             nsCOMPtr&lt;nsIMsgFolder&gt; dstFolder;</span>
<a href="#l5.257"></a><span id="l5.257">             rv = GetExistingFolder(actionTargetFolderUri, getter_AddRefs(dstFolder));</span>
<a href="#l5.258"></a><span id="l5.258" class="difflineat">@@ -3413,36 +3497,66 @@ NS_IMETHODIMP nsImapMailFolder::ApplyFil</span>
<a href="#l5.259"></a><span id="l5.259">         break;</span>
<a href="#l5.260"></a><span id="l5.260">         case nsMsgFilterAction::MarkFlagged:</span>
<a href="#l5.261"></a><span id="l5.261">         {</span>
<a href="#l5.262"></a><span id="l5.262">           mDatabase-&gt;MarkHdrMarked(msgHdr, PR_TRUE, nsnull);</span>
<a href="#l5.263"></a><span id="l5.263">           StoreImapFlags(kImapMsgFlaggedFlag, PR_TRUE, &amp;msgKey, 1, nsnull);</span>
<a href="#l5.264"></a><span id="l5.264">         }</span>
<a href="#l5.265"></a><span id="l5.265">         break;</span>
<a href="#l5.266"></a><span id="l5.266">         case nsMsgFilterAction::KillThread:</span>
<a href="#l5.267"></a><span id="l5.267" class="difflineminus">-          msgHdr-&gt;SetUint32Property(&quot;ProtoThreadFlags&quot;, nsMsgMessageFlags::Ignored);</span>
<a href="#l5.268"></a><span id="l5.268" class="difflineminus">-          break;</span>
<a href="#l5.269"></a><span id="l5.269" class="difflineplus">+        case nsMsgFilterAction::WatchThread:</span>
<a href="#l5.270"></a><span id="l5.270" class="difflineplus">+        {</span>
<a href="#l5.271"></a><span id="l5.271" class="difflineplus">+          nsCOMPtr &lt;nsIMsgThread&gt; msgThread;</span>
<a href="#l5.272"></a><span id="l5.272" class="difflineplus">+          nsMsgKey threadKey;</span>
<a href="#l5.273"></a><span id="l5.273" class="difflineplus">+          mDatabase-&gt;GetThreadContainingMsgHdr(msgHdr, getter_AddRefs(msgThread));</span>
<a href="#l5.274"></a><span id="l5.274" class="difflineplus">+          if (msgThread)</span>
<a href="#l5.275"></a><span id="l5.275" class="difflineplus">+          {</span>
<a href="#l5.276"></a><span id="l5.276" class="difflineplus">+            msgThread-&gt;GetThreadKey(&amp;threadKey);</span>
<a href="#l5.277"></a><span id="l5.277" class="difflineplus">+            if (actionType == nsMsgFilterAction::KillThread)</span>
<a href="#l5.278"></a><span id="l5.278" class="difflineplus">+              mDatabase-&gt;MarkThreadIgnored(msgThread, threadKey, PR_TRUE, nsnull);</span>
<a href="#l5.279"></a><span id="l5.279" class="difflineplus">+            else</span>
<a href="#l5.280"></a><span id="l5.280" class="difflineplus">+              mDatabase-&gt;MarkThreadWatched(msgThread, threadKey, PR_TRUE, nsnull);</span>
<a href="#l5.281"></a><span id="l5.281" class="difflineplus">+          }</span>
<a href="#l5.282"></a><span id="l5.282" class="difflineplus">+          else</span>
<a href="#l5.283"></a><span id="l5.283" class="difflineplus">+          {</span>
<a href="#l5.284"></a><span id="l5.284" class="difflineplus">+            if (actionType == nsMsgFilterAction::KillThread)</span>
<a href="#l5.285"></a><span id="l5.285" class="difflineplus">+              msgHdr-&gt;SetUint32Property(&quot;ProtoThreadFlags&quot;, nsMsgMessageFlags::Ignored);</span>
<a href="#l5.286"></a><span id="l5.286" class="difflineplus">+            else</span>
<a href="#l5.287"></a><span id="l5.287" class="difflineplus">+              msgHdr-&gt;SetUint32Property(&quot;ProtoThreadFlags&quot;, nsMsgMessageFlags::Watched);</span>
<a href="#l5.288"></a><span id="l5.288" class="difflineplus">+          }</span>
<a href="#l5.289"></a><span id="l5.289" class="difflineplus">+          if (actionType == nsMsgFilterAction::KillThread)</span>
<a href="#l5.290"></a><span id="l5.290" class="difflineplus">+          {</span>
<a href="#l5.291"></a><span id="l5.291" class="difflineplus">+            mDatabase-&gt;MarkHdrRead(msgHdr, PR_TRUE, nsnull);</span>
<a href="#l5.292"></a><span id="l5.292" class="difflineplus">+            StoreImapFlags(kImapMsgSeenFlag, PR_TRUE, &amp;msgKey, 1, nsnull);</span>
<a href="#l5.293"></a><span id="l5.293" class="difflineplus">+            msgIsNew = PR_FALSE;</span>
<a href="#l5.294"></a><span id="l5.294" class="difflineplus">+          }</span>
<a href="#l5.295"></a><span id="l5.295" class="difflineplus">+        }</span>
<a href="#l5.296"></a><span id="l5.296" class="difflineplus">+        break;</span>
<a href="#l5.297"></a><span id="l5.297">         case nsMsgFilterAction::KillSubthread:</span>
<a href="#l5.298"></a><span id="l5.298" class="difflineminus">-          msgHdr-&gt;OrFlags(nsMsgMessageFlags::Ignored, &amp;newFlags);</span>
<a href="#l5.299"></a><span id="l5.299" class="difflineminus">-          break;</span>
<a href="#l5.300"></a><span id="l5.300" class="difflineminus">-        case nsMsgFilterAction::WatchThread:</span>
<a href="#l5.301"></a><span id="l5.301" class="difflineminus">-          msgHdr-&gt;OrFlags(nsMsgMessageFlags::Watched, &amp;newFlags);</span>
<a href="#l5.302"></a><span id="l5.302" class="difflineplus">+        {</span>
<a href="#l5.303"></a><span id="l5.303" class="difflineplus">+          mDatabase-&gt;MarkHeaderKilled(msgHdr, PR_TRUE, nsnull);</span>
<a href="#l5.304"></a><span id="l5.304" class="difflineplus">+          mDatabase-&gt;MarkHdrRead(msgHdr, PR_TRUE, nsnull);</span>
<a href="#l5.305"></a><span id="l5.305" class="difflineplus">+          StoreImapFlags(kImapMsgSeenFlag, PR_TRUE, &amp;msgKey, 1, nsnull);</span>
<a href="#l5.306"></a><span id="l5.306" class="difflineplus">+          msgIsNew = PR_FALSE;</span>
<a href="#l5.307"></a><span id="l5.307" class="difflineplus">+        }</span>
<a href="#l5.308"></a><span id="l5.308">         break;</span>
<a href="#l5.309"></a><span id="l5.309">         case nsMsgFilterAction::ChangePriority:</span>
<a href="#l5.310"></a><span id="l5.310">         {</span>
<a href="#l5.311"></a><span id="l5.311" class="difflineminus">-          nsMsgPriorityValue filterPriority;</span>
<a href="#l5.312"></a><span id="l5.312" class="difflineplus">+          nsMsgPriorityValue filterPriority; // a PRInt32</span>
<a href="#l5.313"></a><span id="l5.313">           filterAction-&gt;GetPriority(&amp;filterPriority);</span>
<a href="#l5.314"></a><span id="l5.314" class="difflineminus">-          msgHdr-&gt;SetPriority(filterPriority);</span>
<a href="#l5.315"></a><span id="l5.315" class="difflineplus">+          mDatabase-&gt;SetUint32PropertyByHdr(msgHdr, &quot;priority&quot;,</span>
<a href="#l5.316"></a><span id="l5.316" class="difflineplus">+                                            static_cast&lt;PRUint32&gt;(filterPriority));</span>
<a href="#l5.317"></a><span id="l5.317">         }</span>
<a href="#l5.318"></a><span id="l5.318">         break;</span>
<a href="#l5.319"></a><span id="l5.319">         case nsMsgFilterAction::Label:</span>
<a href="#l5.320"></a><span id="l5.320">         {</span>
<a href="#l5.321"></a><span id="l5.321">           nsMsgLabelValue filterLabel;</span>
<a href="#l5.322"></a><span id="l5.322">           filterAction-&gt;GetLabel(&amp;filterLabel);</span>
<a href="#l5.323"></a><span id="l5.323" class="difflineminus">-          msgHdr-&gt;SetLabel(filterLabel);</span>
<a href="#l5.324"></a><span id="l5.324" class="difflineplus">+          mDatabase-&gt;SetUint32PropertyByHdr(msgHdr, &quot;label&quot;,</span>
<a href="#l5.325"></a><span id="l5.325" class="difflineplus">+                                            static_cast&lt;PRUint32&gt;(filterLabel));</span>
<a href="#l5.326"></a><span id="l5.326">           StoreImapFlags((filterLabel &lt;&lt; 9), PR_TRUE, &amp;msgKey, 1, nsnull);</span>
<a href="#l5.327"></a><span id="l5.327">         }</span>
<a href="#l5.328"></a><span id="l5.328">         break;</span>
<a href="#l5.329"></a><span id="l5.329">         case nsMsgFilterAction::AddTag:</span>
<a href="#l5.330"></a><span id="l5.330">         {</span>
<a href="#l5.331"></a><span id="l5.331">           nsCString keyword;</span>
<a href="#l5.332"></a><span id="l5.332">           filterAction-&gt;GetStrValue(keyword);</span>
<a href="#l5.333"></a><span id="l5.333">           nsCOMPtr&lt;nsIMutableArray&gt; messageArray(do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l5.334"></a><span id="l5.334" class="difflineat">@@ -3464,18 +3578,38 @@ NS_IMETHODIMP nsImapMailFolder::ApplyFil</span>
<a href="#l5.335"></a><span id="l5.335">           if (junkScore == nsIJunkMailPlugin::IS_SPAM_SCORE ||</span>
<a href="#l5.336"></a><span id="l5.336">               junkScore == nsIJunkMailPlugin::IS_HAM_SCORE)</span>
<a href="#l5.337"></a><span id="l5.337">           {</span>
<a href="#l5.338"></a><span id="l5.338">             nsTArray&lt;nsMsgKey&gt; *keysToClassify = m_moveCoalescer-&gt;GetKeyBucket(</span>
<a href="#l5.339"></a><span id="l5.339">                        (junkScore == nsIJunkMailPlugin::IS_SPAM_SCORE) ? 0 : 1);</span>
<a href="#l5.340"></a><span id="l5.340">             NS_ASSERTION(keysToClassify, &quot;error getting key bucket&quot;);</span>
<a href="#l5.341"></a><span id="l5.341">             if (keysToClassify)</span>
<a href="#l5.342"></a><span id="l5.342">               keysToClassify-&gt;AppendElement(msgKey);</span>
<a href="#l5.343"></a><span id="l5.343" class="difflineminus">-            if (junkScore == nsIJunkMailPlugin::IS_SPAM_SCORE)</span>
<a href="#l5.344"></a><span id="l5.344" class="difflineplus">+            if (msgIsNew &amp;&amp; junkScore == nsIJunkMailPlugin::IS_SPAM_SCORE)</span>
<a href="#l5.345"></a><span id="l5.345" class="difflineplus">+            {              </span>
<a href="#l5.346"></a><span id="l5.346">               msgIsNew = PR_FALSE;</span>
<a href="#l5.347"></a><span id="l5.347" class="difflineplus">+              mDatabase-&gt;MarkHdrNotNew(msgHdr, nsnull);</span>
<a href="#l5.348"></a><span id="l5.348" class="difflineplus">+              // nsMsgDBFolder::SendFlagNotifications by the call to</span>
<a href="#l5.349"></a><span id="l5.349" class="difflineplus">+              // SetBiffState(nsMsgBiffState_NoMail) will reset numNewMessages</span>
<a href="#l5.350"></a><span id="l5.350" class="difflineplus">+              // only if the message is also read and database notifications</span>
<a href="#l5.351"></a><span id="l5.351" class="difflineplus">+              // are active, but we are not going to mark it read in this</span>
<a href="#l5.352"></a><span id="l5.352" class="difflineplus">+              // action, preferring to leave the choice to the user.</span>
<a href="#l5.353"></a><span id="l5.353" class="difflineplus">+              // So correct numNewMessages.</span>
<a href="#l5.354"></a><span id="l5.354" class="difflineplus">+              if (m_filterListRequiresBody)</span>
<a href="#l5.355"></a><span id="l5.355" class="difflineplus">+              {</span>
<a href="#l5.356"></a><span id="l5.356" class="difflineplus">+                msgHdr-&gt;GetFlags(&amp;msgFlags);</span>
<a href="#l5.357"></a><span id="l5.357" class="difflineplus">+                if (!(msgFlags &amp; nsMsgMessageFlags::Read))</span>
<a href="#l5.358"></a><span id="l5.358" class="difflineplus">+                {</span>
<a href="#l5.359"></a><span id="l5.359" class="difflineplus">+                  PRInt32 numNewMessages;</span>
<a href="#l5.360"></a><span id="l5.360" class="difflineplus">+                  GetNumNewMessages(PR_FALSE, &amp;numNewMessages);</span>
<a href="#l5.361"></a><span id="l5.361" class="difflineplus">+                  SetNumNewMessages(--numNewMessages);</span>
<a href="#l5.362"></a><span id="l5.362" class="difflineplus">+                  SetHasNewMessages(numNewMessages != 0);</span>
<a href="#l5.363"></a><span id="l5.363" class="difflineplus">+                }</span>
<a href="#l5.364"></a><span id="l5.364" class="difflineplus">+              }</span>
<a href="#l5.365"></a><span id="l5.365" class="difflineplus">+            }</span>
<a href="#l5.366"></a><span id="l5.366">           }</span>
<a href="#l5.367"></a><span id="l5.367">         }</span>
<a href="#l5.368"></a><span id="l5.368">         break;</span>
<a href="#l5.369"></a><span id="l5.369">       case nsMsgFilterAction::Forward:</span>
<a href="#l5.370"></a><span id="l5.370">         {</span>
<a href="#l5.371"></a><span id="l5.371">           nsCString forwardTo;</span>
<a href="#l5.372"></a><span id="l5.372">           filterAction-&gt;GetStrValue(forwardTo);</span>
<a href="#l5.373"></a><span id="l5.373">           nsCOMPtr &lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l5.374"></a><span id="l5.374" class="difflineat">@@ -3524,16 +3658,20 @@ NS_IMETHODIMP nsImapMailFolder::ApplyFil</span>
<a href="#l5.375"></a><span id="l5.375"> </span>
<a href="#l5.376"></a><span id="l5.376">           nsCOMPtr&lt;nsIMutableArray&gt; messageArray(</span>
<a href="#l5.377"></a><span id="l5.377">               do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l5.378"></a><span id="l5.378">           NS_ENSURE_TRUE(messageArray, rv);</span>
<a href="#l5.379"></a><span id="l5.379">           messageArray-&gt;AppendElement(msgHdr, PR_FALSE);</span>
<a href="#l5.380"></a><span id="l5.380"> </span>
<a href="#l5.381"></a><span id="l5.381">           customAction-&gt;Apply(messageArray, value, nsnull,</span>
<a href="#l5.382"></a><span id="l5.382">                               nsMsgFilterType::InboxRule, msgWindow);</span>
<a href="#l5.383"></a><span id="l5.383" class="difflineplus">+          // allow custom action to affect new</span>
<a href="#l5.384"></a><span id="l5.384" class="difflineplus">+          msgHdr-&gt;GetFlags(&amp;msgFlags);</span>
<a href="#l5.385"></a><span id="l5.385" class="difflineplus">+          if (!(msgFlags &amp; nsMsgMessageFlags::New))</span>
<a href="#l5.386"></a><span id="l5.386" class="difflineplus">+            msgIsNew = PR_FALSE;</span>
<a href="#l5.387"></a><span id="l5.387">         }</span>
<a href="#l5.388"></a><span id="l5.388">         break;</span>
<a href="#l5.389"></a><span id="l5.389"> </span>
<a href="#l5.390"></a><span id="l5.390">         default:</span>
<a href="#l5.391"></a><span id="l5.391">           break;</span>
<a href="#l5.392"></a><span id="l5.392">       }</span>
<a href="#l5.393"></a><span id="l5.393">       if (loggingEnabled)</span>
<a href="#l5.394"></a><span id="l5.394">       {</span>
<a href="#l5.395"></a><span id="l5.395" class="difflineat">@@ -3543,17 +3681,23 @@ NS_IMETHODIMP nsImapMailFolder::ApplyFil</span>
<a href="#l5.396"></a><span id="l5.396">           (void) filter-&gt;LogRuleHit(filterAction, msgHdr);</span>
<a href="#l5.397"></a><span id="l5.397">       }</span>
<a href="#l5.398"></a><span id="l5.398">     }</span>
<a href="#l5.399"></a><span id="l5.399">   }</span>
<a href="#l5.400"></a><span id="l5.400">   if (!msgIsNew)</span>
<a href="#l5.401"></a><span id="l5.401">   {</span>
<a href="#l5.402"></a><span id="l5.402">     PRInt32 numNewMessages;</span>
<a href="#l5.403"></a><span id="l5.403">     GetNumNewMessages(PR_FALSE, &amp;numNewMessages);</span>
<a href="#l5.404"></a><span id="l5.404" class="difflineminus">-    SetNumNewMessages(numNewMessages - 1);</span>
<a href="#l5.405"></a><span id="l5.405" class="difflineplus">+    // When database notifications are active, new counts will be reset</span>
<a href="#l5.406"></a><span id="l5.406" class="difflineplus">+    // to zero in nsMsgDBFolder::SendFlagNotifications by the call to</span>
<a href="#l5.407"></a><span id="l5.407" class="difflineplus">+    // SetBiffState(nsMsgBiffState_NoMail), so don't repeat them here.</span>
<a href="#l5.408"></a><span id="l5.408" class="difflineplus">+    if (!m_filterListRequiresBody)</span>
<a href="#l5.409"></a><span id="l5.409" class="difflineplus">+      SetNumNewMessages(--numNewMessages);</span>
<a href="#l5.410"></a><span id="l5.410" class="difflineplus">+    if (mDatabase)</span>
<a href="#l5.411"></a><span id="l5.411" class="difflineplus">+      mDatabase-&gt;MarkHdrNotNew(msgHdr, nsnull);</span>
<a href="#l5.412"></a><span id="l5.412">   }</span>
<a href="#l5.413"></a><span id="l5.413">   return NS_OK;</span>
<a href="#l5.414"></a><span id="l5.414"> }</span>
<a href="#l5.415"></a><span id="l5.415"> </span>
<a href="#l5.416"></a><span id="l5.416"> NS_IMETHODIMP nsImapMailFolder::SetImapFlags(const char *uids, PRInt32 flags, nsIURI **url)</span>
<a href="#l5.417"></a><span id="l5.417"> {</span>
<a href="#l5.418"></a><span id="l5.418">   nsresult rv;</span>
<a href="#l5.419"></a><span id="l5.419">   nsCOMPtr&lt;nsIImapService&gt; imapService = do_GetService(NS_IMAPSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l5.420"></a><span id="l5.420" class="difflineat">@@ -4292,16 +4436,71 @@ void nsImapMailFolder::EndOfflineDownloa</span>
<a href="#l5.421"></a><span id="l5.421"> NS_IMETHODIMP</span>
<a href="#l5.422"></a><span id="l5.422"> nsImapMailFolder::NormalEndMsgWriteStream(nsMsgKey uidOfMessage,</span>
<a href="#l5.423"></a><span id="l5.423">                                           PRBool markRead,</span>
<a href="#l5.424"></a><span id="l5.424">                                           nsIImapUrl *imapUrl)</span>
<a href="#l5.425"></a><span id="l5.425"> {</span>
<a href="#l5.426"></a><span id="l5.426">   if (m_offlineHeader)</span>
<a href="#l5.427"></a><span id="l5.427">     EndNewOfflineMessage();</span>
<a href="#l5.428"></a><span id="l5.428">   m_curMsgUid = uidOfMessage;</span>
<a href="#l5.429"></a><span id="l5.429" class="difflineplus">+</span>
<a href="#l5.430"></a><span id="l5.430" class="difflineplus">+  // Apply filter now if it needed a body</span>
<a href="#l5.431"></a><span id="l5.431" class="difflineplus">+  if (m_filterListRequiresBody)</span>
<a href="#l5.432"></a><span id="l5.432" class="difflineplus">+  {</span>
<a href="#l5.433"></a><span id="l5.433" class="difflineplus">+    if (m_filterList)</span>
<a href="#l5.434"></a><span id="l5.434" class="difflineplus">+    {</span>
<a href="#l5.435"></a><span id="l5.435" class="difflineplus">+      nsCOMPtr&lt;nsIMsgDBHdr&gt; newMsgHdr;</span>
<a href="#l5.436"></a><span id="l5.436" class="difflineplus">+      GetMessageHeader(uidOfMessage, getter_AddRefs(newMsgHdr));</span>
<a href="#l5.437"></a><span id="l5.437" class="difflineplus">+      GetMoveCoalescer();</span>
<a href="#l5.438"></a><span id="l5.438" class="difflineplus">+      nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow;</span>
<a href="#l5.439"></a><span id="l5.439" class="difflineplus">+      if (imapUrl)</span>
<a href="#l5.440"></a><span id="l5.440" class="difflineplus">+      {</span>
<a href="#l5.441"></a><span id="l5.441" class="difflineplus">+        nsresult rv;</span>
<a href="#l5.442"></a><span id="l5.442" class="difflineplus">+        nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; msgUrl;</span>
<a href="#l5.443"></a><span id="l5.443" class="difflineplus">+        msgUrl = do_QueryInterface(imapUrl, &amp;rv);</span>
<a href="#l5.444"></a><span id="l5.444" class="difflineplus">+        if (msgUrl &amp;&amp; NS_SUCCEEDED(rv))</span>
<a href="#l5.445"></a><span id="l5.445" class="difflineplus">+          msgUrl-&gt;GetMsgWindow(getter_AddRefs(msgWindow));</span>
<a href="#l5.446"></a><span id="l5.446" class="difflineplus">+      }</span>
<a href="#l5.447"></a><span id="l5.447" class="difflineplus">+      m_filterList-&gt;ApplyFiltersToHdr(nsMsgFilterType::InboxRule, newMsgHdr,</span>
<a href="#l5.448"></a><span id="l5.448" class="difflineplus">+                                      this, mDatabase, nsnull, nsnull, this,</span>
<a href="#l5.449"></a><span id="l5.449" class="difflineplus">+                                      msgWindow, nsnull);</span>
<a href="#l5.450"></a><span id="l5.450" class="difflineplus">+      NotifyFolderEvent(mFiltersAppliedAtom);</span>
<a href="#l5.451"></a><span id="l5.451" class="difflineplus">+    }</span>
<a href="#l5.452"></a><span id="l5.452" class="difflineplus">+    // Process filter plugins and other items normally done at the end of</span>
<a href="#l5.453"></a><span id="l5.453" class="difflineplus">+    // HeaderFetchCompleted.</span>
<a href="#l5.454"></a><span id="l5.454" class="difflineplus">+    PRBool pendingMoves = m_moveCoalescer &amp;&amp; m_moveCoalescer-&gt;HasPendingMoves();</span>
<a href="#l5.455"></a><span id="l5.455" class="difflineplus">+    PlaybackCoalescedOperations();</span>
<a href="#l5.456"></a><span id="l5.456" class="difflineplus">+</span>
<a href="#l5.457"></a><span id="l5.457" class="difflineplus">+    PRBool filtersRun;</span>
<a href="#l5.458"></a><span id="l5.458" class="difflineplus">+    CallFilterPlugins(nsnull, &amp;filtersRun);</span>
<a href="#l5.459"></a><span id="l5.459" class="difflineplus">+    PRInt32 numNewBiffMsgs = 0;</span>
<a href="#l5.460"></a><span id="l5.460" class="difflineplus">+    if (m_performingBiff)</span>
<a href="#l5.461"></a><span id="l5.461" class="difflineplus">+      GetNumNewMessages(PR_FALSE, &amp;numNewBiffMsgs);</span>
<a href="#l5.462"></a><span id="l5.462" class="difflineplus">+</span>
<a href="#l5.463"></a><span id="l5.463" class="difflineplus">+    if (!filtersRun &amp;&amp; m_performingBiff &amp;&amp; mDatabase &amp;&amp; numNewBiffMsgs &gt; 0 &amp;&amp;</span>
<a href="#l5.464"></a><span id="l5.464" class="difflineplus">+        (!pendingMoves || !ShowPreviewText()))</span>
<a href="#l5.465"></a><span id="l5.465" class="difflineplus">+    {</span>
<a href="#l5.466"></a><span id="l5.466" class="difflineplus">+      // If we are performing biff for this folder, tell the</span>
<a href="#l5.467"></a><span id="l5.467" class="difflineplus">+      // stand-alone biff about the new high water mark</span>
<a href="#l5.468"></a><span id="l5.468" class="difflineplus">+      // We must ensure that the server knows that we are performing biff.</span>
<a href="#l5.469"></a><span id="l5.469" class="difflineplus">+      // Otherwise the stand-alone biff won't fire.</span>
<a href="#l5.470"></a><span id="l5.470" class="difflineplus">+      nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l5.471"></a><span id="l5.471" class="difflineplus">+      if (NS_SUCCEEDED(GetServer(getter_AddRefs(server))) &amp;&amp; server)</span>
<a href="#l5.472"></a><span id="l5.472" class="difflineplus">+        server-&gt;SetPerformingBiff(PR_TRUE);</span>
<a href="#l5.473"></a><span id="l5.473" class="difflineplus">+</span>
<a href="#l5.474"></a><span id="l5.474" class="difflineplus">+      SetBiffState(nsIMsgFolder::nsMsgBiffState_NewMail);</span>
<a href="#l5.475"></a><span id="l5.475" class="difflineplus">+      if (server)</span>
<a href="#l5.476"></a><span id="l5.476" class="difflineplus">+        server-&gt;SetPerformingBiff(PR_FALSE);</span>
<a href="#l5.477"></a><span id="l5.477" class="difflineplus">+      m_performingBiff = PR_FALSE;</span>
<a href="#l5.478"></a><span id="l5.478" class="difflineplus">+    }</span>
<a href="#l5.479"></a><span id="l5.479" class="difflineplus">+</span>
<a href="#l5.480"></a><span id="l5.480" class="difflineplus">+    if (m_filterList)</span>
<a href="#l5.481"></a><span id="l5.481" class="difflineplus">+      (void)m_filterList-&gt;FlushLogIfNecessary();</span>
<a href="#l5.482"></a><span id="l5.482" class="difflineplus">+  }</span>
<a href="#l5.483"></a><span id="l5.483" class="difflineplus">+</span>
<a href="#l5.484"></a><span id="l5.484">   return NS_OK;</span>
<a href="#l5.485"></a><span id="l5.485"> }</span>
<a href="#l5.486"></a><span id="l5.486"> </span>
<a href="#l5.487"></a><span id="l5.487"> NS_IMETHODIMP</span>
<a href="#l5.488"></a><span id="l5.488"> nsImapMailFolder::AbortMsgWriteStream()</span>
<a href="#l5.489"></a><span id="l5.489"> {</span>
<a href="#l5.490"></a><span id="l5.490">   m_offlineHeader = nsnull;</span>
<a href="#l5.491"></a><span id="l5.491">   return NS_ERROR_FAILURE;</span>
<a href="#l5.492"></a><span id="l5.492" class="difflineat">@@ -5365,16 +5564,18 @@ nsImapMailFolder::HeaderFetchCompleted(n</span>
<a href="#l5.493"></a><span id="l5.493"> </span>
<a href="#l5.494"></a><span id="l5.494">     PRBool autoDownloadNewHeaders = PR_FALSE;</span>
<a href="#l5.495"></a><span id="l5.495">     PRBool autoSyncOfflineStores = PR_FALSE;</span>
<a href="#l5.496"></a><span id="l5.496"> </span>
<a href="#l5.497"></a><span id="l5.497">     if (imapServer)</span>
<a href="#l5.498"></a><span id="l5.498">     {</span>
<a href="#l5.499"></a><span id="l5.499">       imapServer-&gt;GetAutoSyncOfflineStores(&amp;autoSyncOfflineStores);</span>
<a href="#l5.500"></a><span id="l5.500">       imapServer-&gt;GetDownloadBodiesOnGetNewMail(&amp;autoDownloadNewHeaders);</span>
<a href="#l5.501"></a><span id="l5.501" class="difflineplus">+      if (m_filterListRequiresBody)</span>
<a href="#l5.502"></a><span id="l5.502" class="difflineplus">+        autoDownloadNewHeaders = PR_TRUE;</span>
<a href="#l5.503"></a><span id="l5.503">     }</span>
<a href="#l5.504"></a><span id="l5.504">     PRBool notifiedBodies = PR_FALSE;</span>
<a href="#l5.505"></a><span id="l5.505">     if (m_downloadingFolderForOfflineUse || autoSyncOfflineStores ||</span>
<a href="#l5.506"></a><span id="l5.506">         autoDownloadNewHeaders)</span>
<a href="#l5.507"></a><span id="l5.507">     {</span>
<a href="#l5.508"></a><span id="l5.508">       nsTArray&lt;nsMsgKey&gt; keysToDownload;</span>
<a href="#l5.509"></a><span id="l5.509">       GetBodysToDownload(&amp;keysToDownload);</span>
<a href="#l5.510"></a><span id="l5.510">       if (!keysToDownload.IsEmpty())</span>
<a href="#l5.511"></a><span id="l5.511" class="difflineat">@@ -5405,40 +5606,41 @@ nsImapMailFolder::HeaderFetchCompleted(n</span>
<a href="#l5.512"></a><span id="l5.512">     if (runningUri)</span>
<a href="#l5.513"></a><span id="l5.513">     {</span>
<a href="#l5.514"></a><span id="l5.514">       nsCOMPtr &lt;nsIMsgMailNewsUrl&gt; mailnewsUrl = do_QueryInterface(runningUri);</span>
<a href="#l5.515"></a><span id="l5.515">       if (mailnewsUrl)</span>
<a href="#l5.516"></a><span id="l5.516">         mailnewsUrl-&gt;GetMsgWindow(getter_AddRefs(msgWindow));</span>
<a href="#l5.517"></a><span id="l5.517">     }</span>
<a href="#l5.518"></a><span id="l5.518">   }</span>
<a href="#l5.519"></a><span id="l5.519"> </span>
<a href="#l5.520"></a><span id="l5.520" class="difflineminus">-  PRBool filtersRun;</span>
<a href="#l5.521"></a><span id="l5.521" class="difflineminus">-  CallFilterPlugins(msgWindow, &amp;filtersRun);</span>
<a href="#l5.522"></a><span id="l5.522" class="difflineminus">-  if (!filtersRun &amp;&amp; m_performingBiff &amp;&amp; mDatabase &amp;&amp; numNewBiffMsgs &gt; 0 &amp;&amp;</span>
<a href="#l5.523"></a><span id="l5.523" class="difflineminus">-      (!pendingMoves || !ShowPreviewText()))</span>
<a href="#l5.524"></a><span id="l5.524" class="difflineminus">-  {</span>
<a href="#l5.525"></a><span id="l5.525" class="difflineminus">-    if (!pendingMoves)</span>
<a href="#l5.526"></a><span id="l5.526" class="difflineminus">-      SetHasNewMessages(PR_TRUE);</span>
<a href="#l5.527"></a><span id="l5.527" class="difflineminus">-</span>
<a href="#l5.528"></a><span id="l5.528" class="difflineminus">-    // If we are performing biff for this folder, tell the</span>
<a href="#l5.529"></a><span id="l5.529" class="difflineminus">-    // stand-alone biff about the new high water mark</span>
<a href="#l5.530"></a><span id="l5.530" class="difflineminus">-    // We must ensure that the server knows that we are performing biff.</span>
<a href="#l5.531"></a><span id="l5.531" class="difflineminus">-    // Otherwise the stand-alone biff won't fire.</span>
<a href="#l5.532"></a><span id="l5.532" class="difflineminus">-    nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l5.533"></a><span id="l5.533" class="difflineminus">-    if (NS_SUCCEEDED(GetServer(getter_AddRefs(server))) &amp;&amp; server)</span>
<a href="#l5.534"></a><span id="l5.534" class="difflineminus">-      server-&gt;SetPerformingBiff(PR_TRUE);</span>
<a href="#l5.535"></a><span id="l5.535" class="difflineminus">-</span>
<a href="#l5.536"></a><span id="l5.536" class="difflineminus">-    SetBiffState(nsIMsgFolder::nsMsgBiffState_NewMail);</span>
<a href="#l5.537"></a><span id="l5.537" class="difflineminus">-    if (server)</span>
<a href="#l5.538"></a><span id="l5.538" class="difflineminus">-      server-&gt;SetPerformingBiff(PR_FALSE);</span>
<a href="#l5.539"></a><span id="l5.539" class="difflineminus">-    m_performingBiff = PR_FALSE;</span>
<a href="#l5.540"></a><span id="l5.540" class="difflineminus">-  }</span>
<a href="#l5.541"></a><span id="l5.541" class="difflineminus">-</span>
<a href="#l5.542"></a><span id="l5.542" class="difflineminus">-  if (m_filterList)</span>
<a href="#l5.543"></a><span id="l5.543" class="difflineminus">-    (void)m_filterList-&gt;FlushLogIfNecessary();</span>
<a href="#l5.544"></a><span id="l5.544" class="difflineplus">+  // delay calling plugins if filter application is also delayed</span>
<a href="#l5.545"></a><span id="l5.545" class="difflineplus">+  if (!m_filterListRequiresBody)</span>
<a href="#l5.546"></a><span id="l5.546" class="difflineplus">+  {</span>
<a href="#l5.547"></a><span id="l5.547" class="difflineplus">+    PRBool filtersRun;</span>
<a href="#l5.548"></a><span id="l5.548" class="difflineplus">+    CallFilterPlugins(msgWindow, &amp;filtersRun);</span>
<a href="#l5.549"></a><span id="l5.549" class="difflineplus">+    if (!filtersRun &amp;&amp; m_performingBiff &amp;&amp; mDatabase &amp;&amp; numNewBiffMsgs &gt; 0 &amp;&amp;</span>
<a href="#l5.550"></a><span id="l5.550" class="difflineplus">+        (!pendingMoves || !ShowPreviewText()))</span>
<a href="#l5.551"></a><span id="l5.551" class="difflineplus">+    {</span>
<a href="#l5.552"></a><span id="l5.552" class="difflineplus">+      // If we are performing biff for this folder, tell the</span>
<a href="#l5.553"></a><span id="l5.553" class="difflineplus">+      // stand-alone biff about the new high water mark</span>
<a href="#l5.554"></a><span id="l5.554" class="difflineplus">+      // We must ensure that the server knows that we are performing biff.</span>
<a href="#l5.555"></a><span id="l5.555" class="difflineplus">+      // Otherwise the stand-alone biff won't fire.</span>
<a href="#l5.556"></a><span id="l5.556" class="difflineplus">+      nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l5.557"></a><span id="l5.557" class="difflineplus">+      if (NS_SUCCEEDED(GetServer(getter_AddRefs(server))) &amp;&amp; server)</span>
<a href="#l5.558"></a><span id="l5.558" class="difflineplus">+        server-&gt;SetPerformingBiff(PR_TRUE);</span>
<a href="#l5.559"></a><span id="l5.559" class="difflineplus">+</span>
<a href="#l5.560"></a><span id="l5.560" class="difflineplus">+      SetBiffState(nsIMsgFolder::nsMsgBiffState_NewMail);</span>
<a href="#l5.561"></a><span id="l5.561" class="difflineplus">+      if (server)</span>
<a href="#l5.562"></a><span id="l5.562" class="difflineplus">+        server-&gt;SetPerformingBiff(PR_FALSE);</span>
<a href="#l5.563"></a><span id="l5.563" class="difflineplus">+      m_performingBiff = PR_FALSE;</span>
<a href="#l5.564"></a><span id="l5.564" class="difflineplus">+    }</span>
<a href="#l5.565"></a><span id="l5.565" class="difflineplus">+</span>
<a href="#l5.566"></a><span id="l5.566" class="difflineplus">+    if (m_filterList)</span>
<a href="#l5.567"></a><span id="l5.567" class="difflineplus">+      (void)m_filterList-&gt;FlushLogIfNecessary();</span>
<a href="#l5.568"></a><span id="l5.568" class="difflineplus">+  }</span>
<a href="#l5.569"></a><span id="l5.569"> </span>
<a href="#l5.570"></a><span id="l5.570">   return NS_OK;</span>
<a href="#l5.571"></a><span id="l5.571"> }</span>
<a href="#l5.572"></a><span id="l5.572"> </span>
<a href="#l5.573"></a><span id="l5.573"> NS_IMETHODIMP</span>
<a href="#l5.574"></a><span id="l5.574"> nsImapMailFolder::SetBiffStateAndUpdate(nsMsgBiffState biffState)</span>
<a href="#l5.575"></a><span id="l5.575"> {</span>
<a href="#l5.576"></a><span id="l5.576">   SetBiffState(biffState);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/imap/src/nsImapMailFolder.h</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapMailFolder.h</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -502,16 +502,17 @@ protected:</span>
<a href="#l6.4"></a><span id="l6.4">   nsMsgIMAPFolderACL *m_folderACL;</span>
<a href="#l6.5"></a><span id="l6.5">   PRUint32     m_aclFlags;</span>
<a href="#l6.6"></a><span id="l6.6">   PRUint32     m_supportedUserFlags;</span>
<a href="#l6.7"></a><span id="l6.7"> </span>
<a href="#l6.8"></a><span id="l6.8">   static nsIAtom* mImapHdrDownloadedAtom;</span>
<a href="#l6.9"></a><span id="l6.9"> </span>
<a href="#l6.10"></a><span id="l6.10">   // offline imap support</span>
<a href="#l6.11"></a><span id="l6.11">   PRBool m_downloadingFolderForOfflineUse;</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+  PRBool m_filterListRequiresBody;</span>
<a href="#l6.13"></a><span id="l6.13">   </span>
<a href="#l6.14"></a><span id="l6.14">   // auto-sync (preemptive download) support</span>
<a href="#l6.15"></a><span id="l6.15">   nsRefPtr&lt;nsAutoSyncState&gt; m_autoSyncStateObj;</span>
<a href="#l6.16"></a><span id="l6.16">   </span>
<a href="#l6.17"></a><span id="l6.17">   // Quota support</span>
<a href="#l6.18"></a><span id="l6.18">   nsCString m_folderQuotaRoot;</span>
<a href="#l6.19"></a><span id="l6.19">   PRUint32 m_folderQuotaUsedKB;</span>
<a href="#l6.20"></a><span id="l6.20">   PRUint32 m_folderQuotaMaxKB;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1">new file mode 100644</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineminus">--- /dev/null</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineplus">+++ b/mailnews/imap/test/unit/test_imapFilterActions.js</span>
<a href="#l7.4"></a><span id="l7.4" class="difflineat">@@ -0,0 +1,774 @@</span>
<a href="#l7.5"></a><span id="l7.5" class="difflineplus">+/*</span>
<a href="#l7.6"></a><span id="l7.6" class="difflineplus">+ * This file tests imap filter actions, particularly as affected by the</span>
<a href="#l7.7"></a><span id="l7.7" class="difflineplus">+ * addition of body searches in bug 127250. Actions that involves sending</span>
<a href="#l7.8"></a><span id="l7.8" class="difflineplus">+ * mail are not tested. The tests check various counts, and the effects</span>
<a href="#l7.9"></a><span id="l7.9" class="difflineplus">+ * on the message database of the filters. Effects on IMAP server</span>
<a href="#l7.10"></a><span id="l7.10" class="difflineplus">+ * flags, if any, are not tested.</span>
<a href="#l7.11"></a><span id="l7.11" class="difflineplus">+ *</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+ * Original author: Kent James &lt;kent@caspia.com&gt;</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+ * adapted from test_localToImapFilter.js</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+ */</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/iteratorUtils.jsm&quot;);</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/folderUtils.jsm&quot;);</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineplus">+</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineplus">+const nsMsgSearchScope = Ci.nsMsgSearchScope;</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineplus">+const nsMsgSearchAttrib = Ci.nsMsgSearchAttrib;</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineplus">+const nsMsgSearchOp = Ci.nsMsgSearchOp;</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineplus">+const Is = nsMsgSearchOp.Is;</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineplus">+const Contains = nsMsgSearchOp.Contains;</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineplus">+const Subject = nsMsgSearchAttrib.Subject;</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineplus">+const Body = nsMsgSearchAttrib.Body;</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineplus">+</span>
<a href="#l7.27"></a><span id="l7.27" class="difflineplus">+// Globals</span>
<a href="#l7.28"></a><span id="l7.28" class="difflineplus">+var gIMAPDaemon; // the imap fake server daemon</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineplus">+var gServer; // the imap fake server</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineplus">+var gIMAPIncomingServer; // nsIMsgIncomingServer for the imap server</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineplus">+var gRootFolder; // root message folder for the imap server</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineplus">+var gIMAPInbox; // imap inbox message folder</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineplus">+var gIMAPTrashFolder; // imap trash message folder</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineplus">+var gSubfolder; // a local message folder used as a target for moves and copies</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineplus">+var gLastKey; // the last message key</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineplus">+var gFilter; // a message filter with a subject search</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineplus">+var gAction; // current message action (reused)</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineplus">+var gBodyFilter; // a message filter with a body search</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineplus">+var gInboxListener; // database listener object</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineplus">+var gContinueListener; // what listener is used to continue the test?</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineplus">+var gHeader; // the current message db header</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineplus">+var gChecks; // the function that will be used to check the results of the filter</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineplus">+var gInboxCount; // the previous number of messages in the Inbox</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineplus">+var gSubfolderCount; // the previous number of messages in the subfolder</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineplus">+var gMoveCallbackCount; // the number of callbacks from the move listener</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineplus">+const gMessage = &quot;draft1&quot;; // message file used as the test message</span>
<a href="#l7.47"></a><span id="l7.47" class="difflineplus">+</span>
<a href="#l7.48"></a><span id="l7.48" class="difflineplus">+// subject of the test message</span>
<a href="#l7.49"></a><span id="l7.49" class="difflineplus">+const gMessageSubject = &quot;Hello, did you receive my bugmail?&quot;;</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineplus">+</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineplus">+// a string in the body of the test message</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineplus">+const gMessageInBody = &quot;an HTML message&quot;;</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineplus">+</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineplus">+// various object references</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineplus">+const gCopyService = Cc[&quot;@mozilla.org/messenger/messagecopyservice;1&quot;]</span>
<a href="#l7.56"></a><span id="l7.56" class="difflineplus">+                       .getService(Ci.nsIMsgCopyService);</span>
<a href="#l7.57"></a><span id="l7.57" class="difflineplus">+const gDbService = Components.classes[&quot;@mozilla.org/msgDatabase/msgDBService;1&quot;]</span>
<a href="#l7.58"></a><span id="l7.58" class="difflineplus">+                             .getService(Components.interfaces.nsIMsgDBService);</span>
<a href="#l7.59"></a><span id="l7.59" class="difflineplus">+const gIMAPService = Cc[&quot;@mozilla.org/messenger/messageservice;1?type=imap&quot;]</span>
<a href="#l7.60"></a><span id="l7.60" class="difflineplus">+                       .getService(Ci.nsIMsgMessageService);</span>
<a href="#l7.61"></a><span id="l7.61" class="difflineplus">+const gMailSession = Cc[&quot;@mozilla.org/messenger/services/session;1&quot;]</span>
<a href="#l7.62"></a><span id="l7.62" class="difflineplus">+                     .getService(Ci.nsIMsgMailSession);</span>
<a href="#l7.63"></a><span id="l7.63" class="difflineplus">+const kFiltersAppliedAtom = Cc[&quot;@mozilla.org/atom-service;1&quot;]</span>
<a href="#l7.64"></a><span id="l7.64" class="difflineplus">+                              .getService(Ci.nsIAtomService)</span>
<a href="#l7.65"></a><span id="l7.65" class="difflineplus">+                              .getAtom(&quot;FiltersApplied&quot;);</span>
<a href="#l7.66"></a><span id="l7.66" class="difflineplus">+const kDeleteOrMoveMsgCompleted = Cc[&quot;@mozilla.org/atom-service;1&quot;]</span>
<a href="#l7.67"></a><span id="l7.67" class="difflineplus">+                                    .getService(Ci.nsIAtomService)</span>
<a href="#l7.68"></a><span id="l7.68" class="difflineplus">+                                    .getAtom(&quot;DeleteOrMoveMsgCompleted&quot;);</span>
<a href="#l7.69"></a><span id="l7.69" class="difflineplus">+</span>
<a href="#l7.70"></a><span id="l7.70" class="difflineplus">+// Definition of tests. The test function name is the filter action</span>
<a href="#l7.71"></a><span id="l7.71" class="difflineplus">+// being tested, with &quot;Body&quot; appended to tests that use delayed</span>
<a href="#l7.72"></a><span id="l7.72" class="difflineplus">+// application of filters due to a body search</span>
<a href="#l7.73"></a><span id="l7.73" class="difflineplus">+const gTestArray =</span>
<a href="#l7.74"></a><span id="l7.74" class="difflineplus">+[  // The initial tests do not result in new messages added.</span>
<a href="#l7.75"></a><span id="l7.75" class="difflineplus">+  function MoveToFolder() {</span>
<a href="#l7.76"></a><span id="l7.76" class="difflineplus">+    gAction.type = Ci.nsMsgFilterAction.MoveToFolder;</span>
<a href="#l7.77"></a><span id="l7.77" class="difflineplus">+    gAction.targetFolderUri = gSubfolder.URI;</span>
<a href="#l7.78"></a><span id="l7.78" class="difflineplus">+    gChecks = function checkMoveToFolder() {</span>
<a href="#l7.79"></a><span id="l7.79" class="difflineplus">+      testCounts(false, 0, 0, 0);</span>
<a href="#l7.80"></a><span id="l7.80" class="difflineplus">+      do_check_eq(gSubfolderCount + 1, folderCount(gSubfolder));</span>
<a href="#l7.81"></a><span id="l7.81" class="difflineplus">+      // no net messages were added to the inbox</span>
<a href="#l7.82"></a><span id="l7.82" class="difflineplus">+      do_check_eq(gInboxCount, folderCount(gIMAPInbox));</span>
<a href="#l7.83"></a><span id="l7.83" class="difflineplus">+    }</span>
<a href="#l7.84"></a><span id="l7.84" class="difflineplus">+    gInboxCount = folderCount(gIMAPInbox);</span>
<a href="#l7.85"></a><span id="l7.85" class="difflineplus">+    gSubfolderCount = folderCount(gSubfolder);</span>
<a href="#l7.86"></a><span id="l7.86" class="difflineplus">+    setupTest(gFilter, gAction);</span>
<a href="#l7.87"></a><span id="l7.87" class="difflineplus">+  },</span>
<a href="#l7.88"></a><span id="l7.88" class="difflineplus">+  function MoveToFolderBody() {</span>
<a href="#l7.89"></a><span id="l7.89" class="difflineplus">+    gAction.type = Ci.nsMsgFilterAction.MoveToFolder;</span>
<a href="#l7.90"></a><span id="l7.90" class="difflineplus">+    gAction.targetFolderUri = gSubfolder.URI;</span>
<a href="#l7.91"></a><span id="l7.91" class="difflineplus">+    gChecks = function checkMoveToFolderBody() {</span>
<a href="#l7.92"></a><span id="l7.92" class="difflineplus">+      testCounts(false, 0, 0, 0);</span>
<a href="#l7.93"></a><span id="l7.93" class="difflineplus">+      do_check_eq(gSubfolderCount + 1, folderCount(gSubfolder));</span>
<a href="#l7.94"></a><span id="l7.94" class="difflineplus">+      // no net messsages were added to the inbox</span>
<a href="#l7.95"></a><span id="l7.95" class="difflineplus">+      do_check_eq(gInboxCount, folderCount(gIMAPInbox));</span>
<a href="#l7.96"></a><span id="l7.96" class="difflineplus">+    }</span>
<a href="#l7.97"></a><span id="l7.97" class="difflineplus">+    gInboxCount = folderCount(gIMAPInbox);</span>
<a href="#l7.98"></a><span id="l7.98" class="difflineplus">+    gSubfolderCount = folderCount(gSubfolder);</span>
<a href="#l7.99"></a><span id="l7.99" class="difflineplus">+    setupTest(gBodyFilter, gAction);</span>
<a href="#l7.100"></a><span id="l7.100" class="difflineplus">+  },</span>
<a href="#l7.101"></a><span id="l7.101" class="difflineplus">+  function MarkRead() {</span>
<a href="#l7.102"></a><span id="l7.102" class="difflineplus">+    gAction.type = Ci.nsMsgFilterAction.MarkRead;</span>
<a href="#l7.103"></a><span id="l7.103" class="difflineplus">+    gChecks = function checks() {</span>
<a href="#l7.104"></a><span id="l7.104" class="difflineplus">+      testCounts(false, 0, 0, 0);</span>
<a href="#l7.105"></a><span id="l7.105" class="difflineplus">+      do_check_true(gHeader.isRead);</span>
<a href="#l7.106"></a><span id="l7.106" class="difflineplus">+    }</span>
<a href="#l7.107"></a><span id="l7.107" class="difflineplus">+    setupTest(gFilter, gAction);</span>
<a href="#l7.108"></a><span id="l7.108" class="difflineplus">+  },</span>
<a href="#l7.109"></a><span id="l7.109" class="difflineplus">+  function MarkReadBody() {</span>
<a href="#l7.110"></a><span id="l7.110" class="difflineplus">+    gAction.type = Ci.nsMsgFilterAction.MarkRead;</span>
<a href="#l7.111"></a><span id="l7.111" class="difflineplus">+    gChecks = function checkMarkRead() {</span>
<a href="#l7.112"></a><span id="l7.112" class="difflineplus">+      testCounts(false, 0, 0, 0);</span>
<a href="#l7.113"></a><span id="l7.113" class="difflineplus">+      do_check_true(gHeader.isRead);</span>
<a href="#l7.114"></a><span id="l7.114" class="difflineplus">+    }</span>
<a href="#l7.115"></a><span id="l7.115" class="difflineplus">+    setupTest(gBodyFilter, gAction);</span>
<a href="#l7.116"></a><span id="l7.116" class="difflineplus">+</span>
<a href="#l7.117"></a><span id="l7.117" class="difflineplus">+  },</span>
<a href="#l7.118"></a><span id="l7.118" class="difflineplus">+  function KillThread() {</span>
<a href="#l7.119"></a><span id="l7.119" class="difflineplus">+    gAction.type = Ci.nsMsgFilterAction.KillThread;</span>
<a href="#l7.120"></a><span id="l7.120" class="difflineplus">+    gChecks = function checkKillThread() {</span>
<a href="#l7.121"></a><span id="l7.121" class="difflineplus">+      testCounts(false, 0, 0, 0);</span>
<a href="#l7.122"></a><span id="l7.122" class="difflineplus">+      let thread = db().GetThreadContainingMsgHdr(gHeader);</span>
<a href="#l7.123"></a><span id="l7.123" class="difflineplus">+      do_check_neq(0, thread.flags &amp; Ci.nsMsgMessageFlags.Ignored);</span>
<a href="#l7.124"></a><span id="l7.124" class="difflineplus">+    }</span>
<a href="#l7.125"></a><span id="l7.125" class="difflineplus">+    setupTest(gFilter, gAction);</span>
<a href="#l7.126"></a><span id="l7.126" class="difflineplus">+  },</span>
<a href="#l7.127"></a><span id="l7.127" class="difflineplus">+  function KillThreadBody() {</span>
<a href="#l7.128"></a><span id="l7.128" class="difflineplus">+    gAction.type = Ci.nsMsgFilterAction.KillThread;</span>
<a href="#l7.129"></a><span id="l7.129" class="difflineplus">+    gChecks = function checkKillThread() {</span>
<a href="#l7.130"></a><span id="l7.130" class="difflineplus">+      testCounts(false, 0, 0, 0);</span>
<a href="#l7.131"></a><span id="l7.131" class="difflineplus">+      let thread = db().GetThreadContainingMsgHdr(gHeader);</span>
<a href="#l7.132"></a><span id="l7.132" class="difflineplus">+      do_check_neq(0, thread.flags &amp; Ci.nsMsgMessageFlags.Ignored);</span>
<a href="#l7.133"></a><span id="l7.133" class="difflineplus">+    }</span>
<a href="#l7.134"></a><span id="l7.134" class="difflineplus">+    setupTest(gBodyFilter, gAction);</span>
<a href="#l7.135"></a><span id="l7.135" class="difflineplus">+  },</span>
<a href="#l7.136"></a><span id="l7.136" class="difflineplus">+  function KillSubthread() {</span>
<a href="#l7.137"></a><span id="l7.137" class="difflineplus">+    gAction.type = Ci.nsMsgFilterAction.KillSubthread;</span>
<a href="#l7.138"></a><span id="l7.138" class="difflineplus">+    gChecks = function checkKillSubthread() {</span>
<a href="#l7.139"></a><span id="l7.139" class="difflineplus">+      testCounts(false, 0, 0, 0);</span>
<a href="#l7.140"></a><span id="l7.140" class="difflineplus">+      do_check_neq(0, gHeader.flags &amp; Ci.nsMsgMessageFlags.Ignored);</span>
<a href="#l7.141"></a><span id="l7.141" class="difflineplus">+    }</span>
<a href="#l7.142"></a><span id="l7.142" class="difflineplus">+    setupTest(gFilter, gAction);</span>
<a href="#l7.143"></a><span id="l7.143" class="difflineplus">+  },</span>
<a href="#l7.144"></a><span id="l7.144" class="difflineplus">+  function KillSubthreadBody() {</span>
<a href="#l7.145"></a><span id="l7.145" class="difflineplus">+    gAction.type = Ci.nsMsgFilterAction.KillSubthread;</span>
<a href="#l7.146"></a><span id="l7.146" class="difflineplus">+    gChecks = function checkKillSubthreadBody() {</span>
<a href="#l7.147"></a><span id="l7.147" class="difflineplus">+      testCounts(false, 0, 0, 0);</span>
<a href="#l7.148"></a><span id="l7.148" class="difflineplus">+      do_check_neq(0, gHeader.flags &amp; Ci.nsMsgMessageFlags.Ignored);</span>
<a href="#l7.149"></a><span id="l7.149" class="difflineplus">+    }</span>
<a href="#l7.150"></a><span id="l7.150" class="difflineplus">+    setupTest(gBodyFilter, gAction);</span>
<a href="#l7.151"></a><span id="l7.151" class="difflineplus">+  },</span>
<a href="#l7.152"></a><span id="l7.152" class="difflineplus">+  // this tests for marking message as junk</span>
<a href="#l7.153"></a><span id="l7.153" class="difflineplus">+  function JunkScore() {</span>
<a href="#l7.154"></a><span id="l7.154" class="difflineplus">+    gAction.type = Ci.nsMsgFilterAction.JunkScore;</span>
<a href="#l7.155"></a><span id="l7.155" class="difflineplus">+    gAction.junkScore = 100;</span>
<a href="#l7.156"></a><span id="l7.156" class="difflineplus">+    gChecks = function checkJunkScore() {</span>
<a href="#l7.157"></a><span id="l7.157" class="difflineplus">+      // marking as junk resets new but not unread</span>
<a href="#l7.158"></a><span id="l7.158" class="difflineplus">+      testCounts(false, 1, 0, 0);</span>
<a href="#l7.159"></a><span id="l7.159" class="difflineplus">+      do_check_eq(gHeader.getStringProperty(&quot;junkscore&quot;), &quot;100&quot;);</span>
<a href="#l7.160"></a><span id="l7.160" class="difflineplus">+      do_check_eq(gHeader.getStringProperty(&quot;junkscoreorigin&quot;), &quot;filter&quot;);</span>
<a href="#l7.161"></a><span id="l7.161" class="difflineplus">+    }</span>
<a href="#l7.162"></a><span id="l7.162" class="difflineplus">+    setupTest(gFilter, gAction);</span>
<a href="#l7.163"></a><span id="l7.163" class="difflineplus">+  },</span>
<a href="#l7.164"></a><span id="l7.164" class="difflineplus">+  // this tests for marking message as junk</span>
<a href="#l7.165"></a><span id="l7.165" class="difflineplus">+  function JunkScoreBody() {</span>
<a href="#l7.166"></a><span id="l7.166" class="difflineplus">+    gAction.type = Ci.nsMsgFilterAction.JunkScore;</span>
<a href="#l7.167"></a><span id="l7.167" class="difflineplus">+    gAction.junkScore = 100;</span>
<a href="#l7.168"></a><span id="l7.168" class="difflineplus">+    gChecks = function checkJunkScoreBody() {</span>
<a href="#l7.169"></a><span id="l7.169" class="difflineplus">+      // marking as junk resets new but not unread</span>
<a href="#l7.170"></a><span id="l7.170" class="difflineplus">+      testCounts(false, 1, 0, 0);</span>
<a href="#l7.171"></a><span id="l7.171" class="difflineplus">+      do_check_eq(gHeader.getStringProperty(&quot;junkscore&quot;), &quot;100&quot;);</span>
<a href="#l7.172"></a><span id="l7.172" class="difflineplus">+      do_check_eq(gHeader.getStringProperty(&quot;junkscoreorigin&quot;), &quot;filter&quot;);</span>
<a href="#l7.173"></a><span id="l7.173" class="difflineplus">+    }</span>
<a href="#l7.174"></a><span id="l7.174" class="difflineplus">+    setupTest(gBodyFilter, gAction);</span>
<a href="#l7.175"></a><span id="l7.175" class="difflineplus">+  },</span>
<a href="#l7.176"></a><span id="l7.176" class="difflineplus">+</span>
<a href="#l7.177"></a><span id="l7.177" class="difflineplus">+  // The remaining tests add new messages</span>
<a href="#l7.178"></a><span id="l7.178" class="difflineplus">+  function WatchThread() {</span>
<a href="#l7.179"></a><span id="l7.179" class="difflineplus">+    gAction.type = Ci.nsMsgFilterAction.WatchThread;</span>
<a href="#l7.180"></a><span id="l7.180" class="difflineplus">+    gChecks = function checkWatchThread() {</span>
<a href="#l7.181"></a><span id="l7.181" class="difflineplus">+      testCounts(true, 1, 1, 1);</span>
<a href="#l7.182"></a><span id="l7.182" class="difflineplus">+      let thread = db().GetThreadContainingMsgHdr(gHeader);</span>
<a href="#l7.183"></a><span id="l7.183" class="difflineplus">+      do_check_neq(0, thread.flags &amp; Ci.nsMsgMessageFlags.Watched);</span>
<a href="#l7.184"></a><span id="l7.184" class="difflineplus">+    }</span>
<a href="#l7.185"></a><span id="l7.185" class="difflineplus">+    setupTest(gFilter, gAction);</span>
<a href="#l7.186"></a><span id="l7.186" class="difflineplus">+  },</span>
<a href="#l7.187"></a><span id="l7.187" class="difflineplus">+  function WatchThreadBody() {</span>
<a href="#l7.188"></a><span id="l7.188" class="difflineplus">+    gAction.type = Ci.nsMsgFilterAction.WatchThread;</span>
<a href="#l7.189"></a><span id="l7.189" class="difflineplus">+    gChecks = function checkWatchThreadBody() {</span>
<a href="#l7.190"></a><span id="l7.190" class="difflineplus">+      testCounts(true, 1, 1, 1);</span>
<a href="#l7.191"></a><span id="l7.191" class="difflineplus">+      let thread = db().GetThreadContainingMsgHdr(gHeader);</span>
<a href="#l7.192"></a><span id="l7.192" class="difflineplus">+      do_check_neq(0, thread.flags &amp; Ci.nsMsgMessageFlags.Watched);</span>
<a href="#l7.193"></a><span id="l7.193" class="difflineplus">+    }</span>
<a href="#l7.194"></a><span id="l7.194" class="difflineplus">+    setupTest(gBodyFilter, gAction);</span>
<a href="#l7.195"></a><span id="l7.195" class="difflineplus">+  },</span>
<a href="#l7.196"></a><span id="l7.196" class="difflineplus">+  function MarkFlagged() {</span>
<a href="#l7.197"></a><span id="l7.197" class="difflineplus">+    gAction.type = Ci.nsMsgFilterAction.MarkFlagged;</span>
<a href="#l7.198"></a><span id="l7.198" class="difflineplus">+    gChecks = function checkMarkFlagged() {</span>
<a href="#l7.199"></a><span id="l7.199" class="difflineplus">+      testCounts(true, 1, 1, 1);</span>
<a href="#l7.200"></a><span id="l7.200" class="difflineplus">+      do_check_true(gHeader.isFlagged);</span>
<a href="#l7.201"></a><span id="l7.201" class="difflineplus">+    }</span>
<a href="#l7.202"></a><span id="l7.202" class="difflineplus">+    setupTest(gFilter, gAction);</span>
<a href="#l7.203"></a><span id="l7.203" class="difflineplus">+  },</span>
<a href="#l7.204"></a><span id="l7.204" class="difflineplus">+  function MarkFlaggedBody() {</span>
<a href="#l7.205"></a><span id="l7.205" class="difflineplus">+    gAction.type = Ci.nsMsgFilterAction.MarkFlagged;</span>
<a href="#l7.206"></a><span id="l7.206" class="difflineplus">+    gChecks = function checkMarkFlaggedBody() {</span>
<a href="#l7.207"></a><span id="l7.207" class="difflineplus">+      testCounts(true, 1, 1, 1);</span>
<a href="#l7.208"></a><span id="l7.208" class="difflineplus">+      do_check_true(gHeader.isFlagged);</span>
<a href="#l7.209"></a><span id="l7.209" class="difflineplus">+    }</span>
<a href="#l7.210"></a><span id="l7.210" class="difflineplus">+    setupTest(gBodyFilter, gAction);</span>
<a href="#l7.211"></a><span id="l7.211" class="difflineplus">+  },</span>
<a href="#l7.212"></a><span id="l7.212" class="difflineplus">+  function ChangePriority() {</span>
<a href="#l7.213"></a><span id="l7.213" class="difflineplus">+    gAction.type = Ci.nsMsgFilterAction.ChangePriority;</span>
<a href="#l7.214"></a><span id="l7.214" class="difflineplus">+    gAction.priority = Ci.nsMsgPriority.highest;</span>
<a href="#l7.215"></a><span id="l7.215" class="difflineplus">+    gChecks = function checkChangePriority() {</span>
<a href="#l7.216"></a><span id="l7.216" class="difflineplus">+      testCounts(true, 1, 1, 1);</span>
<a href="#l7.217"></a><span id="l7.217" class="difflineplus">+      do_check_eq(Ci.nsMsgPriority.highest, gHeader.priority);</span>
<a href="#l7.218"></a><span id="l7.218" class="difflineplus">+    }</span>
<a href="#l7.219"></a><span id="l7.219" class="difflineplus">+    setupTest(gFilter, gAction);</span>
<a href="#l7.220"></a><span id="l7.220" class="difflineplus">+  },</span>
<a href="#l7.221"></a><span id="l7.221" class="difflineplus">+  function ChangePriorityBody() {</span>
<a href="#l7.222"></a><span id="l7.222" class="difflineplus">+    gAction.type = Ci.nsMsgFilterAction.ChangePriority;</span>
<a href="#l7.223"></a><span id="l7.223" class="difflineplus">+    gAction.priority = Ci.nsMsgPriority.highest;</span>
<a href="#l7.224"></a><span id="l7.224" class="difflineplus">+    gChecks = function checkChangePriorityBody() {</span>
<a href="#l7.225"></a><span id="l7.225" class="difflineplus">+      testCounts(true, 1, 1, 1);</span>
<a href="#l7.226"></a><span id="l7.226" class="difflineplus">+      do_check_eq(Ci.nsMsgPriority.highest, gHeader.priority);</span>
<a href="#l7.227"></a><span id="l7.227" class="difflineplus">+    }</span>
<a href="#l7.228"></a><span id="l7.228" class="difflineplus">+    setupTest(gBodyFilter, gAction);</span>
<a href="#l7.229"></a><span id="l7.229" class="difflineplus">+  },</span>
<a href="#l7.230"></a><span id="l7.230" class="difflineplus">+  function Label() {</span>
<a href="#l7.231"></a><span id="l7.231" class="difflineplus">+    gAction.type = Ci.nsMsgFilterAction.Label;</span>
<a href="#l7.232"></a><span id="l7.232" class="difflineplus">+    gAction.label = 2;</span>
<a href="#l7.233"></a><span id="l7.233" class="difflineplus">+    gChecks = function checkLabel() {</span>
<a href="#l7.234"></a><span id="l7.234" class="difflineplus">+      testCounts(true, 1, 1, 1);</span>
<a href="#l7.235"></a><span id="l7.235" class="difflineplus">+      do_check_eq(2, gHeader.label);</span>
<a href="#l7.236"></a><span id="l7.236" class="difflineplus">+    }</span>
<a href="#l7.237"></a><span id="l7.237" class="difflineplus">+    setupTest(gFilter, gAction);</span>
<a href="#l7.238"></a><span id="l7.238" class="difflineplus">+  },</span>
<a href="#l7.239"></a><span id="l7.239" class="difflineplus">+  function LabelBody() {</span>
<a href="#l7.240"></a><span id="l7.240" class="difflineplus">+    gAction.type = Ci.nsMsgFilterAction.Label;</span>
<a href="#l7.241"></a><span id="l7.241" class="difflineplus">+    gAction.label = 3;</span>
<a href="#l7.242"></a><span id="l7.242" class="difflineplus">+    gChecks = function checkLabelBody() {</span>
<a href="#l7.243"></a><span id="l7.243" class="difflineplus">+      testCounts(true, 1, 1, 1);</span>
<a href="#l7.244"></a><span id="l7.244" class="difflineplus">+      do_check_eq(3, gHeader.label);</span>
<a href="#l7.245"></a><span id="l7.245" class="difflineplus">+    }</span>
<a href="#l7.246"></a><span id="l7.246" class="difflineplus">+    setupTest(gBodyFilter, gAction);</span>
<a href="#l7.247"></a><span id="l7.247" class="difflineplus">+  },</span>
<a href="#l7.248"></a><span id="l7.248" class="difflineplus">+  function AddTag() {</span>
<a href="#l7.249"></a><span id="l7.249" class="difflineplus">+    gAction.type = Ci.nsMsgFilterAction.AddTag;</span>
<a href="#l7.250"></a><span id="l7.250" class="difflineplus">+    gAction.strValue = &quot;TheTag&quot;;</span>
<a href="#l7.251"></a><span id="l7.251" class="difflineplus">+    gChecks = function checkAddTag() {</span>
<a href="#l7.252"></a><span id="l7.252" class="difflineplus">+      testCounts(true, 1, 1, 1);</span>
<a href="#l7.253"></a><span id="l7.253" class="difflineplus">+      do_check_eq(gHeader.getStringProperty(&quot;keywords&quot;), &quot;TheTag&quot;);</span>
<a href="#l7.254"></a><span id="l7.254" class="difflineplus">+    }</span>
<a href="#l7.255"></a><span id="l7.255" class="difflineplus">+    setupTest(gFilter, gAction);</span>
<a href="#l7.256"></a><span id="l7.256" class="difflineplus">+  },</span>
<a href="#l7.257"></a><span id="l7.257" class="difflineplus">+  function AddTagBody() {</span>
<a href="#l7.258"></a><span id="l7.258" class="difflineplus">+    gAction.type = Ci.nsMsgFilterAction.AddTag;</span>
<a href="#l7.259"></a><span id="l7.259" class="difflineplus">+    gAction.strValue = &quot;TheTag2&quot;;</span>
<a href="#l7.260"></a><span id="l7.260" class="difflineplus">+    gChecks = function checkAddTagBody() {</span>
<a href="#l7.261"></a><span id="l7.261" class="difflineplus">+      testCounts(true, 1, 1, 1);</span>
<a href="#l7.262"></a><span id="l7.262" class="difflineplus">+      do_check_eq(gHeader.getStringProperty(&quot;keywords&quot;), &quot;TheTag2&quot;);</span>
<a href="#l7.263"></a><span id="l7.263" class="difflineplus">+    }</span>
<a href="#l7.264"></a><span id="l7.264" class="difflineplus">+    setupTest(gBodyFilter, gAction);</span>
<a href="#l7.265"></a><span id="l7.265" class="difflineplus">+  },</span>
<a href="#l7.266"></a><span id="l7.266" class="difflineplus">+  // this tests for marking message as good</span>
<a href="#l7.267"></a><span id="l7.267" class="difflineplus">+  function JunkScoreAsGood() {</span>
<a href="#l7.268"></a><span id="l7.268" class="difflineplus">+    gAction.type = Ci.nsMsgFilterAction.JunkScore;</span>
<a href="#l7.269"></a><span id="l7.269" class="difflineplus">+    gAction.junkScore = 0;</span>
<a href="#l7.270"></a><span id="l7.270" class="difflineplus">+    gChecks = function checkJunkScore() {</span>
<a href="#l7.271"></a><span id="l7.271" class="difflineplus">+      testCounts(true, 1, 1, 1);</span>
<a href="#l7.272"></a><span id="l7.272" class="difflineplus">+      do_check_eq(gHeader.getStringProperty(&quot;junkscore&quot;), &quot;0&quot;);</span>
<a href="#l7.273"></a><span id="l7.273" class="difflineplus">+      do_check_eq(gHeader.getStringProperty(&quot;junkscoreorigin&quot;), &quot;filter&quot;);</span>
<a href="#l7.274"></a><span id="l7.274" class="difflineplus">+    }</span>
<a href="#l7.275"></a><span id="l7.275" class="difflineplus">+    setupTest(gFilter, gAction);</span>
<a href="#l7.276"></a><span id="l7.276" class="difflineplus">+  },</span>
<a href="#l7.277"></a><span id="l7.277" class="difflineplus">+  // this tests for marking message as good</span>
<a href="#l7.278"></a><span id="l7.278" class="difflineplus">+  function JunkScoreAsGoodBody() {</span>
<a href="#l7.279"></a><span id="l7.279" class="difflineplus">+    gAction.type = Ci.nsMsgFilterAction.JunkScore;</span>
<a href="#l7.280"></a><span id="l7.280" class="difflineplus">+    gAction.junkScore = 0;</span>
<a href="#l7.281"></a><span id="l7.281" class="difflineplus">+    gChecks = function checkJunkScoreBody() {</span>
<a href="#l7.282"></a><span id="l7.282" class="difflineplus">+      testCounts(true, 1, 1, 1);</span>
<a href="#l7.283"></a><span id="l7.283" class="difflineplus">+      do_check_eq(gHeader.getStringProperty(&quot;junkscore&quot;), &quot;0&quot;);</span>
<a href="#l7.284"></a><span id="l7.284" class="difflineplus">+      do_check_eq(gHeader.getStringProperty(&quot;junkscoreorigin&quot;), &quot;filter&quot;);</span>
<a href="#l7.285"></a><span id="l7.285" class="difflineplus">+    }</span>
<a href="#l7.286"></a><span id="l7.286" class="difflineplus">+    setupTest(gBodyFilter, gAction);</span>
<a href="#l7.287"></a><span id="l7.287" class="difflineplus">+  },</span>
<a href="#l7.288"></a><span id="l7.288" class="difflineplus">+  function CopyToFolder() {</span>
<a href="#l7.289"></a><span id="l7.289" class="difflineplus">+    gAction.type = Ci.nsMsgFilterAction.CopyToFolder;</span>
<a href="#l7.290"></a><span id="l7.290" class="difflineplus">+    gAction.targetFolderUri = gSubfolder.URI;</span>
<a href="#l7.291"></a><span id="l7.291" class="difflineplus">+    gChecks = function checkCopyToFolder() {</span>
<a href="#l7.292"></a><span id="l7.292" class="difflineplus">+      testCounts(true, 1, 1, 1);</span>
<a href="#l7.293"></a><span id="l7.293" class="difflineplus">+      do_check_eq(gInboxCount + 1, folderCount(gIMAPInbox));</span>
<a href="#l7.294"></a><span id="l7.294" class="difflineplus">+      do_check_eq(gSubfolderCount + 1, folderCount(gSubfolder));</span>
<a href="#l7.295"></a><span id="l7.295" class="difflineplus">+    }</span>
<a href="#l7.296"></a><span id="l7.296" class="difflineplus">+    gInboxCount = folderCount(gIMAPInbox);</span>
<a href="#l7.297"></a><span id="l7.297" class="difflineplus">+    gSubfolderCount = folderCount(gSubfolder);</span>
<a href="#l7.298"></a><span id="l7.298" class="difflineplus">+    setupTest(gFilter, gAction);</span>
<a href="#l7.299"></a><span id="l7.299" class="difflineplus">+  },</span>
<a href="#l7.300"></a><span id="l7.300" class="difflineplus">+  function CopyToFolderBody() {</span>
<a href="#l7.301"></a><span id="l7.301" class="difflineplus">+    gAction.type = Ci.nsMsgFilterAction.CopyToFolder;</span>
<a href="#l7.302"></a><span id="l7.302" class="difflineplus">+    gAction.targetFolderUri = gSubfolder.URI;</span>
<a href="#l7.303"></a><span id="l7.303" class="difflineplus">+    gChecks = function checkCopyToFolderBody() {</span>
<a href="#l7.304"></a><span id="l7.304" class="difflineplus">+      testCounts(true, 1, 1, 1);</span>
<a href="#l7.305"></a><span id="l7.305" class="difflineplus">+      do_check_eq(gInboxCount + 1, folderCount(gIMAPInbox));</span>
<a href="#l7.306"></a><span id="l7.306" class="difflineplus">+      do_check_eq(gSubfolderCount + 1, folderCount(gSubfolder));</span>
<a href="#l7.307"></a><span id="l7.307" class="difflineplus">+    }</span>
<a href="#l7.308"></a><span id="l7.308" class="difflineplus">+    gInboxCount = folderCount(gIMAPInbox);</span>
<a href="#l7.309"></a><span id="l7.309" class="difflineplus">+    gSubfolderCount = folderCount(gSubfolder);</span>
<a href="#l7.310"></a><span id="l7.310" class="difflineplus">+    setupTest(gBodyFilter, gAction);</span>
<a href="#l7.311"></a><span id="l7.311" class="difflineplus">+  },</span>
<a href="#l7.312"></a><span id="l7.312" class="difflineplus">+</span>
<a href="#l7.313"></a><span id="l7.313" class="difflineplus">+];</span>
<a href="#l7.314"></a><span id="l7.314" class="difflineplus">+</span>
<a href="#l7.315"></a><span id="l7.315" class="difflineplus">+function run_test()</span>
<a href="#l7.316"></a><span id="l7.316" class="difflineplus">+{</span>
<a href="#l7.317"></a><span id="l7.317" class="difflineplus">+  // This is before any of the actual tests, so...</span>
<a href="#l7.318"></a><span id="l7.318" class="difflineplus">+  gTest = 0;</span>
<a href="#l7.319"></a><span id="l7.319" class="difflineplus">+</span>
<a href="#l7.320"></a><span id="l7.320" class="difflineplus">+  // Add a listener.</span>
<a href="#l7.321"></a><span id="l7.321" class="difflineplus">+  gIMAPDaemon = new imapDaemon();</span>
<a href="#l7.322"></a><span id="l7.322" class="difflineplus">+  gServer = makeServer(gIMAPDaemon, &quot;&quot;);</span>
<a href="#l7.323"></a><span id="l7.323" class="difflineplus">+</span>
<a href="#l7.324"></a><span id="l7.324" class="difflineplus">+  gIMAPIncomingServer = createLocalIMAPServer();</span>
<a href="#l7.325"></a><span id="l7.325" class="difflineplus">+</span>
<a href="#l7.326"></a><span id="l7.326" class="difflineplus">+  if (!gLocalInboxFolder)</span>
<a href="#l7.327"></a><span id="l7.327" class="difflineplus">+    loadLocalMailAccount();</span>
<a href="#l7.328"></a><span id="l7.328" class="difflineplus">+</span>
<a href="#l7.329"></a><span id="l7.329" class="difflineplus">+  // We need an identity so that updateFolder doesn't fail</span>
<a href="#l7.330"></a><span id="l7.330" class="difflineplus">+  let acctMgr = Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l7.331"></a><span id="l7.331" class="difflineplus">+                  .getService(Ci.nsIMsgAccountManager);</span>
<a href="#l7.332"></a><span id="l7.332" class="difflineplus">+  let localAccount = acctMgr.createAccount();</span>
<a href="#l7.333"></a><span id="l7.333" class="difflineplus">+  let identity = acctMgr.createIdentity();</span>
<a href="#l7.334"></a><span id="l7.334" class="difflineplus">+  localAccount.addIdentity(identity);</span>
<a href="#l7.335"></a><span id="l7.335" class="difflineplus">+  localAccount.defaultIdentity = identity;</span>
<a href="#l7.336"></a><span id="l7.336" class="difflineplus">+  localAccount.incomingServer = gLocalIncomingServer;</span>
<a href="#l7.337"></a><span id="l7.337" class="difflineplus">+  acctMgr.defaultAccount = localAccount;</span>
<a href="#l7.338"></a><span id="l7.338" class="difflineplus">+</span>
<a href="#l7.339"></a><span id="l7.339" class="difflineplus">+  // Let's also have another account, using the same identity</span>
<a href="#l7.340"></a><span id="l7.340" class="difflineplus">+  let imapAccount = acctMgr.createAccount();</span>
<a href="#l7.341"></a><span id="l7.341" class="difflineplus">+  imapAccount.addIdentity(identity);</span>
<a href="#l7.342"></a><span id="l7.342" class="difflineplus">+  imapAccount.defaultIdentity = identity;</span>
<a href="#l7.343"></a><span id="l7.343" class="difflineplus">+  imapAccount.incomingServer = gIMAPIncomingServer;</span>
<a href="#l7.344"></a><span id="l7.344" class="difflineplus">+</span>
<a href="#l7.345"></a><span id="l7.345" class="difflineplus">+  // The server doesn't support more than one connection</span>
<a href="#l7.346"></a><span id="l7.346" class="difflineplus">+  let prefBranch = Cc[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l7.347"></a><span id="l7.347" class="difflineplus">+                     .getService(Ci.nsIPrefBranch);</span>
<a href="#l7.348"></a><span id="l7.348" class="difflineplus">+  prefBranch.setIntPref(&quot;mail.server.default.max_cached_connections&quot;, 1);</span>
<a href="#l7.349"></a><span id="l7.349" class="difflineplus">+  // We aren't interested in downloading messages automatically</span>
<a href="#l7.350"></a><span id="l7.350" class="difflineplus">+  prefBranch.setBoolPref(&quot;mail.server.default.download_on_biff&quot;, false);</span>
<a href="#l7.351"></a><span id="l7.351" class="difflineplus">+  prefBranch.setBoolPref(&quot;mail.biff.play_sound&quot;, false);</span>
<a href="#l7.352"></a><span id="l7.352" class="difflineplus">+  prefBranch.setBoolPref(&quot;mail.biff.show_alert&quot;, false);</span>
<a href="#l7.353"></a><span id="l7.353" class="difflineplus">+  prefBranch.setBoolPref(&quot;mail.biff.show_tray_icon&quot;, false);</span>
<a href="#l7.354"></a><span id="l7.354" class="difflineplus">+  prefBranch.setBoolPref(&quot;mail.biff.animate_dock_icon&quot;, false);</span>
<a href="#l7.355"></a><span id="l7.355" class="difflineplus">+</span>
<a href="#l7.356"></a><span id="l7.356" class="difflineplus">+  gSubfolder = gLocalIncomingServer.rootFolder.addSubfolder(&quot;Subfolder&quot;);</span>
<a href="#l7.357"></a><span id="l7.357" class="difflineplus">+  gIMAPIncomingServer.performExpand(null);</span>
<a href="#l7.358"></a><span id="l7.358" class="difflineplus">+</span>
<a href="#l7.359"></a><span id="l7.359" class="difflineplus">+  gRootFolder = gIMAPIncomingServer.rootFolder;</span>
<a href="#l7.360"></a><span id="l7.360" class="difflineplus">+  gIMAPInbox = gRootFolder.getChildNamed(&quot;INBOX&quot;);</span>
<a href="#l7.361"></a><span id="l7.361" class="difflineplus">+  gIMAPMailbox = gIMAPDaemon.getMailbox(&quot;INBOX&quot;);</span>
<a href="#l7.362"></a><span id="l7.362" class="difflineplus">+  dump(&quot;gIMAPInbox uri = &quot; + gIMAPInbox.URI + &quot;\n&quot;);</span>
<a href="#l7.363"></a><span id="l7.363" class="difflineplus">+  msgImapFolder = gIMAPInbox.QueryInterface(Ci.nsIMsgImapMailFolder);</span>
<a href="#l7.364"></a><span id="l7.364" class="difflineplus">+  // these hacks are required because we've created the inbox before</span>
<a href="#l7.365"></a><span id="l7.365" class="difflineplus">+  // running initial folder discovery, and adding the folder bails</span>
<a href="#l7.366"></a><span id="l7.366" class="difflineplus">+  // out before we set it as verified online, so we bail out, and</span>
<a href="#l7.367"></a><span id="l7.367" class="difflineplus">+  // then remove the INBOX folder since it's not verified.</span>
<a href="#l7.368"></a><span id="l7.368" class="difflineplus">+  msgImapFolder.hierarchyDelimiter = '/';</span>
<a href="#l7.369"></a><span id="l7.369" class="difflineplus">+  msgImapFolder.verifiedAsOnlineFolder = true;</span>
<a href="#l7.370"></a><span id="l7.370" class="difflineplus">+</span>
<a href="#l7.371"></a><span id="l7.371" class="difflineplus">+// Create a non-body filter.</span>
<a href="#l7.372"></a><span id="l7.372" class="difflineplus">+  let filterList = gIMAPIncomingServer.getFilterList(null);</span>
<a href="#l7.373"></a><span id="l7.373" class="difflineplus">+  gFilter = filterList.createFilter(&quot;subject&quot;);</span>
<a href="#l7.374"></a><span id="l7.374" class="difflineplus">+  let searchTerm = gFilter.createTerm();</span>
<a href="#l7.375"></a><span id="l7.375" class="difflineplus">+  searchTerm.attrib = Subject;</span>
<a href="#l7.376"></a><span id="l7.376" class="difflineplus">+  searchTerm.op = Is;</span>
<a href="#l7.377"></a><span id="l7.377" class="difflineplus">+  var value = searchTerm.value;</span>
<a href="#l7.378"></a><span id="l7.378" class="difflineplus">+  value.attrib = Subject;</span>
<a href="#l7.379"></a><span id="l7.379" class="difflineplus">+  value.str = gMessageSubject;</span>
<a href="#l7.380"></a><span id="l7.380" class="difflineplus">+  searchTerm.value = value;</span>
<a href="#l7.381"></a><span id="l7.381" class="difflineplus">+  searchTerm.booleanAnd = false;</span>
<a href="#l7.382"></a><span id="l7.382" class="difflineplus">+  gFilter.appendTerm(searchTerm);</span>
<a href="#l7.383"></a><span id="l7.383" class="difflineplus">+  gFilter.enabled = true;</span>
<a href="#l7.384"></a><span id="l7.384" class="difflineplus">+</span>
<a href="#l7.385"></a><span id="l7.385" class="difflineplus">+  // Create a filter with a body term that that forces delayed application of</span>
<a href="#l7.386"></a><span id="l7.386" class="difflineplus">+  // filters until after body download.</span>
<a href="#l7.387"></a><span id="l7.387" class="difflineplus">+  gBodyFilter = filterList.createFilter(&quot;body&quot;);</span>
<a href="#l7.388"></a><span id="l7.388" class="difflineplus">+  searchTerm = gBodyFilter.createTerm();</span>
<a href="#l7.389"></a><span id="l7.389" class="difflineplus">+  searchTerm.attrib = Body;</span>
<a href="#l7.390"></a><span id="l7.390" class="difflineplus">+  searchTerm.op = Contains;</span>
<a href="#l7.391"></a><span id="l7.391" class="difflineplus">+  value = searchTerm.value;</span>
<a href="#l7.392"></a><span id="l7.392" class="difflineplus">+  value.attrib = Body;</span>
<a href="#l7.393"></a><span id="l7.393" class="difflineplus">+  value.str = gMessageInBody;</span>
<a href="#l7.394"></a><span id="l7.394" class="difflineplus">+  searchTerm.value = value;</span>
<a href="#l7.395"></a><span id="l7.395" class="difflineplus">+  searchTerm.booleanAnd = false;</span>
<a href="#l7.396"></a><span id="l7.396" class="difflineplus">+  gBodyFilter.appendTerm(searchTerm);</span>
<a href="#l7.397"></a><span id="l7.397" class="difflineplus">+  gBodyFilter.enabled = true;</span>
<a href="#l7.398"></a><span id="l7.398" class="difflineplus">+</span>
<a href="#l7.399"></a><span id="l7.399" class="difflineplus">+  // an action that can be modified by tests</span>
<a href="#l7.400"></a><span id="l7.400" class="difflineplus">+  gAction = gFilter.createAction();</span>
<a href="#l7.401"></a><span id="l7.401" class="difflineplus">+</span>
<a href="#l7.402"></a><span id="l7.402" class="difflineplus">+  gMailSession.AddFolderListener(FolderListener, Ci.nsIFolderListener.event);</span>
<a href="#l7.403"></a><span id="l7.403" class="difflineplus">+</span>
<a href="#l7.404"></a><span id="l7.404" class="difflineplus">+  // &quot;Master&quot; do_test_pending(), paired with a do_test_finished() at the end of</span>
<a href="#l7.405"></a><span id="l7.405" class="difflineplus">+  // all the operations.</span>
<a href="#l7.406"></a><span id="l7.406" class="difflineplus">+  do_test_pending();</span>
<a href="#l7.407"></a><span id="l7.407" class="difflineplus">+</span>
<a href="#l7.408"></a><span id="l7.408" class="difflineplus">+  //start first test</span>
<a href="#l7.409"></a><span id="l7.409" class="difflineplus">+  gCurTestNum = 1;</span>
<a href="#l7.410"></a><span id="l7.410" class="difflineplus">+  doTest();</span>
<a href="#l7.411"></a><span id="l7.411" class="difflineplus">+}</span>
<a href="#l7.412"></a><span id="l7.412" class="difflineplus">+</span>
<a href="#l7.413"></a><span id="l7.413" class="difflineplus">+/*</span>
<a href="#l7.414"></a><span id="l7.414" class="difflineplus">+ * functions used to support test setup and execution</span>
<a href="#l7.415"></a><span id="l7.415" class="difflineplus">+ */</span>
<a href="#l7.416"></a><span id="l7.416" class="difflineplus">+</span>
<a href="#l7.417"></a><span id="l7.417" class="difflineplus">+// if the source matches the listener used to continue a test,</span>
<a href="#l7.418"></a><span id="l7.418" class="difflineplus">+// run the test checks, and start the next test.</span>
<a href="#l7.419"></a><span id="l7.419" class="difflineplus">+function testContinue(source)</span>
<a href="#l7.420"></a><span id="l7.420" class="difflineplus">+{</span>
<a href="#l7.421"></a><span id="l7.421" class="difflineplus">+  if (gContinueListener === source)</span>
<a href="#l7.422"></a><span id="l7.422" class="difflineplus">+  {</span>
<a href="#l7.423"></a><span id="l7.423" class="difflineplus">+    if (gContinueListener == kDeleteOrMoveMsgCompleted &amp;&amp;</span>
<a href="#l7.424"></a><span id="l7.424" class="difflineplus">+        gAction.type == Ci.nsMsgFilterAction.MoveToFolder)</span>
<a href="#l7.425"></a><span id="l7.425" class="difflineplus">+    {</span>
<a href="#l7.426"></a><span id="l7.426" class="difflineplus">+      // Moves give 2 events, just use the second.</span>
<a href="#l7.427"></a><span id="l7.427" class="difflineplus">+      gMoveCallbackCount++;</span>
<a href="#l7.428"></a><span id="l7.428" class="difflineplus">+      if (gMoveCallbackCount != 2)</span>
<a href="#l7.429"></a><span id="l7.429" class="difflineplus">+        return;</span>
<a href="#l7.430"></a><span id="l7.430" class="difflineplus">+    }</span>
<a href="#l7.431"></a><span id="l7.431" class="difflineplus">+    if (gChecks)</span>
<a href="#l7.432"></a><span id="l7.432" class="difflineplus">+      gChecks();</span>
<a href="#l7.433"></a><span id="l7.433" class="difflineplus">+    gCurTestNum++;</span>
<a href="#l7.434"></a><span id="l7.434" class="difflineplus">+    do_timeout(100, &quot;doTest();&quot;);</span>
<a href="#l7.435"></a><span id="l7.435" class="difflineplus">+  }</span>
<a href="#l7.436"></a><span id="l7.436" class="difflineplus">+}</span>
<a href="#l7.437"></a><span id="l7.437" class="difflineplus">+</span>
<a href="#l7.438"></a><span id="l7.438" class="difflineplus">+// basic preparation done for each test</span>
<a href="#l7.439"></a><span id="l7.439" class="difflineplus">+function setupTest(aFilter, aAction)</span>
<a href="#l7.440"></a><span id="l7.440" class="difflineplus">+{</span>
<a href="#l7.441"></a><span id="l7.441" class="difflineplus">+  if (aAction &amp;&amp;</span>
<a href="#l7.442"></a><span id="l7.442" class="difflineplus">+      ((aAction.type == Ci.nsMsgFilterAction.CopyToFolder) ||</span>
<a href="#l7.443"></a><span id="l7.443" class="difflineplus">+       (aAction.type == Ci.nsMsgFilterAction.MoveToFolder)))</span>
<a href="#l7.444"></a><span id="l7.444" class="difflineplus">+    gContinueListener = kDeleteOrMoveMsgCompleted;</span>
<a href="#l7.445"></a><span id="l7.445" class="difflineplus">+  else if (aFilter === gBodyFilter)</span>
<a href="#l7.446"></a><span id="l7.446" class="difflineplus">+    gContinueListener = kFiltersAppliedAtom;</span>
<a href="#l7.447"></a><span id="l7.447" class="difflineplus">+  else</span>
<a href="#l7.448"></a><span id="l7.448" class="difflineplus">+    gContinueListener = URLListener;</span>
<a href="#l7.449"></a><span id="l7.449" class="difflineplus">+  let filterList = gIMAPIncomingServer.getFilterList(null);</span>
<a href="#l7.450"></a><span id="l7.450" class="difflineplus">+  while (filterList.filterCount)</span>
<a href="#l7.451"></a><span id="l7.451" class="difflineplus">+    filterList.removeFilterAt(0);</span>
<a href="#l7.452"></a><span id="l7.452" class="difflineplus">+  if (aFilter)</span>
<a href="#l7.453"></a><span id="l7.453" class="difflineplus">+  {</span>
<a href="#l7.454"></a><span id="l7.454" class="difflineplus">+    aFilter.clearActionList();</span>
<a href="#l7.455"></a><span id="l7.455" class="difflineplus">+    if (aAction) {</span>
<a href="#l7.456"></a><span id="l7.456" class="difflineplus">+      aFilter.appendAction(aAction);</span>
<a href="#l7.457"></a><span id="l7.457" class="difflineplus">+      filterList.insertFilterAt(0, aFilter);</span>
<a href="#l7.458"></a><span id="l7.458" class="difflineplus">+    }</span>
<a href="#l7.459"></a><span id="l7.459" class="difflineplus">+  }</span>
<a href="#l7.460"></a><span id="l7.460" class="difflineplus">+  if (gInboxListener)</span>
<a href="#l7.461"></a><span id="l7.461" class="difflineplus">+  {</span>
<a href="#l7.462"></a><span id="l7.462" class="difflineplus">+    try {</span>
<a href="#l7.463"></a><span id="l7.463" class="difflineplus">+      gIMAPInbox.msgDatabase.RemoveListener(gInboxListener);</span>
<a href="#l7.464"></a><span id="l7.464" class="difflineplus">+    }</span>
<a href="#l7.465"></a><span id="l7.465" class="difflineplus">+    catch(e) {}</span>
<a href="#l7.466"></a><span id="l7.466" class="difflineplus">+    try {</span>
<a href="#l7.467"></a><span id="l7.467" class="difflineplus">+      gDbService.UnregisterPendingListener(gInboxListener);</span>
<a href="#l7.468"></a><span id="l7.468" class="difflineplus">+    }</span>
<a href="#l7.469"></a><span id="l7.469" class="difflineplus">+    catch(e) {}</span>
<a href="#l7.470"></a><span id="l7.470" class="difflineplus">+  }</span>
<a href="#l7.471"></a><span id="l7.471" class="difflineplus">+</span>
<a href="#l7.472"></a><span id="l7.472" class="difflineplus">+  gInboxListener = new DBListener();</span>
<a href="#l7.473"></a><span id="l7.473" class="difflineplus">+  gDbService.registerPendingListener(gIMAPInbox, gInboxListener);</span>
<a href="#l7.474"></a><span id="l7.474" class="difflineplus">+  gMoveCallbackCount = 0;</span>
<a href="#l7.475"></a><span id="l7.475" class="difflineplus">+  gIMAPMailbox.addMessage(new imapMessage(specForFileName(gMessage),</span>
<a href="#l7.476"></a><span id="l7.476" class="difflineplus">+                          gIMAPMailbox.uidnext++, []));</span>
<a href="#l7.477"></a><span id="l7.477" class="difflineplus">+  gIMAPInbox.updateFolderWithListener(null, URLListener);</span>
<a href="#l7.478"></a><span id="l7.478" class="difflineplus">+}</span>
<a href="#l7.479"></a><span id="l7.479" class="difflineplus">+</span>
<a href="#l7.480"></a><span id="l7.480" class="difflineplus">+// run the next test</span>
<a href="#l7.481"></a><span id="l7.481" class="difflineplus">+function doTest()</span>
<a href="#l7.482"></a><span id="l7.482" class="difflineplus">+{</span>
<a href="#l7.483"></a><span id="l7.483" class="difflineplus">+  test = gCurTestNum;</span>
<a href="#l7.484"></a><span id="l7.484" class="difflineplus">+  if (test &lt;= gTestArray.length)</span>
<a href="#l7.485"></a><span id="l7.485" class="difflineplus">+  {</span>
<a href="#l7.486"></a><span id="l7.486" class="difflineplus">+</span>
<a href="#l7.487"></a><span id="l7.487" class="difflineplus">+    var testFn = gTestArray[test-1];</span>
<a href="#l7.488"></a><span id="l7.488" class="difflineplus">+    dump(&quot;Doing test &quot; + test + &quot; &quot; + testFn.name + &quot;\n&quot;);</span>
<a href="#l7.489"></a><span id="l7.489" class="difflineplus">+    // Set a limit of ten seconds; if the notifications haven't arrived by then there's a problem.</span>
<a href="#l7.490"></a><span id="l7.490" class="difflineplus">+    do_timeout(10000, &quot;if (gCurTestNum == &quot;+test+&quot;) \</span>
<a href="#l7.491"></a><span id="l7.491" class="difflineplus">+      do_throw('Notifications not received in 10000 ms for operation &quot;+testFn.name+&quot;, current status is '+gCurrStatus);&quot;);</span>
<a href="#l7.492"></a><span id="l7.492" class="difflineplus">+    try {</span>
<a href="#l7.493"></a><span id="l7.493" class="difflineplus">+    testFn();</span>
<a href="#l7.494"></a><span id="l7.494" class="difflineplus">+    } catch(ex) {</span>
<a href="#l7.495"></a><span id="l7.495" class="difflineplus">+      gServer.stop();</span>
<a href="#l7.496"></a><span id="l7.496" class="difflineplus">+      do_throw ('TEST FAILED ' + e);</span>
<a href="#l7.497"></a><span id="l7.497" class="difflineplus">+    }</span>
<a href="#l7.498"></a><span id="l7.498" class="difflineplus">+  }</span>
<a href="#l7.499"></a><span id="l7.499" class="difflineplus">+  else</span>
<a href="#l7.500"></a><span id="l7.500" class="difflineplus">+    do_timeout(1000, &quot;endTest();&quot;);</span>
<a href="#l7.501"></a><span id="l7.501" class="difflineplus">+}</span>
<a href="#l7.502"></a><span id="l7.502" class="difflineplus">+</span>
<a href="#l7.503"></a><span id="l7.503" class="difflineplus">+// Cleanup, null out everything, close all cached connections and stop the</span>
<a href="#l7.504"></a><span id="l7.504" class="difflineplus">+// server</span>
<a href="#l7.505"></a><span id="l7.505" class="difflineplus">+function endTest()</span>
<a href="#l7.506"></a><span id="l7.506" class="difflineplus">+{</span>
<a href="#l7.507"></a><span id="l7.507" class="difflineplus">+  dump(&quot; Exiting mail tests\n&quot;);</span>
<a href="#l7.508"></a><span id="l7.508" class="difflineplus">+  if (gInboxListener)</span>
<a href="#l7.509"></a><span id="l7.509" class="difflineplus">+  {</span>
<a href="#l7.510"></a><span id="l7.510" class="difflineplus">+    try {</span>
<a href="#l7.511"></a><span id="l7.511" class="difflineplus">+      gIMAPInbox.msgDatabase.RemoveListener(gInboxListener);</span>
<a href="#l7.512"></a><span id="l7.512" class="difflineplus">+    }</span>
<a href="#l7.513"></a><span id="l7.513" class="difflineplus">+    catch(e) {}</span>
<a href="#l7.514"></a><span id="l7.514" class="difflineplus">+    try {</span>
<a href="#l7.515"></a><span id="l7.515" class="difflineplus">+      gDbService.UnregisterPendingListener(gInboxListener);</span>
<a href="#l7.516"></a><span id="l7.516" class="difflineplus">+    }</span>
<a href="#l7.517"></a><span id="l7.517" class="difflineplus">+    catch(e) {}</span>
<a href="#l7.518"></a><span id="l7.518" class="difflineplus">+  }</span>
<a href="#l7.519"></a><span id="l7.519" class="difflineplus">+  gRootFolder = null;</span>
<a href="#l7.520"></a><span id="l7.520" class="difflineplus">+  gIMAPInbox = null;</span>
<a href="#l7.521"></a><span id="l7.521" class="difflineplus">+  gIMAPTrashFolder = null;</span>
<a href="#l7.522"></a><span id="l7.522" class="difflineplus">+  gSubfolder = null;</span>
<a href="#l7.523"></a><span id="l7.523" class="difflineplus">+  gServer.resetTest();</span>
<a href="#l7.524"></a><span id="l7.524" class="difflineplus">+  gIMAPIncomingServer.closeCachedConnections();</span>
<a href="#l7.525"></a><span id="l7.525" class="difflineplus">+  gServer.performTest();</span>
<a href="#l7.526"></a><span id="l7.526" class="difflineplus">+  gServer.stop();</span>
<a href="#l7.527"></a><span id="l7.527" class="difflineplus">+  let thread = gThreadManager.currentThread;</span>
<a href="#l7.528"></a><span id="l7.528" class="difflineplus">+  while (thread.hasPendingEvents())</span>
<a href="#l7.529"></a><span id="l7.529" class="difflineplus">+    thread.processNextEvent(true);</span>
<a href="#l7.530"></a><span id="l7.530" class="difflineplus">+</span>
<a href="#l7.531"></a><span id="l7.531" class="difflineplus">+  do_test_finished(); // for the one in run_test()</span>
<a href="#l7.532"></a><span id="l7.532" class="difflineplus">+}</span>
<a href="#l7.533"></a><span id="l7.533" class="difflineplus">+</span>
<a href="#l7.534"></a><span id="l7.534" class="difflineplus">+/*</span>
<a href="#l7.535"></a><span id="l7.535" class="difflineplus">+ * listener objects</span>
<a href="#l7.536"></a><span id="l7.536" class="difflineplus">+ */</span>
<a href="#l7.537"></a><span id="l7.537" class="difflineplus">+</span>
<a href="#l7.538"></a><span id="l7.538" class="difflineplus">+// nsIFolderListener implementation</span>
<a href="#l7.539"></a><span id="l7.539" class="difflineplus">+var FolderListener = {</span>
<a href="#l7.540"></a><span id="l7.540" class="difflineplus">+  OnItemEvent: function OnItemEvent(aEventFolder, aEvent) {</span>
<a href="#l7.541"></a><span id="l7.541" class="difflineplus">+    dump(&quot;received folder event &quot; + aEvent.toString() +</span>
<a href="#l7.542"></a><span id="l7.542" class="difflineplus">+         &quot; folder &quot; + aEventFolder.name +</span>
<a href="#l7.543"></a><span id="l7.543" class="difflineplus">+         &quot;\n&quot;);</span>
<a href="#l7.544"></a><span id="l7.544" class="difflineplus">+    testContinue(aEvent);</span>
<a href="#l7.545"></a><span id="l7.545" class="difflineplus">+  }</span>
<a href="#l7.546"></a><span id="l7.546" class="difflineplus">+};</span>
<a href="#l7.547"></a><span id="l7.547" class="difflineplus">+</span>
<a href="#l7.548"></a><span id="l7.548" class="difflineplus">+// nsIMsgCopyServiceListener implementation - runs next test when copy</span>
<a href="#l7.549"></a><span id="l7.549" class="difflineplus">+// is completed.</span>
<a href="#l7.550"></a><span id="l7.550" class="difflineplus">+var CopyListener =</span>
<a href="#l7.551"></a><span id="l7.551" class="difflineplus">+{</span>
<a href="#l7.552"></a><span id="l7.552" class="difflineplus">+  OnStartCopy: function OnStartCopy() {},</span>
<a href="#l7.553"></a><span id="l7.553" class="difflineplus">+  OnProgress: function OnProgress(aProgress, aProgressMax) {},</span>
<a href="#l7.554"></a><span id="l7.554" class="difflineplus">+  SetMessageKey: function SetMessageKey(aKey)</span>
<a href="#l7.555"></a><span id="l7.555" class="difflineplus">+  {</span>
<a href="#l7.556"></a><span id="l7.556" class="difflineplus">+    gLastKey = aKey;</span>
<a href="#l7.557"></a><span id="l7.557" class="difflineplus">+  },</span>
<a href="#l7.558"></a><span id="l7.558" class="difflineplus">+  SetMessageId: function SetMessageId(aMessageId) {},</span>
<a href="#l7.559"></a><span id="l7.559" class="difflineplus">+  OnStopCopy: function OnStopCopy(aStatus)</span>
<a href="#l7.560"></a><span id="l7.560" class="difflineplus">+  {</span>
<a href="#l7.561"></a><span id="l7.561" class="difflineplus">+    dump(&quot;in OnStopCopy &quot; + gCurTestNum + &quot;\n&quot;);</span>
<a href="#l7.562"></a><span id="l7.562" class="difflineplus">+    // Check: message successfully copied.</span>
<a href="#l7.563"></a><span id="l7.563" class="difflineplus">+    do_check_eq(aStatus, 0);</span>
<a href="#l7.564"></a><span id="l7.564" class="difflineplus">+    // Ugly hack: make sure we don't get stuck in a JS-&gt;C++-&gt;JS-&gt;C++... call stack</span>
<a href="#l7.565"></a><span id="l7.565" class="difflineplus">+    // This can happen with a bunch of synchronous functions grouped together, and</span>
<a href="#l7.566"></a><span id="l7.566" class="difflineplus">+    // can even cause tests to fail because they're still waiting for the listener</span>
<a href="#l7.567"></a><span id="l7.567" class="difflineplus">+    // to return</span>
<a href="#l7.568"></a><span id="l7.568" class="difflineplus">+    testContinue(this);</span>
<a href="#l7.569"></a><span id="l7.569" class="difflineplus">+  }</span>
<a href="#l7.570"></a><span id="l7.570" class="difflineplus">+};</span>
<a href="#l7.571"></a><span id="l7.571" class="difflineplus">+</span>
<a href="#l7.572"></a><span id="l7.572" class="difflineplus">+// nsIURLListener implementation - runs next test</span>
<a href="#l7.573"></a><span id="l7.573" class="difflineplus">+var URLListener =</span>
<a href="#l7.574"></a><span id="l7.574" class="difflineplus">+{</span>
<a href="#l7.575"></a><span id="l7.575" class="difflineplus">+  OnStartRunningUrl: function OnStartRunningUrl(aURL) {},</span>
<a href="#l7.576"></a><span id="l7.576" class="difflineplus">+  OnStopRunningUrl: function OnStopRunningUrl(aURL, aStatus)</span>
<a href="#l7.577"></a><span id="l7.577" class="difflineplus">+  {</span>
<a href="#l7.578"></a><span id="l7.578" class="difflineplus">+    dump(&quot;in OnStopRunningURL &quot; + gCurTestNum + &quot;\n&quot;);</span>
<a href="#l7.579"></a><span id="l7.579" class="difflineplus">+    do_check_eq(aStatus, 0);</span>
<a href="#l7.580"></a><span id="l7.580" class="difflineplus">+    testContinue(this);</span>
<a href="#l7.581"></a><span id="l7.581" class="difflineplus">+  }</span>
<a href="#l7.582"></a><span id="l7.582" class="difflineplus">+}</span>
<a href="#l7.583"></a><span id="l7.583" class="difflineplus">+</span>
<a href="#l7.584"></a><span id="l7.584" class="difflineplus">+// nsIDBChangeListener implementation. Counts of calls are kept, but not</span>
<a href="#l7.585"></a><span id="l7.585" class="difflineplus">+// currently used in the tests. Current role is to provide a reference</span>
<a href="#l7.586"></a><span id="l7.586" class="difflineplus">+// to the new message header (plus give some examples of using db listeners</span>
<a href="#l7.587"></a><span id="l7.587" class="difflineplus">+// in javascript).</span>
<a href="#l7.588"></a><span id="l7.588" class="difflineplus">+function DBListener()</span>
<a href="#l7.589"></a><span id="l7.589" class="difflineplus">+{</span>
<a href="#l7.590"></a><span id="l7.590" class="difflineplus">+  this.counts = {};</span>
<a href="#l7.591"></a><span id="l7.591" class="difflineplus">+  counts = this.counts;</span>
<a href="#l7.592"></a><span id="l7.592" class="difflineplus">+  counts.onHdrFlagsChanged = 0;</span>
<a href="#l7.593"></a><span id="l7.593" class="difflineplus">+  counts.onHdrDeleted = 0;</span>
<a href="#l7.594"></a><span id="l7.594" class="difflineplus">+  counts.onHdrAdded = 0;</span>
<a href="#l7.595"></a><span id="l7.595" class="difflineplus">+  counts.onParentChanged = 0;</span>
<a href="#l7.596"></a><span id="l7.596" class="difflineplus">+  counts.onAnnouncerGoingAway = 0;</span>
<a href="#l7.597"></a><span id="l7.597" class="difflineplus">+  counts.onReadChanged = 0;</span>
<a href="#l7.598"></a><span id="l7.598" class="difflineplus">+  counts.onJunkScoreChanged = 0;</span>
<a href="#l7.599"></a><span id="l7.599" class="difflineplus">+  counts.onHdrPropertyChanged = 0;</span>
<a href="#l7.600"></a><span id="l7.600" class="difflineplus">+  counts.onEvent = 0;</span>
<a href="#l7.601"></a><span id="l7.601" class="difflineplus">+}</span>
<a href="#l7.602"></a><span id="l7.602" class="difflineplus">+</span>
<a href="#l7.603"></a><span id="l7.603" class="difflineplus">+DBListener.prototype =</span>
<a href="#l7.604"></a><span id="l7.604" class="difflineplus">+{</span>
<a href="#l7.605"></a><span id="l7.605" class="difflineplus">+  onHdrFlagsChanged:</span>
<a href="#l7.606"></a><span id="l7.606" class="difflineplus">+    function onHdrFlagsChanged(aHdrChanged, aOldFlags, aNewFlags, aInstigator)</span>
<a href="#l7.607"></a><span id="l7.607" class="difflineplus">+    {</span>
<a href="#l7.608"></a><span id="l7.608" class="difflineplus">+      this.counts.onHdrFlagsChanged++;</span>
<a href="#l7.609"></a><span id="l7.609" class="difflineplus">+    },</span>
<a href="#l7.610"></a><span id="l7.610" class="difflineplus">+</span>
<a href="#l7.611"></a><span id="l7.611" class="difflineplus">+  onHdrDeleted:</span>
<a href="#l7.612"></a><span id="l7.612" class="difflineplus">+    function onHdrDeleted(aHdrChanged, aParentKey, Flags, aInstigator)</span>
<a href="#l7.613"></a><span id="l7.613" class="difflineplus">+    {</span>
<a href="#l7.614"></a><span id="l7.614" class="difflineplus">+      this.counts.onHdrDeleted++;</span>
<a href="#l7.615"></a><span id="l7.615" class="difflineplus">+    },</span>
<a href="#l7.616"></a><span id="l7.616" class="difflineplus">+</span>
<a href="#l7.617"></a><span id="l7.617" class="difflineplus">+  onHdrAdded:</span>
<a href="#l7.618"></a><span id="l7.618" class="difflineplus">+    function onHdrAdded(aHdrChanged, aParentKey, aFlags, aInstigator)</span>
<a href="#l7.619"></a><span id="l7.619" class="difflineplus">+    {</span>
<a href="#l7.620"></a><span id="l7.620" class="difflineplus">+      this.counts.onHdrAdded++;</span>
<a href="#l7.621"></a><span id="l7.621" class="difflineplus">+      gHeader = aHdrChanged;</span>
<a href="#l7.622"></a><span id="l7.622" class="difflineplus">+    },</span>
<a href="#l7.623"></a><span id="l7.623" class="difflineplus">+</span>
<a href="#l7.624"></a><span id="l7.624" class="difflineplus">+  onParentChanged:</span>
<a href="#l7.625"></a><span id="l7.625" class="difflineplus">+    function onParentChanged(aKeyChanged, oldParent, newParent, aInstigator)</span>
<a href="#l7.626"></a><span id="l7.626" class="difflineplus">+    {</span>
<a href="#l7.627"></a><span id="l7.627" class="difflineplus">+      this.counts.onParentChanged++;</span>
<a href="#l7.628"></a><span id="l7.628" class="difflineplus">+    },</span>
<a href="#l7.629"></a><span id="l7.629" class="difflineplus">+    </span>
<a href="#l7.630"></a><span id="l7.630" class="difflineplus">+  onAnnouncerGoingAway:</span>
<a href="#l7.631"></a><span id="l7.631" class="difflineplus">+    function onAnnouncerGoingAway(instigator)</span>
<a href="#l7.632"></a><span id="l7.632" class="difflineplus">+    {</span>
<a href="#l7.633"></a><span id="l7.633" class="difflineplus">+      if (gInboxListener)</span>
<a href="#l7.634"></a><span id="l7.634" class="difflineplus">+        try {</span>
<a href="#l7.635"></a><span id="l7.635" class="difflineplus">+          gIMAPInbox.msgDatabase.RemoveListener(gInboxListener);</span>
<a href="#l7.636"></a><span id="l7.636" class="difflineplus">+        }</span>
<a href="#l7.637"></a><span id="l7.637" class="difflineplus">+        catch (e) {dump(&quot; listener not found\n&quot;);}</span>
<a href="#l7.638"></a><span id="l7.638" class="difflineplus">+      this.counts.onAnnouncerGoingAway++;</span>
<a href="#l7.639"></a><span id="l7.639" class="difflineplus">+    },</span>
<a href="#l7.640"></a><span id="l7.640" class="difflineplus">+    </span>
<a href="#l7.641"></a><span id="l7.641" class="difflineplus">+  onReadChanged:</span>
<a href="#l7.642"></a><span id="l7.642" class="difflineplus">+    function onReadChanged(aInstigator)</span>
<a href="#l7.643"></a><span id="l7.643" class="difflineplus">+    {</span>
<a href="#l7.644"></a><span id="l7.644" class="difflineplus">+      this.counts.onReadChanged++;</span>
<a href="#l7.645"></a><span id="l7.645" class="difflineplus">+    },</span>
<a href="#l7.646"></a><span id="l7.646" class="difflineplus">+    </span>
<a href="#l7.647"></a><span id="l7.647" class="difflineplus">+  onJunkScoreChanged:</span>
<a href="#l7.648"></a><span id="l7.648" class="difflineplus">+    function onJunkScoreChanged(aInstigator)</span>
<a href="#l7.649"></a><span id="l7.649" class="difflineplus">+    {</span>
<a href="#l7.650"></a><span id="l7.650" class="difflineplus">+      this.counts.onJunkScoreChanged++;</span>
<a href="#l7.651"></a><span id="l7.651" class="difflineplus">+    },</span>
<a href="#l7.652"></a><span id="l7.652" class="difflineplus">+    </span>
<a href="#l7.653"></a><span id="l7.653" class="difflineplus">+  onHdrPropertyChanged:</span>
<a href="#l7.654"></a><span id="l7.654" class="difflineplus">+    function onHdrPropertyChanged(aHdrToChange, aPreChange, aStatus, aInstigator)</span>
<a href="#l7.655"></a><span id="l7.655" class="difflineplus">+    {</span>
<a href="#l7.656"></a><span id="l7.656" class="difflineplus">+      this.counts.onHdrPropertyChanged++;</span>
<a href="#l7.657"></a><span id="l7.657" class="difflineplus">+    },</span>
<a href="#l7.658"></a><span id="l7.658" class="difflineplus">+    </span>
<a href="#l7.659"></a><span id="l7.659" class="difflineplus">+  onEvent:</span>
<a href="#l7.660"></a><span id="l7.660" class="difflineplus">+    function onEvent(aDB, aEvent)</span>
<a href="#l7.661"></a><span id="l7.661" class="difflineplus">+    {</span>
<a href="#l7.662"></a><span id="l7.662" class="difflineplus">+      this.counts.onEvent++;</span>
<a href="#l7.663"></a><span id="l7.663" class="difflineplus">+    },</span>
<a href="#l7.664"></a><span id="l7.664" class="difflineplus">+</span>
<a href="#l7.665"></a><span id="l7.665" class="difflineplus">+};</span>
<a href="#l7.666"></a><span id="l7.666" class="difflineplus">+</span>
<a href="#l7.667"></a><span id="l7.667" class="difflineplus">+/*</span>
<a href="#l7.668"></a><span id="l7.668" class="difflineplus">+ * helper functions</span>
<a href="#l7.669"></a><span id="l7.669" class="difflineplus">+ */</span>
<a href="#l7.670"></a><span id="l7.670" class="difflineplus">+</span>
<a href="#l7.671"></a><span id="l7.671" class="difflineplus">+// return the number of messages in a folder (and check that the</span>
<a href="#l7.672"></a><span id="l7.672" class="difflineplus">+// folder counts match the database counts)</span>
<a href="#l7.673"></a><span id="l7.673" class="difflineplus">+function folderCount(folder)</span>
<a href="#l7.674"></a><span id="l7.674" class="difflineplus">+{</span>
<a href="#l7.675"></a><span id="l7.675" class="difflineplus">+  // count using the database</span>
<a href="#l7.676"></a><span id="l7.676" class="difflineplus">+  let enumerator = folder.msgDatabase.EnumerateMessages();</span>
<a href="#l7.677"></a><span id="l7.677" class="difflineplus">+  let dbCount = 0;</span>
<a href="#l7.678"></a><span id="l7.678" class="difflineplus">+  while (enumerator.hasMoreElements())</span>
<a href="#l7.679"></a><span id="l7.679" class="difflineplus">+  {</span>
<a href="#l7.680"></a><span id="l7.680" class="difflineplus">+    dbCount++;</span>
<a href="#l7.681"></a><span id="l7.681" class="difflineplus">+    let hdr = enumerator.getNext();</span>
<a href="#l7.682"></a><span id="l7.682" class="difflineplus">+  }</span>
<a href="#l7.683"></a><span id="l7.683" class="difflineplus">+</span>
<a href="#l7.684"></a><span id="l7.684" class="difflineplus">+  // count using the folder</span>
<a href="#l7.685"></a><span id="l7.685" class="difflineplus">+  let folderCount = folder.getTotalMessages(false);</span>
<a href="#l7.686"></a><span id="l7.686" class="difflineplus">+</span>
<a href="#l7.687"></a><span id="l7.687" class="difflineplus">+  // compare the two</span>
<a href="#l7.688"></a><span id="l7.688" class="difflineplus">+  do_check_eq(dbCount, folderCount);</span>
<a href="#l7.689"></a><span id="l7.689" class="difflineplus">+  return dbCount;</span>
<a href="#l7.690"></a><span id="l7.690" class="difflineplus">+}</span>
<a href="#l7.691"></a><span id="l7.691" class="difflineplus">+</span>
<a href="#l7.692"></a><span id="l7.692" class="difflineplus">+// list all of the messages in a folder for debug</span>
<a href="#l7.693"></a><span id="l7.693" class="difflineplus">+function listMessages(folder) {</span>
<a href="#l7.694"></a><span id="l7.694" class="difflineplus">+  let enumerator = folder.msgDatabase.EnumerateMessages();</span>
<a href="#l7.695"></a><span id="l7.695" class="difflineplus">+  var msgCount = 0;</span>
<a href="#l7.696"></a><span id="l7.696" class="difflineplus">+  dump(&quot;listing messages for &quot; + folder.prettyName + &quot;\n&quot;);</span>
<a href="#l7.697"></a><span id="l7.697" class="difflineplus">+  while(enumerator.hasMoreElements())</span>
<a href="#l7.698"></a><span id="l7.698" class="difflineplus">+  {</span>
<a href="#l7.699"></a><span id="l7.699" class="difflineplus">+    msgCount++;</span>
<a href="#l7.700"></a><span id="l7.700" class="difflineplus">+    let hdr = enumerator.getNext().QueryInterface(Ci.nsIMsgDBHdr);</span>
<a href="#l7.701"></a><span id="l7.701" class="difflineplus">+    dump(msgCount + &quot;: &quot; + hdr.subject + &quot;\n&quot;);</span>
<a href="#l7.702"></a><span id="l7.702" class="difflineplus">+  }</span>
<a href="#l7.703"></a><span id="l7.703" class="difflineplus">+}</span>
<a href="#l7.704"></a><span id="l7.704" class="difflineplus">+</span>
<a href="#l7.705"></a><span id="l7.705" class="difflineplus">+// given a test file, return the file uri spec</span>
<a href="#l7.706"></a><span id="l7.706" class="difflineplus">+function specForFileName(aFileName)</span>
<a href="#l7.707"></a><span id="l7.707" class="difflineplus">+{</span>
<a href="#l7.708"></a><span id="l7.708" class="difflineplus">+  let file = do_get_file(&quot;../../mailnews/data/&quot; + aFileName);</span>
<a href="#l7.709"></a><span id="l7.709" class="difflineplus">+  let msgfileuri = Cc[&quot;@mozilla.org/network/io-service;1&quot;]</span>
<a href="#l7.710"></a><span id="l7.710" class="difflineplus">+                     .getService(Ci.nsIIOService)</span>
<a href="#l7.711"></a><span id="l7.711" class="difflineplus">+                     .newFileURI(file)</span>
<a href="#l7.712"></a><span id="l7.712" class="difflineplus">+                     .QueryInterface(Ci.nsIFileURL);</span>
<a href="#l7.713"></a><span id="l7.713" class="difflineplus">+  return msgfileuri.spec;</span>
<a href="#l7.714"></a><span id="l7.714" class="difflineplus">+}</span>
<a href="#l7.715"></a><span id="l7.715" class="difflineplus">+</span>
<a href="#l7.716"></a><span id="l7.716" class="difflineplus">+// shorthand for the inbox message summary database</span>
<a href="#l7.717"></a><span id="l7.717" class="difflineplus">+function db()</span>
<a href="#l7.718"></a><span id="l7.718" class="difflineplus">+{</span>
<a href="#l7.719"></a><span id="l7.719" class="difflineplus">+  return gIMAPInbox.msgDatabase;</span>
<a href="#l7.720"></a><span id="l7.720" class="difflineplus">+}</span>
<a href="#l7.721"></a><span id="l7.721" class="difflineplus">+</span>
<a href="#l7.722"></a><span id="l7.722" class="difflineplus">+// This function may be used in the test array to show</span>
<a href="#l7.723"></a><span id="l7.723" class="difflineplus">+// more detailed results after a particular test.</span>
<a href="#l7.724"></a><span id="l7.724" class="difflineplus">+function showResults() {</span>
<a href="#l7.725"></a><span id="l7.725" class="difflineplus">+  listMessages(gIMAPInbox);</span>
<a href="#l7.726"></a><span id="l7.726" class="difflineplus">+  if (gInboxListener)</span>
<a href="#l7.727"></a><span id="l7.727" class="difflineplus">+    printListener(gInboxListener);</span>
<a href="#l7.728"></a><span id="l7.728" class="difflineplus">+  gCurTestNum++;</span>
<a href="#l7.729"></a><span id="l7.729" class="difflineplus">+  do_timeout(100, &quot;doTest();&quot;);</span>
<a href="#l7.730"></a><span id="l7.730" class="difflineplus">+}</span>
<a href="#l7.731"></a><span id="l7.731" class="difflineplus">+</span>
<a href="#l7.732"></a><span id="l7.732" class="difflineplus">+// static variables used in testCounts</span>
<a href="#l7.733"></a><span id="l7.733" class="difflineplus">+var gPreviousUnread = 0;</span>
<a href="#l7.734"></a><span id="l7.734" class="difflineplus">+var gPreviousDbNew = 0;</span>
<a href="#l7.735"></a><span id="l7.735" class="difflineplus">+</span>
<a href="#l7.736"></a><span id="l7.736" class="difflineplus">+// Test various counts.</span>
<a href="#l7.737"></a><span id="l7.737" class="difflineplus">+//</span>
<a href="#l7.738"></a><span id="l7.738" class="difflineplus">+//  aHasNew:         folder hasNew flag</span>
<a href="#l7.739"></a><span id="l7.739" class="difflineplus">+//  aUnreadDelta:    change in unread count for the folder</span>
<a href="#l7.740"></a><span id="l7.740" class="difflineplus">+//  aFolderNewDelta: change in new count for the folder</span>
<a href="#l7.741"></a><span id="l7.741" class="difflineplus">+//  aDbNewDelta:     change in new count for the database</span>
<a href="#l7.742"></a><span id="l7.742" class="difflineplus">+//</span>
<a href="#l7.743"></a><span id="l7.743" class="difflineplus">+function testCounts(aHasNew, aUnreadDelta, aFolderNewDelta, aDbNewDelta)</span>
<a href="#l7.744"></a><span id="l7.744" class="difflineplus">+{</span>
<a href="#l7.745"></a><span id="l7.745" class="difflineplus">+  try {</span>
<a href="#l7.746"></a><span id="l7.746" class="difflineplus">+  let folderNew = gIMAPInbox.getNumNewMessages(false);</span>
<a href="#l7.747"></a><span id="l7.747" class="difflineplus">+  let hasNew = gIMAPInbox.hasNewMessages;</span>
<a href="#l7.748"></a><span id="l7.748" class="difflineplus">+  let unread = gIMAPInbox.getNumUnread(false);</span>
<a href="#l7.749"></a><span id="l7.749" class="difflineplus">+  let countOut = {};</span>
<a href="#l7.750"></a><span id="l7.750" class="difflineplus">+  let arrayOut = {};</span>
<a href="#l7.751"></a><span id="l7.751" class="difflineplus">+  db().getNewList(countOut, arrayOut);</span>
<a href="#l7.752"></a><span id="l7.752" class="difflineplus">+  let dbNew = countOut.value ? countOut.value : 0;</span>
<a href="#l7.753"></a><span id="l7.753" class="difflineplus">+  let folderNewFlag = gIMAPInbox.getFlag(Ci.nsMsgFolderFlags.GotNew);</span>
<a href="#l7.754"></a><span id="l7.754" class="difflineplus">+  dump(&quot; hasNew: &quot; + hasNew +</span>
<a href="#l7.755"></a><span id="l7.755" class="difflineplus">+       &quot; unread: &quot; + unread +</span>
<a href="#l7.756"></a><span id="l7.756" class="difflineplus">+       &quot; folderNew: &quot; + folderNew +</span>
<a href="#l7.757"></a><span id="l7.757" class="difflineplus">+       &quot; folderNewFlag: &quot; + folderNewFlag +</span>
<a href="#l7.758"></a><span id="l7.758" class="difflineplus">+       &quot; dbNew: &quot; + dbNew +</span>
<a href="#l7.759"></a><span id="l7.759" class="difflineplus">+       &quot;\n&quot;);</span>
<a href="#l7.760"></a><span id="l7.760" class="difflineplus">+  do_check_eq(aHasNew, hasNew);</span>
<a href="#l7.761"></a><span id="l7.761" class="difflineplus">+  do_check_eq(aUnreadDelta, unread - gPreviousUnread);</span>
<a href="#l7.762"></a><span id="l7.762" class="difflineplus">+  gPreviousUnread = unread;</span>
<a href="#l7.763"></a><span id="l7.763" class="difflineplus">+  // this seems to be rest for each folder update</span>
<a href="#l7.764"></a><span id="l7.764" class="difflineplus">+  do_check_eq(aFolderNewDelta, folderNew);</span>
<a href="#l7.765"></a><span id="l7.765" class="difflineplus">+  do_check_eq(aDbNewDelta, dbNew - gPreviousDbNew);</span>
<a href="#l7.766"></a><span id="l7.766" class="difflineplus">+  gPreviousDbNew = dbNew;</span>
<a href="#l7.767"></a><span id="l7.767" class="difflineplus">+  } catch (e) {dump(e);}</span>
<a href="#l7.768"></a><span id="l7.768" class="difflineplus">+}</span>
<a href="#l7.769"></a><span id="l7.769" class="difflineplus">+</span>
<a href="#l7.770"></a><span id="l7.770" class="difflineplus">+// print the counts for debugging purposes in this test</span>
<a href="#l7.771"></a><span id="l7.771" class="difflineplus">+function printListener(listener)</span>
<a href="#l7.772"></a><span id="l7.772" class="difflineplus">+{</span>
<a href="#l7.773"></a><span id="l7.773" class="difflineplus">+  print(&quot;DBListener counts: &quot;);</span>
<a href="#l7.774"></a><span id="l7.774" class="difflineplus">+  for (var item in listener.counts) {</span>
<a href="#l7.775"></a><span id="l7.775" class="difflineplus">+      dump(item + &quot;: &quot; + listener.counts[item] + &quot; &quot;);</span>
<a href="#l7.776"></a><span id="l7.776" class="difflineplus">+  }</span>
<a href="#l7.777"></a><span id="l7.777" class="difflineplus">+  dump(&quot;\n&quot;);</span>
<a href="#l7.778"></a><span id="l7.778" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/local/src/nsLocalMailFolder.cpp</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/local/src/nsLocalMailFolder.cpp</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -2752,22 +2752,27 @@ NS_IMETHODIMP nsMsgLocalMailFolder::EndC</span>
<a href="#l8.4"></a><span id="l8.4"> </span>
<a href="#l8.5"></a><span id="l8.5">         if (mCopyState-&gt;m_msgWindow &amp;&amp; mCopyState-&gt;m_undoMsgTxn)</span>
<a href="#l8.6"></a><span id="l8.6">         {</span>
<a href="#l8.7"></a><span id="l8.7">           nsCOMPtr&lt;nsITransactionManager&gt; txnMgr;</span>
<a href="#l8.8"></a><span id="l8.8">           mCopyState-&gt;m_msgWindow-&gt;GetTransactionManager(getter_AddRefs(txnMgr));</span>
<a href="#l8.9"></a><span id="l8.9">           if (txnMgr)</span>
<a href="#l8.10"></a><span id="l8.10">             txnMgr-&gt;DoTransaction(mCopyState-&gt;m_undoMsgTxn);</span>
<a href="#l8.11"></a><span id="l8.11">         }</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-        if (srcFolder &amp;&amp; !mCopyState-&gt;m_isFolder)</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineminus">-          srcFolder-&gt;NotifyFolderEvent(mDeleteOrMoveMsgCompletedAtom);</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineminus">-</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineminus">-        (void) OnCopyCompleted(mCopyState-&gt;m_srcSupport, PR_TRUE);</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineplus">+</span>
<a href="#l8.17"></a><span id="l8.17">         // enable the dest folder</span>
<a href="#l8.18"></a><span id="l8.18">         EnableNotifications(allMessageCountNotifications, PR_TRUE, PR_FALSE /*dbBatching*/); //dest folder doesn't need db batching</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineplus">+        if (srcFolder &amp;&amp; !mCopyState-&gt;m_isFolder)</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineplus">+        {</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineplus">+          // I'm not too sure of the proper location of this event. It seems to need to be</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineplus">+          // after the EnableNotifications, or the folder counts can be incorrect</span>
<a href="#l8.23"></a><span id="l8.23" class="difflineplus">+          // during the mDeleteOrMoveMsgCompletedAtom call.</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineplus">+          srcFolder-&gt;NotifyFolderEvent(mDeleteOrMoveMsgCompletedAtom);</span>
<a href="#l8.25"></a><span id="l8.25" class="difflineplus">+        }</span>
<a href="#l8.26"></a><span id="l8.26" class="difflineplus">+        (void) OnCopyCompleted(mCopyState-&gt;m_srcSupport, PR_TRUE);</span>
<a href="#l8.27"></a><span id="l8.27">       }</span>
<a href="#l8.28"></a><span id="l8.28">     }</span>
<a href="#l8.29"></a><span id="l8.29">     // Send the itemAdded notification in case we didn't send the itemMoveCopyCompleted notification earlier.</span>
<a href="#l8.30"></a><span id="l8.30">     // Posting news messages involves this, yet doesn't have the newHdr initialized, so don't send any</span>
<a href="#l8.31"></a><span id="l8.31">     // notifications in that case.</span>
<a href="#l8.32"></a><span id="l8.32">     if (!numHdrs &amp;&amp; newHdr)</span>
<a href="#l8.33"></a><span id="l8.33">     {</span>
<a href="#l8.34"></a><span id="l8.34">       nsCOMPtr&lt;nsIMsgFolderNotificationService&gt; notifier(do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID));</span>
<a href="#l8.35"></a><span id="l8.35" class="difflineat">@@ -2834,21 +2839,24 @@ NS_IMETHODIMP nsMsgLocalMailFolder::EndM</span>
<a href="#l8.36"></a><span id="l8.36">         // we call DeleteMessages on the source folder. So don't mark it for deletion</span>
<a href="#l8.37"></a><span id="l8.37">         // here, in that case.</span>
<a href="#l8.38"></a><span id="l8.38">         if (!GetDeleteFromServerOnMove())</span>
<a href="#l8.39"></a><span id="l8.39">           localSrcFolder-&gt;MarkMsgsOnPop3Server(mCopyState-&gt;m_messages, POP3_DELETE);</span>
<a href="#l8.40"></a><span id="l8.40">       }</span>
<a href="#l8.41"></a><span id="l8.41">     }</span>
<a href="#l8.42"></a><span id="l8.42">     // lets delete these all at once - much faster that way</span>
<a href="#l8.43"></a><span id="l8.43">     rv = srcFolder-&gt;DeleteMessages(mCopyState-&gt;m_messages, mCopyState-&gt;m_msgWindow, PR_TRUE, PR_TRUE, nsnull, mCopyState-&gt;m_allowUndo);</span>
<a href="#l8.44"></a><span id="l8.44" class="difflineminus">-    srcFolder-&gt;NotifyFolderEvent(NS_SUCCEEDED(rv) ? mDeleteOrMoveMsgCompletedAtom : mDeleteOrMoveMsgFailedAtom);</span>
<a href="#l8.45"></a><span id="l8.45">     AutoCompact(mCopyState-&gt;m_msgWindow);</span>
<a href="#l8.46"></a><span id="l8.46"> </span>
<a href="#l8.47"></a><span id="l8.47">     // enable the dest folder</span>
<a href="#l8.48"></a><span id="l8.48">     EnableNotifications(allMessageCountNotifications, PR_TRUE, PR_FALSE /*dbBatching*/); //dest folder doesn't need db batching</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineplus">+    // I'm not too sure of the proper location of this event. It seems to need to be</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineplus">+    // after the EnableNotifications, or the folder counts can be incorrect</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineplus">+    // during the mDeleteOrMoveMsgCompletedAtom call.</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineplus">+    srcFolder-&gt;NotifyFolderEvent(NS_SUCCEEDED(rv) ? mDeleteOrMoveMsgCompletedAtom : mDeleteOrMoveMsgFailedAtom);</span>
<a href="#l8.53"></a><span id="l8.53"> </span>
<a href="#l8.54"></a><span id="l8.54">     if (NS_SUCCEEDED(rv) &amp;&amp; mCopyState-&gt;m_msgWindow &amp;&amp; mCopyState-&gt;m_undoMsgTxn)</span>
<a href="#l8.55"></a><span id="l8.55">     {</span>
<a href="#l8.56"></a><span id="l8.56">       nsCOMPtr&lt;nsITransactionManager&gt; txnMgr;</span>
<a href="#l8.57"></a><span id="l8.57">       mCopyState-&gt;m_msgWindow-&gt;GetTransactionManager(getter_AddRefs(txnMgr));</span>
<a href="#l8.58"></a><span id="l8.58">       if (txnMgr)</span>
<a href="#l8.59"></a><span id="l8.59">         txnMgr-&gt;DoTransaction(mCopyState-&gt;m_undoMsgTxn);</span>
<a href="#l8.60"></a><span id="l8.60">     }</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

