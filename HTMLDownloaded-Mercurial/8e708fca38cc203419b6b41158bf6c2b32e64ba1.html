<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 26633:8e708fca38cc203419b6b41158bf6c2b32e64ba1</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 8e708fca38cc203419b6b41158bf6c2b32e64ba1" />
<meta property="og:url" content="/comm-central/rev/8e708fca38cc203419b6b41158bf6c2b32e64ba1" />
<meta property="og:description" content="Bug 1546364 - Reformat to Google coding style in mailnews/base/src (part 2). rs=reformat" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 8e708fca38cc203419b6b41158bf6c2b32e64ba1 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/8e708fca38cc203419b6b41158bf6c2b32e64ba1">shortlog</a> |
<a href="/comm-central/log/8e708fca38cc203419b6b41158bf6c2b32e64ba1">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/8e708fca38cc203419b6b41158bf6c2b32e64ba1">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/8e708fca38cc203419b6b41158bf6c2b32e64ba1">files</a> |
changeset |
<a href="/comm-central/raw-rev/8e708fca38cc203419b6b41158bf6c2b32e64ba1">raw</a>  | <a href="/comm-central/archive/8e708fca38cc203419b6b41158bf6c2b32e64ba1.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1546364">Bug 1546364</a> - Reformat to Google coding style in mailnews/base/src (part 2). rs=reformat
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#74;&#111;&#114;&#103;&#32;&#75;&#32;&#60;&#106;&#111;&#114;&#103;&#107;&#64;&#106;&#111;&#114;&#103;&#107;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Thu, 16 May 2019 13:01:43 +0200</td></tr>

<tr>
 <td>changeset 26633</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/8e708fca38cc203419b6b41158bf6c2b32e64ba1">8e708fca38cc203419b6b41158bf6c2b32e64ba1</a></td>
</tr>



<tr>
<td>parent 26632</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/7e3a1808d30d74cd63009b3a518d417566dd206d">7e3a1808d30d74cd63009b3a518d417566dd206d</a>
</td>
</tr>

<tr>
<td>child 26634</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/0c6818af6df76464c9186d66cd58415a5d4b5e6d">0c6818af6df76464c9186d66cd58415a5d4b5e6d</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=8e708fca38cc203419b6b41158bf6c2b32e64ba1">15931</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Fri, 17 May 2019 21:50:38 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@8e708fca38cc [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=8e708fca38cc203419b6b41158bf6c2b32e64ba1">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=8e708fca38cc203419b6b41158bf6c2b32e64ba1&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=8e708fca38cc203419b6b41158bf6c2b32e64ba1&newProject=comm-central&newRevision=8e708fca38cc203419b6b41158bf6c2b32e64ba1&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=8e708fca38cc203419b6b41158bf6c2b32e64ba1&newProject=comm-central&newRevision=8e708fca38cc203419b6b41158bf6c2b32e64ba1&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=8e708fca38cc203419b6b41158bf6c2b32e64ba1&newProject=comm-central&newRevision=8e708fca38cc203419b6b41158bf6c2b32e64ba1&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28reformat%29&revcount=50">reformat</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1546364">1546364</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1546364">Bug 1546364</a> - Reformat to Google coding style in mailnews/base/src (part 2). rs=reformat
# ignore-this-changeset</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8e708fca38cc203419b6b41158bf6c2b32e64ba1/mailnews/base/src/nsMsgAccount.cpp">mailnews/base/src/nsMsgAccount.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8e708fca38cc203419b6b41158bf6c2b32e64ba1/mailnews/base/src/nsMsgAccount.cpp">file</a> |
<a href="/comm-central/annotate/8e708fca38cc203419b6b41158bf6c2b32e64ba1/mailnews/base/src/nsMsgAccount.cpp">annotate</a> |
<a href="/comm-central/diff/8e708fca38cc203419b6b41158bf6c2b32e64ba1/mailnews/base/src/nsMsgAccount.cpp">diff</a> |
<a href="/comm-central/comparison/8e708fca38cc203419b6b41158bf6c2b32e64ba1/mailnews/base/src/nsMsgAccount.cpp">comparison</a> |
<a href="/comm-central/log/8e708fca38cc203419b6b41158bf6c2b32e64ba1/mailnews/base/src/nsMsgAccount.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8e708fca38cc203419b6b41158bf6c2b32e64ba1/mailnews/base/src/nsMsgAccount.h">mailnews/base/src/nsMsgAccount.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8e708fca38cc203419b6b41158bf6c2b32e64ba1/mailnews/base/src/nsMsgAccount.h">file</a> |
<a href="/comm-central/annotate/8e708fca38cc203419b6b41158bf6c2b32e64ba1/mailnews/base/src/nsMsgAccount.h">annotate</a> |
<a href="/comm-central/diff/8e708fca38cc203419b6b41158bf6c2b32e64ba1/mailnews/base/src/nsMsgAccount.h">diff</a> |
<a href="/comm-central/comparison/8e708fca38cc203419b6b41158bf6c2b32e64ba1/mailnews/base/src/nsMsgAccount.h">comparison</a> |
<a href="/comm-central/log/8e708fca38cc203419b6b41158bf6c2b32e64ba1/mailnews/base/src/nsMsgAccount.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8e708fca38cc203419b6b41158bf6c2b32e64ba1/mailnews/base/src/nsMsgAccountManager.cpp">mailnews/base/src/nsMsgAccountManager.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8e708fca38cc203419b6b41158bf6c2b32e64ba1/mailnews/base/src/nsMsgAccountManager.cpp">file</a> |
<a href="/comm-central/annotate/8e708fca38cc203419b6b41158bf6c2b32e64ba1/mailnews/base/src/nsMsgAccountManager.cpp">annotate</a> |
<a href="/comm-central/diff/8e708fca38cc203419b6b41158bf6c2b32e64ba1/mailnews/base/src/nsMsgAccountManager.cpp">diff</a> |
<a href="/comm-central/comparison/8e708fca38cc203419b6b41158bf6c2b32e64ba1/mailnews/base/src/nsMsgAccountManager.cpp">comparison</a> |
<a href="/comm-central/log/8e708fca38cc203419b6b41158bf6c2b32e64ba1/mailnews/base/src/nsMsgAccountManager.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8e708fca38cc203419b6b41158bf6c2b32e64ba1/mailnews/base/src/nsMsgAccountManager.h">mailnews/base/src/nsMsgAccountManager.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8e708fca38cc203419b6b41158bf6c2b32e64ba1/mailnews/base/src/nsMsgAccountManager.h">file</a> |
<a href="/comm-central/annotate/8e708fca38cc203419b6b41158bf6c2b32e64ba1/mailnews/base/src/nsMsgAccountManager.h">annotate</a> |
<a href="/comm-central/diff/8e708fca38cc203419b6b41158bf6c2b32e64ba1/mailnews/base/src/nsMsgAccountManager.h">diff</a> |
<a href="/comm-central/comparison/8e708fca38cc203419b6b41158bf6c2b32e64ba1/mailnews/base/src/nsMsgAccountManager.h">comparison</a> |
<a href="/comm-central/log/8e708fca38cc203419b6b41158bf6c2b32e64ba1/mailnews/base/src/nsMsgAccountManager.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8e708fca38cc203419b6b41158bf6c2b32e64ba1/mailnews/base/src/nsMsgBiffManager.cpp">mailnews/base/src/nsMsgBiffManager.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8e708fca38cc203419b6b41158bf6c2b32e64ba1/mailnews/base/src/nsMsgBiffManager.cpp">file</a> |
<a href="/comm-central/annotate/8e708fca38cc203419b6b41158bf6c2b32e64ba1/mailnews/base/src/nsMsgBiffManager.cpp">annotate</a> |
<a href="/comm-central/diff/8e708fca38cc203419b6b41158bf6c2b32e64ba1/mailnews/base/src/nsMsgBiffManager.cpp">diff</a> |
<a href="/comm-central/comparison/8e708fca38cc203419b6b41158bf6c2b32e64ba1/mailnews/base/src/nsMsgBiffManager.cpp">comparison</a> |
<a href="/comm-central/log/8e708fca38cc203419b6b41158bf6c2b32e64ba1/mailnews/base/src/nsMsgBiffManager.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8e708fca38cc203419b6b41158bf6c2b32e64ba1/mailnews/base/src/nsMsgBiffManager.h">mailnews/base/src/nsMsgBiffManager.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8e708fca38cc203419b6b41158bf6c2b32e64ba1/mailnews/base/src/nsMsgBiffManager.h">file</a> |
<a href="/comm-central/annotate/8e708fca38cc203419b6b41158bf6c2b32e64ba1/mailnews/base/src/nsMsgBiffManager.h">annotate</a> |
<a href="/comm-central/diff/8e708fca38cc203419b6b41158bf6c2b32e64ba1/mailnews/base/src/nsMsgBiffManager.h">diff</a> |
<a href="/comm-central/comparison/8e708fca38cc203419b6b41158bf6c2b32e64ba1/mailnews/base/src/nsMsgBiffManager.h">comparison</a> |
<a href="/comm-central/log/8e708fca38cc203419b6b41158bf6c2b32e64ba1/mailnews/base/src/nsMsgBiffManager.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8e708fca38cc203419b6b41158bf6c2b32e64ba1/mailnews/base/src/nsMsgContentPolicy.cpp">mailnews/base/src/nsMsgContentPolicy.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8e708fca38cc203419b6b41158bf6c2b32e64ba1/mailnews/base/src/nsMsgContentPolicy.cpp">file</a> |
<a href="/comm-central/annotate/8e708fca38cc203419b6b41158bf6c2b32e64ba1/mailnews/base/src/nsMsgContentPolicy.cpp">annotate</a> |
<a href="/comm-central/diff/8e708fca38cc203419b6b41158bf6c2b32e64ba1/mailnews/base/src/nsMsgContentPolicy.cpp">diff</a> |
<a href="/comm-central/comparison/8e708fca38cc203419b6b41158bf6c2b32e64ba1/mailnews/base/src/nsMsgContentPolicy.cpp">comparison</a> |
<a href="/comm-central/log/8e708fca38cc203419b6b41158bf6c2b32e64ba1/mailnews/base/src/nsMsgContentPolicy.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8e708fca38cc203419b6b41158bf6c2b32e64ba1/mailnews/base/src/nsMsgContentPolicy.h">mailnews/base/src/nsMsgContentPolicy.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8e708fca38cc203419b6b41158bf6c2b32e64ba1/mailnews/base/src/nsMsgContentPolicy.h">file</a> |
<a href="/comm-central/annotate/8e708fca38cc203419b6b41158bf6c2b32e64ba1/mailnews/base/src/nsMsgContentPolicy.h">annotate</a> |
<a href="/comm-central/diff/8e708fca38cc203419b6b41158bf6c2b32e64ba1/mailnews/base/src/nsMsgContentPolicy.h">diff</a> |
<a href="/comm-central/comparison/8e708fca38cc203419b6b41158bf6c2b32e64ba1/mailnews/base/src/nsMsgContentPolicy.h">comparison</a> |
<a href="/comm-central/log/8e708fca38cc203419b6b41158bf6c2b32e64ba1/mailnews/base/src/nsMsgContentPolicy.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/8e708fca38cc203419b6b41158bf6c2b32e64ba1/mailnews/base/src/nsMsgCopyService.cpp">mailnews/base/src/nsMsgCopyService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8e708fca38cc203419b6b41158bf6c2b32e64ba1/mailnews/base/src/nsMsgCopyService.cpp">file</a> |
<a href="/comm-central/annotate/8e708fca38cc203419b6b41158bf6c2b32e64ba1/mailnews/base/src/nsMsgCopyService.cpp">annotate</a> |
<a href="/comm-central/diff/8e708fca38cc203419b6b41158bf6c2b32e64ba1/mailnews/base/src/nsMsgCopyService.cpp">diff</a> |
<a href="/comm-central/comparison/8e708fca38cc203419b6b41158bf6c2b32e64ba1/mailnews/base/src/nsMsgCopyService.cpp">comparison</a> |
<a href="/comm-central/log/8e708fca38cc203419b6b41158bf6c2b32e64ba1/mailnews/base/src/nsMsgCopyService.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/8e708fca38cc203419b6b41158bf6c2b32e64ba1/mailnews/base/src/nsMsgCopyService.h">mailnews/base/src/nsMsgCopyService.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/8e708fca38cc203419b6b41158bf6c2b32e64ba1/mailnews/base/src/nsMsgCopyService.h">file</a> |
<a href="/comm-central/annotate/8e708fca38cc203419b6b41158bf6c2b32e64ba1/mailnews/base/src/nsMsgCopyService.h">annotate</a> |
<a href="/comm-central/diff/8e708fca38cc203419b6b41158bf6c2b32e64ba1/mailnews/base/src/nsMsgCopyService.h">diff</a> |
<a href="/comm-central/comparison/8e708fca38cc203419b6b41158bf6c2b32e64ba1/mailnews/base/src/nsMsgCopyService.h">comparison</a> |
<a href="/comm-central/log/8e708fca38cc203419b6b41158bf6c2b32e64ba1/mailnews/base/src/nsMsgCopyService.h">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/base/src/nsMsgAccount.cpp</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgAccount.cpp</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -1,14 +1,13 @@</span>
<a href="#l1.4"></a><span id="l1.4"> /* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l1.5"></a><span id="l1.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l1.6"></a><span id="l1.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l1.7"></a><span id="l1.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l1.8"></a><span id="l1.8"> </span>
<a href="#l1.9"></a><span id="l1.9" class="difflineminus">-</span>
<a href="#l1.10"></a><span id="l1.10"> #include &quot;prprf.h&quot;</span>
<a href="#l1.11"></a><span id="l1.11"> #include &quot;plstr.h&quot;</span>
<a href="#l1.12"></a><span id="l1.12"> #include &quot;prmem.h&quot;</span>
<a href="#l1.13"></a><span id="l1.13"> #include &quot;nsIComponentManager.h&quot;</span>
<a href="#l1.14"></a><span id="l1.14"> #include &quot;nsIServiceManager.h&quot;</span>
<a href="#l1.15"></a><span id="l1.15"> #include &quot;nsCRTGlue.h&quot;</span>
<a href="#l1.16"></a><span id="l1.16"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l1.17"></a><span id="l1.17"> #include &quot;nsIMsgFolderNotificationService.h&quot;</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineat">@@ -22,199 +21,180 @@</span>
<a href="#l1.19"></a><span id="l1.19"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l1.20"></a><span id="l1.20"> #include &quot;nsMemory.h&quot;</span>
<a href="#l1.21"></a><span id="l1.21"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l1.22"></a><span id="l1.22"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l1.23"></a><span id="l1.23"> #include &quot;nsArrayUtils.h&quot;</span>
<a href="#l1.24"></a><span id="l1.24"> </span>
<a href="#l1.25"></a><span id="l1.25"> NS_IMPL_ISUPPORTS(nsMsgAccount, nsIMsgAccount)</span>
<a href="#l1.26"></a><span id="l1.26"> </span>
<a href="#l1.27"></a><span id="l1.27" class="difflineminus">-nsMsgAccount::nsMsgAccount()</span>
<a href="#l1.28"></a><span id="l1.28" class="difflineminus">-  : mTriedToGetServer(false)</span>
<a href="#l1.29"></a><span id="l1.29" class="difflineminus">-{</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineminus">-}</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineplus">+nsMsgAccount::nsMsgAccount() : mTriedToGetServer(false) {}</span>
<a href="#l1.32"></a><span id="l1.32"> </span>
<a href="#l1.33"></a><span id="l1.33" class="difflineminus">-nsMsgAccount::~nsMsgAccount()</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineminus">-{</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineminus">-}</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineplus">+nsMsgAccount::~nsMsgAccount() {}</span>
<a href="#l1.37"></a><span id="l1.37"> </span>
<a href="#l1.38"></a><span id="l1.38" class="difflineminus">-nsresult</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineminus">-nsMsgAccount::getPrefService()</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineminus">-{</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineminus">-  if (m_prefs)</span>
<a href="#l1.42"></a><span id="l1.42" class="difflineminus">-    return NS_OK;</span>
<a href="#l1.43"></a><span id="l1.43" class="difflineplus">+nsresult nsMsgAccount::getPrefService() {</span>
<a href="#l1.44"></a><span id="l1.44" class="difflineplus">+  if (m_prefs) return NS_OK;</span>
<a href="#l1.45"></a><span id="l1.45"> </span>
<a href="#l1.46"></a><span id="l1.46">   nsresult rv;</span>
<a href="#l1.47"></a><span id="l1.47">   NS_ENSURE_FALSE(m_accountKey.IsEmpty(), NS_ERROR_NOT_INITIALIZED);</span>
<a href="#l1.48"></a><span id="l1.48">   nsCOMPtr&lt;nsIPrefService&gt; prefs(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l1.49"></a><span id="l1.49">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.50"></a><span id="l1.50"> </span>
<a href="#l1.51"></a><span id="l1.51">   nsAutoCString accountRoot(&quot;mail.account.&quot;);</span>
<a href="#l1.52"></a><span id="l1.52">   accountRoot.Append(m_accountKey);</span>
<a href="#l1.53"></a><span id="l1.53">   accountRoot.Append('.');</span>
<a href="#l1.54"></a><span id="l1.54">   return prefs-&gt;GetBranch(accountRoot.get(), getter_AddRefs(m_prefs));</span>
<a href="#l1.55"></a><span id="l1.55"> }</span>
<a href="#l1.56"></a><span id="l1.56"> </span>
<a href="#l1.57"></a><span id="l1.57"> NS_IMETHODIMP</span>
<a href="#l1.58"></a><span id="l1.58" class="difflineminus">-nsMsgAccount::GetIncomingServer(nsIMsgIncomingServer **aIncomingServer)</span>
<a href="#l1.59"></a><span id="l1.59" class="difflineminus">-{</span>
<a href="#l1.60"></a><span id="l1.60" class="difflineplus">+nsMsgAccount::GetIncomingServer(nsIMsgIncomingServer **aIncomingServer) {</span>
<a href="#l1.61"></a><span id="l1.61">   NS_ENSURE_ARG_POINTER(aIncomingServer);</span>
<a href="#l1.62"></a><span id="l1.62"> </span>
<a href="#l1.63"></a><span id="l1.63">   // create the incoming server lazily</span>
<a href="#l1.64"></a><span id="l1.64">   if (!mTriedToGetServer &amp;&amp; !m_incomingServer) {</span>
<a href="#l1.65"></a><span id="l1.65">     mTriedToGetServer = true;</span>
<a href="#l1.66"></a><span id="l1.66">     // ignore the error (and return null), but it's still bad so warn</span>
<a href="#l1.67"></a><span id="l1.67">     mozilla::DebugOnly&lt;nsresult&gt; rv = createIncomingServer();</span>
<a href="#l1.68"></a><span id="l1.68" class="difflineminus">-    NS_WARNING_ASSERTION(NS_SUCCEEDED(rv), &quot;couldn't lazily create the server\n&quot;);</span>
<a href="#l1.69"></a><span id="l1.69" class="difflineplus">+    NS_WARNING_ASSERTION(NS_SUCCEEDED(rv),</span>
<a href="#l1.70"></a><span id="l1.70" class="difflineplus">+                         &quot;couldn't lazily create the server\n&quot;);</span>
<a href="#l1.71"></a><span id="l1.71">   }</span>
<a href="#l1.72"></a><span id="l1.72"> </span>
<a href="#l1.73"></a><span id="l1.73">   NS_IF_ADDREF(*aIncomingServer = m_incomingServer);</span>
<a href="#l1.74"></a><span id="l1.74"> </span>
<a href="#l1.75"></a><span id="l1.75">   return NS_OK;</span>
<a href="#l1.76"></a><span id="l1.76"> }</span>
<a href="#l1.77"></a><span id="l1.77"> </span>
<a href="#l1.78"></a><span id="l1.78"> NS_IMETHODIMP</span>
<a href="#l1.79"></a><span id="l1.79" class="difflineminus">-nsMsgAccount::CreateServer()</span>
<a href="#l1.80"></a><span id="l1.80" class="difflineminus">-{</span>
<a href="#l1.81"></a><span id="l1.81" class="difflineminus">-  if (m_incomingServer)</span>
<a href="#l1.82"></a><span id="l1.82" class="difflineminus">-    return NS_ERROR_ALREADY_INITIALIZED;</span>
<a href="#l1.83"></a><span id="l1.83" class="difflineplus">+nsMsgAccount::CreateServer() {</span>
<a href="#l1.84"></a><span id="l1.84" class="difflineplus">+  if (m_incomingServer) return NS_ERROR_ALREADY_INITIALIZED;</span>
<a href="#l1.85"></a><span id="l1.85">   return createIncomingServer();</span>
<a href="#l1.86"></a><span id="l1.86"> }</span>
<a href="#l1.87"></a><span id="l1.87"> </span>
<a href="#l1.88"></a><span id="l1.88" class="difflineminus">-nsresult</span>
<a href="#l1.89"></a><span id="l1.89" class="difflineminus">-nsMsgAccount::createIncomingServer()</span>
<a href="#l1.90"></a><span id="l1.90" class="difflineminus">-{</span>
<a href="#l1.91"></a><span id="l1.91" class="difflineplus">+nsresult nsMsgAccount::createIncomingServer() {</span>
<a href="#l1.92"></a><span id="l1.92">   // from here, load mail.account.myaccount.server</span>
<a href="#l1.93"></a><span id="l1.93">   // Load the incoming server</span>
<a href="#l1.94"></a><span id="l1.94">   //</span>
<a href="#l1.95"></a><span id="l1.95">   // ex) mail.account.myaccount.server = &quot;myserver&quot;</span>
<a href="#l1.96"></a><span id="l1.96"> </span>
<a href="#l1.97"></a><span id="l1.97">   nsresult rv = getPrefService();</span>
<a href="#l1.98"></a><span id="l1.98">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.99"></a><span id="l1.99"> </span>
<a href="#l1.100"></a><span id="l1.100">   // get the &quot;server&quot; pref</span>
<a href="#l1.101"></a><span id="l1.101">   nsCString serverKey;</span>
<a href="#l1.102"></a><span id="l1.102">   rv = m_prefs-&gt;GetCharPref(&quot;server&quot;, serverKey);</span>
<a href="#l1.103"></a><span id="l1.103">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.104"></a><span id="l1.104"> </span>
<a href="#l1.105"></a><span id="l1.105">   // get the server from the account manager</span>
<a href="#l1.106"></a><span id="l1.106">   nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l1.107"></a><span id="l1.107" class="difflineminus">-           do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l1.108"></a><span id="l1.108" class="difflineplus">+      do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l1.109"></a><span id="l1.109">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.110"></a><span id="l1.110"> </span>
<a href="#l1.111"></a><span id="l1.111">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l1.112"></a><span id="l1.112">   rv = accountManager-&gt;GetIncomingServer(serverKey, getter_AddRefs(server));</span>
<a href="#l1.113"></a><span id="l1.113">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.114"></a><span id="l1.114"> </span>
<a href="#l1.115"></a><span id="l1.115">   // store the server in this structure</span>
<a href="#l1.116"></a><span id="l1.116">   m_incomingServer = server;</span>
<a href="#l1.117"></a><span id="l1.117">   accountManager-&gt;NotifyServerLoaded(server);</span>
<a href="#l1.118"></a><span id="l1.118"> </span>
<a href="#l1.119"></a><span id="l1.119">   return NS_OK;</span>
<a href="#l1.120"></a><span id="l1.120"> }</span>
<a href="#l1.121"></a><span id="l1.121"> </span>
<a href="#l1.122"></a><span id="l1.122" class="difflineminus">-</span>
<a href="#l1.123"></a><span id="l1.123"> NS_IMETHODIMP</span>
<a href="#l1.124"></a><span id="l1.124" class="difflineminus">-nsMsgAccount::SetIncomingServer(nsIMsgIncomingServer *aIncomingServer)</span>
<a href="#l1.125"></a><span id="l1.125" class="difflineminus">-{</span>
<a href="#l1.126"></a><span id="l1.126" class="difflineplus">+nsMsgAccount::SetIncomingServer(nsIMsgIncomingServer *aIncomingServer) {</span>
<a href="#l1.127"></a><span id="l1.127">   NS_ENSURE_ARG_POINTER(aIncomingServer);</span>
<a href="#l1.128"></a><span id="l1.128"> </span>
<a href="#l1.129"></a><span id="l1.129">   nsCString key;</span>
<a href="#l1.130"></a><span id="l1.130">   nsresult rv = aIncomingServer-&gt;GetKey(key);</span>
<a href="#l1.131"></a><span id="l1.131"> </span>
<a href="#l1.132"></a><span id="l1.132">   if (NS_SUCCEEDED(rv)) {</span>
<a href="#l1.133"></a><span id="l1.133">     rv = getPrefService();</span>
<a href="#l1.134"></a><span id="l1.134">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.135"></a><span id="l1.135">     m_prefs-&gt;SetCharPref(&quot;server&quot;, key);</span>
<a href="#l1.136"></a><span id="l1.136">   }</span>
<a href="#l1.137"></a><span id="l1.137"> </span>
<a href="#l1.138"></a><span id="l1.138">   m_incomingServer = aIncomingServer;</span>
<a href="#l1.139"></a><span id="l1.139"> </span>
<a href="#l1.140"></a><span id="l1.140">   bool serverValid;</span>
<a href="#l1.141"></a><span id="l1.141" class="difflineminus">-  (void) aIncomingServer-&gt;GetValid(&amp;serverValid);</span>
<a href="#l1.142"></a><span id="l1.142" class="difflineplus">+  (void)aIncomingServer-&gt;GetValid(&amp;serverValid);</span>
<a href="#l1.143"></a><span id="l1.143">   // only notify server loaded if server is valid so</span>
<a href="#l1.144"></a><span id="l1.144">   // account manager only gets told about finished accounts.</span>
<a href="#l1.145"></a><span id="l1.145" class="difflineminus">-  if (serverValid)</span>
<a href="#l1.146"></a><span id="l1.146" class="difflineminus">-  {</span>
<a href="#l1.147"></a><span id="l1.147" class="difflineplus">+  if (serverValid) {</span>
<a href="#l1.148"></a><span id="l1.148">     // this is the point at which we can notify listeners about the</span>
<a href="#l1.149"></a><span id="l1.149">     // creation of the root folder, which implies creation of the new server.</span>
<a href="#l1.150"></a><span id="l1.150">     nsCOMPtr&lt;nsIMsgFolder&gt; rootFolder;</span>
<a href="#l1.151"></a><span id="l1.151">     rv = aIncomingServer-&gt;GetRootFolder(getter_AddRefs(rootFolder));</span>
<a href="#l1.152"></a><span id="l1.152">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.153"></a><span id="l1.153">     nsCOMPtr&lt;nsIFolderListener&gt; mailSession =</span>
<a href="#l1.154"></a><span id="l1.154" class="difflineminus">-             do_GetService(NS_MSGMAILSESSION_CONTRACTID, &amp;rv);</span>
<a href="#l1.155"></a><span id="l1.155" class="difflineplus">+        do_GetService(NS_MSGMAILSESSION_CONTRACTID, &amp;rv);</span>
<a href="#l1.156"></a><span id="l1.156">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.157"></a><span id="l1.157">     mailSession-&gt;OnItemAdded(nullptr, rootFolder);</span>
<a href="#l1.158"></a><span id="l1.158" class="difflineminus">-    nsCOMPtr&lt;nsIMsgFolderNotificationService&gt; notifier(do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l1.159"></a><span id="l1.159" class="difflineplus">+    nsCOMPtr&lt;nsIMsgFolderNotificationService&gt; notifier(</span>
<a href="#l1.160"></a><span id="l1.160" class="difflineplus">+        do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l1.161"></a><span id="l1.161">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.162"></a><span id="l1.162">     notifier-&gt;NotifyFolderAdded(rootFolder);</span>
<a href="#l1.163"></a><span id="l1.163"> </span>
<a href="#l1.164"></a><span id="l1.164" class="difflineminus">-    nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager = do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l1.165"></a><span id="l1.165" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l1.166"></a><span id="l1.166" class="difflineminus">-      accountManager-&gt;NotifyServerLoaded(aIncomingServer);</span>
<a href="#l1.167"></a><span id="l1.167" class="difflineplus">+    nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l1.168"></a><span id="l1.168" class="difflineplus">+        do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l1.169"></a><span id="l1.169" class="difflineplus">+    if (NS_SUCCEEDED(rv)) accountManager-&gt;NotifyServerLoaded(aIncomingServer);</span>
<a href="#l1.170"></a><span id="l1.170"> </span>
<a href="#l1.171"></a><span id="l1.171" class="difflineminus">-    // Force built-in folders to be created and discovered. Then, notify listeners</span>
<a href="#l1.172"></a><span id="l1.172" class="difflineminus">-    // about them.</span>
<a href="#l1.173"></a><span id="l1.173" class="difflineplus">+    // Force built-in folders to be created and discovered. Then, notify</span>
<a href="#l1.174"></a><span id="l1.174" class="difflineplus">+    // listeners about them.</span>
<a href="#l1.175"></a><span id="l1.175">     nsCOMPtr&lt;nsISimpleEnumerator&gt; enumerator;</span>
<a href="#l1.176"></a><span id="l1.176">     rv = rootFolder-&gt;GetSubFolders(getter_AddRefs(enumerator));</span>
<a href="#l1.177"></a><span id="l1.177">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.178"></a><span id="l1.178"> </span>
<a href="#l1.179"></a><span id="l1.179">     bool hasMore;</span>
<a href="#l1.180"></a><span id="l1.180" class="difflineminus">-    while (NS_SUCCEEDED(enumerator-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore)</span>
<a href="#l1.181"></a><span id="l1.181" class="difflineminus">-    {</span>
<a href="#l1.182"></a><span id="l1.182" class="difflineplus">+    while (NS_SUCCEEDED(enumerator-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore) {</span>
<a href="#l1.183"></a><span id="l1.183">       nsCOMPtr&lt;nsISupports&gt; item;</span>
<a href="#l1.184"></a><span id="l1.184">       enumerator-&gt;GetNext(getter_AddRefs(item));</span>
<a href="#l1.185"></a><span id="l1.185"> </span>
<a href="#l1.186"></a><span id="l1.186">       nsCOMPtr&lt;nsIMsgFolder&gt; msgFolder(do_QueryInterface(item));</span>
<a href="#l1.187"></a><span id="l1.187" class="difflineminus">-      if (!msgFolder)</span>
<a href="#l1.188"></a><span id="l1.188" class="difflineminus">-        continue;</span>
<a href="#l1.189"></a><span id="l1.189" class="difflineplus">+      if (!msgFolder) continue;</span>
<a href="#l1.190"></a><span id="l1.190">       mailSession-&gt;OnItemAdded(rootFolder, msgFolder);</span>
<a href="#l1.191"></a><span id="l1.191">       notifier-&gt;NotifyFolderAdded(msgFolder);</span>
<a href="#l1.192"></a><span id="l1.192">     }</span>
<a href="#l1.193"></a><span id="l1.193">   }</span>
<a href="#l1.194"></a><span id="l1.194">   return NS_OK;</span>
<a href="#l1.195"></a><span id="l1.195"> }</span>
<a href="#l1.196"></a><span id="l1.196"> </span>
<a href="#l1.197"></a><span id="l1.197"> NS_IMETHODIMP</span>
<a href="#l1.198"></a><span id="l1.198" class="difflineminus">-nsMsgAccount::GetIdentities(nsIArray **_retval)</span>
<a href="#l1.199"></a><span id="l1.199" class="difflineminus">-{</span>
<a href="#l1.200"></a><span id="l1.200" class="difflineplus">+nsMsgAccount::GetIdentities(nsIArray **_retval) {</span>
<a href="#l1.201"></a><span id="l1.201">   NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l1.202"></a><span id="l1.202">   NS_ENSURE_TRUE(m_identities, NS_ERROR_FAILURE);</span>
<a href="#l1.203"></a><span id="l1.203"> </span>
<a href="#l1.204"></a><span id="l1.204">   NS_IF_ADDREF(*_retval = m_identities);</span>
<a href="#l1.205"></a><span id="l1.205">   return NS_OK;</span>
<a href="#l1.206"></a><span id="l1.206"> }</span>
<a href="#l1.207"></a><span id="l1.207"> </span>
<a href="#l1.208"></a><span id="l1.208"> /*</span>
<a href="#l1.209"></a><span id="l1.209">  * set up the m_identities array</span>
<a href="#l1.210"></a><span id="l1.210">  * do not call this more than once or we'll leak.</span>
<a href="#l1.211"></a><span id="l1.211">  */</span>
<a href="#l1.212"></a><span id="l1.212" class="difflineminus">-nsresult</span>
<a href="#l1.213"></a><span id="l1.213" class="difflineminus">-nsMsgAccount::createIdentities()</span>
<a href="#l1.214"></a><span id="l1.214" class="difflineminus">-{</span>
<a href="#l1.215"></a><span id="l1.215" class="difflineplus">+nsresult nsMsgAccount::createIdentities() {</span>
<a href="#l1.216"></a><span id="l1.216">   NS_ENSURE_FALSE(m_identities, NS_ERROR_FAILURE);</span>
<a href="#l1.217"></a><span id="l1.217"> </span>
<a href="#l1.218"></a><span id="l1.218">   nsresult rv;</span>
<a href="#l1.219"></a><span id="l1.219">   m_identities = do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l1.220"></a><span id="l1.220">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.221"></a><span id="l1.221"> </span>
<a href="#l1.222"></a><span id="l1.222">   nsCString identityKey;</span>
<a href="#l1.223"></a><span id="l1.223">   rv = getPrefService();</span>
<a href="#l1.224"></a><span id="l1.224">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.225"></a><span id="l1.225"> </span>
<a href="#l1.226"></a><span id="l1.226">   m_prefs-&gt;GetCharPref(&quot;identities&quot;, identityKey);</span>
<a href="#l1.227"></a><span id="l1.227" class="difflineminus">-  if (identityKey.IsEmpty())    // not an error if no identities, but</span>
<a href="#l1.228"></a><span id="l1.228" class="difflineminus">-    return NS_OK;               // strtok will be unhappy</span>
<a href="#l1.229"></a><span id="l1.229" class="difflineplus">+  if (identityKey.IsEmpty())  // not an error if no identities, but</span>
<a href="#l1.230"></a><span id="l1.230" class="difflineplus">+    return NS_OK;             // strtok will be unhappy</span>
<a href="#l1.231"></a><span id="l1.231">   // get the server from the account manager</span>
<a href="#l1.232"></a><span id="l1.232">   nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l1.233"></a><span id="l1.233" class="difflineminus">-           do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l1.234"></a><span id="l1.234" class="difflineplus">+      do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l1.235"></a><span id="l1.235">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.236"></a><span id="l1.236"> </span>
<a href="#l1.237"></a><span id="l1.237" class="difflineminus">-  char* newStr = identityKey.BeginWriting();</span>
<a href="#l1.238"></a><span id="l1.238" class="difflineminus">-  char* token = NS_strtok(&quot;,&quot;, &amp;newStr);</span>
<a href="#l1.239"></a><span id="l1.239" class="difflineplus">+  char *newStr = identityKey.BeginWriting();</span>
<a href="#l1.240"></a><span id="l1.240" class="difflineplus">+  char *token = NS_strtok(&quot;,&quot;, &amp;newStr);</span>
<a href="#l1.241"></a><span id="l1.241"> </span>
<a href="#l1.242"></a><span id="l1.242">   // temporaries used inside the loop</span>
<a href="#l1.243"></a><span id="l1.243">   nsCOMPtr&lt;nsIMsgIdentity&gt; identity;</span>
<a href="#l1.244"></a><span id="l1.244">   nsAutoCString key;</span>
<a href="#l1.245"></a><span id="l1.245"> </span>
<a href="#l1.246"></a><span id="l1.246">   // iterate through id1,id2, etc</span>
<a href="#l1.247"></a><span id="l1.247">   while (token) {</span>
<a href="#l1.248"></a><span id="l1.248">     key = token;</span>
<a href="#l1.249"></a><span id="l1.249" class="difflineat">@@ -230,39 +210,35 @@ nsMsgAccount::createIdentities()</span>
<a href="#l1.250"></a><span id="l1.250"> </span>
<a href="#l1.251"></a><span id="l1.251">     // advance to next key, if any</span>
<a href="#l1.252"></a><span id="l1.252">     token = NS_strtok(&quot;,&quot;, &amp;newStr);</span>
<a href="#l1.253"></a><span id="l1.253">   }</span>
<a href="#l1.254"></a><span id="l1.254"> </span>
<a href="#l1.255"></a><span id="l1.255">   return rv;</span>
<a href="#l1.256"></a><span id="l1.256"> }</span>
<a href="#l1.257"></a><span id="l1.257"> </span>
<a href="#l1.258"></a><span id="l1.258" class="difflineminus">-</span>
<a href="#l1.259"></a><span id="l1.259"> /* attribute nsIMsgIdentity defaultIdentity; */</span>
<a href="#l1.260"></a><span id="l1.260"> NS_IMETHODIMP</span>
<a href="#l1.261"></a><span id="l1.261" class="difflineminus">-nsMsgAccount::GetDefaultIdentity(nsIMsgIdentity **aDefaultIdentity)</span>
<a href="#l1.262"></a><span id="l1.262" class="difflineminus">-{</span>
<a href="#l1.263"></a><span id="l1.263" class="difflineplus">+nsMsgAccount::GetDefaultIdentity(nsIMsgIdentity **aDefaultIdentity) {</span>
<a href="#l1.264"></a><span id="l1.264">   NS_ENSURE_ARG_POINTER(aDefaultIdentity);</span>
<a href="#l1.265"></a><span id="l1.265">   NS_ENSURE_TRUE(m_identities, NS_ERROR_NOT_INITIALIZED);</span>
<a href="#l1.266"></a><span id="l1.266"> </span>
<a href="#l1.267"></a><span id="l1.267">   *aDefaultIdentity = nullptr;</span>
<a href="#l1.268"></a><span id="l1.268">   uint32_t count;</span>
<a href="#l1.269"></a><span id="l1.269">   nsresult rv = m_identities-&gt;GetLength(&amp;count);</span>
<a href="#l1.270"></a><span id="l1.270">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.271"></a><span id="l1.271" class="difflineminus">-  if (count == 0)</span>
<a href="#l1.272"></a><span id="l1.272" class="difflineminus">-    return NS_OK;</span>
<a href="#l1.273"></a><span id="l1.273" class="difflineplus">+  if (count == 0) return NS_OK;</span>
<a href="#l1.274"></a><span id="l1.274"> </span>
<a href="#l1.275"></a><span id="l1.275">   nsCOMPtr&lt;nsIMsgIdentity&gt; identity = do_QueryElementAt(m_identities, 0, &amp;rv);</span>
<a href="#l1.276"></a><span id="l1.276">   identity.forget(aDefaultIdentity);</span>
<a href="#l1.277"></a><span id="l1.277">   return rv;</span>
<a href="#l1.278"></a><span id="l1.278"> }</span>
<a href="#l1.279"></a><span id="l1.279"> </span>
<a href="#l1.280"></a><span id="l1.280"> NS_IMETHODIMP</span>
<a href="#l1.281"></a><span id="l1.281" class="difflineminus">-nsMsgAccount::SetDefaultIdentity(nsIMsgIdentity *aDefaultIdentity)</span>
<a href="#l1.282"></a><span id="l1.282" class="difflineminus">-{</span>
<a href="#l1.283"></a><span id="l1.283" class="difflineplus">+nsMsgAccount::SetDefaultIdentity(nsIMsgIdentity *aDefaultIdentity) {</span>
<a href="#l1.284"></a><span id="l1.284">   NS_ENSURE_TRUE(m_identities, NS_ERROR_FAILURE);</span>
<a href="#l1.285"></a><span id="l1.285"> </span>
<a href="#l1.286"></a><span id="l1.286">   uint32_t position = 0;</span>
<a href="#l1.287"></a><span id="l1.287">   nsresult rv = m_identities-&gt;IndexOf(0, aDefaultIdentity, &amp;position);</span>
<a href="#l1.288"></a><span id="l1.288">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.289"></a><span id="l1.289"> </span>
<a href="#l1.290"></a><span id="l1.290">   rv = m_identities-&gt;RemoveElementAt(position);</span>
<a href="#l1.291"></a><span id="l1.291">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.292"></a><span id="l1.292" class="difflineat">@@ -272,56 +248,52 @@ nsMsgAccount::SetDefaultIdentity(nsIMsgI</span>
<a href="#l1.293"></a><span id="l1.293">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.294"></a><span id="l1.294"> </span>
<a href="#l1.295"></a><span id="l1.295">   return saveIdentitiesPref();</span>
<a href="#l1.296"></a><span id="l1.296"> }</span>
<a href="#l1.297"></a><span id="l1.297"> </span>
<a href="#l1.298"></a><span id="l1.298"> // add the identity to m_identities, but don't fiddle with the</span>
<a href="#l1.299"></a><span id="l1.299"> // prefs. The assumption here is that the pref for this identity is</span>
<a href="#l1.300"></a><span id="l1.300"> // already set.</span>
<a href="#l1.301"></a><span id="l1.301" class="difflineminus">-nsresult</span>
<a href="#l1.302"></a><span id="l1.302" class="difflineminus">-nsMsgAccount::addIdentityInternal(nsIMsgIdentity *identity)</span>
<a href="#l1.303"></a><span id="l1.303" class="difflineminus">-{</span>
<a href="#l1.304"></a><span id="l1.304" class="difflineplus">+nsresult nsMsgAccount::addIdentityInternal(nsIMsgIdentity *identity) {</span>
<a href="#l1.305"></a><span id="l1.305">   NS_ENSURE_TRUE(m_identities, NS_ERROR_FAILURE);</span>
<a href="#l1.306"></a><span id="l1.306"> </span>
<a href="#l1.307"></a><span id="l1.307">   return m_identities-&gt;AppendElement(identity);</span>
<a href="#l1.308"></a><span id="l1.308"> }</span>
<a href="#l1.309"></a><span id="l1.309"> </span>
<a href="#l1.310"></a><span id="l1.310"> /* void addIdentity (in nsIMsgIdentity identity); */</span>
<a href="#l1.311"></a><span id="l1.311"> NS_IMETHODIMP</span>
<a href="#l1.312"></a><span id="l1.312" class="difflineminus">-nsMsgAccount::AddIdentity(nsIMsgIdentity *identity)</span>
<a href="#l1.313"></a><span id="l1.313" class="difflineminus">-{</span>
<a href="#l1.314"></a><span id="l1.314" class="difflineplus">+nsMsgAccount::AddIdentity(nsIMsgIdentity *identity) {</span>
<a href="#l1.315"></a><span id="l1.315">   NS_ENSURE_ARG_POINTER(identity);</span>
<a href="#l1.316"></a><span id="l1.316"> </span>
<a href="#l1.317"></a><span id="l1.317">   // hack hack - need to add this to the list of identities.</span>
<a href="#l1.318"></a><span id="l1.318">   // for now just treat this as a Setxxx accessor</span>
<a href="#l1.319"></a><span id="l1.319">   // when this is actually implemented, don't refcount the default identity</span>
<a href="#l1.320"></a><span id="l1.320">   nsCString key;</span>
<a href="#l1.321"></a><span id="l1.321">   nsresult rv = identity-&gt;GetKey(key);</span>
<a href="#l1.322"></a><span id="l1.322"> </span>
<a href="#l1.323"></a><span id="l1.323">   if (NS_SUCCEEDED(rv)) {</span>
<a href="#l1.324"></a><span id="l1.324">     nsCString identityList;</span>
<a href="#l1.325"></a><span id="l1.325">     m_prefs-&gt;GetCharPref(&quot;identities&quot;, identityList);</span>
<a href="#l1.326"></a><span id="l1.326"> </span>
<a href="#l1.327"></a><span id="l1.327">     nsAutoCString newIdentityList(identityList);</span>
<a href="#l1.328"></a><span id="l1.328"> </span>
<a href="#l1.329"></a><span id="l1.329" class="difflineminus">-    nsAutoCString testKey;      // temporary to strip whitespace</span>
<a href="#l1.330"></a><span id="l1.330" class="difflineminus">-    bool foundIdentity = false; // if the input identity is found</span>
<a href="#l1.331"></a><span id="l1.331" class="difflineplus">+    nsAutoCString testKey;       // temporary to strip whitespace</span>
<a href="#l1.332"></a><span id="l1.332" class="difflineplus">+    bool foundIdentity = false;  // if the input identity is found</span>
<a href="#l1.333"></a><span id="l1.333"> </span>
<a href="#l1.334"></a><span id="l1.334">     if (!identityList.IsEmpty()) {</span>
<a href="#l1.335"></a><span id="l1.335">       char *newStr = identityList.BeginWriting();</span>
<a href="#l1.336"></a><span id="l1.336">       char *token = NS_strtok(&quot;,&quot;, &amp;newStr);</span>
<a href="#l1.337"></a><span id="l1.337"> </span>
<a href="#l1.338"></a><span id="l1.338">       // look for the identity key that we're adding</span>
<a href="#l1.339"></a><span id="l1.339">       while (token) {</span>
<a href="#l1.340"></a><span id="l1.340">         testKey = token;</span>
<a href="#l1.341"></a><span id="l1.341">         testKey.StripWhitespace();</span>
<a href="#l1.342"></a><span id="l1.342"> </span>
<a href="#l1.343"></a><span id="l1.343" class="difflineminus">-        if (testKey.Equals(key))</span>
<a href="#l1.344"></a><span id="l1.344" class="difflineminus">-          foundIdentity = true;</span>
<a href="#l1.345"></a><span id="l1.345" class="difflineplus">+        if (testKey.Equals(key)) foundIdentity = true;</span>
<a href="#l1.346"></a><span id="l1.346"> </span>
<a href="#l1.347"></a><span id="l1.347">         token = NS_strtok(&quot;,&quot;, &amp;newStr);</span>
<a href="#l1.348"></a><span id="l1.348">       }</span>
<a href="#l1.349"></a><span id="l1.349">     }</span>
<a href="#l1.350"></a><span id="l1.350"> </span>
<a href="#l1.351"></a><span id="l1.351">     // if it didn't already exist, append it</span>
<a href="#l1.352"></a><span id="l1.352">     if (!foundIdentity) {</span>
<a href="#l1.353"></a><span id="l1.353">       if (newIdentityList.IsEmpty())</span>
<a href="#l1.354"></a><span id="l1.354" class="difflineat">@@ -336,18 +308,17 @@ nsMsgAccount::AddIdentity(nsIMsgIdentity</span>
<a href="#l1.355"></a><span id="l1.355">   }</span>
<a href="#l1.356"></a><span id="l1.356"> </span>
<a href="#l1.357"></a><span id="l1.357">   // now add it to the in-memory list</span>
<a href="#l1.358"></a><span id="l1.358">   return addIdentityInternal(identity);</span>
<a href="#l1.359"></a><span id="l1.359"> }</span>
<a href="#l1.360"></a><span id="l1.360"> </span>
<a href="#l1.361"></a><span id="l1.361"> /* void removeIdentity (in nsIMsgIdentity identity); */</span>
<a href="#l1.362"></a><span id="l1.362"> NS_IMETHODIMP</span>
<a href="#l1.363"></a><span id="l1.363" class="difflineminus">-nsMsgAccount::RemoveIdentity(nsIMsgIdentity *aIdentity)</span>
<a href="#l1.364"></a><span id="l1.364" class="difflineminus">-{</span>
<a href="#l1.365"></a><span id="l1.365" class="difflineplus">+nsMsgAccount::RemoveIdentity(nsIMsgIdentity *aIdentity) {</span>
<a href="#l1.366"></a><span id="l1.366">   NS_ENSURE_ARG_POINTER(aIdentity);</span>
<a href="#l1.367"></a><span id="l1.367">   NS_ENSURE_TRUE(m_identities, NS_ERROR_FAILURE);</span>
<a href="#l1.368"></a><span id="l1.368"> </span>
<a href="#l1.369"></a><span id="l1.369">   uint32_t count = 0;</span>
<a href="#l1.370"></a><span id="l1.370">   m_identities-&gt;GetLength(&amp;count);</span>
<a href="#l1.371"></a><span id="l1.371">   // At least one identity must stay after the delete.</span>
<a href="#l1.372"></a><span id="l1.372">   NS_ENSURE_TRUE(count &gt; 1, NS_ERROR_FAILURE);</span>
<a href="#l1.373"></a><span id="l1.373"> </span>
<a href="#l1.374"></a><span id="l1.374" class="difflineat">@@ -359,77 +330,68 @@ nsMsgAccount::RemoveIdentity(nsIMsgIdent</span>
<a href="#l1.375"></a><span id="l1.375">   m_identities-&gt;RemoveElementAt(pos);</span>
<a href="#l1.376"></a><span id="l1.376"> </span>
<a href="#l1.377"></a><span id="l1.377">   // clear out the actual pref values associated with the identity</span>
<a href="#l1.378"></a><span id="l1.378">   aIdentity-&gt;ClearAllValues();</span>
<a href="#l1.379"></a><span id="l1.379"> </span>
<a href="#l1.380"></a><span id="l1.380">   return saveIdentitiesPref();</span>
<a href="#l1.381"></a><span id="l1.381"> }</span>
<a href="#l1.382"></a><span id="l1.382"> </span>
<a href="#l1.383"></a><span id="l1.383" class="difflineminus">-nsresult</span>
<a href="#l1.384"></a><span id="l1.384" class="difflineminus">-nsMsgAccount::saveIdentitiesPref()</span>
<a href="#l1.385"></a><span id="l1.385" class="difflineminus">-{</span>
<a href="#l1.386"></a><span id="l1.386" class="difflineplus">+nsresult nsMsgAccount::saveIdentitiesPref() {</span>
<a href="#l1.387"></a><span id="l1.387">   nsAutoCString newIdentityList;</span>
<a href="#l1.388"></a><span id="l1.388"> </span>
<a href="#l1.389"></a><span id="l1.389">   // Iterate over the existing identities and build the pref value,</span>
<a href="#l1.390"></a><span id="l1.390">   // a string of identity keys: id1, id2, idX...</span>
<a href="#l1.391"></a><span id="l1.391">   uint32_t count;</span>
<a href="#l1.392"></a><span id="l1.392">   nsresult rv = m_identities-&gt;GetLength(&amp;count);</span>
<a href="#l1.393"></a><span id="l1.393">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.394"></a><span id="l1.394"> </span>
<a href="#l1.395"></a><span id="l1.395">   nsCString key;</span>
<a href="#l1.396"></a><span id="l1.396" class="difflineminus">-  for (uint32_t index = 0; index &lt; count; index++)</span>
<a href="#l1.397"></a><span id="l1.397" class="difflineminus">-  {</span>
<a href="#l1.398"></a><span id="l1.398" class="difflineminus">-    nsCOMPtr&lt;nsIMsgIdentity&gt; identity = do_QueryElementAt(m_identities, index, &amp;rv);</span>
<a href="#l1.399"></a><span id="l1.399" class="difflineminus">-    if (identity)</span>
<a href="#l1.400"></a><span id="l1.400" class="difflineminus">-    {</span>
<a href="#l1.401"></a><span id="l1.401" class="difflineplus">+  for (uint32_t index = 0; index &lt; count; index++) {</span>
<a href="#l1.402"></a><span id="l1.402" class="difflineplus">+    nsCOMPtr&lt;nsIMsgIdentity&gt; identity =</span>
<a href="#l1.403"></a><span id="l1.403" class="difflineplus">+        do_QueryElementAt(m_identities, index, &amp;rv);</span>
<a href="#l1.404"></a><span id="l1.404" class="difflineplus">+    if (identity) {</span>
<a href="#l1.405"></a><span id="l1.405">       identity-&gt;GetKey(key);</span>
<a href="#l1.406"></a><span id="l1.406"> </span>
<a href="#l1.407"></a><span id="l1.407">       if (!index) {</span>
<a href="#l1.408"></a><span id="l1.408">         newIdentityList = key;</span>
<a href="#l1.409"></a><span id="l1.409" class="difflineminus">-      }</span>
<a href="#l1.410"></a><span id="l1.410" class="difflineminus">-      else</span>
<a href="#l1.411"></a><span id="l1.411" class="difflineminus">-      {</span>
<a href="#l1.412"></a><span id="l1.412" class="difflineplus">+      } else {</span>
<a href="#l1.413"></a><span id="l1.413">         newIdentityList.Append(',');</span>
<a href="#l1.414"></a><span id="l1.414">         newIdentityList.Append(key);</span>
<a href="#l1.415"></a><span id="l1.415">       }</span>
<a href="#l1.416"></a><span id="l1.416">     }</span>
<a href="#l1.417"></a><span id="l1.417">   }</span>
<a href="#l1.418"></a><span id="l1.418"> </span>
<a href="#l1.419"></a><span id="l1.419">   // Save the pref.</span>
<a href="#l1.420"></a><span id="l1.420">   m_prefs-&gt;SetCharPref(&quot;identities&quot;, newIdentityList);</span>
<a href="#l1.421"></a><span id="l1.421"> </span>
<a href="#l1.422"></a><span id="l1.422">   return NS_OK;</span>
<a href="#l1.423"></a><span id="l1.423"> }</span>
<a href="#l1.424"></a><span id="l1.424"> </span>
<a href="#l1.425"></a><span id="l1.425" class="difflineminus">-NS_IMETHODIMP nsMsgAccount::GetKey(nsACString&amp; accountKey)</span>
<a href="#l1.426"></a><span id="l1.426" class="difflineminus">-{</span>
<a href="#l1.427"></a><span id="l1.427" class="difflineplus">+NS_IMETHODIMP nsMsgAccount::GetKey(nsACString &amp;accountKey) {</span>
<a href="#l1.428"></a><span id="l1.428">   accountKey = m_accountKey;</span>
<a href="#l1.429"></a><span id="l1.429">   return NS_OK;</span>
<a href="#l1.430"></a><span id="l1.430"> }</span>
<a href="#l1.431"></a><span id="l1.431"> </span>
<a href="#l1.432"></a><span id="l1.432"> NS_IMETHODIMP</span>
<a href="#l1.433"></a><span id="l1.433" class="difflineminus">-nsMsgAccount::SetKey(const nsACString&amp; accountKey)</span>
<a href="#l1.434"></a><span id="l1.434" class="difflineminus">-{</span>
<a href="#l1.435"></a><span id="l1.435" class="difflineplus">+nsMsgAccount::SetKey(const nsACString &amp;accountKey) {</span>
<a href="#l1.436"></a><span id="l1.436">   m_accountKey = accountKey;</span>
<a href="#l1.437"></a><span id="l1.437">   m_prefs = nullptr;</span>
<a href="#l1.438"></a><span id="l1.438">   m_identities = nullptr;</span>
<a href="#l1.439"></a><span id="l1.439">   return createIdentities();</span>
<a href="#l1.440"></a><span id="l1.440"> }</span>
<a href="#l1.441"></a><span id="l1.441"> </span>
<a href="#l1.442"></a><span id="l1.442"> NS_IMETHODIMP</span>
<a href="#l1.443"></a><span id="l1.443" class="difflineminus">-nsMsgAccount::ToString(nsAString&amp; aResult)</span>
<a href="#l1.444"></a><span id="l1.444" class="difflineminus">-{</span>
<a href="#l1.445"></a><span id="l1.445" class="difflineplus">+nsMsgAccount::ToString(nsAString &amp;aResult) {</span>
<a href="#l1.446"></a><span id="l1.446">   nsAutoString val;</span>
<a href="#l1.447"></a><span id="l1.447">   aResult.AssignLiteral(&quot;[nsIMsgAccount: &quot;);</span>
<a href="#l1.448"></a><span id="l1.448">   aResult.Append(NS_ConvertASCIItoUTF16(m_accountKey));</span>
<a href="#l1.449"></a><span id="l1.449">   aResult.Append(']');</span>
<a href="#l1.450"></a><span id="l1.450">   return NS_OK;</span>
<a href="#l1.451"></a><span id="l1.451"> }</span>
<a href="#l1.452"></a><span id="l1.452"> </span>
<a href="#l1.453"></a><span id="l1.453"> NS_IMETHODIMP</span>
<a href="#l1.454"></a><span id="l1.454" class="difflineminus">-nsMsgAccount::ClearAllValues()</span>
<a href="#l1.455"></a><span id="l1.455" class="difflineminus">-{</span>
<a href="#l1.456"></a><span id="l1.456" class="difflineplus">+nsMsgAccount::ClearAllValues() {</span>
<a href="#l1.457"></a><span id="l1.457">   nsresult rv = getPrefService();</span>
<a href="#l1.458"></a><span id="l1.458">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.459"></a><span id="l1.459"> </span>
<a href="#l1.460"></a><span id="l1.460">   return m_prefs-&gt;DeleteBranch(&quot;&quot;);</span>
<a href="#l1.461"></a><span id="l1.461"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/base/src/nsMsgAccount.h</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgAccount.h</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -4,35 +4,32 @@</span>
<a href="#l2.4"></a><span id="l2.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l2.5"></a><span id="l2.5"> </span>
<a href="#l2.6"></a><span id="l2.6"> #include &quot;nscore.h&quot;</span>
<a href="#l2.7"></a><span id="l2.7"> #include &quot;nsIMsgAccount.h&quot;</span>
<a href="#l2.8"></a><span id="l2.8"> #include &quot;nsIPrefBranch.h&quot;</span>
<a href="#l2.9"></a><span id="l2.9"> #include &quot;nsString.h&quot;</span>
<a href="#l2.10"></a><span id="l2.10"> #include &quot;nsIMutableArray.h&quot;</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-class nsMsgAccount : public nsIMsgAccount</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-{</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineminus">-</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineminus">-public:</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+class nsMsgAccount : public nsIMsgAccount {</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineplus">+ public:</span>
<a href="#l2.18"></a><span id="l2.18">   nsMsgAccount();</span>
<a href="#l2.19"></a><span id="l2.19"> </span>
<a href="#l2.20"></a><span id="l2.20">   NS_DECL_ISUPPORTS</span>
<a href="#l2.21"></a><span id="l2.21">   NS_DECL_NSIMSGACCOUNT</span>
<a href="#l2.22"></a><span id="l2.22"> </span>
<a href="#l2.23"></a><span id="l2.23" class="difflineminus">-private:</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineplus">+ private:</span>
<a href="#l2.25"></a><span id="l2.25">   virtual ~nsMsgAccount();</span>
<a href="#l2.26"></a><span id="l2.26">   nsCString m_accountKey;</span>
<a href="#l2.27"></a><span id="l2.27">   nsCOMPtr&lt;nsIPrefBranch&gt; m_prefs;</span>
<a href="#l2.28"></a><span id="l2.28">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; m_incomingServer;</span>
<a href="#l2.29"></a><span id="l2.29"> </span>
<a href="#l2.30"></a><span id="l2.30">   nsCOMPtr&lt;nsIMutableArray&gt; m_identities;</span>
<a href="#l2.31"></a><span id="l2.31"> </span>
<a href="#l2.32"></a><span id="l2.32">   nsresult getPrefService();</span>
<a href="#l2.33"></a><span id="l2.33">   nsresult createIncomingServer();</span>
<a href="#l2.34"></a><span id="l2.34">   nsresult createIdentities();</span>
<a href="#l2.35"></a><span id="l2.35">   nsresult saveIdentitiesPref();</span>
<a href="#l2.36"></a><span id="l2.36">   nsresult addIdentityInternal(nsIMsgIdentity* identity);</span>
<a href="#l2.37"></a><span id="l2.37"> </span>
<a href="#l2.38"></a><span id="l2.38">   // Have we tried to get the server yet?</span>
<a href="#l2.39"></a><span id="l2.39">   bool mTriedToGetServer;</span>
<a href="#l2.40"></a><span id="l2.40"> };</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/base/src/nsMsgAccountManager.cpp</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgAccountManager.cpp</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -64,236 +64,219 @@</span>
<a href="#l3.4"></a><span id="l3.4"> #include &quot;nsIMsgFilterList.h&quot;</span>
<a href="#l3.5"></a><span id="l3.5"> #include &quot;nsDirectoryServiceUtils.h&quot;</span>
<a href="#l3.6"></a><span id="l3.6"> #include &quot;mozilla/Services.h&quot;</span>
<a href="#l3.7"></a><span id="l3.7"> #include &quot;nsIFileStreams.h&quot;</span>
<a href="#l3.8"></a><span id="l3.8"> #include &quot;nsIOutputStream.h&quot;</span>
<a href="#l3.9"></a><span id="l3.9"> #include &quot;nsISafeOutputStream.h&quot;</span>
<a href="#l3.10"></a><span id="l3.10"> </span>
<a href="#l3.11"></a><span id="l3.11"> #define PREF_MAIL_ACCOUNTMANAGER_ACCOUNTS &quot;mail.accountmanager.accounts&quot;</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-#define PREF_MAIL_ACCOUNTMANAGER_DEFAULTACCOUNT &quot;mail.accountmanager.defaultaccount&quot;</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-#define PREF_MAIL_ACCOUNTMANAGER_LOCALFOLDERSSERVER &quot;mail.accountmanager.localfoldersserver&quot;</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+#define PREF_MAIL_ACCOUNTMANAGER_DEFAULTACCOUNT \</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+  &quot;mail.accountmanager.defaultaccount&quot;</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+#define PREF_MAIL_ACCOUNTMANAGER_LOCALFOLDERSSERVER \</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+  &quot;mail.accountmanager.localfoldersserver&quot;</span>
<a href="#l3.18"></a><span id="l3.18"> #define PREF_MAIL_SERVER_PREFIX &quot;mail.server.&quot;</span>
<a href="#l3.19"></a><span id="l3.19"> #define ACCOUNT_PREFIX &quot;account&quot;</span>
<a href="#l3.20"></a><span id="l3.20"> #define SERVER_PREFIX &quot;server&quot;</span>
<a href="#l3.21"></a><span id="l3.21"> #define ID_PREFIX &quot;id&quot;</span>
<a href="#l3.22"></a><span id="l3.22"> #define ABOUT_TO_GO_OFFLINE_TOPIC &quot;network:offline-about-to-go-offline&quot;</span>
<a href="#l3.23"></a><span id="l3.23"> #define ACCOUNT_DELIMITER ','</span>
<a href="#l3.24"></a><span id="l3.24"> #define APPEND_ACCOUNTS_VERSION_PREF_NAME &quot;append_preconfig_accounts.version&quot;</span>
<a href="#l3.25"></a><span id="l3.25"> #define MAILNEWS_ROOT_PREF &quot;mailnews.&quot;</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineminus">-#define PREF_MAIL_ACCOUNTMANAGER_APPEND_ACCOUNTS &quot;mail.accountmanager.appendaccounts&quot;</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineplus">+#define PREF_MAIL_ACCOUNTMANAGER_APPEND_ACCOUNTS \</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineplus">+  &quot;mail.accountmanager.appendaccounts&quot;</span>
<a href="#l3.29"></a><span id="l3.29"> </span>
<a href="#l3.30"></a><span id="l3.30"> static NS_DEFINE_CID(kMsgAccountCID, NS_MSGACCOUNT_CID);</span>
<a href="#l3.31"></a><span id="l3.31"> static NS_DEFINE_CID(kMsgFolderCacheCID, NS_MSGFOLDERCACHE_CID);</span>
<a href="#l3.32"></a><span id="l3.32"> </span>
<a href="#l3.33"></a><span id="l3.33"> #define SEARCH_FOLDER_FLAG &quot;searchFolderFlag&quot;</span>
<a href="#l3.34"></a><span id="l3.34"> #define SEARCH_FOLDER_FLAG_LEN (sizeof(SEARCH_FOLDER_FLAG) - 1)</span>
<a href="#l3.35"></a><span id="l3.35"> </span>
<a href="#l3.36"></a><span id="l3.36"> const char *kSearchFolderUriProp = &quot;searchFolderUri&quot;;</span>
<a href="#l3.37"></a><span id="l3.37"> </span>
<a href="#l3.38"></a><span id="l3.38"> bool nsMsgAccountManager::m_haveShutdown = false;</span>
<a href="#l3.39"></a><span id="l3.39"> bool nsMsgAccountManager::m_shutdownInProgress = false;</span>
<a href="#l3.40"></a><span id="l3.40"> </span>
<a href="#l3.41"></a><span id="l3.41" class="difflineminus">-NS_IMPL_ISUPPORTS(nsMsgAccountManager,</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineminus">-                              nsIMsgAccountManager,</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineminus">-                              nsIObserver,</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineminus">-                              nsISupportsWeakReference,</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineminus">-                              nsIUrlListener,</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineminus">-                              nsIFolderListener)</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineminus">-</span>
<a href="#l3.48"></a><span id="l3.48" class="difflineminus">-nsMsgAccountManager::nsMsgAccountManager() :</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineminus">-  m_accountsLoaded(false),</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineminus">-  m_emptyTrashInProgress(false),</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineminus">-  m_cleanupInboxInProgress(false),</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineminus">-  m_userAuthenticated(false),</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineminus">-  m_loadingVirtualFolders(false),</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineminus">-  m_virtualFoldersLoaded(false)</span>
<a href="#l3.55"></a><span id="l3.55" class="difflineminus">-{</span>
<a href="#l3.56"></a><span id="l3.56" class="difflineminus">-}</span>
<a href="#l3.57"></a><span id="l3.57" class="difflineminus">-</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineminus">-nsMsgAccountManager::~nsMsgAccountManager()</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineminus">-{</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineminus">-  if(!m_haveShutdown)</span>
<a href="#l3.61"></a><span id="l3.61" class="difflineminus">-  {</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineplus">+NS_IMPL_ISUPPORTS(nsMsgAccountManager, nsIMsgAccountManager, nsIObserver,</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineplus">+                  nsISupportsWeakReference, nsIUrlListener, nsIFolderListener)</span>
<a href="#l3.64"></a><span id="l3.64" class="difflineplus">+</span>
<a href="#l3.65"></a><span id="l3.65" class="difflineplus">+nsMsgAccountManager::nsMsgAccountManager()</span>
<a href="#l3.66"></a><span id="l3.66" class="difflineplus">+    : m_accountsLoaded(false),</span>
<a href="#l3.67"></a><span id="l3.67" class="difflineplus">+      m_emptyTrashInProgress(false),</span>
<a href="#l3.68"></a><span id="l3.68" class="difflineplus">+      m_cleanupInboxInProgress(false),</span>
<a href="#l3.69"></a><span id="l3.69" class="difflineplus">+      m_userAuthenticated(false),</span>
<a href="#l3.70"></a><span id="l3.70" class="difflineplus">+      m_loadingVirtualFolders(false),</span>
<a href="#l3.71"></a><span id="l3.71" class="difflineplus">+      m_virtualFoldersLoaded(false) {}</span>
<a href="#l3.72"></a><span id="l3.72" class="difflineplus">+</span>
<a href="#l3.73"></a><span id="l3.73" class="difflineplus">+nsMsgAccountManager::~nsMsgAccountManager() {</span>
<a href="#l3.74"></a><span id="l3.74" class="difflineplus">+  if (!m_haveShutdown) {</span>
<a href="#l3.75"></a><span id="l3.75">     Shutdown();</span>
<a href="#l3.76"></a><span id="l3.76" class="difflineminus">-    //Don't remove from Observer service in Shutdown because Shutdown also gets called</span>
<a href="#l3.77"></a><span id="l3.77" class="difflineminus">-    //from xpcom shutdown observer.  And we don't want to remove from the service in that case.</span>
<a href="#l3.78"></a><span id="l3.78" class="difflineplus">+    // Don't remove from Observer service in Shutdown because Shutdown also gets</span>
<a href="#l3.79"></a><span id="l3.79" class="difflineplus">+    // called from xpcom shutdown observer.  And we don't want to remove from</span>
<a href="#l3.80"></a><span id="l3.80" class="difflineplus">+    // the service in that case.</span>
<a href="#l3.81"></a><span id="l3.81">     nsCOMPtr&lt;nsIObserverService&gt; observerService =</span>
<a href="#l3.82"></a><span id="l3.82" class="difflineminus">-      mozilla::services::GetObserverService();</span>
<a href="#l3.83"></a><span id="l3.83" class="difflineminus">-    if (observerService)</span>
<a href="#l3.84"></a><span id="l3.84" class="difflineminus">-    {</span>
<a href="#l3.85"></a><span id="l3.85" class="difflineplus">+        mozilla::services::GetObserverService();</span>
<a href="#l3.86"></a><span id="l3.86" class="difflineplus">+    if (observerService) {</span>
<a href="#l3.87"></a><span id="l3.87">       observerService-&gt;RemoveObserver(this, NS_XPCOM_SHUTDOWN_OBSERVER_ID);</span>
<a href="#l3.88"></a><span id="l3.88">       observerService-&gt;RemoveObserver(this, &quot;quit-application-granted&quot;);</span>
<a href="#l3.89"></a><span id="l3.89">       observerService-&gt;RemoveObserver(this, ABOUT_TO_GO_OFFLINE_TOPIC);</span>
<a href="#l3.90"></a><span id="l3.90">       observerService-&gt;RemoveObserver(this, &quot;sleep_notification&quot;);</span>
<a href="#l3.91"></a><span id="l3.91">     }</span>
<a href="#l3.92"></a><span id="l3.92">   }</span>
<a href="#l3.93"></a><span id="l3.93"> }</span>
<a href="#l3.94"></a><span id="l3.94"> </span>
<a href="#l3.95"></a><span id="l3.95" class="difflineminus">-nsresult nsMsgAccountManager::Init()</span>
<a href="#l3.96"></a><span id="l3.96" class="difflineminus">-{</span>
<a href="#l3.97"></a><span id="l3.97" class="difflineplus">+nsresult nsMsgAccountManager::Init() {</span>
<a href="#l3.98"></a><span id="l3.98">   nsresult rv;</span>
<a href="#l3.99"></a><span id="l3.99"> </span>
<a href="#l3.100"></a><span id="l3.100">   m_prefs = do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l3.101"></a><span id="l3.101">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.102"></a><span id="l3.102"> </span>
<a href="#l3.103"></a><span id="l3.103">   nsCOMPtr&lt;nsIObserverService&gt; observerService =</span>
<a href="#l3.104"></a><span id="l3.104" class="difflineminus">-           mozilla::services::GetObserverService();</span>
<a href="#l3.105"></a><span id="l3.105" class="difflineminus">-  if (observerService)</span>
<a href="#l3.106"></a><span id="l3.106" class="difflineminus">-  {</span>
<a href="#l3.107"></a><span id="l3.107" class="difflineplus">+      mozilla::services::GetObserverService();</span>
<a href="#l3.108"></a><span id="l3.108" class="difflineplus">+  if (observerService) {</span>
<a href="#l3.109"></a><span id="l3.109">     observerService-&gt;AddObserver(this, NS_XPCOM_SHUTDOWN_OBSERVER_ID, true);</span>
<a href="#l3.110"></a><span id="l3.110" class="difflineminus">-    observerService-&gt;AddObserver(this, &quot;quit-application-granted&quot; , true);</span>
<a href="#l3.111"></a><span id="l3.111" class="difflineplus">+    observerService-&gt;AddObserver(this, &quot;quit-application-granted&quot;, true);</span>
<a href="#l3.112"></a><span id="l3.112">     observerService-&gt;AddObserver(this, ABOUT_TO_GO_OFFLINE_TOPIC, true);</span>
<a href="#l3.113"></a><span id="l3.113">     observerService-&gt;AddObserver(this, &quot;profile-before-change&quot;, true);</span>
<a href="#l3.114"></a><span id="l3.114">     observerService-&gt;AddObserver(this, &quot;sleep_notification&quot;, true);</span>
<a href="#l3.115"></a><span id="l3.115">   }</span>
<a href="#l3.116"></a><span id="l3.116"> </span>
<a href="#l3.117"></a><span id="l3.117">   // Make sure PSM gets initialized before any accounts use certificates.</span>
<a href="#l3.118"></a><span id="l3.118">   net_EnsurePSMInit();</span>
<a href="#l3.119"></a><span id="l3.119"> </span>
<a href="#l3.120"></a><span id="l3.120">   return NS_OK;</span>
<a href="#l3.121"></a><span id="l3.121"> }</span>
<a href="#l3.122"></a><span id="l3.122"> </span>
<a href="#l3.123"></a><span id="l3.123" class="difflineminus">-nsresult nsMsgAccountManager::Shutdown()</span>
<a href="#l3.124"></a><span id="l3.124" class="difflineminus">-{</span>
<a href="#l3.125"></a><span id="l3.125" class="difflineminus">-  if (m_haveShutdown)     // do not shutdown twice</span>
<a href="#l3.126"></a><span id="l3.126" class="difflineplus">+nsresult nsMsgAccountManager::Shutdown() {</span>
<a href="#l3.127"></a><span id="l3.127" class="difflineplus">+  if (m_haveShutdown)  // do not shutdown twice</span>
<a href="#l3.128"></a><span id="l3.128">     return NS_OK;</span>
<a href="#l3.129"></a><span id="l3.129"> </span>
<a href="#l3.130"></a><span id="l3.130">   nsresult rv;</span>
<a href="#l3.131"></a><span id="l3.131"> </span>
<a href="#l3.132"></a><span id="l3.132">   SaveVirtualFolders();</span>
<a href="#l3.133"></a><span id="l3.133"> </span>
<a href="#l3.134"></a><span id="l3.134" class="difflineminus">-  nsCOMPtr&lt;nsIMsgDBService&gt; msgDBService = do_GetService(NS_MSGDB_SERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l3.135"></a><span id="l3.135" class="difflineminus">-  if (msgDBService)</span>
<a href="#l3.136"></a><span id="l3.136" class="difflineminus">-  {</span>
<a href="#l3.137"></a><span id="l3.137" class="difflineminus">-    nsTObserverArray&lt;RefPtr&lt;VirtualFolderChangeListener&gt; &gt;::ForwardIterator iter(m_virtualFolderListeners);</span>
<a href="#l3.138"></a><span id="l3.138" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDBService&gt; msgDBService =</span>
<a href="#l3.139"></a><span id="l3.139" class="difflineplus">+      do_GetService(NS_MSGDB_SERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l3.140"></a><span id="l3.140" class="difflineplus">+  if (msgDBService) {</span>
<a href="#l3.141"></a><span id="l3.141" class="difflineplus">+    nsTObserverArray&lt;RefPtr&lt;VirtualFolderChangeListener&gt; &gt;::ForwardIterator</span>
<a href="#l3.142"></a><span id="l3.142" class="difflineplus">+        iter(m_virtualFolderListeners);</span>
<a href="#l3.143"></a><span id="l3.143">     RefPtr&lt;VirtualFolderChangeListener&gt; listener;</span>
<a href="#l3.144"></a><span id="l3.144"> </span>
<a href="#l3.145"></a><span id="l3.145" class="difflineminus">-    while (iter.HasMore())</span>
<a href="#l3.146"></a><span id="l3.146" class="difflineminus">-    {</span>
<a href="#l3.147"></a><span id="l3.147" class="difflineplus">+    while (iter.HasMore()) {</span>
<a href="#l3.148"></a><span id="l3.148">       listener = iter.GetNext();</span>
<a href="#l3.149"></a><span id="l3.149">       msgDBService-&gt;UnregisterPendingListener(listener);</span>
<a href="#l3.150"></a><span id="l3.150">     }</span>
<a href="#l3.151"></a><span id="l3.151">   }</span>
<a href="#l3.152"></a><span id="l3.152" class="difflineminus">-  if(m_msgFolderCache)</span>
<a href="#l3.153"></a><span id="l3.153" class="difflineminus">-    WriteToFolderCache(m_msgFolderCache);</span>
<a href="#l3.154"></a><span id="l3.154" class="difflineplus">+  if (m_msgFolderCache) WriteToFolderCache(m_msgFolderCache);</span>
<a href="#l3.155"></a><span id="l3.155">   (void)ShutdownServers();</span>
<a href="#l3.156"></a><span id="l3.156">   (void)UnloadAccounts();</span>
<a href="#l3.157"></a><span id="l3.157"> </span>
<a href="#l3.158"></a><span id="l3.158" class="difflineminus">-  //shutdown removes nsIIncomingServer listener from biff manager, so do it after accounts have been unloaded</span>
<a href="#l3.159"></a><span id="l3.159" class="difflineminus">-  nsCOMPtr&lt;nsIMsgBiffManager&gt; biffService = do_GetService(NS_MSGBIFFMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l3.160"></a><span id="l3.160" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; biffService)</span>
<a href="#l3.161"></a><span id="l3.161" class="difflineminus">-    biffService-&gt;Shutdown();</span>
<a href="#l3.162"></a><span id="l3.162" class="difflineminus">-</span>
<a href="#l3.163"></a><span id="l3.163" class="difflineminus">-  //shutdown removes nsIIncomingServer listener from purge service, so do it after accounts have been unloaded</span>
<a href="#l3.164"></a><span id="l3.164" class="difflineminus">-  nsCOMPtr&lt;nsIMsgPurgeService&gt; purgeService = do_GetService(NS_MSGPURGESERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l3.165"></a><span id="l3.165" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; purgeService)</span>
<a href="#l3.166"></a><span id="l3.166" class="difflineminus">-    purgeService-&gt;Shutdown();</span>
<a href="#l3.167"></a><span id="l3.167" class="difflineplus">+  // shutdown removes nsIIncomingServer listener from biff manager, so do it</span>
<a href="#l3.168"></a><span id="l3.168" class="difflineplus">+  // after accounts have been unloaded</span>
<a href="#l3.169"></a><span id="l3.169" class="difflineplus">+  nsCOMPtr&lt;nsIMsgBiffManager&gt; biffService =</span>
<a href="#l3.170"></a><span id="l3.170" class="difflineplus">+      do_GetService(NS_MSGBIFFMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l3.171"></a><span id="l3.171" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; biffService) biffService-&gt;Shutdown();</span>
<a href="#l3.172"></a><span id="l3.172" class="difflineplus">+</span>
<a href="#l3.173"></a><span id="l3.173" class="difflineplus">+  // shutdown removes nsIIncomingServer listener from purge service, so do it</span>
<a href="#l3.174"></a><span id="l3.174" class="difflineplus">+  // after accounts have been unloaded</span>
<a href="#l3.175"></a><span id="l3.175" class="difflineplus">+  nsCOMPtr&lt;nsIMsgPurgeService&gt; purgeService =</span>
<a href="#l3.176"></a><span id="l3.176" class="difflineplus">+      do_GetService(NS_MSGPURGESERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l3.177"></a><span id="l3.177" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; purgeService) purgeService-&gt;Shutdown();</span>
<a href="#l3.178"></a><span id="l3.178"> </span>
<a href="#l3.179"></a><span id="l3.179">   m_msgFolderCache = nullptr;</span>
<a href="#l3.180"></a><span id="l3.180">   m_haveShutdown = true;</span>
<a href="#l3.181"></a><span id="l3.181">   return NS_OK;</span>
<a href="#l3.182"></a><span id="l3.182"> }</span>
<a href="#l3.183"></a><span id="l3.183"> </span>
<a href="#l3.184"></a><span id="l3.184"> NS_IMETHODIMP</span>
<a href="#l3.185"></a><span id="l3.185" class="difflineminus">-nsMsgAccountManager::GetShutdownInProgress(bool *_retval)</span>
<a href="#l3.186"></a><span id="l3.186" class="difflineminus">-{</span>
<a href="#l3.187"></a><span id="l3.187" class="difflineminus">-    NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l3.188"></a><span id="l3.188" class="difflineminus">-    *_retval = m_shutdownInProgress;</span>
<a href="#l3.189"></a><span id="l3.189" class="difflineminus">-    return NS_OK;</span>
<a href="#l3.190"></a><span id="l3.190" class="difflineplus">+nsMsgAccountManager::GetShutdownInProgress(bool *_retval) {</span>
<a href="#l3.191"></a><span id="l3.191" class="difflineplus">+  NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l3.192"></a><span id="l3.192" class="difflineplus">+  *_retval = m_shutdownInProgress;</span>
<a href="#l3.193"></a><span id="l3.193" class="difflineplus">+  return NS_OK;</span>
<a href="#l3.194"></a><span id="l3.194"> }</span>
<a href="#l3.195"></a><span id="l3.195"> </span>
<a href="#l3.196"></a><span id="l3.196"> NS_IMETHODIMP</span>
<a href="#l3.197"></a><span id="l3.197" class="difflineminus">-nsMsgAccountManager::GetUserNeedsToAuthenticate(bool *aRetval)</span>
<a href="#l3.198"></a><span id="l3.198" class="difflineminus">-{</span>
<a href="#l3.199"></a><span id="l3.199" class="difflineplus">+nsMsgAccountManager::GetUserNeedsToAuthenticate(bool *aRetval) {</span>
<a href="#l3.200"></a><span id="l3.200">   NS_ENSURE_ARG_POINTER(aRetval);</span>
<a href="#l3.201"></a><span id="l3.201">   if (!m_userAuthenticated)</span>
<a href="#l3.202"></a><span id="l3.202">     return m_prefs-&gt;GetBoolPref(&quot;mail.password_protect_local_cache&quot;, aRetval);</span>
<a href="#l3.203"></a><span id="l3.203">   *aRetval = !m_userAuthenticated;</span>
<a href="#l3.204"></a><span id="l3.204">   return NS_OK;</span>
<a href="#l3.205"></a><span id="l3.205"> }</span>
<a href="#l3.206"></a><span id="l3.206"> </span>
<a href="#l3.207"></a><span id="l3.207"> NS_IMETHODIMP</span>
<a href="#l3.208"></a><span id="l3.208" class="difflineminus">-nsMsgAccountManager::SetUserNeedsToAuthenticate(bool aUserNeedsToAuthenticate)</span>
<a href="#l3.209"></a><span id="l3.209" class="difflineminus">-{</span>
<a href="#l3.210"></a><span id="l3.210" class="difflineplus">+nsMsgAccountManager::SetUserNeedsToAuthenticate(bool aUserNeedsToAuthenticate) {</span>
<a href="#l3.211"></a><span id="l3.211">   m_userAuthenticated = !aUserNeedsToAuthenticate;</span>
<a href="#l3.212"></a><span id="l3.212">   return NS_OK;</span>
<a href="#l3.213"></a><span id="l3.213"> }</span>
<a href="#l3.214"></a><span id="l3.214"> </span>
<a href="#l3.215"></a><span id="l3.215" class="difflineminus">-NS_IMETHODIMP nsMsgAccountManager::Observe(nsISupports *aSubject, const char *aTopic, const char16_t *someData)</span>
<a href="#l3.216"></a><span id="l3.216" class="difflineminus">-{</span>
<a href="#l3.217"></a><span id="l3.217" class="difflineminus">-  if(!strcmp(aTopic,NS_XPCOM_SHUTDOWN_OBSERVER_ID))</span>
<a href="#l3.218"></a><span id="l3.218" class="difflineminus">-  {</span>
<a href="#l3.219"></a><span id="l3.219" class="difflineplus">+NS_IMETHODIMP nsMsgAccountManager::Observe(nsISupports *aSubject,</span>
<a href="#l3.220"></a><span id="l3.220" class="difflineplus">+                                           const char *aTopic,</span>
<a href="#l3.221"></a><span id="l3.221" class="difflineplus">+                                           const char16_t *someData) {</span>
<a href="#l3.222"></a><span id="l3.222" class="difflineplus">+  if (!strcmp(aTopic, NS_XPCOM_SHUTDOWN_OBSERVER_ID)) {</span>
<a href="#l3.223"></a><span id="l3.223">     Shutdown();</span>
<a href="#l3.224"></a><span id="l3.224">     return NS_OK;</span>
<a href="#l3.225"></a><span id="l3.225">   }</span>
<a href="#l3.226"></a><span id="l3.226" class="difflineminus">-  if (!strcmp(aTopic, &quot;quit-application-granted&quot;))</span>
<a href="#l3.227"></a><span id="l3.227" class="difflineminus">-  {</span>
<a href="#l3.228"></a><span id="l3.228" class="difflineplus">+  if (!strcmp(aTopic, &quot;quit-application-granted&quot;)) {</span>
<a href="#l3.229"></a><span id="l3.229">     // CleanupOnExit will set m_shutdownInProgress to true.</span>
<a href="#l3.230"></a><span id="l3.230">     CleanupOnExit();</span>
<a href="#l3.231"></a><span id="l3.231">     return NS_OK;</span>
<a href="#l3.232"></a><span id="l3.232">   }</span>
<a href="#l3.233"></a><span id="l3.233" class="difflineminus">-  if (!strcmp(aTopic, ABOUT_TO_GO_OFFLINE_TOPIC))</span>
<a href="#l3.234"></a><span id="l3.234" class="difflineminus">-  {</span>
<a href="#l3.235"></a><span id="l3.235" class="difflineplus">+  if (!strcmp(aTopic, ABOUT_TO_GO_OFFLINE_TOPIC)) {</span>
<a href="#l3.236"></a><span id="l3.236">     nsAutoString dataString(NS_LITERAL_STRING(&quot;offline&quot;));</span>
<a href="#l3.237"></a><span id="l3.237" class="difflineminus">-    if (someData)</span>
<a href="#l3.238"></a><span id="l3.238" class="difflineminus">-    {</span>
<a href="#l3.239"></a><span id="l3.239" class="difflineplus">+    if (someData) {</span>
<a href="#l3.240"></a><span id="l3.240">       nsAutoString someDataString(someData);</span>
<a href="#l3.241"></a><span id="l3.241" class="difflineminus">-      if (dataString.Equals(someDataString))</span>
<a href="#l3.242"></a><span id="l3.242" class="difflineminus">-        CloseCachedConnections();</span>
<a href="#l3.243"></a><span id="l3.243" class="difflineplus">+      if (dataString.Equals(someDataString)) CloseCachedConnections();</span>
<a href="#l3.244"></a><span id="l3.244">     }</span>
<a href="#l3.245"></a><span id="l3.245">     return NS_OK;</span>
<a href="#l3.246"></a><span id="l3.246">   }</span>
<a href="#l3.247"></a><span id="l3.247" class="difflineminus">-  if (!strcmp(aTopic, &quot;sleep_notification&quot;))</span>
<a href="#l3.248"></a><span id="l3.248" class="difflineminus">-    return CloseCachedConnections();</span>
<a href="#l3.249"></a><span id="l3.249" class="difflineminus">-</span>
<a href="#l3.250"></a><span id="l3.250" class="difflineminus">-  if (!strcmp(aTopic, &quot;profile-before-change&quot;))</span>
<a href="#l3.251"></a><span id="l3.251" class="difflineminus">-  {</span>
<a href="#l3.252"></a><span id="l3.252" class="difflineplus">+  if (!strcmp(aTopic, &quot;sleep_notification&quot;)) return CloseCachedConnections();</span>
<a href="#l3.253"></a><span id="l3.253" class="difflineplus">+</span>
<a href="#l3.254"></a><span id="l3.254" class="difflineplus">+  if (!strcmp(aTopic, &quot;profile-before-change&quot;)) {</span>
<a href="#l3.255"></a><span id="l3.255">     Shutdown();</span>
<a href="#l3.256"></a><span id="l3.256">     return NS_OK;</span>
<a href="#l3.257"></a><span id="l3.257">   }</span>
<a href="#l3.258"></a><span id="l3.258"> </span>
<a href="#l3.259"></a><span id="l3.259" class="difflineminus">- return NS_OK;</span>
<a href="#l3.260"></a><span id="l3.260" class="difflineplus">+  return NS_OK;</span>
<a href="#l3.261"></a><span id="l3.261"> }</span>
<a href="#l3.262"></a><span id="l3.262"> </span>
<a href="#l3.263"></a><span id="l3.263" class="difflineminus">-void</span>
<a href="#l3.264"></a><span id="l3.264" class="difflineminus">-nsMsgAccountManager::getUniqueAccountKey(nsCString&amp; aResult)</span>
<a href="#l3.265"></a><span id="l3.265" class="difflineminus">-{</span>
<a href="#l3.266"></a><span id="l3.266" class="difflineplus">+void nsMsgAccountManager::getUniqueAccountKey(nsCString &amp;aResult) {</span>
<a href="#l3.267"></a><span id="l3.267">   int32_t lastKey = 0;</span>
<a href="#l3.268"></a><span id="l3.268">   nsresult rv;</span>
<a href="#l3.269"></a><span id="l3.269" class="difflineminus">-  nsCOMPtr&lt;nsIPrefService&gt; prefservice(do_GetService(NS_PREFSERVICE_CONTRACTID,</span>
<a href="#l3.270"></a><span id="l3.270" class="difflineminus">-                                       &amp;rv));</span>
<a href="#l3.271"></a><span id="l3.271" class="difflineplus">+  nsCOMPtr&lt;nsIPrefService&gt; prefservice(</span>
<a href="#l3.272"></a><span id="l3.272" class="difflineplus">+      do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l3.273"></a><span id="l3.273">   if (NS_SUCCEEDED(rv)) {</span>
<a href="#l3.274"></a><span id="l3.274">     nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch;</span>
<a href="#l3.275"></a><span id="l3.275">     prefservice-&gt;GetBranch(&quot;&quot;, getter_AddRefs(prefBranch));</span>
<a href="#l3.276"></a><span id="l3.276"> </span>
<a href="#l3.277"></a><span id="l3.277">     rv = prefBranch-&gt;GetIntPref(&quot;mail.account.lastKey&quot;, &amp;lastKey);</span>
<a href="#l3.278"></a><span id="l3.278">     if (NS_FAILED(rv) || lastKey == 0) {</span>
<a href="#l3.279"></a><span id="l3.279">       // If lastKey pref does not contain a valid value, loop over existing</span>
<a href="#l3.280"></a><span id="l3.280">       // pref names mail.account.* .</span>
<a href="#l3.281"></a><span id="l3.281">       nsCOMPtr&lt;nsIPrefBranch&gt; prefBranchAccount;</span>
<a href="#l3.282"></a><span id="l3.282" class="difflineminus">-      rv = prefservice-&gt;GetBranch(&quot;mail.account.&quot;, getter_AddRefs(prefBranchAccount));</span>
<a href="#l3.283"></a><span id="l3.283" class="difflineplus">+      rv = prefservice-&gt;GetBranch(&quot;mail.account.&quot;,</span>
<a href="#l3.284"></a><span id="l3.284" class="difflineplus">+                                  getter_AddRefs(prefBranchAccount));</span>
<a href="#l3.285"></a><span id="l3.285">       if (NS_SUCCEEDED(rv)) {</span>
<a href="#l3.286"></a><span id="l3.286">         uint32_t prefCount;</span>
<a href="#l3.287"></a><span id="l3.287">         char **prefList;</span>
<a href="#l3.288"></a><span id="l3.288">         rv = prefBranchAccount-&gt;GetChildList(&quot;&quot;, &amp;prefCount, &amp;prefList);</span>
<a href="#l3.289"></a><span id="l3.289">         if (NS_SUCCEEDED(rv)) {</span>
<a href="#l3.290"></a><span id="l3.290">           // Pref names are of the format accountX.</span>
<a href="#l3.291"></a><span id="l3.291">           // Find the maximum value of 'X' used so far.</span>
<a href="#l3.292"></a><span id="l3.292">           for (uint32_t i = 0; i &lt; prefCount; i++) {</span>
<a href="#l3.293"></a><span id="l3.293">             nsCString prefName;</span>
<a href="#l3.294"></a><span id="l3.294">             prefName.Assign(prefList[i]);</span>
<a href="#l3.295"></a><span id="l3.295" class="difflineminus">-            if (StringBeginsWith(prefName, NS_LITERAL_CSTRING(ACCOUNT_PREFIX))) {</span>
<a href="#l3.296"></a><span id="l3.296" class="difflineplus">+            if (StringBeginsWith(prefName,</span>
<a href="#l3.297"></a><span id="l3.297" class="difflineplus">+                                 NS_LITERAL_CSTRING(ACCOUNT_PREFIX))) {</span>
<a href="#l3.298"></a><span id="l3.298">               int32_t dotPos = prefName.FindChar('.');</span>
<a href="#l3.299"></a><span id="l3.299">               if (dotPos != kNotFound) {</span>
<a href="#l3.300"></a><span id="l3.300">                 nsCString keyString(Substring(prefName, strlen(ACCOUNT_PREFIX),</span>
<a href="#l3.301"></a><span id="l3.301">                                               dotPos - strlen(ACCOUNT_PREFIX)));</span>
<a href="#l3.302"></a><span id="l3.302">                 int32_t thisKey = keyString.ToInteger(&amp;rv);</span>
<a href="#l3.303"></a><span id="l3.303" class="difflineminus">-                if (NS_SUCCEEDED(rv))</span>
<a href="#l3.304"></a><span id="l3.304" class="difflineminus">-                  lastKey = std::max(lastKey, thisKey);</span>
<a href="#l3.305"></a><span id="l3.305" class="difflineplus">+                if (NS_SUCCEEDED(rv)) lastKey = std::max(lastKey, thisKey);</span>
<a href="#l3.306"></a><span id="l3.306">               }</span>
<a href="#l3.307"></a><span id="l3.307">             }</span>
<a href="#l3.308"></a><span id="l3.308">           }</span>
<a href="#l3.309"></a><span id="l3.309">           NS_FREE_XPCOM_ALLOCATED_POINTER_ARRAY(prefCount, prefList);</span>
<a href="#l3.310"></a><span id="l3.310">         }</span>
<a href="#l3.311"></a><span id="l3.311">       }</span>
<a href="#l3.312"></a><span id="l3.312">     }</span>
<a href="#l3.313"></a><span id="l3.313"> </span>
<a href="#l3.314"></a><span id="l3.314" class="difflineat">@@ -310,174 +293,157 @@ nsMsgAccountManager::getUniqueAccountKey</span>
<a href="#l3.315"></a><span id="l3.315">     do {</span>
<a href="#l3.316"></a><span id="l3.316">       aResult = ACCOUNT_PREFIX;</span>
<a href="#l3.317"></a><span id="l3.317">       aResult.AppendInt(i++);</span>
<a href="#l3.318"></a><span id="l3.318">       GetAccount(aResult, getter_AddRefs(account));</span>
<a href="#l3.319"></a><span id="l3.319">     } while (account);</span>
<a href="#l3.320"></a><span id="l3.320">   }</span>
<a href="#l3.321"></a><span id="l3.321"> }</span>
<a href="#l3.322"></a><span id="l3.322"> </span>
<a href="#l3.323"></a><span id="l3.323" class="difflineminus">-void</span>
<a href="#l3.324"></a><span id="l3.324" class="difflineminus">-nsMsgAccountManager::GetUniqueServerKey(nsACString&amp; aResult)</span>
<a href="#l3.325"></a><span id="l3.325" class="difflineminus">-{</span>
<a href="#l3.326"></a><span id="l3.326" class="difflineplus">+void nsMsgAccountManager::GetUniqueServerKey(nsACString &amp;aResult) {</span>
<a href="#l3.327"></a><span id="l3.327">   nsAutoCString prefResult;</span>
<a href="#l3.328"></a><span id="l3.328">   bool usePrefsScan = true;</span>
<a href="#l3.329"></a><span id="l3.329">   nsresult rv;</span>
<a href="#l3.330"></a><span id="l3.330" class="difflineminus">-  nsCOMPtr&lt;nsIPrefService&gt; prefService(do_GetService(NS_PREFSERVICE_CONTRACTID,</span>
<a href="#l3.331"></a><span id="l3.331" class="difflineminus">-                                       &amp;rv));</span>
<a href="#l3.332"></a><span id="l3.332" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l3.333"></a><span id="l3.333" class="difflineminus">-    usePrefsScan = false;</span>
<a href="#l3.334"></a><span id="l3.334" class="difflineplus">+  nsCOMPtr&lt;nsIPrefService&gt; prefService(</span>
<a href="#l3.335"></a><span id="l3.335" class="difflineplus">+      do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l3.336"></a><span id="l3.336" class="difflineplus">+  if (NS_FAILED(rv)) usePrefsScan = false;</span>
<a href="#l3.337"></a><span id="l3.337"> </span>
<a href="#l3.338"></a><span id="l3.338">   // Loop over existing pref names mail.server.server(lastKey).type</span>
<a href="#l3.339"></a><span id="l3.339">   nsCOMPtr&lt;nsIPrefBranch&gt; prefBranchServer;</span>
<a href="#l3.340"></a><span id="l3.340" class="difflineminus">-  if (prefService)</span>
<a href="#l3.341"></a><span id="l3.341" class="difflineminus">-  {</span>
<a href="#l3.342"></a><span id="l3.342" class="difflineminus">-    rv = prefService-&gt;GetBranch(PREF_MAIL_SERVER_PREFIX, getter_AddRefs(prefBranchServer));</span>
<a href="#l3.343"></a><span id="l3.343" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l3.344"></a><span id="l3.344" class="difflineminus">-      usePrefsScan = false;</span>
<a href="#l3.345"></a><span id="l3.345" class="difflineplus">+  if (prefService) {</span>
<a href="#l3.346"></a><span id="l3.346" class="difflineplus">+    rv = prefService-&gt;GetBranch(PREF_MAIL_SERVER_PREFIX,</span>
<a href="#l3.347"></a><span id="l3.347" class="difflineplus">+                                getter_AddRefs(prefBranchServer));</span>
<a href="#l3.348"></a><span id="l3.348" class="difflineplus">+    if (NS_FAILED(rv)) usePrefsScan = false;</span>
<a href="#l3.349"></a><span id="l3.349">   }</span>
<a href="#l3.350"></a><span id="l3.350"> </span>
<a href="#l3.351"></a><span id="l3.351" class="difflineminus">-  if (usePrefsScan)</span>
<a href="#l3.352"></a><span id="l3.352" class="difflineminus">-  {</span>
<a href="#l3.353"></a><span id="l3.353" class="difflineplus">+  if (usePrefsScan) {</span>
<a href="#l3.354"></a><span id="l3.354">     nsAutoCString type;</span>
<a href="#l3.355"></a><span id="l3.355">     nsAutoCString typeKey;</span>
<a href="#l3.356"></a><span id="l3.356" class="difflineminus">-    for (uint32_t lastKey = 1; ; lastKey++)</span>
<a href="#l3.357"></a><span id="l3.357" class="difflineminus">-    {</span>
<a href="#l3.358"></a><span id="l3.358" class="difflineplus">+    for (uint32_t lastKey = 1;; lastKey++) {</span>
<a href="#l3.359"></a><span id="l3.359">       aResult.AssignLiteral(SERVER_PREFIX);</span>
<a href="#l3.360"></a><span id="l3.360">       aResult.AppendInt(lastKey);</span>
<a href="#l3.361"></a><span id="l3.361">       typeKey.Assign(aResult);</span>
<a href="#l3.362"></a><span id="l3.362">       typeKey.AppendLiteral(&quot;.type&quot;);</span>
<a href="#l3.363"></a><span id="l3.363">       prefBranchServer-&gt;GetCharPref(typeKey.get(), type);</span>
<a href="#l3.364"></a><span id="l3.364" class="difflineminus">-      if (type.IsEmpty()) // a server slot with no type is considered empty</span>
<a href="#l3.365"></a><span id="l3.365" class="difflineplus">+      if (type.IsEmpty())  // a server slot with no type is considered empty</span>
<a href="#l3.366"></a><span id="l3.366">         return;</span>
<a href="#l3.367"></a><span id="l3.367">     }</span>
<a href="#l3.368"></a><span id="l3.368" class="difflineminus">-  }</span>
<a href="#l3.369"></a><span id="l3.369" class="difflineminus">-  else</span>
<a href="#l3.370"></a><span id="l3.370" class="difflineminus">-  {</span>
<a href="#l3.371"></a><span id="l3.371" class="difflineplus">+  } else {</span>
<a href="#l3.372"></a><span id="l3.372">     // If pref service fails, try to find a free serverX key</span>
<a href="#l3.373"></a><span id="l3.373">     // by checking which keys exist.</span>
<a href="#l3.374"></a><span id="l3.374">     nsAutoCString internalResult;</span>
<a href="#l3.375"></a><span id="l3.375">     nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l3.376"></a><span id="l3.376">     uint32_t i = 1;</span>
<a href="#l3.377"></a><span id="l3.377">     do {</span>
<a href="#l3.378"></a><span id="l3.378">       aResult.AssignLiteral(SERVER_PREFIX);</span>
<a href="#l3.379"></a><span id="l3.379">       aResult.AppendInt(i++);</span>
<a href="#l3.380"></a><span id="l3.380">       m_incomingServers.Get(aResult, getter_AddRefs(server));</span>
<a href="#l3.381"></a><span id="l3.381">     } while (server);</span>
<a href="#l3.382"></a><span id="l3.382">     return;</span>
<a href="#l3.383"></a><span id="l3.383">   }</span>
<a href="#l3.384"></a><span id="l3.384"> }</span>
<a href="#l3.385"></a><span id="l3.385"> </span>
<a href="#l3.386"></a><span id="l3.386" class="difflineminus">-nsresult</span>
<a href="#l3.387"></a><span id="l3.387" class="difflineminus">-nsMsgAccountManager::CreateIdentity(nsIMsgIdentity **_retval)</span>
<a href="#l3.388"></a><span id="l3.388" class="difflineminus">-{</span>
<a href="#l3.389"></a><span id="l3.389" class="difflineplus">+nsresult nsMsgAccountManager::CreateIdentity(nsIMsgIdentity **_retval) {</span>
<a href="#l3.390"></a><span id="l3.390">   NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l3.391"></a><span id="l3.391">   nsresult rv;</span>
<a href="#l3.392"></a><span id="l3.392">   nsAutoCString key;</span>
<a href="#l3.393"></a><span id="l3.393">   nsCOMPtr&lt;nsIMsgIdentity&gt; identity;</span>
<a href="#l3.394"></a><span id="l3.394">   int32_t i = 1;</span>
<a href="#l3.395"></a><span id="l3.395">   do {</span>
<a href="#l3.396"></a><span id="l3.396">     key.AssignLiteral(ID_PREFIX);</span>
<a href="#l3.397"></a><span id="l3.397">     key.AppendInt(i++);</span>
<a href="#l3.398"></a><span id="l3.398">     m_identities.Get(key, getter_AddRefs(identity));</span>
<a href="#l3.399"></a><span id="l3.399">   } while (identity);</span>
<a href="#l3.400"></a><span id="l3.400"> </span>
<a href="#l3.401"></a><span id="l3.401">   rv = createKeyedIdentity(key, _retval);</span>
<a href="#l3.402"></a><span id="l3.402">   return rv;</span>
<a href="#l3.403"></a><span id="l3.403"> }</span>
<a href="#l3.404"></a><span id="l3.404"> </span>
<a href="#l3.405"></a><span id="l3.405"> NS_IMETHODIMP</span>
<a href="#l3.406"></a><span id="l3.406" class="difflineminus">-nsMsgAccountManager::GetIdentity(const nsACString&amp; key, nsIMsgIdentity **_retval)</span>
<a href="#l3.407"></a><span id="l3.407" class="difflineminus">-{</span>
<a href="#l3.408"></a><span id="l3.408" class="difflineplus">+nsMsgAccountManager::GetIdentity(const nsACString &amp;key,</span>
<a href="#l3.409"></a><span id="l3.409" class="difflineplus">+                                 nsIMsgIdentity **_retval) {</span>
<a href="#l3.410"></a><span id="l3.410">   NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l3.411"></a><span id="l3.411">   nsresult rv = NS_OK;</span>
<a href="#l3.412"></a><span id="l3.412">   *_retval = nullptr;</span>
<a href="#l3.413"></a><span id="l3.413"> </span>
<a href="#l3.414"></a><span id="l3.414" class="difflineminus">-  if (!key.IsEmpty())</span>
<a href="#l3.415"></a><span id="l3.415" class="difflineminus">-  {</span>
<a href="#l3.416"></a><span id="l3.416" class="difflineplus">+  if (!key.IsEmpty()) {</span>
<a href="#l3.417"></a><span id="l3.417">     nsCOMPtr&lt;nsIMsgIdentity&gt; identity;</span>
<a href="#l3.418"></a><span id="l3.418">     m_identities.Get(key, getter_AddRefs(identity));</span>
<a href="#l3.419"></a><span id="l3.419">     if (identity)</span>
<a href="#l3.420"></a><span id="l3.420">       identity.forget(_retval);</span>
<a href="#l3.421"></a><span id="l3.421" class="difflineminus">-    else // identity doesn't exist. create it.</span>
<a href="#l3.422"></a><span id="l3.422" class="difflineplus">+    else  // identity doesn't exist. create it.</span>
<a href="#l3.423"></a><span id="l3.423">       rv = createKeyedIdentity(key, _retval);</span>
<a href="#l3.424"></a><span id="l3.424">   }</span>
<a href="#l3.425"></a><span id="l3.425"> </span>
<a href="#l3.426"></a><span id="l3.426">   return rv;</span>
<a href="#l3.427"></a><span id="l3.427"> }</span>
<a href="#l3.428"></a><span id="l3.428"> </span>
<a href="#l3.429"></a><span id="l3.429"> /*</span>
<a href="#l3.430"></a><span id="l3.430">  * the shared identity-creation code</span>
<a href="#l3.431"></a><span id="l3.431">  * create an identity and add it to the accountmanager's list.</span>
<a href="#l3.432"></a><span id="l3.432">  */</span>
<a href="#l3.433"></a><span id="l3.433" class="difflineminus">-nsresult</span>
<a href="#l3.434"></a><span id="l3.434" class="difflineminus">-nsMsgAccountManager::createKeyedIdentity(const nsACString&amp; key,</span>
<a href="#l3.435"></a><span id="l3.435" class="difflineminus">-                                         nsIMsgIdentity ** aIdentity)</span>
<a href="#l3.436"></a><span id="l3.436" class="difflineminus">-{</span>
<a href="#l3.437"></a><span id="l3.437" class="difflineplus">+nsresult nsMsgAccountManager::createKeyedIdentity(const nsACString &amp;key,</span>
<a href="#l3.438"></a><span id="l3.438" class="difflineplus">+                                                  nsIMsgIdentity **aIdentity) {</span>
<a href="#l3.439"></a><span id="l3.439">   nsresult rv;</span>
<a href="#l3.440"></a><span id="l3.440">   nsCOMPtr&lt;nsIMsgIdentity&gt; identity =</span>
<a href="#l3.441"></a><span id="l3.441">       do_CreateInstance(NS_MSGIDENTITY_CONTRACTID, &amp;rv);</span>
<a href="#l3.442"></a><span id="l3.442">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.443"></a><span id="l3.443"> </span>
<a href="#l3.444"></a><span id="l3.444">   identity-&gt;SetKey(key);</span>
<a href="#l3.445"></a><span id="l3.445">   m_identities.Put(key, identity);</span>
<a href="#l3.446"></a><span id="l3.446">   identity.forget(aIdentity);</span>
<a href="#l3.447"></a><span id="l3.447">   return NS_OK;</span>
<a href="#l3.448"></a><span id="l3.448"> }</span>
<a href="#l3.449"></a><span id="l3.449"> </span>
<a href="#l3.450"></a><span id="l3.450"> NS_IMETHODIMP</span>
<a href="#l3.451"></a><span id="l3.451" class="difflineminus">-nsMsgAccountManager::CreateIncomingServer(const nsACString&amp;  username,</span>
<a href="#l3.452"></a><span id="l3.452" class="difflineminus">-                                          const nsACString&amp; hostname,</span>
<a href="#l3.453"></a><span id="l3.453" class="difflineminus">-                                          const nsACString&amp; type,</span>
<a href="#l3.454"></a><span id="l3.454" class="difflineminus">-                                          nsIMsgIncomingServer **_retval)</span>
<a href="#l3.455"></a><span id="l3.455" class="difflineminus">-{</span>
<a href="#l3.456"></a><span id="l3.456" class="difflineplus">+nsMsgAccountManager::CreateIncomingServer(const nsACString &amp;username,</span>
<a href="#l3.457"></a><span id="l3.457" class="difflineplus">+                                          const nsACString &amp;hostname,</span>
<a href="#l3.458"></a><span id="l3.458" class="difflineplus">+                                          const nsACString &amp;type,</span>
<a href="#l3.459"></a><span id="l3.459" class="difflineplus">+                                          nsIMsgIncomingServer **_retval) {</span>
<a href="#l3.460"></a><span id="l3.460">   NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l3.461"></a><span id="l3.461"> </span>
<a href="#l3.462"></a><span id="l3.462">   nsresult rv = LoadAccounts();</span>
<a href="#l3.463"></a><span id="l3.463">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.464"></a><span id="l3.464"> </span>
<a href="#l3.465"></a><span id="l3.465">   nsAutoCString key;</span>
<a href="#l3.466"></a><span id="l3.466">   GetUniqueServerKey(key);</span>
<a href="#l3.467"></a><span id="l3.467">   rv = createKeyedServer(key, username, hostname, type, _retval);</span>
<a href="#l3.468"></a><span id="l3.468" class="difflineminus">-  if (*_retval)</span>
<a href="#l3.469"></a><span id="l3.469" class="difflineminus">-  {</span>
<a href="#l3.470"></a><span id="l3.470" class="difflineplus">+  if (*_retval) {</span>
<a href="#l3.471"></a><span id="l3.471">     nsCString defaultStore;</span>
<a href="#l3.472"></a><span id="l3.472">     m_prefs-&gt;GetCharPref(&quot;mail.serverDefaultStoreContractID&quot;, defaultStore);</span>
<a href="#l3.473"></a><span id="l3.473">     (*_retval)-&gt;SetCharValue(&quot;storeContractID&quot;, defaultStore);</span>
<a href="#l3.474"></a><span id="l3.474"> </span>
<a href="#l3.475"></a><span id="l3.475">     // From when we first create the account until we have created some folders,</span>
<a href="#l3.476"></a><span id="l3.476">     // we can change the store type.</span>
<a href="#l3.477"></a><span id="l3.477">     (*_retval)-&gt;SetBoolValue(&quot;canChangeStoreType&quot;, true);</span>
<a href="#l3.478"></a><span id="l3.478">   }</span>
<a href="#l3.479"></a><span id="l3.479">   return rv;</span>
<a href="#l3.480"></a><span id="l3.480"> }</span>
<a href="#l3.481"></a><span id="l3.481"> </span>
<a href="#l3.482"></a><span id="l3.482"> NS_IMETHODIMP</span>
<a href="#l3.483"></a><span id="l3.483" class="difflineminus">-nsMsgAccountManager::GetIncomingServer(const nsACString&amp; key,</span>
<a href="#l3.484"></a><span id="l3.484" class="difflineminus">-                                       nsIMsgIncomingServer **_retval)</span>
<a href="#l3.485"></a><span id="l3.485" class="difflineminus">-{</span>
<a href="#l3.486"></a><span id="l3.486" class="difflineplus">+nsMsgAccountManager::GetIncomingServer(const nsACString &amp;key,</span>
<a href="#l3.487"></a><span id="l3.487" class="difflineplus">+                                       nsIMsgIncomingServer **_retval) {</span>
<a href="#l3.488"></a><span id="l3.488">   NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l3.489"></a><span id="l3.489">   nsresult rv;</span>
<a href="#l3.490"></a><span id="l3.490"> </span>
<a href="#l3.491"></a><span id="l3.491" class="difflineminus">-  if (m_incomingServers.Get(key, _retval))</span>
<a href="#l3.492"></a><span id="l3.492" class="difflineminus">-    return NS_OK;</span>
<a href="#l3.493"></a><span id="l3.493" class="difflineplus">+  if (m_incomingServers.Get(key, _retval)) return NS_OK;</span>
<a href="#l3.494"></a><span id="l3.494"> </span>
<a href="#l3.495"></a><span id="l3.495">   // server doesn't exist, so create it</span>
<a href="#l3.496"></a><span id="l3.496">   // this is really horrible because we are doing our own prefname munging</span>
<a href="#l3.497"></a><span id="l3.497">   // instead of leaving it up to the incoming server.</span>
<a href="#l3.498"></a><span id="l3.498">   // this should be fixed somehow so that we can create the incoming server</span>
<a href="#l3.499"></a><span id="l3.499">   // and then read from the incoming server's attributes</span>
<a href="#l3.500"></a><span id="l3.500"> </span>
<a href="#l3.501"></a><span id="l3.501">   // in order to create the right kind of server, we have to look</span>
<a href="#l3.502"></a><span id="l3.502">   // at the pref for this server to get the username, hostname, and type</span>
<a href="#l3.503"></a><span id="l3.503">   nsAutoCString serverPrefPrefix(PREF_MAIL_SERVER_PREFIX);</span>
<a href="#l3.504"></a><span id="l3.504">   serverPrefPrefix.Append(key);</span>
<a href="#l3.505"></a><span id="l3.505"> </span>
<a href="#l3.506"></a><span id="l3.506">   nsCString serverType;</span>
<a href="#l3.507"></a><span id="l3.507" class="difflineminus">-  nsAutoCString serverPref (serverPrefPrefix);</span>
<a href="#l3.508"></a><span id="l3.508" class="difflineplus">+  nsAutoCString serverPref(serverPrefPrefix);</span>
<a href="#l3.509"></a><span id="l3.509">   serverPref.AppendLiteral(&quot;.type&quot;);</span>
<a href="#l3.510"></a><span id="l3.510">   rv = m_prefs-&gt;GetCharPref(serverPref.get(), serverType);</span>
<a href="#l3.511"></a><span id="l3.511">   NS_ENSURE_SUCCESS(rv, NS_ERROR_NOT_INITIALIZED);</span>
<a href="#l3.512"></a><span id="l3.512"> </span>
<a href="#l3.513"></a><span id="l3.513">   //</span>
<a href="#l3.514"></a><span id="l3.514">   // .userName</span>
<a href="#l3.515"></a><span id="l3.515">   serverPref = serverPrefPrefix;</span>
<a href="#l3.516"></a><span id="l3.516">   serverPref.AppendLiteral(&quot;.userName&quot;);</span>
<a href="#l3.517"></a><span id="l3.517" class="difflineat">@@ -491,29 +457,30 @@ nsMsgAccountManager::GetIncomingServer(c</span>
<a href="#l3.518"></a><span id="l3.518">   rv = m_prefs-&gt;GetCharPref(serverPref.get(), hostname);</span>
<a href="#l3.519"></a><span id="l3.519">   NS_ENSURE_SUCCESS(rv, NS_ERROR_NOT_INITIALIZED);</span>
<a href="#l3.520"></a><span id="l3.520"> </span>
<a href="#l3.521"></a><span id="l3.521">   return createKeyedServer(key, username, hostname, serverType, _retval);</span>
<a href="#l3.522"></a><span id="l3.522"> }</span>
<a href="#l3.523"></a><span id="l3.523"> </span>
<a href="#l3.524"></a><span id="l3.524"> NS_IMETHODIMP</span>
<a href="#l3.525"></a><span id="l3.525"> nsMsgAccountManager::RemoveIncomingServer(nsIMsgIncomingServer *aServer,</span>
<a href="#l3.526"></a><span id="l3.526" class="difflineminus">-                                          bool aRemoveFiles)</span>
<a href="#l3.527"></a><span id="l3.527" class="difflineminus">-{</span>
<a href="#l3.528"></a><span id="l3.528" class="difflineplus">+                                          bool aRemoveFiles) {</span>
<a href="#l3.529"></a><span id="l3.529">   NS_ENSURE_ARG_POINTER(aServer);</span>
<a href="#l3.530"></a><span id="l3.530"> </span>
<a href="#l3.531"></a><span id="l3.531">   nsCString serverKey;</span>
<a href="#l3.532"></a><span id="l3.532">   nsresult rv = aServer-&gt;GetKey(serverKey);</span>
<a href="#l3.533"></a><span id="l3.533">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.534"></a><span id="l3.534"> </span>
<a href="#l3.535"></a><span id="l3.535" class="difflineminus">-  LogoutOfServer(aServer); // close cached connections and forget session password</span>
<a href="#l3.536"></a><span id="l3.536" class="difflineplus">+  // close cached connections and forget session password</span>
<a href="#l3.537"></a><span id="l3.537" class="difflineplus">+  LogoutOfServer(aServer);</span>
<a href="#l3.538"></a><span id="l3.538"> </span>
<a href="#l3.539"></a><span id="l3.539">   // invalidate the FindServer() cache if we are removing the cached server</span>
<a href="#l3.540"></a><span id="l3.540">   if (m_lastFindServerResult == aServer)</span>
<a href="#l3.541"></a><span id="l3.541" class="difflineminus">-    SetLastServerFound(nullptr, EmptyCString(), EmptyCString(), 0, EmptyCString());</span>
<a href="#l3.542"></a><span id="l3.542" class="difflineplus">+    SetLastServerFound(nullptr, EmptyCString(), EmptyCString(), 0,</span>
<a href="#l3.543"></a><span id="l3.543" class="difflineplus">+                       EmptyCString());</span>
<a href="#l3.544"></a><span id="l3.544"> </span>
<a href="#l3.545"></a><span id="l3.545">   m_incomingServers.Remove(serverKey);</span>
<a href="#l3.546"></a><span id="l3.546"> </span>
<a href="#l3.547"></a><span id="l3.547">   nsCOMPtr&lt;nsIMsgFolder&gt; rootFolder;</span>
<a href="#l3.548"></a><span id="l3.548">   nsCOMPtr&lt;nsIArray&gt; allDescendants;</span>
<a href="#l3.549"></a><span id="l3.549"> </span>
<a href="#l3.550"></a><span id="l3.550">   rv = aServer-&gt;GetRootFolder(getter_AddRefs(rootFolder));</span>
<a href="#l3.551"></a><span id="l3.551">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.552"></a><span id="l3.552" class="difflineat">@@ -521,803 +488,735 @@ nsMsgAccountManager::RemoveIncomingServe</span>
<a href="#l3.553"></a><span id="l3.553">   rv = rootFolder-&gt;GetDescendants(getter_AddRefs(allDescendants));</span>
<a href="#l3.554"></a><span id="l3.554">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.555"></a><span id="l3.555"> </span>
<a href="#l3.556"></a><span id="l3.556">   uint32_t cnt = 0;</span>
<a href="#l3.557"></a><span id="l3.557">   rv = allDescendants-&gt;GetLength(&amp;cnt);</span>
<a href="#l3.558"></a><span id="l3.558">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.559"></a><span id="l3.559"> </span>
<a href="#l3.560"></a><span id="l3.560">   nsCOMPtr&lt;nsIMsgFolderNotificationService&gt; notifier =</span>
<a href="#l3.561"></a><span id="l3.561" class="difflineminus">-           do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID);</span>
<a href="#l3.562"></a><span id="l3.562" class="difflineplus">+      do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID);</span>
<a href="#l3.563"></a><span id="l3.563">   nsCOMPtr&lt;nsIFolderListener&gt; mailSession =</span>
<a href="#l3.564"></a><span id="l3.564" class="difflineminus">-           do_GetService(NS_MSGMAILSESSION_CONTRACTID);</span>
<a href="#l3.565"></a><span id="l3.565" class="difflineminus">-</span>
<a href="#l3.566"></a><span id="l3.566" class="difflineminus">-  for (uint32_t i = 0; i &lt; cnt; i++)</span>
<a href="#l3.567"></a><span id="l3.567" class="difflineminus">-  {</span>
<a href="#l3.568"></a><span id="l3.568" class="difflineplus">+      do_GetService(NS_MSGMAILSESSION_CONTRACTID);</span>
<a href="#l3.569"></a><span id="l3.569" class="difflineplus">+</span>
<a href="#l3.570"></a><span id="l3.570" class="difflineplus">+  for (uint32_t i = 0; i &lt; cnt; i++) {</span>
<a href="#l3.571"></a><span id="l3.571">     nsCOMPtr&lt;nsIMsgFolder&gt; folder = do_QueryElementAt(allDescendants, i);</span>
<a href="#l3.572"></a><span id="l3.572" class="difflineminus">-    if (folder)</span>
<a href="#l3.573"></a><span id="l3.573" class="difflineminus">-    {</span>
<a href="#l3.574"></a><span id="l3.574" class="difflineplus">+    if (folder) {</span>
<a href="#l3.575"></a><span id="l3.575">       folder-&gt;ForceDBClosed();</span>
<a href="#l3.576"></a><span id="l3.576" class="difflineminus">-      if (notifier)</span>
<a href="#l3.577"></a><span id="l3.577" class="difflineminus">-        notifier-&gt;NotifyFolderDeleted(folder);</span>
<a href="#l3.578"></a><span id="l3.578" class="difflineminus">-      if (mailSession)</span>
<a href="#l3.579"></a><span id="l3.579" class="difflineminus">-      {</span>
<a href="#l3.580"></a><span id="l3.580" class="difflineplus">+      if (notifier) notifier-&gt;NotifyFolderDeleted(folder);</span>
<a href="#l3.581"></a><span id="l3.581" class="difflineplus">+      if (mailSession) {</span>
<a href="#l3.582"></a><span id="l3.582">         nsCOMPtr&lt;nsIMsgFolder&gt; parentFolder;</span>
<a href="#l3.583"></a><span id="l3.583">         folder-&gt;GetParent(getter_AddRefs(parentFolder));</span>
<a href="#l3.584"></a><span id="l3.584">         mailSession-&gt;OnItemRemoved(parentFolder, folder);</span>
<a href="#l3.585"></a><span id="l3.585">       }</span>
<a href="#l3.586"></a><span id="l3.586">     }</span>
<a href="#l3.587"></a><span id="l3.587">   }</span>
<a href="#l3.588"></a><span id="l3.588" class="difflineminus">-  if (notifier)</span>
<a href="#l3.589"></a><span id="l3.589" class="difflineminus">-    notifier-&gt;NotifyFolderDeleted(rootFolder);</span>
<a href="#l3.590"></a><span id="l3.590" class="difflineminus">-  if (mailSession)</span>
<a href="#l3.591"></a><span id="l3.591" class="difflineminus">-    mailSession-&gt;OnItemRemoved(nullptr, rootFolder);</span>
<a href="#l3.592"></a><span id="l3.592" class="difflineplus">+  if (notifier) notifier-&gt;NotifyFolderDeleted(rootFolder);</span>
<a href="#l3.593"></a><span id="l3.593" class="difflineplus">+  if (mailSession) mailSession-&gt;OnItemRemoved(nullptr, rootFolder);</span>
<a href="#l3.594"></a><span id="l3.594"> </span>
<a href="#l3.595"></a><span id="l3.595">   removeListenersFromFolder(rootFolder);</span>
<a href="#l3.596"></a><span id="l3.596">   NotifyServerUnloaded(aServer);</span>
<a href="#l3.597"></a><span id="l3.597" class="difflineminus">-  if (aRemoveFiles)</span>
<a href="#l3.598"></a><span id="l3.598" class="difflineminus">-  {</span>
<a href="#l3.599"></a><span id="l3.599" class="difflineplus">+  if (aRemoveFiles) {</span>
<a href="#l3.600"></a><span id="l3.600">     rv = aServer-&gt;RemoveFiles();</span>
<a href="#l3.601"></a><span id="l3.601">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.602"></a><span id="l3.602">   }</span>
<a href="#l3.603"></a><span id="l3.603"> </span>
<a href="#l3.604"></a><span id="l3.604">   // now clear out the server once and for all.</span>
<a href="#l3.605"></a><span id="l3.605">   // watch out! could be scary</span>
<a href="#l3.606"></a><span id="l3.606">   aServer-&gt;ClearAllValues();</span>
<a href="#l3.607"></a><span id="l3.607">   rootFolder-&gt;Shutdown(true);</span>
<a href="#l3.608"></a><span id="l3.608">   return rv;</span>
<a href="#l3.609"></a><span id="l3.609"> }</span>
<a href="#l3.610"></a><span id="l3.610"> </span>
<a href="#l3.611"></a><span id="l3.611"> /*</span>
<a href="#l3.612"></a><span id="l3.612">  * create a server when you know the key and the type</span>
<a href="#l3.613"></a><span id="l3.613">  */</span>
<a href="#l3.614"></a><span id="l3.614" class="difflineminus">-nsresult</span>
<a href="#l3.615"></a><span id="l3.615" class="difflineminus">-nsMsgAccountManager::createKeyedServer(const nsACString&amp; key,</span>
<a href="#l3.616"></a><span id="l3.616" class="difflineminus">-                                       const nsACString&amp; username,</span>
<a href="#l3.617"></a><span id="l3.617" class="difflineminus">-                                       const nsACString&amp; hostname,</span>
<a href="#l3.618"></a><span id="l3.618" class="difflineminus">-                                       const nsACString&amp; type,</span>
<a href="#l3.619"></a><span id="l3.619" class="difflineminus">-                                       nsIMsgIncomingServer ** aServer)</span>
<a href="#l3.620"></a><span id="l3.620" class="difflineminus">-{</span>
<a href="#l3.621"></a><span id="l3.621" class="difflineplus">+nsresult nsMsgAccountManager::createKeyedServer(</span>
<a href="#l3.622"></a><span id="l3.622" class="difflineplus">+    const nsACString &amp;key, const nsACString &amp;username,</span>
<a href="#l3.623"></a><span id="l3.623" class="difflineplus">+    const nsACString &amp;hostname, const nsACString &amp;type,</span>
<a href="#l3.624"></a><span id="l3.624" class="difflineplus">+    nsIMsgIncomingServer **aServer) {</span>
<a href="#l3.625"></a><span id="l3.625">   nsresult rv;</span>
<a href="#l3.626"></a><span id="l3.626">   *aServer = nullptr;</span>
<a href="#l3.627"></a><span id="l3.627"> </span>
<a href="#l3.628"></a><span id="l3.628" class="difflineminus">-  //construct the contractid</span>
<a href="#l3.629"></a><span id="l3.629" class="difflineplus">+  // construct the contractid</span>
<a href="#l3.630"></a><span id="l3.630">   nsAutoCString serverContractID(NS_MSGINCOMINGSERVER_CONTRACTID_PREFIX);</span>
<a href="#l3.631"></a><span id="l3.631">   serverContractID += type;</span>
<a href="#l3.632"></a><span id="l3.632"> </span>
<a href="#l3.633"></a><span id="l3.633">   // finally, create the server</span>
<a href="#l3.634"></a><span id="l3.634">   // (This will fail if type is from an extension that has been removed)</span>
<a href="#l3.635"></a><span id="l3.635">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server =</span>
<a href="#l3.636"></a><span id="l3.636" class="difflineminus">-           do_CreateInstance(serverContractID.get(), &amp;rv);</span>
<a href="#l3.637"></a><span id="l3.637" class="difflineplus">+      do_CreateInstance(serverContractID.get(), &amp;rv);</span>
<a href="#l3.638"></a><span id="l3.638">   NS_ENSURE_SUCCESS(rv, NS_ERROR_NOT_AVAILABLE);</span>
<a href="#l3.639"></a><span id="l3.639"> </span>
<a href="#l3.640"></a><span id="l3.640">   int32_t port;</span>
<a href="#l3.641"></a><span id="l3.641" class="difflineminus">-  nsCOMPtr &lt;nsIMsgIncomingServer&gt; existingServer;</span>
<a href="#l3.642"></a><span id="l3.642" class="difflineplus">+  nsCOMPtr&lt;nsIMsgIncomingServer&gt; existingServer;</span>
<a href="#l3.643"></a><span id="l3.643">   server-&gt;SetKey(key);</span>
<a href="#l3.644"></a><span id="l3.644">   server-&gt;SetType(type);</span>
<a href="#l3.645"></a><span id="l3.645">   server-&gt;SetUsername(username);</span>
<a href="#l3.646"></a><span id="l3.646">   server-&gt;SetHostName(hostname);</span>
<a href="#l3.647"></a><span id="l3.647">   server-&gt;GetPort(&amp;port);</span>
<a href="#l3.648"></a><span id="l3.648" class="difflineminus">-  FindRealServer(username, hostname, type, port, getter_AddRefs(existingServer));</span>
<a href="#l3.649"></a><span id="l3.649" class="difflineplus">+  FindRealServer(username, hostname, type, port,</span>
<a href="#l3.650"></a><span id="l3.650" class="difflineplus">+                 getter_AddRefs(existingServer));</span>
<a href="#l3.651"></a><span id="l3.651">   // don't allow duplicate servers.</span>
<a href="#l3.652"></a><span id="l3.652" class="difflineminus">-  if (existingServer)</span>
<a href="#l3.653"></a><span id="l3.653" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l3.654"></a><span id="l3.654" class="difflineplus">+  if (existingServer) return NS_ERROR_FAILURE;</span>
<a href="#l3.655"></a><span id="l3.655"> </span>
<a href="#l3.656"></a><span id="l3.656">   m_incomingServers.Put(key, server);</span>
<a href="#l3.657"></a><span id="l3.657"> </span>
<a href="#l3.658"></a><span id="l3.658">   // now add all listeners that are supposed to be</span>
<a href="#l3.659"></a><span id="l3.659">   // waiting on root folders</span>
<a href="#l3.660"></a><span id="l3.660">   nsCOMPtr&lt;nsIMsgFolder&gt; rootFolder;</span>
<a href="#l3.661"></a><span id="l3.661">   rv = server-&gt;GetRootFolder(getter_AddRefs(rootFolder));</span>
<a href="#l3.662"></a><span id="l3.662">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.663"></a><span id="l3.663"> </span>
<a href="#l3.664"></a><span id="l3.664" class="difflineminus">-  nsTObserverArray&lt;nsCOMPtr&lt;nsIFolderListener&gt; &gt;::ForwardIterator iter(mFolderListeners);</span>
<a href="#l3.665"></a><span id="l3.665" class="difflineminus">-  while (iter.HasMore())</span>
<a href="#l3.666"></a><span id="l3.666" class="difflineminus">-  {</span>
<a href="#l3.667"></a><span id="l3.667" class="difflineplus">+  nsTObserverArray&lt;nsCOMPtr&lt;nsIFolderListener&gt; &gt;::ForwardIterator iter(</span>
<a href="#l3.668"></a><span id="l3.668" class="difflineplus">+      mFolderListeners);</span>
<a href="#l3.669"></a><span id="l3.669" class="difflineplus">+  while (iter.HasMore()) {</span>
<a href="#l3.670"></a><span id="l3.670">     rootFolder-&gt;AddFolderListener(iter.GetNext());</span>
<a href="#l3.671"></a><span id="l3.671">   }</span>
<a href="#l3.672"></a><span id="l3.672"> </span>
<a href="#l3.673"></a><span id="l3.673">   server.forget(aServer);</span>
<a href="#l3.674"></a><span id="l3.674">   return NS_OK;</span>
<a href="#l3.675"></a><span id="l3.675"> }</span>
<a href="#l3.676"></a><span id="l3.676"> </span>
<a href="#l3.677"></a><span id="l3.677" class="difflineminus">-void</span>
<a href="#l3.678"></a><span id="l3.678" class="difflineminus">-nsMsgAccountManager::removeListenersFromFolder(nsIMsgFolder *aFolder)</span>
<a href="#l3.679"></a><span id="l3.679" class="difflineminus">-{</span>
<a href="#l3.680"></a><span id="l3.680" class="difflineminus">-  nsTObserverArray&lt;nsCOMPtr&lt;nsIFolderListener&gt; &gt;::ForwardIterator iter(mFolderListeners);</span>
<a href="#l3.681"></a><span id="l3.681" class="difflineminus">-  while (iter.HasMore())</span>
<a href="#l3.682"></a><span id="l3.682" class="difflineminus">-  {</span>
<a href="#l3.683"></a><span id="l3.683" class="difflineplus">+void nsMsgAccountManager::removeListenersFromFolder(nsIMsgFolder *aFolder) {</span>
<a href="#l3.684"></a><span id="l3.684" class="difflineplus">+  nsTObserverArray&lt;nsCOMPtr&lt;nsIFolderListener&gt; &gt;::ForwardIterator iter(</span>
<a href="#l3.685"></a><span id="l3.685" class="difflineplus">+      mFolderListeners);</span>
<a href="#l3.686"></a><span id="l3.686" class="difflineplus">+  while (iter.HasMore()) {</span>
<a href="#l3.687"></a><span id="l3.687">     aFolder-&gt;RemoveFolderListener(iter.GetNext());</span>
<a href="#l3.688"></a><span id="l3.688">   }</span>
<a href="#l3.689"></a><span id="l3.689"> }</span>
<a href="#l3.690"></a><span id="l3.690"> </span>
<a href="#l3.691"></a><span id="l3.691"> NS_IMETHODIMP</span>
<a href="#l3.692"></a><span id="l3.692"> nsMsgAccountManager::RemoveAccount(nsIMsgAccount *aAccount,</span>
<a href="#l3.693"></a><span id="l3.693" class="difflineminus">-                                   bool aRemoveFiles = false)</span>
<a href="#l3.694"></a><span id="l3.694" class="difflineminus">-{</span>
<a href="#l3.695"></a><span id="l3.695" class="difflineplus">+                                   bool aRemoveFiles = false) {</span>
<a href="#l3.696"></a><span id="l3.696">   NS_ENSURE_ARG_POINTER(aAccount);</span>
<a href="#l3.697"></a><span id="l3.697">   nsresult rv = LoadAccounts();</span>
<a href="#l3.698"></a><span id="l3.698">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.699"></a><span id="l3.699"> </span>
<a href="#l3.700"></a><span id="l3.700">   bool accountRemoved = m_accounts.RemoveElement(aAccount);</span>
<a href="#l3.701"></a><span id="l3.701"> </span>
<a href="#l3.702"></a><span id="l3.702" class="difflineminus">-  rv  = OutputAccountsPref();</span>
<a href="#l3.703"></a><span id="l3.703" class="difflineplus">+  rv = OutputAccountsPref();</span>
<a href="#l3.704"></a><span id="l3.704">   // If we couldn't write out the pref, restore the account.</span>
<a href="#l3.705"></a><span id="l3.705" class="difflineminus">-  if (NS_FAILED(rv) &amp;&amp; accountRemoved)</span>
<a href="#l3.706"></a><span id="l3.706" class="difflineminus">-  {</span>
<a href="#l3.707"></a><span id="l3.707" class="difflineplus">+  if (NS_FAILED(rv) &amp;&amp; accountRemoved) {</span>
<a href="#l3.708"></a><span id="l3.708">     m_accounts.AppendElement(aAccount);</span>
<a href="#l3.709"></a><span id="l3.709">     return rv;</span>
<a href="#l3.710"></a><span id="l3.710">   }</span>
<a href="#l3.711"></a><span id="l3.711"> </span>
<a href="#l3.712"></a><span id="l3.712">   // If it's the default, choose a new default account.</span>
<a href="#l3.713"></a><span id="l3.713" class="difflineminus">-  if (m_defaultAccount.get() == aAccount)</span>
<a href="#l3.714"></a><span id="l3.714" class="difflineminus">-    AutosetDefaultAccount();</span>
<a href="#l3.715"></a><span id="l3.715" class="difflineplus">+  if (m_defaultAccount.get() == aAccount) AutosetDefaultAccount();</span>
<a href="#l3.716"></a><span id="l3.716"> </span>
<a href="#l3.717"></a><span id="l3.717">   // XXX - need to figure out if this is the last time this server is</span>
<a href="#l3.718"></a><span id="l3.718">   // being used, and only send notification then.</span>
<a href="#l3.719"></a><span id="l3.719">   // (and only remove from hashtable then too!)</span>
<a href="#l3.720"></a><span id="l3.720">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l3.721"></a><span id="l3.721">   rv = aAccount-&gt;GetIncomingServer(getter_AddRefs(server));</span>
<a href="#l3.722"></a><span id="l3.722" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; server)</span>
<a href="#l3.723"></a><span id="l3.723" class="difflineminus">-    RemoveIncomingServer(server, aRemoveFiles);</span>
<a href="#l3.724"></a><span id="l3.724" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; server) RemoveIncomingServer(server, aRemoveFiles);</span>
<a href="#l3.725"></a><span id="l3.725"> </span>
<a href="#l3.726"></a><span id="l3.726">   nsCOMPtr&lt;nsIArray&gt; identityArray;</span>
<a href="#l3.727"></a><span id="l3.727">   rv = aAccount-&gt;GetIdentities(getter_AddRefs(identityArray));</span>
<a href="#l3.728"></a><span id="l3.728">   if (NS_SUCCEEDED(rv)) {</span>
<a href="#l3.729"></a><span id="l3.729">     uint32_t count = 0;</span>
<a href="#l3.730"></a><span id="l3.730">     identityArray-&gt;GetLength(&amp;count);</span>
<a href="#l3.731"></a><span id="l3.731">     uint32_t i;</span>
<a href="#l3.732"></a><span id="l3.732" class="difflineminus">-    for (i = 0; i &lt; count; i++)</span>
<a href="#l3.733"></a><span id="l3.733" class="difflineminus">-    {</span>
<a href="#l3.734"></a><span id="l3.734" class="difflineminus">-      nsCOMPtr&lt;nsIMsgIdentity&gt; identity( do_QueryElementAt(identityArray, i, &amp;rv));</span>
<a href="#l3.735"></a><span id="l3.735" class="difflineplus">+    for (i = 0; i &lt; count; i++) {</span>
<a href="#l3.736"></a><span id="l3.736" class="difflineplus">+      nsCOMPtr&lt;nsIMsgIdentity&gt; identity(</span>
<a href="#l3.737"></a><span id="l3.737" class="difflineplus">+          do_QueryElementAt(identityArray, i, &amp;rv));</span>
<a href="#l3.738"></a><span id="l3.738">       bool identityStillUsed = false;</span>
<a href="#l3.739"></a><span id="l3.739">       // for each identity, see if any existing account still uses it,</span>
<a href="#l3.740"></a><span id="l3.740">       // and if not, clear it.</span>
<a href="#l3.741"></a><span id="l3.741">       // Note that we are also searching here accounts with missing servers from</span>
<a href="#l3.742"></a><span id="l3.742">       //  unloaded extension types.</span>
<a href="#l3.743"></a><span id="l3.743" class="difflineminus">-      if (NS_SUCCEEDED(rv))</span>
<a href="#l3.744"></a><span id="l3.744" class="difflineminus">-      {</span>
<a href="#l3.745"></a><span id="l3.745" class="difflineplus">+      if (NS_SUCCEEDED(rv)) {</span>
<a href="#l3.746"></a><span id="l3.746">         uint32_t index;</span>
<a href="#l3.747"></a><span id="l3.747" class="difflineminus">-        for (index = 0; index &lt; m_accounts.Length() &amp;&amp; !identityStillUsed; index++)</span>
<a href="#l3.748"></a><span id="l3.748" class="difflineminus">-        {</span>
<a href="#l3.749"></a><span id="l3.749" class="difflineplus">+        for (index = 0; index &lt; m_accounts.Length() &amp;&amp; !identityStillUsed;</span>
<a href="#l3.750"></a><span id="l3.750" class="difflineplus">+             index++) {</span>
<a href="#l3.751"></a><span id="l3.751">           nsCOMPtr&lt;nsIArray&gt; existingIdentitiesArray;</span>
<a href="#l3.752"></a><span id="l3.752"> </span>
<a href="#l3.753"></a><span id="l3.753" class="difflineminus">-          rv = m_accounts[index]-&gt;GetIdentities(getter_AddRefs(existingIdentitiesArray));</span>
<a href="#l3.754"></a><span id="l3.754" class="difflineplus">+          rv = m_accounts[index]-&gt;GetIdentities(</span>
<a href="#l3.755"></a><span id="l3.755" class="difflineplus">+              getter_AddRefs(existingIdentitiesArray));</span>
<a href="#l3.756"></a><span id="l3.756">           uint32_t pos;</span>
<a href="#l3.757"></a><span id="l3.757" class="difflineminus">-          if (NS_SUCCEEDED(existingIdentitiesArray-&gt;IndexOf(0, identity, &amp;pos)))</span>
<a href="#l3.758"></a><span id="l3.758" class="difflineminus">-          {</span>
<a href="#l3.759"></a><span id="l3.759" class="difflineplus">+          if (NS_SUCCEEDED(</span>
<a href="#l3.760"></a><span id="l3.760" class="difflineplus">+                  existingIdentitiesArray-&gt;IndexOf(0, identity, &amp;pos))) {</span>
<a href="#l3.761"></a><span id="l3.761">             identityStillUsed = true;</span>
<a href="#l3.762"></a><span id="l3.762">             break;</span>
<a href="#l3.763"></a><span id="l3.763">           }</span>
<a href="#l3.764"></a><span id="l3.764">         }</span>
<a href="#l3.765"></a><span id="l3.765">       }</span>
<a href="#l3.766"></a><span id="l3.766">       // clear out all identity information if no other account uses it.</span>
<a href="#l3.767"></a><span id="l3.767" class="difflineminus">-      if (!identityStillUsed)</span>
<a href="#l3.768"></a><span id="l3.768" class="difflineminus">-        identity-&gt;ClearAllValues();</span>
<a href="#l3.769"></a><span id="l3.769" class="difflineplus">+      if (!identityStillUsed) identity-&gt;ClearAllValues();</span>
<a href="#l3.770"></a><span id="l3.770">     }</span>
<a href="#l3.771"></a><span id="l3.771">   }</span>
<a href="#l3.772"></a><span id="l3.772"> </span>
<a href="#l3.773"></a><span id="l3.773">   // It is not a critical problem if this fails as the account was already</span>
<a href="#l3.774"></a><span id="l3.774">   // removed from the list of accounts so should not ever be referenced.</span>
<a href="#l3.775"></a><span id="l3.775">   // Just print it out for debugging.</span>
<a href="#l3.776"></a><span id="l3.776">   rv = aAccount-&gt;ClearAllValues();</span>
<a href="#l3.777"></a><span id="l3.777">   NS_ASSERTION(NS_SUCCEEDED(rv), &quot;removing of account prefs failed&quot;);</span>
<a href="#l3.778"></a><span id="l3.778">   return NS_OK;</span>
<a href="#l3.779"></a><span id="l3.779"> }</span>
<a href="#l3.780"></a><span id="l3.780"> </span>
<a href="#l3.781"></a><span id="l3.781" class="difflineminus">-nsresult</span>
<a href="#l3.782"></a><span id="l3.782" class="difflineminus">-nsMsgAccountManager::OutputAccountsPref()</span>
<a href="#l3.783"></a><span id="l3.783" class="difflineminus">-{</span>
<a href="#l3.784"></a><span id="l3.784" class="difflineplus">+nsresult nsMsgAccountManager::OutputAccountsPref() {</span>
<a href="#l3.785"></a><span id="l3.785">   nsCString accountKey;</span>
<a href="#l3.786"></a><span id="l3.786">   mAccountKeyList.Truncate();</span>
<a href="#l3.787"></a><span id="l3.787"> </span>
<a href="#l3.788"></a><span id="l3.788" class="difflineminus">-  for (uint32_t index = 0; index &lt; m_accounts.Length(); index++)</span>
<a href="#l3.789"></a><span id="l3.789" class="difflineminus">-  {</span>
<a href="#l3.790"></a><span id="l3.790" class="difflineplus">+  for (uint32_t index = 0; index &lt; m_accounts.Length(); index++) {</span>
<a href="#l3.791"></a><span id="l3.791">     m_accounts[index]-&gt;GetKey(accountKey);</span>
<a href="#l3.792"></a><span id="l3.792" class="difflineminus">-    if (index)</span>
<a href="#l3.793"></a><span id="l3.793" class="difflineminus">-      mAccountKeyList.Append(ACCOUNT_DELIMITER);</span>
<a href="#l3.794"></a><span id="l3.794" class="difflineplus">+    if (index) mAccountKeyList.Append(ACCOUNT_DELIMITER);</span>
<a href="#l3.795"></a><span id="l3.795">     mAccountKeyList.Append(accountKey);</span>
<a href="#l3.796"></a><span id="l3.796">   }</span>
<a href="#l3.797"></a><span id="l3.797">   return m_prefs-&gt;SetCharPref(PREF_MAIL_ACCOUNTMANAGER_ACCOUNTS,</span>
<a href="#l3.798"></a><span id="l3.798">                               mAccountKeyList);</span>
<a href="#l3.799"></a><span id="l3.799"> }</span>
<a href="#l3.800"></a><span id="l3.800"> </span>
<a href="#l3.801"></a><span id="l3.801"> /**</span>
<a href="#l3.802"></a><span id="l3.802">  * Get the default account. If no default account, return null.</span>
<a href="#l3.803"></a><span id="l3.803">  */</span>
<a href="#l3.804"></a><span id="l3.804"> NS_IMETHODIMP</span>
<a href="#l3.805"></a><span id="l3.805" class="difflineminus">-nsMsgAccountManager::GetDefaultAccount(nsIMsgAccount **aDefaultAccount)</span>
<a href="#l3.806"></a><span id="l3.806" class="difflineminus">-{</span>
<a href="#l3.807"></a><span id="l3.807" class="difflineplus">+nsMsgAccountManager::GetDefaultAccount(nsIMsgAccount **aDefaultAccount) {</span>
<a href="#l3.808"></a><span id="l3.808">   NS_ENSURE_ARG_POINTER(aDefaultAccount);</span>
<a href="#l3.809"></a><span id="l3.809"> </span>
<a href="#l3.810"></a><span id="l3.810">   nsresult rv = LoadAccounts();</span>
<a href="#l3.811"></a><span id="l3.811">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.812"></a><span id="l3.812"> </span>
<a href="#l3.813"></a><span id="l3.813">   if (!m_defaultAccount) {</span>
<a href="#l3.814"></a><span id="l3.814">     nsCString defaultKey;</span>
<a href="#l3.815"></a><span id="l3.815" class="difflineminus">-    rv = m_prefs-&gt;GetCharPref(PREF_MAIL_ACCOUNTMANAGER_DEFAULTACCOUNT, defaultKey);</span>
<a href="#l3.816"></a><span id="l3.816" class="difflineplus">+    rv = m_prefs-&gt;GetCharPref(PREF_MAIL_ACCOUNTMANAGER_DEFAULTACCOUNT,</span>
<a href="#l3.817"></a><span id="l3.817" class="difflineplus">+                              defaultKey);</span>
<a href="#l3.818"></a><span id="l3.818">     if (NS_SUCCEEDED(rv)) {</span>
<a href="#l3.819"></a><span id="l3.819">       rv = GetAccount(defaultKey, getter_AddRefs(m_defaultAccount));</span>
<a href="#l3.820"></a><span id="l3.820">       if (NS_SUCCEEDED(rv) &amp;&amp; m_defaultAccount) {</span>
<a href="#l3.821"></a><span id="l3.821">         bool canBeDefault = false;</span>
<a href="#l3.822"></a><span id="l3.822">         rv = CheckDefaultAccount(m_defaultAccount, canBeDefault);</span>
<a href="#l3.823"></a><span id="l3.823" class="difflineminus">-        if (NS_FAILED(rv) || !canBeDefault)</span>
<a href="#l3.824"></a><span id="l3.824" class="difflineminus">-          m_defaultAccount = nullptr;</span>
<a href="#l3.825"></a><span id="l3.825" class="difflineplus">+        if (NS_FAILED(rv) || !canBeDefault) m_defaultAccount = nullptr;</span>
<a href="#l3.826"></a><span id="l3.826">       }</span>
<a href="#l3.827"></a><span id="l3.827">     }</span>
<a href="#l3.828"></a><span id="l3.828">   }</span>
<a href="#l3.829"></a><span id="l3.829"> </span>
<a href="#l3.830"></a><span id="l3.830">   NS_IF_ADDREF(*aDefaultAccount = m_defaultAccount);</span>
<a href="#l3.831"></a><span id="l3.831">   return NS_OK;</span>
<a href="#l3.832"></a><span id="l3.832"> }</span>
<a href="#l3.833"></a><span id="l3.833"> </span>
<a href="#l3.834"></a><span id="l3.834"> /**</span>
<a href="#l3.835"></a><span id="l3.835">  * Check if the given account can be default.</span>
<a href="#l3.836"></a><span id="l3.836">  */</span>
<a href="#l3.837"></a><span id="l3.837" class="difflineminus">-nsresult</span>
<a href="#l3.838"></a><span id="l3.838" class="difflineminus">-nsMsgAccountManager::CheckDefaultAccount(nsIMsgAccount *aAccount, bool &amp;aCanBeDefault)</span>
<a href="#l3.839"></a><span id="l3.839" class="difflineminus">-{</span>
<a href="#l3.840"></a><span id="l3.840" class="difflineplus">+nsresult nsMsgAccountManager::CheckDefaultAccount(nsIMsgAccount *aAccount,</span>
<a href="#l3.841"></a><span id="l3.841" class="difflineplus">+                                                  bool &amp;aCanBeDefault) {</span>
<a href="#l3.842"></a><span id="l3.842">   aCanBeDefault = false;</span>
<a href="#l3.843"></a><span id="l3.843">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l3.844"></a><span id="l3.844">   // Server could be null if created by an unloaded extension.</span>
<a href="#l3.845"></a><span id="l3.845">   nsresult rv = aAccount-&gt;GetIncomingServer(getter_AddRefs(server));</span>
<a href="#l3.846"></a><span id="l3.846">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.847"></a><span id="l3.847">   if (server) {</span>
<a href="#l3.848"></a><span id="l3.848">     // Check if server can be default.</span>
<a href="#l3.849"></a><span id="l3.849">     rv = server-&gt;GetCanBeDefaultServer(&amp;aCanBeDefault);</span>
<a href="#l3.850"></a><span id="l3.850">   }</span>
<a href="#l3.851"></a><span id="l3.851">   return rv;</span>
<a href="#l3.852"></a><span id="l3.852"> }</span>
<a href="#l3.853"></a><span id="l3.853"> </span>
<a href="#l3.854"></a><span id="l3.854"> /**</span>
<a href="#l3.855"></a><span id="l3.855">  * Pick the first account that can be default and make it the default.</span>
<a href="#l3.856"></a><span id="l3.856">  */</span>
<a href="#l3.857"></a><span id="l3.857" class="difflineminus">-nsresult</span>
<a href="#l3.858"></a><span id="l3.858" class="difflineminus">-nsMsgAccountManager::AutosetDefaultAccount()</span>
<a href="#l3.859"></a><span id="l3.859" class="difflineminus">-{</span>
<a href="#l3.860"></a><span id="l3.860" class="difflineminus">-  for (nsIMsgAccount* account : m_accounts) {</span>
<a href="#l3.861"></a><span id="l3.861" class="difflineplus">+nsresult nsMsgAccountManager::AutosetDefaultAccount() {</span>
<a href="#l3.862"></a><span id="l3.862" class="difflineplus">+  for (nsIMsgAccount *account : m_accounts) {</span>
<a href="#l3.863"></a><span id="l3.863">     bool canBeDefault = false;</span>
<a href="#l3.864"></a><span id="l3.864">     nsresult rv = CheckDefaultAccount(account, canBeDefault);</span>
<a href="#l3.865"></a><span id="l3.865">     if (NS_SUCCEEDED(rv) &amp;&amp; canBeDefault) {</span>
<a href="#l3.866"></a><span id="l3.866">       return SetDefaultAccount(account);</span>
<a href="#l3.867"></a><span id="l3.867">     }</span>
<a href="#l3.868"></a><span id="l3.868">   }</span>
<a href="#l3.869"></a><span id="l3.869">   return NS_OK;</span>
<a href="#l3.870"></a><span id="l3.870"> }</span>
<a href="#l3.871"></a><span id="l3.871"> </span>
<a href="#l3.872"></a><span id="l3.872"> NS_IMETHODIMP</span>
<a href="#l3.873"></a><span id="l3.873" class="difflineminus">-nsMsgAccountManager::SetDefaultAccount(nsIMsgAccount *aDefaultAccount)</span>
<a href="#l3.874"></a><span id="l3.874" class="difflineminus">-{</span>
<a href="#l3.875"></a><span id="l3.875" class="difflineminus">-  if (!aDefaultAccount)</span>
<a href="#l3.876"></a><span id="l3.876" class="difflineminus">-    return NS_ERROR_INVALID_ARG;</span>
<a href="#l3.877"></a><span id="l3.877" class="difflineminus">-</span>
<a href="#l3.878"></a><span id="l3.878" class="difflineminus">-  if (m_defaultAccount != aDefaultAccount)</span>
<a href="#l3.879"></a><span id="l3.879" class="difflineminus">-  {</span>
<a href="#l3.880"></a><span id="l3.880" class="difflineplus">+nsMsgAccountManager::SetDefaultAccount(nsIMsgAccount *aDefaultAccount) {</span>
<a href="#l3.881"></a><span id="l3.881" class="difflineplus">+  if (!aDefaultAccount) return NS_ERROR_INVALID_ARG;</span>
<a href="#l3.882"></a><span id="l3.882" class="difflineplus">+</span>
<a href="#l3.883"></a><span id="l3.883" class="difflineplus">+  if (m_defaultAccount != aDefaultAccount) {</span>
<a href="#l3.884"></a><span id="l3.884">     bool canBeDefault = false;</span>
<a href="#l3.885"></a><span id="l3.885">     nsresult rv = CheckDefaultAccount(aDefaultAccount, canBeDefault);</span>
<a href="#l3.886"></a><span id="l3.886">     if (NS_FAILED(rv) || !canBeDefault) {</span>
<a href="#l3.887"></a><span id="l3.887">       // Report failure if we were explicitly asked to use an unusable server.</span>
<a href="#l3.888"></a><span id="l3.888">       return NS_ERROR_INVALID_ARG;</span>
<a href="#l3.889"></a><span id="l3.889">     }</span>
<a href="#l3.890"></a><span id="l3.890">     nsCOMPtr&lt;nsIMsgAccount&gt; oldAccount = m_defaultAccount;</span>
<a href="#l3.891"></a><span id="l3.891">     m_defaultAccount = aDefaultAccount;</span>
<a href="#l3.892"></a><span id="l3.892" class="difflineminus">-    (void) setDefaultAccountPref(aDefaultAccount);</span>
<a href="#l3.893"></a><span id="l3.893" class="difflineminus">-    (void) notifyDefaultServerChange(oldAccount, aDefaultAccount);</span>
<a href="#l3.894"></a><span id="l3.894" class="difflineplus">+    (void)setDefaultAccountPref(aDefaultAccount);</span>
<a href="#l3.895"></a><span id="l3.895" class="difflineplus">+    (void)notifyDefaultServerChange(oldAccount, aDefaultAccount);</span>
<a href="#l3.896"></a><span id="l3.896">   }</span>
<a href="#l3.897"></a><span id="l3.897">   return NS_OK;</span>
<a href="#l3.898"></a><span id="l3.898"> }</span>
<a href="#l3.899"></a><span id="l3.899"> </span>
<a href="#l3.900"></a><span id="l3.900"> // fire notifications</span>
<a href="#l3.901"></a><span id="l3.901" class="difflineminus">-nsresult</span>
<a href="#l3.902"></a><span id="l3.902" class="difflineminus">-nsMsgAccountManager::notifyDefaultServerChange(nsIMsgAccount *aOldAccount,</span>
<a href="#l3.903"></a><span id="l3.903" class="difflineminus">-                                               nsIMsgAccount *aNewAccount)</span>
<a href="#l3.904"></a><span id="l3.904" class="difflineminus">-{</span>
<a href="#l3.905"></a><span id="l3.905" class="difflineplus">+nsresult nsMsgAccountManager::notifyDefaultServerChange(</span>
<a href="#l3.906"></a><span id="l3.906" class="difflineplus">+    nsIMsgAccount *aOldAccount, nsIMsgAccount *aNewAccount) {</span>
<a href="#l3.907"></a><span id="l3.907">   nsresult rv;</span>
<a href="#l3.908"></a><span id="l3.908"> </span>
<a href="#l3.909"></a><span id="l3.909">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l3.910"></a><span id="l3.910">   nsCOMPtr&lt;nsIMsgFolder&gt; rootFolder;</span>
<a href="#l3.911"></a><span id="l3.911"> </span>
<a href="#l3.912"></a><span id="l3.912">   // first tell old server it's no longer the default</span>
<a href="#l3.913"></a><span id="l3.913">   if (aOldAccount) {</span>
<a href="#l3.914"></a><span id="l3.914">     rv = aOldAccount-&gt;GetIncomingServer(getter_AddRefs(server));</span>
<a href="#l3.915"></a><span id="l3.915">     if (NS_SUCCEEDED(rv) &amp;&amp; server) {</span>
<a href="#l3.916"></a><span id="l3.916">       rv = server-&gt;GetRootFolder(getter_AddRefs(rootFolder));</span>
<a href="#l3.917"></a><span id="l3.917">       if (NS_SUCCEEDED(rv) &amp;&amp; rootFolder)</span>
<a href="#l3.918"></a><span id="l3.918" class="difflineminus">-        rootFolder-&gt;NotifyBoolPropertyChanged(kDefaultServer,</span>
<a href="#l3.919"></a><span id="l3.919" class="difflineminus">-                                              true, false);</span>
<a href="#l3.920"></a><span id="l3.920" class="difflineplus">+        rootFolder-&gt;NotifyBoolPropertyChanged(kDefaultServer, true, false);</span>
<a href="#l3.921"></a><span id="l3.921">     }</span>
<a href="#l3.922"></a><span id="l3.922">   }</span>
<a href="#l3.923"></a><span id="l3.923"> </span>
<a href="#l3.924"></a><span id="l3.924" class="difflineminus">-    // now tell new server it is.</span>
<a href="#l3.925"></a><span id="l3.925" class="difflineplus">+  // now tell new server it is.</span>
<a href="#l3.926"></a><span id="l3.926">   if (aNewAccount) {</span>
<a href="#l3.927"></a><span id="l3.927">     rv = aNewAccount-&gt;GetIncomingServer(getter_AddRefs(server));</span>
<a href="#l3.928"></a><span id="l3.928">     if (NS_SUCCEEDED(rv) &amp;&amp; server) {</span>
<a href="#l3.929"></a><span id="l3.929">       rv = server-&gt;GetRootFolder(getter_AddRefs(rootFolder));</span>
<a href="#l3.930"></a><span id="l3.930">       if (NS_SUCCEEDED(rv) &amp;&amp; rootFolder)</span>
<a href="#l3.931"></a><span id="l3.931" class="difflineminus">-        rootFolder-&gt;NotifyBoolPropertyChanged(kDefaultServer,</span>
<a href="#l3.932"></a><span id="l3.932" class="difflineminus">-                                              false, true);</span>
<a href="#l3.933"></a><span id="l3.933" class="difflineplus">+        rootFolder-&gt;NotifyBoolPropertyChanged(kDefaultServer, false, true);</span>
<a href="#l3.934"></a><span id="l3.934">     }</span>
<a href="#l3.935"></a><span id="l3.935">   }</span>
<a href="#l3.936"></a><span id="l3.936"> </span>
<a href="#l3.937"></a><span id="l3.937" class="difflineminus">-  if (aOldAccount &amp;&amp; aNewAccount)  //only notify if the user goes and changes default account</span>
<a href="#l3.938"></a><span id="l3.938" class="difflineminus">-  {</span>
<a href="#l3.939"></a><span id="l3.939" class="difflineplus">+  // only notify if the user goes and changes default account</span>
<a href="#l3.940"></a><span id="l3.940" class="difflineplus">+  if (aOldAccount &amp;&amp; aNewAccount) {</span>
<a href="#l3.941"></a><span id="l3.941">     nsCOMPtr&lt;nsIObserverService&gt; observerService =</span>
<a href="#l3.942"></a><span id="l3.942" class="difflineminus">-      mozilla::services::GetObserverService();</span>
<a href="#l3.943"></a><span id="l3.943" class="difflineplus">+        mozilla::services::GetObserverService();</span>
<a href="#l3.944"></a><span id="l3.944"> </span>
<a href="#l3.945"></a><span id="l3.945">     if (observerService)</span>
<a href="#l3.946"></a><span id="l3.946" class="difflineminus">-      observerService-&gt;NotifyObservers(nullptr,&quot;mailDefaultAccountChanged&quot;,nullptr);</span>
<a href="#l3.947"></a><span id="l3.947" class="difflineplus">+      observerService-&gt;NotifyObservers(nullptr, &quot;mailDefaultAccountChanged&quot;,</span>
<a href="#l3.948"></a><span id="l3.948" class="difflineplus">+                                       nullptr);</span>
<a href="#l3.949"></a><span id="l3.949">   }</span>
<a href="#l3.950"></a><span id="l3.950"> </span>
<a href="#l3.951"></a><span id="l3.951">   return NS_OK;</span>
<a href="#l3.952"></a><span id="l3.952"> }</span>
<a href="#l3.953"></a><span id="l3.953"> </span>
<a href="#l3.954"></a><span id="l3.954" class="difflineminus">-nsresult</span>
<a href="#l3.955"></a><span id="l3.955" class="difflineminus">-nsMsgAccountManager::setDefaultAccountPref(nsIMsgAccount* aDefaultAccount)</span>
<a href="#l3.956"></a><span id="l3.956" class="difflineminus">-{</span>
<a href="#l3.957"></a><span id="l3.957" class="difflineplus">+nsresult nsMsgAccountManager::setDefaultAccountPref(</span>
<a href="#l3.958"></a><span id="l3.958" class="difflineplus">+    nsIMsgAccount *aDefaultAccount) {</span>
<a href="#l3.959"></a><span id="l3.959">   nsresult rv;</span>
<a href="#l3.960"></a><span id="l3.960"> </span>
<a href="#l3.961"></a><span id="l3.961">   if (aDefaultAccount) {</span>
<a href="#l3.962"></a><span id="l3.962">     nsCString key;</span>
<a href="#l3.963"></a><span id="l3.963">     rv = aDefaultAccount-&gt;GetKey(key);</span>
<a href="#l3.964"></a><span id="l3.964">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.965"></a><span id="l3.965"> </span>
<a href="#l3.966"></a><span id="l3.966">     rv = m_prefs-&gt;SetCharPref(PREF_MAIL_ACCOUNTMANAGER_DEFAULTACCOUNT, key);</span>
<a href="#l3.967"></a><span id="l3.967" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l3.968"></a><span id="l3.968" class="difflineminus">-  }</span>
<a href="#l3.969"></a><span id="l3.969" class="difflineminus">-  else</span>
<a href="#l3.970"></a><span id="l3.970" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.971"></a><span id="l3.971" class="difflineplus">+  } else</span>
<a href="#l3.972"></a><span id="l3.972">     m_prefs-&gt;ClearUserPref(PREF_MAIL_ACCOUNTMANAGER_DEFAULTACCOUNT);</span>
<a href="#l3.973"></a><span id="l3.973"> </span>
<a href="#l3.974"></a><span id="l3.974">   return NS_OK;</span>
<a href="#l3.975"></a><span id="l3.975"> }</span>
<a href="#l3.976"></a><span id="l3.976"> </span>
<a href="#l3.977"></a><span id="l3.977" class="difflineminus">-void nsMsgAccountManager::LogoutOfServer(nsIMsgIncomingServer *aServer)</span>
<a href="#l3.978"></a><span id="l3.978" class="difflineminus">-{</span>
<a href="#l3.979"></a><span id="l3.979" class="difflineminus">-  if (!aServer)</span>
<a href="#l3.980"></a><span id="l3.980" class="difflineminus">-    return;</span>
<a href="#l3.981"></a><span id="l3.981" class="difflineplus">+void nsMsgAccountManager::LogoutOfServer(nsIMsgIncomingServer *aServer) {</span>
<a href="#l3.982"></a><span id="l3.982" class="difflineplus">+  if (!aServer) return;</span>
<a href="#l3.983"></a><span id="l3.983">   mozilla::DebugOnly&lt;nsresult&gt; rv = aServer-&gt;Shutdown();</span>
<a href="#l3.984"></a><span id="l3.984">   NS_ASSERTION(NS_SUCCEEDED(rv), &quot;Shutdown of server failed&quot;);</span>
<a href="#l3.985"></a><span id="l3.985">   rv = aServer-&gt;ForgetSessionPassword();</span>
<a href="#l3.986"></a><span id="l3.986" class="difflineminus">-  NS_ASSERTION(NS_SUCCEEDED(rv), &quot;failed to remove the password associated with server&quot;);</span>
<a href="#l3.987"></a><span id="l3.987" class="difflineplus">+  NS_ASSERTION(NS_SUCCEEDED(rv),</span>
<a href="#l3.988"></a><span id="l3.988" class="difflineplus">+               &quot;failed to remove the password associated with server&quot;);</span>
<a href="#l3.989"></a><span id="l3.989"> }</span>
<a href="#l3.990"></a><span id="l3.990"> </span>
<a href="#l3.991"></a><span id="l3.991" class="difflineminus">-NS_IMETHODIMP nsMsgAccountManager::GetFolderCache(nsIMsgFolderCache* *aFolderCache)</span>
<a href="#l3.992"></a><span id="l3.992" class="difflineminus">-{</span>
<a href="#l3.993"></a><span id="l3.993" class="difflineplus">+NS_IMETHODIMP nsMsgAccountManager::GetFolderCache(</span>
<a href="#l3.994"></a><span id="l3.994" class="difflineplus">+    nsIMsgFolderCache **aFolderCache) {</span>
<a href="#l3.995"></a><span id="l3.995">   NS_ENSURE_ARG_POINTER(aFolderCache);</span>
<a href="#l3.996"></a><span id="l3.996">   nsresult rv = NS_OK;</span>
<a href="#l3.997"></a><span id="l3.997"> </span>
<a href="#l3.998"></a><span id="l3.998" class="difflineminus">-  if (!m_msgFolderCache)</span>
<a href="#l3.999"></a><span id="l3.999" class="difflineminus">-  {</span>
<a href="#l3.1000"></a><span id="l3.1000" class="difflineplus">+  if (!m_msgFolderCache) {</span>
<a href="#l3.1001"></a><span id="l3.1001">     m_msgFolderCache = do_CreateInstance(kMsgFolderCacheCID, &amp;rv);</span>
<a href="#l3.1002"></a><span id="l3.1002">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.1003"></a><span id="l3.1003"> </span>
<a href="#l3.1004"></a><span id="l3.1004">     nsCOMPtr&lt;nsIFile&gt; cacheFile;</span>
<a href="#l3.1005"></a><span id="l3.1005">     rv = NS_GetSpecialDirectory(NS_APP_MESSENGER_FOLDER_CACHE_50_FILE,</span>
<a href="#l3.1006"></a><span id="l3.1006">                                 getter_AddRefs(cacheFile));</span>
<a href="#l3.1007"></a><span id="l3.1007">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.1008"></a><span id="l3.1008">     m_msgFolderCache-&gt;Init(cacheFile);</span>
<a href="#l3.1009"></a><span id="l3.1009">   }</span>
<a href="#l3.1010"></a><span id="l3.1010"> </span>
<a href="#l3.1011"></a><span id="l3.1011">   NS_IF_ADDREF(*aFolderCache = m_msgFolderCache);</span>
<a href="#l3.1012"></a><span id="l3.1012">   return rv;</span>
<a href="#l3.1013"></a><span id="l3.1013"> }</span>
<a href="#l3.1014"></a><span id="l3.1014"> </span>
<a href="#l3.1015"></a><span id="l3.1015"> NS_IMETHODIMP</span>
<a href="#l3.1016"></a><span id="l3.1016" class="difflineminus">-nsMsgAccountManager::GetAccounts(nsIArray **_retval)</span>
<a href="#l3.1017"></a><span id="l3.1017" class="difflineminus">-{</span>
<a href="#l3.1018"></a><span id="l3.1018" class="difflineplus">+nsMsgAccountManager::GetAccounts(nsIArray **_retval) {</span>
<a href="#l3.1019"></a><span id="l3.1019">   nsresult rv = LoadAccounts();</span>
<a href="#l3.1020"></a><span id="l3.1020">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.1021"></a><span id="l3.1021"> </span>
<a href="#l3.1022"></a><span id="l3.1022" class="difflineminus">-  nsCOMPtr&lt;nsIMutableArray&gt; accounts(do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l3.1023"></a><span id="l3.1023" class="difflineplus">+  nsCOMPtr&lt;nsIMutableArray&gt; accounts(</span>
<a href="#l3.1024"></a><span id="l3.1024" class="difflineplus">+      do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l3.1025"></a><span id="l3.1025">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.1026"></a><span id="l3.1026"> </span>
<a href="#l3.1027"></a><span id="l3.1027" class="difflineminus">-  for (uint32_t index = 0; index &lt; m_accounts.Length(); index++)</span>
<a href="#l3.1028"></a><span id="l3.1028" class="difflineminus">-  {</span>
<a href="#l3.1029"></a><span id="l3.1029" class="difflineplus">+  for (uint32_t index = 0; index &lt; m_accounts.Length(); index++) {</span>
<a href="#l3.1030"></a><span id="l3.1030">     nsCOMPtr&lt;nsIMsgAccount&gt; existingAccount(m_accounts[index]);</span>
<a href="#l3.1031"></a><span id="l3.1031">     nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l3.1032"></a><span id="l3.1032">     existingAccount-&gt;GetIncomingServer(getter_AddRefs(server));</span>
<a href="#l3.1033"></a><span id="l3.1033" class="difflineminus">-    if (!server)</span>
<a href="#l3.1034"></a><span id="l3.1034" class="difflineminus">-      continue;</span>
<a href="#l3.1035"></a><span id="l3.1035" class="difflineminus">-    if (server)</span>
<a href="#l3.1036"></a><span id="l3.1036" class="difflineminus">-    {</span>
<a href="#l3.1037"></a><span id="l3.1037" class="difflineplus">+    if (!server) continue;</span>
<a href="#l3.1038"></a><span id="l3.1038" class="difflineplus">+    if (server) {</span>
<a href="#l3.1039"></a><span id="l3.1039">       bool hidden = false;</span>
<a href="#l3.1040"></a><span id="l3.1040">       server-&gt;GetHidden(&amp;hidden);</span>
<a href="#l3.1041"></a><span id="l3.1041" class="difflineminus">-      if (hidden)</span>
<a href="#l3.1042"></a><span id="l3.1042" class="difflineminus">-        continue;</span>
<a href="#l3.1043"></a><span id="l3.1043" class="difflineplus">+      if (hidden) continue;</span>
<a href="#l3.1044"></a><span id="l3.1044">     }</span>
<a href="#l3.1045"></a><span id="l3.1045">     accounts-&gt;AppendElement(existingAccount);</span>
<a href="#l3.1046"></a><span id="l3.1046">   }</span>
<a href="#l3.1047"></a><span id="l3.1047">   accounts.forget(_retval);</span>
<a href="#l3.1048"></a><span id="l3.1048">   return NS_OK;</span>
<a href="#l3.1049"></a><span id="l3.1049"> }</span>
<a href="#l3.1050"></a><span id="l3.1050"> </span>
<a href="#l3.1051"></a><span id="l3.1051"> NS_IMETHODIMP</span>
<a href="#l3.1052"></a><span id="l3.1052" class="difflineminus">-nsMsgAccountManager::GetAllIdentities(nsIArray **_retval)</span>
<a href="#l3.1053"></a><span id="l3.1053" class="difflineminus">-{</span>
<a href="#l3.1054"></a><span id="l3.1054" class="difflineplus">+nsMsgAccountManager::GetAllIdentities(nsIArray **_retval) {</span>
<a href="#l3.1055"></a><span id="l3.1055">   nsresult rv = LoadAccounts();</span>
<a href="#l3.1056"></a><span id="l3.1056">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.1057"></a><span id="l3.1057"> </span>
<a href="#l3.1058"></a><span id="l3.1058">   nsCOMPtr&lt;nsIMutableArray&gt; result(do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l3.1059"></a><span id="l3.1059">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.1060"></a><span id="l3.1060"> </span>
<a href="#l3.1061"></a><span id="l3.1061">   nsCOMPtr&lt;nsIArray&gt; identities;</span>
<a href="#l3.1062"></a><span id="l3.1062"> </span>
<a href="#l3.1063"></a><span id="l3.1063">   for (uint32_t i = 0; i &lt; m_accounts.Length(); ++i) {</span>
<a href="#l3.1064"></a><span id="l3.1064">     rv = m_accounts[i]-&gt;GetIdentities(getter_AddRefs(identities));</span>
<a href="#l3.1065"></a><span id="l3.1065" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l3.1066"></a><span id="l3.1066" class="difflineminus">-      continue;</span>
<a href="#l3.1067"></a><span id="l3.1067" class="difflineplus">+    if (NS_FAILED(rv)) continue;</span>
<a href="#l3.1068"></a><span id="l3.1068"> </span>
<a href="#l3.1069"></a><span id="l3.1069">     uint32_t idCount;</span>
<a href="#l3.1070"></a><span id="l3.1070">     rv = identities-&gt;GetLength(&amp;idCount);</span>
<a href="#l3.1071"></a><span id="l3.1071" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l3.1072"></a><span id="l3.1072" class="difflineminus">-      continue;</span>
<a href="#l3.1073"></a><span id="l3.1073" class="difflineplus">+    if (NS_FAILED(rv)) continue;</span>
<a href="#l3.1074"></a><span id="l3.1074"> </span>
<a href="#l3.1075"></a><span id="l3.1075">     for (uint32_t j = 0; j &lt; idCount; ++j) {</span>
<a href="#l3.1076"></a><span id="l3.1076">       nsCOMPtr&lt;nsIMsgIdentity&gt; identity(do_QueryElementAt(identities, j, &amp;rv));</span>
<a href="#l3.1077"></a><span id="l3.1077" class="difflineminus">-      if (NS_FAILED(rv))</span>
<a href="#l3.1078"></a><span id="l3.1078" class="difflineminus">-        continue;</span>
<a href="#l3.1079"></a><span id="l3.1079" class="difflineplus">+      if (NS_FAILED(rv)) continue;</span>
<a href="#l3.1080"></a><span id="l3.1080"> </span>
<a href="#l3.1081"></a><span id="l3.1081">       nsAutoCString key;</span>
<a href="#l3.1082"></a><span id="l3.1082">       rv = identity-&gt;GetKey(key);</span>
<a href="#l3.1083"></a><span id="l3.1083" class="difflineminus">-      if (NS_FAILED(rv))</span>
<a href="#l3.1084"></a><span id="l3.1084" class="difflineminus">-        continue;</span>
<a href="#l3.1085"></a><span id="l3.1085" class="difflineplus">+      if (NS_FAILED(rv)) continue;</span>
<a href="#l3.1086"></a><span id="l3.1086"> </span>
<a href="#l3.1087"></a><span id="l3.1087">       uint32_t resultCount;</span>
<a href="#l3.1088"></a><span id="l3.1088">       rv = result-&gt;GetLength(&amp;resultCount);</span>
<a href="#l3.1089"></a><span id="l3.1089" class="difflineminus">-      if (NS_FAILED(rv))</span>
<a href="#l3.1090"></a><span id="l3.1090" class="difflineminus">-        continue;</span>
<a href="#l3.1091"></a><span id="l3.1091" class="difflineplus">+      if (NS_FAILED(rv)) continue;</span>
<a href="#l3.1092"></a><span id="l3.1092"> </span>
<a href="#l3.1093"></a><span id="l3.1093">       bool found = false;</span>
<a href="#l3.1094"></a><span id="l3.1094">       for (uint32_t k = 0; k &lt; resultCount &amp;&amp; !found; ++k) {</span>
<a href="#l3.1095"></a><span id="l3.1095" class="difflineminus">-        nsCOMPtr&lt;nsIMsgIdentity&gt; thisIdentity(do_QueryElementAt(result, k, &amp;rv));</span>
<a href="#l3.1096"></a><span id="l3.1096" class="difflineminus">-        if (NS_FAILED(rv))</span>
<a href="#l3.1097"></a><span id="l3.1097" class="difflineminus">-          continue;</span>
<a href="#l3.1098"></a><span id="l3.1098" class="difflineplus">+        nsCOMPtr&lt;nsIMsgIdentity&gt; thisIdentity(</span>
<a href="#l3.1099"></a><span id="l3.1099" class="difflineplus">+            do_QueryElementAt(result, k, &amp;rv));</span>
<a href="#l3.1100"></a><span id="l3.1100" class="difflineplus">+        if (NS_FAILED(rv)) continue;</span>
<a href="#l3.1101"></a><span id="l3.1101"> </span>
<a href="#l3.1102"></a><span id="l3.1102">         nsAutoCString thisKey;</span>
<a href="#l3.1103"></a><span id="l3.1103">         rv = thisIdentity-&gt;GetKey(thisKey);</span>
<a href="#l3.1104"></a><span id="l3.1104" class="difflineminus">-        if (NS_FAILED(rv))</span>
<a href="#l3.1105"></a><span id="l3.1105" class="difflineminus">-          continue;</span>
<a href="#l3.1106"></a><span id="l3.1106" class="difflineminus">-</span>
<a href="#l3.1107"></a><span id="l3.1107" class="difflineminus">-        if (key == thisKey)</span>
<a href="#l3.1108"></a><span id="l3.1108" class="difflineminus">-          found = true;</span>
<a href="#l3.1109"></a><span id="l3.1109" class="difflineplus">+        if (NS_FAILED(rv)) continue;</span>
<a href="#l3.1110"></a><span id="l3.1110" class="difflineplus">+</span>
<a href="#l3.1111"></a><span id="l3.1111" class="difflineplus">+        if (key == thisKey) found = true;</span>
<a href="#l3.1112"></a><span id="l3.1112">       }</span>
<a href="#l3.1113"></a><span id="l3.1113"> </span>
<a href="#l3.1114"></a><span id="l3.1114" class="difflineminus">-      if (!found)</span>
<a href="#l3.1115"></a><span id="l3.1115" class="difflineminus">-        result-&gt;AppendElement(identity);</span>
<a href="#l3.1116"></a><span id="l3.1116" class="difflineplus">+      if (!found) result-&gt;AppendElement(identity);</span>
<a href="#l3.1117"></a><span id="l3.1117">     }</span>
<a href="#l3.1118"></a><span id="l3.1118">   }</span>
<a href="#l3.1119"></a><span id="l3.1119">   result.forget(_retval);</span>
<a href="#l3.1120"></a><span id="l3.1120">   return rv;</span>
<a href="#l3.1121"></a><span id="l3.1121"> }</span>
<a href="#l3.1122"></a><span id="l3.1122"> </span>
<a href="#l3.1123"></a><span id="l3.1123"> NS_IMETHODIMP</span>
<a href="#l3.1124"></a><span id="l3.1124" class="difflineminus">-nsMsgAccountManager::GetAllServers(nsIArray **_retval)</span>
<a href="#l3.1125"></a><span id="l3.1125" class="difflineminus">-{</span>
<a href="#l3.1126"></a><span id="l3.1126" class="difflineplus">+nsMsgAccountManager::GetAllServers(nsIArray **_retval) {</span>
<a href="#l3.1127"></a><span id="l3.1127">   nsresult rv = LoadAccounts();</span>
<a href="#l3.1128"></a><span id="l3.1128">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.1129"></a><span id="l3.1129"> </span>
<a href="#l3.1130"></a><span id="l3.1130" class="difflineminus">-  nsCOMPtr&lt;nsIMutableArray&gt; servers(do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l3.1131"></a><span id="l3.1131" class="difflineplus">+  nsCOMPtr&lt;nsIMutableArray&gt; servers(</span>
<a href="#l3.1132"></a><span id="l3.1132" class="difflineplus">+      do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l3.1133"></a><span id="l3.1133">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.1134"></a><span id="l3.1134"> </span>
<a href="#l3.1135"></a><span id="l3.1135">   for (auto iter = m_incomingServers.Iter(); !iter.Done(); iter.Next()) {</span>
<a href="#l3.1136"></a><span id="l3.1136" class="difflineminus">-    nsCOMPtr&lt;nsIMsgIncomingServer&gt;&amp; server = iter.Data();</span>
<a href="#l3.1137"></a><span id="l3.1137" class="difflineminus">-    if (!server)</span>
<a href="#l3.1138"></a><span id="l3.1138" class="difflineminus">-      continue;</span>
<a href="#l3.1139"></a><span id="l3.1139" class="difflineplus">+    nsCOMPtr&lt;nsIMsgIncomingServer&gt; &amp;server = iter.Data();</span>
<a href="#l3.1140"></a><span id="l3.1140" class="difflineplus">+    if (!server) continue;</span>
<a href="#l3.1141"></a><span id="l3.1141"> </span>
<a href="#l3.1142"></a><span id="l3.1142">     bool hidden = false;</span>
<a href="#l3.1143"></a><span id="l3.1143">     server-&gt;GetHidden(&amp;hidden);</span>
<a href="#l3.1144"></a><span id="l3.1144" class="difflineminus">-    if (hidden)</span>
<a href="#l3.1145"></a><span id="l3.1145" class="difflineminus">-      continue;</span>
<a href="#l3.1146"></a><span id="l3.1146" class="difflineplus">+    if (hidden) continue;</span>
<a href="#l3.1147"></a><span id="l3.1147"> </span>
<a href="#l3.1148"></a><span id="l3.1148">     nsCString type;</span>
<a href="#l3.1149"></a><span id="l3.1149">     if (NS_FAILED(server-&gt;GetType(type))) {</span>
<a href="#l3.1150"></a><span id="l3.1150">       NS_WARNING(&quot;server-&gt;GetType() failed&quot;);</span>
<a href="#l3.1151"></a><span id="l3.1151">       continue;</span>
<a href="#l3.1152"></a><span id="l3.1152">     }</span>
<a href="#l3.1153"></a><span id="l3.1153"> </span>
<a href="#l3.1154"></a><span id="l3.1154">     if (!type.EqualsLiteral(&quot;im&quot;)) {</span>
<a href="#l3.1155"></a><span id="l3.1155">       servers-&gt;AppendElement(server);</span>
<a href="#l3.1156"></a><span id="l3.1156">     }</span>
<a href="#l3.1157"></a><span id="l3.1157">   }</span>
<a href="#l3.1158"></a><span id="l3.1158"> </span>
<a href="#l3.1159"></a><span id="l3.1159">   servers.forget(_retval);</span>
<a href="#l3.1160"></a><span id="l3.1160">   return rv;</span>
<a href="#l3.1161"></a><span id="l3.1161"> }</span>
<a href="#l3.1162"></a><span id="l3.1162"> </span>
<a href="#l3.1163"></a><span id="l3.1163" class="difflineminus">-nsresult</span>
<a href="#l3.1164"></a><span id="l3.1164" class="difflineminus">-nsMsgAccountManager::LoadAccounts()</span>
<a href="#l3.1165"></a><span id="l3.1165" class="difflineminus">-{</span>
<a href="#l3.1166"></a><span id="l3.1166" class="difflineplus">+nsresult nsMsgAccountManager::LoadAccounts() {</span>
<a href="#l3.1167"></a><span id="l3.1167">   nsresult rv;</span>
<a href="#l3.1168"></a><span id="l3.1168"> </span>
<a href="#l3.1169"></a><span id="l3.1169">   // for now safeguard multiple calls to this function</span>
<a href="#l3.1170"></a><span id="l3.1170" class="difflineminus">-  if (m_accountsLoaded)</span>
<a href="#l3.1171"></a><span id="l3.1171" class="difflineminus">-    return NS_OK;</span>
<a href="#l3.1172"></a><span id="l3.1172" class="difflineminus">-</span>
<a href="#l3.1173"></a><span id="l3.1173" class="difflineminus">-  nsCOMPtr&lt;nsIMsgMailSession&gt; mailSession = do_GetService(NS_MSGMAILSESSION_CONTRACTID, &amp;rv);</span>
<a href="#l3.1174"></a><span id="l3.1174" class="difflineplus">+  if (m_accountsLoaded) return NS_OK;</span>
<a href="#l3.1175"></a><span id="l3.1175" class="difflineplus">+</span>
<a href="#l3.1176"></a><span id="l3.1176" class="difflineplus">+  nsCOMPtr&lt;nsIMsgMailSession&gt; mailSession =</span>
<a href="#l3.1177"></a><span id="l3.1177" class="difflineplus">+      do_GetService(NS_MSGMAILSESSION_CONTRACTID, &amp;rv);</span>
<a href="#l3.1178"></a><span id="l3.1178"> </span>
<a href="#l3.1179"></a><span id="l3.1179">   if (NS_SUCCEEDED(rv))</span>
<a href="#l3.1180"></a><span id="l3.1180" class="difflineminus">-    mailSession-&gt;AddFolderListener(this, nsIFolderListener::added |</span>
<a href="#l3.1181"></a><span id="l3.1181" class="difflineminus">-                                         nsIFolderListener::removed |</span>
<a href="#l3.1182"></a><span id="l3.1182" class="difflineminus">-                                         nsIFolderListener::intPropertyChanged);</span>
<a href="#l3.1183"></a><span id="l3.1183" class="difflineplus">+    mailSession-&gt;AddFolderListener(</span>
<a href="#l3.1184"></a><span id="l3.1184" class="difflineplus">+        this, nsIFolderListener::added | nsIFolderListener::removed |</span>
<a href="#l3.1185"></a><span id="l3.1185" class="difflineplus">+                  nsIFolderListener::intPropertyChanged);</span>
<a href="#l3.1186"></a><span id="l3.1186">   // If we have code trying to do things after we've unloaded accounts,</span>
<a href="#l3.1187"></a><span id="l3.1187">   // ignore it.</span>
<a href="#l3.1188"></a><span id="l3.1188" class="difflineminus">-  if (m_shutdownInProgress || m_haveShutdown)</span>
<a href="#l3.1189"></a><span id="l3.1189" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l3.1190"></a><span id="l3.1190" class="difflineminus">-</span>
<a href="#l3.1191"></a><span id="l3.1191" class="difflineminus">-  //Ensure biff service has started</span>
<a href="#l3.1192"></a><span id="l3.1192" class="difflineplus">+  if (m_shutdownInProgress || m_haveShutdown) return NS_ERROR_FAILURE;</span>
<a href="#l3.1193"></a><span id="l3.1193" class="difflineplus">+</span>
<a href="#l3.1194"></a><span id="l3.1194" class="difflineplus">+  // Ensure biff service has started</span>
<a href="#l3.1195"></a><span id="l3.1195">   nsCOMPtr&lt;nsIMsgBiffManager&gt; biffService =</span>
<a href="#l3.1196"></a><span id="l3.1196" class="difflineminus">-           do_GetService(NS_MSGBIFFMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l3.1197"></a><span id="l3.1197" class="difflineminus">-</span>
<a href="#l3.1198"></a><span id="l3.1198" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l3.1199"></a><span id="l3.1199" class="difflineminus">-    biffService-&gt;Init();</span>
<a href="#l3.1200"></a><span id="l3.1200" class="difflineminus">-</span>
<a href="#l3.1201"></a><span id="l3.1201" class="difflineminus">-  //Ensure purge service has started</span>
<a href="#l3.1202"></a><span id="l3.1202" class="difflineplus">+      do_GetService(NS_MSGBIFFMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l3.1203"></a><span id="l3.1203" class="difflineplus">+</span>
<a href="#l3.1204"></a><span id="l3.1204" class="difflineplus">+  if (NS_SUCCEEDED(rv)) biffService-&gt;Init();</span>
<a href="#l3.1205"></a><span id="l3.1205" class="difflineplus">+</span>
<a href="#l3.1206"></a><span id="l3.1206" class="difflineplus">+  // Ensure purge service has started</span>
<a href="#l3.1207"></a><span id="l3.1207">   nsCOMPtr&lt;nsIMsgPurgeService&gt; purgeService =</span>
<a href="#l3.1208"></a><span id="l3.1208" class="difflineminus">-           do_GetService(NS_MSGPURGESERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l3.1209"></a><span id="l3.1209" class="difflineminus">-</span>
<a href="#l3.1210"></a><span id="l3.1210" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l3.1211"></a><span id="l3.1211" class="difflineminus">-    purgeService-&gt;Init();</span>
<a href="#l3.1212"></a><span id="l3.1212" class="difflineminus">-</span>
<a href="#l3.1213"></a><span id="l3.1213" class="difflineminus">-  nsCOMPtr&lt;nsIPrefService&gt; prefservice(do_GetService(NS_PREFSERVICE_CONTRACTID,</span>
<a href="#l3.1214"></a><span id="l3.1214" class="difflineminus">-                                       &amp;rv));</span>
<a href="#l3.1215"></a><span id="l3.1215" class="difflineplus">+      do_GetService(NS_MSGPURGESERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l3.1216"></a><span id="l3.1216" class="difflineplus">+</span>
<a href="#l3.1217"></a><span id="l3.1217" class="difflineplus">+  if (NS_SUCCEEDED(rv)) purgeService-&gt;Init();</span>
<a href="#l3.1218"></a><span id="l3.1218" class="difflineplus">+</span>
<a href="#l3.1219"></a><span id="l3.1219" class="difflineplus">+  nsCOMPtr&lt;nsIPrefService&gt; prefservice(</span>
<a href="#l3.1220"></a><span id="l3.1220" class="difflineplus">+      do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l3.1221"></a><span id="l3.1221">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.1222"></a><span id="l3.1222"> </span>
<a href="#l3.1223"></a><span id="l3.1223">   // Ensure messenger OS integration service has started</span>
<a href="#l3.1224"></a><span id="l3.1224">   // note, you can't expect the integrationService to be there</span>
<a href="#l3.1225"></a><span id="l3.1225">   // we don't have OS integration on all platforms.</span>
<a href="#l3.1226"></a><span id="l3.1226">   nsCOMPtr&lt;nsIMessengerOSIntegration&gt; integrationService =</span>
<a href="#l3.1227"></a><span id="l3.1227" class="difflineminus">-           do_GetService(NS_MESSENGEROSINTEGRATION_CONTRACTID, &amp;rv);</span>
<a href="#l3.1228"></a><span id="l3.1228" class="difflineplus">+      do_GetService(NS_MESSENGEROSINTEGRATION_CONTRACTID, &amp;rv);</span>
<a href="#l3.1229"></a><span id="l3.1229"> </span>
<a href="#l3.1230"></a><span id="l3.1230">   // mail.accountmanager.accounts is the main entry point for all accounts</span>
<a href="#l3.1231"></a><span id="l3.1231">   nsCString accountList;</span>
<a href="#l3.1232"></a><span id="l3.1232">   rv = m_prefs-&gt;GetCharPref(PREF_MAIL_ACCOUNTMANAGER_ACCOUNTS, accountList);</span>
<a href="#l3.1233"></a><span id="l3.1233"> </span>
<a href="#l3.1234"></a><span id="l3.1234">   /**</span>
<a href="#l3.1235"></a><span id="l3.1235">    * Check to see if we need to add pre-configured accounts.</span>
<a href="#l3.1236"></a><span id="l3.1236">    * Following prefs are important to note in understanding the procedure here.</span>
<a href="#l3.1237"></a><span id="l3.1237">    *</span>
<a href="#l3.1238"></a><span id="l3.1238">    * 1. pref(&quot;mailnews.append_preconfig_accounts.version&quot;, version number);</span>
<a href="#l3.1239"></a><span id="l3.1239" class="difflineminus">-   * This pref registers the current version in the user prefs file. A default value</span>
<a href="#l3.1240"></a><span id="l3.1240" class="difflineminus">-   * is stored in mailnews.js file. If a given vendor needs to add more preconfigured</span>
<a href="#l3.1241"></a><span id="l3.1241" class="difflineminus">-   * accounts, the default version number can be increased. Comparing version</span>
<a href="#l3.1242"></a><span id="l3.1242" class="difflineminus">-   * number from user's prefs file and the default one from mailnews.js, we</span>
<a href="#l3.1243"></a><span id="l3.1243" class="difflineminus">-   * can add new accounts and any other version level changes that need to be done.</span>
<a href="#l3.1244"></a><span id="l3.1244" class="difflineplus">+   * This pref registers the current version in the user prefs file. A default</span>
<a href="#l3.1245"></a><span id="l3.1245" class="difflineplus">+   * value is stored in mailnews.js file. If a given vendor needs to add more</span>
<a href="#l3.1246"></a><span id="l3.1246" class="difflineplus">+   * preconfigured accounts, the default version number can be increased.</span>
<a href="#l3.1247"></a><span id="l3.1247" class="difflineplus">+   * Comparing version number from user's prefs file and the default one from</span>
<a href="#l3.1248"></a><span id="l3.1248" class="difflineplus">+   * mailnews.js, we can add new accounts and any other version level changes</span>
<a href="#l3.1249"></a><span id="l3.1249" class="difflineplus">+   * that need to be done.</span>
<a href="#l3.1250"></a><span id="l3.1250">    *</span>
<a href="#l3.1251"></a><span id="l3.1251" class="difflineminus">-   * 2. pref(&quot;mail.accountmanager.appendaccounts&quot;, &lt;comma separated account list&gt;);</span>
<a href="#l3.1252"></a><span id="l3.1252" class="difflineminus">-   * This pref contains the list of pre-configured accounts that ISP/Vendor wants to</span>
<a href="#l3.1253"></a><span id="l3.1253" class="difflineminus">-   * to add to the existing accounts list.</span>
<a href="#l3.1254"></a><span id="l3.1254" class="difflineplus">+   * 2. pref(&quot;mail.accountmanager.appendaccounts&quot;, &lt;comma sep. account list&gt;);</span>
<a href="#l3.1255"></a><span id="l3.1255" class="difflineplus">+   * This pref contains the list of pre-configured accounts that ISP/Vendor</span>
<a href="#l3.1256"></a><span id="l3.1256" class="difflineplus">+   * wants to add to the existing accounts list.</span>
<a href="#l3.1257"></a><span id="l3.1257">    */</span>
<a href="#l3.1258"></a><span id="l3.1258">   nsCOMPtr&lt;nsIPrefBranch&gt; defaultsPrefBranch;</span>
<a href="#l3.1259"></a><span id="l3.1259" class="difflineminus">-  rv = prefservice-&gt;GetDefaultBranch(MAILNEWS_ROOT_PREF, getter_AddRefs(defaultsPrefBranch));</span>
<a href="#l3.1260"></a><span id="l3.1260" class="difflineplus">+  rv = prefservice-&gt;GetDefaultBranch(MAILNEWS_ROOT_PREF,</span>
<a href="#l3.1261"></a><span id="l3.1261" class="difflineplus">+                                     getter_AddRefs(defaultsPrefBranch));</span>
<a href="#l3.1262"></a><span id="l3.1262">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.1263"></a><span id="l3.1263"> </span>
<a href="#l3.1264"></a><span id="l3.1264">   nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch;</span>
<a href="#l3.1265"></a><span id="l3.1265">   rv = prefservice-&gt;GetBranch(MAILNEWS_ROOT_PREF, getter_AddRefs(prefBranch));</span>
<a href="#l3.1266"></a><span id="l3.1266">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.1267"></a><span id="l3.1267"> </span>
<a href="#l3.1268"></a><span id="l3.1268" class="difflineminus">-  int32_t appendAccountsCurrentVersion=0;</span>
<a href="#l3.1269"></a><span id="l3.1269" class="difflineminus">-  int32_t appendAccountsDefaultVersion=0;</span>
<a href="#l3.1270"></a><span id="l3.1270" class="difflineminus">-  rv = prefBranch-&gt;GetIntPref(APPEND_ACCOUNTS_VERSION_PREF_NAME, &amp;appendAccountsCurrentVersion);</span>
<a href="#l3.1271"></a><span id="l3.1271" class="difflineplus">+  int32_t appendAccountsCurrentVersion = 0;</span>
<a href="#l3.1272"></a><span id="l3.1272" class="difflineplus">+  int32_t appendAccountsDefaultVersion = 0;</span>
<a href="#l3.1273"></a><span id="l3.1273" class="difflineplus">+  rv = prefBranch-&gt;GetIntPref(APPEND_ACCOUNTS_VERSION_PREF_NAME,</span>
<a href="#l3.1274"></a><span id="l3.1274" class="difflineplus">+                              &amp;appendAccountsCurrentVersion);</span>
<a href="#l3.1275"></a><span id="l3.1275">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.1276"></a><span id="l3.1276"> </span>
<a href="#l3.1277"></a><span id="l3.1277" class="difflineminus">-  rv = defaultsPrefBranch-&gt;GetIntPref(APPEND_ACCOUNTS_VERSION_PREF_NAME, &amp;appendAccountsDefaultVersion);</span>
<a href="#l3.1278"></a><span id="l3.1278" class="difflineplus">+  rv = defaultsPrefBranch-&gt;GetIntPref(APPEND_ACCOUNTS_VERSION_PREF_NAME,</span>
<a href="#l3.1279"></a><span id="l3.1279" class="difflineplus">+                                      &amp;appendAccountsDefaultVersion);</span>
<a href="#l3.1280"></a><span id="l3.1280">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.1281"></a><span id="l3.1281"> </span>
<a href="#l3.1282"></a><span id="l3.1282">   // Update the account list if needed</span>
<a href="#l3.1283"></a><span id="l3.1283">   if ((appendAccountsCurrentVersion &lt;= appendAccountsDefaultVersion)) {</span>
<a href="#l3.1284"></a><span id="l3.1284" class="difflineminus">-</span>
<a href="#l3.1285"></a><span id="l3.1285">     // Get a list of pre-configured accounts</span>
<a href="#l3.1286"></a><span id="l3.1286">     nsCString appendAccountList;</span>
<a href="#l3.1287"></a><span id="l3.1287">     rv = m_prefs-&gt;GetCharPref(PREF_MAIL_ACCOUNTMANAGER_APPEND_ACCOUNTS,</span>
<a href="#l3.1288"></a><span id="l3.1288">                               appendAccountList);</span>
<a href="#l3.1289"></a><span id="l3.1289">     appendAccountList.StripWhitespace();</span>
<a href="#l3.1290"></a><span id="l3.1290"> </span>
<a href="#l3.1291"></a><span id="l3.1291">     // If there are pre-configured accounts, we need to add them to the</span>
<a href="#l3.1292"></a><span id="l3.1292">     // existing list.</span>
<a href="#l3.1293"></a><span id="l3.1293" class="difflineminus">-    if (!appendAccountList.IsEmpty())</span>
<a href="#l3.1294"></a><span id="l3.1294" class="difflineminus">-    {</span>
<a href="#l3.1295"></a><span id="l3.1295" class="difflineminus">-      if (!accountList.IsEmpty())</span>
<a href="#l3.1296"></a><span id="l3.1296" class="difflineminus">-      {</span>
<a href="#l3.1297"></a><span id="l3.1297" class="difflineplus">+    if (!appendAccountList.IsEmpty()) {</span>
<a href="#l3.1298"></a><span id="l3.1298" class="difflineplus">+      if (!accountList.IsEmpty()) {</span>
<a href="#l3.1299"></a><span id="l3.1299">         // Tokenize the data and add each account</span>
<a href="#l3.1300"></a><span id="l3.1300">         // in the user's current mailnews account list</span>
<a href="#l3.1301"></a><span id="l3.1301">         nsTArray&lt;nsCString&gt; accountsArray;</span>
<a href="#l3.1302"></a><span id="l3.1302">         ParseString(accountList, ACCOUNT_DELIMITER, accountsArray);</span>
<a href="#l3.1303"></a><span id="l3.1303">         uint32_t i = accountsArray.Length();</span>
<a href="#l3.1304"></a><span id="l3.1304"> </span>
<a href="#l3.1305"></a><span id="l3.1305">         // Append each account in the pre-configured account list</span>
<a href="#l3.1306"></a><span id="l3.1306">         ParseString(appendAccountList, ACCOUNT_DELIMITER, accountsArray);</span>
<a href="#l3.1307"></a><span id="l3.1307"> </span>
<a href="#l3.1308"></a><span id="l3.1308">         // Now add each account that does not already appear in the list</span>
<a href="#l3.1309"></a><span id="l3.1309" class="difflineminus">-        for (; i &lt; accountsArray.Length(); i++)</span>
<a href="#l3.1310"></a><span id="l3.1310" class="difflineminus">-        {</span>
<a href="#l3.1311"></a><span id="l3.1311" class="difflineminus">-          if (accountsArray.IndexOf(accountsArray[i]) == i)</span>
<a href="#l3.1312"></a><span id="l3.1312" class="difflineminus">-          {</span>
<a href="#l3.1313"></a><span id="l3.1313" class="difflineplus">+        for (; i &lt; accountsArray.Length(); i++) {</span>
<a href="#l3.1314"></a><span id="l3.1314" class="difflineplus">+          if (accountsArray.IndexOf(accountsArray[i]) == i) {</span>
<a href="#l3.1315"></a><span id="l3.1315">             accountList.Append(ACCOUNT_DELIMITER);</span>
<a href="#l3.1316"></a><span id="l3.1316">             accountList.Append(accountsArray[i]);</span>
<a href="#l3.1317"></a><span id="l3.1317">           }</span>
<a href="#l3.1318"></a><span id="l3.1318">         }</span>
<a href="#l3.1319"></a><span id="l3.1319" class="difflineminus">-      }</span>
<a href="#l3.1320"></a><span id="l3.1320" class="difflineminus">-      else</span>
<a href="#l3.1321"></a><span id="l3.1321" class="difflineminus">-      {</span>
<a href="#l3.1322"></a><span id="l3.1322" class="difflineplus">+      } else {</span>
<a href="#l3.1323"></a><span id="l3.1323">         accountList = appendAccountList;</span>
<a href="#l3.1324"></a><span id="l3.1324">       }</span>
<a href="#l3.1325"></a><span id="l3.1325" class="difflineminus">-      // Increase the version number so that updates will happen as and when needed</span>
<a href="#l3.1326"></a><span id="l3.1326" class="difflineminus">-      rv = prefBranch-&gt;SetIntPref(APPEND_ACCOUNTS_VERSION_PREF_NAME, appendAccountsCurrentVersion + 1);</span>
<a href="#l3.1327"></a><span id="l3.1327" class="difflineplus">+      // Increase the version number so that updates will happen as and when</span>
<a href="#l3.1328"></a><span id="l3.1328" class="difflineplus">+      // needed</span>
<a href="#l3.1329"></a><span id="l3.1329" class="difflineplus">+      rv = prefBranch-&gt;SetIntPref(APPEND_ACCOUNTS_VERSION_PREF_NAME,</span>
<a href="#l3.1330"></a><span id="l3.1330" class="difflineplus">+                                  appendAccountsCurrentVersion + 1);</span>
<a href="#l3.1331"></a><span id="l3.1331">     }</span>
<a href="#l3.1332"></a><span id="l3.1332">   }</span>
<a href="#l3.1333"></a><span id="l3.1333"> </span>
<a href="#l3.1334"></a><span id="l3.1334">   // It is ok to return null accounts like when we create new profile.</span>
<a href="#l3.1335"></a><span id="l3.1335">   m_accountsLoaded = true;</span>
<a href="#l3.1336"></a><span id="l3.1336">   m_haveShutdown = false;</span>
<a href="#l3.1337"></a><span id="l3.1337"> </span>
<a href="#l3.1338"></a><span id="l3.1338" class="difflineminus">-  if (accountList.IsEmpty())</span>
<a href="#l3.1339"></a><span id="l3.1339" class="difflineminus">-      return NS_OK;</span>
<a href="#l3.1340"></a><span id="l3.1340" class="difflineplus">+  if (accountList.IsEmpty()) return NS_OK;</span>
<a href="#l3.1341"></a><span id="l3.1341"> </span>
<a href="#l3.1342"></a><span id="l3.1342">   /* parse accountList and run loadAccount on each string, comma-separated */</span>
<a href="#l3.1343"></a><span id="l3.1343">   nsCOMPtr&lt;nsIMsgAccount&gt; account;</span>
<a href="#l3.1344"></a><span id="l3.1344">   // Tokenize the data and add each account</span>
<a href="#l3.1345"></a><span id="l3.1345">   // in the user's current mailnews account list</span>
<a href="#l3.1346"></a><span id="l3.1346">   nsTArray&lt;nsCString&gt; accountsArray;</span>
<a href="#l3.1347"></a><span id="l3.1347">   ParseString(accountList, ACCOUNT_DELIMITER, accountsArray);</span>
<a href="#l3.1348"></a><span id="l3.1348"> </span>
<a href="#l3.1349"></a><span id="l3.1349">   // These are the duplicate accounts we found. We keep track of these</span>
<a href="#l3.1350"></a><span id="l3.1350">   // because if any other server defers to one of these accounts, we need</span>
<a href="#l3.1351"></a><span id="l3.1351">   // to defer to the correct account.</span>
<a href="#l3.1352"></a><span id="l3.1352">   nsCOMArray&lt;nsIMsgAccount&gt; dupAccounts;</span>
<a href="#l3.1353"></a><span id="l3.1353"> </span>
<a href="#l3.1354"></a><span id="l3.1354">   // Now add each account that does not already appear in the list</span>
<a href="#l3.1355"></a><span id="l3.1355" class="difflineminus">-  for (uint32_t i = 0; i &lt; accountsArray.Length(); i++)</span>
<a href="#l3.1356"></a><span id="l3.1356" class="difflineminus">-  {</span>
<a href="#l3.1357"></a><span id="l3.1357" class="difflineplus">+  for (uint32_t i = 0; i &lt; accountsArray.Length(); i++) {</span>
<a href="#l3.1358"></a><span id="l3.1358">     // if we've already seen this exact account, advance to the next account.</span>
<a href="#l3.1359"></a><span id="l3.1359">     // After the loop, we'll notice that we don't have as many actual accounts</span>
<a href="#l3.1360"></a><span id="l3.1360">     // as there were accounts in the pref, and rewrite the pref.</span>
<a href="#l3.1361"></a><span id="l3.1361" class="difflineminus">-    if (accountsArray.IndexOf(accountsArray[i]) != i)</span>
<a href="#l3.1362"></a><span id="l3.1362" class="difflineminus">-      continue;</span>
<a href="#l3.1363"></a><span id="l3.1363" class="difflineplus">+    if (accountsArray.IndexOf(accountsArray[i]) != i) continue;</span>
<a href="#l3.1364"></a><span id="l3.1364"> </span>
<a href="#l3.1365"></a><span id="l3.1365">     // get the &quot;server&quot; pref to see if we already have an account with this</span>
<a href="#l3.1366"></a><span id="l3.1366">     // server. If we do, we ignore this account.</span>
<a href="#l3.1367"></a><span id="l3.1367">     nsAutoCString serverKeyPref(&quot;mail.account.&quot;);</span>
<a href="#l3.1368"></a><span id="l3.1368">     serverKeyPref += accountsArray[i];</span>
<a href="#l3.1369"></a><span id="l3.1369"> </span>
<a href="#l3.1370"></a><span id="l3.1370">     nsCOMPtr&lt;nsIPrefBranch&gt; accountPrefBranch;</span>
<a href="#l3.1371"></a><span id="l3.1371">     rv = prefservice-&gt;GetBranch(serverKeyPref.get(),</span>
<a href="#l3.1372"></a><span id="l3.1372">                                 getter_AddRefs(accountPrefBranch));</span>
<a href="#l3.1373"></a><span id="l3.1373" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l3.1374"></a><span id="l3.1374" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.1375"></a><span id="l3.1375"> </span>
<a href="#l3.1376"></a><span id="l3.1376">     serverKeyPref += &quot;.server&quot;;</span>
<a href="#l3.1377"></a><span id="l3.1377">     nsCString serverKey;</span>
<a href="#l3.1378"></a><span id="l3.1378">     rv = m_prefs-&gt;GetCharPref(serverKeyPref.get(), serverKey);</span>
<a href="#l3.1379"></a><span id="l3.1379" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l3.1380"></a><span id="l3.1380" class="difflineminus">-      continue;</span>
<a href="#l3.1381"></a><span id="l3.1381" class="difflineplus">+    if (NS_FAILED(rv)) continue;</span>
<a href="#l3.1382"></a><span id="l3.1382"> </span>
<a href="#l3.1383"></a><span id="l3.1383">     nsCOMPtr&lt;nsIMsgAccount&gt; serverAccount;</span>
<a href="#l3.1384"></a><span id="l3.1384">     findAccountByServerKey(serverKey, getter_AddRefs(serverAccount));</span>
<a href="#l3.1385"></a><span id="l3.1385">     // If we have an existing account with the same server, ignore this account</span>
<a href="#l3.1386"></a><span id="l3.1386" class="difflineminus">-    if (serverAccount)</span>
<a href="#l3.1387"></a><span id="l3.1387" class="difflineminus">-      continue;</span>
<a href="#l3.1388"></a><span id="l3.1388" class="difflineminus">-</span>
<a href="#l3.1389"></a><span id="l3.1389" class="difflineminus">-    if (NS_FAILED(createKeyedAccount(accountsArray[i],</span>
<a href="#l3.1390"></a><span id="l3.1390" class="difflineminus">-                                     getter_AddRefs(account))) || !account)</span>
<a href="#l3.1391"></a><span id="l3.1391" class="difflineminus">-    {</span>
<a href="#l3.1392"></a><span id="l3.1392" class="difflineplus">+    if (serverAccount) continue;</span>
<a href="#l3.1393"></a><span id="l3.1393" class="difflineplus">+</span>
<a href="#l3.1394"></a><span id="l3.1394" class="difflineplus">+    if (NS_FAILED(</span>
<a href="#l3.1395"></a><span id="l3.1395" class="difflineplus">+            createKeyedAccount(accountsArray[i], getter_AddRefs(account))) ||</span>
<a href="#l3.1396"></a><span id="l3.1396" class="difflineplus">+        !account) {</span>
<a href="#l3.1397"></a><span id="l3.1397">       NS_WARNING(&quot;unexpected entry in account list; prefs corrupt?&quot;);</span>
<a href="#l3.1398"></a><span id="l3.1398">       continue;</span>
<a href="#l3.1399"></a><span id="l3.1399">     }</span>
<a href="#l3.1400"></a><span id="l3.1400"> </span>
<a href="#l3.1401"></a><span id="l3.1401">     // See nsIMsgAccount.idl for a description of the secondsToLeaveUnavailable</span>
<a href="#l3.1402"></a><span id="l3.1402">     //  and timeFoundUnavailable preferences</span>
<a href="#l3.1403"></a><span id="l3.1403">     nsAutoCString toLeavePref(PREF_MAIL_SERVER_PREFIX);</span>
<a href="#l3.1404"></a><span id="l3.1404">     toLeavePref.Append(serverKey);</span>
<a href="#l3.1405"></a><span id="l3.1405" class="difflineminus">-    nsAutoCString unavailablePref(toLeavePref); // this is the server-specific prefix</span>
<a href="#l3.1406"></a><span id="l3.1406" class="difflineplus">+    nsAutoCString unavailablePref(</span>
<a href="#l3.1407"></a><span id="l3.1407" class="difflineplus">+        toLeavePref);  // this is the server-specific prefix</span>
<a href="#l3.1408"></a><span id="l3.1408">     unavailablePref.AppendLiteral(&quot;.timeFoundUnavailable&quot;);</span>
<a href="#l3.1409"></a><span id="l3.1409">     toLeavePref.AppendLiteral(&quot;.secondsToLeaveUnavailable&quot;);</span>
<a href="#l3.1410"></a><span id="l3.1410">     int32_t secondsToLeave = 0;</span>
<a href="#l3.1411"></a><span id="l3.1411">     int32_t timeUnavailable = 0;</span>
<a href="#l3.1412"></a><span id="l3.1412"> </span>
<a href="#l3.1413"></a><span id="l3.1413">     m_prefs-&gt;GetIntPref(toLeavePref.get(), &amp;secondsToLeave);</span>
<a href="#l3.1414"></a><span id="l3.1414"> </span>
<a href="#l3.1415"></a><span id="l3.1415">     // force load of accounts (need to find a better way to do this)</span>
<a href="#l3.1416"></a><span id="l3.1416">     nsCOMPtr&lt;nsIArray&gt; identities;</span>
<a href="#l3.1417"></a><span id="l3.1417">     account-&gt;GetIdentities(getter_AddRefs(identities));</span>
<a href="#l3.1418"></a><span id="l3.1418"> </span>
<a href="#l3.1419"></a><span id="l3.1419">     rv = account-&gt;CreateServer();</span>
<a href="#l3.1420"></a><span id="l3.1420">     bool deleteAccount = NS_FAILED(rv);</span>
<a href="#l3.1421"></a><span id="l3.1421"> </span>
<a href="#l3.1422"></a><span id="l3.1422" class="difflineminus">-    if (secondsToLeave)</span>
<a href="#l3.1423"></a><span id="l3.1423" class="difflineminus">-    { // we need to process timeUnavailable</span>
<a href="#l3.1424"></a><span id="l3.1424" class="difflineminus">-      if (NS_SUCCEEDED(rv)) // clear the time if server is available</span>
<a href="#l3.1425"></a><span id="l3.1425" class="difflineplus">+    if (secondsToLeave) {    // we need to process timeUnavailable</span>
<a href="#l3.1426"></a><span id="l3.1426" class="difflineplus">+      if (NS_SUCCEEDED(rv))  // clear the time if server is available</span>
<a href="#l3.1427"></a><span id="l3.1427">       {</span>
<a href="#l3.1428"></a><span id="l3.1428">         m_prefs-&gt;ClearUserPref(unavailablePref.get());</span>
<a href="#l3.1429"></a><span id="l3.1429">       }</span>
<a href="#l3.1430"></a><span id="l3.1430">       // NS_ERROR_NOT_AVAILABLE signifies a server that could not be</span>
<a href="#l3.1431"></a><span id="l3.1431">       // instantiated, presumably because of an invalid type.</span>
<a href="#l3.1432"></a><span id="l3.1432" class="difflineminus">-      else if (rv == NS_ERROR_NOT_AVAILABLE)</span>
<a href="#l3.1433"></a><span id="l3.1433" class="difflineminus">-      {</span>
<a href="#l3.1434"></a><span id="l3.1434" class="difflineplus">+      else if (rv == NS_ERROR_NOT_AVAILABLE) {</span>
<a href="#l3.1435"></a><span id="l3.1435">         m_prefs-&gt;GetIntPref(unavailablePref.get(), &amp;timeUnavailable);</span>
<a href="#l3.1436"></a><span id="l3.1436" class="difflineminus">-        if (!timeUnavailable)</span>
<a href="#l3.1437"></a><span id="l3.1437" class="difflineminus">-        { // we need to set it, this must be the first time unavailable</span>
<a href="#l3.1438"></a><span id="l3.1438" class="difflineplus">+        if (!timeUnavailable) {  // we need to set it, this must be the first</span>
<a href="#l3.1439"></a><span id="l3.1439" class="difflineplus">+                                 // time unavailable</span>
<a href="#l3.1440"></a><span id="l3.1440">           uint32_t nowSeconds;</span>
<a href="#l3.1441"></a><span id="l3.1441">           PRTime2Seconds(PR_Now(), &amp;nowSeconds);</span>
<a href="#l3.1442"></a><span id="l3.1442">           m_prefs-&gt;SetIntPref(unavailablePref.get(), nowSeconds);</span>
<a href="#l3.1443"></a><span id="l3.1443">           deleteAccount = false;</span>
<a href="#l3.1444"></a><span id="l3.1444">         }</span>
<a href="#l3.1445"></a><span id="l3.1445">       }</span>
<a href="#l3.1446"></a><span id="l3.1446">     }</span>
<a href="#l3.1447"></a><span id="l3.1447"> </span>
<a href="#l3.1448"></a><span id="l3.1448" class="difflineminus">-    if (rv == NS_ERROR_NOT_AVAILABLE &amp;&amp; timeUnavailable != 0)</span>
<a href="#l3.1449"></a><span id="l3.1449" class="difflineminus">-    { // Our server is still unavailable. Have we timed out yet?</span>
<a href="#l3.1450"></a><span id="l3.1450" class="difflineplus">+    // Our server is still unavailable. Have we timed out yet?</span>
<a href="#l3.1451"></a><span id="l3.1451" class="difflineplus">+    if (rv == NS_ERROR_NOT_AVAILABLE &amp;&amp; timeUnavailable != 0) {</span>
<a href="#l3.1452"></a><span id="l3.1452">       uint32_t nowSeconds;</span>
<a href="#l3.1453"></a><span id="l3.1453">       PRTime2Seconds(PR_Now(), &amp;nowSeconds);</span>
<a href="#l3.1454"></a><span id="l3.1454">       if ((int32_t)nowSeconds &lt; timeUnavailable + secondsToLeave)</span>
<a href="#l3.1455"></a><span id="l3.1455">         deleteAccount = false;</span>
<a href="#l3.1456"></a><span id="l3.1456">     }</span>
<a href="#l3.1457"></a><span id="l3.1457"> </span>
<a href="#l3.1458"></a><span id="l3.1458" class="difflineminus">-    if (deleteAccount)</span>
<a href="#l3.1459"></a><span id="l3.1459" class="difflineminus">-    {</span>
<a href="#l3.1460"></a><span id="l3.1460" class="difflineplus">+    if (deleteAccount) {</span>
<a href="#l3.1461"></a><span id="l3.1461">       dupAccounts.AppendObject(account);</span>
<a href="#l3.1462"></a><span id="l3.1462">       m_accounts.RemoveElement(account);</span>
<a href="#l3.1463"></a><span id="l3.1463">     }</span>
<a href="#l3.1464"></a><span id="l3.1464">   }</span>
<a href="#l3.1465"></a><span id="l3.1465"> </span>
<a href="#l3.1466"></a><span id="l3.1466">   // Check if we removed one or more of the accounts in the pref string.</span>
<a href="#l3.1467"></a><span id="l3.1467">   // If so, rewrite the pref string.</span>
<a href="#l3.1468"></a><span id="l3.1468" class="difflineminus">-  if (accountsArray.Length() != m_accounts.Length())</span>
<a href="#l3.1469"></a><span id="l3.1469" class="difflineminus">-    OutputAccountsPref();</span>
<a href="#l3.1470"></a><span id="l3.1470" class="difflineplus">+  if (accountsArray.Length() != m_accounts.Length()) OutputAccountsPref();</span>
<a href="#l3.1471"></a><span id="l3.1471"> </span>
<a href="#l3.1472"></a><span id="l3.1472">   int32_t cnt = dupAccounts.Count();</span>
<a href="#l3.1473"></a><span id="l3.1473">   nsCOMPtr&lt;nsIMsgAccount&gt; dupAccount;</span>
<a href="#l3.1474"></a><span id="l3.1474"> </span>
<a href="#l3.1475"></a><span id="l3.1475">   // Go through the accounts seeing if any existing server is deferred to</span>
<a href="#l3.1476"></a><span id="l3.1476">   // an account we removed. If so, fix the deferral. Then clean up the prefs</span>
<a href="#l3.1477"></a><span id="l3.1477">   // for the removed account.</span>
<a href="#l3.1478"></a><span id="l3.1478" class="difflineminus">-  for (int32_t i = 0; i &lt; cnt; i++)</span>
<a href="#l3.1479"></a><span id="l3.1479" class="difflineminus">-  {</span>
<a href="#l3.1480"></a><span id="l3.1480" class="difflineplus">+  for (int32_t i = 0; i &lt; cnt; i++) {</span>
<a href="#l3.1481"></a><span id="l3.1481">     dupAccount = dupAccounts[i];</span>
<a href="#l3.1482"></a><span id="l3.1482">     for (auto iter = m_incomingServers.Iter(); !iter.Done(); iter.Next()) {</span>
<a href="#l3.1483"></a><span id="l3.1483">       /*</span>
<a href="#l3.1484"></a><span id="l3.1484">        * This loop gets run for every incoming server, and is passed a</span>
<a href="#l3.1485"></a><span id="l3.1485">        * duplicate account. It checks that the server is not deferred to the</span>
<a href="#l3.1486"></a><span id="l3.1486">        * duplicate account. If it is, then it looks up the information for the</span>
<a href="#l3.1487"></a><span id="l3.1487">        * duplicate account's server (username, hostName, type), and finds an</span>
<a href="#l3.1488"></a><span id="l3.1488">        * account with a server with the same username, hostname, and type, and</span>
<a href="#l3.1489"></a><span id="l3.1489">        * if it finds one, defers to that account instead. Generally, this will</span>
<a href="#l3.1490"></a><span id="l3.1490">        * be a Local Folders account, since 2.0 has a bug where duplicate Local</span>
<a href="#l3.1491"></a><span id="l3.1491">        * Folders accounts are created.</span>
<a href="#l3.1492"></a><span id="l3.1492">        */</span>
<a href="#l3.1493"></a><span id="l3.1493" class="difflineminus">-      nsCOMPtr&lt;nsIMsgIncomingServer&gt;&amp; server = iter.Data();</span>
<a href="#l3.1494"></a><span id="l3.1494" class="difflineplus">+      nsCOMPtr&lt;nsIMsgIncomingServer&gt; &amp;server = iter.Data();</span>
<a href="#l3.1495"></a><span id="l3.1495">       nsCString type;</span>
<a href="#l3.1496"></a><span id="l3.1496">       server-&gt;GetType(type);</span>
<a href="#l3.1497"></a><span id="l3.1497" class="difflineminus">-      if (type.EqualsLiteral(&quot;pop3&quot;))</span>
<a href="#l3.1498"></a><span id="l3.1498" class="difflineminus">-      {</span>
<a href="#l3.1499"></a><span id="l3.1499" class="difflineplus">+      if (type.EqualsLiteral(&quot;pop3&quot;)) {</span>
<a href="#l3.1500"></a><span id="l3.1500">         nsCString deferredToAccount;</span>
<a href="#l3.1501"></a><span id="l3.1501">         // Get the pref directly, because the GetDeferredToAccount accessor</span>
<a href="#l3.1502"></a><span id="l3.1502">         // attempts to fix broken deferrals, but we know more about what the</span>
<a href="#l3.1503"></a><span id="l3.1503">         // deferred to account was.</span>
<a href="#l3.1504"></a><span id="l3.1504">         server-&gt;GetCharValue(&quot;deferred_to_account&quot;, deferredToAccount);</span>
<a href="#l3.1505"></a><span id="l3.1505" class="difflineminus">-        if (!deferredToAccount.IsEmpty())</span>
<a href="#l3.1506"></a><span id="l3.1506" class="difflineminus">-        {</span>
<a href="#l3.1507"></a><span id="l3.1507" class="difflineplus">+        if (!deferredToAccount.IsEmpty()) {</span>
<a href="#l3.1508"></a><span id="l3.1508">           nsCString dupAccountKey;</span>
<a href="#l3.1509"></a><span id="l3.1509">           dupAccount-&gt;GetKey(dupAccountKey);</span>
<a href="#l3.1510"></a><span id="l3.1510" class="difflineminus">-          if (deferredToAccount.Equals(dupAccountKey))</span>
<a href="#l3.1511"></a><span id="l3.1511" class="difflineminus">-          {</span>
<a href="#l3.1512"></a><span id="l3.1512" class="difflineplus">+          if (deferredToAccount.Equals(dupAccountKey)) {</span>
<a href="#l3.1513"></a><span id="l3.1513">             nsresult rv;</span>
<a href="#l3.1514"></a><span id="l3.1514">             nsCString accountPref(&quot;mail.account.&quot;);</span>
<a href="#l3.1515"></a><span id="l3.1515">             nsCString dupAccountServerKey;</span>
<a href="#l3.1516"></a><span id="l3.1516">             accountPref.Append(dupAccountKey);</span>
<a href="#l3.1517"></a><span id="l3.1517">             accountPref.AppendLiteral(&quot;.server&quot;);</span>
<a href="#l3.1518"></a><span id="l3.1518">             nsCOMPtr&lt;nsIPrefService&gt; prefservice(</span>
<a href="#l3.1519"></a><span id="l3.1519" class="difflineminus">-              do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l3.1520"></a><span id="l3.1520" class="difflineplus">+                do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l3.1521"></a><span id="l3.1521">             if (NS_FAILED(rv)) {</span>
<a href="#l3.1522"></a><span id="l3.1522">               continue;</span>
<a href="#l3.1523"></a><span id="l3.1523">             }</span>
<a href="#l3.1524"></a><span id="l3.1524">             nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(</span>
<a href="#l3.1525"></a><span id="l3.1525" class="difflineminus">-              do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l3.1526"></a><span id="l3.1526" class="difflineplus">+                do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l3.1527"></a><span id="l3.1527">             if (NS_FAILED(rv)) {</span>
<a href="#l3.1528"></a><span id="l3.1528">               continue;</span>
<a href="#l3.1529"></a><span id="l3.1529">             }</span>
<a href="#l3.1530"></a><span id="l3.1530" class="difflineminus">-            rv = prefBranch-&gt;GetCharPref(accountPref.get(),</span>
<a href="#l3.1531"></a><span id="l3.1531" class="difflineminus">-                                         dupAccountServerKey);</span>
<a href="#l3.1532"></a><span id="l3.1532" class="difflineplus">+            rv =</span>
<a href="#l3.1533"></a><span id="l3.1533" class="difflineplus">+                prefBranch-&gt;GetCharPref(accountPref.get(), dupAccountServerKey);</span>
<a href="#l3.1534"></a><span id="l3.1534">             if (NS_FAILED(rv)) {</span>
<a href="#l3.1535"></a><span id="l3.1535">               continue;</span>
<a href="#l3.1536"></a><span id="l3.1536">             }</span>
<a href="#l3.1537"></a><span id="l3.1537">             nsCOMPtr&lt;nsIPrefBranch&gt; serverPrefBranch;</span>
<a href="#l3.1538"></a><span id="l3.1538">             nsCString serverKeyPref(PREF_MAIL_SERVER_PREFIX);</span>
<a href="#l3.1539"></a><span id="l3.1539">             serverKeyPref.Append(dupAccountServerKey);</span>
<a href="#l3.1540"></a><span id="l3.1540">             serverKeyPref.Append('.');</span>
<a href="#l3.1541"></a><span id="l3.1541">             rv = prefservice-&gt;GetBranch(serverKeyPref.get(),</span>
<a href="#l3.1542"></a><span id="l3.1542" class="difflineat">@@ -1328,86 +1227,78 @@ nsMsgAccountManager::LoadAccounts()</span>
<a href="#l3.1543"></a><span id="l3.1543">             nsCString userName;</span>
<a href="#l3.1544"></a><span id="l3.1544">             nsCString hostName;</span>
<a href="#l3.1545"></a><span id="l3.1545">             nsCString type;</span>
<a href="#l3.1546"></a><span id="l3.1546">             serverPrefBranch-&gt;GetCharPref(&quot;userName&quot;, userName);</span>
<a href="#l3.1547"></a><span id="l3.1547">             serverPrefBranch-&gt;GetCharPref(&quot;hostname&quot;, hostName);</span>
<a href="#l3.1548"></a><span id="l3.1548">             serverPrefBranch-&gt;GetCharPref(&quot;type&quot;, type);</span>
<a href="#l3.1549"></a><span id="l3.1549">             // Find a server with the same info.</span>
<a href="#l3.1550"></a><span id="l3.1550">             nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l3.1551"></a><span id="l3.1551" class="difflineminus">-                     do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l3.1552"></a><span id="l3.1552" class="difflineplus">+                do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l3.1553"></a><span id="l3.1553">             if (NS_FAILED(rv)) {</span>
<a href="#l3.1554"></a><span id="l3.1554">               continue;</span>
<a href="#l3.1555"></a><span id="l3.1555">             }</span>
<a href="#l3.1556"></a><span id="l3.1556">             nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l3.1557"></a><span id="l3.1557">             accountManager-&gt;FindServer(userName, hostName, type,</span>
<a href="#l3.1558"></a><span id="l3.1558">                                        getter_AddRefs(server));</span>
<a href="#l3.1559"></a><span id="l3.1559" class="difflineminus">-            if (server)</span>
<a href="#l3.1560"></a><span id="l3.1560" class="difflineminus">-            {</span>
<a href="#l3.1561"></a><span id="l3.1561" class="difflineplus">+            if (server) {</span>
<a href="#l3.1562"></a><span id="l3.1562">               nsCOMPtr&lt;nsIMsgAccount&gt; replacement;</span>
<a href="#l3.1563"></a><span id="l3.1563">               accountManager-&gt;FindAccountForServer(server,</span>
<a href="#l3.1564"></a><span id="l3.1564">                                                    getter_AddRefs(replacement));</span>
<a href="#l3.1565"></a><span id="l3.1565" class="difflineminus">-              if (replacement)</span>
<a href="#l3.1566"></a><span id="l3.1566" class="difflineminus">-              {</span>
<a href="#l3.1567"></a><span id="l3.1567" class="difflineplus">+              if (replacement) {</span>
<a href="#l3.1568"></a><span id="l3.1568">                 nsCString accountKey;</span>
<a href="#l3.1569"></a><span id="l3.1569">                 replacement-&gt;GetKey(accountKey);</span>
<a href="#l3.1570"></a><span id="l3.1570">                 if (!accountKey.IsEmpty())</span>
<a href="#l3.1571"></a><span id="l3.1571">                   server-&gt;SetCharValue(&quot;deferred_to_account&quot;, accountKey);</span>
<a href="#l3.1572"></a><span id="l3.1572">               }</span>
<a href="#l3.1573"></a><span id="l3.1573">             }</span>
<a href="#l3.1574"></a><span id="l3.1574">           }</span>
<a href="#l3.1575"></a><span id="l3.1575">         }</span>
<a href="#l3.1576"></a><span id="l3.1576">       }</span>
<a href="#l3.1577"></a><span id="l3.1577">     }</span>
<a href="#l3.1578"></a><span id="l3.1578"> </span>
<a href="#l3.1579"></a><span id="l3.1579">     nsAutoCString accountKeyPref(&quot;mail.account.&quot;);</span>
<a href="#l3.1580"></a><span id="l3.1580">     nsCString dupAccountKey;</span>
<a href="#l3.1581"></a><span id="l3.1581">     dupAccount-&gt;GetKey(dupAccountKey);</span>
<a href="#l3.1582"></a><span id="l3.1582" class="difflineminus">-    if (dupAccountKey.IsEmpty())</span>
<a href="#l3.1583"></a><span id="l3.1583" class="difflineminus">-      continue;</span>
<a href="#l3.1584"></a><span id="l3.1584" class="difflineplus">+    if (dupAccountKey.IsEmpty()) continue;</span>
<a href="#l3.1585"></a><span id="l3.1585">     accountKeyPref += dupAccountKey;</span>
<a href="#l3.1586"></a><span id="l3.1586"> </span>
<a href="#l3.1587"></a><span id="l3.1587">     nsCOMPtr&lt;nsIPrefBranch&gt; accountPrefBranch;</span>
<a href="#l3.1588"></a><span id="l3.1588">     rv = prefservice-&gt;GetBranch(accountKeyPref.get(),</span>
<a href="#l3.1589"></a><span id="l3.1589">                                 getter_AddRefs(accountPrefBranch));</span>
<a href="#l3.1590"></a><span id="l3.1590" class="difflineminus">-    if (accountPrefBranch)</span>
<a href="#l3.1591"></a><span id="l3.1591" class="difflineminus">-      accountPrefBranch-&gt;DeleteBranch(&quot;&quot;);</span>
<a href="#l3.1592"></a><span id="l3.1592" class="difflineplus">+    if (accountPrefBranch) accountPrefBranch-&gt;DeleteBranch(&quot;&quot;);</span>
<a href="#l3.1593"></a><span id="l3.1593">   }</span>
<a href="#l3.1594"></a><span id="l3.1594"> </span>
<a href="#l3.1595"></a><span id="l3.1595">   // Make sure we have an account that points at the local folders server</span>
<a href="#l3.1596"></a><span id="l3.1596">   nsCString localFoldersServerKey;</span>
<a href="#l3.1597"></a><span id="l3.1597">   rv = m_prefs-&gt;GetCharPref(PREF_MAIL_ACCOUNTMANAGER_LOCALFOLDERSSERVER,</span>
<a href="#l3.1598"></a><span id="l3.1598">                             localFoldersServerKey);</span>
<a href="#l3.1599"></a><span id="l3.1599"> </span>
<a href="#l3.1600"></a><span id="l3.1600" class="difflineminus">-  if (!localFoldersServerKey.IsEmpty())</span>
<a href="#l3.1601"></a><span id="l3.1601" class="difflineminus">-  {</span>
<a href="#l3.1602"></a><span id="l3.1602" class="difflineplus">+  if (!localFoldersServerKey.IsEmpty()) {</span>
<a href="#l3.1603"></a><span id="l3.1603">     nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l3.1604"></a><span id="l3.1604">     rv = GetIncomingServer(localFoldersServerKey, getter_AddRefs(server));</span>
<a href="#l3.1605"></a><span id="l3.1605" class="difflineminus">-    if (server)</span>
<a href="#l3.1606"></a><span id="l3.1606" class="difflineminus">-    {</span>
<a href="#l3.1607"></a><span id="l3.1607" class="difflineplus">+    if (server) {</span>
<a href="#l3.1608"></a><span id="l3.1608">       nsCOMPtr&lt;nsIMsgAccount&gt; localFoldersAccount;</span>
<a href="#l3.1609"></a><span id="l3.1609" class="difflineminus">-      findAccountByServerKey(localFoldersServerKey, getter_AddRefs(localFoldersAccount));</span>
<a href="#l3.1610"></a><span id="l3.1610" class="difflineplus">+      findAccountByServerKey(localFoldersServerKey,</span>
<a href="#l3.1611"></a><span id="l3.1611" class="difflineplus">+                             getter_AddRefs(localFoldersAccount));</span>
<a href="#l3.1612"></a><span id="l3.1612">       // If we don't have an existing account pointing at the local folders</span>
<a href="#l3.1613"></a><span id="l3.1613">       // server, we're going to add one.</span>
<a href="#l3.1614"></a><span id="l3.1614" class="difflineminus">-      if (!localFoldersAccount)</span>
<a href="#l3.1615"></a><span id="l3.1615" class="difflineminus">-      {</span>
<a href="#l3.1616"></a><span id="l3.1616" class="difflineplus">+      if (!localFoldersAccount) {</span>
<a href="#l3.1617"></a><span id="l3.1617">         nsCOMPtr&lt;nsIMsgAccount&gt; account;</span>
<a href="#l3.1618"></a><span id="l3.1618" class="difflineminus">-        (void) CreateAccount(getter_AddRefs(account));</span>
<a href="#l3.1619"></a><span id="l3.1619" class="difflineminus">-        if (account)</span>
<a href="#l3.1620"></a><span id="l3.1620" class="difflineminus">-          account-&gt;SetIncomingServer(server);</span>
<a href="#l3.1621"></a><span id="l3.1621" class="difflineplus">+        (void)CreateAccount(getter_AddRefs(account));</span>
<a href="#l3.1622"></a><span id="l3.1622" class="difflineplus">+        if (account) account-&gt;SetIncomingServer(server);</span>
<a href="#l3.1623"></a><span id="l3.1623">       }</span>
<a href="#l3.1624"></a><span id="l3.1624">     }</span>
<a href="#l3.1625"></a><span id="l3.1625">   }</span>
<a href="#l3.1626"></a><span id="l3.1626">   return NS_OK;</span>
<a href="#l3.1627"></a><span id="l3.1627"> }</span>
<a href="#l3.1628"></a><span id="l3.1628"> </span>
<a href="#l3.1629"></a><span id="l3.1629"> NS_IMETHODIMP</span>
<a href="#l3.1630"></a><span id="l3.1630" class="difflineminus">-nsMsgAccountManager::ReactivateAccounts()</span>
<a href="#l3.1631"></a><span id="l3.1631" class="difflineminus">-{</span>
<a href="#l3.1632"></a><span id="l3.1632" class="difflineminus">-  for (nsIMsgAccount* account : m_accounts) {</span>
<a href="#l3.1633"></a><span id="l3.1633" class="difflineplus">+nsMsgAccountManager::ReactivateAccounts() {</span>
<a href="#l3.1634"></a><span id="l3.1634" class="difflineplus">+  for (nsIMsgAccount *account : m_accounts) {</span>
<a href="#l3.1635"></a><span id="l3.1635">     // This will error out if the account already has its server, or</span>
<a href="#l3.1636"></a><span id="l3.1636">     // if this isn't the account that the extension is trying to reactivate.</span>
<a href="#l3.1637"></a><span id="l3.1637">     if (NS_SUCCEEDED(account-&gt;CreateServer())) {</span>
<a href="#l3.1638"></a><span id="l3.1638">       nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l3.1639"></a><span id="l3.1639">       account-&gt;GetIncomingServer(getter_AddRefs(server));</span>
<a href="#l3.1640"></a><span id="l3.1640">       // This triggers all of the notifications required by the UI.</span>
<a href="#l3.1641"></a><span id="l3.1641">       account-&gt;SetIncomingServer(server);</span>
<a href="#l3.1642"></a><span id="l3.1642">     }</span>
<a href="#l3.1643"></a><span id="l3.1643" class="difflineat">@@ -1418,306 +1309,271 @@ nsMsgAccountManager::ReactivateAccounts(</span>
<a href="#l3.1644"></a><span id="l3.1644"> // this routine goes through all the identities and makes sure</span>
<a href="#l3.1645"></a><span id="l3.1645"> // that the special folders for each identity have the</span>
<a href="#l3.1646"></a><span id="l3.1646"> // correct special folder flags set, e.g, the Sent folder has</span>
<a href="#l3.1647"></a><span id="l3.1647"> // the sent flag set.</span>
<a href="#l3.1648"></a><span id="l3.1648"> //</span>
<a href="#l3.1649"></a><span id="l3.1649"> // it also goes through all the spam settings for each account</span>
<a href="#l3.1650"></a><span id="l3.1650"> // and makes sure the folder flags are set there, too</span>
<a href="#l3.1651"></a><span id="l3.1651"> NS_IMETHODIMP</span>
<a href="#l3.1652"></a><span id="l3.1652" class="difflineminus">-nsMsgAccountManager::SetSpecialFolders()</span>
<a href="#l3.1653"></a><span id="l3.1653" class="difflineminus">-{</span>
<a href="#l3.1654"></a><span id="l3.1654" class="difflineplus">+nsMsgAccountManager::SetSpecialFolders() {</span>
<a href="#l3.1655"></a><span id="l3.1655">   nsCOMPtr&lt;nsIArray&gt; identities;</span>
<a href="#l3.1656"></a><span id="l3.1656">   GetAllIdentities(getter_AddRefs(identities));</span>
<a href="#l3.1657"></a><span id="l3.1657"> </span>
<a href="#l3.1658"></a><span id="l3.1658">   uint32_t idCount = 0;</span>
<a href="#l3.1659"></a><span id="l3.1659">   identities-&gt;GetLength(&amp;idCount);</span>
<a href="#l3.1660"></a><span id="l3.1660"> </span>
<a href="#l3.1661"></a><span id="l3.1661">   uint32_t id;</span>
<a href="#l3.1662"></a><span id="l3.1662">   nsCString identityKey;</span>
<a href="#l3.1663"></a><span id="l3.1663"> </span>
<a href="#l3.1664"></a><span id="l3.1664" class="difflineminus">-  for (id = 0; id &lt; idCount; id++)</span>
<a href="#l3.1665"></a><span id="l3.1665" class="difflineminus">-  {</span>
<a href="#l3.1666"></a><span id="l3.1666" class="difflineplus">+  for (id = 0; id &lt; idCount; id++) {</span>
<a href="#l3.1667"></a><span id="l3.1667">     nsresult rv;</span>
<a href="#l3.1668"></a><span id="l3.1668" class="difflineminus">-    nsCOMPtr&lt;nsIMsgIdentity&gt; thisIdentity(do_QueryElementAt(identities, id, &amp;rv));</span>
<a href="#l3.1669"></a><span id="l3.1669" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l3.1670"></a><span id="l3.1670" class="difflineminus">-      continue;</span>
<a href="#l3.1671"></a><span id="l3.1671" class="difflineminus">-</span>
<a href="#l3.1672"></a><span id="l3.1672" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; thisIdentity)</span>
<a href="#l3.1673"></a><span id="l3.1673" class="difflineminus">-    {</span>
<a href="#l3.1674"></a><span id="l3.1674" class="difflineplus">+    nsCOMPtr&lt;nsIMsgIdentity&gt; thisIdentity(</span>
<a href="#l3.1675"></a><span id="l3.1675" class="difflineplus">+        do_QueryElementAt(identities, id, &amp;rv));</span>
<a href="#l3.1676"></a><span id="l3.1676" class="difflineplus">+    if (NS_FAILED(rv)) continue;</span>
<a href="#l3.1677"></a><span id="l3.1677" class="difflineplus">+</span>
<a href="#l3.1678"></a><span id="l3.1678" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; thisIdentity) {</span>
<a href="#l3.1679"></a><span id="l3.1679">       nsCString folderUri;</span>
<a href="#l3.1680"></a><span id="l3.1680">       nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l3.1681"></a><span id="l3.1681"> </span>
<a href="#l3.1682"></a><span id="l3.1682">       thisIdentity-&gt;GetFccFolder(folderUri);</span>
<a href="#l3.1683"></a><span id="l3.1683">       if (!folderUri.IsEmpty() &amp;&amp;</span>
<a href="#l3.1684"></a><span id="l3.1684" class="difflineminus">-          NS_SUCCEEDED(GetOrCreateFolder(folderUri, getter_AddRefs(folder))))</span>
<a href="#l3.1685"></a><span id="l3.1685" class="difflineminus">-      {</span>
<a href="#l3.1686"></a><span id="l3.1686" class="difflineminus">-        nsCOMPtr &lt;nsIMsgFolder&gt; parent;</span>
<a href="#l3.1687"></a><span id="l3.1687" class="difflineplus">+          NS_SUCCEEDED(GetOrCreateFolder(folderUri, getter_AddRefs(folder)))) {</span>
<a href="#l3.1688"></a><span id="l3.1688" class="difflineplus">+        nsCOMPtr&lt;nsIMsgFolder&gt; parent;</span>
<a href="#l3.1689"></a><span id="l3.1689">         rv = folder-&gt;GetParent(getter_AddRefs(parent));</span>
<a href="#l3.1690"></a><span id="l3.1690">         if (NS_SUCCEEDED(rv) &amp;&amp; parent)</span>
<a href="#l3.1691"></a><span id="l3.1691">           rv = folder-&gt;SetFlag(nsMsgFolderFlags::SentMail);</span>
<a href="#l3.1692"></a><span id="l3.1692">       }</span>
<a href="#l3.1693"></a><span id="l3.1693"> </span>
<a href="#l3.1694"></a><span id="l3.1694">       thisIdentity-&gt;GetDraftFolder(folderUri);</span>
<a href="#l3.1695"></a><span id="l3.1695">       if (!folderUri.IsEmpty() &amp;&amp;</span>
<a href="#l3.1696"></a><span id="l3.1696" class="difflineminus">-          NS_SUCCEEDED(GetOrCreateFolder(folderUri, getter_AddRefs(folder))))</span>
<a href="#l3.1697"></a><span id="l3.1697" class="difflineminus">-      {</span>
<a href="#l3.1698"></a><span id="l3.1698" class="difflineminus">-        nsCOMPtr &lt;nsIMsgFolder&gt; parent;</span>
<a href="#l3.1699"></a><span id="l3.1699" class="difflineplus">+          NS_SUCCEEDED(GetOrCreateFolder(folderUri, getter_AddRefs(folder)))) {</span>
<a href="#l3.1700"></a><span id="l3.1700" class="difflineplus">+        nsCOMPtr&lt;nsIMsgFolder&gt; parent;</span>
<a href="#l3.1701"></a><span id="l3.1701">         rv = folder-&gt;GetParent(getter_AddRefs(parent));</span>
<a href="#l3.1702"></a><span id="l3.1702">         if (NS_SUCCEEDED(rv) &amp;&amp; parent)</span>
<a href="#l3.1703"></a><span id="l3.1703">           rv = folder-&gt;SetFlag(nsMsgFolderFlags::Drafts);</span>
<a href="#l3.1704"></a><span id="l3.1704">       }</span>
<a href="#l3.1705"></a><span id="l3.1705"> </span>
<a href="#l3.1706"></a><span id="l3.1706">       thisIdentity-&gt;GetArchiveFolder(folderUri);</span>
<a href="#l3.1707"></a><span id="l3.1707">       if (!folderUri.IsEmpty() &amp;&amp;</span>
<a href="#l3.1708"></a><span id="l3.1708" class="difflineminus">-          NS_SUCCEEDED(GetOrCreateFolder(folderUri, getter_AddRefs(folder))))</span>
<a href="#l3.1709"></a><span id="l3.1709" class="difflineminus">-      {</span>
<a href="#l3.1710"></a><span id="l3.1710" class="difflineminus">-        nsCOMPtr &lt;nsIMsgFolder&gt; parent;</span>
<a href="#l3.1711"></a><span id="l3.1711" class="difflineplus">+          NS_SUCCEEDED(GetOrCreateFolder(folderUri, getter_AddRefs(folder)))) {</span>
<a href="#l3.1712"></a><span id="l3.1712" class="difflineplus">+        nsCOMPtr&lt;nsIMsgFolder&gt; parent;</span>
<a href="#l3.1713"></a><span id="l3.1713">         rv = folder-&gt;GetParent(getter_AddRefs(parent));</span>
<a href="#l3.1714"></a><span id="l3.1714">         if (NS_SUCCEEDED(rv) &amp;&amp; parent) {</span>
<a href="#l3.1715"></a><span id="l3.1715">           bool archiveEnabled;</span>
<a href="#l3.1716"></a><span id="l3.1716">           thisIdentity-&gt;GetArchiveEnabled(&amp;archiveEnabled);</span>
<a href="#l3.1717"></a><span id="l3.1717">           if (archiveEnabled)</span>
<a href="#l3.1718"></a><span id="l3.1718">             rv = folder-&gt;SetFlag(nsMsgFolderFlags::Archive);</span>
<a href="#l3.1719"></a><span id="l3.1719">           else</span>
<a href="#l3.1720"></a><span id="l3.1720">             rv = folder-&gt;ClearFlag(nsMsgFolderFlags::Archive);</span>
<a href="#l3.1721"></a><span id="l3.1721">         }</span>
<a href="#l3.1722"></a><span id="l3.1722">       }</span>
<a href="#l3.1723"></a><span id="l3.1723"> </span>
<a href="#l3.1724"></a><span id="l3.1724">       thisIdentity-&gt;GetStationeryFolder(folderUri);</span>
<a href="#l3.1725"></a><span id="l3.1725">       if (!folderUri.IsEmpty() &amp;&amp;</span>
<a href="#l3.1726"></a><span id="l3.1726" class="difflineminus">-          NS_SUCCEEDED(GetOrCreateFolder(folderUri, getter_AddRefs(folder))))</span>
<a href="#l3.1727"></a><span id="l3.1727" class="difflineminus">-      {</span>
<a href="#l3.1728"></a><span id="l3.1728" class="difflineminus">-        nsCOMPtr &lt;nsIMsgFolder&gt; parent;</span>
<a href="#l3.1729"></a><span id="l3.1729" class="difflineplus">+          NS_SUCCEEDED(GetOrCreateFolder(folderUri, getter_AddRefs(folder)))) {</span>
<a href="#l3.1730"></a><span id="l3.1730" class="difflineplus">+        nsCOMPtr&lt;nsIMsgFolder&gt; parent;</span>
<a href="#l3.1731"></a><span id="l3.1731">         rv = folder-&gt;GetParent(getter_AddRefs(parent));</span>
<a href="#l3.1732"></a><span id="l3.1732">         if (NS_SUCCEEDED(rv) &amp;&amp; parent)</span>
<a href="#l3.1733"></a><span id="l3.1733">           folder-&gt;SetFlag(nsMsgFolderFlags::Templates);</span>
<a href="#l3.1734"></a><span id="l3.1734">       }</span>
<a href="#l3.1735"></a><span id="l3.1735">     }</span>
<a href="#l3.1736"></a><span id="l3.1736">   }</span>
<a href="#l3.1737"></a><span id="l3.1737"> </span>
<a href="#l3.1738"></a><span id="l3.1738">   // XXX todo</span>
<a href="#l3.1739"></a><span id="l3.1739">   // get all servers</span>
<a href="#l3.1740"></a><span id="l3.1740">   // get all spam settings for each server</span>
<a href="#l3.1741"></a><span id="l3.1741">   // set the JUNK folder flag on the spam folders, right?</span>
<a href="#l3.1742"></a><span id="l3.1742">   return NS_OK;</span>
<a href="#l3.1743"></a><span id="l3.1743"> }</span>
<a href="#l3.1744"></a><span id="l3.1744"> </span>
<a href="#l3.1745"></a><span id="l3.1745"> NS_IMETHODIMP</span>
<a href="#l3.1746"></a><span id="l3.1746" class="difflineminus">-nsMsgAccountManager::UnloadAccounts()</span>
<a href="#l3.1747"></a><span id="l3.1747" class="difflineminus">-{</span>
<a href="#l3.1748"></a><span id="l3.1748" class="difflineplus">+nsMsgAccountManager::UnloadAccounts() {</span>
<a href="#l3.1749"></a><span id="l3.1749">   // release the default account</span>
<a href="#l3.1750"></a><span id="l3.1750" class="difflineminus">-  m_defaultAccount=nullptr;</span>
<a href="#l3.1751"></a><span id="l3.1751" class="difflineplus">+  m_defaultAccount = nullptr;</span>
<a href="#l3.1752"></a><span id="l3.1752">   for (auto iter = m_incomingServers.Iter(); !iter.Done(); iter.Next()) {</span>
<a href="#l3.1753"></a><span id="l3.1753" class="difflineminus">-    nsCOMPtr&lt;nsIMsgIncomingServer&gt;&amp; server = iter.Data();</span>
<a href="#l3.1754"></a><span id="l3.1754" class="difflineminus">-    if (!server)</span>
<a href="#l3.1755"></a><span id="l3.1755" class="difflineminus">-      continue;</span>
<a href="#l3.1756"></a><span id="l3.1756" class="difflineplus">+    nsCOMPtr&lt;nsIMsgIncomingServer&gt; &amp;server = iter.Data();</span>
<a href="#l3.1757"></a><span id="l3.1757" class="difflineplus">+    if (!server) continue;</span>
<a href="#l3.1758"></a><span id="l3.1758">     nsresult rv;</span>
<a href="#l3.1759"></a><span id="l3.1759">     NotifyServerUnloaded(server);</span>
<a href="#l3.1760"></a><span id="l3.1760"> </span>
<a href="#l3.1761"></a><span id="l3.1761">     nsCOMPtr&lt;nsIMsgFolder&gt; rootFolder;</span>
<a href="#l3.1762"></a><span id="l3.1762">     rv = server-&gt;GetRootFolder(getter_AddRefs(rootFolder));</span>
<a href="#l3.1763"></a><span id="l3.1763">     if (NS_SUCCEEDED(rv)) {</span>
<a href="#l3.1764"></a><span id="l3.1764">       removeListenersFromFolder(rootFolder);</span>
<a href="#l3.1765"></a><span id="l3.1765"> </span>
<a href="#l3.1766"></a><span id="l3.1766">       rootFolder-&gt;Shutdown(true);</span>
<a href="#l3.1767"></a><span id="l3.1767">     }</span>
<a href="#l3.1768"></a><span id="l3.1768">   }</span>
<a href="#l3.1769"></a><span id="l3.1769"> </span>
<a href="#l3.1770"></a><span id="l3.1770" class="difflineminus">-  m_accounts.Clear();          // will release all elements</span>
<a href="#l3.1771"></a><span id="l3.1771" class="difflineplus">+  m_accounts.Clear();  // will release all elements</span>
<a href="#l3.1772"></a><span id="l3.1772">   m_identities.Clear();</span>
<a href="#l3.1773"></a><span id="l3.1773">   m_incomingServers.Clear();</span>
<a href="#l3.1774"></a><span id="l3.1774">   mAccountKeyList.Truncate();</span>
<a href="#l3.1775"></a><span id="l3.1775" class="difflineminus">-  SetLastServerFound(nullptr, EmptyCString(), EmptyCString(), 0, EmptyCString());</span>
<a href="#l3.1776"></a><span id="l3.1776" class="difflineminus">-</span>
<a href="#l3.1777"></a><span id="l3.1777" class="difflineminus">-  if (m_accountsLoaded)</span>
<a href="#l3.1778"></a><span id="l3.1778" class="difflineminus">-  {</span>
<a href="#l3.1779"></a><span id="l3.1779" class="difflineplus">+  SetLastServerFound(nullptr, EmptyCString(), EmptyCString(), 0,</span>
<a href="#l3.1780"></a><span id="l3.1780" class="difflineplus">+                     EmptyCString());</span>
<a href="#l3.1781"></a><span id="l3.1781" class="difflineplus">+</span>
<a href="#l3.1782"></a><span id="l3.1782" class="difflineplus">+  if (m_accountsLoaded) {</span>
<a href="#l3.1783"></a><span id="l3.1783">     nsCOMPtr&lt;nsIMsgMailSession&gt; mailSession =</span>
<a href="#l3.1784"></a><span id="l3.1784" class="difflineminus">-      do_GetService(NS_MSGMAILSESSION_CONTRACTID);</span>
<a href="#l3.1785"></a><span id="l3.1785" class="difflineminus">-    if (mailSession)</span>
<a href="#l3.1786"></a><span id="l3.1786" class="difflineminus">-      mailSession-&gt;RemoveFolderListener(this);</span>
<a href="#l3.1787"></a><span id="l3.1787" class="difflineplus">+        do_GetService(NS_MSGMAILSESSION_CONTRACTID);</span>
<a href="#l3.1788"></a><span id="l3.1788" class="difflineplus">+    if (mailSession) mailSession-&gt;RemoveFolderListener(this);</span>
<a href="#l3.1789"></a><span id="l3.1789">     m_accountsLoaded = false;</span>
<a href="#l3.1790"></a><span id="l3.1790">   }</span>
<a href="#l3.1791"></a><span id="l3.1791"> </span>
<a href="#l3.1792"></a><span id="l3.1792">   return NS_OK;</span>
<a href="#l3.1793"></a><span id="l3.1793"> }</span>
<a href="#l3.1794"></a><span id="l3.1794"> </span>
<a href="#l3.1795"></a><span id="l3.1795"> NS_IMETHODIMP</span>
<a href="#l3.1796"></a><span id="l3.1796" class="difflineminus">-nsMsgAccountManager::ShutdownServers()</span>
<a href="#l3.1797"></a><span id="l3.1797" class="difflineminus">-{</span>
<a href="#l3.1798"></a><span id="l3.1798" class="difflineplus">+nsMsgAccountManager::ShutdownServers() {</span>
<a href="#l3.1799"></a><span id="l3.1799">   for (auto iter = m_incomingServers.Iter(); !iter.Done(); iter.Next()) {</span>
<a href="#l3.1800"></a><span id="l3.1800" class="difflineminus">-    nsCOMPtr&lt;nsIMsgIncomingServer&gt;&amp; server = iter.Data();</span>
<a href="#l3.1801"></a><span id="l3.1801" class="difflineminus">-    if (server)</span>
<a href="#l3.1802"></a><span id="l3.1802" class="difflineminus">-      server-&gt;Shutdown();</span>
<a href="#l3.1803"></a><span id="l3.1803" class="difflineplus">+    nsCOMPtr&lt;nsIMsgIncomingServer&gt; &amp;server = iter.Data();</span>
<a href="#l3.1804"></a><span id="l3.1804" class="difflineplus">+    if (server) server-&gt;Shutdown();</span>
<a href="#l3.1805"></a><span id="l3.1805">   }</span>
<a href="#l3.1806"></a><span id="l3.1806">   return NS_OK;</span>
<a href="#l3.1807"></a><span id="l3.1807"> }</span>
<a href="#l3.1808"></a><span id="l3.1808"> </span>
<a href="#l3.1809"></a><span id="l3.1809"> NS_IMETHODIMP</span>
<a href="#l3.1810"></a><span id="l3.1810" class="difflineminus">-nsMsgAccountManager::CloseCachedConnections()</span>
<a href="#l3.1811"></a><span id="l3.1811" class="difflineminus">-{</span>
<a href="#l3.1812"></a><span id="l3.1812" class="difflineplus">+nsMsgAccountManager::CloseCachedConnections() {</span>
<a href="#l3.1813"></a><span id="l3.1813">   for (auto iter = m_incomingServers.Iter(); !iter.Done(); iter.Next()) {</span>
<a href="#l3.1814"></a><span id="l3.1814" class="difflineminus">-    nsCOMPtr&lt;nsIMsgIncomingServer&gt;&amp; server = iter.Data();</span>
<a href="#l3.1815"></a><span id="l3.1815" class="difflineminus">-    if (server)</span>
<a href="#l3.1816"></a><span id="l3.1816" class="difflineminus">-      server-&gt;CloseCachedConnections();</span>
<a href="#l3.1817"></a><span id="l3.1817" class="difflineplus">+    nsCOMPtr&lt;nsIMsgIncomingServer&gt; &amp;server = iter.Data();</span>
<a href="#l3.1818"></a><span id="l3.1818" class="difflineplus">+    if (server) server-&gt;CloseCachedConnections();</span>
<a href="#l3.1819"></a><span id="l3.1819">   }</span>
<a href="#l3.1820"></a><span id="l3.1820">   return NS_OK;</span>
<a href="#l3.1821"></a><span id="l3.1821"> }</span>
<a href="#l3.1822"></a><span id="l3.1822"> </span>
<a href="#l3.1823"></a><span id="l3.1823"> NS_IMETHODIMP</span>
<a href="#l3.1824"></a><span id="l3.1824" class="difflineminus">-nsMsgAccountManager::CleanupOnExit()</span>
<a href="#l3.1825"></a><span id="l3.1825" class="difflineminus">-{</span>
<a href="#l3.1826"></a><span id="l3.1826" class="difflineplus">+nsMsgAccountManager::CleanupOnExit() {</span>
<a href="#l3.1827"></a><span id="l3.1827">   // This can get called multiple times, and potentially re-entrantly.</span>
<a href="#l3.1828"></a><span id="l3.1828">   // So add some protection against that.</span>
<a href="#l3.1829"></a><span id="l3.1829" class="difflineminus">-  if (m_shutdownInProgress)</span>
<a href="#l3.1830"></a><span id="l3.1830" class="difflineminus">-    return NS_OK;</span>
<a href="#l3.1831"></a><span id="l3.1831" class="difflineplus">+  if (m_shutdownInProgress) return NS_OK;</span>
<a href="#l3.1832"></a><span id="l3.1832"> </span>
<a href="#l3.1833"></a><span id="l3.1833">   m_shutdownInProgress = true;</span>
<a href="#l3.1834"></a><span id="l3.1834"> </span>
<a href="#l3.1835"></a><span id="l3.1835">   for (auto iter = m_incomingServers.Iter(); !iter.Done(); iter.Next()) {</span>
<a href="#l3.1836"></a><span id="l3.1836" class="difflineminus">-    nsCOMPtr&lt;nsIMsgIncomingServer&gt;&amp; server = iter.Data();</span>
<a href="#l3.1837"></a><span id="l3.1837" class="difflineplus">+    nsCOMPtr&lt;nsIMsgIncomingServer&gt; &amp;server = iter.Data();</span>
<a href="#l3.1838"></a><span id="l3.1838"> </span>
<a href="#l3.1839"></a><span id="l3.1839">     bool emptyTrashOnExit = false;</span>
<a href="#l3.1840"></a><span id="l3.1840">     bool cleanupInboxOnExit = false;</span>
<a href="#l3.1841"></a><span id="l3.1841">     nsresult rv;</span>
<a href="#l3.1842"></a><span id="l3.1842"> </span>
<a href="#l3.1843"></a><span id="l3.1843" class="difflineminus">-    if (WeAreOffline())</span>
<a href="#l3.1844"></a><span id="l3.1844" class="difflineminus">-      break;</span>
<a href="#l3.1845"></a><span id="l3.1845" class="difflineminus">-</span>
<a href="#l3.1846"></a><span id="l3.1846" class="difflineminus">-    if (!server)</span>
<a href="#l3.1847"></a><span id="l3.1847" class="difflineminus">-      continue;</span>
<a href="#l3.1848"></a><span id="l3.1848" class="difflineplus">+    if (WeAreOffline()) break;</span>
<a href="#l3.1849"></a><span id="l3.1849" class="difflineplus">+</span>
<a href="#l3.1850"></a><span id="l3.1850" class="difflineplus">+    if (!server) continue;</span>
<a href="#l3.1851"></a><span id="l3.1851"> </span>
<a href="#l3.1852"></a><span id="l3.1852">     server-&gt;GetEmptyTrashOnExit(&amp;emptyTrashOnExit);</span>
<a href="#l3.1853"></a><span id="l3.1853" class="difflineminus">-    nsCOMPtr &lt;nsIImapIncomingServer&gt; imapserver = do_QueryInterface(server);</span>
<a href="#l3.1854"></a><span id="l3.1854" class="difflineminus">-    if (imapserver)</span>
<a href="#l3.1855"></a><span id="l3.1855" class="difflineminus">-    {</span>
<a href="#l3.1856"></a><span id="l3.1856" class="difflineplus">+    nsCOMPtr&lt;nsIImapIncomingServer&gt; imapserver = do_QueryInterface(server);</span>
<a href="#l3.1857"></a><span id="l3.1857" class="difflineplus">+    if (imapserver) {</span>
<a href="#l3.1858"></a><span id="l3.1858">       imapserver-&gt;GetCleanupInboxOnExit(&amp;cleanupInboxOnExit);</span>
<a href="#l3.1859"></a><span id="l3.1859">       imapserver-&gt;SetShuttingDown(true);</span>
<a href="#l3.1860"></a><span id="l3.1860">     }</span>
<a href="#l3.1861"></a><span id="l3.1861" class="difflineminus">-    if (emptyTrashOnExit || cleanupInboxOnExit)</span>
<a href="#l3.1862"></a><span id="l3.1862" class="difflineminus">-    {</span>
<a href="#l3.1863"></a><span id="l3.1863" class="difflineplus">+    if (emptyTrashOnExit || cleanupInboxOnExit) {</span>
<a href="#l3.1864"></a><span id="l3.1864">       nsCOMPtr&lt;nsIMsgFolder&gt; root;</span>
<a href="#l3.1865"></a><span id="l3.1865">       server-&gt;GetRootFolder(getter_AddRefs(root));</span>
<a href="#l3.1866"></a><span id="l3.1866">       nsCString type;</span>
<a href="#l3.1867"></a><span id="l3.1867">       server-&gt;GetType(type);</span>
<a href="#l3.1868"></a><span id="l3.1868" class="difflineminus">-      if (root)</span>
<a href="#l3.1869"></a><span id="l3.1869" class="difflineminus">-      {</span>
<a href="#l3.1870"></a><span id="l3.1870" class="difflineplus">+      if (root) {</span>
<a href="#l3.1871"></a><span id="l3.1871">         nsString passwd;</span>
<a href="#l3.1872"></a><span id="l3.1872">         bool serverRequiresPasswordForAuthentication = true;</span>
<a href="#l3.1873"></a><span id="l3.1873">         bool isImap = type.EqualsLiteral(&quot;imap&quot;);</span>
<a href="#l3.1874"></a><span id="l3.1874" class="difflineminus">-        if (isImap)</span>
<a href="#l3.1875"></a><span id="l3.1875" class="difflineminus">-        {</span>
<a href="#l3.1876"></a><span id="l3.1876" class="difflineminus">-          server-&gt;GetServerRequiresPasswordForBiff(&amp;serverRequiresPasswordForAuthentication);</span>
<a href="#l3.1877"></a><span id="l3.1877" class="difflineplus">+        if (isImap) {</span>
<a href="#l3.1878"></a><span id="l3.1878" class="difflineplus">+          server-&gt;GetServerRequiresPasswordForBiff(</span>
<a href="#l3.1879"></a><span id="l3.1879" class="difflineplus">+              &amp;serverRequiresPasswordForAuthentication);</span>
<a href="#l3.1880"></a><span id="l3.1880">           server-&gt;GetPassword(passwd);</span>
<a href="#l3.1881"></a><span id="l3.1881">         }</span>
<a href="#l3.1882"></a><span id="l3.1882" class="difflineminus">-        if (!isImap || (isImap &amp;&amp; (!serverRequiresPasswordForAuthentication || !passwd.IsEmpty())))</span>
<a href="#l3.1883"></a><span id="l3.1883" class="difflineminus">-        {</span>
<a href="#l3.1884"></a><span id="l3.1884" class="difflineplus">+        if (!isImap || (isImap &amp;&amp; (!serverRequiresPasswordForAuthentication ||</span>
<a href="#l3.1885"></a><span id="l3.1885" class="difflineplus">+                                   !passwd.IsEmpty()))) {</span>
<a href="#l3.1886"></a><span id="l3.1886">           nsCOMPtr&lt;nsIUrlListener&gt; urlListener;</span>
<a href="#l3.1887"></a><span id="l3.1887">           nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l3.1888"></a><span id="l3.1888" class="difflineminus">-                   do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l3.1889"></a><span id="l3.1889" class="difflineminus">-          if (NS_FAILED(rv))</span>
<a href="#l3.1890"></a><span id="l3.1890" class="difflineminus">-            continue;</span>
<a href="#l3.1891"></a><span id="l3.1891" class="difflineminus">-</span>
<a href="#l3.1892"></a><span id="l3.1892" class="difflineminus">-          if (isImap)</span>
<a href="#l3.1893"></a><span id="l3.1893" class="difflineminus">-            urlListener = do_QueryInterface(accountManager, &amp;rv);</span>
<a href="#l3.1894"></a><span id="l3.1894" class="difflineminus">-</span>
<a href="#l3.1895"></a><span id="l3.1895" class="difflineminus">-          if (isImap &amp;&amp; cleanupInboxOnExit)</span>
<a href="#l3.1896"></a><span id="l3.1896" class="difflineminus">-          {</span>
<a href="#l3.1897"></a><span id="l3.1897" class="difflineplus">+              do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l3.1898"></a><span id="l3.1898" class="difflineplus">+          if (NS_FAILED(rv)) continue;</span>
<a href="#l3.1899"></a><span id="l3.1899" class="difflineplus">+</span>
<a href="#l3.1900"></a><span id="l3.1900" class="difflineplus">+          if (isImap) urlListener = do_QueryInterface(accountManager, &amp;rv);</span>
<a href="#l3.1901"></a><span id="l3.1901" class="difflineplus">+</span>
<a href="#l3.1902"></a><span id="l3.1902" class="difflineplus">+          if (isImap &amp;&amp; cleanupInboxOnExit) {</span>
<a href="#l3.1903"></a><span id="l3.1903">             nsCOMPtr&lt;nsISimpleEnumerator&gt; enumerator;</span>
<a href="#l3.1904"></a><span id="l3.1904">             rv = root-&gt;GetSubFolders(getter_AddRefs(enumerator));</span>
<a href="#l3.1905"></a><span id="l3.1905" class="difflineminus">-            if (NS_SUCCEEDED(rv))</span>
<a href="#l3.1906"></a><span id="l3.1906" class="difflineminus">-            {</span>
<a href="#l3.1907"></a><span id="l3.1907" class="difflineplus">+            if (NS_SUCCEEDED(rv)) {</span>
<a href="#l3.1908"></a><span id="l3.1908">               bool hasMore;</span>
<a href="#l3.1909"></a><span id="l3.1909">               while (NS_SUCCEEDED(enumerator-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp;</span>
<a href="#l3.1910"></a><span id="l3.1910" class="difflineminus">-                     hasMore)</span>
<a href="#l3.1911"></a><span id="l3.1911" class="difflineminus">-              {</span>
<a href="#l3.1912"></a><span id="l3.1912" class="difflineplus">+                     hasMore) {</span>
<a href="#l3.1913"></a><span id="l3.1913">                 nsCOMPtr&lt;nsISupports&gt; item;</span>
<a href="#l3.1914"></a><span id="l3.1914">                 enumerator-&gt;GetNext(getter_AddRefs(item));</span>
<a href="#l3.1915"></a><span id="l3.1915"> </span>
<a href="#l3.1916"></a><span id="l3.1916">                 nsCOMPtr&lt;nsIMsgFolder&gt; inboxFolder(do_QueryInterface(item));</span>
<a href="#l3.1917"></a><span id="l3.1917" class="difflineminus">-                if (!inboxFolder)</span>
<a href="#l3.1918"></a><span id="l3.1918" class="difflineminus">-                  continue;</span>
<a href="#l3.1919"></a><span id="l3.1919" class="difflineplus">+                if (!inboxFolder) continue;</span>
<a href="#l3.1920"></a><span id="l3.1920"> </span>
<a href="#l3.1921"></a><span id="l3.1921">                 uint32_t flags;</span>
<a href="#l3.1922"></a><span id="l3.1922">                 inboxFolder-&gt;GetFlags(&amp;flags);</span>
<a href="#l3.1923"></a><span id="l3.1923" class="difflineminus">-                if (flags &amp; nsMsgFolderFlags::Inbox)</span>
<a href="#l3.1924"></a><span id="l3.1924" class="difflineminus">-                {</span>
<a href="#l3.1925"></a><span id="l3.1925" class="difflineminus">-                  rv = inboxFolder-&gt;Compact(urlListener, nullptr /* msgwindow */);</span>
<a href="#l3.1926"></a><span id="l3.1926" class="difflineplus">+                if (flags &amp; nsMsgFolderFlags::Inbox) {</span>
<a href="#l3.1927"></a><span id="l3.1927" class="difflineplus">+                  rv = inboxFolder-&gt;Compact(urlListener,</span>
<a href="#l3.1928"></a><span id="l3.1928" class="difflineplus">+                                            nullptr /* msgwindow */);</span>
<a href="#l3.1929"></a><span id="l3.1929">                   if (NS_SUCCEEDED(rv))</span>
<a href="#l3.1930"></a><span id="l3.1930">                     accountManager-&gt;SetFolderDoingCleanupInbox(inboxFolder);</span>
<a href="#l3.1931"></a><span id="l3.1931">                   break;</span>
<a href="#l3.1932"></a><span id="l3.1932">                 }</span>
<a href="#l3.1933"></a><span id="l3.1933">               }</span>
<a href="#l3.1934"></a><span id="l3.1934">             }</span>
<a href="#l3.1935"></a><span id="l3.1935">           }</span>
<a href="#l3.1936"></a><span id="l3.1936"> </span>
<a href="#l3.1937"></a><span id="l3.1937" class="difflineminus">-          if (emptyTrashOnExit)</span>
<a href="#l3.1938"></a><span id="l3.1938" class="difflineminus">-          {</span>
<a href="#l3.1939"></a><span id="l3.1939" class="difflineplus">+          if (emptyTrashOnExit) {</span>
<a href="#l3.1940"></a><span id="l3.1940">             rv = root-&gt;EmptyTrash(nullptr, urlListener);</span>
<a href="#l3.1941"></a><span id="l3.1941">             if (isImap &amp;&amp; NS_SUCCEEDED(rv))</span>
<a href="#l3.1942"></a><span id="l3.1942">               accountManager-&gt;SetFolderDoingEmptyTrash(root);</span>
<a href="#l3.1943"></a><span id="l3.1943">           }</span>
<a href="#l3.1944"></a><span id="l3.1944"> </span>
<a href="#l3.1945"></a><span id="l3.1945" class="difflineminus">-          if (isImap &amp;&amp; urlListener)</span>
<a href="#l3.1946"></a><span id="l3.1946" class="difflineminus">-          {</span>
<a href="#l3.1947"></a><span id="l3.1947" class="difflineplus">+          if (isImap &amp;&amp; urlListener) {</span>
<a href="#l3.1948"></a><span id="l3.1948">             nsCOMPtr&lt;nsIThread&gt; thread(do_GetCurrentThread());</span>
<a href="#l3.1949"></a><span id="l3.1949"> </span>
<a href="#l3.1950"></a><span id="l3.1950">             bool inProgress = false;</span>
<a href="#l3.1951"></a><span id="l3.1951" class="difflineminus">-            if (cleanupInboxOnExit)</span>
<a href="#l3.1952"></a><span id="l3.1952" class="difflineminus">-            {</span>
<a href="#l3.1953"></a><span id="l3.1953" class="difflineminus">-              int32_t loopCount = 0; // used to break out after 5 seconds</span>
<a href="#l3.1954"></a><span id="l3.1954" class="difflineplus">+            if (cleanupInboxOnExit) {</span>
<a href="#l3.1955"></a><span id="l3.1955" class="difflineplus">+              int32_t loopCount = 0;  // used to break out after 5 seconds</span>
<a href="#l3.1956"></a><span id="l3.1956">               accountManager-&gt;GetCleanupInboxInProgress(&amp;inProgress);</span>
<a href="#l3.1957"></a><span id="l3.1957" class="difflineminus">-              while (inProgress &amp;&amp; loopCount++ &lt; 5000)</span>
<a href="#l3.1958"></a><span id="l3.1958" class="difflineminus">-              {</span>
<a href="#l3.1959"></a><span id="l3.1959" class="difflineplus">+              while (inProgress &amp;&amp; loopCount++ &lt; 5000) {</span>
<a href="#l3.1960"></a><span id="l3.1960">                 accountManager-&gt;GetCleanupInboxInProgress(&amp;inProgress);</span>
<a href="#l3.1961"></a><span id="l3.1961">                 PR_CEnterMonitor(root);</span>
<a href="#l3.1962"></a><span id="l3.1962">                 PR_CWait(root, PR_MicrosecondsToInterval(1000UL));</span>
<a href="#l3.1963"></a><span id="l3.1963">                 PR_CExitMonitor(root);</span>
<a href="#l3.1964"></a><span id="l3.1964" class="difflineminus">-                NS_ProcessPendingEvents(thread, PR_MicrosecondsToInterval(1000UL));</span>
<a href="#l3.1965"></a><span id="l3.1965" class="difflineplus">+                NS_ProcessPendingEvents(thread,</span>
<a href="#l3.1966"></a><span id="l3.1966" class="difflineplus">+                                        PR_MicrosecondsToInterval(1000UL));</span>
<a href="#l3.1967"></a><span id="l3.1967">               }</span>
<a href="#l3.1968"></a><span id="l3.1968">             }</span>
<a href="#l3.1969"></a><span id="l3.1969" class="difflineminus">-            if (emptyTrashOnExit)</span>
<a href="#l3.1970"></a><span id="l3.1970" class="difflineminus">-            {</span>
<a href="#l3.1971"></a><span id="l3.1971" class="difflineplus">+            if (emptyTrashOnExit) {</span>
<a href="#l3.1972"></a><span id="l3.1972">               accountManager-&gt;GetEmptyTrashInProgress(&amp;inProgress);</span>
<a href="#l3.1973"></a><span id="l3.1973">               int32_t loopCount = 0;</span>
<a href="#l3.1974"></a><span id="l3.1974" class="difflineminus">-              while (inProgress &amp;&amp; loopCount++ &lt; 5000)</span>
<a href="#l3.1975"></a><span id="l3.1975" class="difflineminus">-              {</span>
<a href="#l3.1976"></a><span id="l3.1976" class="difflineplus">+              while (inProgress &amp;&amp; loopCount++ &lt; 5000) {</span>
<a href="#l3.1977"></a><span id="l3.1977">                 accountManager-&gt;GetEmptyTrashInProgress(&amp;inProgress);</span>
<a href="#l3.1978"></a><span id="l3.1978">                 PR_CEnterMonitor(root);</span>
<a href="#l3.1979"></a><span id="l3.1979">                 PR_CWait(root, PR_MicrosecondsToInterval(1000UL));</span>
<a href="#l3.1980"></a><span id="l3.1980">                 PR_CExitMonitor(root);</span>
<a href="#l3.1981"></a><span id="l3.1981" class="difflineminus">-                NS_ProcessPendingEvents(thread, PR_MicrosecondsToInterval(1000UL));</span>
<a href="#l3.1982"></a><span id="l3.1982" class="difflineplus">+                NS_ProcessPendingEvents(thread,</span>
<a href="#l3.1983"></a><span id="l3.1983" class="difflineplus">+                                        PR_MicrosecondsToInterval(1000UL));</span>
<a href="#l3.1984"></a><span id="l3.1984">               }</span>
<a href="#l3.1985"></a><span id="l3.1985">             }</span>
<a href="#l3.1986"></a><span id="l3.1986">           }</span>
<a href="#l3.1987"></a><span id="l3.1987">         }</span>
<a href="#l3.1988"></a><span id="l3.1988">       }</span>
<a href="#l3.1989"></a><span id="l3.1989">     }</span>
<a href="#l3.1990"></a><span id="l3.1990">   }</span>
<a href="#l3.1991"></a><span id="l3.1991"> </span>
<a href="#l3.1992"></a><span id="l3.1992">   // Try to do this early on in the shutdown process before</span>
<a href="#l3.1993"></a><span id="l3.1993">   // necko shuts itself down.</span>
<a href="#l3.1994"></a><span id="l3.1994">   CloseCachedConnections();</span>
<a href="#l3.1995"></a><span id="l3.1995">   return NS_OK;</span>
<a href="#l3.1996"></a><span id="l3.1996"> }</span>
<a href="#l3.1997"></a><span id="l3.1997"> </span>
<a href="#l3.1998"></a><span id="l3.1998"> NS_IMETHODIMP</span>
<a href="#l3.1999"></a><span id="l3.1999" class="difflineminus">-nsMsgAccountManager::WriteToFolderCache(nsIMsgFolderCache *folderCache)</span>
<a href="#l3.2000"></a><span id="l3.2000" class="difflineminus">-{</span>
<a href="#l3.2001"></a><span id="l3.2001" class="difflineplus">+nsMsgAccountManager::WriteToFolderCache(nsIMsgFolderCache *folderCache) {</span>
<a href="#l3.2002"></a><span id="l3.2002">   for (auto iter = m_incomingServers.Iter(); !iter.Done(); iter.Next()) {</span>
<a href="#l3.2003"></a><span id="l3.2003">     iter.Data()-&gt;WriteToFolderCache(folderCache);</span>
<a href="#l3.2004"></a><span id="l3.2004">   }</span>
<a href="#l3.2005"></a><span id="l3.2005">   return folderCache ? folderCache-&gt;Close() : NS_ERROR_FAILURE;</span>
<a href="#l3.2006"></a><span id="l3.2006"> }</span>
<a href="#l3.2007"></a><span id="l3.2007"> </span>
<a href="#l3.2008"></a><span id="l3.2008" class="difflineminus">-nsresult</span>
<a href="#l3.2009"></a><span id="l3.2009" class="difflineminus">-nsMsgAccountManager::createKeyedAccount(const nsCString&amp; key,</span>
<a href="#l3.2010"></a><span id="l3.2010" class="difflineminus">-                                        nsIMsgAccount ** aAccount)</span>
<a href="#l3.2011"></a><span id="l3.2011" class="difflineminus">-{</span>
<a href="#l3.2012"></a><span id="l3.2012" class="difflineminus">-</span>
<a href="#l3.2013"></a><span id="l3.2013" class="difflineplus">+nsresult nsMsgAccountManager::createKeyedAccount(const nsCString &amp;key,</span>
<a href="#l3.2014"></a><span id="l3.2014" class="difflineplus">+                                                 nsIMsgAccount **aAccount) {</span>
<a href="#l3.2015"></a><span id="l3.2015">   nsresult rv;</span>
<a href="#l3.2016"></a><span id="l3.2016">   nsCOMPtr&lt;nsIMsgAccount&gt; account = do_CreateInstance(kMsgAccountCID, &amp;rv);</span>
<a href="#l3.2017"></a><span id="l3.2017">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.2018"></a><span id="l3.2018"> </span>
<a href="#l3.2019"></a><span id="l3.2019">   account-&gt;SetKey(key);</span>
<a href="#l3.2020"></a><span id="l3.2020"> </span>
<a href="#l3.2021"></a><span id="l3.2021">   m_accounts.AppendElement(account);</span>
<a href="#l3.2022"></a><span id="l3.2022"> </span>
<a href="#l3.2023"></a><span id="l3.2023" class="difflineat">@@ -1730,816 +1586,747 @@ nsMsgAccountManager::createKeyedAccount(</span>
<a href="#l3.2024"></a><span id="l3.2024">   }</span>
<a href="#l3.2025"></a><span id="l3.2025"> </span>
<a href="#l3.2026"></a><span id="l3.2026">   m_prefs-&gt;SetCharPref(PREF_MAIL_ACCOUNTMANAGER_ACCOUNTS, mAccountKeyList);</span>
<a href="#l3.2027"></a><span id="l3.2027">   account.forget(aAccount);</span>
<a href="#l3.2028"></a><span id="l3.2028">   return NS_OK;</span>
<a href="#l3.2029"></a><span id="l3.2029"> }</span>
<a href="#l3.2030"></a><span id="l3.2030"> </span>
<a href="#l3.2031"></a><span id="l3.2031"> NS_IMETHODIMP</span>
<a href="#l3.2032"></a><span id="l3.2032" class="difflineminus">-nsMsgAccountManager::CreateAccount(nsIMsgAccount **_retval)</span>
<a href="#l3.2033"></a><span id="l3.2033" class="difflineminus">-{</span>
<a href="#l3.2034"></a><span id="l3.2034" class="difflineplus">+nsMsgAccountManager::CreateAccount(nsIMsgAccount **_retval) {</span>
<a href="#l3.2035"></a><span id="l3.2035">   NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l3.2036"></a><span id="l3.2036"> </span>
<a href="#l3.2037"></a><span id="l3.2037">   nsAutoCString key;</span>
<a href="#l3.2038"></a><span id="l3.2038">   getUniqueAccountKey(key);</span>
<a href="#l3.2039"></a><span id="l3.2039"> </span>
<a href="#l3.2040"></a><span id="l3.2040">   return createKeyedAccount(key, _retval);</span>
<a href="#l3.2041"></a><span id="l3.2041"> }</span>
<a href="#l3.2042"></a><span id="l3.2042"> </span>
<a href="#l3.2043"></a><span id="l3.2043"> NS_IMETHODIMP</span>
<a href="#l3.2044"></a><span id="l3.2044" class="difflineminus">-nsMsgAccountManager::GetAccount(const nsACString&amp; aKey, nsIMsgAccount **aAccount)</span>
<a href="#l3.2045"></a><span id="l3.2045" class="difflineminus">-{</span>
<a href="#l3.2046"></a><span id="l3.2046" class="difflineplus">+nsMsgAccountManager::GetAccount(const nsACString &amp;aKey,</span>
<a href="#l3.2047"></a><span id="l3.2047" class="difflineplus">+                                nsIMsgAccount **aAccount) {</span>
<a href="#l3.2048"></a><span id="l3.2048">   NS_ENSURE_ARG_POINTER(aAccount);</span>
<a href="#l3.2049"></a><span id="l3.2049">   *aAccount = nullptr;</span>
<a href="#l3.2050"></a><span id="l3.2050"> </span>
<a href="#l3.2051"></a><span id="l3.2051" class="difflineminus">-  for (uint32_t i = 0; i &lt; m_accounts.Length(); ++i)</span>
<a href="#l3.2052"></a><span id="l3.2052" class="difflineminus">-  {</span>
<a href="#l3.2053"></a><span id="l3.2053" class="difflineplus">+  for (uint32_t i = 0; i &lt; m_accounts.Length(); ++i) {</span>
<a href="#l3.2054"></a><span id="l3.2054">     nsCOMPtr&lt;nsIMsgAccount&gt; account(m_accounts[i]);</span>
<a href="#l3.2055"></a><span id="l3.2055">     nsCString key;</span>
<a href="#l3.2056"></a><span id="l3.2056">     account-&gt;GetKey(key);</span>
<a href="#l3.2057"></a><span id="l3.2057" class="difflineminus">-    if (key.Equals(aKey))</span>
<a href="#l3.2058"></a><span id="l3.2058" class="difflineminus">-    {</span>
<a href="#l3.2059"></a><span id="l3.2059" class="difflineplus">+    if (key.Equals(aKey)) {</span>
<a href="#l3.2060"></a><span id="l3.2060">       account.forget(aAccount);</span>
<a href="#l3.2061"></a><span id="l3.2061">       break;</span>
<a href="#l3.2062"></a><span id="l3.2062">     }</span>
<a href="#l3.2063"></a><span id="l3.2063">   }</span>
<a href="#l3.2064"></a><span id="l3.2064"> </span>
<a href="#l3.2065"></a><span id="l3.2065">   // If not found, create on demand.</span>
<a href="#l3.2066"></a><span id="l3.2066">   return NS_OK;</span>
<a href="#l3.2067"></a><span id="l3.2067"> }</span>
<a href="#l3.2068"></a><span id="l3.2068"> </span>
<a href="#l3.2069"></a><span id="l3.2069"> NS_IMETHODIMP</span>
<a href="#l3.2070"></a><span id="l3.2070" class="difflineminus">-nsMsgAccountManager::FindServerIndex(nsIMsgIncomingServer* server, int32_t* result)</span>
<a href="#l3.2071"></a><span id="l3.2071" class="difflineminus">-{</span>
<a href="#l3.2072"></a><span id="l3.2072" class="difflineplus">+nsMsgAccountManager::FindServerIndex(nsIMsgIncomingServer *server,</span>
<a href="#l3.2073"></a><span id="l3.2073" class="difflineplus">+                                     int32_t *result) {</span>
<a href="#l3.2074"></a><span id="l3.2074">   NS_ENSURE_ARG_POINTER(server);</span>
<a href="#l3.2075"></a><span id="l3.2075">   NS_ENSURE_ARG_POINTER(result);</span>
<a href="#l3.2076"></a><span id="l3.2076"> </span>
<a href="#l3.2077"></a><span id="l3.2077">   nsCString key;</span>
<a href="#l3.2078"></a><span id="l3.2078">   nsresult rv = server-&gt;GetKey(key);</span>
<a href="#l3.2079"></a><span id="l3.2079">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.2080"></a><span id="l3.2080"> </span>
<a href="#l3.2081"></a><span id="l3.2081">   // do this by account because the account list is in order</span>
<a href="#l3.2082"></a><span id="l3.2082">   uint32_t i;</span>
<a href="#l3.2083"></a><span id="l3.2083" class="difflineminus">-  for (i = 0; i &lt; m_accounts.Length(); ++i)</span>
<a href="#l3.2084"></a><span id="l3.2084" class="difflineminus">-  {</span>
<a href="#l3.2085"></a><span id="l3.2085" class="difflineplus">+  for (i = 0; i &lt; m_accounts.Length(); ++i) {</span>
<a href="#l3.2086"></a><span id="l3.2086">     nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l3.2087"></a><span id="l3.2087">     rv = m_accounts[i]-&gt;GetIncomingServer(getter_AddRefs(server));</span>
<a href="#l3.2088"></a><span id="l3.2088" class="difflineminus">-    if (!server || NS_FAILED(rv))</span>
<a href="#l3.2089"></a><span id="l3.2089" class="difflineminus">-      continue;</span>
<a href="#l3.2090"></a><span id="l3.2090" class="difflineplus">+    if (!server || NS_FAILED(rv)) continue;</span>
<a href="#l3.2091"></a><span id="l3.2091"> </span>
<a href="#l3.2092"></a><span id="l3.2092">     nsCString serverKey;</span>
<a href="#l3.2093"></a><span id="l3.2093">     rv = server-&gt;GetKey(serverKey);</span>
<a href="#l3.2094"></a><span id="l3.2094" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l3.2095"></a><span id="l3.2095" class="difflineminus">-      continue;</span>
<a href="#l3.2096"></a><span id="l3.2096" class="difflineplus">+    if (NS_FAILED(rv)) continue;</span>
<a href="#l3.2097"></a><span id="l3.2097"> </span>
<a href="#l3.2098"></a><span id="l3.2098">     // stop when found,</span>
<a href="#l3.2099"></a><span id="l3.2099">     // index will be set to the current index</span>
<a href="#l3.2100"></a><span id="l3.2100" class="difflineminus">-    if (serverKey.Equals(key))</span>
<a href="#l3.2101"></a><span id="l3.2101" class="difflineminus">-      break;</span>
<a href="#l3.2102"></a><span id="l3.2102" class="difflineplus">+    if (serverKey.Equals(key)) break;</span>
<a href="#l3.2103"></a><span id="l3.2103">   }</span>
<a href="#l3.2104"></a><span id="l3.2104"> </span>
<a href="#l3.2105"></a><span id="l3.2105">   // Even if the search failed, we can return index.</span>
<a href="#l3.2106"></a><span id="l3.2106">   // This means that all servers not in the array return an index higher</span>
<a href="#l3.2107"></a><span id="l3.2107">   // than all &quot;registered&quot; servers.</span>
<a href="#l3.2108"></a><span id="l3.2108">   *result = i;</span>
<a href="#l3.2109"></a><span id="l3.2109">   return NS_OK;</span>
<a href="#l3.2110"></a><span id="l3.2110"> }</span>
<a href="#l3.2111"></a><span id="l3.2111"> </span>
<a href="#l3.2112"></a><span id="l3.2112" class="difflineminus">-NS_IMETHODIMP nsMsgAccountManager::AddIncomingServerListener(nsIIncomingServerListener *serverListener)</span>
<a href="#l3.2113"></a><span id="l3.2113" class="difflineminus">-{</span>
<a href="#l3.2114"></a><span id="l3.2114" class="difflineplus">+NS_IMETHODIMP nsMsgAccountManager::AddIncomingServerListener(</span>
<a href="#l3.2115"></a><span id="l3.2115" class="difflineplus">+    nsIIncomingServerListener *serverListener) {</span>
<a href="#l3.2116"></a><span id="l3.2116">   m_incomingServerListeners.AppendObject(serverListener);</span>
<a href="#l3.2117"></a><span id="l3.2117">   return NS_OK;</span>
<a href="#l3.2118"></a><span id="l3.2118"> }</span>
<a href="#l3.2119"></a><span id="l3.2119"> </span>
<a href="#l3.2120"></a><span id="l3.2120" class="difflineminus">-NS_IMETHODIMP nsMsgAccountManager::RemoveIncomingServerListener(nsIIncomingServerListener *serverListener)</span>
<a href="#l3.2121"></a><span id="l3.2121" class="difflineminus">-{</span>
<a href="#l3.2122"></a><span id="l3.2122" class="difflineplus">+NS_IMETHODIMP nsMsgAccountManager::RemoveIncomingServerListener(</span>
<a href="#l3.2123"></a><span id="l3.2123" class="difflineplus">+    nsIIncomingServerListener *serverListener) {</span>
<a href="#l3.2124"></a><span id="l3.2124">   m_incomingServerListeners.RemoveObject(serverListener);</span>
<a href="#l3.2125"></a><span id="l3.2125">   return NS_OK;</span>
<a href="#l3.2126"></a><span id="l3.2126"> }</span>
<a href="#l3.2127"></a><span id="l3.2127"> </span>
<a href="#l3.2128"></a><span id="l3.2128" class="difflineminus">-NS_IMETHODIMP nsMsgAccountManager::NotifyServerLoaded(nsIMsgIncomingServer *server)</span>
<a href="#l3.2129"></a><span id="l3.2129" class="difflineminus">-{</span>
<a href="#l3.2130"></a><span id="l3.2130" class="difflineplus">+NS_IMETHODIMP nsMsgAccountManager::NotifyServerLoaded(</span>
<a href="#l3.2131"></a><span id="l3.2131" class="difflineplus">+    nsIMsgIncomingServer *server) {</span>
<a href="#l3.2132"></a><span id="l3.2132">   int32_t count = m_incomingServerListeners.Count();</span>
<a href="#l3.2133"></a><span id="l3.2133" class="difflineminus">-  for(int32_t i = 0; i &lt; count; i++)</span>
<a href="#l3.2134"></a><span id="l3.2134" class="difflineminus">-  {</span>
<a href="#l3.2135"></a><span id="l3.2135" class="difflineminus">-    nsIIncomingServerListener* listener = m_incomingServerListeners[i];</span>
<a href="#l3.2136"></a><span id="l3.2136" class="difflineplus">+  for (int32_t i = 0; i &lt; count; i++) {</span>
<a href="#l3.2137"></a><span id="l3.2137" class="difflineplus">+    nsIIncomingServerListener *listener = m_incomingServerListeners[i];</span>
<a href="#l3.2138"></a><span id="l3.2138">     listener-&gt;OnServerLoaded(server);</span>
<a href="#l3.2139"></a><span id="l3.2139">   }</span>
<a href="#l3.2140"></a><span id="l3.2140"> </span>
<a href="#l3.2141"></a><span id="l3.2141">   return NS_OK;</span>
<a href="#l3.2142"></a><span id="l3.2142"> }</span>
<a href="#l3.2143"></a><span id="l3.2143"> </span>
<a href="#l3.2144"></a><span id="l3.2144" class="difflineminus">-NS_IMETHODIMP nsMsgAccountManager::NotifyServerUnloaded(nsIMsgIncomingServer *server)</span>
<a href="#l3.2145"></a><span id="l3.2145" class="difflineminus">-{</span>
<a href="#l3.2146"></a><span id="l3.2146" class="difflineplus">+NS_IMETHODIMP nsMsgAccountManager::NotifyServerUnloaded(</span>
<a href="#l3.2147"></a><span id="l3.2147" class="difflineplus">+    nsIMsgIncomingServer *server) {</span>
<a href="#l3.2148"></a><span id="l3.2148">   NS_ENSURE_ARG_POINTER(server);</span>
<a href="#l3.2149"></a><span id="l3.2149"> </span>
<a href="#l3.2150"></a><span id="l3.2150">   int32_t count = m_incomingServerListeners.Count();</span>
<a href="#l3.2151"></a><span id="l3.2151" class="difflineminus">-  server-&gt;SetFilterList(nullptr); // clear this to cut shutdown leaks. we are always passing valid non-null server here.</span>
<a href="#l3.2152"></a><span id="l3.2152" class="difflineminus">-</span>
<a href="#l3.2153"></a><span id="l3.2153" class="difflineminus">-  for(int32_t i = 0; i &lt; count; i++)</span>
<a href="#l3.2154"></a><span id="l3.2154" class="difflineminus">-  {</span>
<a href="#l3.2155"></a><span id="l3.2155" class="difflineminus">-    nsIIncomingServerListener* listener = m_incomingServerListeners[i];</span>
<a href="#l3.2156"></a><span id="l3.2156" class="difflineplus">+  // Clear this to cut shutdown leaks. We are always passing valid non-null</span>
<a href="#l3.2157"></a><span id="l3.2157" class="difflineplus">+  // server here.</span>
<a href="#l3.2158"></a><span id="l3.2158" class="difflineplus">+  server-&gt;SetFilterList(nullptr);</span>
<a href="#l3.2159"></a><span id="l3.2159" class="difflineplus">+</span>
<a href="#l3.2160"></a><span id="l3.2160" class="difflineplus">+  for (int32_t i = 0; i &lt; count; i++) {</span>
<a href="#l3.2161"></a><span id="l3.2161" class="difflineplus">+    nsIIncomingServerListener *listener = m_incomingServerListeners[i];</span>
<a href="#l3.2162"></a><span id="l3.2162">     listener-&gt;OnServerUnloaded(server);</span>
<a href="#l3.2163"></a><span id="l3.2163">   }</span>
<a href="#l3.2164"></a><span id="l3.2164"> </span>
<a href="#l3.2165"></a><span id="l3.2165">   return NS_OK;</span>
<a href="#l3.2166"></a><span id="l3.2166"> }</span>
<a href="#l3.2167"></a><span id="l3.2167"> </span>
<a href="#l3.2168"></a><span id="l3.2168" class="difflineminus">-NS_IMETHODIMP nsMsgAccountManager::NotifyServerChanged(nsIMsgIncomingServer *server)</span>
<a href="#l3.2169"></a><span id="l3.2169" class="difflineminus">-{</span>
<a href="#l3.2170"></a><span id="l3.2170" class="difflineplus">+NS_IMETHODIMP nsMsgAccountManager::NotifyServerChanged(</span>
<a href="#l3.2171"></a><span id="l3.2171" class="difflineplus">+    nsIMsgIncomingServer *server) {</span>
<a href="#l3.2172"></a><span id="l3.2172">   int32_t count = m_incomingServerListeners.Count();</span>
<a href="#l3.2173"></a><span id="l3.2173" class="difflineminus">-  for(int32_t i = 0; i &lt; count; i++)</span>
<a href="#l3.2174"></a><span id="l3.2174" class="difflineminus">-  {</span>
<a href="#l3.2175"></a><span id="l3.2175" class="difflineminus">-    nsIIncomingServerListener* listener = m_incomingServerListeners[i];</span>
<a href="#l3.2176"></a><span id="l3.2176" class="difflineplus">+  for (int32_t i = 0; i &lt; count; i++) {</span>
<a href="#l3.2177"></a><span id="l3.2177" class="difflineplus">+    nsIIncomingServerListener *listener = m_incomingServerListeners[i];</span>
<a href="#l3.2178"></a><span id="l3.2178">     listener-&gt;OnServerChanged(server);</span>
<a href="#l3.2179"></a><span id="l3.2179">   }</span>
<a href="#l3.2180"></a><span id="l3.2180"> </span>
<a href="#l3.2181"></a><span id="l3.2181">   return NS_OK;</span>
<a href="#l3.2182"></a><span id="l3.2182"> }</span>
<a href="#l3.2183"></a><span id="l3.2183"> </span>
<a href="#l3.2184"></a><span id="l3.2184"> NS_IMETHODIMP</span>
<a href="#l3.2185"></a><span id="l3.2185"> nsMsgAccountManager::FindServerByURI(nsIURI *aURI, bool aRealFlag,</span>
<a href="#l3.2186"></a><span id="l3.2186" class="difflineminus">-                                nsIMsgIncomingServer** aResult)</span>
<a href="#l3.2187"></a><span id="l3.2187" class="difflineminus">-{</span>
<a href="#l3.2188"></a><span id="l3.2188" class="difflineplus">+                                     nsIMsgIncomingServer **aResult) {</span>
<a href="#l3.2189"></a><span id="l3.2189">   NS_ENSURE_ARG_POINTER(aURI);</span>
<a href="#l3.2190"></a><span id="l3.2190"> </span>
<a href="#l3.2191"></a><span id="l3.2191">   nsresult rv = LoadAccounts();</span>
<a href="#l3.2192"></a><span id="l3.2192">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.2193"></a><span id="l3.2193"> </span>
<a href="#l3.2194"></a><span id="l3.2194">   // Get username and hostname and port so we can get the server</span>
<a href="#l3.2195"></a><span id="l3.2195">   nsAutoCString username;</span>
<a href="#l3.2196"></a><span id="l3.2196">   nsAutoCString escapedUsername;</span>
<a href="#l3.2197"></a><span id="l3.2197">   rv = aURI-&gt;GetUserPass(escapedUsername);</span>
<a href="#l3.2198"></a><span id="l3.2198">   if (NS_SUCCEEDED(rv) &amp;&amp; !escapedUsername.IsEmpty())</span>
<a href="#l3.2199"></a><span id="l3.2199" class="difflineminus">-    MsgUnescapeString(escapedUsername, 0,  username);</span>
<a href="#l3.2200"></a><span id="l3.2200" class="difflineplus">+    MsgUnescapeString(escapedUsername, 0, username);</span>
<a href="#l3.2201"></a><span id="l3.2201"> </span>
<a href="#l3.2202"></a><span id="l3.2202">   nsAutoCString hostname;</span>
<a href="#l3.2203"></a><span id="l3.2203">   nsAutoCString escapedHostname;</span>
<a href="#l3.2204"></a><span id="l3.2204">   rv = aURI-&gt;GetHost(escapedHostname);</span>
<a href="#l3.2205"></a><span id="l3.2205">   if (NS_SUCCEEDED(rv) &amp;&amp; !escapedHostname.IsEmpty())</span>
<a href="#l3.2206"></a><span id="l3.2206">     MsgUnescapeString(escapedHostname, 0, hostname);</span>
<a href="#l3.2207"></a><span id="l3.2207"> </span>
<a href="#l3.2208"></a><span id="l3.2208">   nsAutoCString type;</span>
<a href="#l3.2209"></a><span id="l3.2209">   rv = aURI-&gt;GetScheme(type);</span>
<a href="#l3.2210"></a><span id="l3.2210" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; !type.IsEmpty())</span>
<a href="#l3.2211"></a><span id="l3.2211" class="difflineminus">-  {</span>
<a href="#l3.2212"></a><span id="l3.2212" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; !type.IsEmpty()) {</span>
<a href="#l3.2213"></a><span id="l3.2213">     // now modify type if pop or news</span>
<a href="#l3.2214"></a><span id="l3.2214" class="difflineminus">-    if (type.EqualsLiteral(&quot;pop&quot;))</span>
<a href="#l3.2215"></a><span id="l3.2215" class="difflineminus">-      type.AssignLiteral(&quot;pop3&quot;);</span>
<a href="#l3.2216"></a><span id="l3.2216" class="difflineplus">+    if (type.EqualsLiteral(&quot;pop&quot;)) type.AssignLiteral(&quot;pop3&quot;);</span>
<a href="#l3.2217"></a><span id="l3.2217">     // we use &quot;nntp&quot; in the server list so translate it here.</span>
<a href="#l3.2218"></a><span id="l3.2218">     else if (type.EqualsLiteral(&quot;news&quot;))</span>
<a href="#l3.2219"></a><span id="l3.2219">       type.AssignLiteral(&quot;nntp&quot;);</span>
<a href="#l3.2220"></a><span id="l3.2220">     // we use &quot;any&quot; as the wildcard type.</span>
<a href="#l3.2221"></a><span id="l3.2221">     else if (type.EqualsLiteral(&quot;any&quot;))</span>
<a href="#l3.2222"></a><span id="l3.2222">       type.Truncate();</span>
<a href="#l3.2223"></a><span id="l3.2223">   }</span>
<a href="#l3.2224"></a><span id="l3.2224"> </span>
<a href="#l3.2225"></a><span id="l3.2225">   int32_t port = 0;</span>
<a href="#l3.2226"></a><span id="l3.2226">   // check the port of the scheme is not 'none' or blank</span>
<a href="#l3.2227"></a><span id="l3.2227" class="difflineminus">-  if (!(type.EqualsLiteral(&quot;none&quot;) || type.IsEmpty()))</span>
<a href="#l3.2228"></a><span id="l3.2228" class="difflineminus">-  {</span>
<a href="#l3.2229"></a><span id="l3.2229" class="difflineplus">+  if (!(type.EqualsLiteral(&quot;none&quot;) || type.IsEmpty())) {</span>
<a href="#l3.2230"></a><span id="l3.2230">     rv = aURI-&gt;GetPort(&amp;port);</span>
<a href="#l3.2231"></a><span id="l3.2231">     // Set the port to zero if we got a -1 (use default)</span>
<a href="#l3.2232"></a><span id="l3.2232" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; (port == -1))</span>
<a href="#l3.2233"></a><span id="l3.2233" class="difflineminus">-      port = 0;</span>
<a href="#l3.2234"></a><span id="l3.2234" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; (port == -1)) port = 0;</span>
<a href="#l3.2235"></a><span id="l3.2235">   }</span>
<a href="#l3.2236"></a><span id="l3.2236"> </span>
<a href="#l3.2237"></a><span id="l3.2237">   return findServerInternal(username, hostname, type, port, aRealFlag, aResult);</span>
<a href="#l3.2238"></a><span id="l3.2238"> }</span>
<a href="#l3.2239"></a><span id="l3.2239"> </span>
<a href="#l3.2240"></a><span id="l3.2240" class="difflineminus">-nsresult</span>
<a href="#l3.2241"></a><span id="l3.2241" class="difflineminus">-nsMsgAccountManager::findServerInternal(const nsACString&amp; username,</span>
<a href="#l3.2242"></a><span id="l3.2242" class="difflineminus">-                                        const nsACString&amp; hostname,</span>
<a href="#l3.2243"></a><span id="l3.2243" class="difflineminus">-                                        const nsACString&amp; type,</span>
<a href="#l3.2244"></a><span id="l3.2244" class="difflineminus">-                                        int32_t port,</span>
<a href="#l3.2245"></a><span id="l3.2245" class="difflineminus">-                                        bool aRealFlag,</span>
<a href="#l3.2246"></a><span id="l3.2246" class="difflineminus">-                                        nsIMsgIncomingServer** aResult)</span>
<a href="#l3.2247"></a><span id="l3.2247" class="difflineminus">-{</span>
<a href="#l3.2248"></a><span id="l3.2248" class="difflineplus">+nsresult nsMsgAccountManager::findServerInternal(</span>
<a href="#l3.2249"></a><span id="l3.2249" class="difflineplus">+    const nsACString &amp;username, const nsACString &amp;hostname,</span>
<a href="#l3.2250"></a><span id="l3.2250" class="difflineplus">+    const nsACString &amp;type, int32_t port, bool aRealFlag,</span>
<a href="#l3.2251"></a><span id="l3.2251" class="difflineplus">+    nsIMsgIncomingServer **aResult) {</span>
<a href="#l3.2252"></a><span id="l3.2252">   // If 'aRealFlag' is set then we want to scan all existing accounts</span>
<a href="#l3.2253"></a><span id="l3.2253">   // to make sure there's no duplicate including those whose host and/or</span>
<a href="#l3.2254"></a><span id="l3.2254">   // user names have been changed.</span>
<a href="#l3.2255"></a><span id="l3.2255" class="difflineminus">-  if (!aRealFlag &amp;&amp;</span>
<a href="#l3.2256"></a><span id="l3.2256" class="difflineminus">-      (m_lastFindServerUserName.Equals(username)) &amp;&amp;</span>
<a href="#l3.2257"></a><span id="l3.2257" class="difflineplus">+  if (!aRealFlag &amp;&amp; (m_lastFindServerUserName.Equals(username)) &amp;&amp;</span>
<a href="#l3.2258"></a><span id="l3.2258">       (m_lastFindServerHostName.Equals(hostname)) &amp;&amp;</span>
<a href="#l3.2259"></a><span id="l3.2259" class="difflineminus">-      (m_lastFindServerType.Equals(type)) &amp;&amp;</span>
<a href="#l3.2260"></a><span id="l3.2260" class="difflineminus">-      (m_lastFindServerPort == port) &amp;&amp;</span>
<a href="#l3.2261"></a><span id="l3.2261" class="difflineminus">-      m_lastFindServerResult)</span>
<a href="#l3.2262"></a><span id="l3.2262" class="difflineminus">-  {</span>
<a href="#l3.2263"></a><span id="l3.2263" class="difflineplus">+      (m_lastFindServerType.Equals(type)) &amp;&amp; (m_lastFindServerPort == port) &amp;&amp;</span>
<a href="#l3.2264"></a><span id="l3.2264" class="difflineplus">+      m_lastFindServerResult) {</span>
<a href="#l3.2265"></a><span id="l3.2265">     NS_ADDREF(*aResult = m_lastFindServerResult);</span>
<a href="#l3.2266"></a><span id="l3.2266">     return NS_OK;</span>
<a href="#l3.2267"></a><span id="l3.2267">   }</span>
<a href="#l3.2268"></a><span id="l3.2268"> </span>
<a href="#l3.2269"></a><span id="l3.2269">   for (auto iter = m_incomingServers.Iter(); !iter.Done(); iter.Next()) {</span>
<a href="#l3.2270"></a><span id="l3.2270">     // Find matching server by user+host+type+port.</span>
<a href="#l3.2271"></a><span id="l3.2271" class="difflineminus">-    nsCOMPtr&lt;nsIMsgIncomingServer&gt;&amp; server = iter.Data();</span>
<a href="#l3.2272"></a><span id="l3.2272" class="difflineminus">-</span>
<a href="#l3.2273"></a><span id="l3.2273" class="difflineminus">-    if (!server)</span>
<a href="#l3.2274"></a><span id="l3.2274" class="difflineminus">-      continue;</span>
<a href="#l3.2275"></a><span id="l3.2275" class="difflineplus">+    nsCOMPtr&lt;nsIMsgIncomingServer&gt; &amp;server = iter.Data();</span>
<a href="#l3.2276"></a><span id="l3.2276" class="difflineplus">+</span>
<a href="#l3.2277"></a><span id="l3.2277" class="difflineplus">+    if (!server) continue;</span>
<a href="#l3.2278"></a><span id="l3.2278"> </span>
<a href="#l3.2279"></a><span id="l3.2279">     nsresult rv;</span>
<a href="#l3.2280"></a><span id="l3.2280">     nsCString thisHostname;</span>
<a href="#l3.2281"></a><span id="l3.2281">     if (aRealFlag)</span>
<a href="#l3.2282"></a><span id="l3.2282">       rv = server-&gt;GetRealHostName(thisHostname);</span>
<a href="#l3.2283"></a><span id="l3.2283">     else</span>
<a href="#l3.2284"></a><span id="l3.2284">       rv = server-&gt;GetHostName(thisHostname);</span>
<a href="#l3.2285"></a><span id="l3.2285" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l3.2286"></a><span id="l3.2286" class="difflineminus">-      continue;</span>
<a href="#l3.2287"></a><span id="l3.2287" class="difflineplus">+    if (NS_FAILED(rv)) continue;</span>
<a href="#l3.2288"></a><span id="l3.2288"> </span>
<a href="#l3.2289"></a><span id="l3.2289">     nsCString thisUsername;</span>
<a href="#l3.2290"></a><span id="l3.2290">     if (aRealFlag)</span>
<a href="#l3.2291"></a><span id="l3.2291">       rv = server-&gt;GetRealUsername(thisUsername);</span>
<a href="#l3.2292"></a><span id="l3.2292">     else</span>
<a href="#l3.2293"></a><span id="l3.2293">       rv = server-&gt;GetUsername(thisUsername);</span>
<a href="#l3.2294"></a><span id="l3.2294" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l3.2295"></a><span id="l3.2295" class="difflineminus">-      continue;</span>
<a href="#l3.2296"></a><span id="l3.2296" class="difflineplus">+    if (NS_FAILED(rv)) continue;</span>
<a href="#l3.2297"></a><span id="l3.2297"> </span>
<a href="#l3.2298"></a><span id="l3.2298">     nsCString thisType;</span>
<a href="#l3.2299"></a><span id="l3.2299">     rv = server-&gt;GetType(thisType);</span>
<a href="#l3.2300"></a><span id="l3.2300" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l3.2301"></a><span id="l3.2301" class="difflineminus">-      continue;</span>
<a href="#l3.2302"></a><span id="l3.2302" class="difflineminus">-</span>
<a href="#l3.2303"></a><span id="l3.2303" class="difflineminus">-    int32_t thisPort = -1; // use the default port identifier</span>
<a href="#l3.2304"></a><span id="l3.2304" class="difflineplus">+    if (NS_FAILED(rv)) continue;</span>
<a href="#l3.2305"></a><span id="l3.2305" class="difflineplus">+</span>
<a href="#l3.2306"></a><span id="l3.2306" class="difflineplus">+    int32_t thisPort = -1;  // use the default port identifier</span>
<a href="#l3.2307"></a><span id="l3.2307">     // Don't try and get a port for the 'none' scheme</span>
<a href="#l3.2308"></a><span id="l3.2308" class="difflineminus">-    if (!thisType.EqualsLiteral(&quot;none&quot;))</span>
<a href="#l3.2309"></a><span id="l3.2309" class="difflineminus">-    {</span>
<a href="#l3.2310"></a><span id="l3.2310" class="difflineplus">+    if (!thisType.EqualsLiteral(&quot;none&quot;)) {</span>
<a href="#l3.2311"></a><span id="l3.2311">       rv = server-&gt;GetPort(&amp;thisPort);</span>
<a href="#l3.2312"></a><span id="l3.2312">       if (NS_FAILED(rv)) {</span>
<a href="#l3.2313"></a><span id="l3.2313">         continue;</span>
<a href="#l3.2314"></a><span id="l3.2314">       }</span>
<a href="#l3.2315"></a><span id="l3.2315">     }</span>
<a href="#l3.2316"></a><span id="l3.2316"> </span>
<a href="#l3.2317"></a><span id="l3.2317" class="difflineminus">-    // treat &quot;&quot; as a wild card, so if the caller passed in &quot;&quot; for the desired attribute</span>
<a href="#l3.2318"></a><span id="l3.2318" class="difflineminus">-    // treat it as a match</span>
<a href="#l3.2319"></a><span id="l3.2319" class="difflineplus">+    // treat &quot;&quot; as a wild card, so if the caller passed in &quot;&quot; for the desired</span>
<a href="#l3.2320"></a><span id="l3.2320" class="difflineplus">+    // attribute treat it as a match</span>
<a href="#l3.2321"></a><span id="l3.2321">     if ((type.IsEmpty() || thisType.Equals(type)) &amp;&amp;</span>
<a href="#l3.2322"></a><span id="l3.2322" class="difflineminus">-        (hostname.IsEmpty() || thisHostname.Equals(hostname, nsCaseInsensitiveCStringComparator())) &amp;&amp;</span>
<a href="#l3.2323"></a><span id="l3.2323" class="difflineplus">+        (hostname.IsEmpty() ||</span>
<a href="#l3.2324"></a><span id="l3.2324" class="difflineplus">+         thisHostname.Equals(hostname, nsCaseInsensitiveCStringComparator())) &amp;&amp;</span>
<a href="#l3.2325"></a><span id="l3.2325">         (!(port != 0) || (port == thisPort)) &amp;&amp;</span>
<a href="#l3.2326"></a><span id="l3.2326" class="difflineminus">-        (username.IsEmpty() || thisUsername.Equals(username)))</span>
<a href="#l3.2327"></a><span id="l3.2327" class="difflineminus">-    {</span>
<a href="#l3.2328"></a><span id="l3.2328" class="difflineplus">+        (username.IsEmpty() || thisUsername.Equals(username))) {</span>
<a href="#l3.2329"></a><span id="l3.2329">       // stop on first find; cache for next time</span>
<a href="#l3.2330"></a><span id="l3.2330">       if (!aRealFlag)</span>
<a href="#l3.2331"></a><span id="l3.2331">         SetLastServerFound(server, hostname, username, port, type);</span>
<a href="#l3.2332"></a><span id="l3.2332"> </span>
<a href="#l3.2333"></a><span id="l3.2333">       NS_ADDREF(*aResult = server);  // Was populated from member variable.</span>
<a href="#l3.2334"></a><span id="l3.2334">       return NS_OK;</span>
<a href="#l3.2335"></a><span id="l3.2335">     }</span>
<a href="#l3.2336"></a><span id="l3.2336">   }</span>
<a href="#l3.2337"></a><span id="l3.2337"> </span>
<a href="#l3.2338"></a><span id="l3.2338">   return NS_ERROR_UNEXPECTED;</span>
<a href="#l3.2339"></a><span id="l3.2339"> }</span>
<a href="#l3.2340"></a><span id="l3.2340"> </span>
<a href="#l3.2341"></a><span id="l3.2341"> NS_IMETHODIMP</span>
<a href="#l3.2342"></a><span id="l3.2342" class="difflineminus">-nsMsgAccountManager::FindServer(const nsACString&amp; username,</span>
<a href="#l3.2343"></a><span id="l3.2343" class="difflineminus">-                                const nsACString&amp; hostname,</span>
<a href="#l3.2344"></a><span id="l3.2344" class="difflineminus">-                                const nsACString&amp; type,</span>
<a href="#l3.2345"></a><span id="l3.2345" class="difflineminus">-                                nsIMsgIncomingServer** aResult)</span>
<a href="#l3.2346"></a><span id="l3.2346" class="difflineminus">-{</span>
<a href="#l3.2347"></a><span id="l3.2347" class="difflineplus">+nsMsgAccountManager::FindServer(const nsACString &amp;username,</span>
<a href="#l3.2348"></a><span id="l3.2348" class="difflineplus">+                                const nsACString &amp;hostname,</span>
<a href="#l3.2349"></a><span id="l3.2349" class="difflineplus">+                                const nsACString &amp;type,</span>
<a href="#l3.2350"></a><span id="l3.2350" class="difflineplus">+                                nsIMsgIncomingServer **aResult) {</span>
<a href="#l3.2351"></a><span id="l3.2351">   return findServerInternal(username, hostname, type, 0, false, aResult);</span>
<a href="#l3.2352"></a><span id="l3.2352"> }</span>
<a href="#l3.2353"></a><span id="l3.2353"> </span>
<a href="#l3.2354"></a><span id="l3.2354"> // Interface called by UI js only (always return true).</span>
<a href="#l3.2355"></a><span id="l3.2355"> NS_IMETHODIMP</span>
<a href="#l3.2356"></a><span id="l3.2356" class="difflineminus">-nsMsgAccountManager::FindRealServer(const nsACString&amp; username,</span>
<a href="#l3.2357"></a><span id="l3.2357" class="difflineminus">-                                    const nsACString&amp; hostname,</span>
<a href="#l3.2358"></a><span id="l3.2358" class="difflineminus">-                                    const nsACString&amp; type,</span>
<a href="#l3.2359"></a><span id="l3.2359" class="difflineminus">-                                    int32_t port,</span>
<a href="#l3.2360"></a><span id="l3.2360" class="difflineminus">-                                    nsIMsgIncomingServer** aResult)</span>
<a href="#l3.2361"></a><span id="l3.2361" class="difflineminus">-{</span>
<a href="#l3.2362"></a><span id="l3.2362" class="difflineplus">+nsMsgAccountManager::FindRealServer(const nsACString &amp;username,</span>
<a href="#l3.2363"></a><span id="l3.2363" class="difflineplus">+                                    const nsACString &amp;hostname,</span>
<a href="#l3.2364"></a><span id="l3.2364" class="difflineplus">+                                    const nsACString &amp;type, int32_t port,</span>
<a href="#l3.2365"></a><span id="l3.2365" class="difflineplus">+                                    nsIMsgIncomingServer **aResult) {</span>
<a href="#l3.2366"></a><span id="l3.2366">   *aResult = nullptr;</span>
<a href="#l3.2367"></a><span id="l3.2367">   findServerInternal(username, hostname, type, port, true, aResult);</span>
<a href="#l3.2368"></a><span id="l3.2368">   return NS_OK;</span>
<a href="#l3.2369"></a><span id="l3.2369"> }</span>
<a href="#l3.2370"></a><span id="l3.2370"> </span>
<a href="#l3.2371"></a><span id="l3.2371" class="difflineminus">-void</span>
<a href="#l3.2372"></a><span id="l3.2372" class="difflineminus">-nsMsgAccountManager::findAccountByServerKey(const nsCString &amp;aKey,</span>
<a href="#l3.2373"></a><span id="l3.2373" class="difflineminus">-                                            nsIMsgAccount **aResult)</span>
<a href="#l3.2374"></a><span id="l3.2374" class="difflineminus">-{</span>
<a href="#l3.2375"></a><span id="l3.2375" class="difflineplus">+void nsMsgAccountManager::findAccountByServerKey(const nsCString &amp;aKey,</span>
<a href="#l3.2376"></a><span id="l3.2376" class="difflineplus">+                                                 nsIMsgAccount **aResult) {</span>
<a href="#l3.2377"></a><span id="l3.2377">   *aResult = nullptr;</span>
<a href="#l3.2378"></a><span id="l3.2378"> </span>
<a href="#l3.2379"></a><span id="l3.2379" class="difflineminus">-  for (uint32_t i = 0; i &lt; m_accounts.Length(); ++i)</span>
<a href="#l3.2380"></a><span id="l3.2380" class="difflineminus">-  {</span>
<a href="#l3.2381"></a><span id="l3.2381" class="difflineplus">+  for (uint32_t i = 0; i &lt; m_accounts.Length(); ++i) {</span>
<a href="#l3.2382"></a><span id="l3.2382">     nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l3.2383"></a><span id="l3.2383">     nsresult rv = m_accounts[i]-&gt;GetIncomingServer(getter_AddRefs(server));</span>
<a href="#l3.2384"></a><span id="l3.2384" class="difflineminus">-    if (!server || NS_FAILED(rv))</span>
<a href="#l3.2385"></a><span id="l3.2385" class="difflineminus">-      continue;</span>
<a href="#l3.2386"></a><span id="l3.2386" class="difflineplus">+    if (!server || NS_FAILED(rv)) continue;</span>
<a href="#l3.2387"></a><span id="l3.2387"> </span>
<a href="#l3.2388"></a><span id="l3.2388">     nsCString key;</span>
<a href="#l3.2389"></a><span id="l3.2389">     rv = server-&gt;GetKey(key);</span>
<a href="#l3.2390"></a><span id="l3.2390" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l3.2391"></a><span id="l3.2391" class="difflineminus">-      continue;</span>
<a href="#l3.2392"></a><span id="l3.2392" class="difflineplus">+    if (NS_FAILED(rv)) continue;</span>
<a href="#l3.2393"></a><span id="l3.2393"> </span>
<a href="#l3.2394"></a><span id="l3.2394">     // if the keys are equal, the servers are equal</span>
<a href="#l3.2395"></a><span id="l3.2395" class="difflineminus">-    if (key.Equals(aKey))</span>
<a href="#l3.2396"></a><span id="l3.2396" class="difflineminus">-    {</span>
<a href="#l3.2397"></a><span id="l3.2397" class="difflineplus">+    if (key.Equals(aKey)) {</span>
<a href="#l3.2398"></a><span id="l3.2398">       NS_ADDREF(*aResult = m_accounts[i]);</span>
<a href="#l3.2399"></a><span id="l3.2399" class="difflineminus">-      break; // stop on first found account</span>
<a href="#l3.2400"></a><span id="l3.2400" class="difflineplus">+      break;  // stop on first found account</span>
<a href="#l3.2401"></a><span id="l3.2401">     }</span>
<a href="#l3.2402"></a><span id="l3.2402">   }</span>
<a href="#l3.2403"></a><span id="l3.2403"> }</span>
<a href="#l3.2404"></a><span id="l3.2404"> </span>
<a href="#l3.2405"></a><span id="l3.2405"> NS_IMETHODIMP</span>
<a href="#l3.2406"></a><span id="l3.2406"> nsMsgAccountManager::FindAccountForServer(nsIMsgIncomingServer *server,</span>
<a href="#l3.2407"></a><span id="l3.2407" class="difflineminus">-                                            nsIMsgAccount **aResult)</span>
<a href="#l3.2408"></a><span id="l3.2408" class="difflineminus">-{</span>
<a href="#l3.2409"></a><span id="l3.2409" class="difflineplus">+                                          nsIMsgAccount **aResult) {</span>
<a href="#l3.2410"></a><span id="l3.2410">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l3.2411"></a><span id="l3.2411"> </span>
<a href="#l3.2412"></a><span id="l3.2412" class="difflineminus">-  if (!server)</span>
<a href="#l3.2413"></a><span id="l3.2413" class="difflineminus">-  {</span>
<a href="#l3.2414"></a><span id="l3.2414" class="difflineplus">+  if (!server) {</span>
<a href="#l3.2415"></a><span id="l3.2415">     (*aResult) = nullptr;</span>
<a href="#l3.2416"></a><span id="l3.2416">     return NS_OK;</span>
<a href="#l3.2417"></a><span id="l3.2417">   }</span>
<a href="#l3.2418"></a><span id="l3.2418"> </span>
<a href="#l3.2419"></a><span id="l3.2419">   nsresult rv;</span>
<a href="#l3.2420"></a><span id="l3.2420"> </span>
<a href="#l3.2421"></a><span id="l3.2421">   nsCString key;</span>
<a href="#l3.2422"></a><span id="l3.2422">   rv = server-&gt;GetKey(key);</span>
<a href="#l3.2423"></a><span id="l3.2423">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.2424"></a><span id="l3.2424"> </span>
<a href="#l3.2425"></a><span id="l3.2425">   findAccountByServerKey(key, aResult);</span>
<a href="#l3.2426"></a><span id="l3.2426">   return NS_OK;</span>
<a href="#l3.2427"></a><span id="l3.2427"> }</span>
<a href="#l3.2428"></a><span id="l3.2428"> </span>
<a href="#l3.2429"></a><span id="l3.2429"> NS_IMETHODIMP</span>
<a href="#l3.2430"></a><span id="l3.2430" class="difflineminus">-nsMsgAccountManager::GetFirstIdentityForServer(nsIMsgIncomingServer *aServer, nsIMsgIdentity **aIdentity)</span>
<a href="#l3.2431"></a><span id="l3.2431" class="difflineminus">-{</span>
<a href="#l3.2432"></a><span id="l3.2432" class="difflineplus">+nsMsgAccountManager::GetFirstIdentityForServer(nsIMsgIncomingServer *aServer,</span>
<a href="#l3.2433"></a><span id="l3.2433" class="difflineplus">+                                               nsIMsgIdentity **aIdentity) {</span>
<a href="#l3.2434"></a><span id="l3.2434">   NS_ENSURE_ARG_POINTER(aServer);</span>
<a href="#l3.2435"></a><span id="l3.2435">   NS_ENSURE_ARG_POINTER(aIdentity);</span>
<a href="#l3.2436"></a><span id="l3.2436"> </span>
<a href="#l3.2437"></a><span id="l3.2437">   nsCOMPtr&lt;nsIArray&gt; identities;</span>
<a href="#l3.2438"></a><span id="l3.2438">   nsresult rv = GetIdentitiesForServer(aServer, getter_AddRefs(identities));</span>
<a href="#l3.2439"></a><span id="l3.2439">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.2440"></a><span id="l3.2440"> </span>
<a href="#l3.2441"></a><span id="l3.2441">   // not all servers have identities</span>
<a href="#l3.2442"></a><span id="l3.2442">   // for example, Local Folders</span>
<a href="#l3.2443"></a><span id="l3.2443">   uint32_t numIdentities;</span>
<a href="#l3.2444"></a><span id="l3.2444">   rv = identities-&gt;GetLength(&amp;numIdentities);</span>
<a href="#l3.2445"></a><span id="l3.2445">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.2446"></a><span id="l3.2446"> </span>
<a href="#l3.2447"></a><span id="l3.2447" class="difflineminus">-  if (numIdentities &gt; 0)</span>
<a href="#l3.2448"></a><span id="l3.2448" class="difflineminus">-  {</span>
<a href="#l3.2449"></a><span id="l3.2449" class="difflineplus">+  if (numIdentities &gt; 0) {</span>
<a href="#l3.2450"></a><span id="l3.2450">     nsCOMPtr&lt;nsIMsgIdentity&gt; identity(do_QueryElementAt(identities, 0, &amp;rv));</span>
<a href="#l3.2451"></a><span id="l3.2451">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.2452"></a><span id="l3.2452">     identity.forget(aIdentity);</span>
<a href="#l3.2453"></a><span id="l3.2453" class="difflineminus">-  }</span>
<a href="#l3.2454"></a><span id="l3.2454" class="difflineminus">-  else</span>
<a href="#l3.2455"></a><span id="l3.2455" class="difflineplus">+  } else</span>
<a href="#l3.2456"></a><span id="l3.2456">     *aIdentity = nullptr;</span>
<a href="#l3.2457"></a><span id="l3.2457">   return rv;</span>
<a href="#l3.2458"></a><span id="l3.2458"> }</span>
<a href="#l3.2459"></a><span id="l3.2459"> </span>
<a href="#l3.2460"></a><span id="l3.2460"> NS_IMETHODIMP</span>
<a href="#l3.2461"></a><span id="l3.2461"> nsMsgAccountManager::GetIdentitiesForServer(nsIMsgIncomingServer *server,</span>
<a href="#l3.2462"></a><span id="l3.2462" class="difflineminus">-                                            nsIArray **_retval)</span>
<a href="#l3.2463"></a><span id="l3.2463" class="difflineminus">-{</span>
<a href="#l3.2464"></a><span id="l3.2464" class="difflineplus">+                                            nsIArray **_retval) {</span>
<a href="#l3.2465"></a><span id="l3.2465">   NS_ENSURE_ARG_POINTER(server);</span>
<a href="#l3.2466"></a><span id="l3.2466">   NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l3.2467"></a><span id="l3.2467">   nsresult rv = LoadAccounts();</span>
<a href="#l3.2468"></a><span id="l3.2468">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.2469"></a><span id="l3.2469"> </span>
<a href="#l3.2470"></a><span id="l3.2470" class="difflineminus">-  nsCOMPtr&lt;nsIMutableArray&gt; identities(do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l3.2471"></a><span id="l3.2471" class="difflineplus">+  nsCOMPtr&lt;nsIMutableArray&gt; identities(</span>
<a href="#l3.2472"></a><span id="l3.2472" class="difflineplus">+      do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l3.2473"></a><span id="l3.2473">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.2474"></a><span id="l3.2474"> </span>
<a href="#l3.2475"></a><span id="l3.2475">   nsAutoCString serverKey;</span>
<a href="#l3.2476"></a><span id="l3.2476">   rv = server-&gt;GetKey(serverKey);</span>
<a href="#l3.2477"></a><span id="l3.2477">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.2478"></a><span id="l3.2478"> </span>
<a href="#l3.2479"></a><span id="l3.2479" class="difflineminus">-  for (uint32_t i = 0; i &lt; m_accounts.Length(); ++i)</span>
<a href="#l3.2480"></a><span id="l3.2480" class="difflineminus">-  {</span>
<a href="#l3.2481"></a><span id="l3.2481" class="difflineplus">+  for (uint32_t i = 0; i &lt; m_accounts.Length(); ++i) {</span>
<a href="#l3.2482"></a><span id="l3.2482">     nsCOMPtr&lt;nsIMsgAccount&gt; account(m_accounts[i]);</span>
<a href="#l3.2483"></a><span id="l3.2483"> </span>
<a href="#l3.2484"></a><span id="l3.2484">     nsCOMPtr&lt;nsIMsgIncomingServer&gt; thisServer;</span>
<a href="#l3.2485"></a><span id="l3.2485">     rv = account-&gt;GetIncomingServer(getter_AddRefs(thisServer));</span>
<a href="#l3.2486"></a><span id="l3.2486" class="difflineminus">-    if (NS_FAILED(rv) || !thisServer)</span>
<a href="#l3.2487"></a><span id="l3.2487" class="difflineminus">-      continue;</span>
<a href="#l3.2488"></a><span id="l3.2488" class="difflineplus">+    if (NS_FAILED(rv) || !thisServer) continue;</span>
<a href="#l3.2489"></a><span id="l3.2489"> </span>
<a href="#l3.2490"></a><span id="l3.2490">     nsAutoCString thisServerKey;</span>
<a href="#l3.2491"></a><span id="l3.2491">     rv = thisServer-&gt;GetKey(thisServerKey);</span>
<a href="#l3.2492"></a><span id="l3.2492" class="difflineminus">-    if (serverKey.Equals(thisServerKey))</span>
<a href="#l3.2493"></a><span id="l3.2493" class="difflineminus">-    {</span>
<a href="#l3.2494"></a><span id="l3.2494" class="difflineplus">+    if (serverKey.Equals(thisServerKey)) {</span>
<a href="#l3.2495"></a><span id="l3.2495">       nsCOMPtr&lt;nsIArray&gt; theseIdentities;</span>
<a href="#l3.2496"></a><span id="l3.2496">       rv = account-&gt;GetIdentities(getter_AddRefs(theseIdentities));</span>
<a href="#l3.2497"></a><span id="l3.2497" class="difflineminus">-      if (NS_SUCCEEDED(rv))</span>
<a href="#l3.2498"></a><span id="l3.2498" class="difflineminus">-      {</span>
<a href="#l3.2499"></a><span id="l3.2499" class="difflineplus">+      if (NS_SUCCEEDED(rv)) {</span>
<a href="#l3.2500"></a><span id="l3.2500">         uint32_t theseLength;</span>
<a href="#l3.2501"></a><span id="l3.2501">         rv = theseIdentities-&gt;GetLength(&amp;theseLength);</span>
<a href="#l3.2502"></a><span id="l3.2502" class="difflineminus">-        if (NS_SUCCEEDED(rv))</span>
<a href="#l3.2503"></a><span id="l3.2503" class="difflineminus">-        {</span>
<a href="#l3.2504"></a><span id="l3.2504" class="difflineminus">-          for (uint32_t j = 0; j &lt; theseLength; ++j)</span>
<a href="#l3.2505"></a><span id="l3.2505" class="difflineminus">-          {</span>
<a href="#l3.2506"></a><span id="l3.2506" class="difflineminus">-            nsCOMPtr&lt;nsISupports&gt; id(do_QueryElementAt(theseIdentities, j, &amp;rv));</span>
<a href="#l3.2507"></a><span id="l3.2507" class="difflineminus">-            if (NS_SUCCEEDED(rv))</span>
<a href="#l3.2508"></a><span id="l3.2508" class="difflineminus">-              identities-&gt;AppendElement(id);</span>
<a href="#l3.2509"></a><span id="l3.2509" class="difflineplus">+        if (NS_SUCCEEDED(rv)) {</span>
<a href="#l3.2510"></a><span id="l3.2510" class="difflineplus">+          for (uint32_t j = 0; j &lt; theseLength; ++j) {</span>
<a href="#l3.2511"></a><span id="l3.2511" class="difflineplus">+            nsCOMPtr&lt;nsISupports&gt; id(</span>
<a href="#l3.2512"></a><span id="l3.2512" class="difflineplus">+                do_QueryElementAt(theseIdentities, j, &amp;rv));</span>
<a href="#l3.2513"></a><span id="l3.2513" class="difflineplus">+            if (NS_SUCCEEDED(rv)) identities-&gt;AppendElement(id);</span>
<a href="#l3.2514"></a><span id="l3.2514">           }</span>
<a href="#l3.2515"></a><span id="l3.2515">         }</span>
<a href="#l3.2516"></a><span id="l3.2516">       }</span>
<a href="#l3.2517"></a><span id="l3.2517">     }</span>
<a href="#l3.2518"></a><span id="l3.2518">   }</span>
<a href="#l3.2519"></a><span id="l3.2519"> </span>
<a href="#l3.2520"></a><span id="l3.2520">   identities.forget(_retval);</span>
<a href="#l3.2521"></a><span id="l3.2521">   return NS_OK;</span>
<a href="#l3.2522"></a><span id="l3.2522"> }</span>
<a href="#l3.2523"></a><span id="l3.2523"> </span>
<a href="#l3.2524"></a><span id="l3.2524"> NS_IMETHODIMP</span>
<a href="#l3.2525"></a><span id="l3.2525"> nsMsgAccountManager::GetServersForIdentity(nsIMsgIdentity *aIdentity,</span>
<a href="#l3.2526"></a><span id="l3.2526" class="difflineminus">-                                           nsIArray **_retval)</span>
<a href="#l3.2527"></a><span id="l3.2527" class="difflineminus">-{</span>
<a href="#l3.2528"></a><span id="l3.2528" class="difflineplus">+                                           nsIArray **_retval) {</span>
<a href="#l3.2529"></a><span id="l3.2529">   NS_ENSURE_ARG_POINTER(aIdentity);</span>
<a href="#l3.2530"></a><span id="l3.2530"> </span>
<a href="#l3.2531"></a><span id="l3.2531">   nsresult rv;</span>
<a href="#l3.2532"></a><span id="l3.2532">   rv = LoadAccounts();</span>
<a href="#l3.2533"></a><span id="l3.2533">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.2534"></a><span id="l3.2534"> </span>
<a href="#l3.2535"></a><span id="l3.2535" class="difflineminus">-  nsCOMPtr&lt;nsIMutableArray&gt; servers(do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l3.2536"></a><span id="l3.2536" class="difflineplus">+  nsCOMPtr&lt;nsIMutableArray&gt; servers(</span>
<a href="#l3.2537"></a><span id="l3.2537" class="difflineplus">+      do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l3.2538"></a><span id="l3.2538">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.2539"></a><span id="l3.2539"> </span>
<a href="#l3.2540"></a><span id="l3.2540" class="difflineminus">-  for (uint32_t i = 0; i &lt; m_accounts.Length(); ++i)</span>
<a href="#l3.2541"></a><span id="l3.2541" class="difflineminus">-  {</span>
<a href="#l3.2542"></a><span id="l3.2542" class="difflineplus">+  for (uint32_t i = 0; i &lt; m_accounts.Length(); ++i) {</span>
<a href="#l3.2543"></a><span id="l3.2543">     nsCOMPtr&lt;nsIArray&gt; identities;</span>
<a href="#l3.2544"></a><span id="l3.2544">     if (NS_FAILED(m_accounts[i]-&gt;GetIdentities(getter_AddRefs(identities))))</span>
<a href="#l3.2545"></a><span id="l3.2545">       continue;</span>
<a href="#l3.2546"></a><span id="l3.2546"> </span>
<a href="#l3.2547"></a><span id="l3.2547">     uint32_t idCount = 0;</span>
<a href="#l3.2548"></a><span id="l3.2548" class="difflineminus">-    if (NS_FAILED(identities-&gt;GetLength(&amp;idCount)))</span>
<a href="#l3.2549"></a><span id="l3.2549" class="difflineminus">-      continue;</span>
<a href="#l3.2550"></a><span id="l3.2550" class="difflineplus">+    if (NS_FAILED(identities-&gt;GetLength(&amp;idCount))) continue;</span>
<a href="#l3.2551"></a><span id="l3.2551"> </span>
<a href="#l3.2552"></a><span id="l3.2552">     uint32_t id;</span>
<a href="#l3.2553"></a><span id="l3.2553">     nsCString identityKey;</span>
<a href="#l3.2554"></a><span id="l3.2554">     rv = aIdentity-&gt;GetKey(identityKey);</span>
<a href="#l3.2555"></a><span id="l3.2555" class="difflineminus">-    for (id = 0; id &lt; idCount; id++)</span>
<a href="#l3.2556"></a><span id="l3.2556" class="difflineminus">-    {</span>
<a href="#l3.2557"></a><span id="l3.2557" class="difflineminus">-      nsCOMPtr&lt;nsIMsgIdentity&gt; thisIdentity(do_QueryElementAt(identities, id, &amp;rv));</span>
<a href="#l3.2558"></a><span id="l3.2558" class="difflineminus">-      if (NS_SUCCEEDED(rv))</span>
<a href="#l3.2559"></a><span id="l3.2559" class="difflineminus">-      {</span>
<a href="#l3.2560"></a><span id="l3.2560" class="difflineplus">+    for (id = 0; id &lt; idCount; id++) {</span>
<a href="#l3.2561"></a><span id="l3.2561" class="difflineplus">+      nsCOMPtr&lt;nsIMsgIdentity&gt; thisIdentity(</span>
<a href="#l3.2562"></a><span id="l3.2562" class="difflineplus">+          do_QueryElementAt(identities, id, &amp;rv));</span>
<a href="#l3.2563"></a><span id="l3.2563" class="difflineplus">+      if (NS_SUCCEEDED(rv)) {</span>
<a href="#l3.2564"></a><span id="l3.2564">         nsCString thisIdentityKey;</span>
<a href="#l3.2565"></a><span id="l3.2565">         rv = thisIdentity-&gt;GetKey(thisIdentityKey);</span>
<a href="#l3.2566"></a><span id="l3.2566"> </span>
<a href="#l3.2567"></a><span id="l3.2567" class="difflineminus">-        if (NS_SUCCEEDED(rv) &amp;&amp; identityKey.Equals(thisIdentityKey))</span>
<a href="#l3.2568"></a><span id="l3.2568" class="difflineminus">-        {</span>
<a href="#l3.2569"></a><span id="l3.2569" class="difflineplus">+        if (NS_SUCCEEDED(rv) &amp;&amp; identityKey.Equals(thisIdentityKey)) {</span>
<a href="#l3.2570"></a><span id="l3.2570">           nsCOMPtr&lt;nsIMsgIncomingServer&gt; thisServer;</span>
<a href="#l3.2571"></a><span id="l3.2571">           rv = m_accounts[i]-&gt;GetIncomingServer(getter_AddRefs(thisServer));</span>
<a href="#l3.2572"></a><span id="l3.2572" class="difflineminus">-          if (thisServer &amp;&amp; NS_SUCCEEDED(rv))</span>
<a href="#l3.2573"></a><span id="l3.2573" class="difflineminus">-          {</span>
<a href="#l3.2574"></a><span id="l3.2574" class="difflineplus">+          if (thisServer &amp;&amp; NS_SUCCEEDED(rv)) {</span>
<a href="#l3.2575"></a><span id="l3.2575">             servers-&gt;AppendElement(thisServer);</span>
<a href="#l3.2576"></a><span id="l3.2576">             break;</span>
<a href="#l3.2577"></a><span id="l3.2577">           }</span>
<a href="#l3.2578"></a><span id="l3.2578">         }</span>
<a href="#l3.2579"></a><span id="l3.2579">       }</span>
<a href="#l3.2580"></a><span id="l3.2580">     }</span>
<a href="#l3.2581"></a><span id="l3.2581">   }</span>
<a href="#l3.2582"></a><span id="l3.2582">   servers.forget(_retval);</span>
<a href="#l3.2583"></a><span id="l3.2583">   return NS_OK;</span>
<a href="#l3.2584"></a><span id="l3.2584"> }</span>
<a href="#l3.2585"></a><span id="l3.2585"> </span>
<a href="#l3.2586"></a><span id="l3.2586"> NS_IMETHODIMP</span>
<a href="#l3.2587"></a><span id="l3.2587" class="difflineminus">-nsMsgAccountManager::AddRootFolderListener(nsIFolderListener *aListener)</span>
<a href="#l3.2588"></a><span id="l3.2588" class="difflineminus">-{</span>
<a href="#l3.2589"></a><span id="l3.2589" class="difflineplus">+nsMsgAccountManager::AddRootFolderListener(nsIFolderListener *aListener) {</span>
<a href="#l3.2590"></a><span id="l3.2590">   NS_ENSURE_TRUE(aListener, NS_OK);</span>
<a href="#l3.2591"></a><span id="l3.2591">   mFolderListeners.AppendElement(aListener);</span>
<a href="#l3.2592"></a><span id="l3.2592">   for (auto iter = m_incomingServers.Iter(); !iter.Done(); iter.Next()) {</span>
<a href="#l3.2593"></a><span id="l3.2593">     nsCOMPtr&lt;nsIMsgFolder&gt; rootFolder;</span>
<a href="#l3.2594"></a><span id="l3.2594">     nsresult rv = iter.Data()-&gt;GetRootFolder(getter_AddRefs(rootFolder));</span>
<a href="#l3.2595"></a><span id="l3.2595">     if (NS_FAILED(rv)) {</span>
<a href="#l3.2596"></a><span id="l3.2596">       continue;</span>
<a href="#l3.2597"></a><span id="l3.2597">     }</span>
<a href="#l3.2598"></a><span id="l3.2598">     rv = rootFolder-&gt;AddFolderListener(aListener);</span>
<a href="#l3.2599"></a><span id="l3.2599">   }</span>
<a href="#l3.2600"></a><span id="l3.2600">   return NS_OK;</span>
<a href="#l3.2601"></a><span id="l3.2601"> }</span>
<a href="#l3.2602"></a><span id="l3.2602"> </span>
<a href="#l3.2603"></a><span id="l3.2603"> NS_IMETHODIMP</span>
<a href="#l3.2604"></a><span id="l3.2604" class="difflineminus">-nsMsgAccountManager::RemoveRootFolderListener(nsIFolderListener *aListener)</span>
<a href="#l3.2605"></a><span id="l3.2605" class="difflineminus">-{</span>
<a href="#l3.2606"></a><span id="l3.2606" class="difflineplus">+nsMsgAccountManager::RemoveRootFolderListener(nsIFolderListener *aListener) {</span>
<a href="#l3.2607"></a><span id="l3.2607">   NS_ENSURE_TRUE(aListener, NS_OK);</span>
<a href="#l3.2608"></a><span id="l3.2608">   mFolderListeners.RemoveElement(aListener);</span>
<a href="#l3.2609"></a><span id="l3.2609">   for (auto iter = m_incomingServers.Iter(); !iter.Done(); iter.Next()) {</span>
<a href="#l3.2610"></a><span id="l3.2610">     nsCOMPtr&lt;nsIMsgFolder&gt; rootFolder;</span>
<a href="#l3.2611"></a><span id="l3.2611">     nsresult rv = iter.Data()-&gt;GetRootFolder(getter_AddRefs(rootFolder));</span>
<a href="#l3.2612"></a><span id="l3.2612">     if (NS_FAILED(rv)) {</span>
<a href="#l3.2613"></a><span id="l3.2613">       continue;</span>
<a href="#l3.2614"></a><span id="l3.2614">     }</span>
<a href="#l3.2615"></a><span id="l3.2615">     rv = rootFolder-&gt;RemoveFolderListener(aListener);</span>
<a href="#l3.2616"></a><span id="l3.2616">   }</span>
<a href="#l3.2617"></a><span id="l3.2617"> </span>
<a href="#l3.2618"></a><span id="l3.2618">   return NS_OK;</span>
<a href="#l3.2619"></a><span id="l3.2619"> }</span>
<a href="#l3.2620"></a><span id="l3.2620"> </span>
<a href="#l3.2621"></a><span id="l3.2621" class="difflineminus">-NS_IMETHODIMP nsMsgAccountManager::SetLocalFoldersServer(nsIMsgIncomingServer *aServer)</span>
<a href="#l3.2622"></a><span id="l3.2622" class="difflineminus">-{</span>
<a href="#l3.2623"></a><span id="l3.2623" class="difflineplus">+NS_IMETHODIMP nsMsgAccountManager::SetLocalFoldersServer(</span>
<a href="#l3.2624"></a><span id="l3.2624" class="difflineplus">+    nsIMsgIncomingServer *aServer) {</span>
<a href="#l3.2625"></a><span id="l3.2625">   NS_ENSURE_ARG_POINTER(aServer);</span>
<a href="#l3.2626"></a><span id="l3.2626">   nsCString key;</span>
<a href="#l3.2627"></a><span id="l3.2627">   nsresult rv = aServer-&gt;GetKey(key);</span>
<a href="#l3.2628"></a><span id="l3.2628">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.2629"></a><span id="l3.2629"> </span>
<a href="#l3.2630"></a><span id="l3.2630">   return m_prefs-&gt;SetCharPref(PREF_MAIL_ACCOUNTMANAGER_LOCALFOLDERSSERVER, key);</span>
<a href="#l3.2631"></a><span id="l3.2631"> }</span>
<a href="#l3.2632"></a><span id="l3.2632"> </span>
<a href="#l3.2633"></a><span id="l3.2633" class="difflineminus">-NS_IMETHODIMP nsMsgAccountManager::GetLocalFoldersServer(nsIMsgIncomingServer **aServer)</span>
<a href="#l3.2634"></a><span id="l3.2634" class="difflineminus">-{</span>
<a href="#l3.2635"></a><span id="l3.2635" class="difflineplus">+NS_IMETHODIMP nsMsgAccountManager::GetLocalFoldersServer(</span>
<a href="#l3.2636"></a><span id="l3.2636" class="difflineplus">+    nsIMsgIncomingServer **aServer) {</span>
<a href="#l3.2637"></a><span id="l3.2637">   NS_ENSURE_ARG_POINTER(aServer);</span>
<a href="#l3.2638"></a><span id="l3.2638"> </span>
<a href="#l3.2639"></a><span id="l3.2639">   nsCString serverKey;</span>
<a href="#l3.2640"></a><span id="l3.2640"> </span>
<a href="#l3.2641"></a><span id="l3.2641" class="difflineminus">-  nsresult rv = m_prefs-&gt;GetCharPref(PREF_MAIL_ACCOUNTMANAGER_LOCALFOLDERSSERVER, serverKey);</span>
<a href="#l3.2642"></a><span id="l3.2642" class="difflineminus">-</span>
<a href="#l3.2643"></a><span id="l3.2643" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; !serverKey.IsEmpty())</span>
<a href="#l3.2644"></a><span id="l3.2644" class="difflineminus">-  {</span>
<a href="#l3.2645"></a><span id="l3.2645" class="difflineplus">+  nsresult rv = m_prefs-&gt;GetCharPref(</span>
<a href="#l3.2646"></a><span id="l3.2646" class="difflineplus">+      PREF_MAIL_ACCOUNTMANAGER_LOCALFOLDERSSERVER, serverKey);</span>
<a href="#l3.2647"></a><span id="l3.2647" class="difflineplus">+</span>
<a href="#l3.2648"></a><span id="l3.2648" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; !serverKey.IsEmpty()) {</span>
<a href="#l3.2649"></a><span id="l3.2649">     rv = GetIncomingServer(serverKey, aServer);</span>
<a href="#l3.2650"></a><span id="l3.2650" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l3.2651"></a><span id="l3.2651" class="difflineminus">-      return rv;</span>
<a href="#l3.2652"></a><span id="l3.2652" class="difflineplus">+    if (NS_SUCCEEDED(rv)) return rv;</span>
<a href="#l3.2653"></a><span id="l3.2653">     // otherwise, we're going to fall through to looking for an existing local</span>
<a href="#l3.2654"></a><span id="l3.2654">     // folders account, because now we fail creating one if one already exists.</span>
<a href="#l3.2655"></a><span id="l3.2655">   }</span>
<a href="#l3.2656"></a><span id="l3.2656"> </span>
<a href="#l3.2657"></a><span id="l3.2657">   // try (&quot;nobody&quot;,&quot;Local Folders&quot;,&quot;none&quot;), and work down to any &quot;none&quot; server.</span>
<a href="#l3.2658"></a><span id="l3.2658" class="difflineminus">-  rv = FindServer(NS_LITERAL_CSTRING(&quot;nobody&quot;), NS_LITERAL_CSTRING(&quot;Local Folders&quot;),</span>
<a href="#l3.2659"></a><span id="l3.2659" class="difflineplus">+  rv = FindServer(NS_LITERAL_CSTRING(&quot;nobody&quot;),</span>
<a href="#l3.2660"></a><span id="l3.2660" class="difflineplus">+                  NS_LITERAL_CSTRING(&quot;Local Folders&quot;),</span>
<a href="#l3.2661"></a><span id="l3.2661">                   NS_LITERAL_CSTRING(&quot;none&quot;), aServer);</span>
<a href="#l3.2662"></a><span id="l3.2662" class="difflineminus">-  if (NS_FAILED(rv) || !*aServer)</span>
<a href="#l3.2663"></a><span id="l3.2663" class="difflineminus">-  {</span>
<a href="#l3.2664"></a><span id="l3.2664" class="difflineminus">-      rv = FindServer(NS_LITERAL_CSTRING(&quot;nobody&quot;), EmptyCString(), NS_LITERAL_CSTRING(&quot;none&quot;), aServer);</span>
<a href="#l3.2665"></a><span id="l3.2665" class="difflineplus">+  if (NS_FAILED(rv) || !*aServer) {</span>
<a href="#l3.2666"></a><span id="l3.2666" class="difflineplus">+    rv = FindServer(NS_LITERAL_CSTRING(&quot;nobody&quot;), EmptyCString(),</span>
<a href="#l3.2667"></a><span id="l3.2667" class="difflineplus">+                    NS_LITERAL_CSTRING(&quot;none&quot;), aServer);</span>
<a href="#l3.2668"></a><span id="l3.2668" class="difflineplus">+    if (NS_FAILED(rv) || !*aServer) {</span>
<a href="#l3.2669"></a><span id="l3.2669" class="difflineplus">+      rv = FindServer(EmptyCString(), NS_LITERAL_CSTRING(&quot;Local Folders&quot;),</span>
<a href="#l3.2670"></a><span id="l3.2670" class="difflineplus">+                      NS_LITERAL_CSTRING(&quot;none&quot;), aServer);</span>
<a href="#l3.2671"></a><span id="l3.2671">       if (NS_FAILED(rv) || !*aServer)</span>
<a href="#l3.2672"></a><span id="l3.2672" class="difflineminus">-      {</span>
<a href="#l3.2673"></a><span id="l3.2673" class="difflineminus">-          rv = FindServer(EmptyCString(), NS_LITERAL_CSTRING(&quot;Local Folders&quot;),</span>
<a href="#l3.2674"></a><span id="l3.2674" class="difflineminus">-                          NS_LITERAL_CSTRING(&quot;none&quot;), aServer);</span>
<a href="#l3.2675"></a><span id="l3.2675" class="difflineminus">-          if (NS_FAILED(rv) || !*aServer)</span>
<a href="#l3.2676"></a><span id="l3.2676" class="difflineminus">-              rv = FindServer(EmptyCString(), EmptyCString(), NS_LITERAL_CSTRING(&quot;none&quot;), aServer);</span>
<a href="#l3.2677"></a><span id="l3.2677" class="difflineminus">-      }</span>
<a href="#l3.2678"></a><span id="l3.2678" class="difflineplus">+        rv = FindServer(EmptyCString(), EmptyCString(),</span>
<a href="#l3.2679"></a><span id="l3.2679" class="difflineplus">+                        NS_LITERAL_CSTRING(&quot;none&quot;), aServer);</span>
<a href="#l3.2680"></a><span id="l3.2680" class="difflineplus">+    }</span>
<a href="#l3.2681"></a><span id="l3.2681">   }</span>
<a href="#l3.2682"></a><span id="l3.2682"> </span>
<a href="#l3.2683"></a><span id="l3.2683">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.2684"></a><span id="l3.2684" class="difflineminus">-  if (!*aServer)</span>
<a href="#l3.2685"></a><span id="l3.2685" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l3.2686"></a><span id="l3.2686" class="difflineplus">+  if (!*aServer) return NS_ERROR_FAILURE;</span>
<a href="#l3.2687"></a><span id="l3.2687"> </span>
<a href="#l3.2688"></a><span id="l3.2688">   // we don't want the Smart Mailboxes server to be the local server.</span>
<a href="#l3.2689"></a><span id="l3.2689">   bool hidden;</span>
<a href="#l3.2690"></a><span id="l3.2690">   (*aServer)-&gt;GetHidden(&amp;hidden);</span>
<a href="#l3.2691"></a><span id="l3.2691" class="difflineminus">-  if (hidden)</span>
<a href="#l3.2692"></a><span id="l3.2692" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l3.2693"></a><span id="l3.2693" class="difflineplus">+  if (hidden) return NS_ERROR_FAILURE;</span>
<a href="#l3.2694"></a><span id="l3.2694"> </span>
<a href="#l3.2695"></a><span id="l3.2695">   rv = SetLocalFoldersServer(*aServer);</span>
<a href="#l3.2696"></a><span id="l3.2696">   return rv;</span>
<a href="#l3.2697"></a><span id="l3.2697"> }</span>
<a href="#l3.2698"></a><span id="l3.2698"> </span>
<a href="#l3.2699"></a><span id="l3.2699" class="difflineminus">-nsresult nsMsgAccountManager::GetLocalFoldersPrettyName(nsString &amp;localFoldersName)</span>
<a href="#l3.2700"></a><span id="l3.2700" class="difflineminus">-{</span>
<a href="#l3.2701"></a><span id="l3.2701" class="difflineplus">+nsresult nsMsgAccountManager::GetLocalFoldersPrettyName(</span>
<a href="#l3.2702"></a><span id="l3.2702" class="difflineplus">+    nsString &amp;localFoldersName) {</span>
<a href="#l3.2703"></a><span id="l3.2703">   // we don't want &quot;nobody at Local Folders&quot; to show up in the</span>
<a href="#l3.2704"></a><span id="l3.2704">   // folder pane, so we set the pretty name to a localized &quot;Local Folders&quot;</span>
<a href="#l3.2705"></a><span id="l3.2705">   nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l3.2706"></a><span id="l3.2706">   nsresult rv;</span>
<a href="#l3.2707"></a><span id="l3.2707">   nsCOMPtr&lt;nsIStringBundleService&gt; sBundleService =</span>
<a href="#l3.2708"></a><span id="l3.2708" class="difflineminus">-    mozilla::services::GetStringBundleService();</span>
<a href="#l3.2709"></a><span id="l3.2709" class="difflineplus">+      mozilla::services::GetStringBundleService();</span>
<a href="#l3.2710"></a><span id="l3.2710">   NS_ENSURE_TRUE(sBundleService, NS_ERROR_UNEXPECTED);</span>
<a href="#l3.2711"></a><span id="l3.2711"> </span>
<a href="#l3.2712"></a><span id="l3.2712" class="difflineminus">-  rv = sBundleService-&gt;CreateBundle(&quot;chrome://messenger/locale/messenger.properties&quot;,</span>
<a href="#l3.2713"></a><span id="l3.2713" class="difflineminus">-                                    getter_AddRefs(bundle));</span>
<a href="#l3.2714"></a><span id="l3.2714" class="difflineplus">+  rv = sBundleService-&gt;CreateBundle(</span>
<a href="#l3.2715"></a><span id="l3.2715" class="difflineplus">+      &quot;chrome://messenger/locale/messenger.properties&quot;, getter_AddRefs(bundle));</span>
<a href="#l3.2716"></a><span id="l3.2716">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.2717"></a><span id="l3.2717"> </span>
<a href="#l3.2718"></a><span id="l3.2718">   return bundle-&gt;GetStringFromName(&quot;localFolders&quot;, localFoldersName);</span>
<a href="#l3.2719"></a><span id="l3.2719"> }</span>
<a href="#l3.2720"></a><span id="l3.2720"> </span>
<a href="#l3.2721"></a><span id="l3.2721"> NS_IMETHODIMP</span>
<a href="#l3.2722"></a><span id="l3.2722" class="difflineminus">-nsMsgAccountManager::CreateLocalMailAccount()</span>
<a href="#l3.2723"></a><span id="l3.2723" class="difflineminus">-{</span>
<a href="#l3.2724"></a><span id="l3.2724" class="difflineplus">+nsMsgAccountManager::CreateLocalMailAccount() {</span>
<a href="#l3.2725"></a><span id="l3.2725">   // create the server</span>
<a href="#l3.2726"></a><span id="l3.2726">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l3.2727"></a><span id="l3.2727" class="difflineminus">-  nsresult rv = CreateIncomingServer(NS_LITERAL_CSTRING(&quot;nobody&quot;),</span>
<a href="#l3.2728"></a><span id="l3.2728" class="difflineminus">-                            NS_LITERAL_CSTRING(&quot;Local Folders&quot;),</span>
<a href="#l3.2729"></a><span id="l3.2729" class="difflineminus">-                            NS_LITERAL_CSTRING(&quot;none&quot;), getter_AddRefs(server));</span>
<a href="#l3.2730"></a><span id="l3.2730" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l3.2731"></a><span id="l3.2731" class="difflineplus">+  nsresult rv = CreateIncomingServer(</span>
<a href="#l3.2732"></a><span id="l3.2732" class="difflineplus">+      NS_LITERAL_CSTRING(&quot;nobody&quot;), NS_LITERAL_CSTRING(&quot;Local Folders&quot;),</span>
<a href="#l3.2733"></a><span id="l3.2733" class="difflineplus">+      NS_LITERAL_CSTRING(&quot;none&quot;), getter_AddRefs(server));</span>
<a href="#l3.2734"></a><span id="l3.2734" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.2735"></a><span id="l3.2735"> </span>
<a href="#l3.2736"></a><span id="l3.2736">   nsString localFoldersName;</span>
<a href="#l3.2737"></a><span id="l3.2737">   rv = GetLocalFoldersPrettyName(localFoldersName);</span>
<a href="#l3.2738"></a><span id="l3.2738">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.2739"></a><span id="l3.2739">   server-&gt;SetPrettyName(localFoldersName);</span>
<a href="#l3.2740"></a><span id="l3.2740"> </span>
<a href="#l3.2741"></a><span id="l3.2741">   nsCOMPtr&lt;nsINoIncomingServer&gt; noServer;</span>
<a href="#l3.2742"></a><span id="l3.2742">   noServer = do_QueryInterface(server, &amp;rv);</span>
<a href="#l3.2743"></a><span id="l3.2743">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l3.2744"></a><span id="l3.2744"> </span>
<a href="#l3.2745"></a><span id="l3.2745">   // create the directory structure for old 4.x &quot;Local Mail&quot;</span>
<a href="#l3.2746"></a><span id="l3.2746">   // under &lt;profile dir&gt;/Mail/Local Folders or</span>
<a href="#l3.2747"></a><span id="l3.2747">   // &lt;&quot;mail.directory&quot; pref&gt;/Local Folders</span>
<a href="#l3.2748"></a><span id="l3.2748" class="difflineminus">-  nsCOMPtr &lt;nsIFile&gt; mailDir;</span>
<a href="#l3.2749"></a><span id="l3.2749" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; mailDir;</span>
<a href="#l3.2750"></a><span id="l3.2750">   bool dirExists;</span>
<a href="#l3.2751"></a><span id="l3.2751"> </span>
<a href="#l3.2752"></a><span id="l3.2752">   // we want &lt;profile&gt;/Mail</span>
<a href="#l3.2753"></a><span id="l3.2753">   rv = NS_GetSpecialDirectory(NS_APP_MAIL_50_DIR, getter_AddRefs(mailDir));</span>
<a href="#l3.2754"></a><span id="l3.2754">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l3.2755"></a><span id="l3.2755"> </span>
<a href="#l3.2756"></a><span id="l3.2756">   rv = mailDir-&gt;Exists(&amp;dirExists);</span>
<a href="#l3.2757"></a><span id="l3.2757">   if (NS_SUCCEEDED(rv) &amp;&amp; !dirExists)</span>
<a href="#l3.2758"></a><span id="l3.2758">     rv = mailDir-&gt;Create(nsIFile::DIRECTORY_TYPE, 0775);</span>
<a href="#l3.2759"></a><span id="l3.2759">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l3.2760"></a><span id="l3.2760"> </span>
<a href="#l3.2761"></a><span id="l3.2761">   // set the default local path for &quot;none&quot;</span>
<a href="#l3.2762"></a><span id="l3.2762">   rv = server-&gt;SetDefaultLocalPath(mailDir);</span>
<a href="#l3.2763"></a><span id="l3.2763">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l3.2764"></a><span id="l3.2764"> </span>
<a href="#l3.2765"></a><span id="l3.2765">   // Create an account when valid server values are established.</span>
<a href="#l3.2766"></a><span id="l3.2766" class="difflineminus">-  // This will keep the status of accounts sane by avoiding the addition of incomplete accounts.</span>
<a href="#l3.2767"></a><span id="l3.2767" class="difflineplus">+  // This will keep the status of accounts sane by avoiding the addition of</span>
<a href="#l3.2768"></a><span id="l3.2768" class="difflineplus">+  // incomplete accounts.</span>
<a href="#l3.2769"></a><span id="l3.2769">   nsCOMPtr&lt;nsIMsgAccount&gt; account;</span>
<a href="#l3.2770"></a><span id="l3.2770">   rv = CreateAccount(getter_AddRefs(account));</span>
<a href="#l3.2771"></a><span id="l3.2771">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l3.2772"></a><span id="l3.2772"> </span>
<a href="#l3.2773"></a><span id="l3.2773">   // notice, no identity for local mail</span>
<a href="#l3.2774"></a><span id="l3.2774">   // hook the server to the account</span>
<a href="#l3.2775"></a><span id="l3.2775">   // after we set the server's local path</span>
<a href="#l3.2776"></a><span id="l3.2776">   // (see bug #66018)</span>
<a href="#l3.2777"></a><span id="l3.2777">   account-&gt;SetIncomingServer(server);</span>
<a href="#l3.2778"></a><span id="l3.2778"> </span>
<a href="#l3.2779"></a><span id="l3.2779">   // remember this as the local folders server</span>
<a href="#l3.2780"></a><span id="l3.2780">   return SetLocalFoldersServer(server);</span>
<a href="#l3.2781"></a><span id="l3.2781"> }</span>
<a href="#l3.2782"></a><span id="l3.2782"> </span>
<a href="#l3.2783"></a><span id="l3.2783" class="difflineminus">-  // nsIUrlListener methods</span>
<a href="#l3.2784"></a><span id="l3.2784" class="difflineplus">+// nsIUrlListener methods</span>
<a href="#l3.2785"></a><span id="l3.2785" class="difflineplus">+</span>
<a href="#l3.2786"></a><span id="l3.2786" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l3.2787"></a><span id="l3.2787" class="difflineplus">+nsMsgAccountManager::OnStartRunningUrl(nsIURI *aUrl) { return NS_OK; }</span>
<a href="#l3.2788"></a><span id="l3.2788"> </span>
<a href="#l3.2789"></a><span id="l3.2789"> NS_IMETHODIMP</span>
<a href="#l3.2790"></a><span id="l3.2790" class="difflineminus">-nsMsgAccountManager::OnStartRunningUrl(nsIURI * aUrl)</span>
<a href="#l3.2791"></a><span id="l3.2791" class="difflineminus">-{</span>
<a href="#l3.2792"></a><span id="l3.2792" class="difflineplus">+nsMsgAccountManager::OnStopRunningUrl(nsIURI *aUrl, nsresult aExitCode) {</span>
<a href="#l3.2793"></a><span id="l3.2793" class="difflineplus">+  if (aUrl) {</span>
<a href="#l3.2794"></a><span id="l3.2794" class="difflineplus">+    nsCOMPtr&lt;nsIImapUrl&gt; imapUrl = do_QueryInterface(aUrl);</span>
<a href="#l3.2795"></a><span id="l3.2795" class="difflineplus">+    if (imapUrl) {</span>
<a href="#l3.2796"></a><span id="l3.2796" class="difflineplus">+      nsImapAction imapAction = nsIImapUrl::nsImapTest;</span>
<a href="#l3.2797"></a><span id="l3.2797" class="difflineplus">+      imapUrl-&gt;GetImapAction(&amp;imapAction);</span>
<a href="#l3.2798"></a><span id="l3.2798" class="difflineplus">+      switch (imapAction) {</span>
<a href="#l3.2799"></a><span id="l3.2799" class="difflineplus">+        case nsIImapUrl::nsImapExpungeFolder:</span>
<a href="#l3.2800"></a><span id="l3.2800" class="difflineplus">+          if (m_folderDoingCleanupInbox) {</span>
<a href="#l3.2801"></a><span id="l3.2801" class="difflineplus">+            PR_CEnterMonitor(m_folderDoingCleanupInbox);</span>
<a href="#l3.2802"></a><span id="l3.2802" class="difflineplus">+            PR_CNotifyAll(m_folderDoingCleanupInbox);</span>
<a href="#l3.2803"></a><span id="l3.2803" class="difflineplus">+            m_cleanupInboxInProgress = false;</span>
<a href="#l3.2804"></a><span id="l3.2804" class="difflineplus">+            PR_CExitMonitor(m_folderDoingCleanupInbox);</span>
<a href="#l3.2805"></a><span id="l3.2805" class="difflineplus">+            m_folderDoingCleanupInbox = nullptr;  // reset to nullptr</span>
<a href="#l3.2806"></a><span id="l3.2806" class="difflineplus">+          }</span>
<a href="#l3.2807"></a><span id="l3.2807" class="difflineplus">+          break;</span>
<a href="#l3.2808"></a><span id="l3.2808" class="difflineplus">+        case nsIImapUrl::nsImapDeleteAllMsgs:</span>
<a href="#l3.2809"></a><span id="l3.2809" class="difflineplus">+          if (m_folderDoingEmptyTrash) {</span>
<a href="#l3.2810"></a><span id="l3.2810" class="difflineplus">+            PR_CEnterMonitor(m_folderDoingEmptyTrash);</span>
<a href="#l3.2811"></a><span id="l3.2811" class="difflineplus">+            PR_CNotifyAll(m_folderDoingEmptyTrash);</span>
<a href="#l3.2812"></a><span id="l3.2812" class="difflineplus">+            m_emptyTrashInProgress = false;</span>
<a href="#l3.2813"></a><span id="l3.2813" class="difflineplus">+            PR_CExitMonitor(m_folderDoingEmptyTrash);</span>
<a href="#l3.2814"></a><span id="l3.2814" class="difflineplus">+            m_folderDoingEmptyTrash = nullptr;  // reset to nullptr;</span>
<a href="#l3.2815"></a><span id="l3.2815" class="difflineplus">+          }</span>
<a href="#l3.2816"></a><span id="l3.2816" class="difflineplus">+          break;</span>
<a href="#l3.2817"></a><span id="l3.2817" class="difflineplus">+        default:</span>
<a href="#l3.2818"></a><span id="l3.2818" class="difflineplus">+          break;</span>
<a href="#l3.2819"></a><span id="l3.2819" class="difflineplus">+      }</span>
<a href="#l3.2820"></a><span id="l3.2820" class="difflineplus">+    }</span>
<a href="#l3.2821"></a><span id="l3.2821" class="difflineplus">+  }</span>
<a href="#l3.2822"></a><span id="l3.2822">   return NS_OK;</span>
<a href="#l3.2823"></a><span id="l3.2823"> }</span>
<a href="#l3.2824"></a><span id="l3.2824"> </span>
<a href="#l3.2825"></a><span id="l3.2825"> NS_IMETHODIMP</span>
<a href="#l3.2826"></a><span id="l3.2826" class="difflineminus">-nsMsgAccountManager::OnStopRunningUrl(nsIURI * aUrl, nsresult aExitCode)</span>
<a href="#l3.2827"></a><span id="l3.2827" class="difflineminus">-{</span>
<a href="#l3.2828"></a><span id="l3.2828" class="difflineminus">-  if (aUrl)</span>
<a href="#l3.2829"></a><span id="l3.2829" class="difflineminus">-  {</span>
<a href="#l3.2830"></a><span id="l3.2830" class="difflineminus">-    nsCOMPtr&lt;nsIImapUrl&gt; imapUrl = do_QueryInterface(aUrl);</span>
<a href="#l3.2831"></a><span id="l3.2831" class="difflineminus">-    if (imapUrl)</span>
<a href="#l3.2832"></a><span id="l3.2832" class="difflineminus">-    {</span>
<a href="#l3.2833"></a><span id="l3.2833" class="difflineminus">-      nsImapAction imapAction = nsIImapUrl::nsImapTest;</span>
<a href="#l3.2834"></a><span id="l3.2834" class="difflineminus">-      imapUrl-&gt;GetImapAction(&amp;imapAction);</span>
<a href="#l3.2835"></a><span id="l3.2835" class="difflineminus">-      switch(imapAction)</span>
<a href="#l3.2836"></a><span id="l3.2836" class="difflineminus">-      {</span>
<a href="#l3.2837"></a><span id="l3.2837" class="difflineminus">-        case nsIImapUrl::nsImapExpungeFolder:</span>
<a href="#l3.2838"></a><span id="l3.2838" class="difflineminus">-          if (m_folderDoingCleanupInbox)</span>
<a href="#l3.2839"></a><span id="l3.2839" class="difflineminus">-          {</span>
<a href="#l3.2840"></a><span id="l3.2840" class="difflineminus">-            PR_CEnterMonitor(m_folderDoingCleanupInbox);</span>
<a href="#l3.2841"></a><span id="l3.2841" class="difflineminus">-            PR_CNotifyAll(m_folderDoingCleanupInbox);</span>
<a href="#l3.2842"></a><span id="l3.2842" class="difflineminus">-            m_cleanupInboxInProgress = false;</span>
<a href="#l3.2843"></a><span id="l3.2843" class="difflineminus">-            PR_CExitMonitor(m_folderDoingCleanupInbox);</span>
<a href="#l3.2844"></a><span id="l3.2844" class="difflineminus">-            m_folderDoingCleanupInbox=nullptr;   //reset to nullptr</span>
<a href="#l3.2845"></a><span id="l3.2845" class="difflineminus">-          }</span>
<a href="#l3.2846"></a><span id="l3.2846" class="difflineminus">-          break;</span>
<a href="#l3.2847"></a><span id="l3.2847" class="difflineminus">-        case nsIImapUrl::nsImapDeleteAllMsgs:</span>
<a href="#l3.2848"></a><span id="l3.2848" class="difflineminus">-          if (m_folderDoingEmptyTrash)</span>
<a href="#l3.2849"></a><span id="l3.2849" class="difflineminus">-          {</span>
<a href="#l3.2850"></a><span id="l3.2850" class="difflineminus">-            PR_CEnterMonitor(m_folderDoingEmptyTrash);</span>
<a href="#l3.2851"></a><span id="l3.2851" class="difflineminus">-            PR_CNotifyAll(m_folderDoingEmptyTrash);</span>
<a href="#l3.2852"></a><span id="l3.2852" class="difflineminus">-            m_emptyTrashInProgress = false;</span>
<a href="#l3.2853"></a><span id="l3.2853" class="difflineminus">-            PR_CExitMonitor(m_folderDoingEmptyTrash);</span>
<a href="#l3.2854"></a><span id="l3.2854" class="difflineminus">-            m_folderDoingEmptyTrash = nullptr;  //reset to nullptr;</span>
<a href="#l3.2855"></a><span id="l3.2855" class="difflineminus">-          }</span>
<a href="#l3.2856"></a><span id="l3.2856" class="difflineminus">-          break;</span>
<a href="#l3.2857"></a><span id="l3.2857" class="difflineminus">-        default:</span>
<a href="#l3.2858"></a><span id="l3.2858" class="difflineminus">-          break;</span>
<a href="#l3.2859"></a><span id="l3.2859" class="difflineminus">-       }</span>
<a href="#l3.2860"></a><span id="l3.2860" class="difflineminus">-     }</span>
<a href="#l3.2861"></a><span id="l3.2861" class="difflineminus">-   }</span>
<a href="#l3.2862"></a><span id="l3.2862" class="difflineminus">-   return NS_OK;</span>
<a href="#l3.2863"></a><span id="l3.2863" class="difflineminus">-}</span>
<a href="#l3.2864"></a><span id="l3.2864" class="difflineminus">-</span>
<a href="#l3.2865"></a><span id="l3.2865" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l3.2866"></a><span id="l3.2866" class="difflineminus">-nsMsgAccountManager::SetFolderDoingEmptyTrash(nsIMsgFolder *folder)</span>
<a href="#l3.2867"></a><span id="l3.2867" class="difflineminus">-{</span>
<a href="#l3.2868"></a><span id="l3.2868" class="difflineplus">+nsMsgAccountManager::SetFolderDoingEmptyTrash(nsIMsgFolder *folder) {</span>
<a href="#l3.2869"></a><span id="l3.2869">   m_folderDoingEmptyTrash = folder;</span>
<a href="#l3.2870"></a><span id="l3.2870">   m_emptyTrashInProgress = true;</span>
<a href="#l3.2871"></a><span id="l3.2871">   return NS_OK;</span>
<a href="#l3.2872"></a><span id="l3.2872"> }</span>
<a href="#l3.2873"></a><span id="l3.2873"> </span>
<a href="#l3.2874"></a><span id="l3.2874"> NS_IMETHODIMP</span>
<a href="#l3.2875"></a><span id="l3.2875" class="difflineminus">-nsMsgAccountManager::GetEmptyTrashInProgress(bool *bVal)</span>
<a href="#l3.2876"></a><span id="l3.2876" class="difflineminus">-{</span>
<a href="#l3.2877"></a><span id="l3.2877" class="difflineplus">+nsMsgAccountManager::GetEmptyTrashInProgress(bool *bVal) {</span>
<a href="#l3.2878"></a><span id="l3.2878">   NS_ENSURE_ARG_POINTER(bVal);</span>
<a href="#l3.2879"></a><span id="l3.2879">   *bVal = m_emptyTrashInProgress;</span>
<a href="#l3.2880"></a><span id="l3.2880">   return NS_OK;</span>
<a href="#l3.2881"></a><span id="l3.2881"> }</span>
<a href="#l3.2882"></a><span id="l3.2882"> </span>
<a href="#l3.2883"></a><span id="l3.2883"> NS_IMETHODIMP</span>
<a href="#l3.2884"></a><span id="l3.2884" class="difflineminus">-nsMsgAccountManager::SetFolderDoingCleanupInbox(nsIMsgFolder *folder)</span>
<a href="#l3.2885"></a><span id="l3.2885" class="difflineminus">-{</span>
<a href="#l3.2886"></a><span id="l3.2886" class="difflineplus">+nsMsgAccountManager::SetFolderDoingCleanupInbox(nsIMsgFolder *folder) {</span>
<a href="#l3.2887"></a><span id="l3.2887">   m_folderDoingCleanupInbox = folder;</span>
<a href="#l3.2888"></a><span id="l3.2888">   m_cleanupInboxInProgress = true;</span>
<a href="#l3.2889"></a><span id="l3.2889">   return NS_OK;</span>
<a href="#l3.2890"></a><span id="l3.2890"> }</span>
<a href="#l3.2891"></a><span id="l3.2891"> </span>
<a href="#l3.2892"></a><span id="l3.2892"> NS_IMETHODIMP</span>
<a href="#l3.2893"></a><span id="l3.2893" class="difflineminus">-nsMsgAccountManager::GetCleanupInboxInProgress(bool *bVal)</span>
<a href="#l3.2894"></a><span id="l3.2894" class="difflineminus">-{</span>
<a href="#l3.2895"></a><span id="l3.2895" class="difflineplus">+nsMsgAccountManager::GetCleanupInboxInProgress(bool *bVal) {</span>
<a href="#l3.2896"></a><span id="l3.2896">   NS_ENSURE_ARG_POINTER(bVal);</span>
<a href="#l3.2897"></a><span id="l3.2897">   *bVal = m_cleanupInboxInProgress;</span>
<a href="#l3.2898"></a><span id="l3.2898">   return NS_OK;</span>
<a href="#l3.2899"></a><span id="l3.2899"> }</span>
<a href="#l3.2900"></a><span id="l3.2900"> </span>
<a href="#l3.2901"></a><span id="l3.2901" class="difflineminus">-void</span>
<a href="#l3.2902"></a><span id="l3.2902" class="difflineminus">-nsMsgAccountManager::SetLastServerFound(nsIMsgIncomingServer *server, const nsACString&amp; hostname,</span>
<a href="#l3.2903"></a><span id="l3.2903" class="difflineminus">-                                        const nsACString&amp; username, const int32_t port, const nsACString&amp; type)</span>
<a href="#l3.2904"></a><span id="l3.2904" class="difflineminus">-{</span>
<a href="#l3.2905"></a><span id="l3.2905" class="difflineplus">+void nsMsgAccountManager::SetLastServerFound(nsIMsgIncomingServer *server,</span>
<a href="#l3.2906"></a><span id="l3.2906" class="difflineplus">+                                             const nsACString &amp;hostname,</span>
<a href="#l3.2907"></a><span id="l3.2907" class="difflineplus">+                                             const nsACString &amp;username,</span>
<a href="#l3.2908"></a><span id="l3.2908" class="difflineplus">+                                             const int32_t port,</span>
<a href="#l3.2909"></a><span id="l3.2909" class="difflineplus">+                                             const nsACString &amp;type) {</span>
<a href="#l3.2910"></a><span id="l3.2910">   m_lastFindServerResult = server;</span>
<a href="#l3.2911"></a><span id="l3.2911">   m_lastFindServerHostName = hostname;</span>
<a href="#l3.2912"></a><span id="l3.2912">   m_lastFindServerUserName = username;</span>
<a href="#l3.2913"></a><span id="l3.2913">   m_lastFindServerPort = port;</span>
<a href="#l3.2914"></a><span id="l3.2914">   m_lastFindServerType = type;</span>
<a href="#l3.2915"></a><span id="l3.2915"> }</span>
<a href="#l3.2916"></a><span id="l3.2916"> </span>
<a href="#l3.2917"></a><span id="l3.2917"> NS_IMETHODIMP</span>
<a href="#l3.2918"></a><span id="l3.2918" class="difflineminus">-nsMsgAccountManager::SaveAccountInfo()</span>
<a href="#l3.2919"></a><span id="l3.2919" class="difflineminus">-{</span>
<a href="#l3.2920"></a><span id="l3.2920" class="difflineplus">+nsMsgAccountManager::SaveAccountInfo() {</span>
<a href="#l3.2921"></a><span id="l3.2921">   nsresult rv;</span>
<a href="#l3.2922"></a><span id="l3.2922">   nsCOMPtr&lt;nsIPrefService&gt; pref(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l3.2923"></a><span id="l3.2923" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l3.2924"></a><span id="l3.2924" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.2925"></a><span id="l3.2925">   return pref-&gt;SavePrefFile(nullptr);</span>
<a href="#l3.2926"></a><span id="l3.2926"> }</span>
<a href="#l3.2927"></a><span id="l3.2927"> </span>
<a href="#l3.2928"></a><span id="l3.2928"> NS_IMETHODIMP</span>
<a href="#l3.2929"></a><span id="l3.2929" class="difflineminus">-nsMsgAccountManager::GetChromePackageName(const nsACString&amp; aExtensionName, nsACString&amp; aChromePackageName)</span>
<a href="#l3.2930"></a><span id="l3.2930" class="difflineminus">-{</span>
<a href="#l3.2931"></a><span id="l3.2931" class="difflineplus">+nsMsgAccountManager::GetChromePackageName(const nsACString &amp;aExtensionName,</span>
<a href="#l3.2932"></a><span id="l3.2932" class="difflineplus">+                                          nsACString &amp;aChromePackageName) {</span>
<a href="#l3.2933"></a><span id="l3.2933">   nsresult rv;</span>
<a href="#l3.2934"></a><span id="l3.2934" class="difflineminus">-  nsCOMPtr&lt;nsICategoryManager&gt; catman = do_GetService(NS_CATEGORYMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l3.2935"></a><span id="l3.2935" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l3.2936"></a><span id="l3.2936" class="difflineplus">+  nsCOMPtr&lt;nsICategoryManager&gt; catman =</span>
<a href="#l3.2937"></a><span id="l3.2937" class="difflineplus">+      do_GetService(NS_CATEGORYMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l3.2938"></a><span id="l3.2938" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.2939"></a><span id="l3.2939"> </span>
<a href="#l3.2940"></a><span id="l3.2940">   nsCOMPtr&lt;nsISimpleEnumerator&gt; e;</span>
<a href="#l3.2941"></a><span id="l3.2941" class="difflineminus">-  rv = catman-&gt;EnumerateCategory(MAILNEWS_ACCOUNTMANAGER_EXTENSIONS, getter_AddRefs(e));</span>
<a href="#l3.2942"></a><span id="l3.2942" class="difflineminus">-  if(NS_SUCCEEDED(rv) &amp;&amp; e) {</span>
<a href="#l3.2943"></a><span id="l3.2943" class="difflineplus">+  rv = catman-&gt;EnumerateCategory(MAILNEWS_ACCOUNTMANAGER_EXTENSIONS,</span>
<a href="#l3.2944"></a><span id="l3.2944" class="difflineplus">+                                 getter_AddRefs(e));</span>
<a href="#l3.2945"></a><span id="l3.2945" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; e) {</span>
<a href="#l3.2946"></a><span id="l3.2946">     while (true) {</span>
<a href="#l3.2947"></a><span id="l3.2947">       nsCOMPtr&lt;nsISupports&gt; supports;</span>
<a href="#l3.2948"></a><span id="l3.2948">       rv = e-&gt;GetNext(getter_AddRefs(supports));</span>
<a href="#l3.2949"></a><span id="l3.2949">       nsCOMPtr&lt;nsISupportsCString&gt; catEntry = do_QueryInterface(supports);</span>
<a href="#l3.2950"></a><span id="l3.2950" class="difflineminus">-      if (NS_FAILED(rv) || !catEntry)</span>
<a href="#l3.2951"></a><span id="l3.2951" class="difflineminus">-        break;</span>
<a href="#l3.2952"></a><span id="l3.2952" class="difflineplus">+      if (NS_FAILED(rv) || !catEntry) break;</span>
<a href="#l3.2953"></a><span id="l3.2953"> </span>
<a href="#l3.2954"></a><span id="l3.2954">       nsAutoCString entryString;</span>
<a href="#l3.2955"></a><span id="l3.2955">       rv = catEntry-&gt;GetData(entryString);</span>
<a href="#l3.2956"></a><span id="l3.2956" class="difflineminus">-      if (NS_FAILED(rv))</span>
<a href="#l3.2957"></a><span id="l3.2957" class="difflineminus">-         break;</span>
<a href="#l3.2958"></a><span id="l3.2958" class="difflineplus">+      if (NS_FAILED(rv)) break;</span>
<a href="#l3.2959"></a><span id="l3.2959"> </span>
<a href="#l3.2960"></a><span id="l3.2960">       nsCString contractidString;</span>
<a href="#l3.2961"></a><span id="l3.2961" class="difflineminus">-      rv = catman-&gt;GetCategoryEntry(MAILNEWS_ACCOUNTMANAGER_EXTENSIONS, entryString,</span>
<a href="#l3.2962"></a><span id="l3.2962" class="difflineminus">-                                    contractidString);</span>
<a href="#l3.2963"></a><span id="l3.2963" class="difflineminus">-      if (NS_FAILED(rv))</span>
<a href="#l3.2964"></a><span id="l3.2964" class="difflineminus">-        break;</span>
<a href="#l3.2965"></a><span id="l3.2965" class="difflineminus">-</span>
<a href="#l3.2966"></a><span id="l3.2966" class="difflineminus">-      nsCOMPtr &lt;nsIMsgAccountManagerExtension&gt; extension = do_GetService(contractidString.get(), &amp;rv);</span>
<a href="#l3.2967"></a><span id="l3.2967" class="difflineminus">-      if (NS_FAILED(rv) || !extension)</span>
<a href="#l3.2968"></a><span id="l3.2968" class="difflineminus">-        break;</span>
<a href="#l3.2969"></a><span id="l3.2969" class="difflineplus">+      rv = catman-&gt;GetCategoryEntry(MAILNEWS_ACCOUNTMANAGER_EXTENSIONS,</span>
<a href="#l3.2970"></a><span id="l3.2970" class="difflineplus">+                                    entryString, contractidString);</span>
<a href="#l3.2971"></a><span id="l3.2971" class="difflineplus">+      if (NS_FAILED(rv)) break;</span>
<a href="#l3.2972"></a><span id="l3.2972" class="difflineplus">+</span>
<a href="#l3.2973"></a><span id="l3.2973" class="difflineplus">+      nsCOMPtr&lt;nsIMsgAccountManagerExtension&gt; extension =</span>
<a href="#l3.2974"></a><span id="l3.2974" class="difflineplus">+          do_GetService(contractidString.get(), &amp;rv);</span>
<a href="#l3.2975"></a><span id="l3.2975" class="difflineplus">+      if (NS_FAILED(rv) || !extension) break;</span>
<a href="#l3.2976"></a><span id="l3.2976"> </span>
<a href="#l3.2977"></a><span id="l3.2977">       nsCString name;</span>
<a href="#l3.2978"></a><span id="l3.2978">       rv = extension-&gt;GetName(name);</span>
<a href="#l3.2979"></a><span id="l3.2979" class="difflineminus">-      if (NS_FAILED(rv))</span>
<a href="#l3.2980"></a><span id="l3.2980" class="difflineminus">-        break;</span>
<a href="#l3.2981"></a><span id="l3.2981" class="difflineplus">+      if (NS_FAILED(rv)) break;</span>
<a href="#l3.2982"></a><span id="l3.2982"> </span>
<a href="#l3.2983"></a><span id="l3.2983">       if (name.Equals(aExtensionName))</span>
<a href="#l3.2984"></a><span id="l3.2984">         return extension-&gt;GetChromePackageName(aChromePackageName);</span>
<a href="#l3.2985"></a><span id="l3.2985">     }</span>
<a href="#l3.2986"></a><span id="l3.2986">   }</span>
<a href="#l3.2987"></a><span id="l3.2987">   return NS_ERROR_UNEXPECTED;</span>
<a href="#l3.2988"></a><span id="l3.2988"> }</span>
<a href="#l3.2989"></a><span id="l3.2989"> </span>
<a href="#l3.2990"></a><span id="l3.2990" class="difflineminus">-class VFChangeListenerEvent : public mozilla::Runnable</span>
<a href="#l3.2991"></a><span id="l3.2991" class="difflineminus">-{</span>
<a href="#l3.2992"></a><span id="l3.2992" class="difflineminus">-public:</span>
<a href="#l3.2993"></a><span id="l3.2993" class="difflineplus">+class VFChangeListenerEvent : public mozilla::Runnable {</span>
<a href="#l3.2994"></a><span id="l3.2994" class="difflineplus">+ public:</span>
<a href="#l3.2995"></a><span id="l3.2995">   VFChangeListenerEvent(VirtualFolderChangeListener *vfChangeListener,</span>
<a href="#l3.2996"></a><span id="l3.2996">                         nsIMsgFolder *virtFolder, nsIMsgDatabase *virtDB)</span>
<a href="#l3.2997"></a><span id="l3.2997" class="difflineminus">-    : mozilla::Runnable(&quot;VFChangeListenerEvent&quot;)</span>
<a href="#l3.2998"></a><span id="l3.2998" class="difflineminus">-    , mVFChangeListener(vfChangeListener), mFolder(virtFolder), mDB(virtDB)</span>
<a href="#l3.2999"></a><span id="l3.2999" class="difflineminus">-  {}</span>
<a href="#l3.3000"></a><span id="l3.3000" class="difflineminus">-</span>
<a href="#l3.3001"></a><span id="l3.3001" class="difflineminus">-  NS_IMETHOD Run()</span>
<a href="#l3.3002"></a><span id="l3.3002" class="difflineminus">-  {</span>
<a href="#l3.3003"></a><span id="l3.3003" class="difflineminus">-    if (mVFChangeListener)</span>
<a href="#l3.3004"></a><span id="l3.3004" class="difflineminus">-      mVFChangeListener-&gt;ProcessUpdateEvent(mFolder, mDB);</span>
<a href="#l3.3005"></a><span id="l3.3005" class="difflineplus">+      : mozilla::Runnable(&quot;VFChangeListenerEvent&quot;),</span>
<a href="#l3.3006"></a><span id="l3.3006" class="difflineplus">+        mVFChangeListener(vfChangeListener),</span>
<a href="#l3.3007"></a><span id="l3.3007" class="difflineplus">+        mFolder(virtFolder),</span>
<a href="#l3.3008"></a><span id="l3.3008" class="difflineplus">+        mDB(virtDB) {}</span>
<a href="#l3.3009"></a><span id="l3.3009" class="difflineplus">+</span>
<a href="#l3.3010"></a><span id="l3.3010" class="difflineplus">+  NS_IMETHOD Run() {</span>
<a href="#l3.3011"></a><span id="l3.3011" class="difflineplus">+    if (mVFChangeListener) mVFChangeListener-&gt;ProcessUpdateEvent(mFolder, mDB);</span>
<a href="#l3.3012"></a><span id="l3.3012">     return NS_OK;</span>
<a href="#l3.3013"></a><span id="l3.3013">   }</span>
<a href="#l3.3014"></a><span id="l3.3014"> </span>
<a href="#l3.3015"></a><span id="l3.3015" class="difflineminus">-private:</span>
<a href="#l3.3016"></a><span id="l3.3016" class="difflineplus">+ private:</span>
<a href="#l3.3017"></a><span id="l3.3017">   RefPtr&lt;VirtualFolderChangeListener&gt; mVFChangeListener;</span>
<a href="#l3.3018"></a><span id="l3.3018">   nsCOMPtr&lt;nsIMsgFolder&gt; mFolder;</span>
<a href="#l3.3019"></a><span id="l3.3019">   nsCOMPtr&lt;nsIMsgDatabase&gt; mDB;</span>
<a href="#l3.3020"></a><span id="l3.3020"> };</span>
<a href="#l3.3021"></a><span id="l3.3021"> </span>
<a href="#l3.3022"></a><span id="l3.3022"> NS_IMPL_ISUPPORTS(VirtualFolderChangeListener, nsIDBChangeListener)</span>
<a href="#l3.3023"></a><span id="l3.3023"> </span>
<a href="#l3.3024"></a><span id="l3.3024" class="difflineminus">-VirtualFolderChangeListener::VirtualFolderChangeListener() :</span>
<a href="#l3.3025"></a><span id="l3.3025" class="difflineminus">-  m_searchOnMsgStatus(false), m_batchingEvents(false)</span>
<a href="#l3.3026"></a><span id="l3.3026" class="difflineminus">-{}</span>
<a href="#l3.3027"></a><span id="l3.3027" class="difflineminus">-</span>
<a href="#l3.3028"></a><span id="l3.3028" class="difflineminus">-nsresult VirtualFolderChangeListener::Init()</span>
<a href="#l3.3029"></a><span id="l3.3029" class="difflineminus">-{</span>
<a href="#l3.3030"></a><span id="l3.3030" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDatabase&gt; msgDB;</span>
<a href="#l3.3031"></a><span id="l3.3031" class="difflineminus">-  nsCOMPtr &lt;nsIDBFolderInfo&gt; dbFolderInfo;</span>
<a href="#l3.3032"></a><span id="l3.3032" class="difflineminus">-</span>
<a href="#l3.3033"></a><span id="l3.3033" class="difflineminus">-  nsresult rv = m_virtualFolder-&gt;GetDBFolderInfoAndDB(getter_AddRefs(dbFolderInfo), getter_AddRefs(msgDB));</span>
<a href="#l3.3034"></a><span id="l3.3034" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; msgDB)</span>
<a href="#l3.3035"></a><span id="l3.3035" class="difflineminus">-  {</span>
<a href="#l3.3036"></a><span id="l3.3036" class="difflineplus">+VirtualFolderChangeListener::VirtualFolderChangeListener()</span>
<a href="#l3.3037"></a><span id="l3.3037" class="difflineplus">+    : m_searchOnMsgStatus(false), m_batchingEvents(false) {}</span>
<a href="#l3.3038"></a><span id="l3.3038" class="difflineplus">+</span>
<a href="#l3.3039"></a><span id="l3.3039" class="difflineplus">+nsresult VirtualFolderChangeListener::Init() {</span>
<a href="#l3.3040"></a><span id="l3.3040" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDatabase&gt; msgDB;</span>
<a href="#l3.3041"></a><span id="l3.3041" class="difflineplus">+  nsCOMPtr&lt;nsIDBFolderInfo&gt; dbFolderInfo;</span>
<a href="#l3.3042"></a><span id="l3.3042" class="difflineplus">+</span>
<a href="#l3.3043"></a><span id="l3.3043" class="difflineplus">+  nsresult rv = m_virtualFolder-&gt;GetDBFolderInfoAndDB(</span>
<a href="#l3.3044"></a><span id="l3.3044" class="difflineplus">+      getter_AddRefs(dbFolderInfo), getter_AddRefs(msgDB));</span>
<a href="#l3.3045"></a><span id="l3.3045" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; msgDB) {</span>
<a href="#l3.3046"></a><span id="l3.3046">     nsCString searchTermString;</span>
<a href="#l3.3047"></a><span id="l3.3047">     dbFolderInfo-&gt;GetCharProperty(&quot;searchStr&quot;, searchTermString);</span>
<a href="#l3.3048"></a><span id="l3.3048" class="difflineminus">-    nsCOMPtr&lt;nsIMsgFilterService&gt; filterService = do_GetService(NS_MSGFILTERSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l3.3049"></a><span id="l3.3049" class="difflineplus">+    nsCOMPtr&lt;nsIMsgFilterService&gt; filterService =</span>
<a href="#l3.3050"></a><span id="l3.3050" class="difflineplus">+        do_GetService(NS_MSGFILTERSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l3.3051"></a><span id="l3.3051">     nsCOMPtr&lt;nsIMsgFilterList&gt; filterList;</span>
<a href="#l3.3052"></a><span id="l3.3052" class="difflineminus">-    rv = filterService-&gt;GetTempFilterList(m_virtualFolder, getter_AddRefs(filterList));</span>
<a href="#l3.3053"></a><span id="l3.3053" class="difflineplus">+    rv = filterService-&gt;GetTempFilterList(m_virtualFolder,</span>
<a href="#l3.3054"></a><span id="l3.3054" class="difflineplus">+                                          getter_AddRefs(filterList));</span>
<a href="#l3.3055"></a><span id="l3.3055">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.3056"></a><span id="l3.3056" class="difflineminus">-    nsCOMPtr &lt;nsIMsgFilter&gt; tempFilter;</span>
<a href="#l3.3057"></a><span id="l3.3057" class="difflineminus">-    filterList-&gt;CreateFilter(NS_LITERAL_STRING(&quot;temp&quot;), getter_AddRefs(tempFilter));</span>
<a href="#l3.3058"></a><span id="l3.3058" class="difflineplus">+    nsCOMPtr&lt;nsIMsgFilter&gt; tempFilter;</span>
<a href="#l3.3059"></a><span id="l3.3059" class="difflineplus">+    filterList-&gt;CreateFilter(NS_LITERAL_STRING(&quot;temp&quot;),</span>
<a href="#l3.3060"></a><span id="l3.3060" class="difflineplus">+                             getter_AddRefs(tempFilter));</span>
<a href="#l3.3061"></a><span id="l3.3061">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.3062"></a><span id="l3.3062">     filterList-&gt;ParseCondition(tempFilter, searchTermString.get());</span>
<a href="#l3.3063"></a><span id="l3.3063">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.3064"></a><span id="l3.3064">     m_searchSession = do_CreateInstance(NS_MSGSEARCHSESSION_CONTRACTID, &amp;rv);</span>
<a href="#l3.3065"></a><span id="l3.3065">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.3066"></a><span id="l3.3066"> </span>
<a href="#l3.3067"></a><span id="l3.3067">     nsCOMPtr&lt;nsIMutableArray&gt; searchTerms;</span>
<a href="#l3.3068"></a><span id="l3.3068">     rv = tempFilter-&gt;GetSearchTerms(getter_AddRefs(searchTerms));</span>
<a href="#l3.3069"></a><span id="l3.3069" class="difflineat">@@ -2548,561 +2335,528 @@ nsresult VirtualFolderChangeListener::In</span>
<a href="#l3.3070"></a><span id="l3.3070">     // we add the search scope right before we match the header,</span>
<a href="#l3.3071"></a><span id="l3.3071">     // because we don't want the search scope caching the body input</span>
<a href="#l3.3072"></a><span id="l3.3072">     // stream, because that holds onto the mailbox file, breaking</span>
<a href="#l3.3073"></a><span id="l3.3073">     // compaction.</span>
<a href="#l3.3074"></a><span id="l3.3074"> </span>
<a href="#l3.3075"></a><span id="l3.3075">     // add each item in termsArray to the search session</span>
<a href="#l3.3076"></a><span id="l3.3076">     uint32_t numTerms;</span>
<a href="#l3.3077"></a><span id="l3.3077">     searchTerms-&gt;Count(&amp;numTerms);</span>
<a href="#l3.3078"></a><span id="l3.3078" class="difflineminus">-    for (uint32_t i = 0; i &lt; numTerms; i++)</span>
<a href="#l3.3079"></a><span id="l3.3079" class="difflineminus">-    {</span>
<a href="#l3.3080"></a><span id="l3.3080" class="difflineplus">+    for (uint32_t i = 0; i &lt; numTerms; i++) {</span>
<a href="#l3.3081"></a><span id="l3.3081">       nsCOMPtr&lt;nsIMsgSearchTerm&gt; searchTerm(do_QueryElementAt(searchTerms, i));</span>
<a href="#l3.3082"></a><span id="l3.3082">       nsMsgSearchAttribValue attrib;</span>
<a href="#l3.3083"></a><span id="l3.3083">       searchTerm-&gt;GetAttrib(&amp;attrib);</span>
<a href="#l3.3084"></a><span id="l3.3084" class="difflineminus">-      if (attrib == nsMsgSearchAttrib::MsgStatus)</span>
<a href="#l3.3085"></a><span id="l3.3085" class="difflineminus">-        m_searchOnMsgStatus = true;</span>
<a href="#l3.3086"></a><span id="l3.3086" class="difflineplus">+      if (attrib == nsMsgSearchAttrib::MsgStatus) m_searchOnMsgStatus = true;</span>
<a href="#l3.3087"></a><span id="l3.3087">       m_searchSession-&gt;AppendTerm(searchTerm);</span>
<a href="#l3.3088"></a><span id="l3.3088">     }</span>
<a href="#l3.3089"></a><span id="l3.3089">   }</span>
<a href="#l3.3090"></a><span id="l3.3090">   return rv;</span>
<a href="#l3.3091"></a><span id="l3.3091"> }</span>
<a href="#l3.3092"></a><span id="l3.3092"> </span>
<a href="#l3.3093"></a><span id="l3.3093" class="difflineminus">-  /**</span>
<a href="#l3.3094"></a><span id="l3.3094" class="difflineminus">-   * nsIDBChangeListener</span>
<a href="#l3.3095"></a><span id="l3.3095" class="difflineminus">-   */</span>
<a href="#l3.3096"></a><span id="l3.3096" class="difflineplus">+/**</span>
<a href="#l3.3097"></a><span id="l3.3097" class="difflineplus">+ * nsIDBChangeListener</span>
<a href="#l3.3098"></a><span id="l3.3098" class="difflineplus">+ */</span>
<a href="#l3.3099"></a><span id="l3.3099"> </span>
<a href="#l3.3100"></a><span id="l3.3100"> NS_IMETHODIMP</span>
<a href="#l3.3101"></a><span id="l3.3101" class="difflineminus">-VirtualFolderChangeListener::OnHdrPropertyChanged(nsIMsgDBHdr *aHdrChanged, bool aPreChange, uint32_t *aStatus,</span>
<a href="#l3.3102"></a><span id="l3.3102" class="difflineminus">-                                                 nsIDBChangeListener *aInstigator)</span>
<a href="#l3.3103"></a><span id="l3.3103" class="difflineminus">-{</span>
<a href="#l3.3104"></a><span id="l3.3104" class="difflineplus">+VirtualFolderChangeListener::OnHdrPropertyChanged(</span>
<a href="#l3.3105"></a><span id="l3.3105" class="difflineplus">+    nsIMsgDBHdr *aHdrChanged, bool aPreChange, uint32_t *aStatus,</span>
<a href="#l3.3106"></a><span id="l3.3106" class="difflineplus">+    nsIDBChangeListener *aInstigator) {</span>
<a href="#l3.3107"></a><span id="l3.3107">   const uint32_t kMatch = 0x1;</span>
<a href="#l3.3108"></a><span id="l3.3108">   const uint32_t kRead = 0x2;</span>
<a href="#l3.3109"></a><span id="l3.3109">   const uint32_t kNew = 0x4;</span>
<a href="#l3.3110"></a><span id="l3.3110">   NS_ENSURE_ARG_POINTER(aHdrChanged);</span>
<a href="#l3.3111"></a><span id="l3.3111">   NS_ENSURE_ARG_POINTER(aStatus);</span>
<a href="#l3.3112"></a><span id="l3.3112"> </span>
<a href="#l3.3113"></a><span id="l3.3113">   uint32_t flags;</span>
<a href="#l3.3114"></a><span id="l3.3114">   bool match;</span>
<a href="#l3.3115"></a><span id="l3.3115">   nsCOMPtr&lt;nsIMsgDatabase&gt; msgDB;</span>
<a href="#l3.3116"></a><span id="l3.3116">   nsresult rv = m_folderWatching-&gt;GetMsgDatabase(getter_AddRefs(msgDB));</span>
<a href="#l3.3117"></a><span id="l3.3117">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.3118"></a><span id="l3.3118">   // we don't want any early returns from this function, until we've</span>
<a href="#l3.3119"></a><span id="l3.3119">   // called ClearScopes on the search session.</span>
<a href="#l3.3120"></a><span id="l3.3120" class="difflineminus">-  m_searchSession-&gt;AddScopeTerm(nsMsgSearchScope::offlineMail, m_folderWatching);</span>
<a href="#l3.3121"></a><span id="l3.3121" class="difflineplus">+  m_searchSession-&gt;AddScopeTerm(nsMsgSearchScope::offlineMail,</span>
<a href="#l3.3122"></a><span id="l3.3122" class="difflineplus">+                                m_folderWatching);</span>
<a href="#l3.3123"></a><span id="l3.3123">   rv = m_searchSession-&gt;MatchHdr(aHdrChanged, msgDB, &amp;match);</span>
<a href="#l3.3124"></a><span id="l3.3124">   m_searchSession-&gt;ClearScopes();</span>
<a href="#l3.3125"></a><span id="l3.3125">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.3126"></a><span id="l3.3126">   aHdrChanged-&gt;GetFlags(&amp;flags);</span>
<a href="#l3.3127"></a><span id="l3.3127"> </span>
<a href="#l3.3128"></a><span id="l3.3128" class="difflineminus">-  if (aPreChange) // We're looking at the old header, save status</span>
<a href="#l3.3129"></a><span id="l3.3129" class="difflineplus">+  if (aPreChange)  // We're looking at the old header, save status</span>
<a href="#l3.3130"></a><span id="l3.3130">   {</span>
<a href="#l3.3131"></a><span id="l3.3131">     *aStatus = 0;</span>
<a href="#l3.3132"></a><span id="l3.3132" class="difflineminus">-    if (match)</span>
<a href="#l3.3133"></a><span id="l3.3133" class="difflineminus">-      *aStatus |= kMatch;</span>
<a href="#l3.3134"></a><span id="l3.3134" class="difflineminus">-    if (flags &amp; nsMsgMessageFlags::Read)</span>
<a href="#l3.3135"></a><span id="l3.3135" class="difflineminus">-      *aStatus |= kRead;</span>
<a href="#l3.3136"></a><span id="l3.3136" class="difflineminus">-    if (flags &amp; nsMsgMessageFlags::New)</span>
<a href="#l3.3137"></a><span id="l3.3137" class="difflineminus">-      *aStatus |= kNew;</span>
<a href="#l3.3138"></a><span id="l3.3138" class="difflineplus">+    if (match) *aStatus |= kMatch;</span>
<a href="#l3.3139"></a><span id="l3.3139" class="difflineplus">+    if (flags &amp; nsMsgMessageFlags::Read) *aStatus |= kRead;</span>
<a href="#l3.3140"></a><span id="l3.3140" class="difflineplus">+    if (flags &amp; nsMsgMessageFlags::New) *aStatus |= kNew;</span>
<a href="#l3.3141"></a><span id="l3.3141">     return NS_OK;</span>
<a href="#l3.3142"></a><span id="l3.3142">   }</span>
<a href="#l3.3143"></a><span id="l3.3143"> </span>
<a href="#l3.3144"></a><span id="l3.3144">   // This is the post change section where changes are detected</span>
<a href="#l3.3145"></a><span id="l3.3145"> </span>
<a href="#l3.3146"></a><span id="l3.3146">   bool wasMatch = *aStatus &amp; kMatch;</span>
<a href="#l3.3147"></a><span id="l3.3147" class="difflineminus">-  if (!match &amp;&amp; !wasMatch) // header not in virtual folder</span>
<a href="#l3.3148"></a><span id="l3.3148" class="difflineplus">+  if (!match &amp;&amp; !wasMatch)  // header not in virtual folder</span>
<a href="#l3.3149"></a><span id="l3.3149">     return NS_OK;</span>
<a href="#l3.3150"></a><span id="l3.3150"> </span>
<a href="#l3.3151"></a><span id="l3.3151">   int32_t totalDelta = 0, unreadDelta = 0, newDelta = 0;</span>
<a href="#l3.3152"></a><span id="l3.3152"> </span>
<a href="#l3.3153"></a><span id="l3.3153">   if (match) {</span>
<a href="#l3.3154"></a><span id="l3.3154">     totalDelta++;</span>
<a href="#l3.3155"></a><span id="l3.3155" class="difflineminus">-    if (!(flags &amp; nsMsgMessageFlags::Read))</span>
<a href="#l3.3156"></a><span id="l3.3156" class="difflineminus">-      unreadDelta++;</span>
<a href="#l3.3157"></a><span id="l3.3157" class="difflineminus">-    if (flags &amp; nsMsgMessageFlags::New)</span>
<a href="#l3.3158"></a><span id="l3.3158" class="difflineminus">-      newDelta++;</span>
<a href="#l3.3159"></a><span id="l3.3159" class="difflineplus">+    if (!(flags &amp; nsMsgMessageFlags::Read)) unreadDelta++;</span>
<a href="#l3.3160"></a><span id="l3.3160" class="difflineplus">+    if (flags &amp; nsMsgMessageFlags::New) newDelta++;</span>
<a href="#l3.3161"></a><span id="l3.3161">   }</span>
<a href="#l3.3162"></a><span id="l3.3162"> </span>
<a href="#l3.3163"></a><span id="l3.3163">   if (wasMatch) {</span>
<a href="#l3.3164"></a><span id="l3.3164">     totalDelta--;</span>
<a href="#l3.3165"></a><span id="l3.3165">     if (!(*aStatus &amp; kRead)) unreadDelta--;</span>
<a href="#l3.3166"></a><span id="l3.3166">     if (*aStatus &amp; kNew) newDelta--;</span>
<a href="#l3.3167"></a><span id="l3.3167">   }</span>
<a href="#l3.3168"></a><span id="l3.3168"> </span>
<a href="#l3.3169"></a><span id="l3.3169" class="difflineminus">-  if ( !(unreadDelta || totalDelta || newDelta) )</span>
<a href="#l3.3170"></a><span id="l3.3170" class="difflineminus">-    return NS_OK;</span>
<a href="#l3.3171"></a><span id="l3.3171" class="difflineplus">+  if (!(unreadDelta || totalDelta || newDelta)) return NS_OK;</span>
<a href="#l3.3172"></a><span id="l3.3172"> </span>
<a href="#l3.3173"></a><span id="l3.3173">   nsCOMPtr&lt;nsIMsgDatabase&gt; virtDatabase;</span>
<a href="#l3.3174"></a><span id="l3.3174">   nsCOMPtr&lt;nsIDBFolderInfo&gt; dbFolderInfo;</span>
<a href="#l3.3175"></a><span id="l3.3175">   rv = m_virtualFolder-&gt;GetDBFolderInfoAndDB(getter_AddRefs(dbFolderInfo),</span>
<a href="#l3.3176"></a><span id="l3.3176" class="difflineminus">-                        getter_AddRefs(virtDatabase));</span>
<a href="#l3.3177"></a><span id="l3.3177" class="difflineplus">+                                             getter_AddRefs(virtDatabase));</span>
<a href="#l3.3178"></a><span id="l3.3178">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.3179"></a><span id="l3.3179"> </span>
<a href="#l3.3180"></a><span id="l3.3180" class="difflineminus">-  if (unreadDelta)</span>
<a href="#l3.3181"></a><span id="l3.3181" class="difflineminus">-    dbFolderInfo-&gt;ChangeNumUnreadMessages(unreadDelta);</span>
<a href="#l3.3182"></a><span id="l3.3182" class="difflineminus">-</span>
<a href="#l3.3183"></a><span id="l3.3183" class="difflineminus">-  if (newDelta)</span>
<a href="#l3.3184"></a><span id="l3.3184" class="difflineminus">-  {</span>
<a href="#l3.3185"></a><span id="l3.3185" class="difflineplus">+  if (unreadDelta) dbFolderInfo-&gt;ChangeNumUnreadMessages(unreadDelta);</span>
<a href="#l3.3186"></a><span id="l3.3186" class="difflineplus">+</span>
<a href="#l3.3187"></a><span id="l3.3187" class="difflineplus">+  if (newDelta) {</span>
<a href="#l3.3188"></a><span id="l3.3188">     int32_t numNewMessages;</span>
<a href="#l3.3189"></a><span id="l3.3189">     m_virtualFolder-&gt;GetNumNewMessages(false, &amp;numNewMessages);</span>
<a href="#l3.3190"></a><span id="l3.3190">     m_virtualFolder-&gt;SetNumNewMessages(numNewMessages + newDelta);</span>
<a href="#l3.3191"></a><span id="l3.3191">     m_virtualFolder-&gt;SetHasNewMessages(numNewMessages + newDelta &gt; 0);</span>
<a href="#l3.3192"></a><span id="l3.3192">   }</span>
<a href="#l3.3193"></a><span id="l3.3193"> </span>
<a href="#l3.3194"></a><span id="l3.3194" class="difflineminus">-  if (totalDelta)</span>
<a href="#l3.3195"></a><span id="l3.3195" class="difflineminus">-  {</span>
<a href="#l3.3196"></a><span id="l3.3196" class="difflineplus">+  if (totalDelta) {</span>
<a href="#l3.3197"></a><span id="l3.3197">     dbFolderInfo-&gt;ChangeNumMessages(totalDelta);</span>
<a href="#l3.3198"></a><span id="l3.3198">     nsCString searchUri;</span>
<a href="#l3.3199"></a><span id="l3.3199">     m_virtualFolder-&gt;GetURI(searchUri);</span>
<a href="#l3.3200"></a><span id="l3.3200">     msgDB-&gt;UpdateHdrInCache(searchUri.get(), aHdrChanged, totalDelta == 1);</span>
<a href="#l3.3201"></a><span id="l3.3201">   }</span>
<a href="#l3.3202"></a><span id="l3.3202"> </span>
<a href="#l3.3203"></a><span id="l3.3203" class="difflineminus">-    PostUpdateEvent(m_virtualFolder, virtDatabase);</span>
<a href="#l3.3204"></a><span id="l3.3204" class="difflineplus">+  PostUpdateEvent(m_virtualFolder, virtDatabase);</span>
<a href="#l3.3205"></a><span id="l3.3205"> </span>
<a href="#l3.3206"></a><span id="l3.3206">   return NS_OK;</span>
<a href="#l3.3207"></a><span id="l3.3207"> }</span>
<a href="#l3.3208"></a><span id="l3.3208"> </span>
<a href="#l3.3209"></a><span id="l3.3209" class="difflineminus">-void VirtualFolderChangeListener::DecrementNewMsgCount()</span>
<a href="#l3.3210"></a><span id="l3.3210" class="difflineminus">-{</span>
<a href="#l3.3211"></a><span id="l3.3211" class="difflineplus">+void VirtualFolderChangeListener::DecrementNewMsgCount() {</span>
<a href="#l3.3212"></a><span id="l3.3212">   int32_t numNewMessages;</span>
<a href="#l3.3213"></a><span id="l3.3213">   m_virtualFolder-&gt;GetNumNewMessages(false, &amp;numNewMessages);</span>
<a href="#l3.3214"></a><span id="l3.3214" class="difflineminus">-  if (numNewMessages &gt; 0)</span>
<a href="#l3.3215"></a><span id="l3.3215" class="difflineminus">-    numNewMessages--;</span>
<a href="#l3.3216"></a><span id="l3.3216" class="difflineplus">+  if (numNewMessages &gt; 0) numNewMessages--;</span>
<a href="#l3.3217"></a><span id="l3.3217">   m_virtualFolder-&gt;SetNumNewMessages(numNewMessages);</span>
<a href="#l3.3218"></a><span id="l3.3218" class="difflineminus">-  if (!numNewMessages)</span>
<a href="#l3.3219"></a><span id="l3.3219" class="difflineminus">-    m_virtualFolder-&gt;SetHasNewMessages(false);</span>
<a href="#l3.3220"></a><span id="l3.3220" class="difflineplus">+  if (!numNewMessages) m_virtualFolder-&gt;SetHasNewMessages(false);</span>
<a href="#l3.3221"></a><span id="l3.3221"> }</span>
<a href="#l3.3222"></a><span id="l3.3222"> </span>
<a href="#l3.3223"></a><span id="l3.3223" class="difflineminus">-NS_IMETHODIMP VirtualFolderChangeListener::OnHdrFlagsChanged(nsIMsgDBHdr *aHdrChanged, uint32_t aOldFlags, uint32_t aNewFlags, nsIDBChangeListener *aInstigator)</span>
<a href="#l3.3224"></a><span id="l3.3224" class="difflineminus">-{</span>
<a href="#l3.3225"></a><span id="l3.3225" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDatabase&gt; msgDB;</span>
<a href="#l3.3226"></a><span id="l3.3226" class="difflineplus">+NS_IMETHODIMP VirtualFolderChangeListener::OnHdrFlagsChanged(</span>
<a href="#l3.3227"></a><span id="l3.3227" class="difflineplus">+    nsIMsgDBHdr *aHdrChanged, uint32_t aOldFlags, uint32_t aNewFlags,</span>
<a href="#l3.3228"></a><span id="l3.3228" class="difflineplus">+    nsIDBChangeListener *aInstigator) {</span>
<a href="#l3.3229"></a><span id="l3.3229" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDatabase&gt; msgDB;</span>
<a href="#l3.3230"></a><span id="l3.3230"> </span>
<a href="#l3.3231"></a><span id="l3.3231">   nsresult rv = m_folderWatching-&gt;GetMsgDatabase(getter_AddRefs(msgDB));</span>
<a href="#l3.3232"></a><span id="l3.3232">   bool oldMatch = false, newMatch = false;</span>
<a href="#l3.3233"></a><span id="l3.3233">   // we don't want any early returns from this function, until we've</span>
<a href="#l3.3234"></a><span id="l3.3234">   // called ClearScopes 0n the search session.</span>
<a href="#l3.3235"></a><span id="l3.3235" class="difflineminus">-  m_searchSession-&gt;AddScopeTerm(nsMsgSearchScope::offlineMail, m_folderWatching);</span>
<a href="#l3.3236"></a><span id="l3.3236" class="difflineplus">+  m_searchSession-&gt;AddScopeTerm(nsMsgSearchScope::offlineMail,</span>
<a href="#l3.3237"></a><span id="l3.3237" class="difflineplus">+                                m_folderWatching);</span>
<a href="#l3.3238"></a><span id="l3.3238">   rv = m_searchSession-&gt;MatchHdr(aHdrChanged, msgDB, &amp;newMatch);</span>
<a href="#l3.3239"></a><span id="l3.3239" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; m_searchOnMsgStatus)</span>
<a href="#l3.3240"></a><span id="l3.3240" class="difflineminus">-  {</span>
<a href="#l3.3241"></a><span id="l3.3241" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; m_searchOnMsgStatus) {</span>
<a href="#l3.3242"></a><span id="l3.3242">     // if status is a search criteria, check if the header matched before</span>
<a href="#l3.3243"></a><span id="l3.3243">     // it changed, in order to determine if we need to bump the counts.</span>
<a href="#l3.3244"></a><span id="l3.3244">     aHdrChanged-&gt;SetFlags(aOldFlags);</span>
<a href="#l3.3245"></a><span id="l3.3245">     rv = m_searchSession-&gt;MatchHdr(aHdrChanged, msgDB, &amp;oldMatch);</span>
<a href="#l3.3246"></a><span id="l3.3246" class="difflineminus">-    aHdrChanged-&gt;SetFlags(aNewFlags); // restore new flags even on match failure.</span>
<a href="#l3.3247"></a><span id="l3.3247" class="difflineminus">-  }</span>
<a href="#l3.3248"></a><span id="l3.3248" class="difflineminus">-  else</span>
<a href="#l3.3249"></a><span id="l3.3249" class="difflineplus">+    // restore new flags even on match failure.</span>
<a href="#l3.3250"></a><span id="l3.3250" class="difflineplus">+    aHdrChanged-&gt;SetFlags(aNewFlags);</span>
<a href="#l3.3251"></a><span id="l3.3251" class="difflineplus">+  } else</span>
<a href="#l3.3252"></a><span id="l3.3252">     oldMatch = newMatch;</span>
<a href="#l3.3253"></a><span id="l3.3253">   m_searchSession-&gt;ClearScopes();</span>
<a href="#l3.3254"></a><span id="l3.3254">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.3255"></a><span id="l3.3255" class="difflineminus">-  // we don't want to change the total counts if this virtual folder is open in a view,</span>
<a href="#l3.3256"></a><span id="l3.3256" class="difflineminus">-  // because we won't remove the header from view while it's open. On the other hand,</span>
<a href="#l3.3257"></a><span id="l3.3257" class="difflineminus">-  // it's hard to fix the count when the user clicks away to another folder, w/o re-running</span>
<a href="#l3.3258"></a><span id="l3.3258" class="difflineminus">-  // the search, or setting some sort of pending count change.</span>
<a href="#l3.3259"></a><span id="l3.3259" class="difflineminus">-  // Maybe this needs to be handled in the view code...the view could do the same calculation</span>
<a href="#l3.3260"></a><span id="l3.3260" class="difflineminus">-  // and also keep track of the counts changed. Then, when the view was closed, if it's a virtual</span>
<a href="#l3.3261"></a><span id="l3.3261" class="difflineminus">-  // folder, it could update the counts for the db.</span>
<a href="#l3.3262"></a><span id="l3.3262" class="difflineminus">-  if (oldMatch != newMatch || (oldMatch &amp;&amp; (aOldFlags &amp; nsMsgMessageFlags::Read) != (aNewFlags &amp; nsMsgMessageFlags::Read)))</span>
<a href="#l3.3263"></a><span id="l3.3263" class="difflineminus">-  {</span>
<a href="#l3.3264"></a><span id="l3.3264" class="difflineminus">-    nsCOMPtr &lt;nsIMsgDatabase&gt; virtDatabase;</span>
<a href="#l3.3265"></a><span id="l3.3265" class="difflineminus">-    nsCOMPtr &lt;nsIDBFolderInfo&gt; dbFolderInfo;</span>
<a href="#l3.3266"></a><span id="l3.3266" class="difflineminus">-</span>
<a href="#l3.3267"></a><span id="l3.3267" class="difflineminus">-    rv = m_virtualFolder-&gt;GetDBFolderInfoAndDB(getter_AddRefs(dbFolderInfo), getter_AddRefs(virtDatabase));</span>
<a href="#l3.3268"></a><span id="l3.3268" class="difflineplus">+  // we don't want to change the total counts if this virtual folder is open in</span>
<a href="#l3.3269"></a><span id="l3.3269" class="difflineplus">+  // a view, because we won't remove the header from view while it's open. On</span>
<a href="#l3.3270"></a><span id="l3.3270" class="difflineplus">+  // the other hand, it's hard to fix the count when the user clicks away to</span>
<a href="#l3.3271"></a><span id="l3.3271" class="difflineplus">+  // another folder, w/o re-running the search, or setting some sort of pending</span>
<a href="#l3.3272"></a><span id="l3.3272" class="difflineplus">+  // count change. Maybe this needs to be handled in the view code...the view</span>
<a href="#l3.3273"></a><span id="l3.3273" class="difflineplus">+  // could do the same calculation and also keep track of the counts changed.</span>
<a href="#l3.3274"></a><span id="l3.3274" class="difflineplus">+  // Then, when the view was closed, if it's a virtual folder, it could update</span>
<a href="#l3.3275"></a><span id="l3.3275" class="difflineplus">+  // the counts for the db.</span>
<a href="#l3.3276"></a><span id="l3.3276" class="difflineplus">+  if (oldMatch != newMatch ||</span>
<a href="#l3.3277"></a><span id="l3.3277" class="difflineplus">+      (oldMatch &amp;&amp; (aOldFlags &amp; nsMsgMessageFlags::Read) !=</span>
<a href="#l3.3278"></a><span id="l3.3278" class="difflineplus">+                       (aNewFlags &amp; nsMsgMessageFlags::Read))) {</span>
<a href="#l3.3279"></a><span id="l3.3279" class="difflineplus">+    nsCOMPtr&lt;nsIMsgDatabase&gt; virtDatabase;</span>
<a href="#l3.3280"></a><span id="l3.3280" class="difflineplus">+    nsCOMPtr&lt;nsIDBFolderInfo&gt; dbFolderInfo;</span>
<a href="#l3.3281"></a><span id="l3.3281" class="difflineplus">+</span>
<a href="#l3.3282"></a><span id="l3.3282" class="difflineplus">+    rv = m_virtualFolder-&gt;GetDBFolderInfoAndDB(getter_AddRefs(dbFolderInfo),</span>
<a href="#l3.3283"></a><span id="l3.3283" class="difflineplus">+                                               getter_AddRefs(virtDatabase));</span>
<a href="#l3.3284"></a><span id="l3.3284">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.3285"></a><span id="l3.3285" class="difflineminus">-    int32_t totalDelta = 0,  unreadDelta = 0;</span>
<a href="#l3.3286"></a><span id="l3.3286" class="difflineminus">-    if (oldMatch != newMatch)</span>
<a href="#l3.3287"></a><span id="l3.3287" class="difflineminus">-    {</span>
<a href="#l3.3288"></a><span id="l3.3288" class="difflineminus">- //     bool isOpen = false;</span>
<a href="#l3.3289"></a><span id="l3.3289" class="difflineminus">-//      nsCOMPtr &lt;nsIMsgMailSession&gt; mailSession = do_GetService(NS_MSGMAILSESSION_CONTRACTID);</span>
<a href="#l3.3290"></a><span id="l3.3290" class="difflineminus">-//      if (mailSession &amp;&amp; aFolder)</span>
<a href="#l3.3291"></a><span id="l3.3291" class="difflineminus">-//        mailSession-&gt;IsFolderOpenInWindow(m_virtualFolder, &amp;isOpen);</span>
<a href="#l3.3292"></a><span id="l3.3292" class="difflineminus">-      // we can't remove headers that no longer match - but we might add headers that newly match, someday.</span>
<a href="#l3.3293"></a><span id="l3.3293" class="difflineminus">-//      if (!isOpen)</span>
<a href="#l3.3294"></a><span id="l3.3294" class="difflineminus">-        totalDelta = (oldMatch) ? -1 : 1;</span>
<a href="#l3.3295"></a><span id="l3.3295" class="difflineplus">+    int32_t totalDelta = 0, unreadDelta = 0;</span>
<a href="#l3.3296"></a><span id="l3.3296" class="difflineplus">+    if (oldMatch != newMatch) {</span>
<a href="#l3.3297"></a><span id="l3.3297" class="difflineplus">+      // bool isOpen = false;</span>
<a href="#l3.3298"></a><span id="l3.3298" class="difflineplus">+      // nsCOMPtr&lt;nsIMsgMailSession&gt; mailSession =</span>
<a href="#l3.3299"></a><span id="l3.3299" class="difflineplus">+      //     do_GetService(NS_MSGMAILSESSION_CONTRACTID);</span>
<a href="#l3.3300"></a><span id="l3.3300" class="difflineplus">+      // if (mailSession &amp;&amp; aFolder)</span>
<a href="#l3.3301"></a><span id="l3.3301" class="difflineplus">+      //   mailSession-&gt;IsFolderOpenInWindow(m_virtualFolder, &amp;isOpen);</span>
<a href="#l3.3302"></a><span id="l3.3302" class="difflineplus">+      // we can't remove headers that no longer match - but we might add headers</span>
<a href="#l3.3303"></a><span id="l3.3303" class="difflineplus">+      // that newly match, someday.</span>
<a href="#l3.3304"></a><span id="l3.3304" class="difflineplus">+      // if (!isOpen)</span>
<a href="#l3.3305"></a><span id="l3.3305" class="difflineplus">+      totalDelta = (oldMatch) ? -1 : 1;</span>
<a href="#l3.3306"></a><span id="l3.3306">     }</span>
<a href="#l3.3307"></a><span id="l3.3307">     bool msgHdrIsRead;</span>
<a href="#l3.3308"></a><span id="l3.3308">     aHdrChanged-&gt;GetIsRead(&amp;msgHdrIsRead);</span>
<a href="#l3.3309"></a><span id="l3.3309" class="difflineminus">-    if (oldMatch == newMatch) // read flag changed state</span>
<a href="#l3.3310"></a><span id="l3.3310" class="difflineplus">+    if (oldMatch == newMatch)  // read flag changed state</span>
<a href="#l3.3311"></a><span id="l3.3311">       unreadDelta = (msgHdrIsRead) ? -1 : 1;</span>
<a href="#l3.3312"></a><span id="l3.3312" class="difflineminus">-    else if (oldMatch) // else header should removed</span>
<a href="#l3.3313"></a><span id="l3.3313" class="difflineplus">+    else if (oldMatch)  // else header should removed</span>
<a href="#l3.3314"></a><span id="l3.3314">       unreadDelta = (aOldFlags &amp; nsMsgMessageFlags::Read) ? 0 : -1;</span>
<a href="#l3.3315"></a><span id="l3.3315" class="difflineminus">-    else               // header should be added</span>
<a href="#l3.3316"></a><span id="l3.3316" class="difflineplus">+    else  // header should be added</span>
<a href="#l3.3317"></a><span id="l3.3317">       unreadDelta = (aNewFlags &amp; nsMsgMessageFlags::Read) ? 0 : 1;</span>
<a href="#l3.3318"></a><span id="l3.3318" class="difflineminus">-    if (unreadDelta)</span>
<a href="#l3.3319"></a><span id="l3.3319" class="difflineminus">-      dbFolderInfo-&gt;ChangeNumUnreadMessages(unreadDelta);</span>
<a href="#l3.3320"></a><span id="l3.3320" class="difflineminus">-    if (totalDelta)</span>
<a href="#l3.3321"></a><span id="l3.3321" class="difflineminus">-      dbFolderInfo-&gt;ChangeNumMessages(totalDelta);</span>
<a href="#l3.3322"></a><span id="l3.3322" class="difflineplus">+    if (unreadDelta) dbFolderInfo-&gt;ChangeNumUnreadMessages(unreadDelta);</span>
<a href="#l3.3323"></a><span id="l3.3323" class="difflineplus">+    if (totalDelta) dbFolderInfo-&gt;ChangeNumMessages(totalDelta);</span>
<a href="#l3.3324"></a><span id="l3.3324">     if (unreadDelta == -1 &amp;&amp; aOldFlags &amp; nsMsgMessageFlags::New)</span>
<a href="#l3.3325"></a><span id="l3.3325">       DecrementNewMsgCount();</span>
<a href="#l3.3326"></a><span id="l3.3326"> </span>
<a href="#l3.3327"></a><span id="l3.3327" class="difflineminus">-    if (totalDelta)</span>
<a href="#l3.3328"></a><span id="l3.3328" class="difflineminus">-    {</span>
<a href="#l3.3329"></a><span id="l3.3329" class="difflineplus">+    if (totalDelta) {</span>
<a href="#l3.3330"></a><span id="l3.3330">       nsCString searchUri;</span>
<a href="#l3.3331"></a><span id="l3.3331">       m_virtualFolder-&gt;GetURI(searchUri);</span>
<a href="#l3.3332"></a><span id="l3.3332">       msgDB-&gt;UpdateHdrInCache(searchUri.get(), aHdrChanged, totalDelta == 1);</span>
<a href="#l3.3333"></a><span id="l3.3333">     }</span>
<a href="#l3.3334"></a><span id="l3.3334"> </span>
<a href="#l3.3335"></a><span id="l3.3335">     PostUpdateEvent(m_virtualFolder, virtDatabase);</span>
<a href="#l3.3336"></a><span id="l3.3336" class="difflineminus">-  }</span>
<a href="#l3.3337"></a><span id="l3.3337" class="difflineminus">-  else if (oldMatch &amp;&amp; (aOldFlags &amp; nsMsgMessageFlags::New) &amp;&amp;</span>
<a href="#l3.3338"></a><span id="l3.3338" class="difflineminus">-           !(aNewFlags &amp; nsMsgMessageFlags::New))</span>
<a href="#l3.3339"></a><span id="l3.3339" class="difflineplus">+  } else if (oldMatch &amp;&amp; (aOldFlags &amp; nsMsgMessageFlags::New) &amp;&amp;</span>
<a href="#l3.3340"></a><span id="l3.3340" class="difflineplus">+             !(aNewFlags &amp; nsMsgMessageFlags::New))</span>
<a href="#l3.3341"></a><span id="l3.3341">     DecrementNewMsgCount();</span>
<a href="#l3.3342"></a><span id="l3.3342"> </span>
<a href="#l3.3343"></a><span id="l3.3343">   return rv;</span>
<a href="#l3.3344"></a><span id="l3.3344"> }</span>
<a href="#l3.3345"></a><span id="l3.3345"> </span>
<a href="#l3.3346"></a><span id="l3.3346" class="difflineminus">-NS_IMETHODIMP VirtualFolderChangeListener::OnHdrDeleted(nsIMsgDBHdr *aHdrDeleted, nsMsgKey aParentKey, int32_t aFlags, nsIDBChangeListener *aInstigator)</span>
<a href="#l3.3347"></a><span id="l3.3347" class="difflineminus">-{</span>
<a href="#l3.3348"></a><span id="l3.3348" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDatabase&gt; msgDB;</span>
<a href="#l3.3349"></a><span id="l3.3349" class="difflineplus">+NS_IMETHODIMP VirtualFolderChangeListener::OnHdrDeleted(</span>
<a href="#l3.3350"></a><span id="l3.3350" class="difflineplus">+    nsIMsgDBHdr *aHdrDeleted, nsMsgKey aParentKey, int32_t aFlags,</span>
<a href="#l3.3351"></a><span id="l3.3351" class="difflineplus">+    nsIDBChangeListener *aInstigator) {</span>
<a href="#l3.3352"></a><span id="l3.3352" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDatabase&gt; msgDB;</span>
<a href="#l3.3353"></a><span id="l3.3353"> </span>
<a href="#l3.3354"></a><span id="l3.3354">   nsresult rv = m_folderWatching-&gt;GetMsgDatabase(getter_AddRefs(msgDB));</span>
<a href="#l3.3355"></a><span id="l3.3355">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.3356"></a><span id="l3.3356">   bool match = false;</span>
<a href="#l3.3357"></a><span id="l3.3357" class="difflineminus">-  m_searchSession-&gt;AddScopeTerm(nsMsgSearchScope::offlineMail, m_folderWatching);</span>
<a href="#l3.3358"></a><span id="l3.3358" class="difflineplus">+  m_searchSession-&gt;AddScopeTerm(nsMsgSearchScope::offlineMail,</span>
<a href="#l3.3359"></a><span id="l3.3359" class="difflineplus">+                                m_folderWatching);</span>
<a href="#l3.3360"></a><span id="l3.3360">   // Since the notifier went to the trouble of passing in the msg flags,</span>
<a href="#l3.3361"></a><span id="l3.3361">   // we should use them when doing the match.</span>
<a href="#l3.3362"></a><span id="l3.3362">   uint32_t msgFlags;</span>
<a href="#l3.3363"></a><span id="l3.3363">   aHdrDeleted-&gt;GetFlags(&amp;msgFlags);</span>
<a href="#l3.3364"></a><span id="l3.3364">   aHdrDeleted-&gt;SetFlags(aFlags);</span>
<a href="#l3.3365"></a><span id="l3.3365">   rv = m_searchSession-&gt;MatchHdr(aHdrDeleted, msgDB, &amp;match);</span>
<a href="#l3.3366"></a><span id="l3.3366">   aHdrDeleted-&gt;SetFlags(msgFlags);</span>
<a href="#l3.3367"></a><span id="l3.3367">   m_searchSession-&gt;ClearScopes();</span>
<a href="#l3.3368"></a><span id="l3.3368" class="difflineminus">-  if (match)</span>
<a href="#l3.3369"></a><span id="l3.3369" class="difflineminus">-  {</span>
<a href="#l3.3370"></a><span id="l3.3370" class="difflineminus">-    nsCOMPtr &lt;nsIMsgDatabase&gt; virtDatabase;</span>
<a href="#l3.3371"></a><span id="l3.3371" class="difflineminus">-    nsCOMPtr &lt;nsIDBFolderInfo&gt; dbFolderInfo;</span>
<a href="#l3.3372"></a><span id="l3.3372" class="difflineminus">-</span>
<a href="#l3.3373"></a><span id="l3.3373" class="difflineminus">-    rv = m_virtualFolder-&gt;GetDBFolderInfoAndDB(getter_AddRefs(dbFolderInfo), getter_AddRefs(virtDatabase));</span>
<a href="#l3.3374"></a><span id="l3.3374" class="difflineplus">+  if (match) {</span>
<a href="#l3.3375"></a><span id="l3.3375" class="difflineplus">+    nsCOMPtr&lt;nsIMsgDatabase&gt; virtDatabase;</span>
<a href="#l3.3376"></a><span id="l3.3376" class="difflineplus">+    nsCOMPtr&lt;nsIDBFolderInfo&gt; dbFolderInfo;</span>
<a href="#l3.3377"></a><span id="l3.3377" class="difflineplus">+</span>
<a href="#l3.3378"></a><span id="l3.3378" class="difflineplus">+    rv = m_virtualFolder-&gt;GetDBFolderInfoAndDB(getter_AddRefs(dbFolderInfo),</span>
<a href="#l3.3379"></a><span id="l3.3379" class="difflineplus">+                                               getter_AddRefs(virtDatabase));</span>
<a href="#l3.3380"></a><span id="l3.3380">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.3381"></a><span id="l3.3381">     bool msgHdrIsRead;</span>
<a href="#l3.3382"></a><span id="l3.3382">     aHdrDeleted-&gt;GetIsRead(&amp;msgHdrIsRead);</span>
<a href="#l3.3383"></a><span id="l3.3383" class="difflineminus">-    if (!msgHdrIsRead)</span>
<a href="#l3.3384"></a><span id="l3.3384" class="difflineminus">-      dbFolderInfo-&gt;ChangeNumUnreadMessages(-1);</span>
<a href="#l3.3385"></a><span id="l3.3385" class="difflineplus">+    if (!msgHdrIsRead) dbFolderInfo-&gt;ChangeNumUnreadMessages(-1);</span>
<a href="#l3.3386"></a><span id="l3.3386">     dbFolderInfo-&gt;ChangeNumMessages(-1);</span>
<a href="#l3.3387"></a><span id="l3.3387" class="difflineminus">-    if (aFlags &amp; nsMsgMessageFlags::New)</span>
<a href="#l3.3388"></a><span id="l3.3388" class="difflineminus">-    {</span>
<a href="#l3.3389"></a><span id="l3.3389" class="difflineplus">+    if (aFlags &amp; nsMsgMessageFlags::New) {</span>
<a href="#l3.3390"></a><span id="l3.3390">       int32_t numNewMessages;</span>
<a href="#l3.3391"></a><span id="l3.3391">       m_virtualFolder-&gt;GetNumNewMessages(false, &amp;numNewMessages);</span>
<a href="#l3.3392"></a><span id="l3.3392">       m_virtualFolder-&gt;SetNumNewMessages(numNewMessages - 1);</span>
<a href="#l3.3393"></a><span id="l3.3393" class="difflineminus">-      if (numNewMessages == 1)</span>
<a href="#l3.3394"></a><span id="l3.3394" class="difflineminus">-        m_virtualFolder-&gt;SetHasNewMessages(false);</span>
<a href="#l3.3395"></a><span id="l3.3395" class="difflineplus">+      if (numNewMessages == 1) m_virtualFolder-&gt;SetHasNewMessages(false);</span>
<a href="#l3.3396"></a><span id="l3.3396">     }</span>
<a href="#l3.3397"></a><span id="l3.3397"> </span>
<a href="#l3.3398"></a><span id="l3.3398">     nsCString searchUri;</span>
<a href="#l3.3399"></a><span id="l3.3399">     m_virtualFolder-&gt;GetURI(searchUri);</span>
<a href="#l3.3400"></a><span id="l3.3400">     msgDB-&gt;UpdateHdrInCache(searchUri.get(), aHdrDeleted, false);</span>
<a href="#l3.3401"></a><span id="l3.3401"> </span>
<a href="#l3.3402"></a><span id="l3.3402">     PostUpdateEvent(m_virtualFolder, virtDatabase);</span>
<a href="#l3.3403"></a><span id="l3.3403">   }</span>
<a href="#l3.3404"></a><span id="l3.3404">   return rv;</span>
<a href="#l3.3405"></a><span id="l3.3405"> }</span>
<a href="#l3.3406"></a><span id="l3.3406"> </span>
<a href="#l3.3407"></a><span id="l3.3407" class="difflineminus">-NS_IMETHODIMP VirtualFolderChangeListener::OnHdrAdded(nsIMsgDBHdr *aNewHdr, nsMsgKey aParentKey, int32_t aFlags, nsIDBChangeListener *aInstigator)</span>
<a href="#l3.3408"></a><span id="l3.3408" class="difflineminus">-{</span>
<a href="#l3.3409"></a><span id="l3.3409" class="difflineplus">+NS_IMETHODIMP VirtualFolderChangeListener::OnHdrAdded(</span>
<a href="#l3.3410"></a><span id="l3.3410" class="difflineplus">+    nsIMsgDBHdr *aNewHdr, nsMsgKey aParentKey, int32_t aFlags,</span>
<a href="#l3.3411"></a><span id="l3.3411" class="difflineplus">+    nsIDBChangeListener *aInstigator) {</span>
<a href="#l3.3412"></a><span id="l3.3412">   nsCOMPtr&lt;nsIMsgDatabase&gt; msgDB;</span>
<a href="#l3.3413"></a><span id="l3.3413"> </span>
<a href="#l3.3414"></a><span id="l3.3414">   nsresult rv = m_folderWatching-&gt;GetMsgDatabase(getter_AddRefs(msgDB));</span>
<a href="#l3.3415"></a><span id="l3.3415">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.3416"></a><span id="l3.3416">   bool match = false;</span>
<a href="#l3.3417"></a><span id="l3.3417" class="difflineminus">-  if (!m_searchSession)</span>
<a href="#l3.3418"></a><span id="l3.3418" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l3.3419"></a><span id="l3.3419" class="difflineminus">-</span>
<a href="#l3.3420"></a><span id="l3.3420" class="difflineminus">-  m_searchSession-&gt;AddScopeTerm(nsMsgSearchScope::offlineMail, m_folderWatching);</span>
<a href="#l3.3421"></a><span id="l3.3421" class="difflineplus">+  if (!m_searchSession) return NS_ERROR_NULL_POINTER;</span>
<a href="#l3.3422"></a><span id="l3.3422" class="difflineplus">+</span>
<a href="#l3.3423"></a><span id="l3.3423" class="difflineplus">+  m_searchSession-&gt;AddScopeTerm(nsMsgSearchScope::offlineMail,</span>
<a href="#l3.3424"></a><span id="l3.3424" class="difflineplus">+                                m_folderWatching);</span>
<a href="#l3.3425"></a><span id="l3.3425">   rv = m_searchSession-&gt;MatchHdr(aNewHdr, msgDB, &amp;match);</span>
<a href="#l3.3426"></a><span id="l3.3426">   m_searchSession-&gt;ClearScopes();</span>
<a href="#l3.3427"></a><span id="l3.3427" class="difflineminus">-  if (match)</span>
<a href="#l3.3428"></a><span id="l3.3428" class="difflineminus">-  {</span>
<a href="#l3.3429"></a><span id="l3.3429" class="difflineminus">-    nsCOMPtr &lt;nsIMsgDatabase&gt; virtDatabase;</span>
<a href="#l3.3430"></a><span id="l3.3430" class="difflineminus">-    nsCOMPtr &lt;nsIDBFolderInfo&gt; dbFolderInfo;</span>
<a href="#l3.3431"></a><span id="l3.3431" class="difflineminus">-</span>
<a href="#l3.3432"></a><span id="l3.3432" class="difflineminus">-    rv = m_virtualFolder-&gt;GetDBFolderInfoAndDB(getter_AddRefs(dbFolderInfo), getter_AddRefs(virtDatabase));</span>
<a href="#l3.3433"></a><span id="l3.3433" class="difflineplus">+  if (match) {</span>
<a href="#l3.3434"></a><span id="l3.3434" class="difflineplus">+    nsCOMPtr&lt;nsIMsgDatabase&gt; virtDatabase;</span>
<a href="#l3.3435"></a><span id="l3.3435" class="difflineplus">+    nsCOMPtr&lt;nsIDBFolderInfo&gt; dbFolderInfo;</span>
<a href="#l3.3436"></a><span id="l3.3436" class="difflineplus">+</span>
<a href="#l3.3437"></a><span id="l3.3437" class="difflineplus">+    rv = m_virtualFolder-&gt;GetDBFolderInfoAndDB(getter_AddRefs(dbFolderInfo),</span>
<a href="#l3.3438"></a><span id="l3.3438" class="difflineplus">+                                               getter_AddRefs(virtDatabase));</span>
<a href="#l3.3439"></a><span id="l3.3439">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.3440"></a><span id="l3.3440">     bool msgHdrIsRead;</span>
<a href="#l3.3441"></a><span id="l3.3441">     uint32_t msgFlags;</span>
<a href="#l3.3442"></a><span id="l3.3442">     aNewHdr-&gt;GetIsRead(&amp;msgHdrIsRead);</span>
<a href="#l3.3443"></a><span id="l3.3443">     aNewHdr-&gt;GetFlags(&amp;msgFlags);</span>
<a href="#l3.3444"></a><span id="l3.3444" class="difflineminus">-    if (!msgHdrIsRead)</span>
<a href="#l3.3445"></a><span id="l3.3445" class="difflineminus">-      dbFolderInfo-&gt;ChangeNumUnreadMessages(1);</span>
<a href="#l3.3446"></a><span id="l3.3446" class="difflineminus">-    if (msgFlags &amp; nsMsgMessageFlags::New)</span>
<a href="#l3.3447"></a><span id="l3.3447" class="difflineminus">-    {</span>
<a href="#l3.3448"></a><span id="l3.3448" class="difflineplus">+    if (!msgHdrIsRead) dbFolderInfo-&gt;ChangeNumUnreadMessages(1);</span>
<a href="#l3.3449"></a><span id="l3.3449" class="difflineplus">+    if (msgFlags &amp; nsMsgMessageFlags::New) {</span>
<a href="#l3.3450"></a><span id="l3.3450">       int32_t numNewMessages;</span>
<a href="#l3.3451"></a><span id="l3.3451">       m_virtualFolder-&gt;GetNumNewMessages(false, &amp;numNewMessages);</span>
<a href="#l3.3452"></a><span id="l3.3452">       m_virtualFolder-&gt;SetHasNewMessages(true);</span>
<a href="#l3.3453"></a><span id="l3.3453">       m_virtualFolder-&gt;SetNumNewMessages(numNewMessages + 1);</span>
<a href="#l3.3454"></a><span id="l3.3454">     }</span>
<a href="#l3.3455"></a><span id="l3.3455">     nsCString searchUri;</span>
<a href="#l3.3456"></a><span id="l3.3456">     m_virtualFolder-&gt;GetURI(searchUri);</span>
<a href="#l3.3457"></a><span id="l3.3457">     msgDB-&gt;UpdateHdrInCache(searchUri.get(), aNewHdr, true);</span>
<a href="#l3.3458"></a><span id="l3.3458">     dbFolderInfo-&gt;ChangeNumMessages(1);</span>
<a href="#l3.3459"></a><span id="l3.3459">     PostUpdateEvent(m_virtualFolder, virtDatabase);</span>
<a href="#l3.3460"></a><span id="l3.3460">   }</span>
<a href="#l3.3461"></a><span id="l3.3461">   return rv;</span>
<a href="#l3.3462"></a><span id="l3.3462"> }</span>
<a href="#l3.3463"></a><span id="l3.3463"> </span>
<a href="#l3.3464"></a><span id="l3.3464" class="difflineminus">-NS_IMETHODIMP VirtualFolderChangeListener::OnParentChanged(nsMsgKey aKeyChanged, nsMsgKey oldParent, nsMsgKey newParent, nsIDBChangeListener *aInstigator)</span>
<a href="#l3.3465"></a><span id="l3.3465" class="difflineminus">-{</span>
<a href="#l3.3466"></a><span id="l3.3466" class="difflineplus">+NS_IMETHODIMP VirtualFolderChangeListener::OnParentChanged(</span>
<a href="#l3.3467"></a><span id="l3.3467" class="difflineplus">+    nsMsgKey aKeyChanged, nsMsgKey oldParent, nsMsgKey newParent,</span>
<a href="#l3.3468"></a><span id="l3.3468" class="difflineplus">+    nsIDBChangeListener *aInstigator) {</span>
<a href="#l3.3469"></a><span id="l3.3469">   return NS_OK;</span>
<a href="#l3.3470"></a><span id="l3.3470"> }</span>
<a href="#l3.3471"></a><span id="l3.3471"> </span>
<a href="#l3.3472"></a><span id="l3.3472" class="difflineminus">-NS_IMETHODIMP VirtualFolderChangeListener::OnAnnouncerGoingAway(nsIDBChangeAnnouncer *instigator)</span>
<a href="#l3.3473"></a><span id="l3.3473" class="difflineminus">-{</span>
<a href="#l3.3474"></a><span id="l3.3474" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDatabase&gt; msgDB = do_QueryInterface(instigator);</span>
<a href="#l3.3475"></a><span id="l3.3475" class="difflineminus">-  if (msgDB)</span>
<a href="#l3.3476"></a><span id="l3.3476" class="difflineminus">-    msgDB-&gt;RemoveListener(this);</span>
<a href="#l3.3477"></a><span id="l3.3477" class="difflineplus">+NS_IMETHODIMP VirtualFolderChangeListener::OnAnnouncerGoingAway(</span>
<a href="#l3.3478"></a><span id="l3.3478" class="difflineplus">+    nsIDBChangeAnnouncer *instigator) {</span>
<a href="#l3.3479"></a><span id="l3.3479" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDatabase&gt; msgDB = do_QueryInterface(instigator);</span>
<a href="#l3.3480"></a><span id="l3.3480" class="difflineplus">+  if (msgDB) msgDB-&gt;RemoveListener(this);</span>
<a href="#l3.3481"></a><span id="l3.3481">   return NS_OK;</span>
<a href="#l3.3482"></a><span id="l3.3482"> }</span>
<a href="#l3.3483"></a><span id="l3.3483"> </span>
<a href="#l3.3484"></a><span id="l3.3484"> NS_IMETHODIMP</span>
<a href="#l3.3485"></a><span id="l3.3485" class="difflineminus">-VirtualFolderChangeListener::OnEvent(nsIMsgDatabase *aDB, const char *aEvent)</span>
<a href="#l3.3486"></a><span id="l3.3486" class="difflineminus">-{</span>
<a href="#l3.3487"></a><span id="l3.3487" class="difflineplus">+VirtualFolderChangeListener::OnEvent(nsIMsgDatabase *aDB, const char *aEvent) {</span>
<a href="#l3.3488"></a><span id="l3.3488">   return NS_OK;</span>
<a href="#l3.3489"></a><span id="l3.3489"> }</span>
<a href="#l3.3490"></a><span id="l3.3490"> </span>
<a href="#l3.3491"></a><span id="l3.3491" class="difflineminus">-</span>
<a href="#l3.3492"></a><span id="l3.3492" class="difflineminus">-NS_IMETHODIMP VirtualFolderChangeListener::OnReadChanged(nsIDBChangeListener *aInstigator)</span>
<a href="#l3.3493"></a><span id="l3.3493" class="difflineminus">-{</span>
<a href="#l3.3494"></a><span id="l3.3494" class="difflineplus">+NS_IMETHODIMP VirtualFolderChangeListener::OnReadChanged(</span>
<a href="#l3.3495"></a><span id="l3.3495" class="difflineplus">+    nsIDBChangeListener *aInstigator) {</span>
<a href="#l3.3496"></a><span id="l3.3496">   return NS_OK;</span>
<a href="#l3.3497"></a><span id="l3.3497"> }</span>
<a href="#l3.3498"></a><span id="l3.3498"> </span>
<a href="#l3.3499"></a><span id="l3.3499" class="difflineminus">-NS_IMETHODIMP VirtualFolderChangeListener::OnJunkScoreChanged(nsIDBChangeListener *aInstigator)</span>
<a href="#l3.3500"></a><span id="l3.3500" class="difflineminus">-{</span>
<a href="#l3.3501"></a><span id="l3.3501" class="difflineplus">+NS_IMETHODIMP VirtualFolderChangeListener::OnJunkScoreChanged(</span>
<a href="#l3.3502"></a><span id="l3.3502" class="difflineplus">+    nsIDBChangeListener *aInstigator) {</span>
<a href="#l3.3503"></a><span id="l3.3503">   return NS_OK;</span>
<a href="#l3.3504"></a><span id="l3.3504"> }</span>
<a href="#l3.3505"></a><span id="l3.3505"> </span>
<a href="#l3.3506"></a><span id="l3.3506" class="difflineminus">-nsresult VirtualFolderChangeListener::PostUpdateEvent(nsIMsgFolder *virtualFolder,</span>
<a href="#l3.3507"></a><span id="l3.3507" class="difflineminus">-                                                  nsIMsgDatabase *virtDatabase)</span>
<a href="#l3.3508"></a><span id="l3.3508" class="difflineminus">-{</span>
<a href="#l3.3509"></a><span id="l3.3509" class="difflineminus">-  if (m_batchingEvents)</span>
<a href="#l3.3510"></a><span id="l3.3510" class="difflineminus">-    return NS_OK;</span>
<a href="#l3.3511"></a><span id="l3.3511" class="difflineplus">+nsresult VirtualFolderChangeListener::PostUpdateEvent(</span>
<a href="#l3.3512"></a><span id="l3.3512" class="difflineplus">+    nsIMsgFolder *virtualFolder, nsIMsgDatabase *virtDatabase) {</span>
<a href="#l3.3513"></a><span id="l3.3513" class="difflineplus">+  if (m_batchingEvents) return NS_OK;</span>
<a href="#l3.3514"></a><span id="l3.3514">   m_batchingEvents = true;</span>
<a href="#l3.3515"></a><span id="l3.3515" class="difflineminus">-  nsCOMPtr&lt;nsIRunnable&gt; event = new VFChangeListenerEvent(this, virtualFolder,</span>
<a href="#l3.3516"></a><span id="l3.3516" class="difflineminus">-                                                          virtDatabase);</span>
<a href="#l3.3517"></a><span id="l3.3517" class="difflineplus">+  nsCOMPtr&lt;nsIRunnable&gt; event =</span>
<a href="#l3.3518"></a><span id="l3.3518" class="difflineplus">+      new VFChangeListenerEvent(this, virtualFolder, virtDatabase);</span>
<a href="#l3.3519"></a><span id="l3.3519">   return NS_DispatchToCurrentThread(event);</span>
<a href="#l3.3520"></a><span id="l3.3520"> }</span>
<a href="#l3.3521"></a><span id="l3.3521"> </span>
<a href="#l3.3522"></a><span id="l3.3522"> void VirtualFolderChangeListener::ProcessUpdateEvent(nsIMsgFolder *virtFolder,</span>
<a href="#l3.3523"></a><span id="l3.3523" class="difflineminus">-                                                     nsIMsgDatabase *virtDB)</span>
<a href="#l3.3524"></a><span id="l3.3524" class="difflineminus">-{</span>
<a href="#l3.3525"></a><span id="l3.3525" class="difflineplus">+                                                     nsIMsgDatabase *virtDB) {</span>
<a href="#l3.3526"></a><span id="l3.3526">   m_batchingEvents = false;</span>
<a href="#l3.3527"></a><span id="l3.3527" class="difflineminus">-  virtFolder-&gt;UpdateSummaryTotals(true); // force update from db.</span>
<a href="#l3.3528"></a><span id="l3.3528" class="difflineplus">+  virtFolder-&gt;UpdateSummaryTotals(true);  // force update from db.</span>
<a href="#l3.3529"></a><span id="l3.3529">   virtDB-&gt;Commit(nsMsgDBCommitType::kLargeCommit);</span>
<a href="#l3.3530"></a><span id="l3.3530"> }</span>
<a href="#l3.3531"></a><span id="l3.3531"> </span>
<a href="#l3.3532"></a><span id="l3.3532" class="difflineminus">-nsresult nsMsgAccountManager::GetVirtualFoldersFile(nsCOMPtr&lt;nsIFile&gt;&amp; aFile)</span>
<a href="#l3.3533"></a><span id="l3.3533" class="difflineminus">-{</span>
<a href="#l3.3534"></a><span id="l3.3534" class="difflineplus">+nsresult nsMsgAccountManager::GetVirtualFoldersFile(nsCOMPtr&lt;nsIFile&gt; &amp;aFile) {</span>
<a href="#l3.3535"></a><span id="l3.3535">   nsCOMPtr&lt;nsIFile&gt; profileDir;</span>
<a href="#l3.3536"></a><span id="l3.3536" class="difflineminus">-  nsresult rv = NS_GetSpecialDirectory(NS_APP_USER_PROFILE_50_DIR, getter_AddRefs(profileDir));</span>
<a href="#l3.3537"></a><span id="l3.3537" class="difflineplus">+  nsresult rv = NS_GetSpecialDirectory(NS_APP_USER_PROFILE_50_DIR,</span>
<a href="#l3.3538"></a><span id="l3.3538" class="difflineplus">+                                       getter_AddRefs(profileDir));</span>
<a href="#l3.3539"></a><span id="l3.3539">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.3540"></a><span id="l3.3540"> </span>
<a href="#l3.3541"></a><span id="l3.3541">   rv = profileDir-&gt;AppendNative(nsDependentCString(&quot;virtualFolders.dat&quot;));</span>
<a href="#l3.3542"></a><span id="l3.3542" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l3.3543"></a><span id="l3.3543" class="difflineminus">-    aFile = profileDir;</span>
<a href="#l3.3544"></a><span id="l3.3544" class="difflineplus">+  if (NS_SUCCEEDED(rv)) aFile = profileDir;</span>
<a href="#l3.3545"></a><span id="l3.3545">   return rv;</span>
<a href="#l3.3546"></a><span id="l3.3546"> }</span>
<a href="#l3.3547"></a><span id="l3.3547"> </span>
<a href="#l3.3548"></a><span id="l3.3548" class="difflineminus">-NS_IMETHODIMP nsMsgAccountManager::LoadVirtualFolders()</span>
<a href="#l3.3549"></a><span id="l3.3549" class="difflineminus">-{</span>
<a href="#l3.3550"></a><span id="l3.3550" class="difflineminus">-  nsCOMPtr &lt;nsIFile&gt; file;</span>
<a href="#l3.3551"></a><span id="l3.3551" class="difflineplus">+NS_IMETHODIMP nsMsgAccountManager::LoadVirtualFolders() {</span>
<a href="#l3.3552"></a><span id="l3.3552" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; file;</span>
<a href="#l3.3553"></a><span id="l3.3553">   GetVirtualFoldersFile(file);</span>
<a href="#l3.3554"></a><span id="l3.3554" class="difflineminus">-  if (!file)</span>
<a href="#l3.3555"></a><span id="l3.3555" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l3.3556"></a><span id="l3.3556" class="difflineminus">-</span>
<a href="#l3.3557"></a><span id="l3.3557" class="difflineminus">-  if (m_virtualFoldersLoaded)</span>
<a href="#l3.3558"></a><span id="l3.3558" class="difflineminus">-    return NS_OK;</span>
<a href="#l3.3559"></a><span id="l3.3559" class="difflineplus">+  if (!file) return NS_ERROR_FAILURE;</span>
<a href="#l3.3560"></a><span id="l3.3560" class="difflineplus">+</span>
<a href="#l3.3561"></a><span id="l3.3561" class="difflineplus">+  if (m_virtualFoldersLoaded) return NS_OK;</span>
<a href="#l3.3562"></a><span id="l3.3562"> </span>
<a href="#l3.3563"></a><span id="l3.3563">   m_loadingVirtualFolders = true;</span>
<a href="#l3.3564"></a><span id="l3.3564"> </span>
<a href="#l3.3565"></a><span id="l3.3565">   nsresult rv;</span>
<a href="#l3.3566"></a><span id="l3.3566" class="difflineminus">-  nsCOMPtr&lt;nsIMsgDBService&gt; msgDBService = do_GetService(NS_MSGDB_SERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l3.3567"></a><span id="l3.3567" class="difflineminus">-  if (msgDBService)</span>
<a href="#l3.3568"></a><span id="l3.3568" class="difflineminus">-  {</span>
<a href="#l3.3569"></a><span id="l3.3569" class="difflineminus">-     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.3570"></a><span id="l3.3570" class="difflineminus">-     nsCOMPtr&lt;nsIFileInputStream&gt; fileStream = do_CreateInstance(NS_LOCALFILEINPUTSTREAM_CONTRACTID, &amp;rv);</span>
<a href="#l3.3571"></a><span id="l3.3571" class="difflineminus">-     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.3572"></a><span id="l3.3572" class="difflineminus">-</span>
<a href="#l3.3573"></a><span id="l3.3573" class="difflineminus">-     rv = fileStream-&gt;Init(file,  PR_RDONLY, 0664, false);</span>
<a href="#l3.3574"></a><span id="l3.3574" class="difflineminus">-     nsCOMPtr &lt;nsILineInputStream&gt; lineInputStream(do_QueryInterface(fileStream));</span>
<a href="#l3.3575"></a><span id="l3.3575" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDBService&gt; msgDBService =</span>
<a href="#l3.3576"></a><span id="l3.3576" class="difflineplus">+      do_GetService(NS_MSGDB_SERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l3.3577"></a><span id="l3.3577" class="difflineplus">+  if (msgDBService) {</span>
<a href="#l3.3578"></a><span id="l3.3578" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.3579"></a><span id="l3.3579" class="difflineplus">+    nsCOMPtr&lt;nsIFileInputStream&gt; fileStream =</span>
<a href="#l3.3580"></a><span id="l3.3580" class="difflineplus">+        do_CreateInstance(NS_LOCALFILEINPUTSTREAM_CONTRACTID, &amp;rv);</span>
<a href="#l3.3581"></a><span id="l3.3581" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.3582"></a><span id="l3.3582" class="difflineplus">+</span>
<a href="#l3.3583"></a><span id="l3.3583" class="difflineplus">+    rv = fileStream-&gt;Init(file, PR_RDONLY, 0664, false);</span>
<a href="#l3.3584"></a><span id="l3.3584" class="difflineplus">+    nsCOMPtr&lt;nsILineInputStream&gt; lineInputStream(do_QueryInterface(fileStream));</span>
<a href="#l3.3585"></a><span id="l3.3585"> </span>
<a href="#l3.3586"></a><span id="l3.3586">     bool isMore = true;</span>
<a href="#l3.3587"></a><span id="l3.3587">     nsAutoCString buffer;</span>
<a href="#l3.3588"></a><span id="l3.3588">     int32_t version = -1;</span>
<a href="#l3.3589"></a><span id="l3.3589">     nsCOMPtr&lt;nsIMsgFolder&gt; virtualFolder;</span>
<a href="#l3.3590"></a><span id="l3.3590">     nsCOMPtr&lt;nsIDBFolderInfo&gt; dbFolderInfo;</span>
<a href="#l3.3591"></a><span id="l3.3591"> </span>
<a href="#l3.3592"></a><span id="l3.3592" class="difflineminus">-    while (isMore &amp;&amp;</span>
<a href="#l3.3593"></a><span id="l3.3593" class="difflineminus">-           NS_SUCCEEDED(lineInputStream-&gt;ReadLine(buffer, &amp;isMore)))</span>
<a href="#l3.3594"></a><span id="l3.3594" class="difflineminus">-    {</span>
<a href="#l3.3595"></a><span id="l3.3595" class="difflineminus">-      if (!buffer.IsEmpty())</span>
<a href="#l3.3596"></a><span id="l3.3596" class="difflineminus">-      {</span>
<a href="#l3.3597"></a><span id="l3.3597" class="difflineminus">-        if (version == -1)</span>
<a href="#l3.3598"></a><span id="l3.3598" class="difflineminus">-        {</span>
<a href="#l3.3599"></a><span id="l3.3599" class="difflineplus">+    while (isMore &amp;&amp; NS_SUCCEEDED(lineInputStream-&gt;ReadLine(buffer, &amp;isMore))) {</span>
<a href="#l3.3600"></a><span id="l3.3600" class="difflineplus">+      if (!buffer.IsEmpty()) {</span>
<a href="#l3.3601"></a><span id="l3.3601" class="difflineplus">+        if (version == -1) {</span>
<a href="#l3.3602"></a><span id="l3.3602">           buffer.Cut(0, 8);</span>
<a href="#l3.3603"></a><span id="l3.3603">           nsresult irv;</span>
<a href="#l3.3604"></a><span id="l3.3604">           version = buffer.ToInteger(&amp;irv);</span>
<a href="#l3.3605"></a><span id="l3.3605">           continue;</span>
<a href="#l3.3606"></a><span id="l3.3606">         }</span>
<a href="#l3.3607"></a><span id="l3.3607" class="difflineminus">-        if (StringBeginsWith(buffer, NS_LITERAL_CSTRING(&quot;uri=&quot;)))</span>
<a href="#l3.3608"></a><span id="l3.3608" class="difflineminus">-        {</span>
<a href="#l3.3609"></a><span id="l3.3609" class="difflineplus">+        if (StringBeginsWith(buffer, NS_LITERAL_CSTRING(&quot;uri=&quot;))) {</span>
<a href="#l3.3610"></a><span id="l3.3610">           buffer.Cut(0, 4);</span>
<a href="#l3.3611"></a><span id="l3.3611">           dbFolderInfo = nullptr;</span>
<a href="#l3.3612"></a><span id="l3.3612"> </span>
<a href="#l3.3613"></a><span id="l3.3613">           rv = GetOrCreateFolder(buffer, getter_AddRefs(virtualFolder));</span>
<a href="#l3.3614"></a><span id="l3.3614">           NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.3615"></a><span id="l3.3615"> </span>
<a href="#l3.3616"></a><span id="l3.3616">           nsCOMPtr&lt;nsIMsgFolder&gt; grandParent;</span>
<a href="#l3.3617"></a><span id="l3.3617">           nsCOMPtr&lt;nsIMsgFolder&gt; oldParent;</span>
<a href="#l3.3618"></a><span id="l3.3618">           nsCOMPtr&lt;nsIMsgFolder&gt; parentFolder;</span>
<a href="#l3.3619"></a><span id="l3.3619">           bool isServer;</span>
<a href="#l3.3620"></a><span id="l3.3620">           // This loop handles creating virtual folders without an existing</span>
<a href="#l3.3621"></a><span id="l3.3621">           // parent.</span>
<a href="#l3.3622"></a><span id="l3.3622" class="difflineminus">-          do</span>
<a href="#l3.3623"></a><span id="l3.3623" class="difflineminus">-          {</span>
<a href="#l3.3624"></a><span id="l3.3624" class="difflineplus">+          do {</span>
<a href="#l3.3625"></a><span id="l3.3625">             // need to add the folder as a sub-folder of its parent.</span>
<a href="#l3.3626"></a><span id="l3.3626">             int32_t lastSlash = buffer.RFindChar('/');</span>
<a href="#l3.3627"></a><span id="l3.3627" class="difflineminus">-            if (lastSlash == kNotFound)</span>
<a href="#l3.3628"></a><span id="l3.3628" class="difflineminus">-              break;</span>
<a href="#l3.3629"></a><span id="l3.3629" class="difflineplus">+            if (lastSlash == kNotFound) break;</span>
<a href="#l3.3630"></a><span id="l3.3630">             nsDependentCSubstring parentUri(buffer, 0, lastSlash);</span>
<a href="#l3.3631"></a><span id="l3.3631">             // hold a reference so it won't get deleted before it's parented.</span>
<a href="#l3.3632"></a><span id="l3.3632">             oldParent = parentFolder;</span>
<a href="#l3.3633"></a><span id="l3.3633"> </span>
<a href="#l3.3634"></a><span id="l3.3634">             rv = GetOrCreateFolder(parentUri, getter_AddRefs(parentFolder));</span>
<a href="#l3.3635"></a><span id="l3.3635">             NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.3636"></a><span id="l3.3636"> </span>
<a href="#l3.3637"></a><span id="l3.3637">             nsAutoString currentFolderNameStr;</span>
<a href="#l3.3638"></a><span id="l3.3638">             nsAutoCString currentFolderNameCStr;</span>
<a href="#l3.3639"></a><span id="l3.3639" class="difflineminus">-            MsgUnescapeString(nsCString(Substring(buffer, lastSlash + 1, buffer.Length())), 0, currentFolderNameCStr);</span>
<a href="#l3.3640"></a><span id="l3.3640" class="difflineplus">+            MsgUnescapeString(</span>
<a href="#l3.3641"></a><span id="l3.3641" class="difflineplus">+                nsCString(Substring(buffer, lastSlash + 1, buffer.Length())), 0,</span>
<a href="#l3.3642"></a><span id="l3.3642" class="difflineplus">+                currentFolderNameCStr);</span>
<a href="#l3.3643"></a><span id="l3.3643">             CopyUTF8toUTF16(currentFolderNameCStr, currentFolderNameStr);</span>
<a href="#l3.3644"></a><span id="l3.3644">             nsCOMPtr&lt;nsIMsgFolder&gt; childFolder;</span>
<a href="#l3.3645"></a><span id="l3.3645">             nsCOMPtr&lt;nsIMsgDatabase&gt; db;</span>
<a href="#l3.3646"></a><span id="l3.3646">             // force db to get created.</span>
<a href="#l3.3647"></a><span id="l3.3647">             // XXX TODO: is this SetParent() right? Won't it screw up if virtual</span>
<a href="#l3.3648"></a><span id="l3.3648">             // folder is nested &gt;2 deep? Leave for now, but revisit when getting</span>
<a href="#l3.3649"></a><span id="l3.3649">             // rid of dangling folders (BenC).</span>
<a href="#l3.3650"></a><span id="l3.3650">             virtualFolder-&gt;SetParent(parentFolder);</span>
<a href="#l3.3651"></a><span id="l3.3651">             rv = virtualFolder-&gt;GetMsgDatabase(getter_AddRefs(db));</span>
<a href="#l3.3652"></a><span id="l3.3652">             if (rv == NS_MSG_ERROR_FOLDER_SUMMARY_MISSING)</span>
<a href="#l3.3653"></a><span id="l3.3653">               msgDBService-&gt;CreateNewDB(virtualFolder, getter_AddRefs(db));</span>
<a href="#l3.3654"></a><span id="l3.3654">             if (db)</span>
<a href="#l3.3655"></a><span id="l3.3655">               rv = db-&gt;GetDBFolderInfo(getter_AddRefs(dbFolderInfo));</span>
<a href="#l3.3656"></a><span id="l3.3656">             else</span>
<a href="#l3.3657"></a><span id="l3.3657">               break;</span>
<a href="#l3.3658"></a><span id="l3.3658"> </span>
<a href="#l3.3659"></a><span id="l3.3659" class="difflineminus">-            parentFolder-&gt;AddSubfolder(currentFolderNameStr, getter_AddRefs(childFolder));</span>
<a href="#l3.3660"></a><span id="l3.3660" class="difflineplus">+            parentFolder-&gt;AddSubfolder(currentFolderNameStr,</span>
<a href="#l3.3661"></a><span id="l3.3661" class="difflineplus">+                                       getter_AddRefs(childFolder));</span>
<a href="#l3.3662"></a><span id="l3.3662">             virtualFolder-&gt;SetFlag(nsMsgFolderFlags::Virtual);</span>
<a href="#l3.3663"></a><span id="l3.3663" class="difflineminus">-            if (childFolder)</span>
<a href="#l3.3664"></a><span id="l3.3664" class="difflineminus">-              parentFolder-&gt;NotifyItemAdded(childFolder);</span>
<a href="#l3.3665"></a><span id="l3.3665" class="difflineplus">+            if (childFolder) parentFolder-&gt;NotifyItemAdded(childFolder);</span>
<a href="#l3.3666"></a><span id="l3.3666">             // here we make sure if our parent is rooted - if not, we're</span>
<a href="#l3.3667"></a><span id="l3.3667">             // going to loop and add our parent as a child of its grandparent</span>
<a href="#l3.3668"></a><span id="l3.3668">             // and repeat until we get to the server, or a folder that</span>
<a href="#l3.3669"></a><span id="l3.3669">             // has its parent set.</span>
<a href="#l3.3670"></a><span id="l3.3670">             parentFolder-&gt;GetParent(getter_AddRefs(grandParent));</span>
<a href="#l3.3671"></a><span id="l3.3671">             parentFolder-&gt;GetIsServer(&amp;isServer);</span>
<a href="#l3.3672"></a><span id="l3.3672">             buffer.SetLength(lastSlash);</span>
<a href="#l3.3673"></a><span id="l3.3673">           } while (!grandParent &amp;&amp; !isServer);</span>
<a href="#l3.3674"></a><span id="l3.3674" class="difflineminus">-        }</span>
<a href="#l3.3675"></a><span id="l3.3675" class="difflineminus">-        else if (dbFolderInfo &amp;&amp; StringBeginsWith(buffer, NS_LITERAL_CSTRING(&quot;scope=&quot;)))</span>
<a href="#l3.3676"></a><span id="l3.3676" class="difflineminus">-        {</span>
<a href="#l3.3677"></a><span id="l3.3677" class="difflineplus">+        } else if (dbFolderInfo &amp;&amp;</span>
<a href="#l3.3678"></a><span id="l3.3678" class="difflineplus">+                   StringBeginsWith(buffer, NS_LITERAL_CSTRING(&quot;scope=&quot;))) {</span>
<a href="#l3.3679"></a><span id="l3.3679">           buffer.Cut(0, 6);</span>
<a href="#l3.3680"></a><span id="l3.3680" class="difflineminus">-          // if this is a cross folder virtual folder, we have a list of folders uris,</span>
<a href="#l3.3681"></a><span id="l3.3681" class="difflineminus">-          // and we have to add a pending listener for each of them.</span>
<a href="#l3.3682"></a><span id="l3.3682" class="difflineminus">-          if (!buffer.IsEmpty())</span>
<a href="#l3.3683"></a><span id="l3.3683" class="difflineminus">-          {</span>
<a href="#l3.3684"></a><span id="l3.3684" class="difflineplus">+          // if this is a cross folder virtual folder, we have a list of folders</span>
<a href="#l3.3685"></a><span id="l3.3685" class="difflineplus">+          // uris, and we have to add a pending listener for each of them.</span>
<a href="#l3.3686"></a><span id="l3.3686" class="difflineplus">+          if (!buffer.IsEmpty()) {</span>
<a href="#l3.3687"></a><span id="l3.3687">             ParseAndVerifyVirtualFolderScope(buffer);</span>
<a href="#l3.3688"></a><span id="l3.3688">             dbFolderInfo-&gt;SetCharProperty(kSearchFolderUriProp, buffer);</span>
<a href="#l3.3689"></a><span id="l3.3689">             AddVFListenersForVF(virtualFolder, buffer, msgDBService);</span>
<a href="#l3.3690"></a><span id="l3.3690">           }</span>
<a href="#l3.3691"></a><span id="l3.3691" class="difflineminus">-        }</span>
<a href="#l3.3692"></a><span id="l3.3692" class="difflineminus">-        else if (dbFolderInfo &amp;&amp; StringBeginsWith(buffer, NS_LITERAL_CSTRING(&quot;terms=&quot;)))</span>
<a href="#l3.3693"></a><span id="l3.3693" class="difflineminus">-        {</span>
<a href="#l3.3694"></a><span id="l3.3694" class="difflineplus">+        } else if (dbFolderInfo &amp;&amp;</span>
<a href="#l3.3695"></a><span id="l3.3695" class="difflineplus">+                   StringBeginsWith(buffer, NS_LITERAL_CSTRING(&quot;terms=&quot;))) {</span>
<a href="#l3.3696"></a><span id="l3.3696">           buffer.Cut(0, 6);</span>
<a href="#l3.3697"></a><span id="l3.3697">           dbFolderInfo-&gt;SetCharProperty(&quot;searchStr&quot;, buffer);</span>
<a href="#l3.3698"></a><span id="l3.3698" class="difflineminus">-        }</span>
<a href="#l3.3699"></a><span id="l3.3699" class="difflineminus">-        else if (dbFolderInfo &amp;&amp; StringBeginsWith(buffer, NS_LITERAL_CSTRING(&quot;searchOnline=&quot;)))</span>
<a href="#l3.3700"></a><span id="l3.3700" class="difflineminus">-        {</span>
<a href="#l3.3701"></a><span id="l3.3701" class="difflineplus">+        } else if (dbFolderInfo &amp;&amp;</span>
<a href="#l3.3702"></a><span id="l3.3702" class="difflineplus">+                   StringBeginsWith(buffer,</span>
<a href="#l3.3703"></a><span id="l3.3703" class="difflineplus">+                                    NS_LITERAL_CSTRING(&quot;searchOnline=&quot;))) {</span>
<a href="#l3.3704"></a><span id="l3.3704">           buffer.Cut(0, 13);</span>
<a href="#l3.3705"></a><span id="l3.3705" class="difflineminus">-          dbFolderInfo-&gt;SetBooleanProperty(&quot;searchOnline&quot;, buffer.EqualsLiteral(&quot;true&quot;));</span>
<a href="#l3.3706"></a><span id="l3.3706" class="difflineminus">-        }</span>
<a href="#l3.3707"></a><span id="l3.3707" class="difflineminus">-        else if (dbFolderInfo &amp;&amp;</span>
<a href="#l3.3708"></a><span id="l3.3708" class="difflineminus">-                 Substring(buffer, 0, SEARCH_FOLDER_FLAG_LEN + 1)</span>
<a href="#l3.3709"></a><span id="l3.3709" class="difflineminus">-                   .Equals(SEARCH_FOLDER_FLAG&quot;=&quot;))</span>
<a href="#l3.3710"></a><span id="l3.3710" class="difflineminus">-        {</span>
<a href="#l3.3711"></a><span id="l3.3711" class="difflineplus">+          dbFolderInfo-&gt;SetBooleanProperty(&quot;searchOnline&quot;,</span>
<a href="#l3.3712"></a><span id="l3.3712" class="difflineplus">+                                           buffer.EqualsLiteral(&quot;true&quot;));</span>
<a href="#l3.3713"></a><span id="l3.3713" class="difflineplus">+        } else if (dbFolderInfo &amp;&amp;</span>
<a href="#l3.3714"></a><span id="l3.3714" class="difflineplus">+                   Substring(buffer, 0, SEARCH_FOLDER_FLAG_LEN + 1)</span>
<a href="#l3.3715"></a><span id="l3.3715" class="difflineplus">+                       .Equals(SEARCH_FOLDER_FLAG &quot;=&quot;)) {</span>
<a href="#l3.3716"></a><span id="l3.3716">           buffer.Cut(0, SEARCH_FOLDER_FLAG_LEN + 1);</span>
<a href="#l3.3717"></a><span id="l3.3717">           dbFolderInfo-&gt;SetCharProperty(SEARCH_FOLDER_FLAG, buffer);</span>
<a href="#l3.3718"></a><span id="l3.3718">         }</span>
<a href="#l3.3719"></a><span id="l3.3719">       }</span>
<a href="#l3.3720"></a><span id="l3.3720">     }</span>
<a href="#l3.3721"></a><span id="l3.3721">   }</span>
<a href="#l3.3722"></a><span id="l3.3722"> </span>
<a href="#l3.3723"></a><span id="l3.3723">   m_loadingVirtualFolders = false;</span>
<a href="#l3.3724"></a><span id="l3.3724">   m_virtualFoldersLoaded = true;</span>
<a href="#l3.3725"></a><span id="l3.3725">   return rv;</span>
<a href="#l3.3726"></a><span id="l3.3726"> }</span>
<a href="#l3.3727"></a><span id="l3.3727"> </span>
<a href="#l3.3728"></a><span id="l3.3728" class="difflineminus">-NS_IMETHODIMP nsMsgAccountManager::SaveVirtualFolders()</span>
<a href="#l3.3729"></a><span id="l3.3729" class="difflineminus">-{</span>
<a href="#l3.3730"></a><span id="l3.3730" class="difflineminus">-  if (!m_virtualFoldersLoaded)</span>
<a href="#l3.3731"></a><span id="l3.3731" class="difflineminus">-    return NS_OK;</span>
<a href="#l3.3732"></a><span id="l3.3732" class="difflineplus">+NS_IMETHODIMP nsMsgAccountManager::SaveVirtualFolders() {</span>
<a href="#l3.3733"></a><span id="l3.3733" class="difflineplus">+  if (!m_virtualFoldersLoaded) return NS_OK;</span>
<a href="#l3.3734"></a><span id="l3.3734"> </span>
<a href="#l3.3735"></a><span id="l3.3735">   nsCOMPtr&lt;nsIFile&gt; file;</span>
<a href="#l3.3736"></a><span id="l3.3736">   GetVirtualFoldersFile(file);</span>
<a href="#l3.3737"></a><span id="l3.3737"> </span>
<a href="#l3.3738"></a><span id="l3.3738">   // Open a buffered, safe output stream</span>
<a href="#l3.3739"></a><span id="l3.3739">   nsCOMPtr&lt;nsIOutputStream&gt; outStream;</span>
<a href="#l3.3740"></a><span id="l3.3740" class="difflineminus">-  nsresult rv = MsgNewSafeBufferedFileOutputStream(getter_AddRefs(outStream),</span>
<a href="#l3.3741"></a><span id="l3.3741" class="difflineminus">-                                                   file,</span>
<a href="#l3.3742"></a><span id="l3.3742" class="difflineminus">-                                                   PR_CREATE_FILE | PR_WRONLY | PR_TRUNCATE,</span>
<a href="#l3.3743"></a><span id="l3.3743" class="difflineminus">-                                                   0664);</span>
<a href="#l3.3744"></a><span id="l3.3744" class="difflineplus">+  nsresult rv = MsgNewSafeBufferedFileOutputStream(</span>
<a href="#l3.3745"></a><span id="l3.3745" class="difflineplus">+      getter_AddRefs(outStream), file, PR_CREATE_FILE | PR_WRONLY | PR_TRUNCATE,</span>
<a href="#l3.3746"></a><span id="l3.3746" class="difflineplus">+      0664);</span>
<a href="#l3.3747"></a><span id="l3.3747">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.3748"></a><span id="l3.3748"> </span>
<a href="#l3.3749"></a><span id="l3.3749">   WriteLineToOutputStream(&quot;version=&quot;, &quot;1&quot;, outStream);</span>
<a href="#l3.3750"></a><span id="l3.3750">   for (auto iter = m_incomingServers.Iter(); !iter.Done(); iter.Next()) {</span>
<a href="#l3.3751"></a><span id="l3.3751" class="difflineminus">-    nsCOMPtr&lt;nsIMsgIncomingServer&gt;&amp; server = iter.Data();</span>
<a href="#l3.3752"></a><span id="l3.3752" class="difflineminus">-    if (server)</span>
<a href="#l3.3753"></a><span id="l3.3753" class="difflineminus">-    {</span>
<a href="#l3.3754"></a><span id="l3.3754" class="difflineminus">-      nsCOMPtr &lt;nsIMsgFolder&gt; rootFolder;</span>
<a href="#l3.3755"></a><span id="l3.3755" class="difflineplus">+    nsCOMPtr&lt;nsIMsgIncomingServer&gt; &amp;server = iter.Data();</span>
<a href="#l3.3756"></a><span id="l3.3756" class="difflineplus">+    if (server) {</span>
<a href="#l3.3757"></a><span id="l3.3757" class="difflineplus">+      nsCOMPtr&lt;nsIMsgFolder&gt; rootFolder;</span>
<a href="#l3.3758"></a><span id="l3.3758">       server-&gt;GetRootFolder(getter_AddRefs(rootFolder));</span>
<a href="#l3.3759"></a><span id="l3.3759" class="difflineminus">-      if (rootFolder)</span>
<a href="#l3.3760"></a><span id="l3.3760" class="difflineminus">-      {</span>
<a href="#l3.3761"></a><span id="l3.3761" class="difflineminus">-        nsCOMPtr &lt;nsIArray&gt; virtualFolders;</span>
<a href="#l3.3762"></a><span id="l3.3762" class="difflineminus">-        nsresult rv = rootFolder-&gt;GetFoldersWithFlags(nsMsgFolderFlags::Virtual,</span>
<a href="#l3.3763"></a><span id="l3.3763" class="difflineminus">-                                             getter_AddRefs(virtualFolders));</span>
<a href="#l3.3764"></a><span id="l3.3764" class="difflineplus">+      if (rootFolder) {</span>
<a href="#l3.3765"></a><span id="l3.3765" class="difflineplus">+        nsCOMPtr&lt;nsIArray&gt; virtualFolders;</span>
<a href="#l3.3766"></a><span id="l3.3766" class="difflineplus">+        nsresult rv = rootFolder-&gt;GetFoldersWithFlags(</span>
<a href="#l3.3767"></a><span id="l3.3767" class="difflineplus">+            nsMsgFolderFlags::Virtual, getter_AddRefs(virtualFolders));</span>
<a href="#l3.3768"></a><span id="l3.3768">         if (NS_FAILED(rv)) {</span>
<a href="#l3.3769"></a><span id="l3.3769">           continue;</span>
<a href="#l3.3770"></a><span id="l3.3770">         }</span>
<a href="#l3.3771"></a><span id="l3.3771">         uint32_t vfCount;</span>
<a href="#l3.3772"></a><span id="l3.3772">         virtualFolders-&gt;GetLength(&amp;vfCount);</span>
<a href="#l3.3773"></a><span id="l3.3773" class="difflineminus">-        for (uint32_t folderIndex = 0; folderIndex &lt; vfCount; folderIndex++)</span>
<a href="#l3.3774"></a><span id="l3.3774" class="difflineminus">-        {</span>
<a href="#l3.3775"></a><span id="l3.3775" class="difflineminus">-          nsCOMPtr&lt;nsIMsgFolder&gt; msgFolder(do_QueryElementAt(virtualFolders, folderIndex));</span>
<a href="#l3.3776"></a><span id="l3.3776" class="difflineplus">+        for (uint32_t folderIndex = 0; folderIndex &lt; vfCount; folderIndex++) {</span>
<a href="#l3.3777"></a><span id="l3.3777" class="difflineplus">+          nsCOMPtr&lt;nsIMsgFolder&gt; msgFolder(</span>
<a href="#l3.3778"></a><span id="l3.3778" class="difflineplus">+              do_QueryElementAt(virtualFolders, folderIndex));</span>
<a href="#l3.3779"></a><span id="l3.3779">           nsCOMPtr&lt;nsIMsgDatabase&gt; db;</span>
<a href="#l3.3780"></a><span id="l3.3780">           nsCOMPtr&lt;nsIDBFolderInfo&gt; dbFolderInfo;</span>
<a href="#l3.3781"></a><span id="l3.3781" class="difflineminus">-          rv = msgFolder-&gt;GetDBFolderInfoAndDB(getter_AddRefs(dbFolderInfo), getter_AddRefs(db)); // force db to get created.</span>
<a href="#l3.3782"></a><span id="l3.3782" class="difflineminus">-          if (dbFolderInfo)</span>
<a href="#l3.3783"></a><span id="l3.3783" class="difflineminus">-          {</span>
<a href="#l3.3784"></a><span id="l3.3784" class="difflineplus">+          rv = msgFolder-&gt;GetDBFolderInfoAndDB(</span>
<a href="#l3.3785"></a><span id="l3.3785" class="difflineplus">+              getter_AddRefs(dbFolderInfo),</span>
<a href="#l3.3786"></a><span id="l3.3786" class="difflineplus">+              getter_AddRefs(db));  // force db to get created.</span>
<a href="#l3.3787"></a><span id="l3.3787" class="difflineplus">+          if (dbFolderInfo) {</span>
<a href="#l3.3788"></a><span id="l3.3788">             nsCString srchFolderUri;</span>
<a href="#l3.3789"></a><span id="l3.3789">             nsCString searchTerms;</span>
<a href="#l3.3790"></a><span id="l3.3790">             nsCString regexScope;</span>
<a href="#l3.3791"></a><span id="l3.3791">             nsCString vfFolderFlag;</span>
<a href="#l3.3792"></a><span id="l3.3792">             bool searchOnline = false;</span>
<a href="#l3.3793"></a><span id="l3.3793" class="difflineminus">-            dbFolderInfo-&gt;GetBooleanProperty(&quot;searchOnline&quot;, false, &amp;searchOnline);</span>
<a href="#l3.3794"></a><span id="l3.3794" class="difflineplus">+            dbFolderInfo-&gt;GetBooleanProperty(&quot;searchOnline&quot;, false,</span>
<a href="#l3.3795"></a><span id="l3.3795" class="difflineplus">+                                             &amp;searchOnline);</span>
<a href="#l3.3796"></a><span id="l3.3796">             dbFolderInfo-&gt;GetCharProperty(kSearchFolderUriProp, srchFolderUri);</span>
<a href="#l3.3797"></a><span id="l3.3797">             dbFolderInfo-&gt;GetCharProperty(&quot;searchStr&quot;, searchTerms);</span>
<a href="#l3.3798"></a><span id="l3.3798">             // logically searchFolderFlag is an int, but since we want to</span>
<a href="#l3.3799"></a><span id="l3.3799">             // write out a string, get it as a string.</span>
<a href="#l3.3800"></a><span id="l3.3800">             dbFolderInfo-&gt;GetCharProperty(SEARCH_FOLDER_FLAG, vfFolderFlag);</span>
<a href="#l3.3801"></a><span id="l3.3801">             nsCString uri;</span>
<a href="#l3.3802"></a><span id="l3.3802">             msgFolder-&gt;GetURI(uri);</span>
<a href="#l3.3803"></a><span id="l3.3803" class="difflineminus">-            if (!srchFolderUri.IsEmpty() &amp;&amp; !searchTerms.IsEmpty())</span>
<a href="#l3.3804"></a><span id="l3.3804" class="difflineminus">-            {</span>
<a href="#l3.3805"></a><span id="l3.3805" class="difflineplus">+            if (!srchFolderUri.IsEmpty() &amp;&amp; !searchTerms.IsEmpty()) {</span>
<a href="#l3.3806"></a><span id="l3.3806">               WriteLineToOutputStream(&quot;uri=&quot;, uri.get(), outStream);</span>
<a href="#l3.3807"></a><span id="l3.3807">               if (!vfFolderFlag.IsEmpty())</span>
<a href="#l3.3808"></a><span id="l3.3808" class="difflineminus">-                WriteLineToOutputStream(SEARCH_FOLDER_FLAG&quot;=&quot;, vfFolderFlag.get(), outStream);</span>
<a href="#l3.3809"></a><span id="l3.3809" class="difflineplus">+                WriteLineToOutputStream(SEARCH_FOLDER_FLAG &quot;=&quot;,</span>
<a href="#l3.3810"></a><span id="l3.3810" class="difflineplus">+                                        vfFolderFlag.get(), outStream);</span>
<a href="#l3.3811"></a><span id="l3.3811">               WriteLineToOutputStream(&quot;scope=&quot;, srchFolderUri.get(), outStream);</span>
<a href="#l3.3812"></a><span id="l3.3812">               WriteLineToOutputStream(&quot;terms=&quot;, searchTerms.get(), outStream);</span>
<a href="#l3.3813"></a><span id="l3.3813" class="difflineminus">-              WriteLineToOutputStream(&quot;searchOnline=&quot;, searchOnline ? &quot;true&quot; : &quot;false&quot;, outStream);</span>
<a href="#l3.3814"></a><span id="l3.3814" class="difflineplus">+              WriteLineToOutputStream(</span>
<a href="#l3.3815"></a><span id="l3.3815" class="difflineplus">+                  &quot;searchOnline=&quot;, searchOnline ? &quot;true&quot; : &quot;false&quot;, outStream);</span>
<a href="#l3.3816"></a><span id="l3.3816">             }</span>
<a href="#l3.3817"></a><span id="l3.3817">           }</span>
<a href="#l3.3818"></a><span id="l3.3818">         }</span>
<a href="#l3.3819"></a><span id="l3.3819">       }</span>
<a href="#l3.3820"></a><span id="l3.3820">     }</span>
<a href="#l3.3821"></a><span id="l3.3821">   }</span>
<a href="#l3.3822"></a><span id="l3.3822"> </span>
<a href="#l3.3823"></a><span id="l3.3823">   nsCOMPtr&lt;nsISafeOutputStream&gt; safeStream = do_QueryInterface(outStream, &amp;rv);</span>
<a href="#l3.3824"></a><span id="l3.3824" class="difflineat">@@ -3111,448 +2865,412 @@ NS_IMETHODIMP nsMsgAccountManager::SaveV</span>
<a href="#l3.3825"></a><span id="l3.3825">     rv = safeStream-&gt;Finish();</span>
<a href="#l3.3826"></a><span id="l3.3826">     if (NS_FAILED(rv)) {</span>
<a href="#l3.3827"></a><span id="l3.3827">       NS_WARNING(&quot;failed to save personal dictionary file! possible data loss&quot;);</span>
<a href="#l3.3828"></a><span id="l3.3828">     }</span>
<a href="#l3.3829"></a><span id="l3.3829">   }</span>
<a href="#l3.3830"></a><span id="l3.3830">   return rv;</span>
<a href="#l3.3831"></a><span id="l3.3831"> }</span>
<a href="#l3.3832"></a><span id="l3.3832"> </span>
<a href="#l3.3833"></a><span id="l3.3833" class="difflineminus">-nsresult nsMsgAccountManager::WriteLineToOutputStream(const char *prefix, const char * line, nsIOutputStream *outputStream)</span>
<a href="#l3.3834"></a><span id="l3.3834" class="difflineminus">-{</span>
<a href="#l3.3835"></a><span id="l3.3835" class="difflineplus">+nsresult nsMsgAccountManager::WriteLineToOutputStream(</span>
<a href="#l3.3836"></a><span id="l3.3836" class="difflineplus">+    const char *prefix, const char *line, nsIOutputStream *outputStream) {</span>
<a href="#l3.3837"></a><span id="l3.3837">   uint32_t writeCount;</span>
<a href="#l3.3838"></a><span id="l3.3838">   outputStream-&gt;Write(prefix, strlen(prefix), &amp;writeCount);</span>
<a href="#l3.3839"></a><span id="l3.3839">   outputStream-&gt;Write(line, strlen(line), &amp;writeCount);</span>
<a href="#l3.3840"></a><span id="l3.3840">   outputStream-&gt;Write(&quot;\n&quot;, 1, &amp;writeCount);</span>
<a href="#l3.3841"></a><span id="l3.3841">   return NS_OK;</span>
<a href="#l3.3842"></a><span id="l3.3842"> }</span>
<a href="#l3.3843"></a><span id="l3.3843"> </span>
<a href="#l3.3844"></a><span id="l3.3844"> /**</span>
<a href="#l3.3845"></a><span id="l3.3845">  * Parse the '|' separated folder uri string into individual folders, verify</span>
<a href="#l3.3846"></a><span id="l3.3846">  * that the folders are real. If we were to add things like wildcards, we</span>
<a href="#l3.3847"></a><span id="l3.3847">  * could implement the expansion into real folders here.</span>
<a href="#l3.3848"></a><span id="l3.3848">  *</span>
<a href="#l3.3849"></a><span id="l3.3849">  * @param buffer On input, list of folder uri's, on output, verified list.</span>
<a href="#l3.3850"></a><span id="l3.3850">  */</span>
<a href="#l3.3851"></a><span id="l3.3851" class="difflineminus">-void nsMsgAccountManager::ParseAndVerifyVirtualFolderScope(nsCString &amp;buffer)</span>
<a href="#l3.3852"></a><span id="l3.3852" class="difflineminus">-{</span>
<a href="#l3.3853"></a><span id="l3.3853" class="difflineplus">+void nsMsgAccountManager::ParseAndVerifyVirtualFolderScope(nsCString &amp;buffer) {</span>
<a href="#l3.3854"></a><span id="l3.3854">   nsCString verifiedFolders;</span>
<a href="#l3.3855"></a><span id="l3.3855">   nsTArray&lt;nsCString&gt; folderUris;</span>
<a href="#l3.3856"></a><span id="l3.3856">   ParseString(buffer, '|', folderUris);</span>
<a href="#l3.3857"></a><span id="l3.3857">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l3.3858"></a><span id="l3.3858">   nsCOMPtr&lt;nsIMsgFolder&gt; parent;</span>
<a href="#l3.3859"></a><span id="l3.3859"> </span>
<a href="#l3.3860"></a><span id="l3.3860" class="difflineminus">-  for (uint32_t i = 0; i &lt; folderUris.Length(); i++)</span>
<a href="#l3.3861"></a><span id="l3.3861" class="difflineminus">-  {</span>
<a href="#l3.3862"></a><span id="l3.3862" class="difflineplus">+  for (uint32_t i = 0; i &lt; folderUris.Length(); i++) {</span>
<a href="#l3.3863"></a><span id="l3.3863">     nsCOMPtr&lt;nsIMsgFolder&gt; realFolder;</span>
<a href="#l3.3864"></a><span id="l3.3864">     nsresult rv = GetOrCreateFolder(folderUris[i], getter_AddRefs(realFolder));</span>
<a href="#l3.3865"></a><span id="l3.3865">     if (!NS_SUCCEEDED(rv)) {</span>
<a href="#l3.3866"></a><span id="l3.3866">       continue;</span>
<a href="#l3.3867"></a><span id="l3.3867">     }</span>
<a href="#l3.3868"></a><span id="l3.3868">     realFolder-&gt;GetParent(getter_AddRefs(parent));</span>
<a href="#l3.3869"></a><span id="l3.3869" class="difflineminus">-    if (!parent)</span>
<a href="#l3.3870"></a><span id="l3.3870" class="difflineminus">-      continue;</span>
<a href="#l3.3871"></a><span id="l3.3871" class="difflineplus">+    if (!parent) continue;</span>
<a href="#l3.3872"></a><span id="l3.3872">     realFolder-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l3.3873"></a><span id="l3.3873" class="difflineminus">-    if (!server)</span>
<a href="#l3.3874"></a><span id="l3.3874" class="difflineminus">-      continue;</span>
<a href="#l3.3875"></a><span id="l3.3875" class="difflineminus">-    if (!verifiedFolders.IsEmpty())</span>
<a href="#l3.3876"></a><span id="l3.3876" class="difflineminus">-      verifiedFolders.Append('|');</span>
<a href="#l3.3877"></a><span id="l3.3877" class="difflineplus">+    if (!server) continue;</span>
<a href="#l3.3878"></a><span id="l3.3878" class="difflineplus">+    if (!verifiedFolders.IsEmpty()) verifiedFolders.Append('|');</span>
<a href="#l3.3879"></a><span id="l3.3879">     verifiedFolders.Append(folderUris[i]);</span>
<a href="#l3.3880"></a><span id="l3.3880">   }</span>
<a href="#l3.3881"></a><span id="l3.3881">   buffer.Assign(verifiedFolders);</span>
<a href="#l3.3882"></a><span id="l3.3882"> }</span>
<a href="#l3.3883"></a><span id="l3.3883"> </span>
<a href="#l3.3884"></a><span id="l3.3884"> // This conveniently works to add a single folder as well.</span>
<a href="#l3.3885"></a><span id="l3.3885" class="difflineminus">-nsresult nsMsgAccountManager::AddVFListenersForVF(nsIMsgFolder *virtualFolder,</span>
<a href="#l3.3886"></a><span id="l3.3886" class="difflineminus">-                                                  const nsCString&amp; srchFolderUris,</span>
<a href="#l3.3887"></a><span id="l3.3887" class="difflineminus">-                                                  nsIMsgDBService *msgDBService)</span>
<a href="#l3.3888"></a><span id="l3.3888" class="difflineminus">-{</span>
<a href="#l3.3889"></a><span id="l3.3889" class="difflineplus">+nsresult nsMsgAccountManager::AddVFListenersForVF(</span>
<a href="#l3.3890"></a><span id="l3.3890" class="difflineplus">+    nsIMsgFolder *virtualFolder, const nsCString &amp;srchFolderUris,</span>
<a href="#l3.3891"></a><span id="l3.3891" class="difflineplus">+    nsIMsgDBService *msgDBService) {</span>
<a href="#l3.3892"></a><span id="l3.3892">   nsTArray&lt;nsCString&gt; folderUris;</span>
<a href="#l3.3893"></a><span id="l3.3893">   ParseString(srchFolderUris, '|', folderUris);</span>
<a href="#l3.3894"></a><span id="l3.3894"> </span>
<a href="#l3.3895"></a><span id="l3.3895" class="difflineminus">-  for (uint32_t i = 0; i &lt; folderUris.Length(); i++)</span>
<a href="#l3.3896"></a><span id="l3.3896" class="difflineminus">-  {</span>
<a href="#l3.3897"></a><span id="l3.3897" class="difflineplus">+  for (uint32_t i = 0; i &lt; folderUris.Length(); i++) {</span>
<a href="#l3.3898"></a><span id="l3.3898">     nsCOMPtr&lt;nsIMsgFolder&gt; realFolder;</span>
<a href="#l3.3899"></a><span id="l3.3899">     nsresult rv = GetOrCreateFolder(folderUris[i], getter_AddRefs(realFolder));</span>
<a href="#l3.3900"></a><span id="l3.3900">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.3901"></a><span id="l3.3901" class="difflineminus">-    RefPtr&lt;VirtualFolderChangeListener&gt; dbListener = new VirtualFolderChangeListener();</span>
<a href="#l3.3902"></a><span id="l3.3902" class="difflineplus">+    RefPtr&lt;VirtualFolderChangeListener&gt; dbListener =</span>
<a href="#l3.3903"></a><span id="l3.3903" class="difflineplus">+        new VirtualFolderChangeListener();</span>
<a href="#l3.3904"></a><span id="l3.3904">     NS_ENSURE_TRUE(dbListener, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l3.3905"></a><span id="l3.3905">     dbListener-&gt;m_virtualFolder = virtualFolder;</span>
<a href="#l3.3906"></a><span id="l3.3906">     dbListener-&gt;m_folderWatching = realFolder;</span>
<a href="#l3.3907"></a><span id="l3.3907" class="difflineminus">-    if (NS_FAILED(dbListener-&gt;Init()))</span>
<a href="#l3.3908"></a><span id="l3.3908" class="difflineminus">-    {</span>
<a href="#l3.3909"></a><span id="l3.3909" class="difflineplus">+    if (NS_FAILED(dbListener-&gt;Init())) {</span>
<a href="#l3.3910"></a><span id="l3.3910">       dbListener = nullptr;</span>
<a href="#l3.3911"></a><span id="l3.3911">       continue;</span>
<a href="#l3.3912"></a><span id="l3.3912">     }</span>
<a href="#l3.3913"></a><span id="l3.3913">     m_virtualFolderListeners.AppendElement(dbListener);</span>
<a href="#l3.3914"></a><span id="l3.3914">     msgDBService-&gt;RegisterPendingListener(realFolder, dbListener);</span>
<a href="#l3.3915"></a><span id="l3.3915">   }</span>
<a href="#l3.3916"></a><span id="l3.3916">   return NS_OK;</span>
<a href="#l3.3917"></a><span id="l3.3917"> }</span>
<a href="#l3.3918"></a><span id="l3.3918"> </span>
<a href="#l3.3919"></a><span id="l3.3919"> // This is called if a folder that's part of the scope of a saved search</span>
<a href="#l3.3920"></a><span id="l3.3920"> // has gone away.</span>
<a href="#l3.3921"></a><span id="l3.3921"> nsresult nsMsgAccountManager::RemoveVFListenerForVF(nsIMsgFolder *virtualFolder,</span>
<a href="#l3.3922"></a><span id="l3.3922" class="difflineminus">-                                                    nsIMsgFolder *folder)</span>
<a href="#l3.3923"></a><span id="l3.3923" class="difflineminus">-{</span>
<a href="#l3.3924"></a><span id="l3.3924" class="difflineplus">+                                                    nsIMsgFolder *folder) {</span>
<a href="#l3.3925"></a><span id="l3.3925">   nsresult rv;</span>
<a href="#l3.3926"></a><span id="l3.3926" class="difflineminus">-  nsCOMPtr&lt;nsIMsgDBService&gt; msgDBService(do_GetService(NS_MSGDB_SERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l3.3927"></a><span id="l3.3927" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDBService&gt; msgDBService(</span>
<a href="#l3.3928"></a><span id="l3.3928" class="difflineplus">+      do_GetService(NS_MSGDB_SERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l3.3929"></a><span id="l3.3929">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.3930"></a><span id="l3.3930"> </span>
<a href="#l3.3931"></a><span id="l3.3931" class="difflineminus">-  nsTObserverArray&lt;RefPtr&lt;VirtualFolderChangeListener&gt; &gt;::ForwardIterator iter(m_virtualFolderListeners);</span>
<a href="#l3.3932"></a><span id="l3.3932" class="difflineplus">+  nsTObserverArray&lt;RefPtr&lt;VirtualFolderChangeListener&gt; &gt;::ForwardIterator iter(</span>
<a href="#l3.3933"></a><span id="l3.3933" class="difflineplus">+      m_virtualFolderListeners);</span>
<a href="#l3.3934"></a><span id="l3.3934">   RefPtr&lt;VirtualFolderChangeListener&gt; listener;</span>
<a href="#l3.3935"></a><span id="l3.3935"> </span>
<a href="#l3.3936"></a><span id="l3.3936" class="difflineminus">-  while (iter.HasMore())</span>
<a href="#l3.3937"></a><span id="l3.3937" class="difflineminus">-  {</span>
<a href="#l3.3938"></a><span id="l3.3938" class="difflineplus">+  while (iter.HasMore()) {</span>
<a href="#l3.3939"></a><span id="l3.3939">     listener = iter.GetNext();</span>
<a href="#l3.3940"></a><span id="l3.3940">     if (listener-&gt;m_folderWatching == folder &amp;&amp;</span>
<a href="#l3.3941"></a><span id="l3.3941" class="difflineminus">-        listener-&gt;m_virtualFolder == virtualFolder)</span>
<a href="#l3.3942"></a><span id="l3.3942" class="difflineminus">-    {</span>
<a href="#l3.3943"></a><span id="l3.3943" class="difflineplus">+        listener-&gt;m_virtualFolder == virtualFolder) {</span>
<a href="#l3.3944"></a><span id="l3.3944">       msgDBService-&gt;UnregisterPendingListener(listener);</span>
<a href="#l3.3945"></a><span id="l3.3945">       m_virtualFolderListeners.RemoveElement(listener);</span>
<a href="#l3.3946"></a><span id="l3.3946">       break;</span>
<a href="#l3.3947"></a><span id="l3.3947">     }</span>
<a href="#l3.3948"></a><span id="l3.3948">   }</span>
<a href="#l3.3949"></a><span id="l3.3949">   return NS_OK;</span>
<a href="#l3.3950"></a><span id="l3.3950"> }</span>
<a href="#l3.3951"></a><span id="l3.3951"> </span>
<a href="#l3.3952"></a><span id="l3.3952" class="difflineminus">-NS_IMETHODIMP nsMsgAccountManager::GetAllFolders(nsIArray **aAllFolders)</span>
<a href="#l3.3953"></a><span id="l3.3953" class="difflineminus">-{</span>
<a href="#l3.3954"></a><span id="l3.3954" class="difflineplus">+NS_IMETHODIMP nsMsgAccountManager::GetAllFolders(nsIArray **aAllFolders) {</span>
<a href="#l3.3955"></a><span id="l3.3955">   NS_ENSURE_ARG_POINTER(aAllFolders);</span>
<a href="#l3.3956"></a><span id="l3.3956"> </span>
<a href="#l3.3957"></a><span id="l3.3957">   nsCOMPtr&lt;nsIArray&gt; servers;</span>
<a href="#l3.3958"></a><span id="l3.3958">   nsresult rv = GetAllServers(getter_AddRefs(servers));</span>
<a href="#l3.3959"></a><span id="l3.3959">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.3960"></a><span id="l3.3960"> </span>
<a href="#l3.3961"></a><span id="l3.3961">   uint32_t numServers = 0;</span>
<a href="#l3.3962"></a><span id="l3.3962">   rv = servers-&gt;GetLength(&amp;numServers);</span>
<a href="#l3.3963"></a><span id="l3.3963">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.3964"></a><span id="l3.3964"> </span>
<a href="#l3.3965"></a><span id="l3.3965" class="difflineminus">-  nsCOMPtr&lt;nsIMutableArray&gt; allFolders(do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l3.3966"></a><span id="l3.3966" class="difflineplus">+  nsCOMPtr&lt;nsIMutableArray&gt; allFolders(</span>
<a href="#l3.3967"></a><span id="l3.3967" class="difflineplus">+      do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l3.3968"></a><span id="l3.3968">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.3969"></a><span id="l3.3969"> </span>
<a href="#l3.3970"></a><span id="l3.3970">   uint32_t i;</span>
<a href="#l3.3971"></a><span id="l3.3971" class="difflineminus">-  for (i = 0; i &lt; numServers; i++)</span>
<a href="#l3.3972"></a><span id="l3.3972" class="difflineminus">-  {</span>
<a href="#l3.3973"></a><span id="l3.3973" class="difflineplus">+  for (i = 0; i &lt; numServers; i++) {</span>
<a href="#l3.3974"></a><span id="l3.3974">     nsCOMPtr&lt;nsIMsgIncomingServer&gt; server = do_QueryElementAt(servers, i);</span>
<a href="#l3.3975"></a><span id="l3.3975" class="difflineminus">-    if (server)</span>
<a href="#l3.3976"></a><span id="l3.3976" class="difflineminus">-    {</span>
<a href="#l3.3977"></a><span id="l3.3977" class="difflineplus">+    if (server) {</span>
<a href="#l3.3978"></a><span id="l3.3978">       nsCOMPtr&lt;nsIMsgFolder&gt; rootFolder;</span>
<a href="#l3.3979"></a><span id="l3.3979">       server-&gt;GetRootFolder(getter_AddRefs(rootFolder));</span>
<a href="#l3.3980"></a><span id="l3.3980" class="difflineminus">-      if (rootFolder)</span>
<a href="#l3.3981"></a><span id="l3.3981" class="difflineminus">-        rootFolder-&gt;ListDescendants(allFolders);</span>
<a href="#l3.3982"></a><span id="l3.3982" class="difflineplus">+      if (rootFolder) rootFolder-&gt;ListDescendants(allFolders);</span>
<a href="#l3.3983"></a><span id="l3.3983">     }</span>
<a href="#l3.3984"></a><span id="l3.3984">   }</span>
<a href="#l3.3985"></a><span id="l3.3985"> </span>
<a href="#l3.3986"></a><span id="l3.3986">   allFolders.forget(aAllFolders);</span>
<a href="#l3.3987"></a><span id="l3.3987">   return NS_OK;</span>
<a href="#l3.3988"></a><span id="l3.3988"> }</span>
<a href="#l3.3989"></a><span id="l3.3989"> </span>
<a href="#l3.3990"></a><span id="l3.3990" class="difflineminus">-NS_IMETHODIMP nsMsgAccountManager::OnItemAdded(nsIMsgFolder *parentItem, nsISupports *item)</span>
<a href="#l3.3991"></a><span id="l3.3991" class="difflineminus">-{</span>
<a href="#l3.3992"></a><span id="l3.3992" class="difflineplus">+NS_IMETHODIMP nsMsgAccountManager::OnItemAdded(nsIMsgFolder *parentItem,</span>
<a href="#l3.3993"></a><span id="l3.3993" class="difflineplus">+                                               nsISupports *item) {</span>
<a href="#l3.3994"></a><span id="l3.3994">   nsCOMPtr&lt;nsIMsgFolder&gt; folder = do_QueryInterface(item);</span>
<a href="#l3.3995"></a><span id="l3.3995">   // just kick out with a success code if the item in question is not a folder</span>
<a href="#l3.3996"></a><span id="l3.3996" class="difflineminus">-  if (!folder)</span>
<a href="#l3.3997"></a><span id="l3.3997" class="difflineminus">-    return NS_OK;</span>
<a href="#l3.3998"></a><span id="l3.3998" class="difflineplus">+  if (!folder) return NS_OK;</span>
<a href="#l3.3999"></a><span id="l3.3999"> </span>
<a href="#l3.4000"></a><span id="l3.4000">   uint32_t folderFlags;</span>
<a href="#l3.4001"></a><span id="l3.4001">   folder-&gt;GetFlags(&amp;folderFlags);</span>
<a href="#l3.4002"></a><span id="l3.4002">   bool addToSmartFolders = false;</span>
<a href="#l3.4003"></a><span id="l3.4003" class="difflineminus">-  folder-&gt;IsSpecialFolder(nsMsgFolderFlags::Inbox |</span>
<a href="#l3.4004"></a><span id="l3.4004" class="difflineminus">-                          nsMsgFolderFlags::Templates |</span>
<a href="#l3.4005"></a><span id="l3.4005" class="difflineminus">-                          nsMsgFolderFlags::Trash |</span>
<a href="#l3.4006"></a><span id="l3.4006" class="difflineminus">-                          nsMsgFolderFlags::Drafts, false,</span>
<a href="#l3.4007"></a><span id="l3.4007" class="difflineminus">-                          &amp;addToSmartFolders);</span>
<a href="#l3.4008"></a><span id="l3.4008" class="difflineplus">+  folder-&gt;IsSpecialFolder(</span>
<a href="#l3.4009"></a><span id="l3.4009" class="difflineplus">+      nsMsgFolderFlags::Inbox | nsMsgFolderFlags::Templates |</span>
<a href="#l3.4010"></a><span id="l3.4010" class="difflineplus">+          nsMsgFolderFlags::Trash | nsMsgFolderFlags::Drafts,</span>
<a href="#l3.4011"></a><span id="l3.4011" class="difflineplus">+      false, &amp;addToSmartFolders);</span>
<a href="#l3.4012"></a><span id="l3.4012">   // For Sent/Archives/Trash, we treat sub-folders of those folders as</span>
<a href="#l3.4013"></a><span id="l3.4013">   // &quot;special&quot;, and want to add them the smart folders search scope.</span>
<a href="#l3.4014"></a><span id="l3.4014">   // So we check if this is a sub-folder of one of those special folders</span>
<a href="#l3.4015"></a><span id="l3.4015">   // and set the corresponding folderFlag if so.</span>
<a href="#l3.4016"></a><span id="l3.4016" class="difflineminus">-  if (!addToSmartFolders)</span>
<a href="#l3.4017"></a><span id="l3.4017" class="difflineminus">-  {</span>
<a href="#l3.4018"></a><span id="l3.4018" class="difflineplus">+  if (!addToSmartFolders) {</span>
<a href="#l3.4019"></a><span id="l3.4019">     bool isSpecial = false;</span>
<a href="#l3.4020"></a><span id="l3.4020">     folder-&gt;IsSpecialFolder(nsMsgFolderFlags::SentMail, true, &amp;isSpecial);</span>
<a href="#l3.4021"></a><span id="l3.4021" class="difflineminus">-    if (isSpecial)</span>
<a href="#l3.4022"></a><span id="l3.4022" class="difflineminus">-    {</span>
<a href="#l3.4023"></a><span id="l3.4023" class="difflineplus">+    if (isSpecial) {</span>
<a href="#l3.4024"></a><span id="l3.4024">       addToSmartFolders = true;</span>
<a href="#l3.4025"></a><span id="l3.4025">       folderFlags |= nsMsgFolderFlags::SentMail;</span>
<a href="#l3.4026"></a><span id="l3.4026">     }</span>
<a href="#l3.4027"></a><span id="l3.4027">     folder-&gt;IsSpecialFolder(nsMsgFolderFlags::Archive, true, &amp;isSpecial);</span>
<a href="#l3.4028"></a><span id="l3.4028" class="difflineminus">-    if (isSpecial)</span>
<a href="#l3.4029"></a><span id="l3.4029" class="difflineminus">-    {</span>
<a href="#l3.4030"></a><span id="l3.4030" class="difflineplus">+    if (isSpecial) {</span>
<a href="#l3.4031"></a><span id="l3.4031">       addToSmartFolders = true;</span>
<a href="#l3.4032"></a><span id="l3.4032">       folderFlags |= nsMsgFolderFlags::Archive;</span>
<a href="#l3.4033"></a><span id="l3.4033">     }</span>
<a href="#l3.4034"></a><span id="l3.4034">     folder-&gt;IsSpecialFolder(nsMsgFolderFlags::Trash, true, &amp;isSpecial);</span>
<a href="#l3.4035"></a><span id="l3.4035" class="difflineminus">-    if (isSpecial)</span>
<a href="#l3.4036"></a><span id="l3.4036" class="difflineminus">-    {</span>
<a href="#l3.4037"></a><span id="l3.4037" class="difflineplus">+    if (isSpecial) {</span>
<a href="#l3.4038"></a><span id="l3.4038">       addToSmartFolders = true;</span>
<a href="#l3.4039"></a><span id="l3.4039">       folderFlags |= nsMsgFolderFlags::Trash;</span>
<a href="#l3.4040"></a><span id="l3.4040">     }</span>
<a href="#l3.4041"></a><span id="l3.4041">   }</span>
<a href="#l3.4042"></a><span id="l3.4042">   nsresult rv = NS_OK;</span>
<a href="#l3.4043"></a><span id="l3.4043">   // if this is a special folder, check if we have a saved search over</span>
<a href="#l3.4044"></a><span id="l3.4044">   // folders with this flag, and if so, add this folder to the scope.</span>
<a href="#l3.4045"></a><span id="l3.4045" class="difflineminus">-  if (addToSmartFolders)</span>
<a href="#l3.4046"></a><span id="l3.4046" class="difflineminus">-  {</span>
<a href="#l3.4047"></a><span id="l3.4047" class="difflineplus">+  if (addToSmartFolders) {</span>
<a href="#l3.4048"></a><span id="l3.4048">     // quick way to enumerate the saved searches.</span>
<a href="#l3.4049"></a><span id="l3.4049" class="difflineminus">-    nsTObserverArray&lt;RefPtr&lt;VirtualFolderChangeListener&gt; &gt;::ForwardIterator iter(m_virtualFolderListeners);</span>
<a href="#l3.4050"></a><span id="l3.4050" class="difflineplus">+    nsTObserverArray&lt;RefPtr&lt;VirtualFolderChangeListener&gt; &gt;::ForwardIterator</span>
<a href="#l3.4051"></a><span id="l3.4051" class="difflineplus">+        iter(m_virtualFolderListeners);</span>
<a href="#l3.4052"></a><span id="l3.4052">     RefPtr&lt;VirtualFolderChangeListener&gt; listener;</span>
<a href="#l3.4053"></a><span id="l3.4053"> </span>
<a href="#l3.4054"></a><span id="l3.4054" class="difflineminus">-    while (iter.HasMore())</span>
<a href="#l3.4055"></a><span id="l3.4055" class="difflineminus">-    {</span>
<a href="#l3.4056"></a><span id="l3.4056" class="difflineplus">+    while (iter.HasMore()) {</span>
<a href="#l3.4057"></a><span id="l3.4057">       listener = iter.GetNext();</span>
<a href="#l3.4058"></a><span id="l3.4058" class="difflineminus">-      nsCOMPtr &lt;nsIMsgDatabase&gt; db;</span>
<a href="#l3.4059"></a><span id="l3.4059" class="difflineminus">-      nsCOMPtr &lt;nsIDBFolderInfo&gt; dbFolderInfo;</span>
<a href="#l3.4060"></a><span id="l3.4060" class="difflineminus">-      listener-&gt;m_virtualFolder-&gt;GetDBFolderInfoAndDB(getter_AddRefs(dbFolderInfo),</span>
<a href="#l3.4061"></a><span id="l3.4061" class="difflineminus">-                                                      getter_AddRefs(db));</span>
<a href="#l3.4062"></a><span id="l3.4062" class="difflineminus">-      if (dbFolderInfo)</span>
<a href="#l3.4063"></a><span id="l3.4063" class="difflineminus">-      {</span>
<a href="#l3.4064"></a><span id="l3.4064" class="difflineplus">+      nsCOMPtr&lt;nsIMsgDatabase&gt; db;</span>
<a href="#l3.4065"></a><span id="l3.4065" class="difflineplus">+      nsCOMPtr&lt;nsIDBFolderInfo&gt; dbFolderInfo;</span>
<a href="#l3.4066"></a><span id="l3.4066" class="difflineplus">+      listener-&gt;m_virtualFolder-&gt;GetDBFolderInfoAndDB(</span>
<a href="#l3.4067"></a><span id="l3.4067" class="difflineplus">+          getter_AddRefs(dbFolderInfo), getter_AddRefs(db));</span>
<a href="#l3.4068"></a><span id="l3.4068" class="difflineplus">+      if (dbFolderInfo) {</span>
<a href="#l3.4069"></a><span id="l3.4069">         uint32_t vfFolderFlag;</span>
<a href="#l3.4070"></a><span id="l3.4070" class="difflineminus">-        dbFolderInfo-&gt;GetUint32Property(&quot;searchFolderFlag&quot;, 0, &amp; vfFolderFlag);</span>
<a href="#l3.4071"></a><span id="l3.4071" class="difflineplus">+        dbFolderInfo-&gt;GetUint32Property(&quot;searchFolderFlag&quot;, 0, &amp;vfFolderFlag);</span>
<a href="#l3.4072"></a><span id="l3.4072">         // found a saved search over folders w/ the same flag as the new folder.</span>
<a href="#l3.4073"></a><span id="l3.4073" class="difflineminus">-        if (vfFolderFlag &amp; folderFlags)</span>
<a href="#l3.4074"></a><span id="l3.4074" class="difflineminus">-        {</span>
<a href="#l3.4075"></a><span id="l3.4075" class="difflineplus">+        if (vfFolderFlag &amp; folderFlags) {</span>
<a href="#l3.4076"></a><span id="l3.4076">           nsCString searchURI;</span>
<a href="#l3.4077"></a><span id="l3.4077">           dbFolderInfo-&gt;GetCharProperty(kSearchFolderUriProp, searchURI);</span>
<a href="#l3.4078"></a><span id="l3.4078"> </span>
<a href="#l3.4079"></a><span id="l3.4079">           // &quot;normalize&quot; searchURI so we can search for |folderURI|.</span>
<a href="#l3.4080"></a><span id="l3.4080" class="difflineminus">-          if (!searchURI.IsEmpty())</span>
<a href="#l3.4081"></a><span id="l3.4081" class="difflineminus">-          {</span>
<a href="#l3.4082"></a><span id="l3.4082" class="difflineplus">+          if (!searchURI.IsEmpty()) {</span>
<a href="#l3.4083"></a><span id="l3.4083">             searchURI.Insert('|', 0);</span>
<a href="#l3.4084"></a><span id="l3.4084">             searchURI.Append('|');</span>
<a href="#l3.4085"></a><span id="l3.4085">           }</span>
<a href="#l3.4086"></a><span id="l3.4086">           nsCString folderURI;</span>
<a href="#l3.4087"></a><span id="l3.4087">           folder-&gt;GetURI(folderURI);</span>
<a href="#l3.4088"></a><span id="l3.4088"> </span>
<a href="#l3.4089"></a><span id="l3.4089">           int32_t index = searchURI.Find(folderURI);</span>
<a href="#l3.4090"></a><span id="l3.4090" class="difflineminus">-          if (index == kNotFound)</span>
<a href="#l3.4091"></a><span id="l3.4091" class="difflineminus">-          {</span>
<a href="#l3.4092"></a><span id="l3.4092" class="difflineplus">+          if (index == kNotFound) {</span>
<a href="#l3.4093"></a><span id="l3.4093">             searchURI.Cut(0, 1);</span>
<a href="#l3.4094"></a><span id="l3.4094">             searchURI.Append(folderURI);</span>
<a href="#l3.4095"></a><span id="l3.4095">             dbFolderInfo-&gt;SetCharProperty(kSearchFolderUriProp, searchURI);</span>
<a href="#l3.4096"></a><span id="l3.4096">             break;</span>
<a href="#l3.4097"></a><span id="l3.4097">           }</span>
<a href="#l3.4098"></a><span id="l3.4098" class="difflineminus">-          // New sent or archive folder, need to add sub-folders to smart folder.</span>
<a href="#l3.4099"></a><span id="l3.4099" class="difflineminus">-          if (vfFolderFlag &amp; (nsMsgFolderFlags::Archive | nsMsgFolderFlags::SentMail))</span>
<a href="#l3.4100"></a><span id="l3.4100" class="difflineminus">-          {</span>
<a href="#l3.4101"></a><span id="l3.4101" class="difflineplus">+          // New sent or archive folder, need to add sub-folders to smart</span>
<a href="#l3.4102"></a><span id="l3.4102" class="difflineplus">+          // folder.</span>
<a href="#l3.4103"></a><span id="l3.4103" class="difflineplus">+          if (vfFolderFlag &amp;</span>
<a href="#l3.4104"></a><span id="l3.4104" class="difflineplus">+              (nsMsgFolderFlags::Archive | nsMsgFolderFlags::SentMail)) {</span>
<a href="#l3.4105"></a><span id="l3.4105">             nsCOMPtr&lt;nsIArray&gt; allDescendants;</span>
<a href="#l3.4106"></a><span id="l3.4106">             rv = folder-&gt;GetDescendants(getter_AddRefs(allDescendants));</span>
<a href="#l3.4107"></a><span id="l3.4107">             NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.4108"></a><span id="l3.4108"> </span>
<a href="#l3.4109"></a><span id="l3.4109">             uint32_t cnt = 0;</span>
<a href="#l3.4110"></a><span id="l3.4110">             rv = allDescendants-&gt;GetLength(&amp;cnt);</span>
<a href="#l3.4111"></a><span id="l3.4111">             NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.4112"></a><span id="l3.4112"> </span>
<a href="#l3.4113"></a><span id="l3.4113">             nsCOMPtr&lt;nsIMsgFolder&gt; parent;</span>
<a href="#l3.4114"></a><span id="l3.4114" class="difflineminus">-            for (uint32_t j = 0; j &lt; cnt; j++)</span>
<a href="#l3.4115"></a><span id="l3.4115" class="difflineminus">-            {</span>
<a href="#l3.4116"></a><span id="l3.4116" class="difflineminus">-              nsCOMPtr&lt;nsIMsgFolder&gt; subFolder = do_QueryElementAt(allDescendants, j);</span>
<a href="#l3.4117"></a><span id="l3.4117" class="difflineminus">-              if (subFolder)</span>
<a href="#l3.4118"></a><span id="l3.4118" class="difflineminus">-              {</span>
<a href="#l3.4119"></a><span id="l3.4119" class="difflineplus">+            for (uint32_t j = 0; j &lt; cnt; j++) {</span>
<a href="#l3.4120"></a><span id="l3.4120" class="difflineplus">+              nsCOMPtr&lt;nsIMsgFolder&gt; subFolder =</span>
<a href="#l3.4121"></a><span id="l3.4121" class="difflineplus">+                  do_QueryElementAt(allDescendants, j);</span>
<a href="#l3.4122"></a><span id="l3.4122" class="difflineplus">+              if (subFolder) {</span>
<a href="#l3.4123"></a><span id="l3.4123">                 subFolder-&gt;GetParent(getter_AddRefs(parent));</span>
<a href="#l3.4124"></a><span id="l3.4124">                 OnItemAdded(parent, subFolder);</span>
<a href="#l3.4125"></a><span id="l3.4125">               }</span>
<a href="#l3.4126"></a><span id="l3.4126">             }</span>
<a href="#l3.4127"></a><span id="l3.4127">           }</span>
<a href="#l3.4128"></a><span id="l3.4128">         }</span>
<a href="#l3.4129"></a><span id="l3.4129">       }</span>
<a href="#l3.4130"></a><span id="l3.4130">     }</span>
<a href="#l3.4131"></a><span id="l3.4131">   }</span>
<a href="#l3.4132"></a><span id="l3.4132">   // need to make sure this isn't happening during loading of virtualfolders.dat</span>
<a href="#l3.4133"></a><span id="l3.4133" class="difflineminus">-  if (folderFlags &amp; nsMsgFolderFlags::Virtual &amp;&amp; !m_loadingVirtualFolders)</span>
<a href="#l3.4134"></a><span id="l3.4134" class="difflineminus">-  {</span>
<a href="#l3.4135"></a><span id="l3.4135" class="difflineplus">+  if (folderFlags &amp; nsMsgFolderFlags::Virtual &amp;&amp; !m_loadingVirtualFolders) {</span>
<a href="#l3.4136"></a><span id="l3.4136">     // When a new virtual folder is added, need to create a db Listener for it.</span>
<a href="#l3.4137"></a><span id="l3.4137" class="difflineminus">-    nsCOMPtr&lt;nsIMsgDBService&gt; msgDBService = do_GetService(NS_MSGDB_SERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l3.4138"></a><span id="l3.4138" class="difflineminus">-    if (msgDBService)</span>
<a href="#l3.4139"></a><span id="l3.4139" class="difflineminus">-    {</span>
<a href="#l3.4140"></a><span id="l3.4140" class="difflineminus">-      nsCOMPtr &lt;nsIMsgDatabase&gt; virtDatabase;</span>
<a href="#l3.4141"></a><span id="l3.4141" class="difflineminus">-      nsCOMPtr &lt;nsIDBFolderInfo&gt; dbFolderInfo;</span>
<a href="#l3.4142"></a><span id="l3.4142" class="difflineminus">-      rv = folder-&gt;GetDBFolderInfoAndDB(getter_AddRefs(dbFolderInfo), getter_AddRefs(virtDatabase));</span>
<a href="#l3.4143"></a><span id="l3.4143" class="difflineplus">+    nsCOMPtr&lt;nsIMsgDBService&gt; msgDBService =</span>
<a href="#l3.4144"></a><span id="l3.4144" class="difflineplus">+        do_GetService(NS_MSGDB_SERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l3.4145"></a><span id="l3.4145" class="difflineplus">+    if (msgDBService) {</span>
<a href="#l3.4146"></a><span id="l3.4146" class="difflineplus">+      nsCOMPtr&lt;nsIMsgDatabase&gt; virtDatabase;</span>
<a href="#l3.4147"></a><span id="l3.4147" class="difflineplus">+      nsCOMPtr&lt;nsIDBFolderInfo&gt; dbFolderInfo;</span>
<a href="#l3.4148"></a><span id="l3.4148" class="difflineplus">+      rv = folder-&gt;GetDBFolderInfoAndDB(getter_AddRefs(dbFolderInfo),</span>
<a href="#l3.4149"></a><span id="l3.4149" class="difflineplus">+                                        getter_AddRefs(virtDatabase));</span>
<a href="#l3.4150"></a><span id="l3.4150">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.4151"></a><span id="l3.4151">       nsCString srchFolderUri;</span>
<a href="#l3.4152"></a><span id="l3.4152">       dbFolderInfo-&gt;GetCharProperty(kSearchFolderUriProp, srchFolderUri);</span>
<a href="#l3.4153"></a><span id="l3.4153">       AddVFListenersForVF(folder, srchFolderUri, msgDBService);</span>
<a href="#l3.4154"></a><span id="l3.4154">     }</span>
<a href="#l3.4155"></a><span id="l3.4155">     rv = SaveVirtualFolders();</span>
<a href="#l3.4156"></a><span id="l3.4156">   }</span>
<a href="#l3.4157"></a><span id="l3.4157">   return rv;</span>
<a href="#l3.4158"></a><span id="l3.4158"> }</span>
<a href="#l3.4159"></a><span id="l3.4159"> </span>
<a href="#l3.4160"></a><span id="l3.4160" class="difflineminus">-NS_IMETHODIMP nsMsgAccountManager::OnItemRemoved(nsIMsgFolder *parentItem, nsISupports *item)</span>
<a href="#l3.4161"></a><span id="l3.4161" class="difflineminus">-{</span>
<a href="#l3.4162"></a><span id="l3.4162" class="difflineplus">+NS_IMETHODIMP nsMsgAccountManager::OnItemRemoved(nsIMsgFolder *parentItem,</span>
<a href="#l3.4163"></a><span id="l3.4163" class="difflineplus">+                                                 nsISupports *item) {</span>
<a href="#l3.4164"></a><span id="l3.4164">   nsCOMPtr&lt;nsIMsgFolder&gt; folder = do_QueryInterface(item);</span>
<a href="#l3.4165"></a><span id="l3.4165">   // just kick out with a success code if the item in question is not a folder</span>
<a href="#l3.4166"></a><span id="l3.4166" class="difflineminus">-  if (!folder)</span>
<a href="#l3.4167"></a><span id="l3.4167" class="difflineminus">-    return NS_OK;</span>
<a href="#l3.4168"></a><span id="l3.4168" class="difflineplus">+  if (!folder) return NS_OK;</span>
<a href="#l3.4169"></a><span id="l3.4169">   nsresult rv = NS_OK;</span>
<a href="#l3.4170"></a><span id="l3.4170">   uint32_t folderFlags;</span>
<a href="#l3.4171"></a><span id="l3.4171">   folder-&gt;GetFlags(&amp;folderFlags);</span>
<a href="#l3.4172"></a><span id="l3.4172" class="difflineminus">-  if (folderFlags &amp; nsMsgFolderFlags::Virtual) // if we removed a VF, flush VF list to disk.</span>
<a href="#l3.4173"></a><span id="l3.4173" class="difflineminus">-  {</span>
<a href="#l3.4174"></a><span id="l3.4174" class="difflineplus">+  // if we removed a VF, flush VF list to disk.</span>
<a href="#l3.4175"></a><span id="l3.4175" class="difflineplus">+  if (folderFlags &amp; nsMsgFolderFlags::Virtual) {</span>
<a href="#l3.4176"></a><span id="l3.4176">     rv = SaveVirtualFolders();</span>
<a href="#l3.4177"></a><span id="l3.4177" class="difflineminus">-    // clear flags on deleted folder if it's a virtual folder, so that creating a new folder</span>
<a href="#l3.4178"></a><span id="l3.4178" class="difflineminus">-    // with the same name doesn't cause confusion.</span>
<a href="#l3.4179"></a><span id="l3.4179" class="difflineplus">+    // clear flags on deleted folder if it's a virtual folder, so that creating</span>
<a href="#l3.4180"></a><span id="l3.4180" class="difflineplus">+    // a new folder with the same name doesn't cause confusion.</span>
<a href="#l3.4181"></a><span id="l3.4181">     folder-&gt;SetFlags(0);</span>
<a href="#l3.4182"></a><span id="l3.4182">     return rv;</span>
<a href="#l3.4183"></a><span id="l3.4183">   }</span>
<a href="#l3.4184"></a><span id="l3.4184">   // need to update the saved searches to check for a few things:</span>
<a href="#l3.4185"></a><span id="l3.4185">   // 1. Folder removed was in the scope of a saved search - if so, remove the</span>
<a href="#l3.4186"></a><span id="l3.4186">   //    uri from the scope of the saved search.</span>
<a href="#l3.4187"></a><span id="l3.4187">   // 2. If the scope is now empty, remove the saved search.</span>
<a href="#l3.4188"></a><span id="l3.4188"> </span>
<a href="#l3.4189"></a><span id="l3.4189">   // build a &quot;normalized&quot; uri that we can do a find on.</span>
<a href="#l3.4190"></a><span id="l3.4190">   nsCString removedFolderURI;</span>
<a href="#l3.4191"></a><span id="l3.4191">   folder-&gt;GetURI(removedFolderURI);</span>
<a href="#l3.4192"></a><span id="l3.4192">   removedFolderURI.Insert('|', 0);</span>
<a href="#l3.4193"></a><span id="l3.4193">   removedFolderURI.Append('|');</span>
<a href="#l3.4194"></a><span id="l3.4194"> </span>
<a href="#l3.4195"></a><span id="l3.4195">   // Enumerate the saved searches.</span>
<a href="#l3.4196"></a><span id="l3.4196" class="difflineminus">-  nsTObserverArray&lt;RefPtr&lt;VirtualFolderChangeListener&gt; &gt;::ForwardIterator iter(m_virtualFolderListeners);</span>
<a href="#l3.4197"></a><span id="l3.4197" class="difflineplus">+  nsTObserverArray&lt;RefPtr&lt;VirtualFolderChangeListener&gt; &gt;::ForwardIterator iter(</span>
<a href="#l3.4198"></a><span id="l3.4198" class="difflineplus">+      m_virtualFolderListeners);</span>
<a href="#l3.4199"></a><span id="l3.4199">   RefPtr&lt;VirtualFolderChangeListener&gt; listener;</span>
<a href="#l3.4200"></a><span id="l3.4200"> </span>
<a href="#l3.4201"></a><span id="l3.4201" class="difflineminus">-  while (iter.HasMore())</span>
<a href="#l3.4202"></a><span id="l3.4202" class="difflineminus">-  {</span>
<a href="#l3.4203"></a><span id="l3.4203" class="difflineplus">+  while (iter.HasMore()) {</span>
<a href="#l3.4204"></a><span id="l3.4204">     listener = iter.GetNext();</span>
<a href="#l3.4205"></a><span id="l3.4205">     nsCOMPtr&lt;nsIMsgDatabase&gt; db;</span>
<a href="#l3.4206"></a><span id="l3.4206">     nsCOMPtr&lt;nsIDBFolderInfo&gt; dbFolderInfo;</span>
<a href="#l3.4207"></a><span id="l3.4207">     nsCOMPtr&lt;nsIMsgFolder&gt; savedSearch = listener-&gt;m_virtualFolder;</span>
<a href="#l3.4208"></a><span id="l3.4208">     savedSearch-&gt;GetDBFolderInfoAndDB(getter_AddRefs(dbFolderInfo),</span>
<a href="#l3.4209"></a><span id="l3.4209">                                       getter_AddRefs(db));</span>
<a href="#l3.4210"></a><span id="l3.4210" class="difflineminus">-    if (dbFolderInfo)</span>
<a href="#l3.4211"></a><span id="l3.4211" class="difflineminus">-    {</span>
<a href="#l3.4212"></a><span id="l3.4212" class="difflineplus">+    if (dbFolderInfo) {</span>
<a href="#l3.4213"></a><span id="l3.4213">       nsCString searchURI;</span>
<a href="#l3.4214"></a><span id="l3.4214">       dbFolderInfo-&gt;GetCharProperty(kSearchFolderUriProp, searchURI);</span>
<a href="#l3.4215"></a><span id="l3.4215">       // &quot;normalize&quot; searchURI so we can search for |folderURI|.</span>
<a href="#l3.4216"></a><span id="l3.4216">       searchURI.Insert('|', 0);</span>
<a href="#l3.4217"></a><span id="l3.4217">       searchURI.Append('|');</span>
<a href="#l3.4218"></a><span id="l3.4218">       int32_t index = searchURI.Find(removedFolderURI);</span>
<a href="#l3.4219"></a><span id="l3.4219" class="difflineminus">-      if (index != kNotFound)</span>
<a href="#l3.4220"></a><span id="l3.4220" class="difflineminus">-      {</span>
<a href="#l3.4221"></a><span id="l3.4221" class="difflineplus">+      if (index != kNotFound) {</span>
<a href="#l3.4222"></a><span id="l3.4222">         RemoveVFListenerForVF(savedSearch, folder);</span>
<a href="#l3.4223"></a><span id="l3.4223"> </span>
<a href="#l3.4224"></a><span id="l3.4224">         // remove |folderURI</span>
<a href="#l3.4225"></a><span id="l3.4225">         searchURI.Cut(index, removedFolderURI.Length() - 1);</span>
<a href="#l3.4226"></a><span id="l3.4226">         // remove last '|' we added</span>
<a href="#l3.4227"></a><span id="l3.4227">         searchURI.SetLength(searchURI.Length() - 1);</span>
<a href="#l3.4228"></a><span id="l3.4228"> </span>
<a href="#l3.4229"></a><span id="l3.4229">         // if saved search is empty now, delete it.</span>
<a href="#l3.4230"></a><span id="l3.4230" class="difflineminus">-        if (searchURI.IsEmpty())</span>
<a href="#l3.4231"></a><span id="l3.4231" class="difflineminus">-        {</span>
<a href="#l3.4232"></a><span id="l3.4232" class="difflineplus">+        if (searchURI.IsEmpty()) {</span>
<a href="#l3.4233"></a><span id="l3.4233">           db = nullptr;</span>
<a href="#l3.4234"></a><span id="l3.4234">           dbFolderInfo = nullptr;</span>
<a href="#l3.4235"></a><span id="l3.4235"> </span>
<a href="#l3.4236"></a><span id="l3.4236">           nsCOMPtr&lt;nsIMsgFolder&gt; parent;</span>
<a href="#l3.4237"></a><span id="l3.4237">           rv = savedSearch-&gt;GetParent(getter_AddRefs(parent));</span>
<a href="#l3.4238"></a><span id="l3.4238">           NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.4239"></a><span id="l3.4239"> </span>
<a href="#l3.4240"></a><span id="l3.4240" class="difflineminus">-          if (!parent)</span>
<a href="#l3.4241"></a><span id="l3.4241" class="difflineminus">-            continue;</span>
<a href="#l3.4242"></a><span id="l3.4242" class="difflineplus">+          if (!parent) continue;</span>
<a href="#l3.4243"></a><span id="l3.4243">           parent-&gt;PropagateDelete(savedSearch, true, nullptr);</span>
<a href="#l3.4244"></a><span id="l3.4244" class="difflineminus">-        }</span>
<a href="#l3.4245"></a><span id="l3.4245" class="difflineminus">-        else</span>
<a href="#l3.4246"></a><span id="l3.4246" class="difflineminus">-        {</span>
<a href="#l3.4247"></a><span id="l3.4247" class="difflineminus">-        // remove leading '|' we added (or one after |folderURI, if first URI)</span>
<a href="#l3.4248"></a><span id="l3.4248" class="difflineplus">+        } else {</span>
<a href="#l3.4249"></a><span id="l3.4249" class="difflineplus">+          // remove leading '|' we added (or one after |folderURI, if first URI)</span>
<a href="#l3.4250"></a><span id="l3.4250">           searchURI.Cut(0, 1);</span>
<a href="#l3.4251"></a><span id="l3.4251">           dbFolderInfo-&gt;SetCharProperty(kSearchFolderUriProp, searchURI);</span>
<a href="#l3.4252"></a><span id="l3.4252">         }</span>
<a href="#l3.4253"></a><span id="l3.4253">       }</span>
<a href="#l3.4254"></a><span id="l3.4254">     }</span>
<a href="#l3.4255"></a><span id="l3.4255">   }</span>
<a href="#l3.4256"></a><span id="l3.4256"> </span>
<a href="#l3.4257"></a><span id="l3.4257">   return rv;</span>
<a href="#l3.4258"></a><span id="l3.4258"> }</span>
<a href="#l3.4259"></a><span id="l3.4259"> </span>
<a href="#l3.4260"></a><span id="l3.4260" class="difflineminus">-NS_IMETHODIMP nsMsgAccountManager::OnItemPropertyChanged(nsIMsgFolder *item, const nsACString &amp;property, const char *oldValue, const char *newValue)</span>
<a href="#l3.4261"></a><span id="l3.4261" class="difflineminus">-{</span>
<a href="#l3.4262"></a><span id="l3.4262" class="difflineplus">+NS_IMETHODIMP nsMsgAccountManager::OnItemPropertyChanged(</span>
<a href="#l3.4263"></a><span id="l3.4263" class="difflineplus">+    nsIMsgFolder *item, const nsACString &amp;property, const char *oldValue,</span>
<a href="#l3.4264"></a><span id="l3.4264" class="difflineplus">+    const char *newValue) {</span>
<a href="#l3.4265"></a><span id="l3.4265">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l3.4266"></a><span id="l3.4266"> }</span>
<a href="#l3.4267"></a><span id="l3.4267"> </span>
<a href="#l3.4268"></a><span id="l3.4268"> NS_IMETHODIMP</span>
<a href="#l3.4269"></a><span id="l3.4269"> nsMsgAccountManager::OnItemIntPropertyChanged(nsIMsgFolder *aFolder,</span>
<a href="#l3.4270"></a><span id="l3.4270">                                               const nsACString &amp;aProperty,</span>
<a href="#l3.4271"></a><span id="l3.4271">                                               int64_t oldValue,</span>
<a href="#l3.4272"></a><span id="l3.4272" class="difflineminus">-                                              int64_t newValue)</span>
<a href="#l3.4273"></a><span id="l3.4273" class="difflineminus">-{</span>
<a href="#l3.4274"></a><span id="l3.4274" class="difflineminus">-  if (aProperty.Equals(kFolderFlag))</span>
<a href="#l3.4275"></a><span id="l3.4275" class="difflineminus">-  {</span>
<a href="#l3.4276"></a><span id="l3.4276" class="difflineminus">-    uint32_t smartFlagsChanged = (oldValue ^ newValue) &amp;</span>
<a href="#l3.4277"></a><span id="l3.4277" class="difflineminus">-      (nsMsgFolderFlags::SpecialUse &amp; ~nsMsgFolderFlags::Queue);</span>
<a href="#l3.4278"></a><span id="l3.4278" class="difflineminus">-    if (smartFlagsChanged)</span>
<a href="#l3.4279"></a><span id="l3.4279" class="difflineminus">-    {</span>
<a href="#l3.4280"></a><span id="l3.4280" class="difflineminus">-      if (smartFlagsChanged &amp; newValue)</span>
<a href="#l3.4281"></a><span id="l3.4281" class="difflineminus">-      {</span>
<a href="#l3.4282"></a><span id="l3.4282" class="difflineplus">+                                              int64_t newValue) {</span>
<a href="#l3.4283"></a><span id="l3.4283" class="difflineplus">+  if (aProperty.Equals(kFolderFlag)) {</span>
<a href="#l3.4284"></a><span id="l3.4284" class="difflineplus">+    uint32_t smartFlagsChanged =</span>
<a href="#l3.4285"></a><span id="l3.4285" class="difflineplus">+        (oldValue ^ newValue) &amp;</span>
<a href="#l3.4286"></a><span id="l3.4286" class="difflineplus">+        (nsMsgFolderFlags::SpecialUse &amp; ~nsMsgFolderFlags::Queue);</span>
<a href="#l3.4287"></a><span id="l3.4287" class="difflineplus">+    if (smartFlagsChanged) {</span>
<a href="#l3.4288"></a><span id="l3.4288" class="difflineplus">+      if (smartFlagsChanged &amp; newValue) {</span>
<a href="#l3.4289"></a><span id="l3.4289">         // if the smart folder flag was set, calling OnItemAdded will</span>
<a href="#l3.4290"></a><span id="l3.4290">         // do the right thing.</span>
<a href="#l3.4291"></a><span id="l3.4291">         nsCOMPtr&lt;nsIMsgFolder&gt; parent;</span>
<a href="#l3.4292"></a><span id="l3.4292">         aFolder-&gt;GetParent(getter_AddRefs(parent));</span>
<a href="#l3.4293"></a><span id="l3.4293">         return OnItemAdded(parent, aFolder);</span>
<a href="#l3.4294"></a><span id="l3.4294">       }</span>
<a href="#l3.4295"></a><span id="l3.4295">       RemoveFolderFromSmartFolder(aFolder, smartFlagsChanged);</span>
<a href="#l3.4296"></a><span id="l3.4296">       // sent|archive flag removed, remove sub-folders from smart folder.</span>
<a href="#l3.4297"></a><span id="l3.4297" class="difflineminus">-      if (smartFlagsChanged &amp; (nsMsgFolderFlags::Archive | nsMsgFolderFlags::SentMail))</span>
<a href="#l3.4298"></a><span id="l3.4298" class="difflineminus">-      {</span>
<a href="#l3.4299"></a><span id="l3.4299" class="difflineplus">+      if (smartFlagsChanged &amp;</span>
<a href="#l3.4300"></a><span id="l3.4300" class="difflineplus">+          (nsMsgFolderFlags::Archive | nsMsgFolderFlags::SentMail)) {</span>
<a href="#l3.4301"></a><span id="l3.4301">         nsCOMPtr&lt;nsIArray&gt; allDescendants;</span>
<a href="#l3.4302"></a><span id="l3.4302">         nsresult rv = aFolder-&gt;GetDescendants(getter_AddRefs(allDescendants));</span>
<a href="#l3.4303"></a><span id="l3.4303">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.4304"></a><span id="l3.4304"> </span>
<a href="#l3.4305"></a><span id="l3.4305">         uint32_t cnt = 0;</span>
<a href="#l3.4306"></a><span id="l3.4306">         rv = allDescendants-&gt;GetLength(&amp;cnt);</span>
<a href="#l3.4307"></a><span id="l3.4307">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.4308"></a><span id="l3.4308"> </span>
<a href="#l3.4309"></a><span id="l3.4309">         nsCOMPtr&lt;nsIMsgFolder&gt; parent;</span>
<a href="#l3.4310"></a><span id="l3.4310" class="difflineminus">-        for (uint32_t j = 0; j &lt; cnt; j++)</span>
<a href="#l3.4311"></a><span id="l3.4311" class="difflineminus">-        {</span>
<a href="#l3.4312"></a><span id="l3.4312" class="difflineminus">-          nsCOMPtr&lt;nsIMsgFolder&gt; subFolder = do_QueryElementAt(allDescendants, j);</span>
<a href="#l3.4313"></a><span id="l3.4313" class="difflineplus">+        for (uint32_t j = 0; j &lt; cnt; j++) {</span>
<a href="#l3.4314"></a><span id="l3.4314" class="difflineplus">+          nsCOMPtr&lt;nsIMsgFolder&gt; subFolder =</span>
<a href="#l3.4315"></a><span id="l3.4315" class="difflineplus">+              do_QueryElementAt(allDescendants, j);</span>
<a href="#l3.4316"></a><span id="l3.4316">           if (subFolder)</span>
<a href="#l3.4317"></a><span id="l3.4317">             RemoveFolderFromSmartFolder(subFolder, smartFlagsChanged);</span>
<a href="#l3.4318"></a><span id="l3.4318">         }</span>
<a href="#l3.4319"></a><span id="l3.4319">       }</span>
<a href="#l3.4320"></a><span id="l3.4320">     }</span>
<a href="#l3.4321"></a><span id="l3.4321">   }</span>
<a href="#l3.4322"></a><span id="l3.4322">   return NS_OK;</span>
<a href="#l3.4323"></a><span id="l3.4323"> }</span>
<a href="#l3.4324"></a><span id="l3.4324"> </span>
<a href="#l3.4325"></a><span id="l3.4325" class="difflineminus">-nsresult</span>
<a href="#l3.4326"></a><span id="l3.4326" class="difflineminus">-nsMsgAccountManager::RemoveFolderFromSmartFolder(nsIMsgFolder *aFolder,</span>
<a href="#l3.4327"></a><span id="l3.4327" class="difflineminus">-                                                 uint32_t flagsChanged)</span>
<a href="#l3.4328"></a><span id="l3.4328" class="difflineminus">-{</span>
<a href="#l3.4329"></a><span id="l3.4329" class="difflineplus">+nsresult nsMsgAccountManager::RemoveFolderFromSmartFolder(</span>
<a href="#l3.4330"></a><span id="l3.4330" class="difflineplus">+    nsIMsgFolder *aFolder, uint32_t flagsChanged) {</span>
<a href="#l3.4331"></a><span id="l3.4331">   nsCString removedFolderURI;</span>
<a href="#l3.4332"></a><span id="l3.4332">   aFolder-&gt;GetURI(removedFolderURI);</span>
<a href="#l3.4333"></a><span id="l3.4333">   removedFolderURI.Insert('|', 0);</span>
<a href="#l3.4334"></a><span id="l3.4334">   removedFolderURI.Append('|');</span>
<a href="#l3.4335"></a><span id="l3.4335">   uint32_t flags;</span>
<a href="#l3.4336"></a><span id="l3.4336">   aFolder-&gt;GetFlags(&amp;flags);</span>
<a href="#l3.4337"></a><span id="l3.4337">   NS_ASSERTION(!(flags &amp; flagsChanged), &quot;smart folder flag should not be set&quot;);</span>
<a href="#l3.4338"></a><span id="l3.4338">   // Flag was removed. Look for smart folder based on that flag,</span>
<a href="#l3.4339"></a><span id="l3.4339">   // and remove this folder from its scope.</span>
<a href="#l3.4340"></a><span id="l3.4340" class="difflineminus">-  nsTObserverArray&lt;RefPtr&lt;VirtualFolderChangeListener&gt; &gt;::ForwardIterator iter(m_virtualFolderListeners);</span>
<a href="#l3.4341"></a><span id="l3.4341" class="difflineplus">+  nsTObserverArray&lt;RefPtr&lt;VirtualFolderChangeListener&gt; &gt;::ForwardIterator iter(</span>
<a href="#l3.4342"></a><span id="l3.4342" class="difflineplus">+      m_virtualFolderListeners);</span>
<a href="#l3.4343"></a><span id="l3.4343">   RefPtr&lt;VirtualFolderChangeListener&gt; listener;</span>
<a href="#l3.4344"></a><span id="l3.4344"> </span>
<a href="#l3.4345"></a><span id="l3.4345" class="difflineminus">-  while (iter.HasMore())</span>
<a href="#l3.4346"></a><span id="l3.4346" class="difflineminus">-  {</span>
<a href="#l3.4347"></a><span id="l3.4347" class="difflineplus">+  while (iter.HasMore()) {</span>
<a href="#l3.4348"></a><span id="l3.4348">     listener = iter.GetNext();</span>
<a href="#l3.4349"></a><span id="l3.4349" class="difflineminus">-    nsCOMPtr &lt;nsIMsgDatabase&gt; db;</span>
<a href="#l3.4350"></a><span id="l3.4350" class="difflineminus">-    nsCOMPtr &lt;nsIDBFolderInfo&gt; dbFolderInfo;</span>
<a href="#l3.4351"></a><span id="l3.4351" class="difflineminus">-    listener-&gt;m_virtualFolder-&gt;GetDBFolderInfoAndDB(getter_AddRefs(dbFolderInfo),</span>
<a href="#l3.4352"></a><span id="l3.4352" class="difflineminus">-                                                    getter_AddRefs(db));</span>
<a href="#l3.4353"></a><span id="l3.4353" class="difflineminus">-    if (dbFolderInfo)</span>
<a href="#l3.4354"></a><span id="l3.4354" class="difflineminus">-    {</span>
<a href="#l3.4355"></a><span id="l3.4355" class="difflineplus">+    nsCOMPtr&lt;nsIMsgDatabase&gt; db;</span>
<a href="#l3.4356"></a><span id="l3.4356" class="difflineplus">+    nsCOMPtr&lt;nsIDBFolderInfo&gt; dbFolderInfo;</span>
<a href="#l3.4357"></a><span id="l3.4357" class="difflineplus">+    listener-&gt;m_virtualFolder-&gt;GetDBFolderInfoAndDB(</span>
<a href="#l3.4358"></a><span id="l3.4358" class="difflineplus">+        getter_AddRefs(dbFolderInfo), getter_AddRefs(db));</span>
<a href="#l3.4359"></a><span id="l3.4359" class="difflineplus">+    if (dbFolderInfo) {</span>
<a href="#l3.4360"></a><span id="l3.4360">       uint32_t vfFolderFlag;</span>
<a href="#l3.4361"></a><span id="l3.4361" class="difflineminus">-      dbFolderInfo-&gt;GetUint32Property(&quot;searchFolderFlag&quot;, 0, &amp; vfFolderFlag);</span>
<a href="#l3.4362"></a><span id="l3.4362" class="difflineplus">+      dbFolderInfo-&gt;GetUint32Property(&quot;searchFolderFlag&quot;, 0, &amp;vfFolderFlag);</span>
<a href="#l3.4363"></a><span id="l3.4363">       // found a smart folder over the removed flag</span>
<a href="#l3.4364"></a><span id="l3.4364" class="difflineminus">-      if (vfFolderFlag &amp; flagsChanged)</span>
<a href="#l3.4365"></a><span id="l3.4365" class="difflineminus">-      {</span>
<a href="#l3.4366"></a><span id="l3.4366" class="difflineplus">+      if (vfFolderFlag &amp; flagsChanged) {</span>
<a href="#l3.4367"></a><span id="l3.4367">         nsCString searchURI;</span>
<a href="#l3.4368"></a><span id="l3.4368">         dbFolderInfo-&gt;GetCharProperty(kSearchFolderUriProp, searchURI);</span>
<a href="#l3.4369"></a><span id="l3.4369">         // &quot;normalize&quot; searchURI so we can search for |folderURI|.</span>
<a href="#l3.4370"></a><span id="l3.4370">         searchURI.Insert('|', 0);</span>
<a href="#l3.4371"></a><span id="l3.4371">         searchURI.Append('|');</span>
<a href="#l3.4372"></a><span id="l3.4372">         int32_t index = searchURI.Find(removedFolderURI);</span>
<a href="#l3.4373"></a><span id="l3.4373" class="difflineminus">-        if (index != kNotFound)</span>
<a href="#l3.4374"></a><span id="l3.4374" class="difflineminus">-        {</span>
<a href="#l3.4375"></a><span id="l3.4375" class="difflineplus">+        if (index != kNotFound) {</span>
<a href="#l3.4376"></a><span id="l3.4376">           RemoveVFListenerForVF(listener-&gt;m_virtualFolder, aFolder);</span>
<a href="#l3.4377"></a><span id="l3.4377"> </span>
<a href="#l3.4378"></a><span id="l3.4378">           // remove |folderURI</span>
<a href="#l3.4379"></a><span id="l3.4379">           searchURI.Cut(index, removedFolderURI.Length() - 1);</span>
<a href="#l3.4380"></a><span id="l3.4380">           // remove last '|' we added</span>
<a href="#l3.4381"></a><span id="l3.4381">           searchURI.SetLength(searchURI.Length() - 1);</span>
<a href="#l3.4382"></a><span id="l3.4382"> </span>
<a href="#l3.4383"></a><span id="l3.4383">           // remove leading '|' we added (or one after |folderURI, if first URI)</span>
<a href="#l3.4384"></a><span id="l3.4384" class="difflineat">@@ -3560,89 +3278,87 @@ nsMsgAccountManager::RemoveFolderFromSma</span>
<a href="#l3.4385"></a><span id="l3.4385">           dbFolderInfo-&gt;SetCharProperty(kSearchFolderUriProp, searchURI);</span>
<a href="#l3.4386"></a><span id="l3.4386">         }</span>
<a href="#l3.4387"></a><span id="l3.4387">       }</span>
<a href="#l3.4388"></a><span id="l3.4388">     }</span>
<a href="#l3.4389"></a><span id="l3.4389">   }</span>
<a href="#l3.4390"></a><span id="l3.4390">   return NS_OK;</span>
<a href="#l3.4391"></a><span id="l3.4391"> }</span>
<a href="#l3.4392"></a><span id="l3.4392"> </span>
<a href="#l3.4393"></a><span id="l3.4393" class="difflineminus">-NS_IMETHODIMP nsMsgAccountManager::OnItemBoolPropertyChanged(nsIMsgFolder *item, const nsACString &amp;property, bool oldValue, bool newValue)</span>
<a href="#l3.4394"></a><span id="l3.4394" class="difflineminus">-{</span>
<a href="#l3.4395"></a><span id="l3.4395" class="difflineminus">-  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l3.4396"></a><span id="l3.4396" class="difflineminus">-}</span>
<a href="#l3.4397"></a><span id="l3.4397" class="difflineminus">-</span>
<a href="#l3.4398"></a><span id="l3.4398" class="difflineminus">-NS_IMETHODIMP nsMsgAccountManager::OnItemUnicharPropertyChanged(nsIMsgFolder *item, const nsACString &amp;property, const char16_t *oldValue, const char16_t *newValue)</span>
<a href="#l3.4399"></a><span id="l3.4399" class="difflineminus">-{</span>
<a href="#l3.4400"></a><span id="l3.4400" class="difflineplus">+NS_IMETHODIMP nsMsgAccountManager::OnItemBoolPropertyChanged(</span>
<a href="#l3.4401"></a><span id="l3.4401" class="difflineplus">+    nsIMsgFolder *item, const nsACString &amp;property, bool oldValue,</span>
<a href="#l3.4402"></a><span id="l3.4402" class="difflineplus">+    bool newValue) {</span>
<a href="#l3.4403"></a><span id="l3.4403">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l3.4404"></a><span id="l3.4404"> }</span>
<a href="#l3.4405"></a><span id="l3.4405"> </span>
<a href="#l3.4406"></a><span id="l3.4406" class="difflineminus">-</span>
<a href="#l3.4407"></a><span id="l3.4407" class="difflineminus">-NS_IMETHODIMP nsMsgAccountManager::OnItemPropertyFlagChanged(nsIMsgDBHdr *item, const nsACString &amp;property, uint32_t oldFlag, uint32_t newFlag)</span>
<a href="#l3.4408"></a><span id="l3.4408" class="difflineminus">-{</span>
<a href="#l3.4409"></a><span id="l3.4409" class="difflineplus">+NS_IMETHODIMP nsMsgAccountManager::OnItemUnicharPropertyChanged(</span>
<a href="#l3.4410"></a><span id="l3.4410" class="difflineplus">+    nsIMsgFolder *item, const nsACString &amp;property, const char16_t *oldValue,</span>
<a href="#l3.4411"></a><span id="l3.4411" class="difflineplus">+    const char16_t *newValue) {</span>
<a href="#l3.4412"></a><span id="l3.4412">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l3.4413"></a><span id="l3.4413"> }</span>
<a href="#l3.4414"></a><span id="l3.4414"> </span>
<a href="#l3.4415"></a><span id="l3.4415" class="difflineminus">-NS_IMETHODIMP nsMsgAccountManager::OnItemEvent(nsIMsgFolder *aFolder, const nsACString &amp;aEvent)</span>
<a href="#l3.4416"></a><span id="l3.4416" class="difflineminus">-{</span>
<a href="#l3.4417"></a><span id="l3.4417" class="difflineplus">+NS_IMETHODIMP nsMsgAccountManager::OnItemPropertyFlagChanged(</span>
<a href="#l3.4418"></a><span id="l3.4418" class="difflineplus">+    nsIMsgDBHdr *item, const nsACString &amp;property, uint32_t oldFlag,</span>
<a href="#l3.4419"></a><span id="l3.4419" class="difflineplus">+    uint32_t newFlag) {</span>
<a href="#l3.4420"></a><span id="l3.4420" class="difflineplus">+  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l3.4421"></a><span id="l3.4421" class="difflineplus">+}</span>
<a href="#l3.4422"></a><span id="l3.4422" class="difflineplus">+</span>
<a href="#l3.4423"></a><span id="l3.4423" class="difflineplus">+NS_IMETHODIMP nsMsgAccountManager::OnItemEvent(nsIMsgFolder *aFolder,</span>
<a href="#l3.4424"></a><span id="l3.4424" class="difflineplus">+                                               const nsACString &amp;aEvent) {</span>
<a href="#l3.4425"></a><span id="l3.4425">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l3.4426"></a><span id="l3.4426"> }</span>
<a href="#l3.4427"></a><span id="l3.4427"> </span>
<a href="#l3.4428"></a><span id="l3.4428"> NS_IMETHODIMP</span>
<a href="#l3.4429"></a><span id="l3.4429"> nsMsgAccountManager::FolderUriForPath(nsIFile *aLocalPath,</span>
<a href="#l3.4430"></a><span id="l3.4430" class="difflineminus">-                                               nsACString &amp;aMailboxUri)</span>
<a href="#l3.4431"></a><span id="l3.4431" class="difflineminus">-{</span>
<a href="#l3.4432"></a><span id="l3.4432" class="difflineplus">+                                      nsACString &amp;aMailboxUri) {</span>
<a href="#l3.4433"></a><span id="l3.4433">   NS_ENSURE_ARG_POINTER(aLocalPath);</span>
<a href="#l3.4434"></a><span id="l3.4434">   bool equals;</span>
<a href="#l3.4435"></a><span id="l3.4435">   if (m_lastPathLookedUp &amp;&amp;</span>
<a href="#l3.4436"></a><span id="l3.4436" class="difflineminus">-      NS_SUCCEEDED(aLocalPath-&gt;Equals(m_lastPathLookedUp, &amp;equals)) &amp;&amp; equals)</span>
<a href="#l3.4437"></a><span id="l3.4437" class="difflineminus">-  {</span>
<a href="#l3.4438"></a><span id="l3.4438" class="difflineplus">+      NS_SUCCEEDED(aLocalPath-&gt;Equals(m_lastPathLookedUp, &amp;equals)) &amp;&amp; equals) {</span>
<a href="#l3.4439"></a><span id="l3.4439">     aMailboxUri = m_lastFolderURIForPath;</span>
<a href="#l3.4440"></a><span id="l3.4440">     return NS_OK;</span>
<a href="#l3.4441"></a><span id="l3.4441">   }</span>
<a href="#l3.4442"></a><span id="l3.4442">   nsCOMPtr&lt;nsIArray&gt; folderArray;</span>
<a href="#l3.4443"></a><span id="l3.4443">   nsresult rv = GetAllFolders(getter_AddRefs(folderArray));</span>
<a href="#l3.4444"></a><span id="l3.4444">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.4445"></a><span id="l3.4445"> </span>
<a href="#l3.4446"></a><span id="l3.4446">   uint32_t count;</span>
<a href="#l3.4447"></a><span id="l3.4447">   rv = folderArray-&gt;GetLength(&amp;count);</span>
<a href="#l3.4448"></a><span id="l3.4448">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.4449"></a><span id="l3.4449"> </span>
<a href="#l3.4450"></a><span id="l3.4450" class="difflineminus">-  for (uint32_t i = 0; i &lt; count; i++)</span>
<a href="#l3.4451"></a><span id="l3.4451" class="difflineminus">-  {</span>
<a href="#l3.4452"></a><span id="l3.4452" class="difflineplus">+  for (uint32_t i = 0; i &lt; count; i++) {</span>
<a href="#l3.4453"></a><span id="l3.4453">     nsCOMPtr&lt;nsIMsgFolder&gt; folder(do_QueryElementAt(folderArray, i, &amp;rv));</span>
<a href="#l3.4454"></a><span id="l3.4454">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.4455"></a><span id="l3.4455"> </span>
<a href="#l3.4456"></a><span id="l3.4456">     nsCOMPtr&lt;nsIFile&gt; folderPath;</span>
<a href="#l3.4457"></a><span id="l3.4457">     rv = folder-&gt;GetFilePath(getter_AddRefs(folderPath));</span>
<a href="#l3.4458"></a><span id="l3.4458">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.4459"></a><span id="l3.4459"> </span>
<a href="#l3.4460"></a><span id="l3.4460">     // Check if we're equal</span>
<a href="#l3.4461"></a><span id="l3.4461">     rv = folderPath-&gt;Equals(aLocalPath, &amp;equals);</span>
<a href="#l3.4462"></a><span id="l3.4462">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.4463"></a><span id="l3.4463"> </span>
<a href="#l3.4464"></a><span id="l3.4464" class="difflineminus">-    if (equals)</span>
<a href="#l3.4465"></a><span id="l3.4465" class="difflineminus">-    {</span>
<a href="#l3.4466"></a><span id="l3.4466" class="difflineplus">+    if (equals) {</span>
<a href="#l3.4467"></a><span id="l3.4467">       rv = folder-&gt;GetURI(aMailboxUri);</span>
<a href="#l3.4468"></a><span id="l3.4468">       m_lastFolderURIForPath = aMailboxUri;</span>
<a href="#l3.4469"></a><span id="l3.4469">       aLocalPath-&gt;Clone(getter_AddRefs(m_lastPathLookedUp));</span>
<a href="#l3.4470"></a><span id="l3.4470">       return rv;</span>
<a href="#l3.4471"></a><span id="l3.4471">     }</span>
<a href="#l3.4472"></a><span id="l3.4472">   }</span>
<a href="#l3.4473"></a><span id="l3.4473">   return NS_ERROR_FAILURE;</span>
<a href="#l3.4474"></a><span id="l3.4474"> }</span>
<a href="#l3.4475"></a><span id="l3.4475"> </span>
<a href="#l3.4476"></a><span id="l3.4476"> NS_IMETHODIMP</span>
<a href="#l3.4477"></a><span id="l3.4477" class="difflineminus">-nsMsgAccountManager::GetSortOrder(nsIMsgIncomingServer* aServer, int32_t* aSortOrder)</span>
<a href="#l3.4478"></a><span id="l3.4478" class="difflineminus">-{</span>
<a href="#l3.4479"></a><span id="l3.4479" class="difflineplus">+nsMsgAccountManager::GetSortOrder(nsIMsgIncomingServer *aServer,</span>
<a href="#l3.4480"></a><span id="l3.4480" class="difflineplus">+                                  int32_t *aSortOrder) {</span>
<a href="#l3.4481"></a><span id="l3.4481">   NS_ENSURE_ARG_POINTER(aServer);</span>
<a href="#l3.4482"></a><span id="l3.4482">   NS_ENSURE_ARG_POINTER(aSortOrder);</span>
<a href="#l3.4483"></a><span id="l3.4483"> </span>
<a href="#l3.4484"></a><span id="l3.4484" class="difflineminus">-  // If the passed in server is the default, return its sort order as 0 regardless</span>
<a href="#l3.4485"></a><span id="l3.4485" class="difflineminus">-  // of its server sort order.</span>
<a href="#l3.4486"></a><span id="l3.4486" class="difflineplus">+  // If the passed in server is the default, return its sort order as 0</span>
<a href="#l3.4487"></a><span id="l3.4487" class="difflineplus">+  // regardless of its server sort order.</span>
<a href="#l3.4488"></a><span id="l3.4488"> </span>
<a href="#l3.4489"></a><span id="l3.4489">   nsCOMPtr&lt;nsIMsgAccount&gt; defaultAccount;</span>
<a href="#l3.4490"></a><span id="l3.4490">   nsresult rv = GetDefaultAccount(getter_AddRefs(defaultAccount));</span>
<a href="#l3.4491"></a><span id="l3.4491">   if (NS_SUCCEEDED(rv) &amp;&amp; defaultAccount) {</span>
<a href="#l3.4492"></a><span id="l3.4492">     nsCOMPtr&lt;nsIMsgIncomingServer&gt; defaultServer;</span>
<a href="#l3.4493"></a><span id="l3.4493">     rv = m_defaultAccount-&gt;GetIncomingServer(getter_AddRefs(defaultServer));</span>
<a href="#l3.4494"></a><span id="l3.4494">     if (NS_SUCCEEDED(rv) &amp;&amp; (aServer == defaultServer)) {</span>
<a href="#l3.4495"></a><span id="l3.4495">       *aSortOrder = 0;</span>
<a href="#l3.4496"></a><span id="l3.4496" class="difflineat">@@ -3656,18 +3372,17 @@ nsMsgAccountManager::GetSortOrder(nsIMsg</span>
<a href="#l3.4497"></a><span id="l3.4497">   // the accounts list. This ensures that even when several accounts have the</span>
<a href="#l3.4498"></a><span id="l3.4498">   // same sort order value, the returned value is not the same and keeps</span>
<a href="#l3.4499"></a><span id="l3.4499">   // their relative order in the account list when and unstable sort is run</span>
<a href="#l3.4500"></a><span id="l3.4500">   // on the returned sort order values.</span>
<a href="#l3.4501"></a><span id="l3.4501">   int32_t sortOrder;</span>
<a href="#l3.4502"></a><span id="l3.4502">   int32_t serverIndex;</span>
<a href="#l3.4503"></a><span id="l3.4503"> </span>
<a href="#l3.4504"></a><span id="l3.4504">   rv = aServer-&gt;GetSortOrder(&amp;sortOrder);</span>
<a href="#l3.4505"></a><span id="l3.4505" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l3.4506"></a><span id="l3.4506" class="difflineminus">-    rv = FindServerIndex(aServer, &amp;serverIndex);</span>
<a href="#l3.4507"></a><span id="l3.4507" class="difflineplus">+  if (NS_SUCCEEDED(rv)) rv = FindServerIndex(aServer, &amp;serverIndex);</span>
<a href="#l3.4508"></a><span id="l3.4508"> </span>
<a href="#l3.4509"></a><span id="l3.4509">   if (NS_FAILED(rv)) {</span>
<a href="#l3.4510"></a><span id="l3.4510">     *aSortOrder = 999999999;</span>
<a href="#l3.4511"></a><span id="l3.4511">   } else {</span>
<a href="#l3.4512"></a><span id="l3.4512">     *aSortOrder = sortOrder + serverIndex;</span>
<a href="#l3.4513"></a><span id="l3.4513">   }</span>
<a href="#l3.4514"></a><span id="l3.4514"> </span>
<a href="#l3.4515"></a><span id="l3.4515">   return NS_OK;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/base/src/nsMsgAccountManager.h</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgAccountManager.h</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -1,16 +1,17 @@</span>
<a href="#l4.4"></a><span id="l4.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l4.5"></a><span id="l4.5">  *</span>
<a href="#l4.6"></a><span id="l4.6">  * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l4.7"></a><span id="l4.7">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l4.8"></a><span id="l4.8">  * file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l4.9"></a><span id="l4.9" class="difflineminus">- * This Original Code has been modified by IBM Corporation. Modifications made by IBM</span>
<a href="#l4.10"></a><span id="l4.10" class="difflineminus">- * described herein are Copyright (c) International Business Machines Corporation, 2000.</span>
<a href="#l4.11"></a><span id="l4.11" class="difflineminus">- * Modifications to Mozilla code or documentation identified per MPL Section 3.3</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+ * This Original Code has been modified by IBM Corporation. Modifications made</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+ * by IBM described herein are Copyright (c) International Business Machines</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+ * Corporation, 2000. Modifications to Mozilla code or documentation identified</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+ * per MPL Section 3.3</span>
<a href="#l4.16"></a><span id="l4.16">  *</span>
<a href="#l4.17"></a><span id="l4.17">  * Date             Modified by     Description of modification</span>
<a href="#l4.18"></a><span id="l4.18">  * 04/20/2000       IBM Corp.      OS/2 VisualAge build.</span>
<a href="#l4.19"></a><span id="l4.19">  */</span>
<a href="#l4.20"></a><span id="l4.20"> </span>
<a href="#l4.21"></a><span id="l4.21"> #include &quot;nscore.h&quot;</span>
<a href="#l4.22"></a><span id="l4.22"> #include &quot;nsIMsgAccountManager.h&quot;</span>
<a href="#l4.23"></a><span id="l4.23"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineat">@@ -24,19 +25,18 @@</span>
<a href="#l4.25"></a><span id="l4.25"> #include &quot;nsCOMArray.h&quot;</span>
<a href="#l4.26"></a><span id="l4.26"> #include &quot;nsIMsgSearchSession.h&quot;</span>
<a href="#l4.27"></a><span id="l4.27"> #include &quot;nsInterfaceHashtable.h&quot;</span>
<a href="#l4.28"></a><span id="l4.28"> #include &quot;nsIMsgDatabase.h&quot;</span>
<a href="#l4.29"></a><span id="l4.29"> #include &quot;nsIDBChangeListener.h&quot;</span>
<a href="#l4.30"></a><span id="l4.30"> #include &quot;nsAutoPtr.h&quot;</span>
<a href="#l4.31"></a><span id="l4.31"> #include &quot;nsTObserverArray.h&quot;</span>
<a href="#l4.32"></a><span id="l4.32"> </span>
<a href="#l4.33"></a><span id="l4.33" class="difflineminus">-class VirtualFolderChangeListener final : public nsIDBChangeListener</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineminus">-{</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineminus">-public:</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineplus">+class VirtualFolderChangeListener final : public nsIDBChangeListener {</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineplus">+ public:</span>
<a href="#l4.38"></a><span id="l4.38">   VirtualFolderChangeListener();</span>
<a href="#l4.39"></a><span id="l4.39"> </span>
<a href="#l4.40"></a><span id="l4.40">   NS_DECL_ISUPPORTS</span>
<a href="#l4.41"></a><span id="l4.41">   NS_DECL_NSIDBCHANGELISTENER</span>
<a href="#l4.42"></a><span id="l4.42"> </span>
<a href="#l4.43"></a><span id="l4.43">   nsresult Init();</span>
<a href="#l4.44"></a><span id="l4.44">   /**</span>
<a href="#l4.45"></a><span id="l4.45">    * Posts an event to update the summary totals and commit the db.</span>
<a href="#l4.46"></a><span id="l4.46" class="difflineat">@@ -44,61 +44,62 @@ public:</span>
<a href="#l4.47"></a><span id="l4.47">    * in a synchronous loop.</span>
<a href="#l4.48"></a><span id="l4.48">    */</span>
<a href="#l4.49"></a><span id="l4.49">   nsresult PostUpdateEvent(nsIMsgFolder *folder, nsIMsgDatabase *db);</span>
<a href="#l4.50"></a><span id="l4.50">   /// Handles event posted to event queue to batch notifications.</span>
<a href="#l4.51"></a><span id="l4.51">   void ProcessUpdateEvent(nsIMsgFolder *folder, nsIMsgDatabase *db);</span>
<a href="#l4.52"></a><span id="l4.52"> </span>
<a href="#l4.53"></a><span id="l4.53">   void DecrementNewMsgCount();</span>
<a href="#l4.54"></a><span id="l4.54"> </span>
<a href="#l4.55"></a><span id="l4.55" class="difflineminus">-  nsCOMPtr &lt;nsIMsgFolder&gt; m_virtualFolder; // folder we're listening to db changes on behalf of.</span>
<a href="#l4.56"></a><span id="l4.56" class="difflineminus">-  nsCOMPtr &lt;nsIMsgFolder&gt; m_folderWatching; // folder whose db we're listening to.</span>
<a href="#l4.57"></a><span id="l4.57" class="difflineminus">-  nsCOMPtr &lt;nsIMsgSearchSession&gt; m_searchSession;</span>
<a href="#l4.58"></a><span id="l4.58" class="difflineplus">+  // folder we're listening to db changes on behalf of.</span>
<a href="#l4.59"></a><span id="l4.59" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; m_virtualFolder;</span>
<a href="#l4.60"></a><span id="l4.60" class="difflineplus">+  // folder whose db we're listening to.</span>
<a href="#l4.61"></a><span id="l4.61" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; m_folderWatching;</span>
<a href="#l4.62"></a><span id="l4.62" class="difflineplus">+  nsCOMPtr&lt;nsIMsgSearchSession&gt; m_searchSession;</span>
<a href="#l4.63"></a><span id="l4.63">   bool m_searchOnMsgStatus;</span>
<a href="#l4.64"></a><span id="l4.64">   bool m_batchingEvents;</span>
<a href="#l4.65"></a><span id="l4.65"> </span>
<a href="#l4.66"></a><span id="l4.66" class="difflineminus">-private:</span>
<a href="#l4.67"></a><span id="l4.67" class="difflineplus">+ private:</span>
<a href="#l4.68"></a><span id="l4.68">   ~VirtualFolderChangeListener() {}</span>
<a href="#l4.69"></a><span id="l4.69"> };</span>
<a href="#l4.70"></a><span id="l4.70"> </span>
<a href="#l4.71"></a><span id="l4.71" class="difflineminus">-</span>
<a href="#l4.72"></a><span id="l4.72" class="difflineminus">-class nsMsgAccountManager: public nsIMsgAccountManager,</span>
<a href="#l4.73"></a><span id="l4.73" class="difflineminus">-    public nsIObserver,</span>
<a href="#l4.74"></a><span id="l4.74" class="difflineminus">-    public nsSupportsWeakReference,</span>
<a href="#l4.75"></a><span id="l4.75" class="difflineminus">-    public nsIUrlListener,</span>
<a href="#l4.76"></a><span id="l4.76" class="difflineminus">-    public nsIFolderListener</span>
<a href="#l4.77"></a><span id="l4.77" class="difflineminus">-{</span>
<a href="#l4.78"></a><span id="l4.78" class="difflineminus">-public:</span>
<a href="#l4.79"></a><span id="l4.79" class="difflineminus">-</span>
<a href="#l4.80"></a><span id="l4.80" class="difflineplus">+class nsMsgAccountManager : public nsIMsgAccountManager,</span>
<a href="#l4.81"></a><span id="l4.81" class="difflineplus">+                            public nsIObserver,</span>
<a href="#l4.82"></a><span id="l4.82" class="difflineplus">+                            public nsSupportsWeakReference,</span>
<a href="#l4.83"></a><span id="l4.83" class="difflineplus">+                            public nsIUrlListener,</span>
<a href="#l4.84"></a><span id="l4.84" class="difflineplus">+                            public nsIFolderListener {</span>
<a href="#l4.85"></a><span id="l4.85" class="difflineplus">+ public:</span>
<a href="#l4.86"></a><span id="l4.86">   nsMsgAccountManager();</span>
<a href="#l4.87"></a><span id="l4.87"> </span>
<a href="#l4.88"></a><span id="l4.88">   NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l4.89"></a><span id="l4.89"> </span>
<a href="#l4.90"></a><span id="l4.90">   /* nsIMsgAccountManager methods */</span>
<a href="#l4.91"></a><span id="l4.91"> </span>
<a href="#l4.92"></a><span id="l4.92">   NS_DECL_NSIMSGACCOUNTMANAGER</span>
<a href="#l4.93"></a><span id="l4.93">   NS_DECL_NSIOBSERVER</span>
<a href="#l4.94"></a><span id="l4.94">   NS_DECL_NSIURLLISTENER</span>
<a href="#l4.95"></a><span id="l4.95">   NS_DECL_NSIFOLDERLISTENER</span>
<a href="#l4.96"></a><span id="l4.96"> </span>
<a href="#l4.97"></a><span id="l4.97">   nsresult Init();</span>
<a href="#l4.98"></a><span id="l4.98">   nsresult Shutdown();</span>
<a href="#l4.99"></a><span id="l4.99">   void LogoutOfServer(nsIMsgIncomingServer *aServer);</span>
<a href="#l4.100"></a><span id="l4.100"> </span>
<a href="#l4.101"></a><span id="l4.101" class="difflineminus">-private:</span>
<a href="#l4.102"></a><span id="l4.102" class="difflineplus">+ private:</span>
<a href="#l4.103"></a><span id="l4.103">   virtual ~nsMsgAccountManager();</span>
<a href="#l4.104"></a><span id="l4.104"> </span>
<a href="#l4.105"></a><span id="l4.105">   bool m_accountsLoaded;</span>
<a href="#l4.106"></a><span id="l4.106" class="difflineminus">-  nsCOMPtr &lt;nsIMsgFolderCache&gt; m_msgFolderCache;</span>
<a href="#l4.107"></a><span id="l4.107" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolderCache&gt; m_msgFolderCache;</span>
<a href="#l4.108"></a><span id="l4.108">   nsTArray&lt;nsCOMPtr&lt;nsIMsgAccount&gt; &gt; m_accounts;</span>
<a href="#l4.109"></a><span id="l4.109">   nsInterfaceHashtable&lt;nsCStringHashKey, nsIMsgIdentity&gt; m_identities;</span>
<a href="#l4.110"></a><span id="l4.110" class="difflineminus">-  nsInterfaceHashtable&lt;nsCStringHashKey, nsIMsgIncomingServer&gt; m_incomingServers;</span>
<a href="#l4.111"></a><span id="l4.111" class="difflineplus">+  nsInterfaceHashtable&lt;nsCStringHashKey, nsIMsgIncomingServer&gt;</span>
<a href="#l4.112"></a><span id="l4.112" class="difflineplus">+      m_incomingServers;</span>
<a href="#l4.113"></a><span id="l4.113">   nsCOMPtr&lt;nsIMsgAccount&gt; m_defaultAccount;</span>
<a href="#l4.114"></a><span id="l4.114">   nsCOMArray&lt;nsIIncomingServerListener&gt; m_incomingServerListeners;</span>
<a href="#l4.115"></a><span id="l4.115" class="difflineminus">-  nsTObserverArray&lt;RefPtr&lt;VirtualFolderChangeListener&gt; &gt; m_virtualFolderListeners;</span>
<a href="#l4.116"></a><span id="l4.116" class="difflineplus">+  nsTObserverArray&lt;RefPtr&lt;VirtualFolderChangeListener&gt; &gt;</span>
<a href="#l4.117"></a><span id="l4.117" class="difflineplus">+      m_virtualFolderListeners;</span>
<a href="#l4.118"></a><span id="l4.118">   nsCOMPtr&lt;nsIMsgFolder&gt; m_folderDoingEmptyTrash;</span>
<a href="#l4.119"></a><span id="l4.119">   nsCOMPtr&lt;nsIMsgFolder&gt; m_folderDoingCleanupInbox;</span>
<a href="#l4.120"></a><span id="l4.120">   bool m_emptyTrashInProgress;</span>
<a href="#l4.121"></a><span id="l4.121">   bool m_cleanupInboxInProgress;</span>
<a href="#l4.122"></a><span id="l4.122"> </span>
<a href="#l4.123"></a><span id="l4.123">   nsCString mAccountKeyList;</span>
<a href="#l4.124"></a><span id="l4.124"> </span>
<a href="#l4.125"></a><span id="l4.125">   // These are static because the account manager may go away during</span>
<a href="#l4.126"></a><span id="l4.126" class="difflineat">@@ -106,47 +107,45 @@ private:</span>
<a href="#l4.127"></a><span id="l4.127">   static bool m_haveShutdown;</span>
<a href="#l4.128"></a><span id="l4.128">   static bool m_shutdownInProgress;</span>
<a href="#l4.129"></a><span id="l4.129"> </span>
<a href="#l4.130"></a><span id="l4.130">   bool m_userAuthenticated;</span>
<a href="#l4.131"></a><span id="l4.131">   bool m_loadingVirtualFolders;</span>
<a href="#l4.132"></a><span id="l4.132">   bool m_virtualFoldersLoaded;</span>
<a href="#l4.133"></a><span id="l4.133"> </span>
<a href="#l4.134"></a><span id="l4.134">   /* we call FindServer() a lot.  so cache the last server found */</span>
<a href="#l4.135"></a><span id="l4.135" class="difflineminus">-  nsCOMPtr &lt;nsIMsgIncomingServer&gt; m_lastFindServerResult;</span>
<a href="#l4.136"></a><span id="l4.136" class="difflineplus">+  nsCOMPtr&lt;nsIMsgIncomingServer&gt; m_lastFindServerResult;</span>
<a href="#l4.137"></a><span id="l4.137">   nsCString m_lastFindServerHostName;</span>
<a href="#l4.138"></a><span id="l4.138">   nsCString m_lastFindServerUserName;</span>
<a href="#l4.139"></a><span id="l4.139">   int32_t m_lastFindServerPort;</span>
<a href="#l4.140"></a><span id="l4.140">   nsCString m_lastFindServerType;</span>
<a href="#l4.141"></a><span id="l4.141"> </span>
<a href="#l4.142"></a><span id="l4.142" class="difflineminus">-  void SetLastServerFound(nsIMsgIncomingServer *server, const nsACString&amp; hostname,</span>
<a href="#l4.143"></a><span id="l4.143" class="difflineminus">-                          const nsACString&amp; username, const int32_t port, const nsACString&amp; type);</span>
<a href="#l4.144"></a><span id="l4.144" class="difflineplus">+  void SetLastServerFound(nsIMsgIncomingServer *server,</span>
<a href="#l4.145"></a><span id="l4.145" class="difflineplus">+                          const nsACString &amp;hostname,</span>
<a href="#l4.146"></a><span id="l4.146" class="difflineplus">+                          const nsACString &amp;username, const int32_t port,</span>
<a href="#l4.147"></a><span id="l4.147" class="difflineplus">+                          const nsACString &amp;type);</span>
<a href="#l4.148"></a><span id="l4.148"> </span>
<a href="#l4.149"></a><span id="l4.149">   // Cache the results of the last call to FolderUriFromDirInProfile</span>
<a href="#l4.150"></a><span id="l4.150">   nsCOMPtr&lt;nsIFile&gt; m_lastPathLookedUp;</span>
<a href="#l4.151"></a><span id="l4.151">   nsCString m_lastFolderURIForPath;</span>
<a href="#l4.152"></a><span id="l4.152"> </span>
<a href="#l4.153"></a><span id="l4.153">   /* internal creation routines - updates m_identities and m_incomingServers */</span>
<a href="#l4.154"></a><span id="l4.154" class="difflineminus">-  nsresult createKeyedAccount(const nsCString&amp; key,</span>
<a href="#l4.155"></a><span id="l4.155" class="difflineminus">-                              nsIMsgAccount **_retval);</span>
<a href="#l4.156"></a><span id="l4.156" class="difflineminus">-  nsresult createKeyedServer(const nsACString&amp; key,</span>
<a href="#l4.157"></a><span id="l4.157" class="difflineminus">-                             const nsACString&amp; username,</span>
<a href="#l4.158"></a><span id="l4.158" class="difflineminus">-                             const nsACString&amp; password,</span>
<a href="#l4.159"></a><span id="l4.159" class="difflineminus">-                             const nsACString&amp; type,</span>
<a href="#l4.160"></a><span id="l4.160" class="difflineplus">+  nsresult createKeyedAccount(const nsCString &amp;key, nsIMsgAccount **_retval);</span>
<a href="#l4.161"></a><span id="l4.161" class="difflineplus">+  nsresult createKeyedServer(const nsACString &amp;key, const nsACString &amp;username,</span>
<a href="#l4.162"></a><span id="l4.162" class="difflineplus">+                             const nsACString &amp;password, const nsACString &amp;type,</span>
<a href="#l4.163"></a><span id="l4.163">                              nsIMsgIncomingServer **_retval);</span>
<a href="#l4.164"></a><span id="l4.164"> </span>
<a href="#l4.165"></a><span id="l4.165" class="difflineminus">-  nsresult createKeyedIdentity(const nsACString&amp; key,</span>
<a href="#l4.166"></a><span id="l4.166" class="difflineminus">-                               nsIMsgIdentity **_retval);</span>
<a href="#l4.167"></a><span id="l4.167" class="difflineplus">+  nsresult createKeyedIdentity(const nsACString &amp;key, nsIMsgIdentity **_retval);</span>
<a href="#l4.168"></a><span id="l4.168"> </span>
<a href="#l4.169"></a><span id="l4.169">   nsresult GetLocalFoldersPrettyName(nsString &amp;localFoldersName);</span>
<a href="#l4.170"></a><span id="l4.170"> </span>
<a href="#l4.171"></a><span id="l4.171">   /**</span>
<a href="#l4.172"></a><span id="l4.172">    * Check if the given account can be the set as the default account.</span>
<a href="#l4.173"></a><span id="l4.173">    */</span>
<a href="#l4.174"></a><span id="l4.174" class="difflineminus">-  nsresult CheckDefaultAccount(nsIMsgAccount* aAccount, bool &amp;aCanBeDefault);</span>
<a href="#l4.175"></a><span id="l4.175" class="difflineplus">+  nsresult CheckDefaultAccount(nsIMsgAccount *aAccount, bool &amp;aCanBeDefault);</span>
<a href="#l4.176"></a><span id="l4.176"> </span>
<a href="#l4.177"></a><span id="l4.177">   /**</span>
<a href="#l4.178"></a><span id="l4.178">    * Find a new account that can serve as default.</span>
<a href="#l4.179"></a><span id="l4.179">    */</span>
<a href="#l4.180"></a><span id="l4.180">   nsresult AutosetDefaultAccount();</span>
<a href="#l4.181"></a><span id="l4.181"> </span>
<a href="#l4.182"></a><span id="l4.182">   // sets the pref for the default server</span>
<a href="#l4.183"></a><span id="l4.183">   nsresult setDefaultAccountPref(nsIMsgAccount *aDefaultAccount);</span>
<a href="#l4.184"></a><span id="l4.184" class="difflineat">@@ -159,48 +158,46 @@ private:</span>
<a href="#l4.185"></a><span id="l4.185">                                      nsIMsgAccount *aNewAccount);</span>
<a href="#l4.186"></a><span id="l4.186"> </span>
<a href="#l4.187"></a><span id="l4.187">   //</span>
<a href="#l4.188"></a><span id="l4.188">   // account enumerators</span>
<a href="#l4.189"></a><span id="l4.189">   // (&quot;element&quot; is always an account)</span>
<a href="#l4.190"></a><span id="l4.190">   //</span>
<a href="#l4.191"></a><span id="l4.191"> </span>
<a href="#l4.192"></a><span id="l4.192">   // find the servers that correspond to the given identity</span>
<a href="#l4.193"></a><span id="l4.193" class="difflineminus">-  static bool findServersForIdentity (nsISupports *element, void *aData);</span>
<a href="#l4.194"></a><span id="l4.194" class="difflineplus">+  static bool findServersForIdentity(nsISupports *element, void *aData);</span>
<a href="#l4.195"></a><span id="l4.195"> </span>
<a href="#l4.196"></a><span id="l4.196" class="difflineminus">-  void findAccountByServerKey(const nsCString &amp;aKey,</span>
<a href="#l4.197"></a><span id="l4.197" class="difflineminus">-                              nsIMsgAccount **aResult);</span>
<a href="#l4.198"></a><span id="l4.198" class="difflineplus">+  void findAccountByServerKey(const nsCString &amp;aKey, nsIMsgAccount **aResult);</span>
<a href="#l4.199"></a><span id="l4.199"> </span>
<a href="#l4.200"></a><span id="l4.200">   //</span>
<a href="#l4.201"></a><span id="l4.201">   // server enumerators</span>
<a href="#l4.202"></a><span id="l4.202">   // (&quot;element&quot; is always a server)</span>
<a href="#l4.203"></a><span id="l4.203">   //</span>
<a href="#l4.204"></a><span id="l4.204"> </span>
<a href="#l4.205"></a><span id="l4.205" class="difflineminus">-  nsresult findServerInternal(const nsACString&amp; username,</span>
<a href="#l4.206"></a><span id="l4.206" class="difflineminus">-                              const nsACString&amp; hostname,</span>
<a href="#l4.207"></a><span id="l4.207" class="difflineminus">-                              const nsACString&amp; type,</span>
<a href="#l4.208"></a><span id="l4.208" class="difflineminus">-                              int32_t port,</span>
<a href="#l4.209"></a><span id="l4.209" class="difflineminus">-                              bool aRealFlag,</span>
<a href="#l4.210"></a><span id="l4.210" class="difflineminus">-                              nsIMsgIncomingServer** aResult);</span>
<a href="#l4.211"></a><span id="l4.211" class="difflineplus">+  nsresult findServerInternal(const nsACString &amp;username,</span>
<a href="#l4.212"></a><span id="l4.212" class="difflineplus">+                              const nsACString &amp;hostname,</span>
<a href="#l4.213"></a><span id="l4.213" class="difflineplus">+                              const nsACString &amp;type, int32_t port,</span>
<a href="#l4.214"></a><span id="l4.214" class="difflineplus">+                              bool aRealFlag, nsIMsgIncomingServer **aResult);</span>
<a href="#l4.215"></a><span id="l4.215"> </span>
<a href="#l4.216"></a><span id="l4.216">   // handle virtual folders</span>
<a href="#l4.217"></a><span id="l4.217" class="difflineminus">-  static nsresult GetVirtualFoldersFile(nsCOMPtr&lt;nsIFile&gt;&amp; file);</span>
<a href="#l4.218"></a><span id="l4.218" class="difflineminus">-  static nsresult WriteLineToOutputStream(const char *prefix, const char * line, nsIOutputStream *outputStream);</span>
<a href="#l4.219"></a><span id="l4.219" class="difflineplus">+  static nsresult GetVirtualFoldersFile(nsCOMPtr&lt;nsIFile&gt; &amp;file);</span>
<a href="#l4.220"></a><span id="l4.220" class="difflineplus">+  static nsresult WriteLineToOutputStream(const char *prefix, const char *line,</span>
<a href="#l4.221"></a><span id="l4.221" class="difflineplus">+                                          nsIOutputStream *outputStream);</span>
<a href="#l4.222"></a><span id="l4.222">   void ParseAndVerifyVirtualFolderScope(nsCString &amp;buffer);</span>
<a href="#l4.223"></a><span id="l4.223">   nsresult AddVFListenersForVF(nsIMsgFolder *virtualFolder,</span>
<a href="#l4.224"></a><span id="l4.224" class="difflineminus">-                               const nsCString&amp; srchFolderUris,</span>
<a href="#l4.225"></a><span id="l4.225" class="difflineplus">+                               const nsCString &amp;srchFolderUris,</span>
<a href="#l4.226"></a><span id="l4.226">                                nsIMsgDBService *msgDBService);</span>
<a href="#l4.227"></a><span id="l4.227"> </span>
<a href="#l4.228"></a><span id="l4.228">   nsresult RemoveVFListenerForVF(nsIMsgFolder *virtualFolder,</span>
<a href="#l4.229"></a><span id="l4.229">                                  nsIMsgFolder *folder);</span>
<a href="#l4.230"></a><span id="l4.230"> </span>
<a href="#l4.231"></a><span id="l4.231" class="difflineminus">-  void getUniqueAccountKey(nsCString&amp; aResult);</span>
<a href="#l4.232"></a><span id="l4.232" class="difflineplus">+  void getUniqueAccountKey(nsCString &amp;aResult);</span>
<a href="#l4.233"></a><span id="l4.233"> </span>
<a href="#l4.234"></a><span id="l4.234">   // Scan the preferences to find a unique server key</span>
<a href="#l4.235"></a><span id="l4.235" class="difflineminus">-  void GetUniqueServerKey(nsACString&amp; aResult);</span>
<a href="#l4.236"></a><span id="l4.236" class="difflineplus">+  void GetUniqueServerKey(nsACString &amp;aResult);</span>
<a href="#l4.237"></a><span id="l4.237"> </span>
<a href="#l4.238"></a><span id="l4.238">   nsresult RemoveFolderFromSmartFolder(nsIMsgFolder *aFolder,</span>
<a href="#l4.239"></a><span id="l4.239">                                        uint32_t flagsChanged);</span>
<a href="#l4.240"></a><span id="l4.240"> </span>
<a href="#l4.241"></a><span id="l4.241">   nsresult SetSendLaterUriPref(nsIMsgIncomingServer *server);</span>
<a href="#l4.242"></a><span id="l4.242"> </span>
<a href="#l4.243"></a><span id="l4.243">   nsCOMPtr&lt;nsIPrefBranch&gt; m_prefs;</span>
<a href="#l4.244"></a><span id="l4.244"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/base/src/nsMsgBiffManager.cpp</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgBiffManager.cpp</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -20,307 +20,265 @@</span>
<a href="#l5.4"></a><span id="l5.4"> </span>
<a href="#l5.5"></a><span id="l5.5"> #define PREF_BIFF_JITTER &quot;mail.biff.add_interval_jitter&quot;</span>
<a href="#l5.6"></a><span id="l5.6"> </span>
<a href="#l5.7"></a><span id="l5.7"> static NS_DEFINE_CID(kStatusBarBiffManagerCID, NS_STATUSBARBIFFMANAGER_CID);</span>
<a href="#l5.8"></a><span id="l5.8"> </span>
<a href="#l5.9"></a><span id="l5.9"> static mozilla::LazyLogModule MsgBiffLogModule(&quot;MsgBiff&quot;);</span>
<a href="#l5.10"></a><span id="l5.10"> </span>
<a href="#l5.11"></a><span id="l5.11"> NS_IMPL_ISUPPORTS(nsMsgBiffManager, nsIMsgBiffManager,</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-                   nsIIncomingServerListener, nsIObserver,</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineminus">-                   nsISupportsWeakReference)</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+                  nsIIncomingServerListener, nsIObserver,</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineplus">+                  nsISupportsWeakReference)</span>
<a href="#l5.16"></a><span id="l5.16"> </span>
<a href="#l5.17"></a><span id="l5.17" class="difflineminus">-void OnBiffTimer(nsITimer *timer, void *aBiffManager)</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineminus">-{</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineminus">-  nsMsgBiffManager *biffManager = (nsMsgBiffManager*)aBiffManager;</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineplus">+void OnBiffTimer(nsITimer *timer, void *aBiffManager) {</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineplus">+  nsMsgBiffManager *biffManager = (nsMsgBiffManager *)aBiffManager;</span>
<a href="#l5.22"></a><span id="l5.22">   biffManager-&gt;PerformBiff();</span>
<a href="#l5.23"></a><span id="l5.23"> }</span>
<a href="#l5.24"></a><span id="l5.24"> </span>
<a href="#l5.25"></a><span id="l5.25" class="difflineminus">-nsMsgBiffManager::nsMsgBiffManager()</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineminus">-{</span>
<a href="#l5.27"></a><span id="l5.27" class="difflineplus">+nsMsgBiffManager::nsMsgBiffManager() {</span>
<a href="#l5.28"></a><span id="l5.28">   mHaveShutdown = false;</span>
<a href="#l5.29"></a><span id="l5.29">   mInited = false;</span>
<a href="#l5.30"></a><span id="l5.30"> }</span>
<a href="#l5.31"></a><span id="l5.31"> </span>
<a href="#l5.32"></a><span id="l5.32" class="difflineminus">-nsMsgBiffManager::~nsMsgBiffManager()</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineminus">-{</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineminus">-  if (mBiffTimer)</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineminus">-    mBiffTimer-&gt;Cancel();</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineplus">+nsMsgBiffManager::~nsMsgBiffManager() {</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineplus">+  if (mBiffTimer) mBiffTimer-&gt;Cancel();</span>
<a href="#l5.38"></a><span id="l5.38"> </span>
<a href="#l5.39"></a><span id="l5.39" class="difflineminus">-  if (!mHaveShutdown)</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineminus">-    Shutdown();</span>
<a href="#l5.41"></a><span id="l5.41" class="difflineplus">+  if (!mHaveShutdown) Shutdown();</span>
<a href="#l5.42"></a><span id="l5.42"> </span>
<a href="#l5.43"></a><span id="l5.43">   nsCOMPtr&lt;nsIObserverService&gt; observerService =</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineminus">-    mozilla::services::GetObserverService();</span>
<a href="#l5.45"></a><span id="l5.45" class="difflineminus">-  if (observerService)</span>
<a href="#l5.46"></a><span id="l5.46" class="difflineminus">-  {</span>
<a href="#l5.47"></a><span id="l5.47" class="difflineplus">+      mozilla::services::GetObserverService();</span>
<a href="#l5.48"></a><span id="l5.48" class="difflineplus">+  if (observerService) {</span>
<a href="#l5.49"></a><span id="l5.49">     observerService-&gt;RemoveObserver(this, &quot;wake_notification&quot;);</span>
<a href="#l5.50"></a><span id="l5.50">     observerService-&gt;RemoveObserver(this, &quot;sleep_notification&quot;);</span>
<a href="#l5.51"></a><span id="l5.51">   }</span>
<a href="#l5.52"></a><span id="l5.52"> }</span>
<a href="#l5.53"></a><span id="l5.53"> </span>
<a href="#l5.54"></a><span id="l5.54" class="difflineminus">-NS_IMETHODIMP nsMsgBiffManager::Init()</span>
<a href="#l5.55"></a><span id="l5.55" class="difflineminus">-{</span>
<a href="#l5.56"></a><span id="l5.56" class="difflineminus">-  if (mInited)</span>
<a href="#l5.57"></a><span id="l5.57" class="difflineminus">-    return NS_OK;</span>
<a href="#l5.58"></a><span id="l5.58" class="difflineplus">+NS_IMETHODIMP nsMsgBiffManager::Init() {</span>
<a href="#l5.59"></a><span id="l5.59" class="difflineplus">+  if (mInited) return NS_OK;</span>
<a href="#l5.60"></a><span id="l5.60"> </span>
<a href="#l5.61"></a><span id="l5.61">   mInited = true;</span>
<a href="#l5.62"></a><span id="l5.62">   nsresult rv;</span>
<a href="#l5.63"></a><span id="l5.63"> </span>
<a href="#l5.64"></a><span id="l5.64">   nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l5.65"></a><span id="l5.65" class="difflineminus">-  do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l5.66"></a><span id="l5.66" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l5.67"></a><span id="l5.67" class="difflineminus">-    accountManager-&gt;AddIncomingServerListener(this);</span>
<a href="#l5.68"></a><span id="l5.68" class="difflineplus">+      do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l5.69"></a><span id="l5.69" class="difflineplus">+  if (NS_SUCCEEDED(rv)) accountManager-&gt;AddIncomingServerListener(this);</span>
<a href="#l5.70"></a><span id="l5.70"> </span>
<a href="#l5.71"></a><span id="l5.71">   // in turbo mode on profile change we don't need to do anything below this</span>
<a href="#l5.72"></a><span id="l5.72" class="difflineminus">-  if (mHaveShutdown)</span>
<a href="#l5.73"></a><span id="l5.73" class="difflineminus">-  {</span>
<a href="#l5.74"></a><span id="l5.74" class="difflineplus">+  if (mHaveShutdown) {</span>
<a href="#l5.75"></a><span id="l5.75">     mHaveShutdown = false;</span>
<a href="#l5.76"></a><span id="l5.76">     return NS_OK;</span>
<a href="#l5.77"></a><span id="l5.77">   }</span>
<a href="#l5.78"></a><span id="l5.78"> </span>
<a href="#l5.79"></a><span id="l5.79">   // Ensure status bar biff service has started</span>
<a href="#l5.80"></a><span id="l5.80">   nsCOMPtr&lt;nsIFolderListener&gt; statusBarBiffService =</span>
<a href="#l5.81"></a><span id="l5.81" class="difflineminus">-    do_GetService(kStatusBarBiffManagerCID, &amp;rv);</span>
<a href="#l5.82"></a><span id="l5.82" class="difflineplus">+      do_GetService(kStatusBarBiffManagerCID, &amp;rv);</span>
<a href="#l5.83"></a><span id="l5.83"> </span>
<a href="#l5.84"></a><span id="l5.84">   nsCOMPtr&lt;nsIObserverService&gt; observerService =</span>
<a href="#l5.85"></a><span id="l5.85" class="difflineminus">-    mozilla::services::GetObserverService();</span>
<a href="#l5.86"></a><span id="l5.86" class="difflineminus">-  if (observerService)</span>
<a href="#l5.87"></a><span id="l5.87" class="difflineminus">-  {</span>
<a href="#l5.88"></a><span id="l5.88" class="difflineplus">+      mozilla::services::GetObserverService();</span>
<a href="#l5.89"></a><span id="l5.89" class="difflineplus">+  if (observerService) {</span>
<a href="#l5.90"></a><span id="l5.90">     observerService-&gt;AddObserver(this, &quot;sleep_notification&quot;, true);</span>
<a href="#l5.91"></a><span id="l5.91">     observerService-&gt;AddObserver(this, &quot;wake_notification&quot;, true);</span>
<a href="#l5.92"></a><span id="l5.92">   }</span>
<a href="#l5.93"></a><span id="l5.93">   return NS_OK;</span>
<a href="#l5.94"></a><span id="l5.94"> }</span>
<a href="#l5.95"></a><span id="l5.95"> </span>
<a href="#l5.96"></a><span id="l5.96" class="difflineminus">-NS_IMETHODIMP nsMsgBiffManager::Shutdown()</span>
<a href="#l5.97"></a><span id="l5.97" class="difflineminus">-{</span>
<a href="#l5.98"></a><span id="l5.98" class="difflineminus">-  if (mBiffTimer)</span>
<a href="#l5.99"></a><span id="l5.99" class="difflineminus">-  {</span>
<a href="#l5.100"></a><span id="l5.100" class="difflineplus">+NS_IMETHODIMP nsMsgBiffManager::Shutdown() {</span>
<a href="#l5.101"></a><span id="l5.101" class="difflineplus">+  if (mBiffTimer) {</span>
<a href="#l5.102"></a><span id="l5.102">     mBiffTimer-&gt;Cancel();</span>
<a href="#l5.103"></a><span id="l5.103">     mBiffTimer = nullptr;</span>
<a href="#l5.104"></a><span id="l5.104">   }</span>
<a href="#l5.105"></a><span id="l5.105"> </span>
<a href="#l5.106"></a><span id="l5.106">   nsresult rv;</span>
<a href="#l5.107"></a><span id="l5.107">   nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l5.108"></a><span id="l5.108" class="difflineminus">-    do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l5.109"></a><span id="l5.109" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l5.110"></a><span id="l5.110" class="difflineminus">-    accountManager-&gt;RemoveIncomingServerListener(this);</span>
<a href="#l5.111"></a><span id="l5.111" class="difflineplus">+      do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l5.112"></a><span id="l5.112" class="difflineplus">+  if (NS_SUCCEEDED(rv)) accountManager-&gt;RemoveIncomingServerListener(this);</span>
<a href="#l5.113"></a><span id="l5.113"> </span>
<a href="#l5.114"></a><span id="l5.114">   mHaveShutdown = true;</span>
<a href="#l5.115"></a><span id="l5.115">   mInited = false;</span>
<a href="#l5.116"></a><span id="l5.116">   return NS_OK;</span>
<a href="#l5.117"></a><span id="l5.117"> }</span>
<a href="#l5.118"></a><span id="l5.118"> </span>
<a href="#l5.119"></a><span id="l5.119" class="difflineminus">-NS_IMETHODIMP nsMsgBiffManager::Observe(nsISupports *aSubject, const char *aTopic, const char16_t *someData)</span>
<a href="#l5.120"></a><span id="l5.120" class="difflineminus">-{</span>
<a href="#l5.121"></a><span id="l5.121" class="difflineminus">-  if (!strcmp(aTopic, &quot;sleep_notification&quot;) &amp;&amp; mBiffTimer)</span>
<a href="#l5.122"></a><span id="l5.122" class="difflineminus">-  {</span>
<a href="#l5.123"></a><span id="l5.123" class="difflineplus">+NS_IMETHODIMP nsMsgBiffManager::Observe(nsISupports *aSubject,</span>
<a href="#l5.124"></a><span id="l5.124" class="difflineplus">+                                        const char *aTopic,</span>
<a href="#l5.125"></a><span id="l5.125" class="difflineplus">+                                        const char16_t *someData) {</span>
<a href="#l5.126"></a><span id="l5.126" class="difflineplus">+  if (!strcmp(aTopic, &quot;sleep_notification&quot;) &amp;&amp; mBiffTimer) {</span>
<a href="#l5.127"></a><span id="l5.127">     mBiffTimer-&gt;Cancel();</span>
<a href="#l5.128"></a><span id="l5.128">     mBiffTimer = nullptr;</span>
<a href="#l5.129"></a><span id="l5.129" class="difflineminus">-  }</span>
<a href="#l5.130"></a><span id="l5.130" class="difflineminus">-  else if (!strcmp(aTopic, &quot;wake_notification&quot;))</span>
<a href="#l5.131"></a><span id="l5.131" class="difflineminus">-  {</span>
<a href="#l5.132"></a><span id="l5.132" class="difflineplus">+  } else if (!strcmp(aTopic, &quot;wake_notification&quot;)) {</span>
<a href="#l5.133"></a><span id="l5.133">     // wait 10 seconds after waking up to start biffing again.</span>
<a href="#l5.134"></a><span id="l5.134">     mBiffTimer = do_CreateInstance(&quot;@mozilla.org/timer;1&quot;);</span>
<a href="#l5.135"></a><span id="l5.135" class="difflineminus">-    mBiffTimer-&gt;InitWithNamedFuncCallback(OnBiffTimer, (void*)this, 10000,</span>
<a href="#l5.136"></a><span id="l5.136" class="difflineplus">+    mBiffTimer-&gt;InitWithNamedFuncCallback(OnBiffTimer, (void *)this, 10000,</span>
<a href="#l5.137"></a><span id="l5.137">                                           nsITimer::TYPE_ONE_SHOT,</span>
<a href="#l5.138"></a><span id="l5.138">                                           &quot;nsMsgBiffManager::OnBiffTimer&quot;);</span>
<a href="#l5.139"></a><span id="l5.139">   }</span>
<a href="#l5.140"></a><span id="l5.140">   return NS_OK;</span>
<a href="#l5.141"></a><span id="l5.141"> }</span>
<a href="#l5.142"></a><span id="l5.142"> </span>
<a href="#l5.143"></a><span id="l5.143" class="difflineminus">-NS_IMETHODIMP nsMsgBiffManager::AddServerBiff(nsIMsgIncomingServer *server)</span>
<a href="#l5.144"></a><span id="l5.144" class="difflineminus">-{</span>
<a href="#l5.145"></a><span id="l5.145" class="difflineplus">+NS_IMETHODIMP nsMsgBiffManager::AddServerBiff(nsIMsgIncomingServer *server) {</span>
<a href="#l5.146"></a><span id="l5.146">   NS_ENSURE_ARG_POINTER(server);</span>
<a href="#l5.147"></a><span id="l5.147"> </span>
<a href="#l5.148"></a><span id="l5.148">   int32_t biffMinutes;</span>
<a href="#l5.149"></a><span id="l5.149"> </span>
<a href="#l5.150"></a><span id="l5.150">   nsresult rv = server-&gt;GetBiffMinutes(&amp;biffMinutes);</span>
<a href="#l5.151"></a><span id="l5.151">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.152"></a><span id="l5.152"> </span>
<a href="#l5.153"></a><span id="l5.153">   // Don't add if biffMinutes isn't &gt; 0</span>
<a href="#l5.154"></a><span id="l5.154" class="difflineminus">-  if (biffMinutes &gt; 0)</span>
<a href="#l5.155"></a><span id="l5.155" class="difflineminus">-  {</span>
<a href="#l5.156"></a><span id="l5.156" class="difflineplus">+  if (biffMinutes &gt; 0) {</span>
<a href="#l5.157"></a><span id="l5.157">     int32_t serverIndex = FindServer(server);</span>
<a href="#l5.158"></a><span id="l5.158">     // Only add it if it hasn't been added already.</span>
<a href="#l5.159"></a><span id="l5.159" class="difflineminus">-    if (serverIndex == -1)</span>
<a href="#l5.160"></a><span id="l5.160" class="difflineminus">-    {</span>
<a href="#l5.161"></a><span id="l5.161" class="difflineplus">+    if (serverIndex == -1) {</span>
<a href="#l5.162"></a><span id="l5.162">       nsBiffEntry biffEntry;</span>
<a href="#l5.163"></a><span id="l5.163">       biffEntry.server = server;</span>
<a href="#l5.164"></a><span id="l5.164">       rv = SetNextBiffTime(biffEntry, PR_Now());</span>
<a href="#l5.165"></a><span id="l5.165">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.166"></a><span id="l5.166"> </span>
<a href="#l5.167"></a><span id="l5.167">       AddBiffEntry(biffEntry);</span>
<a href="#l5.168"></a><span id="l5.168">       SetupNextBiff();</span>
<a href="#l5.169"></a><span id="l5.169">     }</span>
<a href="#l5.170"></a><span id="l5.170">   }</span>
<a href="#l5.171"></a><span id="l5.171">   return NS_OK;</span>
<a href="#l5.172"></a><span id="l5.172"> }</span>
<a href="#l5.173"></a><span id="l5.173"> </span>
<a href="#l5.174"></a><span id="l5.174" class="difflineminus">-NS_IMETHODIMP nsMsgBiffManager::RemoveServerBiff(nsIMsgIncomingServer *server)</span>
<a href="#l5.175"></a><span id="l5.175" class="difflineminus">-{</span>
<a href="#l5.176"></a><span id="l5.176" class="difflineplus">+NS_IMETHODIMP nsMsgBiffManager::RemoveServerBiff(nsIMsgIncomingServer *server) {</span>
<a href="#l5.177"></a><span id="l5.177">   int32_t pos = FindServer(server);</span>
<a href="#l5.178"></a><span id="l5.178" class="difflineminus">-  if (pos != -1)</span>
<a href="#l5.179"></a><span id="l5.179" class="difflineminus">-    mBiffArray.RemoveElementAt(pos);</span>
<a href="#l5.180"></a><span id="l5.180" class="difflineplus">+  if (pos != -1) mBiffArray.RemoveElementAt(pos);</span>
<a href="#l5.181"></a><span id="l5.181"> </span>
<a href="#l5.182"></a><span id="l5.182">   // Should probably reset biff time if this was the server that gets biffed</span>
<a href="#l5.183"></a><span id="l5.183">   // next.</span>
<a href="#l5.184"></a><span id="l5.184">   return NS_OK;</span>
<a href="#l5.185"></a><span id="l5.185"> }</span>
<a href="#l5.186"></a><span id="l5.186"> </span>
<a href="#l5.187"></a><span id="l5.187" class="difflineminus">-</span>
<a href="#l5.188"></a><span id="l5.188" class="difflineminus">-NS_IMETHODIMP nsMsgBiffManager::ForceBiff(nsIMsgIncomingServer *server)</span>
<a href="#l5.189"></a><span id="l5.189" class="difflineminus">-{</span>
<a href="#l5.190"></a><span id="l5.190" class="difflineplus">+NS_IMETHODIMP nsMsgBiffManager::ForceBiff(nsIMsgIncomingServer *server) {</span>
<a href="#l5.191"></a><span id="l5.191">   return NS_OK;</span>
<a href="#l5.192"></a><span id="l5.192"> }</span>
<a href="#l5.193"></a><span id="l5.193"> </span>
<a href="#l5.194"></a><span id="l5.194" class="difflineminus">-NS_IMETHODIMP nsMsgBiffManager::ForceBiffAll()</span>
<a href="#l5.195"></a><span id="l5.195" class="difflineminus">-{</span>
<a href="#l5.196"></a><span id="l5.196" class="difflineminus">-  return NS_OK;</span>
<a href="#l5.197"></a><span id="l5.197" class="difflineminus">-}</span>
<a href="#l5.198"></a><span id="l5.198" class="difflineplus">+NS_IMETHODIMP nsMsgBiffManager::ForceBiffAll() { return NS_OK; }</span>
<a href="#l5.199"></a><span id="l5.199"> </span>
<a href="#l5.200"></a><span id="l5.200" class="difflineminus">-NS_IMETHODIMP nsMsgBiffManager::OnServerLoaded(nsIMsgIncomingServer *server)</span>
<a href="#l5.201"></a><span id="l5.201" class="difflineminus">-{</span>
<a href="#l5.202"></a><span id="l5.202" class="difflineplus">+NS_IMETHODIMP nsMsgBiffManager::OnServerLoaded(nsIMsgIncomingServer *server) {</span>
<a href="#l5.203"></a><span id="l5.203">   NS_ENSURE_ARG_POINTER(server);</span>
<a href="#l5.204"></a><span id="l5.204"> </span>
<a href="#l5.205"></a><span id="l5.205">   bool doBiff = false;</span>
<a href="#l5.206"></a><span id="l5.206">   nsresult rv = server-&gt;GetDoBiff(&amp;doBiff);</span>
<a href="#l5.207"></a><span id="l5.207"> </span>
<a href="#l5.208"></a><span id="l5.208" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; doBiff)</span>
<a href="#l5.209"></a><span id="l5.209" class="difflineminus">-    rv = AddServerBiff(server);</span>
<a href="#l5.210"></a><span id="l5.210" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; doBiff) rv = AddServerBiff(server);</span>
<a href="#l5.211"></a><span id="l5.211"> </span>
<a href="#l5.212"></a><span id="l5.212">   return rv;</span>
<a href="#l5.213"></a><span id="l5.213"> }</span>
<a href="#l5.214"></a><span id="l5.214"> </span>
<a href="#l5.215"></a><span id="l5.215" class="difflineminus">-NS_IMETHODIMP nsMsgBiffManager::OnServerUnloaded(nsIMsgIncomingServer *server)</span>
<a href="#l5.216"></a><span id="l5.216" class="difflineminus">-{</span>
<a href="#l5.217"></a><span id="l5.217" class="difflineplus">+NS_IMETHODIMP nsMsgBiffManager::OnServerUnloaded(nsIMsgIncomingServer *server) {</span>
<a href="#l5.218"></a><span id="l5.218">   return RemoveServerBiff(server);</span>
<a href="#l5.219"></a><span id="l5.219"> }</span>
<a href="#l5.220"></a><span id="l5.220"> </span>
<a href="#l5.221"></a><span id="l5.221" class="difflineminus">-NS_IMETHODIMP nsMsgBiffManager::OnServerChanged(nsIMsgIncomingServer *server)</span>
<a href="#l5.222"></a><span id="l5.222" class="difflineminus">-{</span>
<a href="#l5.223"></a><span id="l5.223" class="difflineplus">+NS_IMETHODIMP nsMsgBiffManager::OnServerChanged(nsIMsgIncomingServer *server) {</span>
<a href="#l5.224"></a><span id="l5.224">   // nothing required.  If the hostname or username changed</span>
<a href="#l5.225"></a><span id="l5.225">   // the next time biff fires, we'll ping the right server</span>
<a href="#l5.226"></a><span id="l5.226">   return NS_OK;</span>
<a href="#l5.227"></a><span id="l5.227"> }</span>
<a href="#l5.228"></a><span id="l5.228"> </span>
<a href="#l5.229"></a><span id="l5.229" class="difflineminus">-int32_t nsMsgBiffManager::FindServer(nsIMsgIncomingServer *server)</span>
<a href="#l5.230"></a><span id="l5.230" class="difflineminus">-{</span>
<a href="#l5.231"></a><span id="l5.231" class="difflineplus">+int32_t nsMsgBiffManager::FindServer(nsIMsgIncomingServer *server) {</span>
<a href="#l5.232"></a><span id="l5.232">   uint32_t count = mBiffArray.Length();</span>
<a href="#l5.233"></a><span id="l5.233" class="difflineminus">-  for (uint32_t i = 0; i &lt; count; i++)</span>
<a href="#l5.234"></a><span id="l5.234" class="difflineminus">-  {</span>
<a href="#l5.235"></a><span id="l5.235" class="difflineminus">-    if (server == mBiffArray[i].server.get())</span>
<a href="#l5.236"></a><span id="l5.236" class="difflineminus">-      return i;</span>
<a href="#l5.237"></a><span id="l5.237" class="difflineplus">+  for (uint32_t i = 0; i &lt; count; i++) {</span>
<a href="#l5.238"></a><span id="l5.238" class="difflineplus">+    if (server == mBiffArray[i].server.get()) return i;</span>
<a href="#l5.239"></a><span id="l5.239">   }</span>
<a href="#l5.240"></a><span id="l5.240">   return -1;</span>
<a href="#l5.241"></a><span id="l5.241"> }</span>
<a href="#l5.242"></a><span id="l5.242"> </span>
<a href="#l5.243"></a><span id="l5.243" class="difflineminus">-nsresult nsMsgBiffManager::AddBiffEntry(nsBiffEntry &amp;biffEntry)</span>
<a href="#l5.244"></a><span id="l5.244" class="difflineminus">-{</span>
<a href="#l5.245"></a><span id="l5.245" class="difflineplus">+nsresult nsMsgBiffManager::AddBiffEntry(nsBiffEntry &amp;biffEntry) {</span>
<a href="#l5.246"></a><span id="l5.246">   uint32_t i;</span>
<a href="#l5.247"></a><span id="l5.247">   uint32_t count = mBiffArray.Length();</span>
<a href="#l5.248"></a><span id="l5.248" class="difflineminus">-  for (i = 0; i &lt; count; i++)</span>
<a href="#l5.249"></a><span id="l5.249" class="difflineminus">-  {</span>
<a href="#l5.250"></a><span id="l5.250" class="difflineminus">-    if (biffEntry.nextBiffTime &lt; mBiffArray[i].nextBiffTime)</span>
<a href="#l5.251"></a><span id="l5.251" class="difflineminus">-      break;</span>
<a href="#l5.252"></a><span id="l5.252" class="difflineplus">+  for (i = 0; i &lt; count; i++) {</span>
<a href="#l5.253"></a><span id="l5.253" class="difflineplus">+    if (biffEntry.nextBiffTime &lt; mBiffArray[i].nextBiffTime) break;</span>
<a href="#l5.254"></a><span id="l5.254">   }</span>
<a href="#l5.255"></a><span id="l5.255" class="difflineminus">-  MOZ_LOG(MsgBiffLogModule, mozilla::LogLevel::Info, (&quot;inserting biff entry at %d&quot;, i));</span>
<a href="#l5.256"></a><span id="l5.256" class="difflineplus">+  MOZ_LOG(MsgBiffLogModule, mozilla::LogLevel::Info,</span>
<a href="#l5.257"></a><span id="l5.257" class="difflineplus">+          (&quot;inserting biff entry at %d&quot;, i));</span>
<a href="#l5.258"></a><span id="l5.258">   mBiffArray.InsertElementAt(i, biffEntry);</span>
<a href="#l5.259"></a><span id="l5.259">   return NS_OK;</span>
<a href="#l5.260"></a><span id="l5.260"> }</span>
<a href="#l5.261"></a><span id="l5.261"> </span>
<a href="#l5.262"></a><span id="l5.262" class="difflineminus">-nsresult nsMsgBiffManager::SetNextBiffTime(nsBiffEntry &amp;biffEntry, PRTime currentTime)</span>
<a href="#l5.263"></a><span id="l5.263" class="difflineminus">-{</span>
<a href="#l5.264"></a><span id="l5.264" class="difflineplus">+nsresult nsMsgBiffManager::SetNextBiffTime(nsBiffEntry &amp;biffEntry,</span>
<a href="#l5.265"></a><span id="l5.265" class="difflineplus">+                                           PRTime currentTime) {</span>
<a href="#l5.266"></a><span id="l5.266">   nsIMsgIncomingServer *server = biffEntry.server;</span>
<a href="#l5.267"></a><span id="l5.267">   NS_ENSURE_TRUE(server, NS_ERROR_FAILURE);</span>
<a href="#l5.268"></a><span id="l5.268"> </span>
<a href="#l5.269"></a><span id="l5.269">   int32_t biffInterval;</span>
<a href="#l5.270"></a><span id="l5.270">   nsresult rv = server-&gt;GetBiffMinutes(&amp;biffInterval);</span>
<a href="#l5.271"></a><span id="l5.271">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.272"></a><span id="l5.272"> </span>
<a href="#l5.273"></a><span id="l5.273">   // Add biffInterval, converted in microseconds, to current time.</span>
<a href="#l5.274"></a><span id="l5.274">   // Force 64-bit multiplication.</span>
<a href="#l5.275"></a><span id="l5.275">   PRTime chosenTimeInterval = biffInterval * 60000000LL;</span>
<a href="#l5.276"></a><span id="l5.276">   biffEntry.nextBiffTime = currentTime + chosenTimeInterval;</span>
<a href="#l5.277"></a><span id="l5.277"> </span>
<a href="#l5.278"></a><span id="l5.278">   // Check if we should jitter.</span>
<a href="#l5.279"></a><span id="l5.279">   nsCOMPtr&lt;nsIPrefBranch&gt; prefs = do_GetService(NS_PREFSERVICE_CONTRACTID);</span>
<a href="#l5.280"></a><span id="l5.280" class="difflineminus">-  if (prefs)</span>
<a href="#l5.281"></a><span id="l5.281" class="difflineminus">-  {</span>
<a href="#l5.282"></a><span id="l5.282" class="difflineplus">+  if (prefs) {</span>
<a href="#l5.283"></a><span id="l5.283">     bool shouldUseBiffJitter = false;</span>
<a href="#l5.284"></a><span id="l5.284">     prefs-&gt;GetBoolPref(PREF_BIFF_JITTER, &amp;shouldUseBiffJitter);</span>
<a href="#l5.285"></a><span id="l5.285" class="difflineminus">-    if (shouldUseBiffJitter)</span>
<a href="#l5.286"></a><span id="l5.286" class="difflineminus">-    {</span>
<a href="#l5.287"></a><span id="l5.287" class="difflineplus">+    if (shouldUseBiffJitter) {</span>
<a href="#l5.288"></a><span id="l5.288">       // Calculate a jitter of +/-5% on chosenTimeInterval</span>
<a href="#l5.289"></a><span id="l5.289">       // - minimum 1 second (to avoid a modulo with 0)</span>
<a href="#l5.290"></a><span id="l5.290" class="difflineminus">-      // - maximum 30 seconds (to avoid problems when biffInterval is very large)</span>
<a href="#l5.291"></a><span id="l5.291" class="difflineplus">+      // - maximum 30 seconds (to avoid problems when biffInterval is very</span>
<a href="#l5.292"></a><span id="l5.292" class="difflineplus">+      // large)</span>
<a href="#l5.293"></a><span id="l5.293">       int64_t jitter = (int64_t)(0.05 * (int64_t)chosenTimeInterval);</span>
<a href="#l5.294"></a><span id="l5.294" class="difflineminus">-      jitter = std::max&lt;int64_t&gt;(1000000LL, std::min&lt;int64_t&gt;(jitter, 30000000LL));</span>
<a href="#l5.295"></a><span id="l5.295" class="difflineplus">+      jitter =</span>
<a href="#l5.296"></a><span id="l5.296" class="difflineplus">+          std::max&lt;int64_t&gt;(1000000LL, std::min&lt;int64_t&gt;(jitter, 30000000LL));</span>
<a href="#l5.297"></a><span id="l5.297">       jitter = ((rand() % 2) ? 1 : -1) * (rand() % jitter);</span>
<a href="#l5.298"></a><span id="l5.298"> </span>
<a href="#l5.299"></a><span id="l5.299">       biffEntry.nextBiffTime += jitter;</span>
<a href="#l5.300"></a><span id="l5.300">     }</span>
<a href="#l5.301"></a><span id="l5.301">   }</span>
<a href="#l5.302"></a><span id="l5.302"> </span>
<a href="#l5.303"></a><span id="l5.303">   return NS_OK;</span>
<a href="#l5.304"></a><span id="l5.304"> }</span>
<a href="#l5.305"></a><span id="l5.305"> </span>
<a href="#l5.306"></a><span id="l5.306" class="difflineminus">-nsresult nsMsgBiffManager::SetupNextBiff()</span>
<a href="#l5.307"></a><span id="l5.307" class="difflineminus">-{</span>
<a href="#l5.308"></a><span id="l5.308" class="difflineminus">-  if (mBiffArray.Length() &gt; 0)</span>
<a href="#l5.309"></a><span id="l5.309" class="difflineminus">-  {</span>
<a href="#l5.310"></a><span id="l5.310" class="difflineplus">+nsresult nsMsgBiffManager::SetupNextBiff() {</span>
<a href="#l5.311"></a><span id="l5.311" class="difflineplus">+  if (mBiffArray.Length() &gt; 0) {</span>
<a href="#l5.312"></a><span id="l5.312">     // Get the next biff entry</span>
<a href="#l5.313"></a><span id="l5.313">     const nsBiffEntry &amp;biffEntry = mBiffArray[0];</span>
<a href="#l5.314"></a><span id="l5.314">     PRTime currentTime = PR_Now();</span>
<a href="#l5.315"></a><span id="l5.315">     int64_t biffDelay;</span>
<a href="#l5.316"></a><span id="l5.316">     int64_t ms(1000);</span>
<a href="#l5.317"></a><span id="l5.317"> </span>
<a href="#l5.318"></a><span id="l5.318" class="difflineminus">-    if (currentTime &gt; biffEntry.nextBiffTime)</span>
<a href="#l5.319"></a><span id="l5.319" class="difflineminus">-    {</span>
<a href="#l5.320"></a><span id="l5.320" class="difflineplus">+    if (currentTime &gt; biffEntry.nextBiffTime) {</span>
<a href="#l5.321"></a><span id="l5.321">       // Let's wait 30 seconds before firing biff again</span>
<a href="#l5.322"></a><span id="l5.322">       biffDelay = 30 * PR_USEC_PER_SEC;</span>
<a href="#l5.323"></a><span id="l5.323" class="difflineminus">-    }</span>
<a href="#l5.324"></a><span id="l5.324" class="difflineminus">-    else</span>
<a href="#l5.325"></a><span id="l5.325" class="difflineplus">+    } else</span>
<a href="#l5.326"></a><span id="l5.326">       biffDelay = biffEntry.nextBiffTime - currentTime;</span>
<a href="#l5.327"></a><span id="l5.327"> </span>
<a href="#l5.328"></a><span id="l5.328">     // Convert biffDelay into milliseconds</span>
<a href="#l5.329"></a><span id="l5.329">     int64_t timeInMS = biffDelay / ms;</span>
<a href="#l5.330"></a><span id="l5.330">     uint32_t timeInMSUint32 = (uint32_t)timeInMS;</span>
<a href="#l5.331"></a><span id="l5.331"> </span>
<a href="#l5.332"></a><span id="l5.332">     // Can't currently reset a timer when it's in the process of</span>
<a href="#l5.333"></a><span id="l5.333">     // calling Notify. So, just release the timer here and create a new one.</span>
<a href="#l5.334"></a><span id="l5.334" class="difflineminus">-    if (mBiffTimer)</span>
<a href="#l5.335"></a><span id="l5.335" class="difflineminus">-      mBiffTimer-&gt;Cancel();</span>
<a href="#l5.336"></a><span id="l5.336" class="difflineplus">+    if (mBiffTimer) mBiffTimer-&gt;Cancel();</span>
<a href="#l5.337"></a><span id="l5.337"> </span>
<a href="#l5.338"></a><span id="l5.338" class="difflineminus">-    MOZ_LOG(MsgBiffLogModule, mozilla::LogLevel::Info, (&quot;setting %d timer&quot;, timeInMSUint32));</span>
<a href="#l5.339"></a><span id="l5.339" class="difflineplus">+    MOZ_LOG(MsgBiffLogModule, mozilla::LogLevel::Info,</span>
<a href="#l5.340"></a><span id="l5.340" class="difflineplus">+            (&quot;setting %d timer&quot;, timeInMSUint32));</span>
<a href="#l5.341"></a><span id="l5.341">     mBiffTimer = do_CreateInstance(&quot;@mozilla.org/timer;1&quot;);</span>
<a href="#l5.342"></a><span id="l5.342" class="difflineminus">-    mBiffTimer-&gt;InitWithNamedFuncCallback(OnBiffTimer, (void*)this, timeInMSUint32,</span>
<a href="#l5.343"></a><span id="l5.343" class="difflineminus">-                                          nsITimer::TYPE_ONE_SHOT,</span>
<a href="#l5.344"></a><span id="l5.344" class="difflineminus">-                                          &quot;nsMsgBiffManager::OnBiffTimer&quot;);</span>
<a href="#l5.345"></a><span id="l5.345" class="difflineminus">-</span>
<a href="#l5.346"></a><span id="l5.346" class="difflineplus">+    mBiffTimer-&gt;InitWithNamedFuncCallback(</span>
<a href="#l5.347"></a><span id="l5.347" class="difflineplus">+        OnBiffTimer, (void *)this, timeInMSUint32, nsITimer::TYPE_ONE_SHOT,</span>
<a href="#l5.348"></a><span id="l5.348" class="difflineplus">+        &quot;nsMsgBiffManager::OnBiffTimer&quot;);</span>
<a href="#l5.349"></a><span id="l5.349">   }</span>
<a href="#l5.350"></a><span id="l5.350">   return NS_OK;</span>
<a href="#l5.351"></a><span id="l5.351"> }</span>
<a href="#l5.352"></a><span id="l5.352"> </span>
<a href="#l5.353"></a><span id="l5.353" class="difflineminus">-//This is the function that does a biff on all of the servers whose time it is to biff.</span>
<a href="#l5.354"></a><span id="l5.354" class="difflineminus">-nsresult nsMsgBiffManager::PerformBiff()</span>
<a href="#l5.355"></a><span id="l5.355" class="difflineminus">-{</span>
<a href="#l5.356"></a><span id="l5.356" class="difflineplus">+// This is the function that does a biff on all of the servers whose time it is</span>
<a href="#l5.357"></a><span id="l5.357" class="difflineplus">+// to biff.</span>
<a href="#l5.358"></a><span id="l5.358" class="difflineplus">+nsresult nsMsgBiffManager::PerformBiff() {</span>
<a href="#l5.359"></a><span id="l5.359">   PRTime currentTime = PR_Now();</span>
<a href="#l5.360"></a><span id="l5.360">   nsCOMArray&lt;nsIMsgFolder&gt; targetFolders;</span>
<a href="#l5.361"></a><span id="l5.361">   MOZ_LOG(MsgBiffLogModule, mozilla::LogLevel::Info, (&quot;performing biffs&quot;));</span>
<a href="#l5.362"></a><span id="l5.362"> </span>
<a href="#l5.363"></a><span id="l5.363">   uint32_t count = mBiffArray.Length();</span>
<a href="#l5.364"></a><span id="l5.364" class="difflineminus">-  for (uint32_t i = 0; i &lt; count; i++)</span>
<a href="#l5.365"></a><span id="l5.365" class="difflineminus">-  {</span>
<a href="#l5.366"></a><span id="l5.366" class="difflineplus">+  for (uint32_t i = 0; i &lt; count; i++) {</span>
<a href="#l5.367"></a><span id="l5.367">     // Take a copy of the entry rather than the a reference so that we can</span>
<a href="#l5.368"></a><span id="l5.368">     // remove and add if necessary, but keep the references and memory alive.</span>
<a href="#l5.369"></a><span id="l5.369">     nsBiffEntry current = mBiffArray[i];</span>
<a href="#l5.370"></a><span id="l5.370" class="difflineminus">-    if (current.nextBiffTime &lt; currentTime)</span>
<a href="#l5.371"></a><span id="l5.371" class="difflineminus">-    {</span>
<a href="#l5.372"></a><span id="l5.372" class="difflineplus">+    if (current.nextBiffTime &lt; currentTime) {</span>
<a href="#l5.373"></a><span id="l5.373">       bool serverBusy = false;</span>
<a href="#l5.374"></a><span id="l5.374">       bool serverRequiresPassword = true;</span>
<a href="#l5.375"></a><span id="l5.375">       bool passwordPromptRequired;</span>
<a href="#l5.376"></a><span id="l5.376"> </span>
<a href="#l5.377"></a><span id="l5.377">       current.server-&gt;GetPasswordPromptRequired(&amp;passwordPromptRequired);</span>
<a href="#l5.378"></a><span id="l5.378">       current.server-&gt;GetServerBusy(&amp;serverBusy);</span>
<a href="#l5.379"></a><span id="l5.379">       current.server-&gt;GetServerRequiresPasswordForBiff(&amp;serverRequiresPassword);</span>
<a href="#l5.380"></a><span id="l5.380">       // find the dest folder we're actually downloading to...</span>
<a href="#l5.381"></a><span id="l5.381" class="difflineat">@@ -329,45 +287,44 @@ nsresult nsMsgBiffManager::PerformBiff()</span>
<a href="#l5.382"></a><span id="l5.382">       int32_t targetFolderIndex = targetFolders.IndexOfObject(rootMsgFolder);</span>
<a href="#l5.383"></a><span id="l5.383">       if (targetFolderIndex == kNotFound)</span>
<a href="#l5.384"></a><span id="l5.384">         targetFolders.AppendObject(rootMsgFolder);</span>
<a href="#l5.385"></a><span id="l5.385"> </span>
<a href="#l5.386"></a><span id="l5.386">       // so if we need to be authenticated to biff, check that we are</span>
<a href="#l5.387"></a><span id="l5.387">       // (since we don't want to prompt the user for password UI)</span>
<a href="#l5.388"></a><span id="l5.388">       // and make sure the server isn't already in the middle of downloading</span>
<a href="#l5.389"></a><span id="l5.389">       // new messages</span>
<a href="#l5.390"></a><span id="l5.390" class="difflineminus">-      if (!serverBusy &amp;&amp;</span>
<a href="#l5.391"></a><span id="l5.391" class="difflineminus">-          (!serverRequiresPassword || !passwordPromptRequired) &amp;&amp;</span>
<a href="#l5.392"></a><span id="l5.392" class="difflineminus">-          targetFolderIndex == kNotFound)</span>
<a href="#l5.393"></a><span id="l5.393" class="difflineminus">-      {</span>
<a href="#l5.394"></a><span id="l5.394" class="difflineplus">+      if (!serverBusy &amp;&amp; (!serverRequiresPassword || !passwordPromptRequired) &amp;&amp;</span>
<a href="#l5.395"></a><span id="l5.395" class="difflineplus">+          targetFolderIndex == kNotFound) {</span>
<a href="#l5.396"></a><span id="l5.396">         nsCString serverKey;</span>
<a href="#l5.397"></a><span id="l5.397">         current.server-&gt;GetKey(serverKey);</span>
<a href="#l5.398"></a><span id="l5.398">         nsresult rv = current.server-&gt;PerformBiff(nullptr);</span>
<a href="#l5.399"></a><span id="l5.399">         MOZ_LOG(MsgBiffLogModule, mozilla::LogLevel::Info,</span>
<a href="#l5.400"></a><span id="l5.400" class="difflineminus">-          (&quot;biffing server %s rv = %&quot; PRIx32, serverKey.get(), static_cast&lt;uint32_t&gt;(rv)));</span>
<a href="#l5.401"></a><span id="l5.401" class="difflineminus">-      }</span>
<a href="#l5.402"></a><span id="l5.402" class="difflineminus">-      else</span>
<a href="#l5.403"></a><span id="l5.403" class="difflineminus">-      {</span>
<a href="#l5.404"></a><span id="l5.404" class="difflineplus">+                (&quot;biffing server %s rv = %&quot; PRIx32, serverKey.get(),</span>
<a href="#l5.405"></a><span id="l5.405" class="difflineplus">+                 static_cast&lt;uint32_t&gt;(rv)));</span>
<a href="#l5.406"></a><span id="l5.406" class="difflineplus">+      } else {</span>
<a href="#l5.407"></a><span id="l5.407">         MOZ_LOG(MsgBiffLogModule, mozilla::LogLevel::Info,</span>
<a href="#l5.408"></a><span id="l5.408" class="difflineminus">-          (&quot;not biffing server serverBusy = %d requirespassword = %d password prompt required = %d targetFolderIndex = %d&quot;,</span>
<a href="#l5.409"></a><span id="l5.409" class="difflineminus">-           serverBusy, serverRequiresPassword, passwordPromptRequired, targetFolderIndex));</span>
<a href="#l5.410"></a><span id="l5.410" class="difflineplus">+                (&quot;not biffing server serverBusy = %d requirespassword = %d &quot;</span>
<a href="#l5.411"></a><span id="l5.411" class="difflineplus">+                 &quot;password prompt required = %d targetFolderIndex = %d&quot;,</span>
<a href="#l5.412"></a><span id="l5.412" class="difflineplus">+                 serverBusy, serverRequiresPassword, passwordPromptRequired,</span>
<a href="#l5.413"></a><span id="l5.413" class="difflineplus">+                 targetFolderIndex));</span>
<a href="#l5.414"></a><span id="l5.414">       }</span>
<a href="#l5.415"></a><span id="l5.415" class="difflineminus">-      // if we didn't do this server because the destination server was already being</span>
<a href="#l5.416"></a><span id="l5.416" class="difflineminus">-      // biffed into, leave this server in the biff array so it will fire next.</span>
<a href="#l5.417"></a><span id="l5.417" class="difflineminus">-      if (targetFolderIndex == kNotFound)</span>
<a href="#l5.418"></a><span id="l5.418" class="difflineminus">-      {</span>
<a href="#l5.419"></a><span id="l5.419" class="difflineplus">+      // if we didn't do this server because the destination server was already</span>
<a href="#l5.420"></a><span id="l5.420" class="difflineplus">+      // being biffed into, leave this server in the biff array so it will fire</span>
<a href="#l5.421"></a><span id="l5.421" class="difflineplus">+      // next.</span>
<a href="#l5.422"></a><span id="l5.422" class="difflineplus">+      if (targetFolderIndex == kNotFound) {</span>
<a href="#l5.423"></a><span id="l5.423">         mBiffArray.RemoveElementAt(i);</span>
<a href="#l5.424"></a><span id="l5.424" class="difflineminus">-        i--; //Because we removed it we need to look at the one that just moved up.</span>
<a href="#l5.425"></a><span id="l5.425" class="difflineplus">+        i--;  // Because we removed it we need to look at the one that just</span>
<a href="#l5.426"></a><span id="l5.426" class="difflineplus">+              // moved up.</span>
<a href="#l5.427"></a><span id="l5.427">         SetNextBiffTime(current, currentTime);</span>
<a href="#l5.428"></a><span id="l5.428">         AddBiffEntry(current);</span>
<a href="#l5.429"></a><span id="l5.429">       }</span>
<a href="#l5.430"></a><span id="l5.430"> #ifdef DEBUG_David_Bienvenu</span>
<a href="#l5.431"></a><span id="l5.431">       else</span>
<a href="#l5.432"></a><span id="l5.432">         printf(&quot;dest account performing biff\n&quot;);</span>
<a href="#l5.433"></a><span id="l5.433"> #endif</span>
<a href="#l5.434"></a><span id="l5.434" class="difflineminus">-    }</span>
<a href="#l5.435"></a><span id="l5.435" class="difflineminus">-    else</span>
<a href="#l5.436"></a><span id="l5.436" class="difflineminus">-      //since we're in biff order, there's no reason to keep checking</span>
<a href="#l5.437"></a><span id="l5.437" class="difflineplus">+    } else</span>
<a href="#l5.438"></a><span id="l5.438" class="difflineplus">+      // since we're in biff order, there's no reason to keep checking</span>
<a href="#l5.439"></a><span id="l5.439">       break;</span>
<a href="#l5.440"></a><span id="l5.440">   }</span>
<a href="#l5.441"></a><span id="l5.441">   SetupNextBiff();</span>
<a href="#l5.442"></a><span id="l5.442">   return NS_OK;</span>
<a href="#l5.443"></a><span id="l5.443"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/base/src/nsMsgBiffManager.h</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgBiffManager.h</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -15,41 +15,38 @@</span>
<a href="#l6.4"></a><span id="l6.4"> #include &quot;nsWeakReference.h&quot;</span>
<a href="#l6.5"></a><span id="l6.5"> #include &quot;nsIObserver.h&quot;</span>
<a href="#l6.6"></a><span id="l6.6"> </span>
<a href="#l6.7"></a><span id="l6.7"> typedef struct {</span>
<a href="#l6.8"></a><span id="l6.8">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l6.9"></a><span id="l6.9">   PRTime nextBiffTime;</span>
<a href="#l6.10"></a><span id="l6.10"> } nsBiffEntry;</span>
<a href="#l6.11"></a><span id="l6.11"> </span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-class nsMsgBiffManager</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineminus">-  : public nsIMsgBiffManager,</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineminus">-    public nsIIncomingServerListener,</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineminus">-    public nsIObserver,</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineminus">-    public nsSupportsWeakReference</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineminus">-{</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineminus">-public:</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineplus">+class nsMsgBiffManager : public nsIMsgBiffManager,</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineplus">+                         public nsIIncomingServerListener,</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineplus">+                         public nsIObserver,</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineplus">+                         public nsSupportsWeakReference {</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineplus">+ public:</span>
<a href="#l6.25"></a><span id="l6.25">   nsMsgBiffManager();</span>
<a href="#l6.26"></a><span id="l6.26"> </span>
<a href="#l6.27"></a><span id="l6.27">   NS_DECL_ISUPPORTS</span>
<a href="#l6.28"></a><span id="l6.28">   NS_DECL_NSIMSGBIFFMANAGER</span>
<a href="#l6.29"></a><span id="l6.29">   NS_DECL_NSIINCOMINGSERVERLISTENER</span>
<a href="#l6.30"></a><span id="l6.30">   NS_DECL_NSIOBSERVER</span>
<a href="#l6.31"></a><span id="l6.31"> </span>
<a href="#l6.32"></a><span id="l6.32">   nsresult PerformBiff();</span>
<a href="#l6.33"></a><span id="l6.33"> </span>
<a href="#l6.34"></a><span id="l6.34" class="difflineminus">-protected:</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineplus">+ protected:</span>
<a href="#l6.36"></a><span id="l6.36">   virtual ~nsMsgBiffManager();</span>
<a href="#l6.37"></a><span id="l6.37"> </span>
<a href="#l6.38"></a><span id="l6.38">   int32_t FindServer(nsIMsgIncomingServer *server);</span>
<a href="#l6.39"></a><span id="l6.39">   nsresult SetNextBiffTime(nsBiffEntry &amp;biffEntry, PRTime currentTime);</span>
<a href="#l6.40"></a><span id="l6.40">   nsresult SetupNextBiff();</span>
<a href="#l6.41"></a><span id="l6.41">   nsresult AddBiffEntry(nsBiffEntry &amp;biffEntry);</span>
<a href="#l6.42"></a><span id="l6.42"> </span>
<a href="#l6.43"></a><span id="l6.43" class="difflineminus">-protected:</span>
<a href="#l6.44"></a><span id="l6.44" class="difflineplus">+ protected:</span>
<a href="#l6.45"></a><span id="l6.45">   nsCOMPtr&lt;nsITimer&gt; mBiffTimer;</span>
<a href="#l6.46"></a><span id="l6.46">   nsTArray&lt;nsBiffEntry&gt; mBiffArray;</span>
<a href="#l6.47"></a><span id="l6.47">   bool mHaveShutdown;</span>
<a href="#l6.48"></a><span id="l6.48">   bool mInited;</span>
<a href="#l6.49"></a><span id="l6.49"> };</span>
<a href="#l6.50"></a><span id="l6.50"> </span>
<a href="#l6.51"></a><span id="l6.51" class="difflineminus">-#endif // NSMSGBIFFMANAGER_H</span>
<a href="#l6.52"></a><span id="l6.52" class="difflineplus">+#endif  // NSMSGBIFFMANAGER_H</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/base/src/nsMsgContentPolicy.cpp</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgContentPolicy.cpp</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -27,58 +27,52 @@</span>
<a href="#l7.4"></a><span id="l7.4"> #include &quot;nsThreadUtils.h&quot;</span>
<a href="#l7.5"></a><span id="l7.5"> #include &quot;mozilla/mailnews/MimeHeaderParser.h&quot;</span>
<a href="#l7.6"></a><span id="l7.6"> #include &quot;mozilla/dom/HTMLImageElement.h&quot;</span>
<a href="#l7.7"></a><span id="l7.7"> #include &quot;nsINntpUrl.h&quot;</span>
<a href="#l7.8"></a><span id="l7.8"> #include &quot;nsILoadInfo.h&quot;</span>
<a href="#l7.9"></a><span id="l7.9"> #include &quot;nsSandboxFlags.h&quot;</span>
<a href="#l7.10"></a><span id="l7.10"> #include &quot;nsQueryObject.h&quot;</span>
<a href="#l7.11"></a><span id="l7.11"> </span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-static const char kBlockRemoteImages[] = &quot;mailnews.message_display.disable_remote_image&quot;;</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">-static const char kTrustedDomains[] =  &quot;mail.trusteddomains&quot;;</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+static const char kBlockRemoteImages[] =</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+    &quot;mailnews.message_display.disable_remote_image&quot;;</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineplus">+static const char kTrustedDomains[] = &quot;mail.trusteddomains&quot;;</span>
<a href="#l7.17"></a><span id="l7.17"> </span>
<a href="#l7.18"></a><span id="l7.18"> using namespace mozilla::mailnews;</span>
<a href="#l7.19"></a><span id="l7.19"> </span>
<a href="#l7.20"></a><span id="l7.20" class="difflineminus">-// Per message headder flags to keep track of whether the user is allowing remote</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineminus">-// content for a particular message.</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineminus">-// if you change or add more values to these constants, be sure to modify</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineminus">-// the corresponding definitions in mailWindowOverlay.js</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineplus">+// Per message headder flags to keep track of whether the user is allowing</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineplus">+// remote content for a particular message. if you change or add more values to</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineplus">+// these constants, be sure to modify the corresponding definitions in</span>
<a href="#l7.27"></a><span id="l7.27" class="difflineplus">+// mailWindowOverlay.js</span>
<a href="#l7.28"></a><span id="l7.28"> #define kNoRemoteContentPolicy 0</span>
<a href="#l7.29"></a><span id="l7.29"> #define kBlockRemoteContent 1</span>
<a href="#l7.30"></a><span id="l7.30"> #define kAllowRemoteContent 2</span>
<a href="#l7.31"></a><span id="l7.31"> </span>
<a href="#l7.32"></a><span id="l7.32" class="difflineminus">-NS_IMPL_ISUPPORTS(nsMsgContentPolicy,</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineminus">-                  nsIContentPolicy,</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineminus">-                  nsIWebProgressListener,</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineminus">-                  nsIMsgContentPolicy,</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineminus">-                  nsIObserver,</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineminus">-                  nsISupportsWeakReference)</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineplus">+NS_IMPL_ISUPPORTS(nsMsgContentPolicy, nsIContentPolicy, nsIWebProgressListener,</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineplus">+                  nsIMsgContentPolicy, nsIObserver, nsISupportsWeakReference)</span>
<a href="#l7.40"></a><span id="l7.40"> </span>
<a href="#l7.41"></a><span id="l7.41" class="difflineminus">-nsMsgContentPolicy::nsMsgContentPolicy()</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineminus">-{</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineminus">-  mBlockRemoteImages = true;</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineminus">-}</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineplus">+nsMsgContentPolicy::nsMsgContentPolicy() { mBlockRemoteImages = true; }</span>
<a href="#l7.46"></a><span id="l7.46"> </span>
<a href="#l7.47"></a><span id="l7.47" class="difflineminus">-nsMsgContentPolicy::~nsMsgContentPolicy()</span>
<a href="#l7.48"></a><span id="l7.48" class="difflineminus">-{</span>
<a href="#l7.49"></a><span id="l7.49" class="difflineplus">+nsMsgContentPolicy::~nsMsgContentPolicy() {</span>
<a href="#l7.50"></a><span id="l7.50">   // hey, we are going away...clean up after ourself....unregister our observer</span>
<a href="#l7.51"></a><span id="l7.51">   nsresult rv;</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineminus">-  nsCOMPtr&lt;nsIPrefBranch&gt; prefInternal = do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineminus">-  {</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineplus">+  nsCOMPtr&lt;nsIPrefBranch&gt; prefInternal =</span>
<a href="#l7.56"></a><span id="l7.56" class="difflineplus">+      do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l7.57"></a><span id="l7.57" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l7.58"></a><span id="l7.58">     prefInternal-&gt;RemoveObserver(kBlockRemoteImages, this);</span>
<a href="#l7.59"></a><span id="l7.59">   }</span>
<a href="#l7.60"></a><span id="l7.60"> }</span>
<a href="#l7.61"></a><span id="l7.61"> </span>
<a href="#l7.62"></a><span id="l7.62" class="difflineminus">-nsresult nsMsgContentPolicy::Init()</span>
<a href="#l7.63"></a><span id="l7.63" class="difflineminus">-{</span>
<a href="#l7.64"></a><span id="l7.64" class="difflineplus">+nsresult nsMsgContentPolicy::Init() {</span>
<a href="#l7.65"></a><span id="l7.65">   nsresult rv;</span>
<a href="#l7.66"></a><span id="l7.66"> </span>
<a href="#l7.67"></a><span id="l7.67" class="difflineminus">-  // register ourself as an observer on the mail preference to block remote images</span>
<a href="#l7.68"></a><span id="l7.68" class="difflineminus">-  nsCOMPtr&lt;nsIPrefBranch&gt; prefInternal = do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l7.69"></a><span id="l7.69" class="difflineplus">+  // register ourself as an observer on the mail preference to block remote</span>
<a href="#l7.70"></a><span id="l7.70" class="difflineplus">+  // images</span>
<a href="#l7.71"></a><span id="l7.71" class="difflineplus">+  nsCOMPtr&lt;nsIPrefBranch&gt; prefInternal =</span>
<a href="#l7.72"></a><span id="l7.72" class="difflineplus">+      do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l7.73"></a><span id="l7.73">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.74"></a><span id="l7.74"> </span>
<a href="#l7.75"></a><span id="l7.75">   prefInternal-&gt;AddObserver(kBlockRemoteImages, this, true);</span>
<a href="#l7.76"></a><span id="l7.76"> </span>
<a href="#l7.77"></a><span id="l7.77">   prefInternal-&gt;GetCharPref(kTrustedDomains, mTrustedMailDomains);</span>
<a href="#l7.78"></a><span id="l7.78">   prefInternal-&gt;GetBoolPref(kBlockRemoteImages, &amp;mBlockRemoteImages);</span>
<a href="#l7.79"></a><span id="l7.79"> </span>
<a href="#l7.80"></a><span id="l7.80">   // Grab a handle on the PermissionManager service for managing allowed remote</span>
<a href="#l7.81"></a><span id="l7.81" class="difflineat">@@ -88,71 +82,67 @@ nsresult nsMsgContentPolicy::Init()</span>
<a href="#l7.82"></a><span id="l7.82"> </span>
<a href="#l7.83"></a><span id="l7.83">   return NS_OK;</span>
<a href="#l7.84"></a><span id="l7.84"> }</span>
<a href="#l7.85"></a><span id="l7.85"> </span>
<a href="#l7.86"></a><span id="l7.86"> /**</span>
<a href="#l7.87"></a><span id="l7.87">  * @returns true if the sender referenced by aMsgHdr is explicitly allowed to</span>
<a href="#l7.88"></a><span id="l7.88">  *          load remote images according to the PermissionManager</span>
<a href="#l7.89"></a><span id="l7.89">  */</span>
<a href="#l7.90"></a><span id="l7.90" class="difflineminus">-bool</span>
<a href="#l7.91"></a><span id="l7.91" class="difflineminus">-nsMsgContentPolicy::ShouldAcceptRemoteContentForSender(nsIMsgDBHdr *aMsgHdr)</span>
<a href="#l7.92"></a><span id="l7.92" class="difflineminus">-{</span>
<a href="#l7.93"></a><span id="l7.93" class="difflineminus">-  if (!aMsgHdr)</span>
<a href="#l7.94"></a><span id="l7.94" class="difflineminus">-    return false;</span>
<a href="#l7.95"></a><span id="l7.95" class="difflineplus">+bool nsMsgContentPolicy::ShouldAcceptRemoteContentForSender(</span>
<a href="#l7.96"></a><span id="l7.96" class="difflineplus">+    nsIMsgDBHdr *aMsgHdr) {</span>
<a href="#l7.97"></a><span id="l7.97" class="difflineplus">+  if (!aMsgHdr) return false;</span>
<a href="#l7.98"></a><span id="l7.98"> </span>
<a href="#l7.99"></a><span id="l7.99">   // extract the e-mail address from the msg hdr</span>
<a href="#l7.100"></a><span id="l7.100">   nsCString author;</span>
<a href="#l7.101"></a><span id="l7.101">   nsresult rv = aMsgHdr-&gt;GetAuthor(getter_Copies(author));</span>
<a href="#l7.102"></a><span id="l7.102">   NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l7.103"></a><span id="l7.103"> </span>
<a href="#l7.104"></a><span id="l7.104">   nsCString emailAddress;</span>
<a href="#l7.105"></a><span id="l7.105">   ExtractEmail(EncodedHeader(author), emailAddress);</span>
<a href="#l7.106"></a><span id="l7.106" class="difflineminus">-  if (emailAddress.IsEmpty())</span>
<a href="#l7.107"></a><span id="l7.107" class="difflineminus">-    return false;</span>
<a href="#l7.108"></a><span id="l7.108" class="difflineplus">+  if (emailAddress.IsEmpty()) return false;</span>
<a href="#l7.109"></a><span id="l7.109"> </span>
<a href="#l7.110"></a><span id="l7.110" class="difflineminus">-  nsCOMPtr&lt;nsIIOService&gt; ios = do_GetService(&quot;@mozilla.org/network/io-service;1&quot;, &amp;rv);</span>
<a href="#l7.111"></a><span id="l7.111" class="difflineplus">+  nsCOMPtr&lt;nsIIOService&gt; ios =</span>
<a href="#l7.112"></a><span id="l7.112" class="difflineplus">+      do_GetService(&quot;@mozilla.org/network/io-service;1&quot;, &amp;rv);</span>
<a href="#l7.113"></a><span id="l7.113">   NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l7.114"></a><span id="l7.114">   nsCOMPtr&lt;nsIURI&gt; mailURI;</span>
<a href="#l7.115"></a><span id="l7.115">   emailAddress.InsertLiteral(&quot;chrome://messenger/content/email=&quot;, 0);</span>
<a href="#l7.116"></a><span id="l7.116">   rv = ios-&gt;NewURI(emailAddress, nullptr, nullptr, getter_AddRefs(mailURI));</span>
<a href="#l7.117"></a><span id="l7.117">   NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l7.118"></a><span id="l7.118"> </span>
<a href="#l7.119"></a><span id="l7.119">   // check with permission manager</span>
<a href="#l7.120"></a><span id="l7.120">   uint32_t permission = 0;</span>
<a href="#l7.121"></a><span id="l7.121" class="difflineminus">-  rv = mPermissionManager-&gt;TestPermission(mailURI, NS_LITERAL_CSTRING(&quot;image&quot;), &amp;permission);</span>
<a href="#l7.122"></a><span id="l7.122" class="difflineplus">+  rv = mPermissionManager-&gt;TestPermission(mailURI, NS_LITERAL_CSTRING(&quot;image&quot;),</span>
<a href="#l7.123"></a><span id="l7.123" class="difflineplus">+                                          &amp;permission);</span>
<a href="#l7.124"></a><span id="l7.124">   NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l7.125"></a><span id="l7.125"> </span>
<a href="#l7.126"></a><span id="l7.126">   // Only return true if the permission manager has an explicit allow</span>
<a href="#l7.127"></a><span id="l7.127">   return (permission == nsIPermissionManager::ALLOW_ACTION);</span>
<a href="#l7.128"></a><span id="l7.128"> }</span>
<a href="#l7.129"></a><span id="l7.129"> </span>
<a href="#l7.130"></a><span id="l7.130"> /**</span>
<a href="#l7.131"></a><span id="l7.131">  * Extract the host name from aContentLocation, and look it up in our list</span>
<a href="#l7.132"></a><span id="l7.132">  * of trusted domains.</span>
<a href="#l7.133"></a><span id="l7.133">  */</span>
<a href="#l7.134"></a><span id="l7.134" class="difflineminus">-bool nsMsgContentPolicy::IsTrustedDomain(nsIURI * aContentLocation)</span>
<a href="#l7.135"></a><span id="l7.135" class="difflineminus">-{</span>
<a href="#l7.136"></a><span id="l7.136" class="difflineplus">+bool nsMsgContentPolicy::IsTrustedDomain(nsIURI *aContentLocation) {</span>
<a href="#l7.137"></a><span id="l7.137">   bool trustedDomain = false;</span>
<a href="#l7.138"></a><span id="l7.138">   // get the host name of the server hosting the remote image</span>
<a href="#l7.139"></a><span id="l7.139">   nsAutoCString host;</span>
<a href="#l7.140"></a><span id="l7.140">   nsresult rv = aContentLocation-&gt;GetHost(host);</span>
<a href="#l7.141"></a><span id="l7.141"> </span>
<a href="#l7.142"></a><span id="l7.142">   if (NS_SUCCEEDED(rv) &amp;&amp; !mTrustedMailDomains.IsEmpty())</span>
<a href="#l7.143"></a><span id="l7.143">     trustedDomain = MsgHostDomainIsTrusted(host, mTrustedMailDomains);</span>
<a href="#l7.144"></a><span id="l7.144"> </span>
<a href="#l7.145"></a><span id="l7.145">   return trustedDomain;</span>
<a href="#l7.146"></a><span id="l7.146"> }</span>
<a href="#l7.147"></a><span id="l7.147"> </span>
<a href="#l7.148"></a><span id="l7.148"> NS_IMETHODIMP</span>
<a href="#l7.149"></a><span id="l7.149" class="difflineminus">-nsMsgContentPolicy::ShouldLoad(nsIURI           *aContentLocation,</span>
<a href="#l7.150"></a><span id="l7.150" class="difflineminus">-                               nsILoadInfo      *aLoadInfo,</span>
<a href="#l7.151"></a><span id="l7.151" class="difflineplus">+nsMsgContentPolicy::ShouldLoad(nsIURI *aContentLocation, nsILoadInfo *aLoadInfo,</span>
<a href="#l7.152"></a><span id="l7.152">                                const nsACString &amp;aMimeGuess,</span>
<a href="#l7.153"></a><span id="l7.153" class="difflineminus">-                               int16_t          *aDecision)</span>
<a href="#l7.154"></a><span id="l7.154" class="difflineminus">-{</span>
<a href="#l7.155"></a><span id="l7.155" class="difflineplus">+                               int16_t *aDecision) {</span>
<a href="#l7.156"></a><span id="l7.156">   nsresult rv = NS_OK;</span>
<a href="#l7.157"></a><span id="l7.157">   uint32_t aContentType = aLoadInfo-&gt;GetExternalContentPolicyType();</span>
<a href="#l7.158"></a><span id="l7.158">   nsCOMPtr&lt;nsISupports&gt; aRequestingContext;</span>
<a href="#l7.159"></a><span id="l7.159">   if (aContentType == nsIContentPolicy::TYPE_DOCUMENT)</span>
<a href="#l7.160"></a><span id="l7.160">     aRequestingContext = aLoadInfo-&gt;ContextForTopLevelLoad();</span>
<a href="#l7.161"></a><span id="l7.161">   else</span>
<a href="#l7.162"></a><span id="l7.162">     aRequestingContext = aLoadInfo-&gt;LoadingNode();</span>
<a href="#l7.163"></a><span id="l7.163">   nsCOMPtr&lt;nsIPrincipal&gt; aRequestPrincipal = aLoadInfo-&gt;TriggeringPrincipal();</span>
<a href="#l7.164"></a><span id="l7.164" class="difflineat">@@ -172,81 +162,80 @@ nsMsgContentPolicy::ShouldLoad(nsIURI   </span>
<a href="#l7.165"></a><span id="l7.165">   //</span>
<a href="#l7.166"></a><span id="l7.166">   // In most cases if an error occurs, its something we didn't expect so we</span>
<a href="#l7.167"></a><span id="l7.167">   // should be rejecting the document anyway.</span>
<a href="#l7.168"></a><span id="l7.168">   *aDecision = nsIContentPolicy::ACCEPT;</span>
<a href="#l7.169"></a><span id="l7.169"> </span>
<a href="#l7.170"></a><span id="l7.170">   NS_ENSURE_ARG_POINTER(aContentLocation);</span>
<a href="#l7.171"></a><span id="l7.171"> </span>
<a href="#l7.172"></a><span id="l7.172"> #ifdef DEBUG_MsgContentPolicy</span>
<a href="#l7.173"></a><span id="l7.173" class="difflineminus">-  fprintf(stderr, &quot;aContentType: %d\naContentLocation = %s\n&quot;,</span>
<a href="#l7.174"></a><span id="l7.174" class="difflineminus">-          aContentType,</span>
<a href="#l7.175"></a><span id="l7.175" class="difflineplus">+  fprintf(stderr, &quot;aContentType: %d\naContentLocation = %s\n&quot;, aContentType,</span>
<a href="#l7.176"></a><span id="l7.176">           aContentLocation-&gt;GetSpecOrDefault().get());</span>
<a href="#l7.177"></a><span id="l7.177"> #endif</span>
<a href="#l7.178"></a><span id="l7.178"> </span>
<a href="#l7.179"></a><span id="l7.179"> #ifndef MOZ_THUNDERBIRD</span>
<a href="#l7.180"></a><span id="l7.180">   // Go find out if we are dealing with mailnews. Anything else</span>
<a href="#l7.181"></a><span id="l7.181">   // isn't our concern and we accept content.</span>
<a href="#l7.182"></a><span id="l7.182">   nsCOMPtr&lt;nsIDocShell&gt; rootDocShell;</span>
<a href="#l7.183"></a><span id="l7.183">   rv = GetRootDocShellForContext(aRequestingContext,</span>
<a href="#l7.184"></a><span id="l7.184">                                  getter_AddRefs(rootDocShell));</span>
<a href="#l7.185"></a><span id="l7.185">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.186"></a><span id="l7.186"> </span>
<a href="#l7.187"></a><span id="l7.187">   // We only want to deal with mailnews</span>
<a href="#l7.188"></a><span id="l7.188" class="difflineminus">-  if (rootDocShell-&gt;GetAppType() != nsIDocShell::APP_TYPE_MAIL)</span>
<a href="#l7.189"></a><span id="l7.189" class="difflineminus">-    return NS_OK;</span>
<a href="#l7.190"></a><span id="l7.190" class="difflineplus">+  if (rootDocShell-&gt;GetAppType() != nsIDocShell::APP_TYPE_MAIL) return NS_OK;</span>
<a href="#l7.191"></a><span id="l7.191"> #endif</span>
<a href="#l7.192"></a><span id="l7.192"> </span>
<a href="#l7.193"></a><span id="l7.193" class="difflineminus">-  switch(aContentType) {</span>
<a href="#l7.194"></a><span id="l7.194" class="difflineminus">-    // Plugins (nsIContentPolicy::TYPE_OBJECT) are blocked on document load.</span>
<a href="#l7.195"></a><span id="l7.195" class="difflineminus">-  case nsIContentPolicy::TYPE_DOCUMENT:</span>
<a href="#l7.196"></a><span id="l7.196" class="difflineminus">-    // At this point, we have no intention of supporting a different JS</span>
<a href="#l7.197"></a><span id="l7.197" class="difflineminus">-    // setting on a subdocument, so we don't worry about TYPE_SUBDOCUMENT here.</span>
<a href="#l7.198"></a><span id="l7.198" class="difflineplus">+  switch (aContentType) {</span>
<a href="#l7.199"></a><span id="l7.199" class="difflineplus">+      // Plugins (nsIContentPolicy::TYPE_OBJECT) are blocked on document load.</span>
<a href="#l7.200"></a><span id="l7.200" class="difflineplus">+    case nsIContentPolicy::TYPE_DOCUMENT:</span>
<a href="#l7.201"></a><span id="l7.201" class="difflineplus">+      // At this point, we have no intention of supporting a different JS</span>
<a href="#l7.202"></a><span id="l7.202" class="difflineplus">+      // setting on a subdocument, so we don't worry about TYPE_SUBDOCUMENT</span>
<a href="#l7.203"></a><span id="l7.203" class="difflineplus">+      // here.</span>
<a href="#l7.204"></a><span id="l7.204"> </span>
<a href="#l7.205"></a><span id="l7.205" class="difflineminus">-    // If the timing were right, we'd enable JavaScript on the docshell</span>
<a href="#l7.206"></a><span id="l7.206" class="difflineminus">-    // for non mailnews URIs here.  However, at this point, the</span>
<a href="#l7.207"></a><span id="l7.207" class="difflineminus">-    // old document may still be around, so we can't do any enabling just yet.</span>
<a href="#l7.208"></a><span id="l7.208" class="difflineminus">-    // Instead, we apply the policy in nsIWebProgressListener::OnLocationChange.</span>
<a href="#l7.209"></a><span id="l7.209" class="difflineminus">-    // For now, we explicitly disable JavaScript in order to be safe rather than</span>
<a href="#l7.210"></a><span id="l7.210" class="difflineminus">-    // sorry, because OnLocationChange isn't guaranteed to necessarily be called</span>
<a href="#l7.211"></a><span id="l7.211" class="difflineminus">-    // soon enough to disable it in time (though bz says it _should_ be called</span>
<a href="#l7.212"></a><span id="l7.212" class="difflineminus">-    // soon enough &quot;in all sane cases&quot;).</span>
<a href="#l7.213"></a><span id="l7.213" class="difflineminus">-    rv = SetDisableItemsOnMailNewsUrlDocshells(aContentLocation,</span>
<a href="#l7.214"></a><span id="l7.214" class="difflineminus">-                                               aRequestingContext);</span>
<a href="#l7.215"></a><span id="l7.215" class="difflineminus">-    // if something went wrong during the tweaking, reject this content</span>
<a href="#l7.216"></a><span id="l7.216" class="difflineminus">-    if (NS_FAILED(rv)) {</span>
<a href="#l7.217"></a><span id="l7.217" class="difflineminus">-      NS_WARNING(&quot;Failed to set disable items on docShells&quot;);</span>
<a href="#l7.218"></a><span id="l7.218" class="difflineminus">-      *aDecision = nsIContentPolicy::REJECT_TYPE;</span>
<a href="#l7.219"></a><span id="l7.219" class="difflineplus">+      // If the timing were right, we'd enable JavaScript on the docshell</span>
<a href="#l7.220"></a><span id="l7.220" class="difflineplus">+      // for non mailnews URIs here.  However, at this point, the</span>
<a href="#l7.221"></a><span id="l7.221" class="difflineplus">+      // old document may still be around, so we can't do any enabling just yet.</span>
<a href="#l7.222"></a><span id="l7.222" class="difflineplus">+      // Instead, we apply the policy in</span>
<a href="#l7.223"></a><span id="l7.223" class="difflineplus">+      // nsIWebProgressListener::OnLocationChange. For now, we explicitly</span>
<a href="#l7.224"></a><span id="l7.224" class="difflineplus">+      // disable JavaScript in order to be safe rather than sorry, because</span>
<a href="#l7.225"></a><span id="l7.225" class="difflineplus">+      // OnLocationChange isn't guaranteed to necessarily be called soon enough</span>
<a href="#l7.226"></a><span id="l7.226" class="difflineplus">+      // to disable it in time (though bz says it _should_ be called soon enough</span>
<a href="#l7.227"></a><span id="l7.227" class="difflineplus">+      // &quot;in all sane cases&quot;).</span>
<a href="#l7.228"></a><span id="l7.228" class="difflineplus">+      rv = SetDisableItemsOnMailNewsUrlDocshells(aContentLocation,</span>
<a href="#l7.229"></a><span id="l7.229" class="difflineplus">+                                                 aRequestingContext);</span>
<a href="#l7.230"></a><span id="l7.230" class="difflineplus">+      // if something went wrong during the tweaking, reject this content</span>
<a href="#l7.231"></a><span id="l7.231" class="difflineplus">+      if (NS_FAILED(rv)) {</span>
<a href="#l7.232"></a><span id="l7.232" class="difflineplus">+        NS_WARNING(&quot;Failed to set disable items on docShells&quot;);</span>
<a href="#l7.233"></a><span id="l7.233" class="difflineplus">+        *aDecision = nsIContentPolicy::REJECT_TYPE;</span>
<a href="#l7.234"></a><span id="l7.234" class="difflineplus">+        return NS_OK;</span>
<a href="#l7.235"></a><span id="l7.235" class="difflineplus">+      }</span>
<a href="#l7.236"></a><span id="l7.236" class="difflineplus">+      break;</span>
<a href="#l7.237"></a><span id="l7.237" class="difflineplus">+</span>
<a href="#l7.238"></a><span id="l7.238" class="difflineplus">+    case nsIContentPolicy::TYPE_CSP_REPORT:</span>
<a href="#l7.239"></a><span id="l7.239" class="difflineplus">+      // We cannot block CSP reports.</span>
<a href="#l7.240"></a><span id="l7.240" class="difflineplus">+      *aDecision = nsIContentPolicy::ACCEPT;</span>
<a href="#l7.241"></a><span id="l7.241">       return NS_OK;</span>
<a href="#l7.242"></a><span id="l7.242" class="difflineminus">-    }</span>
<a href="#l7.243"></a><span id="l7.243" class="difflineminus">-    break;</span>
<a href="#l7.244"></a><span id="l7.244" class="difflineplus">+      break;</span>
<a href="#l7.245"></a><span id="l7.245"> </span>
<a href="#l7.246"></a><span id="l7.246" class="difflineminus">-  case nsIContentPolicy::TYPE_CSP_REPORT:</span>
<a href="#l7.247"></a><span id="l7.247" class="difflineminus">-    // We cannot block CSP reports.</span>
<a href="#l7.248"></a><span id="l7.248" class="difflineminus">-    *aDecision = nsIContentPolicy::ACCEPT;</span>
<a href="#l7.249"></a><span id="l7.249" class="difflineminus">-    return NS_OK;</span>
<a href="#l7.250"></a><span id="l7.250" class="difflineminus">-    break;</span>
<a href="#l7.251"></a><span id="l7.251" class="difflineminus">-</span>
<a href="#l7.252"></a><span id="l7.252" class="difflineminus">-  default:</span>
<a href="#l7.253"></a><span id="l7.253" class="difflineminus">-    break;</span>
<a href="#l7.254"></a><span id="l7.254" class="difflineplus">+    default:</span>
<a href="#l7.255"></a><span id="l7.255" class="difflineplus">+      break;</span>
<a href="#l7.256"></a><span id="l7.256">   }</span>
<a href="#l7.257"></a><span id="l7.257"> </span>
<a href="#l7.258"></a><span id="l7.258">   // NOTE: Not using NS_ENSURE_ARG_POINTER because this is a legitimate case</span>
<a href="#l7.259"></a><span id="l7.259">   // that can happen.  Also keep in mind that the default policy used for a</span>
<a href="#l7.260"></a><span id="l7.260">   // failure code is ACCEPT.</span>
<a href="#l7.261"></a><span id="l7.261" class="difflineminus">-  if (!aRequestingLocation)</span>
<a href="#l7.262"></a><span id="l7.262" class="difflineminus">-    return NS_ERROR_INVALID_POINTER;</span>
<a href="#l7.263"></a><span id="l7.263" class="difflineplus">+  if (!aRequestingLocation) return NS_ERROR_INVALID_POINTER;</span>
<a href="#l7.264"></a><span id="l7.264"> </span>
<a href="#l7.265"></a><span id="l7.265"> #ifdef DEBUG_MsgContentPolicy</span>
<a href="#l7.266"></a><span id="l7.266" class="difflineminus">-  fprintf(stderr, &quot;aRequestingLocation = %s\n&quot;, aRequestingLocation-&gt;GetSpecOrDefault().get());</span>
<a href="#l7.267"></a><span id="l7.267" class="difflineplus">+  fprintf(stderr, &quot;aRequestingLocation = %s\n&quot;,</span>
<a href="#l7.268"></a><span id="l7.268" class="difflineplus">+          aRequestingLocation-&gt;GetSpecOrDefault().get());</span>
<a href="#l7.269"></a><span id="l7.269"> #endif</span>
<a href="#l7.270"></a><span id="l7.270"> </span>
<a href="#l7.271"></a><span id="l7.271">   // If the requesting location is safe, accept the content location request.</span>
<a href="#l7.272"></a><span id="l7.272" class="difflineminus">-  if (IsSafeRequestingLocation(aRequestingLocation))</span>
<a href="#l7.273"></a><span id="l7.273" class="difflineminus">-    return rv;</span>
<a href="#l7.274"></a><span id="l7.274" class="difflineplus">+  if (IsSafeRequestingLocation(aRequestingLocation)) return rv;</span>
<a href="#l7.275"></a><span id="l7.275"> </span>
<a href="#l7.276"></a><span id="l7.276">   // Now default to reject so early returns via NS_ENSURE_SUCCESS</span>
<a href="#l7.277"></a><span id="l7.277">   // cause content to be rejected.</span>
<a href="#l7.278"></a><span id="l7.278">   *aDecision = nsIContentPolicy::REJECT_REQUEST;</span>
<a href="#l7.279"></a><span id="l7.279"> </span>
<a href="#l7.280"></a><span id="l7.280">   // We want to establish the following:</span>
<a href="#l7.281"></a><span id="l7.281">   // \--------\  requester    |               |              |</span>
<a href="#l7.282"></a><span id="l7.282">   // content   \------------\ |               |              |</span>
<a href="#l7.283"></a><span id="l7.283" class="difflineat">@@ -258,163 +247,149 @@ nsMsgContentPolicy::ShouldLoad(nsIURI   </span>
<a href="#l7.284"></a><span id="l7.284">   // news message             | don't load (4)| load (5)     | load (6)</span>
<a href="#l7.285"></a><span id="l7.285">   // -------------------------+---------------+--------------+------------------</span>
<a href="#l7.286"></a><span id="l7.286">   // http(s)/data, etc.       | (default)     | (default)    | (default)</span>
<a href="#l7.287"></a><span id="l7.287">   // -------------------------+---------------+--------------+------------------</span>
<a href="#l7.288"></a><span id="l7.288">   nsCOMPtr&lt;nsIMsgMessageUrl&gt; contentURL(do_QueryInterface(aContentLocation));</span>
<a href="#l7.289"></a><span id="l7.289">   if (contentURL) {</span>
<a href="#l7.290"></a><span id="l7.290">     nsCOMPtr&lt;nsINntpUrl&gt; contentNntpURL(do_QueryInterface(aContentLocation));</span>
<a href="#l7.291"></a><span id="l7.291">     if (!contentNntpURL) {</span>
<a href="#l7.292"></a><span id="l7.292" class="difflineminus">-      // Mail message (mailbox, imap or JsAccount) content requested, for example</span>
<a href="#l7.293"></a><span id="l7.293" class="difflineminus">-      // a message part, like an image:</span>
<a href="#l7.294"></a><span id="l7.294" class="difflineminus">-      // To load mail message content the requester must have the same</span>
<a href="#l7.295"></a><span id="l7.295" class="difflineminus">-      // &quot;normalized&quot; principal. This is basically a &quot;same origin&quot; test, it</span>
<a href="#l7.296"></a><span id="l7.296" class="difflineminus">-      // protects against cross-loading of mail message content from</span>
<a href="#l7.297"></a><span id="l7.297" class="difflineminus">-      // other mail or news messages.</span>
<a href="#l7.298"></a><span id="l7.298" class="difflineminus">-      nsCOMPtr&lt;nsIMsgMessageUrl&gt; requestURL(do_QueryInterface(aRequestingLocation));</span>
<a href="#l7.299"></a><span id="l7.299" class="difflineplus">+      // Mail message (mailbox, imap or JsAccount) content requested, for</span>
<a href="#l7.300"></a><span id="l7.300" class="difflineplus">+      // example a message part, like an image: To load mail message content the</span>
<a href="#l7.301"></a><span id="l7.301" class="difflineplus">+      // requester must have the same &quot;normalized&quot; principal. This is basically</span>
<a href="#l7.302"></a><span id="l7.302" class="difflineplus">+      // a &quot;same origin&quot; test, it protects against cross-loading of mail message</span>
<a href="#l7.303"></a><span id="l7.303" class="difflineplus">+      // content from other mail or news messages.</span>
<a href="#l7.304"></a><span id="l7.304" class="difflineplus">+      nsCOMPtr&lt;nsIMsgMessageUrl&gt; requestURL(</span>
<a href="#l7.305"></a><span id="l7.305" class="difflineplus">+          do_QueryInterface(aRequestingLocation));</span>
<a href="#l7.306"></a><span id="l7.306">       // If the request URL is not also a message URL, then we don't accept.</span>
<a href="#l7.307"></a><span id="l7.307">       if (requestURL) {</span>
<a href="#l7.308"></a><span id="l7.308">         nsCString contentPrincipalSpec, requestPrincipalSpec;</span>
<a href="#l7.309"></a><span id="l7.309">         nsresult rv1 = contentURL-&gt;GetNormalizedSpec(contentPrincipalSpec);</span>
<a href="#l7.310"></a><span id="l7.310">         nsresult rv2 = requestURL-&gt;GetNormalizedSpec(requestPrincipalSpec);</span>
<a href="#l7.311"></a><span id="l7.311">         if (NS_SUCCEEDED(rv1) &amp;&amp; NS_SUCCEEDED(rv2) &amp;&amp;</span>
<a href="#l7.312"></a><span id="l7.312">             contentPrincipalSpec.Equals(requestPrincipalSpec))</span>
<a href="#l7.313"></a><span id="l7.313" class="difflineminus">-          *aDecision = nsIContentPolicy::ACCEPT; // (1)</span>
<a href="#l7.314"></a><span id="l7.314" class="difflineplus">+          *aDecision = nsIContentPolicy::ACCEPT;  // (1)</span>
<a href="#l7.315"></a><span id="l7.315">       }</span>
<a href="#l7.316"></a><span id="l7.316" class="difflineminus">-      return NS_OK; // (2) and (3)</span>
<a href="#l7.317"></a><span id="l7.317" class="difflineplus">+      return NS_OK;  // (2) and (3)</span>
<a href="#l7.318"></a><span id="l7.318">     }</span>
<a href="#l7.319"></a><span id="l7.319"> </span>
<a href="#l7.320"></a><span id="l7.320">     // News message content requested. Don't accept request coming</span>
<a href="#l7.321"></a><span id="l7.321">     // from a mail message since it would access the news server.</span>
<a href="#l7.322"></a><span id="l7.322" class="difflineminus">-    nsCOMPtr&lt;nsIMsgMessageUrl&gt; requestURL(do_QueryInterface(aRequestingLocation));</span>
<a href="#l7.323"></a><span id="l7.323" class="difflineplus">+    nsCOMPtr&lt;nsIMsgMessageUrl&gt; requestURL(</span>
<a href="#l7.324"></a><span id="l7.324" class="difflineplus">+        do_QueryInterface(aRequestingLocation));</span>
<a href="#l7.325"></a><span id="l7.325">     if (requestURL) {</span>
<a href="#l7.326"></a><span id="l7.326" class="difflineminus">-      nsCOMPtr&lt;nsINntpUrl&gt; requestNntpURL(do_QueryInterface(aRequestingLocation));</span>
<a href="#l7.327"></a><span id="l7.327" class="difflineminus">-      if (!requestNntpURL)</span>
<a href="#l7.328"></a><span id="l7.328" class="difflineminus">-        return NS_OK; // (4)</span>
<a href="#l7.329"></a><span id="l7.329" class="difflineplus">+      nsCOMPtr&lt;nsINntpUrl&gt; requestNntpURL(</span>
<a href="#l7.330"></a><span id="l7.330" class="difflineplus">+          do_QueryInterface(aRequestingLocation));</span>
<a href="#l7.331"></a><span id="l7.331" class="difflineplus">+      if (!requestNntpURL) return NS_OK;  // (4)</span>
<a href="#l7.332"></a><span id="l7.332">     }</span>
<a href="#l7.333"></a><span id="l7.333" class="difflineminus">-    *aDecision = nsIContentPolicy::ACCEPT; // (5) and (6)</span>
<a href="#l7.334"></a><span id="l7.334" class="difflineplus">+    *aDecision = nsIContentPolicy::ACCEPT;  // (5) and (6)</span>
<a href="#l7.335"></a><span id="l7.335">     return NS_OK;</span>
<a href="#l7.336"></a><span id="l7.336">   }</span>
<a href="#l7.337"></a><span id="l7.337"> </span>
<a href="#l7.338"></a><span id="l7.338">   // If exposed protocol not covered by the test above or protocol that has been</span>
<a href="#l7.339"></a><span id="l7.339">   // specifically exposed by an add-on, or is a chrome url, then allow the load.</span>
<a href="#l7.340"></a><span id="l7.340" class="difflineminus">-  if (IsExposedProtocol(aContentLocation))</span>
<a href="#l7.341"></a><span id="l7.341" class="difflineminus">-  {</span>
<a href="#l7.342"></a><span id="l7.342" class="difflineplus">+  if (IsExposedProtocol(aContentLocation)) {</span>
<a href="#l7.343"></a><span id="l7.343">     *aDecision = nsIContentPolicy::ACCEPT;</span>
<a href="#l7.344"></a><span id="l7.344">     return NS_OK;</span>
<a href="#l7.345"></a><span id="l7.345">   }</span>
<a href="#l7.346"></a><span id="l7.346"> </span>
<a href="#l7.347"></a><span id="l7.347">   // never load unexposed protocols except for http, https and file.</span>
<a href="#l7.348"></a><span id="l7.348">   // Protocols like ftp are always blocked.</span>
<a href="#l7.349"></a><span id="l7.349" class="difflineminus">-  if (ShouldBlockUnexposedProtocol(aContentLocation))</span>
<a href="#l7.350"></a><span id="l7.350" class="difflineminus">-    return NS_OK;</span>
<a href="#l7.351"></a><span id="l7.351" class="difflineminus">-</span>
<a href="#l7.352"></a><span id="l7.352" class="difflineplus">+  if (ShouldBlockUnexposedProtocol(aContentLocation)) return NS_OK;</span>
<a href="#l7.353"></a><span id="l7.353"> </span>
<a href="#l7.354"></a><span id="l7.354">   // Find out the URI that originally initiated the set of requests for this</span>
<a href="#l7.355"></a><span id="l7.355">   // context.</span>
<a href="#l7.356"></a><span id="l7.356">   nsCOMPtr&lt;nsIURI&gt; originatorLocation;</span>
<a href="#l7.357"></a><span id="l7.357" class="difflineminus">-  if (!aRequestingContext &amp;&amp; aRequestPrincipal)</span>
<a href="#l7.358"></a><span id="l7.358" class="difflineminus">-  {</span>
<a href="#l7.359"></a><span id="l7.359" class="difflineplus">+  if (!aRequestingContext &amp;&amp; aRequestPrincipal) {</span>
<a href="#l7.360"></a><span id="l7.360">     // Can get the URI directly from the principal.</span>
<a href="#l7.361"></a><span id="l7.361">     rv = aRequestPrincipal-&gt;GetURI(getter_AddRefs(originatorLocation));</span>
<a href="#l7.362"></a><span id="l7.362" class="difflineminus">-  }</span>
<a href="#l7.363"></a><span id="l7.363" class="difflineminus">-  else</span>
<a href="#l7.364"></a><span id="l7.364" class="difflineminus">-  {</span>
<a href="#l7.365"></a><span id="l7.365" class="difflineplus">+  } else {</span>
<a href="#l7.366"></a><span id="l7.366">     rv = GetOriginatingURIForContext(aRequestingContext,</span>
<a href="#l7.367"></a><span id="l7.367">                                      getter_AddRefs(originatorLocation));</span>
<a href="#l7.368"></a><span id="l7.368" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; !originatorLocation)</span>
<a href="#l7.369"></a><span id="l7.369" class="difflineminus">-      return NS_OK;</span>
<a href="#l7.370"></a><span id="l7.370" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; !originatorLocation) return NS_OK;</span>
<a href="#l7.371"></a><span id="l7.371">   }</span>
<a href="#l7.372"></a><span id="l7.372">   NS_ENSURE_SUCCESS(rv, NS_OK);</span>
<a href="#l7.373"></a><span id="l7.373"> </span>
<a href="#l7.374"></a><span id="l7.374"> #ifdef DEBUG_MsgContentPolicy</span>
<a href="#l7.375"></a><span id="l7.375" class="difflineminus">-  fprintf(stderr, &quot;originatorLocation = %s\n&quot;, originatorLocation-&gt;GetSpecOrDefault().get());</span>
<a href="#l7.376"></a><span id="l7.376" class="difflineplus">+  fprintf(stderr, &quot;originatorLocation = %s\n&quot;,</span>
<a href="#l7.377"></a><span id="l7.377" class="difflineplus">+          originatorLocation-&gt;GetSpecOrDefault().get());</span>
<a href="#l7.378"></a><span id="l7.378"> #endif</span>
<a href="#l7.379"></a><span id="l7.379"> </span>
<a href="#l7.380"></a><span id="l7.380">   // Don't load remote content for encrypted messages.</span>
<a href="#l7.381"></a><span id="l7.381" class="difflineminus">-  nsCOMPtr&lt;nsIEncryptedSMIMEURIsService&gt; encryptedURIService =</span>
<a href="#l7.382"></a><span id="l7.382" class="difflineminus">-    do_GetService(&quot;@mozilla.org/messenger-smime/smime-encrypted-uris-service;1&quot;, &amp;rv);</span>
<a href="#l7.383"></a><span id="l7.383" class="difflineplus">+  nsCOMPtr&lt;nsIEncryptedSMIMEURIsService&gt; encryptedURIService = do_GetService(</span>
<a href="#l7.384"></a><span id="l7.384" class="difflineplus">+      &quot;@mozilla.org/messenger-smime/smime-encrypted-uris-service;1&quot;, &amp;rv);</span>
<a href="#l7.385"></a><span id="l7.385">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.386"></a><span id="l7.386">   bool isEncrypted;</span>
<a href="#l7.387"></a><span id="l7.387" class="difflineminus">-  rv = encryptedURIService-&gt;IsEncrypted(aRequestingLocation-&gt;GetSpecOrDefault(), &amp;isEncrypted);</span>
<a href="#l7.388"></a><span id="l7.388" class="difflineplus">+  rv = encryptedURIService-&gt;IsEncrypted(aRequestingLocation-&gt;GetSpecOrDefault(),</span>
<a href="#l7.389"></a><span id="l7.389" class="difflineplus">+                                        &amp;isEncrypted);</span>
<a href="#l7.390"></a><span id="l7.390">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.391"></a><span id="l7.391" class="difflineminus">-  if (isEncrypted)</span>
<a href="#l7.392"></a><span id="l7.392" class="difflineminus">-  {</span>
<a href="#l7.393"></a><span id="l7.393" class="difflineplus">+  if (isEncrypted) {</span>
<a href="#l7.394"></a><span id="l7.394">     *aDecision = nsIContentPolicy::REJECT_REQUEST;</span>
<a href="#l7.395"></a><span id="l7.395">     NotifyContentWasBlocked(originatorLocation, aContentLocation, false);</span>
<a href="#l7.396"></a><span id="l7.396">     return NS_OK;</span>
<a href="#l7.397"></a><span id="l7.397">   }</span>
<a href="#l7.398"></a><span id="l7.398"> </span>
<a href="#l7.399"></a><span id="l7.399">   // If we are allowing all remote content...</span>
<a href="#l7.400"></a><span id="l7.400" class="difflineminus">-  if (!mBlockRemoteImages)</span>
<a href="#l7.401"></a><span id="l7.401" class="difflineminus">-  {</span>
<a href="#l7.402"></a><span id="l7.402" class="difflineplus">+  if (!mBlockRemoteImages) {</span>
<a href="#l7.403"></a><span id="l7.403">     *aDecision = nsIContentPolicy::ACCEPT;</span>
<a href="#l7.404"></a><span id="l7.404">     return NS_OK;</span>
<a href="#l7.405"></a><span id="l7.405">   }</span>
<a href="#l7.406"></a><span id="l7.406"> </span>
<a href="#l7.407"></a><span id="l7.407">   // Extract the windowtype to handle compose windows separately from mail</span>
<a href="#l7.408"></a><span id="l7.408" class="difflineminus">-  if (aRequestingContext)</span>
<a href="#l7.409"></a><span id="l7.409" class="difflineminus">-  {</span>
<a href="#l7.410"></a><span id="l7.410" class="difflineplus">+  if (aRequestingContext) {</span>
<a href="#l7.411"></a><span id="l7.411">     nsCOMPtr&lt;nsIMsgCompose&gt; msgCompose =</span>
<a href="#l7.412"></a><span id="l7.412" class="difflineminus">-      GetMsgComposeForContext(aRequestingContext);</span>
<a href="#l7.413"></a><span id="l7.413" class="difflineplus">+        GetMsgComposeForContext(aRequestingContext);</span>
<a href="#l7.414"></a><span id="l7.414">     // Work out if we're in a compose window or not.</span>
<a href="#l7.415"></a><span id="l7.415" class="difflineminus">-    if (msgCompose)</span>
<a href="#l7.416"></a><span id="l7.416" class="difflineminus">-    {</span>
<a href="#l7.417"></a><span id="l7.417" class="difflineplus">+    if (msgCompose) {</span>
<a href="#l7.418"></a><span id="l7.418">       ComposeShouldLoad(msgCompose, aRequestingContext, aContentLocation,</span>
<a href="#l7.419"></a><span id="l7.419">                         aDecision);</span>
<a href="#l7.420"></a><span id="l7.420">       return NS_OK;</span>
<a href="#l7.421"></a><span id="l7.421">     }</span>
<a href="#l7.422"></a><span id="l7.422">   }</span>
<a href="#l7.423"></a><span id="l7.423"> </span>
<a href="#l7.424"></a><span id="l7.424">   // Allow content when using a remote page.</span>
<a href="#l7.425"></a><span id="l7.425">   bool isHttp;</span>
<a href="#l7.426"></a><span id="l7.426">   bool isHttps;</span>
<a href="#l7.427"></a><span id="l7.427">   rv = originatorLocation-&gt;SchemeIs(&quot;http&quot;, &amp;isHttp);</span>
<a href="#l7.428"></a><span id="l7.428">   nsresult rv2 = originatorLocation-&gt;SchemeIs(&quot;https&quot;, &amp;isHttps);</span>
<a href="#l7.429"></a><span id="l7.429" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; NS_SUCCEEDED(rv2) &amp;&amp; (isHttp || isHttps))</span>
<a href="#l7.430"></a><span id="l7.430" class="difflineminus">-  {</span>
<a href="#l7.431"></a><span id="l7.431" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; NS_SUCCEEDED(rv2) &amp;&amp; (isHttp || isHttps)) {</span>
<a href="#l7.432"></a><span id="l7.432">     *aDecision = nsIContentPolicy::ACCEPT;</span>
<a href="#l7.433"></a><span id="l7.433">     return NS_OK;</span>
<a href="#l7.434"></a><span id="l7.434">   }</span>
<a href="#l7.435"></a><span id="l7.435"> </span>
<a href="#l7.436"></a><span id="l7.436">   uint32_t permission;</span>
<a href="#l7.437"></a><span id="l7.437" class="difflineminus">-  mPermissionManager-&gt;TestPermission(aContentLocation, NS_LITERAL_CSTRING(&quot;image&quot;), &amp;permission);</span>
<a href="#l7.438"></a><span id="l7.438" class="difflineplus">+  mPermissionManager-&gt;TestPermission(aContentLocation,</span>
<a href="#l7.439"></a><span id="l7.439" class="difflineplus">+                                     NS_LITERAL_CSTRING(&quot;image&quot;), &amp;permission);</span>
<a href="#l7.440"></a><span id="l7.440">   switch (permission) {</span>
<a href="#l7.441"></a><span id="l7.441" class="difflineminus">-    case nsIPermissionManager::UNKNOWN_ACTION:</span>
<a href="#l7.442"></a><span id="l7.442" class="difflineminus">-    {</span>
<a href="#l7.443"></a><span id="l7.443" class="difflineplus">+    case nsIPermissionManager::UNKNOWN_ACTION: {</span>
<a href="#l7.444"></a><span id="l7.444">       // No exception was found for this location.</span>
<a href="#l7.445"></a><span id="l7.445">       break;</span>
<a href="#l7.446"></a><span id="l7.446">     }</span>
<a href="#l7.447"></a><span id="l7.447" class="difflineminus">-    case nsIPermissionManager::ALLOW_ACTION:</span>
<a href="#l7.448"></a><span id="l7.448" class="difflineminus">-    {</span>
<a href="#l7.449"></a><span id="l7.449" class="difflineplus">+    case nsIPermissionManager::ALLOW_ACTION: {</span>
<a href="#l7.450"></a><span id="l7.450">       *aDecision = nsIContentPolicy::ACCEPT;</span>
<a href="#l7.451"></a><span id="l7.451">       return NS_OK;</span>
<a href="#l7.452"></a><span id="l7.452">     }</span>
<a href="#l7.453"></a><span id="l7.453" class="difflineminus">-    case nsIPermissionManager::DENY_ACTION:</span>
<a href="#l7.454"></a><span id="l7.454" class="difflineminus">-    {</span>
<a href="#l7.455"></a><span id="l7.455" class="difflineplus">+    case nsIPermissionManager::DENY_ACTION: {</span>
<a href="#l7.456"></a><span id="l7.456">       *aDecision = nsIContentPolicy::REJECT_REQUEST;</span>
<a href="#l7.457"></a><span id="l7.457">       return NS_OK;</span>
<a href="#l7.458"></a><span id="l7.458">     }</span>
<a href="#l7.459"></a><span id="l7.459">   }</span>
<a href="#l7.460"></a><span id="l7.460"> </span>
<a href="#l7.461"></a><span id="l7.461">   // The default decision is still to reject.</span>
<a href="#l7.462"></a><span id="l7.462">   ShouldAcceptContentForPotentialMsg(originatorLocation, aContentLocation,</span>
<a href="#l7.463"></a><span id="l7.463">                                      aDecision);</span>
<a href="#l7.464"></a><span id="l7.464">   return NS_OK;</span>
<a href="#l7.465"></a><span id="l7.465"> }</span>
<a href="#l7.466"></a><span id="l7.466"> </span>
<a href="#l7.467"></a><span id="l7.467"> /**</span>
<a href="#l7.468"></a><span id="l7.468">  * Determines if the requesting location is a safe one, i.e. its under the</span>
<a href="#l7.469"></a><span id="l7.469">  * app/user's control - so file, about, chrome etc.</span>
<a href="#l7.470"></a><span id="l7.470">  */</span>
<a href="#l7.471"></a><span id="l7.471" class="difflineminus">-bool</span>
<a href="#l7.472"></a><span id="l7.472" class="difflineminus">-nsMsgContentPolicy::IsSafeRequestingLocation(nsIURI *aRequestingLocation)</span>
<a href="#l7.473"></a><span id="l7.473" class="difflineminus">-{</span>
<a href="#l7.474"></a><span id="l7.474" class="difflineminus">-  if (!aRequestingLocation)</span>
<a href="#l7.475"></a><span id="l7.475" class="difflineminus">-    return false;</span>
<a href="#l7.476"></a><span id="l7.476" class="difflineplus">+bool nsMsgContentPolicy::IsSafeRequestingLocation(nsIURI *aRequestingLocation) {</span>
<a href="#l7.477"></a><span id="l7.477" class="difflineplus">+  if (!aRequestingLocation) return false;</span>
<a href="#l7.478"></a><span id="l7.478"> </span>
<a href="#l7.479"></a><span id="l7.479">   // If aRequestingLocation is one of chrome, resource, file or view-source,</span>
<a href="#l7.480"></a><span id="l7.480">   // allow aContentLocation to load.</span>
<a href="#l7.481"></a><span id="l7.481">   bool isChrome;</span>
<a href="#l7.482"></a><span id="l7.482">   bool isRes;</span>
<a href="#l7.483"></a><span id="l7.483">   bool isFile;</span>
<a href="#l7.484"></a><span id="l7.484">   bool isViewSource;</span>
<a href="#l7.485"></a><span id="l7.485"> </span>
<a href="#l7.486"></a><span id="l7.486" class="difflineat">@@ -422,59 +397,54 @@ nsMsgContentPolicy::IsSafeRequestingLoca</span>
<a href="#l7.487"></a><span id="l7.487">   NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l7.488"></a><span id="l7.488">   rv = aRequestingLocation-&gt;SchemeIs(&quot;resource&quot;, &amp;isRes);</span>
<a href="#l7.489"></a><span id="l7.489">   NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l7.490"></a><span id="l7.490">   rv = aRequestingLocation-&gt;SchemeIs(&quot;file&quot;, &amp;isFile);</span>
<a href="#l7.491"></a><span id="l7.491">   NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l7.492"></a><span id="l7.492">   rv = aRequestingLocation-&gt;SchemeIs(&quot;view-source&quot;, &amp;isViewSource);</span>
<a href="#l7.493"></a><span id="l7.493">   NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l7.494"></a><span id="l7.494"> </span>
<a href="#l7.495"></a><span id="l7.495" class="difflineminus">-  if (isChrome || isRes || isFile || isViewSource)</span>
<a href="#l7.496"></a><span id="l7.496" class="difflineminus">-    return true;</span>
<a href="#l7.497"></a><span id="l7.497" class="difflineplus">+  if (isChrome || isRes || isFile || isViewSource) return true;</span>
<a href="#l7.498"></a><span id="l7.498"> </span>
<a href="#l7.499"></a><span id="l7.499">   // Only allow about: to load anything if the requesting location is not the</span>
<a href="#l7.500"></a><span id="l7.500">   // special about:blank one.</span>
<a href="#l7.501"></a><span id="l7.501">   bool isAbout;</span>
<a href="#l7.502"></a><span id="l7.502">   rv = aRequestingLocation-&gt;SchemeIs(&quot;about&quot;, &amp;isAbout);</span>
<a href="#l7.503"></a><span id="l7.503">   NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l7.504"></a><span id="l7.504"> </span>
<a href="#l7.505"></a><span id="l7.505" class="difflineminus">-  if (!isAbout)</span>
<a href="#l7.506"></a><span id="l7.506" class="difflineminus">-    return false;</span>
<a href="#l7.507"></a><span id="l7.507" class="difflineplus">+  if (!isAbout) return false;</span>
<a href="#l7.508"></a><span id="l7.508"> </span>
<a href="#l7.509"></a><span id="l7.509">   nsCString fullSpec;</span>
<a href="#l7.510"></a><span id="l7.510">   rv = aRequestingLocation-&gt;GetSpec(fullSpec);</span>
<a href="#l7.511"></a><span id="l7.511">   NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l7.512"></a><span id="l7.512"> </span>
<a href="#l7.513"></a><span id="l7.513">   return !fullSpec.EqualsLiteral(&quot;about:blank&quot;);</span>
<a href="#l7.514"></a><span id="l7.514"> }</span>
<a href="#l7.515"></a><span id="l7.515"> </span>
<a href="#l7.516"></a><span id="l7.516"> /**</span>
<a href="#l7.517"></a><span id="l7.517">  * Determines if the content location is a scheme that we're willing to expose</span>
<a href="#l7.518"></a><span id="l7.518">  * for unlimited loading of content.</span>
<a href="#l7.519"></a><span id="l7.519">  */</span>
<a href="#l7.520"></a><span id="l7.520" class="difflineminus">-bool</span>
<a href="#l7.521"></a><span id="l7.521" class="difflineminus">-nsMsgContentPolicy::IsExposedProtocol(nsIURI *aContentLocation)</span>
<a href="#l7.522"></a><span id="l7.522" class="difflineminus">-{</span>
<a href="#l7.523"></a><span id="l7.523" class="difflineplus">+bool nsMsgContentPolicy::IsExposedProtocol(nsIURI *aContentLocation) {</span>
<a href="#l7.524"></a><span id="l7.524">   nsAutoCString contentScheme;</span>
<a href="#l7.525"></a><span id="l7.525">   nsresult rv = aContentLocation-&gt;GetScheme(contentScheme);</span>
<a href="#l7.526"></a><span id="l7.526">   NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l7.527"></a><span id="l7.527"> </span>
<a href="#l7.528"></a><span id="l7.528">   // Check some exposed protocols. Not all protocols in the list of</span>
<a href="#l7.529"></a><span id="l7.529">   // network.protocol-handler.expose.* prefs in all-thunderbird.js are</span>
<a href="#l7.530"></a><span id="l7.530">   // admitted purely based on their scheme.</span>
<a href="#l7.531"></a><span id="l7.531">   // news, snews, nntp, imap and mailbox are checked before the call</span>
<a href="#l7.532"></a><span id="l7.532">   // to this function by matching content location and requesting location.</span>
<a href="#l7.533"></a><span id="l7.533">   if (MsgLowerCaseEqualsLiteral(contentScheme, &quot;mailto&quot;) ||</span>
<a href="#l7.534"></a><span id="l7.534">       MsgLowerCaseEqualsLiteral(contentScheme, &quot;addbook&quot;) ||</span>
<a href="#l7.535"></a><span id="l7.535">       MsgLowerCaseEqualsLiteral(contentScheme, &quot;about&quot;))</span>
<a href="#l7.536"></a><span id="l7.536">     return true;</span>
<a href="#l7.537"></a><span id="l7.537"> </span>
<a href="#l7.538"></a><span id="l7.538">   // check if customized exposed scheme</span>
<a href="#l7.539"></a><span id="l7.539" class="difflineminus">-  if (mCustomExposedProtocols.Contains(contentScheme))</span>
<a href="#l7.540"></a><span id="l7.540" class="difflineminus">-    return true;</span>
<a href="#l7.541"></a><span id="l7.541" class="difflineplus">+  if (mCustomExposedProtocols.Contains(contentScheme)) return true;</span>
<a href="#l7.542"></a><span id="l7.542"> </span>
<a href="#l7.543"></a><span id="l7.543">   bool isData;</span>
<a href="#l7.544"></a><span id="l7.544">   bool isChrome;</span>
<a href="#l7.545"></a><span id="l7.545">   bool isRes;</span>
<a href="#l7.546"></a><span id="l7.546">   bool isMozExtension;</span>
<a href="#l7.547"></a><span id="l7.547">   rv = aContentLocation-&gt;SchemeIs(&quot;chrome&quot;, &amp;isChrome);</span>
<a href="#l7.548"></a><span id="l7.548">   NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l7.549"></a><span id="l7.549">   rv = aContentLocation-&gt;SchemeIs(&quot;resource&quot;, &amp;isRes);</span>
<a href="#l7.550"></a><span id="l7.550" class="difflineat">@@ -485,19 +455,18 @@ nsMsgContentPolicy::IsExposedProtocol(ns</span>
<a href="#l7.551"></a><span id="l7.551">   NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l7.552"></a><span id="l7.552"> </span>
<a href="#l7.553"></a><span id="l7.553">   return isChrome || isRes || isData || isMozExtension;</span>
<a href="#l7.554"></a><span id="l7.554"> }</span>
<a href="#l7.555"></a><span id="l7.555"> </span>
<a href="#l7.556"></a><span id="l7.556"> /**</span>
<a href="#l7.557"></a><span id="l7.557">  * We block most unexposed protocols - apart from http(s) and file.</span>
<a href="#l7.558"></a><span id="l7.558">  */</span>
<a href="#l7.559"></a><span id="l7.559" class="difflineminus">-bool</span>
<a href="#l7.560"></a><span id="l7.560" class="difflineminus">-nsMsgContentPolicy::ShouldBlockUnexposedProtocol(nsIURI *aContentLocation)</span>
<a href="#l7.561"></a><span id="l7.561" class="difflineminus">-{</span>
<a href="#l7.562"></a><span id="l7.562" class="difflineplus">+bool nsMsgContentPolicy::ShouldBlockUnexposedProtocol(</span>
<a href="#l7.563"></a><span id="l7.563" class="difflineplus">+    nsIURI *aContentLocation) {</span>
<a href="#l7.564"></a><span id="l7.564">   bool isHttp;</span>
<a href="#l7.565"></a><span id="l7.565">   bool isHttps;</span>
<a href="#l7.566"></a><span id="l7.566">   bool isFile;</span>
<a href="#l7.567"></a><span id="l7.567">   // Error condition - we must return true so that we block.</span>
<a href="#l7.568"></a><span id="l7.568">   nsresult rv = aContentLocation-&gt;SchemeIs(&quot;http&quot;, &amp;isHttp);</span>
<a href="#l7.569"></a><span id="l7.569">   NS_ENSURE_SUCCESS(rv, true);</span>
<a href="#l7.570"></a><span id="l7.570">   rv = aContentLocation-&gt;SchemeIs(&quot;https&quot;, &amp;isHttps);</span>
<a href="#l7.571"></a><span id="l7.571">   NS_ENSURE_SUCCESS(rv, true);</span>
<a href="#l7.572"></a><span id="l7.572" class="difflineat">@@ -512,23 +481,20 @@ nsMsgContentPolicy::ShouldBlockUnexposed</span>
<a href="#l7.573"></a><span id="l7.573">  * When determining if to allow the request for a given msg hdr, the function</span>
<a href="#l7.574"></a><span id="l7.574">  * will go through the list of remote content blocking criteria:</span>
<a href="#l7.575"></a><span id="l7.575">  *</span>
<a href="#l7.576"></a><span id="l7.576">  * #1 Allow if there is a db header for a manual override.</span>
<a href="#l7.577"></a><span id="l7.577">  * #2 Allow if the message is in an RSS folder.</span>
<a href="#l7.578"></a><span id="l7.578">  * #3 Allow if the domain for the remote image in our white list.</span>
<a href="#l7.579"></a><span id="l7.579">  * #4 Allow if the author has been specifically white listed.</span>
<a href="#l7.580"></a><span id="l7.580">  */</span>
<a href="#l7.581"></a><span id="l7.581" class="difflineminus">-int16_t</span>
<a href="#l7.582"></a><span id="l7.582" class="difflineminus">-nsMsgContentPolicy::ShouldAcceptRemoteContentForMsgHdr(nsIMsgDBHdr *aMsgHdr,</span>
<a href="#l7.583"></a><span id="l7.583" class="difflineminus">-                                                       nsIURI *aRequestingLocation,</span>
<a href="#l7.584"></a><span id="l7.584" class="difflineminus">-                                                       nsIURI *aContentLocation)</span>
<a href="#l7.585"></a><span id="l7.585" class="difflineminus">-{</span>
<a href="#l7.586"></a><span id="l7.586" class="difflineminus">-  if (!aMsgHdr)</span>
<a href="#l7.587"></a><span id="l7.587" class="difflineminus">-    return static_cast&lt;int16_t&gt;(nsIContentPolicy::REJECT_REQUEST);</span>
<a href="#l7.588"></a><span id="l7.588" class="difflineplus">+int16_t nsMsgContentPolicy::ShouldAcceptRemoteContentForMsgHdr(</span>
<a href="#l7.589"></a><span id="l7.589" class="difflineplus">+    nsIMsgDBHdr *aMsgHdr, nsIURI *aRequestingLocation,</span>
<a href="#l7.590"></a><span id="l7.590" class="difflineplus">+    nsIURI *aContentLocation) {</span>
<a href="#l7.591"></a><span id="l7.591" class="difflineplus">+  if (!aMsgHdr) return static_cast&lt;int16_t&gt;(nsIContentPolicy::REJECT_REQUEST);</span>
<a href="#l7.592"></a><span id="l7.592"> </span>
<a href="#l7.593"></a><span id="l7.593">   // Case #1, check the db hdr for the remote content policy on this particular</span>
<a href="#l7.594"></a><span id="l7.594">   // message.</span>
<a href="#l7.595"></a><span id="l7.595">   uint32_t remoteContentPolicy = kNoRemoteContentPolicy;</span>
<a href="#l7.596"></a><span id="l7.596">   aMsgHdr-&gt;GetUint32Property(&quot;remoteContentPolicy&quot;, &amp;remoteContentPolicy);</span>
<a href="#l7.597"></a><span id="l7.597"> </span>
<a href="#l7.598"></a><span id="l7.598">   // Case #2, check if the message is in an RSS folder</span>
<a href="#l7.599"></a><span id="l7.599">   bool isRSS = false;</span>
<a href="#l7.600"></a><span id="l7.600" class="difflineat">@@ -540,279 +506,260 @@ nsMsgContentPolicy::ShouldAcceptRemoteCo</span>
<a href="#l7.601"></a><span id="l7.601">   // Case 4 means looking up items in the permissions database. So if</span>
<a href="#l7.602"></a><span id="l7.602">   // either of the two previous items means we load the data, just do it.</span>
<a href="#l7.603"></a><span id="l7.603">   if (isRSS || remoteContentPolicy == kAllowRemoteContent || trustedDomain)</span>
<a href="#l7.604"></a><span id="l7.604">     return nsIContentPolicy::ACCEPT;</span>
<a href="#l7.605"></a><span id="l7.605"> </span>
<a href="#l7.606"></a><span id="l7.606">   // Case #4, author is in our white list..</span>
<a href="#l7.607"></a><span id="l7.607">   bool allowForSender = ShouldAcceptRemoteContentForSender(aMsgHdr);</span>
<a href="#l7.608"></a><span id="l7.608"> </span>
<a href="#l7.609"></a><span id="l7.609" class="difflineminus">-  int16_t result = allowForSender ?</span>
<a href="#l7.610"></a><span id="l7.610" class="difflineminus">-    static_cast&lt;int16_t&gt;(nsIContentPolicy::ACCEPT) :</span>
<a href="#l7.611"></a><span id="l7.611" class="difflineminus">-    static_cast&lt;int16_t&gt;(nsIContentPolicy::REJECT_REQUEST);</span>
<a href="#l7.612"></a><span id="l7.612" class="difflineplus">+  int16_t result = allowForSender</span>
<a href="#l7.613"></a><span id="l7.613" class="difflineplus">+                       ? static_cast&lt;int16_t&gt;(nsIContentPolicy::ACCEPT)</span>
<a href="#l7.614"></a><span id="l7.614" class="difflineplus">+                       : static_cast&lt;int16_t&gt;(nsIContentPolicy::REJECT_REQUEST);</span>
<a href="#l7.615"></a><span id="l7.615"> </span>
<a href="#l7.616"></a><span id="l7.616">   // kNoRemoteContentPolicy means we have never set a value on the message</span>
<a href="#l7.617"></a><span id="l7.617">   if (result == nsIContentPolicy::REJECT_REQUEST &amp;&amp; !remoteContentPolicy)</span>
<a href="#l7.618"></a><span id="l7.618">     aMsgHdr-&gt;SetUint32Property(&quot;remoteContentPolicy&quot;, kBlockRemoteContent);</span>
<a href="#l7.619"></a><span id="l7.619"> </span>
<a href="#l7.620"></a><span id="l7.620">   return result;</span>
<a href="#l7.621"></a><span id="l7.621"> }</span>
<a href="#l7.622"></a><span id="l7.622"> </span>
<a href="#l7.623"></a><span id="l7.623" class="difflineminus">-class RemoteContentNotifierEvent : public mozilla::Runnable</span>
<a href="#l7.624"></a><span id="l7.624" class="difflineminus">-{</span>
<a href="#l7.625"></a><span id="l7.625" class="difflineminus">-public:</span>
<a href="#l7.626"></a><span id="l7.626" class="difflineplus">+class RemoteContentNotifierEvent : public mozilla::Runnable {</span>
<a href="#l7.627"></a><span id="l7.627" class="difflineplus">+ public:</span>
<a href="#l7.628"></a><span id="l7.628">   RemoteContentNotifierEvent(nsIMsgWindow *aMsgWindow, nsIMsgDBHdr *aMsgHdr,</span>
<a href="#l7.629"></a><span id="l7.629">                              nsIURI *aContentURI, bool aCanOverride = true)</span>
<a href="#l7.630"></a><span id="l7.630" class="difflineminus">-    : mozilla::Runnable(&quot;RemoteContentNotifierEvent&quot;)</span>
<a href="#l7.631"></a><span id="l7.631" class="difflineminus">-    , mMsgWindow(aMsgWindow), mMsgHdr(aMsgHdr), mContentURI(aContentURI),</span>
<a href="#l7.632"></a><span id="l7.632" class="difflineminus">-    mCanOverride(aCanOverride)</span>
<a href="#l7.633"></a><span id="l7.633" class="difflineminus">-  {}</span>
<a href="#l7.634"></a><span id="l7.634" class="difflineplus">+      : mozilla::Runnable(&quot;RemoteContentNotifierEvent&quot;),</span>
<a href="#l7.635"></a><span id="l7.635" class="difflineplus">+        mMsgWindow(aMsgWindow),</span>
<a href="#l7.636"></a><span id="l7.636" class="difflineplus">+        mMsgHdr(aMsgHdr),</span>
<a href="#l7.637"></a><span id="l7.637" class="difflineplus">+        mContentURI(aContentURI),</span>
<a href="#l7.638"></a><span id="l7.638" class="difflineplus">+        mCanOverride(aCanOverride) {}</span>
<a href="#l7.639"></a><span id="l7.639"> </span>
<a href="#l7.640"></a><span id="l7.640" class="difflineminus">-  NS_IMETHOD Run()</span>
<a href="#l7.641"></a><span id="l7.641" class="difflineminus">-  {</span>
<a href="#l7.642"></a><span id="l7.642" class="difflineminus">-    if (mMsgWindow)</span>
<a href="#l7.643"></a><span id="l7.643" class="difflineminus">-    {</span>
<a href="#l7.644"></a><span id="l7.644" class="difflineplus">+  NS_IMETHOD Run() {</span>
<a href="#l7.645"></a><span id="l7.645" class="difflineplus">+    if (mMsgWindow) {</span>
<a href="#l7.646"></a><span id="l7.646">       nsCOMPtr&lt;nsIMsgHeaderSink&gt; msgHdrSink;</span>
<a href="#l7.647"></a><span id="l7.647">       (void)mMsgWindow-&gt;GetMsgHeaderSink(getter_AddRefs(msgHdrSink));</span>
<a href="#l7.648"></a><span id="l7.648">       if (msgHdrSink)</span>
<a href="#l7.649"></a><span id="l7.649">         msgHdrSink-&gt;OnMsgHasRemoteContent(mMsgHdr, mContentURI, mCanOverride);</span>
<a href="#l7.650"></a><span id="l7.650">     }</span>
<a href="#l7.651"></a><span id="l7.651">     return NS_OK;</span>
<a href="#l7.652"></a><span id="l7.652">   }</span>
<a href="#l7.653"></a><span id="l7.653"> </span>
<a href="#l7.654"></a><span id="l7.654" class="difflineminus">-private:</span>
<a href="#l7.655"></a><span id="l7.655" class="difflineplus">+ private:</span>
<a href="#l7.656"></a><span id="l7.656">   nsCOMPtr&lt;nsIMsgWindow&gt; mMsgWindow;</span>
<a href="#l7.657"></a><span id="l7.657">   nsCOMPtr&lt;nsIMsgDBHdr&gt; mMsgHdr;</span>
<a href="#l7.658"></a><span id="l7.658">   nsCOMPtr&lt;nsIURI&gt; mContentURI;</span>
<a href="#l7.659"></a><span id="l7.659">   bool mCanOverride;</span>
<a href="#l7.660"></a><span id="l7.660"> };</span>
<a href="#l7.661"></a><span id="l7.661"> </span>
<a href="#l7.662"></a><span id="l7.662"> /**</span>
<a href="#l7.663"></a><span id="l7.663">  * This function is used to show a blocked remote content notification.</span>
<a href="#l7.664"></a><span id="l7.664">  */</span>
<a href="#l7.665"></a><span id="l7.665" class="difflineminus">-void</span>
<a href="#l7.666"></a><span id="l7.666" class="difflineminus">-nsMsgContentPolicy::NotifyContentWasBlocked(nsIURI *aOriginatorLocation,</span>
<a href="#l7.667"></a><span id="l7.667" class="difflineminus">-                                            nsIURI *aContentLocation,</span>
<a href="#l7.668"></a><span id="l7.668" class="difflineminus">-                                            bool aCanOverride)</span>
<a href="#l7.669"></a><span id="l7.669" class="difflineminus">-{</span>
<a href="#l7.670"></a><span id="l7.670" class="difflineplus">+void nsMsgContentPolicy::NotifyContentWasBlocked(nsIURI *aOriginatorLocation,</span>
<a href="#l7.671"></a><span id="l7.671" class="difflineplus">+                                                 nsIURI *aContentLocation,</span>
<a href="#l7.672"></a><span id="l7.672" class="difflineplus">+                                                 bool aCanOverride) {</span>
<a href="#l7.673"></a><span id="l7.673">   // Is it a mailnews url?</span>
<a href="#l7.674"></a><span id="l7.674">   nsresult rv;</span>
<a href="#l7.675"></a><span id="l7.675" class="difflineminus">-  nsCOMPtr&lt;nsIMsgMessageUrl&gt; msgUrl(do_QueryInterface(aOriginatorLocation,</span>
<a href="#l7.676"></a><span id="l7.676" class="difflineminus">-                                                      &amp;rv));</span>
<a href="#l7.677"></a><span id="l7.677" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l7.678"></a><span id="l7.678" class="difflineminus">-  {</span>
<a href="#l7.679"></a><span id="l7.679" class="difflineplus">+  nsCOMPtr&lt;nsIMsgMessageUrl&gt; msgUrl(</span>
<a href="#l7.680"></a><span id="l7.680" class="difflineplus">+      do_QueryInterface(aOriginatorLocation, &amp;rv));</span>
<a href="#l7.681"></a><span id="l7.681" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l7.682"></a><span id="l7.682">     return;</span>
<a href="#l7.683"></a><span id="l7.683">   }</span>
<a href="#l7.684"></a><span id="l7.684"> </span>
<a href="#l7.685"></a><span id="l7.685">   nsCString resourceURI;</span>
<a href="#l7.686"></a><span id="l7.686">   rv = msgUrl-&gt;GetUri(getter_Copies(resourceURI));</span>
<a href="#l7.687"></a><span id="l7.687">   NS_ENSURE_SUCCESS_VOID(rv);</span>
<a href="#l7.688"></a><span id="l7.688"> </span>
<a href="#l7.689"></a><span id="l7.689" class="difflineminus">-  nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsUrl(do_QueryInterface(aOriginatorLocation, &amp;rv));</span>
<a href="#l7.690"></a><span id="l7.690" class="difflineplus">+  nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsUrl(</span>
<a href="#l7.691"></a><span id="l7.691" class="difflineplus">+      do_QueryInterface(aOriginatorLocation, &amp;rv));</span>
<a href="#l7.692"></a><span id="l7.692">   NS_ENSURE_SUCCESS_VOID(rv);</span>
<a href="#l7.693"></a><span id="l7.693"> </span>
<a href="#l7.694"></a><span id="l7.694">   nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l7.695"></a><span id="l7.695">   rv = GetMsgDBHdrFromURI(resourceURI.get(), getter_AddRefs(msgHdr));</span>
<a href="#l7.696"></a><span id="l7.696" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l7.697"></a><span id="l7.697" class="difflineminus">-  {</span>
<a href="#l7.698"></a><span id="l7.698" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l7.699"></a><span id="l7.699">     // Maybe we can get a dummy header.</span>
<a href="#l7.700"></a><span id="l7.700">     nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow;</span>
<a href="#l7.701"></a><span id="l7.701">     rv = mailnewsUrl-&gt;GetMsgWindow(getter_AddRefs(msgWindow));</span>
<a href="#l7.702"></a><span id="l7.702" class="difflineminus">-    if (msgWindow)</span>
<a href="#l7.703"></a><span id="l7.703" class="difflineminus">-    {</span>
<a href="#l7.704"></a><span id="l7.704" class="difflineplus">+    if (msgWindow) {</span>
<a href="#l7.705"></a><span id="l7.705">       nsCOMPtr&lt;nsIMsgHeaderSink&gt; msgHdrSink;</span>
<a href="#l7.706"></a><span id="l7.706">       rv = msgWindow-&gt;GetMsgHeaderSink(getter_AddRefs(msgHdrSink));</span>
<a href="#l7.707"></a><span id="l7.707">       if (msgHdrSink)</span>
<a href="#l7.708"></a><span id="l7.708">         rv = msgHdrSink-&gt;GetDummyMsgHeader(getter_AddRefs(msgHdr));</span>
<a href="#l7.709"></a><span id="l7.709">     }</span>
<a href="#l7.710"></a><span id="l7.710">   }</span>
<a href="#l7.711"></a><span id="l7.711"> </span>
<a href="#l7.712"></a><span id="l7.712">   nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow;</span>
<a href="#l7.713"></a><span id="l7.713">   (void)mailnewsUrl-&gt;GetMsgWindow(getter_AddRefs(msgWindow));</span>
<a href="#l7.714"></a><span id="l7.714" class="difflineminus">-  if (msgWindow)</span>
<a href="#l7.715"></a><span id="l7.715" class="difflineminus">-  {</span>
<a href="#l7.716"></a><span id="l7.716" class="difflineminus">-    nsCOMPtr&lt;nsIRunnable&gt; event =</span>
<a href="#l7.717"></a><span id="l7.717" class="difflineminus">-      new RemoteContentNotifierEvent(msgWindow, msgHdr, aContentLocation, aCanOverride);</span>
<a href="#l7.718"></a><span id="l7.718" class="difflineplus">+  if (msgWindow) {</span>
<a href="#l7.719"></a><span id="l7.719" class="difflineplus">+    nsCOMPtr&lt;nsIRunnable&gt; event = new RemoteContentNotifierEvent(</span>
<a href="#l7.720"></a><span id="l7.720" class="difflineplus">+        msgWindow, msgHdr, aContentLocation, aCanOverride);</span>
<a href="#l7.721"></a><span id="l7.721">     // Post this as an event because it can cause dom mutations, and we</span>
<a href="#l7.722"></a><span id="l7.722">     // get called at a bad time to be causing dom mutations.</span>
<a href="#l7.723"></a><span id="l7.723" class="difflineminus">-    if (event)</span>
<a href="#l7.724"></a><span id="l7.724" class="difflineminus">-      NS_DispatchToCurrentThread(event);</span>
<a href="#l7.725"></a><span id="l7.725" class="difflineplus">+    if (event) NS_DispatchToCurrentThread(event);</span>
<a href="#l7.726"></a><span id="l7.726">   }</span>
<a href="#l7.727"></a><span id="l7.727"> }</span>
<a href="#l7.728"></a><span id="l7.728"> </span>
<a href="#l7.729"></a><span id="l7.729"> /**</span>
<a href="#l7.730"></a><span id="l7.730">  * This function is used to determine if we allow content for a remote message.</span>
<a href="#l7.731"></a><span id="l7.731">  * If we reject loading remote content, then we'll inform the message window</span>
<a href="#l7.732"></a><span id="l7.732">  * that this message has remote content (and hence we are not loading it).</span>
<a href="#l7.733"></a><span id="l7.733">  *</span>
<a href="#l7.734"></a><span id="l7.734">  * See ShouldAcceptRemoteContentForMsgHdr for the actual decisions that</span>
<a href="#l7.735"></a><span id="l7.735">  * determine if we are going to allow remote content.</span>
<a href="#l7.736"></a><span id="l7.736">  */</span>
<a href="#l7.737"></a><span id="l7.737" class="difflineminus">-void</span>
<a href="#l7.738"></a><span id="l7.738" class="difflineminus">-nsMsgContentPolicy::ShouldAcceptContentForPotentialMsg(nsIURI *aOriginatorLocation,</span>
<a href="#l7.739"></a><span id="l7.739" class="difflineminus">-                                                       nsIURI *aContentLocation,</span>
<a href="#l7.740"></a><span id="l7.740" class="difflineminus">-                                                       int16_t *aDecision)</span>
<a href="#l7.741"></a><span id="l7.741" class="difflineminus">-{</span>
<a href="#l7.742"></a><span id="l7.742" class="difflineminus">-  NS_ASSERTION(*aDecision == nsIContentPolicy::REJECT_REQUEST,</span>
<a href="#l7.743"></a><span id="l7.743" class="difflineminus">-               &quot;AllowContentForPotentialMessage expects default decision to be reject!&quot;);</span>
<a href="#l7.744"></a><span id="l7.744" class="difflineplus">+void nsMsgContentPolicy::ShouldAcceptContentForPotentialMsg(</span>
<a href="#l7.745"></a><span id="l7.745" class="difflineplus">+    nsIURI *aOriginatorLocation, nsIURI *aContentLocation, int16_t *aDecision) {</span>
<a href="#l7.746"></a><span id="l7.746" class="difflineplus">+  NS_ASSERTION(</span>
<a href="#l7.747"></a><span id="l7.747" class="difflineplus">+      *aDecision == nsIContentPolicy::REJECT_REQUEST,</span>
<a href="#l7.748"></a><span id="l7.748" class="difflineplus">+      &quot;AllowContentForPotentialMessage expects default decision to be reject!&quot;);</span>
<a href="#l7.749"></a><span id="l7.749"> </span>
<a href="#l7.750"></a><span id="l7.750">   // Is it a mailnews url?</span>
<a href="#l7.751"></a><span id="l7.751">   nsresult rv;</span>
<a href="#l7.752"></a><span id="l7.752" class="difflineminus">-  nsCOMPtr&lt;nsIMsgMessageUrl&gt; msgUrl(do_QueryInterface(aOriginatorLocation,</span>
<a href="#l7.753"></a><span id="l7.753" class="difflineminus">-                                                      &amp;rv));</span>
<a href="#l7.754"></a><span id="l7.754" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l7.755"></a><span id="l7.755" class="difflineminus">-  {</span>
<a href="#l7.756"></a><span id="l7.756" class="difflineplus">+  nsCOMPtr&lt;nsIMsgMessageUrl&gt; msgUrl(</span>
<a href="#l7.757"></a><span id="l7.757" class="difflineplus">+      do_QueryInterface(aOriginatorLocation, &amp;rv));</span>
<a href="#l7.758"></a><span id="l7.758" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l7.759"></a><span id="l7.759">     // It isn't a mailnews url - so we accept the load here, and let other</span>
<a href="#l7.760"></a><span id="l7.760">     // content policies make the decision if we should be loading it or not.</span>
<a href="#l7.761"></a><span id="l7.761">     *aDecision = nsIContentPolicy::ACCEPT;</span>
<a href="#l7.762"></a><span id="l7.762">     return;</span>
<a href="#l7.763"></a><span id="l7.763">   }</span>
<a href="#l7.764"></a><span id="l7.764"> </span>
<a href="#l7.765"></a><span id="l7.765">   nsCString resourceURI;</span>
<a href="#l7.766"></a><span id="l7.766">   rv = msgUrl-&gt;GetUri(getter_Copies(resourceURI));</span>
<a href="#l7.767"></a><span id="l7.767">   NS_ENSURE_SUCCESS_VOID(rv);</span>
<a href="#l7.768"></a><span id="l7.768"> </span>
<a href="#l7.769"></a><span id="l7.769" class="difflineminus">-  nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsUrl(do_QueryInterface(aOriginatorLocation, &amp;rv));</span>
<a href="#l7.770"></a><span id="l7.770" class="difflineplus">+  nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsUrl(</span>
<a href="#l7.771"></a><span id="l7.771" class="difflineplus">+      do_QueryInterface(aOriginatorLocation, &amp;rv));</span>
<a href="#l7.772"></a><span id="l7.772">   NS_ENSURE_SUCCESS_VOID(rv);</span>
<a href="#l7.773"></a><span id="l7.773"> </span>
<a href="#l7.774"></a><span id="l7.774">   nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l7.775"></a><span id="l7.775">   rv = GetMsgDBHdrFromURI(resourceURI.get(), getter_AddRefs(msgHdr));</span>
<a href="#l7.776"></a><span id="l7.776" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l7.777"></a><span id="l7.777" class="difflineminus">-  {</span>
<a href="#l7.778"></a><span id="l7.778" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l7.779"></a><span id="l7.779">     // Maybe we can get a dummy header.</span>
<a href="#l7.780"></a><span id="l7.780">     nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow;</span>
<a href="#l7.781"></a><span id="l7.781">     rv = mailnewsUrl-&gt;GetMsgWindow(getter_AddRefs(msgWindow));</span>
<a href="#l7.782"></a><span id="l7.782" class="difflineminus">-    if (msgWindow)</span>
<a href="#l7.783"></a><span id="l7.783" class="difflineminus">-    {</span>
<a href="#l7.784"></a><span id="l7.784" class="difflineplus">+    if (msgWindow) {</span>
<a href="#l7.785"></a><span id="l7.785">       nsCOMPtr&lt;nsIMsgHeaderSink&gt; msgHdrSink;</span>
<a href="#l7.786"></a><span id="l7.786">       rv = msgWindow-&gt;GetMsgHeaderSink(getter_AddRefs(msgHdrSink));</span>
<a href="#l7.787"></a><span id="l7.787">       if (msgHdrSink)</span>
<a href="#l7.788"></a><span id="l7.788">         rv = msgHdrSink-&gt;GetDummyMsgHeader(getter_AddRefs(msgHdr));</span>
<a href="#l7.789"></a><span id="l7.789">     }</span>
<a href="#l7.790"></a><span id="l7.790">   }</span>
<a href="#l7.791"></a><span id="l7.791"> </span>
<a href="#l7.792"></a><span id="l7.792">   // Get a decision on whether or not to allow remote content for this message</span>
<a href="#l7.793"></a><span id="l7.793">   // header.</span>
<a href="#l7.794"></a><span id="l7.794">   *aDecision = ShouldAcceptRemoteContentForMsgHdr(msgHdr, aOriginatorLocation,</span>
<a href="#l7.795"></a><span id="l7.795">                                                   aContentLocation);</span>
<a href="#l7.796"></a><span id="l7.796"> </span>
<a href="#l7.797"></a><span id="l7.797">   // If we're not allowing the remote content, tell the nsIMsgWindow loading</span>
<a href="#l7.798"></a><span id="l7.798">   // this url that this is the case, so that the UI knows to show the remote</span>
<a href="#l7.799"></a><span id="l7.799">   // content header bar, so the user can override if they wish.</span>
<a href="#l7.800"></a><span id="l7.800" class="difflineminus">-  if (*aDecision == nsIContentPolicy::REJECT_REQUEST)</span>
<a href="#l7.801"></a><span id="l7.801" class="difflineminus">-  {</span>
<a href="#l7.802"></a><span id="l7.802" class="difflineplus">+  if (*aDecision == nsIContentPolicy::REJECT_REQUEST) {</span>
<a href="#l7.803"></a><span id="l7.803">     nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow;</span>
<a href="#l7.804"></a><span id="l7.804">     (void)mailnewsUrl-&gt;GetMsgWindow(getter_AddRefs(msgWindow));</span>
<a href="#l7.805"></a><span id="l7.805" class="difflineminus">-    if (msgWindow)</span>
<a href="#l7.806"></a><span id="l7.806" class="difflineminus">-    {</span>
<a href="#l7.807"></a><span id="l7.807" class="difflineplus">+    if (msgWindow) {</span>
<a href="#l7.808"></a><span id="l7.808">       nsCOMPtr&lt;nsIRunnable&gt; event =</span>
<a href="#l7.809"></a><span id="l7.809" class="difflineminus">-        new RemoteContentNotifierEvent(msgWindow, msgHdr, aContentLocation);</span>
<a href="#l7.810"></a><span id="l7.810" class="difflineplus">+          new RemoteContentNotifierEvent(msgWindow, msgHdr, aContentLocation);</span>
<a href="#l7.811"></a><span id="l7.811">       // Post this as an event because it can cause dom mutations, and we</span>
<a href="#l7.812"></a><span id="l7.812">       // get called at a bad time to be causing dom mutations.</span>
<a href="#l7.813"></a><span id="l7.813" class="difflineminus">-      if (event)</span>
<a href="#l7.814"></a><span id="l7.814" class="difflineminus">-        NS_DispatchToCurrentThread(event);</span>
<a href="#l7.815"></a><span id="l7.815" class="difflineplus">+      if (event) NS_DispatchToCurrentThread(event);</span>
<a href="#l7.816"></a><span id="l7.816">     }</span>
<a href="#l7.817"></a><span id="l7.817">   }</span>
<a href="#l7.818"></a><span id="l7.818"> }</span>
<a href="#l7.819"></a><span id="l7.819"> </span>
<a href="#l7.820"></a><span id="l7.820"> /**</span>
<a href="#l7.821"></a><span id="l7.821">  * Content policy logic for compose windows</span>
<a href="#l7.822"></a><span id="l7.822">  *</span>
<a href="#l7.823"></a><span id="l7.823">  */</span>
<a href="#l7.824"></a><span id="l7.824"> void nsMsgContentPolicy::ComposeShouldLoad(nsIMsgCompose *aMsgCompose,</span>
<a href="#l7.825"></a><span id="l7.825">                                            nsISupports *aRequestingContext,</span>
<a href="#l7.826"></a><span id="l7.826">                                            nsIURI *aContentLocation,</span>
<a href="#l7.827"></a><span id="l7.827" class="difflineminus">-                                           int16_t *aDecision)</span>
<a href="#l7.828"></a><span id="l7.828" class="difflineminus">-{</span>
<a href="#l7.829"></a><span id="l7.829" class="difflineplus">+                                           int16_t *aDecision) {</span>
<a href="#l7.830"></a><span id="l7.830">   NS_ASSERTION(*aDecision == nsIContentPolicy::REJECT_REQUEST,</span>
<a href="#l7.831"></a><span id="l7.831">                &quot;ComposeShouldLoad expects default decision to be reject!&quot;);</span>
<a href="#l7.832"></a><span id="l7.832"> </span>
<a href="#l7.833"></a><span id="l7.833">   nsCString originalMsgURI;</span>
<a href="#l7.834"></a><span id="l7.834">   nsresult rv = aMsgCompose-&gt;GetOriginalMsgURI(getter_Copies(originalMsgURI));</span>
<a href="#l7.835"></a><span id="l7.835">   NS_ENSURE_SUCCESS_VOID(rv);</span>
<a href="#l7.836"></a><span id="l7.836"> </span>
<a href="#l7.837"></a><span id="l7.837">   MSG_ComposeType composeType;</span>
<a href="#l7.838"></a><span id="l7.838">   rv = aMsgCompose-&gt;GetType(&amp;composeType);</span>
<a href="#l7.839"></a><span id="l7.839">   NS_ENSURE_SUCCESS_VOID(rv);</span>
<a href="#l7.840"></a><span id="l7.840"> </span>
<a href="#l7.841"></a><span id="l7.841">   // Only allow remote content for new mail compositions or mailto</span>
<a href="#l7.842"></a><span id="l7.842" class="difflineminus">-  // Block remote content for all other types (drafts, templates, forwards, replies, etc)</span>
<a href="#l7.843"></a><span id="l7.843" class="difflineminus">-  // unless there is an associated msgHdr which allows the load, or unless the image is being</span>
<a href="#l7.844"></a><span id="l7.844" class="difflineminus">-  // added by the user and not the quoted message content...</span>
<a href="#l7.845"></a><span id="l7.845" class="difflineplus">+  // Block remote content for all other types (drafts, templates, forwards,</span>
<a href="#l7.846"></a><span id="l7.846" class="difflineplus">+  // replies, etc) unless there is an associated msgHdr which allows the load,</span>
<a href="#l7.847"></a><span id="l7.847" class="difflineplus">+  // or unless the image is being added by the user and not the quoted message</span>
<a href="#l7.848"></a><span id="l7.848" class="difflineplus">+  // content...</span>
<a href="#l7.849"></a><span id="l7.849">   if (composeType == nsIMsgCompType::New ||</span>
<a href="#l7.850"></a><span id="l7.850">       composeType == nsIMsgCompType::MailToUrl)</span>
<a href="#l7.851"></a><span id="l7.851">     *aDecision = nsIContentPolicy::ACCEPT;</span>
<a href="#l7.852"></a><span id="l7.852" class="difflineminus">-  else if (!originalMsgURI.IsEmpty())</span>
<a href="#l7.853"></a><span id="l7.853" class="difflineminus">-  {</span>
<a href="#l7.854"></a><span id="l7.854" class="difflineplus">+  else if (!originalMsgURI.IsEmpty()) {</span>
<a href="#l7.855"></a><span id="l7.855">     nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l7.856"></a><span id="l7.856">     rv = GetMsgDBHdrFromURI(originalMsgURI.get(), getter_AddRefs(msgHdr));</span>
<a href="#l7.857"></a><span id="l7.857">     NS_ENSURE_SUCCESS_VOID(rv);</span>
<a href="#l7.858"></a><span id="l7.858" class="difflineminus">-    *aDecision = ShouldAcceptRemoteContentForMsgHdr(msgHdr, nullptr,</span>
<a href="#l7.859"></a><span id="l7.859" class="difflineminus">-                                                    aContentLocation);</span>
<a href="#l7.860"></a><span id="l7.860" class="difflineplus">+    *aDecision =</span>
<a href="#l7.861"></a><span id="l7.861" class="difflineplus">+        ShouldAcceptRemoteContentForMsgHdr(msgHdr, nullptr, aContentLocation);</span>
<a href="#l7.862"></a><span id="l7.862"> </span>
<a href="#l7.863"></a><span id="l7.863">     // Special case image elements. When replying to a message, we want to allow</span>
<a href="#l7.864"></a><span id="l7.864">     // the user to add remote images to the message. But we don't want remote</span>
<a href="#l7.865"></a><span id="l7.865">     // images that are a part of the quoted content to load. Hence we block them</span>
<a href="#l7.866"></a><span id="l7.866">     // while the reply is created (insertingQuotedContent==true), but allow them</span>
<a href="#l7.867"></a><span id="l7.867">     // later when the user inserts them.</span>
<a href="#l7.868"></a><span id="l7.868" class="difflineminus">-    if (*aDecision == nsIContentPolicy::REJECT_REQUEST)</span>
<a href="#l7.869"></a><span id="l7.869" class="difflineminus">-    {</span>
<a href="#l7.870"></a><span id="l7.870" class="difflineplus">+    if (*aDecision == nsIContentPolicy::REJECT_REQUEST) {</span>
<a href="#l7.871"></a><span id="l7.871">       bool insertingQuotedContent = true;</span>
<a href="#l7.872"></a><span id="l7.872">       aMsgCompose-&gt;GetInsertingQuotedContent(&amp;insertingQuotedContent);</span>
<a href="#l7.873"></a><span id="l7.873">       nsCOMPtr&lt;Element&gt; element = do_QueryInterface(aRequestingContext);</span>
<a href="#l7.874"></a><span id="l7.874">       RefPtr&lt;mozilla::dom::HTMLImageElement&gt; image =</span>
<a href="#l7.875"></a><span id="l7.875" class="difflineminus">-        mozilla::dom::HTMLImageElement::FromNodeOrNull(element);</span>
<a href="#l7.876"></a><span id="l7.876" class="difflineminus">-      if (image)</span>
<a href="#l7.877"></a><span id="l7.877" class="difflineminus">-      {</span>
<a href="#l7.878"></a><span id="l7.878" class="difflineminus">-        if (!insertingQuotedContent)</span>
<a href="#l7.879"></a><span id="l7.879" class="difflineminus">-        {</span>
<a href="#l7.880"></a><span id="l7.880" class="difflineplus">+          mozilla::dom::HTMLImageElement::FromNodeOrNull(element);</span>
<a href="#l7.881"></a><span id="l7.881" class="difflineplus">+      if (image) {</span>
<a href="#l7.882"></a><span id="l7.882" class="difflineplus">+        if (!insertingQuotedContent) {</span>
<a href="#l7.883"></a><span id="l7.883">           *aDecision = nsIContentPolicy::ACCEPT;</span>
<a href="#l7.884"></a><span id="l7.884">           return;</span>
<a href="#l7.885"></a><span id="l7.885">         }</span>
<a href="#l7.886"></a><span id="l7.886"> </span>
<a href="#l7.887"></a><span id="l7.887">         // Test whitelist.</span>
<a href="#l7.888"></a><span id="l7.888">         uint32_t permission;</span>
<a href="#l7.889"></a><span id="l7.889" class="difflineminus">-        mPermissionManager-&gt;TestPermission(aContentLocation, NS_LITERAL_CSTRING(&quot;image&quot;), &amp;permission);</span>
<a href="#l7.890"></a><span id="l7.890" class="difflineplus">+        mPermissionManager-&gt;TestPermission(</span>
<a href="#l7.891"></a><span id="l7.891" class="difflineplus">+            aContentLocation, NS_LITERAL_CSTRING(&quot;image&quot;), &amp;permission);</span>
<a href="#l7.892"></a><span id="l7.892">         if (permission == nsIPermissionManager::ALLOW_ACTION)</span>
<a href="#l7.893"></a><span id="l7.893">           *aDecision = nsIContentPolicy::ACCEPT;</span>
<a href="#l7.894"></a><span id="l7.894">       }</span>
<a href="#l7.895"></a><span id="l7.895">     }</span>
<a href="#l7.896"></a><span id="l7.896">   }</span>
<a href="#l7.897"></a><span id="l7.897"> }</span>
<a href="#l7.898"></a><span id="l7.898"> </span>
<a href="#l7.899"></a><span id="l7.899" class="difflineminus">-already_AddRefed&lt;nsIMsgCompose&gt; nsMsgContentPolicy::GetMsgComposeForContext(nsISupports *aRequestingContext)</span>
<a href="#l7.900"></a><span id="l7.900" class="difflineminus">-{</span>
<a href="#l7.901"></a><span id="l7.901" class="difflineplus">+already_AddRefed&lt;nsIMsgCompose&gt; nsMsgContentPolicy::GetMsgComposeForContext(</span>
<a href="#l7.902"></a><span id="l7.902" class="difflineplus">+    nsISupports *aRequestingContext) {</span>
<a href="#l7.903"></a><span id="l7.903">   nsresult rv;</span>
<a href="#l7.904"></a><span id="l7.904"> </span>
<a href="#l7.905"></a><span id="l7.905">   nsIDocShell *shell = NS_CP_GetDocShellFromContext(aRequestingContext);</span>
<a href="#l7.906"></a><span id="l7.906" class="difflineminus">-  if (!shell)</span>
<a href="#l7.907"></a><span id="l7.907" class="difflineminus">-    return nullptr;</span>
<a href="#l7.908"></a><span id="l7.908" class="difflineplus">+  if (!shell) return nullptr;</span>
<a href="#l7.909"></a><span id="l7.909">   nsCOMPtr&lt;nsIDocShellTreeItem&gt; docShellTreeItem(shell);</span>
<a href="#l7.910"></a><span id="l7.910"> </span>
<a href="#l7.911"></a><span id="l7.911">   nsCOMPtr&lt;nsIDocShellTreeItem&gt; rootItem;</span>
<a href="#l7.912"></a><span id="l7.912">   rv = docShellTreeItem-&gt;GetSameTypeRootTreeItem(getter_AddRefs(rootItem));</span>
<a href="#l7.913"></a><span id="l7.913">   NS_ENSURE_SUCCESS(rv, nullptr);</span>
<a href="#l7.914"></a><span id="l7.914"> </span>
<a href="#l7.915"></a><span id="l7.915">   nsCOMPtr&lt;nsIDocShell&gt; docShell(do_QueryInterface(rootItem, &amp;rv));</span>
<a href="#l7.916"></a><span id="l7.916">   NS_ENSURE_SUCCESS(rv, nullptr);</span>
<a href="#l7.917"></a><span id="l7.917"> </span>
<a href="#l7.918"></a><span id="l7.918" class="difflineminus">-  nsCOMPtr&lt;nsIMsgComposeService&gt; composeService(do_GetService(NS_MSGCOMPOSESERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l7.919"></a><span id="l7.919" class="difflineplus">+  nsCOMPtr&lt;nsIMsgComposeService&gt; composeService(</span>
<a href="#l7.920"></a><span id="l7.920" class="difflineplus">+      do_GetService(NS_MSGCOMPOSESERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l7.921"></a><span id="l7.921">   NS_ENSURE_SUCCESS(rv, nullptr);</span>
<a href="#l7.922"></a><span id="l7.922"> </span>
<a href="#l7.923"></a><span id="l7.923">   nsCOMPtr&lt;nsIMsgCompose&gt; msgCompose;</span>
<a href="#l7.924"></a><span id="l7.924" class="difflineminus">-  // Don't bother checking rv, as GetMsgComposeForDocShell returns NS_ERROR_FAILURE</span>
<a href="#l7.925"></a><span id="l7.925" class="difflineminus">-  // for not found.</span>
<a href="#l7.926"></a><span id="l7.926" class="difflineplus">+  // Don't bother checking rv, as GetMsgComposeForDocShell returns</span>
<a href="#l7.927"></a><span id="l7.927" class="difflineplus">+  // NS_ERROR_FAILURE for not found.</span>
<a href="#l7.928"></a><span id="l7.928">   composeService-&gt;GetMsgComposeForDocShell(docShell,</span>
<a href="#l7.929"></a><span id="l7.929">                                            getter_AddRefs(msgCompose));</span>
<a href="#l7.930"></a><span id="l7.930">   return msgCompose.forget();</span>
<a href="#l7.931"></a><span id="l7.931"> }</span>
<a href="#l7.932"></a><span id="l7.932"> </span>
<a href="#l7.933"></a><span id="l7.933"> nsresult nsMsgContentPolicy::SetDisableItemsOnMailNewsUrlDocshells(</span>
<a href="#l7.934"></a><span id="l7.934" class="difflineminus">-  nsIURI *aContentLocation, nsISupports *aRequestingContext)</span>
<a href="#l7.935"></a><span id="l7.935" class="difflineminus">-{</span>
<a href="#l7.936"></a><span id="l7.936" class="difflineplus">+    nsIURI *aContentLocation, nsISupports *aRequestingContext) {</span>
<a href="#l7.937"></a><span id="l7.937">   // XXX if this class changes so that this method can be called from</span>
<a href="#l7.938"></a><span id="l7.938">   // ShouldProcess, and if it's possible for this to be null when called from</span>
<a href="#l7.939"></a><span id="l7.939">   // ShouldLoad, but not in the corresponding ShouldProcess call,</span>
<a href="#l7.940"></a><span id="l7.940">   // we need to re-think the assumptions underlying this code.</span>
<a href="#l7.941"></a><span id="l7.941"> </span>
<a href="#l7.942"></a><span id="l7.942">   // If there's no docshell to get to, there's nowhere for the JavaScript to</span>
<a href="#l7.943"></a><span id="l7.943">   // run, so we're already safe and don't need to disable anything.</span>
<a href="#l7.944"></a><span id="l7.944">   if (!aRequestingContext) {</span>
<a href="#l7.945"></a><span id="l7.945" class="difflineat">@@ -832,17 +779,18 @@ nsresult nsMsgContentPolicy::SetDisableI</span>
<a href="#l7.946"></a><span id="l7.946">   // since NS_CP_GetDocShellFromContext returns the containing docshell rather</span>
<a href="#l7.947"></a><span id="l7.947">   // than the contained one we need, we can't use that here, so...</span>
<a href="#l7.948"></a><span id="l7.948">   RefPtr&lt;nsFrameLoaderOwner&gt; flOwner = do_QueryObject(aRequestingContext);</span>
<a href="#l7.949"></a><span id="l7.949">   NS_ENSURE_TRUE(flOwner, NS_ERROR_INVALID_POINTER);</span>
<a href="#l7.950"></a><span id="l7.950"> </span>
<a href="#l7.951"></a><span id="l7.951">   RefPtr&lt;nsFrameLoader&gt; frameLoader = flOwner-&gt;GetFrameLoader();</span>
<a href="#l7.952"></a><span id="l7.952">   NS_ENSURE_TRUE(frameLoader, NS_ERROR_INVALID_POINTER);</span>
<a href="#l7.953"></a><span id="l7.953"> </span>
<a href="#l7.954"></a><span id="l7.954" class="difflineminus">-  nsCOMPtr&lt;nsIDocShell&gt; docShell = frameLoader-&gt;GetDocShell(mozilla::IgnoreErrors());</span>
<a href="#l7.955"></a><span id="l7.955" class="difflineplus">+  nsCOMPtr&lt;nsIDocShell&gt; docShell =</span>
<a href="#l7.956"></a><span id="l7.956" class="difflineplus">+      frameLoader-&gt;GetDocShell(mozilla::IgnoreErrors());</span>
<a href="#l7.957"></a><span id="l7.957">   NS_ENSURE_TRUE(docShell, NS_ERROR_INVALID_POINTER);</span>
<a href="#l7.958"></a><span id="l7.958"> </span>
<a href="#l7.959"></a><span id="l7.959">   nsCOMPtr&lt;nsIDocShellTreeItem&gt; docshellTreeItem(docShell);</span>
<a href="#l7.960"></a><span id="l7.960"> </span>
<a href="#l7.961"></a><span id="l7.961">   // what sort of docshell is this?</span>
<a href="#l7.962"></a><span id="l7.962">   int32_t itemType;</span>
<a href="#l7.963"></a><span id="l7.963">   rv = docshellTreeItem-&gt;GetItemType(&amp;itemType);</span>
<a href="#l7.964"></a><span id="l7.964">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.965"></a><span id="l7.965" class="difflineat">@@ -860,38 +808,35 @@ nsresult nsMsgContentPolicy::SetDisableI</span>
<a href="#l7.966"></a><span id="l7.966">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.967"></a><span id="l7.967"> </span>
<a href="#l7.968"></a><span id="l7.968">     uint32_t sandboxFlags;</span>
<a href="#l7.969"></a><span id="l7.969">     rv = docShell-&gt;GetSandboxFlags(&amp;sandboxFlags);</span>
<a href="#l7.970"></a><span id="l7.970">     sandboxFlags |= SANDBOXED_FORMS;</span>
<a href="#l7.971"></a><span id="l7.971">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.972"></a><span id="l7.972">     rv = docShell-&gt;SetSandboxFlags(sandboxFlags);</span>
<a href="#l7.973"></a><span id="l7.973">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.974"></a><span id="l7.974" class="difflineminus">-  }</span>
<a href="#l7.975"></a><span id="l7.975" class="difflineminus">-  else {</span>
<a href="#l7.976"></a><span id="l7.976" class="difflineplus">+  } else {</span>
<a href="#l7.977"></a><span id="l7.977">     // JavaScript is allowed on non-message URLs.</span>
<a href="#l7.978"></a><span id="l7.978">     rv = docShell-&gt;SetAllowJavascript(true);</span>
<a href="#l7.979"></a><span id="l7.979">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.980"></a><span id="l7.980">     rv = docShell-&gt;SetAllowContentRetargetingOnChildren(true);</span>
<a href="#l7.981"></a><span id="l7.981">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.982"></a><span id="l7.982">   }</span>
<a href="#l7.983"></a><span id="l7.983"> </span>
<a href="#l7.984"></a><span id="l7.984">   rv = docShell-&gt;SetAllowPlugins(false);</span>
<a href="#l7.985"></a><span id="l7.985">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.986"></a><span id="l7.986"> </span>
<a href="#l7.987"></a><span id="l7.987">   return NS_OK;</span>
<a href="#l7.988"></a><span id="l7.988"> }</span>
<a href="#l7.989"></a><span id="l7.989"> </span>
<a href="#l7.990"></a><span id="l7.990"> /**</span>
<a href="#l7.991"></a><span id="l7.991">  * Gets the root docshell from a requesting context.</span>
<a href="#l7.992"></a><span id="l7.992">  */</span>
<a href="#l7.993"></a><span id="l7.993" class="difflineminus">-nsresult</span>
<a href="#l7.994"></a><span id="l7.994" class="difflineminus">-nsMsgContentPolicy::GetRootDocShellForContext(nsISupports *aRequestingContext,</span>
<a href="#l7.995"></a><span id="l7.995" class="difflineminus">-                                              nsIDocShell **aDocShell)</span>
<a href="#l7.996"></a><span id="l7.996" class="difflineminus">-{</span>
<a href="#l7.997"></a><span id="l7.997" class="difflineplus">+nsresult nsMsgContentPolicy::GetRootDocShellForContext(</span>
<a href="#l7.998"></a><span id="l7.998" class="difflineplus">+    nsISupports *aRequestingContext, nsIDocShell **aDocShell) {</span>
<a href="#l7.999"></a><span id="l7.999">   NS_ENSURE_ARG_POINTER(aRequestingContext);</span>
<a href="#l7.1000"></a><span id="l7.1000">   nsresult rv;</span>
<a href="#l7.1001"></a><span id="l7.1001"> </span>
<a href="#l7.1002"></a><span id="l7.1002">   nsIDocShell *shell = NS_CP_GetDocShellFromContext(aRequestingContext);</span>
<a href="#l7.1003"></a><span id="l7.1003">   NS_ENSURE_TRUE(shell, NS_ERROR_NULL_POINTER);</span>
<a href="#l7.1004"></a><span id="l7.1004">   nsCOMPtr&lt;nsIDocShellTreeItem&gt; docshellTreeItem(shell);</span>
<a href="#l7.1005"></a><span id="l7.1005"> </span>
<a href="#l7.1006"></a><span id="l7.1006">   nsCOMPtr&lt;nsIDocShellTreeItem&gt; rootItem;</span>
<a href="#l7.1007"></a><span id="l7.1007" class="difflineat">@@ -904,20 +849,18 @@ nsMsgContentPolicy::GetRootDocShellForCo</span>
<a href="#l7.1008"></a><span id="l7.1008"> /**</span>
<a href="#l7.1009"></a><span id="l7.1009">  * Gets the originating URI that started off a set of requests, accounting</span>
<a href="#l7.1010"></a><span id="l7.1010">  * for multiple iframes.</span>
<a href="#l7.1011"></a><span id="l7.1011">  *</span>
<a href="#l7.1012"></a><span id="l7.1012">  * Navigates up the docshell tree from aRequestingContext and finds the</span>
<a href="#l7.1013"></a><span id="l7.1013">  * highest parent with the same type docshell as aRequestingContext, then</span>
<a href="#l7.1014"></a><span id="l7.1014">  * returns the URI associated with that docshell.</span>
<a href="#l7.1015"></a><span id="l7.1015">  */</span>
<a href="#l7.1016"></a><span id="l7.1016" class="difflineminus">-nsresult</span>
<a href="#l7.1017"></a><span id="l7.1017" class="difflineminus">-nsMsgContentPolicy::GetOriginatingURIForContext(nsISupports *aRequestingContext,</span>
<a href="#l7.1018"></a><span id="l7.1018" class="difflineminus">-                                                nsIURI **aURI)</span>
<a href="#l7.1019"></a><span id="l7.1019" class="difflineminus">-{</span>
<a href="#l7.1020"></a><span id="l7.1020" class="difflineplus">+nsresult nsMsgContentPolicy::GetOriginatingURIForContext(</span>
<a href="#l7.1021"></a><span id="l7.1021" class="difflineplus">+    nsISupports *aRequestingContext, nsIURI **aURI) {</span>
<a href="#l7.1022"></a><span id="l7.1022">   NS_ENSURE_ARG_POINTER(aRequestingContext);</span>
<a href="#l7.1023"></a><span id="l7.1023">   nsresult rv;</span>
<a href="#l7.1024"></a><span id="l7.1024"> </span>
<a href="#l7.1025"></a><span id="l7.1025">   nsIDocShell *shell = NS_CP_GetDocShellFromContext(aRequestingContext);</span>
<a href="#l7.1026"></a><span id="l7.1026">   if (!shell) {</span>
<a href="#l7.1027"></a><span id="l7.1027">     *aURI = nullptr;</span>
<a href="#l7.1028"></a><span id="l7.1028">     return NS_OK;</span>
<a href="#l7.1029"></a><span id="l7.1029">   }</span>
<a href="#l7.1030"></a><span id="l7.1030" class="difflineat">@@ -929,34 +872,33 @@ nsMsgContentPolicy::GetOriginatingURIFor</span>
<a href="#l7.1031"></a><span id="l7.1031"> </span>
<a href="#l7.1032"></a><span id="l7.1032">   nsCOMPtr&lt;nsIWebNavigation&gt; webNavigation(do_QueryInterface(rootItem, &amp;rv));</span>
<a href="#l7.1033"></a><span id="l7.1033">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.1034"></a><span id="l7.1034"> </span>
<a href="#l7.1035"></a><span id="l7.1035">   return webNavigation-&gt;GetCurrentURI(aURI);</span>
<a href="#l7.1036"></a><span id="l7.1036"> }</span>
<a href="#l7.1037"></a><span id="l7.1037"> </span>
<a href="#l7.1038"></a><span id="l7.1038"> NS_IMETHODIMP</span>
<a href="#l7.1039"></a><span id="l7.1039" class="difflineminus">-nsMsgContentPolicy::ShouldProcess(nsIURI           *aContentLocation,</span>
<a href="#l7.1040"></a><span id="l7.1040" class="difflineminus">-                                  nsILoadInfo      *aLoadInfo,</span>
<a href="#l7.1041"></a><span id="l7.1041" class="difflineplus">+nsMsgContentPolicy::ShouldProcess(nsIURI *aContentLocation,</span>
<a href="#l7.1042"></a><span id="l7.1042" class="difflineplus">+                                  nsILoadInfo *aLoadInfo,</span>
<a href="#l7.1043"></a><span id="l7.1043">                                   const nsACString &amp;aMimeGuess,</span>
<a href="#l7.1044"></a><span id="l7.1044" class="difflineminus">-                                  int16_t          *aDecision)</span>
<a href="#l7.1045"></a><span id="l7.1045" class="difflineminus">-{</span>
<a href="#l7.1046"></a><span id="l7.1046" class="difflineplus">+                                  int16_t *aDecision) {</span>
<a href="#l7.1047"></a><span id="l7.1047">   // XXX Returning ACCEPT is presumably only a reasonable thing to do if we</span>
<a href="#l7.1048"></a><span id="l7.1048">   // think that ShouldLoad is going to catch all possible cases (i.e. that</span>
<a href="#l7.1049"></a><span id="l7.1049">   // everything we use to make decisions is going to be available at</span>
<a href="#l7.1050"></a><span id="l7.1050">   // ShouldLoad time, and not only become available in time for ShouldProcess).</span>
<a href="#l7.1051"></a><span id="l7.1051">   // Do we think that's actually the case?</span>
<a href="#l7.1052"></a><span id="l7.1052">   *aDecision = nsIContentPolicy::ACCEPT;</span>
<a href="#l7.1053"></a><span id="l7.1053">   return NS_OK;</span>
<a href="#l7.1054"></a><span id="l7.1054"> }</span>
<a href="#l7.1055"></a><span id="l7.1055"> </span>
<a href="#l7.1056"></a><span id="l7.1056" class="difflineminus">-NS_IMETHODIMP nsMsgContentPolicy::Observe(nsISupports *aSubject, const char *aTopic, const char16_t *aData)</span>
<a href="#l7.1057"></a><span id="l7.1057" class="difflineminus">-{</span>
<a href="#l7.1058"></a><span id="l7.1058" class="difflineminus">-  if (!strcmp(NS_PREFBRANCH_PREFCHANGE_TOPIC_ID, aTopic))</span>
<a href="#l7.1059"></a><span id="l7.1059" class="difflineminus">-  {</span>
<a href="#l7.1060"></a><span id="l7.1060" class="difflineplus">+NS_IMETHODIMP nsMsgContentPolicy::Observe(nsISupports *aSubject,</span>
<a href="#l7.1061"></a><span id="l7.1061" class="difflineplus">+                                          const char *aTopic,</span>
<a href="#l7.1062"></a><span id="l7.1062" class="difflineplus">+                                          const char16_t *aData) {</span>
<a href="#l7.1063"></a><span id="l7.1063" class="difflineplus">+  if (!strcmp(NS_PREFBRANCH_PREFCHANGE_TOPIC_ID, aTopic)) {</span>
<a href="#l7.1064"></a><span id="l7.1064">     NS_LossyConvertUTF16toASCII pref(aData);</span>
<a href="#l7.1065"></a><span id="l7.1065"> </span>
<a href="#l7.1066"></a><span id="l7.1066">     nsresult rv;</span>
<a href="#l7.1067"></a><span id="l7.1067"> </span>
<a href="#l7.1068"></a><span id="l7.1068">     nsCOMPtr&lt;nsIPrefBranch&gt; prefBranchInt = do_QueryInterface(aSubject, &amp;rv);</span>
<a href="#l7.1069"></a><span id="l7.1069">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.1070"></a><span id="l7.1070"> </span>
<a href="#l7.1071"></a><span id="l7.1071">     if (pref.Equals(kBlockRemoteImages))</span>
<a href="#l7.1072"></a><span id="l7.1072" class="difflineat">@@ -968,37 +910,34 @@ NS_IMETHODIMP nsMsgContentPolicy::Observ</span>
<a href="#l7.1073"></a><span id="l7.1073"> </span>
<a href="#l7.1074"></a><span id="l7.1074"> /**</span>
<a href="#l7.1075"></a><span id="l7.1075">  * We implement the nsIWebProgressListener interface in order to enforce</span>
<a href="#l7.1076"></a><span id="l7.1076">  * settings at onLocationChange time.</span>
<a href="#l7.1077"></a><span id="l7.1077">  */</span>
<a href="#l7.1078"></a><span id="l7.1078"> NS_IMETHODIMP</span>
<a href="#l7.1079"></a><span id="l7.1079"> nsMsgContentPolicy::OnStateChange(nsIWebProgress *aWebProgress,</span>
<a href="#l7.1080"></a><span id="l7.1080">                                   nsIRequest *aRequest, uint32_t aStateFlags,</span>
<a href="#l7.1081"></a><span id="l7.1081" class="difflineminus">-                                  nsresult aStatus)</span>
<a href="#l7.1082"></a><span id="l7.1082" class="difflineminus">-{</span>
<a href="#l7.1083"></a><span id="l7.1083" class="difflineplus">+                                  nsresult aStatus) {</span>
<a href="#l7.1084"></a><span id="l7.1084">   return NS_OK;</span>
<a href="#l7.1085"></a><span id="l7.1085"> }</span>
<a href="#l7.1086"></a><span id="l7.1086"> </span>
<a href="#l7.1087"></a><span id="l7.1087"> NS_IMETHODIMP</span>
<a href="#l7.1088"></a><span id="l7.1088"> nsMsgContentPolicy::OnProgressChange(nsIWebProgress *aWebProgress,</span>
<a href="#l7.1089"></a><span id="l7.1089">                                      nsIRequest *aRequest,</span>
<a href="#l7.1090"></a><span id="l7.1090">                                      int32_t aCurSelfProgress,</span>
<a href="#l7.1091"></a><span id="l7.1091">                                      int32_t aMaxSelfProgress,</span>
<a href="#l7.1092"></a><span id="l7.1092">                                      int32_t aCurTotalProgress,</span>
<a href="#l7.1093"></a><span id="l7.1093" class="difflineminus">-                                     int32_t aMaxTotalProgress)</span>
<a href="#l7.1094"></a><span id="l7.1094" class="difflineminus">-{</span>
<a href="#l7.1095"></a><span id="l7.1095" class="difflineplus">+                                     int32_t aMaxTotalProgress) {</span>
<a href="#l7.1096"></a><span id="l7.1096">   return NS_OK;</span>
<a href="#l7.1097"></a><span id="l7.1097"> }</span>
<a href="#l7.1098"></a><span id="l7.1098"> </span>
<a href="#l7.1099"></a><span id="l7.1099"> NS_IMETHODIMP</span>
<a href="#l7.1100"></a><span id="l7.1100"> nsMsgContentPolicy::OnLocationChange(nsIWebProgress *aWebProgress,</span>
<a href="#l7.1101"></a><span id="l7.1101">                                      nsIRequest *aRequest, nsIURI *aLocation,</span>
<a href="#l7.1102"></a><span id="l7.1102" class="difflineminus">-                                     uint32_t aFlags)</span>
<a href="#l7.1103"></a><span id="l7.1103" class="difflineminus">-{</span>
<a href="#l7.1104"></a><span id="l7.1104" class="difflineplus">+                                     uint32_t aFlags) {</span>
<a href="#l7.1105"></a><span id="l7.1105">   nsresult rv;</span>
<a href="#l7.1106"></a><span id="l7.1106"> </span>
<a href="#l7.1107"></a><span id="l7.1107">   // If anything goes wrong and/or there's no docshell associated with this</span>
<a href="#l7.1108"></a><span id="l7.1108">   // request, just give up.  The behavior ends up being &quot;don't consider</span>
<a href="#l7.1109"></a><span id="l7.1109">   // re-enabling JS on the docshell&quot;, which is the safe thing to do (and if</span>
<a href="#l7.1110"></a><span id="l7.1110">   // the problem was that there's no docshell, that means that there was</span>
<a href="#l7.1111"></a><span id="l7.1111">   // nowhere for any JavaScript to run, so we're already safe</span>
<a href="#l7.1112"></a><span id="l7.1112"> </span>
<a href="#l7.1113"></a><span id="l7.1113" class="difflineat">@@ -1007,80 +946,73 @@ nsMsgContentPolicy::OnLocationChange(nsI</span>
<a href="#l7.1114"></a><span id="l7.1114">     return NS_OK;</span>
<a href="#l7.1115"></a><span id="l7.1115">   }</span>
<a href="#l7.1116"></a><span id="l7.1116"> </span>
<a href="#l7.1117"></a><span id="l7.1117"> #ifdef DEBUG</span>
<a href="#l7.1118"></a><span id="l7.1118">   nsCOMPtr&lt;nsIChannel&gt; channel = do_QueryInterface(aRequest, &amp;rv);</span>
<a href="#l7.1119"></a><span id="l7.1119">   if (NS_SUCCEEDED(rv)) {</span>
<a href="#l7.1120"></a><span id="l7.1120">     nsCOMPtr&lt;nsIDocShell&gt; docShell2;</span>
<a href="#l7.1121"></a><span id="l7.1121">     NS_QueryNotificationCallbacks(channel, docShell2);</span>
<a href="#l7.1122"></a><span id="l7.1122" class="difflineminus">-    NS_ASSERTION(docShell == docShell2, &quot;aWebProgress and channel callbacks&quot;</span>
<a href="#l7.1123"></a><span id="l7.1123" class="difflineminus">-                                        &quot; do not point to the same docshell&quot;);</span>
<a href="#l7.1124"></a><span id="l7.1124" class="difflineplus">+    NS_ASSERTION(docShell == docShell2,</span>
<a href="#l7.1125"></a><span id="l7.1125" class="difflineplus">+                 &quot;aWebProgress and channel callbacks&quot;</span>
<a href="#l7.1126"></a><span id="l7.1126" class="difflineplus">+                 &quot; do not point to the same docshell&quot;);</span>
<a href="#l7.1127"></a><span id="l7.1127">   }</span>
<a href="#l7.1128"></a><span id="l7.1128"> #endif</span>
<a href="#l7.1129"></a><span id="l7.1129"> </span>
<a href="#l7.1130"></a><span id="l7.1130">   nsCOMPtr&lt;nsIMsgMessageUrl&gt; messageUrl = do_QueryInterface(aLocation, &amp;rv);</span>
<a href="#l7.1131"></a><span id="l7.1131">   mozilla::Unused &lt;&lt; messageUrl;</span>
<a href="#l7.1132"></a><span id="l7.1132">   if (NS_SUCCEEDED(rv)) {</span>
<a href="#l7.1133"></a><span id="l7.1133">     // Disable javascript on message URLs.</span>
<a href="#l7.1134"></a><span id="l7.1134">     rv = docShell-&gt;SetAllowJavascript(false);</span>
<a href="#l7.1135"></a><span id="l7.1135">     NS_ASSERTION(NS_SUCCEEDED(rv),</span>
<a href="#l7.1136"></a><span id="l7.1136">                  &quot;Failed to set javascript disabled on docShell&quot;);</span>
<a href="#l7.1137"></a><span id="l7.1137" class="difflineminus">-  }</span>
<a href="#l7.1138"></a><span id="l7.1138" class="difflineminus">-  else {</span>
<a href="#l7.1139"></a><span id="l7.1139" class="difflineplus">+  } else {</span>
<a href="#l7.1140"></a><span id="l7.1140">     // Javascript is allowed on non-message URLs. Plugins are not.</span>
<a href="#l7.1141"></a><span id="l7.1141">     rv = docShell-&gt;SetAllowJavascript(true);</span>
<a href="#l7.1142"></a><span id="l7.1142">     NS_ASSERTION(NS_SUCCEEDED(rv),</span>
<a href="#l7.1143"></a><span id="l7.1143">                  &quot;Failed to set javascript allowed on docShell&quot;);</span>
<a href="#l7.1144"></a><span id="l7.1144">   }</span>
<a href="#l7.1145"></a><span id="l7.1145"> </span>
<a href="#l7.1146"></a><span id="l7.1146">   rv = docShell-&gt;SetAllowPlugins(false);</span>
<a href="#l7.1147"></a><span id="l7.1147" class="difflineminus">-  NS_ASSERTION(NS_SUCCEEDED(rv),</span>
<a href="#l7.1148"></a><span id="l7.1148" class="difflineminus">-               &quot;Failed to set plugins disabled on docShell&quot;);</span>
<a href="#l7.1149"></a><span id="l7.1149" class="difflineplus">+  NS_ASSERTION(NS_SUCCEEDED(rv), &quot;Failed to set plugins disabled on docShell&quot;);</span>
<a href="#l7.1150"></a><span id="l7.1150"> </span>
<a href="#l7.1151"></a><span id="l7.1151">   return NS_OK;</span>
<a href="#l7.1152"></a><span id="l7.1152"> }</span>
<a href="#l7.1153"></a><span id="l7.1153"> </span>
<a href="#l7.1154"></a><span id="l7.1154"> NS_IMETHODIMP</span>
<a href="#l7.1155"></a><span id="l7.1155"> nsMsgContentPolicy::OnStatusChange(nsIWebProgress *aWebProgress,</span>
<a href="#l7.1156"></a><span id="l7.1156">                                    nsIRequest *aRequest, nsresult aStatus,</span>
<a href="#l7.1157"></a><span id="l7.1157" class="difflineminus">-                                   const char16_t *aMessage)</span>
<a href="#l7.1158"></a><span id="l7.1158" class="difflineminus">-{</span>
<a href="#l7.1159"></a><span id="l7.1159" class="difflineplus">+                                   const char16_t *aMessage) {</span>
<a href="#l7.1160"></a><span id="l7.1160">   return NS_OK;</span>
<a href="#l7.1161"></a><span id="l7.1161"> }</span>
<a href="#l7.1162"></a><span id="l7.1162"> </span>
<a href="#l7.1163"></a><span id="l7.1163"> NS_IMETHODIMP</span>
<a href="#l7.1164"></a><span id="l7.1164"> nsMsgContentPolicy::OnSecurityChange(nsIWebProgress *aWebProgress,</span>
<a href="#l7.1165"></a><span id="l7.1165" class="difflineminus">-                                     nsIRequest *aRequest, uint32_t aState)</span>
<a href="#l7.1166"></a><span id="l7.1166" class="difflineminus">-{</span>
<a href="#l7.1167"></a><span id="l7.1167" class="difflineplus">+                                     nsIRequest *aRequest, uint32_t aState) {</span>
<a href="#l7.1168"></a><span id="l7.1168">   return NS_OK;</span>
<a href="#l7.1169"></a><span id="l7.1169"> }</span>
<a href="#l7.1170"></a><span id="l7.1170"> </span>
<a href="#l7.1171"></a><span id="l7.1171"> NS_IMETHODIMP</span>
<a href="#l7.1172"></a><span id="l7.1172"> nsMsgContentPolicy::OnContentBlockingEvent(nsIWebProgress *aWebProgress,</span>
<a href="#l7.1173"></a><span id="l7.1173" class="difflineminus">-                                           nsIRequest *aRequest, uint32_t aEvent)</span>
<a href="#l7.1174"></a><span id="l7.1174" class="difflineminus">-{</span>
<a href="#l7.1175"></a><span id="l7.1175" class="difflineplus">+                                           nsIRequest *aRequest,</span>
<a href="#l7.1176"></a><span id="l7.1176" class="difflineplus">+                                           uint32_t aEvent) {</span>
<a href="#l7.1177"></a><span id="l7.1177">   return NS_OK;</span>
<a href="#l7.1178"></a><span id="l7.1178"> }</span>
<a href="#l7.1179"></a><span id="l7.1179"> </span>
<a href="#l7.1180"></a><span id="l7.1180"> /**</span>
<a href="#l7.1181"></a><span id="l7.1181">  * Implementation of nsIMsgContentPolicy</span>
<a href="#l7.1182"></a><span id="l7.1182">  *</span>
<a href="#l7.1183"></a><span id="l7.1183">  */</span>
<a href="#l7.1184"></a><span id="l7.1184"> NS_IMETHODIMP</span>
<a href="#l7.1185"></a><span id="l7.1185" class="difflineminus">-nsMsgContentPolicy::AddExposedProtocol(const nsACString &amp;aScheme)</span>
<a href="#l7.1186"></a><span id="l7.1186" class="difflineminus">-{</span>
<a href="#l7.1187"></a><span id="l7.1187" class="difflineminus">-  if (mCustomExposedProtocols.Contains(nsCString(aScheme)))</span>
<a href="#l7.1188"></a><span id="l7.1188" class="difflineminus">-    return NS_OK;</span>
<a href="#l7.1189"></a><span id="l7.1189" class="difflineplus">+nsMsgContentPolicy::AddExposedProtocol(const nsACString &amp;aScheme) {</span>
<a href="#l7.1190"></a><span id="l7.1190" class="difflineplus">+  if (mCustomExposedProtocols.Contains(nsCString(aScheme))) return NS_OK;</span>
<a href="#l7.1191"></a><span id="l7.1191"> </span>
<a href="#l7.1192"></a><span id="l7.1192">   mCustomExposedProtocols.AppendElement(aScheme);</span>
<a href="#l7.1193"></a><span id="l7.1193"> </span>
<a href="#l7.1194"></a><span id="l7.1194">   return NS_OK;</span>
<a href="#l7.1195"></a><span id="l7.1195"> }</span>
<a href="#l7.1196"></a><span id="l7.1196"> </span>
<a href="#l7.1197"></a><span id="l7.1197"> NS_IMETHODIMP</span>
<a href="#l7.1198"></a><span id="l7.1198" class="difflineminus">-nsMsgContentPolicy::RemoveExposedProtocol(const nsACString &amp;aScheme)</span>
<a href="#l7.1199"></a><span id="l7.1199" class="difflineminus">-{</span>
<a href="#l7.1200"></a><span id="l7.1200" class="difflineplus">+nsMsgContentPolicy::RemoveExposedProtocol(const nsACString &amp;aScheme) {</span>
<a href="#l7.1201"></a><span id="l7.1201">   mCustomExposedProtocols.RemoveElement(nsCString(aScheme));</span>
<a href="#l7.1202"></a><span id="l7.1202"> </span>
<a href="#l7.1203"></a><span id="l7.1203">   return NS_OK;</span>
<a href="#l7.1204"></a><span id="l7.1204"> }</span>
<a href="#l7.1205"></a><span id="l7.1205" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/base/src/nsMsgContentPolicy.h</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgContentPolicy.h</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -1,19 +1,20 @@</span>
<a href="#l8.4"></a><span id="l8.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l8.5"></a><span id="l8.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l8.6"></a><span id="l8.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l8.7"></a><span id="l8.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l8.8"></a><span id="l8.8"> </span>
<a href="#l8.9"></a><span id="l8.9" class="difflineminus">-/**********************************************************************************</span>
<a href="#l8.10"></a><span id="l8.10" class="difflineminus">- * nsMsgContentPolicy enforces the specified content policy on images, js, plugins, etc.</span>
<a href="#l8.11"></a><span id="l8.11" class="difflineminus">- * This is the class used to determine what elements in a message should be loaded.</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+/******************************************************************************</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+ * nsMsgContentPolicy enforces the specified content policy on images, js,</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineplus">+ * plugins, etc. This is the class used to determine what elements in a message</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineplus">+ * should be loaded.</span>
<a href="#l8.16"></a><span id="l8.16">  *</span>
<a href="#l8.17"></a><span id="l8.17">  * nsMsgCookiePolicy enforces our cookie policy for mail and RSS messages.</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineminus">- ***********************************************************************************/</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineplus">+ ******************************************************************************/</span>
<a href="#l8.20"></a><span id="l8.20"> </span>
<a href="#l8.21"></a><span id="l8.21"> #ifndef _nsMsgContentPolicy_H_</span>
<a href="#l8.22"></a><span id="l8.22"> #define _nsMsgContentPolicy_H_</span>
<a href="#l8.23"></a><span id="l8.23"> </span>
<a href="#l8.24"></a><span id="l8.24"> #include &quot;nsIContentPolicy.h&quot;</span>
<a href="#l8.25"></a><span id="l8.25"> #include &quot;nsIObserver.h&quot;</span>
<a href="#l8.26"></a><span id="l8.26"> #include &quot;nsWeakReference.h&quot;</span>
<a href="#l8.27"></a><span id="l8.27"> #include &quot;nsString.h&quot;</span>
<a href="#l8.28"></a><span id="l8.28" class="difflineat">@@ -21,72 +22,75 @@</span>
<a href="#l8.29"></a><span id="l8.29"> #include &quot;nsIWebProgressListener.h&quot;</span>
<a href="#l8.30"></a><span id="l8.30"> #include &quot;nsIMsgCompose.h&quot;</span>
<a href="#l8.31"></a><span id="l8.31"> #include &quot;nsIDocShell.h&quot;</span>
<a href="#l8.32"></a><span id="l8.32"> #include &quot;nsIPermissionManager.h&quot;</span>
<a href="#l8.33"></a><span id="l8.33"> #include &quot;nsIMsgContentPolicy.h&quot;</span>
<a href="#l8.34"></a><span id="l8.34"> #include &quot;nsTArray.h&quot;</span>
<a href="#l8.35"></a><span id="l8.35"> </span>
<a href="#l8.36"></a><span id="l8.36"> /* DBFCFDF0-4489-4faa-8122-190FD1EFA16C */</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineminus">-#define NS_MSGCONTENTPOLICY_CID \</span>
<a href="#l8.38"></a><span id="l8.38" class="difflineminus">-{ 0xdbfcfdf0, 0x4489, 0x4faa, { 0x81, 0x22, 0x19, 0xf, 0xd1, 0xef, 0xa1, 0x6c } }</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineplus">+#define NS_MSGCONTENTPOLICY_CID                     \</span>
<a href="#l8.40"></a><span id="l8.40" class="difflineplus">+  {                                                 \</span>
<a href="#l8.41"></a><span id="l8.41" class="difflineplus">+    0xdbfcfdf0, 0x4489, 0x4faa, {                   \</span>
<a href="#l8.42"></a><span id="l8.42" class="difflineplus">+      0x81, 0x22, 0x19, 0xf, 0xd1, 0xef, 0xa1, 0x6c \</span>
<a href="#l8.43"></a><span id="l8.43" class="difflineplus">+    }                                               \</span>
<a href="#l8.44"></a><span id="l8.44" class="difflineplus">+  }</span>
<a href="#l8.45"></a><span id="l8.45"> </span>
<a href="#l8.46"></a><span id="l8.46"> #define NS_MSGCONTENTPOLICY_CONTRACTID &quot;@mozilla.org/messenger/content-policy;1&quot;</span>
<a href="#l8.47"></a><span id="l8.47"> </span>
<a href="#l8.48"></a><span id="l8.48"> class nsIMsgDBHdr;</span>
<a href="#l8.49"></a><span id="l8.49"> class nsIDocShell;</span>
<a href="#l8.50"></a><span id="l8.50"> </span>
<a href="#l8.51"></a><span id="l8.51"> class nsMsgContentPolicy : public nsIContentPolicy,</span>
<a href="#l8.52"></a><span id="l8.52">                            public nsIObserver,</span>
<a href="#l8.53"></a><span id="l8.53">                            public nsIWebProgressListener,</span>
<a href="#l8.54"></a><span id="l8.54">                            public nsIMsgContentPolicy,</span>
<a href="#l8.55"></a><span id="l8.55" class="difflineminus">-                           public nsSupportsWeakReference</span>
<a href="#l8.56"></a><span id="l8.56" class="difflineminus">-{</span>
<a href="#l8.57"></a><span id="l8.57" class="difflineminus">-public:</span>
<a href="#l8.58"></a><span id="l8.58" class="difflineplus">+                           public nsSupportsWeakReference {</span>
<a href="#l8.59"></a><span id="l8.59" class="difflineplus">+ public:</span>
<a href="#l8.60"></a><span id="l8.60">   nsMsgContentPolicy();</span>
<a href="#l8.61"></a><span id="l8.61"> </span>
<a href="#l8.62"></a><span id="l8.62">   nsresult Init();</span>
<a href="#l8.63"></a><span id="l8.63"> </span>
<a href="#l8.64"></a><span id="l8.64">   NS_DECL_ISUPPORTS</span>
<a href="#l8.65"></a><span id="l8.65">   NS_DECL_NSICONTENTPOLICY</span>
<a href="#l8.66"></a><span id="l8.66">   NS_DECL_NSIOBSERVER</span>
<a href="#l8.67"></a><span id="l8.67">   NS_DECL_NSIWEBPROGRESSLISTENER</span>
<a href="#l8.68"></a><span id="l8.68">   NS_DECL_NSIMSGCONTENTPOLICY</span>
<a href="#l8.69"></a><span id="l8.69"> </span>
<a href="#l8.70"></a><span id="l8.70" class="difflineminus">-protected:</span>
<a href="#l8.71"></a><span id="l8.71" class="difflineplus">+ protected:</span>
<a href="#l8.72"></a><span id="l8.72">   virtual ~nsMsgContentPolicy();</span>
<a href="#l8.73"></a><span id="l8.73"> </span>
<a href="#l8.74"></a><span id="l8.74" class="difflineminus">-  bool     mBlockRemoteImages;</span>
<a href="#l8.75"></a><span id="l8.75" class="difflineplus">+  bool mBlockRemoteImages;</span>
<a href="#l8.76"></a><span id="l8.76">   nsCString mTrustedMailDomains;</span>
<a href="#l8.77"></a><span id="l8.77">   nsCOMPtr&lt;nsIPermissionManager&gt; mPermissionManager;</span>
<a href="#l8.78"></a><span id="l8.78"> </span>
<a href="#l8.79"></a><span id="l8.79" class="difflineminus">-  bool IsTrustedDomain(nsIURI * aContentLocation);</span>
<a href="#l8.80"></a><span id="l8.80" class="difflineplus">+  bool IsTrustedDomain(nsIURI *aContentLocation);</span>
<a href="#l8.81"></a><span id="l8.81">   bool IsSafeRequestingLocation(nsIURI *aRequestingLocation);</span>
<a href="#l8.82"></a><span id="l8.82">   bool IsExposedProtocol(nsIURI *aContentLocation);</span>
<a href="#l8.83"></a><span id="l8.83">   bool IsExposedChromeProtocol(nsIURI *aContentLocation);</span>
<a href="#l8.84"></a><span id="l8.84">   bool ShouldBlockUnexposedProtocol(nsIURI *aContentLocation);</span>
<a href="#l8.85"></a><span id="l8.85"> </span>
<a href="#l8.86"></a><span id="l8.86">   bool ShouldAcceptRemoteContentForSender(nsIMsgDBHdr *aMsgHdr);</span>
<a href="#l8.87"></a><span id="l8.87">   int16_t ShouldAcceptRemoteContentForMsgHdr(nsIMsgDBHdr *aMsgHdr,</span>
<a href="#l8.88"></a><span id="l8.88">                                              nsIURI *aRequestingLocation,</span>
<a href="#l8.89"></a><span id="l8.89">                                              nsIURI *aContentLocation);</span>
<a href="#l8.90"></a><span id="l8.90">   void NotifyContentWasBlocked(nsIURI *aOriginatorLocation,</span>
<a href="#l8.91"></a><span id="l8.91" class="difflineminus">-                               nsIURI *aContentLocation,</span>
<a href="#l8.92"></a><span id="l8.92" class="difflineminus">-                               bool aCanOverride);</span>
<a href="#l8.93"></a><span id="l8.93" class="difflineplus">+                               nsIURI *aContentLocation, bool aCanOverride);</span>
<a href="#l8.94"></a><span id="l8.94">   void ShouldAcceptContentForPotentialMsg(nsIURI *aOriginatorLocation,</span>
<a href="#l8.95"></a><span id="l8.95">                                           nsIURI *aContentLocation,</span>
<a href="#l8.96"></a><span id="l8.96">                                           int16_t *aDecision);</span>
<a href="#l8.97"></a><span id="l8.97">   void ComposeShouldLoad(nsIMsgCompose *aMsgCompose,</span>
<a href="#l8.98"></a><span id="l8.98">                          nsISupports *aRequestingContext,</span>
<a href="#l8.99"></a><span id="l8.99">                          nsIURI *aContentLocation, int16_t *aDecision);</span>
<a href="#l8.100"></a><span id="l8.100" class="difflineminus">-  already_AddRefed&lt;nsIMsgCompose&gt; GetMsgComposeForContext(nsISupports *aRequestingContext);</span>
<a href="#l8.101"></a><span id="l8.101" class="difflineplus">+  already_AddRefed&lt;nsIMsgCompose&gt; GetMsgComposeForContext(</span>
<a href="#l8.102"></a><span id="l8.102" class="difflineplus">+      nsISupports *aRequestingContext);</span>
<a href="#l8.103"></a><span id="l8.103"> </span>
<a href="#l8.104"></a><span id="l8.104">   nsresult GetRootDocShellForContext(nsISupports *aRequestingContext,</span>
<a href="#l8.105"></a><span id="l8.105">                                      nsIDocShell **aDocShell);</span>
<a href="#l8.106"></a><span id="l8.106">   nsresult GetOriginatingURIForContext(nsISupports *aRequestingContext,</span>
<a href="#l8.107"></a><span id="l8.107">                                        nsIURI **aURI);</span>
<a href="#l8.108"></a><span id="l8.108" class="difflineminus">-  nsresult SetDisableItemsOnMailNewsUrlDocshells(nsIURI *aContentLocation,</span>
<a href="#l8.109"></a><span id="l8.109" class="difflineminus">-                                                 nsISupports *aRequestingContext);</span>
<a href="#l8.110"></a><span id="l8.110" class="difflineplus">+  nsresult SetDisableItemsOnMailNewsUrlDocshells(</span>
<a href="#l8.111"></a><span id="l8.111" class="difflineplus">+      nsIURI *aContentLocation, nsISupports *aRequestingContext);</span>
<a href="#l8.112"></a><span id="l8.112"> </span>
<a href="#l8.113"></a><span id="l8.113">   nsTArray&lt;nsCString&gt; mCustomExposedProtocols;</span>
<a href="#l8.114"></a><span id="l8.114"> };</span>
<a href="#l8.115"></a><span id="l8.115"> </span>
<a href="#l8.116"></a><span id="l8.116" class="difflineminus">-#endif // _nsMsgContentPolicy_H_</span>
<a href="#l8.117"></a><span id="l8.117" class="difflineplus">+#endif  // _nsMsgContentPolicy_H_</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/base/src/nsMsgCopyService.cpp</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgCopyService.cpp</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -14,444 +14,370 @@</span>
<a href="#l9.4"></a><span id="l9.4"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l9.5"></a><span id="l9.5"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l9.6"></a><span id="l9.6"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l9.7"></a><span id="l9.7"> #include &quot;mozilla/Logging.h&quot;</span>
<a href="#l9.8"></a><span id="l9.8"> </span>
<a href="#l9.9"></a><span id="l9.9"> static mozilla::LazyLogModule gCopyServiceLog(&quot;MsgCopyService&quot;);</span>
<a href="#l9.10"></a><span id="l9.10"> </span>
<a href="#l9.11"></a><span id="l9.11"> // ******************** nsCopySource ******************</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-//</span>
<a href="#l9.13"></a><span id="l9.13"> </span>
<a href="#l9.14"></a><span id="l9.14" class="difflineminus">-nsCopySource::nsCopySource() : m_processed(false)</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineminus">-{</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineplus">+nsCopySource::nsCopySource() : m_processed(false) {</span>
<a href="#l9.17"></a><span id="l9.17">   MOZ_COUNT_CTOR(nsCopySource);</span>
<a href="#l9.18"></a><span id="l9.18">   m_messageArray = do_CreateInstance(NS_ARRAY_CONTRACTID);</span>
<a href="#l9.19"></a><span id="l9.19"> }</span>
<a href="#l9.20"></a><span id="l9.20"> </span>
<a href="#l9.21"></a><span id="l9.21" class="difflineminus">-nsCopySource::nsCopySource(nsIMsgFolder* srcFolder) :</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineminus">-    m_processed(false)</span>
<a href="#l9.23"></a><span id="l9.23" class="difflineminus">-{</span>
<a href="#l9.24"></a><span id="l9.24" class="difflineplus">+nsCopySource::nsCopySource(nsIMsgFolder* srcFolder) : m_processed(false) {</span>
<a href="#l9.25"></a><span id="l9.25">   MOZ_COUNT_CTOR(nsCopySource);</span>
<a href="#l9.26"></a><span id="l9.26">   m_messageArray = do_CreateInstance(NS_ARRAY_CONTRACTID);</span>
<a href="#l9.27"></a><span id="l9.27">   m_msgFolder = srcFolder;</span>
<a href="#l9.28"></a><span id="l9.28"> }</span>
<a href="#l9.29"></a><span id="l9.29"> </span>
<a href="#l9.30"></a><span id="l9.30" class="difflineminus">-nsCopySource::~nsCopySource()</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineminus">-{</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineminus">-  MOZ_COUNT_DTOR(nsCopySource);</span>
<a href="#l9.33"></a><span id="l9.33" class="difflineminus">-}</span>
<a href="#l9.34"></a><span id="l9.34" class="difflineplus">+nsCopySource::~nsCopySource() { MOZ_COUNT_DTOR(nsCopySource); }</span>
<a href="#l9.35"></a><span id="l9.35"> </span>
<a href="#l9.36"></a><span id="l9.36" class="difflineminus">-void nsCopySource::AddMessage(nsIMsgDBHdr* aMsg)</span>
<a href="#l9.37"></a><span id="l9.37" class="difflineminus">-{</span>
<a href="#l9.38"></a><span id="l9.38" class="difflineplus">+void nsCopySource::AddMessage(nsIMsgDBHdr* aMsg) {</span>
<a href="#l9.39"></a><span id="l9.39">   m_messageArray-&gt;AppendElement(aMsg);</span>
<a href="#l9.40"></a><span id="l9.40"> }</span>
<a href="#l9.41"></a><span id="l9.41"> </span>
<a href="#l9.42"></a><span id="l9.42"> // ************ nsCopyRequest *****************</span>
<a href="#l9.43"></a><span id="l9.43"> //</span>
<a href="#l9.44"></a><span id="l9.44"> </span>
<a href="#l9.45"></a><span id="l9.45" class="difflineminus">-nsCopyRequest::nsCopyRequest() :</span>
<a href="#l9.46"></a><span id="l9.46" class="difflineminus">-    m_requestType(nsCopyMessagesType),</span>
<a href="#l9.47"></a><span id="l9.47" class="difflineminus">-    m_isMoveOrDraftOrTemplate(false),</span>
<a href="#l9.48"></a><span id="l9.48" class="difflineminus">-    m_processed(false),</span>
<a href="#l9.49"></a><span id="l9.49" class="difflineminus">-    m_newMsgFlags(0)</span>
<a href="#l9.50"></a><span id="l9.50" class="difflineminus">-{</span>
<a href="#l9.51"></a><span id="l9.51" class="difflineplus">+nsCopyRequest::nsCopyRequest()</span>
<a href="#l9.52"></a><span id="l9.52" class="difflineplus">+    : m_requestType(nsCopyMessagesType),</span>
<a href="#l9.53"></a><span id="l9.53" class="difflineplus">+      m_isMoveOrDraftOrTemplate(false),</span>
<a href="#l9.54"></a><span id="l9.54" class="difflineplus">+      m_processed(false),</span>
<a href="#l9.55"></a><span id="l9.55" class="difflineplus">+      m_newMsgFlags(0) {</span>
<a href="#l9.56"></a><span id="l9.56">   MOZ_COUNT_CTOR(nsCopyRequest);</span>
<a href="#l9.57"></a><span id="l9.57"> }</span>
<a href="#l9.58"></a><span id="l9.58"> </span>
<a href="#l9.59"></a><span id="l9.59" class="difflineminus">-nsCopyRequest::~nsCopyRequest()</span>
<a href="#l9.60"></a><span id="l9.60" class="difflineminus">-{</span>
<a href="#l9.61"></a><span id="l9.61" class="difflineplus">+nsCopyRequest::~nsCopyRequest() {</span>
<a href="#l9.62"></a><span id="l9.62">   MOZ_COUNT_DTOR(nsCopyRequest);</span>
<a href="#l9.63"></a><span id="l9.63"> </span>
<a href="#l9.64"></a><span id="l9.64">   int32_t j = m_copySourceArray.Length();</span>
<a href="#l9.65"></a><span id="l9.65" class="difflineminus">-  while(j-- &gt; 0)</span>
<a href="#l9.66"></a><span id="l9.66" class="difflineminus">-    delete m_copySourceArray.ElementAt(j);</span>
<a href="#l9.67"></a><span id="l9.67" class="difflineplus">+  while (j-- &gt; 0) delete m_copySourceArray.ElementAt(j);</span>
<a href="#l9.68"></a><span id="l9.68"> }</span>
<a href="#l9.69"></a><span id="l9.69"> </span>
<a href="#l9.70"></a><span id="l9.70" class="difflineminus">-nsresult</span>
<a href="#l9.71"></a><span id="l9.71" class="difflineminus">-nsCopyRequest::Init(nsCopyRequestType type, nsISupports* aSupport,</span>
<a href="#l9.72"></a><span id="l9.72" class="difflineminus">-                    nsIMsgFolder* dstFolder,</span>
<a href="#l9.73"></a><span id="l9.73" class="difflineminus">-                    bool bVal, uint32_t newMsgFlags,</span>
<a href="#l9.74"></a><span id="l9.74" class="difflineminus">-                    const nsACString &amp;newMsgKeywords,</span>
<a href="#l9.75"></a><span id="l9.75" class="difflineminus">-                    nsIMsgCopyServiceListener* listener,</span>
<a href="#l9.76"></a><span id="l9.76" class="difflineminus">-                    nsIMsgWindow* msgWindow, bool allowUndo)</span>
<a href="#l9.77"></a><span id="l9.77" class="difflineminus">-{</span>
<a href="#l9.78"></a><span id="l9.78" class="difflineplus">+nsresult nsCopyRequest::Init(nsCopyRequestType type, nsISupports* aSupport,</span>
<a href="#l9.79"></a><span id="l9.79" class="difflineplus">+                             nsIMsgFolder* dstFolder, bool bVal,</span>
<a href="#l9.80"></a><span id="l9.80" class="difflineplus">+                             uint32_t newMsgFlags,</span>
<a href="#l9.81"></a><span id="l9.81" class="difflineplus">+                             const nsACString&amp; newMsgKeywords,</span>
<a href="#l9.82"></a><span id="l9.82" class="difflineplus">+                             nsIMsgCopyServiceListener* listener,</span>
<a href="#l9.83"></a><span id="l9.83" class="difflineplus">+                             nsIMsgWindow* msgWindow, bool allowUndo) {</span>
<a href="#l9.84"></a><span id="l9.84">   nsresult rv = NS_OK;</span>
<a href="#l9.85"></a><span id="l9.85">   m_requestType = type;</span>
<a href="#l9.86"></a><span id="l9.86">   m_srcSupport = aSupport;</span>
<a href="#l9.87"></a><span id="l9.87">   m_dstFolder = dstFolder;</span>
<a href="#l9.88"></a><span id="l9.88">   m_isMoveOrDraftOrTemplate = bVal;</span>
<a href="#l9.89"></a><span id="l9.89">   m_allowUndo = allowUndo;</span>
<a href="#l9.90"></a><span id="l9.90">   m_newMsgFlags = newMsgFlags;</span>
<a href="#l9.91"></a><span id="l9.91">   m_newMsgKeywords = newMsgKeywords;</span>
<a href="#l9.92"></a><span id="l9.92"> </span>
<a href="#l9.93"></a><span id="l9.93" class="difflineminus">-  if (listener)</span>
<a href="#l9.94"></a><span id="l9.94" class="difflineminus">-      m_listener = listener;</span>
<a href="#l9.95"></a><span id="l9.95" class="difflineminus">-  if (msgWindow)</span>
<a href="#l9.96"></a><span id="l9.96" class="difflineminus">-  {</span>
<a href="#l9.97"></a><span id="l9.97" class="difflineplus">+  if (listener) m_listener = listener;</span>
<a href="#l9.98"></a><span id="l9.98" class="difflineplus">+  if (msgWindow) {</span>
<a href="#l9.99"></a><span id="l9.99">     m_msgWindow = msgWindow;</span>
<a href="#l9.100"></a><span id="l9.100" class="difflineminus">-    if (m_allowUndo)</span>
<a href="#l9.101"></a><span id="l9.101" class="difflineminus">-      msgWindow-&gt;GetTransactionManager(getter_AddRefs(m_txnMgr));</span>
<a href="#l9.102"></a><span id="l9.102" class="difflineplus">+    if (m_allowUndo) msgWindow-&gt;GetTransactionManager(getter_AddRefs(m_txnMgr));</span>
<a href="#l9.103"></a><span id="l9.103">   }</span>
<a href="#l9.104"></a><span id="l9.104" class="difflineminus">-  if (type == nsCopyFoldersType)</span>
<a href="#l9.105"></a><span id="l9.105" class="difflineminus">-  {</span>
<a href="#l9.106"></a><span id="l9.106" class="difflineplus">+  if (type == nsCopyFoldersType) {</span>
<a href="#l9.107"></a><span id="l9.107">     // To support multiple copy folder operations to the same destination, we</span>
<a href="#l9.108"></a><span id="l9.108">     // need to save the leaf name of the src file spec so that FindRequest() is</span>
<a href="#l9.109"></a><span id="l9.109">     // able to find the right request when copy finishes.</span>
<a href="#l9.110"></a><span id="l9.110">     nsCOMPtr&lt;nsIMsgFolder&gt; srcFolder = do_QueryInterface(aSupport, &amp;rv);</span>
<a href="#l9.111"></a><span id="l9.111">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.112"></a><span id="l9.112">     nsString folderName;</span>
<a href="#l9.113"></a><span id="l9.113">     rv = srcFolder-&gt;GetName(folderName);</span>
<a href="#l9.114"></a><span id="l9.114">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.115"></a><span id="l9.115">     m_dstFolderName = folderName;</span>
<a href="#l9.116"></a><span id="l9.116">   }</span>
<a href="#l9.117"></a><span id="l9.117"> </span>
<a href="#l9.118"></a><span id="l9.118">   return rv;</span>
<a href="#l9.119"></a><span id="l9.119"> }</span>
<a href="#l9.120"></a><span id="l9.120"> </span>
<a href="#l9.121"></a><span id="l9.121" class="difflineminus">-nsCopySource*</span>
<a href="#l9.122"></a><span id="l9.122" class="difflineminus">-nsCopyRequest::AddNewCopySource(nsIMsgFolder* srcFolder)</span>
<a href="#l9.123"></a><span id="l9.123" class="difflineminus">-{</span>
<a href="#l9.124"></a><span id="l9.124" class="difflineplus">+nsCopySource* nsCopyRequest::AddNewCopySource(nsIMsgFolder* srcFolder) {</span>
<a href="#l9.125"></a><span id="l9.125">   nsCopySource* newSrc = new nsCopySource(srcFolder);</span>
<a href="#l9.126"></a><span id="l9.126" class="difflineminus">-  if (newSrc)</span>
<a href="#l9.127"></a><span id="l9.127" class="difflineminus">-  {</span>
<a href="#l9.128"></a><span id="l9.128" class="difflineminus">-      m_copySourceArray.AppendElement(newSrc);</span>
<a href="#l9.129"></a><span id="l9.129" class="difflineminus">-      if (srcFolder == m_dstFolder)</span>
<a href="#l9.130"></a><span id="l9.130" class="difflineminus">-        newSrc-&gt;m_processed = true;</span>
<a href="#l9.131"></a><span id="l9.131" class="difflineplus">+  if (newSrc) {</span>
<a href="#l9.132"></a><span id="l9.132" class="difflineplus">+    m_copySourceArray.AppendElement(newSrc);</span>
<a href="#l9.133"></a><span id="l9.133" class="difflineplus">+    if (srcFolder == m_dstFolder) newSrc-&gt;m_processed = true;</span>
<a href="#l9.134"></a><span id="l9.134">   }</span>
<a href="#l9.135"></a><span id="l9.135">   return newSrc;</span>
<a href="#l9.136"></a><span id="l9.136"> }</span>
<a href="#l9.137"></a><span id="l9.137"> </span>
<a href="#l9.138"></a><span id="l9.138"> // ************* nsMsgCopyService ****************</span>
<a href="#l9.139"></a><span id="l9.139"> //</span>
<a href="#l9.140"></a><span id="l9.140"> </span>
<a href="#l9.141"></a><span id="l9.141" class="difflineplus">+nsMsgCopyService::nsMsgCopyService() {}</span>
<a href="#l9.142"></a><span id="l9.142"> </span>
<a href="#l9.143"></a><span id="l9.143" class="difflineminus">-nsMsgCopyService::nsMsgCopyService()</span>
<a href="#l9.144"></a><span id="l9.144" class="difflineminus">-{</span>
<a href="#l9.145"></a><span id="l9.145" class="difflineminus">-}</span>
<a href="#l9.146"></a><span id="l9.146" class="difflineminus">-</span>
<a href="#l9.147"></a><span id="l9.147" class="difflineminus">-nsMsgCopyService::~nsMsgCopyService()</span>
<a href="#l9.148"></a><span id="l9.148" class="difflineminus">-{</span>
<a href="#l9.149"></a><span id="l9.149" class="difflineplus">+nsMsgCopyService::~nsMsgCopyService() {</span>
<a href="#l9.150"></a><span id="l9.150">   int32_t i = m_copyRequests.Length();</span>
<a href="#l9.151"></a><span id="l9.151"> </span>
<a href="#l9.152"></a><span id="l9.152" class="difflineminus">-  while (i-- &gt; 0)</span>
<a href="#l9.153"></a><span id="l9.153" class="difflineminus">-    ClearRequest(m_copyRequests.ElementAt(i), NS_ERROR_FAILURE);</span>
<a href="#l9.154"></a><span id="l9.154" class="difflineplus">+  while (i-- &gt; 0) ClearRequest(m_copyRequests.ElementAt(i), NS_ERROR_FAILURE);</span>
<a href="#l9.155"></a><span id="l9.155"> }</span>
<a href="#l9.156"></a><span id="l9.156"> </span>
<a href="#l9.157"></a><span id="l9.157" class="difflineminus">-void nsMsgCopyService::LogCopyCompletion(nsISupports *aSrc, nsIMsgFolder *aDest)</span>
<a href="#l9.158"></a><span id="l9.158" class="difflineminus">-{</span>
<a href="#l9.159"></a><span id="l9.159" class="difflineplus">+void nsMsgCopyService::LogCopyCompletion(nsISupports* aSrc,</span>
<a href="#l9.160"></a><span id="l9.160" class="difflineplus">+                                         nsIMsgFolder* aDest) {</span>
<a href="#l9.161"></a><span id="l9.161">   nsCString srcFolderUri, destFolderUri;</span>
<a href="#l9.162"></a><span id="l9.162">   nsCOMPtr&lt;nsIMsgFolder&gt; srcFolder(do_QueryInterface(aSrc));</span>
<a href="#l9.163"></a><span id="l9.163" class="difflineminus">-  if (srcFolder)</span>
<a href="#l9.164"></a><span id="l9.164" class="difflineminus">-    srcFolder-&gt;GetURI(srcFolderUri);</span>
<a href="#l9.165"></a><span id="l9.165" class="difflineplus">+  if (srcFolder) srcFolder-&gt;GetURI(srcFolderUri);</span>
<a href="#l9.166"></a><span id="l9.166">   aDest-&gt;GetURI(destFolderUri);</span>
<a href="#l9.167"></a><span id="l9.167">   MOZ_LOG(gCopyServiceLog, mozilla::LogLevel::Info,</span>
<a href="#l9.168"></a><span id="l9.168" class="difflineminus">-         (&quot;NotifyCompletion - src %s dest %s\n&quot;,</span>
<a href="#l9.169"></a><span id="l9.169" class="difflineminus">-          srcFolderUri.get(), destFolderUri.get()));</span>
<a href="#l9.170"></a><span id="l9.170" class="difflineplus">+          (&quot;NotifyCompletion - src %s dest %s\n&quot;, srcFolderUri.get(),</span>
<a href="#l9.171"></a><span id="l9.171" class="difflineplus">+           destFolderUri.get()));</span>
<a href="#l9.172"></a><span id="l9.172"> }</span>
<a href="#l9.173"></a><span id="l9.173"> </span>
<a href="#l9.174"></a><span id="l9.174" class="difflineminus">-void nsMsgCopyService::LogCopyRequest(const char *logMsg, nsCopyRequest* aRequest)</span>
<a href="#l9.175"></a><span id="l9.175" class="difflineminus">-{</span>
<a href="#l9.176"></a><span id="l9.176" class="difflineplus">+void nsMsgCopyService::LogCopyRequest(const char* logMsg,</span>
<a href="#l9.177"></a><span id="l9.177" class="difflineplus">+                                      nsCopyRequest* aRequest) {</span>
<a href="#l9.178"></a><span id="l9.178">   nsCString srcFolderUri, destFolderUri;</span>
<a href="#l9.179"></a><span id="l9.179">   nsCOMPtr&lt;nsIMsgFolder&gt; srcFolder(do_QueryInterface(aRequest-&gt;m_srcSupport));</span>
<a href="#l9.180"></a><span id="l9.180" class="difflineminus">-  if (srcFolder)</span>
<a href="#l9.181"></a><span id="l9.181" class="difflineminus">-    srcFolder-&gt;GetURI(srcFolderUri);</span>
<a href="#l9.182"></a><span id="l9.182" class="difflineplus">+  if (srcFolder) srcFolder-&gt;GetURI(srcFolderUri);</span>
<a href="#l9.183"></a><span id="l9.183">   aRequest-&gt;m_dstFolder-&gt;GetURI(destFolderUri);</span>
<a href="#l9.184"></a><span id="l9.184">   uint32_t numMsgs = 0;</span>
<a href="#l9.185"></a><span id="l9.185">   if (aRequest-&gt;m_requestType == nsCopyMessagesType &amp;&amp;</span>
<a href="#l9.186"></a><span id="l9.186">       aRequest-&gt;m_copySourceArray.Length() &gt; 0 &amp;&amp;</span>
<a href="#l9.187"></a><span id="l9.187">       aRequest-&gt;m_copySourceArray[0]-&gt;m_messageArray)</span>
<a href="#l9.188"></a><span id="l9.188">     aRequest-&gt;m_copySourceArray[0]-&gt;m_messageArray-&gt;GetLength(&amp;numMsgs);</span>
<a href="#l9.189"></a><span id="l9.189">   MOZ_LOG(gCopyServiceLog, mozilla::LogLevel::Info,</span>
<a href="#l9.190"></a><span id="l9.190" class="difflineminus">-         (&quot;request %p %s - src %s dest %s numItems %d type=%d&quot;,</span>
<a href="#l9.191"></a><span id="l9.191" class="difflineminus">-         aRequest, logMsg, srcFolderUri.get(),</span>
<a href="#l9.192"></a><span id="l9.192" class="difflineminus">-         destFolderUri.get(), numMsgs, aRequest-&gt;m_requestType));</span>
<a href="#l9.193"></a><span id="l9.193" class="difflineplus">+          (&quot;request %p %s - src %s dest %s numItems %d type=%d&quot;, aRequest,</span>
<a href="#l9.194"></a><span id="l9.194" class="difflineplus">+           logMsg, srcFolderUri.get(), destFolderUri.get(), numMsgs,</span>
<a href="#l9.195"></a><span id="l9.195" class="difflineplus">+           aRequest-&gt;m_requestType));</span>
<a href="#l9.196"></a><span id="l9.196"> }</span>
<a href="#l9.197"></a><span id="l9.197"> </span>
<a href="#l9.198"></a><span id="l9.198" class="difflineminus">-nsresult</span>
<a href="#l9.199"></a><span id="l9.199" class="difflineminus">-nsMsgCopyService::ClearRequest(nsCopyRequest* aRequest, nsresult rv)</span>
<a href="#l9.200"></a><span id="l9.200" class="difflineminus">-{</span>
<a href="#l9.201"></a><span id="l9.201" class="difflineminus">-  if (aRequest)</span>
<a href="#l9.202"></a><span id="l9.202" class="difflineminus">-  {</span>
<a href="#l9.203"></a><span id="l9.203" class="difflineplus">+nsresult nsMsgCopyService::ClearRequest(nsCopyRequest* aRequest, nsresult rv) {</span>
<a href="#l9.204"></a><span id="l9.204" class="difflineplus">+  if (aRequest) {</span>
<a href="#l9.205"></a><span id="l9.205">     if (MOZ_LOG_TEST(gCopyServiceLog, mozilla::LogLevel::Info))</span>
<a href="#l9.206"></a><span id="l9.206" class="difflineminus">-      LogCopyRequest(NS_SUCCEEDED(rv) ? &quot;Clearing OK request&quot;</span>
<a href="#l9.207"></a><span id="l9.207" class="difflineminus">-                                      : &quot;Clearing failed request&quot;, aRequest);</span>
<a href="#l9.208"></a><span id="l9.208" class="difflineplus">+      LogCopyRequest(</span>
<a href="#l9.209"></a><span id="l9.209" class="difflineplus">+          NS_SUCCEEDED(rv) ? &quot;Clearing OK request&quot; : &quot;Clearing failed request&quot;,</span>
<a href="#l9.210"></a><span id="l9.210" class="difflineplus">+          aRequest);</span>
<a href="#l9.211"></a><span id="l9.211"> </span>
<a href="#l9.212"></a><span id="l9.212">     // Send notifications to nsIMsgFolderListeners</span>
<a href="#l9.213"></a><span id="l9.213" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; aRequest-&gt;m_requestType == nsCopyFoldersType)</span>
<a href="#l9.214"></a><span id="l9.214" class="difflineminus">-    {</span>
<a href="#l9.215"></a><span id="l9.215" class="difflineminus">-      nsCOMPtr&lt;nsIMsgFolderNotificationService&gt; notifier(do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID));</span>
<a href="#l9.216"></a><span id="l9.216" class="difflineminus">-      if (notifier)</span>
<a href="#l9.217"></a><span id="l9.217" class="difflineminus">-      {</span>
<a href="#l9.218"></a><span id="l9.218" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; aRequest-&gt;m_requestType == nsCopyFoldersType) {</span>
<a href="#l9.219"></a><span id="l9.219" class="difflineplus">+      nsCOMPtr&lt;nsIMsgFolderNotificationService&gt; notifier(</span>
<a href="#l9.220"></a><span id="l9.220" class="difflineplus">+          do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID));</span>
<a href="#l9.221"></a><span id="l9.221" class="difflineplus">+      if (notifier) {</span>
<a href="#l9.222"></a><span id="l9.222">         bool hasListeners;</span>
<a href="#l9.223"></a><span id="l9.223">         notifier-&gt;GetHasListeners(&amp;hasListeners);</span>
<a href="#l9.224"></a><span id="l9.224" class="difflineminus">-        if (hasListeners)</span>
<a href="#l9.225"></a><span id="l9.225" class="difflineminus">-        {</span>
<a href="#l9.226"></a><span id="l9.226" class="difflineminus">-          // Iterate over the copy sources and append their message arrays to this mutable array</span>
<a href="#l9.227"></a><span id="l9.227" class="difflineminus">-          // or in the case of folders, the source folder.</span>
<a href="#l9.228"></a><span id="l9.228" class="difflineplus">+        if (hasListeners) {</span>
<a href="#l9.229"></a><span id="l9.229" class="difflineplus">+          // Iterate over the copy sources and append their message arrays to</span>
<a href="#l9.230"></a><span id="l9.230" class="difflineplus">+          // this mutable array or in the case of folders, the source folder.</span>
<a href="#l9.231"></a><span id="l9.231">           int32_t cnt, i;</span>
<a href="#l9.232"></a><span id="l9.232">           cnt = aRequest-&gt;m_copySourceArray.Length();</span>
<a href="#l9.233"></a><span id="l9.233" class="difflineminus">-          for (i = 0; i &lt; cnt; i++)</span>
<a href="#l9.234"></a><span id="l9.234" class="difflineminus">-          {</span>
<a href="#l9.235"></a><span id="l9.235" class="difflineminus">-            nsCopySource *copySource = aRequest-&gt;m_copySourceArray.ElementAt(i);</span>
<a href="#l9.236"></a><span id="l9.236" class="difflineminus">-            notifier-&gt;NotifyFolderMoveCopyCompleted(aRequest-&gt;m_isMoveOrDraftOrTemplate, copySource-&gt;m_msgFolder, aRequest-&gt;m_dstFolder);</span>
<a href="#l9.237"></a><span id="l9.237" class="difflineplus">+          for (i = 0; i &lt; cnt; i++) {</span>
<a href="#l9.238"></a><span id="l9.238" class="difflineplus">+            nsCopySource* copySource = aRequest-&gt;m_copySourceArray.ElementAt(i);</span>
<a href="#l9.239"></a><span id="l9.239" class="difflineplus">+            notifier-&gt;NotifyFolderMoveCopyCompleted(</span>
<a href="#l9.240"></a><span id="l9.240" class="difflineplus">+                aRequest-&gt;m_isMoveOrDraftOrTemplate, copySource-&gt;m_msgFolder,</span>
<a href="#l9.241"></a><span id="l9.241" class="difflineplus">+                aRequest-&gt;m_dstFolder);</span>
<a href="#l9.242"></a><span id="l9.242">           }</span>
<a href="#l9.243"></a><span id="l9.243">         }</span>
<a href="#l9.244"></a><span id="l9.244">       }</span>
<a href="#l9.245"></a><span id="l9.245">     }</span>
<a href="#l9.246"></a><span id="l9.246"> </span>
<a href="#l9.247"></a><span id="l9.247">     // undo stuff</span>
<a href="#l9.248"></a><span id="l9.248" class="difflineminus">-    if (aRequest-&gt;m_allowUndo &amp;&amp;</span>
<a href="#l9.249"></a><span id="l9.249" class="difflineminus">-        aRequest-&gt;m_copySourceArray.Length() &gt; 1 &amp;&amp;</span>
<a href="#l9.250"></a><span id="l9.250" class="difflineplus">+    if (aRequest-&gt;m_allowUndo &amp;&amp; aRequest-&gt;m_copySourceArray.Length() &gt; 1 &amp;&amp;</span>
<a href="#l9.251"></a><span id="l9.251">         aRequest-&gt;m_txnMgr)</span>
<a href="#l9.252"></a><span id="l9.252" class="difflineminus">-        aRequest-&gt;m_txnMgr-&gt;EndBatch(false);</span>
<a href="#l9.253"></a><span id="l9.253" class="difflineplus">+      aRequest-&gt;m_txnMgr-&gt;EndBatch(false);</span>
<a href="#l9.254"></a><span id="l9.254"> </span>
<a href="#l9.255"></a><span id="l9.255">     m_copyRequests.RemoveElement(aRequest);</span>
<a href="#l9.256"></a><span id="l9.256" class="difflineminus">-    if (aRequest-&gt;m_listener)</span>
<a href="#l9.257"></a><span id="l9.257" class="difflineminus">-        aRequest-&gt;m_listener-&gt;OnStopCopy(rv);</span>
<a href="#l9.258"></a><span id="l9.258" class="difflineplus">+    if (aRequest-&gt;m_listener) aRequest-&gt;m_listener-&gt;OnStopCopy(rv);</span>
<a href="#l9.259"></a><span id="l9.259">     delete aRequest;</span>
<a href="#l9.260"></a><span id="l9.260">   }</span>
<a href="#l9.261"></a><span id="l9.261"> </span>
<a href="#l9.262"></a><span id="l9.262">   return rv;</span>
<a href="#l9.263"></a><span id="l9.263"> }</span>
<a href="#l9.264"></a><span id="l9.264"> </span>
<a href="#l9.265"></a><span id="l9.265" class="difflineminus">-nsresult</span>
<a href="#l9.266"></a><span id="l9.266" class="difflineminus">-nsMsgCopyService::QueueRequest(nsCopyRequest* aRequest, bool *aCopyImmediately)</span>
<a href="#l9.267"></a><span id="l9.267" class="difflineminus">-{</span>
<a href="#l9.268"></a><span id="l9.268" class="difflineplus">+nsresult nsMsgCopyService::QueueRequest(nsCopyRequest* aRequest,</span>
<a href="#l9.269"></a><span id="l9.269" class="difflineplus">+                                        bool* aCopyImmediately) {</span>
<a href="#l9.270"></a><span id="l9.270">   NS_ENSURE_ARG_POINTER(aRequest);</span>
<a href="#l9.271"></a><span id="l9.271">   NS_ENSURE_ARG_POINTER(aCopyImmediately);</span>
<a href="#l9.272"></a><span id="l9.272">   *aCopyImmediately = true;</span>
<a href="#l9.273"></a><span id="l9.273">   nsCopyRequest* copyRequest;</span>
<a href="#l9.274"></a><span id="l9.274"> </span>
<a href="#l9.275"></a><span id="l9.275">   uint32_t cnt = m_copyRequests.Length();</span>
<a href="#l9.276"></a><span id="l9.276" class="difflineminus">-  for (uint32_t i = 0; i &lt; cnt; i++)</span>
<a href="#l9.277"></a><span id="l9.277" class="difflineminus">-  {</span>
<a href="#l9.278"></a><span id="l9.278" class="difflineplus">+  for (uint32_t i = 0; i &lt; cnt; i++) {</span>
<a href="#l9.279"></a><span id="l9.279">     copyRequest = m_copyRequests.ElementAt(i);</span>
<a href="#l9.280"></a><span id="l9.280" class="difflineminus">-    if (aRequest-&gt;m_requestType == nsCopyFoldersType)</span>
<a href="#l9.281"></a><span id="l9.281" class="difflineminus">-    {</span>
<a href="#l9.282"></a><span id="l9.282" class="difflineplus">+    if (aRequest-&gt;m_requestType == nsCopyFoldersType) {</span>
<a href="#l9.283"></a><span id="l9.283">       // For copy folder, see if both destination folder (root)</span>
<a href="#l9.284"></a><span id="l9.284">       // (ie, Local Folder) and folder name (ie, abc) are the same.</span>
<a href="#l9.285"></a><span id="l9.285">       if (copyRequest-&gt;m_dstFolderName == aRequest-&gt;m_dstFolderName &amp;&amp;</span>
<a href="#l9.286"></a><span id="l9.286" class="difflineminus">-          copyRequest-&gt;m_dstFolder.get() == aRequest-&gt;m_dstFolder.get())</span>
<a href="#l9.287"></a><span id="l9.287" class="difflineminus">-      {</span>
<a href="#l9.288"></a><span id="l9.288" class="difflineplus">+          copyRequest-&gt;m_dstFolder.get() == aRequest-&gt;m_dstFolder.get()) {</span>
<a href="#l9.289"></a><span id="l9.289">         *aCopyImmediately = false;</span>
<a href="#l9.290"></a><span id="l9.290">         break;</span>
<a href="#l9.291"></a><span id="l9.291">       }</span>
<a href="#l9.292"></a><span id="l9.292" class="difflineminus">-    }</span>
<a href="#l9.293"></a><span id="l9.293" class="difflineminus">-    else if (copyRequest-&gt;m_dstFolder.get() == aRequest-&gt;m_dstFolder.get())  //if dst are same and we already have a request, we cannot copy immediately</span>
<a href="#l9.294"></a><span id="l9.294" class="difflineminus">-    {</span>
<a href="#l9.295"></a><span id="l9.295" class="difflineplus">+    } else if (copyRequest-&gt;m_dstFolder.get() == aRequest-&gt;m_dstFolder.get()) {</span>
<a href="#l9.296"></a><span id="l9.296" class="difflineplus">+      // If dst are same and we already have a request, we cannot copy</span>
<a href="#l9.297"></a><span id="l9.297" class="difflineplus">+      // immediately.</span>
<a href="#l9.298"></a><span id="l9.298">       *aCopyImmediately = false;</span>
<a href="#l9.299"></a><span id="l9.299">       break;</span>
<a href="#l9.300"></a><span id="l9.300">     }</span>
<a href="#l9.301"></a><span id="l9.301">   }</span>
<a href="#l9.302"></a><span id="l9.302">   return NS_OK;</span>
<a href="#l9.303"></a><span id="l9.303"> }</span>
<a href="#l9.304"></a><span id="l9.304"> </span>
<a href="#l9.305"></a><span id="l9.305" class="difflineminus">-nsresult</span>
<a href="#l9.306"></a><span id="l9.306" class="difflineminus">-nsMsgCopyService::DoCopy(nsCopyRequest* aRequest)</span>
<a href="#l9.307"></a><span id="l9.307" class="difflineminus">-{</span>
<a href="#l9.308"></a><span id="l9.308" class="difflineplus">+nsresult nsMsgCopyService::DoCopy(nsCopyRequest* aRequest) {</span>
<a href="#l9.309"></a><span id="l9.309">   NS_ENSURE_ARG(aRequest);</span>
<a href="#l9.310"></a><span id="l9.310">   bool copyImmediately;</span>
<a href="#l9.311"></a><span id="l9.311">   QueueRequest(aRequest, &amp;copyImmediately);</span>
<a href="#l9.312"></a><span id="l9.312">   m_copyRequests.AppendElement(aRequest);</span>
<a href="#l9.313"></a><span id="l9.313">   if (MOZ_LOG_TEST(gCopyServiceLog, mozilla::LogLevel::Info))</span>
<a href="#l9.314"></a><span id="l9.314">     LogCopyRequest(copyImmediately ? &quot;DoCopy&quot; : &quot;QueueRequest&quot;, aRequest);</span>
<a href="#l9.315"></a><span id="l9.315"> </span>
<a href="#l9.316"></a><span id="l9.316">   // if no active request for this dest folder then we can copy immediately</span>
<a href="#l9.317"></a><span id="l9.317" class="difflineminus">-  if (copyImmediately)</span>
<a href="#l9.318"></a><span id="l9.318" class="difflineminus">-    return DoNextCopy();</span>
<a href="#l9.319"></a><span id="l9.319" class="difflineplus">+  if (copyImmediately) return DoNextCopy();</span>
<a href="#l9.320"></a><span id="l9.320"> </span>
<a href="#l9.321"></a><span id="l9.321">   return NS_OK;</span>
<a href="#l9.322"></a><span id="l9.322"> }</span>
<a href="#l9.323"></a><span id="l9.323"> </span>
<a href="#l9.324"></a><span id="l9.324" class="difflineminus">-nsresult</span>
<a href="#l9.325"></a><span id="l9.325" class="difflineminus">-nsMsgCopyService::DoNextCopy()</span>
<a href="#l9.326"></a><span id="l9.326" class="difflineminus">-{</span>
<a href="#l9.327"></a><span id="l9.327" class="difflineplus">+nsresult nsMsgCopyService::DoNextCopy() {</span>
<a href="#l9.328"></a><span id="l9.328">   nsresult rv = NS_OK;</span>
<a href="#l9.329"></a><span id="l9.329">   nsCopyRequest* copyRequest = nullptr;</span>
<a href="#l9.330"></a><span id="l9.330">   nsCopySource* copySource = nullptr;</span>
<a href="#l9.331"></a><span id="l9.331">   uint32_t i, j, scnt;</span>
<a href="#l9.332"></a><span id="l9.332"> </span>
<a href="#l9.333"></a><span id="l9.333">   uint32_t cnt = m_copyRequests.Length();</span>
<a href="#l9.334"></a><span id="l9.334" class="difflineminus">-  if (cnt &gt; 0)</span>
<a href="#l9.335"></a><span id="l9.335" class="difflineminus">-  {</span>
<a href="#l9.336"></a><span id="l9.336" class="difflineplus">+  if (cnt &gt; 0) {</span>
<a href="#l9.337"></a><span id="l9.337">     nsCOMArray&lt;nsIMsgFolder&gt; activeTargets;</span>
<a href="#l9.338"></a><span id="l9.338"> </span>
<a href="#l9.339"></a><span id="l9.339">     // ** jt -- always FIFO</span>
<a href="#l9.340"></a><span id="l9.340" class="difflineminus">-    for (i = 0; i &lt; cnt; i++)</span>
<a href="#l9.341"></a><span id="l9.341" class="difflineminus">-    {</span>
<a href="#l9.342"></a><span id="l9.342" class="difflineplus">+    for (i = 0; i &lt; cnt; i++) {</span>
<a href="#l9.343"></a><span id="l9.343">       copyRequest = m_copyRequests.ElementAt(i);</span>
<a href="#l9.344"></a><span id="l9.344">       copySource = nullptr;</span>
<a href="#l9.345"></a><span id="l9.345">       scnt = copyRequest-&gt;m_copySourceArray.Length();</span>
<a href="#l9.346"></a><span id="l9.346" class="difflineminus">-      if (!copyRequest-&gt;m_processed)</span>
<a href="#l9.347"></a><span id="l9.347" class="difflineminus">-      {</span>
<a href="#l9.348"></a><span id="l9.348" class="difflineplus">+      if (!copyRequest-&gt;m_processed) {</span>
<a href="#l9.349"></a><span id="l9.349">         // if the target folder of this request already has an active</span>
<a href="#l9.350"></a><span id="l9.350">         // copy request, skip this request for now.</span>
<a href="#l9.351"></a><span id="l9.351" class="difflineminus">-        if (activeTargets.ContainsObject(copyRequest-&gt;m_dstFolder))</span>
<a href="#l9.352"></a><span id="l9.352" class="difflineminus">-        {</span>
<a href="#l9.353"></a><span id="l9.353" class="difflineplus">+        if (activeTargets.ContainsObject(copyRequest-&gt;m_dstFolder)) {</span>
<a href="#l9.354"></a><span id="l9.354">           copyRequest = nullptr;</span>
<a href="#l9.355"></a><span id="l9.355">           continue;</span>
<a href="#l9.356"></a><span id="l9.356">         }</span>
<a href="#l9.357"></a><span id="l9.357" class="difflineminus">-        if (scnt &lt;= 0)</span>
<a href="#l9.358"></a><span id="l9.358" class="difflineminus">-            goto found; // must be CopyFileMessage</span>
<a href="#l9.359"></a><span id="l9.359" class="difflineminus">-        for (j = 0; j &lt; scnt; j++)</span>
<a href="#l9.360"></a><span id="l9.360" class="difflineminus">-        {</span>
<a href="#l9.361"></a><span id="l9.361" class="difflineplus">+        if (scnt &lt;= 0) goto found;  // must be CopyFileMessage</span>
<a href="#l9.362"></a><span id="l9.362" class="difflineplus">+        for (j = 0; j &lt; scnt; j++) {</span>
<a href="#l9.363"></a><span id="l9.363">           copySource = copyRequest-&gt;m_copySourceArray.ElementAt(j);</span>
<a href="#l9.364"></a><span id="l9.364" class="difflineminus">-          if (!copySource-&gt;m_processed)</span>
<a href="#l9.365"></a><span id="l9.365" class="difflineminus">-            goto found;</span>
<a href="#l9.366"></a><span id="l9.366" class="difflineplus">+          if (!copySource-&gt;m_processed) goto found;</span>
<a href="#l9.367"></a><span id="l9.367">         }</span>
<a href="#l9.368"></a><span id="l9.368" class="difflineminus">-        if (j &gt;= scnt) // all processed set the value</span>
<a href="#l9.369"></a><span id="l9.369" class="difflineplus">+        if (j &gt;= scnt)  // all processed set the value</span>
<a href="#l9.370"></a><span id="l9.370">           copyRequest-&gt;m_processed = true;</span>
<a href="#l9.371"></a><span id="l9.371">       }</span>
<a href="#l9.372"></a><span id="l9.372" class="difflineminus">-      if (copyRequest-&gt;m_processed) // keep track of folders actively getting copied to.</span>
<a href="#l9.373"></a><span id="l9.373" class="difflineplus">+      if (copyRequest-&gt;m_processed) {</span>
<a href="#l9.374"></a><span id="l9.374" class="difflineplus">+        // Keep track of folders actively getting copied to.</span>
<a href="#l9.375"></a><span id="l9.375">         activeTargets.AppendObject(copyRequest-&gt;m_dstFolder);</span>
<a href="#l9.376"></a><span id="l9.376" class="difflineminus">-    }</span>
<a href="#l9.377"></a><span id="l9.377" class="difflineminus">-    found:</span>
<a href="#l9.378"></a><span id="l9.378" class="difflineminus">-      if (copyRequest &amp;&amp; !copyRequest-&gt;m_processed)</span>
<a href="#l9.379"></a><span id="l9.379" class="difflineminus">-      {</span>
<a href="#l9.380"></a><span id="l9.380" class="difflineminus">-          if (copyRequest-&gt;m_listener)</span>
<a href="#l9.381"></a><span id="l9.381" class="difflineminus">-              copyRequest-&gt;m_listener-&gt;OnStartCopy();</span>
<a href="#l9.382"></a><span id="l9.382" class="difflineminus">-          if (copyRequest-&gt;m_requestType == nsCopyMessagesType &amp;&amp;</span>
<a href="#l9.383"></a><span id="l9.383" class="difflineminus">-              copySource)</span>
<a href="#l9.384"></a><span id="l9.384" class="difflineminus">-          {</span>
<a href="#l9.385"></a><span id="l9.385" class="difflineminus">-              copySource-&gt;m_processed = true;</span>
<a href="#l9.386"></a><span id="l9.386" class="difflineminus">-              rv = copyRequest-&gt;m_dstFolder-&gt;CopyMessages</span>
<a href="#l9.387"></a><span id="l9.387" class="difflineminus">-                  (copySource-&gt;m_msgFolder, copySource-&gt;m_messageArray,</span>
<a href="#l9.388"></a><span id="l9.388" class="difflineminus">-                   copyRequest-&gt;m_isMoveOrDraftOrTemplate,</span>
<a href="#l9.389"></a><span id="l9.389" class="difflineminus">-                   copyRequest-&gt;m_msgWindow, copyRequest-&gt;m_listener, false, copyRequest-&gt;m_allowUndo);   //isFolder operation false</span>
<a href="#l9.390"></a><span id="l9.390" class="difflineminus">-</span>
<a href="#l9.391"></a><span id="l9.391" class="difflineminus">-          }</span>
<a href="#l9.392"></a><span id="l9.392" class="difflineminus">-          else if (copyRequest-&gt;m_requestType == nsCopyFoldersType)</span>
<a href="#l9.393"></a><span id="l9.393" class="difflineminus">-          {</span>
<a href="#l9.394"></a><span id="l9.394" class="difflineminus">-              NS_ENSURE_STATE(copySource);</span>
<a href="#l9.395"></a><span id="l9.395" class="difflineminus">-              copySource-&gt;m_processed = true;</span>
<a href="#l9.396"></a><span id="l9.396" class="difflineminus">-              rv = copyRequest-&gt;m_dstFolder-&gt;CopyFolder</span>
<a href="#l9.397"></a><span id="l9.397" class="difflineminus">-                  (copySource-&gt;m_msgFolder,</span>
<a href="#l9.398"></a><span id="l9.398" class="difflineminus">-                   copyRequest-&gt;m_isMoveOrDraftOrTemplate,</span>
<a href="#l9.399"></a><span id="l9.399" class="difflineminus">-                   copyRequest-&gt;m_msgWindow, copyRequest-&gt;m_listener);</span>
<a href="#l9.400"></a><span id="l9.400" class="difflineminus">-              // If it's a copy folder operation and the destination</span>
<a href="#l9.401"></a><span id="l9.401" class="difflineminus">-              // folder already exists, CopyFolder() returns an error w/o sending</span>
<a href="#l9.402"></a><span id="l9.402" class="difflineminus">-              // a completion notification, so clear it here.</span>
<a href="#l9.403"></a><span id="l9.403" class="difflineminus">-              if (NS_FAILED(rv))</span>
<a href="#l9.404"></a><span id="l9.404" class="difflineminus">-                ClearRequest(copyRequest, rv);</span>
<a href="#l9.405"></a><span id="l9.405" class="difflineminus">-</span>
<a href="#l9.406"></a><span id="l9.406" class="difflineminus">-          }</span>
<a href="#l9.407"></a><span id="l9.407" class="difflineminus">-          else if (copyRequest-&gt;m_requestType == nsCopyFileMessageType)</span>
<a href="#l9.408"></a><span id="l9.408" class="difflineminus">-          {</span>
<a href="#l9.409"></a><span id="l9.409" class="difflineminus">-            nsCOMPtr&lt;nsIFile&gt; aFile(do_QueryInterface(copyRequest-&gt;m_srcSupport, &amp;rv));</span>
<a href="#l9.410"></a><span id="l9.410" class="difflineminus">-            if (NS_SUCCEEDED(rv))</span>
<a href="#l9.411"></a><span id="l9.411" class="difflineminus">-            {</span>
<a href="#l9.412"></a><span id="l9.412" class="difflineminus">-                // ** in case of saving draft/template; the very first</span>
<a href="#l9.413"></a><span id="l9.413" class="difflineminus">-                // time we may not have the original message to replace</span>
<a href="#l9.414"></a><span id="l9.414" class="difflineminus">-                // with; if we do we shall have an instance of copySource</span>
<a href="#l9.415"></a><span id="l9.415" class="difflineminus">-                nsCOMPtr&lt;nsIMsgDBHdr&gt; aMessage;</span>
<a href="#l9.416"></a><span id="l9.416" class="difflineminus">-                if (copySource)</span>
<a href="#l9.417"></a><span id="l9.417" class="difflineminus">-                {</span>
<a href="#l9.418"></a><span id="l9.418" class="difflineminus">-                    aMessage = do_QueryElementAt(copySource-&gt;m_messageArray,</span>
<a href="#l9.419"></a><span id="l9.419" class="difflineminus">-                                                 0, &amp;rv);</span>
<a href="#l9.420"></a><span id="l9.420" class="difflineminus">-                    copySource-&gt;m_processed = true;</span>
<a href="#l9.421"></a><span id="l9.421" class="difflineminus">-                }</span>
<a href="#l9.422"></a><span id="l9.422" class="difflineminus">-                copyRequest-&gt;m_processed = true;</span>
<a href="#l9.423"></a><span id="l9.423" class="difflineminus">-                rv = copyRequest-&gt;m_dstFolder-&gt;CopyFileMessage</span>
<a href="#l9.424"></a><span id="l9.424" class="difflineminus">-                    (aFile, aMessage,</span>
<a href="#l9.425"></a><span id="l9.425" class="difflineminus">-                     copyRequest-&gt;m_isMoveOrDraftOrTemplate,</span>
<a href="#l9.426"></a><span id="l9.426" class="difflineminus">-                     copyRequest-&gt;m_newMsgFlags,</span>
<a href="#l9.427"></a><span id="l9.427" class="difflineminus">-                     copyRequest-&gt;m_newMsgKeywords,</span>
<a href="#l9.428"></a><span id="l9.428" class="difflineminus">-                     copyRequest-&gt;m_msgWindow,</span>
<a href="#l9.429"></a><span id="l9.429" class="difflineminus">-                     copyRequest-&gt;m_listener);</span>
<a href="#l9.430"></a><span id="l9.430" class="difflineminus">-            }</span>
<a href="#l9.431"></a><span id="l9.431" class="difflineminus">-          }</span>
<a href="#l9.432"></a><span id="l9.432">       }</span>
<a href="#l9.433"></a><span id="l9.433">     }</span>
<a href="#l9.434"></a><span id="l9.434" class="difflineminus">-    return rv;</span>
<a href="#l9.435"></a><span id="l9.435" class="difflineplus">+  found:</span>
<a href="#l9.436"></a><span id="l9.436" class="difflineplus">+    if (copyRequest &amp;&amp; !copyRequest-&gt;m_processed) {</span>
<a href="#l9.437"></a><span id="l9.437" class="difflineplus">+      if (copyRequest-&gt;m_listener) copyRequest-&gt;m_listener-&gt;OnStartCopy();</span>
<a href="#l9.438"></a><span id="l9.438" class="difflineplus">+      if (copyRequest-&gt;m_requestType == nsCopyMessagesType &amp;&amp; copySource) {</span>
<a href="#l9.439"></a><span id="l9.439" class="difflineplus">+        copySource-&gt;m_processed = true;</span>
<a href="#l9.440"></a><span id="l9.440" class="difflineplus">+        rv = copyRequest-&gt;m_dstFolder-&gt;CopyMessages(</span>
<a href="#l9.441"></a><span id="l9.441" class="difflineplus">+            copySource-&gt;m_msgFolder, copySource-&gt;m_messageArray,</span>
<a href="#l9.442"></a><span id="l9.442" class="difflineplus">+            copyRequest-&gt;m_isMoveOrDraftOrTemplate, copyRequest-&gt;m_msgWindow,</span>
<a href="#l9.443"></a><span id="l9.443" class="difflineplus">+            copyRequest-&gt;m_listener, false,</span>
<a href="#l9.444"></a><span id="l9.444" class="difflineplus">+            copyRequest-&gt;m_allowUndo);  // isFolder operation false</span>
<a href="#l9.445"></a><span id="l9.445" class="difflineplus">+</span>
<a href="#l9.446"></a><span id="l9.446" class="difflineplus">+      } else if (copyRequest-&gt;m_requestType == nsCopyFoldersType) {</span>
<a href="#l9.447"></a><span id="l9.447" class="difflineplus">+        NS_ENSURE_STATE(copySource);</span>
<a href="#l9.448"></a><span id="l9.448" class="difflineplus">+        copySource-&gt;m_processed = true;</span>
<a href="#l9.449"></a><span id="l9.449" class="difflineplus">+        rv = copyRequest-&gt;m_dstFolder-&gt;CopyFolder(</span>
<a href="#l9.450"></a><span id="l9.450" class="difflineplus">+            copySource-&gt;m_msgFolder, copyRequest-&gt;m_isMoveOrDraftOrTemplate,</span>
<a href="#l9.451"></a><span id="l9.451" class="difflineplus">+            copyRequest-&gt;m_msgWindow, copyRequest-&gt;m_listener);</span>
<a href="#l9.452"></a><span id="l9.452" class="difflineplus">+        // If it's a copy folder operation and the destination</span>
<a href="#l9.453"></a><span id="l9.453" class="difflineplus">+        // folder already exists, CopyFolder() returns an error w/o sending</span>
<a href="#l9.454"></a><span id="l9.454" class="difflineplus">+        // a completion notification, so clear it here.</span>
<a href="#l9.455"></a><span id="l9.455" class="difflineplus">+        if (NS_FAILED(rv)) ClearRequest(copyRequest, rv);</span>
<a href="#l9.456"></a><span id="l9.456" class="difflineplus">+</span>
<a href="#l9.457"></a><span id="l9.457" class="difflineplus">+      } else if (copyRequest-&gt;m_requestType == nsCopyFileMessageType) {</span>
<a href="#l9.458"></a><span id="l9.458" class="difflineplus">+        nsCOMPtr&lt;nsIFile&gt; aFile(</span>
<a href="#l9.459"></a><span id="l9.459" class="difflineplus">+            do_QueryInterface(copyRequest-&gt;m_srcSupport, &amp;rv));</span>
<a href="#l9.460"></a><span id="l9.460" class="difflineplus">+        if (NS_SUCCEEDED(rv)) {</span>
<a href="#l9.461"></a><span id="l9.461" class="difflineplus">+          // ** in case of saving draft/template; the very first</span>
<a href="#l9.462"></a><span id="l9.462" class="difflineplus">+          // time we may not have the original message to replace</span>
<a href="#l9.463"></a><span id="l9.463" class="difflineplus">+          // with; if we do we shall have an instance of copySource</span>
<a href="#l9.464"></a><span id="l9.464" class="difflineplus">+          nsCOMPtr&lt;nsIMsgDBHdr&gt; aMessage;</span>
<a href="#l9.465"></a><span id="l9.465" class="difflineplus">+          if (copySource) {</span>
<a href="#l9.466"></a><span id="l9.466" class="difflineplus">+            aMessage = do_QueryElementAt(copySource-&gt;m_messageArray, 0, &amp;rv);</span>
<a href="#l9.467"></a><span id="l9.467" class="difflineplus">+            copySource-&gt;m_processed = true;</span>
<a href="#l9.468"></a><span id="l9.468" class="difflineplus">+          }</span>
<a href="#l9.469"></a><span id="l9.469" class="difflineplus">+          copyRequest-&gt;m_processed = true;</span>
<a href="#l9.470"></a><span id="l9.470" class="difflineplus">+          rv = copyRequest-&gt;m_dstFolder-&gt;CopyFileMessage(</span>
<a href="#l9.471"></a><span id="l9.471" class="difflineplus">+              aFile, aMessage, copyRequest-&gt;m_isMoveOrDraftOrTemplate,</span>
<a href="#l9.472"></a><span id="l9.472" class="difflineplus">+              copyRequest-&gt;m_newMsgFlags, copyRequest-&gt;m_newMsgKeywords,</span>
<a href="#l9.473"></a><span id="l9.473" class="difflineplus">+              copyRequest-&gt;m_msgWindow, copyRequest-&gt;m_listener);</span>
<a href="#l9.474"></a><span id="l9.474" class="difflineplus">+        }</span>
<a href="#l9.475"></a><span id="l9.475" class="difflineplus">+      }</span>
<a href="#l9.476"></a><span id="l9.476" class="difflineplus">+    }</span>
<a href="#l9.477"></a><span id="l9.477" class="difflineplus">+  }</span>
<a href="#l9.478"></a><span id="l9.478" class="difflineplus">+  return rv;</span>
<a href="#l9.479"></a><span id="l9.479"> }</span>
<a href="#l9.480"></a><span id="l9.480"> </span>
<a href="#l9.481"></a><span id="l9.481"> /**</span>
<a href="#l9.482"></a><span id="l9.482">  * Find a request in m_copyRequests which matches the passed in source</span>
<a href="#l9.483"></a><span id="l9.483">  * and destination folders.</span>
<a href="#l9.484"></a><span id="l9.484">  *</span>
<a href="#l9.485"></a><span id="l9.485">  * @param aSupport the iSupports of the source folder.</span>
<a href="#l9.486"></a><span id="l9.486">  * @param dstFolder the destination folder of the copy request.</span>
<a href="#l9.487"></a><span id="l9.487">  */</span>
<a href="#l9.488"></a><span id="l9.488" class="difflineminus">-nsCopyRequest*</span>
<a href="#l9.489"></a><span id="l9.489" class="difflineminus">-nsMsgCopyService::FindRequest(nsISupports* aSupport,</span>
<a href="#l9.490"></a><span id="l9.490" class="difflineminus">-                              nsIMsgFolder* dstFolder)</span>
<a href="#l9.491"></a><span id="l9.491" class="difflineminus">-{</span>
<a href="#l9.492"></a><span id="l9.492" class="difflineplus">+nsCopyRequest* nsMsgCopyService::FindRequest(nsISupports* aSupport,</span>
<a href="#l9.493"></a><span id="l9.493" class="difflineplus">+                                             nsIMsgFolder* dstFolder) {</span>
<a href="#l9.494"></a><span id="l9.494">   nsCopyRequest* copyRequest = nullptr;</span>
<a href="#l9.495"></a><span id="l9.495">   uint32_t cnt = m_copyRequests.Length();</span>
<a href="#l9.496"></a><span id="l9.496" class="difflineminus">-  for (uint32_t i = 0; i &lt; cnt; i++)</span>
<a href="#l9.497"></a><span id="l9.497" class="difflineminus">-  {</span>
<a href="#l9.498"></a><span id="l9.498" class="difflineplus">+  for (uint32_t i = 0; i &lt; cnt; i++) {</span>
<a href="#l9.499"></a><span id="l9.499">     copyRequest = m_copyRequests.ElementAt(i);</span>
<a href="#l9.500"></a><span id="l9.500">     if (copyRequest-&gt;m_srcSupport.get() == aSupport &amp;&amp;</span>
<a href="#l9.501"></a><span id="l9.501">         copyRequest-&gt;m_dstFolder.get() == dstFolder)</span>
<a href="#l9.502"></a><span id="l9.502">       break;</span>
<a href="#l9.503"></a><span id="l9.503"> </span>
<a href="#l9.504"></a><span id="l9.504">     // When copying folders the notification of the message copy serves as a</span>
<a href="#l9.505"></a><span id="l9.505">     // proxy for the folder copy. Check for that here.</span>
<a href="#l9.506"></a><span id="l9.506" class="difflineminus">-    if (copyRequest-&gt;m_requestType == nsCopyFoldersType)</span>
<a href="#l9.507"></a><span id="l9.507" class="difflineminus">-    {</span>
<a href="#l9.508"></a><span id="l9.508" class="difflineminus">-        // If the src is different then check next request.</span>
<a href="#l9.509"></a><span id="l9.509" class="difflineminus">-        if (copyRequest-&gt;m_srcSupport.get() != aSupport)</span>
<a href="#l9.510"></a><span id="l9.510" class="difflineminus">-        {</span>
<a href="#l9.511"></a><span id="l9.511" class="difflineminus">-          copyRequest = nullptr;</span>
<a href="#l9.512"></a><span id="l9.512" class="difflineminus">-          continue;</span>
<a href="#l9.513"></a><span id="l9.513" class="difflineminus">-        }</span>
<a href="#l9.514"></a><span id="l9.514" class="difflineplus">+    if (copyRequest-&gt;m_requestType == nsCopyFoldersType) {</span>
<a href="#l9.515"></a><span id="l9.515" class="difflineplus">+      // If the src is different then check next request.</span>
<a href="#l9.516"></a><span id="l9.516" class="difflineplus">+      if (copyRequest-&gt;m_srcSupport.get() != aSupport) {</span>
<a href="#l9.517"></a><span id="l9.517" class="difflineplus">+        copyRequest = nullptr;</span>
<a href="#l9.518"></a><span id="l9.518" class="difflineplus">+        continue;</span>
<a href="#l9.519"></a><span id="l9.519" class="difflineplus">+      }</span>
<a href="#l9.520"></a><span id="l9.520"> </span>
<a href="#l9.521"></a><span id="l9.521" class="difflineminus">-        // See if the parent of the copied folder is the same as the one when the request was made.</span>
<a href="#l9.522"></a><span id="l9.522" class="difflineminus">-        // Note if the destination folder is already a server folder then no need to get parent.</span>
<a href="#l9.523"></a><span id="l9.523" class="difflineminus">-        nsCOMPtr &lt;nsIMsgFolder&gt; parentMsgFolder;</span>
<a href="#l9.524"></a><span id="l9.524" class="difflineminus">-        nsresult rv = NS_OK;</span>
<a href="#l9.525"></a><span id="l9.525" class="difflineminus">-        bool isServer=false;</span>
<a href="#l9.526"></a><span id="l9.526" class="difflineminus">-        dstFolder-&gt;GetIsServer(&amp;isServer);</span>
<a href="#l9.527"></a><span id="l9.527" class="difflineminus">-        if (!isServer)</span>
<a href="#l9.528"></a><span id="l9.528" class="difflineminus">-          rv = dstFolder-&gt;GetParent(getter_AddRefs(parentMsgFolder));</span>
<a href="#l9.529"></a><span id="l9.529" class="difflineminus">-        if ((NS_FAILED(rv)) || (!parentMsgFolder &amp;&amp; !isServer) || (copyRequest-&gt;m_dstFolder.get() != parentMsgFolder))</span>
<a href="#l9.530"></a><span id="l9.530" class="difflineminus">-        {</span>
<a href="#l9.531"></a><span id="l9.531" class="difflineminus">-          copyRequest = nullptr;</span>
<a href="#l9.532"></a><span id="l9.532" class="difflineminus">-          continue;</span>
<a href="#l9.533"></a><span id="l9.533" class="difflineminus">-        }</span>
<a href="#l9.534"></a><span id="l9.534" class="difflineplus">+      // See if the parent of the copied folder is the same as the one when the</span>
<a href="#l9.535"></a><span id="l9.535" class="difflineplus">+      // request was made. Note if the destination folder is already a server</span>
<a href="#l9.536"></a><span id="l9.536" class="difflineplus">+      // folder then no need to get parent.</span>
<a href="#l9.537"></a><span id="l9.537" class="difflineplus">+      nsCOMPtr&lt;nsIMsgFolder&gt; parentMsgFolder;</span>
<a href="#l9.538"></a><span id="l9.538" class="difflineplus">+      nsresult rv = NS_OK;</span>
<a href="#l9.539"></a><span id="l9.539" class="difflineplus">+      bool isServer = false;</span>
<a href="#l9.540"></a><span id="l9.540" class="difflineplus">+      dstFolder-&gt;GetIsServer(&amp;isServer);</span>
<a href="#l9.541"></a><span id="l9.541" class="difflineplus">+      if (!isServer) rv = dstFolder-&gt;GetParent(getter_AddRefs(parentMsgFolder));</span>
<a href="#l9.542"></a><span id="l9.542" class="difflineplus">+      if ((NS_FAILED(rv)) || (!parentMsgFolder &amp;&amp; !isServer) ||</span>
<a href="#l9.543"></a><span id="l9.543" class="difflineplus">+          (copyRequest-&gt;m_dstFolder.get() != parentMsgFolder)) {</span>
<a href="#l9.544"></a><span id="l9.544" class="difflineplus">+        copyRequest = nullptr;</span>
<a href="#l9.545"></a><span id="l9.545" class="difflineplus">+        continue;</span>
<a href="#l9.546"></a><span id="l9.546" class="difflineplus">+      }</span>
<a href="#l9.547"></a><span id="l9.547"> </span>
<a href="#l9.548"></a><span id="l9.548" class="difflineminus">-        // Now checks if the folder name is the same.</span>
<a href="#l9.549"></a><span id="l9.549" class="difflineminus">-        nsString folderName;</span>
<a href="#l9.550"></a><span id="l9.550" class="difflineminus">-        rv = dstFolder-&gt;GetName(folderName);</span>
<a href="#l9.551"></a><span id="l9.551" class="difflineminus">-        if (NS_FAILED(rv))</span>
<a href="#l9.552"></a><span id="l9.552" class="difflineminus">-        {</span>
<a href="#l9.553"></a><span id="l9.553" class="difflineminus">-          copyRequest = nullptr;</span>
<a href="#l9.554"></a><span id="l9.554" class="difflineminus">-          continue;</span>
<a href="#l9.555"></a><span id="l9.555" class="difflineminus">-        }</span>
<a href="#l9.556"></a><span id="l9.556" class="difflineplus">+      // Now checks if the folder name is the same.</span>
<a href="#l9.557"></a><span id="l9.557" class="difflineplus">+      nsString folderName;</span>
<a href="#l9.558"></a><span id="l9.558" class="difflineplus">+      rv = dstFolder-&gt;GetName(folderName);</span>
<a href="#l9.559"></a><span id="l9.559" class="difflineplus">+      if (NS_FAILED(rv)) {</span>
<a href="#l9.560"></a><span id="l9.560" class="difflineplus">+        copyRequest = nullptr;</span>
<a href="#l9.561"></a><span id="l9.561" class="difflineplus">+        continue;</span>
<a href="#l9.562"></a><span id="l9.562" class="difflineplus">+      }</span>
<a href="#l9.563"></a><span id="l9.563"> </span>
<a href="#l9.564"></a><span id="l9.564" class="difflineminus">-        if (copyRequest-&gt;m_dstFolderName == folderName)</span>
<a href="#l9.565"></a><span id="l9.565" class="difflineminus">-          break;</span>
<a href="#l9.566"></a><span id="l9.566" class="difflineminus">-    }</span>
<a href="#l9.567"></a><span id="l9.567" class="difflineminus">-    else</span>
<a href="#l9.568"></a><span id="l9.568" class="difflineminus">-        copyRequest = nullptr;</span>
<a href="#l9.569"></a><span id="l9.569" class="difflineplus">+      if (copyRequest-&gt;m_dstFolderName == folderName) break;</span>
<a href="#l9.570"></a><span id="l9.570" class="difflineplus">+    } else</span>
<a href="#l9.571"></a><span id="l9.571" class="difflineplus">+      copyRequest = nullptr;</span>
<a href="#l9.572"></a><span id="l9.572">   }</span>
<a href="#l9.573"></a><span id="l9.573"> </span>
<a href="#l9.574"></a><span id="l9.574">   return copyRequest;</span>
<a href="#l9.575"></a><span id="l9.575"> }</span>
<a href="#l9.576"></a><span id="l9.576"> </span>
<a href="#l9.577"></a><span id="l9.577"> NS_IMPL_ISUPPORTS(nsMsgCopyService, nsIMsgCopyService)</span>
<a href="#l9.578"></a><span id="l9.578"> </span>
<a href="#l9.579"></a><span id="l9.579"> NS_IMETHODIMP</span>
<a href="#l9.580"></a><span id="l9.580"> nsMsgCopyService::CopyMessages(nsIMsgFolder* srcFolder, /* UI src folder */</span>
<a href="#l9.581"></a><span id="l9.581" class="difflineminus">-                               nsIArray* messages,</span>
<a href="#l9.582"></a><span id="l9.582" class="difflineminus">-                               nsIMsgFolder* dstFolder,</span>
<a href="#l9.583"></a><span id="l9.583" class="difflineminus">-                               bool isMove,</span>
<a href="#l9.584"></a><span id="l9.584" class="difflineminus">-                               nsIMsgCopyServiceListener* listener,</span>
<a href="#l9.585"></a><span id="l9.585" class="difflineminus">-                               nsIMsgWindow* window,</span>
<a href="#l9.586"></a><span id="l9.586" class="difflineminus">-                               bool allowUndo)</span>
<a href="#l9.587"></a><span id="l9.587" class="difflineminus">-{</span>
<a href="#l9.588"></a><span id="l9.588" class="difflineplus">+                               nsIArray* messages, nsIMsgFolder* dstFolder,</span>
<a href="#l9.589"></a><span id="l9.589" class="difflineplus">+                               bool isMove, nsIMsgCopyServiceListener* listener,</span>
<a href="#l9.590"></a><span id="l9.590" class="difflineplus">+                               nsIMsgWindow* window, bool allowUndo) {</span>
<a href="#l9.591"></a><span id="l9.591">   NS_ENSURE_ARG_POINTER(srcFolder);</span>
<a href="#l9.592"></a><span id="l9.592">   NS_ENSURE_ARG_POINTER(messages);</span>
<a href="#l9.593"></a><span id="l9.593">   NS_ENSURE_ARG_POINTER(dstFolder);</span>
<a href="#l9.594"></a><span id="l9.594"> </span>
<a href="#l9.595"></a><span id="l9.595">   MOZ_LOG(gCopyServiceLog, mozilla::LogLevel::Debug, (&quot;CopyMessages&quot;));</span>
<a href="#l9.596"></a><span id="l9.596"> </span>
<a href="#l9.597"></a><span id="l9.597" class="difflineminus">-  if (srcFolder == dstFolder)</span>
<a href="#l9.598"></a><span id="l9.598" class="difflineminus">-  {</span>
<a href="#l9.599"></a><span id="l9.599" class="difflineplus">+  if (srcFolder == dstFolder) {</span>
<a href="#l9.600"></a><span id="l9.600">     NS_ERROR(&quot;src and dest folders for msg copy can't be the same&quot;);</span>
<a href="#l9.601"></a><span id="l9.601">     return NS_ERROR_FAILURE;</span>
<a href="#l9.602"></a><span id="l9.602">   }</span>
<a href="#l9.603"></a><span id="l9.603">   nsCopyRequest* copyRequest;</span>
<a href="#l9.604"></a><span id="l9.604">   nsCopySource* copySource = nullptr;</span>
<a href="#l9.605"></a><span id="l9.605">   nsCOMArray&lt;nsIMsgDBHdr&gt; msgArray;</span>
<a href="#l9.606"></a><span id="l9.606">   uint32_t cnt;</span>
<a href="#l9.607"></a><span id="l9.607">   nsCOMPtr&lt;nsIMsgDBHdr&gt; msg;</span>
<a href="#l9.608"></a><span id="l9.608" class="difflineat">@@ -461,250 +387,216 @@ nsMsgCopyService::CopyMessages(nsIMsgFol</span>
<a href="#l9.609"></a><span id="l9.609"> </span>
<a href="#l9.610"></a><span id="l9.610">   // XXX TODO</span>
<a href="#l9.611"></a><span id="l9.611">   // JUNK MAIL RELATED</span>
<a href="#l9.612"></a><span id="l9.612">   // make sure dest folder exists</span>
<a href="#l9.613"></a><span id="l9.613">   // and has proper flags, before we start copying?</span>
<a href="#l9.614"></a><span id="l9.614"> </span>
<a href="#l9.615"></a><span id="l9.615">   // bail early if nothing to do</span>
<a href="#l9.616"></a><span id="l9.616">   messages-&gt;GetLength(&amp;cnt);</span>
<a href="#l9.617"></a><span id="l9.617" class="difflineminus">-  if (!cnt)</span>
<a href="#l9.618"></a><span id="l9.618" class="difflineminus">-  {</span>
<a href="#l9.619"></a><span id="l9.619" class="difflineminus">-    if (listener)</span>
<a href="#l9.620"></a><span id="l9.620" class="difflineminus">-    {</span>
<a href="#l9.621"></a><span id="l9.621" class="difflineplus">+  if (!cnt) {</span>
<a href="#l9.622"></a><span id="l9.622" class="difflineplus">+    if (listener) {</span>
<a href="#l9.623"></a><span id="l9.623">       listener-&gt;OnStartCopy();</span>
<a href="#l9.624"></a><span id="l9.624">       listener-&gt;OnStopCopy(NS_OK);</span>
<a href="#l9.625"></a><span id="l9.625">     }</span>
<a href="#l9.626"></a><span id="l9.626">     return NS_OK;</span>
<a href="#l9.627"></a><span id="l9.627">   }</span>
<a href="#l9.628"></a><span id="l9.628"> </span>
<a href="#l9.629"></a><span id="l9.629">   copyRequest = new nsCopyRequest();</span>
<a href="#l9.630"></a><span id="l9.630" class="difflineminus">-  if (!copyRequest)</span>
<a href="#l9.631"></a><span id="l9.631" class="difflineminus">-    return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l9.632"></a><span id="l9.632" class="difflineplus">+  if (!copyRequest) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l9.633"></a><span id="l9.633"> </span>
<a href="#l9.634"></a><span id="l9.634">   aSupport = do_QueryInterface(srcFolder, &amp;rv);</span>
<a href="#l9.635"></a><span id="l9.635"> </span>
<a href="#l9.636"></a><span id="l9.636">   rv = copyRequest-&gt;Init(nsCopyMessagesType, aSupport, dstFolder, isMove,</span>
<a href="#l9.637"></a><span id="l9.637" class="difflineminus">-                        0 /* new msg flags, not used */, EmptyCString(),</span>
<a href="#l9.638"></a><span id="l9.638" class="difflineminus">-                        listener, window, allowUndo);</span>
<a href="#l9.639"></a><span id="l9.639" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l9.640"></a><span id="l9.640" class="difflineminus">-    goto done;</span>
<a href="#l9.641"></a><span id="l9.641" class="difflineplus">+                         0 /* new msg flags, not used */, EmptyCString(),</span>
<a href="#l9.642"></a><span id="l9.642" class="difflineplus">+                         listener, window, allowUndo);</span>
<a href="#l9.643"></a><span id="l9.643" class="difflineplus">+  if (NS_FAILED(rv)) goto done;</span>
<a href="#l9.644"></a><span id="l9.644"> </span>
<a href="#l9.645"></a><span id="l9.645">   if (MOZ_LOG_TEST(gCopyServiceLog, mozilla::LogLevel::Info))</span>
<a href="#l9.646"></a><span id="l9.646">     LogCopyRequest(&quot;CopyMessages request&quot;, copyRequest);</span>
<a href="#l9.647"></a><span id="l9.647"> </span>
<a href="#l9.648"></a><span id="l9.648">   // duplicate the message array so we could sort the messages by it's</span>
<a href="#l9.649"></a><span id="l9.649">   // folder easily</span>
<a href="#l9.650"></a><span id="l9.650" class="difflineminus">-  for (uint32_t i = 0; i &lt; cnt; i++)</span>
<a href="#l9.651"></a><span id="l9.651" class="difflineminus">-  {</span>
<a href="#l9.652"></a><span id="l9.652" class="difflineplus">+  for (uint32_t i = 0; i &lt; cnt; i++) {</span>
<a href="#l9.653"></a><span id="l9.653">     nsCOMPtr&lt;nsIMsgDBHdr&gt; currMsg = do_QueryElementAt(messages, i);</span>
<a href="#l9.654"></a><span id="l9.654">     msgArray.AppendObject(currMsg);</span>
<a href="#l9.655"></a><span id="l9.655">   }</span>
<a href="#l9.656"></a><span id="l9.656"> </span>
<a href="#l9.657"></a><span id="l9.657">   cnt = msgArray.Count();</span>
<a href="#l9.658"></a><span id="l9.658"> </span>
<a href="#l9.659"></a><span id="l9.659" class="difflineminus">-  while (cnt-- &gt; 0)</span>
<a href="#l9.660"></a><span id="l9.660" class="difflineminus">-  {</span>
<a href="#l9.661"></a><span id="l9.661" class="difflineplus">+  while (cnt-- &gt; 0) {</span>
<a href="#l9.662"></a><span id="l9.662">     msg = msgArray[cnt];</span>
<a href="#l9.663"></a><span id="l9.663">     rv = msg-&gt;GetFolder(getter_AddRefs(curFolder));</span>
<a href="#l9.664"></a><span id="l9.664"> </span>
<a href="#l9.665"></a><span id="l9.665" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l9.666"></a><span id="l9.666" class="difflineminus">-      goto done;</span>
<a href="#l9.667"></a><span id="l9.667" class="difflineminus">-    if (!copySource)</span>
<a href="#l9.668"></a><span id="l9.668" class="difflineminus">-    {</span>
<a href="#l9.669"></a><span id="l9.669" class="difflineplus">+    if (NS_FAILED(rv)) goto done;</span>
<a href="#l9.670"></a><span id="l9.670" class="difflineplus">+    if (!copySource) {</span>
<a href="#l9.671"></a><span id="l9.671">       copySource = copyRequest-&gt;AddNewCopySource(curFolder);</span>
<a href="#l9.672"></a><span id="l9.672" class="difflineminus">-      if (!copySource)</span>
<a href="#l9.673"></a><span id="l9.673" class="difflineminus">-      {</span>
<a href="#l9.674"></a><span id="l9.674" class="difflineminus">-         rv = NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l9.675"></a><span id="l9.675" class="difflineminus">-         goto done;</span>
<a href="#l9.676"></a><span id="l9.676" class="difflineplus">+      if (!copySource) {</span>
<a href="#l9.677"></a><span id="l9.677" class="difflineplus">+        rv = NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l9.678"></a><span id="l9.678" class="difflineplus">+        goto done;</span>
<a href="#l9.679"></a><span id="l9.679">       }</span>
<a href="#l9.680"></a><span id="l9.680">     }</span>
<a href="#l9.681"></a><span id="l9.681"> </span>
<a href="#l9.682"></a><span id="l9.682" class="difflineminus">-    if (curFolder == copySource-&gt;m_msgFolder)</span>
<a href="#l9.683"></a><span id="l9.683" class="difflineminus">-    {</span>
<a href="#l9.684"></a><span id="l9.684" class="difflineplus">+    if (curFolder == copySource-&gt;m_msgFolder) {</span>
<a href="#l9.685"></a><span id="l9.685">       copySource-&gt;AddMessage(msg);</span>
<a href="#l9.686"></a><span id="l9.686">       msgArray.RemoveObjectAt(cnt);</span>
<a href="#l9.687"></a><span id="l9.687">     }</span>
<a href="#l9.688"></a><span id="l9.688"> </span>
<a href="#l9.689"></a><span id="l9.689" class="difflineminus">-    if (cnt == 0)</span>
<a href="#l9.690"></a><span id="l9.690" class="difflineminus">-    {</span>
<a href="#l9.691"></a><span id="l9.691" class="difflineplus">+    if (cnt == 0) {</span>
<a href="#l9.692"></a><span id="l9.692">       cnt = msgArray.Count();</span>
<a href="#l9.693"></a><span id="l9.693" class="difflineminus">-      if (cnt &gt; 0)</span>
<a href="#l9.694"></a><span id="l9.694" class="difflineminus">-        copySource = nullptr; // * force to create a new one and</span>
<a href="#l9.695"></a><span id="l9.695" class="difflineminus">-                             // * continue grouping the messages</span>
<a href="#l9.696"></a><span id="l9.696" class="difflineplus">+      if (cnt &gt; 0) {</span>
<a href="#l9.697"></a><span id="l9.697" class="difflineplus">+        // Force to create a new one and continue grouping the messages.</span>
<a href="#l9.698"></a><span id="l9.698" class="difflineplus">+        copySource = nullptr;</span>
<a href="#l9.699"></a><span id="l9.699" class="difflineplus">+      }</span>
<a href="#l9.700"></a><span id="l9.700">     }</span>
<a href="#l9.701"></a><span id="l9.701">   }</span>
<a href="#l9.702"></a><span id="l9.702"> </span>
<a href="#l9.703"></a><span id="l9.703">   // undo stuff</span>
<a href="#l9.704"></a><span id="l9.704" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; copyRequest-&gt;m_allowUndo &amp;&amp; copyRequest-&gt;m_copySourceArray.Length() &gt; 1 &amp;&amp;</span>
<a href="#l9.705"></a><span id="l9.705" class="difflineminus">-      copyRequest-&gt;m_txnMgr)</span>
<a href="#l9.706"></a><span id="l9.706" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; copyRequest-&gt;m_allowUndo &amp;&amp;</span>
<a href="#l9.707"></a><span id="l9.707" class="difflineplus">+      copyRequest-&gt;m_copySourceArray.Length() &gt; 1 &amp;&amp; copyRequest-&gt;m_txnMgr)</span>
<a href="#l9.708"></a><span id="l9.708">     copyRequest-&gt;m_txnMgr-&gt;BeginBatch(nullptr);</span>
<a href="#l9.709"></a><span id="l9.709"> </span>
<a href="#l9.710"></a><span id="l9.710"> done:</span>
<a href="#l9.711"></a><span id="l9.711"> </span>
<a href="#l9.712"></a><span id="l9.712" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l9.713"></a><span id="l9.713" class="difflineminus">-      delete copyRequest;</span>
<a href="#l9.714"></a><span id="l9.714" class="difflineminus">-    else</span>
<a href="#l9.715"></a><span id="l9.715" class="difflineminus">-      rv = DoCopy(copyRequest);</span>
<a href="#l9.716"></a><span id="l9.716" class="difflineplus">+  if (NS_FAILED(rv))</span>
<a href="#l9.717"></a><span id="l9.717" class="difflineplus">+    delete copyRequest;</span>
<a href="#l9.718"></a><span id="l9.718" class="difflineplus">+  else</span>
<a href="#l9.719"></a><span id="l9.719" class="difflineplus">+    rv = DoCopy(copyRequest);</span>
<a href="#l9.720"></a><span id="l9.720"> </span>
<a href="#l9.721"></a><span id="l9.721" class="difflineminus">-    return rv;</span>
<a href="#l9.722"></a><span id="l9.722" class="difflineplus">+  return rv;</span>
<a href="#l9.723"></a><span id="l9.723"> }</span>
<a href="#l9.724"></a><span id="l9.724"> </span>
<a href="#l9.725"></a><span id="l9.725"> NS_IMETHODIMP</span>
<a href="#l9.726"></a><span id="l9.726" class="difflineminus">-nsMsgCopyService::CopyFolders(nsIArray* folders,</span>
<a href="#l9.727"></a><span id="l9.727" class="difflineminus">-                              nsIMsgFolder* dstFolder,</span>
<a href="#l9.728"></a><span id="l9.728" class="difflineminus">-                              bool isMove,</span>
<a href="#l9.729"></a><span id="l9.729" class="difflineminus">-                              nsIMsgCopyServiceListener* listener,</span>
<a href="#l9.730"></a><span id="l9.730" class="difflineminus">-                              nsIMsgWindow* window)</span>
<a href="#l9.731"></a><span id="l9.731" class="difflineminus">-{</span>
<a href="#l9.732"></a><span id="l9.732" class="difflineplus">+nsMsgCopyService::CopyFolders(nsIArray* folders, nsIMsgFolder* dstFolder,</span>
<a href="#l9.733"></a><span id="l9.733" class="difflineplus">+                              bool isMove, nsIMsgCopyServiceListener* listener,</span>
<a href="#l9.734"></a><span id="l9.734" class="difflineplus">+                              nsIMsgWindow* window) {</span>
<a href="#l9.735"></a><span id="l9.735">   NS_ENSURE_ARG_POINTER(folders);</span>
<a href="#l9.736"></a><span id="l9.736">   NS_ENSURE_ARG_POINTER(dstFolder);</span>
<a href="#l9.737"></a><span id="l9.737">   nsCopyRequest* copyRequest;</span>
<a href="#l9.738"></a><span id="l9.738">   nsCopySource* copySource = nullptr;</span>
<a href="#l9.739"></a><span id="l9.739">   nsresult rv;</span>
<a href="#l9.740"></a><span id="l9.740">   uint32_t cnt;</span>
<a href="#l9.741"></a><span id="l9.741">   nsCOMPtr&lt;nsIMsgFolder&gt; curFolder;</span>
<a href="#l9.742"></a><span id="l9.742">   nsCOMPtr&lt;nsISupports&gt; support;</span>
<a href="#l9.743"></a><span id="l9.743"> </span>
<a href="#l9.744"></a><span id="l9.744" class="difflineminus">-  rv = folders-&gt;GetLength(&amp;cnt);   //if cnt is zero it cannot to get this point, will be detected earlier</span>
<a href="#l9.745"></a><span id="l9.745" class="difflineplus">+  // If cnt is zero it cannot to get this point, will be detected earlier.</span>
<a href="#l9.746"></a><span id="l9.746" class="difflineplus">+  rv = folders-&gt;GetLength(&amp;cnt);</span>
<a href="#l9.747"></a><span id="l9.747">   if (cnt &gt; 1)</span>
<a href="#l9.748"></a><span id="l9.748" class="difflineminus">-    NS_ASSERTION((NS_SUCCEEDED(rv)),&quot;More than one folders to copy&quot;);</span>
<a href="#l9.749"></a><span id="l9.749" class="difflineplus">+    NS_ASSERTION((NS_SUCCEEDED(rv)), &quot;More than one folders to copy&quot;);</span>
<a href="#l9.750"></a><span id="l9.750"> </span>
<a href="#l9.751"></a><span id="l9.751">   support = do_QueryElementAt(folders, 0);</span>
<a href="#l9.752"></a><span id="l9.752"> </span>
<a href="#l9.753"></a><span id="l9.753">   copyRequest = new nsCopyRequest();</span>
<a href="#l9.754"></a><span id="l9.754">   if (!copyRequest) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l9.755"></a><span id="l9.755"> </span>
<a href="#l9.756"></a><span id="l9.756" class="difflineminus">-  rv = copyRequest-&gt;Init(nsCopyFoldersType, support, dstFolder,</span>
<a href="#l9.757"></a><span id="l9.757" class="difflineminus">-    isMove, 0 /* new msg flags, not used */ , EmptyCString(), listener, window, false);</span>
<a href="#l9.758"></a><span id="l9.758" class="difflineplus">+  rv = copyRequest-&gt;Init(nsCopyFoldersType, support, dstFolder, isMove,</span>
<a href="#l9.759"></a><span id="l9.759" class="difflineplus">+                         0 /* new msg flags, not used */, EmptyCString(),</span>
<a href="#l9.760"></a><span id="l9.760" class="difflineplus">+                         listener, window, false);</span>
<a href="#l9.761"></a><span id="l9.761">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.762"></a><span id="l9.762"> </span>
<a href="#l9.763"></a><span id="l9.763">   curFolder = do_QueryInterface(support, &amp;rv);</span>
<a href="#l9.764"></a><span id="l9.764">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.765"></a><span id="l9.765"> </span>
<a href="#l9.766"></a><span id="l9.766">   copySource = copyRequest-&gt;AddNewCopySource(curFolder);</span>
<a href="#l9.767"></a><span id="l9.767" class="difflineminus">-  if (!copySource)</span>
<a href="#l9.768"></a><span id="l9.768" class="difflineminus">-    rv = NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l9.769"></a><span id="l9.769" class="difflineplus">+  if (!copySource) rv = NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l9.770"></a><span id="l9.770"> </span>
<a href="#l9.771"></a><span id="l9.771" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l9.772"></a><span id="l9.772" class="difflineminus">-  {</span>
<a href="#l9.773"></a><span id="l9.773" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l9.774"></a><span id="l9.774">     delete copyRequest;</span>
<a href="#l9.775"></a><span id="l9.775">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.776"></a><span id="l9.776" class="difflineminus">-  }</span>
<a href="#l9.777"></a><span id="l9.777" class="difflineminus">-  else</span>
<a href="#l9.778"></a><span id="l9.778" class="difflineplus">+  } else</span>
<a href="#l9.779"></a><span id="l9.779">     rv = DoCopy(copyRequest);</span>
<a href="#l9.780"></a><span id="l9.780"> </span>
<a href="#l9.781"></a><span id="l9.781">   return rv;</span>
<a href="#l9.782"></a><span id="l9.782"> }</span>
<a href="#l9.783"></a><span id="l9.783"> </span>
<a href="#l9.784"></a><span id="l9.784"> NS_IMETHODIMP</span>
<a href="#l9.785"></a><span id="l9.785" class="difflineminus">-nsMsgCopyService::CopyFileMessage(nsIFile* file,</span>
<a href="#l9.786"></a><span id="l9.786" class="difflineminus">-                                  nsIMsgFolder* dstFolder,</span>
<a href="#l9.787"></a><span id="l9.787" class="difflineminus">-                                  nsIMsgDBHdr* msgToReplace,</span>
<a href="#l9.788"></a><span id="l9.788" class="difflineminus">-                                  bool isDraft,</span>
<a href="#l9.789"></a><span id="l9.789" class="difflineplus">+nsMsgCopyService::CopyFileMessage(nsIFile* file, nsIMsgFolder* dstFolder,</span>
<a href="#l9.790"></a><span id="l9.790" class="difflineplus">+                                  nsIMsgDBHdr* msgToReplace, bool isDraft,</span>
<a href="#l9.791"></a><span id="l9.791">                                   uint32_t aMsgFlags,</span>
<a href="#l9.792"></a><span id="l9.792" class="difflineminus">-                                  const nsACString &amp;aNewMsgKeywords,</span>
<a href="#l9.793"></a><span id="l9.793" class="difflineplus">+                                  const nsACString&amp; aNewMsgKeywords,</span>
<a href="#l9.794"></a><span id="l9.794">                                   nsIMsgCopyServiceListener* listener,</span>
<a href="#l9.795"></a><span id="l9.795" class="difflineminus">-                                  nsIMsgWindow* window)</span>
<a href="#l9.796"></a><span id="l9.796" class="difflineminus">-{</span>
<a href="#l9.797"></a><span id="l9.797" class="difflineplus">+                                  nsIMsgWindow* window) {</span>
<a href="#l9.798"></a><span id="l9.798">   nsresult rv = NS_ERROR_NULL_POINTER;</span>
<a href="#l9.799"></a><span id="l9.799">   nsCopyRequest* copyRequest;</span>
<a href="#l9.800"></a><span id="l9.800">   nsCopySource* copySource = nullptr;</span>
<a href="#l9.801"></a><span id="l9.801">   nsCOMPtr&lt;nsISupports&gt; fileSupport;</span>
<a href="#l9.802"></a><span id="l9.802">   nsCOMPtr&lt;nsITransactionManager&gt; txnMgr;</span>
<a href="#l9.803"></a><span id="l9.803"> </span>
<a href="#l9.804"></a><span id="l9.804">   NS_ENSURE_ARG_POINTER(file);</span>
<a href="#l9.805"></a><span id="l9.805">   NS_ENSURE_ARG_POINTER(dstFolder);</span>
<a href="#l9.806"></a><span id="l9.806"> </span>
<a href="#l9.807"></a><span id="l9.807" class="difflineminus">-  if (window)</span>
<a href="#l9.808"></a><span id="l9.808" class="difflineminus">-    window-&gt;GetTransactionManager(getter_AddRefs(txnMgr));</span>
<a href="#l9.809"></a><span id="l9.809" class="difflineplus">+  if (window) window-&gt;GetTransactionManager(getter_AddRefs(txnMgr));</span>
<a href="#l9.810"></a><span id="l9.810">   copyRequest = new nsCopyRequest();</span>
<a href="#l9.811"></a><span id="l9.811">   if (!copyRequest) return rv;</span>
<a href="#l9.812"></a><span id="l9.812">   fileSupport = do_QueryInterface(file, &amp;rv);</span>
<a href="#l9.813"></a><span id="l9.813">   if (NS_FAILED(rv)) goto done;</span>
<a href="#l9.814"></a><span id="l9.814"> </span>
<a href="#l9.815"></a><span id="l9.815" class="difflineminus">-  rv = copyRequest-&gt;Init(nsCopyFileMessageType, fileSupport, dstFolder,</span>
<a href="#l9.816"></a><span id="l9.816" class="difflineminus">-                         isDraft, aMsgFlags, aNewMsgKeywords, listener, window, false);</span>
<a href="#l9.817"></a><span id="l9.817" class="difflineplus">+  rv = copyRequest-&gt;Init(nsCopyFileMessageType, fileSupport, dstFolder, isDraft,</span>
<a href="#l9.818"></a><span id="l9.818" class="difflineplus">+                         aMsgFlags, aNewMsgKeywords, listener, window, false);</span>
<a href="#l9.819"></a><span id="l9.819">   if (NS_FAILED(rv)) goto done;</span>
<a href="#l9.820"></a><span id="l9.820"> </span>
<a href="#l9.821"></a><span id="l9.821" class="difflineminus">-  if (msgToReplace)</span>
<a href="#l9.822"></a><span id="l9.822" class="difflineminus">-  {</span>
<a href="#l9.823"></a><span id="l9.823" class="difflineplus">+  if (msgToReplace) {</span>
<a href="#l9.824"></a><span id="l9.824">     // The actual source of the message is a file not a folder, but</span>
<a href="#l9.825"></a><span id="l9.825">     // we still need an nsCopySource to reference the old message header</span>
<a href="#l9.826"></a><span id="l9.826">     // which will be used to recover message metadata.</span>
<a href="#l9.827"></a><span id="l9.827">     copySource = copyRequest-&gt;AddNewCopySource(nullptr);</span>
<a href="#l9.828"></a><span id="l9.828" class="difflineminus">-    if (!copySource)</span>
<a href="#l9.829"></a><span id="l9.829" class="difflineminus">-    {</span>
<a href="#l9.830"></a><span id="l9.830" class="difflineminus">-        rv = NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l9.831"></a><span id="l9.831" class="difflineminus">-        goto done;</span>
<a href="#l9.832"></a><span id="l9.832" class="difflineplus">+    if (!copySource) {</span>
<a href="#l9.833"></a><span id="l9.833" class="difflineplus">+      rv = NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l9.834"></a><span id="l9.834" class="difflineplus">+      goto done;</span>
<a href="#l9.835"></a><span id="l9.835">     }</span>
<a href="#l9.836"></a><span id="l9.836">     copySource-&gt;AddMessage(msgToReplace);</span>
<a href="#l9.837"></a><span id="l9.837">   }</span>
<a href="#l9.838"></a><span id="l9.838"> </span>
<a href="#l9.839"></a><span id="l9.839"> done:</span>
<a href="#l9.840"></a><span id="l9.840" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l9.841"></a><span id="l9.841" class="difflineminus">-    {</span>
<a href="#l9.842"></a><span id="l9.842" class="difflineminus">-      delete copyRequest;</span>
<a href="#l9.843"></a><span id="l9.843" class="difflineminus">-    }</span>
<a href="#l9.844"></a><span id="l9.844" class="difflineminus">-    else</span>
<a href="#l9.845"></a><span id="l9.845" class="difflineminus">-    {</span>
<a href="#l9.846"></a><span id="l9.846" class="difflineminus">-      rv = DoCopy(copyRequest);</span>
<a href="#l9.847"></a><span id="l9.847" class="difflineminus">-    }</span>
<a href="#l9.848"></a><span id="l9.848" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l9.849"></a><span id="l9.849" class="difflineplus">+    delete copyRequest;</span>
<a href="#l9.850"></a><span id="l9.850" class="difflineplus">+  } else {</span>
<a href="#l9.851"></a><span id="l9.851" class="difflineplus">+    rv = DoCopy(copyRequest);</span>
<a href="#l9.852"></a><span id="l9.852" class="difflineplus">+  }</span>
<a href="#l9.853"></a><span id="l9.853"> </span>
<a href="#l9.854"></a><span id="l9.854" class="difflineminus">-    return rv;</span>
<a href="#l9.855"></a><span id="l9.855" class="difflineplus">+  return rv;</span>
<a href="#l9.856"></a><span id="l9.856"> }</span>
<a href="#l9.857"></a><span id="l9.857"> </span>
<a href="#l9.858"></a><span id="l9.858"> NS_IMETHODIMP</span>
<a href="#l9.859"></a><span id="l9.859"> nsMsgCopyService::NotifyCompletion(nsISupports* aSupport,</span>
<a href="#l9.860"></a><span id="l9.860" class="difflineminus">-                                   nsIMsgFolder* dstFolder,</span>
<a href="#l9.861"></a><span id="l9.861" class="difflineminus">-                                   nsresult result)</span>
<a href="#l9.862"></a><span id="l9.862" class="difflineminus">-{</span>
<a href="#l9.863"></a><span id="l9.863" class="difflineplus">+                                   nsIMsgFolder* dstFolder, nsresult result) {</span>
<a href="#l9.864"></a><span id="l9.864">   if (MOZ_LOG_TEST(gCopyServiceLog, mozilla::LogLevel::Info))</span>
<a href="#l9.865"></a><span id="l9.865">     LogCopyCompletion(aSupport, dstFolder);</span>
<a href="#l9.866"></a><span id="l9.866">   nsCopyRequest* copyRequest = nullptr;</span>
<a href="#l9.867"></a><span id="l9.867">   uint32_t numOrigRequests = m_copyRequests.Length();</span>
<a href="#l9.868"></a><span id="l9.868" class="difflineminus">-  do</span>
<a href="#l9.869"></a><span id="l9.869" class="difflineminus">-  {</span>
<a href="#l9.870"></a><span id="l9.870" class="difflineplus">+  do {</span>
<a href="#l9.871"></a><span id="l9.871">     // loop for copy requests, because if we do a cross server folder copy,</span>
<a href="#l9.872"></a><span id="l9.872">     // we'll have a copy request for the folder copy, which will in turn</span>
<a href="#l9.873"></a><span id="l9.873">     // generate a copy request for the messages in the folder, which</span>
<a href="#l9.874"></a><span id="l9.874">     // will have the same src support.</span>
<a href="#l9.875"></a><span id="l9.875">     copyRequest = FindRequest(aSupport, dstFolder);</span>
<a href="#l9.876"></a><span id="l9.876"> </span>
<a href="#l9.877"></a><span id="l9.877" class="difflineminus">-    if (copyRequest)</span>
<a href="#l9.878"></a><span id="l9.878" class="difflineminus">-    {</span>
<a href="#l9.879"></a><span id="l9.879" class="difflineplus">+    if (copyRequest) {</span>
<a href="#l9.880"></a><span id="l9.880">       // ClearRequest can cause a new request to get added to m_copyRequests</span>
<a href="#l9.881"></a><span id="l9.881">       // with matching source and dest folders if the copy listener starts</span>
<a href="#l9.882"></a><span id="l9.882">       // a new copy. We want to ignore any such request here, because it wasn't</span>
<a href="#l9.883"></a><span id="l9.883">       // the one that was completed. So we keep track of how many original</span>
<a href="#l9.884"></a><span id="l9.884">       // requests there were.</span>
<a href="#l9.885"></a><span id="l9.885" class="difflineminus">-      if (m_copyRequests.IndexOf(copyRequest) &gt;= numOrigRequests)</span>
<a href="#l9.886"></a><span id="l9.886" class="difflineminus">-        break;</span>
<a href="#l9.887"></a><span id="l9.887" class="difflineplus">+      if (m_copyRequests.IndexOf(copyRequest) &gt;= numOrigRequests) break;</span>
<a href="#l9.888"></a><span id="l9.888">       // check if this copy request is done by making sure all the</span>
<a href="#l9.889"></a><span id="l9.889">       // sources have been processed.</span>
<a href="#l9.890"></a><span id="l9.890">       int32_t sourceIndex, sourceCount;</span>
<a href="#l9.891"></a><span id="l9.891">       sourceCount = copyRequest-&gt;m_copySourceArray.Length();</span>
<a href="#l9.892"></a><span id="l9.892" class="difflineminus">-      for (sourceIndex = 0; sourceIndex &lt; sourceCount;)</span>
<a href="#l9.893"></a><span id="l9.893" class="difflineminus">-      {</span>
<a href="#l9.894"></a><span id="l9.894" class="difflineminus">-        if (!(copyRequest-&gt;m_copySourceArray.ElementAt(sourceIndex))-&gt;m_processed)</span>
<a href="#l9.895"></a><span id="l9.895" class="difflineminus">-            break;</span>
<a href="#l9.896"></a><span id="l9.896" class="difflineminus">-         sourceIndex++;</span>
<a href="#l9.897"></a><span id="l9.897" class="difflineplus">+      for (sourceIndex = 0; sourceIndex &lt; sourceCount;) {</span>
<a href="#l9.898"></a><span id="l9.898" class="difflineplus">+        if (!(copyRequest-&gt;m_copySourceArray.ElementAt(sourceIndex))</span>
<a href="#l9.899"></a><span id="l9.899" class="difflineplus">+                 -&gt;m_processed)</span>
<a href="#l9.900"></a><span id="l9.900" class="difflineplus">+          break;</span>
<a href="#l9.901"></a><span id="l9.901" class="difflineplus">+        sourceIndex++;</span>
<a href="#l9.902"></a><span id="l9.902">       }</span>
<a href="#l9.903"></a><span id="l9.903">       // if all sources processed, mark the request as processed</span>
<a href="#l9.904"></a><span id="l9.904" class="difflineminus">-      if (sourceIndex &gt;= sourceCount)</span>
<a href="#l9.905"></a><span id="l9.905" class="difflineminus">-        copyRequest-&gt;m_processed = true;</span>
<a href="#l9.906"></a><span id="l9.906" class="difflineplus">+      if (sourceIndex &gt;= sourceCount) copyRequest-&gt;m_processed = true;</span>
<a href="#l9.907"></a><span id="l9.907">       // if this request is done, or failed, clear it.</span>
<a href="#l9.908"></a><span id="l9.908" class="difflineminus">-      if (copyRequest-&gt;m_processed || NS_FAILED(result))</span>
<a href="#l9.909"></a><span id="l9.909" class="difflineminus">-      {</span>
<a href="#l9.910"></a><span id="l9.910" class="difflineplus">+      if (copyRequest-&gt;m_processed || NS_FAILED(result)) {</span>
<a href="#l9.911"></a><span id="l9.911">         ClearRequest(copyRequest, result);</span>
<a href="#l9.912"></a><span id="l9.912">         numOrigRequests--;</span>
<a href="#l9.913"></a><span id="l9.913" class="difflineminus">-      }</span>
<a href="#l9.914"></a><span id="l9.914" class="difflineminus">-      else</span>
<a href="#l9.915"></a><span id="l9.915" class="difflineplus">+      } else</span>
<a href="#l9.916"></a><span id="l9.916">         break;</span>
<a href="#l9.917"></a><span id="l9.917" class="difflineminus">-    }</span>
<a href="#l9.918"></a><span id="l9.918" class="difflineminus">-    else</span>
<a href="#l9.919"></a><span id="l9.919" class="difflineplus">+    } else</span>
<a href="#l9.920"></a><span id="l9.920">       break;</span>
<a href="#l9.921"></a><span id="l9.921" class="difflineminus">-  }</span>
<a href="#l9.922"></a><span id="l9.922" class="difflineminus">-  while (copyRequest);</span>
<a href="#l9.923"></a><span id="l9.923" class="difflineplus">+  } while (copyRequest);</span>
<a href="#l9.924"></a><span id="l9.924"> </span>
<a href="#l9.925"></a><span id="l9.925">   return DoNextCopy();</span>
<a href="#l9.926"></a><span id="l9.926"> }</span>
<a href="#l9.927"></a><span id="l9.927" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/base/src/nsMsgCopyService.h</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgCopyService.h</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -11,84 +11,78 @@</span>
<a href="#l10.4"></a><span id="l10.4"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l10.5"></a><span id="l10.5"> #include &quot;nsIMsgFolder.h&quot;</span>
<a href="#l10.6"></a><span id="l10.6"> #include &quot;nsIMsgHdr.h&quot;</span>
<a href="#l10.7"></a><span id="l10.7"> #include &quot;nsIMsgWindow.h&quot;</span>
<a href="#l10.8"></a><span id="l10.8"> #include &quot;nsIMutableArray.h&quot;</span>
<a href="#l10.9"></a><span id="l10.9"> #include &quot;nsITransactionManager.h&quot;</span>
<a href="#l10.10"></a><span id="l10.10"> #include &quot;nsTArray.h&quot;</span>
<a href="#l10.11"></a><span id="l10.11"> </span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-typedef enum _nsCopyRequestType</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineminus">-{</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineminus">-    nsCopyMessagesType = 0x0,</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineminus">-    nsCopyFileMessageType = 0x1,</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineminus">-    nsCopyFoldersType = 0x2</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineplus">+typedef enum _nsCopyRequestType {</span>
<a href="#l10.18"></a><span id="l10.18" class="difflineplus">+  nsCopyMessagesType = 0x0,</span>
<a href="#l10.19"></a><span id="l10.19" class="difflineplus">+  nsCopyFileMessageType = 0x1,</span>
<a href="#l10.20"></a><span id="l10.20" class="difflineplus">+  nsCopyFoldersType = 0x2</span>
<a href="#l10.21"></a><span id="l10.21"> } nsCopyRequestType;</span>
<a href="#l10.22"></a><span id="l10.22"> </span>
<a href="#l10.23"></a><span id="l10.23"> class nsCopyRequest;</span>
<a href="#l10.24"></a><span id="l10.24"> </span>
<a href="#l10.25"></a><span id="l10.25" class="difflineminus">-class nsCopySource</span>
<a href="#l10.26"></a><span id="l10.26" class="difflineminus">-{</span>
<a href="#l10.27"></a><span id="l10.27" class="difflineminus">-public:</span>
<a href="#l10.28"></a><span id="l10.28" class="difflineminus">-    nsCopySource();</span>
<a href="#l10.29"></a><span id="l10.29" class="difflineminus">-    explicit nsCopySource(nsIMsgFolder* srcFolder);</span>
<a href="#l10.30"></a><span id="l10.30" class="difflineminus">-    ~nsCopySource();</span>
<a href="#l10.31"></a><span id="l10.31" class="difflineminus">-    void AddMessage(nsIMsgDBHdr* aMsg);</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineplus">+class nsCopySource {</span>
<a href="#l10.33"></a><span id="l10.33" class="difflineplus">+ public:</span>
<a href="#l10.34"></a><span id="l10.34" class="difflineplus">+  nsCopySource();</span>
<a href="#l10.35"></a><span id="l10.35" class="difflineplus">+  explicit nsCopySource(nsIMsgFolder* srcFolder);</span>
<a href="#l10.36"></a><span id="l10.36" class="difflineplus">+  ~nsCopySource();</span>
<a href="#l10.37"></a><span id="l10.37" class="difflineplus">+  void AddMessage(nsIMsgDBHdr* aMsg);</span>
<a href="#l10.38"></a><span id="l10.38"> </span>
<a href="#l10.39"></a><span id="l10.39" class="difflineminus">-    nsCOMPtr&lt;nsIMsgFolder&gt; m_msgFolder;</span>
<a href="#l10.40"></a><span id="l10.40" class="difflineminus">-    nsCOMPtr&lt;nsIMutableArray&gt; m_messageArray;</span>
<a href="#l10.41"></a><span id="l10.41" class="difflineminus">-    bool m_processed;</span>
<a href="#l10.42"></a><span id="l10.42" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; m_msgFolder;</span>
<a href="#l10.43"></a><span id="l10.43" class="difflineplus">+  nsCOMPtr&lt;nsIMutableArray&gt; m_messageArray;</span>
<a href="#l10.44"></a><span id="l10.44" class="difflineplus">+  bool m_processed;</span>
<a href="#l10.45"></a><span id="l10.45"> };</span>
<a href="#l10.46"></a><span id="l10.46"> </span>
<a href="#l10.47"></a><span id="l10.47" class="difflineminus">-class nsCopyRequest</span>
<a href="#l10.48"></a><span id="l10.48" class="difflineminus">-{</span>
<a href="#l10.49"></a><span id="l10.49" class="difflineminus">-public:</span>
<a href="#l10.50"></a><span id="l10.50" class="difflineminus">-    nsCopyRequest();</span>
<a href="#l10.51"></a><span id="l10.51" class="difflineminus">-    ~nsCopyRequest();</span>
<a href="#l10.52"></a><span id="l10.52" class="difflineplus">+class nsCopyRequest {</span>
<a href="#l10.53"></a><span id="l10.53" class="difflineplus">+ public:</span>
<a href="#l10.54"></a><span id="l10.54" class="difflineplus">+  nsCopyRequest();</span>
<a href="#l10.55"></a><span id="l10.55" class="difflineplus">+  ~nsCopyRequest();</span>
<a href="#l10.56"></a><span id="l10.56"> </span>
<a href="#l10.57"></a><span id="l10.57" class="difflineminus">-    nsresult Init(nsCopyRequestType type, nsISupports* aSupport,</span>
<a href="#l10.58"></a><span id="l10.58" class="difflineminus">-                  nsIMsgFolder* dstFolder,</span>
<a href="#l10.59"></a><span id="l10.59" class="difflineminus">-                  bool bVal, uint32_t newMsgFlags,</span>
<a href="#l10.60"></a><span id="l10.60" class="difflineminus">-                  const nsACString &amp;newMsgKeywords,</span>
<a href="#l10.61"></a><span id="l10.61" class="difflineminus">-                  nsIMsgCopyServiceListener* listener,</span>
<a href="#l10.62"></a><span id="l10.62" class="difflineminus">-                  nsIMsgWindow *msgWindow, bool allowUndo);</span>
<a href="#l10.63"></a><span id="l10.63" class="difflineminus">-    nsCopySource* AddNewCopySource(nsIMsgFolder* srcFolder);</span>
<a href="#l10.64"></a><span id="l10.64" class="difflineplus">+  nsresult Init(nsCopyRequestType type, nsISupports* aSupport,</span>
<a href="#l10.65"></a><span id="l10.65" class="difflineplus">+                nsIMsgFolder* dstFolder, bool bVal, uint32_t newMsgFlags,</span>
<a href="#l10.66"></a><span id="l10.66" class="difflineplus">+                const nsACString&amp; newMsgKeywords,</span>
<a href="#l10.67"></a><span id="l10.67" class="difflineplus">+                nsIMsgCopyServiceListener* listener, nsIMsgWindow* msgWindow,</span>
<a href="#l10.68"></a><span id="l10.68" class="difflineplus">+                bool allowUndo);</span>
<a href="#l10.69"></a><span id="l10.69" class="difflineplus">+  nsCopySource* AddNewCopySource(nsIMsgFolder* srcFolder);</span>
<a href="#l10.70"></a><span id="l10.70"> </span>
<a href="#l10.71"></a><span id="l10.71" class="difflineminus">-    nsCOMPtr&lt;nsISupports&gt; m_srcSupport; // ui source folder or file spec</span>
<a href="#l10.72"></a><span id="l10.72" class="difflineminus">-    nsCOMPtr&lt;nsIMsgFolder&gt; m_dstFolder;</span>
<a href="#l10.73"></a><span id="l10.73" class="difflineminus">-    nsCOMPtr&lt;nsIMsgWindow&gt; m_msgWindow;</span>
<a href="#l10.74"></a><span id="l10.74" class="difflineminus">-    nsCOMPtr&lt;nsIMsgCopyServiceListener&gt; m_listener;</span>
<a href="#l10.75"></a><span id="l10.75" class="difflineminus">-    nsCOMPtr&lt;nsITransactionManager&gt; m_txnMgr;</span>
<a href="#l10.76"></a><span id="l10.76" class="difflineminus">-    nsCopyRequestType m_requestType;</span>
<a href="#l10.77"></a><span id="l10.77" class="difflineminus">-    bool m_isMoveOrDraftOrTemplate;</span>
<a href="#l10.78"></a><span id="l10.78" class="difflineminus">-    bool m_allowUndo;</span>
<a href="#l10.79"></a><span id="l10.79" class="difflineminus">-    bool m_processed;</span>
<a href="#l10.80"></a><span id="l10.80" class="difflineminus">-    uint32_t m_newMsgFlags;</span>
<a href="#l10.81"></a><span id="l10.81" class="difflineminus">-    nsCString m_newMsgKeywords;</span>
<a href="#l10.82"></a><span id="l10.82" class="difflineminus">-    nsString m_dstFolderName;      // used for copy folder.</span>
<a href="#l10.83"></a><span id="l10.83" class="difflineminus">-    nsTArray&lt;nsCopySource*&gt; m_copySourceArray; // array of nsCopySource</span>
<a href="#l10.84"></a><span id="l10.84" class="difflineplus">+  nsCOMPtr&lt;nsISupports&gt; m_srcSupport;  // ui source folder or file spec</span>
<a href="#l10.85"></a><span id="l10.85" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; m_dstFolder;</span>
<a href="#l10.86"></a><span id="l10.86" class="difflineplus">+  nsCOMPtr&lt;nsIMsgWindow&gt; m_msgWindow;</span>
<a href="#l10.87"></a><span id="l10.87" class="difflineplus">+  nsCOMPtr&lt;nsIMsgCopyServiceListener&gt; m_listener;</span>
<a href="#l10.88"></a><span id="l10.88" class="difflineplus">+  nsCOMPtr&lt;nsITransactionManager&gt; m_txnMgr;</span>
<a href="#l10.89"></a><span id="l10.89" class="difflineplus">+  nsCopyRequestType m_requestType;</span>
<a href="#l10.90"></a><span id="l10.90" class="difflineplus">+  bool m_isMoveOrDraftOrTemplate;</span>
<a href="#l10.91"></a><span id="l10.91" class="difflineplus">+  bool m_allowUndo;</span>
<a href="#l10.92"></a><span id="l10.92" class="difflineplus">+  bool m_processed;</span>
<a href="#l10.93"></a><span id="l10.93" class="difflineplus">+  uint32_t m_newMsgFlags;</span>
<a href="#l10.94"></a><span id="l10.94" class="difflineplus">+  nsCString m_newMsgKeywords;</span>
<a href="#l10.95"></a><span id="l10.95" class="difflineplus">+  nsString m_dstFolderName;                   // used for copy folder.</span>
<a href="#l10.96"></a><span id="l10.96" class="difflineplus">+  nsTArray&lt;nsCopySource*&gt; m_copySourceArray;  // array of nsCopySource</span>
<a href="#l10.97"></a><span id="l10.97"> };</span>
<a href="#l10.98"></a><span id="l10.98"> </span>
<a href="#l10.99"></a><span id="l10.99" class="difflineminus">-class nsMsgCopyService : public nsIMsgCopyService</span>
<a href="#l10.100"></a><span id="l10.100" class="difflineminus">-{</span>
<a href="#l10.101"></a><span id="l10.101" class="difflineminus">-public:</span>
<a href="#l10.102"></a><span id="l10.102" class="difflineplus">+class nsMsgCopyService : public nsIMsgCopyService {</span>
<a href="#l10.103"></a><span id="l10.103" class="difflineplus">+ public:</span>
<a href="#l10.104"></a><span id="l10.104">   nsMsgCopyService();</span>
<a href="#l10.105"></a><span id="l10.105"> </span>
<a href="#l10.106"></a><span id="l10.106">   NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l10.107"></a><span id="l10.107"> </span>
<a href="#l10.108"></a><span id="l10.108">   NS_DECL_NSIMSGCOPYSERVICE</span>
<a href="#l10.109"></a><span id="l10.109"> </span>
<a href="#l10.110"></a><span id="l10.110" class="difflineminus">-private:</span>
<a href="#l10.111"></a><span id="l10.111" class="difflineplus">+ private:</span>
<a href="#l10.112"></a><span id="l10.112">   virtual ~nsMsgCopyService();</span>
<a href="#l10.113"></a><span id="l10.113"> </span>
<a href="#l10.114"></a><span id="l10.114">   nsresult ClearRequest(nsCopyRequest* aRequest, nsresult rv);</span>
<a href="#l10.115"></a><span id="l10.115">   nsresult DoCopy(nsCopyRequest* aRequest);</span>
<a href="#l10.116"></a><span id="l10.116">   nsresult DoNextCopy();</span>
<a href="#l10.117"></a><span id="l10.117">   nsCopyRequest* FindRequest(nsISupports* aSupport, nsIMsgFolder* dstFolder);</span>
<a href="#l10.118"></a><span id="l10.118" class="difflineminus">-  nsresult QueueRequest(nsCopyRequest* aRequest, bool *aCopyImmediately);</span>
<a href="#l10.119"></a><span id="l10.119" class="difflineminus">-  void LogCopyCompletion(nsISupports *aSrc, nsIMsgFolder *aDest);</span>
<a href="#l10.120"></a><span id="l10.120" class="difflineminus">-  void LogCopyRequest(const char *logMsg, nsCopyRequest* aRequest);</span>
<a href="#l10.121"></a><span id="l10.121" class="difflineplus">+  nsresult QueueRequest(nsCopyRequest* aRequest, bool* aCopyImmediately);</span>
<a href="#l10.122"></a><span id="l10.122" class="difflineplus">+  void LogCopyCompletion(nsISupports* aSrc, nsIMsgFolder* aDest);</span>
<a href="#l10.123"></a><span id="l10.123" class="difflineplus">+  void LogCopyRequest(const char* logMsg, nsCopyRequest* aRequest);</span>
<a href="#l10.124"></a><span id="l10.124"> </span>
<a href="#l10.125"></a><span id="l10.125">   nsTArray&lt;nsCopyRequest*&gt; m_copyRequests;</span>
<a href="#l10.126"></a><span id="l10.126"> };</span>
<a href="#l10.127"></a><span id="l10.127"> </span>
<a href="#l10.128"></a><span id="l10.128" class="difflineminus">-</span>
<a href="#l10.129"></a><span id="l10.129"> #endif</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:33Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

