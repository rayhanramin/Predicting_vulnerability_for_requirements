<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 14838:198c9ae2f845e6befd27322346d1d179507a1811</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 198c9ae2f845e6befd27322346d1d179507a1811" />
<meta property="og:url" content="/comm-central/rev/198c9ae2f845e6befd27322346d1d179507a1811" />
<meta property="og:description" content="Cleanup of the chat/ directory, based mostly on bienvenu's review comments in bug 714733." />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 198c9ae2f845e6befd27322346d1d179507a1811 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/198c9ae2f845e6befd27322346d1d179507a1811">shortlog</a> |
<a href="/comm-central/log/198c9ae2f845e6befd27322346d1d179507a1811">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/198c9ae2f845e6befd27322346d1d179507a1811">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/198c9ae2f845e6befd27322346d1d179507a1811">files</a> |
changeset |
<a href="/comm-central/raw-rev/198c9ae2f845e6befd27322346d1d179507a1811">raw</a>  | <a href="/comm-central/archive/198c9ae2f845e6befd27322346d1d179507a1811.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
Cleanup of the chat/ directory, based mostly on bienvenu's review comments in <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=714733">bug 714733</a>.
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#70;&#108;&#111;&#114;&#105;&#97;&#110;&#32;&#81;&#117;&#232;&#122;&#101;&#32;&#60;&#102;&#108;&#111;&#114;&#105;&#97;&#110;&#64;&#105;&#110;&#115;&#116;&#97;&#110;&#116;&#98;&#105;&#114;&#100;&#46;&#111;&#114;&#103;&#62;</td></tr>
<tr><td></td><td class="date age">Mon, 30 Jan 2012 12:46:13 +0100</td></tr>

<tr>
 <td>changeset 14838</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/198c9ae2f845e6befd27322346d1d179507a1811">198c9ae2f845e6befd27322346d1d179507a1811</a></td>
</tr>



<tr>
<td>parent 14837</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/adf88824ec53638d10974d0dac1a70ffd21fb911">adf88824ec53638d10974d0dac1a70ffd21fb911</a>
</td>
</tr>

<tr>
<td>child 14839</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/08230f5588302df76dd59025bef31122e8ebd78a">08230f5588302df76dd59025bef31122e8ebd78a</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=198c9ae2f845e6befd27322346d1d179507a1811">9778</a></td></tr>
<tr><td>push user</td><td>florian@queze.net</td></tr>
<tr><td>push date</td><td class="date age">Sun, 12 Jan 2014 18:25:45 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@f81a23bfefcd [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=f81a23bfefcd0f6ec6215fbde12f8af2bc7749f1">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=f81a23bfefcd0f6ec6215fbde12f8af2bc7749f1&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=f81a23bfefcd0f6ec6215fbde12f8af2bc7749f1&newProject=comm-central&newRevision=279a7aa9624ffb41326b021ff7d8bc68b9b89551&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=f81a23bfefcd0f6ec6215fbde12f8af2bc7749f1&newProject=comm-central&newRevision=279a7aa9624ffb41326b021ff7d8bc68b9b89551&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=f81a23bfefcd0f6ec6215fbde12f8af2bc7749f1&newProject=comm-central&newRevision=279a7aa9624ffb41326b021ff7d8bc68b9b89551&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>

<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=714733">714733</a></td></tr>




</table></div>

<div class="page_body description">Cleanup of the chat/ directory, based mostly on bienvenu's review comments in <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=714733">bug 714733</a>.</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/198c9ae2f845e6befd27322346d1d179507a1811/chat/chat-prefs.js">chat/chat-prefs.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/198c9ae2f845e6befd27322346d1d179507a1811/chat/chat-prefs.js">file</a> |
<a href="/comm-central/annotate/198c9ae2f845e6befd27322346d1d179507a1811/chat/chat-prefs.js">annotate</a> |
<a href="/comm-central/diff/198c9ae2f845e6befd27322346d1d179507a1811/chat/chat-prefs.js">diff</a> |
<a href="/comm-central/comparison/198c9ae2f845e6befd27322346d1d179507a1811/chat/chat-prefs.js">comparison</a> |
<a href="/comm-central/log/198c9ae2f845e6befd27322346d1d179507a1811/chat/chat-prefs.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/198c9ae2f845e6befd27322346d1d179507a1811/chat/components/public/imIAccount.idl">chat/components/public/imIAccount.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/198c9ae2f845e6befd27322346d1d179507a1811/chat/components/public/imIAccount.idl">file</a> |
<a href="/comm-central/annotate/198c9ae2f845e6befd27322346d1d179507a1811/chat/components/public/imIAccount.idl">annotate</a> |
<a href="/comm-central/diff/198c9ae2f845e6befd27322346d1d179507a1811/chat/components/public/imIAccount.idl">diff</a> |
<a href="/comm-central/comparison/198c9ae2f845e6befd27322346d1d179507a1811/chat/components/public/imIAccount.idl">comparison</a> |
<a href="/comm-central/log/198c9ae2f845e6befd27322346d1d179507a1811/chat/components/public/imIAccount.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/198c9ae2f845e6befd27322346d1d179507a1811/chat/components/public/imIContactsService.idl">chat/components/public/imIContactsService.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/198c9ae2f845e6befd27322346d1d179507a1811/chat/components/public/imIContactsService.idl">file</a> |
<a href="/comm-central/annotate/198c9ae2f845e6befd27322346d1d179507a1811/chat/components/public/imIContactsService.idl">annotate</a> |
<a href="/comm-central/diff/198c9ae2f845e6befd27322346d1d179507a1811/chat/components/public/imIContactsService.idl">diff</a> |
<a href="/comm-central/comparison/198c9ae2f845e6befd27322346d1d179507a1811/chat/components/public/imIContactsService.idl">comparison</a> |
<a href="/comm-central/log/198c9ae2f845e6befd27322346d1d179507a1811/chat/components/public/imIContactsService.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/198c9ae2f845e6befd27322346d1d179507a1811/chat/components/public/imITagsService.idl">chat/components/public/imITagsService.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/198c9ae2f845e6befd27322346d1d179507a1811/chat/components/public/imITagsService.idl">file</a> |
<a href="/comm-central/annotate/198c9ae2f845e6befd27322346d1d179507a1811/chat/components/public/imITagsService.idl">annotate</a> |
<a href="/comm-central/diff/198c9ae2f845e6befd27322346d1d179507a1811/chat/components/public/imITagsService.idl">diff</a> |
<a href="/comm-central/comparison/198c9ae2f845e6befd27322346d1d179507a1811/chat/components/public/imITagsService.idl">comparison</a> |
<a href="/comm-central/log/198c9ae2f845e6befd27322346d1d179507a1811/chat/components/public/imITagsService.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/198c9ae2f845e6befd27322346d1d179507a1811/chat/components/public/prplIMessage.idl">chat/components/public/prplIMessage.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/198c9ae2f845e6befd27322346d1d179507a1811/chat/components/public/prplIMessage.idl">file</a> |
<a href="/comm-central/annotate/198c9ae2f845e6befd27322346d1d179507a1811/chat/components/public/prplIMessage.idl">annotate</a> |
<a href="/comm-central/diff/198c9ae2f845e6befd27322346d1d179507a1811/chat/components/public/prplIMessage.idl">diff</a> |
<a href="/comm-central/comparison/198c9ae2f845e6befd27322346d1d179507a1811/chat/components/public/prplIMessage.idl">comparison</a> |
<a href="/comm-central/log/198c9ae2f845e6befd27322346d1d179507a1811/chat/components/public/prplIMessage.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/198c9ae2f845e6befd27322346d1d179507a1811/chat/components/src/Makefile.in">chat/components/src/Makefile.in</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/198c9ae2f845e6befd27322346d1d179507a1811/chat/components/src/Makefile.in">file</a> |
<a href="/comm-central/annotate/198c9ae2f845e6befd27322346d1d179507a1811/chat/components/src/Makefile.in">annotate</a> |
<a href="/comm-central/diff/198c9ae2f845e6befd27322346d1d179507a1811/chat/components/src/Makefile.in">diff</a> |
<a href="/comm-central/comparison/198c9ae2f845e6befd27322346d1d179507a1811/chat/components/src/Makefile.in">comparison</a> |
<a href="/comm-central/log/198c9ae2f845e6befd27322346d1d179507a1811/chat/components/src/Makefile.in">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/198c9ae2f845e6befd27322346d1d179507a1811/chat/components/src/imAccounts.js">chat/components/src/imAccounts.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/198c9ae2f845e6befd27322346d1d179507a1811/chat/components/src/imAccounts.js">file</a> |
<a href="/comm-central/annotate/198c9ae2f845e6befd27322346d1d179507a1811/chat/components/src/imAccounts.js">annotate</a> |
<a href="/comm-central/diff/198c9ae2f845e6befd27322346d1d179507a1811/chat/components/src/imAccounts.js">diff</a> |
<a href="/comm-central/comparison/198c9ae2f845e6befd27322346d1d179507a1811/chat/components/src/imAccounts.js">comparison</a> |
<a href="/comm-central/log/198c9ae2f845e6befd27322346d1d179507a1811/chat/components/src/imAccounts.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/198c9ae2f845e6befd27322346d1d179507a1811/chat/components/src/imCommands.js">chat/components/src/imCommands.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/198c9ae2f845e6befd27322346d1d179507a1811/chat/components/src/imCommands.js">file</a> |
<a href="/comm-central/annotate/198c9ae2f845e6befd27322346d1d179507a1811/chat/components/src/imCommands.js">annotate</a> |
<a href="/comm-central/diff/198c9ae2f845e6befd27322346d1d179507a1811/chat/components/src/imCommands.js">diff</a> |
<a href="/comm-central/comparison/198c9ae2f845e6befd27322346d1d179507a1811/chat/components/src/imCommands.js">comparison</a> |
<a href="/comm-central/log/198c9ae2f845e6befd27322346d1d179507a1811/chat/components/src/imCommands.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/198c9ae2f845e6befd27322346d1d179507a1811/chat/components/src/imContacts.js">chat/components/src/imContacts.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/198c9ae2f845e6befd27322346d1d179507a1811/chat/components/src/imContacts.js">file</a> |
<a href="/comm-central/annotate/198c9ae2f845e6befd27322346d1d179507a1811/chat/components/src/imContacts.js">annotate</a> |
<a href="/comm-central/diff/198c9ae2f845e6befd27322346d1d179507a1811/chat/components/src/imContacts.js">diff</a> |
<a href="/comm-central/comparison/198c9ae2f845e6befd27322346d1d179507a1811/chat/components/src/imContacts.js">comparison</a> |
<a href="/comm-central/log/198c9ae2f845e6befd27322346d1d179507a1811/chat/components/src/imContacts.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/198c9ae2f845e6befd27322346d1d179507a1811/chat/components/src/imCore.js">chat/components/src/imCore.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/198c9ae2f845e6befd27322346d1d179507a1811/chat/components/src/imCore.js">file</a> |
<a href="/comm-central/annotate/198c9ae2f845e6befd27322346d1d179507a1811/chat/components/src/imCore.js">annotate</a> |
<a href="/comm-central/diff/198c9ae2f845e6befd27322346d1d179507a1811/chat/components/src/imCore.js">diff</a> |
<a href="/comm-central/comparison/198c9ae2f845e6befd27322346d1d179507a1811/chat/components/src/imCore.js">comparison</a> |
<a href="/comm-central/log/198c9ae2f845e6befd27322346d1d179507a1811/chat/components/src/imCore.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/198c9ae2f845e6befd27322346d1d179507a1811/chat/components/src/logger.js">chat/components/src/logger.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/198c9ae2f845e6befd27322346d1d179507a1811/chat/components/src/logger.js">file</a> |
<a href="/comm-central/annotate/198c9ae2f845e6befd27322346d1d179507a1811/chat/components/src/logger.js">annotate</a> |
<a href="/comm-central/diff/198c9ae2f845e6befd27322346d1d179507a1811/chat/components/src/logger.js">diff</a> |
<a href="/comm-central/comparison/198c9ae2f845e6befd27322346d1d179507a1811/chat/components/src/logger.js">comparison</a> |
<a href="/comm-central/log/198c9ae2f845e6befd27322346d1d179507a1811/chat/components/src/logger.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/198c9ae2f845e6befd27322346d1d179507a1811/chat/components/src/smileProtocolHandler.js">chat/components/src/smileProtocolHandler.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/198c9ae2f845e6befd27322346d1d179507a1811/chat/components/src/smileProtocolHandler.js">file</a> |
<a href="/comm-central/annotate/198c9ae2f845e6befd27322346d1d179507a1811/chat/components/src/smileProtocolHandler.js">annotate</a> |
<a href="/comm-central/diff/198c9ae2f845e6befd27322346d1d179507a1811/chat/components/src/smileProtocolHandler.js">diff</a> |
<a href="/comm-central/comparison/198c9ae2f845e6befd27322346d1d179507a1811/chat/components/src/smileProtocolHandler.js">comparison</a> |
<a href="/comm-central/log/198c9ae2f845e6befd27322346d1d179507a1811/chat/components/src/smileProtocolHandler.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/198c9ae2f845e6befd27322346d1d179507a1811/chat/content/browserRequest.js">chat/content/browserRequest.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/198c9ae2f845e6befd27322346d1d179507a1811/chat/content/browserRequest.js">file</a> |
<a href="/comm-central/annotate/198c9ae2f845e6befd27322346d1d179507a1811/chat/content/browserRequest.js">annotate</a> |
<a href="/comm-central/diff/198c9ae2f845e6befd27322346d1d179507a1811/chat/content/browserRequest.js">diff</a> |
<a href="/comm-central/comparison/198c9ae2f845e6befd27322346d1d179507a1811/chat/content/browserRequest.js">comparison</a> |
<a href="/comm-central/log/198c9ae2f845e6befd27322346d1d179507a1811/chat/content/browserRequest.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/198c9ae2f845e6befd27322346d1d179507a1811/chat/content/convbrowser.xml">chat/content/convbrowser.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/198c9ae2f845e6befd27322346d1d179507a1811/chat/content/convbrowser.xml">file</a> |
<a href="/comm-central/annotate/198c9ae2f845e6befd27322346d1d179507a1811/chat/content/convbrowser.xml">annotate</a> |
<a href="/comm-central/diff/198c9ae2f845e6befd27322346d1d179507a1811/chat/content/convbrowser.xml">diff</a> |
<a href="/comm-central/comparison/198c9ae2f845e6befd27322346d1d179507a1811/chat/content/convbrowser.xml">comparison</a> |
<a href="/comm-central/log/198c9ae2f845e6befd27322346d1d179507a1811/chat/content/convbrowser.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/198c9ae2f845e6befd27322346d1d179507a1811/chat/locales/en-US/twitter.properties">chat/locales/en-US/twitter.properties</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/198c9ae2f845e6befd27322346d1d179507a1811/chat/locales/en-US/twitter.properties">file</a> |
<a href="/comm-central/annotate/198c9ae2f845e6befd27322346d1d179507a1811/chat/locales/en-US/twitter.properties">annotate</a> |
<a href="/comm-central/diff/198c9ae2f845e6befd27322346d1d179507a1811/chat/locales/en-US/twitter.properties">diff</a> |
<a href="/comm-central/comparison/198c9ae2f845e6befd27322346d1d179507a1811/chat/locales/en-US/twitter.properties">comparison</a> |
<a href="/comm-central/log/198c9ae2f845e6befd27322346d1d179507a1811/chat/locales/en-US/twitter.properties">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/198c9ae2f845e6befd27322346d1d179507a1811/chat/modules/Makefile.in">chat/modules/Makefile.in</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/198c9ae2f845e6befd27322346d1d179507a1811/chat/modules/Makefile.in">file</a> |
<a href="/comm-central/annotate/198c9ae2f845e6befd27322346d1d179507a1811/chat/modules/Makefile.in">annotate</a> |
<a href="/comm-central/diff/198c9ae2f845e6befd27322346d1d179507a1811/chat/modules/Makefile.in">diff</a> |
<a href="/comm-central/comparison/198c9ae2f845e6befd27322346d1d179507a1811/chat/modules/Makefile.in">comparison</a> |
<a href="/comm-central/log/198c9ae2f845e6befd27322346d1d179507a1811/chat/modules/Makefile.in">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/198c9ae2f845e6befd27322346d1d179507a1811/chat/modules/http.jsm">chat/modules/http.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/198c9ae2f845e6befd27322346d1d179507a1811/chat/modules/http.jsm">file</a> |
<a href="/comm-central/annotate/198c9ae2f845e6befd27322346d1d179507a1811/chat/modules/http.jsm">annotate</a> |
<a href="/comm-central/diff/198c9ae2f845e6befd27322346d1d179507a1811/chat/modules/http.jsm">diff</a> |
<a href="/comm-central/comparison/198c9ae2f845e6befd27322346d1d179507a1811/chat/modules/http.jsm">comparison</a> |
<a href="/comm-central/log/198c9ae2f845e6befd27322346d1d179507a1811/chat/modules/http.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/198c9ae2f845e6befd27322346d1d179507a1811/chat/modules/imContentSink.jsm">chat/modules/imContentSink.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/198c9ae2f845e6befd27322346d1d179507a1811/chat/modules/imContentSink.jsm">file</a> |
<a href="/comm-central/annotate/198c9ae2f845e6befd27322346d1d179507a1811/chat/modules/imContentSink.jsm">annotate</a> |
<a href="/comm-central/diff/198c9ae2f845e6befd27322346d1d179507a1811/chat/modules/imContentSink.jsm">diff</a> |
<a href="/comm-central/comparison/198c9ae2f845e6befd27322346d1d179507a1811/chat/modules/imContentSink.jsm">comparison</a> |
<a href="/comm-central/log/198c9ae2f845e6befd27322346d1d179507a1811/chat/modules/imContentSink.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/198c9ae2f845e6befd27322346d1d179507a1811/chat/modules/imSmileys.jsm">chat/modules/imSmileys.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/198c9ae2f845e6befd27322346d1d179507a1811/chat/modules/imSmileys.jsm">file</a> |
<a href="/comm-central/annotate/198c9ae2f845e6befd27322346d1d179507a1811/chat/modules/imSmileys.jsm">annotate</a> |
<a href="/comm-central/diff/198c9ae2f845e6befd27322346d1d179507a1811/chat/modules/imSmileys.jsm">diff</a> |
<a href="/comm-central/comparison/198c9ae2f845e6befd27322346d1d179507a1811/chat/modules/imSmileys.jsm">comparison</a> |
<a href="/comm-central/log/198c9ae2f845e6befd27322346d1d179507a1811/chat/modules/imSmileys.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/198c9ae2f845e6befd27322346d1d179507a1811/chat/modules/imThemes.jsm">chat/modules/imThemes.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/198c9ae2f845e6befd27322346d1d179507a1811/chat/modules/imThemes.jsm">file</a> |
<a href="/comm-central/annotate/198c9ae2f845e6befd27322346d1d179507a1811/chat/modules/imThemes.jsm">annotate</a> |
<a href="/comm-central/diff/198c9ae2f845e6befd27322346d1d179507a1811/chat/modules/imThemes.jsm">diff</a> |
<a href="/comm-central/comparison/198c9ae2f845e6befd27322346d1d179507a1811/chat/modules/imThemes.jsm">comparison</a> |
<a href="/comm-central/log/198c9ae2f845e6befd27322346d1d179507a1811/chat/modules/imThemes.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/198c9ae2f845e6befd27322346d1d179507a1811/chat/modules/imXPCOMUtils.jsm">chat/modules/imXPCOMUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/198c9ae2f845e6befd27322346d1d179507a1811/chat/modules/imXPCOMUtils.jsm">file</a> |
<a href="/comm-central/annotate/198c9ae2f845e6befd27322346d1d179507a1811/chat/modules/imXPCOMUtils.jsm">annotate</a> |
<a href="/comm-central/diff/198c9ae2f845e6befd27322346d1d179507a1811/chat/modules/imXPCOMUtils.jsm">diff</a> |
<a href="/comm-central/comparison/198c9ae2f845e6befd27322346d1d179507a1811/chat/modules/imXPCOMUtils.jsm">comparison</a> |
<a href="/comm-central/log/198c9ae2f845e6befd27322346d1d179507a1811/chat/modules/imXPCOMUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/198c9ae2f845e6befd27322346d1d179507a1811/chat/modules/jsProtoHelper.jsm">chat/modules/jsProtoHelper.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/198c9ae2f845e6befd27322346d1d179507a1811/chat/modules/jsProtoHelper.jsm">file</a> |
<a href="/comm-central/annotate/198c9ae2f845e6befd27322346d1d179507a1811/chat/modules/jsProtoHelper.jsm">annotate</a> |
<a href="/comm-central/diff/198c9ae2f845e6befd27322346d1d179507a1811/chat/modules/jsProtoHelper.jsm">diff</a> |
<a href="/comm-central/comparison/198c9ae2f845e6befd27322346d1d179507a1811/chat/modules/jsProtoHelper.jsm">comparison</a> |
<a href="/comm-central/log/198c9ae2f845e6befd27322346d1d179507a1811/chat/modules/jsProtoHelper.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/198c9ae2f845e6befd27322346d1d179507a1811/chat/modules/socket.jsm">chat/modules/socket.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/198c9ae2f845e6befd27322346d1d179507a1811/chat/modules/socket.jsm">file</a> |
<a href="/comm-central/annotate/198c9ae2f845e6befd27322346d1d179507a1811/chat/modules/socket.jsm">annotate</a> |
<a href="/comm-central/diff/198c9ae2f845e6befd27322346d1d179507a1811/chat/modules/socket.jsm">diff</a> |
<a href="/comm-central/comparison/198c9ae2f845e6befd27322346d1d179507a1811/chat/modules/socket.jsm">comparison</a> |
<a href="/comm-central/log/198c9ae2f845e6befd27322346d1d179507a1811/chat/modules/socket.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/198c9ae2f845e6befd27322346d1d179507a1811/chat/protocols/twitter/twitter.js">chat/protocols/twitter/twitter.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/198c9ae2f845e6befd27322346d1d179507a1811/chat/protocols/twitter/twitter.js">file</a> |
<a href="/comm-central/annotate/198c9ae2f845e6befd27322346d1d179507a1811/chat/protocols/twitter/twitter.js">annotate</a> |
<a href="/comm-central/diff/198c9ae2f845e6befd27322346d1d179507a1811/chat/protocols/twitter/twitter.js">diff</a> |
<a href="/comm-central/comparison/198c9ae2f845e6befd27322346d1d179507a1811/chat/protocols/twitter/twitter.js">comparison</a> |
<a href="/comm-central/log/198c9ae2f845e6befd27322346d1d179507a1811/chat/protocols/twitter/twitter.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/198c9ae2f845e6befd27322346d1d179507a1811/chat/protocols/xmpp/xmpp-authmechs.jsm">chat/protocols/xmpp/xmpp-authmechs.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/198c9ae2f845e6befd27322346d1d179507a1811/chat/protocols/xmpp/xmpp-authmechs.jsm">file</a> |
<a href="/comm-central/annotate/198c9ae2f845e6befd27322346d1d179507a1811/chat/protocols/xmpp/xmpp-authmechs.jsm">annotate</a> |
<a href="/comm-central/diff/198c9ae2f845e6befd27322346d1d179507a1811/chat/protocols/xmpp/xmpp-authmechs.jsm">diff</a> |
<a href="/comm-central/comparison/198c9ae2f845e6befd27322346d1d179507a1811/chat/protocols/xmpp/xmpp-authmechs.jsm">comparison</a> |
<a href="/comm-central/log/198c9ae2f845e6befd27322346d1d179507a1811/chat/protocols/xmpp/xmpp-authmechs.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/198c9ae2f845e6befd27322346d1d179507a1811/chat/protocols/xmpp/xmpp-session.jsm">chat/protocols/xmpp/xmpp-session.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/198c9ae2f845e6befd27322346d1d179507a1811/chat/protocols/xmpp/xmpp-session.jsm">file</a> |
<a href="/comm-central/annotate/198c9ae2f845e6befd27322346d1d179507a1811/chat/protocols/xmpp/xmpp-session.jsm">annotate</a> |
<a href="/comm-central/diff/198c9ae2f845e6befd27322346d1d179507a1811/chat/protocols/xmpp/xmpp-session.jsm">diff</a> |
<a href="/comm-central/comparison/198c9ae2f845e6befd27322346d1d179507a1811/chat/protocols/xmpp/xmpp-session.jsm">comparison</a> |
<a href="/comm-central/log/198c9ae2f845e6befd27322346d1d179507a1811/chat/protocols/xmpp/xmpp-session.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/198c9ae2f845e6befd27322346d1d179507a1811/chat/protocols/xmpp/xmpp.jsm">chat/protocols/xmpp/xmpp.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/198c9ae2f845e6befd27322346d1d179507a1811/chat/protocols/xmpp/xmpp.jsm">file</a> |
<a href="/comm-central/annotate/198c9ae2f845e6befd27322346d1d179507a1811/chat/protocols/xmpp/xmpp.jsm">annotate</a> |
<a href="/comm-central/diff/198c9ae2f845e6befd27322346d1d179507a1811/chat/protocols/xmpp/xmpp.jsm">diff</a> |
<a href="/comm-central/comparison/198c9ae2f845e6befd27322346d1d179507a1811/chat/protocols/xmpp/xmpp.jsm">comparison</a> |
<a href="/comm-central/log/198c9ae2f845e6befd27322346d1d179507a1811/chat/protocols/xmpp/xmpp.jsm">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/chat/chat-prefs.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/chat/chat-prefs.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -5,18 +5,18 @@</span>
<a href="#l1.4"></a><span id="l1.4"> pref(&quot;messenger.startup.action&quot;, 1);</span>
<a href="#l1.5"></a><span id="l1.5"> </span>
<a href="#l1.6"></a><span id="l1.6"> pref(&quot;messenger.accounts&quot;, &quot;&quot;);</span>
<a href="#l1.7"></a><span id="l1.7"> </span>
<a href="#l1.8"></a><span id="l1.8"> // Should the accounts service stored in the password manager the</span>
<a href="#l1.9"></a><span id="l1.9"> // passwords that are currently stored in the preferences?</span>
<a href="#l1.10"></a><span id="l1.10"> pref(&quot;messenger.accounts.convertOldPasswords&quot;, false);</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-// The intervals in seconds between automatic reconnection attempts</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-// The last value will be reused forever.</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+// The intervals in seconds between automatic reconnection attempts.</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+// The last value will be reused for the rest of the reconnection attempts.</span>
<a href="#l1.16"></a><span id="l1.16"> // A value of 0 means that there will be no more reconnection attempts.</span>
<a href="#l1.17"></a><span id="l1.17"> pref(&quot;messenger.accounts.reconnectTimer&quot;, &quot;1,5,30,60,90,300,600,1200,3600&quot;);</span>
<a href="#l1.18"></a><span id="l1.18"> </span>
<a href="#l1.19"></a><span id="l1.19"> // List of tags ids whose contacts should be shown in the special</span>
<a href="#l1.20"></a><span id="l1.20"> // &quot;Other contacts&quot; group.</span>
<a href="#l1.21"></a><span id="l1.21"> pref(&quot;messenger.buddies.hiddenTags&quot;, &quot;&quot;);</span>
<a href="#l1.22"></a><span id="l1.22"> </span>
<a href="#l1.23"></a><span id="l1.23"> //  1 accepts invitations automatically,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/chat/components/public/imIAccount.idl</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/chat/components/public/imIAccount.idl</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -206,18 +206,18 @@ the protocol plugin. */</span>
<a href="#l2.4"></a><span id="l2.4"> [scriptable, uuid(20a85b44-e220-4f23-85bf-f8523d1a2b08)]</span>
<a href="#l2.5"></a><span id="l2.5"> interface imIAccount: prplIAccount {</span>
<a href="#l2.6"></a><span id="l2.6">   /* Check if autologin is enabled for this account, connect it now. */</span>
<a href="#l2.7"></a><span id="l2.7">   void checkAutoLogin();</span>
<a href="#l2.8"></a><span id="l2.8"> </span>
<a href="#l2.9"></a><span id="l2.9">   /* Delete the account (from the preferences, mozStorage, and call unInit). */</span>
<a href="#l2.10"></a><span id="l2.10">   void remove();</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-  /* Cancel the timer that automatically reconnects the account that were</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-     disconnected with a non fatal error */</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+  /* Cancel the timer that automatically reconnects the account if it was</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+     disconnected because of a non fatal error. */</span>
<a href="#l2.16"></a><span id="l2.16">   void cancelReconnection();</span>
<a href="#l2.17"></a><span id="l2.17"> </span>
<a href="#l2.18"></a><span id="l2.18">   readonly attribute AUTF8String name;</span>
<a href="#l2.19"></a><span id="l2.19">   readonly attribute AUTF8String id;</span>
<a href="#l2.20"></a><span id="l2.20">   readonly attribute PRUint32 numericId;</span>
<a href="#l2.21"></a><span id="l2.21">   readonly attribute prplIProtocol protocol;</span>
<a href="#l2.22"></a><span id="l2.22">   readonly attribute prplIAccount prplAccount;</span>
<a href="#l2.23"></a><span id="l2.23"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/chat/components/public/imIContactsService.idl</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/chat/components/public/imIContactsService.idl</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -158,18 +158,18 @@ interface imIContact: imIStatusInfo {</span>
<a href="#l3.4"></a><span id="l3.4">    *     See also the comment above the 'id' attribute.</span>
<a href="#l3.5"></a><span id="l3.5">    *   contact-icon-changed</span>
<a href="#l3.6"></a><span id="l3.6">    *</span>
<a href="#l3.7"></a><span id="l3.7">    * Observers will also receive all the (forwarded) notifications</span>
<a href="#l3.8"></a><span id="l3.8">    * from the linked buddies (imIBuddy instances) and their account</span>
<a href="#l3.9"></a><span id="l3.9">    * buddies (imIAccountBuddy instances).</span>
<a href="#l3.10"></a><span id="l3.10">    */</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-  // Exposed for add-on authors. All usage by Instantbird will come from</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-  // the imIContact implementation so it wasn't required to expose this.</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+  // Exposed for add-on authors. All internal calls will come from the</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+  // imIContact implementation itself so it wasn't required to expose this.</span>
<a href="#l3.16"></a><span id="l3.16">   // This can be used to dispatch custom notifications to the</span>
<a href="#l3.17"></a><span id="l3.17">   // observers of the contact and its tags.</span>
<a href="#l3.18"></a><span id="l3.18">   // The notification will also be forwarded to the observer service.</span>
<a href="#l3.19"></a><span id="l3.19">   void notifyObservers(in nsISupports aObj, in string aEvent,</span>
<a href="#l3.20"></a><span id="l3.20">                        [optional] in wstring aData);</span>
<a href="#l3.21"></a><span id="l3.21"> };</span>
<a href="#l3.22"></a><span id="l3.22"> </span>
<a href="#l3.23"></a><span id="l3.23"> </span>
<a href="#l3.24"></a><span id="l3.24" class="difflineat">@@ -207,18 +207,18 @@ interface imIBuddy: imIStatusInfo {</span>
<a href="#l3.25"></a><span id="l3.25">    *   buddy-preferred-account-changed</span>
<a href="#l3.26"></a><span id="l3.26">    *     The account that would be favored to start a conversation has changed.</span>
<a href="#l3.27"></a><span id="l3.27">    *   buddy-icon-changed</span>
<a href="#l3.28"></a><span id="l3.28">    *</span>
<a href="#l3.29"></a><span id="l3.29">    * Observers will also receive all the (forwarded) notifications</span>
<a href="#l3.30"></a><span id="l3.30">    * from the linked account buddies (imIAccountBuddy instances).</span>
<a href="#l3.31"></a><span id="l3.31">    */</span>
<a href="#l3.32"></a><span id="l3.32"> </span>
<a href="#l3.33"></a><span id="l3.33" class="difflineminus">-  // Exposed for add-on authors. All usage by Instantbird will come from</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineminus">-  // the imIBuddy implementation so it wasn't required to expose this.</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineplus">+  // Exposed for add-on authors. All internal calls will come from the</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineplus">+  // imIBuddy implementation itself so it wasn't required to expose this.</span>
<a href="#l3.37"></a><span id="l3.37">   // This can be used to dispatch custom notifications to the</span>
<a href="#l3.38"></a><span id="l3.38">   // observers of the buddy, its contact and its tags.</span>
<a href="#l3.39"></a><span id="l3.39">   // The contact will forward the notifications to the observer service.</span>
<a href="#l3.40"></a><span id="l3.40">   void notifyObservers(in nsISupports aObj, in string aEvent,</span>
<a href="#l3.41"></a><span id="l3.41">                        [optional] in wstring aData);</span>
<a href="#l3.42"></a><span id="l3.42"> </span>
<a href="#l3.43"></a><span id="l3.43">   // observe should only be called by the imIAccountBuddy</span>
<a href="#l3.44"></a><span id="l3.44">   // implementations to report changes.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/chat/components/public/imITagsService.idl</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/chat/components/public/imITagsService.idl</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -55,18 +55,18 @@ interface imITag: nsISupports {</span>
<a href="#l4.4"></a><span id="l4.4">   void addObserver(in nsIObserver aObserver);</span>
<a href="#l4.5"></a><span id="l4.5">   void removeObserver(in nsIObserver aObserver);</span>
<a href="#l4.6"></a><span id="l4.6">   /* Observers will be notified of changes related to the contacts</span>
<a href="#l4.7"></a><span id="l4.7">    * that have the tag: contact-*, buddy-*, account-buddy-*</span>
<a href="#l4.8"></a><span id="l4.8">    * notifications forwarded respectively from the imIContact,</span>
<a href="#l4.9"></a><span id="l4.9">    * imIBuddy and imIAccountBuddy instances.</span>
<a href="#l4.10"></a><span id="l4.10">    */</span>
<a href="#l4.11"></a><span id="l4.11"> </span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-  // Exposed for add-on authors. All usage by Instantbird will come from</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-  // the imITag implementation so it wasn't required to expose this.</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+  // Exposed for add-on authors. All internal calls will come from the</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+  // imITag implementation itself so it wasn't required to expose this.</span>
<a href="#l4.16"></a><span id="l4.16">   // This can be used to dispatch custom notifications to the</span>
<a href="#l4.17"></a><span id="l4.17">   // observers of the tag.</span>
<a href="#l4.18"></a><span id="l4.18">   void notifyObservers(in nsISupports aObj, in string aEvent,</span>
<a href="#l4.19"></a><span id="l4.19">                        [optional] in wstring aData);</span>
<a href="#l4.20"></a><span id="l4.20"> };</span>
<a href="#l4.21"></a><span id="l4.21"> </span>
<a href="#l4.22"></a><span id="l4.22"> [scriptable, uuid(f799a9c2-23f2-4fd1-96fb-515bad238f8c)]</span>
<a href="#l4.23"></a><span id="l4.23"> interface imITagsService: nsISupports {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/chat/components/public/prplIMessage.idl</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/chat/components/public/prplIMessage.idl</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -62,17 +62,17 @@ interface prplIMessage: nsISupports {</span>
<a href="#l5.4"></a><span id="l5.4">   readonly attribute AUTF8String originalMessage;</span>
<a href="#l5.5"></a><span id="l5.5">            attribute AUTF8String message;</span>
<a href="#l5.6"></a><span id="l5.6">   readonly attribute AUTF8String iconURL;</span>
<a href="#l5.7"></a><span id="l5.7">   readonly attribute PRTime time;</span>
<a href="#l5.8"></a><span id="l5.8">   readonly attribute prplIConversation conversation;</span>
<a href="#l5.9"></a><span id="l5.9"> </span>
<a href="#l5.10"></a><span id="l5.10">   /* Holds the sender color for Chats.</span>
<a href="#l5.11"></a><span id="l5.11">      Empty string by default, it is set by the conversation binding. */</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-           attribute AUTF8String color;</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+  attribute AUTF8String color;</span>
<a href="#l5.14"></a><span id="l5.14"> </span>
<a href="#l5.15"></a><span id="l5.15">   /*  PURPLE_MESSAGE_SEND        = 0x0001, /**&lt; Outgoing message. */</span>
<a href="#l5.16"></a><span id="l5.16">   readonly attribute boolean outgoing;</span>
<a href="#l5.17"></a><span id="l5.17">   /*  PURPLE_MESSAGE_RECV        = 0x0002, /**&lt; Incoming message. */</span>
<a href="#l5.18"></a><span id="l5.18">   readonly attribute boolean incoming;</span>
<a href="#l5.19"></a><span id="l5.19">   /*  PURPLE_MESSAGE_SYSTEM      = 0x0004, /**&lt; System message.   */</span>
<a href="#l5.20"></a><span id="l5.20">   readonly attribute boolean system;</span>
<a href="#l5.21"></a><span id="l5.21">   /*  PURPLE_MESSAGE_AUTO_RESP   = 0x0008, /**&lt; Auto response.    */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/chat/components/src/Makefile.in</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/chat/components/src/Makefile.in</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -42,18 +42,17 @@ VPATH		= @srcdir@</span>
<a href="#l6.4"></a><span id="l6.4"> include $(DEPTH)/config/autoconf.mk</span>
<a href="#l6.5"></a><span id="l6.5"> </span>
<a href="#l6.6"></a><span id="l6.6"> EXTRA_COMPONENTS = \</span>
<a href="#l6.7"></a><span id="l6.7"> 		imAccounts.manifest \</span>
<a href="#l6.8"></a><span id="l6.8"> 		imCommands.js imCommands.manifest \</span>
<a href="#l6.9"></a><span id="l6.9"> 		imContacts.js imContacts.manifest \</span>
<a href="#l6.10"></a><span id="l6.10"> 		imConversations.js imConversations.manifest \</span>
<a href="#l6.11"></a><span id="l6.11"> 		imCore.js imCore.manifest \</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-		logger.manifest \</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+		logger.js logger.manifest \</span>
<a href="#l6.14"></a><span id="l6.14"> 		smileProtocolHandler.js smileProtocolHandler.manifest \</span>
<a href="#l6.15"></a><span id="l6.15"> 		$(NULL)</span>
<a href="#l6.16"></a><span id="l6.16"> </span>
<a href="#l6.17"></a><span id="l6.17"> EXTRA_PP_COMPONENTS = \</span>
<a href="#l6.18"></a><span id="l6.18"> 		imAccounts.js \</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineminus">-		logger.js \</span>
<a href="#l6.20"></a><span id="l6.20"> 		$(NULL)</span>
<a href="#l6.21"></a><span id="l6.21"> </span>
<a href="#l6.22"></a><span id="l6.22"> include $(topsrcdir)/config/rules.mk</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/chat/components/src/imAccounts.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/chat/components/src/imAccounts.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -783,19 +783,17 @@ AccountsService.prototype = {</span>
<a href="#l7.4"></a><span id="l7.4">     prefs.deleteBranch(kPrefAutologinPending);</span>
<a href="#l7.5"></a><span id="l7.5"> </span>
<a href="#l7.6"></a><span id="l7.6"> #ifdef MOZ_CRASHREPORTER</span>
<a href="#l7.7"></a><span id="l7.7">     try {</span>
<a href="#l7.8"></a><span id="l7.8">       // Try to get more info with breakpad</span>
<a href="#l7.9"></a><span id="l7.9">       let lastCrashTime = 0;</span>
<a href="#l7.10"></a><span id="l7.10"> </span>
<a href="#l7.11"></a><span id="l7.11">       /* Locate the LastCrash file */</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-      let lastCrash =</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">-        Cc[&quot;@mozilla.org/file/directory_service;1&quot;].getService(Ci.nsIProperties)</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineminus">-        .get(&quot;UAppData&quot;, Ci.nsILocalFile);</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+      let lastCrash = Services.dirsvc.get(&quot;UAppData&quot;, Ci.nsILocalFile);</span>
<a href="#l7.16"></a><span id="l7.16">       lastCrash.append(&quot;Crash Reports&quot;);</span>
<a href="#l7.17"></a><span id="l7.17">       lastCrash.append(&quot;LastCrash&quot;);</span>
<a href="#l7.18"></a><span id="l7.18">       if (lastCrash.exists()) {</span>
<a href="#l7.19"></a><span id="l7.19">         /* Ok, the file exists, now let's try to read it */</span>
<a href="#l7.20"></a><span id="l7.20">         let is = Cc[&quot;@mozilla.org/network/file-input-stream;1&quot;]</span>
<a href="#l7.21"></a><span id="l7.21">                  .createInstance(Ci.nsIFileInputStream);</span>
<a href="#l7.22"></a><span id="l7.22">         let sis = Cc[&quot;@mozilla.org/scriptableinputstream;1&quot;]</span>
<a href="#l7.23"></a><span id="l7.23">                   .createInstance(Ci.nsIScriptableInputStream);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/chat/components/src/imCommands.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/chat/components/src/imCommands.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -30,105 +30,99 @@</span>
<a href="#l8.4"></a><span id="l8.4">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l8.5"></a><span id="l8.5">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l8.6"></a><span id="l8.6">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l8.7"></a><span id="l8.7">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l8.8"></a><span id="l8.8">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l8.9"></a><span id="l8.9">  *</span>
<a href="#l8.10"></a><span id="l8.10">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l8.11"></a><span id="l8.11"> </span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineminus">-Components.utils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineminus">-</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineminus">-const Cc = Components.classes;</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineminus">-const Ci = Components.interfaces;</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineminus">-const Cr = Components.results;</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineplus">+const {classes: Cc, interfaces: Ci, results: Cr, utils: Cu} = Components;</span>
<a href="#l8.19"></a><span id="l8.19"> </span>
<a href="#l8.20"></a><span id="l8.20" class="difflineminus">-XPCOMUtils.defineLazyServiceGetter(this, &quot;obs&quot;,</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineminus">-                                   &quot;@mozilla.org/observer-service;1&quot;,</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineminus">-                                   &quot;nsIObserverService&quot;);</span>
<a href="#l8.23"></a><span id="l8.23" class="difflineplus">+Cu.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineplus">+Cu.import(&quot;resource:///modules/imXPCOMUtils.jsm&quot;);</span>
<a href="#l8.25"></a><span id="l8.25"> </span>
<a href="#l8.26"></a><span id="l8.26" class="difflineminus">-XPCOMUtils.defineLazyGetter(this, &quot;bundle&quot;, function()</span>
<a href="#l8.27"></a><span id="l8.27" class="difflineminus">-  Services.strings.createBundle(&quot;chrome://chat/locale/commands.properties&quot;)</span>
<a href="#l8.28"></a><span id="l8.28" class="difflineplus">+XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, function()</span>
<a href="#l8.29"></a><span id="l8.29" class="difflineplus">+  l10nHelper(&quot;chrome://chat/locale/commands.properties&quot;)</span>
<a href="#l8.30"></a><span id="l8.30"> );</span>
<a href="#l8.31"></a><span id="l8.31"> </span>
<a href="#l8.32"></a><span id="l8.32"> function CommandsService() { }</span>
<a href="#l8.33"></a><span id="l8.33"> CommandsService.prototype = {</span>
<a href="#l8.34"></a><span id="l8.34">   initCommands: function() {</span>
<a href="#l8.35"></a><span id="l8.35">     this._commands = {};</span>
<a href="#l8.36"></a><span id="l8.36">     // The say command is directly implemented in the UI layer, but has a</span>
<a href="#l8.37"></a><span id="l8.37">     // dummy command registered here so it shows up as a command (e.g. when</span>
<a href="#l8.38"></a><span id="l8.38">     // using the /help command).</span>
<a href="#l8.39"></a><span id="l8.39">     this.registerCommand({</span>
<a href="#l8.40"></a><span id="l8.40">       name: &quot;say&quot;,</span>
<a href="#l8.41"></a><span id="l8.41" class="difflineminus">-      get helpString() bundle.GetStringFromName(&quot;sayHelpString&quot;),</span>
<a href="#l8.42"></a><span id="l8.42" class="difflineplus">+      get helpString() _(&quot;sayHelpString&quot;),</span>
<a href="#l8.43"></a><span id="l8.43">       usageContext: Ci.imICommand.CONTEXT_ALL,</span>
<a href="#l8.44"></a><span id="l8.44">       priority: Ci.imICommand.PRIORITY_HIGH,</span>
<a href="#l8.45"></a><span id="l8.45">       run: function(aMsg, aConv) {</span>
<a href="#l8.46"></a><span id="l8.46">         throw Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l8.47"></a><span id="l8.47">       }</span>
<a href="#l8.48"></a><span id="l8.48">     });</span>
<a href="#l8.49"></a><span id="l8.49"> </span>
<a href="#l8.50"></a><span id="l8.50">     this.registerCommand({</span>
<a href="#l8.51"></a><span id="l8.51">       name: &quot;raw&quot;,</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineminus">-      get helpString() bundle.GetStringFromName(&quot;rawHelpString&quot;),</span>
<a href="#l8.53"></a><span id="l8.53" class="difflineplus">+      get helpString() _(&quot;rawHelpString&quot;),</span>
<a href="#l8.54"></a><span id="l8.54">       usageContext: Ci.imICommand.CONTEXT_ALL,</span>
<a href="#l8.55"></a><span id="l8.55">       priority: Ci.imICommand.PRIORITY_DEFAULT,</span>
<a href="#l8.56"></a><span id="l8.56">       run: function(aMsg, aConv) {</span>
<a href="#l8.57"></a><span id="l8.57">         aConv.sendMsg(aMsg);</span>
<a href="#l8.58"></a><span id="l8.58">         return true;</span>
<a href="#l8.59"></a><span id="l8.59">       }</span>
<a href="#l8.60"></a><span id="l8.60">     });</span>
<a href="#l8.61"></a><span id="l8.61"> </span>
<a href="#l8.62"></a><span id="l8.62">     this.registerCommand({</span>
<a href="#l8.63"></a><span id="l8.63">       // Reference the command service so we can use the internal properties</span>
<a href="#l8.64"></a><span id="l8.64">       // directly.</span>
<a href="#l8.65"></a><span id="l8.65">       cmdSrv: this,</span>
<a href="#l8.66"></a><span id="l8.66"> </span>
<a href="#l8.67"></a><span id="l8.67">       name: &quot;help&quot;,</span>
<a href="#l8.68"></a><span id="l8.68" class="difflineminus">-      get helpString() bundle.GetStringFromName(&quot;helpHelpString&quot;),</span>
<a href="#l8.69"></a><span id="l8.69" class="difflineplus">+      get helpString() _(&quot;helpHelpString&quot;),</span>
<a href="#l8.70"></a><span id="l8.70">       usageContext: Ci.imICommand.CONTEXT_ALL,</span>
<a href="#l8.71"></a><span id="l8.71">       priority: Ci.imICommand.PRIORITY_DEFAULT,</span>
<a href="#l8.72"></a><span id="l8.72">       run: function(aMsg, aConv) {</span>
<a href="#l8.73"></a><span id="l8.73">         let conv = Services.conversations.getUIConversation(aConv);</span>
<a href="#l8.74"></a><span id="l8.74">         if (!conv)</span>
<a href="#l8.75"></a><span id="l8.75">           return false;</span>
<a href="#l8.76"></a><span id="l8.76"> </span>
<a href="#l8.77"></a><span id="l8.77">         // Handle when no command is given, list all possible commands that are</span>
<a href="#l8.78"></a><span id="l8.78">         // available for this conversation (alphabetically).</span>
<a href="#l8.79"></a><span id="l8.79">         if (!aMsg) {</span>
<a href="#l8.80"></a><span id="l8.80">           let commands = this.cmdSrv.listCommandsForConversation(aConv, {});</span>
<a href="#l8.81"></a><span id="l8.81">           if (!commands.length)</span>
<a href="#l8.82"></a><span id="l8.82">             return false;</span>
<a href="#l8.83"></a><span id="l8.83"> </span>
<a href="#l8.84"></a><span id="l8.84">           // Concatenate the command names (separated by a comma and space).</span>
<a href="#l8.85"></a><span id="l8.85">           let cmds = commands.map(function(aCmd) aCmd.name).sort().join(&quot;, &quot;);</span>
<a href="#l8.86"></a><span id="l8.86" class="difflineminus">-          let message = bundle.formatStringFromName(&quot;commands&quot;, [cmds], 1);</span>
<a href="#l8.87"></a><span id="l8.87" class="difflineplus">+          let message = _(&quot;commands&quot;, cmds);</span>
<a href="#l8.88"></a><span id="l8.88"> </span>
<a href="#l8.89"></a><span id="l8.89">           // Display the message</span>
<a href="#l8.90"></a><span id="l8.90">           conv.systemMessage(message);</span>
<a href="#l8.91"></a><span id="l8.91">           return true;</span>
<a href="#l8.92"></a><span id="l8.92">         }</span>
<a href="#l8.93"></a><span id="l8.93"> </span>
<a href="#l8.94"></a><span id="l8.94">         // A command name was given, find the commands that match.</span>
<a href="#l8.95"></a><span id="l8.95">         let cmdArray = this.cmdSrv._findCommands(aConv, aMsg);</span>
<a href="#l8.96"></a><span id="l8.96"> </span>
<a href="#l8.97"></a><span id="l8.97">         if (!cmdArray.length) {</span>
<a href="#l8.98"></a><span id="l8.98">           // No command that matches.</span>
<a href="#l8.99"></a><span id="l8.99" class="difflineminus">-          let message = bundle.formatStringFromName(&quot;noCommand&quot;, [aMsg], 1);</span>
<a href="#l8.100"></a><span id="l8.100" class="difflineplus">+          let message = _(&quot;noCommand&quot;, aMsg);</span>
<a href="#l8.101"></a><span id="l8.101">           conv.systemMessage(message);</span>
<a href="#l8.102"></a><span id="l8.102">           return true;</span>
<a href="#l8.103"></a><span id="l8.103">         }</span>
<a href="#l8.104"></a><span id="l8.104"> </span>
<a href="#l8.105"></a><span id="l8.105">         // Only show the help for the one of the highest priority.</span>
<a href="#l8.106"></a><span id="l8.106">         let cmd = cmdArray[0];</span>
<a href="#l8.107"></a><span id="l8.107"> </span>
<a href="#l8.108"></a><span id="l8.108">         let text = cmd.helpString;</span>
<a href="#l8.109"></a><span id="l8.109">         if (!text)</span>
<a href="#l8.110"></a><span id="l8.110" class="difflineminus">-          text = bundle.formatStringFromName(&quot;noHelp&quot;, [cmd.name], 1);</span>
<a href="#l8.111"></a><span id="l8.111" class="difflineplus">+          text = _(&quot;noHelp&quot;, cmd.name);</span>
<a href="#l8.112"></a><span id="l8.112"> </span>
<a href="#l8.113"></a><span id="l8.113">         // Display the message.</span>
<a href="#l8.114"></a><span id="l8.114">         conv.systemMessage(text);</span>
<a href="#l8.115"></a><span id="l8.115">         return true;</span>
<a href="#l8.116"></a><span id="l8.116">       }</span>
<a href="#l8.117"></a><span id="l8.117">     });</span>
<a href="#l8.118"></a><span id="l8.118"> </span>
<a href="#l8.119"></a><span id="l8.119">     // Status commands</span>
<a href="#l8.120"></a><span id="l8.120" class="difflineat">@@ -138,21 +132,17 @@ CommandsService.prototype = {</span>
<a href="#l8.121"></a><span id="l8.121">       busy: &quot;UNAVAILABLE&quot;,</span>
<a href="#l8.122"></a><span id="l8.122">       dnd: &quot;UNAVAILABLE&quot;,</span>
<a href="#l8.123"></a><span id="l8.123">       offline: &quot;OFFLINE&quot;</span>
<a href="#l8.124"></a><span id="l8.124">     };</span>
<a href="#l8.125"></a><span id="l8.125">     for (let cmd in status) {</span>
<a href="#l8.126"></a><span id="l8.126">       let statusValue = Ci.imIStatusInfo[&quot;STATUS_&quot; + status[cmd]];</span>
<a href="#l8.127"></a><span id="l8.127">       this.registerCommand({</span>
<a href="#l8.128"></a><span id="l8.128">         name: cmd,</span>
<a href="#l8.129"></a><span id="l8.129" class="difflineminus">-        get helpString()</span>
<a href="#l8.130"></a><span id="l8.130" class="difflineminus">-          bundle.formatStringFromName(&quot;statusCommand&quot;,</span>
<a href="#l8.131"></a><span id="l8.131" class="difflineminus">-                                      [this.name,</span>
<a href="#l8.132"></a><span id="l8.132" class="difflineminus">-                                       bundle.GetStringFromName(this.name)],</span>
<a href="#l8.133"></a><span id="l8.133" class="difflineminus">-                                      2),</span>
<a href="#l8.134"></a><span id="l8.134" class="difflineplus">+        get helpString() _(&quot;statusCommand&quot;, this.name, _(this.name)),</span>
<a href="#l8.135"></a><span id="l8.135">         usageContext: Ci.imICommand.CONTEXT_ALL,</span>
<a href="#l8.136"></a><span id="l8.136">         priority: Ci.imICommand.PRIORITY_HIGH,</span>
<a href="#l8.137"></a><span id="l8.137">         run: function(aMsg) {</span>
<a href="#l8.138"></a><span id="l8.138">           Services.core.globalUserStatus.setStatus(statusValue, aMsg);</span>
<a href="#l8.139"></a><span id="l8.139">           return true;</span>
<a href="#l8.140"></a><span id="l8.140">         }</span>
<a href="#l8.141"></a><span id="l8.141">       });</span>
<a href="#l8.142"></a><span id="l8.142">     }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/chat/components/src/imContacts.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/chat/components/src/imContacts.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -39,19 +39,17 @@ const {classes: Cc, interfaces: Ci, util</span>
<a href="#l9.4"></a><span id="l9.4"> Cu.import(&quot;resource:///modules/imXPCOMUtils.jsm&quot;);</span>
<a href="#l9.5"></a><span id="l9.5"> Cu.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l9.6"></a><span id="l9.6"> </span>
<a href="#l9.7"></a><span id="l9.7"> var gDBConnection = null;</span>
<a href="#l9.8"></a><span id="l9.8"> </span>
<a href="#l9.9"></a><span id="l9.9"> function getDBConnection()</span>
<a href="#l9.10"></a><span id="l9.10"> {</span>
<a href="#l9.11"></a><span id="l9.11">   const NS_APP_USER_PROFILE_50_DIR = &quot;ProfD&quot;;</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-  let dbFile =</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineminus">-    Cc[&quot;@mozilla.org/file/directory_service;1&quot;].getService(Ci.nsIProperties)</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineminus">-    .get(NS_APP_USER_PROFILE_50_DIR, Ci.nsIFile);</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineplus">+  let dbFile = Services.dirsvc.get(NS_APP_USER_PROFILE_50_DIR, Ci.nsIFile);</span>
<a href="#l9.16"></a><span id="l9.16">   dbFile.append(&quot;blist.sqlite&quot;);</span>
<a href="#l9.17"></a><span id="l9.17"> </span>
<a href="#l9.18"></a><span id="l9.18">   let conn =</span>
<a href="#l9.19"></a><span id="l9.19">     Cc[&quot;@mozilla.org/storage/service;1&quot;].getService(Ci.mozIStorageService)</span>
<a href="#l9.20"></a><span id="l9.20">                                         .openDatabase(dbFile);</span>
<a href="#l9.21"></a><span id="l9.21">   if (!conn.connectionReady)</span>
<a href="#l9.22"></a><span id="l9.22">     throw Cr.NS_ERROR_UNEXPECTED;</span>
<a href="#l9.23"></a><span id="l9.23"> </span>
<a href="#l9.24"></a><span id="l9.24" class="difflineat">@@ -188,17 +186,17 @@ function Tag(aId, aName) {</span>
<a href="#l9.25"></a><span id="l9.25">   this._observers = [];</span>
<a href="#l9.26"></a><span id="l9.26"> </span>
<a href="#l9.27"></a><span id="l9.27">   TagsById[this.id] = this;</span>
<a href="#l9.28"></a><span id="l9.28"> }</span>
<a href="#l9.29"></a><span id="l9.29"> Tag.prototype = {</span>
<a href="#l9.30"></a><span id="l9.30">   get id() this._id,</span>
<a href="#l9.31"></a><span id="l9.31">   get name() this._name,</span>
<a href="#l9.32"></a><span id="l9.32">   set name(aNewName) {</span>
<a href="#l9.33"></a><span id="l9.33" class="difflineminus">-    var statement = DBConn.createStatement(&quot;UPDATE tags SET name = :name WHERE id = :id&quot;);</span>
<a href="#l9.34"></a><span id="l9.34" class="difflineplus">+    let statement = DBConn.createStatement(&quot;UPDATE tags SET name = :name WHERE id = :id&quot;);</span>
<a href="#l9.35"></a><span id="l9.35">     statement.params.name = aNewName;</span>
<a href="#l9.36"></a><span id="l9.36">     statement.params.id = this._id;</span>
<a href="#l9.37"></a><span id="l9.37">     statement.execute();</span>
<a href="#l9.38"></a><span id="l9.38"> </span>
<a href="#l9.39"></a><span id="l9.39">     //FIXME move the account buddies if some use this tag as their group</span>
<a href="#l9.40"></a><span id="l9.40">     return aNewName;</span>
<a href="#l9.41"></a><span id="l9.41">   },</span>
<a href="#l9.42"></a><span id="l9.42">   getContacts: function(aContactCount) {</span>
<a href="#l9.43"></a><span id="l9.43" class="difflineat">@@ -224,17 +222,17 @@ Tag.prototype = {</span>
<a href="#l9.44"></a><span id="l9.44">     this._observers = this._observers.filter(function(o) o !== aObserver);</span>
<a href="#l9.45"></a><span id="l9.45">   },</span>
<a href="#l9.46"></a><span id="l9.46">   notifyObservers: function(aSubject, aTopic, aData) {</span>
<a href="#l9.47"></a><span id="l9.47">     for each (let observer in this._observers)</span>
<a href="#l9.48"></a><span id="l9.48">       observer.observe(aSubject, aTopic, aData);</span>
<a href="#l9.49"></a><span id="l9.49">   },</span>
<a href="#l9.50"></a><span id="l9.50"> </span>
<a href="#l9.51"></a><span id="l9.51">   getInterfaces: function(countRef) {</span>
<a href="#l9.52"></a><span id="l9.52" class="difflineminus">-    var interfaces = [Ci.nsIClassInfo, Ci.nsISupports, Ci.imITag];</span>
<a href="#l9.53"></a><span id="l9.53" class="difflineplus">+    let interfaces = [Ci.nsIClassInfo, Ci.nsISupports, Ci.imITag];</span>
<a href="#l9.54"></a><span id="l9.54">     countRef.value = interfaces.length;</span>
<a href="#l9.55"></a><span id="l9.55">     return interfaces;</span>
<a href="#l9.56"></a><span id="l9.56">   },</span>
<a href="#l9.57"></a><span id="l9.57">   getHelperForLanguage: function(language) null,</span>
<a href="#l9.58"></a><span id="l9.58">   implementationLanguage: Ci.nsIProgrammingLanguage.JAVASCRIPT,</span>
<a href="#l9.59"></a><span id="l9.59">   flags: 0,</span>
<a href="#l9.60"></a><span id="l9.60">   QueryInterface: XPCOMUtils.generateQI([Ci.imITag, Ci.nsIClassInfo])</span>
<a href="#l9.61"></a><span id="l9.61"> };</span>
<a href="#l9.62"></a><span id="l9.62" class="difflineat">@@ -354,17 +352,17 @@ var otherContactsTag = {</span>
<a href="#l9.63"></a><span id="l9.63">     this._observers = this._observers.filter(function(o) o !== aObserver);</span>
<a href="#l9.64"></a><span id="l9.64">   },</span>
<a href="#l9.65"></a><span id="l9.65">   notifyObservers: function(aSubject, aTopic, aData) {</span>
<a href="#l9.66"></a><span id="l9.66">     for each (let observer in this._observers)</span>
<a href="#l9.67"></a><span id="l9.67">       observer.observe(aSubject, aTopic, aData);</span>
<a href="#l9.68"></a><span id="l9.68">   },</span>
<a href="#l9.69"></a><span id="l9.69"> </span>
<a href="#l9.70"></a><span id="l9.70">   getInterfaces: function(countRef) {</span>
<a href="#l9.71"></a><span id="l9.71" class="difflineminus">-    var interfaces = [Ci.nsIClassInfo, Ci.nsISupports, Ci.nsIObserver, Ci.imITag];</span>
<a href="#l9.72"></a><span id="l9.72" class="difflineplus">+    let interfaces = [Ci.nsIClassInfo, Ci.nsISupports, Ci.nsIObserver, Ci.imITag];</span>
<a href="#l9.73"></a><span id="l9.73">     countRef.value = interfaces.length;</span>
<a href="#l9.74"></a><span id="l9.74">     return interfaces;</span>
<a href="#l9.75"></a><span id="l9.75">   },</span>
<a href="#l9.76"></a><span id="l9.76">   getHelperForLanguage: function(language) null,</span>
<a href="#l9.77"></a><span id="l9.77">   implementationLanguage: Ci.nsIProgrammingLanguage.JAVASCRIPT,</span>
<a href="#l9.78"></a><span id="l9.78">   flags: 0,</span>
<a href="#l9.79"></a><span id="l9.79">   QueryInterface: XPCOMUtils.generateQI([Ci.imITag, Ci.nsIObserver, Ci.nsIClassInfo])</span>
<a href="#l9.80"></a><span id="l9.80"> };</span>
<a href="#l9.81"></a><span id="l9.81" class="difflineat">@@ -876,17 +874,17 @@ Contact.prototype = {</span>
<a href="#l9.82"></a><span id="l9.82">         this._notifyObservers(&quot;added&quot;);</span>
<a href="#l9.83"></a><span id="l9.83">         break;</span>
<a href="#l9.84"></a><span id="l9.84">       case &quot;buddy-removed&quot;:</span>
<a href="#l9.85"></a><span id="l9.85">         this._removeBuddy(aSubject);</span>
<a href="#l9.86"></a><span id="l9.86">     }</span>
<a href="#l9.87"></a><span id="l9.87">   },</span>
<a href="#l9.88"></a><span id="l9.88"> </span>
<a href="#l9.89"></a><span id="l9.89">   getInterfaces: function(countRef) {</span>
<a href="#l9.90"></a><span id="l9.90" class="difflineminus">-    var interfaces = [Ci.nsIClassInfo, Ci.nsISupports, Ci.imIContact];</span>
<a href="#l9.91"></a><span id="l9.91" class="difflineplus">+    let interfaces = [Ci.nsIClassInfo, Ci.nsISupports, Ci.imIContact];</span>
<a href="#l9.92"></a><span id="l9.92">     countRef.value = interfaces.length;</span>
<a href="#l9.93"></a><span id="l9.93">     return interfaces;</span>
<a href="#l9.94"></a><span id="l9.94">   },</span>
<a href="#l9.95"></a><span id="l9.95">   getHelperForLanguage: function(language) null,</span>
<a href="#l9.96"></a><span id="l9.96">   implementationLanguage: Ci.nsIProgrammingLanguage.JAVASCRIPT,</span>
<a href="#l9.97"></a><span id="l9.97">   flags: 0,</span>
<a href="#l9.98"></a><span id="l9.98">   QueryInterface: XPCOMUtils.generateQI([Ci.imIContact, Ci.nsIClassInfo])</span>
<a href="#l9.99"></a><span id="l9.99"> };</span>
<a href="#l9.100"></a><span id="l9.100" class="difflineat">@@ -1186,31 +1184,31 @@ Buddy.prototype = {</span>
<a href="#l9.101"></a><span id="l9.101">           }</span>
<a href="#l9.102"></a><span id="l9.102">           this.contact._moved(aSubject.tag);</span>
<a href="#l9.103"></a><span id="l9.103">         }</span>
<a href="#l9.104"></a><span id="l9.104">         break;</span>
<a href="#l9.105"></a><span id="l9.105">     }</span>
<a href="#l9.106"></a><span id="l9.106">   },</span>
<a href="#l9.107"></a><span id="l9.107"> </span>
<a href="#l9.108"></a><span id="l9.108">   getInterfaces: function(countRef) {</span>
<a href="#l9.109"></a><span id="l9.109" class="difflineminus">-    var interfaces = [Ci.nsIClassInfo, Ci.nsISupports, Ci.imIBuddy];</span>
<a href="#l9.110"></a><span id="l9.110" class="difflineplus">+    let interfaces = [Ci.nsIClassInfo, Ci.nsISupports, Ci.imIBuddy];</span>
<a href="#l9.111"></a><span id="l9.111">     countRef.value = interfaces.length;</span>
<a href="#l9.112"></a><span id="l9.112">     return interfaces;</span>
<a href="#l9.113"></a><span id="l9.113">   },</span>
<a href="#l9.114"></a><span id="l9.114">   getHelperForLanguage: function(language) null,</span>
<a href="#l9.115"></a><span id="l9.115">   implementationLanguage: Ci.nsIProgrammingLanguage.JAVASCRIPT,</span>
<a href="#l9.116"></a><span id="l9.116">   flags: 0,</span>
<a href="#l9.117"></a><span id="l9.117">   QueryInterface: XPCOMUtils.generateQI([Ci.imIBuddy, Ci.nsIClassInfo])</span>
<a href="#l9.118"></a><span id="l9.118"> };</span>
<a href="#l9.119"></a><span id="l9.119"> </span>
<a href="#l9.120"></a><span id="l9.120"> </span>
<a href="#l9.121"></a><span id="l9.121"> function ContactsService() { }</span>
<a href="#l9.122"></a><span id="l9.122"> ContactsService.prototype = {</span>
<a href="#l9.123"></a><span id="l9.123">   initContacts: function() {</span>
<a href="#l9.124"></a><span id="l9.124" class="difflineminus">-    var statement = DBConn.createStatement(&quot;SELECT id, name FROM tags&quot;);</span>
<a href="#l9.125"></a><span id="l9.125" class="difflineplus">+    let statement = DBConn.createStatement(&quot;SELECT id, name FROM tags&quot;);</span>
<a href="#l9.126"></a><span id="l9.126">     while (statement.executeStep())</span>
<a href="#l9.127"></a><span id="l9.127">       Tags.push(new Tag(statement.getInt32(0), statement.getUTF8String(1)));</span>
<a href="#l9.128"></a><span id="l9.128"> </span>
<a href="#l9.129"></a><span id="l9.129">     statement = DBConn.createStatement(&quot;SELECT id, alias FROM contacts&quot;);</span>
<a href="#l9.130"></a><span id="l9.130">     while (statement.executeStep())</span>
<a href="#l9.131"></a><span id="l9.131">       new Contact(statement.getInt32(0), statement.getUTF8String(1));</span>
<a href="#l9.132"></a><span id="l9.132"> </span>
<a href="#l9.133"></a><span id="l9.133">     statement =</span>
<a href="#l9.134"></a><span id="l9.134" class="difflineat">@@ -1248,21 +1246,21 @@ ContactsService.prototype = {</span>
<a href="#l9.135"></a><span id="l9.135">                        &quot;account_id = &quot; + accountId + &quot;, buddy_id = &quot; + buddyId +</span>
<a href="#l9.136"></a><span id="l9.136">                        &quot;, tag_id = &quot; + tagId);</span>
<a href="#l9.137"></a><span id="l9.137">         continue;</span>
<a href="#l9.138"></a><span id="l9.138">       }</span>
<a href="#l9.139"></a><span id="l9.139"> </span>
<a href="#l9.140"></a><span id="l9.140">       let account = Services.accounts.getAccountByNumericId(accountId);</span>
<a href="#l9.141"></a><span id="l9.141">       let tag = TagsById[tagId];</span>
<a href="#l9.142"></a><span id="l9.142">       try {</span>
<a href="#l9.143"></a><span id="l9.143" class="difflineminus">-        let ab = account.loadBuddy(buddy, tag);</span>
<a href="#l9.144"></a><span id="l9.144" class="difflineminus">-        if (ab)</span>
<a href="#l9.145"></a><span id="l9.145" class="difflineminus">-          buddy._addAccount(ab, tag);</span>
<a href="#l9.146"></a><span id="l9.146" class="difflineplus">+        let accountBuddy = account.loadBuddy(buddy, tag);</span>
<a href="#l9.147"></a><span id="l9.147" class="difflineplus">+        if (accountBuddy)</span>
<a href="#l9.148"></a><span id="l9.148" class="difflineplus">+          buddy._addAccount(accountBuddy, tag);</span>
<a href="#l9.149"></a><span id="l9.149">       } catch (e) {</span>
<a href="#l9.150"></a><span id="l9.150" class="difflineminus">-        // FIXME ab shouldn't be NULL (once purpleAccount is finished)</span>
<a href="#l9.151"></a><span id="l9.151" class="difflineplus">+        // FIXME accountBuddy shouldn't be NULL (once imAccounts.js is finished)</span>
<a href="#l9.152"></a><span id="l9.152">         // It currently doesn't work right with unknown protocols.</span>
<a href="#l9.153"></a><span id="l9.153">         Components.utils.reportError(e);</span>
<a href="#l9.154"></a><span id="l9.154">         dump(e + &quot;\n&quot;);</span>
<a href="#l9.155"></a><span id="l9.155">       }</span>
<a href="#l9.156"></a><span id="l9.156">     }</span>
<a href="#l9.157"></a><span id="l9.157"> </span>
<a href="#l9.158"></a><span id="l9.158">     otherContactsTag._initHiddenTags();</span>
<a href="#l9.159"></a><span id="l9.159">   },</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/chat/components/src/imCore.js</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/chat/components/src/imCore.js</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -192,18 +192,17 @@ UserStatus.prototype = {</span>
<a href="#l10.4"></a><span id="l10.4">     if (aStatus != Ci.imIStatusInfo.STATUS_UNKNOWN)</span>
<a href="#l10.5"></a><span id="l10.5">       this._statusType = aStatus;</span>
<a href="#l10.6"></a><span id="l10.6">     if (aStatus != Ci.imIStatusInfo.STATUS_OFFLINE)</span>
<a href="#l10.7"></a><span id="l10.7">       this._statusText = aMessage;</span>
<a href="#l10.8"></a><span id="l10.8">     this._notifyObservers(&quot;status-changed&quot;, aMessage);</span>
<a href="#l10.9"></a><span id="l10.9">   },</span>
<a href="#l10.10"></a><span id="l10.10"> </span>
<a href="#l10.11"></a><span id="l10.11">   _getProfileDir: function()</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-    Cc[&quot;@mozilla.org/file/directory_service;1&quot;].getService(Ci.nsIProperties)</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineminus">-      .get(&quot;ProfD&quot; /*NS_APP_USER_PROFILE_50_DIR*/, Ci.nsIFile),</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineplus">+    Services.dirsvc.get(&quot;ProfD&quot;, Ci.nsIFile),</span>
<a href="#l10.15"></a><span id="l10.15">   setUserIcon: function(aIconFile) {</span>
<a href="#l10.16"></a><span id="l10.16">     let folder = this._getProfileDir();</span>
<a href="#l10.17"></a><span id="l10.17"> </span>
<a href="#l10.18"></a><span id="l10.18">     let newName = &quot;&quot;;</span>
<a href="#l10.19"></a><span id="l10.19">     if (aIconFile) {</span>
<a href="#l10.20"></a><span id="l10.20">       // Get the extension (remove trailing dots - invalid Windows extension).</span>
<a href="#l10.21"></a><span id="l10.21">       let ext = aIconFile.leafName.replace(/.*(\.[a-z0-9]+)\.*/i, &quot;$1&quot;);</span>
<a href="#l10.22"></a><span id="l10.22">       // newName = userIcon-&lt;timestamp(now)&gt;.&lt;aIconFile.extension&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/chat/components/src/logger.js</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/chat/components/src/logger.js</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -30,53 +30,38 @@</span>
<a href="#l11.4"></a><span id="l11.4">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l11.5"></a><span id="l11.5">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l11.6"></a><span id="l11.6">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l11.7"></a><span id="l11.7">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l11.8"></a><span id="l11.8">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l11.9"></a><span id="l11.9">  *</span>
<a href="#l11.10"></a><span id="l11.10">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l11.11"></a><span id="l11.11"> </span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-#filter substitution</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineminus">-#ifdef XP_WIN</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineminus">-#define LINE_BREAK \r\n</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineminus">-#else</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineminus">-#define LINE_BREAK \n</span>
<a href="#l11.17"></a><span id="l11.17" class="difflineminus">-#endif</span>
<a href="#l11.18"></a><span id="l11.18" class="difflineminus">-</span>
<a href="#l11.19"></a><span id="l11.19" class="difflineminus">-Components.utils.import(&quot;resource:///modules/hiddenWindow.jsm&quot;);</span>
<a href="#l11.20"></a><span id="l11.20" class="difflineminus">-Components.utils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineminus">-Components.utils.import(&quot;resource:///modules/imXPCOMUtils.jsm&quot;);</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineminus">-Components.utils.import(&quot;resource:///modules/jsProtoHelper.jsm&quot;);</span>
<a href="#l11.23"></a><span id="l11.23" class="difflineplus">+const {classes: Cc, interfaces: Ci, utils: Cu, Constructor: CC} = Components;</span>
<a href="#l11.24"></a><span id="l11.24"> </span>
<a href="#l11.25"></a><span id="l11.25" class="difflineminus">-const Cc = Components.classes;</span>
<a href="#l11.26"></a><span id="l11.26" class="difflineminus">-const Ci = Components.interfaces;</span>
<a href="#l11.27"></a><span id="l11.27" class="difflineminus">-const CC = Components.Constructor;</span>
<a href="#l11.28"></a><span id="l11.28" class="difflineplus">+Cu.import(&quot;resource:///modules/hiddenWindow.jsm&quot;);</span>
<a href="#l11.29"></a><span id="l11.29" class="difflineplus">+Cu.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l11.30"></a><span id="l11.30" class="difflineplus">+Cu.import(&quot;resource:///modules/imXPCOMUtils.jsm&quot;);</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineplus">+Cu.import(&quot;resource:///modules/jsProtoHelper.jsm&quot;);</span>
<a href="#l11.32"></a><span id="l11.32"> </span>
<a href="#l11.33"></a><span id="l11.33" class="difflineminus">-XPCOMUtils.defineLazyServiceGetter(this, &quot;obs&quot;,</span>
<a href="#l11.34"></a><span id="l11.34" class="difflineminus">-                                   &quot;@mozilla.org/observer-service;1&quot;,</span>
<a href="#l11.35"></a><span id="l11.35" class="difflineminus">-                                   &quot;nsIObserverService&quot;);</span>
<a href="#l11.36"></a><span id="l11.36" class="difflineminus">-XPCOMUtils.defineLazyServiceGetter(this, &quot;prefs&quot;,</span>
<a href="#l11.37"></a><span id="l11.37" class="difflineminus">-                                   &quot;@mozilla.org/preferences-service;1&quot;,</span>
<a href="#l11.38"></a><span id="l11.38" class="difflineminus">-                                   &quot;nsIPrefBranch&quot;);</span>
<a href="#l11.39"></a><span id="l11.39"> XPCOMUtils.defineLazyGetter(this, &quot;logDir&quot;, function() {</span>
<a href="#l11.40"></a><span id="l11.40" class="difflineminus">-  let file = Components.classes[&quot;@mozilla.org/file/directory_service;1&quot;]</span>
<a href="#l11.41"></a><span id="l11.41" class="difflineminus">-                       .getService(Components.interfaces.nsIProperties)</span>
<a href="#l11.42"></a><span id="l11.42" class="difflineminus">-                       .get(&quot;ProfD&quot;, Components.interfaces.nsIFile);</span>
<a href="#l11.43"></a><span id="l11.43" class="difflineplus">+  let file = Services.dirsvc.get(&quot;ProfD&quot;, Ci.nsIFile);</span>
<a href="#l11.44"></a><span id="l11.44">   file.append(&quot;logs&quot;);</span>
<a href="#l11.45"></a><span id="l11.45">   return file;</span>
<a href="#l11.46"></a><span id="l11.46"> });</span>
<a href="#l11.47"></a><span id="l11.47"> </span>
<a href="#l11.48"></a><span id="l11.48"> const FileInputStream = CC(&quot;@mozilla.org/network/file-input-stream;1&quot;,</span>
<a href="#l11.49"></a><span id="l11.49">                            &quot;nsIFileInputStream&quot;,</span>
<a href="#l11.50"></a><span id="l11.50">                            &quot;init&quot;);</span>
<a href="#l11.51"></a><span id="l11.51"> const ConverterInputStream = CC(&quot;@mozilla.org/intl/converter-input-stream;1&quot;,</span>
<a href="#l11.52"></a><span id="l11.52">                                 &quot;nsIConverterInputStream&quot;,</span>
<a href="#l11.53"></a><span id="l11.53">                                 &quot;init&quot;);</span>
<a href="#l11.54"></a><span id="l11.54"> </span>
<a href="#l11.55"></a><span id="l11.55" class="difflineplus">+const kLineBreak = &quot;@mozilla.org/windows-registry-key;1&quot; in Cc ? &quot;\r\n&quot; : &quot;\n&quot;;</span>
<a href="#l11.56"></a><span id="l11.56" class="difflineplus">+</span>
<a href="#l11.57"></a><span id="l11.57"> function getLogFolderForAccount(aAccount, aCreate)</span>
<a href="#l11.58"></a><span id="l11.58"> {</span>
<a href="#l11.59"></a><span id="l11.59">   let file = logDir.clone();</span>
<a href="#l11.60"></a><span id="l11.60">   function createIfNotExists(aFile) {</span>
<a href="#l11.61"></a><span id="l11.61">     if (aCreate &amp;&amp; !aFile.exists())</span>
<a href="#l11.62"></a><span id="l11.62">       aFile.create(Ci.nsIFile.DIRECTORY_TYPE, 0777);</span>
<a href="#l11.63"></a><span id="l11.63">   }</span>
<a href="#l11.64"></a><span id="l11.64">   createIfNotExists(file);</span>
<a href="#l11.65"></a><span id="l11.65" class="difflineat">@@ -115,17 +100,17 @@ function ConversationLog(aConversation)</span>
<a href="#l11.66"></a><span id="l11.66"> ConversationLog.prototype = {</span>
<a href="#l11.67"></a><span id="l11.67">   _log: null,</span>
<a href="#l11.68"></a><span id="l11.68">   format: &quot;txt&quot;,</span>
<a href="#l11.69"></a><span id="l11.69">   _init: function cl_init() {</span>
<a href="#l11.70"></a><span id="l11.70">     let file = getLogFolderForAccount(this._conv.account, true);</span>
<a href="#l11.71"></a><span id="l11.71">     file.append(this._conv.normalizedName);</span>
<a href="#l11.72"></a><span id="l11.72">     if (!file.exists())</span>
<a href="#l11.73"></a><span id="l11.73">       file.create(Ci.nsIFile.DIRECTORY_TYPE, 0777);</span>
<a href="#l11.74"></a><span id="l11.74" class="difflineminus">-    if (prefs.getCharPref(&quot;purple.logging.format&quot;) == &quot;json&quot;)</span>
<a href="#l11.75"></a><span id="l11.75" class="difflineplus">+    if (Services.prefs.getCharPref(&quot;purple.logging.format&quot;) == &quot;json&quot;)</span>
<a href="#l11.76"></a><span id="l11.76">       this.format = &quot;json&quot;;</span>
<a href="#l11.77"></a><span id="l11.77">     file.append(getNewLogFileName(this.format));</span>
<a href="#l11.78"></a><span id="l11.78">     let os = Cc[&quot;@mozilla.org/network/file-output-stream;1&quot;].</span>
<a href="#l11.79"></a><span id="l11.79">              createInstance(Ci.nsIFileOutputStream);</span>
<a href="#l11.80"></a><span id="l11.80">     const PR_WRITE_ONLY   = 0x02;</span>
<a href="#l11.81"></a><span id="l11.81">     const PR_CREATE_FILE  = 0x08;</span>
<a href="#l11.82"></a><span id="l11.82">     const PR_APPEND       = 0x10;</span>
<a href="#l11.83"></a><span id="l11.83">     os.init(file, PR_WRITE_ONLY | PR_CREATE_FILE | PR_APPEND, 0666, 0);</span>
<a href="#l11.84"></a><span id="l11.84" class="difflineat">@@ -145,17 +130,17 @@ ConversationLog.prototype = {</span>
<a href="#l11.85"></a><span id="l11.85">                              title: this._conv.title,</span>
<a href="#l11.86"></a><span id="l11.86">                              account: account.normalizedName,</span>
<a href="#l11.87"></a><span id="l11.87">                              protocol: account.protocol.normalizedName</span>
<a href="#l11.88"></a><span id="l11.88">                             }) + &quot;\n&quot;;</span>
<a href="#l11.89"></a><span id="l11.89">     }</span>
<a href="#l11.90"></a><span id="l11.90">     return &quot;Conversation with &quot; + this._conv.name +</span>
<a href="#l11.91"></a><span id="l11.91">            &quot; at &quot; + (new Date).toLocaleString() +</span>
<a href="#l11.92"></a><span id="l11.92">            &quot; on &quot; + account.name +</span>
<a href="#l11.93"></a><span id="l11.93" class="difflineminus">-           &quot; (&quot; + account.protocol.normalizedName + &quot;)@LINE_BREAK@&quot;;</span>
<a href="#l11.94"></a><span id="l11.94" class="difflineplus">+           &quot; (&quot; + account.protocol.normalizedName + &quot;)&quot; + kLineBreak;</span>
<a href="#l11.95"></a><span id="l11.95">   },</span>
<a href="#l11.96"></a><span id="l11.96">   _serialize: function cl_serialize(aString) {</span>
<a href="#l11.97"></a><span id="l11.97">     // TODO cleanup once bug 102699 is fixed</span>
<a href="#l11.98"></a><span id="l11.98">     let doc = getHiddenHTMLWindow().document;</span>
<a href="#l11.99"></a><span id="l11.99">     let div = doc.createElementNS(&quot;http://www.w3.org/1999/xhtml&quot;, &quot;div&quot;);</span>
<a href="#l11.100"></a><span id="l11.100">     div.innerHTML = aString.replace(/\r?\n/g, &quot;&lt;br/&gt;&quot;).replace(/&lt;br&gt;/gi, &quot;&lt;br/&gt;&quot;);</span>
<a href="#l11.101"></a><span id="l11.101">     const type = &quot;text/plain&quot;;</span>
<a href="#l11.102"></a><span id="l11.102">     let encoder =</span>
<a href="#l11.103"></a><span id="l11.103" class="difflineat">@@ -206,17 +191,17 @@ ConversationLog.prototype = {</span>
<a href="#l11.104"></a><span id="l11.104">         line += sender + &quot; &lt;AUTO-REPLY&gt;: &quot; + msg;</span>
<a href="#l11.105"></a><span id="l11.105">       else {</span>
<a href="#l11.106"></a><span id="l11.106">         if (/^\/me /.test(msg))</span>
<a href="#l11.107"></a><span id="l11.107">           line += &quot;***&quot; + sender + &quot; &quot; + msg.replace(/^\/me /, &quot;&quot;);</span>
<a href="#l11.108"></a><span id="l11.108">         else</span>
<a href="#l11.109"></a><span id="l11.109">           line += sender + &quot;: &quot; + msg;</span>
<a href="#l11.110"></a><span id="l11.110">       }</span>
<a href="#l11.111"></a><span id="l11.111">     }</span>
<a href="#l11.112"></a><span id="l11.112" class="difflineminus">-    this._log.writeString(line + &quot;@LINE_BREAK@&quot;);</span>
<a href="#l11.113"></a><span id="l11.113" class="difflineplus">+    this._log.writeString(line + kLineBreak);</span>
<a href="#l11.114"></a><span id="l11.114">   },</span>
<a href="#l11.115"></a><span id="l11.115"> </span>
<a href="#l11.116"></a><span id="l11.116">   close: function cl_close() {</span>
<a href="#l11.117"></a><span id="l11.117">     if (this._log) {</span>
<a href="#l11.118"></a><span id="l11.118">       this._log.close();</span>
<a href="#l11.119"></a><span id="l11.119">       this._log = null;</span>
<a href="#l11.120"></a><span id="l11.120">     }</span>
<a href="#l11.121"></a><span id="l11.121">   }</span>
<a href="#l11.122"></a><span id="l11.122" class="difflineat">@@ -229,17 +214,17 @@ const dummyConversationLog = {</span>
<a href="#l11.123"></a><span id="l11.123"> </span>
<a href="#l11.124"></a><span id="l11.124"> var gConversationLogs = { };</span>
<a href="#l11.125"></a><span id="l11.125"> function getLogForConversation(aConversation)</span>
<a href="#l11.126"></a><span id="l11.126"> {</span>
<a href="#l11.127"></a><span id="l11.127">   let id = aConversation.id;</span>
<a href="#l11.128"></a><span id="l11.128">   if (!(id in gConversationLogs)) {</span>
<a href="#l11.129"></a><span id="l11.129">     let prefName =</span>
<a href="#l11.130"></a><span id="l11.130">       &quot;purple.logging.log_&quot; + (aConversation.isChat ? &quot;chats&quot; : &quot;ims&quot;);</span>
<a href="#l11.131"></a><span id="l11.131" class="difflineminus">-    if (prefs.getBoolPref(prefName))</span>
<a href="#l11.132"></a><span id="l11.132" class="difflineplus">+    if (Services.prefs.getBoolPref(prefName))</span>
<a href="#l11.133"></a><span id="l11.133">       gConversationLogs[id] = new ConversationLog(aConversation);</span>
<a href="#l11.134"></a><span id="l11.134">     else</span>
<a href="#l11.135"></a><span id="l11.135">       gConversationLogs[id] = dummyConversationLog;</span>
<a href="#l11.136"></a><span id="l11.136">   }</span>
<a href="#l11.137"></a><span id="l11.137">   return gConversationLogs[id];</span>
<a href="#l11.138"></a><span id="l11.138"> }</span>
<a href="#l11.139"></a><span id="l11.139"> </span>
<a href="#l11.140"></a><span id="l11.140"> function closeLogForConversation(aConversation)</span>
<a href="#l11.141"></a><span id="l11.141" class="difflineat">@@ -253,17 +238,17 @@ function closeLogForConversation(aConver</span>
<a href="#l11.142"></a><span id="l11.142"> </span>
<a href="#l11.143"></a><span id="l11.143"> /* System logs stuff */</span>
<a href="#l11.144"></a><span id="l11.144"> function SystemLog(aAccount)</span>
<a href="#l11.145"></a><span id="l11.145"> {</span>
<a href="#l11.146"></a><span id="l11.146">   this._init(aAccount);</span>
<a href="#l11.147"></a><span id="l11.147">   this._log.writeString(&quot;System log for account &quot; + aAccount.name +</span>
<a href="#l11.148"></a><span id="l11.148">                         &quot; (&quot; + aAccount.protocol.normalizedName +</span>
<a href="#l11.149"></a><span id="l11.149">                         &quot;) connected at &quot; +</span>
<a href="#l11.150"></a><span id="l11.150" class="difflineminus">-                        (new Date()).toLocaleFormat(&quot;%c&quot;) + &quot;@LINE_BREAK@&quot;);</span>
<a href="#l11.151"></a><span id="l11.151" class="difflineplus">+                        (new Date()).toLocaleFormat(&quot;%c&quot;) + kLineBreak);</span>
<a href="#l11.152"></a><span id="l11.152"> }</span>
<a href="#l11.153"></a><span id="l11.153"> SystemLog.prototype = {</span>
<a href="#l11.154"></a><span id="l11.154">   _log: null,</span>
<a href="#l11.155"></a><span id="l11.155">   _init: function sl_init(aAccount) {</span>
<a href="#l11.156"></a><span id="l11.156">     let file = getLogFolderForAccount(aAccount, true);</span>
<a href="#l11.157"></a><span id="l11.157">     file.append(&quot;.system&quot;);</span>
<a href="#l11.158"></a><span id="l11.158">     if (!file.exists())</span>
<a href="#l11.159"></a><span id="l11.159">       file.create(Ci.nsIFile.DIRECTORY_TYPE, 0777);</span>
<a href="#l11.160"></a><span id="l11.160" class="difflineat">@@ -280,17 +265,17 @@ SystemLog.prototype = {</span>
<a href="#l11.161"></a><span id="l11.161">     converter.init(os, &quot;UTF-8&quot;, 0, 0);</span>
<a href="#l11.162"></a><span id="l11.162">     this._log = converter;</span>
<a href="#l11.163"></a><span id="l11.163">   },</span>
<a href="#l11.164"></a><span id="l11.164">   logEvent: function sl_logEvent(aString) {</span>
<a href="#l11.165"></a><span id="l11.165">     if (!this._log)</span>
<a href="#l11.166"></a><span id="l11.166">       this._init();</span>
<a href="#l11.167"></a><span id="l11.167"> </span>
<a href="#l11.168"></a><span id="l11.168">     let date = (new Date()).toLocaleFormat(&quot;%x %X&quot;);</span>
<a href="#l11.169"></a><span id="l11.169" class="difflineminus">-    this._log.writeString(&quot;---- &quot; + aString + &quot; @ &quot; + date + &quot; ----@LINE_BREAK@&quot;);</span>
<a href="#l11.170"></a><span id="l11.170" class="difflineplus">+    this._log.writeString(&quot;---- &quot; + aString + &quot; @ &quot; + date + &quot; ----&quot; + kLineBreak);</span>
<a href="#l11.171"></a><span id="l11.171">   },</span>
<a href="#l11.172"></a><span id="l11.172"> </span>
<a href="#l11.173"></a><span id="l11.173">   close: function sl_close() {</span>
<a href="#l11.174"></a><span id="l11.174">     if (this._log) {</span>
<a href="#l11.175"></a><span id="l11.175">       this._log.close();</span>
<a href="#l11.176"></a><span id="l11.176">       this._log = null;</span>
<a href="#l11.177"></a><span id="l11.177">     }</span>
<a href="#l11.178"></a><span id="l11.178">   }</span>
<a href="#l11.179"></a><span id="l11.179" class="difflineat">@@ -303,17 +288,17 @@ const dummySystemLog = {</span>
<a href="#l11.180"></a><span id="l11.180"> </span>
<a href="#l11.181"></a><span id="l11.181"> var gSystemLogs = { };</span>
<a href="#l11.182"></a><span id="l11.182"> function getLogForAccount(aAccount, aCreate)</span>
<a href="#l11.183"></a><span id="l11.183"> {</span>
<a href="#l11.184"></a><span id="l11.184">   let id = aAccount.id;</span>
<a href="#l11.185"></a><span id="l11.185">   if (aCreate) {</span>
<a href="#l11.186"></a><span id="l11.186">     if (id in gSystemLogs)</span>
<a href="#l11.187"></a><span id="l11.187">       gSystemLogs[id].close();</span>
<a href="#l11.188"></a><span id="l11.188" class="difflineminus">-    if (!prefs.getBoolPref(&quot;purple.logging.log_system&quot;))</span>
<a href="#l11.189"></a><span id="l11.189" class="difflineplus">+    if (!Services.prefs.getBoolPref(&quot;purple.logging.log_system&quot;))</span>
<a href="#l11.190"></a><span id="l11.190">       return dummySystemLog;</span>
<a href="#l11.191"></a><span id="l11.191">     return (gSystemLogs[id] = new SystemLog(aAccount));</span>
<a href="#l11.192"></a><span id="l11.192">   }</span>
<a href="#l11.193"></a><span id="l11.193"> </span>
<a href="#l11.194"></a><span id="l11.194">   return (id in gSystemLogs) &amp;&amp; gSystemLogs[id] || dummySystemLog;</span>
<a href="#l11.195"></a><span id="l11.195"> }</span>
<a href="#l11.196"></a><span id="l11.196"> </span>
<a href="#l11.197"></a><span id="l11.197"> function closeLogForAccount(aAccount)</span>
<a href="#l11.198"></a><span id="l11.198" class="difflineat">@@ -461,36 +446,32 @@ Logger.prototype = {</span>
<a href="#l11.199"></a><span id="l11.199">   getLogsForConversation: function logger_getLogsForConversation(aConversation)</span>
<a href="#l11.200"></a><span id="l11.200">     this._enumerateLogs(aConversation.account, aConversation.normalizedName),</span>
<a href="#l11.201"></a><span id="l11.201">   getSystemLogsForAccount: function logger_getSystemLogsForAccount(aAccount)</span>
<a href="#l11.202"></a><span id="l11.202">     this._enumerateLogs(aAccount, &quot;.system&quot;),</span>
<a href="#l11.203"></a><span id="l11.203"> </span>
<a href="#l11.204"></a><span id="l11.204">   observe: function logger_observe(aSubject, aTopic, aData) {</span>
<a href="#l11.205"></a><span id="l11.205">     switch (aTopic) {</span>
<a href="#l11.206"></a><span id="l11.206">     case &quot;profile-after-change&quot;:</span>
<a href="#l11.207"></a><span id="l11.207" class="difflineminus">-      obs.addObserver(this, &quot;final-ui-startup&quot;, false);</span>
<a href="#l11.208"></a><span id="l11.208" class="difflineplus">+      Services.obs.addObserver(this, &quot;final-ui-startup&quot;, false);</span>
<a href="#l11.209"></a><span id="l11.209">       break;</span>
<a href="#l11.210"></a><span id="l11.210">     case &quot;final-ui-startup&quot;:</span>
<a href="#l11.211"></a><span id="l11.211" class="difflineminus">-      obs.removeObserver(this, &quot;final-ui-startup&quot;);</span>
<a href="#l11.212"></a><span id="l11.212" class="difflineminus">-      [&quot;new-conversation&quot;, &quot;new-text&quot;,</span>
<a href="#l11.213"></a><span id="l11.213" class="difflineminus">-       &quot;conversation-closed&quot;, &quot;conversation-left-chat&quot;,</span>
<a href="#l11.214"></a><span id="l11.214" class="difflineplus">+      Services.obs.removeObserver(this, &quot;final-ui-startup&quot;);</span>
<a href="#l11.215"></a><span id="l11.215" class="difflineplus">+      [&quot;new-text&quot;, &quot;conversation-closed&quot;, &quot;conversation-left-chat&quot;,</span>
<a href="#l11.216"></a><span id="l11.216">        &quot;account-connected&quot;, &quot;account-disconnected&quot;,</span>
<a href="#l11.217"></a><span id="l11.217">        &quot;account-buddy-status-changed&quot;].forEach(function(aEvent) {</span>
<a href="#l11.218"></a><span id="l11.218" class="difflineminus">-        obs.addObserver(this, aEvent, false);</span>
<a href="#l11.219"></a><span id="l11.219" class="difflineplus">+        Services.obs.addObserver(this, aEvent, false);</span>
<a href="#l11.220"></a><span id="l11.220">       }, this);</span>
<a href="#l11.221"></a><span id="l11.221">       break;</span>
<a href="#l11.222"></a><span id="l11.222">     case &quot;new-text&quot;:</span>
<a href="#l11.223"></a><span id="l11.223">       if (!aSubject.noLog) {</span>
<a href="#l11.224"></a><span id="l11.224">         let log = getLogForConversation(aSubject.conversation);</span>
<a href="#l11.225"></a><span id="l11.225">         log.logMessage(aSubject);</span>
<a href="#l11.226"></a><span id="l11.226">       }</span>
<a href="#l11.227"></a><span id="l11.227">       break;</span>
<a href="#l11.228"></a><span id="l11.228" class="difflineminus">-    case &quot;new-conversation&quot;:</span>
<a href="#l11.229"></a><span id="l11.229" class="difflineminus">-      //XXX should we create the log file here?</span>
<a href="#l11.230"></a><span id="l11.230" class="difflineminus">-      break;</span>
<a href="#l11.231"></a><span id="l11.231">     case &quot;conversation-closed&quot;:</span>
<a href="#l11.232"></a><span id="l11.232">     case &quot;conversation-left-chat&quot;:</span>
<a href="#l11.233"></a><span id="l11.233">       closeLogForConversation(aSubject);</span>
<a href="#l11.234"></a><span id="l11.234">       break;</span>
<a href="#l11.235"></a><span id="l11.235">     case &quot;account-connected&quot;:</span>
<a href="#l11.236"></a><span id="l11.236">       getLogForAccount(aSubject, true).logEvent(&quot;+++ &quot; + aSubject.name +</span>
<a href="#l11.237"></a><span id="l11.237">                                                 &quot; signed on&quot;);</span>
<a href="#l11.238"></a><span id="l11.238">       break;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/chat/components/src/smileProtocolHandler.js</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/chat/components/src/smileProtocolHandler.js</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -30,22 +30,22 @@</span>
<a href="#l12.4"></a><span id="l12.4">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l12.5"></a><span id="l12.5">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l12.6"></a><span id="l12.6">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l12.7"></a><span id="l12.7">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l12.8"></a><span id="l12.8">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l12.9"></a><span id="l12.9">  *</span>
<a href="#l12.10"></a><span id="l12.10">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l12.11"></a><span id="l12.11"> </span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineminus">-Components.utils.import(&quot;resource:///modules/imSmileys.jsm&quot;);</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineplus">+const {classes: Cc, interfaces: Ci, utils: Cu} = Components;</span>
<a href="#l12.15"></a><span id="l12.15"> </span>
<a href="#l12.16"></a><span id="l12.16" class="difflineminus">-const Cc = Components.classes;</span>
<a href="#l12.17"></a><span id="l12.17" class="difflineminus">-const Ci = Components.interfaces;</span>
<a href="#l12.18"></a><span id="l12.18" class="difflineminus">-const smileRegexp = /^smile:\/\//;</span>
<a href="#l12.19"></a><span id="l12.19" class="difflineplus">+Cu.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l12.20"></a><span id="l12.20" class="difflineplus">+Cu.import(&quot;resource:///modules/imSmileys.jsm&quot;);</span>
<a href="#l12.21"></a><span id="l12.21" class="difflineplus">+</span>
<a href="#l12.22"></a><span id="l12.22" class="difflineplus">+const kSmileRegexp = /^smile:\/\//;</span>
<a href="#l12.23"></a><span id="l12.23"> </span>
<a href="#l12.24"></a><span id="l12.24"> function smileProtocolHandler() { }</span>
<a href="#l12.25"></a><span id="l12.25"> </span>
<a href="#l12.26"></a><span id="l12.26"> smileProtocolHandler.prototype = {</span>
<a href="#l12.27"></a><span id="l12.27">   scheme: &quot;smile&quot;,</span>
<a href="#l12.28"></a><span id="l12.28">   defaultPort: -1,</span>
<a href="#l12.29"></a><span id="l12.29">   protocolFlags: Ci.nsIProtocolHandler.URI_NORELATIVE |</span>
<a href="#l12.30"></a><span id="l12.30">                  Ci.nsIProtocolHandler.URI_NOAUTH |</span>
<a href="#l12.31"></a><span id="l12.31" class="difflineat">@@ -54,17 +54,17 @@ smileProtocolHandler.prototype = {</span>
<a href="#l12.32"></a><span id="l12.32">   newURI: function SPH_newURI(aSpec, aOriginCharset, aBaseURI) {</span>
<a href="#l12.33"></a><span id="l12.33">     let uri = Cc[&quot;@mozilla.org/network/simple-uri;1&quot;].createInstance(Ci.nsIURI);</span>
<a href="#l12.34"></a><span id="l12.34">     uri.spec = aSpec;</span>
<a href="#l12.35"></a><span id="l12.35">     uri.QueryInterface(Ci.nsIMutable);</span>
<a href="#l12.36"></a><span id="l12.36">     uri.mutable = false;</span>
<a href="#l12.37"></a><span id="l12.37">     return uri;</span>
<a href="#l12.38"></a><span id="l12.38">   },</span>
<a href="#l12.39"></a><span id="l12.39">   newChannel: function SPH_newChannel(aURI) {</span>
<a href="#l12.40"></a><span id="l12.40" class="difflineminus">-    let smile = aURI.spec.replace(smileRegexp, &quot;&quot;);</span>
<a href="#l12.41"></a><span id="l12.41" class="difflineplus">+    let smile = aURI.spec.replace(kSmileRegexp, &quot;&quot;);</span>
<a href="#l12.42"></a><span id="l12.42">     let ios = Cc[&quot;@mozilla.org/network/io-service;1&quot;].getService(Ci.nsIIOService);</span>
<a href="#l12.43"></a><span id="l12.43">     let channel = ios.newChannel(getSmileRealURI(smile), null, null);</span>
<a href="#l12.44"></a><span id="l12.44">     channel.originalURI = aURI;</span>
<a href="#l12.45"></a><span id="l12.45">     return channel;</span>
<a href="#l12.46"></a><span id="l12.46">   },</span>
<a href="#l12.47"></a><span id="l12.47">   allowPort: function  SPH_allowPort(aPort, aScheme) false,</span>
<a href="#l12.48"></a><span id="l12.48"> </span>
<a href="#l12.49"></a><span id="l12.49">   classDescription: &quot;Smile Protocol Handler&quot;,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/chat/content/browserRequest.js</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/chat/content/browserRequest.js</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -108,18 +108,18 @@ var reporterListener = {</span>
<a href="#l13.4"></a><span id="l13.4">                         /*in nsIRequest*/ aRequest,</span>
<a href="#l13.5"></a><span id="l13.5">                         /*in unsigned long*/ aState) {</span>
<a href="#l13.6"></a><span id="l13.6">     const wpl_security_bits = wpl.STATE_IS_SECURE |</span>
<a href="#l13.7"></a><span id="l13.7">                               wpl.STATE_IS_BROKEN |</span>
<a href="#l13.8"></a><span id="l13.8">                               wpl.STATE_IS_INSECURE |</span>
<a href="#l13.9"></a><span id="l13.9">                               wpl.STATE_SECURE_HIGH |</span>
<a href="#l13.10"></a><span id="l13.10">                               wpl.STATE_SECURE_MED |</span>
<a href="#l13.11"></a><span id="l13.11">                               wpl.STATE_SECURE_LOW;</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-    var browser = document.getElementById(&quot;requestFrame&quot;);</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineminus">-    var level;</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineplus">+    let browser = document.getElementById(&quot;requestFrame&quot;);</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineplus">+    let level;</span>
<a href="#l13.16"></a><span id="l13.16"> </span>
<a href="#l13.17"></a><span id="l13.17">     switch (aState &amp; wpl_security_bits) {</span>
<a href="#l13.18"></a><span id="l13.18">       case wpl.STATE_IS_SECURE | wpl.STATE_SECURE_HIGH:</span>
<a href="#l13.19"></a><span id="l13.19">         level = &quot;high&quot;;</span>
<a href="#l13.20"></a><span id="l13.20">         break;</span>
<a href="#l13.21"></a><span id="l13.21">       case wpl.STATE_IS_SECURE | wpl.STATE_SECURE_MED:</span>
<a href="#l13.22"></a><span id="l13.22">       case wpl.STATE_IS_SECURE | wpl.STATE_SECURE_LOW:</span>
<a href="#l13.23"></a><span id="l13.23">         level = &quot;low&quot;;</span>
<a href="#l13.24"></a><span id="l13.24" class="difflineat">@@ -160,17 +160,16 @@ function loadRequestedUrl()</span>
<a href="#l13.25"></a><span id="l13.25">   request.QueryInterface(Components.interfaces.prplIRequestBrowser);</span>
<a href="#l13.26"></a><span id="l13.26">   document.getElementById(&quot;headerMessage&quot;).textContent = request.promptText;</span>
<a href="#l13.27"></a><span id="l13.27">   let account = request.account;</span>
<a href="#l13.28"></a><span id="l13.28">   document.getElementById(&quot;headerLabel&quot;).value =</span>
<a href="#l13.29"></a><span id="l13.29">     account.protocol.name + &quot; - &quot; + account.name;</span>
<a href="#l13.30"></a><span id="l13.30">   document.getElementById(&quot;headerImage&quot;).src =</span>
<a href="#l13.31"></a><span id="l13.31">     account.protocol.iconBaseURI + &quot;icon48.png&quot;;</span>
<a href="#l13.32"></a><span id="l13.32"> </span>
<a href="#l13.33"></a><span id="l13.33" class="difflineminus">-  var browser = document.getElementById(&quot;requestFrame&quot;);</span>
<a href="#l13.34"></a><span id="l13.34" class="difflineplus">+  let browser = document.getElementById(&quot;requestFrame&quot;);</span>
<a href="#l13.35"></a><span id="l13.35">   browser.addProgressListener(reporterListener,</span>
<a href="#l13.36"></a><span id="l13.36">                               Components.interfaces.nsIWebProgress.NOTIFY_ALL);</span>
<a href="#l13.37"></a><span id="l13.37" class="difflineminus">-  var url = request.url;</span>
<a href="#l13.38"></a><span id="l13.38" class="difflineminus">-  if (url != &quot;&quot;) {</span>
<a href="#l13.39"></a><span id="l13.39" class="difflineplus">+  let url = request.url;</span>
<a href="#l13.40"></a><span id="l13.40" class="difflineplus">+  if (url != &quot;&quot;)</span>
<a href="#l13.41"></a><span id="l13.41">     browser.setAttribute(&quot;src&quot;, url);</span>
<a href="#l13.42"></a><span id="l13.42" class="difflineminus">-  }</span>
<a href="#l13.43"></a><span id="l13.43">   request.loaded(window, browser.webProgress);</span>
<a href="#l13.44"></a><span id="l13.44"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/chat/content/convbrowser.xml</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/chat/content/convbrowser.xml</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -767,18 +767,18 @@</span>
<a href="#l14.4"></a><span id="l14.4">         &lt;/body&gt;</span>
<a href="#l14.5"></a><span id="l14.5">       &lt;/method&gt;</span>
<a href="#l14.6"></a><span id="l14.6"> </span>
<a href="#l14.7"></a><span id="l14.7">       &lt;method name=&quot;_accelerate&quot;&gt;</span>
<a href="#l14.8"></a><span id="l14.8">         &lt;parameter name=&quot;curr&quot;/&gt;</span>
<a href="#l14.9"></a><span id="l14.9">         &lt;parameter name=&quot;start&quot;/&gt;</span>
<a href="#l14.10"></a><span id="l14.10">         &lt;body&gt;</span>
<a href="#l14.11"></a><span id="l14.11">           &lt;![CDATA[</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-            const speed = 12;</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineminus">-            var val = (curr - start) / speed;</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineplus">+            const kSpeed = 12;</span>
<a href="#l14.15"></a><span id="l14.15" class="difflineplus">+            var val = (curr - start) / kSpeed;</span>
<a href="#l14.16"></a><span id="l14.16"> </span>
<a href="#l14.17"></a><span id="l14.17">             if (val &gt; 1)</span>
<a href="#l14.18"></a><span id="l14.18">               return val * Math.sqrt(val) - 1;</span>
<a href="#l14.19"></a><span id="l14.19">             if (val &lt; -1)</span>
<a href="#l14.20"></a><span id="l14.20">               return val * Math.sqrt(-val) + 1;</span>
<a href="#l14.21"></a><span id="l14.21">             return 0;</span>
<a href="#l14.22"></a><span id="l14.22">           ]]&gt;</span>
<a href="#l14.23"></a><span id="l14.23">         &lt;/body&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/chat/locales/en-US/twitter.properties</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/chat/locales/en-US/twitter.properties</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -57,19 +57,19 @@ connection.requestTimelines=Requesting u</span>
<a href="#l15.4"></a><span id="l15.4"> #   connection attempt.</span>
<a href="#l15.5"></a><span id="l15.5"> connection.error.userMismatch=Username mismatch.</span>
<a href="#l15.6"></a><span id="l15.6"> connection.error.failedToken=Failed to get request token.</span>
<a href="#l15.7"></a><span id="l15.7"> connection.error.authCancelled=You cancelled the authorization process.</span>
<a href="#l15.8"></a><span id="l15.8"> connection.error.authFailed=Failed to get authorization.</span>
<a href="#l15.9"></a><span id="l15.9"> connection.error.noNetwork=There is no network connection available.</span>
<a href="#l15.10"></a><span id="l15.10"> </span>
<a href="#l15.11"></a><span id="l15.11"> # LOCALIZATION NOTE</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-#   This is the prompt in the browser window that pops up to authorize</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineminus">-#   Instantbird to use a Twitter account. It is shown in the title bar of the</span>
<a href="#l15.14"></a><span id="l15.14" class="difflineminus">-#   authorization window.</span>
<a href="#l15.15"></a><span id="l15.15" class="difflineplus">+#   This is the prompt in the browser window that pops up to authorize us</span>
<a href="#l15.16"></a><span id="l15.16" class="difflineplus">+#   to use a Twitter account. It is shown in the title bar of the authorization</span>
<a href="#l15.17"></a><span id="l15.17" class="difflineplus">+#   window.</span>
<a href="#l15.18"></a><span id="l15.18"> authPrompt=Give permission to use your Twitter account</span>
<a href="#l15.19"></a><span id="l15.19"> </span>
<a href="#l15.20"></a><span id="l15.20"> # LOCALIZATION NOTE (options.*):</span>
<a href="#l15.21"></a><span id="l15.21"> #   These are the protocol specific options shown in the account manager and</span>
<a href="#l15.22"></a><span id="l15.22"> #   account wizard windows.</span>
<a href="#l15.23"></a><span id="l15.23"> options.track=Tracked keywords</span>
<a href="#l15.24"></a><span id="l15.24"> </span>
<a href="#l15.25"></a><span id="l15.25"> # LOCALIZATION NOTE (tooltip.*):</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/chat/modules/Makefile.in</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/chat/modules/Makefile.in</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -42,20 +42,20 @@ VPATH		= @srcdir@</span>
<a href="#l16.4"></a><span id="l16.4"> include $(DEPTH)/config/autoconf.mk</span>
<a href="#l16.5"></a><span id="l16.5"> </span>
<a href="#l16.6"></a><span id="l16.6"> EXTRA_JS_MODULES = \</span>
<a href="#l16.7"></a><span id="l16.7"> 	http.jsm \</span>
<a href="#l16.8"></a><span id="l16.8"> 	imContentSink.jsm \</span>
<a href="#l16.9"></a><span id="l16.9"> 	imServices.jsm \</span>
<a href="#l16.10"></a><span id="l16.10"> 	imSmileys.jsm \</span>
<a href="#l16.11"></a><span id="l16.11"> 	imStatusUtils.jsm \</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineplus">+	imThemes.jsm \</span>
<a href="#l16.13"></a><span id="l16.13"> 	imXPCOMUtils.jsm \</span>
<a href="#l16.14"></a><span id="l16.14"> 	jsProtoHelper.jsm \</span>
<a href="#l16.15"></a><span id="l16.15"> 	socket.jsm \</span>
<a href="#l16.16"></a><span id="l16.16"> 	$(NULL)</span>
<a href="#l16.17"></a><span id="l16.17"> </span>
<a href="#l16.18"></a><span id="l16.18"> EXTRA_PP_JS_MODULES = \</span>
<a href="#l16.19"></a><span id="l16.19"> 	hiddenWindow.jsm \</span>
<a href="#l16.20"></a><span id="l16.20"> 	imTextboxUtils.jsm \</span>
<a href="#l16.21"></a><span id="l16.21" class="difflineminus">-	imThemes.jsm \</span>
<a href="#l16.22"></a><span id="l16.22"> 	$(NULL)</span>
<a href="#l16.23"></a><span id="l16.23"> </span>
<a href="#l16.24"></a><span id="l16.24"> include $(topsrcdir)/config/rules.mk</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/chat/modules/http.jsm</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/chat/modules/http.jsm</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -32,29 +32,24 @@</span>
<a href="#l17.4"></a><span id="l17.4">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l17.5"></a><span id="l17.5">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l17.6"></a><span id="l17.6">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l17.7"></a><span id="l17.7">  *</span>
<a href="#l17.8"></a><span id="l17.8">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l17.9"></a><span id="l17.9"> </span>
<a href="#l17.10"></a><span id="l17.10"> var EXPORTED_SYMBOLS = [&quot;doXHRequest&quot;];</span>
<a href="#l17.11"></a><span id="l17.11"> </span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-/*</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineminus">- TODO</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineminus">-  replace doXHRequest with a more generic 'HTTP' object</span>
<a href="#l17.15"></a><span id="l17.15" class="difflineminus">-*/</span>
<a href="#l17.16"></a><span id="l17.16" class="difflineminus">-</span>
<a href="#l17.17"></a><span id="l17.17"> const {classes: Cc, interfaces: Ci, utils: Cu} = Components;</span>
<a href="#l17.18"></a><span id="l17.18"> </span>
<a href="#l17.19"></a><span id="l17.19"> Cu.import(&quot;resource:///modules/imXPCOMUtils.jsm&quot;);</span>
<a href="#l17.20"></a><span id="l17.20"> </span>
<a href="#l17.21"></a><span id="l17.21"> initLogModule(&quot;xhr&quot;, this);</span>
<a href="#l17.22"></a><span id="l17.22"> </span>
<a href="#l17.23"></a><span id="l17.23"> function doXHRequest(aUrl, aHeaders, aPOSTData, aOnLoad, aOnError, aThis) {</span>
<a href="#l17.24"></a><span id="l17.24" class="difflineminus">-  var xhr = Cc[&quot;@mozilla.org/xmlextras/xmlhttprequest;1&quot;]</span>
<a href="#l17.25"></a><span id="l17.25" class="difflineplus">+  let xhr = Cc[&quot;@mozilla.org/xmlextras/xmlhttprequest;1&quot;]</span>
<a href="#l17.26"></a><span id="l17.26">               .createInstance(Ci.nsIXMLHttpRequest);</span>
<a href="#l17.27"></a><span id="l17.27">   xhr.mozBackgroundRequest = true; // no error dialogs</span>
<a href="#l17.28"></a><span id="l17.28">   xhr.open(aPOSTData ? &quot;POST&quot; : &quot;GET&quot;, aUrl);</span>
<a href="#l17.29"></a><span id="l17.29">   xhr.channel.loadFlags = Ci.nsIChannel.LOAD_ANONYMOUS | // don't send cookies</span>
<a href="#l17.30"></a><span id="l17.30">                           Ci.nsIChannel.LOAD_BYPASS_CACHE |</span>
<a href="#l17.31"></a><span id="l17.31">                           Ci.nsIChannel.INHIBIT_CACHING;</span>
<a href="#l17.32"></a><span id="l17.32">   xhr.onerror = function(aProgressEvent) {</span>
<a href="#l17.33"></a><span id="l17.33">     if (aOnError) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/chat/modules/imContentSink.jsm</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/chat/modules/imContentSink.jsm</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -176,43 +176,43 @@ const kPermissiveMode = {</span>
<a href="#l18.4"></a><span id="l18.4">     'font-family': true,</span>
<a href="#l18.5"></a><span id="l18.5">     'font-size': true,</span>
<a href="#l18.6"></a><span id="l18.6">     'font-style': true,</span>
<a href="#l18.7"></a><span id="l18.7">     'font-weight': true,</span>
<a href="#l18.8"></a><span id="l18.8">     'text-decoration': true</span>
<a href="#l18.9"></a><span id="l18.9">   }</span>
<a href="#l18.10"></a><span id="l18.10"> };</span>
<a href="#l18.11"></a><span id="l18.11"> </span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-const modePref = &quot;messenger.options.filterMode&quot;;</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineplus">+const kModePref = &quot;messenger.options.filterMode&quot;;</span>
<a href="#l18.14"></a><span id="l18.14"> const kModes = [kStrictMode, kStandardMode, kPermissiveMode];</span>
<a href="#l18.15"></a><span id="l18.15"> </span>
<a href="#l18.16"></a><span id="l18.16"> var gGlobalRuleset = null;</span>
<a href="#l18.17"></a><span id="l18.17"> </span>
<a href="#l18.18"></a><span id="l18.18"> function initGlobalRuleset()</span>
<a href="#l18.19"></a><span id="l18.19"> {</span>
<a href="#l18.20"></a><span id="l18.20">   gGlobalRuleset = newRuleset();</span>
<a href="#l18.21"></a><span id="l18.21"> </span>
<a href="#l18.22"></a><span id="l18.22" class="difflineminus">-  Services.prefs.addObserver(modePref, styleObserver, false);</span>
<a href="#l18.23"></a><span id="l18.23" class="difflineplus">+  Services.prefs.addObserver(kModePref, styleObserver, false);</span>
<a href="#l18.24"></a><span id="l18.24"> }</span>
<a href="#l18.25"></a><span id="l18.25"> </span>
<a href="#l18.26"></a><span id="l18.26"> var styleObserver = {</span>
<a href="#l18.27"></a><span id="l18.27">   observe: function so_observe(aObject, aTopic, aMsg) {</span>
<a href="#l18.28"></a><span id="l18.28" class="difflineminus">-    if (aTopic != &quot;nsPref:changed&quot; || aMsg != modePref)</span>
<a href="#l18.29"></a><span id="l18.29" class="difflineplus">+    if (aTopic != &quot;nsPref:changed&quot; || aMsg != kModePref)</span>
<a href="#l18.30"></a><span id="l18.30">       throw &quot;bad notification&quot;;</span>
<a href="#l18.31"></a><span id="l18.31"> </span>
<a href="#l18.32"></a><span id="l18.32">     if (!gGlobalRuleset)</span>
<a href="#l18.33"></a><span id="l18.33">       throw &quot;gGlobalRuleset not initialized&quot;;</span>
<a href="#l18.34"></a><span id="l18.34"> </span>
<a href="#l18.35"></a><span id="l18.35">     setBaseRuleset(getModePref(), gGlobalRuleset);</span>
<a href="#l18.36"></a><span id="l18.36">   }</span>
<a href="#l18.37"></a><span id="l18.37"> };</span>
<a href="#l18.38"></a><span id="l18.38"> </span>
<a href="#l18.39"></a><span id="l18.39"> function getModePref()</span>
<a href="#l18.40"></a><span id="l18.40"> {</span>
<a href="#l18.41"></a><span id="l18.41" class="difflineminus">-  let baseNum = Services.prefs.getIntPref(modePref);</span>
<a href="#l18.42"></a><span id="l18.42" class="difflineplus">+  let baseNum = Services.prefs.getIntPref(kModePref);</span>
<a href="#l18.43"></a><span id="l18.43">   if (baseNum &lt; 0 || baseNum &gt; 2)</span>
<a href="#l18.44"></a><span id="l18.44">     baseNum = 1;</span>
<a href="#l18.45"></a><span id="l18.45"> </span>
<a href="#l18.46"></a><span id="l18.46">   return kModes[baseNum];</span>
<a href="#l18.47"></a><span id="l18.47"> }</span>
<a href="#l18.48"></a><span id="l18.48"> </span>
<a href="#l18.49"></a><span id="l18.49"> function setBaseRuleset(aBase, aResult)</span>
<a href="#l18.50"></a><span id="l18.50"> {</span>
<a href="#l18.51"></a><span id="l18.51" class="difflineat">@@ -221,17 +221,17 @@ function setBaseRuleset(aBase, aResult)</span>
<a href="#l18.52"></a><span id="l18.52">   aResult.styles.__proto__ = aBase.styles;</span>
<a href="#l18.53"></a><span id="l18.53"> }</span>
<a href="#l18.54"></a><span id="l18.54"> </span>
<a href="#l18.55"></a><span id="l18.55"> function newRuleset(aBase)</span>
<a href="#l18.56"></a><span id="l18.56"> {</span>
<a href="#l18.57"></a><span id="l18.57">   if (!aBase)</span>
<a href="#l18.58"></a><span id="l18.58">     aBase = getModePref();</span>
<a href="#l18.59"></a><span id="l18.59"> </span>
<a href="#l18.60"></a><span id="l18.60" class="difflineminus">-  var result = {};</span>
<a href="#l18.61"></a><span id="l18.61" class="difflineplus">+  let result = {};</span>
<a href="#l18.62"></a><span id="l18.62">   result.tags = {};</span>
<a href="#l18.63"></a><span id="l18.63">   result.attrs = {};</span>
<a href="#l18.64"></a><span id="l18.64">   result.styles = {};</span>
<a href="#l18.65"></a><span id="l18.65">   setBaseRuleset(aBase, result);</span>
<a href="#l18.66"></a><span id="l18.66">   return result;</span>
<a href="#l18.67"></a><span id="l18.67"> }</span>
<a href="#l18.68"></a><span id="l18.68"> </span>
<a href="#l18.69"></a><span id="l18.69"> function createDerivedRuleset()</span>
<a href="#l18.70"></a><span id="l18.70" class="difflineat">@@ -265,17 +265,17 @@ function addGlobalAllowedStyleRule(aStyl</span>
<a href="#l18.71"></a><span id="l18.71"> }</span>
<a href="#l18.72"></a><span id="l18.72"> function removeGlobalAllowedStyleRule(aStyle)</span>
<a href="#l18.73"></a><span id="l18.73"> {</span>
<a href="#l18.74"></a><span id="l18.74">   delete gGlobalRuleset.styles[aStyle];</span>
<a href="#l18.75"></a><span id="l18.75"> }</span>
<a href="#l18.76"></a><span id="l18.76"> </span>
<a href="#l18.77"></a><span id="l18.77"> function cleanupNode(aNode, aRules, aTextModifiers)</span>
<a href="#l18.78"></a><span id="l18.78"> {</span>
<a href="#l18.79"></a><span id="l18.79" class="difflineminus">-  for (var i = 0; i &lt; aNode.childNodes.length; ++i) {</span>
<a href="#l18.80"></a><span id="l18.80" class="difflineplus">+  for (let i = 0; i &lt; aNode.childNodes.length; ++i) {</span>
<a href="#l18.81"></a><span id="l18.81">     let node = aNode.childNodes[i];</span>
<a href="#l18.82"></a><span id="l18.82">     if (node instanceof Components.interfaces.nsIDOMHTMLElement) {</span>
<a href="#l18.83"></a><span id="l18.83">       // check if node allowed</span>
<a href="#l18.84"></a><span id="l18.84">       let nodeName = node.localName.toLowerCase();</span>
<a href="#l18.85"></a><span id="l18.85">       if (!(nodeName in aRules.tags)) {</span>
<a href="#l18.86"></a><span id="l18.86">         // this node is not allowed, replace it with its children</span>
<a href="#l18.87"></a><span id="l18.87">         while (node.hasChildNodes())</span>
<a href="#l18.88"></a><span id="l18.88">           aNode.insertBefore(node.removeChild(node.firstChild), node);</span>
<a href="#l18.89"></a><span id="l18.89" class="difflineat">@@ -285,41 +285,41 @@ function cleanupNode(aNode, aRules, aTex</span>
<a href="#l18.90"></a><span id="l18.90">         --i;</span>
<a href="#l18.91"></a><span id="l18.91">         continue;</span>
<a href="#l18.92"></a><span id="l18.92">       }</span>
<a href="#l18.93"></a><span id="l18.93"> </span>
<a href="#l18.94"></a><span id="l18.94">       // we are going to keep this child node, clean up its children</span>
<a href="#l18.95"></a><span id="l18.95">       cleanupNode(node, aRules, aTextModifiers);</span>
<a href="#l18.96"></a><span id="l18.96"> </span>
<a href="#l18.97"></a><span id="l18.97">       // cleanup attributes</span>
<a href="#l18.98"></a><span id="l18.98" class="difflineminus">-      var attrs = node.attributes;</span>
<a href="#l18.99"></a><span id="l18.99" class="difflineplus">+      let attrs = node.attributes;</span>
<a href="#l18.100"></a><span id="l18.100">       let acceptFunction = function(aAttrRules, aAttr) {</span>
<a href="#l18.101"></a><span id="l18.101">         // an attribute is always accepted if its rule is true, or conditionnaly</span>
<a href="#l18.102"></a><span id="l18.102">         // accepted if its rule is a function that evaluates to true</span>
<a href="#l18.103"></a><span id="l18.103">         // if its rule does not exist, it is refused</span>
<a href="#l18.104"></a><span id="l18.104">           let localName = aAttr.localName;</span>
<a href="#l18.105"></a><span id="l18.105">           let rule = localName in aAttrRules &amp;&amp; aAttrRules[localName];</span>
<a href="#l18.106"></a><span id="l18.106">           return (rule === true ||</span>
<a href="#l18.107"></a><span id="l18.107">                   (rule instanceof Function &amp;&amp; rule(aAttr.value)));</span>
<a href="#l18.108"></a><span id="l18.108">       };</span>
<a href="#l18.109"></a><span id="l18.109" class="difflineminus">-      for (var j = 0; j &lt; attrs.length; ++j) {</span>
<a href="#l18.110"></a><span id="l18.110" class="difflineplus">+      for (let j = 0; j &lt; attrs.length; ++j) {</span>
<a href="#l18.111"></a><span id="l18.111">         let attr = attrs[j];</span>
<a href="#l18.112"></a><span id="l18.112">         // we check both the list of accepted attributes for all tags</span>
<a href="#l18.113"></a><span id="l18.113">         // and the list of accepted attributes for this specific tag.</span>
<a href="#l18.114"></a><span id="l18.114">         if (!(acceptFunction(aRules.attrs, attr) ||</span>
<a href="#l18.115"></a><span id="l18.115">               (aRules.tags[nodeName] instanceof Object) &amp;&amp;</span>
<a href="#l18.116"></a><span id="l18.116">               acceptFunction(aRules.tags[nodeName], attr))) {</span>
<a href="#l18.117"></a><span id="l18.117">           node.removeAttribute(attr.name);</span>
<a href="#l18.118"></a><span id="l18.118">           --j;</span>
<a href="#l18.119"></a><span id="l18.119">         }</span>
<a href="#l18.120"></a><span id="l18.120">       }</span>
<a href="#l18.121"></a><span id="l18.121"> </span>
<a href="#l18.122"></a><span id="l18.122">       // cleanup style</span>
<a href="#l18.123"></a><span id="l18.123" class="difflineminus">-      var style = node.style;</span>
<a href="#l18.124"></a><span id="l18.124" class="difflineminus">-      for (var j = 0; j &lt; style.length; ++j) {</span>
<a href="#l18.125"></a><span id="l18.125" class="difflineplus">+      let style = node.style;</span>
<a href="#l18.126"></a><span id="l18.126" class="difflineplus">+      for (let j = 0; j &lt; style.length; ++j) {</span>
<a href="#l18.127"></a><span id="l18.127">         if (!(style[j] in aRules.styles)) {</span>
<a href="#l18.128"></a><span id="l18.128">           style.removeProperty(style[j]);</span>
<a href="#l18.129"></a><span id="l18.129">           --j;</span>
<a href="#l18.130"></a><span id="l18.130">         }</span>
<a href="#l18.131"></a><span id="l18.131">       }</span>
<a href="#l18.132"></a><span id="l18.132">     }</span>
<a href="#l18.133"></a><span id="l18.133">     else {</span>
<a href="#l18.134"></a><span id="l18.134">       // We are on a text node, we need to apply the functions</span>
<a href="#l18.135"></a><span id="l18.135" class="difflineat">@@ -331,19 +331,19 @@ function cleanupNode(aNode, aRules, aTex</span>
<a href="#l18.136"></a><span id="l18.136">       //  * positive value if nodes were added.</span>
<a href="#l18.137"></a><span id="l18.137">       //     For instance, adding an &lt;img&gt; tag for a smiley adds 2 nodes:</span>
<a href="#l18.138"></a><span id="l18.138">       //      - the img tag</span>
<a href="#l18.139"></a><span id="l18.139">       //      - the new text node after the img tag.</span>
<a href="#l18.140"></a><span id="l18.140"> </span>
<a href="#l18.141"></a><span id="l18.141">       // This is the number of nodes we need to process. If new nodes</span>
<a href="#l18.142"></a><span id="l18.142">       // are created, the next text modifier functions have more nodes</span>
<a href="#l18.143"></a><span id="l18.143">       // to process.</span>
<a href="#l18.144"></a><span id="l18.144" class="difflineminus">-      var textNodeCount = 1;</span>
<a href="#l18.145"></a><span id="l18.145" class="difflineminus">-      for each (var modifier in aTextModifiers)</span>
<a href="#l18.146"></a><span id="l18.146" class="difflineminus">-        for (var n = 0; n &lt; textNodeCount; ++n) {</span>
<a href="#l18.147"></a><span id="l18.147" class="difflineplus">+      let textNodeCount = 1;</span>
<a href="#l18.148"></a><span id="l18.148" class="difflineplus">+      for each (let modifier in aTextModifiers)</span>
<a href="#l18.149"></a><span id="l18.149" class="difflineplus">+        for (let n = 0; n &lt; textNodeCount; ++n) {</span>
<a href="#l18.150"></a><span id="l18.150">           let textNode = aNode.childNodes[i + n];</span>
<a href="#l18.151"></a><span id="l18.151"> </span>
<a href="#l18.152"></a><span id="l18.152">           // If we are processing nodes created by one of the previous</span>
<a href="#l18.153"></a><span id="l18.153">           // text modifier function, some of the nodes are likely not</span>
<a href="#l18.154"></a><span id="l18.154">           // text node, skip them.</span>
<a href="#l18.155"></a><span id="l18.155">           if (!(textNode instanceof Components.interfaces.nsIDOMText))</span>
<a href="#l18.156"></a><span id="l18.156">             continue;</span>
<a href="#l18.157"></a><span id="l18.157"> </span>
<a href="#l18.158"></a><span id="l18.158" class="difflineat">@@ -361,13 +361,13 @@ function cleanupNode(aNode, aRules, aTex</span>
<a href="#l18.159"></a><span id="l18.159"> function cleanupImMarkup(aDocument, aText, aRuleset, aTextModifiers)</span>
<a href="#l18.160"></a><span id="l18.160"> {</span>
<a href="#l18.161"></a><span id="l18.161">   if (!aDocument)</span>
<a href="#l18.162"></a><span id="l18.162">     throw &quot;providing an HTML document is required&quot;;</span>
<a href="#l18.163"></a><span id="l18.163"> </span>
<a href="#l18.164"></a><span id="l18.164">   if (!gGlobalRuleset)</span>
<a href="#l18.165"></a><span id="l18.165">     initGlobalRuleset();</span>
<a href="#l18.166"></a><span id="l18.166"> </span>
<a href="#l18.167"></a><span id="l18.167" class="difflineminus">-  var div = aDocument.createElement(&quot;div&quot;);</span>
<a href="#l18.168"></a><span id="l18.168" class="difflineplus">+  let div = aDocument.createElement(&quot;div&quot;);</span>
<a href="#l18.169"></a><span id="l18.169">   div.innerHTML = aText;</span>
<a href="#l18.170"></a><span id="l18.170">   cleanupNode(div, aRuleset || gGlobalRuleset, aTextModifiers || []);</span>
<a href="#l18.171"></a><span id="l18.171">   return div.innerHTML;</span>
<a href="#l18.172"></a><span id="l18.172"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/chat/modules/imSmileys.jsm</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/chat/modules/imSmileys.jsm</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -40,32 +40,32 @@ Components.utils.import(&quot;resource:///mod</span>
<a href="#l19.4"></a><span id="l19.4"> var EXPORTED_SYMBOLS = [</span>
<a href="#l19.5"></a><span id="l19.5">   &quot;smileImMarkup&quot;, // used to add smile:// img tags into IM markup.</span>
<a href="#l19.6"></a><span id="l19.6">   &quot;smileTextNode&quot;, // used to add smile:// img tags to the content of a textnode</span>
<a href="#l19.7"></a><span id="l19.7">   &quot;smileString&quot;, // used to add smile:// img tags into a string without parsing it as HTML. Be sure the string doesn't contain HTML tags.</span>
<a href="#l19.8"></a><span id="l19.8">   &quot;getSmileRealURI&quot;, // used to retrive the chrome URI for a smile:// URI</span>
<a href="#l19.9"></a><span id="l19.9">   &quot;getSmileyList&quot; // used to display a list of smileys in the UI</span>
<a href="#l19.10"></a><span id="l19.10"> ];</span>
<a href="#l19.11"></a><span id="l19.11"> </span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-const emoticonsThemePref = &quot;messenger.options.emoticonsTheme&quot;;</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineminus">-const themeFile = &quot;theme.js&quot;;</span>
<a href="#l19.14"></a><span id="l19.14" class="difflineplus">+const kEmoticonsThemePref = &quot;messenger.options.emoticonsTheme&quot;;</span>
<a href="#l19.15"></a><span id="l19.15" class="difflineplus">+const kThemeFile = &quot;theme.js&quot;;</span>
<a href="#l19.16"></a><span id="l19.16"> </span>
<a href="#l19.17"></a><span id="l19.17"> __defineGetter__(&quot;gTheme&quot;, function() {</span>
<a href="#l19.18"></a><span id="l19.18">   delete this.gTheme;</span>
<a href="#l19.19"></a><span id="l19.19">   gPrefObserver.init();</span>
<a href="#l19.20"></a><span id="l19.20">   return this.gTheme = getTheme();</span>
<a href="#l19.21"></a><span id="l19.21"> });</span>
<a href="#l19.22"></a><span id="l19.22"> </span>
<a href="#l19.23"></a><span id="l19.23"> var gPrefObserver = {</span>
<a href="#l19.24"></a><span id="l19.24">   init: function po_init() {</span>
<a href="#l19.25"></a><span id="l19.25" class="difflineminus">-    Services.prefs.addObserver(emoticonsThemePref, gPrefObserver, false);</span>
<a href="#l19.26"></a><span id="l19.26" class="difflineplus">+    Services.prefs.addObserver(kEmoticonsThemePref, gPrefObserver, false);</span>
<a href="#l19.27"></a><span id="l19.27">   },</span>
<a href="#l19.28"></a><span id="l19.28"> </span>
<a href="#l19.29"></a><span id="l19.29">   observe: function so_observe(aObject, aTopic, aMsg) {</span>
<a href="#l19.30"></a><span id="l19.30" class="difflineminus">-    if (aTopic != &quot;nsPref:changed&quot; || aMsg != emoticonsThemePref)</span>
<a href="#l19.31"></a><span id="l19.31" class="difflineplus">+    if (aTopic != &quot;nsPref:changed&quot; || aMsg != kEmoticonsThemePref)</span>
<a href="#l19.32"></a><span id="l19.32">       throw &quot;bad notification&quot;;</span>
<a href="#l19.33"></a><span id="l19.33"> </span>
<a href="#l19.34"></a><span id="l19.34">     gTheme = getTheme();</span>
<a href="#l19.35"></a><span id="l19.35">   }</span>
<a href="#l19.36"></a><span id="l19.36"> };</span>
<a href="#l19.37"></a><span id="l19.37"> </span>
<a href="#l19.38"></a><span id="l19.38"> function getSmileRealURI(aSmile)</span>
<a href="#l19.39"></a><span id="l19.39"> {</span>
<a href="#l19.40"></a><span id="l19.40" class="difflineat">@@ -89,34 +89,34 @@ function getSmileyList(aThemeName)</span>
<a href="#l19.41"></a><span id="l19.41">             src: theme.baseUri + aSmiley.filename,</span>
<a href="#l19.42"></a><span id="l19.42">             textCodes: aSmiley.textCodes};</span>
<a href="#l19.43"></a><span id="l19.43">   };</span>
<a href="#l19.44"></a><span id="l19.44">   return theme.json.smileys.map(addAbsoluteUrls);</span>
<a href="#l19.45"></a><span id="l19.45"> }</span>
<a href="#l19.46"></a><span id="l19.46"> </span>
<a href="#l19.47"></a><span id="l19.47"> function getTheme(aName)</span>
<a href="#l19.48"></a><span id="l19.48"> {</span>
<a href="#l19.49"></a><span id="l19.49" class="difflineminus">-  let name = aName || Services.prefs.getCharPref(emoticonsThemePref);</span>
<a href="#l19.50"></a><span id="l19.50" class="difflineplus">+  let name = aName || Services.prefs.getCharPref(kEmoticonsThemePref);</span>
<a href="#l19.51"></a><span id="l19.51"> </span>
<a href="#l19.52"></a><span id="l19.52">   let theme = {</span>
<a href="#l19.53"></a><span id="l19.53">     name: name,</span>
<a href="#l19.54"></a><span id="l19.54">     iconsHash: null,</span>
<a href="#l19.55"></a><span id="l19.55">     json: null,</span>
<a href="#l19.56"></a><span id="l19.56">     regExp: null</span>
<a href="#l19.57"></a><span id="l19.57">   };</span>
<a href="#l19.58"></a><span id="l19.58"> </span>
<a href="#l19.59"></a><span id="l19.59">   if (name == &quot;none&quot;)</span>
<a href="#l19.60"></a><span id="l19.60">     return theme;</span>
<a href="#l19.61"></a><span id="l19.61"> </span>
<a href="#l19.62"></a><span id="l19.62">   if (name == &quot;default&quot;)</span>
<a href="#l19.63"></a><span id="l19.63">     theme.baseUri = &quot;chrome://instantbird-emoticons/skin/&quot;;</span>
<a href="#l19.64"></a><span id="l19.64">   else</span>
<a href="#l19.65"></a><span id="l19.65">     theme.baseUri = &quot;chrome://&quot; + theme.name + &quot;/skin/&quot;;</span>
<a href="#l19.66"></a><span id="l19.66">   try {</span>
<a href="#l19.67"></a><span id="l19.67" class="difflineminus">-    let channel = Services.io.newChannel(theme.baseUri + themeFile, null, null);</span>
<a href="#l19.68"></a><span id="l19.68" class="difflineplus">+    let channel = Services.io.newChannel(theme.baseUri + kThemeFile, null, null);</span>
<a href="#l19.69"></a><span id="l19.69">     let stream = channel.open();</span>
<a href="#l19.70"></a><span id="l19.70">     let json = Components.classes[&quot;@mozilla.org/dom/json;1&quot;]</span>
<a href="#l19.71"></a><span id="l19.71">                          .createInstance(Components.interfaces.nsIJSON);</span>
<a href="#l19.72"></a><span id="l19.72">     theme.json = json.decodeFromStream(stream, stream.available());</span>
<a href="#l19.73"></a><span id="l19.73">     stream.close();</span>
<a href="#l19.74"></a><span id="l19.74">     theme.iconsHash = {};</span>
<a href="#l19.75"></a><span id="l19.75">     for each (let smiley in theme.json.smileys) {</span>
<a href="#l19.76"></a><span id="l19.76">       for each (let textCode in smiley.textCodes)</span>
<a href="#l19.77"></a><span id="l19.77" class="difflineat">@@ -164,20 +164,20 @@ function getRegexp()</span>
<a href="#l19.78"></a><span id="l19.78"> </span>
<a href="#l19.79"></a><span id="l19.79">   gTheme.regExp = new RegExp('(' + emoticonList.join('|') + ')', 'g');</span>
<a href="#l19.80"></a><span id="l19.80">   return gTheme.regExp;</span>
<a href="#l19.81"></a><span id="l19.81"> }</span>
<a href="#l19.82"></a><span id="l19.82"> </span>
<a href="#l19.83"></a><span id="l19.83"> // unused. May be useful later to process a string instead of an HTML node</span>
<a href="#l19.84"></a><span id="l19.84"> function smileString(aString)</span>
<a href="#l19.85"></a><span id="l19.85"> {</span>
<a href="#l19.86"></a><span id="l19.86" class="difflineminus">-  const smileFormat = '&lt;img class=&quot;ib-img-smile&quot; src=&quot;smile://$1&quot; alt=&quot;$1&quot; title=&quot;$1&quot;/&gt;';</span>
<a href="#l19.87"></a><span id="l19.87" class="difflineplus">+  const kSmileFormat = '&lt;img class=&quot;ib-img-smile&quot; src=&quot;smile://$1&quot; alt=&quot;$1&quot; title=&quot;$1&quot;/&gt;';</span>
<a href="#l19.88"></a><span id="l19.88"> </span>
<a href="#l19.89"></a><span id="l19.89">   let exp = getRegexp();</span>
<a href="#l19.90"></a><span id="l19.90" class="difflineminus">-  return exp ? aString.replace(exp, smileFormat) : aString;</span>
<a href="#l19.91"></a><span id="l19.91" class="difflineplus">+  return exp ? aString.replace(exp, kSmileFormat) : aString;</span>
<a href="#l19.92"></a><span id="l19.92"> }</span>
<a href="#l19.93"></a><span id="l19.93"> </span>
<a href="#l19.94"></a><span id="l19.94"> function smileTextNode(aNode)</span>
<a href="#l19.95"></a><span id="l19.95"> {</span>
<a href="#l19.96"></a><span id="l19.96">   /*</span>
<a href="#l19.97"></a><span id="l19.97">    * Skip text nodes that contain the href in the child text node.</span>
<a href="#l19.98"></a><span id="l19.98">    * We must check both the testNode.textContent and the aNode.data since they</span>
<a href="#l19.99"></a><span id="l19.99">    * cover different cases:</span>
<a href="#l19.100"></a><span id="l19.100" class="difflineat">@@ -216,17 +216,17 @@ function smileTextNode(aNode)</span>
<a href="#l19.101"></a><span id="l19.101">     result += 2;</span>
<a href="#l19.102"></a><span id="l19.102">     exp.lastIndex = 0;</span>
<a href="#l19.103"></a><span id="l19.103">   }</span>
<a href="#l19.104"></a><span id="l19.104">   return result;</span>
<a href="#l19.105"></a><span id="l19.105"> }</span>
<a href="#l19.106"></a><span id="l19.106"> </span>
<a href="#l19.107"></a><span id="l19.107"> function smileNode(aNode)</span>
<a href="#l19.108"></a><span id="l19.108"> {</span>
<a href="#l19.109"></a><span id="l19.109" class="difflineminus">-  for (var i = 0; i &lt; aNode.childNodes.length; ++i) {</span>
<a href="#l19.110"></a><span id="l19.110" class="difflineplus">+  for (let i = 0; i &lt; aNode.childNodes.length; ++i) {</span>
<a href="#l19.111"></a><span id="l19.111">     let node = aNode.childNodes[i];</span>
<a href="#l19.112"></a><span id="l19.112">     if (node instanceof Components.interfaces.nsIDOMHTMLElement) {</span>
<a href="#l19.113"></a><span id="l19.113">       // we are on a tag, recurse to process its children</span>
<a href="#l19.114"></a><span id="l19.114">       smileNode(node);</span>
<a href="#l19.115"></a><span id="l19.115">     } else if (node instanceof Components.interfaces.nsIDOMText) {</span>
<a href="#l19.116"></a><span id="l19.116">       // we are on a text node, process it</span>
<a href="#l19.117"></a><span id="l19.117">       smileTextNode(node);</span>
<a href="#l19.118"></a><span id="l19.118">     }</span>
<a href="#l19.119"></a><span id="l19.119" class="difflineat">@@ -237,13 +237,13 @@ function smileImMarkup(aDocument, aText)</span>
<a href="#l19.120"></a><span id="l19.120"> {</span>
<a href="#l19.121"></a><span id="l19.121">   if (!aDocument)</span>
<a href="#l19.122"></a><span id="l19.122">     throw &quot;providing an HTML document is required&quot;;</span>
<a href="#l19.123"></a><span id="l19.123"> </span>
<a href="#l19.124"></a><span id="l19.124">   // return early if smileys are disabled</span>
<a href="#l19.125"></a><span id="l19.125">   if (!gTheme.iconsHash)</span>
<a href="#l19.126"></a><span id="l19.126">     return aText;</span>
<a href="#l19.127"></a><span id="l19.127"> </span>
<a href="#l19.128"></a><span id="l19.128" class="difflineminus">-  var div = aDocument.createElement(&quot;div&quot;);</span>
<a href="#l19.129"></a><span id="l19.129" class="difflineplus">+  let div = aDocument.createElement(&quot;div&quot;);</span>
<a href="#l19.130"></a><span id="l19.130">   div.innerHTML = aText;</span>
<a href="#l19.131"></a><span id="l19.131">   smileNode(div);</span>
<a href="#l19.132"></a><span id="l19.132">   return div.innerHTML;</span>
<a href="#l19.133"></a><span id="l19.133"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/chat/modules/imThemes.jsm</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/chat/modules/imThemes.jsm</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -30,52 +30,48 @@</span>
<a href="#l20.4"></a><span id="l20.4">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l20.5"></a><span id="l20.5">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l20.6"></a><span id="l20.6">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l20.7"></a><span id="l20.7">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l20.8"></a><span id="l20.8">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l20.9"></a><span id="l20.9">  *</span>
<a href="#l20.10"></a><span id="l20.10">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l20.11"></a><span id="l20.11"> </span>
<a href="#l20.12"></a><span id="l20.12" class="difflineminus">-#filter substitution</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineminus">-#ifdef XP_WIN</span>
<a href="#l20.14"></a><span id="l20.14" class="difflineminus">-#define LINE_BREAK \r\n</span>
<a href="#l20.15"></a><span id="l20.15" class="difflineminus">-#else</span>
<a href="#l20.16"></a><span id="l20.16" class="difflineminus">-#define LINE_BREAK \n</span>
<a href="#l20.17"></a><span id="l20.17" class="difflineminus">-#endif</span>
<a href="#l20.18"></a><span id="l20.18" class="difflineminus">-</span>
<a href="#l20.19"></a><span id="l20.19"> var EXPORTED_SYMBOLS = [</span>
<a href="#l20.20"></a><span id="l20.20">   &quot;getCurrentTheme&quot;,</span>
<a href="#l20.21"></a><span id="l20.21">   &quot;getThemeByName&quot;,</span>
<a href="#l20.22"></a><span id="l20.22">   &quot;getHTMLForMessage&quot;,</span>
<a href="#l20.23"></a><span id="l20.23">   &quot;getThemeVariants&quot;,</span>
<a href="#l20.24"></a><span id="l20.24">   &quot;isNextMessage&quot;,</span>
<a href="#l20.25"></a><span id="l20.25">   &quot;insertHTMLForMessage&quot;,</span>
<a href="#l20.26"></a><span id="l20.26">   &quot;initHTMLDocument&quot;,</span>
<a href="#l20.27"></a><span id="l20.27">   &quot;getMessagesForRange&quot;,</span>
<a href="#l20.28"></a><span id="l20.28">   &quot;serializeSelection&quot;</span>
<a href="#l20.29"></a><span id="l20.29"> ];</span>
<a href="#l20.30"></a><span id="l20.30"> </span>
<a href="#l20.31"></a><span id="l20.31" class="difflineminus">-Components.utils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l20.32"></a><span id="l20.32" class="difflineminus">-Components.utils.import(&quot;resource://gre/modules/DownloadUtils.jsm&quot;);</span>
<a href="#l20.33"></a><span id="l20.33" class="difflineminus">-const Ci = Components.interfaces;</span>
<a href="#l20.34"></a><span id="l20.34" class="difflineplus">+const {classes: Cc, interfaces: Ci, utils: Cu} = Components;</span>
<a href="#l20.35"></a><span id="l20.35" class="difflineplus">+</span>
<a href="#l20.36"></a><span id="l20.36" class="difflineplus">+Cu.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l20.37"></a><span id="l20.37" class="difflineplus">+Cu.import(&quot;resource://gre/modules/DownloadUtils.jsm&quot;);</span>
<a href="#l20.38"></a><span id="l20.38"> </span>
<a href="#l20.39"></a><span id="l20.39" class="difflineminus">-const messagesStylePrefBranch = &quot;messenger.options.messagesStyle.&quot;;</span>
<a href="#l20.40"></a><span id="l20.40" class="difflineminus">-const themePref = &quot;theme&quot;;</span>
<a href="#l20.41"></a><span id="l20.41" class="difflineminus">-const variantPref = &quot;variant&quot;;</span>
<a href="#l20.42"></a><span id="l20.42" class="difflineminus">-const showHeaderPref = &quot;showHeader&quot;;</span>
<a href="#l20.43"></a><span id="l20.43" class="difflineminus">-const combineConsecutivePref = &quot;combineConsecutive&quot;;</span>
<a href="#l20.44"></a><span id="l20.44" class="difflineminus">-const combineConsecutiveIntervalPref = &quot;combineConsecutiveInterval&quot;;</span>
<a href="#l20.45"></a><span id="l20.45" class="difflineplus">+const kMessagesStylePrefBranch = &quot;messenger.options.messagesStyle.&quot;;</span>
<a href="#l20.46"></a><span id="l20.46" class="difflineplus">+const kThemePref = &quot;theme&quot;;</span>
<a href="#l20.47"></a><span id="l20.47" class="difflineplus">+const kVariantPref = &quot;variant&quot;;</span>
<a href="#l20.48"></a><span id="l20.48" class="difflineplus">+const kShowHeaderPref = &quot;showHeader&quot;;</span>
<a href="#l20.49"></a><span id="l20.49" class="difflineplus">+const kCombineConsecutivePref = &quot;combineConsecutive&quot;;</span>
<a href="#l20.50"></a><span id="l20.50" class="difflineplus">+const kCombineConsecutiveIntervalPref = &quot;combineConsecutiveInterval&quot;;</span>
<a href="#l20.51"></a><span id="l20.51"> </span>
<a href="#l20.52"></a><span id="l20.52"> const DEFAULT_THEME = &quot;bubbles&quot;;</span>
<a href="#l20.53"></a><span id="l20.53"> const DEFAULT_THEMES = [&quot;bubbles&quot;, &quot;dark&quot;, &quot;papersheets&quot;, &quot;simple&quot;];</span>
<a href="#l20.54"></a><span id="l20.54"> </span>
<a href="#l20.55"></a><span id="l20.55" class="difflineplus">+const kLineBreak = &quot;@mozilla.org/windows-registry-key;1&quot; in Cc ? &quot;\r\n&quot; : &quot;\n&quot;;</span>
<a href="#l20.56"></a><span id="l20.56" class="difflineplus">+</span>
<a href="#l20.57"></a><span id="l20.57"> __defineGetter__(&quot;gPrefBranch&quot;, function() {</span>
<a href="#l20.58"></a><span id="l20.58">   delete this.gPrefBranch;</span>
<a href="#l20.59"></a><span id="l20.59" class="difflineminus">-  return this.gPrefBranch = Services.prefs.getBranch(messagesStylePrefBranch);</span>
<a href="#l20.60"></a><span id="l20.60" class="difflineplus">+  return this.gPrefBranch = Services.prefs.getBranch(kMessagesStylePrefBranch);</span>
<a href="#l20.61"></a><span id="l20.61"> });</span>
<a href="#l20.62"></a><span id="l20.62"> </span>
<a href="#l20.63"></a><span id="l20.63"> var gCurrentTheme = null;</span>
<a href="#l20.64"></a><span id="l20.64"> </span>
<a href="#l20.65"></a><span id="l20.65"> function getChromeFile(aURI)</span>
<a href="#l20.66"></a><span id="l20.66"> {</span>
<a href="#l20.67"></a><span id="l20.67">   try {</span>
<a href="#l20.68"></a><span id="l20.68">     let channel = Services.io.newChannel(aURI, null, null);</span>
<a href="#l20.69"></a><span id="l20.69" class="difflineat">@@ -221,26 +217,26 @@ function getThemeByName(aName)</span>
<a href="#l20.70"></a><span id="l20.70">     throw &quot;Cannot load theme &quot; + aName;</span>
<a href="#l20.71"></a><span id="l20.71"> </span>
<a href="#l20.72"></a><span id="l20.72">   return {</span>
<a href="#l20.73"></a><span id="l20.73">     name: aName,</span>
<a href="#l20.74"></a><span id="l20.74">     variant: &quot;default&quot;,</span>
<a href="#l20.75"></a><span id="l20.75">     baseURI: baseURI,</span>
<a href="#l20.76"></a><span id="l20.76">     metadata: metadata,</span>
<a href="#l20.77"></a><span id="l20.77">     html: new HTMLTheme(baseURI),</span>
<a href="#l20.78"></a><span id="l20.78" class="difflineminus">-    showHeader: gPrefBranch.getBoolPref(showHeaderPref),</span>
<a href="#l20.79"></a><span id="l20.79" class="difflineminus">-    combineConsecutive: gPrefBranch.getBoolPref(combineConsecutivePref),</span>
<a href="#l20.80"></a><span id="l20.80" class="difflineminus">-    combineConsecutiveInterval: gPrefBranch.getIntPref(combineConsecutiveIntervalPref)</span>
<a href="#l20.81"></a><span id="l20.81" class="difflineplus">+    showHeader: gPrefBranch.getBoolPref(kShowHeaderPref),</span>
<a href="#l20.82"></a><span id="l20.82" class="difflineplus">+    combineConsecutive: gPrefBranch.getBoolPref(kCombineConsecutivePref),</span>
<a href="#l20.83"></a><span id="l20.83" class="difflineplus">+    combineConsecutiveInterval: gPrefBranch.getIntPref(kCombineConsecutiveIntervalPref)</span>
<a href="#l20.84"></a><span id="l20.84">   };</span>
<a href="#l20.85"></a><span id="l20.85"> }</span>
<a href="#l20.86"></a><span id="l20.86"> </span>
<a href="#l20.87"></a><span id="l20.87"> function getCurrentTheme()</span>
<a href="#l20.88"></a><span id="l20.88"> {</span>
<a href="#l20.89"></a><span id="l20.89" class="difflineminus">-  let name = gPrefBranch.getCharPref(themePref);</span>
<a href="#l20.90"></a><span id="l20.90" class="difflineminus">-  let variant = gPrefBranch.getCharPref(variantPref);</span>
<a href="#l20.91"></a><span id="l20.91" class="difflineplus">+  let name = gPrefBranch.getCharPref(kThemePref);</span>
<a href="#l20.92"></a><span id="l20.92" class="difflineplus">+  let variant = gPrefBranch.getCharPref(kVariantPref);</span>
<a href="#l20.93"></a><span id="l20.93">   if (gCurrentTheme &amp;&amp; gCurrentTheme.name == name &amp;&amp;</span>
<a href="#l20.94"></a><span id="l20.94">       gCurrentTheme.variant == variant)</span>
<a href="#l20.95"></a><span id="l20.95">     return gCurrentTheme;</span>
<a href="#l20.96"></a><span id="l20.96"> </span>
<a href="#l20.97"></a><span id="l20.97">   try {</span>
<a href="#l20.98"></a><span id="l20.98">     gCurrentTheme = getThemeByName(name);</span>
<a href="#l20.99"></a><span id="l20.99">     gCurrentTheme.variant = variant;</span>
<a href="#l20.100"></a><span id="l20.100">   } catch(e) {</span>
<a href="#l20.101"></a><span id="l20.101" class="difflineat">@@ -263,17 +259,17 @@ function getDirectoryEntries(aDir)</span>
<a href="#l20.102"></a><span id="l20.102"> </span>
<a href="#l20.103"></a><span id="l20.103">   // remove any trailing file name added by convertChromeURL</span>
<a href="#l20.104"></a><span id="l20.104">   let spec = uri.spec.replace(/[^\/]+$/, &quot;&quot;);</span>
<a href="#l20.105"></a><span id="l20.105">   uri = ios.newURI(spec, null, null);</span>
<a href="#l20.106"></a><span id="l20.106"> </span>
<a href="#l20.107"></a><span id="l20.107">   let results = [];</span>
<a href="#l20.108"></a><span id="l20.108">   if (uri.scheme == &quot;jar&quot;) {</span>
<a href="#l20.109"></a><span id="l20.109">     uri.QueryInterface(Ci.nsIJARURI);</span>
<a href="#l20.110"></a><span id="l20.110" class="difflineminus">-    var strEntry = uri.JAREntry;</span>
<a href="#l20.111"></a><span id="l20.111" class="difflineplus">+    let strEntry = uri.JAREntry;</span>
<a href="#l20.112"></a><span id="l20.112">     if (!strEntry)</span>
<a href="#l20.113"></a><span id="l20.113">       return [];</span>
<a href="#l20.114"></a><span id="l20.114"> </span>
<a href="#l20.115"></a><span id="l20.115">     let zr = Components.classes[&quot;@mozilla.org/libjar/zip-reader;1&quot;]</span>
<a href="#l20.116"></a><span id="l20.116">                        .createInstance(Ci.nsIZipReader);</span>
<a href="#l20.117"></a><span id="l20.117">     let jarFile = uri.JARFile;</span>
<a href="#l20.118"></a><span id="l20.118">     if (jarFile instanceof Ci.nsIJARURI) {</span>
<a href="#l20.119"></a><span id="l20.119">       let innerZr = Components.classes[&quot;@mozilla.org/libjar/zip-reader;1&quot;]</span>
<a href="#l20.120"></a><span id="l20.120" class="difflineat">@@ -284,28 +280,28 @@ function getDirectoryEntries(aDir)</span>
<a href="#l20.121"></a><span id="l20.121">     else</span>
<a href="#l20.122"></a><span id="l20.122">       zr.open(jarFile.QueryInterface(Ci.nsIFileURL).file);</span>
<a href="#l20.123"></a><span id="l20.123"> </span>
<a href="#l20.124"></a><span id="l20.124">     if (!zr.hasEntry(strEntry) || !zr.getEntry(strEntry).isDirectory) {</span>
<a href="#l20.125"></a><span id="l20.125">       zr.close();</span>
<a href="#l20.126"></a><span id="l20.126">       return [];</span>
<a href="#l20.127"></a><span id="l20.127">     }</span>
<a href="#l20.128"></a><span id="l20.128"> </span>
<a href="#l20.129"></a><span id="l20.129" class="difflineminus">-    var escapedEntry = strEntry.replace(/([*?$[\]^~()\\])/g, &quot;\\$1&quot;);</span>
<a href="#l20.130"></a><span id="l20.130" class="difflineminus">-    var filter = escapedEntry + &quot;?*~&quot; + escapedEntry + &quot;?*/?*&quot;;</span>
<a href="#l20.131"></a><span id="l20.131" class="difflineminus">-    var entries = zr.findEntries(filter);</span>
<a href="#l20.132"></a><span id="l20.132" class="difflineplus">+    let escapedEntry = strEntry.replace(/([*?$[\]^~()\\])/g, &quot;\\$1&quot;);</span>
<a href="#l20.133"></a><span id="l20.133" class="difflineplus">+    let filter = escapedEntry + &quot;?*~&quot; + escapedEntry + &quot;?*/?*&quot;;</span>
<a href="#l20.134"></a><span id="l20.134" class="difflineplus">+    let entries = zr.findEntries(filter);</span>
<a href="#l20.135"></a><span id="l20.135"> </span>
<a href="#l20.136"></a><span id="l20.136">     let parentLength = strEntry.length;</span>
<a href="#l20.137"></a><span id="l20.137">     while (entries.hasMore())</span>
<a href="#l20.138"></a><span id="l20.138">       results.push(entries.getNext().substring(parentLength));</span>
<a href="#l20.139"></a><span id="l20.139">     zr.close();</span>
<a href="#l20.140"></a><span id="l20.140">   }</span>
<a href="#l20.141"></a><span id="l20.141">   else if (uri.scheme == &quot;file&quot;) {</span>
<a href="#l20.142"></a><span id="l20.142">     uri.QueryInterface(Ci.nsIFileURL);</span>
<a href="#l20.143"></a><span id="l20.143" class="difflineminus">-    var dir = uri.file;</span>
<a href="#l20.144"></a><span id="l20.144" class="difflineplus">+    let dir = uri.file;</span>
<a href="#l20.145"></a><span id="l20.145"> </span>
<a href="#l20.146"></a><span id="l20.146">     if (!dir.exists() || !dir.isDirectory())</span>
<a href="#l20.147"></a><span id="l20.147">       return [];</span>
<a href="#l20.148"></a><span id="l20.148"> </span>
<a href="#l20.149"></a><span id="l20.149">     let children = dir.directoryEntries;</span>
<a href="#l20.150"></a><span id="l20.150">     while (children.hasMoreElements()) {</span>
<a href="#l20.151"></a><span id="l20.151">       let file = children.getNext()</span>
<a href="#l20.152"></a><span id="l20.152">                          .QueryInterface(Ci.nsIFile);</span>
<a href="#l20.153"></a><span id="l20.153" class="difflineat">@@ -315,19 +311,18 @@ function getDirectoryEntries(aDir)</span>
<a href="#l20.154"></a><span id="l20.154"> </span>
<a href="#l20.155"></a><span id="l20.155">   return results;</span>
<a href="#l20.156"></a><span id="l20.156"> }</span>
<a href="#l20.157"></a><span id="l20.157"> </span>
<a href="#l20.158"></a><span id="l20.158"> function getThemeVariants(aTheme)</span>
<a href="#l20.159"></a><span id="l20.159"> {</span>
<a href="#l20.160"></a><span id="l20.160">   let variants = getDirectoryEntries(aTheme.baseURI + &quot;Variants/&quot;);</span>
<a href="#l20.161"></a><span id="l20.161">   let cssRe = /\.css$/;</span>
<a href="#l20.162"></a><span id="l20.162" class="difflineminus">-  variants = variants.filter(function(v) cssRe.test(v))</span>
<a href="#l20.163"></a><span id="l20.163" class="difflineminus">-                     .map(function(v) v.replace(cssRe, &quot;&quot;));</span>
<a href="#l20.164"></a><span id="l20.164" class="difflineminus">-  return variants;</span>
<a href="#l20.165"></a><span id="l20.165" class="difflineplus">+  return variants.filter(function(v) cssRe.test(v))</span>
<a href="#l20.166"></a><span id="l20.166" class="difflineplus">+                 .map(function(v) v.replace(cssRe, &quot;&quot;));</span>
<a href="#l20.167"></a><span id="l20.167"> }</span>
<a href="#l20.168"></a><span id="l20.168"> </span>
<a href="#l20.169"></a><span id="l20.169"> /* helper function for replacements in messages */</span>
<a href="#l20.170"></a><span id="l20.170"> function getBuddyFromMessage(aMsg)</span>
<a href="#l20.171"></a><span id="l20.171"> {</span>
<a href="#l20.172"></a><span id="l20.172">   if (aMsg.incoming) {</span>
<a href="#l20.173"></a><span id="l20.173">     let conv = aMsg.conversation;</span>
<a href="#l20.174"></a><span id="l20.174">     if (!conv.isChat)</span>
<a href="#l20.175"></a><span id="l20.175" class="difflineat">@@ -355,17 +350,17 @@ function getStatusIconFromBuddy(aBuddy)</span>
<a href="#l20.176"></a><span id="l20.176"> }</span>
<a href="#l20.177"></a><span id="l20.177"> </span>
<a href="#l20.178"></a><span id="l20.178"> const headerFooterReplacements = {</span>
<a href="#l20.179"></a><span id="l20.179">   chatName: function(aConv) aConv.title,</span>
<a href="#l20.180"></a><span id="l20.180">   sourceName: function(aConv) aConv.account.alias || aConv.account.name,</span>
<a href="#l20.181"></a><span id="l20.181">   destinationName: function(aConv) aConv.name,</span>
<a href="#l20.182"></a><span id="l20.182">   destinationDisplayName: function(aConv) aConv.title,</span>
<a href="#l20.183"></a><span id="l20.183">   incomingIconPath: function(aConv) {</span>
<a href="#l20.184"></a><span id="l20.184" class="difflineminus">-    var buddy;</span>
<a href="#l20.185"></a><span id="l20.185" class="difflineplus">+    let buddy;</span>
<a href="#l20.186"></a><span id="l20.186">     return (!aConv.isChat &amp;&amp; (buddy = aConv.buddy) &amp;&amp;</span>
<a href="#l20.187"></a><span id="l20.187">             buddy.buddyIconFilename) || &quot;incoming_icon.png&quot;;</span>
<a href="#l20.188"></a><span id="l20.188">   },</span>
<a href="#l20.189"></a><span id="l20.189">   outgoingIconPath: function(aConv) &quot;outgoing_icon.png&quot;,</span>
<a href="#l20.190"></a><span id="l20.190">   timeOpened: function(aConv, aFormat) {</span>
<a href="#l20.191"></a><span id="l20.191">     if (aFormat)</span>
<a href="#l20.192"></a><span id="l20.192">       return (new Date()).toLocaleFormat(aFormat);</span>
<a href="#l20.193"></a><span id="l20.193">     else</span>
<a href="#l20.194"></a><span id="l20.194" class="difflineat">@@ -460,33 +455,33 @@ const statusReplacements = {</span>
<a href="#l20.195"></a><span id="l20.195">     let buddy = null;</span>
<a href="#l20.196"></a><span id="l20.196">     if (!conv.isChat)</span>
<a href="#l20.197"></a><span id="l20.197">       buddy = conv.buddy;</span>
<a href="#l20.198"></a><span id="l20.198">     return getStatusIconFromBuddy(buddy);</span>
<a href="#l20.199"></a><span id="l20.199">   },</span>
<a href="#l20.200"></a><span id="l20.200">   __proto__: statusMessageReplacements</span>
<a href="#l20.201"></a><span id="l20.201"> };</span>
<a href="#l20.202"></a><span id="l20.202"> </span>
<a href="#l20.203"></a><span id="l20.203" class="difflineminus">-const replacementRegExp = /%([a-zA-Z]*)(\{([^\}]*)\})?%/g;</span>
<a href="#l20.204"></a><span id="l20.204" class="difflineplus">+const kReplacementRegExp = /%([a-zA-Z]*)(\{([^\}]*)\})?%/g;</span>
<a href="#l20.205"></a><span id="l20.205"> </span>
<a href="#l20.206"></a><span id="l20.206"> function replaceKeywordsInHTML(aHTML, aReplacements, aReplacementArg)</span>
<a href="#l20.207"></a><span id="l20.207"> {</span>
<a href="#l20.208"></a><span id="l20.208" class="difflineminus">-  replacementRegExp.lastIndex = 0;</span>
<a href="#l20.209"></a><span id="l20.209" class="difflineplus">+  kReplacementRegExp.lastIndex = 0;</span>
<a href="#l20.210"></a><span id="l20.210">   let previousIndex = 0;</span>
<a href="#l20.211"></a><span id="l20.211">   let result = &quot;&quot;;</span>
<a href="#l20.212"></a><span id="l20.212">   let match;</span>
<a href="#l20.213"></a><span id="l20.213" class="difflineminus">-  while ((match = replacementRegExp.exec(aHTML))) {</span>
<a href="#l20.214"></a><span id="l20.214" class="difflineplus">+  while ((match = kReplacementRegExp.exec(aHTML))) {</span>
<a href="#l20.215"></a><span id="l20.215">     let content = &quot;&quot;;</span>
<a href="#l20.216"></a><span id="l20.216">     if (match[1] in aReplacements)</span>
<a href="#l20.217"></a><span id="l20.217">       content = aReplacements[match[1]](aReplacementArg, match[3]);</span>
<a href="#l20.218"></a><span id="l20.218">     else</span>
<a href="#l20.219"></a><span id="l20.219">       Components.utils.reportError(&quot;Unknown replacement string %&quot; +</span>
<a href="#l20.220"></a><span id="l20.220">                                    match[1] + &quot;% in message styles.&quot;);</span>
<a href="#l20.221"></a><span id="l20.221">     result += aHTML.substring(previousIndex, match.index) + content;</span>
<a href="#l20.222"></a><span id="l20.222" class="difflineminus">-    previousIndex = replacementRegExp.lastIndex;</span>
<a href="#l20.223"></a><span id="l20.223" class="difflineplus">+    previousIndex = kReplacementRegExp.lastIndex;</span>
<a href="#l20.224"></a><span id="l20.224">   }</span>
<a href="#l20.225"></a><span id="l20.225"> </span>
<a href="#l20.226"></a><span id="l20.226">   return result + aHTML.slice(previousIndex);</span>
<a href="#l20.227"></a><span id="l20.227"> }</span>
<a href="#l20.228"></a><span id="l20.228"> </span>
<a href="#l20.229"></a><span id="l20.229"> function isNextMessage(aTheme, aMsg, aPreviousMsg)</span>
<a href="#l20.230"></a><span id="l20.230"> {</span>
<a href="#l20.231"></a><span id="l20.231">   if (!aTheme.combineConsecutive ||</span>
<a href="#l20.232"></a><span id="l20.232" class="difflineat">@@ -587,17 +582,17 @@ function getMetadata(aTheme, aKey)</span>
<a href="#l20.233"></a><span id="l20.233">       ((aKey + &quot;:&quot; + aTheme.metadata.DefaultVariant) in aTheme.metadata))</span>
<a href="#l20.234"></a><span id="l20.234">     return aTheme.metadata[aKey + &quot;:&quot; + aTheme.metadata.DefaultVariant];</span>
<a href="#l20.235"></a><span id="l20.235"> </span>
<a href="#l20.236"></a><span id="l20.236">   return aTheme.metadata[aKey];</span>
<a href="#l20.237"></a><span id="l20.237"> }</span>
<a href="#l20.238"></a><span id="l20.238"> </span>
<a href="#l20.239"></a><span id="l20.239"> function initHTMLDocument(aConv, aTheme, aDoc)</span>
<a href="#l20.240"></a><span id="l20.240"> {</span>
<a href="#l20.241"></a><span id="l20.241" class="difflineminus">-  var HTML = &quot;&lt;html&gt;&lt;head&gt;&lt;base href=\&quot;&quot; + aTheme.baseURI + &quot;\&quot;/&gt;&quot;;</span>
<a href="#l20.242"></a><span id="l20.242" class="difflineplus">+  let HTML = &quot;&lt;html&gt;&lt;head&gt;&lt;base href=\&quot;&quot; + aTheme.baseURI + &quot;\&quot;/&gt;&quot;;</span>
<a href="#l20.243"></a><span id="l20.243"> </span>
<a href="#l20.244"></a><span id="l20.244">   function addCSS(aHref)</span>
<a href="#l20.245"></a><span id="l20.245">   {</span>
<a href="#l20.246"></a><span id="l20.246">     HTML += &quot;&lt;link rel=\&quot;stylesheet\&quot; href=\&quot;&quot; + aHref + &quot;\&quot; type=\&quot;text/css\&quot;/&gt;&quot;;</span>
<a href="#l20.247"></a><span id="l20.247">   }</span>
<a href="#l20.248"></a><span id="l20.248">   addCSS(&quot;chrome://chat/skin/conv.css&quot;);</span>
<a href="#l20.249"></a><span id="l20.249"> </span>
<a href="#l20.250"></a><span id="l20.250">   // add css to handle DefaultFontFamily and DefaultFontSize</span>
<a href="#l20.251"></a><span id="l20.251" class="difflineat">@@ -647,18 +642,21 @@ function getEllipsis()</span>
<a href="#l20.252"></a><span id="l20.252">               .getComplexValue(&quot;messenger.conversations.selections.ellipsis&quot;,</span>
<a href="#l20.253"></a><span id="l20.253">                                Ci.nsIPrefLocalizedString).data;</span>
<a href="#l20.254"></a><span id="l20.254">   } catch (e) { }</span>
<a href="#l20.255"></a><span id="l20.255">   return ellipsis;</span>
<a href="#l20.256"></a><span id="l20.256"> }</span>
<a href="#l20.257"></a><span id="l20.257"> </span>
<a href="#l20.258"></a><span id="l20.258"> function _serializeDOMObject(aDocument, aInitFunction)</span>
<a href="#l20.259"></a><span id="l20.259"> {</span>
<a href="#l20.260"></a><span id="l20.260" class="difflineminus">-  const type = &quot;text/plain&quot;;</span>
<a href="#l20.261"></a><span id="l20.261" class="difflineminus">-  var encoder =</span>
<a href="#l20.262"></a><span id="l20.262" class="difflineplus">+  // This shouldn't really be a constant, as we want to support</span>
<a href="#l20.263"></a><span id="l20.263" class="difflineplus">+  // text/html too in the future.</span>
<a href="#l20.264"></a><span id="l20.264" class="difflineplus">+  const type = &quot;text/plain&quot;; </span>
<a href="#l20.265"></a><span id="l20.265" class="difflineplus">+</span>
<a href="#l20.266"></a><span id="l20.266" class="difflineplus">+  let encoder =</span>
<a href="#l20.267"></a><span id="l20.267">     Components.classes[&quot;@mozilla.org/layout/documentEncoder;1?type=&quot; + type]</span>
<a href="#l20.268"></a><span id="l20.268">               .createInstance(Ci.nsIDocumentEncoder);</span>
<a href="#l20.269"></a><span id="l20.269">   encoder.init(aDocument, type, 0);</span>
<a href="#l20.270"></a><span id="l20.270">   aInitFunction(encoder);</span>
<a href="#l20.271"></a><span id="l20.271">   let result = encoder.encodeToString();</span>
<a href="#l20.272"></a><span id="l20.272">   return result;</span>
<a href="#l20.273"></a><span id="l20.273"> }</span>
<a href="#l20.274"></a><span id="l20.274"> </span>
<a href="#l20.275"></a><span id="l20.275" class="difflineat">@@ -672,39 +670,39 @@ function serializeNode(aNode)</span>
<a href="#l20.276"></a><span id="l20.276"> {</span>
<a href="#l20.277"></a><span id="l20.277">   return _serializeDOMObject(aNode.ownerDocument,</span>
<a href="#l20.278"></a><span id="l20.278">                              function(aEncoder) { aEncoder.setNode(aNode); });</span>
<a href="#l20.279"></a><span id="l20.279"> }</span>
<a href="#l20.280"></a><span id="l20.280"> </span>
<a href="#l20.281"></a><span id="l20.281"> /* This function is used to pretty print a selection inside a conversation area */</span>
<a href="#l20.282"></a><span id="l20.282"> function serializeSelection(aSelection)</span>
<a href="#l20.283"></a><span id="l20.283"> {</span>
<a href="#l20.284"></a><span id="l20.284" class="difflineminus">-  // We have to kinds of selection serialization:</span>
<a href="#l20.285"></a><span id="l20.285" class="difflineplus">+  // We have two kinds of selection serialization:</span>
<a href="#l20.286"></a><span id="l20.286">   //  - The short version, used when only a part of message is</span>
<a href="#l20.287"></a><span id="l20.287">   //    selected, or if nothing interesting is selected</span>
<a href="#l20.288"></a><span id="l20.288" class="difflineminus">-  var shortSelection = &quot;&quot;;</span>
<a href="#l20.289"></a><span id="l20.289" class="difflineplus">+  let shortSelection = &quot;&quot;;</span>
<a href="#l20.290"></a><span id="l20.290"> </span>
<a href="#l20.291"></a><span id="l20.291">   //  - The long version, which is used:</span>
<a href="#l20.292"></a><span id="l20.292">   //      * when both some of the message text and some of the context</span>
<a href="#l20.293"></a><span id="l20.293">   //        (sender, time, ...) is selected;</span>
<a href="#l20.294"></a><span id="l20.294">   //      * when several messages are selected at once</span>
<a href="#l20.295"></a><span id="l20.295">   //    This version uses an array, with each message formatted</span>
<a href="#l20.296"></a><span id="l20.296">   //    through the theme system.</span>
<a href="#l20.297"></a><span id="l20.297" class="difflineminus">-  var longSelection = [];</span>
<a href="#l20.298"></a><span id="l20.298" class="difflineplus">+  let longSelection = [];</span>
<a href="#l20.299"></a><span id="l20.299"> </span>
<a href="#l20.300"></a><span id="l20.300">   // We first assume that we are going to use the short version, but</span>
<a href="#l20.301"></a><span id="l20.301">   // while working on creating the short version, we prepare</span>
<a href="#l20.302"></a><span id="l20.302">   // everything to be able to switch to the long version if we later</span>
<a href="#l20.303"></a><span id="l20.303">   // discover that it is in fact needed.</span>
<a href="#l20.304"></a><span id="l20.304" class="difflineminus">-  var shortVersionPossible = true;</span>
<a href="#l20.305"></a><span id="l20.305" class="difflineplus">+  let shortVersionPossible = true;</span>
<a href="#l20.306"></a><span id="l20.306"> </span>
<a href="#l20.307"></a><span id="l20.307">   // Sometimes we need to know if a selection range is inside the same</span>
<a href="#l20.308"></a><span id="l20.308">   // message as the previous selection range, so we keep track of the</span>
<a href="#l20.309"></a><span id="l20.309">   // last message we have processed.</span>
<a href="#l20.310"></a><span id="l20.310" class="difflineminus">-  var lastMessage = null;</span>
<a href="#l20.311"></a><span id="l20.311" class="difflineplus">+  let lastMessage = null;</span>
<a href="#l20.312"></a><span id="l20.312"> </span>
<a href="#l20.313"></a><span id="l20.313">   for (let i = 0; i &lt; aSelection.rangeCount; ++i) {</span>
<a href="#l20.314"></a><span id="l20.314">     let range = aSelection.getRangeAt(i);</span>
<a href="#l20.315"></a><span id="l20.315">     let messages = getMessagesForRange(range);</span>
<a href="#l20.316"></a><span id="l20.316"> </span>
<a href="#l20.317"></a><span id="l20.317">     // If at least one selected message has some of its text selected,</span>
<a href="#l20.318"></a><span id="l20.318">     // remove from the selection all the messages that have no text</span>
<a href="#l20.319"></a><span id="l20.319">     // selected</span>
<a href="#l20.320"></a><span id="l20.320" class="difflineat">@@ -723,17 +721,17 @@ function serializeSelection(aSelection)</span>
<a href="#l20.321"></a><span id="l20.321">         (!messages[0].isTextSelected() || messages[0].onlyTextSelected()) &amp;&amp;</span>
<a href="#l20.322"></a><span id="l20.322">         (!lastMessage || lastMessage.msg == messages[0].msg ||</span>
<a href="#l20.323"></a><span id="l20.323">          lastMessage.msg.who == messages[0].msg.who)) {</span>
<a href="#l20.324"></a><span id="l20.324">       if (shortSelection) {</span>
<a href="#l20.325"></a><span id="l20.325">         if (lastMessage.msg != messages[0].msg) {</span>
<a href="#l20.326"></a><span id="l20.326">           // Add the ellipsis only if the previous message was cut</span>
<a href="#l20.327"></a><span id="l20.327">           if (lastMessage.cutEnd)</span>
<a href="#l20.328"></a><span id="l20.328">             shortSelection += &quot; &quot; + getEllipsis();</span>
<a href="#l20.329"></a><span id="l20.329" class="difflineminus">-          shortSelection += &quot;@LINE_BREAK@&quot;;</span>
<a href="#l20.330"></a><span id="l20.330" class="difflineplus">+          shortSelection += kLineBreak;</span>
<a href="#l20.331"></a><span id="l20.331">         }</span>
<a href="#l20.332"></a><span id="l20.332">         else</span>
<a href="#l20.333"></a><span id="l20.333">           shortSelection += &quot; &quot; + getEllipsis() + &quot; &quot;;</span>
<a href="#l20.334"></a><span id="l20.334">       }</span>
<a href="#l20.335"></a><span id="l20.335">       shortSelection += serializeRange(range);</span>
<a href="#l20.336"></a><span id="l20.336">       longSelection.push(messages[0].getFormattedMessage());</span>
<a href="#l20.337"></a><span id="l20.337">     }</span>
<a href="#l20.338"></a><span id="l20.338">     else {</span>
<a href="#l20.339"></a><span id="l20.339" class="difflineat">@@ -751,17 +749,17 @@ function serializeSelection(aSelection)</span>
<a href="#l20.340"></a><span id="l20.340">       }</span>
<a href="#l20.341"></a><span id="l20.341">     }</span>
<a href="#l20.342"></a><span id="l20.342">     lastMessage = messages[messages.length - 1];</span>
<a href="#l20.343"></a><span id="l20.343">   }</span>
<a href="#l20.344"></a><span id="l20.344"> </span>
<a href="#l20.345"></a><span id="l20.345">   if (shortVersionPossible)</span>
<a href="#l20.346"></a><span id="l20.346">     return shortSelection || aSelection.toString();</span>
<a href="#l20.347"></a><span id="l20.347">   else</span>
<a href="#l20.348"></a><span id="l20.348" class="difflineminus">-    return longSelection.join(&quot;@LINE_BREAK@&quot;);</span>
<a href="#l20.349"></a><span id="l20.349" class="difflineplus">+    return longSelection.join(kLineBreak);</span>
<a href="#l20.350"></a><span id="l20.350"> }</span>
<a href="#l20.351"></a><span id="l20.351"> </span>
<a href="#l20.352"></a><span id="l20.352"> function SelectedMessage(aRootNode, aRange)</span>
<a href="#l20.353"></a><span id="l20.353"> {</span>
<a href="#l20.354"></a><span id="l20.354">   this._rootNodes = [aRootNode];</span>
<a href="#l20.355"></a><span id="l20.355">   this._range = aRange;</span>
<a href="#l20.356"></a><span id="l20.356"> }</span>
<a href="#l20.357"></a><span id="l20.357"> </span>
<a href="#l20.358"></a><span id="l20.358" class="difflineat">@@ -847,17 +845,17 @@ SelectedMessage.prototype = {</span>
<a href="#l20.359"></a><span id="l20.359">       }</span>
<a href="#l20.360"></a><span id="l20.360">       else</span>
<a href="#l20.361"></a><span id="l20.361">         this._cutBegin = false;</span>
<a href="#l20.362"></a><span id="l20.362"> </span>
<a href="#l20.363"></a><span id="l20.363">       if (endPoint == 1) {</span>
<a href="#l20.364"></a><span id="l20.364">         let range = spanNode.ownerDocument.createRange();</span>
<a href="#l20.365"></a><span id="l20.365">         range.setStart(this._range.endContainer, this._range.endOffset);</span>
<a href="#l20.366"></a><span id="l20.366">         range.setEnd(spanNode, spanNode.childNodes.length);</span>
<a href="#l20.367"></a><span id="l20.367" class="difflineminus">-        this._cutEnd = !/^(@LINE_BREAK@)?$/.test(serializeRange(range));</span>
<a href="#l20.368"></a><span id="l20.368" class="difflineplus">+        this._cutEnd = !/^(\r?\n)?$/.test(serializeRange(range));</span>
<a href="#l20.369"></a><span id="l20.369">       }</span>
<a href="#l20.370"></a><span id="l20.370">       else</span>
<a href="#l20.371"></a><span id="l20.371">         this._cutEnd = false;</span>
<a href="#l20.372"></a><span id="l20.372">     }</span>
<a href="#l20.373"></a><span id="l20.373">     this._otherSelected =</span>
<a href="#l20.374"></a><span id="l20.374">       (startPoint &gt;= 0 || endPoint &lt;= 0) &amp;&amp; // eliminate most negative cases</span>
<a href="#l20.375"></a><span id="l20.375">       (!this._textSelected ||</span>
<a href="#l20.376"></a><span id="l20.376">        serializeRange(this._range).length &gt; this._selectedText.length);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/chat/modules/imXPCOMUtils.jsm</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/chat/modules/imXPCOMUtils.jsm</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -96,21 +96,21 @@ function initLogModule(aModule, aThis)</span>
<a href="#l21.4"></a><span id="l21.4">   aThis.DEBUG = scriptError.bind(aThis, aModule, DEBUG_MISC);</span>
<a href="#l21.5"></a><span id="l21.5">   aThis.LOG   = scriptError.bind(aThis, aModule, DEBUG_INFO);</span>
<a href="#l21.6"></a><span id="l21.6">   aThis.WARN  = scriptError.bind(aThis, aModule, DEBUG_WARNING);</span>
<a href="#l21.7"></a><span id="l21.7">   aThis.ERROR = scriptError.bind(aThis, aModule, DEBUG_ERROR);</span>
<a href="#l21.8"></a><span id="l21.8"> }</span>
<a href="#l21.9"></a><span id="l21.9"> </span>
<a href="#l21.10"></a><span id="l21.10"> function setTimeout(aFunction, aDelay)</span>
<a href="#l21.11"></a><span id="l21.11"> {</span>
<a href="#l21.12"></a><span id="l21.12" class="difflineminus">-  var timer = Cc[&quot;@mozilla.org/timer;1&quot;].createInstance(Ci.nsITimer);</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineminus">-  var args = Array.prototype.slice.call(arguments, 2);</span>
<a href="#l21.14"></a><span id="l21.14" class="difflineplus">+  let timer = Cc[&quot;@mozilla.org/timer;1&quot;].createInstance(Ci.nsITimer);</span>
<a href="#l21.15"></a><span id="l21.15" class="difflineplus">+  let args = Array.prototype.slice.call(arguments, 2);</span>
<a href="#l21.16"></a><span id="l21.16">   // A reference to the timer should be kept to ensure it won't be</span>
<a href="#l21.17"></a><span id="l21.17">   // GC'ed before firing the callback.</span>
<a href="#l21.18"></a><span id="l21.18" class="difflineminus">-  var callback = {</span>
<a href="#l21.19"></a><span id="l21.19" class="difflineplus">+  let callback = {</span>
<a href="#l21.20"></a><span id="l21.20">     _timer: timer,</span>
<a href="#l21.21"></a><span id="l21.21">     notify: function (aTimer) { aFunction.apply(null, args); delete this._timer; }</span>
<a href="#l21.22"></a><span id="l21.22">   };</span>
<a href="#l21.23"></a><span id="l21.23">   timer.initWithCallback(callback, aDelay, Ci.nsITimer.TYPE_ONE_SHOT);</span>
<a href="#l21.24"></a><span id="l21.24">   return timer;</span>
<a href="#l21.25"></a><span id="l21.25"> }</span>
<a href="#l21.26"></a><span id="l21.26"> function clearTimeout(aTimer)</span>
<a href="#l21.27"></a><span id="l21.27"> {</span>
<a href="#l21.28"></a><span id="l21.28" class="difflineat">@@ -150,17 +150,17 @@ ClassInfo.prototype = {</span>
<a href="#l21.29"></a><span id="l21.29">   QueryInterface: function ClassInfo_QueryInterface(iid) {</span>
<a href="#l21.30"></a><span id="l21.30">     if (iid.equals(Ci.nsISupports) || iid.equals(Ci.nsIClassInfo) ||</span>
<a href="#l21.31"></a><span id="l21.31">         this._interfaces.some(function(i) i.equals(iid)))</span>
<a href="#l21.32"></a><span id="l21.32">       return this;</span>
<a href="#l21.33"></a><span id="l21.33"> </span>
<a href="#l21.34"></a><span id="l21.34">     throw Cr.NS_ERROR_NO_INTERFACE;</span>
<a href="#l21.35"></a><span id="l21.35">   },</span>
<a href="#l21.36"></a><span id="l21.36">   getInterfaces: function(countRef) {</span>
<a href="#l21.37"></a><span id="l21.37" class="difflineminus">-    var interfaces =</span>
<a href="#l21.38"></a><span id="l21.38" class="difflineplus">+    let interfaces =</span>
<a href="#l21.39"></a><span id="l21.39">       [Ci.nsIClassInfo, Ci.nsISupports].concat(this._interfaces);</span>
<a href="#l21.40"></a><span id="l21.40">     countRef.value = interfaces.length;</span>
<a href="#l21.41"></a><span id="l21.41">     return interfaces;</span>
<a href="#l21.42"></a><span id="l21.42">   },</span>
<a href="#l21.43"></a><span id="l21.43">   getHelperForLanguage: function(language) null,</span>
<a href="#l21.44"></a><span id="l21.44">   contractID: null,</span>
<a href="#l21.45"></a><span id="l21.45">   classID: null,</span>
<a href="#l21.46"></a><span id="l21.46">   implementationLanguage: Ci.nsIProgrammingLanguage.JAVASCRIPT,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/chat/modules/jsProtoHelper.jsm</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/chat/modules/jsProtoHelper.jsm</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -325,17 +325,17 @@ const GenericAccountBuddyPrototype = {</span>
<a href="#l22.4"></a><span id="l22.4">   get availabilityDetails() this._availabilityDetails,</span>
<a href="#l22.5"></a><span id="l22.5"> </span>
<a href="#l22.6"></a><span id="l22.6">   get canSendMessage() this.online /*|| this.account.canSendOfflineMessage(this) */,</span>
<a href="#l22.7"></a><span id="l22.7"> </span>
<a href="#l22.8"></a><span id="l22.8">   getTooltipInfo: function() EmptyEnumerator,</span>
<a href="#l22.9"></a><span id="l22.9">   createConversation: function() { throw Cr.NS_ERROR_NOT_IMPLEMENTED; }</span>
<a href="#l22.10"></a><span id="l22.10"> };</span>
<a href="#l22.11"></a><span id="l22.11"> </span>
<a href="#l22.12"></a><span id="l22.12" class="difflineminus">-// aUserName is required only if aBuddy is null (= we are adding a buddy)</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineplus">+// aUserName is required only if aBuddy is null, i.e., we are adding a buddy.</span>
<a href="#l22.14"></a><span id="l22.14"> function AccountBuddy(aAccount, aBuddy, aTag, aUserName) {</span>
<a href="#l22.15"></a><span id="l22.15">   this._init(aAccount, aBuddy, aTag, aUserName);</span>
<a href="#l22.16"></a><span id="l22.16"> }</span>
<a href="#l22.17"></a><span id="l22.17"> AccountBuddy.prototype = GenericAccountBuddyPrototype;</span>
<a href="#l22.18"></a><span id="l22.18"> </span>
<a href="#l22.19"></a><span id="l22.19"> const GenericMessagePrototype = {</span>
<a href="#l22.20"></a><span id="l22.20">   __proto__: ClassInfo(&quot;prplIMessage&quot;, &quot;generic message object&quot;),</span>
<a href="#l22.21"></a><span id="l22.21">   flags: Ci.nsIClassInfo.DOM_OBJECT,</span>
<a href="#l22.22"></a><span id="l22.22" class="difflineat">@@ -575,18 +575,18 @@ TooltipInfo.prototype = ClassInfo(&quot;prplI</span>
<a href="#l22.23"></a><span id="l22.23"> function purplePref(aName, aOption) {</span>
<a href="#l22.24"></a><span id="l22.24">   this.name = aName; // Preference name</span>
<a href="#l22.25"></a><span id="l22.25">   this.label = aOption.label; // Text to display</span>
<a href="#l22.26"></a><span id="l22.26"> </span>
<a href="#l22.27"></a><span id="l22.27">   if (aOption.default === undefined || aOption.default === null)</span>
<a href="#l22.28"></a><span id="l22.28">     throw &quot;A default value for the option is required to determine its type.&quot;;</span>
<a href="#l22.29"></a><span id="l22.29">   this._defaultValue = aOption.default;</span>
<a href="#l22.30"></a><span id="l22.30"> </span>
<a href="#l22.31"></a><span id="l22.31" class="difflineminus">-  const types = {boolean: &quot;Bool&quot;, string: &quot;String&quot;, number: &quot;Int&quot;};</span>
<a href="#l22.32"></a><span id="l22.32" class="difflineminus">-  let type = types[typeof aOption.default];</span>
<a href="#l22.33"></a><span id="l22.33" class="difflineplus">+  const kTypes = {boolean: &quot;Bool&quot;, string: &quot;String&quot;, number: &quot;Int&quot;};</span>
<a href="#l22.34"></a><span id="l22.34" class="difflineplus">+  let type = kTypes[typeof aOption.default];</span>
<a href="#l22.35"></a><span id="l22.35">   if (!type)</span>
<a href="#l22.36"></a><span id="l22.36">     throw &quot;Invalid option type&quot;;</span>
<a href="#l22.37"></a><span id="l22.37"> </span>
<a href="#l22.38"></a><span id="l22.38">   if (type == &quot;String&quot; &amp;&amp; (&quot;listValues&quot; in aOption)) {</span>
<a href="#l22.39"></a><span id="l22.39">     type = &quot;List&quot;;</span>
<a href="#l22.40"></a><span id="l22.40">     this._listValues = aOption.listValues;</span>
<a href="#l22.41"></a><span id="l22.41">   }</span>
<a href="#l22.42"></a><span id="l22.42">   this.type = Ci.prplIPref[&quot;type&quot; + type];</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/chat/modules/socket.jsm</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/chat/modules/socket.jsm</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -380,16 +380,17 @@ const Socket = {</span>
<a href="#l23.4"></a><span id="l23.4">     else</span>
<a href="#l23.5"></a><span id="l23.5">       this.onConnectionClosed();</span>
<a href="#l23.6"></a><span id="l23.6">   },</span>
<a href="#l23.7"></a><span id="l23.7"> </span>
<a href="#l23.8"></a><span id="l23.8">   /*</span>
<a href="#l23.9"></a><span id="l23.9">    * nsIBadCertListener2</span>
<a href="#l23.10"></a><span id="l23.10">    */</span>
<a href="#l23.11"></a><span id="l23.11">   // Called when there's an error, return true to suppress the modal alert.</span>
<a href="#l23.12"></a><span id="l23.12" class="difflineplus">+  // Whatever this function returns, NSS will close the connection.</span>
<a href="#l23.13"></a><span id="l23.13">   notifyCertProblem: function(aSocketInfo, aStatus, aTargetSite) true,</span>
<a href="#l23.14"></a><span id="l23.14"> </span>
<a href="#l23.15"></a><span id="l23.15">   /*</span>
<a href="#l23.16"></a><span id="l23.16">    * nsISSLErrorListener</span>
<a href="#l23.17"></a><span id="l23.17">    */</span>
<a href="#l23.18"></a><span id="l23.18">   notifySSLError: function(aSocketInfo, aError, aTargetSite) true,</span>
<a href="#l23.19"></a><span id="l23.19"> </span>
<a href="#l23.20"></a><span id="l23.20">   /*</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/chat/protocols/twitter/twitter.js</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/chat/protocols/twitter/twitter.js</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -304,19 +304,19 @@ Conversation.prototype = {</span>
<a href="#l24.4"></a><span id="l24.4">           str: &quot;@&quot; + um.screen_name,</span>
<a href="#l24.5"></a><span id="l24.5">           title: um.name,</span>
<a href="#l24.6"></a><span id="l24.6">           href: &quot;https://twitter.com/&quot; + um.screen_name})));</span>
<a href="#l24.7"></a><span id="l24.7">       }</span>
<a href="#l24.8"></a><span id="l24.8">       entArray.sort(function(a, b) a.start - b.start);</span>
<a href="#l24.9"></a><span id="l24.9">       let offset = 0;</span>
<a href="#l24.10"></a><span id="l24.10">       for each (let entity in entArray) {</span>
<a href="#l24.11"></a><span id="l24.11">         let str = text.substring(offset + entity.start, offset + entity.end);</span>
<a href="#l24.12"></a><span id="l24.12" class="difflineminus">-        if (str[0] == &quot;＠&quot;)</span>
<a href="#l24.13"></a><span id="l24.13" class="difflineplus">+        if (str[0] == &quot;\uFF20&quot;) // ＠ - unicode character similar to @</span>
<a href="#l24.14"></a><span id="l24.14">           str = &quot;@&quot; + str.substring(1);</span>
<a href="#l24.15"></a><span id="l24.15" class="difflineminus">-        if (str[0] == &quot;＃&quot;)</span>
<a href="#l24.16"></a><span id="l24.16" class="difflineplus">+        if (str[0] == &quot;\uFF03&quot;) // ＃ - unicode character similar to #</span>
<a href="#l24.17"></a><span id="l24.17">           str = &quot;#&quot; + str.substring(1);</span>
<a href="#l24.18"></a><span id="l24.18">         if (str.toLowerCase() != entity.str.toLowerCase())</span>
<a href="#l24.19"></a><span id="l24.19">           continue;</span>
<a href="#l24.20"></a><span id="l24.20"> </span>
<a href="#l24.21"></a><span id="l24.21">         let html = &quot;&lt;a href=\&quot;&quot; + entity.href + &quot;\&quot;&quot;;</span>
<a href="#l24.22"></a><span id="l24.22">         if (&quot;title&quot; in entity)</span>
<a href="#l24.23"></a><span id="l24.23">           html += &quot; title=\&quot;&quot; + entity.title + &quot;\&quot;&quot;;</span>
<a href="#l24.24"></a><span id="l24.24">         html += &quot;&gt;&quot; + (&quot;text&quot; in entity ? entity.text : entity.str) + &quot;&lt;/a&gt;&quot;;</span>
<a href="#l24.25"></a><span id="l24.25" class="difflineat">@@ -412,22 +412,22 @@ Account.prototype = {</span>
<a href="#l24.26"></a><span id="l24.26">   },</span>
<a href="#l24.27"></a><span id="l24.27"> </span>
<a href="#l24.28"></a><span id="l24.28">   // Twitter doesn't broadcast the user's availability, so we can ignore</span>
<a href="#l24.29"></a><span id="l24.29">   // imIUserStatusInfo's status notifications.</span>
<a href="#l24.30"></a><span id="l24.30">   observe: function(aSubject, aTopic, aMsg) { },</span>
<a href="#l24.31"></a><span id="l24.31"> </span>
<a href="#l24.32"></a><span id="l24.32">   signAndSend: function(aUrl, aHeaders, aPOSTData, aOnLoad, aOnError, aThis,</span>
<a href="#l24.33"></a><span id="l24.33">                         aOAuthParams) {</span>
<a href="#l24.34"></a><span id="l24.34" class="difflineminus">-    const chars =</span>
<a href="#l24.35"></a><span id="l24.35" class="difflineplus">+    const kChars =</span>
<a href="#l24.36"></a><span id="l24.36">       &quot;0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz&quot;;</span>
<a href="#l24.37"></a><span id="l24.37" class="difflineminus">-    const nonceLength = 6;</span>
<a href="#l24.38"></a><span id="l24.38" class="difflineplus">+    const kNonceLength = 6;</span>
<a href="#l24.39"></a><span id="l24.39">     let nonce = &quot;&quot;;</span>
<a href="#l24.40"></a><span id="l24.40" class="difflineminus">-    for (var i = 0; i &lt; nonceLength; ++i)</span>
<a href="#l24.41"></a><span id="l24.41" class="difflineminus">-      nonce += chars[Math.floor(Math.random() * chars.length)];</span>
<a href="#l24.42"></a><span id="l24.42" class="difflineplus">+    for (let i = 0; i &lt; kNonceLength; ++i)</span>
<a href="#l24.43"></a><span id="l24.43" class="difflineplus">+      nonce += kChars[Math.floor(Math.random() * kChars.length)];</span>
<a href="#l24.44"></a><span id="l24.44"> </span>
<a href="#l24.45"></a><span id="l24.45">     let params = (aOAuthParams || []).concat([</span>
<a href="#l24.46"></a><span id="l24.46">       [&quot;oauth_consumer_key&quot;, this.consumerKey],</span>
<a href="#l24.47"></a><span id="l24.47">       [&quot;oauth_nonce&quot;, nonce],</span>
<a href="#l24.48"></a><span id="l24.48">       [&quot;oauth_signature_method&quot;, &quot;HMAC-SHA1&quot;],</span>
<a href="#l24.49"></a><span id="l24.49">       [&quot;oauth_token&quot;, this.token],</span>
<a href="#l24.50"></a><span id="l24.50">       [&quot;oauth_timestamp&quot;, Math.floor(((new Date()).getTime()) / 1000)],</span>
<a href="#l24.51"></a><span id="l24.51">       [&quot;oauth_version&quot;, &quot;1.0&quot;]</span>
<a href="#l24.52"></a><span id="l24.52" class="difflineat">@@ -783,17 +783,17 @@ Account.prototype = {</span>
<a href="#l24.53"></a><span id="l24.53">     }</span>
<a href="#l24.54"></a><span id="l24.54">     this.token = data.oauth_token;</span>
<a href="#l24.55"></a><span id="l24.55">     this.tokenSecret = data.oauth_token_secret;</span>
<a href="#l24.56"></a><span id="l24.56"> </span>
<a href="#l24.57"></a><span id="l24.57">     this.requestAuthorization();</span>
<a href="#l24.58"></a><span id="l24.58">   },</span>
<a href="#l24.59"></a><span id="l24.59">   requestAuthorization: function() {</span>
<a href="#l24.60"></a><span id="l24.60">     this.reportConnecting(_(&quot;connection.requestAuth&quot;));</span>
<a href="#l24.61"></a><span id="l24.61" class="difflineminus">-    const url = this.baseURI + &quot;oauth/authorize?oauth_token=&quot;;</span>
<a href="#l24.62"></a><span id="l24.62" class="difflineplus">+    let url = this.baseURI + &quot;oauth/authorize?oauth_token=&quot;;</span>
<a href="#l24.63"></a><span id="l24.63">     this._browserRequest = {</span>
<a href="#l24.64"></a><span id="l24.64">       get promptText() _(&quot;authPrompt&quot;),</span>
<a href="#l24.65"></a><span id="l24.65">       account: this,</span>
<a href="#l24.66"></a><span id="l24.66">       url: url + this.token,</span>
<a href="#l24.67"></a><span id="l24.67">       _active: true,</span>
<a href="#l24.68"></a><span id="l24.68">       cancelled: function() {</span>
<a href="#l24.69"></a><span id="l24.69">         if (!this._active)</span>
<a href="#l24.70"></a><span id="l24.70">           return;</span>
<a href="#l24.71"></a><span id="l24.71" class="difflineat">@@ -957,17 +957,17 @@ Account.prototype = {</span>
<a href="#l24.72"></a><span id="l24.72">     }</span>
<a href="#l24.73"></a><span id="l24.73"> </span>
<a href="#l24.74"></a><span id="l24.74">     let userInfo = this._userInfo[aBuddyName];</span>
<a href="#l24.75"></a><span id="l24.75"> </span>
<a href="#l24.76"></a><span id="l24.76">     // List of the names of the info to actually show in the tooltip and</span>
<a href="#l24.77"></a><span id="l24.77">     // optionally a transform function to apply to the value.</span>
<a href="#l24.78"></a><span id="l24.78">     // See https://dev.twitter.com/docs/api/1/get/users/show for the options.</span>
<a href="#l24.79"></a><span id="l24.79">     let normalizeBool = function(isFollowing) _(isFollowing ? &quot;yes&quot; : &quot;no&quot;);</span>
<a href="#l24.80"></a><span id="l24.80" class="difflineminus">-    const fields = {</span>
<a href="#l24.81"></a><span id="l24.81" class="difflineplus">+    const kFields = {</span>
<a href="#l24.82"></a><span id="l24.82">       following: normalizeBool,</span>
<a href="#l24.83"></a><span id="l24.83">       description: null,</span>
<a href="#l24.84"></a><span id="l24.84">       url: null,</span>
<a href="#l24.85"></a><span id="l24.85">       location: null,</span>
<a href="#l24.86"></a><span id="l24.86">       lang: function(aLang) {</span>
<a href="#l24.87"></a><span id="l24.87">         try {</span>
<a href="#l24.88"></a><span id="l24.88">           return _lang(aLang);</span>
<a href="#l24.89"></a><span id="l24.89">         }</span>
<a href="#l24.90"></a><span id="l24.90" class="difflineat">@@ -980,21 +980,21 @@ Account.prototype = {</span>
<a href="#l24.91"></a><span id="l24.91">       created_at: function(aDate) (new Date(aDate)).toLocaleDateString(),</span>
<a href="#l24.92"></a><span id="l24.92">       statuses_count: null,</span>
<a href="#l24.93"></a><span id="l24.93">       friends_count: null,</span>
<a href="#l24.94"></a><span id="l24.94">       followers_count: null,</span>
<a href="#l24.95"></a><span id="l24.95">       listed_count: null</span>
<a href="#l24.96"></a><span id="l24.96">     };</span>
<a href="#l24.97"></a><span id="l24.97"> </span>
<a href="#l24.98"></a><span id="l24.98">     let tooltipInfo = [];</span>
<a href="#l24.99"></a><span id="l24.99" class="difflineminus">-    for (let field in fields) {</span>
<a href="#l24.100"></a><span id="l24.100" class="difflineplus">+    for (let field in kFields) {</span>
<a href="#l24.101"></a><span id="l24.101">       if (hasOwnProperty(userInfo, field) &amp;&amp; userInfo[field]) {</span>
<a href="#l24.102"></a><span id="l24.102">         let value = userInfo[field];</span>
<a href="#l24.103"></a><span id="l24.103" class="difflineminus">-        if (fields[field])</span>
<a href="#l24.104"></a><span id="l24.104" class="difflineminus">-          value = fields[field](value);</span>
<a href="#l24.105"></a><span id="l24.105" class="difflineplus">+        if (kFields[field])</span>
<a href="#l24.106"></a><span id="l24.106" class="difflineplus">+          value = kFields[field](value);</span>
<a href="#l24.107"></a><span id="l24.107">         tooltipInfo.push(new TooltipInfo(_(&quot;tooltip.&quot; + field), value));</span>
<a href="#l24.108"></a><span id="l24.108">       }</span>
<a href="#l24.109"></a><span id="l24.109">     }</span>
<a href="#l24.110"></a><span id="l24.110"> </span>
<a href="#l24.111"></a><span id="l24.111">     Services.obs.notifyObservers(new nsSimpleEnumerator(tooltipInfo),</span>
<a href="#l24.112"></a><span id="l24.112">                                  &quot;user-info-received&quot;, aBuddyName);</span>
<a href="#l24.113"></a><span id="l24.113">   },</span>
<a href="#l24.114"></a><span id="l24.114"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1" class="difflineminus">--- a/chat/protocols/xmpp/xmpp-authmechs.jsm</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineplus">+++ b/chat/protocols/xmpp/xmpp-authmechs.jsm</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineat">@@ -122,22 +122,22 @@ DigestMD5Auth.prototype = {</span>
<a href="#l25.4"></a><span id="l25.4">       if (e.length != 2)</span>
<a href="#l25.5"></a><span id="l25.5">         throw &quot;Error decoding: &quot; + elem;</span>
<a href="#l25.6"></a><span id="l25.6"> </span>
<a href="#l25.7"></a><span id="l25.7">       data[e[0]] = e[1].replace(/&quot;|'/g, &quot;&quot;);</span>
<a href="#l25.8"></a><span id="l25.8">     }</span>
<a href="#l25.9"></a><span id="l25.9"> </span>
<a href="#l25.10"></a><span id="l25.10">     data.username = this._username;</span>
<a href="#l25.11"></a><span id="l25.11"> </span>
<a href="#l25.12"></a><span id="l25.12" class="difflineminus">-    const chars =</span>
<a href="#l25.13"></a><span id="l25.13" class="difflineplus">+    const kChars =</span>
<a href="#l25.14"></a><span id="l25.14">       &quot;0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz&quot;;</span>
<a href="#l25.15"></a><span id="l25.15" class="difflineminus">-    const nonceLength = 32;</span>
<a href="#l25.16"></a><span id="l25.16" class="difflineplus">+    const kNonceLength = 32;</span>
<a href="#l25.17"></a><span id="l25.17">     let nonce = &quot;&quot;;</span>
<a href="#l25.18"></a><span id="l25.18" class="difflineminus">-    for (let i = 0; i &lt; nonceLength; ++i)</span>
<a href="#l25.19"></a><span id="l25.19" class="difflineminus">-      nonce += chars[Math.floor(Math.random() * chars.length)];</span>
<a href="#l25.20"></a><span id="l25.20" class="difflineplus">+    for (let i = 0; i &lt; kNonceLength; ++i)</span>
<a href="#l25.21"></a><span id="l25.21" class="difflineplus">+      nonce += kChars[Math.floor(Math.random() * kChars.length)];</span>
<a href="#l25.22"></a><span id="l25.22"> </span>
<a href="#l25.23"></a><span id="l25.23">     data.cnonce = nonce;</span>
<a href="#l25.24"></a><span id="l25.24">     data.nc = &quot;00000001&quot;;</span>
<a href="#l25.25"></a><span id="l25.25">     data.qop = &quot;auth&quot;,</span>
<a href="#l25.26"></a><span id="l25.26">     data[&quot;digest-uri&quot;] = &quot;xmpp/&quot; + this._domain + (data.host ? &quot;/&quot; + host : &quot;&quot;);</span>
<a href="#l25.27"></a><span id="l25.27">     data.response = digestMD5(this._username, data.realm, this._password,</span>
<a href="#l25.28"></a><span id="l25.28">                               data.nonce, data.cnonce, data[&quot;digest-uri&quot;]);</span>
<a href="#l25.29"></a><span id="l25.29">     data.charset = &quot;utf-8&quot;;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1" class="difflineminus">--- a/chat/protocols/xmpp/xmpp-session.jsm</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineplus">+++ b/chat/protocols/xmpp/xmpp-session.jsm</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineat">@@ -32,18 +32,17 @@</span>
<a href="#l26.4"></a><span id="l26.4">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l26.5"></a><span id="l26.5">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l26.6"></a><span id="l26.6">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l26.7"></a><span id="l26.7">  *</span>
<a href="#l26.8"></a><span id="l26.8">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l26.9"></a><span id="l26.9"> </span>
<a href="#l26.10"></a><span id="l26.10"> var EXPORTED_SYMBOLS = [&quot;XMPPSession&quot;, &quot;XMPPDefaultResource&quot;];</span>
<a href="#l26.11"></a><span id="l26.11"> </span>
<a href="#l26.12"></a><span id="l26.12" class="difflineminus">-const Cu = Components.utils;</span>
<a href="#l26.13"></a><span id="l26.13" class="difflineminus">-const Ci = Components.interfaces;</span>
<a href="#l26.14"></a><span id="l26.14" class="difflineplus">+const {interfaces: Ci, utils: Cu} = Components;</span>
<a href="#l26.15"></a><span id="l26.15"> </span>
<a href="#l26.16"></a><span id="l26.16"> Cu.import(&quot;resource:///modules/imXPCOMUtils.jsm&quot;);</span>
<a href="#l26.17"></a><span id="l26.17"> Cu.import(&quot;resource:///modules/socket.jsm&quot;);</span>
<a href="#l26.18"></a><span id="l26.18"> Cu.import(&quot;resource:///modules/xmpp-xml.jsm&quot;);</span>
<a href="#l26.19"></a><span id="l26.19"> Cu.import(&quot;resource:///modules/xmpp-authmechs.jsm&quot;);</span>
<a href="#l26.20"></a><span id="l26.20"> </span>
<a href="#l26.21"></a><span id="l26.21"> initLogModule(&quot;xmpp-session&quot;, this);</span>
<a href="#l26.22"></a><span id="l26.22"> </span>
<a href="#l26.23"></a><span id="l26.23" class="difflineat">@@ -324,29 +323,29 @@ XMPPSession.prototype = {</span>
<a href="#l26.24"></a><span id="l26.24">         let errorMsg = &quot;authenticationFailure&quot;;</span>
<a href="#l26.25"></a><span id="l26.25">         if (aStanza.getElement([&quot;not-authorized&quot;]))</span>
<a href="#l26.26"></a><span id="l26.26">           errorMsg = &quot;notAuthorized&quot;;</span>
<a href="#l26.27"></a><span id="l26.27">         this.onError(Ci.prplIAccount.ERROR_AUTHENTICATION_FAILED,</span>
<a href="#l26.28"></a><span id="l26.28">                      _(&quot;connection.error.&quot; + errorMsg));</span>
<a href="#l26.29"></a><span id="l26.29">         return;</span>
<a href="#l26.30"></a><span id="l26.30">       }</span>
<a href="#l26.31"></a><span id="l26.31"> </span>
<a href="#l26.32"></a><span id="l26.32" class="difflineminus">-      let rv;</span>
<a href="#l26.33"></a><span id="l26.33" class="difflineplus">+      let result;</span>
<a href="#l26.34"></a><span id="l26.34">       try {</span>
<a href="#l26.35"></a><span id="l26.35" class="difflineminus">-        rv = this._auth.next(aStanza);</span>
<a href="#l26.36"></a><span id="l26.36" class="difflineplus">+        result = this._auth.next(aStanza);</span>
<a href="#l26.37"></a><span id="l26.37">       } catch(e) {</span>
<a href="#l26.38"></a><span id="l26.38">         ERROR(e);</span>
<a href="#l26.39"></a><span id="l26.39">         this.onError(Ci.prplIAccount.ERROR_AUTHENTICATION_FAILED,</span>
<a href="#l26.40"></a><span id="l26.40">                      _(&quot;connection.error.authenticationFailure&quot;));</span>
<a href="#l26.41"></a><span id="l26.41">         return;</span>
<a href="#l26.42"></a><span id="l26.42">       }</span>
<a href="#l26.43"></a><span id="l26.43"> </span>
<a href="#l26.44"></a><span id="l26.44" class="difflineminus">-      if (rv.send)</span>
<a href="#l26.45"></a><span id="l26.45" class="difflineminus">-        this.send(rv.send.getXML());</span>
<a href="#l26.46"></a><span id="l26.46" class="difflineminus">-      if (rv.done)</span>
<a href="#l26.47"></a><span id="l26.47" class="difflineplus">+      if (result.send)</span>
<a href="#l26.48"></a><span id="l26.48" class="difflineplus">+        this.send(result.send.getXML());</span>
<a href="#l26.49"></a><span id="l26.49" class="difflineplus">+      if (result.done)</span>
<a href="#l26.50"></a><span id="l26.50">         this.onXmppStanza = this.stanzaListeners.authResult;</span>
<a href="#l26.51"></a><span id="l26.51">     },</span>
<a href="#l26.52"></a><span id="l26.52">     authResult: function(aStanza) {</span>
<a href="#l26.53"></a><span id="l26.53">       if (aStanza.localName != &quot;success&quot;) {</span>
<a href="#l26.54"></a><span id="l26.54">         this.onError(Ci.prplIAccount.ERROR_AUTHENTICATION_FAILED,</span>
<a href="#l26.55"></a><span id="l26.55">                      _(&quot;connection.error.notAuthorized&quot;));</span>
<a href="#l26.56"></a><span id="l26.56">         return;</span>
<a href="#l26.57"></a><span id="l26.57">       }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1" class="difflineminus">--- a/chat/protocols/xmpp/xmpp.jsm</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineplus">+++ b/chat/protocols/xmpp/xmpp.jsm</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineat">@@ -111,16 +111,17 @@ MUCParticipant.prototype = {</span>
<a href="#l27.4"></a><span id="l27.4">   get noFlags() this.role &lt; kRoles.indexOf(&quot;member&quot;),</span>
<a href="#l27.5"></a><span id="l27.5">   get voiced() this.role == kRoles.indexOf(&quot;member&quot;),</span>
<a href="#l27.6"></a><span id="l27.6">   get halfOp() this.role == kRoles.indexOf(&quot;moderator&quot;),</span>
<a href="#l27.7"></a><span id="l27.7">   get op() this.role == kRoles.indexOf(&quot;admin&quot;),</span>
<a href="#l27.8"></a><span id="l27.8">   get founder() this.role == kRoles.indexOf(&quot;owner&quot;),</span>
<a href="#l27.9"></a><span id="l27.9">   typing: false</span>
<a href="#l27.10"></a><span id="l27.10"> };</span>
<a href="#l27.11"></a><span id="l27.11"> </span>
<a href="#l27.12"></a><span id="l27.12" class="difflineplus">+// MUC (Multi-User Chat)</span>
<a href="#l27.13"></a><span id="l27.13"> const XMPPMUCConversationPrototype = {</span>
<a href="#l27.14"></a><span id="l27.14">   __proto__: GenericConvChatPrototype,</span>
<a href="#l27.15"></a><span id="l27.15"> </span>
<a href="#l27.16"></a><span id="l27.16">   _init: function(aAccount, aJID, aNick) {</span>
<a href="#l27.17"></a><span id="l27.17">     GenericConvChatPrototype._init.call(this, aAccount, aJID, aNick);</span>
<a href="#l27.18"></a><span id="l27.18">   },</span>
<a href="#l27.19"></a><span id="l27.19"> </span>
<a href="#l27.20"></a><span id="l27.20">   get normalizedName() this.name,</span>
<a href="#l27.21"></a><span id="l27.21" class="difflineat">@@ -353,27 +354,27 @@ const XMPPAccountBuddyPrototype = {</span>
<a href="#l27.22"></a><span id="l27.22">   },</span>
<a href="#l27.23"></a><span id="l27.23"> </span>
<a href="#l27.24"></a><span id="l27.24">   get normalizedName() this.userName,</span>
<a href="#l27.25"></a><span id="l27.25">   /* Display name of the buddy */</span>
<a href="#l27.26"></a><span id="l27.26">   get contactDisplayName() this.buddy.contact.displayName || this.displayName,</span>
<a href="#l27.27"></a><span id="l27.27"> </span>
<a href="#l27.28"></a><span id="l27.28">   _saveIcon: function(aPhotoNode) {</span>
<a href="#l27.29"></a><span id="l27.29">     let type = aPhotoNode.getElement([&quot;TYPE&quot;]).innerText;</span>
<a href="#l27.30"></a><span id="l27.30" class="difflineminus">-    const ext = {&quot;image/gif&quot;: &quot;gif&quot;, &quot;image/jpeg&quot;: &quot;jpg&quot;, &quot;image/png&quot;: &quot;png&quot;};</span>
<a href="#l27.31"></a><span id="l27.31" class="difflineminus">-    if (!ext.hasOwnProperty(type))</span>
<a href="#l27.32"></a><span id="l27.32" class="difflineplus">+    const kExt = {&quot;image/gif&quot;: &quot;gif&quot;, &quot;image/jpeg&quot;: &quot;jpg&quot;, &quot;image/png&quot;: &quot;png&quot;};</span>
<a href="#l27.33"></a><span id="l27.33" class="difflineplus">+    if (!kExt.hasOwnProperty(type))</span>
<a href="#l27.34"></a><span id="l27.34">       return;</span>
<a href="#l27.35"></a><span id="l27.35"> </span>
<a href="#l27.36"></a><span id="l27.36">     let data = aPhotoNode.getElement([&quot;BINVAL&quot;]).innerText;</span>
<a href="#l27.37"></a><span id="l27.37">     let content = atob(data.replace(/[^A-Za-z0-9\+\/\=]/g, &quot;&quot;));</span>
<a href="#l27.38"></a><span id="l27.38">     let istream = Cc[&quot;@mozilla.org/io/string-input-stream;1&quot;]</span>
<a href="#l27.39"></a><span id="l27.39">                   .createInstance(Ci.nsIStringInputStream);</span>
<a href="#l27.40"></a><span id="l27.40">     istream.setData(content, content.length);</span>
<a href="#l27.41"></a><span id="l27.41"> </span>
<a href="#l27.42"></a><span id="l27.42" class="difflineminus">-    let fileName = this.normalizedName + &quot;.&quot; + ext[type];</span>
<a href="#l27.43"></a><span id="l27.43" class="difflineplus">+    let fileName = this.normalizedName + &quot;.&quot; + kExt[type];</span>
<a href="#l27.44"></a><span id="l27.44">     let file = FileUtils.getFile(&quot;ProfD&quot;, [&quot;icons&quot;,</span>
<a href="#l27.45"></a><span id="l27.45">                                            this.account.protocol.normalizedName,</span>
<a href="#l27.46"></a><span id="l27.46">                                            this.account.normalizedName,</span>
<a href="#l27.47"></a><span id="l27.47">                                            fileName]);</span>
<a href="#l27.48"></a><span id="l27.48">     let ostream = FileUtils.openSafeFileOutputStream(file);</span>
<a href="#l27.49"></a><span id="l27.49">     let buddy = this;</span>
<a href="#l27.50"></a><span id="l27.50">     NetUtil.asyncCopy(istream, ostream, function(rc) {</span>
<a href="#l27.51"></a><span id="l27.51">       if (Components.isSuccessCode(rc))</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

