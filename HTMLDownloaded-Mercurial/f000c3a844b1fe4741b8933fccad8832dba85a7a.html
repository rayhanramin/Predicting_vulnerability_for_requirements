<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 23805:f000c3a844b1fe4741b8933fccad8832dba85a7a</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ f000c3a844b1fe4741b8933fccad8832dba85a7a" />
<meta property="og:url" content="/comm-central/rev/f000c3a844b1fe4741b8933fccad8832dba85a7a" />
<meta property="og:description" content="Bug 1378089 - Part 3. Replace the Bookmarks Manager and the History viewer with the Firefox library. r=IanN" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / f000c3a844b1fe4741b8933fccad8832dba85a7a 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/f000c3a844b1fe4741b8933fccad8832dba85a7a">shortlog</a> |
<a href="/comm-central/log/f000c3a844b1fe4741b8933fccad8832dba85a7a">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/f000c3a844b1fe4741b8933fccad8832dba85a7a">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/f000c3a844b1fe4741b8933fccad8832dba85a7a">files</a> |
changeset |
<a href="/comm-central/raw-rev/f000c3a844b1fe4741b8933fccad8832dba85a7a">raw</a>  | <a href="/comm-central/archive/f000c3a844b1fe4741b8933fccad8832dba85a7a.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1378089">Bug 1378089</a> - Part 3. Replace the Bookmarks Manager and the History viewer with the Firefox library. r=IanN
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#70;&#114;&#97;&#110;&#107;&#45;&#82;&#97;&#105;&#110;&#101;&#114;&#32;&#71;&#114;&#97;&#104;&#108;&#32;&#60;&#102;&#114;&#103;&#114;&#97;&#104;&#108;&#64;&#103;&#109;&#120;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Sat, 03 Feb 2018 19:49:47 +0100</td></tr>

<tr>
 <td>changeset 23805</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/f000c3a844b1fe4741b8933fccad8832dba85a7a">f000c3a844b1fe4741b8933fccad8832dba85a7a</a></td>
</tr>



<tr>
<td>parent 23804</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/0c8c03f917f1a0096d9c3d236a11b817e983cc4f">0c8c03f917f1a0096d9c3d236a11b817e983cc4f</a>
</td>
</tr>

<tr>
<td>child 23806</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4">fd9d6ed9952e446a2d000ed207bea63ff6f9c5a4</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=f000c3a844b1fe4741b8933fccad8832dba85a7a">14348</a></td></tr>
<tr><td>push user</td><td>frgrahl@gmx.net</td></tr>
<tr><td>push date</td><td class="date age">Tue, 24 Apr 2018 17:31:46 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@1ad208ac3369 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=1ad208ac3369666fd6923b8856d8f05a9172e364">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=1ad208ac3369666fd6923b8856d8f05a9172e364&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=1ad208ac3369666fd6923b8856d8f05a9172e364&newProject=comm-central&newRevision=b9a5db2726f3acdf694432d7a182c967d847e5d5&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=1ad208ac3369666fd6923b8856d8f05a9172e364&newProject=comm-central&newRevision=b9a5db2726f3acdf694432d7a182c967d847e5d5&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=1ad208ac3369666fd6923b8856d8f05a9172e364&newProject=comm-central&newRevision=b9a5db2726f3acdf694432d7a182c967d847e5d5&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28IanN%29&revcount=50">IanN</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1378089">1378089</a>, <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1383138">1383138</a>, <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=371409">371409</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1378089">Bug 1378089</a> - Part 3. Replace the Bookmarks Manager and the History viewer with the Firefox library. r=IanN
Fx 56 up to <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1383138">Bug 1383138</a>. Rev 371409 in m-c.</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/FIXME-PLACES.TXT">suite/FIXME-PLACES.TXT</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/FIXME-PLACES.TXT">file</a> |
<a href="/comm-central/annotate/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/FIXME-PLACES.TXT">annotate</a> |
<a href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/FIXME-PLACES.TXT">diff</a> |
<a href="/comm-central/comparison/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/FIXME-PLACES.TXT">comparison</a> |
<a href="/comm-central/log/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/FIXME-PLACES.TXT">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/browser/browser-places.js">suite/browser/browser-places.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/browser/browser-places.js">file</a> |
<a href="/comm-central/annotate/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/browser/browser-places.js">annotate</a> |
<a href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/browser/browser-places.js">diff</a> |
<a href="/comm-central/comparison/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/browser/browser-places.js">comparison</a> |
<a href="/comm-central/log/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/browser/browser-places.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/browser/browser-prefs.js">suite/browser/browser-prefs.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/browser/browser-prefs.js">file</a> |
<a href="/comm-central/annotate/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/browser/browser-prefs.js">annotate</a> |
<a href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/browser/browser-prefs.js">diff</a> |
<a href="/comm-central/comparison/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/browser/browser-prefs.js">comparison</a> |
<a href="/comm-central/log/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/browser/browser-prefs.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/browser/content.js">suite/browser/content.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/browser/content.js">file</a> |
<a href="/comm-central/annotate/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/browser/content.js">annotate</a> |
<a href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/browser/content.js">diff</a> |
<a href="/comm-central/comparison/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/browser/content.js">comparison</a> |
<a href="/comm-central/log/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/browser/content.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/browser/jar.mn">suite/browser/jar.mn</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/browser/jar.mn">file</a> |
<a href="/comm-central/annotate/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/browser/jar.mn">annotate</a> |
<a href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/browser/jar.mn">diff</a> |
<a href="/comm-central/comparison/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/browser/jar.mn">comparison</a> |
<a href="/comm-central/log/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/browser/jar.mn">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/browser/navigator.js">suite/browser/navigator.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/browser/navigator.js">file</a> |
<a href="/comm-central/annotate/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/browser/navigator.js">annotate</a> |
<a href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/browser/navigator.js">diff</a> |
<a href="/comm-central/comparison/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/browser/navigator.js">comparison</a> |
<a href="/comm-central/log/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/browser/navigator.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/browser/navigator.xul">suite/browser/navigator.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/browser/navigator.xul">file</a> |
<a href="/comm-central/annotate/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/browser/navigator.xul">annotate</a> |
<a href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/browser/navigator.xul">diff</a> |
<a href="/comm-central/comparison/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/browser/navigator.xul">comparison</a> |
<a href="/comm-central/log/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/browser/navigator.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/browser/navigatorOverlay.xul">suite/browser/navigatorOverlay.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/browser/navigatorOverlay.xul">file</a> |
<a href="/comm-central/annotate/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/browser/navigatorOverlay.xul">annotate</a> |
<a href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/browser/navigatorOverlay.xul">diff</a> |
<a href="/comm-central/comparison/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/browser/navigatorOverlay.xul">comparison</a> |
<a href="/comm-central/log/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/browser/navigatorOverlay.xul">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/browser/nsBrowserStatusHandler.js">suite/browser/nsBrowserStatusHandler.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/browser/nsBrowserStatusHandler.js">file</a> |
<a href="/comm-central/annotate/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/browser/nsBrowserStatusHandler.js">annotate</a> |
<a href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/browser/nsBrowserStatusHandler.js">diff</a> |
<a href="/comm-central/comparison/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/browser/nsBrowserStatusHandler.js">comparison</a> |
<a href="/comm-central/log/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/browser/nsBrowserStatusHandler.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/jar.mn">suite/common/jar.mn</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/jar.mn">file</a> |
<a href="/comm-central/annotate/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/jar.mn">annotate</a> |
<a href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/jar.mn">diff</a> |
<a href="/comm-central/comparison/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/jar.mn">comparison</a> |
<a href="/comm-central/log/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/jar.mn">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/mac/platformCommunicatorOverlay.xul">suite/common/mac/platformCommunicatorOverlay.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/mac/platformCommunicatorOverlay.xul">file</a> |
<a href="/comm-central/annotate/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/mac/platformCommunicatorOverlay.xul">annotate</a> |
<a href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/mac/platformCommunicatorOverlay.xul">diff</a> |
<a href="/comm-central/comparison/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/mac/platformCommunicatorOverlay.xul">comparison</a> |
<a href="/comm-central/log/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/mac/platformCommunicatorOverlay.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/moz.build">suite/common/moz.build</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/moz.build">file</a> |
<a href="/comm-central/annotate/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/moz.build">annotate</a> |
<a href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/moz.build">diff</a> |
<a href="/comm-central/comparison/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/moz.build">comparison</a> |
<a href="/comm-central/log/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/moz.build">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/PlacesUIUtils.jsm">suite/common/places/PlacesUIUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/PlacesUIUtils.jsm">file</a> |
<a href="/comm-central/annotate/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/PlacesUIUtils.jsm">annotate</a> |
<a href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/PlacesUIUtils.jsm">diff</a> |
<a href="/comm-central/comparison/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/PlacesUIUtils.jsm">comparison</a> |
<a href="/comm-central/log/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/PlacesUIUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/bookmarkProperties.js">suite/common/places/content/bookmarkProperties.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/bookmarkProperties.js">file</a> |
<a href="/comm-central/annotate/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/bookmarkProperties.js">annotate</a> |
<a href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/bookmarkProperties.js">diff</a> |
<a href="/comm-central/comparison/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/bookmarkProperties.js">comparison</a> |
<a href="/comm-central/log/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/bookmarkProperties.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/bookmarkProperties.xul">suite/common/places/content/bookmarkProperties.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/bookmarkProperties.xul">file</a> |
<a href="/comm-central/annotate/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/bookmarkProperties.xul">annotate</a> |
<a href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/bookmarkProperties.xul">diff</a> |
<a href="/comm-central/comparison/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/bookmarkProperties.xul">comparison</a> |
<a href="/comm-central/log/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/bookmarkProperties.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/bookmarksPanel.js">suite/common/places/content/bookmarksPanel.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/bookmarksPanel.js">file</a> |
<a href="/comm-central/annotate/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/bookmarksPanel.js">annotate</a> |
<a href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/bookmarksPanel.js">diff</a> |
<a href="/comm-central/comparison/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/bookmarksPanel.js">comparison</a> |
<a href="/comm-central/log/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/bookmarksPanel.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/bookmarksPanel.xul">suite/common/places/content/bookmarksPanel.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/bookmarksPanel.xul">file</a> |
<a href="/comm-central/annotate/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/bookmarksPanel.xul">annotate</a> |
<a href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/bookmarksPanel.xul">diff</a> |
<a href="/comm-central/comparison/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/bookmarksPanel.xul">comparison</a> |
<a href="/comm-central/log/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/bookmarksPanel.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/browserPlacesViews.js">suite/common/places/content/browserPlacesViews.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/browserPlacesViews.js">file</a> |
<a href="/comm-central/annotate/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/browserPlacesViews.js">annotate</a> |
<a href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/browserPlacesViews.js">diff</a> |
<a href="/comm-central/comparison/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/browserPlacesViews.js">comparison</a> |
<a href="/comm-central/log/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/browserPlacesViews.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/controller.js">suite/common/places/content/controller.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/controller.js">file</a> |
<a href="/comm-central/annotate/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/controller.js">annotate</a> |
<a href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/controller.js">diff</a> |
<a href="/comm-central/comparison/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/controller.js">comparison</a> |
<a href="/comm-central/log/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/controller.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/editBookmarkOverlay.js">suite/common/places/content/editBookmarkOverlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/editBookmarkOverlay.js">file</a> |
<a href="/comm-central/annotate/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/editBookmarkOverlay.js">annotate</a> |
<a href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/editBookmarkOverlay.js">diff</a> |
<a href="/comm-central/comparison/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/editBookmarkOverlay.js">comparison</a> |
<a href="/comm-central/log/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/editBookmarkOverlay.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/editBookmarkOverlay.xul">suite/common/places/content/editBookmarkOverlay.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/editBookmarkOverlay.xul">file</a> |
<a href="/comm-central/annotate/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/editBookmarkOverlay.xul">annotate</a> |
<a href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/editBookmarkOverlay.xul">diff</a> |
<a href="/comm-central/comparison/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/editBookmarkOverlay.xul">comparison</a> |
<a href="/comm-central/log/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/editBookmarkOverlay.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/history-panel.js">suite/common/places/content/history-panel.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/history-panel.js">file</a> |
<a href="/comm-central/annotate/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/history-panel.js">annotate</a> |
<a href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/history-panel.js">diff</a> |
<a href="/comm-central/comparison/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/history-panel.js">comparison</a> |
<a href="/comm-central/log/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/history-panel.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/history-panel.xul">suite/common/places/content/history-panel.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/history-panel.xul">file</a> |
<a href="/comm-central/annotate/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/history-panel.xul">annotate</a> |
<a href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/history-panel.xul">diff</a> |
<a href="/comm-central/comparison/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/history-panel.xul">comparison</a> |
<a href="/comm-central/log/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/history-panel.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/menu.xml">suite/common/places/content/menu.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/menu.xml">file</a> |
<a href="/comm-central/annotate/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/menu.xml">annotate</a> |
<a href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/menu.xml">diff</a> |
<a href="/comm-central/comparison/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/menu.xml">comparison</a> |
<a href="/comm-central/log/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/menu.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/moveBookmarks.js">suite/common/places/content/moveBookmarks.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/moveBookmarks.js">diff</a> |
<a href="/comm-central/comparison/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/moveBookmarks.js">comparison</a> |
<a href="/comm-central/log/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/moveBookmarks.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/moveBookmarks.xul">suite/common/places/content/moveBookmarks.xul</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/moveBookmarks.xul">diff</a> |
<a href="/comm-central/comparison/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/moveBookmarks.xul">comparison</a> |
<a href="/comm-central/log/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/moveBookmarks.xul">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/organizer.css">suite/common/places/content/organizer.css</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/organizer.css">file</a> |
<a href="/comm-central/annotate/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/organizer.css">annotate</a> |
<a href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/organizer.css">diff</a> |
<a href="/comm-central/comparison/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/organizer.css">comparison</a> |
<a href="/comm-central/log/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/organizer.css">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/places.css">suite/common/places/content/places.css</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/places.css">file</a> |
<a href="/comm-central/annotate/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/places.css">annotate</a> |
<a href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/places.css">diff</a> |
<a href="/comm-central/comparison/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/places.css">comparison</a> |
<a href="/comm-central/log/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/places.css">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/places.js">suite/common/places/content/places.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/places.js">file</a> |
<a href="/comm-central/annotate/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/places.js">annotate</a> |
<a href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/places.js">diff</a> |
<a href="/comm-central/comparison/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/places.js">comparison</a> |
<a href="/comm-central/log/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/places.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/places.xul">suite/common/places/content/places.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/places.xul">file</a> |
<a href="/comm-central/annotate/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/places.xul">annotate</a> |
<a href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/places.xul">diff</a> |
<a href="/comm-central/comparison/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/places.xul">comparison</a> |
<a href="/comm-central/log/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/places.xul">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/placesOverlay.xul">suite/common/places/content/placesOverlay.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/placesOverlay.xul">file</a> |
<a href="/comm-central/annotate/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/placesOverlay.xul">annotate</a> |
<a href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/placesOverlay.xul">diff</a> |
<a href="/comm-central/comparison/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/placesOverlay.xul">comparison</a> |
<a href="/comm-central/log/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/placesOverlay.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/sidebarUtils.js">suite/common/places/content/sidebarUtils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/sidebarUtils.js">file</a> |
<a href="/comm-central/annotate/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/sidebarUtils.js">annotate</a> |
<a href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/sidebarUtils.js">diff</a> |
<a href="/comm-central/comparison/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/sidebarUtils.js">comparison</a> |
<a href="/comm-central/log/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/sidebarUtils.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/tree.xml">suite/common/places/content/tree.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/tree.xml">file</a> |
<a href="/comm-central/annotate/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/tree.xml">annotate</a> |
<a href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/tree.xml">diff</a> |
<a href="/comm-central/comparison/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/tree.xml">comparison</a> |
<a href="/comm-central/log/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/tree.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/treeView.js">suite/common/places/content/treeView.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/treeView.js">file</a> |
<a href="/comm-central/annotate/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/treeView.js">annotate</a> |
<a href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/treeView.js">diff</a> |
<a href="/comm-central/comparison/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/treeView.js">comparison</a> |
<a href="/comm-central/log/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/content/treeView.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/jar.mn">suite/common/places/jar.mn</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/jar.mn">file</a> |
<a href="/comm-central/annotate/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/jar.mn">annotate</a> |
<a href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/jar.mn">diff</a> |
<a href="/comm-central/comparison/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/jar.mn">comparison</a> |
<a href="/comm-central/log/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/jar.mn">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/moz.build">suite/common/places/moz.build</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/moz.build">file</a> |
<a href="/comm-central/annotate/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/moz.build">annotate</a> |
<a href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/moz.build">diff</a> |
<a href="/comm-central/comparison/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/moz.build">comparison</a> |
<a href="/comm-central/log/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/places/moz.build">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/sidebar/sidebarOverlay.xul">suite/common/sidebar/sidebarOverlay.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/sidebar/sidebarOverlay.xul">file</a> |
<a href="/comm-central/annotate/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/sidebar/sidebarOverlay.xul">annotate</a> |
<a href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/sidebar/sidebarOverlay.xul">diff</a> |
<a href="/comm-central/comparison/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/sidebar/sidebarOverlay.xul">comparison</a> |
<a href="/comm-central/log/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/sidebar/sidebarOverlay.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/tasksOverlay.js">suite/common/tasksOverlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/tasksOverlay.js">file</a> |
<a href="/comm-central/annotate/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/tasksOverlay.js">annotate</a> |
<a href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/tasksOverlay.js">diff</a> |
<a href="/comm-central/comparison/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/tasksOverlay.js">comparison</a> |
<a href="/comm-central/log/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/tasksOverlay.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/utilityOverlay.js">suite/common/utilityOverlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/utilityOverlay.js">file</a> |
<a href="/comm-central/annotate/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/utilityOverlay.js">annotate</a> |
<a href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/utilityOverlay.js">diff</a> |
<a href="/comm-central/comparison/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/utilityOverlay.js">comparison</a> |
<a href="/comm-central/log/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/common/utilityOverlay.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/installer/allowed-dupes.mn">suite/installer/allowed-dupes.mn</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/installer/allowed-dupes.mn">file</a> |
<a href="/comm-central/annotate/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/installer/allowed-dupes.mn">annotate</a> |
<a href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/installer/allowed-dupes.mn">diff</a> |
<a href="/comm-central/comparison/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/installer/allowed-dupes.mn">comparison</a> |
<a href="/comm-central/log/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/installer/allowed-dupes.mn">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/locales/en-US/chrome/browser/navigator.dtd">suite/locales/en-US/chrome/browser/navigator.dtd</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/locales/en-US/chrome/browser/navigator.dtd">file</a> |
<a href="/comm-central/annotate/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/locales/en-US/chrome/browser/navigator.dtd">annotate</a> |
<a href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/locales/en-US/chrome/browser/navigator.dtd">diff</a> |
<a href="/comm-central/comparison/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/locales/en-US/chrome/browser/navigator.dtd">comparison</a> |
<a href="/comm-central/log/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/locales/en-US/chrome/browser/navigator.dtd">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/locales/en-US/chrome/common/help/cs_nav_prefs_appearance.xhtml">suite/locales/en-US/chrome/common/help/cs_nav_prefs_appearance.xhtml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/locales/en-US/chrome/common/help/cs_nav_prefs_appearance.xhtml">file</a> |
<a href="/comm-central/annotate/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/locales/en-US/chrome/common/help/cs_nav_prefs_appearance.xhtml">annotate</a> |
<a href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/locales/en-US/chrome/common/help/cs_nav_prefs_appearance.xhtml">diff</a> |
<a href="/comm-central/comparison/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/locales/en-US/chrome/common/help/cs_nav_prefs_appearance.xhtml">comparison</a> |
<a href="/comm-central/log/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/locales/en-US/chrome/common/help/cs_nav_prefs_appearance.xhtml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/locales/en-US/chrome/common/help/customize_help.xhtml">suite/locales/en-US/chrome/common/help/customize_help.xhtml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/locales/en-US/chrome/common/help/customize_help.xhtml">file</a> |
<a href="/comm-central/annotate/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/locales/en-US/chrome/common/help/customize_help.xhtml">annotate</a> |
<a href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/locales/en-US/chrome/common/help/customize_help.xhtml">diff</a> |
<a href="/comm-central/comparison/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/locales/en-US/chrome/common/help/customize_help.xhtml">comparison</a> |
<a href="/comm-central/log/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/locales/en-US/chrome/common/help/customize_help.xhtml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/locales/en-US/chrome/common/places/bookmarkProperties.properties">suite/locales/en-US/chrome/common/places/bookmarkProperties.properties</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/locales/en-US/chrome/common/places/bookmarkProperties.properties">file</a> |
<a href="/comm-central/annotate/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/locales/en-US/chrome/common/places/bookmarkProperties.properties">annotate</a> |
<a href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/locales/en-US/chrome/common/places/bookmarkProperties.properties">diff</a> |
<a href="/comm-central/comparison/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/locales/en-US/chrome/common/places/bookmarkProperties.properties">comparison</a> |
<a href="/comm-central/log/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/locales/en-US/chrome/common/places/bookmarkProperties.properties">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/locales/en-US/chrome/common/places/editBookmarkOverlay.dtd">suite/locales/en-US/chrome/common/places/editBookmarkOverlay.dtd</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/locales/en-US/chrome/common/places/editBookmarkOverlay.dtd">file</a> |
<a href="/comm-central/annotate/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/locales/en-US/chrome/common/places/editBookmarkOverlay.dtd">annotate</a> |
<a href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/locales/en-US/chrome/common/places/editBookmarkOverlay.dtd">diff</a> |
<a href="/comm-central/comparison/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/locales/en-US/chrome/common/places/editBookmarkOverlay.dtd">comparison</a> |
<a href="/comm-central/log/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/locales/en-US/chrome/common/places/editBookmarkOverlay.dtd">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/locales/en-US/chrome/common/places/moveBookmarks.dtd">suite/locales/en-US/chrome/common/places/moveBookmarks.dtd</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/locales/en-US/chrome/common/places/moveBookmarks.dtd">diff</a> |
<a href="/comm-central/comparison/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/locales/en-US/chrome/common/places/moveBookmarks.dtd">comparison</a> |
<a href="/comm-central/log/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/locales/en-US/chrome/common/places/moveBookmarks.dtd">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/locales/en-US/chrome/common/places/places.dtd">suite/locales/en-US/chrome/common/places/places.dtd</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/locales/en-US/chrome/common/places/places.dtd">file</a> |
<a href="/comm-central/annotate/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/locales/en-US/chrome/common/places/places.dtd">annotate</a> |
<a href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/locales/en-US/chrome/common/places/places.dtd">diff</a> |
<a href="/comm-central/comparison/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/locales/en-US/chrome/common/places/places.dtd">comparison</a> |
<a href="/comm-central/log/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/locales/en-US/chrome/common/places/places.dtd">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/locales/en-US/chrome/common/places/places.properties">suite/locales/en-US/chrome/common/places/places.properties</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/locales/en-US/chrome/common/places/places.properties">file</a> |
<a href="/comm-central/annotate/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/locales/en-US/chrome/common/places/places.properties">annotate</a> |
<a href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/locales/en-US/chrome/common/places/places.properties">diff</a> |
<a href="/comm-central/comparison/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/locales/en-US/chrome/common/places/places.properties">comparison</a> |
<a href="/comm-central/log/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/locales/en-US/chrome/common/places/places.properties">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/locales/jar.mn">suite/locales/jar.mn</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/locales/jar.mn">file</a> |
<a href="/comm-central/annotate/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/locales/jar.mn">annotate</a> |
<a href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/locales/jar.mn">diff</a> |
<a href="/comm-central/comparison/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/locales/jar.mn">comparison</a> |
<a href="/comm-central/log/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/locales/jar.mn">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/modules/moz.build">suite/modules/moz.build</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/modules/moz.build">file</a> |
<a href="/comm-central/annotate/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/modules/moz.build">annotate</a> |
<a href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/modules/moz.build">diff</a> |
<a href="/comm-central/comparison/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/modules/moz.build">comparison</a> |
<a href="/comm-central/log/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/modules/moz.build">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/classic/communicator/aboutSessionRestore.css">suite/themes/classic/communicator/aboutSessionRestore.css</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/classic/communicator/aboutSessionRestore.css">file</a> |
<a href="/comm-central/annotate/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/classic/communicator/aboutSessionRestore.css">annotate</a> |
<a href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/classic/communicator/aboutSessionRestore.css">diff</a> |
<a href="/comm-central/comparison/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/classic/communicator/aboutSessionRestore.css">comparison</a> |
<a href="/comm-central/log/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/classic/communicator/aboutSessionRestore.css">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/classic/communicator/communicator.css">suite/themes/classic/communicator/communicator.css</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/classic/communicator/communicator.css">file</a> |
<a href="/comm-central/annotate/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/classic/communicator/communicator.css">annotate</a> |
<a href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/classic/communicator/communicator.css">diff</a> |
<a href="/comm-central/comparison/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/classic/communicator/communicator.css">comparison</a> |
<a href="/comm-central/log/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/classic/communicator/communicator.css">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/classic/communicator/places/bookmarks.css">suite/themes/classic/communicator/places/bookmarks.css</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/classic/communicator/places/bookmarks.css">file</a> |
<a href="/comm-central/annotate/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/classic/communicator/places/bookmarks.css">annotate</a> |
<a href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/classic/communicator/places/bookmarks.css">diff</a> |
<a href="/comm-central/comparison/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/classic/communicator/places/bookmarks.css">comparison</a> |
<a href="/comm-central/log/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/classic/communicator/places/bookmarks.css">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/classic/communicator/places/bookmarksToolbar.css">suite/themes/classic/communicator/places/bookmarksToolbar.css</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/classic/communicator/places/bookmarksToolbar.css">file</a> |
<a href="/comm-central/annotate/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/classic/communicator/places/bookmarksToolbar.css">annotate</a> |
<a href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/classic/communicator/places/bookmarksToolbar.css">diff</a> |
<a href="/comm-central/comparison/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/classic/communicator/places/bookmarksToolbar.css">comparison</a> |
<a href="/comm-central/log/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/classic/communicator/places/bookmarksToolbar.css">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/classic/communicator/places/editBookmarkOverlay.css">suite/themes/classic/communicator/places/editBookmarkOverlay.css</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/classic/communicator/places/editBookmarkOverlay.css">file</a> |
<a href="/comm-central/annotate/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/classic/communicator/places/editBookmarkOverlay.css">annotate</a> |
<a href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/classic/communicator/places/editBookmarkOverlay.css">diff</a> |
<a href="/comm-central/comparison/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/classic/communicator/places/editBookmarkOverlay.css">comparison</a> |
<a href="/comm-central/log/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/classic/communicator/places/editBookmarkOverlay.css">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/classic/communicator/places/history.png">suite/themes/classic/communicator/places/history.png</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/classic/communicator/places/history.png">file</a> |
<a href="/comm-central/annotate/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/classic/communicator/places/history.png">annotate</a> |
<a href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/classic/communicator/places/history.png">diff</a> |
<a href="/comm-central/comparison/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/classic/communicator/places/history.png">comparison</a> |
<a href="/comm-central/log/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/classic/communicator/places/history.png">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/classic/communicator/places/organizer.css">suite/themes/classic/communicator/places/organizer.css</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/classic/communicator/places/organizer.css">file</a> |
<a href="/comm-central/annotate/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/classic/communicator/places/organizer.css">annotate</a> |
<a href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/classic/communicator/places/organizer.css">diff</a> |
<a href="/comm-central/comparison/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/classic/communicator/places/organizer.css">comparison</a> |
<a href="/comm-central/log/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/classic/communicator/places/organizer.css">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/classic/communicator/sidebar/customize.css">suite/themes/classic/communicator/sidebar/customize.css</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/classic/communicator/sidebar/customize.css">file</a> |
<a href="/comm-central/annotate/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/classic/communicator/sidebar/customize.css">annotate</a> |
<a href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/classic/communicator/sidebar/customize.css">diff</a> |
<a href="/comm-central/comparison/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/classic/communicator/sidebar/customize.css">comparison</a> |
<a href="/comm-central/log/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/classic/communicator/sidebar/customize.css">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/classic/jar.mn">suite/themes/classic/jar.mn</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/classic/jar.mn">file</a> |
<a href="/comm-central/annotate/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/classic/jar.mn">annotate</a> |
<a href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/classic/jar.mn">diff</a> |
<a href="/comm-central/comparison/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/classic/jar.mn">comparison</a> |
<a href="/comm-central/log/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/classic/jar.mn">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/classic/mac/communicator/aboutSessionRestore.css">suite/themes/classic/mac/communicator/aboutSessionRestore.css</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/classic/mac/communicator/aboutSessionRestore.css">file</a> |
<a href="/comm-central/annotate/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/classic/mac/communicator/aboutSessionRestore.css">annotate</a> |
<a href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/classic/mac/communicator/aboutSessionRestore.css">diff</a> |
<a href="/comm-central/comparison/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/classic/mac/communicator/aboutSessionRestore.css">comparison</a> |
<a href="/comm-central/log/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/classic/mac/communicator/aboutSessionRestore.css">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/classic/mac/communicator/places/bookmarks.css">suite/themes/classic/mac/communicator/places/bookmarks.css</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/classic/mac/communicator/places/bookmarks.css">file</a> |
<a href="/comm-central/annotate/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/classic/mac/communicator/places/bookmarks.css">annotate</a> |
<a href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/classic/mac/communicator/places/bookmarks.css">diff</a> |
<a href="/comm-central/comparison/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/classic/mac/communicator/places/bookmarks.css">comparison</a> |
<a href="/comm-central/log/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/classic/mac/communicator/places/bookmarks.css">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/classic/mac/communicator/places/bookmarksToolbar.css">suite/themes/classic/mac/communicator/places/bookmarksToolbar.css</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/classic/mac/communicator/places/bookmarksToolbar.css">file</a> |
<a href="/comm-central/annotate/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/classic/mac/communicator/places/bookmarksToolbar.css">annotate</a> |
<a href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/classic/mac/communicator/places/bookmarksToolbar.css">diff</a> |
<a href="/comm-central/comparison/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/classic/mac/communicator/places/bookmarksToolbar.css">comparison</a> |
<a href="/comm-central/log/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/classic/mac/communicator/places/bookmarksToolbar.css">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/classic/mac/communicator/places/editBookmarkOverlay.css">suite/themes/classic/mac/communicator/places/editBookmarkOverlay.css</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/classic/mac/communicator/places/editBookmarkOverlay.css">file</a> |
<a href="/comm-central/annotate/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/classic/mac/communicator/places/editBookmarkOverlay.css">annotate</a> |
<a href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/classic/mac/communicator/places/editBookmarkOverlay.css">diff</a> |
<a href="/comm-central/comparison/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/classic/mac/communicator/places/editBookmarkOverlay.css">comparison</a> |
<a href="/comm-central/log/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/classic/mac/communicator/places/editBookmarkOverlay.css">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/classic/mac/navigator/navigator.css">suite/themes/classic/mac/navigator/navigator.css</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/classic/mac/navigator/navigator.css">file</a> |
<a href="/comm-central/annotate/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/classic/mac/navigator/navigator.css">annotate</a> |
<a href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/classic/mac/navigator/navigator.css">diff</a> |
<a href="/comm-central/comparison/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/classic/mac/navigator/navigator.css">comparison</a> |
<a href="/comm-central/log/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/classic/mac/navigator/navigator.css">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/classic/mac/navigator/tabbrowser.css">suite/themes/classic/mac/navigator/tabbrowser.css</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/classic/mac/navigator/tabbrowser.css">file</a> |
<a href="/comm-central/annotate/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/classic/mac/navigator/tabbrowser.css">annotate</a> |
<a href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/classic/mac/navigator/tabbrowser.css">diff</a> |
<a href="/comm-central/comparison/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/classic/mac/navigator/tabbrowser.css">comparison</a> |
<a href="/comm-central/log/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/classic/mac/navigator/tabbrowser.css">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/classic/navigator/navigator.css">suite/themes/classic/navigator/navigator.css</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/classic/navigator/navigator.css">file</a> |
<a href="/comm-central/annotate/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/classic/navigator/navigator.css">annotate</a> |
<a href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/classic/navigator/navigator.css">diff</a> |
<a href="/comm-central/comparison/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/classic/navigator/navigator.css">comparison</a> |
<a href="/comm-central/log/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/classic/navigator/navigator.css">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/classic/navigator/tabbrowser.css">suite/themes/classic/navigator/tabbrowser.css</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/classic/navigator/tabbrowser.css">file</a> |
<a href="/comm-central/annotate/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/classic/navigator/tabbrowser.css">annotate</a> |
<a href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/classic/navigator/tabbrowser.css">diff</a> |
<a href="/comm-central/comparison/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/classic/navigator/tabbrowser.css">comparison</a> |
<a href="/comm-central/log/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/classic/navigator/tabbrowser.css">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/modern/communicator/aboutSessionRestore.css">suite/themes/modern/communicator/aboutSessionRestore.css</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/modern/communicator/aboutSessionRestore.css">file</a> |
<a href="/comm-central/annotate/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/modern/communicator/aboutSessionRestore.css">annotate</a> |
<a href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/modern/communicator/aboutSessionRestore.css">diff</a> |
<a href="/comm-central/comparison/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/modern/communicator/aboutSessionRestore.css">comparison</a> |
<a href="/comm-central/log/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/modern/communicator/aboutSessionRestore.css">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/modern/communicator/communicator.css">suite/themes/modern/communicator/communicator.css</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/modern/communicator/communicator.css">file</a> |
<a href="/comm-central/annotate/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/modern/communicator/communicator.css">annotate</a> |
<a href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/modern/communicator/communicator.css">diff</a> |
<a href="/comm-central/comparison/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/modern/communicator/communicator.css">comparison</a> |
<a href="/comm-central/log/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/modern/communicator/communicator.css">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/modern/communicator/places/bookmarks.css">suite/themes/modern/communicator/places/bookmarks.css</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/modern/communicator/places/bookmarks.css">file</a> |
<a href="/comm-central/annotate/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/modern/communicator/places/bookmarks.css">annotate</a> |
<a href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/modern/communicator/places/bookmarks.css">diff</a> |
<a href="/comm-central/comparison/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/modern/communicator/places/bookmarks.css">comparison</a> |
<a href="/comm-central/log/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/modern/communicator/places/bookmarks.css">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/modern/communicator/places/bookmarksToolbar.css">suite/themes/modern/communicator/places/bookmarksToolbar.css</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/modern/communicator/places/bookmarksToolbar.css">file</a> |
<a href="/comm-central/annotate/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/modern/communicator/places/bookmarksToolbar.css">annotate</a> |
<a href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/modern/communicator/places/bookmarksToolbar.css">diff</a> |
<a href="/comm-central/comparison/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/modern/communicator/places/bookmarksToolbar.css">comparison</a> |
<a href="/comm-central/log/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/modern/communicator/places/bookmarksToolbar.css">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/modern/communicator/places/editBookmarkOverlay.css">suite/themes/modern/communicator/places/editBookmarkOverlay.css</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/modern/communicator/places/editBookmarkOverlay.css">file</a> |
<a href="/comm-central/annotate/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/modern/communicator/places/editBookmarkOverlay.css">annotate</a> |
<a href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/modern/communicator/places/editBookmarkOverlay.css">diff</a> |
<a href="/comm-central/comparison/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/modern/communicator/places/editBookmarkOverlay.css">comparison</a> |
<a href="/comm-central/log/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/modern/communicator/places/editBookmarkOverlay.css">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/modern/communicator/places/history.png">suite/themes/modern/communicator/places/history.png</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/modern/communicator/places/history.png">file</a> |
<a href="/comm-central/annotate/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/modern/communicator/places/history.png">annotate</a> |
<a href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/modern/communicator/places/history.png">diff</a> |
<a href="/comm-central/comparison/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/modern/communicator/places/history.png">comparison</a> |
<a href="/comm-central/log/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/modern/communicator/places/history.png">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/modern/global/dirListing/dirListing.css">suite/themes/modern/global/dirListing/dirListing.css</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/modern/global/dirListing/dirListing.css">file</a> |
<a href="/comm-central/annotate/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/modern/global/dirListing/dirListing.css">annotate</a> |
<a href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/modern/global/dirListing/dirListing.css">diff</a> |
<a href="/comm-central/comparison/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/modern/global/dirListing/dirListing.css">comparison</a> |
<a href="/comm-central/log/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/modern/global/dirListing/dirListing.css">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/modern/jar.mn">suite/themes/modern/jar.mn</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/modern/jar.mn">file</a> |
<a href="/comm-central/annotate/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/modern/jar.mn">annotate</a> |
<a href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/modern/jar.mn">diff</a> |
<a href="/comm-central/comparison/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/modern/jar.mn">comparison</a> |
<a href="/comm-central/log/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/modern/jar.mn">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/modern/navigator/navigator.css">suite/themes/modern/navigator/navigator.css</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/modern/navigator/navigator.css">file</a> |
<a href="/comm-central/annotate/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/modern/navigator/navigator.css">annotate</a> |
<a href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/modern/navigator/navigator.css">diff</a> |
<a href="/comm-central/comparison/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/modern/navigator/navigator.css">comparison</a> |
<a href="/comm-central/log/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/modern/navigator/navigator.css">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/modern/navigator/tabbrowser.css">suite/themes/modern/navigator/tabbrowser.css</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/modern/navigator/tabbrowser.css">file</a> |
<a href="/comm-central/annotate/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/modern/navigator/tabbrowser.css">annotate</a> |
<a href="/comm-central/diff/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/modern/navigator/tabbrowser.css">diff</a> |
<a href="/comm-central/comparison/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/modern/navigator/tabbrowser.css">comparison</a> |
<a href="/comm-central/log/f000c3a844b1fe4741b8933fccad8832dba85a7a/suite/themes/modern/navigator/tabbrowser.css">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1">new file mode 100644</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineminus">--- /dev/null</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineplus">+++ b/suite/FIXME-PLACES.TXT</span>
<a href="#l1.4"></a><span id="l1.4" class="difflineat">@@ -0,0 +1,5 @@</span>
<a href="#l1.5"></a><span id="l1.5" class="difflineplus">+Load in sidebar disabled because of:</span>
<a href="#l1.6"></a><span id="l1.6" class="difflineplus">+Timestamp: 1/29/2018, 9:56:54 PM</span>
<a href="#l1.7"></a><span id="l1.7" class="difflineplus">+Error: TypeError: browserWin.openWebPanel is not a function</span>
<a href="#l1.8"></a><span id="l1.8" class="difflineplus">+Source File: resource:///modules/PlacesUIUtils.jsm</span>
<a href="#l1.9"></a><span id="l1.9" class="difflineplus">+Line: 1053</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/suite/browser/browser-places.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/suite/browser/browser-places.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -1,12 +1,18 @@</span>
<a href="#l2.4"></a><span id="l2.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l2.5"></a><span id="l2.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l2.6"></a><span id="l2.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l2.7"></a><span id="l2.7"> </span>
<a href="#l2.8"></a><span id="l2.8" class="difflineplus">+ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l2.9"></a><span id="l2.9" class="difflineplus">+</span>
<a href="#l2.10"></a><span id="l2.10" class="difflineplus">+XPCOMUtils.defineLazyScriptGetter(this, [&quot;PlacesToolbar&quot;, &quot;PlacesMenu&quot;,</span>
<a href="#l2.11"></a><span id="l2.11" class="difflineplus">+                                         &quot;PlacesPanelview&quot;, &quot;PlacesPanelMenuView&quot;],</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+                                  &quot;chrome://communicator/content/places/browserPlacesViews.js&quot;);</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+</span>
<a href="#l2.14"></a><span id="l2.14"> var StarUI = {</span>
<a href="#l2.15"></a><span id="l2.15">   _itemGuids: -1,</span>
<a href="#l2.16"></a><span id="l2.16">   uri: null,</span>
<a href="#l2.17"></a><span id="l2.17">   _batching: false,</span>
<a href="#l2.18"></a><span id="l2.18"> </span>
<a href="#l2.19"></a><span id="l2.19">   _element: function(aID) {</span>
<a href="#l2.20"></a><span id="l2.20">     return document.getElementById(aID);</span>
<a href="#l2.21"></a><span id="l2.21">   },</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineat">@@ -15,16 +21,25 @@ var StarUI = {</span>
<a href="#l2.23"></a><span id="l2.23">   get panel() {</span>
<a href="#l2.24"></a><span id="l2.24">     delete this.panel;</span>
<a href="#l2.25"></a><span id="l2.25">     var element = this._element(&quot;editBookmarkPanel&quot;);</span>
<a href="#l2.26"></a><span id="l2.26">     // initially the panel is hidden</span>
<a href="#l2.27"></a><span id="l2.27">     // to avoid impacting startup / new window performance</span>
<a href="#l2.28"></a><span id="l2.28">     element.hidden = false;</span>
<a href="#l2.29"></a><span id="l2.29">     element.addEventListener(&quot;popuphidden&quot;, this);</span>
<a href="#l2.30"></a><span id="l2.30">     element.addEventListener(&quot;keypress&quot;, this);</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineplus">+    element.addEventListener(&quot;keypress&quot;, this);</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineplus">+    element.addEventListener(&quot;mousedown&quot;, this);</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineplus">+    element.addEventListener(&quot;mouseout&quot;, this);</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineplus">+    element.addEventListener(&quot;mousemove&quot;, this);</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineplus">+    element.addEventListener(&quot;compositionstart&quot;, this);</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineplus">+    element.addEventListener(&quot;compositionend&quot;, this);</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineplus">+    element.addEventListener(&quot;input&quot;, this);</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineplus">+    element.addEventListener(&quot;popuphidden&quot;, this);</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineplus">+    element.addEventListener(&quot;popupshown&quot;, this);</span>
<a href="#l2.40"></a><span id="l2.40">     return this.panel = element;</span>
<a href="#l2.41"></a><span id="l2.41">   },</span>
<a href="#l2.42"></a><span id="l2.42"> </span>
<a href="#l2.43"></a><span id="l2.43">   // Array of command elements to disable when the panel is opened.</span>
<a href="#l2.44"></a><span id="l2.44">   get _blockedCommands() {</span>
<a href="#l2.45"></a><span id="l2.45">     delete this._blockedCommands;</span>
<a href="#l2.46"></a><span id="l2.46">     return this._blockedCommands =</span>
<a href="#l2.47"></a><span id="l2.47">       [&quot;cmd_close&quot;, &quot;cmd_closeWindow&quot;].map(id =&gt; this._element(id));</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineat">@@ -111,87 +126,110 @@ var StarUI = {</span>
<a href="#l2.49"></a><span id="l2.49">             break;</span>
<a href="#l2.50"></a><span id="l2.50">         }</span>
<a href="#l2.51"></a><span id="l2.51">         break;</span>
<a href="#l2.52"></a><span id="l2.52">     }</span>
<a href="#l2.53"></a><span id="l2.53">   },</span>
<a href="#l2.54"></a><span id="l2.54"> </span>
<a href="#l2.55"></a><span id="l2.55">   _overlayLoaded: false,</span>
<a href="#l2.56"></a><span id="l2.56">   _overlayLoading: false,</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineminus">-  showEditBookmarkPopup:</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineminus">-  function SU_showEditBookmarkPopup(aItemId, aAnchorElement, aPosition) {</span>
<a href="#l2.59"></a><span id="l2.59" class="difflineplus">+  async showEditBookmarkPopup(aNode, aAnchorElement, aPosition, aIsNewBookmark) {</span>
<a href="#l2.60"></a><span id="l2.60" class="difflineplus">+    // Slow double-clicks (not true double-clicks) shouldn't</span>
<a href="#l2.61"></a><span id="l2.61" class="difflineplus">+    // cause the panel to flicker.</span>
<a href="#l2.62"></a><span id="l2.62" class="difflineplus">+    if (this.panel.state == &quot;showing&quot; ||</span>
<a href="#l2.63"></a><span id="l2.63" class="difflineplus">+        this.panel.state == &quot;open&quot;) {</span>
<a href="#l2.64"></a><span id="l2.64" class="difflineplus">+      return;</span>
<a href="#l2.65"></a><span id="l2.65" class="difflineplus">+    }</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineplus">+</span>
<a href="#l2.67"></a><span id="l2.67" class="difflineplus">+    this._isNewBookmark = aIsNewBookmark;</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineplus">+    this._uriForRemoval = &quot;&quot;;</span>
<a href="#l2.69"></a><span id="l2.69" class="difflineplus">+    // TODO (bug 1131491): Deprecate this once async transactions are enabled</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineplus">+    // and the legacy transactions code is gone.</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineplus">+    if (typeof(aNode) == &quot;number&quot;) {</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineplus">+      let itemId = aNode;</span>
<a href="#l2.73"></a><span id="l2.73" class="difflineplus">+      let guid = await PlacesUtils.promiseItemGuid(itemId);</span>
<a href="#l2.74"></a><span id="l2.74" class="difflineplus">+      aNode = await PlacesUIUtils.fetchNodeLike(guid);</span>
<a href="#l2.75"></a><span id="l2.75" class="difflineplus">+    }</span>
<a href="#l2.76"></a><span id="l2.76" class="difflineplus">+</span>
<a href="#l2.77"></a><span id="l2.77">     // Performance: load the overlay the first time the panel is opened</span>
<a href="#l2.78"></a><span id="l2.78">     // (see bug 392443).</span>
<a href="#l2.79"></a><span id="l2.79">     if (this._overlayLoading)</span>
<a href="#l2.80"></a><span id="l2.80">       return;</span>
<a href="#l2.81"></a><span id="l2.81"> </span>
<a href="#l2.82"></a><span id="l2.82">     if (this._overlayLoaded) {</span>
<a href="#l2.83"></a><span id="l2.83" class="difflineminus">-      this._doShowEditBookmarkPanel(aItemId, aAnchorElement, aPosition);</span>
<a href="#l2.84"></a><span id="l2.84" class="difflineplus">+      this._doShowEditBookmarkPanel(aNode, aAnchorElement, aPosition);</span>
<a href="#l2.85"></a><span id="l2.85">       return;</span>
<a href="#l2.86"></a><span id="l2.86">     }</span>
<a href="#l2.87"></a><span id="l2.87"> </span>
<a href="#l2.88"></a><span id="l2.88">     this._overlayLoading = true;</span>
<a href="#l2.89"></a><span id="l2.89">     document.loadOverlay(</span>
<a href="#l2.90"></a><span id="l2.90" class="difflineminus">-      &quot;chrome://communicator/content/bookmarks/editBookmarkOverlay.xul&quot;,</span>
<a href="#l2.91"></a><span id="l2.91" class="difflineminus">-      (function (aSubject, aTopic, aData) {</span>
<a href="#l2.92"></a><span id="l2.92" class="difflineplus">+      &quot;chrome://communicator/content/places/editBookmarkOverlay.xul&quot;,</span>
<a href="#l2.93"></a><span id="l2.93" class="difflineplus">+      (aSubject, aTopic, aData) =&gt; {</span>
<a href="#l2.94"></a><span id="l2.94">         // Move the header (star, title, button) into the grid,</span>
<a href="#l2.95"></a><span id="l2.95">         // so that it aligns nicely with the other items (bug 484022).</span>
<a href="#l2.96"></a><span id="l2.96">         let header = this._element(&quot;editBookmarkPanelHeader&quot;);</span>
<a href="#l2.97"></a><span id="l2.97">         let rows = this._element(&quot;editBookmarkPanelGrid&quot;).lastChild;</span>
<a href="#l2.98"></a><span id="l2.98">         rows.insertBefore(header, rows.firstChild);</span>
<a href="#l2.99"></a><span id="l2.99">         header.hidden = false;</span>
<a href="#l2.100"></a><span id="l2.100"> </span>
<a href="#l2.101"></a><span id="l2.101">         this._overlayLoading = false;</span>
<a href="#l2.102"></a><span id="l2.102">         this._overlayLoaded = true;</span>
<a href="#l2.103"></a><span id="l2.103" class="difflineminus">-        this._doShowEditBookmarkPanel(aItemId, aAnchorElement, aPosition);</span>
<a href="#l2.104"></a><span id="l2.104" class="difflineminus">-      }).bind(this)</span>
<a href="#l2.105"></a><span id="l2.105" class="difflineplus">+        this._doShowEditBookmarkPanel(aNode, aAnchorElement, aPosition);</span>
<a href="#l2.106"></a><span id="l2.106" class="difflineplus">+      }</span>
<a href="#l2.107"></a><span id="l2.107">     );</span>
<a href="#l2.108"></a><span id="l2.108">   },</span>
<a href="#l2.109"></a><span id="l2.109"> </span>
<a href="#l2.110"></a><span id="l2.110">   _doShowEditBookmarkPanel:</span>
<a href="#l2.111"></a><span id="l2.111" class="difflineminus">-  function SU__doShowEditBookmarkPanel(aItemId, aAnchorElement, aPosition) {</span>
<a href="#l2.112"></a><span id="l2.112" class="difflineplus">+  function SU__doShowEditBookmarkPanel(aNode, aAnchorElement, aPosition) {</span>
<a href="#l2.113"></a><span id="l2.113">     if (this.panel.state != &quot;closed&quot;)</span>
<a href="#l2.114"></a><span id="l2.114">       return;</span>
<a href="#l2.115"></a><span id="l2.115"> </span>
<a href="#l2.116"></a><span id="l2.116">     this._blockCommands(); // un-done in the popuphiding handler</span>
<a href="#l2.117"></a><span id="l2.117"> </span>
<a href="#l2.118"></a><span id="l2.118">     // Set panel title:</span>
<a href="#l2.119"></a><span id="l2.119">     // if we are batching, i.e. the bookmark has been added now,</span>
<a href="#l2.120"></a><span id="l2.120">     // then show Page Bookmarked, else if the bookmark did already exist,</span>
<a href="#l2.121"></a><span id="l2.121">     // we are about editing it, then use Edit This Bookmark.</span>
<a href="#l2.122"></a><span id="l2.122">     this._element(&quot;editBookmarkPanelTitle&quot;).value =</span>
<a href="#l2.123"></a><span id="l2.123" class="difflineminus">-      this._batching ?</span>
<a href="#l2.124"></a><span id="l2.124" class="difflineplus">+      this._isNewBookmark ?</span>
<a href="#l2.125"></a><span id="l2.125">         gNavigatorBundle.getString(&quot;editBookmarkPanel.pageBookmarkedTitle&quot;) :</span>
<a href="#l2.126"></a><span id="l2.126">         gNavigatorBundle.getString(&quot;editBookmarkPanel.editBookmarkTitle&quot;);</span>
<a href="#l2.127"></a><span id="l2.127"> </span>
<a href="#l2.128"></a><span id="l2.128">     this._element(&quot;editBookmarkPanelBottomButtons&quot;).hidden = false;</span>
<a href="#l2.129"></a><span id="l2.129">     this._element(&quot;editBookmarkPanelContent&quot;).hidden = false;</span>
<a href="#l2.130"></a><span id="l2.130"> </span>
<a href="#l2.131"></a><span id="l2.131" class="difflineminus">-    // The remove button is shown only if we're not already batching, i.e.</span>
<a href="#l2.132"></a><span id="l2.132" class="difflineminus">-    // if the cancel button/ESC does not remove the bookmark.</span>
<a href="#l2.133"></a><span id="l2.133" class="difflineminus">-    this._element(&quot;editBookmarkPanelRemoveButton&quot;).hidden = this._batching;</span>
<a href="#l2.134"></a><span id="l2.134" class="difflineminus">-</span>
<a href="#l2.135"></a><span id="l2.135">     // The label of the remove button differs if the URI is bookmarked</span>
<a href="#l2.136"></a><span id="l2.136">     // multiple times.</span>
<a href="#l2.137"></a><span id="l2.137" class="difflineminus">-    var bookmarks = PlacesUtils.getBookmarksForURI(gBrowser.currentURI);</span>
<a href="#l2.138"></a><span id="l2.138" class="difflineminus">-    var forms = gNavigatorBundle.getString(&quot;editBookmark.removeBookmarks.label&quot;);</span>
<a href="#l2.139"></a><span id="l2.139" class="difflineminus">-    var label = PluralForm.get(bookmarks.length, forms).replace(&quot;#1&quot;, bookmarks.length);</span>
<a href="#l2.140"></a><span id="l2.140" class="difflineplus">+    let bookmarks = PlacesUtils.getBookmarksForURI(gBrowser.currentURI);</span>
<a href="#l2.141"></a><span id="l2.141" class="difflineplus">+    let forms = gNavigatorBundle.getString(&quot;editBookmark.removeBookmarks.label&quot;);</span>
<a href="#l2.142"></a><span id="l2.142" class="difflineplus">+    let label = PluralForm.get(bookmarks.length, forms).replace(&quot;#1&quot;, bookmarks.length);</span>
<a href="#l2.143"></a><span id="l2.143">     this._element(&quot;editBookmarkPanelRemoveButton&quot;).label = label;</span>
<a href="#l2.144"></a><span id="l2.144"> </span>
<a href="#l2.145"></a><span id="l2.145" class="difflineminus">-    this._itemId = aItemId !== undefined ? aItemId : this._itemId;</span>
<a href="#l2.146"></a><span id="l2.146" class="difflineplus">+    this._itemId = aNode.itemId;</span>
<a href="#l2.147"></a><span id="l2.147">     this.beginBatch();</span>
<a href="#l2.148"></a><span id="l2.148"> </span>
<a href="#l2.149"></a><span id="l2.149" class="difflineminus">-    // Consume dismiss clicks, see bug 400924</span>
<a href="#l2.150"></a><span id="l2.150" class="difflineminus">-    this.panel.popupBoxObject</span>
<a href="#l2.151"></a><span id="l2.151" class="difflineminus">-        .setConsumeRollupEvent(PopupBoxObject.ROLLUP_CONSUME);</span>
<a href="#l2.152"></a><span id="l2.152" class="difflineplus">+    let onPanelReady = fn =&gt; {</span>
<a href="#l2.153"></a><span id="l2.153" class="difflineplus">+      let target = this.panel;</span>
<a href="#l2.154"></a><span id="l2.154" class="difflineplus">+      if (target.parentNode) {</span>
<a href="#l2.155"></a><span id="l2.155" class="difflineplus">+        // By targeting the panel's parent and using a capturing listener, we</span>
<a href="#l2.156"></a><span id="l2.156" class="difflineplus">+        // can have our listener called before others waiting for the panel to</span>
<a href="#l2.157"></a><span id="l2.157" class="difflineplus">+        // be shown (which probably expect the panel to be fully initialized)</span>
<a href="#l2.158"></a><span id="l2.158" class="difflineplus">+        target = target.parentNode;</span>
<a href="#l2.159"></a><span id="l2.159" class="difflineplus">+      }</span>
<a href="#l2.160"></a><span id="l2.160" class="difflineplus">+      target.addEventListener(&quot;popupshown&quot;, function(event) {</span>
<a href="#l2.161"></a><span id="l2.161" class="difflineplus">+        fn();</span>
<a href="#l2.162"></a><span id="l2.162" class="difflineplus">+      }, {&quot;capture&quot;: true, &quot;once&quot;: true});</span>
<a href="#l2.163"></a><span id="l2.163" class="difflineplus">+    };</span>
<a href="#l2.164"></a><span id="l2.164" class="difflineplus">+    gEditItemOverlay.initPanel({ node: aNode,</span>
<a href="#l2.165"></a><span id="l2.165" class="difflineplus">+                                 onPanelReady,</span>
<a href="#l2.166"></a><span id="l2.166" class="difflineplus">+                                 hiddenRows: [&quot;description&quot;, &quot;location&quot;,</span>
<a href="#l2.167"></a><span id="l2.167" class="difflineplus">+                                              &quot;loadInSidebar&quot;, &quot;keyword&quot;],</span>
<a href="#l2.168"></a><span id="l2.168" class="difflineplus">+                                 focusedElement: &quot;preferred&quot;});</span>
<a href="#l2.169"></a><span id="l2.169" class="difflineplus">+</span>
<a href="#l2.170"></a><span id="l2.170">     this.panel.openPopup(aAnchorElement, aPosition);</span>
<a href="#l2.171"></a><span id="l2.171" class="difflineminus">-</span>
<a href="#l2.172"></a><span id="l2.172" class="difflineminus">-    gEditItemOverlay.initPanel(this._itemId,</span>
<a href="#l2.173"></a><span id="l2.173" class="difflineminus">-                               { hiddenRows: [&quot;description&quot;, &quot;location&quot;,</span>
<a href="#l2.174"></a><span id="l2.174" class="difflineminus">-                                              &quot;keyword&quot;] });</span>
<a href="#l2.175"></a><span id="l2.175">   },</span>
<a href="#l2.176"></a><span id="l2.176"> </span>
<a href="#l2.177"></a><span id="l2.177">   panelShown:</span>
<a href="#l2.178"></a><span id="l2.178">   function SU_panelShown(aEvent) {</span>
<a href="#l2.179"></a><span id="l2.179">     if (aEvent.target == this.panel) {</span>
<a href="#l2.180"></a><span id="l2.180">       if (!this._element(&quot;editBookmarkPanelContent&quot;).hidden) {</span>
<a href="#l2.181"></a><span id="l2.181">         let fieldToFocus = &quot;editBMPanel_&quot; +</span>
<a href="#l2.182"></a><span id="l2.182">           Services.prefs.getCharPref(&quot;browser.bookmarks.editDialog.firstEditField&quot;);</span>
<a href="#l2.183"></a><span id="l2.183" class="difflineat">@@ -232,81 +270,16 @@ var StarUI = {</span>
<a href="#l2.184"></a><span id="l2.184">     if (!this._batching) {</span>
<a href="#l2.185"></a><span id="l2.185">       PlacesUtils.transactionManager.beginBatch(null);</span>
<a href="#l2.186"></a><span id="l2.186">       this._batching = true;</span>
<a href="#l2.187"></a><span id="l2.187">     }</span>
<a href="#l2.188"></a><span id="l2.188">   }</span>
<a href="#l2.189"></a><span id="l2.189"> }</span>
<a href="#l2.190"></a><span id="l2.190"> </span>
<a href="#l2.191"></a><span id="l2.191"> var PlacesCommandHook = {</span>
<a href="#l2.192"></a><span id="l2.192" class="difflineminus">-  /**</span>
<a href="#l2.193"></a><span id="l2.193" class="difflineminus">-   * Adds a bookmark to the page loaded in the given browser.</span>
<a href="#l2.194"></a><span id="l2.194" class="difflineminus">-   *</span>
<a href="#l2.195"></a><span id="l2.195" class="difflineminus">-   * @param aBrowser</span>
<a href="#l2.196"></a><span id="l2.196" class="difflineminus">-   *        a &lt;browser&gt; element.</span>
<a href="#l2.197"></a><span id="l2.197" class="difflineminus">-   * @param [optional] aParent</span>
<a href="#l2.198"></a><span id="l2.198" class="difflineminus">-   *        The folder in which to create a new bookmark if the page loaded in</span>
<a href="#l2.199"></a><span id="l2.199" class="difflineminus">-   *        aBrowser isn't bookmarked yet, defaults to the unfiled root.</span>
<a href="#l2.200"></a><span id="l2.200" class="difflineminus">-   * @param [optional] aShowEditUI</span>
<a href="#l2.201"></a><span id="l2.201" class="difflineminus">-   *        whether or not to show the edit-bookmark UI for the bookmark item</span>
<a href="#l2.202"></a><span id="l2.202" class="difflineminus">-   */</span>
<a href="#l2.203"></a><span id="l2.203" class="difflineminus">-  bookmarkPage: function PCH_bookmarkPage(aBrowser, aParent, aShowEditUI) {</span>
<a href="#l2.204"></a><span id="l2.204" class="difflineminus">-    var uri = aBrowser.currentURI;</span>
<a href="#l2.205"></a><span id="l2.205" class="difflineminus">-    var itemId = PlacesUtils.getMostRecentBookmarkForURI(uri);</span>
<a href="#l2.206"></a><span id="l2.206" class="difflineminus">-    if (itemId == -1) {</span>
<a href="#l2.207"></a><span id="l2.207" class="difflineminus">-      // Copied over from addBookmarkForBrowser:</span>
<a href="#l2.208"></a><span id="l2.208" class="difflineminus">-      // Bug 52536: We obtain the URL and title from the nsIWebNavigation</span>
<a href="#l2.209"></a><span id="l2.209" class="difflineminus">-      // associated with a &lt;browser/&gt; rather than from a DOMWindow.</span>
<a href="#l2.210"></a><span id="l2.210" class="difflineminus">-      // This is because when a full page plugin is loaded, there is</span>
<a href="#l2.211"></a><span id="l2.211" class="difflineminus">-      // no DOMWindow (?) but information about the loaded document</span>
<a href="#l2.212"></a><span id="l2.212" class="difflineminus">-      // may still be obtained from the webNavigation.</span>
<a href="#l2.213"></a><span id="l2.213" class="difflineminus">-      var webNav = aBrowser.webNavigation;</span>
<a href="#l2.214"></a><span id="l2.214" class="difflineminus">-      var url = webNav.currentURI;</span>
<a href="#l2.215"></a><span id="l2.215" class="difflineminus">-      var title;</span>
<a href="#l2.216"></a><span id="l2.216" class="difflineminus">-      var description;</span>
<a href="#l2.217"></a><span id="l2.217" class="difflineminus">-      var charset;</span>
<a href="#l2.218"></a><span id="l2.218" class="difflineminus">-      try {</span>
<a href="#l2.219"></a><span id="l2.219" class="difflineminus">-        title = webNav.document.title || url.spec;</span>
<a href="#l2.220"></a><span id="l2.220" class="difflineminus">-        description = PlacesUIUtils.getDescriptionFromDocument(webNav.document);</span>
<a href="#l2.221"></a><span id="l2.221" class="difflineminus">-        charset = webNav.document.characterSet;</span>
<a href="#l2.222"></a><span id="l2.222" class="difflineminus">-      }</span>
<a href="#l2.223"></a><span id="l2.223" class="difflineminus">-      catch (e) { }</span>
<a href="#l2.224"></a><span id="l2.224" class="difflineminus">-</span>
<a href="#l2.225"></a><span id="l2.225" class="difflineminus">-      if (aShowEditUI) {</span>
<a href="#l2.226"></a><span id="l2.226" class="difflineminus">-        // If we bookmark the page here (i.e. page was not &quot;starred&quot; already)</span>
<a href="#l2.227"></a><span id="l2.227" class="difflineminus">-        // but open right into the &quot;edit&quot; state, start batching here, so</span>
<a href="#l2.228"></a><span id="l2.228" class="difflineminus">-        // &quot;Cancel&quot; in that state removes the bookmark.</span>
<a href="#l2.229"></a><span id="l2.229" class="difflineminus">-        StarUI.beginBatch();</span>
<a href="#l2.230"></a><span id="l2.230" class="difflineminus">-      }</span>
<a href="#l2.231"></a><span id="l2.231" class="difflineminus">-</span>
<a href="#l2.232"></a><span id="l2.232" class="difflineminus">-      var parent = aParent || PlacesUtils.unfiledBookmarksFolderId;</span>
<a href="#l2.233"></a><span id="l2.233" class="difflineminus">-      var descAnno = { name: PlacesUIUtils.DESCRIPTION_ANNO, value: description };</span>
<a href="#l2.234"></a><span id="l2.234" class="difflineminus">-      var txn = new PlacesCreateBookmarkTransaction(uri, parent,</span>
<a href="#l2.235"></a><span id="l2.235" class="difflineminus">-                                                    PlacesUtils.bookmarks.DEFAULT_INDEX,</span>
<a href="#l2.236"></a><span id="l2.236" class="difflineminus">-                                                    title, null, [descAnno]);</span>
<a href="#l2.237"></a><span id="l2.237" class="difflineminus">-      PlacesUtils.transactionManager.doTransaction(txn);</span>
<a href="#l2.238"></a><span id="l2.238" class="difflineminus">-      // Set the character-set</span>
<a href="#l2.239"></a><span id="l2.239" class="difflineminus">-      if (charset)</span>
<a href="#l2.240"></a><span id="l2.240" class="difflineminus">-        PlacesUtils.setCharsetForURI(uri, charset);</span>
<a href="#l2.241"></a><span id="l2.241" class="difflineminus">-      itemId = PlacesUtils.getMostRecentBookmarkForURI(uri);</span>
<a href="#l2.242"></a><span id="l2.242" class="difflineminus">-    }</span>
<a href="#l2.243"></a><span id="l2.243" class="difflineminus">-</span>
<a href="#l2.244"></a><span id="l2.244" class="difflineminus">-    // dock the panel to the star icon when possible, otherwise dock</span>
<a href="#l2.245"></a><span id="l2.245" class="difflineminus">-    // it to the content area</span>
<a href="#l2.246"></a><span id="l2.246" class="difflineminus">-    if (aBrowser.contentWindow == window.content) {</span>
<a href="#l2.247"></a><span id="l2.247" class="difflineminus">-      let ubIcons = aBrowser.ownerDocument.getElementById(&quot;urlbar-icons&quot;);</span>
<a href="#l2.248"></a><span id="l2.248" class="difflineminus">-      if (ubIcons) {</span>
<a href="#l2.249"></a><span id="l2.249" class="difflineminus">-        if (aShowEditUI)</span>
<a href="#l2.250"></a><span id="l2.250" class="difflineminus">-          StarUI.showEditBookmarkPopup(itemId, ubIcons, &quot;bottomcenter topright&quot;);</span>
<a href="#l2.251"></a><span id="l2.251" class="difflineminus">-        return;</span>
<a href="#l2.252"></a><span id="l2.252" class="difflineminus">-      }</span>
<a href="#l2.253"></a><span id="l2.253" class="difflineminus">-    }</span>
<a href="#l2.254"></a><span id="l2.254" class="difflineminus">-</span>
<a href="#l2.255"></a><span id="l2.255" class="difflineminus">-    StarUI.showEditBookmarkPopup(itemId, aBrowser, &quot;overlap&quot;);</span>
<a href="#l2.256"></a><span id="l2.256" class="difflineminus">-  },</span>
<a href="#l2.257"></a><span id="l2.257"> </span>
<a href="#l2.258"></a><span id="l2.258">   /**</span>
<a href="#l2.259"></a><span id="l2.259">    * Adds a bookmark to the page loaded in the given browser using the</span>
<a href="#l2.260"></a><span id="l2.260">    * properties dialog.</span>
<a href="#l2.261"></a><span id="l2.261">    *</span>
<a href="#l2.262"></a><span id="l2.262">    * @param aBrowser</span>
<a href="#l2.263"></a><span id="l2.263">    *        a &lt;browser&gt; element.</span>
<a href="#l2.264"></a><span id="l2.264">    * @param [optional] aParent</span>
<a href="#l2.265"></a><span id="l2.265" class="difflineat">@@ -330,130 +303,329 @@ var PlacesCommandHook = {</span>
<a href="#l2.266"></a><span id="l2.266">     var insertPoint = new InsertionPoint(parent,</span>
<a href="#l2.267"></a><span id="l2.267">                                          PlacesUtils.bookmarks.DEFAULT_INDEX);</span>
<a href="#l2.268"></a><span id="l2.268">     var hiddenRows = [];</span>
<a href="#l2.269"></a><span id="l2.269">     PlacesUIUtils.showAddBookmarkUI(uri, title, description, insertPoint, true,</span>
<a href="#l2.270"></a><span id="l2.270">                                     null, null, null, null, hiddenRows);</span>
<a href="#l2.271"></a><span id="l2.271">   },</span>
<a href="#l2.272"></a><span id="l2.272"> </span>
<a href="#l2.273"></a><span id="l2.273">   /**</span>
<a href="#l2.274"></a><span id="l2.274" class="difflineplus">+   * Adds a bookmark to the page loaded in the given browser.</span>
<a href="#l2.275"></a><span id="l2.275" class="difflineplus">+   *</span>
<a href="#l2.276"></a><span id="l2.276" class="difflineplus">+   * @param aBrowser</span>
<a href="#l2.277"></a><span id="l2.277" class="difflineplus">+   *        a &lt;browser&gt; element.</span>
<a href="#l2.278"></a><span id="l2.278" class="difflineplus">+   * @param [optional] aParent</span>
<a href="#l2.279"></a><span id="l2.279" class="difflineplus">+   *        The folder in which to create a new bookmark if the page loaded in</span>
<a href="#l2.280"></a><span id="l2.280" class="difflineplus">+   *        aBrowser isn't bookmarked yet, defaults to the unfiled root.</span>
<a href="#l2.281"></a><span id="l2.281" class="difflineplus">+   * @param [optional] aShowEditUI</span>
<a href="#l2.282"></a><span id="l2.282" class="difflineplus">+   *        whether or not to show the edit-bookmark UI for the bookmark item</span>
<a href="#l2.283"></a><span id="l2.283" class="difflineplus">+   */</span>
<a href="#l2.284"></a><span id="l2.284" class="difflineplus">+  async bookmarkPage(aBrowser, aParent, aShowEditUI) {</span>
<a href="#l2.285"></a><span id="l2.285" class="difflineplus">+    if (PlacesUIUtils.useAsyncTransactions) {</span>
<a href="#l2.286"></a><span id="l2.286" class="difflineplus">+      await this._bookmarkPagePT(aBrowser, aParent, aShowEditUI);</span>
<a href="#l2.287"></a><span id="l2.287" class="difflineplus">+      return;</span>
<a href="#l2.288"></a><span id="l2.288" class="difflineplus">+    }</span>
<a href="#l2.289"></a><span id="l2.289" class="difflineplus">+</span>
<a href="#l2.290"></a><span id="l2.290" class="difflineplus">+    var uri = aBrowser.currentURI;</span>
<a href="#l2.291"></a><span id="l2.291" class="difflineplus">+    var itemId = PlacesUtils.getMostRecentBookmarkForURI(uri);</span>
<a href="#l2.292"></a><span id="l2.292" class="difflineplus">+    let isNewBookmark = itemId == -1;</span>
<a href="#l2.293"></a><span id="l2.293" class="difflineplus">+    if (isNewBookmark) {</span>
<a href="#l2.294"></a><span id="l2.294" class="difflineplus">+      // Bug 1148838 - Make this code work for full page plugins.</span>
<a href="#l2.295"></a><span id="l2.295" class="difflineplus">+      var title;</span>
<a href="#l2.296"></a><span id="l2.296" class="difflineplus">+      var description;</span>
<a href="#l2.297"></a><span id="l2.297" class="difflineplus">+      var charset;</span>
<a href="#l2.298"></a><span id="l2.298" class="difflineplus">+</span>
<a href="#l2.299"></a><span id="l2.299" class="difflineplus">+      let docInfo = await this._getPageDetails(aBrowser);</span>
<a href="#l2.300"></a><span id="l2.300" class="difflineplus">+</span>
<a href="#l2.301"></a><span id="l2.301" class="difflineplus">+      try {</span>
<a href="#l2.302"></a><span id="l2.302" class="difflineplus">+        title = docInfo.isErrorPage ? PlacesUtils.history.getPageTitle(uri)</span>
<a href="#l2.303"></a><span id="l2.303" class="difflineplus">+                                    : aBrowser.contentTitle;</span>
<a href="#l2.304"></a><span id="l2.304" class="difflineplus">+        title = title || uri.spec;</span>
<a href="#l2.305"></a><span id="l2.305" class="difflineplus">+        description = docInfo.description;</span>
<a href="#l2.306"></a><span id="l2.306" class="difflineplus">+        charset = aBrowser.characterSet;</span>
<a href="#l2.307"></a><span id="l2.307" class="difflineplus">+      } catch (e) { }</span>
<a href="#l2.308"></a><span id="l2.308" class="difflineplus">+</span>
<a href="#l2.309"></a><span id="l2.309" class="difflineplus">+      if (aShowEditUI) {</span>
<a href="#l2.310"></a><span id="l2.310" class="difflineplus">+        // If we bookmark the page here but open right into a cancelable</span>
<a href="#l2.311"></a><span id="l2.311" class="difflineplus">+        // state (i.e. new bookmark in Library), start batching here so</span>
<a href="#l2.312"></a><span id="l2.312" class="difflineplus">+        // all of the actions can be undone in a single undo step.</span>
<a href="#l2.313"></a><span id="l2.313" class="difflineplus">+        StarUI.beginBatch();</span>
<a href="#l2.314"></a><span id="l2.314" class="difflineplus">+      }</span>
<a href="#l2.315"></a><span id="l2.315" class="difflineplus">+</span>
<a href="#l2.316"></a><span id="l2.316" class="difflineplus">+      var parent = aParent !== undefined ?</span>
<a href="#l2.317"></a><span id="l2.317" class="difflineplus">+                   aParent : PlacesUtils.unfiledBookmarksFolderId;</span>
<a href="#l2.318"></a><span id="l2.318" class="difflineplus">+      var descAnno = { name: PlacesUIUtils.DESCRIPTION_ANNO, value: description };</span>
<a href="#l2.319"></a><span id="l2.319" class="difflineplus">+      var txn = new PlacesCreateBookmarkTransaction(uri, parent,</span>
<a href="#l2.320"></a><span id="l2.320" class="difflineplus">+                                                    PlacesUtils.bookmarks.DEFAULT_INDEX,</span>
<a href="#l2.321"></a><span id="l2.321" class="difflineplus">+                                                    title, null, [descAnno]);</span>
<a href="#l2.322"></a><span id="l2.322" class="difflineplus">+      PlacesUtils.transactionManager.doTransaction(txn);</span>
<a href="#l2.323"></a><span id="l2.323" class="difflineplus">+      itemId = txn.item.id;</span>
<a href="#l2.324"></a><span id="l2.324" class="difflineplus">+      // Set the character-set.</span>
<a href="#l2.325"></a><span id="l2.325" class="difflineplus">+      if (charset &amp;&amp; !PrivateBrowsingUtils.isBrowserPrivate(aBrowser))</span>
<a href="#l2.326"></a><span id="l2.326" class="difflineplus">+        PlacesUtils.setCharsetForURI(uri, charset);</span>
<a href="#l2.327"></a><span id="l2.327" class="difflineplus">+    }</span>
<a href="#l2.328"></a><span id="l2.328" class="difflineplus">+</span>
<a href="#l2.329"></a><span id="l2.329" class="difflineplus">+    // If it was not requested to open directly in &quot;edit&quot; mode, we are done.</span>
<a href="#l2.330"></a><span id="l2.330" class="difflineplus">+    if (!aShowEditUI)</span>
<a href="#l2.331"></a><span id="l2.331" class="difflineplus">+      return;</span>
<a href="#l2.332"></a><span id="l2.332" class="difflineplus">+</span>
<a href="#l2.333"></a><span id="l2.333" class="difflineplus">+    // Dock the panel to the star icon when possible, otherwise dock</span>
<a href="#l2.334"></a><span id="l2.334" class="difflineplus">+    // it to the content area.</span>
<a href="#l2.335"></a><span id="l2.335" class="difflineplus">+    if (aBrowser.contentWindow == window.content) {</span>
<a href="#l2.336"></a><span id="l2.336" class="difflineplus">+      let ubIcons = aBrowser.ownerDocument.getElementById(&quot;urlbar-icons&quot;);</span>
<a href="#l2.337"></a><span id="l2.337" class="difflineplus">+      if (ubIcons) {</span>
<a href="#l2.338"></a><span id="l2.338" class="difflineplus">+        await StarUI.showEditBookmarkPopup(itemId, ubIcons,</span>
<a href="#l2.339"></a><span id="l2.339" class="difflineplus">+                                           &quot;bottomcenter topright&quot;,</span>
<a href="#l2.340"></a><span id="l2.340" class="difflineplus">+                                           isNewBookmark);</span>
<a href="#l2.341"></a><span id="l2.341" class="difflineplus">+        return;</span>
<a href="#l2.342"></a><span id="l2.342" class="difflineplus">+      }</span>
<a href="#l2.343"></a><span id="l2.343" class="difflineplus">+    }</span>
<a href="#l2.344"></a><span id="l2.344" class="difflineplus">+</span>
<a href="#l2.345"></a><span id="l2.345" class="difflineplus">+    await StarUI.showEditBookmarkPopup(itemId, aBrowser, &quot;overlap&quot;,</span>
<a href="#l2.346"></a><span id="l2.346" class="difflineplus">+                                       isNewBookmark);</span>
<a href="#l2.347"></a><span id="l2.347" class="difflineplus">+  },</span>
<a href="#l2.348"></a><span id="l2.348" class="difflineplus">+</span>
<a href="#l2.349"></a><span id="l2.349" class="difflineplus">+  // TODO: Replace bookmarkPage code with this function once legacy</span>
<a href="#l2.350"></a><span id="l2.350" class="difflineplus">+  // transactions are removed.</span>
<a href="#l2.351"></a><span id="l2.351" class="difflineplus">+  async _bookmarkPagePT(aBrowser, aParentId, aShowEditUI) {</span>
<a href="#l2.352"></a><span id="l2.352" class="difflineplus">+    let url = new URL(aBrowser.currentURI.spec);</span>
<a href="#l2.353"></a><span id="l2.353" class="difflineplus">+    let info = await PlacesUtils.bookmarks.fetch({ url });</span>
<a href="#l2.354"></a><span id="l2.354" class="difflineplus">+    let isNewBookmark = !info;</span>
<a href="#l2.355"></a><span id="l2.355" class="difflineplus">+    if (!info) {</span>
<a href="#l2.356"></a><span id="l2.356" class="difflineplus">+      let parentGuid = aParentId !== undefined ?</span>
<a href="#l2.357"></a><span id="l2.357" class="difflineplus">+                         await PlacesUtils.promiseItemGuid(aParentId) :</span>
<a href="#l2.358"></a><span id="l2.358" class="difflineplus">+                         PlacesUtils.bookmarks.unfiledGuid;</span>
<a href="#l2.359"></a><span id="l2.359" class="difflineplus">+      info = { url, parentGuid };</span>
<a href="#l2.360"></a><span id="l2.360" class="difflineplus">+      // Bug 1148838 - Make this code work for full page plugins.</span>
<a href="#l2.361"></a><span id="l2.361" class="difflineplus">+      let description = null;</span>
<a href="#l2.362"></a><span id="l2.362" class="difflineplus">+      let charset = null;</span>
<a href="#l2.363"></a><span id="l2.363" class="difflineplus">+</span>
<a href="#l2.364"></a><span id="l2.364" class="difflineplus">+      let docInfo = await this._getPageDetails(aBrowser);</span>
<a href="#l2.365"></a><span id="l2.365" class="difflineplus">+</span>
<a href="#l2.366"></a><span id="l2.366" class="difflineplus">+      try {</span>
<a href="#l2.367"></a><span id="l2.367" class="difflineplus">+        if (docInfo.isErrorPage) {</span>
<a href="#l2.368"></a><span id="l2.368" class="difflineplus">+          let entry = await PlacesUtils.history.fetch(aBrowser.currentURI);</span>
<a href="#l2.369"></a><span id="l2.369" class="difflineplus">+          if (entry) {</span>
<a href="#l2.370"></a><span id="l2.370" class="difflineplus">+            info.title = entry.title;</span>
<a href="#l2.371"></a><span id="l2.371" class="difflineplus">+          }</span>
<a href="#l2.372"></a><span id="l2.372" class="difflineplus">+        } else {</span>
<a href="#l2.373"></a><span id="l2.373" class="difflineplus">+          info.title = aBrowser.contentTitle;</span>
<a href="#l2.374"></a><span id="l2.374" class="difflineplus">+        }</span>
<a href="#l2.375"></a><span id="l2.375" class="difflineplus">+        info.title = info.title || url.href;</span>
<a href="#l2.376"></a><span id="l2.376" class="difflineplus">+        description = docInfo.description;</span>
<a href="#l2.377"></a><span id="l2.377" class="difflineplus">+        charset = aBrowser.characterSet;</span>
<a href="#l2.378"></a><span id="l2.378" class="difflineplus">+      } catch (e) {</span>
<a href="#l2.379"></a><span id="l2.379" class="difflineplus">+        Cu..reportError(e);</span>
<a href="#l2.380"></a><span id="l2.380" class="difflineplus">+      }</span>
<a href="#l2.381"></a><span id="l2.381" class="difflineplus">+</span>
<a href="#l2.382"></a><span id="l2.382" class="difflineplus">+      if (aShowEditUI &amp;&amp; isNewBookmark) {</span>
<a href="#l2.383"></a><span id="l2.383" class="difflineplus">+        // If we bookmark the page here but open right into a cancelable</span>
<a href="#l2.384"></a><span id="l2.384" class="difflineplus">+        // state (i.e. new bookmark in Library), start batching here so</span>
<a href="#l2.385"></a><span id="l2.385" class="difflineplus">+        // all of the actions can be undone in a single undo step.</span>
<a href="#l2.386"></a><span id="l2.386" class="difflineplus">+        StarUI.beginBatch();</span>
<a href="#l2.387"></a><span id="l2.387" class="difflineplus">+      }</span>
<a href="#l2.388"></a><span id="l2.388" class="difflineplus">+</span>
<a href="#l2.389"></a><span id="l2.389" class="difflineplus">+      if (description) {</span>
<a href="#l2.390"></a><span id="l2.390" class="difflineplus">+        info.annotations = [{ name: PlacesUIUtils.DESCRIPTION_ANNO,</span>
<a href="#l2.391"></a><span id="l2.391" class="difflineplus">+                              value: description }];</span>
<a href="#l2.392"></a><span id="l2.392" class="difflineplus">+      }</span>
<a href="#l2.393"></a><span id="l2.393" class="difflineplus">+</span>
<a href="#l2.394"></a><span id="l2.394" class="difflineplus">+      info.guid = await PlacesTransactions.NewBookmark(info).transact();</span>
<a href="#l2.395"></a><span id="l2.395" class="difflineplus">+</span>
<a href="#l2.396"></a><span id="l2.396" class="difflineplus">+      // Set the character-set</span>
<a href="#l2.397"></a><span id="l2.397" class="difflineplus">+      if (charset &amp;&amp; !PrivateBrowsingUtils.isBrowserPrivate(aBrowser))</span>
<a href="#l2.398"></a><span id="l2.398" class="difflineplus">+         PlacesUtils.setCharsetForURI(makeURI(url.href), charset);</span>
<a href="#l2.399"></a><span id="l2.399" class="difflineplus">+    }</span>
<a href="#l2.400"></a><span id="l2.400" class="difflineplus">+</span>
<a href="#l2.401"></a><span id="l2.401" class="difflineplus">+    // If it was not requested to open directly in &quot;edit&quot; mode, we are done.</span>
<a href="#l2.402"></a><span id="l2.402" class="difflineplus">+    if (!aShowEditUI)</span>
<a href="#l2.403"></a><span id="l2.403" class="difflineplus">+      return;</span>
<a href="#l2.404"></a><span id="l2.404" class="difflineplus">+</span>
<a href="#l2.405"></a><span id="l2.405" class="difflineplus">+    let node = await PlacesUIUtils.promiseNodeLikeFromFetchInfo(info);</span>
<a href="#l2.406"></a><span id="l2.406" class="difflineplus">+</span>
<a href="#l2.407"></a><span id="l2.407" class="difflineplus">+    // Dock the panel to the star icon when possible, otherwise dock</span>
<a href="#l2.408"></a><span id="l2.408" class="difflineplus">+    // it to the content area.</span>
<a href="#l2.409"></a><span id="l2.409" class="difflineplus">+    if (aBrowser.contentWindow == window.content) {</span>
<a href="#l2.410"></a><span id="l2.410" class="difflineplus">+      let ubIcons = aBrowser.ownerDocument.getElementById(&quot;urlbar-icons&quot;);</span>
<a href="#l2.411"></a><span id="l2.411" class="difflineplus">+      if (ubIcons) {</span>
<a href="#l2.412"></a><span id="l2.412" class="difflineplus">+        await StarUI.showEditBookmarkPopup(node, ubIcons,</span>
<a href="#l2.413"></a><span id="l2.413" class="difflineplus">+                                           &quot;bottomcenter topright&quot;,</span>
<a href="#l2.414"></a><span id="l2.414" class="difflineplus">+                                           isNewBookmark);</span>
<a href="#l2.415"></a><span id="l2.415" class="difflineplus">+        return;</span>
<a href="#l2.416"></a><span id="l2.416" class="difflineplus">+      }</span>
<a href="#l2.417"></a><span id="l2.417" class="difflineplus">+    }</span>
<a href="#l2.418"></a><span id="l2.418" class="difflineplus">+</span>
<a href="#l2.419"></a><span id="l2.419" class="difflineplus">+    await StarUI.showEditBookmarkPopup(node, aBrowser, &quot;overlap&quot;,</span>
<a href="#l2.420"></a><span id="l2.420" class="difflineplus">+                                       isNewBookmark);</span>
<a href="#l2.421"></a><span id="l2.421" class="difflineplus">+  },</span>
<a href="#l2.422"></a><span id="l2.422" class="difflineplus">+</span>
<a href="#l2.423"></a><span id="l2.423" class="difflineplus">+  _getPageDetails(browser) {</span>
<a href="#l2.424"></a><span id="l2.424" class="difflineplus">+    return new Promise(resolve =&gt; {</span>
<a href="#l2.425"></a><span id="l2.425" class="difflineplus">+      let mm = browser.messageManager;</span>
<a href="#l2.426"></a><span id="l2.426" class="difflineplus">+      mm.addMessageListener(&quot;Bookmarks:GetPageDetails:Result&quot;, function listener(msg) {</span>
<a href="#l2.427"></a><span id="l2.427" class="difflineplus">+        mm.removeMessageListener(&quot;Bookmarks:GetPageDetails:Result&quot;, listener);</span>
<a href="#l2.428"></a><span id="l2.428" class="difflineplus">+        resolve(msg.data);</span>
<a href="#l2.429"></a><span id="l2.429" class="difflineplus">+      });</span>
<a href="#l2.430"></a><span id="l2.430" class="difflineplus">+</span>
<a href="#l2.431"></a><span id="l2.431" class="difflineplus">+      mm.sendAsyncMessage(&quot;Bookmarks:GetPageDetails&quot;, { })</span>
<a href="#l2.432"></a><span id="l2.432" class="difflineplus">+    });</span>
<a href="#l2.433"></a><span id="l2.433" class="difflineplus">+  },</span>
<a href="#l2.434"></a><span id="l2.434" class="difflineplus">+</span>
<a href="#l2.435"></a><span id="l2.435" class="difflineplus">+  /**</span>
<a href="#l2.436"></a><span id="l2.436">    * Adds a bookmark to the page loaded in the current tab.</span>
<a href="#l2.437"></a><span id="l2.437">    */</span>
<a href="#l2.438"></a><span id="l2.438">   bookmarkCurrentPage: function PCH_bookmarkCurrentPage(aShowEditUI, aParent) {</span>
<a href="#l2.439"></a><span id="l2.439" class="difflineminus">-    this.bookmarkPage(gBrowser.selectedBrowser, aParent, aShowEditUI);</span>
<a href="#l2.440"></a><span id="l2.440" class="difflineplus">+    this.bookmarkPage(gBrowser.selectedBrowser, aParent, aShowEditUI)</span>
<a href="#l2.441"></a><span id="l2.441" class="difflineplus">+        .catch(Cu..reportError);</span>
<a href="#l2.442"></a><span id="l2.442">   },</span>
<a href="#l2.443"></a><span id="l2.443"> </span>
<a href="#l2.444"></a><span id="l2.444">   /**</span>
<a href="#l2.445"></a><span id="l2.445">    * Adds a bookmark to the page targeted by a link.</span>
<a href="#l2.446"></a><span id="l2.446">    * @param aParent</span>
<a href="#l2.447"></a><span id="l2.447">    *        The folder in which to create a new bookmark if aURL isn't</span>
<a href="#l2.448"></a><span id="l2.448">    *        bookmarked.</span>
<a href="#l2.449"></a><span id="l2.449">    * @param aURL (string)</span>
<a href="#l2.450"></a><span id="l2.450">    *        the address of the link target</span>
<a href="#l2.451"></a><span id="l2.451">    * @param aTitle</span>
<a href="#l2.452"></a><span id="l2.452">    *        The link text</span>
<a href="#l2.453"></a><span id="l2.453" class="difflineplus">+   * @param [optional] aDescription</span>
<a href="#l2.454"></a><span id="l2.454" class="difflineplus">+   *        The linked page description, if available</span>
<a href="#l2.455"></a><span id="l2.455">    */</span>
<a href="#l2.456"></a><span id="l2.456" class="difflineminus">-  bookmarkLink: function PCH_bookmarkLink(aParent, aURL, aTitle) {</span>
<a href="#l2.457"></a><span id="l2.457" class="difflineminus">-    var linkURI = makeURI(aURL);</span>
<a href="#l2.458"></a><span id="l2.458" class="difflineminus">-    var itemId = PlacesUtils.getMostRecentBookmarkForURI(linkURI);</span>
<a href="#l2.459"></a><span id="l2.459" class="difflineminus">-    if (itemId == -1)</span>
<a href="#l2.460"></a><span id="l2.460" class="difflineminus">-      PlacesUIUtils.showMinimalAddBookmarkUI(linkURI, aTitle);</span>
<a href="#l2.461"></a><span id="l2.461" class="difflineminus">-    else {</span>
<a href="#l2.462"></a><span id="l2.462" class="difflineminus">-      PlacesUIUtils.showItemProperties(itemId,</span>
<a href="#l2.463"></a><span id="l2.463" class="difflineminus">-                                       PlacesUtils.bookmarks.TYPE_BOOKMARK);</span>
<a href="#l2.464"></a><span id="l2.464" class="difflineplus">+  async bookmarkLink(aParentId, aURL, aTitle, aDescription = &quot;&quot;) {</span>
<a href="#l2.465"></a><span id="l2.465" class="difflineplus">+    let node = await PlacesUIUtils.fetchNodeLike({ url: aURL });</span>
<a href="#l2.466"></a><span id="l2.466" class="difflineplus">+    if (node) {</span>
<a href="#l2.467"></a><span id="l2.467" class="difflineplus">+      PlacesUIUtils.showBookmarkDialog({ action: &quot;edit&quot;,</span>
<a href="#l2.468"></a><span id="l2.468" class="difflineplus">+                                         node</span>
<a href="#l2.469"></a><span id="l2.469" class="difflineplus">+                                       }, window.top);</span>
<a href="#l2.470"></a><span id="l2.470" class="difflineplus">+      return;</span>
<a href="#l2.471"></a><span id="l2.471">     }</span>
<a href="#l2.472"></a><span id="l2.472" class="difflineplus">+</span>
<a href="#l2.473"></a><span id="l2.473" class="difflineplus">+    let ip = new InsertionPoint(aParentId,</span>
<a href="#l2.474"></a><span id="l2.474" class="difflineplus">+                                PlacesUtils.bookmarks.DEFAULT_INDEX,</span>
<a href="#l2.475"></a><span id="l2.475" class="difflineplus">+                                Ci.nsITreeView.DROP_ON);</span>
<a href="#l2.476"></a><span id="l2.476" class="difflineplus">+    PlacesUIUtils.showBookmarkDialog({ action: &quot;add&quot;,</span>
<a href="#l2.477"></a><span id="l2.477" class="difflineplus">+                                       type: &quot;bookmark&quot;,</span>
<a href="#l2.478"></a><span id="l2.478" class="difflineplus">+                                       uri: makeURI(aURL),</span>
<a href="#l2.479"></a><span id="l2.479" class="difflineplus">+                                       title: aTitle,</span>
<a href="#l2.480"></a><span id="l2.480" class="difflineplus">+                                       description: aDescription,</span>
<a href="#l2.481"></a><span id="l2.481" class="difflineplus">+                                       defaultInsertionPoint: ip,</span>
<a href="#l2.482"></a><span id="l2.482" class="difflineplus">+                                       hiddenRows: [ &quot;description&quot;,</span>
<a href="#l2.483"></a><span id="l2.483" class="difflineplus">+                                                     &quot;location&quot;,</span>
<a href="#l2.484"></a><span id="l2.484" class="difflineplus">+                                                     &quot;loadInSidebar&quot;,</span>
<a href="#l2.485"></a><span id="l2.485" class="difflineplus">+                                                     &quot;keyword&quot; ]</span>
<a href="#l2.486"></a><span id="l2.486" class="difflineplus">+                                     }, window.top);</span>
<a href="#l2.487"></a><span id="l2.487">   },</span>
<a href="#l2.488"></a><span id="l2.488"> </span>
<a href="#l2.489"></a><span id="l2.489">   /**</span>
<a href="#l2.490"></a><span id="l2.490" class="difflineminus">-   * This function returns a list of nsIURI objects characterizing the</span>
<a href="#l2.491"></a><span id="l2.491" class="difflineminus">-   * tabs currently open in the browser.  The URIs will appear in the</span>
<a href="#l2.492"></a><span id="l2.492" class="difflineminus">-   * list in the order in which their corresponding tabs appeared.  However,</span>
<a href="#l2.493"></a><span id="l2.493" class="difflineminus">-   * only the first instance of each URI will be returned.</span>
<a href="#l2.494"></a><span id="l2.494" class="difflineminus">-   *</span>
<a href="#l2.495"></a><span id="l2.495" class="difflineminus">-   * @returns a list of nsIURI objects representing unique locations open</span>
<a href="#l2.496"></a><span id="l2.496" class="difflineplus">+   * List of nsIURI objects characterizing the tabs currently open in the</span>
<a href="#l2.497"></a><span id="l2.497" class="difflineplus">+   * browser. The URIs will be in the order in which their</span>
<a href="#l2.498"></a><span id="l2.498" class="difflineplus">+   * corresponding tabs appeared and duplicates are discarded.</span>
<a href="#l2.499"></a><span id="l2.499">    */</span>
<a href="#l2.500"></a><span id="l2.500" class="difflineminus">-  _getUniqueTabInfo: function BATC__getUniqueTabInfo(aTitles) {</span>
<a href="#l2.501"></a><span id="l2.501" class="difflineplus">+  get uniqueCurrentPages() {</span>
<a href="#l2.502"></a><span id="l2.502">     var tabList = [];</span>
<a href="#l2.503"></a><span id="l2.503">     var seenURIs = {};</span>
<a href="#l2.504"></a><span id="l2.504"> </span>
<a href="#l2.505"></a><span id="l2.505">     var browsers = gBrowser.browsers;</span>
<a href="#l2.506"></a><span id="l2.506">     for (var i = 0; i &lt; browsers.length; ++i) {</span>
<a href="#l2.507"></a><span id="l2.507">       let uri = browsers[i].currentURI;</span>
<a href="#l2.508"></a><span id="l2.508"> </span>
<a href="#l2.509"></a><span id="l2.509">       // skip redundant entries</span>
<a href="#l2.510"></a><span id="l2.510">       if (uri.spec in seenURIs)</span>
<a href="#l2.511"></a><span id="l2.511">         continue;</span>
<a href="#l2.512"></a><span id="l2.512"> </span>
<a href="#l2.513"></a><span id="l2.513">       // add to the set of seen URIs</span>
<a href="#l2.514"></a><span id="l2.514">       seenURIs[uri.spec] = null;</span>
<a href="#l2.515"></a><span id="l2.515">       tabList.push(uri);</span>
<a href="#l2.516"></a><span id="l2.516" class="difflineminus">-      if (aTitles)</span>
<a href="#l2.517"></a><span id="l2.517" class="difflineminus">-        aTitles.push(browsers[i].contentTitle);</span>
<a href="#l2.518"></a><span id="l2.518">     }</span>
<a href="#l2.519"></a><span id="l2.519">     return tabList;</span>
<a href="#l2.520"></a><span id="l2.520">   },</span>
<a href="#l2.521"></a><span id="l2.521"> </span>
<a href="#l2.522"></a><span id="l2.522">   /**</span>
<a href="#l2.523"></a><span id="l2.523">    * Adds a folder with bookmarks to all of the currently open tabs in this</span>
<a href="#l2.524"></a><span id="l2.524">    * window.</span>
<a href="#l2.525"></a><span id="l2.525">    */</span>
<a href="#l2.526"></a><span id="l2.526">   bookmarkCurrentPages: function PCH_bookmarkCurrentPages() {</span>
<a href="#l2.527"></a><span id="l2.527" class="difflineminus">-    var titles = [];</span>
<a href="#l2.528"></a><span id="l2.528" class="difflineminus">-    var tabURIs = this._getUniqueTabInfo(titles);</span>
<a href="#l2.529"></a><span id="l2.529" class="difflineminus">-    PlacesUIUtils.showMinimalAddMultiBookmarkUI(tabURIs, titles);</span>
<a href="#l2.530"></a><span id="l2.530" class="difflineplus">+    let pages = this.uniqueCurrentPages;</span>
<a href="#l2.531"></a><span id="l2.531" class="difflineplus">+    if (pages.length &gt; 1) {</span>
<a href="#l2.532"></a><span id="l2.532" class="difflineplus">+    PlacesUIUtils.showBookmarkDialog({ action: &quot;add&quot;,</span>
<a href="#l2.533"></a><span id="l2.533" class="difflineplus">+                                       type: &quot;folder&quot;,</span>
<a href="#l2.534"></a><span id="l2.534" class="difflineplus">+                                       URIList: pages,</span>
<a href="#l2.535"></a><span id="l2.535" class="difflineplus">+                                       hiddenRows: [ &quot;description&quot; ]</span>
<a href="#l2.536"></a><span id="l2.536" class="difflineplus">+                                     }, window);</span>
<a href="#l2.537"></a><span id="l2.537" class="difflineplus">+    }</span>
<a href="#l2.538"></a><span id="l2.538">   },</span>
<a href="#l2.539"></a><span id="l2.539"> </span>
<a href="#l2.540"></a><span id="l2.540" class="difflineplus">+  /**</span>
<a href="#l2.541"></a><span id="l2.541" class="difflineplus">+   * Updates disabled state for the &quot;Bookmark All Tabs&quot; command.</span>
<a href="#l2.542"></a><span id="l2.542" class="difflineplus">+   */</span>
<a href="#l2.543"></a><span id="l2.543" class="difflineplus">+  updateBookmarkAllTabsCommand:</span>
<a href="#l2.544"></a><span id="l2.544" class="difflineplus">+  function PCH_updateBookmarkAllTabsCommand() {</span>
<a href="#l2.545"></a><span id="l2.545" class="difflineplus">+    // There's nothing to do in non-browser windows.</span>
<a href="#l2.546"></a><span id="l2.546" class="difflineplus">+    if (window.location.href != getBrowserURL())</span>
<a href="#l2.547"></a><span id="l2.547" class="difflineplus">+      return;</span>
<a href="#l2.548"></a><span id="l2.548" class="difflineplus">+</span>
<a href="#l2.549"></a><span id="l2.549" class="difflineplus">+    // Disable &quot;Bookmark All Tabs&quot; if there are less than two</span>
<a href="#l2.550"></a><span id="l2.550" class="difflineplus">+    // &quot;unique current pages&quot;.</span>
<a href="#l2.551"></a><span id="l2.551" class="difflineplus">+    goSetCommandEnabled(&quot;Browser:BookmarkAllTabs&quot;,</span>
<a href="#l2.552"></a><span id="l2.552" class="difflineplus">+                        this.uniqueCurrentPages.length &gt;= 2);</span>
<a href="#l2.553"></a><span id="l2.553" class="difflineplus">+  },</span>
<a href="#l2.554"></a><span id="l2.554"> </span>
<a href="#l2.555"></a><span id="l2.555">   /**</span>
<a href="#l2.556"></a><span id="l2.556">    * Adds a Live Bookmark to a feed associated with the current page.</span>
<a href="#l2.557"></a><span id="l2.557">    * @param     url</span>
<a href="#l2.558"></a><span id="l2.558">    *            The nsIURI of the page the feed was attached to</span>
<a href="#l2.559"></a><span id="l2.559">    * @title     title</span>
<a href="#l2.560"></a><span id="l2.560">    *            The title of the feed. Optional.</span>
<a href="#l2.561"></a><span id="l2.561">    * @subtitle  subtitle</span>
<a href="#l2.562"></a><span id="l2.562">    *            A short description of the feed. Optional.</span>
<a href="#l2.563"></a><span id="l2.563">    */</span>
<a href="#l2.564"></a><span id="l2.564" class="difflineminus">-  addLiveBookmark: function PCH_addLiveBookmark(url, feedTitle, feedSubtitle) {</span>
<a href="#l2.565"></a><span id="l2.565" class="difflineminus">-    var feedURI = makeURI(url);</span>
<a href="#l2.566"></a><span id="l2.566" class="difflineplus">+  async addLiveBookmark(url, feedTitle, feedSubtitle) {</span>
<a href="#l2.567"></a><span id="l2.567" class="difflineplus">+    let toolbarIP = new InsertionPoint(PlacesUtils.toolbarFolderId,</span>
<a href="#l2.568"></a><span id="l2.568" class="difflineplus">+                                       PlacesUtils.bookmarks.DEFAULT_INDEX,</span>
<a href="#l2.569"></a><span id="l2.569" class="difflineplus">+                                       Ci.nsITreeView.DROP_ON);</span>
<a href="#l2.570"></a><span id="l2.570"> </span>
<a href="#l2.571"></a><span id="l2.571" class="difflineminus">-    var doc = gBrowser.contentDocument;</span>
<a href="#l2.572"></a><span id="l2.572" class="difflineminus">-    var title = (arguments.length &gt; 1) ? feedTitle : doc.title;</span>
<a href="#l2.573"></a><span id="l2.573" class="difflineplus">+    let feedURI = makeURI(url);</span>
<a href="#l2.574"></a><span id="l2.574" class="difflineplus">+    let title = feedTitle || gBrowser.contentTitle;</span>
<a href="#l2.575"></a><span id="l2.575" class="difflineplus">+    let description = feedSubtitle;</span>
<a href="#l2.576"></a><span id="l2.576" class="difflineplus">+    if (!description) {</span>
<a href="#l2.577"></a><span id="l2.577" class="difflineplus">+      description = (await this._getPageDetails(gBrowser.selectedBrowser)).description;</span>
<a href="#l2.578"></a><span id="l2.578" class="difflineplus">+    }</span>
<a href="#l2.579"></a><span id="l2.579"> </span>
<a href="#l2.580"></a><span id="l2.580" class="difflineminus">-    var description;</span>
<a href="#l2.581"></a><span id="l2.581" class="difflineminus">-    if (arguments.length &gt; 2)</span>
<a href="#l2.582"></a><span id="l2.582" class="difflineminus">-      description = feedSubtitle;</span>
<a href="#l2.583"></a><span id="l2.583" class="difflineminus">-    else</span>
<a href="#l2.584"></a><span id="l2.584" class="difflineminus">-      description = PlacesUIUtils.getDescriptionFromDocument(doc);</span>
<a href="#l2.585"></a><span id="l2.585" class="difflineminus">-</span>
<a href="#l2.586"></a><span id="l2.586" class="difflineminus">-    var toolbarIP =</span>
<a href="#l2.587"></a><span id="l2.587" class="difflineminus">-      new InsertionPoint(PlacesUtils.bookmarks.toolbarFolder, -1);</span>
<a href="#l2.588"></a><span id="l2.588" class="difflineminus">-    PlacesUIUtils.showMinimalAddLivemarkUI(feedURI, gBrowser.currentURI,</span>
<a href="#l2.589"></a><span id="l2.589" class="difflineminus">-                                           title, description, toolbarIP, true);</span>
<a href="#l2.590"></a><span id="l2.590" class="difflineplus">+    PlacesUIUtils.showBookmarkDialog({ action: &quot;add&quot;,</span>
<a href="#l2.591"></a><span id="l2.591" class="difflineplus">+                                       type: &quot;livemark&quot;,</span>
<a href="#l2.592"></a><span id="l2.592" class="difflineplus">+                                       feedURI,</span>
<a href="#l2.593"></a><span id="l2.593" class="difflineplus">+                                       siteURI: gBrowser.currentURI,</span>
<a href="#l2.594"></a><span id="l2.594" class="difflineplus">+                                       title,</span>
<a href="#l2.595"></a><span id="l2.595" class="difflineplus">+                                       description,</span>
<a href="#l2.596"></a><span id="l2.596" class="difflineplus">+                                       defaultInsertionPoint: toolbarIP,</span>
<a href="#l2.597"></a><span id="l2.597" class="difflineplus">+                                       hiddenRows: [ &quot;feedLocation&quot;,</span>
<a href="#l2.598"></a><span id="l2.598" class="difflineplus">+                                                     &quot;siteLocation&quot;,</span>
<a href="#l2.599"></a><span id="l2.599" class="difflineplus">+                                                     &quot;description&quot; ]</span>
<a href="#l2.600"></a><span id="l2.600" class="difflineplus">+                                     }, window);</span>
<a href="#l2.601"></a><span id="l2.601">   },</span>
<a href="#l2.602"></a><span id="l2.602"> </span>
<a href="#l2.603"></a><span id="l2.603">   /**</span>
<a href="#l2.604"></a><span id="l2.604" class="difflineminus">-   * Opens the bookmarks manager.</span>
<a href="#l2.605"></a><span id="l2.605" class="difflineplus">+   * Opens the Places Organizer.</span>
<a href="#l2.606"></a><span id="l2.606">    * @param   aLeftPaneRoot</span>
<a href="#l2.607"></a><span id="l2.607">    *          The query to select in the organizer window - options</span>
<a href="#l2.608"></a><span id="l2.608" class="difflineminus">-   *          are: AllBookmarks, BookmarksMenu, BookmarksToolbar,</span>
<a href="#l2.609"></a><span id="l2.609" class="difflineplus">+   *          are: History, AllBookmarks, BookmarksMenu, BookmarksToolbar,</span>
<a href="#l2.610"></a><span id="l2.610">    *          UnfiledBookmarks and Tags.</span>
<a href="#l2.611"></a><span id="l2.611">    */</span>
<a href="#l2.612"></a><span id="l2.612" class="difflineminus">-  showBookmarksManager: function PCH_showBookmarksManager(aLeftPaneRoot) {</span>
<a href="#l2.613"></a><span id="l2.613" class="difflineminus">-    var manager = Services.wm.getMostRecentWindow(&quot;bookmarks:manager&quot;);</span>
<a href="#l2.614"></a><span id="l2.614" class="difflineplus">+  showPlacesOrganizer: function PCH_showPlacesOrganizer(aLeftPaneRoot) {</span>
<a href="#l2.615"></a><span id="l2.615" class="difflineplus">+    var organizer = Services.wm.getMostRecentWindow(&quot;Places:Organizer&quot;);</span>
<a href="#l2.616"></a><span id="l2.616">     // Due to bug 528706, getMostRecentWindow can return closed windows.</span>
<a href="#l2.617"></a><span id="l2.617" class="difflineminus">-    if (!manager || manager.closed) {</span>
<a href="#l2.618"></a><span id="l2.618" class="difflineplus">+    if (!organizer || organizer.closed) {</span>
<a href="#l2.619"></a><span id="l2.619">       // No currently open places window, so open one with the specified mode.</span>
<a href="#l2.620"></a><span id="l2.620" class="difflineminus">-      openDialog(&quot;chrome://communicator/content/bookmarks/bookmarksManager.xul&quot;,</span>
<a href="#l2.621"></a><span id="l2.621" class="difflineminus">-                 &quot;&quot;, &quot;all,dialog=no&quot;, aLeftPaneRoot);</span>
<a href="#l2.622"></a><span id="l2.622" class="difflineplus">+      openDialog(&quot;chrome://communicator/content/places/places.xul&quot;,</span>
<a href="#l2.623"></a><span id="l2.623" class="difflineplus">+                 &quot;&quot;, &quot;chrome,toolbar=yes,dialog=no,resizable&quot;, aLeftPaneRoot);</span>
<a href="#l2.624"></a><span id="l2.624" class="difflineplus">+    } else {</span>
<a href="#l2.625"></a><span id="l2.625" class="difflineplus">+      organizer.PlacesOrganizer.selectLeftPaneContainerByHierarchy(aLeftPaneRoot);</span>
<a href="#l2.626"></a><span id="l2.626" class="difflineplus">+      organizer.focus();</span>
<a href="#l2.627"></a><span id="l2.627">     }</span>
<a href="#l2.628"></a><span id="l2.628" class="difflineminus">-    else {</span>
<a href="#l2.629"></a><span id="l2.629" class="difflineminus">-      manager.PlacesOrganizer.selectLeftPaneQuery(aLeftPaneRoot);</span>
<a href="#l2.630"></a><span id="l2.630" class="difflineminus">-      manager.focus();</span>
<a href="#l2.631"></a><span id="l2.631" class="difflineminus">-    }</span>
<a href="#l2.632"></a><span id="l2.632" class="difflineminus">-  }</span>
<a href="#l2.633"></a><span id="l2.633" class="difflineplus">+  },</span>
<a href="#l2.634"></a><span id="l2.634"> };</span>
<a href="#l2.635"></a><span id="l2.635"> </span>
<a href="#l2.636"></a><span id="l2.636"> /**</span>
<a href="#l2.637"></a><span id="l2.637">  * Functions for handling events in the Bookmarks Toolbar and menu.</span>
<a href="#l2.638"></a><span id="l2.638">  */</span>
<a href="#l2.639"></a><span id="l2.639"> var BookmarksEventHandler = {</span>
<a href="#l2.640"></a><span id="l2.640">   /**</span>
<a href="#l2.641"></a><span id="l2.641">    * Handler for click event for an item in the bookmarks toolbar or menu.</span>
<a href="#l2.642"></a><span id="l2.642" class="difflineat">@@ -673,18 +845,19 @@ var PlacesMenuDNDHandler = {</span>
<a href="#l2.643"></a><span id="l2.643">                                 PlacesUtils.bookmarks.DEFAULT_INDEX,</span>
<a href="#l2.644"></a><span id="l2.644">                                 Ci.nsITreeView.DROP_ON);</span>
<a href="#l2.645"></a><span id="l2.645">     PlacesControllerDragHelper.onDrop(ip, event.dataTransfer);</span>
<a href="#l2.646"></a><span id="l2.646">     event.stopPropagation();</span>
<a href="#l2.647"></a><span id="l2.647">   }</span>
<a href="#l2.648"></a><span id="l2.648"> };</span>
<a href="#l2.649"></a><span id="l2.649"> </span>
<a href="#l2.650"></a><span id="l2.650"> </span>
<a href="#l2.651"></a><span id="l2.651" class="difflineminus">-var PlacesStarButton = {</span>
<a href="#l2.652"></a><span id="l2.652" class="difflineplus">+var BookmarkingUI = {</span>
<a href="#l2.653"></a><span id="l2.653">   _hasBookmarksObserver: false,</span>
<a href="#l2.654"></a><span id="l2.654" class="difflineplus">+  _itemGuids: new Set(),</span>
<a href="#l2.655"></a><span id="l2.655"> </span>
<a href="#l2.656"></a><span id="l2.656">   uninit: function BUI_uninit()</span>
<a href="#l2.657"></a><span id="l2.657">   {</span>
<a href="#l2.658"></a><span id="l2.658">     if (this._hasBookmarksObserver) {</span>
<a href="#l2.659"></a><span id="l2.659">       PlacesUtils.bookmarks.removeObserver(this);</span>
<a href="#l2.660"></a><span id="l2.660">     }</span>
<a href="#l2.661"></a><span id="l2.661"> </span>
<a href="#l2.662"></a><span id="l2.662">     if (this._pendingUpdate) {</span>
<a href="#l2.663"></a><span id="l2.663" class="difflineat">@@ -715,17 +888,17 @@ var PlacesStarButton = {</span>
<a href="#l2.664"></a><span id="l2.664">     this._itemGuids = [];</span>
<a href="#l2.665"></a><span id="l2.665">     let aItemGuids = [];</span>
<a href="#l2.666"></a><span id="l2.666"> </span>
<a href="#l2.667"></a><span id="l2.667">     // those objects are use to check if we are in the current iteration before</span>
<a href="#l2.668"></a><span id="l2.668">     // returning any result.</span>
<a href="#l2.669"></a><span id="l2.669">     let pendingUpdate = this._pendingUpdate = {};</span>
<a href="#l2.670"></a><span id="l2.670"> </span>
<a href="#l2.671"></a><span id="l2.671">     PlacesUtils.bookmarks.fetch({url: this._uri}, b =&gt; aItemGuids.push(b.guid))</span>
<a href="#l2.672"></a><span id="l2.672" class="difflineminus">-      .catch(Cu.reportError)</span>
<a href="#l2.673"></a><span id="l2.673" class="difflineplus">+      .catch(Cu..reportError)</span>
<a href="#l2.674"></a><span id="l2.674">       .then(() =&gt; {</span>
<a href="#l2.675"></a><span id="l2.675">          if (pendingUpdate != this._pendingUpdate) {</span>
<a href="#l2.676"></a><span id="l2.676">            return;</span>
<a href="#l2.677"></a><span id="l2.677">          }</span>
<a href="#l2.678"></a><span id="l2.678"> </span>
<a href="#l2.679"></a><span id="l2.679">          // It's possible that onItemAdded gets called before the async statement</span>
<a href="#l2.680"></a><span id="l2.680">          // calls back.  For such an edge case, retain all unique entries from the</span>
<a href="#l2.681"></a><span id="l2.681">          // array.</span>
<a href="#l2.682"></a><span id="l2.682" class="difflineat">@@ -736,17 +909,17 @@ var PlacesStarButton = {</span>
<a href="#l2.683"></a><span id="l2.683">          this._updateStar();</span>
<a href="#l2.684"></a><span id="l2.684"> </span>
<a href="#l2.685"></a><span id="l2.685">          // Start observing bookmarks if needed.</span>
<a href="#l2.686"></a><span id="l2.686">          if (!this._hasBookmarksObserver) {</span>
<a href="#l2.687"></a><span id="l2.687">            try {</span>
<a href="#l2.688"></a><span id="l2.688">              PlacesUtils.bookmarks.addObserver(this);</span>
<a href="#l2.689"></a><span id="l2.689">              this._hasBookmarksObserver = true;</span>
<a href="#l2.690"></a><span id="l2.690">            } catch (ex) {</span>
<a href="#l2.691"></a><span id="l2.691" class="difflineminus">-             Cu.reportError(&quot;BookmarkingUI failed adding a bookmarks observer: &quot; + ex);</span>
<a href="#l2.692"></a><span id="l2.692" class="difflineplus">+             Cu..reportError(&quot;BookmarkingUI failed adding a bookmarks observer: &quot; + ex);</span>
<a href="#l2.693"></a><span id="l2.693">            }</span>
<a href="#l2.694"></a><span id="l2.694">          }</span>
<a href="#l2.695"></a><span id="l2.695"> </span>
<a href="#l2.696"></a><span id="l2.696">          delete this._pendingUpdate;</span>
<a href="#l2.697"></a><span id="l2.697">        });</span>
<a href="#l2.698"></a><span id="l2.698">   },</span>
<a href="#l2.699"></a><span id="l2.699"> </span>
<a href="#l2.700"></a><span id="l2.700">   _updateStar: function BUI__updateStar()</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/suite/browser/browser-prefs.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/suite/browser/browser-prefs.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -242,16 +242,19 @@ pref(&quot;browser.tabs.closeWindowWithLastTa</span>
<a href="#l3.4"></a><span id="l3.4"> pref(&quot;browser.tabs.warnOnClose&quot;, true);</span>
<a href="#l3.5"></a><span id="l3.5"> pref(&quot;browser.tabs.warnOnCloseOther&quot;, true);</span>
<a href="#l3.6"></a><span id="l3.6"> pref(&quot;browser.tabs.warnOnOpen&quot;, true);</span>
<a href="#l3.7"></a><span id="l3.7"> pref(&quot;browser.tabs.maxOpenBeforeWarn&quot;, 15);</span>
<a href="#l3.8"></a><span id="l3.8"> pref(&quot;browser.tabs.insertRelatedAfterCurrent&quot;, true);</span>
<a href="#l3.9"></a><span id="l3.9"> // 0 = append, 1 = replace</span>
<a href="#l3.10"></a><span id="l3.10"> pref(&quot;browser.tabs.loadGroup&quot;, 1);</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+// For future use</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+pref(&quot;browser.tabs.loadBookmarksInBackground&quot;, false);</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+</span>
<a href="#l3.15"></a><span id="l3.15"> // No e10s in SeaMonkey for now.</span>
<a href="#l3.16"></a><span id="l3.16"> pref(&quot;browser.tabs.remote.autostart&quot;, false);</span>
<a href="#l3.17"></a><span id="l3.17"> </span>
<a href="#l3.18"></a><span id="l3.18"> // how many browsers can be saved in the DOM (by the tabbed browser)</span>
<a href="#l3.19"></a><span id="l3.19"> pref(&quot;browser.tabs.max_tabs_undo&quot;, 3);</span>
<a href="#l3.20"></a><span id="l3.20"> // should popups by saved in the DOM (by the tabbed browser)</span>
<a href="#l3.21"></a><span id="l3.21"> pref(&quot;browser.tabs.cache_popups&quot;, false);</span>
<a href="#l3.22"></a><span id="l3.22"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/suite/browser/content.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/suite/browser/content.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -9,16 +9,18 @@</span>
<a href="#l4.4"></a><span id="l4.4"> ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l4.5"></a><span id="l4.5"> </span>
<a href="#l4.6"></a><span id="l4.6"> ChromeUtils.defineModuleGetter(this, &quot;LoginManagerContent&quot;,</span>
<a href="#l4.7"></a><span id="l4.7">   &quot;resource://gre/modules/LoginManagerContent.jsm&quot;);</span>
<a href="#l4.8"></a><span id="l4.8"> ChromeUtils.defineModuleGetter(this, &quot;InsecurePasswordUtils&quot;,</span>
<a href="#l4.9"></a><span id="l4.9">   &quot;resource://gre/modules/InsecurePasswordUtils.jsm&quot;);</span>
<a href="#l4.10"></a><span id="l4.10"> ChromeUtils.defineModuleGetter(this, &quot;LoginFormFactory&quot;,</span>
<a href="#l4.11"></a><span id="l4.11">   &quot;resource://gre/modules/LoginManagerContent.jsm&quot;);</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+ChromeUtils.defineModuleGetter(this, &quot;PlacesUIUtils&quot;,</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+  &quot;resource:///modules/PlacesUIUtils.jsm&quot;);</span>
<a href="#l4.14"></a><span id="l4.14"> </span>
<a href="#l4.15"></a><span id="l4.15"> addMessageListener(&quot;RemoteLogins:fillForm&quot;, message =&gt; {</span>
<a href="#l4.16"></a><span id="l4.16">   LoginManagerContent.receiveMessage(message, content);</span>
<a href="#l4.17"></a><span id="l4.17"> });</span>
<a href="#l4.18"></a><span id="l4.18"> </span>
<a href="#l4.19"></a><span id="l4.19"> addEventListener(&quot;DOMFormHasPassword&quot;, event =&gt; {</span>
<a href="#l4.20"></a><span id="l4.20">   LoginManagerContent.onDOMFormHasPassword(event, content);</span>
<a href="#l4.21"></a><span id="l4.21">   let formLike = LoginFormFactory.createFromForm(event.target);</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineat">@@ -37,8 +39,16 @@ addEventListener(&quot;pageshow&quot;, event =&gt; {</span>
<a href="#l4.23"></a><span id="l4.23"> </span>
<a href="#l4.24"></a><span id="l4.24"> addEventListener(&quot;DOMAutoComplete&quot;, event =&gt; {</span>
<a href="#l4.25"></a><span id="l4.25">   LoginManagerContent.onUsernameInput(event);</span>
<a href="#l4.26"></a><span id="l4.26"> });</span>
<a href="#l4.27"></a><span id="l4.27"> </span>
<a href="#l4.28"></a><span id="l4.28"> addEventListener(&quot;blur&quot;, event =&gt; {</span>
<a href="#l4.29"></a><span id="l4.29">   LoginManagerContent.onUsernameInput(event);</span>
<a href="#l4.30"></a><span id="l4.30"> });</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineplus">+</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineplus">+addMessageListener(&quot;Bookmarks:GetPageDetails&quot;, (message) =&gt; {</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineplus">+  let doc = content.document;</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineplus">+  let isErrorPage = /^about:(neterror|certerror|blocked)/.test(doc.documentURI);</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineplus">+  sendAsyncMessage(&quot;Bookmarks:GetPageDetails:Result&quot;,</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineplus">+                   { isErrorPage,</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineplus">+                     description: PlacesUIUtils.getDescriptionFromDocument(doc) });</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/suite/browser/jar.mn</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/suite/browser/jar.mn</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -1,16 +1,17 @@</span>
<a href="#l5.4"></a><span id="l5.4"> # This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l5.5"></a><span id="l5.5"> # License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l5.6"></a><span id="l5.6"> # file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l5.7"></a><span id="l5.7"> </span>
<a href="#l5.8"></a><span id="l5.8"> comm.jar:</span>
<a href="#l5.9"></a><span id="l5.9"> % content navigator %content/navigator/</span>
<a href="#l5.10"></a><span id="l5.10"> % content navigator-region %content/navigator-region/</span>
<a href="#l5.11"></a><span id="l5.11">    content/navigator/browser.js</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+   content/navigator/browser-places.js</span>
<a href="#l5.13"></a><span id="l5.13">    content/navigator/content.js</span>
<a href="#l5.14"></a><span id="l5.14">    content/navigator/fullScreen.js</span>
<a href="#l5.15"></a><span id="l5.15">    content/navigator/hiddenWindow.xul</span>
<a href="#l5.16"></a><span id="l5.16">    content/navigator/linkToolbarHandler.js</span>
<a href="#l5.17"></a><span id="l5.17">    content/navigator/linkToolbarItem.js</span>
<a href="#l5.18"></a><span id="l5.18">    content/navigator/linkToolbarOverlay.js</span>
<a href="#l5.19"></a><span id="l5.19">    content/navigator/linkToolbarOverlay.xul</span>
<a href="#l5.20"></a><span id="l5.20">    content/navigator/mailNavigatorOverlay.js</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/suite/browser/navigator.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/suite/browser/navigator.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -14,16 +14,19 @@ this.__defineGetter__(&quot;PluralForm&quot;, func</span>
<a href="#l6.4"></a><span id="l6.4"> });</span>
<a href="#l6.5"></a><span id="l6.5"> this.__defineSetter__(&quot;PluralForm&quot;, function (val) {</span>
<a href="#l6.6"></a><span id="l6.6">   delete this.PluralForm;</span>
<a href="#l6.7"></a><span id="l6.7">   return this.PluralForm = val;</span>
<a href="#l6.8"></a><span id="l6.8"> });</span>
<a href="#l6.9"></a><span id="l6.9"> </span>
<a href="#l6.10"></a><span id="l6.10"> ChromeUtils.defineModuleGetter(this, &quot;SafeBrowsing&quot;,</span>
<a href="#l6.11"></a><span id="l6.11">   &quot;resource://gre/modules/SafeBrowsing.jsm&quot;);</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+  </span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+XPCOMUtils.defineLazyScriptGetter(this, &quot;gEditItemOverlay&quot;,</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+                                  &quot;chrome://communicator/content/places/editBookmarkOverlay.js&quot;);</span>
<a href="#l6.15"></a><span id="l6.15"> </span>
<a href="#l6.16"></a><span id="l6.16"> const REMOTESERVICE_CONTRACTID = &quot;@mozilla.org/toolkit/remote-service;1&quot;;</span>
<a href="#l6.17"></a><span id="l6.17"> const XUL_NS = &quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;;</span>
<a href="#l6.18"></a><span id="l6.18"> </span>
<a href="#l6.19"></a><span id="l6.19"> var gURLBar = null;</span>
<a href="#l6.20"></a><span id="l6.20"> var gProxyButton = null;</span>
<a href="#l6.21"></a><span id="l6.21"> var gProxyFavIcon = null;</span>
<a href="#l6.22"></a><span id="l6.22"> var gProxyDeck = null;</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineat">@@ -866,17 +869,17 @@ function WindowFocusTimerCallback(elemen</span>
<a href="#l6.24"></a><span id="l6.24">     }</span>
<a href="#l6.25"></a><span id="l6.25">   }</span>
<a href="#l6.26"></a><span id="l6.26"> }</span>
<a href="#l6.27"></a><span id="l6.27"> </span>
<a href="#l6.28"></a><span id="l6.28"> function Shutdown()</span>
<a href="#l6.29"></a><span id="l6.29"> {</span>
<a href="#l6.30"></a><span id="l6.30">   AeroPeek.onCloseWindow(window);</span>
<a href="#l6.31"></a><span id="l6.31"> </span>
<a href="#l6.32"></a><span id="l6.32" class="difflineminus">-  PlacesStarButton.uninit();</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineplus">+  BookmarkingUI.uninit();</span>
<a href="#l6.34"></a><span id="l6.34"> </span>
<a href="#l6.35"></a><span id="l6.35">   // shut down browser access support</span>
<a href="#l6.36"></a><span id="l6.36">   window.browserDOMWindow = null;</span>
<a href="#l6.37"></a><span id="l6.37"> </span>
<a href="#l6.38"></a><span id="l6.38">   getBrowser().removeEventListener(&quot;DOMLinkAdded&quot;, BrowserSearch);</span>
<a href="#l6.39"></a><span id="l6.39"> </span>
<a href="#l6.40"></a><span id="l6.40">   try {</span>
<a href="#l6.41"></a><span id="l6.41">     getBrowser().removeProgressListener(window.XULBrowserWindow);</span>
<a href="#l6.42"></a><span id="l6.42" class="difflineat">@@ -2592,21 +2595,16 @@ function StatusbarViewPopupManager()</span>
<a href="#l6.43"></a><span id="l6.43"> function popupBlockerMenuShowing(event)</span>
<a href="#l6.44"></a><span id="l6.44"> {</span>
<a href="#l6.45"></a><span id="l6.45">   var separator = document.getElementById(&quot;popupMenuSeparator&quot;);</span>
<a href="#l6.46"></a><span id="l6.46"> </span>
<a href="#l6.47"></a><span id="l6.47">   if (separator)</span>
<a href="#l6.48"></a><span id="l6.48">     separator.hidden = !createShowPopupsMenu(event.target, gBrowser.selectedBrowser);</span>
<a href="#l6.49"></a><span id="l6.49"> }</span>
<a href="#l6.50"></a><span id="l6.50"> </span>
<a href="#l6.51"></a><span id="l6.51" class="difflineminus">-function toHistory()</span>
<a href="#l6.52"></a><span id="l6.52" class="difflineminus">-{</span>
<a href="#l6.53"></a><span id="l6.53" class="difflineminus">-  toOpenWindowByType(&quot;history:manager&quot;, &quot;chrome://communicator/content/history/history.xul&quot;);</span>
<a href="#l6.54"></a><span id="l6.54" class="difflineminus">-}</span>
<a href="#l6.55"></a><span id="l6.55" class="difflineminus">-</span>
<a href="#l6.56"></a><span id="l6.56"> // opener may not have been initialized by load time (chrome windows only)</span>
<a href="#l6.57"></a><span id="l6.57"> // so call this function some time later.</span>
<a href="#l6.58"></a><span id="l6.58"> function maybeInitPopupContext()</span>
<a href="#l6.59"></a><span id="l6.59"> {</span>
<a href="#l6.60"></a><span id="l6.60">   // it's not a popup with no opener</span>
<a href="#l6.61"></a><span id="l6.61">   if (!window.content.opener)</span>
<a href="#l6.62"></a><span id="l6.62">     return null;</span>
<a href="#l6.63"></a><span id="l6.63"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/suite/browser/navigator.xul</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/suite/browser/navigator.xul</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -52,17 +52,18 @@</span>
<a href="#l7.4"></a><span id="l7.4">   &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://global/content/printUtils.js&quot;/&gt;</span>
<a href="#l7.5"></a><span id="l7.5"> </span>
<a href="#l7.6"></a><span id="l7.6">   &lt;!-- Navigator --&gt;</span>
<a href="#l7.7"></a><span id="l7.7">   &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://navigator/content/fullScreen.js&quot;/&gt;</span>
<a href="#l7.8"></a><span id="l7.8">   &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://navigator/content/navigatorDD.js&quot;/&gt;</span>
<a href="#l7.9"></a><span id="l7.9">   &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://navigator/content/sessionHistoryUI.js&quot;/&gt;</span>
<a href="#l7.10"></a><span id="l7.10"> </span>
<a href="#l7.11"></a><span id="l7.11">   &lt;!-- Places Bookmarks Utilities --&gt;</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-  &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://communicator/content/bookmarks/editBookmarkOverlay.js&quot;/&gt;</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+  &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+          src=&quot;chrome://navigator/content/browser-places.js&quot;/&gt;</span>
<a href="#l7.15"></a><span id="l7.15"> </span>
<a href="#l7.16"></a><span id="l7.16">   &lt;!-- hook for stringbundle overlays --&gt;</span>
<a href="#l7.17"></a><span id="l7.17">   &lt;stringbundleset id=&quot;stringbundleset&quot;&gt;</span>
<a href="#l7.18"></a><span id="l7.18">     &lt;stringbundle id=&quot;findBundle&quot; src=&quot;chrome://global/locale/finddialog.properties&quot;/&gt;</span>
<a href="#l7.19"></a><span id="l7.19">   &lt;/stringbundleset&gt;</span>
<a href="#l7.20"></a><span id="l7.20"> </span>
<a href="#l7.21"></a><span id="l7.21">   &lt;commandset id=&quot;commands&quot;&gt;</span>
<a href="#l7.22"></a><span id="l7.22">     &lt;commandset id=&quot;findTypeMenuItems&quot;/&gt;</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineat">@@ -113,17 +114,48 @@</span>
<a href="#l7.24"></a><span id="l7.24">            noautofocus=&quot;true&quot;</span>
<a href="#l7.25"></a><span id="l7.25">            hidden=&quot;true&quot;/&gt;</span>
<a href="#l7.26"></a><span id="l7.26"> </span>
<a href="#l7.27"></a><span id="l7.27">     &lt;!-- for invalid form error message --&gt;</span>
<a href="#l7.28"></a><span id="l7.28">     &lt;panel id=&quot;invalid-form-popup&quot; noautofocus=&quot;true&quot; hidden=&quot;true&quot; level=&quot;parent&quot;&gt;</span>
<a href="#l7.29"></a><span id="l7.29">       &lt;description/&gt;</span>
<a href="#l7.30"></a><span id="l7.30">     &lt;/panel&gt;</span>
<a href="#l7.31"></a><span id="l7.31"> </span>
<a href="#l7.32"></a><span id="l7.32" class="difflineminus">-    &lt;panel id=&quot;editBookmarkPanel&quot;/&gt;</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineplus">+    &lt;panel id=&quot;editBookmarkPanel&quot;</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineplus">+           type=&quot;arrow&quot;</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineplus">+           animate=&quot;false&quot;</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineplus">+           orient=&quot;vertical&quot;</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineplus">+           ignorekeys=&quot;true&quot;</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineplus">+           hidden=&quot;true&quot;</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineplus">+           onpopupshown=&quot;StarUI.panelShown(event);&quot;</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineplus">+           aria-labelledby=&quot;editBookmarkPanelTitle&quot;&gt;</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineplus">+      &lt;row id=&quot;editBookmarkPanelHeader&quot; align=&quot;center&quot; hidden=&quot;true&quot;&gt;</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineplus">+        &lt;vbox align=&quot;center&quot;&gt;</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineplus">+          &lt;image id=&quot;editBookmarkPanelStarIcon&quot;/&gt;</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineplus">+        &lt;/vbox&gt;</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineplus">+        &lt;label id=&quot;editBookmarkPanelTitle&quot;/&gt;</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineplus">+      &lt;/row&gt;</span>
<a href="#l7.47"></a><span id="l7.47" class="difflineplus">+      &lt;vbox id=&quot;editBookmarkPanelContent&quot; hidden=&quot;true&quot;/&gt;</span>
<a href="#l7.48"></a><span id="l7.48" class="difflineplus">+      &lt;hbox id=&quot;editBookmarkPanelBottomButtons&quot;&gt;</span>
<a href="#l7.49"></a><span id="l7.49" class="difflineplus">+        &lt;button id=&quot;editBookmarkPanelRemoveButton&quot;</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineplus">+                class=&quot;editBookmarkPanelHeaderButton&quot;</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineplus">+                oncommand=&quot;StarUI.removeBookmarkButtonCommand();&quot;</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineplus">+                accesskey=&quot;&amp;editBookmark.removeBookmark.accessKey;&quot;/&gt;</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineplus">+        &lt;spacer flex=&quot;1&quot;/&gt;</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineplus">+        &lt;button id=&quot;editBookmarkPanelDeleteButton&quot;</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineplus">+                class=&quot;editBookmarkPanelBottomButton&quot;</span>
<a href="#l7.56"></a><span id="l7.56" class="difflineplus">+                label=&quot;&amp;editBookmark.cancel.label;&quot;</span>
<a href="#l7.57"></a><span id="l7.57" class="difflineplus">+                oncommand=&quot;StarUI.cancelButtonOnCommand();&quot;/&gt;</span>
<a href="#l7.58"></a><span id="l7.58" class="difflineplus">+        &lt;button id=&quot;editBookmarkPanelDoneButton&quot;</span>
<a href="#l7.59"></a><span id="l7.59" class="difflineplus">+                class=&quot;editBookmarkPanelBottomButton&quot;</span>
<a href="#l7.60"></a><span id="l7.60" class="difflineplus">+                label=&quot;&amp;editBookmark.done.label;&quot;</span>
<a href="#l7.61"></a><span id="l7.61" class="difflineplus">+                default=&quot;true&quot;</span>
<a href="#l7.62"></a><span id="l7.62" class="difflineplus">+                oncommand=&quot;StarUI.panel.hidePopup();&quot;/&gt;</span>
<a href="#l7.63"></a><span id="l7.63" class="difflineplus">+      &lt;/hbox&gt;</span>
<a href="#l7.64"></a><span id="l7.64" class="difflineplus">+    &lt;/panel&gt;</span>
<a href="#l7.65"></a><span id="l7.65"> </span>
<a href="#l7.66"></a><span id="l7.66">     &lt;menupopup id=&quot;placesContext&quot;/&gt;</span>
<a href="#l7.67"></a><span id="l7.67"> </span>
<a href="#l7.68"></a><span id="l7.68">     &lt;!-- Bookmarks and history tooltip --&gt;</span>
<a href="#l7.69"></a><span id="l7.69">     &lt;tooltip id=&quot;bhTooltip&quot;/&gt;</span>
<a href="#l7.70"></a><span id="l7.70"> </span>
<a href="#l7.71"></a><span id="l7.71">     &lt;panel id=&quot;notification-popup&quot;</span>
<a href="#l7.72"></a><span id="l7.72">            type=&quot;arrow&quot;</span>
<a href="#l7.73"></a><span id="l7.73" class="difflineat">@@ -327,17 +359,17 @@</span>
<a href="#l7.74"></a><span id="l7.74">           &lt;/deck&gt;</span>
<a href="#l7.75"></a><span id="l7.75">           &lt;hbox id=&quot;urlbar-icons&quot; class=&quot;urlbar-icons&quot;</span>
<a href="#l7.76"></a><span id="l7.76">                 onmousedown=&quot;event.stopPropagation();&quot;</span>
<a href="#l7.77"></a><span id="l7.77">                 onclick=&quot;event.stopPropagation();&quot;&gt;</span>
<a href="#l7.78"></a><span id="l7.78">             &lt;image id=&quot;feedsButton&quot; hidden=&quot;true&quot; popup=&quot;feedsPopup&quot;/&gt;</span>
<a href="#l7.79"></a><span id="l7.79">             &lt;image id=&quot;ev-button&quot; hidden=&quot;true&quot;</span>
<a href="#l7.80"></a><span id="l7.80">                    onclick=&quot;if (event.button == 0) BrowserPageInfo(null, 'securityTab');&quot;/&gt;</span>
<a href="#l7.81"></a><span id="l7.81">             &lt;image id=&quot;star-button&quot;</span>
<a href="#l7.82"></a><span id="l7.82" class="difflineminus">-                   onclick=&quot;PlacesStarButton.onClick(event);&quot;/&gt;</span>
<a href="#l7.83"></a><span id="l7.83" class="difflineplus">+                   onclick=&quot;BookmarkingUI.onClick(event);&quot;/&gt;</span>
<a href="#l7.84"></a><span id="l7.84">           &lt;/hbox&gt;</span>
<a href="#l7.85"></a><span id="l7.85">           &lt;menupopup id=&quot;ubhist-popup&quot; class=&quot;autocomplete-history-popup&quot;</span>
<a href="#l7.86"></a><span id="l7.86">                      popupalign=&quot;topleft&quot; popupanchor=&quot;bottomleft&quot;</span>
<a href="#l7.87"></a><span id="l7.87">                      onpopupshowing=&quot;createUBHistoryMenu(event.target);&quot;</span>
<a href="#l7.88"></a><span id="l7.88">                      oncommand=&quot;executeUrlBarHistoryCommand(event.target);&quot;/&gt;</span>
<a href="#l7.89"></a><span id="l7.89">         &lt;/textbox&gt;</span>
<a href="#l7.90"></a><span id="l7.90">       &lt;/toolbaritem&gt;</span>
<a href="#l7.91"></a><span id="l7.91"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/suite/browser/navigatorOverlay.xul</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/suite/browser/navigatorOverlay.xul</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -2,17 +2,17 @@</span>
<a href="#l8.4"></a><span id="l8.4"> &lt;!-- This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l8.5"></a><span id="l8.5">    - License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l8.6"></a><span id="l8.6">    - file, You can obtain one at http://mozilla.org/MPL/2.0/. --&gt;</span>
<a href="#l8.7"></a><span id="l8.7"> </span>
<a href="#l8.8"></a><span id="l8.8"> &lt;?xul-overlay href=&quot;chrome://communicator/content/utilityOverlay.xul&quot;?&gt;</span>
<a href="#l8.9"></a><span id="l8.9"> &lt;?xul-overlay href=&quot;chrome://communicator/content/viewZoomOverlay.xul&quot;?&gt;</span>
<a href="#l8.10"></a><span id="l8.10"> &lt;?xul-overlay href=&quot;chrome://communicator/content/viewApplyThemeOverlay.xul&quot;?&gt;</span>
<a href="#l8.11"></a><span id="l8.11"> &lt;?xul-overlay href=&quot;chrome://communicator/content/tasksOverlay.xul&quot;?&gt;</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-&lt;?xul-overlay href=&quot;chrome://communicator/content/bookmarks/placesOverlay.xul&quot;?&gt;</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+&lt;?xul-overlay href=&quot;chrome://communicator/content/places/placesOverlay.xul&quot;?&gt;</span>
<a href="#l8.14"></a><span id="l8.14"> &lt;?xul-overlay href=&quot;chrome://communicator/content/charsetOverlay.xul&quot;?&gt;</span>
<a href="#l8.15"></a><span id="l8.15"> &lt;?xul-overlay href=&quot;chrome://navigator/content/mailNavigatorOverlay.xul&quot;?&gt;</span>
<a href="#l8.16"></a><span id="l8.16"> &lt;?xul-overlay href=&quot;chrome://navigator/content/platformNavigationBindings.xul&quot;?&gt;</span>
<a href="#l8.17"></a><span id="l8.17"> </span>
<a href="#l8.18"></a><span id="l8.18"> &lt;!DOCTYPE overlay [</span>
<a href="#l8.19"></a><span id="l8.19"> &lt;!ENTITY % navigatorDTD SYSTEM &quot;chrome://navigator/locale/navigator.dtd&quot; &gt;</span>
<a href="#l8.20"></a><span id="l8.20"> %navigatorDTD;</span>
<a href="#l8.21"></a><span id="l8.21"> &lt;!ENTITY % navigatorOverlayDTD SYSTEM &quot;chrome://navigator/locale/navigatorOverlay.dtd&quot;&gt;</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineat">@@ -28,19 +28,17 @@</span>
<a href="#l8.23"></a><span id="l8.23">   &lt;!-- Navigator --&gt;</span>
<a href="#l8.24"></a><span id="l8.24">   &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l8.25"></a><span id="l8.25">           src=&quot;chrome://navigator/content/browser.js&quot;/&gt;</span>
<a href="#l8.26"></a><span id="l8.26">   &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l8.27"></a><span id="l8.27">           src=&quot;chrome://navigator/content/navigator.js&quot;/&gt;</span>
<a href="#l8.28"></a><span id="l8.28"> </span>
<a href="#l8.29"></a><span id="l8.29">   &lt;!-- Places Bookmarks Utilities --&gt;</span>
<a href="#l8.30"></a><span id="l8.30">   &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineminus">-          src=&quot;chrome://communicator/content/places/browserPlacesViews.js&quot;/&gt;</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineminus">-  &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineminus">-          src=&quot;chrome://communicator/content/bookmarks/browser-places.js&quot;/&gt;</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineplus">+          src=&quot;chrome://navigator/content/browser-places.js&quot;/&gt;</span>
<a href="#l8.35"></a><span id="l8.35"> </span>
<a href="#l8.36"></a><span id="l8.36">   &lt;stringbundleset id=&quot;stringbundleset&quot;&gt;</span>
<a href="#l8.37"></a><span id="l8.37">     &lt;stringbundle id=&quot;bundle_navigator&quot;</span>
<a href="#l8.38"></a><span id="l8.38">                   src=&quot;chrome://navigator/locale/navigator.properties&quot;/&gt;</span>
<a href="#l8.39"></a><span id="l8.39">     &lt;stringbundle id=&quot;bundle_brand&quot;</span>
<a href="#l8.40"></a><span id="l8.40">                   src=&quot;chrome://branding/locale/brand.properties&quot;/&gt;</span>
<a href="#l8.41"></a><span id="l8.41">     &lt;stringbundle id=&quot;bundle_navigator_region&quot;</span>
<a href="#l8.42"></a><span id="l8.42">                   src=&quot;chrome://navigator-region/locale/region.properties&quot;/&gt;</span>
<a href="#l8.43"></a><span id="l8.43" class="difflineat">@@ -102,17 +100,20 @@</span>
<a href="#l8.44"></a><span id="l8.44"> </span>
<a href="#l8.45"></a><span id="l8.45">     &lt;!-- Tools Menu --&gt;</span>
<a href="#l8.46"></a><span id="l8.46">     &lt;key id=&quot;searchInternetKb&quot; key=&quot;&amp;searchInternet.commandKey;&quot; modifiers=&quot;accel,shift&quot; command=&quot;Browser:SearchInternet&quot;/&gt;</span>
<a href="#l8.47"></a><span id="l8.47"> </span>
<a href="#l8.48"></a><span id="l8.48">     &lt;!-- Misc --&gt;</span>
<a href="#l8.49"></a><span id="l8.49">     &lt;!-- the amazing fishcam, suppress warning by ',' at the beginning of modifiers, see bug 496322 --&gt;</span>
<a href="#l8.50"></a><span id="l8.50">     &lt;key key=&quot;f&quot; modifiers=&quot;,control,alt&quot; oncommand=&quot;loadURI('http://www.fishcam.com/');&quot;/&gt;</span>
<a href="#l8.51"></a><span id="l8.51">     &lt;key id=&quot;goUpKb&quot; keycode=&quot;VK_UP&quot; command=&quot;Browser:Up&quot; modifiers=&quot;alt&quot;/&gt;</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineminus">-    &lt;key id=&quot;key_gotoHistory&quot;  key=&quot;&amp;history.commandKey;&quot;        oncommand=&quot;toHistory();&quot; modifiers=&quot;accel&quot;/&gt;</span>
<a href="#l8.53"></a><span id="l8.53" class="difflineplus">+    &lt;key id=&quot;key_gotoHistory&quot;</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineplus">+         key=&quot;&amp;history.commandKey;&quot;</span>
<a href="#l8.55"></a><span id="l8.55" class="difflineplus">+         oncommand=&quot;PlacesCommandHook.showPlacesOrganizer('History');&quot;</span>
<a href="#l8.56"></a><span id="l8.56" class="difflineplus">+         modifiers=&quot;accel&quot;/&gt;</span>
<a href="#l8.57"></a><span id="l8.57">     &lt;keyset id=&quot;viewZoomKeys&quot;/&gt;</span>
<a href="#l8.58"></a><span id="l8.58">     &lt;keyset id=&quot;navigationKeys&quot;/&gt;</span>
<a href="#l8.59"></a><span id="l8.59">     &lt;keyset id=&quot;tasksKeys&quot;/&gt;</span>
<a href="#l8.60"></a><span id="l8.60">     &lt;key id=&quot;key_sanitize&quot; command=&quot;Tools:Sanitize&quot; keycode=&quot;VK_DELETE&quot; modifiers=&quot;accel,shift&quot;/&gt;</span>
<a href="#l8.61"></a><span id="l8.61">   &lt;/keyset&gt;</span>
<a href="#l8.62"></a><span id="l8.62"> </span>
<a href="#l8.63"></a><span id="l8.63">   &lt;commandset id=&quot;commands&quot;&gt;</span>
<a href="#l8.64"></a><span id="l8.64">     &lt;command id=&quot;cmd_newNavigatorTab&quot; oncommand=&quot;BrowserOpenTab();&quot;/&gt;</span>
<a href="#l8.65"></a><span id="l8.65" class="difflineat">@@ -176,26 +177,26 @@</span>
<a href="#l8.66"></a><span id="l8.66">     &lt;command id=&quot;cmd_findTypeLinks&quot; observes=&quot;isImage&quot;/&gt;</span>
<a href="#l8.67"></a><span id="l8.67"> </span>
<a href="#l8.68"></a><span id="l8.68">     &lt;!-- Bookmarks Menu --&gt;</span>
<a href="#l8.69"></a><span id="l8.69">     &lt;command id=&quot;Browser:AddBookmark&quot;</span>
<a href="#l8.70"></a><span id="l8.70">              label=&quot;&amp;addCurPageCmd.label;&quot; accesskey=&quot;&amp;addCurPageCmd.accesskey;&quot;</span>
<a href="#l8.71"></a><span id="l8.71">              oncommand=&quot;PlacesCommandHook.bookmarkCurrentPage(false, PlacesUtils.bookmarksMenuFolderId);&quot;/&gt;</span>
<a href="#l8.72"></a><span id="l8.72">     &lt;command id=&quot;Browser:AddBookmarkAs&quot;</span>
<a href="#l8.73"></a><span id="l8.73">              label=&quot;&amp;addCurPageAsCmd.label;&quot; accesskey=&quot;&amp;addCurPageAsCmd.accesskey;&quot;</span>
<a href="#l8.74"></a><span id="l8.74" class="difflineminus">-             oncommand=&quot;PlacesCommandHook.bookmarkPageAs(gBrowser.selectedBrowser, PlacesUtils.bookmarksMenuFolderId);&quot;/&gt;</span>
<a href="#l8.75"></a><span id="l8.75" class="difflineplus">+             oncommand=&quot;PlacesCommandHook.bookmarkPage(gBrowser.selectedBrowser, PlacesUtils.bookmarksMenuFolderId, true);&quot;/&gt;</span>
<a href="#l8.76"></a><span id="l8.76">     &lt;!-- The command is disabled for the hidden window. Otherwise its enabled</span>
<a href="#l8.77"></a><span id="l8.77">          state is handled by BookmarksEventHandler.onPopupShowing. --&gt;</span>
<a href="#l8.78"></a><span id="l8.78">     &lt;command id=&quot;Browser:BookmarkAllTabs&quot;</span>
<a href="#l8.79"></a><span id="l8.79">              label=&quot;&amp;addCurTabsAsCmd.label;&quot; accesskey=&quot;&amp;addCurTabsAsCmd.accesskey;&quot;</span>
<a href="#l8.80"></a><span id="l8.80">              oncommand=&quot;PlacesCommandHook.bookmarkCurrentPages();&quot;</span>
<a href="#l8.81"></a><span id="l8.81">              disabled=&quot;true&quot;/&gt;</span>
<a href="#l8.82"></a><span id="l8.82">     &lt;command id=&quot;Browser:ManageBookmark&quot;</span>
<a href="#l8.83"></a><span id="l8.83">              label=&quot;&amp;manBookmarksCmd.label;&quot; accesskey=&quot;&amp;manBookmarksCmd.accesskey;&quot;</span>
<a href="#l8.84"></a><span id="l8.84" class="difflineminus">-             oncommand=&quot;PlacesCommandHook.showBookmarksManager('AllBookmarks');&quot;/&gt;</span>
<a href="#l8.85"></a><span id="l8.85" class="difflineplus">+             oncommand=&quot;PlacesCommandHook.showPlacesOrganizer('AllBookmarks');&quot;/&gt;</span>
<a href="#l8.86"></a><span id="l8.86">     &lt;command id=&quot;feedsMenu&quot; disabled=&quot;true&quot;/&gt;</span>
<a href="#l8.87"></a><span id="l8.87">     &lt;commandset id=&quot;placesCommands&quot;/&gt;</span>
<a href="#l8.88"></a><span id="l8.88"> </span>
<a href="#l8.89"></a><span id="l8.89">     &lt;!-- Go Menu --&gt;</span>
<a href="#l8.90"></a><span id="l8.90">     &lt;command id=&quot;Browser:Home&quot;    oncommand=&quot;BrowserHome(event);&quot;/&gt;</span>
<a href="#l8.91"></a><span id="l8.91">     &lt;command id=&quot;Browser:Back&quot;    oncommand=&quot;BrowserBack();&quot;    observes=&quot;canGoBack&quot;/&gt;</span>
<a href="#l8.92"></a><span id="l8.92">     &lt;command id=&quot;Browser:Forward&quot; oncommand=&quot;BrowserForward();&quot; observes=&quot;canGoForward&quot;/&gt;</span>
<a href="#l8.93"></a><span id="l8.93">     &lt;command id=&quot;Browser:Up&quot;      oncommand=&quot;BrowserUp();&quot;      observes=&quot;canGoUp&quot;/&gt;</span>
<a href="#l8.94"></a><span id="l8.94" class="difflineat">@@ -438,17 +439,17 @@</span>
<a href="#l8.95"></a><span id="l8.95">                   label=&quot;&amp;historyRestoreLastSession.label;&quot;</span>
<a href="#l8.96"></a><span id="l8.96">                   accesskey=&quot;&amp;historyRestoreLastSession.accesskey;&quot;</span>
<a href="#l8.97"></a><span id="l8.97">                   oncommand=&quot;restoreLastSession();&quot;</span>
<a href="#l8.98"></a><span id="l8.98">                   disabled=&quot;true&quot;/&gt;</span>
<a href="#l8.99"></a><span id="l8.99">         &lt;menuseparator/&gt;</span>
<a href="#l8.100"></a><span id="l8.100">         &lt;menuitem id=&quot;menu_showAllHistory&quot;</span>
<a href="#l8.101"></a><span id="l8.101">                   label=&quot;&amp;historyCmd.label;&quot;</span>
<a href="#l8.102"></a><span id="l8.102">                   accesskey=&quot;&amp;historyCmd.accesskey;&quot;</span>
<a href="#l8.103"></a><span id="l8.103" class="difflineminus">-                  oncommand=&quot;toHistory()&quot;</span>
<a href="#l8.104"></a><span id="l8.104" class="difflineplus">+                  oncommand=&quot;PlacesCommandHook.showPlacesOrganizer('History');&quot;</span>
<a href="#l8.105"></a><span id="l8.105">                   key=&quot;key_gotoHistory&quot;/&gt;</span>
<a href="#l8.106"></a><span id="l8.106">         &lt;menuseparator id=&quot;startHistorySeparator&quot; hidden=&quot;true&quot;/&gt;</span>
<a href="#l8.107"></a><span id="l8.107">         &lt;menuseparator id=&quot;endHistorySeparator&quot; hidden=&quot;true&quot;/&gt;</span>
<a href="#l8.108"></a><span id="l8.108">         &lt;!-- Dead for now.</span>
<a href="#l8.109"></a><span id="l8.109">         &lt;menuitem id=&quot;sync-tabs-menuitem&quot;</span>
<a href="#l8.110"></a><span id="l8.110">                   label=&quot;&amp;syncTabsMenu.label;&quot;</span>
<a href="#l8.111"></a><span id="l8.111">                   oncommand=&quot;BrowserOpenSyncTabs();&quot;</span>
<a href="#l8.112"></a><span id="l8.112">                   disabled=&quot;true&quot;/&gt; --&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/suite/browser/nsBrowserStatusHandler.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/suite/browser/nsBrowserStatusHandler.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -328,17 +328,17 @@ nsBrowserStatusHandler.prototype =</span>
<a href="#l9.4"></a><span id="l9.4">       var userTypedValue = browser.userTypedValue;</span>
<a href="#l9.5"></a><span id="l9.5">       if (userTypedValue === null) {</span>
<a href="#l9.6"></a><span id="l9.6">         URLBarSetURI(aLocation, true);</span>
<a href="#l9.7"></a><span id="l9.7">       } else {</span>
<a href="#l9.8"></a><span id="l9.8">         this.urlBar.value = userTypedValue;</span>
<a href="#l9.9"></a><span id="l9.9">         SetPageProxyState(&quot;invalid&quot;, null);</span>
<a href="#l9.10"></a><span id="l9.10">       }</span>
<a href="#l9.11"></a><span id="l9.11"> </span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-      PlacesStarButton.updateStarState();</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+      BookmarkingUI.updateStarState();</span>
<a href="#l9.14"></a><span id="l9.14"> </span>
<a href="#l9.15"></a><span id="l9.15">       this.feedsMenu.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l9.16"></a><span id="l9.16">       this.feedsButton.hidden = true;</span>
<a href="#l9.17"></a><span id="l9.17">       this.feeds = [];</span>
<a href="#l9.18"></a><span id="l9.18"> </span>
<a href="#l9.19"></a><span id="l9.19">       // When background tab comes into foreground or loading a new page</span>
<a href="#l9.20"></a><span id="l9.20">       // (aRequest set), might want to update zoom.</span>
<a href="#l9.21"></a><span id="l9.21">       if (FullZoom.updateBackgroundTabs || aRequest)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/suite/common/jar.mn</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/suite/common/jar.mn</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -114,31 +114,16 @@ comm.jar:</span>
<a href="#l10.4"></a><span id="l10.4">    content/communicator/bindings/findbar.xml                        (bindings/findbar.xml)</span>
<a href="#l10.5"></a><span id="l10.5">    content/communicator/bindings/general.xml                        (bindings/general.xml)</span>
<a href="#l10.6"></a><span id="l10.6">    content/communicator/bindings/generalBindings.xml                (../../common/bindings/generalBindings.xml)</span>
<a href="#l10.7"></a><span id="l10.7">    content/communicator/bindings/notification.xml                   (bindings/notification.xml)</span>
<a href="#l10.8"></a><span id="l10.8"> *  content/communicator/bindings/preferences.xml                    (../../common/bindings/preferences.xml)</span>
<a href="#l10.9"></a><span id="l10.9"> *  content/communicator/bindings/toolbar.xml                        (../../common/bindings/toolbar.xml)   </span>
<a href="#l10.10"></a><span id="l10.10">    content/communicator/bindings/toolbar-xpfe.xml                   (bindings/toolbar-xpfe.xml)</span>
<a href="#l10.11"></a><span id="l10.11"> *  content/communicator/bindings/prefwindow.xml                     (bindings/prefwindow.xml)</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-   content/communicator/bookmarks/bm-panel.js                       (bookmarks/bm-panel.js)</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineminus">-   content/communicator/bookmarks/bm-panel.xul                      (bookmarks/bm-panel.xul)</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineminus">-   content/communicator/bookmarks/bm-props.js                       (bookmarks/bm-props.js)</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineminus">-   content/communicator/bookmarks/bm-props.xul                      (bookmarks/bm-props.xul)</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineminus">-# Provide another URI for the bookmark properties dialog so we can persist the attributes separately</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineminus">-% override chrome://communicator/content/bookmarks/bm-props2.xul chrome://communicator/content/bookmarks/bm-props.xul</span>
<a href="#l10.18"></a><span id="l10.18" class="difflineminus">-   content/communicator/bookmarks/bookmarksManager.css              (bookmarks/bookmarksManager.css)</span>
<a href="#l10.19"></a><span id="l10.19" class="difflineminus">-   content/communicator/bookmarks/bookmarksManager.js               (bookmarks/bookmarksManager.js)</span>
<a href="#l10.20"></a><span id="l10.20" class="difflineminus">-   content/communicator/bookmarks/bookmarksManager.xul              (bookmarks/bookmarksManager.xul)</span>
<a href="#l10.21"></a><span id="l10.21" class="difflineminus">-   content/communicator/bookmarks/browser-places.js                 (bookmarks/browser-places.js)</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineminus">-   content/communicator/bookmarks/editBookmarkOverlay.js            (bookmarks/editBookmarkOverlay.js)</span>
<a href="#l10.23"></a><span id="l10.23" class="difflineminus">-   content/communicator/bookmarks/editBookmarkOverlay.xul           (bookmarks/editBookmarkOverlay.xul)</span>
<a href="#l10.24"></a><span id="l10.24" class="difflineminus">-   content/communicator/bookmarks/moveBookmarks.js                  (bookmarks/moveBookmarks.js)</span>
<a href="#l10.25"></a><span id="l10.25" class="difflineminus">-   content/communicator/bookmarks/moveBookmarks.xul                 (bookmarks/moveBookmarks.xul)</span>
<a href="#l10.26"></a><span id="l10.26" class="difflineminus">-   content/communicator/bookmarks/placesOverlay.xul                 (bookmarks/placesOverlay.xul)</span>
<a href="#l10.27"></a><span id="l10.27">    content/communicator/console/consoleBindings.xml                 (console/consoleBindings.xml)</span>
<a href="#l10.28"></a><span id="l10.28">    content/communicator/console/console.css                         (console/console.css)</span>
<a href="#l10.29"></a><span id="l10.29">    content/communicator/console/console.js                          (console/console.js)</span>
<a href="#l10.30"></a><span id="l10.30">    content/communicator/console/console.xul                         (console/console.xul)</span>
<a href="#l10.31"></a><span id="l10.31">    content/communicator/dataman/dataman.css                         (dataman/dataman.css)</span>
<a href="#l10.32"></a><span id="l10.32">    content/communicator/dataman/dataman.js                          (dataman/dataman.js)</span>
<a href="#l10.33"></a><span id="l10.33">    content/communicator/dataman/dataman.xml                         (dataman/dataman.xml)</span>
<a href="#l10.34"></a><span id="l10.34">    content/communicator/dataman/dataman.xul                         (dataman/dataman.xul)</span>
<a href="#l10.35"></a><span id="l10.35" class="difflineat">@@ -153,36 +138,21 @@ comm.jar:</span>
<a href="#l10.36"></a><span id="l10.36">    content/communicator/downloads/progressDialog.xul                (downloads/progressDialog.xul)</span>
<a href="#l10.37"></a><span id="l10.37">    content/communicator/downloads/progressDialog.js                 (downloads/progressDialog.js)</span>
<a href="#l10.38"></a><span id="l10.38">    content/communicator/downloads/uploadProgress.xul                (downloads/uploadProgress.xul)</span>
<a href="#l10.39"></a><span id="l10.39">    content/communicator/downloads/uploadProgress.js                 (downloads/uploadProgress.js)</span>
<a href="#l10.40"></a><span id="l10.40">    content/communicator/downloads/treeView.js                       (downloads/treeView.js)</span>
<a href="#l10.41"></a><span id="l10.41">    content/communicator/feeds/subscribe.css                         (feeds/subscribe.css)</span>
<a href="#l10.42"></a><span id="l10.42">    content/communicator/feeds/subscribe.xhtml                       (feeds/subscribe.xhtml)</span>
<a href="#l10.43"></a><span id="l10.43">    content/communicator/feeds/subscribe.xml                         (feeds/subscribe.xml)</span>
<a href="#l10.44"></a><span id="l10.44" class="difflineminus">-   content/communicator/history/controller.js                       (history/controller.js)</span>
<a href="#l10.45"></a><span id="l10.45" class="difflineminus">-   content/communicator/history/history.js                          (history/history.js)</span>
<a href="#l10.46"></a><span id="l10.46" class="difflineminus">-   content/communicator/history/history.xul                         (history/history.xul)</span>
<a href="#l10.47"></a><span id="l10.47" class="difflineminus">-   content/communicator/history/history-panel.xul                   (history/history-panel.xul)</span>
<a href="#l10.48"></a><span id="l10.48" class="difflineminus">-   content/communicator/history/places.css                          (history/places.css)</span>
<a href="#l10.49"></a><span id="l10.49" class="difflineminus">-   content/communicator/history/placesOverlay.xul                   (history/placesOverlay.xul)</span>
<a href="#l10.50"></a><span id="l10.50" class="difflineminus">-   content/communicator/history/tree.xml                            (history/tree.xml)</span>
<a href="#l10.51"></a><span id="l10.51" class="difflineminus">-   content/communicator/history/treeView.js                         (history/treeView.js)</span>
<a href="#l10.52"></a><span id="l10.52">    content/communicator/permissions/cookieViewer.js                 (permissions/cookieViewer.js)</span>
<a href="#l10.53"></a><span id="l10.53">    content/communicator/permissions/cookieViewer.xul                (permissions/cookieViewer.xul)</span>
<a href="#l10.54"></a><span id="l10.54">    content/communicator/permissions/permissionsManager.js           (permissions/permissionsManager.js)</span>
<a href="#l10.55"></a><span id="l10.55">    content/communicator/permissions/permissionsManager.xul          (permissions/permissionsManager.xul)</span>
<a href="#l10.56"></a><span id="l10.56">    content/communicator/permissions/treeUtils.js                    (permissions/treeUtils.js)</span>
<a href="#l10.57"></a><span id="l10.57" class="difflineminus">-*  content/communicator/places/browserPlacesViews.js                (places/browserPlacesViews.js)</span>
<a href="#l10.58"></a><span id="l10.58" class="difflineminus">-   content/communicator/places/controller.js                        (places/controller.js)</span>
<a href="#l10.59"></a><span id="l10.59" class="difflineminus">-*  content/communicator/places/menu.xml                             (places/menu.xml)</span>
<a href="#l10.60"></a><span id="l10.60" class="difflineminus">-   content/communicator/places/places.css                           (places/places.css)</span>
<a href="#l10.61"></a><span id="l10.61" class="difflineminus">-   content/communicator/places/sidebarUtils.js                      (places/sidebarUtils.js)</span>
<a href="#l10.62"></a><span id="l10.62" class="difflineminus">-   content/communicator/places/tree.xml                             (places/tree.xml)</span>
<a href="#l10.63"></a><span id="l10.63" class="difflineminus">-   content/communicator/places/treeView.js                          (places/treeView.js)</span>
<a href="#l10.64"></a><span id="l10.64">    content/communicator/pref/preferences.xul                        (pref/preferences.xul)</span>
<a href="#l10.65"></a><span id="l10.65">    content/communicator/pref/preferences.js                         (pref/preferences.js)</span>
<a href="#l10.66"></a><span id="l10.66">    content/communicator/pref/prefpanels.css                         (pref/prefpanels.css)</span>
<a href="#l10.67"></a><span id="l10.67">    content/communicator/pref/prefpanels.xml                         (pref/prefpanels.xml)</span>
<a href="#l10.68"></a><span id="l10.68">    content/communicator/pref/pref-advanced.js                       (pref/pref-advanced.js)</span>
<a href="#l10.69"></a><span id="l10.69">    content/communicator/pref/pref-advanced.xul                      (pref/pref-advanced.xul)</span>
<a href="#l10.70"></a><span id="l10.70">    content/communicator/pref/pref-appearance.js                     (pref/pref-appearance.js)</span>
<a href="#l10.71"></a><span id="l10.71">    content/communicator/pref/pref-appearance.xul                    (pref/pref-appearance.xul)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/suite/common/mac/platformCommunicatorOverlay.xul</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/suite/common/mac/platformCommunicatorOverlay.xul</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -18,17 +18,20 @@</span>
<a href="#l11.4"></a><span id="l11.4"> </span>
<a href="#l11.5"></a><span id="l11.5"> &lt;overlay id=&quot;platformCommunicatorOverlay&quot;</span>
<a href="#l11.6"></a><span id="l11.6">      xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;&gt;</span>
<a href="#l11.7"></a><span id="l11.7"> </span>
<a href="#l11.8"></a><span id="l11.8">   &lt;!-- close --&gt;</span>
<a href="#l11.9"></a><span id="l11.9">   &lt;menuitem id=&quot;menu_close&quot; label=&quot;&amp;closeCmd.label;&quot; key=&quot;key_close&quot; command=&quot;cmd_close&quot;/&gt;</span>
<a href="#l11.10"></a><span id="l11.10">   &lt;key id=&quot;key_close&quot;  key=&quot;&amp;closeCmd.key;&quot; command=&quot;cmd_close&quot; modifiers=&quot;accel&quot;/&gt;</span>
<a href="#l11.11"></a><span id="l11.11">   &lt;key id=&quot;key_closeWindow&quot;  key=&quot;&amp;closeCmd.key;&quot; command=&quot;cmd_closeWindow&quot; modifiers=&quot;accel,shift&quot;/&gt;</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-  &lt;key id=&quot;key_gotoHistory&quot;  key=&quot;&amp;historyCmd.key;&quot; oncommand=&quot;toHistory();&quot; modifiers=&quot;accel,shift&quot;/&gt;</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+  &lt;key id=&quot;key_gotoHistory&quot;</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineplus">+       key=&quot;&amp;historyCmd.key;&quot;</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineplus">+       oncommand=&quot;PlacesCommandHook.showPlacesOrganizer('History');&quot;</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineplus">+       modifiers=&quot;accel,shift&quot;/&gt;</span>
<a href="#l11.17"></a><span id="l11.17"> </span>
<a href="#l11.18"></a><span id="l11.18">   &lt;menuitem id=&quot;menu_preferences&quot; label=&quot;&amp;preferencesCmd.label;&quot;</span>
<a href="#l11.19"></a><span id="l11.19">             key=&quot;key_preferences&quot;/&gt;</span>
<a href="#l11.20"></a><span id="l11.20"> </span>
<a href="#l11.21"></a><span id="l11.21">   &lt;menupopup id=&quot;menu_FilePopup&quot;&gt;</span>
<a href="#l11.22"></a><span id="l11.22">     &lt;!-- These 5 menuitems (and the menu_preferences menuitem above) are added</span>
<a href="#l11.23"></a><span id="l11.23">       to the Application menu. They just need to be in the DOM, widget code</span>
<a href="#l11.24"></a><span id="l11.24">       does the rest --&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/suite/common/moz.build</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/suite/common/moz.build</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -1,43 +1,31 @@</span>
<a href="#l12.4"></a><span id="l12.4"> # vim: set filetype=python:</span>
<a href="#l12.5"></a><span id="l12.5"> # This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l12.6"></a><span id="l12.6"> # License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l12.7"></a><span id="l12.7"> # file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l12.8"></a><span id="l12.8"> </span>
<a href="#l12.9"></a><span id="l12.9"> DIRS += [</span>
<a href="#l12.10"></a><span id="l12.10">     'console',</span>
<a href="#l12.11"></a><span id="l12.11" class="difflineplus">+    'places',</span>
<a href="#l12.12"></a><span id="l12.12">     'public',</span>
<a href="#l12.13"></a><span id="l12.13">     'src',</span>
<a href="#l12.14"></a><span id="l12.14"> ]</span>
<a href="#l12.15"></a><span id="l12.15"> </span>
<a href="#l12.16"></a><span id="l12.16" class="difflineminus">-EXTRA_COMPONENTS += [</span>
<a href="#l12.17"></a><span id="l12.17" class="difflineminus">-    'places/nsPlacesAutoComplete.js',</span>
<a href="#l12.18"></a><span id="l12.18" class="difflineminus">-    'places/nsPlacesAutoComplete.manifest',</span>
<a href="#l12.19"></a><span id="l12.19" class="difflineminus">-]</span>
<a href="#l12.20"></a><span id="l12.20" class="difflineminus">-</span>
<a href="#l12.21"></a><span id="l12.21"> BROWSER_CHROME_MANIFESTS += [</span>
<a href="#l12.22"></a><span id="l12.22">     'dataman/tests/browser.ini',</span>
<a href="#l12.23"></a><span id="l12.23">     'downloads/tests/browser/browser.ini',</span>
<a href="#l12.24"></a><span id="l12.24" class="difflineminus">-    'places/tests/browser/browser.ini',</span>
<a href="#l12.25"></a><span id="l12.25" class="difflineminus">-    'tests/browser/browser.ini',</span>
<a href="#l12.26"></a><span id="l12.26">     'tests/preferences/browser.ini',</span>
<a href="#l12.27"></a><span id="l12.27"> ]</span>
<a href="#l12.28"></a><span id="l12.28"> </span>
<a href="#l12.29"></a><span id="l12.29"> MOCHITEST_CHROME_MANIFESTS += [</span>
<a href="#l12.30"></a><span id="l12.30">     'downloads/tests/chrome/chrome.ini',</span>
<a href="#l12.31"></a><span id="l12.31" class="difflineminus">-    'places/tests/chrome/chrome.ini',</span>
<a href="#l12.32"></a><span id="l12.32">     'tests/chrome/chrome.ini',</span>
<a href="#l12.33"></a><span id="l12.33"> ]</span>
<a href="#l12.34"></a><span id="l12.34"> </span>
<a href="#l12.35"></a><span id="l12.35" class="difflineminus">-XPCSHELL_TESTS_MANIFESTS += [</span>
<a href="#l12.36"></a><span id="l12.36" class="difflineminus">-    'places/tests/autocomplete/xpcshell.ini',</span>
<a href="#l12.37"></a><span id="l12.37" class="difflineminus">-    'places/tests/unit/xpcshell.ini',</span>
<a href="#l12.38"></a><span id="l12.38" class="difflineminus">-]</span>
<a href="#l12.39"></a><span id="l12.39" class="difflineminus">-</span>
<a href="#l12.40"></a><span id="l12.40"> JAR_MANIFESTS += ['jar.mn']</span>
<a href="#l12.41"></a><span id="l12.41"> </span>
<a href="#l12.42"></a><span id="l12.42"> # DEFINES for preprocessing</span>
<a href="#l12.43"></a><span id="l12.43"> # Use suite/common/app-license.html as input when generating </span>
<a href="#l12.44"></a><span id="l12.44"> # chrome://content/communicator/license.html to override </span>
<a href="#l12.45"></a><span id="l12.45"> # chrome://global/content/license.html (about:license)</span>
<a href="#l12.46"></a><span id="l12.46"> DEFINES['APP_LICENSE_BLOCK'] = '%s/app-license.html' % SRCDIR</span>
<a href="#l12.47"></a><span id="l12.47"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/suite/common/places/PlacesUIUtils.jsm</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/suite/common/places/PlacesUIUtils.jsm</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -1,227 +1,460 @@</span>
<a href="#l13.4"></a><span id="l13.4" class="difflineminus">-/* -*- Mode: C++; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l13.5"></a><span id="l13.5" class="difflineplus">+/* -*- indent-tabs-mode: nil; js-indent-level: 2 -*- */</span>
<a href="#l13.6"></a><span id="l13.6"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l13.7"></a><span id="l13.7">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l13.8"></a><span id="l13.8">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l13.9"></a><span id="l13.9"> </span>
<a href="#l13.10"></a><span id="l13.10" class="difflineminus">-var EXPORTED_SYMBOLS = [&quot;PlacesUIUtils&quot;];</span>
<a href="#l13.11"></a><span id="l13.11" class="difflineplus">+this.EXPORTED_SYMBOLS = [&quot;PlacesUIUtils&quot;];</span>
<a href="#l13.12"></a><span id="l13.12"> </span>
<a href="#l13.13"></a><span id="l13.13"> ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l13.14"></a><span id="l13.14"> ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineplus">+ChromeUtils.import(&quot;resource://gre/modules/Timer.jsm&quot;);</span>
<a href="#l13.16"></a><span id="l13.16" class="difflineplus">+// PlacesUtils exposes multiple symbols, so we can't use defineModuleGetter.</span>
<a href="#l13.17"></a><span id="l13.17" class="difflineplus">+ChromeUtils.import(&quot;resource://gre/modules/PlacesUtils.jsm&quot;);</span>
<a href="#l13.18"></a><span id="l13.18"> </span>
<a href="#l13.19"></a><span id="l13.19" class="difflineminus">-XPCOMUtils.defineLazyGetter(this, &quot;PlacesUtils&quot;, function() {</span>
<a href="#l13.20"></a><span id="l13.20" class="difflineminus">-  ChromeUtils.import(&quot;resource://gre/modules/PlacesUtils.jsm&quot;);</span>
<a href="#l13.21"></a><span id="l13.21" class="difflineminus">-  return PlacesUtils;</span>
<a href="#l13.22"></a><span id="l13.22" class="difflineminus">-});</span>
<a href="#l13.23"></a><span id="l13.23" class="difflineplus">+ChromeUtils.defineModuleGetter(this, &quot;PluralForm&quot;,</span>
<a href="#l13.24"></a><span id="l13.24" class="difflineplus">+                               &quot;resource://gre/modules/PluralForm.jsm&quot;);</span>
<a href="#l13.25"></a><span id="l13.25" class="difflineplus">+ChromeUtils.defineModuleGetter(this, &quot;PrivateBrowsingUtils&quot;,</span>
<a href="#l13.26"></a><span id="l13.26" class="difflineplus">+                               &quot;resource://gre/modules/PrivateBrowsingUtils.jsm&quot;);</span>
<a href="#l13.27"></a><span id="l13.27" class="difflineplus">+ChromeUtils.defineModuleGetter(this, &quot;NetUtil&quot;,</span>
<a href="#l13.28"></a><span id="l13.28" class="difflineplus">+                               &quot;resource://gre/modules/NetUtil.jsm&quot;);</span>
<a href="#l13.29"></a><span id="l13.29" class="difflineplus">+ChromeUtils.defineModuleGetter(this, &quot;RecentWindow&quot;,</span>
<a href="#l13.30"></a><span id="l13.30" class="difflineplus">+                               &quot;resource:///modules/RecentWindow.jsm&quot;);</span>
<a href="#l13.31"></a><span id="l13.31" class="difflineplus">+ChromeUtils.defineModuleGetter(this, &quot;PlacesTransactions&quot;,</span>
<a href="#l13.32"></a><span id="l13.32" class="difflineplus">+                               &quot;resource://gre/modules/PlacesTransactions.jsm&quot;);</span>
<a href="#l13.33"></a><span id="l13.33" class="difflineplus">+</span>
<a href="#l13.34"></a><span id="l13.34" class="difflineplus">+ChromeUtils.defineModuleGetter(this, &quot;Weave&quot;,</span>
<a href="#l13.35"></a><span id="l13.35" class="difflineplus">+                               &quot;resource://services-sync/main.js&quot;);</span>
<a href="#l13.36"></a><span id="l13.36" class="difflineplus">+</span>
<a href="#l13.37"></a><span id="l13.37" class="difflineplus">+const gInContentProcess = Services.appinfo.processType == Ci.nsIXULRuntime.PROCESS_TYPE_CONTENT;</span>
<a href="#l13.38"></a><span id="l13.38" class="difflineplus">+const FAVICON_REQUEST_TIMEOUT = 60 * 1000;</span>
<a href="#l13.39"></a><span id="l13.39" class="difflineplus">+// Map from windows to arrays of data about pending favicon loads.</span>
<a href="#l13.40"></a><span id="l13.40" class="difflineplus">+let gFaviconLoadDataMap = new Map();</span>
<a href="#l13.41"></a><span id="l13.41" class="difflineplus">+</span>
<a href="#l13.42"></a><span id="l13.42" class="difflineplus">+// copied from utilityOverlay.js</span>
<a href="#l13.43"></a><span id="l13.43" class="difflineplus">+const TAB_DROP_TYPE = &quot;application/x-moz-tabbrowser-tab&quot;;</span>
<a href="#l13.44"></a><span id="l13.44"> </span>
<a href="#l13.45"></a><span id="l13.45"> // This function isn't public both because it's synchronous and because it is</span>
<a href="#l13.46"></a><span id="l13.46"> // going to be removed in bug 1072833.</span>
<a href="#l13.47"></a><span id="l13.47"> function IsLivemark(aItemId) {</span>
<a href="#l13.48"></a><span id="l13.48">   // Since this check may be done on each dragover event, it's worth maintaining</span>
<a href="#l13.49"></a><span id="l13.49">   // a cache.</span>
<a href="#l13.50"></a><span id="l13.50">   let self = IsLivemark;</span>
<a href="#l13.51"></a><span id="l13.51">   if (!(&quot;ids&quot; in self)) {</span>
<a href="#l13.52"></a><span id="l13.52">     const LIVEMARK_ANNO = PlacesUtils.LMANNO_FEEDURI;</span>
<a href="#l13.53"></a><span id="l13.53"> </span>
<a href="#l13.54"></a><span id="l13.54">     let idsVec = PlacesUtils.annotations.getItemsWithAnnotation(LIVEMARK_ANNO);</span>
<a href="#l13.55"></a><span id="l13.55">     self.ids = new Set(idsVec);</span>
<a href="#l13.56"></a><span id="l13.56"> </span>
<a href="#l13.57"></a><span id="l13.57" class="difflineminus">-    let obs = {</span>
<a href="#l13.58"></a><span id="l13.58" class="difflineplus">+    let obs = Object.freeze({</span>
<a href="#l13.59"></a><span id="l13.59">       QueryInterface: XPCOMUtils.generateQI(Ci.nsIAnnotationObserver),</span>
<a href="#l13.60"></a><span id="l13.60"> </span>
<a href="#l13.61"></a><span id="l13.61">       onItemAnnotationSet(itemId, annoName) {</span>
<a href="#l13.62"></a><span id="l13.62">         if (annoName == LIVEMARK_ANNO)</span>
<a href="#l13.63"></a><span id="l13.63">           self.ids.add(itemId);</span>
<a href="#l13.64"></a><span id="l13.64">       },</span>
<a href="#l13.65"></a><span id="l13.65"> </span>
<a href="#l13.66"></a><span id="l13.66">       onItemAnnotationRemoved(itemId, annoName) {</span>
<a href="#l13.67"></a><span id="l13.67">         // If annoName is set to an empty string, the item is gone.</span>
<a href="#l13.68"></a><span id="l13.68">         if (annoName == LIVEMARK_ANNO || annoName == &quot;&quot;)</span>
<a href="#l13.69"></a><span id="l13.69">           self.ids.delete(itemId);</span>
<a href="#l13.70"></a><span id="l13.70">       },</span>
<a href="#l13.71"></a><span id="l13.71"> </span>
<a href="#l13.72"></a><span id="l13.72">       onPageAnnotationSet() { },</span>
<a href="#l13.73"></a><span id="l13.73">       onPageAnnotationRemoved() { },</span>
<a href="#l13.74"></a><span id="l13.74" class="difflineminus">-    };</span>
<a href="#l13.75"></a><span id="l13.75" class="difflineplus">+    });</span>
<a href="#l13.76"></a><span id="l13.76">     PlacesUtils.annotations.addObserver(obs);</span>
<a href="#l13.77"></a><span id="l13.77">     PlacesUtils.registerShutdownFunction(() =&gt; {</span>
<a href="#l13.78"></a><span id="l13.78">       PlacesUtils.annotations.removeObserver(obs);</span>
<a href="#l13.79"></a><span id="l13.79">     });</span>
<a href="#l13.80"></a><span id="l13.80">   }</span>
<a href="#l13.81"></a><span id="l13.81">   return self.ids.has(aItemId);</span>
<a href="#l13.82"></a><span id="l13.82"> }</span>
<a href="#l13.83"></a><span id="l13.83"> </span>
<a href="#l13.84"></a><span id="l13.84" class="difflineminus">-var PlacesUIUtils = {</span>
<a href="#l13.85"></a><span id="l13.85" class="difflineminus">-  ORGANIZER_LEFTPANE_VERSION: 6,</span>
<a href="#l13.86"></a><span id="l13.86" class="difflineplus">+let InternalFaviconLoader = {</span>
<a href="#l13.87"></a><span id="l13.87" class="difflineplus">+  /**</span>
<a href="#l13.88"></a><span id="l13.88" class="difflineplus">+   * This gets called for every inner window that is destroyed.</span>
<a href="#l13.89"></a><span id="l13.89" class="difflineplus">+   * In the parent process, we process the destruction ourselves. In the child process,</span>
<a href="#l13.90"></a><span id="l13.90" class="difflineplus">+   * we notify the parent which will then process it based on that message.</span>
<a href="#l13.91"></a><span id="l13.91" class="difflineplus">+   */</span>
<a href="#l13.92"></a><span id="l13.92" class="difflineplus">+  observe(subject, topic, data) {</span>
<a href="#l13.93"></a><span id="l13.93" class="difflineplus">+    let innerWindowID = subject.QueryInterface(Ci.nsISupportsPRUint64).data;</span>
<a href="#l13.94"></a><span id="l13.94" class="difflineplus">+    this.removeRequestsForInner(innerWindowID);</span>
<a href="#l13.95"></a><span id="l13.95" class="difflineplus">+  },</span>
<a href="#l13.96"></a><span id="l13.96" class="difflineplus">+</span>
<a href="#l13.97"></a><span id="l13.97" class="difflineplus">+  /**</span>
<a href="#l13.98"></a><span id="l13.98" class="difflineplus">+   * Actually cancel the request, and clear the timeout for cancelling it.</span>
<a href="#l13.99"></a><span id="l13.99" class="difflineplus">+   */</span>
<a href="#l13.100"></a><span id="l13.100" class="difflineplus">+  _cancelRequest({uri, innerWindowID, timerID, callback}, reason) {</span>
<a href="#l13.101"></a><span id="l13.101" class="difflineplus">+    // Break cycle</span>
<a href="#l13.102"></a><span id="l13.102" class="difflineplus">+    let request = callback.request;</span>
<a href="#l13.103"></a><span id="l13.103" class="difflineplus">+    delete callback.request;</span>
<a href="#l13.104"></a><span id="l13.104" class="difflineplus">+    // Ensure we don't time out.</span>
<a href="#l13.105"></a><span id="l13.105" class="difflineplus">+    clearTimeout(timerID);</span>
<a href="#l13.106"></a><span id="l13.106" class="difflineplus">+    try {</span>
<a href="#l13.107"></a><span id="l13.107" class="difflineplus">+      request.cancel();</span>
<a href="#l13.108"></a><span id="l13.108" class="difflineplus">+    } catch (ex) {</span>
<a href="#l13.109"></a><span id="l13.109" class="difflineplus">+      Cu.reportError(&quot;When cancelling a request for &quot; + uri.spec + &quot; because &quot; + reason + &quot;, it was already canceled!&quot;);</span>
<a href="#l13.110"></a><span id="l13.110" class="difflineplus">+    }</span>
<a href="#l13.111"></a><span id="l13.111" class="difflineplus">+  },</span>
<a href="#l13.112"></a><span id="l13.112" class="difflineplus">+</span>
<a href="#l13.113"></a><span id="l13.113" class="difflineplus">+  /**</span>
<a href="#l13.114"></a><span id="l13.114" class="difflineplus">+   * Called for every inner that gets destroyed, only in the parent process.</span>
<a href="#l13.115"></a><span id="l13.115" class="difflineplus">+   */</span>
<a href="#l13.116"></a><span id="l13.116" class="difflineplus">+  removeRequestsForInner(innerID) {</span>
<a href="#l13.117"></a><span id="l13.117" class="difflineplus">+    for (let [window, loadDataForWindow] of gFaviconLoadDataMap) {</span>
<a href="#l13.118"></a><span id="l13.118" class="difflineplus">+      let newLoadDataForWindow = loadDataForWindow.filter(loadData =&gt; {</span>
<a href="#l13.119"></a><span id="l13.119" class="difflineplus">+        let innerWasDestroyed = loadData.innerWindowID == innerID;</span>
<a href="#l13.120"></a><span id="l13.120" class="difflineplus">+        if (innerWasDestroyed) {</span>
<a href="#l13.121"></a><span id="l13.121" class="difflineplus">+          this._cancelRequest(loadData, &quot;the inner window was destroyed or a new favicon was loaded for it&quot;);</span>
<a href="#l13.122"></a><span id="l13.122" class="difflineplus">+        }</span>
<a href="#l13.123"></a><span id="l13.123" class="difflineplus">+        // Keep the items whose inner is still alive.</span>
<a href="#l13.124"></a><span id="l13.124" class="difflineplus">+        return !innerWasDestroyed;</span>
<a href="#l13.125"></a><span id="l13.125" class="difflineplus">+      });</span>
<a href="#l13.126"></a><span id="l13.126" class="difflineplus">+      // Map iteration with for...of is safe against modification, so</span>
<a href="#l13.127"></a><span id="l13.127" class="difflineplus">+      // now just replace the old value:</span>
<a href="#l13.128"></a><span id="l13.128" class="difflineplus">+      gFaviconLoadDataMap.set(window, newLoadDataForWindow);</span>
<a href="#l13.129"></a><span id="l13.129" class="difflineplus">+    }</span>
<a href="#l13.130"></a><span id="l13.130" class="difflineplus">+  },</span>
<a href="#l13.131"></a><span id="l13.131" class="difflineplus">+</span>
<a href="#l13.132"></a><span id="l13.132" class="difflineplus">+  /**</span>
<a href="#l13.133"></a><span id="l13.133" class="difflineplus">+   * Called when a toplevel chrome window unloads. We use this to tidy up after ourselves,</span>
<a href="#l13.134"></a><span id="l13.134" class="difflineplus">+   * avoid leaks, and cancel any remaining requests. The last part should in theory be</span>
<a href="#l13.135"></a><span id="l13.135" class="difflineplus">+   * handled by the inner-window-destroyed handlers. We clean up just to be on the safe side.</span>
<a href="#l13.136"></a><span id="l13.136" class="difflineplus">+   */</span>
<a href="#l13.137"></a><span id="l13.137" class="difflineplus">+  onUnload(win) {</span>
<a href="#l13.138"></a><span id="l13.138" class="difflineplus">+    let loadDataForWindow = gFaviconLoadDataMap.get(win);</span>
<a href="#l13.139"></a><span id="l13.139" class="difflineplus">+    if (loadDataForWindow) {</span>
<a href="#l13.140"></a><span id="l13.140" class="difflineplus">+      for (let loadData of loadDataForWindow) {</span>
<a href="#l13.141"></a><span id="l13.141" class="difflineplus">+        this._cancelRequest(loadData, &quot;the chrome window went away&quot;);</span>
<a href="#l13.142"></a><span id="l13.142" class="difflineplus">+      }</span>
<a href="#l13.143"></a><span id="l13.143" class="difflineplus">+    }</span>
<a href="#l13.144"></a><span id="l13.144" class="difflineplus">+    gFaviconLoadDataMap.delete(win);</span>
<a href="#l13.145"></a><span id="l13.145" class="difflineplus">+  },</span>
<a href="#l13.146"></a><span id="l13.146" class="difflineplus">+</span>
<a href="#l13.147"></a><span id="l13.147" class="difflineplus">+  /**</span>
<a href="#l13.148"></a><span id="l13.148" class="difflineplus">+   * Remove a particular favicon load's loading data from our map tracking</span>
<a href="#l13.149"></a><span id="l13.149" class="difflineplus">+   * load data per chrome window.</span>
<a href="#l13.150"></a><span id="l13.150" class="difflineplus">+   *</span>
<a href="#l13.151"></a><span id="l13.151" class="difflineplus">+   * @param win</span>
<a href="#l13.152"></a><span id="l13.152" class="difflineplus">+   *        the chrome window in which we should look for this load</span>
<a href="#l13.153"></a><span id="l13.153" class="difflineplus">+   * @param filterData ({innerWindowID, uri, callback})</span>
<a href="#l13.154"></a><span id="l13.154" class="difflineplus">+   *        the data we should use to find this particular load to remove.</span>
<a href="#l13.155"></a><span id="l13.155" class="difflineplus">+   *</span>
<a href="#l13.156"></a><span id="l13.156" class="difflineplus">+   * @return the loadData object we removed, or null if we didn't find any.</span>
<a href="#l13.157"></a><span id="l13.157" class="difflineplus">+   */</span>
<a href="#l13.158"></a><span id="l13.158" class="difflineplus">+  _removeLoadDataFromWindowMap(win, {innerWindowID, uri, callback}) {</span>
<a href="#l13.159"></a><span id="l13.159" class="difflineplus">+    let loadDataForWindow = gFaviconLoadDataMap.get(win);</span>
<a href="#l13.160"></a><span id="l13.160" class="difflineplus">+    if (loadDataForWindow) {</span>
<a href="#l13.161"></a><span id="l13.161" class="difflineplus">+      let itemIndex = loadDataForWindow.findIndex(loadData =&gt; {</span>
<a href="#l13.162"></a><span id="l13.162" class="difflineplus">+        return loadData.innerWindowID == innerWindowID &amp;&amp;</span>
<a href="#l13.163"></a><span id="l13.163" class="difflineplus">+               loadData.uri.equals(uri) &amp;&amp;</span>
<a href="#l13.164"></a><span id="l13.164" class="difflineplus">+               loadData.callback.request == callback.request;</span>
<a href="#l13.165"></a><span id="l13.165" class="difflineplus">+      });</span>
<a href="#l13.166"></a><span id="l13.166" class="difflineplus">+      if (itemIndex != -1) {</span>
<a href="#l13.167"></a><span id="l13.167" class="difflineplus">+        let loadData = loadDataForWindow[itemIndex];</span>
<a href="#l13.168"></a><span id="l13.168" class="difflineplus">+        loadDataForWindow.splice(itemIndex, 1);</span>
<a href="#l13.169"></a><span id="l13.169" class="difflineplus">+        return loadData;</span>
<a href="#l13.170"></a><span id="l13.170" class="difflineplus">+      }</span>
<a href="#l13.171"></a><span id="l13.171" class="difflineplus">+    }</span>
<a href="#l13.172"></a><span id="l13.172" class="difflineplus">+    return null;</span>
<a href="#l13.173"></a><span id="l13.173" class="difflineplus">+  },</span>
<a href="#l13.174"></a><span id="l13.174" class="difflineplus">+</span>
<a href="#l13.175"></a><span id="l13.175" class="difflineplus">+  /**</span>
<a href="#l13.176"></a><span id="l13.176" class="difflineplus">+   * Create a function to use as a nsIFaviconDataCallback, so we can remove cancelling</span>
<a href="#l13.177"></a><span id="l13.177" class="difflineplus">+   * information when the request succeeds. Note that right now there are some edge-cases,</span>
<a href="#l13.178"></a><span id="l13.178" class="difflineplus">+   * such as about: URIs with chrome:// favicons where the success callback is not invoked.</span>
<a href="#l13.179"></a><span id="l13.179" class="difflineplus">+   * This is OK: we will 'cancel' the request after the timeout (or when the window goes</span>
<a href="#l13.180"></a><span id="l13.180" class="difflineplus">+   * away) but that will be a no-op in such cases.</span>
<a href="#l13.181"></a><span id="l13.181" class="difflineplus">+   */</span>
<a href="#l13.182"></a><span id="l13.182" class="difflineplus">+  _makeCompletionCallback(win, id) {</span>
<a href="#l13.183"></a><span id="l13.183" class="difflineplus">+    return {</span>
<a href="#l13.184"></a><span id="l13.184" class="difflineplus">+      onComplete(uri) {</span>
<a href="#l13.185"></a><span id="l13.185" class="difflineplus">+        let loadData = InternalFaviconLoader._removeLoadDataFromWindowMap(win, {</span>
<a href="#l13.186"></a><span id="l13.186" class="difflineplus">+          uri,</span>
<a href="#l13.187"></a><span id="l13.187" class="difflineplus">+          innerWindowID: id,</span>
<a href="#l13.188"></a><span id="l13.188" class="difflineplus">+          callback: this,</span>
<a href="#l13.189"></a><span id="l13.189" class="difflineplus">+        });</span>
<a href="#l13.190"></a><span id="l13.190" class="difflineplus">+        if (loadData) {</span>
<a href="#l13.191"></a><span id="l13.191" class="difflineplus">+          clearTimeout(loadData.timerID);</span>
<a href="#l13.192"></a><span id="l13.192" class="difflineplus">+        }</span>
<a href="#l13.193"></a><span id="l13.193" class="difflineplus">+        delete this.request;</span>
<a href="#l13.194"></a><span id="l13.194" class="difflineplus">+      },</span>
<a href="#l13.195"></a><span id="l13.195" class="difflineplus">+    };</span>
<a href="#l13.196"></a><span id="l13.196" class="difflineplus">+  },</span>
<a href="#l13.197"></a><span id="l13.197" class="difflineplus">+</span>
<a href="#l13.198"></a><span id="l13.198" class="difflineplus">+  ensureInitialized() {</span>
<a href="#l13.199"></a><span id="l13.199" class="difflineplus">+    if (this._initialized) {</span>
<a href="#l13.200"></a><span id="l13.200" class="difflineplus">+      return;</span>
<a href="#l13.201"></a><span id="l13.201" class="difflineplus">+    }</span>
<a href="#l13.202"></a><span id="l13.202" class="difflineplus">+    this._initialized = true;</span>
<a href="#l13.203"></a><span id="l13.203" class="difflineplus">+</span>
<a href="#l13.204"></a><span id="l13.204" class="difflineplus">+    Services.obs.addObserver(this, &quot;inner-window-destroyed&quot;);</span>
<a href="#l13.205"></a><span id="l13.205" class="difflineplus">+    Services.ppmm.addMessageListener(&quot;Toolkit:inner-window-destroyed&quot;, msg =&gt; {</span>
<a href="#l13.206"></a><span id="l13.206" class="difflineplus">+      this.removeRequestsForInner(msg.data);</span>
<a href="#l13.207"></a><span id="l13.207" class="difflineplus">+    });</span>
<a href="#l13.208"></a><span id="l13.208" class="difflineplus">+  },</span>
<a href="#l13.209"></a><span id="l13.209" class="difflineplus">+</span>
<a href="#l13.210"></a><span id="l13.210" class="difflineplus">+  loadFavicon(browser, principal, uri) {</span>
<a href="#l13.211"></a><span id="l13.211" class="difflineplus">+    this.ensureInitialized();</span>
<a href="#l13.212"></a><span id="l13.212" class="difflineplus">+    let win = browser.ownerGlobal;</span>
<a href="#l13.213"></a><span id="l13.213" class="difflineplus">+    if (!gFaviconLoadDataMap.has(win)) {</span>
<a href="#l13.214"></a><span id="l13.214" class="difflineplus">+      gFaviconLoadDataMap.set(win, []);</span>
<a href="#l13.215"></a><span id="l13.215" class="difflineplus">+      let unloadHandler = event =&gt; {</span>
<a href="#l13.216"></a><span id="l13.216" class="difflineplus">+        let doc = event.target;</span>
<a href="#l13.217"></a><span id="l13.217" class="difflineplus">+        let eventWin = doc.defaultView;</span>
<a href="#l13.218"></a><span id="l13.218" class="difflineplus">+        if (eventWin == win) {</span>
<a href="#l13.219"></a><span id="l13.219" class="difflineplus">+          win.removeEventListener(&quot;unload&quot;, unloadHandler);</span>
<a href="#l13.220"></a><span id="l13.220" class="difflineplus">+          this.onUnload(win);</span>
<a href="#l13.221"></a><span id="l13.221" class="difflineplus">+        }</span>
<a href="#l13.222"></a><span id="l13.222" class="difflineplus">+      };</span>
<a href="#l13.223"></a><span id="l13.223" class="difflineplus">+      win.addEventListener(&quot;unload&quot;, unloadHandler, true);</span>
<a href="#l13.224"></a><span id="l13.224" class="difflineplus">+    }</span>
<a href="#l13.225"></a><span id="l13.225" class="difflineplus">+</span>
<a href="#l13.226"></a><span id="l13.226" class="difflineplus">+    let {innerWindowID, currentURI} = browser;</span>
<a href="#l13.227"></a><span id="l13.227" class="difflineplus">+</span>
<a href="#l13.228"></a><span id="l13.228" class="difflineplus">+    // Immediately cancel any earlier requests</span>
<a href="#l13.229"></a><span id="l13.229" class="difflineplus">+    this.removeRequestsForInner(innerWindowID);</span>
<a href="#l13.230"></a><span id="l13.230" class="difflineplus">+</span>
<a href="#l13.231"></a><span id="l13.231" class="difflineplus">+    // First we do the actual setAndFetch call:</span>
<a href="#l13.232"></a><span id="l13.232" class="difflineplus">+    let loadType = PrivateBrowsingUtils.isWindowPrivate(win)</span>
<a href="#l13.233"></a><span id="l13.233" class="difflineplus">+      ? PlacesUtils.favicons.FAVICON_LOAD_PRIVATE</span>
<a href="#l13.234"></a><span id="l13.234" class="difflineplus">+      : PlacesUtils.favicons.FAVICON_LOAD_NON_PRIVATE;</span>
<a href="#l13.235"></a><span id="l13.235" class="difflineplus">+    let callback = this._makeCompletionCallback(win, innerWindowID);</span>
<a href="#l13.236"></a><span id="l13.236" class="difflineplus">+    let request = PlacesUtils.favicons.setAndFetchFaviconForPage(currentURI, uri, false,</span>
<a href="#l13.237"></a><span id="l13.237" class="difflineplus">+                                                                 loadType, callback, principal);</span>
<a href="#l13.238"></a><span id="l13.238" class="difflineplus">+</span>
<a href="#l13.239"></a><span id="l13.239" class="difflineplus">+    // Now register the result so we can cancel it if/when necessary.</span>
<a href="#l13.240"></a><span id="l13.240" class="difflineplus">+    if (!request) {</span>
<a href="#l13.241"></a><span id="l13.241" class="difflineplus">+      // The favicon service can return with success but no-op (and leave request</span>
<a href="#l13.242"></a><span id="l13.242" class="difflineplus">+      // as null) if the icon is the same as the page (e.g. for images) or if it is</span>
<a href="#l13.243"></a><span id="l13.243" class="difflineplus">+      // the favicon for an error page. In this case, we do not need to do anything else.</span>
<a href="#l13.244"></a><span id="l13.244" class="difflineplus">+      return;</span>
<a href="#l13.245"></a><span id="l13.245" class="difflineplus">+    }</span>
<a href="#l13.246"></a><span id="l13.246" class="difflineplus">+    callback.request = request;</span>
<a href="#l13.247"></a><span id="l13.247" class="difflineplus">+    let loadData = {innerWindowID, uri, callback};</span>
<a href="#l13.248"></a><span id="l13.248" class="difflineplus">+    loadData.timerID = setTimeout(() =&gt; {</span>
<a href="#l13.249"></a><span id="l13.249" class="difflineplus">+      this._cancelRequest(loadData, &quot;it timed out&quot;);</span>
<a href="#l13.250"></a><span id="l13.250" class="difflineplus">+      this._removeLoadDataFromWindowMap(win, loadData);</span>
<a href="#l13.251"></a><span id="l13.251" class="difflineplus">+    }, FAVICON_REQUEST_TIMEOUT);</span>
<a href="#l13.252"></a><span id="l13.252" class="difflineplus">+    let loadDataForWindow = gFaviconLoadDataMap.get(win);</span>
<a href="#l13.253"></a><span id="l13.253" class="difflineplus">+    loadDataForWindow.push(loadData);</span>
<a href="#l13.254"></a><span id="l13.254" class="difflineplus">+  },</span>
<a href="#l13.255"></a><span id="l13.255" class="difflineplus">+};</span>
<a href="#l13.256"></a><span id="l13.256" class="difflineplus">+</span>
<a href="#l13.257"></a><span id="l13.257" class="difflineplus">+this.PlacesUIUtils = {</span>
<a href="#l13.258"></a><span id="l13.258" class="difflineplus">+  ORGANIZER_LEFTPANE_VERSION: 7,</span>
<a href="#l13.259"></a><span id="l13.259">   ORGANIZER_FOLDER_ANNO: &quot;PlacesOrganizer/OrganizerFolder&quot;,</span>
<a href="#l13.260"></a><span id="l13.260">   ORGANIZER_QUERY_ANNO: &quot;PlacesOrganizer/OrganizerQuery&quot;,</span>
<a href="#l13.261"></a><span id="l13.261"> </span>
<a href="#l13.262"></a><span id="l13.262">   LOAD_IN_SIDEBAR_ANNO: &quot;bookmarkProperties/loadInSidebar&quot;,</span>
<a href="#l13.263"></a><span id="l13.263">   DESCRIPTION_ANNO: &quot;bookmarkProperties/description&quot;,</span>
<a href="#l13.264"></a><span id="l13.264"> </span>
<a href="#l13.265"></a><span id="l13.265" class="difflineminus">-  TYPE_TAB_DROP: &quot;application/x-moz-tabbrowser-tab&quot;,</span>
<a href="#l13.266"></a><span id="l13.266" class="difflineminus">-</span>
<a href="#l13.267"></a><span id="l13.267">   /**</span>
<a href="#l13.268"></a><span id="l13.268">    * Makes a URI from a spec, and do fixup</span>
<a href="#l13.269"></a><span id="l13.269">    * @param   aSpec</span>
<a href="#l13.270"></a><span id="l13.270">    *          The string spec of the URI</span>
<a href="#l13.271"></a><span id="l13.271" class="difflineminus">-   * @returns A URI object for the spec.</span>
<a href="#l13.272"></a><span id="l13.272" class="difflineplus">+   * @return A URI object for the spec.</span>
<a href="#l13.273"></a><span id="l13.273">    */</span>
<a href="#l13.274"></a><span id="l13.274">   createFixedURI: function PUIU_createFixedURI(aSpec) {</span>
<a href="#l13.275"></a><span id="l13.275">     return URIFixup.createFixupURI(aSpec, Ci.nsIURIFixup.FIXUP_FLAG_NONE);</span>
<a href="#l13.276"></a><span id="l13.276">   },</span>
<a href="#l13.277"></a><span id="l13.277"> </span>
<a href="#l13.278"></a><span id="l13.278" class="difflineminus">-  /**</span>
<a href="#l13.279"></a><span id="l13.279" class="difflineminus">-   * Wraps a string in a nsISupportsString wrapper</span>
<a href="#l13.280"></a><span id="l13.280" class="difflineminus">-   * @param   aString</span>
<a href="#l13.281"></a><span id="l13.281" class="difflineminus">-   *          The string to wrap</span>
<a href="#l13.282"></a><span id="l13.282" class="difflineminus">-   * @returns A nsISupportsString object containing a string.</span>
<a href="#l13.283"></a><span id="l13.283" class="difflineminus">-   */</span>
<a href="#l13.284"></a><span id="l13.284" class="difflineminus">-  _wrapString: function PUIU__wrapString(aString) {</span>
<a href="#l13.285"></a><span id="l13.285" class="difflineminus">-    var s = Cc[&quot;@mozilla.org/supports-string;1&quot;]</span>
<a href="#l13.286"></a><span id="l13.286" class="difflineminus">-              .createInstance(Ci.nsISupportsString);</span>
<a href="#l13.287"></a><span id="l13.287" class="difflineminus">-    s.data = aString;</span>
<a href="#l13.288"></a><span id="l13.288" class="difflineminus">-    return s;</span>
<a href="#l13.289"></a><span id="l13.289" class="difflineminus">-  },</span>
<a href="#l13.290"></a><span id="l13.290" class="difflineminus">-</span>
<a href="#l13.291"></a><span id="l13.291">   getFormattedString: function PUIU_getFormattedString(key, params) {</span>
<a href="#l13.292"></a><span id="l13.292">     return bundle.formatStringFromName(key, params, params.length);</span>
<a href="#l13.293"></a><span id="l13.293">   },</span>
<a href="#l13.294"></a><span id="l13.294"> </span>
<a href="#l13.295"></a><span id="l13.295" class="difflineplus">+  /**</span>
<a href="#l13.296"></a><span id="l13.296" class="difflineplus">+   * Get a localized plural string for the specified key name and numeric value</span>
<a href="#l13.297"></a><span id="l13.297" class="difflineplus">+   * substituting parameters.</span>
<a href="#l13.298"></a><span id="l13.298" class="difflineplus">+   *</span>
<a href="#l13.299"></a><span id="l13.299" class="difflineplus">+   * @param   aKey</span>
<a href="#l13.300"></a><span id="l13.300" class="difflineplus">+   *          String, key for looking up the localized string in the bundle</span>
<a href="#l13.301"></a><span id="l13.301" class="difflineplus">+   * @param   aNumber</span>
<a href="#l13.302"></a><span id="l13.302" class="difflineplus">+   *          Number based on which the final localized form is looked up</span>
<a href="#l13.303"></a><span id="l13.303" class="difflineplus">+   * @param   aParams</span>
<a href="#l13.304"></a><span id="l13.304" class="difflineplus">+   *          Array whose items will substitute #1, #2,... #n parameters</span>
<a href="#l13.305"></a><span id="l13.305" class="difflineplus">+   *          in the string.</span>
<a href="#l13.306"></a><span id="l13.306" class="difflineplus">+   *</span>
<a href="#l13.307"></a><span id="l13.307" class="difflineplus">+   * @see https://developer.mozilla.org/en/Localization_and_Plurals</span>
<a href="#l13.308"></a><span id="l13.308" class="difflineplus">+   * @return The localized plural string.</span>
<a href="#l13.309"></a><span id="l13.309" class="difflineplus">+   */</span>
<a href="#l13.310"></a><span id="l13.310" class="difflineplus">+  getPluralString: function PUIU_getPluralString(aKey, aNumber, aParams) {</span>
<a href="#l13.311"></a><span id="l13.311" class="difflineplus">+    let str = PluralForm.get(aNumber, bundle.GetStringFromName(aKey));</span>
<a href="#l13.312"></a><span id="l13.312" class="difflineplus">+</span>
<a href="#l13.313"></a><span id="l13.313" class="difflineplus">+    // Replace #1 with aParams[0], #2 with aParams[1], and so on.</span>
<a href="#l13.314"></a><span id="l13.314" class="difflineplus">+    return str.replace(/\#(\d+)/g, function(matchedId, matchedNumber) {</span>
<a href="#l13.315"></a><span id="l13.315" class="difflineplus">+      let param = aParams[parseInt(matchedNumber, 10) - 1];</span>
<a href="#l13.316"></a><span id="l13.316" class="difflineplus">+      return param !== undefined ? param : matchedId;</span>
<a href="#l13.317"></a><span id="l13.317" class="difflineplus">+    });</span>
<a href="#l13.318"></a><span id="l13.318" class="difflineplus">+  },</span>
<a href="#l13.319"></a><span id="l13.319" class="difflineplus">+</span>
<a href="#l13.320"></a><span id="l13.320">   getString: function PUIU_getString(key) {</span>
<a href="#l13.321"></a><span id="l13.321">     return bundle.GetStringFromName(key);</span>
<a href="#l13.322"></a><span id="l13.322">   },</span>
<a href="#l13.323"></a><span id="l13.323"> </span>
<a href="#l13.324"></a><span id="l13.324" class="difflineplus">+  get _copyableAnnotations() {</span>
<a href="#l13.325"></a><span id="l13.325" class="difflineplus">+    return [</span>
<a href="#l13.326"></a><span id="l13.326" class="difflineplus">+      this.DESCRIPTION_ANNO,</span>
<a href="#l13.327"></a><span id="l13.327" class="difflineplus">+      this.LOAD_IN_SIDEBAR_ANNO,</span>
<a href="#l13.328"></a><span id="l13.328" class="difflineplus">+      PlacesUtils.READ_ONLY_ANNO,</span>
<a href="#l13.329"></a><span id="l13.329" class="difflineplus">+    ];</span>
<a href="#l13.330"></a><span id="l13.330" class="difflineplus">+  },</span>
<a href="#l13.331"></a><span id="l13.331" class="difflineplus">+</span>
<a href="#l13.332"></a><span id="l13.332">   /**</span>
<a href="#l13.333"></a><span id="l13.333" class="difflineminus">-   * Get a transaction for copying a uri item (either a bookmark or a</span>
<a href="#l13.334"></a><span id="l13.334" class="difflineminus">-   * history entry) from one container to another.</span>
<a href="#l13.335"></a><span id="l13.335" class="difflineplus">+   * Get a transaction for copying a uri item (either a bookmark or a history</span>
<a href="#l13.336"></a><span id="l13.336" class="difflineplus">+   * entry) from one container to another.</span>
<a href="#l13.337"></a><span id="l13.337">    *</span>
<a href="#l13.338"></a><span id="l13.338">    * @param   aData</span>
<a href="#l13.339"></a><span id="l13.339">    *          JSON object of dropped or pasted item properties</span>
<a href="#l13.340"></a><span id="l13.340">    * @param   aContainer</span>
<a href="#l13.341"></a><span id="l13.341">    *          The container being copied into</span>
<a href="#l13.342"></a><span id="l13.342">    * @param   aIndex</span>
<a href="#l13.343"></a><span id="l13.343">    *          The index within the container the item is copied to</span>
<a href="#l13.344"></a><span id="l13.344" class="difflineminus">-   * @return  A nsITransaction object that performs the copy.</span>
<a href="#l13.345"></a><span id="l13.345" class="difflineplus">+   * @return A nsITransaction object that performs the copy.</span>
<a href="#l13.346"></a><span id="l13.346">    *</span>
<a href="#l13.347"></a><span id="l13.347">    * @note Since a copy creates a completely new item, only some internal</span>
<a href="#l13.348"></a><span id="l13.348">    *       annotations are synced from the old one.</span>
<a href="#l13.349"></a><span id="l13.349">    * @see this._copyableAnnotations for the list of copyable annotations.</span>
<a href="#l13.350"></a><span id="l13.350">    */</span>
<a href="#l13.351"></a><span id="l13.351" class="difflineminus">-   _getURIItemCopyTransaction:</span>
<a href="#l13.352"></a><span id="l13.352" class="difflineminus">-   function PUIU__getURIItemCopyTransaction(aData, aContainer, aIndex)</span>
<a href="#l13.353"></a><span id="l13.353" class="difflineminus">-   {</span>
<a href="#l13.354"></a><span id="l13.354" class="difflineminus">-     let transactions = [];</span>
<a href="#l13.355"></a><span id="l13.355" class="difflineminus">-     if (aData.dateAdded)</span>
<a href="#l13.356"></a><span id="l13.356" class="difflineminus">-       transactions.push(</span>
<a href="#l13.357"></a><span id="l13.357" class="difflineminus">-         new PlacesEditItemDateAddedTransaction(null, aData.dateAdded)</span>
<a href="#l13.358"></a><span id="l13.358" class="difflineminus">-       );</span>
<a href="#l13.359"></a><span id="l13.359" class="difflineplus">+  _getURIItemCopyTransaction:</span>
<a href="#l13.360"></a><span id="l13.360" class="difflineplus">+  function PUIU__getURIItemCopyTransaction(aData, aContainer, aIndex) {</span>
<a href="#l13.361"></a><span id="l13.361" class="difflineplus">+    let transactions = [];</span>
<a href="#l13.362"></a><span id="l13.362" class="difflineplus">+    if (aData.dateAdded) {</span>
<a href="#l13.363"></a><span id="l13.363" class="difflineplus">+      transactions.push(</span>
<a href="#l13.364"></a><span id="l13.364" class="difflineplus">+        new PlacesEditItemDateAddedTransaction(null, aData.dateAdded)</span>
<a href="#l13.365"></a><span id="l13.365" class="difflineplus">+      );</span>
<a href="#l13.366"></a><span id="l13.366" class="difflineplus">+    }</span>
<a href="#l13.367"></a><span id="l13.367" class="difflineplus">+    if (aData.lastModified) {</span>
<a href="#l13.368"></a><span id="l13.368" class="difflineplus">+      transactions.push(</span>
<a href="#l13.369"></a><span id="l13.369" class="difflineplus">+        new PlacesEditItemLastModifiedTransaction(null, aData.lastModified)</span>
<a href="#l13.370"></a><span id="l13.370" class="difflineplus">+      );</span>
<a href="#l13.371"></a><span id="l13.371" class="difflineplus">+    }</span>
<a href="#l13.372"></a><span id="l13.372"> </span>
<a href="#l13.373"></a><span id="l13.373" class="difflineminus">-     if (aData.lastModified)</span>
<a href="#l13.374"></a><span id="l13.374" class="difflineminus">-       transactions.push(</span>
<a href="#l13.375"></a><span id="l13.375" class="difflineminus">-         new PlacesEditItemLastModifiedTransaction(null, aData.lastModified)</span>
<a href="#l13.376"></a><span id="l13.376" class="difflineminus">-       );</span>
<a href="#l13.377"></a><span id="l13.377" class="difflineplus">+    let annos = [];</span>
<a href="#l13.378"></a><span id="l13.378" class="difflineplus">+    if (aData.annos) {</span>
<a href="#l13.379"></a><span id="l13.379" class="difflineplus">+      annos = aData.annos.filter(function(aAnno) {</span>
<a href="#l13.380"></a><span id="l13.380" class="difflineplus">+        return this._copyableAnnotations.includes(aAnno.name);</span>
<a href="#l13.381"></a><span id="l13.381" class="difflineplus">+      }, this);</span>
<a href="#l13.382"></a><span id="l13.382" class="difflineplus">+    }</span>
<a href="#l13.383"></a><span id="l13.383"> </span>
<a href="#l13.384"></a><span id="l13.384" class="difflineminus">-     let keyword = aData.keyword || null;</span>
<a href="#l13.385"></a><span id="l13.385" class="difflineminus">-     let annos = [];</span>
<a href="#l13.386"></a><span id="l13.386" class="difflineminus">-     if (aData.annos) {</span>
<a href="#l13.387"></a><span id="l13.387" class="difflineminus">-       annos = aData.annos.filter(function (aAnno) {</span>
<a href="#l13.388"></a><span id="l13.388" class="difflineminus">-         return this._copyableAnnotations.indexOf(aAnno.name) != -1;</span>
<a href="#l13.389"></a><span id="l13.389" class="difflineminus">-       }, this);</span>
<a href="#l13.390"></a><span id="l13.390" class="difflineminus">-     }</span>
<a href="#l13.391"></a><span id="l13.391" class="difflineminus">-</span>
<a href="#l13.392"></a><span id="l13.392" class="difflineminus">-     return new PlacesCreateBookmarkTransaction(PlacesUtils._uri(aData.uri),</span>
<a href="#l13.393"></a><span id="l13.393" class="difflineminus">-                                                aContainer, aIndex, aData.title,</span>
<a href="#l13.394"></a><span id="l13.394" class="difflineminus">-                                                keyword, annos, transactions);</span>
<a href="#l13.395"></a><span id="l13.395" class="difflineplus">+    // There's no need to copy the keyword since it's bound to the bookmark url.</span>
<a href="#l13.396"></a><span id="l13.396" class="difflineplus">+    return new PlacesCreateBookmarkTransaction(PlacesUtils._uri(aData.uri),</span>
<a href="#l13.397"></a><span id="l13.397" class="difflineplus">+                                               aContainer, aIndex, aData.title,</span>
<a href="#l13.398"></a><span id="l13.398" class="difflineplus">+                                               null, annos, transactions);</span>
<a href="#l13.399"></a><span id="l13.399">   },</span>
<a href="#l13.400"></a><span id="l13.400"> </span>
<a href="#l13.401"></a><span id="l13.401">   /**</span>
<a href="#l13.402"></a><span id="l13.402">    * Gets a transaction for copying (recursively nesting to include children)</span>
<a href="#l13.403"></a><span id="l13.403">    * a folder (or container) and its contents from one folder to another.</span>
<a href="#l13.404"></a><span id="l13.404">    *</span>
<a href="#l13.405"></a><span id="l13.405">    * @param   aData</span>
<a href="#l13.406"></a><span id="l13.406">    *          Unwrapped dropped folder data - Obj containing folder and children</span>
<a href="#l13.407"></a><span id="l13.407">    * @param   aContainer</span>
<a href="#l13.408"></a><span id="l13.408">    *          The container we are copying into</span>
<a href="#l13.409"></a><span id="l13.409">    * @param   aIndex</span>
<a href="#l13.410"></a><span id="l13.410">    *          The index in the destination container to insert the new items</span>
<a href="#l13.411"></a><span id="l13.411" class="difflineminus">-   * @return  A nsITransaction object that will perform the copy.</span>
<a href="#l13.412"></a><span id="l13.412" class="difflineplus">+   * @return A nsITransaction object that will perform the copy.</span>
<a href="#l13.413"></a><span id="l13.413">    *</span>
<a href="#l13.414"></a><span id="l13.414">    * @note Since a copy creates a completely new item, only some internal</span>
<a href="#l13.415"></a><span id="l13.415">    *       annotations are synced from the old one.</span>
<a href="#l13.416"></a><span id="l13.416">    * @see this._copyableAnnotations for the list of copyable annotations.</span>
<a href="#l13.417"></a><span id="l13.417">    */</span>
<a href="#l13.418"></a><span id="l13.418" class="difflineminus">-  _getFolderCopyTransaction:</span>
<a href="#l13.419"></a><span id="l13.419" class="difflineminus">-  function PUIU__getFolderCopyTransaction(aData, aContainer, aIndex) {</span>
<a href="#l13.420"></a><span id="l13.420" class="difflineminus">-    function getChildItemsTransactions(aChildren) {</span>
<a href="#l13.421"></a><span id="l13.421" class="difflineplus">+  _getFolderCopyTransaction(aData, aContainer, aIndex) {</span>
<a href="#l13.422"></a><span id="l13.422" class="difflineplus">+    function getChildItemsTransactions(aRoot) {</span>
<a href="#l13.423"></a><span id="l13.423">       let transactions = [];</span>
<a href="#l13.424"></a><span id="l13.424">       let index = aIndex;</span>
<a href="#l13.425"></a><span id="l13.425" class="difflineminus">-      aChildren.forEach(function (node, i) {</span>
<a href="#l13.426"></a><span id="l13.426" class="difflineplus">+      for (let i = 0; i &lt; aRoot.childCount; ++i) {</span>
<a href="#l13.427"></a><span id="l13.427" class="difflineplus">+        let child = aRoot.getChild(i);</span>
<a href="#l13.428"></a><span id="l13.428" class="difflineplus">+        // Temporary hacks until we switch to PlacesTransactions.jsm.</span>
<a href="#l13.429"></a><span id="l13.429" class="difflineplus">+        let isLivemark =</span>
<a href="#l13.430"></a><span id="l13.430" class="difflineplus">+          PlacesUtils.annotations.itemHasAnnotation(child.itemId,</span>
<a href="#l13.431"></a><span id="l13.431" class="difflineplus">+                                                    PlacesUtils.LMANNO_FEEDURI);</span>
<a href="#l13.432"></a><span id="l13.432" class="difflineplus">+        let [node] = PlacesUtils.unwrapNodes(</span>
<a href="#l13.433"></a><span id="l13.433" class="difflineplus">+          PlacesUtils.wrapNode(child, PlacesUtils.TYPE_X_MOZ_PLACE, isLivemark),</span>
<a href="#l13.434"></a><span id="l13.434" class="difflineplus">+          PlacesUtils.TYPE_X_MOZ_PLACE</span>
<a href="#l13.435"></a><span id="l13.435" class="difflineplus">+        );</span>
<a href="#l13.436"></a><span id="l13.436" class="difflineplus">+</span>
<a href="#l13.437"></a><span id="l13.437">         // Make sure that items are given the correct index, this will be</span>
<a href="#l13.438"></a><span id="l13.438">         // passed by the transaction manager to the backend for the insertion.</span>
<a href="#l13.439"></a><span id="l13.439">         // Insertion behaves differently for DEFAULT_INDEX (append).</span>
<a href="#l13.440"></a><span id="l13.440" class="difflineminus">-        if (aIndex != PlacesUtils.bookmarks.DEFAULT_INDEX)</span>
<a href="#l13.441"></a><span id="l13.441" class="difflineplus">+        if (aIndex != PlacesUtils.bookmarks.DEFAULT_INDEX) {</span>
<a href="#l13.442"></a><span id="l13.442">           index = i;</span>
<a href="#l13.443"></a><span id="l13.443" class="difflineplus">+        }</span>
<a href="#l13.444"></a><span id="l13.444"> </span>
<a href="#l13.445"></a><span id="l13.445" class="difflineminus">-        if (node.type == PlacesUtils.TYPE_X_MOZ_PLACE_CONTAINER)</span>
<a href="#l13.446"></a><span id="l13.446" class="difflineminus">-          transactions.push(</span>
<a href="#l13.447"></a><span id="l13.447" class="difflineminus">-            PlacesUIUtils._getFolderCopyTransaction(node, aContainer, index)</span>
<a href="#l13.448"></a><span id="l13.448" class="difflineminus">-          );</span>
<a href="#l13.449"></a><span id="l13.449" class="difflineminus">-        else if (node.type == PlacesUtils.TYPE_X_MOZ_PLACE_SEPARATOR)</span>
<a href="#l13.450"></a><span id="l13.450" class="difflineplus">+        if (node.type == PlacesUtils.TYPE_X_MOZ_PLACE_CONTAINER) {</span>
<a href="#l13.451"></a><span id="l13.451" class="difflineplus">+          if (node.livemark &amp;&amp; node.annos) {</span>
<a href="#l13.452"></a><span id="l13.452" class="difflineplus">+            transactions.push(</span>
<a href="#l13.453"></a><span id="l13.453" class="difflineplus">+              PlacesUIUtils._getLivemarkCopyTransaction(node, aContainer, index)</span>
<a href="#l13.454"></a><span id="l13.454" class="difflineplus">+            );</span>
<a href="#l13.455"></a><span id="l13.455" class="difflineplus">+          } else {</span>
<a href="#l13.456"></a><span id="l13.456" class="difflineplus">+            transactions.push(</span>
<a href="#l13.457"></a><span id="l13.457" class="difflineplus">+              PlacesUIUtils._getFolderCopyTransaction(node, aContainer, index)</span>
<a href="#l13.458"></a><span id="l13.458" class="difflineplus">+            );</span>
<a href="#l13.459"></a><span id="l13.459" class="difflineplus">+          }</span>
<a href="#l13.460"></a><span id="l13.460" class="difflineplus">+        } else if (node.type == PlacesUtils.TYPE_X_MOZ_PLACE_SEPARATOR) {</span>
<a href="#l13.461"></a><span id="l13.461">           transactions.push(new PlacesCreateSeparatorTransaction(-1, index));</span>
<a href="#l13.462"></a><span id="l13.462" class="difflineminus">-        else if (node.type == PlacesUtils.TYPE_X_MOZ_PLACE)</span>
<a href="#l13.463"></a><span id="l13.463" class="difflineplus">+        } else if (node.type == PlacesUtils.TYPE_X_MOZ_PLACE) {</span>
<a href="#l13.464"></a><span id="l13.464">           transactions.push(</span>
<a href="#l13.465"></a><span id="l13.465">             PlacesUIUtils._getURIItemCopyTransaction(node, -1, index)</span>
<a href="#l13.466"></a><span id="l13.466">           );</span>
<a href="#l13.467"></a><span id="l13.467" class="difflineminus">-        else</span>
<a href="#l13.468"></a><span id="l13.468" class="difflineplus">+        } else {</span>
<a href="#l13.469"></a><span id="l13.469">           throw new Error(&quot;Unexpected item under a bookmarks folder&quot;);</span>
<a href="#l13.470"></a><span id="l13.470" class="difflineminus">-      });</span>
<a href="#l13.471"></a><span id="l13.471" class="difflineplus">+        }</span>
<a href="#l13.472"></a><span id="l13.472" class="difflineplus">+      }</span>
<a href="#l13.473"></a><span id="l13.473">       return transactions;</span>
<a href="#l13.474"></a><span id="l13.474">     }</span>
<a href="#l13.475"></a><span id="l13.475"> </span>
<a href="#l13.476"></a><span id="l13.476" class="difflineminus">-    if (aContainer == PlacesUtils.tagsFolderId) { // Copying a tag folder.</span>
<a href="#l13.477"></a><span id="l13.477" class="difflineplus">+    if (aContainer == PlacesUtils.tagsFolderId) { // Copying into a tag folder.</span>
<a href="#l13.478"></a><span id="l13.478">       let transactions = [];</span>
<a href="#l13.479"></a><span id="l13.479" class="difflineminus">-      if (aData.children) {</span>
<a href="#l13.480"></a><span id="l13.480" class="difflineminus">-        aData.children.forEach(function(aChild) {</span>
<a href="#l13.481"></a><span id="l13.481" class="difflineplus">+      if (!aData.livemark &amp;&amp; aData.type == PlacesUtils.TYPE_X_MOZ_PLACE_CONTAINER) {</span>
<a href="#l13.482"></a><span id="l13.482" class="difflineplus">+        let {root} = PlacesUtils.getFolderContents(aData.id, false, false);</span>
<a href="#l13.483"></a><span id="l13.483" class="difflineplus">+        let urls = PlacesUtils.getURLsForContainerNode(root);</span>
<a href="#l13.484"></a><span id="l13.484" class="difflineplus">+        root.containerOpen = false;</span>
<a href="#l13.485"></a><span id="l13.485" class="difflineplus">+        for (let { uri } of urls) {</span>
<a href="#l13.486"></a><span id="l13.486">           transactions.push(</span>
<a href="#l13.487"></a><span id="l13.487" class="difflineminus">-            new PlacesTagURITransaction(PlacesUtils._uri(aChild.uri),</span>
<a href="#l13.488"></a><span id="l13.488" class="difflineminus">-                                        [aData.title])</span>
<a href="#l13.489"></a><span id="l13.489" class="difflineplus">+            new PlacesTagURITransaction(NetUtil.newURI(uri), [aData.title])</span>
<a href="#l13.490"></a><span id="l13.490">           );</span>
<a href="#l13.491"></a><span id="l13.491" class="difflineminus">-        });</span>
<a href="#l13.492"></a><span id="l13.492" class="difflineplus">+        }</span>
<a href="#l13.493"></a><span id="l13.493">       }</span>
<a href="#l13.494"></a><span id="l13.494">       return new PlacesAggregatedTransaction(&quot;addTags&quot;, transactions);</span>
<a href="#l13.495"></a><span id="l13.495">     }</span>
<a href="#l13.496"></a><span id="l13.496"> </span>
<a href="#l13.497"></a><span id="l13.497" class="difflineminus">-    if (aData.livemark &amp;&amp; aData.annos) // Copying a livemark.</span>
<a href="#l13.498"></a><span id="l13.498" class="difflineplus">+    if (aData.livemark &amp;&amp; aData.annos) { // Copying a livemark.</span>
<a href="#l13.499"></a><span id="l13.499">       return this._getLivemarkCopyTransaction(aData, aContainer, aIndex);</span>
<a href="#l13.500"></a><span id="l13.500" class="difflineplus">+    }</span>
<a href="#l13.501"></a><span id="l13.501"> </span>
<a href="#l13.502"></a><span id="l13.502" class="difflineminus">-    let transactions = getChildItemsTransactions(aData.children);</span>
<a href="#l13.503"></a><span id="l13.503" class="difflineminus">-    if (aData.dateAdded)</span>
<a href="#l13.504"></a><span id="l13.504" class="difflineplus">+    let {root} = PlacesUtils.getFolderContents(aData.id, false, false);</span>
<a href="#l13.505"></a><span id="l13.505" class="difflineplus">+    let transactions = getChildItemsTransactions(root);</span>
<a href="#l13.506"></a><span id="l13.506" class="difflineplus">+    root.containerOpen = false;</span>
<a href="#l13.507"></a><span id="l13.507" class="difflineplus">+</span>
<a href="#l13.508"></a><span id="l13.508" class="difflineplus">+    if (aData.dateAdded) {</span>
<a href="#l13.509"></a><span id="l13.509">       transactions.push(</span>
<a href="#l13.510"></a><span id="l13.510">         new PlacesEditItemDateAddedTransaction(null, aData.dateAdded)</span>
<a href="#l13.511"></a><span id="l13.511">       );</span>
<a href="#l13.512"></a><span id="l13.512" class="difflineminus">-    if (aData.lastModified)</span>
<a href="#l13.513"></a><span id="l13.513" class="difflineplus">+    }</span>
<a href="#l13.514"></a><span id="l13.514" class="difflineplus">+    if (aData.lastModified) {</span>
<a href="#l13.515"></a><span id="l13.515">       transactions.push(</span>
<a href="#l13.516"></a><span id="l13.516">         new PlacesEditItemLastModifiedTransaction(null, aData.lastModified)</span>
<a href="#l13.517"></a><span id="l13.517" class="difflineminus">-    );</span>
<a href="#l13.518"></a><span id="l13.518" class="difflineplus">+      );</span>
<a href="#l13.519"></a><span id="l13.519" class="difflineplus">+    }</span>
<a href="#l13.520"></a><span id="l13.520"> </span>
<a href="#l13.521"></a><span id="l13.521">     let annos = [];</span>
<a href="#l13.522"></a><span id="l13.522">     if (aData.annos) {</span>
<a href="#l13.523"></a><span id="l13.523" class="difflineminus">-      annos = aData.annos.filter(function (aAnno) {</span>
<a href="#l13.524"></a><span id="l13.524" class="difflineminus">-        return this._copyableAnnotations.indexOf(aAnno.name) != -1;</span>
<a href="#l13.525"></a><span id="l13.525" class="difflineplus">+      annos = aData.annos.filter(function(aAnno) {</span>
<a href="#l13.526"></a><span id="l13.526" class="difflineplus">+        return this._copyableAnnotations.includes(aAnno.name);</span>
<a href="#l13.527"></a><span id="l13.527">       }, this);</span>
<a href="#l13.528"></a><span id="l13.528">     }</span>
<a href="#l13.529"></a><span id="l13.529"> </span>
<a href="#l13.530"></a><span id="l13.530" class="difflineminus">-    return new PlacesCreateFolderTransaction(aData.title, aContainer,</span>
<a href="#l13.531"></a><span id="l13.531" class="difflineminus">-                                             aIndex, annos,</span>
<a href="#l13.532"></a><span id="l13.532" class="difflineminus">-                                             transactions);</span>
<a href="#l13.533"></a><span id="l13.533" class="difflineplus">+    return new PlacesCreateFolderTransaction(aData.title, aContainer, aIndex,</span>
<a href="#l13.534"></a><span id="l13.534" class="difflineplus">+                                             annos, transactions);</span>
<a href="#l13.535"></a><span id="l13.535">   },</span>
<a href="#l13.536"></a><span id="l13.536"> </span>
<a href="#l13.537"></a><span id="l13.537" class="difflineminus">-   /**</span>
<a href="#l13.538"></a><span id="l13.538" class="difflineplus">+  /**</span>
<a href="#l13.539"></a><span id="l13.539">    * Gets a transaction for copying a live bookmark item from one container to</span>
<a href="#l13.540"></a><span id="l13.540">    * another.</span>
<a href="#l13.541"></a><span id="l13.541">    *</span>
<a href="#l13.542"></a><span id="l13.542">    * @param   aData</span>
<a href="#l13.543"></a><span id="l13.543">    *          Unwrapped live bookmarkmark data</span>
<a href="#l13.544"></a><span id="l13.544">    * @param   aContainer</span>
<a href="#l13.545"></a><span id="l13.545">    *          The container we are copying into</span>
<a href="#l13.546"></a><span id="l13.546">    * @param   aIndex</span>
<a href="#l13.547"></a><span id="l13.547" class="difflineat">@@ -229,30 +462,30 @@ var PlacesUIUtils = {</span>
<a href="#l13.548"></a><span id="l13.548">    * @return A nsITransaction object that will perform the copy.</span>
<a href="#l13.549"></a><span id="l13.549">    *</span>
<a href="#l13.550"></a><span id="l13.550">    * @note Since a copy creates a completely new item, only some internal</span>
<a href="#l13.551"></a><span id="l13.551">    *       annotations are synced from the old one.</span>
<a href="#l13.552"></a><span id="l13.552">    * @see this._copyableAnnotations for the list of copyable annotations.</span>
<a href="#l13.553"></a><span id="l13.553">    */</span>
<a href="#l13.554"></a><span id="l13.554">   _getLivemarkCopyTransaction:</span>
<a href="#l13.555"></a><span id="l13.555">   function PUIU__getLivemarkCopyTransaction(aData, aContainer, aIndex) {</span>
<a href="#l13.556"></a><span id="l13.556" class="difflineminus">-    if (!aData.livemark || !aData.annos)</span>
<a href="#l13.557"></a><span id="l13.557" class="difflineminus">-      throw(&quot;node is not a livemark&quot;);</span>
<a href="#l13.558"></a><span id="l13.558" class="difflineplus">+    if (!aData.livemark || !aData.annos) {</span>
<a href="#l13.559"></a><span id="l13.559" class="difflineplus">+      throw new Error(&quot;node is not a livemark&quot;);</span>
<a href="#l13.560"></a><span id="l13.560" class="difflineplus">+    }</span>
<a href="#l13.561"></a><span id="l13.561"> </span>
<a href="#l13.562"></a><span id="l13.562" class="difflineminus">-    let feedURI = null;</span>
<a href="#l13.563"></a><span id="l13.563" class="difflineminus">-    let siteURI = null;</span>
<a href="#l13.564"></a><span id="l13.564" class="difflineplus">+    let feedURI, siteURI;</span>
<a href="#l13.565"></a><span id="l13.565" class="difflineplus">+    let annos = [];</span>
<a href="#l13.566"></a><span id="l13.566">     if (aData.annos) {</span>
<a href="#l13.567"></a><span id="l13.567">       annos = aData.annos.filter(function(aAnno) {</span>
<a href="#l13.568"></a><span id="l13.568">         if (aAnno.name == PlacesUtils.LMANNO_FEEDURI) {</span>
<a href="#l13.569"></a><span id="l13.569">           feedURI = PlacesUtils._uri(aAnno.value);</span>
<a href="#l13.570"></a><span id="l13.570" class="difflineminus">-        }</span>
<a href="#l13.571"></a><span id="l13.571" class="difflineminus">-        else if (aAnno.name == PlacesUtils.LMANNO_SITEURI) {</span>
<a href="#l13.572"></a><span id="l13.572" class="difflineplus">+        } else if (aAnno.name == PlacesUtils.LMANNO_SITEURI) {</span>
<a href="#l13.573"></a><span id="l13.573">           siteURI = PlacesUtils._uri(aAnno.value);</span>
<a href="#l13.574"></a><span id="l13.574">         }</span>
<a href="#l13.575"></a><span id="l13.575" class="difflineminus">-        return this._copyableAnnotations.indexOf(aAnno.name) != -1</span>
<a href="#l13.576"></a><span id="l13.576" class="difflineplus">+        return this._copyableAnnotations.includes(aAnno.name)</span>
<a href="#l13.577"></a><span id="l13.577">       }, this);</span>
<a href="#l13.578"></a><span id="l13.578">     }</span>
<a href="#l13.579"></a><span id="l13.579"> </span>
<a href="#l13.580"></a><span id="l13.580">     return new PlacesCreateLivemarkTransaction(feedURI, siteURI, aData.title,</span>
<a href="#l13.581"></a><span id="l13.581">                                                aContainer, aIndex, annos);</span>
<a href="#l13.582"></a><span id="l13.582">   },</span>
<a href="#l13.583"></a><span id="l13.583"> </span>
<a href="#l13.584"></a><span id="l13.584">   /**</span>
<a href="#l13.585"></a><span id="l13.585" class="difflineat">@@ -263,418 +496,175 @@ var PlacesUIUtils = {</span>
<a href="#l13.586"></a><span id="l13.586">    * @param   type</span>
<a href="#l13.587"></a><span id="l13.587">    *          The content type of the data</span>
<a href="#l13.588"></a><span id="l13.588">    * @param   container</span>
<a href="#l13.589"></a><span id="l13.589">    *          The container the data was dropped or pasted into</span>
<a href="#l13.590"></a><span id="l13.590">    * @param   index</span>
<a href="#l13.591"></a><span id="l13.591">    *          The index within the container the item was dropped or pasted at</span>
<a href="#l13.592"></a><span id="l13.592">    * @param   copy</span>
<a href="#l13.593"></a><span id="l13.593">    *          The drag action was copy, so don't move folders or links.</span>
<a href="#l13.594"></a><span id="l13.594" class="difflineminus">-   * @returns An object implementing nsITransaction that can perform</span>
<a href="#l13.595"></a><span id="l13.595" class="difflineminus">-   *          the move/insert.</span>
<a href="#l13.596"></a><span id="l13.596" class="difflineplus">+   * @return An object implementing nsITransaction that can perform</span>
<a href="#l13.597"></a><span id="l13.597" class="difflineplus">+   *         the move/insert.</span>
<a href="#l13.598"></a><span id="l13.598">    */</span>
<a href="#l13.599"></a><span id="l13.599" class="difflineminus">-  makeTransaction: function PUIU_makeTransaction(data, type, container,</span>
<a href="#l13.600"></a><span id="l13.600" class="difflineminus">-                                                 index, copy) {</span>
<a href="#l13.601"></a><span id="l13.601" class="difflineplus">+  makeTransaction:</span>
<a href="#l13.602"></a><span id="l13.602" class="difflineplus">+  function PUIU_makeTransaction(data, type, container, index, copy) {</span>
<a href="#l13.603"></a><span id="l13.603">     switch (data.type) {</span>
<a href="#l13.604"></a><span id="l13.604">       case PlacesUtils.TYPE_X_MOZ_PLACE_CONTAINER:</span>
<a href="#l13.605"></a><span id="l13.605" class="difflineminus">-        if (copy)</span>
<a href="#l13.606"></a><span id="l13.606" class="difflineplus">+        if (copy) {</span>
<a href="#l13.607"></a><span id="l13.607">           return this._getFolderCopyTransaction(data, container, index);</span>
<a href="#l13.608"></a><span id="l13.608" class="difflineminus">-        // Otherwise move the item.</span>
<a href="#l13.609"></a><span id="l13.609" class="difflineminus">-        return new PlacesMoveItemTransaction(data.id, container, index);</span>
<a href="#l13.610"></a><span id="l13.610" class="difflineminus">-        break;</span>
<a href="#l13.611"></a><span id="l13.611" class="difflineminus">-      case PlacesUtils.TYPE_X_MOZ_PLACE:</span>
<a href="#l13.612"></a><span id="l13.612" class="difflineminus">-        if (copy || data.id == -1) // id is -1 if the place is not bookmarked</span>
<a href="#l13.613"></a><span id="l13.613" class="difflineminus">-          return this._getURIItemCopyTransaction(data, container, index);</span>
<a href="#l13.614"></a><span id="l13.614" class="difflineplus">+        }</span>
<a href="#l13.615"></a><span id="l13.615"> </span>
<a href="#l13.616"></a><span id="l13.616">         // Otherwise move the item.</span>
<a href="#l13.617"></a><span id="l13.617">         return new PlacesMoveItemTransaction(data.id, container, index);</span>
<a href="#l13.618"></a><span id="l13.618" class="difflineminus">-        break;</span>
<a href="#l13.619"></a><span id="l13.619" class="difflineplus">+      case PlacesUtils.TYPE_X_MOZ_PLACE:</span>
<a href="#l13.620"></a><span id="l13.620" class="difflineplus">+        if (copy || data.id == -1) { // Id is -1 if the place is not bookmarked.</span>
<a href="#l13.621"></a><span id="l13.621" class="difflineplus">+          return this._getURIItemCopyTransaction(data, container, index);</span>
<a href="#l13.622"></a><span id="l13.622" class="difflineplus">+        }</span>
<a href="#l13.623"></a><span id="l13.623" class="difflineplus">+</span>
<a href="#l13.624"></a><span id="l13.624" class="difflineplus">+        // Otherwise move the item.</span>
<a href="#l13.625"></a><span id="l13.625" class="difflineplus">+        return new PlacesMoveItemTransaction(data.id, container, index);</span>
<a href="#l13.626"></a><span id="l13.626">       case PlacesUtils.TYPE_X_MOZ_PLACE_SEPARATOR:</span>
<a href="#l13.627"></a><span id="l13.627">         if (copy) {</span>
<a href="#l13.628"></a><span id="l13.628">           // There is no data in a separator, so copying it just amounts to</span>
<a href="#l13.629"></a><span id="l13.629">           // inserting a new separator.</span>
<a href="#l13.630"></a><span id="l13.630">           return new PlacesCreateSeparatorTransaction(container, index);</span>
<a href="#l13.631"></a><span id="l13.631">         }</span>
<a href="#l13.632"></a><span id="l13.632"> </span>
<a href="#l13.633"></a><span id="l13.633" class="difflineplus">+        // Otherwise move the item.</span>
<a href="#l13.634"></a><span id="l13.634">         return new PlacesMoveItemTransaction(data.id, container, index);</span>
<a href="#l13.635"></a><span id="l13.635" class="difflineminus">-        break;</span>
<a href="#l13.636"></a><span id="l13.636">       default:</span>
<a href="#l13.637"></a><span id="l13.637">         if (type == PlacesUtils.TYPE_X_MOZ_URL ||</span>
<a href="#l13.638"></a><span id="l13.638">             type == PlacesUtils.TYPE_UNICODE ||</span>
<a href="#l13.639"></a><span id="l13.639" class="difflineminus">-            type == this.TYPE_TAB_DROP) {</span>
<a href="#l13.640"></a><span id="l13.640" class="difflineminus">-          let title = (type != PlacesUtils.TYPE_UNICODE) ? data.title :</span>
<a href="#l13.641"></a><span id="l13.641" class="difflineminus">-                                                             data.uri;</span>
<a href="#l13.642"></a><span id="l13.642" class="difflineplus">+            type == TAB_DROP_TYPE) {</span>
<a href="#l13.643"></a><span id="l13.643" class="difflineplus">+          let title = type != PlacesUtils.TYPE_UNICODE ? data.title</span>
<a href="#l13.644"></a><span id="l13.644" class="difflineplus">+                                                       : data.uri;</span>
<a href="#l13.645"></a><span id="l13.645">           return new PlacesCreateBookmarkTransaction(PlacesUtils._uri(data.uri),</span>
<a href="#l13.646"></a><span id="l13.646">                                                      container, index, title);</span>
<a href="#l13.647"></a><span id="l13.647">         }</span>
<a href="#l13.648"></a><span id="l13.648">     }</span>
<a href="#l13.649"></a><span id="l13.649">     return null;</span>
<a href="#l13.650"></a><span id="l13.650">   },</span>
<a href="#l13.651"></a><span id="l13.651"> </span>
<a href="#l13.652"></a><span id="l13.652">   /**</span>
<a href="#l13.653"></a><span id="l13.653" class="difflineminus">-   * Methods to show the bookmarkProperties dialog in its various modes.</span>
<a href="#l13.654"></a><span id="l13.654" class="difflineplus">+   * ********* PlacesTransactions version of the function defined above ********</span>
<a href="#l13.655"></a><span id="l13.655">    *</span>
<a href="#l13.656"></a><span id="l13.656" class="difflineminus">-   * The showMinimalAdd* methods open the dialog by its alternative URI. Thus</span>
<a href="#l13.657"></a><span id="l13.657" class="difflineminus">-   * they persist the dialog dimensions separately from the showAdd* methods.</span>
<a href="#l13.658"></a><span id="l13.658" class="difflineminus">-   * Note these variants also do not return the dialog &quot;performed&quot; state since</span>
<a href="#l13.659"></a><span id="l13.659" class="difflineminus">-   * they may not open the dialog modally.</span>
<a href="#l13.660"></a><span id="l13.660" class="difflineminus">-   */</span>
<a href="#l13.661"></a><span id="l13.661" class="difflineminus">-</span>
<a href="#l13.662"></a><span id="l13.662" class="difflineminus">-  /**</span>
<a href="#l13.663"></a><span id="l13.663" class="difflineminus">-   * Shows the &quot;Add Bookmark&quot; dialog.</span>
<a href="#l13.664"></a><span id="l13.664" class="difflineplus">+   * Constructs a Places Transaction for the drop or paste of a blob of data</span>
<a href="#l13.665"></a><span id="l13.665" class="difflineplus">+   * into a container.</span>
<a href="#l13.666"></a><span id="l13.666">    *</span>
<a href="#l13.667"></a><span id="l13.667" class="difflineminus">-   * @param [optional] aURI</span>
<a href="#l13.668"></a><span id="l13.668" class="difflineminus">-   *        An nsIURI object for which the &quot;add bookmark&quot; dialog is</span>
<a href="#l13.669"></a><span id="l13.669" class="difflineminus">-   *        to be shown.</span>
<a href="#l13.670"></a><span id="l13.670" class="difflineminus">-   * @param [optional] aTitle</span>
<a href="#l13.671"></a><span id="l13.671" class="difflineminus">-   *        The default title for the new bookmark.</span>
<a href="#l13.672"></a><span id="l13.672" class="difflineminus">-   * @param [optional] aDescription</span>
<a href="#l13.673"></a><span id="l13.673" class="difflineminus">-            The default description for the new bookmark</span>
<a href="#l13.674"></a><span id="l13.674" class="difflineminus">-   * @param [optional] aDefaultInsertionPoint</span>
<a href="#l13.675"></a><span id="l13.675" class="difflineminus">-   *        The default insertion point for the new item. If set, the folder</span>
<a href="#l13.676"></a><span id="l13.676" class="difflineminus">-   *        picker would be hidden unless aShowPicker is set to true, in which</span>
<a href="#l13.677"></a><span id="l13.677" class="difflineminus">-   *        case the dialog only uses the folder identifier from the insertion</span>
<a href="#l13.678"></a><span id="l13.678" class="difflineminus">-   *        point as the initially selected item in the folder picker.</span>
<a href="#l13.679"></a><span id="l13.679" class="difflineminus">-   * @param [optional] aShowPicker</span>
<a href="#l13.680"></a><span id="l13.680" class="difflineminus">-   *        see above</span>
<a href="#l13.681"></a><span id="l13.681" class="difflineminus">-   * @param [optional] aKeyword</span>
<a href="#l13.682"></a><span id="l13.682" class="difflineminus">-   *        The default keyword for the new bookmark. The keyword field</span>
<a href="#l13.683"></a><span id="l13.683" class="difflineminus">-   *        will be shown in the dialog if this is used.</span>
<a href="#l13.684"></a><span id="l13.684" class="difflineminus">-   * @param [optional] aPostData</span>
<a href="#l13.685"></a><span id="l13.685" class="difflineminus">-   *        POST data for POST-style keywords.</span>
<a href="#l13.686"></a><span id="l13.686" class="difflineminus">-   * @param [optional] aCharSet</span>
<a href="#l13.687"></a><span id="l13.687" class="difflineminus">-   *        The character set for the bookmarked page.</span>
<a href="#l13.688"></a><span id="l13.688" class="difflineminus">-   * @param [optional] aHiddenRows</span>
<a href="#l13.689"></a><span id="l13.689" class="difflineminus">-   *        An array of rows to hide that is passed through to the</span>
<a href="#l13.690"></a><span id="l13.690" class="difflineminus">-            bookmark properties dialog.</span>
<a href="#l13.691"></a><span id="l13.691" class="difflineminus">-   * @return true if any transaction has been performed.</span>
<a href="#l13.692"></a><span id="l13.692" class="difflineplus">+   * @param   aData</span>
<a href="#l13.693"></a><span id="l13.693" class="difflineplus">+   *          The unwrapped data blob of dropped or pasted data.</span>
<a href="#l13.694"></a><span id="l13.694" class="difflineplus">+   * @param   aType</span>
<a href="#l13.695"></a><span id="l13.695" class="difflineplus">+   *          The content type of the data.</span>
<a href="#l13.696"></a><span id="l13.696" class="difflineplus">+   * @param   aNewParentGuid</span>
<a href="#l13.697"></a><span id="l13.697" class="difflineplus">+   *          GUID of the container the data was dropped or pasted into.</span>
<a href="#l13.698"></a><span id="l13.698" class="difflineplus">+   * @param   aIndex</span>
<a href="#l13.699"></a><span id="l13.699" class="difflineplus">+   *          The index within the container the item was dropped or pasted at.</span>
<a href="#l13.700"></a><span id="l13.700" class="difflineplus">+   * @param   aCopy</span>
<a href="#l13.701"></a><span id="l13.701" class="difflineplus">+   *          The drag action was copy, so don't move folders or links.</span>
<a href="#l13.702"></a><span id="l13.702">    *</span>
<a href="#l13.703"></a><span id="l13.703" class="difflineminus">-   * Notes:</span>
<a href="#l13.704"></a><span id="l13.704" class="difflineminus">-   *  - the location and description fields are</span>
<a href="#l13.705"></a><span id="l13.705" class="difflineminus">-   *    visible only if there is no initial URI (aURI is null).</span>
<a href="#l13.706"></a><span id="l13.706" class="difflineminus">-   *  - When aDefaultInsertionPoint is not set, the dialog defaults to the</span>
<a href="#l13.707"></a><span id="l13.707" class="difflineminus">-   *    bookmarks root folder.</span>
<a href="#l13.708"></a><span id="l13.708" class="difflineplus">+   * @return  a Places Transaction that can be transacted for performing the</span>
<a href="#l13.709"></a><span id="l13.709" class="difflineplus">+   *          move/insert command.</span>
<a href="#l13.710"></a><span id="l13.710">    */</span>
<a href="#l13.711"></a><span id="l13.711" class="difflineminus">-  showAddBookmarkUI: function PUIU_showAddBookmarkUI(aURI,</span>
<a href="#l13.712"></a><span id="l13.712" class="difflineminus">-                                                     aTitle,</span>
<a href="#l13.713"></a><span id="l13.713" class="difflineminus">-                                                     aDescription,</span>
<a href="#l13.714"></a><span id="l13.714" class="difflineminus">-                                                     aDefaultInsertionPoint,</span>
<a href="#l13.715"></a><span id="l13.715" class="difflineminus">-                                                     aShowPicker,</span>
<a href="#l13.716"></a><span id="l13.716" class="difflineminus">-                                                     aLoadInSidebar,</span>
<a href="#l13.717"></a><span id="l13.717" class="difflineminus">-                                                     aKeyword,</span>
<a href="#l13.718"></a><span id="l13.718" class="difflineminus">-                                                     aPostData,</span>
<a href="#l13.719"></a><span id="l13.719" class="difflineminus">-                                                     aCharSet,</span>
<a href="#l13.720"></a><span id="l13.720" class="difflineminus">-                                                     aHiddenRows) {</span>
<a href="#l13.721"></a><span id="l13.721" class="difflineminus">-    var info = {</span>
<a href="#l13.722"></a><span id="l13.722" class="difflineminus">-      action: &quot;add&quot;,</span>
<a href="#l13.723"></a><span id="l13.723" class="difflineminus">-      type: &quot;bookmark&quot;</span>
<a href="#l13.724"></a><span id="l13.724" class="difflineminus">-    };</span>
<a href="#l13.725"></a><span id="l13.725" class="difflineplus">+  getTransactionForData(aData, aType, aNewParentGuid, aIndex, aCopy) {</span>
<a href="#l13.726"></a><span id="l13.726" class="difflineplus">+    if (!this.SUPPORTED_FLAVORS.includes(aData.type))</span>
<a href="#l13.727"></a><span id="l13.727" class="difflineplus">+      throw new Error(`Unsupported '${aData.type}' data type`);</span>
<a href="#l13.728"></a><span id="l13.728" class="difflineplus">+</span>
<a href="#l13.729"></a><span id="l13.729" class="difflineplus">+    if (&quot;itemGuid&quot; in aData) {</span>
<a href="#l13.730"></a><span id="l13.730" class="difflineplus">+      if (!this.PLACES_FLAVORS.includes(aData.type))</span>
<a href="#l13.731"></a><span id="l13.731" class="difflineplus">+        throw new Error(`itemGuid unexpectedly set on ${aData.type} data`);</span>
<a href="#l13.732"></a><span id="l13.732"> </span>
<a href="#l13.733"></a><span id="l13.733" class="difflineminus">-    if (aURI)</span>
<a href="#l13.734"></a><span id="l13.734" class="difflineminus">-      info.uri = aURI;</span>
<a href="#l13.735"></a><span id="l13.735" class="difflineminus">-</span>
<a href="#l13.736"></a><span id="l13.736" class="difflineminus">-    // allow default empty title</span>
<a href="#l13.737"></a><span id="l13.737" class="difflineminus">-    if (typeof(aTitle) == &quot;string&quot;)</span>
<a href="#l13.738"></a><span id="l13.738" class="difflineminus">-      info.title = aTitle;</span>
<a href="#l13.739"></a><span id="l13.739" class="difflineminus">-</span>
<a href="#l13.740"></a><span id="l13.740" class="difflineminus">-    if (aDescription)</span>
<a href="#l13.741"></a><span id="l13.741" class="difflineminus">-      info.description = aDescription;</span>
<a href="#l13.742"></a><span id="l13.742" class="difflineminus">-</span>
<a href="#l13.743"></a><span id="l13.743" class="difflineminus">-    info.hiddenRows = aHiddenRows || [];</span>
<a href="#l13.744"></a><span id="l13.744" class="difflineminus">-</span>
<a href="#l13.745"></a><span id="l13.745" class="difflineminus">-    if (aDefaultInsertionPoint) {</span>
<a href="#l13.746"></a><span id="l13.746" class="difflineminus">-      info.defaultInsertionPoint = aDefaultInsertionPoint;</span>
<a href="#l13.747"></a><span id="l13.747" class="difflineminus">-      if (!aShowPicker)</span>
<a href="#l13.748"></a><span id="l13.748" class="difflineminus">-        info.hiddenRows.push(&quot;folderPicker&quot;);</span>
<a href="#l13.749"></a><span id="l13.749" class="difflineplus">+      let info = { guid: aData.itemGuid,</span>
<a href="#l13.750"></a><span id="l13.750" class="difflineplus">+                   newParentGuid: aNewParentGuid,</span>
<a href="#l13.751"></a><span id="l13.751" class="difflineplus">+                   newIndex: aIndex };</span>
<a href="#l13.752"></a><span id="l13.752" class="difflineplus">+      if (aCopy) {</span>
<a href="#l13.753"></a><span id="l13.753" class="difflineplus">+        info.excludingAnnotation = &quot;Places/SmartBookmark&quot;;</span>
<a href="#l13.754"></a><span id="l13.754" class="difflineplus">+        return PlacesTransactions.Copy(info);</span>
<a href="#l13.755"></a><span id="l13.755" class="difflineplus">+      }</span>
<a href="#l13.756"></a><span id="l13.756" class="difflineplus">+      return PlacesTransactions.Move(info);</span>
<a href="#l13.757"></a><span id="l13.757">     }</span>
<a href="#l13.758"></a><span id="l13.758"> </span>
<a href="#l13.759"></a><span id="l13.759" class="difflineminus">-    if (typeof(aKeyword) == &quot;string&quot;) {</span>
<a href="#l13.760"></a><span id="l13.760" class="difflineminus">-      info.keyword = aKeyword;</span>
<a href="#l13.761"></a><span id="l13.761" class="difflineminus">-      if (typeof(aPostData) == &quot;string&quot;)</span>
<a href="#l13.762"></a><span id="l13.762" class="difflineminus">-        info.postData = aPostData;</span>
<a href="#l13.763"></a><span id="l13.763" class="difflineminus">-      if (typeof(aCharSet) == &quot;string&quot;)</span>
<a href="#l13.764"></a><span id="l13.764" class="difflineminus">-        info.charSet = aCharSet;</span>
<a href="#l13.765"></a><span id="l13.765" class="difflineplus">+    // Since it's cheap and harmless, we allow the paste of separators and</span>
<a href="#l13.766"></a><span id="l13.766" class="difflineplus">+    // bookmarks from builds that use legacy transactions (i.e. when itemGuid</span>
<a href="#l13.767"></a><span id="l13.767" class="difflineplus">+    // was not set on PLACES_FLAVORS data). Containers are a different story,</span>
<a href="#l13.768"></a><span id="l13.768" class="difflineplus">+    // and thus disallowed.</span>
<a href="#l13.769"></a><span id="l13.769" class="difflineplus">+    if (aData.type == PlacesUtils.TYPE_X_MOZ_PLACE_CONTAINER)</span>
<a href="#l13.770"></a><span id="l13.770" class="difflineplus">+      throw new Error(&quot;Can't copy a container from a legacy-transactions build&quot;);</span>
<a href="#l13.771"></a><span id="l13.771" class="difflineplus">+</span>
<a href="#l13.772"></a><span id="l13.772" class="difflineplus">+    if (aData.type == PlacesUtils.TYPE_X_MOZ_PLACE_SEPARATOR) {</span>
<a href="#l13.773"></a><span id="l13.773" class="difflineplus">+      return PlacesTransactions.NewSeparator({ parentGuid: aNewParentGuid,</span>
<a href="#l13.774"></a><span id="l13.774" class="difflineplus">+                                               index: aIndex });</span>
<a href="#l13.775"></a><span id="l13.775">     }</span>
<a href="#l13.776"></a><span id="l13.776"> </span>
<a href="#l13.777"></a><span id="l13.777" class="difflineminus">-    return this._showBookmarkDialog(info);</span>
<a href="#l13.778"></a><span id="l13.778" class="difflineminus">-  },</span>
<a href="#l13.779"></a><span id="l13.779" class="difflineminus">-</span>
<a href="#l13.780"></a><span id="l13.780" class="difflineminus">-  /**</span>
<a href="#l13.781"></a><span id="l13.781" class="difflineminus">-   * @see showAddBookmarkUI</span>
<a href="#l13.782"></a><span id="l13.782" class="difflineminus">-   * This opens the dialog with only the name and folder pickers visible by</span>
<a href="#l13.783"></a><span id="l13.783" class="difflineminus">-   * default.</span>
<a href="#l13.784"></a><span id="l13.784" class="difflineminus">-   *</span>
<a href="#l13.785"></a><span id="l13.785" class="difflineminus">-   * You can still pass in the various paramaters as the default properties</span>
<a href="#l13.786"></a><span id="l13.786" class="difflineminus">-   * for the new bookmark.</span>
<a href="#l13.787"></a><span id="l13.787" class="difflineminus">-   *</span>
<a href="#l13.788"></a><span id="l13.788" class="difflineminus">-   * The keyword field will be visible only if the aKeyword parameter</span>
<a href="#l13.789"></a><span id="l13.789" class="difflineminus">-   * was used.</span>
<a href="#l13.790"></a><span id="l13.790" class="difflineminus">-   */</span>
<a href="#l13.791"></a><span id="l13.791" class="difflineminus">-  showMinimalAddBookmarkUI:</span>
<a href="#l13.792"></a><span id="l13.792" class="difflineminus">-  function PUIU_showMinimalAddBookmarkUI(aURI, aTitle, aDescription,</span>
<a href="#l13.793"></a><span id="l13.793" class="difflineminus">-                                         aDefaultInsertionPoint, aShowPicker,</span>
<a href="#l13.794"></a><span id="l13.794" class="difflineminus">-                                         aLoadInSidebar, aKeyword, aPostData,</span>
<a href="#l13.795"></a><span id="l13.795" class="difflineminus">-                                         aCharSet) {</span>
<a href="#l13.796"></a><span id="l13.796" class="difflineminus">-    var info = {</span>
<a href="#l13.797"></a><span id="l13.797" class="difflineminus">-      action: &quot;add&quot;,</span>
<a href="#l13.798"></a><span id="l13.798" class="difflineminus">-      type: &quot;bookmark&quot;,</span>
<a href="#l13.799"></a><span id="l13.799" class="difflineminus">-      hiddenRows: [&quot;description&quot;]</span>
<a href="#l13.800"></a><span id="l13.800" class="difflineminus">-    };</span>
<a href="#l13.801"></a><span id="l13.801" class="difflineminus">-    if (aURI)</span>
<a href="#l13.802"></a><span id="l13.802" class="difflineminus">-      info.uri = aURI;</span>
<a href="#l13.803"></a><span id="l13.803" class="difflineminus">-</span>
<a href="#l13.804"></a><span id="l13.804" class="difflineminus">-    // allow default empty title</span>
<a href="#l13.805"></a><span id="l13.805" class="difflineminus">-    if (typeof(aTitle) == &quot;string&quot;)</span>
<a href="#l13.806"></a><span id="l13.806" class="difflineminus">-      info.title = aTitle;</span>
<a href="#l13.807"></a><span id="l13.807" class="difflineminus">-</span>
<a href="#l13.808"></a><span id="l13.808" class="difflineminus">-    if (aDescription)</span>
<a href="#l13.809"></a><span id="l13.809" class="difflineminus">-      info.description = aDescription;</span>
<a href="#l13.810"></a><span id="l13.810" class="difflineminus">-</span>
<a href="#l13.811"></a><span id="l13.811" class="difflineminus">-    if (aDefaultInsertionPoint) {</span>
<a href="#l13.812"></a><span id="l13.812" class="difflineminus">-      info.defaultInsertionPoint = aDefaultInsertionPoint;</span>
<a href="#l13.813"></a><span id="l13.813" class="difflineminus">-      if (!aShowPicker)</span>
<a href="#l13.814"></a><span id="l13.814" class="difflineminus">-        info.hiddenRows.push(&quot;folderPicker&quot;);</span>
<a href="#l13.815"></a><span id="l13.815" class="difflineminus">-    }</span>
<a href="#l13.816"></a><span id="l13.816" class="difflineminus">-</span>
<a href="#l13.817"></a><span id="l13.817" class="difflineminus">-    info.hiddenRows = info.hiddenRows.concat([&quot;location&quot;]);</span>
<a href="#l13.818"></a><span id="l13.818" class="difflineminus">-</span>
<a href="#l13.819"></a><span id="l13.819" class="difflineminus">-    if (typeof(aKeyword) == &quot;string&quot;) {</span>
<a href="#l13.820"></a><span id="l13.820" class="difflineminus">-      info.keyword = aKeyword;</span>
<a href="#l13.821"></a><span id="l13.821" class="difflineminus">-      // Hide the Tags field if we are adding a keyword.</span>
<a href="#l13.822"></a><span id="l13.822" class="difflineminus">-      info.hiddenRows.push(&quot;tags&quot;);</span>
<a href="#l13.823"></a><span id="l13.823" class="difflineminus">-      // Keyword related params.</span>
<a href="#l13.824"></a><span id="l13.824" class="difflineminus">-      if (typeof(aPostData) == &quot;string&quot;)</span>
<a href="#l13.825"></a><span id="l13.825" class="difflineminus">-        info.postData = aPostData;</span>
<a href="#l13.826"></a><span id="l13.826" class="difflineminus">-      if (typeof(aCharSet) == &quot;string&quot;)</span>
<a href="#l13.827"></a><span id="l13.827" class="difflineminus">-        info.charSet = aCharSet;</span>
<a href="#l13.828"></a><span id="l13.828" class="difflineminus">-    }</span>
<a href="#l13.829"></a><span id="l13.829" class="difflineminus">-    else</span>
<a href="#l13.830"></a><span id="l13.830" class="difflineminus">-      info.hiddenRows.push(&quot;keyword&quot;);</span>
<a href="#l13.831"></a><span id="l13.831" class="difflineminus">-</span>
<a href="#l13.832"></a><span id="l13.832" class="difflineminus">-    return this._showBookmarkDialog(info);</span>
<a href="#l13.833"></a><span id="l13.833" class="difflineplus">+    let title = aData.type != PlacesUtils.TYPE_UNICODE ? aData.title</span>
<a href="#l13.834"></a><span id="l13.834" class="difflineplus">+                                                       : aData.uri;</span>
<a href="#l13.835"></a><span id="l13.835" class="difflineplus">+    return PlacesTransactions.NewBookmark({ url: Services.io.newURI(aData.uri),</span>
<a href="#l13.836"></a><span id="l13.836" class="difflineplus">+                                            title,</span>
<a href="#l13.837"></a><span id="l13.837" class="difflineplus">+                                            parentGuid: aNewParentGuid,</span>
<a href="#l13.838"></a><span id="l13.838" class="difflineplus">+                                            index: aIndex });</span>
<a href="#l13.839"></a><span id="l13.839">   },</span>
<a href="#l13.840"></a><span id="l13.840"> </span>
<a href="#l13.841"></a><span id="l13.841">   /**</span>
<a href="#l13.842"></a><span id="l13.842" class="difflineminus">-   * Shows the &quot;Add Live Bookmark&quot; dialog.</span>
<a href="#l13.843"></a><span id="l13.843" class="difflineminus">-   *</span>
<a href="#l13.844"></a><span id="l13.844" class="difflineminus">-   * @param [optional] aFeedURI</span>
<a href="#l13.845"></a><span id="l13.845" class="difflineminus">-   *        The feed URI for which the dialog is to be shown (nsIURI).</span>
<a href="#l13.846"></a><span id="l13.846" class="difflineminus">-   * @param [optional] aSiteURI</span>
<a href="#l13.847"></a><span id="l13.847" class="difflineminus">-   *        The site URI for the new live-bookmark (nsIURI).</span>
<a href="#l13.848"></a><span id="l13.848" class="difflineminus">-   * @param [optional] aDefaultInsertionPoint</span>
<a href="#l13.849"></a><span id="l13.849" class="difflineminus">-   *        The default insertion point for the new item. If set, the folder</span>
<a href="#l13.850"></a><span id="l13.850" class="difflineminus">-   *        picker would be hidden unless aShowPicker is set to true, in which</span>
<a href="#l13.851"></a><span id="l13.851" class="difflineminus">-   *        case the dialog only uses the folder identifier from the insertion</span>
<a href="#l13.852"></a><span id="l13.852" class="difflineminus">-   *        point as the initially selected item in the folder picker.</span>
<a href="#l13.853"></a><span id="l13.853" class="difflineminus">-   * @param [optional] aShowPicker</span>
<a href="#l13.854"></a><span id="l13.854" class="difflineminus">-   *        see above</span>
<a href="#l13.855"></a><span id="l13.855" class="difflineminus">-   * @return true if any transaction has been performed.</span>
<a href="#l13.856"></a><span id="l13.856" class="difflineminus">-   *</span>
<a href="#l13.857"></a><span id="l13.857" class="difflineminus">-   * Notes:</span>
<a href="#l13.858"></a><span id="l13.858" class="difflineminus">-   *  - the feedURI and description fields are visible only if there is no</span>
<a href="#l13.859"></a><span id="l13.859" class="difflineminus">-   *    initial feed URI (aFeedURI is null).</span>
<a href="#l13.860"></a><span id="l13.860" class="difflineminus">-   *  - When aDefaultInsertionPoint is not set, the dialog defaults to the</span>
<a href="#l13.861"></a><span id="l13.861" class="difflineminus">-   *    bookmarks root folder.</span>
<a href="#l13.862"></a><span id="l13.862" class="difflineminus">-   */</span>
<a href="#l13.863"></a><span id="l13.863" class="difflineminus">-  showAddLivemarkUI: function PUIU_showAddLivemarkURI(aFeedURI,</span>
<a href="#l13.864"></a><span id="l13.864" class="difflineminus">-                                                      aSiteURI,</span>
<a href="#l13.865"></a><span id="l13.865" class="difflineminus">-                                                      aTitle,</span>
<a href="#l13.866"></a><span id="l13.866" class="difflineminus">-                                                      aDescription,</span>
<a href="#l13.867"></a><span id="l13.867" class="difflineminus">-                                                      aDefaultInsertionPoint,</span>
<a href="#l13.868"></a><span id="l13.868" class="difflineminus">-                                                      aShowPicker) {</span>
<a href="#l13.869"></a><span id="l13.869" class="difflineminus">-    var info = {</span>
<a href="#l13.870"></a><span id="l13.870" class="difflineminus">-      action: &quot;add&quot;,</span>
<a href="#l13.871"></a><span id="l13.871" class="difflineminus">-      type: &quot;livemark&quot;</span>
<a href="#l13.872"></a><span id="l13.872" class="difflineminus">-    };</span>
<a href="#l13.873"></a><span id="l13.873" class="difflineminus">-</span>
<a href="#l13.874"></a><span id="l13.874" class="difflineminus">-    if (aFeedURI)</span>
<a href="#l13.875"></a><span id="l13.875" class="difflineminus">-      info.feedURI = aFeedURI;</span>
<a href="#l13.876"></a><span id="l13.876" class="difflineminus">-    if (aSiteURI)</span>
<a href="#l13.877"></a><span id="l13.877" class="difflineminus">-      info.siteURI = aSiteURI;</span>
<a href="#l13.878"></a><span id="l13.878" class="difflineminus">-</span>
<a href="#l13.879"></a><span id="l13.879" class="difflineminus">-    // allow default empty title</span>
<a href="#l13.880"></a><span id="l13.880" class="difflineminus">-    if (typeof(aTitle) == &quot;string&quot;)</span>
<a href="#l13.881"></a><span id="l13.881" class="difflineminus">-      info.title = aTitle;</span>
<a href="#l13.882"></a><span id="l13.882" class="difflineminus">-</span>
<a href="#l13.883"></a><span id="l13.883" class="difflineminus">-    if (aDescription)</span>
<a href="#l13.884"></a><span id="l13.884" class="difflineminus">-      info.description = aDescription;</span>
<a href="#l13.885"></a><span id="l13.885" class="difflineminus">-</span>
<a href="#l13.886"></a><span id="l13.886" class="difflineminus">-    if (aDefaultInsertionPoint) {</span>
<a href="#l13.887"></a><span id="l13.887" class="difflineminus">-      info.defaultInsertionPoint = aDefaultInsertionPoint;</span>
<a href="#l13.888"></a><span id="l13.888" class="difflineminus">-      if (!aShowPicker)</span>
<a href="#l13.889"></a><span id="l13.889" class="difflineminus">-        info.hiddenRows = [&quot;folderPicker&quot;];</span>
<a href="#l13.890"></a><span id="l13.890" class="difflineminus">-    }</span>
<a href="#l13.891"></a><span id="l13.891" class="difflineminus">-    return this._showBookmarkDialog(info);</span>
<a href="#l13.892"></a><span id="l13.892" class="difflineminus">-  },</span>
<a href="#l13.893"></a><span id="l13.893" class="difflineminus">-</span>
<a href="#l13.894"></a><span id="l13.894" class="difflineminus">-  /**</span>
<a href="#l13.895"></a><span id="l13.895" class="difflineminus">-   * @see showAddLivemarkUI</span>
<a href="#l13.896"></a><span id="l13.896" class="difflineminus">-   * This opens the dialog with only the name and folder pickers visible by</span>
<a href="#l13.897"></a><span id="l13.897" class="difflineminus">-   * default.</span>
<a href="#l13.898"></a><span id="l13.898" class="difflineminus">-   *</span>
<a href="#l13.899"></a><span id="l13.899" class="difflineminus">-   * You can still pass in the various paramaters as the default properties</span>
<a href="#l13.900"></a><span id="l13.900" class="difflineminus">-   * for the new live-bookmark.</span>
<a href="#l13.901"></a><span id="l13.901" class="difflineminus">-   */</span>
<a href="#l13.902"></a><span id="l13.902" class="difflineminus">-  showMinimalAddLivemarkUI:</span>
<a href="#l13.903"></a><span id="l13.903" class="difflineminus">-  function PUIU_showMinimalAddLivemarkURI(aFeedURI, aSiteURI, aTitle,</span>
<a href="#l13.904"></a><span id="l13.904" class="difflineminus">-                                          aDescription, aDefaultInsertionPoint,</span>
<a href="#l13.905"></a><span id="l13.905" class="difflineminus">-                                          aShowPicker) {</span>
<a href="#l13.906"></a><span id="l13.906" class="difflineminus">-    var info = {</span>
<a href="#l13.907"></a><span id="l13.907" class="difflineminus">-      action: &quot;add&quot;,</span>
<a href="#l13.908"></a><span id="l13.908" class="difflineminus">-      type: &quot;livemark&quot;,</span>
<a href="#l13.909"></a><span id="l13.909" class="difflineminus">-      hiddenRows: [&quot;feedLocation&quot;, &quot;siteLocation&quot;, &quot;description&quot;]</span>
<a href="#l13.910"></a><span id="l13.910" class="difflineminus">-    };</span>
<a href="#l13.911"></a><span id="l13.911" class="difflineminus">-</span>
<a href="#l13.912"></a><span id="l13.912" class="difflineminus">-    if (aFeedURI)</span>
<a href="#l13.913"></a><span id="l13.913" class="difflineminus">-      info.feedURI = aFeedURI;</span>
<a href="#l13.914"></a><span id="l13.914" class="difflineminus">-    if (aSiteURI)</span>
<a href="#l13.915"></a><span id="l13.915" class="difflineminus">-      info.siteURI = aSiteURI;</span>
<a href="#l13.916"></a><span id="l13.916" class="difflineminus">-</span>
<a href="#l13.917"></a><span id="l13.917" class="difflineminus">-    // allow default empty title</span>
<a href="#l13.918"></a><span id="l13.918" class="difflineminus">-    if (typeof(aTitle) == &quot;string&quot;)</span>
<a href="#l13.919"></a><span id="l13.919" class="difflineminus">-      info.title = aTitle;</span>
<a href="#l13.920"></a><span id="l13.920" class="difflineminus">-</span>
<a href="#l13.921"></a><span id="l13.921" class="difflineminus">-    if (aDescription)</span>
<a href="#l13.922"></a><span id="l13.922" class="difflineminus">-      info.description = aDescription;</span>
<a href="#l13.923"></a><span id="l13.923" class="difflineminus">-</span>
<a href="#l13.924"></a><span id="l13.924" class="difflineminus">-    if (aDefaultInsertionPoint) {</span>
<a href="#l13.925"></a><span id="l13.925" class="difflineminus">-      info.defaultInsertionPoint = aDefaultInsertionPoint;</span>
<a href="#l13.926"></a><span id="l13.926" class="difflineminus">-      if (!aShowPicker)</span>
<a href="#l13.927"></a><span id="l13.927" class="difflineminus">-        info.hiddenRows.push(&quot;folderPicker&quot;);</span>
<a href="#l13.928"></a><span id="l13.928" class="difflineminus">-    }</span>
<a href="#l13.929"></a><span id="l13.929" class="difflineminus">-    return this._showBookmarkDialog(info);</span>
<a href="#l13.930"></a><span id="l13.930" class="difflineminus">-  },</span>
<a href="#l13.931"></a><span id="l13.931" class="difflineminus">-</span>
<a href="#l13.932"></a><span id="l13.932" class="difflineminus">-  /**</span>
<a href="#l13.933"></a><span id="l13.933" class="difflineminus">-   * Show an &quot;Add Bookmarks&quot; dialog to allow the adding of a folder full</span>
<a href="#l13.934"></a><span id="l13.934" class="difflineminus">-   * of bookmarks corresponding to the objects in the uriList.  This will</span>
<a href="#l13.935"></a><span id="l13.935" class="difflineminus">-   * be called most often as the result of a &quot;Bookmark All Tabs...&quot; command.</span>
<a href="#l13.936"></a><span id="l13.936" class="difflineminus">-   *</span>
<a href="#l13.937"></a><span id="l13.937" class="difflineminus">-   * @param aURIList  List of nsIURI objects representing the locations</span>
<a href="#l13.938"></a><span id="l13.938" class="difflineminus">-   *                  to be bookmarked.</span>
<a href="#l13.939"></a><span id="l13.939" class="difflineminus">-   * @param aTitleList  Optional list of strings giving the page titles.</span>
<a href="#l13.940"></a><span id="l13.940" class="difflineminus">-   * @return true if any transaction has been performed.</span>
<a href="#l13.941"></a><span id="l13.941" class="difflineminus">-   */</span>
<a href="#l13.942"></a><span id="l13.942" class="difflineminus">-  showMinimalAddMultiBookmarkUI: function PUIU_showAddMultiBookmarkUI(aURIList, aTitleList) {</span>
<a href="#l13.943"></a><span id="l13.943" class="difflineminus">-    if (aURIList.length == 0)</span>
<a href="#l13.944"></a><span id="l13.944" class="difflineminus">-      throw(&quot;showAddMultiBookmarkUI expects a list of nsIURI objects&quot;);</span>
<a href="#l13.945"></a><span id="l13.945" class="difflineminus">-    var info = {</span>
<a href="#l13.946"></a><span id="l13.946" class="difflineminus">-      action: &quot;add&quot;,</span>
<a href="#l13.947"></a><span id="l13.947" class="difflineminus">-      type: &quot;folder&quot;,</span>
<a href="#l13.948"></a><span id="l13.948" class="difflineminus">-      hiddenRows: [&quot;description&quot;],</span>
<a href="#l13.949"></a><span id="l13.949" class="difflineminus">-      URIList: aURIList</span>
<a href="#l13.950"></a><span id="l13.950" class="difflineminus">-    };</span>
<a href="#l13.951"></a><span id="l13.951" class="difflineminus">-</span>
<a href="#l13.952"></a><span id="l13.952" class="difflineminus">-    if (aTitleList)</span>
<a href="#l13.953"></a><span id="l13.953" class="difflineminus">-      info.titleList = aTitleList;</span>
<a href="#l13.954"></a><span id="l13.954" class="difflineminus">-</span>
<a href="#l13.955"></a><span id="l13.955" class="difflineminus">-    return this._showBookmarkDialog(info);</span>
<a href="#l13.956"></a><span id="l13.956" class="difflineminus">-  },</span>
<a href="#l13.957"></a><span id="l13.957" class="difflineminus">-</span>
<a href="#l13.958"></a><span id="l13.958" class="difflineminus">-  /**</span>
<a href="#l13.959"></a><span id="l13.959" class="difflineminus">-   * Opens the properties dialog for a given item identifier.</span>
<a href="#l13.960"></a><span id="l13.960" class="difflineminus">-   *</span>
<a href="#l13.961"></a><span id="l13.961" class="difflineminus">-   * @param aItemId</span>
<a href="#l13.962"></a><span id="l13.962" class="difflineminus">-   *        item identifier for which the properties are to be shown</span>
<a href="#l13.963"></a><span id="l13.963" class="difflineminus">-   * @param aType</span>
<a href="#l13.964"></a><span id="l13.964" class="difflineminus">-   *        item type, either &quot;bookmark&quot; or &quot;folder&quot;</span>
<a href="#l13.965"></a><span id="l13.965" class="difflineminus">-   * @param [optional] aReadOnly</span>
<a href="#l13.966"></a><span id="l13.966" class="difflineminus">-   *        states if properties dialog should be readonly</span>
<a href="#l13.967"></a><span id="l13.967" class="difflineminus">-   * @return true if any transaction has been performed.</span>
<a href="#l13.968"></a><span id="l13.968" class="difflineminus">-   */</span>
<a href="#l13.969"></a><span id="l13.969" class="difflineminus">-  showItemProperties: function PUIU_showItemProperties(aItemId, aType, aReadOnly) {</span>
<a href="#l13.970"></a><span id="l13.970" class="difflineminus">-    var info = {</span>
<a href="#l13.971"></a><span id="l13.971" class="difflineminus">-      action: &quot;edit&quot;,</span>
<a href="#l13.972"></a><span id="l13.972" class="difflineminus">-      type: aType,</span>
<a href="#l13.973"></a><span id="l13.973" class="difflineminus">-      itemId: aItemId,</span>
<a href="#l13.974"></a><span id="l13.974" class="difflineminus">-      readOnly: aReadOnly</span>
<a href="#l13.975"></a><span id="l13.975" class="difflineminus">-    };</span>
<a href="#l13.976"></a><span id="l13.976" class="difflineminus">-    return this._showBookmarkDialog(info);</span>
<a href="#l13.977"></a><span id="l13.977" class="difflineminus">-  },</span>
<a href="#l13.978"></a><span id="l13.978" class="difflineminus">-</span>
<a href="#l13.979"></a><span id="l13.979" class="difflineminus">-  /**</span>
<a href="#l13.980"></a><span id="l13.980" class="difflineminus">-   * Shows the &quot;New Folder&quot; dialog.</span>
<a href="#l13.981"></a><span id="l13.981" class="difflineminus">-   *</span>
<a href="#l13.982"></a><span id="l13.982" class="difflineminus">-   * @param [optional] aTitle</span>
<a href="#l13.983"></a><span id="l13.983" class="difflineminus">-   *        The default title for the new bookmark.</span>
<a href="#l13.984"></a><span id="l13.984" class="difflineminus">-   * @param [optional] aDefaultInsertionPoint</span>
<a href="#l13.985"></a><span id="l13.985" class="difflineminus">-   *        The default insertion point for the new item. If set, the folder</span>
<a href="#l13.986"></a><span id="l13.986" class="difflineminus">-   *        picker would be hidden unless aShowPicker is set to true, in which</span>
<a href="#l13.987"></a><span id="l13.987" class="difflineminus">-   *        case the dialog only uses the folder identifier from the insertion</span>
<a href="#l13.988"></a><span id="l13.988" class="difflineminus">-   *        point as the initially selected item in the folder picker.</span>
<a href="#l13.989"></a><span id="l13.989" class="difflineminus">-   * @param [optional] aShowPicker</span>
<a href="#l13.990"></a><span id="l13.990" class="difflineminus">-   *        see above</span>
<a href="#l13.991"></a><span id="l13.991" class="difflineminus">-   * @return true if any transaction has been performed.</span>
<a href="#l13.992"></a><span id="l13.992" class="difflineminus">-   */</span>
<a href="#l13.993"></a><span id="l13.993" class="difflineminus">-  showAddFolderUI:</span>
<a href="#l13.994"></a><span id="l13.994" class="difflineminus">-  function PUIU_showAddFolderUI(aTitle, aDefaultInsertionPoint, aShowPicker) {</span>
<a href="#l13.995"></a><span id="l13.995" class="difflineminus">-    var info = {</span>
<a href="#l13.996"></a><span id="l13.996" class="difflineminus">-      action: &quot;add&quot;,</span>
<a href="#l13.997"></a><span id="l13.997" class="difflineminus">-      type: &quot;folder&quot;,</span>
<a href="#l13.998"></a><span id="l13.998" class="difflineminus">-      hiddenRows: []</span>
<a href="#l13.999"></a><span id="l13.999" class="difflineminus">-    };</span>
<a href="#l13.1000"></a><span id="l13.1000" class="difflineminus">-</span>
<a href="#l13.1001"></a><span id="l13.1001" class="difflineminus">-    // allow default empty title</span>
<a href="#l13.1002"></a><span id="l13.1002" class="difflineminus">-    if (typeof(aTitle) == &quot;string&quot;)</span>
<a href="#l13.1003"></a><span id="l13.1003" class="difflineminus">-      info.title = aTitle;</span>
<a href="#l13.1004"></a><span id="l13.1004" class="difflineminus">-</span>
<a href="#l13.1005"></a><span id="l13.1005" class="difflineminus">-    if (aDefaultInsertionPoint) {</span>
<a href="#l13.1006"></a><span id="l13.1006" class="difflineminus">-      info.defaultInsertionPoint = aDefaultInsertionPoint;</span>
<a href="#l13.1007"></a><span id="l13.1007" class="difflineminus">-      if (!aShowPicker)</span>
<a href="#l13.1008"></a><span id="l13.1008" class="difflineminus">-        info.hiddenRows.push(&quot;folderPicker&quot;);</span>
<a href="#l13.1009"></a><span id="l13.1009" class="difflineminus">-    }</span>
<a href="#l13.1010"></a><span id="l13.1010" class="difflineminus">-    return this._showBookmarkDialog(info);</span>
<a href="#l13.1011"></a><span id="l13.1011" class="difflineminus">-  },</span>
<a href="#l13.1012"></a><span id="l13.1012" class="difflineminus">-</span>
<a href="#l13.1013"></a><span id="l13.1013" class="difflineminus">-  /**</span>
<a href="#l13.1014"></a><span id="l13.1014" class="difflineminus">-   * Shows the bookmark dialog corresponding to the specified info</span>
<a href="#l13.1015"></a><span id="l13.1015" class="difflineplus">+   * Shows the bookmark dialog corresponding to the specified info.</span>
<a href="#l13.1016"></a><span id="l13.1016">    *</span>
<a href="#l13.1017"></a><span id="l13.1017">    * @param aInfo</span>
<a href="#l13.1018"></a><span id="l13.1018">    *        Describes the item to be edited/added in the dialog.</span>
<a href="#l13.1019"></a><span id="l13.1019" class="difflineminus">-   *        See documentation at the top of bm-props.js</span>
<a href="#l13.1020"></a><span id="l13.1020" class="difflineminus">-   * @param aMinimalUI</span>
<a href="#l13.1021"></a><span id="l13.1021" class="difflineminus">-   *        [optional] if true, the dialog is opened by its alternative</span>
<a href="#l13.1022"></a><span id="l13.1022" class="difflineminus">-   *        chrome: uri.</span>
<a href="#l13.1023"></a><span id="l13.1023" class="difflineplus">+   *        See documentation at the top of bookmarkProperties.js</span>
<a href="#l13.1024"></a><span id="l13.1024" class="difflineplus">+   * @param aWindow</span>
<a href="#l13.1025"></a><span id="l13.1025" class="difflineplus">+   *        Owner window for the new dialog.</span>
<a href="#l13.1026"></a><span id="l13.1026">    *</span>
<a href="#l13.1027"></a><span id="l13.1027" class="difflineplus">+   * @see documentation at the top of bookmarkProperties.js</span>
<a href="#l13.1028"></a><span id="l13.1028">    * @return true if any transaction has been performed, false otherwise.</span>
<a href="#l13.1029"></a><span id="l13.1029">    */</span>
<a href="#l13.1030"></a><span id="l13.1030" class="difflineminus">-  _showBookmarkDialog: function PUIU__showBookmarkDialog(aInfo) {</span>
<a href="#l13.1031"></a><span id="l13.1031" class="difflineplus">+  showBookmarkDialog:</span>
<a href="#l13.1032"></a><span id="l13.1032" class="difflineplus">+  function PUIU_showBookmarkDialog(aInfo, aParentWindow) {</span>
<a href="#l13.1033"></a><span id="l13.1033">     // Preserve size attributes differently based on the fact the dialog has</span>
<a href="#l13.1034"></a><span id="l13.1034">     // a folder picker or not, since it needs more horizontal space than the</span>
<a href="#l13.1035"></a><span id="l13.1035">     // other controls.</span>
<a href="#l13.1036"></a><span id="l13.1036">     let hasFolderPicker = !(&quot;hiddenRows&quot; in aInfo) ||</span>
<a href="#l13.1037"></a><span id="l13.1037">                           !aInfo.hiddenRows.includes(&quot;folderPicker&quot;);</span>
<a href="#l13.1038"></a><span id="l13.1038">     // Use a different chrome url to persist different sizes.</span>
<a href="#l13.1039"></a><span id="l13.1039">     let dialogURL = hasFolderPicker ?</span>
<a href="#l13.1040"></a><span id="l13.1040" class="difflineminus">-                    &quot;chrome://communicator/content/bookmarks/bm-props2.xul&quot; :</span>
<a href="#l13.1041"></a><span id="l13.1041" class="difflineminus">-                    &quot;chrome://communicator/content/bookmarks/bm-props.xul&quot;;</span>
<a href="#l13.1042"></a><span id="l13.1042" class="difflineplus">+                    &quot;chrome://communicator/content/places/bookmarkProperties2.xul&quot; :</span>
<a href="#l13.1043"></a><span id="l13.1043" class="difflineplus">+                    &quot;chrome://communicator/content/places/bookmarkProperties.xul&quot;;</span>
<a href="#l13.1044"></a><span id="l13.1044"> </span>
<a href="#l13.1045"></a><span id="l13.1045">     let features = &quot;centerscreen,chrome,modal,resizable=yes&quot;;</span>
<a href="#l13.1046"></a><span id="l13.1046" class="difflineminus">-    this._getCurrentActiveWin().openDialog(dialogURL, &quot;&quot;, features, aInfo);</span>
<a href="#l13.1047"></a><span id="l13.1047" class="difflineplus">+    aParentWindow.openDialog(dialogURL, &quot;&quot;, features, aInfo);</span>
<a href="#l13.1048"></a><span id="l13.1048">     return (&quot;performed&quot; in aInfo &amp;&amp; aInfo.performed);</span>
<a href="#l13.1049"></a><span id="l13.1049">   },</span>
<a href="#l13.1050"></a><span id="l13.1050"> </span>
<a href="#l13.1051"></a><span id="l13.1051">   _getTopBrowserWin: function PUIU__getTopBrowserWin() {</span>
<a href="#l13.1052"></a><span id="l13.1052" class="difflineminus">-    return this._getCurrentActiveWin().gPrivate ||</span>
<a href="#l13.1053"></a><span id="l13.1053" class="difflineminus">-           Services.wm.getMostRecentWindow(&quot;navigator:browser&quot;);</span>
<a href="#l13.1054"></a><span id="l13.1054" class="difflineplus">+    return RecentWindow.getMostRecentBrowserWindow();</span>
<a href="#l13.1055"></a><span id="l13.1055">   },</span>
<a href="#l13.1056"></a><span id="l13.1056"> </span>
<a href="#l13.1057"></a><span id="l13.1057" class="difflineminus">-  _getCurrentActiveWin: function PUIU__getCurrentActiveWin() {</span>
<a href="#l13.1058"></a><span id="l13.1058" class="difflineminus">-    return focusManager.activeWindow || Services.wm.getMostRecentWindow(null);</span>
<a href="#l13.1059"></a><span id="l13.1059" class="difflineplus">+  /**</span>
<a href="#l13.1060"></a><span id="l13.1060" class="difflineplus">+   * set and fetch a favicon. Can only be used from the parent process.</span>
<a href="#l13.1061"></a><span id="l13.1061" class="difflineplus">+   * @param browser   {Browser}   The XUL browser element for which we're fetching a favicon.</span>
<a href="#l13.1062"></a><span id="l13.1062" class="difflineplus">+   * @param principal {Principal} The loading principal to use for the fetch.</span>
<a href="#l13.1063"></a><span id="l13.1063" class="difflineplus">+   * @param uri       {URI}       The URI to fetch.</span>
<a href="#l13.1064"></a><span id="l13.1064" class="difflineplus">+   */</span>
<a href="#l13.1065"></a><span id="l13.1065" class="difflineplus">+  loadFavicon(browser, principal, uri) {</span>
<a href="#l13.1066"></a><span id="l13.1066" class="difflineplus">+    if (gInContentProcess) {</span>
<a href="#l13.1067"></a><span id="l13.1067" class="difflineplus">+      throw new Error(&quot;Can't track loads from within the child process!&quot;);</span>
<a href="#l13.1068"></a><span id="l13.1068" class="difflineplus">+    }</span>
<a href="#l13.1069"></a><span id="l13.1069" class="difflineplus">+    InternalFaviconLoader.loadFavicon(browser, principal, uri);</span>
<a href="#l13.1070"></a><span id="l13.1070">   },</span>
<a href="#l13.1071"></a><span id="l13.1071"> </span>
<a href="#l13.1072"></a><span id="l13.1072">   /**</span>
<a href="#l13.1073"></a><span id="l13.1073">    * Returns the closet ancestor places view for the given DOM node</span>
<a href="#l13.1074"></a><span id="l13.1074">    * @param aNode</span>
<a href="#l13.1075"></a><span id="l13.1075">    *        a DOM node</span>
<a href="#l13.1076"></a><span id="l13.1076">    * @return the closet ancestor places view if exists, null otherwsie.</span>
<a href="#l13.1077"></a><span id="l13.1077">    */</span>
<a href="#l13.1078"></a><span id="l13.1078">   getViewForNode: function PUIU_getViewForNode(aNode) {</span>
<a href="#l13.1079"></a><span id="l13.1079">     let node = aNode;</span>
<a href="#l13.1080"></a><span id="l13.1080"> </span>
<a href="#l13.1081"></a><span id="l13.1081" class="difflineplus">+    if (node.localName == &quot;panelview&quot; &amp;&amp; node._placesView) {</span>
<a href="#l13.1082"></a><span id="l13.1082" class="difflineplus">+      return node._placesView;</span>
<a href="#l13.1083"></a><span id="l13.1083" class="difflineplus">+    }</span>
<a href="#l13.1084"></a><span id="l13.1084" class="difflineplus">+</span>
<a href="#l13.1085"></a><span id="l13.1085">     // The view for a &lt;menu&gt; of which its associated menupopup is a places</span>
<a href="#l13.1086"></a><span id="l13.1086">     // view, is the menupopup.</span>
<a href="#l13.1087"></a><span id="l13.1087">     if (node.localName == &quot;menu&quot; &amp;&amp; !node._placesNode &amp;&amp;</span>
<a href="#l13.1088"></a><span id="l13.1088">         node.lastChild._placesView)</span>
<a href="#l13.1089"></a><span id="l13.1089">       return node.lastChild._placesView;</span>
<a href="#l13.1090"></a><span id="l13.1090"> </span>
<a href="#l13.1091"></a><span id="l13.1091">     while (node instanceof Ci.nsIDOMElement) {</span>
<a href="#l13.1092"></a><span id="l13.1092">       if (node._placesView)</span>
<a href="#l13.1093"></a><span id="l13.1093" class="difflineat">@@ -735,70 +725,72 @@ var PlacesUIUtils = {</span>
<a href="#l13.1094"></a><span id="l13.1094">     if (PlacesUtils.nodeIsBookmark(aURINode))</span>
<a href="#l13.1095"></a><span id="l13.1095">       return true;</span>
<a href="#l13.1096"></a><span id="l13.1096"> </span>
<a href="#l13.1097"></a><span id="l13.1097">     var uri = PlacesUtils._uri(aURINode.uri);</span>
<a href="#l13.1098"></a><span id="l13.1098">     if (uri.schemeIs(&quot;javascript&quot;) || uri.schemeIs(&quot;data&quot;)) {</span>
<a href="#l13.1099"></a><span id="l13.1099">       const BRANDING_BUNDLE_URI = &quot;chrome://branding/locale/brand.properties&quot;;</span>
<a href="#l13.1100"></a><span id="l13.1100">       var brandShortName = Cc[&quot;@mozilla.org/intl/stringbundle;1&quot;]</span>
<a href="#l13.1101"></a><span id="l13.1101">                              .getService(Ci.nsIStringBundleService)</span>
<a href="#l13.1102"></a><span id="l13.1102" class="difflineminus">-                             .createBundle(BRANDING_BUNDLE_URI)</span>
<a href="#l13.1103"></a><span id="l13.1103" class="difflineplus">+                             .createBundle(BRANDING_BUNDLE_URI).</span>
<a href="#l13.1104"></a><span id="l13.1104">                              .GetStringFromName(&quot;brandShortName&quot;);</span>
<a href="#l13.1105"></a><span id="l13.1105"> </span>
<a href="#l13.1106"></a><span id="l13.1106">       var errorStr = this.getString(&quot;load-js-data-url-error&quot;);</span>
<a href="#l13.1107"></a><span id="l13.1107">       Services.prompt.alert(aWindow, brandShortName, errorStr);</span>
<a href="#l13.1108"></a><span id="l13.1108">       return false;</span>
<a href="#l13.1109"></a><span id="l13.1109">     }</span>
<a href="#l13.1110"></a><span id="l13.1110">     return true;</span>
<a href="#l13.1111"></a><span id="l13.1111">   },</span>
<a href="#l13.1112"></a><span id="l13.1112"> </span>
<a href="#l13.1113"></a><span id="l13.1113">   /**</span>
<a href="#l13.1114"></a><span id="l13.1114">    * Get the description associated with a document, as specified in a &lt;META&gt;</span>
<a href="#l13.1115"></a><span id="l13.1115">    * element.</span>
<a href="#l13.1116"></a><span id="l13.1116">    * @param   doc</span>
<a href="#l13.1117"></a><span id="l13.1117">    *          A DOM Document to get a description for</span>
<a href="#l13.1118"></a><span id="l13.1118" class="difflineminus">-   * @returns A description string if a META element was discovered with a</span>
<a href="#l13.1119"></a><span id="l13.1119" class="difflineminus">-   *          &quot;description&quot; or &quot;httpequiv&quot; attribute, empty string otherwise.</span>
<a href="#l13.1120"></a><span id="l13.1120" class="difflineplus">+   * @return A description string if a META element was discovered with a</span>
<a href="#l13.1121"></a><span id="l13.1121" class="difflineplus">+   *         &quot;description&quot; or &quot;httpequiv&quot; attribute, empty string otherwise.</span>
<a href="#l13.1122"></a><span id="l13.1122">    */</span>
<a href="#l13.1123"></a><span id="l13.1123">   getDescriptionFromDocument: function PUIU_getDescriptionFromDocument(doc) {</span>
<a href="#l13.1124"></a><span id="l13.1124">     var metaElements = doc.getElementsByTagName(&quot;META&quot;);</span>
<a href="#l13.1125"></a><span id="l13.1125">     for (var i = 0; i &lt; metaElements.length; ++i) {</span>
<a href="#l13.1126"></a><span id="l13.1126">       if (metaElements[i].name.toLowerCase() == &quot;description&quot; ||</span>
<a href="#l13.1127"></a><span id="l13.1127">           metaElements[i].httpEquiv.toLowerCase() == &quot;description&quot;) {</span>
<a href="#l13.1128"></a><span id="l13.1128">         return metaElements[i].content;</span>
<a href="#l13.1129"></a><span id="l13.1129">       }</span>
<a href="#l13.1130"></a><span id="l13.1130">     }</span>
<a href="#l13.1131"></a><span id="l13.1131">     return &quot;&quot;;</span>
<a href="#l13.1132"></a><span id="l13.1132">   },</span>
<a href="#l13.1133"></a><span id="l13.1133"> </span>
<a href="#l13.1134"></a><span id="l13.1134">   /**</span>
<a href="#l13.1135"></a><span id="l13.1135">    * Retrieve the description of an item</span>
<a href="#l13.1136"></a><span id="l13.1136">    * @param aItemId</span>
<a href="#l13.1137"></a><span id="l13.1137">    *        item identifier</span>
<a href="#l13.1138"></a><span id="l13.1138" class="difflineminus">-   * @returns the description of the given item, or an empty string if it is</span>
<a href="#l13.1139"></a><span id="l13.1139" class="difflineplus">+   * @return the description of the given item, or an empty string if it is</span>
<a href="#l13.1140"></a><span id="l13.1140">    * not set.</span>
<a href="#l13.1141"></a><span id="l13.1141">    */</span>
<a href="#l13.1142"></a><span id="l13.1142">   getItemDescription: function PUIU_getItemDescription(aItemId) {</span>
<a href="#l13.1143"></a><span id="l13.1143">     if (PlacesUtils.annotations.itemHasAnnotation(aItemId, this.DESCRIPTION_ANNO))</span>
<a href="#l13.1144"></a><span id="l13.1144">       return PlacesUtils.annotations.getItemAnnotation(aItemId, this.DESCRIPTION_ANNO);</span>
<a href="#l13.1145"></a><span id="l13.1145">     return &quot;&quot;;</span>
<a href="#l13.1146"></a><span id="l13.1146">   },</span>
<a href="#l13.1147"></a><span id="l13.1147"> </span>
<a href="#l13.1148"></a><span id="l13.1148" class="difflineminus">-   /**</span>
<a href="#l13.1149"></a><span id="l13.1149" class="difflineplus">+  /**</span>
<a href="#l13.1150"></a><span id="l13.1150">    * Check whether or not the given node represents a removable entry (either in</span>
<a href="#l13.1151"></a><span id="l13.1151">    * history or in bookmarks).</span>
<a href="#l13.1152"></a><span id="l13.1152">    *</span>
<a href="#l13.1153"></a><span id="l13.1153">    * @param aNode</span>
<a href="#l13.1154"></a><span id="l13.1154">    *        a node, except the root node of a query.</span>
<a href="#l13.1155"></a><span id="l13.1155">    * @return true if the aNode represents a removable entry, false otherwise.</span>
<a href="#l13.1156"></a><span id="l13.1156">    */</span>
<a href="#l13.1157"></a><span id="l13.1157" class="difflineminus">-  canUserRemove: function (aNode) {</span>
<a href="#l13.1158"></a><span id="l13.1158" class="difflineplus">+  canUserRemove(aNode) {</span>
<a href="#l13.1159"></a><span id="l13.1159">     let parentNode = aNode.parent;</span>
<a href="#l13.1160"></a><span id="l13.1160" class="difflineminus">-    if (!parentNode)</span>
<a href="#l13.1161"></a><span id="l13.1161" class="difflineminus">-      throw new Error(&quot;canUserRemove doesn't accept root nodes&quot;);</span>
<a href="#l13.1162"></a><span id="l13.1162" class="difflineplus">+    if (!parentNode) {</span>
<a href="#l13.1163"></a><span id="l13.1163" class="difflineplus">+      // canUserRemove doesn't accept root nodes.</span>
<a href="#l13.1164"></a><span id="l13.1164" class="difflineplus">+      return false;</span>
<a href="#l13.1165"></a><span id="l13.1165" class="difflineplus">+    }</span>
<a href="#l13.1166"></a><span id="l13.1166"> </span>
<a href="#l13.1167"></a><span id="l13.1167">     // If it's not a bookmark, we can remove it unless it's a child of a</span>
<a href="#l13.1168"></a><span id="l13.1168">     // livemark.</span>
<a href="#l13.1169"></a><span id="l13.1169">     if (aNode.itemId == -1) {</span>
<a href="#l13.1170"></a><span id="l13.1170">       // Rather than executing a db query, checking the existence of the feedURI</span>
<a href="#l13.1171"></a><span id="l13.1171">       // annotation, detect livemark children by the fact that they are the only</span>
<a href="#l13.1172"></a><span id="l13.1172">       // direct non-bookmark children of bookmark folders.</span>
<a href="#l13.1173"></a><span id="l13.1173">       return !PlacesUtils.nodeIsFolder(parentNode);</span>
<a href="#l13.1174"></a><span id="l13.1174" class="difflineat">@@ -831,25 +823,23 @@ var PlacesUIUtils = {</span>
<a href="#l13.1175"></a><span id="l13.1175">    * Otherwise they are just treated as bookmarks (i.e. false is returned).</span>
<a href="#l13.1176"></a><span id="l13.1176">    *</span>
<a href="#l13.1177"></a><span id="l13.1177">    * @param aNodeOrItemId</span>
<a href="#l13.1178"></a><span id="l13.1178">    *        any item id or result node.</span>
<a href="#l13.1179"></a><span id="l13.1179">    * @throws if aNodeOrItemId is neither an item id nor a folder result node.</span>
<a href="#l13.1180"></a><span id="l13.1180">    * @note livemark &quot;folders&quot; are considered read-only (but see bug 1072833).</span>
<a href="#l13.1181"></a><span id="l13.1181">    * @return true if aItemId points to a read-only folder, false otherwise.</span>
<a href="#l13.1182"></a><span id="l13.1182">    */</span>
<a href="#l13.1183"></a><span id="l13.1183" class="difflineminus">-  isContentsReadOnly: function (aNodeOrItemId) {</span>
<a href="#l13.1184"></a><span id="l13.1184" class="difflineplus">+  isContentsReadOnly(aNodeOrItemId) {</span>
<a href="#l13.1185"></a><span id="l13.1185">     let itemId;</span>
<a href="#l13.1186"></a><span id="l13.1186">     if (typeof(aNodeOrItemId) == &quot;number&quot;) {</span>
<a href="#l13.1187"></a><span id="l13.1187">       itemId = aNodeOrItemId;</span>
<a href="#l13.1188"></a><span id="l13.1188" class="difflineminus">-    }</span>
<a href="#l13.1189"></a><span id="l13.1189" class="difflineminus">-    else if (PlacesUtils.nodeIsFolder(aNodeOrItemId)) {</span>
<a href="#l13.1190"></a><span id="l13.1190" class="difflineplus">+    } else if (PlacesUtils.nodeIsFolder(aNodeOrItemId)) {</span>
<a href="#l13.1191"></a><span id="l13.1191">       itemId = PlacesUtils.getConcreteItemId(aNodeOrItemId);</span>
<a href="#l13.1192"></a><span id="l13.1192" class="difflineminus">-    }</span>
<a href="#l13.1193"></a><span id="l13.1193" class="difflineminus">-    else {</span>
<a href="#l13.1194"></a><span id="l13.1194" class="difflineplus">+    } else {</span>
<a href="#l13.1195"></a><span id="l13.1195">       throw new Error(&quot;invalid value for aNodeOrItemId&quot;);</span>
<a href="#l13.1196"></a><span id="l13.1196">     }</span>
<a href="#l13.1197"></a><span id="l13.1197"> </span>
<a href="#l13.1198"></a><span id="l13.1198">     if (itemId == PlacesUtils.placesRootId || IsLivemark(itemId))</span>
<a href="#l13.1199"></a><span id="l13.1199">       return true;</span>
<a href="#l13.1200"></a><span id="l13.1200"> </span>
<a href="#l13.1201"></a><span id="l13.1201">     // leftPaneFolderId, and as a result, allBookmarksFolderId, is a lazy getter</span>
<a href="#l13.1202"></a><span id="l13.1202">     // performing at least a synchronous DB query (and on its very first call</span>
<a href="#l13.1203"></a><span id="l13.1203" class="difflineat">@@ -861,23 +851,23 @@ var PlacesUIUtils = {</span>
<a href="#l13.1204"></a><span id="l13.1204">     // toolbar for managing bookmarks).  To do so, we avoid comparing to those</span>
<a href="#l13.1205"></a><span id="l13.1205">     // special folder if the lazy getter is still in place.  This is safe merely</span>
<a href="#l13.1206"></a><span id="l13.1206">     // because the only way to access the left pane contents goes through</span>
<a href="#l13.1207"></a><span id="l13.1207">     // &quot;resolving&quot; the leftPaneFolderId getter.</span>
<a href="#l13.1208"></a><span id="l13.1208">     if (&quot;get&quot; in Object.getOwnPropertyDescriptor(this, &quot;leftPaneFolderId&quot;))</span>
<a href="#l13.1209"></a><span id="l13.1209">       return false;</span>
<a href="#l13.1210"></a><span id="l13.1210"> </span>
<a href="#l13.1211"></a><span id="l13.1211">     return itemId == this.leftPaneFolderId ||</span>
<a href="#l13.1212"></a><span id="l13.1212" class="difflineminus">-           itemId == this.allBookmarksFolderId;;</span>
<a href="#l13.1213"></a><span id="l13.1213" class="difflineplus">+           itemId == this.allBookmarksFolderId;</span>
<a href="#l13.1214"></a><span id="l13.1214">   },</span>
<a href="#l13.1215"></a><span id="l13.1215"> </span>
<a href="#l13.1216"></a><span id="l13.1216">   /**</span>
<a href="#l13.1217"></a><span id="l13.1217">    * Gives the user a chance to cancel loading lots of tabs at once</span>
<a href="#l13.1218"></a><span id="l13.1218">    */</span>
<a href="#l13.1219"></a><span id="l13.1219" class="difflineminus">-  _confirmOpenInTabs: function PUIU__confirmOpenInTabs(numTabsToOpen) {</span>
<a href="#l13.1220"></a><span id="l13.1220" class="difflineplus">+  confirmOpenInTabs(numTabsToOpen, aWindow) {</span>
<a href="#l13.1221"></a><span id="l13.1221">     const WARN_ON_OPEN_PREF = &quot;browser.tabs.warnOnOpen&quot;;</span>
<a href="#l13.1222"></a><span id="l13.1222">     var reallyOpen = true;</span>
<a href="#l13.1223"></a><span id="l13.1223"> </span>
<a href="#l13.1224"></a><span id="l13.1224">     if (Services.prefs.getBoolPref(WARN_ON_OPEN_PREF)) {</span>
<a href="#l13.1225"></a><span id="l13.1225">       if (numTabsToOpen &gt;= Services.prefs.getIntPref(&quot;browser.tabs.maxOpenBeforeWarn&quot;)) {</span>
<a href="#l13.1226"></a><span id="l13.1226">         // default to true: if it were false, we wouldn't get this far</span>
<a href="#l13.1227"></a><span id="l13.1227">         var warnOnOpen = { value: true };</span>
<a href="#l13.1228"></a><span id="l13.1228"> </span>
<a href="#l13.1229"></a><span id="l13.1229" class="difflineat">@@ -885,17 +875,17 @@ var PlacesUIUtils = {</span>
<a href="#l13.1230"></a><span id="l13.1230">         var openKey = &quot;tabs.openButtonMultiple&quot;;</span>
<a href="#l13.1231"></a><span id="l13.1231">         const BRANDING_BUNDLE_URI = &quot;chrome://branding/locale/brand.properties&quot;;</span>
<a href="#l13.1232"></a><span id="l13.1232">         var brandShortName = Cc[&quot;@mozilla.org/intl/stringbundle;1&quot;]</span>
<a href="#l13.1233"></a><span id="l13.1233">                                .getService(Ci.nsIStringBundleService)</span>
<a href="#l13.1234"></a><span id="l13.1234">                                .createBundle(BRANDING_BUNDLE_URI)</span>
<a href="#l13.1235"></a><span id="l13.1235">                                .GetStringFromName(&quot;brandShortName&quot;);</span>
<a href="#l13.1236"></a><span id="l13.1236"> </span>
<a href="#l13.1237"></a><span id="l13.1237">         var buttonPressed = Services.prompt.confirmEx(</span>
<a href="#l13.1238"></a><span id="l13.1238" class="difflineminus">-          this._getCurrentActiveWin(),</span>
<a href="#l13.1239"></a><span id="l13.1239" class="difflineplus">+          aWindow,</span>
<a href="#l13.1240"></a><span id="l13.1240">           this.getString(&quot;tabs.openWarningTitle&quot;),</span>
<a href="#l13.1241"></a><span id="l13.1241">           this.getFormattedString(messageKey, [numTabsToOpen, brandShortName]),</span>
<a href="#l13.1242"></a><span id="l13.1242">           (Services.prompt.BUTTON_TITLE_IS_STRING * Services.prompt.BUTTON_POS_0) +</span>
<a href="#l13.1243"></a><span id="l13.1243">             (Services.prompt.BUTTON_TITLE_CANCEL * Services.prompt.BUTTON_POS_1),</span>
<a href="#l13.1244"></a><span id="l13.1244">           this.getString(openKey), null, null,</span>
<a href="#l13.1245"></a><span id="l13.1245">           this.getFormattedString(&quot;tabs.openWarningPromptMeBranded&quot;,</span>
<a href="#l13.1246"></a><span id="l13.1246">                                   [brandShortName]),</span>
<a href="#l13.1247"></a><span id="l13.1247">           warnOnOpen</span>
<a href="#l13.1248"></a><span id="l13.1248" class="difflineat">@@ -909,98 +899,166 @@ var PlacesUIUtils = {</span>
<a href="#l13.1249"></a><span id="l13.1249">     }</span>
<a href="#l13.1250"></a><span id="l13.1250"> </span>
<a href="#l13.1251"></a><span id="l13.1251">     return reallyOpen;</span>
<a href="#l13.1252"></a><span id="l13.1252">   },</span>
<a href="#l13.1253"></a><span id="l13.1253"> </span>
<a href="#l13.1254"></a><span id="l13.1254">   /** aItemsToOpen needs to be an array of objects of the form:</span>
<a href="#l13.1255"></a><span id="l13.1255">     * {uri: string, isBookmark: boolean}</span>
<a href="#l13.1256"></a><span id="l13.1256">     */</span>
<a href="#l13.1257"></a><span id="l13.1257" class="difflineminus">-  _openTabset: function (aItemsToOpen, aEvent, aWhere) {</span>
<a href="#l13.1258"></a><span id="l13.1258" class="difflineplus">+  _openTabset: function PUIU__openTabset(aItemsToOpen, aEvent, aWindow) {</span>
<a href="#l13.1259"></a><span id="l13.1259">     if (!aItemsToOpen.length)</span>
<a href="#l13.1260"></a><span id="l13.1260">       return;</span>
<a href="#l13.1261"></a><span id="l13.1261"> </span>
<a href="#l13.1262"></a><span id="l13.1262" class="difflineplus">+    // Prefer the caller window if it's a browser window, otherwise use</span>
<a href="#l13.1263"></a><span id="l13.1263" class="difflineplus">+    // the top browser window.</span>
<a href="#l13.1264"></a><span id="l13.1264" class="difflineplus">+    var browserWindow = null;</span>
<a href="#l13.1265"></a><span id="l13.1265" class="difflineplus">+    browserWindow =</span>
<a href="#l13.1266"></a><span id="l13.1266" class="difflineplus">+      aWindow &amp;&amp; aWindow.document.documentElement.getAttribute(&quot;windowtype&quot;) == &quot;navigator:browser&quot; ?</span>
<a href="#l13.1267"></a><span id="l13.1267" class="difflineplus">+      aWindow : this._getTopBrowserWin();</span>
<a href="#l13.1268"></a><span id="l13.1268" class="difflineplus">+</span>
<a href="#l13.1269"></a><span id="l13.1269">     var urls = [];</span>
<a href="#l13.1270"></a><span id="l13.1270" class="difflineplus">+    let skipMarking = browserWindow &amp;&amp; PrivateBrowsingUtils.isWindowPrivate(browserWindow);</span>
<a href="#l13.1271"></a><span id="l13.1271">     for (let item of aItemsToOpen) {</span>
<a href="#l13.1272"></a><span id="l13.1272" class="difflineplus">+      urls.push(item.uri);</span>
<a href="#l13.1273"></a><span id="l13.1273" class="difflineplus">+      if (skipMarking) {</span>
<a href="#l13.1274"></a><span id="l13.1274" class="difflineplus">+        continue;</span>
<a href="#l13.1275"></a><span id="l13.1275" class="difflineplus">+      }</span>
<a href="#l13.1276"></a><span id="l13.1276" class="difflineplus">+</span>
<a href="#l13.1277"></a><span id="l13.1277">       if (item.isBookmark)</span>
<a href="#l13.1278"></a><span id="l13.1278">         this.markPageAsFollowedBookmark(item.uri);</span>
<a href="#l13.1279"></a><span id="l13.1279">       else</span>
<a href="#l13.1280"></a><span id="l13.1280">         this.markPageAsTyped(item.uri);</span>
<a href="#l13.1281"></a><span id="l13.1281" class="difflineplus">+    }</span>
<a href="#l13.1282"></a><span id="l13.1282"> </span>
<a href="#l13.1283"></a><span id="l13.1283" class="difflineminus">-      urls.push(item.uri);</span>
<a href="#l13.1284"></a><span id="l13.1284" class="difflineplus">+    // whereToOpenLink doesn't return &quot;window&quot; when there's no browser window</span>
<a href="#l13.1285"></a><span id="l13.1285" class="difflineplus">+    // open (Bug 630255).</span>
<a href="#l13.1286"></a><span id="l13.1286" class="difflineplus">+    var where = browserWindow ?</span>
<a href="#l13.1287"></a><span id="l13.1287" class="difflineplus">+                browserWindow.whereToOpenLink(aEvent, false, true) : &quot;window&quot;;</span>
<a href="#l13.1288"></a><span id="l13.1288" class="difflineplus">+    if (where == &quot;window&quot;) {</span>
<a href="#l13.1289"></a><span id="l13.1289" class="difflineplus">+      // There is no browser window open, thus open a new one.</span>
<a href="#l13.1290"></a><span id="l13.1290" class="difflineplus">+      var uriList = PlacesUtils.toISupportsString(urls.join(&quot;|&quot;));</span>
<a href="#l13.1291"></a><span id="l13.1291" class="difflineplus">+      var args = Cc[&quot;@mozilla.org/array;1&quot;]</span>
<a href="#l13.1292"></a><span id="l13.1292" class="difflineplus">+                   .createInstance(Ci.nsIMutableArray);</span>
<a href="#l13.1293"></a><span id="l13.1293" class="difflineplus">+      args.appendElement(uriList);</span>
<a href="#l13.1294"></a><span id="l13.1294" class="difflineplus">+      browserWindow = Services.ww.openWindow(aWindow,</span>
<a href="#l13.1295"></a><span id="l13.1295" class="difflineplus">+                                             &quot;chrome://navigator/content/navigator.xul&quot;,</span>
<a href="#l13.1296"></a><span id="l13.1296" class="difflineplus">+                                             null, &quot;chrome,dialog=no,all&quot;, args);</span>
<a href="#l13.1297"></a><span id="l13.1297" class="difflineplus">+      return;</span>
<a href="#l13.1298"></a><span id="l13.1298">     }</span>
<a href="#l13.1299"></a><span id="l13.1299"> </span>
<a href="#l13.1300"></a><span id="l13.1300" class="difflineminus">-    var browserWindow = this._getTopBrowserWin();</span>
<a href="#l13.1301"></a><span id="l13.1301" class="difflineminus">-    if (browserWindow) {</span>
<a href="#l13.1302"></a><span id="l13.1302" class="difflineminus">-      let where = aWhere || browserWindow.whereToOpenLink(aEvent, false, true);</span>
<a href="#l13.1303"></a><span id="l13.1303" class="difflineminus">-      browserWindow.openUILinkArrayIn(urls, where);</span>
<a href="#l13.1304"></a><span id="l13.1304" class="difflineminus">-    }</span>
<a href="#l13.1305"></a><span id="l13.1305" class="difflineminus">-    else {</span>
<a href="#l13.1306"></a><span id="l13.1306" class="difflineminus">-      let win = this._getCurrentActiveWin();</span>
<a href="#l13.1307"></a><span id="l13.1307" class="difflineminus">-      win.openDialog(win.getBrowserURL(), &quot;_blank&quot;,</span>
<a href="#l13.1308"></a><span id="l13.1308" class="difflineminus">-                     &quot;chrome,all,dialog=no&quot;, urls.join(&quot;\n&quot;));</span>
<a href="#l13.1309"></a><span id="l13.1309" class="difflineplus">+    var loadInBackground = where == &quot;tabshifted&quot;;</span>
<a href="#l13.1310"></a><span id="l13.1310" class="difflineplus">+    // For consistency, we want all the bookmarks to open in new tabs, instead</span>
<a href="#l13.1311"></a><span id="l13.1311" class="difflineplus">+    // of having one of them replace the currently focused tab.  Hence we call</span>
<a href="#l13.1312"></a><span id="l13.1312" class="difflineplus">+    // loadTabs with aReplace set to false.</span>
<a href="#l13.1313"></a><span id="l13.1313" class="difflineplus">+    browserWindow.gBrowser.loadTabs(urls, {</span>
<a href="#l13.1314"></a><span id="l13.1314" class="difflineplus">+      inBackground: loadInBackground,</span>
<a href="#l13.1315"></a><span id="l13.1315" class="difflineplus">+      replace: false,</span>
<a href="#l13.1316"></a><span id="l13.1316" class="difflineplus">+      triggeringPrincipal: Services.scriptSecurityManager.getSystemPrincipal(),</span>
<a href="#l13.1317"></a><span id="l13.1317" class="difflineplus">+    });</span>
<a href="#l13.1318"></a><span id="l13.1318" class="difflineplus">+  },</span>
<a href="#l13.1319"></a><span id="l13.1319" class="difflineplus">+</span>
<a href="#l13.1320"></a><span id="l13.1320" class="difflineplus">+  openLiveMarkNodesInTabs:</span>
<a href="#l13.1321"></a><span id="l13.1321" class="difflineplus">+  function PUIU_openLiveMarkNodesInTabs(aNode, aEvent, aView) {</span>
<a href="#l13.1322"></a><span id="l13.1322" class="difflineplus">+    let window = aView.ownerWindow;</span>
<a href="#l13.1323"></a><span id="l13.1323" class="difflineplus">+</span>
<a href="#l13.1324"></a><span id="l13.1324" class="difflineplus">+    PlacesUtils.livemarks.getLivemark({id: aNode.itemId})</span>
<a href="#l13.1325"></a><span id="l13.1325" class="difflineplus">+      .then(aLivemark =&gt; {</span>
<a href="#l13.1326"></a><span id="l13.1326" class="difflineplus">+        let urlsToOpen = [];</span>
<a href="#l13.1327"></a><span id="l13.1327" class="difflineplus">+</span>
<a href="#l13.1328"></a><span id="l13.1328" class="difflineplus">+        let nodes = aLivemark.getNodesForContainer(aNode);</span>
<a href="#l13.1329"></a><span id="l13.1329" class="difflineplus">+        for (let node of nodes) {</span>
<a href="#l13.1330"></a><span id="l13.1330" class="difflineplus">+          urlsToOpen.push({uri: node.uri, isBookmark: false});</span>
<a href="#l13.1331"></a><span id="l13.1331" class="difflineplus">+        }</span>
<a href="#l13.1332"></a><span id="l13.1332" class="difflineplus">+</span>
<a href="#l13.1333"></a><span id="l13.1333" class="difflineplus">+        if (this.confirmOpenInTabs(urlsToOpen.length, window)) {</span>
<a href="#l13.1334"></a><span id="l13.1334" class="difflineplus">+          this._openTabset(urlsToOpen, aEvent, window);</span>
<a href="#l13.1335"></a><span id="l13.1335" class="difflineplus">+        }</span>
<a href="#l13.1336"></a><span id="l13.1336" class="difflineplus">+      }, Cu.reportError);</span>
<a href="#l13.1337"></a><span id="l13.1337" class="difflineplus">+  },</span>
<a href="#l13.1338"></a><span id="l13.1338" class="difflineplus">+</span>
<a href="#l13.1339"></a><span id="l13.1339" class="difflineplus">+  openContainerNodeInTabs:</span>
<a href="#l13.1340"></a><span id="l13.1340" class="difflineplus">+  function PUIU_openContainerInTabs(aNode, aEvent, aView) {</span>
<a href="#l13.1341"></a><span id="l13.1341" class="difflineplus">+    let window = aView.ownerWindow;</span>
<a href="#l13.1342"></a><span id="l13.1342" class="difflineplus">+</span>
<a href="#l13.1343"></a><span id="l13.1343" class="difflineplus">+    let urlsToOpen = PlacesUtils.getURLsForContainerNode(aNode);</span>
<a href="#l13.1344"></a><span id="l13.1344" class="difflineplus">+    if (this.confirmOpenInTabs(urlsToOpen.length, window)) {</span>
<a href="#l13.1345"></a><span id="l13.1345" class="difflineplus">+      this._openTabset(urlsToOpen, aEvent, window);</span>
<a href="#l13.1346"></a><span id="l13.1346">     }</span>
<a href="#l13.1347"></a><span id="l13.1347">   },</span>
<a href="#l13.1348"></a><span id="l13.1348"> </span>
<a href="#l13.1349"></a><span id="l13.1349" class="difflineminus">-  openContainerNodeInTabs: function PUIU_openContainerInTabs(aNode, aEvent, aWhere) {</span>
<a href="#l13.1350"></a><span id="l13.1350" class="difflineminus">-    var urlsToOpen = PlacesUtils.getURLsForContainerNode(aNode);</span>
<a href="#l13.1351"></a><span id="l13.1351" class="difflineminus">-    if (!this._confirmOpenInTabs(urlsToOpen.length))</span>
<a href="#l13.1352"></a><span id="l13.1352" class="difflineminus">-      return;</span>
<a href="#l13.1353"></a><span id="l13.1353" class="difflineminus">-</span>
<a href="#l13.1354"></a><span id="l13.1354" class="difflineminus">-    this._openTabset(urlsToOpen, aEvent, aWhere);</span>
<a href="#l13.1355"></a><span id="l13.1355" class="difflineminus">-  },</span>
<a href="#l13.1356"></a><span id="l13.1356" class="difflineplus">+  openURINodesInTabs: function PUIU_openURINodesInTabs(aNodes, aEvent, aView) {</span>
<a href="#l13.1357"></a><span id="l13.1357" class="difflineplus">+    let window = aView.ownerWindow;</span>
<a href="#l13.1358"></a><span id="l13.1358"> </span>
<a href="#l13.1359"></a><span id="l13.1359" class="difflineminus">-  openURINodesInTabs: function PUIU_openURINodesInTabs(aNodes, aEvent) {</span>
<a href="#l13.1360"></a><span id="l13.1360" class="difflineminus">-    this.openSelectionIn(aNodes, null, aEvent);</span>
<a href="#l13.1361"></a><span id="l13.1361" class="difflineminus">-  },</span>
<a href="#l13.1362"></a><span id="l13.1362" class="difflineminus">-</span>
<a href="#l13.1363"></a><span id="l13.1363" class="difflineminus">-  openSelectionIn: function (aNodes, aWhere, aEvent) {</span>
<a href="#l13.1364"></a><span id="l13.1364" class="difflineminus">-    var urlsToOpen = [];</span>
<a href="#l13.1365"></a><span id="l13.1365" class="difflineminus">-    for (let node of aNodes) {</span>
<a href="#l13.1366"></a><span id="l13.1366" class="difflineminus">-      // skip over separators and folders</span>
<a href="#l13.1367"></a><span id="l13.1367" class="difflineminus">-      if (PlacesUtils.nodeIsURI(node))</span>
<a href="#l13.1368"></a><span id="l13.1368" class="difflineminus">-        urlsToOpen.push({uri: node.uri, isBookmark: PlacesUtils.nodeIsBookmark(node)});</span>
<a href="#l13.1369"></a><span id="l13.1369" class="difflineplus">+    let urlsToOpen = [];</span>
<a href="#l13.1370"></a><span id="l13.1370" class="difflineplus">+    for (var i = 0; i &lt; aNodes.length; i++) {</span>
<a href="#l13.1371"></a><span id="l13.1371" class="difflineplus">+      // Skip over separators and folders.</span>
<a href="#l13.1372"></a><span id="l13.1372" class="difflineplus">+      if (PlacesUtils.nodeIsURI(aNodes[i]))</span>
<a href="#l13.1373"></a><span id="l13.1373" class="difflineplus">+        urlsToOpen.push({uri: aNodes[i].uri, isBookmark: PlacesUtils.nodeIsBookmark(aNodes[i])});</span>
<a href="#l13.1374"></a><span id="l13.1374">     }</span>
<a href="#l13.1375"></a><span id="l13.1375" class="difflineminus">-    this._openTabset(urlsToOpen, aEvent, aWhere);</span>
<a href="#l13.1376"></a><span id="l13.1376" class="difflineplus">+    this._openTabset(urlsToOpen, aEvent, window);</span>
<a href="#l13.1377"></a><span id="l13.1377">   },</span>
<a href="#l13.1378"></a><span id="l13.1378"> </span>
<a href="#l13.1379"></a><span id="l13.1379">   /**</span>
<a href="#l13.1380"></a><span id="l13.1380">    * Loads the node's URL in the appropriate tab or window or as a web</span>
<a href="#l13.1381"></a><span id="l13.1381">    * panel given the user's preference specified by modifier keys tracked by a</span>
<a href="#l13.1382"></a><span id="l13.1382">    * DOM mouse/key event.</span>
<a href="#l13.1383"></a><span id="l13.1383">    * @param   aNode</span>
<a href="#l13.1384"></a><span id="l13.1384">    *          An uri result node.</span>
<a href="#l13.1385"></a><span id="l13.1385">    * @param   aEvent</span>
<a href="#l13.1386"></a><span id="l13.1386">    *          The DOM mouse/key event with modifier keys set that track the</span>
<a href="#l13.1387"></a><span id="l13.1387">    *          user's preferred destination window or tab.</span>
<a href="#l13.1388"></a><span id="l13.1388">    */</span>
<a href="#l13.1389"></a><span id="l13.1389" class="difflineminus">-  openNodeWithEvent: function PUIU_openNodeWithEvent(aNode, aEvent) {</span>
<a href="#l13.1390"></a><span id="l13.1390" class="difflineminus">-    this.openNodeIn(aNode, this._getCurrentActiveWin().whereToOpenLink(aEvent, false, true));</span>
<a href="#l13.1391"></a><span id="l13.1391" class="difflineplus">+  openNodeWithEvent:</span>
<a href="#l13.1392"></a><span id="l13.1392" class="difflineplus">+  function PUIU_openNodeWithEvent(aNode, aEvent) {</span>
<a href="#l13.1393"></a><span id="l13.1393" class="difflineplus">+    let window = aEvent.target.ownerGlobal;</span>
<a href="#l13.1394"></a><span id="l13.1394" class="difflineplus">+    this._openNodeIn(aNode, window.whereToOpenLink(aEvent, false, true), window);</span>
<a href="#l13.1395"></a><span id="l13.1395">   },</span>
<a href="#l13.1396"></a><span id="l13.1396"> </span>
<a href="#l13.1397"></a><span id="l13.1397">   /**</span>
<a href="#l13.1398"></a><span id="l13.1398">    * Loads the node's URL in the appropriate tab or window or as a</span>
<a href="#l13.1399"></a><span id="l13.1399">    * web panel.</span>
<a href="#l13.1400"></a><span id="l13.1400">    * see also openUILinkIn</span>
<a href="#l13.1401"></a><span id="l13.1401">    */</span>
<a href="#l13.1402"></a><span id="l13.1402" class="difflineminus">-  openNodeIn: function PUIU_openNodeIn(aNode, aWhere) {</span>
<a href="#l13.1403"></a><span id="l13.1403" class="difflineminus">-    if (!aNode || !aWhere)</span>
<a href="#l13.1404"></a><span id="l13.1404" class="difflineminus">-      return;</span>
<a href="#l13.1405"></a><span id="l13.1405" class="difflineminus">-    var win = this._getCurrentActiveWin();</span>
<a href="#l13.1406"></a><span id="l13.1406" class="difflineminus">-    if (PlacesUtils.nodeIsContainer(aNode) &amp;&amp; aWhere != &quot;current&quot;) {</span>
<a href="#l13.1407"></a><span id="l13.1407" class="difflineminus">-      this.openContainerNodeInTabs(aNode, null, aWhere);</span>
<a href="#l13.1408"></a><span id="l13.1408" class="difflineminus">-    } else if (PlacesUtils.nodeIsURI(aNode) &amp;&amp; this.checkURLSecurity(aNode, win)) {</span>
<a href="#l13.1409"></a><span id="l13.1409" class="difflineminus">-      var isBookmark = PlacesUtils.nodeIsBookmark(aNode);</span>
<a href="#l13.1410"></a><span id="l13.1410" class="difflineplus">+  openNodeIn: function PUIU_openNodeIn(aNode, aWhere, aView, aPrivate) {</span>
<a href="#l13.1411"></a><span id="l13.1411" class="difflineplus">+    let window = aView.ownerWindow;</span>
<a href="#l13.1412"></a><span id="l13.1412" class="difflineplus">+    this._openNodeIn(aNode, aWhere, window, aPrivate);</span>
<a href="#l13.1413"></a><span id="l13.1413" class="difflineplus">+  },</span>
<a href="#l13.1414"></a><span id="l13.1414" class="difflineplus">+</span>
<a href="#l13.1415"></a><span id="l13.1415" class="difflineplus">+  _openNodeIn: function PUIU_openNodeIn(aNode, aWhere, aWindow, aPrivate = false) {</span>
<a href="#l13.1416"></a><span id="l13.1416" class="difflineplus">+    if (aNode &amp;&amp; PlacesUtils.nodeIsURI(aNode) &amp;&amp;</span>
<a href="#l13.1417"></a><span id="l13.1417" class="difflineplus">+        this.checkURLSecurity(aNode, aWindow)) {</span>
<a href="#l13.1418"></a><span id="l13.1418" class="difflineplus">+      let isBookmark = PlacesUtils.nodeIsBookmark(aNode);</span>
<a href="#l13.1419"></a><span id="l13.1419" class="difflineplus">+</span>
<a href="#l13.1420"></a><span id="l13.1420" class="difflineplus">+      if (!PrivateBrowsingUtils.isWindowPrivate(aWindow)) {</span>
<a href="#l13.1421"></a><span id="l13.1421" class="difflineplus">+        if (isBookmark)</span>
<a href="#l13.1422"></a><span id="l13.1422" class="difflineplus">+          this.markPageAsFollowedBookmark(aNode.uri);</span>
<a href="#l13.1423"></a><span id="l13.1423" class="difflineplus">+        else</span>
<a href="#l13.1424"></a><span id="l13.1424" class="difflineplus">+          this.markPageAsTyped(aNode.uri);</span>
<a href="#l13.1425"></a><span id="l13.1425" class="difflineplus">+      }</span>
<a href="#l13.1426"></a><span id="l13.1426"> </span>
<a href="#l13.1427"></a><span id="l13.1427" class="difflineminus">-      if (isBookmark)</span>
<a href="#l13.1428"></a><span id="l13.1428" class="difflineminus">-        this.markPageAsFollowedBookmark(aNode.uri);</span>
<a href="#l13.1429"></a><span id="l13.1429" class="difflineminus">-      else</span>
<a href="#l13.1430"></a><span id="l13.1430" class="difflineminus">-        this.markPageAsTyped(aNode.uri);</span>
<a href="#l13.1431"></a><span id="l13.1431" class="difflineplus">+      // Check whether the node is a bookmark which should be opened as</span>
<a href="#l13.1432"></a><span id="l13.1432" class="difflineplus">+      // a web panel</span>
<a href="#l13.1433"></a><span id="l13.1433" class="difflineplus">+      // Currently not supported in SeaMonkey. Please stay tuned.</span>
<a href="#l13.1434"></a><span id="l13.1434" class="difflineplus">+      if (aWhere == &quot;current-NOT_YET_SUPPORTED&quot; &amp;&amp; isBookmark) {</span>
<a href="#l13.1435"></a><span id="l13.1435" class="difflineplus">+        if (PlacesUtils.annotations</span>
<a href="#l13.1436"></a><span id="l13.1436" class="difflineplus">+                       .itemHasAnnotation(aNode.itemId, this.LOAD_IN_SIDEBAR_ANNO)) {</span>
<a href="#l13.1437"></a><span id="l13.1437" class="difflineplus">+          let browserWin = this._getTopBrowserWin();</span>
<a href="#l13.1438"></a><span id="l13.1438" class="difflineplus">+          if (browserWin) {</span>
<a href="#l13.1439"></a><span id="l13.1439" class="difflineplus">+            browserWin.openWebPanel(aNode.title, aNode.uri);</span>
<a href="#l13.1440"></a><span id="l13.1440" class="difflineplus">+            return;</span>
<a href="#l13.1441"></a><span id="l13.1441" class="difflineplus">+          }</span>
<a href="#l13.1442"></a><span id="l13.1442" class="difflineplus">+        }</span>
<a href="#l13.1443"></a><span id="l13.1443" class="difflineplus">+      }</span>
<a href="#l13.1444"></a><span id="l13.1444"> </span>
<a href="#l13.1445"></a><span id="l13.1445" class="difflineminus">-      win.openUILinkIn(aNode.uri, aWhere);</span>
<a href="#l13.1446"></a><span id="l13.1446" class="difflineplus">+      aWindow.openUILinkIn(aNode.uri, aWhere, {</span>
<a href="#l13.1447"></a><span id="l13.1447" class="difflineplus">+        allowPopups: aNode.uri.startsWith(&quot;javascript:&quot;),</span>
<a href="#l13.1448"></a><span id="l13.1448" class="difflineplus">+        inBackground: Services.prefs.getBoolPref(&quot;browser.tabs.loadBookmarksInBackground&quot;),</span>
<a href="#l13.1449"></a><span id="l13.1449" class="difflineplus">+        private: aPrivate,</span>
<a href="#l13.1450"></a><span id="l13.1450" class="difflineplus">+      });</span>
<a href="#l13.1451"></a><span id="l13.1451">     }</span>
<a href="#l13.1452"></a><span id="l13.1452">   },</span>
<a href="#l13.1453"></a><span id="l13.1453"> </span>
<a href="#l13.1454"></a><span id="l13.1454">   /**</span>
<a href="#l13.1455"></a><span id="l13.1455">    * Helper for guessing scheme from an url string.</span>
<a href="#l13.1456"></a><span id="l13.1456">    * Used to avoid nsIURI overhead in frequently called UI functions.</span>
<a href="#l13.1457"></a><span id="l13.1457">    *</span>
<a href="#l13.1458"></a><span id="l13.1458">    * @param aUrlString the url to guess the scheme from.</span>
<a href="#l13.1459"></a><span id="l13.1459" class="difflineat">@@ -1008,72 +1066,79 @@ var PlacesUIUtils = {</span>
<a href="#l13.1460"></a><span id="l13.1460">    * @return guessed scheme for this url string.</span>
<a href="#l13.1461"></a><span id="l13.1461">    *</span>
<a href="#l13.1462"></a><span id="l13.1462">    * @note this is not supposed be perfect, so use it only for UI purposes.</span>
<a href="#l13.1463"></a><span id="l13.1463">    */</span>
<a href="#l13.1464"></a><span id="l13.1464">   guessUrlSchemeForUI: function PUIU_guessUrlSchemeForUI(aUrlString) {</span>
<a href="#l13.1465"></a><span id="l13.1465">     return aUrlString.substr(0, aUrlString.indexOf(&quot;:&quot;));</span>
<a href="#l13.1466"></a><span id="l13.1466">   },</span>
<a href="#l13.1467"></a><span id="l13.1467"> </span>
<a href="#l13.1468"></a><span id="l13.1468" class="difflineminus">-  getBestTitle: function PUIU_getBestTitle(aNode) {</span>
<a href="#l13.1469"></a><span id="l13.1469" class="difflineplus">+  getBestTitle: function PUIU_getBestTitle(aNode, aDoNotCutTitle) {</span>
<a href="#l13.1470"></a><span id="l13.1470">     var title;</span>
<a href="#l13.1471"></a><span id="l13.1471">     if (!aNode.title &amp;&amp; PlacesUtils.nodeIsURI(aNode)) {</span>
<a href="#l13.1472"></a><span id="l13.1472">       // if node title is empty, try to set the label using host and filename</span>
<a href="#l13.1473"></a><span id="l13.1473">       // PlacesUtils._uri() will throw if aNode.uri is not a valid URI</span>
<a href="#l13.1474"></a><span id="l13.1474">       try {</span>
<a href="#l13.1475"></a><span id="l13.1475">         var uri = PlacesUtils._uri(aNode.uri);</span>
<a href="#l13.1476"></a><span id="l13.1476">         var host = uri.host;</span>
<a href="#l13.1477"></a><span id="l13.1477">         var fileName = uri.QueryInterface(Ci.nsIURL).fileName;</span>
<a href="#l13.1478"></a><span id="l13.1478">         // if fileName is empty, use path to distinguish labels</span>
<a href="#l13.1479"></a><span id="l13.1479" class="difflineminus">-        title = host + (fileName ?</span>
<a href="#l13.1480"></a><span id="l13.1480" class="difflineminus">-                        (host ? &quot;/&quot; + this.ellipsis + &quot;/&quot; : &quot;&quot;) + fileName :</span>
<a href="#l13.1481"></a><span id="l13.1481" class="difflineminus">-                        uri.pathQueryRef);</span>
<a href="#l13.1482"></a><span id="l13.1482" class="difflineminus">-      }</span>
<a href="#l13.1483"></a><span id="l13.1483" class="difflineminus">-      catch (e) {</span>
<a href="#l13.1484"></a><span id="l13.1484" class="difflineplus">+        if (aDoNotCutTitle) {</span>
<a href="#l13.1485"></a><span id="l13.1485" class="difflineplus">+          title = host + uri.pathQueryRef;</span>
<a href="#l13.1486"></a><span id="l13.1486" class="difflineplus">+        } else {</span>
<a href="#l13.1487"></a><span id="l13.1487" class="difflineplus">+          title = host + (fileName ?</span>
<a href="#l13.1488"></a><span id="l13.1488" class="difflineplus">+                           (host ? &quot;/&quot; + this.ellipsis + &quot;/&quot; : &quot;&quot;) + fileName :</span>
<a href="#l13.1489"></a><span id="l13.1489" class="difflineplus">+                           uri.pathQueryRef);</span>
<a href="#l13.1490"></a><span id="l13.1490" class="difflineplus">+        }</span>
<a href="#l13.1491"></a><span id="l13.1491" class="difflineplus">+      } catch (e) {</span>
<a href="#l13.1492"></a><span id="l13.1492">         // Use (no title) for non-standard URIs (data:, javascript:, ...)</span>
<a href="#l13.1493"></a><span id="l13.1493">         title = &quot;&quot;;</span>
<a href="#l13.1494"></a><span id="l13.1494">       }</span>
<a href="#l13.1495"></a><span id="l13.1495" class="difflineminus">-    }</span>
<a href="#l13.1496"></a><span id="l13.1496" class="difflineminus">-    else</span>
<a href="#l13.1497"></a><span id="l13.1497" class="difflineplus">+    } else</span>
<a href="#l13.1498"></a><span id="l13.1498">       title = aNode.title;</span>
<a href="#l13.1499"></a><span id="l13.1499"> </span>
<a href="#l13.1500"></a><span id="l13.1500">     return title || this.getString(&quot;noTitle&quot;);</span>
<a href="#l13.1501"></a><span id="l13.1501">   },</span>
<a href="#l13.1502"></a><span id="l13.1502"> </span>
<a href="#l13.1503"></a><span id="l13.1503">   get leftPaneQueries() {</span>
<a href="#l13.1504"></a><span id="l13.1504">     // build the map</span>
<a href="#l13.1505"></a><span id="l13.1505">     this.leftPaneFolderId;</span>
<a href="#l13.1506"></a><span id="l13.1506">     return this.leftPaneQueries;</span>
<a href="#l13.1507"></a><span id="l13.1507">   },</span>
<a href="#l13.1508"></a><span id="l13.1508"> </span>
<a href="#l13.1509"></a><span id="l13.1509" class="difflineplus">+  get leftPaneFolderId() {</span>
<a href="#l13.1510"></a><span id="l13.1510" class="difflineplus">+    delete this.leftPaneFolderId;</span>
<a href="#l13.1511"></a><span id="l13.1511" class="difflineplus">+    return this.leftPaneFolderId = this.maybeRebuildLeftPane();</span>
<a href="#l13.1512"></a><span id="l13.1512" class="difflineplus">+  },</span>
<a href="#l13.1513"></a><span id="l13.1513" class="difflineplus">+</span>
<a href="#l13.1514"></a><span id="l13.1514">   // Get the folder id for the organizer left-pane folder.</span>
<a href="#l13.1515"></a><span id="l13.1515" class="difflineminus">-  get leftPaneFolderId() {</span>
<a href="#l13.1516"></a><span id="l13.1516" class="difflineplus">+  maybeRebuildLeftPane() {</span>
<a href="#l13.1517"></a><span id="l13.1517">     let leftPaneRoot = -1;</span>
<a href="#l13.1518"></a><span id="l13.1518">     let allBookmarksId;</span>
<a href="#l13.1519"></a><span id="l13.1519"> </span>
<a href="#l13.1520"></a><span id="l13.1520">     // Shortcuts to services.</span>
<a href="#l13.1521"></a><span id="l13.1521">     let bs = PlacesUtils.bookmarks;</span>
<a href="#l13.1522"></a><span id="l13.1522">     let as = PlacesUtils.annotations;</span>
<a href="#l13.1523"></a><span id="l13.1523"> </span>
<a href="#l13.1524"></a><span id="l13.1524">     // This is the list of the left pane queries.</span>
<a href="#l13.1525"></a><span id="l13.1525">     let queries = {</span>
<a href="#l13.1526"></a><span id="l13.1526">       &quot;PlacesRoot&quot;: { title: &quot;&quot; },</span>
<a href="#l13.1527"></a><span id="l13.1527">       &quot;History&quot;: { title: this.getString(&quot;OrganizerQueryHistory&quot;) },</span>
<a href="#l13.1528"></a><span id="l13.1528">       &quot;Tags&quot;: { title: this.getString(&quot;OrganizerQueryTags&quot;) },</span>
<a href="#l13.1529"></a><span id="l13.1529">       &quot;AllBookmarks&quot;: { title: this.getString(&quot;OrganizerQueryAllBookmarks&quot;) },</span>
<a href="#l13.1530"></a><span id="l13.1530">       &quot;BookmarksToolbar&quot;:</span>
<a href="#l13.1531"></a><span id="l13.1531" class="difflineminus">-        { title: null,</span>
<a href="#l13.1532"></a><span id="l13.1532" class="difflineplus">+        { title: &quot;&quot;,</span>
<a href="#l13.1533"></a><span id="l13.1533">           concreteTitle: PlacesUtils.getString(&quot;BookmarksToolbarFolderTitle&quot;),</span>
<a href="#l13.1534"></a><span id="l13.1534">           concreteId: PlacesUtils.toolbarFolderId },</span>
<a href="#l13.1535"></a><span id="l13.1535">       &quot;BookmarksMenu&quot;:</span>
<a href="#l13.1536"></a><span id="l13.1536" class="difflineminus">-        { title: null,</span>
<a href="#l13.1537"></a><span id="l13.1537" class="difflineplus">+        { title: &quot;&quot;,</span>
<a href="#l13.1538"></a><span id="l13.1538">           concreteTitle: PlacesUtils.getString(&quot;BookmarksMenuFolderTitle&quot;),</span>
<a href="#l13.1539"></a><span id="l13.1539">           concreteId: PlacesUtils.bookmarksMenuFolderId },</span>
<a href="#l13.1540"></a><span id="l13.1540">       &quot;UnfiledBookmarks&quot;:</span>
<a href="#l13.1541"></a><span id="l13.1541" class="difflineminus">-        { title: null,</span>
<a href="#l13.1542"></a><span id="l13.1542" class="difflineplus">+        { title: &quot;&quot;,</span>
<a href="#l13.1543"></a><span id="l13.1543">           concreteTitle: PlacesUtils.getString(&quot;OtherBookmarksFolderTitle&quot;),</span>
<a href="#l13.1544"></a><span id="l13.1544">           concreteId: PlacesUtils.unfiledBookmarksFolderId },</span>
<a href="#l13.1545"></a><span id="l13.1545">     };</span>
<a href="#l13.1546"></a><span id="l13.1546">     // All queries but PlacesRoot.</span>
<a href="#l13.1547"></a><span id="l13.1547">     const EXPECTED_QUERY_COUNT = 6;</span>
<a href="#l13.1548"></a><span id="l13.1548"> </span>
<a href="#l13.1549"></a><span id="l13.1549">     // Removes an item and associated annotations, ignoring eventual errors.</span>
<a href="#l13.1550"></a><span id="l13.1550">     function safeRemoveItem(aItemId) {</span>
<a href="#l13.1551"></a><span id="l13.1551" class="difflineat">@@ -1085,39 +1150,36 @@ var PlacesUIUtils = {</span>
<a href="#l13.1552"></a><span id="l13.1552">           return;</span>
<a href="#l13.1553"></a><span id="l13.1553">         }</span>
<a href="#l13.1554"></a><span id="l13.1554">         // removeItemAnnotation does not check if item exists, nor the anno,</span>
<a href="#l13.1555"></a><span id="l13.1555">         // so this is safe to do.</span>
<a href="#l13.1556"></a><span id="l13.1556">         as.removeItemAnnotation(aItemId, PlacesUIUtils.ORGANIZER_FOLDER_ANNO);</span>
<a href="#l13.1557"></a><span id="l13.1557">         as.removeItemAnnotation(aItemId, PlacesUIUtils.ORGANIZER_QUERY_ANNO);</span>
<a href="#l13.1558"></a><span id="l13.1558">         // This will throw if the annotation is an orphan.</span>
<a href="#l13.1559"></a><span id="l13.1559">         bs.removeItem(aItemId);</span>
<a href="#l13.1560"></a><span id="l13.1560" class="difflineminus">-      }</span>
<a href="#l13.1561"></a><span id="l13.1561" class="difflineminus">-      catch(e) { /* orphan anno */ }</span>
<a href="#l13.1562"></a><span id="l13.1562" class="difflineplus">+      } catch (e) { /* orphan anno */ }</span>
<a href="#l13.1563"></a><span id="l13.1563">     }</span>
<a href="#l13.1564"></a><span id="l13.1564"> </span>
<a href="#l13.1565"></a><span id="l13.1565">     // Returns true if item really exists, false otherwise.</span>
<a href="#l13.1566"></a><span id="l13.1566">     function itemExists(aItemId) {</span>
<a href="#l13.1567"></a><span id="l13.1567">       try {</span>
<a href="#l13.1568"></a><span id="l13.1568" class="difflineminus">-        bs.getItemIndex(aItemId);</span>
<a href="#l13.1569"></a><span id="l13.1569" class="difflineminus">-        return true;</span>
<a href="#l13.1570"></a><span id="l13.1570" class="difflineminus">-      }</span>
<a href="#l13.1571"></a><span id="l13.1571" class="difflineminus">-      catch(e) {</span>
<a href="#l13.1572"></a><span id="l13.1572" class="difflineplus">+        let index = bs.getItemIndex(aItemId);</span>
<a href="#l13.1573"></a><span id="l13.1573" class="difflineplus">+        return index &gt; -1;</span>
<a href="#l13.1574"></a><span id="l13.1574" class="difflineplus">+      } catch (e) {</span>
<a href="#l13.1575"></a><span id="l13.1575">         return false;</span>
<a href="#l13.1576"></a><span id="l13.1576">       }</span>
<a href="#l13.1577"></a><span id="l13.1577">     }</span>
<a href="#l13.1578"></a><span id="l13.1578"> </span>
<a href="#l13.1579"></a><span id="l13.1579">     // Get all items marked as being the left pane folder.</span>
<a href="#l13.1580"></a><span id="l13.1580">     let items = as.getItemsWithAnnotation(this.ORGANIZER_FOLDER_ANNO);</span>
<a href="#l13.1581"></a><span id="l13.1581">     if (items.length &gt; 1) {</span>
<a href="#l13.1582"></a><span id="l13.1582">       // Something went wrong, we cannot have more than one left pane folder,</span>
<a href="#l13.1583"></a><span id="l13.1583">       // remove all left pane folders and continue.  We will create a new one.</span>
<a href="#l13.1584"></a><span id="l13.1584">       items.forEach(safeRemoveItem);</span>
<a href="#l13.1585"></a><span id="l13.1585" class="difflineminus">-    }</span>
<a href="#l13.1586"></a><span id="l13.1586" class="difflineminus">-    else if (items.length == 1 &amp;&amp; items[0] != -1) {</span>
<a href="#l13.1587"></a><span id="l13.1587" class="difflineplus">+    } else if (items.length == 1 &amp;&amp; items[0] != -1) {</span>
<a href="#l13.1588"></a><span id="l13.1588">       leftPaneRoot = items[0];</span>
<a href="#l13.1589"></a><span id="l13.1589">       // Check that organizer left pane root is valid.</span>
<a href="#l13.1590"></a><span id="l13.1590">       let version = as.getItemAnnotation(leftPaneRoot, this.ORGANIZER_FOLDER_ANNO);</span>
<a href="#l13.1591"></a><span id="l13.1591">       if (version != this.ORGANIZER_LEFTPANE_VERSION ||</span>
<a href="#l13.1592"></a><span id="l13.1592">           !itemExists(leftPaneRoot)) {</span>
<a href="#l13.1593"></a><span id="l13.1593">         // Invalid root, we must rebuild the left pane.</span>
<a href="#l13.1594"></a><span id="l13.1594">         safeRemoveItem(leftPaneRoot);</span>
<a href="#l13.1595"></a><span id="l13.1595">         leftPaneRoot = -1;</span>
<a href="#l13.1596"></a><span id="l13.1596" class="difflineat">@@ -1126,40 +1188,43 @@ var PlacesUIUtils = {</span>
<a href="#l13.1597"></a><span id="l13.1597"> </span>
<a href="#l13.1598"></a><span id="l13.1598">     if (leftPaneRoot != -1) {</span>
<a href="#l13.1599"></a><span id="l13.1599">       // A valid left pane folder has been found.</span>
<a href="#l13.1600"></a><span id="l13.1600">       // Build the leftPaneQueries Map.  This is used to quickly access them,</span>
<a href="#l13.1601"></a><span id="l13.1601">       // associating a mnemonic name to the real item ids.</span>
<a href="#l13.1602"></a><span id="l13.1602">       delete this.leftPaneQueries;</span>
<a href="#l13.1603"></a><span id="l13.1603">       this.leftPaneQueries = {};</span>
<a href="#l13.1604"></a><span id="l13.1604"> </span>
<a href="#l13.1605"></a><span id="l13.1605" class="difflineminus">-      let items = as.getItemsWithAnnotation(this.ORGANIZER_QUERY_ANNO);</span>
<a href="#l13.1606"></a><span id="l13.1606" class="difflineplus">+      let queryItems = as.getItemsWithAnnotation(this.ORGANIZER_QUERY_ANNO);</span>
<a href="#l13.1607"></a><span id="l13.1607">       // While looping through queries we will also check for their validity.</span>
<a href="#l13.1608"></a><span id="l13.1608">       let queriesCount = 0;</span>
<a href="#l13.1609"></a><span id="l13.1609" class="difflineminus">-      for (let i = 0; i &lt; items.length; i++) {</span>
<a href="#l13.1610"></a><span id="l13.1610" class="difflineminus">-        let queryName = as.getItemAnnotation(items[i], this.ORGANIZER_QUERY_ANNO);</span>
<a href="#l13.1611"></a><span id="l13.1611" class="difflineplus">+      let corrupt = false;</span>
<a href="#l13.1612"></a><span id="l13.1612" class="difflineplus">+      for (let i = 0; i &lt; queryItems.length; i++) {</span>
<a href="#l13.1613"></a><span id="l13.1613" class="difflineplus">+        let queryName = as.getItemAnnotation(queryItems[i], this.ORGANIZER_QUERY_ANNO);</span>
<a href="#l13.1614"></a><span id="l13.1614"> </span>
<a href="#l13.1615"></a><span id="l13.1615">         // Some extension did use our annotation to decorate their items</span>
<a href="#l13.1616"></a><span id="l13.1616">         // with icons, so we should check only our elements, to avoid dataloss.</span>
<a href="#l13.1617"></a><span id="l13.1617">         if (!(queryName in queries))</span>
<a href="#l13.1618"></a><span id="l13.1618">           continue;</span>
<a href="#l13.1619"></a><span id="l13.1619"> </span>
<a href="#l13.1620"></a><span id="l13.1620">         let query = queries[queryName];</span>
<a href="#l13.1621"></a><span id="l13.1621" class="difflineminus">-        query.itemId = items[i];</span>
<a href="#l13.1622"></a><span id="l13.1622" class="difflineplus">+        query.itemId = queryItems[i];</span>
<a href="#l13.1623"></a><span id="l13.1623"> </span>
<a href="#l13.1624"></a><span id="l13.1624">         if (!itemExists(query.itemId)) {</span>
<a href="#l13.1625"></a><span id="l13.1625">           // Orphan annotation, bail out and create a new left pane root.</span>
<a href="#l13.1626"></a><span id="l13.1626" class="difflineplus">+          corrupt = true;</span>
<a href="#l13.1627"></a><span id="l13.1627">           break;</span>
<a href="#l13.1628"></a><span id="l13.1628">         }</span>
<a href="#l13.1629"></a><span id="l13.1629"> </span>
<a href="#l13.1630"></a><span id="l13.1630">         // Check that all queries have valid parents.</span>
<a href="#l13.1631"></a><span id="l13.1631">         let parentId = bs.getFolderIdForItem(query.itemId);</span>
<a href="#l13.1632"></a><span id="l13.1632" class="difflineminus">-        if (items.indexOf(parentId) == -1 &amp;&amp; parentId != leftPaneRoot) {</span>
<a href="#l13.1633"></a><span id="l13.1633" class="difflineplus">+        if (!queryItems.includes(parentId) &amp;&amp; parentId != leftPaneRoot) {</span>
<a href="#l13.1634"></a><span id="l13.1634">           // The parent is not part of the left pane, bail out and create a new</span>
<a href="#l13.1635"></a><span id="l13.1635">           // left pane root.</span>
<a href="#l13.1636"></a><span id="l13.1636" class="difflineplus">+          corrupt = true;</span>
<a href="#l13.1637"></a><span id="l13.1637">           break;</span>
<a href="#l13.1638"></a><span id="l13.1638">         }</span>
<a href="#l13.1639"></a><span id="l13.1639"> </span>
<a href="#l13.1640"></a><span id="l13.1640">         // Titles could have been corrupted or the user could have changed his</span>
<a href="#l13.1641"></a><span id="l13.1641">         // locale.  Check title and eventually fix it.</span>
<a href="#l13.1642"></a><span id="l13.1642">         if (bs.getItemTitle(query.itemId) != query.title)</span>
<a href="#l13.1643"></a><span id="l13.1643">           bs.setItemTitle(query.itemId, query.title);</span>
<a href="#l13.1644"></a><span id="l13.1644">         if (&quot;concreteId&quot; in query) {</span>
<a href="#l13.1645"></a><span id="l13.1645" class="difflineat">@@ -1167,27 +1232,29 @@ var PlacesUIUtils = {</span>
<a href="#l13.1646"></a><span id="l13.1646">             bs.setItemTitle(query.concreteId, query.concreteTitle);</span>
<a href="#l13.1647"></a><span id="l13.1647">         }</span>
<a href="#l13.1648"></a><span id="l13.1648"> </span>
<a href="#l13.1649"></a><span id="l13.1649">         // Add the query to our cache.</span>
<a href="#l13.1650"></a><span id="l13.1650">         this.leftPaneQueries[queryName] = query.itemId;</span>
<a href="#l13.1651"></a><span id="l13.1651">         queriesCount++;</span>
<a href="#l13.1652"></a><span id="l13.1652">       }</span>
<a href="#l13.1653"></a><span id="l13.1653"> </span>
<a href="#l13.1654"></a><span id="l13.1654" class="difflineminus">-      if (queriesCount != EXPECTED_QUERY_COUNT) {</span>
<a href="#l13.1655"></a><span id="l13.1655" class="difflineplus">+      // Note: it's not enough to just check for queriesCount, since we may</span>
<a href="#l13.1656"></a><span id="l13.1656" class="difflineplus">+      // find an invalid query just after accounting for a sufficient number of</span>
<a href="#l13.1657"></a><span id="l13.1657" class="difflineplus">+      // valid ones.  As well as we can't just rely on corrupt since we may find</span>
<a href="#l13.1658"></a><span id="l13.1658" class="difflineplus">+      // less valid queries than expected.</span>
<a href="#l13.1659"></a><span id="l13.1659" class="difflineplus">+      if (corrupt || queriesCount != EXPECTED_QUERY_COUNT) {</span>
<a href="#l13.1660"></a><span id="l13.1660">         // Queries number is wrong, so the left pane must be corrupt.</span>
<a href="#l13.1661"></a><span id="l13.1661">         // Note: we can't just remove the leftPaneRoot, because some query could</span>
<a href="#l13.1662"></a><span id="l13.1662">         // have a bad parent, so we have to remove all items one by one.</span>
<a href="#l13.1663"></a><span id="l13.1663" class="difflineminus">-        items.forEach(safeRemoveItem);</span>
<a href="#l13.1664"></a><span id="l13.1664" class="difflineplus">+        queryItems.forEach(safeRemoveItem);</span>
<a href="#l13.1665"></a><span id="l13.1665">         safeRemoveItem(leftPaneRoot);</span>
<a href="#l13.1666"></a><span id="l13.1666" class="difflineminus">-      }</span>
<a href="#l13.1667"></a><span id="l13.1667" class="difflineminus">-      else {</span>
<a href="#l13.1668"></a><span id="l13.1668" class="difflineplus">+      } else {</span>
<a href="#l13.1669"></a><span id="l13.1669">         // Everything is fine, return the current left pane folder.</span>
<a href="#l13.1670"></a><span id="l13.1670" class="difflineminus">-        delete this.leftPaneFolderId;</span>
<a href="#l13.1671"></a><span id="l13.1671" class="difflineminus">-        return this.leftPaneFolderId = leftPaneRoot;</span>
<a href="#l13.1672"></a><span id="l13.1672" class="difflineplus">+        return leftPaneRoot;</span>
<a href="#l13.1673"></a><span id="l13.1673">       }</span>
<a href="#l13.1674"></a><span id="l13.1674">     }</span>
<a href="#l13.1675"></a><span id="l13.1675"> </span>
<a href="#l13.1676"></a><span id="l13.1676">     // Create a new left pane folder.</span>
<a href="#l13.1677"></a><span id="l13.1677">     var callback = {</span>
<a href="#l13.1678"></a><span id="l13.1678">       // Helper to create an organizer special query.</span>
<a href="#l13.1679"></a><span id="l13.1679">       create_query: function CB_create_query(aQueryName, aParentId, aQueryUrl) {</span>
<a href="#l13.1680"></a><span id="l13.1680">         let itemId = bs.insertBookmark(aParentId,</span>
<a href="#l13.1681"></a><span id="l13.1681" class="difflineat">@@ -1215,33 +1282,39 @@ var PlacesUIUtils = {</span>
<a href="#l13.1682"></a><span id="l13.1682">         as.setItemAnnotation(folderId, PlacesUtils.EXCLUDE_FROM_BACKUP_ANNO, 1,</span>
<a href="#l13.1683"></a><span id="l13.1683">                              0, as.EXPIRE_NEVER);</span>
<a href="#l13.1684"></a><span id="l13.1684"> </span>
<a href="#l13.1685"></a><span id="l13.1685">         if (aIsRoot) {</span>
<a href="#l13.1686"></a><span id="l13.1686">           // Mark as special left pane root.</span>
<a href="#l13.1687"></a><span id="l13.1687">           as.setItemAnnotation(folderId, PlacesUIUtils.ORGANIZER_FOLDER_ANNO,</span>
<a href="#l13.1688"></a><span id="l13.1688">                                PlacesUIUtils.ORGANIZER_LEFTPANE_VERSION,</span>
<a href="#l13.1689"></a><span id="l13.1689">                                0, as.EXPIRE_NEVER);</span>
<a href="#l13.1690"></a><span id="l13.1690" class="difflineminus">-        }</span>
<a href="#l13.1691"></a><span id="l13.1691" class="difflineminus">-        else {</span>
<a href="#l13.1692"></a><span id="l13.1692" class="difflineplus">+        } else {</span>
<a href="#l13.1693"></a><span id="l13.1693">           // Mark as special organizer folder.</span>
<a href="#l13.1694"></a><span id="l13.1694" class="difflineminus">-          as.setItemAnnotation(folderId, PlacesUIUtils.ORGANIZER_QUERY_ANNO,</span>
<a href="#l13.1695"></a><span id="l13.1695" class="difflineminus">-                               aFolderName, 0, as.EXPIRE_NEVER);</span>
<a href="#l13.1696"></a><span id="l13.1696" class="difflineplus">+          as.setItemAnnotation(folderId, PlacesUIUtils.ORGANIZER_QUERY_ANNO, aFolderName,</span>
<a href="#l13.1697"></a><span id="l13.1697" class="difflineplus">+                           0, as.EXPIRE_NEVER);</span>
<a href="#l13.1698"></a><span id="l13.1698">           PlacesUIUtils.leftPaneQueries[aFolderName] = folderId;</span>
<a href="#l13.1699"></a><span id="l13.1699">         }</span>
<a href="#l13.1700"></a><span id="l13.1700">         return folderId;</span>
<a href="#l13.1701"></a><span id="l13.1701">       },</span>
<a href="#l13.1702"></a><span id="l13.1702"> </span>
<a href="#l13.1703"></a><span id="l13.1703">       runBatched: function CB_runBatched(aUserData) {</span>
<a href="#l13.1704"></a><span id="l13.1704">         delete PlacesUIUtils.leftPaneQueries;</span>
<a href="#l13.1705"></a><span id="l13.1705">         PlacesUIUtils.leftPaneQueries = { };</span>
<a href="#l13.1706"></a><span id="l13.1706"> </span>
<a href="#l13.1707"></a><span id="l13.1707">         // Left Pane Root Folder.</span>
<a href="#l13.1708"></a><span id="l13.1708">         leftPaneRoot = this.create_folder(&quot;PlacesRoot&quot;, bs.placesRoot, true);</span>
<a href="#l13.1709"></a><span id="l13.1709"> </span>
<a href="#l13.1710"></a><span id="l13.1710" class="difflineplus">+        // History Query.</span>
<a href="#l13.1711"></a><span id="l13.1711" class="difflineplus">+        this.create_query(&quot;History&quot;, leftPaneRoot,</span>
<a href="#l13.1712"></a><span id="l13.1712" class="difflineplus">+                          &quot;place:type=&quot; +</span>
<a href="#l13.1713"></a><span id="l13.1713" class="difflineplus">+                          Ci.nsINavHistoryQueryOptions.RESULTS_AS_DATE_QUERY +</span>
<a href="#l13.1714"></a><span id="l13.1714" class="difflineplus">+                          &quot;&amp;sort=&quot; +</span>
<a href="#l13.1715"></a><span id="l13.1715" class="difflineplus">+                          Ci.nsINavHistoryQueryOptions.SORT_BY_DATE_DESCENDING);</span>
<a href="#l13.1716"></a><span id="l13.1716" class="difflineplus">+</span>
<a href="#l13.1717"></a><span id="l13.1717">         // Tags Query.</span>
<a href="#l13.1718"></a><span id="l13.1718">         this.create_query(&quot;Tags&quot;, leftPaneRoot,</span>
<a href="#l13.1719"></a><span id="l13.1719">                           &quot;place:type=&quot; +</span>
<a href="#l13.1720"></a><span id="l13.1720">                           Ci.nsINavHistoryQueryOptions.RESULTS_AS_TAG_QUERY +</span>
<a href="#l13.1721"></a><span id="l13.1721">                           &quot;&amp;sort=&quot; +</span>
<a href="#l13.1722"></a><span id="l13.1722">                           Ci.nsINavHistoryQueryOptions.SORT_BY_TITLE_ASCENDING);</span>
<a href="#l13.1723"></a><span id="l13.1723"> </span>
<a href="#l13.1724"></a><span id="l13.1724">         // All Bookmarks Folder.</span>
<a href="#l13.1725"></a><span id="l13.1725" class="difflineat">@@ -1257,18 +1330,17 @@ var PlacesUIUtils = {</span>
<a href="#l13.1726"></a><span id="l13.1726"> </span>
<a href="#l13.1727"></a><span id="l13.1727">         // All Bookmarks-&gt;Unfiled Bookmarks Query.</span>
<a href="#l13.1728"></a><span id="l13.1728">         this.create_query(&quot;UnfiledBookmarks&quot;, allBookmarksId,</span>
<a href="#l13.1729"></a><span id="l13.1729">                           &quot;place:folder=UNFILED_BOOKMARKS&quot;);</span>
<a href="#l13.1730"></a><span id="l13.1730">       }</span>
<a href="#l13.1731"></a><span id="l13.1731">     };</span>
<a href="#l13.1732"></a><span id="l13.1732">     bs.runInBatchMode(callback, null);</span>
<a href="#l13.1733"></a><span id="l13.1733"> </span>
<a href="#l13.1734"></a><span id="l13.1734" class="difflineminus">-    delete this.leftPaneFolderId;</span>
<a href="#l13.1735"></a><span id="l13.1735" class="difflineminus">-    return this.leftPaneFolderId = leftPaneRoot;</span>
<a href="#l13.1736"></a><span id="l13.1736" class="difflineplus">+    return leftPaneRoot;</span>
<a href="#l13.1737"></a><span id="l13.1737">   },</span>
<a href="#l13.1738"></a><span id="l13.1738"> </span>
<a href="#l13.1739"></a><span id="l13.1739">   /**</span>
<a href="#l13.1740"></a><span id="l13.1740">    * Get the folder id for the organizer left-pane folder.</span>
<a href="#l13.1741"></a><span id="l13.1741">    */</span>
<a href="#l13.1742"></a><span id="l13.1742">   get allBookmarksFolderId() {</span>
<a href="#l13.1743"></a><span id="l13.1743">     // ensure the left-pane root is initialized;</span>
<a href="#l13.1744"></a><span id="l13.1744">     this.leftPaneFolderId;</span>
<a href="#l13.1745"></a><span id="l13.1745" class="difflineat">@@ -1276,252 +1348,405 @@ var PlacesUIUtils = {</span>
<a href="#l13.1746"></a><span id="l13.1746">     return this.allBookmarksFolderId = this.leftPaneQueries[&quot;AllBookmarks&quot;];</span>
<a href="#l13.1747"></a><span id="l13.1747">   },</span>
<a href="#l13.1748"></a><span id="l13.1748"> </span>
<a href="#l13.1749"></a><span id="l13.1749">   /**</span>
<a href="#l13.1750"></a><span id="l13.1750">    * If an item is a left-pane query, returns the name of the query</span>
<a href="#l13.1751"></a><span id="l13.1751">    * or an empty string if not.</span>
<a href="#l13.1752"></a><span id="l13.1752">    *</span>
<a href="#l13.1753"></a><span id="l13.1753">    * @param aItemId id of a container</span>
<a href="#l13.1754"></a><span id="l13.1754" class="difflineminus">-   * @returns the name of the query, or empty string if not a left-pane query</span>
<a href="#l13.1755"></a><span id="l13.1755" class="difflineplus">+   * @return the name of the query, or empty string if not a left-pane query</span>
<a href="#l13.1756"></a><span id="l13.1756">    */</span>
<a href="#l13.1757"></a><span id="l13.1757">   getLeftPaneQueryNameFromId: function PUIU_getLeftPaneQueryNameFromId(aItemId) {</span>
<a href="#l13.1758"></a><span id="l13.1758">     var queryName = &quot;&quot;;</span>
<a href="#l13.1759"></a><span id="l13.1759">     // If the let pane hasn't been built, use the annotation service</span>
<a href="#l13.1760"></a><span id="l13.1760">     // directly, to avoid building the left pane too early.</span>
<a href="#l13.1761"></a><span id="l13.1761">     if (Object.getOwnPropertyDescriptor(this, &quot;leftPaneFolderId&quot;).value === undefined) {</span>
<a href="#l13.1762"></a><span id="l13.1762">       try {</span>
<a href="#l13.1763"></a><span id="l13.1763">         queryName = PlacesUtils.annotations.</span>
<a href="#l13.1764"></a><span id="l13.1764">                                 getItemAnnotation(aItemId, this.ORGANIZER_QUERY_ANNO);</span>
<a href="#l13.1765"></a><span id="l13.1765" class="difflineminus">-      }</span>
<a href="#l13.1766"></a><span id="l13.1766" class="difflineminus">-      catch (ex) {</span>
<a href="#l13.1767"></a><span id="l13.1767" class="difflineplus">+      } catch (ex) {</span>
<a href="#l13.1768"></a><span id="l13.1768">         // doesn't have the annotation</span>
<a href="#l13.1769"></a><span id="l13.1769">         queryName = &quot;&quot;;</span>
<a href="#l13.1770"></a><span id="l13.1770">       }</span>
<a href="#l13.1771"></a><span id="l13.1771" class="difflineminus">-    }</span>
<a href="#l13.1772"></a><span id="l13.1772" class="difflineminus">-    else {</span>
<a href="#l13.1773"></a><span id="l13.1773" class="difflineplus">+    } else {</span>
<a href="#l13.1774"></a><span id="l13.1774">       // If the left pane has already been built, use the name-&gt;id map</span>
<a href="#l13.1775"></a><span id="l13.1775">       // cached in PlacesUIUtils.</span>
<a href="#l13.1776"></a><span id="l13.1776">       for (let [name, id] of Object.entries(this.leftPaneQueries)) {</span>
<a href="#l13.1777"></a><span id="l13.1777">         if (aItemId == id)</span>
<a href="#l13.1778"></a><span id="l13.1778">           queryName = name;</span>
<a href="#l13.1779"></a><span id="l13.1779">       }</span>
<a href="#l13.1780"></a><span id="l13.1780">     }</span>
<a href="#l13.1781"></a><span id="l13.1781">     return queryName;</span>
<a href="#l13.1782"></a><span id="l13.1782" class="difflineplus">+  },</span>
<a href="#l13.1783"></a><span id="l13.1783" class="difflineplus">+</span>
<a href="#l13.1784"></a><span id="l13.1784" class="difflineplus">+  shouldShowTabsFromOtherComputersMenuitem() {</span>
<a href="#l13.1785"></a><span id="l13.1785" class="difflineplus">+    let weaveOK = Weave.Status.checkSetup() != Weave.CLIENT_NOT_CONFIGURED &amp;&amp;</span>
<a href="#l13.1786"></a><span id="l13.1786" class="difflineplus">+                  Weave.Svc.Prefs.get(&quot;firstSync&quot;, &quot;&quot;) != &quot;notReady&quot;;</span>
<a href="#l13.1787"></a><span id="l13.1787" class="difflineplus">+    return weaveOK;</span>
<a href="#l13.1788"></a><span id="l13.1788" class="difflineplus">+  },</span>
<a href="#l13.1789"></a><span id="l13.1789" class="difflineplus">+</span>
<a href="#l13.1790"></a><span id="l13.1790" class="difflineplus">+  /**</span>
<a href="#l13.1791"></a><span id="l13.1791" class="difflineplus">+   * WARNING TO ADDON AUTHORS: DO NOT USE THIS METHOD. IT'S LIKELY TO BE REMOVED IN A</span>
<a href="#l13.1792"></a><span id="l13.1792" class="difflineplus">+   * FUTURE RELEASE.</span>
<a href="#l13.1793"></a><span id="l13.1793" class="difflineplus">+   *</span>
<a href="#l13.1794"></a><span id="l13.1794" class="difflineplus">+   * Checks if a place: href represents a folder shortcut.</span>
<a href="#l13.1795"></a><span id="l13.1795" class="difflineplus">+   *</span>
<a href="#l13.1796"></a><span id="l13.1796" class="difflineplus">+   * @param queryString</span>
<a href="#l13.1797"></a><span id="l13.1797" class="difflineplus">+   *        the query string to check (a place: href)</span>
<a href="#l13.1798"></a><span id="l13.1798" class="difflineplus">+   * @return whether or not queryString represents a folder shortcut.</span>
<a href="#l13.1799"></a><span id="l13.1799" class="difflineplus">+   * @throws if queryString is malformed.</span>
<a href="#l13.1800"></a><span id="l13.1800" class="difflineplus">+   */</span>
<a href="#l13.1801"></a><span id="l13.1801" class="difflineplus">+  isFolderShortcutQueryString(queryString) {</span>
<a href="#l13.1802"></a><span id="l13.1802" class="difflineplus">+    // Based on GetSimpleBookmarksQueryFolder in nsNavHistory.cpp.</span>
<a href="#l13.1803"></a><span id="l13.1803" class="difflineplus">+</span>
<a href="#l13.1804"></a><span id="l13.1804" class="difflineplus">+    let queriesParam = { }, optionsParam = { };</span>
<a href="#l13.1805"></a><span id="l13.1805" class="difflineplus">+    PlacesUtils.history.queryStringToQueries(queryString,</span>
<a href="#l13.1806"></a><span id="l13.1806" class="difflineplus">+                                             queriesParam,</span>
<a href="#l13.1807"></a><span id="l13.1807" class="difflineplus">+                                             { },</span>
<a href="#l13.1808"></a><span id="l13.1808" class="difflineplus">+                                             optionsParam);</span>
<a href="#l13.1809"></a><span id="l13.1809" class="difflineplus">+    let queries = queries.value;</span>
<a href="#l13.1810"></a><span id="l13.1810" class="difflineplus">+    if (queries.length == 0)</span>
<a href="#l13.1811"></a><span id="l13.1811" class="difflineplus">+      throw new Error(`Invalid place: uri: ${queryString}`);</span>
<a href="#l13.1812"></a><span id="l13.1812" class="difflineplus">+    return queries.length == 1 &amp;&amp;</span>
<a href="#l13.1813"></a><span id="l13.1813" class="difflineplus">+           queries[0].folderCount == 1 &amp;&amp;</span>
<a href="#l13.1814"></a><span id="l13.1814" class="difflineplus">+           !queries[0].hasBeginTime &amp;&amp;</span>
<a href="#l13.1815"></a><span id="l13.1815" class="difflineplus">+           !queries[0].hasEndTime &amp;&amp;</span>
<a href="#l13.1816"></a><span id="l13.1816" class="difflineplus">+           !queries[0].hasDomain &amp;&amp;</span>
<a href="#l13.1817"></a><span id="l13.1817" class="difflineplus">+           !queries[0].hasURI &amp;&amp;</span>
<a href="#l13.1818"></a><span id="l13.1818" class="difflineplus">+           !queries[0].hasSearchTerms &amp;&amp;</span>
<a href="#l13.1819"></a><span id="l13.1819" class="difflineplus">+           !queries[0].tags.length == 0 &amp;&amp;</span>
<a href="#l13.1820"></a><span id="l13.1820" class="difflineplus">+           optionsParam.value.maxResults == 0;</span>
<a href="#l13.1821"></a><span id="l13.1821" class="difflineplus">+  },</span>
<a href="#l13.1822"></a><span id="l13.1822" class="difflineplus">+</span>
<a href="#l13.1823"></a><span id="l13.1823" class="difflineplus">+  /**</span>
<a href="#l13.1824"></a><span id="l13.1824" class="difflineplus">+   * @see showAddBookmarkUI</span>
<a href="#l13.1825"></a><span id="l13.1825" class="difflineplus">+   * This opens the dialog with only the name and folder pickers visible by</span>
<a href="#l13.1826"></a><span id="l13.1826" class="difflineplus">+   * default.</span>
<a href="#l13.1827"></a><span id="l13.1827" class="difflineplus">+   *</span>
<a href="#l13.1828"></a><span id="l13.1828" class="difflineplus">+   * This is to be used only outside of the SeaMonkey browser part e.g. for</span>
<a href="#l13.1829"></a><span id="l13.1829" class="difflineplus">+   * bookmarking in mail and news windows.</span>
<a href="#l13.1830"></a><span id="l13.1830" class="difflineplus">+   *</span>
<a href="#l13.1831"></a><span id="l13.1831" class="difflineplus">+   * You can still pass in the various paramaters as the default properties</span>
<a href="#l13.1832"></a><span id="l13.1832" class="difflineplus">+   * for the new bookmark.</span>
<a href="#l13.1833"></a><span id="l13.1833" class="difflineplus">+   *</span>
<a href="#l13.1834"></a><span id="l13.1834" class="difflineplus">+   * The keyword field will be visible only if the aKeyword parameter</span>
<a href="#l13.1835"></a><span id="l13.1835" class="difflineplus">+   * was used.</span>
<a href="#l13.1836"></a><span id="l13.1836" class="difflineplus">+   */</span>
<a href="#l13.1837"></a><span id="l13.1837" class="difflineplus">+  showMinimalAddBookmarkUI:</span>
<a href="#l13.1838"></a><span id="l13.1838" class="difflineplus">+  function PUIU_showMinimalAddBookmarkUI(aURI, aTitle, aDescription,</span>
<a href="#l13.1839"></a><span id="l13.1839" class="difflineplus">+                                         aDefaultInsertionPoint, aShowPicker,</span>
<a href="#l13.1840"></a><span id="l13.1840" class="difflineplus">+                                         aLoadInSidebar, aKeyword, aPostData,</span>
<a href="#l13.1841"></a><span id="l13.1841" class="difflineplus">+                                         aCharSet) {</span>
<a href="#l13.1842"></a><span id="l13.1842" class="difflineplus">+    var info = {</span>
<a href="#l13.1843"></a><span id="l13.1843" class="difflineplus">+      action: &quot;add&quot;,</span>
<a href="#l13.1844"></a><span id="l13.1844" class="difflineplus">+      type: &quot;bookmark&quot;,</span>
<a href="#l13.1845"></a><span id="l13.1845" class="difflineplus">+      hiddenRows: [&quot;description&quot;]</span>
<a href="#l13.1846"></a><span id="l13.1846" class="difflineplus">+    };</span>
<a href="#l13.1847"></a><span id="l13.1847" class="difflineplus">+    if (aURI)</span>
<a href="#l13.1848"></a><span id="l13.1848" class="difflineplus">+      info.uri = aURI;</span>
<a href="#l13.1849"></a><span id="l13.1849" class="difflineplus">+</span>
<a href="#l13.1850"></a><span id="l13.1850" class="difflineplus">+    // allow default empty title</span>
<a href="#l13.1851"></a><span id="l13.1851" class="difflineplus">+    if (typeof(aTitle) == &quot;string&quot;)</span>
<a href="#l13.1852"></a><span id="l13.1852" class="difflineplus">+      info.title = aTitle;</span>
<a href="#l13.1853"></a><span id="l13.1853" class="difflineplus">+</span>
<a href="#l13.1854"></a><span id="l13.1854" class="difflineplus">+    if (aDescription)</span>
<a href="#l13.1855"></a><span id="l13.1855" class="difflineplus">+      info.description = aDescription;</span>
<a href="#l13.1856"></a><span id="l13.1856" class="difflineplus">+</span>
<a href="#l13.1857"></a><span id="l13.1857" class="difflineplus">+    if (aDefaultInsertionPoint) {</span>
<a href="#l13.1858"></a><span id="l13.1858" class="difflineplus">+      info.defaultInsertionPoint = aDefaultInsertionPoint;</span>
<a href="#l13.1859"></a><span id="l13.1859" class="difflineplus">+      if (!aShowPicker)</span>
<a href="#l13.1860"></a><span id="l13.1860" class="difflineplus">+        info.hiddenRows.push(&quot;folderPicker&quot;);</span>
<a href="#l13.1861"></a><span id="l13.1861" class="difflineplus">+    }</span>
<a href="#l13.1862"></a><span id="l13.1862" class="difflineplus">+</span>
<a href="#l13.1863"></a><span id="l13.1863" class="difflineplus">+    info.hiddenRows = info.hiddenRows.concat([&quot;location&quot;]);</span>
<a href="#l13.1864"></a><span id="l13.1864" class="difflineplus">+</span>
<a href="#l13.1865"></a><span id="l13.1865" class="difflineplus">+    if (typeof(aKeyword) == &quot;string&quot;) {</span>
<a href="#l13.1866"></a><span id="l13.1866" class="difflineplus">+      info.keyword = aKeyword;</span>
<a href="#l13.1867"></a><span id="l13.1867" class="difflineplus">+      // Hide the Tags field if we are adding a keyword.</span>
<a href="#l13.1868"></a><span id="l13.1868" class="difflineplus">+      info.hiddenRows.push(&quot;tags&quot;);</span>
<a href="#l13.1869"></a><span id="l13.1869" class="difflineplus">+      // Keyword related params.</span>
<a href="#l13.1870"></a><span id="l13.1870" class="difflineplus">+      if (typeof(aPostData) == &quot;string&quot;)</span>
<a href="#l13.1871"></a><span id="l13.1871" class="difflineplus">+        info.postData = aPostData;</span>
<a href="#l13.1872"></a><span id="l13.1872" class="difflineplus">+      if (typeof(aCharSet) == &quot;string&quot;)</span>
<a href="#l13.1873"></a><span id="l13.1873" class="difflineplus">+        info.charSet = aCharSet;</span>
<a href="#l13.1874"></a><span id="l13.1874" class="difflineplus">+    }</span>
<a href="#l13.1875"></a><span id="l13.1875" class="difflineplus">+    else</span>
<a href="#l13.1876"></a><span id="l13.1876" class="difflineplus">+      info.hiddenRows.push(&quot;keyword&quot;);</span>
<a href="#l13.1877"></a><span id="l13.1877" class="difflineplus">+</span>
<a href="#l13.1878"></a><span id="l13.1878" class="difflineplus">+    return this.showBookmarkDialog(info,</span>
<a href="#l13.1879"></a><span id="l13.1879" class="difflineplus">+                                   focusManager.activeWindow ||</span>
<a href="#l13.1880"></a><span id="l13.1880" class="difflineplus">+                                   Services.wm.getMostRecentWindow(null));</span>
<a href="#l13.1881"></a><span id="l13.1881" class="difflineplus">+  },</span>
<a href="#l13.1882"></a><span id="l13.1882" class="difflineplus">+</span>
<a href="#l13.1883"></a><span id="l13.1883" class="difflineplus">+  /**</span>
<a href="#l13.1884"></a><span id="l13.1884" class="difflineplus">+   * Helpers for consumers of editBookmarkOverlay which don't have a node as their input.</span>
<a href="#l13.1885"></a><span id="l13.1885" class="difflineplus">+   *</span>
<a href="#l13.1886"></a><span id="l13.1886" class="difflineplus">+   * Given a bookmark object for either a url bookmark or a folder, returned by</span>
<a href="#l13.1887"></a><span id="l13.1887" class="difflineplus">+   * Bookmarks.fetch (see Bookmark.jsm), this creates a node-like object suitable for</span>
<a href="#l13.1888"></a><span id="l13.1888" class="difflineplus">+   * initialising the edit overlay with it.</span>
<a href="#l13.1889"></a><span id="l13.1889" class="difflineplus">+   *</span>
<a href="#l13.1890"></a><span id="l13.1890" class="difflineplus">+   * @param aFetchInfo</span>
<a href="#l13.1891"></a><span id="l13.1891" class="difflineplus">+   *        a bookmark object returned by Bookmarks.fetch.</span>
<a href="#l13.1892"></a><span id="l13.1892" class="difflineplus">+   * @return a node-like object suitable for initialising editBookmarkOverlay.</span>
<a href="#l13.1893"></a><span id="l13.1893" class="difflineplus">+   * @throws if aFetchInfo is representing a separator.</span>
<a href="#l13.1894"></a><span id="l13.1894" class="difflineplus">+   */</span>
<a href="#l13.1895"></a><span id="l13.1895" class="difflineplus">+  async promiseNodeLikeFromFetchInfo(aFetchInfo) {</span>
<a href="#l13.1896"></a><span id="l13.1896" class="difflineplus">+    if (aFetchInfo.itemType == PlacesUtils.bookmarks.TYPE_SEPARATOR)</span>
<a href="#l13.1897"></a><span id="l13.1897" class="difflineplus">+      throw new Error(&quot;promiseNodeLike doesn't support separators&quot;);</span>
<a href="#l13.1898"></a><span id="l13.1898" class="difflineplus">+</span>
<a href="#l13.1899"></a><span id="l13.1899" class="difflineplus">+    let parent = {</span>
<a href="#l13.1900"></a><span id="l13.1900" class="difflineplus">+      itemId: await PlacesUtils.promiseItemId(aFetchInfo.parentGuid),</span>
<a href="#l13.1901"></a><span id="l13.1901" class="difflineplus">+      bookmarkGuid: aFetchInfo.parentGuid,</span>
<a href="#l13.1902"></a><span id="l13.1902" class="difflineplus">+      type: Ci.nsINavHistoryResultNode.RESULT_TYPE_FOLDER</span>
<a href="#l13.1903"></a><span id="l13.1903" class="difflineplus">+    };</span>
<a href="#l13.1904"></a><span id="l13.1904" class="difflineplus">+</span>
<a href="#l13.1905"></a><span id="l13.1905" class="difflineplus">+    return Object.freeze({</span>
<a href="#l13.1906"></a><span id="l13.1906" class="difflineplus">+      itemId: await PlacesUtils.promiseItemId(aFetchInfo.guid),</span>
<a href="#l13.1907"></a><span id="l13.1907" class="difflineplus">+      bookmarkGuid: aFetchInfo.guid,</span>
<a href="#l13.1908"></a><span id="l13.1908" class="difflineplus">+      title: aFetchInfo.title,</span>
<a href="#l13.1909"></a><span id="l13.1909" class="difflineplus">+      uri: aFetchInfo.url !== undefined ? aFetchInfo.url.href : &quot;&quot;,</span>
<a href="#l13.1910"></a><span id="l13.1910" class="difflineplus">+</span>
<a href="#l13.1911"></a><span id="l13.1911" class="difflineplus">+      get type() {</span>
<a href="#l13.1912"></a><span id="l13.1912" class="difflineplus">+        if (aFetchInfo.itemType == PlacesUtils.bookmarks.TYPE_FOLDER)</span>
<a href="#l13.1913"></a><span id="l13.1913" class="difflineplus">+          return Ci.nsINavHistoryResultNode.RESULT_TYPE_FOLDER;</span>
<a href="#l13.1914"></a><span id="l13.1914" class="difflineplus">+</span>
<a href="#l13.1915"></a><span id="l13.1915" class="difflineplus">+        if (this.uri.length == 0)</span>
<a href="#l13.1916"></a><span id="l13.1916" class="difflineplus">+          throw new Error(&quot;Unexpected item type&quot;);</span>
<a href="#l13.1917"></a><span id="l13.1917" class="difflineplus">+</span>
<a href="#l13.1918"></a><span id="l13.1918" class="difflineplus">+        if (/^place:/.test(this.uri)) {</span>
<a href="#l13.1919"></a><span id="l13.1919" class="difflineplus">+          if (this.isFolderShortcutQueryString(this.uri))</span>
<a href="#l13.1920"></a><span id="l13.1920" class="difflineplus">+            return Ci.nsINavHistoryResultNode.RESULT_TYPE_FOLDER_SHORTCUT;</span>
<a href="#l13.1921"></a><span id="l13.1921" class="difflineplus">+</span>
<a href="#l13.1922"></a><span id="l13.1922" class="difflineplus">+          return Ci.nsINavHistoryResultNode.RESULT_TYPE_QUERY;</span>
<a href="#l13.1923"></a><span id="l13.1923" class="difflineplus">+        }</span>
<a href="#l13.1924"></a><span id="l13.1924" class="difflineplus">+</span>
<a href="#l13.1925"></a><span id="l13.1925" class="difflineplus">+        return Ci.nsINavHistoryResultNode.RESULT_TYPE_URI;</span>
<a href="#l13.1926"></a><span id="l13.1926" class="difflineplus">+      },</span>
<a href="#l13.1927"></a><span id="l13.1927" class="difflineplus">+</span>
<a href="#l13.1928"></a><span id="l13.1928" class="difflineplus">+      get parent() {</span>
<a href="#l13.1929"></a><span id="l13.1929" class="difflineplus">+        return parent;</span>
<a href="#l13.1930"></a><span id="l13.1930" class="difflineplus">+      }</span>
<a href="#l13.1931"></a><span id="l13.1931" class="difflineplus">+    });</span>
<a href="#l13.1932"></a><span id="l13.1932" class="difflineplus">+  },</span>
<a href="#l13.1933"></a><span id="l13.1933" class="difflineplus">+</span>
<a href="#l13.1934"></a><span id="l13.1934" class="difflineplus">+  /**</span>
<a href="#l13.1935"></a><span id="l13.1935" class="difflineplus">+   * Shortcut for calling promiseNodeLikeFromFetchInfo on the result of</span>
<a href="#l13.1936"></a><span id="l13.1936" class="difflineplus">+   * Bookmarks.fetch for the given guid/info object.</span>
<a href="#l13.1937"></a><span id="l13.1937" class="difflineplus">+   *</span>
<a href="#l13.1938"></a><span id="l13.1938" class="difflineplus">+   * @see promiseNodeLikeFromFetchInfo above and Bookmarks.fetch in Bookmarks.jsm.</span>
<a href="#l13.1939"></a><span id="l13.1939" class="difflineplus">+   */</span>
<a href="#l13.1940"></a><span id="l13.1940" class="difflineplus">+  async fetchNodeLike(aGuidOrInfo) {</span>
<a href="#l13.1941"></a><span id="l13.1941" class="difflineplus">+    let info = await PlacesUtils.bookmarks.fetch(aGuidOrInfo);</span>
<a href="#l13.1942"></a><span id="l13.1942" class="difflineplus">+    if (!info)</span>
<a href="#l13.1943"></a><span id="l13.1943" class="difflineplus">+      return null;</span>
<a href="#l13.1944"></a><span id="l13.1944" class="difflineplus">+    return this.promiseNodeLikeFromFetchInfo(info);</span>
<a href="#l13.1945"></a><span id="l13.1945">   }</span>
<a href="#l13.1946"></a><span id="l13.1946"> };</span>
<a href="#l13.1947"></a><span id="l13.1947"> </span>
<a href="#l13.1948"></a><span id="l13.1948" class="difflineminus">-XPCOMUtils.defineLazyServiceGetter(PlacesUIUtils, &quot;xulStore&quot;,</span>
<a href="#l13.1949"></a><span id="l13.1949" class="difflineminus">-                                   &quot;@mozilla.org/xul/xulstore;1&quot;,</span>
<a href="#l13.1950"></a><span id="l13.1950" class="difflineminus">-                                   &quot;nsIXULStore&quot;);</span>
<a href="#l13.1951"></a><span id="l13.1951" class="difflineplus">+</span>
<a href="#l13.1952"></a><span id="l13.1952" class="difflineplus">+PlacesUIUtils.PLACES_FLAVORS = [PlacesUtils.TYPE_X_MOZ_PLACE_CONTAINER,</span>
<a href="#l13.1953"></a><span id="l13.1953" class="difflineplus">+                                PlacesUtils.TYPE_X_MOZ_PLACE_SEPARATOR,</span>
<a href="#l13.1954"></a><span id="l13.1954" class="difflineplus">+                                PlacesUtils.TYPE_X_MOZ_PLACE];</span>
<a href="#l13.1955"></a><span id="l13.1955" class="difflineplus">+</span>
<a href="#l13.1956"></a><span id="l13.1956" class="difflineplus">+PlacesUIUtils.URI_FLAVORS = [PlacesUtils.TYPE_X_MOZ_URL,</span>
<a href="#l13.1957"></a><span id="l13.1957" class="difflineplus">+                             TAB_DROP_TYPE,</span>
<a href="#l13.1958"></a><span id="l13.1958" class="difflineplus">+                             PlacesUtils.TYPE_UNICODE],</span>
<a href="#l13.1959"></a><span id="l13.1959" class="difflineplus">+</span>
<a href="#l13.1960"></a><span id="l13.1960" class="difflineplus">+PlacesUIUtils.SUPPORTED_FLAVORS = [...PlacesUIUtils.PLACES_FLAVORS,</span>
<a href="#l13.1961"></a><span id="l13.1961" class="difflineplus">+                                   ...PlacesUIUtils.URI_FLAVORS];</span>
<a href="#l13.1962"></a><span id="l13.1962" class="difflineplus">+</span>
<a href="#l13.1963"></a><span id="l13.1963" class="difflineplus">+XPCOMUtils.defineLazyServiceGetter(PlacesUIUtils, &quot;RDF&quot;,</span>
<a href="#l13.1964"></a><span id="l13.1964" class="difflineplus">+                                   &quot;@mozilla.org/rdf/rdf-service;1&quot;,</span>
<a href="#l13.1965"></a><span id="l13.1965" class="difflineplus">+                                   &quot;nsIRDFService&quot;);</span>
<a href="#l13.1966"></a><span id="l13.1966"> </span>
<a href="#l13.1967"></a><span id="l13.1967"> XPCOMUtils.defineLazyGetter(PlacesUIUtils, &quot;ellipsis&quot;, function() {</span>
<a href="#l13.1968"></a><span id="l13.1968">   return Services.prefs.getComplexValue(&quot;intl.ellipsis&quot;,</span>
<a href="#l13.1969"></a><span id="l13.1969">                                         Ci.nsIPrefLocalizedString).data;</span>
<a href="#l13.1970"></a><span id="l13.1970"> });</span>
<a href="#l13.1971"></a><span id="l13.1971"> </span>
<a href="#l13.1972"></a><span id="l13.1972" class="difflineplus">+XPCOMUtils.defineLazyGetter(PlacesUIUtils, &quot;useAsyncTransactions&quot;, function() {</span>
<a href="#l13.1973"></a><span id="l13.1973" class="difflineplus">+  try {</span>
<a href="#l13.1974"></a><span id="l13.1974" class="difflineplus">+    return Services.prefs.getBoolPref(&quot;browser.places.useAsyncTransactions&quot;);</span>
<a href="#l13.1975"></a><span id="l13.1975" class="difflineplus">+  } catch (ex) { }</span>
<a href="#l13.1976"></a><span id="l13.1976" class="difflineplus">+  return false;</span>
<a href="#l13.1977"></a><span id="l13.1977" class="difflineplus">+});</span>
<a href="#l13.1978"></a><span id="l13.1978" class="difflineplus">+</span>
<a href="#l13.1979"></a><span id="l13.1979"> XPCOMUtils.defineLazyServiceGetter(this, &quot;URIFixup&quot;,</span>
<a href="#l13.1980"></a><span id="l13.1980">                                    &quot;@mozilla.org/docshell/urifixup;1&quot;,</span>
<a href="#l13.1981"></a><span id="l13.1981">                                    &quot;nsIURIFixup&quot;);</span>
<a href="#l13.1982"></a><span id="l13.1982"> </span>
<a href="#l13.1983"></a><span id="l13.1983"> XPCOMUtils.defineLazyGetter(this, &quot;bundle&quot;, function() {</span>
<a href="#l13.1984"></a><span id="l13.1984">   const PLACES_STRING_BUNDLE_URI =</span>
<a href="#l13.1985"></a><span id="l13.1985">     &quot;chrome://communicator/locale/places/places.properties&quot;;</span>
<a href="#l13.1986"></a><span id="l13.1986">   return Cc[&quot;@mozilla.org/intl/stringbundle;1&quot;]</span>
<a href="#l13.1987"></a><span id="l13.1987">            .getService(Ci.nsIStringBundleService)</span>
<a href="#l13.1988"></a><span id="l13.1988">            .createBundle(PLACES_STRING_BUNDLE_URI);</span>
<a href="#l13.1989"></a><span id="l13.1989"> });</span>
<a href="#l13.1990"></a><span id="l13.1990"> </span>
<a href="#l13.1991"></a><span id="l13.1991"> XPCOMUtils.defineLazyServiceGetter(this, &quot;focusManager&quot;,</span>
<a href="#l13.1992"></a><span id="l13.1992">                                    &quot;@mozilla.org/focus-manager;1&quot;,</span>
<a href="#l13.1993"></a><span id="l13.1993">                                    &quot;nsIFocusManager&quot;);</span>
<a href="#l13.1994"></a><span id="l13.1994" class="difflineminus">-</span>
<a href="#l13.1995"></a><span id="l13.1995"> /**</span>
<a href="#l13.1996"></a><span id="l13.1996">  * This is a compatibility shim for old PUIU.ptm users.</span>
<a href="#l13.1997"></a><span id="l13.1997">  *</span>
<a href="#l13.1998"></a><span id="l13.1998">  * If you're looking for transactions and writing new code using them, directly</span>
<a href="#l13.1999"></a><span id="l13.1999">  * use the transactions objects exported by the PlacesUtils.jsm module.</span>
<a href="#l13.2000"></a><span id="l13.2000">  *</span>
<a href="#l13.2001"></a><span id="l13.2001">  * This object will be removed once enough users are converted to the new API.</span>
<a href="#l13.2002"></a><span id="l13.2002">  */</span>
<a href="#l13.2003"></a><span id="l13.2003"> XPCOMUtils.defineLazyGetter(PlacesUIUtils, &quot;ptm&quot;, function() {</span>
<a href="#l13.2004"></a><span id="l13.2004">   // Ensure PlacesUtils is imported in scope.</span>
<a href="#l13.2005"></a><span id="l13.2005">   PlacesUtils;</span>
<a href="#l13.2006"></a><span id="l13.2006"> </span>
<a href="#l13.2007"></a><span id="l13.2007">   return {</span>
<a href="#l13.2008"></a><span id="l13.2008" class="difflineminus">-    aggregateTransactions: function(aName, aTransactions) {</span>
<a href="#l13.2009"></a><span id="l13.2009" class="difflineminus">-      return new PlacesAggregatedTransaction(aName, aTransactions);</span>
<a href="#l13.2010"></a><span id="l13.2010" class="difflineminus">-    },</span>
<a href="#l13.2011"></a><span id="l13.2011" class="difflineplus">+    aggregateTransactions: (aName, aTransactions) =&gt;</span>
<a href="#l13.2012"></a><span id="l13.2012" class="difflineplus">+      new PlacesAggregatedTransaction(aName, aTransactions),</span>
<a href="#l13.2013"></a><span id="l13.2013"> </span>
<a href="#l13.2014"></a><span id="l13.2014" class="difflineminus">-    createFolder: function(aName, aContainer, aIndex, aAnnotations,</span>
<a href="#l13.2015"></a><span id="l13.2015" class="difflineminus">-                           aChildItemsTransactions) {</span>
<a href="#l13.2016"></a><span id="l13.2016" class="difflineminus">-      return new PlacesCreateFolderTransaction(aName, aContainer, aIndex, aAnnotations,</span>
<a href="#l13.2017"></a><span id="l13.2017" class="difflineminus">-                                               aChildItemsTransactions);</span>
<a href="#l13.2018"></a><span id="l13.2018" class="difflineminus">-    },</span>
<a href="#l13.2019"></a><span id="l13.2019" class="difflineplus">+    createFolder: (aName, aContainer, aIndex, aAnnotations,</span>
<a href="#l13.2020"></a><span id="l13.2020" class="difflineplus">+                   aChildItemsTransactions) =&gt;</span>
<a href="#l13.2021"></a><span id="l13.2021" class="difflineplus">+      new PlacesCreateFolderTransaction(aName, aContainer, aIndex, aAnnotations,</span>
<a href="#l13.2022"></a><span id="l13.2022" class="difflineplus">+                                        aChildItemsTransactions),</span>
<a href="#l13.2023"></a><span id="l13.2023"> </span>
<a href="#l13.2024"></a><span id="l13.2024" class="difflineminus">-    createItem: function(aURI, aContainer, aIndex, aTitle, aKeyword,</span>
<a href="#l13.2025"></a><span id="l13.2025" class="difflineminus">-                         aAnnotations, aChildTransactions) {</span>
<a href="#l13.2026"></a><span id="l13.2026" class="difflineminus">-      return new PlacesCreateBookmarkTransaction(aURI, aContainer, aIndex, aTitle,</span>
<a href="#l13.2027"></a><span id="l13.2027" class="difflineminus">-                                                 aKeyword, aAnnotations,</span>
<a href="#l13.2028"></a><span id="l13.2028" class="difflineminus">-                                                 aChildTransactions);</span>
<a href="#l13.2029"></a><span id="l13.2029" class="difflineminus">-    },</span>
<a href="#l13.2030"></a><span id="l13.2030" class="difflineplus">+    createItem: (aURI, aContainer, aIndex, aTitle, aKeyword,</span>
<a href="#l13.2031"></a><span id="l13.2031" class="difflineplus">+                 aAnnotations, aChildTransactions) =&gt;</span>
<a href="#l13.2032"></a><span id="l13.2032" class="difflineplus">+      new PlacesCreateBookmarkTransaction(aURI, aContainer, aIndex, aTitle,</span>
<a href="#l13.2033"></a><span id="l13.2033" class="difflineplus">+                                          aKeyword, aAnnotations,</span>
<a href="#l13.2034"></a><span id="l13.2034" class="difflineplus">+                                          aChildTransactions),</span>
<a href="#l13.2035"></a><span id="l13.2035"> </span>
<a href="#l13.2036"></a><span id="l13.2036" class="difflineminus">-    createSeparator: function(aContainer, aIndex) {</span>
<a href="#l13.2037"></a><span id="l13.2037" class="difflineminus">-      return new PlacesCreateSeparatorTransaction(aContainer, aIndex);</span>
<a href="#l13.2038"></a><span id="l13.2038" class="difflineminus">-    },</span>
<a href="#l13.2039"></a><span id="l13.2039" class="difflineplus">+    createSeparator: (aContainer, aIndex) =&gt;</span>
<a href="#l13.2040"></a><span id="l13.2040" class="difflineplus">+      new PlacesCreateSeparatorTransaction(aContainer, aIndex),</span>
<a href="#l13.2041"></a><span id="l13.2041"> </span>
<a href="#l13.2042"></a><span id="l13.2042" class="difflineminus">-    createLivemark: function(aFeedURI, aSiteURI, aName, aContainer, aIndex,</span>
<a href="#l13.2043"></a><span id="l13.2043" class="difflineminus">-                             aAnnotations) {</span>
<a href="#l13.2044"></a><span id="l13.2044" class="difflineminus">-      return new PlacesCreateLivemarkTransaction(aFeedURI, aSiteURI, aName, aContainer,</span>
<a href="#l13.2045"></a><span id="l13.2045" class="difflineminus">-                                                 aIndex, aAnnotations);</span>
<a href="#l13.2046"></a><span id="l13.2046" class="difflineminus">-    },</span>
<a href="#l13.2047"></a><span id="l13.2047" class="difflineplus">+    createLivemark: (aFeedURI, aSiteURI, aName, aContainer, aIndex,</span>
<a href="#l13.2048"></a><span id="l13.2048" class="difflineplus">+                     aAnnotations) =&gt;</span>
<a href="#l13.2049"></a><span id="l13.2049" class="difflineplus">+      new PlacesCreateLivemarkTransaction(aFeedURI, aSiteURI, aName, aContainer,</span>
<a href="#l13.2050"></a><span id="l13.2050" class="difflineplus">+                                          aIndex, aAnnotations),</span>
<a href="#l13.2051"></a><span id="l13.2051"> </span>
<a href="#l13.2052"></a><span id="l13.2052" class="difflineminus">-    moveItem: function(aItemId, aNewContainer, aNewIndex) {</span>
<a href="#l13.2053"></a><span id="l13.2053" class="difflineminus">-      return new PlacesMoveItemTransaction(aItemId, aNewContainer, aNewIndex);</span>
<a href="#l13.2054"></a><span id="l13.2054" class="difflineminus">-    },</span>
<a href="#l13.2055"></a><span id="l13.2055" class="difflineplus">+    moveItem: (aItemId, aNewContainer, aNewIndex) =&gt;</span>
<a href="#l13.2056"></a><span id="l13.2056" class="difflineplus">+      new PlacesMoveItemTransaction(aItemId, aNewContainer, aNewIndex),</span>
<a href="#l13.2057"></a><span id="l13.2057" class="difflineplus">+</span>
<a href="#l13.2058"></a><span id="l13.2058" class="difflineplus">+    removeItem: (aItemId) =&gt;</span>
<a href="#l13.2059"></a><span id="l13.2059" class="difflineplus">+      new PlacesRemoveItemTransaction(aItemId),</span>
<a href="#l13.2060"></a><span id="l13.2060"> </span>
<a href="#l13.2061"></a><span id="l13.2061" class="difflineminus">-    removeItem: function(aItemId) {</span>
<a href="#l13.2062"></a><span id="l13.2062" class="difflineminus">-      return new PlacesRemoveItemTransaction(aItemId);</span>
<a href="#l13.2063"></a><span id="l13.2063" class="difflineminus">-    },</span>
<a href="#l13.2064"></a><span id="l13.2064" class="difflineplus">+    editItemTitle: (aItemId, aNewTitle) =&gt;</span>
<a href="#l13.2065"></a><span id="l13.2065" class="difflineplus">+      new PlacesEditItemTitleTransaction(aItemId, aNewTitle),</span>
<a href="#l13.2066"></a><span id="l13.2066" class="difflineplus">+</span>
<a href="#l13.2067"></a><span id="l13.2067" class="difflineplus">+    editBookmarkURI: (aItemId, aNewURI) =&gt;</span>
<a href="#l13.2068"></a><span id="l13.2068" class="difflineplus">+      new PlacesEditBookmarkURITransaction(aItemId, aNewURI),</span>
<a href="#l13.2069"></a><span id="l13.2069"> </span>
<a href="#l13.2070"></a><span id="l13.2070" class="difflineminus">-    editItemTitle: function(aItemId, aNewTitle) {</span>
<a href="#l13.2071"></a><span id="l13.2071" class="difflineminus">-      return new PlacesEditItemTitleTransaction(aItemId, aNewTitle);</span>
<a href="#l13.2072"></a><span id="l13.2072" class="difflineminus">-    },</span>
<a href="#l13.2073"></a><span id="l13.2073" class="difflineplus">+    setItemAnnotation: (aItemId, aAnnotationObject) =&gt;</span>
<a href="#l13.2074"></a><span id="l13.2074" class="difflineplus">+      new PlacesSetItemAnnotationTransaction(aItemId, aAnnotationObject),</span>
<a href="#l13.2075"></a><span id="l13.2075"> </span>
<a href="#l13.2076"></a><span id="l13.2076" class="difflineminus">-    editBookmarkURI: function(aItemId, aNewURI) {</span>
<a href="#l13.2077"></a><span id="l13.2077" class="difflineminus">-      return new PlacesEditBookmarkURITransaction(aItemId, aNewURI);</span>
<a href="#l13.2078"></a><span id="l13.2078" class="difflineminus">-    },</span>
<a href="#l13.2079"></a><span id="l13.2079" class="difflineplus">+    setPageAnnotation: (aURI, aAnnotationObject) =&gt;</span>
<a href="#l13.2080"></a><span id="l13.2080" class="difflineplus">+      new PlacesSetPageAnnotationTransaction(aURI, aAnnotationObject),</span>
<a href="#l13.2081"></a><span id="l13.2081"> </span>
<a href="#l13.2082"></a><span id="l13.2082" class="difflineminus">-    setItemAnnotation: function(aItemId, aAnnotationObject) {</span>
<a href="#l13.2083"></a><span id="l13.2083" class="difflineminus">-      return new PlacesSetItemAnnotationTransaction(aItemId, aAnnotationObject);</span>
<a href="#l13.2084"></a><span id="l13.2084" class="difflineminus">-    },</span>
<a href="#l13.2085"></a><span id="l13.2085" class="difflineplus">+    editBookmarkKeyword: (aItemId, aNewKeyword) =&gt;</span>
<a href="#l13.2086"></a><span id="l13.2086" class="difflineplus">+      new PlacesEditBookmarkKeywordTransaction(aItemId, aNewKeyword),</span>
<a href="#l13.2087"></a><span id="l13.2087"> </span>
<a href="#l13.2088"></a><span id="l13.2088" class="difflineminus">-    setPageAnnotation: function(aURI, aAnnotationObject) {</span>
<a href="#l13.2089"></a><span id="l13.2089" class="difflineminus">-      return new PlacesSetPageAnnotationTransaction(aURI, aAnnotationObject);</span>
<a href="#l13.2090"></a><span id="l13.2090" class="difflineminus">-    },</span>
<a href="#l13.2091"></a><span id="l13.2091" class="difflineplus">+    editLivemarkSiteURI: (aLivemarkId, aSiteURI) =&gt;</span>
<a href="#l13.2092"></a><span id="l13.2092" class="difflineplus">+      new PlacesEditLivemarkSiteURITransaction(aLivemarkId, aSiteURI),</span>
<a href="#l13.2093"></a><span id="l13.2093" class="difflineplus">+</span>
<a href="#l13.2094"></a><span id="l13.2094" class="difflineplus">+    editLivemarkFeedURI: (aLivemarkId, aFeedURI) =&gt;</span>
<a href="#l13.2095"></a><span id="l13.2095" class="difflineplus">+      new PlacesEditLivemarkFeedURITransaction(aLivemarkId, aFeedURI),</span>
<a href="#l13.2096"></a><span id="l13.2096"> </span>
<a href="#l13.2097"></a><span id="l13.2097" class="difflineminus">-    editBookmarkKeyword: function(aItemId, aNewKeyword) {</span>
<a href="#l13.2098"></a><span id="l13.2098" class="difflineminus">-      return new PlacesEditBookmarkKeywordTransaction(aItemId, aNewKeyword);</span>
<a href="#l13.2099"></a><span id="l13.2099" class="difflineminus">-    },</span>
<a href="#l13.2100"></a><span id="l13.2100" class="difflineplus">+    editItemDateAdded: (aItemId, aNewDateAdded) =&gt;</span>
<a href="#l13.2101"></a><span id="l13.2101" class="difflineplus">+      new PlacesEditItemDateAddedTransaction(aItemId, aNewDateAdded),</span>
<a href="#l13.2102"></a><span id="l13.2102"> </span>
<a href="#l13.2103"></a><span id="l13.2103" class="difflineminus">-    editBookmarkPostData: function(aItemId, aPostData) {</span>
<a href="#l13.2104"></a><span id="l13.2104" class="difflineminus">-      return new PlacesEditBookmarkPostDataTransaction(aItemId, aPostData);</span>
<a href="#l13.2105"></a><span id="l13.2105" class="difflineminus">-    },</span>
<a href="#l13.2106"></a><span id="l13.2106" class="difflineplus">+    editItemLastModified: (aItemId, aNewLastModified) =&gt;</span>
<a href="#l13.2107"></a><span id="l13.2107" class="difflineplus">+      new PlacesEditItemLastModifiedTransaction(aItemId, aNewLastModified),</span>
<a href="#l13.2108"></a><span id="l13.2108"> </span>
<a href="#l13.2109"></a><span id="l13.2109" class="difflineminus">-    editLivemarkSiteURI: function(aLivemarkId, aSiteURI) {</span>
<a href="#l13.2110"></a><span id="l13.2110" class="difflineminus">-      return new PlacesEditLivemarkSiteURITransaction(aLivemarkId, aSiteURI);</span>
<a href="#l13.2111"></a><span id="l13.2111" class="difflineminus">-    },</span>
<a href="#l13.2112"></a><span id="l13.2112" class="difflineplus">+    sortFolderByName: (aFolderId) =&gt;</span>
<a href="#l13.2113"></a><span id="l13.2113" class="difflineplus">+      new PlacesSortFolderByNameTransaction(aFolderId),</span>
<a href="#l13.2114"></a><span id="l13.2114"> </span>
<a href="#l13.2115"></a><span id="l13.2115" class="difflineminus">-    editLivemarkFeedURI: function(aLivemarkId, aFeedURI) {</span>
<a href="#l13.2116"></a><span id="l13.2116" class="difflineminus">-      return new PlacesEditLivemarkFeedURITransaction(aLivemarkId, aFeedURI);</span>
<a href="#l13.2117"></a><span id="l13.2117" class="difflineminus">-    },</span>
<a href="#l13.2118"></a><span id="l13.2118" class="difflineplus">+    tagURI: (aURI, aTags) =&gt;</span>
<a href="#l13.2119"></a><span id="l13.2119" class="difflineplus">+      new PlacesTagURITransaction(aURI, aTags),</span>
<a href="#l13.2120"></a><span id="l13.2120"> </span>
<a href="#l13.2121"></a><span id="l13.2121" class="difflineminus">-    editItemDateAdded: function(aItemId, aNewDateAdded) {</span>
<a href="#l13.2122"></a><span id="l13.2122" class="difflineminus">-      return new PlacesEditItemDateAddedTransaction(aItemId, aNewDateAdded);</span>
<a href="#l13.2123"></a><span id="l13.2123" class="difflineminus">-    },</span>
<a href="#l13.2124"></a><span id="l13.2124" class="difflineplus">+    untagURI: (aURI, aTags) =&gt;</span>
<a href="#l13.2125"></a><span id="l13.2125" class="difflineplus">+      new PlacesUntagURITransaction(aURI, aTags),</span>
<a href="#l13.2126"></a><span id="l13.2126"> </span>
<a href="#l13.2127"></a><span id="l13.2127" class="difflineminus">-    editItemLastModified: function(aItemId, aNewLastModified) {</span>
<a href="#l13.2128"></a><span id="l13.2128" class="difflineminus">-      return new PlacesEditItemLastModifiedTransaction(aItemId, aNewLastModified);</span>
<a href="#l13.2129"></a><span id="l13.2129" class="difflineminus">-    },</span>
<a href="#l13.2130"></a><span id="l13.2130" class="difflineminus">-</span>
<a href="#l13.2131"></a><span id="l13.2131" class="difflineminus">-    sortFolderByName: function(aFolderId) {</span>
<a href="#l13.2132"></a><span id="l13.2132" class="difflineminus">-      return new PlacesSortFolderByNameTransaction(aFolderId);</span>
<a href="#l13.2133"></a><span id="l13.2133" class="difflineminus">-    },</span>
<a href="#l13.2134"></a><span id="l13.2134" class="difflineminus">-</span>
<a href="#l13.2135"></a><span id="l13.2135" class="difflineminus">-    tagURI: function(aURI, aTags) {</span>
<a href="#l13.2136"></a><span id="l13.2136" class="difflineminus">-      return new PlacesTagURITransaction(aURI, aTags);</span>
<a href="#l13.2137"></a><span id="l13.2137" class="difflineminus">-    },</span>
<a href="#l13.2138"></a><span id="l13.2138" class="difflineminus">-</span>
<a href="#l13.2139"></a><span id="l13.2139" class="difflineminus">-    untagURI: function(aURI, aTags) {</span>
<a href="#l13.2140"></a><span id="l13.2140" class="difflineminus">-      return new PlacesUntagURITransaction(aURI, aTags);</span>
<a href="#l13.2141"></a><span id="l13.2141" class="difflineplus">+    /**</span>
<a href="#l13.2142"></a><span id="l13.2142" class="difflineplus">+     * Transaction for setting/unsetting Load-in-sidebar annotation.</span>
<a href="#l13.2143"></a><span id="l13.2143" class="difflineplus">+     *</span>
<a href="#l13.2144"></a><span id="l13.2144" class="difflineplus">+     * @param aBookmarkId</span>
<a href="#l13.2145"></a><span id="l13.2145" class="difflineplus">+     *        id of the bookmark where to set Load-in-sidebar annotation.</span>
<a href="#l13.2146"></a><span id="l13.2146" class="difflineplus">+     * @param aLoadInSidebar</span>
<a href="#l13.2147"></a><span id="l13.2147" class="difflineplus">+     *        boolean value.</span>
<a href="#l13.2148"></a><span id="l13.2148" class="difflineplus">+     * @return nsITransaction object.</span>
<a href="#l13.2149"></a><span id="l13.2149" class="difflineplus">+     */</span>
<a href="#l13.2150"></a><span id="l13.2150" class="difflineplus">+    setLoadInSidebar(aItemId, aLoadInSidebar) {</span>
<a href="#l13.2151"></a><span id="l13.2151" class="difflineplus">+      let annoObj = { name: PlacesUIUtils.LOAD_IN_SIDEBAR_ANNO,</span>
<a href="#l13.2152"></a><span id="l13.2152" class="difflineplus">+                      type: Ci.nsIAnnotationService.TYPE_INT32,</span>
<a href="#l13.2153"></a><span id="l13.2153" class="difflineplus">+                      flags: 0,</span>
<a href="#l13.2154"></a><span id="l13.2154" class="difflineplus">+                      value: aLoadInSidebar,</span>
<a href="#l13.2155"></a><span id="l13.2155" class="difflineplus">+                      expires: Ci.nsIAnnotationService.EXPIRE_NEVER };</span>
<a href="#l13.2156"></a><span id="l13.2156" class="difflineplus">+      return new PlacesSetItemAnnotationTransaction(aItemId, annoObj);</span>
<a href="#l13.2157"></a><span id="l13.2157">     },</span>
<a href="#l13.2158"></a><span id="l13.2158"> </span>
<a href="#l13.2159"></a><span id="l13.2159">    /**</span>
<a href="#l13.2160"></a><span id="l13.2160">     * Transaction for editing the description of a bookmark or a folder.</span>
<a href="#l13.2161"></a><span id="l13.2161">     *</span>
<a href="#l13.2162"></a><span id="l13.2162">     * @param aItemId</span>
<a href="#l13.2163"></a><span id="l13.2163">     *        id of the item to edit.</span>
<a href="#l13.2164"></a><span id="l13.2164">     * @param aDescription</span>
<a href="#l13.2165"></a><span id="l13.2165">     *        new description.</span>
<a href="#l13.2166"></a><span id="l13.2166" class="difflineminus">-    * @returns nsITransaction object.</span>
<a href="#l13.2167"></a><span id="l13.2167" class="difflineplus">+    * @return nsITransaction object.</span>
<a href="#l13.2168"></a><span id="l13.2168">     */</span>
<a href="#l13.2169"></a><span id="l13.2169" class="difflineminus">-    editItemDescription: function(aItemId, aDescription)</span>
<a href="#l13.2170"></a><span id="l13.2170" class="difflineminus">-    {</span>
<a href="#l13.2171"></a><span id="l13.2171" class="difflineplus">+    editItemDescription(aItemId, aDescription) {</span>
<a href="#l13.2172"></a><span id="l13.2172">       let annoObj = { name: PlacesUIUtils.DESCRIPTION_ANNO,</span>
<a href="#l13.2173"></a><span id="l13.2173">                       type: Ci.nsIAnnotationService.TYPE_STRING,</span>
<a href="#l13.2174"></a><span id="l13.2174">                       flags: 0,</span>
<a href="#l13.2175"></a><span id="l13.2175">                       value: aDescription,</span>
<a href="#l13.2176"></a><span id="l13.2176">                       expires: Ci.nsIAnnotationService.EXPIRE_NEVER };</span>
<a href="#l13.2177"></a><span id="l13.2177">       return new PlacesSetItemAnnotationTransaction(aItemId, annoObj);</span>
<a href="#l13.2178"></a><span id="l13.2178">     },</span>
<a href="#l13.2179"></a><span id="l13.2179"> </span>
<a href="#l13.2180"></a><span id="l13.2180" class="difflineminus">-    ////////////////////////////////////////////////////////////////////////////</span>
<a href="#l13.2181"></a><span id="l13.2181" class="difflineminus">-    //// nsITransactionManager forwarders.</span>
<a href="#l13.2182"></a><span id="l13.2182" class="difflineplus">+    // nsITransactionManager forwarders.</span>
<a href="#l13.2183"></a><span id="l13.2183"> </span>
<a href="#l13.2184"></a><span id="l13.2184" class="difflineminus">-    beginBatch: function() {</span>
<a href="#l13.2185"></a><span id="l13.2185" class="difflineminus">-      PlacesUtils.transactionManager.beginBatch(null);</span>
<a href="#l13.2186"></a><span id="l13.2186" class="difflineminus">-    },</span>
<a href="#l13.2187"></a><span id="l13.2187" class="difflineplus">+    beginBatch: () =&gt;</span>
<a href="#l13.2188"></a><span id="l13.2188" class="difflineplus">+      PlacesUtils.transactionManager.beginBatch(null),</span>
<a href="#l13.2189"></a><span id="l13.2189"> </span>
<a href="#l13.2190"></a><span id="l13.2190" class="difflineminus">-    endBatch: function() {</span>
<a href="#l13.2191"></a><span id="l13.2191" class="difflineminus">-      PlacesUtils.transactionManager.endBatch(false);</span>
<a href="#l13.2192"></a><span id="l13.2192" class="difflineminus">-    },</span>
<a href="#l13.2193"></a><span id="l13.2193" class="difflineplus">+    endBatch: () =&gt;</span>
<a href="#l13.2194"></a><span id="l13.2194" class="difflineplus">+      PlacesUtils.transactionManager.endBatch(false),</span>
<a href="#l13.2195"></a><span id="l13.2195"> </span>
<a href="#l13.2196"></a><span id="l13.2196" class="difflineminus">-    doTransaction: function(txn) {</span>
<a href="#l13.2197"></a><span id="l13.2197" class="difflineminus">-      PlacesUtils.transactionManager.doTransaction(txn);</span>
<a href="#l13.2198"></a><span id="l13.2198" class="difflineminus">-    },</span>
<a href="#l13.2199"></a><span id="l13.2199" class="difflineplus">+    doTransaction: (txn) =&gt;</span>
<a href="#l13.2200"></a><span id="l13.2200" class="difflineplus">+      PlacesUtils.transactionManager.doTransaction(txn),</span>
<a href="#l13.2201"></a><span id="l13.2201"> </span>
<a href="#l13.2202"></a><span id="l13.2202" class="difflineminus">-    undoTransaction: function() {</span>
<a href="#l13.2203"></a><span id="l13.2203" class="difflineminus">-      PlacesUtils.transactionManager.undoTransaction();</span>
<a href="#l13.2204"></a><span id="l13.2204" class="difflineminus">-    },</span>
<a href="#l13.2205"></a><span id="l13.2205" class="difflineplus">+    undoTransaction: () =&gt;</span>
<a href="#l13.2206"></a><span id="l13.2206" class="difflineplus">+      PlacesUtils.transactionManager.undoTransaction(),</span>
<a href="#l13.2207"></a><span id="l13.2207"> </span>
<a href="#l13.2208"></a><span id="l13.2208" class="difflineminus">-    redoTransaction: function() {</span>
<a href="#l13.2209"></a><span id="l13.2209" class="difflineminus">-      PlacesUtils.transactionManager.redoTransaction();</span>
<a href="#l13.2210"></a><span id="l13.2210" class="difflineminus">-    },</span>
<a href="#l13.2211"></a><span id="l13.2211" class="difflineplus">+    redoTransaction: () =&gt;</span>
<a href="#l13.2212"></a><span id="l13.2212" class="difflineplus">+      PlacesUtils.transactionManager.redoTransaction(),</span>
<a href="#l13.2213"></a><span id="l13.2213"> </span>
<a href="#l13.2214"></a><span id="l13.2214">     get numberOfUndoItems() {</span>
<a href="#l13.2215"></a><span id="l13.2215">       return PlacesUtils.transactionManager.numberOfUndoItems;</span>
<a href="#l13.2216"></a><span id="l13.2216">     },</span>
<a href="#l13.2217"></a><span id="l13.2217">     get numberOfRedoItems() {</span>
<a href="#l13.2218"></a><span id="l13.2218">       return PlacesUtils.transactionManager.numberOfRedoItems;</span>
<a href="#l13.2219"></a><span id="l13.2219">     },</span>
<a href="#l13.2220"></a><span id="l13.2220">     get maxTransactionCount() {</span>
<a href="#l13.2221"></a><span id="l13.2221">       return PlacesUtils.transactionManager.maxTransactionCount;</span>
<a href="#l13.2222"></a><span id="l13.2222">     },</span>
<a href="#l13.2223"></a><span id="l13.2223">     set maxTransactionCount(val) {</span>
<a href="#l13.2224"></a><span id="l13.2224" class="difflineminus">-      return PlacesUtils.transactionManager.maxTransactionCount = val;</span>
<a href="#l13.2225"></a><span id="l13.2225" class="difflineminus">-    },</span>
<a href="#l13.2226"></a><span id="l13.2226" class="difflineminus">-</span>
<a href="#l13.2227"></a><span id="l13.2227" class="difflineminus">-    clear: function() {</span>
<a href="#l13.2228"></a><span id="l13.2228" class="difflineminus">-      PlacesUtils.transactionManager.clear();</span>
<a href="#l13.2229"></a><span id="l13.2229" class="difflineminus">-    },</span>
<a href="#l13.2230"></a><span id="l13.2230" class="difflineminus">-</span>
<a href="#l13.2231"></a><span id="l13.2231" class="difflineminus">-    peekUndoStack: function() {</span>
<a href="#l13.2232"></a><span id="l13.2232" class="difflineminus">-      return PlacesUtils.transactionManager.peekUndoStack();</span>
<a href="#l13.2233"></a><span id="l13.2233" class="difflineminus">-    },</span>
<a href="#l13.2234"></a><span id="l13.2234" class="difflineminus">-</span>
<a href="#l13.2235"></a><span id="l13.2235" class="difflineminus">-    peekRedoStack: function() {</span>
<a href="#l13.2236"></a><span id="l13.2236" class="difflineminus">-      return PlacesUtils.transactionManager.peekRedoStack();</span>
<a href="#l13.2237"></a><span id="l13.2237" class="difflineminus">-    },</span>
<a href="#l13.2238"></a><span id="l13.2238" class="difflineminus">-</span>
<a href="#l13.2239"></a><span id="l13.2239" class="difflineminus">-    getUndoStack: function() {</span>
<a href="#l13.2240"></a><span id="l13.2240" class="difflineminus">-      return PlacesUtils.transactionManager.getUndoStack();</span>
<a href="#l13.2241"></a><span id="l13.2241" class="difflineplus">+      PlacesUtils.transactionManager.maxTransactionCount = val;</span>
<a href="#l13.2242"></a><span id="l13.2242">     },</span>
<a href="#l13.2243"></a><span id="l13.2243"> </span>
<a href="#l13.2244"></a><span id="l13.2244" class="difflineminus">-    getRedoStack: function() {</span>
<a href="#l13.2245"></a><span id="l13.2245" class="difflineminus">-      return PlacesUtils.transactionManager.getRedoStack();</span>
<a href="#l13.2246"></a><span id="l13.2246" class="difflineminus">-    },</span>
<a href="#l13.2247"></a><span id="l13.2247" class="difflineplus">+    clear: () =&gt;</span>
<a href="#l13.2248"></a><span id="l13.2248" class="difflineplus">+      PlacesUtils.transactionManager.clear(),</span>
<a href="#l13.2249"></a><span id="l13.2249" class="difflineplus">+</span>
<a href="#l13.2250"></a><span id="l13.2250" class="difflineplus">+    peekUndoStack: () =&gt;</span>
<a href="#l13.2251"></a><span id="l13.2251" class="difflineplus">+      PlacesUtils.transactionManager.peekUndoStack(),</span>
<a href="#l13.2252"></a><span id="l13.2252" class="difflineplus">+</span>
<a href="#l13.2253"></a><span id="l13.2253" class="difflineplus">+    peekRedoStack: () =&gt;</span>
<a href="#l13.2254"></a><span id="l13.2254" class="difflineplus">+      PlacesUtils.transactionManager.peekRedoStack(),</span>
<a href="#l13.2255"></a><span id="l13.2255"> </span>
<a href="#l13.2256"></a><span id="l13.2256" class="difflineminus">-    AddListener: function(aListener) {</span>
<a href="#l13.2257"></a><span id="l13.2257" class="difflineminus">-      PlacesUtils.transactionManager.AddListener(aListener);</span>
<a href="#l13.2258"></a><span id="l13.2258" class="difflineminus">-    },</span>
<a href="#l13.2259"></a><span id="l13.2259" class="difflineplus">+    getUndoStack: () =&gt;</span>
<a href="#l13.2260"></a><span id="l13.2260" class="difflineplus">+      PlacesUtils.transactionManager.getUndoStack(),</span>
<a href="#l13.2261"></a><span id="l13.2261" class="difflineplus">+</span>
<a href="#l13.2262"></a><span id="l13.2262" class="difflineplus">+    getRedoStack: () =&gt;</span>
<a href="#l13.2263"></a><span id="l13.2263" class="difflineplus">+      PlacesUtils.transactionManager.getRedoStack(),</span>
<a href="#l13.2264"></a><span id="l13.2264"> </span>
<a href="#l13.2265"></a><span id="l13.2265" class="difflineminus">-    RemoveListener: function(aListener) {</span>
<a href="#l13.2266"></a><span id="l13.2266" class="difflineminus">-      PlacesUtils.transactionManager.RemoveListener(aListener);</span>
<a href="#l13.2267"></a><span id="l13.2267" class="difflineminus">-    }</span>
<a href="#l13.2268"></a><span id="l13.2268" class="difflineplus">+    AddListener: (aListener) =&gt;</span>
<a href="#l13.2269"></a><span id="l13.2269" class="difflineplus">+      PlacesUtils.transactionManager.AddListener(aListener),</span>
<a href="#l13.2270"></a><span id="l13.2270" class="difflineplus">+</span>
<a href="#l13.2271"></a><span id="l13.2271" class="difflineplus">+    RemoveListener: (aListener) =&gt;</span>
<a href="#l13.2272"></a><span id="l13.2272" class="difflineplus">+      PlacesUtils.transactionManager.RemoveListener(aListener)</span>
<a href="#l13.2273"></a><span id="l13.2273">   }</span>
<a href="#l13.2274"></a><span id="l13.2274"> });</span>
<a href="#l13.2275"></a><span id="l13.2275" class="difflineminus">-</span>
<a href="#l13.2276"></a><span id="l13.2276" class="difflineminus">-XPCOMUtils.defineLazyGetter(PlacesUIUtils, &quot;_copyableAnnotations&quot;, function() {</span>
<a href="#l13.2277"></a><span id="l13.2277" class="difflineminus">-  return [this.DESCRIPTION_ANNO,</span>
<a href="#l13.2278"></a><span id="l13.2278" class="difflineminus">-          this.LOAD_IN_SIDEBAR_ANNO,</span>
<a href="#l13.2279"></a><span id="l13.2279" class="difflineminus">-          PlacesUtils.POST_DATA_ANNO,</span>
<a href="#l13.2280"></a><span id="l13.2280" class="difflineminus">-          PlacesUtils.READ_ONLY_ANNO]</span>
<a href="#l13.2281"></a><span id="l13.2281" class="difflineminus">-});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/suite/common/places/content/bookmarkProperties.js</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/suite/common/places/content/bookmarkProperties.js</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -1,26 +1,25 @@</span>
<a href="#l14.4"></a><span id="l14.4" class="difflineminus">-/* -*- Mode: C++; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l14.5"></a><span id="l14.5" class="difflineplus">+/* -*- indent-tabs-mode: nil; js-indent-level: 2 -*- */</span>
<a href="#l14.6"></a><span id="l14.6"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l14.7"></a><span id="l14.7">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l14.8"></a><span id="l14.8">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l14.9"></a><span id="l14.9"> </span>
<a href="#l14.10"></a><span id="l14.10"> /**</span>
<a href="#l14.11"></a><span id="l14.11">  * The panel is initialized based on data given in the js object passed</span>
<a href="#l14.12"></a><span id="l14.12">  * as window.arguments[0]. The object must have the following fields set:</span>
<a href="#l14.13"></a><span id="l14.13">  *   @ action (String). Possible values:</span>
<a href="#l14.14"></a><span id="l14.14">  *     - &quot;add&quot; - for adding a new item.</span>
<a href="#l14.15"></a><span id="l14.15">  *       @ type (String). Possible values:</span>
<a href="#l14.16"></a><span id="l14.16">  *         - &quot;bookmark&quot;</span>
<a href="#l14.17"></a><span id="l14.17">  *           @ loadBookmarkInSidebar - optional, the default state for the</span>
<a href="#l14.18"></a><span id="l14.18">  *             &quot;Load this bookmark in the sidebar&quot; field.</span>
<a href="#l14.19"></a><span id="l14.19">  *         - &quot;folder&quot;</span>
<a href="#l14.20"></a><span id="l14.20">  *           @ URIList (Array of nsIURI objects) - optional, list of uris to</span>
<a href="#l14.21"></a><span id="l14.21">  *             be bookmarked under the new folder.</span>
<a href="#l14.22"></a><span id="l14.22" class="difflineminus">- *           @ titleList (Array of String) - optional, list of titles.</span>
<a href="#l14.23"></a><span id="l14.23">  *         - &quot;livemark&quot;</span>
<a href="#l14.24"></a><span id="l14.24">  *       @ uri (nsIURI object) - optional, the default uri for the new item.</span>
<a href="#l14.25"></a><span id="l14.25">  *         The property is not used for the &quot;folder with items&quot; type.</span>
<a href="#l14.26"></a><span id="l14.26">  *       @ title (String) - optional, the default title for the new item.</span>
<a href="#l14.27"></a><span id="l14.27">  *       @ description (String) - optional, the default description for the new</span>
<a href="#l14.28"></a><span id="l14.28">  *         item.</span>
<a href="#l14.29"></a><span id="l14.29">  *       @ defaultInsertionPoint (InsertionPoint JS object) - optional, the</span>
<a href="#l14.30"></a><span id="l14.30">  *         default insertion point for the new item.</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineat">@@ -33,36 +32,44 @@</span>
<a href="#l14.32"></a><span id="l14.32">  *           with the given uri. If the dialog is set to adding a folder with</span>
<a href="#l14.33"></a><span id="l14.33">  *           bookmark items under it (see URIList), a default static title is</span>
<a href="#l14.34"></a><span id="l14.34">  *           used (&quot;[Folder Name]&quot;).</span>
<a href="#l14.35"></a><span id="l14.35">  *        2) The index field of the default insertion point is ignored if</span>
<a href="#l14.36"></a><span id="l14.36">  *           the folder picker is shown.</span>
<a href="#l14.37"></a><span id="l14.37">  *     - &quot;edit&quot; - for editing a bookmark item or a folder.</span>
<a href="#l14.38"></a><span id="l14.38">  *       @ type (String). Possible values:</span>
<a href="#l14.39"></a><span id="l14.39">  *         - &quot;bookmark&quot;</span>
<a href="#l14.40"></a><span id="l14.40" class="difflineminus">- *           @ itemId (Integer) - the id of the bookmark item.</span>
<a href="#l14.41"></a><span id="l14.41" class="difflineplus">+ *           @ node (an nsINavHistoryResultNode object) - a node representing</span>
<a href="#l14.42"></a><span id="l14.42" class="difflineplus">+ *             the bookmark.</span>
<a href="#l14.43"></a><span id="l14.43">  *         - &quot;folder&quot; (also applies to livemarks)</span>
<a href="#l14.44"></a><span id="l14.44" class="difflineminus">- *           @ itemId (Integer) - the id of the folder.</span>
<a href="#l14.45"></a><span id="l14.45" class="difflineplus">+ *           @ node (an nsINavHistoryResultNode object) - a node representing</span>
<a href="#l14.46"></a><span id="l14.46" class="difflineplus">+ *             the folder.</span>
<a href="#l14.47"></a><span id="l14.47">  *   @ hiddenRows (Strings array) - optional, list of rows to be hidden</span>
<a href="#l14.48"></a><span id="l14.48">  *     regardless of the item edited or added by the dialog.</span>
<a href="#l14.49"></a><span id="l14.49">  *     Possible values:</span>
<a href="#l14.50"></a><span id="l14.50">  *     - &quot;title&quot;</span>
<a href="#l14.51"></a><span id="l14.51">  *     - &quot;location&quot;</span>
<a href="#l14.52"></a><span id="l14.52">  *     - &quot;description&quot;</span>
<a href="#l14.53"></a><span id="l14.53">  *     - &quot;keyword&quot;</span>
<a href="#l14.54"></a><span id="l14.54">  *     - &quot;tags&quot;</span>
<a href="#l14.55"></a><span id="l14.55" class="difflineminus">- *     - &quot;feedLocation&quot;</span>
<a href="#l14.56"></a><span id="l14.56" class="difflineminus">- *     - &quot;siteLocation&quot;</span>
<a href="#l14.57"></a><span id="l14.57" class="difflineplus">+ *     - &quot;loadInSidebar&quot;</span>
<a href="#l14.58"></a><span id="l14.58">  *     - &quot;folderPicker&quot; - hides both the tree and the menu.</span>
<a href="#l14.59"></a><span id="l14.59" class="difflineminus">- *   @ readOnly (Boolean) - optional, states if the panel should be read-only</span>
<a href="#l14.60"></a><span id="l14.60">  *</span>
<a href="#l14.61"></a><span id="l14.61">  * window.arguments[0].performed is set to true if any transaction has</span>
<a href="#l14.62"></a><span id="l14.62">  * been performed by the dialog.</span>
<a href="#l14.63"></a><span id="l14.63">  */</span>
<a href="#l14.64"></a><span id="l14.64"> </span>
<a href="#l14.65"></a><span id="l14.65" class="difflineplus">+/* import-globals-from editBookmarkOverlay.js */</span>
<a href="#l14.66"></a><span id="l14.66" class="difflineplus">+</span>
<a href="#l14.67"></a><span id="l14.67" class="difflineplus">+ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l14.68"></a><span id="l14.68" class="difflineplus">+ChromeUtils.defineModuleGetter(this, &quot;PrivateBrowsingUtils&quot;,</span>
<a href="#l14.69"></a><span id="l14.69" class="difflineplus">+                               &quot;resource://gre/modules/PrivateBrowsingUtils.jsm&quot;);</span>
<a href="#l14.70"></a><span id="l14.70" class="difflineplus">+ChromeUtils.defineModuleGetter(this, &quot;PromiseUtils&quot;,</span>
<a href="#l14.71"></a><span id="l14.71" class="difflineplus">+                               &quot;resource://gre/modules/PromiseUtils.jsm&quot;);</span>
<a href="#l14.72"></a><span id="l14.72" class="difflineplus">+</span>
<a href="#l14.73"></a><span id="l14.73"> const BOOKMARK_ITEM = 0;</span>
<a href="#l14.74"></a><span id="l14.74"> const BOOKMARK_FOLDER = 1;</span>
<a href="#l14.75"></a><span id="l14.75"> const LIVEMARK_CONTAINER = 2;</span>
<a href="#l14.76"></a><span id="l14.76"> </span>
<a href="#l14.77"></a><span id="l14.77"> const ACTION_EDIT = 0;</span>
<a href="#l14.78"></a><span id="l14.78"> const ACTION_ADD = 1;</span>
<a href="#l14.79"></a><span id="l14.79"> </span>
<a href="#l14.80"></a><span id="l14.80"> var elementsHeight = new Map();</span>
<a href="#l14.81"></a><span id="l14.81" class="difflineat">@@ -77,44 +84,43 @@ var BookmarkPropertiesPanel = {</span>
<a href="#l14.82"></a><span id="l14.82">     }</span>
<a href="#l14.83"></a><span id="l14.83">     return this.__strings;</span>
<a href="#l14.84"></a><span id="l14.84">   },</span>
<a href="#l14.85"></a><span id="l14.85"> </span>
<a href="#l14.86"></a><span id="l14.86">   _action: null,</span>
<a href="#l14.87"></a><span id="l14.87">   _itemType: null,</span>
<a href="#l14.88"></a><span id="l14.88">   _itemId: -1,</span>
<a href="#l14.89"></a><span id="l14.89">   _uri: null,</span>
<a href="#l14.90"></a><span id="l14.90" class="difflineplus">+  _loadInSidebar: false,</span>
<a href="#l14.91"></a><span id="l14.91">   _title: &quot;&quot;,</span>
<a href="#l14.92"></a><span id="l14.92">   _description: &quot;&quot;,</span>
<a href="#l14.93"></a><span id="l14.93">   _URIs: [],</span>
<a href="#l14.94"></a><span id="l14.94" class="difflineminus">-  _titles: [],</span>
<a href="#l14.95"></a><span id="l14.95">   _keyword: &quot;&quot;,</span>
<a href="#l14.96"></a><span id="l14.96">   _postData: null,</span>
<a href="#l14.97"></a><span id="l14.97">   _charSet: &quot;&quot;,</span>
<a href="#l14.98"></a><span id="l14.98">   _feedURI: null,</span>
<a href="#l14.99"></a><span id="l14.99">   _siteURI: null,</span>
<a href="#l14.100"></a><span id="l14.100"> </span>
<a href="#l14.101"></a><span id="l14.101">   _defaultInsertionPoint: null,</span>
<a href="#l14.102"></a><span id="l14.102">   _hiddenRows: [],</span>
<a href="#l14.103"></a><span id="l14.103">   _batching: false,</span>
<a href="#l14.104"></a><span id="l14.104" class="difflineminus">-  _readOnly: false,</span>
<a href="#l14.105"></a><span id="l14.105"> </span>
<a href="#l14.106"></a><span id="l14.106">   /**</span>
<a href="#l14.107"></a><span id="l14.107">    * This method returns the correct label for the dialog's &quot;accept&quot;</span>
<a href="#l14.108"></a><span id="l14.108">    * button based on the variant of the dialog.</span>
<a href="#l14.109"></a><span id="l14.109">    */</span>
<a href="#l14.110"></a><span id="l14.110">   _getAcceptLabel: function BPP__getAcceptLabel() {</span>
<a href="#l14.111"></a><span id="l14.111">     if (this._action == ACTION_ADD) {</span>
<a href="#l14.112"></a><span id="l14.112">       if (this._URIs.length)</span>
<a href="#l14.113"></a><span id="l14.113">         return this._strings.getString(&quot;dialogAcceptLabelAddMulti&quot;);</span>
<a href="#l14.114"></a><span id="l14.114"> </span>
<a href="#l14.115"></a><span id="l14.115">       if (this._itemType == LIVEMARK_CONTAINER)</span>
<a href="#l14.116"></a><span id="l14.116">         return this._strings.getString(&quot;dialogAcceptLabelAddLivemark&quot;);</span>
<a href="#l14.117"></a><span id="l14.117"> </span>
<a href="#l14.118"></a><span id="l14.118" class="difflineminus">-      if (this._dummyItem)</span>
<a href="#l14.119"></a><span id="l14.119" class="difflineplus">+      if (this._dummyItem || this._loadInSidebar)</span>
<a href="#l14.120"></a><span id="l14.120">         return this._strings.getString(&quot;dialogAcceptLabelAddItem&quot;);</span>
<a href="#l14.121"></a><span id="l14.121"> </span>
<a href="#l14.122"></a><span id="l14.122">       return this._strings.getString(&quot;dialogAcceptLabelSaveItem&quot;);</span>
<a href="#l14.123"></a><span id="l14.123">     }</span>
<a href="#l14.124"></a><span id="l14.124">     return this._strings.getString(&quot;dialogAcceptLabelEdit&quot;);</span>
<a href="#l14.125"></a><span id="l14.125">   },</span>
<a href="#l14.126"></a><span id="l14.126"> </span>
<a href="#l14.127"></a><span id="l14.127">   /**</span>
<a href="#l14.128"></a><span id="l14.128" class="difflineat">@@ -139,137 +145,102 @@ var BookmarkPropertiesPanel = {</span>
<a href="#l14.129"></a><span id="l14.129">       return this._strings.getFormattedString(&quot;dialogTitleEdit&quot;, [this._title]);</span>
<a href="#l14.130"></a><span id="l14.130">     }</span>
<a href="#l14.131"></a><span id="l14.131">     return &quot;&quot;;</span>
<a href="#l14.132"></a><span id="l14.132">   },</span>
<a href="#l14.133"></a><span id="l14.133"> </span>
<a href="#l14.134"></a><span id="l14.134">   /**</span>
<a href="#l14.135"></a><span id="l14.135">    * Determines the initial data for the item edited or added by this dialog</span>
<a href="#l14.136"></a><span id="l14.136">    */</span>
<a href="#l14.137"></a><span id="l14.137" class="difflineminus">-  _determineItemInfo: function BPP__determineItemInfo() {</span>
<a href="#l14.138"></a><span id="l14.138" class="difflineminus">-    var dialogInfo = window.arguments[0];</span>
<a href="#l14.139"></a><span id="l14.139" class="difflineplus">+  _determineItemInfo() {</span>
<a href="#l14.140"></a><span id="l14.140" class="difflineplus">+    let dialogInfo = window.arguments[0];</span>
<a href="#l14.141"></a><span id="l14.141">     this._action = dialogInfo.action == &quot;add&quot; ? ACTION_ADD : ACTION_EDIT;</span>
<a href="#l14.142"></a><span id="l14.142">     this._hiddenRows = dialogInfo.hiddenRows ? dialogInfo.hiddenRows : [];</span>
<a href="#l14.143"></a><span id="l14.143">     if (this._action == ACTION_ADD) {</span>
<a href="#l14.144"></a><span id="l14.144">       NS_ASSERT(&quot;type&quot; in dialogInfo, &quot;missing type property for add action&quot;);</span>
<a href="#l14.145"></a><span id="l14.145"> </span>
<a href="#l14.146"></a><span id="l14.146">       if (&quot;title&quot; in dialogInfo)</span>
<a href="#l14.147"></a><span id="l14.147">         this._title = dialogInfo.title;</span>
<a href="#l14.148"></a><span id="l14.148"> </span>
<a href="#l14.149"></a><span id="l14.149">       if (&quot;defaultInsertionPoint&quot; in dialogInfo) {</span>
<a href="#l14.150"></a><span id="l14.150">         this._defaultInsertionPoint = dialogInfo.defaultInsertionPoint;</span>
<a href="#l14.151"></a><span id="l14.151" class="difflineminus">-      }</span>
<a href="#l14.152"></a><span id="l14.152" class="difflineminus">-      else</span>
<a href="#l14.153"></a><span id="l14.153" class="difflineplus">+      } else {</span>
<a href="#l14.154"></a><span id="l14.154">         this._defaultInsertionPoint =</span>
<a href="#l14.155"></a><span id="l14.155">           new InsertionPoint(PlacesUtils.bookmarksMenuFolderId,</span>
<a href="#l14.156"></a><span id="l14.156">                              PlacesUtils.bookmarks.DEFAULT_INDEX,</span>
<a href="#l14.157"></a><span id="l14.157">                              Ci.nsITreeView.DROP_ON);</span>
<a href="#l14.158"></a><span id="l14.158" class="difflineplus">+      }</span>
<a href="#l14.159"></a><span id="l14.159"> </span>
<a href="#l14.160"></a><span id="l14.160">       switch (dialogInfo.type) {</span>
<a href="#l14.161"></a><span id="l14.161">         case &quot;bookmark&quot;:</span>
<a href="#l14.162"></a><span id="l14.162">           this._itemType = BOOKMARK_ITEM;</span>
<a href="#l14.163"></a><span id="l14.163">           if (&quot;uri&quot; in dialogInfo) {</span>
<a href="#l14.164"></a><span id="l14.164">             NS_ASSERT(dialogInfo.uri instanceof Ci.nsIURI,</span>
<a href="#l14.165"></a><span id="l14.165">                       &quot;uri property should be a uri object&quot;);</span>
<a href="#l14.166"></a><span id="l14.166">             this._uri = dialogInfo.uri;</span>
<a href="#l14.167"></a><span id="l14.167">             if (typeof(this._title) != &quot;string&quot;) {</span>
<a href="#l14.168"></a><span id="l14.168">               this._title = this._getURITitleFromHistory(this._uri) ||</span>
<a href="#l14.169"></a><span id="l14.169">                             this._uri.spec;</span>
<a href="#l14.170"></a><span id="l14.170">             }</span>
<a href="#l14.171"></a><span id="l14.171" class="difflineminus">-          }</span>
<a href="#l14.172"></a><span id="l14.172" class="difflineminus">-          else {</span>
<a href="#l14.173"></a><span id="l14.173" class="difflineplus">+          } else {</span>
<a href="#l14.174"></a><span id="l14.174">             this._uri = PlacesUtils._uri(&quot;about:blank&quot;);</span>
<a href="#l14.175"></a><span id="l14.175">             this._title = this._strings.getString(&quot;newBookmarkDefault&quot;);</span>
<a href="#l14.176"></a><span id="l14.176">             this._dummyItem = true;</span>
<a href="#l14.177"></a><span id="l14.177">           }</span>
<a href="#l14.178"></a><span id="l14.178"> </span>
<a href="#l14.179"></a><span id="l14.179" class="difflineplus">+          if (&quot;loadBookmarkInSidebar&quot; in dialogInfo)</span>
<a href="#l14.180"></a><span id="l14.180" class="difflineplus">+            this._loadInSidebar = dialogInfo.loadBookmarkInSidebar;</span>
<a href="#l14.181"></a><span id="l14.181" class="difflineplus">+</span>
<a href="#l14.182"></a><span id="l14.182">           if (&quot;keyword&quot; in dialogInfo) {</span>
<a href="#l14.183"></a><span id="l14.183">             this._keyword = dialogInfo.keyword;</span>
<a href="#l14.184"></a><span id="l14.184">             this._isAddKeywordDialog = true;</span>
<a href="#l14.185"></a><span id="l14.185">             if (&quot;postData&quot; in dialogInfo)</span>
<a href="#l14.186"></a><span id="l14.186">               this._postData = dialogInfo.postData;</span>
<a href="#l14.187"></a><span id="l14.187">             if (&quot;charSet&quot; in dialogInfo)</span>
<a href="#l14.188"></a><span id="l14.188">               this._charSet = dialogInfo.charSet;</span>
<a href="#l14.189"></a><span id="l14.189">           }</span>
<a href="#l14.190"></a><span id="l14.190">           break;</span>
<a href="#l14.191"></a><span id="l14.191"> </span>
<a href="#l14.192"></a><span id="l14.192">         case &quot;folder&quot;:</span>
<a href="#l14.193"></a><span id="l14.193">           this._itemType = BOOKMARK_FOLDER;</span>
<a href="#l14.194"></a><span id="l14.194">           if (!this._title) {</span>
<a href="#l14.195"></a><span id="l14.195">             if (&quot;URIList&quot; in dialogInfo) {</span>
<a href="#l14.196"></a><span id="l14.196">               this._title = this._strings.getString(&quot;bookmarkAllTabsDefault&quot;);</span>
<a href="#l14.197"></a><span id="l14.197">               this._URIs = dialogInfo.URIList;</span>
<a href="#l14.198"></a><span id="l14.198" class="difflineminus">-              if (&quot;titleList&quot; in dialogInfo)</span>
<a href="#l14.199"></a><span id="l14.199" class="difflineminus">-                this._titles = dialogInfo.titleList;</span>
<a href="#l14.200"></a><span id="l14.200" class="difflineminus">-            }</span>
<a href="#l14.201"></a><span id="l14.201" class="difflineminus">-            else</span>
<a href="#l14.202"></a><span id="l14.202" class="difflineplus">+            } else</span>
<a href="#l14.203"></a><span id="l14.203">               this._title = this._strings.getString(&quot;newFolderDefault&quot;);</span>
<a href="#l14.204"></a><span id="l14.204" class="difflineminus">-              this._dummyItem = true;</span>
<a href="#l14.205"></a><span id="l14.205" class="difflineplus">+            this._dummyItem = true;</span>
<a href="#l14.206"></a><span id="l14.206">           }</span>
<a href="#l14.207"></a><span id="l14.207">           break;</span>
<a href="#l14.208"></a><span id="l14.208"> </span>
<a href="#l14.209"></a><span id="l14.209">         case &quot;livemark&quot;:</span>
<a href="#l14.210"></a><span id="l14.210">           this._itemType = LIVEMARK_CONTAINER;</span>
<a href="#l14.211"></a><span id="l14.211">           if (&quot;feedURI&quot; in dialogInfo)</span>
<a href="#l14.212"></a><span id="l14.212">             this._feedURI = dialogInfo.feedURI;</span>
<a href="#l14.213"></a><span id="l14.213">           if (&quot;siteURI&quot; in dialogInfo)</span>
<a href="#l14.214"></a><span id="l14.214">             this._siteURI = dialogInfo.siteURI;</span>
<a href="#l14.215"></a><span id="l14.215"> </span>
<a href="#l14.216"></a><span id="l14.216">           if (!this._title) {</span>
<a href="#l14.217"></a><span id="l14.217">             if (this._feedURI) {</span>
<a href="#l14.218"></a><span id="l14.218">               this._title = this._getURITitleFromHistory(this._feedURI) ||</span>
<a href="#l14.219"></a><span id="l14.219">                             this._feedURI.spec;</span>
<a href="#l14.220"></a><span id="l14.220" class="difflineminus">-            }</span>
<a href="#l14.221"></a><span id="l14.221" class="difflineminus">-            else</span>
<a href="#l14.222"></a><span id="l14.222" class="difflineplus">+            } else</span>
<a href="#l14.223"></a><span id="l14.223">               this._title = this._strings.getString(&quot;newLivemarkDefault&quot;);</span>
<a href="#l14.224"></a><span id="l14.224">           }</span>
<a href="#l14.225"></a><span id="l14.225">       }</span>
<a href="#l14.226"></a><span id="l14.226"> </span>
<a href="#l14.227"></a><span id="l14.227">       if (&quot;description&quot; in dialogInfo)</span>
<a href="#l14.228"></a><span id="l14.228">         this._description = dialogInfo.description;</span>
<a href="#l14.229"></a><span id="l14.229" class="difflineminus">-    }</span>
<a href="#l14.230"></a><span id="l14.230" class="difflineminus">-    else { // edit</span>
<a href="#l14.231"></a><span id="l14.231" class="difflineminus">-      NS_ASSERT(&quot;itemId&quot; in dialogInfo);</span>
<a href="#l14.232"></a><span id="l14.232" class="difflineminus">-      this._itemId = dialogInfo.itemId;</span>
<a href="#l14.233"></a><span id="l14.233" class="difflineminus">-      this._title = PlacesUtils.bookmarks.getItemTitle(this._itemId);</span>
<a href="#l14.234"></a><span id="l14.234" class="difflineminus">-      // Don't show folderPicker when editing</span>
<a href="#l14.235"></a><span id="l14.235" class="difflineminus">-      this._hiddenRows.push(&quot;folderPicker&quot;);</span>
<a href="#l14.236"></a><span id="l14.236" class="difflineminus">-      this._readOnly = !!dialogInfo.readOnly;</span>
<a href="#l14.237"></a><span id="l14.237" class="difflineminus">-</span>
<a href="#l14.238"></a><span id="l14.238" class="difflineminus">-      switch (dialogInfo.type) {</span>
<a href="#l14.239"></a><span id="l14.239" class="difflineminus">-        case &quot;bookmark&quot;:</span>
<a href="#l14.240"></a><span id="l14.240" class="difflineminus">-          this._itemType = BOOKMARK_ITEM;</span>
<a href="#l14.241"></a><span id="l14.241" class="difflineminus">-</span>
<a href="#l14.242"></a><span id="l14.242" class="difflineminus">-          this._uri = PlacesUtils.bookmarks.getBookmarkURI(this._itemId);</span>
<a href="#l14.243"></a><span id="l14.243" class="difflineminus">-          // keyword</span>
<a href="#l14.244"></a><span id="l14.244" class="difflineminus">-          this._keyword = PlacesUtils.bookmarks</span>
<a href="#l14.245"></a><span id="l14.245" class="difflineminus">-                                     .getKeywordForBookmark(this._itemId);</span>
<a href="#l14.246"></a><span id="l14.246" class="difflineminus">-          break;</span>
<a href="#l14.247"></a><span id="l14.247" class="difflineminus">-</span>
<a href="#l14.248"></a><span id="l14.248" class="difflineminus">-        case &quot;folder&quot;:</span>
<a href="#l14.249"></a><span id="l14.249" class="difflineminus">-          this._itemType = BOOKMARK_FOLDER;</span>
<a href="#l14.250"></a><span id="l14.250" class="difflineminus">-          PlacesUtils.livemarks.getLivemark({ id: this._itemId })</span>
<a href="#l14.251"></a><span id="l14.251" class="difflineminus">-                               .then(aLivemark =&gt; {</span>
<a href="#l14.252"></a><span id="l14.252" class="difflineminus">-            this._itemType = LIVEMARK_CONTAINER;</span>
<a href="#l14.253"></a><span id="l14.253" class="difflineminus">-            this._feedURI = aLivemark.feedURI;</span>
<a href="#l14.254"></a><span id="l14.254" class="difflineminus">-            this._siteURI = aLivemark.siteURI;</span>
<a href="#l14.255"></a><span id="l14.255" class="difflineminus">-            this._fillEditProperties();</span>
<a href="#l14.256"></a><span id="l14.256" class="difflineminus">-</span>
<a href="#l14.257"></a><span id="l14.257" class="difflineminus">-            document.documentElement</span>
<a href="#l14.258"></a><span id="l14.258" class="difflineminus">-                    .getButton(&quot;accept&quot;).disabled = !this._inputIsValid();</span>
<a href="#l14.259"></a><span id="l14.259" class="difflineminus">-          }, () =&gt; undefined);</span>
<a href="#l14.260"></a><span id="l14.260" class="difflineminus">-      }</span>
<a href="#l14.261"></a><span id="l14.261" class="difflineminus">-</span>
<a href="#l14.262"></a><span id="l14.262" class="difflineminus">-      // Description</span>
<a href="#l14.263"></a><span id="l14.263" class="difflineminus">-      if (PlacesUtils.annotations</span>
<a href="#l14.264"></a><span id="l14.264" class="difflineminus">-                     .itemHasAnnotation(this._itemId, PlacesUIUtils.DESCRIPTION_ANNO)) {</span>
<a href="#l14.265"></a><span id="l14.265" class="difflineminus">-        this._description = PlacesUtils.annotations</span>
<a href="#l14.266"></a><span id="l14.266" class="difflineminus">-                                       .getItemAnnotation(this._itemId,</span>
<a href="#l14.267"></a><span id="l14.267" class="difflineminus">-                                                          PlacesUIUtils.DESCRIPTION_ANNO);</span>
<a href="#l14.268"></a><span id="l14.268" class="difflineminus">-      }</span>
<a href="#l14.269"></a><span id="l14.269" class="difflineplus">+    } else { // edit</span>
<a href="#l14.270"></a><span id="l14.270" class="difflineplus">+      this._node = dialogInfo.node;</span>
<a href="#l14.271"></a><span id="l14.271" class="difflineplus">+      this._title = this._node.title;</span>
<a href="#l14.272"></a><span id="l14.272" class="difflineplus">+      if (PlacesUtils.nodeIsFolder(this._node))</span>
<a href="#l14.273"></a><span id="l14.273" class="difflineplus">+        this._itemType = BOOKMARK_FOLDER;</span>
<a href="#l14.274"></a><span id="l14.274" class="difflineplus">+      else if (PlacesUtils.nodeIsURI(this._node))</span>
<a href="#l14.275"></a><span id="l14.275" class="difflineplus">+        this._itemType = BOOKMARK_ITEM;</span>
<a href="#l14.276"></a><span id="l14.276">     }</span>
<a href="#l14.277"></a><span id="l14.277">   },</span>
<a href="#l14.278"></a><span id="l14.278"> </span>
<a href="#l14.279"></a><span id="l14.279">   /**</span>
<a href="#l14.280"></a><span id="l14.280">    * This method returns the title string corresponding to a given URI.</span>
<a href="#l14.281"></a><span id="l14.281">    * If none is available from the bookmark service (probably because</span>
<a href="#l14.282"></a><span id="l14.282">    * the given URI doesn't appear in bookmarks or history), we synthesize</span>
<a href="#l14.283"></a><span id="l14.283">    * a title from the first 100 characters of the URI.</span>
<a href="#l14.284"></a><span id="l14.284" class="difflineat">@@ -285,17 +256,17 @@ var BookmarkPropertiesPanel = {</span>
<a href="#l14.285"></a><span id="l14.285">     // get the title from History</span>
<a href="#l14.286"></a><span id="l14.286">     return PlacesUtils.history.getPageTitle(aURI);</span>
<a href="#l14.287"></a><span id="l14.287">   },</span>
<a href="#l14.288"></a><span id="l14.288"> </span>
<a href="#l14.289"></a><span id="l14.289">   /**</span>
<a href="#l14.290"></a><span id="l14.290">    * This method should be called by the onload of the Bookmark Properties</span>
<a href="#l14.291"></a><span id="l14.291">    * dialog to initialize the state of the panel.</span>
<a href="#l14.292"></a><span id="l14.292">    */</span>
<a href="#l14.293"></a><span id="l14.293" class="difflineminus">-  onDialogLoad: function BPP_onDialogLoad() {</span>
<a href="#l14.294"></a><span id="l14.294" class="difflineplus">+  async onDialogLoad() {</span>
<a href="#l14.295"></a><span id="l14.295">     this._determineItemInfo();</span>
<a href="#l14.296"></a><span id="l14.296"> </span>
<a href="#l14.297"></a><span id="l14.297">     document.title = this._getDialogTitle();</span>
<a href="#l14.298"></a><span id="l14.298">     var acceptButton = document.documentElement.getButton(&quot;accept&quot;);</span>
<a href="#l14.299"></a><span id="l14.299">     acceptButton.label = this._getAcceptLabel();</span>
<a href="#l14.300"></a><span id="l14.300"> </span>
<a href="#l14.301"></a><span id="l14.301">     // Do not use sizeToContent, otherwise, due to bug 90276, the dialog will</span>
<a href="#l14.302"></a><span id="l14.302">     // grow at every opening.</span>
<a href="#l14.303"></a><span id="l14.303" class="difflineat">@@ -304,186 +275,184 @@ var BookmarkPropertiesPanel = {</span>
<a href="#l14.304"></a><span id="l14.304">     this._height = window.outerHeight;</span>
<a href="#l14.305"></a><span id="l14.305">     this._mutationObserver = new MutationObserver(mutations =&gt; {</span>
<a href="#l14.306"></a><span id="l14.306">       for (let mutation of mutations) {</span>
<a href="#l14.307"></a><span id="l14.307">         let target = mutation.target;</span>
<a href="#l14.308"></a><span id="l14.308">         let id = target.id;</span>
<a href="#l14.309"></a><span id="l14.309">         if (!/^editBMPanel_.*(Row|Checkbox)$/.test(id))</span>
<a href="#l14.310"></a><span id="l14.310">           continue;</span>
<a href="#l14.311"></a><span id="l14.311"> </span>
<a href="#l14.312"></a><span id="l14.312" class="difflineminus">-        let collapsed = target.getAttribute(&quot;collapsed&quot;) == &quot;true&quot;;</span>
<a href="#l14.313"></a><span id="l14.313" class="difflineminus">-        let wasCollapsed = mutation.oldValue == &quot;true&quot;;</span>
<a href="#l14.314"></a><span id="l14.314" class="difflineplus">+        let collapsed = target.getAttribute(&quot;collapsed&quot;) === &quot;true&quot;;</span>
<a href="#l14.315"></a><span id="l14.315" class="difflineplus">+        let wasCollapsed = mutation.oldValue === &quot;true&quot;;</span>
<a href="#l14.316"></a><span id="l14.316">         if (collapsed == wasCollapsed)</span>
<a href="#l14.317"></a><span id="l14.317">           continue;</span>
<a href="#l14.318"></a><span id="l14.318"> </span>
<a href="#l14.319"></a><span id="l14.319">         if (collapsed) {</span>
<a href="#l14.320"></a><span id="l14.320">           this._height -= elementsHeight.get(id);</span>
<a href="#l14.321"></a><span id="l14.321">           elementsHeight.delete(id);</span>
<a href="#l14.322"></a><span id="l14.322">         } else {</span>
<a href="#l14.323"></a><span id="l14.323">           elementsHeight.set(id, target.boxObject.height);</span>
<a href="#l14.324"></a><span id="l14.324">           this._height += elementsHeight.get(id);</span>
<a href="#l14.325"></a><span id="l14.325">         }</span>
<a href="#l14.326"></a><span id="l14.326" class="difflineplus">+        window.resizeTo(window.outerWidth, this._height);</span>
<a href="#l14.327"></a><span id="l14.327">       }</span>
<a href="#l14.328"></a><span id="l14.328" class="difflineminus">-      window.resizeTo(window.outerWidth, this._height);</span>
<a href="#l14.329"></a><span id="l14.329">     });</span>
<a href="#l14.330"></a><span id="l14.330"> </span>
<a href="#l14.331"></a><span id="l14.331">     this._mutationObserver.observe(document,</span>
<a href="#l14.332"></a><span id="l14.332" class="difflineminus">-                                   { attributes: true,</span>
<a href="#l14.333"></a><span id="l14.333" class="difflineminus">-                                     subtree: true,</span>
<a href="#l14.334"></a><span id="l14.334" class="difflineplus">+                                   { subtree: true,</span>
<a href="#l14.335"></a><span id="l14.335">                                      attributeOldValue: true,</span>
<a href="#l14.336"></a><span id="l14.336">                                      attributeFilter: [&quot;collapsed&quot;] });</span>
<a href="#l14.337"></a><span id="l14.337"> </span>
<a href="#l14.338"></a><span id="l14.338">     // Some controls are flexible and we want to update their cached size when</span>
<a href="#l14.339"></a><span id="l14.339">     // the dialog is resized.</span>
<a href="#l14.340"></a><span id="l14.340">     window.addEventListener(&quot;resize&quot;, this);</span>
<a href="#l14.341"></a><span id="l14.341"> </span>
<a href="#l14.342"></a><span id="l14.342">     this._beginBatch();</span>
<a href="#l14.343"></a><span id="l14.343"> </span>
<a href="#l14.344"></a><span id="l14.344">     switch (this._action) {</span>
<a href="#l14.345"></a><span id="l14.345">       case ACTION_EDIT:</span>
<a href="#l14.346"></a><span id="l14.346" class="difflineminus">-        this._fillEditProperties();</span>
<a href="#l14.347"></a><span id="l14.347" class="difflineminus">-        acceptButton.disabled = this._readOnly;</span>
<a href="#l14.348"></a><span id="l14.348" class="difflineplus">+        gEditItemOverlay.initPanel({ node: this._node,</span>
<a href="#l14.349"></a><span id="l14.349" class="difflineplus">+                                     hiddenRows: this._hiddenRows,</span>
<a href="#l14.350"></a><span id="l14.350" class="difflineplus">+                                     focusedElement: &quot;first&quot; });</span>
<a href="#l14.351"></a><span id="l14.351" class="difflineplus">+        acceptButton.disabled = gEditItemOverlay.readOnly;</span>
<a href="#l14.352"></a><span id="l14.352">         break;</span>
<a href="#l14.353"></a><span id="l14.353">       case ACTION_ADD:</span>
<a href="#l14.354"></a><span id="l14.354" class="difflineminus">-        this._createNewItem().then(() =&gt; this._fillAddProperties());</span>
<a href="#l14.355"></a><span id="l14.355" class="difflineplus">+        this._node = await this._promiseNewItem();</span>
<a href="#l14.356"></a><span id="l14.356" class="difflineplus">+        // Edit the new item</span>
<a href="#l14.357"></a><span id="l14.357" class="difflineplus">+        gEditItemOverlay.initPanel({ node: this._node,</span>
<a href="#l14.358"></a><span id="l14.358" class="difflineplus">+                                     hiddenRows: this._hiddenRows,</span>
<a href="#l14.359"></a><span id="l14.359" class="difflineplus">+                                     postData: this._postData,</span>
<a href="#l14.360"></a><span id="l14.360" class="difflineplus">+                                     focusedElement: &quot;first&quot; });</span>
<a href="#l14.361"></a><span id="l14.361" class="difflineplus">+</span>
<a href="#l14.362"></a><span id="l14.362" class="difflineplus">+        // Empty location field if the uri is about:blank, this way inserting a new</span>
<a href="#l14.363"></a><span id="l14.363" class="difflineplus">+        // url will be easier for the user, Accept button will be automatically</span>
<a href="#l14.364"></a><span id="l14.364" class="difflineplus">+        // disabled by the input listener until the user fills the field.</span>
<a href="#l14.365"></a><span id="l14.365" class="difflineplus">+        let locationField = this._element(&quot;locationField&quot;);</span>
<a href="#l14.366"></a><span id="l14.366" class="difflineplus">+        if (locationField.value == &quot;about:blank&quot;)</span>
<a href="#l14.367"></a><span id="l14.367" class="difflineplus">+          locationField.value = &quot;&quot;;</span>
<a href="#l14.368"></a><span id="l14.368" class="difflineplus">+</span>
<a href="#l14.369"></a><span id="l14.369">         // if this is an uri related dialog disable accept button until</span>
<a href="#l14.370"></a><span id="l14.370">         // the user fills an uri value.</span>
<a href="#l14.371"></a><span id="l14.371">         if (this._itemType == BOOKMARK_ITEM)</span>
<a href="#l14.372"></a><span id="l14.372">           acceptButton.disabled = !this._inputIsValid();</span>
<a href="#l14.373"></a><span id="l14.373">         break;</span>
<a href="#l14.374"></a><span id="l14.374">     }</span>
<a href="#l14.375"></a><span id="l14.375"> </span>
<a href="#l14.376"></a><span id="l14.376" class="difflineminus">-    if (!this._readOnly) {</span>
<a href="#l14.377"></a><span id="l14.377" class="difflineplus">+    if (!gEditItemOverlay.readOnly) {</span>
<a href="#l14.378"></a><span id="l14.378">       // Listen on uri fields to enable accept button if input is valid</span>
<a href="#l14.379"></a><span id="l14.379">       if (this._itemType == BOOKMARK_ITEM) {</span>
<a href="#l14.380"></a><span id="l14.380">         this._element(&quot;locationField&quot;)</span>
<a href="#l14.381"></a><span id="l14.381">             .addEventListener(&quot;input&quot;, this);</span>
<a href="#l14.382"></a><span id="l14.382">         if (this._isAddKeywordDialog) {</span>
<a href="#l14.383"></a><span id="l14.383">           this._element(&quot;keywordField&quot;)</span>
<a href="#l14.384"></a><span id="l14.384">               .addEventListener(&quot;input&quot;, this);</span>
<a href="#l14.385"></a><span id="l14.385">         }</span>
<a href="#l14.386"></a><span id="l14.386">       }</span>
<a href="#l14.387"></a><span id="l14.387" class="difflineminus">-      else if (this._itemType == LIVEMARK_CONTAINER) {</span>
<a href="#l14.388"></a><span id="l14.388" class="difflineminus">-        this._element(&quot;feedLocationField&quot;)</span>
<a href="#l14.389"></a><span id="l14.389" class="difflineminus">-            .addEventListener(&quot;input&quot;, this);</span>
<a href="#l14.390"></a><span id="l14.390" class="difflineminus">-        this._element(&quot;siteLocationField&quot;)</span>
<a href="#l14.391"></a><span id="l14.391" class="difflineminus">-            .addEventListener(&quot;input&quot;, this);</span>
<a href="#l14.392"></a><span id="l14.392" class="difflineminus">-      }</span>
<a href="#l14.393"></a><span id="l14.393">     }</span>
<a href="#l14.394"></a><span id="l14.394">   },</span>
<a href="#l14.395"></a><span id="l14.395"> </span>
<a href="#l14.396"></a><span id="l14.396">   // nsIDOMEventListener</span>
<a href="#l14.397"></a><span id="l14.397">   handleEvent: function BPP_handleEvent(aEvent) {</span>
<a href="#l14.398"></a><span id="l14.398">     var target = aEvent.target;</span>
<a href="#l14.399"></a><span id="l14.399">     switch (aEvent.type) {</span>
<a href="#l14.400"></a><span id="l14.400">       case &quot;input&quot;:</span>
<a href="#l14.401"></a><span id="l14.401">         if (target.id == &quot;editBMPanel_locationField&quot; ||</span>
<a href="#l14.402"></a><span id="l14.402" class="difflineminus">-            target.id == &quot;editBMPanel_feedLocationField&quot; ||</span>
<a href="#l14.403"></a><span id="l14.403" class="difflineminus">-            target.id == &quot;editBMPanel_siteLocationField&quot; ||</span>
<a href="#l14.404"></a><span id="l14.404">             target.id == &quot;editBMPanel_keywordField&quot;) {</span>
<a href="#l14.405"></a><span id="l14.405">           // Check uri fields to enable accept button if input is valid</span>
<a href="#l14.406"></a><span id="l14.406">           document.documentElement</span>
<a href="#l14.407"></a><span id="l14.407">                   .getButton(&quot;accept&quot;).disabled = !this._inputIsValid();</span>
<a href="#l14.408"></a><span id="l14.408">         }</span>
<a href="#l14.409"></a><span id="l14.409">         break;</span>
<a href="#l14.410"></a><span id="l14.410">       case &quot;resize&quot;:</span>
<a href="#l14.411"></a><span id="l14.411">         for (let [id, oldHeight] of elementsHeight) {</span>
<a href="#l14.412"></a><span id="l14.412">           let newHeight = document.getElementById(id).boxObject.height;</span>
<a href="#l14.413"></a><span id="l14.413" class="difflineminus">-          this._height += - oldHeight + newHeight;</span>
<a href="#l14.414"></a><span id="l14.414" class="difflineplus">+          this._height += -oldHeight + newHeight;</span>
<a href="#l14.415"></a><span id="l14.415">           elementsHeight.set(id, newHeight);</span>
<a href="#l14.416"></a><span id="l14.416" class="difflineplus">+        }</span>
<a href="#l14.417"></a><span id="l14.417">         break;</span>
<a href="#l14.418"></a><span id="l14.418">     }</span>
<a href="#l14.419"></a><span id="l14.419" class="difflineminus">-</span>
<a href="#l14.420"></a><span id="l14.420" class="difflineminus">-    }</span>
<a href="#l14.421"></a><span id="l14.421">   },</span>
<a href="#l14.422"></a><span id="l14.422"> </span>
<a href="#l14.423"></a><span id="l14.423" class="difflineminus">-  _beginBatch: function BPP__beginBatch() {</span>
<a href="#l14.424"></a><span id="l14.424" class="difflineplus">+  // Hack for implementing batched-Undo around the editBookmarkOverlay</span>
<a href="#l14.425"></a><span id="l14.425" class="difflineplus">+  // instant-apply code. For all the details see the comment above beginBatch</span>
<a href="#l14.426"></a><span id="l14.426" class="difflineplus">+  // in browser-places.js</span>
<a href="#l14.427"></a><span id="l14.427" class="difflineplus">+  _batchBlockingDeferred: null,</span>
<a href="#l14.428"></a><span id="l14.428" class="difflineplus">+  _beginBatch() {</span>
<a href="#l14.429"></a><span id="l14.429">     if (this._batching)</span>
<a href="#l14.430"></a><span id="l14.430">       return;</span>
<a href="#l14.431"></a><span id="l14.431" class="difflineminus">-</span>
<a href="#l14.432"></a><span id="l14.432" class="difflineminus">-    PlacesUtils.transactionManager.beginBatch(null);</span>
<a href="#l14.433"></a><span id="l14.433" class="difflineplus">+    if (PlacesUIUtils.useAsyncTransactions) {</span>
<a href="#l14.434"></a><span id="l14.434" class="difflineplus">+      this._batchBlockingDeferred = PromiseUtils.defer();</span>
<a href="#l14.435"></a><span id="l14.435" class="difflineplus">+      PlacesTransactions.batch(async () =&gt; {</span>
<a href="#l14.436"></a><span id="l14.436" class="difflineplus">+        await this._batchBlockingDeferred.promise;</span>
<a href="#l14.437"></a><span id="l14.437" class="difflineplus">+      });</span>
<a href="#l14.438"></a><span id="l14.438" class="difflineplus">+    } else {</span>
<a href="#l14.439"></a><span id="l14.439" class="difflineplus">+      PlacesUtils.transactionManager.beginBatch(null);</span>
<a href="#l14.440"></a><span id="l14.440" class="difflineplus">+    }</span>
<a href="#l14.441"></a><span id="l14.441">     this._batching = true;</span>
<a href="#l14.442"></a><span id="l14.442">   },</span>
<a href="#l14.443"></a><span id="l14.443"> </span>
<a href="#l14.444"></a><span id="l14.444" class="difflineminus">-  _endBatch: function BPP__endBatch() {</span>
<a href="#l14.445"></a><span id="l14.445" class="difflineplus">+  _endBatch() {</span>
<a href="#l14.446"></a><span id="l14.446">     if (!this._batching)</span>
<a href="#l14.447"></a><span id="l14.447">       return;</span>
<a href="#l14.448"></a><span id="l14.448"> </span>
<a href="#l14.449"></a><span id="l14.449" class="difflineminus">-    PlacesUtils.transactionManager.endBatch(false);</span>
<a href="#l14.450"></a><span id="l14.450" class="difflineplus">+    if (PlacesUIUtils.useAsyncTransactions) {</span>
<a href="#l14.451"></a><span id="l14.451" class="difflineplus">+      this._batchBlockingDeferred.resolve();</span>
<a href="#l14.452"></a><span id="l14.452" class="difflineplus">+      this._batchBlockingDeferred = null;</span>
<a href="#l14.453"></a><span id="l14.453" class="difflineplus">+    } else {</span>
<a href="#l14.454"></a><span id="l14.454" class="difflineplus">+      PlacesUtils.transactionManager.endBatch(false);</span>
<a href="#l14.455"></a><span id="l14.455" class="difflineplus">+    }</span>
<a href="#l14.456"></a><span id="l14.456">     this._batching = false;</span>
<a href="#l14.457"></a><span id="l14.457">   },</span>
<a href="#l14.458"></a><span id="l14.458"> </span>
<a href="#l14.459"></a><span id="l14.459" class="difflineminus">-  _fillEditProperties: function BPP__fillEditProperties() {</span>
<a href="#l14.460"></a><span id="l14.460" class="difflineminus">-    gEditItemOverlay.initPanel(this._itemId,</span>
<a href="#l14.461"></a><span id="l14.461" class="difflineminus">-                               { hiddenRows: this._hiddenRows,</span>
<a href="#l14.462"></a><span id="l14.462" class="difflineminus">-                                 forceReadOnly: this._readOnly });</span>
<a href="#l14.463"></a><span id="l14.463" class="difflineminus">-  },</span>
<a href="#l14.464"></a><span id="l14.464" class="difflineminus">-</span>
<a href="#l14.465"></a><span id="l14.465" class="difflineminus">-  _fillAddProperties: function BPP__fillAddProperties() {</span>
<a href="#l14.466"></a><span id="l14.466" class="difflineminus">-    // Edit the new item</span>
<a href="#l14.467"></a><span id="l14.467" class="difflineminus">-    gEditItemOverlay.initPanel(this._itemId,</span>
<a href="#l14.468"></a><span id="l14.468" class="difflineminus">-                               { hiddenRows: this._hiddenRows });</span>
<a href="#l14.469"></a><span id="l14.469" class="difflineminus">-    // Empty location field if the uri is about:blank, this way inserting a new</span>
<a href="#l14.470"></a><span id="l14.470" class="difflineminus">-    // url will be easier for the user, Accept button will be automatically</span>
<a href="#l14.471"></a><span id="l14.471" class="difflineminus">-    // disabled by the input listener until the user fills the field.</span>
<a href="#l14.472"></a><span id="l14.472" class="difflineminus">-    var locationField = this._element(&quot;locationField&quot;);</span>
<a href="#l14.473"></a><span id="l14.473" class="difflineminus">-    if (locationField.value == &quot;about:blank&quot;)</span>
<a href="#l14.474"></a><span id="l14.474" class="difflineminus">-      locationField.value = &quot;&quot;;</span>
<a href="#l14.475"></a><span id="l14.475" class="difflineminus">-  },</span>
<a href="#l14.476"></a><span id="l14.476" class="difflineminus">-</span>
<a href="#l14.477"></a><span id="l14.477">   // nsISupports</span>
<a href="#l14.478"></a><span id="l14.478">   QueryInterface: function BPP_QueryInterface(aIID) {</span>
<a href="#l14.479"></a><span id="l14.479">     if (aIID.equals(Ci.nsIDOMEventListener) ||</span>
<a href="#l14.480"></a><span id="l14.480">         aIID.equals(Ci.nsISupports))</span>
<a href="#l14.481"></a><span id="l14.481">       return this;</span>
<a href="#l14.482"></a><span id="l14.482"> </span>
<a href="#l14.483"></a><span id="l14.483">     throw Cr.NS_NOINTERFACE;</span>
<a href="#l14.484"></a><span id="l14.484">   },</span>
<a href="#l14.485"></a><span id="l14.485"> </span>
<a href="#l14.486"></a><span id="l14.486">   _element: function BPP__element(aID) {</span>
<a href="#l14.487"></a><span id="l14.487">     return document.getElementById(&quot;editBMPanel_&quot; + aID);</span>
<a href="#l14.488"></a><span id="l14.488">   },</span>
<a href="#l14.489"></a><span id="l14.489"> </span>
<a href="#l14.490"></a><span id="l14.490" class="difflineminus">-  onDialogUnload: function BPP_onDialogUnload() {</span>
<a href="#l14.491"></a><span id="l14.491" class="difflineminus">-</span>
<a href="#l14.492"></a><span id="l14.492" class="difflineminus">-  // gEditItemOverlay does not exist anymore here, so don't rely on it.</span>
<a href="#l14.493"></a><span id="l14.493" class="difflineplus">+  onDialogUnload() {</span>
<a href="#l14.494"></a><span id="l14.494" class="difflineplus">+    // gEditItemOverlay does not exist anymore here, so don't rely on it.</span>
<a href="#l14.495"></a><span id="l14.495">     this._mutationObserver.disconnect();</span>
<a href="#l14.496"></a><span id="l14.496">     delete this._mutationObserver;</span>
<a href="#l14.497"></a><span id="l14.497"> </span>
<a href="#l14.498"></a><span id="l14.498">     window.removeEventListener(&quot;resize&quot;, this);</span>
<a href="#l14.499"></a><span id="l14.499" class="difflineplus">+</span>
<a href="#l14.500"></a><span id="l14.500">     // Calling removeEventListener with arguments which do not identify any</span>
<a href="#l14.501"></a><span id="l14.501">     // currently registered EventListener on the EventTarget has no effect.</span>
<a href="#l14.502"></a><span id="l14.502">     this._element(&quot;locationField&quot;)</span>
<a href="#l14.503"></a><span id="l14.503">         .removeEventListener(&quot;input&quot;, this);</span>
<a href="#l14.504"></a><span id="l14.504" class="difflineminus">-    this._element(&quot;feedLocationField&quot;)</span>
<a href="#l14.505"></a><span id="l14.505" class="difflineminus">-        .removeEventListener(&quot;input&quot;, this);</span>
<a href="#l14.506"></a><span id="l14.506" class="difflineminus">-    this._element(&quot;siteLocationField&quot;)</span>
<a href="#l14.507"></a><span id="l14.507" class="difflineminus">-        .removeEventListener(&quot;input&quot;, this);</span>
<a href="#l14.508"></a><span id="l14.508" class="difflineminus">-</span>
<a href="#l14.509"></a><span id="l14.509">   },</span>
<a href="#l14.510"></a><span id="l14.510"> </span>
<a href="#l14.511"></a><span id="l14.511" class="difflineminus">-  onDialogAccept: function BPP_onDialogAccept() {</span>
<a href="#l14.512"></a><span id="l14.512" class="difflineplus">+  onDialogAccept() {</span>
<a href="#l14.513"></a><span id="l14.513">     // We must blur current focused element to save its changes correctly</span>
<a href="#l14.514"></a><span id="l14.514">     document.commandDispatcher.focusedElement.blur();</span>
<a href="#l14.515"></a><span id="l14.515">     // The order here is important! We have to uninit the panel first, otherwise</span>
<a href="#l14.516"></a><span id="l14.516">     // late changes could force it to commit more transactions.</span>
<a href="#l14.517"></a><span id="l14.517" class="difflineminus">-    gEditItemOverlay.uninitPanel(false);</span>
<a href="#l14.518"></a><span id="l14.518" class="difflineminus">-    gEditItemOverlay = null;</span>
<a href="#l14.519"></a><span id="l14.519" class="difflineplus">+    gEditItemOverlay.uninitPanel(true);</span>
<a href="#l14.520"></a><span id="l14.520">     this._endBatch();</span>
<a href="#l14.521"></a><span id="l14.521">     window.arguments[0].performed = true;</span>
<a href="#l14.522"></a><span id="l14.522">   },</span>
<a href="#l14.523"></a><span id="l14.523"> </span>
<a href="#l14.524"></a><span id="l14.524" class="difflineminus">-  onDialogCancel: function BPP_onDialogCancel() {</span>
<a href="#l14.525"></a><span id="l14.525" class="difflineplus">+  onDialogCancel() {</span>
<a href="#l14.526"></a><span id="l14.526">     // The order here is important! We have to uninit the panel first, otherwise</span>
<a href="#l14.527"></a><span id="l14.527">     // changes done as part of Undo may change the panel contents and by</span>
<a href="#l14.528"></a><span id="l14.528">     // that force it to commit more transactions.</span>
<a href="#l14.529"></a><span id="l14.529" class="difflineminus">-    gEditItemOverlay.uninitPanel(false);</span>
<a href="#l14.530"></a><span id="l14.530" class="difflineminus">-    gEditItemOverlay = null;</span>
<a href="#l14.531"></a><span id="l14.531" class="difflineplus">+    gEditItemOverlay.uninitPanel(true);</span>
<a href="#l14.532"></a><span id="l14.532">     this._endBatch();</span>
<a href="#l14.533"></a><span id="l14.533" class="difflineminus">-    PlacesUtils.transactionManager.undoTransaction();</span>
<a href="#l14.534"></a><span id="l14.534" class="difflineplus">+    if (PlacesUIUtils.useAsyncTransactions)</span>
<a href="#l14.535"></a><span id="l14.535" class="difflineplus">+      PlacesTransactions.undo().catch(Cu.reportError);</span>
<a href="#l14.536"></a><span id="l14.536" class="difflineplus">+    else</span>
<a href="#l14.537"></a><span id="l14.537" class="difflineplus">+      PlacesUtils.transactionManager.undoTransaction();</span>
<a href="#l14.538"></a><span id="l14.538">     window.arguments[0].performed = false;</span>
<a href="#l14.539"></a><span id="l14.539">   },</span>
<a href="#l14.540"></a><span id="l14.540"> </span>
<a href="#l14.541"></a><span id="l14.541">   /**</span>
<a href="#l14.542"></a><span id="l14.542">    * This method checks to see if the input fields are in a valid state.</span>
<a href="#l14.543"></a><span id="l14.543">    *</span>
<a href="#l14.544"></a><span id="l14.544">    * @returns  true if the input is valid, false otherwise</span>
<a href="#l14.545"></a><span id="l14.545">    */</span>
<a href="#l14.546"></a><span id="l14.546" class="difflineat">@@ -532,63 +501,70 @@ var BookmarkPropertiesPanel = {</span>
<a href="#l14.547"></a><span id="l14.547">   },</span>
<a href="#l14.548"></a><span id="l14.548"> </span>
<a href="#l14.549"></a><span id="l14.549">   /**</span>
<a href="#l14.550"></a><span id="l14.550">    * Returns a transaction for creating a new bookmark item representing the</span>
<a href="#l14.551"></a><span id="l14.551">    * various fields and opening arguments of the dialog.</span>
<a href="#l14.552"></a><span id="l14.552">    */</span>
<a href="#l14.553"></a><span id="l14.553">   _getCreateNewBookmarkTransaction:</span>
<a href="#l14.554"></a><span id="l14.554">   function BPP__getCreateNewBookmarkTransaction(aContainer, aIndex) {</span>
<a href="#l14.555"></a><span id="l14.555" class="difflineminus">-    const nsIAnnotationService = Ci.nsIAnnotationService;</span>
<a href="#l14.556"></a><span id="l14.556">     var annotations = [];</span>
<a href="#l14.557"></a><span id="l14.557">     var childTransactions = [];</span>
<a href="#l14.558"></a><span id="l14.558"> </span>
<a href="#l14.559"></a><span id="l14.559">     if (this._description) {</span>
<a href="#l14.560"></a><span id="l14.560" class="difflineminus">-      let annoObj = { name   : PlacesUIUtils.DESCRIPTION_ANNO,</span>
<a href="#l14.561"></a><span id="l14.561" class="difflineminus">-                      type   : nsIAnnotationService.TYPE_STRING,</span>
<a href="#l14.562"></a><span id="l14.562" class="difflineminus">-                      flags  : 0,</span>
<a href="#l14.563"></a><span id="l14.563" class="difflineminus">-                      value  : this._description,</span>
<a href="#l14.564"></a><span id="l14.564" class="difflineminus">-                      expires: nsIAnnotationService.EXPIRE_NEVER };</span>
<a href="#l14.565"></a><span id="l14.565" class="difflineplus">+      let annoObj = { name: PlacesUIUtils.DESCRIPTION_ANNO,</span>
<a href="#l14.566"></a><span id="l14.566" class="difflineplus">+                      type: Ci.nsIAnnotationService.TYPE_STRING,</span>
<a href="#l14.567"></a><span id="l14.567" class="difflineplus">+                      flags: 0,</span>
<a href="#l14.568"></a><span id="l14.568" class="difflineplus">+                      value: this._description,</span>
<a href="#l14.569"></a><span id="l14.569" class="difflineplus">+                      expires: Ci.nsIAnnotationService.EXPIRE_NEVER };</span>
<a href="#l14.570"></a><span id="l14.570">       let editItemTxn = new PlacesSetItemAnnotationTransaction(-1, annoObj);</span>
<a href="#l14.571"></a><span id="l14.571">       childTransactions.push(editItemTxn);</span>
<a href="#l14.572"></a><span id="l14.572">     }</span>
<a href="#l14.573"></a><span id="l14.573"> </span>
<a href="#l14.574"></a><span id="l14.574" class="difflineminus">-    if (this._postData) {</span>
<a href="#l14.575"></a><span id="l14.575" class="difflineminus">-     let postDataTxn = new PlacesEditBookmarkPostDataTransaction(-1, this._postData);</span>
<a href="#l14.576"></a><span id="l14.576" class="difflineminus">-     childTransactions.push(postDataTxn);</span>
<a href="#l14.577"></a><span id="l14.577" class="difflineplus">+    if (this._loadInSidebar) {</span>
<a href="#l14.578"></a><span id="l14.578" class="difflineplus">+      let annoObj = { name: PlacesUIUtils.LOAD_IN_SIDEBAR_ANNO,</span>
<a href="#l14.579"></a><span id="l14.579" class="difflineplus">+                      value: true };</span>
<a href="#l14.580"></a><span id="l14.580" class="difflineplus">+      let setLoadTxn = new PlacesSetItemAnnotationTransaction(-1, annoObj);</span>
<a href="#l14.581"></a><span id="l14.581" class="difflineplus">+      childTransactions.push(setLoadTxn);</span>
<a href="#l14.582"></a><span id="l14.582">     }</span>
<a href="#l14.583"></a><span id="l14.583"> </span>
<a href="#l14.584"></a><span id="l14.584" class="difflineminus">-    //XXX TODO: this should be in a transaction!</span>
<a href="#l14.585"></a><span id="l14.585" class="difflineminus">-    if (this._charSet)</span>
<a href="#l14.586"></a><span id="l14.586" class="difflineplus">+    // XXX TODO: this should be in a transaction!</span>
<a href="#l14.587"></a><span id="l14.587" class="difflineplus">+    if (this._charSet &amp;&amp; !PrivateBrowsingUtils.isWindowPrivate(window))</span>
<a href="#l14.588"></a><span id="l14.588">       PlacesUtils.setCharsetForURI(this._uri, this._charSet);</span>
<a href="#l14.589"></a><span id="l14.589"> </span>
<a href="#l14.590"></a><span id="l14.590">     let createTxn = new PlacesCreateBookmarkTransaction(this._uri,</span>
<a href="#l14.591"></a><span id="l14.591">                                                         aContainer,</span>
<a href="#l14.592"></a><span id="l14.592">                                                         aIndex,</span>
<a href="#l14.593"></a><span id="l14.593">                                                         this._title,</span>
<a href="#l14.594"></a><span id="l14.594">                                                         this._keyword,</span>
<a href="#l14.595"></a><span id="l14.595">                                                         annotations,</span>
<a href="#l14.596"></a><span id="l14.596" class="difflineminus">-                                                        childTransactions);</span>
<a href="#l14.597"></a><span id="l14.597" class="difflineplus">+                                                        childTransactions,</span>
<a href="#l14.598"></a><span id="l14.598" class="difflineplus">+                                                        this._postData);</span>
<a href="#l14.599"></a><span id="l14.599"> </span>
<a href="#l14.600"></a><span id="l14.600">     return new PlacesAggregatedTransaction(this._getDialogTitle(),</span>
<a href="#l14.601"></a><span id="l14.601">                                            [createTxn]);</span>
<a href="#l14.602"></a><span id="l14.602">   },</span>
<a href="#l14.603"></a><span id="l14.603"> </span>
<a href="#l14.604"></a><span id="l14.604">   /**</span>
<a href="#l14.605"></a><span id="l14.605">    * Returns a childItems-transactions array representing the URIList with</span>
<a href="#l14.606"></a><span id="l14.606">    * which the dialog has been opened.</span>
<a href="#l14.607"></a><span id="l14.607">    */</span>
<a href="#l14.608"></a><span id="l14.608">   _getTransactionsForURIList: function BPP__getTransactionsForURIList() {</span>
<a href="#l14.609"></a><span id="l14.609">     var transactions = [];</span>
<a href="#l14.610"></a><span id="l14.610" class="difflineminus">-    for (var i = 0; i &lt; this._URIs.length; ++i) {</span>
<a href="#l14.611"></a><span id="l14.611" class="difflineminus">-      var uri = this._URIs[i];</span>
<a href="#l14.612"></a><span id="l14.612" class="difflineminus">-      var title = this._titles[i] || this._getURITitleFromHistory(uri);</span>
<a href="#l14.613"></a><span id="l14.613" class="difflineminus">-      var createTxn = new PlacesCreateBookmarkTransaction(uri, -1,</span>
<a href="#l14.614"></a><span id="l14.614" class="difflineminus">-                                                          PlacesUtils.bookmarks.DEFAULT_INDEX,</span>
<a href="#l14.615"></a><span id="l14.615" class="difflineminus">-                                                          title);</span>
<a href="#l14.616"></a><span id="l14.616" class="difflineplus">+    for (let uri of this._URIs) {</span>
<a href="#l14.617"></a><span id="l14.617" class="difflineplus">+      // uri should be an object in the form { uri, title }. Though add-ons</span>
<a href="#l14.618"></a><span id="l14.618" class="difflineplus">+      // could still use the legacy form, where it's an nsIURI.</span>
<a href="#l14.619"></a><span id="l14.619" class="difflineplus">+      // TODO: Remove This from v57 on.</span>
<a href="#l14.620"></a><span id="l14.620" class="difflineplus">+      let [_uri, _title] = uri instanceof Ci.nsIURI ?</span>
<a href="#l14.621"></a><span id="l14.621" class="difflineplus">+        [uri, this._getURITitleFromHistory(uri)] : [uri.uri, uri.title];</span>
<a href="#l14.622"></a><span id="l14.622" class="difflineplus">+</span>
<a href="#l14.623"></a><span id="l14.623" class="difflineplus">+      let createTxn =</span>
<a href="#l14.624"></a><span id="l14.624" class="difflineplus">+        new PlacesCreateBookmarkTransaction(_uri, -1,</span>
<a href="#l14.625"></a><span id="l14.625" class="difflineplus">+                                            PlacesUtils.bookmarks.DEFAULT_INDEX,</span>
<a href="#l14.626"></a><span id="l14.626" class="difflineplus">+                                            _title);</span>
<a href="#l14.627"></a><span id="l14.627">       transactions.push(createTxn);</span>
<a href="#l14.628"></a><span id="l14.628">     }</span>
<a href="#l14.629"></a><span id="l14.629">     return transactions;</span>
<a href="#l14.630"></a><span id="l14.630">   },</span>
<a href="#l14.631"></a><span id="l14.631"> </span>
<a href="#l14.632"></a><span id="l14.632">   /**</span>
<a href="#l14.633"></a><span id="l14.633">    * Returns a transaction for creating a new folder item representing the</span>
<a href="#l14.634"></a><span id="l14.634">    * various fields and opening arguments of the dialog.</span>
<a href="#l14.635"></a><span id="l14.635" class="difflineat">@@ -603,48 +579,118 @@ var BookmarkPropertiesPanel = {</span>
<a href="#l14.636"></a><span id="l14.636">     if (this._description)</span>
<a href="#l14.637"></a><span id="l14.637">       annotations.push(this._getDescriptionAnnotation(this._description));</span>
<a href="#l14.638"></a><span id="l14.638"> </span>
<a href="#l14.639"></a><span id="l14.639">     return new PlacesCreateFolderTransaction(this._title, aContainer,</span>
<a href="#l14.640"></a><span id="l14.640">                                              aIndex, annotations,</span>
<a href="#l14.641"></a><span id="l14.641">                                              childItemsTransactions);</span>
<a href="#l14.642"></a><span id="l14.642">   },</span>
<a href="#l14.643"></a><span id="l14.643"> </span>
<a href="#l14.644"></a><span id="l14.644" class="difflineminus">-  /**</span>
<a href="#l14.645"></a><span id="l14.645" class="difflineminus">-   * Returns a transaction for creating a new live-bookmark item representing</span>
<a href="#l14.646"></a><span id="l14.646" class="difflineminus">-   * the various fields and opening arguments of the dialog.</span>
<a href="#l14.647"></a><span id="l14.647" class="difflineminus">-   */</span>
<a href="#l14.648"></a><span id="l14.648" class="difflineminus">-  _getCreateNewLivemarkTransaction:</span>
<a href="#l14.649"></a><span id="l14.649" class="difflineminus">-  function BPP__getCreateNewLivemarkTransaction(aContainer, aIndex) {</span>
<a href="#l14.650"></a><span id="l14.650" class="difflineminus">-    return new PlacesCreateLivemarkTransaction(this._feedURI, this._siteURI,</span>
<a href="#l14.651"></a><span id="l14.651" class="difflineminus">-                                               this._title,</span>
<a href="#l14.652"></a><span id="l14.652" class="difflineminus">-                                               aContainer, aIndex);</span>
<a href="#l14.653"></a><span id="l14.653" class="difflineminus">-  },</span>
<a href="#l14.654"></a><span id="l14.654" class="difflineminus">-</span>
<a href="#l14.655"></a><span id="l14.655" class="difflineminus">-  /**</span>
<a href="#l14.656"></a><span id="l14.656" class="difflineminus">-   * Dialog-accept code-path for creating a new item (any type)</span>
<a href="#l14.657"></a><span id="l14.657" class="difflineminus">-   */</span>
<a href="#l14.658"></a><span id="l14.658" class="difflineminus">-  _createNewItem: function BPP__getCreateItemTransaction() {</span>
<a href="#l14.659"></a><span id="l14.659" class="difflineminus">-    var [container, index] = this._getInsertionPointDetails();</span>
<a href="#l14.660"></a><span id="l14.660" class="difflineminus">-    var txn;</span>
<a href="#l14.661"></a><span id="l14.661" class="difflineminus">-</span>
<a href="#l14.662"></a><span id="l14.662" class="difflineplus">+  async _createNewItem() {</span>
<a href="#l14.663"></a><span id="l14.663" class="difflineplus">+    let [container, index] = this._getInsertionPointDetails();</span>
<a href="#l14.664"></a><span id="l14.664" class="difflineplus">+    let txn;</span>
<a href="#l14.665"></a><span id="l14.665">     switch (this._itemType) {</span>
<a href="#l14.666"></a><span id="l14.666">       case BOOKMARK_FOLDER:</span>
<a href="#l14.667"></a><span id="l14.667">         txn = this._getCreateNewFolderTransaction(container, index);</span>
<a href="#l14.668"></a><span id="l14.668">         break;</span>
<a href="#l14.669"></a><span id="l14.669">       case LIVEMARK_CONTAINER:</span>
<a href="#l14.670"></a><span id="l14.670" class="difflineminus">-        txn = this._getCreateNewLivemarkTransaction(container, index);</span>
<a href="#l14.671"></a><span id="l14.671" class="difflineplus">+        txn = new PlacesCreateLivemarkTransaction(this._feedURI, this._siteURI,</span>
<a href="#l14.672"></a><span id="l14.672" class="difflineplus">+                                                  this._title, container, index);</span>
<a href="#l14.673"></a><span id="l14.673">         break;</span>
<a href="#l14.674"></a><span id="l14.674">       default: // BOOKMARK_ITEM</span>
<a href="#l14.675"></a><span id="l14.675">         txn = this._getCreateNewBookmarkTransaction(container, index);</span>
<a href="#l14.676"></a><span id="l14.676">     }</span>
<a href="#l14.677"></a><span id="l14.677"> </span>
<a href="#l14.678"></a><span id="l14.678">     PlacesUtils.transactionManager.doTransaction(txn);</span>
<a href="#l14.679"></a><span id="l14.679" class="difflineminus">-    var promise = txn._promise || {</span>
<a href="#l14.680"></a><span id="l14.680" class="difflineminus">-      then: function(callback) {</span>
<a href="#l14.681"></a><span id="l14.681" class="difflineminus">-        callback();</span>
<a href="#l14.682"></a><span id="l14.682" class="difflineminus">-        return this;</span>
<a href="#l14.683"></a><span id="l14.683" class="difflineplus">+    // This is a temporary hack until we use PlacesTransactions.jsm</span>
<a href="#l14.684"></a><span id="l14.684" class="difflineplus">+    if (txn._promise) {</span>
<a href="#l14.685"></a><span id="l14.685" class="difflineplus">+      await txn._promise;</span>
<a href="#l14.686"></a><span id="l14.686" class="difflineplus">+    }</span>
<a href="#l14.687"></a><span id="l14.687" class="difflineplus">+</span>
<a href="#l14.688"></a><span id="l14.688" class="difflineplus">+    let folderGuid = await PlacesUtils.promiseItemGuid(container);</span>
<a href="#l14.689"></a><span id="l14.689" class="difflineplus">+    let bm = await PlacesUtils.bookmarks.fetch({</span>
<a href="#l14.690"></a><span id="l14.690" class="difflineplus">+      parentGuid: folderGuid,</span>
<a href="#l14.691"></a><span id="l14.691" class="difflineplus">+      index</span>
<a href="#l14.692"></a><span id="l14.692" class="difflineplus">+    });</span>
<a href="#l14.693"></a><span id="l14.693" class="difflineplus">+    this._itemId = await PlacesUtils.promiseItemId(bm.guid);</span>
<a href="#l14.694"></a><span id="l14.694" class="difflineplus">+</span>
<a href="#l14.695"></a><span id="l14.695" class="difflineplus">+    return Object.freeze({</span>
<a href="#l14.696"></a><span id="l14.696" class="difflineplus">+      itemId: this._itemId,</span>
<a href="#l14.697"></a><span id="l14.697" class="difflineplus">+      bookmarkGuid: bm.guid,</span>
<a href="#l14.698"></a><span id="l14.698" class="difflineplus">+      title: this._title,</span>
<a href="#l14.699"></a><span id="l14.699" class="difflineplus">+      uri: this._uri ? this._uri.spec : &quot;&quot;,</span>
<a href="#l14.700"></a><span id="l14.700" class="difflineplus">+      type: this._itemType == BOOKMARK_ITEM ?</span>
<a href="#l14.701"></a><span id="l14.701" class="difflineplus">+              Ci.nsINavHistoryResultNode.RESULT_TYPE_URI :</span>
<a href="#l14.702"></a><span id="l14.702" class="difflineplus">+              Ci.nsINavHistoryResultNode.RESULT_TYPE_FOLDER,</span>
<a href="#l14.703"></a><span id="l14.703" class="difflineplus">+      parent: {</span>
<a href="#l14.704"></a><span id="l14.704" class="difflineplus">+        itemId: container,</span>
<a href="#l14.705"></a><span id="l14.705" class="difflineplus">+        bookmarkGuid: await PlacesUtils.promiseItemGuid(container),</span>
<a href="#l14.706"></a><span id="l14.706" class="difflineplus">+        type: Ci.nsINavHistoryResultNode.RESULT_TYPE_FOLDER</span>
<a href="#l14.707"></a><span id="l14.707">       }</span>
<a href="#l14.708"></a><span id="l14.708" class="difflineminus">-    };</span>
<a href="#l14.709"></a><span id="l14.709" class="difflineminus">-    return promise.then(() =&gt;</span>
<a href="#l14.710"></a><span id="l14.710" class="difflineminus">-      this._itemId = PlacesUtils.bookmarks.getIdForItemAt(container, index));</span>
<a href="#l14.711"></a><span id="l14.711" class="difflineplus">+    });</span>
<a href="#l14.712"></a><span id="l14.712" class="difflineplus">+  },</span>
<a href="#l14.713"></a><span id="l14.713" class="difflineplus">+</span>
<a href="#l14.714"></a><span id="l14.714" class="difflineplus">+  async _promiseNewItem() {</span>
<a href="#l14.715"></a><span id="l14.715" class="difflineplus">+    if (!PlacesUIUtils.useAsyncTransactions)</span>
<a href="#l14.716"></a><span id="l14.716" class="difflineplus">+      return this._createNewItem();</span>
<a href="#l14.717"></a><span id="l14.717" class="difflineplus">+</span>
<a href="#l14.718"></a><span id="l14.718" class="difflineplus">+    let [containerId, index] = this._getInsertionPointDetails();</span>
<a href="#l14.719"></a><span id="l14.719" class="difflineplus">+    let parentGuid = await PlacesUtils.promiseItemGuid(containerId);</span>
<a href="#l14.720"></a><span id="l14.720" class="difflineplus">+    let annotations = [];</span>
<a href="#l14.721"></a><span id="l14.721" class="difflineplus">+    if (this._description) {</span>
<a href="#l14.722"></a><span id="l14.722" class="difflineplus">+      annotations.push({ name: PlacesUIUtils.DESCRIPTION_ANNO,</span>
<a href="#l14.723"></a><span id="l14.723" class="difflineplus">+                         value: this._description });</span>
<a href="#l14.724"></a><span id="l14.724" class="difflineplus">+    }</span>
<a href="#l14.725"></a><span id="l14.725" class="difflineplus">+    if (this._loadInSidebar) {</span>
<a href="#l14.726"></a><span id="l14.726" class="difflineplus">+      annotations.push({ name: PlacesUIUtils.LOAD_IN_SIDEBAR_ANNO,</span>
<a href="#l14.727"></a><span id="l14.727" class="difflineplus">+                         value: true });</span>
<a href="#l14.728"></a><span id="l14.728" class="difflineplus">+    }</span>
<a href="#l14.729"></a><span id="l14.729" class="difflineplus">+</span>
<a href="#l14.730"></a><span id="l14.730" class="difflineplus">+    let itemGuid;</span>
<a href="#l14.731"></a><span id="l14.731" class="difflineplus">+    let info = { parentGuid, index, title: this._title, annotations };</span>
<a href="#l14.732"></a><span id="l14.732" class="difflineplus">+    if (this._itemType == BOOKMARK_ITEM) {</span>
<a href="#l14.733"></a><span id="l14.733" class="difflineplus">+      info.url = this._uri;</span>
<a href="#l14.734"></a><span id="l14.734" class="difflineplus">+      if (this._keyword)</span>
<a href="#l14.735"></a><span id="l14.735" class="difflineplus">+        info.keyword = this._keyword;</span>
<a href="#l14.736"></a><span id="l14.736" class="difflineplus">+      if (this._postData)</span>
<a href="#l14.737"></a><span id="l14.737" class="difflineplus">+        info.postData = this._postData;</span>
<a href="#l14.738"></a><span id="l14.738" class="difflineplus">+</span>
<a href="#l14.739"></a><span id="l14.739" class="difflineplus">+      if (this._charSet &amp;&amp; !PrivateBrowsingUtils.isWindowPrivate(window))</span>
<a href="#l14.740"></a><span id="l14.740" class="difflineplus">+        PlacesUtils.setCharsetForURI(this._uri, this._charSet);</span>
<a href="#l14.741"></a><span id="l14.741" class="difflineplus">+</span>
<a href="#l14.742"></a><span id="l14.742" class="difflineplus">+      itemGuid = await PlacesTransactions.NewBookmark(info).transact();</span>
<a href="#l14.743"></a><span id="l14.743" class="difflineplus">+    } else if (this._itemType == LIVEMARK_CONTAINER) {</span>
<a href="#l14.744"></a><span id="l14.744" class="difflineplus">+      info.feedUrl = this._feedURI;</span>
<a href="#l14.745"></a><span id="l14.745" class="difflineplus">+      if (this._siteURI)</span>
<a href="#l14.746"></a><span id="l14.746" class="difflineplus">+        info.siteUrl = this._siteURI;</span>
<a href="#l14.747"></a><span id="l14.747" class="difflineplus">+</span>
<a href="#l14.748"></a><span id="l14.748" class="difflineplus">+      itemGuid = await PlacesTransactions.NewLivemark(info).transact();</span>
<a href="#l14.749"></a><span id="l14.749" class="difflineplus">+    } else if (this._itemType == BOOKMARK_FOLDER) {</span>
<a href="#l14.750"></a><span id="l14.750" class="difflineplus">+      itemGuid = await PlacesTransactions.NewFolder(info).transact();</span>
<a href="#l14.751"></a><span id="l14.751" class="difflineplus">+      // URIs is an array of objects in the form { uri, title }.  It is still</span>
<a href="#l14.752"></a><span id="l14.752" class="difflineplus">+      // named URIs because for backwards compatibility it could also be an</span>
<a href="#l14.753"></a><span id="l14.753" class="difflineplus">+      // array of nsIURIs. TODO: Fix the property names from v57.</span>
<a href="#l14.754"></a><span id="l14.754" class="difflineplus">+      for (let { uri: url, title } of this._URIs) {</span>
<a href="#l14.755"></a><span id="l14.755" class="difflineplus">+        await PlacesTransactions.NewBookmark({ parentGuid: itemGuid, url, title })</span>
<a href="#l14.756"></a><span id="l14.756" class="difflineplus">+                                .transact();</span>
<a href="#l14.757"></a><span id="l14.757" class="difflineplus">+      }</span>
<a href="#l14.758"></a><span id="l14.758" class="difflineplus">+    } else {</span>
<a href="#l14.759"></a><span id="l14.759" class="difflineplus">+      throw new Error(`unexpected value for _itemType:  ${this._itemType}`);</span>
<a href="#l14.760"></a><span id="l14.760" class="difflineplus">+    }</span>
<a href="#l14.761"></a><span id="l14.761" class="difflineplus">+</span>
<a href="#l14.762"></a><span id="l14.762" class="difflineplus">+    this._itemGuid = itemGuid;</span>
<a href="#l14.763"></a><span id="l14.763" class="difflineplus">+    this._itemId = await PlacesUtils.promiseItemId(itemGuid);</span>
<a href="#l14.764"></a><span id="l14.764" class="difflineplus">+    return Object.freeze({</span>
<a href="#l14.765"></a><span id="l14.765" class="difflineplus">+      itemId: this._itemId,</span>
<a href="#l14.766"></a><span id="l14.766" class="difflineplus">+      bookmarkGuid: this._itemGuid,</span>
<a href="#l14.767"></a><span id="l14.767" class="difflineplus">+      title: this._title,</span>
<a href="#l14.768"></a><span id="l14.768" class="difflineplus">+      uri: this._uri ? this._uri.spec : &quot;&quot;,</span>
<a href="#l14.769"></a><span id="l14.769" class="difflineplus">+      type: this._itemType == BOOKMARK_ITEM ?</span>
<a href="#l14.770"></a><span id="l14.770" class="difflineplus">+              Ci.nsINavHistoryResultNode.RESULT_TYPE_URI :</span>
<a href="#l14.771"></a><span id="l14.771" class="difflineplus">+              Ci.nsINavHistoryResultNode.RESULT_TYPE_FOLDER,</span>
<a href="#l14.772"></a><span id="l14.772" class="difflineplus">+      parent: {</span>
<a href="#l14.773"></a><span id="l14.773" class="difflineplus">+        itemId: containerId,</span>
<a href="#l14.774"></a><span id="l14.774" class="difflineplus">+        bookmarkGuid: parentGuid,</span>
<a href="#l14.775"></a><span id="l14.775" class="difflineplus">+        type: Ci.nsINavHistoryResultNode.RESULT_TYPE_FOLDER</span>
<a href="#l14.776"></a><span id="l14.776" class="difflineplus">+      }</span>
<a href="#l14.777"></a><span id="l14.777" class="difflineplus">+    });</span>
<a href="#l14.778"></a><span id="l14.778">   }</span>
<a href="#l14.779"></a><span id="l14.779"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/suite/common/places/content/bookmarkProperties.xul</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/suite/common/places/content/bookmarkProperties.xul</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -1,43 +1,43 @@</span>
<a href="#l15.4"></a><span id="l15.4"> &lt;?xml version=&quot;1.0&quot;?&gt;</span>
<a href="#l15.5"></a><span id="l15.5"> </span>
<a href="#l15.6"></a><span id="l15.6"> &lt;!-- This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l15.7"></a><span id="l15.7">    - License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l15.8"></a><span id="l15.8">    - file, You can obtain one at http://mozilla.org/MPL/2.0/. --&gt;</span>
<a href="#l15.9"></a><span id="l15.9"> </span>
<a href="#l15.10"></a><span id="l15.10"> &lt;?xml-stylesheet href=&quot;chrome://communicator/skin/&quot;?&gt;</span>
<a href="#l15.11"></a><span id="l15.11"> &lt;?xml-stylesheet href=&quot;chrome://communicator/content/places/places.css&quot;?&gt;</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-&lt;?xml-stylesheet href=&quot;chrome://communicator/skin/bookmarks/editBookmarkOverlay.css&quot;?&gt;</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineminus">-&lt;?xml-stylesheet href=&quot;chrome://communicator/skin/bookmarks/bookmarks.css&quot;?&gt;</span>
<a href="#l15.14"></a><span id="l15.14" class="difflineplus">+&lt;?xml-stylesheet href=&quot;chrome://communicator/skin/places/editBookmarkOverlay.css&quot;?&gt;</span>
<a href="#l15.15"></a><span id="l15.15" class="difflineplus">+&lt;?xml-stylesheet href=&quot;chrome://communicator/skin/places/bookmarks.css&quot;?&gt;</span>
<a href="#l15.16"></a><span id="l15.16"> </span>
<a href="#l15.17"></a><span id="l15.17" class="difflineminus">-&lt;?xul-overlay href=&quot;chrome://communicator/content/bookmarks/placesOverlay.xul&quot;?&gt;</span>
<a href="#l15.18"></a><span id="l15.18" class="difflineminus">-&lt;?xul-overlay href=&quot;chrome://communicator/content/bookmarks/editBookmarkOverlay.xul&quot;?&gt;</span>
<a href="#l15.19"></a><span id="l15.19" class="difflineplus">+&lt;?xul-overlay href=&quot;chrome://communicator/content/places/placesOverlay.xul&quot;?&gt;</span>
<a href="#l15.20"></a><span id="l15.20" class="difflineplus">+&lt;?xul-overlay href=&quot;chrome://communicator/content/places/editBookmarkOverlay.xul&quot;?&gt;</span>
<a href="#l15.21"></a><span id="l15.21"> </span>
<a href="#l15.22"></a><span id="l15.22"> &lt;!DOCTYPE dialog [</span>
<a href="#l15.23"></a><span id="l15.23" class="difflineminus">-  &lt;!ENTITY % editBookmarkOverlayDTD SYSTEM &quot;chrome://communicator/locale/bookmarks/editBookmarkOverlay.dtd&quot;&gt;</span>
<a href="#l15.24"></a><span id="l15.24" class="difflineplus">+  &lt;!ENTITY % editBookmarkOverlayDTD SYSTEM &quot;chrome://communicator/locale/places/editBookmarkOverlay.dtd&quot;&gt;</span>
<a href="#l15.25"></a><span id="l15.25">   %editBookmarkOverlayDTD;</span>
<a href="#l15.26"></a><span id="l15.26"> ]&gt;</span>
<a href="#l15.27"></a><span id="l15.27"> </span>
<a href="#l15.28"></a><span id="l15.28"> &lt;dialog id=&quot;bookmarkproperties&quot;</span>
<a href="#l15.29"></a><span id="l15.29">         buttons=&quot;accept, cancel&quot;</span>
<a href="#l15.30"></a><span id="l15.30">         buttoniconaccept=&quot;save&quot;</span>
<a href="#l15.31"></a><span id="l15.31">         ondialogaccept=&quot;BookmarkPropertiesPanel.onDialogAccept();&quot;</span>
<a href="#l15.32"></a><span id="l15.32">         ondialogcancel=&quot;BookmarkPropertiesPanel.onDialogCancel();&quot;</span>
<a href="#l15.33"></a><span id="l15.33">         xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;</span>
<a href="#l15.34"></a><span id="l15.34">         onload=&quot;BookmarkPropertiesPanel.onDialogLoad();&quot;</span>
<a href="#l15.35"></a><span id="l15.35">         onunload=&quot;BookmarkPropertiesPanel.onDialogUnload();&quot;</span>
<a href="#l15.36"></a><span id="l15.36">         style=&quot;min-width: 30em;&quot;</span>
<a href="#l15.37"></a><span id="l15.37" class="difflineminus">-        persist=&quot;screenX screenY height width&quot;&gt;</span>
<a href="#l15.38"></a><span id="l15.38" class="difflineplus">+        persist=&quot;screenX screenY width&quot;&gt;</span>
<a href="#l15.39"></a><span id="l15.39"> </span>
<a href="#l15.40"></a><span id="l15.40">   &lt;stringbundleset id=&quot;stringbundleset&quot;&gt;</span>
<a href="#l15.41"></a><span id="l15.41">     &lt;stringbundle id=&quot;stringBundle&quot;</span>
<a href="#l15.42"></a><span id="l15.42" class="difflineminus">-                  src=&quot;chrome://communicator/locale/bookmarks/bm-props.properties&quot;/&gt;</span>
<a href="#l15.43"></a><span id="l15.43" class="difflineplus">+                  src=&quot;chrome://communicator/locale/places/bookmarkProperties.properties&quot;/&gt;</span>
<a href="#l15.44"></a><span id="l15.44">   &lt;/stringbundleset&gt;</span>
<a href="#l15.45"></a><span id="l15.45"> </span>
<a href="#l15.46"></a><span id="l15.46">   &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l15.47"></a><span id="l15.47" class="difflineminus">-          src=&quot;chrome://communicator/content/bookmarks/editBookmarkOverlay.js&quot;/&gt;</span>
<a href="#l15.48"></a><span id="l15.48" class="difflineplus">+          src=&quot;chrome://communicator/content/places/editBookmarkOverlay.js&quot;/&gt;</span>
<a href="#l15.49"></a><span id="l15.49">   &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l15.50"></a><span id="l15.50" class="difflineminus">-          src=&quot;chrome://communicator/content/bookmarks/bm-props.js&quot;/&gt;</span>
<a href="#l15.51"></a><span id="l15.51" class="difflineplus">+          src=&quot;chrome://communicator/content/places/bookmarkProperties.js&quot;/&gt;</span>
<a href="#l15.52"></a><span id="l15.52"> </span>
<a href="#l15.53"></a><span id="l15.53"> &lt;vbox id=&quot;editBookmarkPanelContent&quot;/&gt;</span>
<a href="#l15.54"></a><span id="l15.54"> </span>
<a href="#l15.55"></a><span id="l15.55"> &lt;/dialog&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/suite/common/places/content/bookmarksPanel.js</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/suite/common/places/content/bookmarksPanel.js</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -1,20 +1,24 @@</span>
<a href="#l16.4"></a><span id="l16.4" class="difflineplus">+/* -*- indent-tabs-mode: nil; js-indent-level: 2 -*- */</span>
<a href="#l16.5"></a><span id="l16.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l16.6"></a><span id="l16.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l16.7"></a><span id="l16.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l16.8"></a><span id="l16.8"> </span>
<a href="#l16.9"></a><span id="l16.9"> function init() {</span>
<a href="#l16.10"></a><span id="l16.10">   document.getElementById(&quot;bookmarks-view&quot;).place =</span>
<a href="#l16.11"></a><span id="l16.11" class="difflineminus">-    &quot;place:queryType=1&amp;folder=&quot; + PlacesUIUtils.allBookmarksFolderId;</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineplus">+    &quot;place:queryType=1&amp;folder=&quot; + window.top.PlacesUIUtils.allBookmarksFolderId;</span>
<a href="#l16.13"></a><span id="l16.13"> }</span>
<a href="#l16.14"></a><span id="l16.14"> </span>
<a href="#l16.15"></a><span id="l16.15"> function searchBookmarks(aSearchString) {</span>
<a href="#l16.16"></a><span id="l16.16" class="difflineminus">-  var tree = document.getElementById('bookmarks-view');</span>
<a href="#l16.17"></a><span id="l16.17" class="difflineplus">+  var tree = document.getElementById(&quot;bookmarks-view&quot;);</span>
<a href="#l16.18"></a><span id="l16.18">   if (!aSearchString)</span>
<a href="#l16.19"></a><span id="l16.19">     tree.place = tree.place;</span>
<a href="#l16.20"></a><span id="l16.20">   else</span>
<a href="#l16.21"></a><span id="l16.21">     tree.applyFilter(aSearchString,</span>
<a href="#l16.22"></a><span id="l16.22">                      [PlacesUtils.bookmarksMenuFolderId,</span>
<a href="#l16.23"></a><span id="l16.23">                       PlacesUtils.unfiledBookmarksFolderId,</span>
<a href="#l16.24"></a><span id="l16.24" class="difflineminus">-                      PlacesUtils.toolbarFolderId]);</span>
<a href="#l16.25"></a><span id="l16.25" class="difflineplus">+                      PlacesUtils.toolbarFolderId,</span>
<a href="#l16.26"></a><span id="l16.26" class="difflineplus">+                      PlacesUtils.mobileFolderId]);</span>
<a href="#l16.27"></a><span id="l16.27"> }</span>
<a href="#l16.28"></a><span id="l16.28"> </span>
<a href="#l16.29"></a><span id="l16.29" class="difflineplus">+window.addEventListener(&quot;SidebarFocused&quot;,</span>
<a href="#l16.30"></a><span id="l16.30" class="difflineplus">+                        () =&gt; document.getElementById(&quot;search-box&quot;).focus());</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/suite/common/places/content/bookmarksPanel.xul</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/suite/common/places/content/bookmarksPanel.xul</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -1,48 +1,46 @@</span>
<a href="#l17.4"></a><span id="l17.4" class="difflineminus">-&lt;?xml version=&quot;1.0&quot;?&gt;</span>
<a href="#l17.5"></a><span id="l17.5" class="difflineminus">-</span>
<a href="#l17.6"></a><span id="l17.6" class="difflineplus">+&lt;?xml version=&quot;1.0&quot;?&gt; &lt;!-- -*- Mode: SGML; indent-tabs-mode: nil; -*- --&gt;</span>
<a href="#l17.7"></a><span id="l17.7"> &lt;!-- This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l17.8"></a><span id="l17.8">    - License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l17.9"></a><span id="l17.9">    - file, You can obtain one at http://mozilla.org/MPL/2.0/. --&gt;</span>
<a href="#l17.10"></a><span id="l17.10"> </span>
<a href="#l17.11"></a><span id="l17.11"> &lt;?xml-stylesheet href=&quot;chrome://communicator/skin/&quot; type=&quot;text/css&quot;?&gt;</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineplus">+&lt;?xml-stylesheet href=&quot;chrome://communicator/skin/sidebar/sidebarListView.css&quot; type=&quot;text/css&quot;?&gt;</span>
<a href="#l17.13"></a><span id="l17.13"> &lt;?xml-stylesheet href=&quot;chrome://communicator/content/places/places.css&quot;?&gt;</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineminus">-&lt;?xml-stylesheet href=&quot;chrome://communicator/skin/sidebar/sidebarListView.css&quot; type=&quot;text/css&quot;?&gt;</span>
<a href="#l17.15"></a><span id="l17.15" class="difflineminus">-&lt;?xml-stylesheet href=&quot;chrome://communicator/skin/bookmarks/bookmarks.css&quot;?&gt;</span>
<a href="#l17.16"></a><span id="l17.16" class="difflineplus">+&lt;?xml-stylesheet href=&quot;chrome://communicator/skin/places/bookmarks.css&quot;?&gt;</span>
<a href="#l17.17"></a><span id="l17.17"> </span>
<a href="#l17.18"></a><span id="l17.18"> &lt;?xul-overlay href=&quot;chrome://global/content/editMenuOverlay.xul&quot;?&gt;</span>
<a href="#l17.19"></a><span id="l17.19" class="difflineminus">-&lt;?xul-overlay href=&quot;chrome://communicator/content/bookmarks/placesOverlay.xul&quot;?&gt;</span>
<a href="#l17.20"></a><span id="l17.20" class="difflineplus">+&lt;?xul-overlay href=&quot;chrome://communicator/content/places/placesOverlay.xul&quot;?&gt;</span>
<a href="#l17.21"></a><span id="l17.21"> &lt;?xul-overlay href=&quot;chrome://communicator/content/utilityOverlay.xul&quot;?&gt;</span>
<a href="#l17.22"></a><span id="l17.22"> </span>
<a href="#l17.23"></a><span id="l17.23" class="difflineminus">-&lt;!DOCTYPE page SYSTEM &quot;chrome://communicator/locale/bookmarks/places.dtd&quot;&gt;</span>
<a href="#l17.24"></a><span id="l17.24" class="difflineplus">+&lt;!DOCTYPE page SYSTEM &quot;chrome://communicator/locale/places/places.dtd&quot;&gt;</span>
<a href="#l17.25"></a><span id="l17.25"> </span>
<a href="#l17.26"></a><span id="l17.26"> &lt;page id=&quot;bookmarksPanel&quot;</span>
<a href="#l17.27"></a><span id="l17.27">       xmlns:rdf=&quot;http://www.w3.org/1999/02/22-rdf-syntax-ns#&quot;</span>
<a href="#l17.28"></a><span id="l17.28">       xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;</span>
<a href="#l17.29"></a><span id="l17.29">       onload=&quot;init();&quot;</span>
<a href="#l17.30"></a><span id="l17.30" class="difflineminus">-      onunload=&quot;SidebarUtils.setMouseoverURL('');&quot;</span>
<a href="#l17.31"></a><span id="l17.31" class="difflineminus">-      elementtofocus=&quot;search-box&quot;&gt;</span>
<a href="#l17.32"></a><span id="l17.32" class="difflineplus">+      onunload=&quot;SidebarUtils.setMouseoverURL('');&quot;&gt;</span>
<a href="#l17.33"></a><span id="l17.33"> </span>
<a href="#l17.34"></a><span id="l17.34">   &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l17.35"></a><span id="l17.35" class="difflineminus">-          src=&quot;chrome://communicator/content/places/sidebarUtils.js&quot;/&gt;</span>
<a href="#l17.36"></a><span id="l17.36" class="difflineplus">+          src=&quot;chrome://communicator/content/bookmarks/sidebarUtils.js&quot;/&gt;</span>
<a href="#l17.37"></a><span id="l17.37">   &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l17.38"></a><span id="l17.38" class="difflineminus">-          src=&quot;chrome://communicator/content/bookmarks/bm-panel.js&quot;/&gt;</span>
<a href="#l17.39"></a><span id="l17.39" class="difflineplus">+          src=&quot;chrome://communicator/content/bookmarks/bookmarksPanel.js&quot;/&gt;</span>
<a href="#l17.40"></a><span id="l17.40"> </span>
<a href="#l17.41"></a><span id="l17.41">   &lt;commandset id=&quot;placesCommands&quot;/&gt;</span>
<a href="#l17.42"></a><span id="l17.42">   &lt;commandset id=&quot;editMenuCommands&quot;/&gt;</span>
<a href="#l17.43"></a><span id="l17.43">   &lt;menupopup id=&quot;placesContext&quot;/&gt;</span>
<a href="#l17.44"></a><span id="l17.44"> </span>
<a href="#l17.45"></a><span id="l17.45">   &lt;!-- Bookmarks and history tooltip --&gt;</span>
<a href="#l17.46"></a><span id="l17.46">   &lt;tooltip id=&quot;bhTooltip&quot;/&gt;</span>
<a href="#l17.47"></a><span id="l17.47"> </span>
<a href="#l17.48"></a><span id="l17.48">   &lt;hbox id=&quot;sidebar-search-container&quot; align=&quot;center&quot;&gt;</span>
<a href="#l17.49"></a><span id="l17.49" class="difflineminus">-    &lt;textbox id=&quot;search-box&quot; flex=&quot;1&quot; type=&quot;search&quot; class=&quot;compact&quot;</span>
<a href="#l17.50"></a><span id="l17.50" class="difflineplus">+    &lt;textbox id=&quot;search-box&quot; flex=&quot;1&quot; type=&quot;search&quot;</span>
<a href="#l17.51"></a><span id="l17.51" class="difflineplus">+             placeholder=&quot;&amp;search.placeholder;&quot;</span>
<a href="#l17.52"></a><span id="l17.52">              aria-controls=&quot;bookmarks-view&quot;</span>
<a href="#l17.53"></a><span id="l17.53" class="difflineminus">-             placeholder=&quot;&amp;search.placeholder;&quot;</span>
<a href="#l17.54"></a><span id="l17.54">              oncommand=&quot;searchBookmarks(this.value);&quot;/&gt;</span>
<a href="#l17.55"></a><span id="l17.55">   &lt;/hbox&gt;</span>
<a href="#l17.56"></a><span id="l17.56"> </span>
<a href="#l17.57"></a><span id="l17.57">   &lt;tree id=&quot;bookmarks-view&quot; class=&quot;sidebar-placesTree&quot; type=&quot;places&quot;</span>
<a href="#l17.58"></a><span id="l17.58">         flex=&quot;1&quot;</span>
<a href="#l17.59"></a><span id="l17.59">         hidecolumnpicker=&quot;true&quot;</span>
<a href="#l17.60"></a><span id="l17.60">         treelines=&quot;true&quot;</span>
<a href="#l17.61"></a><span id="l17.61">         context=&quot;placesContext&quot;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/suite/common/places/content/browserPlacesViews.js</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/suite/common/places/content/browserPlacesViews.js</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -1,32 +1,40 @@</span>
<a href="#l18.4"></a><span id="l18.4" class="difflineminus">-/* -*- Mode: C++; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l18.5"></a><span id="l18.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l18.6"></a><span id="l18.6" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l18.7"></a><span id="l18.7" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l18.8"></a><span id="l18.8" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l18.9"></a><span id="l18.9" class="difflineplus">+ * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l18.10"></a><span id="l18.10"> </span>
<a href="#l18.11"></a><span id="l18.11" class="difflineminus">-ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineplus">+/* eslint-env mozilla/browser-window */</span>
<a href="#l18.13"></a><span id="l18.13"> </span>
<a href="#l18.14"></a><span id="l18.14"> /**</span>
<a href="#l18.15"></a><span id="l18.15">  * The base view implements everything that's common to the toolbar and</span>
<a href="#l18.16"></a><span id="l18.16">  * menu views.</span>
<a href="#l18.17"></a><span id="l18.17">  */</span>
<a href="#l18.18"></a><span id="l18.18" class="difflineminus">-function PlacesViewBase(aPlace) {</span>
<a href="#l18.19"></a><span id="l18.19" class="difflineplus">+function PlacesViewBase(aPlace, aOptions = {}) {</span>
<a href="#l18.20"></a><span id="l18.20" class="difflineplus">+  if (&quot;rootElt&quot; in aOptions)</span>
<a href="#l18.21"></a><span id="l18.21" class="difflineplus">+    this._rootElt = aOptions.rootElt;</span>
<a href="#l18.22"></a><span id="l18.22" class="difflineplus">+  if (&quot;viewElt&quot; in aOptions)</span>
<a href="#l18.23"></a><span id="l18.23" class="difflineplus">+    this._viewElt = aOptions.viewElt;</span>
<a href="#l18.24"></a><span id="l18.24" class="difflineplus">+  this.options = aOptions;</span>
<a href="#l18.25"></a><span id="l18.25" class="difflineplus">+  this._controller = new PlacesController(this);</span>
<a href="#l18.26"></a><span id="l18.26">   this.place = aPlace;</span>
<a href="#l18.27"></a><span id="l18.27" class="difflineminus">-  this._controller = new PlacesController(this);</span>
<a href="#l18.28"></a><span id="l18.28">   this._viewElt.controllers.appendController(this._controller);</span>
<a href="#l18.29"></a><span id="l18.29"> }</span>
<a href="#l18.30"></a><span id="l18.30"> </span>
<a href="#l18.31"></a><span id="l18.31"> PlacesViewBase.prototype = {</span>
<a href="#l18.32"></a><span id="l18.32">   // The xul element that holds the entire view.</span>
<a href="#l18.33"></a><span id="l18.33">   _viewElt: null,</span>
<a href="#l18.34"></a><span id="l18.34">   get viewElt() {</span>
<a href="#l18.35"></a><span id="l18.35">     return this._viewElt;</span>
<a href="#l18.36"></a><span id="l18.36">   },</span>
<a href="#l18.37"></a><span id="l18.37"> </span>
<a href="#l18.38"></a><span id="l18.38" class="difflineplus">+  get associatedElement() {</span>
<a href="#l18.39"></a><span id="l18.39" class="difflineplus">+    return this._viewElt;</span>
<a href="#l18.40"></a><span id="l18.40" class="difflineplus">+  },</span>
<a href="#l18.41"></a><span id="l18.41" class="difflineplus">+</span>
<a href="#l18.42"></a><span id="l18.42">   get controllers() {</span>
<a href="#l18.43"></a><span id="l18.43">     return this._viewElt.controllers;</span>
<a href="#l18.44"></a><span id="l18.44">   },</span>
<a href="#l18.45"></a><span id="l18.45"> </span>
<a href="#l18.46"></a><span id="l18.46">   // The xul element that represents the root container.</span>
<a href="#l18.47"></a><span id="l18.47">   _rootElt: null,</span>
<a href="#l18.48"></a><span id="l18.48"> </span>
<a href="#l18.49"></a><span id="l18.49">   // Set to true for views that are represented by native widgets (i.e.</span>
<a href="#l18.50"></a><span id="l18.50" class="difflineat">@@ -76,25 +84,39 @@ PlacesViewBase.prototype = {</span>
<a href="#l18.51"></a><span id="l18.51">     if (val) {</span>
<a href="#l18.52"></a><span id="l18.52">       this._resultNode = val.root;</span>
<a href="#l18.53"></a><span id="l18.53">       this._rootElt._placesNode = this._resultNode;</span>
<a href="#l18.54"></a><span id="l18.54">       this._domNodes = new Map();</span>
<a href="#l18.55"></a><span id="l18.55">       this._domNodes.set(this._resultNode, this._rootElt);</span>
<a href="#l18.56"></a><span id="l18.56"> </span>
<a href="#l18.57"></a><span id="l18.57">       // This calls _rebuild through invalidateContainer.</span>
<a href="#l18.58"></a><span id="l18.58">       this._resultNode.containerOpen = true;</span>
<a href="#l18.59"></a><span id="l18.59" class="difflineminus">-    }</span>
<a href="#l18.60"></a><span id="l18.60" class="difflineminus">-    else {</span>
<a href="#l18.61"></a><span id="l18.61" class="difflineplus">+    } else {</span>
<a href="#l18.62"></a><span id="l18.62">       this._resultNode = null;</span>
<a href="#l18.63"></a><span id="l18.63">       delete this._domNodes;</span>
<a href="#l18.64"></a><span id="l18.64">     }</span>
<a href="#l18.65"></a><span id="l18.65"> </span>
<a href="#l18.66"></a><span id="l18.66">     return val;</span>
<a href="#l18.67"></a><span id="l18.67">   },</span>
<a href="#l18.68"></a><span id="l18.68"> </span>
<a href="#l18.69"></a><span id="l18.69" class="difflineplus">+  _options: null,</span>
<a href="#l18.70"></a><span id="l18.70" class="difflineplus">+  get options() {</span>
<a href="#l18.71"></a><span id="l18.71" class="difflineplus">+    return this._options;</span>
<a href="#l18.72"></a><span id="l18.72" class="difflineplus">+  },</span>
<a href="#l18.73"></a><span id="l18.73" class="difflineplus">+  set options(val) {</span>
<a href="#l18.74"></a><span id="l18.74" class="difflineplus">+    if (!val)</span>
<a href="#l18.75"></a><span id="l18.75" class="difflineplus">+      val = {};</span>
<a href="#l18.76"></a><span id="l18.76" class="difflineplus">+</span>
<a href="#l18.77"></a><span id="l18.77" class="difflineplus">+    if (!(&quot;extraClasses&quot; in val))</span>
<a href="#l18.78"></a><span id="l18.78" class="difflineplus">+      val.extraClasses = {};</span>
<a href="#l18.79"></a><span id="l18.79" class="difflineplus">+    this._options = val;</span>
<a href="#l18.80"></a><span id="l18.80" class="difflineplus">+</span>
<a href="#l18.81"></a><span id="l18.81" class="difflineplus">+    return val;</span>
<a href="#l18.82"></a><span id="l18.82" class="difflineplus">+  },</span>
<a href="#l18.83"></a><span id="l18.83" class="difflineplus">+</span>
<a href="#l18.84"></a><span id="l18.84">   /**</span>
<a href="#l18.85"></a><span id="l18.85">    * Gets the DOM node used for the given places node.</span>
<a href="#l18.86"></a><span id="l18.86">    *</span>
<a href="#l18.87"></a><span id="l18.87">    * @param aPlacesNode</span>
<a href="#l18.88"></a><span id="l18.88">    *        a places result node.</span>
<a href="#l18.89"></a><span id="l18.89">    * @throws if there is no DOM node set for aPlacesNode.</span>
<a href="#l18.90"></a><span id="l18.90">    */</span>
<a href="#l18.91"></a><span id="l18.91">   _getDOMNodeForPlacesNode:</span>
<a href="#l18.92"></a><span id="l18.92" class="difflineat">@@ -109,23 +131,30 @@ PlacesViewBase.prototype = {</span>
<a href="#l18.93"></a><span id="l18.93"> </span>
<a href="#l18.94"></a><span id="l18.94">   get controller() {</span>
<a href="#l18.95"></a><span id="l18.95">     return this._controller;</span>
<a href="#l18.96"></a><span id="l18.96">   },</span>
<a href="#l18.97"></a><span id="l18.97"> </span>
<a href="#l18.98"></a><span id="l18.98">   get selType() {</span>
<a href="#l18.99"></a><span id="l18.99">     return &quot;single&quot;;</span>
<a href="#l18.100"></a><span id="l18.100">   },</span>
<a href="#l18.101"></a><span id="l18.101" class="difflineminus">-  selectItems: function() { },</span>
<a href="#l18.102"></a><span id="l18.102" class="difflineminus">-  selectAll: function() { },</span>
<a href="#l18.103"></a><span id="l18.103" class="difflineplus">+  selectItems() { },</span>
<a href="#l18.104"></a><span id="l18.104" class="difflineplus">+  selectAll() { },</span>
<a href="#l18.105"></a><span id="l18.105"> </span>
<a href="#l18.106"></a><span id="l18.106">   get selectedNode() {</span>
<a href="#l18.107"></a><span id="l18.107">     if (this._contextMenuShown) {</span>
<a href="#l18.108"></a><span id="l18.108" class="difflineminus">-      let popup = document.popupNode;</span>
<a href="#l18.109"></a><span id="l18.109" class="difflineminus">-      return popup._placesNode || popup.parentNode._placesNode || null;</span>
<a href="#l18.110"></a><span id="l18.110" class="difflineplus">+      let anchor = this._contextMenuShown.triggerNode;</span>
<a href="#l18.111"></a><span id="l18.111" class="difflineplus">+      if (!anchor)</span>
<a href="#l18.112"></a><span id="l18.112" class="difflineplus">+        return null;</span>
<a href="#l18.113"></a><span id="l18.113" class="difflineplus">+</span>
<a href="#l18.114"></a><span id="l18.114" class="difflineplus">+      if (anchor._placesNode)</span>
<a href="#l18.115"></a><span id="l18.115" class="difflineplus">+        return this._rootElt == anchor ? null : anchor._placesNode;</span>
<a href="#l18.116"></a><span id="l18.116" class="difflineplus">+</span>
<a href="#l18.117"></a><span id="l18.117" class="difflineplus">+      anchor = anchor.parentNode;</span>
<a href="#l18.118"></a><span id="l18.118" class="difflineplus">+      return this._rootElt == anchor ? null : (anchor._placesNode || null);</span>
<a href="#l18.119"></a><span id="l18.119">     }</span>
<a href="#l18.120"></a><span id="l18.120">     return null;</span>
<a href="#l18.121"></a><span id="l18.121">   },</span>
<a href="#l18.122"></a><span id="l18.122"> </span>
<a href="#l18.123"></a><span id="l18.123">   get hasSelection() {</span>
<a href="#l18.124"></a><span id="l18.124">     return this.selectedNode != null;</span>
<a href="#l18.125"></a><span id="l18.125">   },</span>
<a href="#l18.126"></a><span id="l18.126"> </span>
<a href="#l18.127"></a><span id="l18.127" class="difflineat">@@ -157,210 +186,209 @@ PlacesViewBase.prototype = {</span>
<a href="#l18.128"></a><span id="l18.128">         PlacesUtils.asQuery(resultNode).queryOptions.queryType ==</span>
<a href="#l18.129"></a><span id="l18.129">           Ci.nsINavHistoryQueryOptions.QUERY_TYPE_HISTORY)</span>
<a href="#l18.130"></a><span id="l18.130">       return null;</span>
<a href="#l18.131"></a><span id="l18.131"> </span>
<a href="#l18.132"></a><span id="l18.132">     // By default, the insertion point is at the top level, at the end.</span>
<a href="#l18.133"></a><span id="l18.133">     let index = PlacesUtils.bookmarks.DEFAULT_INDEX;</span>
<a href="#l18.134"></a><span id="l18.134">     let container = this._resultNode;</span>
<a href="#l18.135"></a><span id="l18.135">     let orientation = Ci.nsITreeView.DROP_BEFORE;</span>
<a href="#l18.136"></a><span id="l18.136" class="difflineminus">-    let isTag = false;</span>
<a href="#l18.137"></a><span id="l18.137" class="difflineplus">+    let tagName = null;</span>
<a href="#l18.138"></a><span id="l18.138"> </span>
<a href="#l18.139"></a><span id="l18.139">     let selectedNode = this.selectedNode;</span>
<a href="#l18.140"></a><span id="l18.140">     if (selectedNode) {</span>
<a href="#l18.141"></a><span id="l18.141">       let popup = document.popupNode;</span>
<a href="#l18.142"></a><span id="l18.142" class="difflineminus">-      if (!popup._placesNode ||</span>
<a href="#l18.143"></a><span id="l18.143" class="difflineminus">-          popup._placesNode == this._resultNode ||</span>
<a href="#l18.144"></a><span id="l18.144" class="difflineminus">-          popup._placesNode.itemId == -1) {</span>
<a href="#l18.145"></a><span id="l18.145" class="difflineplus">+      if (!popup._placesNode || popup._placesNode == this._resultNode ||</span>
<a href="#l18.146"></a><span id="l18.146" class="difflineplus">+          popup._placesNode.itemId == -1 || !selectedNode.parent) {</span>
<a href="#l18.147"></a><span id="l18.147">         // If a static menuitem is selected, or if the root node is selected,</span>
<a href="#l18.148"></a><span id="l18.148">         // the insertion point is inside the folder, at the end.</span>
<a href="#l18.149"></a><span id="l18.149">         container = selectedNode;</span>
<a href="#l18.150"></a><span id="l18.150">         orientation = Ci.nsITreeView.DROP_ON;</span>
<a href="#l18.151"></a><span id="l18.151" class="difflineminus">-      }</span>
<a href="#l18.152"></a><span id="l18.152" class="difflineminus">-      else {</span>
<a href="#l18.153"></a><span id="l18.153" class="difflineplus">+      } else {</span>
<a href="#l18.154"></a><span id="l18.154">         // In all other cases the insertion point is before that node.</span>
<a href="#l18.155"></a><span id="l18.155">         container = selectedNode.parent;</span>
<a href="#l18.156"></a><span id="l18.156">         index = container.getChildIndex(selectedNode);</span>
<a href="#l18.157"></a><span id="l18.157" class="difflineminus">-        isTag = PlacesUtils.nodeIsTagQuery(container);</span>
<a href="#l18.158"></a><span id="l18.158" class="difflineplus">+        if (PlacesUtils.nodeIsTagQuery(container)) {</span>
<a href="#l18.159"></a><span id="l18.159" class="difflineplus">+          tagName = container.title;</span>
<a href="#l18.160"></a><span id="l18.160" class="difflineplus">+          // TODO (Bug 1160193): properly support dropping on a tag root.</span>
<a href="#l18.161"></a><span id="l18.161" class="difflineplus">+          if (!tagName)</span>
<a href="#l18.162"></a><span id="l18.162" class="difflineplus">+            return null;</span>
<a href="#l18.163"></a><span id="l18.163" class="difflineplus">+        }</span>
<a href="#l18.164"></a><span id="l18.164">       }</span>
<a href="#l18.165"></a><span id="l18.165">     }</span>
<a href="#l18.166"></a><span id="l18.166"> </span>
<a href="#l18.167"></a><span id="l18.167">     if (PlacesControllerDragHelper.disallowInsertion(container))</span>
<a href="#l18.168"></a><span id="l18.168">       return null;</span>
<a href="#l18.169"></a><span id="l18.169"> </span>
<a href="#l18.170"></a><span id="l18.170">     return new InsertionPoint(PlacesUtils.getConcreteItemId(container),</span>
<a href="#l18.171"></a><span id="l18.171" class="difflineminus">-                              index, orientation, isTag);</span>
<a href="#l18.172"></a><span id="l18.172" class="difflineplus">+                              index, orientation, tagName);</span>
<a href="#l18.173"></a><span id="l18.173">   },</span>
<a href="#l18.174"></a><span id="l18.174"> </span>
<a href="#l18.175"></a><span id="l18.175">   buildContextMenu: function PVB_buildContextMenu(aPopup) {</span>
<a href="#l18.176"></a><span id="l18.176" class="difflineminus">-    this._contextMenuShown = true;</span>
<a href="#l18.177"></a><span id="l18.177" class="difflineplus">+    this._contextMenuShown = aPopup;</span>
<a href="#l18.178"></a><span id="l18.178">     window.updateCommands(&quot;places&quot;);</span>
<a href="#l18.179"></a><span id="l18.179">     return this.controller.buildContextMenu(aPopup);</span>
<a href="#l18.180"></a><span id="l18.180">   },</span>
<a href="#l18.181"></a><span id="l18.181"> </span>
<a href="#l18.182"></a><span id="l18.182">   destroyContextMenu: function PVB_destroyContextMenu(aPopup) {</span>
<a href="#l18.183"></a><span id="l18.183" class="difflineminus">-    this._contextMenuShown = false;</span>
<a href="#l18.184"></a><span id="l18.184" class="difflineplus">+    this._contextMenuShown = null;</span>
<a href="#l18.185"></a><span id="l18.185" class="difflineplus">+  },</span>
<a href="#l18.186"></a><span id="l18.186" class="difflineplus">+</span>
<a href="#l18.187"></a><span id="l18.187" class="difflineplus">+  clearAllContents(aPopup) {</span>
<a href="#l18.188"></a><span id="l18.188" class="difflineplus">+    while (aPopup.firstChild) {</span>
<a href="#l18.189"></a><span id="l18.189" class="difflineplus">+      aPopup.firstChild.remove();</span>
<a href="#l18.190"></a><span id="l18.190" class="difflineplus">+    }</span>
<a href="#l18.191"></a><span id="l18.191" class="difflineplus">+    aPopup._emptyMenuitem = aPopup._startMarker = aPopup._endMarker = null;</span>
<a href="#l18.192"></a><span id="l18.192">   },</span>
<a href="#l18.193"></a><span id="l18.193"> </span>
<a href="#l18.194"></a><span id="l18.194" class="difflineminus">-  _cleanPopup: function PVB_cleanPopup(aPopup) {</span>
<a href="#l18.195"></a><span id="l18.195" class="difflineminus">-    // Remove places popup children and update markers to keep track of</span>
<a href="#l18.196"></a><span id="l18.196" class="difflineminus">-    // their indices.</span>
<a href="#l18.197"></a><span id="l18.197" class="difflineminus">-    let start = aPopup._startMarker != -1 ? aPopup._startMarker + 1 : 0;</span>
<a href="#l18.198"></a><span id="l18.198" class="difflineminus">-    let end = aPopup._endMarker != -1 ? aPopup._endMarker :</span>
<a href="#l18.199"></a><span id="l18.199" class="difflineminus">-                                        aPopup.childNodes.length;</span>
<a href="#l18.200"></a><span id="l18.200" class="difflineminus">-    let items = [];</span>
<a href="#l18.201"></a><span id="l18.201" class="difflineminus">-    let placesNodeFound = false;</span>
<a href="#l18.202"></a><span id="l18.202" class="difflineminus">-    for (let i = start; i &lt; end; ++i) {</span>
<a href="#l18.203"></a><span id="l18.203" class="difflineminus">-      let item = aPopup.childNodes[i];</span>
<a href="#l18.204"></a><span id="l18.204" class="difflineminus">-      if (item.getAttribute(&quot;builder&quot;) == &quot;end&quot;) {</span>
<a href="#l18.205"></a><span id="l18.205" class="difflineminus">-        // we need to do this for menus that have static content at the end but</span>
<a href="#l18.206"></a><span id="l18.206" class="difflineminus">-        // are initially empty, eg. the history menu, we need to know where to</span>
<a href="#l18.207"></a><span id="l18.207" class="difflineminus">-        // start inserting new items.</span>
<a href="#l18.208"></a><span id="l18.208" class="difflineminus">-        aPopup._endMarker = i;</span>
<a href="#l18.209"></a><span id="l18.209" class="difflineminus">-        break;</span>
<a href="#l18.210"></a><span id="l18.210" class="difflineplus">+  _cleanPopup: function PVB_cleanPopup(aPopup, aDelay) {</span>
<a href="#l18.211"></a><span id="l18.211" class="difflineplus">+    // Ensure markers are here when `invalidateContainer` is called before the</span>
<a href="#l18.212"></a><span id="l18.212" class="difflineplus">+    // popup is shown, which may the case for panelviews, for example.</span>
<a href="#l18.213"></a><span id="l18.213" class="difflineplus">+    this._ensureMarkers(aPopup);</span>
<a href="#l18.214"></a><span id="l18.214" class="difflineplus">+    // Remove Places nodes from the popup.</span>
<a href="#l18.215"></a><span id="l18.215" class="difflineplus">+    let child = aPopup._startMarker;</span>
<a href="#l18.216"></a><span id="l18.216" class="difflineplus">+    while (child.nextSibling != aPopup._endMarker) {</span>
<a href="#l18.217"></a><span id="l18.217" class="difflineplus">+      let sibling = child.nextSibling;</span>
<a href="#l18.218"></a><span id="l18.218" class="difflineplus">+      if (sibling._placesNode &amp;&amp; !aDelay) {</span>
<a href="#l18.219"></a><span id="l18.219" class="difflineplus">+        aPopup.removeChild(sibling);</span>
<a href="#l18.220"></a><span id="l18.220" class="difflineplus">+      } else if (sibling._placesNode &amp;&amp; aDelay) {</span>
<a href="#l18.221"></a><span id="l18.221" class="difflineplus">+        // HACK (bug 733419): the popups originating from the OS X native</span>
<a href="#l18.222"></a><span id="l18.222" class="difflineplus">+        // menubar don't live-update while open, thus we don't clean it</span>
<a href="#l18.223"></a><span id="l18.223" class="difflineplus">+        // until the next popupshowing, to avoid zombie menuitems.</span>
<a href="#l18.224"></a><span id="l18.224" class="difflineplus">+        if (!aPopup._delayedRemovals)</span>
<a href="#l18.225"></a><span id="l18.225" class="difflineplus">+          aPopup._delayedRemovals = [];</span>
<a href="#l18.226"></a><span id="l18.226" class="difflineplus">+        aPopup._delayedRemovals.push(sibling);</span>
<a href="#l18.227"></a><span id="l18.227" class="difflineplus">+        child = child.nextSibling;</span>
<a href="#l18.228"></a><span id="l18.228" class="difflineplus">+      } else {</span>
<a href="#l18.229"></a><span id="l18.229" class="difflineplus">+        child = child.nextSibling;</span>
<a href="#l18.230"></a><span id="l18.230">       }</span>
<a href="#l18.231"></a><span id="l18.231" class="difflineminus">-      if (item._placesNode) {</span>
<a href="#l18.232"></a><span id="l18.232" class="difflineminus">-        items.push(item);</span>
<a href="#l18.233"></a><span id="l18.233" class="difflineminus">-        placesNodeFound = true;</span>
<a href="#l18.234"></a><span id="l18.234" class="difflineminus">-      }</span>
<a href="#l18.235"></a><span id="l18.235" class="difflineminus">-      else {</span>
<a href="#l18.236"></a><span id="l18.236" class="difflineminus">-        // This is static content...</span>
<a href="#l18.237"></a><span id="l18.237" class="difflineminus">-        if (!placesNodeFound)</span>
<a href="#l18.238"></a><span id="l18.238" class="difflineminus">-          // ...at the start of the popup</span>
<a href="#l18.239"></a><span id="l18.239" class="difflineminus">-          // Initialized in menu.xml, in the base binding</span>
<a href="#l18.240"></a><span id="l18.240" class="difflineminus">-          aPopup._startMarker++;</span>
<a href="#l18.241"></a><span id="l18.241" class="difflineminus">-        else {</span>
<a href="#l18.242"></a><span id="l18.242" class="difflineminus">-          // ...after places nodes</span>
<a href="#l18.243"></a><span id="l18.243" class="difflineminus">-          aPopup._endMarker = i;</span>
<a href="#l18.244"></a><span id="l18.244" class="difflineminus">-          break;</span>
<a href="#l18.245"></a><span id="l18.245" class="difflineminus">-        }</span>
<a href="#l18.246"></a><span id="l18.246" class="difflineminus">-      }</span>
<a href="#l18.247"></a><span id="l18.247" class="difflineminus">-    }</span>
<a href="#l18.248"></a><span id="l18.248" class="difflineminus">-</span>
<a href="#l18.249"></a><span id="l18.249" class="difflineminus">-    for (let i = 0; i &lt; items.length; ++i) {</span>
<a href="#l18.250"></a><span id="l18.250" class="difflineminus">-      items[i].remove();</span>
<a href="#l18.251"></a><span id="l18.251" class="difflineminus">-      if (aPopup._endMarker != -1)</span>
<a href="#l18.252"></a><span id="l18.252" class="difflineminus">-        aPopup._endMarker--;</span>
<a href="#l18.253"></a><span id="l18.253">     }</span>
<a href="#l18.254"></a><span id="l18.254">   },</span>
<a href="#l18.255"></a><span id="l18.255"> </span>
<a href="#l18.256"></a><span id="l18.256">   _rebuildPopup: function PVB__rebuildPopup(aPopup) {</span>
<a href="#l18.257"></a><span id="l18.257" class="difflineminus">-    this._cleanPopup(aPopup);</span>
<a href="#l18.258"></a><span id="l18.258" class="difflineminus">-</span>
<a href="#l18.259"></a><span id="l18.259">     let resultNode = aPopup._placesNode;</span>
<a href="#l18.260"></a><span id="l18.260">     if (!resultNode.containerOpen)</span>
<a href="#l18.261"></a><span id="l18.261">       return;</span>
<a href="#l18.262"></a><span id="l18.262"> </span>
<a href="#l18.263"></a><span id="l18.263">     if (this.controller.hasCachedLivemarkInfo(resultNode)) {</span>
<a href="#l18.264"></a><span id="l18.264" class="difflineminus">-      aPopup.removeAttribute(&quot;emptyplacesresult&quot;);</span>
<a href="#l18.265"></a><span id="l18.265" class="difflineminus">-      if (aPopup._emptyMenuItem)</span>
<a href="#l18.266"></a><span id="l18.266" class="difflineminus">-        aPopup._emptyMenuItem.hidden = true;</span>
<a href="#l18.267"></a><span id="l18.267" class="difflineplus">+      this._setEmptyPopupStatus(aPopup, false);</span>
<a href="#l18.268"></a><span id="l18.268">       aPopup._built = true;</span>
<a href="#l18.269"></a><span id="l18.269">       this._populateLivemarkPopup(aPopup);</span>
<a href="#l18.270"></a><span id="l18.270">       return;</span>
<a href="#l18.271"></a><span id="l18.271">     }</span>
<a href="#l18.272"></a><span id="l18.272"> </span>
<a href="#l18.273"></a><span id="l18.273" class="difflineplus">+    this._cleanPopup(aPopup);</span>
<a href="#l18.274"></a><span id="l18.274" class="difflineplus">+</span>
<a href="#l18.275"></a><span id="l18.275">     let cc = resultNode.childCount;</span>
<a href="#l18.276"></a><span id="l18.276">     if (cc &gt; 0) {</span>
<a href="#l18.277"></a><span id="l18.277" class="difflineminus">-      aPopup.removeAttribute(&quot;emptyplacesresult&quot;);</span>
<a href="#l18.278"></a><span id="l18.278" class="difflineminus">-      if (aPopup._emptyMenuItem)</span>
<a href="#l18.279"></a><span id="l18.279" class="difflineminus">-        aPopup._emptyMenuItem.hidden = true;</span>
<a href="#l18.280"></a><span id="l18.280" class="difflineplus">+      this._setEmptyPopupStatus(aPopup, false);</span>
<a href="#l18.281"></a><span id="l18.281"> </span>
<a href="#l18.282"></a><span id="l18.282">       for (let i = 0; i &lt; cc; ++i) {</span>
<a href="#l18.283"></a><span id="l18.283">         let child = resultNode.getChild(i);</span>
<a href="#l18.284"></a><span id="l18.284">         this._insertNewItemToPopup(child, aPopup, null);</span>
<a href="#l18.285"></a><span id="l18.285">       }</span>
<a href="#l18.286"></a><span id="l18.286" class="difflineminus">-    }</span>
<a href="#l18.287"></a><span id="l18.287" class="difflineminus">-    else {</span>
<a href="#l18.288"></a><span id="l18.288" class="difflineminus">-      aPopup.setAttribute(&quot;emptyplacesresult&quot;, &quot;true&quot;);</span>
<a href="#l18.289"></a><span id="l18.289" class="difflineminus">-      // This menu is empty.  If there is no static content, add</span>
<a href="#l18.290"></a><span id="l18.290" class="difflineminus">-      // an element to show it is empty.</span>
<a href="#l18.291"></a><span id="l18.291" class="difflineminus">-      if (aPopup._startMarker == -1 &amp;&amp; aPopup._endMarker == -1)</span>
<a href="#l18.292"></a><span id="l18.292" class="difflineminus">-        this._showEmptyMenuItem(aPopup);</span>
<a href="#l18.293"></a><span id="l18.293" class="difflineplus">+    } else {</span>
<a href="#l18.294"></a><span id="l18.294" class="difflineplus">+      this._setEmptyPopupStatus(aPopup, true);</span>
<a href="#l18.295"></a><span id="l18.295">     }</span>
<a href="#l18.296"></a><span id="l18.296">     aPopup._built = true;</span>
<a href="#l18.297"></a><span id="l18.297">   },</span>
<a href="#l18.298"></a><span id="l18.298"> </span>
<a href="#l18.299"></a><span id="l18.299">   _removeChild: function PVB__removeChild(aChild) {</span>
<a href="#l18.300"></a><span id="l18.300">     // If document.popupNode pointed to this child, null it out,</span>
<a href="#l18.301"></a><span id="l18.301">     // otherwise controller's command-updating may rely on the removed</span>
<a href="#l18.302"></a><span id="l18.302">     // item still being &quot;selected&quot;.</span>
<a href="#l18.303"></a><span id="l18.303">     if (document.popupNode == aChild)</span>
<a href="#l18.304"></a><span id="l18.304">       document.popupNode = null;</span>
<a href="#l18.305"></a><span id="l18.305"> </span>
<a href="#l18.306"></a><span id="l18.306">     aChild.remove();</span>
<a href="#l18.307"></a><span id="l18.307">   },</span>
<a href="#l18.308"></a><span id="l18.308"> </span>
<a href="#l18.309"></a><span id="l18.309" class="difflineminus">-  _showEmptyMenuItem: function PVB__showEmptyMenuItem(aPopup) {</span>
<a href="#l18.310"></a><span id="l18.310" class="difflineminus">-    if (aPopup._emptyMenuItem) {</span>
<a href="#l18.311"></a><span id="l18.311" class="difflineminus">-      aPopup._emptyMenuItem.hidden = false;</span>
<a href="#l18.312"></a><span id="l18.312" class="difflineminus">-      return;</span>
<a href="#l18.313"></a><span id="l18.313" class="difflineplus">+  _setEmptyPopupStatus:</span>
<a href="#l18.314"></a><span id="l18.314" class="difflineplus">+  function PVB__setEmptyPopupStatus(aPopup, aEmpty) {</span>
<a href="#l18.315"></a><span id="l18.315" class="difflineplus">+    if (!aPopup._emptyMenuitem) {</span>
<a href="#l18.316"></a><span id="l18.316" class="difflineplus">+      let label = PlacesUIUtils.getString(&quot;bookmarksMenuEmptyFolder&quot;);</span>
<a href="#l18.317"></a><span id="l18.317" class="difflineplus">+      aPopup._emptyMenuitem = document.createElement(&quot;menuitem&quot;);</span>
<a href="#l18.318"></a><span id="l18.318" class="difflineplus">+      aPopup._emptyMenuitem.setAttribute(&quot;label&quot;, label);</span>
<a href="#l18.319"></a><span id="l18.319" class="difflineplus">+      aPopup._emptyMenuitem.setAttribute(&quot;disabled&quot;, true);</span>
<a href="#l18.320"></a><span id="l18.320" class="difflineplus">+      aPopup._emptyMenuitem.className = &quot;bookmark-item&quot;;</span>
<a href="#l18.321"></a><span id="l18.321" class="difflineplus">+      if (typeof this.options.extraClasses.entry == &quot;string&quot;)</span>
<a href="#l18.322"></a><span id="l18.322" class="difflineplus">+        aPopup._emptyMenuitem.classList.add(this.options.extraClasses.entry);</span>
<a href="#l18.323"></a><span id="l18.323">     }</span>
<a href="#l18.324"></a><span id="l18.324"> </span>
<a href="#l18.325"></a><span id="l18.325" class="difflineminus">-    let label = PlacesUIUtils.getString(&quot;bookmarksMenuEmptyFolder&quot;);</span>
<a href="#l18.326"></a><span id="l18.326" class="difflineminus">-    aPopup._emptyMenuItem = document.createElement(&quot;menuitem&quot;);</span>
<a href="#l18.327"></a><span id="l18.327" class="difflineminus">-    aPopup._emptyMenuItem.setAttribute(&quot;label&quot;, label);</span>
<a href="#l18.328"></a><span id="l18.328" class="difflineminus">-    aPopup._emptyMenuItem.setAttribute(&quot;disabled&quot;, true);</span>
<a href="#l18.329"></a><span id="l18.329" class="difflineminus">-    aPopup.appendChild(aPopup._emptyMenuItem);</span>
<a href="#l18.330"></a><span id="l18.330" class="difflineplus">+    if (aEmpty) {</span>
<a href="#l18.331"></a><span id="l18.331" class="difflineplus">+      aPopup.setAttribute(&quot;emptyplacesresult&quot;, &quot;true&quot;);</span>
<a href="#l18.332"></a><span id="l18.332" class="difflineplus">+      // Don't add the menuitem if there is static content.</span>
<a href="#l18.333"></a><span id="l18.333" class="difflineplus">+      if (!aPopup._startMarker.previousSibling &amp;&amp;</span>
<a href="#l18.334"></a><span id="l18.334" class="difflineplus">+          !aPopup._endMarker.nextSibling)</span>
<a href="#l18.335"></a><span id="l18.335" class="difflineplus">+        aPopup.insertBefore(aPopup._emptyMenuitem, aPopup._endMarker);</span>
<a href="#l18.336"></a><span id="l18.336" class="difflineplus">+    } else {</span>
<a href="#l18.337"></a><span id="l18.337" class="difflineplus">+      aPopup.removeAttribute(&quot;emptyplacesresult&quot;);</span>
<a href="#l18.338"></a><span id="l18.338" class="difflineplus">+      try {</span>
<a href="#l18.339"></a><span id="l18.339" class="difflineplus">+        aPopup.removeChild(aPopup._emptyMenuitem);</span>
<a href="#l18.340"></a><span id="l18.340" class="difflineplus">+      } catch (ex) {}</span>
<a href="#l18.341"></a><span id="l18.341" class="difflineplus">+    }</span>
<a href="#l18.342"></a><span id="l18.342">   },</span>
<a href="#l18.343"></a><span id="l18.343"> </span>
<a href="#l18.344"></a><span id="l18.344" class="difflineminus">-  _createMenuItemForPlacesNode:</span>
<a href="#l18.345"></a><span id="l18.345" class="difflineminus">-  function PVB__createMenuItemForPlacesNode(aPlacesNode) {</span>
<a href="#l18.346"></a><span id="l18.346" class="difflineplus">+  _createDOMNodeForPlacesNode:</span>
<a href="#l18.347"></a><span id="l18.347" class="difflineplus">+  function PVB__createDOMNodeForPlacesNode(aPlacesNode) {</span>
<a href="#l18.348"></a><span id="l18.348">     this._domNodes.delete(aPlacesNode);</span>
<a href="#l18.349"></a><span id="l18.349"> </span>
<a href="#l18.350"></a><span id="l18.350">     let element;</span>
<a href="#l18.351"></a><span id="l18.351">     let type = aPlacesNode.type;</span>
<a href="#l18.352"></a><span id="l18.352" class="difflineminus">-    if (type == Ci.nsINavHistoryResultNode.RESULT_TYPE_SEPARATOR)</span>
<a href="#l18.353"></a><span id="l18.353" class="difflineplus">+    if (type == Ci.nsINavHistoryResultNode.RESULT_TYPE_SEPARATOR) {</span>
<a href="#l18.354"></a><span id="l18.354">       element = document.createElement(&quot;menuseparator&quot;);</span>
<a href="#l18.355"></a><span id="l18.355" class="difflineminus">-    else {</span>
<a href="#l18.356"></a><span id="l18.356" class="difflineplus">+      element.setAttribute(&quot;class&quot;, &quot;small-separator&quot;);</span>
<a href="#l18.357"></a><span id="l18.357" class="difflineplus">+    } else {</span>
<a href="#l18.358"></a><span id="l18.358" class="difflineplus">+      let itemId = aPlacesNode.itemId;</span>
<a href="#l18.359"></a><span id="l18.359">       if (type == Ci.nsINavHistoryResultNode.RESULT_TYPE_URI) {</span>
<a href="#l18.360"></a><span id="l18.360">         element = document.createElement(&quot;menuitem&quot;);</span>
<a href="#l18.361"></a><span id="l18.361">         element.className = &quot;menuitem-iconic bookmark-item menuitem-with-favicon&quot;;</span>
<a href="#l18.362"></a><span id="l18.362">         element.setAttribute(&quot;scheme&quot;,</span>
<a href="#l18.363"></a><span id="l18.363">                              PlacesUIUtils.guessUrlSchemeForUI(aPlacesNode.uri));</span>
<a href="#l18.364"></a><span id="l18.364" class="difflineminus">-      }</span>
<a href="#l18.365"></a><span id="l18.365" class="difflineminus">-      else if (PlacesUtils.containerTypes.indexOf(type) != -1) {</span>
<a href="#l18.366"></a><span id="l18.366" class="difflineplus">+      } else if (PlacesUtils.containerTypes.includes(type)) {</span>
<a href="#l18.367"></a><span id="l18.367">         element = document.createElement(&quot;menu&quot;);</span>
<a href="#l18.368"></a><span id="l18.368">         element.setAttribute(&quot;container&quot;, &quot;true&quot;);</span>
<a href="#l18.369"></a><span id="l18.369"> </span>
<a href="#l18.370"></a><span id="l18.370">         if (aPlacesNode.type == Ci.nsINavHistoryResultNode.RESULT_TYPE_QUERY) {</span>
<a href="#l18.371"></a><span id="l18.371">           element.setAttribute(&quot;query&quot;, &quot;true&quot;);</span>
<a href="#l18.372"></a><span id="l18.372">           if (PlacesUtils.nodeIsTagQuery(aPlacesNode))</span>
<a href="#l18.373"></a><span id="l18.373">             element.setAttribute(&quot;tagContainer&quot;, &quot;true&quot;);</span>
<a href="#l18.374"></a><span id="l18.374">           else if (PlacesUtils.nodeIsDay(aPlacesNode))</span>
<a href="#l18.375"></a><span id="l18.375">             element.setAttribute(&quot;dayContainer&quot;, &quot;true&quot;);</span>
<a href="#l18.376"></a><span id="l18.376">           else if (PlacesUtils.nodeIsHost(aPlacesNode))</span>
<a href="#l18.377"></a><span id="l18.377">             element.setAttribute(&quot;hostContainer&quot;, &quot;true&quot;);</span>
<a href="#l18.378"></a><span id="l18.378" class="difflineminus">-        }</span>
<a href="#l18.379"></a><span id="l18.379" class="difflineminus">-        else if (aPlacesNode.itemId != -1) {</span>
<a href="#l18.380"></a><span id="l18.380" class="difflineminus">-          PlacesUtils.livemarks.getLivemark({ id: aPlacesNode.itemId })</span>
<a href="#l18.381"></a><span id="l18.381" class="difflineminus">-                               .then(aLivemark =&gt; {</span>
<a href="#l18.382"></a><span id="l18.382" class="difflineminus">-            element.setAttribute(&quot;livemark&quot;, &quot;true&quot;);</span>
<a href="#l18.383"></a><span id="l18.383" class="difflineminus">-            this.controller.cacheLivemarkInfo(aPlacesNode, aLivemark);</span>
<a href="#l18.384"></a><span id="l18.384" class="difflineminus">-          }, () =&gt; undefined);</span>
<a href="#l18.385"></a><span id="l18.385" class="difflineplus">+        } else if (itemId != -1) {</span>
<a href="#l18.386"></a><span id="l18.386" class="difflineplus">+          PlacesUtils.livemarks.getLivemark({ id: itemId })</span>
<a href="#l18.387"></a><span id="l18.387" class="difflineplus">+            .then(aLivemark =&gt; {</span>
<a href="#l18.388"></a><span id="l18.388" class="difflineplus">+              element.setAttribute(&quot;livemark&quot;, &quot;true&quot;);</span>
<a href="#l18.389"></a><span id="l18.389" class="difflineplus">+              if (AppConstants.platform === &quot;macosx&quot;) {</span>
<a href="#l18.390"></a><span id="l18.390" class="difflineplus">+                // OS X native menubar doesn't track list-style-images since</span>
<a href="#l18.391"></a><span id="l18.391" class="difflineplus">+                // it doesn't have a frame (bug 733415).  Thus enforce updating.</span>
<a href="#l18.392"></a><span id="l18.392" class="difflineplus">+                element.setAttribute(&quot;image&quot;, &quot;&quot;);</span>
<a href="#l18.393"></a><span id="l18.393" class="difflineplus">+                element.removeAttribute(&quot;image&quot;);</span>
<a href="#l18.394"></a><span id="l18.394" class="difflineplus">+              }</span>
<a href="#l18.395"></a><span id="l18.395" class="difflineplus">+              this.controller.cacheLivemarkInfo(aPlacesNode, aLivemark);</span>
<a href="#l18.396"></a><span id="l18.396" class="difflineplus">+            }, () =&gt; undefined);</span>
<a href="#l18.397"></a><span id="l18.397">         }</span>
<a href="#l18.398"></a><span id="l18.398"> </span>
<a href="#l18.399"></a><span id="l18.399">         let popup = document.createElement(&quot;menupopup&quot;);</span>
<a href="#l18.400"></a><span id="l18.400">         popup._placesNode = PlacesUtils.asContainer(aPlacesNode);</span>
<a href="#l18.401"></a><span id="l18.401" class="difflineminus">-        if (this._nativeView) {</span>
<a href="#l18.402"></a><span id="l18.402" class="difflineminus">-          popup._startMarker = -1;</span>
<a href="#l18.403"></a><span id="l18.403" class="difflineminus">-          popup._endMarker = -1;</span>
<a href="#l18.404"></a><span id="l18.404" class="difflineplus">+</span>
<a href="#l18.405"></a><span id="l18.405" class="difflineplus">+        if (!this._nativeView) {</span>
<a href="#l18.406"></a><span id="l18.406" class="difflineplus">+          popup.setAttribute(&quot;placespopup&quot;, &quot;true&quot;);</span>
<a href="#l18.407"></a><span id="l18.407">         }</span>
<a href="#l18.408"></a><span id="l18.408" class="difflineminus">-        else</span>
<a href="#l18.409"></a><span id="l18.409" class="difflineminus">-          popup.setAttribute(&quot;placespopup&quot;, &quot;true&quot;);</span>
<a href="#l18.410"></a><span id="l18.410" class="difflineminus">-#ifdef XP_MACOSX</span>
<a href="#l18.411"></a><span id="l18.411" class="difflineminus">-        // No context menu on mac.</span>
<a href="#l18.412"></a><span id="l18.412" class="difflineminus">-        popup.setAttribute(&quot;context&quot;, &quot;placesContext&quot;);</span>
<a href="#l18.413"></a><span id="l18.413" class="difflineminus">-#endif</span>
<a href="#l18.414"></a><span id="l18.414" class="difflineplus">+</span>
<a href="#l18.415"></a><span id="l18.415">         element.appendChild(popup);</span>
<a href="#l18.416"></a><span id="l18.416">         element.className = &quot;menu-iconic bookmark-item&quot;;</span>
<a href="#l18.417"></a><span id="l18.417" class="difflineplus">+        if (typeof this.options.extraClasses.entry == &quot;string&quot;) {</span>
<a href="#l18.418"></a><span id="l18.418" class="difflineplus">+          element.classList.add(this.options.extraClasses.entry);</span>
<a href="#l18.419"></a><span id="l18.419" class="difflineplus">+        }</span>
<a href="#l18.420"></a><span id="l18.420"> </span>
<a href="#l18.421"></a><span id="l18.421">         this._domNodes.set(aPlacesNode, popup);</span>
<a href="#l18.422"></a><span id="l18.422" class="difflineminus">-      }</span>
<a href="#l18.423"></a><span id="l18.423" class="difflineminus">-      else</span>
<a href="#l18.424"></a><span id="l18.424" class="difflineplus">+      } else</span>
<a href="#l18.425"></a><span id="l18.425">         throw &quot;Unexpected node&quot;;</span>
<a href="#l18.426"></a><span id="l18.426"> </span>
<a href="#l18.427"></a><span id="l18.427">       element.setAttribute(&quot;label&quot;, PlacesUIUtils.getBestTitle(aPlacesNode));</span>
<a href="#l18.428"></a><span id="l18.428"> </span>
<a href="#l18.429"></a><span id="l18.429">       let icon = aPlacesNode.icon;</span>
<a href="#l18.430"></a><span id="l18.430">       if (icon)</span>
<a href="#l18.431"></a><span id="l18.431">         element.setAttribute(&quot;image&quot;, icon);</span>
<a href="#l18.432"></a><span id="l18.432">     }</span>
<a href="#l18.433"></a><span id="l18.433" class="difflineat">@@ -369,119 +397,111 @@ PlacesViewBase.prototype = {</span>
<a href="#l18.434"></a><span id="l18.434">     if (!this._domNodes.has(aPlacesNode))</span>
<a href="#l18.435"></a><span id="l18.435">       this._domNodes.set(aPlacesNode, element);</span>
<a href="#l18.436"></a><span id="l18.436"> </span>
<a href="#l18.437"></a><span id="l18.437">     return element;</span>
<a href="#l18.438"></a><span id="l18.438">   },</span>
<a href="#l18.439"></a><span id="l18.439"> </span>
<a href="#l18.440"></a><span id="l18.440">   _insertNewItemToPopup:</span>
<a href="#l18.441"></a><span id="l18.441">   function PVB__insertNewItemToPopup(aNewChild, aPopup, aBefore) {</span>
<a href="#l18.442"></a><span id="l18.442" class="difflineminus">-    let element = this._createMenuItemForPlacesNode(aNewChild);</span>
<a href="#l18.443"></a><span id="l18.443" class="difflineplus">+    let element = this._createDOMNodeForPlacesNode(aNewChild);</span>
<a href="#l18.444"></a><span id="l18.444" class="difflineplus">+    let before = aBefore || aPopup._endMarker;</span>
<a href="#l18.445"></a><span id="l18.445"> </span>
<a href="#l18.446"></a><span id="l18.446" class="difflineminus">-    if (aBefore) {</span>
<a href="#l18.447"></a><span id="l18.447" class="difflineminus">-      aPopup.insertBefore(element, aBefore);</span>
<a href="#l18.448"></a><span id="l18.448" class="difflineminus">-    }</span>
<a href="#l18.449"></a><span id="l18.449" class="difflineminus">-    else {</span>
<a href="#l18.450"></a><span id="l18.450" class="difflineminus">-      // Add the new element to the menu.  If there is static content at</span>
<a href="#l18.451"></a><span id="l18.451" class="difflineminus">-      // the end of the menu, add the element before that.  Otherwise,</span>
<a href="#l18.452"></a><span id="l18.452" class="difflineminus">-      // just add to the end.</span>
<a href="#l18.453"></a><span id="l18.453" class="difflineminus">-      if (aPopup._endMarker != -1) {</span>
<a href="#l18.454"></a><span id="l18.454" class="difflineminus">-        let lastElt = aPopup.childNodes[aPopup._endMarker];</span>
<a href="#l18.455"></a><span id="l18.455" class="difflineminus">-        aPopup.insertBefore(element, lastElt);</span>
<a href="#l18.456"></a><span id="l18.456" class="difflineminus">-      }</span>
<a href="#l18.457"></a><span id="l18.457" class="difflineminus">-      else {</span>
<a href="#l18.458"></a><span id="l18.458" class="difflineminus">-        aPopup.appendChild(element);</span>
<a href="#l18.459"></a><span id="l18.459" class="difflineminus">-      }</span>
<a href="#l18.460"></a><span id="l18.460" class="difflineplus">+    if (element.localName == &quot;menuitem&quot; || element.localName == &quot;menu&quot;) {</span>
<a href="#l18.461"></a><span id="l18.461" class="difflineplus">+      if (typeof this.options.extraClasses.entry == &quot;string&quot;)</span>
<a href="#l18.462"></a><span id="l18.462" class="difflineplus">+        element.classList.add(this.options.extraClasses.entry);</span>
<a href="#l18.463"></a><span id="l18.463">     }</span>
<a href="#l18.464"></a><span id="l18.464"> </span>
<a href="#l18.465"></a><span id="l18.465" class="difflineminus">-    if (aPopup._endMarker != -1)</span>
<a href="#l18.466"></a><span id="l18.466" class="difflineminus">-      aPopup._endMarker++;</span>
<a href="#l18.467"></a><span id="l18.467" class="difflineminus">-</span>
<a href="#l18.468"></a><span id="l18.468" class="difflineplus">+    aPopup.insertBefore(element, before);</span>
<a href="#l18.469"></a><span id="l18.469">     return element;</span>
<a href="#l18.470"></a><span id="l18.470">   },</span>
<a href="#l18.471"></a><span id="l18.471"> </span>
<a href="#l18.472"></a><span id="l18.472">   _setLivemarkSiteURIMenuItem:</span>
<a href="#l18.473"></a><span id="l18.473">   function PVB__setLivemarkSiteURIMenuItem(aPopup) {</span>
<a href="#l18.474"></a><span id="l18.474">     let livemarkInfo = this.controller.getCachedLivemarkInfo(aPopup._placesNode);</span>
<a href="#l18.475"></a><span id="l18.475" class="difflineminus">-    let siteUrl = livemarkInfo &amp;&amp; livemarkInfo.siteURI &amp;&amp; livemarkInfo.siteURI.spec;</span>
<a href="#l18.476"></a><span id="l18.476" class="difflineplus">+    let siteUrl = livemarkInfo &amp;&amp; livemarkInfo.siteURI ?</span>
<a href="#l18.477"></a><span id="l18.477" class="difflineplus">+                  livemarkInfo.siteURI.spec : null;</span>
<a href="#l18.478"></a><span id="l18.478">     if (!siteUrl &amp;&amp; aPopup._siteURIMenuitem) {</span>
<a href="#l18.479"></a><span id="l18.479" class="difflineminus">-      aPopup._siteURIMenuitem.remove();</span>
<a href="#l18.480"></a><span id="l18.480" class="difflineplus">+      aPopup.removeChild(aPopup._siteURIMenuitem);</span>
<a href="#l18.481"></a><span id="l18.481">       aPopup._siteURIMenuitem = null;</span>
<a href="#l18.482"></a><span id="l18.482" class="difflineminus">-      aPopup._startMarker--;</span>
<a href="#l18.483"></a><span id="l18.483" class="difflineminus">-      aPopup._siteURIMenuseparator.remove();</span>
<a href="#l18.484"></a><span id="l18.484" class="difflineplus">+      aPopup.removeChild(aPopup._siteURIMenuseparator);</span>
<a href="#l18.485"></a><span id="l18.485">       aPopup._siteURIMenuseparator = null;</span>
<a href="#l18.486"></a><span id="l18.486" class="difflineminus">-      aPopup._startMarker--;</span>
<a href="#l18.487"></a><span id="l18.487" class="difflineminus">-    }</span>
<a href="#l18.488"></a><span id="l18.488" class="difflineminus">-    else if (siteUrl &amp;&amp; !aPopup._siteURIMenuitem) {</span>
<a href="#l18.489"></a><span id="l18.489" class="difflineplus">+    } else if (siteUrl &amp;&amp; !aPopup._siteURIMenuitem) {</span>
<a href="#l18.490"></a><span id="l18.490">       // Add &quot;Open (Feed Name)&quot; menuitem.</span>
<a href="#l18.491"></a><span id="l18.491">       aPopup._siteURIMenuitem = document.createElement(&quot;menuitem&quot;);</span>
<a href="#l18.492"></a><span id="l18.492">       aPopup._siteURIMenuitem.className = &quot;openlivemarksite-menuitem&quot;;</span>
<a href="#l18.493"></a><span id="l18.493" class="difflineplus">+      if (typeof this.options.extraClasses.entry == &quot;string&quot;) {</span>
<a href="#l18.494"></a><span id="l18.494" class="difflineplus">+        aPopup._siteURIMenuitem.classList.add(this.options.extraClasses.entry);</span>
<a href="#l18.495"></a><span id="l18.495" class="difflineplus">+      }</span>
<a href="#l18.496"></a><span id="l18.496">       aPopup._siteURIMenuitem.setAttribute(&quot;targetURI&quot;, siteUrl);</span>
<a href="#l18.497"></a><span id="l18.497">       aPopup._siteURIMenuitem.setAttribute(&quot;oncommand&quot;,</span>
<a href="#l18.498"></a><span id="l18.498">         &quot;openUILink(this.getAttribute('targetURI'), event);&quot;);</span>
<a href="#l18.499"></a><span id="l18.499"> </span>
<a href="#l18.500"></a><span id="l18.500">       // If a user middle-clicks this item we serve the oncommand event.</span>
<a href="#l18.501"></a><span id="l18.501">       // We are using checkForMiddleClick because of Bug 246720.</span>
<a href="#l18.502"></a><span id="l18.502">       // Note: stopPropagation is needed to avoid serving middle-click</span>
<a href="#l18.503"></a><span id="l18.503">       // with BT_onClick that would open all items in tabs.</span>
<a href="#l18.504"></a><span id="l18.504">       aPopup._siteURIMenuitem.setAttribute(&quot;onclick&quot;,</span>
<a href="#l18.505"></a><span id="l18.505">         &quot;checkForMiddleClick(this, event); event.stopPropagation();&quot;);</span>
<a href="#l18.506"></a><span id="l18.506">       let label =</span>
<a href="#l18.507"></a><span id="l18.507">         PlacesUIUtils.getFormattedString(&quot;menuOpenLivemarkOrigin.label&quot;,</span>
<a href="#l18.508"></a><span id="l18.508">                                          [aPopup.parentNode.getAttribute(&quot;label&quot;)])</span>
<a href="#l18.509"></a><span id="l18.509">       aPopup._siteURIMenuitem.setAttribute(&quot;label&quot;, label);</span>
<a href="#l18.510"></a><span id="l18.510" class="difflineminus">-      aPopup.insertBefore(aPopup._siteURIMenuitem,</span>
<a href="#l18.511"></a><span id="l18.511" class="difflineminus">-                          aPopup.childNodes.item(aPopup._startMarker + 1));</span>
<a href="#l18.512"></a><span id="l18.512" class="difflineminus">-      aPopup._startMarker++;</span>
<a href="#l18.513"></a><span id="l18.513" class="difflineplus">+      aPopup.insertBefore(aPopup._siteURIMenuitem, aPopup._startMarker);</span>
<a href="#l18.514"></a><span id="l18.514"> </span>
<a href="#l18.515"></a><span id="l18.515">       aPopup._siteURIMenuseparator = document.createElement(&quot;menuseparator&quot;);</span>
<a href="#l18.516"></a><span id="l18.516" class="difflineminus">-      aPopup.insertBefore(aPopup._siteURIMenuseparator,</span>
<a href="#l18.517"></a><span id="l18.517" class="difflineminus">-                         aPopup.childNodes.item(aPopup._startMarker + 1));</span>
<a href="#l18.518"></a><span id="l18.518" class="difflineminus">-      aPopup._startMarker++;</span>
<a href="#l18.519"></a><span id="l18.519" class="difflineplus">+      aPopup.insertBefore(aPopup._siteURIMenuseparator, aPopup._startMarker);</span>
<a href="#l18.520"></a><span id="l18.520">     }</span>
<a href="#l18.521"></a><span id="l18.521">   },</span>
<a href="#l18.522"></a><span id="l18.522"> </span>
<a href="#l18.523"></a><span id="l18.523">   /**</span>
<a href="#l18.524"></a><span id="l18.524">    * Add, update or remove the livemark status menuitem.</span>
<a href="#l18.525"></a><span id="l18.525">    * @param aPopup</span>
<a href="#l18.526"></a><span id="l18.526">    *        The livemark container popup</span>
<a href="#l18.527"></a><span id="l18.527">    * @param aStatus</span>
<a href="#l18.528"></a><span id="l18.528">    *        The livemark status</span>
<a href="#l18.529"></a><span id="l18.529">    */</span>
<a href="#l18.530"></a><span id="l18.530">   _setLivemarkStatusMenuItem:</span>
<a href="#l18.531"></a><span id="l18.531">   function PVB_setLivemarkStatusMenuItem(aPopup, aStatus) {</span>
<a href="#l18.532"></a><span id="l18.532" class="difflineminus">-    let itemId = aPopup._placesNode.itemId;</span>
<a href="#l18.533"></a><span id="l18.533" class="difflineminus">-    let lmStatus = null;</span>
<a href="#l18.534"></a><span id="l18.534" class="difflineminus">-    if (aStatus == Ci.mozILivemark.STATUS_LOADING)</span>
<a href="#l18.535"></a><span id="l18.535" class="difflineminus">-      lmStatus = &quot;bookmarksLivemarkLoading&quot;;</span>
<a href="#l18.536"></a><span id="l18.536" class="difflineminus">-    else if (aStatus == Ci.mozILivemark.STATUS_FAILED)</span>
<a href="#l18.537"></a><span id="l18.537" class="difflineminus">-      lmStatus = &quot;bookmarksLivemarkFailed&quot;;</span>
<a href="#l18.538"></a><span id="l18.538" class="difflineminus">-</span>
<a href="#l18.539"></a><span id="l18.539" class="difflineminus">-    let lmStatusElt = aPopup._lmStatusMenuItem;</span>
<a href="#l18.540"></a><span id="l18.540" class="difflineminus">-    if (lmStatus &amp;&amp; !lmStatusElt) {</span>
<a href="#l18.541"></a><span id="l18.541" class="difflineplus">+    let statusMenuitem = aPopup._statusMenuitem;</span>
<a href="#l18.542"></a><span id="l18.542" class="difflineplus">+    if (!statusMenuitem) {</span>
<a href="#l18.543"></a><span id="l18.543">       // Create the status menuitem and cache it in the popup object.</span>
<a href="#l18.544"></a><span id="l18.544" class="difflineminus">-      lmStatusElt = document.createElement(&quot;menuitem&quot;);</span>
<a href="#l18.545"></a><span id="l18.545" class="difflineminus">-      lmStatusElt.setAttribute(&quot;lmStatus&quot;, lmStatus);</span>
<a href="#l18.546"></a><span id="l18.546" class="difflineminus">-      lmStatusElt.setAttribute(&quot;label&quot;, PlacesUIUtils.getString(lmStatus));</span>
<a href="#l18.547"></a><span id="l18.547" class="difflineminus">-      lmStatusElt.setAttribute(&quot;disabled&quot;, true);</span>
<a href="#l18.548"></a><span id="l18.548" class="difflineminus">-      aPopup.insertBefore(lmStatusElt,</span>
<a href="#l18.549"></a><span id="l18.549" class="difflineminus">-                          aPopup.childNodes.item(aPopup._startMarker + 1));</span>
<a href="#l18.550"></a><span id="l18.550" class="difflineminus">-      aPopup._lmStatusMenuItem = lmStatusElt;</span>
<a href="#l18.551"></a><span id="l18.551" class="difflineminus">-      aPopup._startMarker++;</span>
<a href="#l18.552"></a><span id="l18.552" class="difflineplus">+      statusMenuitem = document.createElement(&quot;menuitem&quot;);</span>
<a href="#l18.553"></a><span id="l18.553" class="difflineplus">+      statusMenuitem.className = &quot;livemarkstatus-menuitem&quot;;</span>
<a href="#l18.554"></a><span id="l18.554" class="difflineplus">+      if (typeof this.options.extraClasses.entry == &quot;string&quot;) {</span>
<a href="#l18.555"></a><span id="l18.555" class="difflineplus">+        statusMenuitem.classList.add(this.options.extraClasses.entry);</span>
<a href="#l18.556"></a><span id="l18.556" class="difflineplus">+      }</span>
<a href="#l18.557"></a><span id="l18.557" class="difflineplus">+      statusMenuitem.setAttribute(&quot;disabled&quot;, true);</span>
<a href="#l18.558"></a><span id="l18.558" class="difflineplus">+      aPopup._statusMenuitem = statusMenuitem;</span>
<a href="#l18.559"></a><span id="l18.559">     }</span>
<a href="#l18.560"></a><span id="l18.560" class="difflineminus">-    else if (lmStatus &amp;&amp; lmStatusElt.getAttribute(&quot;lmStatus&quot;) != lmStatus) {</span>
<a href="#l18.561"></a><span id="l18.561" class="difflineplus">+</span>
<a href="#l18.562"></a><span id="l18.562" class="difflineplus">+    if (aStatus == Ci.mozILivemark.STATUS_LOADING ||</span>
<a href="#l18.563"></a><span id="l18.563" class="difflineplus">+        aStatus == Ci.mozILivemark.STATUS_FAILED) {</span>
<a href="#l18.564"></a><span id="l18.564">       // Status has changed, update the cached status menuitem.</span>
<a href="#l18.565"></a><span id="l18.565" class="difflineminus">-      lmStatusElt.setAttribute(&quot;label&quot;, PlacesUIUtils.getString(lmStatus));</span>
<a href="#l18.566"></a><span id="l18.566" class="difflineplus">+      let stringId = aStatus == Ci.mozILivemark.STATUS_LOADING ?</span>
<a href="#l18.567"></a><span id="l18.567" class="difflineplus">+                       &quot;bookmarksLivemarkLoading&quot; : &quot;bookmarksLivemarkFailed&quot;;</span>
<a href="#l18.568"></a><span id="l18.568" class="difflineplus">+      statusMenuitem.setAttribute(&quot;label&quot;, PlacesUIUtils.getString(stringId));</span>
<a href="#l18.569"></a><span id="l18.569" class="difflineplus">+      if (aPopup._startMarker.nextSibling != statusMenuitem)</span>
<a href="#l18.570"></a><span id="l18.570" class="difflineplus">+        aPopup.insertBefore(statusMenuitem, aPopup._startMarker.nextSibling);</span>
<a href="#l18.571"></a><span id="l18.571" class="difflineplus">+    } else if (aPopup._statusMenuitem.parentNode == aPopup) {</span>
<a href="#l18.572"></a><span id="l18.572" class="difflineplus">+      // The livemark has finished loading.</span>
<a href="#l18.573"></a><span id="l18.573" class="difflineplus">+      aPopup.removeChild(aPopup._statusMenuitem);</span>
<a href="#l18.574"></a><span id="l18.574">     }</span>
<a href="#l18.575"></a><span id="l18.575" class="difflineminus">-    else if (!lmStatus &amp;&amp; lmStatusElt) {</span>
<a href="#l18.576"></a><span id="l18.576" class="difflineminus">-      // The livemark has finished loading.</span>
<a href="#l18.577"></a><span id="l18.577" class="difflineminus">-      aPopup._lmStatusMenuItem.remove();</span>
<a href="#l18.578"></a><span id="l18.578" class="difflineminus">-      aPopup._lmStatusMenuItem = null;</span>
<a href="#l18.579"></a><span id="l18.579" class="difflineminus">-      aPopup._startMarker--;</span>
<a href="#l18.580"></a><span id="l18.580" class="difflineminus">-    }</span>
<a href="#l18.581"></a><span id="l18.581" class="difflineplus">+  },</span>
<a href="#l18.582"></a><span id="l18.582" class="difflineplus">+</span>
<a href="#l18.583"></a><span id="l18.583" class="difflineplus">+  toggleCutNode: function PVB_toggleCutNode(aPlacesNode, aValue) {</span>
<a href="#l18.584"></a><span id="l18.584" class="difflineplus">+    let elt = this._getDOMNodeForPlacesNode(aPlacesNode);</span>
<a href="#l18.585"></a><span id="l18.585" class="difflineplus">+</span>
<a href="#l18.586"></a><span id="l18.586" class="difflineplus">+    // We may get the popup for menus, but we need the menu itself.</span>
<a href="#l18.587"></a><span id="l18.587" class="difflineplus">+    if (elt.localName == &quot;menupopup&quot;)</span>
<a href="#l18.588"></a><span id="l18.588" class="difflineplus">+      elt = elt.parentNode;</span>
<a href="#l18.589"></a><span id="l18.589" class="difflineplus">+    if (aValue)</span>
<a href="#l18.590"></a><span id="l18.590" class="difflineplus">+      elt.setAttribute(&quot;cutting&quot;, &quot;true&quot;);</span>
<a href="#l18.591"></a><span id="l18.591" class="difflineplus">+    else</span>
<a href="#l18.592"></a><span id="l18.592" class="difflineplus">+      elt.removeAttribute(&quot;cutting&quot;);</span>
<a href="#l18.593"></a><span id="l18.593">   },</span>
<a href="#l18.594"></a><span id="l18.594"> </span>
<a href="#l18.595"></a><span id="l18.595">   nodeURIChanged: function PVB_nodeURIChanged(aPlacesNode, aURIString) {</span>
<a href="#l18.596"></a><span id="l18.596">     let elt = this._getDOMNodeForPlacesNode(aPlacesNode);</span>
<a href="#l18.597"></a><span id="l18.597"> </span>
<a href="#l18.598"></a><span id="l18.598">     // Here we need the &lt;menu&gt;.</span>
<a href="#l18.599"></a><span id="l18.599">     if (elt.localName == &quot;menupopup&quot;)</span>
<a href="#l18.600"></a><span id="l18.600">       elt = elt.parentNode;</span>
<a href="#l18.601"></a><span id="l18.601" class="difflineat">@@ -493,40 +513,48 @@ PlacesViewBase.prototype = {</span>
<a href="#l18.602"></a><span id="l18.602">     let elt = this._getDOMNodeForPlacesNode(aPlacesNode);</span>
<a href="#l18.603"></a><span id="l18.603"> </span>
<a href="#l18.604"></a><span id="l18.604">     // There's no UI representation for the root node, thus there's nothing to</span>
<a href="#l18.605"></a><span id="l18.605">     // be done when the icon changes.</span>
<a href="#l18.606"></a><span id="l18.606">     if (elt == this._rootElt)</span>
<a href="#l18.607"></a><span id="l18.607">       return;</span>
<a href="#l18.608"></a><span id="l18.608"> </span>
<a href="#l18.609"></a><span id="l18.609">     // Here we need the &lt;menu&gt;.</span>
<a href="#l18.610"></a><span id="l18.610" class="difflineminus">-    if (elt.localName == &quot;menupopup&quot;)</span>
<a href="#l18.611"></a><span id="l18.611" class="difflineplus">+    if (elt.localName == &quot;menupopup&quot;) {</span>
<a href="#l18.612"></a><span id="l18.612">       elt = elt.parentNode;</span>
<a href="#l18.613"></a><span id="l18.613" class="difflineminus">-</span>
<a href="#l18.614"></a><span id="l18.614" class="difflineminus">-    let icon = aPlacesNode.icon;</span>
<a href="#l18.615"></a><span id="l18.615" class="difflineminus">-    if (!icon)</span>
<a href="#l18.616"></a><span id="l18.616" class="difflineminus">-      elt.removeAttribute(&quot;image&quot;);</span>
<a href="#l18.617"></a><span id="l18.617" class="difflineminus">-    else if (icon != elt.getAttribute(&quot;image&quot;))</span>
<a href="#l18.618"></a><span id="l18.618" class="difflineminus">-      elt.setAttribute(&quot;image&quot;, icon);</span>
<a href="#l18.619"></a><span id="l18.619" class="difflineplus">+    }</span>
<a href="#l18.620"></a><span id="l18.620" class="difflineplus">+    // We must remove and reset the attribute to force an update.</span>
<a href="#l18.621"></a><span id="l18.621" class="difflineplus">+    elt.removeAttribute(&quot;image&quot;);</span>
<a href="#l18.622"></a><span id="l18.622" class="difflineplus">+    elt.setAttribute(&quot;image&quot;, aPlacesNode.icon);</span>
<a href="#l18.623"></a><span id="l18.623">   },</span>
<a href="#l18.624"></a><span id="l18.624"> </span>
<a href="#l18.625"></a><span id="l18.625">   nodeAnnotationChanged:</span>
<a href="#l18.626"></a><span id="l18.626">   function PVB_nodeAnnotationChanged(aPlacesNode, aAnno) {</span>
<a href="#l18.627"></a><span id="l18.627" class="difflineminus">-    // All livemarks have a feedURI, so use it as our indicator.</span>
<a href="#l18.628"></a><span id="l18.628" class="difflineplus">+    let elt = this._getDOMNodeForPlacesNode(aPlacesNode);</span>
<a href="#l18.629"></a><span id="l18.629" class="difflineplus">+</span>
<a href="#l18.630"></a><span id="l18.630" class="difflineplus">+    // All livemarks have a feedURI, so use it as our indicator of a livemark</span>
<a href="#l18.631"></a><span id="l18.631" class="difflineplus">+    // being modified.</span>
<a href="#l18.632"></a><span id="l18.632">     if (aAnno == PlacesUtils.LMANNO_FEEDURI) {</span>
<a href="#l18.633"></a><span id="l18.633" class="difflineminus">-      let elt = this._getDOMNodeForPlacesNode(aPlacesNode);</span>
<a href="#l18.634"></a><span id="l18.634">       let menu = elt.parentNode;</span>
<a href="#l18.635"></a><span id="l18.635" class="difflineminus">-      if (!menu.hasAttribute(&quot;livemark&quot;))</span>
<a href="#l18.636"></a><span id="l18.636" class="difflineplus">+      if (!menu.hasAttribute(&quot;livemark&quot;)) {</span>
<a href="#l18.637"></a><span id="l18.637">         menu.setAttribute(&quot;livemark&quot;, &quot;true&quot;);</span>
<a href="#l18.638"></a><span id="l18.638" class="difflineplus">+        if (AppConstants.platform === &quot;macosx&quot;) {</span>
<a href="#l18.639"></a><span id="l18.639" class="difflineplus">+          // OS X native menubar doesn't track list-style-images since</span>
<a href="#l18.640"></a><span id="l18.640" class="difflineplus">+          // it doesn't have a frame (bug 733415).  Thus enforce updating.</span>
<a href="#l18.641"></a><span id="l18.641" class="difflineplus">+          menu.setAttribute(&quot;image&quot;, &quot;&quot;);</span>
<a href="#l18.642"></a><span id="l18.642" class="difflineplus">+          menu.removeAttribute(&quot;image&quot;);</span>
<a href="#l18.643"></a><span id="l18.643" class="difflineplus">+        }</span>
<a href="#l18.644"></a><span id="l18.644" class="difflineplus">+      }</span>
<a href="#l18.645"></a><span id="l18.645"> </span>
<a href="#l18.646"></a><span id="l18.646">       PlacesUtils.livemarks.getLivemark({ id: aPlacesNode.itemId })</span>
<a href="#l18.647"></a><span id="l18.647" class="difflineminus">-                           .then(aLivemark =&gt; {</span>
<a href="#l18.648"></a><span id="l18.648" class="difflineminus">-        this.controller.cacheLivemarkInfo(aPlacesNode, aLivemark);</span>
<a href="#l18.649"></a><span id="l18.649" class="difflineminus">-        this.invalidateContainer(aPlacesNode);</span>
<a href="#l18.650"></a><span id="l18.650" class="difflineminus">-      }, () =&gt; undefined);</span>
<a href="#l18.651"></a><span id="l18.651" class="difflineplus">+        .then(aLivemark =&gt; {</span>
<a href="#l18.652"></a><span id="l18.652" class="difflineplus">+          // Controller will use this to build the meta data for the node.</span>
<a href="#l18.653"></a><span id="l18.653" class="difflineplus">+          this.controller.cacheLivemarkInfo(aPlacesNode, aLivemark);</span>
<a href="#l18.654"></a><span id="l18.654" class="difflineplus">+          this.invalidateContainer(aPlacesNode);</span>
<a href="#l18.655"></a><span id="l18.655" class="difflineplus">+        }, () =&gt; undefined);</span>
<a href="#l18.656"></a><span id="l18.656">     }</span>
<a href="#l18.657"></a><span id="l18.657">   },</span>
<a href="#l18.658"></a><span id="l18.658"> </span>
<a href="#l18.659"></a><span id="l18.659">   nodeTitleChanged:</span>
<a href="#l18.660"></a><span id="l18.660">   function PVB_nodeTitleChanged(aPlacesNode, aNewTitle) {</span>
<a href="#l18.661"></a><span id="l18.661">     let elt = this._getDOMNodeForPlacesNode(aPlacesNode);</span>
<a href="#l18.662"></a><span id="l18.662"> </span>
<a href="#l18.663"></a><span id="l18.663">     // There's no UI representation for the root node, thus there's</span>
<a href="#l18.664"></a><span id="l18.664" class="difflineat">@@ -538,84 +566,79 @@ PlacesViewBase.prototype = {</span>
<a href="#l18.665"></a><span id="l18.665">     if (elt.localName == &quot;menupopup&quot;)</span>
<a href="#l18.666"></a><span id="l18.666">       elt = elt.parentNode;</span>
<a href="#l18.667"></a><span id="l18.667"> </span>
<a href="#l18.668"></a><span id="l18.668">     if (!aNewTitle &amp;&amp; elt.localName != &quot;toolbarbutton&quot;) {</span>
<a href="#l18.669"></a><span id="l18.669">       // Many users consider toolbars as shortcuts containers, so explicitly</span>
<a href="#l18.670"></a><span id="l18.670">       // allow empty labels on toolbarbuttons.  For any other element try to be</span>
<a href="#l18.671"></a><span id="l18.671">       // smarter, guessing a title from the uri.</span>
<a href="#l18.672"></a><span id="l18.672">       elt.setAttribute(&quot;label&quot;, PlacesUIUtils.getBestTitle(aPlacesNode));</span>
<a href="#l18.673"></a><span id="l18.673" class="difflineminus">-    }</span>
<a href="#l18.674"></a><span id="l18.674" class="difflineminus">-    else {</span>
<a href="#l18.675"></a><span id="l18.675" class="difflineplus">+    } else {</span>
<a href="#l18.676"></a><span id="l18.676">       elt.setAttribute(&quot;label&quot;, aNewTitle);</span>
<a href="#l18.677"></a><span id="l18.677">     }</span>
<a href="#l18.678"></a><span id="l18.678">   },</span>
<a href="#l18.679"></a><span id="l18.679"> </span>
<a href="#l18.680"></a><span id="l18.680">   nodeRemoved:</span>
<a href="#l18.681"></a><span id="l18.681">   function PVB_nodeRemoved(aParentPlacesNode, aPlacesNode, aIndex) {</span>
<a href="#l18.682"></a><span id="l18.682">     let parentElt = this._getDOMNodeForPlacesNode(aParentPlacesNode);</span>
<a href="#l18.683"></a><span id="l18.683">     let elt = this._getDOMNodeForPlacesNode(aPlacesNode);</span>
<a href="#l18.684"></a><span id="l18.684"> </span>
<a href="#l18.685"></a><span id="l18.685">     // Here we need the &lt;menu&gt;.</span>
<a href="#l18.686"></a><span id="l18.686">     if (elt.localName == &quot;menupopup&quot;)</span>
<a href="#l18.687"></a><span id="l18.687">       elt = elt.parentNode;</span>
<a href="#l18.688"></a><span id="l18.688"> </span>
<a href="#l18.689"></a><span id="l18.689">     if (parentElt._built) {</span>
<a href="#l18.690"></a><span id="l18.690" class="difflineminus">-      elt.remove();</span>
<a href="#l18.691"></a><span id="l18.691" class="difflineplus">+      parentElt.removeChild(elt);</span>
<a href="#l18.692"></a><span id="l18.692"> </span>
<a href="#l18.693"></a><span id="l18.693">       // Figure out if we need to show the &quot;&lt;Empty&gt;&quot; menu-item.</span>
<a href="#l18.694"></a><span id="l18.694">       // TODO Bug 517701: This doesn't seem to handle the case of an empty</span>
<a href="#l18.695"></a><span id="l18.695">       // root.</span>
<a href="#l18.696"></a><span id="l18.696" class="difflineminus">-      if (!parentElt.hasChildNodes() ||</span>
<a href="#l18.697"></a><span id="l18.697" class="difflineminus">-          (parentElt.childNodes.length == 1 &amp;&amp;</span>
<a href="#l18.698"></a><span id="l18.698" class="difflineminus">-          parentElt.firstChild == parentElt._emptyMenuItem))</span>
<a href="#l18.699"></a><span id="l18.699" class="difflineminus">-        this._showEmptyMenuItem(parentElt);</span>
<a href="#l18.700"></a><span id="l18.700" class="difflineminus">-</span>
<a href="#l18.701"></a><span id="l18.701" class="difflineminus">-      if (parentElt._endMarker != -1)</span>
<a href="#l18.702"></a><span id="l18.702" class="difflineminus">-        parentElt._endMarker--;</span>
<a href="#l18.703"></a><span id="l18.703" class="difflineplus">+      if (parentElt._startMarker.nextSibling == parentElt._endMarker)</span>
<a href="#l18.704"></a><span id="l18.704" class="difflineplus">+        this._setEmptyPopupStatus(parentElt, true);</span>
<a href="#l18.705"></a><span id="l18.705">     }</span>
<a href="#l18.706"></a><span id="l18.706">   },</span>
<a href="#l18.707"></a><span id="l18.707"> </span>
<a href="#l18.708"></a><span id="l18.708">   nodeHistoryDetailsChanged:</span>
<a href="#l18.709"></a><span id="l18.709">   function PVB_nodeHistoryDetailsChanged(aPlacesNode, aTime, aCount) {</span>
<a href="#l18.710"></a><span id="l18.710">     if (aPlacesNode.parent &amp;&amp;</span>
<a href="#l18.711"></a><span id="l18.711">         this.controller.hasCachedLivemarkInfo(aPlacesNode.parent)) {</span>
<a href="#l18.712"></a><span id="l18.712">       // Find the node in the parent.</span>
<a href="#l18.713"></a><span id="l18.713">       let popup = this._getDOMNodeForPlacesNode(aPlacesNode.parent);</span>
<a href="#l18.714"></a><span id="l18.714" class="difflineminus">-      for (let i = popup._startMarker; i &lt; popup.childNodes.length; i++) {</span>
<a href="#l18.715"></a><span id="l18.715" class="difflineminus">-        let child = popup.childNodes[i];</span>
<a href="#l18.716"></a><span id="l18.716" class="difflineplus">+      for (let child = popup._startMarker.nextSibling;</span>
<a href="#l18.717"></a><span id="l18.717" class="difflineplus">+           child != popup._endMarker;</span>
<a href="#l18.718"></a><span id="l18.718" class="difflineplus">+           child = child.nextSibling) {</span>
<a href="#l18.719"></a><span id="l18.719">         if (child._placesNode &amp;&amp; child._placesNode.uri == aPlacesNode.uri) {</span>
<a href="#l18.720"></a><span id="l18.720">           if (aPlacesNode.accessCount)</span>
<a href="#l18.721"></a><span id="l18.721">             child.setAttribute(&quot;visited&quot;, &quot;true&quot;);</span>
<a href="#l18.722"></a><span id="l18.722">           else</span>
<a href="#l18.723"></a><span id="l18.723">             child.removeAttribute(&quot;visited&quot;);</span>
<a href="#l18.724"></a><span id="l18.724">           break;</span>
<a href="#l18.725"></a><span id="l18.725">         }</span>
<a href="#l18.726"></a><span id="l18.726">       }</span>
<a href="#l18.727"></a><span id="l18.727">     }</span>
<a href="#l18.728"></a><span id="l18.728">   },</span>
<a href="#l18.729"></a><span id="l18.729"> </span>
<a href="#l18.730"></a><span id="l18.730" class="difflineminus">-  nodeTagsChanged: function() { },</span>
<a href="#l18.731"></a><span id="l18.731" class="difflineminus">-  nodeDateAddedChanged: function() { },</span>
<a href="#l18.732"></a><span id="l18.732" class="difflineminus">-  nodeLastModifiedChanged: function() { },</span>
<a href="#l18.733"></a><span id="l18.733" class="difflineminus">-  nodeKeywordChanged: function() { },</span>
<a href="#l18.734"></a><span id="l18.734" class="difflineminus">-  sortingChanged: function() { },</span>
<a href="#l18.735"></a><span id="l18.735" class="difflineminus">-  batching: function() { },</span>
<a href="#l18.736"></a><span id="l18.736" class="difflineplus">+  nodeTagsChanged() { },</span>
<a href="#l18.737"></a><span id="l18.737" class="difflineplus">+  nodeDateAddedChanged() { },</span>
<a href="#l18.738"></a><span id="l18.738" class="difflineplus">+  nodeLastModifiedChanged() { },</span>
<a href="#l18.739"></a><span id="l18.739" class="difflineplus">+  nodeKeywordChanged() { },</span>
<a href="#l18.740"></a><span id="l18.740" class="difflineplus">+  sortingChanged() { },</span>
<a href="#l18.741"></a><span id="l18.741" class="difflineplus">+  batching() { },</span>
<a href="#l18.742"></a><span id="l18.742"> </span>
<a href="#l18.743"></a><span id="l18.743">   nodeInserted:</span>
<a href="#l18.744"></a><span id="l18.744">   function PVB_nodeInserted(aParentPlacesNode, aPlacesNode, aIndex) {</span>
<a href="#l18.745"></a><span id="l18.745">     let parentElt = this._getDOMNodeForPlacesNode(aParentPlacesNode);</span>
<a href="#l18.746"></a><span id="l18.746">     if (!parentElt._built)</span>
<a href="#l18.747"></a><span id="l18.747">       return;</span>
<a href="#l18.748"></a><span id="l18.748"> </span>
<a href="#l18.749"></a><span id="l18.749" class="difflineminus">-    let index = parentElt._startMarker + 1 + aIndex;</span>
<a href="#l18.750"></a><span id="l18.750" class="difflineplus">+    let index = Array.prototype.indexOf.call(parentElt.childNodes, parentElt._startMarker) +</span>
<a href="#l18.751"></a><span id="l18.751" class="difflineplus">+                aIndex + 1;</span>
<a href="#l18.752"></a><span id="l18.752">     this._insertNewItemToPopup(aPlacesNode, parentElt,</span>
<a href="#l18.753"></a><span id="l18.753">                                parentElt.childNodes[index]);</span>
<a href="#l18.754"></a><span id="l18.754" class="difflineminus">-    if (parentElt._emptyMenuItem)</span>
<a href="#l18.755"></a><span id="l18.755" class="difflineminus">-      parentElt._emptyMenuItem.hidden = true;</span>
<a href="#l18.756"></a><span id="l18.756" class="difflineplus">+    this._setEmptyPopupStatus(parentElt, false);</span>
<a href="#l18.757"></a><span id="l18.757">   },</span>
<a href="#l18.758"></a><span id="l18.758"> </span>
<a href="#l18.759"></a><span id="l18.759">   nodeMoved:</span>
<a href="#l18.760"></a><span id="l18.760">   function PBV_nodeMoved(aPlacesNode,</span>
<a href="#l18.761"></a><span id="l18.761">                          aOldParentPlacesNode, aOldIndex,</span>
<a href="#l18.762"></a><span id="l18.762">                          aNewParentPlacesNode, aNewIndex) {</span>
<a href="#l18.763"></a><span id="l18.763">     // Note: the current implementation of moveItem does not actually</span>
<a href="#l18.764"></a><span id="l18.764">     // use this notification when the item in question is moved from one</span>
<a href="#l18.765"></a><span id="l18.765" class="difflineat">@@ -630,268 +653,389 @@ PlacesViewBase.prototype = {</span>
<a href="#l18.766"></a><span id="l18.766">     // If our root node is a folder, it might be moved. There's nothing</span>
<a href="#l18.767"></a><span id="l18.767">     // we need to do in that case.</span>
<a href="#l18.768"></a><span id="l18.768">     if (elt == this._rootElt)</span>
<a href="#l18.769"></a><span id="l18.769">       return;</span>
<a href="#l18.770"></a><span id="l18.770"> </span>
<a href="#l18.771"></a><span id="l18.771">     let parentElt = this._getDOMNodeForPlacesNode(aNewParentPlacesNode);</span>
<a href="#l18.772"></a><span id="l18.772">     if (parentElt._built) {</span>
<a href="#l18.773"></a><span id="l18.773">       // Move the node.</span>
<a href="#l18.774"></a><span id="l18.774" class="difflineminus">-      elt.remove();</span>
<a href="#l18.775"></a><span id="l18.775" class="difflineminus">-      let index = parentElt._startMarker + 1 + aNewIndex;</span>
<a href="#l18.776"></a><span id="l18.776" class="difflineplus">+      parentElt.removeChild(elt);</span>
<a href="#l18.777"></a><span id="l18.777" class="difflineplus">+      let index = Array.prototype.indexOf.call(parentElt.childNodes, parentElt._startMarker) +</span>
<a href="#l18.778"></a><span id="l18.778" class="difflineplus">+                  aNewIndex + 1;</span>
<a href="#l18.779"></a><span id="l18.779">       parentElt.insertBefore(elt, parentElt.childNodes[index]);</span>
<a href="#l18.780"></a><span id="l18.780">     }</span>
<a href="#l18.781"></a><span id="l18.781">   },</span>
<a href="#l18.782"></a><span id="l18.782"> </span>
<a href="#l18.783"></a><span id="l18.783">   containerStateChanged:</span>
<a href="#l18.784"></a><span id="l18.784">   function PVB_containerStateChanged(aPlacesNode, aOldState, aNewState) {</span>
<a href="#l18.785"></a><span id="l18.785">     if (aNewState == Ci.nsINavHistoryContainerResultNode.STATE_OPENED ||</span>
<a href="#l18.786"></a><span id="l18.786">         aNewState == Ci.nsINavHistoryContainerResultNode.STATE_CLOSED) {</span>
<a href="#l18.787"></a><span id="l18.787">       this.invalidateContainer(aPlacesNode);</span>
<a href="#l18.788"></a><span id="l18.788"> </span>
<a href="#l18.789"></a><span id="l18.789" class="difflineminus">-      if (PlacesUtils.nodeIsFolder(aPlacesNode) &amp;&amp;</span>
<a href="#l18.790"></a><span id="l18.790" class="difflineminus">-          !PlacesUtils.asQuery(this._result.root).queryOptions.excludeItems) {</span>
<a href="#l18.791"></a><span id="l18.791" class="difflineplus">+      if (PlacesUtils.nodeIsFolder(aPlacesNode)) {</span>
<a href="#l18.792"></a><span id="l18.792" class="difflineplus">+        let queryOptions = PlacesUtils.asQuery(this._result.root).queryOptions;</span>
<a href="#l18.793"></a><span id="l18.793" class="difflineplus">+        if (queryOptions.excludeItems) {</span>
<a href="#l18.794"></a><span id="l18.794" class="difflineplus">+          return;</span>
<a href="#l18.795"></a><span id="l18.795" class="difflineplus">+        }</span>
<a href="#l18.796"></a><span id="l18.796" class="difflineplus">+</span>
<a href="#l18.797"></a><span id="l18.797">         PlacesUtils.livemarks.getLivemark({ id: aPlacesNode.itemId })</span>
<a href="#l18.798"></a><span id="l18.798" class="difflineminus">-                             .then(aLivemark =&gt; {</span>
<a href="#l18.799"></a><span id="l18.799" class="difflineminus">-          let shouldInvalidate =</span>
<a href="#l18.800"></a><span id="l18.800" class="difflineminus">-            !this.controller.hasCachedLivemarkInfo(aPlacesNode);</span>
<a href="#l18.801"></a><span id="l18.801" class="difflineminus">-          this.controller.cacheLivemarkInfo(aPlacesNode, aLivemark);</span>
<a href="#l18.802"></a><span id="l18.802" class="difflineminus">-          if (aNewState == Ci.nsINavHistoryContainerResultNode.STATE_OPENED) {</span>
<a href="#l18.803"></a><span id="l18.803" class="difflineminus">-            aLivemark.registerForUpdates(aPlacesNode, this);</span>
<a href="#l18.804"></a><span id="l18.804" class="difflineminus">-            aLivemark.reload();</span>
<a href="#l18.805"></a><span id="l18.805" class="difflineminus">-            if (shouldInvalidate)</span>
<a href="#l18.806"></a><span id="l18.806" class="difflineminus">-              this.invalidateContainer(aPlacesNode);</span>
<a href="#l18.807"></a><span id="l18.807" class="difflineminus">-          }</span>
<a href="#l18.808"></a><span id="l18.808" class="difflineminus">-          else {</span>
<a href="#l18.809"></a><span id="l18.809" class="difflineminus">-            aLivemark.unregisterForUpdates(aPlacesNode);</span>
<a href="#l18.810"></a><span id="l18.810" class="difflineminus">-          }</span>
<a href="#l18.811"></a><span id="l18.811" class="difflineminus">-        }, () =&gt; undefined);</span>
<a href="#l18.812"></a><span id="l18.812" class="difflineplus">+          .then(aLivemark =&gt; {</span>
<a href="#l18.813"></a><span id="l18.813" class="difflineplus">+            let shouldInvalidate =</span>
<a href="#l18.814"></a><span id="l18.814" class="difflineplus">+              !this.controller.hasCachedLivemarkInfo(aPlacesNode);</span>
<a href="#l18.815"></a><span id="l18.815" class="difflineplus">+            this.controller.cacheLivemarkInfo(aPlacesNode, aLivemark);</span>
<a href="#l18.816"></a><span id="l18.816" class="difflineplus">+            if (aNewState == Ci.nsINavHistoryContainerResultNode.STATE_OPENED) {</span>
<a href="#l18.817"></a><span id="l18.817" class="difflineplus">+              aLivemark.registerForUpdates(aPlacesNode, this);</span>
<a href="#l18.818"></a><span id="l18.818" class="difflineplus">+              // Prioritize the current livemark.</span>
<a href="#l18.819"></a><span id="l18.819" class="difflineplus">+              aLivemark.reload();</span>
<a href="#l18.820"></a><span id="l18.820" class="difflineplus">+              PlacesUtils.livemarks.reloadLivemarks();</span>
<a href="#l18.821"></a><span id="l18.821" class="difflineplus">+              if (shouldInvalidate)</span>
<a href="#l18.822"></a><span id="l18.822" class="difflineplus">+                this.invalidateContainer(aPlacesNode);</span>
<a href="#l18.823"></a><span id="l18.823" class="difflineplus">+            } else {</span>
<a href="#l18.824"></a><span id="l18.824" class="difflineplus">+              aLivemark.unregisterForUpdates(aPlacesNode);</span>
<a href="#l18.825"></a><span id="l18.825" class="difflineplus">+            }</span>
<a href="#l18.826"></a><span id="l18.826" class="difflineplus">+          }, () =&gt; undefined);</span>
<a href="#l18.827"></a><span id="l18.827">       }</span>
<a href="#l18.828"></a><span id="l18.828">     }</span>
<a href="#l18.829"></a><span id="l18.829">   },</span>
<a href="#l18.830"></a><span id="l18.830"> </span>
<a href="#l18.831"></a><span id="l18.831" class="difflineminus">-  _populateLivemarkPopup: function PVB__populateLivemarkPopup(aPopup)</span>
<a href="#l18.832"></a><span id="l18.832" class="difflineminus">-  {</span>
<a href="#l18.833"></a><span id="l18.833" class="difflineplus">+  _populateLivemarkPopup: function PVB__populateLivemarkPopup(aPopup) {</span>
<a href="#l18.834"></a><span id="l18.834">     this._setLivemarkSiteURIMenuItem(aPopup);</span>
<a href="#l18.835"></a><span id="l18.835" class="difflineminus">-    this._setLivemarkStatusMenuItem(aPopup, Ci.mozILivemark.STATUS_LOADING);</span>
<a href="#l18.836"></a><span id="l18.836" class="difflineplus">+    // Show the loading status only if there are no entries yet.</span>
<a href="#l18.837"></a><span id="l18.837" class="difflineplus">+    if (aPopup._startMarker.nextSibling == aPopup._endMarker)</span>
<a href="#l18.838"></a><span id="l18.838" class="difflineplus">+      this._setLivemarkStatusMenuItem(aPopup, Ci.mozILivemark.STATUS_LOADING);</span>
<a href="#l18.839"></a><span id="l18.839"> </span>
<a href="#l18.840"></a><span id="l18.840">     PlacesUtils.livemarks.getLivemark({ id: aPopup._placesNode.itemId })</span>
<a href="#l18.841"></a><span id="l18.841" class="difflineminus">-                         .then(aLivemark =&gt; {</span>
<a href="#l18.842"></a><span id="l18.842" class="difflineminus">-      let placesNode = aPopup._placesNode;</span>
<a href="#l18.843"></a><span id="l18.843" class="difflineminus">-      if (!placesNode.containerOpen)</span>
<a href="#l18.844"></a><span id="l18.844" class="difflineminus">-        return;</span>
<a href="#l18.845"></a><span id="l18.845" class="difflineplus">+      .then(aLivemark =&gt; {</span>
<a href="#l18.846"></a><span id="l18.846" class="difflineplus">+        let placesNode = aPopup._placesNode;</span>
<a href="#l18.847"></a><span id="l18.847" class="difflineplus">+        if (!placesNode.containerOpen)</span>
<a href="#l18.848"></a><span id="l18.848" class="difflineplus">+          return;</span>
<a href="#l18.849"></a><span id="l18.849"> </span>
<a href="#l18.850"></a><span id="l18.850" class="difflineminus">-      this._setLivemarkStatusMenuItem(aPopup, aLivemark.status);</span>
<a href="#l18.851"></a><span id="l18.851" class="difflineminus">-      this._cleanPopup(aPopup);</span>
<a href="#l18.852"></a><span id="l18.852" class="difflineplus">+        if (aLivemark.status != Ci.mozILivemark.STATUS_LOADING)</span>
<a href="#l18.853"></a><span id="l18.853" class="difflineplus">+          this._setLivemarkStatusMenuItem(aPopup, aLivemark.status);</span>
<a href="#l18.854"></a><span id="l18.854" class="difflineplus">+        this._cleanPopup(aPopup,</span>
<a href="#l18.855"></a><span id="l18.855" class="difflineplus">+          this._nativeView &amp;&amp; aPopup.parentNode.hasAttribute(&quot;open&quot;));</span>
<a href="#l18.856"></a><span id="l18.856"> </span>
<a href="#l18.857"></a><span id="l18.857" class="difflineminus">-      let children = aLivemark.getNodesForContainer(placesNode);</span>
<a href="#l18.858"></a><span id="l18.858" class="difflineminus">-      for (let i = 0; i &lt; children.length; i++) {</span>
<a href="#l18.859"></a><span id="l18.859" class="difflineminus">-        let child = children[i];</span>
<a href="#l18.860"></a><span id="l18.860" class="difflineminus">-        this.nodeInserted(placesNode, child, i);</span>
<a href="#l18.861"></a><span id="l18.861" class="difflineminus">-        if (child.accessCount)</span>
<a href="#l18.862"></a><span id="l18.862" class="difflineminus">-          this._getDOMNodeForPlacesNode(child).setAttribute(&quot;visited&quot;, true);</span>
<a href="#l18.863"></a><span id="l18.863" class="difflineminus">-        else</span>
<a href="#l18.864"></a><span id="l18.864" class="difflineminus">-          this._getDOMNodeForPlacesNode(child).removeAttribute(&quot;visited&quot;);</span>
<a href="#l18.865"></a><span id="l18.865" class="difflineminus">-      }</span>
<a href="#l18.866"></a><span id="l18.866" class="difflineminus">-    }, () =&gt; undefined);</span>
<a href="#l18.867"></a><span id="l18.867" class="difflineplus">+        let children = aLivemark.getNodesForContainer(placesNode);</span>
<a href="#l18.868"></a><span id="l18.868" class="difflineplus">+        for (let i = 0; i &lt; children.length; i++) {</span>
<a href="#l18.869"></a><span id="l18.869" class="difflineplus">+          let child = children[i];</span>
<a href="#l18.870"></a><span id="l18.870" class="difflineplus">+          this.nodeInserted(placesNode, child, i);</span>
<a href="#l18.871"></a><span id="l18.871" class="difflineplus">+          if (child.accessCount)</span>
<a href="#l18.872"></a><span id="l18.872" class="difflineplus">+            this._getDOMNodeForPlacesNode(child).setAttribute(&quot;visited&quot;, true);</span>
<a href="#l18.873"></a><span id="l18.873" class="difflineplus">+          else</span>
<a href="#l18.874"></a><span id="l18.874" class="difflineplus">+            this._getDOMNodeForPlacesNode(child).removeAttribute(&quot;visited&quot;);</span>
<a href="#l18.875"></a><span id="l18.875" class="difflineplus">+        }</span>
<a href="#l18.876"></a><span id="l18.876" class="difflineplus">+      }, Cu.reportError);</span>
<a href="#l18.877"></a><span id="l18.877" class="difflineplus">+  },</span>
<a href="#l18.878"></a><span id="l18.878" class="difflineplus">+</span>
<a href="#l18.879"></a><span id="l18.879" class="difflineplus">+  /**</span>
<a href="#l18.880"></a><span id="l18.880" class="difflineplus">+   * Checks whether the popup associated with the provided element is open.</span>
<a href="#l18.881"></a><span id="l18.881" class="difflineplus">+   * This method may be overridden by classes that extend this base class.</span>
<a href="#l18.882"></a><span id="l18.882" class="difflineplus">+   *</span>
<a href="#l18.883"></a><span id="l18.883" class="difflineplus">+   * @param  {nsIDOMElement} elt</span>
<a href="#l18.884"></a><span id="l18.884" class="difflineplus">+   * @return {Boolean}</span>
<a href="#l18.885"></a><span id="l18.885" class="difflineplus">+   */</span>
<a href="#l18.886"></a><span id="l18.886" class="difflineplus">+  _isPopupOpen(elt) {</span>
<a href="#l18.887"></a><span id="l18.887" class="difflineplus">+    return !!elt.parentNode.open;</span>
<a href="#l18.888"></a><span id="l18.888">   },</span>
<a href="#l18.889"></a><span id="l18.889"> </span>
<a href="#l18.890"></a><span id="l18.890">   invalidateContainer: function PVB_invalidateContainer(aPlacesNode) {</span>
<a href="#l18.891"></a><span id="l18.891">     let elt = this._getDOMNodeForPlacesNode(aPlacesNode);</span>
<a href="#l18.892"></a><span id="l18.892">     elt._built = false;</span>
<a href="#l18.893"></a><span id="l18.893"> </span>
<a href="#l18.894"></a><span id="l18.894">     // If the menupopup is open we should live-update it.</span>
<a href="#l18.895"></a><span id="l18.895" class="difflineminus">-    if (elt.parentNode.open)</span>
<a href="#l18.896"></a><span id="l18.896" class="difflineplus">+    if (this._isPopupOpen(elt))</span>
<a href="#l18.897"></a><span id="l18.897">       this._rebuildPopup(elt);</span>
<a href="#l18.898"></a><span id="l18.898">   },</span>
<a href="#l18.899"></a><span id="l18.899"> </span>
<a href="#l18.900"></a><span id="l18.900">   uninit: function PVB_uninit() {</span>
<a href="#l18.901"></a><span id="l18.901">     if (this._result) {</span>
<a href="#l18.902"></a><span id="l18.902">       this._result.removeObserver(this);</span>
<a href="#l18.903"></a><span id="l18.903">       this._resultNode.containerOpen = false;</span>
<a href="#l18.904"></a><span id="l18.904">       this._resultNode = null;</span>
<a href="#l18.905"></a><span id="l18.905">       this._result = null;</span>
<a href="#l18.906"></a><span id="l18.906">     }</span>
<a href="#l18.907"></a><span id="l18.907"> </span>
<a href="#l18.908"></a><span id="l18.908" class="difflineplus">+    if (this._controller) {</span>
<a href="#l18.909"></a><span id="l18.909" class="difflineplus">+      this._controller.terminate();</span>
<a href="#l18.910"></a><span id="l18.910" class="difflineplus">+      // Removing the controller will fail if it is already no longer there.</span>
<a href="#l18.911"></a><span id="l18.911" class="difflineplus">+      // This can happen if the view element was removed/reinserted without</span>
<a href="#l18.912"></a><span id="l18.912" class="difflineplus">+      // our knowledge. There is no way to check for that having happened</span>
<a href="#l18.913"></a><span id="l18.913" class="difflineplus">+      // without the possibility of an exception. :-(</span>
<a href="#l18.914"></a><span id="l18.914" class="difflineplus">+      try {</span>
<a href="#l18.915"></a><span id="l18.915" class="difflineplus">+        this._viewElt.controllers.removeController(this._controller);</span>
<a href="#l18.916"></a><span id="l18.916" class="difflineplus">+      } catch (ex) {</span>
<a href="#l18.917"></a><span id="l18.917" class="difflineplus">+      } finally {</span>
<a href="#l18.918"></a><span id="l18.918" class="difflineplus">+        this._controller = null;</span>
<a href="#l18.919"></a><span id="l18.919" class="difflineplus">+      }</span>
<a href="#l18.920"></a><span id="l18.920" class="difflineplus">+    }</span>
<a href="#l18.921"></a><span id="l18.921" class="difflineplus">+</span>
<a href="#l18.922"></a><span id="l18.922">     delete this._viewElt._placesView;</span>
<a href="#l18.923"></a><span id="l18.923">   },</span>
<a href="#l18.924"></a><span id="l18.924"> </span>
<a href="#l18.925"></a><span id="l18.925">   get isRTL() {</span>
<a href="#l18.926"></a><span id="l18.926">     if (&quot;_isRTL&quot; in this)</span>
<a href="#l18.927"></a><span id="l18.927">       return this._isRTL;</span>
<a href="#l18.928"></a><span id="l18.928"> </span>
<a href="#l18.929"></a><span id="l18.929" class="difflineminus">-    return this._isRTL = document.defaultView.getComputedStyle(this, &quot;&quot;)</span>
<a href="#l18.930"></a><span id="l18.930" class="difflineminus">-                                 .direction == &quot;rtl&quot;</span>
<a href="#l18.931"></a><span id="l18.931" class="difflineplus">+    return this._isRTL = document.defaultView</span>
<a href="#l18.932"></a><span id="l18.932" class="difflineplus">+                                 .getComputedStyle(this.viewElt)</span>
<a href="#l18.933"></a><span id="l18.933" class="difflineplus">+                                 .direction == &quot;rtl&quot;;</span>
<a href="#l18.934"></a><span id="l18.934" class="difflineplus">+  },</span>
<a href="#l18.935"></a><span id="l18.935" class="difflineplus">+</span>
<a href="#l18.936"></a><span id="l18.936" class="difflineplus">+  get ownerWindow() {</span>
<a href="#l18.937"></a><span id="l18.937" class="difflineplus">+    return window;</span>
<a href="#l18.938"></a><span id="l18.938">   },</span>
<a href="#l18.939"></a><span id="l18.939"> </span>
<a href="#l18.940"></a><span id="l18.940">   /**</span>
<a href="#l18.941"></a><span id="l18.941">    * Adds an &quot;Open All in Tabs&quot; menuitem to the bottom of the popup.</span>
<a href="#l18.942"></a><span id="l18.942">    * @param aPopup</span>
<a href="#l18.943"></a><span id="l18.943">    *        a Places popup.</span>
<a href="#l18.944"></a><span id="l18.944">    */</span>
<a href="#l18.945"></a><span id="l18.945">   _mayAddCommandsItems: function PVB__mayAddCommandsItems(aPopup) {</span>
<a href="#l18.946"></a><span id="l18.946">     // The command items are never added to the root popup.</span>
<a href="#l18.947"></a><span id="l18.947">     if (aPopup == this._rootElt)</span>
<a href="#l18.948"></a><span id="l18.948">       return;</span>
<a href="#l18.949"></a><span id="l18.949"> </span>
<a href="#l18.950"></a><span id="l18.950">     let hasMultipleURIs = false;</span>
<a href="#l18.951"></a><span id="l18.951"> </span>
<a href="#l18.952"></a><span id="l18.952">     // Check if the popup contains at least 2 menuitems with places nodes.</span>
<a href="#l18.953"></a><span id="l18.953" class="difflineminus">-    // We don't currently support opening multiple uri nodes when</span>
<a href="#l18.954"></a><span id="l18.954" class="difflineminus">-    // they are not populated by the result.</span>
<a href="#l18.955"></a><span id="l18.955" class="difflineplus">+    // We don't currently support opening multiple uri nodes when they are not</span>
<a href="#l18.956"></a><span id="l18.956" class="difflineplus">+    // populated by the result.</span>
<a href="#l18.957"></a><span id="l18.957">     if (aPopup._placesNode.childCount &gt; 0) {</span>
<a href="#l18.958"></a><span id="l18.958">       let currentChild = aPopup.firstChild;</span>
<a href="#l18.959"></a><span id="l18.959">       let numURINodes = 0;</span>
<a href="#l18.960"></a><span id="l18.960">       while (currentChild) {</span>
<a href="#l18.961"></a><span id="l18.961">         if (currentChild.localName == &quot;menuitem&quot; &amp;&amp; currentChild._placesNode) {</span>
<a href="#l18.962"></a><span id="l18.962">           if (++numURINodes == 2)</span>
<a href="#l18.963"></a><span id="l18.963">             break;</span>
<a href="#l18.964"></a><span id="l18.964">         }</span>
<a href="#l18.965"></a><span id="l18.965">         currentChild = currentChild.nextSibling;</span>
<a href="#l18.966"></a><span id="l18.966">       }</span>
<a href="#l18.967"></a><span id="l18.967">       hasMultipleURIs = numURINodes &gt; 1;</span>
<a href="#l18.968"></a><span id="l18.968">     }</span>
<a href="#l18.969"></a><span id="l18.969"> </span>
<a href="#l18.970"></a><span id="l18.970" class="difflineplus">+    let isLiveMark = false;</span>
<a href="#l18.971"></a><span id="l18.971" class="difflineplus">+    if (this.controller.hasCachedLivemarkInfo(aPopup._placesNode)) {</span>
<a href="#l18.972"></a><span id="l18.972" class="difflineplus">+      hasMultipleURIs = true;</span>
<a href="#l18.973"></a><span id="l18.973" class="difflineplus">+      isLiveMark = true;</span>
<a href="#l18.974"></a><span id="l18.974" class="difflineplus">+    }</span>
<a href="#l18.975"></a><span id="l18.975" class="difflineplus">+</span>
<a href="#l18.976"></a><span id="l18.976" class="difflineplus">+    if (!hasMultipleURIs) {</span>
<a href="#l18.977"></a><span id="l18.977" class="difflineplus">+      aPopup.setAttribute(&quot;singleitempopup&quot;, &quot;true&quot;);</span>
<a href="#l18.978"></a><span id="l18.978" class="difflineplus">+    } else {</span>
<a href="#l18.979"></a><span id="l18.979" class="difflineplus">+      aPopup.removeAttribute(&quot;singleitempopup&quot;);</span>
<a href="#l18.980"></a><span id="l18.980" class="difflineplus">+    }</span>
<a href="#l18.981"></a><span id="l18.981" class="difflineplus">+</span>
<a href="#l18.982"></a><span id="l18.982">     if (!hasMultipleURIs) {</span>
<a href="#l18.983"></a><span id="l18.983">       // We don't have to show any option.</span>
<a href="#l18.984"></a><span id="l18.984">       if (aPopup._endOptOpenAllInTabs) {</span>
<a href="#l18.985"></a><span id="l18.985" class="difflineminus">-        aPopup._endOptOpenAllInTabs.remove();</span>
<a href="#l18.986"></a><span id="l18.986" class="difflineplus">+        aPopup.removeChild(aPopup._endOptOpenAllInTabs);</span>
<a href="#l18.987"></a><span id="l18.987">         aPopup._endOptOpenAllInTabs = null;</span>
<a href="#l18.988"></a><span id="l18.988" class="difflineminus">-        aPopup._endMarker--;</span>
<a href="#l18.989"></a><span id="l18.989"> </span>
<a href="#l18.990"></a><span id="l18.990" class="difflineminus">-        aPopup._endOptSeparator.remove();</span>
<a href="#l18.991"></a><span id="l18.991" class="difflineplus">+        aPopup.removeChild(aPopup._endOptSeparator);</span>
<a href="#l18.992"></a><span id="l18.992">         aPopup._endOptSeparator = null;</span>
<a href="#l18.993"></a><span id="l18.993" class="difflineminus">-        aPopup._endMarker--;</span>
<a href="#l18.994"></a><span id="l18.994" class="difflineminus">-        aPopup._endMarker -= aPopup._placesNode.childCount;</span>
<a href="#l18.995"></a><span id="l18.995" class="difflineminus">-        if (aPopup._endMarker &lt; -1)</span>
<a href="#l18.996"></a><span id="l18.996" class="difflineminus">-          aPopup._endMarker = -1;</span>
<a href="#l18.997"></a><span id="l18.997">       }</span>
<a href="#l18.998"></a><span id="l18.998" class="difflineminus">-    }</span>
<a href="#l18.999"></a><span id="l18.999" class="difflineminus">-    else if (!aPopup._endOptOpenAllInTabs) {</span>
<a href="#l18.1000"></a><span id="l18.1000" class="difflineplus">+    } else if (!aPopup._endOptOpenAllInTabs) {</span>
<a href="#l18.1001"></a><span id="l18.1001">       // Create a separator before options.</span>
<a href="#l18.1002"></a><span id="l18.1002">       aPopup._endOptSeparator = document.createElement(&quot;menuseparator&quot;);</span>
<a href="#l18.1003"></a><span id="l18.1003">       aPopup._endOptSeparator.className = &quot;bookmarks-actions-menuseparator&quot;;</span>
<a href="#l18.1004"></a><span id="l18.1004">       aPopup.appendChild(aPopup._endOptSeparator);</span>
<a href="#l18.1005"></a><span id="l18.1005" class="difflineminus">-      aPopup._endMarker++;</span>
<a href="#l18.1006"></a><span id="l18.1006"> </span>
<a href="#l18.1007"></a><span id="l18.1007">       // Add the &quot;Open All in Tabs&quot; menuitem.</span>
<a href="#l18.1008"></a><span id="l18.1008">       aPopup._endOptOpenAllInTabs = document.createElement(&quot;menuitem&quot;);</span>
<a href="#l18.1009"></a><span id="l18.1009">       aPopup._endOptOpenAllInTabs.className = &quot;openintabs-menuitem&quot;;</span>
<a href="#l18.1010"></a><span id="l18.1010" class="difflineminus">-      aPopup._endOptOpenAllInTabs.setAttribute(&quot;oncommand&quot;,</span>
<a href="#l18.1011"></a><span id="l18.1011" class="difflineminus">-        &quot;PlacesUIUtils.openContainerNodeInTabs(this.parentNode._placesNode, event);&quot;);</span>
<a href="#l18.1012"></a><span id="l18.1012" class="difflineplus">+</span>
<a href="#l18.1013"></a><span id="l18.1013" class="difflineplus">+      if (typeof this.options.extraClasses.entry == &quot;string&quot;)</span>
<a href="#l18.1014"></a><span id="l18.1014" class="difflineplus">+        aPopup._endOptOpenAllInTabs.classList.add(this.options.extraClasses.entry);</span>
<a href="#l18.1015"></a><span id="l18.1015" class="difflineplus">+      if (typeof this.options.extraClasses.footer == &quot;string&quot;)</span>
<a href="#l18.1016"></a><span id="l18.1016" class="difflineplus">+        aPopup._endOptOpenAllInTabs.classList.add(this.options.extraClasses.footer);</span>
<a href="#l18.1017"></a><span id="l18.1017" class="difflineplus">+</span>
<a href="#l18.1018"></a><span id="l18.1018" class="difflineplus">+      if (isLiveMark) {</span>
<a href="#l18.1019"></a><span id="l18.1019" class="difflineplus">+        aPopup._endOptOpenAllInTabs.setAttribute(&quot;oncommand&quot;,</span>
<a href="#l18.1020"></a><span id="l18.1020" class="difflineplus">+          &quot;PlacesUIUtils.openLiveMarkNodesInTabs(this.parentNode._placesNode, event, &quot; +</span>
<a href="#l18.1021"></a><span id="l18.1021" class="difflineplus">+                                                 &quot;PlacesUIUtils.getViewForNode(this));&quot;);</span>
<a href="#l18.1022"></a><span id="l18.1022" class="difflineplus">+      } else {</span>
<a href="#l18.1023"></a><span id="l18.1023" class="difflineplus">+        aPopup._endOptOpenAllInTabs.setAttribute(&quot;oncommand&quot;,</span>
<a href="#l18.1024"></a><span id="l18.1024" class="difflineplus">+          &quot;PlacesUIUtils.openContainerNodeInTabs(this.parentNode._placesNode, event, &quot; +</span>
<a href="#l18.1025"></a><span id="l18.1025" class="difflineplus">+                                                 &quot;PlacesUIUtils.getViewForNode(this));&quot;);</span>
<a href="#l18.1026"></a><span id="l18.1026" class="difflineplus">+      }</span>
<a href="#l18.1027"></a><span id="l18.1027">       aPopup._endOptOpenAllInTabs.setAttribute(&quot;onclick&quot;,</span>
<a href="#l18.1028"></a><span id="l18.1028">         &quot;checkForMiddleClick(this, event); event.stopPropagation();&quot;);</span>
<a href="#l18.1029"></a><span id="l18.1029">       aPopup._endOptOpenAllInTabs.setAttribute(&quot;label&quot;,</span>
<a href="#l18.1030"></a><span id="l18.1030">         gNavigatorBundle.getString(&quot;menuOpenAllInTabs.label&quot;));</span>
<a href="#l18.1031"></a><span id="l18.1031">       aPopup.appendChild(aPopup._endOptOpenAllInTabs);</span>
<a href="#l18.1032"></a><span id="l18.1032" class="difflineminus">-      aPopup._endMarker++;</span>
<a href="#l18.1033"></a><span id="l18.1033" class="difflineminus">-      aPopup._endMarker += aPopup._placesNode.childCount;</span>
<a href="#l18.1034"></a><span id="l18.1034" class="difflineplus">+    }</span>
<a href="#l18.1035"></a><span id="l18.1035" class="difflineplus">+  },</span>
<a href="#l18.1036"></a><span id="l18.1036" class="difflineplus">+</span>
<a href="#l18.1037"></a><span id="l18.1037" class="difflineplus">+  _ensureMarkers: function PVB__ensureMarkers(aPopup) {</span>
<a href="#l18.1038"></a><span id="l18.1038" class="difflineplus">+    if (aPopup._startMarker)</span>
<a href="#l18.1039"></a><span id="l18.1039" class="difflineplus">+      return;</span>
<a href="#l18.1040"></a><span id="l18.1040" class="difflineplus">+</span>
<a href="#l18.1041"></a><span id="l18.1041" class="difflineplus">+    // _startMarker is an hidden menuseparator that lives before places nodes.</span>
<a href="#l18.1042"></a><span id="l18.1042" class="difflineplus">+    aPopup._startMarker = document.createElement(&quot;menuseparator&quot;);</span>
<a href="#l18.1043"></a><span id="l18.1043" class="difflineplus">+    aPopup._startMarker.hidden = true;</span>
<a href="#l18.1044"></a><span id="l18.1044" class="difflineplus">+    aPopup.insertBefore(aPopup._startMarker, aPopup.firstChild);</span>
<a href="#l18.1045"></a><span id="l18.1045" class="difflineplus">+</span>
<a href="#l18.1046"></a><span id="l18.1046" class="difflineplus">+    // _endMarker is a DOM node that lives after places nodes, specified with</span>
<a href="#l18.1047"></a><span id="l18.1047" class="difflineplus">+    // the 'insertionPoint' option or will be a hidden menuseparator.</span>
<a href="#l18.1048"></a><span id="l18.1048" class="difflineplus">+    let node = this.options.insertionPoint ?</span>
<a href="#l18.1049"></a><span id="l18.1049" class="difflineplus">+               aPopup.querySelector(this.options.insertionPoint) : null;</span>
<a href="#l18.1050"></a><span id="l18.1050" class="difflineplus">+    if (node) {</span>
<a href="#l18.1051"></a><span id="l18.1051" class="difflineplus">+      aPopup._endMarker = node;</span>
<a href="#l18.1052"></a><span id="l18.1052" class="difflineplus">+    } else {</span>
<a href="#l18.1053"></a><span id="l18.1053" class="difflineplus">+      aPopup._endMarker = document.createElement(&quot;menuseparator&quot;);</span>
<a href="#l18.1054"></a><span id="l18.1054" class="difflineplus">+      aPopup._endMarker.hidden = true;</span>
<a href="#l18.1055"></a><span id="l18.1055" class="difflineplus">+    }</span>
<a href="#l18.1056"></a><span id="l18.1056" class="difflineplus">+    aPopup.appendChild(aPopup._endMarker);</span>
<a href="#l18.1057"></a><span id="l18.1057" class="difflineplus">+</span>
<a href="#l18.1058"></a><span id="l18.1058" class="difflineplus">+    // Move the markers to the right position.</span>
<a href="#l18.1059"></a><span id="l18.1059" class="difflineplus">+    let firstNonStaticNodeFound = false;</span>
<a href="#l18.1060"></a><span id="l18.1060" class="difflineplus">+    for (let i = 0; i &lt; aPopup.childNodes.length; i++) {</span>
<a href="#l18.1061"></a><span id="l18.1061" class="difflineplus">+      let child = aPopup.childNodes[i];</span>
<a href="#l18.1062"></a><span id="l18.1062" class="difflineplus">+      // Menus that have static content at the end, but are initially empty,</span>
<a href="#l18.1063"></a><span id="l18.1063" class="difflineplus">+      // use a special &quot;builder&quot; attribute to figure out where to start</span>
<a href="#l18.1064"></a><span id="l18.1064" class="difflineplus">+      // inserting places nodes.</span>
<a href="#l18.1065"></a><span id="l18.1065" class="difflineplus">+      if (child.getAttribute(&quot;builder&quot;) == &quot;end&quot;) {</span>
<a href="#l18.1066"></a><span id="l18.1066" class="difflineplus">+        aPopup.insertBefore(aPopup._endMarker, child);</span>
<a href="#l18.1067"></a><span id="l18.1067" class="difflineplus">+        break;</span>
<a href="#l18.1068"></a><span id="l18.1068" class="difflineplus">+      }</span>
<a href="#l18.1069"></a><span id="l18.1069" class="difflineplus">+</span>
<a href="#l18.1070"></a><span id="l18.1070" class="difflineplus">+      if (child._placesNode &amp;&amp; !child.hasAttribute(&quot;simulated-places-node&quot;) &amp;&amp;</span>
<a href="#l18.1071"></a><span id="l18.1071" class="difflineplus">+          !firstNonStaticNodeFound) {</span>
<a href="#l18.1072"></a><span id="l18.1072" class="difflineplus">+        firstNonStaticNodeFound = true;</span>
<a href="#l18.1073"></a><span id="l18.1073" class="difflineplus">+        aPopup.insertBefore(aPopup._startMarker, child);</span>
<a href="#l18.1074"></a><span id="l18.1074" class="difflineplus">+      }</span>
<a href="#l18.1075"></a><span id="l18.1075" class="difflineplus">+    }</span>
<a href="#l18.1076"></a><span id="l18.1076" class="difflineplus">+    if (!firstNonStaticNodeFound) {</span>
<a href="#l18.1077"></a><span id="l18.1077" class="difflineplus">+      aPopup.insertBefore(aPopup._startMarker, aPopup._endMarker);</span>
<a href="#l18.1078"></a><span id="l18.1078">     }</span>
<a href="#l18.1079"></a><span id="l18.1079">   },</span>
<a href="#l18.1080"></a><span id="l18.1080"> </span>
<a href="#l18.1081"></a><span id="l18.1081">   _onPopupShowing: function PVB__onPopupShowing(aEvent) {</span>
<a href="#l18.1082"></a><span id="l18.1082">     // Avoid handling popupshowing of inner views.</span>
<a href="#l18.1083"></a><span id="l18.1083">     let popup = aEvent.originalTarget;</span>
<a href="#l18.1084"></a><span id="l18.1084" class="difflineplus">+</span>
<a href="#l18.1085"></a><span id="l18.1085" class="difflineplus">+    this._ensureMarkers(popup);</span>
<a href="#l18.1086"></a><span id="l18.1086" class="difflineplus">+</span>
<a href="#l18.1087"></a><span id="l18.1087" class="difflineplus">+    // Remove any delayed element, see _cleanPopup for details.</span>
<a href="#l18.1088"></a><span id="l18.1088" class="difflineplus">+    if (&quot;_delayedRemovals&quot; in popup) {</span>
<a href="#l18.1089"></a><span id="l18.1089" class="difflineplus">+      while (popup._delayedRemovals.length &gt; 0) {</span>
<a href="#l18.1090"></a><span id="l18.1090" class="difflineplus">+        popup.removeChild(popup._delayedRemovals.shift());</span>
<a href="#l18.1091"></a><span id="l18.1091" class="difflineplus">+      }</span>
<a href="#l18.1092"></a><span id="l18.1092" class="difflineplus">+    }</span>
<a href="#l18.1093"></a><span id="l18.1093" class="difflineplus">+</span>
<a href="#l18.1094"></a><span id="l18.1094">     if (popup._placesNode &amp;&amp; PlacesUIUtils.getViewForNode(popup) == this) {</span>
<a href="#l18.1095"></a><span id="l18.1095">       if (!popup._placesNode.containerOpen)</span>
<a href="#l18.1096"></a><span id="l18.1096">         popup._placesNode.containerOpen = true;</span>
<a href="#l18.1097"></a><span id="l18.1097">       if (!popup._built)</span>
<a href="#l18.1098"></a><span id="l18.1098">         this._rebuildPopup(popup);</span>
<a href="#l18.1099"></a><span id="l18.1099"> </span>
<a href="#l18.1100"></a><span id="l18.1100">       this._mayAddCommandsItems(popup);</span>
<a href="#l18.1101"></a><span id="l18.1101">     }</span>
<a href="#l18.1102"></a><span id="l18.1102">   },</span>
<a href="#l18.1103"></a><span id="l18.1103"> </span>
<a href="#l18.1104"></a><span id="l18.1104">   _addEventListeners:</span>
<a href="#l18.1105"></a><span id="l18.1105" class="difflineminus">-  function PVB__addEventListeners(aObject, aEventNames, aCapturing) {</span>
<a href="#l18.1106"></a><span id="l18.1106" class="difflineplus">+  function PVB__addEventListeners(aObject, aEventNames, aCapturing = false) {</span>
<a href="#l18.1107"></a><span id="l18.1107">     for (let i = 0; i &lt; aEventNames.length; i++) {</span>
<a href="#l18.1108"></a><span id="l18.1108">       aObject.addEventListener(aEventNames[i], this, aCapturing);</span>
<a href="#l18.1109"></a><span id="l18.1109">     }</span>
<a href="#l18.1110"></a><span id="l18.1110">   },</span>
<a href="#l18.1111"></a><span id="l18.1111"> </span>
<a href="#l18.1112"></a><span id="l18.1112">   _removeEventListeners:</span>
<a href="#l18.1113"></a><span id="l18.1113" class="difflineminus">-  function PVB__removeEventListeners(aObject, aEventNames, aCapturing) {</span>
<a href="#l18.1114"></a><span id="l18.1114" class="difflineplus">+  function PVB__removeEventListeners(aObject, aEventNames, aCapturing = false) {</span>
<a href="#l18.1115"></a><span id="l18.1115">     for (let i = 0; i &lt; aEventNames.length; i++) {</span>
<a href="#l18.1116"></a><span id="l18.1116">       aObject.removeEventListener(aEventNames[i], this, aCapturing);</span>
<a href="#l18.1117"></a><span id="l18.1117">     }</span>
<a href="#l18.1118"></a><span id="l18.1118">   },</span>
<a href="#l18.1119"></a><span id="l18.1119"> };</span>
<a href="#l18.1120"></a><span id="l18.1120"> </span>
<a href="#l18.1121"></a><span id="l18.1121"> function PlacesToolbar(aPlace) {</span>
<a href="#l18.1122"></a><span id="l18.1122" class="difflineplus">+  let startTime = Date.now();</span>
<a href="#l18.1123"></a><span id="l18.1123">   // Add some smart getters for our elements.</span>
<a href="#l18.1124"></a><span id="l18.1124">   let thisView = this;</span>
<a href="#l18.1125"></a><span id="l18.1125">   [</span>
<a href="#l18.1126"></a><span id="l18.1126">     [&quot;_viewElt&quot;,              &quot;PlacesToolbar&quot;],</span>
<a href="#l18.1127"></a><span id="l18.1127">     [&quot;_rootElt&quot;,              &quot;PlacesToolbarItems&quot;],</span>
<a href="#l18.1128"></a><span id="l18.1128">     [&quot;_dropIndicator&quot;,        &quot;PlacesToolbarDropIndicator&quot;],</span>
<a href="#l18.1129"></a><span id="l18.1129">     [&quot;_chevron&quot;,              &quot;PlacesChevron&quot;],</span>
<a href="#l18.1130"></a><span id="l18.1130">     [&quot;_chevronPopup&quot;,         &quot;PlacesChevronPopup&quot;]</span>
<a href="#l18.1131"></a><span id="l18.1131" class="difflineminus">-  ].forEach(function (elementGlobal) {</span>
<a href="#l18.1132"></a><span id="l18.1132" class="difflineplus">+  ].forEach(function(elementGlobal) {</span>
<a href="#l18.1133"></a><span id="l18.1133">     let [name, id] = elementGlobal;</span>
<a href="#l18.1134"></a><span id="l18.1134" class="difflineminus">-    thisView.__defineGetter__(name, function () {</span>
<a href="#l18.1135"></a><span id="l18.1135" class="difflineplus">+    thisView.__defineGetter__(name, function() {</span>
<a href="#l18.1136"></a><span id="l18.1136">       let element = document.getElementById(id);</span>
<a href="#l18.1137"></a><span id="l18.1137">       if (!element)</span>
<a href="#l18.1138"></a><span id="l18.1138">         return null;</span>
<a href="#l18.1139"></a><span id="l18.1139"> </span>
<a href="#l18.1140"></a><span id="l18.1140">       delete thisView[name];</span>
<a href="#l18.1141"></a><span id="l18.1141">       return thisView[name] = element;</span>
<a href="#l18.1142"></a><span id="l18.1142">     });</span>
<a href="#l18.1143"></a><span id="l18.1143">   });</span>
<a href="#l18.1144"></a><span id="l18.1144"> </span>
<a href="#l18.1145"></a><span id="l18.1145">   this._viewElt._placesView = this;</span>
<a href="#l18.1146"></a><span id="l18.1146"> </span>
<a href="#l18.1147"></a><span id="l18.1147">   this._addEventListeners(this._viewElt, this._cbEvents, false);</span>
<a href="#l18.1148"></a><span id="l18.1148">   this._addEventListeners(this._rootElt, [&quot;popupshowing&quot;, &quot;popuphidden&quot;], true);</span>
<a href="#l18.1149"></a><span id="l18.1149">   this._addEventListeners(this._rootElt, [&quot;overflow&quot;, &quot;underflow&quot;], true);</span>
<a href="#l18.1150"></a><span id="l18.1150">   this._addEventListeners(window, [&quot;resize&quot;, &quot;unload&quot;], false);</span>
<a href="#l18.1151"></a><span id="l18.1151"> </span>
<a href="#l18.1152"></a><span id="l18.1152" class="difflineplus">+  // If personal-bookmarks has been dragged to the tabs toolbar,</span>
<a href="#l18.1153"></a><span id="l18.1153" class="difflineplus">+  // we have to track addition and removals of tabs, to properly</span>
<a href="#l18.1154"></a><span id="l18.1154" class="difflineplus">+  // recalculate the available space for bookmarks.</span>
<a href="#l18.1155"></a><span id="l18.1155" class="difflineplus">+  // TODO (bug 734730): Use a performant mutation listener when available.</span>
<a href="#l18.1156"></a><span id="l18.1156" class="difflineplus">+  if (this._viewElt.parentNode.parentNode == document.getElementById(&quot;TabsToolbar&quot;)) {</span>
<a href="#l18.1157"></a><span id="l18.1157" class="difflineplus">+    this._addEventListeners(gBrowser.tabContainer, [&quot;TabOpen&quot;, &quot;TabClose&quot;], false);</span>
<a href="#l18.1158"></a><span id="l18.1158" class="difflineplus">+  }</span>
<a href="#l18.1159"></a><span id="l18.1159" class="difflineplus">+</span>
<a href="#l18.1160"></a><span id="l18.1160">   PlacesViewBase.call(this, aPlace);</span>
<a href="#l18.1161"></a><span id="l18.1161" class="difflineplus">+</span>
<a href="#l18.1162"></a><span id="l18.1162" class="difflineplus">+  Services.telemetry.getHistogramById(&quot;FX_BOOKMARKS_TOOLBAR_INIT_MS&quot;)</span>
<a href="#l18.1163"></a><span id="l18.1163" class="difflineplus">+                    .add(Date.now() - startTime);</span>
<a href="#l18.1164"></a><span id="l18.1164"> }</span>
<a href="#l18.1165"></a><span id="l18.1165"> </span>
<a href="#l18.1166"></a><span id="l18.1166"> PlacesToolbar.prototype = {</span>
<a href="#l18.1167"></a><span id="l18.1167">   __proto__: PlacesViewBase.prototype,</span>
<a href="#l18.1168"></a><span id="l18.1168"> </span>
<a href="#l18.1169"></a><span id="l18.1169">   _cbEvents: [&quot;dragstart&quot;, &quot;dragover&quot;, &quot;dragexit&quot;, &quot;dragend&quot;, &quot;drop&quot;,</span>
<a href="#l18.1170"></a><span id="l18.1170" class="difflineminus">-#ifdef XP_UNIX</span>
<a href="#l18.1171"></a><span id="l18.1171" class="difflineminus">-#ifndef XP_MACOSX</span>
<a href="#l18.1172"></a><span id="l18.1172" class="difflineminus">-              &quot;mousedown&quot;, &quot;mouseup&quot;,</span>
<a href="#l18.1173"></a><span id="l18.1173" class="difflineminus">-#endif</span>
<a href="#l18.1174"></a><span id="l18.1174" class="difflineminus">-#endif</span>
<a href="#l18.1175"></a><span id="l18.1175">               &quot;mousemove&quot;, &quot;mouseover&quot;, &quot;mouseout&quot;],</span>
<a href="#l18.1176"></a><span id="l18.1176"> </span>
<a href="#l18.1177"></a><span id="l18.1177">   QueryInterface: function PT_QueryInterface(aIID) {</span>
<a href="#l18.1178"></a><span id="l18.1178">     if (aIID.equals(Ci.nsIDOMEventListener) ||</span>
<a href="#l18.1179"></a><span id="l18.1179">         aIID.equals(Ci.nsITimerCallback))</span>
<a href="#l18.1180"></a><span id="l18.1180">       return this;</span>
<a href="#l18.1181"></a><span id="l18.1181"> </span>
<a href="#l18.1182"></a><span id="l18.1182">     return PlacesViewBase.prototype.QueryInterface.apply(this, arguments);</span>
<a href="#l18.1183"></a><span id="l18.1183">   },</span>
<a href="#l18.1184"></a><span id="l18.1184"> </span>
<a href="#l18.1185"></a><span id="l18.1185">   uninit: function PT_uninit() {</span>
<a href="#l18.1186"></a><span id="l18.1186">     this._removeEventListeners(this._viewElt, this._cbEvents, false);</span>
<a href="#l18.1187"></a><span id="l18.1187">     this._removeEventListeners(this._rootElt, [&quot;popupshowing&quot;, &quot;popuphidden&quot;],</span>
<a href="#l18.1188"></a><span id="l18.1188">                                true);</span>
<a href="#l18.1189"></a><span id="l18.1189">     this._removeEventListeners(this._rootElt, [&quot;overflow&quot;, &quot;underflow&quot;], true);</span>
<a href="#l18.1190"></a><span id="l18.1190">     this._removeEventListeners(window, [&quot;resize&quot;, &quot;unload&quot;], false);</span>
<a href="#l18.1191"></a><span id="l18.1191" class="difflineplus">+    this._removeEventListeners(gBrowser.tabContainer, [&quot;TabOpen&quot;, &quot;TabClose&quot;], false);</span>
<a href="#l18.1192"></a><span id="l18.1192" class="difflineplus">+</span>
<a href="#l18.1193"></a><span id="l18.1193" class="difflineplus">+    if (this._chevron._placesView) {</span>
<a href="#l18.1194"></a><span id="l18.1194" class="difflineplus">+      this._chevron._placesView.uninit();</span>
<a href="#l18.1195"></a><span id="l18.1195" class="difflineplus">+    }</span>
<a href="#l18.1196"></a><span id="l18.1196"> </span>
<a href="#l18.1197"></a><span id="l18.1197">     PlacesViewBase.prototype.uninit.apply(this, arguments);</span>
<a href="#l18.1198"></a><span id="l18.1198">   },</span>
<a href="#l18.1199"></a><span id="l18.1199"> </span>
<a href="#l18.1200"></a><span id="l18.1200">   _openedMenuButton: null,</span>
<a href="#l18.1201"></a><span id="l18.1201">   _allowPopupShowing: true,</span>
<a href="#l18.1202"></a><span id="l18.1202"> </span>
<a href="#l18.1203"></a><span id="l18.1203">   _rebuild: function PT__rebuild() {</span>
<a href="#l18.1204"></a><span id="l18.1204">     // Clear out references to existing nodes, since they will be removed</span>
<a href="#l18.1205"></a><span id="l18.1205">     // and re-added.</span>
<a href="#l18.1206"></a><span id="l18.1206">     if (this._overFolder.elt)</span>
<a href="#l18.1207"></a><span id="l18.1207">       this._clearOverFolder();</span>
<a href="#l18.1208"></a><span id="l18.1208"> </span>
<a href="#l18.1209"></a><span id="l18.1209">     this._openedMenuButton = null;</span>
<a href="#l18.1210"></a><span id="l18.1210">     while (this._rootElt.hasChildNodes()) {</span>
<a href="#l18.1211"></a><span id="l18.1211" class="difflineminus">-      this._rootElt.lastChild.remove();</span>
<a href="#l18.1212"></a><span id="l18.1212" class="difflineplus">+      this._rootElt.firstChild.remove();</span>
<a href="#l18.1213"></a><span id="l18.1213">     }</span>
<a href="#l18.1214"></a><span id="l18.1214"> </span>
<a href="#l18.1215"></a><span id="l18.1215">     let cc = this._resultNode.childCount;</span>
<a href="#l18.1216"></a><span id="l18.1216">     for (let i = 0; i &lt; cc; ++i) {</span>
<a href="#l18.1217"></a><span id="l18.1217">       this._insertNewItem(this._resultNode.getChild(i), null);</span>
<a href="#l18.1218"></a><span id="l18.1218">     }</span>
<a href="#l18.1219"></a><span id="l18.1219"> </span>
<a href="#l18.1220"></a><span id="l18.1220">     if (this._chevronPopup.hasAttribute(&quot;type&quot;)) {</span>
<a href="#l18.1221"></a><span id="l18.1221" class="difflineat">@@ -905,53 +1049,48 @@ PlacesToolbar.prototype = {</span>
<a href="#l18.1222"></a><span id="l18.1222">   _insertNewItem:</span>
<a href="#l18.1223"></a><span id="l18.1223">   function PT__insertNewItem(aChild, aBefore) {</span>
<a href="#l18.1224"></a><span id="l18.1224">     this._domNodes.delete(aChild);</span>
<a href="#l18.1225"></a><span id="l18.1225"> </span>
<a href="#l18.1226"></a><span id="l18.1226">     let type = aChild.type;</span>
<a href="#l18.1227"></a><span id="l18.1227">     let button;</span>
<a href="#l18.1228"></a><span id="l18.1228">     if (type == Ci.nsINavHistoryResultNode.RESULT_TYPE_SEPARATOR) {</span>
<a href="#l18.1229"></a><span id="l18.1229">       button = document.createElement(&quot;toolbarseparator&quot;);</span>
<a href="#l18.1230"></a><span id="l18.1230" class="difflineminus">-    }</span>
<a href="#l18.1231"></a><span id="l18.1231" class="difflineminus">-    else {</span>
<a href="#l18.1232"></a><span id="l18.1232" class="difflineplus">+    } else {</span>
<a href="#l18.1233"></a><span id="l18.1233">       button = document.createElement(&quot;toolbarbutton&quot;);</span>
<a href="#l18.1234"></a><span id="l18.1234">       button.className = &quot;bookmark-item&quot;;</span>
<a href="#l18.1235"></a><span id="l18.1235" class="difflineminus">-      button.setAttribute(&quot;label&quot;, aChild.title);</span>
<a href="#l18.1236"></a><span id="l18.1236" class="difflineplus">+      button.setAttribute(&quot;label&quot;, aChild.title || &quot;&quot;);</span>
<a href="#l18.1237"></a><span id="l18.1237">       let icon = aChild.icon;</span>
<a href="#l18.1238"></a><span id="l18.1238">       if (icon)</span>
<a href="#l18.1239"></a><span id="l18.1239">         button.setAttribute(&quot;image&quot;, icon);</span>
<a href="#l18.1240"></a><span id="l18.1240"> </span>
<a href="#l18.1241"></a><span id="l18.1241" class="difflineminus">-      if (PlacesUtils.containerTypes.indexOf(type) != -1) {</span>
<a href="#l18.1242"></a><span id="l18.1242" class="difflineplus">+      if (PlacesUtils.containerTypes.includes(type)) {</span>
<a href="#l18.1243"></a><span id="l18.1243">         button.setAttribute(&quot;type&quot;, &quot;menu&quot;);</span>
<a href="#l18.1244"></a><span id="l18.1244">         button.setAttribute(&quot;container&quot;, &quot;true&quot;);</span>
<a href="#l18.1245"></a><span id="l18.1245"> </span>
<a href="#l18.1246"></a><span id="l18.1246">         if (PlacesUtils.nodeIsQuery(aChild)) {</span>
<a href="#l18.1247"></a><span id="l18.1247">           button.setAttribute(&quot;query&quot;, &quot;true&quot;);</span>
<a href="#l18.1248"></a><span id="l18.1248">           if (PlacesUtils.nodeIsTagQuery(aChild))</span>
<a href="#l18.1249"></a><span id="l18.1249">             button.setAttribute(&quot;tagContainer&quot;, &quot;true&quot;);</span>
<a href="#l18.1250"></a><span id="l18.1250" class="difflineminus">-        }</span>
<a href="#l18.1251"></a><span id="l18.1251" class="difflineminus">-        else if (PlacesUtils.nodeIsFolder(aChild)) {</span>
<a href="#l18.1252"></a><span id="l18.1252" class="difflineplus">+        } else if (PlacesUtils.nodeIsFolder(aChild)) {</span>
<a href="#l18.1253"></a><span id="l18.1253">           PlacesUtils.livemarks.getLivemark({ id: aChild.itemId })</span>
<a href="#l18.1254"></a><span id="l18.1254" class="difflineminus">-                               .then(aLivemark =&gt; {</span>
<a href="#l18.1255"></a><span id="l18.1255" class="difflineminus">-            button.setAttribute(&quot;livemark&quot;, &quot;true&quot;);</span>
<a href="#l18.1256"></a><span id="l18.1256" class="difflineminus">-            this.controller.cacheLivemarkInfo(aChild, aLivemark);</span>
<a href="#l18.1257"></a><span id="l18.1257" class="difflineminus">-          }, () =&gt; undefined);</span>
<a href="#l18.1258"></a><span id="l18.1258" class="difflineplus">+            .then(aLivemark =&gt; {</span>
<a href="#l18.1259"></a><span id="l18.1259" class="difflineplus">+              button.setAttribute(&quot;livemark&quot;, &quot;true&quot;);</span>
<a href="#l18.1260"></a><span id="l18.1260" class="difflineplus">+              this.controller.cacheLivemarkInfo(aChild, aLivemark);</span>
<a href="#l18.1261"></a><span id="l18.1261" class="difflineplus">+            }, () =&gt; undefined);</span>
<a href="#l18.1262"></a><span id="l18.1262">         }</span>
<a href="#l18.1263"></a><span id="l18.1263"> </span>
<a href="#l18.1264"></a><span id="l18.1264">         let popup = document.createElement(&quot;menupopup&quot;);</span>
<a href="#l18.1265"></a><span id="l18.1265">         popup.setAttribute(&quot;placespopup&quot;, &quot;true&quot;);</span>
<a href="#l18.1266"></a><span id="l18.1266">         button.appendChild(popup);</span>
<a href="#l18.1267"></a><span id="l18.1267">         popup._placesNode = PlacesUtils.asContainer(aChild);</span>
<a href="#l18.1268"></a><span id="l18.1268" class="difflineminus">-#ifndef XP_MACOSX</span>
<a href="#l18.1269"></a><span id="l18.1269">         popup.setAttribute(&quot;context&quot;, &quot;placesContext&quot;);</span>
<a href="#l18.1270"></a><span id="l18.1270" class="difflineminus">-#endif</span>
<a href="#l18.1271"></a><span id="l18.1271"> </span>
<a href="#l18.1272"></a><span id="l18.1272">         this._domNodes.set(aChild, popup);</span>
<a href="#l18.1273"></a><span id="l18.1273" class="difflineminus">-      }</span>
<a href="#l18.1274"></a><span id="l18.1274" class="difflineminus">-      else if (PlacesUtils.nodeIsURI(aChild)) {</span>
<a href="#l18.1275"></a><span id="l18.1275" class="difflineplus">+      } else if (PlacesUtils.nodeIsURI(aChild)) {</span>
<a href="#l18.1276"></a><span id="l18.1276">         button.setAttribute(&quot;scheme&quot;,</span>
<a href="#l18.1277"></a><span id="l18.1277">                             PlacesUIUtils.guessUrlSchemeForUI(aChild.uri));</span>
<a href="#l18.1278"></a><span id="l18.1278">       }</span>
<a href="#l18.1279"></a><span id="l18.1279">     }</span>
<a href="#l18.1280"></a><span id="l18.1280"> </span>
<a href="#l18.1281"></a><span id="l18.1281">     button._placesNode = aChild;</span>
<a href="#l18.1282"></a><span id="l18.1282">     if (!this._domNodes.has(aChild))</span>
<a href="#l18.1283"></a><span id="l18.1283">       this._domNodes.set(aChild, button);</span>
<a href="#l18.1284"></a><span id="l18.1284" class="difflineat">@@ -959,19 +1098,20 @@ PlacesToolbar.prototype = {</span>
<a href="#l18.1285"></a><span id="l18.1285">     if (aBefore)</span>
<a href="#l18.1286"></a><span id="l18.1286">       this._rootElt.insertBefore(button, aBefore);</span>
<a href="#l18.1287"></a><span id="l18.1287">     else</span>
<a href="#l18.1288"></a><span id="l18.1288">       this._rootElt.appendChild(button);</span>
<a href="#l18.1289"></a><span id="l18.1289">   },</span>
<a href="#l18.1290"></a><span id="l18.1290"> </span>
<a href="#l18.1291"></a><span id="l18.1291">   _updateChevronPopupNodesVisibility:</span>
<a href="#l18.1292"></a><span id="l18.1292">   function PT__updateChevronPopupNodesVisibility() {</span>
<a href="#l18.1293"></a><span id="l18.1293" class="difflineminus">-    for (let i = 0; i &lt; this._chevronPopup.childNodes.length; i++) {</span>
<a href="#l18.1294"></a><span id="l18.1294" class="difflineminus">-      this._chevronPopup.childNodes[i].hidden =</span>
<a href="#l18.1295"></a><span id="l18.1295" class="difflineminus">-        this._rootElt.childNodes[i].style.visibility != &quot;hidden&quot;;</span>
<a href="#l18.1296"></a><span id="l18.1296" class="difflineplus">+    for (let i = 0, node = this._chevronPopup._startMarker.nextSibling;</span>
<a href="#l18.1297"></a><span id="l18.1297" class="difflineplus">+         node != this._chevronPopup._endMarker;</span>
<a href="#l18.1298"></a><span id="l18.1298" class="difflineplus">+         i++, node = node.nextSibling) {</span>
<a href="#l18.1299"></a><span id="l18.1299" class="difflineplus">+      node.hidden = this._rootElt.childNodes[i].style.visibility != &quot;hidden&quot;;</span>
<a href="#l18.1300"></a><span id="l18.1300">     }</span>
<a href="#l18.1301"></a><span id="l18.1301">   },</span>
<a href="#l18.1302"></a><span id="l18.1302"> </span>
<a href="#l18.1303"></a><span id="l18.1303">   _onChevronPopupShowing:</span>
<a href="#l18.1304"></a><span id="l18.1304">   function PT__onChevronPopupShowing(aEvent) {</span>
<a href="#l18.1305"></a><span id="l18.1305">     // Handle popupshowing only for the chevron popup, not for nested ones.</span>
<a href="#l18.1306"></a><span id="l18.1306">     if (aEvent.target != this._chevronPopup)</span>
<a href="#l18.1307"></a><span id="l18.1307">       return;</span>
<a href="#l18.1308"></a><span id="l18.1308" class="difflineat">@@ -989,41 +1129,27 @@ PlacesToolbar.prototype = {</span>
<a href="#l18.1309"></a><span id="l18.1309">         break;</span>
<a href="#l18.1310"></a><span id="l18.1310">       case &quot;resize&quot;:</span>
<a href="#l18.1311"></a><span id="l18.1311">         // This handler updates nodes visibility in both the toolbar</span>
<a href="#l18.1312"></a><span id="l18.1312">         // and the chevron popup when a window resize does not change</span>
<a href="#l18.1313"></a><span id="l18.1313">         // the overflow status of the toolbar.</span>
<a href="#l18.1314"></a><span id="l18.1314">         this.updateChevron();</span>
<a href="#l18.1315"></a><span id="l18.1315">         break;</span>
<a href="#l18.1316"></a><span id="l18.1316">       case &quot;overflow&quot;:</span>
<a href="#l18.1317"></a><span id="l18.1317" class="difflineminus">-        if (aEvent.target != aEvent.currentTarget)</span>
<a href="#l18.1318"></a><span id="l18.1318" class="difflineminus">-          return;</span>
<a href="#l18.1319"></a><span id="l18.1319" class="difflineminus">-</span>
<a href="#l18.1320"></a><span id="l18.1320" class="difflineminus">-        // Ignore purely vertical overflows.</span>
<a href="#l18.1321"></a><span id="l18.1321" class="difflineminus">-        if (aEvent.detail == 0)</span>
<a href="#l18.1322"></a><span id="l18.1322" class="difflineplus">+        if (!this._isOverflowStateEventRelevant(aEvent))</span>
<a href="#l18.1323"></a><span id="l18.1323">           return;</span>
<a href="#l18.1324"></a><span id="l18.1324" class="difflineminus">-</span>
<a href="#l18.1325"></a><span id="l18.1325" class="difflineminus">-        // Attach the popup binding to the chevron popup if it has not yet</span>
<a href="#l18.1326"></a><span id="l18.1326" class="difflineminus">-        // been initialized.</span>
<a href="#l18.1327"></a><span id="l18.1327" class="difflineminus">-        if (!this._chevronPopup.hasAttribute(&quot;type&quot;)) {</span>
<a href="#l18.1328"></a><span id="l18.1328" class="difflineminus">-          this._chevronPopup.setAttribute(&quot;place&quot;, this.place);</span>
<a href="#l18.1329"></a><span id="l18.1329" class="difflineminus">-          this._chevronPopup.setAttribute(&quot;type&quot;, &quot;places&quot;);</span>
<a href="#l18.1330"></a><span id="l18.1330" class="difflineminus">-        }</span>
<a href="#l18.1331"></a><span id="l18.1331" class="difflineminus">-        this._chevron.collapsed = false;</span>
<a href="#l18.1332"></a><span id="l18.1332" class="difflineminus">-        this.updateChevron();</span>
<a href="#l18.1333"></a><span id="l18.1333" class="difflineplus">+        this._onOverflow();</span>
<a href="#l18.1334"></a><span id="l18.1334">         break;</span>
<a href="#l18.1335"></a><span id="l18.1335">       case &quot;underflow&quot;:</span>
<a href="#l18.1336"></a><span id="l18.1336" class="difflineminus">-        if (aEvent.target != aEvent.currentTarget)</span>
<a href="#l18.1337"></a><span id="l18.1337" class="difflineplus">+        if (!this._isOverflowStateEventRelevant(aEvent))</span>
<a href="#l18.1338"></a><span id="l18.1338">           return;</span>
<a href="#l18.1339"></a><span id="l18.1339" class="difflineminus">-</span>
<a href="#l18.1340"></a><span id="l18.1340" class="difflineminus">-        // Ignore purely vertical underflows.</span>
<a href="#l18.1341"></a><span id="l18.1341" class="difflineminus">-        if (aEvent.detail == 0)</span>
<a href="#l18.1342"></a><span id="l18.1342" class="difflineminus">-          return;</span>
<a href="#l18.1343"></a><span id="l18.1343" class="difflineminus">-</span>
<a href="#l18.1344"></a><span id="l18.1344" class="difflineminus">-        this._chevron.collapsed = true;</span>
<a href="#l18.1345"></a><span id="l18.1345" class="difflineplus">+        this._onUnderflow();</span>
<a href="#l18.1346"></a><span id="l18.1346" class="difflineplus">+        break;</span>
<a href="#l18.1347"></a><span id="l18.1347" class="difflineplus">+      case &quot;TabOpen&quot;:</span>
<a href="#l18.1348"></a><span id="l18.1348" class="difflineplus">+      case &quot;TabClose&quot;:</span>
<a href="#l18.1349"></a><span id="l18.1349">         this.updateChevron();</span>
<a href="#l18.1350"></a><span id="l18.1350">         break;</span>
<a href="#l18.1351"></a><span id="l18.1351">       case &quot;dragstart&quot;:</span>
<a href="#l18.1352"></a><span id="l18.1352">         this._onDragStart(aEvent);</span>
<a href="#l18.1353"></a><span id="l18.1353">         break;</span>
<a href="#l18.1354"></a><span id="l18.1354">       case &quot;dragover&quot;:</span>
<a href="#l18.1355"></a><span id="l18.1355">         this._onDragOver(aEvent);</span>
<a href="#l18.1356"></a><span id="l18.1356">         break;</span>
<a href="#l18.1357"></a><span id="l18.1357" class="difflineat">@@ -1040,37 +1166,56 @@ PlacesToolbar.prototype = {</span>
<a href="#l18.1358"></a><span id="l18.1358">         this._onMouseOver(aEvent);</span>
<a href="#l18.1359"></a><span id="l18.1359">         break;</span>
<a href="#l18.1360"></a><span id="l18.1360">       case &quot;mousemove&quot;:</span>
<a href="#l18.1361"></a><span id="l18.1361">         this._onMouseMove(aEvent);</span>
<a href="#l18.1362"></a><span id="l18.1362">         break;</span>
<a href="#l18.1363"></a><span id="l18.1363">       case &quot;mouseout&quot;:</span>
<a href="#l18.1364"></a><span id="l18.1364">         this._onMouseOut(aEvent);</span>
<a href="#l18.1365"></a><span id="l18.1365">         break;</span>
<a href="#l18.1366"></a><span id="l18.1366" class="difflineminus">-#ifdef XP_UNIX</span>
<a href="#l18.1367"></a><span id="l18.1367" class="difflineminus">-#ifndef XP_MACOSX</span>
<a href="#l18.1368"></a><span id="l18.1368" class="difflineminus">-      case &quot;mouseup&quot;:</span>
<a href="#l18.1369"></a><span id="l18.1369" class="difflineminus">-        this._onMouseUp(aEvent);</span>
<a href="#l18.1370"></a><span id="l18.1370" class="difflineminus">-        break;</span>
<a href="#l18.1371"></a><span id="l18.1371" class="difflineminus">-      case &quot;mousedown&quot;:</span>
<a href="#l18.1372"></a><span id="l18.1372" class="difflineminus">-        this._onMouseDown(aEvent);</span>
<a href="#l18.1373"></a><span id="l18.1373" class="difflineminus">-        break;</span>
<a href="#l18.1374"></a><span id="l18.1374" class="difflineminus">-#endif</span>
<a href="#l18.1375"></a><span id="l18.1375" class="difflineminus">-#endif</span>
<a href="#l18.1376"></a><span id="l18.1376">       case &quot;popupshowing&quot;:</span>
<a href="#l18.1377"></a><span id="l18.1377">         this._onPopupShowing(aEvent);</span>
<a href="#l18.1378"></a><span id="l18.1378">         break;</span>
<a href="#l18.1379"></a><span id="l18.1379">       case &quot;popuphidden&quot;:</span>
<a href="#l18.1380"></a><span id="l18.1380">         this._onPopupHidden(aEvent);</span>
<a href="#l18.1381"></a><span id="l18.1381">         break;</span>
<a href="#l18.1382"></a><span id="l18.1382">       default:</span>
<a href="#l18.1383"></a><span id="l18.1383">         throw &quot;Trying to handle unexpected event.&quot;;</span>
<a href="#l18.1384"></a><span id="l18.1384">     }</span>
<a href="#l18.1385"></a><span id="l18.1385">   },</span>
<a href="#l18.1386"></a><span id="l18.1386"> </span>
<a href="#l18.1387"></a><span id="l18.1387" class="difflineplus">+  updateOverflowStatus() {</span>
<a href="#l18.1388"></a><span id="l18.1388" class="difflineplus">+    if (this._rootElt.scrollLeftMin != this._rootElt.scrollLeftMax) {</span>
<a href="#l18.1389"></a><span id="l18.1389" class="difflineplus">+      this._onOverflow();</span>
<a href="#l18.1390"></a><span id="l18.1390" class="difflineplus">+    } else {</span>
<a href="#l18.1391"></a><span id="l18.1391" class="difflineplus">+      this._onUnderflow();</span>
<a href="#l18.1392"></a><span id="l18.1392" class="difflineplus">+    }</span>
<a href="#l18.1393"></a><span id="l18.1393" class="difflineplus">+  },</span>
<a href="#l18.1394"></a><span id="l18.1394" class="difflineplus">+</span>
<a href="#l18.1395"></a><span id="l18.1395" class="difflineplus">+  _isOverflowStateEventRelevant: function PT_isOverflowStateEventRelevant(aEvent) {</span>
<a href="#l18.1396"></a><span id="l18.1396" class="difflineplus">+    // Ignore events not aimed at ourselves, as well as purely vertical ones:</span>
<a href="#l18.1397"></a><span id="l18.1397" class="difflineplus">+    return aEvent.target == aEvent.currentTarget &amp;&amp; aEvent.detail &gt; 0;</span>
<a href="#l18.1398"></a><span id="l18.1398" class="difflineplus">+  },</span>
<a href="#l18.1399"></a><span id="l18.1399" class="difflineplus">+</span>
<a href="#l18.1400"></a><span id="l18.1400" class="difflineplus">+  _onOverflow: function PT_onOverflow() {</span>
<a href="#l18.1401"></a><span id="l18.1401" class="difflineplus">+    // Attach the popup binding to the chevron popup if it has not yet</span>
<a href="#l18.1402"></a><span id="l18.1402" class="difflineplus">+    // been initialized.</span>
<a href="#l18.1403"></a><span id="l18.1403" class="difflineplus">+    if (!this._chevronPopup.hasAttribute(&quot;type&quot;)) {</span>
<a href="#l18.1404"></a><span id="l18.1404" class="difflineplus">+      this._chevronPopup.setAttribute(&quot;place&quot;, this.place);</span>
<a href="#l18.1405"></a><span id="l18.1405" class="difflineplus">+      this._chevronPopup.setAttribute(&quot;type&quot;, &quot;places&quot;);</span>
<a href="#l18.1406"></a><span id="l18.1406" class="difflineplus">+    }</span>
<a href="#l18.1407"></a><span id="l18.1407" class="difflineplus">+    this._chevron.collapsed = false;</span>
<a href="#l18.1408"></a><span id="l18.1408" class="difflineplus">+    this.updateChevron();</span>
<a href="#l18.1409"></a><span id="l18.1409" class="difflineplus">+  },</span>
<a href="#l18.1410"></a><span id="l18.1410" class="difflineplus">+</span>
<a href="#l18.1411"></a><span id="l18.1411" class="difflineplus">+  _onUnderflow: function PT_onUnderflow() {</span>
<a href="#l18.1412"></a><span id="l18.1412" class="difflineplus">+    this.updateChevron();</span>
<a href="#l18.1413"></a><span id="l18.1413" class="difflineplus">+    this._chevron.collapsed = true;</span>
<a href="#l18.1414"></a><span id="l18.1414" class="difflineplus">+  },</span>
<a href="#l18.1415"></a><span id="l18.1415" class="difflineplus">+</span>
<a href="#l18.1416"></a><span id="l18.1416">   updateChevron: function PT_updateChevron() {</span>
<a href="#l18.1417"></a><span id="l18.1417">     // If the chevron is collapsed there's nothing to update.</span>
<a href="#l18.1418"></a><span id="l18.1418">     if (this._chevron.collapsed)</span>
<a href="#l18.1419"></a><span id="l18.1419">       return;</span>
<a href="#l18.1420"></a><span id="l18.1420"> </span>
<a href="#l18.1421"></a><span id="l18.1421">     // Update the chevron on a timer.  This will avoid repeated work when</span>
<a href="#l18.1422"></a><span id="l18.1422">     // lot of changes happen in a small timeframe.</span>
<a href="#l18.1423"></a><span id="l18.1423">     if (this._updateChevronTimer)</span>
<a href="#l18.1424"></a><span id="l18.1424" class="difflineat">@@ -1082,18 +1227,19 @@ PlacesToolbar.prototype = {</span>
<a href="#l18.1425"></a><span id="l18.1425">   _updateChevronTimerCallback: function PT__updateChevronTimerCallback() {</span>
<a href="#l18.1426"></a><span id="l18.1426">     let scrollRect = this._rootElt.getBoundingClientRect();</span>
<a href="#l18.1427"></a><span id="l18.1427">     let childOverflowed = false;</span>
<a href="#l18.1428"></a><span id="l18.1428">     for (let i = 0; i &lt; this._rootElt.childNodes.length; i++) {</span>
<a href="#l18.1429"></a><span id="l18.1429">       let child = this._rootElt.childNodes[i];</span>
<a href="#l18.1430"></a><span id="l18.1430">       // Once a child overflows, all the next ones will.</span>
<a href="#l18.1431"></a><span id="l18.1431">       if (!childOverflowed) {</span>
<a href="#l18.1432"></a><span id="l18.1432">         let childRect = child.getBoundingClientRect();</span>
<a href="#l18.1433"></a><span id="l18.1433" class="difflineminus">-        childOverflowed = this._isRTL ? (childRect.left &lt; scrollRect.left)</span>
<a href="#l18.1434"></a><span id="l18.1434" class="difflineminus">-                                      : (childRect.right &gt; scrollRect.right);</span>
<a href="#l18.1435"></a><span id="l18.1435" class="difflineplus">+        childOverflowed = this.isRTL ? (childRect.left &lt; scrollRect.left)</span>
<a href="#l18.1436"></a><span id="l18.1436" class="difflineplus">+                                     : (childRect.right &gt; scrollRect.right);</span>
<a href="#l18.1437"></a><span id="l18.1437" class="difflineplus">+</span>
<a href="#l18.1438"></a><span id="l18.1438">       }</span>
<a href="#l18.1439"></a><span id="l18.1439">       child.style.visibility = childOverflowed ? &quot;hidden&quot; : &quot;visible&quot;;</span>
<a href="#l18.1440"></a><span id="l18.1440">     }</span>
<a href="#l18.1441"></a><span id="l18.1441"> </span>
<a href="#l18.1442"></a><span id="l18.1442">     // We rebuild the chevron on popupShowing, so if it is open</span>
<a href="#l18.1443"></a><span id="l18.1443">     // we must update it.</span>
<a href="#l18.1444"></a><span id="l18.1444">     if (this._chevron.open)</span>
<a href="#l18.1445"></a><span id="l18.1445">       this._updateChevronPopupNodesVisibility();</span>
<a href="#l18.1446"></a><span id="l18.1446" class="difflineat">@@ -1144,24 +1290,23 @@ PlacesToolbar.prototype = {</span>
<a href="#l18.1447"></a><span id="l18.1447"> </span>
<a href="#l18.1448"></a><span id="l18.1448">       // Here we need the &lt;menu&gt;.</span>
<a href="#l18.1449"></a><span id="l18.1449">       if (elt.localName == &quot;menupopup&quot;)</span>
<a href="#l18.1450"></a><span id="l18.1450">         elt = elt.parentNode;</span>
<a href="#l18.1451"></a><span id="l18.1451"> </span>
<a href="#l18.1452"></a><span id="l18.1452">       this._removeChild(elt);</span>
<a href="#l18.1453"></a><span id="l18.1453">       this._rootElt.insertBefore(elt, this._rootElt.childNodes[aNewIndex]);</span>
<a href="#l18.1454"></a><span id="l18.1454"> </span>
<a href="#l18.1455"></a><span id="l18.1455" class="difflineminus">-      // If the chevron popup is open, keep it in sync.</span>
<a href="#l18.1456"></a><span id="l18.1456" class="difflineminus">-      if (this._chevron.open) {</span>
<a href="#l18.1457"></a><span id="l18.1457" class="difflineminus">-        let chevronPopup = this._chevronPopup;</span>
<a href="#l18.1458"></a><span id="l18.1458" class="difflineminus">-        let menuitem = chevronPopup.childNodes[aOldIndex];</span>
<a href="#l18.1459"></a><span id="l18.1459" class="difflineminus">-        menuitem.remove();</span>
<a href="#l18.1460"></a><span id="l18.1460" class="difflineminus">-        chevronPopup.insertBefore(menuitem,</span>
<a href="#l18.1461"></a><span id="l18.1461" class="difflineminus">-                                  chevronPopup.childNodes[aNewIndex]);</span>
<a href="#l18.1462"></a><span id="l18.1462" class="difflineminus">-      }</span>
<a href="#l18.1463"></a><span id="l18.1463" class="difflineplus">+      // The chevron view may get nodeMoved after the toolbar.  In such a case,</span>
<a href="#l18.1464"></a><span id="l18.1464" class="difflineplus">+      // we should ensure (by manually swapping menuitems) that the actual nodes</span>
<a href="#l18.1465"></a><span id="l18.1465" class="difflineplus">+      // are in the final position before updateChevron tries to updates their</span>
<a href="#l18.1466"></a><span id="l18.1466" class="difflineplus">+      // visibility, or the chevron may go out of sync.</span>
<a href="#l18.1467"></a><span id="l18.1467" class="difflineplus">+      // Luckily updateChevron runs on a timer, so, by the time it updates</span>
<a href="#l18.1468"></a><span id="l18.1468" class="difflineplus">+      // nodes, the menu has already handled the notification.</span>
<a href="#l18.1469"></a><span id="l18.1469" class="difflineplus">+</span>
<a href="#l18.1470"></a><span id="l18.1470">       this.updateChevron();</span>
<a href="#l18.1471"></a><span id="l18.1471">       return;</span>
<a href="#l18.1472"></a><span id="l18.1472">     }</span>
<a href="#l18.1473"></a><span id="l18.1473"> </span>
<a href="#l18.1474"></a><span id="l18.1474">     PlacesViewBase.prototype.nodeMoved.apply(this, arguments);</span>
<a href="#l18.1475"></a><span id="l18.1475">   },</span>
<a href="#l18.1476"></a><span id="l18.1476"> </span>
<a href="#l18.1477"></a><span id="l18.1477">   nodeAnnotationChanged:</span>
<a href="#l18.1478"></a><span id="l18.1478" class="difflineat">@@ -1171,29 +1316,31 @@ PlacesToolbar.prototype = {</span>
<a href="#l18.1479"></a><span id="l18.1479">       return;</span>
<a href="#l18.1480"></a><span id="l18.1480"> </span>
<a href="#l18.1481"></a><span id="l18.1481">     // We're notified for the menupopup, not the containing toolbarbutton.</span>
<a href="#l18.1482"></a><span id="l18.1482">     if (elt.localName == &quot;menupopup&quot;)</span>
<a href="#l18.1483"></a><span id="l18.1483">       elt = elt.parentNode;</span>
<a href="#l18.1484"></a><span id="l18.1484"> </span>
<a href="#l18.1485"></a><span id="l18.1485">     if (elt.parentNode == this._rootElt) {</span>
<a href="#l18.1486"></a><span id="l18.1486">       // Node is on the toolbar.</span>
<a href="#l18.1487"></a><span id="l18.1487" class="difflineplus">+</span>
<a href="#l18.1488"></a><span id="l18.1488">       // All livemarks have a feedURI, so use it as our indicator.</span>
<a href="#l18.1489"></a><span id="l18.1489">       if (aAnno == PlacesUtils.LMANNO_FEEDURI) {</span>
<a href="#l18.1490"></a><span id="l18.1490">         elt.setAttribute(&quot;livemark&quot;, true);</span>
<a href="#l18.1491"></a><span id="l18.1491"> </span>
<a href="#l18.1492"></a><span id="l18.1492">         PlacesUtils.livemarks.getLivemark({ id: aPlacesNode.itemId })</span>
<a href="#l18.1493"></a><span id="l18.1493" class="difflineminus">-                             .then(aLivemark =&gt; {</span>
<a href="#l18.1494"></a><span id="l18.1494" class="difflineminus">-          this.controller.cacheLivemarkInfo(aPlacesNode, aLivemark);</span>
<a href="#l18.1495"></a><span id="l18.1495" class="difflineminus">-          this.invalidateContainer(aPlacesNode);</span>
<a href="#l18.1496"></a><span id="l18.1496" class="difflineminus">-        }, () =&gt; undefined);</span>
<a href="#l18.1497"></a><span id="l18.1497" class="difflineplus">+          .then(aLivemark =&gt; {</span>
<a href="#l18.1498"></a><span id="l18.1498" class="difflineplus">+            this.controller.cacheLivemarkInfo(aPlacesNode, aLivemark);</span>
<a href="#l18.1499"></a><span id="l18.1499" class="difflineplus">+            this.invalidateContainer(aPlacesNode);</span>
<a href="#l18.1500"></a><span id="l18.1500" class="difflineplus">+          }, Cu.reportError);</span>
<a href="#l18.1501"></a><span id="l18.1501">       }</span>
<a href="#l18.1502"></a><span id="l18.1502" class="difflineplus">+    } else {</span>
<a href="#l18.1503"></a><span id="l18.1503" class="difflineplus">+      // Node is in a submenu.</span>
<a href="#l18.1504"></a><span id="l18.1504" class="difflineplus">+      PlacesViewBase.prototype.nodeAnnotationChanged.apply(this, arguments);</span>
<a href="#l18.1505"></a><span id="l18.1505">     }</span>
<a href="#l18.1506"></a><span id="l18.1506" class="difflineminus">-</span>
<a href="#l18.1507"></a><span id="l18.1507" class="difflineminus">-    PlacesViewBase.prototype.nodeAnnotationChanged.apply(this, arguments);</span>
<a href="#l18.1508"></a><span id="l18.1508">   },</span>
<a href="#l18.1509"></a><span id="l18.1509"> </span>
<a href="#l18.1510"></a><span id="l18.1510">   nodeTitleChanged: function PT_nodeTitleChanged(aPlacesNode, aNewTitle) {</span>
<a href="#l18.1511"></a><span id="l18.1511">     let elt = this._getDOMNodeForPlacesNode(aPlacesNode);</span>
<a href="#l18.1512"></a><span id="l18.1512"> </span>
<a href="#l18.1513"></a><span id="l18.1513">     // There's no UI representation for the root node, thus there's</span>
<a href="#l18.1514"></a><span id="l18.1514">     // nothing to be done when the title changes.</span>
<a href="#l18.1515"></a><span id="l18.1515">     if (elt == this._rootElt)</span>
<a href="#l18.1516"></a><span id="l18.1516" class="difflineat">@@ -1251,132 +1398,117 @@ PlacesToolbar.prototype = {</span>
<a href="#l18.1517"></a><span id="l18.1517">   /**</span>
<a href="#l18.1518"></a><span id="l18.1518">    * This function returns information about where to drop when dragging over</span>
<a href="#l18.1519"></a><span id="l18.1519">    * the toolbar.  The returned object has the following properties:</span>
<a href="#l18.1520"></a><span id="l18.1520">    * - ip: the insertion point for the bookmarks service.</span>
<a href="#l18.1521"></a><span id="l18.1521">    * - beforeIndex: child index to drop before, for the drop indicator.</span>
<a href="#l18.1522"></a><span id="l18.1522">    * - folderElt: the folder to drop into, if applicable.</span>
<a href="#l18.1523"></a><span id="l18.1523">    */</span>
<a href="#l18.1524"></a><span id="l18.1524">   _getDropPoint: function PT__getDropPoint(aEvent) {</span>
<a href="#l18.1525"></a><span id="l18.1525" class="difflineminus">-    let result = this.result;</span>
<a href="#l18.1526"></a><span id="l18.1526">     if (!PlacesUtils.nodeIsFolder(this._resultNode))</span>
<a href="#l18.1527"></a><span id="l18.1527">       return null;</span>
<a href="#l18.1528"></a><span id="l18.1528"> </span>
<a href="#l18.1529"></a><span id="l18.1529">     let dropPoint = { ip: null, beforeIndex: null, folderElt: null };</span>
<a href="#l18.1530"></a><span id="l18.1530">     let elt = aEvent.target;</span>
<a href="#l18.1531"></a><span id="l18.1531">     if (elt._placesNode &amp;&amp; elt != this._rootElt &amp;&amp;</span>
<a href="#l18.1532"></a><span id="l18.1532">         elt.localName != &quot;menupopup&quot;) {</span>
<a href="#l18.1533"></a><span id="l18.1533">       let eltRect = elt.getBoundingClientRect();</span>
<a href="#l18.1534"></a><span id="l18.1534" class="difflineminus">-      let eltIndex = Array.from(this._rootElt.childNodes).indexOf(elt);</span>
<a href="#l18.1535"></a><span id="l18.1535" class="difflineplus">+      let eltIndex = Array.prototype.indexOf.call(this._rootElt.childNodes, elt);</span>
<a href="#l18.1536"></a><span id="l18.1536">       if (PlacesUtils.nodeIsFolder(elt._placesNode) &amp;&amp;</span>
<a href="#l18.1537"></a><span id="l18.1537">           !PlacesUIUtils.isContentsReadOnly(elt._placesNode)) {</span>
<a href="#l18.1538"></a><span id="l18.1538">         // This is a folder.</span>
<a href="#l18.1539"></a><span id="l18.1539">         // If we are in the middle of it, drop inside it.</span>
<a href="#l18.1540"></a><span id="l18.1540">         // Otherwise, drop before it, with regards to RTL mode.</span>
<a href="#l18.1541"></a><span id="l18.1541">         let threshold = eltRect.width * 0.25;</span>
<a href="#l18.1542"></a><span id="l18.1542" class="difflineminus">-        if (this._isRTL ? (aEvent.clientX &gt; eltRect.right - threshold)</span>
<a href="#l18.1543"></a><span id="l18.1543" class="difflineminus">-                        : (aEvent.clientX &lt; eltRect.left + threshold)) {</span>
<a href="#l18.1544"></a><span id="l18.1544" class="difflineplus">+        if (this.isRTL ? (aEvent.clientX &gt; eltRect.right - threshold)</span>
<a href="#l18.1545"></a><span id="l18.1545" class="difflineplus">+                       : (aEvent.clientX &lt; eltRect.left + threshold)) {</span>
<a href="#l18.1546"></a><span id="l18.1546">           // Drop before this folder.</span>
<a href="#l18.1547"></a><span id="l18.1547">           dropPoint.ip =</span>
<a href="#l18.1548"></a><span id="l18.1548">             new InsertionPoint(PlacesUtils.getConcreteItemId(this._resultNode),</span>
<a href="#l18.1549"></a><span id="l18.1549" class="difflineminus">-                               eltIndex,</span>
<a href="#l18.1550"></a><span id="l18.1550" class="difflineminus">-                               Ci.nsITreeView.DROP_BEFORE);</span>
<a href="#l18.1551"></a><span id="l18.1551" class="difflineplus">+                               eltIndex, Ci.nsITreeView.DROP_BEFORE);</span>
<a href="#l18.1552"></a><span id="l18.1552">           dropPoint.beforeIndex = eltIndex;</span>
<a href="#l18.1553"></a><span id="l18.1553" class="difflineminus">-        }</span>
<a href="#l18.1554"></a><span id="l18.1554" class="difflineminus">-        else if (this._isRTL ? (aEvent.clientX &gt; eltRect.left + threshold)</span>
<a href="#l18.1555"></a><span id="l18.1555" class="difflineminus">-                             : (aEvent.clientX &lt; eltRect.right - threshold)) {</span>
<a href="#l18.1556"></a><span id="l18.1556" class="difflineplus">+        } else if (this.isRTL ? (aEvent.clientX &gt; eltRect.left + threshold)</span>
<a href="#l18.1557"></a><span id="l18.1557" class="difflineplus">+                            : (aEvent.clientX &lt; eltRect.right - threshold)) {</span>
<a href="#l18.1558"></a><span id="l18.1558">           // Drop inside this folder.</span>
<a href="#l18.1559"></a><span id="l18.1559" class="difflineplus">+          let tagName = PlacesUtils.nodeIsTagQuery(elt._placesNode) ?</span>
<a href="#l18.1560"></a><span id="l18.1560" class="difflineplus">+                        elt._placesNode.title : null;</span>
<a href="#l18.1561"></a><span id="l18.1561">           dropPoint.ip =</span>
<a href="#l18.1562"></a><span id="l18.1562">             new InsertionPoint(PlacesUtils.getConcreteItemId(elt._placesNode),</span>
<a href="#l18.1563"></a><span id="l18.1563">                                -1, Ci.nsITreeView.DROP_ON,</span>
<a href="#l18.1564"></a><span id="l18.1564" class="difflineminus">-                               PlacesUtils.nodeIsTagQuery(elt._placesNode));</span>
<a href="#l18.1565"></a><span id="l18.1565" class="difflineplus">+                               tagName);</span>
<a href="#l18.1566"></a><span id="l18.1566">           dropPoint.beforeIndex = eltIndex;</span>
<a href="#l18.1567"></a><span id="l18.1567">           dropPoint.folderElt = elt;</span>
<a href="#l18.1568"></a><span id="l18.1568" class="difflineminus">-        }</span>
<a href="#l18.1569"></a><span id="l18.1569" class="difflineminus">-        else {</span>
<a href="#l18.1570"></a><span id="l18.1570" class="difflineplus">+        } else {</span>
<a href="#l18.1571"></a><span id="l18.1571">           // Drop after this folder.</span>
<a href="#l18.1572"></a><span id="l18.1572">           let beforeIndex =</span>
<a href="#l18.1573"></a><span id="l18.1573">             (eltIndex == this._rootElt.childNodes.length - 1) ?</span>
<a href="#l18.1574"></a><span id="l18.1574">             -1 : eltIndex + 1;</span>
<a href="#l18.1575"></a><span id="l18.1575"> </span>
<a href="#l18.1576"></a><span id="l18.1576">           dropPoint.ip =</span>
<a href="#l18.1577"></a><span id="l18.1577">             new InsertionPoint(PlacesUtils.getConcreteItemId(this._resultNode),</span>
<a href="#l18.1578"></a><span id="l18.1578" class="difflineminus">-                               beforeIndex,</span>
<a href="#l18.1579"></a><span id="l18.1579" class="difflineminus">-                               Ci.nsITreeView.DROP_BEFORE);</span>
<a href="#l18.1580"></a><span id="l18.1580" class="difflineplus">+                               beforeIndex, Ci.nsITreeView.DROP_BEFORE);</span>
<a href="#l18.1581"></a><span id="l18.1581">           dropPoint.beforeIndex = beforeIndex;</span>
<a href="#l18.1582"></a><span id="l18.1582">         }</span>
<a href="#l18.1583"></a><span id="l18.1583" class="difflineminus">-      }</span>
<a href="#l18.1584"></a><span id="l18.1584" class="difflineminus">-      else {</span>
<a href="#l18.1585"></a><span id="l18.1585" class="difflineplus">+      } else {</span>
<a href="#l18.1586"></a><span id="l18.1586">         // This is a non-folder node or a read-only folder.</span>
<a href="#l18.1587"></a><span id="l18.1587">         // Drop before it with regards to RTL mode.</span>
<a href="#l18.1588"></a><span id="l18.1588">         let threshold = eltRect.width * 0.5;</span>
<a href="#l18.1589"></a><span id="l18.1589" class="difflineminus">-        if (this._isRTL ? (aEvent.clientX &gt; eltRect.left + threshold)</span>
<a href="#l18.1590"></a><span id="l18.1590" class="difflineminus">-                        : (aEvent.clientX &lt; eltRect.left + threshold)) {</span>
<a href="#l18.1591"></a><span id="l18.1591" class="difflineplus">+        if (this.isRTL ? (aEvent.clientX &gt; eltRect.left + threshold)</span>
<a href="#l18.1592"></a><span id="l18.1592" class="difflineplus">+                       : (aEvent.clientX &lt; eltRect.left + threshold)) {</span>
<a href="#l18.1593"></a><span id="l18.1593">           // Drop before this bookmark.</span>
<a href="#l18.1594"></a><span id="l18.1594">           dropPoint.ip =</span>
<a href="#l18.1595"></a><span id="l18.1595">             new InsertionPoint(PlacesUtils.getConcreteItemId(this._resultNode),</span>
<a href="#l18.1596"></a><span id="l18.1596" class="difflineminus">-                               eltIndex,</span>
<a href="#l18.1597"></a><span id="l18.1597" class="difflineminus">-                               Ci.nsITreeView.DROP_BEFORE);</span>
<a href="#l18.1598"></a><span id="l18.1598" class="difflineplus">+                               eltIndex, Ci.nsITreeView.DROP_BEFORE);</span>
<a href="#l18.1599"></a><span id="l18.1599">           dropPoint.beforeIndex = eltIndex;</span>
<a href="#l18.1600"></a><span id="l18.1600" class="difflineminus">-        }</span>
<a href="#l18.1601"></a><span id="l18.1601" class="difflineminus">-        else {</span>
<a href="#l18.1602"></a><span id="l18.1602" class="difflineplus">+        } else {</span>
<a href="#l18.1603"></a><span id="l18.1603">           // Drop after this bookmark.</span>
<a href="#l18.1604"></a><span id="l18.1604">           let beforeIndex =</span>
<a href="#l18.1605"></a><span id="l18.1605">             eltIndex == this._rootElt.childNodes.length - 1 ?</span>
<a href="#l18.1606"></a><span id="l18.1606">             -1 : eltIndex + 1;</span>
<a href="#l18.1607"></a><span id="l18.1607">           dropPoint.ip =</span>
<a href="#l18.1608"></a><span id="l18.1608">             new InsertionPoint(PlacesUtils.getConcreteItemId(this._resultNode),</span>
<a href="#l18.1609"></a><span id="l18.1609" class="difflineminus">-                               beforeIndex,</span>
<a href="#l18.1610"></a><span id="l18.1610" class="difflineminus">-                               Ci.nsITreeView.DROP_BEFORE);</span>
<a href="#l18.1611"></a><span id="l18.1611" class="difflineplus">+                               beforeIndex, Ci.nsITreeView.DROP_BEFORE);</span>
<a href="#l18.1612"></a><span id="l18.1612">           dropPoint.beforeIndex = beforeIndex;</span>
<a href="#l18.1613"></a><span id="l18.1613">         }</span>
<a href="#l18.1614"></a><span id="l18.1614">       }</span>
<a href="#l18.1615"></a><span id="l18.1615" class="difflineminus">-    }</span>
<a href="#l18.1616"></a><span id="l18.1616" class="difflineminus">-    else {</span>
<a href="#l18.1617"></a><span id="l18.1617" class="difflineplus">+    } else {</span>
<a href="#l18.1618"></a><span id="l18.1618">       // We are most likely dragging on the empty area of the</span>
<a href="#l18.1619"></a><span id="l18.1619">       // toolbar, we should drop after the last node.</span>
<a href="#l18.1620"></a><span id="l18.1620">       dropPoint.ip =</span>
<a href="#l18.1621"></a><span id="l18.1621">         new InsertionPoint(PlacesUtils.getConcreteItemId(this._resultNode),</span>
<a href="#l18.1622"></a><span id="l18.1622">                            -1, Ci.nsITreeView.DROP_BEFORE);</span>
<a href="#l18.1623"></a><span id="l18.1623">       dropPoint.beforeIndex = -1;</span>
<a href="#l18.1624"></a><span id="l18.1624">     }</span>
<a href="#l18.1625"></a><span id="l18.1625"> </span>
<a href="#l18.1626"></a><span id="l18.1626">     return dropPoint;</span>
<a href="#l18.1627"></a><span id="l18.1627">   },</span>
<a href="#l18.1628"></a><span id="l18.1628"> </span>
<a href="#l18.1629"></a><span id="l18.1629">   _setTimer: function PT_setTimer(aTime) {</span>
<a href="#l18.1630"></a><span id="l18.1630" class="difflineminus">-    let timer = Cc[&quot;@mozilla.org/timer;1&quot;]</span>
<a href="#l18.1631"></a><span id="l18.1631" class="difflineminus">-                  .createInstance(Ci.nsITimer);</span>
<a href="#l18.1632"></a><span id="l18.1632" class="difflineplus">+    let timer = Cc[&quot;@mozilla.org/timer;1&quot;].createInstance(Ci.nsITimer);</span>
<a href="#l18.1633"></a><span id="l18.1633">     timer.initWithCallback(this, aTime, timer.TYPE_ONE_SHOT);</span>
<a href="#l18.1634"></a><span id="l18.1634">     return timer;</span>
<a href="#l18.1635"></a><span id="l18.1635">   },</span>
<a href="#l18.1636"></a><span id="l18.1636"> </span>
<a href="#l18.1637"></a><span id="l18.1637">   notify: function PT_notify(aTimer) {</span>
<a href="#l18.1638"></a><span id="l18.1638">     if (aTimer == this._updateChevronTimer) {</span>
<a href="#l18.1639"></a><span id="l18.1639">       this._updateChevronTimer = null;</span>
<a href="#l18.1640"></a><span id="l18.1640">       this._updateChevronTimerCallback();</span>
<a href="#l18.1641"></a><span id="l18.1641" class="difflineminus">-    }</span>
<a href="#l18.1642"></a><span id="l18.1642" class="difflineminus">-</span>
<a href="#l18.1643"></a><span id="l18.1643" class="difflineminus">-    // * Timer to turn off indicator bar.</span>
<a href="#l18.1644"></a><span id="l18.1644" class="difflineminus">-    else if (aTimer == this._ibTimer) {</span>
<a href="#l18.1645"></a><span id="l18.1645" class="difflineplus">+    } else if (aTimer == this._ibTimer) {</span>
<a href="#l18.1646"></a><span id="l18.1646" class="difflineplus">+      // * Timer to turn off indicator bar.</span>
<a href="#l18.1647"></a><span id="l18.1647">       this._dropIndicator.collapsed = true;</span>
<a href="#l18.1648"></a><span id="l18.1648">       this._ibTimer = null;</span>
<a href="#l18.1649"></a><span id="l18.1649" class="difflineminus">-    }</span>
<a href="#l18.1650"></a><span id="l18.1650" class="difflineminus">-</span>
<a href="#l18.1651"></a><span id="l18.1651" class="difflineminus">-    // * Timer to open a menubutton that's being dragged over.</span>
<a href="#l18.1652"></a><span id="l18.1652" class="difflineminus">-    else if (aTimer == this._overFolder.openTimer) {</span>
<a href="#l18.1653"></a><span id="l18.1653" class="difflineplus">+    } else if (aTimer == this._overFolder.openTimer) {</span>
<a href="#l18.1654"></a><span id="l18.1654" class="difflineplus">+      // * Timer to open a menubutton that's being dragged over.</span>
<a href="#l18.1655"></a><span id="l18.1655">       // Set the autoopen attribute on the folder's menupopup so that</span>
<a href="#l18.1656"></a><span id="l18.1656">       // the menu will automatically close when the mouse drags off of it.</span>
<a href="#l18.1657"></a><span id="l18.1657">       this._overFolder.elt.lastChild.setAttribute(&quot;autoopened&quot;, &quot;true&quot;);</span>
<a href="#l18.1658"></a><span id="l18.1658">       this._overFolder.elt.open = true;</span>
<a href="#l18.1659"></a><span id="l18.1659">       this._overFolder.openTimer = null;</span>
<a href="#l18.1660"></a><span id="l18.1660" class="difflineminus">-    }</span>
<a href="#l18.1661"></a><span id="l18.1661" class="difflineminus">-</span>
<a href="#l18.1662"></a><span id="l18.1662" class="difflineminus">-    // * Timer to close a menubutton that's been dragged off of.</span>
<a href="#l18.1663"></a><span id="l18.1663" class="difflineminus">-    else if (aTimer == this._overFolder.closeTimer) {</span>
<a href="#l18.1664"></a><span id="l18.1664" class="difflineplus">+    } else if (aTimer == this._overFolder.closeTimer) {</span>
<a href="#l18.1665"></a><span id="l18.1665" class="difflineplus">+      // * Timer to close a menubutton that's been dragged off of.</span>
<a href="#l18.1666"></a><span id="l18.1666">       // Close the menubutton if we are not dragging over it or one of</span>
<a href="#l18.1667"></a><span id="l18.1667">       // its children.  The autoopened attribute will let the menu know to</span>
<a href="#l18.1668"></a><span id="l18.1668">       // close later if the menu is still being dragged over.</span>
<a href="#l18.1669"></a><span id="l18.1669">       let currentPlacesNode = PlacesControllerDragHelper.currentDropTarget;</span>
<a href="#l18.1670"></a><span id="l18.1670">       let inHierarchy = false;</span>
<a href="#l18.1671"></a><span id="l18.1671">       while (currentPlacesNode) {</span>
<a href="#l18.1672"></a><span id="l18.1672">         if (currentPlacesNode == this._rootElt) {</span>
<a href="#l18.1673"></a><span id="l18.1673">           inHierarchy = true;</span>
<a href="#l18.1674"></a><span id="l18.1674" class="difflineat">@@ -1420,27 +1552,19 @@ PlacesToolbar.prototype = {</span>
<a href="#l18.1675"></a><span id="l18.1675">     let draggedElt = aEvent.target;</span>
<a href="#l18.1676"></a><span id="l18.1676">     if (draggedElt.parentNode != this._rootElt || !draggedElt._placesNode)</span>
<a href="#l18.1677"></a><span id="l18.1677">       return;</span>
<a href="#l18.1678"></a><span id="l18.1678"> </span>
<a href="#l18.1679"></a><span id="l18.1679">     if (draggedElt.localName == &quot;toolbarbutton&quot; &amp;&amp;</span>
<a href="#l18.1680"></a><span id="l18.1680">         draggedElt.getAttribute(&quot;type&quot;) == &quot;menu&quot;) {</span>
<a href="#l18.1681"></a><span id="l18.1681">       // If the drag gesture on a container is toward down we open instead</span>
<a href="#l18.1682"></a><span id="l18.1682">       // of dragging.</span>
<a href="#l18.1683"></a><span id="l18.1683" class="difflineminus">-#ifdef XP_UNIX</span>
<a href="#l18.1684"></a><span id="l18.1684" class="difflineminus">-#ifndef XP_MACOSX</span>
<a href="#l18.1685"></a><span id="l18.1685" class="difflineminus">-      if (this._mouseDownTimer) {</span>
<a href="#l18.1686"></a><span id="l18.1686" class="difflineminus">-        this._mouseDownTimer.cancel();</span>
<a href="#l18.1687"></a><span id="l18.1687" class="difflineminus">-        this._mouseDownTimer = null;</span>
<a href="#l18.1688"></a><span id="l18.1688" class="difflineminus">-      }</span>
<a href="#l18.1689"></a><span id="l18.1689" class="difflineminus">-#endif</span>
<a href="#l18.1690"></a><span id="l18.1690" class="difflineminus">-#endif</span>
<a href="#l18.1691"></a><span id="l18.1691">       let translateY = this._cachedMouseMoveEvent.clientY - aEvent.clientY;</span>
<a href="#l18.1692"></a><span id="l18.1692">       let translateX = this._cachedMouseMoveEvent.clientX - aEvent.clientX;</span>
<a href="#l18.1693"></a><span id="l18.1693" class="difflineminus">-      if ((translateY) &gt;= Math.abs(translateX/2)) {</span>
<a href="#l18.1694"></a><span id="l18.1694" class="difflineplus">+      if ((translateY) &gt;= Math.abs(translateX / 2)) {</span>
<a href="#l18.1695"></a><span id="l18.1695">         // Don't start the drag.</span>
<a href="#l18.1696"></a><span id="l18.1696">         aEvent.preventDefault();</span>
<a href="#l18.1697"></a><span id="l18.1697">         // Open the menu.</span>
<a href="#l18.1698"></a><span id="l18.1698">         draggedElt.open = true;</span>
<a href="#l18.1699"></a><span id="l18.1699">         return;</span>
<a href="#l18.1700"></a><span id="l18.1700">       }</span>
<a href="#l18.1701"></a><span id="l18.1701"> </span>
<a href="#l18.1702"></a><span id="l18.1702">       // If the menu is open, close it.</span>
<a href="#l18.1703"></a><span id="l18.1703" class="difflineat">@@ -1484,67 +1608,67 @@ PlacesToolbar.prototype = {</span>
<a href="#l18.1704"></a><span id="l18.1704">         this._clearOverFolder();</span>
<a href="#l18.1705"></a><span id="l18.1705">         this._overFolder.elt = overElt;</span>
<a href="#l18.1706"></a><span id="l18.1706">         this._overFolder.openTimer = this._setTimer(this._overFolder.hoverTime);</span>
<a href="#l18.1707"></a><span id="l18.1707">       }</span>
<a href="#l18.1708"></a><span id="l18.1708">       if (!this._overFolder.elt.hasAttribute(&quot;dragover&quot;))</span>
<a href="#l18.1709"></a><span id="l18.1709">         this._overFolder.elt.setAttribute(&quot;dragover&quot;, &quot;true&quot;);</span>
<a href="#l18.1710"></a><span id="l18.1710"> </span>
<a href="#l18.1711"></a><span id="l18.1711">       this._dropIndicator.collapsed = true;</span>
<a href="#l18.1712"></a><span id="l18.1712" class="difflineminus">-    }</span>
<a href="#l18.1713"></a><span id="l18.1713" class="difflineminus">-    else {</span>
<a href="#l18.1714"></a><span id="l18.1714" class="difflineplus">+    } else {</span>
<a href="#l18.1715"></a><span id="l18.1715">       // Dragging over a normal toolbarbutton,</span>
<a href="#l18.1716"></a><span id="l18.1716">       // show indicator bar and move it to the appropriate drop point.</span>
<a href="#l18.1717"></a><span id="l18.1717">       let ind = this._dropIndicator;</span>
<a href="#l18.1718"></a><span id="l18.1718" class="difflineplus">+      ind.parentNode.collapsed = false;</span>
<a href="#l18.1719"></a><span id="l18.1719">       let halfInd = ind.clientWidth / 2;</span>
<a href="#l18.1720"></a><span id="l18.1720">       let translateX;</span>
<a href="#l18.1721"></a><span id="l18.1721" class="difflineminus">-      if (this._isRTL) {</span>
<a href="#l18.1722"></a><span id="l18.1722" class="difflineplus">+      if (this.isRTL) {</span>
<a href="#l18.1723"></a><span id="l18.1723">         halfInd = Math.ceil(halfInd);</span>
<a href="#l18.1724"></a><span id="l18.1724">         translateX = 0 - this._rootElt.getBoundingClientRect().right - halfInd;</span>
<a href="#l18.1725"></a><span id="l18.1725">         if (this._rootElt.firstChild) {</span>
<a href="#l18.1726"></a><span id="l18.1726">           if (dropPoint.beforeIndex == -1)</span>
<a href="#l18.1727"></a><span id="l18.1727">             translateX += this._rootElt.lastChild.getBoundingClientRect().left;</span>
<a href="#l18.1728"></a><span id="l18.1728">           else {</span>
<a href="#l18.1729"></a><span id="l18.1729">             translateX += this._rootElt.childNodes[dropPoint.beforeIndex]</span>
<a href="#l18.1730"></a><span id="l18.1730">                               .getBoundingClientRect().right;</span>
<a href="#l18.1731"></a><span id="l18.1731">           }</span>
<a href="#l18.1732"></a><span id="l18.1732">         }</span>
<a href="#l18.1733"></a><span id="l18.1733" class="difflineminus">-      }</span>
<a href="#l18.1734"></a><span id="l18.1734" class="difflineminus">-      else {</span>
<a href="#l18.1735"></a><span id="l18.1735" class="difflineplus">+      } else {</span>
<a href="#l18.1736"></a><span id="l18.1736">         halfInd = Math.floor(halfInd);</span>
<a href="#l18.1737"></a><span id="l18.1737">         translateX = 0 - this._rootElt.getBoundingClientRect().left +</span>
<a href="#l18.1738"></a><span id="l18.1738">                      halfInd;</span>
<a href="#l18.1739"></a><span id="l18.1739">         if (this._rootElt.firstChild) {</span>
<a href="#l18.1740"></a><span id="l18.1740">           if (dropPoint.beforeIndex == -1)</span>
<a href="#l18.1741"></a><span id="l18.1741">             translateX += this._rootElt.lastChild.getBoundingClientRect().right;</span>
<a href="#l18.1742"></a><span id="l18.1742">           else {</span>
<a href="#l18.1743"></a><span id="l18.1743">             translateX += this._rootElt.childNodes[dropPoint.beforeIndex]</span>
<a href="#l18.1744"></a><span id="l18.1744">                               .getBoundingClientRect().left;</span>
<a href="#l18.1745"></a><span id="l18.1745">           }</span>
<a href="#l18.1746"></a><span id="l18.1746">         }</span>
<a href="#l18.1747"></a><span id="l18.1747">       }</span>
<a href="#l18.1748"></a><span id="l18.1748"> </span>
<a href="#l18.1749"></a><span id="l18.1749">       ind.style.transform = &quot;translate(&quot; + Math.round(translateX) + &quot;px)&quot;;</span>
<a href="#l18.1750"></a><span id="l18.1750" class="difflineminus">-      ind.style.MozMarginStart = (-ind.clientWidth) + &quot;px&quot;;</span>
<a href="#l18.1751"></a><span id="l18.1751" class="difflineplus">+      ind.style.marginInlineStart = (-ind.clientWidth) + &quot;px&quot;;</span>
<a href="#l18.1752"></a><span id="l18.1752">       ind.collapsed = false;</span>
<a href="#l18.1753"></a><span id="l18.1753"> </span>
<a href="#l18.1754"></a><span id="l18.1754">       // Clear out old folder information.</span>
<a href="#l18.1755"></a><span id="l18.1755">       this._clearOverFolder();</span>
<a href="#l18.1756"></a><span id="l18.1756">     }</span>
<a href="#l18.1757"></a><span id="l18.1757"> </span>
<a href="#l18.1758"></a><span id="l18.1758">     aEvent.preventDefault();</span>
<a href="#l18.1759"></a><span id="l18.1759">     aEvent.stopPropagation();</span>
<a href="#l18.1760"></a><span id="l18.1760">   },</span>
<a href="#l18.1761"></a><span id="l18.1761"> </span>
<a href="#l18.1762"></a><span id="l18.1762">   _onDrop: function PT__onDrop(aEvent) {</span>
<a href="#l18.1763"></a><span id="l18.1763">     PlacesControllerDragHelper.currentDropTarget = aEvent.target;</span>
<a href="#l18.1764"></a><span id="l18.1764"> </span>
<a href="#l18.1765"></a><span id="l18.1765">     let dropPoint = this._getDropPoint(aEvent);</span>
<a href="#l18.1766"></a><span id="l18.1766">     if (dropPoint &amp;&amp; dropPoint.ip) {</span>
<a href="#l18.1767"></a><span id="l18.1767">       PlacesControllerDragHelper.onDrop(dropPoint.ip, aEvent.dataTransfer)</span>
<a href="#l18.1768"></a><span id="l18.1768" class="difflineplus">+                                .catch(Cu.reportError);</span>
<a href="#l18.1769"></a><span id="l18.1769">       aEvent.preventDefault();</span>
<a href="#l18.1770"></a><span id="l18.1770">     }</span>
<a href="#l18.1771"></a><span id="l18.1771"> </span>
<a href="#l18.1772"></a><span id="l18.1772">     this._cleanupDragDetails();</span>
<a href="#l18.1773"></a><span id="l18.1773">     aEvent.stopPropagation();</span>
<a href="#l18.1774"></a><span id="l18.1774">   },</span>
<a href="#l18.1775"></a><span id="l18.1775"> </span>
<a href="#l18.1776"></a><span id="l18.1776">   _onDragExit: function PT__onDragExit(aEvent) {</span>
<a href="#l18.1777"></a><span id="l18.1777" class="difflineat">@@ -1582,75 +1706,35 @@ PlacesToolbar.prototype = {</span>
<a href="#l18.1778"></a><span id="l18.1778"> </span>
<a href="#l18.1779"></a><span id="l18.1779">   _onPopupHidden: function PT__onPopupHidden(aEvent) {</span>
<a href="#l18.1780"></a><span id="l18.1780">     let popup = aEvent.target;</span>
<a href="#l18.1781"></a><span id="l18.1781">     let placesNode = popup._placesNode;</span>
<a href="#l18.1782"></a><span id="l18.1782">     // Avoid handling popuphidden of inner views</span>
<a href="#l18.1783"></a><span id="l18.1783">     if (placesNode &amp;&amp; PlacesUIUtils.getViewForNode(popup) == this) {</span>
<a href="#l18.1784"></a><span id="l18.1784">       // UI performance: folder queries are cheap, keep the resultnode open</span>
<a href="#l18.1785"></a><span id="l18.1785">       // so we don't rebuild its contents whenever the popup is reopened.</span>
<a href="#l18.1786"></a><span id="l18.1786" class="difflineminus">-      // Though, we want to always close feed containers so their</span>
<a href="#l18.1787"></a><span id="l18.1787" class="difflineminus">-      // expiration status will be checked at next opening.</span>
<a href="#l18.1788"></a><span id="l18.1788" class="difflineplus">+      // Though, we want to always close feed containers so their expiration</span>
<a href="#l18.1789"></a><span id="l18.1789" class="difflineplus">+      // status will be checked at next opening.</span>
<a href="#l18.1790"></a><span id="l18.1790">       if (!PlacesUtils.nodeIsFolder(placesNode) ||</span>
<a href="#l18.1791"></a><span id="l18.1791" class="difflineminus">-          this.controller.hasCachedLivemarkInfo(placesNode))</span>
<a href="#l18.1792"></a><span id="l18.1792" class="difflineplus">+          this.controller.hasCachedLivemarkInfo(placesNode)) {</span>
<a href="#l18.1793"></a><span id="l18.1793">         placesNode.containerOpen = false;</span>
<a href="#l18.1794"></a><span id="l18.1794" class="difflineplus">+      }</span>
<a href="#l18.1795"></a><span id="l18.1795">     }</span>
<a href="#l18.1796"></a><span id="l18.1796"> </span>
<a href="#l18.1797"></a><span id="l18.1797">     let parent = popup.parentNode;</span>
<a href="#l18.1798"></a><span id="l18.1798">     if (parent.localName == &quot;toolbarbutton&quot;) {</span>
<a href="#l18.1799"></a><span id="l18.1799">       this._openedMenuButton = null;</span>
<a href="#l18.1800"></a><span id="l18.1800">       // Clear the dragover attribute if present, if we are dragging into a</span>
<a href="#l18.1801"></a><span id="l18.1801">       // folder in the hierachy of current opened popup we don't clear</span>
<a href="#l18.1802"></a><span id="l18.1802">       // this attribute on clearOverFolder.  See Notify for closeTimer.</span>
<a href="#l18.1803"></a><span id="l18.1803">       if (parent.hasAttribute(&quot;dragover&quot;))</span>
<a href="#l18.1804"></a><span id="l18.1804">         parent.removeAttribute(&quot;dragover&quot;);</span>
<a href="#l18.1805"></a><span id="l18.1805">     }</span>
<a href="#l18.1806"></a><span id="l18.1806">   },</span>
<a href="#l18.1807"></a><span id="l18.1807"> </span>
<a href="#l18.1808"></a><span id="l18.1808" class="difflineminus">-#ifdef XP_UNIX</span>
<a href="#l18.1809"></a><span id="l18.1809" class="difflineminus">-#ifndef XP_MACOSX</span>
<a href="#l18.1810"></a><span id="l18.1810" class="difflineminus">-  _onMouseDown: function PT__onMouseDown(aEvent) {</span>
<a href="#l18.1811"></a><span id="l18.1811" class="difflineminus">-    let target = aEvent.target;</span>
<a href="#l18.1812"></a><span id="l18.1812" class="difflineminus">-    if (aEvent.button == 0 &amp;&amp;</span>
<a href="#l18.1813"></a><span id="l18.1813" class="difflineminus">-        target.localName == &quot;toolbarbutton&quot; &amp;&amp;</span>
<a href="#l18.1814"></a><span id="l18.1814" class="difflineminus">-        target.getAttribute(&quot;type&quot;) == &quot;menu&quot;) {</span>
<a href="#l18.1815"></a><span id="l18.1815" class="difflineminus">-      this._allowPopupShowing = false;</span>
<a href="#l18.1816"></a><span id="l18.1816" class="difflineminus">-      // On Linux we can open the popup only after a delay.</span>
<a href="#l18.1817"></a><span id="l18.1817" class="difflineminus">-      // Indeed as soon as the menupopup opens we are unable to start a</span>
<a href="#l18.1818"></a><span id="l18.1818" class="difflineminus">-      // drag aEvent.  See bug 500081 for details.</span>
<a href="#l18.1819"></a><span id="l18.1819" class="difflineminus">-      this._mouseDownTimer = Cc[&quot;@mozilla.org/timer;1&quot;].</span>
<a href="#l18.1820"></a><span id="l18.1820" class="difflineminus">-                             createInstance(Ci.nsITimer);</span>
<a href="#l18.1821"></a><span id="l18.1821" class="difflineminus">-      let callback = {</span>
<a href="#l18.1822"></a><span id="l18.1822" class="difflineminus">-        _self: this,</span>
<a href="#l18.1823"></a><span id="l18.1823" class="difflineminus">-        _target: target,</span>
<a href="#l18.1824"></a><span id="l18.1824" class="difflineminus">-        notify: function(timer) {</span>
<a href="#l18.1825"></a><span id="l18.1825" class="difflineminus">-          this._target.open = true;</span>
<a href="#l18.1826"></a><span id="l18.1826" class="difflineminus">-          this._mouseDownTimer = null;</span>
<a href="#l18.1827"></a><span id="l18.1827" class="difflineminus">-        }</span>
<a href="#l18.1828"></a><span id="l18.1828" class="difflineminus">-      };</span>
<a href="#l18.1829"></a><span id="l18.1829" class="difflineminus">-</span>
<a href="#l18.1830"></a><span id="l18.1830" class="difflineminus">-      this._mouseDownTimer.initWithCallback(callback, 300,</span>
<a href="#l18.1831"></a><span id="l18.1831" class="difflineminus">-                                            Ci.nsITimer.TYPE_ONE_SHOT);</span>
<a href="#l18.1832"></a><span id="l18.1832" class="difflineminus">-    }</span>
<a href="#l18.1833"></a><span id="l18.1833" class="difflineminus">-  },</span>
<a href="#l18.1834"></a><span id="l18.1834" class="difflineminus">-</span>
<a href="#l18.1835"></a><span id="l18.1835" class="difflineminus">-  _onMouseUp: function PT__onMouseUp(aEvent) {</span>
<a href="#l18.1836"></a><span id="l18.1836" class="difflineminus">-    if (aEvent.button != 0)</span>
<a href="#l18.1837"></a><span id="l18.1837" class="difflineminus">-      return;</span>
<a href="#l18.1838"></a><span id="l18.1838" class="difflineminus">-</span>
<a href="#l18.1839"></a><span id="l18.1839" class="difflineminus">-    if (this._mouseDownTimer) {</span>
<a href="#l18.1840"></a><span id="l18.1840" class="difflineminus">-      // On a click (down/up), we should open the menu popup.</span>
<a href="#l18.1841"></a><span id="l18.1841" class="difflineminus">-      this._mouseDownTimer.cancel();</span>
<a href="#l18.1842"></a><span id="l18.1842" class="difflineminus">-      this._mouseDownTimer = null;</span>
<a href="#l18.1843"></a><span id="l18.1843" class="difflineminus">-      aEvent.target.open = true;</span>
<a href="#l18.1844"></a><span id="l18.1844" class="difflineminus">-    }</span>
<a href="#l18.1845"></a><span id="l18.1845" class="difflineminus">-  },</span>
<a href="#l18.1846"></a><span id="l18.1846" class="difflineminus">-#endif</span>
<a href="#l18.1847"></a><span id="l18.1847" class="difflineminus">-#endif</span>
<a href="#l18.1848"></a><span id="l18.1848" class="difflineminus">-</span>
<a href="#l18.1849"></a><span id="l18.1849">   _onMouseMove: function PT__onMouseMove(aEvent) {</span>
<a href="#l18.1850"></a><span id="l18.1850">     // Used in dragStart to prevent dragging folders when dragging down.</span>
<a href="#l18.1851"></a><span id="l18.1851">     this._cachedMouseMoveEvent = aEvent;</span>
<a href="#l18.1852"></a><span id="l18.1852"> </span>
<a href="#l18.1853"></a><span id="l18.1853">     if (this._openedMenuButton == null ||</span>
<a href="#l18.1854"></a><span id="l18.1854">         PlacesControllerDragHelper.getSession())</span>
<a href="#l18.1855"></a><span id="l18.1855">       return;</span>
<a href="#l18.1856"></a><span id="l18.1856"> </span>
<a href="#l18.1857"></a><span id="l18.1857" class="difflineat">@@ -1663,49 +1747,49 @@ PlacesToolbar.prototype = {</span>
<a href="#l18.1858"></a><span id="l18.1858">     }</span>
<a href="#l18.1859"></a><span id="l18.1859">   }</span>
<a href="#l18.1860"></a><span id="l18.1860"> };</span>
<a href="#l18.1861"></a><span id="l18.1861"> </span>
<a href="#l18.1862"></a><span id="l18.1862"> /**</span>
<a href="#l18.1863"></a><span id="l18.1863">  * View for Places menus.  This object should be created during the first</span>
<a href="#l18.1864"></a><span id="l18.1864">  * popupshowing that's dispatched on the menu.</span>
<a href="#l18.1865"></a><span id="l18.1865">  */</span>
<a href="#l18.1866"></a><span id="l18.1866" class="difflineminus">-function PlacesMenu(aPopupShowingEvent, aPlace) {</span>
<a href="#l18.1867"></a><span id="l18.1867" class="difflineplus">+function PlacesMenu(aPopupShowingEvent, aPlace, aOptions) {</span>
<a href="#l18.1868"></a><span id="l18.1868">   this._rootElt = aPopupShowingEvent.target; // &lt;menupopup&gt;</span>
<a href="#l18.1869"></a><span id="l18.1869">   this._viewElt = this._rootElt.parentNode;   // &lt;menu&gt;</span>
<a href="#l18.1870"></a><span id="l18.1870">   this._viewElt._placesView = this;</span>
<a href="#l18.1871"></a><span id="l18.1871">   this._addEventListeners(this._rootElt, [&quot;popupshowing&quot;, &quot;popuphidden&quot;], true);</span>
<a href="#l18.1872"></a><span id="l18.1872">   this._addEventListeners(window, [&quot;unload&quot;], false);</span>
<a href="#l18.1873"></a><span id="l18.1873"> </span>
<a href="#l18.1874"></a><span id="l18.1874" class="difflineminus">-#ifdef XP_MACOSX</span>
<a href="#l18.1875"></a><span id="l18.1875" class="difflineminus">-  if (this._viewElt.parentNode.localName == &quot;menubar&quot;) {</span>
<a href="#l18.1876"></a><span id="l18.1876" class="difflineminus">-    this._nativeView = true;</span>
<a href="#l18.1877"></a><span id="l18.1877" class="difflineminus">-    this._rootElt._startMarker = -1;</span>
<a href="#l18.1878"></a><span id="l18.1878" class="difflineminus">-    this._rootElt._endMarker = -1;</span>
<a href="#l18.1879"></a><span id="l18.1879" class="difflineplus">+  if (AppConstants.platform === &quot;macosx&quot;) {</span>
<a href="#l18.1880"></a><span id="l18.1880" class="difflineplus">+    // Must walk up to support views in sub-menus, like Bookmarks Toolbar menu.</span>
<a href="#l18.1881"></a><span id="l18.1881" class="difflineplus">+    for (let elt = this._viewElt.parentNode; elt; elt = elt.parentNode) {</span>
<a href="#l18.1882"></a><span id="l18.1882" class="difflineplus">+      if (elt.localName == &quot;menubar&quot;) {</span>
<a href="#l18.1883"></a><span id="l18.1883" class="difflineplus">+        this._nativeView = true;</span>
<a href="#l18.1884"></a><span id="l18.1884" class="difflineplus">+        break;</span>
<a href="#l18.1885"></a><span id="l18.1885" class="difflineplus">+      }</span>
<a href="#l18.1886"></a><span id="l18.1886" class="difflineplus">+    }</span>
<a href="#l18.1887"></a><span id="l18.1887">   }</span>
<a href="#l18.1888"></a><span id="l18.1888" class="difflineminus">-#endif</span>
<a href="#l18.1889"></a><span id="l18.1889"> </span>
<a href="#l18.1890"></a><span id="l18.1890" class="difflineminus">-  PlacesViewBase.call(this, aPlace);</span>
<a href="#l18.1891"></a><span id="l18.1891" class="difflineplus">+  PlacesViewBase.call(this, aPlace, aOptions);</span>
<a href="#l18.1892"></a><span id="l18.1892">   this._onPopupShowing(aPopupShowingEvent);</span>
<a href="#l18.1893"></a><span id="l18.1893"> }</span>
<a href="#l18.1894"></a><span id="l18.1894"> </span>
<a href="#l18.1895"></a><span id="l18.1895"> PlacesMenu.prototype = {</span>
<a href="#l18.1896"></a><span id="l18.1896">   __proto__: PlacesViewBase.prototype,</span>
<a href="#l18.1897"></a><span id="l18.1897"> </span>
<a href="#l18.1898"></a><span id="l18.1898">   QueryInterface: function PM_QueryInterface(aIID) {</span>
<a href="#l18.1899"></a><span id="l18.1899">     if (aIID.equals(Ci.nsIDOMEventListener))</span>
<a href="#l18.1900"></a><span id="l18.1900">       return this;</span>
<a href="#l18.1901"></a><span id="l18.1901"> </span>
<a href="#l18.1902"></a><span id="l18.1902">     return PlacesViewBase.prototype.QueryInterface.apply(this, arguments);</span>
<a href="#l18.1903"></a><span id="l18.1903">   },</span>
<a href="#l18.1904"></a><span id="l18.1904"> </span>
<a href="#l18.1905"></a><span id="l18.1905">   _removeChild: function PM_removeChild(aChild) {</span>
<a href="#l18.1906"></a><span id="l18.1906">     PlacesViewBase.prototype._removeChild.apply(this, arguments);</span>
<a href="#l18.1907"></a><span id="l18.1907" class="difflineminus">-    if (this._endMarker != -1)</span>
<a href="#l18.1908"></a><span id="l18.1908" class="difflineminus">-      this._endMarker--;</span>
<a href="#l18.1909"></a><span id="l18.1909">   },</span>
<a href="#l18.1910"></a><span id="l18.1910"> </span>
<a href="#l18.1911"></a><span id="l18.1911">   uninit: function PM_uninit() {</span>
<a href="#l18.1912"></a><span id="l18.1912">     this._removeEventListeners(this._rootElt, [&quot;popupshowing&quot;, &quot;popuphidden&quot;],</span>
<a href="#l18.1913"></a><span id="l18.1913">                                true);</span>
<a href="#l18.1914"></a><span id="l18.1914">     this._removeEventListeners(window, [&quot;unload&quot;], false);</span>
<a href="#l18.1915"></a><span id="l18.1915"> </span>
<a href="#l18.1916"></a><span id="l18.1916">     PlacesViewBase.prototype.uninit.apply(this, arguments);</span>
<a href="#l18.1917"></a><span id="l18.1917" class="difflineat">@@ -1723,24 +1807,371 @@ PlacesMenu.prototype = {</span>
<a href="#l18.1918"></a><span id="l18.1918">         this._onPopupHidden(aEvent);</span>
<a href="#l18.1919"></a><span id="l18.1919">         break;</span>
<a href="#l18.1920"></a><span id="l18.1920">     }</span>
<a href="#l18.1921"></a><span id="l18.1921">   },</span>
<a href="#l18.1922"></a><span id="l18.1922"> </span>
<a href="#l18.1923"></a><span id="l18.1923">   _onPopupHidden: function PM__onPopupHidden(aEvent) {</span>
<a href="#l18.1924"></a><span id="l18.1924">     // Avoid handling popuphidden of inner views.</span>
<a href="#l18.1925"></a><span id="l18.1925">     let popup = aEvent.originalTarget;</span>
<a href="#l18.1926"></a><span id="l18.1926" class="difflineminus">-    if (!popup._placesNode || PlacesUIUtils.getViewForNode(popup) != this)</span>
<a href="#l18.1927"></a><span id="l18.1927" class="difflineplus">+    let placesNode = popup._placesNode;</span>
<a href="#l18.1928"></a><span id="l18.1928" class="difflineplus">+    if (!placesNode || PlacesUIUtils.getViewForNode(popup) != this)</span>
<a href="#l18.1929"></a><span id="l18.1929">       return;</span>
<a href="#l18.1930"></a><span id="l18.1930"> </span>
<a href="#l18.1931"></a><span id="l18.1931">     // UI performance: folder queries are cheap, keep the resultnode open</span>
<a href="#l18.1932"></a><span id="l18.1932">     // so we don't rebuild its contents whenever the popup is reopened.</span>
<a href="#l18.1933"></a><span id="l18.1933" class="difflineminus">-    if (!PlacesUtils.nodeIsFolder(popup._placesNode))</span>
<a href="#l18.1934"></a><span id="l18.1934" class="difflineminus">-      popup._placesNode.containerOpen = false;</span>
<a href="#l18.1935"></a><span id="l18.1935" class="difflineplus">+    // Though, we want to always close feed containers so their expiration</span>
<a href="#l18.1936"></a><span id="l18.1936" class="difflineplus">+    // status will be checked at next opening.</span>
<a href="#l18.1937"></a><span id="l18.1937" class="difflineplus">+    if (!PlacesUtils.nodeIsFolder(placesNode) ||</span>
<a href="#l18.1938"></a><span id="l18.1938" class="difflineplus">+        this.controller.hasCachedLivemarkInfo(placesNode))</span>
<a href="#l18.1939"></a><span id="l18.1939" class="difflineplus">+      placesNode.containerOpen = false;</span>
<a href="#l18.1940"></a><span id="l18.1940"> </span>
<a href="#l18.1941"></a><span id="l18.1941">     // The autoopened attribute is set for folders which have been</span>
<a href="#l18.1942"></a><span id="l18.1942">     // automatically opened when dragged over.  Turn off this attribute</span>
<a href="#l18.1943"></a><span id="l18.1943">     // when the folder closes because it is no longer applicable.</span>
<a href="#l18.1944"></a><span id="l18.1944">     popup.removeAttribute(&quot;autoopened&quot;);</span>
<a href="#l18.1945"></a><span id="l18.1945">     popup.removeAttribute(&quot;dragstart&quot;);</span>
<a href="#l18.1946"></a><span id="l18.1946">   }</span>
<a href="#l18.1947"></a><span id="l18.1947"> };</span>
<a href="#l18.1948"></a><span id="l18.1948"> </span>
<a href="#l18.1949"></a><span id="l18.1949" class="difflineplus">+function PlacesPanelMenuView(aPlace, aViewId, aRootId, aOptions) {</span>
<a href="#l18.1950"></a><span id="l18.1950" class="difflineplus">+  this._viewElt = document.getElementById(aViewId);</span>
<a href="#l18.1951"></a><span id="l18.1951" class="difflineplus">+  this._rootElt = document.getElementById(aRootId);</span>
<a href="#l18.1952"></a><span id="l18.1952" class="difflineplus">+  this._viewElt._placesView = this;</span>
<a href="#l18.1953"></a><span id="l18.1953" class="difflineplus">+  this.options = aOptions;</span>
<a href="#l18.1954"></a><span id="l18.1954" class="difflineplus">+</span>
<a href="#l18.1955"></a><span id="l18.1955" class="difflineplus">+  PlacesViewBase.call(this, aPlace, aOptions);</span>
<a href="#l18.1956"></a><span id="l18.1956" class="difflineplus">+}</span>
<a href="#l18.1957"></a><span id="l18.1957" class="difflineplus">+</span>
<a href="#l18.1958"></a><span id="l18.1958" class="difflineplus">+PlacesPanelMenuView.prototype = {</span>
<a href="#l18.1959"></a><span id="l18.1959" class="difflineplus">+  __proto__: PlacesViewBase.prototype,</span>
<a href="#l18.1960"></a><span id="l18.1960" class="difflineplus">+</span>
<a href="#l18.1961"></a><span id="l18.1961" class="difflineplus">+  QueryInterface: function PAMV_QueryInterface(aIID) {</span>
<a href="#l18.1962"></a><span id="l18.1962" class="difflineplus">+    return PlacesViewBase.prototype.QueryInterface.apply(this, arguments);</span>
<a href="#l18.1963"></a><span id="l18.1963" class="difflineplus">+  },</span>
<a href="#l18.1964"></a><span id="l18.1964" class="difflineplus">+</span>
<a href="#l18.1965"></a><span id="l18.1965" class="difflineplus">+  uninit: function PAMV_uninit() {</span>
<a href="#l18.1966"></a><span id="l18.1966" class="difflineplus">+    PlacesViewBase.prototype.uninit.apply(this, arguments);</span>
<a href="#l18.1967"></a><span id="l18.1967" class="difflineplus">+  },</span>
<a href="#l18.1968"></a><span id="l18.1968" class="difflineplus">+</span>
<a href="#l18.1969"></a><span id="l18.1969" class="difflineplus">+  _insertNewItem:</span>
<a href="#l18.1970"></a><span id="l18.1970" class="difflineplus">+  function PAMV__insertNewItem(aChild, aBefore) {</span>
<a href="#l18.1971"></a><span id="l18.1971" class="difflineplus">+    this._domNodes.delete(aChild);</span>
<a href="#l18.1972"></a><span id="l18.1972" class="difflineplus">+</span>
<a href="#l18.1973"></a><span id="l18.1973" class="difflineplus">+    let type = aChild.type;</span>
<a href="#l18.1974"></a><span id="l18.1974" class="difflineplus">+    let button;</span>
<a href="#l18.1975"></a><span id="l18.1975" class="difflineplus">+    if (type == Ci.nsINavHistoryResultNode.RESULT_TYPE_SEPARATOR) {</span>
<a href="#l18.1976"></a><span id="l18.1976" class="difflineplus">+      button = document.createElement(&quot;toolbarseparator&quot;);</span>
<a href="#l18.1977"></a><span id="l18.1977" class="difflineplus">+      button.setAttribute(&quot;class&quot;, &quot;small-separator&quot;);</span>
<a href="#l18.1978"></a><span id="l18.1978" class="difflineplus">+    } else {</span>
<a href="#l18.1979"></a><span id="l18.1979" class="difflineplus">+      button = document.createElement(&quot;toolbarbutton&quot;);</span>
<a href="#l18.1980"></a><span id="l18.1980" class="difflineplus">+      button.className = &quot;bookmark-item&quot;;</span>
<a href="#l18.1981"></a><span id="l18.1981" class="difflineplus">+      if (typeof this.options.extraClasses.entry == &quot;string&quot;)</span>
<a href="#l18.1982"></a><span id="l18.1982" class="difflineplus">+        button.classList.add(this.options.extraClasses.entry);</span>
<a href="#l18.1983"></a><span id="l18.1983" class="difflineplus">+      button.setAttribute(&quot;label&quot;, aChild.title || &quot;&quot;);</span>
<a href="#l18.1984"></a><span id="l18.1984" class="difflineplus">+      let icon = aChild.icon;</span>
<a href="#l18.1985"></a><span id="l18.1985" class="difflineplus">+      if (icon)</span>
<a href="#l18.1986"></a><span id="l18.1986" class="difflineplus">+        button.setAttribute(&quot;image&quot;, icon);</span>
<a href="#l18.1987"></a><span id="l18.1987" class="difflineplus">+</span>
<a href="#l18.1988"></a><span id="l18.1988" class="difflineplus">+      if (PlacesUtils.containerTypes.includes(type)) {</span>
<a href="#l18.1989"></a><span id="l18.1989" class="difflineplus">+        button.setAttribute(&quot;container&quot;, &quot;true&quot;);</span>
<a href="#l18.1990"></a><span id="l18.1990" class="difflineplus">+</span>
<a href="#l18.1991"></a><span id="l18.1991" class="difflineplus">+        if (PlacesUtils.nodeIsQuery(aChild)) {</span>
<a href="#l18.1992"></a><span id="l18.1992" class="difflineplus">+          button.setAttribute(&quot;query&quot;, &quot;true&quot;);</span>
<a href="#l18.1993"></a><span id="l18.1993" class="difflineplus">+          if (PlacesUtils.nodeIsTagQuery(aChild))</span>
<a href="#l18.1994"></a><span id="l18.1994" class="difflineplus">+            button.setAttribute(&quot;tagContainer&quot;, &quot;true&quot;);</span>
<a href="#l18.1995"></a><span id="l18.1995" class="difflineplus">+        } else if (PlacesUtils.nodeIsFolder(aChild)) {</span>
<a href="#l18.1996"></a><span id="l18.1996" class="difflineplus">+          PlacesUtils.livemarks.getLivemark({ id: aChild.itemId })</span>
<a href="#l18.1997"></a><span id="l18.1997" class="difflineplus">+            .then(aLivemark =&gt; {</span>
<a href="#l18.1998"></a><span id="l18.1998" class="difflineplus">+              button.setAttribute(&quot;livemark&quot;, &quot;true&quot;);</span>
<a href="#l18.1999"></a><span id="l18.1999" class="difflineplus">+              this.controller.cacheLivemarkInfo(aChild, aLivemark);</span>
<a href="#l18.2000"></a><span id="l18.2000" class="difflineplus">+            }, () =&gt; undefined);</span>
<a href="#l18.2001"></a><span id="l18.2001" class="difflineplus">+        }</span>
<a href="#l18.2002"></a><span id="l18.2002" class="difflineplus">+      } else if (PlacesUtils.nodeIsURI(aChild)) {</span>
<a href="#l18.2003"></a><span id="l18.2003" class="difflineplus">+        button.setAttribute(&quot;scheme&quot;,</span>
<a href="#l18.2004"></a><span id="l18.2004" class="difflineplus">+                            PlacesUIUtils.guessUrlSchemeForUI(aChild.uri));</span>
<a href="#l18.2005"></a><span id="l18.2005" class="difflineplus">+      }</span>
<a href="#l18.2006"></a><span id="l18.2006" class="difflineplus">+    }</span>
<a href="#l18.2007"></a><span id="l18.2007" class="difflineplus">+</span>
<a href="#l18.2008"></a><span id="l18.2008" class="difflineplus">+    button._placesNode = aChild;</span>
<a href="#l18.2009"></a><span id="l18.2009" class="difflineplus">+    if (!this._domNodes.has(aChild))</span>
<a href="#l18.2010"></a><span id="l18.2010" class="difflineplus">+      this._domNodes.set(aChild, button);</span>
<a href="#l18.2011"></a><span id="l18.2011" class="difflineplus">+</span>
<a href="#l18.2012"></a><span id="l18.2012" class="difflineplus">+    this._rootElt.insertBefore(button, aBefore);</span>
<a href="#l18.2013"></a><span id="l18.2013" class="difflineplus">+  },</span>
<a href="#l18.2014"></a><span id="l18.2014" class="difflineplus">+</span>
<a href="#l18.2015"></a><span id="l18.2015" class="difflineplus">+  nodeInserted:</span>
<a href="#l18.2016"></a><span id="l18.2016" class="difflineplus">+  function PAMV_nodeInserted(aParentPlacesNode, aPlacesNode, aIndex) {</span>
<a href="#l18.2017"></a><span id="l18.2017" class="difflineplus">+    let parentElt = this._getDOMNodeForPlacesNode(aParentPlacesNode);</span>
<a href="#l18.2018"></a><span id="l18.2018" class="difflineplus">+    if (parentElt != this._rootElt)</span>
<a href="#l18.2019"></a><span id="l18.2019" class="difflineplus">+      return;</span>
<a href="#l18.2020"></a><span id="l18.2020" class="difflineplus">+</span>
<a href="#l18.2021"></a><span id="l18.2021" class="difflineplus">+    let children = this._rootElt.childNodes;</span>
<a href="#l18.2022"></a><span id="l18.2022" class="difflineplus">+    this._insertNewItem(aPlacesNode,</span>
<a href="#l18.2023"></a><span id="l18.2023" class="difflineplus">+      aIndex &lt; children.length ? children[aIndex] : null);</span>
<a href="#l18.2024"></a><span id="l18.2024" class="difflineplus">+  },</span>
<a href="#l18.2025"></a><span id="l18.2025" class="difflineplus">+</span>
<a href="#l18.2026"></a><span id="l18.2026" class="difflineplus">+  nodeRemoved:</span>
<a href="#l18.2027"></a><span id="l18.2027" class="difflineplus">+  function PAMV_nodeRemoved(aParentPlacesNode, aPlacesNode, aIndex) {</span>
<a href="#l18.2028"></a><span id="l18.2028" class="difflineplus">+    let parentElt = this._getDOMNodeForPlacesNode(aParentPlacesNode);</span>
<a href="#l18.2029"></a><span id="l18.2029" class="difflineplus">+    if (parentElt != this._rootElt)</span>
<a href="#l18.2030"></a><span id="l18.2030" class="difflineplus">+      return;</span>
<a href="#l18.2031"></a><span id="l18.2031" class="difflineplus">+</span>
<a href="#l18.2032"></a><span id="l18.2032" class="difflineplus">+    let elt = this._getDOMNodeForPlacesNode(aPlacesNode);</span>
<a href="#l18.2033"></a><span id="l18.2033" class="difflineplus">+    this._removeChild(elt);</span>
<a href="#l18.2034"></a><span id="l18.2034" class="difflineplus">+  },</span>
<a href="#l18.2035"></a><span id="l18.2035" class="difflineplus">+</span>
<a href="#l18.2036"></a><span id="l18.2036" class="difflineplus">+  nodeMoved:</span>
<a href="#l18.2037"></a><span id="l18.2037" class="difflineplus">+  function PAMV_nodeMoved(aPlacesNode,</span>
<a href="#l18.2038"></a><span id="l18.2038" class="difflineplus">+                          aOldParentPlacesNode, aOldIndex,</span>
<a href="#l18.2039"></a><span id="l18.2039" class="difflineplus">+                          aNewParentPlacesNode, aNewIndex) {</span>
<a href="#l18.2040"></a><span id="l18.2040" class="difflineplus">+    let parentElt = this._getDOMNodeForPlacesNode(aNewParentPlacesNode);</span>
<a href="#l18.2041"></a><span id="l18.2041" class="difflineplus">+    if (parentElt != this._rootElt)</span>
<a href="#l18.2042"></a><span id="l18.2042" class="difflineplus">+      return;</span>
<a href="#l18.2043"></a><span id="l18.2043" class="difflineplus">+</span>
<a href="#l18.2044"></a><span id="l18.2044" class="difflineplus">+    let elt = this._getDOMNodeForPlacesNode(aPlacesNode);</span>
<a href="#l18.2045"></a><span id="l18.2045" class="difflineplus">+    this._removeChild(elt);</span>
<a href="#l18.2046"></a><span id="l18.2046" class="difflineplus">+    this._rootElt.insertBefore(elt, this._rootElt.childNodes[aNewIndex]);</span>
<a href="#l18.2047"></a><span id="l18.2047" class="difflineplus">+  },</span>
<a href="#l18.2048"></a><span id="l18.2048" class="difflineplus">+</span>
<a href="#l18.2049"></a><span id="l18.2049" class="difflineplus">+  nodeAnnotationChanged:</span>
<a href="#l18.2050"></a><span id="l18.2050" class="difflineplus">+  function PAMV_nodeAnnotationChanged(aPlacesNode, aAnno) {</span>
<a href="#l18.2051"></a><span id="l18.2051" class="difflineplus">+    let elt = this._getDOMNodeForPlacesNode(aPlacesNode);</span>
<a href="#l18.2052"></a><span id="l18.2052" class="difflineplus">+    // There's no UI representation for the root node.</span>
<a href="#l18.2053"></a><span id="l18.2053" class="difflineplus">+    if (elt == this._rootElt)</span>
<a href="#l18.2054"></a><span id="l18.2054" class="difflineplus">+      return;</span>
<a href="#l18.2055"></a><span id="l18.2055" class="difflineplus">+</span>
<a href="#l18.2056"></a><span id="l18.2056" class="difflineplus">+    if (elt.parentNode != this._rootElt)</span>
<a href="#l18.2057"></a><span id="l18.2057" class="difflineplus">+      return;</span>
<a href="#l18.2058"></a><span id="l18.2058" class="difflineplus">+</span>
<a href="#l18.2059"></a><span id="l18.2059" class="difflineplus">+    // All livemarks have a feedURI, so use it as our indicator.</span>
<a href="#l18.2060"></a><span id="l18.2060" class="difflineplus">+    if (aAnno == PlacesUtils.LMANNO_FEEDURI) {</span>
<a href="#l18.2061"></a><span id="l18.2061" class="difflineplus">+      elt.setAttribute(&quot;livemark&quot;, true);</span>
<a href="#l18.2062"></a><span id="l18.2062" class="difflineplus">+</span>
<a href="#l18.2063"></a><span id="l18.2063" class="difflineplus">+      PlacesUtils.livemarks.getLivemark({ id: aPlacesNode.itemId })</span>
<a href="#l18.2064"></a><span id="l18.2064" class="difflineplus">+        .then(aLivemark =&gt; {</span>
<a href="#l18.2065"></a><span id="l18.2065" class="difflineplus">+          this.controller.cacheLivemarkInfo(aPlacesNode, aLivemark);</span>
<a href="#l18.2066"></a><span id="l18.2066" class="difflineplus">+          this.invalidateContainer(aPlacesNode);</span>
<a href="#l18.2067"></a><span id="l18.2067" class="difflineplus">+        }, Cu.reportError);</span>
<a href="#l18.2068"></a><span id="l18.2068" class="difflineplus">+    }</span>
<a href="#l18.2069"></a><span id="l18.2069" class="difflineplus">+  },</span>
<a href="#l18.2070"></a><span id="l18.2070" class="difflineplus">+</span>
<a href="#l18.2071"></a><span id="l18.2071" class="difflineplus">+  nodeTitleChanged: function PAMV_nodeTitleChanged(aPlacesNode, aNewTitle) {</span>
<a href="#l18.2072"></a><span id="l18.2072" class="difflineplus">+    let elt = this._getDOMNodeForPlacesNode(aPlacesNode);</span>
<a href="#l18.2073"></a><span id="l18.2073" class="difflineplus">+</span>
<a href="#l18.2074"></a><span id="l18.2074" class="difflineplus">+    // There's no UI representation for the root node.</span>
<a href="#l18.2075"></a><span id="l18.2075" class="difflineplus">+    if (elt == this._rootElt)</span>
<a href="#l18.2076"></a><span id="l18.2076" class="difflineplus">+      return;</span>
<a href="#l18.2077"></a><span id="l18.2077" class="difflineplus">+</span>
<a href="#l18.2078"></a><span id="l18.2078" class="difflineplus">+    PlacesViewBase.prototype.nodeTitleChanged.apply(this, arguments);</span>
<a href="#l18.2079"></a><span id="l18.2079" class="difflineplus">+  },</span>
<a href="#l18.2080"></a><span id="l18.2080" class="difflineplus">+</span>
<a href="#l18.2081"></a><span id="l18.2081" class="difflineplus">+  invalidateContainer: function PAMV_invalidateContainer(aPlacesNode) {</span>
<a href="#l18.2082"></a><span id="l18.2082" class="difflineplus">+    let elt = this._getDOMNodeForPlacesNode(aPlacesNode);</span>
<a href="#l18.2083"></a><span id="l18.2083" class="difflineplus">+    if (elt != this._rootElt)</span>
<a href="#l18.2084"></a><span id="l18.2084" class="difflineplus">+      return;</span>
<a href="#l18.2085"></a><span id="l18.2085" class="difflineplus">+</span>
<a href="#l18.2086"></a><span id="l18.2086" class="difflineplus">+    // Container is the toolbar itself.</span>
<a href="#l18.2087"></a><span id="l18.2087" class="difflineplus">+    while (this._rootElt.hasChildNodes()) {</span>
<a href="#l18.2088"></a><span id="l18.2088" class="difflineplus">+      this._rootElt.firstChild.remove();</span>
<a href="#l18.2089"></a><span id="l18.2089" class="difflineplus">+    }</span>
<a href="#l18.2090"></a><span id="l18.2090" class="difflineplus">+</span>
<a href="#l18.2091"></a><span id="l18.2091" class="difflineplus">+    for (let i = 0; i &lt; this._resultNode.childCount; ++i) {</span>
<a href="#l18.2092"></a><span id="l18.2092" class="difflineplus">+      this._insertNewItem(this._resultNode.getChild(i), null);</span>
<a href="#l18.2093"></a><span id="l18.2093" class="difflineplus">+    }</span>
<a href="#l18.2094"></a><span id="l18.2094" class="difflineplus">+  }</span>
<a href="#l18.2095"></a><span id="l18.2095" class="difflineplus">+};</span>
<a href="#l18.2096"></a><span id="l18.2096" class="difflineplus">+</span>
<a href="#l18.2097"></a><span id="l18.2097" class="difflineplus">+var PlacesPanelview = class extends PlacesViewBase {</span>
<a href="#l18.2098"></a><span id="l18.2098" class="difflineplus">+  constructor(container, panelview, place, options = {}) {</span>
<a href="#l18.2099"></a><span id="l18.2099" class="difflineplus">+    options.rootElt = container;</span>
<a href="#l18.2100"></a><span id="l18.2100" class="difflineplus">+    options.viewElt = panelview;</span>
<a href="#l18.2101"></a><span id="l18.2101" class="difflineplus">+    super(place, options);</span>
<a href="#l18.2102"></a><span id="l18.2102" class="difflineplus">+    this._viewElt._placesView = this;</span>
<a href="#l18.2103"></a><span id="l18.2103" class="difflineplus">+    // We're simulating a popup show, because a panelview may only be shown when</span>
<a href="#l18.2104"></a><span id="l18.2104" class="difflineplus">+    // its containing popup is already shown.</span>
<a href="#l18.2105"></a><span id="l18.2105" class="difflineplus">+    this._onPopupShowing({ originalTarget: this._viewElt });</span>
<a href="#l18.2106"></a><span id="l18.2106" class="difflineplus">+    this._addEventListeners(window, [&quot;unload&quot;]);</span>
<a href="#l18.2107"></a><span id="l18.2107" class="difflineplus">+    this._rootElt.setAttribute(&quot;context&quot;, &quot;placesContext&quot;);</span>
<a href="#l18.2108"></a><span id="l18.2108" class="difflineplus">+  }</span>
<a href="#l18.2109"></a><span id="l18.2109" class="difflineplus">+</span>
<a href="#l18.2110"></a><span id="l18.2110" class="difflineplus">+  get events() {</span>
<a href="#l18.2111"></a><span id="l18.2111" class="difflineplus">+    if (this._events)</span>
<a href="#l18.2112"></a><span id="l18.2112" class="difflineplus">+      return this._events;</span>
<a href="#l18.2113"></a><span id="l18.2113" class="difflineplus">+    return this._events = [&quot;command&quot;, &quot;destructed&quot;, &quot;dragend&quot;, &quot;dragstart&quot;,</span>
<a href="#l18.2114"></a><span id="l18.2114" class="difflineplus">+      &quot;ViewHiding&quot;, &quot;ViewShowing&quot;, &quot;ViewShown&quot;];</span>
<a href="#l18.2115"></a><span id="l18.2115" class="difflineplus">+  }</span>
<a href="#l18.2116"></a><span id="l18.2116" class="difflineplus">+</span>
<a href="#l18.2117"></a><span id="l18.2117" class="difflineplus">+  get panel() {</span>
<a href="#l18.2118"></a><span id="l18.2118" class="difflineplus">+    return this.panelMultiView.parentNode;</span>
<a href="#l18.2119"></a><span id="l18.2119" class="difflineplus">+  }</span>
<a href="#l18.2120"></a><span id="l18.2120" class="difflineplus">+</span>
<a href="#l18.2121"></a><span id="l18.2121" class="difflineplus">+  get panelMultiView() {</span>
<a href="#l18.2122"></a><span id="l18.2122" class="difflineplus">+    return this._viewElt.panelMultiView;</span>
<a href="#l18.2123"></a><span id="l18.2123" class="difflineplus">+  }</span>
<a href="#l18.2124"></a><span id="l18.2124" class="difflineplus">+</span>
<a href="#l18.2125"></a><span id="l18.2125" class="difflineplus">+  handleEvent(event) {</span>
<a href="#l18.2126"></a><span id="l18.2126" class="difflineplus">+    switch (event.type) {</span>
<a href="#l18.2127"></a><span id="l18.2127" class="difflineplus">+      case &quot;command&quot;:</span>
<a href="#l18.2128"></a><span id="l18.2128" class="difflineplus">+        this._onCommand(event);</span>
<a href="#l18.2129"></a><span id="l18.2129" class="difflineplus">+        break;</span>
<a href="#l18.2130"></a><span id="l18.2130" class="difflineplus">+      case &quot;destructed&quot;:</span>
<a href="#l18.2131"></a><span id="l18.2131" class="difflineplus">+        this._onDestructed(event);</span>
<a href="#l18.2132"></a><span id="l18.2132" class="difflineplus">+        break;</span>
<a href="#l18.2133"></a><span id="l18.2133" class="difflineplus">+      case &quot;dragend&quot;:</span>
<a href="#l18.2134"></a><span id="l18.2134" class="difflineplus">+        this._onDragEnd(event);</span>
<a href="#l18.2135"></a><span id="l18.2135" class="difflineplus">+        break;</span>
<a href="#l18.2136"></a><span id="l18.2136" class="difflineplus">+      case &quot;dragstart&quot;:</span>
<a href="#l18.2137"></a><span id="l18.2137" class="difflineplus">+        this._onDragStart(event);</span>
<a href="#l18.2138"></a><span id="l18.2138" class="difflineplus">+        break;</span>
<a href="#l18.2139"></a><span id="l18.2139" class="difflineplus">+      case &quot;unload&quot;:</span>
<a href="#l18.2140"></a><span id="l18.2140" class="difflineplus">+        this.uninit(event);</span>
<a href="#l18.2141"></a><span id="l18.2141" class="difflineplus">+        break;</span>
<a href="#l18.2142"></a><span id="l18.2142" class="difflineplus">+      case &quot;ViewHiding&quot;:</span>
<a href="#l18.2143"></a><span id="l18.2143" class="difflineplus">+        this._onPopupHidden(event);</span>
<a href="#l18.2144"></a><span id="l18.2144" class="difflineplus">+        break;</span>
<a href="#l18.2145"></a><span id="l18.2145" class="difflineplus">+      case &quot;ViewShowing&quot;:</span>
<a href="#l18.2146"></a><span id="l18.2146" class="difflineplus">+        this._onPopupShowing(event);</span>
<a href="#l18.2147"></a><span id="l18.2147" class="difflineplus">+        break;</span>
<a href="#l18.2148"></a><span id="l18.2148" class="difflineplus">+      case &quot;ViewShown&quot;:</span>
<a href="#l18.2149"></a><span id="l18.2149" class="difflineplus">+        this._onViewShown(event);</span>
<a href="#l18.2150"></a><span id="l18.2150" class="difflineplus">+        break;</span>
<a href="#l18.2151"></a><span id="l18.2151" class="difflineplus">+    }</span>
<a href="#l18.2152"></a><span id="l18.2152" class="difflineplus">+  }</span>
<a href="#l18.2153"></a><span id="l18.2153" class="difflineplus">+</span>
<a href="#l18.2154"></a><span id="l18.2154" class="difflineplus">+  _onCommand(event) {</span>
<a href="#l18.2155"></a><span id="l18.2155" class="difflineplus">+    let button = event.originalTarget;</span>
<a href="#l18.2156"></a><span id="l18.2156" class="difflineplus">+    if (!button._placesNode)</span>
<a href="#l18.2157"></a><span id="l18.2157" class="difflineplus">+      return;</span>
<a href="#l18.2158"></a><span id="l18.2158" class="difflineplus">+</span>
<a href="#l18.2159"></a><span id="l18.2159" class="difflineplus">+    PlacesUIUtils.openNodeWithEvent(button._placesNode, event);</span>
<a href="#l18.2160"></a><span id="l18.2160" class="difflineplus">+  }</span>
<a href="#l18.2161"></a><span id="l18.2161" class="difflineplus">+</span>
<a href="#l18.2162"></a><span id="l18.2162" class="difflineplus">+  _onDestructed(event) {</span>
<a href="#l18.2163"></a><span id="l18.2163" class="difflineplus">+    // The panelmultiview is ephemeral, so let's keep an eye out when the root</span>
<a href="#l18.2164"></a><span id="l18.2164" class="difflineplus">+    // element is showing again.</span>
<a href="#l18.2165"></a><span id="l18.2165" class="difflineplus">+    this._removeEventListeners(event.target, this.events);</span>
<a href="#l18.2166"></a><span id="l18.2166" class="difflineplus">+    this._addEventListeners(this._viewElt, [&quot;ViewShowing&quot;]);</span>
<a href="#l18.2167"></a><span id="l18.2167" class="difflineplus">+  }</span>
<a href="#l18.2168"></a><span id="l18.2168" class="difflineplus">+</span>
<a href="#l18.2169"></a><span id="l18.2169" class="difflineplus">+  _onDragEnd() {</span>
<a href="#l18.2170"></a><span id="l18.2170" class="difflineplus">+    this._draggedElt = null;</span>
<a href="#l18.2171"></a><span id="l18.2171" class="difflineplus">+  }</span>
<a href="#l18.2172"></a><span id="l18.2172" class="difflineplus">+</span>
<a href="#l18.2173"></a><span id="l18.2173" class="difflineplus">+  _onDragStart(event) {</span>
<a href="#l18.2174"></a><span id="l18.2174" class="difflineplus">+    let draggedElt = event.originalTarget;</span>
<a href="#l18.2175"></a><span id="l18.2175" class="difflineplus">+    if (draggedElt.parentNode != this._rootElt || !draggedElt._placesNode)</span>
<a href="#l18.2176"></a><span id="l18.2176" class="difflineplus">+      return;</span>
<a href="#l18.2177"></a><span id="l18.2177" class="difflineplus">+</span>
<a href="#l18.2178"></a><span id="l18.2178" class="difflineplus">+    // Activate the view and cache the dragged element.</span>
<a href="#l18.2179"></a><span id="l18.2179" class="difflineplus">+    this._draggedElt = draggedElt._placesNode;</span>
<a href="#l18.2180"></a><span id="l18.2180" class="difflineplus">+    this._rootElt.focus();</span>
<a href="#l18.2181"></a><span id="l18.2181" class="difflineplus">+</span>
<a href="#l18.2182"></a><span id="l18.2182" class="difflineplus">+    this._controller.setDataTransfer(event);</span>
<a href="#l18.2183"></a><span id="l18.2183" class="difflineplus">+    event.stopPropagation();</span>
<a href="#l18.2184"></a><span id="l18.2184" class="difflineplus">+  }</span>
<a href="#l18.2185"></a><span id="l18.2185" class="difflineplus">+</span>
<a href="#l18.2186"></a><span id="l18.2186" class="difflineplus">+  uninit(event) {</span>
<a href="#l18.2187"></a><span id="l18.2187" class="difflineplus">+    this._removeEventListeners(this.panelMultiView, this.events);</span>
<a href="#l18.2188"></a><span id="l18.2188" class="difflineplus">+    this._removeEventListeners(this._viewElt, [&quot;ViewShowing&quot;]);</span>
<a href="#l18.2189"></a><span id="l18.2189" class="difflineplus">+    this._removeEventListeners(window, [&quot;unload&quot;]);</span>
<a href="#l18.2190"></a><span id="l18.2190" class="difflineplus">+    super.uninit(event);</span>
<a href="#l18.2191"></a><span id="l18.2191" class="difflineplus">+  }</span>
<a href="#l18.2192"></a><span id="l18.2192" class="difflineplus">+</span>
<a href="#l18.2193"></a><span id="l18.2193" class="difflineplus">+  _createDOMNodeForPlacesNode(placesNode) {</span>
<a href="#l18.2194"></a><span id="l18.2194" class="difflineplus">+    this._domNodes.delete(placesNode);</span>
<a href="#l18.2195"></a><span id="l18.2195" class="difflineplus">+</span>
<a href="#l18.2196"></a><span id="l18.2196" class="difflineplus">+    let element;</span>
<a href="#l18.2197"></a><span id="l18.2197" class="difflineplus">+    let type = placesNode.type;</span>
<a href="#l18.2198"></a><span id="l18.2198" class="difflineplus">+    if (type == Ci.nsINavHistoryResultNode.RESULT_TYPE_SEPARATOR) {</span>
<a href="#l18.2199"></a><span id="l18.2199" class="difflineplus">+      element = document.createElement(&quot;toolbarseparator&quot;);</span>
<a href="#l18.2200"></a><span id="l18.2200" class="difflineplus">+    } else {</span>
<a href="#l18.2201"></a><span id="l18.2201" class="difflineplus">+      if (type != Ci.nsINavHistoryResultNode.RESULT_TYPE_URI)</span>
<a href="#l18.2202"></a><span id="l18.2202" class="difflineplus">+        throw &quot;Unexpected node&quot;;</span>
<a href="#l18.2203"></a><span id="l18.2203" class="difflineplus">+</span>
<a href="#l18.2204"></a><span id="l18.2204" class="difflineplus">+      element = document.createElement(&quot;toolbarbutton&quot;);</span>
<a href="#l18.2205"></a><span id="l18.2205" class="difflineplus">+      element.classList.add(&quot;subviewbutton&quot;, &quot;subviewbutton-iconic&quot;, &quot;bookmark-item&quot;);</span>
<a href="#l18.2206"></a><span id="l18.2206" class="difflineplus">+      element.setAttribute(&quot;scheme&quot;, PlacesUIUtils.guessUrlSchemeForUI(placesNode.uri));</span>
<a href="#l18.2207"></a><span id="l18.2207" class="difflineplus">+      element.setAttribute(&quot;label&quot;, PlacesUIUtils.getBestTitle(placesNode));</span>
<a href="#l18.2208"></a><span id="l18.2208" class="difflineplus">+</span>
<a href="#l18.2209"></a><span id="l18.2209" class="difflineplus">+      let icon = placesNode.icon;</span>
<a href="#l18.2210"></a><span id="l18.2210" class="difflineplus">+      if (icon)</span>
<a href="#l18.2211"></a><span id="l18.2211" class="difflineplus">+        element.setAttribute(&quot;image&quot;, icon);</span>
<a href="#l18.2212"></a><span id="l18.2212" class="difflineplus">+    }</span>
<a href="#l18.2213"></a><span id="l18.2213" class="difflineplus">+</span>
<a href="#l18.2214"></a><span id="l18.2214" class="difflineplus">+    element._placesNode = placesNode;</span>
<a href="#l18.2215"></a><span id="l18.2215" class="difflineplus">+    if (!this._domNodes.has(placesNode))</span>
<a href="#l18.2216"></a><span id="l18.2216" class="difflineplus">+      this._domNodes.set(placesNode, element);</span>
<a href="#l18.2217"></a><span id="l18.2217" class="difflineplus">+</span>
<a href="#l18.2218"></a><span id="l18.2218" class="difflineplus">+    return element;</span>
<a href="#l18.2219"></a><span id="l18.2219" class="difflineplus">+  }</span>
<a href="#l18.2220"></a><span id="l18.2220" class="difflineplus">+</span>
<a href="#l18.2221"></a><span id="l18.2221" class="difflineplus">+  _setEmptyPopupStatus(panelview, empty = false) {</span>
<a href="#l18.2222"></a><span id="l18.2222" class="difflineplus">+    if (!panelview._emptyMenuitem) {</span>
<a href="#l18.2223"></a><span id="l18.2223" class="difflineplus">+      let label = PlacesUIUtils.getString(&quot;bookmarksMenuEmptyFolder&quot;);</span>
<a href="#l18.2224"></a><span id="l18.2224" class="difflineplus">+      panelview._emptyMenuitem = document.createElement(&quot;toolbarbutton&quot;);</span>
<a href="#l18.2225"></a><span id="l18.2225" class="difflineplus">+      panelview._emptyMenuitem.setAttribute(&quot;label&quot;, label);</span>
<a href="#l18.2226"></a><span id="l18.2226" class="difflineplus">+      panelview._emptyMenuitem.setAttribute(&quot;disabled&quot;, true);</span>
<a href="#l18.2227"></a><span id="l18.2227" class="difflineplus">+      panelview._emptyMenuitem.className = &quot;subviewbutton&quot;;</span>
<a href="#l18.2228"></a><span id="l18.2228" class="difflineplus">+      if (typeof this.options.extraClasses.entry == &quot;string&quot;)</span>
<a href="#l18.2229"></a><span id="l18.2229" class="difflineplus">+        panelview._emptyMenuitem.classList.add(this.options.extraClasses.entry);</span>
<a href="#l18.2230"></a><span id="l18.2230" class="difflineplus">+    }</span>
<a href="#l18.2231"></a><span id="l18.2231" class="difflineplus">+</span>
<a href="#l18.2232"></a><span id="l18.2232" class="difflineplus">+    if (empty) {</span>
<a href="#l18.2233"></a><span id="l18.2233" class="difflineplus">+      panelview.setAttribute(&quot;emptyplacesresult&quot;, &quot;true&quot;);</span>
<a href="#l18.2234"></a><span id="l18.2234" class="difflineplus">+      // Don't add the menuitem if there is static content.</span>
<a href="#l18.2235"></a><span id="l18.2235" class="difflineplus">+      // We also support external usage for custom crafted panels - which'll have</span>
<a href="#l18.2236"></a><span id="l18.2236" class="difflineplus">+      // no markers present.</span>
<a href="#l18.2237"></a><span id="l18.2237" class="difflineplus">+      if (!panelview._startMarker ||</span>
<a href="#l18.2238"></a><span id="l18.2238" class="difflineplus">+          (!panelview._startMarker.previousSibling &amp;&amp; !panelview._endMarker.nextSibling)) {</span>
<a href="#l18.2239"></a><span id="l18.2239" class="difflineplus">+        panelview.insertBefore(panelview._emptyMenuitem, panelview._endMarker);</span>
<a href="#l18.2240"></a><span id="l18.2240" class="difflineplus">+      }</span>
<a href="#l18.2241"></a><span id="l18.2241" class="difflineplus">+    } else {</span>
<a href="#l18.2242"></a><span id="l18.2242" class="difflineplus">+      panelview.removeAttribute(&quot;emptyplacesresult&quot;);</span>
<a href="#l18.2243"></a><span id="l18.2243" class="difflineplus">+      try {</span>
<a href="#l18.2244"></a><span id="l18.2244" class="difflineplus">+        panelview.removeChild(panelview._emptyMenuitem);</span>
<a href="#l18.2245"></a><span id="l18.2245" class="difflineplus">+      } catch (ex) {}</span>
<a href="#l18.2246"></a><span id="l18.2246" class="difflineplus">+    }</span>
<a href="#l18.2247"></a><span id="l18.2247" class="difflineplus">+  }</span>
<a href="#l18.2248"></a><span id="l18.2248" class="difflineplus">+</span>
<a href="#l18.2249"></a><span id="l18.2249" class="difflineplus">+  _isPopupOpen() {</span>
<a href="#l18.2250"></a><span id="l18.2250" class="difflineplus">+    return this.panel.state == &quot;open&quot; &amp;&amp; this.panelMultiView.current == this._viewElt;</span>
<a href="#l18.2251"></a><span id="l18.2251" class="difflineplus">+  }</span>
<a href="#l18.2252"></a><span id="l18.2252" class="difflineplus">+</span>
<a href="#l18.2253"></a><span id="l18.2253" class="difflineplus">+  _onPopupHidden(event) {</span>
<a href="#l18.2254"></a><span id="l18.2254" class="difflineplus">+    let panelview = event.originalTarget;</span>
<a href="#l18.2255"></a><span id="l18.2255" class="difflineplus">+    let placesNode = panelview._placesNode;</span>
<a href="#l18.2256"></a><span id="l18.2256" class="difflineplus">+    // Avoid handling ViewHiding of inner views</span>
<a href="#l18.2257"></a><span id="l18.2257" class="difflineplus">+    if (placesNode &amp;&amp; PlacesUIUtils.getViewForNode(panelview) == this) {</span>
<a href="#l18.2258"></a><span id="l18.2258" class="difflineplus">+      // UI performance: folder queries are cheap, keep the resultnode open</span>
<a href="#l18.2259"></a><span id="l18.2259" class="difflineplus">+      // so we don't rebuild its contents whenever the popup is reopened.</span>
<a href="#l18.2260"></a><span id="l18.2260" class="difflineplus">+      // Though, we want to always close feed containers so their expiration</span>
<a href="#l18.2261"></a><span id="l18.2261" class="difflineplus">+      // status will be checked at next opening.</span>
<a href="#l18.2262"></a><span id="l18.2262" class="difflineplus">+      if (!PlacesUtils.nodeIsFolder(placesNode) ||</span>
<a href="#l18.2263"></a><span id="l18.2263" class="difflineplus">+          this.controller.hasCachedLivemarkInfo(placesNode)) {</span>
<a href="#l18.2264"></a><span id="l18.2264" class="difflineplus">+        placesNode.containerOpen = false;</span>
<a href="#l18.2265"></a><span id="l18.2265" class="difflineplus">+      }</span>
<a href="#l18.2266"></a><span id="l18.2266" class="difflineplus">+    }</span>
<a href="#l18.2267"></a><span id="l18.2267" class="difflineplus">+  }</span>
<a href="#l18.2268"></a><span id="l18.2268" class="difflineplus">+</span>
<a href="#l18.2269"></a><span id="l18.2269" class="difflineplus">+  _onPopupShowing(event) {</span>
<a href="#l18.2270"></a><span id="l18.2270" class="difflineplus">+    // If the event came from the root element, this is a sign that the panelmultiview</span>
<a href="#l18.2271"></a><span id="l18.2271" class="difflineplus">+    // was just instantiated (see `_onDestructed` above) or this is the first time</span>
<a href="#l18.2272"></a><span id="l18.2272" class="difflineplus">+    // we ever get here.</span>
<a href="#l18.2273"></a><span id="l18.2273" class="difflineplus">+    if (event.originalTarget == this._viewElt) {</span>
<a href="#l18.2274"></a><span id="l18.2274" class="difflineplus">+      this._removeEventListeners(this._viewElt, [&quot;ViewShowing&quot;]);</span>
<a href="#l18.2275"></a><span id="l18.2275" class="difflineplus">+      // Start listening for events from all panels inside the panelmultiview.</span>
<a href="#l18.2276"></a><span id="l18.2276" class="difflineplus">+      this._addEventListeners(this.panelMultiView, this.events);</span>
<a href="#l18.2277"></a><span id="l18.2277" class="difflineplus">+    }</span>
<a href="#l18.2278"></a><span id="l18.2278" class="difflineplus">+    super._onPopupShowing(event);</span>
<a href="#l18.2279"></a><span id="l18.2279" class="difflineplus">+  }</span>
<a href="#l18.2280"></a><span id="l18.2280" class="difflineplus">+</span>
<a href="#l18.2281"></a><span id="l18.2281" class="difflineplus">+  _onViewShown(event) {</span>
<a href="#l18.2282"></a><span id="l18.2282" class="difflineplus">+    if (event.originalTarget != this._viewElt)</span>
<a href="#l18.2283"></a><span id="l18.2283" class="difflineplus">+      return;</span>
<a href="#l18.2284"></a><span id="l18.2284" class="difflineplus">+</span>
<a href="#l18.2285"></a><span id="l18.2285" class="difflineplus">+    // Because PanelMultiView reparents the panelview internally, the controller</span>
<a href="#l18.2286"></a><span id="l18.2286" class="difflineplus">+    // may get lost. In that case we'll append it again, because we certainly</span>
<a href="#l18.2287"></a><span id="l18.2287" class="difflineplus">+    // need it later!</span>
<a href="#l18.2288"></a><span id="l18.2288" class="difflineplus">+    if (!this.controllers.getControllerCount() &amp;&amp; this._controller)</span>
<a href="#l18.2289"></a><span id="l18.2289" class="difflineplus">+      this.controllers.appendController(this._controller);</span>
<a href="#l18.2290"></a><span id="l18.2290" class="difflineplus">+  }</span>
<a href="#l18.2291"></a><span id="l18.2291" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/suite/common/places/content/controller.js</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/suite/common/places/content/controller.js</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -1,106 +1,124 @@</span>
<a href="#l19.4"></a><span id="l19.4" class="difflineminus">-/* -*- Mode: C++; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l19.5"></a><span id="l19.5" class="difflineplus">+/* -*- indent-tabs-mode: nil; js-indent-level: 2 -*- */</span>
<a href="#l19.6"></a><span id="l19.6"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l19.7"></a><span id="l19.7">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l19.8"></a><span id="l19.8">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l19.9"></a><span id="l19.9"> </span>
<a href="#l19.10"></a><span id="l19.10" class="difflineplus">+ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l19.11"></a><span id="l19.11"> ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineplus">+</span>
<a href="#l19.14"></a><span id="l19.14" class="difflineplus">+ChromeUtils.defineModuleGetter(this, &quot;ForgetAboutSite&quot;,</span>
<a href="#l19.15"></a><span id="l19.15" class="difflineplus">+                               &quot;resource://gre/modules/ForgetAboutSite.jsm&quot;);</span>
<a href="#l19.16"></a><span id="l19.16" class="difflineplus">+ChromeUtils.defineModuleGetter(this, &quot;NetUtil&quot;,</span>
<a href="#l19.17"></a><span id="l19.17" class="difflineplus">+                               &quot;resource://gre/modules/NetUtil.jsm&quot;);</span>
<a href="#l19.18"></a><span id="l19.18" class="difflineplus">+ChromeUtils.defineModuleGetter(this, &quot;PrivateBrowsingUtils&quot;,</span>
<a href="#l19.19"></a><span id="l19.19" class="difflineplus">+                               &quot;resource://gre/modules/PrivateBrowsingUtils.jsm&quot;);</span>
<a href="#l19.20"></a><span id="l19.20"> </span>
<a href="#l19.21"></a><span id="l19.21"> // XXXmano: we should move most/all of these constants to PlacesUtils</span>
<a href="#l19.22"></a><span id="l19.22"> const ORGANIZER_ROOT_BOOKMARKS = &quot;place:folder=BOOKMARKS_MENU&amp;excludeItems=1&amp;queryType=1&quot;;</span>
<a href="#l19.23"></a><span id="l19.23"> </span>
<a href="#l19.24"></a><span id="l19.24"> // No change to the view, preserve current selection</span>
<a href="#l19.25"></a><span id="l19.25"> const RELOAD_ACTION_NOTHING = 0;</span>
<a href="#l19.26"></a><span id="l19.26"> // Inserting items new to the view, select the inserted rows</span>
<a href="#l19.27"></a><span id="l19.27"> const RELOAD_ACTION_INSERT = 1;</span>
<a href="#l19.28"></a><span id="l19.28"> // Removing items from the view, select the first item after the last selected</span>
<a href="#l19.29"></a><span id="l19.29"> const RELOAD_ACTION_REMOVE = 2;</span>
<a href="#l19.30"></a><span id="l19.30"> // Moving items within a view, don't treat the dropped items as additional</span>
<a href="#l19.31"></a><span id="l19.31"> // rows.</span>
<a href="#l19.32"></a><span id="l19.32"> const RELOAD_ACTION_MOVE = 3;</span>
<a href="#l19.33"></a><span id="l19.33"> </span>
<a href="#l19.34"></a><span id="l19.34" class="difflineminus">-// when removing a bunch of pages we split them in chunks to avoid passing</span>
<a href="#l19.35"></a><span id="l19.35" class="difflineminus">-// a too big array to RemovePages</span>
<a href="#l19.36"></a><span id="l19.36" class="difflineminus">-// 300 is the best choice with an history of about 150000 visits</span>
<a href="#l19.37"></a><span id="l19.37" class="difflineminus">-// smaller chunks could cause a Slow Script warning with a huge history</span>
<a href="#l19.38"></a><span id="l19.38" class="difflineminus">-const REMOVE_PAGES_CHUNKLEN = 300;</span>
<a href="#l19.39"></a><span id="l19.39" class="difflineminus">-// if we are removing less than this pages we will remove them one by one</span>
<a href="#l19.40"></a><span id="l19.40" class="difflineminus">-// since it will be reflected faster on the UI</span>
<a href="#l19.41"></a><span id="l19.41" class="difflineminus">-// 10 is a good compromise, since allows the user to delete a little amount of</span>
<a href="#l19.42"></a><span id="l19.42" class="difflineminus">-// urls for privacy reasons, but does not cause heavy disk access</span>
<a href="#l19.43"></a><span id="l19.43" class="difflineminus">-const REMOVE_PAGES_MAX_SINGLEREMOVES = 10;</span>
<a href="#l19.44"></a><span id="l19.44" class="difflineminus">-</span>
<a href="#l19.45"></a><span id="l19.45" class="difflineminus">-// XXX: should pull in from global definition, see bug 585500</span>
<a href="#l19.46"></a><span id="l19.46" class="difflineminus">-var TAB_DROP_TYPE = &quot;application/x-moz-tabbrowser-tab&quot;;</span>
<a href="#l19.47"></a><span id="l19.47" class="difflineminus">-</span>
<a href="#l19.48"></a><span id="l19.48"> /**</span>
<a href="#l19.49"></a><span id="l19.49">  * Represents an insertion point within a container where we can insert</span>
<a href="#l19.50"></a><span id="l19.50">  * items.</span>
<a href="#l19.51"></a><span id="l19.51">  * @param   aItemId</span>
<a href="#l19.52"></a><span id="l19.52">  *          The identifier of the parent container</span>
<a href="#l19.53"></a><span id="l19.53">  * @param   aIndex</span>
<a href="#l19.54"></a><span id="l19.54">  *          The index within the container where we should insert</span>
<a href="#l19.55"></a><span id="l19.55">  * @param   aOrientation</span>
<a href="#l19.56"></a><span id="l19.56">  *          The orientation of the insertion. NOTE: the adjustments to the</span>
<a href="#l19.57"></a><span id="l19.57">  *          insertion point to accommodate the orientation should be done by</span>
<a href="#l19.58"></a><span id="l19.58">  *          the person who constructs the IP, not the user. The orientation</span>
<a href="#l19.59"></a><span id="l19.59">  *          is provided for informational purposes only!</span>
<a href="#l19.60"></a><span id="l19.60" class="difflineminus">- * @param   [optional] aIsTag</span>
<a href="#l19.61"></a><span id="l19.61" class="difflineminus">- *          Indicates if parent container is a tag</span>
<a href="#l19.62"></a><span id="l19.62" class="difflineplus">+ * @param   [optional] aTag</span>
<a href="#l19.63"></a><span id="l19.63" class="difflineplus">+ *          The tag name if this IP is set to a tag, null otherwise.</span>
<a href="#l19.64"></a><span id="l19.64">  * @param   [optional] aDropNearItemId</span>
<a href="#l19.65"></a><span id="l19.65">  *          When defined we will calculate index based on this itemId</span>
<a href="#l19.66"></a><span id="l19.66">  * @constructor</span>
<a href="#l19.67"></a><span id="l19.67">  */</span>
<a href="#l19.68"></a><span id="l19.68" class="difflineminus">-function InsertionPoint(aItemId, aIndex, aOrientation, aIsTag,</span>
<a href="#l19.69"></a><span id="l19.69" class="difflineminus">-                        aDropNearItemId) {</span>
<a href="#l19.70"></a><span id="l19.70" class="difflineplus">+function InsertionPoint(aItemId, aIndex, aOrientation, aTagName = null,</span>
<a href="#l19.71"></a><span id="l19.71" class="difflineplus">+                        aDropNearItemId = false) {</span>
<a href="#l19.72"></a><span id="l19.72">   this.itemId = aItemId;</span>
<a href="#l19.73"></a><span id="l19.73">   this._index = aIndex;</span>
<a href="#l19.74"></a><span id="l19.74">   this.orientation = aOrientation;</span>
<a href="#l19.75"></a><span id="l19.75">   this.isTag = aIsTag;</span>
<a href="#l19.76"></a><span id="l19.76" class="difflineplus">+  this.tagName = aTagName;</span>
<a href="#l19.77"></a><span id="l19.77">   this.dropNearItemId = aDropNearItemId;</span>
<a href="#l19.78"></a><span id="l19.78"> }</span>
<a href="#l19.79"></a><span id="l19.79"> </span>
<a href="#l19.80"></a><span id="l19.80"> InsertionPoint.prototype = {</span>
<a href="#l19.81"></a><span id="l19.81">   set index(val) {</span>
<a href="#l19.82"></a><span id="l19.82">     return this._index = val;</span>
<a href="#l19.83"></a><span id="l19.83">   },</span>
<a href="#l19.84"></a><span id="l19.84"> </span>
<a href="#l19.85"></a><span id="l19.85" class="difflineplus">+  promiseGuid() {</span>
<a href="#l19.86"></a><span id="l19.86" class="difflineplus">+    return PlacesUtils.promiseItemGuid(this.itemId);</span>
<a href="#l19.87"></a><span id="l19.87" class="difflineplus">+  },</span>
<a href="#l19.88"></a><span id="l19.88" class="difflineplus">+</span>
<a href="#l19.89"></a><span id="l19.89">   get index() {</span>
<a href="#l19.90"></a><span id="l19.90">     if (this.dropNearItemId &gt; 0) {</span>
<a href="#l19.91"></a><span id="l19.91">       // If dropNearItemId is set up we must calculate the real index of</span>
<a href="#l19.92"></a><span id="l19.92">       // the item near which we will drop.</span>
<a href="#l19.93"></a><span id="l19.93">       var index = PlacesUtils.bookmarks.getItemIndex(this.dropNearItemId);</span>
<a href="#l19.94"></a><span id="l19.94">       return this.orientation == Ci.nsITreeView.DROP_BEFORE ? index : index + 1;</span>
<a href="#l19.95"></a><span id="l19.95">     }</span>
<a href="#l19.96"></a><span id="l19.96">     return this._index;</span>
<a href="#l19.97"></a><span id="l19.97" class="difflineplus">+  },</span>
<a href="#l19.98"></a><span id="l19.98" class="difflineplus">+</span>
<a href="#l19.99"></a><span id="l19.99" class="difflineplus">+  get isTag() {</span>
<a href="#l19.100"></a><span id="l19.100" class="difflineplus">+    return typeof(this.tagName) == &quot;string&quot;;</span>
<a href="#l19.101"></a><span id="l19.101">   }</span>
<a href="#l19.102"></a><span id="l19.102"> };</span>
<a href="#l19.103"></a><span id="l19.103"> </span>
<a href="#l19.104"></a><span id="l19.104"> /**</span>
<a href="#l19.105"></a><span id="l19.105">  * Places Controller</span>
<a href="#l19.106"></a><span id="l19.106">  */</span>
<a href="#l19.107"></a><span id="l19.107"> </span>
<a href="#l19.108"></a><span id="l19.108"> function PlacesController(aView) {</span>
<a href="#l19.109"></a><span id="l19.109">   this._view = aView;</span>
<a href="#l19.110"></a><span id="l19.110">   XPCOMUtils.defineLazyServiceGetter(this, &quot;clipboard&quot;,</span>
<a href="#l19.111"></a><span id="l19.111">                                      &quot;@mozilla.org/widget/clipboard;1&quot;,</span>
<a href="#l19.112"></a><span id="l19.112">                                      &quot;nsIClipboard&quot;);</span>
<a href="#l19.113"></a><span id="l19.113" class="difflineplus">+  XPCOMUtils.defineLazyGetter(this, &quot;profileName&quot;, function() {</span>
<a href="#l19.114"></a><span id="l19.114" class="difflineplus">+    return Services.dirsvc.get(&quot;ProfD&quot;, Ci.nsIFile).leafName;</span>
<a href="#l19.115"></a><span id="l19.115" class="difflineplus">+  });</span>
<a href="#l19.116"></a><span id="l19.116" class="difflineplus">+</span>
<a href="#l19.117"></a><span id="l19.117">   this._cachedLivemarkInfoObjects = new Map();</span>
<a href="#l19.118"></a><span id="l19.118"> }</span>
<a href="#l19.119"></a><span id="l19.119"> </span>
<a href="#l19.120"></a><span id="l19.120"> PlacesController.prototype = {</span>
<a href="#l19.121"></a><span id="l19.121">   /**</span>
<a href="#l19.122"></a><span id="l19.122">    * The places view.</span>
<a href="#l19.123"></a><span id="l19.123">    */</span>
<a href="#l19.124"></a><span id="l19.124">   _view: null,</span>
<a href="#l19.125"></a><span id="l19.125"> </span>
<a href="#l19.126"></a><span id="l19.126" class="difflineplus">+  QueryInterface: XPCOMUtils.generateQI([</span>
<a href="#l19.127"></a><span id="l19.127" class="difflineplus">+    Ci.nsIClipboardOwner</span>
<a href="#l19.128"></a><span id="l19.128" class="difflineplus">+  ]),</span>
<a href="#l19.129"></a><span id="l19.129" class="difflineplus">+</span>
<a href="#l19.130"></a><span id="l19.130" class="difflineplus">+  // nsIClipboardOwner</span>
<a href="#l19.131"></a><span id="l19.131" class="difflineplus">+  LosingOwnership: function PC_LosingOwnership(aXferable) {</span>
<a href="#l19.132"></a><span id="l19.132" class="difflineplus">+    this.cutNodes = [];</span>
<a href="#l19.133"></a><span id="l19.133" class="difflineplus">+  },</span>
<a href="#l19.134"></a><span id="l19.134" class="difflineplus">+</span>
<a href="#l19.135"></a><span id="l19.135" class="difflineplus">+  terminate: function PC_terminate() {</span>
<a href="#l19.136"></a><span id="l19.136" class="difflineplus">+    this._releaseClipboardOwnership();</span>
<a href="#l19.137"></a><span id="l19.137" class="difflineplus">+  },</span>
<a href="#l19.138"></a><span id="l19.138" class="difflineplus">+</span>
<a href="#l19.139"></a><span id="l19.139">   supportsCommand: function PC_supportsCommand(aCommand) {</span>
<a href="#l19.140"></a><span id="l19.140" class="difflineminus">-    //LOG(&quot;supportsCommand: &quot; + command);</span>
<a href="#l19.141"></a><span id="l19.141">     // Non-Places specific commands that we also support</span>
<a href="#l19.142"></a><span id="l19.142">     switch (aCommand) {</span>
<a href="#l19.143"></a><span id="l19.143">     case &quot;cmd_undo&quot;:</span>
<a href="#l19.144"></a><span id="l19.144">     case &quot;cmd_redo&quot;:</span>
<a href="#l19.145"></a><span id="l19.145">     case &quot;cmd_cut&quot;:</span>
<a href="#l19.146"></a><span id="l19.146">     case &quot;cmd_copy&quot;:</span>
<a href="#l19.147"></a><span id="l19.147">     case &quot;cmd_paste&quot;:</span>
<a href="#l19.148"></a><span id="l19.148">     case &quot;cmd_delete&quot;:</span>
<a href="#l19.149"></a><span id="l19.149" class="difflineat">@@ -112,25 +130,30 @@ PlacesController.prototype = {</span>
<a href="#l19.150"></a><span id="l19.150">     // filters out other commands that we do _not_ support (see 329587).</span>
<a href="#l19.151"></a><span id="l19.151">     const CMD_PREFIX = &quot;placesCmd_&quot;;</span>
<a href="#l19.152"></a><span id="l19.152">     return (aCommand.substr(0, CMD_PREFIX.length) == CMD_PREFIX);</span>
<a href="#l19.153"></a><span id="l19.153">   },</span>
<a href="#l19.154"></a><span id="l19.154"> </span>
<a href="#l19.155"></a><span id="l19.155">   isCommandEnabled: function PC_isCommandEnabled(aCommand) {</span>
<a href="#l19.156"></a><span id="l19.156">     switch (aCommand) {</span>
<a href="#l19.157"></a><span id="l19.157">     case &quot;cmd_undo&quot;:</span>
<a href="#l19.158"></a><span id="l19.158" class="difflineminus">-      return PlacesUtils.transactionManager.numberOfUndoItems &gt; 0;</span>
<a href="#l19.159"></a><span id="l19.159" class="difflineplus">+      if (!PlacesUIUtils.useAsyncTransactions)</span>
<a href="#l19.160"></a><span id="l19.160" class="difflineplus">+        return PlacesUtils.transactionManager.numberOfUndoItems &gt; 0;</span>
<a href="#l19.161"></a><span id="l19.161" class="difflineplus">+</span>
<a href="#l19.162"></a><span id="l19.162" class="difflineplus">+      return PlacesTransactions.topUndoEntry != null;</span>
<a href="#l19.163"></a><span id="l19.163">     case &quot;cmd_redo&quot;:</span>
<a href="#l19.164"></a><span id="l19.164" class="difflineminus">-      return PlacesUtils.transactionManager.numberOfRedoItems &gt; 0;</span>
<a href="#l19.165"></a><span id="l19.165" class="difflineplus">+      if (!PlacesUIUtils.useAsyncTransactions)</span>
<a href="#l19.166"></a><span id="l19.166" class="difflineplus">+        return PlacesUtils.transactionManager.numberOfRedoItems &gt; 0;</span>
<a href="#l19.167"></a><span id="l19.167" class="difflineplus">+</span>
<a href="#l19.168"></a><span id="l19.168" class="difflineplus">+      return PlacesTransactions.topRedoEntry != null;</span>
<a href="#l19.169"></a><span id="l19.169">     case &quot;cmd_cut&quot;:</span>
<a href="#l19.170"></a><span id="l19.170">     case &quot;placesCmd_cut&quot;:</span>
<a href="#l19.171"></a><span id="l19.171" class="difflineminus">-    case &quot;placesCmd_moveBookmarks&quot;:</span>
<a href="#l19.172"></a><span id="l19.172">       for (let node of this._view.selectedNodes) {</span>
<a href="#l19.173"></a><span id="l19.173" class="difflineminus">-        // If selection includes history nodes or tags-as-bookmark,</span>
<a href="#l19.174"></a><span id="l19.174" class="difflineminus">-        // disallow cutting.</span>
<a href="#l19.175"></a><span id="l19.175" class="difflineplus">+        // If selection includes history nodes or tags-as-bookmark, disallow</span>
<a href="#l19.176"></a><span id="l19.176" class="difflineplus">+        // cutting.</span>
<a href="#l19.177"></a><span id="l19.177">         if (node.itemId == -1 ||</span>
<a href="#l19.178"></a><span id="l19.178">             (node.parent &amp;&amp; PlacesUtils.nodeIsTagQuery(node.parent))) {</span>
<a href="#l19.179"></a><span id="l19.179">           return false;</span>
<a href="#l19.180"></a><span id="l19.180">         }</span>
<a href="#l19.181"></a><span id="l19.181">       }</span>
<a href="#l19.182"></a><span id="l19.182">       // Otherwise fall through the cmd_delete check.</span>
<a href="#l19.183"></a><span id="l19.183">     case &quot;cmd_delete&quot;:</span>
<a href="#l19.184"></a><span id="l19.184">     case &quot;placesCmd_delete&quot;:</span>
<a href="#l19.185"></a><span id="l19.185" class="difflineat">@@ -145,149 +168,158 @@ PlacesController.prototype = {</span>
<a href="#l19.186"></a><span id="l19.186">     case &quot;cmd_selectAll&quot;:</span>
<a href="#l19.187"></a><span id="l19.187">       if (this._view.selType != &quot;single&quot;) {</span>
<a href="#l19.188"></a><span id="l19.188">         let rootNode = this._view.result.root;</span>
<a href="#l19.189"></a><span id="l19.189">         if (rootNode.containerOpen &amp;&amp; rootNode.childCount &gt; 0)</span>
<a href="#l19.190"></a><span id="l19.190">           return true;</span>
<a href="#l19.191"></a><span id="l19.191">       }</span>
<a href="#l19.192"></a><span id="l19.192">       return false;</span>
<a href="#l19.193"></a><span id="l19.193">     case &quot;placesCmd_open&quot;:</span>
<a href="#l19.194"></a><span id="l19.194" class="difflineminus">-    case &quot;placesCmd_open:tab&quot;:</span>
<a href="#l19.195"></a><span id="l19.195">     case &quot;placesCmd_open:window&quot;:</span>
<a href="#l19.196"></a><span id="l19.196">     case &quot;placesCmd_open:privatewindow&quot;:</span>
<a href="#l19.197"></a><span id="l19.197" class="difflineminus">-      var selectedNode = this._view.selectedNode;</span>
<a href="#l19.198"></a><span id="l19.198" class="difflineplus">+    case &quot;placesCmd_open:tab&quot;: {</span>
<a href="#l19.199"></a><span id="l19.199" class="difflineplus">+      let selectedNode = this._view.selectedNode;</span>
<a href="#l19.200"></a><span id="l19.200">       return selectedNode &amp;&amp; PlacesUtils.nodeIsURI(selectedNode);</span>
<a href="#l19.201"></a><span id="l19.201" class="difflineplus">+    }</span>
<a href="#l19.202"></a><span id="l19.202">     case &quot;placesCmd_new:folder&quot;:</span>
<a href="#l19.203"></a><span id="l19.203" class="difflineminus">-    case &quot;placesCmd_new:livemark&quot;:</span>
<a href="#l19.204"></a><span id="l19.204">       return this._canInsert();</span>
<a href="#l19.205"></a><span id="l19.205">     case &quot;placesCmd_new:bookmark&quot;:</span>
<a href="#l19.206"></a><span id="l19.206">       return this._canInsert();</span>
<a href="#l19.207"></a><span id="l19.207">     case &quot;placesCmd_new:separator&quot;:</span>
<a href="#l19.208"></a><span id="l19.208">       return this._canInsert() &amp;&amp;</span>
<a href="#l19.209"></a><span id="l19.209">              !PlacesUtils.asQuery(this._view.result.root).queryOptions.excludeItems &amp;&amp;</span>
<a href="#l19.210"></a><span id="l19.210">              this._view.result.sortingMode ==</span>
<a href="#l19.211"></a><span id="l19.211">                  Ci.nsINavHistoryQueryOptions.SORT_BY_NONE;</span>
<a href="#l19.212"></a><span id="l19.212" class="difflineminus">-    case &quot;placesCmd_show:info&quot;:</span>
<a href="#l19.213"></a><span id="l19.213" class="difflineminus">-      var selectedNode = this._view.selectedNode;</span>
<a href="#l19.214"></a><span id="l19.214" class="difflineminus">-      return selectedNode &amp;&amp; PlacesUtils.getConcreteItemId(selectedNode) != -1;</span>
<a href="#l19.215"></a><span id="l19.215" class="difflineminus">-    case &quot;placesCmd_reload&quot;:</span>
<a href="#l19.216"></a><span id="l19.216" class="difflineplus">+    case &quot;placesCmd_show:info&quot;: {</span>
<a href="#l19.217"></a><span id="l19.217" class="difflineplus">+      let selectedNode = this._view.selectedNode;</span>
<a href="#l19.218"></a><span id="l19.218" class="difflineplus">+      return selectedNode &amp;&amp; PlacesUtils.getConcreteItemId(selectedNode) != -1</span>
<a href="#l19.219"></a><span id="l19.219" class="difflineplus">+    }</span>
<a href="#l19.220"></a><span id="l19.220" class="difflineplus">+    case &quot;placesCmd_reload&quot;: {</span>
<a href="#l19.221"></a><span id="l19.221">       // Livemark containers</span>
<a href="#l19.222"></a><span id="l19.222" class="difflineminus">-      var selectedNode = this._view.selectedNode;</span>
<a href="#l19.223"></a><span id="l19.223" class="difflineplus">+      let selectedNode = this._view.selectedNode;</span>
<a href="#l19.224"></a><span id="l19.224">       return selectedNode &amp;&amp; this.hasCachedLivemarkInfo(selectedNode);</span>
<a href="#l19.225"></a><span id="l19.225" class="difflineminus">-    case &quot;placesCmd_sortBy:name&quot;:</span>
<a href="#l19.226"></a><span id="l19.226" class="difflineminus">-      var selectedNode = this._view.selectedNode;</span>
<a href="#l19.227"></a><span id="l19.227" class="difflineplus">+    }</span>
<a href="#l19.228"></a><span id="l19.228" class="difflineplus">+    case &quot;placesCmd_sortBy:name&quot;: {</span>
<a href="#l19.229"></a><span id="l19.229" class="difflineplus">+      let selectedNode = this._view.selectedNode;</span>
<a href="#l19.230"></a><span id="l19.230">       return selectedNode &amp;&amp;</span>
<a href="#l19.231"></a><span id="l19.231">              PlacesUtils.nodeIsFolder(selectedNode) &amp;&amp;</span>
<a href="#l19.232"></a><span id="l19.232">              !PlacesUIUtils.isContentsReadOnly(selectedNode) &amp;&amp;</span>
<a href="#l19.233"></a><span id="l19.233">              this._view.result.sortingMode ==</span>
<a href="#l19.234"></a><span id="l19.234">                  Ci.nsINavHistoryQueryOptions.SORT_BY_NONE;</span>
<a href="#l19.235"></a><span id="l19.235" class="difflineplus">+    }</span>
<a href="#l19.236"></a><span id="l19.236">     case &quot;placesCmd_createBookmark&quot;:</span>
<a href="#l19.237"></a><span id="l19.237">       var node = this._view.selectedNode;</span>
<a href="#l19.238"></a><span id="l19.238">       return node &amp;&amp; PlacesUtils.nodeIsURI(node) &amp;&amp; node.itemId == -1;</span>
<a href="#l19.239"></a><span id="l19.239">     default:</span>
<a href="#l19.240"></a><span id="l19.240">       return false;</span>
<a href="#l19.241"></a><span id="l19.241">     }</span>
<a href="#l19.242"></a><span id="l19.242">   },</span>
<a href="#l19.243"></a><span id="l19.243"> </span>
<a href="#l19.244"></a><span id="l19.244">   doCommand: function PC_doCommand(aCommand) {</span>
<a href="#l19.245"></a><span id="l19.245">     switch (aCommand) {</span>
<a href="#l19.246"></a><span id="l19.246">     case &quot;cmd_undo&quot;:</span>
<a href="#l19.247"></a><span id="l19.247" class="difflineminus">-      PlacesUtils.transactionManager.undoTransaction();</span>
<a href="#l19.248"></a><span id="l19.248" class="difflineplus">+      if (!PlacesUIUtils.useAsyncTransactions) {</span>
<a href="#l19.249"></a><span id="l19.249" class="difflineplus">+        PlacesUtils.transactionManager.undoTransaction();</span>
<a href="#l19.250"></a><span id="l19.250" class="difflineplus">+        return;</span>
<a href="#l19.251"></a><span id="l19.251" class="difflineplus">+      }</span>
<a href="#l19.252"></a><span id="l19.252" class="difflineplus">+      PlacesTransactions.undo().catch(Cu.reportError);</span>
<a href="#l19.253"></a><span id="l19.253">       break;</span>
<a href="#l19.254"></a><span id="l19.254">     case &quot;cmd_redo&quot;:</span>
<a href="#l19.255"></a><span id="l19.255" class="difflineminus">-      PlacesUtils.transactionManager.redoTransaction();</span>
<a href="#l19.256"></a><span id="l19.256" class="difflineplus">+      if (!PlacesUIUtils.useAsyncTransactions) {</span>
<a href="#l19.257"></a><span id="l19.257" class="difflineplus">+        PlacesUtils.transactionManager.redoTransaction();</span>
<a href="#l19.258"></a><span id="l19.258" class="difflineplus">+        return;</span>
<a href="#l19.259"></a><span id="l19.259" class="difflineplus">+      }</span>
<a href="#l19.260"></a><span id="l19.260" class="difflineplus">+      PlacesTransactions.redo().catch(Cu.reportError);</span>
<a href="#l19.261"></a><span id="l19.261">       break;</span>
<a href="#l19.262"></a><span id="l19.262">     case &quot;cmd_cut&quot;:</span>
<a href="#l19.263"></a><span id="l19.263">     case &quot;placesCmd_cut&quot;:</span>
<a href="#l19.264"></a><span id="l19.264">       this.cut();</span>
<a href="#l19.265"></a><span id="l19.265">       break;</span>
<a href="#l19.266"></a><span id="l19.266">     case &quot;cmd_copy&quot;:</span>
<a href="#l19.267"></a><span id="l19.267">     case &quot;placesCmd_copy&quot;:</span>
<a href="#l19.268"></a><span id="l19.268">       this.copy();</span>
<a href="#l19.269"></a><span id="l19.269">       break;</span>
<a href="#l19.270"></a><span id="l19.270">     case &quot;cmd_paste&quot;:</span>
<a href="#l19.271"></a><span id="l19.271">     case &quot;placesCmd_paste&quot;:</span>
<a href="#l19.272"></a><span id="l19.272" class="difflineminus">-      this.paste();</span>
<a href="#l19.273"></a><span id="l19.273" class="difflineplus">+      this.paste().catch(Cu.reportError);</span>
<a href="#l19.274"></a><span id="l19.274">       break;</span>
<a href="#l19.275"></a><span id="l19.275">     case &quot;cmd_delete&quot;:</span>
<a href="#l19.276"></a><span id="l19.276">     case &quot;placesCmd_delete&quot;:</span>
<a href="#l19.277"></a><span id="l19.277" class="difflineminus">-      this.remove(&quot;Remove Selection&quot;);</span>
<a href="#l19.278"></a><span id="l19.278" class="difflineplus">+      this.remove(&quot;Remove Selection&quot;).catch(Cu.reportError);</span>
<a href="#l19.279"></a><span id="l19.279">       break;</span>
<a href="#l19.280"></a><span id="l19.280">     case &quot;placesCmd_deleteDataHost&quot;:</span>
<a href="#l19.281"></a><span id="l19.281">       var host;</span>
<a href="#l19.282"></a><span id="l19.282">       if (PlacesUtils.nodeIsHost(this._view.selectedNode)) {</span>
<a href="#l19.283"></a><span id="l19.283">         var queries = this._view.selectedNode.getQueries();</span>
<a href="#l19.284"></a><span id="l19.284">         host = queries[0].domain;</span>
<a href="#l19.285"></a><span id="l19.285" class="difflineminus">-      }</span>
<a href="#l19.286"></a><span id="l19.286" class="difflineminus">-      else</span>
<a href="#l19.287"></a><span id="l19.287" class="difflineminus">-        host = PlacesUtils._uri(this._view.selectedNode.uri).host;</span>
<a href="#l19.288"></a><span id="l19.288" class="difflineplus">+      } else</span>
<a href="#l19.289"></a><span id="l19.289" class="difflineplus">+        host = NetUtil.newURI(this._view.selectedNode.uri).host;</span>
<a href="#l19.290"></a><span id="l19.290" class="difflineplus">+      ForgetAboutSite.removeDataFromDomain(host)</span>
<a href="#l19.291"></a><span id="l19.291" class="difflineplus">+                     .catch(Cu.reportError);</span>
<a href="#l19.292"></a><span id="l19.292">       break;</span>
<a href="#l19.293"></a><span id="l19.293">     case &quot;cmd_selectAll&quot;:</span>
<a href="#l19.294"></a><span id="l19.294">       this.selectAll();</span>
<a href="#l19.295"></a><span id="l19.295">       break;</span>
<a href="#l19.296"></a><span id="l19.296">     case &quot;placesCmd_open&quot;:</span>
<a href="#l19.297"></a><span id="l19.297" class="difflineminus">-      PlacesUIUtils.openNodeIn(this._view.selectedNode, &quot;current&quot;);</span>
<a href="#l19.298"></a><span id="l19.298" class="difflineplus">+      PlacesUIUtils.openNodeIn(this._view.selectedNode, &quot;current&quot;, this._view);</span>
<a href="#l19.299"></a><span id="l19.299" class="difflineplus">+      break;</span>
<a href="#l19.300"></a><span id="l19.300" class="difflineplus">+    case &quot;placesCmd_open:window&quot;:</span>
<a href="#l19.301"></a><span id="l19.301" class="difflineplus">+      PlacesUIUtils.openNodeIn(this._view.selectedNode, &quot;window&quot;, this._view);</span>
<a href="#l19.302"></a><span id="l19.302" class="difflineplus">+      break;</span>
<a href="#l19.303"></a><span id="l19.303" class="difflineplus">+    case &quot;placesCmd_open:privatewindow&quot;:</span>
<a href="#l19.304"></a><span id="l19.304" class="difflineplus">+      PlacesUIUtils.openNodeIn(this._view.selectedNode, &quot;window&quot;, this._view, true);</span>
<a href="#l19.305"></a><span id="l19.305">       break;</span>
<a href="#l19.306"></a><span id="l19.306">     case &quot;placesCmd_open:tab&quot;:</span>
<a href="#l19.307"></a><span id="l19.307" class="difflineminus">-      PlacesUIUtils.openNodeIn(this._view.selectedNode, &quot;tab&quot;);</span>
<a href="#l19.308"></a><span id="l19.308" class="difflineminus">-      break;</span>
<a href="#l19.309"></a><span id="l19.309" class="difflineminus">-    case &quot;placesCmd_open:window&quot;:</span>
<a href="#l19.310"></a><span id="l19.310" class="difflineminus">-      PlacesUIUtils.openNodeIn(this._view.selectedNode, &quot;window&quot;);</span>
<a href="#l19.311"></a><span id="l19.311" class="difflineminus">-      break;</span>
<a href="#l19.312"></a><span id="l19.312" class="difflineminus">-    case &quot;placesCmd_open:privatewindow&quot;:</span>
<a href="#l19.313"></a><span id="l19.313" class="difflineminus">-      PlacesUIUtils.openNodeIn(this._view.selectedNode, &quot;private&quot;);</span>
<a href="#l19.314"></a><span id="l19.314" class="difflineplus">+      PlacesUIUtils.openNodeIn(this._view.selectedNode, &quot;tab&quot;, this._view);</span>
<a href="#l19.315"></a><span id="l19.315">       break;</span>
<a href="#l19.316"></a><span id="l19.316">     case &quot;placesCmd_new:folder&quot;:</span>
<a href="#l19.317"></a><span id="l19.317">       this.newItem(&quot;folder&quot;);</span>
<a href="#l19.318"></a><span id="l19.318">       break;</span>
<a href="#l19.319"></a><span id="l19.319">     case &quot;placesCmd_new:bookmark&quot;:</span>
<a href="#l19.320"></a><span id="l19.320">       this.newItem(&quot;bookmark&quot;);</span>
<a href="#l19.321"></a><span id="l19.321">       break;</span>
<a href="#l19.322"></a><span id="l19.322" class="difflineminus">-    case &quot;placesCmd_new:livemark&quot;:</span>
<a href="#l19.323"></a><span id="l19.323" class="difflineminus">-      this.newItem(&quot;livemark&quot;);</span>
<a href="#l19.324"></a><span id="l19.324" class="difflineminus">-      break;</span>
<a href="#l19.325"></a><span id="l19.325">     case &quot;placesCmd_new:separator&quot;:</span>
<a href="#l19.326"></a><span id="l19.326" class="difflineminus">-      this.newSeparator();</span>
<a href="#l19.327"></a><span id="l19.327" class="difflineplus">+      this.newSeparator().catch(Cu.reportError);</span>
<a href="#l19.328"></a><span id="l19.328">       break;</span>
<a href="#l19.329"></a><span id="l19.329">     case &quot;placesCmd_show:info&quot;:</span>
<a href="#l19.330"></a><span id="l19.330" class="difflineminus">-      var dds = document.getElementById(&quot;detailsDeck-splitter&quot;);</span>
<a href="#l19.331"></a><span id="l19.331" class="difflineminus">-      if (dds) {</span>
<a href="#l19.332"></a><span id="l19.332" class="difflineminus">-        dds.removeAttribute(&quot;state&quot;);</span>
<a href="#l19.333"></a><span id="l19.333" class="difflineminus">-        document.getElementById(&quot;editBMPanel_namePicker&quot;).focus();</span>
<a href="#l19.334"></a><span id="l19.334" class="difflineminus">-      } else {</span>
<a href="#l19.335"></a><span id="l19.335" class="difflineminus">-        this.showBookmarkPropertiesForSelection();</span>
<a href="#l19.336"></a><span id="l19.336" class="difflineminus">-      }</span>
<a href="#l19.337"></a><span id="l19.337" class="difflineminus">-      break;</span>
<a href="#l19.338"></a><span id="l19.338" class="difflineminus">-    case &quot;placesCmd_moveBookmarks&quot;:</span>
<a href="#l19.339"></a><span id="l19.339" class="difflineminus">-      this.moveSelectedBookmarks();</span>
<a href="#l19.340"></a><span id="l19.340" class="difflineplus">+      this.showBookmarkPropertiesForSelection();</span>
<a href="#l19.341"></a><span id="l19.341">       break;</span>
<a href="#l19.342"></a><span id="l19.342">     case &quot;placesCmd_reload&quot;:</span>
<a href="#l19.343"></a><span id="l19.343">       this.reloadSelectedLivemark();</span>
<a href="#l19.344"></a><span id="l19.344">       break;</span>
<a href="#l19.345"></a><span id="l19.345">     case &quot;placesCmd_sortBy:name&quot;:</span>
<a href="#l19.346"></a><span id="l19.346" class="difflineminus">-      this.sortFolderByName();</span>
<a href="#l19.347"></a><span id="l19.347" class="difflineplus">+      this.sortFolderByName().catch(Cu.reportError);</span>
<a href="#l19.348"></a><span id="l19.348">       break;</span>
<a href="#l19.349"></a><span id="l19.349">     case &quot;placesCmd_createBookmark&quot;:</span>
<a href="#l19.350"></a><span id="l19.350" class="difflineminus">-      var node = this._view.selectedNode;</span>
<a href="#l19.351"></a><span id="l19.351" class="difflineminus">-      PlacesUIUtils.showMinimalAddBookmarkUI(PlacesUtils._uri(node.uri), node.title);</span>
<a href="#l19.352"></a><span id="l19.352" class="difflineplus">+      let node = this._view.selectedNode;</span>
<a href="#l19.353"></a><span id="l19.353" class="difflineplus">+      PlacesUIUtils.showBookmarkDialog({ action: &quot;add&quot;,</span>
<a href="#l19.354"></a><span id="l19.354" class="difflineplus">+                                         type: &quot;bookmark&quot;,</span>
<a href="#l19.355"></a><span id="l19.355" class="difflineplus">+                                         hiddenRows: [ &quot;description&quot;,</span>
<a href="#l19.356"></a><span id="l19.356" class="difflineplus">+                                                        &quot;keyword&quot;,</span>
<a href="#l19.357"></a><span id="l19.357" class="difflineplus">+                                                        &quot;location&quot;,</span>
<a href="#l19.358"></a><span id="l19.358" class="difflineplus">+                                                        &quot;loadInSidebar&quot; ],</span>
<a href="#l19.359"></a><span id="l19.359" class="difflineplus">+                                         uri: NetUtil.newURI(node.uri),</span>
<a href="#l19.360"></a><span id="l19.360" class="difflineplus">+                                         title: node.title</span>
<a href="#l19.361"></a><span id="l19.361" class="difflineplus">+                                       }, window.top);</span>
<a href="#l19.362"></a><span id="l19.362">       break;</span>
<a href="#l19.363"></a><span id="l19.363">     }</span>
<a href="#l19.364"></a><span id="l19.364">   },</span>
<a href="#l19.365"></a><span id="l19.365"> </span>
<a href="#l19.366"></a><span id="l19.366">   onEvent: function PC_onEvent(eventName) { },</span>
<a href="#l19.367"></a><span id="l19.367"> </span>
<a href="#l19.368"></a><span id="l19.368" class="difflineplus">+</span>
<a href="#l19.369"></a><span id="l19.369">   /**</span>
<a href="#l19.370"></a><span id="l19.370">    * Determine whether or not the selection can be removed, either by the</span>
<a href="#l19.371"></a><span id="l19.371">    * delete or cut operations based on whether or not any of its contents</span>
<a href="#l19.372"></a><span id="l19.372">    * are non-removable. We don't need to worry about recursion here since it</span>
<a href="#l19.373"></a><span id="l19.373">    * is a policy decision that a removable item not be placed inside a non-</span>
<a href="#l19.374"></a><span id="l19.374">    * removable item.</span>
<a href="#l19.375"></a><span id="l19.375">    *</span>
<a href="#l19.376"></a><span id="l19.376" class="difflineminus">-   * @returns true if all nodes in the selection can be removed,</span>
<a href="#l19.377"></a><span id="l19.377" class="difflineminus">-   *          false otherwise.</span>
<a href="#l19.378"></a><span id="l19.378" class="difflineplus">+   * @return true if all nodes in the selection can be removed,</span>
<a href="#l19.379"></a><span id="l19.379" class="difflineplus">+   *         false otherwise.</span>
<a href="#l19.380"></a><span id="l19.380">    */</span>
<a href="#l19.381"></a><span id="l19.381">   _hasRemovableSelection() {</span>
<a href="#l19.382"></a><span id="l19.382">     var ranges = this._view.removableSelectionRanges;</span>
<a href="#l19.383"></a><span id="l19.383">     if (!ranges.length)</span>
<a href="#l19.384"></a><span id="l19.384">       return false;</span>
<a href="#l19.385"></a><span id="l19.385"> </span>
<a href="#l19.386"></a><span id="l19.386">     var root = this._view.result.root;</span>
<a href="#l19.387"></a><span id="l19.387"> </span>
<a href="#l19.388"></a><span id="l19.388" class="difflineat">@@ -310,105 +342,85 @@ PlacesController.prototype = {</span>
<a href="#l19.389"></a><span id="l19.389">    * Determines whether or not nodes can be inserted relative to the selection.</span>
<a href="#l19.390"></a><span id="l19.390">    */</span>
<a href="#l19.391"></a><span id="l19.391">   _canInsert: function PC__canInsert(isPaste) {</span>
<a href="#l19.392"></a><span id="l19.392">     var ip = this._view.insertionPoint;</span>
<a href="#l19.393"></a><span id="l19.393">     return ip != null &amp;&amp; (isPaste || ip.isTag != true);</span>
<a href="#l19.394"></a><span id="l19.394">   },</span>
<a href="#l19.395"></a><span id="l19.395"> </span>
<a href="#l19.396"></a><span id="l19.396">   /**</span>
<a href="#l19.397"></a><span id="l19.397" class="difflineminus">-   * Determines whether or not the root node for the view is selected</span>
<a href="#l19.398"></a><span id="l19.398" class="difflineminus">-   */</span>
<a href="#l19.399"></a><span id="l19.399" class="difflineminus">-  rootNodeIsSelected: function PC_rootNodeIsSelected() {</span>
<a href="#l19.400"></a><span id="l19.400" class="difflineminus">-    var nodes = this._view.selectedNodes;</span>
<a href="#l19.401"></a><span id="l19.401" class="difflineminus">-    var root = this._view.result.root;</span>
<a href="#l19.402"></a><span id="l19.402" class="difflineminus">-    for (var i = 0; i &lt; nodes.length; ++i) {</span>
<a href="#l19.403"></a><span id="l19.403" class="difflineminus">-      if (nodes[i] == root)</span>
<a href="#l19.404"></a><span id="l19.404" class="difflineminus">-        return true;</span>
<a href="#l19.405"></a><span id="l19.405" class="difflineminus">-    }</span>
<a href="#l19.406"></a><span id="l19.406" class="difflineminus">-</span>
<a href="#l19.407"></a><span id="l19.407" class="difflineminus">-    return false;</span>
<a href="#l19.408"></a><span id="l19.408" class="difflineminus">-  },</span>
<a href="#l19.409"></a><span id="l19.409" class="difflineminus">-</span>
<a href="#l19.410"></a><span id="l19.410" class="difflineminus">-  /**</span>
<a href="#l19.411"></a><span id="l19.411">    * Looks at the data on the clipboard to see if it is paste-able.</span>
<a href="#l19.412"></a><span id="l19.412">    * Paste-able data is:</span>
<a href="#l19.413"></a><span id="l19.413">    *   - in a format that the view can receive</span>
<a href="#l19.414"></a><span id="l19.414" class="difflineminus">-   * @returns true if: - clipboard data is of a TYPE_X_MOZ_PLACE_* flavor,</span>
<a href="#l19.415"></a><span id="l19.415" class="difflineminus">-                       - clipboard data is of type TEXT_UNICODE and</span>
<a href="#l19.416"></a><span id="l19.416" class="difflineminus">-                         is a valid URI.</span>
<a href="#l19.417"></a><span id="l19.417" class="difflineplus">+   * @return true if: - clipboard data is of a TYPE_X_MOZ_PLACE_* flavor,</span>
<a href="#l19.418"></a><span id="l19.418" class="difflineplus">+   *                  - clipboard data is of type TEXT_UNICODE and</span>
<a href="#l19.419"></a><span id="l19.419" class="difflineplus">+   *                    is a valid URI.</span>
<a href="#l19.420"></a><span id="l19.420">    */</span>
<a href="#l19.421"></a><span id="l19.421">   _isClipboardDataPasteable: function PC__isClipboardDataPasteable() {</span>
<a href="#l19.422"></a><span id="l19.422">     // if the clipboard contains TYPE_X_MOZ_PLACE_* data, it is definitely</span>
<a href="#l19.423"></a><span id="l19.423">     // pasteable, with no need to unwrap all the nodes.</span>
<a href="#l19.424"></a><span id="l19.424"> </span>
<a href="#l19.425"></a><span id="l19.425" class="difflineminus">-    var flavors = PlacesControllerDragHelper.placesFlavors;</span>
<a href="#l19.426"></a><span id="l19.426" class="difflineplus">+    var flavors = PlacesUIUtils.PLACES_FLAVORS;</span>
<a href="#l19.427"></a><span id="l19.427">     var clipboard = this.clipboard;</span>
<a href="#l19.428"></a><span id="l19.428">     var hasPlacesData =</span>
<a href="#l19.429"></a><span id="l19.429">       clipboard.hasDataMatchingFlavors(flavors, flavors.length,</span>
<a href="#l19.430"></a><span id="l19.430">                                        Ci.nsIClipboard.kGlobalClipboard);</span>
<a href="#l19.431"></a><span id="l19.431">     if (hasPlacesData)</span>
<a href="#l19.432"></a><span id="l19.432">       return this._view.insertionPoint != null;</span>
<a href="#l19.433"></a><span id="l19.433"> </span>
<a href="#l19.434"></a><span id="l19.434">     // if the clipboard doesn't have TYPE_X_MOZ_PLACE_* data, we also allow</span>
<a href="#l19.435"></a><span id="l19.435">     // pasting of valid &quot;text/unicode&quot; and &quot;text/x-moz-url&quot; data</span>
<a href="#l19.436"></a><span id="l19.436">     var xferable = Cc[&quot;@mozilla.org/widget/transferable;1&quot;]</span>
<a href="#l19.437"></a><span id="l19.437">                      .createInstance(Ci.nsITransferable);</span>
<a href="#l19.438"></a><span id="l19.438" class="difflineplus">+    xferable.init(null);</span>
<a href="#l19.439"></a><span id="l19.439"> </span>
<a href="#l19.440"></a><span id="l19.440" class="difflineminus">-    xferable.init(null);</span>
<a href="#l19.441"></a><span id="l19.441">     xferable.addDataFlavor(PlacesUtils.TYPE_X_MOZ_URL);</span>
<a href="#l19.442"></a><span id="l19.442">     xferable.addDataFlavor(PlacesUtils.TYPE_UNICODE);</span>
<a href="#l19.443"></a><span id="l19.443">     clipboard.getData(xferable, Ci.nsIClipboard.kGlobalClipboard);</span>
<a href="#l19.444"></a><span id="l19.444"> </span>
<a href="#l19.445"></a><span id="l19.445">     try {</span>
<a href="#l19.446"></a><span id="l19.446">       // getAnyTransferData will throw if no data is available.</span>
<a href="#l19.447"></a><span id="l19.447">       var data = { }, type = { };</span>
<a href="#l19.448"></a><span id="l19.448">       xferable.getAnyTransferData(type, data, { });</span>
<a href="#l19.449"></a><span id="l19.449">       data = data.value.QueryInterface(Ci.nsISupportsString).data;</span>
<a href="#l19.450"></a><span id="l19.450">       if (type.value != PlacesUtils.TYPE_X_MOZ_URL &amp;&amp;</span>
<a href="#l19.451"></a><span id="l19.451">           type.value != PlacesUtils.TYPE_UNICODE)</span>
<a href="#l19.452"></a><span id="l19.452">         return false;</span>
<a href="#l19.453"></a><span id="l19.453"> </span>
<a href="#l19.454"></a><span id="l19.454">       // unwrapNodes() will throw if the data blob is malformed.</span>
<a href="#l19.455"></a><span id="l19.455" class="difflineminus">-      var unwrappedNodes = PlacesUtils.unwrapNodes(data, type.value);</span>
<a href="#l19.456"></a><span id="l19.456" class="difflineplus">+      PlacesUtils.unwrapNodes(data, type.value);</span>
<a href="#l19.457"></a><span id="l19.457">       return this._view.insertionPoint != null;</span>
<a href="#l19.458"></a><span id="l19.458" class="difflineminus">-    }</span>
<a href="#l19.459"></a><span id="l19.459" class="difflineminus">-    catch (e) {</span>
<a href="#l19.460"></a><span id="l19.460" class="difflineplus">+    } catch (e) {</span>
<a href="#l19.461"></a><span id="l19.461">       // getAnyTransferData or unwrapNodes failed</span>
<a href="#l19.462"></a><span id="l19.462">       return false;</span>
<a href="#l19.463"></a><span id="l19.463">     }</span>
<a href="#l19.464"></a><span id="l19.464">   },</span>
<a href="#l19.465"></a><span id="l19.465"> </span>
<a href="#l19.466"></a><span id="l19.466">   /**</span>
<a href="#l19.467"></a><span id="l19.467">    * Gathers information about the selected nodes according to the following</span>
<a href="#l19.468"></a><span id="l19.468">    * rules:</span>
<a href="#l19.469"></a><span id="l19.469">    *    &quot;link&quot;              node is a URI</span>
<a href="#l19.470"></a><span id="l19.470" class="difflineminus">-   *    &quot;bookmark&quot;          node is a bookamrk</span>
<a href="#l19.471"></a><span id="l19.471" class="difflineplus">+   *    &quot;bookmark&quot;          node is a bookmark</span>
<a href="#l19.472"></a><span id="l19.472">    *    &quot;livemarkChild&quot;     node is a child of a livemark</span>
<a href="#l19.473"></a><span id="l19.473">    *    &quot;tagChild&quot;          node is a child of a tag</span>
<a href="#l19.474"></a><span id="l19.474">    *    &quot;folder&quot;            node is a folder</span>
<a href="#l19.475"></a><span id="l19.475">    *    &quot;query&quot;             node is a query</span>
<a href="#l19.476"></a><span id="l19.476">    *    &quot;separator&quot;         node is a separator line</span>
<a href="#l19.477"></a><span id="l19.477">    *    &quot;host&quot;              node is a host</span>
<a href="#l19.478"></a><span id="l19.478">    *</span>
<a href="#l19.479"></a><span id="l19.479" class="difflineminus">-   * @returns an array of objects corresponding the selected nodes. Each</span>
<a href="#l19.480"></a><span id="l19.480" class="difflineminus">-   *          object has each of the properties above set if its corresponding</span>
<a href="#l19.481"></a><span id="l19.481" class="difflineminus">-   *          node matches the rule. In addition, the annotations names for each</span>
<a href="#l19.482"></a><span id="l19.482" class="difflineminus">-   *          node are set on its corresponding object as properties.</span>
<a href="#l19.483"></a><span id="l19.483" class="difflineplus">+   * @return an array of objects corresponding the selected nodes. Each</span>
<a href="#l19.484"></a><span id="l19.484" class="difflineplus">+   *         object has each of the properties above set if its corresponding</span>
<a href="#l19.485"></a><span id="l19.485" class="difflineplus">+   *         node matches the rule. In addition, the annotations names for each</span>
<a href="#l19.486"></a><span id="l19.486" class="difflineplus">+   *         node are set on its corresponding object as properties.</span>
<a href="#l19.487"></a><span id="l19.487">    * Notes:</span>
<a href="#l19.488"></a><span id="l19.488">    *   1) This can be slow, so don't call it anywhere performance critical!</span>
<a href="#l19.489"></a><span id="l19.489" class="difflineminus">-   *   2) A single-object array corresponding the root node is returned if</span>
<a href="#l19.490"></a><span id="l19.490" class="difflineminus">-   *      there's no selection.</span>
<a href="#l19.491"></a><span id="l19.491">    */</span>
<a href="#l19.492"></a><span id="l19.492">   _buildSelectionMetadata: function PC__buildSelectionMetadata() {</span>
<a href="#l19.493"></a><span id="l19.493">     var metadata = [];</span>
<a href="#l19.494"></a><span id="l19.494" class="difflineminus">-    var root = this._view.result.root;</span>
<a href="#l19.495"></a><span id="l19.495">     var nodes = this._view.selectedNodes;</span>
<a href="#l19.496"></a><span id="l19.496" class="difflineminus">-    if (nodes.length == 0)</span>
<a href="#l19.497"></a><span id="l19.497" class="difflineminus">-      nodes.push(root); // See the second note above</span>
<a href="#l19.498"></a><span id="l19.498"> </span>
<a href="#l19.499"></a><span id="l19.499">     for (var i = 0; i &lt; nodes.length; i++) {</span>
<a href="#l19.500"></a><span id="l19.500">       var nodeData = {};</span>
<a href="#l19.501"></a><span id="l19.501">       var node = nodes[i];</span>
<a href="#l19.502"></a><span id="l19.502">       var nodeType = node.type;</span>
<a href="#l19.503"></a><span id="l19.503">       var uri = null;</span>
<a href="#l19.504"></a><span id="l19.504"> </span>
<a href="#l19.505"></a><span id="l19.505">       // We don't use the nodeIs* methods here to avoid going through the type</span>
<a href="#l19.506"></a><span id="l19.506" class="difflineat">@@ -432,21 +444,19 @@ PlacesController.prototype = {</span>
<a href="#l19.507"></a><span id="l19.507">         case Ci.nsINavHistoryResultNode.RESULT_TYPE_FOLDER_SHORTCUT:</span>
<a href="#l19.508"></a><span id="l19.508">           nodeData[&quot;folder&quot;] = true;</span>
<a href="#l19.509"></a><span id="l19.509">           break;</span>
<a href="#l19.510"></a><span id="l19.510">         case Ci.nsINavHistoryResultNode.RESULT_TYPE_SEPARATOR:</span>
<a href="#l19.511"></a><span id="l19.511">           nodeData[&quot;separator&quot;] = true;</span>
<a href="#l19.512"></a><span id="l19.512">           break;</span>
<a href="#l19.513"></a><span id="l19.513">         case Ci.nsINavHistoryResultNode.RESULT_TYPE_URI:</span>
<a href="#l19.514"></a><span id="l19.514">           nodeData[&quot;link&quot;] = true;</span>
<a href="#l19.515"></a><span id="l19.515" class="difflineminus">-          uri = PlacesUtils._uri(node.uri);</span>
<a href="#l19.516"></a><span id="l19.516" class="difflineplus">+          uri = NetUtil.newURI(node.uri);</span>
<a href="#l19.517"></a><span id="l19.517">           if (PlacesUtils.nodeIsBookmark(node)) {</span>
<a href="#l19.518"></a><span id="l19.518">             nodeData[&quot;bookmark&quot;] = true;</span>
<a href="#l19.519"></a><span id="l19.519" class="difflineminus">-            PlacesUtils.nodeIsTagQuery(node.parent)</span>
<a href="#l19.520"></a><span id="l19.520" class="difflineminus">-</span>
<a href="#l19.521"></a><span id="l19.521">             var parentNode = node.parent;</span>
<a href="#l19.522"></a><span id="l19.522">             if (parentNode) {</span>
<a href="#l19.523"></a><span id="l19.523">               if (PlacesUtils.nodeIsTagQuery(parentNode))</span>
<a href="#l19.524"></a><span id="l19.524">                 nodeData[&quot;tagChild&quot;] = true;</span>
<a href="#l19.525"></a><span id="l19.525">               else if (this.hasCachedLivemarkInfo(parentNode))</span>
<a href="#l19.526"></a><span id="l19.526">                 nodeData[&quot;livemarkChild&quot;] = true;</span>
<a href="#l19.527"></a><span id="l19.527">             }</span>
<a href="#l19.528"></a><span id="l19.528">           }</span>
<a href="#l19.529"></a><span id="l19.529" class="difflineat">@@ -474,376 +484,348 @@ PlacesController.prototype = {</span>
<a href="#l19.530"></a><span id="l19.530">   },</span>
<a href="#l19.531"></a><span id="l19.531"> </span>
<a href="#l19.532"></a><span id="l19.532">   /**</span>
<a href="#l19.533"></a><span id="l19.533">    * Determines if a context-menu item should be shown</span>
<a href="#l19.534"></a><span id="l19.534">    * @param   aMenuItem</span>
<a href="#l19.535"></a><span id="l19.535">    *          the context menu item</span>
<a href="#l19.536"></a><span id="l19.536">    * @param   aMetaData</span>
<a href="#l19.537"></a><span id="l19.537">    *          meta data about the selection</span>
<a href="#l19.538"></a><span id="l19.538" class="difflineminus">-   * @returns true if the conditions (see buildContextMenu) are satisfied</span>
<a href="#l19.539"></a><span id="l19.539" class="difflineminus">-   *          and the item can be displayed, false otherwise.</span>
<a href="#l19.540"></a><span id="l19.540" class="difflineplus">+   * @return true if the conditions (see buildContextMenu) are satisfied</span>
<a href="#l19.541"></a><span id="l19.541" class="difflineplus">+   *         and the item can be displayed, false otherwise.</span>
<a href="#l19.542"></a><span id="l19.542">    */</span>
<a href="#l19.543"></a><span id="l19.543">   _shouldShowMenuItem: function PC__shouldShowMenuItem(aMenuItem, aMetaData) {</span>
<a href="#l19.544"></a><span id="l19.544">     var selectiontype = aMenuItem.getAttribute(&quot;selectiontype&quot;);</span>
<a href="#l19.545"></a><span id="l19.545" class="difflineminus">-    if (selectiontype == &quot;multiple&quot; &amp;&amp; aMetaData.length == 1)</span>
<a href="#l19.546"></a><span id="l19.546" class="difflineplus">+    if (!selectiontype) {</span>
<a href="#l19.547"></a><span id="l19.547" class="difflineplus">+      selectiontype = &quot;single|multiple&quot;;</span>
<a href="#l19.548"></a><span id="l19.548" class="difflineplus">+    }</span>
<a href="#l19.549"></a><span id="l19.549" class="difflineplus">+    var selectionTypes = selectiontype.split(&quot;|&quot;);</span>
<a href="#l19.550"></a><span id="l19.550" class="difflineplus">+    if (selectionTypes.includes(&quot;any&quot;)) {</span>
<a href="#l19.551"></a><span id="l19.551" class="difflineplus">+      return true;</span>
<a href="#l19.552"></a><span id="l19.552" class="difflineplus">+    }</span>
<a href="#l19.553"></a><span id="l19.553" class="difflineplus">+    var count = aMetaData.length;</span>
<a href="#l19.554"></a><span id="l19.554" class="difflineplus">+    if (count &gt; 1 &amp;&amp; !selectionTypes.includes(&quot;multiple&quot;))</span>
<a href="#l19.555"></a><span id="l19.555">       return false;</span>
<a href="#l19.556"></a><span id="l19.556" class="difflineminus">-    if (selectiontype == &quot;single&quot; &amp;&amp; aMetaData.length != 1)</span>
<a href="#l19.557"></a><span id="l19.557" class="difflineplus">+    if (count == 1 &amp;&amp; !selectionTypes.includes(&quot;single&quot;))</span>
<a href="#l19.558"></a><span id="l19.558">       return false;</span>
<a href="#l19.559"></a><span id="l19.559" class="difflineplus">+    // NB: if there is no selection, we show the item if and only if</span>
<a href="#l19.560"></a><span id="l19.560" class="difflineplus">+    // the selectiontype includes 'none' - the metadata list will be</span>
<a href="#l19.561"></a><span id="l19.561" class="difflineplus">+    // empty so none of the other criteria will apply anyway.</span>
<a href="#l19.562"></a><span id="l19.562" class="difflineplus">+    if (count == 0)</span>
<a href="#l19.563"></a><span id="l19.563" class="difflineplus">+      return selectionTypes.includes(&quot;none&quot;);</span>
<a href="#l19.564"></a><span id="l19.564"> </span>
<a href="#l19.565"></a><span id="l19.565">     var forceHideAttr = aMenuItem.getAttribute(&quot;forcehideselection&quot;);</span>
<a href="#l19.566"></a><span id="l19.566">     if (forceHideAttr) {</span>
<a href="#l19.567"></a><span id="l19.567">       var forceHideRules = forceHideAttr.split(&quot;|&quot;);</span>
<a href="#l19.568"></a><span id="l19.568">       for (let i = 0; i &lt; aMetaData.length; ++i) {</span>
<a href="#l19.569"></a><span id="l19.569">         for (let j = 0; j &lt; forceHideRules.length; ++j) {</span>
<a href="#l19.570"></a><span id="l19.570">           if (forceHideRules[j] in aMetaData[i])</span>
<a href="#l19.571"></a><span id="l19.571">             return false;</span>
<a href="#l19.572"></a><span id="l19.572">         }</span>
<a href="#l19.573"></a><span id="l19.573">       }</span>
<a href="#l19.574"></a><span id="l19.574">     }</span>
<a href="#l19.575"></a><span id="l19.575"> </span>
<a href="#l19.576"></a><span id="l19.576">     var selectionAttr = aMenuItem.getAttribute(&quot;selection&quot;);</span>
<a href="#l19.577"></a><span id="l19.577" class="difflineminus">-    if (selectionAttr) {</span>
<a href="#l19.578"></a><span id="l19.578" class="difflineminus">-      if (selectionAttr == &quot;any&quot;)</span>
<a href="#l19.579"></a><span id="l19.579" class="difflineminus">-        return true;</span>
<a href="#l19.580"></a><span id="l19.580" class="difflineminus">-</span>
<a href="#l19.581"></a><span id="l19.581" class="difflineminus">-      var showRules = selectionAttr.split(&quot;|&quot;);</span>
<a href="#l19.582"></a><span id="l19.582" class="difflineminus">-      var anyMatched = false;</span>
<a href="#l19.583"></a><span id="l19.583" class="difflineminus">-      function metaDataNodeMatches(metaDataNode, rules) {</span>
<a href="#l19.584"></a><span id="l19.584" class="difflineminus">-        for (var i=0; i &lt; rules.length; i++) {</span>
<a href="#l19.585"></a><span id="l19.585" class="difflineminus">-          if (rules[i] in metaDataNode)</span>
<a href="#l19.586"></a><span id="l19.586" class="difflineminus">-            return true;</span>
<a href="#l19.587"></a><span id="l19.587" class="difflineminus">-        }</span>
<a href="#l19.588"></a><span id="l19.588" class="difflineminus">-</span>
<a href="#l19.589"></a><span id="l19.589" class="difflineminus">-        return false;</span>
<a href="#l19.590"></a><span id="l19.590" class="difflineminus">-      }</span>
<a href="#l19.591"></a><span id="l19.591" class="difflineminus">-      for (var i = 0; i &lt; aMetaData.length; ++i) {</span>
<a href="#l19.592"></a><span id="l19.592" class="difflineminus">-        if (metaDataNodeMatches(aMetaData[i], showRules))</span>
<a href="#l19.593"></a><span id="l19.593" class="difflineminus">-          anyMatched = true;</span>
<a href="#l19.594"></a><span id="l19.594" class="difflineminus">-        else</span>
<a href="#l19.595"></a><span id="l19.595" class="difflineminus">-          return false;</span>
<a href="#l19.596"></a><span id="l19.596" class="difflineminus">-      }</span>
<a href="#l19.597"></a><span id="l19.597" class="difflineminus">-      return anyMatched;</span>
<a href="#l19.598"></a><span id="l19.598" class="difflineplus">+    if (!selectionAttr) {</span>
<a href="#l19.599"></a><span id="l19.599" class="difflineplus">+      return !aMenuItem.hidden;</span>
<a href="#l19.600"></a><span id="l19.600">     }</span>
<a href="#l19.601"></a><span id="l19.601"> </span>
<a href="#l19.602"></a><span id="l19.602" class="difflineminus">-    return !aMenuItem.hidden;</span>
<a href="#l19.603"></a><span id="l19.603" class="difflineplus">+    if (selectionAttr == &quot;any&quot;)</span>
<a href="#l19.604"></a><span id="l19.604" class="difflineplus">+      return true;</span>
<a href="#l19.605"></a><span id="l19.605" class="difflineplus">+</span>
<a href="#l19.606"></a><span id="l19.606" class="difflineplus">+    var showRules = selectionAttr.split(&quot;|&quot;);</span>
<a href="#l19.607"></a><span id="l19.607" class="difflineplus">+    var anyMatched = false;</span>
<a href="#l19.608"></a><span id="l19.608" class="difflineplus">+    function metaDataNodeMatches(metaDataNode, rules) {</span>
<a href="#l19.609"></a><span id="l19.609" class="difflineplus">+      for (var i = 0; i &lt; rules.length; i++) {</span>
<a href="#l19.610"></a><span id="l19.610" class="difflineplus">+        if (rules[i] in metaDataNode)</span>
<a href="#l19.611"></a><span id="l19.611" class="difflineplus">+          return true;</span>
<a href="#l19.612"></a><span id="l19.612" class="difflineplus">+      }</span>
<a href="#l19.613"></a><span id="l19.613" class="difflineplus">+      return false;</span>
<a href="#l19.614"></a><span id="l19.614" class="difflineplus">+    }</span>
<a href="#l19.615"></a><span id="l19.615" class="difflineplus">+</span>
<a href="#l19.616"></a><span id="l19.616" class="difflineplus">+    for (var i = 0; i &lt; aMetaData.length; ++i) {</span>
<a href="#l19.617"></a><span id="l19.617" class="difflineplus">+      if (metaDataNodeMatches(aMetaData[i], showRules))</span>
<a href="#l19.618"></a><span id="l19.618" class="difflineplus">+        anyMatched = true;</span>
<a href="#l19.619"></a><span id="l19.619" class="difflineplus">+      else</span>
<a href="#l19.620"></a><span id="l19.620" class="difflineplus">+        return false;</span>
<a href="#l19.621"></a><span id="l19.621" class="difflineplus">+    }</span>
<a href="#l19.622"></a><span id="l19.622" class="difflineplus">+    return anyMatched;</span>
<a href="#l19.623"></a><span id="l19.623">   },</span>
<a href="#l19.624"></a><span id="l19.624"> </span>
<a href="#l19.625"></a><span id="l19.625">   /**</span>
<a href="#l19.626"></a><span id="l19.626">    * Detects information (meta-data rules) about the current selection in the</span>
<a href="#l19.627"></a><span id="l19.627">    * view (see _buildSelectionMetadata) and sets the visibility state for each</span>
<a href="#l19.628"></a><span id="l19.628">    * of the menu-items in the given popup with the following rules applied:</span>
<a href="#l19.629"></a><span id="l19.629" class="difflineplus">+   *  0) The &quot;ignoreitem&quot; attribute may be set to &quot;true&quot; for this code not to</span>
<a href="#l19.630"></a><span id="l19.630" class="difflineplus">+   *     handle that menuitem.</span>
<a href="#l19.631"></a><span id="l19.631">    *  1) The &quot;selectiontype&quot; attribute may be set on a menu-item to &quot;single&quot;</span>
<a href="#l19.632"></a><span id="l19.632">    *     if the menu-item should be visible only if there is a single node</span>
<a href="#l19.633"></a><span id="l19.633">    *     selected, or to &quot;multiple&quot; if the menu-item should be visible only if</span>
<a href="#l19.634"></a><span id="l19.634" class="difflineminus">-   *     multiple nodes are selected. If the attribute is not set or if it is</span>
<a href="#l19.635"></a><span id="l19.635" class="difflineminus">-   *     set to an invalid value, the menu-item may be visible for both types of</span>
<a href="#l19.636"></a><span id="l19.636" class="difflineminus">-   *     selection.</span>
<a href="#l19.637"></a><span id="l19.637" class="difflineplus">+   *     multiple nodes are selected, or to &quot;none&quot; if the menuitems should be</span>
<a href="#l19.638"></a><span id="l19.638" class="difflineplus">+   *     visible for if there are no selected nodes, or to a |-separated</span>
<a href="#l19.639"></a><span id="l19.639" class="difflineplus">+   *     combination of these.</span>
<a href="#l19.640"></a><span id="l19.640" class="difflineplus">+   *     If the attribute is not set or set to an invalid value, the menu-item</span>
<a href="#l19.641"></a><span id="l19.641" class="difflineplus">+   *     may be visible irrespective of the selection.</span>
<a href="#l19.642"></a><span id="l19.642">    *  2) The &quot;selection&quot; attribute may be set on a menu-item to the various</span>
<a href="#l19.643"></a><span id="l19.643">    *     meta-data rules for which it may be visible. The rules should be</span>
<a href="#l19.644"></a><span id="l19.644">    *     separated with the | character.</span>
<a href="#l19.645"></a><span id="l19.645">    *  3) A menu-item may be visible only if at least one of the rules set in</span>
<a href="#l19.646"></a><span id="l19.646">    *     its selection attribute apply to each of the selected nodes in the</span>
<a href="#l19.647"></a><span id="l19.647">    *     view.</span>
<a href="#l19.648"></a><span id="l19.648">    *  4) The &quot;forcehideselection&quot; attribute may be set on a menu-item to rules</span>
<a href="#l19.649"></a><span id="l19.649">    *     for which it should be hidden. This attribute takes priority over the</span>
<a href="#l19.650"></a><span id="l19.650">    *     selection attribute. A menu-item would be hidden if at least one of the</span>
<a href="#l19.651"></a><span id="l19.651">    *     given rules apply to one of the selected nodes. The rules should be</span>
<a href="#l19.652"></a><span id="l19.652">    *     separated with the | character.</span>
<a href="#l19.653"></a><span id="l19.653">    *  5) The &quot;hideifnoinsertionpoint&quot; attribute may be set on a menu-item to</span>
<a href="#l19.654"></a><span id="l19.654">    *     true if it should be hidden when there's no insertion point</span>
<a href="#l19.655"></a><span id="l19.655" class="difflineminus">-   *  6) The &quot;hideifprivatebrowsing&quot; attribute may be set on a menu-item to</span>
<a href="#l19.656"></a><span id="l19.656" class="difflineminus">-   *     true if it should be hidden in a private window</span>
<a href="#l19.657"></a><span id="l19.657" class="difflineminus">-   *  7) The visibility state of a menu-item is unchanged if none of these</span>
<a href="#l19.658"></a><span id="l19.658" class="difflineplus">+   *  6) The visibility state of a menu-item is unchanged if none of these</span>
<a href="#l19.659"></a><span id="l19.659">    *     attribute are set.</span>
<a href="#l19.660"></a><span id="l19.660" class="difflineminus">-   *  8) These attributes should not be set on separators for which the</span>
<a href="#l19.661"></a><span id="l19.661" class="difflineplus">+   *  7) These attributes should not be set on separators for which the</span>
<a href="#l19.662"></a><span id="l19.662">    *     visibility state is &quot;auto-detected.&quot;</span>
<a href="#l19.663"></a><span id="l19.663" class="difflineplus">+   *  8) The &quot;hideifprivatebrowsing&quot; attribute may be set on a menu-item to</span>
<a href="#l19.664"></a><span id="l19.664" class="difflineplus">+   *     true if it should be hidden inside the private browsing mode</span>
<a href="#l19.665"></a><span id="l19.665">    * @param   aPopup</span>
<a href="#l19.666"></a><span id="l19.666">    *          The menupopup to build children into.</span>
<a href="#l19.667"></a><span id="l19.667">    * @return true if at least one item is visible, false otherwise.</span>
<a href="#l19.668"></a><span id="l19.668">    */</span>
<a href="#l19.669"></a><span id="l19.669">   buildContextMenu: function PC_buildContextMenu(aPopup) {</span>
<a href="#l19.670"></a><span id="l19.670">     var metadata = this._buildSelectionMetadata();</span>
<a href="#l19.671"></a><span id="l19.671">     var ip = this._view.insertionPoint;</span>
<a href="#l19.672"></a><span id="l19.672">     var noIp = !ip || ip.isTag;</span>
<a href="#l19.673"></a><span id="l19.673"> </span>
<a href="#l19.674"></a><span id="l19.674">     var separator = null;</span>
<a href="#l19.675"></a><span id="l19.675">     var visibleItemsBeforeSep = false;</span>
<a href="#l19.676"></a><span id="l19.676" class="difflineminus">-    var anyVisible = false;</span>
<a href="#l19.677"></a><span id="l19.677" class="difflineplus">+    var usableItemCount = 0;</span>
<a href="#l19.678"></a><span id="l19.678">     for (var i = 0; i &lt; aPopup.childNodes.length; ++i) {</span>
<a href="#l19.679"></a><span id="l19.679">       var item = aPopup.childNodes[i];</span>
<a href="#l19.680"></a><span id="l19.680" class="difflineplus">+      if (item.getAttribute(&quot;ignoreitem&quot;) == &quot;true&quot;) {</span>
<a href="#l19.681"></a><span id="l19.681" class="difflineplus">+        continue;</span>
<a href="#l19.682"></a><span id="l19.682" class="difflineplus">+      }</span>
<a href="#l19.683"></a><span id="l19.683">       if (item.localName != &quot;menuseparator&quot;) {</span>
<a href="#l19.684"></a><span id="l19.684">         // We allow pasting into tag containers, so special case that.</span>
<a href="#l19.685"></a><span id="l19.685" class="difflineminus">-        var hideIfNoIP = item.hasAttribute(&quot;hideifnoinsertionpoint&quot;) &amp;&amp;</span>
<a href="#l19.686"></a><span id="l19.686" class="difflineplus">+        var hideIfNoIP = item.getAttribute(&quot;hideifnoinsertionpoint&quot;) == &quot;true&quot; &amp;&amp;</span>
<a href="#l19.687"></a><span id="l19.687">                          noIp &amp;&amp; !(ip &amp;&amp; ip.isTag &amp;&amp; item.id == &quot;placesContext_paste&quot;);</span>
<a href="#l19.688"></a><span id="l19.688" class="difflineminus">-        var hideIfPrivate = item.hasAttribute(&quot;hideifprivatebrowsing&quot;) &amp;&amp; top.gPrivate;</span>
<a href="#l19.689"></a><span id="l19.689" class="difflineminus">-        item.hidden = hideIfNoIP || hideIfPrivate ||</span>
<a href="#l19.690"></a><span id="l19.690" class="difflineminus">-                      !this._shouldShowMenuItem(item, metadata);</span>
<a href="#l19.691"></a><span id="l19.691" class="difflineplus">+        var hideIfPrivate = item.getAttribute(&quot;hideifprivatebrowsing&quot;) == &quot;true&quot; &amp;&amp;</span>
<a href="#l19.692"></a><span id="l19.692" class="difflineplus">+                            PrivateBrowsingUtils.isWindowPrivate(window);</span>
<a href="#l19.693"></a><span id="l19.693" class="difflineplus">+        var shouldHideItem = hideIfNoIP || hideIfPrivate ||</span>
<a href="#l19.694"></a><span id="l19.694" class="difflineplus">+                             !this._shouldShowMenuItem(item, metadata);</span>
<a href="#l19.695"></a><span id="l19.695" class="difflineplus">+        item.hidden = item.disabled = shouldHideItem;</span>
<a href="#l19.696"></a><span id="l19.696"> </span>
<a href="#l19.697"></a><span id="l19.697">         if (!item.hidden) {</span>
<a href="#l19.698"></a><span id="l19.698">           visibleItemsBeforeSep = true;</span>
<a href="#l19.699"></a><span id="l19.699" class="difflineminus">-          anyVisible = true;</span>
<a href="#l19.700"></a><span id="l19.700" class="difflineplus">+          usableItemCount++;</span>
<a href="#l19.701"></a><span id="l19.701"> </span>
<a href="#l19.702"></a><span id="l19.702">           // Show the separator above the menu-item if any</span>
<a href="#l19.703"></a><span id="l19.703">           if (separator) {</span>
<a href="#l19.704"></a><span id="l19.704">             separator.hidden = false;</span>
<a href="#l19.705"></a><span id="l19.705">             separator = null;</span>
<a href="#l19.706"></a><span id="l19.706">           }</span>
<a href="#l19.707"></a><span id="l19.707">         }</span>
<a href="#l19.708"></a><span id="l19.708" class="difflineminus">-      }</span>
<a href="#l19.709"></a><span id="l19.709" class="difflineminus">-      else { // menuseparator</span>
<a href="#l19.710"></a><span id="l19.710" class="difflineplus">+      } else { // menuseparator</span>
<a href="#l19.711"></a><span id="l19.711">         // Initially hide it. It will be unhidden if there will be at least one</span>
<a href="#l19.712"></a><span id="l19.712">         // visible menu-item above and below it.</span>
<a href="#l19.713"></a><span id="l19.713">         item.hidden = true;</span>
<a href="#l19.714"></a><span id="l19.714"> </span>
<a href="#l19.715"></a><span id="l19.715">         // We won't show the separator at all if no items are visible above it</span>
<a href="#l19.716"></a><span id="l19.716">         if (visibleItemsBeforeSep)</span>
<a href="#l19.717"></a><span id="l19.717">           separator = item;</span>
<a href="#l19.718"></a><span id="l19.718"> </span>
<a href="#l19.719"></a><span id="l19.719">         // New separator, count again:</span>
<a href="#l19.720"></a><span id="l19.720">         visibleItemsBeforeSep = false;</span>
<a href="#l19.721"></a><span id="l19.721">       }</span>
<a href="#l19.722"></a><span id="l19.722">     }</span>
<a href="#l19.723"></a><span id="l19.723"> </span>
<a href="#l19.724"></a><span id="l19.724">     // Set Open Folder/Links In Tabs items enabled state if they're visible</span>
<a href="#l19.725"></a><span id="l19.725" class="difflineminus">-    if (anyVisible) {</span>
<a href="#l19.726"></a><span id="l19.726" class="difflineplus">+    if (usableItemCount &gt; 0) {</span>
<a href="#l19.727"></a><span id="l19.727">       var openContainerInTabsItem = document.getElementById(&quot;placesContext_openContainer:tabs&quot;);</span>
<a href="#l19.728"></a><span id="l19.728" class="difflineminus">-      if (!openContainerInTabsItem.hidden &amp;&amp; this._view.selectedNode &amp;&amp;</span>
<a href="#l19.729"></a><span id="l19.729" class="difflineminus">-          PlacesUtils.nodeIsContainer(this._view.selectedNode)) {</span>
<a href="#l19.730"></a><span id="l19.730" class="difflineminus">-        openContainerInTabsItem.disabled =</span>
<a href="#l19.731"></a><span id="l19.731" class="difflineminus">-          !PlacesUtils.hasChildURIs(this._view.selectedNode);</span>
<a href="#l19.732"></a><span id="l19.732" class="difflineminus">-      }</span>
<a href="#l19.733"></a><span id="l19.733" class="difflineminus">-      else {</span>
<a href="#l19.734"></a><span id="l19.734" class="difflineminus">-        // see selectiontype rule in the overlay</span>
<a href="#l19.735"></a><span id="l19.735" class="difflineminus">-        var openLinksInTabsItem = document.getElementById(&quot;placesContext_openLinks:tabs&quot;);</span>
<a href="#l19.736"></a><span id="l19.736" class="difflineminus">-        openLinksInTabsItem.disabled = openLinksInTabsItem.hidden;</span>
<a href="#l19.737"></a><span id="l19.737" class="difflineplus">+      if (!openContainerInTabsItem.hidden) {</span>
<a href="#l19.738"></a><span id="l19.738" class="difflineplus">+        var containerToUse = this._view.selectedNode || this._view.result.root;</span>
<a href="#l19.739"></a><span id="l19.739" class="difflineplus">+        if (PlacesUtils.nodeIsContainer(containerToUse)) {</span>
<a href="#l19.740"></a><span id="l19.740" class="difflineplus">+          if (!PlacesUtils.hasChildURIs(containerToUse)) {</span>
<a href="#l19.741"></a><span id="l19.741" class="difflineplus">+            openContainerInTabsItem.disabled = true;</span>
<a href="#l19.742"></a><span id="l19.742" class="difflineplus">+            // Ensure that we don't display the menu if nothing is enabled:</span>
<a href="#l19.743"></a><span id="l19.743" class="difflineplus">+            usableItemCount--;</span>
<a href="#l19.744"></a><span id="l19.744" class="difflineplus">+          }</span>
<a href="#l19.745"></a><span id="l19.745" class="difflineplus">+        }</span>
<a href="#l19.746"></a><span id="l19.746">       }</span>
<a href="#l19.747"></a><span id="l19.747">     }</span>
<a href="#l19.748"></a><span id="l19.748"> </span>
<a href="#l19.749"></a><span id="l19.749" class="difflineminus">-    return anyVisible;</span>
<a href="#l19.750"></a><span id="l19.750" class="difflineplus">+    // Make sure correct PluralForms are diplayed when multiple pages are selected.</span>
<a href="#l19.751"></a><span id="l19.751" class="difflineplus">+    var deleteHistoryItem = document.getElementById(&quot;placesContext_delete_history&quot;);</span>
<a href="#l19.752"></a><span id="l19.752" class="difflineplus">+    deleteHistoryItem.label = PlacesUIUtils.getPluralString(&quot;cmd.deletePages.label&quot;,</span>
<a href="#l19.753"></a><span id="l19.753" class="difflineplus">+                                                            metadata.length);</span>
<a href="#l19.754"></a><span id="l19.754" class="difflineplus">+    deleteHistoryItem.accessKey = PlacesUIUtils.getString(&quot;cmd.deletePages.accesskey&quot;);</span>
<a href="#l19.755"></a><span id="l19.755" class="difflineplus">+    var createBookmarkItem = document.getElementById(&quot;placesContext_createBookmark&quot;);</span>
<a href="#l19.756"></a><span id="l19.756" class="difflineplus">+    createBookmarkItem.label = PlacesUIUtils.getPluralString(&quot;cmd.bookmarkPages.label&quot;,</span>
<a href="#l19.757"></a><span id="l19.757" class="difflineplus">+                                                             metadata.length);</span>
<a href="#l19.758"></a><span id="l19.758" class="difflineplus">+    createBookmarkItem.accessKey = PlacesUIUtils.getString(&quot;cmd.bookmarkPages.accesskey&quot;);</span>
<a href="#l19.759"></a><span id="l19.759" class="difflineplus">+</span>
<a href="#l19.760"></a><span id="l19.760" class="difflineplus">+    return usableItemCount &gt; 0;</span>
<a href="#l19.761"></a><span id="l19.761">   },</span>
<a href="#l19.762"></a><span id="l19.762"> </span>
<a href="#l19.763"></a><span id="l19.763">   /**</span>
<a href="#l19.764"></a><span id="l19.764">    * Select all links in the current view.</span>
<a href="#l19.765"></a><span id="l19.765">    */</span>
<a href="#l19.766"></a><span id="l19.766">   selectAll: function PC_selectAll() {</span>
<a href="#l19.767"></a><span id="l19.767">     this._view.selectAll();</span>
<a href="#l19.768"></a><span id="l19.768">   },</span>
<a href="#l19.769"></a><span id="l19.769"> </span>
<a href="#l19.770"></a><span id="l19.770">   /**</span>
<a href="#l19.771"></a><span id="l19.771">    * Opens the bookmark properties for the selected URI Node.</span>
<a href="#l19.772"></a><span id="l19.772">    */</span>
<a href="#l19.773"></a><span id="l19.773" class="difflineminus">-  showBookmarkPropertiesForSelection:</span>
<a href="#l19.774"></a><span id="l19.774" class="difflineminus">-  function PC_showBookmarkPropertiesForSelection() {</span>
<a href="#l19.775"></a><span id="l19.775" class="difflineminus">-    var node = this._view.selectedNode;</span>
<a href="#l19.776"></a><span id="l19.776" class="difflineplus">+  showBookmarkPropertiesForSelection() {</span>
<a href="#l19.777"></a><span id="l19.777" class="difflineplus">+    let node = this._view.selectedNode;</span>
<a href="#l19.778"></a><span id="l19.778">     if (!node)</span>
<a href="#l19.779"></a><span id="l19.779">       return;</span>
<a href="#l19.780"></a><span id="l19.780"> </span>
<a href="#l19.781"></a><span id="l19.781" class="difflineminus">-    var itemType = PlacesUtils.nodeIsFolder(node) ||</span>
<a href="#l19.782"></a><span id="l19.782" class="difflineminus">-                   PlacesUtils.nodeIsTagQuery(node) ? &quot;folder&quot; : &quot;bookmark&quot;;</span>
<a href="#l19.783"></a><span id="l19.783" class="difflineminus">-    var concreteId = PlacesUtils.getConcreteItemId(node);</span>
<a href="#l19.784"></a><span id="l19.784" class="difflineminus">-    var isRootItem = PlacesUtils.isRootItem(concreteId);</span>
<a href="#l19.785"></a><span id="l19.785" class="difflineminus">-    var itemId = node.itemId;</span>
<a href="#l19.786"></a><span id="l19.786" class="difflineminus">-    if (isRootItem || PlacesUtils.nodeIsTagQuery(node)) {</span>
<a href="#l19.787"></a><span id="l19.787" class="difflineminus">-      // If this is a root or the Tags query we use the concrete itemId to catch</span>
<a href="#l19.788"></a><span id="l19.788" class="difflineminus">-      // the correct title for the node.</span>
<a href="#l19.789"></a><span id="l19.789" class="difflineminus">-      itemId = concreteId;</span>
<a href="#l19.790"></a><span id="l19.790" class="difflineminus">-    }</span>
<a href="#l19.791"></a><span id="l19.791" class="difflineminus">-</span>
<a href="#l19.792"></a><span id="l19.792" class="difflineminus">-    PlacesUIUtils.showItemProperties(itemId, itemType,</span>
<a href="#l19.793"></a><span id="l19.793" class="difflineminus">-                                     isRootItem /* read only */);</span>
<a href="#l19.794"></a><span id="l19.794" class="difflineplus">+    PlacesUIUtils.showBookmarkDialog({ action: &quot;edit&quot;,</span>
<a href="#l19.795"></a><span id="l19.795" class="difflineplus">+                                       node,</span>
<a href="#l19.796"></a><span id="l19.796" class="difflineplus">+                                       hiddenRows: [ &quot;folderPicker&quot; ]</span>
<a href="#l19.797"></a><span id="l19.797" class="difflineplus">+                                     }, window.top);</span>
<a href="#l19.798"></a><span id="l19.798">   },</span>
<a href="#l19.799"></a><span id="l19.799"> </span>
<a href="#l19.800"></a><span id="l19.800">   /**</span>
<a href="#l19.801"></a><span id="l19.801">    * This method can be run on a URI parameter to ensure that it didn't</span>
<a href="#l19.802"></a><span id="l19.802">    * receive a string instead of an nsIURI object.</span>
<a href="#l19.803"></a><span id="l19.803">    */</span>
<a href="#l19.804"></a><span id="l19.804">   _assertURINotString: function PC__assertURINotString(value) {</span>
<a href="#l19.805"></a><span id="l19.805">     NS_ASSERT((typeof(value) == &quot;object&quot;) &amp;&amp; !(value instanceof String),</span>
<a href="#l19.806"></a><span id="l19.806">            &quot;This method should be passed a URI as a nsIURI object, not as a string.&quot;);</span>
<a href="#l19.807"></a><span id="l19.807">   },</span>
<a href="#l19.808"></a><span id="l19.808"> </span>
<a href="#l19.809"></a><span id="l19.809">   /**</span>
<a href="#l19.810"></a><span id="l19.810">    * Reloads the selected livemark if any.</span>
<a href="#l19.811"></a><span id="l19.811">    */</span>
<a href="#l19.812"></a><span id="l19.812">   reloadSelectedLivemark: function PC_reloadSelectedLivemark() {</span>
<a href="#l19.813"></a><span id="l19.813">     var selectedNode = this._view.selectedNode;</span>
<a href="#l19.814"></a><span id="l19.814" class="difflineminus">-    if (selectedNode)</span>
<a href="#l19.815"></a><span id="l19.815" class="difflineminus">-      PlacesUtils.livemarks.getLivemark({ id: selectedNode.itemId })</span>
<a href="#l19.816"></a><span id="l19.816" class="difflineminus">-                           .then(aLivemark =&gt; aLivemark.reload(true));</span>
<a href="#l19.817"></a><span id="l19.817" class="difflineminus">-  },</span>
<a href="#l19.818"></a><span id="l19.818" class="difflineminus">-</span>
<a href="#l19.819"></a><span id="l19.819" class="difflineminus">-  /**</span>
<a href="#l19.820"></a><span id="l19.820" class="difflineminus">-   * Gives the user a chance to cancel loading lots of tabs at once</span>
<a href="#l19.821"></a><span id="l19.821" class="difflineminus">-   */</span>
<a href="#l19.822"></a><span id="l19.822" class="difflineminus">-  _confirmOpenTabs: function(numTabsToOpen) {</span>
<a href="#l19.823"></a><span id="l19.823" class="difflineminus">-    const kWarnOnOpenPref = &quot;browser.tabs.warnOnOpen&quot;;</span>
<a href="#l19.824"></a><span id="l19.824" class="difflineminus">-    var reallyOpen = true;</span>
<a href="#l19.825"></a><span id="l19.825" class="difflineminus">-    if (Services.prefs.getBoolPref(kWarnOnOpenPref)) {</span>
<a href="#l19.826"></a><span id="l19.826" class="difflineminus">-      if (numTabsToOpen &gt;= Services.prefs.getIntPref(&quot;browser.tabs.maxOpenBeforeWarn&quot;)) {</span>
<a href="#l19.827"></a><span id="l19.827" class="difflineminus">-        var promptService = Cc[&quot;@mozilla.org/embedcomp/prompt-service;1&quot;]</span>
<a href="#l19.828"></a><span id="l19.828" class="difflineminus">-                              .getService(Ci.nsIPromptService);</span>
<a href="#l19.829"></a><span id="l19.829" class="difflineminus">-</span>
<a href="#l19.830"></a><span id="l19.830" class="difflineminus">-        // default to true: if it were false, we wouldn't get this far</span>
<a href="#l19.831"></a><span id="l19.831" class="difflineminus">-        var warnOnOpen = { value: true };</span>
<a href="#l19.832"></a><span id="l19.832" class="difflineminus">-</span>
<a href="#l19.833"></a><span id="l19.833" class="difflineminus">-        var messageKey = &quot;tabs.openWarningMultipleBranded&quot;;</span>
<a href="#l19.834"></a><span id="l19.834" class="difflineminus">-        var openKey = &quot;tabs.openButtonMultiple&quot;;</span>
<a href="#l19.835"></a><span id="l19.835" class="difflineminus">-        const BRANDING_BUNDLE_URI = &quot;chrome://branding/locale/brand.properties&quot;;</span>
<a href="#l19.836"></a><span id="l19.836" class="difflineminus">-        var brandShortName = Cc[&quot;@mozilla.org/intl/stringbundle;1&quot;]</span>
<a href="#l19.837"></a><span id="l19.837" class="difflineminus">-                               .getService(Ci.nsIStringBundleService)</span>
<a href="#l19.838"></a><span id="l19.838" class="difflineminus">-                               .createBundle(BRANDING_BUNDLE_URI)</span>
<a href="#l19.839"></a><span id="l19.839" class="difflineminus">-                               .GetStringFromName(&quot;brandShortName&quot;);</span>
<a href="#l19.840"></a><span id="l19.840" class="difflineminus">-</span>
<a href="#l19.841"></a><span id="l19.841" class="difflineminus">-        var buttonPressed = promptService.confirmEx(window,</span>
<a href="#l19.842"></a><span id="l19.842" class="difflineminus">-          PlacesUIUtils.getString(&quot;tabs.openWarningTitle&quot;),</span>
<a href="#l19.843"></a><span id="l19.843" class="difflineminus">-          PlacesUIUtils.getFormattedString(messageKey,</span>
<a href="#l19.844"></a><span id="l19.844" class="difflineminus">-            [numTabsToOpen, brandShortName]),</span>
<a href="#l19.845"></a><span id="l19.845" class="difflineminus">-          (promptService.BUTTON_TITLE_IS_STRING * promptService.BUTTON_POS_0)</span>
<a href="#l19.846"></a><span id="l19.846" class="difflineminus">-          + (promptService.BUTTON_TITLE_CANCEL * promptService.BUTTON_POS_1),</span>
<a href="#l19.847"></a><span id="l19.847" class="difflineminus">-          PlacesUIUtils.getString(openKey),</span>
<a href="#l19.848"></a><span id="l19.848" class="difflineminus">-          null, null,</span>
<a href="#l19.849"></a><span id="l19.849" class="difflineminus">-          PlacesUIUtils.getFormattedString(&quot;tabs.openWarningPromptMeBranded&quot;,</span>
<a href="#l19.850"></a><span id="l19.850" class="difflineminus">-            [brandShortName]),</span>
<a href="#l19.851"></a><span id="l19.851" class="difflineminus">-          warnOnOpen);</span>
<a href="#l19.852"></a><span id="l19.852" class="difflineminus">-</span>
<a href="#l19.853"></a><span id="l19.853" class="difflineminus">-         reallyOpen = (buttonPressed == 0);</span>
<a href="#l19.854"></a><span id="l19.854" class="difflineminus">-         // don't set the pref unless they press OK and it's false</span>
<a href="#l19.855"></a><span id="l19.855" class="difflineminus">-         if (reallyOpen &amp;&amp; !warnOnOpen.value)</span>
<a href="#l19.856"></a><span id="l19.856" class="difflineminus">-           Services.prefs.setBoolPref(kWarnOnOpenPref, false);</span>
<a href="#l19.857"></a><span id="l19.857" class="difflineminus">-      }</span>
<a href="#l19.858"></a><span id="l19.858" class="difflineplus">+    if (selectedNode) {</span>
<a href="#l19.859"></a><span id="l19.859" class="difflineplus">+      let itemId = selectedNode.itemId;</span>
<a href="#l19.860"></a><span id="l19.860" class="difflineplus">+      PlacesUtils.livemarks.getLivemark({ id: itemId })</span>
<a href="#l19.861"></a><span id="l19.861" class="difflineplus">+        .then(aLivemark =&gt; {</span>
<a href="#l19.862"></a><span id="l19.862" class="difflineplus">+          aLivemark.reload(true);</span>
<a href="#l19.863"></a><span id="l19.863" class="difflineplus">+        }, Cu.reportError);</span>
<a href="#l19.864"></a><span id="l19.864">     }</span>
<a href="#l19.865"></a><span id="l19.865" class="difflineminus">-    return reallyOpen;</span>
<a href="#l19.866"></a><span id="l19.866">   },</span>
<a href="#l19.867"></a><span id="l19.867"> </span>
<a href="#l19.868"></a><span id="l19.868">   /**</span>
<a href="#l19.869"></a><span id="l19.869">    * Opens the links in the selected folder, or the selected links in new tabs.</span>
<a href="#l19.870"></a><span id="l19.870">    */</span>
<a href="#l19.871"></a><span id="l19.871">   openSelectionInTabs: function PC_openLinksInTabs(aEvent) {</span>
<a href="#l19.872"></a><span id="l19.872">     var node = this._view.selectedNode;</span>
<a href="#l19.873"></a><span id="l19.873" class="difflineplus">+    var nodes = this._view.selectedNodes;</span>
<a href="#l19.874"></a><span id="l19.874" class="difflineplus">+    // In the case of no selection, open the root node:</span>
<a href="#l19.875"></a><span id="l19.875" class="difflineplus">+    if (!node &amp;&amp; !nodes.length) {</span>
<a href="#l19.876"></a><span id="l19.876" class="difflineplus">+      node = this._view.result.root;</span>
<a href="#l19.877"></a><span id="l19.877" class="difflineplus">+    }</span>
<a href="#l19.878"></a><span id="l19.878">     if (node &amp;&amp; PlacesUtils.nodeIsContainer(node))</span>
<a href="#l19.879"></a><span id="l19.879" class="difflineminus">-      PlacesUIUtils.openContainerNodeInTabs(this._view.selectedNode, aEvent);</span>
<a href="#l19.880"></a><span id="l19.880" class="difflineplus">+      PlacesUIUtils.openContainerNodeInTabs(node, aEvent, this._view);</span>
<a href="#l19.881"></a><span id="l19.881">     else</span>
<a href="#l19.882"></a><span id="l19.882" class="difflineminus">-      PlacesUIUtils.openURINodesInTabs(this._view.selectedNodes, aEvent);</span>
<a href="#l19.883"></a><span id="l19.883" class="difflineplus">+      PlacesUIUtils.openURINodesInTabs(nodes, aEvent, this._view);</span>
<a href="#l19.884"></a><span id="l19.884">   },</span>
<a href="#l19.885"></a><span id="l19.885"> </span>
<a href="#l19.886"></a><span id="l19.886">   /**</span>
<a href="#l19.887"></a><span id="l19.887">    * Shows the Add Bookmark UI for the current insertion point.</span>
<a href="#l19.888"></a><span id="l19.888">    *</span>
<a href="#l19.889"></a><span id="l19.889">    * @param aType</span>
<a href="#l19.890"></a><span id="l19.890">    *        the type of the new item (bookmark/livemark/folder)</span>
<a href="#l19.891"></a><span id="l19.891">    */</span>
<a href="#l19.892"></a><span id="l19.892">   newItem: function PC_newItem(aType) {</span>
<a href="#l19.893"></a><span id="l19.893" class="difflineminus">-    var ip = this._view.insertionPoint;</span>
<a href="#l19.894"></a><span id="l19.894" class="difflineplus">+    let ip = this._view.insertionPoint;</span>
<a href="#l19.895"></a><span id="l19.895">     if (!ip)</span>
<a href="#l19.896"></a><span id="l19.896">       throw Cr.NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l19.897"></a><span id="l19.897"> </span>
<a href="#l19.898"></a><span id="l19.898" class="difflineminus">-    var performed = false;</span>
<a href="#l19.899"></a><span id="l19.899" class="difflineminus">-    if (aType == &quot;bookmark&quot;)</span>
<a href="#l19.900"></a><span id="l19.900" class="difflineminus">-      performed = PlacesUIUtils.showAddBookmarkUI(null, null, null, ip);</span>
<a href="#l19.901"></a><span id="l19.901" class="difflineminus">-    else if (aType == &quot;livemark&quot;)</span>
<a href="#l19.902"></a><span id="l19.902" class="difflineminus">-      performed = PlacesUIUtils.showAddLivemarkUI(null, null, null, null, ip);</span>
<a href="#l19.903"></a><span id="l19.903" class="difflineminus">-    else // folder</span>
<a href="#l19.904"></a><span id="l19.904" class="difflineminus">-      performed = PlacesUIUtils.showAddFolderUI(null, ip);</span>
<a href="#l19.905"></a><span id="l19.905" class="difflineminus">-</span>
<a href="#l19.906"></a><span id="l19.906" class="difflineplus">+    let performed =</span>
<a href="#l19.907"></a><span id="l19.907" class="difflineplus">+      PlacesUIUtils.showBookmarkDialog({ action: &quot;add&quot;,</span>
<a href="#l19.908"></a><span id="l19.908" class="difflineplus">+                                         type: aType,</span>
<a href="#l19.909"></a><span id="l19.909" class="difflineplus">+                                         defaultInsertionPoint: ip,</span>
<a href="#l19.910"></a><span id="l19.910" class="difflineplus">+                                         hiddenRows: [ &quot;folderPicker&quot; ]</span>
<a href="#l19.911"></a><span id="l19.911" class="difflineplus">+                                       }, window.top);</span>
<a href="#l19.912"></a><span id="l19.912">     if (performed) {</span>
<a href="#l19.913"></a><span id="l19.913" class="difflineminus">-      // select the new item</span>
<a href="#l19.914"></a><span id="l19.914" class="difflineminus">-      var insertedNodeId = PlacesUtils.bookmarks</span>
<a href="#l19.915"></a><span id="l19.915" class="difflineminus">-                                      .getIdForItemAt(ip.itemId, ip.index);</span>
<a href="#l19.916"></a><span id="l19.916" class="difflineminus">-      this._view.selectItems([insertedNodeId], false);</span>
<a href="#l19.917"></a><span id="l19.917" class="difflineminus">-    }</span>
<a href="#l19.918"></a><span id="l19.918" class="difflineminus">-  },</span>
<a href="#l19.919"></a><span id="l19.919" class="difflineminus">-</span>
<a href="#l19.920"></a><span id="l19.920" class="difflineminus">-</span>
<a href="#l19.921"></a><span id="l19.921" class="difflineminus">-  /**</span>
<a href="#l19.922"></a><span id="l19.922" class="difflineminus">-   * Create a new Bookmark folder somewhere. Prompts the user for the name</span>
<a href="#l19.923"></a><span id="l19.923" class="difflineminus">-   * of the folder.</span>
<a href="#l19.924"></a><span id="l19.924" class="difflineminus">-   */</span>
<a href="#l19.925"></a><span id="l19.925" class="difflineminus">-  newFolder: function PC_newFolder() {</span>
<a href="#l19.926"></a><span id="l19.926" class="difflineminus">-    var ip = this._view.insertionPoint;</span>
<a href="#l19.927"></a><span id="l19.927" class="difflineminus">-    if (!ip)</span>
<a href="#l19.928"></a><span id="l19.928" class="difflineminus">-      throw Cr.NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l19.929"></a><span id="l19.929" class="difflineminus">-</span>
<a href="#l19.930"></a><span id="l19.930" class="difflineminus">-    var performed = false;</span>
<a href="#l19.931"></a><span id="l19.931" class="difflineminus">-    performed = PlacesUIUtils.showAddFolderUI(null, ip);</span>
<a href="#l19.932"></a><span id="l19.932" class="difflineminus">-    if (performed) {</span>
<a href="#l19.933"></a><span id="l19.933" class="difflineminus">-      // select the new item</span>
<a href="#l19.934"></a><span id="l19.934" class="difflineminus">-      var insertedNodeId = PlacesUtils.bookmarks</span>
<a href="#l19.935"></a><span id="l19.935" class="difflineplus">+      // Select the new item.</span>
<a href="#l19.936"></a><span id="l19.936" class="difflineplus">+      let insertedNodeId = PlacesUtils.bookmarks</span>
<a href="#l19.937"></a><span id="l19.937">                                       .getIdForItemAt(ip.itemId, ip.index);</span>
<a href="#l19.938"></a><span id="l19.938">       this._view.selectItems([insertedNodeId], false);</span>
<a href="#l19.939"></a><span id="l19.939">     }</span>
<a href="#l19.940"></a><span id="l19.940">   },</span>
<a href="#l19.941"></a><span id="l19.941"> </span>
<a href="#l19.942"></a><span id="l19.942">   /**</span>
<a href="#l19.943"></a><span id="l19.943">    * Create a new Bookmark separator somewhere.</span>
<a href="#l19.944"></a><span id="l19.944">    */</span>
<a href="#l19.945"></a><span id="l19.945" class="difflineminus">-  newSeparator: function PC_newSeparator() {</span>
<a href="#l19.946"></a><span id="l19.946" class="difflineplus">+  async newSeparator() {</span>
<a href="#l19.947"></a><span id="l19.947">     var ip = this._view.insertionPoint;</span>
<a href="#l19.948"></a><span id="l19.948">     if (!ip)</span>
<a href="#l19.949"></a><span id="l19.949">       throw Cr.NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l19.950"></a><span id="l19.950" class="difflineminus">-    var txn = new PlacesCreateSeparatorTransaction(ip.itemId, ip.index);</span>
<a href="#l19.951"></a><span id="l19.951" class="difflineminus">-    PlacesUtils.transactionManager.doTransaction(txn);</span>
<a href="#l19.952"></a><span id="l19.952" class="difflineminus">-    // select the new item</span>
<a href="#l19.953"></a><span id="l19.953" class="difflineminus">-    var insertedNodeId = PlacesUtils.bookmarks</span>
<a href="#l19.954"></a><span id="l19.954" class="difflineminus">-                                    .getIdForItemAt(ip.itemId, ip.index);</span>
<a href="#l19.955"></a><span id="l19.955" class="difflineminus">-    this._view.selectItems([insertedNodeId], false);</span>
<a href="#l19.956"></a><span id="l19.956" class="difflineminus">-  },</span>
<a href="#l19.957"></a><span id="l19.957"> </span>
<a href="#l19.958"></a><span id="l19.958" class="difflineminus">-  /**</span>
<a href="#l19.959"></a><span id="l19.959" class="difflineminus">-   * Opens a dialog for moving the selected nodes.</span>
<a href="#l19.960"></a><span id="l19.960" class="difflineminus">-   */</span>
<a href="#l19.961"></a><span id="l19.961" class="difflineminus">-  moveSelectedBookmarks: function PC_moveBookmarks() {</span>
<a href="#l19.962"></a><span id="l19.962" class="difflineminus">-    window.openDialog(&quot;chrome://communicator/content/bookmarks/moveBookmarks.xul&quot;,</span>
<a href="#l19.963"></a><span id="l19.963" class="difflineminus">-                      &quot;&quot;, &quot;chrome,modal,resizable=yes&quot;,</span>
<a href="#l19.964"></a><span id="l19.964" class="difflineminus">-                      this._view.selectedNodes);</span>
<a href="#l19.965"></a><span id="l19.965" class="difflineplus">+    if (!PlacesUIUtils.useAsyncTransactions) {</span>
<a href="#l19.966"></a><span id="l19.966" class="difflineplus">+      let txn = new PlacesCreateSeparatorTransaction(ip.itemId, ip.index);</span>
<a href="#l19.967"></a><span id="l19.967" class="difflineplus">+      PlacesUtils.transactionManager.doTransaction(txn);</span>
<a href="#l19.968"></a><span id="l19.968" class="difflineplus">+      // Select the new item.</span>
<a href="#l19.969"></a><span id="l19.969" class="difflineplus">+      let insertedNodeId = PlacesUtils.bookmarks</span>
<a href="#l19.970"></a><span id="l19.970" class="difflineplus">+                                      .getIdForItemAt(ip.itemId, ip.index);</span>
<a href="#l19.971"></a><span id="l19.971" class="difflineplus">+      this._view.selectItems([insertedNodeId], false);</span>
<a href="#l19.972"></a><span id="l19.972" class="difflineplus">+      return;</span>
<a href="#l19.973"></a><span id="l19.973" class="difflineplus">+    }</span>
<a href="#l19.974"></a><span id="l19.974" class="difflineplus">+</span>
<a href="#l19.975"></a><span id="l19.975" class="difflineplus">+    let txn = PlacesTransactions.NewSeparator({ parentGuid: await ip.promiseGuid(),</span>
<a href="#l19.976"></a><span id="l19.976" class="difflineplus">+                                                index: ip.index });</span>
<a href="#l19.977"></a><span id="l19.977" class="difflineplus">+    let guid = await txn.transact();</span>
<a href="#l19.978"></a><span id="l19.978" class="difflineplus">+    let itemId = await PlacesUtils.promiseItemId(guid);</span>
<a href="#l19.979"></a><span id="l19.979" class="difflineplus">+    // Select the new item.</span>
<a href="#l19.980"></a><span id="l19.980" class="difflineplus">+    this._view.selectItems([itemId], false);</span>
<a href="#l19.981"></a><span id="l19.981">   },</span>
<a href="#l19.982"></a><span id="l19.982"> </span>
<a href="#l19.983"></a><span id="l19.983">   /**</span>
<a href="#l19.984"></a><span id="l19.984">    * Sort the selected folder by name</span>
<a href="#l19.985"></a><span id="l19.985">    */</span>
<a href="#l19.986"></a><span id="l19.986" class="difflineminus">-  sortFolderByName: function PC_sortFolderByName() {</span>
<a href="#l19.987"></a><span id="l19.987" class="difflineminus">-    var itemId = PlacesUtils.getConcreteItemId(this._view.selectedNode);</span>
<a href="#l19.988"></a><span id="l19.988" class="difflineminus">-    var txn = new PlacesSortFolderByNameTransaction(itemId);</span>
<a href="#l19.989"></a><span id="l19.989" class="difflineminus">-    PlacesUtils.transactionManager.doTransaction(txn);</span>
<a href="#l19.990"></a><span id="l19.990" class="difflineplus">+  async sortFolderByName() {</span>
<a href="#l19.991"></a><span id="l19.991" class="difflineplus">+    let itemId = PlacesUtils.getConcreteItemId(this._view.selectedNode);</span>
<a href="#l19.992"></a><span id="l19.992" class="difflineplus">+    if (!PlacesUIUtils.useAsyncTransactions) {</span>
<a href="#l19.993"></a><span id="l19.993" class="difflineplus">+      var txn = new PlacesSortFolderByNameTransaction(itemId);</span>
<a href="#l19.994"></a><span id="l19.994" class="difflineplus">+      PlacesUtils.transactionManager.doTransaction(txn);</span>
<a href="#l19.995"></a><span id="l19.995" class="difflineplus">+      return;</span>
<a href="#l19.996"></a><span id="l19.996" class="difflineplus">+    }</span>
<a href="#l19.997"></a><span id="l19.997" class="difflineplus">+    let guid = await PlacesUtils.promiseItemGuid(itemId);</span>
<a href="#l19.998"></a><span id="l19.998" class="difflineplus">+    await PlacesTransactions.SortByName(guid).transact();</span>
<a href="#l19.999"></a><span id="l19.999">   },</span>
<a href="#l19.1000"></a><span id="l19.1000"> </span>
<a href="#l19.1001"></a><span id="l19.1001">   /**</span>
<a href="#l19.1002"></a><span id="l19.1002">    * Walk the list of folders we're removing in this delete operation, and</span>
<a href="#l19.1003"></a><span id="l19.1003">    * see if the selected node specified is already implicitly being removed</span>
<a href="#l19.1004"></a><span id="l19.1004">    * because it is a child of that folder.</span>
<a href="#l19.1005"></a><span id="l19.1005">    * @param   node</span>
<a href="#l19.1006"></a><span id="l19.1006">    *          Node to check for containment.</span>
<a href="#l19.1007"></a><span id="l19.1007">    * @param   pastFolders</span>
<a href="#l19.1008"></a><span id="l19.1008">    *          List of folders the calling function has already traversed</span>
<a href="#l19.1009"></a><span id="l19.1009" class="difflineminus">-   * @returns true if the node should be skipped, false otherwise.</span>
<a href="#l19.1010"></a><span id="l19.1010" class="difflineplus">+   * @return true if the node should be skipped, false otherwise.</span>
<a href="#l19.1011"></a><span id="l19.1011">    */</span>
<a href="#l19.1012"></a><span id="l19.1012">   _shouldSkipNode: function PC_shouldSkipNode(node, pastFolders) {</span>
<a href="#l19.1013"></a><span id="l19.1013">     /**</span>
<a href="#l19.1014"></a><span id="l19.1014">      * Determines if a node is contained by another node within a resultset.</span>
<a href="#l19.1015"></a><span id="l19.1015">      * @param   node</span>
<a href="#l19.1016"></a><span id="l19.1016">      *          The node to check for containment for</span>
<a href="#l19.1017"></a><span id="l19.1017">      * @param   parent</span>
<a href="#l19.1018"></a><span id="l19.1018">      *          The parent container to check for containment in</span>
<a href="#l19.1019"></a><span id="l19.1019" class="difflineminus">-     * @returns true if node is a member of parent's children, false otherwise.</span>
<a href="#l19.1020"></a><span id="l19.1020" class="difflineplus">+     * @return true if node is a member of parent's children, false otherwise.</span>
<a href="#l19.1021"></a><span id="l19.1021">      */</span>
<a href="#l19.1022"></a><span id="l19.1022" class="difflineminus">-    function isContainedBy(node, parent) {</span>
<a href="#l19.1023"></a><span id="l19.1023" class="difflineplus">+    function isNodeContainedBy(parent) {</span>
<a href="#l19.1024"></a><span id="l19.1024">       var cursor = node.parent;</span>
<a href="#l19.1025"></a><span id="l19.1025">       while (cursor) {</span>
<a href="#l19.1026"></a><span id="l19.1026">         if (cursor == parent)</span>
<a href="#l19.1027"></a><span id="l19.1027">           return true;</span>
<a href="#l19.1028"></a><span id="l19.1028">         cursor = cursor.parent;</span>
<a href="#l19.1029"></a><span id="l19.1029">       }</span>
<a href="#l19.1030"></a><span id="l19.1030">       return false;</span>
<a href="#l19.1031"></a><span id="l19.1031">     }</span>
<a href="#l19.1032"></a><span id="l19.1032"> </span>
<a href="#l19.1033"></a><span id="l19.1033" class="difflineminus">-      for (var j = 0; j &lt; pastFolders.length; ++j) {</span>
<a href="#l19.1034"></a><span id="l19.1034" class="difflineminus">-        if (isContainedBy(node, pastFolders[j]))</span>
<a href="#l19.1035"></a><span id="l19.1035" class="difflineminus">-          return true;</span>
<a href="#l19.1036"></a><span id="l19.1036" class="difflineminus">-      }</span>
<a href="#l19.1037"></a><span id="l19.1037" class="difflineminus">-      return false;</span>
<a href="#l19.1038"></a><span id="l19.1038" class="difflineplus">+    for (var j = 0; j &lt; pastFolders.length; ++j) {</span>
<a href="#l19.1039"></a><span id="l19.1039" class="difflineplus">+      if (isNodeContainedBy(pastFolders[j]))</span>
<a href="#l19.1040"></a><span id="l19.1040" class="difflineplus">+        return true;</span>
<a href="#l19.1041"></a><span id="l19.1041" class="difflineplus">+    }</span>
<a href="#l19.1042"></a><span id="l19.1042" class="difflineplus">+    return false;</span>
<a href="#l19.1043"></a><span id="l19.1043">   },</span>
<a href="#l19.1044"></a><span id="l19.1044"> </span>
<a href="#l19.1045"></a><span id="l19.1045">   /**</span>
<a href="#l19.1046"></a><span id="l19.1046">    * Creates a set of transactions for the removal of a range of items.</span>
<a href="#l19.1047"></a><span id="l19.1047">    * A range is an array of adjacent nodes in a view.</span>
<a href="#l19.1048"></a><span id="l19.1048">    * @param   [in] range</span>
<a href="#l19.1049"></a><span id="l19.1049">    *          An array of nodes to remove. Should all be adjacent.</span>
<a href="#l19.1050"></a><span id="l19.1050">    * @param   [out] transactions</span>
<a href="#l19.1051"></a><span id="l19.1051" class="difflineat">@@ -860,422 +842,507 @@ PlacesController.prototype = {</span>
<a href="#l19.1052"></a><span id="l19.1052">       var node = range[i];</span>
<a href="#l19.1053"></a><span id="l19.1053">       if (this._shouldSkipNode(node, removedFolders))</span>
<a href="#l19.1054"></a><span id="l19.1054">         continue;</span>
<a href="#l19.1055"></a><span id="l19.1055"> </span>
<a href="#l19.1056"></a><span id="l19.1056">       if (PlacesUtils.nodeIsTagQuery(node.parent)) {</span>
<a href="#l19.1057"></a><span id="l19.1057">         // This is a uri node inside a tag container.  It needs a special</span>
<a href="#l19.1058"></a><span id="l19.1058">         // untag transaction.</span>
<a href="#l19.1059"></a><span id="l19.1059">         var tagItemId = PlacesUtils.getConcreteItemId(node.parent);</span>
<a href="#l19.1060"></a><span id="l19.1060" class="difflineminus">-        var uri = PlacesUtils._uri(node.uri);</span>
<a href="#l19.1061"></a><span id="l19.1061" class="difflineminus">-        let txn = new PlacesUntagURITransaction(uri, [tagItemId]);</span>
<a href="#l19.1062"></a><span id="l19.1062" class="difflineminus">-        transactions.push(txn);</span>
<a href="#l19.1063"></a><span id="l19.1063" class="difflineminus">-      }</span>
<a href="#l19.1064"></a><span id="l19.1064" class="difflineminus">-      else if (PlacesUtils.nodeIsTagQuery(node) &amp;&amp; node.parent &amp;&amp;</span>
<a href="#l19.1065"></a><span id="l19.1065" class="difflineplus">+        var uri = NetUtil.newURI(node.uri);</span>
<a href="#l19.1066"></a><span id="l19.1066" class="difflineplus">+        if (PlacesUIUtils.useAsyncTransactions) {</span>
<a href="#l19.1067"></a><span id="l19.1067" class="difflineplus">+          let tag = node.parent.title;</span>
<a href="#l19.1068"></a><span id="l19.1068" class="difflineplus">+          if (!tag)</span>
<a href="#l19.1069"></a><span id="l19.1069" class="difflineplus">+            tag = PlacesUtils.bookmarks.getItemTitle(tagItemId);</span>
<a href="#l19.1070"></a><span id="l19.1070" class="difflineplus">+          transactions.push(PlacesTransactions.Untag({ uri, tag }));</span>
<a href="#l19.1071"></a><span id="l19.1071" class="difflineplus">+        } else {</span>
<a href="#l19.1072"></a><span id="l19.1072" class="difflineplus">+          let txn = new PlacesUntagURITransaction(uri, [tagItemId]);</span>
<a href="#l19.1073"></a><span id="l19.1073" class="difflineplus">+          transactions.push(txn);</span>
<a href="#l19.1074"></a><span id="l19.1074" class="difflineplus">+        }</span>
<a href="#l19.1075"></a><span id="l19.1075" class="difflineplus">+      } else if (PlacesUtils.nodeIsTagQuery(node) &amp;&amp; node.parent &amp;&amp;</span>
<a href="#l19.1076"></a><span id="l19.1076">                PlacesUtils.nodeIsQuery(node.parent) &amp;&amp;</span>
<a href="#l19.1077"></a><span id="l19.1077">                PlacesUtils.asQuery(node.parent).queryOptions.resultType ==</span>
<a href="#l19.1078"></a><span id="l19.1078">                  Ci.nsINavHistoryQueryOptions.RESULTS_AS_TAG_QUERY) {</span>
<a href="#l19.1079"></a><span id="l19.1079">         // This is a tag container.</span>
<a href="#l19.1080"></a><span id="l19.1080">         // Untag all URIs tagged with this tag only if the tag container is</span>
<a href="#l19.1081"></a><span id="l19.1081">         // child of the &quot;Tags&quot; query in the library, in all other places we</span>
<a href="#l19.1082"></a><span id="l19.1082">         // must only remove the query node.</span>
<a href="#l19.1083"></a><span id="l19.1083" class="difflineminus">-        var tag = node.title;</span>
<a href="#l19.1084"></a><span id="l19.1084" class="difflineminus">-        var URIs = PlacesUtils.tagging.getURIsForTag(tag);</span>
<a href="#l19.1085"></a><span id="l19.1085" class="difflineminus">-        for (var j = 0; j &lt; URIs.length; j++) {</span>
<a href="#l19.1086"></a><span id="l19.1086" class="difflineminus">-          let txn = new PlacesUntagURITransaction(URIs[j], [tag]);</span>
<a href="#l19.1087"></a><span id="l19.1087" class="difflineminus">-          transactions.push(txn);</span>
<a href="#l19.1088"></a><span id="l19.1088" class="difflineplus">+        let tag = node.title;</span>
<a href="#l19.1089"></a><span id="l19.1089" class="difflineplus">+        let URIs = PlacesUtils.tagging.getURIsForTag(tag);</span>
<a href="#l19.1090"></a><span id="l19.1090" class="difflineplus">+        if (PlacesUIUtils.useAsyncTransactions) {</span>
<a href="#l19.1091"></a><span id="l19.1091" class="difflineplus">+          transactions.push(PlacesTransactions.Untag({ tag, urls: URIs }));</span>
<a href="#l19.1092"></a><span id="l19.1092" class="difflineplus">+        } else {</span>
<a href="#l19.1093"></a><span id="l19.1093" class="difflineplus">+          for (var j = 0; j &lt; URIs.length; j++) {</span>
<a href="#l19.1094"></a><span id="l19.1094" class="difflineplus">+            let txn = new PlacesUntagURITransaction(URIs[j], [tag]);</span>
<a href="#l19.1095"></a><span id="l19.1095" class="difflineplus">+            transactions.push(txn);</span>
<a href="#l19.1096"></a><span id="l19.1096" class="difflineplus">+          }</span>
<a href="#l19.1097"></a><span id="l19.1097">         }</span>
<a href="#l19.1098"></a><span id="l19.1098" class="difflineminus">-      }</span>
<a href="#l19.1099"></a><span id="l19.1099" class="difflineminus">-      else if (PlacesUtils.nodeIsURI(node) &amp;&amp;</span>
<a href="#l19.1100"></a><span id="l19.1100" class="difflineplus">+      } else if (PlacesUtils.nodeIsURI(node) &amp;&amp;</span>
<a href="#l19.1101"></a><span id="l19.1101">                PlacesUtils.nodeIsQuery(node.parent) &amp;&amp;</span>
<a href="#l19.1102"></a><span id="l19.1102">                PlacesUtils.asQuery(node.parent).queryOptions.queryType ==</span>
<a href="#l19.1103"></a><span id="l19.1103">                  Ci.nsINavHistoryQueryOptions.QUERY_TYPE_HISTORY) {</span>
<a href="#l19.1104"></a><span id="l19.1104">         // This is a uri node inside an history query.</span>
<a href="#l19.1105"></a><span id="l19.1105" class="difflineminus">-        var bhist = PlacesUtils.history.QueryInterface(Ci.nsIBrowserHistory);</span>
<a href="#l19.1106"></a><span id="l19.1106" class="difflineminus">-        bhist.removePage(PlacesUtils._uri(node.uri));</span>
<a href="#l19.1107"></a><span id="l19.1107" class="difflineplus">+        PlacesUtils.history.remove(node.uri).catch(Cu.reportError);</span>
<a href="#l19.1108"></a><span id="l19.1108">         // History deletes are not undoable, so we don't have a transaction.</span>
<a href="#l19.1109"></a><span id="l19.1109" class="difflineminus">-      }</span>
<a href="#l19.1110"></a><span id="l19.1110" class="difflineminus">-      else if (node.itemId == -1 &amp;&amp;</span>
<a href="#l19.1111"></a><span id="l19.1111" class="difflineplus">+      } else if (node.itemId == -1 &amp;&amp;</span>
<a href="#l19.1112"></a><span id="l19.1112">                PlacesUtils.nodeIsQuery(node) &amp;&amp;</span>
<a href="#l19.1113"></a><span id="l19.1113">                PlacesUtils.asQuery(node).queryOptions.queryType ==</span>
<a href="#l19.1114"></a><span id="l19.1114">                  Ci.nsINavHistoryQueryOptions.QUERY_TYPE_HISTORY) {</span>
<a href="#l19.1115"></a><span id="l19.1115">         // This is a dynamically generated history query, like queries</span>
<a href="#l19.1116"></a><span id="l19.1116">         // grouped by site, time or both.  Dynamically generated queries don't</span>
<a href="#l19.1117"></a><span id="l19.1117">         // have an itemId even if they are descendants of a bookmark.</span>
<a href="#l19.1118"></a><span id="l19.1118">         this._removeHistoryContainer(node);</span>
<a href="#l19.1119"></a><span id="l19.1119">         // History deletes are not undoable, so we don't have a transaction.</span>
<a href="#l19.1120"></a><span id="l19.1120" class="difflineminus">-      }</span>
<a href="#l19.1121"></a><span id="l19.1121" class="difflineminus">-      else {</span>
<a href="#l19.1122"></a><span id="l19.1122" class="difflineplus">+      } else {</span>
<a href="#l19.1123"></a><span id="l19.1123">         // This is a common bookmark item.</span>
<a href="#l19.1124"></a><span id="l19.1124">         if (PlacesUtils.nodeIsFolder(node)) {</span>
<a href="#l19.1125"></a><span id="l19.1125">           // If this is a folder we add it to our array of folders, used</span>
<a href="#l19.1126"></a><span id="l19.1126">           // to skip nodes that are children of an already removed folder.</span>
<a href="#l19.1127"></a><span id="l19.1127">           removedFolders.push(node);</span>
<a href="#l19.1128"></a><span id="l19.1128">         }</span>
<a href="#l19.1129"></a><span id="l19.1129" class="difflineminus">-        let txn = new PlacesRemoveItemTransaction(node.itemId);</span>
<a href="#l19.1130"></a><span id="l19.1130" class="difflineminus">-        transactions.push(txn);</span>
<a href="#l19.1131"></a><span id="l19.1131" class="difflineplus">+        if (PlacesUIUtils.useAsyncTransactions) {</span>
<a href="#l19.1132"></a><span id="l19.1132" class="difflineplus">+          transactions.push(</span>
<a href="#l19.1133"></a><span id="l19.1133" class="difflineplus">+            PlacesTransactions.Remove({ guid: node.bookmarkGuid }));</span>
<a href="#l19.1134"></a><span id="l19.1134" class="difflineplus">+        } else {</span>
<a href="#l19.1135"></a><span id="l19.1135" class="difflineplus">+          let txn = new PlacesRemoveItemTransaction(node.itemId);</span>
<a href="#l19.1136"></a><span id="l19.1136" class="difflineplus">+          transactions.push(txn);</span>
<a href="#l19.1137"></a><span id="l19.1137" class="difflineplus">+        }</span>
<a href="#l19.1138"></a><span id="l19.1138">       }</span>
<a href="#l19.1139"></a><span id="l19.1139">     }</span>
<a href="#l19.1140"></a><span id="l19.1140">   },</span>
<a href="#l19.1141"></a><span id="l19.1141"> </span>
<a href="#l19.1142"></a><span id="l19.1142">   /**</span>
<a href="#l19.1143"></a><span id="l19.1143">    * Removes the set of selected ranges from bookmarks.</span>
<a href="#l19.1144"></a><span id="l19.1144">    * @param   txnName</span>
<a href="#l19.1145"></a><span id="l19.1145">    *          See |remove|.</span>
<a href="#l19.1146"></a><span id="l19.1146">    */</span>
<a href="#l19.1147"></a><span id="l19.1147" class="difflineminus">-  _removeRowsFromBookmarks: function PC__removeRowsFromBookmarks(txnName) {</span>
<a href="#l19.1148"></a><span id="l19.1148" class="difflineplus">+  async _removeRowsFromBookmarks(txnName) {</span>
<a href="#l19.1149"></a><span id="l19.1149">     var ranges = this._view.removableSelectionRanges;</span>
<a href="#l19.1150"></a><span id="l19.1150">     var transactions = [];</span>
<a href="#l19.1151"></a><span id="l19.1151">     var removedFolders = [];</span>
<a href="#l19.1152"></a><span id="l19.1152"> </span>
<a href="#l19.1153"></a><span id="l19.1153">     for (var i = 0; i &lt; ranges.length; i++)</span>
<a href="#l19.1154"></a><span id="l19.1154">       this._removeRange(ranges[i], transactions, removedFolders);</span>
<a href="#l19.1155"></a><span id="l19.1155"> </span>
<a href="#l19.1156"></a><span id="l19.1156">     if (transactions.length &gt; 0) {</span>
<a href="#l19.1157"></a><span id="l19.1157" class="difflineminus">-      var txn = new PlacesAggregatedTransaction(txnName, transactions);</span>
<a href="#l19.1158"></a><span id="l19.1158" class="difflineminus">-      PlacesUtils.transactionManager.doTransaction(txn);</span>
<a href="#l19.1159"></a><span id="l19.1159" class="difflineplus">+      if (PlacesUIUtils.useAsyncTransactions) {</span>
<a href="#l19.1160"></a><span id="l19.1160" class="difflineplus">+        await PlacesTransactions.batch(transactions);</span>
<a href="#l19.1161"></a><span id="l19.1161" class="difflineplus">+      } else {</span>
<a href="#l19.1162"></a><span id="l19.1162" class="difflineplus">+        var txn = new PlacesAggregatedTransaction(txnName, transactions);</span>
<a href="#l19.1163"></a><span id="l19.1163" class="difflineplus">+        PlacesUtils.transactionManager.doTransaction(txn);</span>
<a href="#l19.1164"></a><span id="l19.1164" class="difflineplus">+      }</span>
<a href="#l19.1165"></a><span id="l19.1165">     }</span>
<a href="#l19.1166"></a><span id="l19.1166">   },</span>
<a href="#l19.1167"></a><span id="l19.1167"> </span>
<a href="#l19.1168"></a><span id="l19.1168">   /**</span>
<a href="#l19.1169"></a><span id="l19.1169" class="difflineminus">-   * Removes the set of selected ranges from history.</span>
<a href="#l19.1170"></a><span id="l19.1170" class="difflineplus">+   * Removes the set of selected ranges from history, asynchronously.</span>
<a href="#l19.1171"></a><span id="l19.1171" class="difflineplus">+   *</span>
<a href="#l19.1172"></a><span id="l19.1172" class="difflineplus">+   * @note history deletes are not undoable.</span>
<a href="#l19.1173"></a><span id="l19.1173">    */</span>
<a href="#l19.1174"></a><span id="l19.1174">   _removeRowsFromHistory: function PC__removeRowsFromHistory() {</span>
<a href="#l19.1175"></a><span id="l19.1175" class="difflineminus">-    // Other containers are history queries, just delete from history</span>
<a href="#l19.1176"></a><span id="l19.1176" class="difflineminus">-    // history deletes are not undoable.</span>
<a href="#l19.1177"></a><span id="l19.1177" class="difflineminus">-    var nodes = this._view.selectedNodes;</span>
<a href="#l19.1178"></a><span id="l19.1178" class="difflineminus">-    var URIs = [];</span>
<a href="#l19.1179"></a><span id="l19.1179" class="difflineminus">-    var bhist = PlacesUtils.history.QueryInterface(Ci.nsIBrowserHistory);</span>
<a href="#l19.1180"></a><span id="l19.1180" class="difflineminus">-    var root = this._view.result.root;</span>
<a href="#l19.1181"></a><span id="l19.1181" class="difflineminus">-</span>
<a href="#l19.1182"></a><span id="l19.1182" class="difflineminus">-    for (var i = 0; i &lt; nodes.length; ++i) {</span>
<a href="#l19.1183"></a><span id="l19.1183" class="difflineminus">-      var node = nodes[i];</span>
<a href="#l19.1184"></a><span id="l19.1184" class="difflineplus">+    let nodes = this._view.selectedNodes;</span>
<a href="#l19.1185"></a><span id="l19.1185" class="difflineplus">+    let URIs = new Set();</span>
<a href="#l19.1186"></a><span id="l19.1186" class="difflineplus">+    for (let i = 0; i &lt; nodes.length; ++i) {</span>
<a href="#l19.1187"></a><span id="l19.1187" class="difflineplus">+      let node = nodes[i];</span>
<a href="#l19.1188"></a><span id="l19.1188">       if (PlacesUtils.nodeIsURI(node)) {</span>
<a href="#l19.1189"></a><span id="l19.1189" class="difflineminus">-        var uri = PlacesUtils._uri(node.uri);</span>
<a href="#l19.1190"></a><span id="l19.1190" class="difflineminus">-        // avoid trying to delete the same url twice</span>
<a href="#l19.1191"></a><span id="l19.1191" class="difflineminus">-        if (URIs.indexOf(uri) &lt; 0) {</span>
<a href="#l19.1192"></a><span id="l19.1192" class="difflineminus">-          URIs.push(uri);</span>
<a href="#l19.1193"></a><span id="l19.1193" class="difflineminus">-        }</span>
<a href="#l19.1194"></a><span id="l19.1194" class="difflineplus">+        URIs.add(node.uri);</span>
<a href="#l19.1195"></a><span id="l19.1195" class="difflineplus">+      } else if (PlacesUtils.nodeIsQuery(node) &amp;&amp;</span>
<a href="#l19.1196"></a><span id="l19.1196" class="difflineplus">+               PlacesUtils.asQuery(node).queryOptions.queryType ==</span>
<a href="#l19.1197"></a><span id="l19.1197" class="difflineplus">+                 Ci.nsINavHistoryQueryOptions.QUERY_TYPE_HISTORY) {</span>
<a href="#l19.1198"></a><span id="l19.1198" class="difflineplus">+        this._removeHistoryContainer(node);</span>
<a href="#l19.1199"></a><span id="l19.1199">       }</span>
<a href="#l19.1200"></a><span id="l19.1200" class="difflineminus">-      else if (PlacesUtils.nodeIsQuery(node) &amp;&amp;</span>
<a href="#l19.1201"></a><span id="l19.1201" class="difflineminus">-               PlacesUtils.asQuery(node).queryOptions.queryType ==</span>
<a href="#l19.1202"></a><span id="l19.1202" class="difflineminus">-                 Ci.nsINavHistoryQueryOptions.QUERY_TYPE_HISTORY)</span>
<a href="#l19.1203"></a><span id="l19.1203" class="difflineminus">-        this._removeHistoryContainer(node);</span>
<a href="#l19.1204"></a><span id="l19.1204">     }</span>
<a href="#l19.1205"></a><span id="l19.1205"> </span>
<a href="#l19.1206"></a><span id="l19.1206" class="difflineminus">-    // if we have to delete a lot of urls RemovePage will be slow, it's better</span>
<a href="#l19.1207"></a><span id="l19.1207" class="difflineminus">-    // to delete them in bunch and rebuild the full treeView</span>
<a href="#l19.1208"></a><span id="l19.1208" class="difflineminus">-    if (URIs.length &gt; REMOVE_PAGES_MAX_SINGLEREMOVES) {</span>
<a href="#l19.1209"></a><span id="l19.1209" class="difflineminus">-      // do removal in chunks to avoid passing a too big array to removePages</span>
<a href="#l19.1210"></a><span id="l19.1210" class="difflineminus">-      for (var i = 0; i &lt; URIs.length; i += REMOVE_PAGES_CHUNKLEN) {</span>
<a href="#l19.1211"></a><span id="l19.1211" class="difflineminus">-        var URIslice = URIs.slice(i, i + REMOVE_PAGES_CHUNKLEN);</span>
<a href="#l19.1212"></a><span id="l19.1212" class="difflineminus">-        // set DoBatchNotify (third param) only on the last chunk, so we update</span>
<a href="#l19.1213"></a><span id="l19.1213" class="difflineminus">-        // the treeView when we are done.</span>
<a href="#l19.1214"></a><span id="l19.1214" class="difflineminus">-        bhist.removePages(URIslice, URIslice.length,</span>
<a href="#l19.1215"></a><span id="l19.1215" class="difflineminus">-                          (i + REMOVE_PAGES_CHUNKLEN) &gt;= URIs.length);</span>
<a href="#l19.1216"></a><span id="l19.1216" class="difflineminus">-      }</span>
<a href="#l19.1217"></a><span id="l19.1217" class="difflineminus">-    }</span>
<a href="#l19.1218"></a><span id="l19.1218" class="difflineminus">-    else {</span>
<a href="#l19.1219"></a><span id="l19.1219" class="difflineminus">-      // if we have to delete fewer urls, removepage will allow us to avoid</span>
<a href="#l19.1220"></a><span id="l19.1220" class="difflineminus">-      // rebuilding the full treeView</span>
<a href="#l19.1221"></a><span id="l19.1221" class="difflineminus">-      for (var i = 0; i &lt; URIs.length; ++i)</span>
<a href="#l19.1222"></a><span id="l19.1222" class="difflineminus">-        bhist.removePage(URIs[i]);</span>
<a href="#l19.1223"></a><span id="l19.1223" class="difflineminus">-    }</span>
<a href="#l19.1224"></a><span id="l19.1224" class="difflineplus">+    PlacesUtils.history.remove([...URIs]).catch(Cu.reportError);</span>
<a href="#l19.1225"></a><span id="l19.1225">   },</span>
<a href="#l19.1226"></a><span id="l19.1226"> </span>
<a href="#l19.1227"></a><span id="l19.1227">   /**</span>
<a href="#l19.1228"></a><span id="l19.1228">    * Removes history visits for an history container node.</span>
<a href="#l19.1229"></a><span id="l19.1229">    * @param   [in] aContainerNode</span>
<a href="#l19.1230"></a><span id="l19.1230">    *          The container node to remove.</span>
<a href="#l19.1231"></a><span id="l19.1231" class="difflineplus">+   *</span>
<a href="#l19.1232"></a><span id="l19.1232" class="difflineplus">+   * @note history deletes are not undoable.</span>
<a href="#l19.1233"></a><span id="l19.1233">    */</span>
<a href="#l19.1234"></a><span id="l19.1234" class="difflineminus">-  _removeHistoryContainer: function PC_removeHistoryContainer(aContainerNode) {</span>
<a href="#l19.1235"></a><span id="l19.1235" class="difflineminus">-    var bhist = PlacesUtils.history.QueryInterface(Ci.nsIBrowserHistory);</span>
<a href="#l19.1236"></a><span id="l19.1236" class="difflineplus">+  _removeHistoryContainer: function PC__removeHistoryContainer(aContainerNode) {</span>
<a href="#l19.1237"></a><span id="l19.1237">     if (PlacesUtils.nodeIsHost(aContainerNode)) {</span>
<a href="#l19.1238"></a><span id="l19.1238">       // Site container.</span>
<a href="#l19.1239"></a><span id="l19.1239" class="difflineminus">-      bhist.removePagesFromHost(aContainerNode.title, true);</span>
<a href="#l19.1240"></a><span id="l19.1240" class="difflineminus">-    }</span>
<a href="#l19.1241"></a><span id="l19.1241" class="difflineminus">-    else if (PlacesUtils.nodeIsDay(aContainerNode)) {</span>
<a href="#l19.1242"></a><span id="l19.1242" class="difflineplus">+      PlacesUtils.bhistory.removePagesFromHost(aContainerNode.title, true);</span>
<a href="#l19.1243"></a><span id="l19.1243" class="difflineplus">+    } else if (PlacesUtils.nodeIsDay(aContainerNode)) {</span>
<a href="#l19.1244"></a><span id="l19.1244">       // Day container.</span>
<a href="#l19.1245"></a><span id="l19.1245" class="difflineminus">-      var query = aContainerNode.getQueries()[0];</span>
<a href="#l19.1246"></a><span id="l19.1246" class="difflineminus">-      var beginTime = query.beginTime;</span>
<a href="#l19.1247"></a><span id="l19.1247" class="difflineminus">-      var endTime = query.endTime;</span>
<a href="#l19.1248"></a><span id="l19.1248" class="difflineplus">+      let query = aContainerNode.getQueries()[0];</span>
<a href="#l19.1249"></a><span id="l19.1249" class="difflineplus">+      let beginTime = query.beginTime;</span>
<a href="#l19.1250"></a><span id="l19.1250" class="difflineplus">+      let endTime = query.endTime;</span>
<a href="#l19.1251"></a><span id="l19.1251">       NS_ASSERT(query &amp;&amp; beginTime &amp;&amp; endTime,</span>
<a href="#l19.1252"></a><span id="l19.1252">                 &quot;A valid date container query should exist!&quot;);</span>
<a href="#l19.1253"></a><span id="l19.1253">       // We want to exclude beginTime from the removal because</span>
<a href="#l19.1254"></a><span id="l19.1254">       // removePagesByTimeframe includes both extremes, while date containers</span>
<a href="#l19.1255"></a><span id="l19.1255">       // exclude the lower extreme.  So, if we would not exclude it, we would</span>
<a href="#l19.1256"></a><span id="l19.1256">       // end up removing more history than requested.</span>
<a href="#l19.1257"></a><span id="l19.1257" class="difflineminus">-      bhist.removePagesByTimeframe(beginTime+1, endTime);</span>
<a href="#l19.1258"></a><span id="l19.1258" class="difflineplus">+      PlacesUtils.bhistory.removePagesByTimeframe(beginTime + 1, endTime);</span>
<a href="#l19.1259"></a><span id="l19.1259">     }</span>
<a href="#l19.1260"></a><span id="l19.1260">   },</span>
<a href="#l19.1261"></a><span id="l19.1261"> </span>
<a href="#l19.1262"></a><span id="l19.1262">   /**</span>
<a href="#l19.1263"></a><span id="l19.1263">    * Removes the selection</span>
<a href="#l19.1264"></a><span id="l19.1264">    * @param   aTxnName</span>
<a href="#l19.1265"></a><span id="l19.1265">    *          A name for the transaction if this is being performed</span>
<a href="#l19.1266"></a><span id="l19.1266">    *          as part of another operation.</span>
<a href="#l19.1267"></a><span id="l19.1267">    */</span>
<a href="#l19.1268"></a><span id="l19.1268" class="difflineminus">-  remove: function PC_remove(aTxnName) {</span>
<a href="#l19.1269"></a><span id="l19.1269" class="difflineplus">+  async remove(aTxnName) {</span>
<a href="#l19.1270"></a><span id="l19.1270">     if (!this._hasRemovableSelection())</span>
<a href="#l19.1271"></a><span id="l19.1271">       return;</span>
<a href="#l19.1272"></a><span id="l19.1272"> </span>
<a href="#l19.1273"></a><span id="l19.1273">     NS_ASSERT(aTxnName !== undefined, &quot;Must supply Transaction Name&quot;);</span>
<a href="#l19.1274"></a><span id="l19.1274"> </span>
<a href="#l19.1275"></a><span id="l19.1275">     var root = this._view.result.root;</span>
<a href="#l19.1276"></a><span id="l19.1276"> </span>
<a href="#l19.1277"></a><span id="l19.1277" class="difflineminus">-    if (PlacesUtils.nodeIsFolder(root))</span>
<a href="#l19.1278"></a><span id="l19.1278" class="difflineminus">-      this._removeRowsFromBookmarks(aTxnName);</span>
<a href="#l19.1279"></a><span id="l19.1279" class="difflineminus">-    else if (PlacesUtils.nodeIsQuery(root)) {</span>
<a href="#l19.1280"></a><span id="l19.1280" class="difflineminus">-      var queryType = PlacesUtils.asQuery(root).queryOptions.queryType;</span>
<a href="#l19.1281"></a><span id="l19.1281" class="difflineminus">-      if (queryType == Ci.nsINavHistoryQueryOptions.QUERY_TYPE_BOOKMARKS)</span>
<a href="#l19.1282"></a><span id="l19.1282" class="difflineplus">+    if (PlacesUtils.nodeIsFolder(root)) {</span>
<a href="#l19.1283"></a><span id="l19.1283" class="difflineplus">+      if (PlacesUIUtils.useAsyncTransactions)</span>
<a href="#l19.1284"></a><span id="l19.1284" class="difflineplus">+        await this._removeRowsFromBookmarks(aTxnName);</span>
<a href="#l19.1285"></a><span id="l19.1285" class="difflineplus">+      else</span>
<a href="#l19.1286"></a><span id="l19.1286">         this._removeRowsFromBookmarks(aTxnName);</span>
<a href="#l19.1287"></a><span id="l19.1287" class="difflineminus">-      else if (queryType == Ci.nsINavHistoryQueryOptions.QUERY_TYPE_HISTORY)</span>
<a href="#l19.1288"></a><span id="l19.1288" class="difflineplus">+    } else if (PlacesUtils.nodeIsQuery(root)) {</span>
<a href="#l19.1289"></a><span id="l19.1289" class="difflineplus">+      var queryType = PlacesUtils.asQuery(root).queryOptions.queryType;</span>
<a href="#l19.1290"></a><span id="l19.1290" class="difflineplus">+      if (queryType == Ci.nsINavHistoryQueryOptions.QUERY_TYPE_BOOKMARKS) {</span>
<a href="#l19.1291"></a><span id="l19.1291" class="difflineplus">+        if (PlacesUIUtils.useAsyncTransactions)</span>
<a href="#l19.1292"></a><span id="l19.1292" class="difflineplus">+          await this._removeRowsFromBookmarks(aTxnName);</span>
<a href="#l19.1293"></a><span id="l19.1293" class="difflineplus">+        else</span>
<a href="#l19.1294"></a><span id="l19.1294" class="difflineplus">+          this._removeRowsFromBookmarks(aTxnName);</span>
<a href="#l19.1295"></a><span id="l19.1295" class="difflineplus">+      } else if (queryType == Ci.nsINavHistoryQueryOptions.QUERY_TYPE_HISTORY) {</span>
<a href="#l19.1296"></a><span id="l19.1296">         this._removeRowsFromHistory();</span>
<a href="#l19.1297"></a><span id="l19.1297" class="difflineminus">-      else</span>
<a href="#l19.1298"></a><span id="l19.1298" class="difflineplus">+      } else {</span>
<a href="#l19.1299"></a><span id="l19.1299">         NS_ASSERT(false, &quot;implement support for QUERY_TYPE_UNIFIED&quot;);</span>
<a href="#l19.1300"></a><span id="l19.1300" class="difflineminus">-    }</span>
<a href="#l19.1301"></a><span id="l19.1301" class="difflineminus">-    else</span>
<a href="#l19.1302"></a><span id="l19.1302" class="difflineplus">+      }</span>
<a href="#l19.1303"></a><span id="l19.1303" class="difflineplus">+    } else</span>
<a href="#l19.1304"></a><span id="l19.1304">       NS_ASSERT(false, &quot;unexpected root&quot;);</span>
<a href="#l19.1305"></a><span id="l19.1305">   },</span>
<a href="#l19.1306"></a><span id="l19.1306"> </span>
<a href="#l19.1307"></a><span id="l19.1307">   /**</span>
<a href="#l19.1308"></a><span id="l19.1308">    * Fills a DataTransfer object with the content of the selection that can be</span>
<a href="#l19.1309"></a><span id="l19.1309">    * dropped elsewhere.</span>
<a href="#l19.1310"></a><span id="l19.1310">    * @param   aEvent</span>
<a href="#l19.1311"></a><span id="l19.1311">    *          The dragstart event.</span>
<a href="#l19.1312"></a><span id="l19.1312">    */</span>
<a href="#l19.1313"></a><span id="l19.1313">   setDataTransfer: function PC_setDataTransfer(aEvent) {</span>
<a href="#l19.1314"></a><span id="l19.1314">     let dt = aEvent.dataTransfer;</span>
<a href="#l19.1315"></a><span id="l19.1315" class="difflineminus">-    let doCopy = [&quot;copyLink&quot;, &quot;copy&quot;, &quot;link&quot;].indexOf(dt.effectAllowed) != -1;</span>
<a href="#l19.1316"></a><span id="l19.1316"> </span>
<a href="#l19.1317"></a><span id="l19.1317">     let result = this._view.result;</span>
<a href="#l19.1318"></a><span id="l19.1318">     let didSuppressNotifications = result.suppressNotifications;</span>
<a href="#l19.1319"></a><span id="l19.1319">     if (!didSuppressNotifications)</span>
<a href="#l19.1320"></a><span id="l19.1320">       result.suppressNotifications = true;</span>
<a href="#l19.1321"></a><span id="l19.1321"> </span>
<a href="#l19.1322"></a><span id="l19.1322" class="difflineplus">+    function addData(type, index, feedURI) {</span>
<a href="#l19.1323"></a><span id="l19.1323" class="difflineplus">+      let wrapNode = PlacesUtils.wrapNode(node, type, feedURI);</span>
<a href="#l19.1324"></a><span id="l19.1324" class="difflineplus">+      dt.mozSetDataAt(type, wrapNode, index);</span>
<a href="#l19.1325"></a><span id="l19.1325" class="difflineplus">+    }</span>
<a href="#l19.1326"></a><span id="l19.1326" class="difflineplus">+</span>
<a href="#l19.1327"></a><span id="l19.1327" class="difflineplus">+    function addURIData(index, feedURI) {</span>
<a href="#l19.1328"></a><span id="l19.1328" class="difflineplus">+      addData(PlacesUtils.TYPE_X_MOZ_URL, index, feedURI);</span>
<a href="#l19.1329"></a><span id="l19.1329" class="difflineplus">+      addData(PlacesUtils.TYPE_UNICODE, index, feedURI);</span>
<a href="#l19.1330"></a><span id="l19.1330" class="difflineplus">+      addData(PlacesUtils.TYPE_HTML, index, feedURI);</span>
<a href="#l19.1331"></a><span id="l19.1331" class="difflineplus">+    }</span>
<a href="#l19.1332"></a><span id="l19.1332" class="difflineplus">+</span>
<a href="#l19.1333"></a><span id="l19.1333">     try {</span>
<a href="#l19.1334"></a><span id="l19.1334">       let nodes = this._view.draggableSelection;</span>
<a href="#l19.1335"></a><span id="l19.1335">       for (let i = 0; i &lt; nodes.length; ++i) {</span>
<a href="#l19.1336"></a><span id="l19.1336">         var node = nodes[i];</span>
<a href="#l19.1337"></a><span id="l19.1337"> </span>
<a href="#l19.1338"></a><span id="l19.1338" class="difflineminus">-        function addData(type, index, overrideURI) {</span>
<a href="#l19.1339"></a><span id="l19.1339" class="difflineminus">-          let wrapNode = PlacesUtils.wrapNode(node, type, overrideURI, doCopy);</span>
<a href="#l19.1340"></a><span id="l19.1340" class="difflineminus">-          dt.mozSetDataAt(type, wrapNode, index);</span>
<a href="#l19.1341"></a><span id="l19.1341" class="difflineminus">-        }</span>
<a href="#l19.1342"></a><span id="l19.1342" class="difflineminus">-</span>
<a href="#l19.1343"></a><span id="l19.1343" class="difflineminus">-        function addURIData(index, overrideURI) {</span>
<a href="#l19.1344"></a><span id="l19.1344" class="difflineminus">-          addData(PlacesUtils.TYPE_X_MOZ_URL, index, overrideURI);</span>
<a href="#l19.1345"></a><span id="l19.1345" class="difflineminus">-          addData(PlacesUtils.TYPE_UNICODE, index, overrideURI);</span>
<a href="#l19.1346"></a><span id="l19.1346" class="difflineminus">-          addData(PlacesUtils.TYPE_HTML, index, overrideURI);</span>
<a href="#l19.1347"></a><span id="l19.1347" class="difflineminus">-        }</span>
<a href="#l19.1348"></a><span id="l19.1348" class="difflineminus">-</span>
<a href="#l19.1349"></a><span id="l19.1349">         // This order is _important_! It controls how this and other</span>
<a href="#l19.1350"></a><span id="l19.1350">         // applications select data to be inserted based on type.</span>
<a href="#l19.1351"></a><span id="l19.1351">         addData(PlacesUtils.TYPE_X_MOZ_PLACE, i);</span>
<a href="#l19.1352"></a><span id="l19.1352"> </span>
<a href="#l19.1353"></a><span id="l19.1353">         // Drop the feed uri for livemark containers</span>
<a href="#l19.1354"></a><span id="l19.1354">         let livemarkInfo = this.getCachedLivemarkInfo(node);</span>
<a href="#l19.1355"></a><span id="l19.1355" class="difflineminus">-        if (livemarkInfo)</span>
<a href="#l19.1356"></a><span id="l19.1356" class="difflineplus">+        if (livemarkInfo) {</span>
<a href="#l19.1357"></a><span id="l19.1357">           addURIData(i, livemarkInfo.feedURI.spec);</span>
<a href="#l19.1358"></a><span id="l19.1358" class="difflineminus">-        else if (node.uri)</span>
<a href="#l19.1359"></a><span id="l19.1359" class="difflineplus">+        } else if (node.uri) {</span>
<a href="#l19.1360"></a><span id="l19.1360">           addURIData(i);</span>
<a href="#l19.1361"></a><span id="l19.1361" class="difflineplus">+        }</span>
<a href="#l19.1362"></a><span id="l19.1362">       }</span>
<a href="#l19.1363"></a><span id="l19.1363" class="difflineminus">-    }</span>
<a href="#l19.1364"></a><span id="l19.1364" class="difflineminus">-    finally {</span>
<a href="#l19.1365"></a><span id="l19.1365" class="difflineplus">+    } finally {</span>
<a href="#l19.1366"></a><span id="l19.1366">       if (!didSuppressNotifications)</span>
<a href="#l19.1367"></a><span id="l19.1367">         result.suppressNotifications = false;</span>
<a href="#l19.1368"></a><span id="l19.1368">     }</span>
<a href="#l19.1369"></a><span id="l19.1369">   },</span>
<a href="#l19.1370"></a><span id="l19.1370"> </span>
<a href="#l19.1371"></a><span id="l19.1371" class="difflineplus">+  get clipboardAction() {</span>
<a href="#l19.1372"></a><span id="l19.1372" class="difflineplus">+    let action = {};</span>
<a href="#l19.1373"></a><span id="l19.1373" class="difflineplus">+    let actionOwner;</span>
<a href="#l19.1374"></a><span id="l19.1374" class="difflineplus">+    try {</span>
<a href="#l19.1375"></a><span id="l19.1375" class="difflineplus">+      let xferable = Cc[&quot;@mozilla.org/widget/transferable;1&quot;]</span>
<a href="#l19.1376"></a><span id="l19.1376" class="difflineplus">+                       .createInstance(Ci.nsITransferable);</span>
<a href="#l19.1377"></a><span id="l19.1377" class="difflineplus">+      xferable.init(null);</span>
<a href="#l19.1378"></a><span id="l19.1378" class="difflineplus">+      xferable.addDataFlavor(PlacesUtils.TYPE_X_MOZ_PLACE_ACTION)</span>
<a href="#l19.1379"></a><span id="l19.1379" class="difflineplus">+      this.clipboard.getData(xferable, Ci.nsIClipboard.kGlobalClipboard);</span>
<a href="#l19.1380"></a><span id="l19.1380" class="difflineplus">+      xferable.getTransferData(PlacesUtils.TYPE_X_MOZ_PLACE_ACTION, action, {});</span>
<a href="#l19.1381"></a><span id="l19.1381" class="difflineplus">+      [action, actionOwner] =</span>
<a href="#l19.1382"></a><span id="l19.1382" class="difflineplus">+        action.value.QueryInterface(Ci.nsISupportsString).data.split(&quot;,&quot;);</span>
<a href="#l19.1383"></a><span id="l19.1383" class="difflineplus">+    } catch (ex) {</span>
<a href="#l19.1384"></a><span id="l19.1384" class="difflineplus">+      // Paste from external sources don't have any associated action, just</span>
<a href="#l19.1385"></a><span id="l19.1385" class="difflineplus">+      // fallback to a copy action.</span>
<a href="#l19.1386"></a><span id="l19.1386" class="difflineplus">+      return &quot;copy&quot;;</span>
<a href="#l19.1387"></a><span id="l19.1387" class="difflineplus">+    }</span>
<a href="#l19.1388"></a><span id="l19.1388" class="difflineplus">+    // For cuts also check who inited the action, since cuts across different</span>
<a href="#l19.1389"></a><span id="l19.1389" class="difflineplus">+    // instances should instead be handled as copies (The sources are not</span>
<a href="#l19.1390"></a><span id="l19.1390" class="difflineplus">+    // available for this instance).</span>
<a href="#l19.1391"></a><span id="l19.1391" class="difflineplus">+    if (action == &quot;cut&quot; &amp;&amp; actionOwner != this.profileName)</span>
<a href="#l19.1392"></a><span id="l19.1392" class="difflineplus">+      action = &quot;copy&quot;;</span>
<a href="#l19.1393"></a><span id="l19.1393" class="difflineplus">+</span>
<a href="#l19.1394"></a><span id="l19.1394" class="difflineplus">+    return action;</span>
<a href="#l19.1395"></a><span id="l19.1395" class="difflineplus">+  },</span>
<a href="#l19.1396"></a><span id="l19.1396" class="difflineplus">+</span>
<a href="#l19.1397"></a><span id="l19.1397" class="difflineplus">+  _releaseClipboardOwnership: function PC__releaseClipboardOwnership() {</span>
<a href="#l19.1398"></a><span id="l19.1398" class="difflineplus">+    if (this.cutNodes.length &gt; 0) {</span>
<a href="#l19.1399"></a><span id="l19.1399" class="difflineplus">+      // This clears the logical clipboard, doesn't remove data.</span>
<a href="#l19.1400"></a><span id="l19.1400" class="difflineplus">+      this.clipboard.emptyClipboard(Ci.nsIClipboard.kGlobalClipboard);</span>
<a href="#l19.1401"></a><span id="l19.1401" class="difflineplus">+    }</span>
<a href="#l19.1402"></a><span id="l19.1402" class="difflineplus">+  },</span>
<a href="#l19.1403"></a><span id="l19.1403" class="difflineplus">+</span>
<a href="#l19.1404"></a><span id="l19.1404" class="difflineplus">+  _clearClipboard: function PC__clearClipboard() {</span>
<a href="#l19.1405"></a><span id="l19.1405" class="difflineplus">+    let xferable = Cc[&quot;@mozilla.org/widget/transferable;1&quot;]</span>
<a href="#l19.1406"></a><span id="l19.1406" class="difflineplus">+                     .createInstance(Ci.nsITransferable);</span>
<a href="#l19.1407"></a><span id="l19.1407" class="difflineplus">+    xferable.init(null);</span>
<a href="#l19.1408"></a><span id="l19.1408" class="difflineplus">+    // Empty transferables may cause crashes, so just add an unknown type.</span>
<a href="#l19.1409"></a><span id="l19.1409" class="difflineplus">+    const TYPE = &quot;text/x-moz-place-empty&quot;;</span>
<a href="#l19.1410"></a><span id="l19.1410" class="difflineplus">+    xferable.addDataFlavor(TYPE);</span>
<a href="#l19.1411"></a><span id="l19.1411" class="difflineplus">+    xferable.setTransferData(TYPE, PlacesUtils.toISupportsString(&quot;&quot;), 0);</span>
<a href="#l19.1412"></a><span id="l19.1412" class="difflineplus">+    this.clipboard.setData(xferable, null, Ci.nsIClipboard.kGlobalClipboard);</span>
<a href="#l19.1413"></a><span id="l19.1413" class="difflineplus">+  },</span>
<a href="#l19.1414"></a><span id="l19.1414" class="difflineplus">+</span>
<a href="#l19.1415"></a><span id="l19.1415" class="difflineplus">+  _populateClipboard: function PC__populateClipboard(aNodes, aAction) {</span>
<a href="#l19.1416"></a><span id="l19.1416" class="difflineplus">+    // This order is _important_! It controls how this and other applications</span>
<a href="#l19.1417"></a><span id="l19.1417" class="difflineplus">+    // select data to be inserted based on type.</span>
<a href="#l19.1418"></a><span id="l19.1418" class="difflineplus">+    let contents = [</span>
<a href="#l19.1419"></a><span id="l19.1419" class="difflineplus">+      { type: PlacesUtils.TYPE_X_MOZ_PLACE, entries: [] },</span>
<a href="#l19.1420"></a><span id="l19.1420" class="difflineplus">+      { type: PlacesUtils.TYPE_X_MOZ_URL, entries: [] },</span>
<a href="#l19.1421"></a><span id="l19.1421" class="difflineplus">+      { type: PlacesUtils.TYPE_HTML, entries: [] },</span>
<a href="#l19.1422"></a><span id="l19.1422" class="difflineplus">+      { type: PlacesUtils.TYPE_UNICODE, entries: [] },</span>
<a href="#l19.1423"></a><span id="l19.1423" class="difflineplus">+    ];</span>
<a href="#l19.1424"></a><span id="l19.1424" class="difflineplus">+</span>
<a href="#l19.1425"></a><span id="l19.1425" class="difflineplus">+    // Avoid handling descendants of a copied node, the transactions take care</span>
<a href="#l19.1426"></a><span id="l19.1426" class="difflineplus">+    // of them automatically.</span>
<a href="#l19.1427"></a><span id="l19.1427" class="difflineplus">+    let copiedFolders = [];</span>
<a href="#l19.1428"></a><span id="l19.1428" class="difflineplus">+    aNodes.forEach(function(node) {</span>
<a href="#l19.1429"></a><span id="l19.1429" class="difflineplus">+      if (this._shouldSkipNode(node, copiedFolders))</span>
<a href="#l19.1430"></a><span id="l19.1430" class="difflineplus">+        return;</span>
<a href="#l19.1431"></a><span id="l19.1431" class="difflineplus">+      if (PlacesUtils.nodeIsFolder(node))</span>
<a href="#l19.1432"></a><span id="l19.1432" class="difflineplus">+        copiedFolders.push(node);</span>
<a href="#l19.1433"></a><span id="l19.1433" class="difflineplus">+</span>
<a href="#l19.1434"></a><span id="l19.1434" class="difflineplus">+      let livemarkInfo = this.getCachedLivemarkInfo(node);</span>
<a href="#l19.1435"></a><span id="l19.1435" class="difflineplus">+      let feedURI = livemarkInfo &amp;&amp; livemarkInfo.feedURI.spec;</span>
<a href="#l19.1436"></a><span id="l19.1436" class="difflineplus">+</span>
<a href="#l19.1437"></a><span id="l19.1437" class="difflineplus">+      contents.forEach(function(content) {</span>
<a href="#l19.1438"></a><span id="l19.1438" class="difflineplus">+        content.entries.push(</span>
<a href="#l19.1439"></a><span id="l19.1439" class="difflineplus">+          PlacesUtils.wrapNode(node, content.type, feedURI)</span>
<a href="#l19.1440"></a><span id="l19.1440" class="difflineplus">+        );</span>
<a href="#l19.1441"></a><span id="l19.1441" class="difflineplus">+      });</span>
<a href="#l19.1442"></a><span id="l19.1442" class="difflineplus">+    }, this);</span>
<a href="#l19.1443"></a><span id="l19.1443" class="difflineplus">+</span>
<a href="#l19.1444"></a><span id="l19.1444" class="difflineplus">+    function addData(type, data) {</span>
<a href="#l19.1445"></a><span id="l19.1445" class="difflineplus">+      xferable.addDataFlavor(type);</span>
<a href="#l19.1446"></a><span id="l19.1446" class="difflineplus">+      xferable.setTransferData(type, PlacesUtils.toISupportsString(data),</span>
<a href="#l19.1447"></a><span id="l19.1447" class="difflineplus">+                               data.length * 2);</span>
<a href="#l19.1448"></a><span id="l19.1448" class="difflineplus">+    }</span>
<a href="#l19.1449"></a><span id="l19.1449" class="difflineplus">+</span>
<a href="#l19.1450"></a><span id="l19.1450" class="difflineplus">+    let xferable = Cc[&quot;@mozilla.org/widget/transferable;1&quot;]</span>
<a href="#l19.1451"></a><span id="l19.1451" class="difflineplus">+                     .createInstance(Ci.nsITransferable);</span>
<a href="#l19.1452"></a><span id="l19.1452" class="difflineplus">+    xferable.init(null);</span>
<a href="#l19.1453"></a><span id="l19.1453" class="difflineplus">+    let hasData = false;</span>
<a href="#l19.1454"></a><span id="l19.1454" class="difflineplus">+    // This order matters here!  It controls how this and other applications</span>
<a href="#l19.1455"></a><span id="l19.1455" class="difflineplus">+    // select data to be inserted based on type.</span>
<a href="#l19.1456"></a><span id="l19.1456" class="difflineplus">+    contents.forEach(function(content) {</span>
<a href="#l19.1457"></a><span id="l19.1457" class="difflineplus">+      if (content.entries.length &gt; 0) {</span>
<a href="#l19.1458"></a><span id="l19.1458" class="difflineplus">+        hasData = true;</span>
<a href="#l19.1459"></a><span id="l19.1459" class="difflineplus">+        let glue =</span>
<a href="#l19.1460"></a><span id="l19.1460" class="difflineplus">+          content.type == PlacesUtils.TYPE_X_MOZ_PLACE ? &quot;,&quot; : PlacesUtils.endl;</span>
<a href="#l19.1461"></a><span id="l19.1461" class="difflineplus">+        addData(content.type, content.entries.join(glue));</span>
<a href="#l19.1462"></a><span id="l19.1462" class="difflineplus">+      }</span>
<a href="#l19.1463"></a><span id="l19.1463" class="difflineplus">+    });</span>
<a href="#l19.1464"></a><span id="l19.1464" class="difflineplus">+</span>
<a href="#l19.1465"></a><span id="l19.1465" class="difflineplus">+    // Track the exected action in the xferable.  This must be the last flavor</span>
<a href="#l19.1466"></a><span id="l19.1466" class="difflineplus">+    // since it's the least preferred one.</span>
<a href="#l19.1467"></a><span id="l19.1467" class="difflineplus">+    // Enqueue a unique instance identifier to distinguish operations across</span>
<a href="#l19.1468"></a><span id="l19.1468" class="difflineplus">+    // concurrent instances of the application.</span>
<a href="#l19.1469"></a><span id="l19.1469" class="difflineplus">+    addData(PlacesUtils.TYPE_X_MOZ_PLACE_ACTION, aAction + &quot;,&quot; + this.profileName);</span>
<a href="#l19.1470"></a><span id="l19.1470" class="difflineplus">+</span>
<a href="#l19.1471"></a><span id="l19.1471" class="difflineplus">+    if (hasData) {</span>
<a href="#l19.1472"></a><span id="l19.1472" class="difflineplus">+      this.clipboard.setData(xferable,</span>
<a href="#l19.1473"></a><span id="l19.1473" class="difflineplus">+                             this.cutNodes.length &gt; 0 ? this : null,</span>
<a href="#l19.1474"></a><span id="l19.1474" class="difflineplus">+                             Ci.nsIClipboard.kGlobalClipboard);</span>
<a href="#l19.1475"></a><span id="l19.1475" class="difflineplus">+    }</span>
<a href="#l19.1476"></a><span id="l19.1476" class="difflineplus">+  },</span>
<a href="#l19.1477"></a><span id="l19.1477" class="difflineplus">+</span>
<a href="#l19.1478"></a><span id="l19.1478" class="difflineplus">+  _cutNodes: [],</span>
<a href="#l19.1479"></a><span id="l19.1479" class="difflineplus">+  get cutNodes() {</span>
<a href="#l19.1480"></a><span id="l19.1480" class="difflineplus">+    return this._cutNodes;</span>
<a href="#l19.1481"></a><span id="l19.1481" class="difflineplus">+  },</span>
<a href="#l19.1482"></a><span id="l19.1482" class="difflineplus">+  set cutNodes(aNodes) {</span>
<a href="#l19.1483"></a><span id="l19.1483" class="difflineplus">+    let self = this;</span>
<a href="#l19.1484"></a><span id="l19.1484" class="difflineplus">+    function updateCutNodes(aValue) {</span>
<a href="#l19.1485"></a><span id="l19.1485" class="difflineplus">+      self._cutNodes.forEach(function(aNode) {</span>
<a href="#l19.1486"></a><span id="l19.1486" class="difflineplus">+        self._view.toggleCutNode(aNode, aValue);</span>
<a href="#l19.1487"></a><span id="l19.1487" class="difflineplus">+      });</span>
<a href="#l19.1488"></a><span id="l19.1488" class="difflineplus">+    }</span>
<a href="#l19.1489"></a><span id="l19.1489" class="difflineplus">+</span>
<a href="#l19.1490"></a><span id="l19.1490" class="difflineplus">+    updateCutNodes(false);</span>
<a href="#l19.1491"></a><span id="l19.1491" class="difflineplus">+    this._cutNodes = aNodes;</span>
<a href="#l19.1492"></a><span id="l19.1492" class="difflineplus">+    updateCutNodes(true);</span>
<a href="#l19.1493"></a><span id="l19.1493" class="difflineplus">+    return aNodes;</span>
<a href="#l19.1494"></a><span id="l19.1494" class="difflineplus">+  },</span>
<a href="#l19.1495"></a><span id="l19.1495" class="difflineplus">+</span>
<a href="#l19.1496"></a><span id="l19.1496">   /**</span>
<a href="#l19.1497"></a><span id="l19.1497">    * Copy Bookmarks and Folders to the clipboard</span>
<a href="#l19.1498"></a><span id="l19.1498">    */</span>
<a href="#l19.1499"></a><span id="l19.1499">   copy: function PC_copy() {</span>
<a href="#l19.1500"></a><span id="l19.1500">     let result = this._view.result;</span>
<a href="#l19.1501"></a><span id="l19.1501" class="difflineminus">-</span>
<a href="#l19.1502"></a><span id="l19.1502">     let didSuppressNotifications = result.suppressNotifications;</span>
<a href="#l19.1503"></a><span id="l19.1503">     if (!didSuppressNotifications)</span>
<a href="#l19.1504"></a><span id="l19.1504">       result.suppressNotifications = true;</span>
<a href="#l19.1505"></a><span id="l19.1505" class="difflineminus">-</span>
<a href="#l19.1506"></a><span id="l19.1506">     try {</span>
<a href="#l19.1507"></a><span id="l19.1507" class="difflineminus">-      let nodes = this._view.selectedNodes;</span>
<a href="#l19.1508"></a><span id="l19.1508" class="difflineminus">-</span>
<a href="#l19.1509"></a><span id="l19.1509" class="difflineminus">-      let xferable = Cc[&quot;@mozilla.org/widget/transferable;1&quot;]</span>
<a href="#l19.1510"></a><span id="l19.1510" class="difflineminus">-                       .createInstance(Ci.nsITransferable);</span>
<a href="#l19.1511"></a><span id="l19.1511" class="difflineminus">-      xferable.init(null);</span>
<a href="#l19.1512"></a><span id="l19.1512" class="difflineminus">-      let foundFolder = false, foundLink = false;</span>
<a href="#l19.1513"></a><span id="l19.1513" class="difflineminus">-      let copiedFolders = [];</span>
<a href="#l19.1514"></a><span id="l19.1514" class="difflineminus">-      let placeString, mozURLString, htmlString, unicodeString;</span>
<a href="#l19.1515"></a><span id="l19.1515" class="difflineminus">-      placeString = mozURLString = htmlString = unicodeString = &quot;&quot;;</span>
<a href="#l19.1516"></a><span id="l19.1516" class="difflineminus">-</span>
<a href="#l19.1517"></a><span id="l19.1517" class="difflineminus">-      for (let i = 0; i &lt; nodes.length; ++i) {</span>
<a href="#l19.1518"></a><span id="l19.1518" class="difflineminus">-        let node = nodes[i];</span>
<a href="#l19.1519"></a><span id="l19.1519" class="difflineminus">-        if (this._shouldSkipNode(node, copiedFolders))</span>
<a href="#l19.1520"></a><span id="l19.1520" class="difflineminus">-          continue;</span>
<a href="#l19.1521"></a><span id="l19.1521" class="difflineminus">-        if (PlacesUtils.nodeIsFolder(node))</span>
<a href="#l19.1522"></a><span id="l19.1522" class="difflineminus">-          copiedFolders.push(node);</span>
<a href="#l19.1523"></a><span id="l19.1523" class="difflineminus">-</span>
<a href="#l19.1524"></a><span id="l19.1524" class="difflineminus">-        let self = this;</span>
<a href="#l19.1525"></a><span id="l19.1525" class="difflineminus">-        function generateChunk(type, overrideURI) {</span>
<a href="#l19.1526"></a><span id="l19.1526" class="difflineminus">-          let suffix = i &lt; (nodes.length - 1) ? PlacesUtils.endl : &quot;&quot;;</span>
<a href="#l19.1527"></a><span id="l19.1527" class="difflineminus">-          let uri = overrideURI;</span>
<a href="#l19.1528"></a><span id="l19.1528" class="difflineminus">-</span>
<a href="#l19.1529"></a><span id="l19.1529" class="difflineminus">-          let livemarkInfo = self.getCachedLivemarkInfo(node);</span>
<a href="#l19.1530"></a><span id="l19.1530" class="difflineminus">-          if (livemarkInfo)</span>
<a href="#l19.1531"></a><span id="l19.1531" class="difflineminus">-            uri = livemarkInfo.feedURI.spec;</span>
<a href="#l19.1532"></a><span id="l19.1532" class="difflineminus">-</span>
<a href="#l19.1533"></a><span id="l19.1533" class="difflineminus">-          mozURLString += (PlacesUtils.wrapNode(node, PlacesUtils.TYPE_X_MOZ_URL,</span>
<a href="#l19.1534"></a><span id="l19.1534" class="difflineminus">-                                                 uri) + suffix);</span>
<a href="#l19.1535"></a><span id="l19.1535" class="difflineminus">-          unicodeString += (PlacesUtils.wrapNode(node, PlacesUtils.TYPE_UNICODE,</span>
<a href="#l19.1536"></a><span id="l19.1536" class="difflineminus">-                                                 uri) + suffix);</span>
<a href="#l19.1537"></a><span id="l19.1537" class="difflineminus">-          htmlString += (PlacesUtils.wrapNode(node, PlacesUtils.TYPE_HTML,</span>
<a href="#l19.1538"></a><span id="l19.1538" class="difflineminus">-                                                 uri) + suffix);</span>
<a href="#l19.1539"></a><span id="l19.1539" class="difflineminus">-</span>
<a href="#l19.1540"></a><span id="l19.1540" class="difflineminus">-          let placeSuffix = i &lt; (nodes.length - 1) ? &quot;,&quot; : &quot;&quot;;</span>
<a href="#l19.1541"></a><span id="l19.1541" class="difflineminus">-          let resolveShortcuts = !PlacesControllerDragHelper.canMoveNode(node);</span>
<a href="#l19.1542"></a><span id="l19.1542" class="difflineminus">-          return PlacesUtils.wrapNode(node, type, overrideURI, resolveShortcuts) + placeSuffix;</span>
<a href="#l19.1543"></a><span id="l19.1543" class="difflineminus">-        }</span>
<a href="#l19.1544"></a><span id="l19.1544" class="difflineminus">-</span>
<a href="#l19.1545"></a><span id="l19.1545" class="difflineminus">-        // all items wrapped as TYPE_X_MOZ_PLACE</span>
<a href="#l19.1546"></a><span id="l19.1546" class="difflineminus">-        placeString += generateChunk(PlacesUtils.TYPE_X_MOZ_PLACE);</span>
<a href="#l19.1547"></a><span id="l19.1547" class="difflineminus">-      }</span>
<a href="#l19.1548"></a><span id="l19.1548" class="difflineminus">-</span>
<a href="#l19.1549"></a><span id="l19.1549" class="difflineminus">-      function addData(type, data) {</span>
<a href="#l19.1550"></a><span id="l19.1550" class="difflineminus">-        xferable.addDataFlavor(type);</span>
<a href="#l19.1551"></a><span id="l19.1551" class="difflineminus">-        xferable.setTransferData(type, PlacesUIUtils._wrapString(data), data.length * 2);</span>
<a href="#l19.1552"></a><span id="l19.1552" class="difflineminus">-      }</span>
<a href="#l19.1553"></a><span id="l19.1553" class="difflineminus">-      // This order is _important_! It controls how this and other applications</span>
<a href="#l19.1554"></a><span id="l19.1554" class="difflineminus">-      // select data to be inserted based on type.</span>
<a href="#l19.1555"></a><span id="l19.1555" class="difflineminus">-      if (placeString)</span>
<a href="#l19.1556"></a><span id="l19.1556" class="difflineminus">-        addData(PlacesUtils.TYPE_X_MOZ_PLACE, placeString);</span>
<a href="#l19.1557"></a><span id="l19.1557" class="difflineminus">-      if (mozURLString)</span>
<a href="#l19.1558"></a><span id="l19.1558" class="difflineminus">-        addData(PlacesUtils.TYPE_X_MOZ_URL, mozURLString);</span>
<a href="#l19.1559"></a><span id="l19.1559" class="difflineminus">-      if (unicodeString)</span>
<a href="#l19.1560"></a><span id="l19.1560" class="difflineminus">-        addData(PlacesUtils.TYPE_UNICODE, unicodeString);</span>
<a href="#l19.1561"></a><span id="l19.1561" class="difflineminus">-      if (htmlString)</span>
<a href="#l19.1562"></a><span id="l19.1562" class="difflineminus">-        addData(PlacesUtils.TYPE_HTML, htmlString);</span>
<a href="#l19.1563"></a><span id="l19.1563" class="difflineminus">-</span>
<a href="#l19.1564"></a><span id="l19.1564" class="difflineminus">-      if (placeString || unicodeString || htmlString || mozURLString) {</span>
<a href="#l19.1565"></a><span id="l19.1565" class="difflineminus">-        this.clipboard.setData(xferable, null,</span>
<a href="#l19.1566"></a><span id="l19.1566" class="difflineminus">-                               Ci.nsIClipboard.kGlobalClipboard);</span>
<a href="#l19.1567"></a><span id="l19.1567" class="difflineminus">-      }</span>
<a href="#l19.1568"></a><span id="l19.1568" class="difflineminus">-    }</span>
<a href="#l19.1569"></a><span id="l19.1569" class="difflineminus">-    finally {</span>
<a href="#l19.1570"></a><span id="l19.1570" class="difflineplus">+      this._populateClipboard(this._view.selectedNodes, &quot;copy&quot;);</span>
<a href="#l19.1571"></a><span id="l19.1571" class="difflineplus">+    } finally {</span>
<a href="#l19.1572"></a><span id="l19.1572">       if (!didSuppressNotifications)</span>
<a href="#l19.1573"></a><span id="l19.1573">         result.suppressNotifications = false;</span>
<a href="#l19.1574"></a><span id="l19.1574">     }</span>
<a href="#l19.1575"></a><span id="l19.1575">   },</span>
<a href="#l19.1576"></a><span id="l19.1576"> </span>
<a href="#l19.1577"></a><span id="l19.1577">   /**</span>
<a href="#l19.1578"></a><span id="l19.1578">    * Cut Bookmarks and Folders to the clipboard</span>
<a href="#l19.1579"></a><span id="l19.1579">    */</span>
<a href="#l19.1580"></a><span id="l19.1580">   cut: function PC_cut() {</span>
<a href="#l19.1581"></a><span id="l19.1581" class="difflineminus">-    this.copy();</span>
<a href="#l19.1582"></a><span id="l19.1582" class="difflineminus">-    this.remove(&quot;Cut Selection&quot;);</span>
<a href="#l19.1583"></a><span id="l19.1583" class="difflineplus">+    let result = this._view.result;</span>
<a href="#l19.1584"></a><span id="l19.1584" class="difflineplus">+    let didSuppressNotifications = result.suppressNotifications;</span>
<a href="#l19.1585"></a><span id="l19.1585" class="difflineplus">+    if (!didSuppressNotifications)</span>
<a href="#l19.1586"></a><span id="l19.1586" class="difflineplus">+      result.suppressNotifications = true;</span>
<a href="#l19.1587"></a><span id="l19.1587" class="difflineplus">+    try {</span>
<a href="#l19.1588"></a><span id="l19.1588" class="difflineplus">+      this._populateClipboard(this._view.selectedNodes, &quot;cut&quot;);</span>
<a href="#l19.1589"></a><span id="l19.1589" class="difflineplus">+      this.cutNodes = this._view.selectedNodes;</span>
<a href="#l19.1590"></a><span id="l19.1590" class="difflineplus">+    } finally {</span>
<a href="#l19.1591"></a><span id="l19.1591" class="difflineplus">+      if (!didSuppressNotifications)</span>
<a href="#l19.1592"></a><span id="l19.1592" class="difflineplus">+        result.suppressNotifications = false;</span>
<a href="#l19.1593"></a><span id="l19.1593" class="difflineplus">+    }</span>
<a href="#l19.1594"></a><span id="l19.1594">   },</span>
<a href="#l19.1595"></a><span id="l19.1595"> </span>
<a href="#l19.1596"></a><span id="l19.1596">   /**</span>
<a href="#l19.1597"></a><span id="l19.1597">    * Paste Bookmarks and Folders from the clipboard</span>
<a href="#l19.1598"></a><span id="l19.1598">    */</span>
<a href="#l19.1599"></a><span id="l19.1599" class="difflineminus">-  paste: function PC_paste() {</span>
<a href="#l19.1600"></a><span id="l19.1600" class="difflineminus">-    // Strategy:</span>
<a href="#l19.1601"></a><span id="l19.1601" class="difflineminus">-    //</span>
<a href="#l19.1602"></a><span id="l19.1602" class="difflineminus">-    // There can be data of various types (folder, separator, link) on the</span>
<a href="#l19.1603"></a><span id="l19.1603" class="difflineminus">-    // clipboard. We need to get all of that data and build edit transactions</span>
<a href="#l19.1604"></a><span id="l19.1604" class="difflineminus">-    // for them. This means asking the clipboard once for each type and</span>
<a href="#l19.1605"></a><span id="l19.1605" class="difflineminus">-    // aggregating the results.</span>
<a href="#l19.1606"></a><span id="l19.1606" class="difflineminus">-</span>
<a href="#l19.1607"></a><span id="l19.1607" class="difflineminus">-    /**</span>
<a href="#l19.1608"></a><span id="l19.1608" class="difflineminus">-     * Constructs a transferable that can receive data of specific types.</span>
<a href="#l19.1609"></a><span id="l19.1609" class="difflineminus">-     * @param   types</span>
<a href="#l19.1610"></a><span id="l19.1610" class="difflineminus">-     *          The types of data the transferable can hold, in order of</span>
<a href="#l19.1611"></a><span id="l19.1611" class="difflineminus">-     *          preference.</span>
<a href="#l19.1612"></a><span id="l19.1612" class="difflineminus">-     * @returns The transferable.</span>
<a href="#l19.1613"></a><span id="l19.1613" class="difflineminus">-     */</span>
<a href="#l19.1614"></a><span id="l19.1614" class="difflineminus">-    function makeXferable(types) {</span>
<a href="#l19.1615"></a><span id="l19.1615" class="difflineminus">-      var xferable =</span>
<a href="#l19.1616"></a><span id="l19.1616" class="difflineminus">-          Cc[&quot;@mozilla.org/widget/transferable;1&quot;]</span>
<a href="#l19.1617"></a><span id="l19.1617" class="difflineminus">-            .createInstance(Ci.nsITransferable);</span>
<a href="#l19.1618"></a><span id="l19.1618" class="difflineminus">-</span>
<a href="#l19.1619"></a><span id="l19.1619" class="difflineminus">-      xferable.init(null);</span>
<a href="#l19.1620"></a><span id="l19.1620" class="difflineminus">-      for (var i = 0; i &lt; types.length; ++i)</span>
<a href="#l19.1621"></a><span id="l19.1621" class="difflineminus">-        xferable.addDataFlavor(types[i]);</span>
<a href="#l19.1622"></a><span id="l19.1622" class="difflineminus">-      return xferable;</span>
<a href="#l19.1623"></a><span id="l19.1623" class="difflineminus">-    }</span>
<a href="#l19.1624"></a><span id="l19.1624" class="difflineminus">-</span>
<a href="#l19.1625"></a><span id="l19.1625" class="difflineminus">-    var clipboard = this.clipboard;</span>
<a href="#l19.1626"></a><span id="l19.1626" class="difflineminus">-</span>
<a href="#l19.1627"></a><span id="l19.1627" class="difflineminus">-    var ip = this._view.insertionPoint;</span>
<a href="#l19.1628"></a><span id="l19.1628" class="difflineplus">+  async paste() {</span>
<a href="#l19.1629"></a><span id="l19.1629" class="difflineplus">+    // No reason to proceed if there isn't a valid insertion point.</span>
<a href="#l19.1630"></a><span id="l19.1630" class="difflineplus">+    let ip = this._view.insertionPoint;</span>
<a href="#l19.1631"></a><span id="l19.1631">     if (!ip)</span>
<a href="#l19.1632"></a><span id="l19.1632">       throw Cr.NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l19.1633"></a><span id="l19.1633"> </span>
<a href="#l19.1634"></a><span id="l19.1634" class="difflineminus">-    /**</span>
<a href="#l19.1635"></a><span id="l19.1635" class="difflineminus">-     * Gets a list of transactions to perform the paste of specific types.</span>
<a href="#l19.1636"></a><span id="l19.1636" class="difflineminus">-     * @param   types</span>
<a href="#l19.1637"></a><span id="l19.1637" class="difflineminus">-     *          The types of data to form paste transactions for</span>
<a href="#l19.1638"></a><span id="l19.1638" class="difflineminus">-     * @returns An array of transactions that perform the paste.</span>
<a href="#l19.1639"></a><span id="l19.1639" class="difflineminus">-     */</span>
<a href="#l19.1640"></a><span id="l19.1640" class="difflineminus">-    function getTransactions(types) {</span>
<a href="#l19.1641"></a><span id="l19.1641" class="difflineminus">-      var xferable = makeXferable(types);</span>
<a href="#l19.1642"></a><span id="l19.1642" class="difflineminus">-      clipboard.getData(xferable, Ci.nsIClipboard.kGlobalClipboard);</span>
<a href="#l19.1643"></a><span id="l19.1643" class="difflineplus">+    let action = this.clipboardAction;</span>
<a href="#l19.1644"></a><span id="l19.1644" class="difflineplus">+</span>
<a href="#l19.1645"></a><span id="l19.1645" class="difflineplus">+    let xferable = Cc[&quot;@mozilla.org/widget/transferable;1&quot;]</span>
<a href="#l19.1646"></a><span id="l19.1646" class="difflineplus">+                     .createInstance(Ci.nsITransferable);</span>
<a href="#l19.1647"></a><span id="l19.1647" class="difflineplus">+    xferable.init(null);</span>
<a href="#l19.1648"></a><span id="l19.1648" class="difflineplus">+    // This order matters here!  It controls the preferred flavors for this</span>
<a href="#l19.1649"></a><span id="l19.1649" class="difflineplus">+    // paste operation.</span>
<a href="#l19.1650"></a><span id="l19.1650" class="difflineplus">+    [ PlacesUtils.TYPE_X_MOZ_PLACE,</span>
<a href="#l19.1651"></a><span id="l19.1651" class="difflineplus">+      PlacesUtils.TYPE_X_MOZ_URL,</span>
<a href="#l19.1652"></a><span id="l19.1652" class="difflineplus">+      PlacesUtils.TYPE_UNICODE,</span>
<a href="#l19.1653"></a><span id="l19.1653" class="difflineplus">+    ].forEach(type =&gt; xferable.addDataFlavor(type));</span>
<a href="#l19.1654"></a><span id="l19.1654"> </span>
<a href="#l19.1655"></a><span id="l19.1655" class="difflineminus">-      var data = { }, type = { };</span>
<a href="#l19.1656"></a><span id="l19.1656" class="difflineminus">-      try {</span>
<a href="#l19.1657"></a><span id="l19.1657" class="difflineminus">-        xferable.getAnyTransferData(type, data, { });</span>
<a href="#l19.1658"></a><span id="l19.1658" class="difflineminus">-        data = data.value.QueryInterface(Ci.nsISupportsString).data;</span>
<a href="#l19.1659"></a><span id="l19.1659" class="difflineminus">-        var items = PlacesUtils.unwrapNodes(data, type.value);</span>
<a href="#l19.1660"></a><span id="l19.1660" class="difflineminus">-        var transactions = [];</span>
<a href="#l19.1661"></a><span id="l19.1661" class="difflineminus">-        var index = ip.index;</span>
<a href="#l19.1662"></a><span id="l19.1662" class="difflineminus">-        for (var i = 0; i &lt; items.length; ++i) {</span>
<a href="#l19.1663"></a><span id="l19.1663" class="difflineminus">-          var txn;</span>
<a href="#l19.1664"></a><span id="l19.1664" class="difflineminus">-          if (ip.isTag) {</span>
<a href="#l19.1665"></a><span id="l19.1665" class="difflineminus">-            var uri = PlacesUtils._uri(items[i].uri);</span>
<a href="#l19.1666"></a><span id="l19.1666" class="difflineminus">-            txn = new PlacesTagURITransaction(uri, [ip.itemId]);</span>
<a href="#l19.1667"></a><span id="l19.1667" class="difflineminus">-          }</span>
<a href="#l19.1668"></a><span id="l19.1668" class="difflineminus">-          else {</span>
<a href="#l19.1669"></a><span id="l19.1669" class="difflineminus">-            // adjusted to make sure that items are given the correct index</span>
<a href="#l19.1670"></a><span id="l19.1670" class="difflineminus">-            // transactions insert differently if index == -1</span>
<a href="#l19.1671"></a><span id="l19.1671" class="difflineminus">-            // transaction will enqueue the item.</span>
<a href="#l19.1672"></a><span id="l19.1672" class="difflineminus">-            if (ip.index &gt; -1)</span>
<a href="#l19.1673"></a><span id="l19.1673" class="difflineminus">-              index = ip.index + i;</span>
<a href="#l19.1674"></a><span id="l19.1674" class="difflineminus">-            txn = PlacesUIUtils.makeTransaction(items[i], type.value,</span>
<a href="#l19.1675"></a><span id="l19.1675" class="difflineminus">-                                                ip.itemId, index, true);</span>
<a href="#l19.1676"></a><span id="l19.1676" class="difflineminus">-          }</span>
<a href="#l19.1677"></a><span id="l19.1677" class="difflineminus">-          transactions.push(txn);</span>
<a href="#l19.1678"></a><span id="l19.1678" class="difflineminus">-        }</span>
<a href="#l19.1679"></a><span id="l19.1679" class="difflineminus">-        return transactions;</span>
<a href="#l19.1680"></a><span id="l19.1680" class="difflineminus">-      }</span>
<a href="#l19.1681"></a><span id="l19.1681" class="difflineminus">-      catch (e) {</span>
<a href="#l19.1682"></a><span id="l19.1682" class="difflineminus">-        // getAnyTransferData will throw if there is no data of the specified</span>
<a href="#l19.1683"></a><span id="l19.1683" class="difflineminus">-        // type on the clipboard.</span>
<a href="#l19.1684"></a><span id="l19.1684" class="difflineminus">-        // unwrapNodes will throw if the data that is present is malformed in</span>
<a href="#l19.1685"></a><span id="l19.1685" class="difflineminus">-        // some way.</span>
<a href="#l19.1686"></a><span id="l19.1686" class="difflineminus">-        // In either case, don't fail horribly, just return no data.</span>
<a href="#l19.1687"></a><span id="l19.1687" class="difflineminus">-      }</span>
<a href="#l19.1688"></a><span id="l19.1688" class="difflineminus">-      return [];</span>
<a href="#l19.1689"></a><span id="l19.1689" class="difflineplus">+    this.clipboard.getData(xferable, Ci.nsIClipboard.kGlobalClipboard);</span>
<a href="#l19.1690"></a><span id="l19.1690" class="difflineplus">+</span>
<a href="#l19.1691"></a><span id="l19.1691" class="difflineplus">+    // Now get the clipboard contents, in the best available flavor.</span>
<a href="#l19.1692"></a><span id="l19.1692" class="difflineplus">+    let data = {}, type = {}, items = [];</span>
<a href="#l19.1693"></a><span id="l19.1693" class="difflineplus">+    try {</span>
<a href="#l19.1694"></a><span id="l19.1694" class="difflineplus">+      xferable.getAnyTransferData(type, data, {});</span>
<a href="#l19.1695"></a><span id="l19.1695" class="difflineplus">+      data = data.value.QueryInterface(Ci.nsISupportsString).data;</span>
<a href="#l19.1696"></a><span id="l19.1696" class="difflineplus">+      type = type.value;</span>
<a href="#l19.1697"></a><span id="l19.1697" class="difflineplus">+      items = PlacesUtils.unwrapNodes(data, type);</span>
<a href="#l19.1698"></a><span id="l19.1698" class="difflineplus">+    } catch (ex) {</span>
<a href="#l19.1699"></a><span id="l19.1699" class="difflineplus">+      // No supported data exists or nodes unwrap failed, just bail out.</span>
<a href="#l19.1700"></a><span id="l19.1700" class="difflineplus">+      return;</span>
<a href="#l19.1701"></a><span id="l19.1701">     }</span>
<a href="#l19.1702"></a><span id="l19.1702"> </span>
<a href="#l19.1703"></a><span id="l19.1703" class="difflineminus">-    // Get transactions to paste any folders, separators or links that might</span>
<a href="#l19.1704"></a><span id="l19.1704" class="difflineminus">-    // be on the clipboard, aggregate them and execute them.</span>
<a href="#l19.1705"></a><span id="l19.1705" class="difflineminus">-    var transactions = getTransactions([PlacesUtils.TYPE_X_MOZ_PLACE,</span>
<a href="#l19.1706"></a><span id="l19.1706" class="difflineminus">-                                        PlacesUtils.TYPE_X_MOZ_URL,</span>
<a href="#l19.1707"></a><span id="l19.1707" class="difflineminus">-                                        PlacesUtils.TYPE_UNICODE]);</span>
<a href="#l19.1708"></a><span id="l19.1708" class="difflineminus">-    let aggregatedTxn = new PlacesAggregatedTransaction(&quot;Paste&quot;, transactions);</span>
<a href="#l19.1709"></a><span id="l19.1709" class="difflineminus">-    PlacesUtils.transactionManager.doTransaction(aggregatedTxn);</span>
<a href="#l19.1710"></a><span id="l19.1710" class="difflineplus">+    let itemsToSelect = [];</span>
<a href="#l19.1711"></a><span id="l19.1711" class="difflineplus">+    if (PlacesUIUtils.useAsyncTransactions) {</span>
<a href="#l19.1712"></a><span id="l19.1712" class="difflineplus">+      if (ip.isTag) {</span>
<a href="#l19.1713"></a><span id="l19.1713" class="difflineplus">+        let urls = items.filter(item =&gt; &quot;uri&quot; in item).map(item =&gt; Services.io.newURI(item.uri));</span>
<a href="#l19.1714"></a><span id="l19.1714" class="difflineplus">+        await PlacesTransactions.Tag({ urls, tag: ip.tagName }).transact();</span>
<a href="#l19.1715"></a><span id="l19.1715" class="difflineplus">+      } else {</span>
<a href="#l19.1716"></a><span id="l19.1716" class="difflineplus">+        await PlacesTransactions.batch(async function() {</span>
<a href="#l19.1717"></a><span id="l19.1717" class="difflineplus">+          let insertionIndex = ip.index;</span>
<a href="#l19.1718"></a><span id="l19.1718" class="difflineplus">+          let parent = await ip.promiseGuid();</span>
<a href="#l19.1719"></a><span id="l19.1719" class="difflineplus">+</span>
<a href="#l19.1720"></a><span id="l19.1720" class="difflineplus">+          for (let item of items) {</span>
<a href="#l19.1721"></a><span id="l19.1721" class="difflineplus">+            let doCopy = action == &quot;copy&quot;;</span>
<a href="#l19.1722"></a><span id="l19.1722" class="difflineplus">+</span>
<a href="#l19.1723"></a><span id="l19.1723" class="difflineplus">+            // If this is not a copy, check for safety that we can move the</span>
<a href="#l19.1724"></a><span id="l19.1724" class="difflineplus">+            // source, otherwise report an error and fallback to a copy.</span>
<a href="#l19.1725"></a><span id="l19.1725" class="difflineplus">+            if (!doCopy &amp;&amp;</span>
<a href="#l19.1726"></a><span id="l19.1726" class="difflineplus">+                !PlacesControllerDragHelper.canMoveUnwrappedNode(item)) {</span>
<a href="#l19.1727"></a><span id="l19.1727" class="difflineplus">+              Cu.reportError(&quot;Tried to move an unmovable &quot; +</span>
<a href="#l19.1728"></a><span id="l19.1728" class="difflineplus">+                             &quot;Places node, reverting to a copy operation.&quot;);</span>
<a href="#l19.1729"></a><span id="l19.1729" class="difflineplus">+              doCopy = true;</span>
<a href="#l19.1730"></a><span id="l19.1730" class="difflineplus">+            }</span>
<a href="#l19.1731"></a><span id="l19.1731" class="difflineplus">+            let guid = await PlacesUIUtils.getTransactionForData(</span>
<a href="#l19.1732"></a><span id="l19.1732" class="difflineplus">+              item, type, parent, insertionIndex, doCopy).transact();</span>
<a href="#l19.1733"></a><span id="l19.1733" class="difflineplus">+            itemsToSelect.push(await PlacesUtils.promiseItemId(guid));</span>
<a href="#l19.1734"></a><span id="l19.1734"> </span>
<a href="#l19.1735"></a><span id="l19.1735" class="difflineminus">-    // select the pasted items, they should be consecutive</span>
<a href="#l19.1736"></a><span id="l19.1736" class="difflineminus">-    var insertedNodeIds = [];</span>
<a href="#l19.1737"></a><span id="l19.1737" class="difflineminus">-    for (var i = 0; i &lt; transactions.length; ++i)</span>
<a href="#l19.1738"></a><span id="l19.1738" class="difflineminus">-      insertedNodeIds.push(PlacesUtils.bookmarks</span>
<a href="#l19.1739"></a><span id="l19.1739" class="difflineminus">-                                      .getIdForItemAt(ip.itemId, ip.index + i));</span>
<a href="#l19.1740"></a><span id="l19.1740" class="difflineminus">-    if (insertedNodeIds.length &gt; 0)</span>
<a href="#l19.1741"></a><span id="l19.1741" class="difflineminus">-      this._view.selectItems(insertedNodeIds, false);</span>
<a href="#l19.1742"></a><span id="l19.1742" class="difflineplus">+            // Adjust index to make sure items are pasted in the correct</span>
<a href="#l19.1743"></a><span id="l19.1743" class="difflineplus">+            // position.  If index is DEFAULT_INDEX, items are just appended.</span>
<a href="#l19.1744"></a><span id="l19.1744" class="difflineplus">+            if (insertionIndex != PlacesUtils.bookmarks.DEFAULT_INDEX)</span>
<a href="#l19.1745"></a><span id="l19.1745" class="difflineplus">+              insertionIndex++;</span>
<a href="#l19.1746"></a><span id="l19.1746" class="difflineplus">+          }</span>
<a href="#l19.1747"></a><span id="l19.1747" class="difflineplus">+        });</span>
<a href="#l19.1748"></a><span id="l19.1748" class="difflineplus">+      }</span>
<a href="#l19.1749"></a><span id="l19.1749" class="difflineplus">+    } else {</span>
<a href="#l19.1750"></a><span id="l19.1750" class="difflineplus">+      let transactions = [];</span>
<a href="#l19.1751"></a><span id="l19.1751" class="difflineplus">+      let insertionIndex = ip.index;</span>
<a href="#l19.1752"></a><span id="l19.1752" class="difflineplus">+      for (let i = 0; i &lt; items.length; ++i) {</span>
<a href="#l19.1753"></a><span id="l19.1753" class="difflineplus">+        if (ip.isTag) {</span>
<a href="#l19.1754"></a><span id="l19.1754" class="difflineplus">+          // Pasting into a tag container means tagging the item, regardless of</span>
<a href="#l19.1755"></a><span id="l19.1755" class="difflineplus">+          // the requested action.</span>
<a href="#l19.1756"></a><span id="l19.1756" class="difflineplus">+          let tagTxn = new PlacesTagURITransaction(NetUtil.newURI(items[i].uri),</span>
<a href="#l19.1757"></a><span id="l19.1757" class="difflineplus">+                                                   [ip.itemId]);</span>
<a href="#l19.1758"></a><span id="l19.1758" class="difflineplus">+          transactions.push(tagTxn);</span>
<a href="#l19.1759"></a><span id="l19.1759" class="difflineplus">+          continue;</span>
<a href="#l19.1760"></a><span id="l19.1760" class="difflineplus">+        }</span>
<a href="#l19.1761"></a><span id="l19.1761" class="difflineplus">+</span>
<a href="#l19.1762"></a><span id="l19.1762" class="difflineplus">+        // Adjust index to make sure items are pasted in the correct position.</span>
<a href="#l19.1763"></a><span id="l19.1763" class="difflineplus">+        // If index is DEFAULT_INDEX, items are just appended.</span>
<a href="#l19.1764"></a><span id="l19.1764" class="difflineplus">+        if (ip.index != PlacesUtils.bookmarks.DEFAULT_INDEX)</span>
<a href="#l19.1765"></a><span id="l19.1765" class="difflineplus">+          insertionIndex = ip.index + i;</span>
<a href="#l19.1766"></a><span id="l19.1766" class="difflineplus">+</span>
<a href="#l19.1767"></a><span id="l19.1767" class="difflineplus">+        // If this is not a copy, check for safety that we can move the source,</span>
<a href="#l19.1768"></a><span id="l19.1768" class="difflineplus">+        // otherwise report an error and fallback to a copy.</span>
<a href="#l19.1769"></a><span id="l19.1769" class="difflineplus">+        if (action != &quot;copy&quot; &amp;&amp; !PlacesControllerDragHelper.canMoveUnwrappedNode(items[i])) {</span>
<a href="#l19.1770"></a><span id="l19.1770" class="difflineplus">+          Cu.reportError(&quot;Tried to move an unmovable Places &quot; +</span>
<a href="#l19.1771"></a><span id="l19.1771" class="difflineplus">+                                       &quot;node, reverting to a copy operation.&quot;);</span>
<a href="#l19.1772"></a><span id="l19.1772" class="difflineplus">+          action = &quot;copy&quot;;</span>
<a href="#l19.1773"></a><span id="l19.1773" class="difflineplus">+        }</span>
<a href="#l19.1774"></a><span id="l19.1774" class="difflineplus">+        transactions.push(</span>
<a href="#l19.1775"></a><span id="l19.1775" class="difflineplus">+          PlacesUIUtils.makeTransaction(items[i], type, ip.itemId,</span>
<a href="#l19.1776"></a><span id="l19.1776" class="difflineplus">+                                        insertionIndex, action == &quot;copy&quot;)</span>
<a href="#l19.1777"></a><span id="l19.1777" class="difflineplus">+        );</span>
<a href="#l19.1778"></a><span id="l19.1778" class="difflineplus">+      }</span>
<a href="#l19.1779"></a><span id="l19.1779" class="difflineplus">+</span>
<a href="#l19.1780"></a><span id="l19.1780" class="difflineplus">+      let aggregatedTxn = new PlacesAggregatedTransaction(&quot;Paste&quot;, transactions);</span>
<a href="#l19.1781"></a><span id="l19.1781" class="difflineplus">+      PlacesUtils.transactionManager.doTransaction(aggregatedTxn);</span>
<a href="#l19.1782"></a><span id="l19.1782" class="difflineplus">+</span>
<a href="#l19.1783"></a><span id="l19.1783" class="difflineplus">+      for (let i = 0; i &lt; transactions.length; ++i) {</span>
<a href="#l19.1784"></a><span id="l19.1784" class="difflineplus">+        itemsToSelect.push(</span>
<a href="#l19.1785"></a><span id="l19.1785" class="difflineplus">+          PlacesUtils.bookmarks.getIdForItemAt(ip.itemId, ip.index + i)</span>
<a href="#l19.1786"></a><span id="l19.1786" class="difflineplus">+        );</span>
<a href="#l19.1787"></a><span id="l19.1787" class="difflineplus">+      }</span>
<a href="#l19.1788"></a><span id="l19.1788" class="difflineplus">+    }</span>
<a href="#l19.1789"></a><span id="l19.1789" class="difflineplus">+</span>
<a href="#l19.1790"></a><span id="l19.1790" class="difflineplus">+    // Cut/past operations are not repeatable, so clear the clipboard.</span>
<a href="#l19.1791"></a><span id="l19.1791" class="difflineplus">+    if (action == &quot;cut&quot;) {</span>
<a href="#l19.1792"></a><span id="l19.1792" class="difflineplus">+      this._clearClipboard();</span>
<a href="#l19.1793"></a><span id="l19.1793" class="difflineplus">+    }</span>
<a href="#l19.1794"></a><span id="l19.1794" class="difflineplus">+</span>
<a href="#l19.1795"></a><span id="l19.1795" class="difflineplus">+    if (itemsToSelect.length &gt; 0)</span>
<a href="#l19.1796"></a><span id="l19.1796" class="difflineplus">+      this._view.selectItems(itemsToSelect, false);</span>
<a href="#l19.1797"></a><span id="l19.1797">   },</span>
<a href="#l19.1798"></a><span id="l19.1798"> </span>
<a href="#l19.1799"></a><span id="l19.1799" class="difflineminus">-</span>
<a href="#l19.1800"></a><span id="l19.1800">   /**</span>
<a href="#l19.1801"></a><span id="l19.1801">    * Cache the livemark info for a node.  This allows the controller and the</span>
<a href="#l19.1802"></a><span id="l19.1802">    * views to treat the given node as a livemark.</span>
<a href="#l19.1803"></a><span id="l19.1803">    * @param aNode</span>
<a href="#l19.1804"></a><span id="l19.1804">    *        a places result node.</span>
<a href="#l19.1805"></a><span id="l19.1805">    * @param aLivemarkInfo</span>
<a href="#l19.1806"></a><span id="l19.1806">    *        a mozILivemarkInfo object.</span>
<a href="#l19.1807"></a><span id="l19.1807">    */</span>
<a href="#l19.1808"></a><span id="l19.1808" class="difflineat">@@ -1283,17 +1350,17 @@ PlacesController.prototype = {</span>
<a href="#l19.1809"></a><span id="l19.1809">     this._cachedLivemarkInfoObjects.set(aNode, aLivemarkInfo);</span>
<a href="#l19.1810"></a><span id="l19.1810">   },</span>
<a href="#l19.1811"></a><span id="l19.1811"> </span>
<a href="#l19.1812"></a><span id="l19.1812">   /**</span>
<a href="#l19.1813"></a><span id="l19.1813">    * Returns whether or not there's cached mozILivemarkInfo object for a node.</span>
<a href="#l19.1814"></a><span id="l19.1814">    * @param aNode</span>
<a href="#l19.1815"></a><span id="l19.1815">    *        a places result node.</span>
<a href="#l19.1816"></a><span id="l19.1816">    * @return true if there's a cached mozILivemarkInfo object for</span>
<a href="#l19.1817"></a><span id="l19.1817" class="difflineminus">-   * aNode, false otherwise.</span>
<a href="#l19.1818"></a><span id="l19.1818" class="difflineplus">+   *         aNode, false otherwise.</span>
<a href="#l19.1819"></a><span id="l19.1819">    */</span>
<a href="#l19.1820"></a><span id="l19.1820">   hasCachedLivemarkInfo: function PC_hasCachedLivemarkInfo(aNode) {</span>
<a href="#l19.1821"></a><span id="l19.1821">     return this._cachedLivemarkInfoObjects.has(aNode);</span>
<a href="#l19.1822"></a><span id="l19.1822">   },</span>
<a href="#l19.1823"></a><span id="l19.1823"> </span>
<a href="#l19.1824"></a><span id="l19.1824">   /**</span>
<a href="#l19.1825"></a><span id="l19.1825">    * Returns the cached livemark info for a node, if set by cacheLivemarkInfo,</span>
<a href="#l19.1826"></a><span id="l19.1826">    * null otherwise.</span>
<a href="#l19.1827"></a><span id="l19.1827" class="difflineat">@@ -1319,46 +1386,54 @@ var PlacesControllerDragHelper = {</span>
<a href="#l19.1828"></a><span id="l19.1828">   currentDropTarget: null,</span>
<a href="#l19.1829"></a><span id="l19.1829"> </span>
<a href="#l19.1830"></a><span id="l19.1830">   /**</span>
<a href="#l19.1831"></a><span id="l19.1831">    * Determines if the mouse is currently being dragged over a child node of</span>
<a href="#l19.1832"></a><span id="l19.1832">    * this menu. This is necessary so that the menu doesn't close while the</span>
<a href="#l19.1833"></a><span id="l19.1833">    * mouse is dragging over one of its submenus</span>
<a href="#l19.1834"></a><span id="l19.1834">    * @param   node</span>
<a href="#l19.1835"></a><span id="l19.1835">    *          The container node</span>
<a href="#l19.1836"></a><span id="l19.1836" class="difflineminus">-   * @returns true if the user is dragging over a node within the hierarchy of</span>
<a href="#l19.1837"></a><span id="l19.1837" class="difflineminus">-   *          the container, false otherwise.</span>
<a href="#l19.1838"></a><span id="l19.1838" class="difflineplus">+   * @return true if the user is dragging over a node within the hierarchy of</span>
<a href="#l19.1839"></a><span id="l19.1839" class="difflineplus">+   *         the container, false otherwise.</span>
<a href="#l19.1840"></a><span id="l19.1840">    */</span>
<a href="#l19.1841"></a><span id="l19.1841">   draggingOverChildNode: function PCDH_draggingOverChildNode(node) {</span>
<a href="#l19.1842"></a><span id="l19.1842">     let currentNode = this.currentDropTarget;</span>
<a href="#l19.1843"></a><span id="l19.1843">     while (currentNode) {</span>
<a href="#l19.1844"></a><span id="l19.1844">       if (currentNode == node)</span>
<a href="#l19.1845"></a><span id="l19.1845">         return true;</span>
<a href="#l19.1846"></a><span id="l19.1846">       currentNode = currentNode.parentNode;</span>
<a href="#l19.1847"></a><span id="l19.1847">     }</span>
<a href="#l19.1848"></a><span id="l19.1848">     return false;</span>
<a href="#l19.1849"></a><span id="l19.1849">   },</span>
<a href="#l19.1850"></a><span id="l19.1850"> </span>
<a href="#l19.1851"></a><span id="l19.1851">   /**</span>
<a href="#l19.1852"></a><span id="l19.1852" class="difflineminus">-   * @returns The current active drag session. Returns null if there is none.</span>
<a href="#l19.1853"></a><span id="l19.1853" class="difflineplus">+   * @return The current active drag session. Returns null if there is none.</span>
<a href="#l19.1854"></a><span id="l19.1854">    */</span>
<a href="#l19.1855"></a><span id="l19.1855">   getSession: function PCDH__getSession() {</span>
<a href="#l19.1856"></a><span id="l19.1856">     return this.dragService.getCurrentSession();</span>
<a href="#l19.1857"></a><span id="l19.1857">   },</span>
<a href="#l19.1858"></a><span id="l19.1858"> </span>
<a href="#l19.1859"></a><span id="l19.1859">   /**</span>
<a href="#l19.1860"></a><span id="l19.1860" class="difflineminus">-   * Extract the first accepted flavor from a flavors array.</span>
<a href="#l19.1861"></a><span id="l19.1861" class="difflineplus">+   * Extract the first accepted flavor from a list of flavors.</span>
<a href="#l19.1862"></a><span id="l19.1862">    * @param aFlavors</span>
<a href="#l19.1863"></a><span id="l19.1863" class="difflineminus">-   *        The flavors array.</span>
<a href="#l19.1864"></a><span id="l19.1864" class="difflineplus">+   *        The flavors list of type DOMStringList.</span>
<a href="#l19.1865"></a><span id="l19.1865">    */</span>
<a href="#l19.1866"></a><span id="l19.1866">   getFirstValidFlavor: function PCDH_getFirstValidFlavor(aFlavors) {</span>
<a href="#l19.1867"></a><span id="l19.1867">     for (let i = 0; i &lt; aFlavors.length; i++) {</span>
<a href="#l19.1868"></a><span id="l19.1868" class="difflineminus">-      if (this.GENERIC_VIEW_DROP_TYPES.indexOf(aFlavors[i]) != -1)</span>
<a href="#l19.1869"></a><span id="l19.1869" class="difflineplus">+      if (PlacesUIUtils.SUPPORTED_FLAVORS.includes(aFlavors[i]))</span>
<a href="#l19.1870"></a><span id="l19.1870">         return aFlavors[i];</span>
<a href="#l19.1871"></a><span id="l19.1871">     }</span>
<a href="#l19.1872"></a><span id="l19.1872" class="difflineplus">+</span>
<a href="#l19.1873"></a><span id="l19.1873" class="difflineplus">+    // If no supported flavor is found, check if data includes text/plain</span>
<a href="#l19.1874"></a><span id="l19.1874" class="difflineplus">+    // contents.  If so, request them as text/unicode, a conversion will happen</span>
<a href="#l19.1875"></a><span id="l19.1875" class="difflineplus">+    // automatically.</span>
<a href="#l19.1876"></a><span id="l19.1876" class="difflineplus">+    if (aFlavors.contains(&quot;text/plain&quot;)) {</span>
<a href="#l19.1877"></a><span id="l19.1877" class="difflineplus">+        return PlacesUtils.TYPE_UNICODE;</span>
<a href="#l19.1878"></a><span id="l19.1878" class="difflineplus">+    }</span>
<a href="#l19.1879"></a><span id="l19.1879" class="difflineplus">+</span>
<a href="#l19.1880"></a><span id="l19.1880">     return null;</span>
<a href="#l19.1881"></a><span id="l19.1881">   },</span>
<a href="#l19.1882"></a><span id="l19.1882"> </span>
<a href="#l19.1883"></a><span id="l19.1883">   /**</span>
<a href="#l19.1884"></a><span id="l19.1884">    * Determines whether or not the data currently being dragged can be dropped</span>
<a href="#l19.1885"></a><span id="l19.1885">    * on a places view.</span>
<a href="#l19.1886"></a><span id="l19.1886">    * @param ip</span>
<a href="#l19.1887"></a><span id="l19.1887">    *        The insertion point where the items should be dropped.</span>
<a href="#l19.1888"></a><span id="l19.1888" class="difflineat">@@ -1381,209 +1456,255 @@ var PlacesControllerDragHelper = {</span>
<a href="#l19.1889"></a><span id="l19.1889">       // expected cases, which are either unsupported flavors, or items which</span>
<a href="#l19.1890"></a><span id="l19.1890">       // cannot be dropped in the current insertionpoint. The last case will</span>
<a href="#l19.1891"></a><span id="l19.1891">       // likely force us to use unwrapNodes for the private data types of</span>
<a href="#l19.1892"></a><span id="l19.1892">       // places.</span>
<a href="#l19.1893"></a><span id="l19.1893">       if (flavor == TAB_DROP_TYPE)</span>
<a href="#l19.1894"></a><span id="l19.1894">         continue;</span>
<a href="#l19.1895"></a><span id="l19.1895"> </span>
<a href="#l19.1896"></a><span id="l19.1896">       let data = dt.mozGetDataAt(flavor, i);</span>
<a href="#l19.1897"></a><span id="l19.1897" class="difflineminus">-      let dragged;</span>
<a href="#l19.1898"></a><span id="l19.1898" class="difflineplus">+      let nodes;</span>
<a href="#l19.1899"></a><span id="l19.1899">       try {</span>
<a href="#l19.1900"></a><span id="l19.1900" class="difflineminus">-        dragged = PlacesUtils.unwrapNodes(data, flavor)[0];</span>
<a href="#l19.1901"></a><span id="l19.1901" class="difflineminus">-      }</span>
<a href="#l19.1902"></a><span id="l19.1902" class="difflineminus">-      catch (e) {</span>
<a href="#l19.1903"></a><span id="l19.1903" class="difflineplus">+        nodes = PlacesUtils.unwrapNodes(data, flavor);</span>
<a href="#l19.1904"></a><span id="l19.1904" class="difflineplus">+      } catch (e) {</span>
<a href="#l19.1905"></a><span id="l19.1905">         return false;</span>
<a href="#l19.1906"></a><span id="l19.1906">       }</span>
<a href="#l19.1907"></a><span id="l19.1907"> </span>
<a href="#l19.1908"></a><span id="l19.1908" class="difflineminus">-      // Only bookmarks and urls can be dropped into tag containers.</span>
<a href="#l19.1909"></a><span id="l19.1909" class="difflineminus">-      if (ip.isTag &amp;&amp; ip.orientation == Ci.nsITreeView.DROP_ON &amp;&amp;</span>
<a href="#l19.1910"></a><span id="l19.1910" class="difflineminus">-          dragged.type != PlacesUtils.TYPE_X_MOZ_URL &amp;&amp;</span>
<a href="#l19.1911"></a><span id="l19.1911" class="difflineminus">-          (dragged.type != PlacesUtils.TYPE_X_MOZ_PLACE ||</span>
<a href="#l19.1912"></a><span id="l19.1912" class="difflineminus">-           /^place:/.test(dragged.uri)))</span>
<a href="#l19.1913"></a><span id="l19.1913" class="difflineminus">-        return false;</span>
<a href="#l19.1914"></a><span id="l19.1914" class="difflineplus">+      for (let dragged of nodes) {</span>
<a href="#l19.1915"></a><span id="l19.1915" class="difflineplus">+        // Only bookmarks and urls can be dropped into tag containers.</span>
<a href="#l19.1916"></a><span id="l19.1916" class="difflineplus">+        if (ip.isTag &amp;&amp;</span>
<a href="#l19.1917"></a><span id="l19.1917" class="difflineplus">+            dragged.type != PlacesUtils.TYPE_X_MOZ_URL &amp;&amp;</span>
<a href="#l19.1918"></a><span id="l19.1918" class="difflineplus">+            (dragged.type != PlacesUtils.TYPE_X_MOZ_PLACE ||</span>
<a href="#l19.1919"></a><span id="l19.1919" class="difflineplus">+             (dragged.uri &amp;&amp; dragged.uri.startsWith(&quot;place:&quot;)) ))</span>
<a href="#l19.1920"></a><span id="l19.1920" class="difflineplus">+          return false;</span>
<a href="#l19.1921"></a><span id="l19.1921"> </span>
<a href="#l19.1922"></a><span id="l19.1922" class="difflineminus">-      // The following loop disallows the dropping of a folder on itself or</span>
<a href="#l19.1923"></a><span id="l19.1923" class="difflineminus">-      // on any of its descendants.</span>
<a href="#l19.1924"></a><span id="l19.1924" class="difflineminus">-      if (dragged.type == PlacesUtils.TYPE_X_MOZ_PLACE_CONTAINER ||</span>
<a href="#l19.1925"></a><span id="l19.1925" class="difflineminus">-          /^place:/.test(dragged.uri)) {</span>
<a href="#l19.1926"></a><span id="l19.1926" class="difflineminus">-        let parentId = ip.itemId;</span>
<a href="#l19.1927"></a><span id="l19.1927" class="difflineminus">-        while (parentId != PlacesUtils.placesRootId) {</span>
<a href="#l19.1928"></a><span id="l19.1928" class="difflineminus">-          if (dragged.concreteId == parentId || dragged.id == parentId)</span>
<a href="#l19.1929"></a><span id="l19.1929" class="difflineminus">-            return false;</span>
<a href="#l19.1930"></a><span id="l19.1930" class="difflineminus">-          parentId = PlacesUtils.bookmarks.getFolderIdForItem(parentId);</span>
<a href="#l19.1931"></a><span id="l19.1931" class="difflineplus">+        // The following loop disallows the dropping of a folder on itself or</span>
<a href="#l19.1932"></a><span id="l19.1932" class="difflineplus">+        // on any of its descendants.</span>
<a href="#l19.1933"></a><span id="l19.1933" class="difflineplus">+        if (dragged.type == PlacesUtils.TYPE_X_MOZ_PLACE_CONTAINER ||</span>
<a href="#l19.1934"></a><span id="l19.1934" class="difflineplus">+            (dragged.uri &amp;&amp; dragged.uri.startsWith(&quot;place:&quot;)) ) {</span>
<a href="#l19.1935"></a><span id="l19.1935" class="difflineplus">+          let parentId = ip.itemId;</span>
<a href="#l19.1936"></a><span id="l19.1936" class="difflineplus">+          while (parentId != PlacesUtils.placesRootId) {</span>
<a href="#l19.1937"></a><span id="l19.1937" class="difflineplus">+            if (dragged.concreteId == parentId || dragged.id == parentId)</span>
<a href="#l19.1938"></a><span id="l19.1938" class="difflineplus">+              return false;</span>
<a href="#l19.1939"></a><span id="l19.1939" class="difflineplus">+            parentId = PlacesUtils.bookmarks.getFolderIdForItem(parentId);</span>
<a href="#l19.1940"></a><span id="l19.1940" class="difflineplus">+          }</span>
<a href="#l19.1941"></a><span id="l19.1941">         }</span>
<a href="#l19.1942"></a><span id="l19.1942">       }</span>
<a href="#l19.1943"></a><span id="l19.1943">     }</span>
<a href="#l19.1944"></a><span id="l19.1944">     return true;</span>
<a href="#l19.1945"></a><span id="l19.1945">   },</span>
<a href="#l19.1946"></a><span id="l19.1946"> </span>
<a href="#l19.1947"></a><span id="l19.1947" class="difflineplus">+  /**</span>
<a href="#l19.1948"></a><span id="l19.1948" class="difflineplus">+   * Determines if an unwrapped node can be moved.</span>
<a href="#l19.1949"></a><span id="l19.1949" class="difflineplus">+   *</span>
<a href="#l19.1950"></a><span id="l19.1950" class="difflineplus">+   * @param   aUnwrappedNode</span>
<a href="#l19.1951"></a><span id="l19.1951" class="difflineplus">+   *          A node unwrapped by PlacesUtils.unwrapNodes().</span>
<a href="#l19.1952"></a><span id="l19.1952" class="difflineplus">+   * @return True if the node can be moved, false otherwise.</span>
<a href="#l19.1953"></a><span id="l19.1953" class="difflineplus">+   */</span>
<a href="#l19.1954"></a><span id="l19.1954" class="difflineplus">+  canMoveUnwrappedNode(aUnwrappedNode) {</span>
<a href="#l19.1955"></a><span id="l19.1955" class="difflineplus">+    return aUnwrappedNode.id &gt; 0 &amp;&amp;</span>
<a href="#l19.1956"></a><span id="l19.1956" class="difflineplus">+           !PlacesUtils.isRootItem(aUnwrappedNode.id) &amp;&amp;</span>
<a href="#l19.1957"></a><span id="l19.1957" class="difflineplus">+           (!aUnwrappedNode.parent || !PlacesUIUtils.isContentsReadOnly(aUnwrappedNode.parent)) &amp;&amp;</span>
<a href="#l19.1958"></a><span id="l19.1958" class="difflineplus">+           aUnwrappedNode.parent != PlacesUtils.tagsFolderId &amp;&amp;</span>
<a href="#l19.1959"></a><span id="l19.1959" class="difflineplus">+           aUnwrappedNode.grandParentId != PlacesUtils.tagsFolderId;</span>
<a href="#l19.1960"></a><span id="l19.1960" class="difflineplus">+  },</span>
<a href="#l19.1961"></a><span id="l19.1961"> </span>
<a href="#l19.1962"></a><span id="l19.1962">   /**</span>
<a href="#l19.1963"></a><span id="l19.1963">    * Determines if a node can be moved.</span>
<a href="#l19.1964"></a><span id="l19.1964">    *</span>
<a href="#l19.1965"></a><span id="l19.1965">    * @param   aNode</span>
<a href="#l19.1966"></a><span id="l19.1966">    *          A nsINavHistoryResultNode node.</span>
<a href="#l19.1967"></a><span id="l19.1967" class="difflineminus">-   * @returns True if the node can be moved, false otherwise.</span>
<a href="#l19.1968"></a><span id="l19.1968" class="difflineplus">+   * @param   [optional] aDOMNode</span>
<a href="#l19.1969"></a><span id="l19.1969" class="difflineplus">+   *          A XUL DOM node.</span>
<a href="#l19.1970"></a><span id="l19.1970" class="difflineplus">+   * @return True if the node can be moved, false otherwise.</span>
<a href="#l19.1971"></a><span id="l19.1971">    */</span>
<a href="#l19.1972"></a><span id="l19.1972" class="difflineminus">-  canMoveNode:</span>
<a href="#l19.1973"></a><span id="l19.1973" class="difflineminus">-  function PCDH_canMoveNode(aNode) {</span>
<a href="#l19.1974"></a><span id="l19.1974" class="difflineplus">+  canMoveNode(aNode, aDOMNode) {</span>
<a href="#l19.1975"></a><span id="l19.1975">     // Only bookmark items are movable.</span>
<a href="#l19.1976"></a><span id="l19.1976">     if (aNode.itemId == -1)</span>
<a href="#l19.1977"></a><span id="l19.1977">       return false;</span>
<a href="#l19.1978"></a><span id="l19.1978" class="difflineplus">+</span>
<a href="#l19.1979"></a><span id="l19.1979" class="difflineplus">+    let parentNode = aNode.parent;</span>
<a href="#l19.1980"></a><span id="l19.1980" class="difflineplus">+    if (!parentNode) {</span>
<a href="#l19.1981"></a><span id="l19.1981" class="difflineplus">+      // Normally parentless places nodes can not be moved,</span>
<a href="#l19.1982"></a><span id="l19.1982" class="difflineplus">+      // but simulated bookmarked URI nodes are special.</span>
<a href="#l19.1983"></a><span id="l19.1983" class="difflineplus">+      return !!aDOMNode &amp;&amp;</span>
<a href="#l19.1984"></a><span id="l19.1984" class="difflineplus">+             aDOMNode.hasAttribute(&quot;simulated-places-node&quot;) &amp;&amp;</span>
<a href="#l19.1985"></a><span id="l19.1985" class="difflineplus">+             PlacesUtils.nodeIsBookmark(aNode);</span>
<a href="#l19.1986"></a><span id="l19.1986" class="difflineplus">+    }</span>
<a href="#l19.1987"></a><span id="l19.1987" class="difflineplus">+</span>
<a href="#l19.1988"></a><span id="l19.1988">     // Once tags and bookmarked are divorced, the tag-query check should be</span>
<a href="#l19.1989"></a><span id="l19.1989">     // removed.</span>
<a href="#l19.1990"></a><span id="l19.1990" class="difflineminus">-    let parentNode = aNode.parent;</span>
<a href="#l19.1991"></a><span id="l19.1991" class="difflineminus">-    return parentNode &amp;&amp;</span>
<a href="#l19.1992"></a><span id="l19.1992" class="difflineminus">-           !(PlacesUtils.nodeIsFolder(parentNode) &amp;&amp;</span>
<a href="#l19.1993"></a><span id="l19.1993" class="difflineplus">+    return !(PlacesUtils.nodeIsFolder(parentNode) &amp;&amp;</span>
<a href="#l19.1994"></a><span id="l19.1994">              PlacesUIUtils.isContentsReadOnly(parentNode)) &amp;&amp;</span>
<a href="#l19.1995"></a><span id="l19.1995">            !PlacesUtils.nodeIsTagQuery(parentNode);</span>
<a href="#l19.1996"></a><span id="l19.1996" class="difflineminus">-    },</span>
<a href="#l19.1997"></a><span id="l19.1997" class="difflineplus">+  },</span>
<a href="#l19.1998"></a><span id="l19.1998"> </span>
<a href="#l19.1999"></a><span id="l19.1999">   /**</span>
<a href="#l19.2000"></a><span id="l19.2000">    * Handles the drop of one or more items onto a view.</span>
<a href="#l19.2001"></a><span id="l19.2001">    * @param   insertionPoint</span>
<a href="#l19.2002"></a><span id="l19.2002">    *          The insertion point where the items should be dropped</span>
<a href="#l19.2003"></a><span id="l19.2003">    */</span>
<a href="#l19.2004"></a><span id="l19.2004" class="difflineminus">-  onDrop: function PCDH_onDrop(insertionPoint, dt) {</span>
<a href="#l19.2005"></a><span id="l19.2005" class="difflineminus">-    let doCopy = [&quot;copy&quot;, &quot;link&quot;].indexOf(dt.dropEffect) != -1;</span>
<a href="#l19.2006"></a><span id="l19.2006" class="difflineplus">+  async onDrop(insertionPoint, dt) {</span>
<a href="#l19.2007"></a><span id="l19.2007" class="difflineplus">+    let doCopy = [&quot;copy&quot;, &quot;link&quot;].includes(dt.dropEffect);</span>
<a href="#l19.2008"></a><span id="l19.2008"> </span>
<a href="#l19.2009"></a><span id="l19.2009">     let transactions = [];</span>
<a href="#l19.2010"></a><span id="l19.2010">     let dropCount = dt.mozItemCount;</span>
<a href="#l19.2011"></a><span id="l19.2011">     let movedCount = 0;</span>
<a href="#l19.2012"></a><span id="l19.2012" class="difflineplus">+    let parentGuid = PlacesUIUtils.useAsyncTransactions ?</span>
<a href="#l19.2013"></a><span id="l19.2013" class="difflineplus">+                       (await insertionPoint.promiseGuid()) : null;</span>
<a href="#l19.2014"></a><span id="l19.2014" class="difflineplus">+    let tagName = insertionPoint.tagName;</span>
<a href="#l19.2015"></a><span id="l19.2015" class="difflineplus">+</span>
<a href="#l19.2016"></a><span id="l19.2016" class="difflineplus">+    // Following flavors may contain duplicated data.</span>
<a href="#l19.2017"></a><span id="l19.2017" class="difflineplus">+    let duplicable = new Map();</span>
<a href="#l19.2018"></a><span id="l19.2018" class="difflineplus">+    duplicable.set(PlacesUtils.TYPE_UNICODE, new Set());</span>
<a href="#l19.2019"></a><span id="l19.2019" class="difflineplus">+    duplicable.set(PlacesUtils.TYPE_X_MOZ_URL, new Set());</span>
<a href="#l19.2020"></a><span id="l19.2020" class="difflineplus">+</span>
<a href="#l19.2021"></a><span id="l19.2021">     for (let i = 0; i &lt; dropCount; ++i) {</span>
<a href="#l19.2022"></a><span id="l19.2022">       let flavor = this.getFirstValidFlavor(dt.mozTypesAt(i));</span>
<a href="#l19.2023"></a><span id="l19.2023">       if (!flavor)</span>
<a href="#l19.2024"></a><span id="l19.2024">         return;</span>
<a href="#l19.2025"></a><span id="l19.2025"> </span>
<a href="#l19.2026"></a><span id="l19.2026">       let data = dt.mozGetDataAt(flavor, i);</span>
<a href="#l19.2027"></a><span id="l19.2027" class="difflineminus">-      let unwrapped;</span>
<a href="#l19.2028"></a><span id="l19.2028" class="difflineplus">+      if (duplicable.has(flavor)) {</span>
<a href="#l19.2029"></a><span id="l19.2029" class="difflineplus">+        let handled = duplicable.get(flavor);</span>
<a href="#l19.2030"></a><span id="l19.2030" class="difflineplus">+        if (handled.has(data))</span>
<a href="#l19.2031"></a><span id="l19.2031" class="difflineplus">+          continue;</span>
<a href="#l19.2032"></a><span id="l19.2032" class="difflineplus">+        handled.add(data);</span>
<a href="#l19.2033"></a><span id="l19.2033" class="difflineplus">+      }</span>
<a href="#l19.2034"></a><span id="l19.2034" class="difflineplus">+</span>
<a href="#l19.2035"></a><span id="l19.2035" class="difflineplus">+      let nodes;</span>
<a href="#l19.2036"></a><span id="l19.2036">       if (flavor != TAB_DROP_TYPE) {</span>
<a href="#l19.2037"></a><span id="l19.2037" class="difflineminus">-        // There's only ever one in the D&amp;D case.</span>
<a href="#l19.2038"></a><span id="l19.2038" class="difflineminus">-        unwrapped = PlacesUtils.unwrapNodes(data, flavor)[0];</span>
<a href="#l19.2039"></a><span id="l19.2039" class="difflineminus">-      }</span>
<a href="#l19.2040"></a><span id="l19.2040" class="difflineminus">-      else if (data instanceof XULElement &amp;&amp; data.localName == &quot;tab&quot; &amp;&amp;</span>
<a href="#l19.2041"></a><span id="l19.2041" class="difflineminus">-               data.ownerDocument.defaultView instanceof ChromeWindow) {</span>
<a href="#l19.2042"></a><span id="l19.2042" class="difflineplus">+        nodes = PlacesUtils.unwrapNodes(data, flavor);</span>
<a href="#l19.2043"></a><span id="l19.2043" class="difflineplus">+      } else if (data instanceof XULElement &amp;&amp; data.localName == &quot;tab&quot; &amp;&amp;</span>
<a href="#l19.2044"></a><span id="l19.2044" class="difflineplus">+               data.ownerGlobal instanceof ChromeWindow) {</span>
<a href="#l19.2045"></a><span id="l19.2045">         let uri = data.linkedBrowser.currentURI;</span>
<a href="#l19.2046"></a><span id="l19.2046">         let spec = uri ? uri.spec : &quot;about:blank&quot;;</span>
<a href="#l19.2047"></a><span id="l19.2047" class="difflineminus">-        let title = data.label;</span>
<a href="#l19.2048"></a><span id="l19.2048" class="difflineminus">-        unwrapped = { uri: spec,</span>
<a href="#l19.2049"></a><span id="l19.2049" class="difflineminus">-                      title: data.label,</span>
<a href="#l19.2050"></a><span id="l19.2050" class="difflineminus">-                      type: PlacesUtils.TYPE_X_MOZ_URL};</span>
<a href="#l19.2051"></a><span id="l19.2051" class="difflineminus">-      }</span>
<a href="#l19.2052"></a><span id="l19.2052" class="difflineminus">-      else</span>
<a href="#l19.2053"></a><span id="l19.2053" class="difflineminus">-        throw(&quot;bogus data was passed as a tab&quot;)</span>
<a href="#l19.2054"></a><span id="l19.2054" class="difflineplus">+        nodes = [{ uri: spec,</span>
<a href="#l19.2055"></a><span id="l19.2055" class="difflineplus">+                   title: data.label,</span>
<a href="#l19.2056"></a><span id="l19.2056" class="difflineplus">+                   type: PlacesUtils.TYPE_X_MOZ_URL}];</span>
<a href="#l19.2057"></a><span id="l19.2057" class="difflineplus">+      } else</span>
<a href="#l19.2058"></a><span id="l19.2058" class="difflineplus">+        throw new Error(&quot;bogus data was passed as a tab&quot;);</span>
<a href="#l19.2059"></a><span id="l19.2059"> </span>
<a href="#l19.2060"></a><span id="l19.2060" class="difflineminus">-      let index = insertionPoint.index;</span>
<a href="#l19.2061"></a><span id="l19.2061" class="difflineplus">+      for (let unwrapped of nodes) {</span>
<a href="#l19.2062"></a><span id="l19.2062" class="difflineplus">+        let index = insertionPoint.index;</span>
<a href="#l19.2063"></a><span id="l19.2063" class="difflineplus">+</span>
<a href="#l19.2064"></a><span id="l19.2064" class="difflineplus">+        // Adjust insertion index to prevent reversal of dragged items. When you</span>
<a href="#l19.2065"></a><span id="l19.2065" class="difflineplus">+        // drag multiple elts upward: need to increment index or each successive</span>
<a href="#l19.2066"></a><span id="l19.2066" class="difflineplus">+        // elt will be inserted at the same index, each above the previous.</span>
<a href="#l19.2067"></a><span id="l19.2067" class="difflineplus">+        let dragginUp = insertionPoint.itemId == unwrapped.parent &amp;&amp;</span>
<a href="#l19.2068"></a><span id="l19.2068" class="difflineplus">+                        index &lt; PlacesUtils.bookmarks.getItemIndex(unwrapped.id);</span>
<a href="#l19.2069"></a><span id="l19.2069" class="difflineplus">+        if (index != -1 &amp;&amp; dragginUp)</span>
<a href="#l19.2070"></a><span id="l19.2070" class="difflineplus">+          index += movedCount++;</span>
<a href="#l19.2071"></a><span id="l19.2071"> </span>
<a href="#l19.2072"></a><span id="l19.2072" class="difflineminus">-      // Adjust insertion index to prevent reversal of dragged items. When you</span>
<a href="#l19.2073"></a><span id="l19.2073" class="difflineminus">-      // drag multiple elts upward: need to increment index or each successive</span>
<a href="#l19.2074"></a><span id="l19.2074" class="difflineminus">-      // elt will be inserted at the same index, each above the previous.</span>
<a href="#l19.2075"></a><span id="l19.2075" class="difflineminus">-      let dragginUp = insertionPoint.itemId == unwrapped.parent &amp;&amp;</span>
<a href="#l19.2076"></a><span id="l19.2076" class="difflineminus">-                      index &lt; PlacesUtils.bookmarks.getItemIndex(unwrapped.id);</span>
<a href="#l19.2077"></a><span id="l19.2077" class="difflineminus">-      if (index != -1 &amp;&amp; dragginUp)</span>
<a href="#l19.2078"></a><span id="l19.2078" class="difflineminus">-        index+= movedCount++;</span>
<a href="#l19.2079"></a><span id="l19.2079" class="difflineminus">-</span>
<a href="#l19.2080"></a><span id="l19.2080" class="difflineminus">-      // If dragging over a tag container we should tag the item.</span>
<a href="#l19.2081"></a><span id="l19.2081" class="difflineminus">-      if (insertionPoint.isTag &amp;&amp;</span>
<a href="#l19.2082"></a><span id="l19.2082" class="difflineminus">-          insertionPoint.orientation == Ci.nsITreeView.DROP_ON) {</span>
<a href="#l19.2083"></a><span id="l19.2083" class="difflineminus">-        let uri = PlacesUtils._uri(unwrapped.uri);</span>
<a href="#l19.2084"></a><span id="l19.2084" class="difflineminus">-        let tagItemId = insertionPoint.itemId;</span>
<a href="#l19.2085"></a><span id="l19.2085" class="difflineminus">-        let tagTxn = new PlacesTagURITransaction(uri, [tagItemId]);</span>
<a href="#l19.2086"></a><span id="l19.2086" class="difflineminus">-        transactions.push(tagTxn);</span>
<a href="#l19.2087"></a><span id="l19.2087" class="difflineminus">-      }</span>
<a href="#l19.2088"></a><span id="l19.2088" class="difflineminus">-      else {</span>
<a href="#l19.2089"></a><span id="l19.2089" class="difflineminus">-        transactions.push(PlacesUIUtils.makeTransaction(unwrapped,</span>
<a href="#l19.2090"></a><span id="l19.2090" class="difflineminus">-                          flavor, insertionPoint.itemId,</span>
<a href="#l19.2091"></a><span id="l19.2091" class="difflineminus">-                          index, doCopy));</span>
<a href="#l19.2092"></a><span id="l19.2092" class="difflineplus">+        // If dragging over a tag container we should tag the item.</span>
<a href="#l19.2093"></a><span id="l19.2093" class="difflineplus">+        if (insertionPoint.isTag) {</span>
<a href="#l19.2094"></a><span id="l19.2094" class="difflineplus">+          let uri = NetUtil.newURI(unwrapped.uri);</span>
<a href="#l19.2095"></a><span id="l19.2095" class="difflineplus">+          let tagItemId = insertionPoint.itemId;</span>
<a href="#l19.2096"></a><span id="l19.2096" class="difflineplus">+          if (PlacesUIUtils.useAsyncTransactions)</span>
<a href="#l19.2097"></a><span id="l19.2097" class="difflineplus">+            transactions.push(PlacesTransactions.Tag({ uri, tag: tagName }));</span>
<a href="#l19.2098"></a><span id="l19.2098" class="difflineplus">+          else</span>
<a href="#l19.2099"></a><span id="l19.2099" class="difflineplus">+            transactions.push(new PlacesTagURITransaction(uri, [tagItemId]));</span>
<a href="#l19.2100"></a><span id="l19.2100" class="difflineplus">+        } else {</span>
<a href="#l19.2101"></a><span id="l19.2101" class="difflineplus">+          // If this is not a copy, check for safety that we can move the</span>
<a href="#l19.2102"></a><span id="l19.2102" class="difflineplus">+          // source, otherwise report an error and fallback to a copy.</span>
<a href="#l19.2103"></a><span id="l19.2103" class="difflineplus">+          if (!doCopy &amp;&amp; !PlacesControllerDragHelper.canMoveUnwrappedNode(unwrapped)) {</span>
<a href="#l19.2104"></a><span id="l19.2104" class="difflineplus">+            Cu.reportError(&quot;Tried to move an unmovable Places &quot; +</span>
<a href="#l19.2105"></a><span id="l19.2105" class="difflineplus">+                                         &quot;node, reverting to a copy operation.&quot;);</span>
<a href="#l19.2106"></a><span id="l19.2106" class="difflineplus">+            doCopy = true;</span>
<a href="#l19.2107"></a><span id="l19.2107" class="difflineplus">+          }</span>
<a href="#l19.2108"></a><span id="l19.2108" class="difflineplus">+          if (PlacesUIUtils.useAsyncTransactions) {</span>
<a href="#l19.2109"></a><span id="l19.2109" class="difflineplus">+            transactions.push(</span>
<a href="#l19.2110"></a><span id="l19.2110" class="difflineplus">+              PlacesUIUtils.getTransactionForData(unwrapped,</span>
<a href="#l19.2111"></a><span id="l19.2111" class="difflineplus">+                                                  flavor,</span>
<a href="#l19.2112"></a><span id="l19.2112" class="difflineplus">+                                                  parentGuid,</span>
<a href="#l19.2113"></a><span id="l19.2113" class="difflineplus">+                                                  index,</span>
<a href="#l19.2114"></a><span id="l19.2114" class="difflineplus">+                                                  doCopy));</span>
<a href="#l19.2115"></a><span id="l19.2115" class="difflineplus">+          } else {</span>
<a href="#l19.2116"></a><span id="l19.2116" class="difflineplus">+            transactions.push(PlacesUIUtils.makeTransaction(unwrapped,</span>
<a href="#l19.2117"></a><span id="l19.2117" class="difflineplus">+                                flavor, insertionPoint.itemId,</span>
<a href="#l19.2118"></a><span id="l19.2118" class="difflineplus">+                                index, doCopy));</span>
<a href="#l19.2119"></a><span id="l19.2119" class="difflineplus">+          }</span>
<a href="#l19.2120"></a><span id="l19.2120" class="difflineplus">+        }</span>
<a href="#l19.2121"></a><span id="l19.2121">       }</span>
<a href="#l19.2122"></a><span id="l19.2122">     }</span>
<a href="#l19.2123"></a><span id="l19.2123"> </span>
<a href="#l19.2124"></a><span id="l19.2124" class="difflineminus">-    let txn = new PlacesAggregatedTransaction(&quot;DropItems&quot;, transactions);</span>
<a href="#l19.2125"></a><span id="l19.2125" class="difflineminus">-    PlacesUtils.transactionManager.doTransaction(txn);</span>
<a href="#l19.2126"></a><span id="l19.2126" class="difflineplus">+    if (PlacesUIUtils.useAsyncTransactions) {</span>
<a href="#l19.2127"></a><span id="l19.2127" class="difflineplus">+      await PlacesTransactions.batch(transactions);</span>
<a href="#l19.2128"></a><span id="l19.2128" class="difflineplus">+    } else {</span>
<a href="#l19.2129"></a><span id="l19.2129" class="difflineplus">+      let txn = new PlacesAggregatedTransaction(&quot;DropItems&quot;, transactions);</span>
<a href="#l19.2130"></a><span id="l19.2130" class="difflineplus">+      PlacesUtils.transactionManager.doTransaction(txn);</span>
<a href="#l19.2131"></a><span id="l19.2131" class="difflineplus">+    }</span>
<a href="#l19.2132"></a><span id="l19.2132">   },</span>
<a href="#l19.2133"></a><span id="l19.2133"> </span>
<a href="#l19.2134"></a><span id="l19.2134">   /**</span>
<a href="#l19.2135"></a><span id="l19.2135">    * Checks if we can insert into a container.</span>
<a href="#l19.2136"></a><span id="l19.2136">    * @param   aContainer</span>
<a href="#l19.2137"></a><span id="l19.2137">    *          The container were we are want to drop</span>
<a href="#l19.2138"></a><span id="l19.2138">    */</span>
<a href="#l19.2139"></a><span id="l19.2139" class="difflineminus">-  disallowInsertion: function(aContainer) {</span>
<a href="#l19.2140"></a><span id="l19.2140" class="difflineplus">+  disallowInsertion(aContainer) {</span>
<a href="#l19.2141"></a><span id="l19.2141">     NS_ASSERT(aContainer, &quot;empty container&quot;);</span>
<a href="#l19.2142"></a><span id="l19.2142">     // Allow dropping into Tag containers and editable folders.</span>
<a href="#l19.2143"></a><span id="l19.2143">     return !PlacesUtils.nodeIsTagQuery(aContainer) &amp;&amp;</span>
<a href="#l19.2144"></a><span id="l19.2144">            (!PlacesUtils.nodeIsFolder(aContainer) ||</span>
<a href="#l19.2145"></a><span id="l19.2145">             PlacesUIUtils.isContentsReadOnly(aContainer));</span>
<a href="#l19.2146"></a><span id="l19.2146" class="difflineminus">-  },</span>
<a href="#l19.2147"></a><span id="l19.2147" class="difflineminus">-</span>
<a href="#l19.2148"></a><span id="l19.2148" class="difflineminus">-  placesFlavors: [PlacesUtils.TYPE_X_MOZ_PLACE_CONTAINER,</span>
<a href="#l19.2149"></a><span id="l19.2149" class="difflineminus">-                  PlacesUtils.TYPE_X_MOZ_PLACE_SEPARATOR,</span>
<a href="#l19.2150"></a><span id="l19.2150" class="difflineminus">-                  PlacesUtils.TYPE_X_MOZ_PLACE],</span>
<a href="#l19.2151"></a><span id="l19.2151" class="difflineminus">-</span>
<a href="#l19.2152"></a><span id="l19.2152" class="difflineminus">-  // The order matters.</span>
<a href="#l19.2153"></a><span id="l19.2153" class="difflineminus">-  GENERIC_VIEW_DROP_TYPES: [PlacesUtils.TYPE_X_MOZ_PLACE_CONTAINER,</span>
<a href="#l19.2154"></a><span id="l19.2154" class="difflineminus">-                            PlacesUtils.TYPE_X_MOZ_PLACE_SEPARATOR,</span>
<a href="#l19.2155"></a><span id="l19.2155" class="difflineminus">-                            PlacesUtils.TYPE_X_MOZ_PLACE,</span>
<a href="#l19.2156"></a><span id="l19.2156" class="difflineminus">-                            PlacesUtils.TYPE_X_MOZ_URL,</span>
<a href="#l19.2157"></a><span id="l19.2157" class="difflineminus">-                            TAB_DROP_TYPE,</span>
<a href="#l19.2158"></a><span id="l19.2158" class="difflineminus">-                            PlacesUtils.TYPE_UNICODE],</span>
<a href="#l19.2159"></a><span id="l19.2159" class="difflineplus">+  }</span>
<a href="#l19.2160"></a><span id="l19.2160"> };</span>
<a href="#l19.2161"></a><span id="l19.2161"> </span>
<a href="#l19.2162"></a><span id="l19.2162"> </span>
<a href="#l19.2163"></a><span id="l19.2163"> XPCOMUtils.defineLazyServiceGetter(PlacesControllerDragHelper, &quot;dragService&quot;,</span>
<a href="#l19.2164"></a><span id="l19.2164">                                    &quot;@mozilla.org/widget/dragservice;1&quot;,</span>
<a href="#l19.2165"></a><span id="l19.2165">                                    &quot;nsIDragService&quot;);</span>
<a href="#l19.2166"></a><span id="l19.2166"> </span>
<a href="#l19.2167"></a><span id="l19.2167"> function goUpdatePlacesCommands() {</span>
<a href="#l19.2168"></a><span id="l19.2168">   // Get the controller for one of the places commands.</span>
<a href="#l19.2169"></a><span id="l19.2169">   var placesController = doGetPlacesControllerForCommand(&quot;placesCmd_open&quot;);</span>
<a href="#l19.2170"></a><span id="l19.2170" class="difflineminus">-  if (!placesController)</span>
<a href="#l19.2171"></a><span id="l19.2171" class="difflineminus">-    return;</span>
<a href="#l19.2172"></a><span id="l19.2172" class="difflineminus">-</span>
<a href="#l19.2173"></a><span id="l19.2173">   function updatePlacesCommand(aCommand) {</span>
<a href="#l19.2174"></a><span id="l19.2174" class="difflineminus">-    goSetCommandEnabled(aCommand, placesController.isCommandEnabled(aCommand));</span>
<a href="#l19.2175"></a><span id="l19.2175" class="difflineplus">+    goSetCommandEnabled(aCommand, placesController &amp;&amp;</span>
<a href="#l19.2176"></a><span id="l19.2176" class="difflineplus">+                                  placesController.isCommandEnabled(aCommand));</span>
<a href="#l19.2177"></a><span id="l19.2177">   }</span>
<a href="#l19.2178"></a><span id="l19.2178"> </span>
<a href="#l19.2179"></a><span id="l19.2179">   updatePlacesCommand(&quot;placesCmd_open&quot;);</span>
<a href="#l19.2180"></a><span id="l19.2180" class="difflineminus">-  updatePlacesCommand(&quot;placesCmd_open:tab&quot;);</span>
<a href="#l19.2181"></a><span id="l19.2181">   updatePlacesCommand(&quot;placesCmd_open:window&quot;);</span>
<a href="#l19.2182"></a><span id="l19.2182">   updatePlacesCommand(&quot;placesCmd_open:privatewindow&quot;);</span>
<a href="#l19.2183"></a><span id="l19.2183" class="difflineplus">+  updatePlacesCommand(&quot;placesCmd_open:tab&quot;);</span>
<a href="#l19.2184"></a><span id="l19.2184">   updatePlacesCommand(&quot;placesCmd_new:folder&quot;);</span>
<a href="#l19.2185"></a><span id="l19.2185">   updatePlacesCommand(&quot;placesCmd_new:bookmark&quot;);</span>
<a href="#l19.2186"></a><span id="l19.2186" class="difflineminus">-  updatePlacesCommand(&quot;placesCmd_new:livemark&quot;);</span>
<a href="#l19.2187"></a><span id="l19.2187">   updatePlacesCommand(&quot;placesCmd_new:separator&quot;);</span>
<a href="#l19.2188"></a><span id="l19.2188">   updatePlacesCommand(&quot;placesCmd_show:info&quot;);</span>
<a href="#l19.2189"></a><span id="l19.2189" class="difflineminus">-  updatePlacesCommand(&quot;placesCmd_moveBookmarks&quot;);</span>
<a href="#l19.2190"></a><span id="l19.2190">   updatePlacesCommand(&quot;placesCmd_reload&quot;);</span>
<a href="#l19.2191"></a><span id="l19.2191">   updatePlacesCommand(&quot;placesCmd_sortBy:name&quot;);</span>
<a href="#l19.2192"></a><span id="l19.2192">   updatePlacesCommand(&quot;placesCmd_cut&quot;);</span>
<a href="#l19.2193"></a><span id="l19.2193">   updatePlacesCommand(&quot;placesCmd_copy&quot;);</span>
<a href="#l19.2194"></a><span id="l19.2194">   updatePlacesCommand(&quot;placesCmd_paste&quot;);</span>
<a href="#l19.2195"></a><span id="l19.2195">   updatePlacesCommand(&quot;placesCmd_delete&quot;);</span>
<a href="#l19.2196"></a><span id="l19.2196"> }</span>
<a href="#l19.2197"></a><span id="l19.2197"> </span>
<a href="#l19.2198"></a><span id="l19.2198" class="difflineminus">-function doGetPlacesControllerForCommand(aCommand)</span>
<a href="#l19.2199"></a><span id="l19.2199" class="difflineminus">-{</span>
<a href="#l19.2200"></a><span id="l19.2200" class="difflineplus">+function doGetPlacesControllerForCommand(aCommand) {</span>
<a href="#l19.2201"></a><span id="l19.2201">   // A context menu may be built for non-focusable views.  Thus, we first try</span>
<a href="#l19.2202"></a><span id="l19.2202">   // to look for a view associated with document.popupNode</span>
<a href="#l19.2203"></a><span id="l19.2203" class="difflineminus">-  let popupNode = document.popupNode;</span>
<a href="#l19.2204"></a><span id="l19.2204" class="difflineplus">+  let popupNode;</span>
<a href="#l19.2205"></a><span id="l19.2205" class="difflineplus">+  try {</span>
<a href="#l19.2206"></a><span id="l19.2206" class="difflineplus">+    popupNode = document.popupNode;</span>
<a href="#l19.2207"></a><span id="l19.2207" class="difflineplus">+  } catch (e) {</span>
<a href="#l19.2208"></a><span id="l19.2208" class="difflineplus">+    // The document went away (bug 797307).</span>
<a href="#l19.2209"></a><span id="l19.2209" class="difflineplus">+    return null;</span>
<a href="#l19.2210"></a><span id="l19.2210" class="difflineplus">+  }</span>
<a href="#l19.2211"></a><span id="l19.2211">   if (popupNode) {</span>
<a href="#l19.2212"></a><span id="l19.2212">     let view = PlacesUIUtils.getViewForNode(popupNode);</span>
<a href="#l19.2213"></a><span id="l19.2213">     if (view &amp;&amp; view._contextMenuShown)</span>
<a href="#l19.2214"></a><span id="l19.2214">       return view.controllers.getControllerForCommand(aCommand);</span>
<a href="#l19.2215"></a><span id="l19.2215">   }</span>
<a href="#l19.2216"></a><span id="l19.2216"> </span>
<a href="#l19.2217"></a><span id="l19.2217">   // When we're not building a context menu, only focusable views</span>
<a href="#l19.2218"></a><span id="l19.2218">   // are possible.  Thus, we can safely use the command dispatcher.</span>
<a href="#l19.2219"></a><span id="l19.2219">   let controller = top.document.commandDispatcher</span>
<a href="#l19.2220"></a><span id="l19.2220">                       .getControllerForCommand(aCommand);</span>
<a href="#l19.2221"></a><span id="l19.2221">   if (controller)</span>
<a href="#l19.2222"></a><span id="l19.2222">     return controller;</span>
<a href="#l19.2223"></a><span id="l19.2223"> </span>
<a href="#l19.2224"></a><span id="l19.2224">   return null;</span>
<a href="#l19.2225"></a><span id="l19.2225"> }</span>
<a href="#l19.2226"></a><span id="l19.2226"> </span>
<a href="#l19.2227"></a><span id="l19.2227" class="difflineminus">-function goDoPlacesCommand(aCommand)</span>
<a href="#l19.2228"></a><span id="l19.2228" class="difflineminus">-{</span>
<a href="#l19.2229"></a><span id="l19.2229" class="difflineplus">+function goDoPlacesCommand(aCommand) {</span>
<a href="#l19.2230"></a><span id="l19.2230">   let controller = doGetPlacesControllerForCommand(aCommand);</span>
<a href="#l19.2231"></a><span id="l19.2231">   if (controller &amp;&amp; controller.isCommandEnabled(aCommand))</span>
<a href="#l19.2232"></a><span id="l19.2232">     controller.doCommand(aCommand);</span>
<a href="#l19.2233"></a><span id="l19.2233"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/suite/common/places/content/editBookmarkOverlay.js</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/suite/common/places/content/editBookmarkOverlay.js</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -1,978 +1,1220 @@</span>
<a href="#l20.4"></a><span id="l20.4" class="difflineminus">-/* -*- Mode: C++; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l20.5"></a><span id="l20.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l20.6"></a><span id="l20.6" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l20.7"></a><span id="l20.7" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l20.8"></a><span id="l20.8" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l20.9"></a><span id="l20.9" class="difflineplus">+ * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l20.10"></a><span id="l20.10"> </span>
<a href="#l20.11"></a><span id="l20.11" class="difflineminus">-ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineplus">+ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l20.13"></a><span id="l20.13"> </span>
<a href="#l20.14"></a><span id="l20.14"> const LAST_USED_ANNO = &quot;bookmarkPropertiesDialog/folderLastUsed&quot;;</span>
<a href="#l20.15"></a><span id="l20.15"> const MAX_FOLDER_ITEM_IN_MENU_LIST = 5;</span>
<a href="#l20.16"></a><span id="l20.16"> </span>
<a href="#l20.17"></a><span id="l20.17"> var gEditItemOverlay = {</span>
<a href="#l20.18"></a><span id="l20.18" class="difflineminus">-  _uri: null,</span>
<a href="#l20.19"></a><span id="l20.19" class="difflineminus">-  _itemId: -1,</span>
<a href="#l20.20"></a><span id="l20.20" class="difflineminus">-  _itemIds: [],</span>
<a href="#l20.21"></a><span id="l20.21" class="difflineminus">-  _uris: [],</span>
<a href="#l20.22"></a><span id="l20.22" class="difflineminus">-  _tags: [],</span>
<a href="#l20.23"></a><span id="l20.23" class="difflineminus">-  _allTags: [],</span>
<a href="#l20.24"></a><span id="l20.24" class="difflineminus">-  _multiEdit: false,</span>
<a href="#l20.25"></a><span id="l20.25" class="difflineminus">-  _itemType: -1,</span>
<a href="#l20.26"></a><span id="l20.26" class="difflineminus">-  _readOnly: false,</span>
<a href="#l20.27"></a><span id="l20.27" class="difflineminus">-  _hiddenRows: [],</span>
<a href="#l20.28"></a><span id="l20.28">   _observersAdded: false,</span>
<a href="#l20.29"></a><span id="l20.29">   _staticFoldersListBuilt: false,</span>
<a href="#l20.30"></a><span id="l20.30" class="difflineminus">-  _initialized: false,</span>
<a href="#l20.31"></a><span id="l20.31" class="difflineminus">-  _titleOverride: null,</span>
<a href="#l20.32"></a><span id="l20.32" class="difflineplus">+</span>
<a href="#l20.33"></a><span id="l20.33" class="difflineplus">+  _paneInfo: null,</span>
<a href="#l20.34"></a><span id="l20.34" class="difflineplus">+  _setPaneInfo(aInitInfo) {</span>
<a href="#l20.35"></a><span id="l20.35" class="difflineplus">+    if (!aInitInfo)</span>
<a href="#l20.36"></a><span id="l20.36" class="difflineplus">+      return this._paneInfo = null;</span>
<a href="#l20.37"></a><span id="l20.37" class="difflineplus">+</span>
<a href="#l20.38"></a><span id="l20.38" class="difflineplus">+    if (&quot;uris&quot; in aInitInfo &amp;&amp; &quot;node&quot; in aInitInfo)</span>
<a href="#l20.39"></a><span id="l20.39" class="difflineplus">+      throw new Error(&quot;ambiguous pane info&quot;);</span>
<a href="#l20.40"></a><span id="l20.40" class="difflineplus">+    if (!(&quot;uris&quot; in aInitInfo) &amp;&amp; !(&quot;node&quot; in aInitInfo))</span>
<a href="#l20.41"></a><span id="l20.41" class="difflineplus">+      throw new Error(&quot;Neither node nor uris set for pane info&quot;);</span>
<a href="#l20.42"></a><span id="l20.42" class="difflineplus">+</span>
<a href="#l20.43"></a><span id="l20.43" class="difflineplus">+    // Once we stop supporting legacy add-ons the code should throw if a node is</span>
<a href="#l20.44"></a><span id="l20.44" class="difflineplus">+    // not passed.</span>
<a href="#l20.45"></a><span id="l20.45" class="difflineplus">+    let node = &quot;node&quot; in aInitInfo ? aInitInfo.node : null;</span>
<a href="#l20.46"></a><span id="l20.46" class="difflineplus">+</span>
<a href="#l20.47"></a><span id="l20.47" class="difflineplus">+    // Since there's no true UI for folder shortcuts (they show up just as their target</span>
<a href="#l20.48"></a><span id="l20.48" class="difflineplus">+    // folders), when the pane shows for them it's opened in read-only mode, showing the</span>
<a href="#l20.49"></a><span id="l20.49" class="difflineplus">+    // properties of the target folder.</span>
<a href="#l20.50"></a><span id="l20.50" class="difflineplus">+    let itemId = node ? node.itemId : -1;</span>
<a href="#l20.51"></a><span id="l20.51" class="difflineplus">+    let itemGuid = node ? PlacesUtils.getConcreteItemGuid(node) : null;</span>
<a href="#l20.52"></a><span id="l20.52" class="difflineplus">+    let isItem = itemId != -1;</span>
<a href="#l20.53"></a><span id="l20.53" class="difflineplus">+    let isFolderShortcut = isItem &amp;&amp;</span>
<a href="#l20.54"></a><span id="l20.54" class="difflineplus">+                           node.type == Ci.nsINavHistoryResultNode.RESULT_TYPE_FOLDER_SHORTCUT;</span>
<a href="#l20.55"></a><span id="l20.55" class="difflineplus">+    let isTag = node &amp;&amp; PlacesUtils.nodeIsTagQuery(node);</span>
<a href="#l20.56"></a><span id="l20.56" class="difflineplus">+    if (isTag) {</span>
<a href="#l20.57"></a><span id="l20.57" class="difflineplus">+      itemId = PlacesUtils.getConcreteItemId(node);</span>
<a href="#l20.58"></a><span id="l20.58" class="difflineplus">+      // For now we don't have access to the item guid synchronously for tags,</span>
<a href="#l20.59"></a><span id="l20.59" class="difflineplus">+      // so we'll need to fetch it later.</span>
<a href="#l20.60"></a><span id="l20.60" class="difflineplus">+    }</span>
<a href="#l20.61"></a><span id="l20.61" class="difflineplus">+    let isURI = node &amp;&amp; PlacesUtils.nodeIsURI(node);</span>
<a href="#l20.62"></a><span id="l20.62" class="difflineplus">+    let uri = isURI ? NetUtil.newURI(node.uri) : null;</span>
<a href="#l20.63"></a><span id="l20.63" class="difflineplus">+    let title = node ? node.title : null;</span>
<a href="#l20.64"></a><span id="l20.64" class="difflineplus">+    let isBookmark = isItem &amp;&amp; isURI;</span>
<a href="#l20.65"></a><span id="l20.65" class="difflineplus">+    let bulkTagging = !node;</span>
<a href="#l20.66"></a><span id="l20.66" class="difflineplus">+    let uris = bulkTagging ? aInitInfo.uris : null;</span>
<a href="#l20.67"></a><span id="l20.67" class="difflineplus">+    let visibleRows = new Set();</span>
<a href="#l20.68"></a><span id="l20.68" class="difflineplus">+    let isParentReadOnly = false;</span>
<a href="#l20.69"></a><span id="l20.69" class="difflineplus">+    let postData = aInitInfo.postData;</span>
<a href="#l20.70"></a><span id="l20.70" class="difflineplus">+    let parentId = -1;</span>
<a href="#l20.71"></a><span id="l20.71" class="difflineplus">+    let parentGuid = null;</span>
<a href="#l20.72"></a><span id="l20.72" class="difflineplus">+</span>
<a href="#l20.73"></a><span id="l20.73" class="difflineplus">+    if (node &amp;&amp; isItem) {</span>
<a href="#l20.74"></a><span id="l20.74" class="difflineplus">+      if (!node.parent || (node.parent.itemId &gt; 0 &amp;&amp; !node.parent.bookmarkGuid)) {</span>
<a href="#l20.75"></a><span id="l20.75" class="difflineplus">+        throw new Error(&quot;Cannot use an incomplete node to initialize the edit bookmark panel&quot;);</span>
<a href="#l20.76"></a><span id="l20.76" class="difflineplus">+      }</span>
<a href="#l20.77"></a><span id="l20.77" class="difflineplus">+      let parent = node.parent;</span>
<a href="#l20.78"></a><span id="l20.78" class="difflineplus">+      isParentReadOnly = !PlacesUtils.nodeIsFolder(parent) ||</span>
<a href="#l20.79"></a><span id="l20.79" class="difflineplus">+                          PlacesUIUtils.isContentsReadOnly(parent);</span>
<a href="#l20.80"></a><span id="l20.80" class="difflineplus">+      parentId = parent.itemId;</span>
<a href="#l20.81"></a><span id="l20.81" class="difflineplus">+      parentGuid = parent.bookmarkGuid;</span>
<a href="#l20.82"></a><span id="l20.82" class="difflineplus">+    }</span>
<a href="#l20.83"></a><span id="l20.83" class="difflineplus">+</span>
<a href="#l20.84"></a><span id="l20.84" class="difflineplus">+    let focusedElement = aInitInfo.focusedElement;</span>
<a href="#l20.85"></a><span id="l20.85" class="difflineplus">+    let onPanelReady = aInitInfo.onPanelReady;</span>
<a href="#l20.86"></a><span id="l20.86" class="difflineplus">+</span>
<a href="#l20.87"></a><span id="l20.87" class="difflineplus">+    return this._paneInfo = { itemId, itemGuid, parentId, parentGuid, isItem,</span>
<a href="#l20.88"></a><span id="l20.88" class="difflineplus">+                              isURI, uri, title,</span>
<a href="#l20.89"></a><span id="l20.89" class="difflineplus">+                              isBookmark, isFolderShortcut, isParentReadOnly,</span>
<a href="#l20.90"></a><span id="l20.90" class="difflineplus">+                              bulkTagging, uris,</span>
<a href="#l20.91"></a><span id="l20.91" class="difflineplus">+                              visibleRows, postData, isTag, focusedElement,</span>
<a href="#l20.92"></a><span id="l20.92" class="difflineplus">+                              onPanelReady };</span>
<a href="#l20.93"></a><span id="l20.93" class="difflineplus">+  },</span>
<a href="#l20.94"></a><span id="l20.94" class="difflineplus">+</span>
<a href="#l20.95"></a><span id="l20.95" class="difflineplus">+  get initialized() {</span>
<a href="#l20.96"></a><span id="l20.96" class="difflineplus">+    return this._paneInfo != null;</span>
<a href="#l20.97"></a><span id="l20.97" class="difflineplus">+  },</span>
<a href="#l20.98"></a><span id="l20.98" class="difflineplus">+</span>
<a href="#l20.99"></a><span id="l20.99" class="difflineplus">+  // Backwards-compatibility getters</span>
<a href="#l20.100"></a><span id="l20.100" class="difflineplus">+  get itemId() {</span>
<a href="#l20.101"></a><span id="l20.101" class="difflineplus">+    if (!this.initialized || this._paneInfo.bulkTagging)</span>
<a href="#l20.102"></a><span id="l20.102" class="difflineplus">+      return -1;</span>
<a href="#l20.103"></a><span id="l20.103" class="difflineplus">+    return this._paneInfo.itemId;</span>
<a href="#l20.104"></a><span id="l20.104" class="difflineplus">+  },</span>
<a href="#l20.105"></a><span id="l20.105" class="difflineplus">+</span>
<a href="#l20.106"></a><span id="l20.106" class="difflineplus">+  get uri() {</span>
<a href="#l20.107"></a><span id="l20.107" class="difflineplus">+    if (!this.initialized)</span>
<a href="#l20.108"></a><span id="l20.108" class="difflineplus">+      return null;</span>
<a href="#l20.109"></a><span id="l20.109" class="difflineplus">+    if (this._paneInfo.bulkTagging)</span>
<a href="#l20.110"></a><span id="l20.110" class="difflineplus">+      return this._paneInfo.uris[0];</span>
<a href="#l20.111"></a><span id="l20.111" class="difflineplus">+    return this._paneInfo.uri;</span>
<a href="#l20.112"></a><span id="l20.112" class="difflineplus">+  },</span>
<a href="#l20.113"></a><span id="l20.113" class="difflineplus">+</span>
<a href="#l20.114"></a><span id="l20.114" class="difflineplus">+  get multiEdit() {</span>
<a href="#l20.115"></a><span id="l20.115" class="difflineplus">+    return this.initialized &amp;&amp; this._paneInfo.bulkTagging;</span>
<a href="#l20.116"></a><span id="l20.116" class="difflineplus">+  },</span>
<a href="#l20.117"></a><span id="l20.117" class="difflineplus">+</span>
<a href="#l20.118"></a><span id="l20.118" class="difflineplus">+  // Check if the pane is initialized to show only read-only fields.</span>
<a href="#l20.119"></a><span id="l20.119" class="difflineplus">+  get readOnly() {</span>
<a href="#l20.120"></a><span id="l20.120" class="difflineplus">+    // TODO (Bug 1120314): Folder shortcuts are currently read-only due to some</span>
<a href="#l20.121"></a><span id="l20.121" class="difflineplus">+    // quirky implementation details (the most important being the &quot;smart&quot;</span>
<a href="#l20.122"></a><span id="l20.122" class="difflineplus">+    // semantics of node.title that makes hard to edit the right entry).</span>
<a href="#l20.123"></a><span id="l20.123" class="difflineplus">+    // This pane is read-only if:</span>
<a href="#l20.124"></a><span id="l20.124" class="difflineplus">+    //  * the panel is not initialized</span>
<a href="#l20.125"></a><span id="l20.125" class="difflineplus">+    //  * the node is a folder shortcut</span>
<a href="#l20.126"></a><span id="l20.126" class="difflineplus">+    //  * the node is not bookmarked and not a tag container</span>
<a href="#l20.127"></a><span id="l20.127" class="difflineplus">+    //  * the node is child of a read-only container and is not a bookmarked</span>
<a href="#l20.128"></a><span id="l20.128" class="difflineplus">+    //    URI nor a tag container</span>
<a href="#l20.129"></a><span id="l20.129" class="difflineplus">+    return !this.initialized ||</span>
<a href="#l20.130"></a><span id="l20.130" class="difflineplus">+           this._paneInfo.isFolderShortcut ||</span>
<a href="#l20.131"></a><span id="l20.131" class="difflineplus">+           (!this._paneInfo.isItem &amp;&amp; !this._paneInfo.isTag) ||</span>
<a href="#l20.132"></a><span id="l20.132" class="difflineplus">+           (this._paneInfo.isParentReadOnly &amp;&amp; !this._paneInfo.isBookmark &amp;&amp; !this._paneInfo.isTag);</span>
<a href="#l20.133"></a><span id="l20.133" class="difflineplus">+  },</span>
<a href="#l20.134"></a><span id="l20.134"> </span>
<a href="#l20.135"></a><span id="l20.135">   // the first field which was edited after this panel was initialized for</span>
<a href="#l20.136"></a><span id="l20.136">   // a certain item</span>
<a href="#l20.137"></a><span id="l20.137">   _firstEditedField: &quot;&quot;,</span>
<a href="#l20.138"></a><span id="l20.138"> </span>
<a href="#l20.139"></a><span id="l20.139" class="difflineminus">-  get itemId() {</span>
<a href="#l20.140"></a><span id="l20.140" class="difflineminus">-    return this._itemId;</span>
<a href="#l20.141"></a><span id="l20.141" class="difflineminus">-  },</span>
<a href="#l20.142"></a><span id="l20.142" class="difflineplus">+  _initNamePicker() {</span>
<a href="#l20.143"></a><span id="l20.143" class="difflineplus">+    if (this._paneInfo.bulkTagging)</span>
<a href="#l20.144"></a><span id="l20.144" class="difflineplus">+      throw new Error(&quot;_initNamePicker called unexpectedly&quot;);</span>
<a href="#l20.145"></a><span id="l20.145"> </span>
<a href="#l20.146"></a><span id="l20.146" class="difflineminus">-  get uri() {</span>
<a href="#l20.147"></a><span id="l20.147" class="difflineminus">-    return this._uri;</span>
<a href="#l20.148"></a><span id="l20.148" class="difflineminus">-  },</span>
<a href="#l20.149"></a><span id="l20.149" class="difflineminus">-</span>
<a href="#l20.150"></a><span id="l20.150" class="difflineminus">-  get multiEdit() {</span>
<a href="#l20.151"></a><span id="l20.151" class="difflineminus">-    return this._multiEdit;</span>
<a href="#l20.152"></a><span id="l20.152" class="difflineplus">+    // title may by null, which, for us, is the same as an empty string.</span>
<a href="#l20.153"></a><span id="l20.153" class="difflineplus">+    this._initTextField(this._namePicker, this._paneInfo.title || &quot;&quot;);</span>
<a href="#l20.154"></a><span id="l20.154">   },</span>
<a href="#l20.155"></a><span id="l20.155"> </span>
<a href="#l20.156"></a><span id="l20.156" class="difflineminus">-  /**</span>
<a href="#l20.157"></a><span id="l20.157" class="difflineminus">-   * Determines the initial data for the item edited or added by this dialog</span>
<a href="#l20.158"></a><span id="l20.158" class="difflineminus">-   */</span>
<a href="#l20.159"></a><span id="l20.159" class="difflineminus">-  _determineInfo: function EIO__determineInfo(aInfo) {</span>
<a href="#l20.160"></a><span id="l20.160" class="difflineminus">-    // hidden rows</span>
<a href="#l20.161"></a><span id="l20.161" class="difflineminus">-    if (aInfo &amp;&amp; aInfo.hiddenRows)</span>
<a href="#l20.162"></a><span id="l20.162" class="difflineminus">-      this._hiddenRows = aInfo.hiddenRows;</span>
<a href="#l20.163"></a><span id="l20.163" class="difflineminus">-    else</span>
<a href="#l20.164"></a><span id="l20.164" class="difflineminus">-      this._hiddenRows.splice(0, this._hiddenRows.length);</span>
<a href="#l20.165"></a><span id="l20.165" class="difflineminus">-    // force-read-only</span>
<a href="#l20.166"></a><span id="l20.166" class="difflineminus">-    this._readOnly = aInfo &amp;&amp; aInfo.forceReadOnly;</span>
<a href="#l20.167"></a><span id="l20.167" class="difflineminus">-    // override title</span>
<a href="#l20.168"></a><span id="l20.168" class="difflineminus">-    this._titleOverride = aInfo &amp;&amp; aInfo.titleOverride;</span>
<a href="#l20.169"></a><span id="l20.169" class="difflineplus">+  _initLocationField() {</span>
<a href="#l20.170"></a><span id="l20.170" class="difflineplus">+    if (!this._paneInfo.isURI)</span>
<a href="#l20.171"></a><span id="l20.171" class="difflineplus">+      throw new Error(&quot;_initLocationField called unexpectedly&quot;);</span>
<a href="#l20.172"></a><span id="l20.172" class="difflineplus">+    this._initTextField(this._locationField, this._paneInfo.uri.spec);</span>
<a href="#l20.173"></a><span id="l20.173" class="difflineplus">+  },</span>
<a href="#l20.174"></a><span id="l20.174" class="difflineplus">+</span>
<a href="#l20.175"></a><span id="l20.175" class="difflineplus">+  _initDescriptionField() {</span>
<a href="#l20.176"></a><span id="l20.176" class="difflineplus">+    if (!this._paneInfo.isItem)</span>
<a href="#l20.177"></a><span id="l20.177" class="difflineplus">+      throw new Error(&quot;_initDescriptionField called unexpectedly&quot;);</span>
<a href="#l20.178"></a><span id="l20.178" class="difflineplus">+</span>
<a href="#l20.179"></a><span id="l20.179" class="difflineplus">+    this._initTextField(this._descriptionField,</span>
<a href="#l20.180"></a><span id="l20.180" class="difflineplus">+                        PlacesUIUtils.getItemDescription(this._paneInfo.itemId));</span>
<a href="#l20.181"></a><span id="l20.181">   },</span>
<a href="#l20.182"></a><span id="l20.182"> </span>
<a href="#l20.183"></a><span id="l20.183" class="difflineminus">-  _showHideRows: function EIO__showHideRows() {</span>
<a href="#l20.184"></a><span id="l20.184" class="difflineminus">-    var isBookmark = this._itemId != -1 &amp;&amp;</span>
<a href="#l20.185"></a><span id="l20.185" class="difflineminus">-                     this._itemType == Ci.nsINavBookmarksService.TYPE_BOOKMARK;</span>
<a href="#l20.186"></a><span id="l20.186" class="difflineminus">-    var isQuery = false;</span>
<a href="#l20.187"></a><span id="l20.187" class="difflineminus">-    if (this._uri)</span>
<a href="#l20.188"></a><span id="l20.188" class="difflineminus">-      isQuery = this._uri.schemeIs(&quot;place&quot;);</span>
<a href="#l20.189"></a><span id="l20.189" class="difflineplus">+  async _initKeywordField(newKeyword = &quot;&quot;) {</span>
<a href="#l20.190"></a><span id="l20.190" class="difflineplus">+    if (!this._paneInfo.isBookmark) {</span>
<a href="#l20.191"></a><span id="l20.191" class="difflineplus">+      throw new Error(&quot;_initKeywordField called unexpectedly&quot;);</span>
<a href="#l20.192"></a><span id="l20.192" class="difflineplus">+    }</span>
<a href="#l20.193"></a><span id="l20.193" class="difflineplus">+</span>
<a href="#l20.194"></a><span id="l20.194" class="difflineplus">+    // Reset the field status synchronously now, eventually we'll reinit it</span>
<a href="#l20.195"></a><span id="l20.195" class="difflineplus">+    // later if we find an existing keyword. This way we can ensure to be in a</span>
<a href="#l20.196"></a><span id="l20.196" class="difflineplus">+    // consistent status when reusing the panel across different bookmarks.</span>
<a href="#l20.197"></a><span id="l20.197" class="difflineplus">+    this._keyword = newKeyword;</span>
<a href="#l20.198"></a><span id="l20.198" class="difflineplus">+    this._initTextField(this._keywordField, newKeyword);</span>
<a href="#l20.199"></a><span id="l20.199"> </span>
<a href="#l20.200"></a><span id="l20.200" class="difflineminus">-    this._element(&quot;nameRow&quot;).collapsed = this._hiddenRows.indexOf(&quot;name&quot;) != -1;</span>
<a href="#l20.201"></a><span id="l20.201" class="difflineminus">-    this._element(&quot;folderRow&quot;).collapsed =</span>
<a href="#l20.202"></a><span id="l20.202" class="difflineminus">-      this._hiddenRows.indexOf(&quot;folderPicker&quot;) != -1 || this._readOnly;</span>
<a href="#l20.203"></a><span id="l20.203" class="difflineminus">-    this._element(&quot;tagsRow&quot;).collapsed = !this._uri ||</span>
<a href="#l20.204"></a><span id="l20.204" class="difflineminus">-      this._hiddenRows.indexOf(&quot;tags&quot;) != -1 || isQuery;</span>
<a href="#l20.205"></a><span id="l20.205" class="difflineminus">-    // Collapse the tag selector if the item does not accept tags.</span>
<a href="#l20.206"></a><span id="l20.206" class="difflineminus">-    if (!this._element(&quot;tagsSelectorRow&quot;).collapsed &amp;&amp;</span>
<a href="#l20.207"></a><span id="l20.207" class="difflineminus">-        this._element(&quot;tagsRow&quot;).collapsed)</span>
<a href="#l20.208"></a><span id="l20.208" class="difflineminus">-      this.toggleTagsSelector();</span>
<a href="#l20.209"></a><span id="l20.209" class="difflineminus">-    this._element(&quot;descriptionRow&quot;).collapsed =</span>
<a href="#l20.210"></a><span id="l20.210" class="difflineminus">-      this._hiddenRows.indexOf(&quot;description&quot;) != -1 || this._readOnly;</span>
<a href="#l20.211"></a><span id="l20.211" class="difflineminus">-    this._element(&quot;keywordRow&quot;).collapsed = !isBookmark || this._readOnly ||</span>
<a href="#l20.212"></a><span id="l20.212" class="difflineminus">-      this._hiddenRows.indexOf(&quot;keyword&quot;) != -1 || isQuery;</span>
<a href="#l20.213"></a><span id="l20.213" class="difflineminus">-    this._element(&quot;locationRow&quot;).collapsed = !(this._uri &amp;&amp; !isQuery) ||</span>
<a href="#l20.214"></a><span id="l20.214" class="difflineminus">-      this._hiddenRows.indexOf(&quot;location&quot;) != -1;</span>
<a href="#l20.215"></a><span id="l20.215" class="difflineminus">-    this._element(&quot;feedLocationRow&quot;).collapsed = !this._isLivemark ||</span>
<a href="#l20.216"></a><span id="l20.216" class="difflineminus">-      this._hiddenRows.indexOf(&quot;feedLocation&quot;) != -1;</span>
<a href="#l20.217"></a><span id="l20.217" class="difflineminus">-    this._element(&quot;siteLocationRow&quot;).collapsed = !this._isLivemark ||</span>
<a href="#l20.218"></a><span id="l20.218" class="difflineminus">-      this._hiddenRows.indexOf(&quot;siteLocation&quot;) != -1;</span>
<a href="#l20.219"></a><span id="l20.219" class="difflineminus">-    this._element(&quot;selectionCount&quot;).hidden = !this._multiEdit;</span>
<a href="#l20.220"></a><span id="l20.220" class="difflineplus">+    if (!newKeyword) {</span>
<a href="#l20.221"></a><span id="l20.221" class="difflineplus">+      let entries = [];</span>
<a href="#l20.222"></a><span id="l20.222" class="difflineplus">+      await PlacesUtils.keywords.fetch({ url: this._paneInfo.uri.spec },</span>
<a href="#l20.223"></a><span id="l20.223" class="difflineplus">+                                       e =&gt; entries.push(e));</span>
<a href="#l20.224"></a><span id="l20.224" class="difflineplus">+      if (entries.length &gt; 0) {</span>
<a href="#l20.225"></a><span id="l20.225" class="difflineplus">+        // We show an existing keyword if either POST data was not provided, or</span>
<a href="#l20.226"></a><span id="l20.226" class="difflineplus">+        // if the POST data is the same.</span>
<a href="#l20.227"></a><span id="l20.227" class="difflineplus">+        let existingKeyword = entries[0].keyword;</span>
<a href="#l20.228"></a><span id="l20.228" class="difflineplus">+        let postData = this._paneInfo.postData;</span>
<a href="#l20.229"></a><span id="l20.229" class="difflineplus">+        if (postData) {</span>
<a href="#l20.230"></a><span id="l20.230" class="difflineplus">+          let sameEntry = entries.find(e =&gt; e.postData === postData);</span>
<a href="#l20.231"></a><span id="l20.231" class="difflineplus">+          existingKeyword = sameEntry ? sameEntry.keyword : &quot;&quot;;</span>
<a href="#l20.232"></a><span id="l20.232" class="difflineplus">+        }</span>
<a href="#l20.233"></a><span id="l20.233" class="difflineplus">+        if (existingKeyword) {</span>
<a href="#l20.234"></a><span id="l20.234" class="difflineplus">+          this._keyword = existingKeyword;</span>
<a href="#l20.235"></a><span id="l20.235" class="difflineplus">+          // Update the text field to the existing keyword.</span>
<a href="#l20.236"></a><span id="l20.236" class="difflineplus">+          this._initTextField(this._keywordField, this._keyword);</span>
<a href="#l20.237"></a><span id="l20.237" class="difflineplus">+        }</span>
<a href="#l20.238"></a><span id="l20.238" class="difflineplus">+      }</span>
<a href="#l20.239"></a><span id="l20.239" class="difflineplus">+    }</span>
<a href="#l20.240"></a><span id="l20.240" class="difflineplus">+  },</span>
<a href="#l20.241"></a><span id="l20.241" class="difflineplus">+</span>
<a href="#l20.242"></a><span id="l20.242" class="difflineplus">+  _initLoadInSidebar() {</span>
<a href="#l20.243"></a><span id="l20.243" class="difflineplus">+    if (!this._paneInfo.isBookmark)</span>
<a href="#l20.244"></a><span id="l20.244" class="difflineplus">+      throw new Error(&quot;_initLoadInSidebar called unexpectedly&quot;);</span>
<a href="#l20.245"></a><span id="l20.245" class="difflineplus">+</span>
<a href="#l20.246"></a><span id="l20.246" class="difflineplus">+    this._loadInSidebarCheckbox.checked =</span>
<a href="#l20.247"></a><span id="l20.247" class="difflineplus">+      PlacesUtils.annotations.itemHasAnnotation(</span>
<a href="#l20.248"></a><span id="l20.248" class="difflineplus">+        this._paneInfo.itemId, PlacesUIUtils.LOAD_IN_SIDEBAR_ANNO);</span>
<a href="#l20.249"></a><span id="l20.249">   },</span>
<a href="#l20.250"></a><span id="l20.250"> </span>
<a href="#l20.251"></a><span id="l20.251">   /**</span>
<a href="#l20.252"></a><span id="l20.252" class="difflineminus">-   * Initialize the panel</span>
<a href="#l20.253"></a><span id="l20.253" class="difflineminus">-   * @param aFor</span>
<a href="#l20.254"></a><span id="l20.254" class="difflineminus">-   *        Either a places-itemId (of a bookmark, folder or a live bookmark),</span>
<a href="#l20.255"></a><span id="l20.255" class="difflineminus">-   *        an array of itemIds (used for bulk tagging), or a URI object (in</span>
<a href="#l20.256"></a><span id="l20.256" class="difflineminus">-   *        which case, the panel would be initialized in read-only mode).</span>
<a href="#l20.257"></a><span id="l20.257" class="difflineminus">-   * @param [optional] aInfo</span>
<a href="#l20.258"></a><span id="l20.258" class="difflineminus">-   *        JS object which stores additional info for the panel</span>
<a href="#l20.259"></a><span id="l20.259" class="difflineminus">-   *        initialization. The following properties may bet set:</span>
<a href="#l20.260"></a><span id="l20.260" class="difflineminus">-   *        * hiddenRows (Strings array): list of rows to be hidden regardless</span>
<a href="#l20.261"></a><span id="l20.261" class="difflineminus">-   *          of the item edited. Possible values: &quot;title&quot;, &quot;location&quot;,</span>
<a href="#l20.262"></a><span id="l20.262" class="difflineminus">-   *          &quot;description&quot;, &quot;keyword&quot;, &quot;feedLocation&quot;,</span>
<a href="#l20.263"></a><span id="l20.263" class="difflineminus">-   *          &quot;siteLocation&quot;, folderPicker&quot;</span>
<a href="#l20.264"></a><span id="l20.264" class="difflineminus">-   *        * forceReadOnly - set this flag to initialize the panel to its</span>
<a href="#l20.265"></a><span id="l20.265" class="difflineminus">-   *          read-only (view) mode even if the given item is editable.</span>
<a href="#l20.266"></a><span id="l20.266" class="difflineplus">+   * Initialize the panel.</span>
<a href="#l20.267"></a><span id="l20.267" class="difflineplus">+   *</span>
<a href="#l20.268"></a><span id="l20.268" class="difflineplus">+   * @param aInfo</span>
<a href="#l20.269"></a><span id="l20.269" class="difflineplus">+   *        An object having:</span>
<a href="#l20.270"></a><span id="l20.270" class="difflineplus">+   *        1. one of the following properties:</span>
<a href="#l20.271"></a><span id="l20.271" class="difflineplus">+   *        - node: either a result node or a node-like object representing the</span>
<a href="#l20.272"></a><span id="l20.272" class="difflineplus">+   *          item to be edited. A node-like object must have the following</span>
<a href="#l20.273"></a><span id="l20.273" class="difflineplus">+   *          properties (with values that match exactly those a result node</span>
<a href="#l20.274"></a><span id="l20.274" class="difflineplus">+   *          would have): itemId, bookmarkGuid, uri, title, type.</span>
<a href="#l20.275"></a><span id="l20.275" class="difflineplus">+   *        - uris: an array of uris for bulk tagging.</span>
<a href="#l20.276"></a><span id="l20.276" class="difflineplus">+   *</span>
<a href="#l20.277"></a><span id="l20.277" class="difflineplus">+   *        2. any of the following optional properties:</span>
<a href="#l20.278"></a><span id="l20.278" class="difflineplus">+   *          - hiddenRows (Strings array): list of rows to be hidden regardless</span>
<a href="#l20.279"></a><span id="l20.279" class="difflineplus">+   *            of the item edited. Possible values: &quot;title&quot;, &quot;location&quot;,</span>
<a href="#l20.280"></a><span id="l20.280" class="difflineplus">+   *            &quot;description&quot;, &quot;keyword&quot;, &quot;loadInSidebar&quot;, &quot;feedLocation&quot;,</span>
<a href="#l20.281"></a><span id="l20.281" class="difflineplus">+   *            &quot;siteLocation&quot;, folderPicker&quot;</span>
<a href="#l20.282"></a><span id="l20.282">    */</span>
<a href="#l20.283"></a><span id="l20.283" class="difflineminus">-  initPanel: function EIO_initPanel(aFor, aInfo) {</span>
<a href="#l20.284"></a><span id="l20.284" class="difflineminus">-    // For sanity ensure that the implementer has uninited the panel before</span>
<a href="#l20.285"></a><span id="l20.285" class="difflineminus">-    // trying to init it again, or we could end up leaking due to observers.</span>
<a href="#l20.286"></a><span id="l20.286" class="difflineminus">-    if (this._initialized)</span>
<a href="#l20.287"></a><span id="l20.287" class="difflineminus">-      this.uninitPanel(false);</span>
<a href="#l20.288"></a><span id="l20.288" class="difflineminus">-</span>
<a href="#l20.289"></a><span id="l20.289" class="difflineminus">-    var aItemIdList;</span>
<a href="#l20.290"></a><span id="l20.290" class="difflineminus">-    if (Array.isArray(aFor)) {</span>
<a href="#l20.291"></a><span id="l20.291" class="difflineminus">-      aItemIdList = aFor;</span>
<a href="#l20.292"></a><span id="l20.292" class="difflineminus">-      aFor = aItemIdList[0];</span>
<a href="#l20.293"></a><span id="l20.293" class="difflineminus">-    }</span>
<a href="#l20.294"></a><span id="l20.294" class="difflineminus">-    else if (this._multiEdit) {</span>
<a href="#l20.295"></a><span id="l20.295" class="difflineminus">-      this._multiEdit = false;</span>
<a href="#l20.296"></a><span id="l20.296" class="difflineminus">-      this._tags = [];</span>
<a href="#l20.297"></a><span id="l20.297" class="difflineminus">-      this._uris = [];</span>
<a href="#l20.298"></a><span id="l20.298" class="difflineminus">-      this._allTags = [];</span>
<a href="#l20.299"></a><span id="l20.299" class="difflineminus">-      this._itemIds = [];</span>
<a href="#l20.300"></a><span id="l20.300" class="difflineminus">-      this._element(&quot;selectionCount&quot;).hidden = true;</span>
<a href="#l20.301"></a><span id="l20.301" class="difflineplus">+  initPanel(aInfo) {</span>
<a href="#l20.302"></a><span id="l20.302" class="difflineplus">+    if (typeof(aInfo) != &quot;object&quot; || aInfo === null)</span>
<a href="#l20.303"></a><span id="l20.303" class="difflineplus">+      throw new Error(&quot;aInfo must be an object.&quot;);</span>
<a href="#l20.304"></a><span id="l20.304" class="difflineplus">+    if (&quot;node&quot; in aInfo) {</span>
<a href="#l20.305"></a><span id="l20.305" class="difflineplus">+      try {</span>
<a href="#l20.306"></a><span id="l20.306" class="difflineplus">+        aInfo.node.type;</span>
<a href="#l20.307"></a><span id="l20.307" class="difflineplus">+      } catch (e) {</span>
<a href="#l20.308"></a><span id="l20.308" class="difflineplus">+        // If the lazy loader for |type| generates an exception, it means that</span>
<a href="#l20.309"></a><span id="l20.309" class="difflineplus">+        // this bookmark could not be loaded. This sometimes happens when tests</span>
<a href="#l20.310"></a><span id="l20.310" class="difflineplus">+        // create a bookmark by clicking the bookmark star, then try to cleanup</span>
<a href="#l20.311"></a><span id="l20.311" class="difflineplus">+        // before the bookmark panel has finished opening. Either way, if we</span>
<a href="#l20.312"></a><span id="l20.312" class="difflineplus">+        // cannot retrieve the bookmark information, we cannot open the panel.</span>
<a href="#l20.313"></a><span id="l20.313" class="difflineplus">+        return;</span>
<a href="#l20.314"></a><span id="l20.314" class="difflineplus">+      }</span>
<a href="#l20.315"></a><span id="l20.315">     }</span>
<a href="#l20.316"></a><span id="l20.316"> </span>
<a href="#l20.317"></a><span id="l20.317" class="difflineminus">-    this._folderMenuList = this._element(&quot;folderMenuList&quot;);</span>
<a href="#l20.318"></a><span id="l20.318" class="difflineminus">-    this._folderTree = this._element(&quot;folderTree&quot;);</span>
<a href="#l20.319"></a><span id="l20.319" class="difflineplus">+    // For sanity ensure that the implementer has uninited the panel before</span>
<a href="#l20.320"></a><span id="l20.320" class="difflineplus">+    // trying to init it again, or we could end up leaking due to observers.</span>
<a href="#l20.321"></a><span id="l20.321" class="difflineplus">+    if (this.initialized)</span>
<a href="#l20.322"></a><span id="l20.322" class="difflineplus">+      this.uninitPanel(false);</span>
<a href="#l20.323"></a><span id="l20.323" class="difflineplus">+</span>
<a href="#l20.324"></a><span id="l20.324" class="difflineplus">+    let { parentId, isItem, isURI,</span>
<a href="#l20.325"></a><span id="l20.325" class="difflineplus">+          isBookmark, bulkTagging, uris,</span>
<a href="#l20.326"></a><span id="l20.326" class="difflineplus">+          visibleRows, focusedElement,</span>
<a href="#l20.327"></a><span id="l20.327" class="difflineplus">+          onPanelReady } = this._setPaneInfo(aInfo);</span>
<a href="#l20.328"></a><span id="l20.328"> </span>
<a href="#l20.329"></a><span id="l20.329" class="difflineminus">-    this._determineInfo(aInfo);</span>
<a href="#l20.330"></a><span id="l20.330" class="difflineminus">-    if (aFor instanceof Ci.nsIURI) {</span>
<a href="#l20.331"></a><span id="l20.331" class="difflineminus">-      this._itemId = -1;</span>
<a href="#l20.332"></a><span id="l20.332" class="difflineminus">-      this._uri = aFor;</span>
<a href="#l20.333"></a><span id="l20.333" class="difflineminus">-      this._readOnly = true;</span>
<a href="#l20.334"></a><span id="l20.334" class="difflineplus">+    let showOrCollapse =</span>
<a href="#l20.335"></a><span id="l20.335" class="difflineplus">+      (rowId, isAppropriateForInput, nameInHiddenRows = null) =&gt; {</span>
<a href="#l20.336"></a><span id="l20.336" class="difflineplus">+        let visible = isAppropriateForInput;</span>
<a href="#l20.337"></a><span id="l20.337" class="difflineplus">+        if (visible &amp;&amp; &quot;hiddenRows&quot; in aInfo &amp;&amp; nameInHiddenRows)</span>
<a href="#l20.338"></a><span id="l20.338" class="difflineplus">+          visible &amp;= aInfo.hiddenRows.indexOf(nameInHiddenRows) == -1;</span>
<a href="#l20.339"></a><span id="l20.339" class="difflineplus">+        if (visible)</span>
<a href="#l20.340"></a><span id="l20.340" class="difflineplus">+          visibleRows.add(rowId);</span>
<a href="#l20.341"></a><span id="l20.341" class="difflineplus">+        return !(this._element(rowId).collapsed = !visible);</span>
<a href="#l20.342"></a><span id="l20.342" class="difflineplus">+      };</span>
<a href="#l20.343"></a><span id="l20.343" class="difflineplus">+</span>
<a href="#l20.344"></a><span id="l20.344" class="difflineplus">+    if (showOrCollapse(&quot;nameRow&quot;, !bulkTagging, &quot;name&quot;)) {</span>
<a href="#l20.345"></a><span id="l20.345" class="difflineplus">+      this._initNamePicker();</span>
<a href="#l20.346"></a><span id="l20.346" class="difflineplus">+      this._namePicker.readOnly = this.readOnly;</span>
<a href="#l20.347"></a><span id="l20.347">     }</span>
<a href="#l20.348"></a><span id="l20.348" class="difflineminus">-    else {</span>
<a href="#l20.349"></a><span id="l20.349" class="difflineminus">-      this._itemId = aFor;</span>
<a href="#l20.350"></a><span id="l20.350" class="difflineminus">-      // We can't store information on livemarks.</span>
<a href="#l20.351"></a><span id="l20.351" class="difflineminus">-      if (aFor == -1)</span>
<a href="#l20.352"></a><span id="l20.352" class="difflineminus">-        this._readOnly = true;</span>
<a href="#l20.353"></a><span id="l20.353" class="difflineminus">-      var containerId = PlacesUtils.bookmarks.getFolderIdForItem(this._itemId);</span>
<a href="#l20.354"></a><span id="l20.354" class="difflineminus">-      this._itemType = PlacesUtils.bookmarks.getItemType(this._itemId);</span>
<a href="#l20.355"></a><span id="l20.355" class="difflineminus">-      if (this._itemType == Ci.nsINavBookmarksService.TYPE_BOOKMARK) {</span>
<a href="#l20.356"></a><span id="l20.356" class="difflineminus">-        this._uri = PlacesUtils.bookmarks.getBookmarkURI(this._itemId);</span>
<a href="#l20.357"></a><span id="l20.357" class="difflineminus">-        this._initTextField(&quot;keywordField&quot;,</span>
<a href="#l20.358"></a><span id="l20.358" class="difflineminus">-                            PlacesUtils.bookmarks</span>
<a href="#l20.359"></a><span id="l20.359" class="difflineminus">-                                       .getKeywordForBookmark(this._itemId));</span>
<a href="#l20.360"></a><span id="l20.360" class="difflineminus">-      }</span>
<a href="#l20.361"></a><span id="l20.361" class="difflineminus">-      else {</span>
<a href="#l20.362"></a><span id="l20.362" class="difflineminus">-        this._uri = null;</span>
<a href="#l20.363"></a><span id="l20.363" class="difflineminus">-        this._isLivemark = false;</span>
<a href="#l20.364"></a><span id="l20.364" class="difflineminus">-        PlacesUtils.livemarks.getLivemark({ id: this._itemId })</span>
<a href="#l20.365"></a><span id="l20.365" class="difflineminus">-                             .then(aLivemark =&gt; {</span>
<a href="#l20.366"></a><span id="l20.366" class="difflineminus">-          this._isLivemark = true;</span>
<a href="#l20.367"></a><span id="l20.367" class="difflineminus">-          this._initTextField(&quot;feedLocationField&quot;, aLivemark.feedURI.spec, true);</span>
<a href="#l20.368"></a><span id="l20.368" class="difflineminus">-          this._initTextField(&quot;siteLocationField&quot;,</span>
<a href="#l20.369"></a><span id="l20.369" class="difflineminus">-                              aLivemark.siteURI ? aLivemark.siteURI.spec : &quot;&quot;, true);</span>
<a href="#l20.370"></a><span id="l20.370" class="difflineminus">-          this._showHideRows();</span>
<a href="#l20.371"></a><span id="l20.371" class="difflineminus">-        }, () =&gt; undefined);</span>
<a href="#l20.372"></a><span id="l20.372" class="difflineminus">-      }</span>
<a href="#l20.373"></a><span id="l20.373"> </span>
<a href="#l20.374"></a><span id="l20.374" class="difflineminus">-      // folder picker</span>
<a href="#l20.375"></a><span id="l20.375" class="difflineminus">-      this._initFolderMenuList(containerId);</span>
<a href="#l20.376"></a><span id="l20.376" class="difflineminus">-</span>
<a href="#l20.377"></a><span id="l20.377" class="difflineminus">-      // description field</span>
<a href="#l20.378"></a><span id="l20.378" class="difflineminus">-      this._initTextField(&quot;descriptionField&quot;,</span>
<a href="#l20.379"></a><span id="l20.379" class="difflineminus">-                          PlacesUIUtils.getItemDescription(this._itemId));</span>
<a href="#l20.380"></a><span id="l20.380" class="difflineplus">+    // In some cases we want to hide the location field, since it's not</span>
<a href="#l20.381"></a><span id="l20.381" class="difflineplus">+    // human-readable, but we still want to initialize it.</span>
<a href="#l20.382"></a><span id="l20.382" class="difflineplus">+    showOrCollapse(&quot;locationRow&quot;, isURI, &quot;location&quot;);</span>
<a href="#l20.383"></a><span id="l20.383" class="difflineplus">+    if (isURI) {</span>
<a href="#l20.384"></a><span id="l20.384" class="difflineplus">+      this._initLocationField();</span>
<a href="#l20.385"></a><span id="l20.385" class="difflineplus">+      this._locationField.readOnly = this.readOnly;</span>
<a href="#l20.386"></a><span id="l20.386">     }</span>
<a href="#l20.387"></a><span id="l20.387"> </span>
<a href="#l20.388"></a><span id="l20.388" class="difflineminus">-    if (this._itemId == -1 ||</span>
<a href="#l20.389"></a><span id="l20.389" class="difflineminus">-        this._itemType == Ci.nsINavBookmarksService.TYPE_BOOKMARK) {</span>
<a href="#l20.390"></a><span id="l20.390" class="difflineminus">-      this._isLivemark = false;</span>
<a href="#l20.391"></a><span id="l20.391" class="difflineplus">+    // hide the description field for</span>
<a href="#l20.392"></a><span id="l20.392" class="difflineplus">+    if (showOrCollapse(&quot;descriptionRow&quot;, isItem &amp;&amp; !this.readOnly,</span>
<a href="#l20.393"></a><span id="l20.393" class="difflineplus">+                       &quot;description&quot;)) {</span>
<a href="#l20.394"></a><span id="l20.394" class="difflineplus">+      this._initDescriptionField();</span>
<a href="#l20.395"></a><span id="l20.395" class="difflineplus">+      this._descriptionField.readOnly = this.readOnly;</span>
<a href="#l20.396"></a><span id="l20.396" class="difflineplus">+    }</span>
<a href="#l20.397"></a><span id="l20.397"> </span>
<a href="#l20.398"></a><span id="l20.398" class="difflineminus">-      this._initTextField(&quot;locationField&quot;, this._uri.spec);</span>
<a href="#l20.399"></a><span id="l20.399" class="difflineminus">-      if (!aItemIdList) {</span>
<a href="#l20.400"></a><span id="l20.400" class="difflineminus">-        var tags = PlacesUtils.tagging.getTagsForURI(this._uri).join(&quot;, &quot;);</span>
<a href="#l20.401"></a><span id="l20.401" class="difflineminus">-        this._initTextField(&quot;tagsField&quot;, tags, false);</span>
<a href="#l20.402"></a><span id="l20.402" class="difflineminus">-      }</span>
<a href="#l20.403"></a><span id="l20.403" class="difflineminus">-      else {</span>
<a href="#l20.404"></a><span id="l20.404" class="difflineminus">-        this._multiEdit = true;</span>
<a href="#l20.405"></a><span id="l20.405" class="difflineminus">-        this._allTags = [];</span>
<a href="#l20.406"></a><span id="l20.406" class="difflineminus">-        this._itemIds = aItemIdList;</span>
<a href="#l20.407"></a><span id="l20.407" class="difflineminus">-        for (var i = 0; i &lt; aItemIdList.length; i++) {</span>
<a href="#l20.408"></a><span id="l20.408" class="difflineminus">-          if (aItemIdList[i] instanceof Ci.nsIURI) {</span>
<a href="#l20.409"></a><span id="l20.409" class="difflineminus">-            this._uris[i] = aItemIdList[i];</span>
<a href="#l20.410"></a><span id="l20.410" class="difflineminus">-            this._itemIds[i] = -1;</span>
<a href="#l20.411"></a><span id="l20.411" class="difflineminus">-          }</span>
<a href="#l20.412"></a><span id="l20.412" class="difflineminus">-          else</span>
<a href="#l20.413"></a><span id="l20.413" class="difflineminus">-            this._uris[i] = PlacesUtils.bookmarks.getBookmarkURI(this._itemIds[i]);</span>
<a href="#l20.414"></a><span id="l20.414" class="difflineminus">-          this._tags[i] = PlacesUtils.tagging.getTagsForURI(this._uris[i]);</span>
<a href="#l20.415"></a><span id="l20.415" class="difflineminus">-        }</span>
<a href="#l20.416"></a><span id="l20.416" class="difflineminus">-        this._allTags = this._getCommonTags();</span>
<a href="#l20.417"></a><span id="l20.417" class="difflineminus">-        this._initTextField(&quot;tagsField&quot;, this._allTags.join(&quot;, &quot;), false);</span>
<a href="#l20.418"></a><span id="l20.418" class="difflineminus">-        this._element(&quot;itemsCountText&quot;).value =</span>
<a href="#l20.419"></a><span id="l20.419" class="difflineminus">-          PlacesUIUtils.getFormattedString(&quot;detailsPane.multipleItems&quot;,</span>
<a href="#l20.420"></a><span id="l20.420" class="difflineminus">-                                           [this._itemIds.length]);</span>
<a href="#l20.421"></a><span id="l20.421" class="difflineminus">-      }</span>
<a href="#l20.422"></a><span id="l20.422" class="difflineminus">-</span>
<a href="#l20.423"></a><span id="l20.423" class="difflineminus">-      // tags selector</span>
<a href="#l20.424"></a><span id="l20.424" class="difflineminus">-      this._rebuildTagsSelectorList();</span>
<a href="#l20.425"></a><span id="l20.425" class="difflineplus">+    if (showOrCollapse(&quot;keywordRow&quot;, isBookmark, &quot;keyword&quot;)) {</span>
<a href="#l20.426"></a><span id="l20.426" class="difflineplus">+      this._initKeywordField().catch(Cu.reportError);</span>
<a href="#l20.427"></a><span id="l20.427" class="difflineplus">+      this._keywordField.readOnly = this.readOnly;</span>
<a href="#l20.428"></a><span id="l20.428">     }</span>
<a href="#l20.429"></a><span id="l20.429"> </span>
<a href="#l20.430"></a><span id="l20.430" class="difflineminus">-    // name picker</span>
<a href="#l20.431"></a><span id="l20.431" class="difflineminus">-    this._initNamePicker();</span>
<a href="#l20.432"></a><span id="l20.432" class="difflineplus">+    // Collapse the tag selector if the item does not accept tags.</span>
<a href="#l20.433"></a><span id="l20.433" class="difflineplus">+    if (showOrCollapse(&quot;tagsRow&quot;, isURI || bulkTagging, &quot;tags&quot;))</span>
<a href="#l20.434"></a><span id="l20.434" class="difflineplus">+      this._initTagsField();</span>
<a href="#l20.435"></a><span id="l20.435" class="difflineplus">+    else if (!this._element(&quot;tagsSelectorRow&quot;).collapsed)</span>
<a href="#l20.436"></a><span id="l20.436" class="difflineplus">+      this.toggleTagsSelector();</span>
<a href="#l20.437"></a><span id="l20.437"> </span>
<a href="#l20.438"></a><span id="l20.438" class="difflineminus">-    this._showHideRows();</span>
<a href="#l20.439"></a><span id="l20.439" class="difflineplus">+    // Load in sidebar.</span>
<a href="#l20.440"></a><span id="l20.440" class="difflineplus">+    if (showOrCollapse(&quot;loadInSidebarCheckbox&quot;, isBookmark, &quot;loadInSidebar&quot;)) {</span>
<a href="#l20.441"></a><span id="l20.441" class="difflineplus">+      this._initLoadInSidebar();</span>
<a href="#l20.442"></a><span id="l20.442" class="difflineplus">+    }</span>
<a href="#l20.443"></a><span id="l20.443"> </span>
<a href="#l20.444"></a><span id="l20.444" class="difflineminus">-    // observe changes</span>
<a href="#l20.445"></a><span id="l20.445" class="difflineplus">+    // Folder picker.</span>
<a href="#l20.446"></a><span id="l20.446" class="difflineplus">+    // Technically we should check that the item is not moveable, but that's</span>
<a href="#l20.447"></a><span id="l20.447" class="difflineplus">+    // not cheap (we don't always have the parent), and there's no use case for</span>
<a href="#l20.448"></a><span id="l20.448" class="difflineplus">+    // this (it's only the Star UI that shows the folderPicker)</span>
<a href="#l20.449"></a><span id="l20.449" class="difflineplus">+    if (showOrCollapse(&quot;folderRow&quot;, isItem, &quot;folderPicker&quot;)) {</span>
<a href="#l20.450"></a><span id="l20.450" class="difflineplus">+      this._initFolderMenuList(parentId).catch(Cu.reportError);</span>
<a href="#l20.451"></a><span id="l20.451" class="difflineplus">+    }</span>
<a href="#l20.452"></a><span id="l20.452" class="difflineplus">+</span>
<a href="#l20.453"></a><span id="l20.453" class="difflineplus">+    // Selection count.</span>
<a href="#l20.454"></a><span id="l20.454" class="difflineplus">+    if (showOrCollapse(&quot;selectionCount&quot;, bulkTagging)) {</span>
<a href="#l20.455"></a><span id="l20.455" class="difflineplus">+      this._element(&quot;itemsCountText&quot;).value =</span>
<a href="#l20.456"></a><span id="l20.456" class="difflineplus">+        PlacesUIUtils.getPluralString(&quot;detailsPane.itemsCountLabel&quot;,</span>
<a href="#l20.457"></a><span id="l20.457" class="difflineplus">+                                      uris.length,</span>
<a href="#l20.458"></a><span id="l20.458" class="difflineplus">+                                      [uris.length]);</span>
<a href="#l20.459"></a><span id="l20.459" class="difflineplus">+    }</span>
<a href="#l20.460"></a><span id="l20.460" class="difflineplus">+</span>
<a href="#l20.461"></a><span id="l20.461" class="difflineplus">+    // Observe changes.</span>
<a href="#l20.462"></a><span id="l20.462">     if (!this._observersAdded) {</span>
<a href="#l20.463"></a><span id="l20.463" class="difflineminus">-      // Single bookmarks observe any change.  History entries and multiEdit</span>
<a href="#l20.464"></a><span id="l20.464" class="difflineminus">-      // observe only tags changes, through bookmarks.</span>
<a href="#l20.465"></a><span id="l20.465" class="difflineminus">-      if (this._itemId != -1 || this._uri || this._multiEdit)</span>
<a href="#l20.466"></a><span id="l20.466" class="difflineminus">-        PlacesUtils.bookmarks.addObserver(this);</span>
<a href="#l20.467"></a><span id="l20.467" class="difflineplus">+      PlacesUtils.bookmarks.addObserver(this);</span>
<a href="#l20.468"></a><span id="l20.468">       window.addEventListener(&quot;unload&quot;, this);</span>
<a href="#l20.469"></a><span id="l20.469">       this._observersAdded = true;</span>
<a href="#l20.470"></a><span id="l20.470">     }</span>
<a href="#l20.471"></a><span id="l20.471"> </span>
<a href="#l20.472"></a><span id="l20.472" class="difflineminus">-    this._initialized = true;</span>
<a href="#l20.473"></a><span id="l20.473" class="difflineplus">+    let focusElement = () =&gt; {</span>
<a href="#l20.474"></a><span id="l20.474" class="difflineplus">+      // The focusedElement possible values are:</span>
<a href="#l20.475"></a><span id="l20.475" class="difflineplus">+      //  * preferred: focus the field that the user touched first the last</span>
<a href="#l20.476"></a><span id="l20.476" class="difflineplus">+      //    time the pane was shown (either namePicker or tagsField)</span>
<a href="#l20.477"></a><span id="l20.477" class="difflineplus">+      //  * first: focus the first non collapsed textbox</span>
<a href="#l20.478"></a><span id="l20.478" class="difflineplus">+      // Note: since all controls are collapsed by default, we don't get the</span>
<a href="#l20.479"></a><span id="l20.479" class="difflineplus">+      // default XUL dialog behavior, that selects the first control, so we set</span>
<a href="#l20.480"></a><span id="l20.480" class="difflineplus">+      // the focus explicitly.</span>
<a href="#l20.481"></a><span id="l20.481" class="difflineplus">+      let elt;</span>
<a href="#l20.482"></a><span id="l20.482" class="difflineplus">+      if (focusedElement === &quot;preferred&quot;) {</span>
<a href="#l20.483"></a><span id="l20.483" class="difflineplus">+        /* eslint-disable no-undef */</span>
<a href="#l20.484"></a><span id="l20.484" class="difflineplus">+        elt = this._element(Services.prefs.getCharPref(&quot;browser.bookmarks.editDialog.firstEditField&quot;));</span>
<a href="#l20.485"></a><span id="l20.485" class="difflineplus">+        /* eslint-enable no-undef */</span>
<a href="#l20.486"></a><span id="l20.486" class="difflineplus">+      } else if (focusedElement === &quot;first&quot;) {</span>
<a href="#l20.487"></a><span id="l20.487" class="difflineplus">+        elt = document.querySelector(&quot;textbox:not([collapsed=true])&quot;);</span>
<a href="#l20.488"></a><span id="l20.488" class="difflineplus">+      }</span>
<a href="#l20.489"></a><span id="l20.489" class="difflineplus">+      if (elt) {</span>
<a href="#l20.490"></a><span id="l20.490" class="difflineplus">+        elt.focus();</span>
<a href="#l20.491"></a><span id="l20.491" class="difflineplus">+        elt.select();</span>
<a href="#l20.492"></a><span id="l20.492" class="difflineplus">+      }</span>
<a href="#l20.493"></a><span id="l20.493" class="difflineplus">+    };</span>
<a href="#l20.494"></a><span id="l20.494" class="difflineplus">+</span>
<a href="#l20.495"></a><span id="l20.495" class="difflineplus">+    if (onPanelReady) {</span>
<a href="#l20.496"></a><span id="l20.496" class="difflineplus">+      onPanelReady(focusElement);</span>
<a href="#l20.497"></a><span id="l20.497" class="difflineplus">+    } else {</span>
<a href="#l20.498"></a><span id="l20.498" class="difflineplus">+      focusElement();</span>
<a href="#l20.499"></a><span id="l20.499" class="difflineplus">+    }</span>
<a href="#l20.500"></a><span id="l20.500">   },</span>
<a href="#l20.501"></a><span id="l20.501"> </span>
<a href="#l20.502"></a><span id="l20.502">   /**</span>
<a href="#l20.503"></a><span id="l20.503" class="difflineminus">-   * Finds tags that are in common among this._tags entries that track tags</span>
<a href="#l20.504"></a><span id="l20.504" class="difflineminus">-   * for each selected uri.</span>
<a href="#l20.505"></a><span id="l20.505" class="difflineminus">-   * The tags arrays should be kept up-to-date for this to work properly.</span>
<a href="#l20.506"></a><span id="l20.506" class="difflineminus">-   *</span>
<a href="#l20.507"></a><span id="l20.507" class="difflineminus">-   * @return array of common tags for the selected uris.</span>
<a href="#l20.508"></a><span id="l20.508" class="difflineplus">+   * Finds tags that are in common among this._currentInfo.uris;</span>
<a href="#l20.509"></a><span id="l20.509">    */</span>
<a href="#l20.510"></a><span id="l20.510" class="difflineminus">-  _getCommonTags: function() {</span>
<a href="#l20.511"></a><span id="l20.511" class="difflineminus">-    return this._tags[0].filter(</span>
<a href="#l20.512"></a><span id="l20.512" class="difflineminus">-      aTag =&gt; this._tags.every(</span>
<a href="#l20.513"></a><span id="l20.513" class="difflineminus">-        aTags =&gt; aTags.indexOf(aTag) != -1</span>
<a href="#l20.514"></a><span id="l20.514" class="difflineminus">-      )</span>
<a href="#l20.515"></a><span id="l20.515" class="difflineminus">-    );</span>
<a href="#l20.516"></a><span id="l20.516" class="difflineplus">+  _getCommonTags() {</span>
<a href="#l20.517"></a><span id="l20.517" class="difflineplus">+    if (&quot;_cachedCommonTags&quot; in this._paneInfo)</span>
<a href="#l20.518"></a><span id="l20.518" class="difflineplus">+      return this._paneInfo._cachedCommonTags;</span>
<a href="#l20.519"></a><span id="l20.519" class="difflineplus">+</span>
<a href="#l20.520"></a><span id="l20.520" class="difflineplus">+    let uris = [...this._paneInfo.uris];</span>
<a href="#l20.521"></a><span id="l20.521" class="difflineplus">+    let firstURI = uris.shift();</span>
<a href="#l20.522"></a><span id="l20.522" class="difflineplus">+    let commonTags = new Set(PlacesUtils.tagging.getTagsForURI(firstURI));</span>
<a href="#l20.523"></a><span id="l20.523" class="difflineplus">+    if (commonTags.size == 0)</span>
<a href="#l20.524"></a><span id="l20.524" class="difflineplus">+      return this._cachedCommonTags = [];</span>
<a href="#l20.525"></a><span id="l20.525" class="difflineplus">+</span>
<a href="#l20.526"></a><span id="l20.526" class="difflineplus">+    for (let uri of uris) {</span>
<a href="#l20.527"></a><span id="l20.527" class="difflineplus">+      let curentURITags = PlacesUtils.tagging.getTagsForURI(uri);</span>
<a href="#l20.528"></a><span id="l20.528" class="difflineplus">+      for (let tag of commonTags) {</span>
<a href="#l20.529"></a><span id="l20.529" class="difflineplus">+        if (!curentURITags.includes(tag)) {</span>
<a href="#l20.530"></a><span id="l20.530" class="difflineplus">+          commonTags.delete(tag)</span>
<a href="#l20.531"></a><span id="l20.531" class="difflineplus">+          if (commonTags.size == 0)</span>
<a href="#l20.532"></a><span id="l20.532" class="difflineplus">+            return this._paneInfo.cachedCommonTags = [];</span>
<a href="#l20.533"></a><span id="l20.533" class="difflineplus">+        }</span>
<a href="#l20.534"></a><span id="l20.534" class="difflineplus">+      }</span>
<a href="#l20.535"></a><span id="l20.535" class="difflineplus">+    }</span>
<a href="#l20.536"></a><span id="l20.536" class="difflineplus">+    return this._paneInfo._cachedCommonTags = [...commonTags];</span>
<a href="#l20.537"></a><span id="l20.537">   },</span>
<a href="#l20.538"></a><span id="l20.538"> </span>
<a href="#l20.539"></a><span id="l20.539" class="difflineminus">-  _initTextField: function(aTextFieldId, aValue, aReadOnly) {</span>
<a href="#l20.540"></a><span id="l20.540" class="difflineminus">-    var field = this._element(aTextFieldId);</span>
<a href="#l20.541"></a><span id="l20.541" class="difflineminus">-    field.readOnly = aReadOnly !== undefined ? aReadOnly : this._readOnly;</span>
<a href="#l20.542"></a><span id="l20.542" class="difflineplus">+  _initTextField(aElement, aValue) {</span>
<a href="#l20.543"></a><span id="l20.543" class="difflineplus">+    if (aElement.value != aValue) {</span>
<a href="#l20.544"></a><span id="l20.544" class="difflineplus">+      aElement.value = aValue;</span>
<a href="#l20.545"></a><span id="l20.545"> </span>
<a href="#l20.546"></a><span id="l20.546" class="difflineminus">-    if (field.value != aValue) {</span>
<a href="#l20.547"></a><span id="l20.547" class="difflineminus">-      field.value = aValue;</span>
<a href="#l20.548"></a><span id="l20.548" class="difflineminus">-</span>
<a href="#l20.549"></a><span id="l20.549" class="difflineminus">-      // clear the undo stack</span>
<a href="#l20.550"></a><span id="l20.550" class="difflineminus">-      var editor = field.editor;</span>
<a href="#l20.551"></a><span id="l20.551" class="difflineminus">-      if (editor)</span>
<a href="#l20.552"></a><span id="l20.552" class="difflineminus">-        editor.transactionManager.clear();</span>
<a href="#l20.553"></a><span id="l20.553" class="difflineplus">+      // Clear the editor's undo stack</span>
<a href="#l20.554"></a><span id="l20.554" class="difflineplus">+      let transactionManager;</span>
<a href="#l20.555"></a><span id="l20.555" class="difflineplus">+      try {</span>
<a href="#l20.556"></a><span id="l20.556" class="difflineplus">+        transactionManager = aElement.editor.transactionManager;</span>
<a href="#l20.557"></a><span id="l20.557" class="difflineplus">+      } catch (e) {</span>
<a href="#l20.558"></a><span id="l20.558" class="difflineplus">+        // When retrieving the transaction manager, editor may be null resulting</span>
<a href="#l20.559"></a><span id="l20.559" class="difflineplus">+        // in a TypeError. Additionally, the transaction manager may not</span>
<a href="#l20.560"></a><span id="l20.560" class="difflineplus">+        // exist yet, which causes access to it to throw NS_ERROR_FAILURE.</span>
<a href="#l20.561"></a><span id="l20.561" class="difflineplus">+        // In either event, the transaction manager doesn't exist it, so we</span>
<a href="#l20.562"></a><span id="l20.562" class="difflineplus">+        // don't need to worry about clearing it.</span>
<a href="#l20.563"></a><span id="l20.563" class="difflineplus">+        if (!(e instanceof TypeError) &amp;&amp; e.result != Cr.NS_ERROR_FAILURE) {</span>
<a href="#l20.564"></a><span id="l20.564" class="difflineplus">+          throw e;</span>
<a href="#l20.565"></a><span id="l20.565" class="difflineplus">+        }</span>
<a href="#l20.566"></a><span id="l20.566" class="difflineplus">+      }</span>
<a href="#l20.567"></a><span id="l20.567" class="difflineplus">+      if (transactionManager) {</span>
<a href="#l20.568"></a><span id="l20.568" class="difflineplus">+        transactionManager.clear();</span>
<a href="#l20.569"></a><span id="l20.569" class="difflineplus">+      }</span>
<a href="#l20.570"></a><span id="l20.570">     }</span>
<a href="#l20.571"></a><span id="l20.571">   },</span>
<a href="#l20.572"></a><span id="l20.572"> </span>
<a href="#l20.573"></a><span id="l20.573">   /**</span>
<a href="#l20.574"></a><span id="l20.574">    * Appends a menu-item representing a bookmarks folder to a menu-popup.</span>
<a href="#l20.575"></a><span id="l20.575">    * @param aMenupopup</span>
<a href="#l20.576"></a><span id="l20.576">    *        The popup to which the menu-item should be added.</span>
<a href="#l20.577"></a><span id="l20.577">    * @param aFolderId</span>
<a href="#l20.578"></a><span id="l20.578">    *        The identifier of the bookmarks folder.</span>
<a href="#l20.579"></a><span id="l20.579" class="difflineplus">+   * @param aTitle</span>
<a href="#l20.580"></a><span id="l20.580" class="difflineplus">+   *        The title to use as a label.</span>
<a href="#l20.581"></a><span id="l20.581">    * @return the new menu item.</span>
<a href="#l20.582"></a><span id="l20.582">    */</span>
<a href="#l20.583"></a><span id="l20.583" class="difflineminus">-  _appendFolderItemToMenupopup:</span>
<a href="#l20.584"></a><span id="l20.584" class="difflineminus">-  function EIO__appendFolderItemToMenuList(aMenupopup, aFolderId) {</span>
<a href="#l20.585"></a><span id="l20.585" class="difflineplus">+  _appendFolderItemToMenupopup(aMenupopup, aFolderId, aTitle) {</span>
<a href="#l20.586"></a><span id="l20.586">     // First make sure the folders-separator is visible</span>
<a href="#l20.587"></a><span id="l20.587">     this._element(&quot;foldersSeparator&quot;).hidden = false;</span>
<a href="#l20.588"></a><span id="l20.588"> </span>
<a href="#l20.589"></a><span id="l20.589">     var folderMenuItem = document.createElement(&quot;menuitem&quot;);</span>
<a href="#l20.590"></a><span id="l20.590" class="difflineminus">-    var folderTitle = PlacesUtils.bookmarks.getItemTitle(aFolderId)</span>
<a href="#l20.591"></a><span id="l20.591" class="difflineplus">+    var folderTitle = aTitle;</span>
<a href="#l20.592"></a><span id="l20.592">     folderMenuItem.folderId = aFolderId;</span>
<a href="#l20.593"></a><span id="l20.593">     folderMenuItem.setAttribute(&quot;label&quot;, folderTitle);</span>
<a href="#l20.594"></a><span id="l20.594">     folderMenuItem.className = &quot;menuitem-iconic folder-icon&quot;;</span>
<a href="#l20.595"></a><span id="l20.595">     aMenupopup.appendChild(folderMenuItem);</span>
<a href="#l20.596"></a><span id="l20.596">     return folderMenuItem;</span>
<a href="#l20.597"></a><span id="l20.597">   },</span>
<a href="#l20.598"></a><span id="l20.598"> </span>
<a href="#l20.599"></a><span id="l20.599" class="difflineminus">-  _initFolderMenuList: function EIO__initFolderMenuList(aSelectedFolder) {</span>
<a href="#l20.600"></a><span id="l20.600" class="difflineplus">+  async _initFolderMenuList(aSelectedFolder) {</span>
<a href="#l20.601"></a><span id="l20.601">     // clean up first</span>
<a href="#l20.602"></a><span id="l20.602">     var menupopup = this._folderMenuList.menupopup;</span>
<a href="#l20.603"></a><span id="l20.603">     while (menupopup.childNodes.length &gt; 6)</span>
<a href="#l20.604"></a><span id="l20.604" class="difflineminus">-      menupopup.lastChild.remove();</span>
<a href="#l20.605"></a><span id="l20.605" class="difflineminus">-</span>
<a href="#l20.606"></a><span id="l20.606" class="difflineminus">-    const bms = PlacesUtils.bookmarks;</span>
<a href="#l20.607"></a><span id="l20.607" class="difflineminus">-    const annos = PlacesUtils.annotations;</span>
<a href="#l20.608"></a><span id="l20.608" class="difflineplus">+      menupopup.removeChild(menupopup.lastChild);</span>
<a href="#l20.609"></a><span id="l20.609"> </span>
<a href="#l20.610"></a><span id="l20.610">     // Build the static list</span>
<a href="#l20.611"></a><span id="l20.611" class="difflineminus">-    var unfiledItem = this._element(&quot;unfiledRootItem&quot;);</span>
<a href="#l20.612"></a><span id="l20.612">     if (!this._staticFoldersListBuilt) {</span>
<a href="#l20.613"></a><span id="l20.613" class="difflineminus">-      unfiledItem.label = bms.getItemTitle(PlacesUtils.unfiledBookmarksFolderId);</span>
<a href="#l20.614"></a><span id="l20.614" class="difflineplus">+      let unfiledItem = this._element(&quot;unfiledRootItem&quot;);</span>
<a href="#l20.615"></a><span id="l20.615" class="difflineplus">+      unfiledItem.label = PlacesUtils.getString(&quot;OtherBookmarksFolderTitle&quot;);</span>
<a href="#l20.616"></a><span id="l20.616">       unfiledItem.folderId = PlacesUtils.unfiledBookmarksFolderId;</span>
<a href="#l20.617"></a><span id="l20.617" class="difflineminus">-      var bmMenuItem = this._element(&quot;bmRootItem&quot;);</span>
<a href="#l20.618"></a><span id="l20.618" class="difflineminus">-      bmMenuItem.label = bms.getItemTitle(PlacesUtils.bookmarksMenuFolderId);</span>
<a href="#l20.619"></a><span id="l20.619" class="difflineplus">+      let bmMenuItem = this._element(&quot;bmRootItem&quot;);</span>
<a href="#l20.620"></a><span id="l20.620" class="difflineplus">+      bmMenuItem.label = PlacesUtils.getString(&quot;BookmarksMenuFolderTitle&quot;);</span>
<a href="#l20.621"></a><span id="l20.621">       bmMenuItem.folderId = PlacesUtils.bookmarksMenuFolderId;</span>
<a href="#l20.622"></a><span id="l20.622" class="difflineminus">-      var toolbarItem = this._element(&quot;toolbarFolderItem&quot;);</span>
<a href="#l20.623"></a><span id="l20.623" class="difflineminus">-      toolbarItem.label = bms.getItemTitle(PlacesUtils.toolbarFolderId);</span>
<a href="#l20.624"></a><span id="l20.624" class="difflineplus">+      let toolbarItem = this._element(&quot;toolbarFolderItem&quot;);</span>
<a href="#l20.625"></a><span id="l20.625" class="difflineplus">+      toolbarItem.label = PlacesUtils.getString(&quot;BookmarksToolbarFolderTitle&quot;);</span>
<a href="#l20.626"></a><span id="l20.626">       toolbarItem.folderId = PlacesUtils.toolbarFolderId;</span>
<a href="#l20.627"></a><span id="l20.627">       this._staticFoldersListBuilt = true;</span>
<a href="#l20.628"></a><span id="l20.628">     }</span>
<a href="#l20.629"></a><span id="l20.629"> </span>
<a href="#l20.630"></a><span id="l20.630">     // List of recently used folders:</span>
<a href="#l20.631"></a><span id="l20.631" class="difflineminus">-    var folderIds = annos.getItemsWithAnnotation(LAST_USED_ANNO);</span>
<a href="#l20.632"></a><span id="l20.632" class="difflineplus">+    var folderIds =</span>
<a href="#l20.633"></a><span id="l20.633" class="difflineplus">+      PlacesUtils.annotations.getItemsWithAnnotation(LAST_USED_ANNO);</span>
<a href="#l20.634"></a><span id="l20.634"> </span>
<a href="#l20.635"></a><span id="l20.635">     /**</span>
<a href="#l20.636"></a><span id="l20.636">      * The value of the LAST_USED_ANNO annotation is the time (in the form of</span>
<a href="#l20.637"></a><span id="l20.637">      * Date.getTime) at which the folder has been last used.</span>
<a href="#l20.638"></a><span id="l20.638">      *</span>
<a href="#l20.639"></a><span id="l20.639">      * First we build the annotated folders array, each item has both the</span>
<a href="#l20.640"></a><span id="l20.640">      * folder identifier and the time at which it was last-used by this dialog</span>
<a href="#l20.641"></a><span id="l20.641">      * set. Then we sort it descendingly based on the time field.</span>
<a href="#l20.642"></a><span id="l20.642">      */</span>
<a href="#l20.643"></a><span id="l20.643">     this._recentFolders = [];</span>
<a href="#l20.644"></a><span id="l20.644" class="difflineminus">-    for (var i = 0; i &lt; folderIds.length; i++) {</span>
<a href="#l20.645"></a><span id="l20.645" class="difflineminus">-      var lastUsed = annos.getItemAnnotation(folderIds[i], LAST_USED_ANNO);</span>
<a href="#l20.646"></a><span id="l20.646" class="difflineminus">-      this._recentFolders.push({ folderId: folderIds[i], lastUsed: lastUsed });</span>
<a href="#l20.647"></a><span id="l20.647" class="difflineplus">+    for (let folderId of folderIds) {</span>
<a href="#l20.648"></a><span id="l20.648" class="difflineplus">+      var lastUsed =</span>
<a href="#l20.649"></a><span id="l20.649" class="difflineplus">+        PlacesUtils.annotations.getItemAnnotation(folderId, LAST_USED_ANNO);</span>
<a href="#l20.650"></a><span id="l20.650" class="difflineplus">+      let guid = await PlacesUtils.promiseItemGuid(folderId);</span>
<a href="#l20.651"></a><span id="l20.651" class="difflineplus">+      let title = (await PlacesUtils.bookmarks.fetch(guid)).title;</span>
<a href="#l20.652"></a><span id="l20.652" class="difflineplus">+      this._recentFolders.push({ folderId, guid, title, lastUsed });</span>
<a href="#l20.653"></a><span id="l20.653">     }</span>
<a href="#l20.654"></a><span id="l20.654">     this._recentFolders.sort(function(a, b) {</span>
<a href="#l20.655"></a><span id="l20.655">       if (b.lastUsed &lt; a.lastUsed)</span>
<a href="#l20.656"></a><span id="l20.656">         return -1;</span>
<a href="#l20.657"></a><span id="l20.657">       if (b.lastUsed &gt; a.lastUsed)</span>
<a href="#l20.658"></a><span id="l20.658">         return 1;</span>
<a href="#l20.659"></a><span id="l20.659">       return 0;</span>
<a href="#l20.660"></a><span id="l20.660">     });</span>
<a href="#l20.661"></a><span id="l20.661"> </span>
<a href="#l20.662"></a><span id="l20.662">     var numberOfItems = Math.min(MAX_FOLDER_ITEM_IN_MENU_LIST,</span>
<a href="#l20.663"></a><span id="l20.663">                                  this._recentFolders.length);</span>
<a href="#l20.664"></a><span id="l20.664" class="difflineminus">-    for (var i = 0; i &lt; numberOfItems; i++) {</span>
<a href="#l20.665"></a><span id="l20.665" class="difflineminus">-      this._appendFolderItemToMenupopup(menupopup,</span>
<a href="#l20.666"></a><span id="l20.666" class="difflineminus">-                                        this._recentFolders[i].folderId);</span>
<a href="#l20.667"></a><span id="l20.667" class="difflineplus">+    for (let i = 0; i &lt; numberOfItems; i++) {</span>
<a href="#l20.668"></a><span id="l20.668" class="difflineplus">+      await this._appendFolderItemToMenupopup(menupopup,</span>
<a href="#l20.669"></a><span id="l20.669" class="difflineplus">+                                              this._recentFolders[i].folderId,</span>
<a href="#l20.670"></a><span id="l20.670" class="difflineplus">+                                              this._recentFolders[i].title);</span>
<a href="#l20.671"></a><span id="l20.671">     }</span>
<a href="#l20.672"></a><span id="l20.672"> </span>
<a href="#l20.673"></a><span id="l20.673" class="difflineminus">-    var defaultItem = this._getFolderMenuItem(aSelectedFolder);</span>
<a href="#l20.674"></a><span id="l20.674" class="difflineplus">+    let selectedFolderGuid = await PlacesUtils.promiseItemGuid(aSelectedFolder);</span>
<a href="#l20.675"></a><span id="l20.675" class="difflineplus">+    let title = (await PlacesUtils.bookmarks.fetch(selectedFolderGuid)).title;</span>
<a href="#l20.676"></a><span id="l20.676" class="difflineplus">+    var defaultItem = this._getFolderMenuItem(aSelectedFolder, title);</span>
<a href="#l20.677"></a><span id="l20.677">     this._folderMenuList.selectedItem = defaultItem;</span>
<a href="#l20.678"></a><span id="l20.678"> </span>
<a href="#l20.679"></a><span id="l20.679">     // Set a selectedIndex attribute to show special icons</span>
<a href="#l20.680"></a><span id="l20.680">     this._folderMenuList.setAttribute(&quot;selectedIndex&quot;,</span>
<a href="#l20.681"></a><span id="l20.681">                                       this._folderMenuList.selectedIndex);</span>
<a href="#l20.682"></a><span id="l20.682"> </span>
<a href="#l20.683"></a><span id="l20.683">     // Hide the folders-separator if no folder is annotated as recently-used</span>
<a href="#l20.684"></a><span id="l20.684">     this._element(&quot;foldersSeparator&quot;).hidden = (menupopup.childNodes.length &lt;= 6);</span>
<a href="#l20.685"></a><span id="l20.685" class="difflineminus">-    this._folderMenuList.disabled = this._readOnly;</span>
<a href="#l20.686"></a><span id="l20.686" class="difflineplus">+    this._folderMenuList.disabled = this.readOnly;</span>
<a href="#l20.687"></a><span id="l20.687">   },</span>
<a href="#l20.688"></a><span id="l20.688"> </span>
<a href="#l20.689"></a><span id="l20.689" class="difflineminus">-  QueryInterface: function EIO_QueryInterface(aIID) {</span>
<a href="#l20.690"></a><span id="l20.690" class="difflineminus">-    if (aIID.equals(Ci.nsIDOMEventListener) ||</span>
<a href="#l20.691"></a><span id="l20.691" class="difflineminus">-        aIID.equals(Ci.nsINavBookmarkObserver) ||</span>
<a href="#l20.692"></a><span id="l20.692" class="difflineminus">-        aIID.equals(Ci.nsISupports))</span>
<a href="#l20.693"></a><span id="l20.693" class="difflineminus">-      return this;</span>
<a href="#l20.694"></a><span id="l20.694" class="difflineplus">+  QueryInterface:</span>
<a href="#l20.695"></a><span id="l20.695" class="difflineplus">+  XPCOMUtils.generateQI([Ci.nsIDOMEventListener,</span>
<a href="#l20.696"></a><span id="l20.696" class="difflineplus">+                         Ci.nsINavBookmarkObserver]),</span>
<a href="#l20.697"></a><span id="l20.697"> </span>
<a href="#l20.698"></a><span id="l20.698" class="difflineminus">-    throw Cr.NS_ERROR_NO_INTERFACE;</span>
<a href="#l20.699"></a><span id="l20.699" class="difflineminus">-  },</span>
<a href="#l20.700"></a><span id="l20.700" class="difflineminus">-</span>
<a href="#l20.701"></a><span id="l20.701" class="difflineminus">-  _element: function EIO__element(aID) {</span>
<a href="#l20.702"></a><span id="l20.702" class="difflineplus">+  _element(aID) {</span>
<a href="#l20.703"></a><span id="l20.703">     return document.getElementById(&quot;editBMPanel_&quot; + aID);</span>
<a href="#l20.704"></a><span id="l20.704">   },</span>
<a href="#l20.705"></a><span id="l20.705"> </span>
<a href="#l20.706"></a><span id="l20.706" class="difflineminus">-  _getItemStaticTitle: function EIO__getItemStaticTitle() {</span>
<a href="#l20.707"></a><span id="l20.707" class="difflineminus">-    if (this._titleOverride)</span>
<a href="#l20.708"></a><span id="l20.708" class="difflineminus">-      return this._titleOverride;</span>
<a href="#l20.709"></a><span id="l20.709" class="difflineminus">-</span>
<a href="#l20.710"></a><span id="l20.710" class="difflineminus">-    if (this._itemId == -1)</span>
<a href="#l20.711"></a><span id="l20.711" class="difflineminus">-      return PlacesUtils.history.getPageTitle(this._uri);</span>
<a href="#l20.712"></a><span id="l20.712" class="difflineminus">-</span>
<a href="#l20.713"></a><span id="l20.713" class="difflineminus">-    return PlacesUtils.bookmarks.getItemTitle(this._itemId);</span>
<a href="#l20.714"></a><span id="l20.714" class="difflineminus">-  },</span>
<a href="#l20.715"></a><span id="l20.715" class="difflineminus">-</span>
<a href="#l20.716"></a><span id="l20.716" class="difflineminus">-  _initNamePicker: function EIO_initNamePicker() {</span>
<a href="#l20.717"></a><span id="l20.717" class="difflineminus">-    var namePicker = this._element(&quot;namePicker&quot;);</span>
<a href="#l20.718"></a><span id="l20.718" class="difflineminus">-</span>
<a href="#l20.719"></a><span id="l20.719" class="difflineminus">-    namePicker.value = this._getItemStaticTitle();</span>
<a href="#l20.720"></a><span id="l20.720" class="difflineminus">-    namePicker.readOnly = this._readOnly;</span>
<a href="#l20.721"></a><span id="l20.721" class="difflineminus">-</span>
<a href="#l20.722"></a><span id="l20.722" class="difflineminus">-    // clear the undo stack</span>
<a href="#l20.723"></a><span id="l20.723" class="difflineminus">-    var editor = namePicker.editor;</span>
<a href="#l20.724"></a><span id="l20.724" class="difflineminus">-    if (editor)</span>
<a href="#l20.725"></a><span id="l20.725" class="difflineminus">-      editor.transactionManager.clear();</span>
<a href="#l20.726"></a><span id="l20.726" class="difflineminus">-  },</span>
<a href="#l20.727"></a><span id="l20.727" class="difflineminus">-</span>
<a href="#l20.728"></a><span id="l20.728" class="difflineminus">-  uninitPanel: function EIO_uninitPanel(aHideCollapsibleElements) {</span>
<a href="#l20.729"></a><span id="l20.729" class="difflineplus">+  uninitPanel(aHideCollapsibleElements) {</span>
<a href="#l20.730"></a><span id="l20.730">     if (aHideCollapsibleElements) {</span>
<a href="#l20.731"></a><span id="l20.731" class="difflineminus">-      // hide the folder tree if it was previously visible</span>
<a href="#l20.732"></a><span id="l20.732" class="difflineplus">+      // Hide the folder tree if it was previously visible.</span>
<a href="#l20.733"></a><span id="l20.733">       var folderTreeRow = this._element(&quot;folderTreeRow&quot;);</span>
<a href="#l20.734"></a><span id="l20.734">       if (!folderTreeRow.collapsed)</span>
<a href="#l20.735"></a><span id="l20.735">         this.toggleFolderTreeVisibility();</span>
<a href="#l20.736"></a><span id="l20.736"> </span>
<a href="#l20.737"></a><span id="l20.737" class="difflineminus">-      // hide the tag selector if it was previously visible</span>
<a href="#l20.738"></a><span id="l20.738" class="difflineplus">+      // Hide the tag selector if it was previously visible.</span>
<a href="#l20.739"></a><span id="l20.739">       var tagsSelectorRow = this._element(&quot;tagsSelectorRow&quot;);</span>
<a href="#l20.740"></a><span id="l20.740">       if (!tagsSelectorRow.collapsed)</span>
<a href="#l20.741"></a><span id="l20.741">         this.toggleTagsSelector();</span>
<a href="#l20.742"></a><span id="l20.742">     }</span>
<a href="#l20.743"></a><span id="l20.743"> </span>
<a href="#l20.744"></a><span id="l20.744">     if (this._observersAdded) {</span>
<a href="#l20.745"></a><span id="l20.745" class="difflineminus">-      if (this._itemId != -1 || this._uri || this._multiEdit)</span>
<a href="#l20.746"></a><span id="l20.746" class="difflineminus">-        PlacesUtils.bookmarks.removeObserver(this);</span>
<a href="#l20.747"></a><span id="l20.747" class="difflineminus">-</span>
<a href="#l20.748"></a><span id="l20.748" class="difflineplus">+      PlacesUtils.bookmarks.removeObserver(this);</span>
<a href="#l20.749"></a><span id="l20.749">       this._observersAdded = false;</span>
<a href="#l20.750"></a><span id="l20.750">     }</span>
<a href="#l20.751"></a><span id="l20.751"> </span>
<a href="#l20.752"></a><span id="l20.752" class="difflineminus">-    this._itemId = -1;</span>
<a href="#l20.753"></a><span id="l20.753" class="difflineminus">-    this._uri = null;</span>
<a href="#l20.754"></a><span id="l20.754" class="difflineminus">-    this._uris = [];</span>
<a href="#l20.755"></a><span id="l20.755" class="difflineminus">-    this._tags = [];</span>
<a href="#l20.756"></a><span id="l20.756" class="difflineminus">-    this._allTags = [];</span>
<a href="#l20.757"></a><span id="l20.757" class="difflineminus">-    this._itemIds = [];</span>
<a href="#l20.758"></a><span id="l20.758" class="difflineminus">-    this._multiEdit = false;</span>
<a href="#l20.759"></a><span id="l20.759" class="difflineplus">+    this._setPaneInfo(null);</span>
<a href="#l20.760"></a><span id="l20.760">     this._firstEditedField = &quot;&quot;;</span>
<a href="#l20.761"></a><span id="l20.761" class="difflineminus">-    this._initialized = false;</span>
<a href="#l20.762"></a><span id="l20.762" class="difflineminus">-    this._readOnly = false;</span>
<a href="#l20.763"></a><span id="l20.763" class="difflineminus">-    this._titleOverride = null;</span>
<a href="#l20.764"></a><span id="l20.764" class="difflineplus">+  },</span>
<a href="#l20.765"></a><span id="l20.765" class="difflineplus">+</span>
<a href="#l20.766"></a><span id="l20.766" class="difflineplus">+  onTagsFieldChange() {</span>
<a href="#l20.767"></a><span id="l20.767" class="difflineplus">+    // Check for _paneInfo existing as the dialog may be closing but receiving</span>
<a href="#l20.768"></a><span id="l20.768" class="difflineplus">+    // async updates from unresolved promises.</span>
<a href="#l20.769"></a><span id="l20.769" class="difflineplus">+    if (this._paneInfo &amp;&amp;</span>
<a href="#l20.770"></a><span id="l20.770" class="difflineplus">+        (this._paneInfo.isURI || this._paneInfo.bulkTagging)) {</span>
<a href="#l20.771"></a><span id="l20.771" class="difflineplus">+      this._updateTags().then(</span>
<a href="#l20.772"></a><span id="l20.772" class="difflineplus">+        anyChanges =&gt; {</span>
<a href="#l20.773"></a><span id="l20.773" class="difflineplus">+          if (anyChanges)</span>
<a href="#l20.774"></a><span id="l20.774" class="difflineplus">+            this._mayUpdateFirstEditField(&quot;tagsField&quot;);</span>
<a href="#l20.775"></a><span id="l20.775" class="difflineplus">+        }, Cu.reportError);</span>
<a href="#l20.776"></a><span id="l20.776" class="difflineplus">+    }</span>
<a href="#l20.777"></a><span id="l20.777">   },</span>
<a href="#l20.778"></a><span id="l20.778"> </span>
<a href="#l20.779"></a><span id="l20.779" class="difflineminus">-  onTagsFieldBlur: function EIO_onTagsFieldBlur() {</span>
<a href="#l20.780"></a><span id="l20.780" class="difflineminus">-    if (this._updateTags()) // if anything has changed</span>
<a href="#l20.781"></a><span id="l20.781" class="difflineminus">-      this._mayUpdateFirstEditField(&quot;tagsField&quot;);</span>
<a href="#l20.782"></a><span id="l20.782" class="difflineminus">-  },</span>
<a href="#l20.783"></a><span id="l20.783" class="difflineplus">+  /**</span>
<a href="#l20.784"></a><span id="l20.784" class="difflineplus">+   * For a given array of currently-set tags and the tags-input-field</span>
<a href="#l20.785"></a><span id="l20.785" class="difflineplus">+   * value, returns which tags should be removed and which should be added in</span>
<a href="#l20.786"></a><span id="l20.786" class="difflineplus">+   * the form of { removedTags: [...], newTags: [...] }.</span>
<a href="#l20.787"></a><span id="l20.787" class="difflineplus">+   */</span>
<a href="#l20.788"></a><span id="l20.788" class="difflineplus">+  _getTagsChanges(aCurrentTags) {</span>
<a href="#l20.789"></a><span id="l20.789" class="difflineplus">+    let inputTags = this._getTagsArrayFromTagsInputField();</span>
<a href="#l20.790"></a><span id="l20.790"> </span>
<a href="#l20.791"></a><span id="l20.791" class="difflineminus">-  _updateTags: function EIO__updateTags() {</span>
<a href="#l20.792"></a><span id="l20.792" class="difflineminus">-    if (this._multiEdit)</span>
<a href="#l20.793"></a><span id="l20.793" class="difflineminus">-      return this._updateMultipleTagsForItems();</span>
<a href="#l20.794"></a><span id="l20.794" class="difflineminus">-    return this._updateSingleTagForItem();</span>
<a href="#l20.795"></a><span id="l20.795" class="difflineplus">+    // Optimize the trivial cases (which are actually the most common).</span>
<a href="#l20.796"></a><span id="l20.796" class="difflineplus">+    if (inputTags.length == 0 &amp;&amp; aCurrentTags.length == 0)</span>
<a href="#l20.797"></a><span id="l20.797" class="difflineplus">+      return { newTags: [], removedTags: [] };</span>
<a href="#l20.798"></a><span id="l20.798" class="difflineplus">+    if (inputTags.length == 0)</span>
<a href="#l20.799"></a><span id="l20.799" class="difflineplus">+      return { newTags: [], removedTags: aCurrentTags };</span>
<a href="#l20.800"></a><span id="l20.800" class="difflineplus">+    if (aCurrentTags.length == 0)</span>
<a href="#l20.801"></a><span id="l20.801" class="difflineplus">+      return { newTags: inputTags, removedTags: [] };</span>
<a href="#l20.802"></a><span id="l20.802" class="difflineplus">+</span>
<a href="#l20.803"></a><span id="l20.803" class="difflineplus">+    // Do not remove tags that may be reinserted with a different</span>
<a href="#l20.804"></a><span id="l20.804" class="difflineplus">+    // case, since the tagging service may handle those more efficiently.</span>
<a href="#l20.805"></a><span id="l20.805" class="difflineplus">+    let lcInputTags = inputTags.map(t =&gt; t.toLowerCase());</span>
<a href="#l20.806"></a><span id="l20.806" class="difflineplus">+    let removedTags = aCurrentTags.filter(t =&gt; !lcInputTags.includes(t.toLowerCase()));</span>
<a href="#l20.807"></a><span id="l20.807" class="difflineplus">+    let newTags = inputTags.filter(t =&gt; !aCurrentTags.includes(t));</span>
<a href="#l20.808"></a><span id="l20.808" class="difflineplus">+    return { removedTags, newTags };</span>
<a href="#l20.809"></a><span id="l20.809">   },</span>
<a href="#l20.810"></a><span id="l20.810"> </span>
<a href="#l20.811"></a><span id="l20.811" class="difflineminus">-  _updateSingleTagForItem: function EIO__updateSingleTagForItem() {</span>
<a href="#l20.812"></a><span id="l20.812" class="difflineminus">-    var currentTags = PlacesUtils.tagging.getTagsForURI(this._uri);</span>
<a href="#l20.813"></a><span id="l20.813" class="difflineminus">-    var tags = this._getTagsArrayFromTagField();</span>
<a href="#l20.814"></a><span id="l20.814" class="difflineminus">-    if (tags.length &gt; 0 || currentTags.length &gt; 0) {</span>
<a href="#l20.815"></a><span id="l20.815" class="difflineminus">-      var tagsToRemove = [];</span>
<a href="#l20.816"></a><span id="l20.816" class="difflineminus">-      var tagsToAdd = [];</span>
<a href="#l20.817"></a><span id="l20.817" class="difflineminus">-      var txns = [];</span>
<a href="#l20.818"></a><span id="l20.818" class="difflineminus">-      for (var i = 0; i &lt; currentTags.length; i++) {</span>
<a href="#l20.819"></a><span id="l20.819" class="difflineminus">-        if (tags.indexOf(currentTags[i]) == -1)</span>
<a href="#l20.820"></a><span id="l20.820" class="difflineminus">-          tagsToRemove.push(currentTags[i]);</span>
<a href="#l20.821"></a><span id="l20.821" class="difflineminus">-      }</span>
<a href="#l20.822"></a><span id="l20.822" class="difflineminus">-      for (var i = 0; i &lt; tags.length; i++) {</span>
<a href="#l20.823"></a><span id="l20.823" class="difflineminus">-        if (currentTags.indexOf(tags[i]) == -1)</span>
<a href="#l20.824"></a><span id="l20.824" class="difflineminus">-          tagsToAdd.push(tags[i]);</span>
<a href="#l20.825"></a><span id="l20.825" class="difflineplus">+  // Adds and removes tags for one or more uris.</span>
<a href="#l20.826"></a><span id="l20.826" class="difflineplus">+  _setTagsFromTagsInputField(aCurrentTags, aURIs) {</span>
<a href="#l20.827"></a><span id="l20.827" class="difflineplus">+    let { removedTags, newTags } = this._getTagsChanges(aCurrentTags);</span>
<a href="#l20.828"></a><span id="l20.828" class="difflineplus">+    if (removedTags.length + newTags.length == 0)</span>
<a href="#l20.829"></a><span id="l20.829" class="difflineplus">+      return false;</span>
<a href="#l20.830"></a><span id="l20.830" class="difflineplus">+</span>
<a href="#l20.831"></a><span id="l20.831" class="difflineplus">+    if (!PlacesUIUtils.useAsyncTransactions) {</span>
<a href="#l20.832"></a><span id="l20.832" class="difflineplus">+      let txns = [];</span>
<a href="#l20.833"></a><span id="l20.833" class="difflineplus">+      for (let uri of aURIs) {</span>
<a href="#l20.834"></a><span id="l20.834" class="difflineplus">+        if (removedTags.length &gt; 0)</span>
<a href="#l20.835"></a><span id="l20.835" class="difflineplus">+          txns.push(new PlacesUntagURITransaction(uri, removedTags));</span>
<a href="#l20.836"></a><span id="l20.836" class="difflineplus">+        if (newTags.length &gt; 0)</span>
<a href="#l20.837"></a><span id="l20.837" class="difflineplus">+          txns.push(new PlacesTagURITransaction(uri, newTags));</span>
<a href="#l20.838"></a><span id="l20.838">       }</span>
<a href="#l20.839"></a><span id="l20.839"> </span>
<a href="#l20.840"></a><span id="l20.840" class="difflineminus">-      if (tagsToRemove.length &gt; 0) {</span>
<a href="#l20.841"></a><span id="l20.841" class="difflineminus">-        let untagTxn = new PlacesUntagURITransaction(this._uri, tagsToRemove);</span>
<a href="#l20.842"></a><span id="l20.842" class="difflineminus">-        txns.push(untagTxn);</span>
<a href="#l20.843"></a><span id="l20.843" class="difflineminus">-      }</span>
<a href="#l20.844"></a><span id="l20.844" class="difflineminus">-      if (tagsToAdd.length &gt; 0) {</span>
<a href="#l20.845"></a><span id="l20.845" class="difflineminus">-        let tagTxn = new PlacesTagURITransaction(this._uri, tagsToAdd);</span>
<a href="#l20.846"></a><span id="l20.846" class="difflineminus">-        txns.push(tagTxn);</span>
<a href="#l20.847"></a><span id="l20.847" class="difflineminus">-      }</span>
<a href="#l20.848"></a><span id="l20.848" class="difflineplus">+      PlacesUtils.transactionManager.doTransaction(</span>
<a href="#l20.849"></a><span id="l20.849" class="difflineplus">+        new PlacesAggregatedTransaction(&quot;Update tags&quot;, txns));</span>
<a href="#l20.850"></a><span id="l20.850" class="difflineplus">+      return true;</span>
<a href="#l20.851"></a><span id="l20.851" class="difflineplus">+    }</span>
<a href="#l20.852"></a><span id="l20.852"> </span>
<a href="#l20.853"></a><span id="l20.853" class="difflineminus">-      if (txns.length &gt; 0) {</span>
<a href="#l20.854"></a><span id="l20.854" class="difflineminus">-        let aggregate = new PlacesAggregatedTransaction(&quot;Update tags&quot;, txns);</span>
<a href="#l20.855"></a><span id="l20.855" class="difflineminus">-        PlacesUtils.transactionManager.doTransaction(aggregate);</span>
<a href="#l20.856"></a><span id="l20.856" class="difflineplus">+    let setTags = async function() {</span>
<a href="#l20.857"></a><span id="l20.857" class="difflineplus">+      if (removedTags.length &gt; 0) {</span>
<a href="#l20.858"></a><span id="l20.858" class="difflineplus">+        await PlacesTransactions.Untag({ urls: aURIs, tags: removedTags })</span>
<a href="#l20.859"></a><span id="l20.859" class="difflineplus">+                                .transact();</span>
<a href="#l20.860"></a><span id="l20.860" class="difflineplus">+      }</span>
<a href="#l20.861"></a><span id="l20.861" class="difflineplus">+      if (newTags.length &gt; 0) {</span>
<a href="#l20.862"></a><span id="l20.862" class="difflineplus">+        await PlacesTransactions.Tag({ urls: aURIs, tags: newTags })</span>
<a href="#l20.863"></a><span id="l20.863" class="difflineplus">+                                .transact();</span>
<a href="#l20.864"></a><span id="l20.864" class="difflineplus">+      }</span>
<a href="#l20.865"></a><span id="l20.865" class="difflineplus">+    };</span>
<a href="#l20.866"></a><span id="l20.866"> </span>
<a href="#l20.867"></a><span id="l20.867" class="difflineminus">-        // Ensure the tagsField is in sync, clean it up from empty tags</span>
<a href="#l20.868"></a><span id="l20.868" class="difflineminus">-        var tags = PlacesUtils.tagging.getTagsForURI(this._uri).join(&quot;, &quot;);</span>
<a href="#l20.869"></a><span id="l20.869" class="difflineminus">-        this._initTextField(&quot;tagsField&quot;, tags, false);</span>
<a href="#l20.870"></a><span id="l20.870" class="difflineminus">-        return true;</span>
<a href="#l20.871"></a><span id="l20.871" class="difflineminus">-      }</span>
<a href="#l20.872"></a><span id="l20.872" class="difflineminus">-    }</span>
<a href="#l20.873"></a><span id="l20.873" class="difflineminus">-    return false;</span>
<a href="#l20.874"></a><span id="l20.874" class="difflineplus">+    // Only in the library info-pane it's safe (and necessary) to batch these.</span>
<a href="#l20.875"></a><span id="l20.875" class="difflineplus">+    // TODO bug 1093030: cleanup this mess when the bookmarksProperties dialog</span>
<a href="#l20.876"></a><span id="l20.876" class="difflineplus">+    // and star UI code don't &quot;run a batch in the background&quot;.</span>
<a href="#l20.877"></a><span id="l20.877" class="difflineplus">+    if (window.document.documentElement.id == &quot;places&quot;)</span>
<a href="#l20.878"></a><span id="l20.878" class="difflineplus">+      PlacesTransactions.batch(setTags).catch(Cu.reportError);</span>
<a href="#l20.879"></a><span id="l20.879" class="difflineplus">+    else</span>
<a href="#l20.880"></a><span id="l20.880" class="difflineplus">+      setTags().catch(Cu.reportError);</span>
<a href="#l20.881"></a><span id="l20.881" class="difflineplus">+    return true;</span>
<a href="#l20.882"></a><span id="l20.882">   },</span>
<a href="#l20.883"></a><span id="l20.883"> </span>
<a href="#l20.884"></a><span id="l20.884" class="difflineminus">-   /**</span>
<a href="#l20.885"></a><span id="l20.885" class="difflineminus">-    * Stores the first-edit field for this dialog, if the passed-in field</span>
<a href="#l20.886"></a><span id="l20.886" class="difflineminus">-    * is indeed the first edited field</span>
<a href="#l20.887"></a><span id="l20.887" class="difflineminus">-    * @param aNewField</span>
<a href="#l20.888"></a><span id="l20.888" class="difflineminus">-    *        the id of the field that may be set (without the &quot;editBMPanel_&quot;</span>
<a href="#l20.889"></a><span id="l20.889" class="difflineminus">-    *        prefix)</span>
<a href="#l20.890"></a><span id="l20.890" class="difflineminus">-    */</span>
<a href="#l20.891"></a><span id="l20.891" class="difflineminus">-  _mayUpdateFirstEditField: function EIO__mayUpdateFirstEditField(aNewField) {</span>
<a href="#l20.892"></a><span id="l20.892" class="difflineplus">+  async _updateTags() {</span>
<a href="#l20.893"></a><span id="l20.893" class="difflineplus">+    let uris = this._paneInfo.bulkTagging ?</span>
<a href="#l20.894"></a><span id="l20.894" class="difflineplus">+                 this._paneInfo.uris : [this._paneInfo.uri];</span>
<a href="#l20.895"></a><span id="l20.895" class="difflineplus">+    let currentTags = this._paneInfo.bulkTagging ?</span>
<a href="#l20.896"></a><span id="l20.896" class="difflineplus">+                        await this._getCommonTags() :</span>
<a href="#l20.897"></a><span id="l20.897" class="difflineplus">+                        PlacesUtils.tagging.getTagsForURI(uris[0]);</span>
<a href="#l20.898"></a><span id="l20.898" class="difflineplus">+    let anyChanges = this._setTagsFromTagsInputField(currentTags, uris);</span>
<a href="#l20.899"></a><span id="l20.899" class="difflineplus">+    if (!anyChanges)</span>
<a href="#l20.900"></a><span id="l20.900" class="difflineplus">+      return false;</span>
<a href="#l20.901"></a><span id="l20.901" class="difflineplus">+</span>
<a href="#l20.902"></a><span id="l20.902" class="difflineplus">+    // The panel could have been closed in the meanwhile.</span>
<a href="#l20.903"></a><span id="l20.903" class="difflineplus">+    if (!this._paneInfo)</span>
<a href="#l20.904"></a><span id="l20.904" class="difflineplus">+      return false;</span>
<a href="#l20.905"></a><span id="l20.905" class="difflineplus">+</span>
<a href="#l20.906"></a><span id="l20.906" class="difflineplus">+    // Ensure the tagsField is in sync, clean it up from empty tags</span>
<a href="#l20.907"></a><span id="l20.907" class="difflineplus">+    currentTags = this._paneInfo.bulkTagging ?</span>
<a href="#l20.908"></a><span id="l20.908" class="difflineplus">+                    this._getCommonTags() :</span>
<a href="#l20.909"></a><span id="l20.909" class="difflineplus">+                    PlacesUtils.tagging.getTagsForURI(this._paneInfo.uri);</span>
<a href="#l20.910"></a><span id="l20.910" class="difflineplus">+    this._initTextField(this._tagsField, currentTags.join(&quot;, &quot;), false);</span>
<a href="#l20.911"></a><span id="l20.911" class="difflineplus">+    return true;</span>
<a href="#l20.912"></a><span id="l20.912" class="difflineplus">+  },</span>
<a href="#l20.913"></a><span id="l20.913" class="difflineplus">+</span>
<a href="#l20.914"></a><span id="l20.914" class="difflineplus">+  /**</span>
<a href="#l20.915"></a><span id="l20.915" class="difflineplus">+   * Stores the first-edit field for this dialog, if the passed-in field</span>
<a href="#l20.916"></a><span id="l20.916" class="difflineplus">+   * is indeed the first edited field</span>
<a href="#l20.917"></a><span id="l20.917" class="difflineplus">+   * @param aNewField</span>
<a href="#l20.918"></a><span id="l20.918" class="difflineplus">+   *        the id of the field that may be set (without the &quot;editBMPanel_&quot;</span>
<a href="#l20.919"></a><span id="l20.919" class="difflineplus">+   *        prefix)</span>
<a href="#l20.920"></a><span id="l20.920" class="difflineplus">+   */</span>
<a href="#l20.921"></a><span id="l20.921" class="difflineplus">+  _mayUpdateFirstEditField(aNewField) {</span>
<a href="#l20.922"></a><span id="l20.922">     // * The first-edit-field behavior is not applied in the multi-edit case</span>
<a href="#l20.923"></a><span id="l20.923">     // * if this._firstEditedField is already set, this is not the first field,</span>
<a href="#l20.924"></a><span id="l20.924">     //   so there's nothing to do</span>
<a href="#l20.925"></a><span id="l20.925" class="difflineminus">-    if (this._multiEdit || this._firstEditedField)</span>
<a href="#l20.926"></a><span id="l20.926" class="difflineplus">+    if (this._paneInfo.bulkTagging || this._firstEditedField)</span>
<a href="#l20.927"></a><span id="l20.927">       return;</span>
<a href="#l20.928"></a><span id="l20.928"> </span>
<a href="#l20.929"></a><span id="l20.929">     this._firstEditedField = aNewField;</span>
<a href="#l20.930"></a><span id="l20.930"> </span>
<a href="#l20.931"></a><span id="l20.931">     // set the pref</span>
<a href="#l20.932"></a><span id="l20.932" class="difflineminus">-    Services.prefs.setCharPref(&quot;browser.bookmarks.editDialog.firstEditField&quot;, aNewField);</span>
<a href="#l20.933"></a><span id="l20.933" class="difflineplus">+    var prefs = Cc[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l20.934"></a><span id="l20.934" class="difflineplus">+                  .getService(Ci.nsIPrefBranch);</span>
<a href="#l20.935"></a><span id="l20.935" class="difflineplus">+    prefs.setCharPref(&quot;browser.bookmarks.editDialog.firstEditField&quot;, aNewField);</span>
<a href="#l20.936"></a><span id="l20.936">   },</span>
<a href="#l20.937"></a><span id="l20.937"> </span>
<a href="#l20.938"></a><span id="l20.938" class="difflineminus">-  _updateMultipleTagsForItems: function EIO__updateMultipleTagsForItems() {</span>
<a href="#l20.939"></a><span id="l20.939" class="difflineminus">-    var tags = this._getTagsArrayFromTagField();</span>
<a href="#l20.940"></a><span id="l20.940" class="difflineminus">-    if (tags.length &gt; 0 || this._allTags.length &gt; 0) {</span>
<a href="#l20.941"></a><span id="l20.941" class="difflineminus">-      var tagsToRemove = [];</span>
<a href="#l20.942"></a><span id="l20.942" class="difflineminus">-      var tagsToAdd = [];</span>
<a href="#l20.943"></a><span id="l20.943" class="difflineminus">-      var txns = [];</span>
<a href="#l20.944"></a><span id="l20.944" class="difflineminus">-      for (var i = 0; i &lt; this._allTags.length; i++) {</span>
<a href="#l20.945"></a><span id="l20.945" class="difflineminus">-        if (tags.indexOf(this._allTags[i]) == -1)</span>
<a href="#l20.946"></a><span id="l20.946" class="difflineminus">-          tagsToRemove.push(this._allTags[i]);</span>
<a href="#l20.947"></a><span id="l20.947" class="difflineminus">-      }</span>
<a href="#l20.948"></a><span id="l20.948" class="difflineminus">-      for (var i = 0; i &lt; this._tags.length; i++) {</span>
<a href="#l20.949"></a><span id="l20.949" class="difflineminus">-        tagsToAdd[i] = [];</span>
<a href="#l20.950"></a><span id="l20.950" class="difflineminus">-        for (var j = 0; j &lt; tags.length; j++) {</span>
<a href="#l20.951"></a><span id="l20.951" class="difflineminus">-          if (this._tags[i].indexOf(tags[j]) == -1)</span>
<a href="#l20.952"></a><span id="l20.952" class="difflineminus">-            tagsToAdd[i].push(tags[j]);</span>
<a href="#l20.953"></a><span id="l20.953" class="difflineminus">-        }</span>
<a href="#l20.954"></a><span id="l20.954" class="difflineplus">+  async onNamePickerChange() {</span>
<a href="#l20.955"></a><span id="l20.955" class="difflineplus">+    if (this.readOnly || !(this._paneInfo.isItem || this._paneInfo.isTag))</span>
<a href="#l20.956"></a><span id="l20.956" class="difflineplus">+      return;</span>
<a href="#l20.957"></a><span id="l20.957" class="difflineplus">+</span>
<a href="#l20.958"></a><span id="l20.958" class="difflineplus">+    // Here we update either the item title or its cached static title</span>
<a href="#l20.959"></a><span id="l20.959" class="difflineplus">+    let newTitle = this._namePicker.value;</span>
<a href="#l20.960"></a><span id="l20.960" class="difflineplus">+    if (!newTitle &amp;&amp; this._paneInfo.parentGuid == PlacesUtils.bookmarks.tagsGuid) {</span>
<a href="#l20.961"></a><span id="l20.961" class="difflineplus">+      // We don't allow setting an empty title for a tag, restore the old one.</span>
<a href="#l20.962"></a><span id="l20.962" class="difflineplus">+      this._initNamePicker();</span>
<a href="#l20.963"></a><span id="l20.963" class="difflineplus">+    } else {</span>
<a href="#l20.964"></a><span id="l20.964" class="difflineplus">+      this._mayUpdateFirstEditField(&quot;namePicker&quot;);</span>
<a href="#l20.965"></a><span id="l20.965" class="difflineplus">+      if (!PlacesUIUtils.useAsyncTransactions) {</span>
<a href="#l20.966"></a><span id="l20.966" class="difflineplus">+        let txn = new PlacesEditItemTitleTransaction(this._paneInfo.itemId,</span>
<a href="#l20.967"></a><span id="l20.967" class="difflineplus">+                                                     newTitle);</span>
<a href="#l20.968"></a><span id="l20.968" class="difflineplus">+        PlacesUtils.transactionManager.doTransaction(txn);</span>
<a href="#l20.969"></a><span id="l20.969" class="difflineplus">+        return;</span>
<a href="#l20.970"></a><span id="l20.970">       }</span>
<a href="#l20.971"></a><span id="l20.971"> </span>
<a href="#l20.972"></a><span id="l20.972" class="difflineminus">-      if (tagsToAdd.length &gt; 0) {</span>
<a href="#l20.973"></a><span id="l20.973" class="difflineminus">-        for (let i = 0; i &lt; this._uris.length; i++) {</span>
<a href="#l20.974"></a><span id="l20.974" class="difflineminus">-          if (tagsToAdd[i].length &gt; 0) {</span>
<a href="#l20.975"></a><span id="l20.975" class="difflineminus">-            let tagTxn = new PlacesTagURITransaction(this._uris[i],</span>
<a href="#l20.976"></a><span id="l20.976" class="difflineminus">-                                                     tagsToAdd[i]);</span>
<a href="#l20.977"></a><span id="l20.977" class="difflineminus">-            txns.push(tagTxn);</span>
<a href="#l20.978"></a><span id="l20.978" class="difflineminus">-          }</span>
<a href="#l20.979"></a><span id="l20.979" class="difflineminus">-        }</span>
<a href="#l20.980"></a><span id="l20.980" class="difflineminus">-      }</span>
<a href="#l20.981"></a><span id="l20.981" class="difflineminus">-      if (tagsToRemove.length &gt; 0) {</span>
<a href="#l20.982"></a><span id="l20.982" class="difflineminus">-        for (let i = 0; i &lt; this._uris.length; i++) {</span>
<a href="#l20.983"></a><span id="l20.983" class="difflineminus">-          let untagTxn = new PlacesUntagURITransaction(this._uris[i],</span>
<a href="#l20.984"></a><span id="l20.984" class="difflineminus">-                                                       tagsToRemove);</span>
<a href="#l20.985"></a><span id="l20.985" class="difflineminus">-          txns.push(untagTxn);</span>
<a href="#l20.986"></a><span id="l20.986" class="difflineminus">-        }</span>
<a href="#l20.987"></a><span id="l20.987" class="difflineminus">-      }</span>
<a href="#l20.988"></a><span id="l20.988" class="difflineminus">-</span>
<a href="#l20.989"></a><span id="l20.989" class="difflineminus">-      if (txns.length &gt; 0) {</span>
<a href="#l20.990"></a><span id="l20.990" class="difflineminus">-        let aggregate = new PlacesAggregatedTransaction(&quot;Update tags&quot;, txns);</span>
<a href="#l20.991"></a><span id="l20.991" class="difflineminus">-        PlacesUtils.transactionManager.doTransaction(aggregate);</span>
<a href="#l20.992"></a><span id="l20.992" class="difflineminus">-</span>
<a href="#l20.993"></a><span id="l20.993" class="difflineminus">-        this._allTags = tags;</span>
<a href="#l20.994"></a><span id="l20.994" class="difflineminus">-        this._tags = [];</span>
<a href="#l20.995"></a><span id="l20.995" class="difflineminus">-        for (let i = 0; i &lt; this._uris.length; i++)</span>
<a href="#l20.996"></a><span id="l20.996" class="difflineminus">-          this._tags[i] = PlacesUtils.tagging.getTagsForURI(this._uris[i]);</span>
<a href="#l20.997"></a><span id="l20.997" class="difflineminus">-</span>
<a href="#l20.998"></a><span id="l20.998" class="difflineminus">-        // Ensure the tagsField is in sync, clean it up from empty tags</span>
<a href="#l20.999"></a><span id="l20.999" class="difflineminus">-        this._initTextField(&quot;tagsField&quot;, tags, false);</span>
<a href="#l20.1000"></a><span id="l20.1000" class="difflineminus">-        return true;</span>
<a href="#l20.1001"></a><span id="l20.1001" class="difflineminus">-      }</span>
<a href="#l20.1002"></a><span id="l20.1002" class="difflineplus">+      let guid = this._paneInfo.isTag</span>
<a href="#l20.1003"></a><span id="l20.1003" class="difflineplus">+                  ? (await PlacesUtils.promiseItemGuid(this._paneInfo.itemId))</span>
<a href="#l20.1004"></a><span id="l20.1004" class="difflineplus">+                  : this._paneInfo.itemGuid;</span>
<a href="#l20.1005"></a><span id="l20.1005" class="difflineplus">+      await PlacesTransactions.EditTitle({ guid, title: newTitle }).transact();</span>
<a href="#l20.1006"></a><span id="l20.1006">     }</span>
<a href="#l20.1007"></a><span id="l20.1007" class="difflineminus">-    return false;</span>
<a href="#l20.1008"></a><span id="l20.1008">   },</span>
<a href="#l20.1009"></a><span id="l20.1009"> </span>
<a href="#l20.1010"></a><span id="l20.1010" class="difflineminus">-  onNamePickerChange: function EIO_onNamePickerChange() {</span>
<a href="#l20.1011"></a><span id="l20.1011" class="difflineminus">-    if (this._itemId == -1)</span>
<a href="#l20.1012"></a><span id="l20.1012" class="difflineplus">+  onDescriptionFieldChange() {</span>
<a href="#l20.1013"></a><span id="l20.1013" class="difflineplus">+    if (this.readOnly || !this._paneInfo.isItem)</span>
<a href="#l20.1014"></a><span id="l20.1014">       return;</span>
<a href="#l20.1015"></a><span id="l20.1015"> </span>
<a href="#l20.1016"></a><span id="l20.1016" class="difflineminus">-    var namePicker = this._element(&quot;namePicker&quot;)</span>
<a href="#l20.1017"></a><span id="l20.1017" class="difflineminus">-</span>
<a href="#l20.1018"></a><span id="l20.1018" class="difflineminus">-    // Here we update either the item title or its cached static title</span>
<a href="#l20.1019"></a><span id="l20.1019" class="difflineminus">-    var newTitle = namePicker.value;</span>
<a href="#l20.1020"></a><span id="l20.1020" class="difflineminus">-    if (!newTitle &amp;&amp;</span>
<a href="#l20.1021"></a><span id="l20.1021" class="difflineminus">-        PlacesUtils.bookmarks.getFolderIdForItem(this._itemId) == PlacesUtils.tagsFolderId) {</span>
<a href="#l20.1022"></a><span id="l20.1022" class="difflineminus">-      // We don't allow setting an empty title for a tag, restore the old one.</span>
<a href="#l20.1023"></a><span id="l20.1023" class="difflineminus">-      this._initNamePicker();</span>
<a href="#l20.1024"></a><span id="l20.1024" class="difflineminus">-    }</span>
<a href="#l20.1025"></a><span id="l20.1025" class="difflineminus">-    else if (this._getItemStaticTitle() != newTitle) {</span>
<a href="#l20.1026"></a><span id="l20.1026" class="difflineminus">-      this._mayUpdateFirstEditField(&quot;namePicker&quot;);</span>
<a href="#l20.1027"></a><span id="l20.1027" class="difflineminus">-      let txn = new PlacesEditItemTitleTransaction(this._itemId, newTitle);</span>
<a href="#l20.1028"></a><span id="l20.1028" class="difflineminus">-      PlacesUtils.transactionManager.doTransaction(txn);</span>
<a href="#l20.1029"></a><span id="l20.1029" class="difflineplus">+    let itemId = this._paneInfo.itemId;</span>
<a href="#l20.1030"></a><span id="l20.1030" class="difflineplus">+    let description = this._element(&quot;descriptionField&quot;).value;</span>
<a href="#l20.1031"></a><span id="l20.1031" class="difflineplus">+    if (description != PlacesUIUtils.getItemDescription(this._paneInfo.itemId)) {</span>
<a href="#l20.1032"></a><span id="l20.1032" class="difflineplus">+      let annotation =</span>
<a href="#l20.1033"></a><span id="l20.1033" class="difflineplus">+        { name: PlacesUIUtils.DESCRIPTION_ANNO, value: description };</span>
<a href="#l20.1034"></a><span id="l20.1034" class="difflineplus">+      if (!PlacesUIUtils.useAsyncTransactions) {</span>
<a href="#l20.1035"></a><span id="l20.1035" class="difflineplus">+        let txn = new PlacesSetItemAnnotationTransaction(itemId,</span>
<a href="#l20.1036"></a><span id="l20.1036" class="difflineplus">+                                                         annotation);</span>
<a href="#l20.1037"></a><span id="l20.1037" class="difflineplus">+        PlacesUtils.transactionManager.doTransaction(txn);</span>
<a href="#l20.1038"></a><span id="l20.1038" class="difflineplus">+        return;</span>
<a href="#l20.1039"></a><span id="l20.1039" class="difflineplus">+      }</span>
<a href="#l20.1040"></a><span id="l20.1040" class="difflineplus">+      let guid = this._paneInfo.itemGuid;</span>
<a href="#l20.1041"></a><span id="l20.1041" class="difflineplus">+      PlacesTransactions.Annotate({ guid, annotation })</span>
<a href="#l20.1042"></a><span id="l20.1042" class="difflineplus">+                        .transact().catch(Cu.reportError);</span>
<a href="#l20.1043"></a><span id="l20.1043">     }</span>
<a href="#l20.1044"></a><span id="l20.1044">   },</span>
<a href="#l20.1045"></a><span id="l20.1045"> </span>
<a href="#l20.1046"></a><span id="l20.1046" class="difflineminus">-  onDescriptionFieldBlur: function EIO_onDescriptionFieldBlur() {</span>
<a href="#l20.1047"></a><span id="l20.1047" class="difflineminus">-    var description = this._element(&quot;descriptionField&quot;).value;</span>
<a href="#l20.1048"></a><span id="l20.1048" class="difflineminus">-    if (description != PlacesUIUtils.getItemDescription(this._itemId)) {</span>
<a href="#l20.1049"></a><span id="l20.1049" class="difflineminus">-      const nsIAnnotationService = Ci.nsIAnnotationService;</span>
<a href="#l20.1050"></a><span id="l20.1050" class="difflineminus">-      var annoObj = { name   : PlacesUIUtils.DESCRIPTION_ANNO,</span>
<a href="#l20.1051"></a><span id="l20.1051" class="difflineminus">-                      type   : nsIAnnotationService.TYPE_STRING,</span>
<a href="#l20.1052"></a><span id="l20.1052" class="difflineminus">-                      flags  : 0,</span>
<a href="#l20.1053"></a><span id="l20.1053" class="difflineminus">-                      value  : description,</span>
<a href="#l20.1054"></a><span id="l20.1054" class="difflineminus">-                      expires: nsIAnnotationService.EXPIRE_NEVER };</span>
<a href="#l20.1055"></a><span id="l20.1055" class="difflineminus">-      var txn = new PlacesSetItemAnnotationTransaction(this._itemId, annoObj);</span>
<a href="#l20.1056"></a><span id="l20.1056" class="difflineplus">+  onLocationFieldChange() {</span>
<a href="#l20.1057"></a><span id="l20.1057" class="difflineplus">+    if (this.readOnly || !this._paneInfo.isBookmark)</span>
<a href="#l20.1058"></a><span id="l20.1058" class="difflineplus">+      return;</span>
<a href="#l20.1059"></a><span id="l20.1059" class="difflineplus">+</span>
<a href="#l20.1060"></a><span id="l20.1060" class="difflineplus">+    let newURI;</span>
<a href="#l20.1061"></a><span id="l20.1061" class="difflineplus">+    try {</span>
<a href="#l20.1062"></a><span id="l20.1062" class="difflineplus">+      newURI = PlacesUIUtils.createFixedURI(this._locationField.value);</span>
<a href="#l20.1063"></a><span id="l20.1063" class="difflineplus">+    } catch (ex) {</span>
<a href="#l20.1064"></a><span id="l20.1064" class="difflineplus">+      // TODO: Bug 1089141 - Provide some feedback about the invalid url.</span>
<a href="#l20.1065"></a><span id="l20.1065" class="difflineplus">+      return;</span>
<a href="#l20.1066"></a><span id="l20.1066" class="difflineplus">+    }</span>
<a href="#l20.1067"></a><span id="l20.1067" class="difflineplus">+</span>
<a href="#l20.1068"></a><span id="l20.1068" class="difflineplus">+    if (this._paneInfo.uri.equals(newURI))</span>
<a href="#l20.1069"></a><span id="l20.1069" class="difflineplus">+      return;</span>
<a href="#l20.1070"></a><span id="l20.1070" class="difflineplus">+</span>
<a href="#l20.1071"></a><span id="l20.1071" class="difflineplus">+    if (!PlacesUIUtils.useAsyncTransactions) {</span>
<a href="#l20.1072"></a><span id="l20.1072" class="difflineplus">+      let txn = new PlacesEditBookmarkURITransaction(this._paneInfo.itemId, newURI);</span>
<a href="#l20.1073"></a><span id="l20.1073">       PlacesUtils.transactionManager.doTransaction(txn);</span>
<a href="#l20.1074"></a><span id="l20.1074" class="difflineplus">+      return;</span>
<a href="#l20.1075"></a><span id="l20.1075">     }</span>
<a href="#l20.1076"></a><span id="l20.1076" class="difflineplus">+    let guid = this._paneInfo.itemGuid;</span>
<a href="#l20.1077"></a><span id="l20.1077" class="difflineplus">+    PlacesTransactions.EditUrl({ guid, url: newURI })</span>
<a href="#l20.1078"></a><span id="l20.1078" class="difflineplus">+                      .transact().catch(Cu.reportError);</span>
<a href="#l20.1079"></a><span id="l20.1079">   },</span>
<a href="#l20.1080"></a><span id="l20.1080"> </span>
<a href="#l20.1081"></a><span id="l20.1081" class="difflineminus">-  onLocationFieldBlur: function EIO_onLocationFieldBlur() {</span>
<a href="#l20.1082"></a><span id="l20.1082" class="difflineminus">-    var uri;</span>
<a href="#l20.1083"></a><span id="l20.1083" class="difflineminus">-    try {</span>
<a href="#l20.1084"></a><span id="l20.1084" class="difflineminus">-      uri = PlacesUIUtils.createFixedURI(this._element(&quot;locationField&quot;).value);</span>
<a href="#l20.1085"></a><span id="l20.1085" class="difflineplus">+  onKeywordFieldChange() {</span>
<a href="#l20.1086"></a><span id="l20.1086" class="difflineplus">+    if (this.readOnly || !this._paneInfo.isBookmark)</span>
<a href="#l20.1087"></a><span id="l20.1087" class="difflineplus">+      return;</span>
<a href="#l20.1088"></a><span id="l20.1088" class="difflineplus">+</span>
<a href="#l20.1089"></a><span id="l20.1089" class="difflineplus">+    let itemId = this._paneInfo.itemId;</span>
<a href="#l20.1090"></a><span id="l20.1090" class="difflineplus">+    let oldKeyword = this._keyword;</span>
<a href="#l20.1091"></a><span id="l20.1091" class="difflineplus">+    let keyword = this._keyword = this._keywordField.value;</span>
<a href="#l20.1092"></a><span id="l20.1092" class="difflineplus">+    let postData = this._paneInfo.postData;</span>
<a href="#l20.1093"></a><span id="l20.1093" class="difflineplus">+    if (!PlacesUIUtils.useAsyncTransactions) {</span>
<a href="#l20.1094"></a><span id="l20.1094" class="difflineplus">+      let txn = new PlacesEditBookmarkKeywordTransaction(itemId,</span>
<a href="#l20.1095"></a><span id="l20.1095" class="difflineplus">+                                                         keyword,</span>
<a href="#l20.1096"></a><span id="l20.1096" class="difflineplus">+                                                         postData,</span>
<a href="#l20.1097"></a><span id="l20.1097" class="difflineplus">+                                                         oldKeyword);</span>
<a href="#l20.1098"></a><span id="l20.1098" class="difflineplus">+      PlacesUtils.transactionManager.doTransaction(txn);</span>
<a href="#l20.1099"></a><span id="l20.1099" class="difflineplus">+      return;</span>
<a href="#l20.1100"></a><span id="l20.1100">     }</span>
<a href="#l20.1101"></a><span id="l20.1101" class="difflineminus">-    catch(ex) { return; }</span>
<a href="#l20.1102"></a><span id="l20.1102" class="difflineminus">-</span>
<a href="#l20.1103"></a><span id="l20.1103" class="difflineminus">-    if (!this._uri.equals(uri)) {</span>
<a href="#l20.1104"></a><span id="l20.1104" class="difflineminus">-      var txn = new PlacesEditBookmarkURITransaction(this._itemId, uri);</span>
<a href="#l20.1105"></a><span id="l20.1105" class="difflineminus">-      PlacesUtils.transactionManager.doTransaction(txn);</span>
<a href="#l20.1106"></a><span id="l20.1106" class="difflineminus">-      this._uri = uri;</span>
<a href="#l20.1107"></a><span id="l20.1107" class="difflineminus">-    }</span>
<a href="#l20.1108"></a><span id="l20.1108" class="difflineplus">+    let guid = this._paneInfo.itemGuid;</span>
<a href="#l20.1109"></a><span id="l20.1109" class="difflineplus">+    PlacesTransactions.EditKeyword({ guid, keyword, postData, oldKeyword })</span>
<a href="#l20.1110"></a><span id="l20.1110" class="difflineplus">+                      .transact().catch(Cu.reportError);</span>
<a href="#l20.1111"></a><span id="l20.1111">   },</span>
<a href="#l20.1112"></a><span id="l20.1112"> </span>
<a href="#l20.1113"></a><span id="l20.1113" class="difflineminus">-  onKeywordFieldBlur: function EIO_onKeywordFieldBlur() {</span>
<a href="#l20.1114"></a><span id="l20.1114" class="difflineminus">-    var keyword = this._element(&quot;keywordField&quot;).value;</span>
<a href="#l20.1115"></a><span id="l20.1115" class="difflineminus">-    if (keyword != PlacesUtils.bookmarks.getKeywordForBookmark(this._itemId)) {</span>
<a href="#l20.1116"></a><span id="l20.1116" class="difflineminus">-      var txn = new PlacesEditBookmarkKeywordTransaction(this._itemId, keyword);</span>
<a href="#l20.1117"></a><span id="l20.1117" class="difflineplus">+  onLoadInSidebarCheckboxCommand() {</span>
<a href="#l20.1118"></a><span id="l20.1118" class="difflineplus">+    if (!this.initialized || !this._paneInfo.isBookmark)</span>
<a href="#l20.1119"></a><span id="l20.1119" class="difflineplus">+      return;</span>
<a href="#l20.1120"></a><span id="l20.1120" class="difflineplus">+</span>
<a href="#l20.1121"></a><span id="l20.1121" class="difflineplus">+    let annotation = { name: PlacesUIUtils.LOAD_IN_SIDEBAR_ANNO };</span>
<a href="#l20.1122"></a><span id="l20.1122" class="difflineplus">+    if (this._loadInSidebarCheckbox.checked)</span>
<a href="#l20.1123"></a><span id="l20.1123" class="difflineplus">+      annotation.value = true;</span>
<a href="#l20.1124"></a><span id="l20.1124" class="difflineplus">+</span>
<a href="#l20.1125"></a><span id="l20.1125" class="difflineplus">+    if (!PlacesUIUtils.useAsyncTransactions) {</span>
<a href="#l20.1126"></a><span id="l20.1126" class="difflineplus">+      let itemId = this._paneInfo.itemId;</span>
<a href="#l20.1127"></a><span id="l20.1127" class="difflineplus">+      let txn = new PlacesSetItemAnnotationTransaction(itemId,</span>
<a href="#l20.1128"></a><span id="l20.1128" class="difflineplus">+                                                       annotation);</span>
<a href="#l20.1129"></a><span id="l20.1129">       PlacesUtils.transactionManager.doTransaction(txn);</span>
<a href="#l20.1130"></a><span id="l20.1130" class="difflineplus">+      return;</span>
<a href="#l20.1131"></a><span id="l20.1131">     }</span>
<a href="#l20.1132"></a><span id="l20.1132" class="difflineplus">+    let guid = this._paneInfo.itemGuid;</span>
<a href="#l20.1133"></a><span id="l20.1133" class="difflineplus">+    PlacesTransactions.Annotate({ guid, annotation })</span>
<a href="#l20.1134"></a><span id="l20.1134" class="difflineplus">+                      .transact().catch(Cu.reportError);</span>
<a href="#l20.1135"></a><span id="l20.1135">   },</span>
<a href="#l20.1136"></a><span id="l20.1136"> </span>
<a href="#l20.1137"></a><span id="l20.1137" class="difflineminus">-  toggleFolderTreeVisibility: function EIO_toggleFolderTreeVisibility() {</span>
<a href="#l20.1138"></a><span id="l20.1138" class="difflineplus">+  toggleFolderTreeVisibility() {</span>
<a href="#l20.1139"></a><span id="l20.1139">     var expander = this._element(&quot;foldersExpander&quot;);</span>
<a href="#l20.1140"></a><span id="l20.1140">     var folderTreeRow = this._element(&quot;folderTreeRow&quot;);</span>
<a href="#l20.1141"></a><span id="l20.1141">     if (!folderTreeRow.collapsed) {</span>
<a href="#l20.1142"></a><span id="l20.1142">       expander.className = &quot;expander-down&quot;;</span>
<a href="#l20.1143"></a><span id="l20.1143">       expander.setAttribute(&quot;tooltiptext&quot;,</span>
<a href="#l20.1144"></a><span id="l20.1144">                             expander.getAttribute(&quot;tooltiptextdown&quot;));</span>
<a href="#l20.1145"></a><span id="l20.1145">       folderTreeRow.collapsed = true;</span>
<a href="#l20.1146"></a><span id="l20.1146">       this._element(&quot;chooseFolderSeparator&quot;).hidden =</span>
<a href="#l20.1147"></a><span id="l20.1147">         this._element(&quot;chooseFolderMenuItem&quot;).hidden = false;</span>
<a href="#l20.1148"></a><span id="l20.1148" class="difflineminus">-    }</span>
<a href="#l20.1149"></a><span id="l20.1149" class="difflineminus">-    else {</span>
<a href="#l20.1150"></a><span id="l20.1150" class="difflineplus">+    } else {</span>
<a href="#l20.1151"></a><span id="l20.1151">       expander.className = &quot;expander-up&quot;</span>
<a href="#l20.1152"></a><span id="l20.1152">       expander.setAttribute(&quot;tooltiptext&quot;,</span>
<a href="#l20.1153"></a><span id="l20.1153">                             expander.getAttribute(&quot;tooltiptextup&quot;));</span>
<a href="#l20.1154"></a><span id="l20.1154">       folderTreeRow.collapsed = false;</span>
<a href="#l20.1155"></a><span id="l20.1155" class="difflineplus">+</span>
<a href="#l20.1156"></a><span id="l20.1156">       // XXXmano: Ideally we would only do this once, but for some odd reason,</span>
<a href="#l20.1157"></a><span id="l20.1157">       // the editable mode set on this tree, together with its collapsed state</span>
<a href="#l20.1158"></a><span id="l20.1158">       // breaks the view.</span>
<a href="#l20.1159"></a><span id="l20.1159">       const FOLDER_TREE_PLACE_URI =</span>
<a href="#l20.1160"></a><span id="l20.1160">         &quot;place:excludeItems=1&amp;excludeQueries=1&amp;excludeReadOnlyFolders=1&amp;folder=&quot; +</span>
<a href="#l20.1161"></a><span id="l20.1161">         PlacesUIUtils.allBookmarksFolderId;</span>
<a href="#l20.1162"></a><span id="l20.1162">       this._folderTree.place = FOLDER_TREE_PLACE_URI;</span>
<a href="#l20.1163"></a><span id="l20.1163"> </span>
<a href="#l20.1164"></a><span id="l20.1164">       this._element(&quot;chooseFolderSeparator&quot;).hidden =</span>
<a href="#l20.1165"></a><span id="l20.1165">         this._element(&quot;chooseFolderMenuItem&quot;).hidden = true;</span>
<a href="#l20.1166"></a><span id="l20.1166" class="difflineminus">-      var currentFolder = this._getFolderIdFromMenuList();</span>
<a href="#l20.1167"></a><span id="l20.1167" class="difflineminus">-      this._folderTree.selectItems([currentFolder]);</span>
<a href="#l20.1168"></a><span id="l20.1168" class="difflineplus">+      this._folderTree.selectItems([this._paneInfo.parentId]);</span>
<a href="#l20.1169"></a><span id="l20.1169">       this._folderTree.focus();</span>
<a href="#l20.1170"></a><span id="l20.1170">     }</span>
<a href="#l20.1171"></a><span id="l20.1171">   },</span>
<a href="#l20.1172"></a><span id="l20.1172"> </span>
<a href="#l20.1173"></a><span id="l20.1173" class="difflineminus">-  _getFolderIdFromMenuList:</span>
<a href="#l20.1174"></a><span id="l20.1174" class="difflineminus">-  function EIO__getFolderIdFromMenuList() {</span>
<a href="#l20.1175"></a><span id="l20.1175" class="difflineminus">-    var selectedItem = this._folderMenuList.selectedItem;</span>
<a href="#l20.1176"></a><span id="l20.1176" class="difflineminus">-    NS_ASSERT(&quot;folderId&quot; in selectedItem,</span>
<a href="#l20.1177"></a><span id="l20.1177" class="difflineminus">-              &quot;Invalid menuitem in the folders-menulist&quot;);</span>
<a href="#l20.1178"></a><span id="l20.1178" class="difflineminus">-    return selectedItem.folderId;</span>
<a href="#l20.1179"></a><span id="l20.1179" class="difflineminus">-  },</span>
<a href="#l20.1180"></a><span id="l20.1180" class="difflineminus">-</span>
<a href="#l20.1181"></a><span id="l20.1181">   /**</span>
<a href="#l20.1182"></a><span id="l20.1182">    * Get the corresponding menu-item in the folder-menu-list for a bookmarks</span>
<a href="#l20.1183"></a><span id="l20.1183">    * folder if such an item exists. Otherwise, this creates a menu-item for the</span>
<a href="#l20.1184"></a><span id="l20.1184">    * folder. If the items-count limit (see MAX_FOLDERS_IN_MENU_LIST) is reached,</span>
<a href="#l20.1185"></a><span id="l20.1185">    * the new item replaces the last menu-item.</span>
<a href="#l20.1186"></a><span id="l20.1186">    * @param aFolderId</span>
<a href="#l20.1187"></a><span id="l20.1187">    *        The identifier of the bookmarks folder.</span>
<a href="#l20.1188"></a><span id="l20.1188" class="difflineplus">+   * @param aTitle</span>
<a href="#l20.1189"></a><span id="l20.1189" class="difflineplus">+   *        The title to use in case of menuitem creation.</span>
<a href="#l20.1190"></a><span id="l20.1190" class="difflineplus">+   * @return handle to the menuitem.</span>
<a href="#l20.1191"></a><span id="l20.1191">    */</span>
<a href="#l20.1192"></a><span id="l20.1192" class="difflineminus">-  _getFolderMenuItem:</span>
<a href="#l20.1193"></a><span id="l20.1193" class="difflineminus">-  function EIO__getFolderMenuItem(aFolderId) {</span>
<a href="#l20.1194"></a><span id="l20.1194" class="difflineminus">-    var menupopup = this._folderMenuList.menupopup;</span>
<a href="#l20.1195"></a><span id="l20.1195" class="difflineminus">-</span>
<a href="#l20.1196"></a><span id="l20.1196" class="difflineminus">-    for (let i = 0; i &lt; menupopup.childNodes.length; i++) {</span>
<a href="#l20.1197"></a><span id="l20.1197" class="difflineminus">-      if (&quot;folderId&quot; in menupopup.childNodes[i] &amp;&amp;</span>
<a href="#l20.1198"></a><span id="l20.1198" class="difflineminus">-          menupopup.childNodes[i].folderId == aFolderId)</span>
<a href="#l20.1199"></a><span id="l20.1199" class="difflineminus">-        return menupopup.childNodes[i];</span>
<a href="#l20.1200"></a><span id="l20.1200" class="difflineminus">-    }</span>
<a href="#l20.1201"></a><span id="l20.1201" class="difflineplus">+  _getFolderMenuItem(aFolderId, aTitle) {</span>
<a href="#l20.1202"></a><span id="l20.1202" class="difflineplus">+    let menupopup = this._folderMenuList.menupopup;</span>
<a href="#l20.1203"></a><span id="l20.1203" class="difflineplus">+    let menuItem = Array.prototype.find.call(</span>
<a href="#l20.1204"></a><span id="l20.1204" class="difflineplus">+      menupopup.childNodes, item =&gt; item.folderId === aFolderId);</span>
<a href="#l20.1205"></a><span id="l20.1205" class="difflineplus">+    if (menuItem !== undefined)</span>
<a href="#l20.1206"></a><span id="l20.1206" class="difflineplus">+      return menuItem;</span>
<a href="#l20.1207"></a><span id="l20.1207"> </span>
<a href="#l20.1208"></a><span id="l20.1208">     // 3 special folders + separator + folder-items-count limit</span>
<a href="#l20.1209"></a><span id="l20.1209">     if (menupopup.childNodes.length == 4 + MAX_FOLDER_ITEM_IN_MENU_LIST)</span>
<a href="#l20.1210"></a><span id="l20.1210" class="difflineminus">-      menupopup.lastChild.remove();</span>
<a href="#l20.1211"></a><span id="l20.1211" class="difflineplus">+      menupopup.removeChild(menupopup.lastChild);</span>
<a href="#l20.1212"></a><span id="l20.1212"> </span>
<a href="#l20.1213"></a><span id="l20.1213" class="difflineminus">-    return this._appendFolderItemToMenupopup(menupopup, aFolderId);</span>
<a href="#l20.1214"></a><span id="l20.1214" class="difflineplus">+    return this._appendFolderItemToMenupopup(menupopup, aFolderId, aTitle);</span>
<a href="#l20.1215"></a><span id="l20.1215">   },</span>
<a href="#l20.1216"></a><span id="l20.1216"> </span>
<a href="#l20.1217"></a><span id="l20.1217" class="difflineminus">-  onFolderMenuListCommand: function EIO_onFolderMenuListCommand(aEvent) {</span>
<a href="#l20.1218"></a><span id="l20.1218" class="difflineplus">+  async onFolderMenuListCommand(aEvent) {</span>
<a href="#l20.1219"></a><span id="l20.1219" class="difflineplus">+    // Check for _paneInfo existing as the dialog may be closing but receiving</span>
<a href="#l20.1220"></a><span id="l20.1220" class="difflineplus">+    // async updates from unresolved promises.</span>
<a href="#l20.1221"></a><span id="l20.1221" class="difflineplus">+    if (!this._paneInfo) {</span>
<a href="#l20.1222"></a><span id="l20.1222" class="difflineplus">+      return;</span>
<a href="#l20.1223"></a><span id="l20.1223" class="difflineplus">+    }</span>
<a href="#l20.1224"></a><span id="l20.1224">     // Set a selectedIndex attribute to show special icons</span>
<a href="#l20.1225"></a><span id="l20.1225">     this._folderMenuList.setAttribute(&quot;selectedIndex&quot;,</span>
<a href="#l20.1226"></a><span id="l20.1226">                                       this._folderMenuList.selectedIndex);</span>
<a href="#l20.1227"></a><span id="l20.1227"> </span>
<a href="#l20.1228"></a><span id="l20.1228">     if (aEvent.target.id == &quot;editBMPanel_chooseFolderMenuItem&quot;) {</span>
<a href="#l20.1229"></a><span id="l20.1229">       // reset the selection back to where it was and expand the tree</span>
<a href="#l20.1230"></a><span id="l20.1230">       // (this menu-item is hidden when the tree is already visible</span>
<a href="#l20.1231"></a><span id="l20.1231" class="difflineminus">-      var container = PlacesUtils.bookmarks.getFolderIdForItem(this._itemId);</span>
<a href="#l20.1232"></a><span id="l20.1232" class="difflineminus">-      var item = this._getFolderMenuItem(container);</span>
<a href="#l20.1233"></a><span id="l20.1233" class="difflineplus">+      let item = this._getFolderMenuItem(this._paneInfo.parentId,</span>
<a href="#l20.1234"></a><span id="l20.1234" class="difflineplus">+                                         this._paneInfo.title);</span>
<a href="#l20.1235"></a><span id="l20.1235">       this._folderMenuList.selectedItem = item;</span>
<a href="#l20.1236"></a><span id="l20.1236">       // XXXmano HACK: setTimeout 100, otherwise focus goes back to the</span>
<a href="#l20.1237"></a><span id="l20.1237">       // menulist right away</span>
<a href="#l20.1238"></a><span id="l20.1238">       setTimeout(() =&gt; this.toggleFolderTreeVisibility(), 100);</span>
<a href="#l20.1239"></a><span id="l20.1239">       return;</span>
<a href="#l20.1240"></a><span id="l20.1240">     }</span>
<a href="#l20.1241"></a><span id="l20.1241"> </span>
<a href="#l20.1242"></a><span id="l20.1242">     // Move the item</span>
<a href="#l20.1243"></a><span id="l20.1243" class="difflineminus">-    var container = this._getFolderIdFromMenuList();</span>
<a href="#l20.1244"></a><span id="l20.1244" class="difflineminus">-    if (PlacesUtils.bookmarks.getFolderIdForItem(this._itemId) != container) {</span>
<a href="#l20.1245"></a><span id="l20.1245" class="difflineminus">-      var txn = new PlacesMoveItemTransaction(this._itemId,</span>
<a href="#l20.1246"></a><span id="l20.1246" class="difflineminus">-                                              container,</span>
<a href="#l20.1247"></a><span id="l20.1247" class="difflineminus">-                                              PlacesUtils.bookmarks.DEFAULT_INDEX);</span>
<a href="#l20.1248"></a><span id="l20.1248" class="difflineminus">-      PlacesUtils.transactionManager.doTransaction(txn);</span>
<a href="#l20.1249"></a><span id="l20.1249" class="difflineplus">+    let containerId = this._folderMenuList.selectedItem.folderId;</span>
<a href="#l20.1250"></a><span id="l20.1250" class="difflineplus">+    if (this._paneInfo.parentId != containerId &amp;&amp;</span>
<a href="#l20.1251"></a><span id="l20.1251" class="difflineplus">+        this._paneInfo.itemId != containerId) {</span>
<a href="#l20.1252"></a><span id="l20.1252" class="difflineplus">+      if (PlacesUIUtils.useAsyncTransactions) {</span>
<a href="#l20.1253"></a><span id="l20.1253" class="difflineplus">+        let newParentGuid = await PlacesUtils.promiseItemGuid(containerId);</span>
<a href="#l20.1254"></a><span id="l20.1254" class="difflineplus">+        let guid = this._paneInfo.itemGuid;</span>
<a href="#l20.1255"></a><span id="l20.1255" class="difflineplus">+        await PlacesTransactions.Move({ guid, newParentGuid }).transact();</span>
<a href="#l20.1256"></a><span id="l20.1256" class="difflineplus">+      } else {</span>
<a href="#l20.1257"></a><span id="l20.1257" class="difflineplus">+        let txn = new PlacesMoveItemTransaction(this._paneInfo.itemId,</span>
<a href="#l20.1258"></a><span id="l20.1258" class="difflineplus">+                                                containerId,</span>
<a href="#l20.1259"></a><span id="l20.1259" class="difflineplus">+                                                PlacesUtils.bookmarks.DEFAULT_INDEX);</span>
<a href="#l20.1260"></a><span id="l20.1260" class="difflineplus">+        PlacesUtils.transactionManager.doTransaction(txn);</span>
<a href="#l20.1261"></a><span id="l20.1261" class="difflineplus">+      }</span>
<a href="#l20.1262"></a><span id="l20.1262"> </span>
<a href="#l20.1263"></a><span id="l20.1263">       // Mark the containing folder as recently-used if it isn't in the</span>
<a href="#l20.1264"></a><span id="l20.1264">       // static list</span>
<a href="#l20.1265"></a><span id="l20.1265" class="difflineminus">-      if (container != PlacesUtils.unfiledBookmarksFolderId &amp;&amp;</span>
<a href="#l20.1266"></a><span id="l20.1266" class="difflineminus">-          container != PlacesUtils.toolbarFolderId &amp;&amp;</span>
<a href="#l20.1267"></a><span id="l20.1267" class="difflineminus">-          container != PlacesUtils.bookmarksMenuFolderId)</span>
<a href="#l20.1268"></a><span id="l20.1268" class="difflineminus">-        this._markFolderAsRecentlyUsed(container);</span>
<a href="#l20.1269"></a><span id="l20.1269" class="difflineplus">+      if (containerId != PlacesUtils.unfiledBookmarksFolderId &amp;&amp;</span>
<a href="#l20.1270"></a><span id="l20.1270" class="difflineplus">+          containerId != PlacesUtils.toolbarFolderId &amp;&amp;</span>
<a href="#l20.1271"></a><span id="l20.1271" class="difflineplus">+          containerId != PlacesUtils.bookmarksMenuFolderId) {</span>
<a href="#l20.1272"></a><span id="l20.1272" class="difflineplus">+        this._markFolderAsRecentlyUsed(containerId)</span>
<a href="#l20.1273"></a><span id="l20.1273" class="difflineplus">+            .catch(Cu.reportError);</span>
<a href="#l20.1274"></a><span id="l20.1274" class="difflineplus">+      }</span>
<a href="#l20.1275"></a><span id="l20.1275" class="difflineplus">+</span>
<a href="#l20.1276"></a><span id="l20.1276" class="difflineplus">+      // Auto-show the bookmarks toolbar when adding / moving an item there.</span>
<a href="#l20.1277"></a><span id="l20.1277" class="difflineplus">+      if (containerId == PlacesUtils.toolbarFolderId) {</span>
<a href="#l20.1278"></a><span id="l20.1278" class="difflineplus">+        Services.obs.notifyObservers(null, &quot;autoshow-bookmarks-toolbar&quot;);</span>
<a href="#l20.1279"></a><span id="l20.1279" class="difflineplus">+      }</span>
<a href="#l20.1280"></a><span id="l20.1280">     }</span>
<a href="#l20.1281"></a><span id="l20.1281"> </span>
<a href="#l20.1282"></a><span id="l20.1282">     // Update folder-tree selection</span>
<a href="#l20.1283"></a><span id="l20.1283">     var folderTreeRow = this._element(&quot;folderTreeRow&quot;);</span>
<a href="#l20.1284"></a><span id="l20.1284">     if (!folderTreeRow.collapsed) {</span>
<a href="#l20.1285"></a><span id="l20.1285">       var selectedNode = this._folderTree.selectedNode;</span>
<a href="#l20.1286"></a><span id="l20.1286">       if (!selectedNode ||</span>
<a href="#l20.1287"></a><span id="l20.1287" class="difflineminus">-          PlacesUtils.getConcreteItemId(selectedNode) != container)</span>
<a href="#l20.1288"></a><span id="l20.1288" class="difflineminus">-        this._folderTree.selectItems([container]);</span>
<a href="#l20.1289"></a><span id="l20.1289" class="difflineplus">+          PlacesUtils.getConcreteItemId(selectedNode) != containerId)</span>
<a href="#l20.1290"></a><span id="l20.1290" class="difflineplus">+        this._folderTree.selectItems([containerId]);</span>
<a href="#l20.1291"></a><span id="l20.1291">     }</span>
<a href="#l20.1292"></a><span id="l20.1292">   },</span>
<a href="#l20.1293"></a><span id="l20.1293"> </span>
<a href="#l20.1294"></a><span id="l20.1294" class="difflineminus">-  onFolderTreeSelect: function EIO_onFolderTreeSelect() {</span>
<a href="#l20.1295"></a><span id="l20.1295" class="difflineplus">+  onFolderTreeSelect() {</span>
<a href="#l20.1296"></a><span id="l20.1296">     var selectedNode = this._folderTree.selectedNode;</span>
<a href="#l20.1297"></a><span id="l20.1297"> </span>
<a href="#l20.1298"></a><span id="l20.1298">     // Disable the &quot;New Folder&quot; button if we cannot create a new folder</span>
<a href="#l20.1299"></a><span id="l20.1299">     this._element(&quot;newFolderButton&quot;)</span>
<a href="#l20.1300"></a><span id="l20.1300">         .disabled = !this._folderTree.insertionPoint || !selectedNode;</span>
<a href="#l20.1301"></a><span id="l20.1301"> </span>
<a href="#l20.1302"></a><span id="l20.1302">     if (!selectedNode)</span>
<a href="#l20.1303"></a><span id="l20.1303">       return;</span>
<a href="#l20.1304"></a><span id="l20.1304"> </span>
<a href="#l20.1305"></a><span id="l20.1305">     var folderId = PlacesUtils.getConcreteItemId(selectedNode);</span>
<a href="#l20.1306"></a><span id="l20.1306" class="difflineminus">-    if (this._getFolderIdFromMenuList() == folderId)</span>
<a href="#l20.1307"></a><span id="l20.1307" class="difflineplus">+    if (this._folderMenuList.selectedItem.folderId == folderId)</span>
<a href="#l20.1308"></a><span id="l20.1308">       return;</span>
<a href="#l20.1309"></a><span id="l20.1309"> </span>
<a href="#l20.1310"></a><span id="l20.1310" class="difflineminus">-    var folderItem = this._getFolderMenuItem(folderId);</span>
<a href="#l20.1311"></a><span id="l20.1311" class="difflineplus">+    var folderItem = this._getFolderMenuItem(folderId, selectedNode.title);</span>
<a href="#l20.1312"></a><span id="l20.1312">     this._folderMenuList.selectedItem = folderItem;</span>
<a href="#l20.1313"></a><span id="l20.1313">     folderItem.doCommand();</span>
<a href="#l20.1314"></a><span id="l20.1314">   },</span>
<a href="#l20.1315"></a><span id="l20.1315"> </span>
<a href="#l20.1316"></a><span id="l20.1316" class="difflineminus">-  _markFolderAsRecentlyUsed:</span>
<a href="#l20.1317"></a><span id="l20.1317" class="difflineminus">-  function EIO__markFolderAsRecentlyUsed(aFolderId) {</span>
<a href="#l20.1318"></a><span id="l20.1318" class="difflineminus">-    var txns = [];</span>
<a href="#l20.1319"></a><span id="l20.1319" class="difflineplus">+  async _markFolderAsRecentlyUsed(aFolderId) {</span>
<a href="#l20.1320"></a><span id="l20.1320" class="difflineplus">+    if (!PlacesUIUtils.useAsyncTransactions) {</span>
<a href="#l20.1321"></a><span id="l20.1321" class="difflineplus">+      let txns = [];</span>
<a href="#l20.1322"></a><span id="l20.1322" class="difflineplus">+</span>
<a href="#l20.1323"></a><span id="l20.1323" class="difflineplus">+      // Expire old unused recent folders.</span>
<a href="#l20.1324"></a><span id="l20.1324" class="difflineplus">+      let annotation = this._getLastUsedAnnotationObject(false);</span>
<a href="#l20.1325"></a><span id="l20.1325" class="difflineplus">+      while (this._recentFolders.length &gt; MAX_FOLDER_ITEM_IN_MENU_LIST) {</span>
<a href="#l20.1326"></a><span id="l20.1326" class="difflineplus">+        let folderId = this._recentFolders.pop().folderId;</span>
<a href="#l20.1327"></a><span id="l20.1327" class="difflineplus">+        let annoTxn = new PlacesSetItemAnnotationTransaction(folderId,</span>
<a href="#l20.1328"></a><span id="l20.1328" class="difflineplus">+                                                             annotation);</span>
<a href="#l20.1329"></a><span id="l20.1329" class="difflineplus">+        txns.push(annoTxn);</span>
<a href="#l20.1330"></a><span id="l20.1330" class="difflineplus">+      }</span>
<a href="#l20.1331"></a><span id="l20.1331"> </span>
<a href="#l20.1332"></a><span id="l20.1332" class="difflineminus">-    // Expire old unused recent folders</span>
<a href="#l20.1333"></a><span id="l20.1333" class="difflineminus">-    var anno = this._getLastUsedAnnotationObject(false);</span>
<a href="#l20.1334"></a><span id="l20.1334" class="difflineplus">+      // Mark folder as recently used</span>
<a href="#l20.1335"></a><span id="l20.1335" class="difflineplus">+      annotation = this._getLastUsedAnnotationObject(true);</span>
<a href="#l20.1336"></a><span id="l20.1336" class="difflineplus">+      let annoTxn = new PlacesSetItemAnnotationTransaction(aFolderId,</span>
<a href="#l20.1337"></a><span id="l20.1337" class="difflineplus">+                                                           annotation);</span>
<a href="#l20.1338"></a><span id="l20.1338" class="difflineplus">+      txns.push(annoTxn);</span>
<a href="#l20.1339"></a><span id="l20.1339" class="difflineplus">+</span>
<a href="#l20.1340"></a><span id="l20.1340" class="difflineplus">+      let aggregate =</span>
<a href="#l20.1341"></a><span id="l20.1341" class="difflineplus">+        new PlacesAggregatedTransaction(&quot;Update last used folders&quot;, txns);</span>
<a href="#l20.1342"></a><span id="l20.1342" class="difflineplus">+      PlacesUtils.transactionManager.doTransaction(aggregate);</span>
<a href="#l20.1343"></a><span id="l20.1343" class="difflineplus">+      return;</span>
<a href="#l20.1344"></a><span id="l20.1344" class="difflineplus">+    }</span>
<a href="#l20.1345"></a><span id="l20.1345" class="difflineplus">+</span>
<a href="#l20.1346"></a><span id="l20.1346" class="difflineplus">+    // Expire old unused recent folders.</span>
<a href="#l20.1347"></a><span id="l20.1347" class="difflineplus">+    let guids = [];</span>
<a href="#l20.1348"></a><span id="l20.1348">     while (this._recentFolders.length &gt; MAX_FOLDER_ITEM_IN_MENU_LIST) {</span>
<a href="#l20.1349"></a><span id="l20.1349" class="difflineminus">-      var folderId = this._recentFolders.pop().folderId;</span>
<a href="#l20.1350"></a><span id="l20.1350" class="difflineminus">-      let annoTxn = new PlacesSetItemAnnotationTransaction(folderId, anno);</span>
<a href="#l20.1351"></a><span id="l20.1351" class="difflineminus">-      txns.push(annoTxn);</span>
<a href="#l20.1352"></a><span id="l20.1352" class="difflineplus">+      let folderId = this._recentFolders.pop().folderId;</span>
<a href="#l20.1353"></a><span id="l20.1353" class="difflineplus">+      let guid = await PlacesUtils.promiseItemGuid(folderId);</span>
<a href="#l20.1354"></a><span id="l20.1354" class="difflineplus">+      guids.push(guid);</span>
<a href="#l20.1355"></a><span id="l20.1355" class="difflineplus">+    }</span>
<a href="#l20.1356"></a><span id="l20.1356" class="difflineplus">+    if (guids.length &gt; 0) {</span>
<a href="#l20.1357"></a><span id="l20.1357" class="difflineplus">+      let annotation = this._getLastUsedAnnotationObject(false);</span>
<a href="#l20.1358"></a><span id="l20.1358" class="difflineplus">+      PlacesTransactions.Annotate({ guids, annotation  })</span>
<a href="#l20.1359"></a><span id="l20.1359" class="difflineplus">+                        .transact().catch(Cu.reportError);</span>
<a href="#l20.1360"></a><span id="l20.1360">     }</span>
<a href="#l20.1361"></a><span id="l20.1361"> </span>
<a href="#l20.1362"></a><span id="l20.1362">     // Mark folder as recently used</span>
<a href="#l20.1363"></a><span id="l20.1363" class="difflineminus">-    anno = this._getLastUsedAnnotationObject(true);</span>
<a href="#l20.1364"></a><span id="l20.1364" class="difflineminus">-    let annoTxn = new PlacesSetItemAnnotationTransaction(aFolderId, anno);</span>
<a href="#l20.1365"></a><span id="l20.1365" class="difflineminus">-    txns.push(annoTxn);</span>
<a href="#l20.1366"></a><span id="l20.1366" class="difflineminus">-</span>
<a href="#l20.1367"></a><span id="l20.1367" class="difflineminus">-    let aggregate = new PlacesAggregatedTransaction(&quot;Update last used folders&quot;, txns);</span>
<a href="#l20.1368"></a><span id="l20.1368" class="difflineminus">-    PlacesUtils.transactionManager.doTransaction(aggregate);</span>
<a href="#l20.1369"></a><span id="l20.1369" class="difflineplus">+    let annotation = this._getLastUsedAnnotationObject(true);</span>
<a href="#l20.1370"></a><span id="l20.1370" class="difflineplus">+    let guid = await PlacesUtils.promiseItemGuid(aFolderId);</span>
<a href="#l20.1371"></a><span id="l20.1371" class="difflineplus">+    PlacesTransactions.Annotate({ guid, annotation })</span>
<a href="#l20.1372"></a><span id="l20.1372" class="difflineplus">+                      .transact().catch(Cu.reportError);</span>
<a href="#l20.1373"></a><span id="l20.1373">   },</span>
<a href="#l20.1374"></a><span id="l20.1374"> </span>
<a href="#l20.1375"></a><span id="l20.1375">   /**</span>
<a href="#l20.1376"></a><span id="l20.1376">    * Returns an object which could then be used to set/unset the</span>
<a href="#l20.1377"></a><span id="l20.1377">    * LAST_USED_ANNO annotation for a folder.</span>
<a href="#l20.1378"></a><span id="l20.1378">    *</span>
<a href="#l20.1379"></a><span id="l20.1379">    * @param aLastUsed</span>
<a href="#l20.1380"></a><span id="l20.1380">    *        Whether to set or unset the LAST_USED_ANNO annotation.</span>
<a href="#l20.1381"></a><span id="l20.1381">    * @returns an object representing the annotation which could then be used</span>
<a href="#l20.1382"></a><span id="l20.1382">    *          with the transaction manager.</span>
<a href="#l20.1383"></a><span id="l20.1383">    */</span>
<a href="#l20.1384"></a><span id="l20.1384" class="difflineminus">-  _getLastUsedAnnotationObject:</span>
<a href="#l20.1385"></a><span id="l20.1385" class="difflineminus">-  function EIO__getLastUsedAnnotationObject(aLastUsed) {</span>
<a href="#l20.1386"></a><span id="l20.1386" class="difflineminus">-    var anno = { name: LAST_USED_ANNO,</span>
<a href="#l20.1387"></a><span id="l20.1387" class="difflineminus">-                 type: Ci.nsIAnnotationService.TYPE_INT32,</span>
<a href="#l20.1388"></a><span id="l20.1388" class="difflineminus">-                 flags: 0,</span>
<a href="#l20.1389"></a><span id="l20.1389" class="difflineminus">-                 value: aLastUsed ? new Date().getTime() : null,</span>
<a href="#l20.1390"></a><span id="l20.1390" class="difflineminus">-                 expires: Ci.nsIAnnotationService.EXPIRE_NEVER };</span>
<a href="#l20.1391"></a><span id="l20.1391" class="difflineminus">-</span>
<a href="#l20.1392"></a><span id="l20.1392" class="difflineminus">-    return anno;</span>
<a href="#l20.1393"></a><span id="l20.1393" class="difflineplus">+  _getLastUsedAnnotationObject(aLastUsed) {</span>
<a href="#l20.1394"></a><span id="l20.1394" class="difflineplus">+    return { name: LAST_USED_ANNO,</span>
<a href="#l20.1395"></a><span id="l20.1395" class="difflineplus">+             value: aLastUsed ? new Date().getTime() : null };</span>
<a href="#l20.1396"></a><span id="l20.1396">   },</span>
<a href="#l20.1397"></a><span id="l20.1397"> </span>
<a href="#l20.1398"></a><span id="l20.1398" class="difflineminus">-  _rebuildTagsSelectorList: function EIO__rebuildTagsSelectorList() {</span>
<a href="#l20.1399"></a><span id="l20.1399" class="difflineminus">-    var tagsSelector = this._element(&quot;tagsSelector&quot;);</span>
<a href="#l20.1400"></a><span id="l20.1400" class="difflineminus">-    var tagsSelectorRow = this._element(&quot;tagsSelectorRow&quot;);</span>
<a href="#l20.1401"></a><span id="l20.1401" class="difflineplus">+  _rebuildTagsSelectorList() {</span>
<a href="#l20.1402"></a><span id="l20.1402" class="difflineplus">+    let tagsSelector = this._element(&quot;tagsSelector&quot;);</span>
<a href="#l20.1403"></a><span id="l20.1403" class="difflineplus">+    let tagsSelectorRow = this._element(&quot;tagsSelectorRow&quot;);</span>
<a href="#l20.1404"></a><span id="l20.1404">     if (tagsSelectorRow.collapsed)</span>
<a href="#l20.1405"></a><span id="l20.1405">       return;</span>
<a href="#l20.1406"></a><span id="l20.1406"> </span>
<a href="#l20.1407"></a><span id="l20.1407" class="difflineminus">-    while (tagsSelector.hasChildNodes())</span>
<a href="#l20.1408"></a><span id="l20.1408" class="difflineminus">-      tagsSelector.lastChild.remove();</span>
<a href="#l20.1409"></a><span id="l20.1409" class="difflineplus">+    // Save the current scroll position and restore it after the rebuild.</span>
<a href="#l20.1410"></a><span id="l20.1410" class="difflineplus">+    let firstIndex = tagsSelector.getIndexOfFirstVisibleRow();</span>
<a href="#l20.1411"></a><span id="l20.1411" class="difflineplus">+    let selectedIndex = tagsSelector.selectedIndex;</span>
<a href="#l20.1412"></a><span id="l20.1412" class="difflineplus">+    let selectedTag = selectedIndex &gt;= 0 ? tagsSelector.selectedItem.label</span>
<a href="#l20.1413"></a><span id="l20.1413" class="difflineplus">+                                         : null;</span>
<a href="#l20.1414"></a><span id="l20.1414"> </span>
<a href="#l20.1415"></a><span id="l20.1415" class="difflineminus">-    var tagsInField = this._getTagsArrayFromTagField();</span>
<a href="#l20.1416"></a><span id="l20.1416" class="difflineminus">-    var allTags = PlacesUtils.tagging.allTags;</span>
<a href="#l20.1417"></a><span id="l20.1417" class="difflineminus">-    for (var i = 0; i &lt; allTags.length; i++) {</span>
<a href="#l20.1418"></a><span id="l20.1418" class="difflineminus">-      var tag = allTags[i];</span>
<a href="#l20.1419"></a><span id="l20.1419" class="difflineminus">-      var elt = document.createElement(&quot;listitem&quot;);</span>
<a href="#l20.1420"></a><span id="l20.1420" class="difflineplus">+    while (tagsSelector.hasChildNodes()) {</span>
<a href="#l20.1421"></a><span id="l20.1421" class="difflineplus">+      tagsSelector.removeChild(tagsSelector.lastChild);</span>
<a href="#l20.1422"></a><span id="l20.1422" class="difflineplus">+    }</span>
<a href="#l20.1423"></a><span id="l20.1423" class="difflineplus">+</span>
<a href="#l20.1424"></a><span id="l20.1424" class="difflineplus">+    let tagsInField = this._getTagsArrayFromTagsInputField();</span>
<a href="#l20.1425"></a><span id="l20.1425" class="difflineplus">+    let allTags = PlacesUtils.tagging.allTags;</span>
<a href="#l20.1426"></a><span id="l20.1426" class="difflineplus">+    for (let tag of allTags) {</span>
<a href="#l20.1427"></a><span id="l20.1427" class="difflineplus">+      let elt = document.createElement(&quot;listitem&quot;);</span>
<a href="#l20.1428"></a><span id="l20.1428">       elt.setAttribute(&quot;type&quot;, &quot;checkbox&quot;);</span>
<a href="#l20.1429"></a><span id="l20.1429">       elt.setAttribute(&quot;label&quot;, tag);</span>
<a href="#l20.1430"></a><span id="l20.1430" class="difflineminus">-      if (tagsInField.indexOf(tag) != -1)</span>
<a href="#l20.1431"></a><span id="l20.1431" class="difflineplus">+      if (tagsInField.includes(tag))</span>
<a href="#l20.1432"></a><span id="l20.1432">         elt.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l20.1433"></a><span id="l20.1433" class="difflineplus">+      tagsSelector.appendChild(elt);</span>
<a href="#l20.1434"></a><span id="l20.1434" class="difflineplus">+      if (selectedTag === tag)</span>
<a href="#l20.1435"></a><span id="l20.1435" class="difflineplus">+        selectedIndex = tagsSelector.getIndexOfItem(elt);</span>
<a href="#l20.1436"></a><span id="l20.1436" class="difflineplus">+    }</span>
<a href="#l20.1437"></a><span id="l20.1437"> </span>
<a href="#l20.1438"></a><span id="l20.1438" class="difflineminus">-      tagsSelector.appendChild(elt);</span>
<a href="#l20.1439"></a><span id="l20.1439" class="difflineplus">+    // Restore position.</span>
<a href="#l20.1440"></a><span id="l20.1440" class="difflineplus">+    // The listbox allows to scroll only if the required offset doesn't</span>
<a href="#l20.1441"></a><span id="l20.1441" class="difflineplus">+    // overflow its capacity, thus need to adjust the index for removals.</span>
<a href="#l20.1442"></a><span id="l20.1442" class="difflineplus">+    firstIndex =</span>
<a href="#l20.1443"></a><span id="l20.1443" class="difflineplus">+      Math.min(firstIndex,</span>
<a href="#l20.1444"></a><span id="l20.1444" class="difflineplus">+               tagsSelector.itemCount - tagsSelector.getNumberOfVisibleRows());</span>
<a href="#l20.1445"></a><span id="l20.1445" class="difflineplus">+    tagsSelector.scrollToIndex(firstIndex);</span>
<a href="#l20.1446"></a><span id="l20.1446" class="difflineplus">+    if (selectedIndex &gt;= 0 &amp;&amp; tagsSelector.itemCount &gt; 0) {</span>
<a href="#l20.1447"></a><span id="l20.1447" class="difflineplus">+      selectedIndex = Math.min(selectedIndex, tagsSelector.itemCount - 1);</span>
<a href="#l20.1448"></a><span id="l20.1448" class="difflineplus">+      tagsSelector.selectedIndex = selectedIndex;</span>
<a href="#l20.1449"></a><span id="l20.1449" class="difflineplus">+      tagsSelector.ensureIndexIsVisible(selectedIndex);</span>
<a href="#l20.1450"></a><span id="l20.1450">     }</span>
<a href="#l20.1451"></a><span id="l20.1451">   },</span>
<a href="#l20.1452"></a><span id="l20.1452"> </span>
<a href="#l20.1453"></a><span id="l20.1453" class="difflineminus">-  toggleTagsSelector: function EIO_toggleTagsSelector() {</span>
<a href="#l20.1454"></a><span id="l20.1454" class="difflineplus">+  toggleTagsSelector() {</span>
<a href="#l20.1455"></a><span id="l20.1455">     var tagsSelector = this._element(&quot;tagsSelector&quot;);</span>
<a href="#l20.1456"></a><span id="l20.1456">     var tagsSelectorRow = this._element(&quot;tagsSelectorRow&quot;);</span>
<a href="#l20.1457"></a><span id="l20.1457">     var expander = this._element(&quot;tagsSelectorExpander&quot;);</span>
<a href="#l20.1458"></a><span id="l20.1458">     if (tagsSelectorRow.collapsed) {</span>
<a href="#l20.1459"></a><span id="l20.1459">       expander.className = &quot;expander-up&quot;;</span>
<a href="#l20.1460"></a><span id="l20.1460">       expander.setAttribute(&quot;tooltiptext&quot;,</span>
<a href="#l20.1461"></a><span id="l20.1461">                             expander.getAttribute(&quot;tooltiptextup&quot;));</span>
<a href="#l20.1462"></a><span id="l20.1462">       tagsSelectorRow.collapsed = false;</span>
<a href="#l20.1463"></a><span id="l20.1463">       this._rebuildTagsSelectorList();</span>
<a href="#l20.1464"></a><span id="l20.1464"> </span>
<a href="#l20.1465"></a><span id="l20.1465">       // This is a no-op if we've added the listener.</span>
<a href="#l20.1466"></a><span id="l20.1466">       tagsSelector.addEventListener(&quot;CheckboxStateChange&quot;, this);</span>
<a href="#l20.1467"></a><span id="l20.1467" class="difflineminus">-    }</span>
<a href="#l20.1468"></a><span id="l20.1468" class="difflineminus">-    else {</span>
<a href="#l20.1469"></a><span id="l20.1469" class="difflineplus">+    } else {</span>
<a href="#l20.1470"></a><span id="l20.1470">       expander.className = &quot;expander-down&quot;;</span>
<a href="#l20.1471"></a><span id="l20.1471">       expander.setAttribute(&quot;tooltiptext&quot;,</span>
<a href="#l20.1472"></a><span id="l20.1472">                             expander.getAttribute(&quot;tooltiptextdown&quot;));</span>
<a href="#l20.1473"></a><span id="l20.1473">       tagsSelectorRow.collapsed = true;</span>
<a href="#l20.1474"></a><span id="l20.1474">     }</span>
<a href="#l20.1475"></a><span id="l20.1475">   },</span>
<a href="#l20.1476"></a><span id="l20.1476"> </span>
<a href="#l20.1477"></a><span id="l20.1477">   /**</span>
<a href="#l20.1478"></a><span id="l20.1478">    * Splits &quot;tagsField&quot; element value, returning an array of valid tag strings.</span>
<a href="#l20.1479"></a><span id="l20.1479">    *</span>
<a href="#l20.1480"></a><span id="l20.1480">    * @return Array of tag strings found in the field value.</span>
<a href="#l20.1481"></a><span id="l20.1481">    */</span>
<a href="#l20.1482"></a><span id="l20.1482" class="difflineminus">-  _getTagsArrayFromTagField: function EIO__getTagsArrayFromTagField() {</span>
<a href="#l20.1483"></a><span id="l20.1483" class="difflineplus">+  _getTagsArrayFromTagsInputField() {</span>
<a href="#l20.1484"></a><span id="l20.1484">     let tags = this._element(&quot;tagsField&quot;).value;</span>
<a href="#l20.1485"></a><span id="l20.1485">     return tags.trim()</span>
<a href="#l20.1486"></a><span id="l20.1486">                .split(/\s*,\s*/) // Split on commas and remove spaces.</span>
<a href="#l20.1487"></a><span id="l20.1487">                .filter(tag =&gt; tag.length &gt; 0); // Kill empty tags.</span>
<a href="#l20.1488"></a><span id="l20.1488">   },</span>
<a href="#l20.1489"></a><span id="l20.1489"> </span>
<a href="#l20.1490"></a><span id="l20.1490" class="difflineminus">-  newFolder: function EIO_newFolder() {</span>
<a href="#l20.1491"></a><span id="l20.1491" class="difflineminus">-    var ip = this._folderTree.insertionPoint;</span>
<a href="#l20.1492"></a><span id="l20.1492" class="difflineplus">+  async newFolder() {</span>
<a href="#l20.1493"></a><span id="l20.1493" class="difflineplus">+    let ip = this._folderTree.insertionPoint;</span>
<a href="#l20.1494"></a><span id="l20.1494"> </span>
<a href="#l20.1495"></a><span id="l20.1495">     // default to the bookmarks menu folder</span>
<a href="#l20.1496"></a><span id="l20.1496">     if (!ip || ip.itemId == PlacesUIUtils.allBookmarksFolderId) {</span>
<a href="#l20.1497"></a><span id="l20.1497" class="difflineminus">-        ip = new InsertionPoint(PlacesUtils.bookmarksMenuFolderId,</span>
<a href="#l20.1498"></a><span id="l20.1498" class="difflineminus">-                                PlacesUtils.bookmarks.DEFAULT_INDEX,</span>
<a href="#l20.1499"></a><span id="l20.1499" class="difflineminus">-                                Ci.nsITreeView.DROP_ON);</span>
<a href="#l20.1500"></a><span id="l20.1500" class="difflineplus">+      ip = new InsertionPoint(PlacesUtils.bookmarksMenuFolderId,</span>
<a href="#l20.1501"></a><span id="l20.1501" class="difflineplus">+                              PlacesUtils.bookmarks.DEFAULT_INDEX,</span>
<a href="#l20.1502"></a><span id="l20.1502" class="difflineplus">+                              Ci.nsITreeView.DROP_ON);</span>
<a href="#l20.1503"></a><span id="l20.1503">     }</span>
<a href="#l20.1504"></a><span id="l20.1504"> </span>
<a href="#l20.1505"></a><span id="l20.1505">     // XXXmano: add a separate &quot;New Folder&quot; string at some point...</span>
<a href="#l20.1506"></a><span id="l20.1506" class="difflineminus">-    var defaultLabel = this._element(&quot;newFolderButton&quot;).label;</span>
<a href="#l20.1507"></a><span id="l20.1507" class="difflineminus">-    var txn = new PlacesCreateFolderTransaction(defaultLabel, ip.itemId, ip.index);</span>
<a href="#l20.1508"></a><span id="l20.1508" class="difflineminus">-    PlacesUtils.transactionManager.doTransaction(txn);</span>
<a href="#l20.1509"></a><span id="l20.1509" class="difflineplus">+    let title = this._element(&quot;newFolderButton&quot;).label;</span>
<a href="#l20.1510"></a><span id="l20.1510" class="difflineplus">+    if (PlacesUIUtils.useAsyncTransactions) {</span>
<a href="#l20.1511"></a><span id="l20.1511" class="difflineplus">+      let parentGuid = await ip.promiseGuid();</span>
<a href="#l20.1512"></a><span id="l20.1512" class="difflineplus">+      await PlacesTransactions.NewFolder({ parentGuid, title, index: ip.index })</span>
<a href="#l20.1513"></a><span id="l20.1513" class="difflineplus">+                              .transact().catch(Cu.reportError);</span>
<a href="#l20.1514"></a><span id="l20.1514" class="difflineplus">+    } else {</span>
<a href="#l20.1515"></a><span id="l20.1515" class="difflineplus">+      let txn = new PlacesCreateFolderTransaction(title, ip.itemId, ip.index);</span>
<a href="#l20.1516"></a><span id="l20.1516" class="difflineplus">+      PlacesUtils.transactionManager.doTransaction(txn);</span>
<a href="#l20.1517"></a><span id="l20.1517" class="difflineplus">+    }</span>
<a href="#l20.1518"></a><span id="l20.1518" class="difflineplus">+</span>
<a href="#l20.1519"></a><span id="l20.1519">     this._folderTree.focus();</span>
<a href="#l20.1520"></a><span id="l20.1520" class="difflineplus">+    this._folderTree.selectItems([ip.itemId]);</span>
<a href="#l20.1521"></a><span id="l20.1521" class="difflineplus">+    PlacesUtils.asContainer(this._folderTree.selectedNode).containerOpen = true;</span>
<a href="#l20.1522"></a><span id="l20.1522">     this._folderTree.selectItems([this._lastNewItem]);</span>
<a href="#l20.1523"></a><span id="l20.1523">     this._folderTree.startEditing(this._folderTree.view.selection.currentIndex,</span>
<a href="#l20.1524"></a><span id="l20.1524">                                   this._folderTree.columns.getFirstColumn());</span>
<a href="#l20.1525"></a><span id="l20.1525">   },</span>
<a href="#l20.1526"></a><span id="l20.1526"> </span>
<a href="#l20.1527"></a><span id="l20.1527">   // nsIDOMEventListener</span>
<a href="#l20.1528"></a><span id="l20.1528" class="difflineminus">-  handleEvent: function EIO_nsIDOMEventListener(aEvent) {</span>
<a href="#l20.1529"></a><span id="l20.1529" class="difflineplus">+  handleEvent(aEvent) {</span>
<a href="#l20.1530"></a><span id="l20.1530">     switch (aEvent.type) {</span>
<a href="#l20.1531"></a><span id="l20.1531">     case &quot;CheckboxStateChange&quot;:</span>
<a href="#l20.1532"></a><span id="l20.1532">       // Update the tags field when items are checked/unchecked in the listbox</span>
<a href="#l20.1533"></a><span id="l20.1533" class="difflineminus">-      var tags = this._getTagsArrayFromTagField();</span>
<a href="#l20.1534"></a><span id="l20.1534" class="difflineplus">+      let tags = this._getTagsArrayFromTagsInputField();</span>
<a href="#l20.1535"></a><span id="l20.1535" class="difflineplus">+      let tagCheckbox = aEvent.target;</span>
<a href="#l20.1536"></a><span id="l20.1536"> </span>
<a href="#l20.1537"></a><span id="l20.1537" class="difflineminus">-      if (aEvent.target.checked) {</span>
<a href="#l20.1538"></a><span id="l20.1538" class="difflineminus">-        if (tags.indexOf(aEvent.target.label) == -1)</span>
<a href="#l20.1539"></a><span id="l20.1539" class="difflineminus">-          tags.push(aEvent.target.label);</span>
<a href="#l20.1540"></a><span id="l20.1540" class="difflineminus">-      }</span>
<a href="#l20.1541"></a><span id="l20.1541" class="difflineminus">-      else {</span>
<a href="#l20.1542"></a><span id="l20.1542" class="difflineminus">-        var indexOfItem = tags.indexOf(aEvent.target.label);</span>
<a href="#l20.1543"></a><span id="l20.1543" class="difflineminus">-        if (indexOfItem != -1)</span>
<a href="#l20.1544"></a><span id="l20.1544" class="difflineminus">-          tags.splice(indexOfItem, 1);</span>
<a href="#l20.1545"></a><span id="l20.1545" class="difflineplus">+      let curTagIndex = tags.indexOf(tagCheckbox.label);</span>
<a href="#l20.1546"></a><span id="l20.1546" class="difflineplus">+      let tagsSelector = this._element(&quot;tagsSelector&quot;);</span>
<a href="#l20.1547"></a><span id="l20.1547" class="difflineplus">+      tagsSelector.selectedItem = tagCheckbox;</span>
<a href="#l20.1548"></a><span id="l20.1548" class="difflineplus">+</span>
<a href="#l20.1549"></a><span id="l20.1549" class="difflineplus">+      if (tagCheckbox.checked) {</span>
<a href="#l20.1550"></a><span id="l20.1550" class="difflineplus">+        if (curTagIndex == -1)</span>
<a href="#l20.1551"></a><span id="l20.1551" class="difflineplus">+          tags.push(tagCheckbox.label);</span>
<a href="#l20.1552"></a><span id="l20.1552" class="difflineplus">+      } else if (curTagIndex != -1) {</span>
<a href="#l20.1553"></a><span id="l20.1553" class="difflineplus">+        tags.splice(curTagIndex, 1);</span>
<a href="#l20.1554"></a><span id="l20.1554">       }</span>
<a href="#l20.1555"></a><span id="l20.1555">       this._element(&quot;tagsField&quot;).value = tags.join(&quot;, &quot;);</span>
<a href="#l20.1556"></a><span id="l20.1556">       this._updateTags();</span>
<a href="#l20.1557"></a><span id="l20.1557">       break;</span>
<a href="#l20.1558"></a><span id="l20.1558">     case &quot;unload&quot;:</span>
<a href="#l20.1559"></a><span id="l20.1559">       this.uninitPanel(false);</span>
<a href="#l20.1560"></a><span id="l20.1560">       break;</span>
<a href="#l20.1561"></a><span id="l20.1561">     }</span>
<a href="#l20.1562"></a><span id="l20.1562">   },</span>
<a href="#l20.1563"></a><span id="l20.1563"> </span>
<a href="#l20.1564"></a><span id="l20.1564" class="difflineminus">-  // nsINavBookmarkObserver</span>
<a href="#l20.1565"></a><span id="l20.1565" class="difflineminus">-  onItemChanged: function EIO_onItemChanged(aItemId, aProperty,</span>
<a href="#l20.1566"></a><span id="l20.1566" class="difflineminus">-                                            aIsAnnotationProperty, aValue,</span>
<a href="#l20.1567"></a><span id="l20.1567" class="difflineminus">-                                            aLastModified, aItemType) {</span>
<a href="#l20.1568"></a><span id="l20.1568" class="difflineminus">-    if (aProperty == &quot;tags&quot;) {</span>
<a href="#l20.1569"></a><span id="l20.1569" class="difflineminus">-      // Tags case is special, since they should be updated if either:</span>
<a href="#l20.1570"></a><span id="l20.1570" class="difflineminus">-      // - the notification is for the edited bookmark</span>
<a href="#l20.1571"></a><span id="l20.1571" class="difflineminus">-      // - the notification is for the edited history entry</span>
<a href="#l20.1572"></a><span id="l20.1572" class="difflineminus">-      // - the notification is for one of edited uris</span>
<a href="#l20.1573"></a><span id="l20.1573" class="difflineminus">-      let shouldUpdateTagsField = this._itemId == aItemId;</span>
<a href="#l20.1574"></a><span id="l20.1574" class="difflineminus">-      if (this._itemId == -1 || this._multiEdit) {</span>
<a href="#l20.1575"></a><span id="l20.1575" class="difflineminus">-        // Check if the changed uri is part of the modified ones.</span>
<a href="#l20.1576"></a><span id="l20.1576" class="difflineminus">-        let changedURI = PlacesUtils.bookmarks.getBookmarkURI(aItemId);</span>
<a href="#l20.1577"></a><span id="l20.1577" class="difflineminus">-        let uris = this._multiEdit ? this._uris : [this._uri];</span>
<a href="#l20.1578"></a><span id="l20.1578" class="difflineminus">-        uris.forEach(function (aURI, aIndex) {</span>
<a href="#l20.1579"></a><span id="l20.1579" class="difflineminus">-          if (aURI.equals(changedURI)) {</span>
<a href="#l20.1580"></a><span id="l20.1580" class="difflineminus">-            shouldUpdateTagsField = true;</span>
<a href="#l20.1581"></a><span id="l20.1581" class="difflineminus">-            if (this._multiEdit) {</span>
<a href="#l20.1582"></a><span id="l20.1582" class="difflineminus">-              this._tags[aIndex] = PlacesUtils.tagging.getTagsForURI(this._uris[aIndex]);</span>
<a href="#l20.1583"></a><span id="l20.1583" class="difflineminus">-            }</span>
<a href="#l20.1584"></a><span id="l20.1584" class="difflineminus">-          }</span>
<a href="#l20.1585"></a><span id="l20.1585" class="difflineminus">-        }, this);</span>
<a href="#l20.1586"></a><span id="l20.1586" class="difflineplus">+  _initTagsField() {</span>
<a href="#l20.1587"></a><span id="l20.1587" class="difflineplus">+    let tags;</span>
<a href="#l20.1588"></a><span id="l20.1588" class="difflineplus">+    if (this._paneInfo.isURI)</span>
<a href="#l20.1589"></a><span id="l20.1589" class="difflineplus">+      tags = PlacesUtils.tagging.getTagsForURI(this._paneInfo.uri);</span>
<a href="#l20.1590"></a><span id="l20.1590" class="difflineplus">+    else if (this._paneInfo.bulkTagging)</span>
<a href="#l20.1591"></a><span id="l20.1591" class="difflineplus">+      tags = this._getCommonTags();</span>
<a href="#l20.1592"></a><span id="l20.1592" class="difflineplus">+    else</span>
<a href="#l20.1593"></a><span id="l20.1593" class="difflineplus">+      throw new Error(&quot;_promiseTagsStr called unexpectedly&quot;);</span>
<a href="#l20.1594"></a><span id="l20.1594" class="difflineplus">+</span>
<a href="#l20.1595"></a><span id="l20.1595" class="difflineplus">+    this._initTextField(this._tagsField, tags.join(&quot;, &quot;));</span>
<a href="#l20.1596"></a><span id="l20.1596" class="difflineplus">+  },</span>
<a href="#l20.1597"></a><span id="l20.1597" class="difflineplus">+</span>
<a href="#l20.1598"></a><span id="l20.1598" class="difflineplus">+  async _onTagsChange(guid, changedURI = null) {</span>
<a href="#l20.1599"></a><span id="l20.1599" class="difflineplus">+    let paneInfo = this._paneInfo;</span>
<a href="#l20.1600"></a><span id="l20.1600" class="difflineplus">+    let updateTagsField = false;</span>
<a href="#l20.1601"></a><span id="l20.1601" class="difflineplus">+    if (paneInfo.isURI) {</span>
<a href="#l20.1602"></a><span id="l20.1602" class="difflineplus">+      if (paneInfo.isBookmark &amp;&amp; guid == paneInfo.itemGuid) {</span>
<a href="#l20.1603"></a><span id="l20.1603" class="difflineplus">+        updateTagsField = true;</span>
<a href="#l20.1604"></a><span id="l20.1604" class="difflineplus">+      } else if (!paneInfo.isBookmark) {</span>
<a href="#l20.1605"></a><span id="l20.1605" class="difflineplus">+        if (!changedURI) {</span>
<a href="#l20.1606"></a><span id="l20.1606" class="difflineplus">+          let href = (await PlacesUtils.bookmarks.fetch(guid)).url.href;</span>
<a href="#l20.1607"></a><span id="l20.1607" class="difflineplus">+          changedURI = Services.io.newURI(href);</span>
<a href="#l20.1608"></a><span id="l20.1608" class="difflineplus">+        }</span>
<a href="#l20.1609"></a><span id="l20.1609" class="difflineplus">+        updateTagsField = changedURI.equals(paneInfo.uri);</span>
<a href="#l20.1610"></a><span id="l20.1610" class="difflineplus">+      }</span>
<a href="#l20.1611"></a><span id="l20.1611" class="difflineplus">+    } else if (paneInfo.bulkTagging) {</span>
<a href="#l20.1612"></a><span id="l20.1612" class="difflineplus">+      if (!changedURI) {</span>
<a href="#l20.1613"></a><span id="l20.1613" class="difflineplus">+        let href = (await PlacesUtils.bookmarks.fetch(guid)).url.href;</span>
<a href="#l20.1614"></a><span id="l20.1614" class="difflineplus">+        changedURI = Services.io.newURI(href);</span>
<a href="#l20.1615"></a><span id="l20.1615">       }</span>
<a href="#l20.1616"></a><span id="l20.1616" class="difflineplus">+      if (paneInfo.uris.some(uri =&gt; uri.equals(changedURI))) {</span>
<a href="#l20.1617"></a><span id="l20.1617" class="difflineplus">+        updateTagsField = true;</span>
<a href="#l20.1618"></a><span id="l20.1618" class="difflineplus">+        delete this._paneInfo._cachedCommonTags;</span>
<a href="#l20.1619"></a><span id="l20.1619" class="difflineplus">+      }</span>
<a href="#l20.1620"></a><span id="l20.1620" class="difflineplus">+    } else {</span>
<a href="#l20.1621"></a><span id="l20.1621" class="difflineplus">+      throw new Error(&quot;_onTagsChange called unexpectedly&quot;);</span>
<a href="#l20.1622"></a><span id="l20.1622" class="difflineplus">+    }</span>
<a href="#l20.1623"></a><span id="l20.1623"> </span>
<a href="#l20.1624"></a><span id="l20.1624" class="difflineminus">-      if (shouldUpdateTagsField) {</span>
<a href="#l20.1625"></a><span id="l20.1625" class="difflineminus">-        if (this._multiEdit) {</span>
<a href="#l20.1626"></a><span id="l20.1626" class="difflineminus">-          this._allTags = this._getCommonTags();</span>
<a href="#l20.1627"></a><span id="l20.1627" class="difflineminus">-          this._initTextField(&quot;tagsField&quot;, this._allTags.join(&quot;, &quot;), false);</span>
<a href="#l20.1628"></a><span id="l20.1628" class="difflineminus">-        }</span>
<a href="#l20.1629"></a><span id="l20.1629" class="difflineminus">-        else {</span>
<a href="#l20.1630"></a><span id="l20.1630" class="difflineminus">-          let tags = PlacesUtils.tagging.getTagsForURI(this._uri).join(&quot;, &quot;);</span>
<a href="#l20.1631"></a><span id="l20.1631" class="difflineminus">-          this._initTextField(&quot;tagsField&quot;, tags, false);</span>
<a href="#l20.1632"></a><span id="l20.1632" class="difflineplus">+    if (updateTagsField) {</span>
<a href="#l20.1633"></a><span id="l20.1633" class="difflineplus">+      this._initTagsField();</span>
<a href="#l20.1634"></a><span id="l20.1634" class="difflineplus">+      // Any tags change should be reflected in the tags selector.</span>
<a href="#l20.1635"></a><span id="l20.1635" class="difflineplus">+      if (this._element(&quot;tagsSelector&quot;)) {</span>
<a href="#l20.1636"></a><span id="l20.1636" class="difflineplus">+        this._rebuildTagsSelectorList();</span>
<a href="#l20.1637"></a><span id="l20.1637" class="difflineplus">+      }</span>
<a href="#l20.1638"></a><span id="l20.1638" class="difflineplus">+    }</span>
<a href="#l20.1639"></a><span id="l20.1639" class="difflineplus">+  },</span>
<a href="#l20.1640"></a><span id="l20.1640" class="difflineplus">+</span>
<a href="#l20.1641"></a><span id="l20.1641" class="difflineplus">+  _onItemTitleChange(aItemId, aNewTitle) {</span>
<a href="#l20.1642"></a><span id="l20.1642" class="difflineplus">+    if (!this._paneInfo.isBookmark)</span>
<a href="#l20.1643"></a><span id="l20.1643" class="difflineplus">+      return;</span>
<a href="#l20.1644"></a><span id="l20.1644" class="difflineplus">+    if (aItemId == this._paneInfo.itemId) {</span>
<a href="#l20.1645"></a><span id="l20.1645" class="difflineplus">+      this._paneInfo.title = aNewTitle;</span>
<a href="#l20.1646"></a><span id="l20.1646" class="difflineplus">+      this._initTextField(this._namePicker, aNewTitle);</span>
<a href="#l20.1647"></a><span id="l20.1647" class="difflineplus">+    } else if (this._paneInfo.visibleRows.has(&quot;folderRow&quot;)) {</span>
<a href="#l20.1648"></a><span id="l20.1648" class="difflineplus">+      // If the title of a folder which is listed within the folders</span>
<a href="#l20.1649"></a><span id="l20.1649" class="difflineplus">+      // menulist has been changed, we need to update the label of its</span>
<a href="#l20.1650"></a><span id="l20.1650" class="difflineplus">+      // representing element.</span>
<a href="#l20.1651"></a><span id="l20.1651" class="difflineplus">+      let menupopup = this._folderMenuList.menupopup;</span>
<a href="#l20.1652"></a><span id="l20.1652" class="difflineplus">+      for (let menuitem of menupopup.childNodes) {</span>
<a href="#l20.1653"></a><span id="l20.1653" class="difflineplus">+        if (&quot;folderId&quot; in menuitem &amp;&amp; menuitem.folderId == aItemId) {</span>
<a href="#l20.1654"></a><span id="l20.1654" class="difflineplus">+          menuitem.label = aNewTitle;</span>
<a href="#l20.1655"></a><span id="l20.1655" class="difflineplus">+          break;</span>
<a href="#l20.1656"></a><span id="l20.1656">         }</span>
<a href="#l20.1657"></a><span id="l20.1657">       }</span>
<a href="#l20.1658"></a><span id="l20.1658" class="difflineplus">+    }</span>
<a href="#l20.1659"></a><span id="l20.1659" class="difflineplus">+    // We need to also update title of recent folders.</span>
<a href="#l20.1660"></a><span id="l20.1660" class="difflineplus">+    for (let folder of this._recentFolders) {</span>
<a href="#l20.1661"></a><span id="l20.1661" class="difflineplus">+      if (folder.folderId == aItemId) {</span>
<a href="#l20.1662"></a><span id="l20.1662" class="difflineplus">+        folder.title = aNewTitle;</span>
<a href="#l20.1663"></a><span id="l20.1663" class="difflineplus">+        break;</span>
<a href="#l20.1664"></a><span id="l20.1664" class="difflineplus">+      }</span>
<a href="#l20.1665"></a><span id="l20.1665" class="difflineplus">+    }</span>
<a href="#l20.1666"></a><span id="l20.1666" class="difflineplus">+  },</span>
<a href="#l20.1667"></a><span id="l20.1667"> </span>
<a href="#l20.1668"></a><span id="l20.1668" class="difflineminus">-      // Any tags change should be reflected in the tags selector.</span>
<a href="#l20.1669"></a><span id="l20.1669" class="difflineminus">-      this._rebuildTagsSelectorList();</span>
<a href="#l20.1670"></a><span id="l20.1670" class="difflineplus">+  // nsINavBookmarkObserver</span>
<a href="#l20.1671"></a><span id="l20.1671" class="difflineplus">+  onItemChanged(aItemId, aProperty, aIsAnnotationProperty, aValue,</span>
<a href="#l20.1672"></a><span id="l20.1672" class="difflineplus">+                aLastModified, aItemType, aParentId, aGuid) {</span>
<a href="#l20.1673"></a><span id="l20.1673" class="difflineplus">+    if (aProperty == &quot;tags&quot; &amp;&amp; this._paneInfo.visibleRows.has(&quot;tagsRow&quot;)) {</span>
<a href="#l20.1674"></a><span id="l20.1674" class="difflineplus">+      this._onTagsChange(aGuid).catch(Cu.reportError);</span>
<a href="#l20.1675"></a><span id="l20.1675" class="difflineplus">+      return;</span>
<a href="#l20.1676"></a><span id="l20.1676" class="difflineplus">+    }</span>
<a href="#l20.1677"></a><span id="l20.1677" class="difflineplus">+    if (aProperty == &quot;title&quot; &amp;&amp; this._paneInfo.isItem) {</span>
<a href="#l20.1678"></a><span id="l20.1678" class="difflineplus">+      // This also updates titles of folders in the folder menu list.</span>
<a href="#l20.1679"></a><span id="l20.1679" class="difflineplus">+      this._onItemTitleChange(aItemId, aValue);</span>
<a href="#l20.1680"></a><span id="l20.1680">       return;</span>
<a href="#l20.1681"></a><span id="l20.1681">     }</span>
<a href="#l20.1682"></a><span id="l20.1682"> </span>
<a href="#l20.1683"></a><span id="l20.1683" class="difflineminus">-    if (this._itemId != aItemId) {</span>
<a href="#l20.1684"></a><span id="l20.1684" class="difflineminus">-      if (aProperty == &quot;title&quot;) {</span>
<a href="#l20.1685"></a><span id="l20.1685" class="difflineminus">-        // If the title of a folder which is listed within the folders</span>
<a href="#l20.1686"></a><span id="l20.1686" class="difflineminus">-        // menulist has been changed, we need to update the label of its</span>
<a href="#l20.1687"></a><span id="l20.1687" class="difflineminus">-        // representing element.</span>
<a href="#l20.1688"></a><span id="l20.1688" class="difflineminus">-        var menupopup = this._folderMenuList.menupopup;</span>
<a href="#l20.1689"></a><span id="l20.1689" class="difflineminus">-        for (let i = 0; i &lt; menupopup.childNodes.length; i++) {</span>
<a href="#l20.1690"></a><span id="l20.1690" class="difflineminus">-          if (&quot;folderId&quot; in menupopup.childNodes[i] &amp;&amp;</span>
<a href="#l20.1691"></a><span id="l20.1691" class="difflineminus">-              menupopup.childNodes[i].folderId == aItemId) {</span>
<a href="#l20.1692"></a><span id="l20.1692" class="difflineminus">-            menupopup.childNodes[i].label = aValue;</span>
<a href="#l20.1693"></a><span id="l20.1693" class="difflineminus">-            break;</span>
<a href="#l20.1694"></a><span id="l20.1694" class="difflineminus">-          }</span>
<a href="#l20.1695"></a><span id="l20.1695" class="difflineminus">-        }</span>
<a href="#l20.1696"></a><span id="l20.1696" class="difflineminus">-      }</span>
<a href="#l20.1697"></a><span id="l20.1697" class="difflineminus">-</span>
<a href="#l20.1698"></a><span id="l20.1698" class="difflineplus">+    if (!this._paneInfo.isItem || this._paneInfo.itemId != aItemId) {</span>
<a href="#l20.1699"></a><span id="l20.1699">       return;</span>
<a href="#l20.1700"></a><span id="l20.1700">     }</span>
<a href="#l20.1701"></a><span id="l20.1701"> </span>
<a href="#l20.1702"></a><span id="l20.1702">     switch (aProperty) {</span>
<a href="#l20.1703"></a><span id="l20.1703" class="difflineminus">-    case &quot;title&quot;:</span>
<a href="#l20.1704"></a><span id="l20.1704" class="difflineminus">-      var namePicker = this._element(&quot;namePicker&quot;);</span>
<a href="#l20.1705"></a><span id="l20.1705" class="difflineminus">-      if (namePicker.value != aValue) {</span>
<a href="#l20.1706"></a><span id="l20.1706" class="difflineminus">-        namePicker.value = aValue;</span>
<a href="#l20.1707"></a><span id="l20.1707" class="difflineminus">-        // clear undo stack</span>
<a href="#l20.1708"></a><span id="l20.1708" class="difflineminus">-        namePicker.editor.transactionManager.clear();</span>
<a href="#l20.1709"></a><span id="l20.1709" class="difflineminus">-      }</span>
<a href="#l20.1710"></a><span id="l20.1710" class="difflineminus">-      break;</span>
<a href="#l20.1711"></a><span id="l20.1711">     case &quot;uri&quot;:</span>
<a href="#l20.1712"></a><span id="l20.1712" class="difflineminus">-      var locationField = this._element(&quot;locationField&quot;);</span>
<a href="#l20.1713"></a><span id="l20.1713" class="difflineminus">-      if (locationField.value != aValue) {</span>
<a href="#l20.1714"></a><span id="l20.1714" class="difflineminus">-        this._uri = Cc[&quot;@mozilla.org/network/io-service;1&quot;]</span>
<a href="#l20.1715"></a><span id="l20.1715" class="difflineminus">-                      .getService(Ci.nsIIOService)</span>
<a href="#l20.1716"></a><span id="l20.1716" class="difflineminus">-                      .newURI(aValue);</span>
<a href="#l20.1717"></a><span id="l20.1717" class="difflineminus">-        this._initTextField(&quot;locationField&quot;, this._uri.spec);</span>
<a href="#l20.1718"></a><span id="l20.1718" class="difflineminus">-        this._initNamePicker();</span>
<a href="#l20.1719"></a><span id="l20.1719" class="difflineminus">-        this._initTextField(&quot;tagsField&quot;,</span>
<a href="#l20.1720"></a><span id="l20.1720" class="difflineminus">-                             PlacesUtils.tagging</span>
<a href="#l20.1721"></a><span id="l20.1721" class="difflineminus">-                                        .getTagsForURI(this._uri).join(&quot;, &quot;),</span>
<a href="#l20.1722"></a><span id="l20.1722" class="difflineminus">-                            false);</span>
<a href="#l20.1723"></a><span id="l20.1723" class="difflineminus">-        this._rebuildTagsSelectorList();</span>
<a href="#l20.1724"></a><span id="l20.1724" class="difflineplus">+      let newURI = NetUtil.newURI(aValue);</span>
<a href="#l20.1725"></a><span id="l20.1725" class="difflineplus">+      if (!newURI.equals(this._paneInfo.uri)) {</span>
<a href="#l20.1726"></a><span id="l20.1726" class="difflineplus">+        this._paneInfo.uri = newURI;</span>
<a href="#l20.1727"></a><span id="l20.1727" class="difflineplus">+        if (this._paneInfo.visibleRows.has(&quot;locationRow&quot;))</span>
<a href="#l20.1728"></a><span id="l20.1728" class="difflineplus">+          this._initLocationField();</span>
<a href="#l20.1729"></a><span id="l20.1729" class="difflineplus">+</span>
<a href="#l20.1730"></a><span id="l20.1730" class="difflineplus">+        if (this._paneInfo.visibleRows.has(&quot;tagsRow&quot;)) {</span>
<a href="#l20.1731"></a><span id="l20.1731" class="difflineplus">+          delete this._paneInfo._cachedCommonTags;</span>
<a href="#l20.1732"></a><span id="l20.1732" class="difflineplus">+          this._onTagsChange(aGuid, newURI).catch(Cu.reportError);</span>
<a href="#l20.1733"></a><span id="l20.1733" class="difflineplus">+        }</span>
<a href="#l20.1734"></a><span id="l20.1734">       }</span>
<a href="#l20.1735"></a><span id="l20.1735">       break;</span>
<a href="#l20.1736"></a><span id="l20.1736">     case &quot;keyword&quot;:</span>
<a href="#l20.1737"></a><span id="l20.1737" class="difflineminus">-      this._initTextField(&quot;keywordField&quot;,</span>
<a href="#l20.1738"></a><span id="l20.1738" class="difflineminus">-                          PlacesUtils.bookmarks</span>
<a href="#l20.1739"></a><span id="l20.1739" class="difflineminus">-                                     .getKeywordForBookmark(this._itemId));</span>
<a href="#l20.1740"></a><span id="l20.1740" class="difflineplus">+      if (this._paneInfo.visibleRows.has(&quot;keywordRow&quot;))</span>
<a href="#l20.1741"></a><span id="l20.1741" class="difflineplus">+        this._initKeywordField(aValue).catch(Cu.reportError);</span>
<a href="#l20.1742"></a><span id="l20.1742">       break;</span>
<a href="#l20.1743"></a><span id="l20.1743">     case PlacesUIUtils.DESCRIPTION_ANNO:</span>
<a href="#l20.1744"></a><span id="l20.1744" class="difflineminus">-      this._initTextField(&quot;descriptionField&quot;,</span>
<a href="#l20.1745"></a><span id="l20.1745" class="difflineminus">-                          PlacesUIUtils.getItemDescription(this._itemId));</span>
<a href="#l20.1746"></a><span id="l20.1746" class="difflineminus">-      break;</span>
<a href="#l20.1747"></a><span id="l20.1747" class="difflineminus">-    case PlacesUtils.LMANNO_FEEDURI:</span>
<a href="#l20.1748"></a><span id="l20.1748" class="difflineminus">-      var feedURISpec = PlacesUtils.annotations.getItemAnnotation(this._itemId,</span>
<a href="#l20.1749"></a><span id="l20.1749" class="difflineminus">-                        PlacesUtils.LMANNO_FEEDURI);</span>
<a href="#l20.1750"></a><span id="l20.1750" class="difflineminus">-      this._initTextField(&quot;feedLocationField&quot;, feedURISpec, true);</span>
<a href="#l20.1751"></a><span id="l20.1751" class="difflineplus">+      if (this._paneInfo.visibleRows.has(&quot;descriptionRow&quot;))</span>
<a href="#l20.1752"></a><span id="l20.1752" class="difflineplus">+        this._initDescriptionField();</span>
<a href="#l20.1753"></a><span id="l20.1753">       break;</span>
<a href="#l20.1754"></a><span id="l20.1754" class="difflineminus">-    case PlacesUtils.LMANNO_SITEURI:</span>
<a href="#l20.1755"></a><span id="l20.1755" class="difflineminus">-      var siteURISpec = &quot;&quot;;</span>
<a href="#l20.1756"></a><span id="l20.1756" class="difflineminus">-      try {</span>
<a href="#l20.1757"></a><span id="l20.1757" class="difflineminus">-        siteURISpec = PlacesUtils.annotations.getItemAnnotation(this._itemId,</span>
<a href="#l20.1758"></a><span id="l20.1758" class="difflineminus">-                      PlacesUtils.LMANNO_SITEURI);</span>
<a href="#l20.1759"></a><span id="l20.1759" class="difflineminus">-      } catch (e) {}</span>
<a href="#l20.1760"></a><span id="l20.1760" class="difflineminus">-      this._initTextField(&quot;siteLocationField&quot;, siteURISpec, true);</span>
<a href="#l20.1761"></a><span id="l20.1761" class="difflineplus">+    case PlacesUIUtils.LOAD_IN_SIDEBAR_ANNO:</span>
<a href="#l20.1762"></a><span id="l20.1762" class="difflineplus">+      if (this._paneInfo.visibleRows.has(&quot;loadInSidebarCheckbox&quot;))</span>
<a href="#l20.1763"></a><span id="l20.1763" class="difflineplus">+        this._initLoadInSidebar();</span>
<a href="#l20.1764"></a><span id="l20.1764">       break;</span>
<a href="#l20.1765"></a><span id="l20.1765">     }</span>
<a href="#l20.1766"></a><span id="l20.1766">   },</span>
<a href="#l20.1767"></a><span id="l20.1767"> </span>
<a href="#l20.1768"></a><span id="l20.1768" class="difflineminus">-  onItemMoved: function EIO_onItemMoved(aItemId, aOldParent, aOldIndex,</span>
<a href="#l20.1769"></a><span id="l20.1769" class="difflineminus">-                                        aNewParent, aNewIndex, aItemType) {</span>
<a href="#l20.1770"></a><span id="l20.1770" class="difflineminus">-    if (aItemId != this._itemId ||</span>
<a href="#l20.1771"></a><span id="l20.1771" class="difflineminus">-        aNewParent == this._getFolderIdFromMenuList())</span>
<a href="#l20.1772"></a><span id="l20.1772" class="difflineplus">+  onItemMoved(id, oldParentId, oldIndex, newParentId, newIndex, type, guid,</span>
<a href="#l20.1773"></a><span id="l20.1773" class="difflineplus">+              oldParentGuid, newParentGuid) {</span>
<a href="#l20.1774"></a><span id="l20.1774" class="difflineplus">+    if (!this._paneInfo.isItem || this._paneInfo.itemId != id) {</span>
<a href="#l20.1775"></a><span id="l20.1775">       return;</span>
<a href="#l20.1776"></a><span id="l20.1776" class="difflineplus">+    }</span>
<a href="#l20.1777"></a><span id="l20.1777" class="difflineplus">+</span>
<a href="#l20.1778"></a><span id="l20.1778" class="difflineplus">+    this._paneInfo.parentId = newParentId;</span>
<a href="#l20.1779"></a><span id="l20.1779" class="difflineplus">+    this._paneInfo.parentGuid = newParentGuid;</span>
<a href="#l20.1780"></a><span id="l20.1780"> </span>
<a href="#l20.1781"></a><span id="l20.1781" class="difflineminus">-    var folderItem = this._getFolderMenuItem(aNewParent);</span>
<a href="#l20.1782"></a><span id="l20.1782" class="difflineplus">+    if (!this._paneInfo.visibleRows.has(&quot;folderRow&quot;) ||</span>
<a href="#l20.1783"></a><span id="l20.1783" class="difflineplus">+        newParentId == this._folderMenuList.selectedItem.folderId) {</span>
<a href="#l20.1784"></a><span id="l20.1784" class="difflineplus">+      return;</span>
<a href="#l20.1785"></a><span id="l20.1785" class="difflineplus">+    }</span>
<a href="#l20.1786"></a><span id="l20.1786"> </span>
<a href="#l20.1787"></a><span id="l20.1787" class="difflineminus">-    // just setting selectItem _does not_ trigger oncommand, so we don't</span>
<a href="#l20.1788"></a><span id="l20.1788" class="difflineminus">-    // recurse</span>
<a href="#l20.1789"></a><span id="l20.1789" class="difflineminus">-    this._folderMenuList.selectedItem = folderItem;</span>
<a href="#l20.1790"></a><span id="l20.1790" class="difflineplus">+    // Just setting selectItem _does not_ trigger oncommand, so we don't</span>
<a href="#l20.1791"></a><span id="l20.1791" class="difflineplus">+    // recurse.</span>
<a href="#l20.1792"></a><span id="l20.1792" class="difflineplus">+    PlacesUtils.bookmarks.fetch(newParentGuid).then(bm =&gt; {</span>
<a href="#l20.1793"></a><span id="l20.1793" class="difflineplus">+      this._folderMenuList.selectedItem = this._getFolderMenuItem(newParentId,</span>
<a href="#l20.1794"></a><span id="l20.1794" class="difflineplus">+                                                                  bm.title);</span>
<a href="#l20.1795"></a><span id="l20.1795" class="difflineplus">+    });</span>
<a href="#l20.1796"></a><span id="l20.1796">   },</span>
<a href="#l20.1797"></a><span id="l20.1797"> </span>
<a href="#l20.1798"></a><span id="l20.1798" class="difflineminus">-  onItemAdded: function EIO_onItemAdded(aItemId, aParentId, aIndex, aItemType,</span>
<a href="#l20.1799"></a><span id="l20.1799" class="difflineminus">-                                        aURI) {</span>
<a href="#l20.1800"></a><span id="l20.1800" class="difflineplus">+  onItemAdded(aItemId, aParentId, aIndex, aItemType, aURI) {</span>
<a href="#l20.1801"></a><span id="l20.1801">     this._lastNewItem = aItemId;</span>
<a href="#l20.1802"></a><span id="l20.1802">   },</span>
<a href="#l20.1803"></a><span id="l20.1803"> </span>
<a href="#l20.1804"></a><span id="l20.1804" class="difflineminus">-  onItemRemoved: function() { },</span>
<a href="#l20.1805"></a><span id="l20.1805" class="difflineminus">-  onBeginUpdateBatch: function() { },</span>
<a href="#l20.1806"></a><span id="l20.1806" class="difflineminus">-  onEndUpdateBatch: function() { },</span>
<a href="#l20.1807"></a><span id="l20.1807" class="difflineminus">-  onItemVisited: function() { },</span>
<a href="#l20.1808"></a><span id="l20.1808" class="difflineplus">+  onItemRemoved() { },</span>
<a href="#l20.1809"></a><span id="l20.1809" class="difflineplus">+  onBeginUpdateBatch() { },</span>
<a href="#l20.1810"></a><span id="l20.1810" class="difflineplus">+  onEndUpdateBatch() { },</span>
<a href="#l20.1811"></a><span id="l20.1811" class="difflineplus">+  onItemVisited() { },</span>
<a href="#l20.1812"></a><span id="l20.1812"> };</span>
<a href="#l20.1813"></a><span id="l20.1813" class="difflineplus">+</span>
<a href="#l20.1814"></a><span id="l20.1814" class="difflineplus">+</span>
<a href="#l20.1815"></a><span id="l20.1815" class="difflineplus">+for (let elt of [&quot;folderMenuList&quot;, &quot;folderTree&quot;, &quot;namePicker&quot;,</span>
<a href="#l20.1816"></a><span id="l20.1816" class="difflineplus">+                 &quot;locationField&quot;, &quot;descriptionField&quot;, &quot;keywordField&quot;,</span>
<a href="#l20.1817"></a><span id="l20.1817" class="difflineplus">+                 &quot;tagsField&quot;, &quot;loadInSidebarCheckbox&quot;]) {</span>
<a href="#l20.1818"></a><span id="l20.1818" class="difflineplus">+  let eltScoped = elt;</span>
<a href="#l20.1819"></a><span id="l20.1819" class="difflineplus">+  XPCOMUtils.defineLazyGetter(gEditItemOverlay, `_${eltScoped}`,</span>
<a href="#l20.1820"></a><span id="l20.1820" class="difflineplus">+                              () =&gt; gEditItemOverlay._element(eltScoped));</span>
<a href="#l20.1821"></a><span id="l20.1821" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/suite/common/places/content/editBookmarkOverlay.xul</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/suite/common/places/content/editBookmarkOverlay.xul</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -1,105 +1,68 @@</span>
<a href="#l21.4"></a><span id="l21.4" class="difflineminus">-&lt;?xml version=&quot;1.0&quot;?&gt;</span>
<a href="#l21.5"></a><span id="l21.5" class="difflineminus">-</span>
<a href="#l21.6"></a><span id="l21.6"> &lt;!-- This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l21.7"></a><span id="l21.7">    - License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l21.8"></a><span id="l21.8">    - file, You can obtain one at http://mozilla.org/MPL/2.0/. --&gt;</span>
<a href="#l21.9"></a><span id="l21.9"> </span>
<a href="#l21.10"></a><span id="l21.10"> &lt;!DOCTYPE overlay [</span>
<a href="#l21.11"></a><span id="l21.11" class="difflineminus">-&lt;!ENTITY % editBookmarkOverlayDTD SYSTEM &quot;chrome://communicator/locale/bookmarks/editBookmarkOverlay.dtd&quot;&gt;</span>
<a href="#l21.12"></a><span id="l21.12" class="difflineplus">+&lt;!ENTITY % editBookmarkOverlayDTD SYSTEM &quot;chrome://communicator/locale/places/editBookmarkOverlay.dtd&quot;&gt;</span>
<a href="#l21.13"></a><span id="l21.13"> %editBookmarkOverlayDTD;</span>
<a href="#l21.14"></a><span id="l21.14"> ]&gt;</span>
<a href="#l21.15"></a><span id="l21.15"> </span>
<a href="#l21.16"></a><span id="l21.16" class="difflineminus">-&lt;?xml-stylesheet href=&quot;chrome://communicator/skin/bookmarks/editBookmarkOverlay.css&quot;?&gt;</span>
<a href="#l21.17"></a><span id="l21.17" class="difflineminus">-&lt;?xml-stylesheet href=&quot;chrome://communicator/skin/bookmarks/bookmarks.css&quot;?&gt;</span>
<a href="#l21.18"></a><span id="l21.18" class="difflineplus">+&lt;?xml-stylesheet href=&quot;chrome://communicator/skin/places/editBookmarkOverlay.css&quot;?&gt;</span>
<a href="#l21.19"></a><span id="l21.19" class="difflineplus">+&lt;?xml-stylesheet href=&quot;chrome://communicator/skin/places/bookmarks.css&quot;?&gt;</span>
<a href="#l21.20"></a><span id="l21.20"> </span>
<a href="#l21.21"></a><span id="l21.21"> &lt;overlay id=&quot;editBookmarkOverlay&quot;</span>
<a href="#l21.22"></a><span id="l21.22">          xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;&gt;</span>
<a href="#l21.23"></a><span id="l21.23"> </span>
<a href="#l21.24"></a><span id="l21.24" class="difflineminus">-  &lt;vbox id=&quot;editBookmarkPanelContent&quot;&gt;</span>
<a href="#l21.25"></a><span id="l21.25" class="difflineminus">-    &lt;broadcaster id=&quot;paneElementsBroadcaster&quot;/&gt;</span>
<a href="#l21.26"></a><span id="l21.26" class="difflineminus">-</span>
<a href="#l21.27"></a><span id="l21.27" class="difflineminus">-    &lt;hbox id=&quot;editBMPanel_selectionCount&quot; hidden=&quot;true&quot; pack=&quot;center&quot;&gt;</span>
<a href="#l21.28"></a><span id="l21.28" class="difflineplus">+  &lt;vbox id=&quot;editBookmarkPanelContent&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l21.29"></a><span id="l21.29" class="difflineplus">+    &lt;hbox id=&quot;editBMPanel_selectionCount&quot; pack=&quot;center&quot;&gt;</span>
<a href="#l21.30"></a><span id="l21.30">       &lt;label id=&quot;editBMPanel_itemsCountText&quot;/&gt;</span>
<a href="#l21.31"></a><span id="l21.31">     &lt;/hbox&gt;</span>
<a href="#l21.32"></a><span id="l21.32"> </span>
<a href="#l21.33"></a><span id="l21.33">     &lt;grid id=&quot;editBookmarkPanelGrid&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l21.34"></a><span id="l21.34">       &lt;columns id=&quot;editBMPanel_columns&quot;&gt;</span>
<a href="#l21.35"></a><span id="l21.35">         &lt;column id=&quot;editBMPanel_labelColumn&quot; /&gt;</span>
<a href="#l21.36"></a><span id="l21.36">         &lt;column flex=&quot;1&quot; id=&quot;editBMPanel_editColumn&quot; /&gt;</span>
<a href="#l21.37"></a><span id="l21.37">       &lt;/columns&gt;</span>
<a href="#l21.38"></a><span id="l21.38">       &lt;rows id=&quot;editBMPanel_rows&quot;&gt;</span>
<a href="#l21.39"></a><span id="l21.39">         &lt;row id=&quot;editBMPanel_nameRow&quot;</span>
<a href="#l21.40"></a><span id="l21.40">              align=&quot;center&quot;</span>
<a href="#l21.41"></a><span id="l21.41">              collapsed=&quot;true&quot;&gt;</span>
<a href="#l21.42"></a><span id="l21.42">           &lt;label value=&quot;&amp;editBookmarkOverlay.name.label;&quot;</span>
<a href="#l21.43"></a><span id="l21.43">                  class=&quot;editBMPanel_rowLabel&quot;</span>
<a href="#l21.44"></a><span id="l21.44">                  accesskey=&quot;&amp;editBookmarkOverlay.name.accesskey;&quot;</span>
<a href="#l21.45"></a><span id="l21.45" class="difflineminus">-                 control=&quot;editBMPanel_namePicker&quot;</span>
<a href="#l21.46"></a><span id="l21.46" class="difflineminus">-                 observes=&quot;paneElementsBroadcaster&quot;/&gt;</span>
<a href="#l21.47"></a><span id="l21.47" class="difflineplus">+                 control=&quot;editBMPanel_namePicker&quot;/&gt;</span>
<a href="#l21.48"></a><span id="l21.48">           &lt;textbox id=&quot;editBMPanel_namePicker&quot;</span>
<a href="#l21.49"></a><span id="l21.49" class="difflineminus">-                   onblur=&quot;gEditItemOverlay.onNamePickerChange();&quot;</span>
<a href="#l21.50"></a><span id="l21.50" class="difflineminus">-                   observes=&quot;paneElementsBroadcaster&quot;/&gt;</span>
<a href="#l21.51"></a><span id="l21.51" class="difflineplus">+                   onchange=&quot;gEditItemOverlay.onNamePickerChange().catch(Cu.reportError);&quot;/&gt;</span>
<a href="#l21.52"></a><span id="l21.52">         &lt;/row&gt;</span>
<a href="#l21.53"></a><span id="l21.53"> </span>
<a href="#l21.54"></a><span id="l21.54">         &lt;row id=&quot;editBMPanel_locationRow&quot;</span>
<a href="#l21.55"></a><span id="l21.55">              align=&quot;center&quot;</span>
<a href="#l21.56"></a><span id="l21.56">              collapsed=&quot;true&quot;&gt;</span>
<a href="#l21.57"></a><span id="l21.57">           &lt;label value=&quot;&amp;editBookmarkOverlay.location.label;&quot;</span>
<a href="#l21.58"></a><span id="l21.58">                  class=&quot;editBMPanel_rowLabel&quot;</span>
<a href="#l21.59"></a><span id="l21.59">                  accesskey=&quot;&amp;editBookmarkOverlay.location.accesskey;&quot;</span>
<a href="#l21.60"></a><span id="l21.60" class="difflineminus">-                 control=&quot;editBMPanel_locationField&quot;</span>
<a href="#l21.61"></a><span id="l21.61" class="difflineminus">-                 observes=&quot;paneElementsBroadcaster&quot;/&gt;</span>
<a href="#l21.62"></a><span id="l21.62" class="difflineplus">+                 control=&quot;editBMPanel_locationField&quot;/&gt;</span>
<a href="#l21.63"></a><span id="l21.63">           &lt;textbox id=&quot;editBMPanel_locationField&quot;</span>
<a href="#l21.64"></a><span id="l21.64">                    class=&quot;uri-element&quot;</span>
<a href="#l21.65"></a><span id="l21.65" class="difflineminus">-                   onblur=&quot;gEditItemOverlay.onLocationFieldBlur();&quot;</span>
<a href="#l21.66"></a><span id="l21.66" class="difflineminus">-                   observes=&quot;paneElementsBroadcaster&quot;/&gt;</span>
<a href="#l21.67"></a><span id="l21.67" class="difflineminus">-        &lt;/row&gt;</span>
<a href="#l21.68"></a><span id="l21.68" class="difflineminus">-</span>
<a href="#l21.69"></a><span id="l21.69" class="difflineminus">-        &lt;row id=&quot;editBMPanel_feedLocationRow&quot;</span>
<a href="#l21.70"></a><span id="l21.70" class="difflineminus">-             align=&quot;center&quot;</span>
<a href="#l21.71"></a><span id="l21.71" class="difflineminus">-             collapsed=&quot;true&quot;&gt;</span>
<a href="#l21.72"></a><span id="l21.72" class="difflineminus">-          &lt;label value=&quot;&amp;editBookmarkOverlay.feedLocation.label;&quot;</span>
<a href="#l21.73"></a><span id="l21.73" class="difflineminus">-                 class=&quot;editBMPanel_rowLabel&quot;</span>
<a href="#l21.74"></a><span id="l21.74" class="difflineminus">-                 accesskey=&quot;&amp;editBookmarkOverlay.feedLocation.accesskey;&quot;</span>
<a href="#l21.75"></a><span id="l21.75" class="difflineminus">-                 control=&quot;editBMPanel_feedLocationField&quot;</span>
<a href="#l21.76"></a><span id="l21.76" class="difflineminus">-                 observes=&quot;paneElementsBroadcaster&quot;/&gt;</span>
<a href="#l21.77"></a><span id="l21.77" class="difflineminus">-          &lt;textbox id=&quot;editBMPanel_feedLocationField&quot;</span>
<a href="#l21.78"></a><span id="l21.78" class="difflineminus">-                   class=&quot;uri-element&quot;</span>
<a href="#l21.79"></a><span id="l21.79" class="difflineminus">-                   observes=&quot;paneElementsBroadcaster&quot;/&gt;</span>
<a href="#l21.80"></a><span id="l21.80" class="difflineminus">-        &lt;/row&gt;</span>
<a href="#l21.81"></a><span id="l21.81" class="difflineminus">-</span>
<a href="#l21.82"></a><span id="l21.82" class="difflineminus">-        &lt;row id=&quot;editBMPanel_siteLocationRow&quot;</span>
<a href="#l21.83"></a><span id="l21.83" class="difflineminus">-             align=&quot;center&quot;</span>
<a href="#l21.84"></a><span id="l21.84" class="difflineminus">-             collapsed=&quot;true&quot;&gt;</span>
<a href="#l21.85"></a><span id="l21.85" class="difflineminus">-          &lt;label value=&quot;&amp;editBookmarkOverlay.siteLocation.label;&quot;</span>
<a href="#l21.86"></a><span id="l21.86" class="difflineminus">-                 class=&quot;editBMPanel_rowLabel&quot;</span>
<a href="#l21.87"></a><span id="l21.87" class="difflineminus">-                 accesskey=&quot;&amp;editBookmarkOverlay.siteLocation.accesskey;&quot;</span>
<a href="#l21.88"></a><span id="l21.88" class="difflineminus">-                 control=&quot;editBMPanel_siteLocationField&quot;</span>
<a href="#l21.89"></a><span id="l21.89" class="difflineminus">-                 observes=&quot;paneElementsBroadcaster&quot;/&gt;</span>
<a href="#l21.90"></a><span id="l21.90" class="difflineminus">-          &lt;textbox id=&quot;editBMPanel_siteLocationField&quot;</span>
<a href="#l21.91"></a><span id="l21.91" class="difflineminus">-                   class=&quot;uri-element&quot;</span>
<a href="#l21.92"></a><span id="l21.92" class="difflineminus">-                   observes=&quot;paneElementsBroadcaster&quot;/&gt;</span>
<a href="#l21.93"></a><span id="l21.93" class="difflineplus">+                   onchange=&quot;gEditItemOverlay.onLocationFieldChange();&quot;/&gt;</span>
<a href="#l21.94"></a><span id="l21.94">         &lt;/row&gt;</span>
<a href="#l21.95"></a><span id="l21.95"> </span>
<a href="#l21.96"></a><span id="l21.96">         &lt;row id=&quot;editBMPanel_folderRow&quot;</span>
<a href="#l21.97"></a><span id="l21.97">              align=&quot;center&quot;</span>
<a href="#l21.98"></a><span id="l21.98">              collapsed=&quot;true&quot;&gt;</span>
<a href="#l21.99"></a><span id="l21.99">           &lt;label value=&quot;&amp;editBookmarkOverlay.folder.label;&quot;</span>
<a href="#l21.100"></a><span id="l21.100">                  class=&quot;editBMPanel_rowLabel&quot;</span>
<a href="#l21.101"></a><span id="l21.101" class="difflineminus">-                 accesskey=&quot;&amp;editBookmarkOverlay.folder.accesskey;&quot;</span>
<a href="#l21.102"></a><span id="l21.102" class="difflineminus">-                 control=&quot;editBMPanel_folderMenuList&quot;</span>
<a href="#l21.103"></a><span id="l21.103" class="difflineminus">-                 observes=&quot;paneElementsBroadcaster&quot;/&gt;</span>
<a href="#l21.104"></a><span id="l21.104" class="difflineplus">+                 control=&quot;editBMPanel_folderMenuList&quot;/&gt;</span>
<a href="#l21.105"></a><span id="l21.105">           &lt;hbox flex=&quot;1&quot; align=&quot;center&quot;&gt;</span>
<a href="#l21.106"></a><span id="l21.106">             &lt;menulist id=&quot;editBMPanel_folderMenuList&quot;</span>
<a href="#l21.107"></a><span id="l21.107">                       class=&quot;folder-icon&quot;</span>
<a href="#l21.108"></a><span id="l21.108">                       flex=&quot;1&quot;</span>
<a href="#l21.109"></a><span id="l21.109" class="difflineminus">-                      oncommand=&quot;gEditItemOverlay.onFolderMenuListCommand(event);&quot;</span>
<a href="#l21.110"></a><span id="l21.110" class="difflineminus">-                      observes=&quot;paneElementsBroadcaster&quot;&gt;</span>
<a href="#l21.111"></a><span id="l21.111" class="difflineplus">+                      oncommand=&quot;gEditItemOverlay.onFolderMenuListCommand(event).catch(Cu.reportError);&quot;&gt;</span>
<a href="#l21.112"></a><span id="l21.112">               &lt;menupopup&gt;</span>
<a href="#l21.113"></a><span id="l21.113">                 &lt;!-- Static item for special folders --&gt;</span>
<a href="#l21.114"></a><span id="l21.114">                 &lt;menuitem id=&quot;editBMPanel_toolbarFolderItem&quot;</span>
<a href="#l21.115"></a><span id="l21.115">                           class=&quot;menuitem-iconic folder-icon&quot;/&gt;</span>
<a href="#l21.116"></a><span id="l21.116">                 &lt;menuitem id=&quot;editBMPanel_bmRootItem&quot;</span>
<a href="#l21.117"></a><span id="l21.117">                           class=&quot;menuitem-iconic folder-icon&quot;/&gt;</span>
<a href="#l21.118"></a><span id="l21.118">                 &lt;menuitem id=&quot;editBMPanel_unfiledRootItem&quot;</span>
<a href="#l21.119"></a><span id="l21.119">                           class=&quot;menuitem-iconic folder-icon&quot;/&gt;</span>
<a href="#l21.120"></a><span id="l21.120" class="difflineat">@@ -110,120 +73,120 @@</span>
<a href="#l21.121"></a><span id="l21.121">                 &lt;menuseparator id=&quot;editBMPanel_foldersSeparator&quot; hidden=&quot;true&quot;/&gt;</span>
<a href="#l21.122"></a><span id="l21.122">               &lt;/menupopup&gt;</span>
<a href="#l21.123"></a><span id="l21.123">             &lt;/menulist&gt;</span>
<a href="#l21.124"></a><span id="l21.124">             &lt;button id=&quot;editBMPanel_foldersExpander&quot;</span>
<a href="#l21.125"></a><span id="l21.125">                     class=&quot;expander-down&quot;</span>
<a href="#l21.126"></a><span id="l21.126">                     tooltiptext=&quot;&amp;editBookmarkOverlay.foldersExpanderDown.tooltip;&quot;</span>
<a href="#l21.127"></a><span id="l21.127">                     tooltiptextdown=&quot;&amp;editBookmarkOverlay.foldersExpanderDown.tooltip;&quot;</span>
<a href="#l21.128"></a><span id="l21.128">                     tooltiptextup=&quot;&amp;editBookmarkOverlay.expanderUp.tooltip;&quot;</span>
<a href="#l21.129"></a><span id="l21.129" class="difflineminus">-                    oncommand=&quot;gEditItemOverlay.toggleFolderTreeVisibility();&quot;</span>
<a href="#l21.130"></a><span id="l21.130" class="difflineminus">-                    observes=&quot;paneElementsBroadcaster&quot;/&gt;</span>
<a href="#l21.131"></a><span id="l21.131" class="difflineplus">+                    oncommand=&quot;gEditItemOverlay.toggleFolderTreeVisibility();&quot;/&gt;</span>
<a href="#l21.132"></a><span id="l21.132">           &lt;/hbox&gt;</span>
<a href="#l21.133"></a><span id="l21.133">         &lt;/row&gt;</span>
<a href="#l21.134"></a><span id="l21.134"> </span>
<a href="#l21.135"></a><span id="l21.135">         &lt;row id=&quot;editBMPanel_folderTreeRow&quot;</span>
<a href="#l21.136"></a><span id="l21.136">              collapsed=&quot;true&quot;</span>
<a href="#l21.137"></a><span id="l21.137">              flex=&quot;1&quot;&gt;</span>
<a href="#l21.138"></a><span id="l21.138">           &lt;spacer/&gt;</span>
<a href="#l21.139"></a><span id="l21.139">           &lt;vbox flex=&quot;1&quot;&gt;</span>
<a href="#l21.140"></a><span id="l21.140">             &lt;tree id=&quot;editBMPanel_folderTree&quot;</span>
<a href="#l21.141"></a><span id="l21.141" class="difflineplus">+                  flex=&quot;1&quot;</span>
<a href="#l21.142"></a><span id="l21.142">                   class=&quot;placesTree&quot;</span>
<a href="#l21.143"></a><span id="l21.143">                   type=&quot;places&quot;</span>
<a href="#l21.144"></a><span id="l21.144">                   treelines=&quot;true&quot;</span>
<a href="#l21.145"></a><span id="l21.145" class="difflineplus">+                  height=&quot;150&quot;</span>
<a href="#l21.146"></a><span id="l21.146">                   minheight=&quot;150&quot;</span>
<a href="#l21.147"></a><span id="l21.147" class="difflineminus">-                  flex=&quot;1&quot;</span>
<a href="#l21.148"></a><span id="l21.148">                   editable=&quot;true&quot;</span>
<a href="#l21.149"></a><span id="l21.149">                   onselect=&quot;gEditItemOverlay.onFolderTreeSelect();&quot;</span>
<a href="#l21.150"></a><span id="l21.150" class="difflineminus">-                  hidecolumnpicker=&quot;true&quot;</span>
<a href="#l21.151"></a><span id="l21.151" class="difflineminus">-                  observes=&quot;paneElementsBroadcaster&quot;&gt;</span>
<a href="#l21.152"></a><span id="l21.152" class="difflineplus">+                  hidecolumnpicker=&quot;true&quot;&gt;</span>
<a href="#l21.153"></a><span id="l21.153">               &lt;treecols&gt;</span>
<a href="#l21.154"></a><span id="l21.154">                 &lt;treecol anonid=&quot;title&quot; flex=&quot;1&quot; primary=&quot;true&quot; hideheader=&quot;true&quot;/&gt;</span>
<a href="#l21.155"></a><span id="l21.155">               &lt;/treecols&gt;</span>
<a href="#l21.156"></a><span id="l21.156">               &lt;treechildren flex=&quot;1&quot;/&gt;</span>
<a href="#l21.157"></a><span id="l21.157">             &lt;/tree&gt;</span>
<a href="#l21.158"></a><span id="l21.158"> </span>
<a href="#l21.159"></a><span id="l21.159">             &lt;hbox id=&quot;editBMPanel_newFolderBox&quot;&gt;</span>
<a href="#l21.160"></a><span id="l21.160">               &lt;button label=&quot;&amp;editBookmarkOverlay.newFolderButton.label;&quot;</span>
<a href="#l21.161"></a><span id="l21.161">                       id=&quot;editBMPanel_newFolderButton&quot;</span>
<a href="#l21.162"></a><span id="l21.162">                       accesskey=&quot;&amp;editBookmarkOverlay.newFolderButton.accesskey;&quot;</span>
<a href="#l21.163"></a><span id="l21.163" class="difflineminus">-                      tooltiptext=&quot;&amp;editBookmarkOverlay.newFolderButton.tooltip;&quot;</span>
<a href="#l21.164"></a><span id="l21.164" class="difflineminus">-                      oncommand=&quot;gEditItemOverlay.newFolder();&quot;/&gt;</span>
<a href="#l21.165"></a><span id="l21.165" class="difflineplus">+                      oncommand=&quot;gEditItemOverlay.newFolder().catch(Cu.reportError);&quot;/&gt;</span>
<a href="#l21.166"></a><span id="l21.166">             &lt;/hbox&gt;</span>
<a href="#l21.167"></a><span id="l21.167">           &lt;/vbox&gt;</span>
<a href="#l21.168"></a><span id="l21.168">         &lt;/row&gt;</span>
<a href="#l21.169"></a><span id="l21.169"> </span>
<a href="#l21.170"></a><span id="l21.170">         &lt;row id=&quot;editBMPanel_tagsRow&quot;</span>
<a href="#l21.171"></a><span id="l21.171">              align=&quot;center&quot;</span>
<a href="#l21.172"></a><span id="l21.172">              collapsed=&quot;true&quot;&gt;</span>
<a href="#l21.173"></a><span id="l21.173">           &lt;label value=&quot;&amp;editBookmarkOverlay.tags.label;&quot;</span>
<a href="#l21.174"></a><span id="l21.174">                  class=&quot;editBMPanel_rowLabel&quot;</span>
<a href="#l21.175"></a><span id="l21.175">                  accesskey=&quot;&amp;editBookmarkOverlay.tags.accesskey;&quot;</span>
<a href="#l21.176"></a><span id="l21.176" class="difflineminus">-                 control=&quot;editBMPanel_tagsField&quot;</span>
<a href="#l21.177"></a><span id="l21.177" class="difflineminus">-                 observes=&quot;paneElementsBroadcaster&quot;/&gt;</span>
<a href="#l21.178"></a><span id="l21.178" class="difflineplus">+                 control=&quot;editBMPanel_tagsField&quot;/&gt;</span>
<a href="#l21.179"></a><span id="l21.179">           &lt;hbox flex=&quot;1&quot; align=&quot;center&quot;&gt;</span>
<a href="#l21.180"></a><span id="l21.180">             &lt;textbox id=&quot;editBMPanel_tagsField&quot;</span>
<a href="#l21.181"></a><span id="l21.181">                      type=&quot;autocomplete&quot;</span>
<a href="#l21.182"></a><span id="l21.182">                      class=&quot;padded&quot;</span>
<a href="#l21.183"></a><span id="l21.183">                      flex=&quot;1&quot;</span>
<a href="#l21.184"></a><span id="l21.184" class="difflineminus">-                     autocompletesearch=&quot;places-tag-autocomplete&quot;</span>
<a href="#l21.185"></a><span id="l21.185" class="difflineplus">+                     autocompletesearch=&quot;places-tag-autocomplete&quot; </span>
<a href="#l21.186"></a><span id="l21.186">                      completedefaultindex=&quot;true&quot;</span>
<a href="#l21.187"></a><span id="l21.187">                      tabscrolling=&quot;true&quot;</span>
<a href="#l21.188"></a><span id="l21.188">                      showcommentcolumn=&quot;true&quot;</span>
<a href="#l21.189"></a><span id="l21.189" class="difflineminus">-                     onblur=&quot;gEditItemOverlay.onTagsFieldBlur();&quot;</span>
<a href="#l21.190"></a><span id="l21.190" class="difflineminus">-                     observes=&quot;paneElementsBroadcaster&quot;</span>
<a href="#l21.191"></a><span id="l21.191" class="difflineminus">-                     placeholder=&quot;&amp;editBookmarkOverlay.tagsEmptyDesc.label;&quot;/&gt;</span>
<a href="#l21.192"></a><span id="l21.192" class="difflineplus">+                     placeholder=&quot;&amp;editBookmarkOverlay.tagsEmptyDesc.label;&quot;</span>
<a href="#l21.193"></a><span id="l21.193" class="difflineplus">+                     onchange=&quot;gEditItemOverlay.onTagsFieldChange();&quot;/&gt;</span>
<a href="#l21.194"></a><span id="l21.194">             &lt;button id=&quot;editBMPanel_tagsSelectorExpander&quot;</span>
<a href="#l21.195"></a><span id="l21.195">                     class=&quot;expander-down&quot;</span>
<a href="#l21.196"></a><span id="l21.196">                     tooltiptext=&quot;&amp;editBookmarkOverlay.tagsExpanderDown.tooltip;&quot;</span>
<a href="#l21.197"></a><span id="l21.197">                     tooltiptextdown=&quot;&amp;editBookmarkOverlay.tagsExpanderDown.tooltip;&quot;</span>
<a href="#l21.198"></a><span id="l21.198">                     tooltiptextup=&quot;&amp;editBookmarkOverlay.expanderUp.tooltip;&quot;</span>
<a href="#l21.199"></a><span id="l21.199" class="difflineminus">-                    oncommand=&quot;gEditItemOverlay.toggleTagsSelector();&quot;</span>
<a href="#l21.200"></a><span id="l21.200" class="difflineminus">-                    observes=&quot;paneElementsBroadcaster&quot;/&gt;</span>
<a href="#l21.201"></a><span id="l21.201" class="difflineplus">+                    oncommand=&quot;gEditItemOverlay.toggleTagsSelector();&quot;/&gt;</span>
<a href="#l21.202"></a><span id="l21.202">           &lt;/hbox&gt;</span>
<a href="#l21.203"></a><span id="l21.203">         &lt;/row&gt;</span>
<a href="#l21.204"></a><span id="l21.204"> </span>
<a href="#l21.205"></a><span id="l21.205">         &lt;row id=&quot;editBMPanel_tagsSelectorRow&quot;</span>
<a href="#l21.206"></a><span id="l21.206">              align=&quot;center&quot;</span>
<a href="#l21.207"></a><span id="l21.207">              collapsed=&quot;true&quot;&gt;</span>
<a href="#l21.208"></a><span id="l21.208">           &lt;spacer/&gt;</span>
<a href="#l21.209"></a><span id="l21.209">           &lt;listbox id=&quot;editBMPanel_tagsSelector&quot;</span>
<a href="#l21.210"></a><span id="l21.210" class="difflineminus">-                   minheight=&quot;150&quot;</span>
<a href="#l21.211"></a><span id="l21.211" class="difflineminus">-                   observes=&quot;paneElementsBroadcaster&quot;/&gt;</span>
<a href="#l21.212"></a><span id="l21.212" class="difflineplus">+                   height=&quot;150&quot;/&gt;</span>
<a href="#l21.213"></a><span id="l21.213">         &lt;/row&gt;</span>
<a href="#l21.214"></a><span id="l21.214"> </span>
<a href="#l21.215"></a><span id="l21.215">         &lt;row id=&quot;editBMPanel_keywordRow&quot;</span>
<a href="#l21.216"></a><span id="l21.216">              align=&quot;center&quot;</span>
<a href="#l21.217"></a><span id="l21.217">              collapsed=&quot;true&quot;&gt;</span>
<a href="#l21.218"></a><span id="l21.218">           &lt;observes element=&quot;additionalInfoBroadcaster&quot; attribute=&quot;hidden&quot;/&gt;</span>
<a href="#l21.219"></a><span id="l21.219">           &lt;label value=&quot;&amp;editBookmarkOverlay.keyword.label;&quot;</span>
<a href="#l21.220"></a><span id="l21.220">                  class=&quot;editBMPanel_rowLabel&quot;</span>
<a href="#l21.221"></a><span id="l21.221">                  accesskey=&quot;&amp;editBookmarkOverlay.keyword.accesskey;&quot;</span>
<a href="#l21.222"></a><span id="l21.222" class="difflineminus">-                 control=&quot;editBMPanel_keywordField&quot;</span>
<a href="#l21.223"></a><span id="l21.223" class="difflineminus">-                 observes=&quot;paneElementsBroadcaster&quot;/&gt;</span>
<a href="#l21.224"></a><span id="l21.224" class="difflineplus">+                 control=&quot;editBMPanel_keywordField&quot;/&gt;</span>
<a href="#l21.225"></a><span id="l21.225">           &lt;textbox id=&quot;editBMPanel_keywordField&quot;</span>
<a href="#l21.226"></a><span id="l21.226" class="difflineminus">-                   onblur=&quot;gEditItemOverlay.onKeywordFieldBlur();&quot;</span>
<a href="#l21.227"></a><span id="l21.227" class="difflineminus">-                   observes=&quot;paneElementsBroadcaster&quot;/&gt;</span>
<a href="#l21.228"></a><span id="l21.228" class="difflineplus">+                   onchange=&quot;gEditItemOverlay.onKeywordFieldChange();&quot;/&gt;</span>
<a href="#l21.229"></a><span id="l21.229">         &lt;/row&gt;</span>
<a href="#l21.230"></a><span id="l21.230"> </span>
<a href="#l21.231"></a><span id="l21.231">         &lt;row id=&quot;editBMPanel_descriptionRow&quot;</span>
<a href="#l21.232"></a><span id="l21.232">              collapsed=&quot;true&quot;&gt;</span>
<a href="#l21.233"></a><span id="l21.233">           &lt;observes element=&quot;additionalInfoBroadcaster&quot; attribute=&quot;hidden&quot;/&gt;</span>
<a href="#l21.234"></a><span id="l21.234">           &lt;label value=&quot;&amp;editBookmarkOverlay.description.label;&quot;</span>
<a href="#l21.235"></a><span id="l21.235">                  class=&quot;editBMPanel_rowLabel&quot;</span>
<a href="#l21.236"></a><span id="l21.236">                  accesskey=&quot;&amp;editBookmarkOverlay.description.accesskey;&quot;</span>
<a href="#l21.237"></a><span id="l21.237" class="difflineminus">-                 control=&quot;editBMPanel_descriptionField&quot;</span>
<a href="#l21.238"></a><span id="l21.238" class="difflineminus">-                 observes=&quot;paneElementsBroadcaster&quot;/&gt;</span>
<a href="#l21.239"></a><span id="l21.239" class="difflineplus">+                 control=&quot;editBMPanel_descriptionField&quot;/&gt;</span>
<a href="#l21.240"></a><span id="l21.240">           &lt;textbox id=&quot;editBMPanel_descriptionField&quot;</span>
<a href="#l21.241"></a><span id="l21.241">                    multiline=&quot;true&quot;</span>
<a href="#l21.242"></a><span id="l21.242" class="difflineminus">-                   flex=&quot;1&quot;</span>
<a href="#l21.243"></a><span id="l21.243" class="difflineminus">-                   onblur=&quot;gEditItemOverlay.onDescriptionFieldBlur();&quot;</span>
<a href="#l21.244"></a><span id="l21.244" class="difflineminus">-                   observes=&quot;paneElementsBroadcaster&quot;/&gt;</span>
<a href="#l21.245"></a><span id="l21.245" class="difflineplus">+                   rows=&quot;4&quot;</span>
<a href="#l21.246"></a><span id="l21.246" class="difflineplus">+                   onchange=&quot;gEditItemOverlay.onDescriptionFieldChange();&quot;/&gt;</span>
<a href="#l21.247"></a><span id="l21.247">         &lt;/row&gt;</span>
<a href="#l21.248"></a><span id="l21.248">       &lt;/rows&gt;</span>
<a href="#l21.249"></a><span id="l21.249">     &lt;/grid&gt;</span>
<a href="#l21.250"></a><span id="l21.250"> </span>
<a href="#l21.251"></a><span id="l21.251" class="difflineplus">+    &lt;checkbox id=&quot;editBMPanel_loadInSidebarCheckbox&quot;</span>
<a href="#l21.252"></a><span id="l21.252" class="difflineplus">+              collapsed=&quot;true&quot;</span>
<a href="#l21.253"></a><span id="l21.253" class="difflineplus">+              hidden=&quot;true&quot;</span>
<a href="#l21.254"></a><span id="l21.254" class="difflineplus">+              disabled=&quot;true&quot;</span>
<a href="#l21.255"></a><span id="l21.255" class="difflineplus">+              label=&quot;&amp;editBookmarkOverlay.loadInSidebar.label;&quot;</span>
<a href="#l21.256"></a><span id="l21.256" class="difflineplus">+              accesskey=&quot;&amp;editBookmarkOverlay.loadInSidebar.accesskey;&quot;</span>
<a href="#l21.257"></a><span id="l21.257" class="difflineplus">+              oncommand=&quot;gEditItemOverlay.onLoadInSidebarCheckboxCommand();&quot;&gt;</span>
<a href="#l21.258"></a><span id="l21.258" class="difflineplus">+      &lt;!-- Not yet supported</span>
<a href="#l21.259"></a><span id="l21.259" class="difflineplus">+      &lt;observes element=&quot;additionalInfoBroadcaster&quot; attribute=&quot;hidden&quot;/&gt; --&gt;</span>
<a href="#l21.260"></a><span id="l21.260" class="difflineplus">+    &lt;/checkbox&gt;</span>
<a href="#l21.261"></a><span id="l21.261" class="difflineplus">+</span>
<a href="#l21.262"></a><span id="l21.262">     &lt;!-- If the ids are changing or additional fields are being added, be sure</span>
<a href="#l21.263"></a><span id="l21.263">          to sync the values in places.js --&gt;</span>
<a href="#l21.264"></a><span id="l21.264">     &lt;broadcaster id=&quot;additionalInfoBroadcaster&quot;/&gt;</span>
<a href="#l21.265"></a><span id="l21.265" class="difflineminus">-</span>
<a href="#l21.266"></a><span id="l21.266">   &lt;/vbox&gt;</span>
<a href="#l21.267"></a><span id="l21.267"> &lt;/overlay&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/suite/common/places/content/history-panel.js</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/suite/common/places/content/history-panel.js</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -1,197 +1,94 @@</span>
<a href="#l22.4"></a><span id="l22.4" class="difflineminus">-/* -*- Mode: Java; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l22.5"></a><span id="l22.5" class="difflineplus">+/* -*- indent-tabs-mode: nil; js-indent-level: 4 -*- */</span>
<a href="#l22.6"></a><span id="l22.6"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l22.7"></a><span id="l22.7">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l22.8"></a><span id="l22.8">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l22.9"></a><span id="l22.9"> </span>
<a href="#l22.10"></a><span id="l22.10" class="difflineminus">-var gHistoryTree;</span>
<a href="#l22.11"></a><span id="l22.11" class="difflineminus">-var gLastHostname;</span>
<a href="#l22.12"></a><span id="l22.12" class="difflineminus">-var gLastDomain;</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineminus">-var gSearchBox;</span>
<a href="#l22.14"></a><span id="l22.14" class="difflineminus">-var gDeleteByHostname;</span>
<a href="#l22.15"></a><span id="l22.15" class="difflineminus">-var gDeleteByDomain;</span>
<a href="#l22.16"></a><span id="l22.16" class="difflineminus">-var gHistoryStatus;</span>
<a href="#l22.17"></a><span id="l22.17" class="difflineminus">-var gHistoryGrouping = &quot;day&quot;;</span>
<a href="#l22.18"></a><span id="l22.18" class="difflineplus">+ChromeUtils.import(&quot;resource://gre/modules/TelemetryStopwatch.jsm&quot;);</span>
<a href="#l22.19"></a><span id="l22.19"> </span>
<a href="#l22.20"></a><span id="l22.20" class="difflineminus">-ChromeUtils.import(&quot;resource://gre/modules/PlacesUtils.jsm&quot;);</span>
<a href="#l22.21"></a><span id="l22.21" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/PlacesUIUtils.jsm&quot;);</span>
<a href="#l22.22"></a><span id="l22.22" class="difflineplus">+var gHistoryTree;</span>
<a href="#l22.23"></a><span id="l22.23" class="difflineplus">+var gSearchBox;</span>
<a href="#l22.24"></a><span id="l22.24" class="difflineplus">+var gHistoryGrouping = &quot;&quot;;</span>
<a href="#l22.25"></a><span id="l22.25" class="difflineplus">+var gSearching = false;</span>
<a href="#l22.26"></a><span id="l22.26"> </span>
<a href="#l22.27"></a><span id="l22.27" class="difflineminus">-function HistoryCommonInit()</span>
<a href="#l22.28"></a><span id="l22.28" class="difflineminus">-{</span>
<a href="#l22.29"></a><span id="l22.29" class="difflineplus">+function HistorySidebarInit() {</span>
<a href="#l22.30"></a><span id="l22.30">   gHistoryTree = document.getElementById(&quot;historyTree&quot;);</span>
<a href="#l22.31"></a><span id="l22.31" class="difflineminus">-  gDeleteByHostname = document.getElementById(&quot;placesCmd_delete:hostname&quot;);</span>
<a href="#l22.32"></a><span id="l22.32" class="difflineminus">-  gDeleteByDomain = document.getElementById(&quot;placesCmd_delete:domain&quot;);</span>
<a href="#l22.33"></a><span id="l22.33" class="difflineminus">-  gHistoryStatus = document.getElementById(&quot;statusbar-display&quot;);</span>
<a href="#l22.34"></a><span id="l22.34">   gSearchBox = document.getElementById(&quot;search-box&quot;);</span>
<a href="#l22.35"></a><span id="l22.35"> </span>
<a href="#l22.36"></a><span id="l22.36" class="difflineminus">-  try {</span>
<a href="#l22.37"></a><span id="l22.37" class="difflineminus">-    gHistoryGrouping = Services.prefs.getCharPref(&quot;browser.history.grouping&quot;);</span>
<a href="#l22.38"></a><span id="l22.38" class="difflineminus">-  } catch (e) {}</span>
<a href="#l22.39"></a><span id="l22.39" class="difflineminus">-</span>
<a href="#l22.40"></a><span id="l22.40" class="difflineminus">-  document.getElementById(&quot;GroupBy&quot; + gHistoryGrouping[0].toUpperCase() +</span>
<a href="#l22.41"></a><span id="l22.41" class="difflineminus">-                                      gHistoryGrouping.slice(1))</span>
<a href="#l22.42"></a><span id="l22.42" class="difflineminus">-          .setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l22.43"></a><span id="l22.43" class="difflineminus">-</span>
<a href="#l22.44"></a><span id="l22.44" class="difflineminus">-  searchHistory(&quot;&quot;);</span>
<a href="#l22.45"></a><span id="l22.45" class="difflineminus">-</span>
<a href="#l22.46"></a><span id="l22.46" class="difflineminus">-  if (gHistoryStatus)</span>
<a href="#l22.47"></a><span id="l22.47" class="difflineminus">-    gHistoryTree.focus();</span>
<a href="#l22.48"></a><span id="l22.48" class="difflineminus">-</span>
<a href="#l22.49"></a><span id="l22.49" class="difflineminus">-  if (gHistoryTree.view.rowCount &gt; 0)</span>
<a href="#l22.50"></a><span id="l22.50" class="difflineminus">-    gHistoryTree.view.selection.select(0);</span>
<a href="#l22.51"></a><span id="l22.51" class="difflineminus">-}</span>
<a href="#l22.52"></a><span id="l22.52" class="difflineminus">-</span>
<a href="#l22.53"></a><span id="l22.53" class="difflineminus">-function updateHistoryCommands(aCommand)</span>
<a href="#l22.54"></a><span id="l22.54" class="difflineminus">-{</span>
<a href="#l22.55"></a><span id="l22.55" class="difflineminus">-  document.commandDispatcher.updateCommands(&quot;select&quot;);</span>
<a href="#l22.56"></a><span id="l22.56" class="difflineminus">-  for (; aCommand; aCommand = aCommand.nextSibling)</span>
<a href="#l22.57"></a><span id="l22.57" class="difflineminus">-    goUpdateCommand(aCommand.id);</span>
<a href="#l22.58"></a><span id="l22.58" class="difflineminus">-}</span>
<a href="#l22.59"></a><span id="l22.59" class="difflineminus">-</span>
<a href="#l22.60"></a><span id="l22.60" class="difflineminus">-function historyOnSelect()</span>
<a href="#l22.61"></a><span id="l22.61" class="difflineminus">-{</span>
<a href="#l22.62"></a><span id="l22.62" class="difflineminus">-  gLastHostname = null;</span>
<a href="#l22.63"></a><span id="l22.63" class="difflineminus">-  gLastDomain = null;</span>
<a href="#l22.64"></a><span id="l22.64" class="difflineminus">-  var url = &quot;&quot;;</span>
<a href="#l22.65"></a><span id="l22.65" class="difflineminus">-</span>
<a href="#l22.66"></a><span id="l22.66" class="difflineminus">-  var selectedNode = gHistoryTree.selectedNode;</span>
<a href="#l22.67"></a><span id="l22.67" class="difflineminus">-  if (selectedNode) {</span>
<a href="#l22.68"></a><span id="l22.68" class="difflineminus">-    if (PlacesUtils.nodeIsURI(selectedNode)) {</span>
<a href="#l22.69"></a><span id="l22.69" class="difflineminus">-      try {</span>
<a href="#l22.70"></a><span id="l22.70" class="difflineminus">-        url = selectedNode.uri;</span>
<a href="#l22.71"></a><span id="l22.71" class="difflineminus">-        gLastHostname = Services.io.newURI(url).host;</span>
<a href="#l22.72"></a><span id="l22.72" class="difflineminus">-      } catch (e) {}</span>
<a href="#l22.73"></a><span id="l22.73" class="difflineminus">-    } else if (PlacesUtils.nodeIsHost(selectedNode)) {</span>
<a href="#l22.74"></a><span id="l22.74" class="difflineminus">-      gLastHostname = selectedNode.title;</span>
<a href="#l22.75"></a><span id="l22.75" class="difflineminus">-    }</span>
<a href="#l22.76"></a><span id="l22.76" class="difflineminus">-    if (gLastHostname) {</span>
<a href="#l22.77"></a><span id="l22.77" class="difflineminus">-      try {</span>
<a href="#l22.78"></a><span id="l22.78" class="difflineminus">-        gLastDomain = Services.eTLD.getBaseDomainFromHost(gLastHostname);</span>
<a href="#l22.79"></a><span id="l22.79" class="difflineminus">-      } catch (e) {}</span>
<a href="#l22.80"></a><span id="l22.80" class="difflineminus">-    }</span>
<a href="#l22.81"></a><span id="l22.81" class="difflineminus">-  }</span>
<a href="#l22.82"></a><span id="l22.82" class="difflineminus">-</span>
<a href="#l22.83"></a><span id="l22.83" class="difflineminus">-  if (gHistoryStatus)</span>
<a href="#l22.84"></a><span id="l22.84" class="difflineminus">-    gHistoryStatus.label = url;</span>
<a href="#l22.85"></a><span id="l22.85" class="difflineminus">-</span>
<a href="#l22.86"></a><span id="l22.86" class="difflineminus">-  updateHistoryCommands();</span>
<a href="#l22.87"></a><span id="l22.87" class="difflineminus">-}</span>
<a href="#l22.88"></a><span id="l22.88" class="difflineplus">+  gHistoryGrouping = document.getElementById(&quot;viewButton&quot;).</span>
<a href="#l22.89"></a><span id="l22.89" class="difflineplus">+                              getAttribute(&quot;selectedsort&quot;);</span>
<a href="#l22.90"></a><span id="l22.90"> </span>
<a href="#l22.91"></a><span id="l22.91" class="difflineminus">-function UpdateViewColumns(aMenuItem)</span>
<a href="#l22.92"></a><span id="l22.92" class="difflineminus">-{</span>
<a href="#l22.93"></a><span id="l22.93" class="difflineminus">-  while (aMenuItem) {</span>
<a href="#l22.94"></a><span id="l22.94" class="difflineminus">-    // Each menuitem should be checked if its column is not hidden.</span>
<a href="#l22.95"></a><span id="l22.95" class="difflineminus">-    var colid = aMenuItem.id.replace(/Toggle/, &quot;&quot;);</span>
<a href="#l22.96"></a><span id="l22.96" class="difflineminus">-    var column = document.getElementById(colid);</span>
<a href="#l22.97"></a><span id="l22.97" class="difflineminus">-    aMenuItem.setAttribute(&quot;checked&quot;, !column.hidden);</span>
<a href="#l22.98"></a><span id="l22.98" class="difflineminus">-    aMenuItem = aMenuItem.nextSibling;</span>
<a href="#l22.99"></a><span id="l22.99" class="difflineminus">-  }</span>
<a href="#l22.100"></a><span id="l22.100" class="difflineminus">-}</span>
<a href="#l22.101"></a><span id="l22.101" class="difflineplus">+  if (gHistoryGrouping == &quot;site&quot;)</span>
<a href="#l22.102"></a><span id="l22.102" class="difflineplus">+    document.getElementById(&quot;bysite&quot;).setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l22.103"></a><span id="l22.103" class="difflineplus">+  else if (gHistoryGrouping == &quot;visited&quot;)</span>
<a href="#l22.104"></a><span id="l22.104" class="difflineplus">+    document.getElementById(&quot;byvisited&quot;).setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l22.105"></a><span id="l22.105" class="difflineplus">+  else if (gHistoryGrouping == &quot;lastvisited&quot;)</span>
<a href="#l22.106"></a><span id="l22.106" class="difflineplus">+    document.getElementById(&quot;bylastvisited&quot;).setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l22.107"></a><span id="l22.107" class="difflineplus">+  else if (gHistoryGrouping == &quot;dayandsite&quot;)</span>
<a href="#l22.108"></a><span id="l22.108" class="difflineplus">+    document.getElementById(&quot;bydayandsite&quot;).setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l22.109"></a><span id="l22.109" class="difflineplus">+  else</span>
<a href="#l22.110"></a><span id="l22.110" class="difflineplus">+    document.getElementById(&quot;byday&quot;).setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l22.111"></a><span id="l22.111"> </span>
<a href="#l22.112"></a><span id="l22.112" class="difflineminus">-function UpdateViewSort(aMenuItem)</span>
<a href="#l22.113"></a><span id="l22.113" class="difflineminus">-{</span>
<a href="#l22.114"></a><span id="l22.114" class="difflineminus">-  // Note: consider building this by reading the result's sortingMode instead.</span>
<a href="#l22.115"></a><span id="l22.115" class="difflineminus">-  var unsorted = true;</span>
<a href="#l22.116"></a><span id="l22.116" class="difflineminus">-  var ascending = true;</span>
<a href="#l22.117"></a><span id="l22.117" class="difflineminus">-  while (aMenuItem) {</span>
<a href="#l22.118"></a><span id="l22.118" class="difflineminus">-    switch (aMenuItem.id) {</span>
<a href="#l22.119"></a><span id="l22.119" class="difflineminus">-      case &quot;&quot;: // separator</span>
<a href="#l22.120"></a><span id="l22.120" class="difflineminus">-        break;</span>
<a href="#l22.121"></a><span id="l22.121" class="difflineminus">-      case &quot;Unsorted&quot;:</span>
<a href="#l22.122"></a><span id="l22.122" class="difflineminus">-        if (unsorted) // this would work even if Unsorted was last</span>
<a href="#l22.123"></a><span id="l22.123" class="difflineminus">-          aMenuItem.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l22.124"></a><span id="l22.124" class="difflineminus">-        break;</span>
<a href="#l22.125"></a><span id="l22.125" class="difflineminus">-      case &quot;SortAscending&quot;:</span>
<a href="#l22.126"></a><span id="l22.126" class="difflineminus">-        aMenuItem.setAttribute(&quot;disabled&quot;, unsorted);</span>
<a href="#l22.127"></a><span id="l22.127" class="difflineminus">-        if (ascending)</span>
<a href="#l22.128"></a><span id="l22.128" class="difflineminus">-          aMenuItem.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l22.129"></a><span id="l22.129" class="difflineminus">-        break;</span>
<a href="#l22.130"></a><span id="l22.130" class="difflineminus">-      case &quot;SortDescending&quot;:</span>
<a href="#l22.131"></a><span id="l22.131" class="difflineminus">-        aMenuItem.setAttribute(&quot;disabled&quot;, unsorted);</span>
<a href="#l22.132"></a><span id="l22.132" class="difflineminus">-        if (!ascending)</span>
<a href="#l22.133"></a><span id="l22.133" class="difflineminus">-          aMenuItem.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l22.134"></a><span id="l22.134" class="difflineminus">-        break;</span>
<a href="#l22.135"></a><span id="l22.135" class="difflineminus">-      default:</span>
<a href="#l22.136"></a><span id="l22.136" class="difflineminus">-        var colid = aMenuItem.id.replace(/SortBy/, &quot;&quot;);</span>
<a href="#l22.137"></a><span id="l22.137" class="difflineminus">-        var column = document.getElementById(colid);</span>
<a href="#l22.138"></a><span id="l22.138" class="difflineminus">-        var direction = column.getAttribute(&quot;sortDirection&quot;);</span>
<a href="#l22.139"></a><span id="l22.139" class="difflineminus">-        if (direction) {</span>
<a href="#l22.140"></a><span id="l22.140" class="difflineminus">-          // We've found a sorted column. Remember its direction.</span>
<a href="#l22.141"></a><span id="l22.141" class="difflineminus">-          ascending = direction == &quot;ascending&quot;;</span>
<a href="#l22.142"></a><span id="l22.142" class="difflineminus">-          unsorted = false;</span>
<a href="#l22.143"></a><span id="l22.143" class="difflineminus">-          aMenuItem.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l22.144"></a><span id="l22.144" class="difflineminus">-        }</span>
<a href="#l22.145"></a><span id="l22.145" class="difflineminus">-    }</span>
<a href="#l22.146"></a><span id="l22.146" class="difflineminus">-    aMenuItem = aMenuItem.nextSibling;</span>
<a href="#l22.147"></a><span id="l22.147" class="difflineminus">-  }</span>
<a href="#l22.148"></a><span id="l22.148" class="difflineminus">-}</span>
<a href="#l22.149"></a><span id="l22.149" class="difflineminus">-</span>
<a href="#l22.150"></a><span id="l22.150" class="difflineminus">-function ToggleColumn(aMenuItem)</span>
<a href="#l22.151"></a><span id="l22.151" class="difflineminus">-{</span>
<a href="#l22.152"></a><span id="l22.152" class="difflineminus">-  var colid = aMenuItem.id.replace(/Toggle/, &quot;&quot;);</span>
<a href="#l22.153"></a><span id="l22.153" class="difflineminus">-  var column = document.getElementById(colid);</span>
<a href="#l22.154"></a><span id="l22.154" class="difflineminus">-  column.setAttribute(&quot;hidden&quot;, !column.hidden);</span>
<a href="#l22.155"></a><span id="l22.155" class="difflineminus">-}</span>
<a href="#l22.156"></a><span id="l22.156" class="difflineminus">-</span>
<a href="#l22.157"></a><span id="l22.157" class="difflineminus">-function GroupBy(aMenuItem)</span>
<a href="#l22.158"></a><span id="l22.158" class="difflineminus">-{</span>
<a href="#l22.159"></a><span id="l22.159" class="difflineminus">-  gSearchBox.value = &quot;&quot;;</span>
<a href="#l22.160"></a><span id="l22.160" class="difflineminus">-  gHistoryGrouping = aMenuItem.id.replace(/GroupBy/, &quot;&quot;).toLowerCase();</span>
<a href="#l22.161"></a><span id="l22.161" class="difflineminus">-  Services.prefs.setCharPref(&quot;browser.history.grouping&quot;, gHistoryGrouping);</span>
<a href="#l22.162"></a><span id="l22.162">   searchHistory(&quot;&quot;);</span>
<a href="#l22.163"></a><span id="l22.163"> }</span>
<a href="#l22.164"></a><span id="l22.164"> </span>
<a href="#l22.165"></a><span id="l22.165" class="difflineminus">-function historyAddBookmarks()</span>
<a href="#l22.166"></a><span id="l22.166" class="difflineminus">-{</span>
<a href="#l22.167"></a><span id="l22.167" class="difflineminus">-  var count = gHistoryTree.view.selection.count;</span>
<a href="#l22.168"></a><span id="l22.168" class="difflineminus">-  if (count == 1)</span>
<a href="#l22.169"></a><span id="l22.169" class="difflineminus">-    PlacesUIUtils.showMinimalAddBookmarkUI(PlacesUtils._uri(gHistoryTree.selectedNode.uri),</span>
<a href="#l22.170"></a><span id="l22.170" class="difflineminus">-                                           gHistoryTree.selectedNode.title);</span>
<a href="#l22.171"></a><span id="l22.171" class="difflineminus">-  else if (count &gt; 1) {</span>
<a href="#l22.172"></a><span id="l22.172" class="difflineminus">-    selNodes = gHistoryTree.getSelectionNodes();</span>
<a href="#l22.173"></a><span id="l22.173" class="difflineminus">-    var tabList = [];</span>
<a href="#l22.174"></a><span id="l22.174" class="difflineminus">-    for (var i = 0; i &lt; selNodes.length; i++) {</span>
<a href="#l22.175"></a><span id="l22.175" class="difflineminus">-      if (PlacesUtils.nodeIsURI(selNodes[i]))</span>
<a href="#l22.176"></a><span id="l22.176" class="difflineminus">-        tabList.push(PlacesUtils._uri(selNodes[i].uri));</span>
<a href="#l22.177"></a><span id="l22.177" class="difflineminus">-    }</span>
<a href="#l22.178"></a><span id="l22.178" class="difflineminus">-    PlacesUIUtils.showMinimalAddMultiBookmarkUI(tabList);</span>
<a href="#l22.179"></a><span id="l22.179" class="difflineminus">-  }</span>
<a href="#l22.180"></a><span id="l22.180" class="difflineplus">+function GroupBy(groupingType) {</span>
<a href="#l22.181"></a><span id="l22.181" class="difflineplus">+  gHistoryGrouping = groupingType;</span>
<a href="#l22.182"></a><span id="l22.182" class="difflineplus">+  searchHistory(gSearchBox.value);</span>
<a href="#l22.183"></a><span id="l22.183"> }</span>
<a href="#l22.184"></a><span id="l22.184"> </span>
<a href="#l22.185"></a><span id="l22.185" class="difflineminus">-function searchHistory(aInput)</span>
<a href="#l22.186"></a><span id="l22.186" class="difflineminus">-{</span>
<a href="#l22.187"></a><span id="l22.187" class="difflineplus">+function searchHistory(aInput) {</span>
<a href="#l22.188"></a><span id="l22.188">   var query = PlacesUtils.history.getNewQuery();</span>
<a href="#l22.189"></a><span id="l22.189">   var options = PlacesUtils.history.getNewQueryOptions();</span>
<a href="#l22.190"></a><span id="l22.190"> </span>
<a href="#l22.191"></a><span id="l22.191">   const NHQO = Ci.nsINavHistoryQueryOptions;</span>
<a href="#l22.192"></a><span id="l22.192" class="difflineminus">-  options.sortingMode = gHistoryTree.sortingMode;</span>
<a href="#l22.193"></a><span id="l22.193" class="difflineminus">-  options.queryType = NHQO.QUERY_TYPE_HISTORY;</span>
<a href="#l22.194"></a><span id="l22.194" class="difflineplus">+  var sortingMode;</span>
<a href="#l22.195"></a><span id="l22.195" class="difflineplus">+  var resultType;</span>
<a href="#l22.196"></a><span id="l22.196" class="difflineplus">+</span>
<a href="#l22.197"></a><span id="l22.197" class="difflineplus">+  switch (gHistoryGrouping) {</span>
<a href="#l22.198"></a><span id="l22.198" class="difflineplus">+    case &quot;visited&quot;:</span>
<a href="#l22.199"></a><span id="l22.199" class="difflineplus">+      resultType = NHQO.RESULTS_AS_URI;</span>
<a href="#l22.200"></a><span id="l22.200" class="difflineplus">+      sortingMode = NHQO.SORT_BY_VISITCOUNT_DESCENDING;</span>
<a href="#l22.201"></a><span id="l22.201" class="difflineplus">+      break;</span>
<a href="#l22.202"></a><span id="l22.202" class="difflineplus">+    case &quot;lastvisited&quot;:</span>
<a href="#l22.203"></a><span id="l22.203" class="difflineplus">+      resultType = NHQO.RESULTS_AS_URI;</span>
<a href="#l22.204"></a><span id="l22.204" class="difflineplus">+      sortingMode = NHQO.SORT_BY_DATE_DESCENDING;</span>
<a href="#l22.205"></a><span id="l22.205" class="difflineplus">+      break;</span>
<a href="#l22.206"></a><span id="l22.206" class="difflineplus">+    case &quot;dayandsite&quot;:</span>
<a href="#l22.207"></a><span id="l22.207" class="difflineplus">+      resultType = NHQO.RESULTS_AS_DATE_SITE_QUERY;</span>
<a href="#l22.208"></a><span id="l22.208" class="difflineplus">+      break;</span>
<a href="#l22.209"></a><span id="l22.209" class="difflineplus">+    case &quot;site&quot;:</span>
<a href="#l22.210"></a><span id="l22.210" class="difflineplus">+      resultType = NHQO.RESULTS_AS_SITE_QUERY;</span>
<a href="#l22.211"></a><span id="l22.211" class="difflineplus">+      sortingMode = NHQO.SORT_BY_TITLE_ASCENDING;</span>
<a href="#l22.212"></a><span id="l22.212" class="difflineplus">+      break;</span>
<a href="#l22.213"></a><span id="l22.213" class="difflineplus">+    case &quot;day&quot;:</span>
<a href="#l22.214"></a><span id="l22.214" class="difflineplus">+    default:</span>
<a href="#l22.215"></a><span id="l22.215" class="difflineplus">+      resultType = NHQO.RESULTS_AS_DATE_QUERY;</span>
<a href="#l22.216"></a><span id="l22.216" class="difflineplus">+      break;</span>
<a href="#l22.217"></a><span id="l22.217" class="difflineplus">+  }</span>
<a href="#l22.218"></a><span id="l22.218"> </span>
<a href="#l22.219"></a><span id="l22.219">   if (aInput) {</span>
<a href="#l22.220"></a><span id="l22.220">     query.searchTerms = aInput;</span>
<a href="#l22.221"></a><span id="l22.221" class="difflineminus">-    options.resultType = NHQO.RESULTS_AS_URI;</span>
<a href="#l22.222"></a><span id="l22.222" class="difflineminus">-  }</span>
<a href="#l22.223"></a><span id="l22.223" class="difflineminus">-  else {</span>
<a href="#l22.224"></a><span id="l22.224" class="difflineminus">-    switch (gHistoryGrouping) {</span>
<a href="#l22.225"></a><span id="l22.225" class="difflineminus">-      case &quot;none&quot;:</span>
<a href="#l22.226"></a><span id="l22.226" class="difflineminus">-        options.resultType = NHQO.RESULTS_AS_URI;</span>
<a href="#l22.227"></a><span id="l22.227" class="difflineminus">-        break;</span>
<a href="#l22.228"></a><span id="l22.228" class="difflineminus">-      case &quot;both&quot;:</span>
<a href="#l22.229"></a><span id="l22.229" class="difflineminus">-        options.resultType = NHQO.RESULTS_AS_DATE_SITE_QUERY;</span>
<a href="#l22.230"></a><span id="l22.230" class="difflineminus">-        break;</span>
<a href="#l22.231"></a><span id="l22.231" class="difflineminus">-      case &quot;site&quot;:</span>
<a href="#l22.232"></a><span id="l22.232" class="difflineminus">-        options.resultType = NHQO.RESULTS_AS_SITE_QUERY;</span>
<a href="#l22.233"></a><span id="l22.233" class="difflineminus">-        break;</span>
<a href="#l22.234"></a><span id="l22.234" class="difflineminus">-      case &quot;day&quot;:</span>
<a href="#l22.235"></a><span id="l22.235" class="difflineminus">-        options.resultType = NHQO.RESULTS_AS_DATE_QUERY;</span>
<a href="#l22.236"></a><span id="l22.236" class="difflineminus">-        break;</span>
<a href="#l22.237"></a><span id="l22.237" class="difflineplus">+    if (gHistoryGrouping != &quot;visited&quot; &amp;&amp; gHistoryGrouping != &quot;lastvisited&quot;) {</span>
<a href="#l22.238"></a><span id="l22.238" class="difflineplus">+      sortingMode = NHQO.SORT_BY_FRECENCY_DESCENDING;</span>
<a href="#l22.239"></a><span id="l22.239" class="difflineplus">+      resultType = NHQO.RESULTS_AS_URI;</span>
<a href="#l22.240"></a><span id="l22.240">     }</span>
<a href="#l22.241"></a><span id="l22.241">   }</span>
<a href="#l22.242"></a><span id="l22.242"> </span>
<a href="#l22.243"></a><span id="l22.243" class="difflineminus">-  var titleColumn = document.getElementById(&quot;Name&quot;);</span>
<a href="#l22.244"></a><span id="l22.244" class="difflineminus">-  if (options.resultType == NHQO.RESULTS_AS_URI)</span>
<a href="#l22.245"></a><span id="l22.245" class="difflineminus">-    titleColumn.removeAttribute(&quot;primary&quot;);</span>
<a href="#l22.246"></a><span id="l22.246" class="difflineminus">-  else</span>
<a href="#l22.247"></a><span id="l22.247" class="difflineminus">-    titleColumn.setAttribute(&quot;primary&quot;, &quot;true&quot;);</span>
<a href="#l22.248"></a><span id="l22.248" class="difflineplus">+  options.sortingMode = sortingMode;</span>
<a href="#l22.249"></a><span id="l22.249" class="difflineplus">+  options.resultType = resultType;</span>
<a href="#l22.250"></a><span id="l22.250" class="difflineplus">+  options.includeHidden = !!aInput;</span>
<a href="#l22.251"></a><span id="l22.251" class="difflineplus">+</span>
<a href="#l22.252"></a><span id="l22.252" class="difflineplus">+  if (gHistoryGrouping == &quot;lastvisited&quot;)</span>
<a href="#l22.253"></a><span id="l22.253" class="difflineplus">+    this.TelemetryStopwatch.start(&quot;HISTORY_LASTVISITED_TREE_QUERY_TIME_MS&quot;);</span>
<a href="#l22.254"></a><span id="l22.254"> </span>
<a href="#l22.255"></a><span id="l22.255" class="difflineplus">+  // call load() on the tree manually</span>
<a href="#l22.256"></a><span id="l22.256" class="difflineplus">+  // instead of setting the place attribute in history-panel.xul</span>
<a href="#l22.257"></a><span id="l22.257" class="difflineplus">+  // otherwise, we will end up calling load() twice</span>
<a href="#l22.258"></a><span id="l22.258">   gHistoryTree.load([query], options);</span>
<a href="#l22.259"></a><span id="l22.259" class="difflineplus">+</span>
<a href="#l22.260"></a><span id="l22.260" class="difflineplus">+  if (gHistoryGrouping == &quot;lastvisited&quot;)</span>
<a href="#l22.261"></a><span id="l22.261" class="difflineplus">+    this.TelemetryStopwatch.finish(&quot;HISTORY_LASTVISITED_TREE_QUERY_TIME_MS&quot;);</span>
<a href="#l22.262"></a><span id="l22.262"> }</span>
<a href="#l22.263"></a><span id="l22.263" class="difflineplus">+</span>
<a href="#l22.264"></a><span id="l22.264" class="difflineplus">+window.addEventListener(&quot;SidebarFocused&quot;,</span>
<a href="#l22.265"></a><span id="l22.265" class="difflineplus">+                        () =&gt; gSearchBox.focus());</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/suite/common/places/content/history-panel.xul</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/suite/common/places/content/history-panel.xul</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -1,73 +1,95 @@</span>
<a href="#l23.4"></a><span id="l23.4" class="difflineminus">-&lt;?xml version=&quot;1.0&quot;?&gt; &lt;!-- -*- Mode: xml; indent-tabs-mode: nil; -*- --&gt;</span>
<a href="#l23.5"></a><span id="l23.5" class="difflineminus">-</span>
<a href="#l23.6"></a><span id="l23.6" class="difflineplus">+&lt;?xml version=&quot;1.0&quot;?&gt; &lt;!-- -*- Mode: SGML; indent-tabs-mode: nil; -*- --&gt;</span>
<a href="#l23.7"></a><span id="l23.7"> &lt;!-- This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l23.8"></a><span id="l23.8">    - License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l23.9"></a><span id="l23.9">    - file, You can obtain one at http://mozilla.org/MPL/2.0/. --&gt;</span>
<a href="#l23.10"></a><span id="l23.10"> </span>
<a href="#l23.11"></a><span id="l23.11"> &lt;?xml-stylesheet href=&quot;chrome://communicator/skin/&quot; type=&quot;text/css&quot;?&gt;</span>
<a href="#l23.12"></a><span id="l23.12"> &lt;?xml-stylesheet href=&quot;chrome://communicator/skin/sidebar/sidebarListView.css&quot; type=&quot;text/css&quot;?&gt;</span>
<a href="#l23.13"></a><span id="l23.13" class="difflineplus">+&lt;?xml-stylesheet href=&quot;chrome://communicator/content/places/places.css&quot;?&gt;</span>
<a href="#l23.14"></a><span id="l23.14" class="difflineplus">+&lt;?xml-stylesheet href=&quot;chrome://communicator/skin/places/bookmarks.css&quot;?&gt;</span>
<a href="#l23.15"></a><span id="l23.15"> </span>
<a href="#l23.16"></a><span id="l23.16"> &lt;?xul-overlay href=&quot;chrome://global/content/editMenuOverlay.xul&quot;?&gt;</span>
<a href="#l23.17"></a><span id="l23.17" class="difflineminus">-&lt;?xul-overlay href=&quot;chrome://communicator/content/history/placesOverlay.xul&quot;?&gt;</span>
<a href="#l23.18"></a><span id="l23.18" class="difflineplus">+&lt;?xul-overlay href=&quot;chrome://communicator/content/places/placesOverlay.xul&quot;?&gt;</span>
<a href="#l23.19"></a><span id="l23.19"> &lt;?xul-overlay href=&quot;chrome://communicator/content/utilityOverlay.xul&quot;?&gt;</span>
<a href="#l23.20"></a><span id="l23.20"> </span>
<a href="#l23.21"></a><span id="l23.21" class="difflineminus">-&lt;!DOCTYPE page SYSTEM &quot;chrome://communicator/locale/history/history.dtd&quot;&gt;</span>
<a href="#l23.22"></a><span id="l23.22" class="difflineplus">+&lt;!DOCTYPE page [</span>
<a href="#l23.23"></a><span id="l23.23" class="difflineplus">+&lt;!ENTITY % placesDTD SYSTEM &quot;chrome://communicator/locale/places/places.dtd&quot;&gt;</span>
<a href="#l23.24"></a><span id="l23.24" class="difflineplus">+%placesDTD;</span>
<a href="#l23.25"></a><span id="l23.25" class="difflineplus">+]&gt;</span>
<a href="#l23.26"></a><span id="l23.26"> </span>
<a href="#l23.27"></a><span id="l23.27"> &lt;!-- we need to keep id=&quot;history-panel&quot; for upgrade and switching</span>
<a href="#l23.28"></a><span id="l23.28">      between versions of the browser --&gt;</span>
<a href="#l23.29"></a><span id="l23.29"> </span>
<a href="#l23.30"></a><span id="l23.30"> &lt;page id=&quot;history-panel&quot; orient=&quot;vertical&quot;</span>
<a href="#l23.31"></a><span id="l23.31">       xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;</span>
<a href="#l23.32"></a><span id="l23.32" class="difflineminus">-      onload=&quot;HistoryCommonInit();&quot;</span>
<a href="#l23.33"></a><span id="l23.33" class="difflineminus">-      onunload=&quot;SidebarUtils.setMouseoverURL('');&quot;</span>
<a href="#l23.34"></a><span id="l23.34" class="difflineminus">-      elementtofocus=&quot;search-box&quot;&gt;</span>
<a href="#l23.35"></a><span id="l23.35" class="difflineplus">+      onload=&quot;HistorySidebarInit();&quot;</span>
<a href="#l23.36"></a><span id="l23.36" class="difflineplus">+      onunload=&quot;SidebarUtils.setMouseoverURL('');&quot;&gt;</span>
<a href="#l23.37"></a><span id="l23.37"> </span>
<a href="#l23.38"></a><span id="l23.38">   &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l23.39"></a><span id="l23.39" class="difflineminus">-          src=&quot;chrome://communicator/content/places/sidebarUtils.js&quot;/&gt;</span>
<a href="#l23.40"></a><span id="l23.40" class="difflineplus">+          src=&quot;chrome://communicator/content/bookmarks/sidebarUtils.js&quot;/&gt;</span>
<a href="#l23.41"></a><span id="l23.41" class="difflineplus">+  &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l23.42"></a><span id="l23.42" class="difflineplus">+          src=&quot;chrome://communicator/content/places/history-panel.js&quot;/&gt;</span>
<a href="#l23.43"></a><span id="l23.43"> </span>
<a href="#l23.44"></a><span id="l23.44">   &lt;commandset id=&quot;editMenuCommands&quot;/&gt;</span>
<a href="#l23.45"></a><span id="l23.45">   &lt;commandset id=&quot;placesCommands&quot;/&gt;</span>
<a href="#l23.46"></a><span id="l23.46"> </span>
<a href="#l23.47"></a><span id="l23.47">   &lt;keyset id=&quot;editMenuKeys&quot;&gt;</span>
<a href="#l23.48"></a><span id="l23.48" class="difflineminus">-    &lt;key id=&quot;key_delete2&quot;/&gt;</span>
<a href="#l23.49"></a><span id="l23.49" class="difflineplus">+#ifdef XP_MACOSX</span>
<a href="#l23.50"></a><span id="l23.50" class="difflineplus">+    &lt;key id=&quot;key_delete2&quot; keycode=&quot;VK_BACK&quot; command=&quot;cmd_delete&quot;/&gt;</span>
<a href="#l23.51"></a><span id="l23.51" class="difflineplus">+#endif</span>
<a href="#l23.52"></a><span id="l23.52">   &lt;/keyset&gt;</span>
<a href="#l23.53"></a><span id="l23.53"> </span>
<a href="#l23.54"></a><span id="l23.54" class="difflineplus">+  &lt;!-- required to overlay the context menu --&gt;</span>
<a href="#l23.55"></a><span id="l23.55">   &lt;menupopup id=&quot;placesContext&quot;/&gt;</span>
<a href="#l23.56"></a><span id="l23.56"> </span>
<a href="#l23.57"></a><span id="l23.57" class="difflineminus">-  &lt;hbox align=&quot;center&quot;&gt;</span>
<a href="#l23.58"></a><span id="l23.58" class="difflineplus">+  &lt;!-- Bookmarks and history tooltip --&gt;</span>
<a href="#l23.59"></a><span id="l23.59" class="difflineplus">+  &lt;tooltip id=&quot;bhTooltip&quot;/&gt;</span>
<a href="#l23.60"></a><span id="l23.60" class="difflineplus">+</span>
<a href="#l23.61"></a><span id="l23.61" class="difflineplus">+  &lt;hbox id=&quot;sidebar-search-container&quot; align=&quot;center&quot;&gt;</span>
<a href="#l23.62"></a><span id="l23.62">     &lt;textbox id=&quot;search-box&quot; flex=&quot;1&quot; type=&quot;search&quot;</span>
<a href="#l23.63"></a><span id="l23.63" class="difflineminus">-             placeholder=&quot;&amp;search.placeholder;&quot; clickSelectsAll=&quot;true&quot;</span>
<a href="#l23.64"></a><span id="l23.64" class="difflineplus">+             placeholder=&quot;&amp;search.placeholder;&quot;</span>
<a href="#l23.65"></a><span id="l23.65">              aria-controls=&quot;historyTree&quot;</span>
<a href="#l23.66"></a><span id="l23.66">              oncommand=&quot;searchHistory(this.value);&quot;/&gt;</span>
<a href="#l23.67"></a><span id="l23.67" class="difflineminus">-    &lt;toolbarbutton id=&quot;viewButton&quot; type=&quot;menu&quot; class=&quot;tabbable&quot;</span>
<a href="#l23.68"></a><span id="l23.68" class="difflineminus">-                   label=&quot;&amp;view.label;&quot;&gt;</span>
<a href="#l23.69"></a><span id="l23.69" class="difflineminus">-      &lt;menupopup id=&quot;viewPopup&quot;/&gt;</span>
<a href="#l23.70"></a><span id="l23.70" class="difflineminus">-    &lt;/toolbarbutton&gt;</span>
<a href="#l23.71"></a><span id="l23.71" class="difflineplus">+    &lt;button id=&quot;viewButton&quot; style=&quot;min-width:0px !important;&quot; type=&quot;menu&quot;</span>
<a href="#l23.72"></a><span id="l23.72" class="difflineplus">+            label=&quot;&amp;view.label;&quot; accesskey=&quot;&amp;view.accesskey;&quot; selectedsort=&quot;day&quot;</span>
<a href="#l23.73"></a><span id="l23.73" class="difflineplus">+            persist=&quot;selectedsort&quot;&gt;</span>
<a href="#l23.74"></a><span id="l23.74" class="difflineplus">+      &lt;menupopup&gt;</span>
<a href="#l23.75"></a><span id="l23.75" class="difflineplus">+        &lt;menuitem id=&quot;bydayandsite&quot; label=&quot;&amp;byDayAndSite.label;&quot;</span>
<a href="#l23.76"></a><span id="l23.76" class="difflineplus">+                  accesskey=&quot;&amp;byDayAndSite.accesskey;&quot; type=&quot;radio&quot;</span>
<a href="#l23.77"></a><span id="l23.77" class="difflineplus">+                  oncommand=&quot;this.parentNode.parentNode.setAttribute('selectedsort', 'dayandsite'); GroupBy('dayandsite');&quot;/&gt;</span>
<a href="#l23.78"></a><span id="l23.78" class="difflineplus">+        &lt;menuitem id=&quot;bysite&quot; label=&quot;&amp;bySite.label;&quot;</span>
<a href="#l23.79"></a><span id="l23.79" class="difflineplus">+                  accesskey=&quot;&amp;bySite.accesskey;&quot; type=&quot;radio&quot;</span>
<a href="#l23.80"></a><span id="l23.80" class="difflineplus">+                  oncommand=&quot;this.parentNode.parentNode.setAttribute('selectedsort', 'site'); GroupBy('site');&quot;/&gt;</span>
<a href="#l23.81"></a><span id="l23.81" class="difflineplus">+        &lt;menuitem id=&quot;byday&quot; label=&quot;&amp;byDate.label;&quot;</span>
<a href="#l23.82"></a><span id="l23.82" class="difflineplus">+                  accesskey=&quot;&amp;byDate.accesskey;&quot;</span>
<a href="#l23.83"></a><span id="l23.83" class="difflineplus">+                  type=&quot;radio&quot;</span>
<a href="#l23.84"></a><span id="l23.84" class="difflineplus">+                  oncommand=&quot;this.parentNode.parentNode.setAttribute('selectedsort', 'day'); GroupBy('day');&quot;/&gt;</span>
<a href="#l23.85"></a><span id="l23.85" class="difflineplus">+        &lt;menuitem id=&quot;byvisited&quot; label=&quot;&amp;byMostVisited.label;&quot;</span>
<a href="#l23.86"></a><span id="l23.86" class="difflineplus">+                  accesskey=&quot;&amp;byMostVisited.accesskey;&quot;</span>
<a href="#l23.87"></a><span id="l23.87" class="difflineplus">+                  type=&quot;radio&quot;</span>
<a href="#l23.88"></a><span id="l23.88" class="difflineplus">+                  oncommand=&quot;this.parentNode.parentNode.setAttribute('selectedsort', 'visited'); GroupBy('visited');&quot;/&gt;</span>
<a href="#l23.89"></a><span id="l23.89" class="difflineplus">+        &lt;menuitem id=&quot;bylastvisited&quot; label=&quot;&amp;byLastVisited.label;&quot;</span>
<a href="#l23.90"></a><span id="l23.90" class="difflineplus">+                  accesskey=&quot;&amp;byLastVisited.accesskey;&quot;</span>
<a href="#l23.91"></a><span id="l23.91" class="difflineplus">+                  type=&quot;radio&quot;</span>
<a href="#l23.92"></a><span id="l23.92" class="difflineplus">+                  oncommand=&quot;this.parentNode.parentNode.setAttribute('selectedsort', 'lastvisited'); GroupBy('lastvisited');&quot;/&gt;</span>
<a href="#l23.93"></a><span id="l23.93" class="difflineplus">+      &lt;/menupopup&gt;</span>
<a href="#l23.94"></a><span id="l23.94" class="difflineplus">+    &lt;/button&gt;</span>
<a href="#l23.95"></a><span id="l23.95">   &lt;/hbox&gt;</span>
<a href="#l23.96"></a><span id="l23.96"> </span>
<a href="#l23.97"></a><span id="l23.97">   &lt;tree id=&quot;historyTree&quot;</span>
<a href="#l23.98"></a><span id="l23.98" class="difflineminus">-        class=&quot;sidebar-placesTree plain&quot;</span>
<a href="#l23.99"></a><span id="l23.99" class="difflineplus">+        class=&quot;sidebar-placesTree&quot;</span>
<a href="#l23.100"></a><span id="l23.100">         flex=&quot;1&quot;</span>
<a href="#l23.101"></a><span id="l23.101">         type=&quot;places&quot;</span>
<a href="#l23.102"></a><span id="l23.102" class="difflineplus">+        treelines=&quot;true&quot;</span>
<a href="#l23.103"></a><span id="l23.103">         context=&quot;placesContext&quot;</span>
<a href="#l23.104"></a><span id="l23.104" class="difflineminus">-        onselect=&quot;historyOnSelect();&quot;</span>
<a href="#l23.105"></a><span id="l23.105" class="difflineplus">+        hidecolumnpicker=&quot;true&quot;</span>
<a href="#l23.106"></a><span id="l23.106">         onkeypress=&quot;SidebarUtils.handleTreeKeyPress(event);&quot;</span>
<a href="#l23.107"></a><span id="l23.107">         onclick=&quot;SidebarUtils.handleTreeClick(this, event, true);&quot;</span>
<a href="#l23.108"></a><span id="l23.108">         onmousemove=&quot;SidebarUtils.handleTreeMouseMove(event);&quot;</span>
<a href="#l23.109"></a><span id="l23.109">         onmouseout=&quot;SidebarUtils.setMouseoverURL('');&quot;&gt;</span>
<a href="#l23.110"></a><span id="l23.110" class="difflineminus">-    &lt;treecols context=&quot;&quot;&gt;</span>
<a href="#l23.111"></a><span id="l23.111" class="difflineminus">-      &lt;treecol label=&quot;&amp;col.title.label;&quot; id=&quot;Name&quot; flex=&quot;4&quot;</span>
<a href="#l23.112"></a><span id="l23.112" class="difflineminus">-               persist=&quot;width hidden ordinal sortActive sortDirection&quot;/&gt;</span>
<a href="#l23.113"></a><span id="l23.113" class="difflineminus">-      &lt;splitter class=&quot;tree-splitter&quot;/&gt;</span>
<a href="#l23.114"></a><span id="l23.114" class="difflineminus">-      &lt;treecol label=&quot;&amp;col.url.label;&quot; id=&quot;URL&quot; flex=&quot;4&quot; hidden=&quot;true&quot;</span>
<a href="#l23.115"></a><span id="l23.115" class="difflineminus">-               persist=&quot;width hidden ordinal sortActive sortDirection&quot;/&gt;</span>
<a href="#l23.116"></a><span id="l23.116" class="difflineminus">-      &lt;splitter class=&quot;tree-splitter&quot;/&gt;</span>
<a href="#l23.117"></a><span id="l23.117" class="difflineminus">-      &lt;treecol label=&quot;&amp;col.lastvisit.label;&quot; id=&quot;Date&quot; flex=&quot;1&quot; hidden=&quot;true&quot;</span>
<a href="#l23.118"></a><span id="l23.118" class="difflineminus">-               persist=&quot;width hidden ordinal sortActive sortDirection&quot;/&gt;</span>
<a href="#l23.119"></a><span id="l23.119" class="difflineminus">-      &lt;splitter class=&quot;tree-splitter&quot;/&gt;</span>
<a href="#l23.120"></a><span id="l23.120" class="difflineminus">-      &lt;treecol label=&quot;&amp;col.visitcount.label;&quot; id=&quot;VisitCount&quot; flex=&quot;1&quot; hidden=&quot;true&quot;</span>
<a href="#l23.121"></a><span id="l23.121" class="difflineminus">-               persist=&quot;width hidden ordinal sortActive sortDirection&quot;/&gt;</span>
<a href="#l23.122"></a><span id="l23.122" class="difflineplus">+    &lt;treecols&gt;</span>
<a href="#l23.123"></a><span id="l23.123" class="difflineplus">+      &lt;treecol id=&quot;title&quot; flex=&quot;1&quot; primary=&quot;true&quot; hideheader=&quot;true&quot;/&gt;</span>
<a href="#l23.124"></a><span id="l23.124">     &lt;/treecols&gt;</span>
<a href="#l23.125"></a><span id="l23.125" class="difflineminus">-    &lt;treechildren class=&quot;sidebar-placesTreechildren&quot; flex=&quot;1&quot;/&gt;</span>
<a href="#l23.126"></a><span id="l23.126" class="difflineplus">+    &lt;treechildren class=&quot;sidebar-placesTreechildren&quot; flex=&quot;1&quot; tooltip=&quot;bhTooltip&quot;/&gt;</span>
<a href="#l23.127"></a><span id="l23.127">   &lt;/tree&gt;</span>
<a href="#l23.128"></a><span id="l23.128"> &lt;/page&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/suite/common/places/content/menu.xml</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/suite/common/places/content/menu.xml</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -21,48 +21,44 @@</span>
<a href="#l24.4"></a><span id="l24.4">                             smoothscroll=&quot;false&quot;&gt;</span>
<a href="#l24.5"></a><span id="l24.5">           &lt;children/&gt;</span>
<a href="#l24.6"></a><span id="l24.6">         &lt;/xul:arrowscrollbox&gt;</span>
<a href="#l24.7"></a><span id="l24.7">       &lt;/xul:hbox&gt;</span>
<a href="#l24.8"></a><span id="l24.8">     &lt;/content&gt;</span>
<a href="#l24.9"></a><span id="l24.9"> </span>
<a href="#l24.10"></a><span id="l24.10">     &lt;implementation&gt;</span>
<a href="#l24.11"></a><span id="l24.11"> </span>
<a href="#l24.12"></a><span id="l24.12" class="difflineplus">+      &lt;field name=&quot;AppConstants&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l24.13"></a><span id="l24.13" class="difflineplus">+        (ChromeUtils.import(&quot;resource://gre/modules/AppConstants.jsm&quot;, {})).AppConstants;</span>
<a href="#l24.14"></a><span id="l24.14" class="difflineplus">+      &lt;/field&gt;</span>
<a href="#l24.15"></a><span id="l24.15" class="difflineplus">+</span>
<a href="#l24.16"></a><span id="l24.16">       &lt;field name=&quot;_indicatorBar&quot;&gt;</span>
<a href="#l24.17"></a><span id="l24.17">         document.getAnonymousElementByAttribute(this, &quot;class&quot;,</span>
<a href="#l24.18"></a><span id="l24.18">                                                 &quot;menupopup-drop-indicator-bar&quot;);</span>
<a href="#l24.19"></a><span id="l24.19">       &lt;/field&gt;</span>
<a href="#l24.20"></a><span id="l24.20"> </span>
<a href="#l24.21"></a><span id="l24.21">       &lt;field name=&quot;_scrollBox&quot;&gt;</span>
<a href="#l24.22"></a><span id="l24.22">         document.getAnonymousElementByAttribute(this, &quot;class&quot;,</span>
<a href="#l24.23"></a><span id="l24.23">                                                 &quot;popup-internal-box&quot;);</span>
<a href="#l24.24"></a><span id="l24.24">       &lt;/field&gt;</span>
<a href="#l24.25"></a><span id="l24.25"> </span>
<a href="#l24.26"></a><span id="l24.26" class="difflineminus">-      &lt;!-- markers for start and end of valid places items --&gt;</span>
<a href="#l24.27"></a><span id="l24.27" class="difflineminus">-      &lt;field name=&quot;_startMarker&quot;&gt;-1&lt;/field&gt;</span>
<a href="#l24.28"></a><span id="l24.28" class="difflineminus">-      &lt;field name=&quot;_endMarker&quot;&gt;-1&lt;/field&gt;</span>
<a href="#l24.29"></a><span id="l24.29" class="difflineminus">-</span>
<a href="#l24.30"></a><span id="l24.30">       &lt;!-- This is the view that manage the popup --&gt;</span>
<a href="#l24.31"></a><span id="l24.31">       &lt;field name=&quot;_rootView&quot;&gt;PlacesUIUtils.getViewForNode(this);&lt;/field&gt;</span>
<a href="#l24.32"></a><span id="l24.32"> </span>
<a href="#l24.33"></a><span id="l24.33">       &lt;!-- Check if we should hide the drop indicator for the target --&gt;</span>
<a href="#l24.34"></a><span id="l24.34">       &lt;method name=&quot;_hideDropIndicator&quot;&gt;</span>
<a href="#l24.35"></a><span id="l24.35">         &lt;parameter name=&quot;aEvent&quot;/&gt;</span>
<a href="#l24.36"></a><span id="l24.36">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l24.37"></a><span id="l24.37" class="difflineminus">-          var target = aEvent.target;</span>
<a href="#l24.38"></a><span id="l24.38" class="difflineplus">+          let target = aEvent.target;</span>
<a href="#l24.39"></a><span id="l24.39"> </span>
<a href="#l24.40"></a><span id="l24.40" class="difflineminus">-          // in some view we have _startMarker and _endMarker, we should not</span>
<a href="#l24.41"></a><span id="l24.41" class="difflineminus">-          // draw the drop indicator outside of them</span>
<a href="#l24.42"></a><span id="l24.42" class="difflineminus">-          var betweenMarkers = true;</span>
<a href="#l24.43"></a><span id="l24.43" class="difflineminus">-          if (this._startMarker != -1 &amp;&amp;</span>
<a href="#l24.44"></a><span id="l24.44" class="difflineminus">-              target.boxObject.y &lt;= this.childNodes[this._startMarker].boxObject.y)</span>
<a href="#l24.45"></a><span id="l24.45" class="difflineminus">-            betweenMarkers = false;</span>
<a href="#l24.46"></a><span id="l24.46" class="difflineminus">-          if (this._endMarker != -1 &amp;&amp;</span>
<a href="#l24.47"></a><span id="l24.47" class="difflineminus">-              target.boxObject.y &gt;= this.childNodes[this._endMarker].boxObject.y)</span>
<a href="#l24.48"></a><span id="l24.48" class="difflineminus">-            betweenMarkers = false;</span>
<a href="#l24.49"></a><span id="l24.49" class="difflineplus">+          // Don't draw the drop indicator outside of markers or if current</span>
<a href="#l24.50"></a><span id="l24.50" class="difflineplus">+          // node is not a Places node.</span>
<a href="#l24.51"></a><span id="l24.51" class="difflineplus">+          let betweenMarkers =</span>
<a href="#l24.52"></a><span id="l24.52" class="difflineplus">+            (this._startMarker.compareDocumentPosition(target) &amp; Node.DOCUMENT_POSITION_FOLLOWING) &amp;&amp;</span>
<a href="#l24.53"></a><span id="l24.53" class="difflineplus">+            (this._endMarker.compareDocumentPosition(target) &amp; Node.DOCUMENT_POSITION_PRECEDING);</span>
<a href="#l24.54"></a><span id="l24.54"> </span>
<a href="#l24.55"></a><span id="l24.55">           // Hide the dropmarker if current node is not a Places node.</span>
<a href="#l24.56"></a><span id="l24.56">           return !(target &amp;&amp; target._placesNode &amp;&amp; betweenMarkers);</span>
<a href="#l24.57"></a><span id="l24.57">         ]]&gt;&lt;/body&gt;</span>
<a href="#l24.58"></a><span id="l24.58">       &lt;/method&gt;</span>
<a href="#l24.59"></a><span id="l24.59"> </span>
<a href="#l24.60"></a><span id="l24.60">       &lt;!-- This function returns information about where to drop when</span>
<a href="#l24.61"></a><span id="l24.61">            dragging over this popup insertion point --&gt;</span>
<a href="#l24.62"></a><span id="l24.62" class="difflineat">@@ -80,18 +76,18 @@</span>
<a href="#l24.63"></a><span id="l24.63">             var dropPoint = { ip: null, folderElt: null };</span>
<a href="#l24.64"></a><span id="l24.64"> </span>
<a href="#l24.65"></a><span id="l24.65">             // The element we are dragging over</span>
<a href="#l24.66"></a><span id="l24.66">             let elt = aEvent.target;</span>
<a href="#l24.67"></a><span id="l24.67">             if (elt.localName == &quot;menupopup&quot;)</span>
<a href="#l24.68"></a><span id="l24.68">               elt = elt.parentNode;</span>
<a href="#l24.69"></a><span id="l24.69"> </span>
<a href="#l24.70"></a><span id="l24.70">             // Calculate positions taking care of arrowscrollbox</span>
<a href="#l24.71"></a><span id="l24.71" class="difflineminus">-            let eventY = aEvent.layerY;</span>
<a href="#l24.72"></a><span id="l24.72">             let scrollbox = this._scrollBox;</span>
<a href="#l24.73"></a><span id="l24.73" class="difflineplus">+            let eventY = aEvent.layerY + (scrollbox.boxObject.y - this.boxObject.y);</span>
<a href="#l24.74"></a><span id="l24.74">             let scrollboxOffset = scrollbox.scrollBoxObject.y -</span>
<a href="#l24.75"></a><span id="l24.75">                                   (scrollbox.boxObject.y - this.boxObject.y);</span>
<a href="#l24.76"></a><span id="l24.76">             let eltY = elt.boxObject.y - scrollboxOffset;</span>
<a href="#l24.77"></a><span id="l24.77">             let eltHeight = elt.boxObject.height;</span>
<a href="#l24.78"></a><span id="l24.78"> </span>
<a href="#l24.79"></a><span id="l24.79">             if (!elt._placesNode) {</span>
<a href="#l24.80"></a><span id="l24.80">               // If we are dragging over a non places node drop at the end.</span>
<a href="#l24.81"></a><span id="l24.81">               dropPoint.ip = new InsertionPoint(</span>
<a href="#l24.82"></a><span id="l24.82" class="difflineat">@@ -103,59 +99,60 @@</span>
<a href="#l24.83"></a><span id="l24.83">               let isMenu = elt.localName == &quot;menu&quot; ||</span>
<a href="#l24.84"></a><span id="l24.84">                  (elt.localName == &quot;toolbarbutton&quot; &amp;&amp;</span>
<a href="#l24.85"></a><span id="l24.85">                   elt.getAttribute(&quot;type&quot;) == &quot;menu&quot;);</span>
<a href="#l24.86"></a><span id="l24.86">               if (isMenu &amp;&amp; elt.lastChild &amp;&amp;</span>
<a href="#l24.87"></a><span id="l24.87">                   elt.lastChild.hasAttribute(&quot;placespopup&quot;))</span>
<a href="#l24.88"></a><span id="l24.88">                 dropPoint.folderElt = elt;</span>
<a href="#l24.89"></a><span id="l24.89">               return dropPoint;</span>
<a href="#l24.90"></a><span id="l24.90">             }</span>
<a href="#l24.91"></a><span id="l24.91" class="difflineminus">-            else if ((PlacesUtils.nodeIsFolder(elt._placesNode) &amp;&amp;</span>
<a href="#l24.92"></a><span id="l24.92" class="difflineminus">-                      !PlacesUIUtils.isContentsReadOnly(elt._placesNode)) ||</span>
<a href="#l24.93"></a><span id="l24.93" class="difflineminus">-                     PlacesUtils.nodeIsTagQuery(elt._placesNode)) {</span>
<a href="#l24.94"></a><span id="l24.94" class="difflineplus">+</span>
<a href="#l24.95"></a><span id="l24.95" class="difflineplus">+            let tagName = PlacesUtils.nodeIsTagQuery(elt._placesNode) ?</span>
<a href="#l24.96"></a><span id="l24.96" class="difflineplus">+                            elt._placesNode.title : null;</span>
<a href="#l24.97"></a><span id="l24.97" class="difflineplus">+            if ((PlacesUtils.nodeIsFolder(elt._placesNode) &amp;&amp;</span>
<a href="#l24.98"></a><span id="l24.98" class="difflineplus">+                 !PlacesUIUtils.isContentsReadOnly(elt._placesNode)) ||</span>
<a href="#l24.99"></a><span id="l24.99" class="difflineplus">+                PlacesUtils.nodeIsTagQuery(elt._placesNode)) {</span>
<a href="#l24.100"></a><span id="l24.100">               // This is a folder or a tag container.</span>
<a href="#l24.101"></a><span id="l24.101">               if (eventY - eltY &lt; eltHeight * 0.20) {</span>
<a href="#l24.102"></a><span id="l24.102">                 // If mouse is in the top part of the element, drop above folder.</span>
<a href="#l24.103"></a><span id="l24.103">                 dropPoint.ip = new InsertionPoint(</span>
<a href="#l24.104"></a><span id="l24.104">                                     PlacesUtils.getConcreteItemId(resultNode),</span>
<a href="#l24.105"></a><span id="l24.105">                                     -1,</span>
<a href="#l24.106"></a><span id="l24.106">                                     Ci.nsITreeView.DROP_BEFORE,</span>
<a href="#l24.107"></a><span id="l24.107" class="difflineminus">-                                    PlacesUtils.nodeIsTagQuery(elt._placesNode),</span>
<a href="#l24.108"></a><span id="l24.108" class="difflineplus">+                                    tagName,</span>
<a href="#l24.109"></a><span id="l24.109">                                     elt._placesNode.itemId);</span>
<a href="#l24.110"></a><span id="l24.110">                 return dropPoint;</span>
<a href="#l24.111"></a><span id="l24.111" class="difflineminus">-              }</span>
<a href="#l24.112"></a><span id="l24.112" class="difflineminus">-              else if (eventY - eltY &lt; eltHeight * 0.80) {</span>
<a href="#l24.113"></a><span id="l24.113" class="difflineplus">+              } else if (eventY - eltY &lt; eltHeight * 0.80) {</span>
<a href="#l24.114"></a><span id="l24.114">                 // If mouse is in the middle of the element, drop inside folder.</span>
<a href="#l24.115"></a><span id="l24.115">                 dropPoint.ip = new InsertionPoint(</span>
<a href="#l24.116"></a><span id="l24.116">                                     PlacesUtils.getConcreteItemId(elt._placesNode),</span>
<a href="#l24.117"></a><span id="l24.117">                                     -1,</span>
<a href="#l24.118"></a><span id="l24.118">                                     Ci.nsITreeView.DROP_ON,</span>
<a href="#l24.119"></a><span id="l24.119" class="difflineminus">-                                    PlacesUtils.nodeIsTagQuery(elt._placesNode));</span>
<a href="#l24.120"></a><span id="l24.120" class="difflineplus">+                                    tagName);</span>
<a href="#l24.121"></a><span id="l24.121">                 dropPoint.folderElt = elt;</span>
<a href="#l24.122"></a><span id="l24.122">                 return dropPoint;</span>
<a href="#l24.123"></a><span id="l24.123">               }</span>
<a href="#l24.124"></a><span id="l24.124" class="difflineminus">-            }</span>
<a href="#l24.125"></a><span id="l24.125" class="difflineminus">-            else if (eventY - eltY &lt;= eltHeight / 2) {</span>
<a href="#l24.126"></a><span id="l24.126" class="difflineplus">+            } else if (eventY - eltY &lt;= eltHeight / 2) {</span>
<a href="#l24.127"></a><span id="l24.127">               // This is a non-folder node or a readonly folder.</span>
<a href="#l24.128"></a><span id="l24.128">               // If the mouse is above the middle, drop above this item.</span>
<a href="#l24.129"></a><span id="l24.129">               dropPoint.ip = new InsertionPoint(</span>
<a href="#l24.130"></a><span id="l24.130">                                   PlacesUtils.getConcreteItemId(resultNode),</span>
<a href="#l24.131"></a><span id="l24.131">                                   -1,</span>
<a href="#l24.132"></a><span id="l24.132">                                   Ci.nsITreeView.DROP_BEFORE,</span>
<a href="#l24.133"></a><span id="l24.133" class="difflineminus">-                                  PlacesUtils.nodeIsTagQuery(elt._placesNode),</span>
<a href="#l24.134"></a><span id="l24.134" class="difflineplus">+                                  tagName,</span>
<a href="#l24.135"></a><span id="l24.135">                                   elt._placesNode.itemId);</span>
<a href="#l24.136"></a><span id="l24.136">               return dropPoint;</span>
<a href="#l24.137"></a><span id="l24.137">             }</span>
<a href="#l24.138"></a><span id="l24.138"> </span>
<a href="#l24.139"></a><span id="l24.139">             // Drop below the item.</span>
<a href="#l24.140"></a><span id="l24.140">             dropPoint.ip = new InsertionPoint(</span>
<a href="#l24.141"></a><span id="l24.141">                                 PlacesUtils.getConcreteItemId(resultNode),</span>
<a href="#l24.142"></a><span id="l24.142">                                 -1,</span>
<a href="#l24.143"></a><span id="l24.143">                                 Ci.nsITreeView.DROP_AFTER,</span>
<a href="#l24.144"></a><span id="l24.144" class="difflineminus">-                                PlacesUtils.nodeIsTagQuery(elt._placesNode),</span>
<a href="#l24.145"></a><span id="l24.145" class="difflineplus">+                                tagName,</span>
<a href="#l24.146"></a><span id="l24.146">                                 elt._placesNode.itemId);</span>
<a href="#l24.147"></a><span id="l24.147">             return dropPoint;</span>
<a href="#l24.148"></a><span id="l24.148">         ]]&gt;&lt;/body&gt;</span>
<a href="#l24.149"></a><span id="l24.149">       &lt;/method&gt;</span>
<a href="#l24.150"></a><span id="l24.150"> </span>
<a href="#l24.151"></a><span id="l24.151">       &lt;!-- Sub-menus should be opened when the mouse drags over them, and closed</span>
<a href="#l24.152"></a><span id="l24.152">            when the mouse drags off.  The overFolder object manages opening and</span>
<a href="#l24.153"></a><span id="l24.153">            closing of folders when the mouse hovers. --&gt;</span>
<a href="#l24.154"></a><span id="l24.154" class="difflineat">@@ -198,50 +195,45 @@</span>
<a href="#l24.155"></a><span id="l24.155">         get closeMenuTimer() {</span>
<a href="#l24.156"></a><span id="l24.156">           return this._closeMenuTimer;</span>
<a href="#l24.157"></a><span id="l24.157">         },</span>
<a href="#l24.158"></a><span id="l24.158">         set closeMenuTimer(val) {</span>
<a href="#l24.159"></a><span id="l24.159">           return this._closeMenuTimer = val;</span>
<a href="#l24.160"></a><span id="l24.160">         },</span>
<a href="#l24.161"></a><span id="l24.161"> </span>
<a href="#l24.162"></a><span id="l24.162">         setTimer: function OF__setTimer(aTime) {</span>
<a href="#l24.163"></a><span id="l24.163" class="difflineminus">-          var timer = Cc[&quot;@mozilla.org/timer;1&quot;]</span>
<a href="#l24.164"></a><span id="l24.164" class="difflineminus">-                        .createInstance(Ci.nsITimer);</span>
<a href="#l24.165"></a><span id="l24.165" class="difflineplus">+          var timer = Cc[&quot;@mozilla.org/timer;1&quot;].createInstance(Ci.nsITimer);</span>
<a href="#l24.166"></a><span id="l24.166">           timer.initWithCallback(this, aTime, timer.TYPE_ONE_SHOT);</span>
<a href="#l24.167"></a><span id="l24.167">           return timer;</span>
<a href="#l24.168"></a><span id="l24.168">         },</span>
<a href="#l24.169"></a><span id="l24.169"> </span>
<a href="#l24.170"></a><span id="l24.170">         notify: function OF__notify(aTimer) {</span>
<a href="#l24.171"></a><span id="l24.171">           // Function to process all timer notifications.</span>
<a href="#l24.172"></a><span id="l24.172"> </span>
<a href="#l24.173"></a><span id="l24.173">           if (aTimer == this._folder.openTimer) {</span>
<a href="#l24.174"></a><span id="l24.174">             // Timer to open a submenu that's being dragged over.</span>
<a href="#l24.175"></a><span id="l24.175">             this._folder.elt.lastChild.setAttribute(&quot;autoopened&quot;, &quot;true&quot;);</span>
<a href="#l24.176"></a><span id="l24.176">             this._folder.elt.lastChild.showPopup(this._folder.elt);</span>
<a href="#l24.177"></a><span id="l24.177">             this._folder.openTimer = null;</span>
<a href="#l24.178"></a><span id="l24.178" class="difflineminus">-          }</span>
<a href="#l24.179"></a><span id="l24.179" class="difflineminus">-</span>
<a href="#l24.180"></a><span id="l24.180" class="difflineminus">-          else if (aTimer == this._folder.closeTimer) {</span>
<a href="#l24.181"></a><span id="l24.181" class="difflineplus">+          } else if (aTimer == this._folder.closeTimer) {</span>
<a href="#l24.182"></a><span id="l24.182">             // Timer to close a submenu that's been dragged off of.</span>
<a href="#l24.183"></a><span id="l24.183">             // Only close the submenu if the mouse isn't being dragged over any</span>
<a href="#l24.184"></a><span id="l24.184">             // of its child menus.</span>
<a href="#l24.185"></a><span id="l24.185">             var draggingOverChild = PlacesControllerDragHelper</span>
<a href="#l24.186"></a><span id="l24.186">                                     .draggingOverChildNode(this._folder.elt);</span>
<a href="#l24.187"></a><span id="l24.187">             if (draggingOverChild)</span>
<a href="#l24.188"></a><span id="l24.188">               this._folder.elt = null;</span>
<a href="#l24.189"></a><span id="l24.189">             this.clear();</span>
<a href="#l24.190"></a><span id="l24.190"> </span>
<a href="#l24.191"></a><span id="l24.191">             // Close any parent folders which aren't being dragged over.</span>
<a href="#l24.192"></a><span id="l24.192">             // (This is necessary because of the above code that keeps a folder</span>
<a href="#l24.193"></a><span id="l24.193">             // open while its children are being dragged over.)</span>
<a href="#l24.194"></a><span id="l24.194">             if (!draggingOverChild)</span>
<a href="#l24.195"></a><span id="l24.195">               this.closeParentMenus();</span>
<a href="#l24.196"></a><span id="l24.196" class="difflineminus">-          }</span>
<a href="#l24.197"></a><span id="l24.197" class="difflineminus">-</span>
<a href="#l24.198"></a><span id="l24.198" class="difflineminus">-          else if (aTimer == this.closeMenuTimer) {</span>
<a href="#l24.199"></a><span id="l24.199" class="difflineplus">+          } else if (aTimer == this.closeMenuTimer) {</span>
<a href="#l24.200"></a><span id="l24.200">             // Timer to close this menu after the drag exit.</span>
<a href="#l24.201"></a><span id="l24.201">             var popup = this._self;</span>
<a href="#l24.202"></a><span id="l24.202">             // if we are no more dragging we can leave the menu open to allow</span>
<a href="#l24.203"></a><span id="l24.203">             // for better D&amp;D bookmark organization</span>
<a href="#l24.204"></a><span id="l24.204">             if (PlacesControllerDragHelper.getSession() &amp;&amp;</span>
<a href="#l24.205"></a><span id="l24.205">                 !PlacesControllerDragHelper.draggingOverChildNode(popup.parentNode)) {</span>
<a href="#l24.206"></a><span id="l24.206">               popup.hidePopup();</span>
<a href="#l24.207"></a><span id="l24.207">               // Close any parent menus that aren't being dragged over;</span>
<a href="#l24.208"></a><span id="l24.208" class="difflineat">@@ -305,31 +297,30 @@</span>
<a href="#l24.209"></a><span id="l24.209">     &lt;/implementation&gt;</span>
<a href="#l24.210"></a><span id="l24.210"> </span>
<a href="#l24.211"></a><span id="l24.211">     &lt;handlers&gt;</span>
<a href="#l24.212"></a><span id="l24.212">       &lt;handler event=&quot;DOMMenuItemActive&quot;&gt;&lt;![CDATA[</span>
<a href="#l24.213"></a><span id="l24.213">         let elt = event.target;</span>
<a href="#l24.214"></a><span id="l24.214">         if (elt.parentNode != this)</span>
<a href="#l24.215"></a><span id="l24.215">           return;</span>
<a href="#l24.216"></a><span id="l24.216"> </span>
<a href="#l24.217"></a><span id="l24.217" class="difflineminus">-#ifdef XP_MACOSX</span>
<a href="#l24.218"></a><span id="l24.218" class="difflineminus">-        // XXX: The following check is a temporary hack until bug 420033 is</span>
<a href="#l24.219"></a><span id="l24.219" class="difflineminus">-        // resolved.</span>
<a href="#l24.220"></a><span id="l24.220" class="difflineminus">-        let parentElt = elt.parent;</span>
<a href="#l24.221"></a><span id="l24.221" class="difflineminus">-        while (parentElt) {</span>
<a href="#l24.222"></a><span id="l24.222" class="difflineminus">-          if (parentElt.id == &quot;bookmarksMenuPopup&quot; ||</span>
<a href="#l24.223"></a><span id="l24.223" class="difflineminus">-              parentElt.id == &quot;goPopup&quot;)</span>
<a href="#l24.224"></a><span id="l24.224" class="difflineminus">-            return;</span>
<a href="#l24.225"></a><span id="l24.225" class="difflineplus">+        if (this.AppConstants.platform === &quot;macosx&quot;) {</span>
<a href="#l24.226"></a><span id="l24.226" class="difflineplus">+          // XXX: The following check is a temporary hack until bug 420033 is</span>
<a href="#l24.227"></a><span id="l24.227" class="difflineplus">+          // resolved.</span>
<a href="#l24.228"></a><span id="l24.228" class="difflineplus">+          let parentElt = elt.parent;</span>
<a href="#l24.229"></a><span id="l24.229" class="difflineplus">+          while (parentElt) {</span>
<a href="#l24.230"></a><span id="l24.230" class="difflineplus">+            if (parentElt.id == &quot;bookmarksMenuPopup&quot; ||</span>
<a href="#l24.231"></a><span id="l24.231" class="difflineplus">+                parentElt.id == &quot;goPopup&quot;)</span>
<a href="#l24.232"></a><span id="l24.232" class="difflineplus">+              return;</span>
<a href="#l24.233"></a><span id="l24.233"> </span>
<a href="#l24.234"></a><span id="l24.234" class="difflineminus">-          parentElt = parentElt.parentNode;</span>
<a href="#l24.235"></a><span id="l24.235" class="difflineplus">+            parentElt = parentElt.parentNode;</span>
<a href="#l24.236"></a><span id="l24.236" class="difflineplus">+          }</span>
<a href="#l24.237"></a><span id="l24.237">         }</span>
<a href="#l24.238"></a><span id="l24.238" class="difflineminus">-#endif</span>
<a href="#l24.239"></a><span id="l24.239"> </span>
<a href="#l24.240"></a><span id="l24.240">         if (window.XULBrowserWindow) {</span>
<a href="#l24.241"></a><span id="l24.241" class="difflineminus">-          let elt = event.target;</span>
<a href="#l24.242"></a><span id="l24.242">           let placesNode = elt._placesNode;</span>
<a href="#l24.243"></a><span id="l24.243"> </span>
<a href="#l24.244"></a><span id="l24.244">           var linkURI;</span>
<a href="#l24.245"></a><span id="l24.245">           if (placesNode &amp;&amp; PlacesUtils.nodeIsURI(placesNode))</span>
<a href="#l24.246"></a><span id="l24.246">             linkURI = placesNode.uri;</span>
<a href="#l24.247"></a><span id="l24.247">           else if (elt.hasAttribute(&quot;targetURI&quot;))</span>
<a href="#l24.248"></a><span id="l24.248">             linkURI = elt.getAttribute(&quot;targetURI&quot;);</span>
<a href="#l24.249"></a><span id="l24.249"> </span>
<a href="#l24.250"></a><span id="l24.250" class="difflineat">@@ -343,39 +334,41 @@</span>
<a href="#l24.251"></a><span id="l24.251">         if (elt.parentNode != this)</span>
<a href="#l24.252"></a><span id="l24.252">           return;</span>
<a href="#l24.253"></a><span id="l24.253"> </span>
<a href="#l24.254"></a><span id="l24.254">         if (window.XULBrowserWindow)</span>
<a href="#l24.255"></a><span id="l24.255">           window.XULBrowserWindow.setOverLink(&quot;&quot;, null);</span>
<a href="#l24.256"></a><span id="l24.256">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l24.257"></a><span id="l24.257"> </span>
<a href="#l24.258"></a><span id="l24.258">       &lt;handler event=&quot;dragstart&quot;&gt;&lt;![CDATA[</span>
<a href="#l24.259"></a><span id="l24.259" class="difflineminus">-        if (!event.target._placesNode)</span>
<a href="#l24.260"></a><span id="l24.260" class="difflineplus">+        let elt = event.target;</span>
<a href="#l24.261"></a><span id="l24.261" class="difflineplus">+        if (!elt._placesNode)</span>
<a href="#l24.262"></a><span id="l24.262">           return;</span>
<a href="#l24.263"></a><span id="l24.263"> </span>
<a href="#l24.264"></a><span id="l24.264" class="difflineminus">-        let draggedElt = event.target._placesNode;</span>
<a href="#l24.265"></a><span id="l24.265" class="difflineplus">+        let draggedElt = elt._placesNode;</span>
<a href="#l24.266"></a><span id="l24.266"> </span>
<a href="#l24.267"></a><span id="l24.267">         // Force a copy action if parent node is a query or we are dragging a</span>
<a href="#l24.268"></a><span id="l24.268">         // not-removable node.</span>
<a href="#l24.269"></a><span id="l24.269" class="difflineminus">-        if (!PlacesControllerDragHelper.canMoveNode(draggedElt))</span>
<a href="#l24.270"></a><span id="l24.270" class="difflineplus">+        if (!PlacesControllerDragHelper.canMoveNode(draggedElt, elt))</span>
<a href="#l24.271"></a><span id="l24.271">           event.dataTransfer.effectAllowed = &quot;copyLink&quot;;</span>
<a href="#l24.272"></a><span id="l24.272"> </span>
<a href="#l24.273"></a><span id="l24.273">         // Activate the view and cache the dragged element.</span>
<a href="#l24.274"></a><span id="l24.274">         this._rootView._draggedElt = draggedElt;</span>
<a href="#l24.275"></a><span id="l24.275">         this._rootView.controller.setDataTransfer(event);</span>
<a href="#l24.276"></a><span id="l24.276">         this.setAttribute(&quot;dragstart&quot;, &quot;true&quot;);</span>
<a href="#l24.277"></a><span id="l24.277">         event.stopPropagation();</span>
<a href="#l24.278"></a><span id="l24.278">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l24.279"></a><span id="l24.279"> </span>
<a href="#l24.280"></a><span id="l24.280">       &lt;handler event=&quot;drop&quot;&gt;&lt;![CDATA[</span>
<a href="#l24.281"></a><span id="l24.281">         PlacesControllerDragHelper.currentDropTarget = event.target;</span>
<a href="#l24.282"></a><span id="l24.282"> </span>
<a href="#l24.283"></a><span id="l24.283">         let dropPoint = this._getDropPoint(event);</span>
<a href="#l24.284"></a><span id="l24.284">         if (dropPoint &amp;&amp; dropPoint.ip) {</span>
<a href="#l24.285"></a><span id="l24.285" class="difflineminus">-          PlacesControllerDragHelper.onDrop(dropPoint.ip, event.dataTransfer);</span>
<a href="#l24.286"></a><span id="l24.286" class="difflineplus">+          PlacesControllerDragHelper.onDrop(dropPoint.ip, event.dataTransfer)</span>
<a href="#l24.287"></a><span id="l24.287" class="difflineplus">+                                    .catch(Cu.reportError);</span>
<a href="#l24.288"></a><span id="l24.288">           event.preventDefault();</span>
<a href="#l24.289"></a><span id="l24.289">         }</span>
<a href="#l24.290"></a><span id="l24.290"> </span>
<a href="#l24.291"></a><span id="l24.291">         this._cleanupDragDetails();</span>
<a href="#l24.292"></a><span id="l24.292">         event.stopPropagation();</span>
<a href="#l24.293"></a><span id="l24.293">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l24.294"></a><span id="l24.294"> </span>
<a href="#l24.295"></a><span id="l24.295">       &lt;handler event=&quot;dragover&quot;&gt;&lt;![CDATA[</span>
<a href="#l24.296"></a><span id="l24.296" class="difflineat">@@ -404,27 +397,30 @@</span>
<a href="#l24.297"></a><span id="l24.297">           if (!this._overFolder.elt) {</span>
<a href="#l24.298"></a><span id="l24.298">             this._overFolder.elt = dropPoint.folderElt;</span>
<a href="#l24.299"></a><span id="l24.299">             // Create the timer to open this folder.</span>
<a href="#l24.300"></a><span id="l24.300">             this._overFolder.openTimer = this._overFolder</span>
<a href="#l24.301"></a><span id="l24.301">                                              .setTimer(this._overFolder.hoverTime);</span>
<a href="#l24.302"></a><span id="l24.302">           }</span>
<a href="#l24.303"></a><span id="l24.303">           // Since we are dropping into a folder set the corresponding style.</span>
<a href="#l24.304"></a><span id="l24.304">           dropPoint.folderElt.setAttribute(&quot;_moz-menuactive&quot;, true);</span>
<a href="#l24.305"></a><span id="l24.305" class="difflineminus">-        }</span>
<a href="#l24.306"></a><span id="l24.306" class="difflineminus">-        else {</span>
<a href="#l24.307"></a><span id="l24.307" class="difflineplus">+        } else {</span>
<a href="#l24.308"></a><span id="l24.308">           // We are not dragging over a folder.</span>
<a href="#l24.309"></a><span id="l24.309">           // Clear out old _overFolder information.</span>
<a href="#l24.310"></a><span id="l24.310">           this._overFolder.clear();</span>
<a href="#l24.311"></a><span id="l24.311">         }</span>
<a href="#l24.312"></a><span id="l24.312"> </span>
<a href="#l24.313"></a><span id="l24.313">         // Autoscroll the popup strip if we drag over the scroll buttons.</span>
<a href="#l24.314"></a><span id="l24.314" class="difflineminus">-        let anonid = event.originalTarget.getAttribute('anonid');</span>
<a href="#l24.315"></a><span id="l24.315" class="difflineminus">-        let scrollDir = anonid == &quot;scrollbutton-up&quot; ? -1 :</span>
<a href="#l24.316"></a><span id="l24.316" class="difflineminus">-                        anonid == &quot;scrollbutton-down&quot; ? 1 : 0;</span>
<a href="#l24.317"></a><span id="l24.317" class="difflineplus">+        let anonid = event.originalTarget.getAttribute(&quot;anonid&quot;);</span>
<a href="#l24.318"></a><span id="l24.318" class="difflineplus">+        let scrollDir = 0;</span>
<a href="#l24.319"></a><span id="l24.319" class="difflineplus">+        if (anonid == &quot;scrollbutton-up&quot;) {</span>
<a href="#l24.320"></a><span id="l24.320" class="difflineplus">+          scrollDir = -1;</span>
<a href="#l24.321"></a><span id="l24.321" class="difflineplus">+        } else if (anonid == &quot;scrollbutton-down&quot;) {</span>
<a href="#l24.322"></a><span id="l24.322" class="difflineplus">+          scrollDir = 1;</span>
<a href="#l24.323"></a><span id="l24.323" class="difflineplus">+        }</span>
<a href="#l24.324"></a><span id="l24.324">         if (scrollDir != 0) {</span>
<a href="#l24.325"></a><span id="l24.325">           this._scrollBox.scrollByIndex(scrollDir, false);</span>
<a href="#l24.326"></a><span id="l24.326">         }</span>
<a href="#l24.327"></a><span id="l24.327"> </span>
<a href="#l24.328"></a><span id="l24.328">         // Check if we should hide the drop indicator for this target.</span>
<a href="#l24.329"></a><span id="l24.329">         if (dropPoint.folderElt || this._hideDropIndicator(event)) {</span>
<a href="#l24.330"></a><span id="l24.330">           this._indicatorBar.hidden = true;</span>
<a href="#l24.331"></a><span id="l24.331">           event.preventDefault();</span>
<a href="#l24.332"></a><span id="l24.332" class="difflineat">@@ -437,18 +433,17 @@</span>
<a href="#l24.333"></a><span id="l24.333">         let newMarginTop = 0;</span>
<a href="#l24.334"></a><span id="l24.334">         if (scrollDir == 0) {</span>
<a href="#l24.335"></a><span id="l24.335">           let elt = this.firstChild;</span>
<a href="#l24.336"></a><span id="l24.336">           while (elt &amp;&amp; event.screenY &gt; elt.boxObject.screenY +</span>
<a href="#l24.337"></a><span id="l24.337">                                         elt.boxObject.height / 2)</span>
<a href="#l24.338"></a><span id="l24.338">             elt = elt.nextSibling;</span>
<a href="#l24.339"></a><span id="l24.339">           newMarginTop = elt ? elt.boxObject.screenY - sbo.screenY :</span>
<a href="#l24.340"></a><span id="l24.340">                                sbo.height;</span>
<a href="#l24.341"></a><span id="l24.341" class="difflineminus">-        }</span>
<a href="#l24.342"></a><span id="l24.342" class="difflineminus">-        else if (scrollDir == 1)</span>
<a href="#l24.343"></a><span id="l24.343" class="difflineplus">+        } else if (scrollDir == 1)</span>
<a href="#l24.344"></a><span id="l24.344">           newMarginTop = sbo.height;</span>
<a href="#l24.345"></a><span id="l24.345"> </span>
<a href="#l24.346"></a><span id="l24.346">         // Set the new marginTop based on arrowscrollbox.</span>
<a href="#l24.347"></a><span id="l24.347">         newMarginTop += sbo.y - this._scrollBox.boxObject.y;</span>
<a href="#l24.348"></a><span id="l24.348">         this._indicatorBar.firstChild.style.marginTop = newMarginTop + &quot;px&quot;;</span>
<a href="#l24.349"></a><span id="l24.349">         this._indicatorBar.hidden = false;</span>
<a href="#l24.350"></a><span id="l24.350"> </span>
<a href="#l24.351"></a><span id="l24.351">         event.preventDefault();</span>
<a href="#l24.352"></a><span id="l24.352" class="difflineat">@@ -457,17 +452,17 @@</span>
<a href="#l24.353"></a><span id="l24.353"> </span>
<a href="#l24.354"></a><span id="l24.354">       &lt;handler event=&quot;dragexit&quot;&gt;&lt;![CDATA[</span>
<a href="#l24.355"></a><span id="l24.355">         PlacesControllerDragHelper.currentDropTarget = null;</span>
<a href="#l24.356"></a><span id="l24.356">         this.removeAttribute(&quot;dragover&quot;);</span>
<a href="#l24.357"></a><span id="l24.357"> </span>
<a href="#l24.358"></a><span id="l24.358">         // If we have not moved to a valid new target clear the drop indicator</span>
<a href="#l24.359"></a><span id="l24.359">         // this happens when moving out of the popup.</span>
<a href="#l24.360"></a><span id="l24.360">         let target = event.relatedTarget;</span>
<a href="#l24.361"></a><span id="l24.361" class="difflineminus">-        if (!target)</span>
<a href="#l24.362"></a><span id="l24.362" class="difflineplus">+        if (!target || !this.contains(target))</span>
<a href="#l24.363"></a><span id="l24.363">           this._indicatorBar.hidden = true;</span>
<a href="#l24.364"></a><span id="l24.364"> </span>
<a href="#l24.365"></a><span id="l24.365">         // Close any folder being hovered over</span>
<a href="#l24.366"></a><span id="l24.366">         if (this._overFolder.elt) {</span>
<a href="#l24.367"></a><span id="l24.367">           this._overFolder.closeTimer = this._overFolder</span>
<a href="#l24.368"></a><span id="l24.368">                                             .setTimer(this._overFolder.hoverTime);</span>
<a href="#l24.369"></a><span id="l24.369">         }</span>
<a href="#l24.370"></a><span id="l24.370"> </span>
<a href="#l24.371"></a><span id="l24.371" class="difflineat">@@ -486,9 +481,141 @@</span>
<a href="#l24.372"></a><span id="l24.372">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l24.373"></a><span id="l24.373"> </span>
<a href="#l24.374"></a><span id="l24.374">       &lt;handler event=&quot;dragend&quot;&gt;&lt;![CDATA[</span>
<a href="#l24.375"></a><span id="l24.375">         this._cleanupDragDetails();</span>
<a href="#l24.376"></a><span id="l24.376">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l24.377"></a><span id="l24.377"> </span>
<a href="#l24.378"></a><span id="l24.378">     &lt;/handlers&gt;</span>
<a href="#l24.379"></a><span id="l24.379">   &lt;/binding&gt;</span>
<a href="#l24.380"></a><span id="l24.380" class="difflineplus">+</span>
<a href="#l24.381"></a><span id="l24.381" class="difflineplus">+  &lt;!-- Most of this is copied from the arrowpanel binding in popup.xml --&gt;</span>
<a href="#l24.382"></a><span id="l24.382" class="difflineplus">+  &lt;binding id=&quot;places-popup-arrow&quot;</span>
<a href="#l24.383"></a><span id="l24.383" class="difflineplus">+           extends=&quot;chrome://communicator/content/places/menu.xml#places-popup-base&quot;&gt;</span>
<a href="#l24.384"></a><span id="l24.384" class="difflineplus">+    &lt;content flip=&quot;both&quot; side=&quot;top&quot; position=&quot;bottomcenter topright&quot;&gt;</span>
<a href="#l24.385"></a><span id="l24.385" class="difflineplus">+      &lt;xul:vbox anonid=&quot;container&quot; class=&quot;panel-arrowcontainer&quot; flex=&quot;1&quot;</span>
<a href="#l24.386"></a><span id="l24.386" class="difflineplus">+               xbl:inherits=&quot;side,panelopen&quot;&gt;</span>
<a href="#l24.387"></a><span id="l24.387" class="difflineplus">+        &lt;xul:box anonid=&quot;arrowbox&quot; class=&quot;panel-arrowbox&quot;&gt;</span>
<a href="#l24.388"></a><span id="l24.388" class="difflineplus">+          &lt;xul:image anonid=&quot;arrow&quot; class=&quot;panel-arrow&quot; xbl:inherits=&quot;side&quot;/&gt;</span>
<a href="#l24.389"></a><span id="l24.389" class="difflineplus">+        &lt;/xul:box&gt;</span>
<a href="#l24.390"></a><span id="l24.390" class="difflineplus">+        &lt;xul:box class=&quot;panel-arrowcontent&quot; xbl:inherits=&quot;side,align,dir,orient,pack&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l24.391"></a><span id="l24.391" class="difflineplus">+          &lt;xul:vbox class=&quot;menupopup-drop-indicator-bar&quot; hidden=&quot;true&quot;&gt;</span>
<a href="#l24.392"></a><span id="l24.392" class="difflineplus">+            &lt;xul:image class=&quot;menupopup-drop-indicator&quot; mousethrough=&quot;always&quot;/&gt;</span>
<a href="#l24.393"></a><span id="l24.393" class="difflineplus">+          &lt;/xul:vbox&gt;</span>
<a href="#l24.394"></a><span id="l24.394" class="difflineplus">+          &lt;xul:arrowscrollbox class=&quot;popup-internal-box&quot; flex=&quot;1&quot; orient=&quot;vertical&quot;</span>
<a href="#l24.395"></a><span id="l24.395" class="difflineplus">+                              smoothscroll=&quot;false&quot;&gt;</span>
<a href="#l24.396"></a><span id="l24.396" class="difflineplus">+            &lt;children/&gt;</span>
<a href="#l24.397"></a><span id="l24.397" class="difflineplus">+          &lt;/xul:arrowscrollbox&gt;</span>
<a href="#l24.398"></a><span id="l24.398" class="difflineplus">+        &lt;/xul:box&gt;</span>
<a href="#l24.399"></a><span id="l24.399" class="difflineplus">+      &lt;/xul:vbox&gt;</span>
<a href="#l24.400"></a><span id="l24.400" class="difflineplus">+    &lt;/content&gt;</span>
<a href="#l24.401"></a><span id="l24.401" class="difflineplus">+</span>
<a href="#l24.402"></a><span id="l24.402" class="difflineplus">+    &lt;implementation&gt;</span>
<a href="#l24.403"></a><span id="l24.403" class="difflineplus">+      &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l24.404"></a><span id="l24.404" class="difflineplus">+        this.style.pointerEvents = &quot;none&quot;;</span>
<a href="#l24.405"></a><span id="l24.405" class="difflineplus">+      ]]&gt;&lt;/constructor&gt;</span>
<a href="#l24.406"></a><span id="l24.406" class="difflineplus">+      &lt;method name=&quot;adjustArrowPosition&quot;&gt;</span>
<a href="#l24.407"></a><span id="l24.407" class="difflineplus">+        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l24.408"></a><span id="l24.408" class="difflineplus">+          var arrow = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;arrow&quot;);</span>
<a href="#l24.409"></a><span id="l24.409" class="difflineplus">+</span>
<a href="#l24.410"></a><span id="l24.410" class="difflineplus">+          var anchor = this.anchorNode;</span>
<a href="#l24.411"></a><span id="l24.411" class="difflineplus">+          if (!anchor) {</span>
<a href="#l24.412"></a><span id="l24.412" class="difflineplus">+            arrow.hidden = true;</span>
<a href="#l24.413"></a><span id="l24.413" class="difflineplus">+            return;</span>
<a href="#l24.414"></a><span id="l24.414" class="difflineplus">+          }</span>
<a href="#l24.415"></a><span id="l24.415" class="difflineplus">+</span>
<a href="#l24.416"></a><span id="l24.416" class="difflineplus">+          var container = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;container&quot;);</span>
<a href="#l24.417"></a><span id="l24.417" class="difflineplus">+          var arrowbox = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;arrowbox&quot;);</span>
<a href="#l24.418"></a><span id="l24.418" class="difflineplus">+</span>
<a href="#l24.419"></a><span id="l24.419" class="difflineplus">+          var position = this.alignmentPosition;</span>
<a href="#l24.420"></a><span id="l24.420" class="difflineplus">+          var offset = this.alignmentOffset;</span>
<a href="#l24.421"></a><span id="l24.421" class="difflineplus">+</span>
<a href="#l24.422"></a><span id="l24.422" class="difflineplus">+          this.setAttribute(&quot;arrowposition&quot;, position);</span>
<a href="#l24.423"></a><span id="l24.423" class="difflineplus">+</span>
<a href="#l24.424"></a><span id="l24.424" class="difflineplus">+          // if this panel has a &quot;sliding&quot; arrow, we may have previously set margins...</span>
<a href="#l24.425"></a><span id="l24.425" class="difflineplus">+          arrowbox.style.removeProperty(&quot;transform&quot;);</span>
<a href="#l24.426"></a><span id="l24.426" class="difflineplus">+          if (position.indexOf(&quot;start_&quot;) == 0 || position.indexOf(&quot;end_&quot;) == 0) {</span>
<a href="#l24.427"></a><span id="l24.427" class="difflineplus">+            container.orient = &quot;horizontal&quot;;</span>
<a href="#l24.428"></a><span id="l24.428" class="difflineplus">+            arrowbox.orient = &quot;vertical&quot;;</span>
<a href="#l24.429"></a><span id="l24.429" class="difflineplus">+            if (position.indexOf(&quot;_after&quot;) &gt; 0) {</span>
<a href="#l24.430"></a><span id="l24.430" class="difflineplus">+              arrowbox.pack = &quot;end&quot;;</span>
<a href="#l24.431"></a><span id="l24.431" class="difflineplus">+            } else {</span>
<a href="#l24.432"></a><span id="l24.432" class="difflineplus">+              arrowbox.pack = &quot;start&quot;;</span>
<a href="#l24.433"></a><span id="l24.433" class="difflineplus">+            }</span>
<a href="#l24.434"></a><span id="l24.434" class="difflineplus">+            arrowbox.style.transform = &quot;translate(0, &quot; + -offset + &quot;px)&quot;;</span>
<a href="#l24.435"></a><span id="l24.435" class="difflineplus">+</span>
<a href="#l24.436"></a><span id="l24.436" class="difflineplus">+            // The assigned side stays the same regardless of direction.</span>
<a href="#l24.437"></a><span id="l24.437" class="difflineplus">+            var isRTL = (window.getComputedStyle(this).direction == &quot;rtl&quot;);</span>
<a href="#l24.438"></a><span id="l24.438" class="difflineplus">+</span>
<a href="#l24.439"></a><span id="l24.439" class="difflineplus">+            if (position.indexOf(&quot;start_&quot;) == 0) {</span>
<a href="#l24.440"></a><span id="l24.440" class="difflineplus">+              container.dir = &quot;reverse&quot;;</span>
<a href="#l24.441"></a><span id="l24.441" class="difflineplus">+              this.setAttribute(&quot;side&quot;, isRTL ? &quot;left&quot; : &quot;right&quot;);</span>
<a href="#l24.442"></a><span id="l24.442" class="difflineplus">+            } else {</span>
<a href="#l24.443"></a><span id="l24.443" class="difflineplus">+              container.dir = &quot;&quot;;</span>
<a href="#l24.444"></a><span id="l24.444" class="difflineplus">+              this.setAttribute(&quot;side&quot;, isRTL ? &quot;right&quot; : &quot;left&quot;);</span>
<a href="#l24.445"></a><span id="l24.445" class="difflineplus">+            }</span>
<a href="#l24.446"></a><span id="l24.446" class="difflineplus">+          } else if (position.indexOf(&quot;before_&quot;) == 0 || position.indexOf(&quot;after_&quot;) == 0) {</span>
<a href="#l24.447"></a><span id="l24.447" class="difflineplus">+            container.orient = &quot;&quot;;</span>
<a href="#l24.448"></a><span id="l24.448" class="difflineplus">+            arrowbox.orient = &quot;&quot;;</span>
<a href="#l24.449"></a><span id="l24.449" class="difflineplus">+            if (position.indexOf(&quot;_end&quot;) &gt; 0) {</span>
<a href="#l24.450"></a><span id="l24.450" class="difflineplus">+              arrowbox.pack = &quot;end&quot;;</span>
<a href="#l24.451"></a><span id="l24.451" class="difflineplus">+            } else {</span>
<a href="#l24.452"></a><span id="l24.452" class="difflineplus">+              arrowbox.pack = &quot;start&quot;;</span>
<a href="#l24.453"></a><span id="l24.453" class="difflineplus">+            }</span>
<a href="#l24.454"></a><span id="l24.454" class="difflineplus">+            arrowbox.style.transform = &quot;translate(&quot; + -offset + &quot;px, 0)&quot;;</span>
<a href="#l24.455"></a><span id="l24.455" class="difflineplus">+</span>
<a href="#l24.456"></a><span id="l24.456" class="difflineplus">+            if (position.indexOf(&quot;before_&quot;) == 0) {</span>
<a href="#l24.457"></a><span id="l24.457" class="difflineplus">+              container.dir = &quot;reverse&quot;;</span>
<a href="#l24.458"></a><span id="l24.458" class="difflineplus">+              this.setAttribute(&quot;side&quot;, &quot;bottom&quot;);</span>
<a href="#l24.459"></a><span id="l24.459" class="difflineplus">+            } else {</span>
<a href="#l24.460"></a><span id="l24.460" class="difflineplus">+              container.dir = &quot;&quot;;</span>
<a href="#l24.461"></a><span id="l24.461" class="difflineplus">+              this.setAttribute(&quot;side&quot;, &quot;top&quot;);</span>
<a href="#l24.462"></a><span id="l24.462" class="difflineplus">+            }</span>
<a href="#l24.463"></a><span id="l24.463" class="difflineplus">+          }</span>
<a href="#l24.464"></a><span id="l24.464" class="difflineplus">+</span>
<a href="#l24.465"></a><span id="l24.465" class="difflineplus">+          arrow.hidden = false;</span>
<a href="#l24.466"></a><span id="l24.466" class="difflineplus">+        ]]&gt;&lt;/body&gt;</span>
<a href="#l24.467"></a><span id="l24.467" class="difflineplus">+      &lt;/method&gt;</span>
<a href="#l24.468"></a><span id="l24.468" class="difflineplus">+    &lt;/implementation&gt;</span>
<a href="#l24.469"></a><span id="l24.469" class="difflineplus">+</span>
<a href="#l24.470"></a><span id="l24.470" class="difflineplus">+    &lt;handlers&gt;</span>
<a href="#l24.471"></a><span id="l24.471" class="difflineplus">+      &lt;handler event=&quot;popupshowing&quot; phase=&quot;target&quot;&gt;&lt;![CDATA[</span>
<a href="#l24.472"></a><span id="l24.472" class="difflineplus">+        this.adjustArrowPosition();</span>
<a href="#l24.473"></a><span id="l24.473" class="difflineplus">+        this.setAttribute(&quot;animate&quot;, &quot;open&quot;);</span>
<a href="#l24.474"></a><span id="l24.474" class="difflineplus">+      ]]&gt;&lt;/handler&gt;</span>
<a href="#l24.475"></a><span id="l24.475" class="difflineplus">+      &lt;handler event=&quot;popupshown&quot; phase=&quot;target&quot;&gt;&lt;![CDATA[</span>
<a href="#l24.476"></a><span id="l24.476" class="difflineplus">+        this.setAttribute(&quot;panelopen&quot;, &quot;true&quot;);</span>
<a href="#l24.477"></a><span id="l24.477" class="difflineplus">+        let disablePointerEvents;</span>
<a href="#l24.478"></a><span id="l24.478" class="difflineplus">+        if (!this.hasAttribute(&quot;disablepointereventsfortransition&quot;)) {</span>
<a href="#l24.479"></a><span id="l24.479" class="difflineplus">+          let container = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;container&quot;);</span>
<a href="#l24.480"></a><span id="l24.480" class="difflineplus">+          let cs = getComputedStyle(container);</span>
<a href="#l24.481"></a><span id="l24.481" class="difflineplus">+          let transitionProp = cs.transitionProperty;</span>
<a href="#l24.482"></a><span id="l24.482" class="difflineplus">+          let transitionTime = parseFloat(cs.transitionDuration);</span>
<a href="#l24.483"></a><span id="l24.483" class="difflineplus">+          disablePointerEvents = (transitionProp.includes(&quot;transform&quot;) ||</span>
<a href="#l24.484"></a><span id="l24.484" class="difflineplus">+                                  transitionProp == &quot;all&quot;) &amp;&amp;</span>
<a href="#l24.485"></a><span id="l24.485" class="difflineplus">+                                 transitionTime &gt; 0;</span>
<a href="#l24.486"></a><span id="l24.486" class="difflineplus">+          this.setAttribute(&quot;disablepointereventsfortransition&quot;, disablePointerEvents);</span>
<a href="#l24.487"></a><span id="l24.487" class="difflineplus">+        } else {</span>
<a href="#l24.488"></a><span id="l24.488" class="difflineplus">+          disablePointerEvents = this.getAttribute(&quot;disablepointereventsfortransition&quot;) == &quot;true&quot;;</span>
<a href="#l24.489"></a><span id="l24.489" class="difflineplus">+        }</span>
<a href="#l24.490"></a><span id="l24.490" class="difflineplus">+        if (!disablePointerEvents) {</span>
<a href="#l24.491"></a><span id="l24.491" class="difflineplus">+          this.style.removeProperty(&quot;pointer-events&quot;);</span>
<a href="#l24.492"></a><span id="l24.492" class="difflineplus">+        }</span>
<a href="#l24.493"></a><span id="l24.493" class="difflineplus">+      ]]&gt;&lt;/handler&gt;</span>
<a href="#l24.494"></a><span id="l24.494" class="difflineplus">+      &lt;handler event=&quot;transitionend&quot;&gt;&lt;![CDATA[</span>
<a href="#l24.495"></a><span id="l24.495" class="difflineplus">+        if (event.originalTarget.getAttribute(&quot;anonid&quot;) == &quot;container&quot; &amp;&amp;</span>
<a href="#l24.496"></a><span id="l24.496" class="difflineplus">+            event.propertyName == &quot;transform&quot;) {</span>
<a href="#l24.497"></a><span id="l24.497" class="difflineplus">+          this.style.removeProperty(&quot;pointer-events&quot;);</span>
<a href="#l24.498"></a><span id="l24.498" class="difflineplus">+        }</span>
<a href="#l24.499"></a><span id="l24.499" class="difflineplus">+      ]]&gt;&lt;/handler&gt;</span>
<a href="#l24.500"></a><span id="l24.500" class="difflineplus">+      &lt;handler event=&quot;popuphiding&quot; phase=&quot;target&quot;&gt;&lt;![CDATA[</span>
<a href="#l24.501"></a><span id="l24.501" class="difflineplus">+        this.setAttribute(&quot;animate&quot;, &quot;cancel&quot;);</span>
<a href="#l24.502"></a><span id="l24.502" class="difflineplus">+      ]]&gt;&lt;/handler&gt;</span>
<a href="#l24.503"></a><span id="l24.503" class="difflineplus">+      &lt;handler event=&quot;popuphidden&quot; phase=&quot;target&quot;&gt;&lt;![CDATA[</span>
<a href="#l24.504"></a><span id="l24.504" class="difflineplus">+        this.removeAttribute(&quot;panelopen&quot;);</span>
<a href="#l24.505"></a><span id="l24.505" class="difflineplus">+        if (this.getAttribute(&quot;disablepointereventsfortransition&quot;) == &quot;true&quot;) {</span>
<a href="#l24.506"></a><span id="l24.506" class="difflineplus">+          this.style.pointerEvents = &quot;none&quot;;</span>
<a href="#l24.507"></a><span id="l24.507" class="difflineplus">+        }</span>
<a href="#l24.508"></a><span id="l24.508" class="difflineplus">+        this.removeAttribute(&quot;animate&quot;);</span>
<a href="#l24.509"></a><span id="l24.509" class="difflineplus">+      ]]&gt;&lt;/handler&gt;</span>
<a href="#l24.510"></a><span id="l24.510" class="difflineplus">+    &lt;/handlers&gt;</span>
<a href="#l24.511"></a><span id="l24.511" class="difflineplus">+  &lt;/binding&gt;</span>
<a href="#l24.512"></a><span id="l24.512"> &lt;/bindings&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1">deleted file mode 100644</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineminus">--- a/suite/common/places/content/moveBookmarks.js</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineplus">+++ /dev/null</span>
<a href="#l25.4"></a><span id="l25.4" class="difflineat">@@ -1,54 +0,0 @@</span>
<a href="#l25.5"></a><span id="l25.5" class="difflineminus">-/* -*- Mode: C++; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l25.6"></a><span id="l25.6" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l25.7"></a><span id="l25.7" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l25.8"></a><span id="l25.8" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l25.9"></a><span id="l25.9" class="difflineminus">-</span>
<a href="#l25.10"></a><span id="l25.10" class="difflineminus">-var gMoveBookmarksDialog = {</span>
<a href="#l25.11"></a><span id="l25.11" class="difflineminus">-  _nodes: null,</span>
<a href="#l25.12"></a><span id="l25.12" class="difflineminus">-</span>
<a href="#l25.13"></a><span id="l25.13" class="difflineminus">-  _foldersTree: null,</span>
<a href="#l25.14"></a><span id="l25.14" class="difflineminus">-  get foldersTree() {</span>
<a href="#l25.15"></a><span id="l25.15" class="difflineminus">-    if (!this._foldersTree)</span>
<a href="#l25.16"></a><span id="l25.16" class="difflineminus">-      this._foldersTree = document.getElementById(&quot;foldersTree&quot;);</span>
<a href="#l25.17"></a><span id="l25.17" class="difflineminus">-</span>
<a href="#l25.18"></a><span id="l25.18" class="difflineminus">-    return this._foldersTree;</span>
<a href="#l25.19"></a><span id="l25.19" class="difflineminus">-  },</span>
<a href="#l25.20"></a><span id="l25.20" class="difflineminus">-</span>
<a href="#l25.21"></a><span id="l25.21" class="difflineminus">-  init: function() {</span>
<a href="#l25.22"></a><span id="l25.22" class="difflineminus">-    this._nodes = window.arguments[0];</span>
<a href="#l25.23"></a><span id="l25.23" class="difflineminus">-</span>
<a href="#l25.24"></a><span id="l25.24" class="difflineminus">-    this.foldersTree.place =</span>
<a href="#l25.25"></a><span id="l25.25" class="difflineminus">-      &quot;place:excludeItems=1&amp;excludeQueries=1&amp;excludeReadOnlyFolders=1&amp;folder=&quot; +</span>
<a href="#l25.26"></a><span id="l25.26" class="difflineminus">-      PlacesUIUtils.allBookmarksFolderId;</span>
<a href="#l25.27"></a><span id="l25.27" class="difflineminus">-  },</span>
<a href="#l25.28"></a><span id="l25.28" class="difflineminus">-</span>
<a href="#l25.29"></a><span id="l25.29" class="difflineminus">-  onOK: function MBD_onOK(aEvent) {</span>
<a href="#l25.30"></a><span id="l25.30" class="difflineminus">-    var selectedNode = this.foldersTree.selectedNode;</span>
<a href="#l25.31"></a><span id="l25.31" class="difflineminus">-    NS_ASSERT(selectedNode,</span>
<a href="#l25.32"></a><span id="l25.32" class="difflineminus">-              &quot;selectedNode must be set in a single-selection tree with initial selection set&quot;);</span>
<a href="#l25.33"></a><span id="l25.33" class="difflineminus">-    var selectedFolderID = PlacesUtils.getConcreteItemId(selectedNode);</span>
<a href="#l25.34"></a><span id="l25.34" class="difflineminus">-</span>
<a href="#l25.35"></a><span id="l25.35" class="difflineminus">-    var transactions = [];</span>
<a href="#l25.36"></a><span id="l25.36" class="difflineminus">-    for (var i=0; i &lt; this._nodes.length; i++) {</span>
<a href="#l25.37"></a><span id="l25.37" class="difflineminus">-      // Nothing to do if the node is already under the selected folder</span>
<a href="#l25.38"></a><span id="l25.38" class="difflineminus">-      if (this._nodes[i].parent.itemId == selectedFolderID)</span>
<a href="#l25.39"></a><span id="l25.39" class="difflineminus">-        continue;</span>
<a href="#l25.40"></a><span id="l25.40" class="difflineminus">-</span>
<a href="#l25.41"></a><span id="l25.41" class="difflineminus">-      let txn = new PlacesMoveItemTransaction(this._nodes[i].itemId,</span>
<a href="#l25.42"></a><span id="l25.42" class="difflineminus">-                                              selectedFolderID,</span>
<a href="#l25.43"></a><span id="l25.43" class="difflineminus">-                                              PlacesUtils.bookmarks.DEFAULT_INDEX);</span>
<a href="#l25.44"></a><span id="l25.44" class="difflineminus">-      transactions.push(txn);</span>
<a href="#l25.45"></a><span id="l25.45" class="difflineminus">-    }</span>
<a href="#l25.46"></a><span id="l25.46" class="difflineminus">-</span>
<a href="#l25.47"></a><span id="l25.47" class="difflineminus">-    if (transactions.length != 0) {</span>
<a href="#l25.48"></a><span id="l25.48" class="difflineminus">-      let txn = new PlacesAggregatedTransaction(&quot;Move Items&quot;, transactions);</span>
<a href="#l25.49"></a><span id="l25.49" class="difflineminus">-      PlacesUtils.transactionManager.doTransaction(txn);</span>
<a href="#l25.50"></a><span id="l25.50" class="difflineminus">-    }</span>
<a href="#l25.51"></a><span id="l25.51" class="difflineminus">-  },</span>
<a href="#l25.52"></a><span id="l25.52" class="difflineminus">-</span>
<a href="#l25.53"></a><span id="l25.53" class="difflineminus">-  newFolder: function MBD_newFolder() {</span>
<a href="#l25.54"></a><span id="l25.54" class="difflineminus">-    // The command is disabled when the tree is not focused</span>
<a href="#l25.55"></a><span id="l25.55" class="difflineminus">-    this.foldersTree.focus();</span>
<a href="#l25.56"></a><span id="l25.56" class="difflineminus">-    goDoCommand(&quot;placesCmd_new:folder&quot;);</span>
<a href="#l25.57"></a><span id="l25.57" class="difflineminus">-  }</span>
<a href="#l25.58"></a><span id="l25.58" class="difflineminus">-};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1">deleted file mode 100644</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineminus">--- a/suite/common/places/content/moveBookmarks.xul</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineplus">+++ /dev/null</span>
<a href="#l26.4"></a><span id="l26.4" class="difflineat">@@ -1,54 +0,0 @@</span>
<a href="#l26.5"></a><span id="l26.5" class="difflineminus">-&lt;?xml version=&quot;1.0&quot;?&gt;</span>
<a href="#l26.6"></a><span id="l26.6" class="difflineminus">-</span>
<a href="#l26.7"></a><span id="l26.7" class="difflineminus">-&lt;!-- This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l26.8"></a><span id="l26.8" class="difflineminus">-   - License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l26.9"></a><span id="l26.9" class="difflineminus">-   - file, You can obtain one at http://mozilla.org/MPL/2.0/. --&gt;</span>
<a href="#l26.10"></a><span id="l26.10" class="difflineminus">-</span>
<a href="#l26.11"></a><span id="l26.11" class="difflineminus">-&lt;?xml-stylesheet href=&quot;chrome://global/skin/&quot;?&gt;</span>
<a href="#l26.12"></a><span id="l26.12" class="difflineminus">-&lt;?xml-stylesheet href=&quot;chrome://communicator/skin/bookmarks/bookmarks.css&quot;?&gt;</span>
<a href="#l26.13"></a><span id="l26.13" class="difflineminus">-&lt;?xml-stylesheet href=&quot;chrome://communicator/content/places/places.css&quot;?&gt;</span>
<a href="#l26.14"></a><span id="l26.14" class="difflineminus">-</span>
<a href="#l26.15"></a><span id="l26.15" class="difflineminus">-&lt;?xul-overlay href=&quot;chrome://communicator/content/bookmarks/placesOverlay.xul&quot;?&gt;</span>
<a href="#l26.16"></a><span id="l26.16" class="difflineminus">-</span>
<a href="#l26.17"></a><span id="l26.17" class="difflineminus">-&lt;!DOCTYPE window [</span>
<a href="#l26.18"></a><span id="l26.18" class="difflineminus">-  &lt;!ENTITY % moveBookmarksDTD SYSTEM &quot;chrome://communicator/locale/bookmarks/moveBookmarks.dtd&quot;&gt;</span>
<a href="#l26.19"></a><span id="l26.19" class="difflineminus">-  %moveBookmarksDTD;</span>
<a href="#l26.20"></a><span id="l26.20" class="difflineminus">-]&gt;</span>
<a href="#l26.21"></a><span id="l26.21" class="difflineminus">-</span>
<a href="#l26.22"></a><span id="l26.22" class="difflineminus">-&lt;dialog id=&quot;moveBookmarkDialog&quot;</span>
<a href="#l26.23"></a><span id="l26.23" class="difflineminus">-        xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;</span>
<a href="#l26.24"></a><span id="l26.24" class="difflineminus">-        ondialogaccept=&quot;return gMoveBookmarksDialog.onOK(event);&quot;</span>
<a href="#l26.25"></a><span id="l26.25" class="difflineminus">-        title=&quot;&amp;window.title;&quot;</span>
<a href="#l26.26"></a><span id="l26.26" class="difflineminus">-        onload=&quot;gMoveBookmarksDialog.init();&quot;</span>
<a href="#l26.27"></a><span id="l26.27" class="difflineminus">-        style=&quot;&amp;window.style;&quot;</span>
<a href="#l26.28"></a><span id="l26.28" class="difflineminus">-        screenX=&quot;24&quot;</span>
<a href="#l26.29"></a><span id="l26.29" class="difflineminus">-        screenY=&quot;24&quot;</span>
<a href="#l26.30"></a><span id="l26.30" class="difflineminus">-        persist=&quot;screenX screenY width height&quot;&gt;</span>
<a href="#l26.31"></a><span id="l26.31" class="difflineminus">-</span>
<a href="#l26.32"></a><span id="l26.32" class="difflineminus">-  &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l26.33"></a><span id="l26.33" class="difflineminus">-          src=&quot;chrome://communicator/content/bookmarks/moveBookmarks.js&quot;/&gt;</span>
<a href="#l26.34"></a><span id="l26.34" class="difflineminus">-</span>
<a href="#l26.35"></a><span id="l26.35" class="difflineminus">-  &lt;hbox flex=&quot;1&quot;&gt;</span>
<a href="#l26.36"></a><span id="l26.36" class="difflineminus">-    &lt;label id=&quot;movetolabel&quot; value=&quot;&amp;moveTo.label;&quot; control=&quot;foldersTree&quot;/&gt;</span>
<a href="#l26.37"></a><span id="l26.37" class="difflineminus">-    &lt;hbox flex=&quot;1&quot;&gt;</span>
<a href="#l26.38"></a><span id="l26.38" class="difflineminus">-      &lt;tree id=&quot;foldersTree&quot;</span>
<a href="#l26.39"></a><span id="l26.39" class="difflineminus">-            class=&quot;placesTree&quot;</span>
<a href="#l26.40"></a><span id="l26.40" class="difflineminus">-            treelines=&quot;true&quot;</span>
<a href="#l26.41"></a><span id="l26.41" class="difflineminus">-            flex=&quot;1&quot;</span>
<a href="#l26.42"></a><span id="l26.42" class="difflineminus">-            type=&quot;places&quot;</span>
<a href="#l26.43"></a><span id="l26.43" class="difflineminus">-            seltype=&quot;single&quot;</span>
<a href="#l26.44"></a><span id="l26.44" class="difflineminus">-            hidecolumnpicker=&quot;true&quot;&gt;</span>
<a href="#l26.45"></a><span id="l26.45" class="difflineminus">-        &lt;treecols&gt;</span>
<a href="#l26.46"></a><span id="l26.46" class="difflineminus">-          &lt;treecol id=&quot;title&quot; flex=&quot;1&quot; primary=&quot;true&quot; hideheader=&quot;true&quot;/&gt;</span>
<a href="#l26.47"></a><span id="l26.47" class="difflineminus">-        &lt;/treecols&gt;</span>
<a href="#l26.48"></a><span id="l26.48" class="difflineminus">-        &lt;treechildren id=&quot;placesListChildren&quot; view=&quot;placesList&quot; flex=&quot;1&quot;/&gt;</span>
<a href="#l26.49"></a><span id="l26.49" class="difflineminus">-      &lt;/tree&gt;</span>
<a href="#l26.50"></a><span id="l26.50" class="difflineminus">-      &lt;vbox&gt;</span>
<a href="#l26.51"></a><span id="l26.51" class="difflineminus">-        &lt;button id=&quot;newFolderButton&quot;</span>
<a href="#l26.52"></a><span id="l26.52" class="difflineminus">-                label=&quot;&amp;newFolderButton.label;&quot;</span>
<a href="#l26.53"></a><span id="l26.53" class="difflineminus">-                accesskey=&quot;&amp;newFolderButton.accesskey;&quot;</span>
<a href="#l26.54"></a><span id="l26.54" class="difflineminus">-                oncommand=&quot;gMoveBookmarksDialog.newFolder();&quot;/&gt;</span>
<a href="#l26.55"></a><span id="l26.55" class="difflineminus">-      &lt;/vbox&gt;</span>
<a href="#l26.56"></a><span id="l26.56" class="difflineminus">-    &lt;/hbox&gt;</span>
<a href="#l26.57"></a><span id="l26.57" class="difflineminus">-  &lt;/hbox&gt;</span>
<a href="#l26.58"></a><span id="l26.58" class="difflineminus">-&lt;/dialog&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1" class="difflineminus">--- a/suite/common/places/content/organizer.css</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineplus">+++ b/suite/common/places/content/organizer.css</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineat">@@ -1,11 +1,7 @@</span>
<a href="#l27.4"></a><span id="l27.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l27.5"></a><span id="l27.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l27.6"></a><span id="l27.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l27.7"></a><span id="l27.7"> </span>
<a href="#l27.8"></a><span id="l27.8"> #searchFilter {</span>
<a href="#l27.9"></a><span id="l27.9">   width: 23em;</span>
<a href="#l27.10"></a><span id="l27.10"> }</span>
<a href="#l27.11"></a><span id="l27.11" class="difflineminus">-</span>
<a href="#l27.12"></a><span id="l27.12" class="difflineminus">-#detailsDeck-splitter {</span>
<a href="#l27.13"></a><span id="l27.13" class="difflineminus">-  cursor: default;</span>
<a href="#l27.14"></a><span id="l27.14" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l28.1"></a><span id="l28.1" class="difflineminus">--- a/suite/common/places/content/places.css</span>
<a href="#l28.2"></a><span id="l28.2" class="difflineplus">+++ b/suite/common/places/content/places.css</span>
<a href="#l28.3"></a><span id="l28.3" class="difflineat">@@ -1,26 +1,37 @@</span>
<a href="#l28.4"></a><span id="l28.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l28.5"></a><span id="l28.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l28.6"></a><span id="l28.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l28.7"></a><span id="l28.7"> </span>
<a href="#l28.8"></a><span id="l28.8"> tree[type=&quot;places&quot;] {</span>
<a href="#l28.9"></a><span id="l28.9">   -moz-binding: url(&quot;chrome://communicator/content/places/tree.xml#places-tree&quot;);</span>
<a href="#l28.10"></a><span id="l28.10"> }</span>
<a href="#l28.11"></a><span id="l28.11"> </span>
<a href="#l28.12"></a><span id="l28.12" class="difflineminus">-.bookmarks-toolbar-customize,</span>
<a href="#l28.13"></a><span id="l28.13" class="difflineminus">-toolbarpaletteitem #PlacesToolbarItems,</span>
<a href="#l28.14"></a><span id="l28.14" class="difflineminus">-toolbarpaletteitem #PlacesChevron {</span>
<a href="#l28.15"></a><span id="l28.15" class="difflineminus">-  display: none;</span>
<a href="#l28.16"></a><span id="l28.16" class="difflineplus">+tree[type=&quot;places&quot;] &gt; treechildren::-moz-tree-cell {</span>
<a href="#l28.17"></a><span id="l28.17" class="difflineplus">+  /* ensure we use the direction of the website title / url instead of the</span>
<a href="#l28.18"></a><span id="l28.18" class="difflineplus">+   * browser locale */</span>
<a href="#l28.19"></a><span id="l28.19" class="difflineplus">+  unicode-bidi: plaintext;</span>
<a href="#l28.20"></a><span id="l28.20"> }</span>
<a href="#l28.21"></a><span id="l28.21"> </span>
<a href="#l28.22"></a><span id="l28.22" class="difflineminus">-toolbarpaletteitem .bookmarks-toolbar-customize {</span>
<a href="#l28.23"></a><span id="l28.23" class="difflineminus">-  display: -moz-box;</span>
<a href="#l28.24"></a><span id="l28.24" class="difflineplus">+#bhtTitleText {</span>
<a href="#l28.25"></a><span id="l28.25" class="difflineplus">+  /* ensure we use the direction of the website title instead of the</span>
<a href="#l28.26"></a><span id="l28.26" class="difflineplus">+   * browser locale */</span>
<a href="#l28.27"></a><span id="l28.27" class="difflineplus">+  unicode-bidi: plaintext;</span>
<a href="#l28.28"></a><span id="l28.28"> }</span>
<a href="#l28.29"></a><span id="l28.29"> </span>
<a href="#l28.30"></a><span id="l28.30"> .toolbar-drop-indicator {</span>
<a href="#l28.31"></a><span id="l28.31">   position: relative;</span>
<a href="#l28.32"></a><span id="l28.32">   z-index: 1;</span>
<a href="#l28.33"></a><span id="l28.33"> }</span>
<a href="#l28.34"></a><span id="l28.34"> </span>
<a href="#l28.35"></a><span id="l28.35"> menupopup[placespopup=&quot;true&quot;] {</span>
<a href="#l28.36"></a><span id="l28.36">   -moz-binding: url(&quot;chrome://communicator/content/places/menu.xml#places-popup-base&quot;);</span>
<a href="#l28.37"></a><span id="l28.37"> }</span>
<a href="#l28.38"></a><span id="l28.38" class="difflineplus">+</span>
<a href="#l28.39"></a><span id="l28.39" class="difflineplus">+/* Apply crisp rendering for favicons at exactly 2dppx resolution */</span>
<a href="#l28.40"></a><span id="l28.40" class="difflineplus">+@media (resolution: 2dppx) {</span>
<a href="#l28.41"></a><span id="l28.41" class="difflineplus">+  #bookmarksChildren,</span>
<a href="#l28.42"></a><span id="l28.42" class="difflineplus">+  .sidebar-placesTreechildren,</span>
<a href="#l28.43"></a><span id="l28.43" class="difflineplus">+  .placesTree &gt; treechildren {</span>
<a href="#l28.44"></a><span id="l28.44" class="difflineplus">+    image-rendering: -moz-crisp-edges;</span>
<a href="#l28.45"></a><span id="l28.45" class="difflineplus">+  }</span>
<a href="#l28.46"></a><span id="l28.46" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l29.1"></a><span id="l29.1" class="difflineminus">--- a/suite/common/places/content/places.js</span>
<a href="#l29.2"></a><span id="l29.2" class="difflineplus">+++ b/suite/common/places/content/places.js</span>
<a href="#l29.3"></a><span id="l29.3" class="difflineat">@@ -1,72 +1,134 @@</span>
<a href="#l29.4"></a><span id="l29.4" class="difflineminus">-/* -*- Mode: C++; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l29.5"></a><span id="l29.5" class="difflineplus">+/* -*- indent-tabs-mode: nil; js-indent-level: 2 -*- */</span>
<a href="#l29.6"></a><span id="l29.6"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l29.7"></a><span id="l29.7">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l29.8"></a><span id="l29.8">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l29.9"></a><span id="l29.9"> </span>
<a href="#l29.10"></a><span id="l29.10" class="difflineplus">+/* import-globals-from editBookmarkOverlay.js */</span>
<a href="#l29.11"></a><span id="l29.11" class="difflineplus">+/* import-globals-from ../../../../toolkit/content/contentAreaUtils.js */</span>
<a href="#l29.12"></a><span id="l29.12" class="difflineplus">+</span>
<a href="#l29.13"></a><span id="l29.13" class="difflineplus">+ChromeUtils.import(&quot;resource://gre/modules/AppConstants.jsm&quot;);</span>
<a href="#l29.14"></a><span id="l29.14" class="difflineplus">+ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l29.15"></a><span id="l29.15" class="difflineplus">+ChromeUtils.import(&quot;resource://gre/modules/TelemetryStopwatch.jsm&quot;);</span>
<a href="#l29.16"></a><span id="l29.16" class="difflineplus">+ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l29.17"></a><span id="l29.17" class="difflineplus">+</span>
<a href="#l29.18"></a><span id="l29.18" class="difflineplus">+ChromeUtils.defineModuleGetter(this, &quot;MigrationUtils&quot;,</span>
<a href="#l29.19"></a><span id="l29.19" class="difflineplus">+                               &quot;resource:///modules/MigrationUtils.jsm&quot;);</span>
<a href="#l29.20"></a><span id="l29.20"> ChromeUtils.defineModuleGetter(this, &quot;BookmarkJSONUtils&quot;,</span>
<a href="#l29.21"></a><span id="l29.21">                                &quot;resource://gre/modules/BookmarkJSONUtils.jsm&quot;);</span>
<a href="#l29.22"></a><span id="l29.22" class="difflineplus">+ChromeUtils.defineModuleGetter(this, &quot;PlacesBackups&quot;,</span>
<a href="#l29.23"></a><span id="l29.23" class="difflineplus">+                               &quot;resource://gre/modules/PlacesBackups.jsm&quot;);</span>
<a href="#l29.24"></a><span id="l29.24" class="difflineplus">+ChromeUtils.defineModuleGetter(this, &quot;DownloadUtils&quot;,</span>
<a href="#l29.25"></a><span id="l29.25" class="difflineplus">+                               &quot;resource://gre/modules/DownloadUtils.jsm&quot;);</span>
<a href="#l29.26"></a><span id="l29.26" class="difflineplus">+ChromeUtils.defineModuleGetter(this, &quot;OS&quot;,</span>
<a href="#l29.27"></a><span id="l29.27" class="difflineplus">+                               &quot;resource://gre/modules/osfile.jsm&quot;);</span>
<a href="#l29.28"></a><span id="l29.28" class="difflineplus">+</span>
<a href="#l29.29"></a><span id="l29.29" class="difflineplus">+const RESTORE_FILEPICKER_FILTER_EXT = &quot;*.json;*.jsonlz4&quot;;</span>
<a href="#l29.30"></a><span id="l29.30" class="difflineplus">+const HISTORY_LIBRARY_SEARCH_TELEMETRY = &quot;PLACES_HISTORY_LIBRARY_SEARCH_TIME_MS&quot;;</span>
<a href="#l29.31"></a><span id="l29.31"> </span>
<a href="#l29.32"></a><span id="l29.32"> var PlacesOrganizer = {</span>
<a href="#l29.33"></a><span id="l29.33">   _places: null,</span>
<a href="#l29.34"></a><span id="l29.34" class="difflineminus">-  _content: null,</span>
<a href="#l29.35"></a><span id="l29.35"> </span>
<a href="#l29.36"></a><span id="l29.36">   // IDs of fields from editBookmarkOverlay that should be hidden when infoBox</span>
<a href="#l29.37"></a><span id="l29.37">   // is minimal. IDs should be kept in sync with the IDs of the elements</span>
<a href="#l29.38"></a><span id="l29.38">   // observing additionalInfoBroadcaster.</span>
<a href="#l29.39"></a><span id="l29.39">   _additionalInfoFields: [</span>
<a href="#l29.40"></a><span id="l29.40">     &quot;editBMPanel_descriptionRow&quot;,</span>
<a href="#l29.41"></a><span id="l29.41" class="difflineplus">+    &quot;editBMPanel_loadInSidebarCheckbox&quot;,</span>
<a href="#l29.42"></a><span id="l29.42">     &quot;editBMPanel_keywordRow&quot;,</span>
<a href="#l29.43"></a><span id="l29.43">   ],</span>
<a href="#l29.44"></a><span id="l29.44"> </span>
<a href="#l29.45"></a><span id="l29.45" class="difflineminus">-  _initFolderTree: function() {</span>
<a href="#l29.46"></a><span id="l29.46" class="difflineplus">+  _initFolderTree() {</span>
<a href="#l29.47"></a><span id="l29.47">     var leftPaneRoot = PlacesUIUtils.leftPaneFolderId;</span>
<a href="#l29.48"></a><span id="l29.48">     this._places.place = &quot;place:excludeItems=1&amp;expandQueries=0&amp;folder=&quot; + leftPaneRoot;</span>
<a href="#l29.49"></a><span id="l29.49">   },</span>
<a href="#l29.50"></a><span id="l29.50"> </span>
<a href="#l29.51"></a><span id="l29.51">   selectLeftPaneQuery: function PO_selectLeftPaneQuery(aQueryName) {</span>
<a href="#l29.52"></a><span id="l29.52">     var itemId = PlacesUIUtils.leftPaneQueries[aQueryName];</span>
<a href="#l29.53"></a><span id="l29.53">     this._places.selectItems([itemId]);</span>
<a href="#l29.54"></a><span id="l29.54">     // Forcefully expand all-bookmarks</span>
<a href="#l29.55"></a><span id="l29.55" class="difflineminus">-    if (aQueryName == &quot;AllBookmarks&quot;)</span>
<a href="#l29.56"></a><span id="l29.56" class="difflineplus">+    if (aQueryName == &quot;AllBookmarks&quot; || aQueryName == &quot;History&quot;)</span>
<a href="#l29.57"></a><span id="l29.57">       PlacesUtils.asContainer(this._places.selectedNode).containerOpen = true;</span>
<a href="#l29.58"></a><span id="l29.58">   },</span>
<a href="#l29.59"></a><span id="l29.59"> </span>
<a href="#l29.60"></a><span id="l29.60" class="difflineplus">+  /**</span>
<a href="#l29.61"></a><span id="l29.61" class="difflineplus">+   * Opens a given hierarchy in the left pane, stopping at the last reachable</span>
<a href="#l29.62"></a><span id="l29.62" class="difflineplus">+   * container.</span>
<a href="#l29.63"></a><span id="l29.63" class="difflineplus">+   *</span>
<a href="#l29.64"></a><span id="l29.64" class="difflineplus">+   * @param aHierarchy A single container or an array of containers, sorted from</span>
<a href="#l29.65"></a><span id="l29.65" class="difflineplus">+   *                   the outmost to the innermost in the hierarchy. Each</span>
<a href="#l29.66"></a><span id="l29.66" class="difflineplus">+   *                   container may be either an item id, a Places URI string,</span>
<a href="#l29.67"></a><span id="l29.67" class="difflineplus">+   *                   or a named query.</span>
<a href="#l29.68"></a><span id="l29.68" class="difflineplus">+   * @see PlacesUIUtils.leftPaneQueries for supported named queries.</span>
<a href="#l29.69"></a><span id="l29.69" class="difflineplus">+   */</span>
<a href="#l29.70"></a><span id="l29.70" class="difflineplus">+  selectLeftPaneContainerByHierarchy:</span>
<a href="#l29.71"></a><span id="l29.71" class="difflineplus">+  function PO_selectLeftPaneContainerByHierarchy(aHierarchy) {</span>
<a href="#l29.72"></a><span id="l29.72" class="difflineplus">+    if (!aHierarchy)</span>
<a href="#l29.73"></a><span id="l29.73" class="difflineplus">+      throw new Error(&quot;Invalid containers hierarchy&quot;);</span>
<a href="#l29.74"></a><span id="l29.74" class="difflineplus">+    let hierarchy = [].concat(aHierarchy);</span>
<a href="#l29.75"></a><span id="l29.75" class="difflineplus">+    let selectWasSuppressed = this._places.view.selection.selectEventsSuppressed;</span>
<a href="#l29.76"></a><span id="l29.76" class="difflineplus">+    if (!selectWasSuppressed)</span>
<a href="#l29.77"></a><span id="l29.77" class="difflineplus">+      this._places.view.selection.selectEventsSuppressed = true;</span>
<a href="#l29.78"></a><span id="l29.78" class="difflineplus">+    try {</span>
<a href="#l29.79"></a><span id="l29.79" class="difflineplus">+      for (let container of hierarchy) {</span>
<a href="#l29.80"></a><span id="l29.80" class="difflineplus">+        switch (typeof container) {</span>
<a href="#l29.81"></a><span id="l29.81" class="difflineplus">+          case &quot;number&quot;:</span>
<a href="#l29.82"></a><span id="l29.82" class="difflineplus">+            this._places.selectItems([container], false);</span>
<a href="#l29.83"></a><span id="l29.83" class="difflineplus">+            break;</span>
<a href="#l29.84"></a><span id="l29.84" class="difflineplus">+          case &quot;string&quot;:</span>
<a href="#l29.85"></a><span id="l29.85" class="difflineplus">+            if (container.substr(0, 6) == &quot;place:&quot;)</span>
<a href="#l29.86"></a><span id="l29.86" class="difflineplus">+              this._places.selectPlaceURI(container);</span>
<a href="#l29.87"></a><span id="l29.87" class="difflineplus">+            else if (container in PlacesUIUtils.leftPaneQueries)</span>
<a href="#l29.88"></a><span id="l29.88" class="difflineplus">+              this.selectLeftPaneQuery(container);</span>
<a href="#l29.89"></a><span id="l29.89" class="difflineplus">+            else</span>
<a href="#l29.90"></a><span id="l29.90" class="difflineplus">+              throw new Error(&quot;Invalid container found: &quot; + container);</span>
<a href="#l29.91"></a><span id="l29.91" class="difflineplus">+            break;</span>
<a href="#l29.92"></a><span id="l29.92" class="difflineplus">+          default:</span>
<a href="#l29.93"></a><span id="l29.93" class="difflineplus">+            throw new Error(&quot;Invalid container type found: &quot; + container);</span>
<a href="#l29.94"></a><span id="l29.94" class="difflineplus">+        }</span>
<a href="#l29.95"></a><span id="l29.95" class="difflineplus">+        PlacesUtils.asContainer(this._places.selectedNode).containerOpen = true;</span>
<a href="#l29.96"></a><span id="l29.96" class="difflineplus">+      }</span>
<a href="#l29.97"></a><span id="l29.97" class="difflineplus">+    } finally {</span>
<a href="#l29.98"></a><span id="l29.98" class="difflineplus">+      if (!selectWasSuppressed)</span>
<a href="#l29.99"></a><span id="l29.99" class="difflineplus">+        this._places.view.selection.selectEventsSuppressed = false;</span>
<a href="#l29.100"></a><span id="l29.100" class="difflineplus">+    }</span>
<a href="#l29.101"></a><span id="l29.101" class="difflineplus">+  },</span>
<a href="#l29.102"></a><span id="l29.102" class="difflineplus">+</span>
<a href="#l29.103"></a><span id="l29.103">   init: function PO_init() {</span>
<a href="#l29.104"></a><span id="l29.104" class="difflineplus">+    ContentArea.init();</span>
<a href="#l29.105"></a><span id="l29.105" class="difflineplus">+</span>
<a href="#l29.106"></a><span id="l29.106">     this._places = document.getElementById(&quot;placesList&quot;);</span>
<a href="#l29.107"></a><span id="l29.107" class="difflineminus">-    this._content = document.getElementById(&quot;placeContent&quot;);</span>
<a href="#l29.108"></a><span id="l29.108">     this._initFolderTree();</span>
<a href="#l29.109"></a><span id="l29.109"> </span>
<a href="#l29.110"></a><span id="l29.110">     var leftPaneSelection = &quot;AllBookmarks&quot;; // default to all-bookmarks</span>
<a href="#l29.111"></a><span id="l29.111" class="difflineminus">-    if (&quot;arguments&quot; in window &amp;&amp; window.arguments.length &gt; 0)</span>
<a href="#l29.112"></a><span id="l29.112" class="difflineplus">+    if (window.arguments &amp;&amp; window.arguments[0])</span>
<a href="#l29.113"></a><span id="l29.113">       leftPaneSelection = window.arguments[0];</span>
<a href="#l29.114"></a><span id="l29.114"> </span>
<a href="#l29.115"></a><span id="l29.115" class="difflineminus">-    this.selectLeftPaneQuery(leftPaneSelection);</span>
<a href="#l29.116"></a><span id="l29.116" class="difflineplus">+    this.selectLeftPaneContainerByHierarchy(leftPaneSelection);</span>
<a href="#l29.117"></a><span id="l29.117" class="difflineplus">+    if (leftPaneSelection === &quot;History&quot;) {</span>
<a href="#l29.118"></a><span id="l29.118" class="difflineplus">+      let historyNode = this._places.selectedNode;</span>
<a href="#l29.119"></a><span id="l29.119" class="difflineplus">+      if (historyNode.childCount &gt; 0)</span>
<a href="#l29.120"></a><span id="l29.120" class="difflineplus">+        this._places.selectNode(historyNode.getChild(0));</span>
<a href="#l29.121"></a><span id="l29.121" class="difflineplus">+    }</span>
<a href="#l29.122"></a><span id="l29.122" class="difflineplus">+</span>
<a href="#l29.123"></a><span id="l29.123">     // clear the back-stack</span>
<a href="#l29.124"></a><span id="l29.124">     this._backHistory.splice(0, this._backHistory.length);</span>
<a href="#l29.125"></a><span id="l29.125">     document.getElementById(&quot;OrganizerCommand:Back&quot;).setAttribute(&quot;disabled&quot;, true);</span>
<a href="#l29.126"></a><span id="l29.126"> </span>
<a href="#l29.127"></a><span id="l29.127" class="difflineminus">-    var view = this._content.view;</span>
<a href="#l29.128"></a><span id="l29.128" class="difflineminus">-    if (view.rowCount &gt; 0)</span>
<a href="#l29.129"></a><span id="l29.129" class="difflineminus">-      view.selection.select(0);</span>
<a href="#l29.130"></a><span id="l29.130" class="difflineminus">-</span>
<a href="#l29.131"></a><span id="l29.131" class="difflineminus">-    this._content.focus();</span>
<a href="#l29.132"></a><span id="l29.132" class="difflineminus">-</span>
<a href="#l29.133"></a><span id="l29.133">     // Set up the search UI.</span>
<a href="#l29.134"></a><span id="l29.134">     PlacesSearchBox.init();</span>
<a href="#l29.135"></a><span id="l29.135"> </span>
<a href="#l29.136"></a><span id="l29.136" class="difflineminus">-    // Fix for Bug 1224907 - Search box missing in Mac Menu Bar.</span>
<a href="#l29.137"></a><span id="l29.137" class="difflineminus">-    var toolbar = document.getElementById(&quot;placesToolbar&quot;);</span>
<a href="#l29.138"></a><span id="l29.138" class="difflineminus">-    if (toolbar.hasAttribute(&quot;autohide&quot;)) {</span>
<a href="#l29.139"></a><span id="l29.139" class="difflineminus">-      toolbar.removeAttribute(&quot;autohide&quot;);</span>
<a href="#l29.140"></a><span id="l29.140" class="difflineminus">-      document.persist(&quot;placesToolbar&quot;, autohide);</span>
<a href="#l29.141"></a><span id="l29.141" class="difflineminus">-    }</span>
<a href="#l29.142"></a><span id="l29.142" class="difflineplus">+    window.addEventListener(&quot;AppCommand&quot;, this, true);</span>
<a href="#l29.143"></a><span id="l29.143"> </span>
<a href="#l29.144"></a><span id="l29.144" class="difflineminus">-    window.addEventListener(&quot;AppCommand&quot;, this, true);</span>
<a href="#l29.145"></a><span id="l29.145" class="difflineplus">+    // remove the &quot;Properties&quot; context-menu item, we've our own details pane</span>
<a href="#l29.146"></a><span id="l29.146" class="difflineplus">+    document.getElementById(&quot;placesContext&quot;)</span>
<a href="#l29.147"></a><span id="l29.147" class="difflineplus">+            .removeChild(document.getElementById(&quot;placesContext_show:info&quot;));</span>
<a href="#l29.148"></a><span id="l29.148" class="difflineplus">+</span>
<a href="#l29.149"></a><span id="l29.149" class="difflineplus">+    ContentArea.focus();</span>
<a href="#l29.150"></a><span id="l29.150">   },</span>
<a href="#l29.151"></a><span id="l29.151"> </span>
<a href="#l29.152"></a><span id="l29.152">   QueryInterface: function PO_QueryInterface(aIID) {</span>
<a href="#l29.153"></a><span id="l29.153">     if (aIID.equals(Ci.nsIDOMEventListener) ||</span>
<a href="#l29.154"></a><span id="l29.154">         aIID.equals(Ci.nsISupports))</span>
<a href="#l29.155"></a><span id="l29.155">       return this;</span>
<a href="#l29.156"></a><span id="l29.156"> </span>
<a href="#l29.157"></a><span id="l29.157">     throw Cr.NS_NOINTERFACE;</span>
<a href="#l29.158"></a><span id="l29.158" class="difflineat">@@ -109,19 +171,19 @@ var PlacesOrganizer = {</span>
<a href="#l29.159"></a><span id="l29.159">       this._forwardHistory.splice(0, this._forwardHistory.length);</span>
<a href="#l29.160"></a><span id="l29.160">     }</span>
<a href="#l29.161"></a><span id="l29.161"> </span>
<a href="#l29.162"></a><span id="l29.162">     this._location = aLocation;</span>
<a href="#l29.163"></a><span id="l29.163">     this._places.selectPlaceURI(aLocation);</span>
<a href="#l29.164"></a><span id="l29.164"> </span>
<a href="#l29.165"></a><span id="l29.165">     if (!this._places.hasSelection) {</span>
<a href="#l29.166"></a><span id="l29.166">       // If no node was found for the given place: uri, just load it directly</span>
<a href="#l29.167"></a><span id="l29.167" class="difflineminus">-      this._content.place = aLocation;</span>
<a href="#l29.168"></a><span id="l29.168" class="difflineplus">+      ContentArea.currentPlace = aLocation;</span>
<a href="#l29.169"></a><span id="l29.169">     }</span>
<a href="#l29.170"></a><span id="l29.170" class="difflineminus">-    this.onContentTreeSelect();</span>
<a href="#l29.171"></a><span id="l29.171" class="difflineplus">+    this.updateDetailsPane();</span>
<a href="#l29.172"></a><span id="l29.172"> </span>
<a href="#l29.173"></a><span id="l29.173">     // update navigation commands</span>
<a href="#l29.174"></a><span id="l29.174">     if (this._backHistory.length == 0)</span>
<a href="#l29.175"></a><span id="l29.175">       document.getElementById(&quot;OrganizerCommand:Back&quot;).setAttribute(&quot;disabled&quot;, true);</span>
<a href="#l29.176"></a><span id="l29.176">     else</span>
<a href="#l29.177"></a><span id="l29.177">       document.getElementById(&quot;OrganizerCommand:Back&quot;).removeAttribute(&quot;disabled&quot;);</span>
<a href="#l29.178"></a><span id="l29.178">     if (this._forwardHistory.length == 0)</span>
<a href="#l29.179"></a><span id="l29.179">       document.getElementById(&quot;OrganizerCommand:Forward&quot;).setAttribute(&quot;disabled&quot;, true);</span>
<a href="#l29.180"></a><span id="l29.180" class="difflineat">@@ -171,166 +233,133 @@ var PlacesOrganizer = {</span>
<a href="#l29.181"></a><span id="l29.181">     options.excludeItems = false;</span>
<a href="#l29.182"></a><span id="l29.182">     var placeURI = PlacesUtils.history.queriesToQueryString(queries,</span>
<a href="#l29.183"></a><span id="l29.183">                                                             queries.length,</span>
<a href="#l29.184"></a><span id="l29.184">                                                             options);</span>
<a href="#l29.185"></a><span id="l29.185"> </span>
<a href="#l29.186"></a><span id="l29.186">     // If either the place of the content tree in the right pane has changed or</span>
<a href="#l29.187"></a><span id="l29.187">     // the user cleared the search box, update the place, hide the search UI,</span>
<a href="#l29.188"></a><span id="l29.188">     // and update the back/forward buttons by setting location.</span>
<a href="#l29.189"></a><span id="l29.189" class="difflineminus">-    if (this._content.place != placeURI || !resetSearchBox) {</span>
<a href="#l29.190"></a><span id="l29.190" class="difflineminus">-      this._content.place = placeURI;</span>
<a href="#l29.191"></a><span id="l29.191" class="difflineminus">-      PlacesSearchBox.hideSearchUI();</span>
<a href="#l29.192"></a><span id="l29.192" class="difflineplus">+    if (ContentArea.currentPlace != placeURI || !resetSearchBox) {</span>
<a href="#l29.193"></a><span id="l29.193" class="difflineplus">+      ContentArea.currentPlace = placeURI;</span>
<a href="#l29.194"></a><span id="l29.194">       this.location = node.uri;</span>
<a href="#l29.195"></a><span id="l29.195">     }</span>
<a href="#l29.196"></a><span id="l29.196"> </span>
<a href="#l29.197"></a><span id="l29.197" class="difflineminus">-    // Update the selected folder title where it appears in the UI: the folder</span>
<a href="#l29.198"></a><span id="l29.198" class="difflineminus">-    // scope button, &quot;Find in &lt;current collection&gt;&quot; command, and the search box</span>
<a href="#l29.199"></a><span id="l29.199" class="difflineminus">-    // emptytext.  They must be updated even if the selection hasn't changed --</span>
<a href="#l29.200"></a><span id="l29.200" class="difflineminus">-    // specifically when node's title changes.  In that case a selection event</span>
<a href="#l29.201"></a><span id="l29.201" class="difflineminus">-    // is generated, this method is called, but the selection does not change.</span>
<a href="#l29.202"></a><span id="l29.202" class="difflineminus">-    var folderButton = document.getElementById(&quot;scopeBarFolder&quot;);</span>
<a href="#l29.203"></a><span id="l29.203" class="difflineminus">-    var folderTitle = node.title || folderButton.getAttribute(&quot;emptytitle&quot;);</span>
<a href="#l29.204"></a><span id="l29.204" class="difflineminus">-    folderButton.setAttribute(&quot;label&quot;, folderTitle);</span>
<a href="#l29.205"></a><span id="l29.205" class="difflineminus">-    var cmd = document.getElementById(&quot;OrganizerCommand_find:current&quot;);</span>
<a href="#l29.206"></a><span id="l29.206" class="difflineminus">-    var label = PlacesUIUtils.getFormattedString(&quot;findInPrefix&quot;, [folderTitle]);</span>
<a href="#l29.207"></a><span id="l29.207" class="difflineminus">-    cmd.setAttribute(&quot;label&quot;, label);</span>
<a href="#l29.208"></a><span id="l29.208" class="difflineminus">-    if (PlacesSearchBox.filterCollection == &quot;collection&quot;)</span>
<a href="#l29.209"></a><span id="l29.209" class="difflineminus">-      PlacesSearchBox.updateCollectionTitle(folderTitle);</span>
<a href="#l29.210"></a><span id="l29.210" class="difflineminus">-</span>
<a href="#l29.211"></a><span id="l29.211">     // When we invalidate a container we use suppressSelectionEvent, when it is</span>
<a href="#l29.212"></a><span id="l29.212">     // unset a select event is fired, in many cases the selection did not really</span>
<a href="#l29.213"></a><span id="l29.213">     // change, so we should check for it, and return early in such a case. Note</span>
<a href="#l29.214"></a><span id="l29.214">     // that we cannot return any earlier than this point, because when</span>
<a href="#l29.215"></a><span id="l29.215">     // !resetSearchBox, we need to update location and hide the UI as above,</span>
<a href="#l29.216"></a><span id="l29.216">     // even though the selection has not changed.</span>
<a href="#l29.217"></a><span id="l29.217">     if (node.uri == this._cachedLeftPaneSelectedURI)</span>
<a href="#l29.218"></a><span id="l29.218">       return;</span>
<a href="#l29.219"></a><span id="l29.219">     this._cachedLeftPaneSelectedURI = node.uri;</span>
<a href="#l29.220"></a><span id="l29.220"> </span>
<a href="#l29.221"></a><span id="l29.221">     // At this point, resetSearchBox is true, because the left pane selection</span>
<a href="#l29.222"></a><span id="l29.222">     // has changed; otherwise we would have returned earlier.</span>
<a href="#l29.223"></a><span id="l29.223"> </span>
<a href="#l29.224"></a><span id="l29.224">     PlacesSearchBox.searchFilter.reset();</span>
<a href="#l29.225"></a><span id="l29.225">     this._setSearchScopeForNode(node);</span>
<a href="#l29.226"></a><span id="l29.226" class="difflineminus">-    if (this._places.treeBoxObject.focused)</span>
<a href="#l29.227"></a><span id="l29.227" class="difflineminus">-      this._fillDetailsPane([node]);</span>
<a href="#l29.228"></a><span id="l29.228" class="difflineplus">+    this.updateDetailsPane();</span>
<a href="#l29.229"></a><span id="l29.229">   },</span>
<a href="#l29.230"></a><span id="l29.230"> </span>
<a href="#l29.231"></a><span id="l29.231">   /**</span>
<a href="#l29.232"></a><span id="l29.232">    * Sets the search scope based on aNode's properties.</span>
<a href="#l29.233"></a><span id="l29.233">    * @param   aNode</span>
<a href="#l29.234"></a><span id="l29.234">    *          the node to set up scope from</span>
<a href="#l29.235"></a><span id="l29.235">    */</span>
<a href="#l29.236"></a><span id="l29.236">   _setSearchScopeForNode: function PO__setScopeForNode(aNode) {</span>
<a href="#l29.237"></a><span id="l29.237" class="difflineminus">-    var itemId = aNode.itemId;</span>
<a href="#l29.238"></a><span id="l29.238" class="difflineminus">-    PlacesQueryBuilder.setScope(&quot;bookmarks&quot;);</span>
<a href="#l29.239"></a><span id="l29.239" class="difflineplus">+    let itemId = aNode.itemId;</span>
<a href="#l29.240"></a><span id="l29.240"> </span>
<a href="#l29.241"></a><span id="l29.241" class="difflineminus">-    // Enable or disable the folder scope button.</span>
<a href="#l29.242"></a><span id="l29.242" class="difflineminus">-    var folderButton = document.getElementById(&quot;scopeBarFolder&quot;);</span>
<a href="#l29.243"></a><span id="l29.243" class="difflineminus">-    folderButton.hidden = !PlacesUtils.nodeIsFolder(aNode) ||</span>
<a href="#l29.244"></a><span id="l29.244" class="difflineminus">-                          itemId == PlacesUIUtils.allBookmarksFolderId;</span>
<a href="#l29.245"></a><span id="l29.245" class="difflineplus">+    if (PlacesUtils.nodeIsHistoryContainer(aNode) ||</span>
<a href="#l29.246"></a><span id="l29.246" class="difflineplus">+        itemId == PlacesUIUtils.leftPaneQueries[&quot;History&quot;]) {</span>
<a href="#l29.247"></a><span id="l29.247" class="difflineplus">+      PlacesQueryBuilder.setScope(&quot;history&quot;);</span>
<a href="#l29.248"></a><span id="l29.248" class="difflineplus">+    } else {</span>
<a href="#l29.249"></a><span id="l29.249" class="difflineplus">+      // Default to All Bookmarks for all other nodes, per bug 469437.</span>
<a href="#l29.250"></a><span id="l29.250" class="difflineplus">+      PlacesQueryBuilder.setScope(&quot;bookmarks&quot;);</span>
<a href="#l29.251"></a><span id="l29.251" class="difflineplus">+    }</span>
<a href="#l29.252"></a><span id="l29.252">   },</span>
<a href="#l29.253"></a><span id="l29.253"> </span>
<a href="#l29.254"></a><span id="l29.254">   /**</span>
<a href="#l29.255"></a><span id="l29.255" class="difflineminus">-   * Handle clicks on the tree.</span>
<a href="#l29.256"></a><span id="l29.256" class="difflineplus">+   * Handle clicks on the places list.</span>
<a href="#l29.257"></a><span id="l29.257">    * Single Left click, right click or modified click do not result in any</span>
<a href="#l29.258"></a><span id="l29.258">    * special action, since they're related to selection.</span>
<a href="#l29.259"></a><span id="l29.259">    * @param   aEvent</span>
<a href="#l29.260"></a><span id="l29.260">    *          The mouse event.</span>
<a href="#l29.261"></a><span id="l29.261">    */</span>
<a href="#l29.262"></a><span id="l29.262" class="difflineminus">-  onTreeClick: function PO_onTreeClick(aEvent) {</span>
<a href="#l29.263"></a><span id="l29.263" class="difflineplus">+  onPlacesListClick: function PO_onPlacesListClick(aEvent) {</span>
<a href="#l29.264"></a><span id="l29.264">     // Only handle clicks on tree children.</span>
<a href="#l29.265"></a><span id="l29.265">     if (aEvent.target.localName != &quot;treechildren&quot;)</span>
<a href="#l29.266"></a><span id="l29.266">       return;</span>
<a href="#l29.267"></a><span id="l29.267"> </span>
<a href="#l29.268"></a><span id="l29.268" class="difflineminus">-    var currentView = aEvent.currentTarget;</span>
<a href="#l29.269"></a><span id="l29.269" class="difflineminus">-    var selectedNode = currentView.selectedNode;</span>
<a href="#l29.270"></a><span id="l29.270" class="difflineminus">-    if (selectedNode) {</span>
<a href="#l29.271"></a><span id="l29.271" class="difflineminus">-      // might be worth to ensure that double-click onley works in placeContent</span>
<a href="#l29.272"></a><span id="l29.272" class="difflineminus">-      var doubleClick = (aEvent.button == 0 &amp;&amp; aEvent.detail == 2);</span>
<a href="#l29.273"></a><span id="l29.273" class="difflineminus">-      var middleClick = (aEvent.button == 1 &amp;&amp; aEvent.detail == 1);</span>
<a href="#l29.274"></a><span id="l29.274" class="difflineminus">-</span>
<a href="#l29.275"></a><span id="l29.275" class="difflineminus">-      if (PlacesUtils.nodeIsURI(selectedNode) &amp;&amp;</span>
<a href="#l29.276"></a><span id="l29.276" class="difflineminus">-          (doubleClick || middleClick)) {</span>
<a href="#l29.277"></a><span id="l29.277" class="difflineminus">-        // Open associated uri in the browser.</span>
<a href="#l29.278"></a><span id="l29.278" class="difflineminus">-        PlacesOrganizer.openSelectedNode(aEvent);</span>
<a href="#l29.279"></a><span id="l29.279" class="difflineminus">-      }</span>
<a href="#l29.280"></a><span id="l29.280" class="difflineminus">-      else if (middleClick &amp;&amp;</span>
<a href="#l29.281"></a><span id="l29.281" class="difflineminus">-               PlacesUtils.nodeIsContainer(selectedNode)) {</span>
<a href="#l29.282"></a><span id="l29.282" class="difflineplus">+    let node = this._places.selectedNode;</span>
<a href="#l29.283"></a><span id="l29.283" class="difflineplus">+    if (node) {</span>
<a href="#l29.284"></a><span id="l29.284" class="difflineplus">+      let middleClick = aEvent.button == 1 &amp;&amp; aEvent.detail == 1;</span>
<a href="#l29.285"></a><span id="l29.285" class="difflineplus">+      if (middleClick &amp;&amp; PlacesUtils.nodeIsContainer(node)) {</span>
<a href="#l29.286"></a><span id="l29.286">         // The command execution function will take care of seeing if the</span>
<a href="#l29.287"></a><span id="l29.287">         // selection is a folder or a different container type, and will</span>
<a href="#l29.288"></a><span id="l29.288">         // load its contents in tabs.</span>
<a href="#l29.289"></a><span id="l29.289" class="difflineminus">-        PlacesUIUtils.openContainerNodeInTabs(selectedNode, aEvent);</span>
<a href="#l29.290"></a><span id="l29.290" class="difflineplus">+        PlacesUIUtils.openContainerNodeInTabs(node, aEvent, this._places);</span>
<a href="#l29.291"></a><span id="l29.291">       }</span>
<a href="#l29.292"></a><span id="l29.292">     }</span>
<a href="#l29.293"></a><span id="l29.293">   },</span>
<a href="#l29.294"></a><span id="l29.294"> </span>
<a href="#l29.295"></a><span id="l29.295">   /**</span>
<a href="#l29.296"></a><span id="l29.296" class="difflineminus">-   * Handle focus changes on the trees.</span>
<a href="#l29.297"></a><span id="l29.297" class="difflineminus">-   * When moving focus between panes we should update the details pane contents.</span>
<a href="#l29.298"></a><span id="l29.298" class="difflineminus">-   * @param   aEvent</span>
<a href="#l29.299"></a><span id="l29.299" class="difflineminus">-   *          The mouse event.</span>
<a href="#l29.300"></a><span id="l29.300" class="difflineplus">+   * Handle focus changes on the places list and the current content view.</span>
<a href="#l29.301"></a><span id="l29.301">    */</span>
<a href="#l29.302"></a><span id="l29.302" class="difflineminus">-  onTreeFocus: function PO_onTreeFocus(aEvent) {</span>
<a href="#l29.303"></a><span id="l29.303" class="difflineminus">-    var currentView = aEvent.currentTarget;</span>
<a href="#l29.304"></a><span id="l29.304" class="difflineminus">-    var selectedNodes = currentView.selectedNode ? [currentView.selectedNode] :</span>
<a href="#l29.305"></a><span id="l29.305" class="difflineminus">-                        this._content.selectedNodes;</span>
<a href="#l29.306"></a><span id="l29.306" class="difflineminus">-    this._fillDetailsPane(selectedNodes);</span>
<a href="#l29.307"></a><span id="l29.307" class="difflineplus">+  updateDetailsPane: function PO_updateDetailsPane() {</span>
<a href="#l29.308"></a><span id="l29.308" class="difflineplus">+    if (!ContentArea.currentViewOptions.showDetailsPane)</span>
<a href="#l29.309"></a><span id="l29.309" class="difflineplus">+      return;</span>
<a href="#l29.310"></a><span id="l29.310" class="difflineplus">+    let view = PlacesUIUtils.getViewForNode(document.activeElement);</span>
<a href="#l29.311"></a><span id="l29.311" class="difflineplus">+    if (view) {</span>
<a href="#l29.312"></a><span id="l29.312" class="difflineplus">+      let selectedNodes = view.selectedNode ?</span>
<a href="#l29.313"></a><span id="l29.313" class="difflineplus">+                          [view.selectedNode] : view.selectedNodes;</span>
<a href="#l29.314"></a><span id="l29.314" class="difflineplus">+      this._fillDetailsPane(selectedNodes);</span>
<a href="#l29.315"></a><span id="l29.315" class="difflineplus">+    }</span>
<a href="#l29.316"></a><span id="l29.316">   },</span>
<a href="#l29.317"></a><span id="l29.317"> </span>
<a href="#l29.318"></a><span id="l29.318">   openFlatContainer: function PO_openFlatContainerFlatContainer(aContainer) {</span>
<a href="#l29.319"></a><span id="l29.319" class="difflineminus">-    if (aContainer.itemId != -1)</span>
<a href="#l29.320"></a><span id="l29.320" class="difflineminus">-      this._places.selectItems([aContainer.itemId]);</span>
<a href="#l29.321"></a><span id="l29.321" class="difflineminus">-    else if (PlacesUtils.nodeIsQuery(aContainer))</span>
<a href="#l29.322"></a><span id="l29.322" class="difflineplus">+    if (aContainer.itemId != -1) {</span>
<a href="#l29.323"></a><span id="l29.323" class="difflineplus">+      PlacesUtils.asContainer(this._places.selectedNode).containerOpen = true;</span>
<a href="#l29.324"></a><span id="l29.324" class="difflineplus">+      this._places.selectItems([aContainer.itemId], false);</span>
<a href="#l29.325"></a><span id="l29.325" class="difflineplus">+    } else if (PlacesUtils.nodeIsQuery(aContainer)) {</span>
<a href="#l29.326"></a><span id="l29.326">       this._places.selectPlaceURI(aContainer.uri);</span>
<a href="#l29.327"></a><span id="l29.327" class="difflineminus">-  },</span>
<a href="#l29.328"></a><span id="l29.328" class="difflineminus">-</span>
<a href="#l29.329"></a><span id="l29.329" class="difflineminus">-  openSelectedNode: function PO_openSelectedNode(aEvent) {</span>
<a href="#l29.330"></a><span id="l29.330" class="difflineminus">-    PlacesUIUtils.openNodeWithEvent(this._content.selectedNode, aEvent);</span>
<a href="#l29.331"></a><span id="l29.331" class="difflineplus">+    }</span>
<a href="#l29.332"></a><span id="l29.332">   },</span>
<a href="#l29.333"></a><span id="l29.333"> </span>
<a href="#l29.334"></a><span id="l29.334">   /**</span>
<a href="#l29.335"></a><span id="l29.335">    * Returns the options associated with the query currently loaded in the</span>
<a href="#l29.336"></a><span id="l29.336">    * main places pane.</span>
<a href="#l29.337"></a><span id="l29.337">    */</span>
<a href="#l29.338"></a><span id="l29.338">   getCurrentOptions: function PO_getCurrentOptions() {</span>
<a href="#l29.339"></a><span id="l29.339" class="difflineminus">-    return PlacesUtils.asQuery(this._content.result.root).queryOptions;</span>
<a href="#l29.340"></a><span id="l29.340" class="difflineplus">+    return PlacesUtils.asQuery(ContentArea.currentView.result.root).queryOptions;</span>
<a href="#l29.341"></a><span id="l29.341">   },</span>
<a href="#l29.342"></a><span id="l29.342"> </span>
<a href="#l29.343"></a><span id="l29.343">   /**</span>
<a href="#l29.344"></a><span id="l29.344">    * Returns the queries associated with the query currently loaded in the</span>
<a href="#l29.345"></a><span id="l29.345">    * main places pane.</span>
<a href="#l29.346"></a><span id="l29.346">    */</span>
<a href="#l29.347"></a><span id="l29.347">   getCurrentQueries: function PO_getCurrentQueries() {</span>
<a href="#l29.348"></a><span id="l29.348" class="difflineminus">-    return PlacesUtils.asQuery(this._content.result.root).getQueries();</span>
<a href="#l29.349"></a><span id="l29.349" class="difflineplus">+    return PlacesUtils.asQuery(ContentArea.currentView.result.root).getQueries();</span>
<a href="#l29.350"></a><span id="l29.350">   },</span>
<a href="#l29.351"></a><span id="l29.351"> </span>
<a href="#l29.352"></a><span id="l29.352">   /**</span>
<a href="#l29.353"></a><span id="l29.353" class="difflineminus">-   * Show the migration wizard for importing from a file.</span>
<a href="#l29.354"></a><span id="l29.354" class="difflineplus">+   * Show the migration wizard for importing passwords,</span>
<a href="#l29.355"></a><span id="l29.355" class="difflineplus">+   * cookies, history, preferences, and bookmarks.</span>
<a href="#l29.356"></a><span id="l29.356">    */</span>
<a href="#l29.357"></a><span id="l29.357" class="difflineminus">-  importBookmarks: function PO_import() {</span>
<a href="#l29.358"></a><span id="l29.358" class="difflineminus">-    // XXX: ifdef it to be non-modal (non-&quot;sheet&quot;) on mac (see bug 259039)</span>
<a href="#l29.359"></a><span id="l29.359" class="difflineminus">-    var features = &quot;modal,centerscreen,chrome,resizable=no&quot;;</span>
<a href="#l29.360"></a><span id="l29.360" class="difflineminus">-</span>
<a href="#l29.361"></a><span id="l29.361" class="difflineminus">-    // The migrator window will set this to true when it closes, if the user</span>
<a href="#l29.362"></a><span id="l29.362" class="difflineminus">-    // chose to migrate from a specific file.</span>
<a href="#l29.363"></a><span id="l29.363" class="difflineminus">-    window.fromFile = false;</span>
<a href="#l29.364"></a><span id="l29.364" class="difflineminus">-    openDialog(&quot;chrome://communicator/content/migration/migration.xul&quot;,</span>
<a href="#l29.365"></a><span id="l29.365" class="difflineminus">-               &quot;migration&quot;, features, &quot;bookmarks&quot;);</span>
<a href="#l29.366"></a><span id="l29.366" class="difflineminus">-    if (window.fromFile)</span>
<a href="#l29.367"></a><span id="l29.367" class="difflineminus">-      this.importFromFile();</span>
<a href="#l29.368"></a><span id="l29.368" class="difflineplus">+  importFromBrowser: function PO_importFromBrowser() {</span>
<a href="#l29.369"></a><span id="l29.369" class="difflineplus">+    // We pass in the type of source we're using for use in telemetry:</span>
<a href="#l29.370"></a><span id="l29.370" class="difflineplus">+    MigrationUtils.showMigrationWizard(window, [MigrationUtils.MIGRATION_ENTRYPOINT_PLACES]);</span>
<a href="#l29.371"></a><span id="l29.371">   },</span>
<a href="#l29.372"></a><span id="l29.372"> </span>
<a href="#l29.373"></a><span id="l29.373">   /**</span>
<a href="#l29.374"></a><span id="l29.374">    * Open a file-picker and import the selected file into the bookmarks store</span>
<a href="#l29.375"></a><span id="l29.375">    */</span>
<a href="#l29.376"></a><span id="l29.376">   importFromFile: function PO_importFromFile() {</span>
<a href="#l29.377"></a><span id="l29.377" class="difflineminus">-    let fp = Cc[&quot;@mozilla.org/filepicker;1&quot;]</span>
<a href="#l29.378"></a><span id="l29.378" class="difflineminus">-               .createInstance(Ci.nsIFilePicker);</span>
<a href="#l29.379"></a><span id="l29.379" class="difflineplus">+    let fp = Cc[&quot;@mozilla.org/filepicker;1&quot;].createInstance(Ci.nsIFilePicker);</span>
<a href="#l29.380"></a><span id="l29.380">     let fpCallback = function fpCallback_done(aResult) {</span>
<a href="#l29.381"></a><span id="l29.381">       if (aResult != Ci.nsIFilePicker.returnCancel &amp;&amp; fp.fileURL) {</span>
<a href="#l29.382"></a><span id="l29.382">         ChromeUtils.import(&quot;resource://gre/modules/BookmarkHTMLUtils.jsm&quot;);</span>
<a href="#l29.383"></a><span id="l29.383">         BookmarkHTMLUtils.importFromURL(fp.fileURL.spec, false)</span>
<a href="#l29.384"></a><span id="l29.384">                          .catch(Cu.reportError);</span>
<a href="#l29.385"></a><span id="l29.385">       }</span>
<a href="#l29.386"></a><span id="l29.386">     };</span>
<a href="#l29.387"></a><span id="l29.387"> </span>
<a href="#l29.388"></a><span id="l29.388" class="difflineat">@@ -339,18 +368,17 @@ var PlacesOrganizer = {</span>
<a href="#l29.389"></a><span id="l29.389">     fp.appendFilters(Ci.nsIFilePicker.filterHTML);</span>
<a href="#l29.390"></a><span id="l29.390">     fp.open(fpCallback);</span>
<a href="#l29.391"></a><span id="l29.391">   },</span>
<a href="#l29.392"></a><span id="l29.392"> </span>
<a href="#l29.393"></a><span id="l29.393">   /**</span>
<a href="#l29.394"></a><span id="l29.394">    * Allows simple exporting of bookmarks.</span>
<a href="#l29.395"></a><span id="l29.395">    */</span>
<a href="#l29.396"></a><span id="l29.396">   exportBookmarks: function PO_exportBookmarks() {</span>
<a href="#l29.397"></a><span id="l29.397" class="difflineminus">-    let fp = Cc[&quot;@mozilla.org/filepicker;1&quot;]</span>
<a href="#l29.398"></a><span id="l29.398" class="difflineminus">-               .createInstance(Ci.nsIFilePicker);</span>
<a href="#l29.399"></a><span id="l29.399" class="difflineplus">+    let fp = Cc[&quot;@mozilla.org/filepicker;1&quot;].createInstance(Ci.nsIFilePicker);</span>
<a href="#l29.400"></a><span id="l29.400">     let fpCallback = function fpCallback_done(aResult) {</span>
<a href="#l29.401"></a><span id="l29.401">       if (aResult != Ci.nsIFilePicker.returnCancel) {</span>
<a href="#l29.402"></a><span id="l29.402">         ChromeUtils.import(&quot;resource://gre/modules/BookmarkHTMLUtils.jsm&quot;);</span>
<a href="#l29.403"></a><span id="l29.403">         BookmarkHTMLUtils.exportToFile(fp.file.path)</span>
<a href="#l29.404"></a><span id="l29.404">                          .catch(Cu.reportError);</span>
<a href="#l29.405"></a><span id="l29.405">       }</span>
<a href="#l29.406"></a><span id="l29.406">     };</span>
<a href="#l29.407"></a><span id="l29.407"> </span>
<a href="#l29.408"></a><span id="l29.408" class="difflineat">@@ -362,180 +390,190 @@ var PlacesOrganizer = {</span>
<a href="#l29.409"></a><span id="l29.409">   },</span>
<a href="#l29.410"></a><span id="l29.410"> </span>
<a href="#l29.411"></a><span id="l29.411">   /**</span>
<a href="#l29.412"></a><span id="l29.412">    * Populates the restore menu with the dates of the backups available.</span>
<a href="#l29.413"></a><span id="l29.413">    */</span>
<a href="#l29.414"></a><span id="l29.414">   populateRestoreMenu: function PO_populateRestoreMenu() {</span>
<a href="#l29.415"></a><span id="l29.415">     let restorePopup = document.getElementById(&quot;fileRestorePopup&quot;);</span>
<a href="#l29.416"></a><span id="l29.416"> </span>
<a href="#l29.417"></a><span id="l29.417" class="difflineminus">-    const locale = Cc[&quot;@mozilla.org/chrome/chrome-registry;1&quot;]</span>
<a href="#l29.418"></a><span id="l29.418" class="difflineminus">-                     .getService(Ci.nsIXULChromeRegistry)</span>
<a href="#l29.419"></a><span id="l29.419" class="difflineminus">-                     .getSelectedLocale(&quot;global&quot;, true);</span>
<a href="#l29.420"></a><span id="l29.420" class="difflineminus">-    const dtOptions = { year: 'numeric', month: 'long', day: 'numeric' };</span>
<a href="#l29.421"></a><span id="l29.421" class="difflineminus">-    let dateFormatter = new Intl.DateTimeFormat(locale, dtOptions);</span>
<a href="#l29.422"></a><span id="l29.422" class="difflineplus">+    const dtOptions = {</span>
<a href="#l29.423"></a><span id="l29.423" class="difflineplus">+      dateStyle: &quot;long&quot;</span>
<a href="#l29.424"></a><span id="l29.424" class="difflineplus">+    };</span>
<a href="#l29.425"></a><span id="l29.425" class="difflineplus">+    let dateFormatter = Services.intl.createDateTimeFormat(undefined, dtOptions);</span>
<a href="#l29.426"></a><span id="l29.426"> </span>
<a href="#l29.427"></a><span id="l29.427" class="difflineminus">-    // Remove existing menu items. Last item is the restoreFromFile item.</span>
<a href="#l29.428"></a><span id="l29.428" class="difflineplus">+    // Remove existing menu items.  Last item is the restoreFromFile item.</span>
<a href="#l29.429"></a><span id="l29.429">     while (restorePopup.childNodes.length &gt; 1)</span>
<a href="#l29.430"></a><span id="l29.430">       restorePopup.firstChild.remove();</span>
<a href="#l29.431"></a><span id="l29.431"> </span>
<a href="#l29.432"></a><span id="l29.432" class="difflineminus">-    let backupFiles = PlacesBackups.entries;</span>
<a href="#l29.433"></a><span id="l29.433" class="difflineminus">-    if (backupFiles.length == 0)</span>
<a href="#l29.434"></a><span id="l29.434" class="difflineminus">-      return;</span>
<a href="#l29.435"></a><span id="l29.435" class="difflineplus">+    (async function() {</span>
<a href="#l29.436"></a><span id="l29.436" class="difflineplus">+      let backupFiles = await PlacesBackups.getBackupFiles();</span>
<a href="#l29.437"></a><span id="l29.437" class="difflineplus">+      if (backupFiles.length == 0)</span>
<a href="#l29.438"></a><span id="l29.438" class="difflineplus">+        return;</span>
<a href="#l29.439"></a><span id="l29.439"> </span>
<a href="#l29.440"></a><span id="l29.440" class="difflineminus">-    // Populate menu with backups.</span>
<a href="#l29.441"></a><span id="l29.441" class="difflineminus">-    for (let i = 0; i &lt; backupFiles.length; i++) {</span>
<a href="#l29.442"></a><span id="l29.442" class="difflineminus">-      let backupDate = PlacesBackups.getDateForFile(backupFiles[i]);</span>
<a href="#l29.443"></a><span id="l29.443" class="difflineminus">-      let m = restorePopup.insertBefore(document.createElement(&quot;menuitem&quot;),</span>
<a href="#l29.444"></a><span id="l29.444" class="difflineminus">-                                        document.getElementById(&quot;restoreFromFile&quot;));</span>
<a href="#l29.445"></a><span id="l29.445" class="difflineminus">-      m.setAttribute(&quot;label&quot;, dateFormatter.format(backupDate));</span>
<a href="#l29.446"></a><span id="l29.446" class="difflineminus">-      m.setAttribute(&quot;value&quot;, backupFiles[i].leafName);</span>
<a href="#l29.447"></a><span id="l29.447" class="difflineminus">-      m.setAttribute(&quot;oncommand&quot;,</span>
<a href="#l29.448"></a><span id="l29.448" class="difflineminus">-                     &quot;PlacesOrganizer.onRestoreMenuItemClick(this);&quot;);</span>
<a href="#l29.449"></a><span id="l29.449" class="difflineminus">-    }</span>
<a href="#l29.450"></a><span id="l29.450" class="difflineplus">+      // Populate menu with backups.</span>
<a href="#l29.451"></a><span id="l29.451" class="difflineplus">+      for (let i = 0; i &lt; backupFiles.length; i++) {</span>
<a href="#l29.452"></a><span id="l29.452" class="difflineplus">+        let fileSize = (await OS.File.stat(backupFiles[i])).size;</span>
<a href="#l29.453"></a><span id="l29.453" class="difflineplus">+        let [size, unit] = DownloadUtils.convertByteUnits(fileSize);</span>
<a href="#l29.454"></a><span id="l29.454" class="difflineplus">+        let sizeString = PlacesUtils.getFormattedString(&quot;backupFileSizeText&quot;,</span>
<a href="#l29.455"></a><span id="l29.455" class="difflineplus">+                                                        [size, unit]);</span>
<a href="#l29.456"></a><span id="l29.456" class="difflineplus">+        let sizeInfo;</span>
<a href="#l29.457"></a><span id="l29.457" class="difflineplus">+        let bookmarkCount = PlacesBackups.getBookmarkCountForFile(backupFiles[i]);</span>
<a href="#l29.458"></a><span id="l29.458" class="difflineplus">+        if (bookmarkCount != null) {</span>
<a href="#l29.459"></a><span id="l29.459" class="difflineplus">+          sizeInfo = &quot; (&quot; + sizeString + &quot; - &quot; +</span>
<a href="#l29.460"></a><span id="l29.460" class="difflineplus">+                     PlacesUIUtils.getPluralString(&quot;detailsPane.itemsCountLabel&quot;,</span>
<a href="#l29.461"></a><span id="l29.461" class="difflineplus">+                                                   bookmarkCount,</span>
<a href="#l29.462"></a><span id="l29.462" class="difflineplus">+                                                   [bookmarkCount]) +</span>
<a href="#l29.463"></a><span id="l29.463" class="difflineplus">+                     &quot;)&quot;;</span>
<a href="#l29.464"></a><span id="l29.464" class="difflineplus">+        } else {</span>
<a href="#l29.465"></a><span id="l29.465" class="difflineplus">+          sizeInfo = &quot; (&quot; + sizeString + &quot;)&quot;;</span>
<a href="#l29.466"></a><span id="l29.466" class="difflineplus">+        }</span>
<a href="#l29.467"></a><span id="l29.467"> </span>
<a href="#l29.468"></a><span id="l29.468" class="difflineminus">-    // Add the restoreFromFile item.</span>
<a href="#l29.469"></a><span id="l29.469" class="difflineminus">-    restorePopup.insertBefore(document.createElement(&quot;menuseparator&quot;),</span>
<a href="#l29.470"></a><span id="l29.470" class="difflineminus">-                              document.getElementById(&quot;restoreFromFile&quot;));</span>
<a href="#l29.471"></a><span id="l29.471" class="difflineplus">+        let backupDate = PlacesBackups.getDateForFile(backupFiles[i]);</span>
<a href="#l29.472"></a><span id="l29.472" class="difflineplus">+        let m = restorePopup.insertBefore(document.createElement(&quot;menuitem&quot;),</span>
<a href="#l29.473"></a><span id="l29.473" class="difflineplus">+                                          document.getElementById(&quot;restoreFromFile&quot;));</span>
<a href="#l29.474"></a><span id="l29.474" class="difflineplus">+        m.setAttribute(&quot;label&quot;, dateFormatter.format(backupDate) + sizeInfo);</span>
<a href="#l29.475"></a><span id="l29.475" class="difflineplus">+        m.setAttribute(&quot;value&quot;, OS.Path.basename(backupFiles[i]));</span>
<a href="#l29.476"></a><span id="l29.476" class="difflineplus">+        m.setAttribute(&quot;oncommand&quot;,</span>
<a href="#l29.477"></a><span id="l29.477" class="difflineplus">+                       &quot;PlacesOrganizer.onRestoreMenuItemClick(this);&quot;);</span>
<a href="#l29.478"></a><span id="l29.478" class="difflineplus">+      }</span>
<a href="#l29.479"></a><span id="l29.479" class="difflineplus">+</span>
<a href="#l29.480"></a><span id="l29.480" class="difflineplus">+      // Add the restoreFromFile item.</span>
<a href="#l29.481"></a><span id="l29.481" class="difflineplus">+      restorePopup.insertBefore(document.createElement(&quot;menuseparator&quot;),</span>
<a href="#l29.482"></a><span id="l29.482" class="difflineplus">+                                document.getElementById(&quot;restoreFromFile&quot;));</span>
<a href="#l29.483"></a><span id="l29.483" class="difflineplus">+    })();</span>
<a href="#l29.484"></a><span id="l29.484">   },</span>
<a href="#l29.485"></a><span id="l29.485"> </span>
<a href="#l29.486"></a><span id="l29.486">   /**</span>
<a href="#l29.487"></a><span id="l29.487">    * Called when a menuitem is selected from the restore menu.</span>
<a href="#l29.488"></a><span id="l29.488">    */</span>
<a href="#l29.489"></a><span id="l29.489" class="difflineminus">-  onRestoreMenuItemClick: function PO_onRestoreMenuItemClick(aMenuItem) {</span>
<a href="#l29.490"></a><span id="l29.490" class="difflineplus">+  async onRestoreMenuItemClick(aMenuItem) {</span>
<a href="#l29.491"></a><span id="l29.491">     let backupName = aMenuItem.getAttribute(&quot;value&quot;);</span>
<a href="#l29.492"></a><span id="l29.492" class="difflineminus">-    let backupFiles = PlacesBackups.entries;</span>
<a href="#l29.493"></a><span id="l29.493" class="difflineminus">-    for (let i = 0; i &lt; backupFiles.length; i++) {</span>
<a href="#l29.494"></a><span id="l29.494" class="difflineminus">-      if (backupFiles[i].leafName == backupName) {</span>
<a href="#l29.495"></a><span id="l29.495" class="difflineminus">-        this.restoreBookmarksFromFile(backupFiles[i]);</span>
<a href="#l29.496"></a><span id="l29.496" class="difflineplus">+    let backupFilePaths = await PlacesBackups.getBackupFiles();</span>
<a href="#l29.497"></a><span id="l29.497" class="difflineplus">+    for (let backupFilePath of backupFilePaths) {</span>
<a href="#l29.498"></a><span id="l29.498" class="difflineplus">+      if (OS.Path.basename(backupFilePath) == backupName) {</span>
<a href="#l29.499"></a><span id="l29.499" class="difflineplus">+        PlacesOrganizer.restoreBookmarksFromFile(backupFilePath);</span>
<a href="#l29.500"></a><span id="l29.500">         break;</span>
<a href="#l29.501"></a><span id="l29.501">       }</span>
<a href="#l29.502"></a><span id="l29.502">     }</span>
<a href="#l29.503"></a><span id="l29.503">   },</span>
<a href="#l29.504"></a><span id="l29.504"> </span>
<a href="#l29.505"></a><span id="l29.505">   /**</span>
<a href="#l29.506"></a><span id="l29.506">    * Called when 'Choose File...' is selected from the restore menu.</span>
<a href="#l29.507"></a><span id="l29.507">    * Prompts for a file and restores bookmarks to those in the file.</span>
<a href="#l29.508"></a><span id="l29.508">    */</span>
<a href="#l29.509"></a><span id="l29.509">   onRestoreBookmarksFromFile: function PO_onRestoreBookmarksFromFile() {</span>
<a href="#l29.510"></a><span id="l29.510" class="difflineminus">-    let fp = Cc[&quot;@mozilla.org/filepicker;1&quot;]</span>
<a href="#l29.511"></a><span id="l29.511" class="difflineminus">-               .createInstance(Ci.nsIFilePicker);</span>
<a href="#l29.512"></a><span id="l29.512" class="difflineplus">+    let dirSvc = Cc[&quot;@mozilla.org/file/directory_service;1&quot;]</span>
<a href="#l29.513"></a><span id="l29.513" class="difflineplus">+                   .getService(Ci.nsIProperties);</span>
<a href="#l29.514"></a><span id="l29.514" class="difflineplus">+    let backupsDir = dirSvc.get(&quot;Desk&quot;, Ci.nsIFile);</span>
<a href="#l29.515"></a><span id="l29.515" class="difflineplus">+    let fp = Cc[&quot;@mozilla.org/filepicker;1&quot;].createInstance(Ci.nsIFilePicker);</span>
<a href="#l29.516"></a><span id="l29.516">     let fpCallback = aResult =&gt; {</span>
<a href="#l29.517"></a><span id="l29.517">       if (aResult != Ci.nsIFilePicker.returnCancel) {</span>
<a href="#l29.518"></a><span id="l29.518" class="difflineminus">-        this.restoreBookmarksFromFile(fp.file);</span>
<a href="#l29.519"></a><span id="l29.519" class="difflineplus">+        this.restoreBookmarksFromFile(fp.file.path);</span>
<a href="#l29.520"></a><span id="l29.520">       }</span>
<a href="#l29.521"></a><span id="l29.521">     };</span>
<a href="#l29.522"></a><span id="l29.522"> </span>
<a href="#l29.523"></a><span id="l29.523">     fp.init(window, PlacesUIUtils.getString(&quot;bookmarksRestoreTitle&quot;),</span>
<a href="#l29.524"></a><span id="l29.524">             Ci.nsIFilePicker.modeOpen);</span>
<a href="#l29.525"></a><span id="l29.525">     fp.appendFilter(PlacesUIUtils.getString(&quot;bookmarksRestoreFilterName&quot;),</span>
<a href="#l29.526"></a><span id="l29.526" class="difflineminus">-                    PlacesUIUtils.getString(&quot;bookmarksRestoreFilterExtension&quot;));</span>
<a href="#l29.527"></a><span id="l29.527" class="difflineplus">+                    RESTORE_FILEPICKER_FILTER_EXT);</span>
<a href="#l29.528"></a><span id="l29.528">     fp.appendFilters(Ci.nsIFilePicker.filterAll);</span>
<a href="#l29.529"></a><span id="l29.529" class="difflineminus">-    fp.displayDirectory = GetDesktopFolder();</span>
<a href="#l29.530"></a><span id="l29.530" class="difflineplus">+    fp.displayDirectory = backupsDir;</span>
<a href="#l29.531"></a><span id="l29.531">     fp.open(fpCallback);</span>
<a href="#l29.532"></a><span id="l29.532">   },</span>
<a href="#l29.533"></a><span id="l29.533"> </span>
<a href="#l29.534"></a><span id="l29.534">   /**</span>
<a href="#l29.535"></a><span id="l29.535">    * Restores bookmarks from a JSON file.</span>
<a href="#l29.536"></a><span id="l29.536">    */</span>
<a href="#l29.537"></a><span id="l29.537" class="difflineminus">-  restoreBookmarksFromFile: function PO_restoreBookmarksFromFile(aFile) {</span>
<a href="#l29.538"></a><span id="l29.538" class="difflineplus">+  restoreBookmarksFromFile: function PO_restoreBookmarksFromFile(aFilePath) {</span>
<a href="#l29.539"></a><span id="l29.539">     // check file extension</span>
<a href="#l29.540"></a><span id="l29.540" class="difflineminus">-    if (!/\.json(?:lz4)?$/i.test(aFile.leafName)) {</span>
<a href="#l29.541"></a><span id="l29.541" class="difflineplus">+    if (!aFilePath.toLowerCase().endsWith(&quot;json&quot;) &amp;&amp;</span>
<a href="#l29.542"></a><span id="l29.542" class="difflineplus">+        !aFilePath.toLowerCase().endsWith(&quot;jsonlz4&quot;)) {</span>
<a href="#l29.543"></a><span id="l29.543">       this._showErrorAlert(PlacesUIUtils.getString(&quot;bookmarksRestoreFormatError&quot;));</span>
<a href="#l29.544"></a><span id="l29.544">       return;</span>
<a href="#l29.545"></a><span id="l29.545">     }</span>
<a href="#l29.546"></a><span id="l29.546"> </span>
<a href="#l29.547"></a><span id="l29.547">     // confirm ok to delete existing bookmarks</span>
<a href="#l29.548"></a><span id="l29.548" class="difflineminus">-    if (!Services.prompt.confirm(null,</span>
<a href="#l29.549"></a><span id="l29.549" class="difflineminus">-                                 PlacesUIUtils.getString(&quot;bookmarksRestoreAlertTitle&quot;),</span>
<a href="#l29.550"></a><span id="l29.550" class="difflineminus">-                                 PlacesUIUtils.getString(&quot;bookmarksRestoreAlert&quot;)))</span>
<a href="#l29.551"></a><span id="l29.551" class="difflineplus">+    var prompts = Cc[&quot;@mozilla.org/embedcomp/prompt-service;1&quot;]</span>
<a href="#l29.552"></a><span id="l29.552" class="difflineplus">+                    .getService(Ci.nsIPromptService);</span>
<a href="#l29.553"></a><span id="l29.553" class="difflineplus">+    if (!prompts.confirm(null,</span>
<a href="#l29.554"></a><span id="l29.554" class="difflineplus">+                         PlacesUIUtils.getString(&quot;bookmarksRestoreAlertTitle&quot;),</span>
<a href="#l29.555"></a><span id="l29.555" class="difflineplus">+                         PlacesUIUtils.getString(&quot;bookmarksRestoreAlert&quot;)))</span>
<a href="#l29.556"></a><span id="l29.556">       return;</span>
<a href="#l29.557"></a><span id="l29.557"> </span>
<a href="#l29.558"></a><span id="l29.558" class="difflineminus">-    BookmarkJSONUtils.importFromFile(aFile.path, true).catch(() =&gt; {</span>
<a href="#l29.559"></a><span id="l29.559" class="difflineminus">-      this._showErrorAlert(PlacesUIUtils.getString(&quot;bookmarksRestoreParseError&quot;));</span>
<a href="#l29.560"></a><span id="l29.560" class="difflineminus">-    });</span>
<a href="#l29.561"></a><span id="l29.561" class="difflineplus">+    (async function() {</span>
<a href="#l29.562"></a><span id="l29.562" class="difflineplus">+      try {</span>
<a href="#l29.563"></a><span id="l29.563" class="difflineplus">+        await BookmarkJSONUtils.importFromFile(aFilePath, true);</span>
<a href="#l29.564"></a><span id="l29.564" class="difflineplus">+      } catch (ex) {</span>
<a href="#l29.565"></a><span id="l29.565" class="difflineplus">+        PlacesOrganizer._showErrorAlert(PlacesUIUtils.getString(&quot;bookmarksRestoreParseError&quot;));</span>
<a href="#l29.566"></a><span id="l29.566" class="difflineplus">+      }</span>
<a href="#l29.567"></a><span id="l29.567" class="difflineplus">+    })();</span>
<a href="#l29.568"></a><span id="l29.568">   },</span>
<a href="#l29.569"></a><span id="l29.569"> </span>
<a href="#l29.570"></a><span id="l29.570">   _showErrorAlert: function PO__showErrorAlert(aMsg) {</span>
<a href="#l29.571"></a><span id="l29.571" class="difflineminus">-    var brandShortName = document.getElementById(&quot;brandStrings&quot;)</span>
<a href="#l29.572"></a><span id="l29.572" class="difflineminus">-                                 .getString(&quot;brandShortName&quot;);</span>
<a href="#l29.573"></a><span id="l29.573" class="difflineplus">+    var brandShortName = document.getElementById(&quot;brandStrings&quot;).</span>
<a href="#l29.574"></a><span id="l29.574" class="difflineplus">+                                  getString(&quot;brandShortName&quot;);</span>
<a href="#l29.575"></a><span id="l29.575"> </span>
<a href="#l29.576"></a><span id="l29.576" class="difflineminus">-    Services.prompt.alert(window, brandShortName, aMsg);</span>
<a href="#l29.577"></a><span id="l29.577" class="difflineplus">+    Cc[&quot;@mozilla.org/embedcomp/prompt-service;1&quot;]</span>
<a href="#l29.578"></a><span id="l29.578" class="difflineplus">+      .getService(Ci.nsIPromptService)</span>
<a href="#l29.579"></a><span id="l29.579" class="difflineplus">+      .alert(window, brandShortName, aMsg);</span>
<a href="#l29.580"></a><span id="l29.580">   },</span>
<a href="#l29.581"></a><span id="l29.581"> </span>
<a href="#l29.582"></a><span id="l29.582">   /**</span>
<a href="#l29.583"></a><span id="l29.583">    * Backup bookmarks to desktop, auto-generate a filename with a date.</span>
<a href="#l29.584"></a><span id="l29.584">    * The file is a JSON serialization of bookmarks, tags and any annotations</span>
<a href="#l29.585"></a><span id="l29.585">    * of those items.</span>
<a href="#l29.586"></a><span id="l29.586">    */</span>
<a href="#l29.587"></a><span id="l29.587">   backupBookmarks: function PO_backupBookmarks() {</span>
<a href="#l29.588"></a><span id="l29.588" class="difflineminus">-    let fp = Cc[&quot;@mozilla.org/filepicker;1&quot;]</span>
<a href="#l29.589"></a><span id="l29.589" class="difflineminus">-               .createInstance(Ci.nsIFilePicker);</span>
<a href="#l29.590"></a><span id="l29.590" class="difflineplus">+    let dirSvc = Cc[&quot;@mozilla.org/file/directory_service;1&quot;]</span>
<a href="#l29.591"></a><span id="l29.591" class="difflineplus">+                   .getService(Ci.nsIProperties);</span>
<a href="#l29.592"></a><span id="l29.592" class="difflineplus">+    let backupsDir = dirSvc.get(&quot;Desk&quot;, Ci.nsILocalFile);</span>
<a href="#l29.593"></a><span id="l29.593" class="difflineplus">+    let fp = Cc[&quot;@mozilla.org/filepicker;1&quot;].createInstance(Ci.nsIFilePicker);</span>
<a href="#l29.594"></a><span id="l29.594">     let fpCallback = function fpCallback_done(aResult) {</span>
<a href="#l29.595"></a><span id="l29.595">       if (aResult != Ci.nsIFilePicker.returnCancel) {</span>
<a href="#l29.596"></a><span id="l29.596">         // There is no OS.File version of the filepicker yet (Bug 937812).</span>
<a href="#l29.597"></a><span id="l29.597">         PlacesBackups.saveBookmarksToJSONFile(fp.file.path);</span>
<a href="#l29.598"></a><span id="l29.598">       }</span>
<a href="#l29.599"></a><span id="l29.599">     };</span>
<a href="#l29.600"></a><span id="l29.600"> </span>
<a href="#l29.601"></a><span id="l29.601">     fp.init(window, PlacesUIUtils.getString(&quot;bookmarksBackupTitle&quot;),</span>
<a href="#l29.602"></a><span id="l29.602">             Ci.nsIFilePicker.modeSave);</span>
<a href="#l29.603"></a><span id="l29.603">     fp.appendFilter(PlacesUIUtils.getString(&quot;bookmarksRestoreFilterName&quot;),</span>
<a href="#l29.604"></a><span id="l29.604" class="difflineminus">-                    PlacesUIUtils.getString(&quot;bookmarksRestoreFilterExtension&quot;));</span>
<a href="#l29.605"></a><span id="l29.605" class="difflineminus">-</span>
<a href="#l29.606"></a><span id="l29.606" class="difflineminus">-    var dirSvc = Cc[&quot;@mozilla.org/file/directory_service;1&quot;]</span>
<a href="#l29.607"></a><span id="l29.607" class="difflineminus">-                   .getService(Ci.nsIProperties);</span>
<a href="#l29.608"></a><span id="l29.608" class="difflineminus">-    var backupsDir = dirSvc.get(&quot;Desk&quot;, Ci.nsIFile);</span>
<a href="#l29.609"></a><span id="l29.609" class="difflineminus">-    fp.displayDirectory = backupsDir;</span>
<a href="#l29.610"></a><span id="l29.610" class="difflineplus">+                    RESTORE_FILEPICKER_FILTER_EXT);</span>
<a href="#l29.611"></a><span id="l29.611">     fp.defaultString = PlacesBackups.getFilenameForDate();</span>
<a href="#l29.612"></a><span id="l29.612">     fp.defaultExtension = &quot;json&quot;;</span>
<a href="#l29.613"></a><span id="l29.613" class="difflineplus">+    fp.displayDirectory = backupsDir;</span>
<a href="#l29.614"></a><span id="l29.614">     fp.open(fpCallback);</span>
<a href="#l29.615"></a><span id="l29.615">   },</span>
<a href="#l29.616"></a><span id="l29.616"> </span>
<a href="#l29.617"></a><span id="l29.617" class="difflineminus">-  _paneDisabled: false,</span>
<a href="#l29.618"></a><span id="l29.618" class="difflineminus">-  _setDetailsFieldsDisabledState:</span>
<a href="#l29.619"></a><span id="l29.619" class="difflineminus">-  function PO__setDetailsFieldsDisabledState(aDisabled) {</span>
<a href="#l29.620"></a><span id="l29.620" class="difflineminus">-    if (aDisabled) {</span>
<a href="#l29.621"></a><span id="l29.621" class="difflineminus">-      document.getElementById(&quot;paneElementsBroadcaster&quot;)</span>
<a href="#l29.622"></a><span id="l29.622" class="difflineminus">-              .setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l29.623"></a><span id="l29.623" class="difflineminus">-    }</span>
<a href="#l29.624"></a><span id="l29.624" class="difflineminus">-    else {</span>
<a href="#l29.625"></a><span id="l29.625" class="difflineminus">-      document.getElementById(&quot;paneElementsBroadcaster&quot;)</span>
<a href="#l29.626"></a><span id="l29.626" class="difflineminus">-              .removeAttribute(&quot;disabled&quot;);</span>
<a href="#l29.627"></a><span id="l29.627" class="difflineminus">-    }</span>
<a href="#l29.628"></a><span id="l29.628" class="difflineminus">-  },</span>
<a href="#l29.629"></a><span id="l29.629" class="difflineminus">-</span>
<a href="#l29.630"></a><span id="l29.630">   _detectAndSetDetailsPaneMinimalState:</span>
<a href="#l29.631"></a><span id="l29.631">   function PO__detectAndSetDetailsPaneMinimalState(aNode) {</span>
<a href="#l29.632"></a><span id="l29.632">     /**</span>
<a href="#l29.633"></a><span id="l29.633">      * The details of simple folder-items (as opposed to livemarks) or the</span>
<a href="#l29.634"></a><span id="l29.634">      * of livemark-children are not likely to fill the infoBox anyway,</span>
<a href="#l29.635"></a><span id="l29.635">      * thus we remove the &quot;More/Less&quot; button and show all details.</span>
<a href="#l29.636"></a><span id="l29.636">      *</span>
<a href="#l29.637"></a><span id="l29.637" class="difflineminus">-     * the wasminimal attribute here is used to persist the &quot;more/fewer&quot;</span>
<a href="#l29.638"></a><span id="l29.638" class="difflineplus">+     * the wasminimal attribute here is used to persist the &quot;more/less&quot;</span>
<a href="#l29.639"></a><span id="l29.639">      * state in a bookmark-&gt;folder-&gt;bookmark scenario.</span>
<a href="#l29.640"></a><span id="l29.640">      */</span>
<a href="#l29.641"></a><span id="l29.641">     var infoBox = document.getElementById(&quot;infoBox&quot;);</span>
<a href="#l29.642"></a><span id="l29.642" class="difflineminus">-    var infoBoxExpander = document.getElementById(&quot;infoBoxExpander&quot;);</span>
<a href="#l29.643"></a><span id="l29.643">     var infoBoxExpanderWrapper = document.getElementById(&quot;infoBoxExpanderWrapper&quot;);</span>
<a href="#l29.644"></a><span id="l29.644">     var additionalInfoBroadcaster = document.getElementById(&quot;additionalInfoBroadcaster&quot;);</span>
<a href="#l29.645"></a><span id="l29.645"> </span>
<a href="#l29.646"></a><span id="l29.646">     if (!aNode) {</span>
<a href="#l29.647"></a><span id="l29.647">       infoBoxExpanderWrapper.hidden = true;</span>
<a href="#l29.648"></a><span id="l29.648">       return;</span>
<a href="#l29.649"></a><span id="l29.649">     }</span>
<a href="#l29.650"></a><span id="l29.650">     if (aNode.itemId != -1 &amp;&amp;</span>
<a href="#l29.651"></a><span id="l29.651" class="difflineminus">-        ((PlacesUtils.nodeIsFolder(aNode) &amp;&amp; !aNode._feedURI) ||</span>
<a href="#l29.652"></a><span id="l29.652" class="difflineminus">-         PlacesUtils.nodeIsQuery(aNode))) {</span>
<a href="#l29.653"></a><span id="l29.653" class="difflineplus">+        PlacesUtils.nodeIsFolder(aNode) &amp;&amp; !aNode._feedURI) {</span>
<a href="#l29.654"></a><span id="l29.654">       if (infoBox.getAttribute(&quot;minimal&quot;) == &quot;true&quot;)</span>
<a href="#l29.655"></a><span id="l29.655">         infoBox.setAttribute(&quot;wasminimal&quot;, &quot;true&quot;);</span>
<a href="#l29.656"></a><span id="l29.656">       infoBox.removeAttribute(&quot;minimal&quot;);</span>
<a href="#l29.657"></a><span id="l29.657">       infoBoxExpanderWrapper.hidden = true;</span>
<a href="#l29.658"></a><span id="l29.658" class="difflineminus">-    }</span>
<a href="#l29.659"></a><span id="l29.659" class="difflineminus">-    else {</span>
<a href="#l29.660"></a><span id="l29.660" class="difflineplus">+    } else {</span>
<a href="#l29.661"></a><span id="l29.661">       if (infoBox.getAttribute(&quot;wasminimal&quot;) == &quot;true&quot;)</span>
<a href="#l29.662"></a><span id="l29.662">         infoBox.setAttribute(&quot;minimal&quot;, &quot;true&quot;);</span>
<a href="#l29.663"></a><span id="l29.663">       infoBox.removeAttribute(&quot;wasminimal&quot;);</span>
<a href="#l29.664"></a><span id="l29.664">       infoBoxExpanderWrapper.hidden =</span>
<a href="#l29.665"></a><span id="l29.665">         this._additionalInfoFields.every(id =&gt;</span>
<a href="#l29.666"></a><span id="l29.666">           document.getElementById(id).collapsed);</span>
<a href="#l29.667"></a><span id="l29.667">     }</span>
<a href="#l29.668"></a><span id="l29.668">     additionalInfoBroadcaster.hidden = infoBox.getAttribute(&quot;minimal&quot;) == &quot;true&quot;;</span>
<a href="#l29.669"></a><span id="l29.669" class="difflineat">@@ -546,247 +584,170 @@ var PlacesOrganizer = {</span>
<a href="#l29.670"></a><span id="l29.670">     var previewBox = document.getElementById(&quot;previewBox&quot;);</span>
<a href="#l29.671"></a><span id="l29.671">     var canvas = document.getElementById(&quot;itemThumbnail&quot;);</span>
<a href="#l29.672"></a><span id="l29.672">     var height = previewBox.boxObject.height;</span>
<a href="#l29.673"></a><span id="l29.673">     var width = height * (screen.width / screen.height);</span>
<a href="#l29.674"></a><span id="l29.674">     canvas.width = width;</span>
<a href="#l29.675"></a><span id="l29.675">     canvas.height = height;</span>
<a href="#l29.676"></a><span id="l29.676">   },</span>
<a href="#l29.677"></a><span id="l29.677"> </span>
<a href="#l29.678"></a><span id="l29.678" class="difflineminus">-  onContentTreeSelect: function PO_onContentTreeSelect() {</span>
<a href="#l29.679"></a><span id="l29.679" class="difflineminus">-    if (this._content.treeBoxObject.focused)</span>
<a href="#l29.680"></a><span id="l29.680" class="difflineminus">-      this._fillDetailsPane(this._content.selectedNodes);</span>
<a href="#l29.681"></a><span id="l29.681" class="difflineminus">-  },</span>
<a href="#l29.682"></a><span id="l29.682" class="difflineminus">-</span>
<a href="#l29.683"></a><span id="l29.683">   _fillDetailsPane: function PO__fillDetailsPane(aNodeList) {</span>
<a href="#l29.684"></a><span id="l29.684">     var infoBox = document.getElementById(&quot;infoBox&quot;);</span>
<a href="#l29.685"></a><span id="l29.685">     var detailsDeck = document.getElementById(&quot;detailsDeck&quot;);</span>
<a href="#l29.686"></a><span id="l29.686"> </span>
<a href="#l29.687"></a><span id="l29.687">     // Make sure the infoBox UI is visible if we need to use it, we hide it</span>
<a href="#l29.688"></a><span id="l29.688">     // below when we don't.</span>
<a href="#l29.689"></a><span id="l29.689">     infoBox.hidden = false;</span>
<a href="#l29.690"></a><span id="l29.690" class="difflineminus">-    var aSelectedNode = aNodeList.length == 1 ? aNodeList[0] : null;</span>
<a href="#l29.691"></a><span id="l29.691" class="difflineplus">+    let selectedNode = aNodeList.length == 1 ? aNodeList[0] : null;</span>
<a href="#l29.692"></a><span id="l29.692" class="difflineplus">+</span>
<a href="#l29.693"></a><span id="l29.693">     // If a textbox within a panel is focused, force-blur it so its contents</span>
<a href="#l29.694"></a><span id="l29.694">     // are saved</span>
<a href="#l29.695"></a><span id="l29.695">     if (gEditItemOverlay.itemId != -1) {</span>
<a href="#l29.696"></a><span id="l29.696">       var focusedElement = document.commandDispatcher.focusedElement;</span>
<a href="#l29.697"></a><span id="l29.697">       if ((focusedElement instanceof HTMLInputElement ||</span>
<a href="#l29.698"></a><span id="l29.698">            focusedElement instanceof HTMLTextAreaElement) &amp;&amp;</span>
<a href="#l29.699"></a><span id="l29.699">           /^editBMPanel.*/.test(focusedElement.parentNode.parentNode.id))</span>
<a href="#l29.700"></a><span id="l29.700">         focusedElement.blur();</span>
<a href="#l29.701"></a><span id="l29.701"> </span>
<a href="#l29.702"></a><span id="l29.702">       // don't update the panel if we are already editing this node unless we're</span>
<a href="#l29.703"></a><span id="l29.703">       // in multi-edit mode</span>
<a href="#l29.704"></a><span id="l29.704" class="difflineminus">-      if (aSelectedNode) {</span>
<a href="#l29.705"></a><span id="l29.705" class="difflineminus">-        var concreteId = PlacesUtils.getConcreteItemId(aSelectedNode);</span>
<a href="#l29.706"></a><span id="l29.706" class="difflineminus">-        var nodeIsSame = gEditItemOverlay.itemId == aSelectedNode.itemId ||</span>
<a href="#l29.707"></a><span id="l29.707" class="difflineplus">+      if (selectedNode) {</span>
<a href="#l29.708"></a><span id="l29.708" class="difflineplus">+        let concreteId = PlacesUtils.getConcreteItemId(selectedNode);</span>
<a href="#l29.709"></a><span id="l29.709" class="difflineplus">+        var nodeIsSame = gEditItemOverlay.itemId == selectedNode.itemId ||</span>
<a href="#l29.710"></a><span id="l29.710">                          gEditItemOverlay.itemId == concreteId ||</span>
<a href="#l29.711"></a><span id="l29.711" class="difflineminus">-                         (aSelectedNode.itemId == -1 &amp;&amp; gEditItemOverlay.uri &amp;&amp;</span>
<a href="#l29.712"></a><span id="l29.712" class="difflineminus">-                          gEditItemOverlay.uri == aSelectedNode.uri);</span>
<a href="#l29.713"></a><span id="l29.713" class="difflineplus">+                         (selectedNode.itemId == -1 &amp;&amp; gEditItemOverlay.uri &amp;&amp;</span>
<a href="#l29.714"></a><span id="l29.714" class="difflineplus">+                          gEditItemOverlay.uri == selectedNode.uri);</span>
<a href="#l29.715"></a><span id="l29.715">         if (nodeIsSame &amp;&amp; detailsDeck.selectedIndex == 1 &amp;&amp;</span>
<a href="#l29.716"></a><span id="l29.716">             !gEditItemOverlay.multiEdit)</span>
<a href="#l29.717"></a><span id="l29.717">           return;</span>
<a href="#l29.718"></a><span id="l29.718">       }</span>
<a href="#l29.719"></a><span id="l29.719">     }</span>
<a href="#l29.720"></a><span id="l29.720"> </span>
<a href="#l29.721"></a><span id="l29.721">     // Clean up the panel before initing it again.</span>
<a href="#l29.722"></a><span id="l29.722">     gEditItemOverlay.uninitPanel(false);</span>
<a href="#l29.723"></a><span id="l29.723"> </span>
<a href="#l29.724"></a><span id="l29.724" class="difflineminus">-    if (aSelectedNode &amp;&amp; !PlacesUtils.nodeIsSeparator(aSelectedNode)) {</span>
<a href="#l29.725"></a><span id="l29.725" class="difflineplus">+    if (selectedNode &amp;&amp; !PlacesUtils.nodeIsSeparator(selectedNode)) {</span>
<a href="#l29.726"></a><span id="l29.726">       detailsDeck.selectedIndex = 1;</span>
<a href="#l29.727"></a><span id="l29.727" class="difflineminus">-      // Using the concrete itemId is arguably wrong.  The bookmarks API</span>
<a href="#l29.728"></a><span id="l29.728" class="difflineminus">-      // does allow setting properties for folder shortcuts as well, but since</span>
<a href="#l29.729"></a><span id="l29.729" class="difflineminus">-      // the UI does not distinct between the couple, we better just show</span>
<a href="#l29.730"></a><span id="l29.730" class="difflineminus">-      // the concrete item properties for shortcuts to root nodes.</span>
<a href="#l29.731"></a><span id="l29.731" class="difflineminus">-      var concreteId = PlacesUtils.getConcreteItemId(aSelectedNode);</span>
<a href="#l29.732"></a><span id="l29.732" class="difflineminus">-      var isRootItem = concreteId != -1 &amp;&amp; PlacesUtils.isRootItem(concreteId);</span>
<a href="#l29.733"></a><span id="l29.733" class="difflineminus">-      var readOnly = isRootItem ||</span>
<a href="#l29.734"></a><span id="l29.734" class="difflineminus">-                     aSelectedNode.parent.itemId == PlacesUIUtils.leftPaneFolderId;</span>
<a href="#l29.735"></a><span id="l29.735" class="difflineminus">-      var useConcreteId = isRootItem ||</span>
<a href="#l29.736"></a><span id="l29.736" class="difflineminus">-                          PlacesUtils.nodeIsTagQuery(aSelectedNode);</span>
<a href="#l29.737"></a><span id="l29.737" class="difflineminus">-      var itemId = -1;</span>
<a href="#l29.738"></a><span id="l29.738" class="difflineminus">-      if (concreteId != -1 &amp;&amp; useConcreteId)</span>
<a href="#l29.739"></a><span id="l29.739" class="difflineminus">-        itemId = concreteId;</span>
<a href="#l29.740"></a><span id="l29.740" class="difflineminus">-      else if (aSelectedNode.itemId != -1)</span>
<a href="#l29.741"></a><span id="l29.741" class="difflineminus">-        itemId = aSelectedNode.itemId;</span>
<a href="#l29.742"></a><span id="l29.742" class="difflineminus">-      else</span>
<a href="#l29.743"></a><span id="l29.743" class="difflineminus">-        itemId = PlacesUtils._uri(aSelectedNode.uri);</span>
<a href="#l29.744"></a><span id="l29.744"> </span>
<a href="#l29.745"></a><span id="l29.745" class="difflineminus">-      gEditItemOverlay.initPanel(itemId, { hiddenRows: [&quot;folderPicker&quot;],</span>
<a href="#l29.746"></a><span id="l29.746" class="difflineminus">-                                           titleOverride: aSelectedNode.title,</span>
<a href="#l29.747"></a><span id="l29.747" class="difflineminus">-                                           forceReadOnly: readOnly });</span>
<a href="#l29.748"></a><span id="l29.748" class="difflineplus">+      gEditItemOverlay.initPanel({ node: selectedNode,</span>
<a href="#l29.749"></a><span id="l29.749" class="difflineplus">+                                   hiddenRows: [&quot;folderPicker&quot;] });</span>
<a href="#l29.750"></a><span id="l29.750"> </span>
<a href="#l29.751"></a><span id="l29.751" class="difflineminus">-      // Dynamically generated queries, like history date containers, have</span>
<a href="#l29.752"></a><span id="l29.752" class="difflineminus">-      // itemId !=0 and do not exist in history.  For them the panel is</span>
<a href="#l29.753"></a><span id="l29.753" class="difflineminus">-      // read-only, but empty, since it can't get a valid title for the object.</span>
<a href="#l29.754"></a><span id="l29.754" class="difflineminus">-      // In such a case we force the title using the selectedNode one, for UI</span>
<a href="#l29.755"></a><span id="l29.755" class="difflineminus">-      // polishness.</span>
<a href="#l29.756"></a><span id="l29.756" class="difflineminus">-      if (aSelectedNode.itemId == -1 &amp;&amp;</span>
<a href="#l29.757"></a><span id="l29.757" class="difflineminus">-          (PlacesUtils.nodeIsDay(aSelectedNode) ||</span>
<a href="#l29.758"></a><span id="l29.758" class="difflineminus">-           PlacesUtils.nodeIsHost(aSelectedNode)))</span>
<a href="#l29.759"></a><span id="l29.759" class="difflineminus">-        gEditItemOverlay._element(&quot;namePicker&quot;).value = aSelectedNode.title;</span>
<a href="#l29.760"></a><span id="l29.760" class="difflineminus">-</span>
<a href="#l29.761"></a><span id="l29.761" class="difflineminus">-      this._detectAndSetDetailsPaneMinimalState(aSelectedNode);</span>
<a href="#l29.762"></a><span id="l29.762" class="difflineminus">-    }</span>
<a href="#l29.763"></a><span id="l29.763" class="difflineminus">-    else if (!aSelectedNode &amp;&amp; aNodeList[0]) {</span>
<a href="#l29.764"></a><span id="l29.764" class="difflineminus">-      var itemIds = [];</span>
<a href="#l29.765"></a><span id="l29.765" class="difflineminus">-      for (var i = 0; i &lt; aNodeList.length; i++) {</span>
<a href="#l29.766"></a><span id="l29.766" class="difflineminus">-        if (!PlacesUtils.nodeIsBookmark(aNodeList[i]) &amp;&amp;</span>
<a href="#l29.767"></a><span id="l29.767" class="difflineminus">-            !PlacesUtils.nodeIsURI(aNodeList[i])) {</span>
<a href="#l29.768"></a><span id="l29.768" class="difflineminus">-          detailsDeck.selectedIndex = 0;</span>
<a href="#l29.769"></a><span id="l29.769" class="difflineminus">-          var selectItemDesc = document.getElementById(&quot;selectItemDescription&quot;);</span>
<a href="#l29.770"></a><span id="l29.770" class="difflineminus">-          var itemsCountLabel = document.getElementById(&quot;itemsCountText&quot;);</span>
<a href="#l29.771"></a><span id="l29.771" class="difflineminus">-          selectItemDesc.hidden = false;</span>
<a href="#l29.772"></a><span id="l29.772" class="difflineminus">-          itemsCountLabel.value =</span>
<a href="#l29.773"></a><span id="l29.773" class="difflineminus">-            PlacesUIUtils.getFormattedString(&quot;detailsPane.multipleItems&quot;,</span>
<a href="#l29.774"></a><span id="l29.774" class="difflineminus">-                                             [aNodeList.length]);</span>
<a href="#l29.775"></a><span id="l29.775" class="difflineminus">-          infoBox.hidden = true;</span>
<a href="#l29.776"></a><span id="l29.776" class="difflineminus">-          return;</span>
<a href="#l29.777"></a><span id="l29.777" class="difflineminus">-        }</span>
<a href="#l29.778"></a><span id="l29.778" class="difflineminus">-        itemIds[i] = aNodeList[i].itemId != -1 ? aNodeList[i].itemId :</span>
<a href="#l29.779"></a><span id="l29.779" class="difflineminus">-                     PlacesUtils._uri(aNodeList[i].uri);</span>
<a href="#l29.780"></a><span id="l29.780" class="difflineplus">+      this._detectAndSetDetailsPaneMinimalState(selectedNode);</span>
<a href="#l29.781"></a><span id="l29.781" class="difflineplus">+    } else if (!selectedNode &amp;&amp; aNodeList[0]) {</span>
<a href="#l29.782"></a><span id="l29.782" class="difflineplus">+      if (aNodeList.every(PlacesUtils.nodeIsURI)) {</span>
<a href="#l29.783"></a><span id="l29.783" class="difflineplus">+        let uris = aNodeList.map(node =&gt; PlacesUtils._uri(node.uri));</span>
<a href="#l29.784"></a><span id="l29.784" class="difflineplus">+        detailsDeck.selectedIndex = 1;</span>
<a href="#l29.785"></a><span id="l29.785" class="difflineplus">+        gEditItemOverlay.initPanel({ uris,</span>
<a href="#l29.786"></a><span id="l29.786" class="difflineplus">+                                     hiddenRows: [&quot;folderPicker&quot;,</span>
<a href="#l29.787"></a><span id="l29.787" class="difflineplus">+                                                  &quot;loadInSidebar&quot;,</span>
<a href="#l29.788"></a><span id="l29.788" class="difflineplus">+                                                  &quot;location&quot;,</span>
<a href="#l29.789"></a><span id="l29.789" class="difflineplus">+                                                  &quot;keyword&quot;,</span>
<a href="#l29.790"></a><span id="l29.790" class="difflineplus">+                                                  &quot;description&quot;,</span>
<a href="#l29.791"></a><span id="l29.791" class="difflineplus">+                                                  &quot;name&quot;]});</span>
<a href="#l29.792"></a><span id="l29.792" class="difflineplus">+        this._detectAndSetDetailsPaneMinimalState(selectedNode);</span>
<a href="#l29.793"></a><span id="l29.793" class="difflineplus">+      } else {</span>
<a href="#l29.794"></a><span id="l29.794" class="difflineplus">+        detailsDeck.selectedIndex = 0;</span>
<a href="#l29.795"></a><span id="l29.795" class="difflineplus">+        let selectItemDesc = document.getElementById(&quot;selectItemDescription&quot;);</span>
<a href="#l29.796"></a><span id="l29.796" class="difflineplus">+        let itemsCountLabel = document.getElementById(&quot;itemsCountText&quot;);</span>
<a href="#l29.797"></a><span id="l29.797" class="difflineplus">+        selectItemDesc.hidden = false;</span>
<a href="#l29.798"></a><span id="l29.798" class="difflineplus">+        itemsCountLabel.value =</span>
<a href="#l29.799"></a><span id="l29.799" class="difflineplus">+          PlacesUIUtils.getPluralString(&quot;detailsPane.itemsCountLabel&quot;,</span>
<a href="#l29.800"></a><span id="l29.800" class="difflineplus">+                                        aNodeList.length, [aNodeList.length]);</span>
<a href="#l29.801"></a><span id="l29.801" class="difflineplus">+        infoBox.hidden = true;</span>
<a href="#l29.802"></a><span id="l29.802">       }</span>
<a href="#l29.803"></a><span id="l29.803" class="difflineminus">-      detailsDeck.selectedIndex = 1;</span>
<a href="#l29.804"></a><span id="l29.804" class="difflineminus">-      gEditItemOverlay.initPanel(itemIds,</span>
<a href="#l29.805"></a><span id="l29.805" class="difflineminus">-                                 { hiddenRows: [&quot;folderPicker&quot;,</span>
<a href="#l29.806"></a><span id="l29.806" class="difflineminus">-                                                &quot;location&quot;,</span>
<a href="#l29.807"></a><span id="l29.807" class="difflineminus">-                                                &quot;keyword&quot;,</span>
<a href="#l29.808"></a><span id="l29.808" class="difflineminus">-                                                &quot;description&quot;,</span>
<a href="#l29.809"></a><span id="l29.809" class="difflineminus">-                                                &quot;name&quot;]});</span>
<a href="#l29.810"></a><span id="l29.810" class="difflineminus">-      this._detectAndSetDetailsPaneMinimalState(aSelectedNode);</span>
<a href="#l29.811"></a><span id="l29.811" class="difflineminus">-    }</span>
<a href="#l29.812"></a><span id="l29.812" class="difflineminus">-    else {</span>
<a href="#l29.813"></a><span id="l29.813" class="difflineplus">+    } else {</span>
<a href="#l29.814"></a><span id="l29.814">       detailsDeck.selectedIndex = 0;</span>
<a href="#l29.815"></a><span id="l29.815">       infoBox.hidden = true;</span>
<a href="#l29.816"></a><span id="l29.816" class="difflineminus">-      var selectItemDesc = document.getElementById(&quot;selectItemDescription&quot;);</span>
<a href="#l29.817"></a><span id="l29.817" class="difflineminus">-      var itemsCountLabel = document.getElementById(&quot;itemsCountText&quot;);</span>
<a href="#l29.818"></a><span id="l29.818" class="difflineminus">-      var rowCount = this._content.view.rowCount;</span>
<a href="#l29.819"></a><span id="l29.819" class="difflineminus">-      if (rowCount == 0) {</span>
<a href="#l29.820"></a><span id="l29.820" class="difflineplus">+      let selectItemDesc = document.getElementById(&quot;selectItemDescription&quot;);</span>
<a href="#l29.821"></a><span id="l29.821" class="difflineplus">+      let itemsCountLabel = document.getElementById(&quot;itemsCountText&quot;);</span>
<a href="#l29.822"></a><span id="l29.822" class="difflineplus">+      let itemsCount = 0;</span>
<a href="#l29.823"></a><span id="l29.823" class="difflineplus">+      if (ContentArea.currentView.result) {</span>
<a href="#l29.824"></a><span id="l29.824" class="difflineplus">+        let rootNode = ContentArea.currentView.result.root;</span>
<a href="#l29.825"></a><span id="l29.825" class="difflineplus">+        if (rootNode.containerOpen)</span>
<a href="#l29.826"></a><span id="l29.826" class="difflineplus">+          itemsCount = rootNode.childCount;</span>
<a href="#l29.827"></a><span id="l29.827" class="difflineplus">+      }</span>
<a href="#l29.828"></a><span id="l29.828" class="difflineplus">+      if (itemsCount == 0) {</span>
<a href="#l29.829"></a><span id="l29.829">         selectItemDesc.hidden = true;</span>
<a href="#l29.830"></a><span id="l29.830">         itemsCountLabel.value = PlacesUIUtils.getString(&quot;detailsPane.noItems&quot;);</span>
<a href="#l29.831"></a><span id="l29.831" class="difflineminus">-      }</span>
<a href="#l29.832"></a><span id="l29.832" class="difflineminus">-      else {</span>
<a href="#l29.833"></a><span id="l29.833" class="difflineplus">+      } else {</span>
<a href="#l29.834"></a><span id="l29.834">         selectItemDesc.hidden = false;</span>
<a href="#l29.835"></a><span id="l29.835" class="difflineminus">-        if (rowCount == 1)</span>
<a href="#l29.836"></a><span id="l29.836" class="difflineminus">-          itemsCountLabel.value = PlacesUIUtils.getString(&quot;detailsPane.oneItem&quot;);</span>
<a href="#l29.837"></a><span id="l29.837" class="difflineminus">-        else {</span>
<a href="#l29.838"></a><span id="l29.838" class="difflineminus">-          itemsCountLabel.value =</span>
<a href="#l29.839"></a><span id="l29.839" class="difflineminus">-            PlacesUIUtils.getFormattedString(&quot;detailsPane.multipleItems&quot;,</span>
<a href="#l29.840"></a><span id="l29.840" class="difflineminus">-                                             [rowCount]);</span>
<a href="#l29.841"></a><span id="l29.841" class="difflineminus">-        }</span>
<a href="#l29.842"></a><span id="l29.842" class="difflineplus">+        itemsCountLabel.value =</span>
<a href="#l29.843"></a><span id="l29.843" class="difflineplus">+          PlacesUIUtils.getPluralString(&quot;detailsPane.itemsCountLabel&quot;,</span>
<a href="#l29.844"></a><span id="l29.844" class="difflineplus">+                                        itemsCount, [itemsCount]);</span>
<a href="#l29.845"></a><span id="l29.845">       }</span>
<a href="#l29.846"></a><span id="l29.846">     }</span>
<a href="#l29.847"></a><span id="l29.847">   },</span>
<a href="#l29.848"></a><span id="l29.848"> </span>
<a href="#l29.849"></a><span id="l29.849">   // NOT YET USED</span>
<a href="#l29.850"></a><span id="l29.850">   _updateThumbnail: function PO__updateThumbnail() {</span>
<a href="#l29.851"></a><span id="l29.851">     var bo = document.getElementById(&quot;previewBox&quot;).boxObject;</span>
<a href="#l29.852"></a><span id="l29.852">     var width  = bo.width;</span>
<a href="#l29.853"></a><span id="l29.853">     var height = bo.height;</span>
<a href="#l29.854"></a><span id="l29.854"> </span>
<a href="#l29.855"></a><span id="l29.855">     var canvas = document.getElementById(&quot;itemThumbnail&quot;);</span>
<a href="#l29.856"></a><span id="l29.856" class="difflineminus">-    var ctx = canvas.getContext('2d');</span>
<a href="#l29.857"></a><span id="l29.857" class="difflineplus">+    var ctx = canvas.getContext(&quot;2d&quot;);</span>
<a href="#l29.858"></a><span id="l29.858">     var notAvailableText = canvas.getAttribute(&quot;notavailabletext&quot;);</span>
<a href="#l29.859"></a><span id="l29.859">     ctx.save();</span>
<a href="#l29.860"></a><span id="l29.860">     ctx.fillStyle = &quot;-moz-Dialog&quot;;</span>
<a href="#l29.861"></a><span id="l29.861">     ctx.fillRect(0, 0, width, height);</span>
<a href="#l29.862"></a><span id="l29.862" class="difflineminus">-    ctx.translate(width/2, height/2);</span>
<a href="#l29.863"></a><span id="l29.863" class="difflineplus">+    ctx.translate(width / 2, height / 2);</span>
<a href="#l29.864"></a><span id="l29.864"> </span>
<a href="#l29.865"></a><span id="l29.865">     ctx.fillStyle = &quot;GrayText&quot;;</span>
<a href="#l29.866"></a><span id="l29.866">     ctx.mozTextStyle = &quot;12pt sans serif&quot;;</span>
<a href="#l29.867"></a><span id="l29.867">     var len = ctx.mozMeasureText(notAvailableText);</span>
<a href="#l29.868"></a><span id="l29.868" class="difflineminus">-    ctx.translate(-len/2,0);</span>
<a href="#l29.869"></a><span id="l29.869" class="difflineplus">+    ctx.translate(-len / 2, 0);</span>
<a href="#l29.870"></a><span id="l29.870">     ctx.mozDrawText(notAvailableText);</span>
<a href="#l29.871"></a><span id="l29.871">     ctx.restore();</span>
<a href="#l29.872"></a><span id="l29.872">   },</span>
<a href="#l29.873"></a><span id="l29.873"> </span>
<a href="#l29.874"></a><span id="l29.874">   toggleAdditionalInfoFields: function PO_toggleAdditionalInfoFields() {</span>
<a href="#l29.875"></a><span id="l29.875">     var infoBox = document.getElementById(&quot;infoBox&quot;);</span>
<a href="#l29.876"></a><span id="l29.876">     var infoBoxExpander = document.getElementById(&quot;infoBoxExpander&quot;);</span>
<a href="#l29.877"></a><span id="l29.877">     var infoBoxExpanderLabel = document.getElementById(&quot;infoBoxExpanderLabel&quot;);</span>
<a href="#l29.878"></a><span id="l29.878">     var additionalInfoBroadcaster = document.getElementById(&quot;additionalInfoBroadcaster&quot;);</span>
<a href="#l29.879"></a><span id="l29.879"> </span>
<a href="#l29.880"></a><span id="l29.880">     if (infoBox.getAttribute(&quot;minimal&quot;) == &quot;true&quot;) {</span>
<a href="#l29.881"></a><span id="l29.881">       infoBox.removeAttribute(&quot;minimal&quot;);</span>
<a href="#l29.882"></a><span id="l29.882" class="difflineminus">-      infoBoxExpanderLabel.value = infoBoxExpanderLabel.getAttribute(&quot;fewerlabel&quot;);</span>
<a href="#l29.883"></a><span id="l29.883" class="difflineminus">-      infoBoxExpanderLabel.accessKey = infoBoxExpanderLabel.getAttribute(&quot;feweraccesskey&quot;);</span>
<a href="#l29.884"></a><span id="l29.884" class="difflineplus">+      infoBoxExpanderLabel.value = infoBoxExpanderLabel.getAttribute(&quot;lesslabel&quot;);</span>
<a href="#l29.885"></a><span id="l29.885" class="difflineplus">+      infoBoxExpanderLabel.accessKey = infoBoxExpanderLabel.getAttribute(&quot;lessaccesskey&quot;);</span>
<a href="#l29.886"></a><span id="l29.886">       infoBoxExpander.className = &quot;expander-up&quot;;</span>
<a href="#l29.887"></a><span id="l29.887">       additionalInfoBroadcaster.removeAttribute(&quot;hidden&quot;);</span>
<a href="#l29.888"></a><span id="l29.888" class="difflineminus">-    }</span>
<a href="#l29.889"></a><span id="l29.889" class="difflineminus">-    else {</span>
<a href="#l29.890"></a><span id="l29.890" class="difflineplus">+    } else {</span>
<a href="#l29.891"></a><span id="l29.891">       infoBox.setAttribute(&quot;minimal&quot;, &quot;true&quot;);</span>
<a href="#l29.892"></a><span id="l29.892">       infoBoxExpanderLabel.value = infoBoxExpanderLabel.getAttribute(&quot;morelabel&quot;);</span>
<a href="#l29.893"></a><span id="l29.893">       infoBoxExpanderLabel.accessKey = infoBoxExpanderLabel.getAttribute(&quot;moreaccesskey&quot;);</span>
<a href="#l29.894"></a><span id="l29.894">       infoBoxExpander.className = &quot;expander-down&quot;;</span>
<a href="#l29.895"></a><span id="l29.895">       additionalInfoBroadcaster.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l29.896"></a><span id="l29.896">     }</span>
<a href="#l29.897"></a><span id="l29.897">   },</span>
<a href="#l29.898"></a><span id="l29.898" class="difflineminus">-</span>
<a href="#l29.899"></a><span id="l29.899" class="difflineminus">-  /**</span>
<a href="#l29.900"></a><span id="l29.900" class="difflineminus">-   * Save the current search (or advanced query) to the bookmarks root.</span>
<a href="#l29.901"></a><span id="l29.901" class="difflineminus">-   */</span>
<a href="#l29.902"></a><span id="l29.902" class="difflineminus">-  saveSearch: function PO_saveSearch() {</span>
<a href="#l29.903"></a><span id="l29.903" class="difflineminus">-    // Get the place: uri for the query.</span>
<a href="#l29.904"></a><span id="l29.904" class="difflineminus">-    // If the advanced query builder is showing, use that.</span>
<a href="#l29.905"></a><span id="l29.905" class="difflineminus">-    var options = this.getCurrentOptions();</span>
<a href="#l29.906"></a><span id="l29.906" class="difflineminus">-    var queries = this.getCurrentQueries();</span>
<a href="#l29.907"></a><span id="l29.907" class="difflineminus">-</span>
<a href="#l29.908"></a><span id="l29.908" class="difflineminus">-    var placeSpec = PlacesUtils.history.queriesToQueryString(queries,</span>
<a href="#l29.909"></a><span id="l29.909" class="difflineminus">-                                                             queries.length,</span>
<a href="#l29.910"></a><span id="l29.910" class="difflineminus">-                                                             options);</span>
<a href="#l29.911"></a><span id="l29.911" class="difflineminus">-    var placeURI = Services.io.newURI(placeSpec);</span>
<a href="#l29.912"></a><span id="l29.912" class="difflineminus">-</span>
<a href="#l29.913"></a><span id="l29.913" class="difflineminus">-    // Prompt the user for a name for the query.</span>
<a href="#l29.914"></a><span id="l29.914" class="difflineminus">-    // XXX - using prompt service for now; will need to make</span>
<a href="#l29.915"></a><span id="l29.915" class="difflineminus">-    // a real dialog and localize when we're sure this is the UI we want.</span>
<a href="#l29.916"></a><span id="l29.916" class="difflineminus">-    var title = PlacesUIUtils.getString(&quot;saveSearch.title&quot;);</span>
<a href="#l29.917"></a><span id="l29.917" class="difflineminus">-    var inputLabel = PlacesUIUtils.getString(&quot;saveSearch.inputLabel&quot;);</span>
<a href="#l29.918"></a><span id="l29.918" class="difflineminus">-    var defaultText = PlacesUIUtils.getString(&quot;saveSearch.inputDefaultText&quot;);</span>
<a href="#l29.919"></a><span id="l29.919" class="difflineminus">-</span>
<a href="#l29.920"></a><span id="l29.920" class="difflineminus">-    var check = {value: false};</span>
<a href="#l29.921"></a><span id="l29.921" class="difflineminus">-    var input = {value: defaultText};</span>
<a href="#l29.922"></a><span id="l29.922" class="difflineminus">-</span>
<a href="#l29.923"></a><span id="l29.923" class="difflineminus">-    // Don't add the query if the user cancels or clears the seach name.</span>
<a href="#l29.924"></a><span id="l29.924" class="difflineminus">-    if (!Services.prompt.prompt(null, title, inputLabel, input, null, check) ||</span>
<a href="#l29.925"></a><span id="l29.925" class="difflineminus">-        input.value == &quot;&quot;)</span>
<a href="#l29.926"></a><span id="l29.926" class="difflineminus">-     return;</span>
<a href="#l29.927"></a><span id="l29.927" class="difflineminus">-</span>
<a href="#l29.928"></a><span id="l29.928" class="difflineminus">-    // Add the place: uri as a bookmark under the bookmarks root.</span>
<a href="#l29.929"></a><span id="l29.929" class="difflineminus">-    var txn = new PlacesCreateBookmarkTransaction(placeURI,</span>
<a href="#l29.930"></a><span id="l29.930" class="difflineminus">-                                                  PlacesUtils.bookmarksMenuFolderId,</span>
<a href="#l29.931"></a><span id="l29.931" class="difflineminus">-                                                  PlacesUtils.bookmarks.DEFAULT_INDEX,</span>
<a href="#l29.932"></a><span id="l29.932" class="difflineminus">-                                                  input.value);</span>
<a href="#l29.933"></a><span id="l29.933" class="difflineminus">-    PlacesUtils.transactionManager.doTransaction(txn);</span>
<a href="#l29.934"></a><span id="l29.934" class="difflineminus">-</span>
<a href="#l29.935"></a><span id="l29.935" class="difflineminus">-    // select and load the new query</span>
<a href="#l29.936"></a><span id="l29.936" class="difflineminus">-    this._places.selectPlaceURI(placeSpec);</span>
<a href="#l29.937"></a><span id="l29.937" class="difflineminus">-  }</span>
<a href="#l29.938"></a><span id="l29.938"> };</span>
<a href="#l29.939"></a><span id="l29.939"> </span>
<a href="#l29.940"></a><span id="l29.940"> /**</span>
<a href="#l29.941"></a><span id="l29.941" class="difflineminus">- * A set of utilities relating to search within Bookmarks.</span>
<a href="#l29.942"></a><span id="l29.942" class="difflineplus">+ * A set of utilities relating to search within Bookmarks and History.</span>
<a href="#l29.943"></a><span id="l29.943">  */</span>
<a href="#l29.944"></a><span id="l29.944"> var PlacesSearchBox = {</span>
<a href="#l29.945"></a><span id="l29.945"> </span>
<a href="#l29.946"></a><span id="l29.946">   /**</span>
<a href="#l29.947"></a><span id="l29.947">    * The Search text field</span>
<a href="#l29.948"></a><span id="l29.948">    */</span>
<a href="#l29.949"></a><span id="l29.949">   get searchFilter() {</span>
<a href="#l29.950"></a><span id="l29.950">     return document.getElementById(&quot;searchFilter&quot;);</span>
<a href="#l29.951"></a><span id="l29.951">   },</span>
<a href="#l29.952"></a><span id="l29.952"> </span>
<a href="#l29.953"></a><span id="l29.953">   /**</span>
<a href="#l29.954"></a><span id="l29.954">    * Folders to include when searching.</span>
<a href="#l29.955"></a><span id="l29.955">    */</span>
<a href="#l29.956"></a><span id="l29.956">   _folders: [],</span>
<a href="#l29.957"></a><span id="l29.957">   get folders() {</span>
<a href="#l29.958"></a><span id="l29.958" class="difflineminus">-    if (this._folders.length == 0)</span>
<a href="#l29.959"></a><span id="l29.959" class="difflineplus">+    if (this._folders.length == 0) {</span>
<a href="#l29.960"></a><span id="l29.960">       this._folders.push(PlacesUtils.bookmarksMenuFolderId,</span>
<a href="#l29.961"></a><span id="l29.961">                          PlacesUtils.unfiledBookmarksFolderId,</span>
<a href="#l29.962"></a><span id="l29.962" class="difflineminus">-                         PlacesUtils.toolbarFolderId);</span>
<a href="#l29.963"></a><span id="l29.963" class="difflineplus">+                         PlacesUtils.toolbarFolderId,</span>
<a href="#l29.964"></a><span id="l29.964" class="difflineplus">+                         PlacesUtils.mobileFolderId);</span>
<a href="#l29.965"></a><span id="l29.965" class="difflineplus">+    }</span>
<a href="#l29.966"></a><span id="l29.966">     return this._folders;</span>
<a href="#l29.967"></a><span id="l29.967">   },</span>
<a href="#l29.968"></a><span id="l29.968">   set folders(aFolders) {</span>
<a href="#l29.969"></a><span id="l29.969">     this._folders = aFolders;</span>
<a href="#l29.970"></a><span id="l29.970">     return aFolders;</span>
<a href="#l29.971"></a><span id="l29.971">   },</span>
<a href="#l29.972"></a><span id="l29.972"> </span>
<a href="#l29.973"></a><span id="l29.973">   /**</span>
<a href="#l29.974"></a><span id="l29.974" class="difflineat">@@ -802,90 +763,95 @@ var PlacesSearchBox = {</span>
<a href="#l29.975"></a><span id="l29.975">     // contents of the current scope.</span>
<a href="#l29.976"></a><span id="l29.976">     // XXX this might be to jumpy, maybe should search for &quot;&quot;, so results</span>
<a href="#l29.977"></a><span id="l29.977">     // are ungrouped, and search box not reset</span>
<a href="#l29.978"></a><span id="l29.978">     if (filterString == &quot;&quot;) {</span>
<a href="#l29.979"></a><span id="l29.979">       PO.onPlaceSelected(false);</span>
<a href="#l29.980"></a><span id="l29.980">       return;</span>
<a href="#l29.981"></a><span id="l29.981">     }</span>
<a href="#l29.982"></a><span id="l29.982"> </span>
<a href="#l29.983"></a><span id="l29.983" class="difflineminus">-    var currentOptions = PO.getCurrentOptions();</span>
<a href="#l29.984"></a><span id="l29.984" class="difflineminus">-    var content = PO._content;</span>
<a href="#l29.985"></a><span id="l29.985" class="difflineplus">+    let currentView = ContentArea.currentView;</span>
<a href="#l29.986"></a><span id="l29.986" class="difflineplus">+    let currentOptions = PO.getCurrentOptions();</span>
<a href="#l29.987"></a><span id="l29.987"> </span>
<a href="#l29.988"></a><span id="l29.988" class="difflineminus">-    // Search according to the current scope and folders, which were set by</span>
<a href="#l29.989"></a><span id="l29.989" class="difflineplus">+    // Search according to the current scope, which was set by</span>
<a href="#l29.990"></a><span id="l29.990">     // PQB_setScope()</span>
<a href="#l29.991"></a><span id="l29.991">     switch (PlacesSearchBox.filterCollection) {</span>
<a href="#l29.992"></a><span id="l29.992" class="difflineminus">-    case &quot;collection&quot;:</span>
<a href="#l29.993"></a><span id="l29.993" class="difflineminus">-      content.applyFilter(filterString, this.folders);</span>
<a href="#l29.994"></a><span id="l29.994" class="difflineminus">-      // XXX changing the button text is badness</span>
<a href="#l29.995"></a><span id="l29.995" class="difflineminus">-      //var scopeBtn = document.getElementById(&quot;scopeBarFolder&quot;);</span>
<a href="#l29.996"></a><span id="l29.996" class="difflineminus">-      //scopeBtn.label = PlacesOrganizer._places.selectedNode.title;</span>
<a href="#l29.997"></a><span id="l29.997" class="difflineminus">-      break;</span>
<a href="#l29.998"></a><span id="l29.998" class="difflineminus">-    case &quot;bookmarks&quot;:</span>
<a href="#l29.999"></a><span id="l29.999" class="difflineminus">-      content.applyFilter(filterString, this.folders);</span>
<a href="#l29.1000"></a><span id="l29.1000" class="difflineminus">-      break;</span>
<a href="#l29.1001"></a><span id="l29.1001" class="difflineminus">-    default:</span>
<a href="#l29.1002"></a><span id="l29.1002" class="difflineminus">-      throw &quot;Invalid filterCollection on search&quot;;</span>
<a href="#l29.1003"></a><span id="l29.1003" class="difflineminus">-      break;</span>
<a href="#l29.1004"></a><span id="l29.1004" class="difflineplus">+      case &quot;bookmarks&quot;:</span>
<a href="#l29.1005"></a><span id="l29.1005" class="difflineplus">+        currentView.applyFilter(filterString, this.folders);</span>
<a href="#l29.1006"></a><span id="l29.1006" class="difflineplus">+        break;</span>
<a href="#l29.1007"></a><span id="l29.1007" class="difflineplus">+      case &quot;history&quot;: {</span>
<a href="#l29.1008"></a><span id="l29.1008" class="difflineplus">+        if (currentOptions.queryType != Ci.nsINavHistoryQueryOptions.QUERY_TYPE_HISTORY) {</span>
<a href="#l29.1009"></a><span id="l29.1009" class="difflineplus">+          let query = PlacesUtils.history.getNewQuery();</span>
<a href="#l29.1010"></a><span id="l29.1010" class="difflineplus">+          query.searchTerms = filterString;</span>
<a href="#l29.1011"></a><span id="l29.1011" class="difflineplus">+          let options = currentOptions.clone();</span>
<a href="#l29.1012"></a><span id="l29.1012" class="difflineplus">+          // Make sure we're getting uri results.</span>
<a href="#l29.1013"></a><span id="l29.1013" class="difflineplus">+          options.resultType = currentOptions.RESULTS_AS_URI;</span>
<a href="#l29.1014"></a><span id="l29.1014" class="difflineplus">+          options.queryType = Ci.nsINavHistoryQueryOptions.QUERY_TYPE_HISTORY;</span>
<a href="#l29.1015"></a><span id="l29.1015" class="difflineplus">+          options.includeHidden = true;</span>
<a href="#l29.1016"></a><span id="l29.1016" class="difflineplus">+          currentView.load([query], options);</span>
<a href="#l29.1017"></a><span id="l29.1017" class="difflineplus">+        } else {</span>
<a href="#l29.1018"></a><span id="l29.1018" class="difflineplus">+          TelemetryStopwatch.start(HISTORY_LIBRARY_SEARCH_TELEMETRY);</span>
<a href="#l29.1019"></a><span id="l29.1019" class="difflineplus">+          currentView.applyFilter(filterString, null, true);</span>
<a href="#l29.1020"></a><span id="l29.1020" class="difflineplus">+          TelemetryStopwatch.finish(HISTORY_LIBRARY_SEARCH_TELEMETRY);</span>
<a href="#l29.1021"></a><span id="l29.1021" class="difflineplus">+        }</span>
<a href="#l29.1022"></a><span id="l29.1022" class="difflineplus">+        break;</span>
<a href="#l29.1023"></a><span id="l29.1023" class="difflineplus">+      }</span>
<a href="#l29.1024"></a><span id="l29.1024" class="difflineplus">+      default:</span>
<a href="#l29.1025"></a><span id="l29.1025" class="difflineplus">+        throw &quot;Invalid filterCollection on search&quot;;</span>
<a href="#l29.1026"></a><span id="l29.1026">     }</span>
<a href="#l29.1027"></a><span id="l29.1027"> </span>
<a href="#l29.1028"></a><span id="l29.1028" class="difflineminus">-    PlacesSearchBox.showSearchUI();</span>
<a href="#l29.1029"></a><span id="l29.1029" class="difflineminus">-</span>
<a href="#l29.1030"></a><span id="l29.1030">     // Update the details panel</span>
<a href="#l29.1031"></a><span id="l29.1031" class="difflineminus">-    PlacesOrganizer.onContentTreeSelect();</span>
<a href="#l29.1032"></a><span id="l29.1032" class="difflineplus">+    PlacesOrganizer.updateDetailsPane();</span>
<a href="#l29.1033"></a><span id="l29.1033">   },</span>
<a href="#l29.1034"></a><span id="l29.1034"> </span>
<a href="#l29.1035"></a><span id="l29.1035">   /**</span>
<a href="#l29.1036"></a><span id="l29.1036" class="difflineminus">-   * Finds across all bookmarks</span>
<a href="#l29.1037"></a><span id="l29.1037" class="difflineplus">+   * Finds across all history or all bookmarks.</span>
<a href="#l29.1038"></a><span id="l29.1038">    */</span>
<a href="#l29.1039"></a><span id="l29.1039">   findAll: function PSB_findAll() {</span>
<a href="#l29.1040"></a><span id="l29.1040" class="difflineminus">-    PlacesQueryBuilder.setScope(&quot;bookmarks&quot;);</span>
<a href="#l29.1041"></a><span id="l29.1041" class="difflineminus">-    this.focus();</span>
<a href="#l29.1042"></a><span id="l29.1042" class="difflineminus">-  },</span>
<a href="#l29.1043"></a><span id="l29.1043" class="difflineminus">-</span>
<a href="#l29.1044"></a><span id="l29.1044" class="difflineminus">-  /**</span>
<a href="#l29.1045"></a><span id="l29.1045" class="difflineminus">-   * Finds in the currently selected Place.</span>
<a href="#l29.1046"></a><span id="l29.1046" class="difflineminus">-   */</span>
<a href="#l29.1047"></a><span id="l29.1047" class="difflineminus">-  findCurrent: function PSB_findCurrent() {</span>
<a href="#l29.1048"></a><span id="l29.1048" class="difflineminus">-    PlacesQueryBuilder.setScope(&quot;collection&quot;);</span>
<a href="#l29.1049"></a><span id="l29.1049" class="difflineplus">+    switch (this.filterCollection) {</span>
<a href="#l29.1050"></a><span id="l29.1050" class="difflineplus">+      case &quot;history&quot;:</span>
<a href="#l29.1051"></a><span id="l29.1051" class="difflineplus">+        PlacesQueryBuilder.setScope(&quot;history&quot;);</span>
<a href="#l29.1052"></a><span id="l29.1052" class="difflineplus">+        break;</span>
<a href="#l29.1053"></a><span id="l29.1053" class="difflineplus">+      default:</span>
<a href="#l29.1054"></a><span id="l29.1054" class="difflineplus">+        PlacesQueryBuilder.setScope(&quot;bookmarks&quot;);</span>
<a href="#l29.1055"></a><span id="l29.1055" class="difflineplus">+        break;</span>
<a href="#l29.1056"></a><span id="l29.1056" class="difflineplus">+    }</span>
<a href="#l29.1057"></a><span id="l29.1057">     this.focus();</span>
<a href="#l29.1058"></a><span id="l29.1058">   },</span>
<a href="#l29.1059"></a><span id="l29.1059"> </span>
<a href="#l29.1060"></a><span id="l29.1060">   /**</span>
<a href="#l29.1061"></a><span id="l29.1061">    * Updates the display with the title of the current collection.</span>
<a href="#l29.1062"></a><span id="l29.1062" class="difflineminus">-   * @param   title</span>
<a href="#l29.1063"></a><span id="l29.1063" class="difflineplus">+   * @param   aTitle</span>
<a href="#l29.1064"></a><span id="l29.1064">    *          The title of the current collection.</span>
<a href="#l29.1065"></a><span id="l29.1065">    */</span>
<a href="#l29.1066"></a><span id="l29.1066" class="difflineminus">-  updateCollectionTitle: function PSB_updateCollectionTitle(title) {</span>
<a href="#l29.1067"></a><span id="l29.1067" class="difflineminus">-    if (title)</span>
<a href="#l29.1068"></a><span id="l29.1068" class="difflineminus">-      this.searchFilter.placeholder =</span>
<a href="#l29.1069"></a><span id="l29.1069" class="difflineminus">-        PlacesUIUtils.getFormattedString(&quot;searchCurrentDefault&quot;, [title]);</span>
<a href="#l29.1070"></a><span id="l29.1070" class="difflineminus">-    else</span>
<a href="#l29.1071"></a><span id="l29.1071" class="difflineminus">-      this.searchFilter.placeholder = PlacesUIUtils.getString(&quot;searchBookmarks&quot;);</span>
<a href="#l29.1072"></a><span id="l29.1072" class="difflineplus">+  updateCollectionTitle: function PSB_updateCollectionTitle(aTitle) {</span>
<a href="#l29.1073"></a><span id="l29.1073" class="difflineplus">+    let title = &quot;&quot;;</span>
<a href="#l29.1074"></a><span id="l29.1074" class="difflineplus">+    switch (this.filterCollection) {</span>
<a href="#l29.1075"></a><span id="l29.1075" class="difflineplus">+      case &quot;history&quot;:</span>
<a href="#l29.1076"></a><span id="l29.1076" class="difflineplus">+        title = PlacesUIUtils.getString(&quot;searchHistory&quot;);</span>
<a href="#l29.1077"></a><span id="l29.1077" class="difflineplus">+        break;</span>
<a href="#l29.1078"></a><span id="l29.1078" class="difflineplus">+      default:</span>
<a href="#l29.1079"></a><span id="l29.1079" class="difflineplus">+        title = PlacesUIUtils.getString(&quot;searchBookmarks&quot;);</span>
<a href="#l29.1080"></a><span id="l29.1080" class="difflineplus">+    }</span>
<a href="#l29.1081"></a><span id="l29.1081" class="difflineplus">+    this.searchFilter.placeholder = title;</span>
<a href="#l29.1082"></a><span id="l29.1082">   },</span>
<a href="#l29.1083"></a><span id="l29.1083"> </span>
<a href="#l29.1084"></a><span id="l29.1084">   /**</span>
<a href="#l29.1085"></a><span id="l29.1085">    * Gets/sets the active collection from the dropdown menu.</span>
<a href="#l29.1086"></a><span id="l29.1086">    */</span>
<a href="#l29.1087"></a><span id="l29.1087">   get filterCollection() {</span>
<a href="#l29.1088"></a><span id="l29.1088">     return this.searchFilter.getAttribute(&quot;collection&quot;);</span>
<a href="#l29.1089"></a><span id="l29.1089">   },</span>
<a href="#l29.1090"></a><span id="l29.1090">   set filterCollection(collectionName) {</span>
<a href="#l29.1091"></a><span id="l29.1091">     if (collectionName == this.filterCollection)</span>
<a href="#l29.1092"></a><span id="l29.1092">       return collectionName;</span>
<a href="#l29.1093"></a><span id="l29.1093"> </span>
<a href="#l29.1094"></a><span id="l29.1094">     this.searchFilter.setAttribute(&quot;collection&quot;, collectionName);</span>
<a href="#l29.1095"></a><span id="l29.1095" class="difflineplus">+    this.updateCollectionTitle();</span>
<a href="#l29.1096"></a><span id="l29.1096"> </span>
<a href="#l29.1097"></a><span id="l29.1097" class="difflineminus">-    var newGrayText = null;</span>
<a href="#l29.1098"></a><span id="l29.1098" class="difflineminus">-    if (collectionName == &quot;collection&quot;) {</span>
<a href="#l29.1099"></a><span id="l29.1099" class="difflineminus">-      newGrayText = PlacesOrganizer._places.selectedNode.title ||</span>
<a href="#l29.1100"></a><span id="l29.1100" class="difflineminus">-                    document.getElementById(&quot;scopeBarFolder&quot;).</span>
<a href="#l29.1101"></a><span id="l29.1101" class="difflineminus">-                      getAttribute(&quot;emptytitle&quot;);</span>
<a href="#l29.1102"></a><span id="l29.1102" class="difflineminus">-    }</span>
<a href="#l29.1103"></a><span id="l29.1103" class="difflineminus">-    this.updateCollectionTitle(newGrayText);</span>
<a href="#l29.1104"></a><span id="l29.1104">     return collectionName;</span>
<a href="#l29.1105"></a><span id="l29.1105">   },</span>
<a href="#l29.1106"></a><span id="l29.1106"> </span>
<a href="#l29.1107"></a><span id="l29.1107">   /**</span>
<a href="#l29.1108"></a><span id="l29.1108">    * Focus the search box</span>
<a href="#l29.1109"></a><span id="l29.1109">    */</span>
<a href="#l29.1110"></a><span id="l29.1110">   focus: function PSB_focus() {</span>
<a href="#l29.1111"></a><span id="l29.1111">     this.searchFilter.focus();</span>
<a href="#l29.1112"></a><span id="l29.1112" class="difflineat">@@ -902,98 +868,53 @@ var PlacesSearchBox = {</span>
<a href="#l29.1113"></a><span id="l29.1113">    * Gets or sets the text shown in the Places Search Box</span>
<a href="#l29.1114"></a><span id="l29.1114">    */</span>
<a href="#l29.1115"></a><span id="l29.1115">   get value() {</span>
<a href="#l29.1116"></a><span id="l29.1116">     return this.searchFilter.value;</span>
<a href="#l29.1117"></a><span id="l29.1117">   },</span>
<a href="#l29.1118"></a><span id="l29.1118">   set value(value) {</span>
<a href="#l29.1119"></a><span id="l29.1119">     return this.searchFilter.value = value;</span>
<a href="#l29.1120"></a><span id="l29.1120">   },</span>
<a href="#l29.1121"></a><span id="l29.1121" class="difflineminus">-</span>
<a href="#l29.1122"></a><span id="l29.1122" class="difflineminus">-  showSearchUI: function PSB_showSearchUI() {</span>
<a href="#l29.1123"></a><span id="l29.1123" class="difflineminus">-    // Hide the advanced search controls when the user hasn't searched</span>
<a href="#l29.1124"></a><span id="l29.1124" class="difflineminus">-    var searchModifiers = document.getElementById(&quot;searchModifiers&quot;);</span>
<a href="#l29.1125"></a><span id="l29.1125" class="difflineminus">-    searchModifiers.hidden = false;</span>
<a href="#l29.1126"></a><span id="l29.1126" class="difflineminus">-  },</span>
<a href="#l29.1127"></a><span id="l29.1127" class="difflineminus">-</span>
<a href="#l29.1128"></a><span id="l29.1128" class="difflineminus">-  hideSearchUI: function PSB_hideSearchUI() {</span>
<a href="#l29.1129"></a><span id="l29.1129" class="difflineminus">-    var searchModifiers = document.getElementById(&quot;searchModifiers&quot;);</span>
<a href="#l29.1130"></a><span id="l29.1130" class="difflineminus">-    searchModifiers.hidden = true;</span>
<a href="#l29.1131"></a><span id="l29.1131" class="difflineminus">-  }</span>
<a href="#l29.1132"></a><span id="l29.1132"> };</span>
<a href="#l29.1133"></a><span id="l29.1133"> </span>
<a href="#l29.1134"></a><span id="l29.1134"> /**</span>
<a href="#l29.1135"></a><span id="l29.1135">  * Functions and data for advanced query builder</span>
<a href="#l29.1136"></a><span id="l29.1136">  */</span>
<a href="#l29.1137"></a><span id="l29.1137"> var PlacesQueryBuilder = {</span>
<a href="#l29.1138"></a><span id="l29.1138"> </span>
<a href="#l29.1139"></a><span id="l29.1139">   queries: [],</span>
<a href="#l29.1140"></a><span id="l29.1140">   queryOptions: null,</span>
<a href="#l29.1141"></a><span id="l29.1141"> </span>
<a href="#l29.1142"></a><span id="l29.1142">   /**</span>
<a href="#l29.1143"></a><span id="l29.1143" class="difflineminus">-   * Called when a scope button in the scope bar is clicked.</span>
<a href="#l29.1144"></a><span id="l29.1144" class="difflineminus">-   * @param   aButton</span>
<a href="#l29.1145"></a><span id="l29.1145" class="difflineminus">-   *          the scope button that was selected</span>
<a href="#l29.1146"></a><span id="l29.1146" class="difflineminus">-   */</span>
<a href="#l29.1147"></a><span id="l29.1147" class="difflineminus">-  onScopeSelected: function PQB_onScopeSelected(aButton) {</span>
<a href="#l29.1148"></a><span id="l29.1148" class="difflineminus">-    switch (aButton.id) {</span>
<a href="#l29.1149"></a><span id="l29.1149" class="difflineminus">-    case &quot;scopeBarFolder&quot;:</span>
<a href="#l29.1150"></a><span id="l29.1150" class="difflineminus">-      this.setScope(&quot;collection&quot;);</span>
<a href="#l29.1151"></a><span id="l29.1151" class="difflineminus">-      break;</span>
<a href="#l29.1152"></a><span id="l29.1152" class="difflineminus">-    case &quot;scopeBarAll&quot;:</span>
<a href="#l29.1153"></a><span id="l29.1153" class="difflineminus">-      this.setScope(&quot;bookmarks&quot;);</span>
<a href="#l29.1154"></a><span id="l29.1154" class="difflineminus">-      break;</span>
<a href="#l29.1155"></a><span id="l29.1155" class="difflineminus">-    default:</span>
<a href="#l29.1156"></a><span id="l29.1156" class="difflineminus">-      throw &quot;Invalid search scope button ID&quot;;</span>
<a href="#l29.1157"></a><span id="l29.1157" class="difflineminus">-      break;</span>
<a href="#l29.1158"></a><span id="l29.1158" class="difflineminus">-    }</span>
<a href="#l29.1159"></a><span id="l29.1159" class="difflineminus">-  },</span>
<a href="#l29.1160"></a><span id="l29.1160" class="difflineminus">-</span>
<a href="#l29.1161"></a><span id="l29.1161" class="difflineminus">-  /**</span>
<a href="#l29.1162"></a><span id="l29.1162">    * Sets the search scope.  This can be called when no search is active, and</span>
<a href="#l29.1163"></a><span id="l29.1163">    * in that case, when the user does begin a search aScope will be used (see</span>
<a href="#l29.1164"></a><span id="l29.1164">    * PSB_search()).  If there is an active search, it's performed again to</span>
<a href="#l29.1165"></a><span id="l29.1165">    * update the content tree.</span>
<a href="#l29.1166"></a><span id="l29.1166">    * @param   aScope</span>
<a href="#l29.1167"></a><span id="l29.1167" class="difflineminus">-   *          the search scope, &quot;bookmarks&quot; or &quot;collection&quot;</span>
<a href="#l29.1168"></a><span id="l29.1168" class="difflineplus">+   *          The search scope: &quot;bookmarks&quot;, &quot;collection&quot; or &quot;history&quot;.</span>
<a href="#l29.1169"></a><span id="l29.1169">    */</span>
<a href="#l29.1170"></a><span id="l29.1170">   setScope: function PQB_setScope(aScope) {</span>
<a href="#l29.1171"></a><span id="l29.1171">     // Determine filterCollection, folders, and scopeButtonId based on aScope.</span>
<a href="#l29.1172"></a><span id="l29.1172">     var filterCollection;</span>
<a href="#l29.1173"></a><span id="l29.1173">     var folders = [];</span>
<a href="#l29.1174"></a><span id="l29.1174" class="difflineminus">-    var scopeButtonId;</span>
<a href="#l29.1175"></a><span id="l29.1175">     switch (aScope) {</span>
<a href="#l29.1176"></a><span id="l29.1176" class="difflineminus">-    case &quot;collection&quot;:</span>
<a href="#l29.1177"></a><span id="l29.1177" class="difflineminus">-      // The folder scope button can only become hidden upon selecting a new</span>
<a href="#l29.1178"></a><span id="l29.1178" class="difflineminus">-      // folder in the left pane, and the disabled state will remain unchanged</span>
<a href="#l29.1179"></a><span id="l29.1179" class="difflineminus">-      // until a new folder is selected.  See PO__setScopeForNode().</span>
<a href="#l29.1180"></a><span id="l29.1180" class="difflineminus">-      if (!document.getElementById(&quot;scopeBarFolder&quot;).hidden) {</span>
<a href="#l29.1181"></a><span id="l29.1181" class="difflineminus">-        filterCollection = &quot;collection&quot;;</span>
<a href="#l29.1182"></a><span id="l29.1182" class="difflineminus">-        scopeButtonId = &quot;scopeBarFolder&quot;;</span>
<a href="#l29.1183"></a><span id="l29.1183" class="difflineminus">-        folders.push(PlacesUtils.getConcreteItemId(</span>
<a href="#l29.1184"></a><span id="l29.1184" class="difflineminus">-                       PlacesOrganizer._places.selectedNode));</span>
<a href="#l29.1185"></a><span id="l29.1185" class="difflineplus">+      case &quot;history&quot;:</span>
<a href="#l29.1186"></a><span id="l29.1186" class="difflineplus">+        filterCollection = &quot;history&quot;;</span>
<a href="#l29.1187"></a><span id="l29.1187">         break;</span>
<a href="#l29.1188"></a><span id="l29.1188" class="difflineminus">-      }</span>
<a href="#l29.1189"></a><span id="l29.1189" class="difflineminus">-      // Fall through.  If collection scope doesn't make sense for the</span>
<a href="#l29.1190"></a><span id="l29.1190" class="difflineminus">-      // selected node, choose bookmarks scope.</span>
<a href="#l29.1191"></a><span id="l29.1191" class="difflineminus">-    case &quot;bookmarks&quot;:</span>
<a href="#l29.1192"></a><span id="l29.1192" class="difflineminus">-      filterCollection = &quot;bookmarks&quot;;</span>
<a href="#l29.1193"></a><span id="l29.1193" class="difflineminus">-      scopeButtonId = &quot;scopeBarAll&quot;;</span>
<a href="#l29.1194"></a><span id="l29.1194" class="difflineminus">-      folders.push(PlacesUtils.bookmarksMenuFolderId,</span>
<a href="#l29.1195"></a><span id="l29.1195" class="difflineminus">-                   PlacesUtils.toolbarFolderId,</span>
<a href="#l29.1196"></a><span id="l29.1196" class="difflineminus">-                   PlacesUtils.unfiledBookmarksFolderId);</span>
<a href="#l29.1197"></a><span id="l29.1197" class="difflineminus">-      break;</span>
<a href="#l29.1198"></a><span id="l29.1198" class="difflineminus">-    default:</span>
<a href="#l29.1199"></a><span id="l29.1199" class="difflineminus">-      throw &quot;Invalid search scope&quot;;</span>
<a href="#l29.1200"></a><span id="l29.1200" class="difflineminus">-      break;</span>
<a href="#l29.1201"></a><span id="l29.1201" class="difflineplus">+      case &quot;bookmarks&quot;:</span>
<a href="#l29.1202"></a><span id="l29.1202" class="difflineplus">+        filterCollection = &quot;bookmarks&quot;;</span>
<a href="#l29.1203"></a><span id="l29.1203" class="difflineplus">+        folders.push(PlacesUtils.bookmarksMenuFolderId,</span>
<a href="#l29.1204"></a><span id="l29.1204" class="difflineplus">+                     PlacesUtils.toolbarFolderId,</span>
<a href="#l29.1205"></a><span id="l29.1205" class="difflineplus">+                     PlacesUtils.unfiledBookmarksFolderId,</span>
<a href="#l29.1206"></a><span id="l29.1206" class="difflineplus">+                     PlacesUtils.mobileFolderId);</span>
<a href="#l29.1207"></a><span id="l29.1207" class="difflineplus">+        break;</span>
<a href="#l29.1208"></a><span id="l29.1208" class="difflineplus">+      default:</span>
<a href="#l29.1209"></a><span id="l29.1209" class="difflineplus">+        throw &quot;Invalid search scope&quot;;</span>
<a href="#l29.1210"></a><span id="l29.1210">     }</span>
<a href="#l29.1211"></a><span id="l29.1211"> </span>
<a href="#l29.1212"></a><span id="l29.1212" class="difflineminus">-    // Check the appropriate scope button in the scope bar.</span>
<a href="#l29.1213"></a><span id="l29.1213" class="difflineminus">-    document.getElementById(scopeButtonId).checked = true;</span>
<a href="#l29.1214"></a><span id="l29.1214" class="difflineminus">-</span>
<a href="#l29.1215"></a><span id="l29.1215">     // Update the search box.  Re-search if there's an active search.</span>
<a href="#l29.1216"></a><span id="l29.1216">     PlacesSearchBox.filterCollection = filterCollection;</span>
<a href="#l29.1217"></a><span id="l29.1217">     PlacesSearchBox.folders = folders;</span>
<a href="#l29.1218"></a><span id="l29.1218">     var searchStr = PlacesSearchBox.searchFilter.value;</span>
<a href="#l29.1219"></a><span id="l29.1219">     if (searchStr)</span>
<a href="#l29.1220"></a><span id="l29.1220">       PlacesSearchBox.search(searchStr);</span>
<a href="#l29.1221"></a><span id="l29.1221">   }</span>
<a href="#l29.1222"></a><span id="l29.1222"> };</span>
<a href="#l29.1223"></a><span id="l29.1223" class="difflineat">@@ -1035,22 +956,21 @@ var ViewMenu = {</span>
<a href="#l29.1224"></a><span id="l29.1224">       if (endID) {</span>
<a href="#l29.1225"></a><span id="l29.1225">         endElement = document.getElementById(endID);</span>
<a href="#l29.1226"></a><span id="l29.1226">         NS_ASSERT(endElement.parentNode == popup,</span>
<a href="#l29.1227"></a><span id="l29.1227">                   &quot;endElement is not in popup&quot;);</span>
<a href="#l29.1228"></a><span id="l29.1228">         NS_ASSERT(endElement,</span>
<a href="#l29.1229"></a><span id="l29.1229">                   &quot;endID does not correspond to an existing element&quot;);</span>
<a href="#l29.1230"></a><span id="l29.1230">       }</span>
<a href="#l29.1231"></a><span id="l29.1231">       while (startElement.nextSibling != endElement)</span>
<a href="#l29.1232"></a><span id="l29.1232" class="difflineminus">-        startElement.nextSibling.remove();</span>
<a href="#l29.1233"></a><span id="l29.1233" class="difflineplus">+        popup.removeChild(startElement.nextSibling);</span>
<a href="#l29.1234"></a><span id="l29.1234">       return endElement;</span>
<a href="#l29.1235"></a><span id="l29.1235">     }</span>
<a href="#l29.1236"></a><span id="l29.1236" class="difflineminus">-    else {</span>
<a href="#l29.1237"></a><span id="l29.1237" class="difflineminus">-      while (popup.hasChildNodes())</span>
<a href="#l29.1238"></a><span id="l29.1238" class="difflineminus">-        popup.lastChild.remove();</span>
<a href="#l29.1239"></a><span id="l29.1239" class="difflineplus">+    while (popup.hasChildNodes()) {</span>
<a href="#l29.1240"></a><span id="l29.1240" class="difflineplus">+      popup.firstChild.remove();</span>
<a href="#l29.1241"></a><span id="l29.1241">     }</span>
<a href="#l29.1242"></a><span id="l29.1242">     return null;</span>
<a href="#l29.1243"></a><span id="l29.1243">   },</span>
<a href="#l29.1244"></a><span id="l29.1244"> </span>
<a href="#l29.1245"></a><span id="l29.1245">   /**</span>
<a href="#l29.1246"></a><span id="l29.1246">    * Fills a menupopup with a list of columns</span>
<a href="#l29.1247"></a><span id="l29.1247">    * @param   event</span>
<a href="#l29.1248"></a><span id="l29.1248">    *          The popupshowing event that invoked this function.</span>
<a href="#l29.1249"></a><span id="l29.1249" class="difflineat">@@ -1070,44 +990,43 @@ var ViewMenu = {</span>
<a href="#l29.1250"></a><span id="l29.1250">    *          localized accesskey.</span>
<a href="#l29.1251"></a><span id="l29.1251">    *          If propertyPrefix is null, the column label is used as label and</span>
<a href="#l29.1252"></a><span id="l29.1252">    *          no accesskey is assigned.</span>
<a href="#l29.1253"></a><span id="l29.1253">    */</span>
<a href="#l29.1254"></a><span id="l29.1254">   fillWithColumns: function VM_fillWithColumns(event, startID, endID, type, propertyPrefix) {</span>
<a href="#l29.1255"></a><span id="l29.1255">     var popup = event.target;</span>
<a href="#l29.1256"></a><span id="l29.1256">     var pivot = this._clean(popup, startID, endID);</span>
<a href="#l29.1257"></a><span id="l29.1257"> </span>
<a href="#l29.1258"></a><span id="l29.1258" class="difflineminus">-    // If no column is &quot;sort-active&quot;, the &quot;Unsorted&quot; item needs to be checked,</span>
<a href="#l29.1259"></a><span id="l29.1259" class="difflineminus">-    // so track whether or not we find a column that is sort-active.</span>
<a href="#l29.1260"></a><span id="l29.1260" class="difflineminus">-    var isSorted = false;</span>
<a href="#l29.1261"></a><span id="l29.1261">     var content = document.getElementById(&quot;placeContent&quot;);</span>
<a href="#l29.1262"></a><span id="l29.1262">     var columns = content.columns;</span>
<a href="#l29.1263"></a><span id="l29.1263">     for (var i = 0; i &lt; columns.count; ++i) {</span>
<a href="#l29.1264"></a><span id="l29.1264">       var column = columns.getColumnAt(i).element;</span>
<a href="#l29.1265"></a><span id="l29.1265">       var menuitem = document.createElement(&quot;menuitem&quot;);</span>
<a href="#l29.1266"></a><span id="l29.1266">       menuitem.id = &quot;menucol_&quot; + column.id;</span>
<a href="#l29.1267"></a><span id="l29.1267">       menuitem.column = column;</span>
<a href="#l29.1268"></a><span id="l29.1268">       var label = column.getAttribute(&quot;label&quot;);</span>
<a href="#l29.1269"></a><span id="l29.1269">       if (propertyPrefix) {</span>
<a href="#l29.1270"></a><span id="l29.1270" class="difflineminus">-        var menuitemPrefix = propertyPrefix + column.getAttribute(&quot;anonid&quot;);</span>
<a href="#l29.1271"></a><span id="l29.1271" class="difflineplus">+        var menuitemPrefix = propertyPrefix;</span>
<a href="#l29.1272"></a><span id="l29.1272" class="difflineplus">+        // for string properties, use &quot;name&quot; as the id, instead of &quot;title&quot;</span>
<a href="#l29.1273"></a><span id="l29.1273" class="difflineplus">+        // see bug #386287 for details</span>
<a href="#l29.1274"></a><span id="l29.1274" class="difflineplus">+        var columnId = column.getAttribute(&quot;anonid&quot;);</span>
<a href="#l29.1275"></a><span id="l29.1275" class="difflineplus">+        menuitemPrefix += columnId == &quot;title&quot; ? &quot;name&quot; : columnId;</span>
<a href="#l29.1276"></a><span id="l29.1276">         label = PlacesUIUtils.getString(menuitemPrefix + &quot;.label&quot;);</span>
<a href="#l29.1277"></a><span id="l29.1277">         var accesskey = PlacesUIUtils.getString(menuitemPrefix + &quot;.accesskey&quot;);</span>
<a href="#l29.1278"></a><span id="l29.1278">         menuitem.setAttribute(&quot;accesskey&quot;, accesskey);</span>
<a href="#l29.1279"></a><span id="l29.1279">       }</span>
<a href="#l29.1280"></a><span id="l29.1280">       menuitem.setAttribute(&quot;label&quot;, label);</span>
<a href="#l29.1281"></a><span id="l29.1281">       if (type == &quot;radio&quot;) {</span>
<a href="#l29.1282"></a><span id="l29.1282">         menuitem.setAttribute(&quot;type&quot;, &quot;radio&quot;);</span>
<a href="#l29.1283"></a><span id="l29.1283">         menuitem.setAttribute(&quot;name&quot;, &quot;columns&quot;);</span>
<a href="#l29.1284"></a><span id="l29.1284">         // This column is the sort key. Its item is checked.</span>
<a href="#l29.1285"></a><span id="l29.1285">         if (column.getAttribute(&quot;sortDirection&quot;) != &quot;&quot;) {</span>
<a href="#l29.1286"></a><span id="l29.1286">           menuitem.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l29.1287"></a><span id="l29.1287" class="difflineminus">-          isSorted = true;</span>
<a href="#l29.1288"></a><span id="l29.1288">         }</span>
<a href="#l29.1289"></a><span id="l29.1289" class="difflineminus">-      }</span>
<a href="#l29.1290"></a><span id="l29.1290" class="difflineminus">-      else if (type == &quot;checkbox&quot;) {</span>
<a href="#l29.1291"></a><span id="l29.1291" class="difflineplus">+      } else if (type == &quot;checkbox&quot;) {</span>
<a href="#l29.1292"></a><span id="l29.1292">         menuitem.setAttribute(&quot;type&quot;, &quot;checkbox&quot;);</span>
<a href="#l29.1293"></a><span id="l29.1293">         // Cannot uncheck the primary column.</span>
<a href="#l29.1294"></a><span id="l29.1294">         if (column.getAttribute(&quot;primary&quot;) == &quot;true&quot;)</span>
<a href="#l29.1295"></a><span id="l29.1295">           menuitem.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l29.1296"></a><span id="l29.1296">         // Items for visible columns are checked.</span>
<a href="#l29.1297"></a><span id="l29.1297">         if (!column.hidden)</span>
<a href="#l29.1298"></a><span id="l29.1298">           menuitem.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l29.1299"></a><span id="l29.1299">       }</span>
<a href="#l29.1300"></a><span id="l29.1300" class="difflineat">@@ -1118,35 +1037,33 @@ var ViewMenu = {</span>
<a href="#l29.1301"></a><span id="l29.1301">     }</span>
<a href="#l29.1302"></a><span id="l29.1302">     event.stopPropagation();</span>
<a href="#l29.1303"></a><span id="l29.1303">   },</span>
<a href="#l29.1304"></a><span id="l29.1304"> </span>
<a href="#l29.1305"></a><span id="l29.1305">   /**</span>
<a href="#l29.1306"></a><span id="l29.1306">    * Set up the content of the view menu.</span>
<a href="#l29.1307"></a><span id="l29.1307">    */</span>
<a href="#l29.1308"></a><span id="l29.1308">   populateSortMenu: function VM_populateSortMenu(event) {</span>
<a href="#l29.1309"></a><span id="l29.1309" class="difflineminus">-    this.fillWithColumns(event, &quot;viewUnsorted&quot;, &quot;directionSeparator&quot;, &quot;radio&quot;, &quot;view.sortBy.&quot;);</span>
<a href="#l29.1310"></a><span id="l29.1310" class="difflineplus">+    this.fillWithColumns(event, &quot;viewUnsorted&quot;, &quot;directionSeparator&quot;, &quot;radio&quot;, &quot;view.sortBy.1.&quot;);</span>
<a href="#l29.1311"></a><span id="l29.1311"> </span>
<a href="#l29.1312"></a><span id="l29.1312">     var sortColumn = this._getSortColumn();</span>
<a href="#l29.1313"></a><span id="l29.1313">     var viewSortAscending = document.getElementById(&quot;viewSortAscending&quot;);</span>
<a href="#l29.1314"></a><span id="l29.1314">     var viewSortDescending = document.getElementById(&quot;viewSortDescending&quot;);</span>
<a href="#l29.1315"></a><span id="l29.1315">     // We need to remove an existing checked attribute because the unsorted</span>
<a href="#l29.1316"></a><span id="l29.1316">     // menu item is not rebuilt every time we open the menu like the others.</span>
<a href="#l29.1317"></a><span id="l29.1317">     var viewUnsorted = document.getElementById(&quot;viewUnsorted&quot;);</span>
<a href="#l29.1318"></a><span id="l29.1318">     if (!sortColumn) {</span>
<a href="#l29.1319"></a><span id="l29.1319">       viewSortAscending.removeAttribute(&quot;checked&quot;);</span>
<a href="#l29.1320"></a><span id="l29.1320">       viewSortDescending.removeAttribute(&quot;checked&quot;);</span>
<a href="#l29.1321"></a><span id="l29.1321">       viewUnsorted.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l29.1322"></a><span id="l29.1322" class="difflineminus">-    }</span>
<a href="#l29.1323"></a><span id="l29.1323" class="difflineminus">-    else if (sortColumn.getAttribute(&quot;sortDirection&quot;) == &quot;ascending&quot;) {</span>
<a href="#l29.1324"></a><span id="l29.1324" class="difflineplus">+    } else if (sortColumn.getAttribute(&quot;sortDirection&quot;) == &quot;ascending&quot;) {</span>
<a href="#l29.1325"></a><span id="l29.1325">       viewSortAscending.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l29.1326"></a><span id="l29.1326">       viewSortDescending.removeAttribute(&quot;checked&quot;);</span>
<a href="#l29.1327"></a><span id="l29.1327">       viewUnsorted.removeAttribute(&quot;checked&quot;);</span>
<a href="#l29.1328"></a><span id="l29.1328" class="difflineminus">-    }</span>
<a href="#l29.1329"></a><span id="l29.1329" class="difflineminus">-    else if (sortColumn.getAttribute(&quot;sortDirection&quot;) == &quot;descending&quot;) {</span>
<a href="#l29.1330"></a><span id="l29.1330" class="difflineplus">+    } else if (sortColumn.getAttribute(&quot;sortDirection&quot;) == &quot;descending&quot;) {</span>
<a href="#l29.1331"></a><span id="l29.1331">       viewSortDescending.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l29.1332"></a><span id="l29.1332">       viewSortAscending.removeAttribute(&quot;checked&quot;);</span>
<a href="#l29.1333"></a><span id="l29.1333">       viewUnsorted.removeAttribute(&quot;checked&quot;);</span>
<a href="#l29.1334"></a><span id="l29.1334">     }</span>
<a href="#l29.1335"></a><span id="l29.1335">   },</span>
<a href="#l29.1336"></a><span id="l29.1336"> </span>
<a href="#l29.1337"></a><span id="l29.1337">   /**</span>
<a href="#l29.1338"></a><span id="l29.1338">    * Shows/Hides a tree column.</span>
<a href="#l29.1339"></a><span id="l29.1339" class="difflineat">@@ -1159,18 +1076,17 @@ var ViewMenu = {</span>
<a href="#l29.1340"></a><span id="l29.1340">     var splitter = column.nextSibling;</span>
<a href="#l29.1341"></a><span id="l29.1341">     if (splitter &amp;&amp; splitter.localName != &quot;splitter&quot;)</span>
<a href="#l29.1342"></a><span id="l29.1342">       splitter = null;</span>
<a href="#l29.1343"></a><span id="l29.1343"> </span>
<a href="#l29.1344"></a><span id="l29.1344">     if (element.getAttribute(&quot;checked&quot;) == &quot;true&quot;) {</span>
<a href="#l29.1345"></a><span id="l29.1345">       column.setAttribute(&quot;hidden&quot;, &quot;false&quot;);</span>
<a href="#l29.1346"></a><span id="l29.1346">       if (splitter)</span>
<a href="#l29.1347"></a><span id="l29.1347">         splitter.removeAttribute(&quot;hidden&quot;);</span>
<a href="#l29.1348"></a><span id="l29.1348" class="difflineminus">-    }</span>
<a href="#l29.1349"></a><span id="l29.1349" class="difflineminus">-    else {</span>
<a href="#l29.1350"></a><span id="l29.1350" class="difflineplus">+    } else {</span>
<a href="#l29.1351"></a><span id="l29.1351">       column.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l29.1352"></a><span id="l29.1352">       if (splitter)</span>
<a href="#l29.1353"></a><span id="l29.1353">         splitter.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l29.1354"></a><span id="l29.1354">     }</span>
<a href="#l29.1355"></a><span id="l29.1355">   },</span>
<a href="#l29.1356"></a><span id="l29.1356"> </span>
<a href="#l29.1357"></a><span id="l29.1357">   /**</span>
<a href="#l29.1358"></a><span id="l29.1358">    * Gets the last column that was sorted.</span>
<a href="#l29.1359"></a><span id="l29.1359" class="difflineat">@@ -1205,53 +1121,223 @@ var ViewMenu = {</span>
<a href="#l29.1360"></a><span id="l29.1360">       result.sortingMode = Ci.nsINavHistoryQueryOptions.SORT_BY_NONE;</span>
<a href="#l29.1361"></a><span id="l29.1361">       return;</span>
<a href="#l29.1362"></a><span id="l29.1362">     }</span>
<a href="#l29.1363"></a><span id="l29.1363"> </span>
<a href="#l29.1364"></a><span id="l29.1364">     var columnId;</span>
<a href="#l29.1365"></a><span id="l29.1365">     if (aColumn) {</span>
<a href="#l29.1366"></a><span id="l29.1366">       columnId = aColumn.getAttribute(&quot;anonid&quot;);</span>
<a href="#l29.1367"></a><span id="l29.1367">       if (!aDirection) {</span>
<a href="#l29.1368"></a><span id="l29.1368" class="difflineminus">-        var sortColumn = this._getSortColumn();</span>
<a href="#l29.1369"></a><span id="l29.1369" class="difflineplus">+        let sortColumn = this._getSortColumn();</span>
<a href="#l29.1370"></a><span id="l29.1370">         if (sortColumn)</span>
<a href="#l29.1371"></a><span id="l29.1371">           aDirection = sortColumn.getAttribute(&quot;sortDirection&quot;);</span>
<a href="#l29.1372"></a><span id="l29.1372">       }</span>
<a href="#l29.1373"></a><span id="l29.1373" class="difflineminus">-    }</span>
<a href="#l29.1374"></a><span id="l29.1374" class="difflineminus">-    else {</span>
<a href="#l29.1375"></a><span id="l29.1375" class="difflineminus">-      var sortColumn = this._getSortColumn();</span>
<a href="#l29.1376"></a><span id="l29.1376" class="difflineplus">+    } else {</span>
<a href="#l29.1377"></a><span id="l29.1377" class="difflineplus">+      let sortColumn = this._getSortColumn();</span>
<a href="#l29.1378"></a><span id="l29.1378">       columnId = sortColumn ? sortColumn.getAttribute(&quot;anonid&quot;) : &quot;title&quot;;</span>
<a href="#l29.1379"></a><span id="l29.1379">     }</span>
<a href="#l29.1380"></a><span id="l29.1380"> </span>
<a href="#l29.1381"></a><span id="l29.1381">     // This maps the possible values of columnId (i.e., anonid's of treecols in</span>
<a href="#l29.1382"></a><span id="l29.1382">     // placeContent) to the default sortingMode and sortingAnnotation values for</span>
<a href="#l29.1383"></a><span id="l29.1383">     // each column.</span>
<a href="#l29.1384"></a><span id="l29.1384">     //   key:  Sort key in the name of one of the</span>
<a href="#l29.1385"></a><span id="l29.1385">     //         nsINavHistoryQueryOptions.SORT_BY_* constants</span>
<a href="#l29.1386"></a><span id="l29.1386">     //   dir:  Default sort direction to use if none has been specified</span>
<a href="#l29.1387"></a><span id="l29.1387">     //   anno: The annotation to sort by, if key is &quot;ANNOTATION&quot;</span>
<a href="#l29.1388"></a><span id="l29.1388">     var colLookupTable = {</span>
<a href="#l29.1389"></a><span id="l29.1389">       title:        { key: &quot;TITLE&quot;,        dir: &quot;ascending&quot;  },</span>
<a href="#l29.1390"></a><span id="l29.1390">       tags:         { key: &quot;TAGS&quot;,         dir: &quot;ascending&quot;  },</span>
<a href="#l29.1391"></a><span id="l29.1391">       url:          { key: &quot;URI&quot;,          dir: &quot;ascending&quot;  },</span>
<a href="#l29.1392"></a><span id="l29.1392">       date:         { key: &quot;DATE&quot;,         dir: &quot;descending&quot; },</span>
<a href="#l29.1393"></a><span id="l29.1393">       visitCount:   { key: &quot;VISITCOUNT&quot;,   dir: &quot;descending&quot; },</span>
<a href="#l29.1394"></a><span id="l29.1394" class="difflineminus">-      keyword:      { key: &quot;KEYWORD&quot;,      dir: &quot;ascending&quot;  },</span>
<a href="#l29.1395"></a><span id="l29.1395">       dateAdded:    { key: &quot;DATEADDED&quot;,    dir: &quot;descending&quot; },</span>
<a href="#l29.1396"></a><span id="l29.1396">       lastModified: { key: &quot;LASTMODIFIED&quot;, dir: &quot;descending&quot; },</span>
<a href="#l29.1397"></a><span id="l29.1397">       description:  { key: &quot;ANNOTATION&quot;,</span>
<a href="#l29.1398"></a><span id="l29.1398">                       dir: &quot;ascending&quot;,</span>
<a href="#l29.1399"></a><span id="l29.1399">                       anno: PlacesUIUtils.DESCRIPTION_ANNO }</span>
<a href="#l29.1400"></a><span id="l29.1400">     };</span>
<a href="#l29.1401"></a><span id="l29.1401"> </span>
<a href="#l29.1402"></a><span id="l29.1402">     // Make sure we have a valid column.</span>
<a href="#l29.1403"></a><span id="l29.1403">     if (!colLookupTable.hasOwnProperty(columnId))</span>
<a href="#l29.1404"></a><span id="l29.1404" class="difflineminus">-      throw(&quot;Invalid column&quot;);</span>
<a href="#l29.1405"></a><span id="l29.1405" class="difflineplus">+      throw new Error(&quot;Invalid column&quot;);</span>
<a href="#l29.1406"></a><span id="l29.1406"> </span>
<a href="#l29.1407"></a><span id="l29.1407">     // Use a default sort direction if none has been specified.  If aDirection</span>
<a href="#l29.1408"></a><span id="l29.1408">     // is invalid, result.sortingMode will be undefined, which has the effect</span>
<a href="#l29.1409"></a><span id="l29.1409">     // of unsorting the tree.</span>
<a href="#l29.1410"></a><span id="l29.1410">     aDirection = (aDirection || colLookupTable[columnId].dir).toUpperCase();</span>
<a href="#l29.1411"></a><span id="l29.1411"> </span>
<a href="#l29.1412"></a><span id="l29.1412">     var sortConst = &quot;SORT_BY_&quot; + colLookupTable[columnId].key + &quot;_&quot; + aDirection;</span>
<a href="#l29.1413"></a><span id="l29.1413">     result.sortingAnnotation = colLookupTable[columnId].anno || &quot;&quot;;</span>
<a href="#l29.1414"></a><span id="l29.1414">     result.sortingMode = Ci.nsINavHistoryQueryOptions[sortConst];</span>
<a href="#l29.1415"></a><span id="l29.1415">   }</span>
<a href="#l29.1416"></a><span id="l29.1416" class="difflineplus">+}</span>
<a href="#l29.1417"></a><span id="l29.1417" class="difflineplus">+</span>
<a href="#l29.1418"></a><span id="l29.1418" class="difflineplus">+var ContentArea = {</span>
<a href="#l29.1419"></a><span id="l29.1419" class="difflineplus">+  _specialViews: new Map(),</span>
<a href="#l29.1420"></a><span id="l29.1420" class="difflineplus">+</span>
<a href="#l29.1421"></a><span id="l29.1421" class="difflineplus">+  init: function CA_init() {</span>
<a href="#l29.1422"></a><span id="l29.1422" class="difflineplus">+    this._deck = document.getElementById(&quot;placesViewsDeck&quot;);</span>
<a href="#l29.1423"></a><span id="l29.1423" class="difflineplus">+    this._toolbar = document.getElementById(&quot;placesToolbar&quot;);</span>
<a href="#l29.1424"></a><span id="l29.1424" class="difflineplus">+    ContentTree.init();</span>
<a href="#l29.1425"></a><span id="l29.1425" class="difflineplus">+    this._setupView();</span>
<a href="#l29.1426"></a><span id="l29.1426" class="difflineplus">+  },</span>
<a href="#l29.1427"></a><span id="l29.1427" class="difflineplus">+</span>
<a href="#l29.1428"></a><span id="l29.1428" class="difflineplus">+  /**</span>
<a href="#l29.1429"></a><span id="l29.1429" class="difflineplus">+   * Gets the content view to be used for loading the given query.</span>
<a href="#l29.1430"></a><span id="l29.1430" class="difflineplus">+   * If a custom view was set by setContentViewForQueryString, that</span>
<a href="#l29.1431"></a><span id="l29.1431" class="difflineplus">+   * view would be returned, else the default tree view is returned</span>
<a href="#l29.1432"></a><span id="l29.1432" class="difflineplus">+   *</span>
<a href="#l29.1433"></a><span id="l29.1433" class="difflineplus">+   * @param aQueryString</span>
<a href="#l29.1434"></a><span id="l29.1434" class="difflineplus">+   *        a query string</span>
<a href="#l29.1435"></a><span id="l29.1435" class="difflineplus">+   * @return the view to be used for loading aQueryString.</span>
<a href="#l29.1436"></a><span id="l29.1436" class="difflineplus">+   */</span>
<a href="#l29.1437"></a><span id="l29.1437" class="difflineplus">+  getContentViewForQueryString:</span>
<a href="#l29.1438"></a><span id="l29.1438" class="difflineplus">+  function CA_getContentViewForQueryString(aQueryString) {</span>
<a href="#l29.1439"></a><span id="l29.1439" class="difflineplus">+    try {</span>
<a href="#l29.1440"></a><span id="l29.1440" class="difflineplus">+      if (this._specialViews.has(aQueryString)) {</span>
<a href="#l29.1441"></a><span id="l29.1441" class="difflineplus">+        let { view, options } = this._specialViews.get(aQueryString);</span>
<a href="#l29.1442"></a><span id="l29.1442" class="difflineplus">+        if (typeof view == &quot;function&quot;) {</span>
<a href="#l29.1443"></a><span id="l29.1443" class="difflineplus">+          view = view();</span>
<a href="#l29.1444"></a><span id="l29.1444" class="difflineplus">+          this._specialViews.set(aQueryString, { view, options });</span>
<a href="#l29.1445"></a><span id="l29.1445" class="difflineplus">+        }</span>
<a href="#l29.1446"></a><span id="l29.1446" class="difflineplus">+        return view;</span>
<a href="#l29.1447"></a><span id="l29.1447" class="difflineplus">+      }</span>
<a href="#l29.1448"></a><span id="l29.1448" class="difflineplus">+    } catch (ex) {</span>
<a href="#l29.1449"></a><span id="l29.1449" class="difflineplus">+      Cu.reportError(ex);</span>
<a href="#l29.1450"></a><span id="l29.1450" class="difflineplus">+    }</span>
<a href="#l29.1451"></a><span id="l29.1451" class="difflineplus">+    return ContentTree.view;</span>
<a href="#l29.1452"></a><span id="l29.1452" class="difflineplus">+  },</span>
<a href="#l29.1453"></a><span id="l29.1453" class="difflineplus">+</span>
<a href="#l29.1454"></a><span id="l29.1454" class="difflineplus">+  /**</span>
<a href="#l29.1455"></a><span id="l29.1455" class="difflineplus">+   * Sets a custom view to be used rather than the default places tree</span>
<a href="#l29.1456"></a><span id="l29.1456" class="difflineplus">+   * whenever the given query is selected in the left pane.</span>
<a href="#l29.1457"></a><span id="l29.1457" class="difflineplus">+   * @param aQueryString</span>
<a href="#l29.1458"></a><span id="l29.1458" class="difflineplus">+   *        a query string</span>
<a href="#l29.1459"></a><span id="l29.1459" class="difflineplus">+   * @param aView</span>
<a href="#l29.1460"></a><span id="l29.1460" class="difflineplus">+   *        Either the custom view or a function that will return the view</span>
<a href="#l29.1461"></a><span id="l29.1461" class="difflineplus">+   *        the first (and only) time it's called.</span>
<a href="#l29.1462"></a><span id="l29.1462" class="difflineplus">+   * @param [optional] aOptions</span>
<a href="#l29.1463"></a><span id="l29.1463" class="difflineplus">+   *        Object defining special options for the view.</span>
<a href="#l29.1464"></a><span id="l29.1464" class="difflineplus">+   * @see ContentTree.viewOptions for supported options and default values.</span>
<a href="#l29.1465"></a><span id="l29.1465" class="difflineplus">+   */</span>
<a href="#l29.1466"></a><span id="l29.1466" class="difflineplus">+  setContentViewForQueryString:</span>
<a href="#l29.1467"></a><span id="l29.1467" class="difflineplus">+  function CA_setContentViewForQueryString(aQueryString, aView, aOptions) {</span>
<a href="#l29.1468"></a><span id="l29.1468" class="difflineplus">+    if (!aQueryString ||</span>
<a href="#l29.1469"></a><span id="l29.1469" class="difflineplus">+        typeof aView != &quot;object&quot; &amp;&amp; typeof aView != &quot;function&quot;)</span>
<a href="#l29.1470"></a><span id="l29.1470" class="difflineplus">+      throw new Error(&quot;Invalid arguments&quot;);</span>
<a href="#l29.1471"></a><span id="l29.1471" class="difflineplus">+</span>
<a href="#l29.1472"></a><span id="l29.1472" class="difflineplus">+    this._specialViews.set(aQueryString, { view: aView,</span>
<a href="#l29.1473"></a><span id="l29.1473" class="difflineplus">+                                           options: aOptions || {} });</span>
<a href="#l29.1474"></a><span id="l29.1474" class="difflineplus">+  },</span>
<a href="#l29.1475"></a><span id="l29.1475" class="difflineplus">+</span>
<a href="#l29.1476"></a><span id="l29.1476" class="difflineplus">+  get currentView() {</span>
<a href="#l29.1477"></a><span id="l29.1477" class="difflineplus">+    return PlacesUIUtils.getViewForNode(this._deck.selectedPanel);</span>
<a href="#l29.1478"></a><span id="l29.1478" class="difflineplus">+  },</span>
<a href="#l29.1479"></a><span id="l29.1479" class="difflineplus">+  set currentView(aNewView) {</span>
<a href="#l29.1480"></a><span id="l29.1480" class="difflineplus">+    let oldView = this.currentView;</span>
<a href="#l29.1481"></a><span id="l29.1481" class="difflineplus">+    if (oldView != aNewView) {</span>
<a href="#l29.1482"></a><span id="l29.1482" class="difflineplus">+      this._deck.selectedPanel = aNewView.associatedElement;</span>
<a href="#l29.1483"></a><span id="l29.1483" class="difflineplus">+</span>
<a href="#l29.1484"></a><span id="l29.1484" class="difflineplus">+      // If the content area inactivated view was focused, move focus</span>
<a href="#l29.1485"></a><span id="l29.1485" class="difflineplus">+      // to the new view.</span>
<a href="#l29.1486"></a><span id="l29.1486" class="difflineplus">+      if (document.activeElement == oldView.associatedElement)</span>
<a href="#l29.1487"></a><span id="l29.1487" class="difflineplus">+        aNewView.associatedElement.focus();</span>
<a href="#l29.1488"></a><span id="l29.1488" class="difflineplus">+    }</span>
<a href="#l29.1489"></a><span id="l29.1489" class="difflineplus">+    return aNewView;</span>
<a href="#l29.1490"></a><span id="l29.1490" class="difflineplus">+  },</span>
<a href="#l29.1491"></a><span id="l29.1491" class="difflineplus">+</span>
<a href="#l29.1492"></a><span id="l29.1492" class="difflineplus">+  get currentPlace() {</span>
<a href="#l29.1493"></a><span id="l29.1493" class="difflineplus">+    return this.currentView.place;</span>
<a href="#l29.1494"></a><span id="l29.1494" class="difflineplus">+  },</span>
<a href="#l29.1495"></a><span id="l29.1495" class="difflineplus">+  set currentPlace(aQueryString) {</span>
<a href="#l29.1496"></a><span id="l29.1496" class="difflineplus">+    let oldView = this.currentView;</span>
<a href="#l29.1497"></a><span id="l29.1497" class="difflineplus">+    let newView = this.getContentViewForQueryString(aQueryString);</span>
<a href="#l29.1498"></a><span id="l29.1498" class="difflineplus">+    newView.place = aQueryString;</span>
<a href="#l29.1499"></a><span id="l29.1499" class="difflineplus">+    if (oldView != newView) {</span>
<a href="#l29.1500"></a><span id="l29.1500" class="difflineplus">+      oldView.active = false;</span>
<a href="#l29.1501"></a><span id="l29.1501" class="difflineplus">+      this.currentView = newView;</span>
<a href="#l29.1502"></a><span id="l29.1502" class="difflineplus">+      this._setupView();</span>
<a href="#l29.1503"></a><span id="l29.1503" class="difflineplus">+      newView.active = true;</span>
<a href="#l29.1504"></a><span id="l29.1504" class="difflineplus">+    }</span>
<a href="#l29.1505"></a><span id="l29.1505" class="difflineplus">+    return aQueryString;</span>
<a href="#l29.1506"></a><span id="l29.1506" class="difflineplus">+  },</span>
<a href="#l29.1507"></a><span id="l29.1507" class="difflineplus">+</span>
<a href="#l29.1508"></a><span id="l29.1508" class="difflineplus">+  /**</span>
<a href="#l29.1509"></a><span id="l29.1509" class="difflineplus">+   * Applies view options.</span>
<a href="#l29.1510"></a><span id="l29.1510" class="difflineplus">+   */</span>
<a href="#l29.1511"></a><span id="l29.1511" class="difflineplus">+  _setupView: function CA__setupView() {</span>
<a href="#l29.1512"></a><span id="l29.1512" class="difflineplus">+    let options = this.currentViewOptions;</span>
<a href="#l29.1513"></a><span id="l29.1513" class="difflineplus">+</span>
<a href="#l29.1514"></a><span id="l29.1514" class="difflineplus">+    // showDetailsPane.</span>
<a href="#l29.1515"></a><span id="l29.1515" class="difflineplus">+    let detailsDeck = document.getElementById(&quot;detailsDeck&quot;);</span>
<a href="#l29.1516"></a><span id="l29.1516" class="difflineplus">+    detailsDeck.hidden = !options.showDetailsPane;</span>
<a href="#l29.1517"></a><span id="l29.1517" class="difflineplus">+</span>
<a href="#l29.1518"></a><span id="l29.1518" class="difflineplus">+    // toolbarSet.</span>
<a href="#l29.1519"></a><span id="l29.1519" class="difflineplus">+    for (let elt of this._toolbar.childNodes) {</span>
<a href="#l29.1520"></a><span id="l29.1520" class="difflineplus">+      elt.hidden = !options.toolbarSet.includes(elt.id);</span>
<a href="#l29.1521"></a><span id="l29.1521" class="difflineplus">+    }</span>
<a href="#l29.1522"></a><span id="l29.1522" class="difflineplus">+  },</span>
<a href="#l29.1523"></a><span id="l29.1523" class="difflineplus">+</span>
<a href="#l29.1524"></a><span id="l29.1524" class="difflineplus">+  /**</span>
<a href="#l29.1525"></a><span id="l29.1525" class="difflineplus">+   * Options for the current view.</span>
<a href="#l29.1526"></a><span id="l29.1526" class="difflineplus">+   *</span>
<a href="#l29.1527"></a><span id="l29.1527" class="difflineplus">+   * @see ContentTree.viewOptions for supported options and default values.</span>
<a href="#l29.1528"></a><span id="l29.1528" class="difflineplus">+   */</span>
<a href="#l29.1529"></a><span id="l29.1529" class="difflineplus">+  get currentViewOptions() {</span>
<a href="#l29.1530"></a><span id="l29.1530" class="difflineplus">+    // Use ContentTree options as default.</span>
<a href="#l29.1531"></a><span id="l29.1531" class="difflineplus">+    let viewOptions = ContentTree.viewOptions;</span>
<a href="#l29.1532"></a><span id="l29.1532" class="difflineplus">+    if (this._specialViews.has(this.currentPlace)) {</span>
<a href="#l29.1533"></a><span id="l29.1533" class="difflineplus">+      let { options } = this._specialViews.get(this.currentPlace);</span>
<a href="#l29.1534"></a><span id="l29.1534" class="difflineplus">+      for (let option in options) {</span>
<a href="#l29.1535"></a><span id="l29.1535" class="difflineplus">+        viewOptions[option] = options[option];</span>
<a href="#l29.1536"></a><span id="l29.1536" class="difflineplus">+      }</span>
<a href="#l29.1537"></a><span id="l29.1537" class="difflineplus">+    }</span>
<a href="#l29.1538"></a><span id="l29.1538" class="difflineplus">+    return viewOptions;</span>
<a href="#l29.1539"></a><span id="l29.1539" class="difflineplus">+  },</span>
<a href="#l29.1540"></a><span id="l29.1540" class="difflineplus">+</span>
<a href="#l29.1541"></a><span id="l29.1541" class="difflineplus">+  focus() {</span>
<a href="#l29.1542"></a><span id="l29.1542" class="difflineplus">+    this._deck.selectedPanel.focus();</span>
<a href="#l29.1543"></a><span id="l29.1543" class="difflineplus">+  }</span>
<a href="#l29.1544"></a><span id="l29.1544"> };</span>
<a href="#l29.1545"></a><span id="l29.1545" class="difflineplus">+</span>
<a href="#l29.1546"></a><span id="l29.1546" class="difflineplus">+var ContentTree = {</span>
<a href="#l29.1547"></a><span id="l29.1547" class="difflineplus">+  init: function CT_init() {</span>
<a href="#l29.1548"></a><span id="l29.1548" class="difflineplus">+    this._view = document.getElementById(&quot;placeContent&quot;);</span>
<a href="#l29.1549"></a><span id="l29.1549" class="difflineplus">+  },</span>
<a href="#l29.1550"></a><span id="l29.1550" class="difflineplus">+</span>
<a href="#l29.1551"></a><span id="l29.1551" class="difflineplus">+  get view() {</span>
<a href="#l29.1552"></a><span id="l29.1552" class="difflineplus">+    return this._view;</span>
<a href="#l29.1553"></a><span id="l29.1553" class="difflineplus">+  },</span>
<a href="#l29.1554"></a><span id="l29.1554" class="difflineplus">+</span>
<a href="#l29.1555"></a><span id="l29.1555" class="difflineplus">+  get viewOptions() {</span>
<a href="#l29.1556"></a><span id="l29.1556" class="difflineplus">+    return Object.seal({</span>
<a href="#l29.1557"></a><span id="l29.1557" class="difflineplus">+      showDetailsPane: true,</span>
<a href="#l29.1558"></a><span id="l29.1558" class="difflineplus">+      toolbarSet: &quot;placesMenu, toolbar-spacer, searchFilter&quot;</span>
<a href="#l29.1559"></a><span id="l29.1559" class="difflineplus">+    });</span>
<a href="#l29.1560"></a><span id="l29.1560" class="difflineplus">+  },</span>
<a href="#l29.1561"></a><span id="l29.1561" class="difflineplus">+</span>
<a href="#l29.1562"></a><span id="l29.1562" class="difflineplus">+  openSelectedNode: function CT_openSelectedNode(aEvent) {</span>
<a href="#l29.1563"></a><span id="l29.1563" class="difflineplus">+    let view = this.view;</span>
<a href="#l29.1564"></a><span id="l29.1564" class="difflineplus">+    PlacesUIUtils.openNodeWithEvent(view.selectedNode, aEvent);</span>
<a href="#l29.1565"></a><span id="l29.1565" class="difflineplus">+  },</span>
<a href="#l29.1566"></a><span id="l29.1566" class="difflineplus">+</span>
<a href="#l29.1567"></a><span id="l29.1567" class="difflineplus">+  onClick: function CT_onClick(aEvent) {</span>
<a href="#l29.1568"></a><span id="l29.1568" class="difflineplus">+    let node = this.view.selectedNode;</span>
<a href="#l29.1569"></a><span id="l29.1569" class="difflineplus">+    if (node) {</span>
<a href="#l29.1570"></a><span id="l29.1570" class="difflineplus">+      let doubleClick = aEvent.button == 0 &amp;&amp; aEvent.detail == 2;</span>
<a href="#l29.1571"></a><span id="l29.1571" class="difflineplus">+      let middleClick = aEvent.button == 1 &amp;&amp; aEvent.detail == 1;</span>
<a href="#l29.1572"></a><span id="l29.1572" class="difflineplus">+      if (PlacesUtils.nodeIsURI(node) &amp;&amp; (doubleClick || middleClick)) {</span>
<a href="#l29.1573"></a><span id="l29.1573" class="difflineplus">+        // Open associated uri in the browser.</span>
<a href="#l29.1574"></a><span id="l29.1574" class="difflineplus">+        this.openSelectedNode(aEvent);</span>
<a href="#l29.1575"></a><span id="l29.1575" class="difflineplus">+      } else if (middleClick &amp;&amp; PlacesUtils.nodeIsContainer(node)) {</span>
<a href="#l29.1576"></a><span id="l29.1576" class="difflineplus">+        // The command execution function will take care of seeing if the</span>
<a href="#l29.1577"></a><span id="l29.1577" class="difflineplus">+        // selection is a folder or a different container type, and will</span>
<a href="#l29.1578"></a><span id="l29.1578" class="difflineplus">+        // load its contents in tabs.</span>
<a href="#l29.1579"></a><span id="l29.1579" class="difflineplus">+        PlacesUIUtils.openContainerNodeInTabs(node, aEvent, this.view);</span>
<a href="#l29.1580"></a><span id="l29.1580" class="difflineplus">+      }</span>
<a href="#l29.1581"></a><span id="l29.1581" class="difflineplus">+    }</span>
<a href="#l29.1582"></a><span id="l29.1582" class="difflineplus">+  },</span>
<a href="#l29.1583"></a><span id="l29.1583" class="difflineplus">+</span>
<a href="#l29.1584"></a><span id="l29.1584" class="difflineplus">+  onKeyPress: function CT_onKeyPress(aEvent) {</span>
<a href="#l29.1585"></a><span id="l29.1585" class="difflineplus">+    if (aEvent.keyCode == KeyEvent.DOM_VK_RETURN)</span>
<a href="#l29.1586"></a><span id="l29.1586" class="difflineplus">+      this.openSelectedNode(aEvent);</span>
<a href="#l29.1587"></a><span id="l29.1587" class="difflineplus">+  }</span>
<a href="#l29.1588"></a><span id="l29.1588" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l30.1"></a><span id="l30.1" class="difflineminus">--- a/suite/common/places/content/places.xul</span>
<a href="#l30.2"></a><span id="l30.2" class="difflineplus">+++ b/suite/common/places/content/places.xul</span>
<a href="#l30.3"></a><span id="l30.3" class="difflineat">@@ -1,119 +1,109 @@</span>
<a href="#l30.4"></a><span id="l30.4"> &lt;?xml version=&quot;1.0&quot;?&gt;</span>
<a href="#l30.5"></a><span id="l30.5"> </span>
<a href="#l30.6"></a><span id="l30.6" class="difflineminus">-&lt;!-- This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l30.7"></a><span id="l30.7" class="difflineminus">-   - License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l30.8"></a><span id="l30.8" class="difflineminus">-   - file, You can obtain one at http://mozilla.org/MPL/2.0/. --&gt;</span>
<a href="#l30.9"></a><span id="l30.9" class="difflineplus">+# This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l30.10"></a><span id="l30.10" class="difflineplus">+# License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l30.11"></a><span id="l30.11" class="difflineplus">+# file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l30.12"></a><span id="l30.12"> </span>
<a href="#l30.13"></a><span id="l30.13"> &lt;?xml-stylesheet href=&quot;chrome://communicator/content/places/places.css&quot;?&gt;</span>
<a href="#l30.14"></a><span id="l30.14" class="difflineminus">-&lt;?xml-stylesheet href=&quot;chrome://communicator/content/bookmarks/bookmarksManager.css&quot;?&gt;</span>
<a href="#l30.15"></a><span id="l30.15" class="difflineplus">+&lt;?xml-stylesheet href=&quot;chrome://communicator/content/places/organizer.css&quot;?&gt;</span>
<a href="#l30.16"></a><span id="l30.16"> </span>
<a href="#l30.17"></a><span id="l30.17"> &lt;?xml-stylesheet href=&quot;chrome://communicator/skin/&quot;?&gt;</span>
<a href="#l30.18"></a><span id="l30.18" class="difflineminus">-&lt;?xml-stylesheet href=&quot;chrome://communicator/skin/bookmarks/bookmarks.css&quot;?&gt;</span>
<a href="#l30.19"></a><span id="l30.19" class="difflineminus">-&lt;?xml-stylesheet href=&quot;chrome://communicator/skin/bookmarks/bookmarksManager.css&quot;?&gt;</span>
<a href="#l30.20"></a><span id="l30.20" class="difflineplus">+&lt;?xml-stylesheet href=&quot;chrome://communicator/skin/places/bookmarks.css&quot;?&gt;</span>
<a href="#l30.21"></a><span id="l30.21" class="difflineplus">+&lt;?xml-stylesheet href=&quot;chrome://communicator/skin/places/organizer.css&quot;?&gt;</span>
<a href="#l30.22"></a><span id="l30.22"> </span>
<a href="#l30.23"></a><span id="l30.23" class="difflineminus">-&lt;?xul-overlay href=&quot;chrome://communicator/content/bookmarks/editBookmarkOverlay.xul&quot;?&gt;</span>
<a href="#l30.24"></a><span id="l30.24" class="difflineplus">+&lt;?xul-overlay href=&quot;chrome://communicator/content/places/editBookmarkOverlay.xul&quot;?&gt;</span>
<a href="#l30.25"></a><span id="l30.25"> </span>
<a href="#l30.26"></a><span id="l30.26"> &lt;?xul-overlay href=&quot;chrome://communicator/content/utilityOverlay.xul&quot;?&gt;</span>
<a href="#l30.27"></a><span id="l30.27"> &lt;?xul-overlay href=&quot;chrome://communicator/content/tasksOverlay.xul&quot;?&gt;</span>
<a href="#l30.28"></a><span id="l30.28"> &lt;?xul-overlay href=&quot;chrome://global/content/editMenuOverlay.xul&quot;?&gt;</span>
<a href="#l30.29"></a><span id="l30.29" class="difflineminus">-&lt;?xul-overlay href=&quot;chrome://communicator/content/bookmarks/placesOverlay.xul&quot;?&gt;</span>
<a href="#l30.30"></a><span id="l30.30" class="difflineplus">+&lt;?xul-overlay href=&quot;chrome://communicator/content/places/placesOverlay.xul&quot;?&gt;</span>
<a href="#l30.31"></a><span id="l30.31"> </span>
<a href="#l30.32"></a><span id="l30.32"> &lt;!DOCTYPE window [</span>
<a href="#l30.33"></a><span id="l30.33" class="difflineminus">-&lt;!ENTITY % placesDTD SYSTEM &quot;chrome://communicator/locale/bookmarks/places.dtd&quot;&gt;</span>
<a href="#l30.34"></a><span id="l30.34" class="difflineplus">+&lt;!ENTITY % placesDTD SYSTEM &quot;chrome://communicator/locale/places/places.dtd&quot;&gt;</span>
<a href="#l30.35"></a><span id="l30.35"> %placesDTD;</span>
<a href="#l30.36"></a><span id="l30.36"> &lt;!ENTITY % editMenuOverlayDTD SYSTEM &quot;chrome://global/locale/editMenuOverlay.dtd&quot;&gt;</span>
<a href="#l30.37"></a><span id="l30.37"> %editMenuOverlayDTD;</span>
<a href="#l30.38"></a><span id="l30.38"> &lt;!ENTITY % navDTD SYSTEM &quot;chrome://navigator/locale/navigator.dtd&quot;&gt;</span>
<a href="#l30.39"></a><span id="l30.39"> %navDTD;</span>
<a href="#l30.40"></a><span id="l30.40"> ]&gt;</span>
<a href="#l30.41"></a><span id="l30.41"> </span>
<a href="#l30.42"></a><span id="l30.42"> &lt;window id=&quot;places&quot;</span>
<a href="#l30.43"></a><span id="l30.43" class="difflineminus">-        title=&quot;&amp;bookmarksManager.title;&quot;</span>
<a href="#l30.44"></a><span id="l30.44" class="difflineminus">-        windowtype=&quot;bookmarks:manager&quot;</span>
<a href="#l30.45"></a><span id="l30.45" class="difflineplus">+        title=&quot;&amp;places.library.title;&quot;</span>
<a href="#l30.46"></a><span id="l30.46" class="difflineplus">+        windowtype=&quot;Places:Organizer&quot;</span>
<a href="#l30.47"></a><span id="l30.47">         xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;</span>
<a href="#l30.48"></a><span id="l30.48">         xmlns:html=&quot;http://www.w3.org/1999/xhtml&quot;</span>
<a href="#l30.49"></a><span id="l30.49">         onload=&quot;PlacesOrganizer.init();&quot;</span>
<a href="#l30.50"></a><span id="l30.50">         onunload=&quot;PlacesOrganizer.destroy();&quot;</span>
<a href="#l30.51"></a><span id="l30.51" class="difflineminus">-        width=&quot;&amp;bookmarksManager.width;&quot; height=&quot;&amp;bookmarksManager.height;&quot;</span>
<a href="#l30.52"></a><span id="l30.52" class="difflineplus">+        width=&quot;&amp;places.library.width;&quot; height=&quot;&amp;places.library.height;&quot;</span>
<a href="#l30.53"></a><span id="l30.53">         screenX=&quot;10&quot; screenY=&quot;10&quot;</span>
<a href="#l30.54"></a><span id="l30.54">         toggletoolbar=&quot;true&quot;</span>
<a href="#l30.55"></a><span id="l30.55">         persist=&quot;width height screenX screenY sizemode&quot;&gt;</span>
<a href="#l30.56"></a><span id="l30.56"> </span>
<a href="#l30.57"></a><span id="l30.57">   &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l30.58"></a><span id="l30.58" class="difflineminus">-          src=&quot;chrome://communicator/content/bookmarks/bookmarksManager.js&quot;/&gt;</span>
<a href="#l30.59"></a><span id="l30.59" class="difflineplus">+          src=&quot;chrome://communicator/content/places/places.js&quot;/&gt;</span>
<a href="#l30.60"></a><span id="l30.60">   &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l30.61"></a><span id="l30.61" class="difflineminus">-          src=&quot;chrome://communicator/content/bookmarks/editBookmarkOverlay.js&quot;/&gt;</span>
<a href="#l30.62"></a><span id="l30.62" class="difflineplus">+          src=&quot;chrome://communicator/content/places/editBookmarkOverlay.js&quot;/&gt;</span>
<a href="#l30.63"></a><span id="l30.63"> </span>
<a href="#l30.64"></a><span id="l30.64">   &lt;stringbundleset id=&quot;placesStringSet&quot;&gt;</span>
<a href="#l30.65"></a><span id="l30.65">     &lt;stringbundle id=&quot;brandStrings&quot; src=&quot;chrome://branding/locale/brand.properties&quot;/&gt;</span>
<a href="#l30.66"></a><span id="l30.66">   &lt;/stringbundleset&gt;</span>
<a href="#l30.67"></a><span id="l30.67"> </span>
<a href="#l30.68"></a><span id="l30.68" class="difflineminus">-</span>
<a href="#l30.69"></a><span id="l30.69">   &lt;commandset id=&quot;editMenuCommands&quot;/&gt;</span>
<a href="#l30.70"></a><span id="l30.70">   &lt;commandset id=&quot;placesCommands&quot;/&gt;</span>
<a href="#l30.71"></a><span id="l30.71">   &lt;commandset id=&quot;tasksCommands&quot;/&gt;</span>
<a href="#l30.72"></a><span id="l30.72"> </span>
<a href="#l30.73"></a><span id="l30.73">   &lt;commandset id=&quot;organizerCommandSet&quot;&gt;</span>
<a href="#l30.74"></a><span id="l30.74">     &lt;command id=&quot;OrganizerCommand_find:all&quot;</span>
<a href="#l30.75"></a><span id="l30.75" class="difflineminus">-             label=&quot;&amp;cmd.findInBookmarks.label;&quot;</span>
<a href="#l30.76"></a><span id="l30.76" class="difflineminus">-             accesskey=&quot;&amp;cmd.findInBookmarks.accesskey;&quot;</span>
<a href="#l30.77"></a><span id="l30.77">              oncommand=&quot;PlacesSearchBox.findAll();&quot;/&gt;</span>
<a href="#l30.78"></a><span id="l30.78" class="difflineminus">-    &lt;command id=&quot;OrganizerCommand_find:current&quot;</span>
<a href="#l30.79"></a><span id="l30.79" class="difflineminus">-             label=&quot;&amp;cmd.findCurrent.label;&quot;</span>
<a href="#l30.80"></a><span id="l30.80" class="difflineminus">-             accesskey=&quot;&amp;cmd.findCurrent.accesskey;&quot;</span>
<a href="#l30.81"></a><span id="l30.81" class="difflineminus">-             oncommand=&quot;PlacesSearchBox.findCurrent();&quot;/&gt;</span>
<a href="#l30.82"></a><span id="l30.82">     &lt;command id=&quot;OrganizerCommand_export&quot;</span>
<a href="#l30.83"></a><span id="l30.83">              oncommand=&quot;PlacesOrganizer.exportBookmarks();&quot;/&gt;</span>
<a href="#l30.84"></a><span id="l30.84">     &lt;command id=&quot;OrganizerCommand_import&quot;</span>
<a href="#l30.85"></a><span id="l30.85" class="difflineminus">-             oncommand=&quot;PlacesOrganizer.importBookmarks();&quot;/&gt;</span>
<a href="#l30.86"></a><span id="l30.86" class="difflineplus">+             oncommand=&quot;PlacesOrganizer.importFromFile();&quot;/&gt;</span>
<a href="#l30.87"></a><span id="l30.87">     &lt;command id=&quot;OrganizerCommand_backup&quot;</span>
<a href="#l30.88"></a><span id="l30.88">              oncommand=&quot;PlacesOrganizer.backupBookmarks();&quot;/&gt;</span>
<a href="#l30.89"></a><span id="l30.89">     &lt;command id=&quot;OrganizerCommand_restoreFromFile&quot;</span>
<a href="#l30.90"></a><span id="l30.90">              oncommand=&quot;PlacesOrganizer.onRestoreBookmarksFromFile();&quot;/&gt;</span>
<a href="#l30.91"></a><span id="l30.91">     &lt;command id=&quot;OrganizerCommand_search:save&quot;</span>
<a href="#l30.92"></a><span id="l30.92">              oncommand=&quot;PlacesOrganizer.saveSearch();&quot;/&gt;</span>
<a href="#l30.93"></a><span id="l30.93">     &lt;command id=&quot;OrganizerCommand_search:moreCriteria&quot;</span>
<a href="#l30.94"></a><span id="l30.94">              oncommand=&quot;PlacesQueryBuilder.addRow();&quot;/&gt;</span>
<a href="#l30.95"></a><span id="l30.95">     &lt;command id=&quot;OrganizerCommand:Back&quot;</span>
<a href="#l30.96"></a><span id="l30.96">              oncommand=&quot;PlacesOrganizer.back();&quot;/&gt;</span>
<a href="#l30.97"></a><span id="l30.97">     &lt;command id=&quot;OrganizerCommand:Forward&quot;</span>
<a href="#l30.98"></a><span id="l30.98">              oncommand=&quot;PlacesOrganizer.forward();&quot;/&gt;</span>
<a href="#l30.99"></a><span id="l30.99">   &lt;/commandset&gt;</span>
<a href="#l30.100"></a><span id="l30.100"> </span>
<a href="#l30.101"></a><span id="l30.101" class="difflineminus">-</span>
<a href="#l30.102"></a><span id="l30.102">   &lt;keyset id=&quot;placesOrganizerKeyset&quot;&gt;</span>
<a href="#l30.103"></a><span id="l30.103">     &lt;!-- Instantiation Keys --&gt;</span>
<a href="#l30.104"></a><span id="l30.104">     &lt;key id=&quot;placesKey_close&quot; key=&quot;&amp;cmd.close.key;&quot; modifiers=&quot;accel&quot;</span>
<a href="#l30.105"></a><span id="l30.105">          oncommand=&quot;close();&quot;/&gt;</span>
<a href="#l30.106"></a><span id="l30.106"> </span>
<a href="#l30.107"></a><span id="l30.107">     &lt;!-- Command Keys --&gt;</span>
<a href="#l30.108"></a><span id="l30.108">     &lt;key id=&quot;placesKey_find:all&quot;</span>
<a href="#l30.109"></a><span id="l30.109">          command=&quot;OrganizerCommand_find:all&quot;</span>
<a href="#l30.110"></a><span id="l30.110">          key=&quot;&amp;cmd.find.key;&quot;</span>
<a href="#l30.111"></a><span id="l30.111">          modifiers=&quot;accel&quot;/&gt;</span>
<a href="#l30.112"></a><span id="l30.112" class="difflineminus">-    &lt;key id=&quot;placesKey_find:current&quot;</span>
<a href="#l30.113"></a><span id="l30.113" class="difflineminus">-         command=&quot;OrganizerCommand_find:current&quot;</span>
<a href="#l30.114"></a><span id="l30.114" class="difflineminus">-         key=&quot;&amp;cmd.find.key;&quot;</span>
<a href="#l30.115"></a><span id="l30.115" class="difflineminus">-         modifiers=&quot;accel,shift&quot;/&gt;</span>
<a href="#l30.116"></a><span id="l30.116"> </span>
<a href="#l30.117"></a><span id="l30.117">     &lt;!-- Back/Forward Keys Support --&gt;</span>
<a href="#l30.118"></a><span id="l30.118">     &lt;key id=&quot;placesKey_goBackKb&quot;</span>
<a href="#l30.119"></a><span id="l30.119">          keycode=&quot;VK_LEFT&quot;</span>
<a href="#l30.120"></a><span id="l30.120">          command=&quot;OrganizerCommand:Back&quot;</span>
<a href="#l30.121"></a><span id="l30.121">          modifiers=&quot;accel&quot;/&gt;</span>
<a href="#l30.122"></a><span id="l30.122">     &lt;key id=&quot;placesKey_goForwardKb&quot;</span>
<a href="#l30.123"></a><span id="l30.123">          keycode=&quot;VK_RIGHT&quot;</span>
<a href="#l30.124"></a><span id="l30.124">          command=&quot;OrganizerCommand:Forward&quot;</span>
<a href="#l30.125"></a><span id="l30.125">          modifiers=&quot;accel&quot;/&gt;</span>
<a href="#l30.126"></a><span id="l30.126">   &lt;/keyset&gt;</span>
<a href="#l30.127"></a><span id="l30.127"> </span>
<a href="#l30.128"></a><span id="l30.128">   &lt;keyset id=&quot;editMenuKeys&quot;&gt;</span>
<a href="#l30.129"></a><span id="l30.129" class="difflineplus">+#ifdef XP_MACOSX</span>
<a href="#l30.130"></a><span id="l30.130">     &lt;key id=&quot;key_delete2&quot; keycode=&quot;VK_BACK&quot; command=&quot;cmd_delete&quot;/&gt;</span>
<a href="#l30.131"></a><span id="l30.131" class="difflineplus">+#endif</span>
<a href="#l30.132"></a><span id="l30.132">   &lt;/keyset&gt;</span>
<a href="#l30.133"></a><span id="l30.133">   &lt;keyset id=&quot;tasksKeys&quot;&gt;</span>
<a href="#l30.134"></a><span id="l30.134">     &lt;key id=&quot;key_close2&quot; disabled=&quot;true&quot;/&gt;</span>
<a href="#l30.135"></a><span id="l30.135">   &lt;/keyset&gt;</span>
<a href="#l30.136"></a><span id="l30.136"> </span>
<a href="#l30.137"></a><span id="l30.137">   &lt;popupset id=&quot;placesPopupset&quot;&gt;</span>
<a href="#l30.138"></a><span id="l30.138">     &lt;menupopup id=&quot;placesContext&quot;/&gt;</span>
<a href="#l30.139"></a><span id="l30.139">     &lt;menupopup id=&quot;placesColumnsContext&quot;</span>
<a href="#l30.140"></a><span id="l30.140" class="difflineat">@@ -148,36 +138,30 @@</span>
<a href="#l30.141"></a><span id="l30.141">                       oncommand=&quot;close();&quot;/&gt;</span>
<a href="#l30.142"></a><span id="l30.142">           &lt;/menupopup&gt;</span>
<a href="#l30.143"></a><span id="l30.143">         &lt;/menu&gt;</span>
<a href="#l30.144"></a><span id="l30.144"> </span>
<a href="#l30.145"></a><span id="l30.145">         &lt;menu id=&quot;menu_Edit&quot;&gt;</span>
<a href="#l30.146"></a><span id="l30.146">           &lt;menupopup id=&quot;menu_EditPopup&quot;&gt;</span>
<a href="#l30.147"></a><span id="l30.147">             &lt;menuitem id=&quot;menu_undo&quot;/&gt;</span>
<a href="#l30.148"></a><span id="l30.148">             &lt;menuitem id=&quot;menu_redo&quot;/&gt;</span>
<a href="#l30.149"></a><span id="l30.149" class="difflineplus">+</span>
<a href="#l30.150"></a><span id="l30.150">             &lt;menuseparator id=&quot;orgCutSeparator&quot;/&gt;</span>
<a href="#l30.151"></a><span id="l30.151"> </span>
<a href="#l30.152"></a><span id="l30.152">             &lt;menuitem id=&quot;menu_cut&quot;</span>
<a href="#l30.153"></a><span id="l30.153">                       selection=&quot;separator|link|folder|mixed&quot;/&gt;</span>
<a href="#l30.154"></a><span id="l30.154">             &lt;menuitem id=&quot;menu_copy&quot;</span>
<a href="#l30.155"></a><span id="l30.155">                       selection=&quot;separator|link|folder|mixed&quot;/&gt;</span>
<a href="#l30.156"></a><span id="l30.156">             &lt;menuitem id=&quot;menu_paste&quot;</span>
<a href="#l30.157"></a><span id="l30.157">                       selection=&quot;mutable&quot;/&gt;</span>
<a href="#l30.158"></a><span id="l30.158">             &lt;menuitem id=&quot;menu_delete&quot;/&gt;</span>
<a href="#l30.159"></a><span id="l30.159"> </span>
<a href="#l30.160"></a><span id="l30.160">             &lt;menuseparator id=&quot;selectAllSeparator&quot;/&gt;</span>
<a href="#l30.161"></a><span id="l30.161"> </span>
<a href="#l30.162"></a><span id="l30.162">             &lt;menuitem id=&quot;menu_selectAll&quot;/&gt;</span>
<a href="#l30.163"></a><span id="l30.163" class="difflineminus">-</span>
<a href="#l30.164"></a><span id="l30.164" class="difflineminus">-            &lt;menuseparator id=&quot;orgMoveSeparator&quot;/&gt;</span>
<a href="#l30.165"></a><span id="l30.165" class="difflineminus">-</span>
<a href="#l30.166"></a><span id="l30.166" class="difflineminus">-            &lt;menuitem id=&quot;orgMoveBookmarks&quot;</span>
<a href="#l30.167"></a><span id="l30.167" class="difflineminus">-                      command=&quot;placesCmd_moveBookmarks&quot;</span>
<a href="#l30.168"></a><span id="l30.168" class="difflineminus">-                      label=&quot;&amp;cmd.moveBookmarks.label;&quot;</span>
<a href="#l30.169"></a><span id="l30.169" class="difflineminus">-                      accesskey=&quot;&amp;cmd.moveBookmarks.accesskey;&quot;/&gt;</span>
<a href="#l30.170"></a><span id="l30.170">           &lt;/menupopup&gt;</span>
<a href="#l30.171"></a><span id="l30.171">         &lt;/menu&gt;</span>
<a href="#l30.172"></a><span id="l30.172"> </span>
<a href="#l30.173"></a><span id="l30.173">         &lt;menu id=&quot;menu_View&quot;&gt;</span>
<a href="#l30.174"></a><span id="l30.174">           &lt;menupopup id=&quot;menu_ViewPopup&quot;</span>
<a href="#l30.175"></a><span id="l30.175">                      onpopupshowing=&quot;onViewToolbarsPopupShowing(event)&quot;</span>
<a href="#l30.176"></a><span id="l30.176">                      oncommand=&quot;onViewToolbarCommand(event);&quot;&gt;</span>
<a href="#l30.177"></a><span id="l30.177">             &lt;menuseparator id=&quot;toolbarmode-sep&quot;/&gt;</span>
<a href="#l30.178"></a><span id="l30.178" class="difflineat">@@ -185,17 +169,17 @@</span>
<a href="#l30.179"></a><span id="l30.179">                   label=&quot;&amp;view.columns.label;&quot; accesskey=&quot;&amp;view.columns.accesskey;&quot;&gt;</span>
<a href="#l30.180"></a><span id="l30.180">               &lt;menupopup onpopupshowing=&quot;ViewMenu.fillWithColumns(event, null, null, 'checkbox', null);&quot;</span>
<a href="#l30.181"></a><span id="l30.181">                          oncommand=&quot;ViewMenu.showHideColumn(event.target); event.stopPropagation();&quot;/&gt;</span>
<a href="#l30.182"></a><span id="l30.182">             &lt;/menu&gt;</span>
<a href="#l30.183"></a><span id="l30.183"> </span>
<a href="#l30.184"></a><span id="l30.184">             &lt;menu id=&quot;viewSort&quot; label=&quot;&amp;view.sort.label;&quot;</span>
<a href="#l30.185"></a><span id="l30.185">                   accesskey=&quot;&amp;view.sort.accesskey;&quot;&gt;</span>
<a href="#l30.186"></a><span id="l30.186">               &lt;menupopup onpopupshowing=&quot;ViewMenu.populateSortMenu(event);&quot;</span>
<a href="#l30.187"></a><span id="l30.187" class="difflineminus">-                         oncommand=&quot;ViewMenu.setSortColumn(event.target.column, null); event.stopPropagation();&quot;&gt;</span>
<a href="#l30.188"></a><span id="l30.188" class="difflineplus">+                         oncommand=&quot;ViewMenu.setSortColumn(event.target.column, null);&quot;&gt;</span>
<a href="#l30.189"></a><span id="l30.189">                 &lt;menuitem id=&quot;viewUnsorted&quot; type=&quot;radio&quot; name=&quot;columns&quot;</span>
<a href="#l30.190"></a><span id="l30.190">                           label=&quot;&amp;view.unsorted.label;&quot; accesskey=&quot;&amp;view.unsorted.accesskey;&quot;</span>
<a href="#l30.191"></a><span id="l30.191">                           oncommand=&quot;ViewMenu.setSortColumn(null, null);&quot;/&gt;</span>
<a href="#l30.192"></a><span id="l30.192">                 &lt;menuseparator id=&quot;directionSeparator&quot;/&gt;</span>
<a href="#l30.193"></a><span id="l30.193">                 &lt;menuitem id=&quot;viewSortAscending&quot; type=&quot;radio&quot; name=&quot;direction&quot;</span>
<a href="#l30.194"></a><span id="l30.194">                           label=&quot;&amp;view.sortAscending.label;&quot; accesskey=&quot;&amp;view.sortAscending.accesskey;&quot;</span>
<a href="#l30.195"></a><span id="l30.195">                           oncommand=&quot;ViewMenu.setSortColumn(null, 'ascending'); event.stopPropagation();&quot;/&gt;</span>
<a href="#l30.196"></a><span id="l30.196">                 &lt;menuitem id=&quot;viewSortDescending&quot; type=&quot;radio&quot; name=&quot;direction&quot;</span>
<a href="#l30.197"></a><span id="l30.197" class="difflineat">@@ -220,43 +204,34 @@</span>
<a href="#l30.198"></a><span id="l30.198">                           command=&quot;OrganizerCommand_restoreFromFile&quot;</span>
<a href="#l30.199"></a><span id="l30.199">                           label=&quot;&amp;cmd.restoreFromFile.label;&quot;</span>
<a href="#l30.200"></a><span id="l30.200">                           accesskey=&quot;&amp;cmd.restoreFromFile.accesskey;&quot;/&gt;</span>
<a href="#l30.201"></a><span id="l30.201">               &lt;/menupopup&gt;</span>
<a href="#l30.202"></a><span id="l30.202">             &lt;/menu&gt;</span>
<a href="#l30.203"></a><span id="l30.203">             &lt;menuseparator/&gt;</span>
<a href="#l30.204"></a><span id="l30.204">             &lt;menuitem id=&quot;fileImport&quot;</span>
<a href="#l30.205"></a><span id="l30.205">                       command=&quot;OrganizerCommand_import&quot;</span>
<a href="#l30.206"></a><span id="l30.206" class="difflineminus">-                      label=&quot;&amp;cmd.importHTML.label;&quot;</span>
<a href="#l30.207"></a><span id="l30.207" class="difflineminus">-                      accesskey=&quot;&amp;cmd.importHTML.accesskey;&quot;/&gt;</span>
<a href="#l30.208"></a><span id="l30.208" class="difflineplus">+                      label=&quot;&amp;importBookmarksFromHTML.label;&quot;</span>
<a href="#l30.209"></a><span id="l30.209" class="difflineplus">+                      accesskey=&quot;&amp;importBookmarksFromHTML.accesskey;&quot;/&gt;</span>
<a href="#l30.210"></a><span id="l30.210">             &lt;menuitem id=&quot;fileExport&quot;</span>
<a href="#l30.211"></a><span id="l30.211">                       command=&quot;OrganizerCommand_export&quot;</span>
<a href="#l30.212"></a><span id="l30.212" class="difflineminus">-                      label=&quot;&amp;cmd.exportHTML.label;&quot;</span>
<a href="#l30.213"></a><span id="l30.213" class="difflineminus">-                      accesskey=&quot;&amp;cmd.exportHTML.accesskey;&quot;/&gt;</span>
<a href="#l30.214"></a><span id="l30.214" class="difflineplus">+                      label=&quot;&amp;exportBookmarksToHTML.label;&quot;</span>
<a href="#l30.215"></a><span id="l30.215" class="difflineplus">+                      accesskey=&quot;&amp;exportBookmarksToHTML.accesskey;&quot;/&gt;</span>
<a href="#l30.216"></a><span id="l30.216">             &lt;menuseparator/&gt;</span>
<a href="#l30.217"></a><span id="l30.217">           &lt;/menupopup&gt;</span>
<a href="#l30.218"></a><span id="l30.218">         &lt;/menu&gt;</span>
<a href="#l30.219"></a><span id="l30.219"> </span>
<a href="#l30.220"></a><span id="l30.220">         &lt;!-- window menu filled from tasksOverlay --&gt;</span>
<a href="#l30.221"></a><span id="l30.221">         &lt;menu id=&quot;windowMenu&quot;/&gt;</span>
<a href="#l30.222"></a><span id="l30.222"> </span>
<a href="#l30.223"></a><span id="l30.223">         &lt;!-- help menu filled from globalOverlay --&gt;</span>
<a href="#l30.224"></a><span id="l30.224">         &lt;menu id=&quot;menu_Help&quot;/&gt;</span>
<a href="#l30.225"></a><span id="l30.225">       &lt;/menubar&gt;</span>
<a href="#l30.226"></a><span id="l30.226"> </span>
<a href="#l30.227"></a><span id="l30.227" class="difflineminus">-      &lt;toolbarspring/&gt;</span>
<a href="#l30.228"></a><span id="l30.228" class="difflineminus">-      &lt;toolbarbutton id=&quot;back-button&quot; class=&quot;toolbarbutton-1 chromeclass-toolbar-additional&quot;</span>
<a href="#l30.229"></a><span id="l30.229" class="difflineminus">-                     command=&quot;OrganizerCommand:Back&quot;</span>
<a href="#l30.230"></a><span id="l30.230" class="difflineminus">-                     tooltiptext=&quot;&amp;backButton.tooltip;&quot;</span>
<a href="#l30.231"></a><span id="l30.231" class="difflineminus">-                     disabled=&quot;true&quot;/&gt;</span>
<a href="#l30.232"></a><span id="l30.232" class="difflineminus">-</span>
<a href="#l30.233"></a><span id="l30.233" class="difflineminus">-      &lt;toolbarbutton id=&quot;forward-button&quot; class=&quot;toolbarbutton-1 chromeclass-toolbar-additional&quot;</span>
<a href="#l30.234"></a><span id="l30.234" class="difflineminus">-                     command=&quot;OrganizerCommand:Forward&quot;</span>
<a href="#l30.235"></a><span id="l30.235" class="difflineminus">-                     tooltiptext=&quot;&amp;forwardButton.tooltip;&quot;</span>
<a href="#l30.236"></a><span id="l30.236" class="difflineminus">-                     disabled=&quot;true&quot;/&gt;</span>
<a href="#l30.237"></a><span id="l30.237" class="difflineplus">+      &lt;toolbarspring id=&quot;toolbar-spacer&quot;/&gt;</span>
<a href="#l30.238"></a><span id="l30.238"> </span>
<a href="#l30.239"></a><span id="l30.239">       &lt;textbox id=&quot;searchFilter&quot;</span>
<a href="#l30.240"></a><span id="l30.240">                clickSelectsAll=&quot;true&quot;</span>
<a href="#l30.241"></a><span id="l30.241">                type=&quot;search&quot;</span>
<a href="#l30.242"></a><span id="l30.242">                aria-controls=&quot;placeContent&quot;</span>
<a href="#l30.243"></a><span id="l30.243">                oncommand=&quot;PlacesSearchBox.search(this.value);&quot;</span>
<a href="#l30.244"></a><span id="l30.244">                collection=&quot;bookmarks&quot;&gt;</span>
<a href="#l30.245"></a><span id="l30.245">       &lt;/textbox&gt;</span>
<a href="#l30.246"></a><span id="l30.246" class="difflineat">@@ -266,132 +241,101 @@</span>
<a href="#l30.247"></a><span id="l30.247">   &lt;hbox flex=&quot;1&quot; id=&quot;placesView&quot;&gt;</span>
<a href="#l30.248"></a><span id="l30.248">     &lt;tree id=&quot;placesList&quot;</span>
<a href="#l30.249"></a><span id="l30.249">           class=&quot;plain placesTree&quot;</span>
<a href="#l30.250"></a><span id="l30.250">           type=&quot;places&quot;</span>
<a href="#l30.251"></a><span id="l30.251">           hidecolumnpicker=&quot;true&quot;</span>
<a href="#l30.252"></a><span id="l30.252">           treelines=&quot;true&quot;</span>
<a href="#l30.253"></a><span id="l30.253">           context=&quot;placesContext&quot;</span>
<a href="#l30.254"></a><span id="l30.254">           onselect=&quot;PlacesOrganizer.onPlaceSelected(true);&quot;</span>
<a href="#l30.255"></a><span id="l30.255" class="difflineminus">-          onclick=&quot;PlacesOrganizer.onTreeClick(event);&quot;</span>
<a href="#l30.256"></a><span id="l30.256" class="difflineminus">-          onfocus=&quot;PlacesOrganizer.onTreeFocus(event);&quot;</span>
<a href="#l30.257"></a><span id="l30.257" class="difflineplus">+          onclick=&quot;PlacesOrganizer.onPlacesListClick(event);&quot;</span>
<a href="#l30.258"></a><span id="l30.258" class="difflineplus">+          onfocus=&quot;PlacesOrganizer.updateDetailsPane(event);&quot;</span>
<a href="#l30.259"></a><span id="l30.259">           seltype=&quot;single&quot;</span>
<a href="#l30.260"></a><span id="l30.260">           persist=&quot;width&quot;</span>
<a href="#l30.261"></a><span id="l30.261">           width=&quot;200&quot;</span>
<a href="#l30.262"></a><span id="l30.262">           minwidth=&quot;100&quot;</span>
<a href="#l30.263"></a><span id="l30.263">           maxwidth=&quot;400&quot;&gt;</span>
<a href="#l30.264"></a><span id="l30.264">       &lt;treecols&gt;</span>
<a href="#l30.265"></a><span id="l30.265">         &lt;treecol anonid=&quot;title&quot; flex=&quot;1&quot; primary=&quot;true&quot; hideheader=&quot;true&quot;/&gt;</span>
<a href="#l30.266"></a><span id="l30.266">       &lt;/treecols&gt;</span>
<a href="#l30.267"></a><span id="l30.267">       &lt;treechildren flex=&quot;1&quot;/&gt;</span>
<a href="#l30.268"></a><span id="l30.268">     &lt;/tree&gt;</span>
<a href="#l30.269"></a><span id="l30.269" class="difflineminus">-    &lt;splitter id=&quot;placesList-splitter&quot;</span>
<a href="#l30.270"></a><span id="l30.270" class="difflineminus">-              collapse=&quot;before&quot;</span>
<a href="#l30.271"></a><span id="l30.271" class="difflineminus">-              persist=&quot;state collapsed&quot;&gt;</span>
<a href="#l30.272"></a><span id="l30.272" class="difflineminus">-      &lt;grippy/&gt;</span>
<a href="#l30.273"></a><span id="l30.273" class="difflineminus">-    &lt;/splitter&gt;</span>
<a href="#l30.274"></a><span id="l30.274" class="difflineminus">-    &lt;vbox id=&quot;contentView&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l30.275"></a><span id="l30.275" class="difflineminus">-      &lt;toolbox id=&quot;searchModifiers&quot; hidden=&quot;true&quot;&gt;</span>
<a href="#l30.276"></a><span id="l30.276" class="difflineminus">-        &lt;toolbar id=&quot;organizerScopeBar&quot; xpfe=&quot;false&quot;</span>
<a href="#l30.277"></a><span id="l30.277" class="difflineminus">-                 class=&quot;chromeclass-toolbar&quot; align=&quot;center&quot;&gt;</span>
<a href="#l30.278"></a><span id="l30.278" class="difflineminus">-          &lt;label id=&quot;scopeBarTitle&quot; value=&quot;&amp;search.in.label;&quot;/&gt;</span>
<a href="#l30.279"></a><span id="l30.279" class="difflineminus">-          &lt;button id=&quot;scopeBarAll&quot; class=&quot;small-margin&quot;</span>
<a href="#l30.280"></a><span id="l30.280" class="difflineminus">-                  type=&quot;radio&quot; group=&quot;scopeBar&quot;</span>
<a href="#l30.281"></a><span id="l30.281" class="difflineminus">-                  oncommand=&quot;PlacesQueryBuilder.onScopeSelected(this);&quot;</span>
<a href="#l30.282"></a><span id="l30.282" class="difflineminus">-                  label=&quot;&amp;search.scopeBookmarks.label;&quot;</span>
<a href="#l30.283"></a><span id="l30.283" class="difflineminus">-                  accesskey=&quot;&amp;search.scopeBookmarks.accesskey;&quot;/&gt;</span>
<a href="#l30.284"></a><span id="l30.284" class="difflineminus">-          &lt;button id=&quot;scopeBarFolder&quot; class=&quot;small-margin&quot;</span>
<a href="#l30.285"></a><span id="l30.285" class="difflineminus">-                  type=&quot;radio&quot; group=&quot;scopeBar&quot;</span>
<a href="#l30.286"></a><span id="l30.286" class="difflineminus">-                  oncommand=&quot;PlacesQueryBuilder.onScopeSelected(this);&quot;</span>
<a href="#l30.287"></a><span id="l30.287" class="difflineminus">-                  accesskey=&quot;&amp;search.scopeFolder.accesskey;&quot;</span>
<a href="#l30.288"></a><span id="l30.288" class="difflineminus">-                  emptytitle=&quot;&amp;search.scopeFolder.label;&quot; flex=&quot;1&quot;/&gt;</span>
<a href="#l30.289"></a><span id="l30.289" class="difflineminus">-          &lt;!-- The folder scope button should flex but not take up more room</span>
<a href="#l30.290"></a><span id="l30.290" class="difflineminus">-                than its label needs.  The only simple way to do that is to</span>
<a href="#l30.291"></a><span id="l30.291" class="difflineminus">-                set a really big flex on the spacer, e.g., 2^31 - 1. --&gt;</span>
<a href="#l30.292"></a><span id="l30.292" class="difflineminus">-          &lt;spacer flex=&quot;2147483647&quot;/&gt;</span>
<a href="#l30.293"></a><span id="l30.293" class="difflineminus">-          &lt;button id=&quot;saveSearch&quot; class=&quot;small-margin&quot;</span>
<a href="#l30.294"></a><span id="l30.294" class="difflineminus">-                  label=&quot;&amp;saveSearch.label;&quot; accesskey=&quot;&amp;saveSearch.accesskey;&quot;</span>
<a href="#l30.295"></a><span id="l30.295" class="difflineminus">-                  command=&quot;OrganizerCommand_search:save&quot;/&gt;</span>
<a href="#l30.296"></a><span id="l30.296" class="difflineminus">-        &lt;/toolbar&gt;</span>
<a href="#l30.297"></a><span id="l30.297" class="difflineminus">-      &lt;/toolbox&gt;</span>
<a href="#l30.298"></a><span id="l30.298" class="difflineminus">-      &lt;tree id=&quot;placeContent&quot;</span>
<a href="#l30.299"></a><span id="l30.299" class="difflineminus">-            class=&quot;plain placesTree&quot;</span>
<a href="#l30.300"></a><span id="l30.300" class="difflineminus">-            treelines=&quot;true&quot;</span>
<a href="#l30.301"></a><span id="l30.301" class="difflineminus">-            context=&quot;placesContext&quot;</span>
<a href="#l30.302"></a><span id="l30.302" class="difflineminus">-            flex=&quot;1&quot;</span>
<a href="#l30.303"></a><span id="l30.303" class="difflineminus">-            type=&quot;places&quot;</span>
<a href="#l30.304"></a><span id="l30.304" class="difflineminus">-            enableColumnDrag=&quot;true&quot;</span>
<a href="#l30.305"></a><span id="l30.305" class="difflineminus">-            onkeypress=&quot;if (event.keyCode == KeyEvent.DOM_VK_RETURN) PlacesOrganizer.openSelectedNode(event);&quot;</span>
<a href="#l30.306"></a><span id="l30.306" class="difflineminus">-            onopenflatcontainer=&quot;PlacesOrganizer.openFlatContainer(aContainer);&quot;</span>
<a href="#l30.307"></a><span id="l30.307" class="difflineminus">-            onselect=&quot;PlacesOrganizer.onContentTreeSelect();&quot;</span>
<a href="#l30.308"></a><span id="l30.308" class="difflineminus">-            onfocus=&quot;PlacesOrganizer.onTreeFocus(event);&quot;</span>
<a href="#l30.309"></a><span id="l30.309" class="difflineminus">-            onclick=&quot;PlacesOrganizer.onTreeClick(event);&quot;&gt;</span>
<a href="#l30.310"></a><span id="l30.310" class="difflineminus">-        &lt;treecols id=&quot;placeContentColumns&quot; context=&quot;placesColumnsContext&quot;&gt;</span>
<a href="#l30.311"></a><span id="l30.311" class="difflineminus">-          &lt;treecol label=&quot;&amp;col.title.label;&quot; id=&quot;placesContentTitle&quot; anonid=&quot;title&quot; flex=&quot;5&quot; primary=&quot;true&quot;</span>
<a href="#l30.312"></a><span id="l30.312" class="difflineminus">-                    persist=&quot;width hidden ordinal sortActive sortDirection&quot;/&gt;</span>
<a href="#l30.313"></a><span id="l30.313" class="difflineminus">-          &lt;splitter class=&quot;tree-splitter&quot;/&gt;</span>
<a href="#l30.314"></a><span id="l30.314" class="difflineminus">-          &lt;treecol label=&quot;&amp;col.tags.label;&quot; id=&quot;placesContentTags&quot; anonid=&quot;tags&quot; flex=&quot;2&quot;</span>
<a href="#l30.315"></a><span id="l30.315" class="difflineminus">-                    persist=&quot;width hidden ordinal sortActive sortDirection&quot;/&gt;</span>
<a href="#l30.316"></a><span id="l30.316" class="difflineminus">-          &lt;splitter class=&quot;tree-splitter&quot;/&gt;</span>
<a href="#l30.317"></a><span id="l30.317" class="difflineminus">-          &lt;treecol label=&quot;&amp;col.url.label;&quot; id=&quot;placesContentUrl&quot; anonid=&quot;url&quot; flex=&quot;5&quot;</span>
<a href="#l30.318"></a><span id="l30.318" class="difflineminus">-                    persist=&quot;width hidden ordinal sortActive sortDirection&quot;/&gt;</span>
<a href="#l30.319"></a><span id="l30.319" class="difflineminus">-          &lt;splitter class=&quot;tree-splitter&quot;/&gt;</span>
<a href="#l30.320"></a><span id="l30.320" class="difflineminus">-          &lt;treecol label=&quot;&amp;col.lastvisit.label;&quot; id=&quot;placesContentDate&quot; anonid=&quot;date&quot; flex=&quot;1&quot; hidden=&quot;true&quot;</span>
<a href="#l30.321"></a><span id="l30.321" class="difflineminus">-                    persist=&quot;width hidden ordinal sortActive sortDirection&quot;/&gt;</span>
<a href="#l30.322"></a><span id="l30.322" class="difflineminus">-          &lt;splitter class=&quot;tree-splitter&quot;/&gt;</span>
<a href="#l30.323"></a><span id="l30.323" class="difflineminus">-          &lt;treecol label=&quot;&amp;col.visitcount.label;&quot; id=&quot;placesContentVisitCount&quot; anonid=&quot;visitCount&quot; flex=&quot;1&quot; hidden=&quot;true&quot;</span>
<a href="#l30.324"></a><span id="l30.324" class="difflineminus">-                    persist=&quot;width hidden ordinal sortActive sortDirection&quot;/&gt;</span>
<a href="#l30.325"></a><span id="l30.325" class="difflineminus">-          &lt;splitter class=&quot;tree-splitter&quot;/&gt;</span>
<a href="#l30.326"></a><span id="l30.326" class="difflineminus">-          &lt;treecol label=&quot;&amp;col.keyword.label;&quot; id=&quot;placesContentKeyword&quot; anonid=&quot;keyword&quot; flex=&quot;1&quot; hidden=&quot;true&quot;</span>
<a href="#l30.327"></a><span id="l30.327" class="difflineminus">-                    persist=&quot;width hidden ordinal sortActive sortDirection&quot;/&gt;</span>
<a href="#l30.328"></a><span id="l30.328" class="difflineminus">-          &lt;splitter class=&quot;tree-splitter&quot;/&gt;</span>
<a href="#l30.329"></a><span id="l30.329" class="difflineminus">-          &lt;treecol label=&quot;&amp;col.description.label;&quot; id=&quot;placesContentDescription&quot; anonid=&quot;description&quot; flex=&quot;1&quot; hidden=&quot;true&quot;</span>
<a href="#l30.330"></a><span id="l30.330" class="difflineminus">-                    persist=&quot;width hidden ordinal sortActive sortDirection&quot;/&gt;</span>
<a href="#l30.331"></a><span id="l30.331" class="difflineminus">-          &lt;splitter class=&quot;tree-splitter&quot;/&gt;</span>
<a href="#l30.332"></a><span id="l30.332" class="difflineminus">-          &lt;treecol label=&quot;&amp;col.dateadded.label;&quot; id=&quot;placesContentDateAdded&quot; anonid=&quot;dateAdded&quot; flex=&quot;1&quot; hidden=&quot;true&quot;</span>
<a href="#l30.333"></a><span id="l30.333" class="difflineminus">-                    persist=&quot;width hidden ordinal sortActive sortDirection&quot;/&gt;</span>
<a href="#l30.334"></a><span id="l30.334" class="difflineminus">-          &lt;splitter class=&quot;tree-splitter&quot;/&gt;</span>
<a href="#l30.335"></a><span id="l30.335" class="difflineminus">-          &lt;treecol label=&quot;&amp;col.lastmodified.label;&quot; id=&quot;placesContentLastModified&quot; anonid=&quot;lastModified&quot; flex=&quot;1&quot; hidden=&quot;true&quot;</span>
<a href="#l30.336"></a><span id="l30.336" class="difflineminus">-                    persist=&quot;width hidden ordinal sortActive sortDirection&quot;/&gt;</span>
<a href="#l30.337"></a><span id="l30.337" class="difflineminus">-        &lt;/treecols&gt;</span>
<a href="#l30.338"></a><span id="l30.338" class="difflineminus">-        &lt;treechildren flex=&quot;1&quot;/&gt;</span>
<a href="#l30.339"></a><span id="l30.339" class="difflineminus">-      &lt;/tree&gt;</span>
<a href="#l30.340"></a><span id="l30.340" class="difflineminus">-      &lt;splitter id=&quot;detailsDeck-splitter&quot;</span>
<a href="#l30.341"></a><span id="l30.341" class="difflineminus">-                collapse=&quot;after&quot;</span>
<a href="#l30.342"></a><span id="l30.342" class="difflineminus">-                persist=&quot;state collapsed&quot;</span>
<a href="#l30.343"></a><span id="l30.343" class="difflineminus">-                disabled=&quot;true&quot;&gt;</span>
<a href="#l30.344"></a><span id="l30.344" class="difflineminus">-        &lt;grippy/&gt;</span>
<a href="#l30.345"></a><span id="l30.345" class="difflineminus">-      &lt;/splitter&gt;</span>
<a href="#l30.346"></a><span id="l30.346" class="difflineplus">+    &lt;splitter collapse=&quot;none&quot; persist=&quot;state&quot;&gt;&lt;/splitter&gt;</span>
<a href="#l30.347"></a><span id="l30.347" class="difflineplus">+    &lt;vbox id=&quot;contentView&quot; flex=&quot;4&quot;&gt;</span>
<a href="#l30.348"></a><span id="l30.348" class="difflineplus">+      &lt;deck id=&quot;placesViewsDeck&quot;</span>
<a href="#l30.349"></a><span id="l30.349" class="difflineplus">+            selectedIndex=&quot;0&quot;</span>
<a href="#l30.350"></a><span id="l30.350" class="difflineplus">+            flex=&quot;1&quot;&gt;</span>
<a href="#l30.351"></a><span id="l30.351" class="difflineplus">+        &lt;tree id=&quot;placeContent&quot;</span>
<a href="#l30.352"></a><span id="l30.352" class="difflineplus">+              class=&quot;plain placesTree&quot;</span>
<a href="#l30.353"></a><span id="l30.353" class="difflineplus">+              treelines=&quot;true&quot;</span>
<a href="#l30.354"></a><span id="l30.354" class="difflineplus">+              context=&quot;placesContext&quot;</span>
<a href="#l30.355"></a><span id="l30.355" class="difflineplus">+              hidecolumnpicker=&quot;true&quot;</span>
<a href="#l30.356"></a><span id="l30.356" class="difflineplus">+              flex=&quot;1&quot;</span>
<a href="#l30.357"></a><span id="l30.357" class="difflineplus">+              type=&quot;places&quot;</span>
<a href="#l30.358"></a><span id="l30.358" class="difflineplus">+              flatList=&quot;true&quot;</span>
<a href="#l30.359"></a><span id="l30.359" class="difflineplus">+              selectfirstnode=&quot;true&quot;</span>
<a href="#l30.360"></a><span id="l30.360" class="difflineplus">+              enableColumnDrag=&quot;true&quot;</span>
<a href="#l30.361"></a><span id="l30.361" class="difflineplus">+              onfocus=&quot;PlacesOrganizer.updateDetailsPane(event)&quot;</span>
<a href="#l30.362"></a><span id="l30.362" class="difflineplus">+              onselect=&quot;PlacesOrganizer.updateDetailsPane(event)&quot;</span>
<a href="#l30.363"></a><span id="l30.363" class="difflineplus">+              onkeypress=&quot;ContentTree.onKeyPress(event);&quot;</span>
<a href="#l30.364"></a><span id="l30.364" class="difflineplus">+              onopenflatcontainer=&quot;PlacesOrganizer.openFlatContainer(aContainer);&quot;&gt;</span>
<a href="#l30.365"></a><span id="l30.365" class="difflineplus">+          &lt;treecols id=&quot;placeContentColumns&quot; context=&quot;placesColumnsContext&quot;&gt;</span>
<a href="#l30.366"></a><span id="l30.366" class="difflineplus">+            &lt;treecol label=&quot;&amp;col.name.label;&quot; id=&quot;placesContentTitle&quot; anonid=&quot;title&quot; flex=&quot;5&quot; primary=&quot;true&quot; ordinal=&quot;1&quot;</span>
<a href="#l30.367"></a><span id="l30.367" class="difflineplus">+                      persist=&quot;width hidden ordinal sortActive sortDirection&quot;/&gt;</span>
<a href="#l30.368"></a><span id="l30.368" class="difflineplus">+            &lt;splitter class=&quot;tree-splitter&quot;/&gt;</span>
<a href="#l30.369"></a><span id="l30.369" class="difflineplus">+            &lt;treecol label=&quot;&amp;col.tags.label;&quot; id=&quot;placesContentTags&quot; anonid=&quot;tags&quot; flex=&quot;2&quot;</span>
<a href="#l30.370"></a><span id="l30.370" class="difflineplus">+                      persist=&quot;width hidden ordinal sortActive sortDirection&quot;/&gt;</span>
<a href="#l30.371"></a><span id="l30.371" class="difflineplus">+            &lt;splitter class=&quot;tree-splitter&quot;/&gt;</span>
<a href="#l30.372"></a><span id="l30.372" class="difflineplus">+            &lt;treecol label=&quot;&amp;col.url.label;&quot; id=&quot;placesContentUrl&quot; anonid=&quot;url&quot; flex=&quot;5&quot;</span>
<a href="#l30.373"></a><span id="l30.373" class="difflineplus">+                      persist=&quot;width hidden ordinal sortActive sortDirection&quot;/&gt;</span>
<a href="#l30.374"></a><span id="l30.374" class="difflineplus">+            &lt;splitter class=&quot;tree-splitter&quot;/&gt;</span>
<a href="#l30.375"></a><span id="l30.375" class="difflineplus">+            &lt;treecol label=&quot;&amp;col.mostrecentvisit.label;&quot; id=&quot;placesContentDate&quot; anonid=&quot;date&quot; flex=&quot;1&quot; hidden=&quot;true&quot;</span>
<a href="#l30.376"></a><span id="l30.376" class="difflineplus">+                      persist=&quot;width hidden ordinal sortActive sortDirection&quot;/&gt;</span>
<a href="#l30.377"></a><span id="l30.377" class="difflineplus">+            &lt;splitter class=&quot;tree-splitter&quot;/&gt;</span>
<a href="#l30.378"></a><span id="l30.378" class="difflineplus">+            &lt;treecol label=&quot;&amp;col.visitcount.label;&quot; id=&quot;placesContentVisitCount&quot; anonid=&quot;visitCount&quot; flex=&quot;1&quot; hidden=&quot;true&quot;</span>
<a href="#l30.379"></a><span id="l30.379" class="difflineplus">+                      persist=&quot;width hidden ordinal sortActive sortDirection&quot;/&gt;</span>
<a href="#l30.380"></a><span id="l30.380" class="difflineplus">+            &lt;splitter class=&quot;tree-splitter&quot;/&gt;</span>
<a href="#l30.381"></a><span id="l30.381" class="difflineplus">+            &lt;treecol label=&quot;&amp;col.description.label;&quot; id=&quot;placesContentDescription&quot; anonid=&quot;description&quot; flex=&quot;1&quot; hidden=&quot;true&quot;</span>
<a href="#l30.382"></a><span id="l30.382" class="difflineplus">+                      persist=&quot;width hidden ordinal sortActive sortDirection&quot;/&gt;</span>
<a href="#l30.383"></a><span id="l30.383" class="difflineplus">+            &lt;splitter class=&quot;tree-splitter&quot;/&gt;</span>
<a href="#l30.384"></a><span id="l30.384" class="difflineplus">+            &lt;treecol label=&quot;&amp;col.dateadded.label;&quot; id=&quot;placesContentDateAdded&quot; anonid=&quot;dateAdded&quot; flex=&quot;1&quot; hidden=&quot;true&quot;</span>
<a href="#l30.385"></a><span id="l30.385" class="difflineplus">+                      persist=&quot;width hidden ordinal sortActive sortDirection&quot;/&gt;</span>
<a href="#l30.386"></a><span id="l30.386" class="difflineplus">+            &lt;splitter class=&quot;tree-splitter&quot;/&gt;</span>
<a href="#l30.387"></a><span id="l30.387" class="difflineplus">+            &lt;treecol label=&quot;&amp;col.lastmodified.label;&quot; id=&quot;placesContentLastModified&quot; anonid=&quot;lastModified&quot; flex=&quot;1&quot; hidden=&quot;true&quot;</span>
<a href="#l30.388"></a><span id="l30.388" class="difflineplus">+                      persist=&quot;width hidden ordinal sortActive sortDirection&quot;/&gt;</span>
<a href="#l30.389"></a><span id="l30.389" class="difflineplus">+          &lt;/treecols&gt;</span>
<a href="#l30.390"></a><span id="l30.390" class="difflineplus">+          &lt;treechildren flex=&quot;1&quot; onclick=&quot;ContentTree.onClick(event);&quot;/&gt;</span>
<a href="#l30.391"></a><span id="l30.391" class="difflineplus">+        &lt;/tree&gt;</span>
<a href="#l30.392"></a><span id="l30.392" class="difflineplus">+      &lt;/deck&gt;</span>
<a href="#l30.393"></a><span id="l30.393">       &lt;deck id=&quot;detailsDeck&quot; style=&quot;height: 11em;&quot;&gt;</span>
<a href="#l30.394"></a><span id="l30.394">         &lt;vbox id=&quot;itemsCountBox&quot; align=&quot;center&quot;&gt;</span>
<a href="#l30.395"></a><span id="l30.395">           &lt;spacer flex=&quot;3&quot;/&gt;</span>
<a href="#l30.396"></a><span id="l30.396">           &lt;label id=&quot;itemsCountText&quot;/&gt;</span>
<a href="#l30.397"></a><span id="l30.397">           &lt;spacer flex=&quot;1&quot;/&gt;</span>
<a href="#l30.398"></a><span id="l30.398">           &lt;description id=&quot;selectItemDescription&quot;&gt;</span>
<a href="#l30.399"></a><span id="l30.399">               &amp;detailsPane.selectAnItemText.description;</span>
<a href="#l30.400"></a><span id="l30.400">           &lt;/description&gt;</span>
<a href="#l30.401"></a><span id="l30.401">           &lt;spacer flex=&quot;3&quot;/&gt;</span>
<a href="#l30.402"></a><span id="l30.402">         &lt;/vbox&gt;</span>
<a href="#l30.403"></a><span id="l30.403">         &lt;vbox id=&quot;infoBox&quot; minimal=&quot;true&quot;&gt;</span>
<a href="#l30.404"></a><span id="l30.404" class="difflineminus">-          &lt;vbox id=&quot;editBookmarkPanelContent&quot;/&gt;</span>
<a href="#l30.405"></a><span id="l30.405" class="difflineminus">-          &lt;spacer flex=&quot;1&quot;/&gt;</span>
<a href="#l30.406"></a><span id="l30.406" class="difflineplus">+          &lt;vbox id=&quot;editBookmarkPanelContent&quot; flex=&quot;1&quot;/&gt;</span>
<a href="#l30.407"></a><span id="l30.407">           &lt;hbox id=&quot;infoBoxExpanderWrapper&quot; align=&quot;center&quot;&gt;</span>
<a href="#l30.408"></a><span id="l30.408"> </span>
<a href="#l30.409"></a><span id="l30.409">             &lt;button type=&quot;image&quot; id=&quot;infoBoxExpander&quot;</span>
<a href="#l30.410"></a><span id="l30.410">                     class=&quot;expander-down&quot;</span>
<a href="#l30.411"></a><span id="l30.411" class="difflineminus">-                    accesskey=&quot;&amp;detailsPane.more.accesskey;&quot;</span>
<a href="#l30.412"></a><span id="l30.412">                     oncommand=&quot;PlacesOrganizer.toggleAdditionalInfoFields();&quot;</span>
<a href="#l30.413"></a><span id="l30.413">                     observes=&quot;paneElementsBroadcaster&quot;/&gt;</span>
<a href="#l30.414"></a><span id="l30.414"> </span>
<a href="#l30.415"></a><span id="l30.415">             &lt;label id=&quot;infoBoxExpanderLabel&quot;</span>
<a href="#l30.416"></a><span id="l30.416" class="difflineminus">-                    fewerlabel=&quot;&amp;detailsPane.fewer.label;&quot;</span>
<a href="#l30.417"></a><span id="l30.417" class="difflineminus">-                    feweraccesskey=&quot;&amp;detailsPane.fewer.accesskey;&quot;</span>
<a href="#l30.418"></a><span id="l30.418" class="difflineplus">+                    lesslabel=&quot;&amp;detailsPane.less.label;&quot;</span>
<a href="#l30.419"></a><span id="l30.419" class="difflineplus">+                    lessaccesskey=&quot;&amp;detailsPane.less.accesskey;&quot;</span>
<a href="#l30.420"></a><span id="l30.420">                     morelabel=&quot;&amp;detailsPane.more.label;&quot;</span>
<a href="#l30.421"></a><span id="l30.421">                     moreaccesskey=&quot;&amp;detailsPane.more.accesskey;&quot;</span>
<a href="#l30.422"></a><span id="l30.422">                     value=&quot;&amp;detailsPane.more.label;&quot;</span>
<a href="#l30.423"></a><span id="l30.423" class="difflineplus">+                    accesskey=&quot;&amp;detailsPane.more.accesskey;&quot;</span>
<a href="#l30.424"></a><span id="l30.424">                     control=&quot;infoBoxExpander&quot;/&gt;</span>
<a href="#l30.425"></a><span id="l30.425"> </span>
<a href="#l30.426"></a><span id="l30.426">           &lt;/hbox&gt;</span>
<a href="#l30.427"></a><span id="l30.427">         &lt;/vbox&gt;</span>
<a href="#l30.428"></a><span id="l30.428">       &lt;/deck&gt;</span>
<a href="#l30.429"></a><span id="l30.429">     &lt;/vbox&gt;</span>
<a href="#l30.430"></a><span id="l30.430">   &lt;/hbox&gt;</span>
<a href="#l30.431"></a><span id="l30.431"> &lt;/window&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l31.1"></a><span id="l31.1" class="difflineminus">--- a/suite/common/places/content/placesOverlay.xul</span>
<a href="#l31.2"></a><span id="l31.2" class="difflineplus">+++ b/suite/common/places/content/placesOverlay.xul</span>
<a href="#l31.3"></a><span id="l31.3" class="difflineat">@@ -1,127 +1,98 @@</span>
<a href="#l31.4"></a><span id="l31.4" class="difflineminus">-&lt;?xml version=&quot;1.0&quot;?&gt;</span>
<a href="#l31.5"></a><span id="l31.5" class="difflineminus">-</span>
<a href="#l31.6"></a><span id="l31.6"> &lt;!-- This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l31.7"></a><span id="l31.7">    - License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l31.8"></a><span id="l31.8">    - file, You can obtain one at http://mozilla.org/MPL/2.0/. --&gt;</span>
<a href="#l31.9"></a><span id="l31.9"> </span>
<a href="#l31.10"></a><span id="l31.10"> &lt;!DOCTYPE overlay [</span>
<a href="#l31.11"></a><span id="l31.11" class="difflineminus">-&lt;!ENTITY % placesDTD SYSTEM &quot;chrome://communicator/locale/bookmarks/places.dtd&quot;&gt;</span>
<a href="#l31.12"></a><span id="l31.12" class="difflineplus">+&lt;!ENTITY % placesDTD SYSTEM &quot;chrome://communicator/locale/places/places.dtd&quot;&gt;</span>
<a href="#l31.13"></a><span id="l31.13"> %placesDTD;</span>
<a href="#l31.14"></a><span id="l31.14"> &lt;!ENTITY % editMenuOverlayDTD SYSTEM &quot;chrome://global/locale/editMenuOverlay.dtd&quot;&gt;</span>
<a href="#l31.15"></a><span id="l31.15"> %editMenuOverlayDTD;</span>
<a href="#l31.16"></a><span id="l31.16"> ]&gt;</span>
<a href="#l31.17"></a><span id="l31.17"> </span>
<a href="#l31.18"></a><span id="l31.18"> &lt;overlay id=&quot;placesOverlay&quot;</span>
<a href="#l31.19"></a><span id="l31.19">          xmlns:rdf=&quot;http://www.w3.org/1999/02/22-rdf-syntax-ns#&quot;</span>
<a href="#l31.20"></a><span id="l31.20">          xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;&gt;</span>
<a href="#l31.21"></a><span id="l31.21"> </span>
<a href="#l31.22"></a><span id="l31.22">   &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l31.23"></a><span id="l31.23">           src=&quot;chrome://global/content/globalOverlay.js&quot;/&gt;</span>
<a href="#l31.24"></a><span id="l31.24">   &lt;script type=&quot;application/javascript&quot;&gt;&lt;![CDATA[</span>
<a href="#l31.25"></a><span id="l31.25" class="difflineplus">+    // TODO: Bug 406371.</span>
<a href="#l31.26"></a><span id="l31.26" class="difflineplus">+    // A bunch of browser code depends on us defining these, sad but true :(</span>
<a href="#l31.27"></a><span id="l31.27" class="difflineplus">+    var Cc = Cc;</span>
<a href="#l31.28"></a><span id="l31.28" class="difflineplus">+    var Ci = Ci;</span>
<a href="#l31.29"></a><span id="l31.29" class="difflineplus">+    var Cr = Cr;</span>
<a href="#l31.30"></a><span id="l31.30" class="difflineplus">+    var Cu = Cu;</span>
<a href="#l31.31"></a><span id="l31.31" class="difflineplus">+</span>
<a href="#l31.32"></a><span id="l31.32" class="difflineplus">+    ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l31.33"></a><span id="l31.33">     ChromeUtils.import(&quot;resource://gre/modules/PlacesUtils.jsm&quot;);</span>
<a href="#l31.34"></a><span id="l31.34" class="difflineminus">-    ChromeUtils.import(&quot;resource://gre/modules/PlacesBackups.jsm&quot;);</span>
<a href="#l31.35"></a><span id="l31.35" class="difflineminus">-    ChromeUtils.import(&quot;resource:///modules/PlacesUIUtils.jsm&quot;);</span>
<a href="#l31.36"></a><span id="l31.36" class="difflineplus">+    ChromeUtils.defineModuleGetter(window,</span>
<a href="#l31.37"></a><span id="l31.37" class="difflineplus">+      &quot;PlacesUIUtils&quot;, &quot;resource:///modules/PlacesUIUtils.jsm&quot;);</span>
<a href="#l31.38"></a><span id="l31.38" class="difflineplus">+    ChromeUtils.defineModuleGetter(window,</span>
<a href="#l31.39"></a><span id="l31.39" class="difflineplus">+      &quot;PlacesTransactions&quot;, &quot;resource://gre/modules/PlacesTransactions.jsm&quot;);</span>
<a href="#l31.40"></a><span id="l31.40">   ]]&gt;&lt;/script&gt;</span>
<a href="#l31.41"></a><span id="l31.41">   &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l31.42"></a><span id="l31.42">           src=&quot;chrome://communicator/content/places/controller.js&quot;/&gt;</span>
<a href="#l31.43"></a><span id="l31.43">   &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l31.44"></a><span id="l31.44">           src=&quot;chrome://communicator/content/places/treeView.js&quot;/&gt;</span>
<a href="#l31.45"></a><span id="l31.45"> </span>
<a href="#l31.46"></a><span id="l31.46">   &lt;!-- Bookmarks and history tooltip --&gt;</span>
<a href="#l31.47"></a><span id="l31.47">   &lt;tooltip id=&quot;bhTooltip&quot; noautohide=&quot;true&quot;</span>
<a href="#l31.48"></a><span id="l31.48">            onpopupshowing=&quot;return window.top.BookmarksEventHandler.fillInBHTooltip(document, event)&quot;&gt;</span>
<a href="#l31.49"></a><span id="l31.49">     &lt;vbox id=&quot;bhTooltipTextBox&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l31.50"></a><span id="l31.50">       &lt;label id=&quot;bhtTitleText&quot; class=&quot;tooltip-label&quot; /&gt;</span>
<a href="#l31.51"></a><span id="l31.51" class="difflineminus">-      &lt;label id=&quot;bhtUrlText&quot; crop=&quot;center&quot; class=&quot;tooltip-label&quot; /&gt;</span>
<a href="#l31.52"></a><span id="l31.52" class="difflineplus">+      &lt;label id=&quot;bhtUrlText&quot; crop=&quot;center&quot; class=&quot;tooltip-label uri-element&quot; /&gt;</span>
<a href="#l31.53"></a><span id="l31.53">     &lt;/vbox&gt;</span>
<a href="#l31.54"></a><span id="l31.54">   &lt;/tooltip&gt;</span>
<a href="#l31.55"></a><span id="l31.55"> </span>
<a href="#l31.56"></a><span id="l31.56">   &lt;commandset id=&quot;placesCommands&quot;</span>
<a href="#l31.57"></a><span id="l31.57">               commandupdater=&quot;true&quot;</span>
<a href="#l31.58"></a><span id="l31.58">               events=&quot;focus,sort,places&quot;</span>
<a href="#l31.59"></a><span id="l31.59">               oncommandupdate=&quot;goUpdatePlacesCommands();&quot;&gt;</span>
<a href="#l31.60"></a><span id="l31.60">     &lt;command id=&quot;placesCmd_open&quot;</span>
<a href="#l31.61"></a><span id="l31.61">              oncommand=&quot;goDoPlacesCommand('placesCmd_open');&quot;/&gt;</span>
<a href="#l31.62"></a><span id="l31.62" class="difflineminus">-    &lt;command id=&quot;placesCmd_open:tab&quot;</span>
<a href="#l31.63"></a><span id="l31.63" class="difflineminus">-             oncommand=&quot;goDoPlacesCommand('placesCmd_open:tab');&quot;/&gt;</span>
<a href="#l31.64"></a><span id="l31.64">     &lt;command id=&quot;placesCmd_open:window&quot;</span>
<a href="#l31.65"></a><span id="l31.65">              oncommand=&quot;goDoPlacesCommand('placesCmd_open:window');&quot;/&gt;</span>
<a href="#l31.66"></a><span id="l31.66">     &lt;command id=&quot;placesCmd_open:privatewindow&quot;</span>
<a href="#l31.67"></a><span id="l31.67">              oncommand=&quot;goDoPlacesCommand('placesCmd_open:privatewindow');&quot;/&gt;</span>
<a href="#l31.68"></a><span id="l31.68" class="difflineplus">+    &lt;command id=&quot;placesCmd_open:tab&quot;</span>
<a href="#l31.69"></a><span id="l31.69" class="difflineplus">+             oncommand=&quot;goDoPlacesCommand('placesCmd_open:tab');&quot;/&gt;</span>
<a href="#l31.70"></a><span id="l31.70"> </span>
<a href="#l31.71"></a><span id="l31.71">     &lt;command id=&quot;placesCmd_new:bookmark&quot;</span>
<a href="#l31.72"></a><span id="l31.72">              oncommand=&quot;goDoPlacesCommand('placesCmd_new:bookmark');&quot;/&gt;</span>
<a href="#l31.73"></a><span id="l31.73" class="difflineminus">-    &lt;command id=&quot;placesCmd_new:livemark&quot;</span>
<a href="#l31.74"></a><span id="l31.74" class="difflineminus">-             oncommand=&quot;goDoPlacesCommand('placesCmd_new:livemark');&quot;/&gt;</span>
<a href="#l31.75"></a><span id="l31.75">     &lt;command id=&quot;placesCmd_new:folder&quot;</span>
<a href="#l31.76"></a><span id="l31.76">              oncommand=&quot;goDoPlacesCommand('placesCmd_new:folder');&quot;/&gt;</span>
<a href="#l31.77"></a><span id="l31.77">     &lt;command id=&quot;placesCmd_new:separator&quot;</span>
<a href="#l31.78"></a><span id="l31.78">              oncommand=&quot;goDoPlacesCommand('placesCmd_new:separator');&quot;/&gt;</span>
<a href="#l31.79"></a><span id="l31.79">     &lt;command id=&quot;placesCmd_show:info&quot;</span>
<a href="#l31.80"></a><span id="l31.80">              oncommand=&quot;goDoPlacesCommand('placesCmd_show:info');&quot;/&gt;</span>
<a href="#l31.81"></a><span id="l31.81">     &lt;command id=&quot;placesCmd_rename&quot;</span>
<a href="#l31.82"></a><span id="l31.82">              oncommand=&quot;goDoPlacesCommand('placesCmd_show:info');&quot;</span>
<a href="#l31.83"></a><span id="l31.83">              observes=&quot;placesCmd_show:info&quot;/&gt;</span>
<a href="#l31.84"></a><span id="l31.84">     &lt;command id=&quot;placesCmd_reload&quot;</span>
<a href="#l31.85"></a><span id="l31.85">              oncommand=&quot;goDoPlacesCommand('placesCmd_reload');&quot;/&gt;</span>
<a href="#l31.86"></a><span id="l31.86">     &lt;command id=&quot;placesCmd_sortBy:name&quot;</span>
<a href="#l31.87"></a><span id="l31.87">              oncommand=&quot;goDoPlacesCommand('placesCmd_sortBy:name');&quot;/&gt;</span>
<a href="#l31.88"></a><span id="l31.88" class="difflineminus">-    &lt;command id=&quot;placesCmd_moveBookmarks&quot;</span>
<a href="#l31.89"></a><span id="l31.89" class="difflineminus">-             oncommand=&quot;goDoPlacesCommand('placesCmd_moveBookmarks');&quot;/&gt;</span>
<a href="#l31.90"></a><span id="l31.90">     &lt;command id=&quot;placesCmd_deleteDataHost&quot;</span>
<a href="#l31.91"></a><span id="l31.91">              oncommand=&quot;goDoPlacesCommand('placesCmd_deleteDataHost');&quot;/&gt;</span>
<a href="#l31.92"></a><span id="l31.92">     &lt;command id=&quot;placesCmd_createBookmark&quot;</span>
<a href="#l31.93"></a><span id="l31.93">              oncommand=&quot;goDoPlacesCommand('placesCmd_createBookmark');&quot;/&gt;</span>
<a href="#l31.94"></a><span id="l31.94"> </span>
<a href="#l31.95"></a><span id="l31.95">     &lt;!-- Special versions of cut/copy/paste/delete which check for an open context menu. --&gt;</span>
<a href="#l31.96"></a><span id="l31.96">     &lt;command id=&quot;placesCmd_cut&quot;</span>
<a href="#l31.97"></a><span id="l31.97">              oncommand=&quot;goDoPlacesCommand('placesCmd_cut');&quot;/&gt;</span>
<a href="#l31.98"></a><span id="l31.98">     &lt;command id=&quot;placesCmd_copy&quot;</span>
<a href="#l31.99"></a><span id="l31.99">              oncommand=&quot;goDoPlacesCommand('placesCmd_copy');&quot;/&gt;</span>
<a href="#l31.100"></a><span id="l31.100">     &lt;command id=&quot;placesCmd_paste&quot;</span>
<a href="#l31.101"></a><span id="l31.101">              oncommand=&quot;goDoPlacesCommand('placesCmd_paste');&quot;/&gt;</span>
<a href="#l31.102"></a><span id="l31.102">     &lt;command id=&quot;placesCmd_delete&quot;</span>
<a href="#l31.103"></a><span id="l31.103">              oncommand=&quot;goDoPlacesCommand('placesCmd_delete');&quot;/&gt;</span>
<a href="#l31.104"></a><span id="l31.104">   &lt;/commandset&gt;</span>
<a href="#l31.105"></a><span id="l31.105"> </span>
<a href="#l31.106"></a><span id="l31.106" class="difflineminus">-  &lt;panel id=&quot;editBookmarkPanel&quot;</span>
<a href="#l31.107"></a><span id="l31.107" class="difflineminus">-         type=&quot;arrow&quot;</span>
<a href="#l31.108"></a><span id="l31.108" class="difflineminus">-         animate=&quot;false&quot;</span>
<a href="#l31.109"></a><span id="l31.109" class="difflineminus">-         orient=&quot;vertical&quot;</span>
<a href="#l31.110"></a><span id="l31.110" class="difflineminus">-         ignorekeys=&quot;true&quot;</span>
<a href="#l31.111"></a><span id="l31.111" class="difflineminus">-         hidden=&quot;true&quot;</span>
<a href="#l31.112"></a><span id="l31.112" class="difflineminus">-         onpopupshown=&quot;StarUI.panelShown(event);&quot;</span>
<a href="#l31.113"></a><span id="l31.113" class="difflineminus">-         aria-labelledby=&quot;editBookmarkPanelTitle&quot;&gt;</span>
<a href="#l31.114"></a><span id="l31.114" class="difflineminus">-    &lt;row id=&quot;editBookmarkPanelHeader&quot; align=&quot;center&quot; hidden=&quot;true&quot;&gt;</span>
<a href="#l31.115"></a><span id="l31.115" class="difflineminus">-      &lt;vbox align=&quot;center&quot;&gt;</span>
<a href="#l31.116"></a><span id="l31.116" class="difflineminus">-        &lt;image id=&quot;editBookmarkPanelStarIcon&quot;/&gt;</span>
<a href="#l31.117"></a><span id="l31.117" class="difflineminus">-      &lt;/vbox&gt;</span>
<a href="#l31.118"></a><span id="l31.118" class="difflineminus">-      &lt;label id=&quot;editBookmarkPanelTitle&quot;/&gt;</span>
<a href="#l31.119"></a><span id="l31.119" class="difflineminus">-    &lt;/row&gt;</span>
<a href="#l31.120"></a><span id="l31.120" class="difflineminus">-    &lt;vbox id=&quot;editBookmarkPanelContent&quot; hidden=&quot;true&quot;/&gt;</span>
<a href="#l31.121"></a><span id="l31.121" class="difflineminus">-    &lt;hbox id=&quot;editBookmarkPanelBottomButtons&quot;&gt;</span>
<a href="#l31.122"></a><span id="l31.122" class="difflineminus">-      &lt;button id=&quot;editBookmarkPanelRemoveButton&quot;</span>
<a href="#l31.123"></a><span id="l31.123" class="difflineminus">-              class=&quot;editBookmarkPanelHeaderButton&quot;</span>
<a href="#l31.124"></a><span id="l31.124" class="difflineminus">-              oncommand=&quot;StarUI.removeBookmarkButtonCommand();&quot;</span>
<a href="#l31.125"></a><span id="l31.125" class="difflineminus">-              accesskey=&quot;&amp;editBookmark.removeBookmark.accessKey;&quot;/&gt;</span>
<a href="#l31.126"></a><span id="l31.126" class="difflineminus">-      &lt;spacer flex=&quot;1&quot;/&gt;</span>
<a href="#l31.127"></a><span id="l31.127" class="difflineminus">-      &lt;button id=&quot;editBookmarkPanelDeleteButton&quot;</span>
<a href="#l31.128"></a><span id="l31.128" class="difflineminus">-              class=&quot;editBookmarkPanelBottomButton&quot;</span>
<a href="#l31.129"></a><span id="l31.129" class="difflineminus">-              label=&quot;&amp;editBookmark.cancel.label;&quot;</span>
<a href="#l31.130"></a><span id="l31.130" class="difflineminus">-              oncommand=&quot;StarUI.cancelButtonOnCommand();&quot;/&gt;</span>
<a href="#l31.131"></a><span id="l31.131" class="difflineminus">-      &lt;button id=&quot;editBookmarkPanelDoneButton&quot;</span>
<a href="#l31.132"></a><span id="l31.132" class="difflineminus">-              class=&quot;editBookmarkPanelBottomButton&quot;</span>
<a href="#l31.133"></a><span id="l31.133" class="difflineminus">-              label=&quot;&amp;editBookmark.done.label;&quot;</span>
<a href="#l31.134"></a><span id="l31.134" class="difflineminus">-              default=&quot;true&quot;</span>
<a href="#l31.135"></a><span id="l31.135" class="difflineminus">-              oncommand=&quot;StarUI.panel.hidePopup();&quot;/&gt;</span>
<a href="#l31.136"></a><span id="l31.136" class="difflineminus">-    &lt;/hbox&gt;</span>
<a href="#l31.137"></a><span id="l31.137" class="difflineminus">-  &lt;/panel&gt;</span>
<a href="#l31.138"></a><span id="l31.138" class="difflineminus">-</span>
<a href="#l31.139"></a><span id="l31.139">   &lt;menupopup id=&quot;placesContext&quot;</span>
<a href="#l31.140"></a><span id="l31.140">              onpopupshowing=&quot;this._view = PlacesUIUtils.getViewForNode(document.popupNode);</span>
<a href="#l31.141"></a><span id="l31.141">                              return this._view.buildContextMenu(this);&quot;</span>
<a href="#l31.142"></a><span id="l31.142">              onpopuphiding=&quot;this._view.destroyContextMenu();&quot;&gt;</span>
<a href="#l31.143"></a><span id="l31.143">     &lt;menuitem id=&quot;placesContext_open&quot;</span>
<a href="#l31.144"></a><span id="l31.144">               command=&quot;placesCmd_open&quot;</span>
<a href="#l31.145"></a><span id="l31.145">               label=&quot;&amp;cmd.open.label;&quot;</span>
<a href="#l31.146"></a><span id="l31.146">               accesskey=&quot;&amp;cmd.open.accesskey;&quot;</span>
<a href="#l31.147"></a><span id="l31.147" class="difflineat">@@ -129,70 +100,68 @@</span>
<a href="#l31.148"></a><span id="l31.148">               selectiontype=&quot;single&quot;</span>
<a href="#l31.149"></a><span id="l31.149">               selection=&quot;link&quot;/&gt;</span>
<a href="#l31.150"></a><span id="l31.150">     &lt;menuitem id=&quot;placesContext_open:newtab&quot;</span>
<a href="#l31.151"></a><span id="l31.151">               command=&quot;placesCmd_open:tab&quot;</span>
<a href="#l31.152"></a><span id="l31.152">               label=&quot;&amp;cmd.open_tab.label;&quot;</span>
<a href="#l31.153"></a><span id="l31.153">               accesskey=&quot;&amp;cmd.open_tab.accesskey;&quot;</span>
<a href="#l31.154"></a><span id="l31.154">               selectiontype=&quot;single&quot;</span>
<a href="#l31.155"></a><span id="l31.155">               selection=&quot;link&quot;/&gt;</span>
<a href="#l31.156"></a><span id="l31.156" class="difflineminus">-    &lt;menuitem id=&quot;placesContext_open:newwindow&quot;</span>
<a href="#l31.157"></a><span id="l31.157" class="difflineminus">-              command=&quot;placesCmd_open:window&quot;</span>
<a href="#l31.158"></a><span id="l31.158" class="difflineminus">-              label=&quot;&amp;cmd.open_window.label;&quot;</span>
<a href="#l31.159"></a><span id="l31.159" class="difflineminus">-              accesskey=&quot;&amp;cmd.open_window.accesskey;&quot;</span>
<a href="#l31.160"></a><span id="l31.160" class="difflineminus">-              selectiontype=&quot;single&quot;</span>
<a href="#l31.161"></a><span id="l31.161" class="difflineminus">-              selection=&quot;link&quot;</span>
<a href="#l31.162"></a><span id="l31.162" class="difflineminus">-              hideifprivatebrowsing=&quot;true&quot;/&gt;</span>
<a href="#l31.163"></a><span id="l31.163" class="difflineminus">-    &lt;menuitem id=&quot;placesContext_open:newprivatewindow&quot;</span>
<a href="#l31.164"></a><span id="l31.164" class="difflineminus">-              command=&quot;placesCmd_open:privatewindow&quot;</span>
<a href="#l31.165"></a><span id="l31.165" class="difflineminus">-              label=&quot;&amp;cmd.open_private.label;&quot;</span>
<a href="#l31.166"></a><span id="l31.166" class="difflineminus">-              accesskey=&quot;&amp;cmd.open_private.accesskey;&quot;</span>
<a href="#l31.167"></a><span id="l31.167" class="difflineminus">-              selectiontype=&quot;single&quot;</span>
<a href="#l31.168"></a><span id="l31.168" class="difflineminus">-              selection=&quot;link&quot;/&gt;</span>
<a href="#l31.169"></a><span id="l31.169">     &lt;menuitem id=&quot;placesContext_openContainer:tabs&quot;</span>
<a href="#l31.170"></a><span id="l31.170">               oncommand=&quot;var view = PlacesUIUtils.getViewForNode(document.popupNode);</span>
<a href="#l31.171"></a><span id="l31.171">                          view.controller.openSelectionInTabs(event);&quot;</span>
<a href="#l31.172"></a><span id="l31.172">               onclick=&quot;checkForMiddleClick(this, event);&quot;</span>
<a href="#l31.173"></a><span id="l31.173">               label=&quot;&amp;cmd.open_all_in_tabs.label;&quot;</span>
<a href="#l31.174"></a><span id="l31.174">               accesskey=&quot;&amp;cmd.open_all_in_tabs.accesskey;&quot;</span>
<a href="#l31.175"></a><span id="l31.175" class="difflineminus">-              selectiontype=&quot;single&quot;</span>
<a href="#l31.176"></a><span id="l31.176" class="difflineplus">+              selectiontype=&quot;single|none&quot;</span>
<a href="#l31.177"></a><span id="l31.177">               selection=&quot;folder|host|query&quot;/&gt;</span>
<a href="#l31.178"></a><span id="l31.178">     &lt;menuitem id=&quot;placesContext_openLinks:tabs&quot;</span>
<a href="#l31.179"></a><span id="l31.179">               oncommand=&quot;var view = PlacesUIUtils.getViewForNode(document.popupNode);</span>
<a href="#l31.180"></a><span id="l31.180">                          view.controller.openSelectionInTabs(event);&quot;</span>
<a href="#l31.181"></a><span id="l31.181">               onclick=&quot;checkForMiddleClick(this, event);&quot;</span>
<a href="#l31.182"></a><span id="l31.182">               label=&quot;&amp;cmd.open_all_in_tabs.label;&quot;</span>
<a href="#l31.183"></a><span id="l31.183">               accesskey=&quot;&amp;cmd.open_all_in_tabs.accesskey;&quot;</span>
<a href="#l31.184"></a><span id="l31.184">               selectiontype=&quot;multiple&quot;</span>
<a href="#l31.185"></a><span id="l31.185">               selection=&quot;link&quot;/&gt;</span>
<a href="#l31.186"></a><span id="l31.186" class="difflineplus">+    &lt;menuitem id=&quot;placesContext_open:newwindow&quot;</span>
<a href="#l31.187"></a><span id="l31.187" class="difflineplus">+              command=&quot;placesCmd_open:window&quot;</span>
<a href="#l31.188"></a><span id="l31.188" class="difflineplus">+              label=&quot;&amp;cmd.open_window.label;&quot;</span>
<a href="#l31.189"></a><span id="l31.189" class="difflineplus">+              accesskey=&quot;&amp;cmd.open_window.accesskey;&quot;</span>
<a href="#l31.190"></a><span id="l31.190" class="difflineplus">+              selectiontype=&quot;single&quot;</span>
<a href="#l31.191"></a><span id="l31.191" class="difflineplus">+              selection=&quot;link&quot;/&gt;</span>
<a href="#l31.192"></a><span id="l31.192" class="difflineplus">+    &lt;menuitem id=&quot;placesContext_open:newprivatewindow&quot;</span>
<a href="#l31.193"></a><span id="l31.193" class="difflineplus">+              command=&quot;placesCmd_open:privatewindow&quot;</span>
<a href="#l31.194"></a><span id="l31.194" class="difflineplus">+              label=&quot;&amp;cmd.open_private_window.label;&quot;</span>
<a href="#l31.195"></a><span id="l31.195" class="difflineplus">+              accesskey=&quot;&amp;cmd.open_private_window.accesskey;&quot;</span>
<a href="#l31.196"></a><span id="l31.196" class="difflineplus">+              selectiontype=&quot;single&quot;</span>
<a href="#l31.197"></a><span id="l31.197" class="difflineplus">+              selection=&quot;link&quot;</span>
<a href="#l31.198"></a><span id="l31.198" class="difflineplus">+              hideifprivatebrowsing=&quot;true&quot;/&gt;</span>
<a href="#l31.199"></a><span id="l31.199">     &lt;menuseparator id=&quot;placesContext_openSeparator&quot;/&gt;</span>
<a href="#l31.200"></a><span id="l31.200">     &lt;menuitem id=&quot;placesContext_new:bookmark&quot;</span>
<a href="#l31.201"></a><span id="l31.201">               command=&quot;placesCmd_new:bookmark&quot;</span>
<a href="#l31.202"></a><span id="l31.202">               label=&quot;&amp;cmd.new_bookmark.label;&quot;</span>
<a href="#l31.203"></a><span id="l31.203">               accesskey=&quot;&amp;cmd.new_bookmark.accesskey;&quot;</span>
<a href="#l31.204"></a><span id="l31.204" class="difflineminus">-              selection=&quot;any&quot;</span>
<a href="#l31.205"></a><span id="l31.205" class="difflineplus">+              selectiontype=&quot;any&quot;</span>
<a href="#l31.206"></a><span id="l31.206">               hideifnoinsertionpoint=&quot;true&quot;/&gt;</span>
<a href="#l31.207"></a><span id="l31.207">     &lt;menuitem id=&quot;placesContext_new:folder&quot;</span>
<a href="#l31.208"></a><span id="l31.208">               command=&quot;placesCmd_new:folder&quot;</span>
<a href="#l31.209"></a><span id="l31.209">               label=&quot;&amp;cmd.new_folder.label;&quot;</span>
<a href="#l31.210"></a><span id="l31.210">               accesskey=&quot;&amp;cmd.context_new_folder.accesskey;&quot;</span>
<a href="#l31.211"></a><span id="l31.211" class="difflineminus">-              selection=&quot;any&quot;</span>
<a href="#l31.212"></a><span id="l31.212" class="difflineplus">+              selectiontype=&quot;any&quot;</span>
<a href="#l31.213"></a><span id="l31.213">               hideifnoinsertionpoint=&quot;true&quot;/&gt;</span>
<a href="#l31.214"></a><span id="l31.214">     &lt;menuitem id=&quot;placesContext_new:separator&quot;</span>
<a href="#l31.215"></a><span id="l31.215">               command=&quot;placesCmd_new:separator&quot;</span>
<a href="#l31.216"></a><span id="l31.216">               label=&quot;&amp;cmd.new_separator.label;&quot;</span>
<a href="#l31.217"></a><span id="l31.217">               accesskey=&quot;&amp;cmd.new_separator.accesskey;&quot;</span>
<a href="#l31.218"></a><span id="l31.218">               closemenu=&quot;single&quot;</span>
<a href="#l31.219"></a><span id="l31.219" class="difflineminus">-              selection=&quot;any&quot;</span>
<a href="#l31.220"></a><span id="l31.220" class="difflineplus">+              selectiontype=&quot;any&quot;</span>
<a href="#l31.221"></a><span id="l31.221">               hideifnoinsertionpoint=&quot;true&quot;/&gt;</span>
<a href="#l31.222"></a><span id="l31.222">     &lt;menuseparator id=&quot;placesContext_newSeparator&quot;/&gt;</span>
<a href="#l31.223"></a><span id="l31.223">     &lt;menuitem id=&quot;placesContext_createBookmark&quot;</span>
<a href="#l31.224"></a><span id="l31.224">               command=&quot;placesCmd_createBookmark&quot;</span>
<a href="#l31.225"></a><span id="l31.225" class="difflineminus">-              label=&quot;&amp;cmd.bookmarkLink.label;&quot;</span>
<a href="#l31.226"></a><span id="l31.226" class="difflineminus">-              accesskey=&quot;&amp;cmd.bookmarkLink.accesskey;&quot;</span>
<a href="#l31.227"></a><span id="l31.227">               selection=&quot;link&quot;</span>
<a href="#l31.228"></a><span id="l31.228">               forcehideselection=&quot;bookmark|tagChild&quot;/&gt;</span>
<a href="#l31.229"></a><span id="l31.229">     &lt;menuitem id=&quot;placesContext_cut&quot;</span>
<a href="#l31.230"></a><span id="l31.230">               command=&quot;placesCmd_cut&quot;</span>
<a href="#l31.231"></a><span id="l31.231">               label=&quot;&amp;cutCmd.label;&quot;</span>
<a href="#l31.232"></a><span id="l31.232">               accesskey=&quot;&amp;cutCmd.accesskey;&quot;</span>
<a href="#l31.233"></a><span id="l31.233">               closemenu=&quot;single&quot;</span>
<a href="#l31.234"></a><span id="l31.234">               selection=&quot;bookmark|folder|separator|query&quot;</span>
<a href="#l31.235"></a><span id="l31.235" class="difflineat">@@ -203,53 +172,52 @@</span>
<a href="#l31.236"></a><span id="l31.236">               closemenu=&quot;single&quot;</span>
<a href="#l31.237"></a><span id="l31.237">               accesskey=&quot;&amp;copyCmd.accesskey;&quot;</span>
<a href="#l31.238"></a><span id="l31.238">               selection=&quot;any&quot;/&gt;</span>
<a href="#l31.239"></a><span id="l31.239">     &lt;menuitem id=&quot;placesContext_paste&quot;</span>
<a href="#l31.240"></a><span id="l31.240">               command=&quot;placesCmd_paste&quot;</span>
<a href="#l31.241"></a><span id="l31.241">               label=&quot;&amp;pasteCmd.label;&quot;</span>
<a href="#l31.242"></a><span id="l31.242">               closemenu=&quot;single&quot;</span>
<a href="#l31.243"></a><span id="l31.243">               accesskey=&quot;&amp;pasteCmd.accesskey;&quot;</span>
<a href="#l31.244"></a><span id="l31.244" class="difflineminus">-              selection=&quot;any&quot;</span>
<a href="#l31.245"></a><span id="l31.245" class="difflineplus">+              selectiontype=&quot;any&quot;</span>
<a href="#l31.246"></a><span id="l31.246">               hideifnoinsertionpoint=&quot;true&quot;/&gt;</span>
<a href="#l31.247"></a><span id="l31.247">     &lt;menuseparator id=&quot;placesContext_editSeparator&quot;/&gt;</span>
<a href="#l31.248"></a><span id="l31.248">     &lt;menuitem id=&quot;placesContext_delete&quot;</span>
<a href="#l31.249"></a><span id="l31.249">               command=&quot;placesCmd_delete&quot;</span>
<a href="#l31.250"></a><span id="l31.250">               label=&quot;&amp;deleteCmd.label;&quot;</span>
<a href="#l31.251"></a><span id="l31.251">               accesskey=&quot;&amp;deleteCmd.accesskey;&quot;</span>
<a href="#l31.252"></a><span id="l31.252">               closemenu=&quot;single&quot;</span>
<a href="#l31.253"></a><span id="l31.253">               selection=&quot;bookmark|tagChild|folder|query|dynamiccontainer|separator|host&quot;/&gt;</span>
<a href="#l31.254"></a><span id="l31.254">     &lt;menuitem id=&quot;placesContext_delete_history&quot;</span>
<a href="#l31.255"></a><span id="l31.255">               command=&quot;placesCmd_delete&quot;</span>
<a href="#l31.256"></a><span id="l31.256" class="difflineminus">-              label=&quot;&amp;cmd.delete.label;&quot;</span>
<a href="#l31.257"></a><span id="l31.257" class="difflineminus">-              accesskey=&quot;&amp;cmd.delete.accesskey;&quot;</span>
<a href="#l31.258"></a><span id="l31.258">               closemenu=&quot;single&quot;</span>
<a href="#l31.259"></a><span id="l31.259">               selection=&quot;link&quot;</span>
<a href="#l31.260"></a><span id="l31.260">               forcehideselection=&quot;bookmark&quot;/&gt;</span>
<a href="#l31.261"></a><span id="l31.261">     &lt;menuitem id=&quot;placesContext_deleteHost&quot;</span>
<a href="#l31.262"></a><span id="l31.262">               command=&quot;placesCmd_deleteDataHost&quot;</span>
<a href="#l31.263"></a><span id="l31.263">               label=&quot;&amp;cmd.deleteDomainData.label;&quot;</span>
<a href="#l31.264"></a><span id="l31.264">               accesskey=&quot;&amp;cmd.deleteDomainData.accesskey;&quot;</span>
<a href="#l31.265"></a><span id="l31.265">               closemenu=&quot;single&quot;</span>
<a href="#l31.266"></a><span id="l31.266">               selection=&quot;link|host&quot;</span>
<a href="#l31.267"></a><span id="l31.267">               selectiontype=&quot;single&quot;</span>
<a href="#l31.268"></a><span id="l31.268" class="difflineplus">+              hideifprivatebrowsing=&quot;true&quot;</span>
<a href="#l31.269"></a><span id="l31.269">               forcehideselection=&quot;bookmark&quot;/&gt;</span>
<a href="#l31.270"></a><span id="l31.270">     &lt;menuseparator id=&quot;placesContext_deleteSeparator&quot;/&gt;</span>
<a href="#l31.271"></a><span id="l31.271" class="difflineplus">+    &lt;menuitem id=&quot;placesContext_sortBy:name&quot;</span>
<a href="#l31.272"></a><span id="l31.272" class="difflineplus">+              command=&quot;placesCmd_sortBy:name&quot;</span>
<a href="#l31.273"></a><span id="l31.273" class="difflineplus">+              label=&quot;&amp;cmd.sortby_name.label;&quot;</span>
<a href="#l31.274"></a><span id="l31.274" class="difflineplus">+              accesskey=&quot;&amp;cmd.context_sortby_name.accesskey;&quot;</span>
<a href="#l31.275"></a><span id="l31.275" class="difflineplus">+              closemenu=&quot;single&quot;</span>
<a href="#l31.276"></a><span id="l31.276" class="difflineplus">+              selection=&quot;folder&quot;/&gt;</span>
<a href="#l31.277"></a><span id="l31.277">     &lt;menuitem id=&quot;placesContext_reload&quot;</span>
<a href="#l31.278"></a><span id="l31.278">               command=&quot;placesCmd_reload&quot;</span>
<a href="#l31.279"></a><span id="l31.279">               label=&quot;&amp;cmd.reloadLivebookmark.label;&quot;</span>
<a href="#l31.280"></a><span id="l31.280">               accesskey=&quot;&amp;cmd.reloadLivebookmark.accesskey;&quot;</span>
<a href="#l31.281"></a><span id="l31.281">               closemenu=&quot;single&quot;</span>
<a href="#l31.282"></a><span id="l31.282">               selection=&quot;livemark/feedURI&quot;/&gt;</span>
<a href="#l31.283"></a><span id="l31.283" class="difflineminus">-    &lt;menuitem id=&quot;placesContext_sortBy:name&quot;</span>
<a href="#l31.284"></a><span id="l31.284" class="difflineminus">-              command=&quot;placesCmd_sortBy:name&quot;</span>
<a href="#l31.285"></a><span id="l31.285" class="difflineminus">-              label=&quot;&amp;cmd.sortby_name.label;&quot;</span>
<a href="#l31.286"></a><span id="l31.286" class="difflineminus">-              accesskey=&quot;&amp;cmd.sortby_name.accesskey;&quot;</span>
<a href="#l31.287"></a><span id="l31.287" class="difflineminus">-              closemenu=&quot;single&quot;</span>
<a href="#l31.288"></a><span id="l31.288" class="difflineminus">-              selection=&quot;folder&quot;/&gt;</span>
<a href="#l31.289"></a><span id="l31.289">     &lt;menuseparator id=&quot;placesContext_sortSeparator&quot;/&gt;</span>
<a href="#l31.290"></a><span id="l31.290">     &lt;menuitem id=&quot;placesContext_show:info&quot;</span>
<a href="#l31.291"></a><span id="l31.291">               command=&quot;placesCmd_show:info&quot;</span>
<a href="#l31.292"></a><span id="l31.292">               label=&quot;&amp;cmd.properties.label;&quot;</span>
<a href="#l31.293"></a><span id="l31.293">               accesskey=&quot;&amp;cmd.properties.accesskey;&quot;</span>
<a href="#l31.294"></a><span id="l31.294">               selection=&quot;bookmark|folder|query&quot;</span>
<a href="#l31.295"></a><span id="l31.295">               forcehideselection=&quot;livemarkChild&quot;/&gt;</span>
<a href="#l31.296"></a><span id="l31.296">   &lt;/menupopup&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l32.1"></a><span id="l32.1" class="difflineminus">--- a/suite/common/places/content/sidebarUtils.js</span>
<a href="#l32.2"></a><span id="l32.2" class="difflineplus">+++ b/suite/common/places/content/sidebarUtils.js</span>
<a href="#l32.3"></a><span id="l32.3" class="difflineat">@@ -1,12 +1,14 @@</span>
<a href="#l32.4"></a><span id="l32.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l32.5"></a><span id="l32.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l32.6"></a><span id="l32.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l32.7"></a><span id="l32.7"> </span>
<a href="#l32.8"></a><span id="l32.8" class="difflineplus">+ChromeUtils.import(&quot;resource://gre/modules/AppConstants.jsm&quot;);</span>
<a href="#l32.9"></a><span id="l32.9" class="difflineplus">+</span>
<a href="#l32.10"></a><span id="l32.10"> var SidebarUtils = {</span>
<a href="#l32.11"></a><span id="l32.11">   handleTreeClick: function SU_handleTreeClick(aTree, aEvent, aGutterSelect) {</span>
<a href="#l32.12"></a><span id="l32.12">     // right-clicks are not handled here</span>
<a href="#l32.13"></a><span id="l32.13">     if (aEvent.button == 2)</span>
<a href="#l32.14"></a><span id="l32.14">       return;</span>
<a href="#l32.15"></a><span id="l32.15"> </span>
<a href="#l32.16"></a><span id="l32.16">     var tbo = aTree.treeBoxObject;</span>
<a href="#l32.17"></a><span id="l32.17">     var cell = tbo.getCellAt(aEvent.clientX, aEvent.clientY);</span>
<a href="#l32.18"></a><span id="l32.18" class="difflineat">@@ -17,52 +19,54 @@ var SidebarUtils = {</span>
<a href="#l32.19"></a><span id="l32.19">     var mouseInGutter = false;</span>
<a href="#l32.20"></a><span id="l32.20">     if (aGutterSelect) {</span>
<a href="#l32.21"></a><span id="l32.21">       var rect = tbo.getCoordsForCellItem(cell.row, cell.col, &quot;image&quot;);</span>
<a href="#l32.22"></a><span id="l32.22">       // getCoordsForCellItem returns the x coordinate in logical coordinates</span>
<a href="#l32.23"></a><span id="l32.23">       // (i.e., starting from the left and right sides in LTR and RTL modes,</span>
<a href="#l32.24"></a><span id="l32.24">       // respectively.)  Therefore, we make sure to exclude the blank area</span>
<a href="#l32.25"></a><span id="l32.25">       // before the tree item icon (that is, to the left or right of it in</span>
<a href="#l32.26"></a><span id="l32.26">       // LTR and RTL modes, respectively) from the click target area.</span>
<a href="#l32.27"></a><span id="l32.27" class="difflineminus">-      var isRTL = window.getComputedStyle(aTree, null).direction == &quot;rtl&quot;;</span>
<a href="#l32.28"></a><span id="l32.28" class="difflineplus">+      var isRTL = window.getComputedStyle(aTree).direction == &quot;rtl&quot;;</span>
<a href="#l32.29"></a><span id="l32.29">       if (isRTL)</span>
<a href="#l32.30"></a><span id="l32.30">         mouseInGutter = aEvent.clientX &gt; rect.x;</span>
<a href="#l32.31"></a><span id="l32.31">       else</span>
<a href="#l32.32"></a><span id="l32.32">         mouseInGutter = aEvent.clientX &lt; rect.x;</span>
<a href="#l32.33"></a><span id="l32.33">     }</span>
<a href="#l32.34"></a><span id="l32.34"> </span>
<a href="#l32.35"></a><span id="l32.35" class="difflineminus">-    var openWhere = whereToOpenLink(aEvent, false, true);</span>
<a href="#l32.36"></a><span id="l32.36" class="difflineminus">-</span>
<a href="#l32.37"></a><span id="l32.37" class="difflineplus">+    var metaKey = AppConstants.platform === &quot;macosx&quot; ? aEvent.metaKey</span>
<a href="#l32.38"></a><span id="l32.38" class="difflineplus">+                                                     : aEvent.ctrlKey;</span>
<a href="#l32.39"></a><span id="l32.39" class="difflineplus">+    var modifKey = metaKey || aEvent.shiftKey;</span>
<a href="#l32.40"></a><span id="l32.40">     var isContainer = tbo.view.isContainer(cell.row);</span>
<a href="#l32.41"></a><span id="l32.41">     var openInTabs = isContainer &amp;&amp;</span>
<a href="#l32.42"></a><span id="l32.42" class="difflineminus">-                     (openWhere == &quot;tab&quot; || openWhere == &quot;tabshifted&quot;) &amp;&amp;</span>
<a href="#l32.43"></a><span id="l32.43" class="difflineplus">+                     (aEvent.button == 1 ||</span>
<a href="#l32.44"></a><span id="l32.44" class="difflineplus">+                      (aEvent.button == 0 &amp;&amp; modifKey)) &amp;&amp;</span>
<a href="#l32.45"></a><span id="l32.45">                      PlacesUtils.hasChildURIs(tbo.view.nodeForTreeIndex(cell.row));</span>
<a href="#l32.46"></a><span id="l32.46"> </span>
<a href="#l32.47"></a><span id="l32.47">     if (aEvent.button == 0 &amp;&amp; isContainer &amp;&amp; !openInTabs) {</span>
<a href="#l32.48"></a><span id="l32.48">       tbo.view.toggleOpenState(cell.row);</span>
<a href="#l32.49"></a><span id="l32.49" class="difflineminus">-      return;</span>
<a href="#l32.50"></a><span id="l32.50" class="difflineminus">-    }</span>
<a href="#l32.51"></a><span id="l32.51" class="difflineminus">-    else if (!mouseInGutter &amp;&amp; openInTabs &amp;&amp;</span>
<a href="#l32.52"></a><span id="l32.52" class="difflineplus">+    } else if (!mouseInGutter &amp;&amp; openInTabs &amp;&amp;</span>
<a href="#l32.53"></a><span id="l32.53">             aEvent.originalTarget.localName == &quot;treechildren&quot;) {</span>
<a href="#l32.54"></a><span id="l32.54">       tbo.view.selection.select(cell.row);</span>
<a href="#l32.55"></a><span id="l32.55" class="difflineminus">-      PlacesUIUtils.openContainerNodeInTabs(aTree.selectedNode, aEvent);</span>
<a href="#l32.56"></a><span id="l32.56" class="difflineminus">-    }</span>
<a href="#l32.57"></a><span id="l32.57" class="difflineminus">-    else if (!mouseInGutter &amp;&amp; !isContainer &amp;&amp;</span>
<a href="#l32.58"></a><span id="l32.58" class="difflineplus">+      PlacesUIUtils.openContainerNodeInTabs(aTree.selectedNode, aEvent, aTree);</span>
<a href="#l32.59"></a><span id="l32.59" class="difflineplus">+    } else if (!mouseInGutter &amp;&amp; !isContainer &amp;&amp;</span>
<a href="#l32.60"></a><span id="l32.60">              aEvent.originalTarget.localName == &quot;treechildren&quot;) {</span>
<a href="#l32.61"></a><span id="l32.61">       // Clear all other selection since we're loading a link now. We must</span>
<a href="#l32.62"></a><span id="l32.62">       // do this *before* attempting to load the link since openURL uses</span>
<a href="#l32.63"></a><span id="l32.63">       // selection as an indication of which link to load.</span>
<a href="#l32.64"></a><span id="l32.64">       tbo.view.selection.select(cell.row);</span>
<a href="#l32.65"></a><span id="l32.65">       PlacesUIUtils.openNodeWithEvent(aTree.selectedNode, aEvent);</span>
<a href="#l32.66"></a><span id="l32.66">     }</span>
<a href="#l32.67"></a><span id="l32.67">   },</span>
<a href="#l32.68"></a><span id="l32.68"> </span>
<a href="#l32.69"></a><span id="l32.69">   handleTreeKeyPress: function SU_handleTreeKeyPress(aEvent) {</span>
<a href="#l32.70"></a><span id="l32.70" class="difflineminus">-    if (aEvent.keyCode == KeyEvent.DOM_VK_RETURN)</span>
<a href="#l32.71"></a><span id="l32.71" class="difflineminus">-      PlacesUIUtils.openNodeWithEvent(aEvent.target.selectedNode, aEvent);</span>
<a href="#l32.72"></a><span id="l32.72" class="difflineplus">+    let node = aEvent.target.selectedNode;</span>
<a href="#l32.73"></a><span id="l32.73" class="difflineplus">+    if (node) {</span>
<a href="#l32.74"></a><span id="l32.74" class="difflineplus">+      if (aEvent.keyCode == KeyEvent.DOM_VK_RETURN)</span>
<a href="#l32.75"></a><span id="l32.75" class="difflineplus">+        PlacesUIUtils.openNodeWithEvent(node, aEvent);</span>
<a href="#l32.76"></a><span id="l32.76" class="difflineplus">+    }</span>
<a href="#l32.77"></a><span id="l32.77">   },</span>
<a href="#l32.78"></a><span id="l32.78"> </span>
<a href="#l32.79"></a><span id="l32.79">   /**</span>
<a href="#l32.80"></a><span id="l32.80">    * The following function displays the URL of a node that is being</span>
<a href="#l32.81"></a><span id="l32.81">    * hovered over.</span>
<a href="#l32.82"></a><span id="l32.82">    */</span>
<a href="#l32.83"></a><span id="l32.83">   handleTreeMouseMove: function SU_handleTreeMouseMove(aEvent) {</span>
<a href="#l32.84"></a><span id="l32.84">     if (aEvent.target.localName != &quot;treechildren&quot;)</span>
<a href="#l32.85"></a><span id="l32.85" class="difflineat">@@ -76,17 +80,21 @@ var SidebarUtils = {</span>
<a href="#l32.86"></a><span id="l32.86">     // To avoid showing a URL from a previously hovered node for a currently</span>
<a href="#l32.87"></a><span id="l32.87">     // hovered non-url node, we must clear the moused-over URL in these cases.</span>
<a href="#l32.88"></a><span id="l32.88">     if (cell.row != -1) {</span>
<a href="#l32.89"></a><span id="l32.89">       var node = tree.view.nodeForTreeIndex(cell.row);</span>
<a href="#l32.90"></a><span id="l32.90">       if (PlacesUtils.nodeIsURI(node))</span>
<a href="#l32.91"></a><span id="l32.91">         this.setMouseoverURL(node.uri);</span>
<a href="#l32.92"></a><span id="l32.92">       else</span>
<a href="#l32.93"></a><span id="l32.93">         this.setMouseoverURL(&quot;&quot;);</span>
<a href="#l32.94"></a><span id="l32.94" class="difflineminus">-    }</span>
<a href="#l32.95"></a><span id="l32.95" class="difflineminus">-    else</span>
<a href="#l32.96"></a><span id="l32.96" class="difflineplus">+    } else</span>
<a href="#l32.97"></a><span id="l32.97">       this.setMouseoverURL(&quot;&quot;);</span>
<a href="#l32.98"></a><span id="l32.98">   },</span>
<a href="#l32.99"></a><span id="l32.99"> </span>
<a href="#l32.100"></a><span id="l32.100">   setMouseoverURL: function SU_setMouseoverURL(aURL) {</span>
<a href="#l32.101"></a><span id="l32.101" class="difflineminus">-    window.top.XULBrowserWindow.setOverLink(aURL, null);</span>
<a href="#l32.102"></a><span id="l32.102" class="difflineplus">+    // When the browser window is closed with an open sidebar, the sidebar</span>
<a href="#l32.103"></a><span id="l32.103" class="difflineplus">+    // unload event happens after the browser's one.  In this case</span>
<a href="#l32.104"></a><span id="l32.104" class="difflineplus">+    // top.XULBrowserWindow has been nullified already.</span>
<a href="#l32.105"></a><span id="l32.105" class="difflineplus">+    if (top.XULBrowserWindow) {</span>
<a href="#l32.106"></a><span id="l32.106" class="difflineplus">+      top.XULBrowserWindow.setOverLink(aURL, null);</span>
<a href="#l32.107"></a><span id="l32.107" class="difflineplus">+    }</span>
<a href="#l32.108"></a><span id="l32.108">   }</span>
<a href="#l32.109"></a><span id="l32.109"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l33.1"></a><span id="l33.1" class="difflineminus">--- a/suite/common/places/content/tree.xml</span>
<a href="#l33.2"></a><span id="l33.2" class="difflineplus">+++ b/suite/common/places/content/tree.xml</span>
<a href="#l33.3"></a><span id="l33.3" class="difflineat">@@ -21,43 +21,56 @@</span>
<a href="#l33.4"></a><span id="l33.4">       &lt;destructor&gt;&lt;![CDATA[</span>
<a href="#l33.5"></a><span id="l33.5">         // Break the treeviewer-&gt;result-&gt;treeviewer cycle.</span>
<a href="#l33.6"></a><span id="l33.6">         // Note: unsetting the result's viewer also unsets</span>
<a href="#l33.7"></a><span id="l33.7">         // the viewer's reference to our treeBoxObject.</span>
<a href="#l33.8"></a><span id="l33.8">         var result = this.result;</span>
<a href="#l33.9"></a><span id="l33.9">         if (result) {</span>
<a href="#l33.10"></a><span id="l33.10">           result.root.containerOpen = false;</span>
<a href="#l33.11"></a><span id="l33.11">         }</span>
<a href="#l33.12"></a><span id="l33.12" class="difflineplus">+</span>
<a href="#l33.13"></a><span id="l33.13" class="difflineplus">+        // Unregister the controllber before unlinking the view, otherwise it</span>
<a href="#l33.14"></a><span id="l33.14" class="difflineplus">+        // may still try to update commands on a view with a null result.</span>
<a href="#l33.15"></a><span id="l33.15" class="difflineplus">+        if (this._controller) {</span>
<a href="#l33.16"></a><span id="l33.16" class="difflineplus">+          this._controller.terminate();</span>
<a href="#l33.17"></a><span id="l33.17" class="difflineplus">+          this.controllers.removeController(this._controller);</span>
<a href="#l33.18"></a><span id="l33.18" class="difflineplus">+        }</span>
<a href="#l33.19"></a><span id="l33.19" class="difflineplus">+</span>
<a href="#l33.20"></a><span id="l33.20" class="difflineplus">+        if (this.view) {</span>
<a href="#l33.21"></a><span id="l33.21" class="difflineplus">+          this.view.uninit();</span>
<a href="#l33.22"></a><span id="l33.22" class="difflineplus">+        }</span>
<a href="#l33.23"></a><span id="l33.23">         this.view = null;</span>
<a href="#l33.24"></a><span id="l33.24">       ]]&gt;&lt;/destructor&gt;</span>
<a href="#l33.25"></a><span id="l33.25"> </span>
<a href="#l33.26"></a><span id="l33.26">       &lt;property name=&quot;controller&quot;</span>
<a href="#l33.27"></a><span id="l33.27">                 readonly=&quot;true&quot;</span>
<a href="#l33.28"></a><span id="l33.28">                 onget=&quot;return this._controller&quot;/&gt;</span>
<a href="#l33.29"></a><span id="l33.29"> </span>
<a href="#l33.30"></a><span id="l33.30">       &lt;!-- overriding --&gt;</span>
<a href="#l33.31"></a><span id="l33.31">       &lt;property name=&quot;view&quot;&gt;</span>
<a href="#l33.32"></a><span id="l33.32">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l33.33"></a><span id="l33.33">           try {</span>
<a href="#l33.34"></a><span id="l33.34" class="difflineminus">-            return this.treeBoxObject.view</span>
<a href="#l33.35"></a><span id="l33.35" class="difflineminus">-                .QueryInterface(Ci.nsITreeView)</span>
<a href="#l33.36"></a><span id="l33.36" class="difflineminus">-                .QueryInterface(Ci.nsINavHistoryResultTreeViewer);</span>
<a href="#l33.37"></a><span id="l33.37" class="difflineminus">-          }</span>
<a href="#l33.38"></a><span id="l33.38" class="difflineminus">-          catch(e) {</span>
<a href="#l33.39"></a><span id="l33.39" class="difflineplus">+            return this.treeBoxObject.view.wrappedJSObject || null;</span>
<a href="#l33.40"></a><span id="l33.40" class="difflineplus">+          } catch (e) {</span>
<a href="#l33.41"></a><span id="l33.41">             return null;</span>
<a href="#l33.42"></a><span id="l33.42">           }</span>
<a href="#l33.43"></a><span id="l33.43">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l33.44"></a><span id="l33.44">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l33.45"></a><span id="l33.45">           return this.treeBoxObject.view = val;</span>
<a href="#l33.46"></a><span id="l33.46">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l33.47"></a><span id="l33.47">       &lt;/property&gt;</span>
<a href="#l33.48"></a><span id="l33.48"> </span>
<a href="#l33.49"></a><span id="l33.49" class="difflineplus">+      &lt;property name=&quot;associatedElement&quot;</span>
<a href="#l33.50"></a><span id="l33.50" class="difflineplus">+                readonly=&quot;true&quot;</span>
<a href="#l33.51"></a><span id="l33.51" class="difflineplus">+                onget=&quot;return this&quot;/&gt;</span>
<a href="#l33.52"></a><span id="l33.52" class="difflineplus">+</span>
<a href="#l33.53"></a><span id="l33.53">       &lt;method name=&quot;applyFilter&quot;&gt;</span>
<a href="#l33.54"></a><span id="l33.54">         &lt;parameter name=&quot;filterString&quot;/&gt;</span>
<a href="#l33.55"></a><span id="l33.55">         &lt;parameter name=&quot;folderRestrict&quot;/&gt;</span>
<a href="#l33.56"></a><span id="l33.56" class="difflineplus">+        &lt;parameter name=&quot;includeHidden&quot;/&gt;</span>
<a href="#l33.57"></a><span id="l33.57">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l33.58"></a><span id="l33.58">           // preserve grouping</span>
<a href="#l33.59"></a><span id="l33.59">           var queryNode = PlacesUtils.asQuery(this.result.root);</span>
<a href="#l33.60"></a><span id="l33.60">           var options = queryNode.queryOptions.clone();</span>
<a href="#l33.61"></a><span id="l33.61"> </span>
<a href="#l33.62"></a><span id="l33.62">           // Make sure we're getting uri results.</span>
<a href="#l33.63"></a><span id="l33.63">           // We do not yet support searching into grouped queries or into</span>
<a href="#l33.64"></a><span id="l33.64">           // tag containers, so we must fall to the default case.</span>
<a href="#l33.65"></a><span id="l33.65" class="difflineat">@@ -69,16 +82,18 @@</span>
<a href="#l33.66"></a><span id="l33.66">           var query = PlacesUtils.history.getNewQuery();</span>
<a href="#l33.67"></a><span id="l33.67">           query.searchTerms = filterString;</span>
<a href="#l33.68"></a><span id="l33.68"> </span>
<a href="#l33.69"></a><span id="l33.69">           if (folderRestrict) {</span>
<a href="#l33.70"></a><span id="l33.70">             query.setFolders(folderRestrict, folderRestrict.length);</span>
<a href="#l33.71"></a><span id="l33.71">             options.queryType = options.QUERY_TYPE_BOOKMARKS;</span>
<a href="#l33.72"></a><span id="l33.72">           }</span>
<a href="#l33.73"></a><span id="l33.73"> </span>
<a href="#l33.74"></a><span id="l33.74" class="difflineplus">+          options.includeHidden = !!includeHidden;</span>
<a href="#l33.75"></a><span id="l33.75" class="difflineplus">+</span>
<a href="#l33.76"></a><span id="l33.76">           this.load([query], options);</span>
<a href="#l33.77"></a><span id="l33.77">         ]]&gt;&lt;/body&gt;</span>
<a href="#l33.78"></a><span id="l33.78">       &lt;/method&gt;</span>
<a href="#l33.79"></a><span id="l33.79"> </span>
<a href="#l33.80"></a><span id="l33.80">       &lt;method name=&quot;load&quot;&gt;</span>
<a href="#l33.81"></a><span id="l33.81">         &lt;parameter name=&quot;queries&quot;/&gt;</span>
<a href="#l33.82"></a><span id="l33.82">         &lt;parameter name=&quot;options&quot;/&gt;</span>
<a href="#l33.83"></a><span id="l33.83">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l33.84"></a><span id="l33.84" class="difflineat">@@ -99,16 +114,21 @@</span>
<a href="#l33.85"></a><span id="l33.85"> </span>
<a href="#l33.86"></a><span id="l33.86">           let treeView = new PlacesTreeView(this.flatList, callback, this._controller);</span>
<a href="#l33.87"></a><span id="l33.87"> </span>
<a href="#l33.88"></a><span id="l33.88">           // Observer removal is done within the view itself.  When the tree</span>
<a href="#l33.89"></a><span id="l33.89">           // goes away, treeboxobject calls view.setTree(null), which then</span>
<a href="#l33.90"></a><span id="l33.90">           // calls removeObserver.</span>
<a href="#l33.91"></a><span id="l33.91">           result.addObserver(treeView);</span>
<a href="#l33.92"></a><span id="l33.92">           this.view = treeView;</span>
<a href="#l33.93"></a><span id="l33.93" class="difflineplus">+</span>
<a href="#l33.94"></a><span id="l33.94" class="difflineplus">+          if (this.getAttribute(&quot;selectfirstnode&quot;) == &quot;true&quot; &amp;&amp; treeView.rowCount &gt; 0) {</span>
<a href="#l33.95"></a><span id="l33.95" class="difflineplus">+            treeView.selection.select(0);</span>
<a href="#l33.96"></a><span id="l33.96" class="difflineplus">+          }</span>
<a href="#l33.97"></a><span id="l33.97" class="difflineplus">+</span>
<a href="#l33.98"></a><span id="l33.98">           this._cachedInsertionPoint = undefined;</span>
<a href="#l33.99"></a><span id="l33.99">         ]]&gt;&lt;/body&gt;</span>
<a href="#l33.100"></a><span id="l33.100">       &lt;/method&gt;</span>
<a href="#l33.101"></a><span id="l33.101"> </span>
<a href="#l33.102"></a><span id="l33.102">       &lt;property name=&quot;flatList&quot;&gt;</span>
<a href="#l33.103"></a><span id="l33.103">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l33.104"></a><span id="l33.104">           return this.getAttribute(&quot;flatList&quot;) == &quot;true&quot;;</span>
<a href="#l33.105"></a><span id="l33.105">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l33.106"></a><span id="l33.106" class="difflineat">@@ -145,53 +165,53 @@</span>
<a href="#l33.107"></a><span id="l33.107">         --&gt;</span>
<a href="#l33.108"></a><span id="l33.108">       &lt;method name=&quot;selectPlaceURI&quot;&gt;</span>
<a href="#l33.109"></a><span id="l33.109">         &lt;parameter name=&quot;placeURI&quot;/&gt;</span>
<a href="#l33.110"></a><span id="l33.110">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l33.111"></a><span id="l33.111">           // Do nothing if a node matching the given uri is already selected</span>
<a href="#l33.112"></a><span id="l33.112">           if (this.hasSelection &amp;&amp; this.selectedNode.uri == placeURI)</span>
<a href="#l33.113"></a><span id="l33.113">             return;</span>
<a href="#l33.114"></a><span id="l33.114"> </span>
<a href="#l33.115"></a><span id="l33.115" class="difflineminus">-          function findNode(container, placeURI, nodesURIChecked) {</span>
<a href="#l33.116"></a><span id="l33.116" class="difflineplus">+          function findNode(container, nodesURIChecked) {</span>
<a href="#l33.117"></a><span id="l33.117">             var containerURI = container.uri;</span>
<a href="#l33.118"></a><span id="l33.118">             if (containerURI == placeURI)</span>
<a href="#l33.119"></a><span id="l33.119">               return container;</span>
<a href="#l33.120"></a><span id="l33.120" class="difflineminus">-            if (nodesURIChecked.indexOf(containerURI) != -1)</span>
<a href="#l33.121"></a><span id="l33.121" class="difflineplus">+            if (nodesURIChecked.includes(containerURI))</span>
<a href="#l33.122"></a><span id="l33.122">               return null;</span>
<a href="#l33.123"></a><span id="l33.123"> </span>
<a href="#l33.124"></a><span id="l33.124">             // never check the contents of the same query</span>
<a href="#l33.125"></a><span id="l33.125">             nodesURIChecked.push(containerURI);</span>
<a href="#l33.126"></a><span id="l33.126"> </span>
<a href="#l33.127"></a><span id="l33.127">             var wasOpen = container.containerOpen;</span>
<a href="#l33.128"></a><span id="l33.128">             if (!wasOpen)</span>
<a href="#l33.129"></a><span id="l33.129">               container.containerOpen = true;</span>
<a href="#l33.130"></a><span id="l33.130">             for (var i = 0; i &lt; container.childCount; ++i) {</span>
<a href="#l33.131"></a><span id="l33.131">               var child = container.getChild(i);</span>
<a href="#l33.132"></a><span id="l33.132">               var childURI = child.uri;</span>
<a href="#l33.133"></a><span id="l33.133">               if (childURI == placeURI)</span>
<a href="#l33.134"></a><span id="l33.134">                 return child;</span>
<a href="#l33.135"></a><span id="l33.135">               else if (PlacesUtils.nodeIsContainer(child)) {</span>
<a href="#l33.136"></a><span id="l33.136" class="difflineminus">-                var nested = findNode(PlacesUtils.asContainer(child), placeURI, nodesURIChecked);</span>
<a href="#l33.137"></a><span id="l33.137" class="difflineplus">+                var nested = findNode(PlacesUtils.asContainer(child), nodesURIChecked);</span>
<a href="#l33.138"></a><span id="l33.138">                 if (nested)</span>
<a href="#l33.139"></a><span id="l33.139">                   return nested;</span>
<a href="#l33.140"></a><span id="l33.140">               }</span>
<a href="#l33.141"></a><span id="l33.141">             }</span>
<a href="#l33.142"></a><span id="l33.142"> </span>
<a href="#l33.143"></a><span id="l33.143">             if (!wasOpen)</span>
<a href="#l33.144"></a><span id="l33.144">               container.containerOpen = false;</span>
<a href="#l33.145"></a><span id="l33.145"> </span>
<a href="#l33.146"></a><span id="l33.146">             return null;</span>
<a href="#l33.147"></a><span id="l33.147">           }</span>
<a href="#l33.148"></a><span id="l33.148"> </span>
<a href="#l33.149"></a><span id="l33.149">           var container = this.result.root;</span>
<a href="#l33.150"></a><span id="l33.150">           NS_ASSERT(container, &quot;No result, cannot select place URI!&quot;);</span>
<a href="#l33.151"></a><span id="l33.151">           if (!container)</span>
<a href="#l33.152"></a><span id="l33.152">             return;</span>
<a href="#l33.153"></a><span id="l33.153"> </span>
<a href="#l33.154"></a><span id="l33.154" class="difflineminus">-          var child = findNode(container, placeURI, []);</span>
<a href="#l33.155"></a><span id="l33.155" class="difflineplus">+          var child = findNode(container, []);</span>
<a href="#l33.156"></a><span id="l33.156">           if (child)</span>
<a href="#l33.157"></a><span id="l33.157">             this.selectNode(child);</span>
<a href="#l33.158"></a><span id="l33.158">           else {</span>
<a href="#l33.159"></a><span id="l33.159">             // If the specified child could not be located, clear the selection</span>
<a href="#l33.160"></a><span id="l33.160">             var selection = this.view.selection;</span>
<a href="#l33.161"></a><span id="l33.161">             selection.clearSelection();</span>
<a href="#l33.162"></a><span id="l33.162">           }</span>
<a href="#l33.163"></a><span id="l33.163">         ]]&gt;&lt;/body&gt;</span>
<a href="#l33.164"></a><span id="l33.164" class="difflineat">@@ -216,41 +236,40 @@</span>
<a href="#l33.165"></a><span id="l33.165">             while (parent &amp;&amp; parent != root) {</span>
<a href="#l33.166"></a><span id="l33.166">               parents.push(parent);</span>
<a href="#l33.167"></a><span id="l33.167">               parent = parent.parent;</span>
<a href="#l33.168"></a><span id="l33.168">             }</span>
<a href="#l33.169"></a><span id="l33.169"> </span>
<a href="#l33.170"></a><span id="l33.170">             // Walk the list backwards (opening from the root of the hierarchy)</span>
<a href="#l33.171"></a><span id="l33.171">             // opening each folder as we go.</span>
<a href="#l33.172"></a><span id="l33.172">             for (var i = parents.length - 1; i &gt;= 0; --i) {</span>
<a href="#l33.173"></a><span id="l33.173" class="difflineminus">-              var index = view.treeIndexForNode(parents[i]);</span>
<a href="#l33.174"></a><span id="l33.174" class="difflineplus">+              let index = view.treeIndexForNode(parents[i]);</span>
<a href="#l33.175"></a><span id="l33.175">               if (index != Ci.nsINavHistoryResultTreeViewer.INDEX_INVISIBLE &amp;&amp;</span>
<a href="#l33.176"></a><span id="l33.176">                   view.isContainer(index) &amp;&amp; !view.isContainerOpen(index))</span>
<a href="#l33.177"></a><span id="l33.177">                 view.toggleOpenState(index);</span>
<a href="#l33.178"></a><span id="l33.178">             }</span>
<a href="#l33.179"></a><span id="l33.179">             // Select the specified node...</span>
<a href="#l33.180"></a><span id="l33.180">           }</span>
<a href="#l33.181"></a><span id="l33.181"> </span>
<a href="#l33.182"></a><span id="l33.182" class="difflineminus">-          var index = view.treeIndexForNode(node);</span>
<a href="#l33.183"></a><span id="l33.183" class="difflineplus">+          let index = view.treeIndexForNode(node);</span>
<a href="#l33.184"></a><span id="l33.184">           if (index == Ci.nsINavHistoryResultTreeViewer.INDEX_INVISIBLE)</span>
<a href="#l33.185"></a><span id="l33.185">             return;</span>
<a href="#l33.186"></a><span id="l33.186"> </span>
<a href="#l33.187"></a><span id="l33.187">           view.selection.select(index);</span>
<a href="#l33.188"></a><span id="l33.188">           // ... and ensure it's visible, not scrolled off somewhere.</span>
<a href="#l33.189"></a><span id="l33.189">           this.treeBoxObject.ensureRowIsVisible(index);</span>
<a href="#l33.190"></a><span id="l33.190">         ]]&gt;&lt;/body&gt;</span>
<a href="#l33.191"></a><span id="l33.191">       &lt;/method&gt;</span>
<a href="#l33.192"></a><span id="l33.192"> </span>
<a href="#l33.193"></a><span id="l33.193">       &lt;!-- nsIPlacesView --&gt;</span>
<a href="#l33.194"></a><span id="l33.194">       &lt;property name=&quot;result&quot;&gt;</span>
<a href="#l33.195"></a><span id="l33.195">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l33.196"></a><span id="l33.196">           try {</span>
<a href="#l33.197"></a><span id="l33.197">             return this.view.QueryInterface(Ci.nsINavHistoryResultObserver).result;</span>
<a href="#l33.198"></a><span id="l33.198" class="difflineminus">-          }</span>
<a href="#l33.199"></a><span id="l33.199" class="difflineminus">-          catch (e) {</span>
<a href="#l33.200"></a><span id="l33.200" class="difflineplus">+          } catch (e) {</span>
<a href="#l33.201"></a><span id="l33.201">             return null;</span>
<a href="#l33.202"></a><span id="l33.202">           }</span>
<a href="#l33.203"></a><span id="l33.203">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l33.204"></a><span id="l33.204">       &lt;/property&gt;</span>
<a href="#l33.205"></a><span id="l33.205"> </span>
<a href="#l33.206"></a><span id="l33.206">       &lt;!-- nsIPlacesView --&gt;</span>
<a href="#l33.207"></a><span id="l33.207">       &lt;property name=&quot;place&quot;&gt;</span>
<a href="#l33.208"></a><span id="l33.208">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l33.209"></a><span id="l33.209" class="difflineat">@@ -289,25 +308,32 @@</span>
<a href="#l33.210"></a><span id="l33.210">             return nodes;</span>
<a href="#l33.211"></a><span id="l33.211"> </span>
<a href="#l33.212"></a><span id="l33.212">           let selection = this.view.selection;</span>
<a href="#l33.213"></a><span id="l33.213">           let rc = selection.getRangeCount();</span>
<a href="#l33.214"></a><span id="l33.214">           let resultview = this.view;</span>
<a href="#l33.215"></a><span id="l33.215">           for (let i = 0; i &lt; rc; ++i) {</span>
<a href="#l33.216"></a><span id="l33.216">             let min = { }, max = { };</span>
<a href="#l33.217"></a><span id="l33.217">             selection.getRangeAt(i, min, max);</span>
<a href="#l33.218"></a><span id="l33.218" class="difflineminus">-</span>
<a href="#l33.219"></a><span id="l33.219" class="difflineminus">-            if (max.value &gt; -1)</span>
<a href="#l33.220"></a><span id="l33.220" class="difflineminus">-              for (let j = min.value; j &lt;= max.value; ++j)</span>
<a href="#l33.221"></a><span id="l33.221" class="difflineminus">-                nodes.push(resultview.nodeForTreeIndex(j));</span>
<a href="#l33.222"></a><span id="l33.222" class="difflineplus">+            for (let j = min.value; j &lt;= max.value; ++j) {</span>
<a href="#l33.223"></a><span id="l33.223" class="difflineplus">+              nodes.push(resultview.nodeForTreeIndex(j));</span>
<a href="#l33.224"></a><span id="l33.224" class="difflineplus">+            }</span>
<a href="#l33.225"></a><span id="l33.225">           }</span>
<a href="#l33.226"></a><span id="l33.226">           return nodes;</span>
<a href="#l33.227"></a><span id="l33.227">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l33.228"></a><span id="l33.228">       &lt;/property&gt;</span>
<a href="#l33.229"></a><span id="l33.229"> </span>
<a href="#l33.230"></a><span id="l33.230" class="difflineplus">+      &lt;method name=&quot;toggleCutNode&quot;&gt;</span>
<a href="#l33.231"></a><span id="l33.231" class="difflineplus">+        &lt;parameter name=&quot;aNode&quot;/&gt;</span>
<a href="#l33.232"></a><span id="l33.232" class="difflineplus">+        &lt;parameter name=&quot;aValue&quot;/&gt;</span>
<a href="#l33.233"></a><span id="l33.233" class="difflineplus">+        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l33.234"></a><span id="l33.234" class="difflineplus">+          this.view.toggleCutNode(aNode, aValue);</span>
<a href="#l33.235"></a><span id="l33.235" class="difflineplus">+        ]]&gt;&lt;/body&gt;</span>
<a href="#l33.236"></a><span id="l33.236" class="difflineplus">+      &lt;/method&gt;</span>
<a href="#l33.237"></a><span id="l33.237" class="difflineplus">+</span>
<a href="#l33.238"></a><span id="l33.238">       &lt;!-- nsIPlacesView --&gt;</span>
<a href="#l33.239"></a><span id="l33.239">       &lt;property name=&quot;removableSelectionRanges&quot;&gt;</span>
<a href="#l33.240"></a><span id="l33.240">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l33.241"></a><span id="l33.241">           // This property exists in addition to selectedNodes because it</span>
<a href="#l33.242"></a><span id="l33.242">           // encodes selection ranges (which only occur in list views) into</span>
<a href="#l33.243"></a><span id="l33.243">           // the return value. For each removed range, the index at which items</span>
<a href="#l33.244"></a><span id="l33.244">           // will be re-inserted upon the remove transaction being performed is</span>
<a href="#l33.245"></a><span id="l33.245">           // the first index of the range, so that the view updates correctly.</span>
<a href="#l33.246"></a><span id="l33.246" class="difflineat">@@ -423,18 +449,16 @@</span>
<a href="#l33.247"></a><span id="l33.247">           // If the sole selection is a container, and we are not in</span>
<a href="#l33.248"></a><span id="l33.248">           // a flatlist, insert into it.</span>
<a href="#l33.249"></a><span id="l33.249">           // Note that this only applies to _single_ selections,</span>
<a href="#l33.250"></a><span id="l33.250">           // if the last element within a multi-selection is a</span>
<a href="#l33.251"></a><span id="l33.251">           // container, insert _adjacent_ to the selection.</span>
<a href="#l33.252"></a><span id="l33.252">           //</span>
<a href="#l33.253"></a><span id="l33.253">           // If the sole selection is the bookmarks toolbar folder, we insert</span>
<a href="#l33.254"></a><span id="l33.254">           // into it even if it is not opened</span>
<a href="#l33.255"></a><span id="l33.255" class="difflineminus">-          var itemId =</span>
<a href="#l33.256"></a><span id="l33.256" class="difflineminus">-            PlacesUtils.getConcreteItemId(resultView.nodeForTreeIndex(max.value));</span>
<a href="#l33.257"></a><span id="l33.257">           if (selection.count == 1 &amp;&amp; resultView.isContainer(max.value) &amp;&amp;</span>
<a href="#l33.258"></a><span id="l33.258">               !this.flatList)</span>
<a href="#l33.259"></a><span id="l33.259">             orientation = Ci.nsITreeView.DROP_ON;</span>
<a href="#l33.260"></a><span id="l33.260"> </span>
<a href="#l33.261"></a><span id="l33.261">           this._cachedInsertionPoint =</span>
<a href="#l33.262"></a><span id="l33.262">             this._getInsertionPoint(max.value, orientation);</span>
<a href="#l33.263"></a><span id="l33.263">           return this._cachedInsertionPoint;</span>
<a href="#l33.264"></a><span id="l33.264">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l33.265"></a><span id="l33.265" class="difflineat">@@ -453,27 +477,25 @@</span>
<a href="#l33.266"></a><span id="l33.266">           // the view is populated from (i.e. the result's itemId).</span>
<a href="#l33.267"></a><span id="l33.267">           if (index != -1) {</span>
<a href="#l33.268"></a><span id="l33.268">             var lastSelected = resultview.nodeForTreeIndex(index);</span>
<a href="#l33.269"></a><span id="l33.269">             if (resultview.isContainer(index) &amp;&amp; orientation == Ci.nsITreeView.DROP_ON) {</span>
<a href="#l33.270"></a><span id="l33.270">               // If the last selected item is an open container, append _into_</span>
<a href="#l33.271"></a><span id="l33.271">               // it, rather than insert adjacent to it.</span>
<a href="#l33.272"></a><span id="l33.272">               container = lastSelected;</span>
<a href="#l33.273"></a><span id="l33.273">               index = -1;</span>
<a href="#l33.274"></a><span id="l33.274" class="difflineminus">-            }</span>
<a href="#l33.275"></a><span id="l33.275" class="difflineminus">-            else if (lastSelected.containerOpen &amp;&amp;</span>
<a href="#l33.276"></a><span id="l33.276" class="difflineminus">-                     orientation == Ci.nsITreeView.DROP_AFTER &amp;&amp;</span>
<a href="#l33.277"></a><span id="l33.277" class="difflineminus">-                     lastSelected.hasChildren) {</span>
<a href="#l33.278"></a><span id="l33.278" class="difflineplus">+            } else if (lastSelected.containerOpen &amp;&amp;</span>
<a href="#l33.279"></a><span id="l33.279" class="difflineplus">+                       orientation == Ci.nsITreeView.DROP_AFTER &amp;&amp;</span>
<a href="#l33.280"></a><span id="l33.280" class="difflineplus">+                       lastSelected.hasChildren) {</span>
<a href="#l33.281"></a><span id="l33.281">              // If the last selected item is an open container and the user is</span>
<a href="#l33.282"></a><span id="l33.282">              // trying to drag into it as a first item, really insert into it.</span>
<a href="#l33.283"></a><span id="l33.283">              container = lastSelected;</span>
<a href="#l33.284"></a><span id="l33.284">              orientation = Ci.nsITreeView.DROP_ON;</span>
<a href="#l33.285"></a><span id="l33.285">              index = 0;</span>
<a href="#l33.286"></a><span id="l33.286" class="difflineminus">-            }</span>
<a href="#l33.287"></a><span id="l33.287" class="difflineminus">-            else {</span>
<a href="#l33.288"></a><span id="l33.288" class="difflineplus">+            } else {</span>
<a href="#l33.289"></a><span id="l33.289">               // Use the last-selected node's container.</span>
<a href="#l33.290"></a><span id="l33.290">               container = lastSelected.parent;</span>
<a href="#l33.291"></a><span id="l33.291"> </span>
<a href="#l33.292"></a><span id="l33.292">               // See comment in the treeView.js's copy of this method</span>
<a href="#l33.293"></a><span id="l33.293">               if (!container || !container.containerOpen)</span>
<a href="#l33.294"></a><span id="l33.294">                 return null;</span>
<a href="#l33.295"></a><span id="l33.295"> </span>
<a href="#l33.296"></a><span id="l33.296">               // Avoid the potentially expensive call to getChildIndex</span>
<a href="#l33.297"></a><span id="l33.297" class="difflineat">@@ -481,77 +503,86 @@</span>
<a href="#l33.298"></a><span id="l33.298">               if (PlacesControllerDragHelper.disallowInsertion(container))</span>
<a href="#l33.299"></a><span id="l33.299">                 return null;</span>
<a href="#l33.300"></a><span id="l33.300"> </span>
<a href="#l33.301"></a><span id="l33.301">               var queryOptions = PlacesUtils.asQuery(result.root).queryOptions;</span>
<a href="#l33.302"></a><span id="l33.302">               if (queryOptions.sortingMode !=</span>
<a href="#l33.303"></a><span id="l33.303">                     Ci.nsINavHistoryQueryOptions.SORT_BY_NONE) {</span>
<a href="#l33.304"></a><span id="l33.304">                 // If we are within a sorted view, insert at the end</span>
<a href="#l33.305"></a><span id="l33.305">                 index = -1;</span>
<a href="#l33.306"></a><span id="l33.306" class="difflineminus">-              }</span>
<a href="#l33.307"></a><span id="l33.307" class="difflineminus">-              else if (queryOptions.excludeItems ||</span>
<a href="#l33.308"></a><span id="l33.308" class="difflineminus">-                       queryOptions.excludeQueries ||</span>
<a href="#l33.309"></a><span id="l33.309" class="difflineminus">-                       queryOptions.excludeReadOnlyFolders) {</span>
<a href="#l33.310"></a><span id="l33.310" class="difflineplus">+              } else if (queryOptions.excludeItems ||</span>
<a href="#l33.311"></a><span id="l33.311" class="difflineplus">+                         queryOptions.excludeQueries ||</span>
<a href="#l33.312"></a><span id="l33.312" class="difflineplus">+                         queryOptions.excludeReadOnlyFolders) {</span>
<a href="#l33.313"></a><span id="l33.313">                 // Some item may be invisible, insert near last selected one.</span>
<a href="#l33.314"></a><span id="l33.314">                 // We don't replace index here to avoid requests to the db,</span>
<a href="#l33.315"></a><span id="l33.315">                 // instead it will be calculated later by the controller.</span>
<a href="#l33.316"></a><span id="l33.316">                 index = -1;</span>
<a href="#l33.317"></a><span id="l33.317">                 dropNearItemId = lastSelected.itemId;</span>
<a href="#l33.318"></a><span id="l33.318" class="difflineminus">-              }</span>
<a href="#l33.319"></a><span id="l33.319" class="difflineminus">-              else {</span>
<a href="#l33.320"></a><span id="l33.320" class="difflineplus">+              } else {</span>
<a href="#l33.321"></a><span id="l33.321">                 var lsi = container.getChildIndex(lastSelected);</span>
<a href="#l33.322"></a><span id="l33.322">                 index = orientation == Ci.nsITreeView.DROP_BEFORE ? lsi : lsi + 1;</span>
<a href="#l33.323"></a><span id="l33.323">               }</span>
<a href="#l33.324"></a><span id="l33.324">             }</span>
<a href="#l33.325"></a><span id="l33.325">           }</span>
<a href="#l33.326"></a><span id="l33.326"> </span>
<a href="#l33.327"></a><span id="l33.327">           if (PlacesControllerDragHelper.disallowInsertion(container))</span>
<a href="#l33.328"></a><span id="l33.328">             return null;</span>
<a href="#l33.329"></a><span id="l33.329"> </span>
<a href="#l33.330"></a><span id="l33.330" class="difflineplus">+          // TODO (Bug 1160193): properly support dropping on a tag root.</span>
<a href="#l33.331"></a><span id="l33.331" class="difflineplus">+          let tagName = null;</span>
<a href="#l33.332"></a><span id="l33.332" class="difflineplus">+          if (PlacesUtils.nodeIsTagQuery(container)) {</span>
<a href="#l33.333"></a><span id="l33.333" class="difflineplus">+            tagName = container.title;</span>
<a href="#l33.334"></a><span id="l33.334" class="difflineplus">+            if (!tagName)</span>
<a href="#l33.335"></a><span id="l33.335" class="difflineplus">+              return null;</span>
<a href="#l33.336"></a><span id="l33.336" class="difflineplus">+          }</span>
<a href="#l33.337"></a><span id="l33.337" class="difflineplus">+</span>
<a href="#l33.338"></a><span id="l33.338">           return new InsertionPoint(PlacesUtils.getConcreteItemId(container),</span>
<a href="#l33.339"></a><span id="l33.339">                                     index, orientation,</span>
<a href="#l33.340"></a><span id="l33.340" class="difflineminus">-                                    PlacesUtils.nodeIsTagQuery(container),</span>
<a href="#l33.341"></a><span id="l33.341" class="difflineplus">+                                    tagName,</span>
<a href="#l33.342"></a><span id="l33.342">                                     dropNearItemId);</span>
<a href="#l33.343"></a><span id="l33.343">         ]]&gt;&lt;/body&gt;</span>
<a href="#l33.344"></a><span id="l33.344">       &lt;/method&gt;</span>
<a href="#l33.345"></a><span id="l33.345"> </span>
<a href="#l33.346"></a><span id="l33.346">       &lt;!-- nsIPlacesView --&gt;</span>
<a href="#l33.347"></a><span id="l33.347">       &lt;method name=&quot;selectAll&quot;&gt;</span>
<a href="#l33.348"></a><span id="l33.348">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l33.349"></a><span id="l33.349">           this.view.selection.selectAll();</span>
<a href="#l33.350"></a><span id="l33.350">         ]]&gt;&lt;/body&gt;</span>
<a href="#l33.351"></a><span id="l33.351">       &lt;/method&gt;</span>
<a href="#l33.352"></a><span id="l33.352"> </span>
<a href="#l33.353"></a><span id="l33.353">       &lt;!-- This method will select the first node in the tree that matches</span>
<a href="#l33.354"></a><span id="l33.354" class="difflineminus">-           each given item id. It will open any parent nodes that it needs</span>
<a href="#l33.355"></a><span id="l33.355" class="difflineplus">+           each given item id. It will open any folder nodes that it needs</span>
<a href="#l33.356"></a><span id="l33.356">            to in order to show the selected items.</span>
<a href="#l33.357"></a><span id="l33.357">       --&gt;</span>
<a href="#l33.358"></a><span id="l33.358">       &lt;method name=&quot;selectItems&quot;&gt;</span>
<a href="#l33.359"></a><span id="l33.359">         &lt;parameter name=&quot;aIDs&quot;/&gt;</span>
<a href="#l33.360"></a><span id="l33.360">         &lt;parameter name=&quot;aOpenContainers&quot;/&gt;</span>
<a href="#l33.361"></a><span id="l33.361">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l33.362"></a><span id="l33.362" class="difflineplus">+          // Never open containers in flat lists.</span>
<a href="#l33.363"></a><span id="l33.363" class="difflineplus">+          if (this.flatList)</span>
<a href="#l33.364"></a><span id="l33.364" class="difflineplus">+            aOpenContainers = false;</span>
<a href="#l33.365"></a><span id="l33.365">           // By default, we do search and select within containers which were</span>
<a href="#l33.366"></a><span id="l33.366">           // closed (note that containers in which nodes were not found are</span>
<a href="#l33.367"></a><span id="l33.367">           // closed).</span>
<a href="#l33.368"></a><span id="l33.368">           if (aOpenContainers === undefined)</span>
<a href="#l33.369"></a><span id="l33.369">             aOpenContainers = true;</span>
<a href="#l33.370"></a><span id="l33.370"> </span>
<a href="#l33.371"></a><span id="l33.371">           var ids = aIDs; // don't manipulate the caller's array</span>
<a href="#l33.372"></a><span id="l33.372"> </span>
<a href="#l33.373"></a><span id="l33.373">           // Array of nodes found by findNodes which are to be selected</span>
<a href="#l33.374"></a><span id="l33.374">           var nodes = [];</span>
<a href="#l33.375"></a><span id="l33.375"> </span>
<a href="#l33.376"></a><span id="l33.376">           // Array of nodes found by findNodes which should be opened</span>
<a href="#l33.377"></a><span id="l33.377">           var nodesToOpen = [];</span>
<a href="#l33.378"></a><span id="l33.378"> </span>
<a href="#l33.379"></a><span id="l33.379" class="difflineminus">-          // A set of URIs of container-nodes that were previously searched,</span>
<a href="#l33.380"></a><span id="l33.380" class="difflineplus">+          // A set of GUIDs of container-nodes that were previously searched,</span>
<a href="#l33.381"></a><span id="l33.381">           // and thus shouldn't be searched again. This is empty at the initial</span>
<a href="#l33.382"></a><span id="l33.382">           // start of the recursion and gets filled in as the recursion</span>
<a href="#l33.383"></a><span id="l33.383">           // progresses.</span>
<a href="#l33.384"></a><span id="l33.384" class="difflineminus">-          var nodesURIChecked = [];</span>
<a href="#l33.385"></a><span id="l33.385" class="difflineplus">+          var checkedGuidsSet = new Set();</span>
<a href="#l33.386"></a><span id="l33.386"> </span>
<a href="#l33.387"></a><span id="l33.387">           /**</span>
<a href="#l33.388"></a><span id="l33.388">            * Recursively search through a node's children for items</span>
<a href="#l33.389"></a><span id="l33.389">            * with the given IDs. When a matching item is found, remove its ID</span>
<a href="#l33.390"></a><span id="l33.390">            * from the IDs array, and add the found node to the nodes dictionary.</span>
<a href="#l33.391"></a><span id="l33.391">            *</span>
<a href="#l33.392"></a><span id="l33.392">            * NOTE: This method will leave open any node that had matching items</span>
<a href="#l33.393"></a><span id="l33.393">            * in its subtree.</span>
<a href="#l33.394"></a><span id="l33.394" class="difflineat">@@ -567,32 +598,34 @@</span>
<a href="#l33.395"></a><span id="l33.395">               index = ids.indexOf(PlacesUtils.asQuery(node).folderItemId);</span>
<a href="#l33.396"></a><span id="l33.396"> </span>
<a href="#l33.397"></a><span id="l33.397">             if (index != -1) {</span>
<a href="#l33.398"></a><span id="l33.398">               nodes.push(node);</span>
<a href="#l33.399"></a><span id="l33.399">               foundOne = true;</span>
<a href="#l33.400"></a><span id="l33.400">               ids.splice(index, 1);</span>
<a href="#l33.401"></a><span id="l33.401">             }</span>
<a href="#l33.402"></a><span id="l33.402"> </span>
<a href="#l33.403"></a><span id="l33.403" class="difflineplus">+            var concreteGuid = PlacesUtils.getConcreteItemGuid(node);</span>
<a href="#l33.404"></a><span id="l33.404">             if (ids.length == 0 || !PlacesUtils.nodeIsContainer(node) ||</span>
<a href="#l33.405"></a><span id="l33.405" class="difflineminus">-                nodesURIChecked.indexOf(node.uri) != -1)</span>
<a href="#l33.406"></a><span id="l33.406" class="difflineplus">+                checkedGuidsSet.has(concreteGuid))</span>
<a href="#l33.407"></a><span id="l33.407">               return foundOne;</span>
<a href="#l33.408"></a><span id="l33.408"> </span>
<a href="#l33.409"></a><span id="l33.409" class="difflineplus">+            // Only follow a query if it has been been explicitly opened by the caller.</span>
<a href="#l33.410"></a><span id="l33.410" class="difflineplus">+            let shouldOpen = aOpenContainers &amp;&amp; PlacesUtils.nodeIsFolder(node);</span>
<a href="#l33.411"></a><span id="l33.411">             PlacesUtils.asContainer(node);</span>
<a href="#l33.412"></a><span id="l33.412" class="difflineminus">-            if (!aOpenContainers &amp;&amp; !node.containerOpen)</span>
<a href="#l33.413"></a><span id="l33.413" class="difflineplus">+            if (!node.containerOpen &amp;&amp; !shouldOpen)</span>
<a href="#l33.414"></a><span id="l33.414">               return foundOne;</span>
<a href="#l33.415"></a><span id="l33.415"> </span>
<a href="#l33.416"></a><span id="l33.416" class="difflineminus">-            nodesURIChecked.push(node.uri);</span>
<a href="#l33.417"></a><span id="l33.417" class="difflineplus">+            checkedGuidsSet.add(concreteGuid);</span>
<a href="#l33.418"></a><span id="l33.418"> </span>
<a href="#l33.419"></a><span id="l33.419">             // Remember the beginning state so that we can re-close</span>
<a href="#l33.420"></a><span id="l33.420">             // this node if we don't find any additional results here.</span>
<a href="#l33.421"></a><span id="l33.421">             var previousOpenness = node.containerOpen;</span>
<a href="#l33.422"></a><span id="l33.422">             node.containerOpen = true;</span>
<a href="#l33.423"></a><span id="l33.423" class="difflineminus">-            for (var child = 0;  child &lt; node.childCount &amp;&amp; ids.length &gt; 0;</span>
<a href="#l33.424"></a><span id="l33.424" class="difflineminus">-                 child++) {</span>
<a href="#l33.425"></a><span id="l33.425" class="difflineplus">+            for (var child = 0; child &lt; node.childCount &amp;&amp; ids.length &gt; 0; child++) {</span>
<a href="#l33.426"></a><span id="l33.426">               var childNode = node.getChild(child);</span>
<a href="#l33.427"></a><span id="l33.427">               var found = findNodes(childNode);</span>
<a href="#l33.428"></a><span id="l33.428">               if (!foundOne)</span>
<a href="#l33.429"></a><span id="l33.429">                 foundOne = found;</span>
<a href="#l33.430"></a><span id="l33.430">             }</span>
<a href="#l33.431"></a><span id="l33.431"> </span>
<a href="#l33.432"></a><span id="l33.432">             // If we didn't find any additional matches in this node's</span>
<a href="#l33.433"></a><span id="l33.433">             // subtree, revert the node to its previous openness.</span>
<a href="#l33.434"></a><span id="l33.434" class="difflineat">@@ -604,33 +637,32 @@</span>
<a href="#l33.435"></a><span id="l33.435"> </span>
<a href="#l33.436"></a><span id="l33.436">           // Disable notifications while looking for nodes.</span>
<a href="#l33.437"></a><span id="l33.437">           let result = this.result;</span>
<a href="#l33.438"></a><span id="l33.438">           let didSuppressNotifications = result.suppressNotifications;</span>
<a href="#l33.439"></a><span id="l33.439">           if (!didSuppressNotifications)</span>
<a href="#l33.440"></a><span id="l33.440">             result.suppressNotifications = true</span>
<a href="#l33.441"></a><span id="l33.441">           try {</span>
<a href="#l33.442"></a><span id="l33.442">             findNodes(this.result.root);</span>
<a href="#l33.443"></a><span id="l33.443" class="difflineminus">-          }</span>
<a href="#l33.444"></a><span id="l33.444" class="difflineminus">-          finally {</span>
<a href="#l33.445"></a><span id="l33.445" class="difflineplus">+          } finally {</span>
<a href="#l33.446"></a><span id="l33.446">             if (!didSuppressNotifications)</span>
<a href="#l33.447"></a><span id="l33.447">               result.suppressNotifications = false;</span>
<a href="#l33.448"></a><span id="l33.448">           }</span>
<a href="#l33.449"></a><span id="l33.449"> </span>
<a href="#l33.450"></a><span id="l33.450">           // For all the nodes we've found, highlight the corresponding</span>
<a href="#l33.451"></a><span id="l33.451">           // index in the tree.</span>
<a href="#l33.452"></a><span id="l33.452">           var resultview = this.view;</span>
<a href="#l33.453"></a><span id="l33.453">           var selection = this.view.selection;</span>
<a href="#l33.454"></a><span id="l33.454">           selection.selectEventsSuppressed = true;</span>
<a href="#l33.455"></a><span id="l33.455">           selection.clearSelection();</span>
<a href="#l33.456"></a><span id="l33.456">           // Open nodes containing found items</span>
<a href="#l33.457"></a><span id="l33.457" class="difflineminus">-          for (var i = 0; i &lt; nodesToOpen.length; i++) {</span>
<a href="#l33.458"></a><span id="l33.458" class="difflineplus">+          for (let i = 0; i &lt; nodesToOpen.length; i++) {</span>
<a href="#l33.459"></a><span id="l33.459">             nodesToOpen[i].containerOpen = true;</span>
<a href="#l33.460"></a><span id="l33.460">           }</span>
<a href="#l33.461"></a><span id="l33.461" class="difflineminus">-          for (var i = 0; i &lt; nodes.length; i++) {</span>
<a href="#l33.462"></a><span id="l33.462" class="difflineplus">+          for (let i = 0; i &lt; nodes.length; i++) {</span>
<a href="#l33.463"></a><span id="l33.463">             var index = resultview.treeIndexForNode(nodes[i]);</span>
<a href="#l33.464"></a><span id="l33.464">             if (index == Ci.nsINavHistoryResultTreeViewer.INDEX_INVISIBLE)</span>
<a href="#l33.465"></a><span id="l33.465">               continue;</span>
<a href="#l33.466"></a><span id="l33.466">             selection.rangedSelect(index, index, true);</span>
<a href="#l33.467"></a><span id="l33.467">           }</span>
<a href="#l33.468"></a><span id="l33.468">           selection.selectEventsSuppressed = false;</span>
<a href="#l33.469"></a><span id="l33.469">         ]]&gt;&lt;/body&gt;</span>
<a href="#l33.470"></a><span id="l33.470">       &lt;/method&gt;</span>
<a href="#l33.471"></a><span id="l33.471" class="difflineat">@@ -645,16 +677,26 @@</span>
<a href="#l33.472"></a><span id="l33.472">         ]]&gt;&lt;/body&gt;</span>
<a href="#l33.473"></a><span id="l33.473">       &lt;/method&gt;</span>
<a href="#l33.474"></a><span id="l33.474"> </span>
<a href="#l33.475"></a><span id="l33.475">       &lt;method name=&quot;destroyContextMenu&quot;&gt;</span>
<a href="#l33.476"></a><span id="l33.476">         &lt;parameter name=&quot;aPopup&quot;/&gt;</span>
<a href="#l33.477"></a><span id="l33.477">           this._contextMenuShown = false;</span>
<a href="#l33.478"></a><span id="l33.478">         &lt;body/&gt;</span>
<a href="#l33.479"></a><span id="l33.479">       &lt;/method&gt;</span>
<a href="#l33.480"></a><span id="l33.480" class="difflineplus">+</span>
<a href="#l33.481"></a><span id="l33.481" class="difflineplus">+      &lt;property name=&quot;ownerWindow&quot;</span>
<a href="#l33.482"></a><span id="l33.482" class="difflineplus">+                readonly=&quot;true&quot;</span>
<a href="#l33.483"></a><span id="l33.483" class="difflineplus">+                onget=&quot;return window;&quot;/&gt;</span>
<a href="#l33.484"></a><span id="l33.484" class="difflineplus">+</span>
<a href="#l33.485"></a><span id="l33.485" class="difflineplus">+      &lt;field name=&quot;_active&quot;&gt;true&lt;/field&gt;</span>
<a href="#l33.486"></a><span id="l33.486" class="difflineplus">+      &lt;property name=&quot;active&quot;</span>
<a href="#l33.487"></a><span id="l33.487" class="difflineplus">+                onget=&quot;return this._active&quot;</span>
<a href="#l33.488"></a><span id="l33.488" class="difflineplus">+                onset=&quot;return this._active = val&quot;/&gt;</span>
<a href="#l33.489"></a><span id="l33.489" class="difflineplus">+</span>
<a href="#l33.490"></a><span id="l33.490">     &lt;/implementation&gt;</span>
<a href="#l33.491"></a><span id="l33.491">     &lt;handlers&gt;</span>
<a href="#l33.492"></a><span id="l33.492">       &lt;handler event=&quot;focus&quot;&gt;&lt;![CDATA[</span>
<a href="#l33.493"></a><span id="l33.493">         this._cachedInsertionPoint = undefined;</span>
<a href="#l33.494"></a><span id="l33.494"> </span>
<a href="#l33.495"></a><span id="l33.495">         // See select handler. We need the sidebar's places commandset to be</span>
<a href="#l33.496"></a><span id="l33.496">         // updated as well</span>
<a href="#l33.497"></a><span id="l33.497">         document.commandDispatcher.updateCommands(&quot;focus&quot;);</span>
<a href="#l33.498"></a><span id="l33.498" class="difflineat">@@ -718,24 +760,22 @@</span>
<a href="#l33.499"></a><span id="l33.499">         let eventY = event.clientY - tbo.treeBody.boxObject.y -</span>
<a href="#l33.500"></a><span id="l33.500">                      rowHeight * (cell.row - tbo.getFirstVisibleRow());</span>
<a href="#l33.501"></a><span id="l33.501"> </span>
<a href="#l33.502"></a><span id="l33.502">         let orientation = Ci.nsITreeView.DROP_BEFORE;</span>
<a href="#l33.503"></a><span id="l33.503"> </span>
<a href="#l33.504"></a><span id="l33.504">         if (cell.row == -1) {</span>
<a href="#l33.505"></a><span id="l33.505">           // If the row is not valid we try to insert inside the resultNode.</span>
<a href="#l33.506"></a><span id="l33.506">           orientation = Ci.nsITreeView.DROP_ON;</span>
<a href="#l33.507"></a><span id="l33.507" class="difflineminus">-        }</span>
<a href="#l33.508"></a><span id="l33.508" class="difflineminus">-        else if (PlacesUtils.nodeIsContainer(node) &amp;&amp;</span>
<a href="#l33.509"></a><span id="l33.509" class="difflineplus">+        } else if (PlacesUtils.nodeIsContainer(node) &amp;&amp;</span>
<a href="#l33.510"></a><span id="l33.510">                  eventY &gt; rowHeight * 0.75) {</span>
<a href="#l33.511"></a><span id="l33.511">           // If we are below the 75% of a container the treeview we try</span>
<a href="#l33.512"></a><span id="l33.512">           // to drop after the node.</span>
<a href="#l33.513"></a><span id="l33.513">           orientation = Ci.nsITreeView.DROP_AFTER;</span>
<a href="#l33.514"></a><span id="l33.514" class="difflineminus">-        }</span>
<a href="#l33.515"></a><span id="l33.515" class="difflineminus">-        else if (PlacesUtils.nodeIsContainer(node) &amp;&amp;</span>
<a href="#l33.516"></a><span id="l33.516" class="difflineplus">+        } else if (PlacesUtils.nodeIsContainer(node) &amp;&amp;</span>
<a href="#l33.517"></a><span id="l33.517">                  eventY &gt; rowHeight * 0.25) {</span>
<a href="#l33.518"></a><span id="l33.518">           // If we are below the 25% of a container the treeview we try</span>
<a href="#l33.519"></a><span id="l33.519">           // to drop inside the node.</span>
<a href="#l33.520"></a><span id="l33.520">           orientation = Ci.nsITreeView.DROP_ON;</span>
<a href="#l33.521"></a><span id="l33.521">         }</span>
<a href="#l33.522"></a><span id="l33.522"> </span>
<a href="#l33.523"></a><span id="l33.523">         if (!this.view.canDrop(cell.row, orientation, event.dataTransfer))</span>
<a href="#l33.524"></a><span id="l33.524">           return;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l34.1"></a><span id="l34.1" class="difflineminus">--- a/suite/common/places/content/treeView.js</span>
<a href="#l34.2"></a><span id="l34.2" class="difflineplus">+++ b/suite/common/places/content/treeView.js</span>
<a href="#l34.3"></a><span id="l34.3" class="difflineat">@@ -1,16 +1,21 @@</span>
<a href="#l34.4"></a><span id="l34.4" class="difflineminus">-/* -*- Mode: C++; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l34.5"></a><span id="l34.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l34.6"></a><span id="l34.6" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l34.7"></a><span id="l34.7" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l34.8"></a><span id="l34.8" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l34.9"></a><span id="l34.9" class="difflineplus">+ * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l34.10"></a><span id="l34.10"> </span>
<a href="#l34.11"></a><span id="l34.11" class="difflineplus">+ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l34.12"></a><span id="l34.12"> ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l34.13"></a><span id="l34.13"> </span>
<a href="#l34.14"></a><span id="l34.14" class="difflineminus">- /**</span>
<a href="#l34.15"></a><span id="l34.15" class="difflineplus">+const PTV_interfaces = [Ci.nsITreeView,</span>
<a href="#l34.16"></a><span id="l34.16" class="difflineplus">+                        Ci.nsINavHistoryResultObserver,</span>
<a href="#l34.17"></a><span id="l34.17" class="difflineplus">+                        Ci.nsINavHistoryResultTreeViewer,</span>
<a href="#l34.18"></a><span id="l34.18" class="difflineplus">+                        Ci.nsISupportsWeakReference];</span>
<a href="#l34.19"></a><span id="l34.19" class="difflineplus">+</span>
<a href="#l34.20"></a><span id="l34.20" class="difflineplus">+/**</span>
<a href="#l34.21"></a><span id="l34.21">  * This returns the key for any node/details object.</span>
<a href="#l34.22"></a><span id="l34.22">  *</span>
<a href="#l34.23"></a><span id="l34.23">  * @param nodeOrDetails</span>
<a href="#l34.24"></a><span id="l34.24">  *        A node, or an object containing the following properties:</span>
<a href="#l34.25"></a><span id="l34.25">  *        - uri</span>
<a href="#l34.26"></a><span id="l34.26">  *        - time</span>
<a href="#l34.27"></a><span id="l34.27">  *        - itemId</span>
<a href="#l34.28"></a><span id="l34.28">  *        In case any of these is missing, an empty string will be returned. This is</span>
<a href="#l34.29"></a><span id="l34.29" class="difflineat">@@ -25,64 +30,84 @@ function makeNodeDetailsKey(nodeOrDetail</span>
<a href="#l34.30"></a><span id="l34.30">       &quot;uri&quot; in nodeOrDetails &amp;&amp;</span>
<a href="#l34.31"></a><span id="l34.31">       &quot;time&quot; in nodeOrDetails &amp;&amp;</span>
<a href="#l34.32"></a><span id="l34.32">       &quot;itemId&quot; in nodeOrDetails) {</span>
<a href="#l34.33"></a><span id="l34.33">     return `${nodeOrDetails.uri}*${nodeOrDetails.time}*${nodeOrDetails.itemId}`;</span>
<a href="#l34.34"></a><span id="l34.34">   }</span>
<a href="#l34.35"></a><span id="l34.35">   return &quot;&quot;;</span>
<a href="#l34.36"></a><span id="l34.36"> }</span>
<a href="#l34.37"></a><span id="l34.37"> </span>
<a href="#l34.38"></a><span id="l34.38" class="difflineminus">-</span>
<a href="#l34.39"></a><span id="l34.39"> function PlacesTreeView(aFlatList, aOnOpenFlatContainer, aController) {</span>
<a href="#l34.40"></a><span id="l34.40">   this._tree = null;</span>
<a href="#l34.41"></a><span id="l34.41">   this._result = null;</span>
<a href="#l34.42"></a><span id="l34.42">   this._selection = null;</span>
<a href="#l34.43"></a><span id="l34.43">   this._rootNode = null;</span>
<a href="#l34.44"></a><span id="l34.44">   this._rows = [];</span>
<a href="#l34.45"></a><span id="l34.45" class="difflineplus">+  this._flatList = aFlatList;</span>
<a href="#l34.46"></a><span id="l34.46">   this._nodeDetails = new Map();</span>
<a href="#l34.47"></a><span id="l34.47" class="difflineminus">-  this._flatList = aFlatList;</span>
<a href="#l34.48"></a><span id="l34.48">   this._openContainerCallback = aOnOpenFlatContainer;</span>
<a href="#l34.49"></a><span id="l34.49">   this._controller = aController;</span>
<a href="#l34.50"></a><span id="l34.50"> }</span>
<a href="#l34.51"></a><span id="l34.51"> </span>
<a href="#l34.52"></a><span id="l34.52"> PlacesTreeView.prototype = {</span>
<a href="#l34.53"></a><span id="l34.53" class="difflineplus">+  get wrappedJSObject() {</span>
<a href="#l34.54"></a><span id="l34.54" class="difflineplus">+    return this;</span>
<a href="#l34.55"></a><span id="l34.55" class="difflineplus">+  },</span>
<a href="#l34.56"></a><span id="l34.56"> </span>
<a href="#l34.57"></a><span id="l34.57" class="difflineminus">-  QueryInterface: function PTV_QueryInterface(aIID) {</span>
<a href="#l34.58"></a><span id="l34.58" class="difflineminus">-    if (aIID.equals(Ci.nsITreeView) ||</span>
<a href="#l34.59"></a><span id="l34.59" class="difflineminus">-        aIID.equals(Ci.nsINavHistoryResultObserver) ||</span>
<a href="#l34.60"></a><span id="l34.60" class="difflineminus">-        aIID.equals(Ci.nsINavHistoryResultTreeViewer) ||</span>
<a href="#l34.61"></a><span id="l34.61" class="difflineminus">-        aIID.equals(Ci.nsISupportsWeakReference) ||</span>
<a href="#l34.62"></a><span id="l34.62" class="difflineminus">-        aIID.equals(Ci.nsISupports))</span>
<a href="#l34.63"></a><span id="l34.63" class="difflineminus">-      return this;</span>
<a href="#l34.64"></a><span id="l34.64" class="difflineplus">+  __xulStore: null,</span>
<a href="#l34.65"></a><span id="l34.65" class="difflineplus">+  get _xulStore() {</span>
<a href="#l34.66"></a><span id="l34.66" class="difflineplus">+    if (!this.__xulStore) {</span>
<a href="#l34.67"></a><span id="l34.67" class="difflineplus">+      this.__xulStore = Cc[&quot;@mozilla.org/xul/xulstore;1&quot;].getService(Ci.nsIXULStore);</span>
<a href="#l34.68"></a><span id="l34.68" class="difflineplus">+    }</span>
<a href="#l34.69"></a><span id="l34.69" class="difflineplus">+    return this.__xulStore;</span>
<a href="#l34.70"></a><span id="l34.70" class="difflineplus">+  },</span>
<a href="#l34.71"></a><span id="l34.71" class="difflineplus">+</span>
<a href="#l34.72"></a><span id="l34.72" class="difflineplus">+  QueryInterface: XPCOMUtils.generateQI(PTV_interfaces),</span>
<a href="#l34.73"></a><span id="l34.73"> </span>
<a href="#l34.74"></a><span id="l34.74" class="difflineminus">-    throw Cr.NS_ERROR_NO_INTERFACE;</span>
<a href="#l34.75"></a><span id="l34.75" class="difflineminus">-  },</span>
<a href="#l34.76"></a><span id="l34.76" class="difflineplus">+  // Bug 761494:</span>
<a href="#l34.77"></a><span id="l34.77" class="difflineplus">+  // ----------</span>
<a href="#l34.78"></a><span id="l34.78" class="difflineplus">+  // Some addons use methods from nsINavHistoryResultObserver and</span>
<a href="#l34.79"></a><span id="l34.79" class="difflineplus">+  // nsINavHistoryResultTreeViewer, without QIing to these interfaces first.</span>
<a href="#l34.80"></a><span id="l34.80" class="difflineplus">+  // That's not a problem when the view is retrieved through the</span>
<a href="#l34.81"></a><span id="l34.81" class="difflineplus">+  // &lt;tree&gt;.view getter (which returns the wrappedJSObject of this object),</span>
<a href="#l34.82"></a><span id="l34.82" class="difflineplus">+  // it raises an issue when the view retrieved through the treeBoxObject.view</span>
<a href="#l34.83"></a><span id="l34.83" class="difflineplus">+  // getter.  Thus, to avoid breaking addons, the interfaces are prefetched.</span>
<a href="#l34.84"></a><span id="l34.84" class="difflineplus">+  classInfo: XPCOMUtils.generateCI({ interfaces: PTV_interfaces }),</span>
<a href="#l34.85"></a><span id="l34.85"> </span>
<a href="#l34.86"></a><span id="l34.86">   /**</span>
<a href="#l34.87"></a><span id="l34.87">    * This is called once both the result and the tree are set.</span>
<a href="#l34.88"></a><span id="l34.88">    */</span>
<a href="#l34.89"></a><span id="l34.89">   _finishInit: function PTV__finishInit() {</span>
<a href="#l34.90"></a><span id="l34.90">     let selection = this.selection;</span>
<a href="#l34.91"></a><span id="l34.91">     if (selection)</span>
<a href="#l34.92"></a><span id="l34.92">       selection.selectEventsSuppressed = true;</span>
<a href="#l34.93"></a><span id="l34.93"> </span>
<a href="#l34.94"></a><span id="l34.94">     if (!this._rootNode.containerOpen) {</span>
<a href="#l34.95"></a><span id="l34.95" class="difflineminus">-      // This triggers containerStateChanged which then builds the visible section.</span>
<a href="#l34.96"></a><span id="l34.96" class="difflineplus">+      // This triggers containerStateChanged which then builds the visible</span>
<a href="#l34.97"></a><span id="l34.97" class="difflineplus">+      // section.</span>
<a href="#l34.98"></a><span id="l34.98">       this._rootNode.containerOpen = true;</span>
<a href="#l34.99"></a><span id="l34.99" class="difflineminus">-    }</span>
<a href="#l34.100"></a><span id="l34.100" class="difflineminus">-    else</span>
<a href="#l34.101"></a><span id="l34.101" class="difflineplus">+    } else</span>
<a href="#l34.102"></a><span id="l34.102">       this.invalidateContainer(this._rootNode);</span>
<a href="#l34.103"></a><span id="l34.103"> </span>
<a href="#l34.104"></a><span id="l34.104">     // &quot;Activate&quot; the sorting column and update commands.</span>
<a href="#l34.105"></a><span id="l34.105">     this.sortingChanged(this._result.sortingMode);</span>
<a href="#l34.106"></a><span id="l34.106"> </span>
<a href="#l34.107"></a><span id="l34.107">     if (selection)</span>
<a href="#l34.108"></a><span id="l34.108">       selection.selectEventsSuppressed = false;</span>
<a href="#l34.109"></a><span id="l34.109">   },</span>
<a href="#l34.110"></a><span id="l34.110"> </span>
<a href="#l34.111"></a><span id="l34.111" class="difflineplus">+  uninit() {</span>
<a href="#l34.112"></a><span id="l34.112" class="difflineplus">+    if (this._editingObservers) {</span>
<a href="#l34.113"></a><span id="l34.113" class="difflineplus">+      for (let observer of this._editingObservers.values()) {</span>
<a href="#l34.114"></a><span id="l34.114" class="difflineplus">+        observer.disconnect();</span>
<a href="#l34.115"></a><span id="l34.115" class="difflineplus">+      }</span>
<a href="#l34.116"></a><span id="l34.116" class="difflineplus">+      delete this._editingObservers;</span>
<a href="#l34.117"></a><span id="l34.117" class="difflineplus">+    }</span>
<a href="#l34.118"></a><span id="l34.118" class="difflineplus">+  },</span>
<a href="#l34.119"></a><span id="l34.119" class="difflineplus">+</span>
<a href="#l34.120"></a><span id="l34.120">   /**</span>
<a href="#l34.121"></a><span id="l34.121">    * Plain Container: container result nodes which may never include sub</span>
<a href="#l34.122"></a><span id="l34.122">    * hierarchies.</span>
<a href="#l34.123"></a><span id="l34.123">    *</span>
<a href="#l34.124"></a><span id="l34.124">    * When the rows array is constructed, we don't set the children of plain</span>
<a href="#l34.125"></a><span id="l34.125">    * containers.  Instead, we keep placeholders for these children.  We then</span>
<a href="#l34.126"></a><span id="l34.126">    * build these children lazily as the tree asks us for information about each</span>
<a href="#l34.127"></a><span id="l34.127">    * row.  Luckily, the tree doesn't ask about rows outside the visible area.</span>
<a href="#l34.128"></a><span id="l34.128" class="difflineat">@@ -147,17 +172,17 @@ PlacesTreeView.prototype = {</span>
<a href="#l34.129"></a><span id="l34.129">    * @return aNode's row if it's in the rows list or if aForceBuild is set, -1</span>
<a href="#l34.130"></a><span id="l34.130">    *         otherwise.</span>
<a href="#l34.131"></a><span id="l34.131">    */</span>
<a href="#l34.132"></a><span id="l34.132">   _getRowForNode:</span>
<a href="#l34.133"></a><span id="l34.133">   function PTV__getRowForNode(aNode, aForceBuild, aParentRow, aNodeIndex) {</span>
<a href="#l34.134"></a><span id="l34.134">     if (aNode == this._rootNode)</span>
<a href="#l34.135"></a><span id="l34.135">       throw new Error(&quot;The root node is never visible&quot;);</span>
<a href="#l34.136"></a><span id="l34.136"> </span>
<a href="#l34.137"></a><span id="l34.137" class="difflineminus">-    // A node is removed from the view either if it has no parent or if its</span>
<a href="#l34.138"></a><span id="l34.138" class="difflineplus">+    // A node is removed form the view either if it has no parent or if its</span>
<a href="#l34.139"></a><span id="l34.139">     // root-ancestor is not the root node (in which case that's the node</span>
<a href="#l34.140"></a><span id="l34.140">     // for which nodeRemoved was called).</span>
<a href="#l34.141"></a><span id="l34.141">     let ancestors = Array.from(PlacesUtils.nodeAncestors(aNode));</span>
<a href="#l34.142"></a><span id="l34.142">     if (ancestors.length == 0 ||</span>
<a href="#l34.143"></a><span id="l34.143">         ancestors[ancestors.length - 1] != this._rootNode) {</span>
<a href="#l34.144"></a><span id="l34.144">       throw new Error(&quot;Removed node passed to _getRowForNode&quot;);</span>
<a href="#l34.145"></a><span id="l34.145">     }</span>
<a href="#l34.146"></a><span id="l34.146"> </span>
<a href="#l34.147"></a><span id="l34.147" class="difflineat">@@ -174,24 +199,23 @@ PlacesTreeView.prototype = {</span>
<a href="#l34.148"></a><span id="l34.148">       if (parent == this._rootNode)</span>
<a href="#l34.149"></a><span id="l34.149">         return this._rows.indexOf(aNode);</span>
<a href="#l34.150"></a><span id="l34.150"> </span>
<a href="#l34.151"></a><span id="l34.151">       return this._rows.indexOf(aNode, aParentRow);</span>
<a href="#l34.152"></a><span id="l34.152">     }</span>
<a href="#l34.153"></a><span id="l34.153"> </span>
<a href="#l34.154"></a><span id="l34.154">     let row = -1;</span>
<a href="#l34.155"></a><span id="l34.155">     let useNodeIndex = typeof(aNodeIndex) == &quot;number&quot;;</span>
<a href="#l34.156"></a><span id="l34.156" class="difflineminus">-    if (parent == this._rootNode)</span>
<a href="#l34.157"></a><span id="l34.157" class="difflineplus">+    if (parent == this._rootNode) {</span>
<a href="#l34.158"></a><span id="l34.158">       row = useNodeIndex ? aNodeIndex : this._rootNode.getChildIndex(aNode);</span>
<a href="#l34.159"></a><span id="l34.159" class="difflineminus">-    else if (useNodeIndex &amp;&amp; typeof(aParentRow) == &quot;number&quot;) {</span>
<a href="#l34.160"></a><span id="l34.160" class="difflineplus">+    } else if (useNodeIndex &amp;&amp; typeof(aParentRow) == &quot;number&quot;) {</span>
<a href="#l34.161"></a><span id="l34.161">       // If we have both the row of the parent node, and the node's index, we</span>
<a href="#l34.162"></a><span id="l34.162">       // can avoid searching the rows array if the parent is a plain container.</span>
<a href="#l34.163"></a><span id="l34.163">       row = aParentRow + aNodeIndex + 1;</span>
<a href="#l34.164"></a><span id="l34.164" class="difflineminus">-    }</span>
<a href="#l34.165"></a><span id="l34.165" class="difflineminus">-    else {</span>
<a href="#l34.166"></a><span id="l34.166" class="difflineplus">+    } else {</span>
<a href="#l34.167"></a><span id="l34.167">       // Look for the node in the nodes array.  Start the search at the parent</span>
<a href="#l34.168"></a><span id="l34.168">       // row.  If the parent row isn't passed, we'll pass undefined to indexOf,</span>
<a href="#l34.169"></a><span id="l34.169">       // which is fine.</span>
<a href="#l34.170"></a><span id="l34.170">       row = this._rows.indexOf(aNode, aParentRow);</span>
<a href="#l34.171"></a><span id="l34.171">       if (row == -1 &amp;&amp; aForceBuild) {</span>
<a href="#l34.172"></a><span id="l34.172">         let parentRow = typeof(aParentRow) == &quot;number&quot; ? aParentRow</span>
<a href="#l34.173"></a><span id="l34.173">                                                        : this._getRowForNode(parent);</span>
<a href="#l34.174"></a><span id="l34.174">         row = parentRow + parent.getChildIndex(aNode) + 1;</span>
<a href="#l34.175"></a><span id="l34.175" class="difflineat">@@ -281,33 +305,30 @@ PlacesTreeView.prototype = {</span>
<a href="#l34.176"></a><span id="l34.176">    *        The first row at which nodes may be inserted to the row array.</span>
<a href="#l34.177"></a><span id="l34.177">    *        In other words, that's aContainer's row + 1.</span>
<a href="#l34.178"></a><span id="l34.178">    * @param [out] aToOpen</span>
<a href="#l34.179"></a><span id="l34.179">    *        An array of containers to open once the build is done.</span>
<a href="#l34.180"></a><span id="l34.180">    *</span>
<a href="#l34.181"></a><span id="l34.181">    * @return the number of rows which were inserted.</span>
<a href="#l34.182"></a><span id="l34.182">    */</span>
<a href="#l34.183"></a><span id="l34.183">   _buildVisibleSection:</span>
<a href="#l34.184"></a><span id="l34.184" class="difflineminus">-  function PTV__buildVisibleSection(aContainer, aFirstChildRow, aToOpen)</span>
<a href="#l34.185"></a><span id="l34.185" class="difflineminus">-  {</span>
<a href="#l34.186"></a><span id="l34.186" class="difflineplus">+  function PTV__buildVisibleSection(aContainer, aFirstChildRow, aToOpen) {</span>
<a href="#l34.187"></a><span id="l34.187">     // There's nothing to do if the container is closed.</span>
<a href="#l34.188"></a><span id="l34.188">     if (!aContainer.containerOpen)</span>
<a href="#l34.189"></a><span id="l34.189">       return 0;</span>
<a href="#l34.190"></a><span id="l34.190"> </span>
<a href="#l34.191"></a><span id="l34.191">     // Inserting the new elements into the rows array in one shot (by</span>
<a href="#l34.192"></a><span id="l34.192" class="difflineminus">-    // Array.prototype.concat) is faster than resizing the array (by splice) on</span>
<a href="#l34.193"></a><span id="l34.193" class="difflineminus">-    // each loop iteration.</span>
<a href="#l34.194"></a><span id="l34.194" class="difflineplus">+    // Array.prototype.concat) is faster than resizing the array (by splice) on each loop</span>
<a href="#l34.195"></a><span id="l34.195" class="difflineplus">+    // iteration.</span>
<a href="#l34.196"></a><span id="l34.196">     let cc = aContainer.childCount;</span>
<a href="#l34.197"></a><span id="l34.197">     let newElements = new Array(cc);</span>
<a href="#l34.198"></a><span id="l34.198" class="difflineminus">-</span>
<a href="#l34.199"></a><span id="l34.199">     // We need to clean up the node details from aFirstChildRow + 1 to the end of rows.</span>
<a href="#l34.200"></a><span id="l34.200">     for (let i = aFirstChildRow + 1; i &lt; this._rows.length; i++) {</span>
<a href="#l34.201"></a><span id="l34.201">       this._nodeDetails.delete(makeNodeDetailsKey(this._rows[i]));</span>
<a href="#l34.202"></a><span id="l34.202">     }</span>
<a href="#l34.203"></a><span id="l34.203" class="difflineminus">-</span>
<a href="#l34.204"></a><span id="l34.204">     this._rows = this._rows.splice(0, aFirstChildRow)</span>
<a href="#l34.205"></a><span id="l34.205">                      .concat(newElements, this._rows);</span>
<a href="#l34.206"></a><span id="l34.206"> </span>
<a href="#l34.207"></a><span id="l34.207">     if (this._isPlainContainer(aContainer))</span>
<a href="#l34.208"></a><span id="l34.208">       return cc;</span>
<a href="#l34.209"></a><span id="l34.209"> </span>
<a href="#l34.210"></a><span id="l34.210">     let sortingMode = this._result.sortingMode;</span>
<a href="#l34.211"></a><span id="l34.211"> </span>
<a href="#l34.212"></a><span id="l34.212" class="difflineat">@@ -334,19 +355,24 @@ PlacesTreeView.prototype = {</span>
<a href="#l34.213"></a><span id="l34.213">       this._nodeDetails.set(makeNodeDetailsKey(curChild), curChild);</span>
<a href="#l34.214"></a><span id="l34.214">       this._rows[row] = curChild;</span>
<a href="#l34.215"></a><span id="l34.215">       rowsInserted++;</span>
<a href="#l34.216"></a><span id="l34.216"> </span>
<a href="#l34.217"></a><span id="l34.217">       // Recursively do containers.</span>
<a href="#l34.218"></a><span id="l34.218">       if (!this._flatList &amp;&amp;</span>
<a href="#l34.219"></a><span id="l34.219">           curChild instanceof Ci.nsINavHistoryContainerResultNode &amp;&amp;</span>
<a href="#l34.220"></a><span id="l34.220">           !this._controller.hasCachedLivemarkInfo(curChild)) {</span>
<a href="#l34.221"></a><span id="l34.221" class="difflineminus">-        NS_ASSERT(curChild.uri, &quot;if there is no uri, we can't persist the open state&quot;);</span>
<a href="#l34.222"></a><span id="l34.222" class="difflineminus">-        let isopen = curChild.uri &amp;&amp;</span>
<a href="#l34.223"></a><span id="l34.223" class="difflineminus">-                     PlacesUIUtils.xulStore.hasValue(location, curChild.uri, &quot;open&quot;);</span>
<a href="#l34.224"></a><span id="l34.224" class="difflineplus">+        let uri = curChild.uri;</span>
<a href="#l34.225"></a><span id="l34.225" class="difflineplus">+        let isopen = false;</span>
<a href="#l34.226"></a><span id="l34.226" class="difflineplus">+</span>
<a href="#l34.227"></a><span id="l34.227" class="difflineplus">+        if (uri) {</span>
<a href="#l34.228"></a><span id="l34.228" class="difflineplus">+          let val = this._xulStore.getValue(document.documentURI, uri, &quot;open&quot;);</span>
<a href="#l34.229"></a><span id="l34.229" class="difflineplus">+          isopen = (val == &quot;true&quot;);</span>
<a href="#l34.230"></a><span id="l34.230" class="difflineplus">+        }</span>
<a href="#l34.231"></a><span id="l34.231" class="difflineplus">+</span>
<a href="#l34.232"></a><span id="l34.232">         if (isopen != curChild.containerOpen)</span>
<a href="#l34.233"></a><span id="l34.233">           aToOpen.push(curChild);</span>
<a href="#l34.234"></a><span id="l34.234">         else if (curChild.containerOpen &amp;&amp; curChild.childCount &gt; 0)</span>
<a href="#l34.235"></a><span id="l34.235">           rowsInserted += this._buildVisibleSection(curChild, row + 1, aToOpen);</span>
<a href="#l34.236"></a><span id="l34.236">       }</span>
<a href="#l34.237"></a><span id="l34.237">     }</span>
<a href="#l34.238"></a><span id="l34.238"> </span>
<a href="#l34.239"></a><span id="l34.239">     return rowsInserted;</span>
<a href="#l34.240"></a><span id="l34.240" class="difflineat">@@ -476,32 +502,34 @@ PlacesTreeView.prototype = {</span>
<a href="#l34.241"></a><span id="l34.241">     let selection = this.selection;</span>
<a href="#l34.242"></a><span id="l34.242"> </span>
<a href="#l34.243"></a><span id="l34.243">     // Attempt to ensure that previously-visible selection will be visible</span>
<a href="#l34.244"></a><span id="l34.244">     // if it's re-selected.  However, we can only ensure that for one row.</span>
<a href="#l34.245"></a><span id="l34.245">     let scrollToRow = -1;</span>
<a href="#l34.246"></a><span id="l34.246">     for (let i = 0; i &lt; aNodesInfo.length; i++) {</span>
<a href="#l34.247"></a><span id="l34.247">       let nodeInfo = aNodesInfo[i];</span>
<a href="#l34.248"></a><span id="l34.248">       let row = this._getNewRowForRemovedNode(aUpdatedContainer,</span>
<a href="#l34.249"></a><span id="l34.249" class="difflineminus">-                                              aNodesInfo[i].node);</span>
<a href="#l34.250"></a><span id="l34.250" class="difflineplus">+                                              nodeInfo.node);</span>
<a href="#l34.251"></a><span id="l34.251">       // Select the found node, if any.</span>
<a href="#l34.252"></a><span id="l34.252">       if (row != -1) {</span>
<a href="#l34.253"></a><span id="l34.253">         selection.rangedSelect(row, row, true);</span>
<a href="#l34.254"></a><span id="l34.254">         if (nodeInfo.wasVisible &amp;&amp; scrollToRow == -1)</span>
<a href="#l34.255"></a><span id="l34.255">           scrollToRow = row;</span>
<a href="#l34.256"></a><span id="l34.256">       }</span>
<a href="#l34.257"></a><span id="l34.257">     }</span>
<a href="#l34.258"></a><span id="l34.258"> </span>
<a href="#l34.259"></a><span id="l34.259">     // If only one node was previously selected and there's no selection now,</span>
<a href="#l34.260"></a><span id="l34.260">     // select the node at its old row, if any.</span>
<a href="#l34.261"></a><span id="l34.261">     if (aNodesInfo.length == 1 &amp;&amp; selection.count == 0) {</span>
<a href="#l34.262"></a><span id="l34.262">       let row = Math.min(aNodesInfo[0].oldRow, this._rows.length - 1);</span>
<a href="#l34.263"></a><span id="l34.263" class="difflineminus">-      selection.rangedSelect(row, row, true);</span>
<a href="#l34.264"></a><span id="l34.264" class="difflineminus">-      if (aNodesInfo[0].wasVisible &amp;&amp; scrollToRow == -1)</span>
<a href="#l34.265"></a><span id="l34.265" class="difflineminus">-        scrollToRow = aNodesInfo[0].oldRow;</span>
<a href="#l34.266"></a><span id="l34.266" class="difflineplus">+      if (row != -1) {</span>
<a href="#l34.267"></a><span id="l34.267" class="difflineplus">+        selection.rangedSelect(row, row, true);</span>
<a href="#l34.268"></a><span id="l34.268" class="difflineplus">+        if (aNodesInfo[0].wasVisible &amp;&amp; scrollToRow == -1)</span>
<a href="#l34.269"></a><span id="l34.269" class="difflineplus">+          scrollToRow = aNodesInfo[0].oldRow;</span>
<a href="#l34.270"></a><span id="l34.270" class="difflineplus">+      }</span>
<a href="#l34.271"></a><span id="l34.271">     }</span>
<a href="#l34.272"></a><span id="l34.272"> </span>
<a href="#l34.273"></a><span id="l34.273">     if (scrollToRow != -1)</span>
<a href="#l34.274"></a><span id="l34.274">       this._tree.ensureRowIsVisible(scrollToRow);</span>
<a href="#l34.275"></a><span id="l34.275">   },</span>
<a href="#l34.276"></a><span id="l34.276"> </span>
<a href="#l34.277"></a><span id="l34.277">   _convertPRTimeToString: function PTV__convertPRTimeToString(aTime) {</span>
<a href="#l34.278"></a><span id="l34.278">     const MS_PER_MINUTE = 60000;</span>
<a href="#l34.279"></a><span id="l34.279" class="difflineat">@@ -522,56 +550,56 @@ PlacesTreeView.prototype = {</span>
<a href="#l34.280"></a><span id="l34.280">                               : this._dateFormatter.format(timeObj);</span>
<a href="#l34.281"></a><span id="l34.281">   },</span>
<a href="#l34.282"></a><span id="l34.282"> </span>
<a href="#l34.283"></a><span id="l34.283">   // We use a different formatter for times within the current day,</span>
<a href="#l34.284"></a><span id="l34.284">   // so we cache both a &quot;today&quot; formatter and a general date formatter.</span>
<a href="#l34.285"></a><span id="l34.285">   __todayFormatter: null,</span>
<a href="#l34.286"></a><span id="l34.286">   get _todayFormatter() {</span>
<a href="#l34.287"></a><span id="l34.287">     if (!this.__todayFormatter) {</span>
<a href="#l34.288"></a><span id="l34.288" class="difflineminus">-     const dtOptions = { timeStyle: &quot;short&quot; };</span>
<a href="#l34.289"></a><span id="l34.289" class="difflineminus">-     this.__todayFormatter = Services.intl.createDateTimeFormat(undefined, dtOptions);</span>
<a href="#l34.290"></a><span id="l34.290" class="difflineplus">+      const dtOptions = { timeStyle: &quot;short&quot; };</span>
<a href="#l34.291"></a><span id="l34.291" class="difflineplus">+      this.__todayFormatter = Services.intl.createDateTimeFormat(undefined, dtOptions);</span>
<a href="#l34.292"></a><span id="l34.292">     }</span>
<a href="#l34.293"></a><span id="l34.293">     return this.__todayFormatter;</span>
<a href="#l34.294"></a><span id="l34.294">   },</span>
<a href="#l34.295"></a><span id="l34.295"> </span>
<a href="#l34.296"></a><span id="l34.296">   __dateFormatter: null,</span>
<a href="#l34.297"></a><span id="l34.297">   get _dateFormatter() {</span>
<a href="#l34.298"></a><span id="l34.298">     if (!this.__dateFormatter) {</span>
<a href="#l34.299"></a><span id="l34.299" class="difflineminus">-      const dtOptions = { dateStyle: &quot;short&quot;, timeStyle: &quot;short&quot; };</span>
<a href="#l34.300"></a><span id="l34.300" class="difflineplus">+      const dtOptions = {</span>
<a href="#l34.301"></a><span id="l34.301" class="difflineplus">+        dateStyle: &quot;short&quot;,</span>
<a href="#l34.302"></a><span id="l34.302" class="difflineplus">+        timeStyle: &quot;short&quot;</span>
<a href="#l34.303"></a><span id="l34.303" class="difflineplus">+      };</span>
<a href="#l34.304"></a><span id="l34.304">       this.__dateFormatter = Services.intl.createDateTimeFormat(undefined, dtOptions);</span>
<a href="#l34.305"></a><span id="l34.305">     }</span>
<a href="#l34.306"></a><span id="l34.306">     return this.__dateFormatter;</span>
<a href="#l34.307"></a><span id="l34.307">   },</span>
<a href="#l34.308"></a><span id="l34.308"> </span>
<a href="#l34.309"></a><span id="l34.309">   COLUMN_TYPE_UNKNOWN: 0,</span>
<a href="#l34.310"></a><span id="l34.310">   COLUMN_TYPE_TITLE: 1,</span>
<a href="#l34.311"></a><span id="l34.311">   COLUMN_TYPE_URI: 2,</span>
<a href="#l34.312"></a><span id="l34.312">   COLUMN_TYPE_DATE: 3,</span>
<a href="#l34.313"></a><span id="l34.313">   COLUMN_TYPE_VISITCOUNT: 4,</span>
<a href="#l34.314"></a><span id="l34.314" class="difflineminus">-  COLUMN_TYPE_KEYWORD: 5,</span>
<a href="#l34.315"></a><span id="l34.315" class="difflineminus">-  COLUMN_TYPE_DESCRIPTION: 6,</span>
<a href="#l34.316"></a><span id="l34.316" class="difflineminus">-  COLUMN_TYPE_DATEADDED: 7,</span>
<a href="#l34.317"></a><span id="l34.317" class="difflineminus">-  COLUMN_TYPE_LASTMODIFIED: 8,</span>
<a href="#l34.318"></a><span id="l34.318" class="difflineminus">-  COLUMN_TYPE_TAGS: 9,</span>
<a href="#l34.319"></a><span id="l34.319" class="difflineplus">+  COLUMN_TYPE_DESCRIPTION: 5,</span>
<a href="#l34.320"></a><span id="l34.320" class="difflineplus">+  COLUMN_TYPE_DATEADDED: 6,</span>
<a href="#l34.321"></a><span id="l34.321" class="difflineplus">+  COLUMN_TYPE_LASTMODIFIED: 7,</span>
<a href="#l34.322"></a><span id="l34.322" class="difflineplus">+  COLUMN_TYPE_TAGS: 8,</span>
<a href="#l34.323"></a><span id="l34.323"> </span>
<a href="#l34.324"></a><span id="l34.324">   _getColumnType: function PTV__getColumnType(aColumn) {</span>
<a href="#l34.325"></a><span id="l34.325">     let columnType = aColumn.element.getAttribute(&quot;anonid&quot;) || aColumn.id;</span>
<a href="#l34.326"></a><span id="l34.326"> </span>
<a href="#l34.327"></a><span id="l34.327">     switch (columnType) {</span>
<a href="#l34.328"></a><span id="l34.328">       case &quot;title&quot;:</span>
<a href="#l34.329"></a><span id="l34.329">         return this.COLUMN_TYPE_TITLE;</span>
<a href="#l34.330"></a><span id="l34.330">       case &quot;url&quot;:</span>
<a href="#l34.331"></a><span id="l34.331">         return this.COLUMN_TYPE_URI;</span>
<a href="#l34.332"></a><span id="l34.332">       case &quot;date&quot;:</span>
<a href="#l34.333"></a><span id="l34.333">         return this.COLUMN_TYPE_DATE;</span>
<a href="#l34.334"></a><span id="l34.334">       case &quot;visitCount&quot;:</span>
<a href="#l34.335"></a><span id="l34.335">         return this.COLUMN_TYPE_VISITCOUNT;</span>
<a href="#l34.336"></a><span id="l34.336" class="difflineminus">-      case &quot;keyword&quot;:</span>
<a href="#l34.337"></a><span id="l34.337" class="difflineminus">-        return this.COLUMN_TYPE_KEYWORD;</span>
<a href="#l34.338"></a><span id="l34.338">       case &quot;description&quot;:</span>
<a href="#l34.339"></a><span id="l34.339">         return this.COLUMN_TYPE_DESCRIPTION;</span>
<a href="#l34.340"></a><span id="l34.340">       case &quot;dateAdded&quot;:</span>
<a href="#l34.341"></a><span id="l34.341">         return this.COLUMN_TYPE_DATEADDED;</span>
<a href="#l34.342"></a><span id="l34.342">       case &quot;lastModified&quot;:</span>
<a href="#l34.343"></a><span id="l34.343">         return this.COLUMN_TYPE_LASTMODIFIED;</span>
<a href="#l34.344"></a><span id="l34.344">       case &quot;tags&quot;:</span>
<a href="#l34.345"></a><span id="l34.345">         return this.COLUMN_TYPE_TAGS;</span>
<a href="#l34.346"></a><span id="l34.346" class="difflineat">@@ -592,20 +620,16 @@ PlacesTreeView.prototype = {</span>
<a href="#l34.347"></a><span id="l34.347">       case Ci.nsINavHistoryQueryOptions.SORT_BY_URI_ASCENDING:</span>
<a href="#l34.348"></a><span id="l34.348">         return [this.COLUMN_TYPE_URI, false];</span>
<a href="#l34.349"></a><span id="l34.349">       case Ci.nsINavHistoryQueryOptions.SORT_BY_URI_DESCENDING:</span>
<a href="#l34.350"></a><span id="l34.350">         return [this.COLUMN_TYPE_URI, true];</span>
<a href="#l34.351"></a><span id="l34.351">       case Ci.nsINavHistoryQueryOptions.SORT_BY_VISITCOUNT_ASCENDING:</span>
<a href="#l34.352"></a><span id="l34.352">         return [this.COLUMN_TYPE_VISITCOUNT, false];</span>
<a href="#l34.353"></a><span id="l34.353">       case Ci.nsINavHistoryQueryOptions.SORT_BY_VISITCOUNT_DESCENDING:</span>
<a href="#l34.354"></a><span id="l34.354">         return [this.COLUMN_TYPE_VISITCOUNT, true];</span>
<a href="#l34.355"></a><span id="l34.355" class="difflineminus">-      case Ci.nsINavHistoryQueryOptions.SORT_BY_KEYWORD_ASCENDING:</span>
<a href="#l34.356"></a><span id="l34.356" class="difflineminus">-        return [this.COLUMN_TYPE_KEYWORD, false];</span>
<a href="#l34.357"></a><span id="l34.357" class="difflineminus">-      case Ci.nsINavHistoryQueryOptions.SORT_BY_KEYWORD_DESCENDING:</span>
<a href="#l34.358"></a><span id="l34.358" class="difflineminus">-        return [this.COLUMN_TYPE_KEYWORD, true];</span>
<a href="#l34.359"></a><span id="l34.359">       case Ci.nsINavHistoryQueryOptions.SORT_BY_ANNOTATION_ASCENDING:</span>
<a href="#l34.360"></a><span id="l34.360">         if (this._result.sortingAnnotation == PlacesUIUtils.DESCRIPTION_ANNO)</span>
<a href="#l34.361"></a><span id="l34.361">           return [this.COLUMN_TYPE_DESCRIPTION, false];</span>
<a href="#l34.362"></a><span id="l34.362">         break;</span>
<a href="#l34.363"></a><span id="l34.363">       case Ci.nsINavHistoryQueryOptions.SORT_BY_ANNOTATION_DESCENDING:</span>
<a href="#l34.364"></a><span id="l34.364">         if (this._result.sortingAnnotation == PlacesUIUtils.DESCRIPTION_ANNO)</span>
<a href="#l34.365"></a><span id="l34.365">           return [this.COLUMN_TYPE_DESCRIPTION, true];</span>
<a href="#l34.366"></a><span id="l34.366">       case Ci.nsINavHistoryQueryOptions.SORT_BY_DATEADDED_ASCENDING:</span>
<a href="#l34.367"></a><span id="l34.367" class="difflineat">@@ -648,18 +672,17 @@ PlacesTreeView.prototype = {</span>
<a href="#l34.368"></a><span id="l34.368">     let cc = aParentNode.childCount;</span>
<a href="#l34.369"></a><span id="l34.369">     if (aNewIndex == 0 || this._isPlainContainer(aParentNode) || cc == 0) {</span>
<a href="#l34.370"></a><span id="l34.370">       // We don't need to worry about sub hierarchies of the parent node</span>
<a href="#l34.371"></a><span id="l34.371">       // if it's a plain container, or if the new node is its first child.</span>
<a href="#l34.372"></a><span id="l34.372">       if (aParentNode == this._rootNode)</span>
<a href="#l34.373"></a><span id="l34.373">         row = aNewIndex;</span>
<a href="#l34.374"></a><span id="l34.374">       else</span>
<a href="#l34.375"></a><span id="l34.375">         row = parentRow + aNewIndex + 1;</span>
<a href="#l34.376"></a><span id="l34.376" class="difflineminus">-    }</span>
<a href="#l34.377"></a><span id="l34.377" class="difflineminus">-    else {</span>
<a href="#l34.378"></a><span id="l34.378" class="difflineplus">+    } else {</span>
<a href="#l34.379"></a><span id="l34.379">       // Here, we try to find the next visible element in the child list so we</span>
<a href="#l34.380"></a><span id="l34.380">       // can set the new visible index to be right before that.  Note that we</span>
<a href="#l34.381"></a><span id="l34.381">       // have to search down instead of up, because some siblings could have</span>
<a href="#l34.382"></a><span id="l34.382">       // children themselves that would be in the way.</span>
<a href="#l34.383"></a><span id="l34.383">       let separatorsAreHidden = PlacesUtils.nodeIsSeparator(aNode) &amp;&amp;</span>
<a href="#l34.384"></a><span id="l34.384">                                 this.isSorted();</span>
<a href="#l34.385"></a><span id="l34.385">       for (let i = aNewIndex + 1; i &lt; cc; i++) {</span>
<a href="#l34.386"></a><span id="l34.386">         let node = aParentNode.getChild(i);</span>
<a href="#l34.387"></a><span id="l34.387" class="difflineat">@@ -680,18 +703,20 @@ PlacesTreeView.prototype = {</span>
<a href="#l34.388"></a><span id="l34.388">         row = prevIndex + this._countVisibleRowsForNodeAtRow(prevIndex);</span>
<a href="#l34.389"></a><span id="l34.389">       }</span>
<a href="#l34.390"></a><span id="l34.390">     }</span>
<a href="#l34.391"></a><span id="l34.391"> </span>
<a href="#l34.392"></a><span id="l34.392">     this._nodeDetails.set(makeNodeDetailsKey(aNode), aNode);</span>
<a href="#l34.393"></a><span id="l34.393">     this._rows.splice(row, 0, aNode);</span>
<a href="#l34.394"></a><span id="l34.394">     this._tree.rowCountChanged(row, 1);</span>
<a href="#l34.395"></a><span id="l34.395"> </span>
<a href="#l34.396"></a><span id="l34.396" class="difflineminus">-    if (PlacesUtils.nodeIsContainer(aNode) &amp;&amp; PlacesUtils.asContainer(aNode).containerOpen)</span>
<a href="#l34.397"></a><span id="l34.397" class="difflineplus">+    if (PlacesUtils.nodeIsContainer(aNode) &amp;&amp;</span>
<a href="#l34.398"></a><span id="l34.398" class="difflineplus">+        PlacesUtils.asContainer(aNode).containerOpen) {</span>
<a href="#l34.399"></a><span id="l34.399">       this.invalidateContainer(aNode);</span>
<a href="#l34.400"></a><span id="l34.400" class="difflineplus">+    }</span>
<a href="#l34.401"></a><span id="l34.401">   },</span>
<a href="#l34.402"></a><span id="l34.402"> </span>
<a href="#l34.403"></a><span id="l34.403">   /**</span>
<a href="#l34.404"></a><span id="l34.404">    * THIS FUNCTION DOES NOT HANDLE cases where a collapsed node is being</span>
<a href="#l34.405"></a><span id="l34.405">    * removed but the node it is collapsed with is not being removed (this then</span>
<a href="#l34.406"></a><span id="l34.406">    * just swap out the removee with its collapsing partner). The only time</span>
<a href="#l34.407"></a><span id="l34.407">    * when we really remove things is when deleting URIs, which will apply to</span>
<a href="#l34.408"></a><span id="l34.408">    * all collapsees. This function is called sometimes when resorting items.</span>
<a href="#l34.409"></a><span id="l34.409" class="difflineat">@@ -743,17 +768,18 @@ PlacesTreeView.prototype = {</span>
<a href="#l34.410"></a><span id="l34.410">     }</span>
<a href="#l34.411"></a><span id="l34.411"> </span>
<a href="#l34.412"></a><span id="l34.412">     // Restore selection if the node was exclusively selected.</span>
<a href="#l34.413"></a><span id="l34.413">     if (!selectNext)</span>
<a href="#l34.414"></a><span id="l34.414">       return;</span>
<a href="#l34.415"></a><span id="l34.415"> </span>
<a href="#l34.416"></a><span id="l34.416">     // Restore selection.</span>
<a href="#l34.417"></a><span id="l34.417">     let rowToSelect = Math.min(oldRow, this._rows.length - 1);</span>
<a href="#l34.418"></a><span id="l34.418" class="difflineminus">-    this.selection.rangedSelect(rowToSelect, rowToSelect, true);</span>
<a href="#l34.419"></a><span id="l34.419" class="difflineplus">+    if (rowToSelect != -1)</span>
<a href="#l34.420"></a><span id="l34.420" class="difflineplus">+      this.selection.rangedSelect(rowToSelect, rowToSelect, true);</span>
<a href="#l34.421"></a><span id="l34.421">   },</span>
<a href="#l34.422"></a><span id="l34.422"> </span>
<a href="#l34.423"></a><span id="l34.423">   nodeMoved:</span>
<a href="#l34.424"></a><span id="l34.424">   function PTV_nodeMoved(aNode, aOldParent, aOldIndex, aNewParent, aNewIndex) {</span>
<a href="#l34.425"></a><span id="l34.425">     NS_ASSERT(this._result, &quot;Got a notification but have no result!&quot;);</span>
<a href="#l34.426"></a><span id="l34.426">     if (!this._tree || !this._result)</span>
<a href="#l34.427"></a><span id="l34.427">       return;</span>
<a href="#l34.428"></a><span id="l34.428"> </span>
<a href="#l34.429"></a><span id="l34.429" class="difflineat">@@ -810,40 +836,45 @@ PlacesTreeView.prototype = {</span>
<a href="#l34.430"></a><span id="l34.430">     if (aNode == this._rootNode)</span>
<a href="#l34.431"></a><span id="l34.431">       return;</span>
<a href="#l34.432"></a><span id="l34.432"> </span>
<a href="#l34.433"></a><span id="l34.433">     let row = this._getRowForNode(aNode);</span>
<a href="#l34.434"></a><span id="l34.434">     if (row == -1)</span>
<a href="#l34.435"></a><span id="l34.435">       return;</span>
<a href="#l34.436"></a><span id="l34.436"> </span>
<a href="#l34.437"></a><span id="l34.437">     let column = this._findColumnByType(aColumnType);</span>
<a href="#l34.438"></a><span id="l34.438" class="difflineminus">-    if (column &amp;&amp; !column.element.hidden)</span>
<a href="#l34.439"></a><span id="l34.439" class="difflineplus">+    if (column &amp;&amp; !column.element.hidden) {</span>
<a href="#l34.440"></a><span id="l34.440" class="difflineplus">+      if (aColumnType == this.COLUMN_TYPE_TITLE)</span>
<a href="#l34.441"></a><span id="l34.441" class="difflineplus">+        this._tree.removeImageCacheEntry(row, column);</span>
<a href="#l34.442"></a><span id="l34.442">       this._tree.invalidateCell(row, column);</span>
<a href="#l34.443"></a><span id="l34.443" class="difflineplus">+    }</span>
<a href="#l34.444"></a><span id="l34.444"> </span>
<a href="#l34.445"></a><span id="l34.445">     // Last modified time is altered for almost all node changes.</span>
<a href="#l34.446"></a><span id="l34.446">     if (aColumnType != this.COLUMN_TYPE_LASTMODIFIED) {</span>
<a href="#l34.447"></a><span id="l34.447">       let lastModifiedColumn =</span>
<a href="#l34.448"></a><span id="l34.448">         this._findColumnByType(this.COLUMN_TYPE_LASTMODIFIED);</span>
<a href="#l34.449"></a><span id="l34.449">       if (lastModifiedColumn &amp;&amp; !lastModifiedColumn.hidden)</span>
<a href="#l34.450"></a><span id="l34.450">         this._tree.invalidateCell(row, lastModifiedColumn);</span>
<a href="#l34.451"></a><span id="l34.451">     }</span>
<a href="#l34.452"></a><span id="l34.452">   },</span>
<a href="#l34.453"></a><span id="l34.453"> </span>
<a href="#l34.454"></a><span id="l34.454">   _populateLivemarkContainer: function PTV__populateLivemarkContainer(aNode) {</span>
<a href="#l34.455"></a><span id="l34.455">     PlacesUtils.livemarks.getLivemark({ id: aNode.itemId })</span>
<a href="#l34.456"></a><span id="l34.456" class="difflineminus">-                         .then(aLivemark =&gt; {</span>
<a href="#l34.457"></a><span id="l34.457" class="difflineminus">-      let placesNode = aNode;</span>
<a href="#l34.458"></a><span id="l34.458" class="difflineminus">-      // Container may have closed since the call.</span>
<a href="#l34.459"></a><span id="l34.459" class="difflineminus">-      if (!placesNode.containerOpen)</span>
<a href="#l34.460"></a><span id="l34.460" class="difflineminus">-        return;</span>
<a href="#l34.461"></a><span id="l34.461" class="difflineplus">+      .then(aLivemark =&gt; {</span>
<a href="#l34.462"></a><span id="l34.462" class="difflineplus">+        let placesNode = aNode;</span>
<a href="#l34.463"></a><span id="l34.463" class="difflineplus">+        // Need to check containerOpen since getLivemark is async.</span>
<a href="#l34.464"></a><span id="l34.464" class="difflineplus">+        if (!placesNode.containerOpen)</span>
<a href="#l34.465"></a><span id="l34.465" class="difflineplus">+          return;</span>
<a href="#l34.466"></a><span id="l34.466"> </span>
<a href="#l34.467"></a><span id="l34.467" class="difflineminus">-      let children = aLivemark.getNodesForContainer(placesNode);</span>
<a href="#l34.468"></a><span id="l34.468" class="difflineminus">-      for (let i = 0; i &lt; children.length; i++)</span>
<a href="#l34.469"></a><span id="l34.469" class="difflineminus">-        this.nodeInserted(placesNode, children[i], i);</span>
<a href="#l34.470"></a><span id="l34.470" class="difflineminus">-    }, () =&gt; undefined);</span>
<a href="#l34.471"></a><span id="l34.471" class="difflineplus">+        let children = aLivemark.getNodesForContainer(placesNode);</span>
<a href="#l34.472"></a><span id="l34.472" class="difflineplus">+        for (let i = 0; i &lt; children.length; i++) {</span>
<a href="#l34.473"></a><span id="l34.473" class="difflineplus">+          let child = children[i];</span>
<a href="#l34.474"></a><span id="l34.474" class="difflineplus">+          this.nodeInserted(placesNode, child, i);</span>
<a href="#l34.475"></a><span id="l34.475" class="difflineplus">+        }</span>
<a href="#l34.476"></a><span id="l34.476" class="difflineplus">+      }, Cu.reportError);</span>
<a href="#l34.477"></a><span id="l34.477">   },</span>
<a href="#l34.478"></a><span id="l34.478"> </span>
<a href="#l34.479"></a><span id="l34.479">   nodeTitleChanged: function PTV_nodeTitleChanged(aNode, aNewTitle) {</span>
<a href="#l34.480"></a><span id="l34.480">     this._invalidateCellValue(aNode, this.COLUMN_TYPE_TITLE);</span>
<a href="#l34.481"></a><span id="l34.481">   },</span>
<a href="#l34.482"></a><span id="l34.482"> </span>
<a href="#l34.483"></a><span id="l34.483">   nodeURIChanged: function PTV_nodeURIChanged(aNode, aOldURI) {</span>
<a href="#l34.484"></a><span id="l34.484">     this._nodeDetails.delete(makeNodeDetailsKey({uri: aOldURI,</span>
<a href="#l34.485"></a><span id="l34.485" class="difflineat">@@ -859,17 +890,16 @@ PlacesTreeView.prototype = {</span>
<a href="#l34.486"></a><span id="l34.486"> </span>
<a href="#l34.487"></a><span id="l34.487">   nodeHistoryDetailsChanged:</span>
<a href="#l34.488"></a><span id="l34.488">   function PTV_nodeHistoryDetailsChanged(aNode, aOldVisitDate,</span>
<a href="#l34.489"></a><span id="l34.489">                                          aOldVisitCount) {</span>
<a href="#l34.490"></a><span id="l34.490">     this._nodeDetails.delete(makeNodeDetailsKey({uri: aNode.uri,</span>
<a href="#l34.491"></a><span id="l34.491">                                                  itemId: aNode.itemId,</span>
<a href="#l34.492"></a><span id="l34.492">                                                  time: aOldVisitDate}));</span>
<a href="#l34.493"></a><span id="l34.493">     this._nodeDetails.set(makeNodeDetailsKey(aNode), aNode);</span>
<a href="#l34.494"></a><span id="l34.494" class="difflineminus">-</span>
<a href="#l34.495"></a><span id="l34.495">     if (aNode.parent &amp;&amp; this._controller.hasCachedLivemarkInfo(aNode.parent)) {</span>
<a href="#l34.496"></a><span id="l34.496">       // Find the node in the parent.</span>
<a href="#l34.497"></a><span id="l34.497">       let parentRow = this._flatList ? 0 : this._getRowForNode(aNode.parent);</span>
<a href="#l34.498"></a><span id="l34.498">       for (let i = parentRow; i &lt; this._rows.length; i++) {</span>
<a href="#l34.499"></a><span id="l34.499">         let child = this.nodeForTreeIndex(i);</span>
<a href="#l34.500"></a><span id="l34.500">         if (child.uri == aNode.uri) {</span>
<a href="#l34.501"></a><span id="l34.501">           this._cellProperties.delete(child);</span>
<a href="#l34.502"></a><span id="l34.502">           this._invalidateCellValue(child, this.COLUMN_TYPE_TITLE);</span>
<a href="#l34.503"></a><span id="l34.503" class="difflineat">@@ -882,34 +912,30 @@ PlacesTreeView.prototype = {</span>
<a href="#l34.504"></a><span id="l34.504">     this._invalidateCellValue(aNode, this.COLUMN_TYPE_DATE);</span>
<a href="#l34.505"></a><span id="l34.505">     this._invalidateCellValue(aNode, this.COLUMN_TYPE_VISITCOUNT);</span>
<a href="#l34.506"></a><span id="l34.506">   },</span>
<a href="#l34.507"></a><span id="l34.507"> </span>
<a href="#l34.508"></a><span id="l34.508">   nodeTagsChanged: function PTV_nodeTagsChanged(aNode) {</span>
<a href="#l34.509"></a><span id="l34.509">     this._invalidateCellValue(aNode, this.COLUMN_TYPE_TAGS);</span>
<a href="#l34.510"></a><span id="l34.510">   },</span>
<a href="#l34.511"></a><span id="l34.511"> </span>
<a href="#l34.512"></a><span id="l34.512" class="difflineminus">-  nodeKeywordChanged: function PTV_nodeKeywordChanged(aNode, aNewKeyword) {</span>
<a href="#l34.513"></a><span id="l34.513" class="difflineminus">-    this._invalidateCellValue(aNode, this.COLUMN_TYPE_KEYWORD);</span>
<a href="#l34.514"></a><span id="l34.514" class="difflineminus">-  },</span>
<a href="#l34.515"></a><span id="l34.515" class="difflineplus">+  nodeKeywordChanged(aNode, aNewKeyword) {},</span>
<a href="#l34.516"></a><span id="l34.516"> </span>
<a href="#l34.517"></a><span id="l34.517">   nodeAnnotationChanged: function PTV_nodeAnnotationChanged(aNode, aAnno) {</span>
<a href="#l34.518"></a><span id="l34.518">     if (aAnno == PlacesUIUtils.DESCRIPTION_ANNO) {</span>
<a href="#l34.519"></a><span id="l34.519">       this._invalidateCellValue(aNode, this.COLUMN_TYPE_DESCRIPTION);</span>
<a href="#l34.520"></a><span id="l34.520">     } else if (aAnno == PlacesUtils.LMANNO_FEEDURI) {</span>
<a href="#l34.521"></a><span id="l34.521">       PlacesUtils.livemarks.getLivemark({ id: aNode.itemId })</span>
<a href="#l34.522"></a><span id="l34.522" class="difflineminus">-                           .then(aLivemark =&gt; {</span>
<a href="#l34.523"></a><span id="l34.523" class="difflineminus">-        this._controller.cacheLivemarkInfo(aNode, aLivemark);</span>
<a href="#l34.524"></a><span id="l34.524" class="difflineminus">-        let properties = this._cellProperties.get(aNode);</span>
<a href="#l34.525"></a><span id="l34.525" class="difflineminus">-        if (properties)</span>
<a href="#l34.526"></a><span id="l34.526" class="difflineminus">-          this._cellProperties.set(aNode, properties + &quot; livemark&quot;);</span>
<a href="#l34.527"></a><span id="l34.527" class="difflineminus">-</span>
<a href="#l34.528"></a><span id="l34.528" class="difflineminus">-        // The livemark attribute is set as a cell property on the title cell.</span>
<a href="#l34.529"></a><span id="l34.529" class="difflineminus">-        this._invalidateCellValue(aNode, this.COLUMN_TYPE_TITLE);</span>
<a href="#l34.530"></a><span id="l34.530" class="difflineminus">-      }, () =&gt; undefined);</span>
<a href="#l34.531"></a><span id="l34.531" class="difflineplus">+        .then(aLivemark =&gt; {</span>
<a href="#l34.532"></a><span id="l34.532" class="difflineplus">+          this._controller.cacheLivemarkInfo(aNode, aLivemark);</span>
<a href="#l34.533"></a><span id="l34.533" class="difflineplus">+          let properties = this._cellProperties.get(aNode);</span>
<a href="#l34.534"></a><span id="l34.534" class="difflineplus">+          this._cellProperties.set(aNode, properties += &quot; livemark&quot;);</span>
<a href="#l34.535"></a><span id="l34.535" class="difflineplus">+          // The livemark attribute is set as a cell property on the title cell.</span>
<a href="#l34.536"></a><span id="l34.536" class="difflineplus">+          this._invalidateCellValue(aNode, this.COLUMN_TYPE_TITLE);</span>
<a href="#l34.537"></a><span id="l34.537" class="difflineplus">+        }, Cu.reportError);</span>
<a href="#l34.538"></a><span id="l34.538">     }</span>
<a href="#l34.539"></a><span id="l34.539">   },</span>
<a href="#l34.540"></a><span id="l34.540"> </span>
<a href="#l34.541"></a><span id="l34.541">   nodeDateAddedChanged: function PTV_nodeDateAddedChanged(aNode, aNewValue) {</span>
<a href="#l34.542"></a><span id="l34.542">     this._invalidateCellValue(aNode, this.COLUMN_TYPE_DATEADDED);</span>
<a href="#l34.543"></a><span id="l34.543">   },</span>
<a href="#l34.544"></a><span id="l34.544"> </span>
<a href="#l34.545"></a><span id="l34.545">   nodeLastModifiedChanged:</span>
<a href="#l34.546"></a><span id="l34.546" class="difflineat">@@ -918,58 +944,86 @@ PlacesTreeView.prototype = {</span>
<a href="#l34.547"></a><span id="l34.547">   },</span>
<a href="#l34.548"></a><span id="l34.548"> </span>
<a href="#l34.549"></a><span id="l34.549">   containerStateChanged:</span>
<a href="#l34.550"></a><span id="l34.550">   function PTV_containerStateChanged(aNode, aOldState, aNewState) {</span>
<a href="#l34.551"></a><span id="l34.551">     this.invalidateContainer(aNode);</span>
<a href="#l34.552"></a><span id="l34.552"> </span>
<a href="#l34.553"></a><span id="l34.553">     if (PlacesUtils.nodeIsFolder(aNode) ||</span>
<a href="#l34.554"></a><span id="l34.554">         (this._flatList &amp;&amp; aNode == this._rootNode)) {</span>
<a href="#l34.555"></a><span id="l34.555" class="difflineminus">-      if (PlacesUtils.asQuery(this._rootNode).queryOptions.excludeItems)</span>
<a href="#l34.556"></a><span id="l34.556" class="difflineplus">+      let queryOptions = PlacesUtils.asQuery(this._rootNode).queryOptions;</span>
<a href="#l34.557"></a><span id="l34.557" class="difflineplus">+      if (queryOptions.excludeItems) {</span>
<a href="#l34.558"></a><span id="l34.558">         return;</span>
<a href="#l34.559"></a><span id="l34.559" class="difflineminus">-</span>
<a href="#l34.560"></a><span id="l34.560" class="difflineminus">-      PlacesUtils.livemarks.getLivemark({ id: aNode.itemId })</span>
<a href="#l34.561"></a><span id="l34.561" class="difflineminus">-                           .then(aLivemark =&gt; {</span>
<a href="#l34.562"></a><span id="l34.562" class="difflineminus">-        let shouldInvalidate =</span>
<a href="#l34.563"></a><span id="l34.563" class="difflineminus">-          !this._controller.hasCachedLivemarkInfo(aNode);</span>
<a href="#l34.564"></a><span id="l34.564" class="difflineminus">-        this._controller.cacheLivemarkInfo(aNode, aLivemark);</span>
<a href="#l34.565"></a><span id="l34.565" class="difflineminus">-        if (aNewState == Ci.nsINavHistoryContainerResultNode.STATE_OPENED) {</span>
<a href="#l34.566"></a><span id="l34.566" class="difflineminus">-          aLivemark.registerForUpdates(aNode, this);</span>
<a href="#l34.567"></a><span id="l34.567" class="difflineminus">-          aLivemark.reload();</span>
<a href="#l34.568"></a><span id="l34.568" class="difflineminus">-          if (shouldInvalidate)</span>
<a href="#l34.569"></a><span id="l34.569" class="difflineminus">-            this.invalidateContainer(aNode);</span>
<a href="#l34.570"></a><span id="l34.570" class="difflineminus">-        }</span>
<a href="#l34.571"></a><span id="l34.571" class="difflineminus">-        else {</span>
<a href="#l34.572"></a><span id="l34.572" class="difflineminus">-          aLivemark.unregisterForUpdates(aNode);</span>
<a href="#l34.573"></a><span id="l34.573" class="difflineminus">-        }</span>
<a href="#l34.574"></a><span id="l34.574" class="difflineminus">-      }, () =&gt; undefined);</span>
<a href="#l34.575"></a><span id="l34.575" class="difflineplus">+      }</span>
<a href="#l34.576"></a><span id="l34.576" class="difflineplus">+      if (aNode.itemId != -1) { // run when there's a valid node id</span>
<a href="#l34.577"></a><span id="l34.577" class="difflineplus">+        PlacesUtils.livemarks.getLivemark({ id: aNode.itemId })</span>
<a href="#l34.578"></a><span id="l34.578" class="difflineplus">+          .then(aLivemark =&gt; {</span>
<a href="#l34.579"></a><span id="l34.579" class="difflineplus">+            let shouldInvalidate =</span>
<a href="#l34.580"></a><span id="l34.580" class="difflineplus">+              !this._controller.hasCachedLivemarkInfo(aNode);</span>
<a href="#l34.581"></a><span id="l34.581" class="difflineplus">+            this._controller.cacheLivemarkInfo(aNode, aLivemark);</span>
<a href="#l34.582"></a><span id="l34.582" class="difflineplus">+            if (aNewState == Ci.nsINavHistoryContainerResultNode.STATE_OPENED) {</span>
<a href="#l34.583"></a><span id="l34.583" class="difflineplus">+              aLivemark.registerForUpdates(aNode, this);</span>
<a href="#l34.584"></a><span id="l34.584" class="difflineplus">+              // Prioritize the current livemark.</span>
<a href="#l34.585"></a><span id="l34.585" class="difflineplus">+              aLivemark.reload();</span>
<a href="#l34.586"></a><span id="l34.586" class="difflineplus">+              PlacesUtils.livemarks.reloadLivemarks();</span>
<a href="#l34.587"></a><span id="l34.587" class="difflineplus">+              if (shouldInvalidate)</span>
<a href="#l34.588"></a><span id="l34.588" class="difflineplus">+                this.invalidateContainer(aNode);</span>
<a href="#l34.589"></a><span id="l34.589" class="difflineplus">+            } else {</span>
<a href="#l34.590"></a><span id="l34.590" class="difflineplus">+              aLivemark.unregisterForUpdates(aNode);</span>
<a href="#l34.591"></a><span id="l34.591" class="difflineplus">+            }</span>
<a href="#l34.592"></a><span id="l34.592" class="difflineplus">+          }, () =&gt; undefined);</span>
<a href="#l34.593"></a><span id="l34.593" class="difflineplus">+      }</span>
<a href="#l34.594"></a><span id="l34.594">     }</span>
<a href="#l34.595"></a><span id="l34.595">   },</span>
<a href="#l34.596"></a><span id="l34.596"> </span>
<a href="#l34.597"></a><span id="l34.597">   invalidateContainer: function PTV_invalidateContainer(aContainer) {</span>
<a href="#l34.598"></a><span id="l34.598">     NS_ASSERT(this._result, &quot;Need to have a result to update&quot;);</span>
<a href="#l34.599"></a><span id="l34.599">     if (!this._tree)</span>
<a href="#l34.600"></a><span id="l34.600">       return;</span>
<a href="#l34.601"></a><span id="l34.601"> </span>
<a href="#l34.602"></a><span id="l34.602" class="difflineplus">+    // If we are currently editing, don't invalidate the container until we</span>
<a href="#l34.603"></a><span id="l34.603" class="difflineplus">+    // finish.</span>
<a href="#l34.604"></a><span id="l34.604" class="difflineplus">+    if (this._tree.element.getAttribute(&quot;editing&quot;)) {</span>
<a href="#l34.605"></a><span id="l34.605" class="difflineplus">+      if (!this._editingObservers) {</span>
<a href="#l34.606"></a><span id="l34.606" class="difflineplus">+        this._editingObservers = new Map();</span>
<a href="#l34.607"></a><span id="l34.607" class="difflineplus">+      }</span>
<a href="#l34.608"></a><span id="l34.608" class="difflineplus">+      if (!this._editingObservers.has(aContainer)) {</span>
<a href="#l34.609"></a><span id="l34.609" class="difflineplus">+        let mutationObserver = new MutationObserver(() =&gt; {</span>
<a href="#l34.610"></a><span id="l34.610" class="difflineplus">+          Services.tm.dispatchToMainThread(</span>
<a href="#l34.611"></a><span id="l34.611" class="difflineplus">+            () =&gt; this.invalidateContainer(aContainer));</span>
<a href="#l34.612"></a><span id="l34.612" class="difflineplus">+          let observer = this._editingObservers.get(aContainer);</span>
<a href="#l34.613"></a><span id="l34.613" class="difflineplus">+          observer.disconnect();</span>
<a href="#l34.614"></a><span id="l34.614" class="difflineplus">+          this._editingObservers.delete(aContainer);</span>
<a href="#l34.615"></a><span id="l34.615" class="difflineplus">+        });</span>
<a href="#l34.616"></a><span id="l34.616" class="difflineplus">+</span>
<a href="#l34.617"></a><span id="l34.617" class="difflineplus">+        mutationObserver.observe(this._tree.element, {</span>
<a href="#l34.618"></a><span id="l34.618" class="difflineplus">+          attributes: true,</span>
<a href="#l34.619"></a><span id="l34.619" class="difflineplus">+          attributeFilter: [&quot;editing&quot;],</span>
<a href="#l34.620"></a><span id="l34.620" class="difflineplus">+        });</span>
<a href="#l34.621"></a><span id="l34.621" class="difflineplus">+</span>
<a href="#l34.622"></a><span id="l34.622" class="difflineplus">+        this._editingObservers.set(aContainer, mutationObserver);</span>
<a href="#l34.623"></a><span id="l34.623" class="difflineplus">+      }</span>
<a href="#l34.624"></a><span id="l34.624" class="difflineplus">+      return;</span>
<a href="#l34.625"></a><span id="l34.625" class="difflineplus">+    }</span>
<a href="#l34.626"></a><span id="l34.626" class="difflineplus">+</span>
<a href="#l34.627"></a><span id="l34.627">     let startReplacement, replaceCount;</span>
<a href="#l34.628"></a><span id="l34.628">     if (aContainer == this._rootNode) {</span>
<a href="#l34.629"></a><span id="l34.629">       startReplacement = 0;</span>
<a href="#l34.630"></a><span id="l34.630">       replaceCount = this._rows.length;</span>
<a href="#l34.631"></a><span id="l34.631"> </span>
<a href="#l34.632"></a><span id="l34.632">       // If the root node is now closed, the tree is empty.</span>
<a href="#l34.633"></a><span id="l34.633">       if (!this._rootNode.containerOpen) {</span>
<a href="#l34.634"></a><span id="l34.634">         this._nodeDetails.clear();</span>
<a href="#l34.635"></a><span id="l34.635">         this._rows = [];</span>
<a href="#l34.636"></a><span id="l34.636">         if (replaceCount)</span>
<a href="#l34.637"></a><span id="l34.637">           this._tree.rowCountChanged(startReplacement, -replaceCount);</span>
<a href="#l34.638"></a><span id="l34.638"> </span>
<a href="#l34.639"></a><span id="l34.639">         return;</span>
<a href="#l34.640"></a><span id="l34.640">       }</span>
<a href="#l34.641"></a><span id="l34.641" class="difflineminus">-    }</span>
<a href="#l34.642"></a><span id="l34.642" class="difflineminus">-    else {</span>
<a href="#l34.643"></a><span id="l34.643" class="difflineplus">+    } else {</span>
<a href="#l34.644"></a><span id="l34.644">       // Update the twisty state.</span>
<a href="#l34.645"></a><span id="l34.645">       let row = this._getRowForNode(aContainer);</span>
<a href="#l34.646"></a><span id="l34.646">       this._tree.invalidateRow(row);</span>
<a href="#l34.647"></a><span id="l34.647"> </span>
<a href="#l34.648"></a><span id="l34.648">       // We don't replace the container node itself, so we should decrease the</span>
<a href="#l34.649"></a><span id="l34.649">       // replaceCount by 1.</span>
<a href="#l34.650"></a><span id="l34.650">       startReplacement = row + 1;</span>
<a href="#l34.651"></a><span id="l34.651">       replaceCount = this._countVisibleRowsForNodeAtRow(row) - 1;</span>
<a href="#l34.652"></a><span id="l34.652" class="difflineat">@@ -1033,19 +1087,22 @@ PlacesTreeView.prototype = {</span>
<a href="#l34.653"></a><span id="l34.653"> </span>
<a href="#l34.654"></a><span id="l34.654">         // If we don't have a parent, we made it all the way to the root</span>
<a href="#l34.655"></a><span id="l34.655">         // and didn't find a match, so we can open our item.</span>
<a href="#l34.656"></a><span id="l34.656">         if (!parent &amp;&amp; !item.containerOpen)</span>
<a href="#l34.657"></a><span id="l34.657">           item.containerOpen = true;</span>
<a href="#l34.658"></a><span id="l34.658">       }</span>
<a href="#l34.659"></a><span id="l34.659">     }</span>
<a href="#l34.660"></a><span id="l34.660"> </span>
<a href="#l34.661"></a><span id="l34.661" class="difflineminus">-    if (this._controller.hasCachedLivemarkInfo(aContainer) &amp;&amp;</span>
<a href="#l34.662"></a><span id="l34.662" class="difflineminus">-        !PlacesUtils.asQuery(this._result.root).queryOptions.excludeItems)</span>
<a href="#l34.663"></a><span id="l34.663" class="difflineminus">-      this._populateLivemarkContainer(aContainer);</span>
<a href="#l34.664"></a><span id="l34.664" class="difflineplus">+    if (this._controller.hasCachedLivemarkInfo(aContainer)) {</span>
<a href="#l34.665"></a><span id="l34.665" class="difflineplus">+      let queryOptions = PlacesUtils.asQuery(this._result.root).queryOptions;</span>
<a href="#l34.666"></a><span id="l34.666" class="difflineplus">+      if (!queryOptions.excludeItems) {</span>
<a href="#l34.667"></a><span id="l34.667" class="difflineplus">+        this._populateLivemarkContainer(aContainer);</span>
<a href="#l34.668"></a><span id="l34.668" class="difflineplus">+      }</span>
<a href="#l34.669"></a><span id="l34.669" class="difflineplus">+    }</span>
<a href="#l34.670"></a><span id="l34.670"> </span>
<a href="#l34.671"></a><span id="l34.671">     this._tree.endUpdateBatch();</span>
<a href="#l34.672"></a><span id="l34.672"> </span>
<a href="#l34.673"></a><span id="l34.673">     // Restore selection.</span>
<a href="#l34.674"></a><span id="l34.674">     this._restoreSelection(nodesToReselect, aContainer);</span>
<a href="#l34.675"></a><span id="l34.675">     this.selection.selectEventsSuppressed = false;</span>
<a href="#l34.676"></a><span id="l34.676">   },</span>
<a href="#l34.677"></a><span id="l34.677"> </span>
<a href="#l34.678"></a><span id="l34.678" class="difflineat">@@ -1084,54 +1141,54 @@ PlacesTreeView.prototype = {</span>
<a href="#l34.679"></a><span id="l34.679">       sortedColumn.element.removeAttribute(&quot;sortDirection&quot;);</span>
<a href="#l34.680"></a><span id="l34.680"> </span>
<a href="#l34.681"></a><span id="l34.681">     // Set new sorting indicator by looking through all columns for ours.</span>
<a href="#l34.682"></a><span id="l34.682">     if (aSortingMode == Ci.nsINavHistoryQueryOptions.SORT_BY_NONE)</span>
<a href="#l34.683"></a><span id="l34.683">       return;</span>
<a href="#l34.684"></a><span id="l34.684"> </span>
<a href="#l34.685"></a><span id="l34.685">     let [desiredColumn, desiredIsDescending] =</span>
<a href="#l34.686"></a><span id="l34.686">       this._sortTypeToColumnType(aSortingMode);</span>
<a href="#l34.687"></a><span id="l34.687" class="difflineminus">-    let colCount = columns.count;</span>
<a href="#l34.688"></a><span id="l34.688">     let column = this._findColumnByType(desiredColumn);</span>
<a href="#l34.689"></a><span id="l34.689">     if (column) {</span>
<a href="#l34.690"></a><span id="l34.690">       let sortDir = desiredIsDescending ? &quot;descending&quot; : &quot;ascending&quot;;</span>
<a href="#l34.691"></a><span id="l34.691">       column.element.setAttribute(&quot;sortDirection&quot;, sortDir);</span>
<a href="#l34.692"></a><span id="l34.692">     }</span>
<a href="#l34.693"></a><span id="l34.693">   },</span>
<a href="#l34.694"></a><span id="l34.694"> </span>
<a href="#l34.695"></a><span id="l34.695">   _inBatchMode: false,</span>
<a href="#l34.696"></a><span id="l34.696" class="difflineminus">-  batching: function PTV_batching(aBatching) {</span>
<a href="#l34.697"></a><span id="l34.697" class="difflineminus">-    if (aBatching == this._inBatchMode)</span>
<a href="#l34.698"></a><span id="l34.698" class="difflineminus">-      return;</span>
<a href="#l34.699"></a><span id="l34.699" class="difflineminus">-    this._inBatchMode = this.selection.selectEventsSuppressed = aBatching;</span>
<a href="#l34.700"></a><span id="l34.700" class="difflineminus">-    if (aBatching)</span>
<a href="#l34.701"></a><span id="l34.701" class="difflineminus">-      this._tree.beginUpdateBatch();</span>
<a href="#l34.702"></a><span id="l34.702" class="difflineminus">-    else</span>
<a href="#l34.703"></a><span id="l34.703" class="difflineminus">-      this._tree.endUpdateBatch();</span>
<a href="#l34.704"></a><span id="l34.704" class="difflineplus">+  batching: function PTV__batching(aToggleMode) {</span>
<a href="#l34.705"></a><span id="l34.705" class="difflineplus">+    if (this._inBatchMode != aToggleMode) {</span>
<a href="#l34.706"></a><span id="l34.706" class="difflineplus">+      this._inBatchMode = this.selection.selectEventsSuppressed = aToggleMode;</span>
<a href="#l34.707"></a><span id="l34.707" class="difflineplus">+      if (this._inBatchMode) {</span>
<a href="#l34.708"></a><span id="l34.708" class="difflineplus">+        this._tree.beginUpdateBatch();</span>
<a href="#l34.709"></a><span id="l34.709" class="difflineplus">+      } else {</span>
<a href="#l34.710"></a><span id="l34.710" class="difflineplus">+        this._tree.endUpdateBatch();</span>
<a href="#l34.711"></a><span id="l34.711" class="difflineplus">+      }</span>
<a href="#l34.712"></a><span id="l34.712" class="difflineplus">+    }</span>
<a href="#l34.713"></a><span id="l34.713">   },</span>
<a href="#l34.714"></a><span id="l34.714"> </span>
<a href="#l34.715"></a><span id="l34.715">   get result() {</span>
<a href="#l34.716"></a><span id="l34.716">     return this._result;</span>
<a href="#l34.717"></a><span id="l34.717">   },</span>
<a href="#l34.718"></a><span id="l34.718" class="difflineminus">-</span>
<a href="#l34.719"></a><span id="l34.719">   set result(val) {</span>
<a href="#l34.720"></a><span id="l34.720">     if (this._result) {</span>
<a href="#l34.721"></a><span id="l34.721">       this._result.removeObserver(this);</span>
<a href="#l34.722"></a><span id="l34.722">       this._rootNode.containerOpen = false;</span>
<a href="#l34.723"></a><span id="l34.723">     }</span>
<a href="#l34.724"></a><span id="l34.724"> </span>
<a href="#l34.725"></a><span id="l34.725">     if (val) {</span>
<a href="#l34.726"></a><span id="l34.726">       this._result = val;</span>
<a href="#l34.727"></a><span id="l34.727" class="difflineminus">-      this._rootNode = val.root;</span>
<a href="#l34.728"></a><span id="l34.728" class="difflineplus">+      this._rootNode = this._result.root;</span>
<a href="#l34.729"></a><span id="l34.729">       this._cellProperties = new Map();</span>
<a href="#l34.730"></a><span id="l34.730" class="difflineminus">-    }</span>
<a href="#l34.731"></a><span id="l34.731" class="difflineminus">-    else if (this._result) {</span>
<a href="#l34.732"></a><span id="l34.732" class="difflineplus">+      this._cuttingNodes = new Set();</span>
<a href="#l34.733"></a><span id="l34.733" class="difflineplus">+    } else if (this._result) {</span>
<a href="#l34.734"></a><span id="l34.734">       delete this._result;</span>
<a href="#l34.735"></a><span id="l34.735">       delete this._rootNode;</span>
<a href="#l34.736"></a><span id="l34.736">       delete this._cellProperties;</span>
<a href="#l34.737"></a><span id="l34.737" class="difflineplus">+      delete this._cuttingNodes;</span>
<a href="#l34.738"></a><span id="l34.738">     }</span>
<a href="#l34.739"></a><span id="l34.739"> </span>
<a href="#l34.740"></a><span id="l34.740">     // If the tree is not set yet, setTree will call finishInit.</span>
<a href="#l34.741"></a><span id="l34.741">     if (this._tree &amp;&amp; val)</span>
<a href="#l34.742"></a><span id="l34.742">       this._finishInit();</span>
<a href="#l34.743"></a><span id="l34.743"> </span>
<a href="#l34.744"></a><span id="l34.744">     return val;</span>
<a href="#l34.745"></a><span id="l34.745">   },</span>
<a href="#l34.746"></a><span id="l34.746" class="difflineat">@@ -1142,103 +1199,112 @@ PlacesTreeView.prototype = {</span>
<a href="#l34.747"></a><span id="l34.747"> </span>
<a href="#l34.748"></a><span id="l34.748">     return this._getNodeForRow(aIndex);</span>
<a href="#l34.749"></a><span id="l34.749">   },</span>
<a href="#l34.750"></a><span id="l34.750"> </span>
<a href="#l34.751"></a><span id="l34.751">   treeIndexForNode: function PTV_treeNodeForIndex(aNode) {</span>
<a href="#l34.752"></a><span id="l34.752">     // The API allows passing invisible nodes.</span>
<a href="#l34.753"></a><span id="l34.753">     try {</span>
<a href="#l34.754"></a><span id="l34.754">       return this._getRowForNode(aNode, true);</span>
<a href="#l34.755"></a><span id="l34.755" class="difflineminus">-    }</span>
<a href="#l34.756"></a><span id="l34.756" class="difflineminus">-    catch(ex) { }</span>
<a href="#l34.757"></a><span id="l34.757" class="difflineplus">+    } catch (ex) { }</span>
<a href="#l34.758"></a><span id="l34.758"> </span>
<a href="#l34.759"></a><span id="l34.759">     return Ci.nsINavHistoryResultTreeViewer.INDEX_INVISIBLE;</span>
<a href="#l34.760"></a><span id="l34.760">   },</span>
<a href="#l34.761"></a><span id="l34.761"> </span>
<a href="#l34.762"></a><span id="l34.762">   // nsITreeView</span>
<a href="#l34.763"></a><span id="l34.763">   get rowCount() {</span>
<a href="#l34.764"></a><span id="l34.764">     return this._rows.length;</span>
<a href="#l34.765"></a><span id="l34.765">   },</span>
<a href="#l34.766"></a><span id="l34.766" class="difflineminus">-</span>
<a href="#l34.767"></a><span id="l34.767">   get selection() {</span>
<a href="#l34.768"></a><span id="l34.768">     return this._selection;</span>
<a href="#l34.769"></a><span id="l34.769">   },</span>
<a href="#l34.770"></a><span id="l34.770" class="difflineminus">-</span>
<a href="#l34.771"></a><span id="l34.771">   set selection(val) {</span>
<a href="#l34.772"></a><span id="l34.772" class="difflineminus">-    return this._selection = val;</span>
<a href="#l34.773"></a><span id="l34.773" class="difflineplus">+    this._selection = val;</span>
<a href="#l34.774"></a><span id="l34.774">   },</span>
<a href="#l34.775"></a><span id="l34.775"> </span>
<a href="#l34.776"></a><span id="l34.776" class="difflineminus">-  getRowProperties: function PTV_getRowProperties(aRow) { return &quot;&quot;; },</span>
<a href="#l34.777"></a><span id="l34.777" class="difflineplus">+  getRowProperties() { return &quot;&quot;; },</span>
<a href="#l34.778"></a><span id="l34.778"> </span>
<a href="#l34.779"></a><span id="l34.779" class="difflineminus">-  getCellProperties: function PTV_getCellProperties(aRow, aColumn) {</span>
<a href="#l34.780"></a><span id="l34.780" class="difflineplus">+  getCellProperties:</span>
<a href="#l34.781"></a><span id="l34.781" class="difflineplus">+  function PTV_getCellProperties(aRow, aColumn) {</span>
<a href="#l34.782"></a><span id="l34.782">     // for anonid-trees, we need to add the column-type manually</span>
<a href="#l34.783"></a><span id="l34.783" class="difflineminus">-    var columnType = aColumn.element.getAttribute(&quot;anonid&quot;) || aColumn.id;</span>
<a href="#l34.784"></a><span id="l34.784" class="difflineplus">+    var props = &quot;&quot;;</span>
<a href="#l34.785"></a><span id="l34.785" class="difflineplus">+    let columnType = aColumn.element.getAttribute(&quot;anonid&quot;);</span>
<a href="#l34.786"></a><span id="l34.786" class="difflineplus">+    if (columnType)</span>
<a href="#l34.787"></a><span id="l34.787" class="difflineplus">+      props += columnType;</span>
<a href="#l34.788"></a><span id="l34.788" class="difflineplus">+    else</span>
<a href="#l34.789"></a><span id="l34.789" class="difflineplus">+      columnType = aColumn.id;</span>
<a href="#l34.790"></a><span id="l34.790"> </span>
<a href="#l34.791"></a><span id="l34.791">     // Set the &quot;ltr&quot; property on url cells</span>
<a href="#l34.792"></a><span id="l34.792">     if (columnType == &quot;url&quot;)</span>
<a href="#l34.793"></a><span id="l34.793" class="difflineminus">-      return &quot;url ltr&quot;;</span>
<a href="#l34.794"></a><span id="l34.794" class="difflineplus">+      props += &quot; ltr&quot;;</span>
<a href="#l34.795"></a><span id="l34.795"> </span>
<a href="#l34.796"></a><span id="l34.796">     if (columnType != &quot;title&quot;)</span>
<a href="#l34.797"></a><span id="l34.797" class="difflineminus">-      return columnType;</span>
<a href="#l34.798"></a><span id="l34.798" class="difflineplus">+      return props;</span>
<a href="#l34.799"></a><span id="l34.799"> </span>
<a href="#l34.800"></a><span id="l34.800">     let node = this._getNodeForRow(aRow);</span>
<a href="#l34.801"></a><span id="l34.801" class="difflineplus">+</span>
<a href="#l34.802"></a><span id="l34.802" class="difflineplus">+    if (this._cuttingNodes.has(node)) {</span>
<a href="#l34.803"></a><span id="l34.803" class="difflineplus">+      props += &quot; cutting&quot;;</span>
<a href="#l34.804"></a><span id="l34.804" class="difflineplus">+    }</span>
<a href="#l34.805"></a><span id="l34.805" class="difflineplus">+</span>
<a href="#l34.806"></a><span id="l34.806">     let properties = this._cellProperties.get(node);</span>
<a href="#l34.807"></a><span id="l34.807" class="difflineminus">-    if (!properties) {</span>
<a href="#l34.808"></a><span id="l34.808" class="difflineminus">-      properties = &quot;title&quot;;</span>
<a href="#l34.809"></a><span id="l34.809" class="difflineplus">+    if (properties === undefined) {</span>
<a href="#l34.810"></a><span id="l34.810" class="difflineplus">+      properties = &quot;&quot;;</span>
<a href="#l34.811"></a><span id="l34.811">       let itemId = node.itemId;</span>
<a href="#l34.812"></a><span id="l34.812">       let nodeType = node.type;</span>
<a href="#l34.813"></a><span id="l34.813" class="difflineminus">-      if (PlacesUtils.containerTypes.indexOf(nodeType) != -1) {</span>
<a href="#l34.814"></a><span id="l34.814" class="difflineplus">+      if (PlacesUtils.containerTypes.includes(nodeType)) {</span>
<a href="#l34.815"></a><span id="l34.815">         if (nodeType == Ci.nsINavHistoryResultNode.RESULT_TYPE_QUERY) {</span>
<a href="#l34.816"></a><span id="l34.816">           properties += &quot; query&quot;;</span>
<a href="#l34.817"></a><span id="l34.817">           if (PlacesUtils.nodeIsTagQuery(node))</span>
<a href="#l34.818"></a><span id="l34.818">             properties += &quot; tagContainer&quot;;</span>
<a href="#l34.819"></a><span id="l34.819">           else if (PlacesUtils.nodeIsDay(node))</span>
<a href="#l34.820"></a><span id="l34.820">             properties += &quot; dayContainer&quot;;</span>
<a href="#l34.821"></a><span id="l34.821">           else if (PlacesUtils.nodeIsHost(node))</span>
<a href="#l34.822"></a><span id="l34.822">             properties += &quot; hostContainer&quot;;</span>
<a href="#l34.823"></a><span id="l34.823" class="difflineminus">-        }</span>
<a href="#l34.824"></a><span id="l34.824" class="difflineminus">-        else if (nodeType == Ci.nsINavHistoryResultNode.RESULT_TYPE_FOLDER ||</span>
<a href="#l34.825"></a><span id="l34.825" class="difflineplus">+        } else if (nodeType == Ci.nsINavHistoryResultNode.RESULT_TYPE_FOLDER ||</span>
<a href="#l34.826"></a><span id="l34.826">                  nodeType == Ci.nsINavHistoryResultNode.RESULT_TYPE_FOLDER_SHORTCUT) {</span>
<a href="#l34.827"></a><span id="l34.827" class="difflineminus">-          if (this._controller.hasCachedLivemarkInfo(node))</span>
<a href="#l34.828"></a><span id="l34.828" class="difflineplus">+          if (this._controller.hasCachedLivemarkInfo(node)) {</span>
<a href="#l34.829"></a><span id="l34.829">             properties += &quot; livemark&quot;;</span>
<a href="#l34.830"></a><span id="l34.830" class="difflineminus">-          else {</span>
<a href="#l34.831"></a><span id="l34.831" class="difflineplus">+          } else {</span>
<a href="#l34.832"></a><span id="l34.832">             PlacesUtils.livemarks.getLivemark({ id: node.itemId })</span>
<a href="#l34.833"></a><span id="l34.833" class="difflineminus">-                                 .then(aLivemark =&gt; {</span>
<a href="#l34.834"></a><span id="l34.834" class="difflineminus">-              this._controller.cacheLivemarkInfo(node, aLivemark);</span>
<a href="#l34.835"></a><span id="l34.835" class="difflineminus">-              properties += &quot; livemark&quot;;</span>
<a href="#l34.836"></a><span id="l34.836" class="difflineminus">-              this._cellProperties.set(node, properties);</span>
<a href="#l34.837"></a><span id="l34.837" class="difflineminus">-              // The livemark attribute is set as a cell property on the title cell.</span>
<a href="#l34.838"></a><span id="l34.838" class="difflineminus">-              this._invalidateCellValue(node, this.COLUMN_TYPE_TITLE);</span>
<a href="#l34.839"></a><span id="l34.839" class="difflineminus">-            }, () =&gt; undefined);</span>
<a href="#l34.840"></a><span id="l34.840" class="difflineplus">+              .then(aLivemark =&gt; {</span>
<a href="#l34.841"></a><span id="l34.841" class="difflineplus">+                this._controller.cacheLivemarkInfo(node, aLivemark);</span>
<a href="#l34.842"></a><span id="l34.842" class="difflineplus">+                let livemarkProps = this._cellProperties.get(node);</span>
<a href="#l34.843"></a><span id="l34.843" class="difflineplus">+                this._cellProperties.set(node, livemarkProps += &quot; livemark&quot;);</span>
<a href="#l34.844"></a><span id="l34.844" class="difflineplus">+                // The livemark attribute is set as a cell property on the title cell.</span>
<a href="#l34.845"></a><span id="l34.845" class="difflineplus">+                this._invalidateCellValue(node, this.COLUMN_TYPE_TITLE);</span>
<a href="#l34.846"></a><span id="l34.846" class="difflineplus">+              }, () =&gt; undefined);</span>
<a href="#l34.847"></a><span id="l34.847">           }</span>
<a href="#l34.848"></a><span id="l34.848">         }</span>
<a href="#l34.849"></a><span id="l34.849"> </span>
<a href="#l34.850"></a><span id="l34.850">         if (itemId != -1) {</span>
<a href="#l34.851"></a><span id="l34.851">           let queryName = PlacesUIUtils.getLeftPaneQueryNameFromId(itemId);</span>
<a href="#l34.852"></a><span id="l34.852">           if (queryName)</span>
<a href="#l34.853"></a><span id="l34.853">             properties += &quot; OrganizerQuery_&quot; + queryName;</span>
<a href="#l34.854"></a><span id="l34.854">         }</span>
<a href="#l34.855"></a><span id="l34.855" class="difflineminus">-      }</span>
<a href="#l34.856"></a><span id="l34.856" class="difflineminus">-      else if (nodeType == Ci.nsINavHistoryResultNode.RESULT_TYPE_SEPARATOR)</span>
<a href="#l34.857"></a><span id="l34.857" class="difflineplus">+      } else if (nodeType == Ci.nsINavHistoryResultNode.RESULT_TYPE_SEPARATOR)</span>
<a href="#l34.858"></a><span id="l34.858">         properties += &quot; separator&quot;;</span>
<a href="#l34.859"></a><span id="l34.859">       else if (PlacesUtils.nodeIsURI(node)) {</span>
<a href="#l34.860"></a><span id="l34.860">         properties += &quot; &quot; + PlacesUIUtils.guessUrlSchemeForUI(node.uri);</span>
<a href="#l34.861"></a><span id="l34.861" class="difflineplus">+</span>
<a href="#l34.862"></a><span id="l34.862">         if (this._controller.hasCachedLivemarkInfo(node.parent)) {</span>
<a href="#l34.863"></a><span id="l34.863">           properties += &quot; livemarkItem&quot;;</span>
<a href="#l34.864"></a><span id="l34.864" class="difflineminus">-          if (node.accessCount)</span>
<a href="#l34.865"></a><span id="l34.865" class="difflineplus">+          if (node.accessCount) {</span>
<a href="#l34.866"></a><span id="l34.866">             properties += &quot; visited&quot;;</span>
<a href="#l34.867"></a><span id="l34.867" class="difflineplus">+          }</span>
<a href="#l34.868"></a><span id="l34.868">         }</span>
<a href="#l34.869"></a><span id="l34.869">       }</span>
<a href="#l34.870"></a><span id="l34.870"> </span>
<a href="#l34.871"></a><span id="l34.871">       this._cellProperties.set(node, properties);</span>
<a href="#l34.872"></a><span id="l34.872">     }</span>
<a href="#l34.873"></a><span id="l34.873" class="difflineminus">-    return properties;</span>
<a href="#l34.874"></a><span id="l34.874" class="difflineplus">+</span>
<a href="#l34.875"></a><span id="l34.875" class="difflineplus">+    return props + &quot; &quot; + properties;</span>
<a href="#l34.876"></a><span id="l34.876">   },</span>
<a href="#l34.877"></a><span id="l34.877"> </span>
<a href="#l34.878"></a><span id="l34.878" class="difflineminus">-  getColumnProperties: function(aColumn) { return &quot;&quot;; },</span>
<a href="#l34.879"></a><span id="l34.879" class="difflineplus">+  getColumnProperties(aColumn) { return &quot;&quot;; },</span>
<a href="#l34.880"></a><span id="l34.880"> </span>
<a href="#l34.881"></a><span id="l34.881">   isContainer: function PTV_isContainer(aRow) {</span>
<a href="#l34.882"></a><span id="l34.882">     // Only leaf nodes aren't listed in the rows array.</span>
<a href="#l34.883"></a><span id="l34.883">     let node = this._rows[aRow];</span>
<a href="#l34.884"></a><span id="l34.884">     if (node === undefined)</span>
<a href="#l34.885"></a><span id="l34.885">       return false;</span>
<a href="#l34.886"></a><span id="l34.886"> </span>
<a href="#l34.887"></a><span id="l34.887">     if (PlacesUtils.nodeIsContainer(node)) {</span>
<a href="#l34.888"></a><span id="l34.888" class="difflineat">@@ -1267,21 +1333,24 @@ PlacesTreeView.prototype = {</span>
<a href="#l34.889"></a><span id="l34.889">     // All containers are listed in the rows array.</span>
<a href="#l34.890"></a><span id="l34.890">     return this._rows[aRow].containerOpen;</span>
<a href="#l34.891"></a><span id="l34.891">   },</span>
<a href="#l34.892"></a><span id="l34.892"> </span>
<a href="#l34.893"></a><span id="l34.893">   isContainerEmpty: function PTV_isContainerEmpty(aRow) {</span>
<a href="#l34.894"></a><span id="l34.894">     if (this._flatList)</span>
<a href="#l34.895"></a><span id="l34.895">       return true;</span>
<a href="#l34.896"></a><span id="l34.896"> </span>
<a href="#l34.897"></a><span id="l34.897" class="difflineminus">-    if (this._controller.hasCachedLivemarkInfo(this._rows[aRow]))</span>
<a href="#l34.898"></a><span id="l34.898" class="difflineminus">-      return PlacesUtils.asQuery(this._result.root).queryOptions.excludeItems;</span>
<a href="#l34.899"></a><span id="l34.899" class="difflineplus">+    let node = this._rows[aRow];</span>
<a href="#l34.900"></a><span id="l34.900" class="difflineplus">+    if (this._controller.hasCachedLivemarkInfo(node)) {</span>
<a href="#l34.901"></a><span id="l34.901" class="difflineplus">+      let queryOptions = PlacesUtils.asQuery(this._result.root).queryOptions;</span>
<a href="#l34.902"></a><span id="l34.902" class="difflineplus">+      return queryOptions.excludeItems;</span>
<a href="#l34.903"></a><span id="l34.903" class="difflineplus">+    }</span>
<a href="#l34.904"></a><span id="l34.904"> </span>
<a href="#l34.905"></a><span id="l34.905">     // All containers are listed in the rows array.</span>
<a href="#l34.906"></a><span id="l34.906" class="difflineminus">-    return !this._rows[aRow].hasChildren;</span>
<a href="#l34.907"></a><span id="l34.907" class="difflineplus">+    return !node.hasChildren;</span>
<a href="#l34.908"></a><span id="l34.908">   },</span>
<a href="#l34.909"></a><span id="l34.909"> </span>
<a href="#l34.910"></a><span id="l34.910">   isSeparator: function PTV_isSeparator(aRow) {</span>
<a href="#l34.911"></a><span id="l34.911">     // All separators are listed in the rows array.</span>
<a href="#l34.912"></a><span id="l34.912">     let node = this._rows[aRow];</span>
<a href="#l34.913"></a><span id="l34.913">     return node &amp;&amp; PlacesUtils.nodeIsSeparator(node);</span>
<a href="#l34.914"></a><span id="l34.914">   },</span>
<a href="#l34.915"></a><span id="l34.915"> </span>
<a href="#l34.916"></a><span id="l34.916" class="difflineat">@@ -1309,27 +1378,25 @@ PlacesTreeView.prototype = {</span>
<a href="#l34.917"></a><span id="l34.917">     // the view is populated from (i.e. the result's itemId).</span>
<a href="#l34.918"></a><span id="l34.918">     if (index != -1) {</span>
<a href="#l34.919"></a><span id="l34.919">       let lastSelected = this.nodeForTreeIndex(index);</span>
<a href="#l34.920"></a><span id="l34.920">       if (this.isContainer(index) &amp;&amp; orientation == Ci.nsITreeView.DROP_ON) {</span>
<a href="#l34.921"></a><span id="l34.921">         // If the last selected item is an open container, append _into_</span>
<a href="#l34.922"></a><span id="l34.922">         // it, rather than insert adjacent to it.</span>
<a href="#l34.923"></a><span id="l34.923">         container = lastSelected;</span>
<a href="#l34.924"></a><span id="l34.924">         index = -1;</span>
<a href="#l34.925"></a><span id="l34.925" class="difflineminus">-      }</span>
<a href="#l34.926"></a><span id="l34.926" class="difflineminus">-      else if (lastSelected.containerOpen &amp;&amp;</span>
<a href="#l34.927"></a><span id="l34.927" class="difflineplus">+      } else if (lastSelected.containerOpen &amp;&amp;</span>
<a href="#l34.928"></a><span id="l34.928">                orientation == Ci.nsITreeView.DROP_AFTER &amp;&amp;</span>
<a href="#l34.929"></a><span id="l34.929">                lastSelected.hasChildren) {</span>
<a href="#l34.930"></a><span id="l34.930">         // If the last selected node is an open container and the user is</span>
<a href="#l34.931"></a><span id="l34.931">         // trying to drag into it as a first node, really insert into it.</span>
<a href="#l34.932"></a><span id="l34.932">         container = lastSelected;</span>
<a href="#l34.933"></a><span id="l34.933">         orientation = Ci.nsITreeView.DROP_ON;</span>
<a href="#l34.934"></a><span id="l34.934">         index = 0;</span>
<a href="#l34.935"></a><span id="l34.935" class="difflineminus">-      }</span>
<a href="#l34.936"></a><span id="l34.936" class="difflineminus">-      else {</span>
<a href="#l34.937"></a><span id="l34.937" class="difflineplus">+      } else {</span>
<a href="#l34.938"></a><span id="l34.938">         // Use the last-selected node's container.</span>
<a href="#l34.939"></a><span id="l34.939">         container = lastSelected.parent;</span>
<a href="#l34.940"></a><span id="l34.940"> </span>
<a href="#l34.941"></a><span id="l34.941">         // During its Drag &amp; Drop operation, the tree code closes-and-opens</span>
<a href="#l34.942"></a><span id="l34.942">         // containers very often (part of the XUL &quot;spring-loaded folders&quot;</span>
<a href="#l34.943"></a><span id="l34.943">         // implementation).  And in certain cases, we may reach a closed</span>
<a href="#l34.944"></a><span id="l34.944">         // container here.  However, we can simply bail out when this happens,</span>
<a href="#l34.945"></a><span id="l34.945">         // because we would then be back here in less than a millisecond, when</span>
<a href="#l34.946"></a><span id="l34.946" class="difflineat">@@ -1342,55 +1409,63 @@ PlacesTreeView.prototype = {</span>
<a href="#l34.947"></a><span id="l34.947">         if (PlacesControllerDragHelper.disallowInsertion(container))</span>
<a href="#l34.948"></a><span id="l34.948">           return null;</span>
<a href="#l34.949"></a><span id="l34.949"> </span>
<a href="#l34.950"></a><span id="l34.950">         let queryOptions = PlacesUtils.asQuery(this._result.root).queryOptions;</span>
<a href="#l34.951"></a><span id="l34.951">         if (queryOptions.sortingMode !=</span>
<a href="#l34.952"></a><span id="l34.952">               Ci.nsINavHistoryQueryOptions.SORT_BY_NONE) {</span>
<a href="#l34.953"></a><span id="l34.953">           // If we are within a sorted view, insert at the end.</span>
<a href="#l34.954"></a><span id="l34.954">           index = -1;</span>
<a href="#l34.955"></a><span id="l34.955" class="difflineminus">-        }</span>
<a href="#l34.956"></a><span id="l34.956" class="difflineminus">-        else if (queryOptions.excludeItems ||</span>
<a href="#l34.957"></a><span id="l34.957" class="difflineplus">+        } else if (queryOptions.excludeItems ||</span>
<a href="#l34.958"></a><span id="l34.958">                  queryOptions.excludeQueries ||</span>
<a href="#l34.959"></a><span id="l34.959">                  queryOptions.excludeReadOnlyFolders) {</span>
<a href="#l34.960"></a><span id="l34.960">           // Some item may be invisible, insert near last selected one.</span>
<a href="#l34.961"></a><span id="l34.961">           // We don't replace index here to avoid requests to the db,</span>
<a href="#l34.962"></a><span id="l34.962">           // instead it will be calculated later by the controller.</span>
<a href="#l34.963"></a><span id="l34.963">           index = -1;</span>
<a href="#l34.964"></a><span id="l34.964">           dropNearItemId = lastSelected.itemId;</span>
<a href="#l34.965"></a><span id="l34.965" class="difflineminus">-        }</span>
<a href="#l34.966"></a><span id="l34.966" class="difflineminus">-        else {</span>
<a href="#l34.967"></a><span id="l34.967" class="difflineplus">+        } else {</span>
<a href="#l34.968"></a><span id="l34.968">           let lsi = container.getChildIndex(lastSelected);</span>
<a href="#l34.969"></a><span id="l34.969">           index = orientation == Ci.nsITreeView.DROP_BEFORE ? lsi : lsi + 1;</span>
<a href="#l34.970"></a><span id="l34.970">         }</span>
<a href="#l34.971"></a><span id="l34.971">       }</span>
<a href="#l34.972"></a><span id="l34.972">     }</span>
<a href="#l34.973"></a><span id="l34.973"> </span>
<a href="#l34.974"></a><span id="l34.974">     if (PlacesControllerDragHelper.disallowInsertion(container))</span>
<a href="#l34.975"></a><span id="l34.975">       return null;</span>
<a href="#l34.976"></a><span id="l34.976"> </span>
<a href="#l34.977"></a><span id="l34.977" class="difflineplus">+    // TODO (Bug 1160193): properly support dropping on a tag root.</span>
<a href="#l34.978"></a><span id="l34.978" class="difflineplus">+    let tagName = null;</span>
<a href="#l34.979"></a><span id="l34.979" class="difflineplus">+    if (PlacesUtils.nodeIsTagQuery(container)) {</span>
<a href="#l34.980"></a><span id="l34.980" class="difflineplus">+      tagName = container.title;</span>
<a href="#l34.981"></a><span id="l34.981" class="difflineplus">+      if (!tagName)</span>
<a href="#l34.982"></a><span id="l34.982" class="difflineplus">+        return null;</span>
<a href="#l34.983"></a><span id="l34.983" class="difflineplus">+    }</span>
<a href="#l34.984"></a><span id="l34.984" class="difflineplus">+</span>
<a href="#l34.985"></a><span id="l34.985">     return new InsertionPoint(PlacesUtils.getConcreteItemId(container),</span>
<a href="#l34.986"></a><span id="l34.986">                               index, orientation,</span>
<a href="#l34.987"></a><span id="l34.987" class="difflineminus">-                              PlacesUtils.nodeIsTagQuery(container),</span>
<a href="#l34.988"></a><span id="l34.988" class="difflineplus">+                              tagName,</span>
<a href="#l34.989"></a><span id="l34.989">                               dropNearItemId);</span>
<a href="#l34.990"></a><span id="l34.990">   },</span>
<a href="#l34.991"></a><span id="l34.991"> </span>
<a href="#l34.992"></a><span id="l34.992">   drop: function PTV_drop(aRow, aOrientation, aDataTransfer) {</span>
<a href="#l34.993"></a><span id="l34.993">     // We are responsible for translating the |index| and |orientation|</span>
<a href="#l34.994"></a><span id="l34.994">     // parameters into a container id and index within the container,</span>
<a href="#l34.995"></a><span id="l34.995">     // since this information is specific to the tree view.</span>
<a href="#l34.996"></a><span id="l34.996">     let ip = this._getInsertionPoint(aRow, aOrientation);</span>
<a href="#l34.997"></a><span id="l34.997" class="difflineminus">-    if (ip)</span>
<a href="#l34.998"></a><span id="l34.998" class="difflineminus">-      PlacesControllerDragHelper.onDrop(ip, aDataTransfer);</span>
<a href="#l34.999"></a><span id="l34.999" class="difflineplus">+    if (ip) {</span>
<a href="#l34.1000"></a><span id="l34.1000" class="difflineplus">+      PlacesControllerDragHelper.onDrop(ip, aDataTransfer)</span>
<a href="#l34.1001"></a><span id="l34.1001" class="difflineplus">+                                .catch(Cu.reportError);</span>
<a href="#l34.1002"></a><span id="l34.1002" class="difflineplus">+    }</span>
<a href="#l34.1003"></a><span id="l34.1003"> </span>
<a href="#l34.1004"></a><span id="l34.1004">     PlacesControllerDragHelper.currentDropTarget = null;</span>
<a href="#l34.1005"></a><span id="l34.1005">   },</span>
<a href="#l34.1006"></a><span id="l34.1006"> </span>
<a href="#l34.1007"></a><span id="l34.1007">   getParentIndex: function PTV_getParentIndex(aRow) {</span>
<a href="#l34.1008"></a><span id="l34.1008" class="difflineminus">-    let [parentNode, parentRow] = this._getParentByChildRow(aRow);</span>
<a href="#l34.1009"></a><span id="l34.1009" class="difflineplus">+    let [, parentRow] = this._getParentByChildRow(aRow);</span>
<a href="#l34.1010"></a><span id="l34.1010">     return parentRow;</span>
<a href="#l34.1011"></a><span id="l34.1011">   },</span>
<a href="#l34.1012"></a><span id="l34.1012"> </span>
<a href="#l34.1013"></a><span id="l34.1013">   hasNextSibling: function PTV_hasNextSibling(aRow, aAfterIndex) {</span>
<a href="#l34.1014"></a><span id="l34.1014">     if (aRow == this._rows.length - 1) {</span>
<a href="#l34.1015"></a><span id="l34.1015">       // The last row has no sibling.</span>
<a href="#l34.1016"></a><span id="l34.1016">       return false;</span>
<a href="#l34.1017"></a><span id="l34.1017">     }</span>
<a href="#l34.1018"></a><span id="l34.1018" class="difflineat">@@ -1412,42 +1487,43 @@ PlacesTreeView.prototype = {</span>
<a href="#l34.1019"></a><span id="l34.1019">         return true;</span>
<a href="#l34.1020"></a><span id="l34.1020">       if (nextLevel &lt; thisLevel)</span>
<a href="#l34.1021"></a><span id="l34.1021">         break;</span>
<a href="#l34.1022"></a><span id="l34.1022">     }</span>
<a href="#l34.1023"></a><span id="l34.1023"> </span>
<a href="#l34.1024"></a><span id="l34.1024">     return false;</span>
<a href="#l34.1025"></a><span id="l34.1025">   },</span>
<a href="#l34.1026"></a><span id="l34.1026"> </span>
<a href="#l34.1027"></a><span id="l34.1027" class="difflineminus">-  getLevel: function(aRow) {</span>
<a href="#l34.1028"></a><span id="l34.1028" class="difflineplus">+  getLevel(aRow) {</span>
<a href="#l34.1029"></a><span id="l34.1029">     return this._getNodeForRow(aRow).indentLevel;</span>
<a href="#l34.1030"></a><span id="l34.1030">   },</span>
<a href="#l34.1031"></a><span id="l34.1031"> </span>
<a href="#l34.1032"></a><span id="l34.1032">   getImageSrc: function PTV_getImageSrc(aRow, aColumn) {</span>
<a href="#l34.1033"></a><span id="l34.1033">     // Only the title column has an image.</span>
<a href="#l34.1034"></a><span id="l34.1034">     if (this._getColumnType(aColumn) != this.COLUMN_TYPE_TITLE)</span>
<a href="#l34.1035"></a><span id="l34.1035">       return &quot;&quot;;</span>
<a href="#l34.1036"></a><span id="l34.1036"> </span>
<a href="#l34.1037"></a><span id="l34.1037" class="difflineminus">-    return this._getNodeForRow(aRow).icon;</span>
<a href="#l34.1038"></a><span id="l34.1038" class="difflineplus">+    let node = this._getNodeForRow(aRow);</span>
<a href="#l34.1039"></a><span id="l34.1039" class="difflineplus">+    return node.icon;</span>
<a href="#l34.1040"></a><span id="l34.1040">   },</span>
<a href="#l34.1041"></a><span id="l34.1041"> </span>
<a href="#l34.1042"></a><span id="l34.1042" class="difflineminus">-  getProgressMode: function(aRow, aColumn) { },</span>
<a href="#l34.1043"></a><span id="l34.1043" class="difflineminus">-  getCellValue: function(aRow, aColumn) { },</span>
<a href="#l34.1044"></a><span id="l34.1044" class="difflineplus">+  getProgressMode(aRow, aColumn) { },</span>
<a href="#l34.1045"></a><span id="l34.1045" class="difflineplus">+  getCellValue(aRow, aColumn) { },</span>
<a href="#l34.1046"></a><span id="l34.1046"> </span>
<a href="#l34.1047"></a><span id="l34.1047">   getCellText: function PTV_getCellText(aRow, aColumn) {</span>
<a href="#l34.1048"></a><span id="l34.1048">     let node = this._getNodeForRow(aRow);</span>
<a href="#l34.1049"></a><span id="l34.1049">     switch (this._getColumnType(aColumn)) {</span>
<a href="#l34.1050"></a><span id="l34.1050">       case this.COLUMN_TYPE_TITLE:</span>
<a href="#l34.1051"></a><span id="l34.1051">         // normally, this is just the title, but we don't want empty items in</span>
<a href="#l34.1052"></a><span id="l34.1052">         // the tree view so return a special string if the title is empty.</span>
<a href="#l34.1053"></a><span id="l34.1053">         // Do it here so that callers can still get at the 0 length title</span>
<a href="#l34.1054"></a><span id="l34.1054">         // if they go through the &quot;result&quot; API.</span>
<a href="#l34.1055"></a><span id="l34.1055">         if (PlacesUtils.nodeIsSeparator(node))</span>
<a href="#l34.1056"></a><span id="l34.1056">           return &quot;&quot;;</span>
<a href="#l34.1057"></a><span id="l34.1057" class="difflineminus">-        return PlacesUIUtils.getBestTitle(node);</span>
<a href="#l34.1058"></a><span id="l34.1058" class="difflineplus">+        return PlacesUIUtils.getBestTitle(node, true);</span>
<a href="#l34.1059"></a><span id="l34.1059">       case this.COLUMN_TYPE_TAGS:</span>
<a href="#l34.1060"></a><span id="l34.1060">         return node.tags;</span>
<a href="#l34.1061"></a><span id="l34.1061">       case this.COLUMN_TYPE_URI:</span>
<a href="#l34.1062"></a><span id="l34.1062">         if (PlacesUtils.nodeIsURI(node))</span>
<a href="#l34.1063"></a><span id="l34.1063">           return node.uri;</span>
<a href="#l34.1064"></a><span id="l34.1064">         return &quot;&quot;;</span>
<a href="#l34.1065"></a><span id="l34.1065">       case this.COLUMN_TYPE_DATE:</span>
<a href="#l34.1066"></a><span id="l34.1066">         let nodeTime = node.time;</span>
<a href="#l34.1067"></a><span id="l34.1067" class="difflineat">@@ -1458,27 +1534,22 @@ PlacesTreeView.prototype = {</span>
<a href="#l34.1068"></a><span id="l34.1068">           // I expect, and gives me no information I know how to use.</span>
<a href="#l34.1069"></a><span id="l34.1069">           // Only show this for URI-based items.</span>
<a href="#l34.1070"></a><span id="l34.1070">           return &quot;&quot;;</span>
<a href="#l34.1071"></a><span id="l34.1071">         }</span>
<a href="#l34.1072"></a><span id="l34.1072"> </span>
<a href="#l34.1073"></a><span id="l34.1073">         return this._convertPRTimeToString(nodeTime);</span>
<a href="#l34.1074"></a><span id="l34.1074">       case this.COLUMN_TYPE_VISITCOUNT:</span>
<a href="#l34.1075"></a><span id="l34.1075">         return node.accessCount;</span>
<a href="#l34.1076"></a><span id="l34.1076" class="difflineminus">-      case this.COLUMN_TYPE_KEYWORD:</span>
<a href="#l34.1077"></a><span id="l34.1077" class="difflineminus">-        if (PlacesUtils.nodeIsBookmark(node))</span>
<a href="#l34.1078"></a><span id="l34.1078" class="difflineminus">-          return PlacesUtils.bookmarks.getKeywordForBookmark(node.itemId);</span>
<a href="#l34.1079"></a><span id="l34.1079" class="difflineminus">-        return &quot;&quot;;</span>
<a href="#l34.1080"></a><span id="l34.1080">       case this.COLUMN_TYPE_DESCRIPTION:</span>
<a href="#l34.1081"></a><span id="l34.1081">         if (node.itemId != -1) {</span>
<a href="#l34.1082"></a><span id="l34.1082">           try {</span>
<a href="#l34.1083"></a><span id="l34.1083" class="difflineminus">-            return PlacesUtils.annotations</span>
<a href="#l34.1084"></a><span id="l34.1084" class="difflineminus">-                              .getItemAnnotation(node.itemId, PlacesUIUtils.DESCRIPTION_ANNO);</span>
<a href="#l34.1085"></a><span id="l34.1085" class="difflineminus">-          }</span>
<a href="#l34.1086"></a><span id="l34.1086" class="difflineminus">-          catch (ex) { /* has no description */ }</span>
<a href="#l34.1087"></a><span id="l34.1087" class="difflineplus">+            return PlacesUtils.annotations.</span>
<a href="#l34.1088"></a><span id="l34.1088" class="difflineplus">+                               getItemAnnotation(node.itemId, PlacesUIUtils.DESCRIPTION_ANNO);</span>
<a href="#l34.1089"></a><span id="l34.1089" class="difflineplus">+          } catch (ex) { /* has no description */ }</span>
<a href="#l34.1090"></a><span id="l34.1090">         }</span>
<a href="#l34.1091"></a><span id="l34.1091">         return &quot;&quot;;</span>
<a href="#l34.1092"></a><span id="l34.1092">       case this.COLUMN_TYPE_DATEADDED:</span>
<a href="#l34.1093"></a><span id="l34.1093">         if (node.dateAdded)</span>
<a href="#l34.1094"></a><span id="l34.1094">           return this._convertPRTimeToString(node.dateAdded);</span>
<a href="#l34.1095"></a><span id="l34.1095">         return &quot;&quot;;</span>
<a href="#l34.1096"></a><span id="l34.1096">       case this.COLUMN_TYPE_LASTMODIFIED:</span>
<a href="#l34.1097"></a><span id="l34.1097">         if (node.lastModified)</span>
<a href="#l34.1098"></a><span id="l34.1098" class="difflineat">@@ -1516,24 +1587,28 @@ PlacesTreeView.prototype = {</span>
<a href="#l34.1099"></a><span id="l34.1099">       throw Cr.NS_ERROR_UNEXPECTED;</span>
<a href="#l34.1100"></a><span id="l34.1100"> </span>
<a href="#l34.1101"></a><span id="l34.1101">     let node = this._rows[aRow];</span>
<a href="#l34.1102"></a><span id="l34.1102">     if (this._flatList &amp;&amp; this._openContainerCallback) {</span>
<a href="#l34.1103"></a><span id="l34.1103">       this._openContainerCallback(node);</span>
<a href="#l34.1104"></a><span id="l34.1104">       return;</span>
<a href="#l34.1105"></a><span id="l34.1105">     }</span>
<a href="#l34.1106"></a><span id="l34.1106"> </span>
<a href="#l34.1107"></a><span id="l34.1107" class="difflineminus">-    // Persist container open state, except for livemarks.</span>
<a href="#l34.1108"></a><span id="l34.1108" class="difflineplus">+    // Persist containers open status, but never persist livemarks.</span>
<a href="#l34.1109"></a><span id="l34.1109">     if (!this._controller.hasCachedLivemarkInfo(node)) {</span>
<a href="#l34.1110"></a><span id="l34.1110" class="difflineminus">-      NS_ASSERT(node.uri, &quot;if there is no uri, we can't persist the open state&quot;);</span>
<a href="#l34.1111"></a><span id="l34.1111" class="difflineminus">-      if (node.uri) {</span>
<a href="#l34.1112"></a><span id="l34.1112" class="difflineminus">-        if (node.containerOpen)</span>
<a href="#l34.1113"></a><span id="l34.1113" class="difflineminus">-          PlacesUIUtils.xulStore.removeValue(location, node.uri, &quot;open&quot;);</span>
<a href="#l34.1114"></a><span id="l34.1114" class="difflineminus">-        else</span>
<a href="#l34.1115"></a><span id="l34.1115" class="difflineminus">-          PlacesUIUtils.xulStore.setValue(location, node.uri, &quot;open&quot;, &quot;true&quot;);</span>
<a href="#l34.1116"></a><span id="l34.1116" class="difflineplus">+      let uri = node.uri;</span>
<a href="#l34.1117"></a><span id="l34.1117" class="difflineplus">+</span>
<a href="#l34.1118"></a><span id="l34.1118" class="difflineplus">+      if (uri) {</span>
<a href="#l34.1119"></a><span id="l34.1119" class="difflineplus">+        let docURI = document.documentURI;</span>
<a href="#l34.1120"></a><span id="l34.1120" class="difflineplus">+</span>
<a href="#l34.1121"></a><span id="l34.1121" class="difflineplus">+        if (node.containerOpen) {</span>
<a href="#l34.1122"></a><span id="l34.1122" class="difflineplus">+          this._xulStore.removeValue(docURI, uri, &quot;open&quot;);</span>
<a href="#l34.1123"></a><span id="l34.1123" class="difflineplus">+        } else {</span>
<a href="#l34.1124"></a><span id="l34.1124" class="difflineplus">+          this._xulStore.setValue(docURI, uri, &quot;open&quot;, &quot;true&quot;);</span>
<a href="#l34.1125"></a><span id="l34.1125" class="difflineplus">+        }</span>
<a href="#l34.1126"></a><span id="l34.1126">       }</span>
<a href="#l34.1127"></a><span id="l34.1127">     }</span>
<a href="#l34.1128"></a><span id="l34.1128"> </span>
<a href="#l34.1129"></a><span id="l34.1129">     node.containerOpen = !node.containerOpen;</span>
<a href="#l34.1130"></a><span id="l34.1130">   },</span>
<a href="#l34.1131"></a><span id="l34.1131"> </span>
<a href="#l34.1132"></a><span id="l34.1132">   cycleHeader: function PTV_cycleHeader(aColumn) {</span>
<a href="#l34.1133"></a><span id="l34.1133">     if (!this._result)</span>
<a href="#l34.1134"></a><span id="l34.1134" class="difflineat">@@ -1593,32 +1668,22 @@ PlacesTreeView.prototype = {</span>
<a href="#l34.1135"></a><span id="l34.1135">         if (oldSort == NHQO.SORT_BY_VISITCOUNT_DESCENDING)</span>
<a href="#l34.1136"></a><span id="l34.1136">           newSort = NHQO.SORT_BY_VISITCOUNT_ASCENDING;</span>
<a href="#l34.1137"></a><span id="l34.1137">         else if (allowTriState &amp;&amp; oldSort == NHQO.SORT_BY_VISITCOUNT_ASCENDING)</span>
<a href="#l34.1138"></a><span id="l34.1138">           newSort = NHQO.SORT_BY_NONE;</span>
<a href="#l34.1139"></a><span id="l34.1139">         else</span>
<a href="#l34.1140"></a><span id="l34.1140">           newSort = NHQO.SORT_BY_VISITCOUNT_DESCENDING;</span>
<a href="#l34.1141"></a><span id="l34.1141"> </span>
<a href="#l34.1142"></a><span id="l34.1142">         break;</span>
<a href="#l34.1143"></a><span id="l34.1143" class="difflineminus">-      case this.COLUMN_TYPE_KEYWORD:</span>
<a href="#l34.1144"></a><span id="l34.1144" class="difflineminus">-        if (oldSort == NHQO.SORT_BY_KEYWORD_ASCENDING)</span>
<a href="#l34.1145"></a><span id="l34.1145" class="difflineminus">-          newSort = NHQO.SORT_BY_KEYWORD_DESCENDING;</span>
<a href="#l34.1146"></a><span id="l34.1146" class="difflineminus">-        else if (allowTriState &amp;&amp; oldSort == NHQO.SORT_BY_KEYWORD_DESCENDING)</span>
<a href="#l34.1147"></a><span id="l34.1147" class="difflineminus">-          newSort = NHQO.SORT_BY_NONE;</span>
<a href="#l34.1148"></a><span id="l34.1148" class="difflineminus">-        else</span>
<a href="#l34.1149"></a><span id="l34.1149" class="difflineminus">-          newSort = NHQO.SORT_BY_KEYWORD_ASCENDING;</span>
<a href="#l34.1150"></a><span id="l34.1150" class="difflineminus">-</span>
<a href="#l34.1151"></a><span id="l34.1151" class="difflineminus">-        break;</span>
<a href="#l34.1152"></a><span id="l34.1152">       case this.COLUMN_TYPE_DESCRIPTION:</span>
<a href="#l34.1153"></a><span id="l34.1153">         if (oldSort == NHQO.SORT_BY_ANNOTATION_ASCENDING &amp;&amp;</span>
<a href="#l34.1154"></a><span id="l34.1154">             oldSortingAnnotation == PlacesUIUtils.DESCRIPTION_ANNO) {</span>
<a href="#l34.1155"></a><span id="l34.1155">           newSort = NHQO.SORT_BY_ANNOTATION_DESCENDING;</span>
<a href="#l34.1156"></a><span id="l34.1156">           newSortingAnnotation = PlacesUIUtils.DESCRIPTION_ANNO;</span>
<a href="#l34.1157"></a><span id="l34.1157" class="difflineminus">-        }</span>
<a href="#l34.1158"></a><span id="l34.1158" class="difflineminus">-        else if (allowTriState &amp;&amp;</span>
<a href="#l34.1159"></a><span id="l34.1159" class="difflineplus">+        } else if (allowTriState &amp;&amp;</span>
<a href="#l34.1160"></a><span id="l34.1160">                  oldSort == NHQO.SORT_BY_ANNOTATION_DESCENDING &amp;&amp;</span>
<a href="#l34.1161"></a><span id="l34.1161">                  oldSortingAnnotation == PlacesUIUtils.DESCRIPTION_ANNO)</span>
<a href="#l34.1162"></a><span id="l34.1162">           newSort = NHQO.SORT_BY_NONE;</span>
<a href="#l34.1163"></a><span id="l34.1163">         else {</span>
<a href="#l34.1164"></a><span id="l34.1164">           newSort = NHQO.SORT_BY_ANNOTATION_ASCENDING;</span>
<a href="#l34.1165"></a><span id="l34.1165">           newSortingAnnotation = PlacesUIUtils.DESCRIPTION_ANNO;</span>
<a href="#l34.1166"></a><span id="l34.1166">         }</span>
<a href="#l34.1167"></a><span id="l34.1167"> </span>
<a href="#l34.1168"></a><span id="l34.1168" class="difflineat">@@ -1701,20 +1766,37 @@ PlacesTreeView.prototype = {</span>
<a href="#l34.1169"></a><span id="l34.1169"> </span>
<a href="#l34.1170"></a><span id="l34.1170">     return true;</span>
<a href="#l34.1171"></a><span id="l34.1171">   },</span>
<a href="#l34.1172"></a><span id="l34.1172"> </span>
<a href="#l34.1173"></a><span id="l34.1173">   setCellText: function PTV_setCellText(aRow, aColumn, aText) {</span>
<a href="#l34.1174"></a><span id="l34.1174">     // We may only get here if the cell is editable.</span>
<a href="#l34.1175"></a><span id="l34.1175">     let node = this._rows[aRow];</span>
<a href="#l34.1176"></a><span id="l34.1176">     if (node.title != aText) {</span>
<a href="#l34.1177"></a><span id="l34.1177" class="difflineminus">-      let txn = new PlacesEditItemTitleTransaction(node.itemId, aText);</span>
<a href="#l34.1178"></a><span id="l34.1178" class="difflineminus">-      PlacesUtils.transactionManager.doTransaction(txn);</span>
<a href="#l34.1179"></a><span id="l34.1179" class="difflineplus">+      if (!PlacesUIUtils.useAsyncTransactions) {</span>
<a href="#l34.1180"></a><span id="l34.1180" class="difflineplus">+        let txn = new PlacesEditItemTitleTransaction(node.itemId, aText);</span>
<a href="#l34.1181"></a><span id="l34.1181" class="difflineplus">+        PlacesUtils.transactionManager.doTransaction(txn);</span>
<a href="#l34.1182"></a><span id="l34.1182" class="difflineplus">+        return;</span>
<a href="#l34.1183"></a><span id="l34.1183" class="difflineplus">+      }</span>
<a href="#l34.1184"></a><span id="l34.1184" class="difflineplus">+      PlacesTransactions.EditTitle({ guid: node.bookmarkGuid, title: aText })</span>
<a href="#l34.1185"></a><span id="l34.1185" class="difflineplus">+                        .transact().catch(Cu.reportError);</span>
<a href="#l34.1186"></a><span id="l34.1186">     }</span>
<a href="#l34.1187"></a><span id="l34.1187">   },</span>
<a href="#l34.1188"></a><span id="l34.1188"> </span>
<a href="#l34.1189"></a><span id="l34.1189" class="difflineminus">-  selectionChanged: function() { },</span>
<a href="#l34.1190"></a><span id="l34.1190" class="difflineminus">-  cycleCell: function(aRow, aColumn) { },</span>
<a href="#l34.1191"></a><span id="l34.1191" class="difflineminus">-  isSelectable: function(aRow, aColumn) { return false; },</span>
<a href="#l34.1192"></a><span id="l34.1192" class="difflineminus">-  performAction: function(aAction) { },</span>
<a href="#l34.1193"></a><span id="l34.1193" class="difflineminus">-  performActionOnRow: function(aAction, aRow) { },</span>
<a href="#l34.1194"></a><span id="l34.1194" class="difflineminus">-  performActionOnCell: function(aAction, aRow, aColumn) { }</span>
<a href="#l34.1195"></a><span id="l34.1195" class="difflineplus">+  toggleCutNode: function PTV_toggleCutNode(aNode, aValue) {</span>
<a href="#l34.1196"></a><span id="l34.1196" class="difflineplus">+    let currentVal = this._cuttingNodes.has(aNode);</span>
<a href="#l34.1197"></a><span id="l34.1197" class="difflineplus">+    if (currentVal != aValue) {</span>
<a href="#l34.1198"></a><span id="l34.1198" class="difflineplus">+      if (aValue)</span>
<a href="#l34.1199"></a><span id="l34.1199" class="difflineplus">+        this._cuttingNodes.add(aNode);</span>
<a href="#l34.1200"></a><span id="l34.1200" class="difflineplus">+      else</span>
<a href="#l34.1201"></a><span id="l34.1201" class="difflineplus">+        this._cuttingNodes.delete(aNode);</span>
<a href="#l34.1202"></a><span id="l34.1202" class="difflineplus">+</span>
<a href="#l34.1203"></a><span id="l34.1203" class="difflineplus">+      this._invalidateCellValue(aNode, this.COLUMN_TYPE_TITLE);</span>
<a href="#l34.1204"></a><span id="l34.1204" class="difflineplus">+    }</span>
<a href="#l34.1205"></a><span id="l34.1205" class="difflineplus">+  },</span>
<a href="#l34.1206"></a><span id="l34.1206" class="difflineplus">+</span>
<a href="#l34.1207"></a><span id="l34.1207" class="difflineplus">+  selectionChanged() { },</span>
<a href="#l34.1208"></a><span id="l34.1208" class="difflineplus">+  cycleCell(aRow, aColumn) { },</span>
<a href="#l34.1209"></a><span id="l34.1209" class="difflineplus">+  isSelectable(aRow, aColumn) { return false; },</span>
<a href="#l34.1210"></a><span id="l34.1210" class="difflineplus">+  performAction(aAction) { },</span>
<a href="#l34.1211"></a><span id="l34.1211" class="difflineplus">+  performActionOnRow(aAction, aRow) { },</span>
<a href="#l34.1212"></a><span id="l34.1212" class="difflineplus">+  performActionOnCell(aAction, aRow, aColumn) { }</span>
<a href="#l34.1213"></a><span id="l34.1213"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l35.1"></a><span id="l35.1">new file mode 100644</span>
<a href="#l35.2"></a><span id="l35.2" class="difflineminus">--- /dev/null</span>
<a href="#l35.3"></a><span id="l35.3" class="difflineplus">+++ b/suite/common/places/jar.mn</span>
<a href="#l35.4"></a><span id="l35.4" class="difflineat">@@ -0,0 +1,30 @@</span>
<a href="#l35.5"></a><span id="l35.5" class="difflineplus">+# This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l35.6"></a><span id="l35.6" class="difflineplus">+# License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l35.7"></a><span id="l35.7" class="difflineplus">+# file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l35.8"></a><span id="l35.8" class="difflineplus">+</span>
<a href="#l35.9"></a><span id="l35.9" class="difflineplus">+comm.jar:</span>
<a href="#l35.10"></a><span id="l35.10" class="difflineplus">+# Provide another URI for the bookmarkProperties dialog so we can persist the</span>
<a href="#l35.11"></a><span id="l35.11" class="difflineplus">+# attributes separately</span>
<a href="#l35.12"></a><span id="l35.12" class="difflineplus">+    content/communicator/places/bookmarkProperties2.xul       (content/bookmarkProperties.xul)</span>
<a href="#l35.13"></a><span id="l35.13" class="difflineplus">+*   content/communicator/places/places.xul                    (content/places.xul)</span>
<a href="#l35.14"></a><span id="l35.14" class="difflineplus">+    content/communicator/places/places.js                     (content/places.js)</span>
<a href="#l35.15"></a><span id="l35.15" class="difflineplus">+    content/communicator/places/places.css                    (content/places.css)</span>
<a href="#l35.16"></a><span id="l35.16" class="difflineplus">+    content/communicator/places/organizer.css                 (content/organizer.css)</span>
<a href="#l35.17"></a><span id="l35.17" class="difflineplus">+    content/communicator/places/bookmarkProperties.xul        (content/bookmarkProperties.xul)</span>
<a href="#l35.18"></a><span id="l35.18" class="difflineplus">+    content/communicator/places/bookmarkProperties.js         (content/bookmarkProperties.js)</span>
<a href="#l35.19"></a><span id="l35.19" class="difflineplus">+    content/communicator/places/placesOverlay.xul             (content/placesOverlay.xul)</span>
<a href="#l35.20"></a><span id="l35.20" class="difflineplus">+    content/communicator/places/menu.xml                      (content/menu.xml)</span>
<a href="#l35.21"></a><span id="l35.21" class="difflineplus">+    content/communicator/places/tree.xml                      (content/tree.xml)</span>
<a href="#l35.22"></a><span id="l35.22" class="difflineplus">+    content/communicator/places/controller.js                 (content/controller.js)</span>
<a href="#l35.23"></a><span id="l35.23" class="difflineplus">+    content/communicator/places/treeView.js                   (content/treeView.js)</span>
<a href="#l35.24"></a><span id="l35.24" class="difflineplus">+    content/communicator/places/browserPlacesViews.js         (content/browserPlacesViews.js)</span>
<a href="#l35.25"></a><span id="l35.25" class="difflineplus">+# keep the Places version of the history sidebar at history/history-panel.xul</span>
<a href="#l35.26"></a><span id="l35.26" class="difflineplus">+# to prevent having to worry about between versions of the browser</span>
<a href="#l35.27"></a><span id="l35.27" class="difflineplus">+*   content/communicator/history/history-panel.xul            (content/history-panel.xul)</span>
<a href="#l35.28"></a><span id="l35.28" class="difflineplus">+    content/communicator/places/history-panel.js              (content/history-panel.js)</span>
<a href="#l35.29"></a><span id="l35.29" class="difflineplus">+# ditto for the bookmarks sidebar</span>
<a href="#l35.30"></a><span id="l35.30" class="difflineplus">+    content/communicator/bookmarks/bookmarksPanel.xul         (content/bookmarksPanel.xul)</span>
<a href="#l35.31"></a><span id="l35.31" class="difflineplus">+    content/communicator/bookmarks/bookmarksPanel.js          (content/bookmarksPanel.js)</span>
<a href="#l35.32"></a><span id="l35.32" class="difflineplus">+    content/communicator/bookmarks/sidebarUtils.js            (content/sidebarUtils.js)</span>
<a href="#l35.33"></a><span id="l35.33" class="difflineplus">+    content/communicator/places/editBookmarkOverlay.xul       (content/editBookmarkOverlay.xul)</span>
<a href="#l35.34"></a><span id="l35.34" class="difflineplus">+    content/communicator/places/editBookmarkOverlay.js        (content/editBookmarkOverlay.js)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l36.1"></a><span id="l36.1">new file mode 100644</span>
<a href="#l36.2"></a><span id="l36.2" class="difflineminus">--- /dev/null</span>
<a href="#l36.3"></a><span id="l36.3" class="difflineplus">+++ b/suite/common/places/moz.build</span>
<a href="#l36.4"></a><span id="l36.4" class="difflineat">@@ -0,0 +1,28 @@</span>
<a href="#l36.5"></a><span id="l36.5" class="difflineplus">+# -*- Mode: python; indent-tabs-mode: nil; tab-width: 40 -*-</span>
<a href="#l36.6"></a><span id="l36.6" class="difflineplus">+# vim: set filetype=python:</span>
<a href="#l36.7"></a><span id="l36.7" class="difflineplus">+# This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l36.8"></a><span id="l36.8" class="difflineplus">+# License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l36.9"></a><span id="l36.9" class="difflineplus">+# file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l36.10"></a><span id="l36.10" class="difflineplus">+</span>
<a href="#l36.11"></a><span id="l36.11" class="difflineplus">+XPCSHELL_TESTS_MANIFESTS += [</span>
<a href="#l36.12"></a><span id="l36.12" class="difflineplus">+    'tests/autocomplete/xpcshell.ini',</span>
<a href="#l36.13"></a><span id="l36.13" class="difflineplus">+    'tests/unit/xpcshell.ini',</span>
<a href="#l36.14"></a><span id="l36.14" class="difflineplus">+]</span>
<a href="#l36.15"></a><span id="l36.15" class="difflineplus">+</span>
<a href="#l36.16"></a><span id="l36.16" class="difflineplus">+MOCHITEST_CHROME_MANIFESTS += ['tests/chrome/chrome.ini']</span>
<a href="#l36.17"></a><span id="l36.17" class="difflineplus">+BROWSER_CHROME_MANIFESTS += ['tests/browser/browser.ini']</span>
<a href="#l36.18"></a><span id="l36.18" class="difflineplus">+</span>
<a href="#l36.19"></a><span id="l36.19" class="difflineplus">+JAR_MANIFESTS += ['jar.mn']</span>
<a href="#l36.20"></a><span id="l36.20" class="difflineplus">+</span>
<a href="#l36.21"></a><span id="l36.21" class="difflineplus">+EXTRA_COMPONENTS += [</span>
<a href="#l36.22"></a><span id="l36.22" class="difflineplus">+    'nsPlacesAutoComplete.js',</span>
<a href="#l36.23"></a><span id="l36.23" class="difflineplus">+    'nsPlacesAutoComplete.manifest',</span>
<a href="#l36.24"></a><span id="l36.24" class="difflineplus">+]</span>
<a href="#l36.25"></a><span id="l36.25" class="difflineplus">+</span>
<a href="#l36.26"></a><span id="l36.26" class="difflineplus">+EXTRA_JS_MODULES += [</span>
<a href="#l36.27"></a><span id="l36.27" class="difflineplus">+    'PlacesUIUtils.jsm',</span>
<a href="#l36.28"></a><span id="l36.28" class="difflineplus">+]</span>
<a href="#l36.29"></a><span id="l36.29" class="difflineplus">+</span>
<a href="#l36.30"></a><span id="l36.30" class="difflineplus">+</span>
<a href="#l36.31"></a><span id="l36.31" class="difflineplus">+with Files('**'):</span>
<a href="#l36.32"></a><span id="l36.32" class="difflineplus">+    BUG_COMPONENT = ('SeaMonkey', 'Bookmarks &amp; History')</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l37.1"></a><span id="l37.1" class="difflineminus">--- a/suite/common/sidebar/sidebarOverlay.xul</span>
<a href="#l37.2"></a><span id="l37.2" class="difflineplus">+++ b/suite/common/sidebar/sidebarOverlay.xul</span>
<a href="#l37.3"></a><span id="l37.3" class="difflineat">@@ -22,17 +22,17 @@</span>
<a href="#l37.4"></a><span id="l37.4"> </span>
<a href="#l37.5"></a><span id="l37.5">   &lt;!-- Overlay of broadcasterset to get our panels in --&gt;</span>
<a href="#l37.6"></a><span id="l37.6">   &lt;broadcasterset id=&quot;mainBroadcasterSet&quot;&gt;</span>
<a href="#l37.7"></a><span id="l37.7">     &lt;broadcaster id=&quot;viewBookmarksSidebar&quot;</span>
<a href="#l37.8"></a><span id="l37.8">                  autoCheck=&quot;false&quot;</span>
<a href="#l37.9"></a><span id="l37.9">                  type=&quot;checkbox&quot;</span>
<a href="#l37.10"></a><span id="l37.10">                  group=&quot;sidebar&quot;</span>
<a href="#l37.11"></a><span id="l37.11">                  sidebartitle=&quot;&amp;sidebar.client-bookmarks.label;&quot;</span>
<a href="#l37.12"></a><span id="l37.12" class="difflineminus">-                 sidebarurl=&quot;chrome://communicator/content/bookmarks/bm-panel.xul&quot;</span>
<a href="#l37.13"></a><span id="l37.13" class="difflineplus">+                 sidebarurl=&quot;chrome://communicator/content/bookmarks/bookmarksPanel.xul&quot;</span>
<a href="#l37.14"></a><span id="l37.14">                  oncommand=&quot;toggleSidebar('viewBookmarksSidebar');&quot;/&gt;</span>
<a href="#l37.15"></a><span id="l37.15">     &lt;broadcaster id=&quot;viewHistorySidebar&quot;</span>
<a href="#l37.16"></a><span id="l37.16">                  autoCheck=&quot;false&quot;</span>
<a href="#l37.17"></a><span id="l37.17">                  type=&quot;checkbox&quot;</span>
<a href="#l37.18"></a><span id="l37.18">                  group=&quot;sidebar&quot;</span>
<a href="#l37.19"></a><span id="l37.19">                  sidebartitle=&quot;&amp;sidebar.client-history.label;&quot;</span>
<a href="#l37.20"></a><span id="l37.20">                  sidebarurl=&quot;chrome://communicator/content/history/history-panel.xul&quot;</span>
<a href="#l37.21"></a><span id="l37.21">                  oncommand=&quot;toggleSidebar('viewHistorySidebar');&quot;/&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l38.1"></a><span id="l38.1" class="difflineminus">--- a/suite/common/tasksOverlay.js</span>
<a href="#l38.2"></a><span id="l38.2" class="difflineplus">+++ b/suite/common/tasksOverlay.js</span>
<a href="#l38.3"></a><span id="l38.3" class="difflineat">@@ -66,18 +66,18 @@ function toEM(aView)</span>
<a href="#l38.4"></a><span id="l38.4">   switchToTabHavingURI(&quot;about:addons&quot;, true, function(browser) {</span>
<a href="#l38.5"></a><span id="l38.5">     if (aView)</span>
<a href="#l38.6"></a><span id="l38.6">       browser.contentWindow.wrappedJSObject.loadView(aView);</span>
<a href="#l38.7"></a><span id="l38.7">   });</span>
<a href="#l38.8"></a><span id="l38.8"> }</span>
<a href="#l38.9"></a><span id="l38.9"> </span>
<a href="#l38.10"></a><span id="l38.10"> function toBookmarksManager()</span>
<a href="#l38.11"></a><span id="l38.11"> {</span>
<a href="#l38.12"></a><span id="l38.12" class="difflineminus">-  toOpenWindowByType(&quot;bookmarks:manager&quot;,</span>
<a href="#l38.13"></a><span id="l38.13" class="difflineminus">-                     &quot;chrome://communicator/content/bookmarks/bookmarksManager.xul&quot;);</span>
<a href="#l38.14"></a><span id="l38.14" class="difflineplus">+  toOpenWindowByType(&quot;Places:Organizer&quot;,</span>
<a href="#l38.15"></a><span id="l38.15" class="difflineplus">+                     &quot;chrome://communicator/content/places/places.xul&quot;);</span>
<a href="#l38.16"></a><span id="l38.16"> }</span>
<a href="#l38.17"></a><span id="l38.17"> </span>
<a href="#l38.18"></a><span id="l38.18"> function toJavaScriptConsole()</span>
<a href="#l38.19"></a><span id="l38.19"> {</span>
<a href="#l38.20"></a><span id="l38.20">     toOpenWindowByType(&quot;suite:console&quot;, &quot;chrome://communicator/content/console/console.xul&quot;);</span>
<a href="#l38.21"></a><span id="l38.21"> }</span>
<a href="#l38.22"></a><span id="l38.22"> </span>
<a href="#l38.23"></a><span id="l38.23"> function toOpenWindow( aWindow )</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l39.1"></a><span id="l39.1" class="difflineminus">--- a/suite/common/utilityOverlay.js</span>
<a href="#l39.2"></a><span id="l39.2" class="difflineplus">+++ b/suite/common/utilityOverlay.js</span>
<a href="#l39.3"></a><span id="l39.3" class="difflineat">@@ -1433,44 +1433,59 @@ function openUILink(url, aEvent, aIgnore</span>
<a href="#l39.4"></a><span id="l39.4">  * open a new tab, depending on Shift, browser.tabs.loadInBackground, and</span>
<a href="#l39.5"></a><span id="l39.5">  * ignoreBackground.</span>
<a href="#l39.6"></a><span id="l39.6">  * Otherwise if middlemouse.openNewWindow is true, then Ctrl (or Meta) and middle-click</span>
<a href="#l39.7"></a><span id="l39.7">  * open a new window.</span>
<a href="#l39.8"></a><span id="l39.8">  * Otherwise if middle-click is pressed then nothing happens.</span>
<a href="#l39.9"></a><span id="l39.9">  * Save is Alt or Shift depending on the ui.key.saveLink.shift preference.</span>
<a href="#l39.10"></a><span id="l39.10">  * Otherwise if Alt, or Shift, or Ctrl (or Meta) is pressed then nothing happens.</span>
<a href="#l39.11"></a><span id="l39.11">  * Otherwise the most recent browser is used for left clicks.</span>
<a href="#l39.12"></a><span id="l39.12" class="difflineplus">+ *</span>
<a href="#l39.13"></a><span id="l39.13" class="difflineplus">+ * Exceptions:</span>
<a href="#l39.14"></a><span id="l39.14" class="difflineplus">+ * - Alt is ignored for menu items selected using the keyboard so you don't accidentally save stuff.</span>
<a href="#l39.15"></a><span id="l39.15" class="difflineplus">+ * - Alt is hard to use in context menus, because pressing Alt closes the menu.</span>
<a href="#l39.16"></a><span id="l39.16" class="difflineplus">+ * - Alt can't be used on the bookmarks toolbar because Alt is used for &quot;treat this as something draggable&quot;.</span>
<a href="#l39.17"></a><span id="l39.17" class="difflineplus">+ * - The button is ignored for the middle-click-paste-URL feature, since it's always a middle-click.</span>
<a href="#l39.18"></a><span id="l39.18">  */</span>
<a href="#l39.19"></a><span id="l39.19" class="difflineminus">-function whereToOpenLink(e, ignoreButton, ignoreSave, ignoreBackground)</span>
<a href="#l39.20"></a><span id="l39.20" class="difflineplus">+function whereToOpenLink(e, ignoreButton, ignoreSave, ignoreBackground = false)</span>
<a href="#l39.21"></a><span id="l39.21"> {</span>
<a href="#l39.22"></a><span id="l39.22" class="difflineplus">+  // This method must treat a null event like a left click without modifier keys (i.e.</span>
<a href="#l39.23"></a><span id="l39.23" class="difflineplus">+  // e = { shiftKey:false, ctrlKey:false, metaKey:false, altKey:false, button:0 })</span>
<a href="#l39.24"></a><span id="l39.24" class="difflineplus">+  // for compatibility purposes.</span>
<a href="#l39.25"></a><span id="l39.25">   if (!e)</span>
<a href="#l39.26"></a><span id="l39.26">     return &quot;current&quot;;</span>
<a href="#l39.27"></a><span id="l39.27"> </span>
<a href="#l39.28"></a><span id="l39.28">   var shift = e.shiftKey;</span>
<a href="#l39.29"></a><span id="l39.29">   var ctrl = e.ctrlKey;</span>
<a href="#l39.30"></a><span id="l39.30">   var meta = e.metaKey;</span>
<a href="#l39.31"></a><span id="l39.31" class="difflineminus">-  var alt = e.altKey;</span>
<a href="#l39.32"></a><span id="l39.32" class="difflineplus">+  var alt = e.altKey &amp;&amp; !ignoreSave;</span>
<a href="#l39.33"></a><span id="l39.33"> </span>
<a href="#l39.34"></a><span id="l39.34">   // ignoreButton allows &quot;middle-click paste&quot; to use function without always opening in a new window.</span>
<a href="#l39.35"></a><span id="l39.35">   var middle = !ignoreButton &amp;&amp; e.button == 1;</span>
<a href="#l39.36"></a><span id="l39.36"> </span>
<a href="#l39.37"></a><span id="l39.37" class="difflineminus">-  if (meta || ctrl || middle) {</span>
<a href="#l39.38"></a><span id="l39.38" class="difflineplus">+  // Don't do anything special with right-mouse clicks.  They're probably clicks on context menu items.</span>
<a href="#l39.39"></a><span id="l39.39" class="difflineplus">+</span>
<a href="#l39.40"></a><span id="l39.40" class="difflineplus">+  // On macOS ctrl is not evaluated.</span>
<a href="#l39.41"></a><span id="l39.41" class="difflineplus">+  var metaKey = AppConstants.platform == &quot;macosx&quot; ? meta : ctrl;</span>
<a href="#l39.42"></a><span id="l39.42" class="difflineplus">+</span>
<a href="#l39.43"></a><span id="l39.43" class="difflineplus">+  if (metaKey || middle) {</span>
<a href="#l39.44"></a><span id="l39.44">     if (GetBoolPref(&quot;browser.tabs.opentabfor.middleclick&quot;, true))</span>
<a href="#l39.45"></a><span id="l39.45">       return ignoreBackground ? &quot;tabfocused&quot; : shift ? &quot;tabshifted&quot; : &quot;tab&quot;;</span>
<a href="#l39.46"></a><span id="l39.46">     if (GetBoolPref(&quot;middlemouse.openNewWindow&quot;, true))</span>
<a href="#l39.47"></a><span id="l39.47">       return &quot;window&quot;;</span>
<a href="#l39.48"></a><span id="l39.48">     if (middle)</span>
<a href="#l39.49"></a><span id="l39.49">       return null;</span>
<a href="#l39.50"></a><span id="l39.50">   }</span>
<a href="#l39.51"></a><span id="l39.51">   if (!ignoreSave) {</span>
<a href="#l39.52"></a><span id="l39.52">     if (GetBoolPref(&quot;ui.key.saveLink.shift&quot;, true) ? shift : alt)</span>
<a href="#l39.53"></a><span id="l39.53">       return &quot;save&quot;;</span>
<a href="#l39.54"></a><span id="l39.54">   }</span>
<a href="#l39.55"></a><span id="l39.55">   if (alt || shift || meta || ctrl)</span>
<a href="#l39.56"></a><span id="l39.56">     return null;</span>
<a href="#l39.57"></a><span id="l39.57" class="difflineplus">+</span>
<a href="#l39.58"></a><span id="l39.58">   return &quot;current&quot;;</span>
<a href="#l39.59"></a><span id="l39.59"> }</span>
<a href="#l39.60"></a><span id="l39.60"> </span>
<a href="#l39.61"></a><span id="l39.61"> /* openUILinkIn opens a URL in a place specified by the parameter |where|.</span>
<a href="#l39.62"></a><span id="l39.62">  *</span>
<a href="#l39.63"></a><span id="l39.63">  * |where| can be:</span>
<a href="#l39.64"></a><span id="l39.64">  *  &quot;current&quot;     current tab (if there aren't any browser windows, then in a new window instead)</span>
<a href="#l39.65"></a><span id="l39.65">  *  &quot;tab&quot;         new tab     (if there aren't any browser windows, then in a new window instead)</span>
<a href="#l39.66"></a><span id="l39.66" class="difflineat">@@ -1517,16 +1532,17 @@ function openLinkIn(url, where, params)</span>
<a href="#l39.67"></a><span id="l39.67">   if (!where || !url)</span>
<a href="#l39.68"></a><span id="l39.68">     return null;</span>
<a href="#l39.69"></a><span id="l39.69"> </span>
<a href="#l39.70"></a><span id="l39.70">   var aAllowThirdPartyFixup = params.allowThirdPartyFixup;</span>
<a href="#l39.71"></a><span id="l39.71">   var aPostData             = params.postData;</span>
<a href="#l39.72"></a><span id="l39.72">   var aReferrerURI          = params.referrerURI;</span>
<a href="#l39.73"></a><span id="l39.73">   var aRelatedToCurrent     = params.relatedToCurrent;</span>
<a href="#l39.74"></a><span id="l39.74">   var aInitiatingDoc = params.initiatingDoc ? params.initiatingDoc : document;</span>
<a href="#l39.75"></a><span id="l39.75" class="difflineplus">+  var aIsPrivate            = params.private;</span>
<a href="#l39.76"></a><span id="l39.76"> </span>
<a href="#l39.77"></a><span id="l39.77">   var aReferrerPolicy       = (&quot;referrerPolicy&quot; in params ?</span>
<a href="#l39.78"></a><span id="l39.78">         params.referrerPolicy : Ci.nsIHttpChannel.REFERRER_POLICY_UNSET);</span>
<a href="#l39.79"></a><span id="l39.79">   var aUserContextId        = params.userContextId;</span>
<a href="#l39.80"></a><span id="l39.80">   var aPrincipal            = params.originPrincipal;</span>
<a href="#l39.81"></a><span id="l39.81">   var aTriggeringPrincipal  = params.triggeringPrincipal;</span>
<a href="#l39.82"></a><span id="l39.82"> </span>
<a href="#l39.83"></a><span id="l39.83">   if (where == &quot;save&quot;) {</span>
<a href="#l39.84"></a><span id="l39.84" class="difflineat">@@ -1556,16 +1572,22 @@ function openLinkIn(url, where, params)</span>
<a href="#l39.85"></a><span id="l39.85">       return Services.scriptSecurityManager.createCodebasePrincipal(principal.URI, attrs);</span>
<a href="#l39.86"></a><span id="l39.86">     }</span>
<a href="#l39.87"></a><span id="l39.87">     return principal;</span>
<a href="#l39.88"></a><span id="l39.88">   }</span>
<a href="#l39.89"></a><span id="l39.89">   aPrincipal = useOAForPrincipal(aPrincipal);</span>
<a href="#l39.90"></a><span id="l39.90">   aTriggeringPrincipal = useOAForPrincipal(aTriggeringPrincipal);</span>
<a href="#l39.91"></a><span id="l39.91"> </span>
<a href="#l39.92"></a><span id="l39.92">   if (!w || where == &quot;window&quot;) {</span>
<a href="#l39.93"></a><span id="l39.93" class="difflineplus">+    let features = &quot;chrome,dialog=no,all&quot;;</span>
<a href="#l39.94"></a><span id="l39.94" class="difflineplus">+</span>
<a href="#l39.95"></a><span id="l39.95" class="difflineplus">+    if (aIsPrivate) {</span>
<a href="#l39.96"></a><span id="l39.96" class="difflineplus">+      features += &quot;,private&quot;;</span>
<a href="#l39.97"></a><span id="l39.97" class="difflineplus">+    }</span>
<a href="#l39.98"></a><span id="l39.98" class="difflineplus">+</span>
<a href="#l39.99"></a><span id="l39.99">     // This propagates to window.arguments.</span>
<a href="#l39.100"></a><span id="l39.100">     var sa = Cc[&quot;@mozilla.org/array;1&quot;].</span>
<a href="#l39.101"></a><span id="l39.101">              createInstance(Ci.nsIMutableArray);</span>
<a href="#l39.102"></a><span id="l39.102"> </span>
<a href="#l39.103"></a><span id="l39.103">     var wuri = Cc[&quot;@mozilla.org/supports-string;1&quot;].</span>
<a href="#l39.104"></a><span id="l39.104">                createInstance(Ci.nsISupportsString);</span>
<a href="#l39.105"></a><span id="l39.105">     wuri.data = url;</span>
<a href="#l39.106"></a><span id="l39.106"> </span>
<a href="#l39.107"></a><span id="l39.107" class="difflineat">@@ -1592,18 +1614,16 @@ function openLinkIn(url, where, params)</span>
<a href="#l39.108"></a><span id="l39.108">     sa.appendElement(referrerURISupports);</span>
<a href="#l39.109"></a><span id="l39.109">     sa.appendElement(aPostData);</span>
<a href="#l39.110"></a><span id="l39.110">     sa.appendElement(allowThirdPartyFixupSupports);</span>
<a href="#l39.111"></a><span id="l39.111">     sa.appendElement(referrerPolicySupports);</span>
<a href="#l39.112"></a><span id="l39.112">     sa.appendElement(userContextIdSupports);</span>
<a href="#l39.113"></a><span id="l39.113">     sa.appendElement(aPrincipal);</span>
<a href="#l39.114"></a><span id="l39.114">     sa.appendElement(aTriggeringPrincipal);</span>
<a href="#l39.115"></a><span id="l39.115"> </span>
<a href="#l39.116"></a><span id="l39.116" class="difflineminus">-    let features = &quot;chrome,dialog=no,all&quot;;</span>
<a href="#l39.117"></a><span id="l39.117" class="difflineminus">-</span>
<a href="#l39.118"></a><span id="l39.118">     const sourceWindow = (w || window);</span>
<a href="#l39.119"></a><span id="l39.119">     Services.ww.openWindow(sourceWindow, getBrowserURL(), null, features, sa);</span>
<a href="#l39.120"></a><span id="l39.120">     return;</span>
<a href="#l39.121"></a><span id="l39.121">   }</span>
<a href="#l39.122"></a><span id="l39.122"> </span>
<a href="#l39.123"></a><span id="l39.123">   var loadInBackground = GetBoolPref(&quot;browser.tabs.loadInBackground&quot;, false);</span>
<a href="#l39.124"></a><span id="l39.124"> </span>
<a href="#l39.125"></a><span id="l39.125">   // reuse the browser if its current tab is empty</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l40.1"></a><span id="l40.1" class="difflineminus">--- a/suite/installer/allowed-dupes.mn</span>
<a href="#l40.2"></a><span id="l40.2" class="difflineplus">+++ b/suite/installer/allowed-dupes.mn</span>
<a href="#l40.3"></a><span id="l40.3" class="difflineat">@@ -113,18 +113,18 @@ chrome/classic/skin/classic/messenger/ic</span>
<a href="#l40.4"></a><span id="l40.4"> extensions/modern@themes.mozilla.org/chrome/modern/skin/modern/communicator/icons/notification-16.png</span>
<a href="#l40.5"></a><span id="l40.5"> chrome/classic/skin/classic/communicator/icons/notification-16.png</span>
<a href="#l40.6"></a><span id="l40.6"> extensions/modern@themes.mozilla.org/chrome/modern/skin/modern/messenger/icons/insecure.png</span>
<a href="#l40.7"></a><span id="l40.7"> chrome/classic/skin/classic/messenger/icons/insecure.png</span>
<a href="#l40.8"></a><span id="l40.8"> extensions/modern@themes.mozilla.org/chrome/modern/skin/modern/mozapps/plugins/pluginDisabled-16.png</span>
<a href="#l40.9"></a><span id="l40.9"> extensions/modern@themes.mozilla.org/chrome/modern/skin/modern/mozapps/plugins/pluginGeneric-16.png</span>
<a href="#l40.10"></a><span id="l40.10"> extensions/modern@themes.mozilla.org/chrome/modern/skin/modern/messenger/icons/secure.png</span>
<a href="#l40.11"></a><span id="l40.11"> chrome/classic/skin/classic/messenger/icons/secure.png</span>
<a href="#l40.12"></a><span id="l40.12" class="difflineminus">-extensions/modern@themes.mozilla.org/chrome/modern/skin/modern/communicator/history/calendar.png</span>
<a href="#l40.13"></a><span id="l40.13" class="difflineminus">-chrome/classic/skin/classic/communicator/history/calendar.png</span>
<a href="#l40.14"></a><span id="l40.14" class="difflineplus">+extensions/modern@themes.mozilla.org/chrome/modern/skin/modern/communicator/places/calendar.png</span>
<a href="#l40.15"></a><span id="l40.15" class="difflineplus">+chrome/classic/skin/classic/communicator/places/calendar.png</span>
<a href="#l40.16"></a><span id="l40.16"> extensions/modern@themes.mozilla.org/chrome/modern/skin/modern/communicator/icons/identity.png</span>
<a href="#l40.17"></a><span id="l40.17"> chrome/classic/skin/classic/communicator/icons/identity.png</span>
<a href="#l40.18"></a><span id="l40.18"> extensions/modern@themes.mozilla.org/chrome/modern/skin/modern/global/icons/information-16.png</span>
<a href="#l40.19"></a><span id="l40.19"> extensions/modern@themes.mozilla.org/chrome/modern/skin/modern/global/icons/notfound.png</span>
<a href="#l40.20"></a><span id="l40.20"> extensions/modern@themes.mozilla.org/chrome/modern/skin/modern/messenger/addressbook/icons/contact-generic-tiny.png</span>
<a href="#l40.21"></a><span id="l40.21"> chrome/classic/skin/classic/messenger/addressbook/icons/contact-generic-tiny.png</span>
<a href="#l40.22"></a><span id="l40.22"> extensions/modern@themes.mozilla.org/chrome/modern/skin/modern/communicator/icons/feedIcon16.png</span>
<a href="#l40.23"></a><span id="l40.23"> chrome/classic/skin/classic/communicator/icons/feedIcon16.png</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l41.1"></a><span id="l41.1" class="difflineminus">--- a/suite/locales/en-US/chrome/browser/navigator.dtd</span>
<a href="#l41.2"></a><span id="l41.2" class="difflineplus">+++ b/suite/locales/en-US/chrome/browser/navigator.dtd</span>
<a href="#l41.3"></a><span id="l41.3" class="difflineat">@@ -33,16 +33,20 @@</span>
<a href="#l41.4"></a><span id="l41.4"> </span>
<a href="#l41.5"></a><span id="l41.5"> &lt;!ENTITY feedsMenu.label &quot;Subscribe to This Page&quot;&gt;</span>
<a href="#l41.6"></a><span id="l41.6"> &lt;!ENTITY feedsMenu.accesskey &quot;S&quot;&gt;</span>
<a href="#l41.7"></a><span id="l41.7"> </span>
<a href="#l41.8"></a><span id="l41.8"> &lt;!ENTITY menuBar.tooltip                  &quot;Menu Bar&quot;&gt;</span>
<a href="#l41.9"></a><span id="l41.9"> &lt;!ENTITY bookmarksToolbar.tooltip         &quot;Bookmarks Toolbar&quot;&gt;</span>
<a href="#l41.10"></a><span id="l41.10"> &lt;!ENTITY navigationToolbar.tooltip        &quot;Navigation Toolbar&quot;&gt;</span>
<a href="#l41.11"></a><span id="l41.11"> </span>
<a href="#l41.12"></a><span id="l41.12" class="difflineplus">+&lt;!ENTITY editBookmark.done.label &quot;Done&quot;&gt;</span>
<a href="#l41.13"></a><span id="l41.13" class="difflineplus">+&lt;!ENTITY editBookmark.cancel.label &quot;Cancel&quot;&gt;</span>
<a href="#l41.14"></a><span id="l41.14" class="difflineplus">+&lt;!ENTITY editBookmark.removeBookmark.accessKey &quot;R&quot;&gt;</span>
<a href="#l41.15"></a><span id="l41.15" class="difflineplus">+</span>
<a href="#l41.16"></a><span id="l41.16"> &lt;!-- Toolbar items --&gt; </span>
<a href="#l41.17"></a><span id="l41.17"> &lt;!ENTITY backButton.label             &quot;Back&quot;&gt;</span>
<a href="#l41.18"></a><span id="l41.18"> &lt;!ENTITY backButton.tooltip           &quot;Go back one page&quot;&gt;</span>
<a href="#l41.19"></a><span id="l41.19"> &lt;!ENTITY forwardButton.label          &quot;Forward&quot;&gt;</span>
<a href="#l41.20"></a><span id="l41.20"> &lt;!ENTITY forwardButton.tooltip        &quot;Go forward one page&quot;&gt;</span>
<a href="#l41.21"></a><span id="l41.21"> &lt;!ENTITY reloadButton.label           &quot;Reload&quot;&gt;</span>
<a href="#l41.22"></a><span id="l41.22"> &lt;!ENTITY reloadButton.tooltip         &quot;Reload current page&quot;&gt;</span>
<a href="#l41.23"></a><span id="l41.23"> &lt;!ENTITY stopButton.label             &quot;Stop&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l42.1"></a><span id="l42.1" class="difflineminus">--- a/suite/locales/en-US/chrome/common/help/cs_nav_prefs_appearance.xhtml</span>
<a href="#l42.2"></a><span id="l42.2" class="difflineplus">+++ b/suite/locales/en-US/chrome/common/help/cs_nav_prefs_appearance.xhtml</span>
<a href="#l42.3"></a><span id="l42.3" class="difflineat">@@ -114,17 +114,17 @@</span>
<a href="#l42.4"></a><span id="l42.4"> &lt;p&gt;The Content preferences panel allows you to change settings that influence</span>
<a href="#l42.5"></a><span id="l42.5">   how website and message content appears in &amp;brandShortName;.&lt;/p&gt;</span>
<a href="#l42.6"></a><span id="l42.6"> </span>
<a href="#l42.7"></a><span id="l42.7"> &lt;ul&gt;</span>
<a href="#l42.8"></a><span id="l42.8">   &lt;li&gt;&lt;strong&gt;Website icons&lt;/strong&gt;:</span>
<a href="#l42.9"></a><span id="l42.9">     &lt;ul&gt;</span>
<a href="#l42.10"></a><span id="l42.10">       &lt;li&gt;&lt;strong&gt;Show website icons&lt;/strong&gt;: Select this if you want see</span>
<a href="#l42.11"></a><span id="l42.11">         site-specific icons, if available, in place of the bookmark icon</span>
<a href="#l42.12"></a><span id="l42.12" class="difflineminus">-        &lt;img src=&quot;chrome://communicator/skin/bookmarks/bookmark-item.svg&quot;</span>
<a href="#l42.13"></a><span id="l42.13" class="difflineplus">+        &lt;img src=&quot;chrome://communicator/skin/places/bookmark-item.svg&quot;</span>
<a href="#l42.14"></a><span id="l42.14">         alt=&quot;Bookmark item icon&quot;/&gt;. Website icons are shown to the left of the</span>
<a href="#l42.15"></a><span id="l42.15">         Location Bar and Browser tabs.&lt;/li&gt;</span>
<a href="#l42.16"></a><span id="l42.16">       &lt;li&gt;&lt;strong&gt;Aggressively look for website icons when the page doesn&amp;apos;t</span>
<a href="#l42.17"></a><span id="l42.17">         define one&lt;/strong&gt;: If the page itself does not define a website</span>
<a href="#l42.18"></a><span id="l42.18">         icon, turning on this setting makes &amp;brandShortName; look for a</span>
<a href="#l42.19"></a><span id="l42.19">         &amp;quot;favicon&amp;quot; on the server and use that instead.&lt;/li&gt;</span>
<a href="#l42.20"></a><span id="l42.20">     &lt;/ul&gt;</span>
<a href="#l42.21"></a><span id="l42.21">   &lt;/li&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l43.1"></a><span id="l43.1" class="difflineminus">--- a/suite/locales/en-US/chrome/common/help/customize_help.xhtml</span>
<a href="#l43.2"></a><span id="l43.2" class="difflineplus">+++ b/suite/locales/en-US/chrome/common/help/customize_help.xhtml</span>
<a href="#l43.3"></a><span id="l43.3" class="difflineat">@@ -149,17 +149,17 @@</span>
<a href="#l43.4"></a><span id="l43.4">   &lt;li&gt;Click OK to finish.&lt;/li&gt;</span>
<a href="#l43.5"></a><span id="l43.5"> &lt;/ol&gt;</span>
<a href="#l43.6"></a><span id="l43.6"> </span>
<a href="#l43.7"></a><span id="l43.7"> &lt;p&gt;&lt;strong&gt;Note&lt;/strong&gt;: If you add more than eight tabs to Sidebar,</span>
<a href="#l43.8"></a><span id="l43.8">   &amp;brandShortName; hides the remaining tabs to reduce clutter. To scroll</span>
<a href="#l43.9"></a><span id="l43.9">   through the hidden tabs, click the down arrow button at the bottom of Sidebar</span>
<a href="#l43.10"></a><span id="l43.10">   until you see the desired tab. Click the up arrow button to once again scroll</span>
<a href="#l43.11"></a><span id="l43.11">   up.&lt;/p&gt;</span>
<a href="#l43.12"></a><span id="l43.12" class="difflineminus">-  </span>
<a href="#l43.13"></a><span id="l43.13" class="difflineplus">+</span>
<a href="#l43.14"></a><span id="l43.14"> &lt;p&gt;&lt;strong&gt;Tips&lt;/strong&gt;:&lt;/p&gt;</span>
<a href="#l43.15"></a><span id="l43.15"> </span>
<a href="#l43.16"></a><span id="l43.16"> &lt;ul&gt;</span>
<a href="#l43.17"></a><span id="l43.17">   &lt;li&gt;To preview a Sidebar tab before adding it, select a tab from the list</span>
<a href="#l43.18"></a><span id="l43.18">     on the left side of the Customize Sidebar dialog box and click Preview.</span>
<a href="#l43.19"></a><span id="l43.19">     After a few seconds, the tab displays in the Tab Preview pop-up</span>
<a href="#l43.20"></a><span id="l43.20">     window.&lt;/li&gt;</span>
<a href="#l43.21"></a><span id="l43.21">   &lt;li&gt;To view an extensive and categorized list of tabs available for Sidebar,</span>
<a href="#l43.22"></a><span id="l43.22" class="difflineat">@@ -174,31 +174,31 @@</span>
<a href="#l43.23"></a><span id="l43.23">     the lower part of the menu.&lt;/li&gt;</span>
<a href="#l43.24"></a><span id="l43.24">   &lt;li&gt;Select the tabs you want displayed in Sidebar. Remove the checkmark</span>
<a href="#l43.25"></a><span id="l43.25">     (deselect) to turn a tab off (it will still be available from the</span>
<a href="#l43.26"></a><span id="l43.26">     menu).&lt;/li&gt;</span>
<a href="#l43.27"></a><span id="l43.27"> &lt;/ol&gt;</span>
<a href="#l43.28"></a><span id="l43.28"> </span>
<a href="#l43.29"></a><span id="l43.29"> &lt;p&gt;&lt;strong&gt;Tip&lt;/strong&gt;: To quickly turn off a Sidebar tab, right-click on its</span>
<a href="#l43.30"></a><span id="l43.30">   name and choose Hide Tab.&lt;/p&gt;</span>
<a href="#l43.31"></a><span id="l43.31" class="difflineminus">-  </span>
<a href="#l43.32"></a><span id="l43.32" class="difflineplus">+</span>
<a href="#l43.33"></a><span id="l43.33"> &lt;p&gt;[&lt;a href=&quot;#sidebar&quot;&gt;Return to beginning of section&lt;/a&gt;]&lt;/p&gt;</span>
<a href="#l43.34"></a><span id="l43.34"> </span>
<a href="#l43.35"></a><span id="l43.35"> &lt;h3 id=&quot;customizing_individual_sidebar_tabs&quot;&gt;Customizing Individual Sidebar</span>
<a href="#l43.36"></a><span id="l43.36">   Tabs&lt;/h3&gt;</span>
<a href="#l43.37"></a><span id="l43.37"> </span>
<a href="#l43.38"></a><span id="l43.38"> &lt;p&gt;&lt;strong&gt;Note&lt;/strong&gt;: Not all tabs can be customized.&lt;/p&gt;</span>
<a href="#l43.39"></a><span id="l43.39"> </span>
<a href="#l43.40"></a><span id="l43.40"> &lt;ol&gt;</span>
<a href="#l43.41"></a><span id="l43.41">   &lt;li&gt;Click &lt;q&gt;Tabs&lt;/q&gt; at the top of Sidebar and select Customize Sidebar</span>
<a href="#l43.42"></a><span id="l43.42">     from the menu.&lt;/li&gt;</span>
<a href="#l43.43"></a><span id="l43.43">   &lt;li&gt;Select an available tab from the list on the right.&lt;/li&gt;</span>
<a href="#l43.44"></a><span id="l43.44">   &lt;li&gt;Click Customize Tab if it is enabled. A window appears with information</span>
<a href="#l43.45"></a><span id="l43.45">     and options for customizing the tab.</span>
<a href="#l43.46"></a><span id="l43.46" class="difflineminus">-    </span>
<a href="#l43.47"></a><span id="l43.47" class="difflineplus">+</span>
<a href="#l43.48"></a><span id="l43.48">     &lt;p&gt;The instructions vary depending on the source of the tab&amp;mdash;in</span>
<a href="#l43.49"></a><span id="l43.49">       addition to &amp;brandShortName;, tab providers can be any company,</span>
<a href="#l43.50"></a><span id="l43.50">       organization, or individual who uses the Internet.&lt;/p&gt;</span>
<a href="#l43.51"></a><span id="l43.51">   &lt;/li&gt;</span>
<a href="#l43.52"></a><span id="l43.52">   &lt;li&gt;After you follow the tab provider&amp;apos;s instructions, close the</span>
<a href="#l43.53"></a><span id="l43.53">     customization window (or follow the provider&amp;apos;s instructions to close</span>
<a href="#l43.54"></a><span id="l43.54">     it).&lt;/li&gt;</span>
<a href="#l43.55"></a><span id="l43.55">   &lt;li&gt;Click OK to finish.&lt;/li&gt;</span>
<a href="#l43.56"></a><span id="l43.56" class="difflineat">@@ -249,31 +249,31 @@</span>
<a href="#l43.57"></a><span id="l43.57"> &lt;h3 id=&quot;what_is_tabbed_browsing&quot;&gt;What is Tabbed Browsing?&lt;/h3&gt;</span>
<a href="#l43.58"></a><span id="l43.58"> </span>
<a href="#l43.59"></a><span id="l43.59"> &lt;p&gt;Tabbed Browsing lets you open more than one web page in a single window.</span>
<a href="#l43.60"></a><span id="l43.60">   Each web page has its own tab across the top of a single browser window.</span>
<a href="#l43.61"></a><span id="l43.61">   Each tab appears on the Tab Bar. For example, you can visit mozilla.org,</span>
<a href="#l43.62"></a><span id="l43.62">   icq.com, and cnn.com within one window instead of three windows.&lt;/p&gt;</span>
<a href="#l43.63"></a><span id="l43.63"> </span>
<a href="#l43.64"></a><span id="l43.64"> &lt;table summary=&quot;Image table&quot;&gt;</span>
<a href="#l43.65"></a><span id="l43.65" class="difflineminus">-  &lt;tr&gt; </span>
<a href="#l43.66"></a><span id="l43.66" class="difflineplus">+  &lt;tr&gt;</span>
<a href="#l43.67"></a><span id="l43.67">     &lt;td&gt;Click this to open a new tab.&lt;/td&gt;</span>
<a href="#l43.68"></a><span id="l43.68">     &lt;td&gt;&lt;/td&gt;</span>
<a href="#l43.69"></a><span id="l43.69">   &lt;/tr&gt;</span>
<a href="#l43.70"></a><span id="l43.70" class="difflineminus">-  &lt;tr&gt; </span>
<a href="#l43.71"></a><span id="l43.71" class="difflineplus">+  &lt;tr&gt;</span>
<a href="#l43.72"></a><span id="l43.72">     &lt;td colspan=&quot;2&quot;&gt;</span>
<a href="#l43.73"></a><span id="l43.73">       &lt;img src=&quot;images/tabbed_browsing_bar.png&quot; alt=&quot;tab bar&quot;/&gt;</span>
<a href="#l43.74"></a><span id="l43.74">     &lt;/td&gt;</span>
<a href="#l43.75"></a><span id="l43.75">   &lt;/tr&gt;</span>
<a href="#l43.76"></a><span id="l43.76" class="difflineminus">-  &lt;tr&gt; </span>
<a href="#l43.77"></a><span id="l43.77" class="difflineplus">+  &lt;tr&gt;</span>
<a href="#l43.78"></a><span id="l43.78">     &lt;td style=&quot;text-align: left;&quot;&gt;Tab being viewed.&lt;/td&gt;</span>
<a href="#l43.79"></a><span id="l43.79">     &lt;td style=&quot;text-align: right;&quot;&gt;Click this to close the tab being</span>
<a href="#l43.80"></a><span id="l43.80">       viewed.&lt;/td&gt;</span>
<a href="#l43.81"></a><span id="l43.81">   &lt;/tr&gt;</span>
<a href="#l43.82"></a><span id="l43.82" class="difflineminus">-  &lt;tr&gt; </span>
<a href="#l43.83"></a><span id="l43.83" class="difflineplus">+  &lt;tr&gt;</span>
<a href="#l43.84"></a><span id="l43.84">     &lt;td colspan=&quot;2&quot; style=&quot;text-align: center;&quot;&gt;&lt;strong&gt;Tab Bar&lt;/strong&gt;&lt;/td&gt;</span>
<a href="#l43.85"></a><span id="l43.85">   &lt;/tr&gt;</span>
<a href="#l43.86"></a><span id="l43.86"> &lt;/table&gt;</span>
<a href="#l43.87"></a><span id="l43.87"> </span>
<a href="#l43.88"></a><span id="l43.88"> &lt;p&gt;You don&amp;apos;t need to have several windows open to visit several web pages;</span>
<a href="#l43.89"></a><span id="l43.89">   thus, freeing up more space on your desktop. Instead, you can open, close,</span>
<a href="#l43.90"></a><span id="l43.90">   and reload web pages conveniently in one place without having to switch to</span>
<a href="#l43.91"></a><span id="l43.91">   another window.&lt;/p&gt;</span>
<a href="#l43.92"></a><span id="l43.92" class="difflineat">@@ -414,17 +414,17 @@</span>
<a href="#l43.93"></a><span id="l43.93">   &lt;li&gt;To keep only one browser tab open, while closing all other tabs,</span>
<a href="#l43.94"></a><span id="l43.94">     right-click on the browser tab and choose Close Other Tabs.&lt;/li&gt;</span>
<a href="#l43.95"></a><span id="l43.95"> &lt;/ul&gt;</span>
<a href="#l43.96"></a><span id="l43.96"> </span>
<a href="#l43.97"></a><span id="l43.97"> &lt;p&gt;[&lt;a href=&quot;#tabbed_browsing&quot;&gt;Return to beginning of section&lt;/a&gt;]&lt;/p&gt;</span>
<a href="#l43.98"></a><span id="l43.98"> </span>
<a href="#l43.99"></a><span id="l43.99"> &lt;h2 id=&quot;changing_fonts_colors_and_themes&quot;&gt;Changing Fonts, Colors, and</span>
<a href="#l43.100"></a><span id="l43.100">   Themes&lt;/h2&gt;</span>
<a href="#l43.101"></a><span id="l43.101" class="difflineminus">-  </span>
<a href="#l43.102"></a><span id="l43.102" class="difflineplus">+</span>
<a href="#l43.103"></a><span id="l43.103"> &lt;div class=&quot;contentsBox&quot;&gt;In this section:</span>
<a href="#l43.104"></a><span id="l43.104">   &lt;ul&gt;</span>
<a href="#l43.105"></a><span id="l43.105">     &lt;li&gt;&lt;a href=&quot;#changing_the_default_fonts&quot;&gt;Changing the Default Fonts&lt;/a&gt;&lt;/li&gt;</span>
<a href="#l43.106"></a><span id="l43.106">     &lt;li&gt;&lt;a href=&quot;#changing_the_default_colors&quot;&gt;Changing the Default</span>
<a href="#l43.107"></a><span id="l43.107">       Colors&lt;/a&gt;&lt;/li&gt;</span>
<a href="#l43.108"></a><span id="l43.108">     &lt;li&gt;&lt;a href=&quot;#changing_the_theme&quot;&gt;Changing the Theme&lt;/a&gt;&lt;/li&gt;</span>
<a href="#l43.109"></a><span id="l43.109">   &lt;/ul&gt;</span>
<a href="#l43.110"></a><span id="l43.110"> &lt;/div&gt;</span>
<a href="#l43.111"></a><span id="l43.111" class="difflineat">@@ -536,17 +536,17 @@</span>
<a href="#l43.112"></a><span id="l43.112"> &lt;/div&gt;</span>
<a href="#l43.113"></a><span id="l43.113"> </span>
<a href="#l43.114"></a><span id="l43.114"> &lt;h3 id=&quot;menu_bar&quot;&gt;Menu Bar&lt;/h3&gt;</span>
<a href="#l43.115"></a><span id="l43.115"> </span>
<a href="#l43.116"></a><span id="l43.116"> &lt;p&gt;The Menu Bar provides drop down menus for performing actions within</span>
<a href="#l43.117"></a><span id="l43.117">   &amp;brandShortName;.&lt;/p&gt;</span>
<a href="#l43.118"></a><span id="l43.118"> </span>
<a href="#l43.119"></a><span id="l43.119"> &lt;table summary=&quot;Image table&quot;&gt;</span>
<a href="#l43.120"></a><span id="l43.120" class="difflineminus">-  &lt;tr&gt; </span>
<a href="#l43.121"></a><span id="l43.121" class="difflineplus">+  &lt;tr&gt;</span>
<a href="#l43.122"></a><span id="l43.122">     &lt;td&gt;&lt;img src=&quot;images/menubar.png&quot; alt=&quot;Menu Bar&quot;/&gt;&lt;/td&gt;</span>
<a href="#l43.123"></a><span id="l43.123">   &lt;/tr&gt;</span>
<a href="#l43.124"></a><span id="l43.124">   &lt;tr&gt;</span>
<a href="#l43.125"></a><span id="l43.125">     &lt;td style=&quot;text-align: center;&quot;&gt;&lt;strong&gt;Menu Bar&lt;/strong&gt;&lt;/td&gt;</span>
<a href="#l43.126"></a><span id="l43.126">   &lt;/tr&gt;</span>
<a href="#l43.127"></a><span id="l43.127"> &lt;/table&gt;</span>
<a href="#l43.128"></a><span id="l43.128"> </span>
<a href="#l43.129"></a><span id="l43.129"> &lt;p class=&quot;noMac&quot;&gt;If the Menu Bar is hidden (not minimized; see</span>
<a href="#l43.130"></a><span id="l43.130" class="difflineat">@@ -576,47 +576,47 @@</span>
<a href="#l43.131"></a><span id="l43.131"> &lt;p&gt;[&lt;a href=&quot;#toolbars&quot;&gt;Return to beginning of section&lt;/a&gt;]&lt;/p&gt;</span>
<a href="#l43.132"></a><span id="l43.132"> </span>
<a href="#l43.133"></a><span id="l43.133"> &lt;h3 id=&quot;personal_toolbar&quot;&gt;Personal Toolbar&lt;/h3&gt;</span>
<a href="#l43.134"></a><span id="l43.134"> </span>
<a href="#l43.135"></a><span id="l43.135"> &lt;p&gt;The Personal Toolbar is completely customizable&amp;mdash;you decide what you</span>
<a href="#l43.136"></a><span id="l43.136">   want to keep there.&lt;/p&gt;</span>
<a href="#l43.137"></a><span id="l43.137"> </span>
<a href="#l43.138"></a><span id="l43.138"> &lt;table summary=&quot;Image table&quot;&gt;</span>
<a href="#l43.139"></a><span id="l43.139" class="difflineminus">-  &lt;tr&gt; </span>
<a href="#l43.140"></a><span id="l43.140" class="difflineplus">+  &lt;tr&gt;</span>
<a href="#l43.141"></a><span id="l43.141">     &lt;td&gt;&lt;img src=&quot;images/personalbar.png&quot; alt=&quot;Personal Toolbar&quot;/&gt;&lt;/td&gt;</span>
<a href="#l43.142"></a><span id="l43.142">   &lt;/tr&gt;</span>
<a href="#l43.143"></a><span id="l43.143">   &lt;tr&gt;</span>
<a href="#l43.144"></a><span id="l43.144">     &lt;td style=&quot;text-align: center;&quot;&gt;&lt;strong&gt;Personal Toolbar&lt;/strong&gt;&lt;/td&gt;</span>
<a href="#l43.145"></a><span id="l43.145">   &lt;/tr&gt;</span>
<a href="#l43.146"></a><span id="l43.146"> &lt;/table&gt;</span>
<a href="#l43.147"></a><span id="l43.147"> </span>
<a href="#l43.148"></a><span id="l43.148"> &lt;p&gt;You can easily add, delete, and rearrange items in the Personal Toolbar.&lt;/p&gt;</span>
<a href="#l43.149"></a><span id="l43.149"> </span>
<a href="#l43.150"></a><span id="l43.150"> &lt;h4 id=&quot;adding_personal_toolbar_bookmarks&quot;&gt;Adding Personal Toolbar</span>
<a href="#l43.151"></a><span id="l43.151">   Bookmarks&lt;/h4&gt;</span>
<a href="#l43.152"></a><span id="l43.152"> </span>
<a href="#l43.153"></a><span id="l43.153"> &lt;p&gt;You can add buttons for your favorite bookmarks, or folders containing</span>
<a href="#l43.154"></a><span id="l43.154">   groups of bookmarks. To create a new bookmark to add to the Personal</span>
<a href="#l43.155"></a><span id="l43.155">   Toolbar:&lt;/p&gt;</span>
<a href="#l43.156"></a><span id="l43.156" class="difflineminus">-  </span>
<a href="#l43.157"></a><span id="l43.157" class="difflineplus">+</span>
<a href="#l43.158"></a><span id="l43.158"> &lt;ol&gt;</span>
<a href="#l43.159"></a><span id="l43.159">   &lt;li&gt;Open a web page you want to bookmark.&lt;/li&gt;</span>
<a href="#l43.160"></a><span id="l43.160">   &lt;li&gt;Drag the bookmark icon</span>
<a href="#l43.161"></a><span id="l43.161" class="difflineminus">-    &lt;img src=&quot;chrome://communicator/skin/bookmarks/bookmark-item.svg&quot;</span>
<a href="#l43.162"></a><span id="l43.162" class="difflineplus">+    &lt;img src=&quot;chrome://communicator/skin/places/bookmark-item.svg&quot;</span>
<a href="#l43.163"></a><span id="l43.163">     alt=&quot;image of bookmark icon&quot;/&gt;(located to the left of URL in the</span>
<a href="#l43.164"></a><span id="l43.164">     Location Bar) to a desired place on the Personal Toolbar. You can drag the</span>
<a href="#l43.165"></a><span id="l43.165">     icon directly to the Personal Toolbar, or to a folder on the Personal</span>
<a href="#l43.166"></a><span id="l43.166">     Toolbar. For more information, see</span>
<a href="#l43.167"></a><span id="l43.167">     &lt;a href=&quot;#adding_bookmark_folders_to_the_personal_toolbar&quot;&gt;Adding Bookmark</span>
<a href="#l43.168"></a><span id="l43.168">     Folders to the Personal Toolbar&lt;/a&gt;.&lt;/li&gt;</span>
<a href="#l43.169"></a><span id="l43.169"> &lt;/ol&gt;</span>
<a href="#l43.170"></a><span id="l43.170"> </span>
<a href="#l43.171"></a><span id="l43.171"> &lt;p&gt;&lt;strong&gt;Note&lt;/strong&gt;: The bookmark icon</span>
<a href="#l43.172"></a><span id="l43.172" class="difflineminus">-  &lt;img src=&quot;chrome://communicator/skin/bookmarks/bookmark-item.svg&quot; alt=&quot;image</span>
<a href="#l43.173"></a><span id="l43.173" class="difflineplus">+  &lt;img src=&quot;chrome://communicator/skin/places/bookmark-item.svg&quot; alt=&quot;image</span>
<a href="#l43.174"></a><span id="l43.174">   of bookmark icon&quot;/&gt; may appear as another page-specific icon if you have</span>
<a href="#l43.175"></a><span id="l43.175">   checked Show Website Icons in preferences. See</span>
<a href="#l43.176"></a><span id="l43.176">   &lt;a href=&quot;cs_nav_prefs_appearance.xhtml#appearance&quot;&gt;Appearance Preferences -</span>
<a href="#l43.177"></a><span id="l43.177">   Appearance&lt;/a&gt; for more information on changing this preferences.&lt;/p&gt;</span>
<a href="#l43.178"></a><span id="l43.178"> </span>
<a href="#l43.179"></a><span id="l43.179"> &lt;p&gt;Each item in the Personal Toolbar folder appears as a toolbar button. You</span>
<a href="#l43.180"></a><span id="l43.180">   may need to enlarge the browser window to see them all.&lt;/p&gt;</span>
<a href="#l43.181"></a><span id="l43.181"> </span>
<a href="#l43.182"></a><span id="l43.182" class="difflineat">@@ -672,17 +672,17 @@</span>
<a href="#l43.183"></a><span id="l43.183">   &lt;li&gt;Select a bookmark or folder and drag it to a new location.&lt;/li&gt;</span>
<a href="#l43.184"></a><span id="l43.184">   &lt;li&gt;When you are finished rearranging items, close your Bookmarks</span>
<a href="#l43.185"></a><span id="l43.185">     window.&lt;/li&gt;</span>
<a href="#l43.186"></a><span id="l43.186"> &lt;/ol&gt;</span>
<a href="#l43.187"></a><span id="l43.187"> </span>
<a href="#l43.188"></a><span id="l43.188"> &lt;p&gt;&lt;strong&gt;Tip&lt;/strong&gt;: To move a bookmark placed on the Personal Toolbar</span>
<a href="#l43.189"></a><span id="l43.189">   quickly, click and drag the bookmark to another location on the Personal</span>
<a href="#l43.190"></a><span id="l43.190">   Toolbar or to a folder.&lt;/p&gt;</span>
<a href="#l43.191"></a><span id="l43.191" class="difflineminus">-  </span>
<a href="#l43.192"></a><span id="l43.192" class="difflineplus">+</span>
<a href="#l43.193"></a><span id="l43.193"> &lt;p&gt;[&lt;a href=&quot;#toolbars&quot;&gt;Return to beginning of section&lt;/a&gt;]&lt;/p&gt;</span>
<a href="#l43.194"></a><span id="l43.194"> </span>
<a href="#l43.195"></a><span id="l43.195"> &lt;h3 id=&quot;status_bar&quot;&gt;Status Bar&lt;/h3&gt;</span>
<a href="#l43.196"></a><span id="l43.196"> </span>
<a href="#l43.197"></a><span id="l43.197"> &lt;p&gt;The Status Bar is located at the bottom of any &amp;brandShortName; window. It</span>
<a href="#l43.198"></a><span id="l43.198">   includes the following:&lt;/p&gt;</span>
<a href="#l43.199"></a><span id="l43.199"> </span>
<a href="#l43.200"></a><span id="l43.200"> &lt;ul&gt;</span>
<a href="#l43.201"></a><span id="l43.201" class="difflineat">@@ -708,17 +708,17 @@</span>
<a href="#l43.202"></a><span id="l43.202"> &lt;/ul&gt;</span>
<a href="#l43.203"></a><span id="l43.203"> </span>
<a href="#l43.204"></a><span id="l43.204"> &lt;p&gt;[&lt;a href=&quot;#toolbars&quot;&gt;Return to beginning of section&lt;/a&gt;]&lt;/p&gt;</span>
<a href="#l43.205"></a><span id="l43.205"> </span>
<a href="#l43.206"></a><span id="l43.206"> &lt;h3 id=&quot;component_bar&quot;&gt;Component Bar&lt;/h3&gt;</span>
<a href="#l43.207"></a><span id="l43.207"> </span>
<a href="#l43.208"></a><span id="l43.208"> &lt;p&gt;Use the Component Bar at the bottom left of any &amp;brandShortName; window to</span>
<a href="#l43.209"></a><span id="l43.209">   switch between tasks (such as browsing or mail).&lt;/p&gt;</span>
<a href="#l43.210"></a><span id="l43.210" class="difflineminus">-  </span>
<a href="#l43.211"></a><span id="l43.211" class="difflineplus">+</span>
<a href="#l43.212"></a><span id="l43.212"> &lt;p&gt;&lt;img src=&quot;images/taskbar.png&quot; alt=&quot;component bar&quot;/&gt;&lt;/p&gt;</span>
<a href="#l43.213"></a><span id="l43.213"> </span>
<a href="#l43.214"></a><span id="l43.214"> &lt;p&gt;[&lt;a href=&quot;#toolbars&quot;&gt;Return to beginning of section&lt;/a&gt;]&lt;/p&gt;</span>
<a href="#l43.215"></a><span id="l43.215"> </span>
<a href="#l43.216"></a><span id="l43.216"> &lt;h3 id=&quot;hiding_a_toolbar&quot;&gt;Hiding a Toolbar&lt;/h3&gt;</span>
<a href="#l43.217"></a><span id="l43.217"> </span>
<a href="#l43.218"></a><span id="l43.218"> &lt;p&gt;There are two ways to hide the toolbars.&lt;/p&gt;</span>
<a href="#l43.219"></a><span id="l43.219"> </span>
<a href="#l43.220"></a><span id="l43.220" class="difflineat">@@ -736,17 +736,17 @@</span>
<a href="#l43.221"></a><span id="l43.221">   &lt;li&gt;Open the View menu.&lt;/li&gt;</span>
<a href="#l43.222"></a><span id="l43.222">   &lt;li&gt;Choose Show/Hide and uncheck the toolbars you want to hide.&lt;/li&gt;</span>
<a href="#l43.223"></a><span id="l43.223"> &lt;/ol&gt;</span>
<a href="#l43.224"></a><span id="l43.224"> </span>
<a href="#l43.225"></a><span id="l43.225"> &lt;p&gt;To reverse this action, open the View menu, choose Show/Hide, and then</span>
<a href="#l43.226"></a><span id="l43.226">   select the toolbars you want to show. You can also right-click on an empty</span>
<a href="#l43.227"></a><span id="l43.227">   section on the &lt;span class=&quot;noMac&quot;&gt;Menu Bar,&lt;/span&gt; Navigation Toolbar or</span>
<a href="#l43.228"></a><span id="l43.228">   Bookmarks Toolbar to turn toolbars on and off.&lt;/p&gt;</span>
<a href="#l43.229"></a><span id="l43.229" class="difflineminus">-  </span>
<a href="#l43.230"></a><span id="l43.230" class="difflineplus">+</span>
<a href="#l43.231"></a><span id="l43.231"> &lt;p&gt;[&lt;a href=&quot;#toolbars&quot;&gt;Return to beginning of section&lt;/a&gt;]&lt;/p&gt;</span>
<a href="#l43.232"></a><span id="l43.232"> </span>
<a href="#l43.233"></a><span id="l43.233"> &lt;h2 id=&quot;bookmarks&quot;&gt;Bookmarks&lt;/h2&gt;</span>
<a href="#l43.234"></a><span id="l43.234"> </span>
<a href="#l43.235"></a><span id="l43.235"> &lt;div class=&quot;contentsBox&quot;&gt;In this section:</span>
<a href="#l43.236"></a><span id="l43.236">   &lt;ul&gt;</span>
<a href="#l43.237"></a><span id="l43.237">     &lt;li&gt;&lt;a href=&quot;#what_are_bookmarks&quot;&gt;What Are Bookmarks?&lt;/a&gt;&lt;/li&gt;</span>
<a href="#l43.238"></a><span id="l43.238">     &lt;li&gt;&lt;a href=&quot;#using_bookmarks&quot;&gt;Using Bookmarks&lt;/a&gt;&lt;/li&gt;</span>
<a href="#l43.239"></a><span id="l43.239" class="difflineat">@@ -792,17 +792,17 @@</span>
<a href="#l43.240"></a><span id="l43.240"> </span>
<a href="#l43.241"></a><span id="l43.241"> &lt;ul&gt;</span>
<a href="#l43.242"></a><span id="l43.242">   &lt;li&gt;To add a bookmark to the Bookmarks menu, open the Bookmarks menu and</span>
<a href="#l43.243"></a><span id="l43.243">     choose Bookmark This Page.&lt;/li&gt;</span>
<a href="#l43.244"></a><span id="l43.244">   &lt;li&gt;To add a bookmark to a specific folder on the Bookmarks menu, or to</span>
<a href="#l43.245"></a><span id="l43.245">     provide a specific name or URL for your bookmark:</span>
<a href="#l43.246"></a><span id="l43.246">     &lt;ol&gt;</span>
<a href="#l43.247"></a><span id="l43.247">       &lt;li&gt;Open the Bookmarks menu and choose File Bookmark. Choose from any of</span>
<a href="#l43.248"></a><span id="l43.248" class="difflineminus">-        these options: </span>
<a href="#l43.249"></a><span id="l43.249" class="difflineplus">+        these options:</span>
<a href="#l43.250"></a><span id="l43.250">         &lt;ul&gt;</span>
<a href="#l43.251"></a><span id="l43.251">           &lt;li&gt;&lt;strong&gt;Name&lt;/strong&gt;: Enter a name for the bookmark if you want</span>
<a href="#l43.252"></a><span id="l43.252">             a different name.&lt;/li&gt;</span>
<a href="#l43.253"></a><span id="l43.253">           &lt;li&gt;&lt;strong&gt;Location&lt;/strong&gt;: Enter a URL for the bookmark if you</span>
<a href="#l43.254"></a><span id="l43.254">             want a different URL.&lt;/li&gt;</span>
<a href="#l43.255"></a><span id="l43.255">           &lt;li&gt;&lt;strong&gt;Keyword&lt;/strong&gt;: Enter a keyword for the bookmark if you</span>
<a href="#l43.256"></a><span id="l43.256">             want to be able to open the bookmarked page from the Location</span>
<a href="#l43.257"></a><span id="l43.257">             Bar (see</span>
<a href="#l43.258"></a><span id="l43.258" class="difflineat">@@ -811,24 +811,24 @@</span>
<a href="#l43.259"></a><span id="l43.259">           &lt;li&gt;&lt;strong&gt;Destination&lt;/strong&gt;: Choose a folder in which to create</span>
<a href="#l43.260"></a><span id="l43.260">             your bookmark.&lt;/li&gt;</span>
<a href="#l43.261"></a><span id="l43.261">           &lt;li&gt;&lt;strong&gt;New Folder&lt;/strong&gt;: Click this to create a new folder in</span>
<a href="#l43.262"></a><span id="l43.262">             which to create your bookmark.&lt;/li&gt;</span>
<a href="#l43.263"></a><span id="l43.263">         &lt;/ul&gt;</span>
<a href="#l43.264"></a><span id="l43.264">       &lt;/li&gt;</span>
<a href="#l43.265"></a><span id="l43.265">       &lt;li&gt;Click OK to add the bookmark.&lt;/li&gt;</span>
<a href="#l43.266"></a><span id="l43.266">     &lt;/ol&gt;</span>
<a href="#l43.267"></a><span id="l43.267" class="difflineminus">-  </span>
<a href="#l43.268"></a><span id="l43.268" class="difflineplus">+</span>
<a href="#l43.269"></a><span id="l43.269">     &lt;p&gt;&lt;strong&gt;Tip&lt;/strong&gt;: If you have multiple browser tabs open in a</span>
<a href="#l43.270"></a><span id="l43.270">       window, you can select &lt;q&gt;Bookmark this groups of tabs&lt;/q&gt; to add a</span>
<a href="#l43.271"></a><span id="l43.271">       single bookmark that will open all of the open tabs in the current</span>
<a href="#l43.272"></a><span id="l43.272">       window.&lt;/p&gt;</span>
<a href="#l43.273"></a><span id="l43.273">   &lt;/li&gt;</span>
<a href="#l43.274"></a><span id="l43.274">   &lt;li&gt;To add a bookmark to the Personal Toolbar, drag the bookmark icon</span>
<a href="#l43.275"></a><span id="l43.275" class="difflineminus">-    &lt;img src=&quot;chrome://communicator/skin/bookmarks/bookmark-item.svg&quot;</span>
<a href="#l43.276"></a><span id="l43.276" class="difflineplus">+    &lt;img src=&quot;chrome://communicator/skin/places/bookmark-item.svg&quot;</span>
<a href="#l43.277"></a><span id="l43.277">     alt=&quot;image of bookmark icon&quot;/&gt; next to the Location Bar to a place on</span>
<a href="#l43.278"></a><span id="l43.278">     the Personal Toolbar. You can drag a bookmark to the following places:</span>
<a href="#l43.279"></a><span id="l43.279">     &lt;ul&gt;</span>
<a href="#l43.280"></a><span id="l43.280">       &lt;li&gt;In the Bookmarks folder on the Personal Toolbar.&lt;/li&gt;</span>
<a href="#l43.281"></a><span id="l43.281">       &lt;li&gt;In a bookmarks folder you&amp;apos;ve created on the Personal</span>
<a href="#l43.282"></a><span id="l43.282">         Toolbar.&lt;/li&gt;</span>
<a href="#l43.283"></a><span id="l43.283">       &lt;li&gt;To the Personal Toolbar itself, on the right side of all bookmarks</span>
<a href="#l43.284"></a><span id="l43.284">         folders.</span>
<a href="#l43.285"></a><span id="l43.285" class="difflineat">@@ -847,26 +847,26 @@</span>
<a href="#l43.286"></a><span id="l43.286">   &lt;tr&gt;</span>
<a href="#l43.287"></a><span id="l43.287">     &lt;td&gt;&lt;strong&gt;Personal Toolbar&lt;/strong&gt;&lt;/td&gt;</span>
<a href="#l43.288"></a><span id="l43.288">   &lt;/tr&gt;</span>
<a href="#l43.289"></a><span id="l43.289"> &lt;/table&gt;</span>
<a href="#l43.290"></a><span id="l43.290"> </span>
<a href="#l43.291"></a><span id="l43.291"> &lt;ul&gt;</span>
<a href="#l43.292"></a><span id="l43.292">   &lt;li&gt;To add a bookmark to the Bookmarks tab in Sidebar, open Sidebar, select</span>
<a href="#l43.293"></a><span id="l43.293">     the Bookmarks tab, and drag the bookmark icon</span>
<a href="#l43.294"></a><span id="l43.294" class="difflineminus">-    &lt;img src=&quot;chrome://communicator/skin/bookmarks/bookmark-item.svg&quot;</span>
<a href="#l43.295"></a><span id="l43.295" class="difflineplus">+    &lt;img src=&quot;chrome://communicator/skin/places/bookmark-item.svg&quot;</span>
<a href="#l43.296"></a><span id="l43.296">     alt=&quot;image of bookmark icon&quot;/&gt; next to the Location Bar to a place on</span>
<a href="#l43.297"></a><span id="l43.297">     the bookmark list in the Bookmarks tab.</span>
<a href="#l43.298"></a><span id="l43.298">   &lt;/li&gt;</span>
<a href="#l43.299"></a><span id="l43.299"> &lt;/ul&gt;</span>
<a href="#l43.300"></a><span id="l43.300"> </span>
<a href="#l43.301"></a><span id="l43.301"> &lt;p&gt;&lt;strong&gt;Notes&lt;/strong&gt;:&lt;/p&gt;</span>
<a href="#l43.302"></a><span id="l43.302"> &lt;ul&gt;</span>
<a href="#l43.303"></a><span id="l43.303">   &lt;li&gt;The bookmark icon</span>
<a href="#l43.304"></a><span id="l43.304" class="difflineminus">-    &lt;img src=&quot;chrome://communicator/skin/bookmarks/bookmark-item.svg&quot;</span>
<a href="#l43.305"></a><span id="l43.305" class="difflineplus">+    &lt;img src=&quot;chrome://communicator/skin/places/bookmark-item.svg&quot;</span>
<a href="#l43.306"></a><span id="l43.306">     alt=&quot;image of bookmark icon&quot;/&gt; may appear as another page-specific</span>
<a href="#l43.307"></a><span id="l43.307">     icon if you have checked Show Website Icons in preferences. See</span>
<a href="#l43.308"></a><span id="l43.308">     &lt;a href=&quot;cs_nav_prefs_appearance.xhtml#appearance&quot;&gt;Appearance Preferences -</span>
<a href="#l43.309"></a><span id="l43.309">     Appearance&lt;/a&gt; for more information on changing this preferences.&lt;/li&gt;</span>
<a href="#l43.310"></a><span id="l43.310">   &lt;li&gt;After adding a bookmark using any of the methods listed above, it can be</span>
<a href="#l43.311"></a><span id="l43.311">     accessed using the Sidebar Bookmarks tab, the Manage Bookmarks window, and</span>
<a href="#l43.312"></a><span id="l43.312">     the Bookmarks menu.&lt;/li&gt;</span>
<a href="#l43.313"></a><span id="l43.313"> &lt;/ul&gt;</span>
<a href="#l43.314"></a><span id="l43.314" class="difflineat">@@ -945,17 +945,17 @@</span>
<a href="#l43.315"></a><span id="l43.315"> &lt;ol&gt;</span>
<a href="#l43.316"></a><span id="l43.316">   &lt;li&gt;Open the Bookmarks menu and choose Manage Bookmarks.&lt;/li&gt;</span>
<a href="#l43.317"></a><span id="l43.317">   &lt;li&gt;In your Bookmarks window, click a bookmark.&lt;/li&gt;</span>
<a href="#l43.318"></a><span id="l43.318">   &lt;li&gt;Click Properties.&lt;/li&gt;</span>
<a href="#l43.319"></a><span id="l43.319">   &lt;li&gt;In the bookmark Properties dialog box window, click the Info tab.&lt;/li&gt;</span>
<a href="#l43.320"></a><span id="l43.320"> &lt;/ol&gt;</span>
<a href="#l43.321"></a><span id="l43.321"> </span>
<a href="#l43.322"></a><span id="l43.322"> &lt;p&gt;You can rename the bookmark (the name appears in your bookmark list),</span>
<a href="#l43.323"></a><span id="l43.323" class="difflineminus">-  add descriptive information, or set a </span>
<a href="#l43.324"></a><span id="l43.324" class="difflineplus">+  add descriptive information, or set a</span>
<a href="#l43.325"></a><span id="l43.325">   &lt;a href=&quot;nav_help.xhtml#custom_keywords&quot;&gt;keyword&lt;/a&gt;.&lt;/p&gt;</span>
<a href="#l43.326"></a><span id="l43.326"> </span>
<a href="#l43.327"></a><span id="l43.327"> &lt;p&gt;You can also set &amp;brandShortName; to check bookmarked websites for</span>
<a href="#l43.328"></a><span id="l43.328">   changes.&lt;/p&gt;</span>
<a href="#l43.329"></a><span id="l43.329"> </span>
<a href="#l43.330"></a><span id="l43.330"> &lt;ol&gt;</span>
<a href="#l43.331"></a><span id="l43.331">   &lt;li&gt;Open the Bookmarks menu and choose Manage Bookmarks.&lt;/li&gt;</span>
<a href="#l43.332"></a><span id="l43.332">   &lt;li&gt;In your Bookmarks window, click a bookmark.&lt;/li&gt;</span>
<a href="#l43.333"></a><span id="l43.333" class="difflineat">@@ -1001,17 +1001,17 @@</span>
<a href="#l43.334"></a><span id="l43.334"> &lt;p&gt;[&lt;a href=&quot;#bookmarks&quot;&gt;Return to beginning of section&lt;/a&gt;]&lt;/p&gt;</span>
<a href="#l43.335"></a><span id="l43.335"> </span>
<a href="#l43.336"></a><span id="l43.336"> &lt;h3 id=&quot;exporting_or_importing_a_bookmark_list&quot;&gt;Exporting or Importing a</span>
<a href="#l43.337"></a><span id="l43.337">   Bookmark List&lt;/h3&gt;</span>
<a href="#l43.338"></a><span id="l43.338"> </span>
<a href="#l43.339"></a><span id="l43.339"> &lt;p&gt;Your bookmarks are stored in a file named bookmarks.html. You can export a</span>
<a href="#l43.340"></a><span id="l43.340">   copy of this file and save it in a folder of your choosing. You can then edit</span>
<a href="#l43.341"></a><span id="l43.341">   it and treat it as you would any HTML file.&lt;/p&gt;</span>
<a href="#l43.342"></a><span id="l43.342" class="difflineminus">-  </span>
<a href="#l43.343"></a><span id="l43.343" class="difflineplus">+</span>
<a href="#l43.344"></a><span id="l43.344"> &lt;ol&gt;</span>
<a href="#l43.345"></a><span id="l43.345">   &lt;li&gt;Open the Bookmarks menu and choose Manage Bookmarks.&lt;/li&gt;</span>
<a href="#l43.346"></a><span id="l43.346">   &lt;li&gt;In your Bookmarks window, open the Tools menu, and choose Export.&lt;/li&gt;</span>
<a href="#l43.347"></a><span id="l43.347">   &lt;li&gt;In the &lt;q&gt;Export Bookmarks File&lt;/q&gt; dialog box, choose a folder.</span>
<a href="#l43.348"></a><span id="l43.348">     Your bookmarks.html file will be copied into the folder you designate.&lt;/li&gt;</span>
<a href="#l43.349"></a><span id="l43.349">   &lt;li&gt;Click Save.&lt;/li&gt;</span>
<a href="#l43.350"></a><span id="l43.350"> &lt;/ol&gt;</span>
<a href="#l43.351"></a><span id="l43.351"> </span>
<a href="#l43.352"></a><span id="l43.352" class="difflineat">@@ -1140,17 +1140,17 @@</span>
<a href="#l43.353"></a><span id="l43.353"> &lt;/ul&gt;</span>
<a href="#l43.354"></a><span id="l43.354"> </span>
<a href="#l43.355"></a><span id="l43.355"> &lt;p&gt;[&lt;a href=&quot;#add-ons&quot;&gt;Return to beginning of section&lt;/a&gt;]&lt;/p&gt;</span>
<a href="#l43.356"></a><span id="l43.356"> </span>
<a href="#l43.357"></a><span id="l43.357"> &lt;h3 id=&quot;using_the_add-ons_manager&quot;&gt;Using the Add-ons Manager&lt;/h3&gt;</span>
<a href="#l43.358"></a><span id="l43.358"> </span>
<a href="#l43.359"></a><span id="l43.359"> &lt;p&gt;The Add-ons Manager enables you to install and uninstall Add-ons, enable and</span>
<a href="#l43.360"></a><span id="l43.360">   disable them and, in some cases, set preferences for them.&lt;/p&gt;</span>
<a href="#l43.361"></a><span id="l43.361" class="difflineminus">-  </span>
<a href="#l43.362"></a><span id="l43.362" class="difflineplus">+</span>
<a href="#l43.363"></a><span id="l43.363"> &lt;p id=&quot;accessing_the_add-ons_manager&quot;&gt;To access the Add-ons Manager, follow any</span>
<a href="#l43.364"></a><span id="l43.364">   of these steps:&lt;/p&gt;</span>
<a href="#l43.365"></a><span id="l43.365"> </span>
<a href="#l43.366"></a><span id="l43.366"> &lt;ul&gt;</span>
<a href="#l43.367"></a><span id="l43.367">   &lt;li&gt;Open the Tools menu, then select Add-ons Manager.&lt;/li&gt;</span>
<a href="#l43.368"></a><span id="l43.368">   &lt;li&gt;Open the &lt;span class=&quot;mac&quot;&gt;&amp;brandShortName;&lt;/span&gt;&lt;span</span>
<a href="#l43.369"></a><span id="l43.369">     class=&quot;noMac&quot;&gt;Edit&lt;/span&gt; menu and choose Preferences, expand the Advanced</span>
<a href="#l43.370"></a><span id="l43.370">     category, click Software Installation, then Manage Add-ons.&lt;/li&gt;</span>
<a href="#l43.371"></a><span id="l43.371" class="difflineat">@@ -1310,17 +1310,17 @@</span>
<a href="#l43.372"></a><span id="l43.372">   &lt;li&gt;To get more information about any of the installed themes, click</span>
<a href="#l43.373"></a><span id="l43.373">     &lt;q&gt;More&lt;/q&gt; for the entry in the list. The entry will expand into the</span>
<a href="#l43.374"></a><span id="l43.374">     full tab and show the description of the theme along with its version</span>
<a href="#l43.375"></a><span id="l43.375">     information.&lt;/li&gt;</span>
<a href="#l43.376"></a><span id="l43.376">   &lt;li&gt;To use a theme, click the Enable button for the entry corresponding</span>
<a href="#l43.377"></a><span id="l43.377">     to the desired theme. An info bar appears if the changes will apply only</span>
<a href="#l43.378"></a><span id="l43.378">     once you restart &amp;brandShortName;. The info bar features a &lt;q&gt;Restart</span>
<a href="#l43.379"></a><span id="l43.379">     Now&lt;/q&gt; option.</span>
<a href="#l43.380"></a><span id="l43.380" class="difflineminus">-    </span>
<a href="#l43.381"></a><span id="l43.381" class="difflineplus">+</span>
<a href="#l43.382"></a><span id="l43.382">     &lt;p&gt;&lt;strong&gt;Note&lt;/strong&gt;: Contrary to extensions, you can use only one</span>
<a href="#l43.383"></a><span id="l43.383">     theme at a time.&lt;/p&gt;</span>
<a href="#l43.384"></a><span id="l43.384">   &lt;/li&gt;</span>
<a href="#l43.385"></a><span id="l43.385">   &lt;li&gt;To uninstall a theme, click the Remove button for the entry corresponding</span>
<a href="#l43.386"></a><span id="l43.386">     to the desired theme. An info bar appears if the changes will apply only</span>
<a href="#l43.387"></a><span id="l43.387">     once you restart &amp;brandShortName;. The info bar features a &lt;q&gt;Restart</span>
<a href="#l43.388"></a><span id="l43.388">     Now&lt;/q&gt; option.&lt;/li&gt;</span>
<a href="#l43.389"></a><span id="l43.389"> &lt;/ul&gt;</span>
<a href="#l43.390"></a><span id="l43.390" class="difflineat">@@ -1485,17 +1485,17 @@</span>
<a href="#l43.391"></a><span id="l43.391">         browser window your home page.&lt;/li&gt;</span>
<a href="#l43.392"></a><span id="l43.392">       &lt;li&gt;Click Choose File to select a file from your computer&amp;apos;s hard</span>
<a href="#l43.393"></a><span id="l43.393">         drive.&lt;/li&gt;</span>
<a href="#l43.394"></a><span id="l43.394">    &lt;/ul&gt;</span>
<a href="#l43.395"></a><span id="l43.395">  &lt;/li&gt;</span>
<a href="#l43.396"></a><span id="l43.396"> &lt;/ol&gt;</span>
<a href="#l43.397"></a><span id="l43.397"> </span>
<a href="#l43.398"></a><span id="l43.398"> &lt;p&gt;&lt;strong&gt;Tip&lt;/strong&gt;: To specify your home page quickly, drag the bookmark</span>
<a href="#l43.399"></a><span id="l43.399" class="difflineminus">-  icon &lt;img src=&quot;chrome://communicator/skin/bookmarks/bookmark-item.svg&quot;</span>
<a href="#l43.400"></a><span id="l43.400" class="difflineplus">+  icon &lt;img src=&quot;chrome://communicator/skin/places/bookmark-item.svg&quot;</span>
<a href="#l43.401"></a><span id="l43.401">   alt=&quot;image of bookmark icon&quot;/&gt; from the Location Bar to the Home Page</span>
<a href="#l43.402"></a><span id="l43.402">   button on the Personal Toolbar.&lt;/p&gt;</span>
<a href="#l43.403"></a><span id="l43.403"> </span>
<a href="#l43.404"></a><span id="l43.404"> &lt;p&gt;[&lt;a href=&quot;#specifying_how_mozilla_starts_up&quot;&gt;Return to beginning of</span>
<a href="#l43.405"></a><span id="l43.405">   section&lt;/a&gt;]&lt;/p&gt;</span>
<a href="#l43.406"></a><span id="l43.406"> </span>
<a href="#l43.407"></a><span id="l43.407"> &lt;h3 id=&quot;specifying_which_components_open_at_launch&quot;&gt;Specifying Which Components</span>
<a href="#l43.408"></a><span id="l43.408">   Open at Launch&lt;/h3&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l44.1"></a><span id="l44.1" class="difflineminus">--- a/suite/locales/en-US/chrome/common/places/bookmarkProperties.properties</span>
<a href="#l44.2"></a><span id="l44.2" class="difflineplus">+++ b/suite/locales/en-US/chrome/common/places/bookmarkProperties.properties</span>
<a href="#l44.3"></a><span id="l44.3" class="difflineat">@@ -6,14 +6,14 @@ dialogAcceptLabelAddItem=Add</span>
<a href="#l44.4"></a><span id="l44.4"> dialogAcceptLabelSaveItem=Save</span>
<a href="#l44.5"></a><span id="l44.5"> dialogAcceptLabelAddLivemark=Subscribe</span>
<a href="#l44.6"></a><span id="l44.6"> dialogAcceptLabelAddMulti=Add Bookmarks</span>
<a href="#l44.7"></a><span id="l44.7"> dialogAcceptLabelEdit=Save</span>
<a href="#l44.8"></a><span id="l44.8"> dialogTitleAddBookmark=New Bookmark</span>
<a href="#l44.9"></a><span id="l44.9"> dialogTitleAddLivemark=Subscribe with Live Bookmark</span>
<a href="#l44.10"></a><span id="l44.10"> dialogTitleAddFolder=New Folder</span>
<a href="#l44.11"></a><span id="l44.11"> dialogTitleAddMulti=New Bookmarks</span>
<a href="#l44.12"></a><span id="l44.12" class="difflineminus">-dialogTitleEdit=Properties for &quot;%S&quot;</span>
<a href="#l44.13"></a><span id="l44.13" class="difflineplus">+dialogTitleEdit=Properties for “%S”</span>
<a href="#l44.14"></a><span id="l44.14"> </span>
<a href="#l44.15"></a><span id="l44.15"> bookmarkAllTabsDefault=[Folder Name]</span>
<a href="#l44.16"></a><span id="l44.16"> newFolderDefault=New Folder</span>
<a href="#l44.17"></a><span id="l44.17"> newBookmarkDefault=New Bookmark</span>
<a href="#l44.18"></a><span id="l44.18"> newLivemarkDefault=New Live Bookmark</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l45.1"></a><span id="l45.1" class="difflineminus">--- a/suite/locales/en-US/chrome/common/places/editBookmarkOverlay.dtd</span>
<a href="#l45.2"></a><span id="l45.2" class="difflineplus">+++ b/suite/locales/en-US/chrome/common/places/editBookmarkOverlay.dtd</span>
<a href="#l45.3"></a><span id="l45.3" class="difflineat">@@ -6,23 +6,23 @@</span>
<a href="#l45.4"></a><span id="l45.4"> &lt;!ENTITY editBookmarkOverlay.name.accesskey                  &quot;N&quot;&gt;</span>
<a href="#l45.5"></a><span id="l45.5"> &lt;!ENTITY editBookmarkOverlay.location.label                  &quot;Location:&quot;&gt;</span>
<a href="#l45.6"></a><span id="l45.6"> &lt;!ENTITY editBookmarkOverlay.location.accesskey              &quot;L&quot;&gt;</span>
<a href="#l45.7"></a><span id="l45.7"> &lt;!ENTITY editBookmarkOverlay.feedLocation.label              &quot;Feed Location:&quot;&gt;</span>
<a href="#l45.8"></a><span id="l45.8"> &lt;!ENTITY editBookmarkOverlay.feedLocation.accesskey          &quot;F&quot;&gt;</span>
<a href="#l45.9"></a><span id="l45.9"> &lt;!ENTITY editBookmarkOverlay.siteLocation.label              &quot;Site Location:&quot;&gt;</span>
<a href="#l45.10"></a><span id="l45.10"> &lt;!ENTITY editBookmarkOverlay.siteLocation.accesskey          &quot;S&quot;&gt;</span>
<a href="#l45.11"></a><span id="l45.11"> &lt;!ENTITY editBookmarkOverlay.folder.label                    &quot;Folder:&quot;&gt;</span>
<a href="#l45.12"></a><span id="l45.12" class="difflineminus">-&lt;!ENTITY editBookmarkOverlay.folder.accesskey                &quot;F&quot;&gt;</span>
<a href="#l45.13"></a><span id="l45.13"> &lt;!ENTITY editBookmarkOverlay.foldersExpanderDown.tooltip     &quot;Show all the bookmarks folders&quot;&gt;</span>
<a href="#l45.14"></a><span id="l45.14"> &lt;!ENTITY editBookmarkOverlay.expanderUp.tooltip              &quot;Hide&quot;&gt;</span>
<a href="#l45.15"></a><span id="l45.15"> &lt;!ENTITY editBookmarkOverlay.tags.label                      &quot;Tags:&quot;&gt;</span>
<a href="#l45.16"></a><span id="l45.16" class="difflineminus">-&lt;!ENTITY editBookmarkOverlay.tags.accesskey                  &quot;a&quot;&gt;</span>
<a href="#l45.17"></a><span id="l45.17" class="difflineplus">+&lt;!ENTITY editBookmarkOverlay.tags.accesskey                  &quot;T&quot;&gt;</span>
<a href="#l45.18"></a><span id="l45.18"> &lt;!ENTITY editBookmarkOverlay.tagsEmptyDesc.label             &quot;Separate tags with commas&quot;&gt;</span>
<a href="#l45.19"></a><span id="l45.19"> &lt;!ENTITY editBookmarkOverlay.description.label               &quot;Description:&quot;&gt;</span>
<a href="#l45.20"></a><span id="l45.20"> &lt;!ENTITY editBookmarkOverlay.description.accesskey           &quot;D&quot;&gt;</span>
<a href="#l45.21"></a><span id="l45.21"> &lt;!ENTITY editBookmarkOverlay.keyword.label                   &quot;Keyword:&quot;&gt;</span>
<a href="#l45.22"></a><span id="l45.22"> &lt;!ENTITY editBookmarkOverlay.keyword.accesskey               &quot;K&quot;&gt;</span>
<a href="#l45.23"></a><span id="l45.23"> &lt;!ENTITY editBookmarkOverlay.tagsExpanderDown.tooltip        &quot;Show all tags&quot;&gt;</span>
<a href="#l45.24"></a><span id="l45.24" class="difflineplus">+&lt;!ENTITY editBookmarkOverlay.loadInSidebar.label             &quot;Load this bookmark in the sidebar&quot;&gt;</span>
<a href="#l45.25"></a><span id="l45.25" class="difflineplus">+&lt;!ENTITY editBookmarkOverlay.loadInSidebar.accesskey         &quot;h&quot;&gt;</span>
<a href="#l45.26"></a><span id="l45.26"> &lt;!ENTITY editBookmarkOverlay.choose.label                    &quot;Choose…&quot;&gt;</span>
<a href="#l45.27"></a><span id="l45.27"> &lt;!ENTITY editBookmarkOverlay.newFolderButton.label           &quot;New Folder&quot;&gt;</span>
<a href="#l45.28"></a><span id="l45.28"> &lt;!ENTITY editBookmarkOverlay.newFolderButton.accesskey       &quot;o&quot;&gt;</span>
<a href="#l45.29"></a><span id="l45.29" class="difflineminus">-&lt;!ENTITY editBookmarkOverlay.newFolderButton.tooltip         &quot;Create new folder&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l46.1"></a><span id="l46.1">deleted file mode 100644</span>
<a href="#l46.2"></a><span id="l46.2" class="difflineminus">--- a/suite/locales/en-US/chrome/common/places/moveBookmarks.dtd</span>
<a href="#l46.3"></a><span id="l46.3" class="difflineplus">+++ /dev/null</span>
<a href="#l46.4"></a><span id="l46.4" class="difflineat">@@ -1,9 +0,0 @@</span>
<a href="#l46.5"></a><span id="l46.5" class="difflineminus">-&lt;!-- This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l46.6"></a><span id="l46.6" class="difflineminus">-   - License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l46.7"></a><span id="l46.7" class="difflineminus">-   - file, You can obtain one at http://mozilla.org/MPL/2.0/. --&gt;</span>
<a href="#l46.8"></a><span id="l46.8" class="difflineminus">-</span>
<a href="#l46.9"></a><span id="l46.9" class="difflineminus">-&lt;!ENTITY window.title              &quot;Choose Folder&quot;&gt;</span>
<a href="#l46.10"></a><span id="l46.10" class="difflineminus">-&lt;!ENTITY window.style              &quot;width: 36em; height: 18em;&quot;&gt;</span>
<a href="#l46.11"></a><span id="l46.11" class="difflineminus">-&lt;!ENTITY moveTo.label              &quot;Move to:&quot;&gt;</span>
<a href="#l46.12"></a><span id="l46.12" class="difflineminus">-&lt;!ENTITY newFolderButton.label     &quot;New Folder&quot;&gt;</span>
<a href="#l46.13"></a><span id="l46.13" class="difflineminus">-&lt;!ENTITY newFolderButton.accesskey &quot;N&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l47.1"></a><span id="l47.1" class="difflineminus">--- a/suite/locales/en-US/chrome/common/places/places.dtd</span>
<a href="#l47.2"></a><span id="l47.2" class="difflineplus">+++ b/suite/locales/en-US/chrome/common/places/places.dtd</span>
<a href="#l47.3"></a><span id="l47.3" class="difflineat">@@ -1,114 +1,106 @@</span>
<a href="#l47.4"></a><span id="l47.4"> &lt;!-- This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l47.5"></a><span id="l47.5">    - License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l47.6"></a><span id="l47.6">    - file, You can obtain one at http://mozilla.org/MPL/2.0/. --&gt;</span>
<a href="#l47.7"></a><span id="l47.7"> </span>
<a href="#l47.8"></a><span id="l47.8" class="difflineminus">-&lt;!ENTITY bookmarksManager.title         &quot;Bookmarks Manager&quot;&gt;</span>
<a href="#l47.9"></a><span id="l47.9" class="difflineminus">-&lt;!ENTITY bookmarksManager.width         &quot;700&quot;&gt;</span>
<a href="#l47.10"></a><span id="l47.10" class="difflineminus">-&lt;!ENTITY bookmarksManager.height        &quot;500&quot;&gt;</span>
<a href="#l47.11"></a><span id="l47.11" class="difflineplus">+&lt;!-- LOCALIZATION NOTE (places.library.title): use &quot;Library&quot;, &quot;Archive&quot; or &quot;Repository&quot; --&gt;</span>
<a href="#l47.12"></a><span id="l47.12" class="difflineplus">+&lt;!ENTITY places.library.title  &quot;Library&quot;&gt;</span>
<a href="#l47.13"></a><span id="l47.13" class="difflineplus">+&lt;!ENTITY places.library.width  &quot;700&quot;&gt;</span>
<a href="#l47.14"></a><span id="l47.14" class="difflineplus">+&lt;!ENTITY places.library.height &quot;500&quot;&gt;</span>
<a href="#l47.15"></a><span id="l47.15" class="difflineplus">+&lt;!ENTITY organize.label        &quot;Organize&quot;&gt;</span>
<a href="#l47.16"></a><span id="l47.16" class="difflineplus">+&lt;!ENTITY organize.accesskey    &quot;O&quot;&gt;</span>
<a href="#l47.17"></a><span id="l47.17" class="difflineplus">+&lt;!ENTITY organize.tooltip      &quot;Organize your bookmarks&quot;&gt;</span>
<a href="#l47.18"></a><span id="l47.18"> </span>
<a href="#l47.19"></a><span id="l47.19" class="difflineminus">-&lt;!ENTITY file.accesskey                 &quot;F&quot;&gt;</span>
<a href="#l47.20"></a><span id="l47.20"> &lt;!ENTITY file.close.label               &quot;Close&quot;&gt;</span>
<a href="#l47.21"></a><span id="l47.21"> &lt;!ENTITY file.close.accesskey           &quot;C&quot;&gt;</span>
<a href="#l47.22"></a><span id="l47.22"> &lt;!ENTITY cmd.close.key                  &quot;w&quot;&gt;</span>
<a href="#l47.23"></a><span id="l47.23" class="difflineminus">-</span>
<a href="#l47.24"></a><span id="l47.24" class="difflineplus">+&lt;!ENTITY views.label                    &quot;Views&quot;&gt;</span>
<a href="#l47.25"></a><span id="l47.25" class="difflineplus">+&lt;!ENTITY views.accesskey                &quot;V&quot;&gt;</span>
<a href="#l47.26"></a><span id="l47.26" class="difflineplus">+&lt;!ENTITY views.tooltip                  &quot;Change your view&quot;&gt;</span>
<a href="#l47.27"></a><span id="l47.27"> &lt;!ENTITY view.columns.label             &quot;Show Columns&quot;&gt;</span>
<a href="#l47.28"></a><span id="l47.28"> &lt;!ENTITY view.columns.accesskey         &quot;C&quot;&gt;</span>
<a href="#l47.29"></a><span id="l47.29"> &lt;!ENTITY view.sort.label                &quot;Sort&quot;&gt;</span>
<a href="#l47.30"></a><span id="l47.30"> &lt;!ENTITY view.sort.accesskey            &quot;S&quot;&gt;</span>
<a href="#l47.31"></a><span id="l47.31"> &lt;!ENTITY view.unsorted.label            &quot;Unsorted&quot;&gt;</span>
<a href="#l47.32"></a><span id="l47.32"> &lt;!ENTITY view.unsorted.accesskey        &quot;U&quot;&gt;</span>
<a href="#l47.33"></a><span id="l47.33"> &lt;!ENTITY view.sortAscending.label       &quot;A &gt; Z Sort Order&quot;&gt;</span>
<a href="#l47.34"></a><span id="l47.34"> &lt;!ENTITY view.sortAscending.accesskey   &quot;A&quot;&gt;</span>
<a href="#l47.35"></a><span id="l47.35"> &lt;!ENTITY view.sortDescending.label      &quot;Z &gt; A Sort Order&quot;&gt;</span>
<a href="#l47.36"></a><span id="l47.36"> &lt;!ENTITY view.sortDescending.accesskey  &quot;Z&quot;&gt;</span>
<a href="#l47.37"></a><span id="l47.37"> </span>
<a href="#l47.38"></a><span id="l47.38" class="difflineminus">-&lt;!ENTITY cmd.findInBookmarks.label      &quot;Find in Bookmarks…&quot;&gt;</span>
<a href="#l47.39"></a><span id="l47.39" class="difflineminus">-&lt;!ENTITY cmd.findInBookmarks.accesskey  &quot;F&quot;&gt;</span>
<a href="#l47.40"></a><span id="l47.40" class="difflineminus">-&lt;!ENTITY cmd.findCurrent.label          &quot;Find in Current Collection…&quot;&gt;</span>
<a href="#l47.41"></a><span id="l47.41" class="difflineminus">-&lt;!ENTITY cmd.findCurrent.accesskey      &quot;i&quot;&gt;</span>
<a href="#l47.42"></a><span id="l47.42" class="difflineminus">-</span>
<a href="#l47.43"></a><span id="l47.43" class="difflineminus">-&lt;!ENTITY cmd.exportHTML.label           &quot;Export HTML…&quot;&gt;</span>
<a href="#l47.44"></a><span id="l47.44" class="difflineminus">-&lt;!ENTITY cmd.exportHTML.accesskey       &quot;E&quot;&gt;</span>
<a href="#l47.45"></a><span id="l47.45" class="difflineminus">-&lt;!ENTITY cmd.importHTML.label           &quot;Import HTML…&quot;&gt;</span>
<a href="#l47.46"></a><span id="l47.46" class="difflineminus">-&lt;!ENTITY cmd.importHTML.accesskey       &quot;I&quot;&gt;</span>
<a href="#l47.47"></a><span id="l47.47" class="difflineplus">+&lt;!ENTITY importBookmarksFromHTML.label     &quot;Import Bookmarks from HTML…&quot;&gt;</span>
<a href="#l47.48"></a><span id="l47.48" class="difflineplus">+&lt;!ENTITY importBookmarksFromHTML.accesskey &quot;I&quot;&gt;</span>
<a href="#l47.49"></a><span id="l47.49" class="difflineplus">+&lt;!ENTITY exportBookmarksToHTML.label       &quot;Export Bookmarks to HTML…&quot;&gt;</span>
<a href="#l47.50"></a><span id="l47.50" class="difflineplus">+&lt;!ENTITY exportBookmarksToHTML.accesskey   &quot;E&quot;&gt;</span>
<a href="#l47.51"></a><span id="l47.51" class="difflineplus">+&lt;!ENTITY importOtherBrowser.label          &quot;Import Data from Another Browser…&quot;&gt;</span>
<a href="#l47.52"></a><span id="l47.52" class="difflineplus">+&lt;!ENTITY importOtherBrowser.accesskey      &quot;A&quot;&gt;</span>
<a href="#l47.53"></a><span id="l47.53"> </span>
<a href="#l47.54"></a><span id="l47.54"> &lt;!ENTITY cmd.backup.label               &quot;Backup…&quot;&gt;</span>
<a href="#l47.55"></a><span id="l47.55"> &lt;!ENTITY cmd.backup.accesskey           &quot;B&quot;&gt;</span>
<a href="#l47.56"></a><span id="l47.56"> &lt;!ENTITY cmd.restore2.label             &quot;Restore&quot;&gt;</span>
<a href="#l47.57"></a><span id="l47.57"> &lt;!ENTITY cmd.restore2.accesskey         &quot;R&quot;&gt;</span>
<a href="#l47.58"></a><span id="l47.58"> &lt;!ENTITY cmd.restoreFromFile.label      &quot;Choose File…&quot;&gt;</span>
<a href="#l47.59"></a><span id="l47.59"> &lt;!ENTITY cmd.restoreFromFile.accesskey  &quot;C&quot;&gt;</span>
<a href="#l47.60"></a><span id="l47.60"> </span>
<a href="#l47.61"></a><span id="l47.61" class="difflineminus">-&lt;!ENTITY cmd.bookmarkLink.label         &quot;Bookmark This Page…&quot;&gt;</span>
<a href="#l47.62"></a><span id="l47.62" class="difflineminus">-&lt;!ENTITY cmd.bookmarkLink.accesskey     &quot;B&quot;&gt;</span>
<a href="#l47.63"></a><span id="l47.63" class="difflineminus">-&lt;!ENTITY cmd.delete.label               &quot;Delete This Page&quot;&gt;</span>
<a href="#l47.64"></a><span id="l47.64" class="difflineminus">-&lt;!ENTITY cmd.delete.accesskey           &quot;D&quot;&gt;</span>
<a href="#l47.65"></a><span id="l47.65"> &lt;!ENTITY cmd.deleteDomainData.label     &quot;Forget About This Site&quot;&gt;</span>
<a href="#l47.66"></a><span id="l47.66"> &lt;!ENTITY cmd.deleteDomainData.accesskey &quot;F&quot;&gt;</span>
<a href="#l47.67"></a><span id="l47.67"> </span>
<a href="#l47.68"></a><span id="l47.68"> &lt;!ENTITY cmd.open.label                  &quot;Open&quot;&gt;</span>
<a href="#l47.69"></a><span id="l47.69"> &lt;!ENTITY cmd.open.accesskey              &quot;O&quot;&gt;</span>
<a href="#l47.70"></a><span id="l47.70" class="difflineplus">+&lt;!ENTITY cmd.open_window.label           &quot;Open in a New Window&quot;&gt;</span>
<a href="#l47.71"></a><span id="l47.71" class="difflineplus">+&lt;!ENTITY cmd.open_window.accesskey       &quot;N&quot;&gt;</span>
<a href="#l47.72"></a><span id="l47.72" class="difflineplus">+&lt;!ENTITY cmd.open_private_window.label     &quot;Open in a New Private Window&quot;&gt;</span>
<a href="#l47.73"></a><span id="l47.73" class="difflineplus">+&lt;!ENTITY cmd.open_private_window.accesskey &quot;P&quot;&gt;</span>
<a href="#l47.74"></a><span id="l47.74"> &lt;!ENTITY cmd.open_tab.label              &quot;Open in a New Tab&quot;&gt;</span>
<a href="#l47.75"></a><span id="l47.75"> &lt;!ENTITY cmd.open_tab.accesskey          &quot;w&quot;&gt;</span>
<a href="#l47.76"></a><span id="l47.76" class="difflineminus">-&lt;!ENTITY cmd.open_window.label           &quot;Open in a New Window&quot;&gt;</span>
<a href="#l47.77"></a><span id="l47.77" class="difflineminus">-&lt;!ENTITY cmd.open_window.accesskey       &quot;N&quot;&gt;</span>
<a href="#l47.78"></a><span id="l47.78" class="difflineminus">-&lt;!ENTITY cmd.open_private.label          &quot;Open in a Private Window&quot;&gt;</span>
<a href="#l47.79"></a><span id="l47.79" class="difflineminus">-&lt;!ENTITY cmd.open_private.accesskey      &quot;v&quot;&gt;</span>
<a href="#l47.80"></a><span id="l47.80"> &lt;!ENTITY cmd.open_all_in_tabs.label      &quot;Open All in Tabs&quot;&gt;</span>
<a href="#l47.81"></a><span id="l47.81"> &lt;!ENTITY cmd.open_all_in_tabs.accesskey  &quot;O&quot;&gt;</span>
<a href="#l47.82"></a><span id="l47.82"> </span>
<a href="#l47.83"></a><span id="l47.83"> &lt;!ENTITY cmd.properties.label      &quot;Properties&quot;&gt;</span>
<a href="#l47.84"></a><span id="l47.84"> &lt;!ENTITY cmd.properties.accesskey  &quot;i&quot;&gt;</span>
<a href="#l47.85"></a><span id="l47.85"> </span>
<a href="#l47.86"></a><span id="l47.86"> &lt;!ENTITY cmd.sortby_name.label              &quot;Sort By Name&quot;&gt;</span>
<a href="#l47.87"></a><span id="l47.87" class="difflineminus">-&lt;!ENTITY cmd.sortby_name.accesskey          &quot;r&quot;&gt;</span>
<a href="#l47.88"></a><span id="l47.88" class="difflineplus">+&lt;!ENTITY cmd.sortby_name.accesskey          &quot;S&quot;&gt;</span>
<a href="#l47.89"></a><span id="l47.89" class="difflineplus">+&lt;!ENTITY cmd.context_sortby_name.accesskey  &quot;r&quot;&gt;</span>
<a href="#l47.90"></a><span id="l47.90"> </span>
<a href="#l47.91"></a><span id="l47.91"> &lt;!ENTITY cmd.new_bookmark.label            &quot;New Bookmark…&quot;&gt;</span>
<a href="#l47.92"></a><span id="l47.92"> &lt;!ENTITY cmd.new_bookmark.accesskey        &quot;B&quot;&gt;</span>
<a href="#l47.93"></a><span id="l47.93"> &lt;!ENTITY cmd.new_folder.label              &quot;New Folder…&quot;&gt;</span>
<a href="#l47.94"></a><span id="l47.94"> &lt;!ENTITY cmd.new_folder.accesskey          &quot;o&quot;&gt;</span>
<a href="#l47.95"></a><span id="l47.95"> &lt;!ENTITY cmd.context_new_folder.accesskey  &quot;F&quot;&gt;</span>
<a href="#l47.96"></a><span id="l47.96"> &lt;!ENTITY cmd.new_separator.label           &quot;New Separator&quot;&gt;</span>
<a href="#l47.97"></a><span id="l47.97"> &lt;!ENTITY cmd.new_separator.accesskey       &quot;S&quot;&gt;</span>
<a href="#l47.98"></a><span id="l47.98"> </span>
<a href="#l47.99"></a><span id="l47.99"> &lt;!ENTITY cmd.reloadLivebookmark.label      &quot;Reload Live Bookmark&quot;&gt;</span>
<a href="#l47.100"></a><span id="l47.100"> &lt;!ENTITY cmd.reloadLivebookmark.accesskey  &quot;R&quot;&gt;</span>
<a href="#l47.101"></a><span id="l47.101"> </span>
<a href="#l47.102"></a><span id="l47.102" class="difflineminus">-&lt;!ENTITY cmd.moveBookmarks.label                  &quot;Move…&quot;&gt;</span>
<a href="#l47.103"></a><span id="l47.103" class="difflineminus">-&lt;!ENTITY cmd.moveBookmarks.accesskey              &quot;M&quot;&gt;</span>
<a href="#l47.104"></a><span id="l47.104" class="difflineminus">-</span>
<a href="#l47.105"></a><span id="l47.105" class="difflineminus">-&lt;!ENTITY col.title.label         &quot;Name&quot;&gt;</span>
<a href="#l47.106"></a><span id="l47.106" class="difflineplus">+&lt;!ENTITY col.name.label          &quot;Name&quot;&gt;</span>
<a href="#l47.107"></a><span id="l47.107"> &lt;!ENTITY col.tags.label          &quot;Tags&quot;&gt;</span>
<a href="#l47.108"></a><span id="l47.108"> &lt;!ENTITY col.url.label           &quot;Location&quot;&gt;</span>
<a href="#l47.109"></a><span id="l47.109" class="difflineminus">-&lt;!ENTITY col.lastvisit.label     &quot;Visit Date&quot;&gt;</span>
<a href="#l47.110"></a><span id="l47.110" class="difflineplus">+&lt;!ENTITY col.mostrecentvisit.label &quot;Most Recent Visit&quot;&gt;</span>
<a href="#l47.111"></a><span id="l47.111"> &lt;!ENTITY col.visitcount.label    &quot;Visit Count&quot;&gt;</span>
<a href="#l47.112"></a><span id="l47.112" class="difflineminus">-&lt;!ENTITY col.keyword.label       &quot;Keyword&quot;&gt;</span>
<a href="#l47.113"></a><span id="l47.113"> &lt;!ENTITY col.description.label   &quot;Description&quot;&gt;</span>
<a href="#l47.114"></a><span id="l47.114"> &lt;!ENTITY col.dateadded.label     &quot;Added&quot;&gt;</span>
<a href="#l47.115"></a><span id="l47.115"> &lt;!ENTITY col.lastmodified.label  &quot;Last Modified&quot;&gt;</span>
<a href="#l47.116"></a><span id="l47.116"> </span>
<a href="#l47.117"></a><span id="l47.117" class="difflineminus">-&lt;!ENTITY search.label                              &quot;Search:&quot;&gt;</span>
<a href="#l47.118"></a><span id="l47.118" class="difflineminus">-&lt;!ENTITY search.placeholder                        &quot;Search Bookmarks&quot;&gt;</span>
<a href="#l47.119"></a><span id="l47.119" class="difflineminus">-</span>
<a href="#l47.120"></a><span id="l47.120" class="difflineminus">-&lt;!ENTITY search.in.label                           &quot;Search in:&quot;&gt;</span>
<a href="#l47.121"></a><span id="l47.121" class="difflineminus">-&lt;!ENTITY search.scopeFolder.label                  &quot;Selected Folder&quot;&gt;</span>
<a href="#l47.122"></a><span id="l47.122" class="difflineminus">-&lt;!ENTITY search.scopeFolder.accesskey              &quot;m&quot;&gt;</span>
<a href="#l47.123"></a><span id="l47.123" class="difflineminus">-&lt;!ENTITY search.scopeBookmarks.label               &quot;Bookmarks&quot;&gt;</span>
<a href="#l47.124"></a><span id="l47.124" class="difflineminus">-&lt;!ENTITY search.scopeBookmarks.accesskey           &quot;B&quot;&gt;</span>
<a href="#l47.125"></a><span id="l47.125" class="difflineminus">-&lt;!ENTITY saveSearch.label                          &quot;Save&quot;&gt;</span>
<a href="#l47.126"></a><span id="l47.126" class="difflineminus">-&lt;!ENTITY saveSearch.accesskey                      &quot;S&quot;&gt;</span>
<a href="#l47.127"></a><span id="l47.127" class="difflineplus">+&lt;!ENTITY search.placeholder  &quot;Search&quot;&gt;</span>
<a href="#l47.128"></a><span id="l47.128"> </span>
<a href="#l47.129"></a><span id="l47.129"> &lt;!ENTITY cmd.find.key  &quot;f&quot;&gt;</span>
<a href="#l47.130"></a><span id="l47.130"> </span>
<a href="#l47.131"></a><span id="l47.131" class="difflineminus">-&lt;!ENTITY backButton.tooltip  &quot;Go back&quot;&gt;</span>
<a href="#l47.132"></a><span id="l47.132" class="difflineminus">-&lt;!ENTITY forwardButton.tooltip  &quot;Go forward&quot;&gt;</span>
<a href="#l47.133"></a><span id="l47.133" class="difflineminus">-</span>
<a href="#l47.134"></a><span id="l47.134"> &lt;!ENTITY detailsPane.more.label &quot;More&quot;&gt;</span>
<a href="#l47.135"></a><span id="l47.135" class="difflineminus">-&lt;!ENTITY detailsPane.more.accesskey &quot;r&quot;&gt;</span>
<a href="#l47.136"></a><span id="l47.136" class="difflineminus">-&lt;!ENTITY detailsPane.fewer.label &quot;Fewer&quot;&gt;</span>
<a href="#l47.137"></a><span id="l47.137" class="difflineminus">-&lt;!ENTITY detailsPane.fewer.accesskey &quot;r&quot;&gt;</span>
<a href="#l47.138"></a><span id="l47.138" class="difflineplus">+&lt;!ENTITY detailsPane.more.accesskey &quot;e&quot;&gt;</span>
<a href="#l47.139"></a><span id="l47.139" class="difflineplus">+&lt;!ENTITY detailsPane.less.label &quot;Less&quot;&gt;</span>
<a href="#l47.140"></a><span id="l47.140" class="difflineplus">+&lt;!ENTITY detailsPane.less.accesskey &quot;e&quot;&gt;</span>
<a href="#l47.141"></a><span id="l47.141"> &lt;!ENTITY detailsPane.selectAnItemText.description &quot;Select an item to view and edit its properties&quot;&gt;</span>
<a href="#l47.142"></a><span id="l47.142"> </span>
<a href="#l47.143"></a><span id="l47.143" class="difflineminus">-&lt;!ENTITY editBookmark.done.label &quot;Done&quot;&gt;</span>
<a href="#l47.144"></a><span id="l47.144" class="difflineminus">-&lt;!ENTITY editBookmark.cancel.label &quot;Cancel&quot;&gt;</span>
<a href="#l47.145"></a><span id="l47.145" class="difflineminus">-&lt;!ENTITY editBookmark.removeBookmark.accessKey &quot;R&quot;&gt;</span>
<a href="#l47.146"></a><span id="l47.146" class="difflineplus">+&lt;!ENTITY view.label               &quot;View&quot;&gt;</span>
<a href="#l47.147"></a><span id="l47.147" class="difflineplus">+&lt;!ENTITY view.accesskey           &quot;w&quot;&gt;</span>
<a href="#l47.148"></a><span id="l47.148" class="difflineplus">+&lt;!ENTITY byDate.label             &quot;By Date&quot;&gt;</span>
<a href="#l47.149"></a><span id="l47.149" class="difflineplus">+&lt;!ENTITY byDate.accesskey         &quot;D&quot;&gt;</span>
<a href="#l47.150"></a><span id="l47.150" class="difflineplus">+&lt;!ENTITY bySite.label             &quot;By Site&quot;&gt;</span>
<a href="#l47.151"></a><span id="l47.151" class="difflineplus">+&lt;!ENTITY bySite.accesskey         &quot;S&quot;&gt;</span>
<a href="#l47.152"></a><span id="l47.152" class="difflineplus">+&lt;!ENTITY byMostVisited.label      &quot;By Most Visited&quot;&gt;</span>
<a href="#l47.153"></a><span id="l47.153" class="difflineplus">+&lt;!ENTITY byMostVisited.accesskey  &quot;V&quot;&gt;</span>
<a href="#l47.154"></a><span id="l47.154" class="difflineplus">+&lt;!ENTITY byLastVisited.label      &quot;By Last Visited&quot;&gt;</span>
<a href="#l47.155"></a><span id="l47.155" class="difflineplus">+&lt;!ENTITY byLastVisited.accesskey  &quot;L&quot;&gt;</span>
<a href="#l47.156"></a><span id="l47.156" class="difflineplus">+&lt;!ENTITY byDayAndSite.label       &quot;By Date and Site&quot;&gt;</span>
<a href="#l47.157"></a><span id="l47.157" class="difflineplus">+&lt;!ENTITY byDayAndSite.accesskey   &quot;t&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l48.1"></a><span id="l48.1" class="difflineminus">--- a/suite/locales/en-US/chrome/common/places/places.properties</span>
<a href="#l48.2"></a><span id="l48.2" class="difflineplus">+++ b/suite/locales/en-US/chrome/common/places/places.properties</span>
<a href="#l48.3"></a><span id="l48.3" class="difflineat">@@ -1,78 +1,101 @@</span>
<a href="#l48.4"></a><span id="l48.4"> # This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l48.5"></a><span id="l48.5"> # License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l48.6"></a><span id="l48.6"> # file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l48.7"></a><span id="l48.7"> </span>
<a href="#l48.8"></a><span id="l48.8" class="difflineminus">-delete.hostname.true=Delete History for %S</span>
<a href="#l48.9"></a><span id="l48.9" class="difflineminus">-delete.hostname.false=Delete History for Website</span>
<a href="#l48.10"></a><span id="l48.10" class="difflineminus">-delete.hostname.accesskey=s</span>
<a href="#l48.11"></a><span id="l48.11" class="difflineminus">-delete.domain.true=Delete History for *.%S</span>
<a href="#l48.12"></a><span id="l48.12" class="difflineminus">-delete.domain.false=Delete History for Domain</span>
<a href="#l48.13"></a><span id="l48.13" class="difflineminus">-delete.domain.accesskey=H</span>
<a href="#l48.14"></a><span id="l48.14" class="difflineminus">-</span>
<a href="#l48.15"></a><span id="l48.15"> load-js-data-url-error=For security reasons, javascript or data urls cannot be loaded from the history window or sidebar.</span>
<a href="#l48.16"></a><span id="l48.16"> noTitle=(no title)</span>
<a href="#l48.17"></a><span id="l48.17"> </span>
<a href="#l48.18"></a><span id="l48.18"> bookmarksMenuEmptyFolder=(Empty)</span>
<a href="#l48.19"></a><span id="l48.19"> </span>
<a href="#l48.20"></a><span id="l48.20"> bookmarksBackupTitle=Bookmarks backup filename</span>
<a href="#l48.21"></a><span id="l48.21"> </span>
<a href="#l48.22"></a><span id="l48.22"> bookmarksRestoreAlertTitle=Revert Bookmarks</span>
<a href="#l48.23"></a><span id="l48.23"> bookmarksRestoreAlert=This will replace all of your current bookmarks with the backup. Are you sure?</span>
<a href="#l48.24"></a><span id="l48.24"> bookmarksRestoreTitle=Select a bookmarks backup</span>
<a href="#l48.25"></a><span id="l48.25"> bookmarksRestoreFilterName=JSON</span>
<a href="#l48.26"></a><span id="l48.26" class="difflineminus">-bookmarksRestoreFilterExtension=*.json;*.jsonlz4</span>
<a href="#l48.27"></a><span id="l48.27"> </span>
<a href="#l48.28"></a><span id="l48.28"> bookmarksRestoreFormatError=Unsupported file type.</span>
<a href="#l48.29"></a><span id="l48.29"> bookmarksRestoreParseError=Unable to process the backup file.</span>
<a href="#l48.30"></a><span id="l48.30"> </span>
<a href="#l48.31"></a><span id="l48.31"> bookmarksLivemarkLoading=Live Bookmark loading…</span>
<a href="#l48.32"></a><span id="l48.32"> bookmarksLivemarkFailed=Live Bookmark feed failed to load.</span>
<a href="#l48.33"></a><span id="l48.33"> </span>
<a href="#l48.34"></a><span id="l48.34" class="difflineminus">-menuOpenLivemarkOrigin.label=Open &quot;%S&quot;</span>
<a href="#l48.35"></a><span id="l48.35" class="difflineplus">+menuOpenLivemarkOrigin.label=Open “%S”</span>
<a href="#l48.36"></a><span id="l48.36"> </span>
<a href="#l48.37"></a><span id="l48.37" class="difflineminus">-view.sortBy.title.label=Sort by Name</span>
<a href="#l48.38"></a><span id="l48.38" class="difflineminus">-view.sortBy.title.accesskey=N</span>
<a href="#l48.39"></a><span id="l48.39" class="difflineminus">-view.sortBy.url.label=Sort by Location</span>
<a href="#l48.40"></a><span id="l48.40" class="difflineminus">-view.sortBy.url.accesskey=L</span>
<a href="#l48.41"></a><span id="l48.41" class="difflineminus">-view.sortBy.date.label=Sort by Visit Date</span>
<a href="#l48.42"></a><span id="l48.42" class="difflineminus">-view.sortBy.date.accesskey=V</span>
<a href="#l48.43"></a><span id="l48.43" class="difflineminus">-view.sortBy.visitCount.label=Sort by Visit Count</span>
<a href="#l48.44"></a><span id="l48.44" class="difflineminus">-view.sortBy.visitCount.accesskey=C</span>
<a href="#l48.45"></a><span id="l48.45" class="difflineminus">-view.sortBy.keyword.label=Sort by Keyword</span>
<a href="#l48.46"></a><span id="l48.46" class="difflineminus">-view.sortBy.keyword.accesskey=K</span>
<a href="#l48.47"></a><span id="l48.47" class="difflineminus">-view.sortBy.description.label=Sort by Description</span>
<a href="#l48.48"></a><span id="l48.48" class="difflineminus">-view.sortBy.description.accesskey=D</span>
<a href="#l48.49"></a><span id="l48.49" class="difflineminus">-view.sortBy.dateAdded.label=Sort by Added</span>
<a href="#l48.50"></a><span id="l48.50" class="difflineminus">-view.sortBy.dateAdded.accesskey=e</span>
<a href="#l48.51"></a><span id="l48.51" class="difflineminus">-view.sortBy.lastModified.label=Sort by Last Modified</span>
<a href="#l48.52"></a><span id="l48.52" class="difflineminus">-view.sortBy.lastModified.accesskey=M</span>
<a href="#l48.53"></a><span id="l48.53" class="difflineminus">-view.sortBy.tags.label=Sort by Tags</span>
<a href="#l48.54"></a><span id="l48.54" class="difflineminus">-view.sortBy.tags.accesskey=T</span>
<a href="#l48.55"></a><span id="l48.55" class="difflineplus">+sortByName=Sort ‘%S’ by Name</span>
<a href="#l48.56"></a><span id="l48.56" class="difflineplus">+sortByNameGeneric=Sort by Name</span>
<a href="#l48.57"></a><span id="l48.57" class="difflineplus">+# LOCALIZATION NOTE (view.sortBy.1.name.label): sortBy properties are versioned.</span>
<a href="#l48.58"></a><span id="l48.58" class="difflineplus">+# When any of these changes, all of the properties must be bumped, and the</span>
<a href="#l48.59"></a><span id="l48.59" class="difflineplus">+# change must be annotated here.  Both label and accesskey must be updated.</span>
<a href="#l48.60"></a><span id="l48.60" class="difflineplus">+# - version 1: changed view.sortBy.1.date.</span>
<a href="#l48.61"></a><span id="l48.61" class="difflineplus">+view.sortBy.1.name.label=Sort by Name</span>
<a href="#l48.62"></a><span id="l48.62" class="difflineplus">+view.sortBy.1.name.accesskey=N</span>
<a href="#l48.63"></a><span id="l48.63" class="difflineplus">+view.sortBy.1.url.label=Sort by Location</span>
<a href="#l48.64"></a><span id="l48.64" class="difflineplus">+view.sortBy.1.url.accesskey=L</span>
<a href="#l48.65"></a><span id="l48.65" class="difflineplus">+view.sortBy.1.date.label=Sort by Most Recent Visit</span>
<a href="#l48.66"></a><span id="l48.66" class="difflineplus">+view.sortBy.1.date.accesskey=V</span>
<a href="#l48.67"></a><span id="l48.67" class="difflineplus">+view.sortBy.1.visitCount.label=Sort by Visit Count</span>
<a href="#l48.68"></a><span id="l48.68" class="difflineplus">+view.sortBy.1.visitCount.accesskey=C</span>
<a href="#l48.69"></a><span id="l48.69" class="difflineplus">+view.sortBy.1.description.label=Sort by Description</span>
<a href="#l48.70"></a><span id="l48.70" class="difflineplus">+view.sortBy.1.description.accesskey=D</span>
<a href="#l48.71"></a><span id="l48.71" class="difflineplus">+view.sortBy.1.dateAdded.label=Sort by Added</span>
<a href="#l48.72"></a><span id="l48.72" class="difflineplus">+view.sortBy.1.dateAdded.accesskey=e</span>
<a href="#l48.73"></a><span id="l48.73" class="difflineplus">+view.sortBy.1.lastModified.label=Sort by Last Modified</span>
<a href="#l48.74"></a><span id="l48.74" class="difflineplus">+view.sortBy.1.lastModified.accesskey=M</span>
<a href="#l48.75"></a><span id="l48.75" class="difflineplus">+view.sortBy.1.tags.label=Sort by Tags</span>
<a href="#l48.76"></a><span id="l48.76" class="difflineplus">+view.sortBy.1.tags.accesskey=T</span>
<a href="#l48.77"></a><span id="l48.77"> </span>
<a href="#l48.78"></a><span id="l48.78"> searchBookmarks=Search Bookmarks</span>
<a href="#l48.79"></a><span id="l48.79" class="difflineminus">-searchCurrentDefault=Search in '%S'</span>
<a href="#l48.80"></a><span id="l48.80" class="difflineminus">-findInPrefix=Find in '%S'…</span>
<a href="#l48.81"></a><span id="l48.81" class="difflineplus">+searchHistory=Search History</span>
<a href="#l48.82"></a><span id="l48.82"> </span>
<a href="#l48.83"></a><span id="l48.83"> tabs.openWarningTitle=Confirm open</span>
<a href="#l48.84"></a><span id="l48.84"> tabs.openWarningMultipleBranded=You are about to open %S tabs.  This might slow down %S while the pages are loading.  Are you sure you want to continue?</span>
<a href="#l48.85"></a><span id="l48.85"> tabs.openButtonMultiple=Open tabs</span>
<a href="#l48.86"></a><span id="l48.86"> tabs.openWarningPromptMeBranded=Warn me when opening multiple tabs might slow down %S</span>
<a href="#l48.87"></a><span id="l48.87"> </span>
<a href="#l48.88"></a><span id="l48.88"> SelectImport=Import Bookmarks File</span>
<a href="#l48.89"></a><span id="l48.89"> EnterExport=Export Bookmarks File</span>
<a href="#l48.90"></a><span id="l48.90"> </span>
<a href="#l48.91"></a><span id="l48.91" class="difflineminus">-saveSearch.title=Save Search</span>
<a href="#l48.92"></a><span id="l48.92" class="difflineminus">-saveSearch.inputLabel=Name:</span>
<a href="#l48.93"></a><span id="l48.93" class="difflineminus">-saveSearch.inputDefaultText=New Search</span>
<a href="#l48.94"></a><span id="l48.94" class="difflineminus">-</span>
<a href="#l48.95"></a><span id="l48.95"> detailsPane.noItems=No items</span>
<a href="#l48.96"></a><span id="l48.96" class="difflineminus">-detailsPane.oneItem=One item</span>
<a href="#l48.97"></a><span id="l48.97" class="difflineminus">-detailsPane.multipleItems=%S items</span>
<a href="#l48.98"></a><span id="l48.98" class="difflineplus">+# LOCALIZATION NOTE (detailsPane.itemsCountLabel): Semicolon-separated list of plural forms.</span>
<a href="#l48.99"></a><span id="l48.99" class="difflineplus">+# See: http://developer.mozilla.org/en/docs/Localization_and_Plurals</span>
<a href="#l48.100"></a><span id="l48.100" class="difflineplus">+# #1 number of items</span>
<a href="#l48.101"></a><span id="l48.101" class="difflineplus">+# example: 111 items</span>
<a href="#l48.102"></a><span id="l48.102" class="difflineplus">+detailsPane.itemsCountLabel=One item;#1 items</span>
<a href="#l48.103"></a><span id="l48.103"> </span>
<a href="#l48.104"></a><span id="l48.104"> mostVisitedTitle=Most Visited</span>
<a href="#l48.105"></a><span id="l48.105"> recentlyBookmarkedTitle=Recently Bookmarked</span>
<a href="#l48.106"></a><span id="l48.106"> recentTagsTitle=Recent Tags</span>
<a href="#l48.107"></a><span id="l48.107"> </span>
<a href="#l48.108"></a><span id="l48.108"> OrganizerQueryHistory=History</span>
<a href="#l48.109"></a><span id="l48.109"> OrganizerQueryAllBookmarks=All Bookmarks</span>
<a href="#l48.110"></a><span id="l48.110"> OrganizerQueryTags=Tags</span>
<a href="#l48.111"></a><span id="l48.111" class="difflineplus">+</span>
<a href="#l48.112"></a><span id="l48.112" class="difflineplus">+# LOCALIZATION NOTE (tagResultLabel, bookmarkResultLabel, switchtabResultLabel,</span>
<a href="#l48.113"></a><span id="l48.113" class="difflineplus">+# keywordResultLabel, searchengineResultLabel)</span>
<a href="#l48.114"></a><span id="l48.114" class="difflineplus">+# Noun used to describe the location bar autocomplete result type</span>
<a href="#l48.115"></a><span id="l48.115" class="difflineplus">+# to users with screen readers</span>
<a href="#l48.116"></a><span id="l48.116" class="difflineplus">+# See createResultLabel() in urlbarBindings.xml</span>
<a href="#l48.117"></a><span id="l48.117" class="difflineplus">+tagResultLabel=Tag</span>
<a href="#l48.118"></a><span id="l48.118" class="difflineplus">+bookmarkResultLabel=Bookmark</span>
<a href="#l48.119"></a><span id="l48.119" class="difflineplus">+switchtabResultLabel=Tab</span>
<a href="#l48.120"></a><span id="l48.120" class="difflineplus">+keywordResultLabel=Keyword</span>
<a href="#l48.121"></a><span id="l48.121" class="difflineplus">+searchengineResultLabel=Search</span>
<a href="#l48.122"></a><span id="l48.122" class="difflineplus">+</span>
<a href="#l48.123"></a><span id="l48.123" class="difflineplus">+</span>
<a href="#l48.124"></a><span id="l48.124" class="difflineplus">+# LOCALIZATION NOTE (lockPrompt.text)</span>
<a href="#l48.125"></a><span id="l48.125" class="difflineplus">+# %S will be replaced with the application name.</span>
<a href="#l48.126"></a><span id="l48.126" class="difflineplus">+lockPrompt.title=Browser Startup Error</span>
<a href="#l48.127"></a><span id="l48.127" class="difflineplus">+lockPrompt.text=The bookmarks and history system will not be functional because one of %S’s files is in use by another application. Some security software can cause this problem.</span>
<a href="#l48.128"></a><span id="l48.128" class="difflineplus">+lockPromptInfoButton.label=Learn More</span>
<a href="#l48.129"></a><span id="l48.129" class="difflineplus">+lockPromptInfoButton.accessKey=L</span>
<a href="#l48.130"></a><span id="l48.130" class="difflineplus">+</span>
<a href="#l48.131"></a><span id="l48.131" class="difflineplus">+# LOCALIZATION NOTE (deletePagesLabel): Semi-colon list of plural forms.</span>
<a href="#l48.132"></a><span id="l48.132" class="difflineplus">+# See: http://developer.mozilla.org/en/docs/Localization_and_Plurals</span>
<a href="#l48.133"></a><span id="l48.133" class="difflineplus">+cmd.deletePages.label=Delete Page;Delete Pages</span>
<a href="#l48.134"></a><span id="l48.134" class="difflineplus">+cmd.deletePages.accesskey=D</span>
<a href="#l48.135"></a><span id="l48.135" class="difflineplus">+</span>
<a href="#l48.136"></a><span id="l48.136" class="difflineplus">+# LOCALIZATION NOTE (bookmarkPagesLabel): Semi-colon list of plural forms.</span>
<a href="#l48.137"></a><span id="l48.137" class="difflineplus">+# See: http://developer.mozilla.org/en/docs/Localization_and_Plurals</span>
<a href="#l48.138"></a><span id="l48.138" class="difflineplus">+cmd.bookmarkPages.label=Bookmark Page;Bookmark Pages</span>
<a href="#l48.139"></a><span id="l48.139" class="difflineplus">+cmd.bookmarkPages.accesskey=B</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l49.1"></a><span id="l49.1" class="difflineminus">--- a/suite/locales/jar.mn</span>
<a href="#l49.2"></a><span id="l49.2" class="difflineplus">+++ b/suite/locales/jar.mn</span>
<a href="#l49.3"></a><span id="l49.3" class="difflineat">@@ -54,20 +54,16 @@</span>
<a href="#l49.4"></a><span id="l49.4">   locale/@AB_CD@/communicator/utilityOverlay.properties                     (%chrome/common/utilityOverlay.properties)</span>
<a href="#l49.5"></a><span id="l49.5">   locale/@AB_CD@/communicator/viewApplyThemeOverlay.dtd                     (%chrome/common/viewApplyThemeOverlay.dtd)</span>
<a href="#l49.6"></a><span id="l49.6">   locale/@AB_CD@/communicator/viewApplyThemeOverlay.properties              (%chrome/common/viewApplyThemeOverlay.properties)</span>
<a href="#l49.7"></a><span id="l49.7">   locale/@AB_CD@/communicator/viewZoomOverlay.dtd                           (%chrome/common/viewZoomOverlay.dtd)</span>
<a href="#l49.8"></a><span id="l49.8">   locale/@AB_CD@/communicator/viewZoomOverlay.properties                    (%chrome/common/viewZoomOverlay.properties)</span>
<a href="#l49.9"></a><span id="l49.9">   locale/@AB_CD@/communicator/about.dtd                                     (%chrome/common/about.dtd)</span>
<a href="#l49.10"></a><span id="l49.10">   locale/@AB_CD@/communicator/aboutPrivateBrowsing.dtd                      (%chrome/common/aboutPrivateBrowsing.dtd)</span>
<a href="#l49.11"></a><span id="l49.11">   locale/@AB_CD@/communicator/aboutSessionRestore.dtd                       (%chrome/common/aboutSessionRestore.dtd)</span>
<a href="#l49.12"></a><span id="l49.12" class="difflineminus">-  locale/@AB_CD@/communicator/bookmarks/bm-props.properties                 (%chrome/common/bookmarks/bm-props.properties)</span>
<a href="#l49.13"></a><span id="l49.13" class="difflineminus">-  locale/@AB_CD@/communicator/bookmarks/editBookmarkOverlay.dtd             (%chrome/common/bookmarks/editBookmarkOverlay.dtd)</span>
<a href="#l49.14"></a><span id="l49.14" class="difflineminus">-  locale/@AB_CD@/communicator/bookmarks/moveBookmarks.dtd                   (%chrome/common/bookmarks/moveBookmarks.dtd)</span>
<a href="#l49.15"></a><span id="l49.15" class="difflineminus">-  locale/@AB_CD@/communicator/bookmarks/places.dtd                          (%chrome/common/bookmarks/places.dtd)</span>
<a href="#l49.16"></a><span id="l49.16">   locale/@AB_CD@/communicator/console/console.dtd                           (%chrome/common/console/console.dtd)</span>
<a href="#l49.17"></a><span id="l49.17">   locale/@AB_CD@/communicator/console/console.properties                    (%chrome/common/console/console.properties)</span>
<a href="#l49.18"></a><span id="l49.18">   locale/@AB_CD@/communicator/dataman/dataman.dtd                           (%chrome/common/dataman/dataman.dtd)</span>
<a href="#l49.19"></a><span id="l49.19">   locale/@AB_CD@/communicator/dataman/dataman.properties                    (%chrome/common/dataman/dataman.properties)</span>
<a href="#l49.20"></a><span id="l49.20">   locale/@AB_CD@/communicator/downloads/downloadmanager.dtd                 (%chrome/common/downloads/downloadmanager.dtd)</span>
<a href="#l49.21"></a><span id="l49.21">   locale/@AB_CD@/communicator/downloads/downloadmanager.properties          (%chrome/common/downloads/downloadmanager.properties)</span>
<a href="#l49.22"></a><span id="l49.22">   locale/@AB_CD@/communicator/downloads/progressDialog.dtd                  (%chrome/common/downloads/progressDialog.dtd)</span>
<a href="#l49.23"></a><span id="l49.23">   locale/@AB_CD@/communicator/help/cert_dialog_help.xhtml                   (%chrome/common/help/cert_dialog_help.xhtml)</span>
<a href="#l49.24"></a><span id="l49.24" class="difflineat">@@ -148,23 +144,25 @@</span>
<a href="#l49.25"></a><span id="l49.25">   locale/@AB_CD@/communicator/help/images/taskbar.png                       (%chrome/common/help/images/taskbar.png)</span>
<a href="#l49.26"></a><span id="l49.26">   locale/@AB_CD@/communicator/help/images/taskbar-ab.png                    (%chrome/common/help/images/taskbar-ab.png)</span>
<a href="#l49.27"></a><span id="l49.27">   locale/@AB_CD@/communicator/help/images/task_mail.png                     (%chrome/common/help/images/task_mail.png)</span>
<a href="#l49.28"></a><span id="l49.28">   locale/@AB_CD@/communicator/help/images/task_newmail.png                  (%chrome/common/help/images/task_newmail.png)</span>
<a href="#l49.29"></a><span id="l49.29">   locale/@AB_CD@/communicator/help/images/threadbutton.png                  (%chrome/common/help/images/threadbutton.png)</span>
<a href="#l49.30"></a><span id="l49.30">   locale/@AB_CD@/communicator/help/images/web-links.png                     (%chrome/common/help/images/web-links.png)</span>
<a href="#l49.31"></a><span id="l49.31">   locale/@AB_CD@/helpviewer/help.properties                                 (%chrome/common/helpviewer/help.properties)</span>
<a href="#l49.32"></a><span id="l49.32">   locale/@AB_CD@/helpviewer/help.dtd                                        (%chrome/common/helpviewer/help.dtd)</span>
<a href="#l49.33"></a><span id="l49.33" class="difflineminus">-  locale/@AB_CD@/communicator/history/history.dtd                           (%chrome/common/history/history.dtd)</span>
<a href="#l49.34"></a><span id="l49.34">   locale/@AB_CD@/communicator/migration/migration.dtd                       (%chrome/common/migration/migration.dtd)</span>
<a href="#l49.35"></a><span id="l49.35">   locale/@AB_CD@/communicator/migration/migration.properties                (%chrome/common/migration/migration.properties)</span>
<a href="#l49.36"></a><span id="l49.36">   locale/@AB_CD@/communicator/permissions/cookieViewer.properties           (%chrome/common/permissions/cookieViewer.properties)</span>
<a href="#l49.37"></a><span id="l49.37">   locale/@AB_CD@/communicator/permissions/cookieViewer.dtd                  (%chrome/common/permissions/cookieViewer.dtd)</span>
<a href="#l49.38"></a><span id="l49.38">   locale/@AB_CD@/communicator/permissions/permissionsManager.dtd            (%chrome/common/permissions/permissionsManager.dtd)</span>
<a href="#l49.39"></a><span id="l49.39">   locale/@AB_CD@/communicator/permissions/permissionsManager.properties     (%chrome/common/permissions/permissionsManager.properties)</span>
<a href="#l49.40"></a><span id="l49.40" class="difflineplus">+  locale/@AB_CD@/communicator/places/bookmarkProperties.properties          (%chrome/common/places/bookmarkProperties.properties)</span>
<a href="#l49.41"></a><span id="l49.41" class="difflineplus">+  locale/@AB_CD@/communicator/places/editBookmarkOverlay.dtd                (%chrome/common/places/editBookmarkOverlay.dtd)</span>
<a href="#l49.42"></a><span id="l49.42" class="difflineplus">+  locale/@AB_CD@/communicator/places/places.dtd                             (%chrome/common/places/places.dtd)</span>
<a href="#l49.43"></a><span id="l49.43">   locale/@AB_CD@/communicator/places/places.properties                      (%chrome/common/places/places.properties)</span>
<a href="#l49.44"></a><span id="l49.44">   locale/@AB_CD@/communicator/pref/prefutilities.dtd                        (%chrome/common/pref/prefutilities.dtd)</span>
<a href="#l49.45"></a><span id="l49.45">   locale/@AB_CD@/communicator/pref/prefutilities.properties                 (%chrome/common/pref/prefutilities.properties)</span>
<a href="#l49.46"></a><span id="l49.46">   locale/@AB_CD@/communicator/pref/preferences.dtd                          (%chrome/common/pref/preferences.dtd)</span>
<a href="#l49.47"></a><span id="l49.47">   locale/@AB_CD@/communicator/pref/pref-advanced.dtd                        (%chrome/common/pref/pref-advanced.dtd)</span>
<a href="#l49.48"></a><span id="l49.48">   locale/@AB_CD@/communicator/pref/pref-appearance.dtd                      (%chrome/common/pref/pref-appearance.dtd)</span>
<a href="#l49.49"></a><span id="l49.49">   locale/@AB_CD@/communicator/pref/pref-applications.dtd                    (%chrome/common/pref/pref-applications.dtd)</span>
<a href="#l49.50"></a><span id="l49.50">   locale/@AB_CD@/communicator/pref/pref-applications.properties             (%chrome/common/pref/pref-applications.properties)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l50.1"></a><span id="l50.1" class="difflineminus">--- a/suite/modules/moz.build</span>
<a href="#l50.2"></a><span id="l50.2" class="difflineplus">+++ b/suite/modules/moz.build</span>
<a href="#l50.3"></a><span id="l50.3" class="difflineat">@@ -2,17 +2,16 @@</span>
<a href="#l50.4"></a><span id="l50.4"> # This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l50.5"></a><span id="l50.5"> # License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l50.6"></a><span id="l50.6"> # file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l50.7"></a><span id="l50.7"> </span>
<a href="#l50.8"></a><span id="l50.8"> XPCSHELL_TESTS_MANIFESTS += ['test/unit/xpcshell.ini']</span>
<a href="#l50.9"></a><span id="l50.9"> </span>
<a href="#l50.10"></a><span id="l50.10"> EXTRA_JS_MODULES += [</span>
<a href="#l50.11"></a><span id="l50.11">     'DownloadTaskbarProgress.jsm',</span>
<a href="#l50.12"></a><span id="l50.12" class="difflineminus">-    'PlacesUIUtils.jsm',</span>
<a href="#l50.13"></a><span id="l50.13">     'RecentWindow.jsm',</span>
<a href="#l50.14"></a><span id="l50.14">     'Sanitizer.jsm',</span>
<a href="#l50.15"></a><span id="l50.15">     'WindowsPreviewPerTab.jsm',</span>
<a href="#l50.16"></a><span id="l50.16"> ]</span>
<a href="#l50.17"></a><span id="l50.17"> </span>
<a href="#l50.18"></a><span id="l50.18"> if CONFIG['OS_ARCH'] == 'WINNT':</span>
<a href="#l50.19"></a><span id="l50.19">     EXTRA_JS_MODULES += ['WindowsJumpLists.jsm']</span>
<a href="#l50.20"></a><span id="l50.20"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l51.1"></a><span id="l51.1" class="difflineminus">--- a/suite/themes/classic/communicator/aboutSessionRestore.css</span>
<a href="#l51.2"></a><span id="l51.2" class="difflineplus">+++ b/suite/themes/classic/communicator/aboutSessionRestore.css</span>
<a href="#l51.3"></a><span id="l51.3" class="difflineat">@@ -11,25 +11,25 @@ treechildren::-moz-tree-image(icon),</span>
<a href="#l51.4"></a><span id="l51.4"> treechildren::-moz-tree-image(noicon) {</span>
<a href="#l51.5"></a><span id="l51.5">   padding-right: 2px;</span>
<a href="#l51.6"></a><span id="l51.6">   margin: 0px 2px;</span>
<a href="#l51.7"></a><span id="l51.7">   width: 16px;</span>
<a href="#l51.8"></a><span id="l51.8">   height: 16px;</span>
<a href="#l51.9"></a><span id="l51.9"> }</span>
<a href="#l51.10"></a><span id="l51.10"> </span>
<a href="#l51.11"></a><span id="l51.11"> treechildren::-moz-tree-image(noicon) {</span>
<a href="#l51.12"></a><span id="l51.12" class="difflineminus">-  list-style-image: url(&quot;chrome://communicator/skin/bookmarks/bookmark-item.svg&quot;);</span>
<a href="#l51.13"></a><span id="l51.13" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/places/bookmark-item.svg&quot;);</span>
<a href="#l51.14"></a><span id="l51.14"> }</span>
<a href="#l51.15"></a><span id="l51.15"> </span>
<a href="#l51.16"></a><span id="l51.16"> treechildren::-moz-tree-image(container, noicon) {</span>
<a href="#l51.17"></a><span id="l51.17" class="difflineminus">-  list-style-image: url(&quot;chrome://communicator/skin/bookmarks/bookmark-folder-closed.png&quot;);</span>
<a href="#l51.18"></a><span id="l51.18" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/places/bookmark-folder-closed.png&quot;);</span>
<a href="#l51.19"></a><span id="l51.19"> }</span>
<a href="#l51.20"></a><span id="l51.20"> </span>
<a href="#l51.21"></a><span id="l51.21"> treechildren::-moz-tree-image(container, noicon, open) {</span>
<a href="#l51.22"></a><span id="l51.22" class="difflineminus">-  list-style-image: url(&quot;chrome://communicator/skin/bookmarks/bookmark-folder-open.png&quot;);</span>
<a href="#l51.23"></a><span id="l51.23" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/places/bookmark-folder-open.png&quot;);</span>
<a href="#l51.24"></a><span id="l51.24"> }</span>
<a href="#l51.25"></a><span id="l51.25"> </span>
<a href="#l51.26"></a><span id="l51.26"> treechildren::-moz-tree-checkbox(checked) {</span>
<a href="#l51.27"></a><span id="l51.27">   list-style-image: url(&quot;chrome://global/skin/checkbox/cbox-check.gif&quot;);</span>
<a href="#l51.28"></a><span id="l51.28"> }</span>
<a href="#l51.29"></a><span id="l51.29"> </span>
<a href="#l51.30"></a><span id="l51.30"> treechildren::-moz-tree-checkbox(partial) {</span>
<a href="#l51.31"></a><span id="l51.31">   list-style-image: url(&quot;chrome://global/skin/checkbox/cbox-check-dis.gif&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l52.1"></a><span id="l52.1" class="difflineminus">--- a/suite/themes/classic/communicator/communicator.css</span>
<a href="#l52.2"></a><span id="l52.2" class="difflineplus">+++ b/suite/themes/classic/communicator/communicator.css</span>
<a href="#l52.3"></a><span id="l52.3" class="difflineat">@@ -38,21 +38,21 @@ textbox:not(.padded) {</span>
<a href="#l52.4"></a><span id="l52.4"> </span>
<a href="#l52.5"></a><span id="l52.5"> textbox[autocompletesearch=&quot;history file&quot;] .autocomplete-treebody::-moz-tree-image(treecolAutoCompleteValue) {</span>
<a href="#l52.6"></a><span id="l52.6">   width: 16px;</span>
<a href="#l52.7"></a><span id="l52.7">   height: 16px;</span>
<a href="#l52.8"></a><span id="l52.8">   margin-left: 1px;</span>
<a href="#l52.9"></a><span id="l52.9"> }</span>
<a href="#l52.10"></a><span id="l52.10"> </span>
<a href="#l52.11"></a><span id="l52.11"> textbox[autocompletesearch=&quot;history file&quot;] .autocomplete-treebody::-moz-tree-image(treecolAutoCompleteValue, directory) {</span>
<a href="#l52.12"></a><span id="l52.12" class="difflineminus">-  list-style-image: url(&quot;chrome://communicator/skin/bookmarks/bookmark-folder-closed.png&quot;);</span>
<a href="#l52.13"></a><span id="l52.13" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/places/bookmark-folder-closed.png&quot;);</span>
<a href="#l52.14"></a><span id="l52.14"> }</span>
<a href="#l52.15"></a><span id="l52.15"> </span>
<a href="#l52.16"></a><span id="l52.16"> textbox[autocompletesearch=&quot;history file&quot;] .autocomplete-treebody::-moz-tree-image(treecolAutoCompleteValue, file) {</span>
<a href="#l52.17"></a><span id="l52.17" class="difflineminus">-  list-style-image: url(&quot;chrome://communicator/skin/bookmarks/bookmark-item.svg&quot;);</span>
<a href="#l52.18"></a><span id="l52.18" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/places/bookmark-item.svg&quot;);</span>
<a href="#l52.19"></a><span id="l52.19"> }</span>
<a href="#l52.20"></a><span id="l52.20"> </span>
<a href="#l52.21"></a><span id="l52.21"> /* ::::: online/offline icons ::::: */</span>
<a href="#l52.22"></a><span id="l52.22"> </span>
<a href="#l52.23"></a><span id="l52.23"> #offline-status[offline=&quot;true&quot;] {</span>
<a href="#l52.24"></a><span id="l52.24">   list-style-image: url(&quot;chrome://communicator/skin/icons/offline.png&quot;);</span>
<a href="#l52.25"></a><span id="l52.25"> }</span>
<a href="#l52.26"></a><span id="l52.26"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l53.1"></a><span id="l53.1" class="difflineminus">--- a/suite/themes/classic/communicator/places/bookmarks.css</span>
<a href="#l53.2"></a><span id="l53.2" class="difflineplus">+++ b/suite/themes/classic/communicator/places/bookmarks.css</span>
<a href="#l53.3"></a><span id="l53.3" class="difflineat">@@ -4,119 +4,118 @@</span>
<a href="#l53.4"></a><span id="l53.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l53.5"></a><span id="l53.5"> </span>
<a href="#l53.6"></a><span id="l53.6"> @namespace url(&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;);</span>
<a href="#l53.7"></a><span id="l53.7"> </span>
<a href="#l53.8"></a><span id="l53.8"> /**</span>
<a href="#l53.9"></a><span id="l53.9">  * Style rules for generic bookmarks items.</span>
<a href="#l53.10"></a><span id="l53.10">  */</span>
<a href="#l53.11"></a><span id="l53.11"> </span>
<a href="#l53.12"></a><span id="l53.12" class="difflineminus">-treechildren::-moz-tree-image(Name),</span>
<a href="#l53.13"></a><span id="l53.13"> treechildren::-moz-tree-image(title) {</span>
<a href="#l53.14"></a><span id="l53.14">   margin-inline-end: 2px;</span>
<a href="#l53.15"></a><span id="l53.15">   width: 16px;</span>
<a href="#l53.16"></a><span id="l53.16">   height: 16px;</span>
<a href="#l53.17"></a><span id="l53.17"> }</span>
<a href="#l53.18"></a><span id="l53.18"> </span>
<a href="#l53.19"></a><span id="l53.19"> .bookmark-item,</span>
<a href="#l53.20"></a><span id="l53.20" class="difflineminus">-treechildren::-moz-tree-image(Name),</span>
<a href="#l53.21"></a><span id="l53.21"> treechildren::-moz-tree-image(title) {</span>
<a href="#l53.22"></a><span id="l53.22" class="difflineminus">-  list-style-image: url(&quot;chrome://communicator/skin/bookmarks/bookmark-item.svg&quot;);</span>
<a href="#l53.23"></a><span id="l53.23" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/places/bookmark-item.svg&quot;);</span>
<a href="#l53.24"></a><span id="l53.24"> }</span>
<a href="#l53.25"></a><span id="l53.25"> </span>
<a href="#l53.26"></a><span id="l53.26"> .bookmark-item[container=&quot;true&quot;],</span>
<a href="#l53.27"></a><span id="l53.27" class="difflineminus">-treechildren::-moz-tree-image(Name, container),</span>
<a href="#l53.28"></a><span id="l53.28"> treechildren::-moz-tree-image(title, container) {</span>
<a href="#l53.29"></a><span id="l53.29" class="difflineminus">-  list-style-image: url(&quot;chrome://communicator/skin/bookmarks/bookmark-folder-closed.png&quot;);</span>
<a href="#l53.30"></a><span id="l53.30" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/places/bookmark-folder-closed.png&quot;);</span>
<a href="#l53.31"></a><span id="l53.31"> }</span>
<a href="#l53.32"></a><span id="l53.32"> </span>
<a href="#l53.33"></a><span id="l53.33"> .bookmark-item[open=&quot;true&quot;],</span>
<a href="#l53.34"></a><span id="l53.34" class="difflineminus">-treechildren::-moz-tree-image(Name, open),</span>
<a href="#l53.35"></a><span id="l53.35"> treechildren::-moz-tree-image(title, open) {</span>
<a href="#l53.36"></a><span id="l53.36" class="difflineminus">-  list-style-image: url(&quot;chrome://communicator/skin/bookmarks/bookmark-folder-open.png&quot;);</span>
<a href="#l53.37"></a><span id="l53.37" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/places/bookmark-folder-open.png&quot;);</span>
<a href="#l53.38"></a><span id="l53.38"> }</span>
<a href="#l53.39"></a><span id="l53.39"> </span>
<a href="#l53.40"></a><span id="l53.40"> .bookmark-item[container=&quot;true&quot;][open=&quot;true&quot;][loading=&quot;true&quot;] {</span>
<a href="#l53.41"></a><span id="l53.41">   list-style-image: url(&quot;chrome://communicator/skin/icons/loading.gif&quot;) !important;</span>
<a href="#l53.42"></a><span id="l53.42"> }</span>
<a href="#l53.43"></a><span id="l53.43"> </span>
<a href="#l53.44"></a><span id="l53.44"> .bookmark-item &gt; .toolbarbutton-box &gt; .toolbarbutton-icon {</span>
<a href="#l53.45"></a><span id="l53.45">   list-style-image: inherit;</span>
<a href="#l53.46"></a><span id="l53.46">   width: 16px;</span>
<a href="#l53.47"></a><span id="l53.47">   height: 16px;</span>
<a href="#l53.48"></a><span id="l53.48"> }</span>
<a href="#l53.49"></a><span id="l53.49"> </span>
<a href="#l53.50"></a><span id="l53.50" class="difflineminus">-/* calendar icon for history grouping items by day */</span>
<a href="#l53.51"></a><span id="l53.51" class="difflineminus">-treechildren::-moz-tree-image(Name, query, dayContainer) {</span>
<a href="#l53.52"></a><span id="l53.52" class="difflineminus">-  list-style-image: url(&quot;chrome://communicator/skin/history/calendar.png&quot;);</span>
<a href="#l53.53"></a><span id="l53.53" class="difflineminus">-}</span>
<a href="#l53.54"></a><span id="l53.54" class="difflineminus">-</span>
<a href="#l53.55"></a><span id="l53.55"> .bookmark-item[container][livemark],</span>
<a href="#l53.56"></a><span id="l53.56"> treechildren::-moz-tree-image(title, container, livemark) {</span>
<a href="#l53.57"></a><span id="l53.57" class="difflineminus">-  list-style-image: url(&quot;chrome://communicator/skin/bookmarks/livemark-folder.png&quot;);</span>
<a href="#l53.58"></a><span id="l53.58" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/places/livemark-folder.png&quot;);</span>
<a href="#l53.59"></a><span id="l53.59">   -moz-image-region: auto;</span>
<a href="#l53.60"></a><span id="l53.60"> }</span>
<a href="#l53.61"></a><span id="l53.61"> </span>
<a href="#l53.62"></a><span id="l53.62"> .bookmark-item[container][livemark] .bookmark-item,</span>
<a href="#l53.63"></a><span id="l53.63"> treechildren::-moz-tree-image(title, livemarkItem) {</span>
<a href="#l53.64"></a><span id="l53.64" class="difflineminus">-  list-style-image: url(&quot;chrome://communicator/skin/bookmarks/bookmark-item-updated.png&quot;);</span>
<a href="#l53.65"></a><span id="l53.65" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/places/bookmark-item-updated.png&quot;);</span>
<a href="#l53.66"></a><span id="l53.66"> }</span>
<a href="#l53.67"></a><span id="l53.67"> </span>
<a href="#l53.68"></a><span id="l53.68"> .bookmark-item[container][livemark] .bookmark-item[visited],</span>
<a href="#l53.69"></a><span id="l53.69"> treechildren::-moz-tree-image(title, livemarkItem, visited) {</span>
<a href="#l53.70"></a><span id="l53.70" class="difflineminus">-  list-style-image: url(&quot;chrome://communicator/skin/bookmarks/bookmark-item.svg&quot;);</span>
<a href="#l53.71"></a><span id="l53.71" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/places/bookmark-item.svg&quot;);</span>
<a href="#l53.72"></a><span id="l53.72"> }</span>
<a href="#l53.73"></a><span id="l53.73"> </span>
<a href="#l53.74"></a><span id="l53.74"> treechildren::-moz-tree-image(container, OrganizerQuery_AllBookmarks) {</span>
<a href="#l53.75"></a><span id="l53.75" class="difflineminus">-  list-style-image: url(&quot;chrome://communicator/skin/bookmarks/allBookmarks.png&quot;);</span>
<a href="#l53.76"></a><span id="l53.76" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/places/allBookmarks.png&quot;);</span>
<a href="#l53.77"></a><span id="l53.77">   -moz-image-region: auto;</span>
<a href="#l53.78"></a><span id="l53.78"> }</span>
<a href="#l53.79"></a><span id="l53.79"> </span>
<a href="#l53.80"></a><span id="l53.80"> #bookmarksToolbarFolderMenu,</span>
<a href="#l53.81"></a><span id="l53.81"> #BMB_bookmarksToolbarFolderMenu,</span>
<a href="#l53.82"></a><span id="l53.82"> treechildren::-moz-tree-image(container, OrganizerQuery_BookmarksToolbar) {</span>
<a href="#l53.83"></a><span id="l53.83" class="difflineminus">-  list-style-image: url(&quot;chrome://communicator/skin/bookmarks/bookmarksToolbar.png&quot;);</span>
<a href="#l53.84"></a><span id="l53.84" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/places/bookmarksToolbar.png&quot;);</span>
<a href="#l53.85"></a><span id="l53.85">   -moz-image-region: auto;</span>
<a href="#l53.86"></a><span id="l53.86"> }</span>
<a href="#l53.87"></a><span id="l53.87"> </span>
<a href="#l53.88"></a><span id="l53.88"> treechildren::-moz-tree-image(container, OrganizerQuery_BookmarksMenu) {</span>
<a href="#l53.89"></a><span id="l53.89" class="difflineminus">-  list-style-image: url(&quot;chrome://communicator/skin/bookmarks/bookmarksMenu.png&quot;);</span>
<a href="#l53.90"></a><span id="l53.90" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/places/bookmarksMenu.png&quot;);</span>
<a href="#l53.91"></a><span id="l53.91">   -moz-image-region: auto;</span>
<a href="#l53.92"></a><span id="l53.92"> }</span>
<a href="#l53.93"></a><span id="l53.93"> </span>
<a href="#l53.94"></a><span id="l53.94"> #unsortedBookmarksFolderMenu,</span>
<a href="#l53.95"></a><span id="l53.95"> #BMB_unsortedBookmarksFolderMenu,</span>
<a href="#l53.96"></a><span id="l53.96"> treechildren::-moz-tree-image(container, OrganizerQuery_UnfiledBookmarks) {</span>
<a href="#l53.97"></a><span id="l53.97" class="difflineminus">-  list-style-image: url(&quot;chrome://communicator/skin/bookmarks/unsortedBookmarks.png&quot;);</span>
<a href="#l53.98"></a><span id="l53.98" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/places/unsortedBookmarks.png&quot;);</span>
<a href="#l53.99"></a><span id="l53.99">   -moz-image-region: auto;</span>
<a href="#l53.100"></a><span id="l53.100"> }</span>
<a href="#l53.101"></a><span id="l53.101"> </span>
<a href="#l53.102"></a><span id="l53.102"> /* query-nodes should be styled even if they're not expandable */</span>
<a href="#l53.103"></a><span id="l53.103"> .bookmark-item[container][query],</span>
<a href="#l53.104"></a><span id="l53.104" class="difflineminus">-treechildren::-moz-tree-image(title, query) {</span>
<a href="#l53.105"></a><span id="l53.105" class="difflineminus">-  list-style-image: url(&quot;chrome://communicator/skin/bookmarks/query.png&quot;);</span>
<a href="#l53.106"></a><span id="l53.106" class="difflineplus">+treechildren::-moz-tree-image(query) {</span>
<a href="#l53.107"></a><span id="l53.107" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/places/query.png&quot;);</span>
<a href="#l53.108"></a><span id="l53.108">   -moz-image-region: auto;</span>
<a href="#l53.109"></a><span id="l53.109"> }</span>
<a href="#l53.110"></a><span id="l53.110"> </span>
<a href="#l53.111"></a><span id="l53.111"> .bookmark-item[query][tagContainer],</span>
<a href="#l53.112"></a><span id="l53.112"> treechildren::-moz-tree-image(title, query, tagContainer),</span>
<a href="#l53.113"></a><span id="l53.113"> treechildren::-moz-tree-image(query, OrganizerQuery_Tags) {</span>
<a href="#l53.114"></a><span id="l53.114" class="difflineminus">-  list-style-image: url(&quot;chrome://communicator/skin/bookmarks/tag.png&quot;);</span>
<a href="#l53.115"></a><span id="l53.115" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/places/tag.png&quot;);</span>
<a href="#l53.116"></a><span id="l53.116">   -moz-image-region: auto;</span>
<a href="#l53.117"></a><span id="l53.117"> }</span>
<a href="#l53.118"></a><span id="l53.118"> </span>
<a href="#l53.119"></a><span id="l53.119" class="difflineminus">-treechildren::-moz-tree-image(Name, separator),</span>
<a href="#l53.120"></a><span id="l53.120" class="difflineplus">+/* calendar icon for history grouping items by day */</span>
<a href="#l53.121"></a><span id="l53.121" class="difflineplus">+treechildren::-moz-tree-image(title, query, dayContainer) {</span>
<a href="#l53.122"></a><span id="l53.122" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/places/calendar.png&quot;);</span>
<a href="#l53.123"></a><span id="l53.123" class="difflineplus">+  -moz-image-region: auto;</span>
<a href="#l53.124"></a><span id="l53.124" class="difflineplus">+}</span>
<a href="#l53.125"></a><span id="l53.125" class="difflineplus">+</span>
<a href="#l53.126"></a><span id="l53.126" class="difflineplus">+treechildren::-moz-tree-image(query, OrganizerQuery_History) {</span>
<a href="#l53.127"></a><span id="l53.127" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/places/history.png&quot;);</span>
<a href="#l53.128"></a><span id="l53.128" class="difflineplus">+  -moz-image-region: auto;</span>
<a href="#l53.129"></a><span id="l53.129" class="difflineplus">+}</span>
<a href="#l53.130"></a><span id="l53.130" class="difflineplus">+</span>
<a href="#l53.131"></a><span id="l53.131"> treechildren::-moz-tree-image(title, separator) {</span>
<a href="#l53.132"></a><span id="l53.132">   list-style-image: none;</span>
<a href="#l53.133"></a><span id="l53.133">   width: 0px;</span>
<a href="#l53.134"></a><span id="l53.134">   height: 0px;</span>
<a href="#l53.135"></a><span id="l53.135"> }</span>
<a href="#l53.136"></a><span id="l53.136"> </span>
<a href="#l53.137"></a><span id="l53.137" class="difflineminus">-treechildren::-moz-tree-cell-text(Name, separator),</span>
<a href="#l53.138"></a><span id="l53.138"> treechildren::-moz-tree-cell-text(title, separator) {</span>
<a href="#l53.139"></a><span id="l53.139">   color: ThreeDShadow;</span>
<a href="#l53.140"></a><span id="l53.140">   margin: 0px 5px;</span>
<a href="#l53.141"></a><span id="l53.141"> }</span>
<a href="#l53.142"></a><span id="l53.142"> </span>
<a href="#l53.143"></a><span id="l53.143" class="difflineminus">-treechildren::-moz-tree-cell-text(Name, separator, selected, focus),</span>
<a href="#l53.144"></a><span id="l53.144"> treechildren::-moz-tree-cell-text(title, separator, selected, focus) {</span>
<a href="#l53.145"></a><span id="l53.145">   color: HighlightText;</span>
<a href="#l53.146"></a><span id="l53.146"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l54.1"></a><span id="l54.1" class="difflineminus">--- a/suite/themes/classic/communicator/places/bookmarksToolbar.css</span>
<a href="#l54.2"></a><span id="l54.2" class="difflineplus">+++ b/suite/themes/classic/communicator/places/bookmarksToolbar.css</span>
<a href="#l54.3"></a><span id="l54.3" class="difflineat">@@ -1,22 +1,22 @@</span>
<a href="#l54.4"></a><span id="l54.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l54.5"></a><span id="l54.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l54.6"></a><span id="l54.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l54.7"></a><span id="l54.7"> </span>
<a href="#l54.8"></a><span id="l54.8"> /* ===== bookmarksToolbar.css ===========================================</span>
<a href="#l54.9"></a><span id="l54.9">   == Styles specific to bookmark items in a toolbar.</span>
<a href="#l54.10"></a><span id="l54.10">   ======================================================================= */</span>
<a href="#l54.11"></a><span id="l54.11"> </span>
<a href="#l54.12"></a><span id="l54.12" class="difflineminus">-@import url(&quot;chrome://communicator/skin/bookmarks/bookmarks.css&quot;);</span>
<a href="#l54.13"></a><span id="l54.13" class="difflineplus">+@import url(&quot;chrome://communicator/skin/places/bookmarks.css&quot;);</span>
<a href="#l54.14"></a><span id="l54.14"> </span>
<a href="#l54.15"></a><span id="l54.15"> /* ::::: bookmark toolbar buttons ::::: */</span>
<a href="#l54.16"></a><span id="l54.16"> </span>
<a href="#l54.17"></a><span id="l54.17"> /* ..... bookmark items ..... */</span>
<a href="#l54.18"></a><span id="l54.18" class="difflineminus">- </span>
<a href="#l54.19"></a><span id="l54.19" class="difflineplus">+</span>
<a href="#l54.20"></a><span id="l54.20"> toolbarbutton.bookmark-item {</span>
<a href="#l54.21"></a><span id="l54.21">   min-width: 0px;</span>
<a href="#l54.22"></a><span id="l54.22">   max-width: 13em;</span>
<a href="#l54.23"></a><span id="l54.23"> }</span>
<a href="#l54.24"></a><span id="l54.24"> </span>
<a href="#l54.25"></a><span id="l54.25"> toolbarbutton.bookmark-item:not([container=&quot;true&quot;]) {</span>
<a href="#l54.26"></a><span id="l54.26">   -moz-appearance: none;</span>
<a href="#l54.27"></a><span id="l54.27"> }</span>
<a href="#l54.28"></a><span id="l54.28" class="difflineat">@@ -36,36 +36,36 @@ toolbarbutton.bookmark-item:not([contain</span>
<a href="#l54.29"></a><span id="l54.29">   -moz-border-top-colors: transparent !important;</span>
<a href="#l54.30"></a><span id="l54.30">   -moz-border-right-colors: transparent !important;</span>
<a href="#l54.31"></a><span id="l54.31">   -moz-border-bottom-colors: transparent !important;</span>
<a href="#l54.32"></a><span id="l54.32">   -moz-border-left-colors: transparent !important;</span>
<a href="#l54.33"></a><span id="l54.33">   background: transparent !important;</span>
<a href="#l54.34"></a><span id="l54.34"> }</span>
<a href="#l54.35"></a><span id="l54.35"> </span>
<a href="#l54.36"></a><span id="l54.36"> toolbarbutton.bookmark-item[disabled=&quot;true&quot;] {</span>
<a href="#l54.37"></a><span id="l54.37" class="difflineminus">-  list-style-image: url(&quot;chrome://communicator/skin/bookmarks/bookmark-item-dis.png&quot;) !important;</span>
<a href="#l54.38"></a><span id="l54.38" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/places/bookmark-item-dis.png&quot;) !important;</span>
<a href="#l54.39"></a><span id="l54.39"> }</span>
<a href="#l54.40"></a><span id="l54.40"> </span>
<a href="#l54.41"></a><span id="l54.41"> toolbarbutton.bookmark-item[disabled=&quot;true&quot;][container=&quot;true&quot;] {</span>
<a href="#l54.42"></a><span id="l54.42" class="difflineminus">-  list-style-image: url(&quot;chrome://communicator/skin/bookmarks/bookmark-folder-dis.png&quot;) !important;</span>
<a href="#l54.43"></a><span id="l54.43" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/places/bookmark-folder-dis.png&quot;) !important;</span>
<a href="#l54.44"></a><span id="l54.44"> }</span>
<a href="#l54.45"></a><span id="l54.45"> </span>
<a href="#l54.46"></a><span id="l54.46"> .bookmark-item &gt; .toolbarbutton-icon {</span>
<a href="#l54.47"></a><span id="l54.47">   width: 16px;</span>
<a href="#l54.48"></a><span id="l54.48">   height: 16px;</span>
<a href="#l54.49"></a><span id="l54.49"> }</span>
<a href="#l54.50"></a><span id="l54.50"> </span>
<a href="#l54.51"></a><span id="l54.51"> .bookmark-item &gt; .toolbarbutton-menu-dropmarker {</span>
<a href="#l54.52"></a><span id="l54.52">   display: none;</span>
<a href="#l54.53"></a><span id="l54.53"> }</span>
<a href="#l54.54"></a><span id="l54.54"> </span>
<a href="#l54.55"></a><span id="l54.55"> /* ..... drag and drop styles ..... */</span>
<a href="#l54.56"></a><span id="l54.56"> </span>
<a href="#l54.57"></a><span id="l54.57"> #PlacesToolbarDropIndicator {</span>
<a href="#l54.58"></a><span id="l54.58" class="difflineminus">-  list-style-image: url(&quot;chrome://communicator/skin/bookmarks/toolbarDropMarker.png&quot;);</span>
<a href="#l54.59"></a><span id="l54.59" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/places/toolbarDropMarker.png&quot;);</span>
<a href="#l54.60"></a><span id="l54.60"> }</span>
<a href="#l54.61"></a><span id="l54.61"> </span>
<a href="#l54.62"></a><span id="l54.62"> toolbarbutton.bookmark-item[dragover=&quot;true&quot;][open=&quot;true&quot;] {</span>
<a href="#l54.63"></a><span id="l54.63">   background: Highlight !important;</span>
<a href="#l54.64"></a><span id="l54.64">   color: HighlightText !important;</span>
<a href="#l54.65"></a><span id="l54.65"> }</span>
<a href="#l54.66"></a><span id="l54.66"> </span>
<a href="#l54.67"></a><span id="l54.67"> /* ::::: bookmark menus ::::: */</span>
<a href="#l54.68"></a><span id="l54.68" class="difflineat">@@ -77,21 +77,21 @@ menuitem.bookmark-item {</span>
<a href="#l54.69"></a><span id="l54.69"> }</span>
<a href="#l54.70"></a><span id="l54.70"> </span>
<a href="#l54.71"></a><span id="l54.71"> .bookmark-item &gt; .menu-iconic-left &gt; .menu-iconic-icon {</span>
<a href="#l54.72"></a><span id="l54.72">   width: 16px;</span>
<a href="#l54.73"></a><span id="l54.73">   height: 16px;</span>
<a href="#l54.74"></a><span id="l54.74"> }</span>
<a href="#l54.75"></a><span id="l54.75"> </span>
<a href="#l54.76"></a><span id="l54.76"> .menuitem-iconic.bookmark-item[disabled=&quot;true&quot;] {</span>
<a href="#l54.77"></a><span id="l54.77" class="difflineminus">-  list-style-image: url(&quot;chrome://communicator/skin/bookmarks/bookmark-item-dis.png&quot;);</span>
<a href="#l54.78"></a><span id="l54.78" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/places/bookmark-item-dis.png&quot;);</span>
<a href="#l54.79"></a><span id="l54.79"> }</span>
<a href="#l54.80"></a><span id="l54.80"> </span>
<a href="#l54.81"></a><span id="l54.81"> .menu-iconic.bookmark-item[disabled=&quot;true&quot;][container=&quot;true&quot;] {</span>
<a href="#l54.82"></a><span id="l54.82" class="difflineminus">-  list-style-image: url(&quot;chrome://communicator/skin/bookmarks/bookmark-folder-dis.png&quot;);</span>
<a href="#l54.83"></a><span id="l54.83" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/places/bookmark-folder-dis.png&quot;);</span>
<a href="#l54.84"></a><span id="l54.84"> }</span>
<a href="#l54.85"></a><span id="l54.85"> </span>
<a href="#l54.86"></a><span id="l54.86"> /* ..... drag and drop styles ..... */</span>
<a href="#l54.87"></a><span id="l54.87"> </span>
<a href="#l54.88"></a><span id="l54.88"> /* rules for menupopup drop indicators */</span>
<a href="#l54.89"></a><span id="l54.89"> .menupopup-drop-indicator-bar {</span>
<a href="#l54.90"></a><span id="l54.90">   position: relative;</span>
<a href="#l54.91"></a><span id="l54.91">   /* these two margins must together compensate the indicator's height */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l55.1"></a><span id="l55.1" class="difflineminus">--- a/suite/themes/classic/communicator/places/editBookmarkOverlay.css</span>
<a href="#l55.2"></a><span id="l55.2" class="difflineplus">+++ b/suite/themes/classic/communicator/places/editBookmarkOverlay.css</span>
<a href="#l55.3"></a><span id="l55.3" class="difflineat">@@ -62,23 +62,23 @@</span>
<a href="#l55.4"></a><span id="l55.4">   visibility: collapse;</span>
<a href="#l55.5"></a><span id="l55.5"> }</span>
<a href="#l55.6"></a><span id="l55.6"> </span>
<a href="#l55.7"></a><span id="l55.7"> </span>
<a href="#l55.8"></a><span id="l55.8"> /* ::::: bookmark panel dropdown icons ::::: */</span>
<a href="#l55.9"></a><span id="l55.9"> </span>
<a href="#l55.10"></a><span id="l55.10"> #editBMPanel_folderMenuList[selectedIndex=&quot;0&quot;],</span>
<a href="#l55.11"></a><span id="l55.11"> #editBMPanel_toolbarFolderItem {</span>
<a href="#l55.12"></a><span id="l55.12" class="difflineminus">-  list-style-image: url(&quot;chrome://communicator/skin/bookmarks/bookmarksToolbar.png&quot;) !important;</span>
<a href="#l55.13"></a><span id="l55.13" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/places/bookmarksToolbar.png&quot;) !important;</span>
<a href="#l55.14"></a><span id="l55.14">   -moz-image-region: auto !important;</span>
<a href="#l55.15"></a><span id="l55.15"> }</span>
<a href="#l55.16"></a><span id="l55.16"> </span>
<a href="#l55.17"></a><span id="l55.17"> #editBMPanel_folderMenuList[selectedIndex=&quot;1&quot;],</span>
<a href="#l55.18"></a><span id="l55.18"> #editBMPanel_bmRootItem {</span>
<a href="#l55.19"></a><span id="l55.19" class="difflineminus">-  list-style-image: url(&quot;chrome://communicator/skin/bookmarks/bookmarksMenu.png&quot;) !important;</span>
<a href="#l55.20"></a><span id="l55.20" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/places/bookmarksMenu.png&quot;) !important;</span>
<a href="#l55.21"></a><span id="l55.21">   -moz-image-region: auto !important;</span>
<a href="#l55.22"></a><span id="l55.22"> }</span>
<a href="#l55.23"></a><span id="l55.23"> </span>
<a href="#l55.24"></a><span id="l55.24"> #editBMPanel_folderMenuList[selectedIndex=&quot;2&quot;],</span>
<a href="#l55.25"></a><span id="l55.25"> #editBMPanel_unfiledRootItem {</span>
<a href="#l55.26"></a><span id="l55.26" class="difflineminus">-  list-style-image: url(&quot;chrome://communicator/skin/bookmarks/unsortedBookmarks.png&quot;) !important;</span>
<a href="#l55.27"></a><span id="l55.27" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/places/unsortedBookmarks.png&quot;) !important;</span>
<a href="#l55.28"></a><span id="l55.28">   -moz-image-region: auto !important;</span>
<a href="#l55.29"></a><span id="l55.29"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l56.1"></a><span id="l56.1">new file mode 100644</span>
<a href="#l56.2"></a><span id="l56.2">index e69de29bb2d1d6434b8b29ae775ad8c2e48c5391..fcc89bbbf0b6d30d0f33c6dc209b4ff172fe908e</span>
<a href="#l56.3"></a><span id="l56.3">GIT binary patch
literal 821
zc$@(&gt;1Iqk~P)&lt;h;3K|Lk000e1NJLTq000mG000mO1^@s6AM^iV0008~Nkl&lt;Zc-m!C
z-%Aux6#nj=ot+uob=-ArlZvuMGb^B=iYg!|=q-wXUV@5%DuRmgy_X=PdefJ{e?S5w
z0;HEnqBN2!k|@c&lt;64F)ohwjYWxpz8qaee8)+{&gt;MF&amp;v(xE-E&amp;wJMX1|@$Nh#&lt;(UFD*
z=X5&amp;NxX-q&amp;LhScEf3i|t9`!u$DP!#Qotsx=J!TEy{=&gt;euWYX+u-?HgKQ#$1eAt2Q%
zINjmgK&amp;4VG&amp;HR}iAYX6Kt*f(j03Do8H}-Gq*m_b*2|&lt;BwO9pAn#ELHv$Owz`3*agS
zV)*%MdZ&lt;&gt;bU5P=AMmKMmrg?YA_Kx#@AkdI;v2*t&gt;tY4qUy?c+a|JVs^-qMC#J`bXS
zYPo`p&gt;vomOWn&lt;*c=u1wV54UgLcu7iyRJIx2JGa9y4AgC6{5^zFP!Yqn?k=RWEfAr^
zy4H1&lt;sQSa41UuupO{qXBbaZt&lt;5v7p8B%NbZGDHmS2O$M2bar(@G7iUfQpsfU3@5es
z3MxI5%Ysv8Nqng)$W?K9!i@iEL6&gt;U+j$@KOEr&gt;&lt;7EqgDwEvpbxHZzLFQ-mI^1;qAh
z_yw53G^mIaY%&gt;8vhT2cs6}Y}e%WA^a@`(nOo6EVFo|?jkcjEwKVDyn`Kk?Tw32Kf&gt;
zk|5_r91%H`&amp;=nA8iHp~+W6yz47=Hc?D&gt;Wa74(`_g0$gVlp_t_KG-Gj-EY1}X`ck8k
z%DR$TEkx&amp;zZX7y#9Lwb;&lt;eM9?RPwM?ENZ&lt;d`532Vuu`p7Ir0DT?K@0^!y=wUS8GDA
zqBEa6dkVgg`1tuNIB5_Bel-lmASYfUGrwn_(2k|Kc}#qn0HdJRjDtenMSE)#TALlr
zmsT+Hb{ysTIdI0YuuzO+MszFpKI&amp;_89H)QNh7BhLWs#hrDVrs=C6rPKV4$&gt;61PenL
zM0c+EcgXiW-OBZ0(jbXMqK7){f@9lm5D1W_T5Se^a}Lk&lt;ON)!e0jXp!O{5;C|Hhfl
zM=Z-aZ6&amp;RJiG*1Ipw;$0Z&lt;KaD&amp;bMz|UK{6sU6Z&gt;976_6w00000NkvXXu0mjfRQ7?;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l57.1"></a><span id="l57.1" class="difflineminus">--- a/suite/themes/classic/communicator/places/organizer.css</span>
<a href="#l57.2"></a><span id="l57.2" class="difflineplus">+++ b/suite/themes/classic/communicator/places/organizer.css</span>
<a href="#l57.3"></a><span id="l57.3" class="difflineat">@@ -1,13 +1,12 @@</span>
<a href="#l57.4"></a><span id="l57.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l57.5"></a><span id="l57.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l57.6"></a><span id="l57.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l57.7"></a><span id="l57.7"> </span>
<a href="#l57.8"></a><span id="l57.8" class="difflineminus">-</span>
<a href="#l57.9"></a><span id="l57.9"> /* Info box */</span>
<a href="#l57.10"></a><span id="l57.10"> #detailsDeck {</span>
<a href="#l57.11"></a><span id="l57.11">   margin: 5px;</span>
<a href="#l57.12"></a><span id="l57.12"> }</span>
<a href="#l57.13"></a><span id="l57.13"> </span>
<a href="#l57.14"></a><span id="l57.14"> #infoBoxExpanderLabel {</span>
<a href="#l57.15"></a><span id="l57.15">   padding-inline-start: 2px;</span>
<a href="#l57.16"></a><span id="l57.16"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l58.1"></a><span id="l58.1" class="difflineminus">--- a/suite/themes/classic/communicator/sidebar/customize.css</span>
<a href="#l58.2"></a><span id="l58.2" class="difflineplus">+++ b/suite/themes/classic/communicator/sidebar/customize.css</span>
<a href="#l58.3"></a><span id="l58.3" class="difflineat">@@ -2,37 +2,37 @@</span>
<a href="#l58.4"></a><span id="l58.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l58.5"></a><span id="l58.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l58.6"></a><span id="l58.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l58.7"></a><span id="l58.7"> </span>
<a href="#l58.8"></a><span id="l58.8"> @namespace url(&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;);</span>
<a href="#l58.9"></a><span id="l58.9"> </span>
<a href="#l58.10"></a><span id="l58.10"> .treecell-panel</span>
<a href="#l58.11"></a><span id="l58.11"> {</span>
<a href="#l58.12"></a><span id="l58.12" class="difflineminus">- list-style-image: url(&quot;chrome://communicator/skin/bookmarks/bookmark-item.svg&quot;);</span>
<a href="#l58.13"></a><span id="l58.13" class="difflineplus">+ list-style-image: url(&quot;chrome://communicator/skin/places/bookmark-item.svg&quot;);</span>
<a href="#l58.14"></a><span id="l58.14"> }</span>
<a href="#l58.15"></a><span id="l58.15"> </span>
<a href="#l58.16"></a><span id="l58.16"> .treecell-panel[haslink=&quot;true&quot;],</span>
<a href="#l58.17"></a><span id="l58.17"> treeitem[container=&quot;true&quot;] &gt; treerow &gt; .treecell-panel</span>
<a href="#l58.18"></a><span id="l58.18"> {</span>
<a href="#l58.19"></a><span id="l58.19" class="difflineminus">- list-style-image: url(&quot;chrome://communicator/skin/bookmarks/bookmark-folder-closed.gif&quot;);</span>
<a href="#l58.20"></a><span id="l58.20" class="difflineplus">+ list-style-image: url(&quot;chrome://communicator/skin/places/bookmark-folder-closed.gif&quot;);</span>
<a href="#l58.21"></a><span id="l58.21"> }</span>
<a href="#l58.22"></a><span id="l58.22"> treeitem[selected=&quot;true&quot;] &gt; treerow &gt; .treecell-panel[haslink=&quot;true&quot;],</span>
<a href="#l58.23"></a><span id="l58.23"> treeitem[selected=&quot;true&quot;][container=&quot;true&quot;] &gt; treerow &gt; .treecell-panel</span>
<a href="#l58.24"></a><span id="l58.24"> {</span>
<a href="#l58.25"></a><span id="l58.25" class="difflineminus">- list-style-image: url(&quot;chrome://communicator/skin/bookmarks/bookmark-folder-closed-sel.gif&quot;);</span>
<a href="#l58.26"></a><span id="l58.26" class="difflineplus">+ list-style-image: url(&quot;chrome://communicator/skin/places/bookmark-folder-closed-sel.gif&quot;);</span>
<a href="#l58.27"></a><span id="l58.27"> }</span>
<a href="#l58.28"></a><span id="l58.28"> </span>
<a href="#l58.29"></a><span id="l58.29"> treeitem[container=&quot;true&quot;][open=&quot;true&quot;] &gt; treerow &gt; .treecell-panel</span>
<a href="#l58.30"></a><span id="l58.30"> {</span>
<a href="#l58.31"></a><span id="l58.31" class="difflineminus">- list-style-image: url(&quot;chrome://communicator/skin/bookmarks/bookmark-folder-open.gif&quot;);</span>
<a href="#l58.32"></a><span id="l58.32" class="difflineplus">+ list-style-image: url(&quot;chrome://communicator/skin/places/bookmark-folder-open.gif&quot;);</span>
<a href="#l58.33"></a><span id="l58.33"> }</span>
<a href="#l58.34"></a><span id="l58.34"> treeitem[selected=&quot;true&quot;][container=&quot;true&quot;][open=&quot;true&quot;] &gt; treerow &gt; .treecell-panel</span>
<a href="#l58.35"></a><span id="l58.35"> {</span>
<a href="#l58.36"></a><span id="l58.36" class="difflineminus">- list-style-image: url(&quot;chrome://communicator/skin/bookmarks/bookmark-folder-open-sel.gif&quot;);</span>
<a href="#l58.37"></a><span id="l58.37" class="difflineplus">+ list-style-image: url(&quot;chrome://communicator/skin/places/bookmark-folder-open-sel.gif&quot;);</span>
<a href="#l58.38"></a><span id="l58.38"> }</span>
<a href="#l58.39"></a><span id="l58.39"> </span>
<a href="#l58.40"></a><span id="l58.40"> #header {</span>
<a href="#l58.41"></a><span id="l58.41">   list-style-image: url(&quot;chrome://communicator/skin/sidebar/sidebar-icon.gif&quot;);</span>
<a href="#l58.42"></a><span id="l58.42"> }</span>
<a href="#l58.43"></a><span id="l58.43"> </span>
<a href="#l58.44"></a><span id="l58.44"> box#reorder {</span>
<a href="#l58.45"></a><span id="l58.45">   -moz-box-pack: center;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l59.1"></a><span id="l59.1" class="difflineminus">--- a/suite/themes/classic/jar.mn</span>
<a href="#l59.2"></a><span id="l59.2" class="difflineplus">+++ b/suite/themes/classic/jar.mn</span>
<a href="#l59.3"></a><span id="l59.3" class="difflineat">@@ -19,35 +19,35 @@ classic.jar:</span>
<a href="#l59.4"></a><span id="l59.4">   skin/classic/communicator/button.css                                  (mac/communicator/button.css)</span>
<a href="#l59.5"></a><span id="l59.5">   skin/classic/communicator/communicator.css                            (mac/communicator/communicator.css)</span>
<a href="#l59.6"></a><span id="l59.6">   skin/classic/communicator/customizeToolbar.css                        (mac/communicator/customizeToolbar.css)</span>
<a href="#l59.7"></a><span id="l59.7">   skin/classic/communicator/config.css                                  (mac/communicator/config.css)</span>
<a href="#l59.8"></a><span id="l59.8">   skin/classic/communicator/datetimepicker.css                          (mac/communicator/datetimepicker.css)</span>
<a href="#l59.9"></a><span id="l59.9">   skin/classic/communicator/preferences.css                             (mac/communicator/preferences.css)</span>
<a href="#l59.10"></a><span id="l59.10">   skin/classic/communicator/toolbar.css                                 (mac/communicator/toolbar.css)</span>
<a href="#l59.11"></a><span id="l59.11">   skin/classic/communicator/viewSourceOverlay.css                       (mac/communicator/viewSourceOverlay.css)</span>
<a href="#l59.12"></a><span id="l59.12" class="difflineminus">-  skin/classic/communicator/bookmarks/bookmarks.css                     (mac/communicator/bookmarks/bookmarks.css)</span>
<a href="#l59.13"></a><span id="l59.13" class="difflineminus">-  skin/classic/communicator/bookmarks/bookmarksManager.css              (mac/communicator/bookmarks/bookmarksManager.css)</span>
<a href="#l59.14"></a><span id="l59.14" class="difflineminus">-  skin/classic/communicator/bookmarks/bookmarksMenu.png                 (mac/communicator/bookmarks/bookmarksMenu.png)</span>
<a href="#l59.15"></a><span id="l59.15" class="difflineminus">-  skin/classic/communicator/bookmarks/bookmarksToolbar.css              (mac/communicator/bookmarks/bookmarksToolbar.css)</span>
<a href="#l59.16"></a><span id="l59.16" class="difflineminus">-  skin/classic/communicator/bookmarks/bookmarksToolbar.png              (mac/communicator/bookmarks/bookmarksToolbar.png)</span>
<a href="#l59.17"></a><span id="l59.17" class="difflineminus">-  skin/classic/communicator/bookmarks/editBookmarkOverlay.css           (mac/communicator/bookmarks/editBookmarkOverlay.css)</span>
<a href="#l59.18"></a><span id="l59.18" class="difflineminus">-  skin/classic/communicator/bookmarks/filters.svg                       (mac/communicator/bookmarks/filters.svg)</span>
<a href="#l59.19"></a><span id="l59.19" class="difflineminus">-  skin/classic/communicator/bookmarks/livemark-folder.png               (mac/communicator/bookmarks/livemark-folder.png)</span>
<a href="#l59.20"></a><span id="l59.20" class="difflineminus">-  skin/classic/communicator/bookmarks/query.png                         (mac/communicator/bookmarks/query.png)</span>
<a href="#l59.21"></a><span id="l59.21" class="difflineminus">-  skin/classic/communicator/bookmarks/tag.png                           (mac/communicator/bookmarks/tag.png)</span>
<a href="#l59.22"></a><span id="l59.22" class="difflineminus">-  skin/classic/communicator/bookmarks/toolbarDropMarker.png             (mac/communicator/bookmarks/toolbarDropMarker.png)</span>
<a href="#l59.23"></a><span id="l59.23">   skin/classic/communicator/console/console-error-caret.gif             (mac/communicator/console/console-error-caret.gif)</span>
<a href="#l59.24"></a><span id="l59.24">   skin/classic/communicator/console/console-error-dash.gif              (mac/communicator/console/console-error-dash.gif)</span>
<a href="#l59.25"></a><span id="l59.25">   skin/classic/communicator/console/console.css                         (mac/communicator/console/console.css)</span>
<a href="#l59.26"></a><span id="l59.26">   skin/classic/communicator/downloads/downloadButtons.png               (mac/communicator/downloads/downloadButtons.png)</span>
<a href="#l59.27"></a><span id="l59.27">   skin/classic/communicator/downloads/progressBg.png                    (mac/communicator/downloads/progressBg.png)</span>
<a href="#l59.28"></a><span id="l59.28">   skin/classic/communicator/downloads/downloadmanager.css               (mac/communicator/downloads/downloadmanager.css)</span>
<a href="#l59.29"></a><span id="l59.29">   skin/classic/communicator/helpviewer/dropmark-nav.png                 (mac/communicator/helpviewer/dropmark-nav.png)</span>
<a href="#l59.30"></a><span id="l59.30">   skin/classic/communicator/helpviewer/help.css                         (mac/communicator/helpviewer/help.css)</span>
<a href="#l59.31"></a><span id="l59.31" class="difflineplus">+  skin/classic/communicator/places/bookmarks.css                        (mac/communicator/places/bookmarks.css)</span>
<a href="#l59.32"></a><span id="l59.32" class="difflineplus">+  skin/classic/communicator/places/bookmarksMenu.png                    (mac/communicator/places/bookmarksMenu.png)</span>
<a href="#l59.33"></a><span id="l59.33" class="difflineplus">+  skin/classic/communicator/places/bookmarksToolbar.css                 (mac/communicator/places/bookmarksToolbar.css)</span>
<a href="#l59.34"></a><span id="l59.34" class="difflineplus">+  skin/classic/communicator/places/bookmarksToolbar.png                 (mac/communicator/places/bookmarksToolbar.png)</span>
<a href="#l59.35"></a><span id="l59.35" class="difflineplus">+  skin/classic/communicator/places/editBookmarkOverlay.css              (mac/communicator/places/editBookmarkOverlay.css)</span>
<a href="#l59.36"></a><span id="l59.36" class="difflineplus">+  skin/classic/communicator/places/filters.svg                          (mac/communicator/places/filters.svg)</span>
<a href="#l59.37"></a><span id="l59.37" class="difflineplus">+  skin/classic/communicator/places/livemark-folder.png                  (mac/communicator/places/livemark-folder.png)</span>
<a href="#l59.38"></a><span id="l59.38" class="difflineplus">+  skin/classic/communicator/places/places.css                           (mac/communicator/places/places.css)</span>
<a href="#l59.39"></a><span id="l59.39" class="difflineplus">+  skin/classic/communicator/places/query.png                            (mac/communicator/places/query.png)</span>
<a href="#l59.40"></a><span id="l59.40" class="difflineplus">+  skin/classic/communicator/places/tag.png                              (mac/communicator/places/tag.png)</span>
<a href="#l59.41"></a><span id="l59.41" class="difflineplus">+  skin/classic/communicator/places/toolbarDropMarker.png                (mac/communicator/places/toolbarDropMarker.png)</span>
<a href="#l59.42"></a><span id="l59.42">   skin/classic/communicator/profile/profile.css                         (mac/communicator/profile/profile.css)</span>
<a href="#l59.43"></a><span id="l59.43">   skin/classic/communicator/search/searchbar.css                        (mac/communicator/search/searchbar.css)</span>
<a href="#l59.44"></a><span id="l59.44">   skin/classic/communicator/search/searchbar-dropmarker.png             (mac/communicator/search/searchbar-dropmarker.png)</span>
<a href="#l59.45"></a><span id="l59.45">   skin/classic/communicator/search/searchbar-search.png                 (mac/communicator/search/searchbar-search.png)</span>
<a href="#l59.46"></a><span id="l59.46">   skin/classic/communicator/sidebar/sidebar.css                         (mac/communicator/sidebar/sidebar.css)</span>
<a href="#l59.47"></a><span id="l59.47">   skin/classic/communicator/icons/autocomplete-dropmarker.png           (mac/communicator/icons/autocomplete-dropmarker.png)</span>
<a href="#l59.48"></a><span id="l59.48">   skin/classic/communicator/icons/communicatoricons.png                 (mac/communicator/icons/communicatoricons.png)</span>
<a href="#l59.49"></a><span id="l59.49">   skin/classic/communicator/icons/communicatoricons-small.png           (mac/communicator/icons/communicatoricons-small.png)</span>
<a href="#l59.50"></a><span id="l59.50" class="difflineat">@@ -75,38 +75,38 @@ classic.jar:</span>
<a href="#l59.51"></a><span id="l59.51">   skin/classic/communicator/preferences.css                             (linux/communicator/preferences.css)</span>
<a href="#l59.52"></a><span id="l59.52">   skin/classic/communicator/scrollbars.css                              (linux/communicator/scrollbars.css)</span>
<a href="#l59.53"></a><span id="l59.53"> #else</span>
<a href="#l59.54"></a><span id="l59.54">   skin/classic/communicator/communicator.css                            (communicator/communicator.css)</span>
<a href="#l59.55"></a><span id="l59.55">   skin/classic/communicator/preferences.css                             (communicator/preferences.css)</span>
<a href="#l59.56"></a><span id="l59.56"> #endif</span>
<a href="#l59.57"></a><span id="l59.57">   skin/classic/communicator/toolbar.css                                 (communicator/toolbar.css)</span>
<a href="#l59.58"></a><span id="l59.58">   skin/classic/communicator/viewSourceOverlay.css                       (communicator/viewSourceOverlay.css)</span>
<a href="#l59.59"></a><span id="l59.59" class="difflineminus">-  skin/classic/communicator/bookmarks/bookmark-folder-closed.png        (communicator/bookmarks/bookmark-folder-closed.png)</span>
<a href="#l59.60"></a><span id="l59.60" class="difflineminus">-  skin/classic/communicator/bookmarks/bookmark-folder-dis.png           (communicator/bookmarks/bookmark-folder-dis.png)</span>
<a href="#l59.61"></a><span id="l59.61" class="difflineminus">-  skin/classic/communicator/bookmarks/bookmark-folder-open.png          (communicator/bookmarks/bookmark-folder-open.png)</span>
<a href="#l59.62"></a><span id="l59.62" class="difflineminus">-  skin/classic/communicator/bookmarks/bookmarks.css                     (communicator/bookmarks/bookmarks.css)</span>
<a href="#l59.63"></a><span id="l59.63" class="difflineminus">-  skin/classic/communicator/bookmarks/bookmarksManager.css              (communicator/bookmarks/bookmarksManager.css)</span>
<a href="#l59.64"></a><span id="l59.64" class="difflineminus">-  skin/classic/communicator/bookmarks/bookmarksMenu.png                 (communicator/bookmarks/bookmarksMenu.png)</span>
<a href="#l59.65"></a><span id="l59.65" class="difflineminus">-  skin/classic/communicator/bookmarks/bookmarksToolbar.css              (communicator/bookmarks/bookmarksToolbar.css)</span>
<a href="#l59.66"></a><span id="l59.66" class="difflineminus">-  skin/classic/communicator/bookmarks/bookmarksToolbar.png              (communicator/bookmarks/bookmarksToolbar.png)</span>
<a href="#l59.67"></a><span id="l59.67" class="difflineminus">-  skin/classic/communicator/bookmarks/editBookmarkOverlay.css           (communicator/bookmarks/editBookmarkOverlay.css)</span>
<a href="#l59.68"></a><span id="l59.68" class="difflineminus">-  skin/classic/communicator/bookmarks/livemark-folder.png               (communicator/bookmarks/livemark-folder.png)</span>
<a href="#l59.69"></a><span id="l59.69" class="difflineminus">-  skin/classic/communicator/bookmarks/query.png                         (communicator/bookmarks/query.png)</span>
<a href="#l59.70"></a><span id="l59.70" class="difflineminus">-  skin/classic/communicator/bookmarks/tag.png                           (communicator/bookmarks/tag.png)</span>
<a href="#l59.71"></a><span id="l59.71" class="difflineminus">-  skin/classic/communicator/bookmarks/toolbarDropMarker.png             (communicator/bookmarks/toolbarDropMarker.png)</span>
<a href="#l59.72"></a><span id="l59.72">   skin/classic/communicator/console/console.css                         (communicator/console/console.css)</span>
<a href="#l59.73"></a><span id="l59.73">   skin/classic/communicator/console/console-error-caret.gif             (communicator/console/console-error-caret.gif)</span>
<a href="#l59.74"></a><span id="l59.74">   skin/classic/communicator/console/console-error-dash.gif              (communicator/console/console-error-dash.gif)</span>
<a href="#l59.75"></a><span id="l59.75">   skin/classic/communicator/console/console-toolbar.png                 (communicator/console/console-toolbar.png)</span>
<a href="#l59.76"></a><span id="l59.76">   skin/classic/communicator/console/itemSelected.png                    (communicator/console/itemSelected.png)</span>
<a href="#l59.77"></a><span id="l59.77">   skin/classic/communicator/downloads/downloadButtons.png               (communicator/downloads/downloadButtons.png)</span>
<a href="#l59.78"></a><span id="l59.78">   skin/classic/communicator/downloads/downloadmanager.css               (communicator/downloads/downloadmanager.css)</span>
<a href="#l59.79"></a><span id="l59.79">   skin/classic/communicator/helpviewer/Toolbar-rtl.png                  (communicator/helpviewer/Toolbar-rtl.png)</span>
<a href="#l59.80"></a><span id="l59.80">   skin/classic/communicator/helpviewer/help.css                         (communicator/helpviewer/help.css)</span>
<a href="#l59.81"></a><span id="l59.81" class="difflineplus">+  skin/classic/communicator/places/bookmark-folder-closed.png           (communicator/places/bookmark-folder-closed.png)</span>
<a href="#l59.82"></a><span id="l59.82" class="difflineplus">+  skin/classic/communicator/places/bookmark-folder-dis.png              (communicator/places/bookmark-folder-dis.png)</span>
<a href="#l59.83"></a><span id="l59.83" class="difflineplus">+  skin/classic/communicator/places/bookmark-folder-open.png             (communicator/places/bookmark-folder-open.png)</span>
<a href="#l59.84"></a><span id="l59.84" class="difflineplus">+  skin/classic/communicator/places/bookmarks.css                        (communicator/places/bookmarks.css)</span>
<a href="#l59.85"></a><span id="l59.85" class="difflineplus">+  skin/classic/communicator/places/bookmarksMenu.png                    (communicator/places/bookmarksMenu.png)</span>
<a href="#l59.86"></a><span id="l59.86" class="difflineplus">+  skin/classic/communicator/places/bookmarksToolbar.css                 (communicator/places/bookmarksToolbar.css)</span>
<a href="#l59.87"></a><span id="l59.87" class="difflineplus">+  skin/classic/communicator/places/bookmarksToolbar.png                 (communicator/places/bookmarksToolbar.png)</span>
<a href="#l59.88"></a><span id="l59.88" class="difflineplus">+  skin/classic/communicator/places/editBookmarkOverlay.css              (communicator/places/editBookmarkOverlay.css)</span>
<a href="#l59.89"></a><span id="l59.89" class="difflineplus">+  skin/classic/communicator/places/livemark-folder.png                  (communicator/places/livemark-folder.png)</span>
<a href="#l59.90"></a><span id="l59.90" class="difflineplus">+  skin/classic/communicator/places/organizer.css                        (communicator/places/organizer.css)</span>
<a href="#l59.91"></a><span id="l59.91" class="difflineplus">+  skin/classic/communicator/places/query.png                            (communicator/places/query.png)</span>
<a href="#l59.92"></a><span id="l59.92" class="difflineplus">+  skin/classic/communicator/places/tag.png                              (communicator/places/tag.png)</span>
<a href="#l59.93"></a><span id="l59.93" class="difflineplus">+  skin/classic/communicator/places/toolbarDropMarker.png                (communicator/places/toolbarDropMarker.png)</span>
<a href="#l59.94"></a><span id="l59.94">   skin/classic/communicator/profile/profile.css                         (communicator/profile/profile.css)</span>
<a href="#l59.95"></a><span id="l59.95">   skin/classic/communicator/search/mainwindow-dropdown-arrow.png        (communicator/search/mainwindow-dropdown-arrow.png)</span>
<a href="#l59.96"></a><span id="l59.96">   skin/classic/communicator/search/search-glass.png                     (communicator/search/search-glass.png)</span>
<a href="#l59.97"></a><span id="l59.97">   skin/classic/communicator/search/searchbar.css                        (communicator/search/searchbar.css)</span>
<a href="#l59.98"></a><span id="l59.98">   skin/classic/communicator/sidebar/sidebar.css                         (communicator/sidebar/sidebar.css)</span>
<a href="#l59.99"></a><span id="l59.99">   skin/classic/communicator/icons/communicatoricons.png                 (communicator/icons/communicatoricons.png)</span>
<a href="#l59.100"></a><span id="l59.100">   skin/classic/communicator/icons/communicatoricons-small.png           (communicator/icons/communicatoricons-small.png)</span>
<a href="#l59.101"></a><span id="l59.101">   skin/classic/communicator/icons/geolocation-16.png                    (communicator/icons/geolocation-16.png)</span>
<a href="#l59.102"></a><span id="l59.102" class="difflineat">@@ -124,33 +124,34 @@ classic.jar:</span>
<a href="#l59.103"></a><span id="l59.103">   skin/classic/communicator/blockedSite.css                             (communicator/blockedSite.css)</span>
<a href="#l59.104"></a><span id="l59.104">   skin/classic/communicator/certError.css                               (communicator/certError.css)</span>
<a href="#l59.105"></a><span id="l59.105">   skin/classic/communicator/common.css                                  (communicator/common.css)</span>
<a href="#l59.106"></a><span id="l59.106">   skin/classic/communicator/dialogs.css                                 (communicator/dialogs.css)</span>
<a href="#l59.107"></a><span id="l59.107">   skin/classic/communicator/communicatorBindings.xml                    (communicator/communicatorBindings.xml)</span>
<a href="#l59.108"></a><span id="l59.108">   skin/classic/communicator/prefpanels.css                              (communicator/prefpanels.css)</span>
<a href="#l59.109"></a><span id="l59.109">   skin/classic/communicator/smileys.css                                 (communicator/smileys.css)</span>
<a href="#l59.110"></a><span id="l59.110">   skin/classic/communicator/tasksOverlay.css                            (communicator/tasksOverlay.css)</span>
<a href="#l59.111"></a><span id="l59.111" class="difflineminus">-  skin/classic/communicator/bookmarks/allBookmarks.png                  (communicator/bookmarks/allBookmarks.png)</span>
<a href="#l59.112"></a><span id="l59.112" class="difflineminus">-  skin/classic/communicator/bookmarks/bookmark.png                      (communicator/bookmarks/bookmark.png)</span>
<a href="#l59.113"></a><span id="l59.113" class="difflineminus">-  skin/classic/communicator/bookmarks/bookmark-item-dis.png             (communicator/bookmarks/bookmark-item-dis.png)</span>
<a href="#l59.114"></a><span id="l59.114" class="difflineminus">-  skin/classic/communicator/bookmarks/bookmark-item-updated.png         (communicator/bookmarks/bookmark-item-updated.png)</span>
<a href="#l59.115"></a><span id="l59.115" class="difflineminus">-  skin/classic/communicator/bookmarks/bookmark-item.svg                 (communicator/bookmarks/bookmark-item.svg)</span>
<a href="#l59.116"></a><span id="l59.116" class="difflineminus">-  skin/classic/communicator/bookmarks/unsortedBookmarks.png             (communicator/bookmarks/unsortedBookmarks.png)</span>
<a href="#l59.117"></a><span id="l59.117">   skin/classic/communicator/brand/throbber-anim.png                     (communicator/brand/throbber-anim.png)</span>
<a href="#l59.118"></a><span id="l59.118">   skin/classic/communicator/brand/throbber-single.png                   (communicator/brand/throbber-single.png)</span>
<a href="#l59.119"></a><span id="l59.119">   skin/classic/communicator/brand/throbber16-anim.png                   (communicator/brand/throbber16-anim.png)</span>
<a href="#l59.120"></a><span id="l59.120">   skin/classic/communicator/brand/throbber16-single.png                 (communicator/brand/throbber16-single.png)</span>
<a href="#l59.121"></a><span id="l59.121">   skin/classic/communicator/dataman/dataman.css                         (communicator/dataman/dataman.css)</span>
<a href="#l59.122"></a><span id="l59.122">   skin/classic/communicator/dataman/datamanIcon-16.png                  (communicator/dataman/datamanIcon-16.png)</span>
<a href="#l59.123"></a><span id="l59.123">   skin/classic/communicator/feed-subscribe.css                          (communicator/feed-subscribe.css)</span>
<a href="#l59.124"></a><span id="l59.124">   skin/classic/communicator/feed-subscribe-ui.css                       (communicator/feed-subscribe-ui.css)</span>
<a href="#l59.125"></a><span id="l59.125">   skin/classic/communicator/fullscreen-video.css                        (communicator/fullscreen-video.css)</span>
<a href="#l59.126"></a><span id="l59.126">   skin/classic/communicator/downloads/dl-remove.png                     (communicator/downloads/dl-remove.png)</span>
<a href="#l59.127"></a><span id="l59.127" class="difflineminus">-  skin/classic/communicator/history/calendar.png                        (communicator/history/calendar.png)</span>
<a href="#l59.128"></a><span id="l59.128" class="difflineplus">+  skin/classic/communicator/places/allBookmarks.png                     (communicator/places/allBookmarks.png)</span>
<a href="#l59.129"></a><span id="l59.129" class="difflineplus">+  skin/classic/communicator/places/bookmark.png                         (communicator/places/bookmark.png)</span>
<a href="#l59.130"></a><span id="l59.130" class="difflineplus">+  skin/classic/communicator/places/bookmark-item-dis.png                (communicator/places/bookmark-item-dis.png)</span>
<a href="#l59.131"></a><span id="l59.131" class="difflineplus">+  skin/classic/communicator/places/bookmark-item-updated.png            (communicator/places/bookmark-item-updated.png)</span>
<a href="#l59.132"></a><span id="l59.132" class="difflineplus">+  skin/classic/communicator/places/bookmark-item.svg                    (communicator/places/bookmark-item.svg)</span>
<a href="#l59.133"></a><span id="l59.133" class="difflineplus">+  skin/classic/communicator/places/calendar.png                         (communicator/places/calendar.png)</span>
<a href="#l59.134"></a><span id="l59.134" class="difflineplus">+  skin/classic/communicator/places/history.png                          (communicator/places/history.png)</span>
<a href="#l59.135"></a><span id="l59.135" class="difflineplus">+  skin/classic/communicator/places/unsortedBookmarks.png                (communicator/places/unsortedBookmarks.png)</span>
<a href="#l59.136"></a><span id="l59.136">   skin/classic/communicator/profile/migrate.gif                         (communicator/profile/migrate.gif)</span>
<a href="#l59.137"></a><span id="l59.137">   skin/classic/communicator/profile/profileManager.css                  (communicator/profile/profileManager.css)</span>
<a href="#l59.138"></a><span id="l59.138">   skin/classic/communicator/profile/profileicon-large.gif               (communicator/profile/profileicon-large.gif)</span>
<a href="#l59.139"></a><span id="l59.139">   skin/classic/communicator/search/engineManager.css                    (communicator/search/engineManager.css)</span>
<a href="#l59.140"></a><span id="l59.140">   skin/classic/communicator/search/search.css                           (communicator/search/search.css)</span>
<a href="#l59.141"></a><span id="l59.141">   skin/classic/communicator/sidebar/sbtab-twisty.gif                    (communicator/sidebar/sbtab-twisty.gif)</span>
<a href="#l59.142"></a><span id="l59.142">   skin/classic/communicator/sidebar/sbtab-twisty-open.gif               (communicator/sidebar/sbtab-twisty-open.gif)</span>
<a href="#l59.143"></a><span id="l59.143">   skin/classic/communicator/sidebar/customize.css                       (communicator/sidebar/customize.css)</span>
<a href="#l59.144"></a><span id="l59.144" class="difflineat">@@ -494,13 +495,13 @@ classic.jar:</span>
<a href="#l59.145"></a><span id="l59.145">   skin/classic/navigator/icons/popup-blocked.png                        (navigator/icons/popup-blocked.png)</span>
<a href="#l59.146"></a><span id="l59.146">   skin/classic/navigator/icons/tab-drag-indicator.gif                   (navigator/icons/tab-drag-indicator.gif)</span>
<a href="#l59.147"></a><span id="l59.147">   skin/classic/navigator/icons/tab-new.gif                              (navigator/icons/tab-new.gif)</span>
<a href="#l59.148"></a><span id="l59.148"> [extensions/{972ce4c6-7e08-4474-a285-3208198ce6fd}] chrome.jar:</span>
<a href="#l59.149"></a><span id="l59.149"> % override chrome://global/skin/about.css                         chrome://communicator/skin/about.css</span>
<a href="#l59.150"></a><span id="l59.150"> % override chrome://global/skin/aboutSupport.css                  chrome://communicator/skin/aboutSupport.css</span>
<a href="#l59.151"></a><span id="l59.151"> % override chrome://global/skin/config.css                        chrome://communicator/skin/config.css</span>
<a href="#l59.152"></a><span id="l59.152"> % override chrome://global/skin/in-content/info-pages.css         chrome://communicator/skin/communicator.css</span>
<a href="#l59.153"></a><span id="l59.153" class="difflineminus">-% override chrome://mozapps/skin/places/defaultFavicon.svg        chrome://communicator/skin/bookmarks/bookmark-item.svg</span>
<a href="#l59.154"></a><span id="l59.154" class="difflineplus">+% override chrome://mozapps/skin/places/defaultFavicon.svg        chrome://communicator/skin/places/bookmark-item.svg</span>
<a href="#l59.155"></a><span id="l59.155"> </span>
<a href="#l59.156"></a><span id="l59.156"> #ifdef MOZ_WIDGET_GTK</span>
<a href="#l59.157"></a><span id="l59.157"> % override chrome://global/skin/scrollbars.css                    chrome://communicator/skin/scrollbars.css</span>
<a href="#l59.158"></a><span id="l59.158"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l60.1"></a><span id="l60.1" class="difflineminus">--- a/suite/themes/classic/mac/communicator/aboutSessionRestore.css</span>
<a href="#l60.2"></a><span id="l60.2" class="difflineplus">+++ b/suite/themes/classic/mac/communicator/aboutSessionRestore.css</span>
<a href="#l60.3"></a><span id="l60.3" class="difflineat">@@ -11,17 +11,17 @@ treechildren::-moz-tree-image(icon),</span>
<a href="#l60.4"></a><span id="l60.4"> treechildren::-moz-tree-image(noicon) {</span>
<a href="#l60.5"></a><span id="l60.5">   padding-right: 2px;</span>
<a href="#l60.6"></a><span id="l60.6">   margin: 0px 2px;</span>
<a href="#l60.7"></a><span id="l60.7">   width: 16px;</span>
<a href="#l60.8"></a><span id="l60.8">   height: 16px;</span>
<a href="#l60.9"></a><span id="l60.9"> }</span>
<a href="#l60.10"></a><span id="l60.10"> </span>
<a href="#l60.11"></a><span id="l60.11"> treechildren::-moz-tree-image(noicon) {</span>
<a href="#l60.12"></a><span id="l60.12" class="difflineminus">-  list-style-image: url(&quot;chrome://communicator/skin/bookmarks/bookmark-item.svg&quot;);</span>
<a href="#l60.13"></a><span id="l60.13" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/places/bookmark-item.svg&quot;);</span>
<a href="#l60.14"></a><span id="l60.14"> }</span>
<a href="#l60.15"></a><span id="l60.15"> </span>
<a href="#l60.16"></a><span id="l60.16"> treechildren::-moz-tree-image(container, noicon) {</span>
<a href="#l60.17"></a><span id="l60.17">   list-style-image: url(&quot;chrome://global/skin/tree/folder.png&quot;);</span>
<a href="#l60.18"></a><span id="l60.18"> }</span>
<a href="#l60.19"></a><span id="l60.19"> </span>
<a href="#l60.20"></a><span id="l60.20"> treechildren::-moz-tree-checkbox(checked) {</span>
<a href="#l60.21"></a><span id="l60.21">   list-style-image: url(&quot;chrome://global/skin/checkbox/cbox-check.gif&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l61.1"></a><span id="l61.1" class="difflineminus">--- a/suite/themes/classic/mac/communicator/places/bookmarks.css</span>
<a href="#l61.2"></a><span id="l61.2" class="difflineplus">+++ b/suite/themes/classic/mac/communicator/places/bookmarks.css</span>
<a href="#l61.3"></a><span id="l61.3" class="difflineat">@@ -4,106 +4,104 @@</span>
<a href="#l61.4"></a><span id="l61.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l61.5"></a><span id="l61.5"> </span>
<a href="#l61.6"></a><span id="l61.6"> @namespace url(&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;);</span>
<a href="#l61.7"></a><span id="l61.7"> </span>
<a href="#l61.8"></a><span id="l61.8"> /**</span>
<a href="#l61.9"></a><span id="l61.9">  * Style rules for generic bookmarks items.</span>
<a href="#l61.10"></a><span id="l61.10">  */</span>
<a href="#l61.11"></a><span id="l61.11"> </span>
<a href="#l61.12"></a><span id="l61.12" class="difflineminus">-treechildren::-moz-tree-image(Name),</span>
<a href="#l61.13"></a><span id="l61.13"> treechildren::-moz-tree-image(title) {</span>
<a href="#l61.14"></a><span id="l61.14">   margin-inline-end: 2px;</span>
<a href="#l61.15"></a><span id="l61.15">   width: 16px;</span>
<a href="#l61.16"></a><span id="l61.16">   height: 16px;</span>
<a href="#l61.17"></a><span id="l61.17"> }</span>
<a href="#l61.18"></a><span id="l61.18"> </span>
<a href="#l61.19"></a><span id="l61.19"> .bookmark-item,</span>
<a href="#l61.20"></a><span id="l61.20" class="difflineminus">-treechildren::-moz-tree-image(Name),</span>
<a href="#l61.21"></a><span id="l61.21"> treechildren::-moz-tree-image(title) {</span>
<a href="#l61.22"></a><span id="l61.22" class="difflineminus">-  list-style-image: url(&quot;chrome://communicator/skin/bookmarks/bookmark-item.svg&quot;);</span>
<a href="#l61.23"></a><span id="l61.23" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/places/bookmark-item.svg&quot;);</span>
<a href="#l61.24"></a><span id="l61.24"> }</span>
<a href="#l61.25"></a><span id="l61.25"> </span>
<a href="#l61.26"></a><span id="l61.26"> .bookmark-item[container=&quot;true&quot;],</span>
<a href="#l61.27"></a><span id="l61.27" class="difflineminus">-treechildren::-moz-tree-image(Name, container),</span>
<a href="#l61.28"></a><span id="l61.28"> treechildren::-moz-tree-image(title, container) {</span>
<a href="#l61.29"></a><span id="l61.29">   list-style-image: url(&quot;chrome://global/skin/tree/folder.png&quot;);</span>
<a href="#l61.30"></a><span id="l61.30"> }</span>
<a href="#l61.31"></a><span id="l61.31"> </span>
<a href="#l61.32"></a><span id="l61.32"> .bookmark-item[container=&quot;true&quot;][open=&quot;true&quot;][loading=&quot;true&quot;] {</span>
<a href="#l61.33"></a><span id="l61.33">   list-style-image: url(&quot;chrome://communicator/skin/icons/loading.png&quot;) !important;</span>
<a href="#l61.34"></a><span id="l61.34"> }</span>
<a href="#l61.35"></a><span id="l61.35"> </span>
<a href="#l61.36"></a><span id="l61.36"> .bookmark-item &gt; .toolbarbutton-box &gt; .toolbarbutton-icon {</span>
<a href="#l61.37"></a><span id="l61.37">   list-style-image: inherit;</span>
<a href="#l61.38"></a><span id="l61.38">   width: 16px;</span>
<a href="#l61.39"></a><span id="l61.39">   height: 16px;</span>
<a href="#l61.40"></a><span id="l61.40"> }</span>
<a href="#l61.41"></a><span id="l61.41"> </span>
<a href="#l61.42"></a><span id="l61.42" class="difflineminus">-/* calendar icon for history grouping items by day */</span>
<a href="#l61.43"></a><span id="l61.43" class="difflineminus">-treechildren::-moz-tree-image(Name, query, dayContainer) {</span>
<a href="#l61.44"></a><span id="l61.44" class="difflineminus">-  list-style-image: url(&quot;chrome://communicator/skin/history/calendar.png&quot;);</span>
<a href="#l61.45"></a><span id="l61.45" class="difflineminus">-}</span>
<a href="#l61.46"></a><span id="l61.46" class="difflineminus">-</span>
<a href="#l61.47"></a><span id="l61.47"> .bookmark-item[container][livemark],</span>
<a href="#l61.48"></a><span id="l61.48"> treechildren::-moz-tree-image(title, container, livemark) {</span>
<a href="#l61.49"></a><span id="l61.49" class="difflineminus">-  list-style-image: url(&quot;chrome://communicator/skin/bookmarks/livemark-folder.png&quot;);</span>
<a href="#l61.50"></a><span id="l61.50" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/places/livemark-folder.png&quot;);</span>
<a href="#l61.51"></a><span id="l61.51"> }</span>
<a href="#l61.52"></a><span id="l61.52"> </span>
<a href="#l61.53"></a><span id="l61.53"> .bookmark-item[container][livemark] .bookmark-item,</span>
<a href="#l61.54"></a><span id="l61.54"> treechildren::-moz-tree-image(title, livemarkItem) {</span>
<a href="#l61.55"></a><span id="l61.55" class="difflineminus">-  list-style-image: url(&quot;chrome://communicator/skin/bookmarks/bookmark-item-updated.png&quot;);</span>
<a href="#l61.56"></a><span id="l61.56" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/places/bookmark-item-updated.png&quot;);</span>
<a href="#l61.57"></a><span id="l61.57"> }</span>
<a href="#l61.58"></a><span id="l61.58"> </span>
<a href="#l61.59"></a><span id="l61.59"> .bookmark-item[container][livemark] .bookmark-item[visited],</span>
<a href="#l61.60"></a><span id="l61.60"> treechildren::-moz-tree-image(title, livemarkItem, visited) {</span>
<a href="#l61.61"></a><span id="l61.61" class="difflineminus">-  list-style-image: url(&quot;chrome://communicator/skin/bookmarks/bookmark-item.svg&quot;);</span>
<a href="#l61.62"></a><span id="l61.62" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/places/bookmark-item.svg&quot;);</span>
<a href="#l61.63"></a><span id="l61.63"> }</span>
<a href="#l61.64"></a><span id="l61.64"> </span>
<a href="#l61.65"></a><span id="l61.65"> treechildren::-moz-tree-image(container, OrganizerQuery_AllBookmarks) {</span>
<a href="#l61.66"></a><span id="l61.66" class="difflineminus">-  list-style-image: url(&quot;chrome://communicator/skin/bookmarks/allBookmarks.png&quot;);</span>
<a href="#l61.67"></a><span id="l61.67" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/places/allBookmarks.png&quot;);</span>
<a href="#l61.68"></a><span id="l61.68"> }</span>
<a href="#l61.69"></a><span id="l61.69"> </span>
<a href="#l61.70"></a><span id="l61.70"> #bookmarksToolbarFolderMenu,</span>
<a href="#l61.71"></a><span id="l61.71"> #BMB_bookmarksToolbarFolderMenu,</span>
<a href="#l61.72"></a><span id="l61.72"> treechildren::-moz-tree-image(container, OrganizerQuery_BookmarksToolbar) {</span>
<a href="#l61.73"></a><span id="l61.73" class="difflineminus">-  list-style-image: url(&quot;chrome://communicator/skin/bookmarks/bookmarksToolbar.png&quot;);</span>
<a href="#l61.74"></a><span id="l61.74" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/places/bookmarksToolbar.png&quot;);</span>
<a href="#l61.75"></a><span id="l61.75"> }</span>
<a href="#l61.76"></a><span id="l61.76"> </span>
<a href="#l61.77"></a><span id="l61.77"> treechildren::-moz-tree-image(container, OrganizerQuery_BookmarksMenu) {</span>
<a href="#l61.78"></a><span id="l61.78" class="difflineminus">-  list-style-image: url(&quot;chrome://communicator/skin/bookmarks/bookmarksMenu.png&quot;);</span>
<a href="#l61.79"></a><span id="l61.79" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/places/bookmarksMenu.png&quot;);</span>
<a href="#l61.80"></a><span id="l61.80"> }</span>
<a href="#l61.81"></a><span id="l61.81"> </span>
<a href="#l61.82"></a><span id="l61.82"> #unsortedBookmarksFolderMenu,</span>
<a href="#l61.83"></a><span id="l61.83"> #BMB_unsortedBookmarksFolderMenu,</span>
<a href="#l61.84"></a><span id="l61.84"> treechildren::-moz-tree-image(container, OrganizerQuery_UnfiledBookmarks) {</span>
<a href="#l61.85"></a><span id="l61.85" class="difflineminus">-  list-style-image: url(&quot;chrome://communicator/skin/bookmarks/unsortedBookmarks.png&quot;);</span>
<a href="#l61.86"></a><span id="l61.86" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/places/unsortedBookmarks.png&quot;);</span>
<a href="#l61.87"></a><span id="l61.87"> }</span>
<a href="#l61.88"></a><span id="l61.88"> </span>
<a href="#l61.89"></a><span id="l61.89"> /* query-nodes should be styled even if they're not expandable */</span>
<a href="#l61.90"></a><span id="l61.90"> .bookmark-item[query],</span>
<a href="#l61.91"></a><span id="l61.91" class="difflineminus">-treechildren::-moz-tree-image(title, query) {</span>
<a href="#l61.92"></a><span id="l61.92" class="difflineminus">-  list-style-image: url(&quot;chrome://communicator/skin/bookmarks/query.png&quot;);</span>
<a href="#l61.93"></a><span id="l61.93" class="difflineplus">+treechildren::-moz-tree-image(query) {</span>
<a href="#l61.94"></a><span id="l61.94" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/places/query.png&quot;);</span>
<a href="#l61.95"></a><span id="l61.95"> }</span>
<a href="#l61.96"></a><span id="l61.96"> </span>
<a href="#l61.97"></a><span id="l61.97"> .bookmark-item[query][tagContainer],</span>
<a href="#l61.98"></a><span id="l61.98"> treechildren::-moz-tree-image(title, query, tagContainer),</span>
<a href="#l61.99"></a><span id="l61.99"> treechildren::-moz-tree-image(query, OrganizerQuery_Tags) {</span>
<a href="#l61.100"></a><span id="l61.100" class="difflineminus">-  list-style-image: url(&quot;chrome://communicator/skin/bookmarks/tag.png&quot;);</span>
<a href="#l61.101"></a><span id="l61.101" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/places/tag.png&quot;);</span>
<a href="#l61.102"></a><span id="l61.102"> }</span>
<a href="#l61.103"></a><span id="l61.103"> </span>
<a href="#l61.104"></a><span id="l61.104" class="difflineminus">-treechildren::-moz-tree-image(Name, separator),</span>
<a href="#l61.105"></a><span id="l61.105" class="difflineplus">+/* calendar icon for history grouping items by day */</span>
<a href="#l61.106"></a><span id="l61.106" class="difflineplus">+treechildren::-moz-tree-image(title, query, dayContainer) {</span>
<a href="#l61.107"></a><span id="l61.107" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/places/calendar.png&quot;);</span>
<a href="#l61.108"></a><span id="l61.108" class="difflineplus">+}</span>
<a href="#l61.109"></a><span id="l61.109" class="difflineplus">+</span>
<a href="#l61.110"></a><span id="l61.110" class="difflineplus">+treechildren::-moz-tree-image(query, OrganizerQuery_History) {</span>
<a href="#l61.111"></a><span id="l61.111" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/places/history.png&quot;);</span>
<a href="#l61.112"></a><span id="l61.112" class="difflineplus">+}</span>
<a href="#l61.113"></a><span id="l61.113" class="difflineplus">+</span>
<a href="#l61.114"></a><span id="l61.114"> treechildren::-moz-tree-image(title, separator) {</span>
<a href="#l61.115"></a><span id="l61.115">   list-style-image: none;</span>
<a href="#l61.116"></a><span id="l61.116">   width: 0px;</span>
<a href="#l61.117"></a><span id="l61.117">   height: 0px;</span>
<a href="#l61.118"></a><span id="l61.118"> }</span>
<a href="#l61.119"></a><span id="l61.119"> </span>
<a href="#l61.120"></a><span id="l61.120" class="difflineminus">-treechildren::-moz-tree-cell-text(Name, separator),</span>
<a href="#l61.121"></a><span id="l61.121"> treechildren::-moz-tree-cell-text(title, separator) {</span>
<a href="#l61.122"></a><span id="l61.122">   color: ThreeDShadow;</span>
<a href="#l61.123"></a><span id="l61.123">   margin: 0px 5px;</span>
<a href="#l61.124"></a><span id="l61.124"> }</span>
<a href="#l61.125"></a><span id="l61.125"> </span>
<a href="#l61.126"></a><span id="l61.126" class="difflineminus">-treechildren::-moz-tree-cell-text(Name, separator, selected, focus),</span>
<a href="#l61.127"></a><span id="l61.127"> treechildren::-moz-tree-cell-text(title, separator, selected, focus) {</span>
<a href="#l61.128"></a><span id="l61.128">   color: HighlightText;</span>
<a href="#l61.129"></a><span id="l61.129"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l62.1"></a><span id="l62.1" class="difflineminus">--- a/suite/themes/classic/mac/communicator/places/bookmarksToolbar.css</span>
<a href="#l62.2"></a><span id="l62.2" class="difflineplus">+++ b/suite/themes/classic/mac/communicator/places/bookmarksToolbar.css</span>
<a href="#l62.3"></a><span id="l62.3" class="difflineat">@@ -1,17 +1,17 @@</span>
<a href="#l62.4"></a><span id="l62.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l62.5"></a><span id="l62.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l62.6"></a><span id="l62.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l62.7"></a><span id="l62.7"> </span>
<a href="#l62.8"></a><span id="l62.8"> /* ===== bookmarksToolbar.css ===========================================</span>
<a href="#l62.9"></a><span id="l62.9">   == Styles specific to bookmark items in a toolbar.</span>
<a href="#l62.10"></a><span id="l62.10">   ======================================================================= */</span>
<a href="#l62.11"></a><span id="l62.11"> </span>
<a href="#l62.12"></a><span id="l62.12" class="difflineminus">-@import url(&quot;chrome://communicator/skin/bookmarks/bookmarks.css&quot;);</span>
<a href="#l62.13"></a><span id="l62.13" class="difflineplus">+@import url(&quot;chrome://communicator/skin/places/bookmarks.css&quot;);</span>
<a href="#l62.14"></a><span id="l62.14"> </span>
<a href="#l62.15"></a><span id="l62.15"> /* ::::: bookmark toolbar buttons ::::: */</span>
<a href="#l62.16"></a><span id="l62.16"> </span>
<a href="#l62.17"></a><span id="l62.17"> /* ..... bookmark items ..... */</span>
<a href="#l62.18"></a><span id="l62.18"> </span>
<a href="#l62.19"></a><span id="l62.19"> toolbarbutton.bookmark-item {</span>
<a href="#l62.20"></a><span id="l62.20">   min-width: 0px;</span>
<a href="#l62.21"></a><span id="l62.21">   max-width: 13em;</span>
<a href="#l62.22"></a><span id="l62.22" class="difflineat">@@ -34,31 +34,31 @@ toolbarbutton.bookmark-item[disabled=&quot;tr</span>
<a href="#l62.23"></a><span id="l62.23"> </span>
<a href="#l62.24"></a><span id="l62.24"> .bookmark-item &gt; .toolbarbutton-menu-dropmarker {</span>
<a href="#l62.25"></a><span id="l62.25">   display: none;</span>
<a href="#l62.26"></a><span id="l62.26"> }</span>
<a href="#l62.27"></a><span id="l62.27"> </span>
<a href="#l62.28"></a><span id="l62.28"> /* ::::: bookmark menus ::::: */</span>
<a href="#l62.29"></a><span id="l62.29"> </span>
<a href="#l62.30"></a><span id="l62.30"> .bookmark-group {</span>
<a href="#l62.31"></a><span id="l62.31" class="difflineminus">-  list-style-image: url(chrome://communicator/skin/bookmarks/bookmark-group.png) !important;</span>
<a href="#l62.32"></a><span id="l62.32" class="difflineplus">+  list-style-image: url(chrome://communicator/skin/places/bookmark-group.png) !important;</span>
<a href="#l62.33"></a><span id="l62.33"> }</span>
<a href="#l62.34"></a><span id="l62.34"> </span>
<a href="#l62.35"></a><span id="l62.35"> .menuitem-iconic.bookmark-item[disabled=&quot;true&quot;] {</span>
<a href="#l62.36"></a><span id="l62.36" class="difflineminus">-  list-style-image: url(&quot;chrome://communicator/skin/bookmarks/bookmark-item-dis.png&quot;);</span>
<a href="#l62.37"></a><span id="l62.37" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/places/bookmark-item-dis.png&quot;);</span>
<a href="#l62.38"></a><span id="l62.38"> }</span>
<a href="#l62.39"></a><span id="l62.39"> </span>
<a href="#l62.40"></a><span id="l62.40"> .menu-iconic.bookmark-item[disabled=&quot;true&quot;][container=&quot;true&quot;] {</span>
<a href="#l62.41"></a><span id="l62.41">   opacity: 0.5;</span>
<a href="#l62.42"></a><span id="l62.42"> }</span>
<a href="#l62.43"></a><span id="l62.43"> </span>
<a href="#l62.44"></a><span id="l62.44"> /* ..... drag and drop styles ..... */</span>
<a href="#l62.45"></a><span id="l62.45"> </span>
<a href="#l62.46"></a><span id="l62.46"> #PlacesToolbarDropIndicator {</span>
<a href="#l62.47"></a><span id="l62.47" class="difflineminus">-  list-style-image: url(&quot;chrome://communicator/skin/bookmarks/toolbarDropMarker.png&quot;);</span>
<a href="#l62.48"></a><span id="l62.48" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/places/toolbarDropMarker.png&quot;);</span>
<a href="#l62.49"></a><span id="l62.49"> }</span>
<a href="#l62.50"></a><span id="l62.50"> </span>
<a href="#l62.51"></a><span id="l62.51"> .bookmark-item[dragover-into=&quot;true&quot;] {</span>
<a href="#l62.52"></a><span id="l62.52">   background: Highlight !important;</span>
<a href="#l62.53"></a><span id="l62.53">   color: HighlightText !important;</span>
<a href="#l62.54"></a><span id="l62.54"> }</span>
<a href="#l62.55"></a><span id="l62.55"> </span>
<a href="#l62.56"></a><span id="l62.56"> /* rules for menupopup drop indicators */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l63.1"></a><span id="l63.1" class="difflineminus">--- a/suite/themes/classic/mac/communicator/places/editBookmarkOverlay.css</span>
<a href="#l63.2"></a><span id="l63.2" class="difflineplus">+++ b/suite/themes/classic/mac/communicator/places/editBookmarkOverlay.css</span>
<a href="#l63.3"></a><span id="l63.3" class="difflineat">@@ -56,20 +56,20 @@</span>
<a href="#l63.4"></a><span id="l63.4">   visibility: collapse;</span>
<a href="#l63.5"></a><span id="l63.5"> }</span>
<a href="#l63.6"></a><span id="l63.6"> </span>
<a href="#l63.7"></a><span id="l63.7"> </span>
<a href="#l63.8"></a><span id="l63.8"> /* ::::: bookmark panel dropdown icons ::::: */</span>
<a href="#l63.9"></a><span id="l63.9"> </span>
<a href="#l63.10"></a><span id="l63.10"> #editBMPanel_folderMenuList[selectedIndex=&quot;0&quot;],</span>
<a href="#l63.11"></a><span id="l63.11"> #editBMPanel_toolbarFolderItem {</span>
<a href="#l63.12"></a><span id="l63.12" class="difflineminus">-  list-style-image: url(&quot;chrome://communicator/skin/bookmarks/bookmarksToolbar.png&quot;);</span>
<a href="#l63.13"></a><span id="l63.13" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/places/bookmarksToolbar.png&quot;);</span>
<a href="#l63.14"></a><span id="l63.14"> }</span>
<a href="#l63.15"></a><span id="l63.15"> </span>
<a href="#l63.16"></a><span id="l63.16"> #editBMPanel_folderMenuList[selectedIndex=&quot;1&quot;],</span>
<a href="#l63.17"></a><span id="l63.17"> #editBMPanel_bmRootItem {</span>
<a href="#l63.18"></a><span id="l63.18" class="difflineminus">-  list-style-image: url(&quot;chrome://communicator/skin/bookmarks/bookmarksMenu.png&quot;);</span>
<a href="#l63.19"></a><span id="l63.19" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/places/bookmarksMenu.png&quot;);</span>
<a href="#l63.20"></a><span id="l63.20"> }</span>
<a href="#l63.21"></a><span id="l63.21"> </span>
<a href="#l63.22"></a><span id="l63.22"> #editBMPanel_folderMenuList[selectedIndex=&quot;2&quot;],</span>
<a href="#l63.23"></a><span id="l63.23"> #editBMPanel_unfiledRootItem {</span>
<a href="#l63.24"></a><span id="l63.24" class="difflineminus">-  list-style-image: url(&quot;chrome://communicator/skin/bookmarks/unsortedBookmarks.png&quot;);</span>
<a href="#l63.25"></a><span id="l63.25" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/places/unsortedBookmarks.png&quot;);</span>
<a href="#l63.26"></a><span id="l63.26"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l64.1"></a><span id="l64.1" class="difflineminus">--- a/suite/themes/classic/mac/navigator/navigator.css</span>
<a href="#l64.2"></a><span id="l64.2" class="difflineplus">+++ b/suite/themes/classic/mac/navigator/navigator.css</span>
<a href="#l64.3"></a><span id="l64.3" class="difflineat">@@ -1,15 +1,15 @@</span>
<a href="#l64.4"></a><span id="l64.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l64.5"></a><span id="l64.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l64.6"></a><span id="l64.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l64.7"></a><span id="l64.7"> </span>
<a href="#l64.8"></a><span id="l64.8"> @import url(&quot;chrome://navigator/content/navigator.css&quot;);</span>
<a href="#l64.9"></a><span id="l64.9"> @import url(&quot;chrome://communicator/skin/&quot;);</span>
<a href="#l64.10"></a><span id="l64.10" class="difflineminus">-@import url(&quot;chrome://communicator/skin/bookmarks/bookmarksToolbar.css&quot;);</span>
<a href="#l64.11"></a><span id="l64.11" class="difflineplus">+@import url(&quot;chrome://communicator/skin/places/bookmarksToolbar.css&quot;);</span>
<a href="#l64.12"></a><span id="l64.12"> </span>
<a href="#l64.13"></a><span id="l64.13"> @namespace url(&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;);</span>
<a href="#l64.14"></a><span id="l64.14"> @namespace html url(&quot;http://www.w3.org/1999/xhtml&quot;);</span>
<a href="#l64.15"></a><span id="l64.15"> </span>
<a href="#l64.16"></a><span id="l64.16"> #main-window {</span>
<a href="#l64.17"></a><span id="l64.17">   -moz-appearance: none;</span>
<a href="#l64.18"></a><span id="l64.18">   background-color: #EEEEEE;</span>
<a href="#l64.19"></a><span id="l64.19"> }</span>
<a href="#l64.20"></a><span id="l64.20" class="difflineat">@@ -467,26 +467,26 @@ toolbar[mode=&quot;text&quot;] &gt; #window-controls </span>
<a href="#l64.21"></a><span id="l64.21"> }</span>
<a href="#l64.22"></a><span id="l64.22"> </span>
<a href="#l64.23"></a><span id="l64.23"> #page-proxy-deck {</span>
<a href="#l64.24"></a><span id="l64.24">   cursor: grab;</span>
<a href="#l64.25"></a><span id="l64.25">   margin: 0 3px 1px 3px;</span>
<a href="#l64.26"></a><span id="l64.26"> }</span>
<a href="#l64.27"></a><span id="l64.27"> </span>
<a href="#l64.28"></a><span id="l64.28"> #page-proxy-button {</span>
<a href="#l64.29"></a><span id="l64.29" class="difflineminus">-  list-style-image: url(&quot;chrome://communicator/skin/bookmarks/bookmark-item.svg&quot;); </span>
<a href="#l64.30"></a><span id="l64.30" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/places/bookmark-item.svg&quot;); </span>
<a href="#l64.31"></a><span id="l64.31"> }</span>
<a href="#l64.32"></a><span id="l64.32"> </span>
<a href="#l64.33"></a><span id="l64.33"> #page-proxy-favicon {</span>
<a href="#l64.34"></a><span id="l64.34">   list-style-image: none;</span>
<a href="#l64.35"></a><span id="l64.35"> }</span>
<a href="#l64.36"></a><span id="l64.36"> </span>
<a href="#l64.37"></a><span id="l64.37"> #page-proxy-button[pageproxystate=&quot;invalid&quot;] {</span>
<a href="#l64.38"></a><span id="l64.38">   cursor: default;</span>
<a href="#l64.39"></a><span id="l64.39" class="difflineminus">-  list-style-image: url(&quot;chrome://communicator/skin/bookmarks/bookmark-item-dis.png&quot;);</span>
<a href="#l64.40"></a><span id="l64.40" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/places/bookmark-item-dis.png&quot;);</span>
<a href="#l64.41"></a><span id="l64.41"> }</span>
<a href="#l64.42"></a><span id="l64.42"> </span>
<a href="#l64.43"></a><span id="l64.43"> /* ::::: autocomplete ::::: */</span>
<a href="#l64.44"></a><span id="l64.44"> </span>
<a href="#l64.45"></a><span id="l64.45"> #PopupAutoComplete &gt; richlistbox &gt; richlistitem {</span>
<a href="#l64.46"></a><span id="l64.46">   height: 20px;</span>
<a href="#l64.47"></a><span id="l64.47">   min-height: 20px;</span>
<a href="#l64.48"></a><span id="l64.48">   border: 0;</span>
<a href="#l64.49"></a><span id="l64.49" class="difflineat">@@ -721,31 +721,31 @@ toolbar[mode=&quot;text&quot;] toolbarbutton.chevr</span>
<a href="#l64.50"></a><span id="l64.50">   height: 16px;</span>
<a href="#l64.51"></a><span id="l64.51"> }</span>
<a href="#l64.52"></a><span id="l64.52"> </span>
<a href="#l64.53"></a><span id="l64.53"> /*</span>
<a href="#l64.54"></a><span id="l64.54">   In customize mode we hide the normal bookmark items and show a placeholder</span>
<a href="#l64.55"></a><span id="l64.55">   for the drag/drop UI.</span>
<a href="#l64.56"></a><span id="l64.56"> */</span>
<a href="#l64.57"></a><span id="l64.57"> .bookmarks-toolbar-customize {</span>
<a href="#l64.58"></a><span id="l64.58" class="difflineminus">-  list-style-image: url(&quot;chrome://communicator/skin/bookmarks/bookmarksToolbar.png&quot;);</span>
<a href="#l64.59"></a><span id="l64.59" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/places/bookmarksToolbar.png&quot;);</span>
<a href="#l64.60"></a><span id="l64.60">   display: none;</span>
<a href="#l64.61"></a><span id="l64.61">   max-width: 15em !important;</span>
<a href="#l64.62"></a><span id="l64.62"> }</span>
<a href="#l64.63"></a><span id="l64.63"> </span>
<a href="#l64.64"></a><span id="l64.64"> #wrapper-personal-bookmarks[place=&quot;palette&quot;] &gt; .toolbarpaletteitem-box {</span>
<a href="#l64.65"></a><span id="l64.65">   width: 16px;</span>
<a href="#l64.66"></a><span id="l64.66">   height: 16px;</span>
<a href="#l64.67"></a><span id="l64.67" class="difflineminus">-  background: url(&quot;chrome://communicator/skin/bookmarks/bookmarksToolbar.png&quot;) no-repeat;</span>
<a href="#l64.68"></a><span id="l64.68" class="difflineplus">+  background: url(&quot;chrome://communicator/skin/places/bookmarksToolbar.png&quot;) no-repeat;</span>
<a href="#l64.69"></a><span id="l64.69"> }</span>
<a href="#l64.70"></a><span id="l64.70"> </span>
<a href="#l64.71"></a><span id="l64.71"> /* ::::: star button ::::: */</span>
<a href="#l64.72"></a><span id="l64.72"> </span>
<a href="#l64.73"></a><span id="l64.73"> #star-button {</span>
<a href="#l64.74"></a><span id="l64.74" class="difflineminus">-  list-style-image: url(&quot;chrome://communicator/skin/bookmarks/bookmark.png&quot;);</span>
<a href="#l64.75"></a><span id="l64.75" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/places/bookmark.png&quot;);</span>
<a href="#l64.76"></a><span id="l64.76">   -moz-image-region: rect(16px 16px 32px 0px);</span>
<a href="#l64.77"></a><span id="l64.77"> }</span>
<a href="#l64.78"></a><span id="l64.78"> </span>
<a href="#l64.79"></a><span id="l64.79"> #star-button:hover {</span>
<a href="#l64.80"></a><span id="l64.80">   -moz-image-region: rect(16px 32px 32px 16px);</span>
<a href="#l64.81"></a><span id="l64.81"> }</span>
<a href="#l64.82"></a><span id="l64.82"> </span>
<a href="#l64.83"></a><span id="l64.83"> #star-button:hover:active {</span>
<a href="#l64.84"></a><span id="l64.84" class="difflineat">@@ -760,17 +760,17 @@ toolbar[mode=&quot;text&quot;] toolbarbutton.chevr</span>
<a href="#l64.85"></a><span id="l64.85">   -moz-image-region: rect(0px 32px 16px 16px);</span>
<a href="#l64.86"></a><span id="l64.86"> }</span>
<a href="#l64.87"></a><span id="l64.87"> </span>
<a href="#l64.88"></a><span id="l64.88"> #star-button[starred=&quot;true&quot;]:hover:active {</span>
<a href="#l64.89"></a><span id="l64.89">   -moz-image-region: rect(0px 48px 16px 32px);</span>
<a href="#l64.90"></a><span id="l64.90"> }</span>
<a href="#l64.91"></a><span id="l64.91"> </span>
<a href="#l64.92"></a><span id="l64.92"> #editBookmarkPanelStarIcon {</span>
<a href="#l64.93"></a><span id="l64.93" class="difflineminus">-  list-style-image: url(&quot;chrome://communicator/skin/bookmarks/bookmark.png&quot;);</span>
<a href="#l64.94"></a><span id="l64.94" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/places/bookmark.png&quot;);</span>
<a href="#l64.95"></a><span id="l64.95">   -moz-image-region: rect(0px 16px 16px 0px);</span>
<a href="#l64.96"></a><span id="l64.96"> }</span>
<a href="#l64.97"></a><span id="l64.97"> </span>
<a href="#l64.98"></a><span id="l64.98"> #editBookmarkPanelTitle {</span>
<a href="#l64.99"></a><span id="l64.99">   font-size: 130%;</span>
<a href="#l64.100"></a><span id="l64.100">   font-weight: bold;</span>
<a href="#l64.101"></a><span id="l64.101"> }</span>
<a href="#l64.102"></a><span id="l64.102"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l65.1"></a><span id="l65.1" class="difflineminus">--- a/suite/themes/classic/mac/navigator/tabbrowser.css</span>
<a href="#l65.2"></a><span id="l65.2" class="difflineplus">+++ b/suite/themes/classic/mac/navigator/tabbrowser.css</span>
<a href="#l65.3"></a><span id="l65.3" class="difflineat">@@ -39,17 +39,17 @@ tabpanels {</span>
<a href="#l65.4"></a><span id="l65.4">   margin-inline-end: 3px;</span>
<a href="#l65.5"></a><span id="l65.5">   width: 16px;</span>
<a href="#l65.6"></a><span id="l65.6">   height: 16px;</span>
<a href="#l65.7"></a><span id="l65.7"> }</span>
<a href="#l65.8"></a><span id="l65.8"> </span>
<a href="#l65.9"></a><span id="l65.9"> .tabbrowser-tab {</span>
<a href="#l65.10"></a><span id="l65.10">   margin: 0;</span>
<a href="#l65.11"></a><span id="l65.11">   padding: 0;</span>
<a href="#l65.12"></a><span id="l65.12" class="difflineminus">-  list-style-image: url(&quot;chrome://communicator/skin/bookmarks/bookmark-item.svg&quot;);</span>
<a href="#l65.13"></a><span id="l65.13" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/places/bookmark-item.svg&quot;);</span>
<a href="#l65.14"></a><span id="l65.14">   border: solid transparent;</span>
<a href="#l65.15"></a><span id="l65.15">   border-width: 0 2px;</span>
<a href="#l65.16"></a><span id="l65.16">   -moz-appearance: none;</span>
<a href="#l65.17"></a><span id="l65.17"> }</span>
<a href="#l65.18"></a><span id="l65.18"> </span>
<a href="#l65.19"></a><span id="l65.19"> .tabbrowser-tab:not([selected=&quot;true&quot;]):-moz-locale-dir(ltr),</span>
<a href="#l65.20"></a><span id="l65.20"> .tabbrowser-tab:not([selected=&quot;true&quot;]):-moz-locale-dir(rtl):first-child {</span>
<a href="#l65.21"></a><span id="l65.21">   -moz-border-right-colors: transparent rgba(0, 0, 0, 0.19);</span>
<a href="#l65.22"></a><span id="l65.22" class="difflineat">@@ -179,17 +179,17 @@ tabpanels {</span>
<a href="#l65.23"></a><span id="l65.23"> </span>
<a href="#l65.24"></a><span id="l65.24"> .scrollbutton-up:hover:active:not([disabled=&quot;true&quot;]),</span>
<a href="#l65.25"></a><span id="l65.25"> .scrollbutton-down:hover:active:not([disabled=&quot;true&quot;]) {</span>
<a href="#l65.26"></a><span id="l65.26">   background-color: rgba(0, 0, 0, 0.2);</span>
<a href="#l65.27"></a><span id="l65.27"> }</span>
<a href="#l65.28"></a><span id="l65.28"> </span>
<a href="#l65.29"></a><span id="l65.29"> /* All Tabs Menupopup */</span>
<a href="#l65.30"></a><span id="l65.30"> .alltabs-item {</span>
<a href="#l65.31"></a><span id="l65.31" class="difflineminus">-  list-style-image: url(&quot;chrome://communicator/skin/bookmarks/bookmark-item.svg&quot;);</span>
<a href="#l65.32"></a><span id="l65.32" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/places/bookmark-item.svg&quot;);</span>
<a href="#l65.33"></a><span id="l65.33"> }</span>
<a href="#l65.34"></a><span id="l65.34"> </span>
<a href="#l65.35"></a><span id="l65.35"> .alltabs-item[busy] {</span>
<a href="#l65.36"></a><span id="l65.36">   list-style-image: url(&quot;chrome://communicator/skin/icons/loading.png&quot;) !important;</span>
<a href="#l65.37"></a><span id="l65.37"> }</span>
<a href="#l65.38"></a><span id="l65.38"> </span>
<a href="#l65.39"></a><span id="l65.39"> .alltabs-item[tabIsScrolled] {</span>
<a href="#l65.40"></a><span id="l65.40">   font-style: italic;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l66.1"></a><span id="l66.1" class="difflineminus">--- a/suite/themes/classic/navigator/navigator.css</span>
<a href="#l66.2"></a><span id="l66.2" class="difflineplus">+++ b/suite/themes/classic/navigator/navigator.css</span>
<a href="#l66.3"></a><span id="l66.3" class="difflineat">@@ -1,15 +1,15 @@</span>
<a href="#l66.4"></a><span id="l66.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l66.5"></a><span id="l66.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l66.6"></a><span id="l66.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l66.7"></a><span id="l66.7"> </span>
<a href="#l66.8"></a><span id="l66.8"> @import url(&quot;chrome://navigator/content/navigator.css&quot;);</span>
<a href="#l66.9"></a><span id="l66.9"> @import url(&quot;chrome://communicator/skin/&quot;);</span>
<a href="#l66.10"></a><span id="l66.10" class="difflineminus">-@import url(&quot;chrome://communicator/skin/bookmarks/bookmarksToolbar.css&quot;);</span>
<a href="#l66.11"></a><span id="l66.11" class="difflineplus">+@import url(&quot;chrome://communicator/skin/places/bookmarksToolbar.css&quot;);</span>
<a href="#l66.12"></a><span id="l66.12"> </span>
<a href="#l66.13"></a><span id="l66.13"> @namespace url(&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;);</span>
<a href="#l66.14"></a><span id="l66.14"> </span>
<a href="#l66.15"></a><span id="l66.15"> /* ::::: primary toolbar buttons ::::: */</span>
<a href="#l66.16"></a><span id="l66.16"> </span>
<a href="#l66.17"></a><span id="l66.17"> #back-button {</span>
<a href="#l66.18"></a><span id="l66.18">   list-style-image: url(&quot;chrome://communicator/skin/icons/communicatoricons.png&quot;);</span>
<a href="#l66.19"></a><span id="l66.19">   -moz-image-region: rect(60px 29px 89px 0);</span>
<a href="#l66.20"></a><span id="l66.20" class="difflineat">@@ -495,26 +495,26 @@ toolbar[mode=&quot;text&quot;] &gt; #window-controls </span>
<a href="#l66.21"></a><span id="l66.21"> }</span>
<a href="#l66.22"></a><span id="l66.22"> </span>
<a href="#l66.23"></a><span id="l66.23"> #page-proxy-deck {</span>
<a href="#l66.24"></a><span id="l66.24">   cursor: grab;</span>
<a href="#l66.25"></a><span id="l66.25">   margin: 3px;</span>
<a href="#l66.26"></a><span id="l66.26"> }</span>
<a href="#l66.27"></a><span id="l66.27"> </span>
<a href="#l66.28"></a><span id="l66.28"> #page-proxy-button {</span>
<a href="#l66.29"></a><span id="l66.29" class="difflineminus">-  list-style-image: url(&quot;chrome://communicator/skin/bookmarks/bookmark-item.svg&quot;); </span>
<a href="#l66.30"></a><span id="l66.30" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/places/bookmark-item.svg&quot;); </span>
<a href="#l66.31"></a><span id="l66.31"> }</span>
<a href="#l66.32"></a><span id="l66.32"> </span>
<a href="#l66.33"></a><span id="l66.33"> #page-proxy-favicon {</span>
<a href="#l66.34"></a><span id="l66.34">   list-style-image: none;</span>
<a href="#l66.35"></a><span id="l66.35"> }</span>
<a href="#l66.36"></a><span id="l66.36"> </span>
<a href="#l66.37"></a><span id="l66.37"> #page-proxy-button[pageproxystate=&quot;invalid&quot;] {</span>
<a href="#l66.38"></a><span id="l66.38">   cursor: default;</span>
<a href="#l66.39"></a><span id="l66.39" class="difflineminus">-  list-style-image: url(&quot;chrome://communicator/skin/bookmarks/bookmark-item-dis.png&quot;);</span>
<a href="#l66.40"></a><span id="l66.40" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/places/bookmark-item-dis.png&quot;);</span>
<a href="#l66.41"></a><span id="l66.41"> }</span>
<a href="#l66.42"></a><span id="l66.42"> </span>
<a href="#l66.43"></a><span id="l66.43"> /* ::::: autocomplete ::::: */</span>
<a href="#l66.44"></a><span id="l66.44"> </span>
<a href="#l66.45"></a><span id="l66.45"> #PopupAutoComplete &gt; richlistbox &gt; richlistitem {</span>
<a href="#l66.46"></a><span id="l66.46">   height: 20px;</span>
<a href="#l66.47"></a><span id="l66.47">   min-height: 20px;</span>
<a href="#l66.48"></a><span id="l66.48">   border: 0;</span>
<a href="#l66.49"></a><span id="l66.49" class="difflineat">@@ -681,21 +681,21 @@ toolbar[mode=&quot;icons&quot;] #search-button &gt; .</span>
<a href="#l66.50"></a><span id="l66.50">   color: InfoText;</span>
<a href="#l66.51"></a><span id="l66.51">   font: message-box;</span>
<a href="#l66.52"></a><span id="l66.52">   font-weight: bold;</span>
<a href="#l66.53"></a><span id="l66.53"> }</span>
<a href="#l66.54"></a><span id="l66.54"> </span>
<a href="#l66.55"></a><span id="l66.55"> /* ::::: personal toolbar ::::: */</span>
<a href="#l66.56"></a><span id="l66.56"> </span>
<a href="#l66.57"></a><span id="l66.57"> #bookmarks-button {</span>
<a href="#l66.58"></a><span id="l66.58" class="difflineminus">-  list-style-image: url(&quot;chrome://communicator/skin/bookmarks/bookmark-folder-closed.png&quot;);</span>
<a href="#l66.59"></a><span id="l66.59" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/places/bookmark-folder-closed.png&quot;);</span>
<a href="#l66.60"></a><span id="l66.60"> }</span>
<a href="#l66.61"></a><span id="l66.61"> </span>
<a href="#l66.62"></a><span id="l66.62"> #bookmarks-button[open=&quot;true&quot;] {</span>
<a href="#l66.63"></a><span id="l66.63" class="difflineminus">-  list-style-image: url(&quot;chrome://communicator/skin/bookmarks/bookmark-folder-open.png&quot;);</span>
<a href="#l66.64"></a><span id="l66.64" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/places/bookmark-folder-open.png&quot;);</span>
<a href="#l66.65"></a><span id="l66.65"> }</span>
<a href="#l66.66"></a><span id="l66.66"> </span>
<a href="#l66.67"></a><span id="l66.67"> toolbarbutton.chevron {</span>
<a href="#l66.68"></a><span id="l66.68">   list-style-image: url(&quot;chrome://navigator/skin/icons/chevron.gif&quot;) !important;</span>
<a href="#l66.69"></a><span id="l66.69"> }</span>
<a href="#l66.70"></a><span id="l66.70"> </span>
<a href="#l66.71"></a><span id="l66.71"> toolbarbutton.chevron &gt; .toolbarbutton-menu-dropmarker {</span>
<a href="#l66.72"></a><span id="l66.72">   display: none;</span>
<a href="#l66.73"></a><span id="l66.73" class="difflineat">@@ -734,31 +734,31 @@ toolbar[mode=&quot;text&quot;] toolbarbutton.chevr</span>
<a href="#l66.74"></a><span id="l66.74">   text-decoration: none !important;</span>
<a href="#l66.75"></a><span id="l66.75"> }</span>
<a href="#l66.76"></a><span id="l66.76"> </span>
<a href="#l66.77"></a><span id="l66.77"> /*</span>
<a href="#l66.78"></a><span id="l66.78">   In customize mode we hide the normal bookmark items and show a placeholder</span>
<a href="#l66.79"></a><span id="l66.79">   for the drag/drop UI.</span>
<a href="#l66.80"></a><span id="l66.80"> */</span>
<a href="#l66.81"></a><span id="l66.81"> .bookmarks-toolbar-customize {</span>
<a href="#l66.82"></a><span id="l66.82" class="difflineminus">-  list-style-image: url(&quot;chrome://communicator/skin/bookmarks/bookmarksToolbar.png&quot;);</span>
<a href="#l66.83"></a><span id="l66.83" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/places/bookmarksToolbar.png&quot;);</span>
<a href="#l66.84"></a><span id="l66.84">   display: none;</span>
<a href="#l66.85"></a><span id="l66.85">   max-width: 15em !important;</span>
<a href="#l66.86"></a><span id="l66.86"> }</span>
<a href="#l66.87"></a><span id="l66.87"> </span>
<a href="#l66.88"></a><span id="l66.88"> #wrapper-personal-bookmarks[place=&quot;palette&quot;] &gt; .toolbarpaletteitem-box {</span>
<a href="#l66.89"></a><span id="l66.89">   width: 16px;</span>
<a href="#l66.90"></a><span id="l66.90">   height: 16px;</span>
<a href="#l66.91"></a><span id="l66.91" class="difflineminus">-  background: url(&quot;chrome://communicator/skin/bookmarks/bookmarksToolbar.png&quot;) no-repeat;</span>
<a href="#l66.92"></a><span id="l66.92" class="difflineplus">+  background: url(&quot;chrome://communicator/skin/places/bookmarksToolbar.png&quot;) no-repeat;</span>
<a href="#l66.93"></a><span id="l66.93"> }</span>
<a href="#l66.94"></a><span id="l66.94"> </span>
<a href="#l66.95"></a><span id="l66.95"> /* ::::: star button ::::: */</span>
<a href="#l66.96"></a><span id="l66.96"> </span>
<a href="#l66.97"></a><span id="l66.97"> #star-button {</span>
<a href="#l66.98"></a><span id="l66.98" class="difflineminus">-  list-style-image: url(&quot;chrome://communicator/skin/bookmarks/bookmark.png&quot;);</span>
<a href="#l66.99"></a><span id="l66.99" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/places/bookmark.png&quot;);</span>
<a href="#l66.100"></a><span id="l66.100">   -moz-image-region: rect(16px 16px 32px 0px);</span>
<a href="#l66.101"></a><span id="l66.101"> }</span>
<a href="#l66.102"></a><span id="l66.102"> </span>
<a href="#l66.103"></a><span id="l66.103"> #star-button:hover {</span>
<a href="#l66.104"></a><span id="l66.104">   -moz-image-region: rect(16px 32px 32px 16px);</span>
<a href="#l66.105"></a><span id="l66.105"> }</span>
<a href="#l66.106"></a><span id="l66.106"> </span>
<a href="#l66.107"></a><span id="l66.107"> #star-button:hover:active {</span>
<a href="#l66.108"></a><span id="l66.108" class="difflineat">@@ -773,17 +773,17 @@ toolbar[mode=&quot;text&quot;] toolbarbutton.chevr</span>
<a href="#l66.109"></a><span id="l66.109">   -moz-image-region: rect(0px 32px 16px 16px);</span>
<a href="#l66.110"></a><span id="l66.110"> }</span>
<a href="#l66.111"></a><span id="l66.111"> </span>
<a href="#l66.112"></a><span id="l66.112"> #star-button[starred=&quot;true&quot;]:hover:active {</span>
<a href="#l66.113"></a><span id="l66.113">   -moz-image-region: rect(0px 48px 16px 32px);</span>
<a href="#l66.114"></a><span id="l66.114"> }</span>
<a href="#l66.115"></a><span id="l66.115"> </span>
<a href="#l66.116"></a><span id="l66.116"> #editBookmarkPanelStarIcon {</span>
<a href="#l66.117"></a><span id="l66.117" class="difflineminus">-  list-style-image: url(&quot;chrome://communicator/skin/bookmarks/bookmark.png&quot;);</span>
<a href="#l66.118"></a><span id="l66.118" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/places/bookmark.png&quot;);</span>
<a href="#l66.119"></a><span id="l66.119">   -moz-image-region: rect(0px 16px 16px 0px);</span>
<a href="#l66.120"></a><span id="l66.120"> }</span>
<a href="#l66.121"></a><span id="l66.121"> </span>
<a href="#l66.122"></a><span id="l66.122"> /* ::::: feeds ::::: */</span>
<a href="#l66.123"></a><span id="l66.123"> </span>
<a href="#l66.124"></a><span id="l66.124"> .feedsMenu {</span>
<a href="#l66.125"></a><span id="l66.125">   list-style-image: url(&quot;chrome://navigator/skin/btn1/feeds.png&quot;);</span>
<a href="#l66.126"></a><span id="l66.126">   -moz-image-region: rect(0px 16px 16px 0px);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l67.1"></a><span id="l67.1" class="difflineminus">--- a/suite/themes/classic/navigator/tabbrowser.css</span>
<a href="#l67.2"></a><span id="l67.2" class="difflineplus">+++ b/suite/themes/classic/navigator/tabbrowser.css</span>
<a href="#l67.3"></a><span id="l67.3" class="difflineat">@@ -31,17 +31,17 @@ tabpanels {</span>
<a href="#l67.4"></a><span id="l67.4">   margin-top: 1px;</span>
<a href="#l67.5"></a><span id="l67.5">   margin-inline-start: 1px;</span>
<a href="#l67.6"></a><span id="l67.6">   margin-inline-end: 4px;</span>
<a href="#l67.7"></a><span id="l67.7">   width: 16px;</span>
<a href="#l67.8"></a><span id="l67.8">   height: 16px;</span>
<a href="#l67.9"></a><span id="l67.9"> }</span>
<a href="#l67.10"></a><span id="l67.10"> </span>
<a href="#l67.11"></a><span id="l67.11"> .tabbrowser-tab {</span>
<a href="#l67.12"></a><span id="l67.12" class="difflineminus">-  list-style-image: url(&quot;chrome://communicator/skin/bookmarks/bookmark-item.svg&quot;);</span>
<a href="#l67.13"></a><span id="l67.13" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/places/bookmark-item.svg&quot;);</span>
<a href="#l67.14"></a><span id="l67.14">   padding: 0px 2px 2px;</span>
<a href="#l67.15"></a><span id="l67.15">   margin-bottom: 1px;</span>
<a href="#l67.16"></a><span id="l67.16">   border-bottom: none;</span>
<a href="#l67.17"></a><span id="l67.17"> }</span>
<a href="#l67.18"></a><span id="l67.18"> </span>
<a href="#l67.19"></a><span id="l67.19"> .tabbrowser-tab[busy] {</span>
<a href="#l67.20"></a><span id="l67.20">   list-style-image: url(&quot;chrome://communicator/skin/icons/loading.gif&quot;);</span>
<a href="#l67.21"></a><span id="l67.21"> }</span>
<a href="#l67.22"></a><span id="l67.22" class="difflineat">@@ -146,17 +146,17 @@ tabpanels {</span>
<a href="#l67.23"></a><span id="l67.23"> }</span>
<a href="#l67.24"></a><span id="l67.24"> </span>
<a href="#l67.25"></a><span id="l67.25"> .tabs-alltabs-button &gt; .toolbarbutton-icon {</span>
<a href="#l67.26"></a><span id="l67.26">   margin: 0px !important;</span>
<a href="#l67.27"></a><span id="l67.27"> }</span>
<a href="#l67.28"></a><span id="l67.28"> </span>
<a href="#l67.29"></a><span id="l67.29"> /* All tabs menupopup */</span>
<a href="#l67.30"></a><span id="l67.30"> .alltabs-item {</span>
<a href="#l67.31"></a><span id="l67.31" class="difflineminus">-  list-style-image: url(&quot;chrome://communicator/skin/bookmarks/bookmark-item.svg&quot;);</span>
<a href="#l67.32"></a><span id="l67.32" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/places/bookmark-item.svg&quot;);</span>
<a href="#l67.33"></a><span id="l67.33"> }</span>
<a href="#l67.34"></a><span id="l67.34"> </span>
<a href="#l67.35"></a><span id="l67.35"> .alltabs-item[selected=&quot;true&quot;] {</span>
<a href="#l67.36"></a><span id="l67.36">   font-weight: bold;</span>
<a href="#l67.37"></a><span id="l67.37"> }</span>
<a href="#l67.38"></a><span id="l67.38"> </span>
<a href="#l67.39"></a><span id="l67.39"> .alltabs-item[busy] {</span>
<a href="#l67.40"></a><span id="l67.40">   list-style-image: url(&quot;chrome://communicator/skin/icons/loading.gif&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l68.1"></a><span id="l68.1" class="difflineminus">--- a/suite/themes/modern/communicator/aboutSessionRestore.css</span>
<a href="#l68.2"></a><span id="l68.2" class="difflineplus">+++ b/suite/themes/modern/communicator/aboutSessionRestore.css</span>
<a href="#l68.3"></a><span id="l68.3" class="difflineat">@@ -11,25 +11,25 @@ treechildren::-moz-tree-image(icon),</span>
<a href="#l68.4"></a><span id="l68.4"> treechildren::-moz-tree-image(noicon) {</span>
<a href="#l68.5"></a><span id="l68.5">   padding-right: 2px;</span>
<a href="#l68.6"></a><span id="l68.6">   margin: 0px 2px;</span>
<a href="#l68.7"></a><span id="l68.7">   width: 16px;</span>
<a href="#l68.8"></a><span id="l68.8">   height: 16px;</span>
<a href="#l68.9"></a><span id="l68.9"> }</span>
<a href="#l68.10"></a><span id="l68.10"> </span>
<a href="#l68.11"></a><span id="l68.11"> treechildren::-moz-tree-image(noicon) {</span>
<a href="#l68.12"></a><span id="l68.12" class="difflineminus">-  list-style-image: url(&quot;chrome://communicator/skin/bookmarks/bookmark-item.svg&quot;);</span>
<a href="#l68.13"></a><span id="l68.13" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/places/bookmark-item.svg&quot;);</span>
<a href="#l68.14"></a><span id="l68.14"> }</span>
<a href="#l68.15"></a><span id="l68.15"> </span>
<a href="#l68.16"></a><span id="l68.16"> treechildren::-moz-tree-image(container, noicon) {</span>
<a href="#l68.17"></a><span id="l68.17" class="difflineminus">-  list-style-image: url(&quot;chrome://communicator/skin/bookmarks/bookmark-folder-closed.gif&quot;);</span>
<a href="#l68.18"></a><span id="l68.18" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/places/bookmark-folder-closed.gif&quot;);</span>
<a href="#l68.19"></a><span id="l68.19"> }</span>
<a href="#l68.20"></a><span id="l68.20"> </span>
<a href="#l68.21"></a><span id="l68.21"> treechildren::-moz-tree-image(container, noicon, open) {</span>
<a href="#l68.22"></a><span id="l68.22" class="difflineminus">-  list-style-image: url(&quot;chrome://communicator/skin/bookmarks/bookmark-folder-open.gif&quot;);</span>
<a href="#l68.23"></a><span id="l68.23" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/places/bookmark-folder-open.gif&quot;);</span>
<a href="#l68.24"></a><span id="l68.24"> }</span>
<a href="#l68.25"></a><span id="l68.25"> </span>
<a href="#l68.26"></a><span id="l68.26"> treechildren::-moz-tree-checkbox {</span>
<a href="#l68.27"></a><span id="l68.27">   list-style-image: url(&quot;chrome://global/skin/checkbox/cbox.gif&quot;);</span>
<a href="#l68.28"></a><span id="l68.28"> }</span>
<a href="#l68.29"></a><span id="l68.29"> </span>
<a href="#l68.30"></a><span id="l68.30"> treechildren::-moz-tree-checkbox(checked) {</span>
<a href="#l68.31"></a><span id="l68.31">   list-style-image: url(&quot;chrome://global/skin/checkbox/cbox-check.gif&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l69.1"></a><span id="l69.1" class="difflineminus">--- a/suite/themes/modern/communicator/communicator.css</span>
<a href="#l69.2"></a><span id="l69.2" class="difflineplus">+++ b/suite/themes/modern/communicator/communicator.css</span>
<a href="#l69.3"></a><span id="l69.3" class="difflineat">@@ -27,21 +27,21 @@</span>
<a href="#l69.4"></a><span id="l69.4"> textbox[autocompletesearch=&quot;history file&quot;] .autocomplete-treebody::-moz-tree-image(treecolAutoCompleteValue) {</span>
<a href="#l69.5"></a><span id="l69.5">   width: 16px;</span>
<a href="#l69.6"></a><span id="l69.6">   height: 16px;</span>
<a href="#l69.7"></a><span id="l69.7">   margin-left: 1px;</span>
<a href="#l69.8"></a><span id="l69.8"> }</span>
<a href="#l69.9"></a><span id="l69.9"> </span>
<a href="#l69.10"></a><span id="l69.10"> textbox[autocompletesearch=&quot;history file&quot;] .autocomplete-treebody::-moz-tree-image(treecolAutoCompleteValue, directory) {</span>
<a href="#l69.11"></a><span id="l69.11">   /*list-style-image: url(&quot;chrome://global/skin/filepicker/dir-closed.gif&quot;);*/</span>
<a href="#l69.12"></a><span id="l69.12" class="difflineminus">-  list-style-image: url(&quot;chrome://communicator/skin/bookmarks/bookmark-folder-closed.gif&quot;);</span>
<a href="#l69.13"></a><span id="l69.13" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/places/bookmark-folder-closed.gif&quot;);</span>
<a href="#l69.14"></a><span id="l69.14"> }</span>
<a href="#l69.15"></a><span id="l69.15"> </span>
<a href="#l69.16"></a><span id="l69.16"> textbox[autocompletesearch=&quot;history file&quot;] .autocomplete-treebody::-moz-tree-image(treecolAutoCompleteValue, file) {</span>
<a href="#l69.17"></a><span id="l69.17" class="difflineminus">-  list-style-image: url(&quot;chrome://communicator/skin/bookmarks/bookmark-item.svg&quot;);</span>
<a href="#l69.18"></a><span id="l69.18" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/places/bookmark-item.svg&quot;);</span>
<a href="#l69.19"></a><span id="l69.19"> }</span>
<a href="#l69.20"></a><span id="l69.20"> </span>
<a href="#l69.21"></a><span id="l69.21"> /* ::::: online/offline icons ::::: */</span>
<a href="#l69.22"></a><span id="l69.22"> </span>
<a href="#l69.23"></a><span id="l69.23"> #offline-status[offline=&quot;true&quot;] {</span>
<a href="#l69.24"></a><span id="l69.24">   list-style-image: url(&quot;chrome://communicator/skin/icons/offline.gif&quot;);</span>
<a href="#l69.25"></a><span id="l69.25"> }</span>
<a href="#l69.26"></a><span id="l69.26"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l70.1"></a><span id="l70.1" class="difflineminus">--- a/suite/themes/modern/communicator/places/bookmarks.css</span>
<a href="#l70.2"></a><span id="l70.2" class="difflineplus">+++ b/suite/themes/modern/communicator/places/bookmarks.css</span>
<a href="#l70.3"></a><span id="l70.3" class="difflineat">@@ -13,111 +13,111 @@</span>
<a href="#l70.4"></a><span id="l70.4"> treechildren::-moz-tree-image(Name),</span>
<a href="#l70.5"></a><span id="l70.5"> treechildren::-moz-tree-image(title) {</span>
<a href="#l70.6"></a><span id="l70.6">   margin-inline-end: 2px;</span>
<a href="#l70.7"></a><span id="l70.7">   width: 16px;</span>
<a href="#l70.8"></a><span id="l70.8">   height: 16px;</span>
<a href="#l70.9"></a><span id="l70.9"> }</span>
<a href="#l70.10"></a><span id="l70.10"> </span>
<a href="#l70.11"></a><span id="l70.11"> .bookmark-item,</span>
<a href="#l70.12"></a><span id="l70.12" class="difflineminus">-treechildren::-moz-tree-image(Name),</span>
<a href="#l70.13"></a><span id="l70.13"> treechildren::-moz-tree-image(title) {</span>
<a href="#l70.14"></a><span id="l70.14" class="difflineminus">-  list-style-image: url(&quot;chrome://communicator/skin/bookmarks/bookmark-item.svg&quot;);</span>
<a href="#l70.15"></a><span id="l70.15" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/places/bookmark-item.svg&quot;);</span>
<a href="#l70.16"></a><span id="l70.16"> }</span>
<a href="#l70.17"></a><span id="l70.17"> </span>
<a href="#l70.18"></a><span id="l70.18"> .bookmark-item[container=&quot;true&quot;],</span>
<a href="#l70.19"></a><span id="l70.19" class="difflineminus">-treechildren::-moz-tree-image(Name, container),</span>
<a href="#l70.20"></a><span id="l70.20"> treechildren::-moz-tree-image(title, container) {</span>
<a href="#l70.21"></a><span id="l70.21" class="difflineminus">-  list-style-image: url(&quot;chrome://communicator/skin/bookmarks/bookmark-folder-closed.gif&quot;);</span>
<a href="#l70.22"></a><span id="l70.22" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/places/bookmark-folder-closed.gif&quot;);</span>
<a href="#l70.23"></a><span id="l70.23"> }</span>
<a href="#l70.24"></a><span id="l70.24"> </span>
<a href="#l70.25"></a><span id="l70.25"> .bookmark-item[open=&quot;true&quot;],</span>
<a href="#l70.26"></a><span id="l70.26" class="difflineminus">-treechildren::-moz-tree-image(Name, open),</span>
<a href="#l70.27"></a><span id="l70.27"> treechildren::-moz-tree-image(title, open) {</span>
<a href="#l70.28"></a><span id="l70.28" class="difflineminus">-  list-style-image: url(&quot;chrome://communicator/skin/bookmarks/bookmark-folder-open.gif&quot;);</span>
<a href="#l70.29"></a><span id="l70.29" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/places/bookmark-folder-open.gif&quot;);</span>
<a href="#l70.30"></a><span id="l70.30"> }</span>
<a href="#l70.31"></a><span id="l70.31"> </span>
<a href="#l70.32"></a><span id="l70.32"> .bookmark-item[container=&quot;true&quot;][open=&quot;true&quot;][loading=&quot;true&quot;] {</span>
<a href="#l70.33"></a><span id="l70.33">   list-style-image: url(&quot;chrome://communicator/skin/icons/loading.gif&quot;) !important;</span>
<a href="#l70.34"></a><span id="l70.34"> }</span>
<a href="#l70.35"></a><span id="l70.35"> </span>
<a href="#l70.36"></a><span id="l70.36"> .bookmark-item &gt; .toolbarbutton-box &gt; .toolbarbutton-icon {</span>
<a href="#l70.37"></a><span id="l70.37">   list-style-image: inherit;</span>
<a href="#l70.38"></a><span id="l70.38">   width: 16px;</span>
<a href="#l70.39"></a><span id="l70.39">   height: 16px;</span>
<a href="#l70.40"></a><span id="l70.40"> }</span>
<a href="#l70.41"></a><span id="l70.41"> </span>
<a href="#l70.42"></a><span id="l70.42" class="difflineminus">-/* calendar icon for folders grouping items by day */</span>
<a href="#l70.43"></a><span id="l70.43" class="difflineminus">-treechildren::-moz-tree-image(Name, query, dayContainer) {</span>
<a href="#l70.44"></a><span id="l70.44" class="difflineminus">-  list-style-image: url(&quot;chrome://communicator/skin/history/calendar.png&quot;);</span>
<a href="#l70.45"></a><span id="l70.45" class="difflineminus">-}</span>
<a href="#l70.46"></a><span id="l70.46" class="difflineminus">-</span>
<a href="#l70.47"></a><span id="l70.47"> .bookmark-item[container][livemark],</span>
<a href="#l70.48"></a><span id="l70.48"> treechildren::-moz-tree-image(title, container, livemark) {</span>
<a href="#l70.49"></a><span id="l70.49" class="difflineminus">-  list-style-image: url(&quot;chrome://communicator/skin/bookmarks/livemark-folder.png&quot;);</span>
<a href="#l70.50"></a><span id="l70.50" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/places/livemark-folder.png&quot;);</span>
<a href="#l70.51"></a><span id="l70.51">   -moz-image-region: auto;</span>
<a href="#l70.52"></a><span id="l70.52"> }</span>
<a href="#l70.53"></a><span id="l70.53"> </span>
<a href="#l70.54"></a><span id="l70.54"> .bookmark-item[container][livemark] .bookmark-item,</span>
<a href="#l70.55"></a><span id="l70.55"> treechildren::-moz-tree-image(title, livemarkItem) {</span>
<a href="#l70.56"></a><span id="l70.56" class="difflineminus">-  list-style-image: url(&quot;chrome://communicator/skin/bookmarks/bookmark-item-updated.gif&quot;);</span>
<a href="#l70.57"></a><span id="l70.57" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/places/bookmark-item-updated.gif&quot;);</span>
<a href="#l70.58"></a><span id="l70.58"> }</span>
<a href="#l70.59"></a><span id="l70.59"> </span>
<a href="#l70.60"></a><span id="l70.60"> .bookmark-item[container][livemark] .bookmark-item[visited],</span>
<a href="#l70.61"></a><span id="l70.61"> treechildren::-moz-tree-image(title, livemarkItem, visited) {</span>
<a href="#l70.62"></a><span id="l70.62" class="difflineminus">-  list-style-image: url(&quot;chrome://communicator/skin/bookmarks/bookmark-item.svg&quot;);</span>
<a href="#l70.63"></a><span id="l70.63" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/places/bookmark-item.svg&quot;);</span>
<a href="#l70.64"></a><span id="l70.64"> }</span>
<a href="#l70.65"></a><span id="l70.65"> </span>
<a href="#l70.66"></a><span id="l70.66"> treechildren::-moz-tree-image(container, OrganizerQuery_AllBookmarks) {</span>
<a href="#l70.67"></a><span id="l70.67" class="difflineminus">-  list-style-image: url(&quot;chrome://communicator/skin/bookmarks/allBookmarks.png&quot;);</span>
<a href="#l70.68"></a><span id="l70.68" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/places/allBookmarks.png&quot;);</span>
<a href="#l70.69"></a><span id="l70.69">   -moz-image-region: auto;</span>
<a href="#l70.70"></a><span id="l70.70"> }</span>
<a href="#l70.71"></a><span id="l70.71"> </span>
<a href="#l70.72"></a><span id="l70.72"> #bookmarksToolbarFolderMenu,</span>
<a href="#l70.73"></a><span id="l70.73"> #BMB_bookmarksToolbarFolderMenu,</span>
<a href="#l70.74"></a><span id="l70.74"> treechildren::-moz-tree-image(container, OrganizerQuery_BookmarksToolbar) {</span>
<a href="#l70.75"></a><span id="l70.75" class="difflineminus">-  list-style-image: url(&quot;chrome://communicator/skin/bookmarks/bookmarksToolbar.png&quot;);</span>
<a href="#l70.76"></a><span id="l70.76" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/places/bookmarksToolbar.png&quot;);</span>
<a href="#l70.77"></a><span id="l70.77">   -moz-image-region: auto;</span>
<a href="#l70.78"></a><span id="l70.78"> }</span>
<a href="#l70.79"></a><span id="l70.79"> </span>
<a href="#l70.80"></a><span id="l70.80"> treechildren::-moz-tree-image(container, OrganizerQuery_BookmarksMenu) {</span>
<a href="#l70.81"></a><span id="l70.81" class="difflineminus">-  list-style-image: url(&quot;chrome://communicator/skin/bookmarks/bookmarksMenu.png&quot;);</span>
<a href="#l70.82"></a><span id="l70.82" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/places/bookmarksMenu.png&quot;);</span>
<a href="#l70.83"></a><span id="l70.83">   -moz-image-region: auto;</span>
<a href="#l70.84"></a><span id="l70.84"> }</span>
<a href="#l70.85"></a><span id="l70.85"> </span>
<a href="#l70.86"></a><span id="l70.86"> #unsortedBookmarksFolderMenu,</span>
<a href="#l70.87"></a><span id="l70.87"> #BMB_unsortedBookmarksFolderMenu,</span>
<a href="#l70.88"></a><span id="l70.88"> treechildren::-moz-tree-image(container, OrganizerQuery_UnfiledBookmarks) {</span>
<a href="#l70.89"></a><span id="l70.89" class="difflineminus">-  list-style-image: url(&quot;chrome://communicator/skin/bookmarks/unsortedBookmarks.png&quot;);</span>
<a href="#l70.90"></a><span id="l70.90" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/places/unsortedBookmarks.png&quot;);</span>
<a href="#l70.91"></a><span id="l70.91">   -moz-image-region: auto;</span>
<a href="#l70.92"></a><span id="l70.92"> }</span>
<a href="#l70.93"></a><span id="l70.93"> </span>
<a href="#l70.94"></a><span id="l70.94"> /* query-nodes should be styled even if they're not expandable */</span>
<a href="#l70.95"></a><span id="l70.95"> .bookmark-item[container][query],</span>
<a href="#l70.96"></a><span id="l70.96" class="difflineminus">-treechildren::-moz-tree-image(title, query) {</span>
<a href="#l70.97"></a><span id="l70.97" class="difflineminus">-  list-style-image: url(&quot;chrome://communicator/skin/bookmarks/query.png&quot;);</span>
<a href="#l70.98"></a><span id="l70.98" class="difflineplus">+treechildren::-moz-tree-image(query) {</span>
<a href="#l70.99"></a><span id="l70.99" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/places/query.png&quot;);</span>
<a href="#l70.100"></a><span id="l70.100">   -moz-image-region: auto;</span>
<a href="#l70.101"></a><span id="l70.101"> }</span>
<a href="#l70.102"></a><span id="l70.102"> </span>
<a href="#l70.103"></a><span id="l70.103"> .bookmark-item[query][tagContainer],</span>
<a href="#l70.104"></a><span id="l70.104"> treechildren::-moz-tree-image(title, query, tagContainer),</span>
<a href="#l70.105"></a><span id="l70.105"> treechildren::-moz-tree-image(query, OrganizerQuery_Tags) {</span>
<a href="#l70.106"></a><span id="l70.106" class="difflineminus">-  list-style-image: url(&quot;chrome://communicator/skin/bookmarks/tag.png&quot;);</span>
<a href="#l70.107"></a><span id="l70.107" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/places/tag.png&quot;);</span>
<a href="#l70.108"></a><span id="l70.108">   -moz-image-region: auto;</span>
<a href="#l70.109"></a><span id="l70.109"> }</span>
<a href="#l70.110"></a><span id="l70.110"> </span>
<a href="#l70.111"></a><span id="l70.111" class="difflineminus">-treechildren::-moz-tree-image(Name, separator),</span>
<a href="#l70.112"></a><span id="l70.112" class="difflineplus">+/* calendar icon for folders grouping items by day */</span>
<a href="#l70.113"></a><span id="l70.113" class="difflineplus">+treechildren::-moz-tree-image(title, query, dayContainer) {</span>
<a href="#l70.114"></a><span id="l70.114" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/places/calendar.png&quot;);</span>
<a href="#l70.115"></a><span id="l70.115" class="difflineplus">+  -moz-image-region: auto;</span>
<a href="#l70.116"></a><span id="l70.116" class="difflineplus">+}</span>
<a href="#l70.117"></a><span id="l70.117" class="difflineplus">+</span>
<a href="#l70.118"></a><span id="l70.118" class="difflineplus">+treechildren::-moz-tree-image(query, OrganizerQuery_History) {</span>
<a href="#l70.119"></a><span id="l70.119" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/places/history.png&quot;);</span>
<a href="#l70.120"></a><span id="l70.120" class="difflineplus">+  -moz-image-region: auto;</span>
<a href="#l70.121"></a><span id="l70.121" class="difflineplus">+}</span>
<a href="#l70.122"></a><span id="l70.122" class="difflineplus">+</span>
<a href="#l70.123"></a><span id="l70.123"> treechildren::-moz-tree-image(title, separator) {</span>
<a href="#l70.124"></a><span id="l70.124">   list-style-image: none;</span>
<a href="#l70.125"></a><span id="l70.125">   width: 0px;</span>
<a href="#l70.126"></a><span id="l70.126">   height: 0px;</span>
<a href="#l70.127"></a><span id="l70.127"> }</span>
<a href="#l70.128"></a><span id="l70.128"> </span>
<a href="#l70.129"></a><span id="l70.129" class="difflineminus">-treechildren::-moz-tree-cell-text(Name, separator),</span>
<a href="#l70.130"></a><span id="l70.130"> treechildren::-moz-tree-cell-text(title, separator) {</span>
<a href="#l70.131"></a><span id="l70.131">   color: #808080;</span>
<a href="#l70.132"></a><span id="l70.132">   margin: 0px 5px;</span>
<a href="#l70.133"></a><span id="l70.133"> }</span>
<a href="#l70.134"></a><span id="l70.134"> </span>
<a href="#l70.135"></a><span id="l70.135" class="difflineminus">-treechildren::-moz-tree-cell-text(Name, separator, selected, focus),</span>
<a href="#l70.136"></a><span id="l70.136"> treechildren::-moz-tree-cell-text(title, separator, selected, focus) {</span>
<a href="#l70.137"></a><span id="l70.137">   color: #FFFFFF;</span>
<a href="#l70.138"></a><span id="l70.138"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l71.1"></a><span id="l71.1" class="difflineminus">--- a/suite/themes/modern/communicator/places/bookmarksToolbar.css</span>
<a href="#l71.2"></a><span id="l71.2" class="difflineplus">+++ b/suite/themes/modern/communicator/places/bookmarksToolbar.css</span>
<a href="#l71.3"></a><span id="l71.3" class="difflineat">@@ -1,26 +1,26 @@</span>
<a href="#l71.4"></a><span id="l71.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l71.5"></a><span id="l71.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l71.6"></a><span id="l71.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l71.7"></a><span id="l71.7" class="difflineminus">- </span>
<a href="#l71.8"></a><span id="l71.8" class="difflineplus">+</span>
<a href="#l71.9"></a><span id="l71.9"> /* ===== bookmarksToolbar.css ===========================================</span>
<a href="#l71.10"></a><span id="l71.10">   == Styles specific to bookmark items in a toolbar.</span>
<a href="#l71.11"></a><span id="l71.11">   ======================================================================= */</span>
<a href="#l71.12"></a><span id="l71.12"> </span>
<a href="#l71.13"></a><span id="l71.13" class="difflineminus">-@import url(&quot;chrome://communicator/skin/bookmarks/bookmarks.css&quot;);</span>
<a href="#l71.14"></a><span id="l71.14" class="difflineplus">+@import url(&quot;chrome://communicator/skin/places/bookmarks.css&quot;);</span>
<a href="#l71.15"></a><span id="l71.15"> </span>
<a href="#l71.16"></a><span id="l71.16"> /* ::::: bookmark toolbar buttons ::::: */</span>
<a href="#l71.17"></a><span id="l71.17"> </span>
<a href="#l71.18"></a><span id="l71.18"> /* ..... bookmark items ..... */</span>
<a href="#l71.19"></a><span id="l71.19"> </span>
<a href="#l71.20"></a><span id="l71.20"> toolbarbutton.bookmark-item {</span>
<a href="#l71.21"></a><span id="l71.21">   cursor: pointer;</span>
<a href="#l71.22"></a><span id="l71.22">   min-width: 0;</span>
<a href="#l71.23"></a><span id="l71.23" class="difflineminus">-  max-width: 10em;  </span>
<a href="#l71.24"></a><span id="l71.24" class="difflineplus">+  max-width: 10em;</span>
<a href="#l71.25"></a><span id="l71.25"> }</span>
<a href="#l71.26"></a><span id="l71.26"> </span>
<a href="#l71.27"></a><span id="l71.27"> toolbarbutton.bookmark-item:hover {</span>
<a href="#l71.28"></a><span id="l71.28">   text-decoration: underline;</span>
<a href="#l71.29"></a><span id="l71.29"> }</span>
<a href="#l71.30"></a><span id="l71.30"> </span>
<a href="#l71.31"></a><span id="l71.31"> toolbarbutton.bookmark-item[container=&quot;true&quot;],</span>
<a href="#l71.32"></a><span id="l71.32"> toolbarbutton.bookmark-item[container=&quot;true&quot;]:hover {</span>
<a href="#l71.33"></a><span id="l71.33" class="difflineat">@@ -32,21 +32,21 @@ toolbarbutton.bookmark-item[container=&quot;t</span>
<a href="#l71.34"></a><span id="l71.34"> toolbarbutton.bookmark-item:not([container=&quot;true&quot;]):hover,</span>
<a href="#l71.35"></a><span id="l71.35"> toolbarbutton.bookmark-item:not([container=&quot;true&quot;]):hover:active {</span>
<a href="#l71.36"></a><span id="l71.36">   border: 1px solid transparent;</span>
<a href="#l71.37"></a><span id="l71.37"> }</span>
<a href="#l71.38"></a><span id="l71.38"> </span>
<a href="#l71.39"></a><span id="l71.39"> toolbarbutton.bookmark-item[disabled=&quot;true&quot;] {</span>
<a href="#l71.40"></a><span id="l71.40">   cursor: default !important;</span>
<a href="#l71.41"></a><span id="l71.41">   text-decoration: none !important;</span>
<a href="#l71.42"></a><span id="l71.42" class="difflineminus">-  list-style-image: url(&quot;chrome://communicator/skin/bookmarks/bookmark-item-dis.gif&quot;) !important;</span>
<a href="#l71.43"></a><span id="l71.43" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/places/bookmark-item-dis.gif&quot;) !important;</span>
<a href="#l71.44"></a><span id="l71.44"> }</span>
<a href="#l71.45"></a><span id="l71.45"> </span>
<a href="#l71.46"></a><span id="l71.46"> toolbarbutton.bookmark-item[disabled=&quot;true&quot;][container=&quot;true&quot;] {</span>
<a href="#l71.47"></a><span id="l71.47" class="difflineminus">-  list-style-image: url(&quot;chrome://communicator/skin/bookmarks/bookmark-folder-dis.gif&quot;) !important;</span>
<a href="#l71.48"></a><span id="l71.48" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/places/bookmark-folder-dis.gif&quot;) !important;</span>
<a href="#l71.49"></a><span id="l71.49"> }</span>
<a href="#l71.50"></a><span id="l71.50"> </span>
<a href="#l71.51"></a><span id="l71.51"> .bookmark-item &gt; .toolbarbutton-icon {</span>
<a href="#l71.52"></a><span id="l71.52">   width: 16px;</span>
<a href="#l71.53"></a><span id="l71.53">   height: 16px;</span>
<a href="#l71.54"></a><span id="l71.54"> }</span>
<a href="#l71.55"></a><span id="l71.55"> </span>
<a href="#l71.56"></a><span id="l71.56"> .bookmark-item &gt; .toolbarbutton-menu-dropmarker {</span>
<a href="#l71.57"></a><span id="l71.57" class="difflineat">@@ -56,38 +56,38 @@ toolbarbutton.bookmark-item[disabled=&quot;tr</span>
<a href="#l71.58"></a><span id="l71.58"> /* Prevent [mode=&quot;icons&quot;] from hiding the label */</span>
<a href="#l71.59"></a><span id="l71.59"> .bookmark-item &gt; .toolbarbutton-text {</span>
<a href="#l71.60"></a><span id="l71.60">   display: -moz-box !important;</span>
<a href="#l71.61"></a><span id="l71.61"> }</span>
<a href="#l71.62"></a><span id="l71.62"> </span>
<a href="#l71.63"></a><span id="l71.63"> /* ..... drag and drop styles ..... */</span>
<a href="#l71.64"></a><span id="l71.64"> </span>
<a href="#l71.65"></a><span id="l71.65"> #PlacesToolbarDropIndicator {</span>
<a href="#l71.66"></a><span id="l71.66" class="difflineminus">-  list-style-image: url(&quot;chrome://communicator/skin/bookmarks/toolbarDropMarker.png&quot;);</span>
<a href="#l71.67"></a><span id="l71.67" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/places/toolbarDropMarker.png&quot;);</span>
<a href="#l71.68"></a><span id="l71.68"> }</span>
<a href="#l71.69"></a><span id="l71.69"> </span>
<a href="#l71.70"></a><span id="l71.70"> toolbarbutton.bookmark-item[dragover=&quot;true&quot;][open=&quot;true&quot;] {</span>
<a href="#l71.71"></a><span id="l71.71">   border: 1px solid #000000;</span>
<a href="#l71.72"></a><span id="l71.72"> }</span>
<a href="#l71.73"></a><span id="l71.73"> </span>
<a href="#l71.74"></a><span id="l71.74"> /* ::::: bookmark menus ::::: */</span>
<a href="#l71.75"></a><span id="l71.75"> </span>
<a href="#l71.76"></a><span id="l71.76"> menu.bookmark-item,</span>
<a href="#l71.77"></a><span id="l71.77"> menuitem.bookmark-item {</span>
<a href="#l71.78"></a><span id="l71.78">   border-top: 1px solid transparent !important;</span>
<a href="#l71.79"></a><span id="l71.79">   border-bottom: 1px solid transparent !important;</span>
<a href="#l71.80"></a><span id="l71.80">   padding: 1px 2px;</span>
<a href="#l71.81"></a><span id="l71.81"> }</span>
<a href="#l71.82"></a><span id="l71.82"> </span>
<a href="#l71.83"></a><span id="l71.83"> menuitem.bookmark-item[disabled=&quot;true&quot;] {</span>
<a href="#l71.84"></a><span id="l71.84" class="difflineminus">-  list-style-image: url(&quot;chrome://communicator/skin/bookmarks/bookmark-item-dis.gif&quot;);</span>
<a href="#l71.85"></a><span id="l71.85" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/places/bookmark-item-dis.gif&quot;);</span>
<a href="#l71.86"></a><span id="l71.86"> }</span>
<a href="#l71.87"></a><span id="l71.87"> </span>
<a href="#l71.88"></a><span id="l71.88"> menuitem.bookmark-item[disabled=&quot;true&quot;][container=&quot;true&quot;] {</span>
<a href="#l71.89"></a><span id="l71.89" class="difflineminus">-  list-style-image: url(&quot;chrome://communicator/skin/bookmarks/bookmark-folder-dis.gif&quot;);</span>
<a href="#l71.90"></a><span id="l71.90" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/places/bookmark-folder-dis.gif&quot;);</span>
<a href="#l71.91"></a><span id="l71.91"> }</span>
<a href="#l71.92"></a><span id="l71.92"> </span>
<a href="#l71.93"></a><span id="l71.93"> /* ..... drag and drop styles ..... */</span>
<a href="#l71.94"></a><span id="l71.94"> </span>
<a href="#l71.95"></a><span id="l71.95"> /* rules for menupopup drop indicators */</span>
<a href="#l71.96"></a><span id="l71.96"> .menupopup-drop-indicator-bar {</span>
<a href="#l71.97"></a><span id="l71.97">   position: relative;</span>
<a href="#l71.98"></a><span id="l71.98">   /* these two margins must together compensate the indicator's height */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l72.1"></a><span id="l72.1" class="difflineminus">--- a/suite/themes/modern/communicator/places/editBookmarkOverlay.css</span>
<a href="#l72.2"></a><span id="l72.2" class="difflineplus">+++ b/suite/themes/modern/communicator/places/editBookmarkOverlay.css</span>
<a href="#l72.3"></a><span id="l72.3" class="difflineat">@@ -8,17 +8,17 @@</span>
<a href="#l72.4"></a><span id="l72.4">   height: 16px;</span>
<a href="#l72.5"></a><span id="l72.5"> }</span>
<a href="#l72.6"></a><span id="l72.6"> </span>
<a href="#l72.7"></a><span id="l72.7"> .folder-icon &gt; .menu-iconic-left {</span>
<a href="#l72.8"></a><span id="l72.8">   display: -moz-box;</span>
<a href="#l72.9"></a><span id="l72.9"> }</span>
<a href="#l72.10"></a><span id="l72.10"> </span>
<a href="#l72.11"></a><span id="l72.11"> .folder-icon {</span>
<a href="#l72.12"></a><span id="l72.12" class="difflineminus">-  list-style-image: url(&quot;chrome://communicator/skin/bookmarks/bookmark-folder-closed.gif&quot;) !important;</span>
<a href="#l72.13"></a><span id="l72.13" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/places/bookmark-folder-closed.gif&quot;) !important;</span>
<a href="#l72.14"></a><span id="l72.14"> }</span>
<a href="#l72.15"></a><span id="l72.15"> </span>
<a href="#l72.16"></a><span id="l72.16"> </span>
<a href="#l72.17"></a><span id="l72.17"> /**** expanders ****/</span>
<a href="#l72.18"></a><span id="l72.18"> </span>
<a href="#l72.19"></a><span id="l72.19"> .expander-up,</span>
<a href="#l72.20"></a><span id="l72.20"> .expander-down {</span>
<a href="#l72.21"></a><span id="l72.21">   min-width: 0;</span>
<a href="#l72.22"></a><span id="l72.22" class="difflineat">@@ -53,23 +53,23 @@</span>
<a href="#l72.23"></a><span id="l72.23">   visibility: collapse;</span>
<a href="#l72.24"></a><span id="l72.24"> }</span>
<a href="#l72.25"></a><span id="l72.25"> </span>
<a href="#l72.26"></a><span id="l72.26"> </span>
<a href="#l72.27"></a><span id="l72.27"> /* ::::: bookmark panel dropdown icons ::::: */</span>
<a href="#l72.28"></a><span id="l72.28"> </span>
<a href="#l72.29"></a><span id="l72.29"> #editBMPanel_folderMenuList[selectedIndex=&quot;0&quot;],</span>
<a href="#l72.30"></a><span id="l72.30"> #editBMPanel_toolbarFolderItem {</span>
<a href="#l72.31"></a><span id="l72.31" class="difflineminus">-  list-style-image: url(&quot;chrome://communicator/skin/bookmarks/bookmarksToolbar.png&quot;) !important;</span>
<a href="#l72.32"></a><span id="l72.32" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/places/bookmarksToolbar.png&quot;) !important;</span>
<a href="#l72.33"></a><span id="l72.33">   -moz-image-region: auto !important;</span>
<a href="#l72.34"></a><span id="l72.34"> }</span>
<a href="#l72.35"></a><span id="l72.35"> </span>
<a href="#l72.36"></a><span id="l72.36"> #editBMPanel_folderMenuList[selectedIndex=&quot;1&quot;],</span>
<a href="#l72.37"></a><span id="l72.37"> #editBMPanel_bmRootItem {</span>
<a href="#l72.38"></a><span id="l72.38" class="difflineminus">-  list-style-image: url(&quot;chrome://communicator/skin/bookmarks/bookmarksMenu.png&quot;) !important;</span>
<a href="#l72.39"></a><span id="l72.39" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/places/bookmarksMenu.png&quot;) !important;</span>
<a href="#l72.40"></a><span id="l72.40">   -moz-image-region: auto !important;</span>
<a href="#l72.41"></a><span id="l72.41"> }</span>
<a href="#l72.42"></a><span id="l72.42"> </span>
<a href="#l72.43"></a><span id="l72.43"> #editBMPanel_folderMenuList[selectedIndex=&quot;2&quot;],</span>
<a href="#l72.44"></a><span id="l72.44"> #editBMPanel_unfiledRootItem {</span>
<a href="#l72.45"></a><span id="l72.45" class="difflineminus">-  list-style-image: url(&quot;chrome://communicator/skin/bookmarks/unsortedBookmarks.png&quot;) !important;</span>
<a href="#l72.46"></a><span id="l72.46" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/places/unsortedBookmarks.png&quot;) !important;</span>
<a href="#l72.47"></a><span id="l72.47">   -moz-image-region: auto !important;</span>
<a href="#l72.48"></a><span id="l72.48"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l73.1"></a><span id="l73.1">new file mode 100644</span>
<a href="#l73.2"></a><span id="l73.2">index e69de29bb2d1d6434b8b29ae775ad8c2e48c5391..fcc89bbbf0b6d30d0f33c6dc209b4ff172fe908e</span>
<a href="#l73.3"></a><span id="l73.3">GIT binary patch
literal 821
zc$@(&gt;1Iqk~P)&lt;h;3K|Lk000e1NJLTq000mG000mO1^@s6AM^iV0008~Nkl&lt;Zc-m!C
z-%Aux6#nj=ot+uob=-ArlZvuMGb^B=iYg!|=q-wXUV@5%DuRmgy_X=PdefJ{e?S5w
z0;HEnqBN2!k|@c&lt;64F)ohwjYWxpz8qaee8)+{&gt;MF&amp;v(xE-E&amp;wJMX1|@$Nh#&lt;(UFD*
z=X5&amp;NxX-q&amp;LhScEf3i|t9`!u$DP!#Qotsx=J!TEy{=&gt;euWYX+u-?HgKQ#$1eAt2Q%
zINjmgK&amp;4VG&amp;HR}iAYX6Kt*f(j03Do8H}-Gq*m_b*2|&lt;BwO9pAn#ELHv$Owz`3*agS
zV)*%MdZ&lt;&gt;bU5P=AMmKMmrg?YA_Kx#@AkdI;v2*t&gt;tY4qUy?c+a|JVs^-qMC#J`bXS
zYPo`p&gt;vomOWn&lt;*c=u1wV54UgLcu7iyRJIx2JGa9y4AgC6{5^zFP!Yqn?k=RWEfAr^
zy4H1&lt;sQSa41UuupO{qXBbaZt&lt;5v7p8B%NbZGDHmS2O$M2bar(@G7iUfQpsfU3@5es
z3MxI5%Ysv8Nqng)$W?K9!i@iEL6&gt;U+j$@KOEr&gt;&lt;7EqgDwEvpbxHZzLFQ-mI^1;qAh
z_yw53G^mIaY%&gt;8vhT2cs6}Y}e%WA^a@`(nOo6EVFo|?jkcjEwKVDyn`Kk?Tw32Kf&gt;
zk|5_r91%H`&amp;=nA8iHp~+W6yz47=Hc?D&gt;Wa74(`_g0$gVlp_t_KG-Gj-EY1}X`ck8k
z%DR$TEkx&amp;zZX7y#9Lwb;&lt;eM9?RPwM?ENZ&lt;d`532Vuu`p7Ir0DT?K@0^!y=wUS8GDA
zqBEa6dkVgg`1tuNIB5_Bel-lmASYfUGrwn_(2k|Kc}#qn0HdJRjDtenMSE)#TALlr
zmsT+Hb{ysTIdI0YuuzO+MszFpKI&amp;_89H)QNh7BhLWs#hrDVrs=C6rPKV4$&gt;61PenL
zM0c+EcgXiW-OBZ0(jbXMqK7){f@9lm5D1W_T5Se^a}Lk&lt;ON)!e0jXp!O{5;C|Hhfl
zM=Z-aZ6&amp;RJiG*1Ipw;$0Z&lt;KaD&amp;bMz|UK{6sU6Z&gt;976_6w00000NkvXXu0mjfRQ7?;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l74.1"></a><span id="l74.1" class="difflineminus">--- a/suite/themes/modern/global/dirListing/dirListing.css</span>
<a href="#l74.2"></a><span id="l74.2" class="difflineplus">+++ b/suite/themes/modern/global/dirListing/dirListing.css</span>
<a href="#l74.3"></a><span id="l74.3" class="difflineat">@@ -97,11 +97,11 @@ td:not(:first-child) {</span>
<a href="#l74.4"></a><span id="l74.4"> .up::before {</span>
<a href="#l74.5"></a><span id="l74.5">   margin-inline-end: 4px;</span>
<a href="#l74.6"></a><span id="l74.6">   margin-inline-start: -24px;</span>
<a href="#l74.7"></a><span id="l74.7">   vertical-align: middle;</span>
<a href="#l74.8"></a><span id="l74.8">   content: url(&quot;chrome://global/skin/filepicker/folder-up.gif&quot;);</span>
<a href="#l74.9"></a><span id="l74.9"> }</span>
<a href="#l74.10"></a><span id="l74.10"> </span>
<a href="#l74.11"></a><span id="l74.11"> .dir::before {</span>
<a href="#l74.12"></a><span id="l74.12" class="difflineminus">-  content: url(&quot;chrome://communicator/skin/bookmarks/bookmark-folder-closed.gif&quot;);</span>
<a href="#l74.13"></a><span id="l74.13" class="difflineplus">+  content: url(&quot;chrome://communicator/skin/places/bookmark-folder-closed.gif&quot;);</span>
<a href="#l74.14"></a><span id="l74.14"> }</span>
<a href="#l74.15"></a><span id="l74.15"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l75.1"></a><span id="l75.1" class="difflineminus">--- a/suite/themes/modern/jar.mn</span>
<a href="#l75.2"></a><span id="l75.2" class="difflineplus">+++ b/suite/themes/modern/jar.mn</span>
<a href="#l75.3"></a><span id="l75.3" class="difflineat">@@ -1,14 +1,14 @@</span>
<a href="#l75.4"></a><span id="l75.4"> # This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l75.5"></a><span id="l75.5"> # License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l75.6"></a><span id="l75.6"> # file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l75.7"></a><span id="l75.7"> </span>
<a href="#l75.8"></a><span id="l75.8"> modern.jar:</span>
<a href="#l75.9"></a><span id="l75.9" class="difflineminus">-% override chrome://mozapps/skin/places/defaultFavicon.svg chrome://communicator/skin/bookmarks/bookmark-item.svg</span>
<a href="#l75.10"></a><span id="l75.10" class="difflineplus">+% override chrome://mozapps/skin/places/defaultFavicon.svg chrome://communicator/skin/places/bookmark-item.svg</span>
<a href="#l75.11"></a><span id="l75.11"> % skin communicator modern/1.0 %skin/modern/communicator/</span>
<a href="#l75.12"></a><span id="l75.12"> % skin editor modern/1.0 %skin/modern/editor/</span>
<a href="#l75.13"></a><span id="l75.13"> % skin global modern/1.0 %skin/modern/global/</span>
<a href="#l75.14"></a><span id="l75.14"> % skin global-platform modern/1.0 %skin/modern/global/</span>
<a href="#l75.15"></a><span id="l75.15"> % skin messenger modern/1.0 %skin/modern/messenger/</span>
<a href="#l75.16"></a><span id="l75.16"> % skin mozapps modern/1.0 %skin/modern/mozapps/</span>
<a href="#l75.17"></a><span id="l75.17"> % skin navigator modern/1.0 %skin/modern/navigator/</span>
<a href="#l75.18"></a><span id="l75.18"> % skin messenger-newsblog modern/1.0 %skin/modern/messenger-newsblog/</span>
<a href="#l75.19"></a><span id="l75.19" class="difflineat">@@ -28,52 +28,32 @@ modern.jar:</span>
<a href="#l75.20"></a><span id="l75.20">   skin/modern/communicator/button.css                              (communicator/button.css)</span>
<a href="#l75.21"></a><span id="l75.21">   skin/modern/communicator/toolbar.css                             (communicator/toolbar.css)</span>
<a href="#l75.22"></a><span id="l75.22">   skin/modern/communicator/dialogs.css                             (communicator/dialogs.css)</span>
<a href="#l75.23"></a><span id="l75.23">   skin/modern/communicator/smileys.css                             (communicator/smileys.css)</span>
<a href="#l75.24"></a><span id="l75.24">   skin/modern/communicator/communicator.css                        (communicator/communicator.css)</span>
<a href="#l75.25"></a><span id="l75.25">   skin/modern/communicator/aboutPrivateBrowsing.css                (communicator/aboutPrivateBrowsing.css)</span>
<a href="#l75.26"></a><span id="l75.26">   skin/modern/communicator/aboutSessionRestore.css                 (communicator/aboutSessionRestore.css)</span>
<a href="#l75.27"></a><span id="l75.27">   skin/modern/communicator/viewSourceOverlay.css                   (communicator/viewSourceOverlay.css)</span>
<a href="#l75.28"></a><span id="l75.28" class="difflineminus">-  skin/modern/communicator/bookmarks/allBookmarks.png              (communicator/bookmarks/allBookmarks.png)</span>
<a href="#l75.29"></a><span id="l75.29" class="difflineminus">-  skin/modern/communicator/bookmarks/bookmark.png                  (communicator/bookmarks/bookmark.png)</span>
<a href="#l75.30"></a><span id="l75.30" class="difflineminus">-  skin/modern/communicator/bookmarks/bookmark-folder-closed.gif    (communicator/bookmarks/bookmark-folder-closed.gif)</span>
<a href="#l75.31"></a><span id="l75.31" class="difflineminus">-  skin/modern/communicator/bookmarks/bookmark-folder-dis.gif       (communicator/bookmarks/bookmark-folder-dis.gif)</span>
<a href="#l75.32"></a><span id="l75.32" class="difflineminus">-  skin/modern/communicator/bookmarks/bookmark-folder-open.gif      (communicator/bookmarks/bookmark-folder-open.gif)</span>
<a href="#l75.33"></a><span id="l75.33" class="difflineminus">-  skin/modern/communicator/bookmarks/bookmark-item-dis.gif         (communicator/bookmarks/bookmark-item-dis.gif)</span>
<a href="#l75.34"></a><span id="l75.34" class="difflineminus">-  skin/modern/communicator/bookmarks/bookmark-item-updated.gif     (communicator/bookmarks/bookmark-item-updated.gif)</span>
<a href="#l75.35"></a><span id="l75.35" class="difflineminus">-  skin/modern/communicator/bookmarks/bookmark-item.svg             (communicator/bookmarks/bookmark-item.svg)</span>
<a href="#l75.36"></a><span id="l75.36" class="difflineminus">-  skin/modern/communicator/bookmarks/bookmarks.css                 (communicator/bookmarks/bookmarks.css)</span>
<a href="#l75.37"></a><span id="l75.37" class="difflineminus">-  skin/modern/communicator/bookmarks/bookmarksManager.css          (communicator/bookmarks/bookmarksManager.css)</span>
<a href="#l75.38"></a><span id="l75.38" class="difflineminus">-  skin/modern/communicator/bookmarks/bookmarksMenu.png             (communicator/bookmarks/bookmarksMenu.png)</span>
<a href="#l75.39"></a><span id="l75.39" class="difflineminus">-  skin/modern/communicator/bookmarks/bookmarksToolbar.css          (communicator/bookmarks/bookmarksToolbar.css)</span>
<a href="#l75.40"></a><span id="l75.40" class="difflineminus">-  skin/modern/communicator/bookmarks/bookmarksToolbar.png          (communicator/bookmarks/bookmarksToolbar.png)</span>
<a href="#l75.41"></a><span id="l75.41" class="difflineminus">-  skin/modern/communicator/bookmarks/editBookmarkOverlay.css       (communicator/bookmarks/editBookmarkOverlay.css)</span>
<a href="#l75.42"></a><span id="l75.42" class="difflineminus">-  skin/modern/communicator/bookmarks/livemark-folder.png           (communicator/bookmarks/livemark-folder.png)</span>
<a href="#l75.43"></a><span id="l75.43" class="difflineminus">-  skin/modern/communicator/bookmarks/query.png                     (communicator/bookmarks/query.png)</span>
<a href="#l75.44"></a><span id="l75.44" class="difflineminus">-  skin/modern/communicator/bookmarks/tag.png                       (communicator/bookmarks/tag.png)</span>
<a href="#l75.45"></a><span id="l75.45" class="difflineminus">-  skin/modern/communicator/bookmarks/toolbarDropMarker.png         (communicator/bookmarks/toolbarDropMarker.png)</span>
<a href="#l75.46"></a><span id="l75.46" class="difflineminus">-  skin/modern/communicator/bookmarks/unsortedBookmarks.png         (communicator/bookmarks/unsortedBookmarks.png)</span>
<a href="#l75.47"></a><span id="l75.47">   skin/modern/communicator/brand/throbber-anim.png                 (communicator/brand/throbber-anim.png)</span>
<a href="#l75.48"></a><span id="l75.48">   skin/modern/communicator/brand/throbber-single.png               (communicator/brand/throbber-single.png)</span>
<a href="#l75.49"></a><span id="l75.49">   skin/modern/communicator/brand/throbber16-anim.png               (communicator/brand/throbber16-anim.png)</span>
<a href="#l75.50"></a><span id="l75.50">   skin/modern/communicator/brand/throbber16-single.png             (communicator/brand/throbber16-single.png)</span>
<a href="#l75.51"></a><span id="l75.51">   skin/modern/communicator/console/console.css                     (communicator/console/console.css)</span>
<a href="#l75.52"></a><span id="l75.52">   skin/modern/communicator/console/error-caret.gif                 (communicator/console/error-caret.gif)</span>
<a href="#l75.53"></a><span id="l75.53">   skin/modern/communicator/console/error-dash.gif                  (communicator/console/error-dash.gif)</span>
<a href="#l75.54"></a><span id="l75.54">   skin/modern/communicator/dataman/dataman.css                     (communicator/dataman/dataman.css)</span>
<a href="#l75.55"></a><span id="l75.55">   skin/modern/communicator/dataman/datamanIcon-16.png              (communicator/dataman/datamanIcon-16.png)</span>
<a href="#l75.56"></a><span id="l75.56">   skin/modern/communicator/downloads/dl-remove.png                 (communicator/downloads/dl-remove.png)</span>
<a href="#l75.57"></a><span id="l75.57">   skin/modern/communicator/downloads/downloadButtons.png           (communicator/downloads/downloadButtons.png)</span>
<a href="#l75.58"></a><span id="l75.58">   skin/modern/communicator/downloads/downloadmanager.css           (communicator/downloads/downloadmanager.css)</span>
<a href="#l75.59"></a><span id="l75.59">   skin/modern/communicator/feed-subscribe.css                      (communicator/feed-subscribe.css)</span>
<a href="#l75.60"></a><span id="l75.60">   skin/modern/communicator/feed-subscribe-ui.css                   (communicator/feed-subscribe-ui.css)</span>
<a href="#l75.61"></a><span id="l75.61">   skin/modern/communicator/fullscreen-video.css                    (communicator/fullscreen-video.css)</span>
<a href="#l75.62"></a><span id="l75.62">   skin/modern/communicator/helpviewer/help.css                     (communicator/helpviewer/help.css)</span>
<a href="#l75.63"></a><span id="l75.63" class="difflineminus">-  skin/modern/communicator/history/calendar.png                    (communicator/history/calendar.png)</span>
<a href="#l75.64"></a><span id="l75.64">   skin/modern/communicator/icons/alwaysAsk.png                     (communicator/icons/alwaysAsk.png)</span>
<a href="#l75.65"></a><span id="l75.65">   skin/modern/communicator/icons/application.png                   (communicator/icons/application.png)</span>
<a href="#l75.66"></a><span id="l75.66">   skin/modern/communicator/icons/audioFeedIcon.png                 (communicator/icons/feedIcon.png)</span>
<a href="#l75.67"></a><span id="l75.67">   skin/modern/communicator/icons/closeFullScreenVideo.png          (communicator/icons/closeFullScreenVideo.png)</span>
<a href="#l75.68"></a><span id="l75.68">   skin/modern/communicator/icons/btn1.gif                          (communicator/icons/btn1.gif)</span>
<a href="#l75.69"></a><span id="l75.69">   skin/modern/communicator/icons/common.png                        (communicator/icons/common.png)</span>
<a href="#l75.70"></a><span id="l75.70">   skin/modern/communicator/icons/common-small.png                  (communicator/icons/common-small.png)</span>
<a href="#l75.71"></a><span id="l75.71">   skin/modern/communicator/icons/feedIcon.png                      (communicator/icons/feedIcon.png)</span>
<a href="#l75.72"></a><span id="l75.72" class="difflineat">@@ -107,16 +87,37 @@ modern.jar:</span>
<a href="#l75.73"></a><span id="l75.73">   skin/modern/communicator/icons/smileys/smiley-yell.png           (communicator/icons/smileys/smiley-yell.png)</span>
<a href="#l75.74"></a><span id="l75.74">   skin/modern/communicator/icons/smileys/smiley-cool.png           (communicator/icons/smileys/smiley-cool.png)</span>
<a href="#l75.75"></a><span id="l75.75">   skin/modern/communicator/icons/smileys/smiley-money.png          (communicator/icons/smileys/smiley-money.png)</span>
<a href="#l75.76"></a><span id="l75.76">   skin/modern/communicator/icons/smileys/smiley-foot.png           (communicator/icons/smileys/smiley-foot.png)</span>
<a href="#l75.77"></a><span id="l75.77">   skin/modern/communicator/icons/smileys/smiley-innocent.png       (communicator/icons/smileys/smiley-innocent.png)</span>
<a href="#l75.78"></a><span id="l75.78">   skin/modern/communicator/icons/smileys/smiley-cry.png            (communicator/icons/smileys/smiley-cry.png)</span>
<a href="#l75.79"></a><span id="l75.79">   skin/modern/communicator/icons/smileys/smiley-sealed.png         (communicator/icons/smileys/smiley-sealed.png)</span>
<a href="#l75.80"></a><span id="l75.80">   skin/modern/communicator/icons/videoFeedIcon.png                 (communicator/icons/feedIcon.png)</span>
<a href="#l75.81"></a><span id="l75.81" class="difflineplus">+  skin/modern/communicator/places/allBookmarks.png                 (communicator/places/allBookmarks.png)</span>
<a href="#l75.82"></a><span id="l75.82" class="difflineplus">+  skin/modern/communicator/places/bookmark.png                     (communicator/places/bookmark.png)</span>
<a href="#l75.83"></a><span id="l75.83" class="difflineplus">+  skin/modern/communicator/places/bookmark-folder-closed.gif       (communicator/places/bookmark-folder-closed.gif)</span>
<a href="#l75.84"></a><span id="l75.84" class="difflineplus">+  skin/modern/communicator/places/bookmark-folder-dis.gif          (communicator/places/bookmark-folder-dis.gif)</span>
<a href="#l75.85"></a><span id="l75.85" class="difflineplus">+  skin/modern/communicator/places/bookmark-folder-open.gif         (communicator/places/bookmark-folder-open.gif)</span>
<a href="#l75.86"></a><span id="l75.86" class="difflineplus">+  skin/modern/communicator/places/bookmark-item-dis.gif            (communicator/places/bookmark-item-dis.gif)</span>
<a href="#l75.87"></a><span id="l75.87" class="difflineplus">+  skin/modern/communicator/places/bookmark-item-updated.gif        (communicator/places/bookmark-item-updated.gif)</span>
<a href="#l75.88"></a><span id="l75.88" class="difflineplus">+  skin/modern/communicator/places/bookmark-item.svg                (communicator/places/bookmark-item.svg)</span>
<a href="#l75.89"></a><span id="l75.89" class="difflineplus">+  skin/modern/communicator/places/bookmarks.css                    (communicator/places/bookmarks.css)</span>
<a href="#l75.90"></a><span id="l75.90" class="difflineplus">+  skin/modern/communicator/places/bookmarksMenu.png                (communicator/places/bookmarksMenu.png)</span>
<a href="#l75.91"></a><span id="l75.91" class="difflineplus">+  skin/modern/communicator/places/bookmarksToolbar.css             (communicator/places/bookmarksToolbar.css)</span>
<a href="#l75.92"></a><span id="l75.92" class="difflineplus">+  skin/modern/communicator/places/bookmarksToolbar.png             (communicator/places/bookmarksToolbar.png)</span>
<a href="#l75.93"></a><span id="l75.93" class="difflineplus">+  skin/modern/communicator/places/calendar.png                     (communicator/places/calendar.png)</span>
<a href="#l75.94"></a><span id="l75.94" class="difflineplus">+  skin/modern/communicator/places/editBookmarkOverlay.css          (communicator/places/editBookmarkOverlay.css)</span>
<a href="#l75.95"></a><span id="l75.95" class="difflineplus">+  skin/modern/communicator/places/history.png                      (communicator/places/history.png)</span>
<a href="#l75.96"></a><span id="l75.96" class="difflineplus">+  skin/modern/communicator/places/livemark-folder.png              (communicator/places/livemark-folder.png)</span>
<a href="#l75.97"></a><span id="l75.97" class="difflineplus">+  skin/modern/communicator/places/organizer.css                    (communicator/places/organizer.css)</span>
<a href="#l75.98"></a><span id="l75.98" class="difflineplus">+  skin/modern/communicator/places/query.png                        (communicator/places/query.png)</span>
<a href="#l75.99"></a><span id="l75.99" class="difflineplus">+  skin/modern/communicator/places/tag.png                          (communicator/places/tag.png)</span>
<a href="#l75.100"></a><span id="l75.100" class="difflineplus">+  skin/modern/communicator/places/toolbarDropMarker.png            (communicator/places/toolbarDropMarker.png)</span>
<a href="#l75.101"></a><span id="l75.101" class="difflineplus">+  skin/modern/communicator/places/unsortedBookmarks.png            (communicator/places/unsortedBookmarks.png)</span>
<a href="#l75.102"></a><span id="l75.102">   skin/modern/communicator/profile/migrate.gif                     (communicator/profile/migrate.gif)</span>
<a href="#l75.103"></a><span id="l75.103">   skin/modern/communicator/profile/profile.gif                     (communicator/profile/profile.gif)</span>
<a href="#l75.104"></a><span id="l75.104">   skin/modern/communicator/profile/profile.css                     (communicator/profile/profile.css)</span>
<a href="#l75.105"></a><span id="l75.105">   skin/modern/communicator/search/engineManager.css                (communicator/search/engineManager.css)</span>
<a href="#l75.106"></a><span id="l75.106">   skin/modern/communicator/search/mainwindow-dropdown-arrow.png    (communicator/search/mainwindow-dropdown-arrow.png)</span>
<a href="#l75.107"></a><span id="l75.107">   skin/modern/communicator/search/search.css                       (communicator/search/search.css)</span>
<a href="#l75.108"></a><span id="l75.108">   skin/modern/communicator/search/searchbar.css                    (communicator/search/searchbar.css)</span>
<a href="#l75.109"></a><span id="l75.109">   skin/modern/communicator/sidebar/sidebarBindings.xml             (communicator/sidebar/sidebarBindings.xml)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l76.1"></a><span id="l76.1" class="difflineminus">--- a/suite/themes/modern/navigator/navigator.css</span>
<a href="#l76.2"></a><span id="l76.2" class="difflineplus">+++ b/suite/themes/modern/navigator/navigator.css</span>
<a href="#l76.3"></a><span id="l76.3" class="difflineat">@@ -1,15 +1,15 @@</span>
<a href="#l76.4"></a><span id="l76.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l76.5"></a><span id="l76.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l76.6"></a><span id="l76.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l76.7"></a><span id="l76.7"> </span>
<a href="#l76.8"></a><span id="l76.8"> @import url(&quot;chrome://navigator/content/navigator.css&quot;);</span>
<a href="#l76.9"></a><span id="l76.9"> @import url(&quot;chrome://communicator/skin/&quot;);</span>
<a href="#l76.10"></a><span id="l76.10" class="difflineminus">-@import url(&quot;chrome://communicator/skin/bookmarks/bookmarksToolbar.css&quot;);</span>
<a href="#l76.11"></a><span id="l76.11" class="difflineplus">+@import url(&quot;chrome://communicator/skin/places/bookmarksToolbar.css&quot;);</span>
<a href="#l76.12"></a><span id="l76.12"> </span>
<a href="#l76.13"></a><span id="l76.13"> @namespace url(&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;);</span>
<a href="#l76.14"></a><span id="l76.14"> </span>
<a href="#l76.15"></a><span id="l76.15"> /* ::::: primary toolbar buttons ::::: */</span>
<a href="#l76.16"></a><span id="l76.16"> </span>
<a href="#l76.17"></a><span id="l76.17"> .toolbarbutton-1 {</span>
<a href="#l76.18"></a><span id="l76.18">   min-width: 0px;</span>
<a href="#l76.19"></a><span id="l76.19"> }</span>
<a href="#l76.20"></a><span id="l76.20" class="difflineat">@@ -674,26 +674,26 @@ toolbar[mode=&quot;icons&quot;] #search-button &gt; .</span>
<a href="#l76.21"></a><span id="l76.21"> }</span>
<a href="#l76.22"></a><span id="l76.22"> </span>
<a href="#l76.23"></a><span id="l76.23"> #page-proxy-deck {</span>
<a href="#l76.24"></a><span id="l76.24">   cursor: grab;</span>
<a href="#l76.25"></a><span id="l76.25">   margin-inline-end: 4px;</span>
<a href="#l76.26"></a><span id="l76.26"> }</span>
<a href="#l76.27"></a><span id="l76.27"> </span>
<a href="#l76.28"></a><span id="l76.28"> #page-proxy-button {</span>
<a href="#l76.29"></a><span id="l76.29" class="difflineminus">-  list-style-image: url(&quot;chrome://communicator/skin/bookmarks/bookmark-item.svg&quot;); </span>
<a href="#l76.30"></a><span id="l76.30" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/places/bookmark-item.svg&quot;); </span>
<a href="#l76.31"></a><span id="l76.31"> } </span>
<a href="#l76.32"></a><span id="l76.32"> </span>
<a href="#l76.33"></a><span id="l76.33"> #page-proxy-favicon {</span>
<a href="#l76.34"></a><span id="l76.34">   list-style-image: none;</span>
<a href="#l76.35"></a><span id="l76.35"> } </span>
<a href="#l76.36"></a><span id="l76.36"> </span>
<a href="#l76.37"></a><span id="l76.37"> #page-proxy-button[pageproxystate=&quot;invalid&quot;] {</span>
<a href="#l76.38"></a><span id="l76.38">   cursor: default;</span>
<a href="#l76.39"></a><span id="l76.39" class="difflineminus">-  list-style-image: url(&quot;chrome://communicator/skin/bookmarks/bookmark-item-dis.gif&quot;); </span>
<a href="#l76.40"></a><span id="l76.40" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/places/bookmark-item-dis.gif&quot;); </span>
<a href="#l76.41"></a><span id="l76.41"> }</span>
<a href="#l76.42"></a><span id="l76.42"> </span>
<a href="#l76.43"></a><span id="l76.43"> /* ::::: autocomplete ::::: */</span>
<a href="#l76.44"></a><span id="l76.44"> </span>
<a href="#l76.45"></a><span id="l76.45"> #PopupAutoComplete &gt; richlistbox &gt; richlistitem {</span>
<a href="#l76.46"></a><span id="l76.46">   height: 20px;</span>
<a href="#l76.47"></a><span id="l76.47">   min-height: 20px;</span>
<a href="#l76.48"></a><span id="l76.48">   border: 0;</span>
<a href="#l76.49"></a><span id="l76.49" class="difflineat">@@ -840,25 +840,25 @@ toolbar[mode=&quot;text&quot;] toolbarbutton.chevr</span>
<a href="#l76.50"></a><span id="l76.50">   text-decoration: none !important;</span>
<a href="#l76.51"></a><span id="l76.51"> }</span>
<a href="#l76.52"></a><span id="l76.52"> </span>
<a href="#l76.53"></a><span id="l76.53"> /*</span>
<a href="#l76.54"></a><span id="l76.54">   In customize mode we hide the normal bookmark items and show a placeholder</span>
<a href="#l76.55"></a><span id="l76.55">   for the drag/drop UI.</span>
<a href="#l76.56"></a><span id="l76.56"> */</span>
<a href="#l76.57"></a><span id="l76.57"> .bookmarks-toolbar-customize {</span>
<a href="#l76.58"></a><span id="l76.58" class="difflineminus">-  list-style-image: url(&quot;chrome://communicator/skin/bookmarks/bookmarksToolbar.png&quot;);</span>
<a href="#l76.59"></a><span id="l76.59" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/places/bookmarksToolbar.png&quot;);</span>
<a href="#l76.60"></a><span id="l76.60">   display: none;</span>
<a href="#l76.61"></a><span id="l76.61">   max-width: 15em !important;</span>
<a href="#l76.62"></a><span id="l76.62"> }</span>
<a href="#l76.63"></a><span id="l76.63"> </span>
<a href="#l76.64"></a><span id="l76.64"> #wrapper-personal-bookmarks[place=&quot;palette&quot;] &gt; .toolbarpaletteitem-box {</span>
<a href="#l76.65"></a><span id="l76.65">   width: 16px;</span>
<a href="#l76.66"></a><span id="l76.66">   height: 16px;</span>
<a href="#l76.67"></a><span id="l76.67" class="difflineminus">-  background: url(&quot;chrome://communicator/skin/bookmarks/bookmarksToolbar.png&quot;) no-repeat;</span>
<a href="#l76.68"></a><span id="l76.68" class="difflineplus">+  background: url(&quot;chrome://communicator/skin/places/bookmarksToolbar.png&quot;) no-repeat;</span>
<a href="#l76.69"></a><span id="l76.69"> }</span>
<a href="#l76.70"></a><span id="l76.70"> </span>
<a href="#l76.71"></a><span id="l76.71"> /* ::::: content area ::::: */</span>
<a href="#l76.72"></a><span id="l76.72"> </span>
<a href="#l76.73"></a><span id="l76.73"> #content {</span>
<a href="#l76.74"></a><span id="l76.74">   border-bottom: 1px solid #494F5D;</span>
<a href="#l76.75"></a><span id="l76.75"> }</span>
<a href="#l76.76"></a><span id="l76.76"> </span>
<a href="#l76.77"></a><span id="l76.77" class="difflineat">@@ -906,17 +906,17 @@ toolbar[mode=&quot;text&quot;] toolbarbutton.chevr</span>
<a href="#l76.78"></a><span id="l76.78">   color: #000000;</span>
<a href="#l76.79"></a><span id="l76.79">   font: message-box;</span>
<a href="#l76.80"></a><span id="l76.80">   font-weight: bold;</span>
<a href="#l76.81"></a><span id="l76.81"> }</span>
<a href="#l76.82"></a><span id="l76.82"> </span>
<a href="#l76.83"></a><span id="l76.83"> /* ::::: star button ::::: */</span>
<a href="#l76.84"></a><span id="l76.84"> </span>
<a href="#l76.85"></a><span id="l76.85"> #star-button {</span>
<a href="#l76.86"></a><span id="l76.86" class="difflineminus">-  list-style-image: url(&quot;chrome://communicator/skin/bookmarks/bookmark.png&quot;);</span>
<a href="#l76.87"></a><span id="l76.87" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/places/bookmark.png&quot;);</span>
<a href="#l76.88"></a><span id="l76.88">   -moz-image-region: rect(16px 16px 32px 0px);</span>
<a href="#l76.89"></a><span id="l76.89"> }</span>
<a href="#l76.90"></a><span id="l76.90"> </span>
<a href="#l76.91"></a><span id="l76.91"> #star-button:hover {</span>
<a href="#l76.92"></a><span id="l76.92">   -moz-image-region: rect(16px 32px 32px 16px);</span>
<a href="#l76.93"></a><span id="l76.93"> }</span>
<a href="#l76.94"></a><span id="l76.94"> </span>
<a href="#l76.95"></a><span id="l76.95"> #star-button:hover:active {</span>
<a href="#l76.96"></a><span id="l76.96" class="difflineat">@@ -931,17 +931,17 @@ toolbar[mode=&quot;text&quot;] toolbarbutton.chevr</span>
<a href="#l76.97"></a><span id="l76.97">   -moz-image-region: rect(0px 32px 16px 16px);</span>
<a href="#l76.98"></a><span id="l76.98"> }</span>
<a href="#l76.99"></a><span id="l76.99"> </span>
<a href="#l76.100"></a><span id="l76.100"> #star-button[starred=&quot;true&quot;]:hover:active {</span>
<a href="#l76.101"></a><span id="l76.101">   -moz-image-region: rect(0px 48px 16px 32px);</span>
<a href="#l76.102"></a><span id="l76.102"> }</span>
<a href="#l76.103"></a><span id="l76.103"> </span>
<a href="#l76.104"></a><span id="l76.104"> #editBookmarkPanelStarIcon {</span>
<a href="#l76.105"></a><span id="l76.105" class="difflineminus">-  list-style-image: url(&quot;chrome://communicator/skin/bookmarks/bookmark.png&quot;);</span>
<a href="#l76.106"></a><span id="l76.106" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/places/bookmark.png&quot;);</span>
<a href="#l76.107"></a><span id="l76.107">   -moz-image-region: rect(0px 16px 16px 0px);</span>
<a href="#l76.108"></a><span id="l76.108"> }</span>
<a href="#l76.109"></a><span id="l76.109"> </span>
<a href="#l76.110"></a><span id="l76.110"> /* ::::: feeds ::::: */</span>
<a href="#l76.111"></a><span id="l76.111"> </span>
<a href="#l76.112"></a><span id="l76.112"> .feedsMenu {</span>
<a href="#l76.113"></a><span id="l76.113">   list-style-image: url(&quot;chrome://navigator/skin/btn1/feeds.png&quot;);</span>
<a href="#l76.114"></a><span id="l76.114">   -moz-image-region: rect(0px 16px 16px 0px);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l77.1"></a><span id="l77.1" class="difflineminus">--- a/suite/themes/modern/navigator/tabbrowser.css</span>
<a href="#l77.2"></a><span id="l77.2" class="difflineplus">+++ b/suite/themes/modern/navigator/tabbrowser.css</span>
<a href="#l77.3"></a><span id="l77.3" class="difflineat">@@ -17,17 +17,17 @@</span>
<a href="#l77.4"></a><span id="l77.4"> }</span>
<a href="#l77.5"></a><span id="l77.5"> </span>
<a href="#l77.6"></a><span id="l77.6"> .tabs-left {</span>
<a href="#l77.7"></a><span id="l77.7">   width: 3px;</span>
<a href="#l77.8"></a><span id="l77.8"> }</span>
<a href="#l77.9"></a><span id="l77.9"> </span>
<a href="#l77.10"></a><span id="l77.10"> tab {</span>
<a href="#l77.11"></a><span id="l77.11">   padding: 0px 3px;</span>
<a href="#l77.12"></a><span id="l77.12" class="difflineminus">-  list-style-image: url(&quot;chrome://communicator/skin/bookmarks/bookmark-item.svg&quot;);</span>
<a href="#l77.13"></a><span id="l77.13" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/places/bookmark-item.svg&quot;);</span>
<a href="#l77.14"></a><span id="l77.14"> }</span>
<a href="#l77.15"></a><span id="l77.15"> </span>
<a href="#l77.16"></a><span id="l77.16"> tab[busy] {</span>
<a href="#l77.17"></a><span id="l77.17">   list-style-image: url(&quot;chrome://communicator/skin/icons/loading.gif&quot;);</span>
<a href="#l77.18"></a><span id="l77.18"> }</span>
<a href="#l77.19"></a><span id="l77.19"> </span>
<a href="#l77.20"></a><span id="l77.20"> .tab-icon {</span>
<a href="#l77.21"></a><span id="l77.21">   margin-inline-end: 3px;</span>
<a href="#l77.22"></a><span id="l77.22" class="difflineat">@@ -83,17 +83,17 @@ tab[busy] {</span>
<a href="#l77.23"></a><span id="l77.23"> }</span>
<a href="#l77.24"></a><span id="l77.24"> </span>
<a href="#l77.25"></a><span id="l77.25"> .tabs-alltabs-button &gt; .toolbarbutton-icon {</span>
<a href="#l77.26"></a><span id="l77.26">   margin: 0px;</span>
<a href="#l77.27"></a><span id="l77.27"> }</span>
<a href="#l77.28"></a><span id="l77.28"> </span>
<a href="#l77.29"></a><span id="l77.29"> /* All tabs menupopup */</span>
<a href="#l77.30"></a><span id="l77.30"> .alltabs-item {</span>
<a href="#l77.31"></a><span id="l77.31" class="difflineminus">-  list-style-image: url(&quot;chrome://communicator/skin/bookmarks/bookmark-item.svg&quot;);</span>
<a href="#l77.32"></a><span id="l77.32" class="difflineplus">+  list-style-image: url(&quot;chrome://communicator/skin/places/bookmark-item.svg&quot;);</span>
<a href="#l77.33"></a><span id="l77.33"> }</span>
<a href="#l77.34"></a><span id="l77.34"> </span>
<a href="#l77.35"></a><span id="l77.35"> .alltabs-item[selected=&quot;true&quot;] {</span>
<a href="#l77.36"></a><span id="l77.36">   font-weight: bold;</span>
<a href="#l77.37"></a><span id="l77.37"> }</span>
<a href="#l77.38"></a><span id="l77.38"> </span>
<a href="#l77.39"></a><span id="l77.39"> .alltabs-item[busy] {</span>
<a href="#l77.40"></a><span id="l77.40">   list-style-image: url(&quot;chrome://communicator/skin/icons/loading.gif&quot;);</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

