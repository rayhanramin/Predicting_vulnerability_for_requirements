<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 8879:fac3f825a13b57fb0bbf5b59d9b23ac74a5aa9fb</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ fac3f825a13b57fb0bbf5b59d9b23ac74a5aa9fb" />
<meta property="og:url" content="/comm-central/rev/fac3f825a13b57fb0bbf5b59d9b23ac74a5aa9fb" />
<meta property="og:description" content="fix bug 611233, r=bienvenu, add NS_ENSURE_ARG_POINTER to various imap interface implementations" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / fac3f825a13b57fb0bbf5b59d9b23ac74a5aa9fb 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/fac3f825a13b57fb0bbf5b59d9b23ac74a5aa9fb">shortlog</a> |
<a href="/comm-central/log/fac3f825a13b57fb0bbf5b59d9b23ac74a5aa9fb">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/fac3f825a13b57fb0bbf5b59d9b23ac74a5aa9fb">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/fac3f825a13b57fb0bbf5b59d9b23ac74a5aa9fb">files</a> |
changeset |
<a href="/comm-central/raw-rev/fac3f825a13b57fb0bbf5b59d9b23ac74a5aa9fb">raw</a>  | <a href="/comm-central/archive/fac3f825a13b57fb0bbf5b59d9b23ac74a5aa9fb.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
fix <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=611233">bug 611233</a>, r=bienvenu, add NS_ENSURE_ARG_POINTER to various imap interface implementations
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#83;&#101;&#114;&#103;&#101;&#32;&#71;&#97;&#117;&#116;&#104;&#101;&#114;&#105;&#101;&#32;&#60;&#115;&#103;&#97;&#117;&#116;&#104;&#101;&#114;&#105;&#101;&#46;&#98;&#122;&#64;&#102;&#114;&#101;&#101;&#46;&#102;&#114;&#62;</td></tr>
<tr><td></td><td class="date age">Tue, 22 Nov 2011 16:13:41 -0800</td></tr>

<tr>
 <td>changeset 8879</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/fac3f825a13b57fb0bbf5b59d9b23ac74a5aa9fb">fac3f825a13b57fb0bbf5b59d9b23ac74a5aa9fb</a></td>
</tr>



<tr>
<td>parent 8878</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/e57a9c880238b71e2c87144402cbfe5e7d709f7c">e57a9c880238b71e2c87144402cbfe5e7d709f7c</a>
</td>
</tr>

<tr>
<td>child 8880</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/da62106ad30b132ff43a2c515d07e4f5114f39f4">da62106ad30b132ff43a2c515d07e4f5114f39f4</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=fac3f825a13b57fb0bbf5b59d9b23ac74a5aa9fb">6810</a></td></tr>
<tr><td>push user</td><td>bienvenu@nventure.com</td></tr>
<tr><td>push date</td><td class="date age">Wed, 23 Nov 2011 00:13:37 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@fac3f825a13b [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=fac3f825a13b57fb0bbf5b59d9b23ac74a5aa9fb">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=fac3f825a13b57fb0bbf5b59d9b23ac74a5aa9fb&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=fac3f825a13b57fb0bbf5b59d9b23ac74a5aa9fb&newProject=comm-central&newRevision=fac3f825a13b57fb0bbf5b59d9b23ac74a5aa9fb&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=fac3f825a13b57fb0bbf5b59d9b23ac74a5aa9fb&newProject=comm-central&newRevision=fac3f825a13b57fb0bbf5b59d9b23ac74a5aa9fb&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=fac3f825a13b57fb0bbf5b59d9b23ac74a5aa9fb&newProject=comm-central&newRevision=fac3f825a13b57fb0bbf5b59d9b23ac74a5aa9fb&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28bienvenu%29&revcount=50">bienvenu</a>, <a href="/comm-central/log?rev=reviewer%28add%29&revcount=50">add</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=611233">611233</a></td></tr>




</table></div>

<div class="page_body description">fix <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=611233">bug 611233</a>, r=bienvenu, add NS_ENSURE_ARG_POINTER to various imap interface implementations</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/fac3f825a13b57fb0bbf5b59d9b23ac74a5aa9fb/mailnews/imap/public/nsIImapService.idl">mailnews/imap/public/nsIImapService.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/fac3f825a13b57fb0bbf5b59d9b23ac74a5aa9fb/mailnews/imap/public/nsIImapService.idl">file</a> |
<a href="/comm-central/annotate/fac3f825a13b57fb0bbf5b59d9b23ac74a5aa9fb/mailnews/imap/public/nsIImapService.idl">annotate</a> |
<a href="/comm-central/diff/fac3f825a13b57fb0bbf5b59d9b23ac74a5aa9fb/mailnews/imap/public/nsIImapService.idl">diff</a> |
<a href="/comm-central/comparison/fac3f825a13b57fb0bbf5b59d9b23ac74a5aa9fb/mailnews/imap/public/nsIImapService.idl">comparison</a> |
<a href="/comm-central/log/fac3f825a13b57fb0bbf5b59d9b23ac74a5aa9fb/mailnews/imap/public/nsIImapService.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/fac3f825a13b57fb0bbf5b59d9b23ac74a5aa9fb/mailnews/imap/src/nsImapProtocol.cpp">mailnews/imap/src/nsImapProtocol.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/fac3f825a13b57fb0bbf5b59d9b23ac74a5aa9fb/mailnews/imap/src/nsImapProtocol.cpp">file</a> |
<a href="/comm-central/annotate/fac3f825a13b57fb0bbf5b59d9b23ac74a5aa9fb/mailnews/imap/src/nsImapProtocol.cpp">annotate</a> |
<a href="/comm-central/diff/fac3f825a13b57fb0bbf5b59d9b23ac74a5aa9fb/mailnews/imap/src/nsImapProtocol.cpp">diff</a> |
<a href="/comm-central/comparison/fac3f825a13b57fb0bbf5b59d9b23ac74a5aa9fb/mailnews/imap/src/nsImapProtocol.cpp">comparison</a> |
<a href="/comm-central/log/fac3f825a13b57fb0bbf5b59d9b23ac74a5aa9fb/mailnews/imap/src/nsImapProtocol.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/fac3f825a13b57fb0bbf5b59d9b23ac74a5aa9fb/mailnews/imap/src/nsImapService.cpp">mailnews/imap/src/nsImapService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/fac3f825a13b57fb0bbf5b59d9b23ac74a5aa9fb/mailnews/imap/src/nsImapService.cpp">file</a> |
<a href="/comm-central/annotate/fac3f825a13b57fb0bbf5b59d9b23ac74a5aa9fb/mailnews/imap/src/nsImapService.cpp">annotate</a> |
<a href="/comm-central/diff/fac3f825a13b57fb0bbf5b59d9b23ac74a5aa9fb/mailnews/imap/src/nsImapService.cpp">diff</a> |
<a href="/comm-central/comparison/fac3f825a13b57fb0bbf5b59d9b23ac74a5aa9fb/mailnews/imap/src/nsImapService.cpp">comparison</a> |
<a href="/comm-central/log/fac3f825a13b57fb0bbf5b59d9b23ac74a5aa9fb/mailnews/imap/src/nsImapService.cpp">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/imap/public/nsIImapService.idl</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/imap/public/nsIImapService.idl</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -80,27 +80,27 @@ interface nsIImapService : nsISupports</span>
<a href="#l1.4"></a><span id="l1.4">    * @param aMsgWindow          msg window url is running in, can be null</span>
<a href="#l1.5"></a><span id="l1.5">    *</span>
<a href="#l1.6"></a><span id="l1.6">    * @returns the url created to run the lite select in.</span>
<a href="#l1.7"></a><span id="l1.7">    */</span>
<a href="#l1.8"></a><span id="l1.8">   nsIURI liteSelectFolder(in nsIEventTarget aClientEventTarget,</span>
<a href="#l1.9"></a><span id="l1.9">                         in nsIMsgFolder aImapMailFolder,</span>
<a href="#l1.10"></a><span id="l1.10">                         in nsIUrlListener aUrlListener,</span>
<a href="#l1.11"></a><span id="l1.11">                         in nsIMsgWindow aMsgWindow);</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-  </span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+</span>
<a href="#l1.14"></a><span id="l1.14">   void addImapFetchToUrl(in nsIURI aURL,</span>
<a href="#l1.15"></a><span id="l1.15">                          in nsIMsgFolder aImapMailFolder,</span>
<a href="#l1.16"></a><span id="l1.16">                          in ACString aMessageIdentifierList,</span>
<a href="#l1.17"></a><span id="l1.17">                          in ACString aAdditionalHeader);</span>
<a href="#l1.18"></a><span id="l1.18"> </span>
<a href="#l1.19"></a><span id="l1.19">   void fetchMessage(in nsIImapUrl aUrl,</span>
<a href="#l1.20"></a><span id="l1.20">                     in nsImapState aImapAction,</span>
<a href="#l1.21"></a><span id="l1.21">                     in nsIMsgFolder aImapMailFolder,</span>
<a href="#l1.22"></a><span id="l1.22">                     in nsIImapMessageSink aImapMessageSink,</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineminus">-                    in nsIMsgWindow aMsgWindow, </span>
<a href="#l1.24"></a><span id="l1.24" class="difflineplus">+                    in nsIMsgWindow aMsgWindow,</span>
<a href="#l1.25"></a><span id="l1.25">                     in nsISupports aConsumer,</span>
<a href="#l1.26"></a><span id="l1.26">                     in ACString aMessageIdentifierList,</span>
<a href="#l1.27"></a><span id="l1.27">                     in boolean convertDataToText,</span>
<a href="#l1.28"></a><span id="l1.28">                     in ACString additionalHeader,</span>
<a href="#l1.29"></a><span id="l1.29">                     out nsIURI aOutURL);</span>
<a href="#l1.30"></a><span id="l1.30"> </span>
<a href="#l1.31"></a><span id="l1.31">   void noop(in nsIEventTarget aClientEventTarget,</span>
<a href="#l1.32"></a><span id="l1.32">             in nsIMsgFolder aImapMailFolder,</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineat">@@ -173,52 +173,52 @@ interface nsIImapService : nsISupports</span>
<a href="#l1.34"></a><span id="l1.34">                       out nsIURI aURL,</span>
<a href="#l1.35"></a><span id="l1.35">                       in ACString aMessageIdentifierList,</span>
<a href="#l1.36"></a><span id="l1.36">                       in boolean aMessageIdsAreUID);</span>
<a href="#l1.37"></a><span id="l1.37"> </span>
<a href="#l1.38"></a><span id="l1.38">   void deleteAllMessages(in nsIEventTarget aClientEventTarget,</span>
<a href="#l1.39"></a><span id="l1.39">                          in nsIMsgFolder aImapMailFolder,</span>
<a href="#l1.40"></a><span id="l1.40">                          in nsIUrlListener aUrlListener,</span>
<a href="#l1.41"></a><span id="l1.41">                          out nsIURI aURL);</span>
<a href="#l1.42"></a><span id="l1.42" class="difflineminus">-  </span>
<a href="#l1.43"></a><span id="l1.43" class="difflineplus">+</span>
<a href="#l1.44"></a><span id="l1.44">   void addMessageFlags(in nsIEventTarget aClientEventTarget,</span>
<a href="#l1.45"></a><span id="l1.45">                          in nsIMsgFolder aImapMailFolder,</span>
<a href="#l1.46"></a><span id="l1.46">                          in nsIUrlListener aUrlListener,</span>
<a href="#l1.47"></a><span id="l1.47">                          out nsIURI aURL,</span>
<a href="#l1.48"></a><span id="l1.48">                          in ACString aMessageIdentifierList,</span>
<a href="#l1.49"></a><span id="l1.49">                          in imapMessageFlagsType aFlags,</span>
<a href="#l1.50"></a><span id="l1.50">                          in boolean aMessageIdsAreUID);</span>
<a href="#l1.51"></a><span id="l1.51" class="difflineminus">-  </span>
<a href="#l1.52"></a><span id="l1.52" class="difflineplus">+</span>
<a href="#l1.53"></a><span id="l1.53">   void subtractMessageFlags(in nsIEventTarget aClientEventTarget,</span>
<a href="#l1.54"></a><span id="l1.54">                             in nsIMsgFolder aImapMailFolder,</span>
<a href="#l1.55"></a><span id="l1.55">                             in nsIUrlListener aUrlListener,</span>
<a href="#l1.56"></a><span id="l1.56">                             out nsIURI aURL,</span>
<a href="#l1.57"></a><span id="l1.57">                             in ACString aMessageIdentifierList,</span>
<a href="#l1.58"></a><span id="l1.58">                             in imapMessageFlagsType aFlags,</span>
<a href="#l1.59"></a><span id="l1.59">                             in boolean aMessageIdsAreUID);</span>
<a href="#l1.60"></a><span id="l1.60"> </span>
<a href="#l1.61"></a><span id="l1.61">   void setMessageFlags(in nsIEventTarget aClientEventTarget,</span>
<a href="#l1.62"></a><span id="l1.62">                        in nsIMsgFolder aImapMailFolder,</span>
<a href="#l1.63"></a><span id="l1.63">                        in nsIUrlListener aUrlListener,</span>
<a href="#l1.64"></a><span id="l1.64">                        out nsIURI aURL,</span>
<a href="#l1.65"></a><span id="l1.65">                        in ACString aMessageIdentifierList,</span>
<a href="#l1.66"></a><span id="l1.66">                        in imapMessageFlagsType aFlags,</span>
<a href="#l1.67"></a><span id="l1.67">                        in boolean aMessageIdsAreUID);</span>
<a href="#l1.68"></a><span id="l1.68" class="difflineminus">-  </span>
<a href="#l1.69"></a><span id="l1.69" class="difflineplus">+</span>
<a href="#l1.70"></a><span id="l1.70">   void discoverAllFolders(in nsIEventTarget aClientEventTarget,</span>
<a href="#l1.71"></a><span id="l1.71">                           in nsIMsgFolder aImapMailFolder,</span>
<a href="#l1.72"></a><span id="l1.72">                           in nsIUrlListener aUrlListener,</span>
<a href="#l1.73"></a><span id="l1.73">                           in nsIMsgWindow aMsgWindow,</span>
<a href="#l1.74"></a><span id="l1.74">                           out nsIURI aURL);</span>
<a href="#l1.75"></a><span id="l1.75"> </span>
<a href="#l1.76"></a><span id="l1.76">   void discoverAllAndSubscribedFolders(in nsIEventTarget aClientEventTarget,</span>
<a href="#l1.77"></a><span id="l1.77">                                        in nsIMsgFolder aImapMailFolder,</span>
<a href="#l1.78"></a><span id="l1.78">                                        in nsIUrlListener aUrlListener,</span>
<a href="#l1.79"></a><span id="l1.79">                                        out nsIURI aURL);</span>
<a href="#l1.80"></a><span id="l1.80" class="difflineminus">-  void discoverChildren(in nsIEventTarget aClientEventTarget, </span>
<a href="#l1.81"></a><span id="l1.81" class="difflineplus">+  void discoverChildren(in nsIEventTarget aClientEventTarget,</span>
<a href="#l1.82"></a><span id="l1.82">                         in nsIMsgFolder aImapMailFolder,</span>
<a href="#l1.83"></a><span id="l1.83">                         in nsIUrlListener aUrlListener,</span>
<a href="#l1.84"></a><span id="l1.84">                         in ACString folderPath,</span>
<a href="#l1.85"></a><span id="l1.85">                         out nsIURI aURL);</span>
<a href="#l1.86"></a><span id="l1.86"> </span>
<a href="#l1.87"></a><span id="l1.87">   void onlineMessageCopy(in nsIEventTarget aClientEventTarget,</span>
<a href="#l1.88"></a><span id="l1.88">                          in nsIMsgFolder aSrcFolder,</span>
<a href="#l1.89"></a><span id="l1.89">                          in ACString aMessageIds,</span>
<a href="#l1.90"></a><span id="l1.90" class="difflineat">@@ -236,17 +236,17 @@ interface nsIImapService : nsISupports</span>
<a href="#l1.91"></a><span id="l1.91">                              in nsIMsgFolder aDstFolder,</span>
<a href="#l1.92"></a><span id="l1.92">                              in ACString aMessageId,</span>
<a href="#l1.93"></a><span id="l1.93">                              in boolean idsAreUids,</span>
<a href="#l1.94"></a><span id="l1.94">                              in boolean aInSelectedState,</span>
<a href="#l1.95"></a><span id="l1.95">                              in nsIUrlListener aUrlListener,</span>
<a href="#l1.96"></a><span id="l1.96">                              out nsIURI aURL,</span>
<a href="#l1.97"></a><span id="l1.97">                              in nsISupports aCopyState,</span>
<a href="#l1.98"></a><span id="l1.98">                              in nsIMsgWindow aMsgWindow);</span>
<a href="#l1.99"></a><span id="l1.99" class="difflineminus">-  </span>
<a href="#l1.100"></a><span id="l1.100" class="difflineplus">+</span>
<a href="#l1.101"></a><span id="l1.101">   void downloadMessagesForOffline(in ACString aMessageIds, in nsIMsgFolder aSrcFolder,</span>
<a href="#l1.102"></a><span id="l1.102">                       in nsIUrlListener aListener, in nsIMsgWindow   aMsgWindow);</span>
<a href="#l1.103"></a><span id="l1.103"> </span>
<a href="#l1.104"></a><span id="l1.104">   nsIURI moveFolder(in nsIEventTarget aClientEventTarget,</span>
<a href="#l1.105"></a><span id="l1.105">                     in nsIMsgFolder aSrcFolder,</span>
<a href="#l1.106"></a><span id="l1.106">                     in nsIMsgFolder aDstFolder,</span>
<a href="#l1.107"></a><span id="l1.107">                     in nsIUrlListener aUrlListener,</span>
<a href="#l1.108"></a><span id="l1.108">                     in nsIMsgWindow msgWindow);</span>
<a href="#l1.109"></a><span id="l1.109" class="difflineat">@@ -261,17 +261,17 @@ interface nsIImapService : nsISupports</span>
<a href="#l1.110"></a><span id="l1.110">                       in nsIMsgFolder aFolder,</span>
<a href="#l1.111"></a><span id="l1.111">                       in nsIUrlListener aUrlListener,</span>
<a href="#l1.112"></a><span id="l1.112">                       in nsIMsgWindow aMsgWindow);</span>
<a href="#l1.113"></a><span id="l1.113"> </span>
<a href="#l1.114"></a><span id="l1.114">   nsIURI createFolder(in nsIEventTarget aClientEventTarget,</span>
<a href="#l1.115"></a><span id="l1.115">                       in nsIMsgFolder aParentFolder,</span>
<a href="#l1.116"></a><span id="l1.116">                       in AString aLeafName,</span>
<a href="#l1.117"></a><span id="l1.117">                       in nsIUrlListener aUrlListener);</span>
<a href="#l1.118"></a><span id="l1.118" class="difflineminus">-  </span>
<a href="#l1.119"></a><span id="l1.119" class="difflineplus">+</span>
<a href="#l1.120"></a><span id="l1.120">   nsIURI listFolder(in nsIEventTarget aClientEventTarget,</span>
<a href="#l1.121"></a><span id="l1.121">                     in nsIMsgFolder aMailFolder,</span>
<a href="#l1.122"></a><span id="l1.122">                     in nsIUrlListener aUrlListener);</span>
<a href="#l1.123"></a><span id="l1.123"> </span>
<a href="#l1.124"></a><span id="l1.124">   nsIURI subscribeFolder(in nsIEventTarget aClientEventTarget,</span>
<a href="#l1.125"></a><span id="l1.125">                          in nsIMsgFolder aMailFolder,</span>
<a href="#l1.126"></a><span id="l1.126">                          in AString mailboxName,</span>
<a href="#l1.127"></a><span id="l1.127">                          in nsIUrlListener aUrlListener);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/imap/src/nsImapProtocol.cpp</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapProtocol.cpp</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -9145,21 +9145,18 @@ nsresult nsImapMockChannel::ReadFromImap</span>
<a href="#l2.4"></a><span id="l2.4">   // loading the url consists of asking the server to add the url to it's imap event queue....</span>
<a href="#l2.5"></a><span id="l2.5">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l2.6"></a><span id="l2.6">   rv = mailnewsUrl-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l2.7"></a><span id="l2.7">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.8"></a><span id="l2.8">   nsCOMPtr&lt;nsIImapIncomingServer&gt; imapServer (do_QueryInterface(server, &amp;rv));</span>
<a href="#l2.9"></a><span id="l2.9">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.10"></a><span id="l2.10"> </span>
<a href="#l2.11"></a><span id="l2.11">   nsCOMPtr&lt;nsIThread&gt; thread(do_GetCurrentThread());</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-</span>
<a href="#l2.13"></a><span id="l2.13">   // Assume AsyncRead is always called from the UI thread.....</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineminus">-  rv = imapServer-&gt;GetImapConnectionAndLoadUrl(thread, imapUrl,</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineminus">-                                               nsnull);</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineminus">-  return rv;</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineplus">+  return imapServer-&gt;GetImapConnectionAndLoadUrl(thread, imapUrl, nsnull);</span>
<a href="#l2.18"></a><span id="l2.18"> }</span>
<a href="#l2.19"></a><span id="l2.19"> </span>
<a href="#l2.20"></a><span id="l2.20"> // for messages stored in our offline cache, we have special code to handle that...</span>
<a href="#l2.21"></a><span id="l2.21"> // If it's in the local cache, we return true and we can abort the download because</span>
<a href="#l2.22"></a><span id="l2.22"> // this method does the rest of the work.</span>
<a href="#l2.23"></a><span id="l2.23"> bool nsImapMockChannel::ReadFromLocalCache()</span>
<a href="#l2.24"></a><span id="l2.24"> {</span>
<a href="#l2.25"></a><span id="l2.25">   nsresult rv = NS_OK;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/imap/src/nsImapService.cpp</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapService.cpp</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -206,18 +206,18 @@ nsresult nsImapService::GetFolderName(ns</span>
<a href="#l3.4"></a><span id="l3.4"> }</span>
<a href="#l3.5"></a><span id="l3.5"> </span>
<a href="#l3.6"></a><span id="l3.6"> NS_IMETHODIMP nsImapService::SelectFolder(nsIEventTarget *aClientEventTarget, </span>
<a href="#l3.7"></a><span id="l3.7">                                           nsIMsgFolder *aImapMailFolder, </span>
<a href="#l3.8"></a><span id="l3.8">                                           nsIUrlListener *aUrlListener, </span>
<a href="#l3.9"></a><span id="l3.9">                                           nsIMsgWindow *aMsgWindow,</span>
<a href="#l3.10"></a><span id="l3.10">                                           nsIURI **aURL)</span>
<a href="#l3.11"></a><span id="l3.11"> {</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aClientEventTarget);</span>
<a href="#l3.13"></a><span id="l3.13">   NS_ENSURE_ARG_POINTER(aImapMailFolder);</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aClientEventTarget);</span>
<a href="#l3.15"></a><span id="l3.15"> </span>
<a href="#l3.16"></a><span id="l3.16">   if (WeAreOffline())</span>
<a href="#l3.17"></a><span id="l3.17">     return NS_MSG_ERROR_OFFLINE;</span>
<a href="#l3.18"></a><span id="l3.18"> </span>
<a href="#l3.19"></a><span id="l3.19">   bool canOpenThisFolder = true;</span>
<a href="#l3.20"></a><span id="l3.20">   nsCOMPtr&lt;nsIMsgImapMailFolder&gt; imapFolder = do_QueryInterface(aImapMailFolder);</span>
<a href="#l3.21"></a><span id="l3.21">   if (imapFolder)</span>
<a href="#l3.22"></a><span id="l3.22">     imapFolder-&gt;GetCanOpenFolder(&amp;canOpenThisFolder);</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineat">@@ -263,16 +263,19 @@ NS_IMETHODIMP nsImapService::SelectFolde</span>
<a href="#l3.24"></a><span id="l3.24"> </span>
<a href="#l3.25"></a><span id="l3.25"> // lite select, used to verify UIDVALIDITY while going on/offline</span>
<a href="#l3.26"></a><span id="l3.26"> NS_IMETHODIMP nsImapService::LiteSelectFolder(nsIEventTarget *aClientEventTarget,</span>
<a href="#l3.27"></a><span id="l3.27">                                               nsIMsgFolder *aImapMailFolder,</span>
<a href="#l3.28"></a><span id="l3.28">                                               nsIUrlListener *aUrlListener,</span>
<a href="#l3.29"></a><span id="l3.29">                                               nsIMsgWindow *aMsgWindow,</span>
<a href="#l3.30"></a><span id="l3.30">                                               nsIURI **aURL)</span>
<a href="#l3.31"></a><span id="l3.31"> {</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aClientEventTarget);</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aImapMailFolder);</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineplus">+</span>
<a href="#l3.35"></a><span id="l3.35">   return FolderCommand(aClientEventTarget, aImapMailFolder, aUrlListener,</span>
<a href="#l3.36"></a><span id="l3.36">                        &quot;/liteselect&gt;&quot;, nsIImapUrl::nsImapLiteSelectFolder, aMsgWindow, aURL);</span>
<a href="#l3.37"></a><span id="l3.37"> }</span>
<a href="#l3.38"></a><span id="l3.38"> </span>
<a href="#l3.39"></a><span id="l3.39"> NS_IMETHODIMP nsImapService::GetUrlForUri(const char *aMessageURI, </span>
<a href="#l3.40"></a><span id="l3.40">                                           nsIURI **aURL, </span>
<a href="#l3.41"></a><span id="l3.41">                                           nsIMsgWindow *aMsgWindow) </span>
<a href="#l3.42"></a><span id="l3.42"> {</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineat">@@ -690,17 +693,16 @@ nsresult nsImapService::FetchMimePart(ns</span>
<a href="#l3.44"></a><span id="l3.44">       {</span>
<a href="#l3.45"></a><span id="l3.45">         // I'd like to get rid of this code as I believe that we always get a docshell</span>
<a href="#l3.46"></a><span id="l3.46">         // or stream listener passed into us in this method but i'm not sure yet...</span>
<a href="#l3.47"></a><span id="l3.47">         // I'm going to use an assert for now to figure out if this is ever getting called</span>
<a href="#l3.48"></a><span id="l3.48"> #if defined(DEBUG_mscott) || defined(DEBUG_bienvenu)</span>
<a href="#l3.49"></a><span id="l3.49">         NS_ERROR(&quot;oops...someone still is reaching this part of the code&quot;);</span>
<a href="#l3.50"></a><span id="l3.50"> #endif</span>
<a href="#l3.51"></a><span id="l3.51">         nsCOMPtr&lt;nsIThread&gt; thread(do_GetCurrentThread());</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineminus">-</span>
<a href="#l3.53"></a><span id="l3.53">         rv = GetImapConnectionAndLoadUrl(thread, aImapUrl,</span>
<a href="#l3.54"></a><span id="l3.54">                                          aDisplayConsumer, aURL);</span>
<a href="#l3.55"></a><span id="l3.55">       }</span>
<a href="#l3.56"></a><span id="l3.56">     }</span>
<a href="#l3.57"></a><span id="l3.57">   }</span>
<a href="#l3.58"></a><span id="l3.58">   return rv;</span>
<a href="#l3.59"></a><span id="l3.59"> }</span>
<a href="#l3.60"></a><span id="l3.60"> </span>
<a href="#l3.61"></a><span id="l3.61" class="difflineat">@@ -782,17 +784,16 @@ NS_IMETHODIMP nsImapService::CopyMessage</span>
<a href="#l3.62"></a><span id="l3.62">   NS_ENSURE_ARG_POINTER(aKeys);</span>
<a href="#l3.63"></a><span id="l3.63"> </span>
<a href="#l3.64"></a><span id="l3.64">   nsresult rv;</span>
<a href="#l3.65"></a><span id="l3.65">   nsCOMPtr&lt;nsISupports&gt; streamSupport = do_QueryInterface(aMailboxCopy, &amp;rv);</span>
<a href="#l3.66"></a><span id="l3.66">   if (!streamSupport || NS_FAILED(rv)) </span>
<a href="#l3.67"></a><span id="l3.67">     return rv;</span>
<a href="#l3.68"></a><span id="l3.68">   </span>
<a href="#l3.69"></a><span id="l3.69">   nsCOMPtr&lt;nsIMsgFolder&gt; folder = srcFolder;</span>
<a href="#l3.70"></a><span id="l3.70" class="difflineminus">-  nsCAutoString msgKey;</span>
<a href="#l3.71"></a><span id="l3.71">   if (NS_SUCCEEDED(rv))</span>
<a href="#l3.72"></a><span id="l3.72">   {</span>
<a href="#l3.73"></a><span id="l3.73">     nsCOMPtr&lt;nsIImapMessageSink&gt; imapMessageSink(do_QueryInterface(folder, &amp;rv));</span>
<a href="#l3.74"></a><span id="l3.74">     if (NS_SUCCEEDED(rv))</span>
<a href="#l3.75"></a><span id="l3.75">     {</span>
<a href="#l3.76"></a><span id="l3.76">       // we generate the uri for the first message so that way on down the line,</span>
<a href="#l3.77"></a><span id="l3.77">       // GetMessage in nsCopyMessageStreamListener will get an unescaped username</span>
<a href="#l3.78"></a><span id="l3.78">       // and be able to find the msg hdr. See bug 259656 for details</span>
<a href="#l3.79"></a><span id="l3.79" class="difflineat">@@ -1154,16 +1155,17 @@ NS_IMETHODIMP nsImapService::StreamMessa</span>
<a href="#l3.80"></a><span id="l3.80">                                            nsIMsgWindow *aMsgWindow,</span>
<a href="#l3.81"></a><span id="l3.81">                                            nsIUrlListener *aUrlListener, </span>
<a href="#l3.82"></a><span id="l3.82">                                            bool aConvertData,</span>
<a href="#l3.83"></a><span id="l3.83">                                            const nsACString &amp;aAdditionalHeader,</span>
<a href="#l3.84"></a><span id="l3.84">                                            bool aLocalOnly,</span>
<a href="#l3.85"></a><span id="l3.85">                                            nsIURI **aURL)</span>
<a href="#l3.86"></a><span id="l3.86"> {</span>
<a href="#l3.87"></a><span id="l3.87">   NS_ENSURE_ARG_POINTER(aMessageURI);</span>
<a href="#l3.88"></a><span id="l3.88" class="difflineplus">+</span>
<a href="#l3.89"></a><span id="l3.89">   nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l3.90"></a><span id="l3.90">   nsCAutoString msgKey;</span>
<a href="#l3.91"></a><span id="l3.91">   nsCAutoString mimePart;</span>
<a href="#l3.92"></a><span id="l3.92">   nsCAutoString folderURI;</span>
<a href="#l3.93"></a><span id="l3.93">   nsMsgKey key;</span>
<a href="#l3.94"></a><span id="l3.94"> </span>
<a href="#l3.95"></a><span id="l3.95">   nsresult rv = DecomposeImapURI(nsDependentCString(aMessageURI), getter_AddRefs(folder), msgKey);</span>
<a href="#l3.96"></a><span id="l3.96">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.97"></a><span id="l3.97" class="difflineat">@@ -1410,18 +1412,18 @@ NS_IMETHODIMP nsImapService::GetHeaders(</span>
<a href="#l3.98"></a><span id="l3.98">                                         nsIUrlListener *aUrlListener, </span>
<a href="#l3.99"></a><span id="l3.99">                                         nsIURI **aURL,</span>
<a href="#l3.100"></a><span id="l3.100">                                         const nsACString &amp;messageIdentifierList,</span>
<a href="#l3.101"></a><span id="l3.101">                                         bool messageIdsAreUID)</span>
<a href="#l3.102"></a><span id="l3.102"> {</span>
<a href="#l3.103"></a><span id="l3.103">   // create a protocol instance to handle the request.</span>
<a href="#l3.104"></a><span id="l3.104">   // NOTE: once we start working with multiple connections, this step will be much more complicated...but for now</span>
<a href="#l3.105"></a><span id="l3.105">   // just create a connection and process the request.</span>
<a href="#l3.106"></a><span id="l3.106" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aClientEventTarget);</span>
<a href="#l3.107"></a><span id="l3.107">   NS_ENSURE_ARG_POINTER(aImapMailFolder);</span>
<a href="#l3.108"></a><span id="l3.108" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aClientEventTarget);</span>
<a href="#l3.109"></a><span id="l3.109"> </span>
<a href="#l3.110"></a><span id="l3.110">   nsCOMPtr&lt;nsIImapUrl&gt; imapUrl;</span>
<a href="#l3.111"></a><span id="l3.111">   nsCAutoString urlSpec;</span>
<a href="#l3.112"></a><span id="l3.112">   char hierarchyDelimiter = GetHierarchyDelimiter(aImapMailFolder);</span>
<a href="#l3.113"></a><span id="l3.113"> </span>
<a href="#l3.114"></a><span id="l3.114">   nsresult rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(imapUrl), aImapMailFolder, </span>
<a href="#l3.115"></a><span id="l3.115">                                      aUrlListener, urlSpec, hierarchyDelimiter);</span>
<a href="#l3.116"></a><span id="l3.116">   if (NS_SUCCEEDED(rv) &amp;&amp; imapUrl)</span>
<a href="#l3.117"></a><span id="l3.117" class="difflineat">@@ -1461,18 +1463,18 @@ NS_IMETHODIMP nsImapService::GetHeaders(</span>
<a href="#l3.118"></a><span id="l3.118"> /* will not affect the 'SEEN' flag */</span>
<a href="#l3.119"></a><span id="l3.119"> NS_IMETHODIMP nsImapService::GetBodyStart(nsIEventTarget *aClientEventTarget, </span>
<a href="#l3.120"></a><span id="l3.120">                                           nsIMsgFolder *aImapMailFolder, </span>
<a href="#l3.121"></a><span id="l3.121">                                           nsIUrlListener *aUrlListener, </span>
<a href="#l3.122"></a><span id="l3.122">                                           const nsACString &amp;messageIdentifierList,</span>
<a href="#l3.123"></a><span id="l3.123">                                           PRInt32 numBytes,</span>
<a href="#l3.124"></a><span id="l3.124">                                           nsIURI **aURL)</span>
<a href="#l3.125"></a><span id="l3.125"> {</span>
<a href="#l3.126"></a><span id="l3.126" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aClientEventTarget);</span>
<a href="#l3.127"></a><span id="l3.127">   NS_ENSURE_ARG_POINTER(aImapMailFolder);</span>
<a href="#l3.128"></a><span id="l3.128" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aClientEventTarget);</span>
<a href="#l3.129"></a><span id="l3.129"> </span>
<a href="#l3.130"></a><span id="l3.130">   nsresult rv;</span>
<a href="#l3.131"></a><span id="l3.131">   nsCOMPtr&lt;nsIImapUrl&gt; imapUrl;</span>
<a href="#l3.132"></a><span id="l3.132">   nsCAutoString urlSpec;</span>
<a href="#l3.133"></a><span id="l3.133"> </span>
<a href="#l3.134"></a><span id="l3.134">   char hierarchyDelimiter = GetHierarchyDelimiter(aImapMailFolder);</span>
<a href="#l3.135"></a><span id="l3.135">   rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(imapUrl), aImapMailFolder, </span>
<a href="#l3.136"></a><span id="l3.136">     aUrlListener, urlSpec, hierarchyDelimiter);</span>
<a href="#l3.137"></a><span id="l3.137" class="difflineat">@@ -1500,26 +1502,26 @@ NS_IMETHODIMP nsImapService::GetBodyStar</span>
<a href="#l3.138"></a><span id="l3.138">       rv = uri-&gt;SetSpec(urlSpec);</span>
<a href="#l3.139"></a><span id="l3.139">       if (NS_SUCCEEDED(rv))</span>
<a href="#l3.140"></a><span id="l3.140">         rv = GetImapConnectionAndLoadUrl(aClientEventTarget, imapUrl, nsnull, aURL);</span>
<a href="#l3.141"></a><span id="l3.141">     }</span>
<a href="#l3.142"></a><span id="l3.142">   }</span>
<a href="#l3.143"></a><span id="l3.143">   return rv;</span>
<a href="#l3.144"></a><span id="l3.144"> }</span>
<a href="#l3.145"></a><span id="l3.145"> </span>
<a href="#l3.146"></a><span id="l3.146" class="difflineminus">-nsresult nsImapService::FolderCommand(nsIEventTarget *clientEventTarget, </span>
<a href="#l3.147"></a><span id="l3.147" class="difflineplus">+nsresult nsImapService::FolderCommand(nsIEventTarget *aClientEventTarget,</span>
<a href="#l3.148"></a><span id="l3.148">                                       nsIMsgFolder *imapMailFolder,</span>
<a href="#l3.149"></a><span id="l3.149">                                       nsIUrlListener *urlListener,</span>
<a href="#l3.150"></a><span id="l3.150">                                       const char *aCommand,</span>
<a href="#l3.151"></a><span id="l3.151">                                       nsImapAction imapAction,</span>
<a href="#l3.152"></a><span id="l3.152">                                       nsIMsgWindow *msgWindow,</span>
<a href="#l3.153"></a><span id="l3.153">                                       nsIURI **url)</span>
<a href="#l3.154"></a><span id="l3.154"> {</span>
<a href="#l3.155"></a><span id="l3.155" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aClientEventTarget);</span>
<a href="#l3.156"></a><span id="l3.156">   NS_ENSURE_ARG_POINTER(imapMailFolder);</span>
<a href="#l3.157"></a><span id="l3.157" class="difflineminus">-  NS_ENSURE_ARG_POINTER(clientEventTarget);</span>
<a href="#l3.158"></a><span id="l3.158"> </span>
<a href="#l3.159"></a><span id="l3.159">   nsCOMPtr&lt;nsIImapUrl&gt; imapUrl;</span>
<a href="#l3.160"></a><span id="l3.160">   nsCAutoString urlSpec;</span>
<a href="#l3.161"></a><span id="l3.161"> </span>
<a href="#l3.162"></a><span id="l3.162">   char hierarchyDelimiter = GetHierarchyDelimiter(imapMailFolder);</span>
<a href="#l3.163"></a><span id="l3.163">   nsresult rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(imapUrl),</span>
<a href="#l3.164"></a><span id="l3.164">                                      imapMailFolder, urlListener, urlSpec, hierarchyDelimiter);</span>
<a href="#l3.165"></a><span id="l3.165">   if (NS_SUCCEEDED(rv) &amp;&amp; imapUrl)</span>
<a href="#l3.166"></a><span id="l3.166" class="difflineat">@@ -1536,17 +1538,18 @@ nsresult nsImapService::FolderCommand(ns</span>
<a href="#l3.167"></a><span id="l3.167">       urlSpec.Append(aCommand);</span>
<a href="#l3.168"></a><span id="l3.168">       urlSpec.Append(hierarchyDelimiter);</span>
<a href="#l3.169"></a><span id="l3.169"> </span>
<a href="#l3.170"></a><span id="l3.170">       nsCString folderName;</span>
<a href="#l3.171"></a><span id="l3.171">       GetFolderName(imapMailFolder, folderName);</span>
<a href="#l3.172"></a><span id="l3.172">       urlSpec.Append(folderName);</span>
<a href="#l3.173"></a><span id="l3.173">       rv = uri-&gt;SetSpec(urlSpec);</span>
<a href="#l3.174"></a><span id="l3.174">       if (NS_SUCCEEDED(rv))</span>
<a href="#l3.175"></a><span id="l3.175" class="difflineminus">-        rv = GetImapConnectionAndLoadUrl(clientEventTarget, imapUrl, nsnull, url);</span>
<a href="#l3.176"></a><span id="l3.176" class="difflineplus">+        rv = GetImapConnectionAndLoadUrl(aClientEventTarget, imapUrl,</span>
<a href="#l3.177"></a><span id="l3.177" class="difflineplus">+                                         nsnull, url);</span>
<a href="#l3.178"></a><span id="l3.178">     }</span>
<a href="#l3.179"></a><span id="l3.179">   }</span>
<a href="#l3.180"></a><span id="l3.180">   return rv;</span>
<a href="#l3.181"></a><span id="l3.181"> }</span>
<a href="#l3.182"></a><span id="l3.182"> </span>
<a href="#l3.183"></a><span id="l3.183"> NS_IMETHODIMP</span>
<a href="#l3.184"></a><span id="l3.184"> nsImapService::VerifyLogon(nsIMsgFolder *aFolder, nsIUrlListener *aUrlListener,</span>
<a href="#l3.185"></a><span id="l3.185">                            nsIMsgWindow *aMsgWindow, nsIURI **aURL)</span>
<a href="#l3.186"></a><span id="l3.186" class="difflineat">@@ -1578,50 +1581,59 @@ nsImapService::VerifyLogon(nsIMsgFolder </span>
<a href="#l3.187"></a><span id="l3.187"> }</span>
<a href="#l3.188"></a><span id="l3.188"> </span>
<a href="#l3.189"></a><span id="l3.189"> // Noop, used to update a folder (causes server to send changes).</span>
<a href="#l3.190"></a><span id="l3.190"> NS_IMETHODIMP nsImapService::Noop(nsIEventTarget *aClientEventTarget, </span>
<a href="#l3.191"></a><span id="l3.191">                                   nsIMsgFolder *aImapMailFolder,</span>
<a href="#l3.192"></a><span id="l3.192">                                   nsIUrlListener *aUrlListener, </span>
<a href="#l3.193"></a><span id="l3.193">                                   nsIURI **aURL)</span>
<a href="#l3.194"></a><span id="l3.194"> {</span>
<a href="#l3.195"></a><span id="l3.195" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aClientEventTarget);</span>
<a href="#l3.196"></a><span id="l3.196" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aImapMailFolder);</span>
<a href="#l3.197"></a><span id="l3.197" class="difflineplus">+</span>
<a href="#l3.198"></a><span id="l3.198">   return FolderCommand(aClientEventTarget, aImapMailFolder, aUrlListener,</span>
<a href="#l3.199"></a><span id="l3.199">                        &quot;/selectnoop&gt;&quot;, nsIImapUrl::nsImapSelectNoopFolder, nsnull, aURL);</span>
<a href="#l3.200"></a><span id="l3.200"> }</span>
<a href="#l3.201"></a><span id="l3.201">     </span>
<a href="#l3.202"></a><span id="l3.202"> // FolderStatus, used to update message counts</span>
<a href="#l3.203"></a><span id="l3.203"> NS_IMETHODIMP nsImapService::UpdateFolderStatus(nsIEventTarget *aClientEventTarget, </span>
<a href="#l3.204"></a><span id="l3.204">                                                 nsIMsgFolder *aImapMailFolder,</span>
<a href="#l3.205"></a><span id="l3.205">                                                 nsIUrlListener *aUrlListener, </span>
<a href="#l3.206"></a><span id="l3.206">                                                 nsIURI **aURL)</span>
<a href="#l3.207"></a><span id="l3.207"> {</span>
<a href="#l3.208"></a><span id="l3.208" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aClientEventTarget);</span>
<a href="#l3.209"></a><span id="l3.209" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aImapMailFolder);</span>
<a href="#l3.210"></a><span id="l3.210" class="difflineplus">+</span>
<a href="#l3.211"></a><span id="l3.211">   return FolderCommand(aClientEventTarget, aImapMailFolder, aUrlListener,</span>
<a href="#l3.212"></a><span id="l3.212">                        &quot;/folderstatus&gt;&quot;, nsIImapUrl::nsImapFolderStatus, nsnull, aURL);</span>
<a href="#l3.213"></a><span id="l3.213"> }</span>
<a href="#l3.214"></a><span id="l3.214"> </span>
<a href="#l3.215"></a><span id="l3.215"> // Expunge, used to &quot;compress&quot; an imap folder,removes deleted messages.</span>
<a href="#l3.216"></a><span id="l3.216"> NS_IMETHODIMP nsImapService::Expunge(nsIEventTarget *aClientEventTarget,</span>
<a href="#l3.217"></a><span id="l3.217">                                      nsIMsgFolder *aImapMailFolder,</span>
<a href="#l3.218"></a><span id="l3.218">                                      nsIUrlListener *aUrlListener,</span>
<a href="#l3.219"></a><span id="l3.219">                                      nsIMsgWindow *aMsgWindow,</span>
<a href="#l3.220"></a><span id="l3.220">                                      nsIURI **aURL)</span>
<a href="#l3.221"></a><span id="l3.221"> {</span>
<a href="#l3.222"></a><span id="l3.222" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aClientEventTarget);</span>
<a href="#l3.223"></a><span id="l3.223" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aImapMailFolder);</span>
<a href="#l3.224"></a><span id="l3.224" class="difflineplus">+</span>
<a href="#l3.225"></a><span id="l3.225">   return FolderCommand(aClientEventTarget, aImapMailFolder, aUrlListener,</span>
<a href="#l3.226"></a><span id="l3.226">                        &quot;/Expunge&gt;&quot;, nsIImapUrl::nsImapExpungeFolder, aMsgWindow, aURL);</span>
<a href="#l3.227"></a><span id="l3.227"> }</span>
<a href="#l3.228"></a><span id="l3.228"> </span>
<a href="#l3.229"></a><span id="l3.229"> /* old-stle biff that doesn't download headers */</span>
<a href="#l3.230"></a><span id="l3.230"> NS_IMETHODIMP nsImapService::Biff(nsIEventTarget *aClientEventTarget, </span>
<a href="#l3.231"></a><span id="l3.231">                                   nsIMsgFolder *aImapMailFolder,</span>
<a href="#l3.232"></a><span id="l3.232">                                   nsIUrlListener *aUrlListener, </span>
<a href="#l3.233"></a><span id="l3.233">                                   nsIURI **aURL,</span>
<a href="#l3.234"></a><span id="l3.234">                                   PRUint32 uidHighWater)</span>
<a href="#l3.235"></a><span id="l3.235"> {</span>
<a href="#l3.236"></a><span id="l3.236" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aClientEventTarget);</span>
<a href="#l3.237"></a><span id="l3.237">   NS_ENSURE_ARG_POINTER(aImapMailFolder);</span>
<a href="#l3.238"></a><span id="l3.238" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aClientEventTarget);</span>
<a href="#l3.239"></a><span id="l3.239"> </span>
<a href="#l3.240"></a><span id="l3.240">   // static const char *formatString = &quot;biff&gt;%c%s&gt;%ld&quot;;</span>
<a href="#l3.241"></a><span id="l3.241">   nsCOMPtr&lt;nsIImapUrl&gt; imapUrl;</span>
<a href="#l3.242"></a><span id="l3.242">   nsCAutoString urlSpec;</span>
<a href="#l3.243"></a><span id="l3.243"> </span>
<a href="#l3.244"></a><span id="l3.244">   char hierarchyDelimiter = GetHierarchyDelimiter(aImapMailFolder);</span>
<a href="#l3.245"></a><span id="l3.245">   nsresult rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(imapUrl),</span>
<a href="#l3.246"></a><span id="l3.246">     aImapMailFolder, aUrlListener, urlSpec, hierarchyDelimiter);</span>
<a href="#l3.247"></a><span id="l3.247" class="difflineat">@@ -1650,16 +1662,19 @@ NS_IMETHODIMP nsImapService::Biff(nsIEve</span>
<a href="#l3.248"></a><span id="l3.248"> }</span>
<a href="#l3.249"></a><span id="l3.249"> </span>
<a href="#l3.250"></a><span id="l3.250"> NS_IMETHODIMP nsImapService::DeleteFolder(nsIEventTarget *aClientEventTarget,</span>
<a href="#l3.251"></a><span id="l3.251">                                           nsIMsgFolder *aImapMailFolder,</span>
<a href="#l3.252"></a><span id="l3.252">                                           nsIUrlListener *aUrlListener,</span>
<a href="#l3.253"></a><span id="l3.253">                                           nsIMsgWindow *aMsgWindow,</span>
<a href="#l3.254"></a><span id="l3.254">                                           nsIURI **aURL)</span>
<a href="#l3.255"></a><span id="l3.255"> {</span>
<a href="#l3.256"></a><span id="l3.256" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aClientEventTarget);</span>
<a href="#l3.257"></a><span id="l3.257" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aImapMailFolder);</span>
<a href="#l3.258"></a><span id="l3.258" class="difflineplus">+</span>
<a href="#l3.259"></a><span id="l3.259">   // If it's an aol server then use 'deletefolder' url to </span>
<a href="#l3.260"></a><span id="l3.260">   // remove all msgs first and then remove the folder itself.</span>
<a href="#l3.261"></a><span id="l3.261">   bool removeFolderAndMsgs = false;</span>
<a href="#l3.262"></a><span id="l3.262">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l3.263"></a><span id="l3.263">   if (NS_SUCCEEDED(aImapMailFolder-&gt;GetServer(getter_AddRefs(server))) &amp;&amp; server)</span>
<a href="#l3.264"></a><span id="l3.264">   {</span>
<a href="#l3.265"></a><span id="l3.265">     nsCOMPtr &lt;nsIImapIncomingServer&gt; imapServer = do_QueryInterface(server);</span>
<a href="#l3.266"></a><span id="l3.266">     if (imapServer) </span>
<a href="#l3.267"></a><span id="l3.267" class="difflineat">@@ -1673,18 +1688,18 @@ NS_IMETHODIMP nsImapService::DeleteFolde</span>
<a href="#l3.268"></a><span id="l3.268"> </span>
<a href="#l3.269"></a><span id="l3.269"> NS_IMETHODIMP nsImapService::DeleteMessages(nsIEventTarget *aClientEventTarget, </span>
<a href="#l3.270"></a><span id="l3.270">                                             nsIMsgFolder *aImapMailFolder, </span>
<a href="#l3.271"></a><span id="l3.271">                                             nsIUrlListener *aUrlListener, </span>
<a href="#l3.272"></a><span id="l3.272">                                             nsIURI **aURL,</span>
<a href="#l3.273"></a><span id="l3.273">                                             const nsACString &amp;messageIdentifierList,</span>
<a href="#l3.274"></a><span id="l3.274">                                             bool messageIdsAreUID)</span>
<a href="#l3.275"></a><span id="l3.275"> {</span>
<a href="#l3.276"></a><span id="l3.276" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aClientEventTarget);</span>
<a href="#l3.277"></a><span id="l3.277">   NS_ENSURE_ARG_POINTER(aImapMailFolder);</span>
<a href="#l3.278"></a><span id="l3.278" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aClientEventTarget);</span>
<a href="#l3.279"></a><span id="l3.279"> </span>
<a href="#l3.280"></a><span id="l3.280">   // create a protocol instance to handle the request.</span>
<a href="#l3.281"></a><span id="l3.281">   // NOTE: once we start working with multiple connections, this step will be much more complicated...but for now</span>
<a href="#l3.282"></a><span id="l3.282">   // just create a connection and process the request.</span>
<a href="#l3.283"></a><span id="l3.283">   nsresult rv;</span>
<a href="#l3.284"></a><span id="l3.284">   nsCOMPtr&lt;nsIImapUrl&gt; imapUrl;</span>
<a href="#l3.285"></a><span id="l3.285">   nsCAutoString urlSpec;</span>
<a href="#l3.286"></a><span id="l3.286"> </span>
<a href="#l3.287"></a><span id="l3.287" class="difflineat">@@ -1719,67 +1734,79 @@ NS_IMETHODIMP nsImapService::DeleteMessa</span>
<a href="#l3.288"></a><span id="l3.288"> }</span>
<a href="#l3.289"></a><span id="l3.289"> </span>
<a href="#l3.290"></a><span id="l3.290"> // Delete all messages in a folder, used to empty trash</span>
<a href="#l3.291"></a><span id="l3.291"> NS_IMETHODIMP nsImapService::DeleteAllMessages(nsIEventTarget *aClientEventTarget, </span>
<a href="#l3.292"></a><span id="l3.292">                                                nsIMsgFolder *aImapMailFolder,</span>
<a href="#l3.293"></a><span id="l3.293">                                                nsIUrlListener *aUrlListener, </span>
<a href="#l3.294"></a><span id="l3.294">                                                nsIURI **aURL)</span>
<a href="#l3.295"></a><span id="l3.295"> {</span>
<a href="#l3.296"></a><span id="l3.296" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aClientEventTarget);</span>
<a href="#l3.297"></a><span id="l3.297" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aImapMailFolder);</span>
<a href="#l3.298"></a><span id="l3.298" class="difflineplus">+</span>
<a href="#l3.299"></a><span id="l3.299">   return FolderCommand(aClientEventTarget, aImapMailFolder, aUrlListener,</span>
<a href="#l3.300"></a><span id="l3.300">                       &quot;/deleteallmsgs&gt;&quot;, nsIImapUrl::nsImapSelectNoopFolder, nsnull, aURL);</span>
<a href="#l3.301"></a><span id="l3.301"> }</span>
<a href="#l3.302"></a><span id="l3.302"> </span>
<a href="#l3.303"></a><span id="l3.303"> NS_IMETHODIMP nsImapService::AddMessageFlags(nsIEventTarget *aClientEventTarget,</span>
<a href="#l3.304"></a><span id="l3.304">                                              nsIMsgFolder *aImapMailFolder, </span>
<a href="#l3.305"></a><span id="l3.305">                                              nsIUrlListener *aUrlListener, </span>
<a href="#l3.306"></a><span id="l3.306">                                              nsIURI **aURL,</span>
<a href="#l3.307"></a><span id="l3.307">                                              const nsACString &amp;messageIdentifierList,</span>
<a href="#l3.308"></a><span id="l3.308">                                              imapMessageFlagsType flags,</span>
<a href="#l3.309"></a><span id="l3.309">                                              bool messageIdsAreUID)</span>
<a href="#l3.310"></a><span id="l3.310"> {</span>
<a href="#l3.311"></a><span id="l3.311" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aClientEventTarget);</span>
<a href="#l3.312"></a><span id="l3.312" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aImapMailFolder);</span>
<a href="#l3.313"></a><span id="l3.313" class="difflineplus">+</span>
<a href="#l3.314"></a><span id="l3.314">   return DiddleFlags(aClientEventTarget, aImapMailFolder, aUrlListener, aURL, messageIdentifierList,</span>
<a href="#l3.315"></a><span id="l3.315">                      &quot;addmsgflags&quot;, flags, messageIdsAreUID);</span>
<a href="#l3.316"></a><span id="l3.316"> }</span>
<a href="#l3.317"></a><span id="l3.317"> </span>
<a href="#l3.318"></a><span id="l3.318"> NS_IMETHODIMP nsImapService::SubtractMessageFlags(nsIEventTarget *aClientEventTarget,</span>
<a href="#l3.319"></a><span id="l3.319">                                                   nsIMsgFolder *aImapMailFolder, </span>
<a href="#l3.320"></a><span id="l3.320">                                                   nsIUrlListener *aUrlListener, </span>
<a href="#l3.321"></a><span id="l3.321">                                                   nsIURI **aURL,</span>
<a href="#l3.322"></a><span id="l3.322">                                                   const nsACString &amp;messageIdentifierList,</span>
<a href="#l3.323"></a><span id="l3.323">                                                   imapMessageFlagsType flags,</span>
<a href="#l3.324"></a><span id="l3.324">                                                   bool messageIdsAreUID)</span>
<a href="#l3.325"></a><span id="l3.325"> {</span>
<a href="#l3.326"></a><span id="l3.326" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aClientEventTarget);</span>
<a href="#l3.327"></a><span id="l3.327" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aImapMailFolder);</span>
<a href="#l3.328"></a><span id="l3.328" class="difflineplus">+</span>
<a href="#l3.329"></a><span id="l3.329">   return DiddleFlags(aClientEventTarget, aImapMailFolder, aUrlListener, aURL, messageIdentifierList,</span>
<a href="#l3.330"></a><span id="l3.330">                      &quot;subtractmsgflags&quot;, flags, messageIdsAreUID);</span>
<a href="#l3.331"></a><span id="l3.331"> }</span>
<a href="#l3.332"></a><span id="l3.332"> </span>
<a href="#l3.333"></a><span id="l3.333"> NS_IMETHODIMP nsImapService::SetMessageFlags(nsIEventTarget *aClientEventTarget,</span>
<a href="#l3.334"></a><span id="l3.334">                                              nsIMsgFolder *aImapMailFolder, </span>
<a href="#l3.335"></a><span id="l3.335">                                              nsIUrlListener *aUrlListener, </span>
<a href="#l3.336"></a><span id="l3.336">                                              nsIURI **aURL,</span>
<a href="#l3.337"></a><span id="l3.337">                                              const nsACString &amp;messageIdentifierList,</span>
<a href="#l3.338"></a><span id="l3.338">                                              imapMessageFlagsType flags,</span>
<a href="#l3.339"></a><span id="l3.339">                                              bool messageIdsAreUID)</span>
<a href="#l3.340"></a><span id="l3.340"> {</span>
<a href="#l3.341"></a><span id="l3.341" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aClientEventTarget);</span>
<a href="#l3.342"></a><span id="l3.342" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aImapMailFolder);</span>
<a href="#l3.343"></a><span id="l3.343" class="difflineplus">+</span>
<a href="#l3.344"></a><span id="l3.344">   return DiddleFlags(aClientEventTarget, aImapMailFolder, aUrlListener, aURL, messageIdentifierList,</span>
<a href="#l3.345"></a><span id="l3.345">                      &quot;setmsgflags&quot;, flags, messageIdsAreUID);</span>
<a href="#l3.346"></a><span id="l3.346"> }</span>
<a href="#l3.347"></a><span id="l3.347"> </span>
<a href="#l3.348"></a><span id="l3.348"> nsresult nsImapService::DiddleFlags(nsIEventTarget *aClientEventTarget, </span>
<a href="#l3.349"></a><span id="l3.349">                                     nsIMsgFolder *aImapMailFolder, </span>
<a href="#l3.350"></a><span id="l3.350">                                     nsIUrlListener *aUrlListener,</span>
<a href="#l3.351"></a><span id="l3.351">                                     nsIURI **aURL,</span>
<a href="#l3.352"></a><span id="l3.352">                                     const nsACString &amp;messageIdentifierList,</span>
<a href="#l3.353"></a><span id="l3.353">                                     const char *howToDiddle,</span>
<a href="#l3.354"></a><span id="l3.354">                                     imapMessageFlagsType flags,</span>
<a href="#l3.355"></a><span id="l3.355">                                     bool messageIdsAreUID)</span>
<a href="#l3.356"></a><span id="l3.356"> {</span>
<a href="#l3.357"></a><span id="l3.357" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aClientEventTarget);</span>
<a href="#l3.358"></a><span id="l3.358">   NS_ENSURE_ARG_POINTER(aImapMailFolder);</span>
<a href="#l3.359"></a><span id="l3.359" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aClientEventTarget);</span>
<a href="#l3.360"></a><span id="l3.360"> </span>
<a href="#l3.361"></a><span id="l3.361">   // create a protocol instance to handle the request.</span>
<a href="#l3.362"></a><span id="l3.362">   // NOTE: once we start working with multiple connections, </span>
<a href="#l3.363"></a><span id="l3.363">   //       this step will be much more complicated...but for now</span>
<a href="#l3.364"></a><span id="l3.364">   // just create a connection and process the request.</span>
<a href="#l3.365"></a><span id="l3.365">   nsCOMPtr&lt;nsIImapUrl&gt; imapUrl;</span>
<a href="#l3.366"></a><span id="l3.366">   nsCAutoString urlSpec;</span>
<a href="#l3.367"></a><span id="l3.367"> </span>
<a href="#l3.368"></a><span id="l3.368" class="difflineat">@@ -1848,18 +1875,18 @@ nsresult nsImapService::SetImapUrlSink(n</span>
<a href="#l3.369"></a><span id="l3.369"> }</span>
<a href="#l3.370"></a><span id="l3.370"> </span>
<a href="#l3.371"></a><span id="l3.371"> NS_IMETHODIMP nsImapService::DiscoverAllFolders(nsIEventTarget *aClientEventTarget,</span>
<a href="#l3.372"></a><span id="l3.372">                                                 nsIMsgFolder *aImapMailFolder,</span>
<a href="#l3.373"></a><span id="l3.373">                                                 nsIUrlListener *aUrlListener,</span>
<a href="#l3.374"></a><span id="l3.374">                                                 nsIMsgWindow *aMsgWindow,</span>
<a href="#l3.375"></a><span id="l3.375">                                                 nsIURI **aURL)</span>
<a href="#l3.376"></a><span id="l3.376"> {</span>
<a href="#l3.377"></a><span id="l3.377" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aClientEventTarget);</span>
<a href="#l3.378"></a><span id="l3.378">   NS_ENSURE_ARG_POINTER(aImapMailFolder);</span>
<a href="#l3.379"></a><span id="l3.379" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aClientEventTarget);</span>
<a href="#l3.380"></a><span id="l3.380"> </span>
<a href="#l3.381"></a><span id="l3.381">   nsCOMPtr&lt;nsIImapUrl&gt; imapUrl;</span>
<a href="#l3.382"></a><span id="l3.382">   nsCAutoString urlSpec;</span>
<a href="#l3.383"></a><span id="l3.383"> </span>
<a href="#l3.384"></a><span id="l3.384">   char hierarchyDelimiter = GetHierarchyDelimiter(aImapMailFolder);</span>
<a href="#l3.385"></a><span id="l3.385">   nsresult rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(imapUrl), aImapMailFolder, </span>
<a href="#l3.386"></a><span id="l3.386">                                      aUrlListener, urlSpec, hierarchyDelimiter);</span>
<a href="#l3.387"></a><span id="l3.387">   if (NS_SUCCEEDED (rv))</span>
<a href="#l3.388"></a><span id="l3.388" class="difflineat">@@ -1882,18 +1909,18 @@ NS_IMETHODIMP nsImapService::DiscoverAll</span>
<a href="#l3.389"></a><span id="l3.389">   return rv;</span>
<a href="#l3.390"></a><span id="l3.390"> }</span>
<a href="#l3.391"></a><span id="l3.391"> </span>
<a href="#l3.392"></a><span id="l3.392"> NS_IMETHODIMP nsImapService::DiscoverAllAndSubscribedFolders(nsIEventTarget *aClientEventTarget,</span>
<a href="#l3.393"></a><span id="l3.393">                                                              nsIMsgFolder *aImapMailFolder,</span>
<a href="#l3.394"></a><span id="l3.394">                                                              nsIUrlListener *aUrlListener,</span>
<a href="#l3.395"></a><span id="l3.395">                                                              nsIURI **aURL)</span>
<a href="#l3.396"></a><span id="l3.396"> {</span>
<a href="#l3.397"></a><span id="l3.397" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aClientEventTarget);</span>
<a href="#l3.398"></a><span id="l3.398">   NS_ENSURE_ARG_POINTER(aImapMailFolder);</span>
<a href="#l3.399"></a><span id="l3.399" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aClientEventTarget);</span>
<a href="#l3.400"></a><span id="l3.400"> </span>
<a href="#l3.401"></a><span id="l3.401">   nsCOMPtr&lt;nsIImapUrl&gt; aImapUrl;</span>
<a href="#l3.402"></a><span id="l3.402">   nsCAutoString urlSpec;</span>
<a href="#l3.403"></a><span id="l3.403"> </span>
<a href="#l3.404"></a><span id="l3.404">   char hierarchyDelimiter = GetHierarchyDelimiter(aImapMailFolder);</span>
<a href="#l3.405"></a><span id="l3.405">   nsresult rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(aImapUrl), aImapMailFolder,</span>
<a href="#l3.406"></a><span id="l3.406">                                      aUrlListener, urlSpec, hierarchyDelimiter);</span>
<a href="#l3.407"></a><span id="l3.407">   if (NS_SUCCEEDED(rv) &amp;&amp; aImapUrl)</span>
<a href="#l3.408"></a><span id="l3.408" class="difflineat">@@ -1912,18 +1939,18 @@ NS_IMETHODIMP nsImapService::DiscoverAll</span>
<a href="#l3.409"></a><span id="l3.409"> }</span>
<a href="#l3.410"></a><span id="l3.410"> </span>
<a href="#l3.411"></a><span id="l3.411"> NS_IMETHODIMP nsImapService::DiscoverChildren(nsIEventTarget *aClientEventTarget,</span>
<a href="#l3.412"></a><span id="l3.412">                                               nsIMsgFolder *aImapMailFolder,</span>
<a href="#l3.413"></a><span id="l3.413">                                               nsIUrlListener *aUrlListener,</span>
<a href="#l3.414"></a><span id="l3.414">                                               const nsACString &amp;folderPath,</span>
<a href="#l3.415"></a><span id="l3.415">                                               nsIURI **aURL)</span>
<a href="#l3.416"></a><span id="l3.416"> {</span>
<a href="#l3.417"></a><span id="l3.417" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aClientEventTarget);</span>
<a href="#l3.418"></a><span id="l3.418">   NS_ENSURE_ARG_POINTER(aImapMailFolder);</span>
<a href="#l3.419"></a><span id="l3.419" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aClientEventTarget);</span>
<a href="#l3.420"></a><span id="l3.420"> </span>
<a href="#l3.421"></a><span id="l3.421">   nsCOMPtr&lt;nsIImapUrl&gt; aImapUrl;</span>
<a href="#l3.422"></a><span id="l3.422">   nsCAutoString urlSpec;</span>
<a href="#l3.423"></a><span id="l3.423"> </span>
<a href="#l3.424"></a><span id="l3.424">   char hierarchyDelimiter = GetHierarchyDelimiter(aImapMailFolder);</span>
<a href="#l3.425"></a><span id="l3.425">   nsresult rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(aImapUrl), aImapMailFolder, </span>
<a href="#l3.426"></a><span id="l3.426">                                      aUrlListener, urlSpec, hierarchyDelimiter);</span>
<a href="#l3.427"></a><span id="l3.427">   if (NS_SUCCEEDED (rv))</span>
<a href="#l3.428"></a><span id="l3.428" class="difflineat">@@ -2224,17 +2251,17 @@ NS_IMETHODIMP nsImapService::AppendMessa</span>
<a href="#l3.429"></a><span id="l3.429">   return rv;</span>
<a href="#l3.430"></a><span id="l3.430"> }</span>
<a href="#l3.431"></a><span id="l3.431"> </span>
<a href="#l3.432"></a><span id="l3.432"> nsresult nsImapService::GetImapConnectionAndLoadUrl(nsIEventTarget *aClientEventTarget,</span>
<a href="#l3.433"></a><span id="l3.433">                                                     nsIImapUrl *aImapUrl,</span>
<a href="#l3.434"></a><span id="l3.434">                                                     nsISupports *aConsumer,</span>
<a href="#l3.435"></a><span id="l3.435">                                                     nsIURI **aURL)</span>
<a href="#l3.436"></a><span id="l3.436"> {</span>
<a href="#l3.437"></a><span id="l3.437" class="difflineminus">-  NS_ENSURE_ARG(aImapUrl);</span>
<a href="#l3.438"></a><span id="l3.438" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aImapUrl);</span>
<a href="#l3.439"></a><span id="l3.439"> </span>
<a href="#l3.440"></a><span id="l3.440">   bool isValidUrl;</span>
<a href="#l3.441"></a><span id="l3.441">   aImapUrl-&gt;GetValidUrl(&amp;isValidUrl);</span>
<a href="#l3.442"></a><span id="l3.442">   if (!isValidUrl)</span>
<a href="#l3.443"></a><span id="l3.443">     return NS_ERROR_FAILURE;</span>
<a href="#l3.444"></a><span id="l3.444"> </span>
<a href="#l3.445"></a><span id="l3.445">   if (WeAreOffline())</span>
<a href="#l3.446"></a><span id="l3.446">   {</span>
<a href="#l3.447"></a><span id="l3.447" class="difflineat">@@ -2263,24 +2290,24 @@ nsresult nsImapService::GetImapConnectio</span>
<a href="#l3.448"></a><span id="l3.448">   {</span>
<a href="#l3.449"></a><span id="l3.449">     nsCOMPtr&lt;nsIImapIncomingServer&gt; aImapServer(do_QueryInterface(aMsgIncomingServer, &amp;rv));</span>
<a href="#l3.450"></a><span id="l3.450">     if (NS_SUCCEEDED(rv) &amp;&amp; aImapServer)</span>
<a href="#l3.451"></a><span id="l3.451">       rv = aImapServer-&gt;GetImapConnectionAndLoadUrl(aClientEventTarget, aImapUrl, aConsumer);</span>
<a href="#l3.452"></a><span id="l3.452">   }</span>
<a href="#l3.453"></a><span id="l3.453">   return rv;</span>
<a href="#l3.454"></a><span id="l3.454"> }</span>
<a href="#l3.455"></a><span id="l3.455"> </span>
<a href="#l3.456"></a><span id="l3.456" class="difflineminus">-NS_IMETHODIMP nsImapService::MoveFolder(nsIEventTarget *eventTarget, </span>
<a href="#l3.457"></a><span id="l3.457" class="difflineplus">+NS_IMETHODIMP nsImapService::MoveFolder(nsIEventTarget *aClientEventTarget,</span>
<a href="#l3.458"></a><span id="l3.458">                                         nsIMsgFolder *srcFolder,</span>
<a href="#l3.459"></a><span id="l3.459">                                         nsIMsgFolder *dstFolder, </span>
<a href="#l3.460"></a><span id="l3.460">                                         nsIUrlListener *urlListener, </span>
<a href="#l3.461"></a><span id="l3.461">                                         nsIMsgWindow *msgWindow, </span>
<a href="#l3.462"></a><span id="l3.462">                                         nsIURI **url)</span>
<a href="#l3.463"></a><span id="l3.463"> {</span>
<a href="#l3.464"></a><span id="l3.464" class="difflineminus">-  NS_ENSURE_ARG_POINTER(eventTarget);</span>
<a href="#l3.465"></a><span id="l3.465" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aClientEventTarget);</span>
<a href="#l3.466"></a><span id="l3.466">   NS_ENSURE_ARG_POINTER(srcFolder);</span>
<a href="#l3.467"></a><span id="l3.467">   NS_ENSURE_ARG_POINTER(dstFolder);</span>
<a href="#l3.468"></a><span id="l3.468"> </span>
<a href="#l3.469"></a><span id="l3.469">   nsCOMPtr&lt;nsIImapUrl&gt; imapUrl;</span>
<a href="#l3.470"></a><span id="l3.470">   nsCAutoString urlSpec;</span>
<a href="#l3.471"></a><span id="l3.471">   nsresult rv;</span>
<a href="#l3.472"></a><span id="l3.472"> </span>
<a href="#l3.473"></a><span id="l3.473">   char default_hierarchyDelimiter = GetHierarchyDelimiter(dstFolder);</span>
<a href="#l3.474"></a><span id="l3.474" class="difflineat">@@ -2308,31 +2335,32 @@ NS_IMETHODIMP nsImapService::MoveFolder(</span>
<a href="#l3.475"></a><span id="l3.475">       {</span>
<a href="#l3.476"></a><span id="l3.476">         urlSpec.Append(hierarchyDelimiter);</span>
<a href="#l3.477"></a><span id="l3.477">         urlSpec.Append(folderName);</span>
<a href="#l3.478"></a><span id="l3.478">       }</span>
<a href="#l3.479"></a><span id="l3.479">       rv = uri-&gt;SetSpec(urlSpec);</span>
<a href="#l3.480"></a><span id="l3.480">       if (NS_SUCCEEDED(rv))</span>
<a href="#l3.481"></a><span id="l3.481">       {</span>
<a href="#l3.482"></a><span id="l3.482">         GetFolderName(srcFolder, folderName);</span>
<a href="#l3.483"></a><span id="l3.483" class="difflineminus">-        rv = GetImapConnectionAndLoadUrl(eventTarget, imapUrl, nsnull, url);</span>
<a href="#l3.484"></a><span id="l3.484" class="difflineplus">+        rv = GetImapConnectionAndLoadUrl(aClientEventTarget, imapUrl,</span>
<a href="#l3.485"></a><span id="l3.485" class="difflineplus">+                                         nsnull, url);</span>
<a href="#l3.486"></a><span id="l3.486">       }</span>
<a href="#l3.487"></a><span id="l3.487">     }</span>
<a href="#l3.488"></a><span id="l3.488">   }</span>
<a href="#l3.489"></a><span id="l3.489">   return rv;</span>
<a href="#l3.490"></a><span id="l3.490"> }</span>
<a href="#l3.491"></a><span id="l3.491"> </span>
<a href="#l3.492"></a><span id="l3.492" class="difflineminus">-NS_IMETHODIMP nsImapService::RenameLeaf(nsIEventTarget *eventTarget, </span>
<a href="#l3.493"></a><span id="l3.493" class="difflineplus">+NS_IMETHODIMP nsImapService::RenameLeaf(nsIEventTarget *aClientEventTarget,</span>
<a href="#l3.494"></a><span id="l3.494">                                         nsIMsgFolder *srcFolder,</span>
<a href="#l3.495"></a><span id="l3.495">                                         const nsAString &amp;newLeafName, </span>
<a href="#l3.496"></a><span id="l3.496">                                         nsIUrlListener *urlListener,</span>
<a href="#l3.497"></a><span id="l3.497">                                         nsIMsgWindow *msgWindow, </span>
<a href="#l3.498"></a><span id="l3.498">                                         nsIURI **url)</span>
<a href="#l3.499"></a><span id="l3.499"> {</span>
<a href="#l3.500"></a><span id="l3.500" class="difflineminus">-  NS_ENSURE_ARG_POINTER(eventTarget);</span>
<a href="#l3.501"></a><span id="l3.501" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aClientEventTarget);</span>
<a href="#l3.502"></a><span id="l3.502">   NS_ENSURE_ARG_POINTER(srcFolder);</span>
<a href="#l3.503"></a><span id="l3.503">   </span>
<a href="#l3.504"></a><span id="l3.504">   nsCOMPtr&lt;nsIImapUrl&gt; imapUrl;</span>
<a href="#l3.505"></a><span id="l3.505">   nsCAutoString urlSpec;</span>
<a href="#l3.506"></a><span id="l3.506">   nsresult rv;</span>
<a href="#l3.507"></a><span id="l3.507"> </span>
<a href="#l3.508"></a><span id="l3.508">   char hierarchyDelimiter = GetHierarchyDelimiter(srcFolder);</span>
<a href="#l3.509"></a><span id="l3.509">   rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(imapUrl), srcFolder, </span>
<a href="#l3.510"></a><span id="l3.510" class="difflineat">@@ -2369,29 +2397,30 @@ NS_IMETHODIMP nsImapService::RenameLeaf(</span>
<a href="#l3.511"></a><span id="l3.511">       MsgEscapeString(utfNewName, nsINetUtil::ESCAPE_URL_PATH, escapedNewName);</span>
<a href="#l3.512"></a><span id="l3.512">       nsCString escapedSlashName;</span>
<a href="#l3.513"></a><span id="l3.513">       rv = nsImapUrl::EscapeSlashes(escapedNewName.get(), getter_Copies(escapedSlashName));</span>
<a href="#l3.514"></a><span id="l3.514">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.515"></a><span id="l3.515">       urlSpec.Append(escapedSlashName);</span>
<a href="#l3.516"></a><span id="l3.516"> </span>
<a href="#l3.517"></a><span id="l3.517">       rv = uri-&gt;SetSpec(urlSpec);</span>
<a href="#l3.518"></a><span id="l3.518">       if (NS_SUCCEEDED(rv))</span>
<a href="#l3.519"></a><span id="l3.519" class="difflineminus">-        rv = GetImapConnectionAndLoadUrl(eventTarget, imapUrl, nsnull, url);</span>
<a href="#l3.520"></a><span id="l3.520" class="difflineplus">+        rv = GetImapConnectionAndLoadUrl(aClientEventTarget, imapUrl,</span>
<a href="#l3.521"></a><span id="l3.521" class="difflineplus">+                                         nsnull, url);</span>
<a href="#l3.522"></a><span id="l3.522">     } // if (NS_SUCCEEDED(rv))</span>
<a href="#l3.523"></a><span id="l3.523">   } // if (NS_SUCCEEDED(rv) &amp;&amp; imapUrl)</span>
<a href="#l3.524"></a><span id="l3.524">   return rv;</span>
<a href="#l3.525"></a><span id="l3.525"> }</span>
<a href="#l3.526"></a><span id="l3.526"> </span>
<a href="#l3.527"></a><span id="l3.527" class="difflineminus">-NS_IMETHODIMP nsImapService::CreateFolder(nsIEventTarget  *eventTarget,</span>
<a href="#l3.528"></a><span id="l3.528" class="difflineplus">+NS_IMETHODIMP nsImapService::CreateFolder(nsIEventTarget *aClientEventTarget,</span>
<a href="#l3.529"></a><span id="l3.529">                                           nsIMsgFolder *parent,</span>
<a href="#l3.530"></a><span id="l3.530">                                           const nsAString &amp;newFolderName,</span>
<a href="#l3.531"></a><span id="l3.531">                                           nsIUrlListener *urlListener, </span>
<a href="#l3.532"></a><span id="l3.532">                                           nsIURI **url)</span>
<a href="#l3.533"></a><span id="l3.533"> {</span>
<a href="#l3.534"></a><span id="l3.534" class="difflineminus">-  NS_ENSURE_ARG_POINTER(eventTarget);</span>
<a href="#l3.535"></a><span id="l3.535" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aClientEventTarget);</span>
<a href="#l3.536"></a><span id="l3.536">   NS_ENSURE_ARG_POINTER(parent);</span>
<a href="#l3.537"></a><span id="l3.537"> </span>
<a href="#l3.538"></a><span id="l3.538">   nsCOMPtr&lt;nsIImapUrl&gt; imapUrl;</span>
<a href="#l3.539"></a><span id="l3.539">   nsCAutoString urlSpec;</span>
<a href="#l3.540"></a><span id="l3.540">   nsresult rv;</span>
<a href="#l3.541"></a><span id="l3.541"> </span>
<a href="#l3.542"></a><span id="l3.542">   char hierarchyDelimiter = GetHierarchyDelimiter(parent);</span>
<a href="#l3.543"></a><span id="l3.543">   rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(imapUrl), parent, </span>
<a href="#l3.544"></a><span id="l3.544" class="difflineat">@@ -2421,29 +2450,30 @@ NS_IMETHODIMP nsImapService::CreateFolde</span>
<a href="#l3.545"></a><span id="l3.545">       rv = CopyUTF16toMUTF7(PromiseFlatString(newFolderName), utfNewName);</span>
<a href="#l3.546"></a><span id="l3.546">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.547"></a><span id="l3.547">       nsCString escapedFolderName;</span>
<a href="#l3.548"></a><span id="l3.548">       MsgEscapeString(utfNewName, nsINetUtil::ESCAPE_URL_PATH, escapedFolderName);</span>
<a href="#l3.549"></a><span id="l3.549">       urlSpec.Append(escapedFolderName);</span>
<a href="#l3.550"></a><span id="l3.550"> </span>
<a href="#l3.551"></a><span id="l3.551">       rv = uri-&gt;SetSpec(urlSpec);</span>
<a href="#l3.552"></a><span id="l3.552">       if (NS_SUCCEEDED(rv))</span>
<a href="#l3.553"></a><span id="l3.553" class="difflineminus">-        rv = GetImapConnectionAndLoadUrl(eventTarget, imapUrl, nsnull, url);</span>
<a href="#l3.554"></a><span id="l3.554" class="difflineplus">+        rv = GetImapConnectionAndLoadUrl(aClientEventTarget, imapUrl,</span>
<a href="#l3.555"></a><span id="l3.555" class="difflineplus">+                                         nsnull, url);</span>
<a href="#l3.556"></a><span id="l3.556">     } // if (NS_SUCCEEDED(rv))</span>
<a href="#l3.557"></a><span id="l3.557">   } // if (NS_SUCCEEDED(rv) &amp;&amp; imapUrl)</span>
<a href="#l3.558"></a><span id="l3.558">   return rv;</span>
<a href="#l3.559"></a><span id="l3.559"> }</span>
<a href="#l3.560"></a><span id="l3.560"> </span>
<a href="#l3.561"></a><span id="l3.561" class="difflineminus">-NS_IMETHODIMP nsImapService::EnsureFolderExists(nsIEventTarget *eventTarget, </span>
<a href="#l3.562"></a><span id="l3.562" class="difflineplus">+NS_IMETHODIMP nsImapService::EnsureFolderExists(nsIEventTarget *aClientEventTarget,</span>
<a href="#l3.563"></a><span id="l3.563">                                                 nsIMsgFolder *parent,</span>
<a href="#l3.564"></a><span id="l3.564">                                                 const nsAString &amp;newFolderName, </span>
<a href="#l3.565"></a><span id="l3.565">                                                 nsIUrlListener *urlListener, </span>
<a href="#l3.566"></a><span id="l3.566">                                                 nsIURI **url)</span>
<a href="#l3.567"></a><span id="l3.567"> {</span>
<a href="#l3.568"></a><span id="l3.568" class="difflineminus">-  NS_ENSURE_ARG_POINTER(eventTarget);</span>
<a href="#l3.569"></a><span id="l3.569" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aClientEventTarget);</span>
<a href="#l3.570"></a><span id="l3.570">   NS_ENSURE_ARG_POINTER(parent);</span>
<a href="#l3.571"></a><span id="l3.571"> </span>
<a href="#l3.572"></a><span id="l3.572">   nsCOMPtr&lt;nsIImapUrl&gt; imapUrl;</span>
<a href="#l3.573"></a><span id="l3.573">   nsCAutoString urlSpec;</span>
<a href="#l3.574"></a><span id="l3.574">   nsresult rv;</span>
<a href="#l3.575"></a><span id="l3.575"> </span>
<a href="#l3.576"></a><span id="l3.576">   char hierarchyDelimiter = GetHierarchyDelimiter(parent);</span>
<a href="#l3.577"></a><span id="l3.577">   rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(imapUrl), parent, urlListener, urlSpec, hierarchyDelimiter);</span>
<a href="#l3.578"></a><span id="l3.578" class="difflineat">@@ -2466,27 +2496,31 @@ NS_IMETHODIMP nsImapService::EnsureFolde</span>
<a href="#l3.579"></a><span id="l3.579">       nsCAutoString utfNewName; </span>
<a href="#l3.580"></a><span id="l3.580">       CopyUTF16toMUTF7(PromiseFlatString(newFolderName), utfNewName);</span>
<a href="#l3.581"></a><span id="l3.581">       nsCString escapedFolderName;</span>
<a href="#l3.582"></a><span id="l3.582">       MsgEscapeString(utfNewName, nsINetUtil::ESCAPE_URL_PATH, escapedFolderName);</span>
<a href="#l3.583"></a><span id="l3.583">       urlSpec.Append(escapedFolderName);</span>
<a href="#l3.584"></a><span id="l3.584"> </span>
<a href="#l3.585"></a><span id="l3.585">       rv = uri-&gt;SetSpec(urlSpec);</span>
<a href="#l3.586"></a><span id="l3.586">       if (NS_SUCCEEDED(rv))</span>
<a href="#l3.587"></a><span id="l3.587" class="difflineminus">-        rv = GetImapConnectionAndLoadUrl(eventTarget, imapUrl, nsnull, url);</span>
<a href="#l3.588"></a><span id="l3.588" class="difflineplus">+        rv = GetImapConnectionAndLoadUrl(aClientEventTarget, imapUrl,</span>
<a href="#l3.589"></a><span id="l3.589" class="difflineplus">+                                         nsnull, url);</span>
<a href="#l3.590"></a><span id="l3.590">     } // if (NS_SUCCEEDED(rv))</span>
<a href="#l3.591"></a><span id="l3.591">   } // if (NS_SUCCEEDED(rv) &amp;&amp; imapUrl)</span>
<a href="#l3.592"></a><span id="l3.592">   return rv;</span>
<a href="#l3.593"></a><span id="l3.593"> }</span>
<a href="#l3.594"></a><span id="l3.594"> </span>
<a href="#l3.595"></a><span id="l3.595"> NS_IMETHODIMP nsImapService::ListFolder(nsIEventTarget *aClientEventTarget,</span>
<a href="#l3.596"></a><span id="l3.596">                                         nsIMsgFolder *aImapMailFolder,</span>
<a href="#l3.597"></a><span id="l3.597">                                         nsIUrlListener *aUrlListener,</span>
<a href="#l3.598"></a><span id="l3.598">                                         nsIURI **aURL)</span>
<a href="#l3.599"></a><span id="l3.599"> {</span>
<a href="#l3.600"></a><span id="l3.600" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aClientEventTarget);</span>
<a href="#l3.601"></a><span id="l3.601" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aImapMailFolder);</span>
<a href="#l3.602"></a><span id="l3.602" class="difflineplus">+</span>
<a href="#l3.603"></a><span id="l3.603">   return FolderCommand(aClientEventTarget, aImapMailFolder, aUrlListener,</span>
<a href="#l3.604"></a><span id="l3.604">                        &quot;/listfolder&gt;&quot;, nsIImapUrl::nsImapListFolder, nsnull, aURL);</span>
<a href="#l3.605"></a><span id="l3.605"> }</span>
<a href="#l3.606"></a><span id="l3.606"> </span>
<a href="#l3.607"></a><span id="l3.607"> NS_IMETHODIMP nsImapService::GetScheme(nsACString &amp;aScheme)</span>
<a href="#l3.608"></a><span id="l3.608"> {</span>
<a href="#l3.609"></a><span id="l3.609">   aScheme.Assign(&quot;imap&quot;);</span>
<a href="#l3.610"></a><span id="l3.610">   return NS_OK; </span>
<a href="#l3.611"></a><span id="l3.611" class="difflineat">@@ -2641,17 +2675,16 @@ NS_IMETHODIMP nsImapService::NewURI(cons</span>
<a href="#l3.612"></a><span id="l3.612">       }</span>
<a href="#l3.613"></a><span id="l3.613">       if (NS_SUCCEEDED(rv))</span>
<a href="#l3.614"></a><span id="l3.614">       {</span>
<a href="#l3.615"></a><span id="l3.615">         nsCOMPtr&lt;nsIImapMessageSink&gt; msgSink = do_QueryInterface(folder);</span>
<a href="#l3.616"></a><span id="l3.616">         rv = aImapUrl-&gt;SetImapMessageSink(msgSink);</span>
<a href="#l3.617"></a><span id="l3.617"> </span>
<a href="#l3.618"></a><span id="l3.618">         nsCOMPtr&lt;nsIMsgFolder&gt; msgFolder = do_QueryInterface(folder);</span>
<a href="#l3.619"></a><span id="l3.619">         rv = SetImapUrlSink(msgFolder, aImapUrl);	</span>
<a href="#l3.620"></a><span id="l3.620" class="difflineminus">-        nsCAutoString msgKey;</span>
<a href="#l3.621"></a><span id="l3.621"> </span>
<a href="#l3.622"></a><span id="l3.622">          nsCString messageIdString;</span>
<a href="#l3.623"></a><span id="l3.623">          aImapUrl-&gt;GetListOfMessageIds(messageIdString);</span>
<a href="#l3.624"></a><span id="l3.624">          if (!messageIdString.IsEmpty())</span>
<a href="#l3.625"></a><span id="l3.625">         {</span>
<a href="#l3.626"></a><span id="l3.626">           bool useLocalCache = false;</span>
<a href="#l3.627"></a><span id="l3.627">           msgFolder-&gt;HasMsgOffline(atoi(messageIdString.get()), &amp;useLocalCache);  </span>
<a href="#l3.628"></a><span id="l3.628">           mailnewsUrl-&gt;SetMsgIsInLocalCache(useLocalCache);</span>
<a href="#l3.629"></a><span id="l3.629" class="difflineat">@@ -2670,20 +2703,21 @@ NS_IMETHODIMP nsImapService::NewURI(cons</span>
<a href="#l3.630"></a><span id="l3.630">     imapUri.swap(*aRetVal);</span>
<a href="#l3.631"></a><span id="l3.631">   }</span>
<a href="#l3.632"></a><span id="l3.632"> </span>
<a href="#l3.633"></a><span id="l3.633">   return rv;</span>
<a href="#l3.634"></a><span id="l3.634"> }</span>
<a href="#l3.635"></a><span id="l3.635"> </span>
<a href="#l3.636"></a><span id="l3.636"> NS_IMETHODIMP nsImapService::NewChannel(nsIURI *aURI, nsIChannel **aRetVal)</span>
<a href="#l3.637"></a><span id="l3.637"> {</span>
<a href="#l3.638"></a><span id="l3.638" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aURI);</span>
<a href="#l3.639"></a><span id="l3.639">   NS_ENSURE_ARG_POINTER(aRetVal);</span>
<a href="#l3.640"></a><span id="l3.640" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aURI);</span>
<a href="#l3.641"></a><span id="l3.641" class="difflineplus">+  *aRetVal = nsnull;</span>
<a href="#l3.642"></a><span id="l3.642" class="difflineplus">+</span>
<a href="#l3.643"></a><span id="l3.643">   nsresult rv;</span>
<a href="#l3.644"></a><span id="l3.644" class="difflineminus">-  *aRetVal = nsnull;</span>
<a href="#l3.645"></a><span id="l3.645">   nsCOMPtr&lt;nsIImapUrl&gt; imapUrl = do_QueryInterface(aURI, &amp;rv);</span>
<a href="#l3.646"></a><span id="l3.646">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.647"></a><span id="l3.647">   nsCOMPtr &lt;nsIMsgMailNewsUrl&gt; mailnewsUrl = do_QueryInterface(imapUrl, &amp;rv);</span>
<a href="#l3.648"></a><span id="l3.648">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.649"></a><span id="l3.649"> </span>
<a href="#l3.650"></a><span id="l3.650">   // imap can't open and return a channel right away...the url needs to go in the imap url queue </span>
<a href="#l3.651"></a><span id="l3.651">   // until we find a connection which can run the url..in order to satisfy necko, we're going to return</span>
<a href="#l3.652"></a><span id="l3.652">   // a mock imap channel....</span>
<a href="#l3.653"></a><span id="l3.653" class="difflineat">@@ -2877,17 +2911,16 @@ NS_IMETHODIMP nsImapService::NewChannel(</span>
<a href="#l3.654"></a><span id="l3.654">   }</span>
<a href="#l3.655"></a><span id="l3.655">   if (NS_SUCCEEDED(rv))</span>
<a href="#l3.656"></a><span id="l3.656">     NS_IF_ADDREF(*aRetVal = channel);</span>
<a href="#l3.657"></a><span id="l3.657">   return rv;</span>
<a href="#l3.658"></a><span id="l3.658"> }</span>
<a href="#l3.659"></a><span id="l3.659"> </span>
<a href="#l3.660"></a><span id="l3.660"> NS_IMETHODIMP nsImapService::SetDefaultLocalPath(nsILocalFile *aPath)</span>
<a href="#l3.661"></a><span id="l3.661"> {</span>
<a href="#l3.662"></a><span id="l3.662" class="difflineminus">-  NS_ENSURE_ARG(aPath);</span>
<a href="#l3.663"></a><span id="l3.663">   return NS_SetPersistentFile(PREF_MAIL_ROOT_IMAP_REL, PREF_MAIL_ROOT_IMAP, aPath);</span>
<a href="#l3.664"></a><span id="l3.664"> }       </span>
<a href="#l3.665"></a><span id="l3.665"> </span>
<a href="#l3.666"></a><span id="l3.666"> NS_IMETHODIMP nsImapService::GetDefaultLocalPath(nsILocalFile **aResult)</span>
<a href="#l3.667"></a><span id="l3.667"> {</span>
<a href="#l3.668"></a><span id="l3.668">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l3.669"></a><span id="l3.669">   *aResult = nsnull;</span>
<a href="#l3.670"></a><span id="l3.670">   </span>
<a href="#l3.671"></a><span id="l3.671" class="difflineat">@@ -3058,34 +3091,36 @@ NS_IMETHODIMP nsImapService::GetListOfFo</span>
<a href="#l3.672"></a><span id="l3.672"> </span>
<a href="#l3.673"></a><span id="l3.673">   nsCOMPtr&lt;nsIUrlListener&gt; listener = do_QueryInterface(aServer, &amp;rv);</span>
<a href="#l3.674"></a><span id="l3.674">   NS_ENSURE_TRUE(NS_SUCCEEDED(rv) &amp;&amp; listener, NS_ERROR_FAILURE);</span>
<a href="#l3.675"></a><span id="l3.675"> </span>
<a href="#l3.676"></a><span id="l3.676">   nsCOMPtr&lt;nsIThread&gt; thread(do_GetCurrentThread());</span>
<a href="#l3.677"></a><span id="l3.677">   return DiscoverAllAndSubscribedFolders(thread, rootMsgFolder, listener, nsnull);</span>
<a href="#l3.678"></a><span id="l3.678"> } </span>
<a href="#l3.679"></a><span id="l3.679"> </span>
<a href="#l3.680"></a><span id="l3.680" class="difflineminus">-NS_IMETHODIMP nsImapService::SubscribeFolder(nsIEventTarget *eventTarget, </span>
<a href="#l3.681"></a><span id="l3.681" class="difflineplus">+NS_IMETHODIMP nsImapService::SubscribeFolder(nsIEventTarget *aClientEventTarget,</span>
<a href="#l3.682"></a><span id="l3.682">                                              nsIMsgFolder *aFolder,</span>
<a href="#l3.683"></a><span id="l3.683">                                              const nsAString &amp;aFolderName, </span>
<a href="#l3.684"></a><span id="l3.684">                                              nsIUrlListener *urlListener, </span>
<a href="#l3.685"></a><span id="l3.685">                                              nsIURI **url)</span>
<a href="#l3.686"></a><span id="l3.686"> {</span>
<a href="#l3.687"></a><span id="l3.687" class="difflineminus">-  return ChangeFolderSubscription(eventTarget, aFolder, aFolderName, </span>
<a href="#l3.688"></a><span id="l3.688" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aClientEventTarget);</span>
<a href="#l3.689"></a><span id="l3.689" class="difflineplus">+</span>
<a href="#l3.690"></a><span id="l3.690" class="difflineplus">+  return ChangeFolderSubscription(aClientEventTarget, aFolder, aFolderName, </span>
<a href="#l3.691"></a><span id="l3.691">                                   &quot;/subscribe&gt;&quot;, urlListener, url);</span>
<a href="#l3.692"></a><span id="l3.692"> }</span>
<a href="#l3.693"></a><span id="l3.693"> </span>
<a href="#l3.694"></a><span id="l3.694" class="difflineminus">-nsresult nsImapService::ChangeFolderSubscription(nsIEventTarget *eventTarget, </span>
<a href="#l3.695"></a><span id="l3.695" class="difflineplus">+nsresult nsImapService::ChangeFolderSubscription(nsIEventTarget *aClientEventTarget,</span>
<a href="#l3.696"></a><span id="l3.696">                                                  nsIMsgFolder *folder,</span>
<a href="#l3.697"></a><span id="l3.697">                                                  const nsAString &amp;folderName, </span>
<a href="#l3.698"></a><span id="l3.698">                                                  const char *command,</span>
<a href="#l3.699"></a><span id="l3.699">                                                  nsIUrlListener *urlListener, </span>
<a href="#l3.700"></a><span id="l3.700">                                                  nsIURI **url)</span>
<a href="#l3.701"></a><span id="l3.701"> {</span>
<a href="#l3.702"></a><span id="l3.702" class="difflineminus">-  NS_ENSURE_ARG_POINTER(eventTarget);</span>
<a href="#l3.703"></a><span id="l3.703" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aClientEventTarget);</span>
<a href="#l3.704"></a><span id="l3.704">   NS_ENSURE_ARG_POINTER(folder);</span>
<a href="#l3.705"></a><span id="l3.705"> </span>
<a href="#l3.706"></a><span id="l3.706">   nsCOMPtr&lt;nsIImapUrl&gt; imapUrl;</span>
<a href="#l3.707"></a><span id="l3.707">   nsCAutoString urlSpec;</span>
<a href="#l3.708"></a><span id="l3.708">   nsresult rv;</span>
<a href="#l3.709"></a><span id="l3.709">   char hierarchyDelimiter = GetHierarchyDelimiter(folder);</span>
<a href="#l3.710"></a><span id="l3.710">   rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(imapUrl), folder, urlListener,</span>
<a href="#l3.711"></a><span id="l3.711">                             urlSpec, hierarchyDelimiter);</span>
<a href="#l3.712"></a><span id="l3.712" class="difflineat">@@ -3100,52 +3135,59 @@ nsresult nsImapService::ChangeFolderSubs</span>
<a href="#l3.713"></a><span id="l3.713">       nsCAutoString utfFolderName;</span>
<a href="#l3.714"></a><span id="l3.714">       rv = CopyUTF16toMUTF7(PromiseFlatString(folderName), utfFolderName);</span>
<a href="#l3.715"></a><span id="l3.715">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.716"></a><span id="l3.716">       nsCString escapedFolderName;</span>
<a href="#l3.717"></a><span id="l3.717">       MsgEscapeString(utfFolderName, nsINetUtil::ESCAPE_URL_PATH, escapedFolderName);</span>
<a href="#l3.718"></a><span id="l3.718">       urlSpec.Append(escapedFolderName);</span>
<a href="#l3.719"></a><span id="l3.719">       rv = uri-&gt;SetSpec(urlSpec);</span>
<a href="#l3.720"></a><span id="l3.720">       if (NS_SUCCEEDED(rv))</span>
<a href="#l3.721"></a><span id="l3.721" class="difflineminus">-        rv = GetImapConnectionAndLoadUrl(eventTarget, imapUrl, nsnull, url);</span>
<a href="#l3.722"></a><span id="l3.722" class="difflineplus">+        rv = GetImapConnectionAndLoadUrl(aClientEventTarget, imapUrl,</span>
<a href="#l3.723"></a><span id="l3.723" class="difflineplus">+                                         nsnull, url);</span>
<a href="#l3.724"></a><span id="l3.724">     }</span>
<a href="#l3.725"></a><span id="l3.725">   }</span>
<a href="#l3.726"></a><span id="l3.726">   return rv;</span>
<a href="#l3.727"></a><span id="l3.727"> }</span>
<a href="#l3.728"></a><span id="l3.728"> </span>
<a href="#l3.729"></a><span id="l3.729" class="difflineminus">-NS_IMETHODIMP nsImapService::UnsubscribeFolder(nsIEventTarget *aEventTarget, </span>
<a href="#l3.730"></a><span id="l3.730" class="difflineplus">+NS_IMETHODIMP nsImapService::UnsubscribeFolder(nsIEventTarget *aClientEventTarget,</span>
<a href="#l3.731"></a><span id="l3.731">                                                nsIMsgFolder *aFolder,</span>
<a href="#l3.732"></a><span id="l3.732">                                                const nsAString &amp;aFolderName, </span>
<a href="#l3.733"></a><span id="l3.733">                                                nsIUrlListener *aUrlListener, </span>
<a href="#l3.734"></a><span id="l3.734">                                                nsIURI **aUrl)</span>
<a href="#l3.735"></a><span id="l3.735"> {</span>
<a href="#l3.736"></a><span id="l3.736" class="difflineminus">-  return ChangeFolderSubscription(aEventTarget, aFolder, aFolderName, </span>
<a href="#l3.737"></a><span id="l3.737" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aClientEventTarget);</span>
<a href="#l3.738"></a><span id="l3.738" class="difflineplus">+</span>
<a href="#l3.739"></a><span id="l3.739" class="difflineplus">+  return ChangeFolderSubscription(aClientEventTarget, aFolder, aFolderName,</span>
<a href="#l3.740"></a><span id="l3.740">                                   &quot;/unsubscribe&gt;&quot;, aUrlListener, aUrl);</span>
<a href="#l3.741"></a><span id="l3.741"> }</span>
<a href="#l3.742"></a><span id="l3.742"> </span>
<a href="#l3.743"></a><span id="l3.743"> NS_IMETHODIMP nsImapService::GetFolderAdminUrl(nsIEventTarget *aClientEventTarget,</span>
<a href="#l3.744"></a><span id="l3.744">                                                nsIMsgFolder *aImapMailFolder,</span>
<a href="#l3.745"></a><span id="l3.745">                                                nsIMsgWindow *aMsgWindow,</span>
<a href="#l3.746"></a><span id="l3.746">                                                nsIUrlListener *aUrlListener,</span>
<a href="#l3.747"></a><span id="l3.747">                                                nsIURI **aURL)</span>
<a href="#l3.748"></a><span id="l3.748"> {</span>
<a href="#l3.749"></a><span id="l3.749" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aClientEventTarget);</span>
<a href="#l3.750"></a><span id="l3.750" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aImapMailFolder);</span>
<a href="#l3.751"></a><span id="l3.751" class="difflineplus">+</span>
<a href="#l3.752"></a><span id="l3.752">   return FolderCommand(aClientEventTarget, aImapMailFolder, aUrlListener,</span>
<a href="#l3.753"></a><span id="l3.753">                        &quot;/refreshfolderurls&gt;&quot;, nsIImapUrl::nsImapRefreshFolderUrls, aMsgWindow, aURL);</span>
<a href="#l3.754"></a><span id="l3.754"> }</span>
<a href="#l3.755"></a><span id="l3.755"> </span>
<a href="#l3.756"></a><span id="l3.756"> NS_IMETHODIMP nsImapService::IssueCommandOnMsgs(nsIEventTarget *aClientEventTarget,</span>
<a href="#l3.757"></a><span id="l3.757">                                                 nsIMsgFolder *anImapFolder,</span>
<a href="#l3.758"></a><span id="l3.758">                                                 nsIMsgWindow *aMsgWindow,</span>
<a href="#l3.759"></a><span id="l3.759">                                                 const nsACString &amp;aCommand,</span>
<a href="#l3.760"></a><span id="l3.760">                                                 const nsACString &amp;uids,</span>
<a href="#l3.761"></a><span id="l3.761">                                                 nsIURI **aURL)</span>
<a href="#l3.762"></a><span id="l3.762"> {</span>
<a href="#l3.763"></a><span id="l3.763">   NS_ENSURE_ARG_POINTER(aClientEventTarget);</span>
<a href="#l3.764"></a><span id="l3.764">   NS_ENSURE_ARG_POINTER(anImapFolder);</span>
<a href="#l3.765"></a><span id="l3.765">   NS_ENSURE_ARG_POINTER(aMsgWindow);</span>
<a href="#l3.766"></a><span id="l3.766" class="difflineplus">+</span>
<a href="#l3.767"></a><span id="l3.767">   nsCOMPtr&lt;nsIImapUrl&gt; imapUrl;</span>
<a href="#l3.768"></a><span id="l3.768">   nsCAutoString urlSpec;</span>
<a href="#l3.769"></a><span id="l3.769">   nsresult rv;</span>
<a href="#l3.770"></a><span id="l3.770">   char hierarchyDelimiter = GetHierarchyDelimiter(anImapFolder);</span>
<a href="#l3.771"></a><span id="l3.771">   rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(imapUrl), anImapFolder, nsnull, urlSpec, hierarchyDelimiter);</span>
<a href="#l3.772"></a><span id="l3.772"> </span>
<a href="#l3.773"></a><span id="l3.773">   if (NS_SUCCEEDED(rv) &amp;&amp; imapUrl)</span>
<a href="#l3.774"></a><span id="l3.774">   {</span>
<a href="#l3.775"></a><span id="l3.775" class="difflineat">@@ -3231,16 +3273,17 @@ NS_IMETHODIMP nsImapService::StoreCustom</span>
<a href="#l3.776"></a><span id="l3.776">                                                  nsIMsgWindow *aMsgWindow,</span>
<a href="#l3.777"></a><span id="l3.777">                                                  const nsACString &amp;flagsToAdd,</span>
<a href="#l3.778"></a><span id="l3.778">                                                  const nsACString &amp;flagsToSubtract,</span>
<a href="#l3.779"></a><span id="l3.779">                                                  const nsACString &amp;uids,</span>
<a href="#l3.780"></a><span id="l3.780">                                                  nsIURI **aURL)</span>
<a href="#l3.781"></a><span id="l3.781"> {</span>
<a href="#l3.782"></a><span id="l3.782">   NS_ENSURE_ARG_POINTER(aClientEventTarget);</span>
<a href="#l3.783"></a><span id="l3.783">   NS_ENSURE_ARG_POINTER(anImapFolder);</span>
<a href="#l3.784"></a><span id="l3.784" class="difflineplus">+</span>
<a href="#l3.785"></a><span id="l3.785">   nsCOMPtr&lt;nsIImapUrl&gt; imapUrl;</span>
<a href="#l3.786"></a><span id="l3.786">   nsCAutoString urlSpec;</span>
<a href="#l3.787"></a><span id="l3.787">   nsresult rv;</span>
<a href="#l3.788"></a><span id="l3.788">   char hierarchyDelimiter = GetHierarchyDelimiter(anImapFolder);</span>
<a href="#l3.789"></a><span id="l3.789">   rv = CreateStartOfImapUrl(EmptyCString(), getter_AddRefs(imapUrl), anImapFolder, nsnull, urlSpec, hierarchyDelimiter);</span>
<a href="#l3.790"></a><span id="l3.790"> </span>
<a href="#l3.791"></a><span id="l3.791">   if (NS_SUCCEEDED(rv) &amp;&amp; imapUrl)</span>
<a href="#l3.792"></a><span id="l3.792">   {</span>
<a href="#l3.793"></a><span id="l3.793" class="difflineat">@@ -3326,16 +3369,17 @@ NS_IMETHODIMP nsImapService::MessageURIT</span>
<a href="#l3.794"></a><span id="l3.794">   return NS_OK;</span>
<a href="#l3.795"></a><span id="l3.795"> }</span>
<a href="#l3.796"></a><span id="l3.796"> </span>
<a href="#l3.797"></a><span id="l3.797"> NS_IMETHODIMP nsImapService::PlaybackAllOfflineOperations(nsIMsgWindow *aMsgWindow, </span>
<a href="#l3.798"></a><span id="l3.798">                                                           nsIUrlListener *aListener, </span>
<a href="#l3.799"></a><span id="l3.799">                                                           nsISupports **aResult)</span>
<a href="#l3.800"></a><span id="l3.800"> {</span>
<a href="#l3.801"></a><span id="l3.801">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l3.802"></a><span id="l3.802" class="difflineplus">+</span>
<a href="#l3.803"></a><span id="l3.803">   nsresult rv;</span>
<a href="#l3.804"></a><span id="l3.804">   nsImapOfflineSync *goOnline = new nsImapOfflineSync(aMsgWindow, aListener, nsnull);</span>
<a href="#l3.805"></a><span id="l3.805">   if (goOnline)</span>
<a href="#l3.806"></a><span id="l3.806">   {</span>
<a href="#l3.807"></a><span id="l3.807">     rv = goOnline-&gt;QueryInterface(NS_GET_IID(nsISupports), (void **) aResult); </span>
<a href="#l3.808"></a><span id="l3.808">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.809"></a><span id="l3.809">     if (NS_SUCCEEDED(rv) &amp;&amp; *aResult)</span>
<a href="#l3.810"></a><span id="l3.810">       return goOnline-&gt;ProcessNextOperation();</span>
<a href="#l3.811"></a><span id="l3.811" class="difflineat">@@ -3375,19 +3419,19 @@ NS_IMETHODIMP nsImapService::GetCacheSes</span>
<a href="#l3.812"></a><span id="l3.812">   NS_IF_ADDREF(*result = mCacheSession);</span>
<a href="#l3.813"></a><span id="l3.813">   return rv;</span>
<a href="#l3.814"></a><span id="l3.814"> }</span>
<a href="#l3.815"></a><span id="l3.815"> </span>
<a href="#l3.816"></a><span id="l3.816"> NS_IMETHODIMP nsImapService::HandleContent(const char *aContentType, </span>
<a href="#l3.817"></a><span id="l3.817">                                            nsIInterfaceRequestor *aWindowContext, </span>
<a href="#l3.818"></a><span id="l3.818">                                            nsIRequest *request)</span>
<a href="#l3.819"></a><span id="l3.819"> {</span>
<a href="#l3.820"></a><span id="l3.820" class="difflineplus">+  NS_ENSURE_ARG_POINTER(request);</span>
<a href="#l3.821"></a><span id="l3.821" class="difflineplus">+</span>
<a href="#l3.822"></a><span id="l3.822">   nsresult rv;</span>
<a href="#l3.823"></a><span id="l3.823" class="difflineminus">-  NS_ENSURE_ARG_POINTER(request);</span>
<a href="#l3.824"></a><span id="l3.824" class="difflineminus">-  </span>
<a href="#l3.825"></a><span id="l3.825">   nsCOMPtr&lt;nsIChannel&gt; aChannel = do_QueryInterface(request, &amp;rv);</span>
<a href="#l3.826"></a><span id="l3.826">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.827"></a><span id="l3.827"> </span>
<a href="#l3.828"></a><span id="l3.828">   if (PL_strcasecmp(aContentType, &quot;x-application-imapfolder&quot;) == 0)</span>
<a href="#l3.829"></a><span id="l3.829">   {</span>
<a href="#l3.830"></a><span id="l3.830">     nsCOMPtr&lt;nsIURI&gt; uri;</span>
<a href="#l3.831"></a><span id="l3.831">     rv = aChannel-&gt;GetURI(getter_AddRefs(uri));</span>
<a href="#l3.832"></a><span id="l3.832">     NS_ENSURE_SUCCESS(rv, rv);</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

