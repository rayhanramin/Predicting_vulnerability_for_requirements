<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 21346:c30484eedecc8d09f2e6158fa4b85c957cee84da</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ c30484eedecc8d09f2e6158fa4b85c957cee84da" />
<meta property="og:url" content="/comm-central/rev/c30484eedecc8d09f2e6158fa4b85c957cee84da" />
<meta property="og:description" content="Bug 739467 - Remove db batching. r=aceman" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / c30484eedecc8d09f2e6158fa4b85c957cee84da 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/c30484eedecc8d09f2e6158fa4b85c957cee84da">shortlog</a> |
<a href="/comm-central/log/c30484eedecc8d09f2e6158fa4b85c957cee84da">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/c30484eedecc8d09f2e6158fa4b85c957cee84da">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/c30484eedecc8d09f2e6158fa4b85c957cee84da">files</a> |
changeset |
<a href="/comm-central/raw-rev/c30484eedecc8d09f2e6158fa4b85c957cee84da">raw</a>  | <a href="/comm-central/archive/c30484eedecc8d09f2e6158fa4b85c957cee84da.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=739467">Bug 739467</a> - Remove db batching. r=aceman
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#68;&#101;&#97;&#110;&#32;&#90;&#104;&#117;&#32;&#60;&#100;&#101;&#97;&#110;&#122;&#104;&#117;&#50;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Sun, 26 Mar 2017 14:12:00 +0200</td></tr>

<tr>
 <td>changeset 21346</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/c30484eedecc8d09f2e6158fa4b85c957cee84da">c30484eedecc8d09f2e6158fa4b85c957cee84da</a></td>
</tr>



<tr>
<td>parent 21345</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/92ed8653017e7e7ae522997a1d9b0607282b4bfb">92ed8653017e7e7ae522997a1d9b0607282b4bfb</a>
</td>
</tr>

<tr>
<td>child 21347</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/8eeb5667420daba2148746b6b9e470d0d8ebc35d">8eeb5667420daba2148746b6b9e470d0d8ebc35d</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=c30484eedecc8d09f2e6158fa4b85c957cee84da">12979</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Mon, 27 Mar 2017 06:33:53 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@c30484eedecc [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=c30484eedecc8d09f2e6158fa4b85c957cee84da">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=c30484eedecc8d09f2e6158fa4b85c957cee84da&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=c30484eedecc8d09f2e6158fa4b85c957cee84da&newProject=comm-central&newRevision=bc7105f7a94e60be9e498932925ef9795f311358&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=c30484eedecc8d09f2e6158fa4b85c957cee84da&newProject=comm-central&newRevision=bc7105f7a94e60be9e498932925ef9795f311358&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=c30484eedecc8d09f2e6158fa4b85c957cee84da&newProject=comm-central&newRevision=bc7105f7a94e60be9e498932925ef9795f311358&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28aceman%29&revcount=50">aceman</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=739467">739467</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=739467">Bug 739467</a> - Remove db batching. r=aceman</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c30484eedecc8d09f2e6158fa4b85c957cee84da/mailnews/base/public/nsIMsgFolder.idl">mailnews/base/public/nsIMsgFolder.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c30484eedecc8d09f2e6158fa4b85c957cee84da/mailnews/base/public/nsIMsgFolder.idl">file</a> |
<a href="/comm-central/annotate/c30484eedecc8d09f2e6158fa4b85c957cee84da/mailnews/base/public/nsIMsgFolder.idl">annotate</a> |
<a href="/comm-central/diff/c30484eedecc8d09f2e6158fa4b85c957cee84da/mailnews/base/public/nsIMsgFolder.idl">diff</a> |
<a href="/comm-central/comparison/c30484eedecc8d09f2e6158fa4b85c957cee84da/mailnews/base/public/nsIMsgFolder.idl">comparison</a> |
<a href="/comm-central/log/c30484eedecc8d09f2e6158fa4b85c957cee84da/mailnews/base/public/nsIMsgFolder.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c30484eedecc8d09f2e6158fa4b85c957cee84da/mailnews/base/search/src/nsMsgSearchSession.cpp">mailnews/base/search/src/nsMsgSearchSession.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c30484eedecc8d09f2e6158fa4b85c957cee84da/mailnews/base/search/src/nsMsgSearchSession.cpp">file</a> |
<a href="/comm-central/annotate/c30484eedecc8d09f2e6158fa4b85c957cee84da/mailnews/base/search/src/nsMsgSearchSession.cpp">annotate</a> |
<a href="/comm-central/diff/c30484eedecc8d09f2e6158fa4b85c957cee84da/mailnews/base/search/src/nsMsgSearchSession.cpp">diff</a> |
<a href="/comm-central/comparison/c30484eedecc8d09f2e6158fa4b85c957cee84da/mailnews/base/search/src/nsMsgSearchSession.cpp">comparison</a> |
<a href="/comm-central/log/c30484eedecc8d09f2e6158fa4b85c957cee84da/mailnews/base/search/src/nsMsgSearchSession.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c30484eedecc8d09f2e6158fa4b85c957cee84da/mailnews/base/src/nsMsgDBView.cpp">mailnews/base/src/nsMsgDBView.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c30484eedecc8d09f2e6158fa4b85c957cee84da/mailnews/base/src/nsMsgDBView.cpp">file</a> |
<a href="/comm-central/annotate/c30484eedecc8d09f2e6158fa4b85c957cee84da/mailnews/base/src/nsMsgDBView.cpp">annotate</a> |
<a href="/comm-central/diff/c30484eedecc8d09f2e6158fa4b85c957cee84da/mailnews/base/src/nsMsgDBView.cpp">diff</a> |
<a href="/comm-central/comparison/c30484eedecc8d09f2e6158fa4b85c957cee84da/mailnews/base/src/nsMsgDBView.cpp">comparison</a> |
<a href="/comm-central/log/c30484eedecc8d09f2e6158fa4b85c957cee84da/mailnews/base/src/nsMsgDBView.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c30484eedecc8d09f2e6158fa4b85c957cee84da/mailnews/base/src/nsMsgQuickSearchDBView.cpp">mailnews/base/src/nsMsgQuickSearchDBView.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c30484eedecc8d09f2e6158fa4b85c957cee84da/mailnews/base/src/nsMsgQuickSearchDBView.cpp">file</a> |
<a href="/comm-central/annotate/c30484eedecc8d09f2e6158fa4b85c957cee84da/mailnews/base/src/nsMsgQuickSearchDBView.cpp">annotate</a> |
<a href="/comm-central/diff/c30484eedecc8d09f2e6158fa4b85c957cee84da/mailnews/base/src/nsMsgQuickSearchDBView.cpp">diff</a> |
<a href="/comm-central/comparison/c30484eedecc8d09f2e6158fa4b85c957cee84da/mailnews/base/src/nsMsgQuickSearchDBView.cpp">comparison</a> |
<a href="/comm-central/log/c30484eedecc8d09f2e6158fa4b85c957cee84da/mailnews/base/src/nsMsgQuickSearchDBView.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c30484eedecc8d09f2e6158fa4b85c957cee84da/mailnews/base/util/nsMsgDBFolder.cpp">mailnews/base/util/nsMsgDBFolder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c30484eedecc8d09f2e6158fa4b85c957cee84da/mailnews/base/util/nsMsgDBFolder.cpp">file</a> |
<a href="/comm-central/annotate/c30484eedecc8d09f2e6158fa4b85c957cee84da/mailnews/base/util/nsMsgDBFolder.cpp">annotate</a> |
<a href="/comm-central/diff/c30484eedecc8d09f2e6158fa4b85c957cee84da/mailnews/base/util/nsMsgDBFolder.cpp">diff</a> |
<a href="/comm-central/comparison/c30484eedecc8d09f2e6158fa4b85c957cee84da/mailnews/base/util/nsMsgDBFolder.cpp">comparison</a> |
<a href="/comm-central/log/c30484eedecc8d09f2e6158fa4b85c957cee84da/mailnews/base/util/nsMsgDBFolder.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c30484eedecc8d09f2e6158fa4b85c957cee84da/mailnews/db/msgdb/public/nsIMsgDatabase.idl">mailnews/db/msgdb/public/nsIMsgDatabase.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c30484eedecc8d09f2e6158fa4b85c957cee84da/mailnews/db/msgdb/public/nsIMsgDatabase.idl">file</a> |
<a href="/comm-central/annotate/c30484eedecc8d09f2e6158fa4b85c957cee84da/mailnews/db/msgdb/public/nsIMsgDatabase.idl">annotate</a> |
<a href="/comm-central/diff/c30484eedecc8d09f2e6158fa4b85c957cee84da/mailnews/db/msgdb/public/nsIMsgDatabase.idl">diff</a> |
<a href="/comm-central/comparison/c30484eedecc8d09f2e6158fa4b85c957cee84da/mailnews/db/msgdb/public/nsIMsgDatabase.idl">comparison</a> |
<a href="/comm-central/log/c30484eedecc8d09f2e6158fa4b85c957cee84da/mailnews/db/msgdb/public/nsIMsgDatabase.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c30484eedecc8d09f2e6158fa4b85c957cee84da/mailnews/db/msgdb/public/nsImapMailDatabase.h">mailnews/db/msgdb/public/nsImapMailDatabase.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c30484eedecc8d09f2e6158fa4b85c957cee84da/mailnews/db/msgdb/public/nsImapMailDatabase.h">file</a> |
<a href="/comm-central/annotate/c30484eedecc8d09f2e6158fa4b85c957cee84da/mailnews/db/msgdb/public/nsImapMailDatabase.h">annotate</a> |
<a href="/comm-central/diff/c30484eedecc8d09f2e6158fa4b85c957cee84da/mailnews/db/msgdb/public/nsImapMailDatabase.h">diff</a> |
<a href="/comm-central/comparison/c30484eedecc8d09f2e6158fa4b85c957cee84da/mailnews/db/msgdb/public/nsImapMailDatabase.h">comparison</a> |
<a href="/comm-central/log/c30484eedecc8d09f2e6158fa4b85c957cee84da/mailnews/db/msgdb/public/nsImapMailDatabase.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c30484eedecc8d09f2e6158fa4b85c957cee84da/mailnews/db/msgdb/public/nsMailDatabase.h">mailnews/db/msgdb/public/nsMailDatabase.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c30484eedecc8d09f2e6158fa4b85c957cee84da/mailnews/db/msgdb/public/nsMailDatabase.h">file</a> |
<a href="/comm-central/annotate/c30484eedecc8d09f2e6158fa4b85c957cee84da/mailnews/db/msgdb/public/nsMailDatabase.h">annotate</a> |
<a href="/comm-central/diff/c30484eedecc8d09f2e6158fa4b85c957cee84da/mailnews/db/msgdb/public/nsMailDatabase.h">diff</a> |
<a href="/comm-central/comparison/c30484eedecc8d09f2e6158fa4b85c957cee84da/mailnews/db/msgdb/public/nsMailDatabase.h">comparison</a> |
<a href="/comm-central/log/c30484eedecc8d09f2e6158fa4b85c957cee84da/mailnews/db/msgdb/public/nsMailDatabase.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c30484eedecc8d09f2e6158fa4b85c957cee84da/mailnews/db/msgdb/src/nsImapMailDatabase.cpp">mailnews/db/msgdb/src/nsImapMailDatabase.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c30484eedecc8d09f2e6158fa4b85c957cee84da/mailnews/db/msgdb/src/nsImapMailDatabase.cpp">file</a> |
<a href="/comm-central/annotate/c30484eedecc8d09f2e6158fa4b85c957cee84da/mailnews/db/msgdb/src/nsImapMailDatabase.cpp">annotate</a> |
<a href="/comm-central/diff/c30484eedecc8d09f2e6158fa4b85c957cee84da/mailnews/db/msgdb/src/nsImapMailDatabase.cpp">diff</a> |
<a href="/comm-central/comparison/c30484eedecc8d09f2e6158fa4b85c957cee84da/mailnews/db/msgdb/src/nsImapMailDatabase.cpp">comparison</a> |
<a href="/comm-central/log/c30484eedecc8d09f2e6158fa4b85c957cee84da/mailnews/db/msgdb/src/nsImapMailDatabase.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c30484eedecc8d09f2e6158fa4b85c957cee84da/mailnews/db/msgdb/src/nsMailDatabase.cpp">mailnews/db/msgdb/src/nsMailDatabase.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c30484eedecc8d09f2e6158fa4b85c957cee84da/mailnews/db/msgdb/src/nsMailDatabase.cpp">file</a> |
<a href="/comm-central/annotate/c30484eedecc8d09f2e6158fa4b85c957cee84da/mailnews/db/msgdb/src/nsMailDatabase.cpp">annotate</a> |
<a href="/comm-central/diff/c30484eedecc8d09f2e6158fa4b85c957cee84da/mailnews/db/msgdb/src/nsMailDatabase.cpp">diff</a> |
<a href="/comm-central/comparison/c30484eedecc8d09f2e6158fa4b85c957cee84da/mailnews/db/msgdb/src/nsMailDatabase.cpp">comparison</a> |
<a href="/comm-central/log/c30484eedecc8d09f2e6158fa4b85c957cee84da/mailnews/db/msgdb/src/nsMailDatabase.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c30484eedecc8d09f2e6158fa4b85c957cee84da/mailnews/db/msgdb/src/nsMsgDatabase.cpp">mailnews/db/msgdb/src/nsMsgDatabase.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c30484eedecc8d09f2e6158fa4b85c957cee84da/mailnews/db/msgdb/src/nsMsgDatabase.cpp">file</a> |
<a href="/comm-central/annotate/c30484eedecc8d09f2e6158fa4b85c957cee84da/mailnews/db/msgdb/src/nsMsgDatabase.cpp">annotate</a> |
<a href="/comm-central/diff/c30484eedecc8d09f2e6158fa4b85c957cee84da/mailnews/db/msgdb/src/nsMsgDatabase.cpp">diff</a> |
<a href="/comm-central/comparison/c30484eedecc8d09f2e6158fa4b85c957cee84da/mailnews/db/msgdb/src/nsMsgDatabase.cpp">comparison</a> |
<a href="/comm-central/log/c30484eedecc8d09f2e6158fa4b85c957cee84da/mailnews/db/msgdb/src/nsMsgDatabase.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c30484eedecc8d09f2e6158fa4b85c957cee84da/mailnews/imap/src/nsImapMailFolder.cpp">mailnews/imap/src/nsImapMailFolder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c30484eedecc8d09f2e6158fa4b85c957cee84da/mailnews/imap/src/nsImapMailFolder.cpp">file</a> |
<a href="/comm-central/annotate/c30484eedecc8d09f2e6158fa4b85c957cee84da/mailnews/imap/src/nsImapMailFolder.cpp">annotate</a> |
<a href="/comm-central/diff/c30484eedecc8d09f2e6158fa4b85c957cee84da/mailnews/imap/src/nsImapMailFolder.cpp">diff</a> |
<a href="/comm-central/comparison/c30484eedecc8d09f2e6158fa4b85c957cee84da/mailnews/imap/src/nsImapMailFolder.cpp">comparison</a> |
<a href="/comm-central/log/c30484eedecc8d09f2e6158fa4b85c957cee84da/mailnews/imap/src/nsImapMailFolder.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c30484eedecc8d09f2e6158fa4b85c957cee84da/mailnews/local/src/nsLocalMailFolder.cpp">mailnews/local/src/nsLocalMailFolder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c30484eedecc8d09f2e6158fa4b85c957cee84da/mailnews/local/src/nsLocalMailFolder.cpp">file</a> |
<a href="/comm-central/annotate/c30484eedecc8d09f2e6158fa4b85c957cee84da/mailnews/local/src/nsLocalMailFolder.cpp">annotate</a> |
<a href="/comm-central/diff/c30484eedecc8d09f2e6158fa4b85c957cee84da/mailnews/local/src/nsLocalMailFolder.cpp">diff</a> |
<a href="/comm-central/comparison/c30484eedecc8d09f2e6158fa4b85c957cee84da/mailnews/local/src/nsLocalMailFolder.cpp">comparison</a> |
<a href="/comm-central/log/c30484eedecc8d09f2e6158fa4b85c957cee84da/mailnews/local/src/nsLocalMailFolder.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c30484eedecc8d09f2e6158fa4b85c957cee84da/mailnews/local/src/nsLocalUndoTxn.cpp">mailnews/local/src/nsLocalUndoTxn.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c30484eedecc8d09f2e6158fa4b85c957cee84da/mailnews/local/src/nsLocalUndoTxn.cpp">file</a> |
<a href="/comm-central/annotate/c30484eedecc8d09f2e6158fa4b85c957cee84da/mailnews/local/src/nsLocalUndoTxn.cpp">annotate</a> |
<a href="/comm-central/diff/c30484eedecc8d09f2e6158fa4b85c957cee84da/mailnews/local/src/nsLocalUndoTxn.cpp">diff</a> |
<a href="/comm-central/comparison/c30484eedecc8d09f2e6158fa4b85c957cee84da/mailnews/local/src/nsLocalUndoTxn.cpp">comparison</a> |
<a href="/comm-central/log/c30484eedecc8d09f2e6158fa4b85c957cee84da/mailnews/local/src/nsLocalUndoTxn.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c30484eedecc8d09f2e6158fa4b85c957cee84da/mailnews/news/src/nsNewsFolder.cpp">mailnews/news/src/nsNewsFolder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c30484eedecc8d09f2e6158fa4b85c957cee84da/mailnews/news/src/nsNewsFolder.cpp">file</a> |
<a href="/comm-central/annotate/c30484eedecc8d09f2e6158fa4b85c957cee84da/mailnews/news/src/nsNewsFolder.cpp">annotate</a> |
<a href="/comm-central/diff/c30484eedecc8d09f2e6158fa4b85c957cee84da/mailnews/news/src/nsNewsFolder.cpp">diff</a> |
<a href="/comm-central/comparison/c30484eedecc8d09f2e6158fa4b85c957cee84da/mailnews/news/src/nsNewsFolder.cpp">comparison</a> |
<a href="/comm-central/log/c30484eedecc8d09f2e6158fa4b85c957cee84da/mailnews/news/src/nsNewsFolder.cpp">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/base/public/nsIMsgFolder.idl</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/base/public/nsIMsgFolder.idl</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -578,18 +578,17 @@ interface nsIMsgFolder : nsISupports {</span>
<a href="#l1.4"></a><span id="l1.4">                                in boolean caseInsensitive);</span>
<a href="#l1.5"></a><span id="l1.5">   void downloadAllForOffline(in nsIUrlListener listener, in nsIMsgWindow window);</span>
<a href="#l1.6"></a><span id="l1.6">   /**</span>
<a href="#l1.7"></a><span id="l1.7">    *  Turn notifications on/off for various notification types. Currently only</span>
<a href="#l1.8"></a><span id="l1.8">    *  supporting allMessageCountNotifications which refers to both total and</span>
<a href="#l1.9"></a><span id="l1.9">    *  unread message counts.</span>
<a href="#l1.10"></a><span id="l1.10">    */</span>
<a href="#l1.11"></a><span id="l1.11">   const unsigned long allMessageCountNotifications    = 0;</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-  void enableNotifications(in long notificationType, in boolean enable,</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-                           in boolean dbBatching);</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+  void enableNotifications(in long notificationType, in boolean enable);</span>
<a href="#l1.15"></a><span id="l1.15">   boolean isCommandEnabled(in ACString command);</span>
<a href="#l1.16"></a><span id="l1.16">   boolean matchOrChangeFilterDestination(in nsIMsgFolder folder,</span>
<a href="#l1.17"></a><span id="l1.17">                                          in boolean caseInsensitive);</span>
<a href="#l1.18"></a><span id="l1.18">   boolean confirmFolderDeletionForFilter(in nsIMsgWindow msgWindow);</span>
<a href="#l1.19"></a><span id="l1.19">   void alertFilterChanged(in nsIMsgWindow msgWindow);</span>
<a href="#l1.20"></a><span id="l1.20">   void throwAlertMsg(in string msgName, in nsIMsgWindow msgWindow);</span>
<a href="#l1.21"></a><span id="l1.21">   AString getStringWithFolderNameFromBundle(in string msgName);</span>
<a href="#l1.22"></a><span id="l1.22">   void notifyCompactCompleted();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/base/search/src/nsMsgSearchSession.cpp</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/base/search/src/nsMsgSearchSession.cpp</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -651,17 +651,17 @@ void</span>
<a href="#l2.4"></a><span id="l2.4"> nsMsgSearchSession::EnableFolderNotifications(bool aEnable)</span>
<a href="#l2.5"></a><span id="l2.5"> {</span>
<a href="#l2.6"></a><span id="l2.6">   nsMsgSearchScopeTerm *scope = GetRunningScope();</span>
<a href="#l2.7"></a><span id="l2.7">   if (scope)</span>
<a href="#l2.8"></a><span id="l2.8">   {</span>
<a href="#l2.9"></a><span id="l2.9">     nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l2.10"></a><span id="l2.10">     scope-&gt;GetFolder(getter_AddRefs(folder));</span>
<a href="#l2.11"></a><span id="l2.11">     if (folder)  //enable msg count notifications</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-      folder-&gt;EnableNotifications(nsIMsgFolder::allMessageCountNotifications, aEnable, false);</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+      folder-&gt;EnableNotifications(nsIMsgFolder::allMessageCountNotifications, aEnable);</span>
<a href="#l2.14"></a><span id="l2.14">   }</span>
<a href="#l2.15"></a><span id="l2.15"> }</span>
<a href="#l2.16"></a><span id="l2.16"> </span>
<a href="#l2.17"></a><span id="l2.17"> //this method is used for adding new hdrs to quick search view</span>
<a href="#l2.18"></a><span id="l2.18"> NS_IMETHODIMP</span>
<a href="#l2.19"></a><span id="l2.19"> nsMsgSearchSession::MatchHdr(nsIMsgDBHdr *aMsgHdr, nsIMsgDatabase *aDatabase, bool *aResult)</span>
<a href="#l2.20"></a><span id="l2.20"> {</span>
<a href="#l2.21"></a><span id="l2.21">   nsMsgSearchScopeTerm *scope = m_scopeList.SafeElementAt(0, nullptr);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/base/src/nsMsgDBView.cpp</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgDBView.cpp</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -2965,17 +2965,17 @@ nsMsgDBView::ApplyCommandToIndices(nsMsg</span>
<a href="#l3.4"></a><span id="l3.4">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.5"></a><span id="l3.5">     if (!mJunkHdrs)</span>
<a href="#l3.6"></a><span id="l3.6">     {</span>
<a href="#l3.7"></a><span id="l3.7">       mJunkHdrs = do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l3.8"></a><span id="l3.8">       NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l3.9"></a><span id="l3.9">     }</span>
<a href="#l3.10"></a><span id="l3.10">   }</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-  folder-&gt;EnableNotifications(nsIMsgFolder::allMessageCountNotifications, false, true /*dbBatching*/);</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+  folder-&gt;EnableNotifications(nsIMsgFolder::allMessageCountNotifications, false);</span>
<a href="#l3.14"></a><span id="l3.14"> </span>
<a href="#l3.15"></a><span id="l3.15">   // no sense going through the code that handles messages in collasped threads</span>
<a href="#l3.16"></a><span id="l3.16">   // for mark thread read.</span>
<a href="#l3.17"></a><span id="l3.17">   if (command == nsMsgViewCommandType::markThreadRead)</span>
<a href="#l3.18"></a><span id="l3.18">   {</span>
<a href="#l3.19"></a><span id="l3.19">     for (int32_t index = 0; index &lt; numIndices; index++)</span>
<a href="#l3.20"></a><span id="l3.20">       SetThreadOfMsgReadByIndex(indices[index], imapUids, true);</span>
<a href="#l3.21"></a><span id="l3.21">   }</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineat">@@ -3063,17 +3063,17 @@ nsMsgDBView::ApplyCommandToIndices(nsMsg</span>
<a href="#l3.23"></a><span id="l3.23">       if (notifier)</span>
<a href="#l3.24"></a><span id="l3.24">         notifier-&gt;NotifyItemEvent(messages,</span>
<a href="#l3.25"></a><span id="l3.25">                                   NS_LITERAL_CSTRING(&quot;JunkStatusChanged&quot;),</span>
<a href="#l3.26"></a><span id="l3.26">                                   (command == nsMsgViewCommandType::junk) ?</span>
<a href="#l3.27"></a><span id="l3.27">                                     kJunkMsgAtom : kNotJunkMsgAtom);</span>
<a href="#l3.28"></a><span id="l3.28">     }</span>
<a href="#l3.29"></a><span id="l3.29">   }</span>
<a href="#l3.30"></a><span id="l3.30"> </span>
<a href="#l3.31"></a><span id="l3.31" class="difflineminus">-  folder-&gt;EnableNotifications(nsIMsgFolder::allMessageCountNotifications, true, true /*dbBatching*/);</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineplus">+  folder-&gt;EnableNotifications(nsIMsgFolder::allMessageCountNotifications, true);</span>
<a href="#l3.33"></a><span id="l3.33"> </span>
<a href="#l3.34"></a><span id="l3.34">   if (thisIsImapFolder)</span>
<a href="#l3.35"></a><span id="l3.35">   {</span>
<a href="#l3.36"></a><span id="l3.36">     imapMessageFlagsType flags = kNoImapMsgFlag;</span>
<a href="#l3.37"></a><span id="l3.37">     bool addFlags = false;</span>
<a href="#l3.38"></a><span id="l3.38">     nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow(do_QueryReferent(mMsgWindowWeak));</span>
<a href="#l3.39"></a><span id="l3.39">     switch (command)</span>
<a href="#l3.40"></a><span id="l3.40">     {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/base/src/nsMsgQuickSearchDBView.cpp</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgQuickSearchDBView.cpp</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -87,26 +87,26 @@ nsresult nsMsgQuickSearchDBView::DeleteM</span>
<a href="#l4.4"></a><span id="l4.4">   return nsMsgDBView::DeleteMessages(window, indices, numIndices, deleteStorage);</span>
<a href="#l4.5"></a><span id="l4.5"> }</span>
<a href="#l4.6"></a><span id="l4.6"> </span>
<a href="#l4.7"></a><span id="l4.7"> NS_IMETHODIMP nsMsgQuickSearchDBView::DoCommand(nsMsgViewCommandTypeValue aCommand)</span>
<a href="#l4.8"></a><span id="l4.8"> {</span>
<a href="#l4.9"></a><span id="l4.9">   if (aCommand == nsMsgViewCommandType::markAllRead)</span>
<a href="#l4.10"></a><span id="l4.10">   {</span>
<a href="#l4.11"></a><span id="l4.11">     nsresult rv = NS_OK;</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-    m_folder-&gt;EnableNotifications(nsIMsgFolder::allMessageCountNotifications, false, true /*dbBatching*/);</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+    m_folder-&gt;EnableNotifications(nsIMsgFolder::allMessageCountNotifications, false);</span>
<a href="#l4.14"></a><span id="l4.14"> </span>
<a href="#l4.15"></a><span id="l4.15">     for (uint32_t i = 0; NS_SUCCEEDED(rv) &amp;&amp; i &lt; GetSize(); i++)</span>
<a href="#l4.16"></a><span id="l4.16">     {</span>
<a href="#l4.17"></a><span id="l4.17">       nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l4.18"></a><span id="l4.18">       m_db-&gt;GetMsgHdrForKey(m_keys[i],getter_AddRefs(msgHdr)); </span>
<a href="#l4.19"></a><span id="l4.19">       rv = m_db-&gt;MarkHdrRead(msgHdr, true, nullptr);</span>
<a href="#l4.20"></a><span id="l4.20">     }</span>
<a href="#l4.21"></a><span id="l4.21"> </span>
<a href="#l4.22"></a><span id="l4.22" class="difflineminus">-    m_folder-&gt;EnableNotifications(nsIMsgFolder::allMessageCountNotifications, true, true /*dbBatching*/);</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineplus">+    m_folder-&gt;EnableNotifications(nsIMsgFolder::allMessageCountNotifications, true);</span>
<a href="#l4.24"></a><span id="l4.24"> </span>
<a href="#l4.25"></a><span id="l4.25">     nsCOMPtr&lt;nsIMsgImapMailFolder&gt; imapFolder = do_QueryInterface(m_folder);</span>
<a href="#l4.26"></a><span id="l4.26">     if (NS_SUCCEEDED(rv) &amp;&amp; imapFolder)</span>
<a href="#l4.27"></a><span id="l4.27">       rv = imapFolder-&gt;StoreImapFlags(kImapMsgSeenFlag, true, m_keys.Elements(), </span>
<a href="#l4.28"></a><span id="l4.28">                                       m_keys.Length(), nullptr);</span>
<a href="#l4.29"></a><span id="l4.29"> </span>
<a href="#l4.30"></a><span id="l4.30">     m_db-&gt;SetSummaryValid(true);</span>
<a href="#l4.31"></a><span id="l4.31">     return rv;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/base/util/nsMsgDBFolder.cpp</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgDBFolder.cpp</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -1459,21 +1459,21 @@ nsresult nsMsgDBFolder::AddMarkAllReadUn</span>
<a href="#l5.4"></a><span id="l5.4"> NS_IMETHODIMP</span>
<a href="#l5.5"></a><span id="l5.5"> nsMsgDBFolder::MarkAllMessagesRead(nsIMsgWindow *aMsgWindow)</span>
<a href="#l5.6"></a><span id="l5.6"> {</span>
<a href="#l5.7"></a><span id="l5.7">   nsresult rv = GetDatabase();</span>
<a href="#l5.8"></a><span id="l5.8">   m_newMsgs.Clear();</span>
<a href="#l5.9"></a><span id="l5.9"> </span>
<a href="#l5.10"></a><span id="l5.10">   if (NS_SUCCEEDED(rv))</span>
<a href="#l5.11"></a><span id="l5.11">   {</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-    EnableNotifications(allMessageCountNotifications, false, true /*dbBatching*/);</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+    EnableNotifications(allMessageCountNotifications, false);</span>
<a href="#l5.14"></a><span id="l5.14">     nsMsgKey *thoseMarked;</span>
<a href="#l5.15"></a><span id="l5.15">     uint32_t numMarked;</span>
<a href="#l5.16"></a><span id="l5.16">     rv = mDatabase-&gt;MarkAllRead(&amp;numMarked, &amp;thoseMarked);</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineminus">-    EnableNotifications(allMessageCountNotifications, true, true /*dbBatching*/);</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineplus">+    EnableNotifications(allMessageCountNotifications, true);</span>
<a href="#l5.19"></a><span id="l5.19">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.20"></a><span id="l5.20"> </span>
<a href="#l5.21"></a><span id="l5.21">     // Setup a undo-state</span>
<a href="#l5.22"></a><span id="l5.22">     if (aMsgWindow &amp;&amp; numMarked)</span>
<a href="#l5.23"></a><span id="l5.23">       rv = AddMarkAllReadUndoAction(aMsgWindow, thoseMarked, numMarked);</span>
<a href="#l5.24"></a><span id="l5.24">     free(thoseMarked);</span>
<a href="#l5.25"></a><span id="l5.25">   }</span>
<a href="#l5.26"></a><span id="l5.26"> </span>
<a href="#l5.27"></a><span id="l5.27" class="difflineat">@@ -5068,37 +5068,25 @@ nsMsgDBFolder::SetEditableFilterList(nsI</span>
<a href="#l5.28"></a><span id="l5.28"> {</span>
<a href="#l5.29"></a><span id="l5.29">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l5.30"></a><span id="l5.30">   nsresult rv = GetServer(getter_AddRefs(server));</span>
<a href="#l5.31"></a><span id="l5.31">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.32"></a><span id="l5.32">   return server-&gt;SetEditableFilterList(aFilterList);</span>
<a href="#l5.33"></a><span id="l5.33"> }</span>
<a href="#l5.34"></a><span id="l5.34"> </span>
<a href="#l5.35"></a><span id="l5.35"> /* void enableNotifications (in long notificationType, in boolean enable); */</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::EnableNotifications(int32_t notificationType, bool enable, bool dbBatching)</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::EnableNotifications(int32_t notificationType, bool enable)</span>
<a href="#l5.38"></a><span id="l5.38"> {</span>
<a href="#l5.39"></a><span id="l5.39">   if (notificationType == nsIMsgFolder::allMessageCountNotifications)</span>
<a href="#l5.40"></a><span id="l5.40">   {</span>
<a href="#l5.41"></a><span id="l5.41">     mNotifyCountChanges = enable;</span>
<a href="#l5.42"></a><span id="l5.42" class="difflineminus">-    // start and stop db batching here. This is under the theory</span>
<a href="#l5.43"></a><span id="l5.43" class="difflineminus">-    // that any time we want to enable and disable notifications,</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineminus">-    // we're probably doing something that should be batched.</span>
<a href="#l5.45"></a><span id="l5.45" class="difflineminus">-    nsCOMPtr &lt;nsIMsgDatabase&gt; database;</span>
<a href="#l5.46"></a><span id="l5.46" class="difflineminus">-</span>
<a href="#l5.47"></a><span id="l5.47" class="difflineminus">-    if (dbBatching)  //only if we do dbBatching we need to get db</span>
<a href="#l5.48"></a><span id="l5.48" class="difflineminus">-      GetMsgDatabase(getter_AddRefs(database));</span>
<a href="#l5.49"></a><span id="l5.49" class="difflineminus">-</span>
<a href="#l5.50"></a><span id="l5.50">     if (enable)</span>
<a href="#l5.51"></a><span id="l5.51">     {</span>
<a href="#l5.52"></a><span id="l5.52" class="difflineminus">-      if (database)</span>
<a href="#l5.53"></a><span id="l5.53" class="difflineminus">-        database-&gt;EndBatch();</span>
<a href="#l5.54"></a><span id="l5.54">       UpdateSummaryTotals(true);</span>
<a href="#l5.55"></a><span id="l5.55">     }</span>
<a href="#l5.56"></a><span id="l5.56" class="difflineminus">-    else if (database)</span>
<a href="#l5.57"></a><span id="l5.57" class="difflineminus">-      return database-&gt;StartBatch();</span>
<a href="#l5.58"></a><span id="l5.58">     return NS_OK;</span>
<a href="#l5.59"></a><span id="l5.59">   }</span>
<a href="#l5.60"></a><span id="l5.60">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l5.61"></a><span id="l5.61"> }</span>
<a href="#l5.62"></a><span id="l5.62"> </span>
<a href="#l5.63"></a><span id="l5.63"> NS_IMETHODIMP nsMsgDBFolder::GetMessageHeader(nsMsgKey msgKey, nsIMsgDBHdr **aMsgHdr)</span>
<a href="#l5.64"></a><span id="l5.64"> {</span>
<a href="#l5.65"></a><span id="l5.65">   NS_ENSURE_ARG_POINTER(aMsgHdr);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/db/msgdb/public/nsIMsgDatabase.idl</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/db/msgdb/public/nsIMsgDatabase.idl</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -480,20 +480,16 @@ interface nsIMsgDatabase : nsIDBChangeAn</span>
<a href="#l6.4"></a><span id="l6.4"> </span>
<a href="#l6.5"></a><span id="l6.5">   // used mainly to force the timestamp of a local mail folder db to</span>
<a href="#l6.6"></a><span id="l6.6">   // match the time stamp of the corresponding berkeley mail folder,</span>
<a href="#l6.7"></a><span id="l6.7">   // but also useful to tell the summary to mark itself invalid</span>
<a href="#l6.8"></a><span id="l6.8">   // Also, if a local folder is being reparsed, summary will be invalid</span>
<a href="#l6.9"></a><span id="l6.9">   // until the reparsing is done.</span>
<a href="#l6.10"></a><span id="l6.10">   attribute boolean summaryValid;</span>
<a href="#l6.11"></a><span id="l6.11"> </span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-  // batching - can be used to cache file stream for local mail,</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-  // and perhaps to use the mdb batching mechanism as well.</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineminus">-  void StartBatch();</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineminus">-  void EndBatch();</span>
<a href="#l6.16"></a><span id="l6.16">   // offline operations - we could move these into an offline operation interface</span>
<a href="#l6.17"></a><span id="l6.17">   // but it would have to be in nsMailDatabase, since local folders can be move destinations</span>
<a href="#l6.18"></a><span id="l6.18">   nsIMsgOfflineImapOperation GetOfflineOpForKey(in nsMsgKey messageKey, in boolean create);</span>
<a href="#l6.19"></a><span id="l6.19">   void  RemoveOfflineOp(in nsIMsgOfflineImapOperation op);</span>
<a href="#l6.20"></a><span id="l6.20">   nsISimpleEnumerator EnumerateOfflineOps();</span>
<a href="#l6.21"></a><span id="l6.21">   [noscript] void ListAllOfflineOpIds(in nsMsgKeyArrayPtr offlineOpIds);</span>
<a href="#l6.22"></a><span id="l6.22">   [noscript] void ListAllOfflineDeletes(in nsMsgKeyArrayPtr offlineDeletes);</span>
<a href="#l6.23"></a><span id="l6.23">   void ListAllOfflineMsgs(in nsIMsgKeyArray aKeys);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/db/msgdb/public/nsImapMailDatabase.h</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/db/msgdb/public/nsImapMailDatabase.h</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -11,19 +11,17 @@</span>
<a href="#l7.4"></a><span id="l7.4"> class nsImapMailDatabase : public nsMailDatabase</span>
<a href="#l7.5"></a><span id="l7.5"> {</span>
<a href="#l7.6"></a><span id="l7.6"> public:</span>
<a href="#l7.7"></a><span id="l7.7">   // OK, it's dumb that this should require a fileSpec, since there is no file</span>
<a href="#l7.8"></a><span id="l7.8">   // for the folder. This is mainly because we're deriving from nsMailDatabase;</span>
<a href="#l7.9"></a><span id="l7.9">   // Perhaps we shouldn't...</span>
<a href="#l7.10"></a><span id="l7.10">   nsImapMailDatabase();</span>
<a href="#l7.11"></a><span id="l7.11">   virtual ~nsImapMailDatabase();</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-  </span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">-  NS_IMETHOD    StartBatch() override;</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineminus">-  NS_IMETHOD    EndBatch() override;</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+</span>
<a href="#l7.16"></a><span id="l7.16">   NS_IMETHOD    GetSummaryValid(bool *aResult) override;</span>
<a href="#l7.17"></a><span id="l7.17">   NS_IMETHOD    SetSummaryValid(bool valid = true) override;</span>
<a href="#l7.18"></a><span id="l7.18">   virtual nsresult AdjustExpungedBytesOnDelete(nsIMsgDBHdr *msgHdr) override;</span>
<a href="#l7.19"></a><span id="l7.19"> </span>
<a href="#l7.20"></a><span id="l7.20">   NS_IMETHOD    ForceClosed() override;</span>
<a href="#l7.21"></a><span id="l7.21">   NS_IMETHOD    AddNewHdrToDB(nsIMsgDBHdr *newHdr, bool notify) override;</span>
<a href="#l7.22"></a><span id="l7.22">   NS_IMETHOD    SetAttributeOnPendingHdr(nsIMsgDBHdr *pendingHdr, const char *property,</span>
<a href="#l7.23"></a><span id="l7.23">                                          const char *propertyVal) override;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/db/msgdb/public/nsMailDatabase.h</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/db/msgdb/public/nsMailDatabase.h</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -21,18 +21,16 @@ class nsMailDatabase : public nsMsgDatab</span>
<a href="#l8.4"></a><span id="l8.4"> {</span>
<a href="#l8.5"></a><span id="l8.5"> public:</span>
<a href="#l8.6"></a><span id="l8.6">   nsMailDatabase();</span>
<a href="#l8.7"></a><span id="l8.7">   virtual ~nsMailDatabase();</span>
<a href="#l8.8"></a><span id="l8.8">   NS_IMETHOD  ForceClosed() override;</span>
<a href="#l8.9"></a><span id="l8.9">   NS_IMETHOD DeleteMessages(uint32_t aNumKeys, nsMsgKey* nsMsgKeys,</span>
<a href="#l8.10"></a><span id="l8.10">                             nsIDBChangeListener *instigator) override;</span>
<a href="#l8.11"></a><span id="l8.11"> </span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-  NS_IMETHOD StartBatch() override;</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineminus">-  NS_IMETHOD EndBatch() override;</span>
<a href="#l8.14"></a><span id="l8.14"> </span>
<a href="#l8.15"></a><span id="l8.15">   nsresult  Open(nsMsgDBService* aDBService, nsIFile *aSummaryFile, bool create, bool upgrading) override;</span>
<a href="#l8.16"></a><span id="l8.16">   virtual nsMailDatabase  *GetMailDB() {return this;}</span>
<a href="#l8.17"></a><span id="l8.17"> </span>
<a href="#l8.18"></a><span id="l8.18">   virtual uint32_t  GetCurVersion() override {return kMsgDBVersion;}</span>
<a href="#l8.19"></a><span id="l8.19">   </span>
<a href="#l8.20"></a><span id="l8.20">   NS_IMETHOD  GetOfflineOpForKey(nsMsgKey opKey, bool create,</span>
<a href="#l8.21"></a><span id="l8.21">                                  nsIMsgOfflineImapOperation **op) override;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/db/msgdb/src/nsImapMailDatabase.cpp</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/db/msgdb/src/nsImapMailDatabase.cpp</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -55,27 +55,16 @@ void nsImapMailDatabase::UpdateFolderFla</span>
<a href="#l9.4"></a><span id="l9.4"> </span>
<a href="#l9.5"></a><span id="l9.5"> // We override this to avoid our parent class (nsMailDatabase)'s </span>
<a href="#l9.6"></a><span id="l9.6"> // grabbing of the folder semaphore, and bailing on failure.</span>
<a href="#l9.7"></a><span id="l9.7"> NS_IMETHODIMP nsImapMailDatabase::DeleteMessages(uint32_t aNumKeys, nsMsgKey* nsMsgKeys, nsIDBChangeListener *instigator)</span>
<a href="#l9.8"></a><span id="l9.8"> {</span>
<a href="#l9.9"></a><span id="l9.9">   return nsMsgDatabase::DeleteMessages(aNumKeys, nsMsgKeys, instigator);</span>
<a href="#l9.10"></a><span id="l9.10"> }</span>
<a href="#l9.11"></a><span id="l9.11"> </span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-// override so nsMailDatabase methods that deal with m_folderStream are *not* called</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineminus">-NS_IMETHODIMP nsImapMailDatabase::StartBatch()</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineminus">-{</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineminus">-  return NS_OK;</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineminus">-}</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineminus">-</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineminus">-NS_IMETHODIMP nsImapMailDatabase::EndBatch()</span>
<a href="#l9.19"></a><span id="l9.19" class="difflineminus">-{</span>
<a href="#l9.20"></a><span id="l9.20" class="difflineminus">-  return NS_OK;</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineminus">-}</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineminus">-</span>
<a href="#l9.23"></a><span id="l9.23"> nsresult nsImapMailDatabase::AdjustExpungedBytesOnDelete(nsIMsgDBHdr *msgHdr)</span>
<a href="#l9.24"></a><span id="l9.24"> {</span>
<a href="#l9.25"></a><span id="l9.25">   uint32_t msgFlags;</span>
<a href="#l9.26"></a><span id="l9.26">   msgHdr-&gt;GetFlags(&amp;msgFlags);</span>
<a href="#l9.27"></a><span id="l9.27">   if (msgFlags &amp; nsMsgMessageFlags::Offline &amp;&amp; m_dbFolderInfo)</span>
<a href="#l9.28"></a><span id="l9.28">   {</span>
<a href="#l9.29"></a><span id="l9.29">     uint32_t size = 0;</span>
<a href="#l9.30"></a><span id="l9.30">     (void)msgHdr-&gt;GetOfflineMessageSize(&amp;size);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/db/msgdb/src/nsMailDatabase.cpp</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/db/msgdb/src/nsMailDatabase.cpp</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -64,26 +64,16 @@ nsresult nsMailDatabase::GetAllOfflineOp</span>
<a href="#l10.4"></a><span id="l10.4"> {</span>
<a href="#l10.5"></a><span id="l10.5">   nsresult rv = NS_OK;</span>
<a href="#l10.6"></a><span id="l10.6">   if (!m_mdbAllOfflineOpsTable)</span>
<a href="#l10.7"></a><span id="l10.7">     rv = GetTableCreateIfMissing(kOfflineOpsScope, kOfflineOpsTableKind, getter_AddRefs(m_mdbAllOfflineOpsTable), </span>
<a href="#l10.8"></a><span id="l10.8">                                                 m_offlineOpsRowScopeToken, m_offlineOpsTableKindToken) ;</span>
<a href="#l10.9"></a><span id="l10.9">   return rv;</span>
<a href="#l10.10"></a><span id="l10.10"> }</span>
<a href="#l10.11"></a><span id="l10.11"> </span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-NS_IMETHODIMP nsMailDatabase::StartBatch()</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineminus">-{</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineminus">-  return NS_OK;</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineminus">-}</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineminus">-</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineminus">-NS_IMETHODIMP nsMailDatabase::EndBatch()</span>
<a href="#l10.18"></a><span id="l10.18" class="difflineminus">-{</span>
<a href="#l10.19"></a><span id="l10.19" class="difflineminus">-  SetSummaryValid(true);</span>
<a href="#l10.20"></a><span id="l10.20" class="difflineminus">-  return NS_OK;</span>
<a href="#l10.21"></a><span id="l10.21" class="difflineminus">-}</span>
<a href="#l10.22"></a><span id="l10.22"> </span>
<a href="#l10.23"></a><span id="l10.23"> NS_IMETHODIMP nsMailDatabase::DeleteMessages(uint32_t aNumKeys, nsMsgKey* nsMsgKeys, nsIDBChangeListener *instigator)</span>
<a href="#l10.24"></a><span id="l10.24"> {</span>
<a href="#l10.25"></a><span id="l10.25">   nsresult rv;</span>
<a href="#l10.26"></a><span id="l10.26">   if (m_folder)</span>
<a href="#l10.27"></a><span id="l10.27">   {</span>
<a href="#l10.28"></a><span id="l10.28">     bool isLocked;</span>
<a href="#l10.29"></a><span id="l10.29">     m_folder-&gt;GetLocked(&amp;isLocked);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/db/msgdb/src/nsMsgDatabase.cpp</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/db/msgdb/src/nsMsgDatabase.cpp</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -1912,26 +1912,16 @@ NS_IMETHODIMP nsMsgDatabase::GetMsgHdrFo</span>
<a href="#l11.4"></a><span id="l11.4">         err = CreateMsgHdr(hdrRow,  key, pmsgHdr);</span>
<a href="#l11.5"></a><span id="l11.5">       }</span>
<a href="#l11.6"></a><span id="l11.6">     }</span>
<a href="#l11.7"></a><span id="l11.7">   }</span>
<a href="#l11.8"></a><span id="l11.8"> </span>
<a href="#l11.9"></a><span id="l11.9">   return err;</span>
<a href="#l11.10"></a><span id="l11.10"> }</span>
<a href="#l11.11"></a><span id="l11.11"> </span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-NS_IMETHODIMP nsMsgDatabase::StartBatch()</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineminus">-{</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineminus">-  return NS_OK;</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineminus">-}</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineminus">-</span>
<a href="#l11.17"></a><span id="l11.17" class="difflineminus">-NS_IMETHODIMP nsMsgDatabase::EndBatch()</span>
<a href="#l11.18"></a><span id="l11.18" class="difflineminus">-{</span>
<a href="#l11.19"></a><span id="l11.19" class="difflineminus">-  return NS_OK;</span>
<a href="#l11.20"></a><span id="l11.20" class="difflineminus">-}</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineminus">-</span>
<a href="#l11.22"></a><span id="l11.22"> NS_IMETHODIMP nsMsgDatabase::DeleteMessage(nsMsgKey key, nsIDBChangeListener *instigator, bool commit)</span>
<a href="#l11.23"></a><span id="l11.23"> {</span>
<a href="#l11.24"></a><span id="l11.24">   nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l11.25"></a><span id="l11.25"> </span>
<a href="#l11.26"></a><span id="l11.26">   nsresult rv = GetMsgHdrForKey(key, getter_AddRefs(msgHdr));</span>
<a href="#l11.27"></a><span id="l11.27">   if (!msgHdr)</span>
<a href="#l11.28"></a><span id="l11.28">     return NS_MSG_MESSAGE_NOT_FOUND;</span>
<a href="#l11.29"></a><span id="l11.29"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/imap/src/nsImapMailFolder.cpp</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapMailFolder.cpp</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -1897,19 +1897,19 @@ nsImapMailFolder::SetLabelForMessages(ns</span>
<a href="#l12.4"></a><span id="l12.4"> NS_IMETHODIMP</span>
<a href="#l12.5"></a><span id="l12.5"> nsImapMailFolder::MarkAllMessagesRead(nsIMsgWindow *aMsgWindow)</span>
<a href="#l12.6"></a><span id="l12.6"> {</span>
<a href="#l12.7"></a><span id="l12.7">   nsresult rv = GetDatabase();</span>
<a href="#l12.8"></a><span id="l12.8">   if(NS_SUCCEEDED(rv))</span>
<a href="#l12.9"></a><span id="l12.9">   {</span>
<a href="#l12.10"></a><span id="l12.10">     nsMsgKey *thoseMarked;</span>
<a href="#l12.11"></a><span id="l12.11">     uint32_t numMarked;</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-    EnableNotifications(allMessageCountNotifications, false, true /*dbBatching*/);</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+    EnableNotifications(allMessageCountNotifications, false);</span>
<a href="#l12.14"></a><span id="l12.14">     rv = mDatabase-&gt;MarkAllRead(&amp;numMarked, &amp;thoseMarked);</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineminus">-    EnableNotifications(allMessageCountNotifications, true, true /*dbBatching*/);</span>
<a href="#l12.16"></a><span id="l12.16" class="difflineplus">+    EnableNotifications(allMessageCountNotifications, true);</span>
<a href="#l12.17"></a><span id="l12.17">     if (NS_SUCCEEDED(rv) &amp;&amp; numMarked)</span>
<a href="#l12.18"></a><span id="l12.18">     {</span>
<a href="#l12.19"></a><span id="l12.19">       rv = StoreImapFlags(kImapMsgSeenFlag, true, thoseMarked,</span>
<a href="#l12.20"></a><span id="l12.20">                           numMarked, nullptr);</span>
<a href="#l12.21"></a><span id="l12.21">       mDatabase-&gt;Commit(nsMsgDBCommitType::kLargeCommit);</span>
<a href="#l12.22"></a><span id="l12.22"> </span>
<a href="#l12.23"></a><span id="l12.23">       // Setup a undo-state</span>
<a href="#l12.24"></a><span id="l12.24">       if (aMsgWindow)</span>
<a href="#l12.25"></a><span id="l12.25" class="difflineat">@@ -2288,27 +2288,27 @@ NS_IMETHODIMP nsImapMailFolder::DeleteMe</span>
<a href="#l12.26"></a><span id="l12.26">     {</span>
<a href="#l12.27"></a><span id="l12.27">       if (mDatabase)</span>
<a href="#l12.28"></a><span id="l12.28">       {</span>
<a href="#l12.29"></a><span id="l12.29">         nsCOMPtr&lt;nsIMsgDatabase&gt; database(mDatabase);</span>
<a href="#l12.30"></a><span id="l12.30">         if (deleteModel == nsMsgImapDeleteModels::IMAPDelete)</span>
<a href="#l12.31"></a><span id="l12.31">           MarkMessagesImapDeleted(&amp;srcKeyArray, deleteMsgs, database);</span>
<a href="#l12.32"></a><span id="l12.32">         else</span>
<a href="#l12.33"></a><span id="l12.33">         {</span>
<a href="#l12.34"></a><span id="l12.34" class="difflineminus">-          EnableNotifications(allMessageCountNotifications, false, true /*dbBatching*/);  //&quot;remove it immediately&quot; model</span>
<a href="#l12.35"></a><span id="l12.35" class="difflineplus">+          EnableNotifications(allMessageCountNotifications, false);  //&quot;remove it immediately&quot; model</span>
<a href="#l12.36"></a><span id="l12.36">           // Notify if this is an actual delete.</span>
<a href="#l12.37"></a><span id="l12.37">           if (!isMove)</span>
<a href="#l12.38"></a><span id="l12.38">           {</span>
<a href="#l12.39"></a><span id="l12.39">             nsCOMPtr&lt;nsIMsgFolderNotificationService&gt; notifier(do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID));</span>
<a href="#l12.40"></a><span id="l12.40">             if (notifier)</span>
<a href="#l12.41"></a><span id="l12.41">               notifier-&gt;NotifyMsgsDeleted(messages);</span>
<a href="#l12.42"></a><span id="l12.42">           }</span>
<a href="#l12.43"></a><span id="l12.43">           DeleteStoreMessages(messages);</span>
<a href="#l12.44"></a><span id="l12.44">           database-&gt;DeleteMessages(srcKeyArray.Length(), srcKeyArray.Elements(), nullptr);</span>
<a href="#l12.45"></a><span id="l12.45" class="difflineminus">-          EnableNotifications(allMessageCountNotifications, true, true /*dbBatching*/);</span>
<a href="#l12.46"></a><span id="l12.46" class="difflineplus">+          EnableNotifications(allMessageCountNotifications, true);</span>
<a href="#l12.47"></a><span id="l12.47">         }</span>
<a href="#l12.48"></a><span id="l12.48">         NotifyFolderEvent(mDeleteOrMoveMsgCompletedAtom);</span>
<a href="#l12.49"></a><span id="l12.49">       }</span>
<a href="#l12.50"></a><span id="l12.50">     }</span>
<a href="#l12.51"></a><span id="l12.51">     return rv;</span>
<a href="#l12.52"></a><span id="l12.52">   }</span>
<a href="#l12.53"></a><span id="l12.53">   else  // have to move the messages to the trash</span>
<a href="#l12.54"></a><span id="l12.54">   {</span>
<a href="#l12.55"></a><span id="l12.55" class="difflineat">@@ -2801,19 +2801,19 @@ NS_IMETHODIMP nsImapMailFolder::UpdateIm</span>
<a href="#l12.56"></a><span id="l12.56">     hdrsToDelete-&gt;GetLength(&amp;numHdrs);</span>
<a href="#l12.57"></a><span id="l12.57">     if (numHdrs)</span>
<a href="#l12.58"></a><span id="l12.58">     {</span>
<a href="#l12.59"></a><span id="l12.59">       nsCOMPtr&lt;nsIMsgFolderNotificationService&gt; notifier(do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID));</span>
<a href="#l12.60"></a><span id="l12.60">       if (notifier)</span>
<a href="#l12.61"></a><span id="l12.61">         notifier-&gt;NotifyMsgsDeleted(hdrsToDelete);</span>
<a href="#l12.62"></a><span id="l12.62">     }</span>
<a href="#l12.63"></a><span id="l12.63">     DeleteStoreMessages(hdrsToDelete);</span>
<a href="#l12.64"></a><span id="l12.64" class="difflineminus">-    EnableNotifications(nsIMsgFolder::allMessageCountNotifications, false, false);</span>
<a href="#l12.65"></a><span id="l12.65" class="difflineplus">+    EnableNotifications(nsIMsgFolder::allMessageCountNotifications, false);</span>
<a href="#l12.66"></a><span id="l12.66">     mDatabase-&gt;DeleteMessages(keysToDelete.Length(), keysToDelete.Elements(), nullptr);</span>
<a href="#l12.67"></a><span id="l12.67" class="difflineminus">-    EnableNotifications(nsIMsgFolder::allMessageCountNotifications, true, false);</span>
<a href="#l12.68"></a><span id="l12.68" class="difflineplus">+    EnableNotifications(nsIMsgFolder::allMessageCountNotifications, true);</span>
<a href="#l12.69"></a><span id="l12.69">   }</span>
<a href="#l12.70"></a><span id="l12.70">   int32_t numUnreadFromServer;</span>
<a href="#l12.71"></a><span id="l12.71">   aSpec-&gt;GetNumUnseenMessages(&amp;numUnreadFromServer);</span>
<a href="#l12.72"></a><span id="l12.72">   </span>
<a href="#l12.73"></a><span id="l12.73">   bool partialUIDFetch;</span>
<a href="#l12.74"></a><span id="l12.74">   flagState-&gt;GetPartialUIDFetch(&amp;partialUIDFetch);</span>
<a href="#l12.75"></a><span id="l12.75">   </span>
<a href="#l12.76"></a><span id="l12.76">   // For partial UID fetches, we can only trust the numUnread from the server.</span>
<a href="#l12.77"></a><span id="l12.77" class="difflineat">@@ -5285,17 +5285,17 @@ nsImapMailFolder::OnStopRunningUrl(nsIUR</span>
<a href="#l12.78"></a><span id="l12.78">                   // (!m_copyState-&gt;m_isCrossServerOp in if above), so we can</span>
<a href="#l12.79"></a><span id="l12.79">                   // assume that the src is also imap that uses offline storage.</span>
<a href="#l12.80"></a><span id="l12.80">                   DeleteStoreMessages(srcKeyArray, srcFolder);</span>
<a href="#l12.81"></a><span id="l12.81">                   srcDB-&gt;DeleteMessages(srcKeyArray.Length(), srcKeyArray.Elements(), nullptr);</span>
<a href="#l12.82"></a><span id="l12.82">                 }</span>
<a href="#l12.83"></a><span id="l12.83">                 else</span>
<a href="#l12.84"></a><span id="l12.84">                   MarkMessagesImapDeleted(&amp;srcKeyArray, true, srcDB);</span>
<a href="#l12.85"></a><span id="l12.85">               }</span>
<a href="#l12.86"></a><span id="l12.86" class="difflineminus">-              srcFolder-&gt;EnableNotifications(allMessageCountNotifications, true, true/* dbBatching*/);</span>
<a href="#l12.87"></a><span id="l12.87" class="difflineplus">+              srcFolder-&gt;EnableNotifications(allMessageCountNotifications, true);</span>
<a href="#l12.88"></a><span id="l12.88">               // even if we're showing deleted messages,</span>
<a href="#l12.89"></a><span id="l12.89">               // we still need to notify FE so it will show the imap deleted flag</span>
<a href="#l12.90"></a><span id="l12.90">               srcFolder-&gt;NotifyFolderEvent(mDeleteOrMoveMsgCompletedAtom);</span>
<a href="#l12.91"></a><span id="l12.91">               // is there a way to see that we think we have new msgs?</span>
<a href="#l12.92"></a><span id="l12.92">               nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l12.93"></a><span id="l12.93">               if (NS_SUCCEEDED(rv))</span>
<a href="#l12.94"></a><span id="l12.94">               {</span>
<a href="#l12.95"></a><span id="l12.95">                 bool showPreviewText;</span>
<a href="#l12.96"></a><span id="l12.96" class="difflineat">@@ -5305,17 +5305,17 @@ nsImapMailFolder::OnStopRunningUrl(nsIUR</span>
<a href="#l12.97"></a><span id="l12.97">                 // to preview the msg bodies.</span>
<a href="#l12.98"></a><span id="l12.98">                 if (!folderOpen &amp;&amp; showPreviewText &amp;&amp; m_copyState-&gt;m_unreadCount &gt; 0</span>
<a href="#l12.99"></a><span id="l12.99">                     &amp;&amp; ! (mFlags &amp; (nsMsgFolderFlags::Trash | nsMsgFolderFlags::Junk)))</span>
<a href="#l12.100"></a><span id="l12.100">                   UpdateFolder(msgWindow);</span>
<a href="#l12.101"></a><span id="l12.101">               }</span>
<a href="#l12.102"></a><span id="l12.102">             }</span>
<a href="#l12.103"></a><span id="l12.103">             else</span>
<a href="#l12.104"></a><span id="l12.104">             {</span>
<a href="#l12.105"></a><span id="l12.105" class="difflineminus">-              srcFolder-&gt;EnableNotifications(allMessageCountNotifications, true, true/* dbBatching*/);</span>
<a href="#l12.106"></a><span id="l12.106" class="difflineplus">+              srcFolder-&gt;EnableNotifications(allMessageCountNotifications, true);</span>
<a href="#l12.107"></a><span id="l12.107">               srcFolder-&gt;NotifyFolderEvent(mDeleteOrMoveMsgFailedAtom);</span>
<a href="#l12.108"></a><span id="l12.108">             }</span>
<a href="#l12.109"></a><span id="l12.109"> </span>
<a href="#l12.110"></a><span id="l12.110">           }</span>
<a href="#l12.111"></a><span id="l12.111">           if (m_copyState-&gt;m_msgWindow &amp;&amp;</span>
<a href="#l12.112"></a><span id="l12.112">               m_copyState-&gt;m_undoMsgTxn &amp;&amp;  // may be null from filters</span>
<a href="#l12.113"></a><span id="l12.113">               NS_SUCCEEDED(aExitCode))      //we should do this only if move/copy succeeds</span>
<a href="#l12.114"></a><span id="l12.114">           {</span>
<a href="#l12.115"></a><span id="l12.115" class="difflineat">@@ -7186,17 +7186,17 @@ nsresult nsImapMailFolder::CopyMessagesO</span>
<a href="#l12.116"></a><span id="l12.116">       nsCOMArray&lt;nsIMsgDBHdr&gt; srcMsgs;</span>
<a href="#l12.117"></a><span id="l12.117">       nsOfflineImapOperationType moveCopyOpType;</span>
<a href="#l12.118"></a><span id="l12.118">       nsOfflineImapOperationType deleteOpType = nsIMsgOfflineImapOperation::kDeletedMsg;</span>
<a href="#l12.119"></a><span id="l12.119">       if (!deleteToTrash)</span>
<a href="#l12.120"></a><span id="l12.120">         deleteOpType = nsIMsgOfflineImapOperation::kMsgMarkedDeleted;</span>
<a href="#l12.121"></a><span id="l12.121">       nsCString messageIds;</span>
<a href="#l12.122"></a><span id="l12.122">       rv = BuildIdsAndKeyArray(messages, messageIds, srcKeyArray);</span>
<a href="#l12.123"></a><span id="l12.123">       // put fake message in destination db, delete source if move</span>
<a href="#l12.124"></a><span id="l12.124" class="difflineminus">-      EnableNotifications(nsIMsgFolder::allMessageCountNotifications, false, false);</span>
<a href="#l12.125"></a><span id="l12.125" class="difflineplus">+      EnableNotifications(nsIMsgFolder::allMessageCountNotifications, false);</span>
<a href="#l12.126"></a><span id="l12.126">       for (uint32_t sourceKeyIndex = 0; NS_SUCCEEDED(stopit) &amp;&amp; (sourceKeyIndex &lt; srcCount); sourceKeyIndex++)</span>
<a href="#l12.127"></a><span id="l12.127">       {</span>
<a href="#l12.128"></a><span id="l12.128">         bool messageReturningHome = false;</span>
<a href="#l12.129"></a><span id="l12.129">         nsCString originalSrcFolderURI;</span>
<a href="#l12.130"></a><span id="l12.130">         srcFolder-&gt;GetURI(originalSrcFolderURI);</span>
<a href="#l12.131"></a><span id="l12.131">         nsCOMPtr&lt;nsIMsgDBHdr&gt; message;</span>
<a href="#l12.132"></a><span id="l12.132">         message = do_QueryElementAt(messages, sourceKeyIndex);</span>
<a href="#l12.133"></a><span id="l12.133">         nsMsgKey originalKey;</span>
<a href="#l12.134"></a><span id="l12.134" class="difflineat">@@ -7346,17 +7346,17 @@ nsresult nsImapMailFolder::CopyMessagesO</span>
<a href="#l12.135"></a><span id="l12.135">             else</span>
<a href="#l12.136"></a><span id="l12.136">               sourceMailDB-&gt;MarkImapDeleted(msgKey, true, nullptr); // offline delete</span>
<a href="#l12.137"></a><span id="l12.137">           }</span>
<a href="#l12.138"></a><span id="l12.138">           if (successfulCopy)</span>
<a href="#l12.139"></a><span id="l12.139">             // This is for both moves and copies</span>
<a href="#l12.140"></a><span id="l12.140">             msgHdrsCopied-&gt;AppendElement(mailHdr, false);</span>
<a href="#l12.141"></a><span id="l12.141">         }</span>
<a href="#l12.142"></a><span id="l12.142">       }</span>
<a href="#l12.143"></a><span id="l12.143" class="difflineminus">-      EnableNotifications(nsIMsgFolder::allMessageCountNotifications, true, false);</span>
<a href="#l12.144"></a><span id="l12.144" class="difflineplus">+      EnableNotifications(nsIMsgFolder::allMessageCountNotifications, true);</span>
<a href="#l12.145"></a><span id="l12.145">       RefPtr&lt;nsImapOfflineTxn&gt; addHdrMsgTxn = new</span>
<a href="#l12.146"></a><span id="l12.146">         nsImapOfflineTxn(this, &amp;addedKeys, nullptr, this, isMove, nsIMsgOfflineImapOperation::kAddedHeader,</span>
<a href="#l12.147"></a><span id="l12.147">                          addedHdrs);</span>
<a href="#l12.148"></a><span id="l12.148">       if (addHdrMsgTxn &amp;&amp; txnMgr)</span>
<a href="#l12.149"></a><span id="l12.149">          txnMgr-&gt;DoTransaction(addHdrMsgTxn);</span>
<a href="#l12.150"></a><span id="l12.150">       RefPtr&lt;nsImapOfflineTxn&gt; undoMsgTxn = new</span>
<a href="#l12.151"></a><span id="l12.151">         nsImapOfflineTxn(srcFolder, &amp;srcKeyArray, messageIds.get(), this,</span>
<a href="#l12.152"></a><span id="l12.152">                          isMove, moveCopyOpType, srcMsgs);</span>
<a href="#l12.153"></a><span id="l12.153" class="difflineat">@@ -7419,20 +7419,20 @@ nsresult nsImapMailFolder::CopyMessagesO</span>
<a href="#l12.154"></a><span id="l12.154">     nsCOMPtr&lt;nsIMsgFolderNotificationService&gt; notifier(do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID));</span>
<a href="#l12.155"></a><span id="l12.155">     if (notifier)</span>
<a href="#l12.156"></a><span id="l12.156">       notifier-&gt;NotifyMsgsMoveCopyCompleted(isMove, msgHdrsCopied, this, destMsgHdrs);</span>
<a href="#l12.157"></a><span id="l12.157">   }</span>
<a href="#l12.158"></a><span id="l12.158"> </span>
<a href="#l12.159"></a><span id="l12.159">   if (isMove &amp;&amp; NS_SUCCEEDED(rv) &amp;&amp; (deleteToTrash || deleteImmediately))</span>
<a href="#l12.160"></a><span id="l12.160">   {</span>
<a href="#l12.161"></a><span id="l12.161">     DeleteStoreMessages(keysToDelete, srcFolder);</span>
<a href="#l12.162"></a><span id="l12.162" class="difflineminus">-    srcFolder-&gt;EnableNotifications(nsIMsgFolder::allMessageCountNotifications, false, false);</span>
<a href="#l12.163"></a><span id="l12.163" class="difflineplus">+    srcFolder-&gt;EnableNotifications(nsIMsgFolder::allMessageCountNotifications, false);</span>
<a href="#l12.164"></a><span id="l12.164">     sourceMailDB-&gt;DeleteMessages(keysToDelete.Length(), keysToDelete.Elements(),</span>
<a href="#l12.165"></a><span id="l12.165">                                  nullptr);</span>
<a href="#l12.166"></a><span id="l12.166" class="difflineminus">-    srcFolder-&gt;EnableNotifications(nsIMsgFolder::allMessageCountNotifications, true, false);</span>
<a href="#l12.167"></a><span id="l12.167" class="difflineplus">+    srcFolder-&gt;EnableNotifications(nsIMsgFolder::allMessageCountNotifications, true);</span>
<a href="#l12.168"></a><span id="l12.168">   }</span>
<a href="#l12.169"></a><span id="l12.169"> </span>
<a href="#l12.170"></a><span id="l12.170">   nsCOMPtr&lt;nsISupports&gt; srcSupport = do_QueryInterface(srcFolder);</span>
<a href="#l12.171"></a><span id="l12.171">   OnCopyCompleted(srcSupport, rv);</span>
<a href="#l12.172"></a><span id="l12.172"> </span>
<a href="#l12.173"></a><span id="l12.173">   if (isMove)</span>
<a href="#l12.174"></a><span id="l12.174">     srcFolder-&gt;NotifyFolderEvent(NS_SUCCEEDED(rv) ?</span>
<a href="#l12.175"></a><span id="l12.175">                                  mDeleteOrMoveMsgCompletedAtom :</span>
<a href="#l12.176"></a><span id="l12.176" class="difflineat">@@ -7677,17 +7677,17 @@ nsImapMailFolder::CopyMessages(nsIMsgFol</span>
<a href="#l12.177"></a><span id="l12.177">     rv = QueryInterface(NS_GET_IID(nsIUrlListener), getter_AddRefs(urlListener));</span>
<a href="#l12.178"></a><span id="l12.178">     rv = InitCopyState(srcSupport, sortedMsgs, isMove, true, false,</span>
<a href="#l12.179"></a><span id="l12.179">                        0, EmptyCString(), listener, msgWindow, allowUndo);</span>
<a href="#l12.180"></a><span id="l12.180">     if (NS_FAILED(rv)) goto done;</span>
<a href="#l12.181"></a><span id="l12.181"> </span>
<a href="#l12.182"></a><span id="l12.182">     m_copyState-&gt;m_curIndex = m_copyState-&gt;m_totalCount;</span>
<a href="#l12.183"></a><span id="l12.183"> </span>
<a href="#l12.184"></a><span id="l12.184">     if (isMove)</span>
<a href="#l12.185"></a><span id="l12.185" class="difflineminus">-      srcFolder-&gt;EnableNotifications(allMessageCountNotifications, false, true/* dbBatching*/);  //disable message count notification</span>
<a href="#l12.186"></a><span id="l12.186" class="difflineplus">+      srcFolder-&gt;EnableNotifications(allMessageCountNotifications, false);  //disable message count notification</span>
<a href="#l12.187"></a><span id="l12.187"> </span>
<a href="#l12.188"></a><span id="l12.188">     nsCOMPtr&lt;nsISupports&gt; copySupport = do_QueryInterface(m_copyState);</span>
<a href="#l12.189"></a><span id="l12.189">     rv = imapService-&gt;OnlineMessageCopy(srcFolder, messageIds,</span>
<a href="#l12.190"></a><span id="l12.190">                                         this, true, isMove,</span>
<a href="#l12.191"></a><span id="l12.191">                                         urlListener, nullptr,</span>
<a href="#l12.192"></a><span id="l12.192">                                         copySupport, msgWindow);</span>
<a href="#l12.193"></a><span id="l12.193">     if (NS_SUCCEEDED(rv) &amp;&amp; m_copyState-&gt;m_allowUndo)</span>
<a href="#l12.194"></a><span id="l12.194">     {</span>
<a href="#l12.195"></a><span id="l12.195" class="difflineat">@@ -7712,17 +7712,17 @@ nsImapMailFolder::CopyMessages(nsIMsgFol</span>
<a href="#l12.196"></a><span id="l12.196">   }//endif</span>
<a href="#l12.197"></a><span id="l12.197">   </span>
<a href="#l12.198"></a><span id="l12.198"> done:</span>
<a href="#l12.199"></a><span id="l12.199">   if (NS_FAILED(rv))</span>
<a href="#l12.200"></a><span id="l12.200">   {</span>
<a href="#l12.201"></a><span id="l12.201">     (void) OnCopyCompleted(srcSupport, rv);</span>
<a href="#l12.202"></a><span id="l12.202">     if (isMove)</span>
<a href="#l12.203"></a><span id="l12.203">     {</span>
<a href="#l12.204"></a><span id="l12.204" class="difflineminus">-      srcFolder-&gt;EnableNotifications(allMessageCountNotifications, true, true/* dbBatching*/);  //enable message count notification</span>
<a href="#l12.205"></a><span id="l12.205" class="difflineplus">+      srcFolder-&gt;EnableNotifications(allMessageCountNotifications, true);  //enable message count notification</span>
<a href="#l12.206"></a><span id="l12.206">       NotifyFolderEvent(mDeleteOrMoveMsgFailedAtom);</span>
<a href="#l12.207"></a><span id="l12.207">     }</span>
<a href="#l12.208"></a><span id="l12.208">   }</span>
<a href="#l12.209"></a><span id="l12.209">   return rv;</span>
<a href="#l12.210"></a><span id="l12.210"> }</span>
<a href="#l12.211"></a><span id="l12.211"> </span>
<a href="#l12.212"></a><span id="l12.212"> class nsImapFolderCopyState final : public nsIUrlListener, public nsIMsgCopyServiceListener</span>
<a href="#l12.213"></a><span id="l12.213"> {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mailnews/local/src/nsLocalMailFolder.cpp</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mailnews/local/src/nsLocalMailFolder.cpp</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -1209,17 +1209,17 @@ nsMsgLocalMailFolder::DeleteMessages(nsI</span>
<a href="#l13.4"></a><span id="l13.4">     nsCOMPtr &lt;nsIMsgDatabase&gt; msgDB;</span>
<a href="#l13.5"></a><span id="l13.5">     rv = GetDatabaseWOReparse(getter_AddRefs(msgDB));</span>
<a href="#l13.6"></a><span id="l13.6">     if (NS_SUCCEEDED(rv))</span>
<a href="#l13.7"></a><span id="l13.7">     {</span>
<a href="#l13.8"></a><span id="l13.8">       if (deleteStorage &amp;&amp; isMove &amp;&amp; GetDeleteFromServerOnMove())</span>
<a href="#l13.9"></a><span id="l13.9">         MarkMsgsOnPop3Server(messages, POP3_DELETE);</span>
<a href="#l13.10"></a><span id="l13.10"> </span>
<a href="#l13.11"></a><span id="l13.11">       nsCOMPtr&lt;nsISupports&gt; msgSupport;</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-      rv = EnableNotifications(allMessageCountNotifications, false, true /*dbBatching*/);</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+      rv = EnableNotifications(allMessageCountNotifications, false);</span>
<a href="#l13.14"></a><span id="l13.14">       if (NS_SUCCEEDED(rv))</span>
<a href="#l13.15"></a><span id="l13.15">       {</span>
<a href="#l13.16"></a><span id="l13.16">         nsCOMPtr&lt;nsIMsgPluggableStore&gt; msgStore;</span>
<a href="#l13.17"></a><span id="l13.17">         rv = GetMsgStore(getter_AddRefs(msgStore));</span>
<a href="#l13.18"></a><span id="l13.18">         if (NS_SUCCEEDED(rv))</span>
<a href="#l13.19"></a><span id="l13.19">         {</span>
<a href="#l13.20"></a><span id="l13.20">           rv = msgStore-&gt;DeleteMessages(messages);</span>
<a href="#l13.21"></a><span id="l13.21">           nsCOMPtr&lt;nsIMsgDBHdr&gt; msgDBHdr;</span>
<a href="#l13.22"></a><span id="l13.22" class="difflineat">@@ -1231,17 +1231,17 @@ nsMsgLocalMailFolder::DeleteMessages(nsI</span>
<a href="#l13.23"></a><span id="l13.23">         }</span>
<a href="#l13.24"></a><span id="l13.24">       }</span>
<a href="#l13.25"></a><span id="l13.25">       else if (rv == NS_MSG_FOLDER_BUSY)</span>
<a href="#l13.26"></a><span id="l13.26">         ThrowAlertMsg(&quot;deletingMsgsFailed&quot;, msgWindow);</span>
<a href="#l13.27"></a><span id="l13.27"> </span>
<a href="#l13.28"></a><span id="l13.28">       // we are the source folder here for a move or shift delete</span>
<a href="#l13.29"></a><span id="l13.29">       //enable notifications because that will close the file stream</span>
<a href="#l13.30"></a><span id="l13.30">       // we've been caching, mark the db as valid, and commit it.</span>
<a href="#l13.31"></a><span id="l13.31" class="difflineminus">-      EnableNotifications(allMessageCountNotifications, true, true /*dbBatching*/);</span>
<a href="#l13.32"></a><span id="l13.32" class="difflineplus">+      EnableNotifications(allMessageCountNotifications, true);</span>
<a href="#l13.33"></a><span id="l13.33">       if (!isMove)</span>
<a href="#l13.34"></a><span id="l13.34">         NotifyFolderEvent(NS_SUCCEEDED(rv) ? mDeleteOrMoveMsgCompletedAtom : mDeleteOrMoveMsgFailedAtom);</span>
<a href="#l13.35"></a><span id="l13.35">       if (msgWindow &amp;&amp; !isMove)</span>
<a href="#l13.36"></a><span id="l13.36">         AutoCompact(msgWindow);</span>
<a href="#l13.37"></a><span id="l13.37">     }</span>
<a href="#l13.38"></a><span id="l13.38">   }</span>
<a href="#l13.39"></a><span id="l13.39"> </span>
<a href="#l13.40"></a><span id="l13.40">   if (msgWindow &amp;&amp; !isMove &amp;&amp; (deleteStorage || isTrashFolder)) {</span>
<a href="#l13.41"></a><span id="l13.41" class="difflineat">@@ -1309,19 +1309,19 @@ nsMsgLocalMailFolder::MarkMessagesFlagge</span>
<a href="#l13.42"></a><span id="l13.42"> NS_IMETHODIMP</span>
<a href="#l13.43"></a><span id="l13.43"> nsMsgLocalMailFolder::MarkAllMessagesRead(nsIMsgWindow *aMsgWindow)</span>
<a href="#l13.44"></a><span id="l13.44"> {</span>
<a href="#l13.45"></a><span id="l13.45">   nsresult rv = GetDatabase();</span>
<a href="#l13.46"></a><span id="l13.46">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.47"></a><span id="l13.47"> </span>
<a href="#l13.48"></a><span id="l13.48">   nsMsgKey *thoseMarked = nullptr;</span>
<a href="#l13.49"></a><span id="l13.49">   uint32_t numMarked = 0;</span>
<a href="#l13.50"></a><span id="l13.50" class="difflineminus">-  EnableNotifications(allMessageCountNotifications, false, true /*dbBatching*/);</span>
<a href="#l13.51"></a><span id="l13.51" class="difflineplus">+  EnableNotifications(allMessageCountNotifications, false);</span>
<a href="#l13.52"></a><span id="l13.52">   rv = mDatabase-&gt;MarkAllRead(&amp;numMarked, &amp;thoseMarked);</span>
<a href="#l13.53"></a><span id="l13.53" class="difflineminus">-  EnableNotifications(allMessageCountNotifications, true, true /*dbBatching*/);</span>
<a href="#l13.54"></a><span id="l13.54" class="difflineplus">+  EnableNotifications(allMessageCountNotifications, true);</span>
<a href="#l13.55"></a><span id="l13.55">   if (NS_FAILED(rv) || !numMarked || !thoseMarked)</span>
<a href="#l13.56"></a><span id="l13.56">     return rv;</span>
<a href="#l13.57"></a><span id="l13.57"> </span>
<a href="#l13.58"></a><span id="l13.58">   do {</span>
<a href="#l13.59"></a><span id="l13.59">     nsCOMPtr&lt;nsIMutableArray&gt; messages;</span>
<a href="#l13.60"></a><span id="l13.60">     rv = MsgGetHdrsFromKeys(mDatabase, thoseMarked, numMarked, getter_AddRefs(messages));</span>
<a href="#l13.61"></a><span id="l13.61">     if (NS_FAILED(rv))</span>
<a href="#l13.62"></a><span id="l13.62">       break;</span>
<a href="#l13.63"></a><span id="l13.63" class="difflineat">@@ -1587,17 +1587,17 @@ nsMsgLocalMailFolder::CopyMessages(nsIMs</span>
<a href="#l13.64"></a><span id="l13.64">                                                       mDeleteOrMoveMsgFailedAtom);</span>
<a href="#l13.65"></a><span id="l13.65"> </span>
<a href="#l13.66"></a><span id="l13.66">     return rv;</span>
<a href="#l13.67"></a><span id="l13.67">   }</span>
<a href="#l13.68"></a><span id="l13.68">   // If the store doesn't do the copy, we'll stream the source messages into</span>
<a href="#l13.69"></a><span id="l13.69">   // the target folder, using getMsgInputStream and getNewMsgOutputStream.</span>
<a href="#l13.70"></a><span id="l13.70"> </span>
<a href="#l13.71"></a><span id="l13.71">   // don't update the counts in the dest folder until it is all over</span>
<a href="#l13.72"></a><span id="l13.72" class="difflineminus">-  EnableNotifications(allMessageCountNotifications, false, false /*dbBatching*/);  //dest folder doesn't need db batching</span>
<a href="#l13.73"></a><span id="l13.73" class="difflineplus">+  EnableNotifications(allMessageCountNotifications, false);</span>
<a href="#l13.74"></a><span id="l13.74"> </span>
<a href="#l13.75"></a><span id="l13.75">   // sort the message array by key</span>
<a href="#l13.76"></a><span id="l13.76">   uint32_t numMsgs = 0;</span>
<a href="#l13.77"></a><span id="l13.77">   messages-&gt;GetLength(&amp;numMsgs);</span>
<a href="#l13.78"></a><span id="l13.78">   nsTArray&lt;nsMsgKey&gt; keyArray(numMsgs);</span>
<a href="#l13.79"></a><span id="l13.79">   if (numMsgs &gt; 1)</span>
<a href="#l13.80"></a><span id="l13.80">   {</span>
<a href="#l13.81"></a><span id="l13.81">     for (uint32_t i = 0; i &lt; numMsgs; i++)</span>
<a href="#l13.82"></a><span id="l13.82" class="difflineat">@@ -1687,17 +1687,17 @@ nsMsgLocalMailFolder::CopyMessages(nsIMs</span>
<a href="#l13.83"></a><span id="l13.83">       }</span>
<a href="#l13.84"></a><span id="l13.84">     }</span>
<a href="#l13.85"></a><span id="l13.85">   }</span>
<a href="#l13.86"></a><span id="l13.86">   // if this failed immediately, need to turn back on notifications and inform FE.</span>
<a href="#l13.87"></a><span id="l13.87">   if (NS_FAILED(rv))</span>
<a href="#l13.88"></a><span id="l13.88">   {</span>
<a href="#l13.89"></a><span id="l13.89">     if (isMove)</span>
<a href="#l13.90"></a><span id="l13.90">       srcFolder-&gt;NotifyFolderEvent(mDeleteOrMoveMsgFailedAtom);</span>
<a href="#l13.91"></a><span id="l13.91" class="difflineminus">-    EnableNotifications(allMessageCountNotifications, true, false /*dbBatching*/);  //dest folder doesn't need db batching</span>
<a href="#l13.92"></a><span id="l13.92" class="difflineplus">+    EnableNotifications(allMessageCountNotifications, true);</span>
<a href="#l13.93"></a><span id="l13.93">   }</span>
<a href="#l13.94"></a><span id="l13.94">   return rv;</span>
<a href="#l13.95"></a><span id="l13.95"> }</span>
<a href="#l13.96"></a><span id="l13.96"> // for srcFolder that are on different server than the dstFolder.</span>
<a href="#l13.97"></a><span id="l13.97"> // &quot;this&quot; is the parent of the new dest folder.</span>
<a href="#l13.98"></a><span id="l13.98"> nsresult</span>
<a href="#l13.99"></a><span id="l13.99"> nsMsgLocalMailFolder::CopyFolderAcrossServer(nsIMsgFolder* srcFolder, nsIMsgWindow *msgWindow,</span>
<a href="#l13.100"></a><span id="l13.100">                   nsIMsgCopyServiceListener *listener )</span>
<a href="#l13.101"></a><span id="l13.101" class="difflineat">@@ -2331,17 +2331,17 @@ NS_IMETHODIMP nsMsgLocalMailFolder::EndC</span>
<a href="#l13.102"></a><span id="l13.102">     if (!mCopyState-&gt;m_isMove)</span>
<a href="#l13.103"></a><span id="l13.103">     {</span>
<a href="#l13.104"></a><span id="l13.104">       // passing true because the messages that have been successfully</span>
<a href="#l13.105"></a><span id="l13.105">       // copied have their corresponding hdrs in place. The message that has</span>
<a href="#l13.106"></a><span id="l13.106">       // failed has been truncated so the msf file and berkeley mailbox</span>
<a href="#l13.107"></a><span id="l13.107">       // are in sync.</span>
<a href="#l13.108"></a><span id="l13.108">       (void) OnCopyCompleted(mCopyState-&gt;m_srcSupport, true);</span>
<a href="#l13.109"></a><span id="l13.109">       // enable the dest folder</span>
<a href="#l13.110"></a><span id="l13.110" class="difflineminus">-      EnableNotifications(allMessageCountNotifications, true, false /*dbBatching*/); //dest folder doesn't need db batching</span>
<a href="#l13.111"></a><span id="l13.111" class="difflineplus">+      EnableNotifications(allMessageCountNotifications, true);</span>
<a href="#l13.112"></a><span id="l13.112">     }</span>
<a href="#l13.113"></a><span id="l13.113">     return NS_OK;</span>
<a href="#l13.114"></a><span id="l13.114">   }</span>
<a href="#l13.115"></a><span id="l13.115"> </span>
<a href="#l13.116"></a><span id="l13.116">   bool multipleCopiesFinished = (mCopyState-&gt;m_curCopyIndex &gt;= mCopyState-&gt;m_totalMsgCount);</span>
<a href="#l13.117"></a><span id="l13.117"> </span>
<a href="#l13.118"></a><span id="l13.118">   RefPtr&lt;nsLocalMoveCopyMsgTxn&gt; localUndoTxn = mCopyState-&gt;m_undoMsgTxn;</span>
<a href="#l13.119"></a><span id="l13.119"> </span>
<a href="#l13.120"></a><span id="l13.120" class="difflineat">@@ -2538,17 +2538,17 @@ NS_IMETHODIMP nsMsgLocalMailFolder::EndC</span>
<a href="#l13.121"></a><span id="l13.121">         {</span>
<a href="#l13.122"></a><span id="l13.122">           nsCOMPtr&lt;nsITransactionManager&gt; txnMgr;</span>
<a href="#l13.123"></a><span id="l13.123">           mCopyState-&gt;m_msgWindow-&gt;GetTransactionManager(getter_AddRefs(txnMgr));</span>
<a href="#l13.124"></a><span id="l13.124">           if (txnMgr)</span>
<a href="#l13.125"></a><span id="l13.125">             txnMgr-&gt;DoTransaction(mCopyState-&gt;m_undoMsgTxn);</span>
<a href="#l13.126"></a><span id="l13.126">         }</span>
<a href="#l13.127"></a><span id="l13.127"> </span>
<a href="#l13.128"></a><span id="l13.128">         // enable the dest folder</span>
<a href="#l13.129"></a><span id="l13.129" class="difflineminus">-        EnableNotifications(allMessageCountNotifications, true, false /*dbBatching*/); //dest folder doesn't need db batching</span>
<a href="#l13.130"></a><span id="l13.130" class="difflineplus">+        EnableNotifications(allMessageCountNotifications, true);</span>
<a href="#l13.131"></a><span id="l13.131">         if (srcFolder &amp;&amp; !mCopyState-&gt;m_isFolder)</span>
<a href="#l13.132"></a><span id="l13.132">         {</span>
<a href="#l13.133"></a><span id="l13.133">           // I'm not too sure of the proper location of this event. It seems to need to be</span>
<a href="#l13.134"></a><span id="l13.134">           // after the EnableNotifications, or the folder counts can be incorrect</span>
<a href="#l13.135"></a><span id="l13.135">           // during the mDeleteOrMoveMsgCompletedAtom call.</span>
<a href="#l13.136"></a><span id="l13.136">           srcFolder-&gt;NotifyFolderEvent(mDeleteOrMoveMsgCompletedAtom);</span>
<a href="#l13.137"></a><span id="l13.137">         }</span>
<a href="#l13.138"></a><span id="l13.138">         (void) OnCopyCompleted(mCopyState-&gt;m_srcSupport, true);</span>
<a href="#l13.139"></a><span id="l13.139" class="difflineat">@@ -2608,17 +2608,17 @@ NS_IMETHODIMP nsMsgLocalMailFolder::EndM</span>
<a href="#l13.140"></a><span id="l13.140">     srcFolder-&gt;NotifyFolderEvent(mDeleteOrMoveMsgFailedAtom);</span>
<a href="#l13.141"></a><span id="l13.141"> </span>
<a href="#l13.142"></a><span id="l13.142">     /* passing true because the messages that have been successfully copied have their corressponding</span>
<a href="#l13.143"></a><span id="l13.143">                hdrs in place. The message that has failed has been truncated so the msf file and berkeley mailbox</span>
<a href="#l13.144"></a><span id="l13.144">                are in sync*/</span>
<a href="#l13.145"></a><span id="l13.145"> </span>
<a href="#l13.146"></a><span id="l13.146">     (void) OnCopyCompleted(mCopyState-&gt;m_srcSupport, true);</span>
<a href="#l13.147"></a><span id="l13.147">     // enable the dest folder</span>
<a href="#l13.148"></a><span id="l13.148" class="difflineminus">-    EnableNotifications(allMessageCountNotifications, true, false /*dbBatching*/ );  //dest folder doesn't need db batching</span>
<a href="#l13.149"></a><span id="l13.149" class="difflineplus">+    EnableNotifications(allMessageCountNotifications, true);</span>
<a href="#l13.150"></a><span id="l13.150">     return NS_OK;</span>
<a href="#l13.151"></a><span id="l13.151">   }</span>
<a href="#l13.152"></a><span id="l13.152"> </span>
<a href="#l13.153"></a><span id="l13.153">   if (mCopyState &amp;&amp; mCopyState-&gt;m_curCopyIndex &gt;= mCopyState-&gt;m_totalMsgCount)</span>
<a href="#l13.154"></a><span id="l13.154">   {</span>
<a href="#l13.155"></a><span id="l13.155">     //Notify that a completion finished.</span>
<a href="#l13.156"></a><span id="l13.156">     nsCOMPtr&lt;nsIMsgFolder&gt; srcFolder = do_QueryInterface(mCopyState-&gt;m_srcSupport, &amp;rv);</span>
<a href="#l13.157"></a><span id="l13.157">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.158"></a><span id="l13.158" class="difflineat">@@ -2636,17 +2636,17 @@ NS_IMETHODIMP nsMsgLocalMailFolder::EndM</span>
<a href="#l13.159"></a><span id="l13.159">           localSrcFolder-&gt;MarkMsgsOnPop3Server(mCopyState-&gt;m_messages, POP3_DELETE);</span>
<a href="#l13.160"></a><span id="l13.160">       }</span>
<a href="#l13.161"></a><span id="l13.161">     }</span>
<a href="#l13.162"></a><span id="l13.162">     // lets delete these all at once - much faster that way</span>
<a href="#l13.163"></a><span id="l13.163">     rv = srcFolder-&gt;DeleteMessages(mCopyState-&gt;m_messages, mCopyState-&gt;m_msgWindow, true, true, nullptr, mCopyState-&gt;m_allowUndo);</span>
<a href="#l13.164"></a><span id="l13.164">     AutoCompact(mCopyState-&gt;m_msgWindow);</span>
<a href="#l13.165"></a><span id="l13.165"> </span>
<a href="#l13.166"></a><span id="l13.166">     // enable the dest folder</span>
<a href="#l13.167"></a><span id="l13.167" class="difflineminus">-    EnableNotifications(allMessageCountNotifications, true, false /*dbBatching*/); //dest folder doesn't need db batching</span>
<a href="#l13.168"></a><span id="l13.168" class="difflineplus">+    EnableNotifications(allMessageCountNotifications, true);</span>
<a href="#l13.169"></a><span id="l13.169">     // I'm not too sure of the proper location of this event. It seems to need to be</span>
<a href="#l13.170"></a><span id="l13.170">     // after the EnableNotifications, or the folder counts can be incorrect</span>
<a href="#l13.171"></a><span id="l13.171">     // during the mDeleteOrMoveMsgCompletedAtom call.</span>
<a href="#l13.172"></a><span id="l13.172">     srcFolder-&gt;NotifyFolderEvent(NS_SUCCEEDED(rv) ? mDeleteOrMoveMsgCompletedAtom : mDeleteOrMoveMsgFailedAtom);</span>
<a href="#l13.173"></a><span id="l13.173"> </span>
<a href="#l13.174"></a><span id="l13.174">     if (NS_SUCCEEDED(rv) &amp;&amp; mCopyState-&gt;m_msgWindow &amp;&amp; mCopyState-&gt;m_undoMsgTxn)</span>
<a href="#l13.175"></a><span id="l13.175">     {</span>
<a href="#l13.176"></a><span id="l13.176">       nsCOMPtr&lt;nsITransactionManager&gt; txnMgr;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mailnews/local/src/nsLocalUndoTxn.cpp</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mailnews/local/src/nsLocalUndoTxn.cpp</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -240,17 +240,16 @@ nsLocalMoveCopyMsgTxn::UndoTransactionIn</span>
<a href="#l14.4"></a><span id="l14.4">     }</span>
<a href="#l14.5"></a><span id="l14.5">     else if (m_canUndelete)</span>
<a href="#l14.6"></a><span id="l14.6">     {</span>
<a href="#l14.7"></a><span id="l14.7">       nsCOMPtr&lt;nsIMutableArray&gt; srcMessages =</span>
<a href="#l14.8"></a><span id="l14.8">         do_CreateInstance(NS_ARRAY_CONTRACTID);</span>
<a href="#l14.9"></a><span id="l14.9">       nsCOMPtr&lt;nsIMutableArray&gt; dstMessages =</span>
<a href="#l14.10"></a><span id="l14.10">         do_CreateInstance(NS_ARRAY_CONTRACTID);</span>
<a href="#l14.11"></a><span id="l14.11"> </span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-      srcDB-&gt;StartBatch();</span>
<a href="#l14.13"></a><span id="l14.13">       for (i = 0; i &lt; count; i++)</span>
<a href="#l14.14"></a><span id="l14.14">       {</span>
<a href="#l14.15"></a><span id="l14.15">         rv = dstDB-&gt;GetMsgHdrForKey(m_dstKeyArray[i], </span>
<a href="#l14.16"></a><span id="l14.16">                                     getter_AddRefs(oldHdr));</span>
<a href="#l14.17"></a><span id="l14.17">         NS_ASSERTION(oldHdr, &quot;fatal ... cannot get old msg header\n&quot;);</span>
<a href="#l14.18"></a><span id="l14.18">         if (NS_SUCCEEDED(rv) &amp;&amp; oldHdr)</span>
<a href="#l14.19"></a><span id="l14.19">         {</span>
<a href="#l14.20"></a><span id="l14.20">           rv = srcDB-&gt;CopyHdrFromExistingHdr(m_srcKeyArray[i],</span>
<a href="#l14.21"></a><span id="l14.21" class="difflineat">@@ -263,17 +262,16 @@ nsLocalMoveCopyMsgTxn::UndoTransactionIn</span>
<a href="#l14.22"></a><span id="l14.22">             newHdr-&gt;SetStatusOffset(m_srcStatusOffsetArray[i]);</span>
<a href="#l14.23"></a><span id="l14.23">             srcDB-&gt;UndoDelete(newHdr);</span>
<a href="#l14.24"></a><span id="l14.24">             srcMessages-&gt;AppendElement(newHdr, false);</span>
<a href="#l14.25"></a><span id="l14.25">             // (we want to keep these two lists in sync)</span>
<a href="#l14.26"></a><span id="l14.26">             dstMessages-&gt;AppendElement(oldHdr, false);</span>
<a href="#l14.27"></a><span id="l14.27">           }</span>
<a href="#l14.28"></a><span id="l14.28">         }</span>
<a href="#l14.29"></a><span id="l14.29">       }</span>
<a href="#l14.30"></a><span id="l14.30" class="difflineminus">-      srcDB-&gt;EndBatch();</span>
<a href="#l14.31"></a><span id="l14.31"> </span>
<a href="#l14.32"></a><span id="l14.32">       nsCOMPtr&lt;nsIMsgFolderNotificationService&gt;</span>
<a href="#l14.33"></a><span id="l14.33">         notifier(do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID));</span>
<a href="#l14.34"></a><span id="l14.34">       if (notifier)</span>
<a href="#l14.35"></a><span id="l14.35">       {</span>
<a href="#l14.36"></a><span id="l14.36">         // Remember that we're actually moving things back from the destination</span>
<a href="#l14.37"></a><span id="l14.37">         //  to the source!</span>
<a href="#l14.38"></a><span id="l14.38">         notifier-&gt;NotifyMsgsMoveCopyCompleted(true, dstMessages,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mailnews/news/src/nsNewsFolder.cpp</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mailnews/news/src/nsNewsFolder.cpp</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -808,30 +808,30 @@ nsMsgNewsFolder::DeleteMessages(nsIArray</span>
<a href="#l15.4"></a><span id="l15.4">     nsCOMPtr&lt;nsIMsgFolderNotificationService&gt; notifier(do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID));</span>
<a href="#l15.5"></a><span id="l15.5">     if (notifier)</span>
<a href="#l15.6"></a><span id="l15.6">       notifier-&gt;NotifyMsgsDeleted(messages);</span>
<a href="#l15.7"></a><span id="l15.7">   }</span>
<a href="#l15.8"></a><span id="l15.8"> </span>
<a href="#l15.9"></a><span id="l15.9">   rv = GetDatabase();</span>
<a href="#l15.10"></a><span id="l15.10">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.11"></a><span id="l15.11"> </span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-  rv = EnableNotifications(allMessageCountNotifications, false, true);</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineplus">+  rv = EnableNotifications(allMessageCountNotifications, false);</span>
<a href="#l15.14"></a><span id="l15.14">   if (NS_SUCCEEDED(rv))</span>
<a href="#l15.15"></a><span id="l15.15">   {</span>
<a href="#l15.16"></a><span id="l15.16">     uint32_t count = 0;</span>
<a href="#l15.17"></a><span id="l15.17">     rv = messages-&gt;GetLength(&amp;count);</span>
<a href="#l15.18"></a><span id="l15.18">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.19"></a><span id="l15.19"> </span>
<a href="#l15.20"></a><span id="l15.20">     for (uint32_t i = 0; i &lt; count &amp;&amp; NS_SUCCEEDED(rv); i++)</span>
<a href="#l15.21"></a><span id="l15.21">     {</span>
<a href="#l15.22"></a><span id="l15.22">       nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr = do_QueryElementAt(messages, i, &amp;rv);</span>
<a href="#l15.23"></a><span id="l15.23">       if (msgHdr)</span>
<a href="#l15.24"></a><span id="l15.24">         rv = mDatabase-&gt;DeleteHeader(msgHdr, nullptr, true, true);</span>
<a href="#l15.25"></a><span id="l15.25">     }</span>
<a href="#l15.26"></a><span id="l15.26" class="difflineminus">-    EnableNotifications(allMessageCountNotifications, true, true);</span>
<a href="#l15.27"></a><span id="l15.27" class="difflineplus">+    EnableNotifications(allMessageCountNotifications, true);</span>
<a href="#l15.28"></a><span id="l15.28">   }</span>
<a href="#l15.29"></a><span id="l15.29">  </span>
<a href="#l15.30"></a><span id="l15.30">   if (!isMove) </span>
<a href="#l15.31"></a><span id="l15.31">     NotifyFolderEvent(NS_SUCCEEDED(rv) ? mDeleteOrMoveMsgCompletedAtom :</span>
<a href="#l15.32"></a><span id="l15.32">       mDeleteOrMoveMsgFailedAtom);</span>
<a href="#l15.33"></a><span id="l15.33"> </span>
<a href="#l15.34"></a><span id="l15.34">   (void) RefreshSizeOnDisk();</span>
<a href="#l15.35"></a><span id="l15.35"> </span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

