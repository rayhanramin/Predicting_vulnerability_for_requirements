<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 7382:711e23c7796083d2658220b5f385e560e192e1d1</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 711e23c7796083d2658220b5f385e560e192e1d1" />
<meta property="og:url" content="/comm-central/rev/711e23c7796083d2658220b5f385e560e192e1d1" />
<meta property="og:description" content="Bug 504122 - &quot;provide undo close tab&quot;. Patch v3. r=asuth" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 711e23c7796083d2658220b5f385e560e192e1d1 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/711e23c7796083d2658220b5f385e560e192e1d1">shortlog</a> |
<a href="/comm-central/log/711e23c7796083d2658220b5f385e560e192e1d1">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/711e23c7796083d2658220b5f385e560e192e1d1">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/711e23c7796083d2658220b5f385e560e192e1d1">files</a> |
changeset |
<a href="/comm-central/raw-rev/711e23c7796083d2658220b5f385e560e192e1d1">raw</a>  | <a href="/comm-central/archive/711e23c7796083d2658220b5f385e560e192e1d1.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=504122">Bug 504122</a> - &quot;provide undo close tab&quot;. Patch v3. r=asuth
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#84;&#104;&#111;&#109;&#97;&#115;&#32;&#83;&#99;&#104;&#109;&#105;&#100;&#32;&#60;&#115;&#99;&#104;&#109;&#105;&#100;&#45;&#116;&#104;&#111;&#109;&#97;&#115;&#64;&#103;&#109;&#120;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Sun, 20 Mar 2011 06:56:00 -0700</td></tr>

<tr>
 <td>changeset 7382</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/711e23c7796083d2658220b5f385e560e192e1d1">711e23c7796083d2658220b5f385e560e192e1d1</a></td>
</tr>



<tr>
<td>parent 7381</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/e7c212dc0f4e704d0400526e96eebbe8499d3104">e7c212dc0f4e704d0400526e96eebbe8499d3104</a>
</td>
</tr>

<tr>
<td>child 7383</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/635f55c596792d23cd57581aed6578f22df12949">635f55c596792d23cd57581aed6578f22df12949</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=711e23c7796083d2658220b5f385e560e192e1d1">5661</a></td></tr>
<tr><td>push user</td><td>bugmail@asutherland.org</td></tr>
<tr><td>push date</td><td class="date age">Mon, 21 Mar 2011 00:30:07 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@711e23c77960 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=711e23c7796083d2658220b5f385e560e192e1d1">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=711e23c7796083d2658220b5f385e560e192e1d1&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=711e23c7796083d2658220b5f385e560e192e1d1&newProject=comm-central&newRevision=711e23c7796083d2658220b5f385e560e192e1d1&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=711e23c7796083d2658220b5f385e560e192e1d1&newProject=comm-central&newRevision=711e23c7796083d2658220b5f385e560e192e1d1&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=711e23c7796083d2658220b5f385e560e192e1d1&newProject=comm-central&newRevision=711e23c7796083d2658220b5f385e560e192e1d1&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28asuth%29&revcount=50">asuth</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=504122">504122</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=504122">Bug 504122</a> - &quot;provide undo close tab&quot;. Patch v3. r=asuth</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/711e23c7796083d2658220b5f385e560e192e1d1/mail/base/content/mail3PaneWindowCommands.js">mail/base/content/mail3PaneWindowCommands.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/711e23c7796083d2658220b5f385e560e192e1d1/mail/base/content/mail3PaneWindowCommands.js">file</a> |
<a href="/comm-central/annotate/711e23c7796083d2658220b5f385e560e192e1d1/mail/base/content/mail3PaneWindowCommands.js">annotate</a> |
<a href="/comm-central/diff/711e23c7796083d2658220b5f385e560e192e1d1/mail/base/content/mail3PaneWindowCommands.js">diff</a> |
<a href="/comm-central/comparison/711e23c7796083d2658220b5f385e560e192e1d1/mail/base/content/mail3PaneWindowCommands.js">comparison</a> |
<a href="/comm-central/log/711e23c7796083d2658220b5f385e560e192e1d1/mail/base/content/mail3PaneWindowCommands.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/711e23c7796083d2658220b5f385e560e192e1d1/mail/base/content/mailWindowOverlay.js">mail/base/content/mailWindowOverlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/711e23c7796083d2658220b5f385e560e192e1d1/mail/base/content/mailWindowOverlay.js">file</a> |
<a href="/comm-central/annotate/711e23c7796083d2658220b5f385e560e192e1d1/mail/base/content/mailWindowOverlay.js">annotate</a> |
<a href="/comm-central/diff/711e23c7796083d2658220b5f385e560e192e1d1/mail/base/content/mailWindowOverlay.js">diff</a> |
<a href="/comm-central/comparison/711e23c7796083d2658220b5f385e560e192e1d1/mail/base/content/mailWindowOverlay.js">comparison</a> |
<a href="/comm-central/log/711e23c7796083d2658220b5f385e560e192e1d1/mail/base/content/mailWindowOverlay.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/711e23c7796083d2658220b5f385e560e192e1d1/mail/base/content/mailWindowOverlay.xul">mail/base/content/mailWindowOverlay.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/711e23c7796083d2658220b5f385e560e192e1d1/mail/base/content/mailWindowOverlay.xul">file</a> |
<a href="/comm-central/annotate/711e23c7796083d2658220b5f385e560e192e1d1/mail/base/content/mailWindowOverlay.xul">annotate</a> |
<a href="/comm-central/diff/711e23c7796083d2658220b5f385e560e192e1d1/mail/base/content/mailWindowOverlay.xul">diff</a> |
<a href="/comm-central/comparison/711e23c7796083d2658220b5f385e560e192e1d1/mail/base/content/mailWindowOverlay.xul">comparison</a> |
<a href="/comm-central/log/711e23c7796083d2658220b5f385e560e192e1d1/mail/base/content/mailWindowOverlay.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/711e23c7796083d2658220b5f385e560e192e1d1/mail/base/content/tabmail.xml">mail/base/content/tabmail.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/711e23c7796083d2658220b5f385e560e192e1d1/mail/base/content/tabmail.xml">file</a> |
<a href="/comm-central/annotate/711e23c7796083d2658220b5f385e560e192e1d1/mail/base/content/tabmail.xml">annotate</a> |
<a href="/comm-central/diff/711e23c7796083d2658220b5f385e560e192e1d1/mail/base/content/tabmail.xml">diff</a> |
<a href="/comm-central/comparison/711e23c7796083d2658220b5f385e560e192e1d1/mail/base/content/tabmail.xml">comparison</a> |
<a href="/comm-central/log/711e23c7796083d2658220b5f385e560e192e1d1/mail/base/content/tabmail.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/711e23c7796083d2658220b5f385e560e192e1d1/mail/locales/en-US/chrome/messenger/messenger.dtd">mail/locales/en-US/chrome/messenger/messenger.dtd</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/711e23c7796083d2658220b5f385e560e192e1d1/mail/locales/en-US/chrome/messenger/messenger.dtd">file</a> |
<a href="/comm-central/annotate/711e23c7796083d2658220b5f385e560e192e1d1/mail/locales/en-US/chrome/messenger/messenger.dtd">annotate</a> |
<a href="/comm-central/diff/711e23c7796083d2658220b5f385e560e192e1d1/mail/locales/en-US/chrome/messenger/messenger.dtd">diff</a> |
<a href="/comm-central/comparison/711e23c7796083d2658220b5f385e560e192e1d1/mail/locales/en-US/chrome/messenger/messenger.dtd">comparison</a> |
<a href="/comm-central/log/711e23c7796083d2658220b5f385e560e192e1d1/mail/locales/en-US/chrome/messenger/messenger.dtd">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/711e23c7796083d2658220b5f385e560e192e1d1/mail/locales/en-US/chrome/messenger/messenger.properties">mail/locales/en-US/chrome/messenger/messenger.properties</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/711e23c7796083d2658220b5f385e560e192e1d1/mail/locales/en-US/chrome/messenger/messenger.properties">file</a> |
<a href="/comm-central/annotate/711e23c7796083d2658220b5f385e560e192e1d1/mail/locales/en-US/chrome/messenger/messenger.properties">annotate</a> |
<a href="/comm-central/diff/711e23c7796083d2658220b5f385e560e192e1d1/mail/locales/en-US/chrome/messenger/messenger.properties">diff</a> |
<a href="/comm-central/comparison/711e23c7796083d2658220b5f385e560e192e1d1/mail/locales/en-US/chrome/messenger/messenger.properties">comparison</a> |
<a href="/comm-central/log/711e23c7796083d2658220b5f385e560e192e1d1/mail/locales/en-US/chrome/messenger/messenger.properties">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/711e23c7796083d2658220b5f385e560e192e1d1/mail/test/mozmill/tabmail/test-tabmail-dragndrop.js">mail/test/mozmill/tabmail/test-tabmail-dragndrop.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/711e23c7796083d2658220b5f385e560e192e1d1/mail/test/mozmill/tabmail/test-tabmail-dragndrop.js">file</a> |
<a href="/comm-central/annotate/711e23c7796083d2658220b5f385e560e192e1d1/mail/test/mozmill/tabmail/test-tabmail-dragndrop.js">annotate</a> |
<a href="/comm-central/diff/711e23c7796083d2658220b5f385e560e192e1d1/mail/test/mozmill/tabmail/test-tabmail-dragndrop.js">diff</a> |
<a href="/comm-central/comparison/711e23c7796083d2658220b5f385e560e192e1d1/mail/test/mozmill/tabmail/test-tabmail-dragndrop.js">comparison</a> |
<a href="/comm-central/log/711e23c7796083d2658220b5f385e560e192e1d1/mail/test/mozmill/tabmail/test-tabmail-dragndrop.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/base/content/mail3PaneWindowCommands.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/base/content/mail3PaneWindowCommands.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -169,16 +169,17 @@ var DefaultController =</span>
<a href="#l1.4"></a><span id="l1.4">       case &quot;cmd_previousMsg&quot;:</span>
<a href="#l1.5"></a><span id="l1.5">       case &quot;cmd_previousUnreadMsg&quot;:</span>
<a href="#l1.6"></a><span id="l1.6">       case &quot;cmd_previousFlaggedMsg&quot;:</span>
<a href="#l1.7"></a><span id="l1.7">       case &quot;button_goForward&quot;:</span>
<a href="#l1.8"></a><span id="l1.8">       case &quot;button_goBack&quot;:</span>
<a href="#l1.9"></a><span id="l1.9">       case &quot;cmd_goForward&quot;:</span>
<a href="#l1.10"></a><span id="l1.10">       case &quot;cmd_goBack&quot;:</span>
<a href="#l1.11"></a><span id="l1.11">       case &quot;cmd_goStartPage&quot;:</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+      case &quot;cmd_undoCloseTab&quot;:</span>
<a href="#l1.13"></a><span id="l1.13">       case &quot;cmd_viewClassicMailLayout&quot;:</span>
<a href="#l1.14"></a><span id="l1.14">       case &quot;cmd_viewWideMailLayout&quot;:</span>
<a href="#l1.15"></a><span id="l1.15">       case &quot;cmd_viewVerticalMailLayout&quot;:</span>
<a href="#l1.16"></a><span id="l1.16">       case &quot;cmd_toggleMessagePane&quot;:</span>
<a href="#l1.17"></a><span id="l1.17">       case &quot;cmd_viewAllMsgs&quot;:</span>
<a href="#l1.18"></a><span id="l1.18">       case &quot;cmd_viewUnreadMsgs&quot;:</span>
<a href="#l1.19"></a><span id="l1.19">       case &quot;cmd_viewThreadsWithUnread&quot;:</span>
<a href="#l1.20"></a><span id="l1.20">       case &quot;cmd_viewWatchedThreadsWithUnread&quot;:</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineat">@@ -423,16 +424,18 @@ var DefaultController =</span>
<a href="#l1.22"></a><span id="l1.22">       case &quot;cmd_goForward&quot;:</span>
<a href="#l1.23"></a><span id="l1.23">       case &quot;cmd_goBack&quot;:</span>
<a href="#l1.24"></a><span id="l1.24">         if (gDBView)</span>
<a href="#l1.25"></a><span id="l1.25">           enabled.value = gDBView.navigateStatus((command == &quot;cmd_goBack&quot; || command == &quot;button_goBack&quot;) ? nsMsgNavigationType.back : nsMsgNavigationType.forward);</span>
<a href="#l1.26"></a><span id="l1.26">         return enabled.value;</span>
<a href="#l1.27"></a><span id="l1.27">       case &quot;cmd_goStartPage&quot;:</span>
<a href="#l1.28"></a><span id="l1.28">         return document.getElementById(&quot;tabmail&quot;).selectedTab.mode.name == &quot;folder&quot; &amp;&amp;</span>
<a href="#l1.29"></a><span id="l1.29">                !IsMessagePaneCollapsed();</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineplus">+      case &quot;cmd_undoCloseTab&quot;:</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineplus">+        return (document.getElementById(&quot;tabmail&quot;).recentlyClosedTabs.length &gt; 0);               </span>
<a href="#l1.32"></a><span id="l1.32">       case &quot;cmd_markAllRead&quot;:</span>
<a href="#l1.33"></a><span id="l1.33">       case &quot;cmd_markReadByDate&quot;:</span>
<a href="#l1.34"></a><span id="l1.34">         return IsFolderSelected();</span>
<a href="#l1.35"></a><span id="l1.35">       case &quot;cmd_find&quot;:</span>
<a href="#l1.36"></a><span id="l1.36">       case &quot;cmd_findAgain&quot;:</span>
<a href="#l1.37"></a><span id="l1.37">       case &quot;cmd_findPrevious&quot;:</span>
<a href="#l1.38"></a><span id="l1.38">         // If we are a message tab, then we've got a message displayed, so</span>
<a href="#l1.39"></a><span id="l1.39">         // always allow searching in the message</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineat">@@ -679,16 +682,19 @@ var DefaultController =</span>
<a href="#l1.41"></a><span id="l1.41">       case &quot;button_goBack&quot;:</span>
<a href="#l1.42"></a><span id="l1.42">       case &quot;cmd_goBack&quot;:</span>
<a href="#l1.43"></a><span id="l1.43">         GoNextMessage(nsMsgNavigationType.back, true);</span>
<a href="#l1.44"></a><span id="l1.44">         break;</span>
<a href="#l1.45"></a><span id="l1.45">       case &quot;cmd_goStartPage&quot;:</span>
<a href="#l1.46"></a><span id="l1.46">         HideMessageHeaderPane();</span>
<a href="#l1.47"></a><span id="l1.47">         loadStartPage(true);</span>
<a href="#l1.48"></a><span id="l1.48">         break;</span>
<a href="#l1.49"></a><span id="l1.49" class="difflineplus">+      case &quot;cmd_undoCloseTab&quot;:</span>
<a href="#l1.50"></a><span id="l1.50" class="difflineplus">+        document.getElementById(&quot;tabmail&quot;).undoCloseTab();</span>
<a href="#l1.51"></a><span id="l1.51" class="difflineplus">+        break;</span>
<a href="#l1.52"></a><span id="l1.52">       case &quot;cmd_viewClassicMailLayout&quot;:</span>
<a href="#l1.53"></a><span id="l1.53">       case &quot;cmd_viewWideMailLayout&quot;:</span>
<a href="#l1.54"></a><span id="l1.54">       case &quot;cmd_viewVerticalMailLayout&quot;:</span>
<a href="#l1.55"></a><span id="l1.55">         ChangeMailLayoutForCommand(command);</span>
<a href="#l1.56"></a><span id="l1.56">         break;</span>
<a href="#l1.57"></a><span id="l1.57">       case &quot;cmd_toggleMessagePane&quot;:</span>
<a href="#l1.58"></a><span id="l1.58">         MsgToggleMessagePane();</span>
<a href="#l1.59"></a><span id="l1.59">         break;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/base/content/mailWindowOverlay.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/base/content/mailWindowOverlay.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -698,16 +698,64 @@ function InitMessageTags(menuPopup)</span>
<a href="#l2.4"></a><span id="l2.4">     newMenuItem.setAttribute('oncommand', 'ToggleMessageTagMenu(event.target);');</span>
<a href="#l2.5"></a><span id="l2.5">     var color = taginfo.color;</span>
<a href="#l2.6"></a><span id="l2.6">     if (color)</span>
<a href="#l2.7"></a><span id="l2.7">       newMenuItem.setAttribute(&quot;class&quot;, &quot;lc-&quot; + color.substr(1));</span>
<a href="#l2.8"></a><span id="l2.8">     menuPopup.appendChild(newMenuItem);</span>
<a href="#l2.9"></a><span id="l2.9">   }</span>
<a href="#l2.10"></a><span id="l2.10"> }</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+function InitRecentlyClosedTabsPopup(menuPopup)</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+{</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+  let tabs = document.getElementById(&quot;tabmail&quot;).recentlyClosedTabs;</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+  // show Popup only when there are restorable tabs.</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineplus">+  if( !tabs.length )</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineplus">+    return false;</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineplus">+</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineplus">+  // Clear the list before rebulding it.     </span>
<a href="#l2.21"></a><span id="l2.21" class="difflineplus">+  while (menuPopup.childNodes.length &gt; 0)</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineplus">+    menuPopup.removeChild(menuPopup.firstChild);</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineplus">+    </span>
<a href="#l2.24"></a><span id="l2.24" class="difflineplus">+  // Rebuild the recently closed tab list</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineplus">+  for (let i = 0; i &lt; tabs.length; i++ ) {</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineplus">+    </span>
<a href="#l2.27"></a><span id="l2.27" class="difflineplus">+    let menuItem = document.createElement(&quot;menuitem&quot;);</span>
<a href="#l2.28"></a><span id="l2.28" class="difflineplus">+    menuItem.setAttribute(&quot;label&quot;,tabs[i].title);    </span>
<a href="#l2.29"></a><span id="l2.29" class="difflineplus">+    menuItem.setAttribute('oncommand',</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineplus">+        'document.getElementById(&quot;tabmail&quot;).undoCloseTab('+i+');');</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineplus">+     </span>
<a href="#l2.32"></a><span id="l2.32" class="difflineplus">+    if (i==0)</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineplus">+      menuItem.setAttribute('key',&quot;key_undoCloseTab&quot;);</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineplus">+     </span>
<a href="#l2.35"></a><span id="l2.35" class="difflineplus">+    menuPopup.appendChild(menuItem);</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineplus">+  }</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineplus">+  </span>
<a href="#l2.38"></a><span id="l2.38" class="difflineplus">+  // &quot;Restore All Tabs&quot; with only one entry does not make sense </span>
<a href="#l2.39"></a><span id="l2.39" class="difflineplus">+  if (tabs.length &lt;= 1)</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineplus">+    return;</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineplus">+  </span>
<a href="#l2.42"></a><span id="l2.42" class="difflineplus">+  menuPopup.appendChild(document.createElement(&quot;menuseparator&quot;));</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineplus">+  </span>
<a href="#l2.44"></a><span id="l2.44" class="difflineplus">+  let menuItem = document.createElement(&quot;menuitem&quot;);</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineplus">+  menuItem.setAttribute(&quot;label&quot;,gMessengerBundle.getString(&quot;restoreAllTabs&quot;));</span>
<a href="#l2.46"></a><span id="l2.46" class="difflineplus">+  menuItem.setAttribute(&quot;oncommand&quot;,&quot;goRestoreAllTabs();&quot;);</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineplus">+  menuPopup.appendChild(menuItem);</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineplus">+}</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineplus">+</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineplus">+function goRestoreAllTabs()</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineplus">+{</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineplus">+  let tabmail = document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineplus">+  </span>
<a href="#l2.54"></a><span id="l2.54" class="difflineplus">+  let len = tabmail.recentlyClosedTabs.length;</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineplus">+  </span>
<a href="#l2.56"></a><span id="l2.56" class="difflineplus">+  while(len--)</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineplus">+    document.getElementById(&quot;tabmail&quot;).undoCloseTab();</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineplus">+}</span>
<a href="#l2.59"></a><span id="l2.59" class="difflineplus">+</span>
<a href="#l2.60"></a><span id="l2.60"> function backToolbarMenu_init(menuPopup)</span>
<a href="#l2.61"></a><span id="l2.61"> {</span>
<a href="#l2.62"></a><span id="l2.62">   populateHistoryMenu(menuPopup, true);</span>
<a href="#l2.63"></a><span id="l2.63"> }</span>
<a href="#l2.64"></a><span id="l2.64"> </span>
<a href="#l2.65"></a><span id="l2.65"> function getMsgToolbarMenu_init()</span>
<a href="#l2.66"></a><span id="l2.66"> {</span>
<a href="#l2.67"></a><span id="l2.67">   document.commandDispatcher.updateCommands('create-menu-getMsgToolbar');</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/base/content/mailWindowOverlay.xul</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/base/content/mailWindowOverlay.xul</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -234,16 +234,17 @@</span>
<a href="#l3.4"></a><span id="l3.4">   &lt;command id=&quot;cmd_nextMsg&quot; oncommand=&quot;goDoCommand('cmd_nextMsg')&quot; disabled=&quot;true&quot;/&gt;</span>
<a href="#l3.5"></a><span id="l3.5">   &lt;command id=&quot;cmd_nextUnreadMsg&quot; oncommand=&quot;goDoCommand('cmd_nextUnreadMsg')&quot; disabled=&quot;true&quot;/&gt;</span>
<a href="#l3.6"></a><span id="l3.6">   &lt;command id=&quot;cmd_nextFlaggedMsg&quot; oncommand=&quot;goDoCommand('cmd_nextFlaggedMsg')&quot; disabled=&quot;true&quot;/&gt;</span>
<a href="#l3.7"></a><span id="l3.7">   &lt;command id=&quot;cmd_nextUnreadThread&quot; oncommand=&quot;goDoCommand('cmd_nextUnreadThread')&quot; disabled=&quot;true&quot;/&gt;</span>
<a href="#l3.8"></a><span id="l3.8">   &lt;command id=&quot;cmd_previousMsg&quot; oncommand=&quot;goDoCommand('cmd_previousMsg')&quot; disabled=&quot;true&quot;/&gt;</span>
<a href="#l3.9"></a><span id="l3.9">   &lt;command id=&quot;cmd_previousUnreadMsg&quot; oncommand=&quot;goDoCommand('cmd_previousUnreadMsg')&quot; disabled=&quot;true&quot;/&gt;</span>
<a href="#l3.10"></a><span id="l3.10">   &lt;command id=&quot;cmd_previousFlaggedMsg&quot; oncommand=&quot;goDoCommand('cmd_previousFlaggedMsg')&quot; disabled=&quot;true&quot;/&gt;</span>
<a href="#l3.11"></a><span id="l3.11">   &lt;command id=&quot;cmd_goStartPage&quot; oncommand=&quot;goDoCommand('cmd_goStartPage');&quot;/&gt;</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+  &lt;command id=&quot;cmd_undoCloseTab&quot; oncommand=&quot;goDoCommand('cmd_undoCloseTab');&quot;/&gt; </span>
<a href="#l3.13"></a><span id="l3.13">   &lt;command id=&quot;cmd_goForward&quot; oncommand=&quot;goDoCommand('cmd_goForward')&quot; disabled=&quot;true&quot;/&gt;</span>
<a href="#l3.14"></a><span id="l3.14">   &lt;command id=&quot;cmd_goBack&quot; oncommand=&quot;goDoCommand('cmd_goBack')&quot; disabled=&quot;true&quot;/&gt;</span>
<a href="#l3.15"></a><span id="l3.15"> &lt;/commandset&gt;</span>
<a href="#l3.16"></a><span id="l3.16"> </span>
<a href="#l3.17"></a><span id="l3.17"> &lt;commandset id=&quot;mailMessageMenuItems&quot;</span>
<a href="#l3.18"></a><span id="l3.18">             commandupdater=&quot;true&quot;</span>
<a href="#l3.19"></a><span id="l3.19">             events=&quot;create-menu-message&quot;</span>
<a href="#l3.20"></a><span id="l3.20">             oncommandupdate=&quot;goUpdateMailMenuItems(this)&quot;&gt;</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineat">@@ -404,16 +405,17 @@</span>
<a href="#l3.22"></a><span id="l3.22">   &lt;key key=&quot;&amp;collapseAllThreadsCmd.key;&quot; modifiers=&quot;shift&quot;           oncommand=&quot;goDoCommand('cmd_collapseAllThreads')&quot;/&gt;</span>
<a href="#l3.23"></a><span id="l3.23">   &lt;key id=&quot;key_nextUnreadThread&quot; key=&quot;&amp;nextUnreadThread.key;&quot;        oncommand=&quot;goDoCommand('cmd_nextUnreadThread')&quot;/&gt;</span>
<a href="#l3.24"></a><span id="l3.24">   &lt;key id=&quot;key_previousMsg&quot; key=&quot;&amp;prevMsgCmd.key;&quot;                   oncommand=&quot;goDoCommand('cmd_previousMsg')&quot;/&gt;</span>
<a href="#l3.25"></a><span id="l3.25">   &lt;key id=&quot;key_previousUnreadMsg&quot; key=&quot;&amp;prevUnreadMsgCmd.key;&quot;       oncommand=&quot;goDoCommand('cmd_previousUnreadMsg')&quot;/&gt;</span>
<a href="#l3.26"></a><span id="l3.26">   &lt;key id=&quot;key_archive&quot; key=&quot;&amp;archiveMsgCmd.key;&quot;                    oncommand=&quot;goDoCommand('cmd_archive')&quot;/&gt;</span>
<a href="#l3.27"></a><span id="l3.27">   &lt;key id=&quot;key_goForward&quot; key=&quot;&amp;goForwardCmd.commandKey;&quot;            oncommand=&quot;goDoCommand('cmd_goForward')&quot;/&gt;</span>
<a href="#l3.28"></a><span id="l3.28">   &lt;key id=&quot;key_goBack&quot; key=&quot;&amp;goBackCmd.commandKey;&quot;                  oncommand=&quot;goDoCommand('cmd_goBack')&quot;/&gt;</span>
<a href="#l3.29"></a><span id="l3.29">   &lt;key id=&quot;key_goStartPage&quot; keycode=&quot;VK_HOME&quot;                        oncommand=&quot;goDoCommand('cmd_goStartPage')&quot; modifiers=&quot;alt&quot;/&gt;</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineplus">+  &lt;key id=&quot;key_undoCloseTab&quot; key=&quot;&amp;undoCloseTabCmd.commandkey;&quot;      oncommand=&quot;goDoCommand('cmd_undoCloseTab')&quot; modifiers=&quot;accel, shift&quot;/&gt; </span>
<a href="#l3.31"></a><span id="l3.31">   &lt;key id=&quot;key_reply&quot; key=&quot;&amp;replyMsgCmd.key;&quot;                        oncommand=&quot;goDoCommand('cmd_reply')&quot; modifiers=&quot;accel&quot;/&gt;</span>
<a href="#l3.32"></a><span id="l3.32">   &lt;key id=&quot;key_replyall&quot; key=&quot;&amp;replyToAllMsgCmd.key;&quot;                oncommand=&quot;goDoCommand('cmd_replyall')&quot; modifiers=&quot;accel, shift&quot;/&gt;</span>
<a href="#l3.33"></a><span id="l3.33">   &lt;key id=&quot;key_replylist&quot; key=&quot;&amp;replyToListMsgCmd.key;&quot;              oncommand=&quot;goDoCommand('cmd_replylist')&quot; modifiers=&quot;accel, shift&quot;/&gt;</span>
<a href="#l3.34"></a><span id="l3.34">   &lt;key id=&quot;key_forward&quot; key=&quot;&amp;forwardMsgCmd.key;&quot;                    oncommand=&quot;goDoCommand('cmd_forward')&quot; modifiers=&quot;accel&quot;/&gt;</span>
<a href="#l3.35"></a><span id="l3.35">   &lt;key id=&quot;key_editAsNew&quot; key=&quot;&amp;editMsgAsNewCmd.key;&quot;                oncommand=&quot;goDoCommand('cmd_editAsNew')&quot; modifiers=&quot;accel&quot;/&gt;</span>
<a href="#l3.36"></a><span id="l3.36">   &lt;key id=&quot;key_watchThread&quot; key=&quot;&amp;watchThreadMenu.key;&quot;              oncommand=&quot;goDoCommand('cmd_watchThread')&quot; /&gt;</span>
<a href="#l3.37"></a><span id="l3.37">   &lt;key id=&quot;key_killThread&quot; key=&quot;&amp;killThreadMenu.key;&quot;                oncommand=&quot;goDoCommand('cmd_killThread')&quot; /&gt;</span>
<a href="#l3.38"></a><span id="l3.38">   &lt;key id=&quot;key_killSubthread&quot; key=&quot;&amp;killSubthreadMenu.key;&quot;          oncommand=&quot;goDoCommand('cmd_killSubthread')&quot; modifiers=&quot;shift&quot; /&gt;</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineat">@@ -1391,16 +1393,24 @@</span>
<a href="#l3.40"></a><span id="l3.40">                        showFileHereLabel=&quot;true&quot;</span>
<a href="#l3.41"></a><span id="l3.41">                        fileHereLabel=&quot;&amp;thisFolder.label;&quot;</span>
<a href="#l3.42"></a><span id="l3.42">                        fileHereAccessKey=&quot;&amp;thisFolder.accesskey;&quot;</span>
<a href="#l3.43"></a><span id="l3.43">                        showRecent=&quot;true&quot;</span>
<a href="#l3.44"></a><span id="l3.44">                        recentLabel=&quot;&amp;contextMoveCopyMsgRecentMenu.label;&quot;</span>
<a href="#l3.45"></a><span id="l3.45">                        recentAccessKey=&quot;&amp;contextMoveCopyMsgRecentMenu.accesskey;&quot;/&gt;</span>
<a href="#l3.46"></a><span id="l3.46">           &lt;/menu&gt;</span>
<a href="#l3.47"></a><span id="l3.47">           &lt;menuseparator id=&quot;goFolderSeparator&quot;/&gt;</span>
<a href="#l3.48"></a><span id="l3.48" class="difflineplus">+          </span>
<a href="#l3.49"></a><span id="l3.49" class="difflineplus">+          &lt;menu id=&quot;goRecentlyClosedTabs&quot;</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineplus">+                label=&quot;&amp;goRecentlyClosedTabs.label;&quot;&gt;</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineplus">+            &lt;menupopup id=&quot;menu_GoRecentlyClosedTabsPopup&quot;</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineplus">+                       onpopupshowing=&quot;return InitRecentlyClosedTabsPopup(this)&quot; /&gt;</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineplus">+          &lt;/menu&gt;</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineplus">+          &lt;menuseparator id=&quot;goRecentlyClosedTabsSeparator&quot;/&gt;</span>
<a href="#l3.55"></a><span id="l3.55" class="difflineplus">+               </span>
<a href="#l3.56"></a><span id="l3.56">           &lt;menuitem id=&quot;goStartPage&quot;</span>
<a href="#l3.57"></a><span id="l3.57">                     label=&quot;&amp;startPageCmd.label;&quot;</span>
<a href="#l3.58"></a><span id="l3.58">                     accesskey=&quot;&amp;startPageCmd.accesskey;&quot;</span>
<a href="#l3.59"></a><span id="l3.59">                     command=&quot;cmd_goStartPage&quot;</span>
<a href="#l3.60"></a><span id="l3.60">                     key=&quot;key_goStartPage&quot;/&gt;</span>
<a href="#l3.61"></a><span id="l3.61">         &lt;/menupopup&gt;</span>
<a href="#l3.62"></a><span id="l3.62">         &lt;/menu&gt;</span>
<a href="#l3.63"></a><span id="l3.63"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mail/base/content/tabmail.xml</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mail/base/content/tabmail.xml</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -314,20 +314,21 @@</span>
<a href="#l4.4"></a><span id="l4.4">             </span>
<a href="#l4.5"></a><span id="l4.5">             &lt;xul:menuitem label=&quot;&amp;closeOtherTabsCmd2.label;&quot; </span>
<a href="#l4.6"></a><span id="l4.6">                           accesskey=&quot;&amp;closeOtherTabsCmd2.accesskey;&quot;</span>
<a href="#l4.7"></a><span id="l4.7">                           anonid=&quot;closeOtherTabs&quot;</span>
<a href="#l4.8"></a><span id="l4.8">                           oncommand=&quot;document.getElementById('tabmail').closeOtherTabs(document.popupNode);&quot;/&gt;</span>
<a href="#l4.9"></a><span id="l4.9">                                                  </span>
<a href="#l4.10"></a><span id="l4.10">             &lt;xul:menuseparator /&gt;</span>
<a href="#l4.11"></a><span id="l4.11">             </span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-            &lt;xul:menuitem label=&quot;&amp;undoCloseTabCmd.label;&quot;</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-                          accesskey=&quot;&amp;undoCloseTabCmd.accesskey;&quot;</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineminus">-                          anonid=&quot;undoCloseTab&quot;</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineminus">-                          oncommand=&quot;document.getElementById('tabmail').undoCloseTab();&quot;/&gt;</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineplus">+            &lt;xul:menu label=&quot;&amp;recentlyClosedTabsCmd.label;&quot;</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineplus">+                      accesskey=&quot;&amp;recentlyClosedTabsCmd.accesskey;&quot;</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineplus">+                      anonid=&quot;recentlyClosedTabs&quot; &gt;</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineplus">+              &lt;xul:menupopup onpopupshowing=&quot;return InitRecentlyClosedTabsPopup(this);&quot; /&gt;</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineplus">+            &lt;/xul:menu&gt;</span>
<a href="#l4.21"></a><span id="l4.21">                                                                          </span>
<a href="#l4.22"></a><span id="l4.22">             &lt;xul:menuitem label=&quot;&amp;closeTabCmd2.label;&quot; </span>
<a href="#l4.23"></a><span id="l4.23">                           accesskey=&quot;&amp;closeTabCmd2.accesskey;&quot;</span>
<a href="#l4.24"></a><span id="l4.24">                           anonid=&quot;closeTab&quot;</span>
<a href="#l4.25"></a><span id="l4.25">                           oncommand=&quot;document.getElementById('tabmail').closeTab(document.popupNode);&quot;/&gt;</span>
<a href="#l4.26"></a><span id="l4.26">                                                                           </span>
<a href="#l4.27"></a><span id="l4.27">           &lt;/xul:menupopup&gt;</span>
<a href="#l4.28"></a><span id="l4.28">           &lt;xul:tabs class=&quot;tabmail-tabs&quot; flex=&quot;1&quot;</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineat">@@ -344,17 +345,16 @@</span>
<a href="#l4.30"></a><span id="l4.30">         &lt;children includes=&quot;tabpanels&quot;/&gt;</span>
<a href="#l4.31"></a><span id="l4.31">       &lt;/xul:tabbox&gt;</span>
<a href="#l4.32"></a><span id="l4.32">     &lt;/content&gt;</span>
<a href="#l4.33"></a><span id="l4.33"> </span>
<a href="#l4.34"></a><span id="l4.34">     &lt;implementation implements=&quot;nsIController&quot;&gt;</span>
<a href="#l4.35"></a><span id="l4.35">       &lt;constructor&gt;</span>
<a href="#l4.36"></a><span id="l4.36">         window.controllers.insertControllerAt(0, this);</span>
<a href="#l4.37"></a><span id="l4.37">         this._restoringTabState = null;</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineminus">-        this._tabUndo = [];</span>
<a href="#l4.39"></a><span id="l4.39">       &lt;/constructor&gt;</span>
<a href="#l4.40"></a><span id="l4.40">       &lt;destructor&gt;</span>
<a href="#l4.41"></a><span id="l4.41">         window.controllers.removeController(this);</span>
<a href="#l4.42"></a><span id="l4.42">       &lt;/destructor&gt;</span>
<a href="#l4.43"></a><span id="l4.43">       &lt;field name=&quot;currentTabInfo&quot;&gt;</span>
<a href="#l4.44"></a><span id="l4.44">         null</span>
<a href="#l4.45"></a><span id="l4.45">       &lt;/field&gt;</span>
<a href="#l4.46"></a><span id="l4.46">       &lt;!-- Temporary field that only has a non-null value during a call to</span>
<a href="#l4.47"></a><span id="l4.47" class="difflineat">@@ -382,16 +382,19 @@</span>
<a href="#l4.48"></a><span id="l4.48">         document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;tabcontainer&quot;);</span>
<a href="#l4.49"></a><span id="l4.49">       &lt;/field&gt;</span>
<a href="#l4.50"></a><span id="l4.50">       &lt;field name=&quot;panelContainer&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l4.51"></a><span id="l4.51">         document.getElementById(this.getAttribute(&quot;panelcontainer&quot;));</span>
<a href="#l4.52"></a><span id="l4.52">       &lt;/field&gt;</span>
<a href="#l4.53"></a><span id="l4.53">       &lt;field name=&quot;tabMonitors&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l4.54"></a><span id="l4.54">         new Array()</span>
<a href="#l4.55"></a><span id="l4.55">       &lt;/field&gt;</span>
<a href="#l4.56"></a><span id="l4.56" class="difflineplus">+      &lt;field name=&quot;recentlyClosedTabs&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l4.57"></a><span id="l4.57" class="difflineplus">+        new Array();</span>
<a href="#l4.58"></a><span id="l4.58" class="difflineplus">+      &lt;/field&gt;      </span>
<a href="#l4.59"></a><span id="l4.59">       &lt;method name=&quot;registerTabType&quot;&gt;</span>
<a href="#l4.60"></a><span id="l4.60">         &lt;parameter name=&quot;aTabType&quot;/&gt;</span>
<a href="#l4.61"></a><span id="l4.61">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l4.62"></a><span id="l4.62">           if (aTabType.name in this.tabTypes)</span>
<a href="#l4.63"></a><span id="l4.63">             return;</span>
<a href="#l4.64"></a><span id="l4.64">         </span>
<a href="#l4.65"></a><span id="l4.65">           this.tabTypes[aTabType.name] = aTabType;</span>
<a href="#l4.66"></a><span id="l4.66">           for (let [modeName, modeDetails] in Iterator(aTabType.modes)) {</span>
<a href="#l4.67"></a><span id="l4.67" class="difflineat">@@ -668,18 +671,27 @@</span>
<a href="#l4.68"></a><span id="l4.68">             return tabToConsider;</span>
<a href="#l4.69"></a><span id="l4.69">           else if (aTabMode.tabs.length)</span>
<a href="#l4.70"></a><span id="l4.70">             return aTabMode.tabs[0];</span>
<a href="#l4.71"></a><span id="l4.71">           else</span>
<a href="#l4.72"></a><span id="l4.72">             return null;</span>
<a href="#l4.73"></a><span id="l4.73">         ]]&gt;&lt;/body&gt;</span>
<a href="#l4.74"></a><span id="l4.74">       &lt;/method&gt;</span>
<a href="#l4.75"></a><span id="l4.75">       &lt;method name=&quot;undoCloseTab&quot;&gt;</span>
<a href="#l4.76"></a><span id="l4.76" class="difflineplus">+        &lt;parameter name=&quot;aIdx&quot;/&gt;</span>
<a href="#l4.77"></a><span id="l4.77">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l4.78"></a><span id="l4.78" class="difflineminus">-          let history = this._tabUndo.pop();</span>
<a href="#l4.79"></a><span id="l4.79" class="difflineplus">+            </span>
<a href="#l4.80"></a><span id="l4.80" class="difflineplus">+          if (!this.recentlyClosedTabs.length)</span>
<a href="#l4.81"></a><span id="l4.81" class="difflineplus">+            return;</span>
<a href="#l4.82"></a><span id="l4.82" class="difflineplus">+        </span>
<a href="#l4.83"></a><span id="l4.83" class="difflineplus">+          if (aIdx &gt;= this.recentlyClosedTabs.length)</span>
<a href="#l4.84"></a><span id="l4.84" class="difflineplus">+            aIdx = this.recentlyClosedTabs.length-1;</span>
<a href="#l4.85"></a><span id="l4.85" class="difflineplus">+</span>
<a href="#l4.86"></a><span id="l4.86" class="difflineplus">+          // splice always returns an array </span>
<a href="#l4.87"></a><span id="l4.87" class="difflineplus">+          let history = (this.recentlyClosedTabs.splice(aIdx,1))[0];</span>
<a href="#l4.88"></a><span id="l4.88">           </span>
<a href="#l4.89"></a><span id="l4.89">           if (!history.tab)</span>
<a href="#l4.90"></a><span id="l4.90">             return;</span>
<a href="#l4.91"></a><span id="l4.91"> </span>
<a href="#l4.92"></a><span id="l4.92">           if (!this.restoreTab(JSON.parse(history.tab)))</span>
<a href="#l4.93"></a><span id="l4.93">             return;</span>
<a href="#l4.94"></a><span id="l4.94">           </span>
<a href="#l4.95"></a><span id="l4.95">           let idx = Math.min(history.idx,this.tabInfo.length);          </span>
<a href="#l4.96"></a><span id="l4.96" class="difflineat">@@ -706,21 +718,22 @@</span>
<a href="#l4.97"></a><span id="l4.97">                 tabMonitor.onTabClosing(tab);</span>
<a href="#l4.98"></a><span id="l4.98">             }</span>
<a href="#l4.99"></a><span id="l4.99"> </span>
<a href="#l4.100"></a><span id="l4.100">             if (!aNoUndo) {</span>
<a href="#l4.101"></a><span id="l4.101">               // Allow user to undo accidentially closed tabs</span>
<a href="#l4.102"></a><span id="l4.102">               let session = this.persistTab(tab);</span>
<a href="#l4.103"></a><span id="l4.103"> </span>
<a href="#l4.104"></a><span id="l4.104">               if (session) {</span>
<a href="#l4.105"></a><span id="l4.105" class="difflineminus">-                this._tabUndo.push(</span>
<a href="#l4.106"></a><span id="l4.106" class="difflineminus">-                    { tab: JSON.stringify(session), idx: iTab } );</span>
<a href="#l4.107"></a><span id="l4.107" class="difflineplus">+              </span>
<a href="#l4.108"></a><span id="l4.108" class="difflineplus">+                this.recentlyClosedTabs.unshift(</span>
<a href="#l4.109"></a><span id="l4.109" class="difflineplus">+                  { tab: JSON.stringify(session), idx: iTab, title: tab.title });</span>
<a href="#l4.110"></a><span id="l4.110"> </span>
<a href="#l4.111"></a><span id="l4.111" class="difflineminus">-                if (this._tabUndo.length &gt; 10)</span>
<a href="#l4.112"></a><span id="l4.112" class="difflineminus">-                  this._tabUndo.shift();    </span>
<a href="#l4.113"></a><span id="l4.113" class="difflineplus">+                if (this.recentlyClosedTabs.length &gt; 10)</span>
<a href="#l4.114"></a><span id="l4.114" class="difflineplus">+                  this.recentlyClosedTabs.pop();    </span>
<a href="#l4.115"></a><span id="l4.115">               }</span>
<a href="#l4.116"></a><span id="l4.116">             }</span>
<a href="#l4.117"></a><span id="l4.117">             </span>
<a href="#l4.118"></a><span id="l4.118">             let closeFunc = tab.mode.closeTab || tab.mode.tabType.closeTab;</span>
<a href="#l4.119"></a><span id="l4.119">             closeFunc.call(tab.mode.tabType, tab);</span>
<a href="#l4.120"></a><span id="l4.120">              </span>
<a href="#l4.121"></a><span id="l4.121">             this.tabInfo.splice(iTab, 1);</span>
<a href="#l4.122"></a><span id="l4.122">             tab.mode.tabs.splice(tab.mode.tabs.indexOf(tab), 1);</span>
<a href="#l4.123"></a><span id="l4.123" class="difflineat">@@ -1322,19 +1335,19 @@</span>
<a href="#l4.124"></a><span id="l4.124">             // ... while moving it to a new window.</span>
<a href="#l4.125"></a><span id="l4.125">             document</span>
<a href="#l4.126"></a><span id="l4.126">               .getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;openTabInWindow&quot;)</span>
<a href="#l4.127"></a><span id="l4.127">               .setAttribute(&quot;disabled&quot;, </span>
<a href="#l4.128"></a><span id="l4.128">                   (tab.canClose &amp;&amp; this.persistTab(tab)) ? &quot;false&quot; : &quot;true&quot;)</span>
<a href="#l4.129"></a><span id="l4.129"> </span>
<a href="#l4.130"></a><span id="l4.130">             // If the tab history is empty, disable &quot;Undo Close Tab&quot;</span>
<a href="#l4.131"></a><span id="l4.131">             document</span>
<a href="#l4.132"></a><span id="l4.132" class="difflineminus">-              .getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;undoCloseTab&quot;)</span>
<a href="#l4.133"></a><span id="l4.133" class="difflineplus">+              .getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;recentlyClosedTabs&quot;)</span>
<a href="#l4.134"></a><span id="l4.134">               .setAttribute(&quot;disabled&quot;,</span>
<a href="#l4.135"></a><span id="l4.135" class="difflineminus">-                  (this._tabUndo.length) ? &quot;false&quot; : &quot;true&quot;);</span>
<a href="#l4.136"></a><span id="l4.136" class="difflineplus">+                  (this.recentlyClosedTabs.length) ? &quot;false&quot; : &quot;true&quot;);</span>
<a href="#l4.137"></a><span id="l4.137">                           </span>
<a href="#l4.138"></a><span id="l4.138">             return true;</span>
<a href="#l4.139"></a><span id="l4.139">           ]]&gt;</span>
<a href="#l4.140"></a><span id="l4.140">         &lt;/body&gt;</span>
<a href="#l4.141"></a><span id="l4.141">       &lt;/method&gt;</span>
<a href="#l4.142"></a><span id="l4.142">       &lt;method name=&quot;supportsCommand&quot;&gt;</span>
<a href="#l4.143"></a><span id="l4.143">         &lt;parameter name=&quot;aCommand&quot;/&gt;</span>
<a href="#l4.144"></a><span id="l4.144">         &lt;body&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mail/locales/en-US/chrome/messenger/messenger.dtd</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mail/locales/en-US/chrome/messenger/messenger.dtd</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -7,18 +7,20 @@</span>
<a href="#l5.4"></a><span id="l5.4"> &lt;!ENTITY newFolderCmd.accesskey &quot;F&quot;&gt;</span>
<a href="#l5.5"></a><span id="l5.5"> &lt;!ENTITY closeTabCmd2.label &quot;Close Tab&quot;&gt;</span>
<a href="#l5.6"></a><span id="l5.6"> &lt;!ENTITY closeTabCmd2.accesskey &quot;C&quot;&gt;</span>
<a href="#l5.7"></a><span id="l5.7"> &lt;!ENTITY closeOtherTabsCmd2.label &quot;Close Other Tabs&quot;&gt;</span>
<a href="#l5.8"></a><span id="l5.8"> &lt;!ENTITY closeOtherTabsCmd2.accesskey &quot;o&quot;&gt;</span>
<a href="#l5.9"></a><span id="l5.9"> &lt;!-- LOCALIZATION NOTE (undoCloseTabCmd.label):</span>
<a href="#l5.10"></a><span id="l5.10">      Menu option to attempt to re-open a recently closed tab.</span>
<a href="#l5.11"></a><span id="l5.11">      --&gt;</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-&lt;!ENTITY undoCloseTabCmd.label &quot;Undo Close Tab&quot;&gt;</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineminus">-&lt;!ENTITY undoCloseTabCmd.accesskey &quot;U&quot;&gt;</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+&lt;!ENTITY recentlyClosedTabsCmd.label &quot;Recently Closed Tabs&quot;&gt;</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineplus">+&lt;!ENTITY recentlyClosedTabsCmd.accesskey &quot;R&quot;&gt;</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineplus">+</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineplus">+&lt;!ENTITY undoCloseTabCmd.commandkey &quot;T&quot;&gt;</span>
<a href="#l5.18"></a><span id="l5.18"> &lt;!-- LOCALIZATION NOTE (moveToNewWindow.label):</span>
<a href="#l5.19"></a><span id="l5.19">      Menu option to cause the current tab to be migrated to a new Thunderbird</span>
<a href="#l5.20"></a><span id="l5.20">      window.</span>
<a href="#l5.21"></a><span id="l5.21">      --&gt;</span>
<a href="#l5.22"></a><span id="l5.22"> &lt;!ENTITY moveToNewWindow.label &quot;Move to New Window&quot;&gt;</span>
<a href="#l5.23"></a><span id="l5.23"> &lt;!ENTITY moveToNewWindow.accesskey &quot;W&quot;&gt;</span>
<a href="#l5.24"></a><span id="l5.24"> &lt;!ENTITY newVirtualFolderCmd.label &quot;Saved Search&quot;&gt;</span>
<a href="#l5.25"></a><span id="l5.25"> &lt;!ENTITY newVirtualFolderCmd.accesskey &quot;S&quot;&gt;</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineat">@@ -319,16 +321,17 @@ you can use these alternative items. Oth</span>
<a href="#l5.27"></a><span id="l5.27"> &lt;!ENTITY goBackCmd.accesskey &quot;B&quot;&gt;</span>
<a href="#l5.28"></a><span id="l5.28"> &lt;!ENTITY goBackCmd.commandKey &quot;[&quot;&gt;</span>
<a href="#l5.29"></a><span id="l5.29"> &lt;!ENTITY prevStarredMsgCmd.label &quot;Starred Message&quot;&gt;</span>
<a href="#l5.30"></a><span id="l5.30"> &lt;!ENTITY prevStarredMsgCmd.accesskey &quot;S&quot;&gt;</span>
<a href="#l5.31"></a><span id="l5.31"> &lt;!ENTITY folderMenu.label &quot;Folder&quot;&gt;</span>
<a href="#l5.32"></a><span id="l5.32"> &lt;!ENTITY folderMenu.accesskey &quot;O&quot;&gt;</span>
<a href="#l5.33"></a><span id="l5.33"> &lt;!ENTITY thisFolder.label &quot;This Folder&quot;&gt;</span>
<a href="#l5.34"></a><span id="l5.34"> &lt;!ENTITY thisFolder.accesskey &quot;F&quot;&gt;</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineplus">+&lt;!ENTITY goRecentlyClosedTabs.label &quot;Recently Closed Tabs&quot;&gt;</span>
<a href="#l5.36"></a><span id="l5.36"> &lt;!ENTITY startPageCmd.label &quot;Mail Start Page&quot;&gt;</span>
<a href="#l5.37"></a><span id="l5.37"> &lt;!ENTITY startPageCmd.accesskey &quot;S&quot;&gt;</span>
<a href="#l5.38"></a><span id="l5.38"> </span>
<a href="#l5.39"></a><span id="l5.39"> &lt;!-- Message Menu --&gt;</span>
<a href="#l5.40"></a><span id="l5.40"> &lt;!ENTITY msgMenu.label &quot;Message&quot;&gt;</span>
<a href="#l5.41"></a><span id="l5.41"> &lt;!ENTITY msgMenu.accesskey &quot;M&quot;&gt;</span>
<a href="#l5.42"></a><span id="l5.42"> &lt;!ENTITY newMsgCmd.label &quot;New Message&quot;&gt;</span>
<a href="#l5.43"></a><span id="l5.43"> &lt;!ENTITY newMsgCmd.accesskey &quot;N&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mail/locales/en-US/chrome/messenger/messenger.properties</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mail/locales/en-US/chrome/messenger/messenger.properties</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -324,16 +324,17 @@ newsAcctType=News</span>
<a href="#l6.4"></a><span id="l6.4"> </span>
<a href="#l6.5"></a><span id="l6.5"> # LOCALIZATION NOTE(nocachedbodytitle): Do not translate &quot;&lt;TITLE&gt;&quot; or &quot;&lt;/TITLE&gt;&quot; in the line below</span>
<a href="#l6.6"></a><span id="l6.6"> nocachedbodytitle=&lt;TITLE&gt;Go Online to View This Message&lt;/TITLE&gt;\n</span>
<a href="#l6.7"></a><span id="l6.7"> </span>
<a href="#l6.8"></a><span id="l6.8"> # mailWindowOverlay.js</span>
<a href="#l6.9"></a><span id="l6.9"> confirmUnsubscribeTitle=Confirm Unsubscribe</span>
<a href="#l6.10"></a><span id="l6.10"> confirmUnsubscribeText=Are you sure you want to unsubscribe from %S?</span>
<a href="#l6.11"></a><span id="l6.11"> confirmUnsubscribeManyText=Are you sure you want to unsubscribe from these newsgroups?</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+restoreAllTabs=Restore All Tabs</span>
<a href="#l6.13"></a><span id="l6.13"> </span>
<a href="#l6.14"></a><span id="l6.14"> # msgHdrViewOverlay.js</span>
<a href="#l6.15"></a><span id="l6.15"> openLabel=Open</span>
<a href="#l6.16"></a><span id="l6.16"> openLabelAccesskey=O</span>
<a href="#l6.17"></a><span id="l6.17"> saveLabel=Save As</span>
<a href="#l6.18"></a><span id="l6.18"> saveLabelAccesskey=A</span>
<a href="#l6.19"></a><span id="l6.19"> detachLabel=Detach</span>
<a href="#l6.20"></a><span id="l6.20"> detachLabelAccesskey=D</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mail/test/mozmill/tabmail/test-tabmail-dragndrop.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mail/test/mozmill/tabmail/test-tabmail-dragndrop.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -29,30 +29,33 @@</span>
<a href="#l7.4"></a><span id="l7.4">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l7.5"></a><span id="l7.5">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l7.6"></a><span id="l7.6">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l7.7"></a><span id="l7.7">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l7.8"></a><span id="l7.8">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l7.9"></a><span id="l7.9">  *</span>
<a href="#l7.10"></a><span id="l7.10">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l7.11"></a><span id="l7.11"> </span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+var elib = {};</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+Cu.import('resource://mozmill/modules/elementslib.js', elib);</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+</span>
<a href="#l7.15"></a><span id="l7.15"> /*</span>
<a href="#l7.16"></a><span id="l7.16">  * Test rearanging tabs via drag'n'drop.</span>
<a href="#l7.17"></a><span id="l7.17">  */</span>
<a href="#l7.18"></a><span id="l7.18"> </span>
<a href="#l7.19"></a><span id="l7.19"> var MODULE_NAME = &quot;test-tabmail-dragndrop&quot;;</span>
<a href="#l7.20"></a><span id="l7.20"> </span>
<a href="#l7.21"></a><span id="l7.21"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l7.22"></a><span id="l7.22"> var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;];</span>
<a href="#l7.23"></a><span id="l7.23"> </span>
<a href="#l7.24"></a><span id="l7.24"> var folder;</span>
<a href="#l7.25"></a><span id="l7.25"> let msgHdrsInFolder = [];</span>
<a href="#l7.26"></a><span id="l7.26"> </span>
<a href="#l7.27"></a><span id="l7.27"> // The number of messages in folder.</span>
<a href="#l7.28"></a><span id="l7.28" class="difflineminus">-const NUM_MESSAGES_IN_FOLDER = 10;</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineplus">+const NUM_MESSAGES_IN_FOLDER = 15;</span>
<a href="#l7.30"></a><span id="l7.30"> </span>
<a href="#l7.31"></a><span id="l7.31"> function setupModule(module) {</span>
<a href="#l7.32"></a><span id="l7.32">   let fdh = collector.getModule(&quot;folder-display-helpers&quot;);</span>
<a href="#l7.33"></a><span id="l7.33">   fdh.installInto(module);</span>
<a href="#l7.34"></a><span id="l7.34">   let wh = collector.getModule(&quot;window-helpers&quot;);</span>
<a href="#l7.35"></a><span id="l7.35">   wh.installInto(module);</span>
<a href="#l7.36"></a><span id="l7.36"> </span>
<a href="#l7.37"></a><span id="l7.37">   folder = create_folder(&quot;MessageFolder&quot;);</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineat">@@ -98,282 +101,392 @@ function test_tab_reorder_setup_globals(</span>
<a href="#l7.39"></a><span id="l7.39">  * movable tab and drops it onto the third movable tab.</span>
<a href="#l7.40"></a><span id="l7.40">  */</span>
<a href="#l7.41"></a><span id="l7.41"> function test_tab_reorder_tabbar(){</span>
<a href="#l7.42"></a><span id="l7.42"> </span>
<a href="#l7.43"></a><span id="l7.43">   // Ensure only one tab is open, otherwise our test most likey fail anyway.</span>
<a href="#l7.44"></a><span id="l7.44">   mc.tabmail.closeOtherTabs(0);</span>
<a href="#l7.45"></a><span id="l7.45">   assert_number_of_tabs_open(1);</span>
<a href="#l7.46"></a><span id="l7.46"> </span>
<a href="#l7.47"></a><span id="l7.47" class="difflineminus">-  try {</span>
<a href="#l7.48"></a><span id="l7.48" class="difflineminus">-</span>
<a href="#l7.49"></a><span id="l7.49" class="difflineminus">-    be_in_folder(folder);</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineplus">+  be_in_folder(folder);</span>
<a href="#l7.51"></a><span id="l7.51"> </span>
<a href="#l7.52"></a><span id="l7.52" class="difflineminus">-    // Open four tabs</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineminus">-    for (let idx=0; idx &lt; 4 ; idx++) {</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineminus">-      select_click_row(idx);</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineminus">-      open_selected_message_in_new_tab(true);</span>
<a href="#l7.56"></a><span id="l7.56" class="difflineminus">-    }</span>
<a href="#l7.57"></a><span id="l7.57" class="difflineplus">+  // Open four tabs</span>
<a href="#l7.58"></a><span id="l7.58" class="difflineplus">+  for (let idx=0; idx &lt; 4 ; idx++) {</span>
<a href="#l7.59"></a><span id="l7.59" class="difflineplus">+    select_click_row(idx);</span>
<a href="#l7.60"></a><span id="l7.60" class="difflineplus">+    open_selected_message_in_new_tab(true);</span>
<a href="#l7.61"></a><span id="l7.61" class="difflineplus">+  }</span>
<a href="#l7.62"></a><span id="l7.62"> </span>
<a href="#l7.63"></a><span id="l7.63" class="difflineminus">-    // Check if every thing is correctly initalized</span>
<a href="#l7.64"></a><span id="l7.64" class="difflineminus">-    assert_number_of_tabs_open(5);</span>
<a href="#l7.65"></a><span id="l7.65" class="difflineplus">+  // Check if every thing is correctly initalized</span>
<a href="#l7.66"></a><span id="l7.66" class="difflineplus">+  assert_number_of_tabs_open(5);</span>
<a href="#l7.67"></a><span id="l7.67"> </span>
<a href="#l7.68"></a><span id="l7.68" class="difflineminus">-    assert_true(mc.tabmail.tabModes[&quot;message&quot;].tabs[0] == mc.tabmail.tabInfo[1],</span>
<a href="#l7.69"></a><span id="l7.69" class="difflineminus">-        &quot; tabMode.tabs and tabInfo out of sync&quot;);</span>
<a href="#l7.70"></a><span id="l7.70" class="difflineplus">+  assert_true(mc.tabmail.tabModes[&quot;message&quot;].tabs[0] == mc.tabmail.tabInfo[1],</span>
<a href="#l7.71"></a><span id="l7.71" class="difflineplus">+      &quot; tabMode.tabs and tabInfo out of sync&quot;);</span>
<a href="#l7.72"></a><span id="l7.72"> </span>
<a href="#l7.73"></a><span id="l7.73" class="difflineminus">-    assert_true(mc.tabmail.tabModes[&quot;message&quot;].tabs[1] == mc.tabmail.tabInfo[2],</span>
<a href="#l7.74"></a><span id="l7.74" class="difflineminus">-        &quot; tabMode.tabs and tabInfo out of sync&quot;);</span>
<a href="#l7.75"></a><span id="l7.75" class="difflineplus">+  assert_true(mc.tabmail.tabModes[&quot;message&quot;].tabs[1] == mc.tabmail.tabInfo[2],</span>
<a href="#l7.76"></a><span id="l7.76" class="difflineplus">+      &quot; tabMode.tabs and tabInfo out of sync&quot;);</span>
<a href="#l7.77"></a><span id="l7.77"> </span>
<a href="#l7.78"></a><span id="l7.78" class="difflineminus">-    assert_true(mc.tabmail.tabModes[&quot;message&quot;].tabs[2] == mc.tabmail.tabInfo[3],</span>
<a href="#l7.79"></a><span id="l7.79" class="difflineminus">-        &quot; tabMode.tabs and tabInfo out of sync&quot;);</span>
<a href="#l7.80"></a><span id="l7.80" class="difflineplus">+  assert_true(mc.tabmail.tabModes[&quot;message&quot;].tabs[2] == mc.tabmail.tabInfo[3],</span>
<a href="#l7.81"></a><span id="l7.81" class="difflineplus">+      &quot; tabMode.tabs and tabInfo out of sync&quot;);</span>
<a href="#l7.82"></a><span id="l7.82"> </span>
<a href="#l7.83"></a><span id="l7.83" class="difflineminus">-    // Start dragging the first tab</span>
<a href="#l7.84"></a><span id="l7.84" class="difflineminus">-    switch_tab(1);</span>
<a href="#l7.85"></a><span id="l7.85" class="difflineminus">-    assert_selected_and_displayed(msgHdrsInFolder[0]);</span>
<a href="#l7.86"></a><span id="l7.86" class="difflineplus">+  // Start dragging the first tab</span>
<a href="#l7.87"></a><span id="l7.87" class="difflineplus">+  switch_tab(1);</span>
<a href="#l7.88"></a><span id="l7.88" class="difflineplus">+  assert_selected_and_displayed(msgHdrsInFolder[0]);</span>
<a href="#l7.89"></a><span id="l7.89"> </span>
<a href="#l7.90"></a><span id="l7.90" class="difflineminus">-    let tab1 = mc.tabmail.tabContainer.childNodes[1];</span>
<a href="#l7.91"></a><span id="l7.91" class="difflineminus">-    let tab3 = mc.tabmail.tabContainer.childNodes[3];</span>
<a href="#l7.92"></a><span id="l7.92" class="difflineplus">+  let tab1 = mc.tabmail.tabContainer.childNodes[1];</span>
<a href="#l7.93"></a><span id="l7.93" class="difflineplus">+  let tab3 = mc.tabmail.tabContainer.childNodes[3];</span>
<a href="#l7.94"></a><span id="l7.94"> </span>
<a href="#l7.95"></a><span id="l7.95" class="difflineminus">-    let dt = _synthesizeDragStart(mc.window, tab1, mc.tabmail);</span>
<a href="#l7.96"></a><span id="l7.96" class="difflineplus">+  let dt = _synthesizeDragStart(mc.window, tab1, mc.tabmail);</span>
<a href="#l7.97"></a><span id="l7.97"> </span>
<a href="#l7.98"></a><span id="l7.98" class="difflineminus">-    // Drop it onto the third tab ...</span>
<a href="#l7.99"></a><span id="l7.99" class="difflineminus">-    _synthesizeDragOver(mc.window, tab3, dt);</span>
<a href="#l7.100"></a><span id="l7.100" class="difflineplus">+  // Drop it onto the third tab ...</span>
<a href="#l7.101"></a><span id="l7.101" class="difflineplus">+  _synthesizeDragOver(mc.window, tab3, dt);</span>
<a href="#l7.102"></a><span id="l7.102"> </span>
<a href="#l7.103"></a><span id="l7.103" class="difflineminus">-    _synthesizeDrop(mc.window, tab3, dt,</span>
<a href="#l7.104"></a><span id="l7.104" class="difflineminus">-        { screenX : tab3.boxObject.screenX + (tab3.boxObject.width * 0.75),</span>
<a href="#l7.105"></a><span id="l7.105" class="difflineminus">-          screenY : tab3.boxObject.screenY });</span>
<a href="#l7.106"></a><span id="l7.106" class="difflineplus">+  _synthesizeDrop(mc.window, tab3, dt,</span>
<a href="#l7.107"></a><span id="l7.107" class="difflineplus">+      { screenX : tab3.boxObject.screenX + (tab3.boxObject.width * 0.75),</span>
<a href="#l7.108"></a><span id="l7.108" class="difflineplus">+        screenY : tab3.boxObject.screenY });</span>
<a href="#l7.109"></a><span id="l7.109"> </span>
<a href="#l7.110"></a><span id="l7.110" class="difflineminus">-    wait_for_message_display_completion(mc);</span>
<a href="#l7.111"></a><span id="l7.111" class="difflineplus">+  wait_for_message_display_completion(mc);</span>
<a href="#l7.112"></a><span id="l7.112"> </span>
<a href="#l7.113"></a><span id="l7.113" class="difflineminus">-    // if every thing went well...</span>
<a href="#l7.114"></a><span id="l7.114" class="difflineminus">-    assert_number_of_tabs_open(5);</span>
<a href="#l7.115"></a><span id="l7.115" class="difflineplus">+  // if every thing went well...</span>
<a href="#l7.116"></a><span id="l7.116" class="difflineplus">+  assert_number_of_tabs_open(5);</span>
<a href="#l7.117"></a><span id="l7.117"> </span>
<a href="#l7.118"></a><span id="l7.118" class="difflineminus">-    // ... we should find tab1 at the third position...</span>
<a href="#l7.119"></a><span id="l7.119" class="difflineminus">-    assert_true(tab1 == mc.tabmail.tabContainer.childNodes[3],</span>
<a href="#l7.120"></a><span id="l7.120" class="difflineminus">-                &quot;Moving tab1 failed&quot;);</span>
<a href="#l7.121"></a><span id="l7.121" class="difflineminus">-    switch_tab(3);</span>
<a href="#l7.122"></a><span id="l7.122" class="difflineminus">-    assert_selected_and_displayed(msgHdrsInFolder[0]);</span>
<a href="#l7.123"></a><span id="l7.123" class="difflineplus">+  // ... we should find tab1 at the third position...</span>
<a href="#l7.124"></a><span id="l7.124" class="difflineplus">+  assert_true(tab1 == mc.tabmail.tabContainer.childNodes[3],</span>
<a href="#l7.125"></a><span id="l7.125" class="difflineplus">+              &quot;Moving tab1 failed&quot;);</span>
<a href="#l7.126"></a><span id="l7.126" class="difflineplus">+  switch_tab(3);</span>
<a href="#l7.127"></a><span id="l7.127" class="difflineplus">+  assert_selected_and_displayed(msgHdrsInFolder[0]);</span>
<a href="#l7.128"></a><span id="l7.128"> </span>
<a href="#l7.129"></a><span id="l7.129" class="difflineminus">-    // ... while tab3 moves one up and gets second.</span>
<a href="#l7.130"></a><span id="l7.130" class="difflineminus">-    assert_true(tab3 == mc.tabmail.tabContainer.childNodes[2],</span>
<a href="#l7.131"></a><span id="l7.131" class="difflineminus">-                &quot;Moving tab3 failed&quot;);</span>
<a href="#l7.132"></a><span id="l7.132" class="difflineminus">-    switch_tab(2);</span>
<a href="#l7.133"></a><span id="l7.133" class="difflineminus">-    assert_selected_and_displayed(msgHdrsInFolder[2]);</span>
<a href="#l7.134"></a><span id="l7.134" class="difflineminus">-</span>
<a href="#l7.135"></a><span id="l7.135" class="difflineminus">-    // we have one &quot;message&quot; tab and three &quot;folder&quot; tabs, thus tabInfo[1-3] and</span>
<a href="#l7.136"></a><span id="l7.136" class="difflineminus">-    // tabMode[&quot;message&quot;].tabs[0-2] have to be same, otherwise something went</span>
<a href="#l7.137"></a><span id="l7.137" class="difflineminus">-    // wrong while moving tabs around</span>
<a href="#l7.138"></a><span id="l7.138" class="difflineminus">-    assert_true(mc.tabmail.tabModes[&quot;message&quot;].tabs[0] == mc.tabmail.tabInfo[1],</span>
<a href="#l7.139"></a><span id="l7.139" class="difflineminus">-        &quot; tabMode.tabs and tabInfo out of sync&quot;);</span>
<a href="#l7.140"></a><span id="l7.140" class="difflineplus">+  // ... while tab3 moves one up and gets second.</span>
<a href="#l7.141"></a><span id="l7.141" class="difflineplus">+  assert_true(tab3 == mc.tabmail.tabContainer.childNodes[2],</span>
<a href="#l7.142"></a><span id="l7.142" class="difflineplus">+              &quot;Moving tab3 failed&quot;);</span>
<a href="#l7.143"></a><span id="l7.143" class="difflineplus">+  switch_tab(2);</span>
<a href="#l7.144"></a><span id="l7.144" class="difflineplus">+  assert_selected_and_displayed(msgHdrsInFolder[2]);</span>
<a href="#l7.145"></a><span id="l7.145"> </span>
<a href="#l7.146"></a><span id="l7.146" class="difflineminus">-    assert_true(mc.tabmail.tabModes[&quot;message&quot;].tabs[1] == mc.tabmail.tabInfo[2],</span>
<a href="#l7.147"></a><span id="l7.147" class="difflineminus">-        &quot; tabMode.tabs and tabInfo out of sync&quot;);</span>
<a href="#l7.148"></a><span id="l7.148" class="difflineplus">+  // we have one &quot;message&quot; tab and three &quot;folder&quot; tabs, thus tabInfo[1-3] and</span>
<a href="#l7.149"></a><span id="l7.149" class="difflineplus">+  // tabMode[&quot;message&quot;].tabs[0-2] have to be same, otherwise something went</span>
<a href="#l7.150"></a><span id="l7.150" class="difflineplus">+  // wrong while moving tabs around</span>
<a href="#l7.151"></a><span id="l7.151" class="difflineplus">+  assert_true(mc.tabmail.tabModes[&quot;message&quot;].tabs[0] == mc.tabmail.tabInfo[1],</span>
<a href="#l7.152"></a><span id="l7.152" class="difflineplus">+      &quot; tabMode.tabs and tabInfo out of sync&quot;);</span>
<a href="#l7.153"></a><span id="l7.153"> </span>
<a href="#l7.154"></a><span id="l7.154" class="difflineminus">-    assert_true(mc.tabmail.tabModes[&quot;message&quot;].tabs[2] == mc.tabmail.tabInfo[3],</span>
<a href="#l7.155"></a><span id="l7.155" class="difflineminus">-        &quot; tabMode.tabs and tabInfo out of sync&quot;);</span>
<a href="#l7.156"></a><span id="l7.156" class="difflineminus">-  }</span>
<a href="#l7.157"></a><span id="l7.157" class="difflineminus">-  finally {</span>
<a href="#l7.158"></a><span id="l7.158" class="difflineminus">-    // finally close the tabs we opened.</span>
<a href="#l7.159"></a><span id="l7.159" class="difflineminus">-    mc.tabmail.closeOtherTabs(0);</span>
<a href="#l7.160"></a><span id="l7.160" class="difflineminus">-    assert_number_of_tabs_open(1);</span>
<a href="#l7.161"></a><span id="l7.161" class="difflineminus">-  }</span>
<a href="#l7.162"></a><span id="l7.162" class="difflineplus">+  assert_true(mc.tabmail.tabModes[&quot;message&quot;].tabs[1] == mc.tabmail.tabInfo[2],</span>
<a href="#l7.163"></a><span id="l7.163" class="difflineplus">+      &quot; tabMode.tabs and tabInfo out of sync&quot;);</span>
<a href="#l7.164"></a><span id="l7.164" class="difflineplus">+</span>
<a href="#l7.165"></a><span id="l7.165" class="difflineplus">+  assert_true(mc.tabmail.tabModes[&quot;message&quot;].tabs[2] == mc.tabmail.tabInfo[3],</span>
<a href="#l7.166"></a><span id="l7.166" class="difflineplus">+      &quot; tabMode.tabs and tabInfo out of sync&quot;);</span>
<a href="#l7.167"></a><span id="l7.167"> }</span>
<a href="#l7.168"></a><span id="l7.168"> </span>
<a href="#l7.169"></a><span id="l7.169"> /**</span>
<a href="#l7.170"></a><span id="l7.170">  * Tests drag'n'drop tab reordering between windows</span>
<a href="#l7.171"></a><span id="l7.171">  */</span>
<a href="#l7.172"></a><span id="l7.172"> function test_tab_reorder_window(){</span>
<a href="#l7.173"></a><span id="l7.173"> </span>
<a href="#l7.174"></a><span id="l7.174">   // Ensure only one tab is open, otherwise our test most likey fail anyway.</span>
<a href="#l7.175"></a><span id="l7.175">   mc.tabmail.closeOtherTabs(0);</span>
<a href="#l7.176"></a><span id="l7.176">   assert_number_of_tabs_open(1);</span>
<a href="#l7.177"></a><span id="l7.177"> </span>
<a href="#l7.178"></a><span id="l7.178">   let mc2 = null;</span>
<a href="#l7.179"></a><span id="l7.179"> </span>
<a href="#l7.180"></a><span id="l7.180" class="difflineminus">-  try {</span>
<a href="#l7.181"></a><span id="l7.181" class="difflineminus">-</span>
<a href="#l7.182"></a><span id="l7.182" class="difflineminus">-    be_in_folder(folder);</span>
<a href="#l7.183"></a><span id="l7.183" class="difflineplus">+  be_in_folder(folder);</span>
<a href="#l7.184"></a><span id="l7.184"> </span>
<a href="#l7.185"></a><span id="l7.185" class="difflineminus">-    // Open a new tab...</span>
<a href="#l7.186"></a><span id="l7.186" class="difflineminus">-    select_click_row(1);</span>
<a href="#l7.187"></a><span id="l7.187" class="difflineminus">-    open_selected_message_in_new_tab(false);</span>
<a href="#l7.188"></a><span id="l7.188" class="difflineplus">+  // Open a new tab...</span>
<a href="#l7.189"></a><span id="l7.189" class="difflineplus">+  select_click_row(1);</span>
<a href="#l7.190"></a><span id="l7.190" class="difflineplus">+  open_selected_message_in_new_tab(false);</span>
<a href="#l7.191"></a><span id="l7.191"> </span>
<a href="#l7.192"></a><span id="l7.192" class="difflineminus">-    assert_number_of_tabs_open(2);</span>
<a href="#l7.193"></a><span id="l7.193" class="difflineplus">+  assert_number_of_tabs_open(2);</span>
<a href="#l7.194"></a><span id="l7.194" class="difflineplus">+</span>
<a href="#l7.195"></a><span id="l7.195" class="difflineplus">+  switch_tab(1);</span>
<a href="#l7.196"></a><span id="l7.196" class="difflineplus">+  assert_selected_and_displayed(msgHdrsInFolder[1]);</span>
<a href="#l7.197"></a><span id="l7.197"> </span>
<a href="#l7.198"></a><span id="l7.198" class="difflineminus">-    switch_tab(1);</span>
<a href="#l7.199"></a><span id="l7.199" class="difflineminus">-    assert_selected_and_displayed(msgHdrsInFolder[1]);</span>
<a href="#l7.200"></a><span id="l7.200" class="difflineminus">-</span>
<a href="#l7.201"></a><span id="l7.201" class="difflineminus">-    // ...and then a new 3 pane as our drop target.</span>
<a href="#l7.202"></a><span id="l7.202" class="difflineminus">-    plan_for_new_window(&quot;mail:3pane&quot;);</span>
<a href="#l7.203"></a><span id="l7.203" class="difflineplus">+  // ...and then a new 3 pane as our drop target.</span>
<a href="#l7.204"></a><span id="l7.204" class="difflineplus">+  plan_for_new_window(&quot;mail:3pane&quot;);</span>
<a href="#l7.205"></a><span id="l7.205"> </span>
<a href="#l7.206"></a><span id="l7.206" class="difflineminus">-    let ww = Cc[&quot;@mozilla.org/embedcomp/window-watcher;1&quot;]</span>
<a href="#l7.207"></a><span id="l7.207" class="difflineminus">-                          .getService(Ci.nsIWindowWatcher);</span>
<a href="#l7.208"></a><span id="l7.208" class="difflineplus">+  let ww = Cc[&quot;@mozilla.org/embedcomp/window-watcher;1&quot;]</span>
<a href="#l7.209"></a><span id="l7.209" class="difflineplus">+                        .getService(Ci.nsIWindowWatcher);</span>
<a href="#l7.210"></a><span id="l7.210"> </span>
<a href="#l7.211"></a><span id="l7.211" class="difflineminus">-    let args = {msgHdr: msgHdrsInFolder[3]};</span>
<a href="#l7.212"></a><span id="l7.212" class="difflineminus">-    args.wrappedJSObject = args;</span>
<a href="#l7.213"></a><span id="l7.213" class="difflineplus">+  let args = {msgHdr: msgHdrsInFolder[3]};</span>
<a href="#l7.214"></a><span id="l7.214" class="difflineplus">+  args.wrappedJSObject = args;</span>
<a href="#l7.215"></a><span id="l7.215"> </span>
<a href="#l7.216"></a><span id="l7.216" class="difflineminus">-    let aWnd2 = ww.openWindow(null,</span>
<a href="#l7.217"></a><span id="l7.217" class="difflineplus">+  let aWnd2 = ww.openWindow(null,</span>
<a href="#l7.218"></a><span id="l7.218">         &quot;chrome://messenger/content/&quot;, &quot;&quot;,</span>
<a href="#l7.219"></a><span id="l7.219">         &quot;all,chrome,dialog=no,status,toolbar&quot;, args);</span>
<a href="#l7.220"></a><span id="l7.220"> </span>
<a href="#l7.221"></a><span id="l7.221" class="difflineminus">-    mc2 = wait_for_new_window(&quot;mail:3pane&quot;);</span>
<a href="#l7.222"></a><span id="l7.222" class="difflineminus">-    wait_for_message_display_completion(mc2,true);</span>
<a href="#l7.223"></a><span id="l7.223" class="difflineplus">+  mc2 = wait_for_new_window(&quot;mail:3pane&quot;);</span>
<a href="#l7.224"></a><span id="l7.224" class="difflineplus">+  wait_for_message_display_completion(mc2,true);</span>
<a href="#l7.225"></a><span id="l7.225"> </span>
<a href="#l7.226"></a><span id="l7.226" class="difflineminus">-    // Double check if we are listening to the right window.</span>
<a href="#l7.227"></a><span id="l7.227" class="difflineminus">-    assert_true(aWnd2 == mc2.window, &quot;Opening Window failed&quot; );</span>
<a href="#l7.228"></a><span id="l7.228" class="difflineminus">-</span>
<a href="#l7.229"></a><span id="l7.229" class="difflineminus">-    // Start dragging the first tab ...</span>
<a href="#l7.230"></a><span id="l7.230" class="difflineminus">-    let tabA = mc.tabmail.tabContainer.childNodes[1];</span>
<a href="#l7.231"></a><span id="l7.231" class="difflineminus">-    assert_true(tabA, &quot;No movable Tab&quot;);</span>
<a href="#l7.232"></a><span id="l7.232" class="difflineplus">+  // Double check if we are listening to the right window.</span>
<a href="#l7.233"></a><span id="l7.233" class="difflineplus">+  assert_true(aWnd2 == mc2.window, &quot;Opening Window failed&quot; );</span>
<a href="#l7.234"></a><span id="l7.234"> </span>
<a href="#l7.235"></a><span id="l7.235" class="difflineminus">-    // We drop onto the Folder Tab, it is guaranteed to exist.</span>
<a href="#l7.236"></a><span id="l7.236" class="difflineminus">-    let tabB = mc2.tabmail.tabContainer.childNodes[0];</span>
<a href="#l7.237"></a><span id="l7.237" class="difflineminus">-    assert_true(tabB, &quot;No movable Tab&quot;);</span>
<a href="#l7.238"></a><span id="l7.238" class="difflineminus">-</span>
<a href="#l7.239"></a><span id="l7.239" class="difflineminus">-    let dt = _synthesizeDragStart(mc.window,tabA,mc.tabmail);</span>
<a href="#l7.240"></a><span id="l7.240" class="difflineplus">+  // Start dragging the first tab ...</span>
<a href="#l7.241"></a><span id="l7.241" class="difflineplus">+  let tabA = mc.tabmail.tabContainer.childNodes[1];</span>
<a href="#l7.242"></a><span id="l7.242" class="difflineplus">+  assert_true(tabA, &quot;No movable Tab&quot;);</span>
<a href="#l7.243"></a><span id="l7.243"> </span>
<a href="#l7.244"></a><span id="l7.244" class="difflineminus">-    _synthesizeDragOver(mc2.window, tabB,dt);</span>
<a href="#l7.245"></a><span id="l7.245" class="difflineplus">+  // We drop onto the Folder Tab, it is guaranteed to exist.</span>
<a href="#l7.246"></a><span id="l7.246" class="difflineplus">+  let tabB = mc2.tabmail.tabContainer.childNodes[0];</span>
<a href="#l7.247"></a><span id="l7.247" class="difflineplus">+  assert_true(tabB, &quot;No movable Tab&quot;);</span>
<a href="#l7.248"></a><span id="l7.248"> </span>
<a href="#l7.249"></a><span id="l7.249" class="difflineminus">-    _synthesizeDrop(mc2.window,tabB, dt,</span>
<a href="#l7.250"></a><span id="l7.250" class="difflineminus">-        { screenX : tabB.boxObject.screenX + (tabB.boxObject.width * 0.75),</span>
<a href="#l7.251"></a><span id="l7.251" class="difflineminus">-          screenY : tabB.boxObject.screenY });</span>
<a href="#l7.252"></a><span id="l7.252" class="difflineplus">+  let dt = _synthesizeDragStart(mc.window,tabA,mc.tabmail);</span>
<a href="#l7.253"></a><span id="l7.253"> </span>
<a href="#l7.254"></a><span id="l7.254" class="difflineminus">-    wait_for_message_display_completion(mc2);</span>
<a href="#l7.255"></a><span id="l7.255" class="difflineminus">-</span>
<a href="#l7.256"></a><span id="l7.256" class="difflineminus">-    assert_true( !! (mc.tabmail.tabContainer.childNodes.length == 1),</span>
<a href="#l7.257"></a><span id="l7.257" class="difflineminus">-      &quot;Moving tab to new window failed, tab still in old window&quot;);</span>
<a href="#l7.258"></a><span id="l7.258" class="difflineplus">+  _synthesizeDragOver(mc2.window, tabB,dt);</span>
<a href="#l7.259"></a><span id="l7.259"> </span>
<a href="#l7.260"></a><span id="l7.260" class="difflineminus">-    assert_true( !! (mc2.tabmail.tabContainer.childNodes.length == 2),</span>
<a href="#l7.261"></a><span id="l7.261" class="difflineminus">-      &quot;Moving tab to new window failed, no new tab in new window&quot;);</span>
<a href="#l7.262"></a><span id="l7.262" class="difflineplus">+  _synthesizeDrop(mc2.window,tabB, dt,</span>
<a href="#l7.263"></a><span id="l7.263" class="difflineplus">+      { screenX : tabB.boxObject.screenX + (tabB.boxObject.width * 0.75),</span>
<a href="#l7.264"></a><span id="l7.264" class="difflineplus">+        screenY : tabB.boxObject.screenY });</span>
<a href="#l7.265"></a><span id="l7.265"> </span>
<a href="#l7.266"></a><span id="l7.266" class="difflineminus">-    assert_selected_and_displayed(mc2,msgHdrsInFolder[1]);</span>
<a href="#l7.267"></a><span id="l7.267" class="difflineplus">+  wait_for_message_display_completion(mc2);</span>
<a href="#l7.268"></a><span id="l7.268"> </span>
<a href="#l7.269"></a><span id="l7.269" class="difflineminus">-  }</span>
<a href="#l7.270"></a><span id="l7.270" class="difflineminus">-  finally {</span>
<a href="#l7.271"></a><span id="l7.271" class="difflineminus">-    // finally close the tabs and windows we opened.</span>
<a href="#l7.272"></a><span id="l7.272" class="difflineminus">-    mc.tabmail.closeOtherTabs(0);</span>
<a href="#l7.273"></a><span id="l7.273" class="difflineminus">-    assert_number_of_tabs_open(1);</span>
<a href="#l7.274"></a><span id="l7.274" class="difflineplus">+  assert_true( !! (mc.tabmail.tabContainer.childNodes.length == 1),</span>
<a href="#l7.275"></a><span id="l7.275" class="difflineplus">+    &quot;Moving tab to new window failed, tab still in old window&quot;);</span>
<a href="#l7.276"></a><span id="l7.276"> </span>
<a href="#l7.277"></a><span id="l7.277" class="difflineminus">-    if (mc2)</span>
<a href="#l7.278"></a><span id="l7.278" class="difflineminus">-      mc2.window.close();</span>
<a href="#l7.279"></a><span id="l7.279" class="difflineminus">-  }</span>
<a href="#l7.280"></a><span id="l7.280" class="difflineplus">+  assert_true( !! (mc2.tabmail.tabContainer.childNodes.length == 2),</span>
<a href="#l7.281"></a><span id="l7.281" class="difflineplus">+    &quot;Moving tab to new window failed, no new tab in new window&quot;);</span>
<a href="#l7.282"></a><span id="l7.282"> </span>
<a href="#l7.283"></a><span id="l7.283" class="difflineminus">-</span>
<a href="#l7.284"></a><span id="l7.284" class="difflineplus">+  assert_selected_and_displayed(mc2,msgHdrsInFolder[1]);</span>
<a href="#l7.285"></a><span id="l7.285"> }</span>
<a href="#l7.286"></a><span id="l7.286"> </span>
<a href="#l7.287"></a><span id="l7.287"> /**</span>
<a href="#l7.288"></a><span id="l7.288">  * Tests detaching tabs into windows via drag'n'drop</span>
<a href="#l7.289"></a><span id="l7.289">  */</span>
<a href="#l7.290"></a><span id="l7.290"> function test_tab_reorder_detach(){</span>
<a href="#l7.291"></a><span id="l7.291"> </span>
<a href="#l7.292"></a><span id="l7.292">   // Ensure only one tab is open, otherwise our test most likey fail anyway.</span>
<a href="#l7.293"></a><span id="l7.293">   mc.tabmail.closeOtherTabs(0);</span>
<a href="#l7.294"></a><span id="l7.294">   assert_number_of_tabs_open(1);</span>
<a href="#l7.295"></a><span id="l7.295"> </span>
<a href="#l7.296"></a><span id="l7.296">   let mc2 = null;</span>
<a href="#l7.297"></a><span id="l7.297"> </span>
<a href="#l7.298"></a><span id="l7.298" class="difflineminus">-  try {</span>
<a href="#l7.299"></a><span id="l7.299" class="difflineminus">-</span>
<a href="#l7.300"></a><span id="l7.300" class="difflineminus">-    be_in_folder(folder);</span>
<a href="#l7.301"></a><span id="l7.301" class="difflineplus">+  be_in_folder(folder);</span>
<a href="#l7.302"></a><span id="l7.302"> </span>
<a href="#l7.303"></a><span id="l7.303" class="difflineminus">-    // Open a new tab...</span>
<a href="#l7.304"></a><span id="l7.304" class="difflineminus">-    select_click_row(2);</span>
<a href="#l7.305"></a><span id="l7.305" class="difflineminus">-    open_selected_message_in_new_tab(false);</span>
<a href="#l7.306"></a><span id="l7.306" class="difflineplus">+  // Open a new tab...</span>
<a href="#l7.307"></a><span id="l7.307" class="difflineplus">+  select_click_row(2);</span>
<a href="#l7.308"></a><span id="l7.308" class="difflineplus">+  open_selected_message_in_new_tab(false);</span>
<a href="#l7.309"></a><span id="l7.309"> </span>
<a href="#l7.310"></a><span id="l7.310" class="difflineminus">-    assert_number_of_tabs_open(2);</span>
<a href="#l7.311"></a><span id="l7.311" class="difflineplus">+  assert_number_of_tabs_open(2);</span>
<a href="#l7.312"></a><span id="l7.312"> </span>
<a href="#l7.313"></a><span id="l7.313" class="difflineminus">-    // ... if every thing works we should expect a new window...</span>
<a href="#l7.314"></a><span id="l7.314" class="difflineminus">-    plan_for_new_window(&quot;mail:3pane&quot;);</span>
<a href="#l7.315"></a><span id="l7.315" class="difflineplus">+  // ... if every thing works we should expect a new window...</span>
<a href="#l7.316"></a><span id="l7.316" class="difflineplus">+  plan_for_new_window(&quot;mail:3pane&quot;);</span>
<a href="#l7.317"></a><span id="l7.317"> </span>
<a href="#l7.318"></a><span id="l7.318" class="difflineminus">-    // ... now start dragging</span>
<a href="#l7.319"></a><span id="l7.319" class="difflineminus">-</span>
<a href="#l7.320"></a><span id="l7.320" class="difflineminus">-    mc.tabmail.switchToTab(1);</span>
<a href="#l7.321"></a><span id="l7.321" class="difflineplus">+  // ... now start dragging</span>
<a href="#l7.322"></a><span id="l7.322"> </span>
<a href="#l7.323"></a><span id="l7.323" class="difflineminus">-    let tab1 = mc.tabmail.tabContainer.childNodes[1];</span>
<a href="#l7.324"></a><span id="l7.324" class="difflineminus">-    let dropContent = mc.e(&quot;tabpanelcontainer&quot;);</span>
<a href="#l7.325"></a><span id="l7.325" class="difflineminus">-    let box = dropContent.boxObject;</span>
<a href="#l7.326"></a><span id="l7.326" class="difflineplus">+  mc.tabmail.switchToTab(1);</span>
<a href="#l7.327"></a><span id="l7.327"> </span>
<a href="#l7.328"></a><span id="l7.328" class="difflineminus">-    let dt = _synthesizeDragStart(mc.window, tab1, mc.tabmail);</span>
<a href="#l7.329"></a><span id="l7.329" class="difflineminus">-</span>
<a href="#l7.330"></a><span id="l7.330" class="difflineminus">-    _synthesizeDragOver(mc.window, dropContent, dt);</span>
<a href="#l7.331"></a><span id="l7.331" class="difflineplus">+  let tab1 = mc.tabmail.tabContainer.childNodes[1];</span>
<a href="#l7.332"></a><span id="l7.332" class="difflineplus">+  let dropContent = mc.e(&quot;tabpanelcontainer&quot;);</span>
<a href="#l7.333"></a><span id="l7.333" class="difflineplus">+  let box = dropContent.boxObject;</span>
<a href="#l7.334"></a><span id="l7.334"> </span>
<a href="#l7.335"></a><span id="l7.335" class="difflineminus">-    // notify tab1 drag has ended</span>
<a href="#l7.336"></a><span id="l7.336" class="difflineminus">-    _synthesizeDragEnd(mc.window, dropContent, tab1, dt,</span>
<a href="#l7.337"></a><span id="l7.337" class="difflineminus">-        { screenX : (box.screenX + box.width / 2 ),</span>
<a href="#l7.338"></a><span id="l7.338" class="difflineminus">-          screenY : (box.screenY + box.height / 2 ) });</span>
<a href="#l7.339"></a><span id="l7.339" class="difflineplus">+  let dt = _synthesizeDragStart(mc.window, tab1, mc.tabmail);</span>
<a href="#l7.340"></a><span id="l7.340" class="difflineplus">+</span>
<a href="#l7.341"></a><span id="l7.341" class="difflineplus">+  _synthesizeDragOver(mc.window, dropContent, dt);</span>
<a href="#l7.342"></a><span id="l7.342"> </span>
<a href="#l7.343"></a><span id="l7.343" class="difflineminus">-    // ... and wait for the new window</span>
<a href="#l7.344"></a><span id="l7.344" class="difflineminus">-    mc2 = wait_for_new_window(&quot;mail:3pane&quot;);</span>
<a href="#l7.345"></a><span id="l7.345" class="difflineminus">-    wait_for_message_display_completion(mc2, true);</span>
<a href="#l7.346"></a><span id="l7.346" class="difflineminus">-</span>
<a href="#l7.347"></a><span id="l7.347" class="difflineminus">-    assert_true(mc.tabmail.tabContainer.childNodes.length == 1,</span>
<a href="#l7.348"></a><span id="l7.348" class="difflineminus">-        &quot;Moving tab to new window failed, tab still in old window&quot;);</span>
<a href="#l7.349"></a><span id="l7.349" class="difflineplus">+  // notify tab1 drag has ended</span>
<a href="#l7.350"></a><span id="l7.350" class="difflineplus">+  _synthesizeDragEnd(mc.window, dropContent, tab1, dt,</span>
<a href="#l7.351"></a><span id="l7.351" class="difflineplus">+      { screenX : (box.screenX + box.width / 2 ),</span>
<a href="#l7.352"></a><span id="l7.352" class="difflineplus">+        screenY : (box.screenY + box.height / 2 ) });</span>
<a href="#l7.353"></a><span id="l7.353"> </span>
<a href="#l7.354"></a><span id="l7.354" class="difflineminus">-    assert_true(mc2.tabmail.tabContainer.childNodes.length == 2,</span>
<a href="#l7.355"></a><span id="l7.355" class="difflineminus">-        &quot;Moving tab to new window failed, no new tab in new window&quot;);</span>
<a href="#l7.356"></a><span id="l7.356" class="difflineminus">-</span>
<a href="#l7.357"></a><span id="l7.357" class="difflineminus">-    assert_selected_and_displayed(mc2, msgHdrsInFolder[2]);</span>
<a href="#l7.358"></a><span id="l7.358" class="difflineplus">+  // ... and wait for the new window</span>
<a href="#l7.359"></a><span id="l7.359" class="difflineplus">+  mc2 = wait_for_new_window(&quot;mail:3pane&quot;);</span>
<a href="#l7.360"></a><span id="l7.360" class="difflineplus">+  wait_for_message_display_completion(mc2, true);</span>
<a href="#l7.361"></a><span id="l7.361"> </span>
<a href="#l7.362"></a><span id="l7.362" class="difflineminus">-  }</span>
<a href="#l7.363"></a><span id="l7.363" class="difflineminus">-  finally {</span>
<a href="#l7.364"></a><span id="l7.364" class="difflineminus">-    // finally close the tabs and window we opened.</span>
<a href="#l7.365"></a><span id="l7.365" class="difflineminus">-    mc.tabmail.closeOtherTabs(0);</span>
<a href="#l7.366"></a><span id="l7.366" class="difflineminus">-    assert_number_of_tabs_open(1);</span>
<a href="#l7.367"></a><span id="l7.367" class="difflineplus">+  assert_true(mc.tabmail.tabContainer.childNodes.length == 1,</span>
<a href="#l7.368"></a><span id="l7.368" class="difflineplus">+      &quot;Moving tab to new window failed, tab still in old window&quot;);</span>
<a href="#l7.369"></a><span id="l7.369"> </span>
<a href="#l7.370"></a><span id="l7.370" class="difflineminus">-    if (mc2)</span>
<a href="#l7.371"></a><span id="l7.371" class="difflineminus">-      mc2.window.close();</span>
<a href="#l7.372"></a><span id="l7.372" class="difflineminus">-  }</span>
<a href="#l7.373"></a><span id="l7.373" class="difflineplus">+  assert_true(mc2.tabmail.tabContainer.childNodes.length == 2,</span>
<a href="#l7.374"></a><span id="l7.374" class="difflineplus">+      &quot;Moving tab to new window failed, no new tab in new window&quot;);</span>
<a href="#l7.375"></a><span id="l7.375" class="difflineplus">+</span>
<a href="#l7.376"></a><span id="l7.376" class="difflineplus">+  assert_selected_and_displayed(mc2, msgHdrsInFolder[2]);</span>
<a href="#l7.377"></a><span id="l7.377" class="difflineplus">+</span>
<a href="#l7.378"></a><span id="l7.378"> }</span>
<a href="#l7.379"></a><span id="l7.379"> </span>
<a href="#l7.380"></a><span id="l7.380"> /**</span>
<a href="#l7.381"></a><span id="l7.381">  * Test undo of recently closed tabs.</span>
<a href="#l7.382"></a><span id="l7.382">  */</span>
<a href="#l7.383"></a><span id="l7.383"> function test_tab_undo() {</span>
<a href="#l7.384"></a><span id="l7.384">   // Ensure only one tab is open, otherwise our test most likey fail anyway.</span>
<a href="#l7.385"></a><span id="l7.385">   mc.tabmail.closeOtherTabs(0);</span>
<a href="#l7.386"></a><span id="l7.386">   assert_number_of_tabs_open(1);</span>
<a href="#l7.387"></a><span id="l7.387"> </span>
<a href="#l7.388"></a><span id="l7.388" class="difflineminus">-  try {</span>
<a href="#l7.389"></a><span id="l7.389" class="difflineplus">+  be_in_folder(folder);</span>
<a href="#l7.390"></a><span id="l7.390" class="difflineplus">+</span>
<a href="#l7.391"></a><span id="l7.391" class="difflineplus">+  // Open five tabs...</span>
<a href="#l7.392"></a><span id="l7.392" class="difflineplus">+  for (let idx = 0; idx &lt; 5; idx++) {</span>
<a href="#l7.393"></a><span id="l7.393" class="difflineplus">+    select_click_row(idx);</span>
<a href="#l7.394"></a><span id="l7.394" class="difflineplus">+    open_selected_message_in_new_tab(true);</span>
<a href="#l7.395"></a><span id="l7.395" class="difflineplus">+  }</span>
<a href="#l7.396"></a><span id="l7.396" class="difflineplus">+</span>
<a href="#l7.397"></a><span id="l7.397" class="difflineplus">+  assert_number_of_tabs_open(6);</span>
<a href="#l7.398"></a><span id="l7.398" class="difflineplus">+</span>
<a href="#l7.399"></a><span id="l7.399" class="difflineplus">+  switch_tab(2);</span>
<a href="#l7.400"></a><span id="l7.400" class="difflineplus">+  assert_selected_and_displayed(msgHdrsInFolder[1]);</span>
<a href="#l7.401"></a><span id="l7.401"> </span>
<a href="#l7.402"></a><span id="l7.402" class="difflineminus">-    be_in_folder(folder);</span>
<a href="#l7.403"></a><span id="l7.403" class="difflineplus">+  mc.tabmail.closeTab(2);</span>
<a href="#l7.404"></a><span id="l7.404" class="difflineplus">+  // This tab should not be added to recently closed tabs...</span>
<a href="#l7.405"></a><span id="l7.405" class="difflineplus">+  // ... thus it can't be restored</span>
<a href="#l7.406"></a><span id="l7.406" class="difflineplus">+  mc.tabmail.closeTab(2, true);</span>
<a href="#l7.407"></a><span id="l7.407" class="difflineplus">+  mc.tabmail.closeTab(2);</span>
<a href="#l7.408"></a><span id="l7.408" class="difflineplus">+</span>
<a href="#l7.409"></a><span id="l7.409" class="difflineplus">+  assert_number_of_tabs_open(3);</span>
<a href="#l7.410"></a><span id="l7.410" class="difflineplus">+  assert_selected_and_displayed(mc, msgHdrsInFolder[4]);</span>
<a href="#l7.411"></a><span id="l7.411" class="difflineplus">+</span>
<a href="#l7.412"></a><span id="l7.412" class="difflineplus">+  mc.tabmail.undoCloseTab();</span>
<a href="#l7.413"></a><span id="l7.413" class="difflineplus">+  assert_number_of_tabs_open(4);</span>
<a href="#l7.414"></a><span id="l7.414" class="difflineplus">+  assert_selected_and_displayed(mc, msgHdrsInFolder[3]);</span>
<a href="#l7.415"></a><span id="l7.415" class="difflineplus">+</span>
<a href="#l7.416"></a><span id="l7.416" class="difflineplus">+  // msgHdrsInFolder[2] won't be restorend it was closed with disabled undo.</span>
<a href="#l7.417"></a><span id="l7.417" class="difflineplus">+</span>
<a href="#l7.418"></a><span id="l7.418" class="difflineplus">+  mc.tabmail.undoCloseTab();</span>
<a href="#l7.419"></a><span id="l7.419" class="difflineplus">+  assert_number_of_tabs_open(5);</span>
<a href="#l7.420"></a><span id="l7.420" class="difflineplus">+  assert_selected_and_displayed(mc, msgHdrsInFolder[1]);</span>
<a href="#l7.421"></a><span id="l7.421" class="difflineplus">+}</span>
<a href="#l7.422"></a><span id="l7.422"> </span>
<a href="#l7.423"></a><span id="l7.423" class="difflineminus">-    // Open five tabs...</span>
<a href="#l7.424"></a><span id="l7.424" class="difflineminus">-    for (let idx = 0; idx &lt; 5; idx++) {</span>
<a href="#l7.425"></a><span id="l7.425" class="difflineminus">-      select_click_row(idx);</span>
<a href="#l7.426"></a><span id="l7.426" class="difflineminus">-      open_selected_message_in_new_tab(true);</span>
<a href="#l7.427"></a><span id="l7.427" class="difflineminus">-    }</span>
<a href="#l7.428"></a><span id="l7.428" class="difflineplus">+function _synthesizeRecentlyClosedMenu()</span>
<a href="#l7.429"></a><span id="l7.429" class="difflineplus">+{                  </span>
<a href="#l7.430"></a><span id="l7.430" class="difflineplus">+  mc.rightClick(new elib.Elem(mc.tabmail.tabContainer.childNodes[1]));</span>
<a href="#l7.431"></a><span id="l7.431" class="difflineplus">+  </span>
<a href="#l7.432"></a><span id="l7.432" class="difflineplus">+  wait_for_popup_to_open(</span>
<a href="#l7.433"></a><span id="l7.433" class="difflineplus">+    mc.window.document.getAnonymousElementByAttribute(</span>
<a href="#l7.434"></a><span id="l7.434" class="difflineplus">+      mc.tabmail,&quot;anonid&quot;,&quot;tabContextMenu&quot;));</span>
<a href="#l7.435"></a><span id="l7.435" class="difflineplus">+      </span>
<a href="#l7.436"></a><span id="l7.436" class="difflineplus">+  let menu = mc.window.document.getAnonymousElementByAttribute(</span>
<a href="#l7.437"></a><span id="l7.437" class="difflineplus">+                   mc.tabmail,&quot;anonid&quot;,&quot;recentlyClosedTabs&quot;);      </span>
<a href="#l7.438"></a><span id="l7.438" class="difflineplus">+</span>
<a href="#l7.439"></a><span id="l7.439" class="difflineplus">+  EventUtils.synthesizeMouse(menu,5, 5, {},mc.window);</span>
<a href="#l7.440"></a><span id="l7.440" class="difflineplus">+  wait_for_popup_to_open(menu.menupopup);</span>
<a href="#l7.441"></a><span id="l7.441" class="difflineplus">+  </span>
<a href="#l7.442"></a><span id="l7.442" class="difflineplus">+  return menu;</span>
<a href="#l7.443"></a><span id="l7.443" class="difflineplus">+}</span>
<a href="#l7.444"></a><span id="l7.444" class="difflineplus">+</span>
<a href="#l7.445"></a><span id="l7.445" class="difflineplus">+function _teardownRecentlyClosedMenu()</span>
<a href="#l7.446"></a><span id="l7.446" class="difflineplus">+{  </span>
<a href="#l7.447"></a><span id="l7.447" class="difflineplus">+  let menu = mc.window.document.getAnonymousElementByAttribute(</span>
<a href="#l7.448"></a><span id="l7.448" class="difflineplus">+            mc.tabmail,&quot;anonid&quot;,&quot;tabContextMenu&quot;)  </span>
<a href="#l7.449"></a><span id="l7.449" class="difflineplus">+  close_popup(mc,new elib.Elem(menu));</span>
<a href="#l7.450"></a><span id="l7.450" class="difflineplus">+}</span>
<a href="#l7.451"></a><span id="l7.451"> </span>
<a href="#l7.452"></a><span id="l7.452" class="difflineminus">-    assert_number_of_tabs_open(6);</span>
<a href="#l7.453"></a><span id="l7.453" class="difflineplus">+/**</span>
<a href="#l7.454"></a><span id="l7.454" class="difflineplus">+ * Tests the recently closed tabs menu. </span>
<a href="#l7.455"></a><span id="l7.455" class="difflineplus">+ */</span>
<a href="#l7.456"></a><span id="l7.456" class="difflineplus">+function test_tab_recentlyClosed() {</span>
<a href="#l7.457"></a><span id="l7.457"> </span>
<a href="#l7.458"></a><span id="l7.458" class="difflineminus">-    switch_tab(2);</span>
<a href="#l7.459"></a><span id="l7.459" class="difflineminus">-    assert_selected_and_displayed(msgHdrsInFolder[1]);</span>
<a href="#l7.460"></a><span id="l7.460" class="difflineplus">+  // Ensure only one tab is open, otherwise our test most likey fail anyway.</span>
<a href="#l7.461"></a><span id="l7.461" class="difflineplus">+  mc.tabmail.closeOtherTabs(0);</span>
<a href="#l7.462"></a><span id="l7.462" class="difflineplus">+  assert_number_of_tabs_open(1);</span>
<a href="#l7.463"></a><span id="l7.463" class="difflineplus">+  </span>
<a href="#l7.464"></a><span id="l7.464" class="difflineplus">+  // We start with a clean tab history.</span>
<a href="#l7.465"></a><span id="l7.465" class="difflineplus">+  mc.tabmail.recentlyClosedTabs = [];</span>
<a href="#l7.466"></a><span id="l7.466" class="difflineplus">+        </span>
<a href="#l7.467"></a><span id="l7.467" class="difflineplus">+  // The history is cleaned so let's open 15 tabs...</span>
<a href="#l7.468"></a><span id="l7.468" class="difflineplus">+  be_in_folder(folder);    </span>
<a href="#l7.469"></a><span id="l7.469" class="difflineplus">+                   </span>
<a href="#l7.470"></a><span id="l7.470" class="difflineplus">+  for (let idx = 0; idx &lt; 15; idx++) {</span>
<a href="#l7.471"></a><span id="l7.471" class="difflineplus">+    select_click_row(idx);</span>
<a href="#l7.472"></a><span id="l7.472" class="difflineplus">+    open_selected_message_in_new_tab(true);</span>
<a href="#l7.473"></a><span id="l7.473" class="difflineplus">+  }</span>
<a href="#l7.474"></a><span id="l7.474"> </span>
<a href="#l7.475"></a><span id="l7.475" class="difflineminus">-    mc.tabmail.closeTab(2);</span>
<a href="#l7.476"></a><span id="l7.476" class="difflineminus">-    mc.tabmail.closeTab(2, true);</span>
<a href="#l7.477"></a><span id="l7.477" class="difflineminus">-    mc.tabmail.closeTab(2);</span>
<a href="#l7.478"></a><span id="l7.478" class="difflineplus">+  assert_number_of_tabs_open(16);</span>
<a href="#l7.479"></a><span id="l7.479" class="difflineplus">+    </span>
<a href="#l7.480"></a><span id="l7.480" class="difflineplus">+  switch_tab(2);</span>
<a href="#l7.481"></a><span id="l7.481" class="difflineplus">+  assert_selected_and_displayed(msgHdrsInFolder[1]);</span>
<a href="#l7.482"></a><span id="l7.482" class="difflineplus">+</span>
<a href="#l7.483"></a><span id="l7.483" class="difflineplus">+  // ... and store the tab titles, to ensure they match with the menu items.</span>
<a href="#l7.484"></a><span id="l7.484" class="difflineplus">+  let tabTitles = []</span>
<a href="#l7.485"></a><span id="l7.485" class="difflineplus">+  for (let idx = 0; idx &lt; 16; idx++)</span>
<a href="#l7.486"></a><span id="l7.486" class="difflineplus">+    tabTitles.unshift(mc.tabmail.tabInfo[idx].title);</span>
<a href="#l7.487"></a><span id="l7.487"> </span>
<a href="#l7.488"></a><span id="l7.488" class="difflineminus">-    assert_number_of_tabs_open(3);</span>
<a href="#l7.489"></a><span id="l7.489" class="difflineminus">-    assert_selected_and_displayed(mc, msgHdrsInFolder[4]);</span>
<a href="#l7.490"></a><span id="l7.490" class="difflineplus">+  // Start the test by closing all tabs except the first two tabs...</span>
<a href="#l7.491"></a><span id="l7.491" class="difflineplus">+  for (let idx = 0; idx &lt; 14; idx++)</span>
<a href="#l7.492"></a><span id="l7.492" class="difflineplus">+    mc.tabmail.closeTab(2);</span>
<a href="#l7.493"></a><span id="l7.493" class="difflineplus">+    </span>
<a href="#l7.494"></a><span id="l7.494" class="difflineplus">+  assert_number_of_tabs_open(2);</span>
<a href="#l7.495"></a><span id="l7.495" class="difflineplus">+    </span>
<a href="#l7.496"></a><span id="l7.496" class="difflineplus">+  // ...then open the context menu.</span>
<a href="#l7.497"></a><span id="l7.497" class="difflineplus">+  let menu = _synthesizeRecentlyClosedMenu();</span>
<a href="#l7.498"></a><span id="l7.498"> </span>
<a href="#l7.499"></a><span id="l7.499" class="difflineminus">-    mc.tabmail.undoCloseTab();</span>
<a href="#l7.500"></a><span id="l7.500" class="difflineminus">-    assert_number_of_tabs_open(4);</span>
<a href="#l7.501"></a><span id="l7.501" class="difflineminus">-    assert_selected_and_displayed(mc, msgHdrsInFolder[3]);</span>
<a href="#l7.502"></a><span id="l7.502" class="difflineplus">+  // Check if the context menu was populated correctly...</span>
<a href="#l7.503"></a><span id="l7.503" class="difflineplus">+  assert_true(menu.itemCount == 12, &quot;Failed to populate context menu&quot;);</span>
<a href="#l7.504"></a><span id="l7.504" class="difflineplus">+  for (let idx=0; idx &lt; 10; idx++)</span>
<a href="#l7.505"></a><span id="l7.505" class="difflineplus">+    assert_true(tabTitles[idx] == menu.getItemAtIndex(idx).label, </span>
<a href="#l7.506"></a><span id="l7.506" class="difflineplus">+        &quot;Tab Title does not match Menu item&quot;);</span>
<a href="#l7.507"></a><span id="l7.507" class="difflineplus">+    </span>
<a href="#l7.508"></a><span id="l7.508" class="difflineplus">+  // Restore the most recently closed tab</span>
<a href="#l7.509"></a><span id="l7.509" class="difflineplus">+  EventUtils.synthesizeMouse(menu.getItemAtIndex(0),5, 5, {},mc.window);</span>
<a href="#l7.510"></a><span id="l7.510" class="difflineplus">+  _teardownRecentlyClosedMenu();</span>
<a href="#l7.511"></a><span id="l7.511" class="difflineplus">+  </span>
<a href="#l7.512"></a><span id="l7.512" class="difflineplus">+  wait_for_message_display_completion(mc);</span>
<a href="#l7.513"></a><span id="l7.513" class="difflineplus">+  assert_number_of_tabs_open(3);</span>
<a href="#l7.514"></a><span id="l7.514" class="difflineplus">+  assert_selected_and_displayed(msgHdrsInFolder[14]);  </span>
<a href="#l7.515"></a><span id="l7.515"> </span>
<a href="#l7.516"></a><span id="l7.516" class="difflineminus">-    // msgHdrsInFolder[2] won't be restorend it was closed with disabled undo.</span>
<a href="#l7.517"></a><span id="l7.517" class="difflineplus">+  // The context menu should now contain one item less.</span>
<a href="#l7.518"></a><span id="l7.518" class="difflineplus">+  _synthesizeRecentlyClosedMenu();</span>
<a href="#l7.519"></a><span id="l7.519" class="difflineplus">+      </span>
<a href="#l7.520"></a><span id="l7.520"> </span>
<a href="#l7.521"></a><span id="l7.521" class="difflineminus">-    mc.tabmail.undoCloseTab();</span>
<a href="#l7.522"></a><span id="l7.522" class="difflineminus">-    assert_number_of_tabs_open(5);</span>
<a href="#l7.523"></a><span id="l7.523" class="difflineminus">-    assert_selected_and_displayed(mc, msgHdrsInFolder[1]);</span>
<a href="#l7.524"></a><span id="l7.524" class="difflineplus">+  assert_true(menu.itemCount == 11, &quot;Failed to populate context menu&quot;);</span>
<a href="#l7.525"></a><span id="l7.525" class="difflineplus">+  for (let idx=0; idx &lt; 9; idx++)</span>
<a href="#l7.526"></a><span id="l7.526" class="difflineplus">+    assert_true(tabTitles[idx+1] == menu.getItemAtIndex(idx).label, </span>
<a href="#l7.527"></a><span id="l7.527" class="difflineplus">+        &quot;Tab Title does not match Menu item&quot;);</span>
<a href="#l7.528"></a><span id="l7.528" class="difflineplus">+        </span>
<a href="#l7.529"></a><span id="l7.529" class="difflineplus">+  // Now we restore an &quot;random&quot; tab.  </span>
<a href="#l7.530"></a><span id="l7.530" class="difflineplus">+  EventUtils.synthesizeMouse(menu.getItemAtIndex(5),5, 5, {},mc.window);</span>
<a href="#l7.531"></a><span id="l7.531" class="difflineplus">+  _teardownRecentlyClosedMenu();</span>
<a href="#l7.532"></a><span id="l7.532" class="difflineplus">+   </span>
<a href="#l7.533"></a><span id="l7.533" class="difflineplus">+  wait_for_message_display_completion(mc);</span>
<a href="#l7.534"></a><span id="l7.534" class="difflineplus">+  assert_number_of_tabs_open(4);    </span>
<a href="#l7.535"></a><span id="l7.535" class="difflineplus">+  assert_selected_and_displayed(msgHdrsInFolder[8]);</span>
<a href="#l7.536"></a><span id="l7.536" class="difflineplus">+        </span>
<a href="#l7.537"></a><span id="l7.537" class="difflineplus">+  // finally restore all tabs </span>
<a href="#l7.538"></a><span id="l7.538" class="difflineplus">+  _synthesizeRecentlyClosedMenu();</span>
<a href="#l7.539"></a><span id="l7.539" class="difflineplus">+  </span>
<a href="#l7.540"></a><span id="l7.540" class="difflineplus">+  assert_true(menu.itemCount == 10, </span>
<a href="#l7.541"></a><span id="l7.541" class="difflineplus">+      &quot;Failed to populate context menu&quot;);</span>
<a href="#l7.542"></a><span id="l7.542" class="difflineplus">+  assert_true(tabTitles[1] == menu.getItemAtIndex(0).label,</span>
<a href="#l7.543"></a><span id="l7.543" class="difflineplus">+      &quot;Tab Title does not match Menu item&quot;);</span>
<a href="#l7.544"></a><span id="l7.544" class="difflineplus">+  assert_true(tabTitles[7] == menu.getItemAtIndex(5).label,</span>
<a href="#l7.545"></a><span id="l7.545" class="difflineplus">+      &quot;Tab Title does not match Menu item&quot;);</span>
<a href="#l7.546"></a><span id="l7.546" class="difflineplus">+    </span>
<a href="#l7.547"></a><span id="l7.547" class="difflineplus">+  EventUtils.synthesizeMouse(menu.getItemAtIndex(menu.itemCount-1),5, 5, {},mc.window);</span>
<a href="#l7.548"></a><span id="l7.548" class="difflineplus">+  _teardownRecentlyClosedMenu();</span>
<a href="#l7.549"></a><span id="l7.549" class="difflineplus">+  </span>
<a href="#l7.550"></a><span id="l7.550" class="difflineplus">+  wait_for_message_display_completion(mc);</span>
<a href="#l7.551"></a><span id="l7.551" class="difflineplus">+    </span>
<a href="#l7.552"></a><span id="l7.552" class="difflineplus">+  // out of the 16 tab, we closed all except two. As the history can store </span>
<a href="#l7.553"></a><span id="l7.553" class="difflineplus">+  // only 10 items we have to endup with exactly 10 + 2 tabs.</span>
<a href="#l7.554"></a><span id="l7.554" class="difflineplus">+  assert_number_of_tabs_open(12);    </span>
<a href="#l7.555"></a><span id="l7.555" class="difflineplus">+}</span>
<a href="#l7.556"></a><span id="l7.556"> </span>
<a href="#l7.557"></a><span id="l7.557" class="difflineplus">+function teardownTest(test)</span>
<a href="#l7.558"></a><span id="l7.558" class="difflineplus">+{</span>
<a href="#l7.559"></a><span id="l7.559" class="difflineplus">+  </span>
<a href="#l7.560"></a><span id="l7.560" class="difflineplus">+  switch(test)</span>
<a href="#l7.561"></a><span id="l7.561" class="difflineplus">+  {    </span>
<a href="#l7.562"></a><span id="l7.562" class="difflineplus">+    case test_tab_reorder_detach :</span>
<a href="#l7.563"></a><span id="l7.563" class="difflineplus">+    case test_tab_reorder_window :</span>
<a href="#l7.564"></a><span id="l7.564" class="difflineplus">+      // Some test cases open new windows, thus we need to ensure all </span>
<a href="#l7.565"></a><span id="l7.565" class="difflineplus">+      // opened windows get closed.</span>
<a href="#l7.566"></a><span id="l7.566" class="difflineplus">+</span>
<a href="#l7.567"></a><span id="l7.567" class="difflineplus">+      let en = Cc[&quot;@mozilla.org/appshell/window-mediator;1&quot;]</span>
<a href="#l7.568"></a><span id="l7.568" class="difflineplus">+                 .getService(Ci.nsIWindowMediator)</span>
<a href="#l7.569"></a><span id="l7.569" class="difflineplus">+                 .getEnumerator(&quot;mail:3pane&quot;);</span>
<a href="#l7.570"></a><span id="l7.570" class="difflineplus">+       </span>
<a href="#l7.571"></a><span id="l7.571" class="difflineplus">+       while(en.hasMoreElements()) {</span>
<a href="#l7.572"></a><span id="l7.572" class="difflineplus">+        </span>
<a href="#l7.573"></a><span id="l7.573" class="difflineplus">+         var win = en.getNext();</span>
<a href="#l7.574"></a><span id="l7.574" class="difflineplus">+         </span>
<a href="#l7.575"></a><span id="l7.575" class="difflineplus">+         if(win != mc.window)</span>
<a href="#l7.576"></a><span id="l7.576" class="difflineplus">+           close_window(new mozmill.controller.MozMillController(win));</span>
<a href="#l7.577"></a><span id="l7.577" class="difflineplus">+       }</span>
<a href="#l7.578"></a><span id="l7.578" class="difflineplus">+       </span>
<a href="#l7.579"></a><span id="l7.579" class="difflineplus">+       // fall through!</span>
<a href="#l7.580"></a><span id="l7.580" class="difflineplus">+</span>
<a href="#l7.581"></a><span id="l7.581" class="difflineplus">+    case test_tab_reorder_tabbar :</span>
<a href="#l7.582"></a><span id="l7.582" class="difflineplus">+        </span>
<a href="#l7.583"></a><span id="l7.583" class="difflineplus">+    case test_tab_recentlyClosed :</span>
<a href="#l7.584"></a><span id="l7.584" class="difflineplus">+    case test_tab_undo :</span>
<a href="#l7.585"></a><span id="l7.585" class="difflineplus">+    </span>
<a href="#l7.586"></a><span id="l7.586" class="difflineplus">+      // clean up the tabbbar </span>
<a href="#l7.587"></a><span id="l7.587" class="difflineplus">+      mc.tabmail.closeOtherTabs(0);</span>
<a href="#l7.588"></a><span id="l7.588" class="difflineplus">+      assert_number_of_tabs_open(1);</span>
<a href="#l7.589"></a><span id="l7.589">   }</span>
<a href="#l7.590"></a><span id="l7.590" class="difflineminus">-  finally  {</span>
<a href="#l7.591"></a><span id="l7.591" class="difflineminus">-    // finally close the tabs opened.</span>
<a href="#l7.592"></a><span id="l7.592" class="difflineminus">-    mc.tabmail.closeOtherTabs(0);</span>
<a href="#l7.593"></a><span id="l7.593" class="difflineminus">-    assert_number_of_tabs_open(1);</span>
<a href="#l7.594"></a><span id="l7.594" class="difflineminus">-  }</span>
<a href="#l7.595"></a><span id="l7.595" class="difflineplus">+  </span>
<a href="#l7.596"></a><span id="l7.596"> }</span>
<a href="#l7.597"></a><span id="l7.597"> </span>
<a href="#l7.598"></a><span id="l7.598"> /*</span>
<a href="#l7.599"></a><span id="l7.599">  * A set of private helper functions for drag'n'drop</span>
<a href="#l7.600"></a><span id="l7.600">  */</span>
<a href="#l7.601"></a><span id="l7.601"> </span>
<a href="#l7.602"></a><span id="l7.602"> /**</span>
<a href="#l7.603"></a><span id="l7.603">  * Starts a drag new session.</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

