<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 6300:cd6208fd054afea4295f0eb1d482844d822647b4</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ cd6208fd054afea4295f0eb1d482844d822647b4" />
<meta property="og:url" content="/comm-central/rev/cd6208fd054afea4295f0eb1d482844d822647b4" />
<meta property="og:description" content="Bug 592560 - Port changes from toolkit's browser_354894.js to SeaMonkey's browser_bug515006.js" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / cd6208fd054afea4295f0eb1d482844d822647b4 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/cd6208fd054afea4295f0eb1d482844d822647b4">shortlog</a> |
<a href="/comm-central/log/cd6208fd054afea4295f0eb1d482844d822647b4">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/cd6208fd054afea4295f0eb1d482844d822647b4">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/cd6208fd054afea4295f0eb1d482844d822647b4">files</a> |
changeset |
<a href="/comm-central/raw-rev/cd6208fd054afea4295f0eb1d482844d822647b4">raw</a>  | <a href="/comm-central/archive/cd6208fd054afea4295f0eb1d482844d822647b4.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=592560">Bug 592560</a> - Port changes from toolkit's browser_354894.js to SeaMonkey's browser_bug515006.js
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#73;&#97;&#110;&#32;&#78;&#101;&#97;&#108;&#32;&#60;&#105;&#97;&#110;&#110;&#95;&#99;&#118;&#115;&#64;&#98;&#108;&#117;&#101;&#121;&#111;&#110;&#100;&#101;&#114;&#46;&#99;&#111;&#46;&#117;&#107;&#62;</td></tr>
<tr><td></td><td class="date age">Wed, 01 Sep 2010 13:26:43 +0100</td></tr>

<tr>
 <td>changeset 6300</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/cd6208fd054afea4295f0eb1d482844d822647b4">cd6208fd054afea4295f0eb1d482844d822647b4</a></td>
</tr>



<tr>
<td>parent 6299</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/7565800b5864faae3f75a418bcd4600630b8e496">7565800b5864faae3f75a418bcd4600630b8e496</a>
</td>
</tr>

<tr>
<td>child 6301</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/b49156134c1588411ca2cb3d2edb3467823e1844">b49156134c1588411ca2cb3d2edb3467823e1844</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=cd6208fd054afea4295f0eb1d482844d822647b4">4861</a></td></tr>
<tr><td>push user</td><td>iann_cvs@blueyonder.co.uk</td></tr>
<tr><td>push date</td><td class="date age">Wed, 01 Sep 2010 12:26:54 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@cd6208fd054a [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=cd6208fd054afea4295f0eb1d482844d822647b4">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=cd6208fd054afea4295f0eb1d482844d822647b4&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=cd6208fd054afea4295f0eb1d482844d822647b4&newProject=comm-central&newRevision=cd6208fd054afea4295f0eb1d482844d822647b4&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=cd6208fd054afea4295f0eb1d482844d822647b4&newProject=comm-central&newRevision=cd6208fd054afea4295f0eb1d482844d822647b4&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=cd6208fd054afea4295f0eb1d482844d822647b4&newProject=comm-central&newRevision=cd6208fd054afea4295f0eb1d482844d822647b4&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>

<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=592560">592560</a>, <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=515006">515006</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=592560">Bug 592560</a> - Port changes from toolkit's browser_354894.js to SeaMonkey's browser_bug515006.js
r=neil (NPODB)</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/cd6208fd054afea4295f0eb1d482844d822647b4/suite/common/tests/browser/browser_bug515006.js">suite/common/tests/browser/browser_bug515006.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/cd6208fd054afea4295f0eb1d482844d822647b4/suite/common/tests/browser/browser_bug515006.js">file</a> |
<a href="/comm-central/annotate/cd6208fd054afea4295f0eb1d482844d822647b4/suite/common/tests/browser/browser_bug515006.js">annotate</a> |
<a href="/comm-central/diff/cd6208fd054afea4295f0eb1d482844d822647b4/suite/common/tests/browser/browser_bug515006.js">diff</a> |
<a href="/comm-central/comparison/cd6208fd054afea4295f0eb1d482844d822647b4/suite/common/tests/browser/browser_bug515006.js">comparison</a> |
<a href="/comm-central/log/cd6208fd054afea4295f0eb1d482844d822647b4/suite/common/tests/browser/browser_bug515006.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/suite/common/tests/browser/browser_bug515006.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/suite/common/tests/browser/browser_bug515006.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -89,23 +89,45 @@</span>
<a href="#l1.4"></a><span id="l1.4">  * @note Mac only tests the new notifications, as restoring the last window is</span>
<a href="#l1.5"></a><span id="l1.5">  * not enabled on that platform (platform shim; the application is kept running</span>
<a href="#l1.6"></a><span id="l1.6">  * although there are no windows left)</span>
<a href="#l1.7"></a><span id="l1.7">  * @note There is a difference when closing a browser window with</span>
<a href="#l1.8"></a><span id="l1.8">  * BrowserTryToCloseWindow() as opposed to close(). The former will make</span>
<a href="#l1.9"></a><span id="l1.9">  * nsSessionStore restore a window next time it gets a chance and will post</span>
<a href="#l1.10"></a><span id="l1.10">  * notifications. The latter won't.</span>
<a href="#l1.11"></a><span id="l1.11">  */</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+function browserWindowsCount(expected, msg) {</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+  if (typeof expected == &quot;number&quot;)</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+    expected = [expected, expected];</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineplus">+  let count = 0;</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineplus">+  let e = Services.wm.getEnumerator(&quot;navigator:browser&quot;);</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineplus">+  while (e.hasMoreElements()) {</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineplus">+    if (!e.getNext().closed)</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineplus">+      ++count;</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineplus">+  }</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineplus">+  is(count, expected[0], msg + &quot; (nsIWindowMediator)&quot;);</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineplus">+  let state = Components.classes[&quot;@mozilla.org/suite/sessionstore;1&quot;]</span>
<a href="#l1.24"></a><span id="l1.24" class="difflineplus">+                        .getService(Components.interfaces.nsISessionStore)</span>
<a href="#l1.25"></a><span id="l1.25" class="difflineplus">+                        .getBrowserState();</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineplus">+  is(JSON.parse(state).windows.length, expected[1], msg + &quot; (getBrowserState)&quot;);</span>
<a href="#l1.27"></a><span id="l1.27" class="difflineplus">+}</span>
<a href="#l1.28"></a><span id="l1.28" class="difflineplus">+</span>
<a href="#l1.29"></a><span id="l1.29"> function test() {</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineplus">+  browserWindowsCount(1, &quot;Only one browser window should be open initially&quot;);</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineplus">+</span>
<a href="#l1.32"></a><span id="l1.32">   if (navigator.platform.match(/Mac/)) {</span>
<a href="#l1.33"></a><span id="l1.33">     todo(false, &quot;Test disabled on MacOSX. (Bug 520787)&quot;);</span>
<a href="#l1.34"></a><span id="l1.34">     return;</span>
<a href="#l1.35"></a><span id="l1.35">   }</span>
<a href="#l1.36"></a><span id="l1.36"> </span>
<a href="#l1.37"></a><span id="l1.37">   waitForExplicitFinish();</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineplus">+  // This test takes some time to run, and it could timeout randomly.</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineplus">+  // So we require a longer timeout. See bug 528219.</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineplus">+  requestLongerTimeout(2);</span>
<a href="#l1.41"></a><span id="l1.41"> </span>
<a href="#l1.42"></a><span id="l1.42">   // Some urls that might be opened in tabs and/or popups</span>
<a href="#l1.43"></a><span id="l1.43">   // Do not use about:blank:</span>
<a href="#l1.44"></a><span id="l1.44">   // That one is reserved for special purposes in the tests</span>
<a href="#l1.45"></a><span id="l1.45">   const TEST_URLS = [&quot;about:mozilla&quot;, &quot;about:buildconfig&quot;];</span>
<a href="#l1.46"></a><span id="l1.46"> </span>
<a href="#l1.47"></a><span id="l1.47">   // Number of -request notifications to except</span>
<a href="#l1.48"></a><span id="l1.48">   // remember to adjust when adding new tests</span>
<a href="#l1.49"></a><span id="l1.49" class="difflineat">@@ -116,19 +138,17 @@ function test() {</span>
<a href="#l1.50"></a><span id="l1.50"> </span>
<a href="#l1.51"></a><span id="l1.51">   // Window features of browser windows</span>
<a href="#l1.52"></a><span id="l1.52">   const CHROME_FEATURES = &quot;chrome,all,dialog=no&quot;;</span>
<a href="#l1.53"></a><span id="l1.53"> </span>
<a href="#l1.54"></a><span id="l1.54">   // Store the old window type for cleanup</span>
<a href="#l1.55"></a><span id="l1.55">   var oldWinType = &quot;&quot;;</span>
<a href="#l1.56"></a><span id="l1.56">   // Store the old tabs.warnOnClose pref so that we may reset it during</span>
<a href="#l1.57"></a><span id="l1.57">   // cleanup</span>
<a href="#l1.58"></a><span id="l1.58" class="difflineminus">-  var gPrefService = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l1.59"></a><span id="l1.59" class="difflineminus">-                               .getService(Components.interfaces.nsIPrefBranch);</span>
<a href="#l1.60"></a><span id="l1.60" class="difflineminus">-  var oldWarnTabsOnClose = gPrefService.getBoolPref(&quot;browser.tabs.warnOnClose&quot;);</span>
<a href="#l1.61"></a><span id="l1.61" class="difflineplus">+  var oldWarnTabsOnClose = Services.prefs.getBoolPref(&quot;browser.tabs.warnOnClose&quot;);</span>
<a href="#l1.62"></a><span id="l1.62"> </span>
<a href="#l1.63"></a><span id="l1.63">   // Observe these, and also use to count the number of hits</span>
<a href="#l1.64"></a><span id="l1.64">   var observing = {</span>
<a href="#l1.65"></a><span id="l1.65">     &quot;browser-lastwindow-close-requested&quot;: 0,</span>
<a href="#l1.66"></a><span id="l1.66">     &quot;browser-lastwindow-close-granted&quot;: 0</span>
<a href="#l1.67"></a><span id="l1.67">   };</span>
<a href="#l1.68"></a><span id="l1.68"> </span>
<a href="#l1.69"></a><span id="l1.69">   /**</span>
<a href="#l1.70"></a><span id="l1.70" class="difflineat">@@ -143,59 +163,55 @@ function test() {</span>
<a href="#l1.71"></a><span id="l1.71"> </span>
<a href="#l1.72"></a><span id="l1.72">       // handle some tests</span>
<a href="#l1.73"></a><span id="l1.73">       if (++this.hitCount == 1) {</span>
<a href="#l1.74"></a><span id="l1.74">         // Test 6</span>
<a href="#l1.75"></a><span id="l1.75">         aCancel.QueryInterface(Components.interfaces.nsISupportsPRBool).data = true;</span>
<a href="#l1.76"></a><span id="l1.76">       }</span>
<a href="#l1.77"></a><span id="l1.77">     }</span>
<a href="#l1.78"></a><span id="l1.78">   };</span>
<a href="#l1.79"></a><span id="l1.79" class="difflineminus">-  var observerService = Components.classes[&quot;@mozilla.org/observer-service;1&quot;]</span>
<a href="#l1.80"></a><span id="l1.80" class="difflineminus">-                                  .getService(Components.interfaces.nsIObserverService);</span>
<a href="#l1.81"></a><span id="l1.81"> </span>
<a href="#l1.82"></a><span id="l1.82">   /**</span>
<a href="#l1.83"></a><span id="l1.83">    * Helper: Sets prefs as the testsuite requires</span>
<a href="#l1.84"></a><span id="l1.84">    * @note Will be reset in cleanTestSuite just before finishing the tests</span>
<a href="#l1.85"></a><span id="l1.85">    */</span>
<a href="#l1.86"></a><span id="l1.86">   function setPrefs() {</span>
<a href="#l1.87"></a><span id="l1.87" class="difflineminus">-    gPrefService.setIntPref(&quot;browser.startup.page&quot;, 3);</span>
<a href="#l1.88"></a><span id="l1.88" class="difflineminus">-    gPrefService.setBoolPref(&quot;browser.tabs.warnOnClose&quot;, false);</span>
<a href="#l1.89"></a><span id="l1.89" class="difflineplus">+    Services.prefs.setIntPref(&quot;browser.startup.page&quot;, 3);</span>
<a href="#l1.90"></a><span id="l1.90" class="difflineplus">+    Services.prefs.setBoolPref(&quot;browser.tabs.warnOnClose&quot;, false);</span>
<a href="#l1.91"></a><span id="l1.91">   }</span>
<a href="#l1.92"></a><span id="l1.92"> </span>
<a href="#l1.93"></a><span id="l1.93">   /**</span>
<a href="#l1.94"></a><span id="l1.94">    * Helper: Sets up this testsuite</span>
<a href="#l1.95"></a><span id="l1.95">    */</span>
<a href="#l1.96"></a><span id="l1.96">   function setupTestsuite(testFn) {</span>
<a href="#l1.97"></a><span id="l1.97">     // Register our observers</span>
<a href="#l1.98"></a><span id="l1.98" class="difflineminus">-    for (let o in observing) {</span>
<a href="#l1.99"></a><span id="l1.99" class="difflineminus">-      observerService.addObserver(observer, o, false);</span>
<a href="#l1.100"></a><span id="l1.100" class="difflineminus">-    }</span>
<a href="#l1.101"></a><span id="l1.101" class="difflineplus">+    for (let o in observing)</span>
<a href="#l1.102"></a><span id="l1.102" class="difflineplus">+      Services.obs.addObserver(observer, o, false);</span>
<a href="#l1.103"></a><span id="l1.103"> </span>
<a href="#l1.104"></a><span id="l1.104">     // Make the main test window not count as a browser window any longer</span>
<a href="#l1.105"></a><span id="l1.105">     oldWinType = document.documentElement.getAttribute(&quot;windowtype&quot;);</span>
<a href="#l1.106"></a><span id="l1.106">     document.documentElement.setAttribute(&quot;windowtype&quot;, &quot;navigator:testrunner&quot;);</span>
<a href="#l1.107"></a><span id="l1.107">   }</span>
<a href="#l1.108"></a><span id="l1.108"> </span>
<a href="#l1.109"></a><span id="l1.109">   /**</span>
<a href="#l1.110"></a><span id="l1.110">    * Helper: Cleans up behind the testsuite</span>
<a href="#l1.111"></a><span id="l1.111">    */</span>
<a href="#l1.112"></a><span id="l1.112">   function cleanupTestsuite(callback) {</span>
<a href="#l1.113"></a><span id="l1.113">     // Finally remove observers again</span>
<a href="#l1.114"></a><span id="l1.114" class="difflineminus">-    for (let o in observing) {</span>
<a href="#l1.115"></a><span id="l1.115" class="difflineminus">-      observerService.removeObserver(observer, o, false);</span>
<a href="#l1.116"></a><span id="l1.116" class="difflineminus">-    }</span>
<a href="#l1.117"></a><span id="l1.117" class="difflineplus">+    for (let o in observing)</span>
<a href="#l1.118"></a><span id="l1.118" class="difflineplus">+      Services.obs.removeObserver(observer, o, false);</span>
<a href="#l1.119"></a><span id="l1.119" class="difflineplus">+</span>
<a href="#l1.120"></a><span id="l1.120">     // Reset the prefs we touched</span>
<a href="#l1.121"></a><span id="l1.121">     for each (let pref in [</span>
<a href="#l1.122"></a><span id="l1.122">       &quot;browser.startup.page&quot;</span>
<a href="#l1.123"></a><span id="l1.123">     ]) {</span>
<a href="#l1.124"></a><span id="l1.124" class="difflineminus">-      if (gPrefService.prefHasUserValue(pref)) {</span>
<a href="#l1.125"></a><span id="l1.125" class="difflineminus">-        gPrefService.clearUserPref(pref);</span>
<a href="#l1.126"></a><span id="l1.126" class="difflineminus">-      }</span>
<a href="#l1.127"></a><span id="l1.127" class="difflineplus">+      if (Services.prefs.prefHasUserValue(pref))</span>
<a href="#l1.128"></a><span id="l1.128" class="difflineplus">+        Services.prefs.clearUserPref(pref);</span>
<a href="#l1.129"></a><span id="l1.129">     }</span>
<a href="#l1.130"></a><span id="l1.130" class="difflineminus">-    gPrefService.setBoolPref(&quot;browser.tabs.warnOnClose&quot;, oldWarnTabsOnClose);</span>
<a href="#l1.131"></a><span id="l1.131" class="difflineplus">+    Services.prefs.setBoolPref(&quot;browser.tabs.warnOnClose&quot;, oldWarnTabsOnClose);</span>
<a href="#l1.132"></a><span id="l1.132"> </span>
<a href="#l1.133"></a><span id="l1.133">     // Reset the window type</span>
<a href="#l1.134"></a><span id="l1.134">     document.documentElement.setAttribute(&quot;windowtype&quot;, oldWinType);</span>
<a href="#l1.135"></a><span id="l1.135">   }</span>
<a href="#l1.136"></a><span id="l1.136"> </span>
<a href="#l1.137"></a><span id="l1.137">   /**</span>
<a href="#l1.138"></a><span id="l1.138">    * Helper: sets the prefs and a new window with our test tabs</span>
<a href="#l1.139"></a><span id="l1.139">    */</span>
<a href="#l1.140"></a><span id="l1.140" class="difflineat">@@ -307,16 +323,17 @@ function test() {</span>
<a href="#l1.141"></a><span id="l1.141">   function testOpenCloseOnlyPopup(nextFn) {</span>
<a href="#l1.142"></a><span id="l1.142">     // prepare the prefs</span>
<a href="#l1.143"></a><span id="l1.143">     setPrefs();</span>
<a href="#l1.144"></a><span id="l1.144"> </span>
<a href="#l1.145"></a><span id="l1.145">     // This will cause nsSessionStore to restore a window the next time it</span>
<a href="#l1.146"></a><span id="l1.146">     // gets a chance.</span>
<a href="#l1.147"></a><span id="l1.147">     let popup = openDialog(location, &quot;popup&quot;, POPUP_FEATURES, TEST_URLS[1]);</span>
<a href="#l1.148"></a><span id="l1.148">     popup.addEventListener(&quot;load&quot;, function() {</span>
<a href="#l1.149"></a><span id="l1.149" class="difflineplus">+      this.removeEventListener(&quot;load&quot;, arguments.callee, true);</span>
<a href="#l1.150"></a><span id="l1.150">       is(popup.getBrowser().browsers.length, 1,</span>
<a href="#l1.151"></a><span id="l1.151">          &quot;Did not restore the popup window (1)&quot;);</span>
<a href="#l1.152"></a><span id="l1.152">       popup.BrowserTryToCloseWindow();</span>
<a href="#l1.153"></a><span id="l1.153"> </span>
<a href="#l1.154"></a><span id="l1.154">       // Real tests</span>
<a href="#l1.155"></a><span id="l1.155">       popup = openDialog(location, &quot;popup&quot;, POPUP_FEATURES, TEST_URLS[1]);</span>
<a href="#l1.156"></a><span id="l1.156">       popup.addEventListener(&quot;load&quot;, function() {</span>
<a href="#l1.157"></a><span id="l1.157">         popup.removeEventListener(&quot;load&quot;, arguments.callee, false);</span>
<a href="#l1.158"></a><span id="l1.158" class="difflineat">@@ -359,31 +376,37 @@ function test() {</span>
<a href="#l1.159"></a><span id="l1.159">    * @note: Non-Mac only</span>
<a href="#l1.160"></a><span id="l1.160">    */</span>
<a href="#l1.161"></a><span id="l1.161">   function testOpenCloseRestoreFromPopup(nextFn) {</span>
<a href="#l1.162"></a><span id="l1.162">     setupTestAndRun(function(newWin) {</span>
<a href="#l1.163"></a><span id="l1.163">       setupTestAndRun(function(newWin2) {</span>
<a href="#l1.164"></a><span id="l1.164">         newWin.BrowserTryToCloseWindow();</span>
<a href="#l1.165"></a><span id="l1.165">         newWin2.BrowserTryToCloseWindow();</span>
<a href="#l1.166"></a><span id="l1.166"> </span>
<a href="#l1.167"></a><span id="l1.167" class="difflineplus">+        browserWindowsCount([0, 1], &quot;browser windows while running testOpenCloseRestoreFromPopup&quot;);</span>
<a href="#l1.168"></a><span id="l1.168" class="difflineplus">+</span>
<a href="#l1.169"></a><span id="l1.169">         newWin = undoCloseWindow(0);</span>
<a href="#l1.170"></a><span id="l1.170"> </span>
<a href="#l1.171"></a><span id="l1.171">         newWin2 = openDialog(location, &quot;_blank&quot;, CHROME_FEATURES, &quot;about:blank&quot;);</span>
<a href="#l1.172"></a><span id="l1.172">         newWin2.addEventListener(&quot;load&quot;, function() {</span>
<a href="#l1.173"></a><span id="l1.173">           newWin2.removeEventListener(&quot;load&quot;, arguments.callee, true);</span>
<a href="#l1.174"></a><span id="l1.174">           executeSoon(function() {</span>
<a href="#l1.175"></a><span id="l1.175">             is(newWin2.getBrowser().browsers.length, 1,</span>
<a href="#l1.176"></a><span id="l1.176">                &quot;Did not restore, as undoCloseWindow() was last called&quot;);</span>
<a href="#l1.177"></a><span id="l1.177">             is(TEST_URLS.indexOf(newWin2.getBrowser().browsers[0].currentURI.spec), -1,</span>
<a href="#l1.178"></a><span id="l1.178">                &quot;Did not restore, as undoCloseWindow() was last called (2)&quot;);</span>
<a href="#l1.179"></a><span id="l1.179"> </span>
<a href="#l1.180"></a><span id="l1.180" class="difflineplus">+            browserWindowsCount([2, 3], &quot;browser windows while running testOpenCloseRestoreFromPopup&quot;);</span>
<a href="#l1.181"></a><span id="l1.181" class="difflineplus">+</span>
<a href="#l1.182"></a><span id="l1.182">             // Cleanup</span>
<a href="#l1.183"></a><span id="l1.183">             newWin.close();</span>
<a href="#l1.184"></a><span id="l1.184">             newWin2.close();</span>
<a href="#l1.185"></a><span id="l1.185"> </span>
<a href="#l1.186"></a><span id="l1.186" class="difflineplus">+            browserWindowsCount([0, 1], &quot;browser windows while running testOpenCloseRestoreFromPopup&quot;);</span>
<a href="#l1.187"></a><span id="l1.187" class="difflineplus">+</span>
<a href="#l1.188"></a><span id="l1.188">             // Next please</span>
<a href="#l1.189"></a><span id="l1.189">             executeSoon(nextFn);</span>
<a href="#l1.190"></a><span id="l1.190">           });</span>
<a href="#l1.191"></a><span id="l1.191">         }, true);</span>
<a href="#l1.192"></a><span id="l1.192">       });</span>
<a href="#l1.193"></a><span id="l1.193">     });</span>
<a href="#l1.194"></a><span id="l1.194">   }</span>
<a href="#l1.195"></a><span id="l1.195"> </span>
<a href="#l1.196"></a><span id="l1.196" class="difflineat">@@ -434,29 +457,37 @@ function test() {</span>
<a href="#l1.197"></a><span id="l1.197">     });</span>
<a href="#l1.198"></a><span id="l1.198">   }</span>
<a href="#l1.199"></a><span id="l1.199"> </span>
<a href="#l1.200"></a><span id="l1.200">   // Execution starts here</span>
<a href="#l1.201"></a><span id="l1.201"> </span>
<a href="#l1.202"></a><span id="l1.202">   setupTestsuite();</span>
<a href="#l1.203"></a><span id="l1.203">   if (navigator.platform.match(/Mac/)) {</span>
<a href="#l1.204"></a><span id="l1.204">     // Mac tests</span>
<a href="#l1.205"></a><span id="l1.205" class="difflineminus">-    testMacNotifications(</span>
<a href="#l1.206"></a><span id="l1.206" class="difflineminus">-      function() testNotificationCount(</span>
<a href="#l1.207"></a><span id="l1.207" class="difflineminus">-        function() cleanupTestsuite() + finish()</span>
<a href="#l1.208"></a><span id="l1.208" class="difflineminus">-      )</span>
<a href="#l1.209"></a><span id="l1.209" class="difflineminus">-    );</span>
<a href="#l1.210"></a><span id="l1.210" class="difflineplus">+    testMacNotifications(function () {</span>
<a href="#l1.211"></a><span id="l1.211" class="difflineplus">+      testNotificationCount(function () {</span>
<a href="#l1.212"></a><span id="l1.212" class="difflineplus">+        cleanupTestsuite();</span>
<a href="#l1.213"></a><span id="l1.213" class="difflineplus">+        browserWindowsCount(1, &quot;Only one browser window should be open eventually&quot;);</span>
<a href="#l1.214"></a><span id="l1.214" class="difflineplus">+        finish();</span>
<a href="#l1.215"></a><span id="l1.215" class="difflineplus">+      });</span>
<a href="#l1.216"></a><span id="l1.216" class="difflineplus">+    });</span>
<a href="#l1.217"></a><span id="l1.217">   }</span>
<a href="#l1.218"></a><span id="l1.218">   else {</span>
<a href="#l1.219"></a><span id="l1.219">     // Non-Mac Tests</span>
<a href="#l1.220"></a><span id="l1.220" class="difflineminus">-    testOpenCloseNormal(</span>
<a href="#l1.221"></a><span id="l1.221" class="difflineminus">-      function() testOpenCloseWindowAndPopup(</span>
<a href="#l1.222"></a><span id="l1.222" class="difflineminus">-        function() testOpenCloseOnlyPopup(</span>
<a href="#l1.223"></a><span id="l1.223" class="difflineminus">-          function() testOpenCloseRestoreFromPopup (</span>
<a href="#l1.224"></a><span id="l1.224" class="difflineminus">-            function() testNotificationCount(</span>
<a href="#l1.225"></a><span id="l1.225" class="difflineminus">-              function() cleanupTestsuite() + finish()</span>
<a href="#l1.226"></a><span id="l1.226" class="difflineminus">-            )</span>
<a href="#l1.227"></a><span id="l1.227" class="difflineminus">-          )</span>
<a href="#l1.228"></a><span id="l1.228" class="difflineminus">-        )</span>
<a href="#l1.229"></a><span id="l1.229" class="difflineminus">-      )</span>
<a href="#l1.230"></a><span id="l1.230" class="difflineminus">-    );</span>
<a href="#l1.231"></a><span id="l1.231" class="difflineplus">+    testOpenCloseNormal(function () {</span>
<a href="#l1.232"></a><span id="l1.232" class="difflineplus">+      browserWindowsCount([0, 1], &quot;browser windows after testOpenCloseNormal&quot;);</span>
<a href="#l1.233"></a><span id="l1.233" class="difflineplus">+      testOpenCloseWindowAndPopup(function () {</span>
<a href="#l1.234"></a><span id="l1.234" class="difflineplus">+        browserWindowsCount([0, 1], &quot;browser windows after testOpenCloseWindowAndPopup&quot;);</span>
<a href="#l1.235"></a><span id="l1.235" class="difflineplus">+        testOpenCloseOnlyPopup(function () {</span>
<a href="#l1.236"></a><span id="l1.236" class="difflineplus">+          browserWindowsCount([0, 1], &quot;browser windows after testOpenCloseOnlyPopup&quot;);</span>
<a href="#l1.237"></a><span id="l1.237" class="difflineplus">+          testOpenCloseRestoreFromPopup(function () {</span>
<a href="#l1.238"></a><span id="l1.238" class="difflineplus">+            browserWindowsCount([0, 1], &quot;browser windows after testOpenCloseRestoreFromPopup&quot;);</span>
<a href="#l1.239"></a><span id="l1.239" class="difflineplus">+            testNotificationCount(function () {</span>
<a href="#l1.240"></a><span id="l1.240" class="difflineplus">+              cleanupTestsuite();</span>
<a href="#l1.241"></a><span id="l1.241" class="difflineplus">+              browserWindowsCount(1, &quot;browser windows after testNotificationCount&quot;);</span>
<a href="#l1.242"></a><span id="l1.242" class="difflineplus">+              finish();</span>
<a href="#l1.243"></a><span id="l1.243" class="difflineplus">+            });</span>
<a href="#l1.244"></a><span id="l1.244" class="difflineplus">+          });</span>
<a href="#l1.245"></a><span id="l1.245" class="difflineplus">+        });</span>
<a href="#l1.246"></a><span id="l1.246" class="difflineplus">+      });</span>
<a href="#l1.247"></a><span id="l1.247" class="difflineplus">+    });</span>
<a href="#l1.248"></a><span id="l1.248">   }</span>
<a href="#l1.249"></a><span id="l1.249"> }</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

