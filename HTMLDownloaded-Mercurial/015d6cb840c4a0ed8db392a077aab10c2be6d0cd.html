<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 23135:015d6cb840c4a0ed8db392a077aab10c2be6d0cd</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 015d6cb840c4a0ed8db392a077aab10c2be6d0cd" />
<meta property="og:url" content="/comm-central/rev/015d6cb840c4a0ed8db392a077aab10c2be6d0cd" />
<meta property="og:description" content="Bug 1408662 - Move date/time/timezone related functions into calDateTimeUtils.jsm - manual changes. r=MakeMyDay" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 015d6cb840c4a0ed8db392a077aab10c2be6d0cd 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/015d6cb840c4a0ed8db392a077aab10c2be6d0cd">shortlog</a> |
<a href="/comm-central/log/015d6cb840c4a0ed8db392a077aab10c2be6d0cd">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/015d6cb840c4a0ed8db392a077aab10c2be6d0cd">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/015d6cb840c4a0ed8db392a077aab10c2be6d0cd">files</a> |
changeset |
<a href="/comm-central/raw-rev/015d6cb840c4a0ed8db392a077aab10c2be6d0cd">raw</a>  | <a href="/comm-central/archive/015d6cb840c4a0ed8db392a077aab10c2be6d0cd.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1408662">Bug 1408662</a> - Move date/time/timezone related functions into calDateTimeUtils.jsm - manual changes. r=MakeMyDay
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#80;&#104;&#105;&#108;&#105;&#112;&#112;&#32;&#75;&#101;&#119;&#105;&#115;&#99;&#104;&#32;&#60;&#109;&#111;&#122;&#105;&#108;&#108;&#97;&#64;&#107;&#101;&#119;&#105;&#115;&#46;&#99;&#104;&#62;</td></tr>
<tr><td></td><td class="date age">Fri, 13 Oct 2017 20:27:54 +0200</td></tr>

<tr>
 <td>changeset 23135</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/015d6cb840c4a0ed8db392a077aab10c2be6d0cd">015d6cb840c4a0ed8db392a077aab10c2be6d0cd</a></td>
</tr>



<tr>
<td>parent 23134</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/ec015f717cb05fdf8d6057a6526d8cdce9378eb5">ec015f717cb05fdf8d6057a6526d8cdce9378eb5</a>
</td>
</tr>

<tr>
<td>child 23136</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/18938fc0dd706992c6fd9fec8baddee302b2cd45">18938fc0dd706992c6fd9fec8baddee302b2cd45</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=015d6cb840c4a0ed8db392a077aab10c2be6d0cd">13994</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Mon, 22 Jan 2018 11:31:46 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@18938fc0dd70 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=18938fc0dd706992c6fd9fec8baddee302b2cd45">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=18938fc0dd706992c6fd9fec8baddee302b2cd45&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=18938fc0dd706992c6fd9fec8baddee302b2cd45&newProject=comm-central&newRevision=d10e311b217af59593eb04d57be03fca16df6281&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=18938fc0dd706992c6fd9fec8baddee302b2cd45&newProject=comm-central&newRevision=d10e311b217af59593eb04d57be03fca16df6281&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=18938fc0dd706992c6fd9fec8baddee302b2cd45&newProject=comm-central&newRevision=d10e311b217af59593eb04d57be03fca16df6281&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28MakeMyDay%29&revcount=50">MakeMyDay</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1408662">1408662</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1408662">Bug 1408662</a> - Move date/time/timezone related functions into calDateTimeUtils.jsm - manual changes. r=MakeMyDay

MozReview-Commit-ID: Ks5ufwa5YhW</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/015d6cb840c4a0ed8db392a077aab10c2be6d0cd/calendar/base/modules/calDateTimeUtils.jsm">calendar/base/modules/calDateTimeUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/015d6cb840c4a0ed8db392a077aab10c2be6d0cd/calendar/base/modules/calDateTimeUtils.jsm">file</a> |
<a href="/comm-central/annotate/015d6cb840c4a0ed8db392a077aab10c2be6d0cd/calendar/base/modules/calDateTimeUtils.jsm">annotate</a> |
<a href="/comm-central/diff/015d6cb840c4a0ed8db392a077aab10c2be6d0cd/calendar/base/modules/calDateTimeUtils.jsm">diff</a> |
<a href="/comm-central/comparison/015d6cb840c4a0ed8db392a077aab10c2be6d0cd/calendar/base/modules/calDateTimeUtils.jsm">comparison</a> |
<a href="/comm-central/log/015d6cb840c4a0ed8db392a077aab10c2be6d0cd/calendar/base/modules/calDateTimeUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/015d6cb840c4a0ed8db392a077aab10c2be6d0cd/calendar/base/modules/calUtils.jsm">calendar/base/modules/calUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/015d6cb840c4a0ed8db392a077aab10c2be6d0cd/calendar/base/modules/calUtils.jsm">file</a> |
<a href="/comm-central/annotate/015d6cb840c4a0ed8db392a077aab10c2be6d0cd/calendar/base/modules/calUtils.jsm">annotate</a> |
<a href="/comm-central/diff/015d6cb840c4a0ed8db392a077aab10c2be6d0cd/calendar/base/modules/calUtils.jsm">diff</a> |
<a href="/comm-central/comparison/015d6cb840c4a0ed8db392a077aab10c2be6d0cd/calendar/base/modules/calUtils.jsm">comparison</a> |
<a href="/comm-central/log/015d6cb840c4a0ed8db392a077aab10c2be6d0cd/calendar/base/modules/calUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/015d6cb840c4a0ed8db392a077aab10c2be6d0cd/calendar/base/modules/calUtilsCompat.jsm">calendar/base/modules/calUtilsCompat.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/015d6cb840c4a0ed8db392a077aab10c2be6d0cd/calendar/base/modules/calUtilsCompat.jsm">file</a> |
<a href="/comm-central/annotate/015d6cb840c4a0ed8db392a077aab10c2be6d0cd/calendar/base/modules/calUtilsCompat.jsm">annotate</a> |
<a href="/comm-central/diff/015d6cb840c4a0ed8db392a077aab10c2be6d0cd/calendar/base/modules/calUtilsCompat.jsm">diff</a> |
<a href="/comm-central/comparison/015d6cb840c4a0ed8db392a077aab10c2be6d0cd/calendar/base/modules/calUtilsCompat.jsm">comparison</a> |
<a href="/comm-central/log/015d6cb840c4a0ed8db392a077aab10c2be6d0cd/calendar/base/modules/calUtilsCompat.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/015d6cb840c4a0ed8db392a077aab10c2be6d0cd/calendar/base/modules/moz.build">calendar/base/modules/moz.build</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/015d6cb840c4a0ed8db392a077aab10c2be6d0cd/calendar/base/modules/moz.build">file</a> |
<a href="/comm-central/annotate/015d6cb840c4a0ed8db392a077aab10c2be6d0cd/calendar/base/modules/moz.build">annotate</a> |
<a href="/comm-central/diff/015d6cb840c4a0ed8db392a077aab10c2be6d0cd/calendar/base/modules/moz.build">diff</a> |
<a href="/comm-central/comparison/015d6cb840c4a0ed8db392a077aab10c2be6d0cd/calendar/base/modules/moz.build">comparison</a> |
<a href="/comm-central/log/015d6cb840c4a0ed8db392a077aab10c2be6d0cd/calendar/base/modules/moz.build">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/015d6cb840c4a0ed8db392a077aab10c2be6d0cd/calendar/base/src/calIcsParser.js">calendar/base/src/calIcsParser.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/015d6cb840c4a0ed8db392a077aab10c2be6d0cd/calendar/base/src/calIcsParser.js">file</a> |
<a href="/comm-central/annotate/015d6cb840c4a0ed8db392a077aab10c2be6d0cd/calendar/base/src/calIcsParser.js">annotate</a> |
<a href="/comm-central/diff/015d6cb840c4a0ed8db392a077aab10c2be6d0cd/calendar/base/src/calIcsParser.js">diff</a> |
<a href="/comm-central/comparison/015d6cb840c4a0ed8db392a077aab10c2be6d0cd/calendar/base/src/calIcsParser.js">comparison</a> |
<a href="/comm-central/log/015d6cb840c4a0ed8db392a077aab10c2be6d0cd/calendar/base/src/calIcsParser.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/015d6cb840c4a0ed8db392a077aab10c2be6d0cd/calendar/base/src/calUtils.js">calendar/base/src/calUtils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/015d6cb840c4a0ed8db392a077aab10c2be6d0cd/calendar/base/src/calUtils.js">file</a> |
<a href="/comm-central/annotate/015d6cb840c4a0ed8db392a077aab10c2be6d0cd/calendar/base/src/calUtils.js">annotate</a> |
<a href="/comm-central/diff/015d6cb840c4a0ed8db392a077aab10c2be6d0cd/calendar/base/src/calUtils.js">diff</a> |
<a href="/comm-central/comparison/015d6cb840c4a0ed8db392a077aab10c2be6d0cd/calendar/base/src/calUtils.js">comparison</a> |
<a href="/comm-central/log/015d6cb840c4a0ed8db392a077aab10c2be6d0cd/calendar/base/src/calUtils.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/015d6cb840c4a0ed8db392a077aab10c2be6d0cd/calendar/providers/gdata/components/calGoogleCalendar.js">calendar/providers/gdata/components/calGoogleCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/015d6cb840c4a0ed8db392a077aab10c2be6d0cd/calendar/providers/gdata/components/calGoogleCalendar.js">file</a> |
<a href="/comm-central/annotate/015d6cb840c4a0ed8db392a077aab10c2be6d0cd/calendar/providers/gdata/components/calGoogleCalendar.js">annotate</a> |
<a href="/comm-central/diff/015d6cb840c4a0ed8db392a077aab10c2be6d0cd/calendar/providers/gdata/components/calGoogleCalendar.js">diff</a> |
<a href="/comm-central/comparison/015d6cb840c4a0ed8db392a077aab10c2be6d0cd/calendar/providers/gdata/components/calGoogleCalendar.js">comparison</a> |
<a href="/comm-central/log/015d6cb840c4a0ed8db392a077aab10c2be6d0cd/calendar/providers/gdata/components/calGoogleCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/015d6cb840c4a0ed8db392a077aab10c2be6d0cd/calendar/providers/gdata/content/gdata-calendar-event-dialog.js">calendar/providers/gdata/content/gdata-calendar-event-dialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/015d6cb840c4a0ed8db392a077aab10c2be6d0cd/calendar/providers/gdata/content/gdata-calendar-event-dialog.js">file</a> |
<a href="/comm-central/annotate/015d6cb840c4a0ed8db392a077aab10c2be6d0cd/calendar/providers/gdata/content/gdata-calendar-event-dialog.js">annotate</a> |
<a href="/comm-central/diff/015d6cb840c4a0ed8db392a077aab10c2be6d0cd/calendar/providers/gdata/content/gdata-calendar-event-dialog.js">diff</a> |
<a href="/comm-central/comparison/015d6cb840c4a0ed8db392a077aab10c2be6d0cd/calendar/providers/gdata/content/gdata-calendar-event-dialog.js">comparison</a> |
<a href="/comm-central/log/015d6cb840c4a0ed8db392a077aab10c2be6d0cd/calendar/providers/gdata/content/gdata-calendar-event-dialog.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/015d6cb840c4a0ed8db392a077aab10c2be6d0cd/calendar/providers/gdata/modules/calUtilsShim.jsm">calendar/providers/gdata/modules/calUtilsShim.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/015d6cb840c4a0ed8db392a077aab10c2be6d0cd/calendar/providers/gdata/modules/calUtilsShim.jsm">file</a> |
<a href="/comm-central/annotate/015d6cb840c4a0ed8db392a077aab10c2be6d0cd/calendar/providers/gdata/modules/calUtilsShim.jsm">annotate</a> |
<a href="/comm-central/diff/015d6cb840c4a0ed8db392a077aab10c2be6d0cd/calendar/providers/gdata/modules/calUtilsShim.jsm">diff</a> |
<a href="/comm-central/comparison/015d6cb840c4a0ed8db392a077aab10c2be6d0cd/calendar/providers/gdata/modules/calUtilsShim.jsm">comparison</a> |
<a href="/comm-central/log/015d6cb840c4a0ed8db392a077aab10c2be6d0cd/calendar/providers/gdata/modules/calUtilsShim.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/015d6cb840c4a0ed8db392a077aab10c2be6d0cd/calendar/providers/gdata/modules/gdataSession.jsm">calendar/providers/gdata/modules/gdataSession.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/015d6cb840c4a0ed8db392a077aab10c2be6d0cd/calendar/providers/gdata/modules/gdataSession.jsm">file</a> |
<a href="/comm-central/annotate/015d6cb840c4a0ed8db392a077aab10c2be6d0cd/calendar/providers/gdata/modules/gdataSession.jsm">annotate</a> |
<a href="/comm-central/diff/015d6cb840c4a0ed8db392a077aab10c2be6d0cd/calendar/providers/gdata/modules/gdataSession.jsm">diff</a> |
<a href="/comm-central/comparison/015d6cb840c4a0ed8db392a077aab10c2be6d0cd/calendar/providers/gdata/modules/gdataSession.jsm">comparison</a> |
<a href="/comm-central/log/015d6cb840c4a0ed8db392a077aab10c2be6d0cd/calendar/providers/gdata/modules/gdataSession.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/015d6cb840c4a0ed8db392a077aab10c2be6d0cd/calendar/providers/gdata/modules/gdataUtils.jsm">calendar/providers/gdata/modules/gdataUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/015d6cb840c4a0ed8db392a077aab10c2be6d0cd/calendar/providers/gdata/modules/gdataUtils.jsm">file</a> |
<a href="/comm-central/annotate/015d6cb840c4a0ed8db392a077aab10c2be6d0cd/calendar/providers/gdata/modules/gdataUtils.jsm">annotate</a> |
<a href="/comm-central/diff/015d6cb840c4a0ed8db392a077aab10c2be6d0cd/calendar/providers/gdata/modules/gdataUtils.jsm">diff</a> |
<a href="/comm-central/comparison/015d6cb840c4a0ed8db392a077aab10c2be6d0cd/calendar/providers/gdata/modules/gdataUtils.jsm">comparison</a> |
<a href="/comm-central/log/015d6cb840c4a0ed8db392a077aab10c2be6d0cd/calendar/providers/gdata/modules/gdataUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/015d6cb840c4a0ed8db392a077aab10c2be6d0cd/calendar/providers/gdata/moz.build">calendar/providers/gdata/moz.build</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/015d6cb840c4a0ed8db392a077aab10c2be6d0cd/calendar/providers/gdata/moz.build">file</a> |
<a href="/comm-central/annotate/015d6cb840c4a0ed8db392a077aab10c2be6d0cd/calendar/providers/gdata/moz.build">annotate</a> |
<a href="/comm-central/diff/015d6cb840c4a0ed8db392a077aab10c2be6d0cd/calendar/providers/gdata/moz.build">diff</a> |
<a href="/comm-central/comparison/015d6cb840c4a0ed8db392a077aab10c2be6d0cd/calendar/providers/gdata/moz.build">comparison</a> |
<a href="/comm-central/log/015d6cb840c4a0ed8db392a077aab10c2be6d0cd/calendar/providers/gdata/moz.build">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1">new file mode 100644</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineminus">--- /dev/null</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineplus">+++ b/calendar/base/modules/calDateTimeUtils.jsm</span>
<a href="#l1.4"></a><span id="l1.4" class="difflineat">@@ -0,0 +1,252 @@</span>
<a href="#l1.5"></a><span id="l1.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l1.6"></a><span id="l1.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l1.7"></a><span id="l1.7" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l1.8"></a><span id="l1.8" class="difflineplus">+</span>
<a href="#l1.9"></a><span id="l1.9" class="difflineplus">+/*</span>
<a href="#l1.10"></a><span id="l1.10" class="difflineplus">+ * date, time and timezone related functions via cal.dtz.*</span>
<a href="#l1.11"></a><span id="l1.11" class="difflineplus">+ *</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+ * NOTE this module should never be imported directly. Instead, load</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+ * calUtils.jsm and accss them via cal.dtz.*</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+ */</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Preferences.jsm&quot;);</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineplus">+</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineplus">+XPCOMUtils.defineLazyModuleGetter(this, &quot;cal&quot;, &quot;resource://calendar/modules/calUtils.jsm&quot;, &quot;cal&quot;);</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineplus">+</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineplus">+this.EXPORTED_SYMBOLS = [&quot;caldtz&quot;]; /* exported caldtz */</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineplus">+</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineplus">+var caldtz = {</span>
<a href="#l1.24"></a><span id="l1.24" class="difflineplus">+    /**</span>
<a href="#l1.25"></a><span id="l1.25" class="difflineplus">+     * Shortcut to the timezone service's defaultTimezone</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineplus">+     */</span>
<a href="#l1.27"></a><span id="l1.27" class="difflineplus">+    get defaultTimezone() {</span>
<a href="#l1.28"></a><span id="l1.28" class="difflineplus">+        return cal.getTimezoneService().defaultTimezone;</span>
<a href="#l1.29"></a><span id="l1.29" class="difflineplus">+    },</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineplus">+</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineplus">+    /**</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineplus">+     * Shorcut to the UTC timezone</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineplus">+     */</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineplus">+    get UTC() {</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineplus">+        return cal.getTimezoneService().UTC;</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineplus">+    },</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineplus">+</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineplus">+    /**</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineplus">+     * Shortcut to the floating (local) timezone</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineplus">+     */</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineplus">+    get floating() {</span>
<a href="#l1.42"></a><span id="l1.42" class="difflineplus">+        return cal.getTimezoneService().floating;</span>
<a href="#l1.43"></a><span id="l1.43" class="difflineplus">+    },</span>
<a href="#l1.44"></a><span id="l1.44" class="difflineplus">+</span>
<a href="#l1.45"></a><span id="l1.45" class="difflineplus">+    /**</span>
<a href="#l1.46"></a><span id="l1.46" class="difflineplus">+     * Makes sure the given timezone id is part of the list of recent timezones.</span>
<a href="#l1.47"></a><span id="l1.47" class="difflineplus">+     *</span>
<a href="#l1.48"></a><span id="l1.48" class="difflineplus">+     * @param aTzid     The timezone id to add</span>
<a href="#l1.49"></a><span id="l1.49" class="difflineplus">+     */</span>
<a href="#l1.50"></a><span id="l1.50" class="difflineplus">+    saveRecentTimezone: function(aTzid) {</span>
<a href="#l1.51"></a><span id="l1.51" class="difflineplus">+        let recentTimezones = caldtz.getRecentTimezones();</span>
<a href="#l1.52"></a><span id="l1.52" class="difflineplus">+        const MAX_RECENT_TIMEZONES = 5; // We don't need a pref for *everything*.</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineplus">+</span>
<a href="#l1.54"></a><span id="l1.54" class="difflineplus">+        if (aTzid != caldtz.defaultTimezone.tzid &amp;&amp;</span>
<a href="#l1.55"></a><span id="l1.55" class="difflineplus">+            !recentTimezones.includes(aTzid)) {</span>
<a href="#l1.56"></a><span id="l1.56" class="difflineplus">+            // Add the timezone if its not already the default timezone</span>
<a href="#l1.57"></a><span id="l1.57" class="difflineplus">+            recentTimezones.unshift(aTzid);</span>
<a href="#l1.58"></a><span id="l1.58" class="difflineplus">+            recentTimezones.splice(MAX_RECENT_TIMEZONES);</span>
<a href="#l1.59"></a><span id="l1.59" class="difflineplus">+            Preferences.set(&quot;calendar.timezone.recent&quot;, JSON.stringify(recentTimezones));</span>
<a href="#l1.60"></a><span id="l1.60" class="difflineplus">+        }</span>
<a href="#l1.61"></a><span id="l1.61" class="difflineplus">+    },</span>
<a href="#l1.62"></a><span id="l1.62" class="difflineplus">+</span>
<a href="#l1.63"></a><span id="l1.63" class="difflineplus">+    /**</span>
<a href="#l1.64"></a><span id="l1.64" class="difflineplus">+     * Returns a calIDateTime that corresponds to the current time in the user's</span>
<a href="#l1.65"></a><span id="l1.65" class="difflineplus">+     * default timezone.</span>
<a href="#l1.66"></a><span id="l1.66" class="difflineplus">+     */</span>
<a href="#l1.67"></a><span id="l1.67" class="difflineplus">+    now: function() {</span>
<a href="#l1.68"></a><span id="l1.68" class="difflineplus">+        let date = caldtz.jsDateToDateTime(new Date());</span>
<a href="#l1.69"></a><span id="l1.69" class="difflineplus">+        return date.getInTimezone(caldtz.defaultTimezone);</span>
<a href="#l1.70"></a><span id="l1.70" class="difflineplus">+    },</span>
<a href="#l1.71"></a><span id="l1.71" class="difflineplus">+</span>
<a href="#l1.72"></a><span id="l1.72" class="difflineplus">+    /**</span>
<a href="#l1.73"></a><span id="l1.73" class="difflineplus">+     * Get the default event start date. This is the next full hour, or 23:00 if it</span>
<a href="#l1.74"></a><span id="l1.74" class="difflineplus">+     * is past 23:00.</span>
<a href="#l1.75"></a><span id="l1.75" class="difflineplus">+     *</span>
<a href="#l1.76"></a><span id="l1.76" class="difflineplus">+     * @param aReferenceDate    If passed, the time of this date will be modified,</span>
<a href="#l1.77"></a><span id="l1.77" class="difflineplus">+     *                            keeping the date and timezone intact.</span>
<a href="#l1.78"></a><span id="l1.78" class="difflineplus">+     */</span>
<a href="#l1.79"></a><span id="l1.79" class="difflineplus">+    getDefaultStartDate: function(aReferenceDate) {</span>
<a href="#l1.80"></a><span id="l1.80" class="difflineplus">+        let startDate = caldtz.now();</span>
<a href="#l1.81"></a><span id="l1.81" class="difflineplus">+        if (aReferenceDate) {</span>
<a href="#l1.82"></a><span id="l1.82" class="difflineplus">+            let savedHour = startDate.hour;</span>
<a href="#l1.83"></a><span id="l1.83" class="difflineplus">+            startDate = aReferenceDate;</span>
<a href="#l1.84"></a><span id="l1.84" class="difflineplus">+            if (!startDate.isMutable) {</span>
<a href="#l1.85"></a><span id="l1.85" class="difflineplus">+                startDate = startDate.clone();</span>
<a href="#l1.86"></a><span id="l1.86" class="difflineplus">+            }</span>
<a href="#l1.87"></a><span id="l1.87" class="difflineplus">+            startDate.isDate = false;</span>
<a href="#l1.88"></a><span id="l1.88" class="difflineplus">+            startDate.hour = savedHour;</span>
<a href="#l1.89"></a><span id="l1.89" class="difflineplus">+        }</span>
<a href="#l1.90"></a><span id="l1.90" class="difflineplus">+</span>
<a href="#l1.91"></a><span id="l1.91" class="difflineplus">+        startDate.second = 0;</span>
<a href="#l1.92"></a><span id="l1.92" class="difflineplus">+        startDate.minute = 0;</span>
<a href="#l1.93"></a><span id="l1.93" class="difflineplus">+        if (startDate.hour &lt; 23) {</span>
<a href="#l1.94"></a><span id="l1.94" class="difflineplus">+            startDate.hour++;</span>
<a href="#l1.95"></a><span id="l1.95" class="difflineplus">+        }</span>
<a href="#l1.96"></a><span id="l1.96" class="difflineplus">+        return startDate;</span>
<a href="#l1.97"></a><span id="l1.97" class="difflineplus">+    },</span>
<a href="#l1.98"></a><span id="l1.98" class="difflineplus">+</span>
<a href="#l1.99"></a><span id="l1.99" class="difflineplus">+    /**</span>
<a href="#l1.100"></a><span id="l1.100" class="difflineplus">+     * Setup the default start and end hours of the given item. This can be a task</span>
<a href="#l1.101"></a><span id="l1.101" class="difflineplus">+     * or an event.</span>
<a href="#l1.102"></a><span id="l1.102" class="difflineplus">+     *</span>
<a href="#l1.103"></a><span id="l1.103" class="difflineplus">+     * @param aItem             The item to set up the start and end date for.</span>
<a href="#l1.104"></a><span id="l1.104" class="difflineplus">+     * @param aReferenceDate    If passed, the time of this date will be modified,</span>
<a href="#l1.105"></a><span id="l1.105" class="difflineplus">+     *                            keeping the date and timezone intact.</span>
<a href="#l1.106"></a><span id="l1.106" class="difflineplus">+     */</span>
<a href="#l1.107"></a><span id="l1.107" class="difflineplus">+    setDefaultStartEndHour: function(aItem, aReferenceDate) {</span>
<a href="#l1.108"></a><span id="l1.108" class="difflineplus">+        aItem[caldtz.startDateProp(aItem)] = caldtz.getDefaultStartDate(aReferenceDate);</span>
<a href="#l1.109"></a><span id="l1.109" class="difflineplus">+</span>
<a href="#l1.110"></a><span id="l1.110" class="difflineplus">+        if (cal.isEvent(aItem)) {</span>
<a href="#l1.111"></a><span id="l1.111" class="difflineplus">+            aItem.endDate = aItem.startDate.clone();</span>
<a href="#l1.112"></a><span id="l1.112" class="difflineplus">+            aItem.endDate.minute += Preferences.get(&quot;calendar.event.defaultlength&quot;, 60);</span>
<a href="#l1.113"></a><span id="l1.113" class="difflineplus">+        }</span>
<a href="#l1.114"></a><span id="l1.114" class="difflineplus">+    },</span>
<a href="#l1.115"></a><span id="l1.115" class="difflineplus">+</span>
<a href="#l1.116"></a><span id="l1.116" class="difflineplus">+    /**</span>
<a href="#l1.117"></a><span id="l1.117" class="difflineplus">+     * Returns the property name used for the start date of an item, ie either an</span>
<a href="#l1.118"></a><span id="l1.118" class="difflineplus">+     * event's start date or a task's entry date.</span>
<a href="#l1.119"></a><span id="l1.119" class="difflineplus">+     */</span>
<a href="#l1.120"></a><span id="l1.120" class="difflineplus">+    startDateProp: function(aItem) {</span>
<a href="#l1.121"></a><span id="l1.121" class="difflineplus">+        if (cal.isEvent(aItem)) {</span>
<a href="#l1.122"></a><span id="l1.122" class="difflineplus">+            return &quot;startDate&quot;;</span>
<a href="#l1.123"></a><span id="l1.123" class="difflineplus">+        } else if (cal.isToDo(aItem)) {</span>
<a href="#l1.124"></a><span id="l1.124" class="difflineplus">+            return &quot;entryDate&quot;;</span>
<a href="#l1.125"></a><span id="l1.125" class="difflineplus">+        }</span>
<a href="#l1.126"></a><span id="l1.126" class="difflineplus">+        throw Components.results.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l1.127"></a><span id="l1.127" class="difflineplus">+    },</span>
<a href="#l1.128"></a><span id="l1.128" class="difflineplus">+</span>
<a href="#l1.129"></a><span id="l1.129" class="difflineplus">+    /**</span>
<a href="#l1.130"></a><span id="l1.130" class="difflineplus">+     * Returns the property name used for the end date of an item, ie either an</span>
<a href="#l1.131"></a><span id="l1.131" class="difflineplus">+     * event's end date or a task's due date.</span>
<a href="#l1.132"></a><span id="l1.132" class="difflineplus">+     */</span>
<a href="#l1.133"></a><span id="l1.133" class="difflineplus">+    endDateProp: function(aItem) {</span>
<a href="#l1.134"></a><span id="l1.134" class="difflineplus">+        if (cal.isEvent(aItem)) {</span>
<a href="#l1.135"></a><span id="l1.135" class="difflineplus">+            return &quot;endDate&quot;;</span>
<a href="#l1.136"></a><span id="l1.136" class="difflineplus">+        } else if (cal.isToDo(aItem)) {</span>
<a href="#l1.137"></a><span id="l1.137" class="difflineplus">+            return &quot;dueDate&quot;;</span>
<a href="#l1.138"></a><span id="l1.138" class="difflineplus">+        }</span>
<a href="#l1.139"></a><span id="l1.139" class="difflineplus">+        throw Components.results.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l1.140"></a><span id="l1.140" class="difflineplus">+    },</span>
<a href="#l1.141"></a><span id="l1.141" class="difflineplus">+</span>
<a href="#l1.142"></a><span id="l1.142" class="difflineplus">+    /**</span>
<a href="#l1.143"></a><span id="l1.143" class="difflineplus">+     * Check if the two dates are on the same day (ignoring time)</span>
<a href="#l1.144"></a><span id="l1.144" class="difflineplus">+     *</span>
<a href="#l1.145"></a><span id="l1.145" class="difflineplus">+     * @param date1     The left date to compare</span>
<a href="#l1.146"></a><span id="l1.146" class="difflineplus">+     * @param date2     The right date to compare</span>
<a href="#l1.147"></a><span id="l1.147" class="difflineplus">+     * @return          True, if dates are on the same day</span>
<a href="#l1.148"></a><span id="l1.148" class="difflineplus">+     */</span>
<a href="#l1.149"></a><span id="l1.149" class="difflineplus">+    sameDay: function(date1, date2) {</span>
<a href="#l1.150"></a><span id="l1.150" class="difflineplus">+        if (date1 &amp;&amp; date2) {</span>
<a href="#l1.151"></a><span id="l1.151" class="difflineplus">+            if ((date1.day == date2.day) &amp;&amp;</span>
<a href="#l1.152"></a><span id="l1.152" class="difflineplus">+                (date1.month == date2.month) &amp;&amp;</span>
<a href="#l1.153"></a><span id="l1.153" class="difflineplus">+                (date1.year == date2.year)) {</span>
<a href="#l1.154"></a><span id="l1.154" class="difflineplus">+                return true;</span>
<a href="#l1.155"></a><span id="l1.155" class="difflineplus">+            }</span>
<a href="#l1.156"></a><span id="l1.156" class="difflineplus">+        }</span>
<a href="#l1.157"></a><span id="l1.157" class="difflineplus">+        return false;</span>
<a href="#l1.158"></a><span id="l1.158" class="difflineplus">+    },</span>
<a href="#l1.159"></a><span id="l1.159" class="difflineplus">+</span>
<a href="#l1.160"></a><span id="l1.160" class="difflineplus">+    /**</span>
<a href="#l1.161"></a><span id="l1.161" class="difflineplus">+     * Many computations want to work only with date-times, not with dates.  This</span>
<a href="#l1.162"></a><span id="l1.162" class="difflineplus">+     * method will return a proper datetime (set to midnight) for a date object.  If</span>
<a href="#l1.163"></a><span id="l1.163" class="difflineplus">+     * the object is already a datetime, it will simply be returned.</span>
<a href="#l1.164"></a><span id="l1.164" class="difflineplus">+     *</span>
<a href="#l1.165"></a><span id="l1.165" class="difflineplus">+     * @param aDate  the date or datetime to check</span>
<a href="#l1.166"></a><span id="l1.166" class="difflineplus">+     */</span>
<a href="#l1.167"></a><span id="l1.167" class="difflineplus">+    ensureDateTime: function(aDate) {</span>
<a href="#l1.168"></a><span id="l1.168" class="difflineplus">+        if (!aDate || !aDate.isDate) {</span>
<a href="#l1.169"></a><span id="l1.169" class="difflineplus">+            return aDate;</span>
<a href="#l1.170"></a><span id="l1.170" class="difflineplus">+        }</span>
<a href="#l1.171"></a><span id="l1.171" class="difflineplus">+        let newDate = aDate.clone();</span>
<a href="#l1.172"></a><span id="l1.172" class="difflineplus">+        newDate.isDate = false;</span>
<a href="#l1.173"></a><span id="l1.173" class="difflineplus">+        return newDate;</span>
<a href="#l1.174"></a><span id="l1.174" class="difflineplus">+    },</span>
<a href="#l1.175"></a><span id="l1.175" class="difflineplus">+</span>
<a href="#l1.176"></a><span id="l1.176" class="difflineplus">+    /**</span>
<a href="#l1.177"></a><span id="l1.177" class="difflineplus">+     * Returns a calIDateTime corresponding to a javascript Date.</span>
<a href="#l1.178"></a><span id="l1.178" class="difflineplus">+     *</span>
<a href="#l1.179"></a><span id="l1.179" class="difflineplus">+     * @param aDate     a javascript date</span>
<a href="#l1.180"></a><span id="l1.180" class="difflineplus">+     * @param aTimezone (optional) a timezone that should be enforced</span>
<a href="#l1.181"></a><span id="l1.181" class="difflineplus">+     * @returns         a calIDateTime</span>
<a href="#l1.182"></a><span id="l1.182" class="difflineplus">+     *</span>
<a href="#l1.183"></a><span id="l1.183" class="difflineplus">+     * @warning  Use of this function is strongly discouraged.  calIDateTime should</span>
<a href="#l1.184"></a><span id="l1.184" class="difflineplus">+     *           be used directly whenever possible.</span>
<a href="#l1.185"></a><span id="l1.185" class="difflineplus">+     *           If you pass a timezone, then the passed jsDate's timezone will be ignored,</span>
<a href="#l1.186"></a><span id="l1.186" class="difflineplus">+     *           but only its local time portions are be taken.</span>
<a href="#l1.187"></a><span id="l1.187" class="difflineplus">+     */</span>
<a href="#l1.188"></a><span id="l1.188" class="difflineplus">+    jsDateToDateTime: function(aDate, aTimezone) {</span>
<a href="#l1.189"></a><span id="l1.189" class="difflineplus">+        let newDate = cal.createDateTime();</span>
<a href="#l1.190"></a><span id="l1.190" class="difflineplus">+        if (aTimezone) {</span>
<a href="#l1.191"></a><span id="l1.191" class="difflineplus">+            newDate.resetTo(aDate.getFullYear(),</span>
<a href="#l1.192"></a><span id="l1.192" class="difflineplus">+                            aDate.getMonth(),</span>
<a href="#l1.193"></a><span id="l1.193" class="difflineplus">+                            aDate.getDate(),</span>
<a href="#l1.194"></a><span id="l1.194" class="difflineplus">+                            aDate.getHours(),</span>
<a href="#l1.195"></a><span id="l1.195" class="difflineplus">+                            aDate.getMinutes(),</span>
<a href="#l1.196"></a><span id="l1.196" class="difflineplus">+                            aDate.getSeconds(),</span>
<a href="#l1.197"></a><span id="l1.197" class="difflineplus">+                            aTimezone);</span>
<a href="#l1.198"></a><span id="l1.198" class="difflineplus">+        } else {</span>
<a href="#l1.199"></a><span id="l1.199" class="difflineplus">+            newDate.nativeTime = aDate.getTime() * 1000;</span>
<a href="#l1.200"></a><span id="l1.200" class="difflineplus">+        }</span>
<a href="#l1.201"></a><span id="l1.201" class="difflineplus">+        return newDate;</span>
<a href="#l1.202"></a><span id="l1.202" class="difflineplus">+    },</span>
<a href="#l1.203"></a><span id="l1.203" class="difflineplus">+</span>
<a href="#l1.204"></a><span id="l1.204" class="difflineplus">+    /**</span>
<a href="#l1.205"></a><span id="l1.205" class="difflineplus">+     * Convert a calIDateTime to a Javascript date object. This is the</span>
<a href="#l1.206"></a><span id="l1.206" class="difflineplus">+     * replacement for the former .jsDate property.</span>
<a href="#l1.207"></a><span id="l1.207" class="difflineplus">+     *</span>
<a href="#l1.208"></a><span id="l1.208" class="difflineplus">+     * @param cdt       The calIDateTime instnace</span>
<a href="#l1.209"></a><span id="l1.209" class="difflineplus">+     * @return          The Javascript date equivalent.</span>
<a href="#l1.210"></a><span id="l1.210" class="difflineplus">+     */</span>
<a href="#l1.211"></a><span id="l1.211" class="difflineplus">+    dateTimeToJsDate: function(cdt) {</span>
<a href="#l1.212"></a><span id="l1.212" class="difflineplus">+        if (cdt.timezone.isFloating) {</span>
<a href="#l1.213"></a><span id="l1.213" class="difflineplus">+            return new Date(cdt.year, cdt.month, cdt.day,</span>
<a href="#l1.214"></a><span id="l1.214" class="difflineplus">+                            cdt.hour, cdt.minute, cdt.second);</span>
<a href="#l1.215"></a><span id="l1.215" class="difflineplus">+        } else {</span>
<a href="#l1.216"></a><span id="l1.216" class="difflineplus">+            return new Date(cdt.nativeTime / 1000);</span>
<a href="#l1.217"></a><span id="l1.217" class="difflineplus">+        }</span>
<a href="#l1.218"></a><span id="l1.218" class="difflineplus">+    },</span>
<a href="#l1.219"></a><span id="l1.219" class="difflineplus">+</span>
<a href="#l1.220"></a><span id="l1.220" class="difflineplus">+    /**</span>
<a href="#l1.221"></a><span id="l1.221" class="difflineplus">+     * Gets the list of recent timezones. Optionally retuns the list as</span>
<a href="#l1.222"></a><span id="l1.222" class="difflineplus">+     * calITimezones.</span>
<a href="#l1.223"></a><span id="l1.223" class="difflineplus">+     *</span>
<a href="#l1.224"></a><span id="l1.224" class="difflineplus">+     * @param aConvertZones     (optional) If true, return calITimezones instead</span>
<a href="#l1.225"></a><span id="l1.225" class="difflineplus">+     * @return                  An array of timezone ids or calITimezones.</span>
<a href="#l1.226"></a><span id="l1.226" class="difflineplus">+     */</span>
<a href="#l1.227"></a><span id="l1.227" class="difflineplus">+    getRecentTimezones: function(aConvertZones) {</span>
<a href="#l1.228"></a><span id="l1.228" class="difflineplus">+        let recentTimezones = JSON.parse(Preferences.get(&quot;calendar.timezone.recent&quot;, &quot;[]&quot;) || &quot;[]&quot;);</span>
<a href="#l1.229"></a><span id="l1.229" class="difflineplus">+        if (!Array.isArray(recentTimezones)) {</span>
<a href="#l1.230"></a><span id="l1.230" class="difflineplus">+            recentTimezones = [];</span>
<a href="#l1.231"></a><span id="l1.231" class="difflineplus">+        }</span>
<a href="#l1.232"></a><span id="l1.232" class="difflineplus">+</span>
<a href="#l1.233"></a><span id="l1.233" class="difflineplus">+        let tzService = cal.getTimezoneService();</span>
<a href="#l1.234"></a><span id="l1.234" class="difflineplus">+        if (aConvertZones) {</span>
<a href="#l1.235"></a><span id="l1.235" class="difflineplus">+            let oldZonesLength = recentTimezones.length;</span>
<a href="#l1.236"></a><span id="l1.236" class="difflineplus">+            for (let i = 0; i &lt; recentTimezones.length; i++) {</span>
<a href="#l1.237"></a><span id="l1.237" class="difflineplus">+                let timezone = tzService.getTimezone(recentTimezones[i]);</span>
<a href="#l1.238"></a><span id="l1.238" class="difflineplus">+                if (timezone) {</span>
<a href="#l1.239"></a><span id="l1.239" class="difflineplus">+                    // Replace id with found timezone</span>
<a href="#l1.240"></a><span id="l1.240" class="difflineplus">+                    recentTimezones[i] = timezone;</span>
<a href="#l1.241"></a><span id="l1.241" class="difflineplus">+                } else {</span>
<a href="#l1.242"></a><span id="l1.242" class="difflineplus">+                    // Looks like the timezone doesn't longer exist, remove it</span>
<a href="#l1.243"></a><span id="l1.243" class="difflineplus">+                    recentTimezones.splice(i, 1);</span>
<a href="#l1.244"></a><span id="l1.244" class="difflineplus">+                    i--;</span>
<a href="#l1.245"></a><span id="l1.245" class="difflineplus">+                }</span>
<a href="#l1.246"></a><span id="l1.246" class="difflineplus">+            }</span>
<a href="#l1.247"></a><span id="l1.247" class="difflineplus">+</span>
<a href="#l1.248"></a><span id="l1.248" class="difflineplus">+            if (oldZonesLength != recentTimezones.length) {</span>
<a href="#l1.249"></a><span id="l1.249" class="difflineplus">+                // Looks like the one or other timezone dropped out. Go ahead and</span>
<a href="#l1.250"></a><span id="l1.250" class="difflineplus">+                // modify the pref.</span>
<a href="#l1.251"></a><span id="l1.251" class="difflineplus">+                Preferences.set(&quot;calendar.timezone.recent&quot;, JSON.stringify(recentTimezones));</span>
<a href="#l1.252"></a><span id="l1.252" class="difflineplus">+            }</span>
<a href="#l1.253"></a><span id="l1.253" class="difflineplus">+        }</span>
<a href="#l1.254"></a><span id="l1.254" class="difflineplus">+        return recentTimezones;</span>
<a href="#l1.255"></a><span id="l1.255" class="difflineplus">+    }</span>
<a href="#l1.256"></a><span id="l1.256" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/calendar/base/modules/calUtils.jsm</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/calendar/base/modules/calUtils.jsm</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -62,22 +62,16 @@ var cal = {</span>
<a href="#l2.4"></a><span id="l2.4">                                  Components.interfaces.calIFreeBusyService),</span>
<a href="#l2.5"></a><span id="l2.5">     getWeekInfoService: _service(&quot;@mozilla.org/calendar/weekinfo-service;1&quot;,</span>
<a href="#l2.6"></a><span id="l2.6">                                  Components.interfaces.calIWeekInfoService),</span>
<a href="#l2.7"></a><span id="l2.7">     getDateFormatter: _service(&quot;@mozilla.org/calendar/datetime-formatter;1&quot;,</span>
<a href="#l2.8"></a><span id="l2.8">                                Components.interfaces.calIDateTimeFormatter),</span>
<a href="#l2.9"></a><span id="l2.9">     getDragService: _service(&quot;@mozilla.org/widget/dragservice;1&quot;,</span>
<a href="#l2.10"></a><span id="l2.10">                              Components.interfaces.nsIDragService),</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-    UTC: _cached(() =&gt; cal.getTimezoneService().UTC),</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-    floating: _cached(() =&gt; cal.getTimezoneService().floating),</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineminus">-    calendarDefaultTimezone: function() {</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineminus">-        return cal.getTimezoneService().defaultTimezone;</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineminus">-    },</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineminus">-</span>
<a href="#l2.18"></a><span id="l2.18">     /**</span>
<a href="#l2.19"></a><span id="l2.19">      * Loads an array of calendar scripts into the passed scope.</span>
<a href="#l2.20"></a><span id="l2.20">      *</span>
<a href="#l2.21"></a><span id="l2.21">      * @param scriptNames an array of calendar script names</span>
<a href="#l2.22"></a><span id="l2.22">      * @param scope       scope to load into</span>
<a href="#l2.23"></a><span id="l2.23">      * @param baseDir     base dir; defaults to calendar-js/</span>
<a href="#l2.24"></a><span id="l2.24">      */</span>
<a href="#l2.25"></a><span id="l2.25">     loadScripts: function(scriptNames, scope, baseDir) {</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineat">@@ -206,23 +200,16 @@ var cal = {</span>
<a href="#l2.27"></a><span id="l2.27">      *</span>
<a href="#l2.28"></a><span id="l2.28">      * @param aCalendar</span>
<a href="#l2.29"></a><span id="l2.29">      */</span>
<a href="#l2.30"></a><span id="l2.30">     isTaskCalendar: function(aCalendar) {</span>
<a href="#l2.31"></a><span id="l2.31">         return (aCalendar.getProperty(&quot;capabilities.tasks.supported&quot;) !== false);</span>
<a href="#l2.32"></a><span id="l2.32">     },</span>
<a href="#l2.33"></a><span id="l2.33"> </span>
<a href="#l2.34"></a><span id="l2.34">     /**</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineminus">-     * Checks whether a timezone lacks a definition.</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineminus">-     */</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineminus">-    isPhantomTimezone: function(timezone) {</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineminus">-        return (!timezone.icalComponent &amp;&amp; !timezone.isUTC &amp;&amp; !timezone.isFloating);</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineminus">-    },</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineminus">-</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineminus">-    /**</span>
<a href="#l2.42"></a><span id="l2.42">      * Shifts an item by the given timely offset.</span>
<a href="#l2.43"></a><span id="l2.43">      *</span>
<a href="#l2.44"></a><span id="l2.44">      * @param item an item</span>
<a href="#l2.45"></a><span id="l2.45">      * @param offset an offset (calIDuration)</span>
<a href="#l2.46"></a><span id="l2.46">      */</span>
<a href="#l2.47"></a><span id="l2.47">     shiftItem: function(item, offset) {</span>
<a href="#l2.48"></a><span id="l2.48">         // When modifying dates explicitly using the setters is important</span>
<a href="#l2.49"></a><span id="l2.49">         // since those may triggers e.g. calIRecurrenceInfo::onStartDateChange</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineat">@@ -640,37 +627,44 @@ var cal = {</span>
<a href="#l2.51"></a><span id="l2.51">             default:</span>
<a href="#l2.52"></a><span id="l2.52">                 return function(sortEntryA, sortEntryB) {</span>
<a href="#l2.53"></a><span id="l2.53">                     return 0;</span>
<a href="#l2.54"></a><span id="l2.54">                 };</span>
<a href="#l2.55"></a><span id="l2.55">         }</span>
<a href="#l2.56"></a><span id="l2.56">     },</span>
<a href="#l2.57"></a><span id="l2.57"> </span>
<a href="#l2.58"></a><span id="l2.58">     getItemSortKey: function(aItem, aKey, aStartTime) {</span>
<a href="#l2.59"></a><span id="l2.59" class="difflineplus">+        function nativeTime(calDateTime) {</span>
<a href="#l2.60"></a><span id="l2.60" class="difflineplus">+            if (calDateTime == null) {</span>
<a href="#l2.61"></a><span id="l2.61" class="difflineplus">+                return -62168601600000000; // ns value for (0000/00/00 00:00:00)</span>
<a href="#l2.62"></a><span id="l2.62" class="difflineplus">+            }</span>
<a href="#l2.63"></a><span id="l2.63" class="difflineplus">+            return calDateTime.nativeTime;</span>
<a href="#l2.64"></a><span id="l2.64" class="difflineplus">+        }</span>
<a href="#l2.65"></a><span id="l2.65" class="difflineplus">+</span>
<a href="#l2.66"></a><span id="l2.66">         switch (aKey) {</span>
<a href="#l2.67"></a><span id="l2.67">             case &quot;priority&quot;:</span>
<a href="#l2.68"></a><span id="l2.68">                 return aItem.priority || 5;</span>
<a href="#l2.69"></a><span id="l2.69"> </span>
<a href="#l2.70"></a><span id="l2.70">             case &quot;title&quot;:</span>
<a href="#l2.71"></a><span id="l2.71">                 return aItem.title || &quot;&quot;;</span>
<a href="#l2.72"></a><span id="l2.72"> </span>
<a href="#l2.73"></a><span id="l2.73">             case &quot;entryDate&quot;:</span>
<a href="#l2.74"></a><span id="l2.74" class="difflineminus">-                return cal.nativeTime(aItem.entryDate);</span>
<a href="#l2.75"></a><span id="l2.75" class="difflineplus">+                return nativeTime(aItem.entryDate);</span>
<a href="#l2.76"></a><span id="l2.76"> </span>
<a href="#l2.77"></a><span id="l2.77">             case &quot;startDate&quot;:</span>
<a href="#l2.78"></a><span id="l2.78" class="difflineminus">-                return cal.nativeTime(aItem.startDate);</span>
<a href="#l2.79"></a><span id="l2.79" class="difflineplus">+                return nativeTime(aItem.startDate);</span>
<a href="#l2.80"></a><span id="l2.80"> </span>
<a href="#l2.81"></a><span id="l2.81">             case &quot;dueDate&quot;:</span>
<a href="#l2.82"></a><span id="l2.82" class="difflineminus">-                return cal.nativeTime(aItem.dueDate);</span>
<a href="#l2.83"></a><span id="l2.83" class="difflineplus">+                return nativeTime(aItem.dueDate);</span>
<a href="#l2.84"></a><span id="l2.84"> </span>
<a href="#l2.85"></a><span id="l2.85">             case &quot;endDate&quot;:</span>
<a href="#l2.86"></a><span id="l2.86" class="difflineminus">-                return cal.nativeTime(aItem.endDate);</span>
<a href="#l2.87"></a><span id="l2.87" class="difflineplus">+                return nativeTime(aItem.endDate);</span>
<a href="#l2.88"></a><span id="l2.88"> </span>
<a href="#l2.89"></a><span id="l2.89">             case &quot;completedDate&quot;:</span>
<a href="#l2.90"></a><span id="l2.90" class="difflineminus">-                return cal.nativeTime(aItem.completedDate);</span>
<a href="#l2.91"></a><span id="l2.91" class="difflineplus">+                return nativeTime(aItem.completedDate);</span>
<a href="#l2.92"></a><span id="l2.92"> </span>
<a href="#l2.93"></a><span id="l2.93">             case &quot;percentComplete&quot;:</span>
<a href="#l2.94"></a><span id="l2.94">                 return aItem.percentComplete;</span>
<a href="#l2.95"></a><span id="l2.95"> </span>
<a href="#l2.96"></a><span id="l2.96">             case &quot;categories&quot;:</span>
<a href="#l2.97"></a><span id="l2.97">                 return aItem.getCategories({}).join(&quot;, &quot;);</span>
<a href="#l2.98"></a><span id="l2.98"> </span>
<a href="#l2.99"></a><span id="l2.99">             case &quot;location&quot;:</span>
<a href="#l2.100"></a><span id="l2.100" class="difflineat">@@ -710,80 +704,16 @@ var cal = {</span>
<a href="#l2.101"></a><span id="l2.101">             case &quot;percentComplete&quot;:</span>
<a href="#l2.102"></a><span id="l2.102">             case &quot;status&quot;:</span>
<a href="#l2.103"></a><span id="l2.103">                 return &quot;number&quot;;</span>
<a href="#l2.104"></a><span id="l2.104">             default:</span>
<a href="#l2.105"></a><span id="l2.105">                 return &quot;unknown&quot;;</span>
<a href="#l2.106"></a><span id="l2.106">         }</span>
<a href="#l2.107"></a><span id="l2.107">     },</span>
<a href="#l2.108"></a><span id="l2.108"> </span>
<a href="#l2.109"></a><span id="l2.109" class="difflineminus">-    nativeTimeOrNow: function(calDateTime, sortStartedTime) {</span>
<a href="#l2.110"></a><span id="l2.110" class="difflineminus">-        // Treat null/0 as 'now' when sort started, so incomplete tasks stay current.</span>
<a href="#l2.111"></a><span id="l2.111" class="difflineminus">-        // Time is computed once per sort (just before sort) so sort is stable.</span>
<a href="#l2.112"></a><span id="l2.112" class="difflineminus">-        if (calDateTime == null) {</span>
<a href="#l2.113"></a><span id="l2.113" class="difflineminus">-            return sortStartedTime.nativeTime;</span>
<a href="#l2.114"></a><span id="l2.114" class="difflineminus">-        }</span>
<a href="#l2.115"></a><span id="l2.115" class="difflineminus">-        let nativeTime = calDateTime.nativeTime;</span>
<a href="#l2.116"></a><span id="l2.116" class="difflineminus">-        if (nativeTime == -62168601600000000) { // nativeTime value for (0000/00/00 00:00:00)</span>
<a href="#l2.117"></a><span id="l2.117" class="difflineminus">-            return sortStartedTime;</span>
<a href="#l2.118"></a><span id="l2.118" class="difflineminus">-        }</span>
<a href="#l2.119"></a><span id="l2.119" class="difflineminus">-        return nativeTime;</span>
<a href="#l2.120"></a><span id="l2.120" class="difflineminus">-    },</span>
<a href="#l2.121"></a><span id="l2.121" class="difflineminus">-</span>
<a href="#l2.122"></a><span id="l2.122" class="difflineminus">-    nativeTime: function(calDateTime) {</span>
<a href="#l2.123"></a><span id="l2.123" class="difflineminus">-        if (calDateTime == null) {</span>
<a href="#l2.124"></a><span id="l2.124" class="difflineminus">-            return -62168601600000000; // ns value for (0000/00/00 00:00:00)</span>
<a href="#l2.125"></a><span id="l2.125" class="difflineminus">-        }</span>
<a href="#l2.126"></a><span id="l2.126" class="difflineminus">-        return calDateTime.nativeTime;</span>
<a href="#l2.127"></a><span id="l2.127" class="difflineminus">-    },</span>
<a href="#l2.128"></a><span id="l2.128" class="difflineminus">-</span>
<a href="#l2.129"></a><span id="l2.129" class="difflineminus">-    /**</span>
<a href="#l2.130"></a><span id="l2.130" class="difflineminus">-     * Returns a calIDateTime corresponding to a javascript Date.</span>
<a href="#l2.131"></a><span id="l2.131" class="difflineminus">-     *</span>
<a href="#l2.132"></a><span id="l2.132" class="difflineminus">-     * @param aDate     a javascript date</span>
<a href="#l2.133"></a><span id="l2.133" class="difflineminus">-     * @param aTimezone (optional) a timezone that should be enforced</span>
<a href="#l2.134"></a><span id="l2.134" class="difflineminus">-     * @returns         a calIDateTime</span>
<a href="#l2.135"></a><span id="l2.135" class="difflineminus">-     *</span>
<a href="#l2.136"></a><span id="l2.136" class="difflineminus">-     * @warning  Use of this function is strongly discouraged.  calIDateTime should</span>
<a href="#l2.137"></a><span id="l2.137" class="difflineminus">-     *           be used directly whenever possible.</span>
<a href="#l2.138"></a><span id="l2.138" class="difflineminus">-     *           If you pass a timezone, then the passed jsDate's timezone will be ignored,</span>
<a href="#l2.139"></a><span id="l2.139" class="difflineminus">-     *           but only its local time portions are be taken.</span>
<a href="#l2.140"></a><span id="l2.140" class="difflineminus">-     */</span>
<a href="#l2.141"></a><span id="l2.141" class="difflineminus">-    jsDateToDateTime: function(aDate, aTimezone) {</span>
<a href="#l2.142"></a><span id="l2.142" class="difflineminus">-        let newDate = cal.createDateTime();</span>
<a href="#l2.143"></a><span id="l2.143" class="difflineminus">-        if (aTimezone) {</span>
<a href="#l2.144"></a><span id="l2.144" class="difflineminus">-            newDate.resetTo(aDate.getFullYear(),</span>
<a href="#l2.145"></a><span id="l2.145" class="difflineminus">-                            aDate.getMonth(),</span>
<a href="#l2.146"></a><span id="l2.146" class="difflineminus">-                            aDate.getDate(),</span>
<a href="#l2.147"></a><span id="l2.147" class="difflineminus">-                            aDate.getHours(),</span>
<a href="#l2.148"></a><span id="l2.148" class="difflineminus">-                            aDate.getMinutes(),</span>
<a href="#l2.149"></a><span id="l2.149" class="difflineminus">-                            aDate.getSeconds(),</span>
<a href="#l2.150"></a><span id="l2.150" class="difflineminus">-                            aTimezone);</span>
<a href="#l2.151"></a><span id="l2.151" class="difflineminus">-        } else {</span>
<a href="#l2.152"></a><span id="l2.152" class="difflineminus">-            newDate.nativeTime = aDate.getTime() * 1000;</span>
<a href="#l2.153"></a><span id="l2.153" class="difflineminus">-        }</span>
<a href="#l2.154"></a><span id="l2.154" class="difflineminus">-        return newDate;</span>
<a href="#l2.155"></a><span id="l2.155" class="difflineminus">-    },</span>
<a href="#l2.156"></a><span id="l2.156" class="difflineminus">-</span>
<a href="#l2.157"></a><span id="l2.157" class="difflineminus">-    /**</span>
<a href="#l2.158"></a><span id="l2.158" class="difflineminus">-     * Convert a calIDateTime to a Javascript date object. This is the</span>
<a href="#l2.159"></a><span id="l2.159" class="difflineminus">-     * replacement for the former .jsDate property.</span>
<a href="#l2.160"></a><span id="l2.160" class="difflineminus">-     *</span>
<a href="#l2.161"></a><span id="l2.161" class="difflineminus">-     * @param cdt       The calIDateTime instnace</span>
<a href="#l2.162"></a><span id="l2.162" class="difflineminus">-     * @return          The Javascript date equivalent.</span>
<a href="#l2.163"></a><span id="l2.163" class="difflineminus">-     */</span>
<a href="#l2.164"></a><span id="l2.164" class="difflineminus">-    dateTimeToJsDate: function(cdt) {</span>
<a href="#l2.165"></a><span id="l2.165" class="difflineminus">-        if (cdt.timezone.isFloating) {</span>
<a href="#l2.166"></a><span id="l2.166" class="difflineminus">-            return new Date(cdt.year, cdt.month, cdt.day,</span>
<a href="#l2.167"></a><span id="l2.167" class="difflineminus">-                            cdt.hour, cdt.minute, cdt.second);</span>
<a href="#l2.168"></a><span id="l2.168" class="difflineminus">-        } else {</span>
<a href="#l2.169"></a><span id="l2.169" class="difflineminus">-            return new Date(cdt.nativeTime / 1000);</span>
<a href="#l2.170"></a><span id="l2.170" class="difflineminus">-        }</span>
<a href="#l2.171"></a><span id="l2.171" class="difflineminus">-    },</span>
<a href="#l2.172"></a><span id="l2.172" class="difflineminus">-</span>
<a href="#l2.173"></a><span id="l2.173">     sortEntry: function(aItem) {</span>
<a href="#l2.174"></a><span id="l2.174">         let key = cal.getItemSortKey(aItem, this.mSortKey, this.mSortStartedDate);</span>
<a href="#l2.175"></a><span id="l2.175">         return { mSortKey: key, mItem: aItem };</span>
<a href="#l2.176"></a><span id="l2.176">     },</span>
<a href="#l2.177"></a><span id="l2.177"> </span>
<a href="#l2.178"></a><span id="l2.178">     sortEntryItem: function(sortEntry) {</span>
<a href="#l2.179"></a><span id="l2.179">         return sortEntry.mItem;</span>
<a href="#l2.180"></a><span id="l2.180">     },</span>
<a href="#l2.181"></a><span id="l2.181" class="difflineat">@@ -1009,34 +939,18 @@ var cal = {</span>
<a href="#l2.182"></a><span id="l2.182">      *</span>
<a href="#l2.183"></a><span id="l2.183">      * @param obj    object</span>
<a href="#l2.184"></a><span id="l2.184">      * @param prop   property to be deleted on shutdown</span>
<a href="#l2.185"></a><span id="l2.185">      *               (if null, |object| will be deleted)</span>
<a href="#l2.186"></a><span id="l2.186">      */</span>
<a href="#l2.187"></a><span id="l2.187">     registerForShutdownCleanup: shutdownCleanup</span>
<a href="#l2.188"></a><span id="l2.188"> };</span>
<a href="#l2.189"></a><span id="l2.189"> </span>
<a href="#l2.190"></a><span id="l2.190" class="difflineminus">-// following functions are local to this module:</span>
<a href="#l2.191"></a><span id="l2.191" class="difflineminus">-</span>
<a href="#l2.192"></a><span id="l2.192" class="difflineminus">-/**</span>
<a href="#l2.193"></a><span id="l2.193" class="difflineminus">- * Returns a function that provides cached access to whatever the passed</span>
<a href="#l2.194"></a><span id="l2.194" class="difflineminus">- * function returns.</span>
<a href="#l2.195"></a><span id="l2.195" class="difflineminus">- *</span>
<a href="#l2.196"></a><span id="l2.196" class="difflineminus">- * @param {function} func   The function to call for the value</span>
<a href="#l2.197"></a><span id="l2.197" class="difflineminus">- * @return {function}       A function that returns the (possibly cached) value</span>
<a href="#l2.198"></a><span id="l2.198" class="difflineminus">- */</span>
<a href="#l2.199"></a><span id="l2.199" class="difflineminus">-function _cached(func) {</span>
<a href="#l2.200"></a><span id="l2.200" class="difflineminus">-    let thing;</span>
<a href="#l2.201"></a><span id="l2.201" class="difflineminus">-    return function() {</span>
<a href="#l2.202"></a><span id="l2.202" class="difflineminus">-        if (typeof thing == &quot;undefined&quot;) {</span>
<a href="#l2.203"></a><span id="l2.203" class="difflineminus">-            thing = func();</span>
<a href="#l2.204"></a><span id="l2.204" class="difflineminus">-        }</span>
<a href="#l2.205"></a><span id="l2.205" class="difflineminus">-        return thing;</span>
<a href="#l2.206"></a><span id="l2.206" class="difflineminus">-    };</span>
<a href="#l2.207"></a><span id="l2.207" class="difflineminus">-}</span>
<a href="#l2.208"></a><span id="l2.208" class="difflineplus">+// Sub-modules for calUtils</span>
<a href="#l2.209"></a><span id="l2.209" class="difflineplus">+XPCOMUtils.defineLazyModuleGetter(cal, &quot;dtz&quot;, &quot;resource://calendar/modules/calDateTimeUtils.jsm&quot;, &quot;caldtz&quot;);</span>
<a href="#l2.210"></a><span id="l2.210"> </span>
<a href="#l2.211"></a><span id="l2.211"> /**</span>
<a href="#l2.212"></a><span id="l2.212">  * Returns a function that provides access to the given service.</span>
<a href="#l2.213"></a><span id="l2.213">  *</span>
<a href="#l2.214"></a><span id="l2.214">  * @param cid           The contract id to create</span>
<a href="#l2.215"></a><span id="l2.215">  * @param iid           The interface id to create with</span>
<a href="#l2.216"></a><span id="l2.216">  * @return {function}   A function that returns the given service</span>
<a href="#l2.217"></a><span id="l2.217">  */</span>
<a href="#l2.218"></a><span id="l2.218" class="difflineat">@@ -1087,8 +1001,12 @@ function shutdownCleanup(obj, prop) {</span>
<a href="#l2.219"></a><span id="l2.219"> </span>
<a href="#l2.220"></a><span id="l2.220"> // Interim import of all symbols into cal:</span>
<a href="#l2.221"></a><span id="l2.221"> // This should serve as a clean start for new code, e.g. new code could use</span>
<a href="#l2.222"></a><span id="l2.222"> // cal.createDatetime instead of plain createDatetime NOW.</span>
<a href="#l2.223"></a><span id="l2.223"> cal.loadScripts([&quot;calUtils.js&quot;], cal);</span>
<a href="#l2.224"></a><span id="l2.224"> // Some functions in calUtils.js refer to other in the same file, thus include</span>
<a href="#l2.225"></a><span id="l2.225"> // the code in global scope (although only visible to this module file), too:</span>
<a href="#l2.226"></a><span id="l2.226"> cal.loadScripts([&quot;calUtils.js&quot;], Components.utils.getGlobalForObject(cal));</span>
<a href="#l2.227"></a><span id="l2.227" class="difflineplus">+</span>
<a href="#l2.228"></a><span id="l2.228" class="difflineplus">+// Backwards compatibility for bug 905097. Please remove with Thunderbird 61.</span>
<a href="#l2.229"></a><span id="l2.229" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calUtilsCompat.jsm&quot;);</span>
<a href="#l2.230"></a><span id="l2.230" class="difflineplus">+injectCalUtilsCompat(cal);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1">new file mode 100644</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineminus">--- /dev/null</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineplus">+++ b/calendar/base/modules/calUtilsCompat.jsm</span>
<a href="#l3.4"></a><span id="l3.4" class="difflineat">@@ -0,0 +1,82 @@</span>
<a href="#l3.5"></a><span id="l3.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l3.6"></a><span id="l3.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l3.7"></a><span id="l3.7" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l3.8"></a><span id="l3.8" class="difflineplus">+</span>
<a href="#l3.9"></a><span id="l3.9" class="difflineplus">+/*</span>
<a href="#l3.10"></a><span id="l3.10" class="difflineplus">+ * Backwards compat for calUtils migration.</span>
<a href="#l3.11"></a><span id="l3.11" class="difflineplus">+ */</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Deprecated.jsm&quot;);</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+/* exported injectCalUtilsCompat */</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+this.EXPORTED_SYMBOLS = [&quot;injectCalUtilsCompat&quot;];</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineplus">+</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineplus">+/**</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineplus">+ * Migration data for backwards compatibility, will be used with</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineplus">+ * injectCalUtilsCompat.</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineplus">+ */</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineplus">+var migrations = {</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineplus">+    dtz: {</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineplus">+        now: &quot;now&quot;,</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineplus">+        ensureDateTime: &quot;ensureDateTime&quot;,</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineplus">+        getRecentTimezones: &quot;getRecentTimezones&quot;,</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineplus">+        saveRecentTimezone: &quot;saveRecentTimezone&quot;,</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineplus">+        getDefaultStartDate: &quot;getDefaultStartDate&quot;,</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineplus">+        setDefaultStartEndHour: &quot;setDefaultStartEndHour&quot;,</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineplus">+        calGetStartDateProp: &quot;startDateProp&quot;,</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineplus">+        calGetEndDateProp: &quot;endDateProp&quot;,</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineplus">+        sameDay: &quot;sameDay&quot;,</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineplus">+        jsDateToDateTime: &quot;jsDateToDateTime&quot;,</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineplus">+        dateTimeToJsDate: &quot;dateTimeToJsDate&quot;,</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineplus">+</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineplus">+        // The following are now getters</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineplus">+        calendarDefaultTimezone: &quot;defaultTimezone&quot;,</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineplus">+        floating: &quot;floating&quot;,</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineplus">+        UTC: &quot;UTC&quot;</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineplus">+    }</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineplus">+};</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineplus">+</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineplus">+/**</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineplus">+ * Generate a forward function on the given global, for the namespace from the</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineplus">+ * migrations data.</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineplus">+ *</span>
<a href="#l3.48"></a><span id="l3.48" class="difflineplus">+ * @param global        The global object to inject on.</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineplus">+ * @param namespace     The new namespace in the cal object.</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineplus">+ * @param from          The function/property name being migrated from</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineplus">+ * @param to            The function/property name being migrated to</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineplus">+ */</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineplus">+function generateForward(global, namespace, from, to) {</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineplus">+    // Protect from footguns</span>
<a href="#l3.55"></a><span id="l3.55" class="difflineplus">+    if (typeof global[from] != &quot;undefined&quot;) {</span>
<a href="#l3.56"></a><span id="l3.56" class="difflineplus">+        throw new Error(from + &quot; is already defined on the cal. namespace!&quot;);</span>
<a href="#l3.57"></a><span id="l3.57" class="difflineplus">+    }</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineplus">+</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineplus">+    global[from] = function(...args) {</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineplus">+        let suffix = &quot;&quot;;</span>
<a href="#l3.61"></a><span id="l3.61" class="difflineplus">+        let target = global[namespace][to];</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineplus">+        if (typeof target == &quot;function&quot;) {</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineplus">+            target = target(...args);</span>
<a href="#l3.64"></a><span id="l3.64" class="difflineplus">+            suffix = &quot;()&quot;;</span>
<a href="#l3.65"></a><span id="l3.65" class="difflineplus">+        }</span>
<a href="#l3.66"></a><span id="l3.66" class="difflineplus">+</span>
<a href="#l3.67"></a><span id="l3.67" class="difflineplus">+        Deprecated.warning(`calUtils' cal.${from}() has changed to cal.${namespace}.${to}${suffix}`,</span>
<a href="#l3.68"></a><span id="l3.68" class="difflineplus">+                           &quot;https://bugzilla.mozilla.org/show_bug.cgi?id=905097&quot;,</span>
<a href="#l3.69"></a><span id="l3.69" class="difflineplus">+                           Components.stack.caller);</span>
<a href="#l3.70"></a><span id="l3.70" class="difflineplus">+</span>
<a href="#l3.71"></a><span id="l3.71" class="difflineplus">+        return target;</span>
<a href="#l3.72"></a><span id="l3.72" class="difflineplus">+    };</span>
<a href="#l3.73"></a><span id="l3.73" class="difflineplus">+}</span>
<a href="#l3.74"></a><span id="l3.74" class="difflineplus">+</span>
<a href="#l3.75"></a><span id="l3.75" class="difflineplus">+/**</span>
<a href="#l3.76"></a><span id="l3.76" class="difflineplus">+ * Inject the backwards compatibility functions using above migration data</span>
<a href="#l3.77"></a><span id="l3.77" class="difflineplus">+ *</span>
<a href="#l3.78"></a><span id="l3.78" class="difflineplus">+ * @param global        The global object to inject on.</span>
<a href="#l3.79"></a><span id="l3.79" class="difflineplus">+ */</span>
<a href="#l3.80"></a><span id="l3.80" class="difflineplus">+function injectCalUtilsCompat(global) {</span>
<a href="#l3.81"></a><span id="l3.81" class="difflineplus">+    for (let [namespace, nsdata] of Object.entries(migrations)) {</span>
<a href="#l3.82"></a><span id="l3.82" class="difflineplus">+        for (let [from, to] of Object.entries(nsdata)) {</span>
<a href="#l3.83"></a><span id="l3.83" class="difflineplus">+            generateForward(global, namespace, from, to);</span>
<a href="#l3.84"></a><span id="l3.84" class="difflineplus">+        }</span>
<a href="#l3.85"></a><span id="l3.85" class="difflineplus">+    }</span>
<a href="#l3.86"></a><span id="l3.86" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/calendar/base/modules/moz.build</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/calendar/base/modules/moz.build</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -2,22 +2,24 @@</span>
<a href="#l4.4"></a><span id="l4.4"> # This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l4.5"></a><span id="l4.5"> # License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l4.6"></a><span id="l4.6"> # file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l4.7"></a><span id="l4.7"> </span>
<a href="#l4.8"></a><span id="l4.8"> EXTRA_JS_MODULES += [</span>
<a href="#l4.9"></a><span id="l4.9">     'calAlarmUtils.jsm',</span>
<a href="#l4.10"></a><span id="l4.10">     'calAsyncUtils.jsm',</span>
<a href="#l4.11"></a><span id="l4.11">     'calAuthUtils.jsm',</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+    'calDateTimeUtils.jsm',</span>
<a href="#l4.13"></a><span id="l4.13">     'calExtract.jsm',</span>
<a href="#l4.14"></a><span id="l4.14">     'calHashedArray.jsm',</span>
<a href="#l4.15"></a><span id="l4.15">     'calItemUtils.jsm',</span>
<a href="#l4.16"></a><span id="l4.16">     'calIteratorUtils.jsm',</span>
<a href="#l4.17"></a><span id="l4.17">     'calItipUtils.jsm',</span>
<a href="#l4.18"></a><span id="l4.18">     'calPrintUtils.jsm',</span>
<a href="#l4.19"></a><span id="l4.19">     'calProviderUtils.jsm',</span>
<a href="#l4.20"></a><span id="l4.20">     'calRecurrenceUtils.jsm',</span>
<a href="#l4.21"></a><span id="l4.21">     'calUtils.jsm',</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineplus">+    'calUtilsCompat.jsm',</span>
<a href="#l4.23"></a><span id="l4.23">     'calViewUtils.jsm',</span>
<a href="#l4.24"></a><span id="l4.24">     'calXMLUtils.jsm',</span>
<a href="#l4.25"></a><span id="l4.25">     'ical.js',</span>
<a href="#l4.26"></a><span id="l4.26"> ]</span>
<a href="#l4.27"></a><span id="l4.27"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/calendar/base/src/calIcsParser.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/calendar/base/src/calIcsParser.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -248,17 +248,21 @@ parserState.prototype = {</span>
<a href="#l5.4"></a><span id="l5.4"> </span>
<a href="#l5.5"></a><span id="l5.5">     /**</span>
<a href="#l5.6"></a><span id="l5.6">      * Checks if the timezones are missing and notifies the user via error console</span>
<a href="#l5.7"></a><span id="l5.7">      *</span>
<a href="#l5.8"></a><span id="l5.8">      * @param item      The item to check for</span>
<a href="#l5.9"></a><span id="l5.9">      * @param date      The datetime object to check with</span>
<a href="#l5.10"></a><span id="l5.10">      */</span>
<a href="#l5.11"></a><span id="l5.11">     checkTimezone: function(item, date) {</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-        if (date &amp;&amp; cal.isPhantomTimezone(date.timezone)) {</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+        function isPhantomTimezone(timezone) {</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+            return !timezone.icalComponent &amp;&amp; !timezone.isUTC &amp;&amp; !timezone.isFloating;</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineplus">+        }</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineplus">+</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineplus">+        if (date &amp;&amp; isPhantomTimezone(date.timezone)) {</span>
<a href="#l5.18"></a><span id="l5.18">             let tzid = date.timezone.tzid;</span>
<a href="#l5.19"></a><span id="l5.19">             let hid = item.hashId + &quot;#&quot; + tzid;</span>
<a href="#l5.20"></a><span id="l5.20">             if (!(hid in this.tzErrors)) {</span>
<a href="#l5.21"></a><span id="l5.21">                 // For now, publish errors to console and alert user.</span>
<a href="#l5.22"></a><span id="l5.22">                 // In future, maybe make them available through an interface method</span>
<a href="#l5.23"></a><span id="l5.23">                 // so this UI code can be removed from the parser, and caller can</span>
<a href="#l5.24"></a><span id="l5.24">                 // choose whether to alert, or show user the problem items and ask</span>
<a href="#l5.25"></a><span id="l5.25">                 // for fixes, or something else.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/calendar/base/src/calUtils.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/calendar/base/src/calUtils.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -2,94 +2,38 @@</span>
<a href="#l6.4"></a><span id="l6.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l6.5"></a><span id="l6.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l6.6"></a><span id="l6.6"> </span>
<a href="#l6.7"></a><span id="l6.7"> /* This file contains commonly used functions in a centralized place so that</span>
<a href="#l6.8"></a><span id="l6.8">  * various components (and other js scopes) don't need to replicate them. Note</span>
<a href="#l6.9"></a><span id="l6.9">  * that loading this file twice in the same scope will throw errors.</span>
<a href="#l6.10"></a><span id="l6.10">  */</span>
<a href="#l6.11"></a><span id="l6.11"> </span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-/* exported saveRecentTimezone, getCalendarDirectory,</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">- *          isCalendarWritable, userCanAddItemsToCalendar,</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineminus">- *          userCanDeleteItemsFromCalendar, attendeeMatchesAddresses,</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineminus">- *          userCanRespondToInvitation, openCalendarWizard,</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineminus">- *          openCalendarProperties, calPrint, calRadioGroupSelectItem,</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineminus">- *          isItemSupported, getPrefCategoriesArray,</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineplus">+/* exported getCalendarDirectory, isCalendarWritable,</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineplus">+ *          userCanAddItemsToCalendar, userCanDeleteItemsFromCalendar,</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineplus">+ *          attendeeMatchesAddresses, userCanRespondToInvitation,</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineplus">+ *          openCalendarWizard, openCalendarProperties, calPrint,</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineplus">+ *          calRadioGroupSelectItem, isItemSupported, getPrefCategoriesArray,</span>
<a href="#l6.23"></a><span id="l6.23">  *          setPrefCategoriesFromArray, compareItems, calTryWrappedJSObject,</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineminus">- *          compareArrays, setDefaultStartEndHour, LOG, WARN, ERROR, showError,</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineminus">- *          getContrastingTextColor, calGetEndDateProp, checkIfInRange,</span>
<a href="#l6.26"></a><span id="l6.26" class="difflineminus">- *          getProgressAtom, sendMailTo, sameDay, calSetProdidVersion,</span>
<a href="#l6.27"></a><span id="l6.27" class="difflineminus">- *          applyAttributeToMenuChildren, isPropertyValueSame,</span>
<a href="#l6.28"></a><span id="l6.28" class="difflineminus">- *          getParentNodeOrThis, getParentNodeOrThisByAttribute,</span>
<a href="#l6.29"></a><span id="l6.29" class="difflineminus">- *          setItemProperty, calIterateEmailIdentities, compareItemContent,</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineminus">- *          binaryInsert, getCompositeCalendar, findItemWindow</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineplus">+ *          compareArrays, LOG, WARN, ERROR, showError,</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineplus">+ *          getContrastingTextColor, checkIfInRange, getProgressAtom,</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineplus">+ *          sendMailTo, calSetProdidVersion, applyAttributeToMenuChildren,</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineplus">+ *          isPropertyValueSame, getParentNodeOrThis,</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineplus">+ *          getParentNodeOrThisByAttribute, setItemProperty,</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineplus">+ *          calIterateEmailIdentities, compareItemContent, binaryInsert,</span>
<a href="#l6.37"></a><span id="l6.37" class="difflineplus">+ *          getCompositeCalendar, findItemWindow</span>
<a href="#l6.38"></a><span id="l6.38">  */</span>
<a href="#l6.39"></a><span id="l6.39"> </span>
<a href="#l6.40"></a><span id="l6.40"> Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l6.41"></a><span id="l6.41"> Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l6.42"></a><span id="l6.42"> Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l6.43"></a><span id="l6.43"> Components.utils.import(&quot;resource://gre/modules/Preferences.jsm&quot;);</span>
<a href="#l6.44"></a><span id="l6.44"> Components.utils.import(&quot;resource://gre/modules/AppConstants.jsm&quot;);</span>
<a href="#l6.45"></a><span id="l6.45"> </span>
<a href="#l6.46"></a><span id="l6.46"> /**</span>
<a href="#l6.47"></a><span id="l6.47" class="difflineminus">- * Makes sure the given timezone id is part of the list of recent timezones.</span>
<a href="#l6.48"></a><span id="l6.48" class="difflineminus">- *</span>
<a href="#l6.49"></a><span id="l6.49" class="difflineminus">- * @param aTzid     The timezone id to add</span>
<a href="#l6.50"></a><span id="l6.50" class="difflineminus">- */</span>
<a href="#l6.51"></a><span id="l6.51" class="difflineminus">-function saveRecentTimezone(aTzid) {</span>
<a href="#l6.52"></a><span id="l6.52" class="difflineminus">-    let recentTimezones = getRecentTimezones();</span>
<a href="#l6.53"></a><span id="l6.53" class="difflineminus">-    const MAX_RECENT_TIMEZONES = 5; // We don't need a pref for *everything*.</span>
<a href="#l6.54"></a><span id="l6.54" class="difflineminus">-</span>
<a href="#l6.55"></a><span id="l6.55" class="difflineminus">-    if (aTzid != calendarDefaultTimezone().tzid &amp;&amp;</span>
<a href="#l6.56"></a><span id="l6.56" class="difflineminus">-        !recentTimezones.includes(aTzid)) {</span>
<a href="#l6.57"></a><span id="l6.57" class="difflineminus">-        // Add the timezone if its not already the default timezone</span>
<a href="#l6.58"></a><span id="l6.58" class="difflineminus">-        recentTimezones.unshift(aTzid);</span>
<a href="#l6.59"></a><span id="l6.59" class="difflineminus">-        recentTimezones.splice(MAX_RECENT_TIMEZONES);</span>
<a href="#l6.60"></a><span id="l6.60" class="difflineminus">-        Preferences.set(&quot;calendar.timezone.recent&quot;, JSON.stringify(recentTimezones));</span>
<a href="#l6.61"></a><span id="l6.61" class="difflineminus">-    }</span>
<a href="#l6.62"></a><span id="l6.62" class="difflineminus">-}</span>
<a href="#l6.63"></a><span id="l6.63" class="difflineminus">-</span>
<a href="#l6.64"></a><span id="l6.64" class="difflineminus">-/**</span>
<a href="#l6.65"></a><span id="l6.65" class="difflineminus">- * Gets the list of recent timezones. Optionally retuns the list as</span>
<a href="#l6.66"></a><span id="l6.66" class="difflineminus">- * calITimezones.</span>
<a href="#l6.67"></a><span id="l6.67" class="difflineminus">- *</span>
<a href="#l6.68"></a><span id="l6.68" class="difflineminus">- * @param aConvertZones     (optional) If true, return calITimezones instead</span>
<a href="#l6.69"></a><span id="l6.69" class="difflineminus">- * @return                  An array of timezone ids or calITimezones.</span>
<a href="#l6.70"></a><span id="l6.70" class="difflineminus">- */</span>
<a href="#l6.71"></a><span id="l6.71" class="difflineminus">-function getRecentTimezones(aConvertZones) {</span>
<a href="#l6.72"></a><span id="l6.72" class="difflineminus">-    let recentTimezones = JSON.parse(Preferences.get(&quot;calendar.timezone.recent&quot;, &quot;[]&quot;) || &quot;[]&quot;);</span>
<a href="#l6.73"></a><span id="l6.73" class="difflineminus">-    if (!Array.isArray(recentTimezones)) {</span>
<a href="#l6.74"></a><span id="l6.74" class="difflineminus">-        recentTimezones = [];</span>
<a href="#l6.75"></a><span id="l6.75" class="difflineminus">-    }</span>
<a href="#l6.76"></a><span id="l6.76" class="difflineminus">-</span>
<a href="#l6.77"></a><span id="l6.77" class="difflineminus">-    let tzService = cal.getTimezoneService();</span>
<a href="#l6.78"></a><span id="l6.78" class="difflineminus">-    if (aConvertZones) {</span>
<a href="#l6.79"></a><span id="l6.79" class="difflineminus">-        let oldZonesLength = recentTimezones.length;</span>
<a href="#l6.80"></a><span id="l6.80" class="difflineminus">-        for (let i = 0; i &lt; recentTimezones.length; i++) {</span>
<a href="#l6.81"></a><span id="l6.81" class="difflineminus">-            let timezone = tzService.getTimezone(recentTimezones[i]);</span>
<a href="#l6.82"></a><span id="l6.82" class="difflineminus">-            if (timezone) {</span>
<a href="#l6.83"></a><span id="l6.83" class="difflineminus">-                // Replace id with found timezone</span>
<a href="#l6.84"></a><span id="l6.84" class="difflineminus">-                recentTimezones[i] = timezone;</span>
<a href="#l6.85"></a><span id="l6.85" class="difflineminus">-            } else {</span>
<a href="#l6.86"></a><span id="l6.86" class="difflineminus">-                // Looks like the timezone doesn't longer exist, remove it</span>
<a href="#l6.87"></a><span id="l6.87" class="difflineminus">-                recentTimezones.splice(i, 1);</span>
<a href="#l6.88"></a><span id="l6.88" class="difflineminus">-                i--;</span>
<a href="#l6.89"></a><span id="l6.89" class="difflineminus">-            }</span>
<a href="#l6.90"></a><span id="l6.90" class="difflineminus">-        }</span>
<a href="#l6.91"></a><span id="l6.91" class="difflineminus">-</span>
<a href="#l6.92"></a><span id="l6.92" class="difflineminus">-        if (oldZonesLength != recentTimezones.length) {</span>
<a href="#l6.93"></a><span id="l6.93" class="difflineminus">-            // Looks like the one or other timezone dropped out. Go ahead and</span>
<a href="#l6.94"></a><span id="l6.94" class="difflineminus">-            // modify the pref.</span>
<a href="#l6.95"></a><span id="l6.95" class="difflineminus">-            Preferences.set(&quot;calendar.timezone.recent&quot;, JSON.stringify(recentTimezones));</span>
<a href="#l6.96"></a><span id="l6.96" class="difflineminus">-        }</span>
<a href="#l6.97"></a><span id="l6.97" class="difflineminus">-    }</span>
<a href="#l6.98"></a><span id="l6.98" class="difflineminus">-    return recentTimezones;</span>
<a href="#l6.99"></a><span id="l6.99" class="difflineminus">-}</span>
<a href="#l6.100"></a><span id="l6.100" class="difflineminus">-</span>
<a href="#l6.101"></a><span id="l6.101" class="difflineminus">-/**</span>
<a href="#l6.102"></a><span id="l6.102">  * Format the given string to work inside a CSS rule selector</span>
<a href="#l6.103"></a><span id="l6.103">  * (and as part of a non-unicode preference key).</span>
<a href="#l6.104"></a><span id="l6.104">  *</span>
<a href="#l6.105"></a><span id="l6.105">  * Replaces each space ' ' char with '_'.</span>
<a href="#l6.106"></a><span id="l6.106">  * Replaces each char other than ascii digits and letters, with '-uxHHH-'</span>
<a href="#l6.107"></a><span id="l6.107">  * where HHH is unicode in hexadecimal (variable length, terminated by the '-').</span>
<a href="#l6.108"></a><span id="l6.108">  *</span>
<a href="#l6.109"></a><span id="l6.109">  * Ensures: result only contains ascii digits, letters,'-', and '_'.</span>
<a href="#l6.110"></a><span id="l6.110" class="difflineat">@@ -281,25 +225,16 @@ function calPrint(aWindow) {</span>
<a href="#l6.111"></a><span id="l6.111">                        &quot;centerscreen,chrome,resizable&quot;);</span>
<a href="#l6.112"></a><span id="l6.112"> }</span>
<a href="#l6.113"></a><span id="l6.113"> </span>
<a href="#l6.114"></a><span id="l6.114"> /**</span>
<a href="#l6.115"></a><span id="l6.115">  * Other functions</span>
<a href="#l6.116"></a><span id="l6.116">  */</span>
<a href="#l6.117"></a><span id="l6.117"> </span>
<a href="#l6.118"></a><span id="l6.118"> /**</span>
<a href="#l6.119"></a><span id="l6.119" class="difflineminus">- * Returns a calIDateTime that corresponds to the current time in the user's</span>
<a href="#l6.120"></a><span id="l6.120" class="difflineminus">- * default timezone.</span>
<a href="#l6.121"></a><span id="l6.121" class="difflineminus">- */</span>
<a href="#l6.122"></a><span id="l6.122" class="difflineminus">-function now() {</span>
<a href="#l6.123"></a><span id="l6.123" class="difflineminus">-    let date = cal.jsDateToDateTime(new Date());</span>
<a href="#l6.124"></a><span id="l6.124" class="difflineminus">-    return date.getInTimezone(calendarDefaultTimezone());</span>
<a href="#l6.125"></a><span id="l6.125" class="difflineminus">-}</span>
<a href="#l6.126"></a><span id="l6.126" class="difflineminus">-</span>
<a href="#l6.127"></a><span id="l6.127" class="difflineminus">-/**</span>
<a href="#l6.128"></a><span id="l6.128">  * Selects an item with id aItemId in the radio group with id aRadioGroupId</span>
<a href="#l6.129"></a><span id="l6.129">  *</span>
<a href="#l6.130"></a><span id="l6.130">  * @param aRadioGroupId  the id of the radio group which contains the item</span>
<a href="#l6.131"></a><span id="l6.131">  * @param aItemId        the item to be selected</span>
<a href="#l6.132"></a><span id="l6.132">  */</span>
<a href="#l6.133"></a><span id="l6.133"> function calRadioGroupSelectItem(aRadioGroupId, aItemId) {</span>
<a href="#l6.134"></a><span id="l6.134">     let radioGroup = document.getElementById(aRadioGroupId);</span>
<a href="#l6.135"></a><span id="l6.135">     let items = radioGroup.getElementsByTagName(&quot;radio&quot;);</span>
<a href="#l6.136"></a><span id="l6.136" class="difflineat">@@ -584,75 +519,16 @@ function compareArrays(aOne, aTwo, compa</span>
<a href="#l6.137"></a><span id="l6.137">     for (let i = 0; i &lt; len; ++i) {</span>
<a href="#l6.138"></a><span id="l6.138">         if (!compareFunc(aOne[i], aTwo[i])) {</span>
<a href="#l6.139"></a><span id="l6.139">             return false;</span>
<a href="#l6.140"></a><span id="l6.140">         }</span>
<a href="#l6.141"></a><span id="l6.141">     }</span>
<a href="#l6.142"></a><span id="l6.142">     return true;</span>
<a href="#l6.143"></a><span id="l6.143"> }</span>
<a href="#l6.144"></a><span id="l6.144"> </span>
<a href="#l6.145"></a><span id="l6.145" class="difflineminus">-/**</span>
<a href="#l6.146"></a><span id="l6.146" class="difflineminus">- * Many computations want to work only with date-times, not with dates.  This</span>
<a href="#l6.147"></a><span id="l6.147" class="difflineminus">- * method will return a proper datetime (set to midnight) for a date object.  If</span>
<a href="#l6.148"></a><span id="l6.148" class="difflineminus">- * the object is already a datetime, it will simply be returned.</span>
<a href="#l6.149"></a><span id="l6.149" class="difflineminus">- *</span>
<a href="#l6.150"></a><span id="l6.150" class="difflineminus">- * @param aDate  the date or datetime to check</span>
<a href="#l6.151"></a><span id="l6.151" class="difflineminus">- */</span>
<a href="#l6.152"></a><span id="l6.152" class="difflineminus">-function ensureDateTime(aDate) {</span>
<a href="#l6.153"></a><span id="l6.153" class="difflineminus">-    if (!aDate || !aDate.isDate) {</span>
<a href="#l6.154"></a><span id="l6.154" class="difflineminus">-        return aDate;</span>
<a href="#l6.155"></a><span id="l6.155" class="difflineminus">-    }</span>
<a href="#l6.156"></a><span id="l6.156" class="difflineminus">-    let newDate = aDate.clone();</span>
<a href="#l6.157"></a><span id="l6.157" class="difflineminus">-    newDate.isDate = false;</span>
<a href="#l6.158"></a><span id="l6.158" class="difflineminus">-    return newDate;</span>
<a href="#l6.159"></a><span id="l6.159" class="difflineminus">-}</span>
<a href="#l6.160"></a><span id="l6.160" class="difflineminus">-</span>
<a href="#l6.161"></a><span id="l6.161" class="difflineminus">-/**</span>
<a href="#l6.162"></a><span id="l6.162" class="difflineminus">- * Get the default event start date. This is the next full hour, or 23:00 if it</span>
<a href="#l6.163"></a><span id="l6.163" class="difflineminus">- * is past 23:00.</span>
<a href="#l6.164"></a><span id="l6.164" class="difflineminus">- *</span>
<a href="#l6.165"></a><span id="l6.165" class="difflineminus">- * @param aReferenceDate    If passed, the time of this date will be modified,</span>
<a href="#l6.166"></a><span id="l6.166" class="difflineminus">- *                            keeping the date and timezone intact.</span>
<a href="#l6.167"></a><span id="l6.167" class="difflineminus">- */</span>
<a href="#l6.168"></a><span id="l6.168" class="difflineminus">-function getDefaultStartDate(aReferenceDate) {</span>
<a href="#l6.169"></a><span id="l6.169" class="difflineminus">-    let startDate = now();</span>
<a href="#l6.170"></a><span id="l6.170" class="difflineminus">-    if (aReferenceDate) {</span>
<a href="#l6.171"></a><span id="l6.171" class="difflineminus">-        let savedHour = startDate.hour;</span>
<a href="#l6.172"></a><span id="l6.172" class="difflineminus">-        startDate = aReferenceDate;</span>
<a href="#l6.173"></a><span id="l6.173" class="difflineminus">-        if (!startDate.isMutable) {</span>
<a href="#l6.174"></a><span id="l6.174" class="difflineminus">-            startDate = startDate.clone();</span>
<a href="#l6.175"></a><span id="l6.175" class="difflineminus">-        }</span>
<a href="#l6.176"></a><span id="l6.176" class="difflineminus">-        startDate.isDate = false;</span>
<a href="#l6.177"></a><span id="l6.177" class="difflineminus">-        startDate.hour = savedHour;</span>
<a href="#l6.178"></a><span id="l6.178" class="difflineminus">-    }</span>
<a href="#l6.179"></a><span id="l6.179" class="difflineminus">-</span>
<a href="#l6.180"></a><span id="l6.180" class="difflineminus">-    startDate.second = 0;</span>
<a href="#l6.181"></a><span id="l6.181" class="difflineminus">-    startDate.minute = 0;</span>
<a href="#l6.182"></a><span id="l6.182" class="difflineminus">-    if (startDate.hour &lt; 23) {</span>
<a href="#l6.183"></a><span id="l6.183" class="difflineminus">-        startDate.hour++;</span>
<a href="#l6.184"></a><span id="l6.184" class="difflineminus">-    }</span>
<a href="#l6.185"></a><span id="l6.185" class="difflineminus">-    return startDate;</span>
<a href="#l6.186"></a><span id="l6.186" class="difflineminus">-}</span>
<a href="#l6.187"></a><span id="l6.187" class="difflineminus">-</span>
<a href="#l6.188"></a><span id="l6.188" class="difflineminus">-/**</span>
<a href="#l6.189"></a><span id="l6.189" class="difflineminus">- * Setup the default start and end hours of the given item. This can be a task</span>
<a href="#l6.190"></a><span id="l6.190" class="difflineminus">- * or an event.</span>
<a href="#l6.191"></a><span id="l6.191" class="difflineminus">- *</span>
<a href="#l6.192"></a><span id="l6.192" class="difflineminus">- * @param aItem             The item to set up the start and end date for.</span>
<a href="#l6.193"></a><span id="l6.193" class="difflineminus">- * @param aReferenceDate    If passed, the time of this date will be modified,</span>
<a href="#l6.194"></a><span id="l6.194" class="difflineminus">- *                            keeping the date and timezone intact.</span>
<a href="#l6.195"></a><span id="l6.195" class="difflineminus">- */</span>
<a href="#l6.196"></a><span id="l6.196" class="difflineminus">-function setDefaultStartEndHour(aItem, aReferenceDate) {</span>
<a href="#l6.197"></a><span id="l6.197" class="difflineminus">-    aItem[calGetStartDateProp(aItem)] = getDefaultStartDate(aReferenceDate);</span>
<a href="#l6.198"></a><span id="l6.198" class="difflineminus">-</span>
<a href="#l6.199"></a><span id="l6.199" class="difflineminus">-    if (isEvent(aItem)) {</span>
<a href="#l6.200"></a><span id="l6.200" class="difflineminus">-        aItem.endDate = aItem.startDate.clone();</span>
<a href="#l6.201"></a><span id="l6.201" class="difflineminus">-        aItem.endDate.minute += Preferences.get(&quot;calendar.event.defaultlength&quot;, 60);</span>
<a href="#l6.202"></a><span id="l6.202" class="difflineminus">-    }</span>
<a href="#l6.203"></a><span id="l6.203" class="difflineminus">-}</span>
<a href="#l6.204"></a><span id="l6.204"> </span>
<a href="#l6.205"></a><span id="l6.205"> /**</span>
<a href="#l6.206"></a><span id="l6.206">  * Helper used in the following log functions to actually log the message.</span>
<a href="#l6.207"></a><span id="l6.207">  * Should not be used outside of this file.</span>
<a href="#l6.208"></a><span id="l6.208">  */</span>
<a href="#l6.209"></a><span id="l6.209"> function _log(message, flag) {</span>
<a href="#l6.210"></a><span id="l6.210">     let frame = Components.stack.caller.caller;</span>
<a href="#l6.211"></a><span id="l6.211">     let filename = frame.filename ? frame.filename.split(&quot; -&gt; &quot;).pop() : null;</span>
<a href="#l6.212"></a><span id="l6.212" class="difflineat">@@ -785,54 +661,28 @@ function getContrastingTextColor(bgColor</span>
<a href="#l6.213"></a><span id="l6.213">     if (brightness &lt; 144) {</span>
<a href="#l6.214"></a><span id="l6.214">         return &quot;white&quot;;</span>
<a href="#l6.215"></a><span id="l6.215">     }</span>
<a href="#l6.216"></a><span id="l6.216"> </span>
<a href="#l6.217"></a><span id="l6.217">     return &quot;black&quot;;</span>
<a href="#l6.218"></a><span id="l6.218"> }</span>
<a href="#l6.219"></a><span id="l6.219"> </span>
<a href="#l6.220"></a><span id="l6.220"> /**</span>
<a href="#l6.221"></a><span id="l6.221" class="difflineminus">- * Returns the property name used for the start date of an item, ie either an</span>
<a href="#l6.222"></a><span id="l6.222" class="difflineminus">- * event's start date or a task's entry date.</span>
<a href="#l6.223"></a><span id="l6.223" class="difflineminus">- */</span>
<a href="#l6.224"></a><span id="l6.224" class="difflineminus">-function calGetStartDateProp(aItem) {</span>
<a href="#l6.225"></a><span id="l6.225" class="difflineminus">-    if (isEvent(aItem)) {</span>
<a href="#l6.226"></a><span id="l6.226" class="difflineminus">-        return &quot;startDate&quot;;</span>
<a href="#l6.227"></a><span id="l6.227" class="difflineminus">-    } else if (isToDo(aItem)) {</span>
<a href="#l6.228"></a><span id="l6.228" class="difflineminus">-        return &quot;entryDate&quot;;</span>
<a href="#l6.229"></a><span id="l6.229" class="difflineminus">-    }</span>
<a href="#l6.230"></a><span id="l6.230" class="difflineminus">-    throw Components.results.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l6.231"></a><span id="l6.231" class="difflineminus">-}</span>
<a href="#l6.232"></a><span id="l6.232" class="difflineminus">-</span>
<a href="#l6.233"></a><span id="l6.233" class="difflineminus">-/**</span>
<a href="#l6.234"></a><span id="l6.234" class="difflineminus">- * Returns the property name used for the end date of an item, ie either an</span>
<a href="#l6.235"></a><span id="l6.235" class="difflineminus">- * event's end date or a task's due date.</span>
<a href="#l6.236"></a><span id="l6.236" class="difflineminus">- */</span>
<a href="#l6.237"></a><span id="l6.237" class="difflineminus">-function calGetEndDateProp(aItem) {</span>
<a href="#l6.238"></a><span id="l6.238" class="difflineminus">-    if (isEvent(aItem)) {</span>
<a href="#l6.239"></a><span id="l6.239" class="difflineminus">-        return &quot;endDate&quot;;</span>
<a href="#l6.240"></a><span id="l6.240" class="difflineminus">-    } else if (isToDo(aItem)) {</span>
<a href="#l6.241"></a><span id="l6.241" class="difflineminus">-        return &quot;dueDate&quot;;</span>
<a href="#l6.242"></a><span id="l6.242" class="difflineminus">-    }</span>
<a href="#l6.243"></a><span id="l6.243" class="difflineminus">-    throw Components.results.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l6.244"></a><span id="l6.244" class="difflineminus">-}</span>
<a href="#l6.245"></a><span id="l6.245" class="difflineminus">-</span>
<a href="#l6.246"></a><span id="l6.246" class="difflineminus">-/**</span>
<a href="#l6.247"></a><span id="l6.247">  * Checks whether the passed item fits into the demanded range.</span>
<a href="#l6.248"></a><span id="l6.248">  *</span>
<a href="#l6.249"></a><span id="l6.249">  * @param item               the item</span>
<a href="#l6.250"></a><span id="l6.250">  * @param rangeStart         (inclusive) range start or null (open range)</span>
<a href="#l6.251"></a><span id="l6.251">  * @param rangeStart         (exclusive) range end or null (open range)</span>
<a href="#l6.252"></a><span id="l6.252">  * @param returnDtstartOrDue returns item's start (or due) date in case</span>
<a href="#l6.253"></a><span id="l6.253">  *                           the item is in the specified Range; null otherwise.</span>
<a href="#l6.254"></a><span id="l6.254">  */</span>
<a href="#l6.255"></a><span id="l6.255"> function checkIfInRange(item, rangeStart, rangeEnd, returnDtstartOrDue) {</span>
<a href="#l6.256"></a><span id="l6.256">     let startDate;</span>
<a href="#l6.257"></a><span id="l6.257">     let endDate;</span>
<a href="#l6.258"></a><span id="l6.258" class="difflineminus">-    let queryStart = ensureDateTime(rangeStart);</span>
<a href="#l6.259"></a><span id="l6.259" class="difflineplus">+    let queryStart = cal.ensureDateTime(rangeStart);</span>
<a href="#l6.260"></a><span id="l6.260">     if (isEvent(item)) {</span>
<a href="#l6.261"></a><span id="l6.261">         startDate = item.startDate;</span>
<a href="#l6.262"></a><span id="l6.262">         if (!startDate) { // DTSTART mandatory</span>
<a href="#l6.263"></a><span id="l6.263">             // xxx todo: should we assert this case?</span>
<a href="#l6.264"></a><span id="l6.264">             return null;</span>
<a href="#l6.265"></a><span id="l6.265">         }</span>
<a href="#l6.266"></a><span id="l6.266">         endDate = item.endDate || startDate;</span>
<a href="#l6.267"></a><span id="l6.267">     } else {</span>
<a href="#l6.268"></a><span id="l6.268" class="difflineat">@@ -841,28 +691,28 @@ function checkIfInRange(item, rangeStart</span>
<a href="#l6.269"></a><span id="l6.269">         if (!item.entryDate) {</span>
<a href="#l6.270"></a><span id="l6.270">             if (returnDtstartOrDue) { // DTSTART or DUE mandatory</span>
<a href="#l6.271"></a><span id="l6.271">                 return null;</span>
<a href="#l6.272"></a><span id="l6.272">             }</span>
<a href="#l6.273"></a><span id="l6.273">             // 3.6.2. To-do Component</span>
<a href="#l6.274"></a><span id="l6.274">             // A &quot;VTODO&quot; calendar component without the &quot;DTSTART&quot; and &quot;DUE&quot; (or</span>
<a href="#l6.275"></a><span id="l6.275">             // &quot;DURATION&quot;) properties specifies a to-do that will be associated</span>
<a href="#l6.276"></a><span id="l6.276">             // with each successive calendar date, until it is completed.</span>
<a href="#l6.277"></a><span id="l6.277" class="difflineminus">-            let completedDate = ensureDateTime(item.completedDate);</span>
<a href="#l6.278"></a><span id="l6.278" class="difflineminus">-            dueDate = ensureDateTime(dueDate);</span>
<a href="#l6.279"></a><span id="l6.279" class="difflineplus">+            let completedDate = cal.ensureDateTime(item.completedDate);</span>
<a href="#l6.280"></a><span id="l6.280" class="difflineplus">+            dueDate = cal.ensureDateTime(dueDate);</span>
<a href="#l6.281"></a><span id="l6.281">             return !completedDate || !queryStart ||</span>
<a href="#l6.282"></a><span id="l6.282">                    completedDate.compare(queryStart) &gt; 0 ||</span>
<a href="#l6.283"></a><span id="l6.283">                    (dueDate &amp;&amp; dueDate.compare(queryStart) &gt;= 0);</span>
<a href="#l6.284"></a><span id="l6.284">         }</span>
<a href="#l6.285"></a><span id="l6.285">         endDate = dueDate || startDate;</span>
<a href="#l6.286"></a><span id="l6.286">     }</span>
<a href="#l6.287"></a><span id="l6.287"> </span>
<a href="#l6.288"></a><span id="l6.288" class="difflineminus">-    let start = ensureDateTime(startDate);</span>
<a href="#l6.289"></a><span id="l6.289" class="difflineminus">-    let end = ensureDateTime(endDate);</span>
<a href="#l6.290"></a><span id="l6.290" class="difflineminus">-    let queryEnd = ensureDateTime(rangeEnd);</span>
<a href="#l6.291"></a><span id="l6.291" class="difflineplus">+    let start = cal.ensureDateTime(startDate);</span>
<a href="#l6.292"></a><span id="l6.292" class="difflineplus">+    let end = cal.ensureDateTime(endDate);</span>
<a href="#l6.293"></a><span id="l6.293" class="difflineplus">+    let queryEnd = cal.ensureDateTime(rangeEnd);</span>
<a href="#l6.294"></a><span id="l6.294"> </span>
<a href="#l6.295"></a><span id="l6.295">     if (start.compare(end) == 0) {</span>
<a href="#l6.296"></a><span id="l6.296">         if ((!queryStart || start.compare(queryStart) &gt;= 0) &amp;&amp;</span>
<a href="#l6.297"></a><span id="l6.297">             (!queryEnd || start.compare(queryEnd) &lt; 0)) {</span>
<a href="#l6.298"></a><span id="l6.298">             return startDate;</span>
<a href="#l6.299"></a><span id="l6.299">         }</span>
<a href="#l6.300"></a><span id="l6.300">     } else if ((!queryEnd || start.compare(queryEnd) &lt; 0) &amp;&amp;</span>
<a href="#l6.301"></a><span id="l6.301">                (!queryStart || end.compare(queryStart) &gt; 0)) {</span>
<a href="#l6.302"></a><span id="l6.302" class="difflineat">@@ -1082,27 +932,16 @@ calOperationGroup.prototype = {</span>
<a href="#l6.303"></a><span id="l6.303">             this.mSubOperations = [];</span>
<a href="#l6.304"></a><span id="l6.304">             for (let operation of subOperations) {</span>
<a href="#l6.305"></a><span id="l6.305">                 operation.cancel(Components.interfaces.calIErrors.OPERATION_CANCELLED);</span>
<a href="#l6.306"></a><span id="l6.306">             }</span>
<a href="#l6.307"></a><span id="l6.307">         }</span>
<a href="#l6.308"></a><span id="l6.308">     }</span>
<a href="#l6.309"></a><span id="l6.309"> };</span>
<a href="#l6.310"></a><span id="l6.310"> </span>
<a href="#l6.311"></a><span id="l6.311" class="difflineminus">-function sameDay(date1, date2) {</span>
<a href="#l6.312"></a><span id="l6.312" class="difflineminus">-    if (date1 &amp;&amp; date2) {</span>
<a href="#l6.313"></a><span id="l6.313" class="difflineminus">-        if ((date1.day == date2.day) &amp;&amp;</span>
<a href="#l6.314"></a><span id="l6.314" class="difflineminus">-            (date1.month == date2.month) &amp;&amp;</span>
<a href="#l6.315"></a><span id="l6.315" class="difflineminus">-            (date1.year == date2.year)) {</span>
<a href="#l6.316"></a><span id="l6.316" class="difflineminus">-            return true;</span>
<a href="#l6.317"></a><span id="l6.317" class="difflineminus">-        }</span>
<a href="#l6.318"></a><span id="l6.318" class="difflineminus">-    }</span>
<a href="#l6.319"></a><span id="l6.319" class="difflineminus">-    return false;</span>
<a href="#l6.320"></a><span id="l6.320" class="difflineminus">-}</span>
<a href="#l6.321"></a><span id="l6.321" class="difflineminus">-</span>
<a href="#l6.322"></a><span id="l6.322"> /**</span>
<a href="#l6.323"></a><span id="l6.323">  * Centralized funtions for accessing prodid and version</span>
<a href="#l6.324"></a><span id="l6.324">  */</span>
<a href="#l6.325"></a><span id="l6.325"> function calGetProductId() {</span>
<a href="#l6.326"></a><span id="l6.326">     return &quot;-//Mozilla.org/NONSGML Mozilla Calendar V1.1//EN&quot;;</span>
<a href="#l6.327"></a><span id="l6.327"> }</span>
<a href="#l6.328"></a><span id="l6.328"> function calGetProductVersion() {</span>
<a href="#l6.329"></a><span id="l6.329">     return &quot;2.0&quot;;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/calendar/providers/gdata/components/calGoogleCalendar.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/calendar/providers/gdata/components/calGoogleCalendar.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -6,16 +6,17 @@ Components.utils.import(&quot;resource://gre/</span>
<a href="#l7.4"></a><span id="l7.4"> Components.utils.import(&quot;resource://gre/modules/PromiseUtils.jsm&quot;);</span>
<a href="#l7.5"></a><span id="l7.5"> Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l7.6"></a><span id="l7.6"> Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l7.7"></a><span id="l7.7"> </span>
<a href="#l7.8"></a><span id="l7.8"> Components.utils.import(&quot;resource://calendar/modules/calAsyncUtils.jsm&quot;);</span>
<a href="#l7.9"></a><span id="l7.9"> Components.utils.import(&quot;resource://calendar/modules/calProviderUtils.jsm&quot;);</span>
<a href="#l7.10"></a><span id="l7.10"> Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l7.11"></a><span id="l7.11"> </span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+Components.utils.import(&quot;resource://gdata-provider/modules/calUtilsShim.jsm&quot;);</span>
<a href="#l7.13"></a><span id="l7.13"> Components.utils.import(&quot;resource://gdata-provider/modules/gdataLogging.jsm&quot;);</span>
<a href="#l7.14"></a><span id="l7.14"> Components.utils.import(&quot;resource://gdata-provider/modules/gdataRequest.jsm&quot;);</span>
<a href="#l7.15"></a><span id="l7.15"> Components.utils.import(&quot;resource://gdata-provider/modules/gdataSession.jsm&quot;);</span>
<a href="#l7.16"></a><span id="l7.16"> Components.utils.import(&quot;resource://gdata-provider/modules/gdataUtils.jsm&quot;);</span>
<a href="#l7.17"></a><span id="l7.17"> </span>
<a href="#l7.18"></a><span id="l7.18"> var cICL = Components.interfaces.calIChangeLog;</span>
<a href="#l7.19"></a><span id="l7.19"> var cIOL = Components.interfaces.calIOperationListener;</span>
<a href="#l7.20"></a><span id="l7.20"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/calendar/providers/gdata/content/gdata-calendar-event-dialog.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/calendar/providers/gdata/content/gdata-calendar-event-dialog.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -1,14 +1,17 @@</span>
<a href="#l8.4"></a><span id="l8.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l8.5"></a><span id="l8.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l8.6"></a><span id="l8.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l8.7"></a><span id="l8.7"> </span>
<a href="#l8.8"></a><span id="l8.8"> Components.utils.import(&quot;resource://gdata-provider/modules/gdataUtils.jsm&quot;);</span>
<a href="#l8.9"></a><span id="l8.9"> </span>
<a href="#l8.10"></a><span id="l8.10" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l8.11"></a><span id="l8.11" class="difflineplus">+Components.utils.import(&quot;resource://gdata-provider/modules/calUtilsShim.jsm&quot;);</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+</span>
<a href="#l8.13"></a><span id="l8.13"> (function() {</span>
<a href="#l8.14"></a><span id="l8.14"> </span>
<a href="#l8.15"></a><span id="l8.15">     // Older versions of Lightning don't have this variable.</span>
<a href="#l8.16"></a><span id="l8.16">     if (!(&quot;gOldEndTimezone&quot; in window)) {</span>
<a href="#l8.17"></a><span id="l8.17">         window.gOldEndTimezone = null;</span>
<a href="#l8.18"></a><span id="l8.18">     }</span>
<a href="#l8.19"></a><span id="l8.19"> </span>
<a href="#l8.20"></a><span id="l8.20">     monkeyPatch(window, &quot;updateCalendar&quot;, function(protofunc, ...args) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1">new file mode 100644</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineminus">--- /dev/null</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineplus">+++ b/calendar/providers/gdata/modules/calUtilsShim.jsm</span>
<a href="#l9.4"></a><span id="l9.4" class="difflineat">@@ -0,0 +1,27 @@</span>
<a href="#l9.5"></a><span id="l9.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l9.6"></a><span id="l9.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l9.7"></a><span id="l9.7" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l9.8"></a><span id="l9.8" class="difflineplus">+</span>
<a href="#l9.9"></a><span id="l9.9" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l9.10"></a><span id="l9.10" class="difflineplus">+</span>
<a href="#l9.11"></a><span id="l9.11" class="difflineplus">+this.EXPORTED_SYMBOLS = [&quot;cal&quot;];</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineplus">+</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+if (!cal.dtz) {</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineplus">+    cal.dtz = {</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineplus">+        get defaultTimezone() { return cal.calendarDefaultTimezone(); },</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineplus">+        get floating() { return cal.floating(); },</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineplus">+        get UTC() { return cal.UTC(); },</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineplus">+</span>
<a href="#l9.19"></a><span id="l9.19" class="difflineplus">+        now: (...args) =&gt; cal.now(...args),</span>
<a href="#l9.20"></a><span id="l9.20" class="difflineplus">+        ensureDateTime: (...args) =&gt; cal.ensureDateTime(...args),</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineplus">+        getRecentTimezones: (...args) =&gt; cal.getRecentTimezones(...args),</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineplus">+        saveRecentTimezone: (...args) =&gt; cal.saveRecentTimezone(...args),</span>
<a href="#l9.23"></a><span id="l9.23" class="difflineplus">+        getDefaultStartDate: (...args) =&gt; cal.getDefaultStartDate(...args),</span>
<a href="#l9.24"></a><span id="l9.24" class="difflineplus">+        setDefaultStartEndHour: (...args) =&gt; cal.setDefaultStartEndHour(...args),</span>
<a href="#l9.25"></a><span id="l9.25" class="difflineplus">+        startDateProp: (...args) =&gt; cal.calGetStartDateProp(...args),</span>
<a href="#l9.26"></a><span id="l9.26" class="difflineplus">+        endDateProp: (...args) =&gt; cal.calGetEndDateProp(...args),</span>
<a href="#l9.27"></a><span id="l9.27" class="difflineplus">+        sameDay: (...args) =&gt; cal.sameDay(...args),</span>
<a href="#l9.28"></a><span id="l9.28" class="difflineplus">+        jsDateToDateTime: (...args) =&gt; cal.jsDateToDateTime(...args),</span>
<a href="#l9.29"></a><span id="l9.29" class="difflineplus">+        dateTimeToJsDate: (...args) =&gt; cal.dateTimeToJsDate(...args)</span>
<a href="#l9.30"></a><span id="l9.30" class="difflineplus">+    };</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/calendar/providers/gdata/modules/gdataSession.jsm</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/calendar/providers/gdata/modules/gdataSession.jsm</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -13,16 +13,18 @@ Components.utils.import(&quot;resource://gre/</span>
<a href="#l10.4"></a><span id="l10.4"> Components.utils.import(&quot;resource://gre/modules/PromiseUtils.jsm&quot;);</span>
<a href="#l10.5"></a><span id="l10.5"> Components.utils.import(&quot;resource://gre/modules/Timer.jsm&quot;);</span>
<a href="#l10.6"></a><span id="l10.6"> </span>
<a href="#l10.7"></a><span id="l10.7"> Components.utils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;);</span>
<a href="#l10.8"></a><span id="l10.8"> </span>
<a href="#l10.9"></a><span id="l10.9"> Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l10.10"></a><span id="l10.10"> Components.utils.import(&quot;resource://calendar/modules/calProviderUtils.jsm&quot;);</span>
<a href="#l10.11"></a><span id="l10.11"> </span>
<a href="#l10.12"></a><span id="l10.12" class="difflineplus">+Components.utils.import(&quot;resource://gdata-provider/modules/calUtilsShim.jsm&quot;);</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+</span>
<a href="#l10.14"></a><span id="l10.14"> var cIFBI = Components.interfaces.calIFreeBusyInterval;</span>
<a href="#l10.15"></a><span id="l10.15"> var nIPM = Components.interfaces.nsIPermissionManager;</span>
<a href="#l10.16"></a><span id="l10.16"> </span>
<a href="#l10.17"></a><span id="l10.17"> var NOTIFY_TIMEOUT = 60 * 1000;</span>
<a href="#l10.18"></a><span id="l10.18"> </span>
<a href="#l10.19"></a><span id="l10.19"> var EXPORTED_SYMBOLS = [&quot;getGoogleSessionManager&quot;];</span>
<a href="#l10.20"></a><span id="l10.20"> </span>
<a href="#l10.21"></a><span id="l10.21"> var gdataSessionMap = new Map();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/calendar/providers/gdata/modules/gdataUtils.jsm</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/calendar/providers/gdata/modules/gdataUtils.jsm</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -9,16 +9,18 @@ Components.utils.import(&quot;resource://gdat</span>
<a href="#l11.4"></a><span id="l11.4"> Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l11.5"></a><span id="l11.5"> Components.utils.import(&quot;resource://gre/modules/Preferences.jsm&quot;);</span>
<a href="#l11.6"></a><span id="l11.6"> Components.utils.import(&quot;resource://gre/modules/PromiseUtils.jsm&quot;);</span>
<a href="#l11.7"></a><span id="l11.7"> </span>
<a href="#l11.8"></a><span id="l11.8"> Components.utils.import(&quot;resource://calendar/modules/calAsyncUtils.jsm&quot;);</span>
<a href="#l11.9"></a><span id="l11.9"> Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l11.10"></a><span id="l11.10"> Components.utils.import(&quot;resource://calendar/modules/calProviderUtils.jsm&quot;);</span>
<a href="#l11.11"></a><span id="l11.11"> </span>
<a href="#l11.12"></a><span id="l11.12" class="difflineplus">+Components.utils.import(&quot;resource://gdata-provider/modules/calUtilsShim.jsm&quot;);</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+</span>
<a href="#l11.14"></a><span id="l11.14"> var cIE = Components.interfaces.calIErrors;</span>
<a href="#l11.15"></a><span id="l11.15"> </span>
<a href="#l11.16"></a><span id="l11.16"> var FOUR_WEEKS_IN_MINUTES = 40320;</span>
<a href="#l11.17"></a><span id="l11.17"> </span>
<a href="#l11.18"></a><span id="l11.18"> var EXPORTED_SYMBOLS = [</span>
<a href="#l11.19"></a><span id="l11.19">     &quot;ItemToJSON&quot;, &quot;JSONToItem&quot;, &quot;ItemSaver&quot;,</span>
<a href="#l11.20"></a><span id="l11.20">     &quot;checkResolveConflict&quot;, &quot;getGoogleId&quot;,</span>
<a href="#l11.21"></a><span id="l11.21">     &quot;getItemMetadata&quot;, &quot;saveItemMetadata&quot;,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/calendar/providers/gdata/moz.build</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/calendar/providers/gdata/moz.build</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -7,16 +7,17 @@ XPI_NAME = 'gdata-provider'</span>
<a href="#l12.4"></a><span id="l12.4"> </span>
<a href="#l12.5"></a><span id="l12.5"> FINAL_TARGET_PP_FILES += ['install.rdf']</span>
<a href="#l12.6"></a><span id="l12.6"> </span>
<a href="#l12.7"></a><span id="l12.7"> DIRS += [</span>
<a href="#l12.8"></a><span id="l12.8">     'locales',</span>
<a href="#l12.9"></a><span id="l12.9"> ]</span>
<a href="#l12.10"></a><span id="l12.10"> </span>
<a href="#l12.11"></a><span id="l12.11"> EXTRA_JS_MODULES += [</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineplus">+    'modules/calUtilsShim.jsm',</span>
<a href="#l12.13"></a><span id="l12.13">     'modules/gdataLogging.jsm',</span>
<a href="#l12.14"></a><span id="l12.14">     'modules/gdataRequest.jsm',</span>
<a href="#l12.15"></a><span id="l12.15">     'modules/gdataSession.jsm',</span>
<a href="#l12.16"></a><span id="l12.16">     'modules/gdataUtils.jsm',</span>
<a href="#l12.17"></a><span id="l12.17">     'modules/OAuth2.jsm',</span>
<a href="#l12.18"></a><span id="l12.18">     'modules/timezoneMap.jsm',</span>
<a href="#l12.19"></a><span id="l12.19"> ]</span>
<a href="#l12.20"></a><span id="l12.20"> </span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

