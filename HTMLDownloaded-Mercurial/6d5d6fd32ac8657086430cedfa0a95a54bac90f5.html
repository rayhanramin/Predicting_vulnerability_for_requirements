<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 5132:6d5d6fd32ac8657086430cedfa0a95a54bac90f5</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 6d5d6fd32ac8657086430cedfa0a95a54bac90f5" />
<meta property="og:url" content="/comm-central/rev/6d5d6fd32ac8657086430cedfa0a95a54bac90f5" />
<meta property="og:description" content="Bug 545625 related.  bloat bustage fix.  Make sure gloda shuts down its" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 6d5d6fd32ac8657086430cedfa0a95a54bac90f5 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/6d5d6fd32ac8657086430cedfa0a95a54bac90f5">shortlog</a> |
<a href="/comm-central/log/6d5d6fd32ac8657086430cedfa0a95a54bac90f5">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/6d5d6fd32ac8657086430cedfa0a95a54bac90f5">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/6d5d6fd32ac8657086430cedfa0a95a54bac90f5">files</a> |
changeset |
<a href="/comm-central/raw-rev/6d5d6fd32ac8657086430cedfa0a95a54bac90f5">raw</a>  | <a href="/comm-central/archive/6d5d6fd32ac8657086430cedfa0a95a54bac90f5.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=545625">Bug 545625</a> related.  bloat bustage fix.  Make sure gloda shuts down its
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#65;&#110;&#100;&#114;&#101;&#119;&#32;&#83;&#117;&#116;&#104;&#101;&#114;&#108;&#97;&#110;&#100;&#32;&#60;&#97;&#115;&#117;&#116;&#104;&#101;&#114;&#108;&#97;&#110;&#100;&#64;&#97;&#115;&#117;&#116;&#104;&#101;&#114;&#108;&#97;&#110;&#100;&#46;&#111;&#114;&#103;&#62;</td></tr>
<tr><td></td><td class="date age">Wed, 10 Mar 2010 15:11:36 -0800</td></tr>

<tr>
 <td>changeset 5132</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/6d5d6fd32ac8657086430cedfa0a95a54bac90f5">6d5d6fd32ac8657086430cedfa0a95a54bac90f5</a></td>
</tr>



<tr>
<td>parent 5131</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/27da2a32b708f2e52b95a368d895e8fd957e0d66">27da2a32b708f2e52b95a368d895e8fd957e0d66</a>
</td>
</tr>

<tr>
<td>child 5133</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/7460caf101399c56afad8233874907def3ad0618">7460caf101399c56afad8233874907def3ad0618</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=6d5d6fd32ac8657086430cedfa0a95a54bac90f5">3974</a></td></tr>
<tr><td>push user</td><td>bugmail@asutherland.org</td></tr>
<tr><td>push date</td><td class="date age">Wed, 10 Mar 2010 23:12:18 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@6d5d6fd32ac8 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=6d5d6fd32ac8657086430cedfa0a95a54bac90f5">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=6d5d6fd32ac8657086430cedfa0a95a54bac90f5&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=6d5d6fd32ac8657086430cedfa0a95a54bac90f5&newProject=comm-central&newRevision=6d5d6fd32ac8657086430cedfa0a95a54bac90f5&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=6d5d6fd32ac8657086430cedfa0a95a54bac90f5&newProject=comm-central&newRevision=6d5d6fd32ac8657086430cedfa0a95a54bac90f5&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=6d5d6fd32ac8657086430cedfa0a95a54bac90f5&newProject=comm-central&newRevision=6d5d6fd32ac8657086430cedfa0a95a54bac90f5&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>

<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=545625">545625</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=545625">Bug 545625</a> related.  bloat bustage fix.  Make sure gloda shuts down its
datastore even when it is disabled.  This started showing up because the
default behavior of calling Close when destructed no longer will actually
cleanup because Close likes to get angry when async statements are in play
so you know to use AsyncClose. a=bustage fix.</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6d5d6fd32ac8657086430cedfa0a95a54bac90f5/mailnews/db/gloda/modules/indexer.js">mailnews/db/gloda/modules/indexer.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6d5d6fd32ac8657086430cedfa0a95a54bac90f5/mailnews/db/gloda/modules/indexer.js">file</a> |
<a href="/comm-central/annotate/6d5d6fd32ac8657086430cedfa0a95a54bac90f5/mailnews/db/gloda/modules/indexer.js">annotate</a> |
<a href="/comm-central/diff/6d5d6fd32ac8657086430cedfa0a95a54bac90f5/mailnews/db/gloda/modules/indexer.js">diff</a> |
<a href="/comm-central/comparison/6d5d6fd32ac8657086430cedfa0a95a54bac90f5/mailnews/db/gloda/modules/indexer.js">comparison</a> |
<a href="/comm-central/log/6d5d6fd32ac8657086430cedfa0a95a54bac90f5/mailnews/db/gloda/modules/indexer.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/db/gloda/modules/indexer.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/db/gloda/modules/indexer.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -344,16 +344,22 @@ var GlodaIndexer = {</span>
<a href="#l1.4"></a><span id="l1.4">       this._perfIndexStopwatch = Cc[&quot;@mozilla.org/stopwatch;1&quot;]</span>
<a href="#l1.5"></a><span id="l1.5">                                    .createInstance(Ci.nsIStopwatch);</span>
<a href="#l1.6"></a><span id="l1.6">       this._perfPauseStopwatch = Cc[&quot;@mozilla.org/stopwatch;1&quot;]</span>
<a href="#l1.7"></a><span id="l1.7">                                    .createInstance(Ci.nsIStopwatch);</span>
<a href="#l1.8"></a><span id="l1.8"> </span>
<a href="#l1.9"></a><span id="l1.9">     } catch (ex) {</span>
<a href="#l1.10"></a><span id="l1.10">       this._log.error(&quot;problem creating stopwatch!: &quot; + ex);</span>
<a href="#l1.11"></a><span id="l1.11">     }</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+    // register for shutdown notifications</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+    let observerService = Cc[&quot;@mozilla.org/observer-service;1&quot;]</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+                            .getService(Ci.nsIObserverService);</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineplus">+    observerService.addObserver(this, &quot;quit-application&quot;, false);</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineplus">+</span>
<a href="#l1.18"></a><span id="l1.18">     // figure out if event-driven indexing should be enabled...</span>
<a href="#l1.19"></a><span id="l1.19">     let prefService = Cc[&quot;@mozilla.org/preferences-service;1&quot;].</span>
<a href="#l1.20"></a><span id="l1.20">                         getService(Ci.nsIPrefService);</span>
<a href="#l1.21"></a><span id="l1.21">     let branch = prefService.getBranch(&quot;mailnews.database.global.indexer.&quot;);</span>
<a href="#l1.22"></a><span id="l1.22">     let eventDrivenEnabled = false; // default</span>
<a href="#l1.23"></a><span id="l1.23">     let performInitialSweep = true; // default</span>
<a href="#l1.24"></a><span id="l1.24">     try {</span>
<a href="#l1.25"></a><span id="l1.25">       eventDrivenEnabled = branch.getBoolPref(&quot;enabled&quot;);</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineat">@@ -397,29 +403,32 @@ var GlodaIndexer = {</span>
<a href="#l1.27"></a><span id="l1.27">     this._perfPauseStopwatch = null;</span>
<a href="#l1.28"></a><span id="l1.28"> </span>
<a href="#l1.29"></a><span id="l1.29">     // Remove listeners to avoid reference cycles on the off chance one of them</span>
<a href="#l1.30"></a><span id="l1.30">     // holds a reference to the indexer object.</span>
<a href="#l1.31"></a><span id="l1.31">     this._indexListeners = [];</span>
<a href="#l1.32"></a><span id="l1.32"> </span>
<a href="#l1.33"></a><span id="l1.33">     this._indexerIsShutdown = true;</span>
<a href="#l1.34"></a><span id="l1.34"> </span>
<a href="#l1.35"></a><span id="l1.35" class="difflineminus">-    if (!this.enabled)</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineminus">-      return;</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineminus">-</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineminus">-    this._log.info(&quot;Shutting Down&quot;);</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineplus">+    if (this.enabled)</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineplus">+      this._log.info(&quot;Shutting Down&quot;);</span>
<a href="#l1.41"></a><span id="l1.41"> </span>
<a href="#l1.42"></a><span id="l1.42">     // don't let anything try and convince us to start indexing again</span>
<a href="#l1.43"></a><span id="l1.43">     this.suppressIndexing = true;</span>
<a href="#l1.44"></a><span id="l1.44"> </span>
<a href="#l1.45"></a><span id="l1.45">     // If there is an active job and it has a cleanup handler, run it.</span>
<a href="#l1.46"></a><span id="l1.46">     if (this._curIndexingJob) {</span>
<a href="#l1.47"></a><span id="l1.47">       let workerDef = this._curIndexingJob._workerDef;</span>
<a href="#l1.48"></a><span id="l1.48" class="difflineminus">-      if (workerDef.cleanup)</span>
<a href="#l1.49"></a><span id="l1.49" class="difflineminus">-        workerDef.cleanup.call(workerDef.indexer, this._curIndexingJob);</span>
<a href="#l1.50"></a><span id="l1.50" class="difflineplus">+      try {</span>
<a href="#l1.51"></a><span id="l1.51" class="difflineplus">+        if (workerDef.cleanup)</span>
<a href="#l1.52"></a><span id="l1.52" class="difflineplus">+          workerDef.cleanup.call(workerDef.indexer, this._curIndexingJob);</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineplus">+      }</span>
<a href="#l1.54"></a><span id="l1.54" class="difflineplus">+      catch (ex) {</span>
<a href="#l1.55"></a><span id="l1.55" class="difflineplus">+        this._log.error(&quot;problem during worker cleanup during shutdown.&quot;);</span>
<a href="#l1.56"></a><span id="l1.56" class="difflineplus">+      }</span>
<a href="#l1.57"></a><span id="l1.57">     }</span>
<a href="#l1.58"></a><span id="l1.58">     // Definitely clean out the async call stack and any associated data</span>
<a href="#l1.59"></a><span id="l1.59">     this._callbackHandle.cleanup();</span>
<a href="#l1.60"></a><span id="l1.60">     this._workBatchData = undefined;</span>
<a href="#l1.61"></a><span id="l1.61"> </span>
<a href="#l1.62"></a><span id="l1.62">     // disable ourselves and all of the specific indexers</span>
<a href="#l1.63"></a><span id="l1.63">     this.enabled = false;</span>
<a href="#l1.64"></a><span id="l1.64"> </span>
<a href="#l1.65"></a><span id="l1.65" class="difflineat">@@ -495,21 +504,21 @@ var GlodaIndexer = {</span>
<a href="#l1.66"></a><span id="l1.66"> </span>
<a href="#l1.67"></a><span id="l1.67">   /**</span>
<a href="#l1.68"></a><span id="l1.68">    * Are we enabled, read: are we processing change events?</span>
<a href="#l1.69"></a><span id="l1.69">    */</span>
<a href="#l1.70"></a><span id="l1.70">   _enabled: false,</span>
<a href="#l1.71"></a><span id="l1.71">   get enabled() { return this._enabled; },</span>
<a href="#l1.72"></a><span id="l1.72">   set enabled(aEnable) {</span>
<a href="#l1.73"></a><span id="l1.73">     if (!this._enabled &amp;&amp; aEnable) {</span>
<a href="#l1.74"></a><span id="l1.74" class="difflineminus">-      // register for shutdown, offline notifications</span>
<a href="#l1.75"></a><span id="l1.75" class="difflineplus">+      // register for offline notifications</span>
<a href="#l1.76"></a><span id="l1.76">       let observerService = Cc[&quot;@mozilla.org/observer-service;1&quot;].</span>
<a href="#l1.77"></a><span id="l1.77">                               getService(Ci.nsIObserverService);</span>
<a href="#l1.78"></a><span id="l1.78" class="difflineminus">-      observerService.addObserver(this, &quot;network:offline-status-changed&quot;, false);</span>
<a href="#l1.79"></a><span id="l1.79" class="difflineminus">-      observerService.addObserver(this, &quot;quit-application&quot;, false);</span>
<a href="#l1.80"></a><span id="l1.80" class="difflineplus">+      observerService.addObserver(this, &quot;network:offline-status-changed&quot;,</span>
<a href="#l1.81"></a><span id="l1.81" class="difflineplus">+                                  false);</span>
<a href="#l1.82"></a><span id="l1.82"> </span>
<a href="#l1.83"></a><span id="l1.83">       // register for idle notification</span>
<a href="#l1.84"></a><span id="l1.84">       this._idleService.addIdleObserver(this, this._indexIdleThresholdSecs);</span>
<a href="#l1.85"></a><span id="l1.85"> </span>
<a href="#l1.86"></a><span id="l1.86">       this._enabled = true;</span>
<a href="#l1.87"></a><span id="l1.87"> </span>
<a href="#l1.88"></a><span id="l1.88">       for each (let [iIndexer, indexer] in Iterator(this._indexers)) {</span>
<a href="#l1.89"></a><span id="l1.89">         try {</span>
<a href="#l1.90"></a><span id="l1.90" class="difflineat">@@ -534,21 +543,20 @@ var GlodaIndexer = {</span>
<a href="#l1.91"></a><span id="l1.91">       for each (let [iIndexer, indexer] in Iterator(this._indexers)) {</span>
<a href="#l1.92"></a><span id="l1.92">         try {</span>
<a href="#l1.93"></a><span id="l1.93">           indexer.disable();</span>
<a href="#l1.94"></a><span id="l1.94">         } catch (ex) {</span>
<a href="#l1.95"></a><span id="l1.95">           this._log.warn(&quot;Helper indexer threw exception on disable: &quot; + ex);</span>
<a href="#l1.96"></a><span id="l1.96">         }</span>
<a href="#l1.97"></a><span id="l1.97">       }</span>
<a href="#l1.98"></a><span id="l1.98"> </span>
<a href="#l1.99"></a><span id="l1.99" class="difflineminus">-      // remove observer; no more events to observe!</span>
<a href="#l1.100"></a><span id="l1.100" class="difflineplus">+      // remove offline observer</span>
<a href="#l1.101"></a><span id="l1.101">       let observerService = Cc[&quot;@mozilla.org/observer-service;1&quot;].</span>
<a href="#l1.102"></a><span id="l1.102">                               getService(Ci.nsIObserverService);</span>
<a href="#l1.103"></a><span id="l1.103">       observerService.removeObserver(this, &quot;network:offline-status-changed&quot;);</span>
<a href="#l1.104"></a><span id="l1.104" class="difflineminus">-      observerService.removeObserver(this, &quot;quit-application&quot;);</span>
<a href="#l1.105"></a><span id="l1.105"> </span>
<a href="#l1.106"></a><span id="l1.106">       // remove idle</span>
<a href="#l1.107"></a><span id="l1.107">       this._idleService.removeIdleObserver(this, this._indexIdleThresholdSecs);</span>
<a href="#l1.108"></a><span id="l1.108"> </span>
<a href="#l1.109"></a><span id="l1.109">       this._enabled = false;</span>
<a href="#l1.110"></a><span id="l1.110">     }</span>
<a href="#l1.111"></a><span id="l1.111"> </span>
<a href="#l1.112"></a><span id="l1.112">   },</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

