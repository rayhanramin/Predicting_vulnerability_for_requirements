<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 22083:5a8396d48e9e9b461a5ce27fa09f31f4f77dc073</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 5a8396d48e9e9b461a5ce27fa09f31f4f77dc073" />
<meta property="og:url" content="/comm-central/rev/5a8396d48e9e9b461a5ce27fa09f31f4f77dc073" />
<meta property="og:description" content="Bug 1393219 - Fix white-space issues in mimedrft.cpp. rs=white-space-only" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 5a8396d48e9e9b461a5ce27fa09f31f4f77dc073 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/5a8396d48e9e9b461a5ce27fa09f31f4f77dc073">shortlog</a> |
<a href="/comm-central/log/5a8396d48e9e9b461a5ce27fa09f31f4f77dc073">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/5a8396d48e9e9b461a5ce27fa09f31f4f77dc073">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/5a8396d48e9e9b461a5ce27fa09f31f4f77dc073">files</a> |
changeset |
<a href="/comm-central/raw-rev/5a8396d48e9e9b461a5ce27fa09f31f4f77dc073">raw</a>  | <a href="/comm-central/archive/5a8396d48e9e9b461a5ce27fa09f31f4f77dc073.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1393219">Bug 1393219</a> - Fix white-space issues in mimedrft.cpp. rs=white-space-only
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#74;&#111;&#114;&#103;&#32;&#75;&#32;&#60;&#106;&#111;&#114;&#103;&#107;&#64;&#106;&#111;&#114;&#103;&#107;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Thu, 07 Sep 2017 13:53:53 +0200</td></tr>

<tr>
 <td>changeset 22083</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/5a8396d48e9e9b461a5ce27fa09f31f4f77dc073">5a8396d48e9e9b461a5ce27fa09f31f4f77dc073</a></td>
</tr>



<tr>
<td>parent 22082</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/b6e47292fdffc8ee8f86178e373c6b35af2aae55">b6e47292fdffc8ee8f86178e373c6b35af2aae55</a>
</td>
</tr>

<tr>
<td>child 22084</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/5a6d6607eee5f491232a2679fb7687e1b3623503">5a6d6607eee5f491232a2679fb7687e1b3623503</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=5a8396d48e9e9b461a5ce27fa09f31f4f77dc073">13483</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Thu, 07 Sep 2017 11:56:58 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@5a8396d48e9e [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=5a8396d48e9e9b461a5ce27fa09f31f4f77dc073">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=5a8396d48e9e9b461a5ce27fa09f31f4f77dc073&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=5a8396d48e9e9b461a5ce27fa09f31f4f77dc073&newProject=comm-central&newRevision=b6e47292fdffc8ee8f86178e373c6b35af2aae55&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=5a8396d48e9e9b461a5ce27fa09f31f4f77dc073&newProject=comm-central&newRevision=b6e47292fdffc8ee8f86178e373c6b35af2aae55&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=5a8396d48e9e9b461a5ce27fa09f31f4f77dc073&newProject=comm-central&newRevision=b6e47292fdffc8ee8f86178e373c6b35af2aae55&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28white-space-only%29&revcount=50">white-space-only</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1393219">1393219</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1393219">Bug 1393219</a> - Fix white-space issues in mimedrft.cpp. rs=white-space-only</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5a8396d48e9e9b461a5ce27fa09f31f4f77dc073/mailnews/mime/src/mimedrft.cpp">mailnews/mime/src/mimedrft.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5a8396d48e9e9b461a5ce27fa09f31f4f77dc073/mailnews/mime/src/mimedrft.cpp">file</a> |
<a href="/comm-central/annotate/5a8396d48e9e9b461a5ce27fa09f31f4f77dc073/mailnews/mime/src/mimedrft.cpp">annotate</a> |
<a href="/comm-central/diff/5a8396d48e9e9b461a5ce27fa09f31f4f77dc073/mailnews/mime/src/mimedrft.cpp">diff</a> |
<a href="/comm-central/comparison/5a8396d48e9e9b461a5ce27fa09f31f4f77dc073/mailnews/mime/src/mimedrft.cpp">comparison</a> |
<a href="/comm-central/log/5a8396d48e9e9b461a5ce27fa09f31f4f77dc073/mailnews/mime/src/mimedrft.cpp">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/mime/src/mimedrft.cpp</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/mime/src/mimedrft.cpp</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -60,19 +60,19 @@ using namespace mozilla::mailnews;</span>
<a href="#l1.4"></a><span id="l1.4"> #define HEADER_START_JUNK             &quot;&lt;TR&gt;&lt;TH VALIGN=BASELINE ALIGN=RIGHT NOWRAP&gt;&quot;</span>
<a href="#l1.5"></a><span id="l1.5"> #define HEADER_MIDDLE_JUNK            &quot;: &lt;/TH&gt;&lt;TD&gt;&quot;</span>
<a href="#l1.6"></a><span id="l1.6"> #define HEADER_END_JUNK               &quot;&lt;/TD&gt;&lt;/TR&gt;&quot;</span>
<a href="#l1.7"></a><span id="l1.7"> </span>
<a href="#l1.8"></a><span id="l1.8"> //</span>
<a href="#l1.9"></a><span id="l1.9"> // Forward declarations...</span>
<a href="#l1.10"></a><span id="l1.10"> //</span>
<a href="#l1.11"></a><span id="l1.11"> extern &quot;C&quot; char     *MIME_StripContinuations(char *original);</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-int                 mime_decompose_file_init_fn ( void *stream_closure, MimeHeaders *headers );</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-int                 mime_decompose_file_output_fn ( const char *buf, int32_t size, void *stream_closure );</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineminus">-int                 mime_decompose_file_close_fn ( void *stream_closure );</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+int                 mime_decompose_file_init_fn(void *stream_closure, MimeHeaders *headers);</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineplus">+int                 mime_decompose_file_output_fn(const char *buf, int32_t size, void *stream_closure);</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineplus">+int                 mime_decompose_file_close_fn(void *stream_closure);</span>
<a href="#l1.18"></a><span id="l1.18"> extern int          MimeHeaders_build_heads_list(MimeHeaders *hdrs);</span>
<a href="#l1.19"></a><span id="l1.19"> </span>
<a href="#l1.20"></a><span id="l1.20"> // CID's</span>
<a href="#l1.21"></a><span id="l1.21"> static NS_DEFINE_CID(kCMsgComposeServiceCID,  NS_MSGCOMPOSESERVICE_CID);</span>
<a href="#l1.22"></a><span id="l1.22"> </span>
<a href="#l1.23"></a><span id="l1.23"> mime_draft_data::mime_draft_data() : url_name(nullptr), format_out(0),</span>
<a href="#l1.24"></a><span id="l1.24">   stream(nullptr), obj(nullptr), options(nullptr), headers(nullptr),</span>
<a href="#l1.25"></a><span id="l1.25">   messageBody(nullptr), curAttachment(nullptr),</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineat">@@ -127,26 +127,26 @@ typedef enum {</span>
<a href="#l1.27"></a><span id="l1.27">   nsMsg_UUENCODE_BINARY_BOOL_HEADER_MASK,</span>
<a href="#l1.28"></a><span id="l1.28">   nsMsg_ATTACH_VCARD_BOOL_HEADER_MASK,</span>
<a href="#l1.29"></a><span id="l1.29">   nsMsg_LAST_BOOL_HEADER_MASK     // last boolean header mask; must be the last one</span>
<a href="#l1.30"></a><span id="l1.30">                                   // DON'T remove.</span>
<a href="#l1.31"></a><span id="l1.31"> } nsMsgBoolHeaderSet;</span>
<a href="#l1.32"></a><span id="l1.32"> </span>
<a href="#l1.33"></a><span id="l1.33"> #ifdef NS_DEBUG</span>
<a href="#l1.34"></a><span id="l1.34"> extern &quot;C&quot; void</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineminus">-mime_dump_attachments ( nsMsgAttachmentData *attachData )</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineplus">+mime_dump_attachments(nsMsgAttachmentData *attachData)</span>
<a href="#l1.37"></a><span id="l1.37"> {</span>
<a href="#l1.38"></a><span id="l1.38">   int32_t     i = 0;</span>
<a href="#l1.39"></a><span id="l1.39">   class nsMsgAttachmentData  *tmp = attachData;</span>
<a href="#l1.40"></a><span id="l1.40"> </span>
<a href="#l1.41"></a><span id="l1.41" class="difflineminus">-  while ( (tmp) &amp;&amp; (tmp-&gt;m_url) )</span>
<a href="#l1.42"></a><span id="l1.42" class="difflineplus">+  while ((tmp) &amp;&amp; (tmp-&gt;m_url))</span>
<a href="#l1.43"></a><span id="l1.43">   {</span>
<a href="#l1.44"></a><span id="l1.44">     printf(&quot;Real Name         : %s\n&quot;, tmp-&gt;m_realName.get());</span>
<a href="#l1.45"></a><span id="l1.45"> </span>
<a href="#l1.46"></a><span id="l1.46" class="difflineminus">-    if ( tmp-&gt;m_url )</span>
<a href="#l1.47"></a><span id="l1.47" class="difflineplus">+    if (tmp-&gt;m_url)</span>
<a href="#l1.48"></a><span id="l1.48">     {</span>
<a href="#l1.49"></a><span id="l1.49">       ;</span>
<a href="#l1.50"></a><span id="l1.50">       printf(&quot;URL               : %s\n&quot;, tmp-&gt;m_url-&gt;GetSpecOrDefault().get());</span>
<a href="#l1.51"></a><span id="l1.51">     }</span>
<a href="#l1.52"></a><span id="l1.52"> </span>
<a href="#l1.53"></a><span id="l1.53">     printf(&quot;Desired Type      : %s\n&quot;, tmp-&gt;m_desiredType.get());</span>
<a href="#l1.54"></a><span id="l1.54">     printf(&quot;Real Type         : %s\n&quot;, tmp-&gt;m_realType.get());</span>
<a href="#l1.55"></a><span id="l1.55">     printf(&quot;Real Encoding     : %s\n&quot;, tmp-&gt;m_realEncoding.get());</span>
<a href="#l1.56"></a><span id="l1.56" class="difflineat">@@ -165,17 +165,17 @@ nsresult CreateComposeParams(nsCOMPtr&lt;ns</span>
<a href="#l1.57"></a><span id="l1.57">                              nsMsgAttachmentData *attachmentList,</span>
<a href="#l1.58"></a><span id="l1.58">                              MSG_ComposeType composeType,</span>
<a href="#l1.59"></a><span id="l1.59">                              MSG_ComposeFormat composeFormat,</span>
<a href="#l1.60"></a><span id="l1.60">                              nsIMsgIdentity * identity,</span>
<a href="#l1.61"></a><span id="l1.61">                              const char *originalMsgURI,</span>
<a href="#l1.62"></a><span id="l1.62">                              nsIMsgDBHdr *origMsgHdr)</span>
<a href="#l1.63"></a><span id="l1.63"> {</span>
<a href="#l1.64"></a><span id="l1.64"> #ifdef NS_DEBUG</span>
<a href="#l1.65"></a><span id="l1.65" class="difflineminus">-  mime_dump_attachments ( attachmentList );</span>
<a href="#l1.66"></a><span id="l1.66" class="difflineplus">+  mime_dump_attachments(attachmentList);</span>
<a href="#l1.67"></a><span id="l1.67"> #endif</span>
<a href="#l1.68"></a><span id="l1.68"> </span>
<a href="#l1.69"></a><span id="l1.69">   nsresult rv;</span>
<a href="#l1.70"></a><span id="l1.70">   nsMsgAttachmentData *curAttachment = attachmentList;</span>
<a href="#l1.71"></a><span id="l1.71">   if (curAttachment)</span>
<a href="#l1.72"></a><span id="l1.72">   {</span>
<a href="#l1.73"></a><span id="l1.73">     nsAutoCString spec;</span>
<a href="#l1.74"></a><span id="l1.74"> </span>
<a href="#l1.75"></a><span id="l1.75" class="difflineat">@@ -249,17 +249,17 @@ nsresult CreateComposeParams(nsCOMPtr&lt;ns</span>
<a href="#l1.76"></a><span id="l1.76"> nsresult</span>
<a href="#l1.77"></a><span id="l1.77"> CreateTheComposeWindow(nsIMsgCompFields *   compFields,</span>
<a href="#l1.78"></a><span id="l1.78">                        nsMsgAttachmentData *attachmentList,</span>
<a href="#l1.79"></a><span id="l1.79">                        MSG_ComposeType      composeType,</span>
<a href="#l1.80"></a><span id="l1.80">                        MSG_ComposeFormat    composeFormat,</span>
<a href="#l1.81"></a><span id="l1.81">                        nsIMsgIdentity *     identity,</span>
<a href="#l1.82"></a><span id="l1.82">                        const char *         originalMsgURI,</span>
<a href="#l1.83"></a><span id="l1.83">                        nsIMsgDBHdr *        origMsgHdr</span>
<a href="#l1.84"></a><span id="l1.84" class="difflineminus">-                       )</span>
<a href="#l1.85"></a><span id="l1.85" class="difflineplus">+                      )</span>
<a href="#l1.86"></a><span id="l1.86"> {</span>
<a href="#l1.87"></a><span id="l1.87">   nsCOMPtr&lt;nsIMsgComposeParams&gt; pMsgComposeParams;</span>
<a href="#l1.88"></a><span id="l1.88">   nsresult rv = CreateComposeParams(pMsgComposeParams, compFields,</span>
<a href="#l1.89"></a><span id="l1.89">                        attachmentList,</span>
<a href="#l1.90"></a><span id="l1.90">                        composeType,</span>
<a href="#l1.91"></a><span id="l1.91">                        composeFormat,</span>
<a href="#l1.92"></a><span id="l1.92">                        identity,</span>
<a href="#l1.93"></a><span id="l1.93">                        originalMsgURI,</span>
<a href="#l1.94"></a><span id="l1.94" class="difflineat">@@ -290,17 +290,17 @@ ForwardMsgInline(nsIMsgCompFields *compF</span>
<a href="#l1.95"></a><span id="l1.95">                                     originalMsgURI,</span>
<a href="#l1.96"></a><span id="l1.96">                                     origMsgHdr);</span>
<a href="#l1.97"></a><span id="l1.97">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.98"></a><span id="l1.98"> </span>
<a href="#l1.99"></a><span id="l1.99">   nsCOMPtr&lt;nsIMsgComposeService&gt; msgComposeService =</span>
<a href="#l1.100"></a><span id="l1.100">            do_GetService(kCMsgComposeServiceCID, &amp;rv);</span>
<a href="#l1.101"></a><span id="l1.101">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.102"></a><span id="l1.102">   // create the nsIMsgCompose object to send the object</span>
<a href="#l1.103"></a><span id="l1.103" class="difflineminus">-  nsCOMPtr&lt;nsIMsgCompose&gt; pMsgCompose (do_CreateInstance(NS_MSGCOMPOSE_CONTRACTID, &amp;rv));</span>
<a href="#l1.104"></a><span id="l1.104" class="difflineplus">+  nsCOMPtr&lt;nsIMsgCompose&gt; pMsgCompose(do_CreateInstance(NS_MSGCOMPOSE_CONTRACTID, &amp;rv));</span>
<a href="#l1.105"></a><span id="l1.105">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.106"></a><span id="l1.106"> </span>
<a href="#l1.107"></a><span id="l1.107">   /** initialize nsIMsgCompose, Send the message, wait for send completion response **/</span>
<a href="#l1.108"></a><span id="l1.108">   rv = pMsgCompose-&gt;Initialize(pMsgComposeParams, nullptr, nullptr);</span>
<a href="#l1.109"></a><span id="l1.109">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.110"></a><span id="l1.110"> </span>
<a href="#l1.111"></a><span id="l1.111">   rv = pMsgCompose-&gt;SendMsg(nsIMsgSend::nsMsgDeliverNow, identity, nullptr, nullptr, nullptr);</span>
<a href="#l1.112"></a><span id="l1.112">   if (NS_SUCCEEDED(rv))</span>
<a href="#l1.113"></a><span id="l1.113" class="difflineat">@@ -419,37 +419,37 @@ CreateCompositionFields(const char      </span>
<a href="#l1.114"></a><span id="l1.114"> </span>
<a href="#l1.115"></a><span id="l1.115">   *_retval = cFields;</span>
<a href="#l1.116"></a><span id="l1.116">   NS_IF_ADDREF(*_retval);</span>
<a href="#l1.117"></a><span id="l1.117"> </span>
<a href="#l1.118"></a><span id="l1.118">   return rv;</span>
<a href="#l1.119"></a><span id="l1.119"> }</span>
<a href="#l1.120"></a><span id="l1.120"> </span>
<a href="#l1.121"></a><span id="l1.121"> static int</span>
<a href="#l1.122"></a><span id="l1.122" class="difflineminus">-dummy_file_write( char *buf, int32_t size, void *fileHandle )</span>
<a href="#l1.123"></a><span id="l1.123" class="difflineplus">+dummy_file_write(char *buf, int32_t size, void *fileHandle)</span>
<a href="#l1.124"></a><span id="l1.124"> {</span>
<a href="#l1.125"></a><span id="l1.125">   if (!fileHandle)</span>
<a href="#l1.126"></a><span id="l1.126">     return -1;</span>
<a href="#l1.127"></a><span id="l1.127"> </span>
<a href="#l1.128"></a><span id="l1.128" class="difflineminus">-  nsIOutputStream  *tStream = (nsIOutputStream *) fileHandle;</span>
<a href="#l1.129"></a><span id="l1.129" class="difflineplus">+  nsIOutputStream  *tStream = (nsIOutputStream *)fileHandle;</span>
<a href="#l1.130"></a><span id="l1.130">   uint32_t bytesWritten;</span>
<a href="#l1.131"></a><span id="l1.131">   tStream-&gt;Write(buf, size, &amp;bytesWritten);</span>
<a href="#l1.132"></a><span id="l1.132" class="difflineminus">-  return (int) bytesWritten;</span>
<a href="#l1.133"></a><span id="l1.133" class="difflineplus">+  return (int)bytesWritten;</span>
<a href="#l1.134"></a><span id="l1.134"> }</span>
<a href="#l1.135"></a><span id="l1.135"> </span>
<a href="#l1.136"></a><span id="l1.136"> static int</span>
<a href="#l1.137"></a><span id="l1.137" class="difflineminus">-mime_parse_stream_write ( nsMIMESession *stream, const char *buf, int32_t size )</span>
<a href="#l1.138"></a><span id="l1.138" class="difflineplus">+mime_parse_stream_write(nsMIMESession *stream, const char *buf, int32_t size)</span>
<a href="#l1.139"></a><span id="l1.139"> {</span>
<a href="#l1.140"></a><span id="l1.140" class="difflineminus">-  mime_draft_data *mdd = (mime_draft_data *) stream-&gt;data_object;</span>
<a href="#l1.141"></a><span id="l1.141" class="difflineminus">-  NS_ASSERTION ( mdd, &quot;null mime draft data!&quot; );</span>
<a href="#l1.142"></a><span id="l1.142" class="difflineplus">+  mime_draft_data *mdd = (mime_draft_data *)stream-&gt;data_object;</span>
<a href="#l1.143"></a><span id="l1.143" class="difflineplus">+  NS_ASSERTION(mdd, &quot;null mime draft data!&quot;);</span>
<a href="#l1.144"></a><span id="l1.144"> </span>
<a href="#l1.145"></a><span id="l1.145" class="difflineminus">-  if ( !mdd || !mdd-&gt;obj )</span>
<a href="#l1.146"></a><span id="l1.146" class="difflineplus">+  if (!mdd || !mdd-&gt;obj)</span>
<a href="#l1.147"></a><span id="l1.147">     return -1;</span>
<a href="#l1.148"></a><span id="l1.148"> </span>
<a href="#l1.149"></a><span id="l1.149" class="difflineminus">-  return mdd-&gt;obj-&gt;clazz-&gt;parse_buffer ((char *) buf, size, mdd-&gt;obj);</span>
<a href="#l1.150"></a><span id="l1.150" class="difflineplus">+  return mdd-&gt;obj-&gt;clazz-&gt;parse_buffer((char *)buf, size, mdd-&gt;obj);</span>
<a href="#l1.151"></a><span id="l1.151"> }</span>
<a href="#l1.152"></a><span id="l1.152"> </span>
<a href="#l1.153"></a><span id="l1.153"> static void</span>
<a href="#l1.154"></a><span id="l1.154"> mime_free_attachments(nsTArray&lt;nsMsgAttachedFile *&gt; &amp;attachments)</span>
<a href="#l1.155"></a><span id="l1.155"> {</span>
<a href="#l1.156"></a><span id="l1.156">   if (attachments.Length() &lt;= 0)</span>
<a href="#l1.157"></a><span id="l1.157">     return;</span>
<a href="#l1.158"></a><span id="l1.158"> </span>
<a href="#l1.159"></a><span id="l1.159" class="difflineat">@@ -484,32 +484,32 @@ mime_draft_process_attachments(mime_draf</span>
<a href="#l1.160"></a><span id="l1.160"> </span>
<a href="#l1.161"></a><span id="l1.161">   if (!mdd-&gt;attachments.Length() &amp;&amp; !bodyAsAttachment)</span>
<a href="#l1.162"></a><span id="l1.162">     return nullptr;</span>
<a href="#l1.163"></a><span id="l1.163"> </span>
<a href="#l1.164"></a><span id="l1.164">   int32_t totalCount = mdd-&gt;attachments.Length();</span>
<a href="#l1.165"></a><span id="l1.165">   if (bodyAsAttachment)</span>
<a href="#l1.166"></a><span id="l1.166">     totalCount++;</span>
<a href="#l1.167"></a><span id="l1.167">   attachData = new nsMsgAttachmentData[totalCount + 1];</span>
<a href="#l1.168"></a><span id="l1.168" class="difflineminus">-  if ( !attachData )</span>
<a href="#l1.169"></a><span id="l1.169" class="difflineplus">+  if (!attachData)</span>
<a href="#l1.170"></a><span id="l1.170">     return nullptr;</span>
<a href="#l1.171"></a><span id="l1.171"> </span>
<a href="#l1.172"></a><span id="l1.172">   tmp = attachData;</span>
<a href="#l1.173"></a><span id="l1.173"> </span>
<a href="#l1.174"></a><span id="l1.174">   for (int i = 0, attachmentsIndex = 0; i &lt; totalCount; i++, tmp++)</span>
<a href="#l1.175"></a><span id="l1.175">   {</span>
<a href="#l1.176"></a><span id="l1.176">     if (bodyAsAttachment &amp;&amp; i == 0)</span>
<a href="#l1.177"></a><span id="l1.177">       tmpFile = mdd-&gt;messageBody;</span>
<a href="#l1.178"></a><span id="l1.178">     else</span>
<a href="#l1.179"></a><span id="l1.179">       tmpFile = mdd-&gt;attachments[attachmentsIndex++];</span>
<a href="#l1.180"></a><span id="l1.180"> </span>
<a href="#l1.181"></a><span id="l1.181">     if (tmpFile-&gt;m_type.LowerCaseEqualsLiteral(&quot;text/x-vcard&quot;))</span>
<a href="#l1.182"></a><span id="l1.182">       tmp-&gt;m_realName = tmpFile-&gt;m_description;</span>
<a href="#l1.183"></a><span id="l1.183"> </span>
<a href="#l1.184"></a><span id="l1.184" class="difflineminus">-    if ( tmpFile-&gt;m_origUrl )</span>
<a href="#l1.185"></a><span id="l1.185" class="difflineplus">+    if (tmpFile-&gt;m_origUrl)</span>
<a href="#l1.186"></a><span id="l1.186">     {</span>
<a href="#l1.187"></a><span id="l1.187">       nsAutoCString tmpSpec;</span>
<a href="#l1.188"></a><span id="l1.188">       if (NS_FAILED(tmpFile-&gt;m_origUrl-&gt;GetSpec(tmpSpec)))</span>
<a href="#l1.189"></a><span id="l1.189">         goto FAIL;</span>
<a href="#l1.190"></a><span id="l1.190"> </span>
<a href="#l1.191"></a><span id="l1.191">       if (NS_FAILED(nsMimeNewURI(getter_AddRefs(tmp-&gt;m_url), tmpSpec.get(), nullptr)))</span>
<a href="#l1.192"></a><span id="l1.192">         goto FAIL;</span>
<a href="#l1.193"></a><span id="l1.193"> </span>
<a href="#l1.194"></a><span id="l1.194" class="difflineat">@@ -765,17 +765,17 @@ mime_insert_all_headers(char            </span>
<a href="#l1.195"></a><span id="l1.195">     PR_FREEIF(*body);</span>
<a href="#l1.196"></a><span id="l1.196">     *body = newBody;</span>
<a href="#l1.197"></a><span id="l1.197">   }</span>
<a href="#l1.198"></a><span id="l1.198"> }</span>
<a href="#l1.199"></a><span id="l1.199"> </span>
<a href="#l1.200"></a><span id="l1.200"> static void</span>
<a href="#l1.201"></a><span id="l1.201"> mime_insert_normal_headers(char             **body,</span>
<a href="#l1.202"></a><span id="l1.202">                            MimeHeaders      *headers,</span>
<a href="#l1.203"></a><span id="l1.203" class="difflineminus">-                           MSG_ComposeFormat  composeFormat,</span>
<a href="#l1.204"></a><span id="l1.204" class="difflineplus">+                           MSG_ComposeFormat composeFormat,</span>
<a href="#l1.205"></a><span id="l1.205">                            char             *mailcharset)</span>
<a href="#l1.206"></a><span id="l1.206"> {</span>
<a href="#l1.207"></a><span id="l1.207">   char *newBody = nullptr;</span>
<a href="#l1.208"></a><span id="l1.208">   char *subject = MimeHeaders_get(headers, HEADER_SUBJECT, false, false);</span>
<a href="#l1.209"></a><span id="l1.209">   char *resent_comments = MimeHeaders_get(headers, HEADER_RESENT_COMMENTS, false, false);</span>
<a href="#l1.210"></a><span id="l1.210">   char *resent_date = MimeHeaders_get(headers, HEADER_RESENT_DATE, false, true);</span>
<a href="#l1.211"></a><span id="l1.211">   nsCString resent_from(MimeHeaders_get(headers, HEADER_RESENT_FROM, false, true));</span>
<a href="#l1.212"></a><span id="l1.212">   nsCString resent_to(MimeHeaders_get(headers, HEADER_RESENT_TO, false, true));</span>
<a href="#l1.213"></a><span id="l1.213" class="difflineat">@@ -1227,19 +1227,19 @@ convert_plaintext_body_to_html(char **bo</span>
<a href="#l1.214"></a><span id="l1.214">     haveSig = false;</span>
<a href="#l1.215"></a><span id="l1.215">   }</span>
<a href="#l1.216"></a><span id="l1.216"> </span>
<a href="#l1.217"></a><span id="l1.217">   PR_Free(*body);</span>
<a href="#l1.218"></a><span id="l1.218">   *body = ToNewCString(newBody);</span>
<a href="#l1.219"></a><span id="l1.219"> }</span>
<a href="#l1.220"></a><span id="l1.220"> </span>
<a href="#l1.221"></a><span id="l1.221"> static void</span>
<a href="#l1.222"></a><span id="l1.222" class="difflineminus">-mime_parse_stream_complete (nsMIMESession *stream)</span>
<a href="#l1.223"></a><span id="l1.223" class="difflineplus">+mime_parse_stream_complete(nsMIMESession *stream)</span>
<a href="#l1.224"></a><span id="l1.224"> {</span>
<a href="#l1.225"></a><span id="l1.225" class="difflineminus">-  mime_draft_data *mdd = (mime_draft_data *) stream-&gt;data_object;</span>
<a href="#l1.226"></a><span id="l1.226" class="difflineplus">+  mime_draft_data *mdd = (mime_draft_data *)stream-&gt;data_object;</span>
<a href="#l1.227"></a><span id="l1.227">   nsCOMPtr&lt;nsIMsgCompFields&gt; fields;</span>
<a href="#l1.228"></a><span id="l1.228">   int htmlAction = 0;</span>
<a href="#l1.229"></a><span id="l1.229">   int lineWidth = 0;</span>
<a href="#l1.230"></a><span id="l1.230"> </span>
<a href="#l1.231"></a><span id="l1.231">   char *host = 0;</span>
<a href="#l1.232"></a><span id="l1.232">   char *news_host = 0;</span>
<a href="#l1.233"></a><span id="l1.233">   char *to_and_cc = 0;</span>
<a href="#l1.234"></a><span id="l1.234">   char *re_subject = 0;</span>
<a href="#l1.235"></a><span id="l1.235" class="difflineat">@@ -1260,36 +1260,36 @@ mime_parse_stream_complete (nsMIMESessio</span>
<a href="#l1.236"></a><span id="l1.236">   char *draftInfo = 0;</span>
<a href="#l1.237"></a><span id="l1.237">   char *contentLanguage = 0;</span>
<a href="#l1.238"></a><span id="l1.238">   char *identityKey = 0;</span>
<a href="#l1.239"></a><span id="l1.239"> </span>
<a href="#l1.240"></a><span id="l1.240">   bool forward_inline = false;</span>
<a href="#l1.241"></a><span id="l1.241">   bool bodyAsAttachment = false;</span>
<a href="#l1.242"></a><span id="l1.242">   bool charsetOverride = false;</span>
<a href="#l1.243"></a><span id="l1.243"> </span>
<a href="#l1.244"></a><span id="l1.244" class="difflineminus">-  NS_ASSERTION (mdd, &quot;null mime draft data&quot;);</span>
<a href="#l1.245"></a><span id="l1.245" class="difflineplus">+  NS_ASSERTION(mdd, &quot;null mime draft data&quot;);</span>
<a href="#l1.246"></a><span id="l1.246"> </span>
<a href="#l1.247"></a><span id="l1.247">   if (!mdd) return;</span>
<a href="#l1.248"></a><span id="l1.248"> </span>
<a href="#l1.249"></a><span id="l1.249">   if (mdd-&gt;obj)</span>
<a href="#l1.250"></a><span id="l1.250">   {</span>
<a href="#l1.251"></a><span id="l1.251">     int status;</span>
<a href="#l1.252"></a><span id="l1.252"> </span>
<a href="#l1.253"></a><span id="l1.253" class="difflineminus">-    status = mdd-&gt;obj-&gt;clazz-&gt;parse_eof ( mdd-&gt;obj, false );</span>
<a href="#l1.254"></a><span id="l1.254" class="difflineminus">-    mdd-&gt;obj-&gt;clazz-&gt;parse_end( mdd-&gt;obj, status &lt; 0 ? true : false );</span>
<a href="#l1.255"></a><span id="l1.255" class="difflineplus">+    status = mdd-&gt;obj-&gt;clazz-&gt;parse_eof(mdd-&gt;obj, false);</span>
<a href="#l1.256"></a><span id="l1.256" class="difflineplus">+    mdd-&gt;obj-&gt;clazz-&gt;parse_end(mdd-&gt;obj, status &lt; 0 ? true : false);</span>
<a href="#l1.257"></a><span id="l1.257"> </span>
<a href="#l1.258"></a><span id="l1.258">     // RICHIE</span>
<a href="#l1.259"></a><span id="l1.259">     // We need to figure out how to pass the forwarded flag along with this</span>
<a href="#l1.260"></a><span id="l1.260">     // operation.</span>
<a href="#l1.261"></a><span id="l1.261"> </span>
<a href="#l1.262"></a><span id="l1.262">     //forward_inline = (mdd-&gt;format_out != FO_CMDLINE_ATTACHMENTS);</span>
<a href="#l1.263"></a><span id="l1.263">     forward_inline = mdd-&gt;forwardInline;</span>
<a href="#l1.264"></a><span id="l1.264"> </span>
<a href="#l1.265"></a><span id="l1.265" class="difflineminus">-    NS_ASSERTION ( mdd-&gt;options == mdd-&gt;obj-&gt;options, &quot;mime draft options not same as obj-&gt;options&quot; );</span>
<a href="#l1.266"></a><span id="l1.266" class="difflineminus">-    mime_free (mdd-&gt;obj);</span>
<a href="#l1.267"></a><span id="l1.267" class="difflineplus">+    NS_ASSERTION(mdd-&gt;options == mdd-&gt;obj-&gt;options, &quot;mime draft options not same as obj-&gt;options&quot;);</span>
<a href="#l1.268"></a><span id="l1.268" class="difflineplus">+    mime_free(mdd-&gt;obj);</span>
<a href="#l1.269"></a><span id="l1.269">     mdd-&gt;obj = 0;</span>
<a href="#l1.270"></a><span id="l1.270">     if (mdd-&gt;options)</span>
<a href="#l1.271"></a><span id="l1.271">     {</span>
<a href="#l1.272"></a><span id="l1.272">       // save the override flag before it's unavailable</span>
<a href="#l1.273"></a><span id="l1.273">       charsetOverride = mdd-&gt;options-&gt;override_charset;</span>
<a href="#l1.274"></a><span id="l1.274">       if ((!mdd-&gt;mailcharset || charsetOverride) &amp;&amp; mdd-&gt;options-&gt;default_charset)</span>
<a href="#l1.275"></a><span id="l1.275">       {</span>
<a href="#l1.276"></a><span id="l1.276">         PR_Free(mdd-&gt;mailcharset);</span>
<a href="#l1.277"></a><span id="l1.277" class="difflineat">@@ -1297,32 +1297,32 @@ mime_parse_stream_complete (nsMIMESessio</span>
<a href="#l1.278"></a><span id="l1.278">       }</span>
<a href="#l1.279"></a><span id="l1.279"> </span>
<a href="#l1.280"></a><span id="l1.280">       // mscott: aren't we leaking a bunch of strings here like the charset strings and such?</span>
<a href="#l1.281"></a><span id="l1.281">       delete mdd-&gt;options;</span>
<a href="#l1.282"></a><span id="l1.282">       mdd-&gt;options = 0;</span>
<a href="#l1.283"></a><span id="l1.283">     }</span>
<a href="#l1.284"></a><span id="l1.284">     if (mdd-&gt;stream)</span>
<a href="#l1.285"></a><span id="l1.285">     {</span>
<a href="#l1.286"></a><span id="l1.286" class="difflineminus">-      mdd-&gt;stream-&gt;complete ((nsMIMESession *)mdd-&gt;stream-&gt;data_object);</span>
<a href="#l1.287"></a><span id="l1.287" class="difflineminus">-      PR_Free( mdd-&gt;stream );</span>
<a href="#l1.288"></a><span id="l1.288" class="difflineplus">+      mdd-&gt;stream-&gt;complete((nsMIMESession *)mdd-&gt;stream-&gt;data_object);</span>
<a href="#l1.289"></a><span id="l1.289" class="difflineplus">+      PR_Free(mdd-&gt;stream);</span>
<a href="#l1.290"></a><span id="l1.290">       mdd-&gt;stream = 0;</span>
<a href="#l1.291"></a><span id="l1.291">     }</span>
<a href="#l1.292"></a><span id="l1.292">   }</span>
<a href="#l1.293"></a><span id="l1.293"> </span>
<a href="#l1.294"></a><span id="l1.294">   //</span>
<a href="#l1.295"></a><span id="l1.295">   // Now, process the attachments that we have gathered from the message</span>
<a href="#l1.296"></a><span id="l1.296">   // on disk</span>
<a href="#l1.297"></a><span id="l1.297">   //</span>
<a href="#l1.298"></a><span id="l1.298">   nsMsgAttachmentData *newAttachData = mime_draft_process_attachments(mdd);</span>
<a href="#l1.299"></a><span id="l1.299"> </span>
<a href="#l1.300"></a><span id="l1.300">   //</span>
<a href="#l1.301"></a><span id="l1.301">   // time to bring up the compose windows with all the info gathered</span>
<a href="#l1.302"></a><span id="l1.302">   //</span>
<a href="#l1.303"></a><span id="l1.303" class="difflineminus">-  if ( mdd-&gt;headers )</span>
<a href="#l1.304"></a><span id="l1.304" class="difflineplus">+  if (mdd-&gt;headers)</span>
<a href="#l1.305"></a><span id="l1.305">   {</span>
<a href="#l1.306"></a><span id="l1.306">     subj = MimeHeaders_get(mdd-&gt;headers, HEADER_SUBJECT,  false, false);</span>
<a href="#l1.307"></a><span id="l1.307">     if (forward_inline)</span>
<a href="#l1.308"></a><span id="l1.308">     {</span>
<a href="#l1.309"></a><span id="l1.309">       if (subj)</span>
<a href="#l1.310"></a><span id="l1.310">       {</span>
<a href="#l1.311"></a><span id="l1.311">         nsresult rv;</span>
<a href="#l1.312"></a><span id="l1.312">         nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l1.313"></a><span id="l1.313" class="difflineat">@@ -1375,17 +1375,17 @@ mime_parse_stream_complete (nsMIMESessio</span>
<a href="#l1.314"></a><span id="l1.314">         else</span>
<a href="#l1.315"></a><span id="l1.315">         {</span>
<a href="#l1.316"></a><span id="l1.316">           news_host = PR_smprintf (&quot;news://%s&quot;, host);</span>
<a href="#l1.317"></a><span id="l1.317">         }</span>
<a href="#l1.318"></a><span id="l1.318">       }</span>
<a href="#l1.319"></a><span id="l1.319">     }</span>
<a href="#l1.320"></a><span id="l1.320"> </span>
<a href="#l1.321"></a><span id="l1.321"> </span>
<a href="#l1.322"></a><span id="l1.322" class="difflineminus">-    CreateCompositionFields( from, repl, to, cc, bcc, fcc, grps, foll,</span>
<a href="#l1.323"></a><span id="l1.323" class="difflineplus">+    CreateCompositionFields(from, repl, to, cc, bcc, fcc, grps, foll,</span>
<a href="#l1.324"></a><span id="l1.324">       org, subj, refs, priority, news_host,</span>
<a href="#l1.325"></a><span id="l1.325">       mdd-&gt;mailcharset,</span>
<a href="#l1.326"></a><span id="l1.326">       getter_AddRefs(fields));</span>
<a href="#l1.327"></a><span id="l1.327"> </span>
<a href="#l1.328"></a><span id="l1.328">     contentLanguage = MimeHeaders_get(mdd-&gt;headers, HEADER_CONTENT_LANGUAGE, false, false);</span>
<a href="#l1.329"></a><span id="l1.329">     if (contentLanguage) {</span>
<a href="#l1.330"></a><span id="l1.330">       fields-&gt;SetContentLanguage(contentLanguage);</span>
<a href="#l1.331"></a><span id="l1.331">     }</span>
<a href="#l1.332"></a><span id="l1.332" class="difflineat">@@ -1444,25 +1444,25 @@ mime_parse_stream_complete (nsMIMESessio</span>
<a href="#l1.333"></a><span id="l1.333">         sscanf(parm, &quot;%d&quot;, &amp;deliveryFormat);</span>
<a href="#l1.334"></a><span id="l1.334">         fields-&gt;SetDeliveryFormat(deliveryFormat);</span>
<a href="#l1.335"></a><span id="l1.335">       }</span>
<a href="#l1.336"></a><span id="l1.336">       PR_FREEIF(parm);</span>
<a href="#l1.337"></a><span id="l1.337">     }</span>
<a href="#l1.338"></a><span id="l1.338"> </span>
<a href="#l1.339"></a><span id="l1.339">   // identity to prefer when opening the message in the compose window?</span>
<a href="#l1.340"></a><span id="l1.340">     identityKey = MimeHeaders_get(mdd-&gt;headers, HEADER_X_MOZILLA_IDENTITY_KEY, false, false);</span>
<a href="#l1.341"></a><span id="l1.341" class="difflineminus">-    if ( identityKey &amp;&amp; *identityKey )</span>
<a href="#l1.342"></a><span id="l1.342" class="difflineplus">+    if (identityKey &amp;&amp; *identityKey)</span>
<a href="#l1.343"></a><span id="l1.343">     {</span>
<a href="#l1.344"></a><span id="l1.344">         nsresult rv = NS_OK;</span>
<a href="#l1.345"></a><span id="l1.345" class="difflineminus">-        nsCOMPtr&lt; nsIMsgAccountManager &gt; accountManager =</span>
<a href="#l1.346"></a><span id="l1.346" class="difflineminus">-                do_GetService( NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv );</span>
<a href="#l1.347"></a><span id="l1.347" class="difflineminus">-        if ( NS_SUCCEEDED(rv) &amp;&amp; accountManager )</span>
<a href="#l1.348"></a><span id="l1.348" class="difflineplus">+        nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l1.349"></a><span id="l1.349" class="difflineplus">+                do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l1.350"></a><span id="l1.350" class="difflineplus">+        if (NS_SUCCEEDED(rv) &amp;&amp; accountManager)</span>
<a href="#l1.351"></a><span id="l1.351">         {</span>
<a href="#l1.352"></a><span id="l1.352" class="difflineminus">-            nsCOMPtr&lt; nsIMsgIdentity &gt; overrulingIdentity;</span>
<a href="#l1.353"></a><span id="l1.353" class="difflineminus">-            rv = accountManager-&gt;GetIdentity( nsDependentCString(identityKey), getter_AddRefs( overrulingIdentity ) );</span>
<a href="#l1.354"></a><span id="l1.354" class="difflineplus">+            nsCOMPtr&lt;nsIMsgIdentity&gt; overrulingIdentity;</span>
<a href="#l1.355"></a><span id="l1.355" class="difflineplus">+            rv = accountManager-&gt;GetIdentity(nsDependentCString(identityKey), getter_AddRefs(overrulingIdentity));</span>
<a href="#l1.356"></a><span id="l1.356"> </span>
<a href="#l1.357"></a><span id="l1.357">             if (NS_SUCCEEDED(rv) &amp;&amp; overrulingIdentity) {</span>
<a href="#l1.358"></a><span id="l1.358">                 mdd-&gt;identity = overrulingIdentity;</span>
<a href="#l1.359"></a><span id="l1.359">                 fields-&gt;SetCreatorIdentityKey(identityKey);</span>
<a href="#l1.360"></a><span id="l1.360">             }</span>
<a href="#l1.361"></a><span id="l1.361">         }</span>
<a href="#l1.362"></a><span id="l1.362">     }</span>
<a href="#l1.363"></a><span id="l1.363"> </span>
<a href="#l1.364"></a><span id="l1.364" class="difflineat">@@ -1490,37 +1490,37 @@ mime_parse_stream_complete (nsMIMESessio</span>
<a href="#l1.365"></a><span id="l1.365">       {</span>
<a href="#l1.366"></a><span id="l1.366">         int64_t fileSize;</span>
<a href="#l1.367"></a><span id="l1.367">         nsCOMPtr&lt;nsIFile&gt; tempFileCopy;</span>
<a href="#l1.368"></a><span id="l1.368">         mdd-&gt;messageBody-&gt;m_tmpFile-&gt;Clone(getter_AddRefs(tempFileCopy));</span>
<a href="#l1.369"></a><span id="l1.369">         mdd-&gt;messageBody-&gt;m_tmpFile = do_QueryInterface(tempFileCopy);</span>
<a href="#l1.370"></a><span id="l1.370">         tempFileCopy = nullptr;</span>
<a href="#l1.371"></a><span id="l1.371">         mdd-&gt;messageBody-&gt;m_tmpFile-&gt;GetFileSize(&amp;fileSize);</span>
<a href="#l1.372"></a><span id="l1.372">         bodyLen = fileSize;</span>
<a href="#l1.373"></a><span id="l1.373" class="difflineminus">-        body = (char *)PR_MALLOC (bodyLen + 1);</span>
<a href="#l1.374"></a><span id="l1.374" class="difflineplus">+        body = (char *)PR_MALLOC(bodyLen + 1);</span>
<a href="#l1.375"></a><span id="l1.375">         if (body)</span>
<a href="#l1.376"></a><span id="l1.376">         {</span>
<a href="#l1.377"></a><span id="l1.377" class="difflineminus">-          memset (body, 0, bodyLen+1);</span>
<a href="#l1.378"></a><span id="l1.378" class="difflineplus">+          memset(body, 0, bodyLen+1);</span>
<a href="#l1.379"></a><span id="l1.379"> </span>
<a href="#l1.380"></a><span id="l1.380">           uint32_t bytesRead;</span>
<a href="#l1.381"></a><span id="l1.381" class="difflineminus">-          nsCOMPtr &lt;nsIInputStream&gt; inputStream;</span>
<a href="#l1.382"></a><span id="l1.382" class="difflineplus">+          nsCOMPtr&lt;nsIInputStream&gt; inputStream;</span>
<a href="#l1.383"></a><span id="l1.383"> </span>
<a href="#l1.384"></a><span id="l1.384">           nsresult rv = NS_NewLocalFileInputStream(getter_AddRefs(inputStream), mdd-&gt;messageBody-&gt;m_tmpFile);</span>
<a href="#l1.385"></a><span id="l1.385">           if (NS_FAILED(rv))</span>
<a href="#l1.386"></a><span id="l1.386">             return;</span>
<a href="#l1.387"></a><span id="l1.387"> </span>
<a href="#l1.388"></a><span id="l1.388">           inputStream-&gt;Read(body, bodyLen, &amp;bytesRead);</span>
<a href="#l1.389"></a><span id="l1.389"> </span>
<a href="#l1.390"></a><span id="l1.390">           inputStream-&gt;Close();</span>
<a href="#l1.391"></a><span id="l1.391"> </span>
<a href="#l1.392"></a><span id="l1.392">           // Convert the body to UTF-8</span>
<a href="#l1.393"></a><span id="l1.393">           char *mimeCharset = nullptr;</span>
<a href="#l1.394"></a><span id="l1.394">           // Get a charset from the header if no override is set.</span>
<a href="#l1.395"></a><span id="l1.395">           if (!charsetOverride)</span>
<a href="#l1.396"></a><span id="l1.396" class="difflineminus">-            mimeCharset = MimeHeaders_get_parameter (mdd-&gt;messageBody-&gt;m_type.get(), &quot;charset&quot;, nullptr, nullptr);</span>
<a href="#l1.397"></a><span id="l1.397" class="difflineplus">+            mimeCharset = MimeHeaders_get_parameter(mdd-&gt;messageBody-&gt;m_type.get(), &quot;charset&quot;, nullptr, nullptr);</span>
<a href="#l1.398"></a><span id="l1.398">           // If no charset is specified in the header then use the default.</span>
<a href="#l1.399"></a><span id="l1.399">           char *bodyCharset = mimeCharset ? mimeCharset : mdd-&gt;mailcharset;</span>
<a href="#l1.400"></a><span id="l1.400">           if (bodyCharset)</span>
<a href="#l1.401"></a><span id="l1.401">           {</span>
<a href="#l1.402"></a><span id="l1.402">             nsAutoString tmpUnicodeBody;</span>
<a href="#l1.403"></a><span id="l1.403">             rv = ConvertToUnicode(bodyCharset, body, tmpUnicodeBody);</span>
<a href="#l1.404"></a><span id="l1.404">             if (NS_FAILED(rv)) // Tough luck, ASCII/ISO-8859-1 then...</span>
<a href="#l1.405"></a><span id="l1.405">               CopyASCIItoUTF16(nsDependentCString(body), tmpUnicodeBody);</span>
<a href="#l1.406"></a><span id="l1.406" class="difflineat">@@ -1721,26 +1721,26 @@ mime_parse_stream_complete (nsMIMESessio</span>
<a href="#l1.407"></a><span id="l1.407">           fields-&gt;SetDraftId(mdd-&gt;url_name);</span>
<a href="#l1.408"></a><span id="l1.408">           CreateTheComposeWindow(fields, newAttachData, nsIMsgCompType::Draft, nsIMsgCompFormat::Default, mdd-&gt;identity, nullptr, mdd-&gt;origMsgHdr);</span>
<a href="#l1.409"></a><span id="l1.409">         }</span>
<a href="#l1.410"></a><span id="l1.410">       }</span>
<a href="#l1.411"></a><span id="l1.411">     }</span>
<a href="#l1.412"></a><span id="l1.412">   }</span>
<a href="#l1.413"></a><span id="l1.413">   else</span>
<a href="#l1.414"></a><span id="l1.414">   {</span>
<a href="#l1.415"></a><span id="l1.415" class="difflineminus">-    CreateCompositionFields( from, repl, to, cc, bcc, fcc, grps, foll,</span>
<a href="#l1.416"></a><span id="l1.416" class="difflineplus">+    CreateCompositionFields(from, repl, to, cc, bcc, fcc, grps, foll,</span>
<a href="#l1.417"></a><span id="l1.417">       org, subj, refs, priority, news_host,</span>
<a href="#l1.418"></a><span id="l1.418">       mdd-&gt;mailcharset,</span>
<a href="#l1.419"></a><span id="l1.419">       getter_AddRefs(fields));</span>
<a href="#l1.420"></a><span id="l1.420">     if (fields)</span>
<a href="#l1.421"></a><span id="l1.421">       CreateTheComposeWindow(fields, newAttachData, nsIMsgCompType::New, nsIMsgCompFormat::Default, mdd-&gt;identity, nullptr, mdd-&gt;origMsgHdr);</span>
<a href="#l1.422"></a><span id="l1.422">   }</span>
<a href="#l1.423"></a><span id="l1.423"> </span>
<a href="#l1.424"></a><span id="l1.424" class="difflineminus">-  if ( mdd-&gt;headers )</span>
<a href="#l1.425"></a><span id="l1.425" class="difflineminus">-    MimeHeaders_free ( mdd-&gt;headers );</span>
<a href="#l1.426"></a><span id="l1.426" class="difflineplus">+  if (mdd-&gt;headers)</span>
<a href="#l1.427"></a><span id="l1.427" class="difflineplus">+    MimeHeaders_free(mdd-&gt;headers);</span>
<a href="#l1.428"></a><span id="l1.428"> </span>
<a href="#l1.429"></a><span id="l1.429">   //</span>
<a href="#l1.430"></a><span id="l1.430">   // Free the original attachment structure...</span>
<a href="#l1.431"></a><span id="l1.431">   // Make sure we only cleanup the local copy of the memory and not kill</span>
<a href="#l1.432"></a><span id="l1.432">   // files we need on disk</span>
<a href="#l1.433"></a><span id="l1.433">   //</span>
<a href="#l1.434"></a><span id="l1.434">   if (bodyAsAttachment)</span>
<a href="#l1.435"></a><span id="l1.435">     mdd-&gt;messageBody-&gt;m_tmpFile = nullptr;</span>
<a href="#l1.436"></a><span id="l1.436" class="difflineat">@@ -1776,90 +1776,90 @@ mime_parse_stream_complete (nsMIMESessio</span>
<a href="#l1.437"></a><span id="l1.437">   PR_FREEIF(priority);</span>
<a href="#l1.438"></a><span id="l1.438">   PR_FREEIF(draftInfo);</span>
<a href="#l1.439"></a><span id="l1.439">   PR_Free(identityKey);</span>
<a href="#l1.440"></a><span id="l1.440"> </span>
<a href="#l1.441"></a><span id="l1.441">   delete [] newAttachData;</span>
<a href="#l1.442"></a><span id="l1.442"> }</span>
<a href="#l1.443"></a><span id="l1.443"> </span>
<a href="#l1.444"></a><span id="l1.444"> static void</span>
<a href="#l1.445"></a><span id="l1.445" class="difflineminus">-mime_parse_stream_abort (nsMIMESession *stream, int status )</span>
<a href="#l1.446"></a><span id="l1.446" class="difflineplus">+mime_parse_stream_abort(nsMIMESession *stream, int status)</span>
<a href="#l1.447"></a><span id="l1.447"> {</span>
<a href="#l1.448"></a><span id="l1.448" class="difflineminus">-  mime_draft_data *mdd = (mime_draft_data *) stream-&gt;data_object;</span>
<a href="#l1.449"></a><span id="l1.449" class="difflineminus">-  NS_ASSERTION (mdd, &quot;null mime draft data&quot;);</span>
<a href="#l1.450"></a><span id="l1.450" class="difflineplus">+  mime_draft_data *mdd = (mime_draft_data *)stream-&gt;data_object;</span>
<a href="#l1.451"></a><span id="l1.451" class="difflineplus">+  NS_ASSERTION(mdd, &quot;null mime draft data&quot;);</span>
<a href="#l1.452"></a><span id="l1.452"> </span>
<a href="#l1.453"></a><span id="l1.453">   if (!mdd)</span>
<a href="#l1.454"></a><span id="l1.454">     return;</span>
<a href="#l1.455"></a><span id="l1.455"> </span>
<a href="#l1.456"></a><span id="l1.456">   if (mdd-&gt;obj)</span>
<a href="#l1.457"></a><span id="l1.457">   {</span>
<a href="#l1.458"></a><span id="l1.458">     int status=0;</span>
<a href="#l1.459"></a><span id="l1.459"> </span>
<a href="#l1.460"></a><span id="l1.460" class="difflineminus">-    if ( !mdd-&gt;obj-&gt;closed_p )</span>
<a href="#l1.461"></a><span id="l1.461" class="difflineminus">-      status = mdd-&gt;obj-&gt;clazz-&gt;parse_eof ( mdd-&gt;obj, true );</span>
<a href="#l1.462"></a><span id="l1.462" class="difflineminus">-    if ( !mdd-&gt;obj-&gt;parsed_p )</span>
<a href="#l1.463"></a><span id="l1.463" class="difflineminus">-      mdd-&gt;obj-&gt;clazz-&gt;parse_end( mdd-&gt;obj, true );</span>
<a href="#l1.464"></a><span id="l1.464" class="difflineplus">+    if (!mdd-&gt;obj-&gt;closed_p)</span>
<a href="#l1.465"></a><span id="l1.465" class="difflineplus">+      status = mdd-&gt;obj-&gt;clazz-&gt;parse_eof(mdd-&gt;obj, true);</span>
<a href="#l1.466"></a><span id="l1.466" class="difflineplus">+    if (!mdd-&gt;obj-&gt;parsed_p)</span>
<a href="#l1.467"></a><span id="l1.467" class="difflineplus">+      mdd-&gt;obj-&gt;clazz-&gt;parse_end(mdd-&gt;obj, true);</span>
<a href="#l1.468"></a><span id="l1.468"> </span>
<a href="#l1.469"></a><span id="l1.469" class="difflineminus">-    NS_ASSERTION ( mdd-&gt;options == mdd-&gt;obj-&gt;options, &quot;draft display options not same as mime obj&quot; );</span>
<a href="#l1.470"></a><span id="l1.470" class="difflineplus">+    NS_ASSERTION(mdd-&gt;options == mdd-&gt;obj-&gt;options, &quot;draft display options not same as mime obj&quot;);</span>
<a href="#l1.471"></a><span id="l1.471">     mime_free (mdd-&gt;obj);</span>
<a href="#l1.472"></a><span id="l1.472">     mdd-&gt;obj = 0;</span>
<a href="#l1.473"></a><span id="l1.473">     if (mdd-&gt;options)</span>
<a href="#l1.474"></a><span id="l1.474">     {</span>
<a href="#l1.475"></a><span id="l1.475">       delete mdd-&gt;options;</span>
<a href="#l1.476"></a><span id="l1.476">       mdd-&gt;options = 0;</span>
<a href="#l1.477"></a><span id="l1.477">     }</span>
<a href="#l1.478"></a><span id="l1.478"> </span>
<a href="#l1.479"></a><span id="l1.479">     if (mdd-&gt;stream)</span>
<a href="#l1.480"></a><span id="l1.480">     {</span>
<a href="#l1.481"></a><span id="l1.481" class="difflineminus">-      mdd-&gt;stream-&gt;abort ((nsMIMESession *)mdd-&gt;stream-&gt;data_object, status);</span>
<a href="#l1.482"></a><span id="l1.482" class="difflineminus">-      PR_Free( mdd-&gt;stream );</span>
<a href="#l1.483"></a><span id="l1.483" class="difflineplus">+      mdd-&gt;stream-&gt;abort((nsMIMESession *)mdd-&gt;stream-&gt;data_object, status);</span>
<a href="#l1.484"></a><span id="l1.484" class="difflineplus">+      PR_Free(mdd-&gt;stream);</span>
<a href="#l1.485"></a><span id="l1.485">       mdd-&gt;stream = 0;</span>
<a href="#l1.486"></a><span id="l1.486">     }</span>
<a href="#l1.487"></a><span id="l1.487">   }</span>
<a href="#l1.488"></a><span id="l1.488"> </span>
<a href="#l1.489"></a><span id="l1.489" class="difflineminus">-  if ( mdd-&gt;headers )</span>
<a href="#l1.490"></a><span id="l1.490" class="difflineminus">-    MimeHeaders_free (mdd-&gt;headers);</span>
<a href="#l1.491"></a><span id="l1.491" class="difflineplus">+  if (mdd-&gt;headers)</span>
<a href="#l1.492"></a><span id="l1.492" class="difflineplus">+    MimeHeaders_free(mdd-&gt;headers);</span>
<a href="#l1.493"></a><span id="l1.493"> </span>
<a href="#l1.494"></a><span id="l1.494"> </span>
<a href="#l1.495"></a><span id="l1.495">   mime_free_attachments(mdd-&gt;attachments);</span>
<a href="#l1.496"></a><span id="l1.496"> </span>
<a href="#l1.497"></a><span id="l1.497">   PR_FREEIF(mdd-&gt;mailcharset);</span>
<a href="#l1.498"></a><span id="l1.498"> </span>
<a href="#l1.499"></a><span id="l1.499" class="difflineminus">-  PR_Free (mdd);</span>
<a href="#l1.500"></a><span id="l1.500" class="difflineplus">+  PR_Free(mdd);</span>
<a href="#l1.501"></a><span id="l1.501"> }</span>
<a href="#l1.502"></a><span id="l1.502"> </span>
<a href="#l1.503"></a><span id="l1.503"> static int</span>
<a href="#l1.504"></a><span id="l1.504" class="difflineminus">-make_mime_headers_copy ( void *closure, MimeHeaders *headers )</span>
<a href="#l1.505"></a><span id="l1.505" class="difflineplus">+make_mime_headers_copy(void *closure, MimeHeaders *headers)</span>
<a href="#l1.506"></a><span id="l1.506"> {</span>
<a href="#l1.507"></a><span id="l1.507" class="difflineminus">-  mime_draft_data *mdd = (mime_draft_data *) closure;</span>
<a href="#l1.508"></a><span id="l1.508" class="difflineplus">+  mime_draft_data *mdd = (mime_draft_data *)closure;</span>
<a href="#l1.509"></a><span id="l1.509"> </span>
<a href="#l1.510"></a><span id="l1.510" class="difflineminus">-  NS_ASSERTION ( mdd &amp;&amp; headers, &quot;null mime draft data and/or headers&quot; );</span>
<a href="#l1.511"></a><span id="l1.511" class="difflineplus">+  NS_ASSERTION(mdd &amp;&amp; headers, &quot;null mime draft data and/or headers&quot;);</span>
<a href="#l1.512"></a><span id="l1.512"> </span>
<a href="#l1.513"></a><span id="l1.513" class="difflineminus">-  if ( !mdd || ! headers )</span>
<a href="#l1.514"></a><span id="l1.514" class="difflineplus">+  if (!mdd || ! headers)</span>
<a href="#l1.515"></a><span id="l1.515">     return 0;</span>
<a href="#l1.516"></a><span id="l1.516"> </span>
<a href="#l1.517"></a><span id="l1.517" class="difflineminus">-  NS_ASSERTION ( mdd-&gt;headers == NULL , &quot;non null mime draft data headers&quot;);</span>
<a href="#l1.518"></a><span id="l1.518" class="difflineplus">+  NS_ASSERTION(mdd-&gt;headers == NULL , &quot;non null mime draft data headers&quot;);</span>
<a href="#l1.519"></a><span id="l1.519"> </span>
<a href="#l1.520"></a><span id="l1.520" class="difflineminus">-  mdd-&gt;headers = MimeHeaders_copy ( headers );</span>
<a href="#l1.521"></a><span id="l1.521" class="difflineplus">+  mdd-&gt;headers = MimeHeaders_copy(headers);</span>
<a href="#l1.522"></a><span id="l1.522">   mdd-&gt;options-&gt;done_parsing_outer_headers = true;</span>
<a href="#l1.523"></a><span id="l1.523"> </span>
<a href="#l1.524"></a><span id="l1.524">   return 0;</span>
<a href="#l1.525"></a><span id="l1.525"> }</span>
<a href="#l1.526"></a><span id="l1.526"> </span>
<a href="#l1.527"></a><span id="l1.527"> int</span>
<a href="#l1.528"></a><span id="l1.528" class="difflineminus">-mime_decompose_file_init_fn ( void *stream_closure, MimeHeaders *headers )</span>
<a href="#l1.529"></a><span id="l1.529" class="difflineplus">+mime_decompose_file_init_fn(void *stream_closure, MimeHeaders *headers)</span>
<a href="#l1.530"></a><span id="l1.530"> {</span>
<a href="#l1.531"></a><span id="l1.531" class="difflineminus">-  mime_draft_data *mdd = (mime_draft_data *) stream_closure;</span>
<a href="#l1.532"></a><span id="l1.532" class="difflineplus">+  mime_draft_data *mdd = (mime_draft_data *)stream_closure;</span>
<a href="#l1.533"></a><span id="l1.533">   nsMsgAttachedFile *newAttachment = 0;</span>
<a href="#l1.534"></a><span id="l1.534">   int nAttachments = 0;</span>
<a href="#l1.535"></a><span id="l1.535">   //char *hdr_value = NULL;</span>
<a href="#l1.536"></a><span id="l1.536">   char *parm_value = NULL;</span>
<a href="#l1.537"></a><span id="l1.537">   bool creatingMsgBody = true;</span>
<a href="#l1.538"></a><span id="l1.538"> </span>
<a href="#l1.539"></a><span id="l1.539" class="difflineminus">-  NS_ASSERTION (mdd &amp;&amp; headers, &quot;null mime draft data and/or headers&quot;);</span>
<a href="#l1.540"></a><span id="l1.540" class="difflineplus">+  NS_ASSERTION(mdd &amp;&amp; headers, &quot;null mime draft data and/or headers&quot;);</span>
<a href="#l1.541"></a><span id="l1.541">   if (!mdd || !headers)</span>
<a href="#l1.542"></a><span id="l1.542">     return -1;</span>
<a href="#l1.543"></a><span id="l1.543"> </span>
<a href="#l1.544"></a><span id="l1.544">   if (mdd-&gt;options-&gt;decompose_init_count)</span>
<a href="#l1.545"></a><span id="l1.545">   {</span>
<a href="#l1.546"></a><span id="l1.546">     mdd-&gt;options-&gt;decompose_init_count++;</span>
<a href="#l1.547"></a><span id="l1.547">     NS_ASSERTION(mdd-&gt;curAttachment, &quot;missing attachment in mime_decompose_file_init_fn&quot;);</span>
<a href="#l1.548"></a><span id="l1.548">     if (mdd-&gt;curAttachment)</span>
<a href="#l1.549"></a><span id="l1.549" class="difflineat">@@ -1904,34 +1904,34 @@ mime_decompose_file_init_fn ( void *stre</span>
<a href="#l1.550"></a><span id="l1.550">       return MIME_OUT_OF_MEMORY;</span>
<a href="#l1.551"></a><span id="l1.551">     mdd-&gt;attachments.AppendElement(newAttachment);</span>
<a href="#l1.552"></a><span id="l1.552">   }</span>
<a href="#l1.553"></a><span id="l1.553"> </span>
<a href="#l1.554"></a><span id="l1.554">   char *workURLSpec = nullptr;</span>
<a href="#l1.555"></a><span id="l1.555">   char *contLoc = nullptr;</span>
<a href="#l1.556"></a><span id="l1.556"> </span>
<a href="#l1.557"></a><span id="l1.557">   newAttachment-&gt;m_realName.Adopt(MimeHeaders_get_name(headers, mdd-&gt;options));</span>
<a href="#l1.558"></a><span id="l1.558" class="difflineminus">-  contLoc = MimeHeaders_get( headers, HEADER_CONTENT_LOCATION, false, false );</span>
<a href="#l1.559"></a><span id="l1.559" class="difflineplus">+  contLoc = MimeHeaders_get(headers, HEADER_CONTENT_LOCATION, false, false);</span>
<a href="#l1.560"></a><span id="l1.560">   if (!contLoc)</span>
<a href="#l1.561"></a><span id="l1.561" class="difflineminus">-      contLoc = MimeHeaders_get( headers, HEADER_CONTENT_BASE, false, false );</span>
<a href="#l1.562"></a><span id="l1.562" class="difflineplus">+      contLoc = MimeHeaders_get(headers, HEADER_CONTENT_BASE, false, false);</span>
<a href="#l1.563"></a><span id="l1.563"> </span>
<a href="#l1.564"></a><span id="l1.564">   if (!contLoc &amp;&amp; !newAttachment-&gt;m_realName.IsEmpty())</span>
<a href="#l1.565"></a><span id="l1.565">     workURLSpec = ToNewCString(newAttachment-&gt;m_realName);</span>
<a href="#l1.566"></a><span id="l1.566" class="difflineminus">-  if ( (contLoc) &amp;&amp; (!workURLSpec) )</span>
<a href="#l1.567"></a><span id="l1.567" class="difflineplus">+  if ((contLoc) &amp;&amp; (!workURLSpec))</span>
<a href="#l1.568"></a><span id="l1.568">     workURLSpec = strdup(contLoc);</span>
<a href="#l1.569"></a><span id="l1.569"> </span>
<a href="#l1.570"></a><span id="l1.570">   PR_FREEIF(contLoc);</span>
<a href="#l1.571"></a><span id="l1.571"> </span>
<a href="#l1.572"></a><span id="l1.572">   mdd-&gt;curAttachment = newAttachment;</span>
<a href="#l1.573"></a><span id="l1.573" class="difflineminus">-  newAttachment-&gt;m_type.Adopt(MimeHeaders_get ( headers, HEADER_CONTENT_TYPE, false, false ));</span>
<a href="#l1.574"></a><span id="l1.574" class="difflineplus">+  newAttachment-&gt;m_type.Adopt(MimeHeaders_get(headers, HEADER_CONTENT_TYPE, false, false));</span>
<a href="#l1.575"></a><span id="l1.575"> </span>
<a href="#l1.576"></a><span id="l1.576">   //</span>
<a href="#l1.577"></a><span id="l1.577">   // This is to handle the degenerated Apple Double attachment.</span>
<a href="#l1.578"></a><span id="l1.578">   //</span>
<a href="#l1.579"></a><span id="l1.579" class="difflineminus">-  parm_value = MimeHeaders_get( headers, HEADER_CONTENT_TYPE, false, false );</span>
<a href="#l1.580"></a><span id="l1.580" class="difflineplus">+  parm_value = MimeHeaders_get(headers, HEADER_CONTENT_TYPE, false, false);</span>
<a href="#l1.581"></a><span id="l1.581">   if (parm_value)</span>
<a href="#l1.582"></a><span id="l1.582">   {</span>
<a href="#l1.583"></a><span id="l1.583">     char *boundary = NULL;</span>
<a href="#l1.584"></a><span id="l1.584">     char *tmp_value = NULL;</span>
<a href="#l1.585"></a><span id="l1.585">     boundary = MimeHeaders_get_parameter(parm_value, &quot;boundary&quot;, NULL, NULL);</span>
<a href="#l1.586"></a><span id="l1.586">     if (boundary)</span>
<a href="#l1.587"></a><span id="l1.587">       tmp_value = PR_smprintf(&quot;; boundary=\&quot;%s\&quot;&quot;, boundary);</span>
<a href="#l1.588"></a><span id="l1.588">     if (tmp_value)</span>
<a href="#l1.589"></a><span id="l1.589" class="difflineat">@@ -1941,20 +1941,20 @@ mime_decompose_file_init_fn ( void *stre</span>
<a href="#l1.590"></a><span id="l1.590">     newAttachment-&gt;m_xMacCreator.Adopt(</span>
<a href="#l1.591"></a><span id="l1.591">       MimeHeaders_get_parameter(parm_value, &quot;x-mac-creator&quot;, NULL, NULL));</span>
<a href="#l1.592"></a><span id="l1.592">     PR_FREEIF(parm_value);</span>
<a href="#l1.593"></a><span id="l1.593">     PR_FREEIF(boundary);</span>
<a href="#l1.594"></a><span id="l1.594">     PR_FREEIF(tmp_value);</span>
<a href="#l1.595"></a><span id="l1.595">   }</span>
<a href="#l1.596"></a><span id="l1.596"> </span>
<a href="#l1.597"></a><span id="l1.597">   newAttachment-&gt;m_size = 0;</span>
<a href="#l1.598"></a><span id="l1.598" class="difflineminus">-  newAttachment-&gt;m_encoding.Adopt(MimeHeaders_get (headers, HEADER_CONTENT_TRANSFER_ENCODING,</span>
<a href="#l1.599"></a><span id="l1.599" class="difflineminus">-                                                   false, false));</span>
<a href="#l1.600"></a><span id="l1.600" class="difflineplus">+  newAttachment-&gt;m_encoding.Adopt(MimeHeaders_get(headers, HEADER_CONTENT_TRANSFER_ENCODING,</span>
<a href="#l1.601"></a><span id="l1.601" class="difflineplus">+                                                  false, false));</span>
<a href="#l1.602"></a><span id="l1.602">   newAttachment-&gt;m_description.Adopt(MimeHeaders_get(headers, HEADER_CONTENT_DESCRIPTION,</span>
<a href="#l1.603"></a><span id="l1.603" class="difflineminus">-                                                     false, false ));</span>
<a href="#l1.604"></a><span id="l1.604" class="difflineplus">+                                                     false, false));</span>
<a href="#l1.605"></a><span id="l1.605">   //</span>
<a href="#l1.606"></a><span id="l1.606">   // If we came up empty for description or the orig URL, we should do something about it.</span>
<a href="#l1.607"></a><span id="l1.607">   //</span>
<a href="#l1.608"></a><span id="l1.608">   if (newAttachment-&gt;m_description.IsEmpty() &amp;&amp; workURLSpec)</span>
<a href="#l1.609"></a><span id="l1.609">     newAttachment-&gt;m_description = workURLSpec;</span>
<a href="#l1.610"></a><span id="l1.610"> </span>
<a href="#l1.611"></a><span id="l1.611">   PR_FREEIF(workURLSpec);     // resource leak otherwise</span>
<a href="#l1.612"></a><span id="l1.612"> </span>
<a href="#l1.613"></a><span id="l1.613" class="difflineat">@@ -1971,30 +1971,30 @@ mime_decompose_file_init_fn ( void *stre</span>
<a href="#l1.614"></a><span id="l1.614">                                 nullptr, nullptr));</span>
<a href="#l1.615"></a><span id="l1.615">     if (!fileURL.IsEmpty())</span>
<a href="#l1.616"></a><span id="l1.616">       nsMimeNewURI(getter_AddRefs(newAttachment-&gt;m_origUrl), fileURL.get(),</span>
<a href="#l1.617"></a><span id="l1.617">                    nullptr);</span>
<a href="#l1.618"></a><span id="l1.618">     mdd-&gt;tmpFile = nullptr;</span>
<a href="#l1.619"></a><span id="l1.619">     return 0;</span>
<a href="#l1.620"></a><span id="l1.620">   }</span>
<a href="#l1.621"></a><span id="l1.621"> </span>
<a href="#l1.622"></a><span id="l1.622" class="difflineminus">-  nsCOMPtr &lt;nsIFile&gt; tmpFile = nullptr;</span>
<a href="#l1.623"></a><span id="l1.623" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; tmpFile = nullptr;</span>
<a href="#l1.624"></a><span id="l1.624">   {</span>
<a href="#l1.625"></a><span id="l1.625">     // Let's build a temp file with an extension based on the content-type: nsmail.&lt;extension&gt;</span>
<a href="#l1.626"></a><span id="l1.626"> </span>
<a href="#l1.627"></a><span id="l1.627" class="difflineminus">-    nsAutoCString  newAttachName (&quot;nsmail&quot;);</span>
<a href="#l1.628"></a><span id="l1.628" class="difflineplus">+    nsAutoCString newAttachName(&quot;nsmail&quot;);</span>
<a href="#l1.629"></a><span id="l1.629">     bool extensionAdded = false;</span>
<a href="#l1.630"></a><span id="l1.630">     // the content type may contain a charset. i.e. text/html; ISO-2022-JP...we want to strip off the charset</span>
<a href="#l1.631"></a><span id="l1.631">     // before we ask the mime service for a mime info for this content type.</span>
<a href="#l1.632"></a><span id="l1.632" class="difflineminus">-    nsAutoCString contentType (newAttachment-&gt;m_type);</span>
<a href="#l1.633"></a><span id="l1.633" class="difflineplus">+    nsAutoCString contentType(newAttachment-&gt;m_type);</span>
<a href="#l1.634"></a><span id="l1.634">     int32_t pos = contentType.FindChar(';');</span>
<a href="#l1.635"></a><span id="l1.635">     if (pos &gt; 0)</span>
<a href="#l1.636"></a><span id="l1.636">       contentType.SetLength(pos);</span>
<a href="#l1.637"></a><span id="l1.637" class="difflineminus">-    nsresult  rv = NS_OK;</span>
<a href="#l1.638"></a><span id="l1.638" class="difflineminus">-    nsCOMPtr&lt;nsIMIMEService&gt; mimeFinder (do_GetService(NS_MIMESERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l1.639"></a><span id="l1.639" class="difflineplus">+    nsresult rv = NS_OK;</span>
<a href="#l1.640"></a><span id="l1.640" class="difflineplus">+    nsCOMPtr&lt;nsIMIMEService&gt; mimeFinder(do_GetService(NS_MIMESERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l1.641"></a><span id="l1.641">     if (NS_SUCCEEDED(rv) &amp;&amp; mimeFinder)</span>
<a href="#l1.642"></a><span id="l1.642">     {</span>
<a href="#l1.643"></a><span id="l1.643">       nsAutoCString fileExtension;</span>
<a href="#l1.644"></a><span id="l1.644">       rv = mimeFinder-&gt;GetPrimaryExtension(contentType, EmptyCString(), fileExtension);</span>
<a href="#l1.645"></a><span id="l1.645"> </span>
<a href="#l1.646"></a><span id="l1.646">       if (NS_SUCCEEDED(rv) &amp;&amp; !fileExtension.IsEmpty())</span>
<a href="#l1.647"></a><span id="l1.647">       {</span>
<a href="#l1.648"></a><span id="l1.648">         newAttachName.Append(&quot;.&quot;);</span>
<a href="#l1.649"></a><span id="l1.649" class="difflineat">@@ -2060,39 +2060,39 @@ mime_decompose_file_init_fn ( void *stre</span>
<a href="#l1.650"></a><span id="l1.650">       fn = &amp;MimeUUDecoderInit;</span>
<a href="#l1.651"></a><span id="l1.651">     else if (newAttachment-&gt;m_encoding.LowerCaseEqualsLiteral(ENCODING_YENCODE))</span>
<a href="#l1.652"></a><span id="l1.652">       fn = &amp;MimeYDecoderInit;</span>
<a href="#l1.653"></a><span id="l1.653"> </span>
<a href="#l1.654"></a><span id="l1.654">     if (fn)</span>
<a href="#l1.655"></a><span id="l1.655">     {</span>
<a href="#l1.656"></a><span id="l1.656">       mdd-&gt;decoder_data = fn (/* The (MimeConverterOutputCallback) cast is to</span>
<a href="#l1.657"></a><span id="l1.657">                                  turn the `void' argument into `MimeObject'. */</span>
<a href="#l1.658"></a><span id="l1.658" class="difflineminus">-                              ((MimeConverterOutputCallback) dummy_file_write),</span>
<a href="#l1.659"></a><span id="l1.659" class="difflineplus">+                              ((MimeConverterOutputCallback)dummy_file_write),</span>
<a href="#l1.660"></a><span id="l1.660">                               mdd-&gt;tmpFileStream);</span>
<a href="#l1.661"></a><span id="l1.661">       if (!mdd-&gt;decoder_data)</span>
<a href="#l1.662"></a><span id="l1.662">         return MIME_OUT_OF_MEMORY;</span>
<a href="#l1.663"></a><span id="l1.663">     }</span>
<a href="#l1.664"></a><span id="l1.664">   }</span>
<a href="#l1.665"></a><span id="l1.665"> </span>
<a href="#l1.666"></a><span id="l1.666">   return 0;</span>
<a href="#l1.667"></a><span id="l1.667"> }</span>
<a href="#l1.668"></a><span id="l1.668"> </span>
<a href="#l1.669"></a><span id="l1.669"> int</span>
<a href="#l1.670"></a><span id="l1.670" class="difflineminus">-mime_decompose_file_output_fn (const char     *buf,</span>
<a href="#l1.671"></a><span id="l1.671" class="difflineminus">-                               int32_t  size,</span>
<a href="#l1.672"></a><span id="l1.672" class="difflineminus">-                               void     *stream_closure )</span>
<a href="#l1.673"></a><span id="l1.673" class="difflineplus">+mime_decompose_file_output_fn(const char *buf,</span>
<a href="#l1.674"></a><span id="l1.674" class="difflineplus">+                              int32_t size,</span>
<a href="#l1.675"></a><span id="l1.675" class="difflineplus">+                              void *stream_closure)</span>
<a href="#l1.676"></a><span id="l1.676"> {</span>
<a href="#l1.677"></a><span id="l1.677" class="difflineminus">-  mime_draft_data *mdd = (mime_draft_data *) stream_closure;</span>
<a href="#l1.678"></a><span id="l1.678" class="difflineplus">+  mime_draft_data *mdd = (mime_draft_data *)stream_closure;</span>
<a href="#l1.679"></a><span id="l1.679">   int ret = 0;</span>
<a href="#l1.680"></a><span id="l1.680"> </span>
<a href="#l1.681"></a><span id="l1.681" class="difflineminus">-  NS_ASSERTION (mdd &amp;&amp; buf, &quot;missing mime draft data and/or buf&quot;);</span>
<a href="#l1.682"></a><span id="l1.682" class="difflineplus">+  NS_ASSERTION(mdd &amp;&amp; buf, &quot;missing mime draft data and/or buf&quot;);</span>
<a href="#l1.683"></a><span id="l1.683">   if (!mdd || !buf) return -1;</span>
<a href="#l1.684"></a><span id="l1.684">   if (!size) return 0;</span>
<a href="#l1.685"></a><span id="l1.685"> </span>
<a href="#l1.686"></a><span id="l1.686" class="difflineminus">-  if ( !mdd-&gt;tmpFileStream )</span>
<a href="#l1.687"></a><span id="l1.687" class="difflineplus">+  if (!mdd-&gt;tmpFileStream)</span>
<a href="#l1.688"></a><span id="l1.688">     return 0;</span>
<a href="#l1.689"></a><span id="l1.689"> </span>
<a href="#l1.690"></a><span id="l1.690">   if (mdd-&gt;decoder_data) {</span>
<a href="#l1.691"></a><span id="l1.691">     int32_t outsize;</span>
<a href="#l1.692"></a><span id="l1.692">     ret = MimeDecoderWrite(mdd-&gt;decoder_data, buf, size, &amp;outsize);</span>
<a href="#l1.693"></a><span id="l1.693">     if (ret == -1) return -1;</span>
<a href="#l1.694"></a><span id="l1.694">     mdd-&gt;curAttachment-&gt;m_size += outsize;</span>
<a href="#l1.695"></a><span id="l1.695">   }</span>
<a href="#l1.696"></a><span id="l1.696" class="difflineat">@@ -2104,24 +2104,24 @@ mime_decompose_file_output_fn (const cha</span>
<a href="#l1.697"></a><span id="l1.697">       return MIME_ERROR_WRITING_FILE;</span>
<a href="#l1.698"></a><span id="l1.698">     mdd-&gt;curAttachment-&gt;m_size += size;</span>
<a href="#l1.699"></a><span id="l1.699">   }</span>
<a href="#l1.700"></a><span id="l1.700"> </span>
<a href="#l1.701"></a><span id="l1.701">   return 0;</span>
<a href="#l1.702"></a><span id="l1.702"> }</span>
<a href="#l1.703"></a><span id="l1.703"> </span>
<a href="#l1.704"></a><span id="l1.704"> int</span>
<a href="#l1.705"></a><span id="l1.705" class="difflineminus">-mime_decompose_file_close_fn ( void *stream_closure )</span>
<a href="#l1.706"></a><span id="l1.706" class="difflineplus">+mime_decompose_file_close_fn(void *stream_closure)</span>
<a href="#l1.707"></a><span id="l1.707"> {</span>
<a href="#l1.708"></a><span id="l1.708" class="difflineminus">-  mime_draft_data *mdd = (mime_draft_data *) stream_closure;</span>
<a href="#l1.709"></a><span id="l1.709" class="difflineplus">+  mime_draft_data *mdd = (mime_draft_data *)stream_closure;</span>
<a href="#l1.710"></a><span id="l1.710"> </span>
<a href="#l1.711"></a><span id="l1.711">   if (!mdd)</span>
<a href="#l1.712"></a><span id="l1.712">     return -1;</span>
<a href="#l1.713"></a><span id="l1.713"> </span>
<a href="#l1.714"></a><span id="l1.714" class="difflineminus">-  if ( --mdd-&gt;options-&gt;decompose_init_count &gt; 0 )</span>
<a href="#l1.715"></a><span id="l1.715" class="difflineplus">+  if (--mdd-&gt;options-&gt;decompose_init_count &gt; 0)</span>
<a href="#l1.716"></a><span id="l1.716">       return 0;</span>
<a href="#l1.717"></a><span id="l1.717"> </span>
<a href="#l1.718"></a><span id="l1.718">   if (mdd-&gt;decoder_data) {</span>
<a href="#l1.719"></a><span id="l1.719">     MimeDecoderDestroy(mdd-&gt;decoder_data, false);</span>
<a href="#l1.720"></a><span id="l1.720">     mdd-&gt;decoder_data = 0;</span>
<a href="#l1.721"></a><span id="l1.721">   }</span>
<a href="#l1.722"></a><span id="l1.722"> </span>
<a href="#l1.723"></a><span id="l1.723">   if (!mdd-&gt;tmpFileStream) {</span>
<a href="#l1.724"></a><span id="l1.724" class="difflineat">@@ -2146,25 +2146,25 @@ mime_bridge_create_draft_stream(</span>
<a href="#l1.725"></a><span id="l1.725">                           nsIURI              *uri,</span>
<a href="#l1.726"></a><span id="l1.726">                           nsMimeOutputType    format_out)</span>
<a href="#l1.727"></a><span id="l1.727"> {</span>
<a href="#l1.728"></a><span id="l1.728">   int                     status = 0;</span>
<a href="#l1.729"></a><span id="l1.729">   nsMIMESession           *stream = nullptr;</span>
<a href="#l1.730"></a><span id="l1.730">   mime_draft_data  *mdd = nullptr;</span>
<a href="#l1.731"></a><span id="l1.731">   MimeObject              *obj = nullptr;</span>
<a href="#l1.732"></a><span id="l1.732"> </span>
<a href="#l1.733"></a><span id="l1.733" class="difflineminus">-  if ( !uri )</span>
<a href="#l1.734"></a><span id="l1.734" class="difflineplus">+  if (!uri)</span>
<a href="#l1.735"></a><span id="l1.735">     return nullptr;</span>
<a href="#l1.736"></a><span id="l1.736"> </span>
<a href="#l1.737"></a><span id="l1.737">   mdd = new mime_draft_data;</span>
<a href="#l1.738"></a><span id="l1.738">   if (!mdd)</span>
<a href="#l1.739"></a><span id="l1.739">     return nullptr;</span>
<a href="#l1.740"></a><span id="l1.740"> </span>
<a href="#l1.741"></a><span id="l1.741">   nsAutoCString turl;</span>
<a href="#l1.742"></a><span id="l1.742" class="difflineminus">-  nsCOMPtr &lt;nsIMsgMessageService&gt; msgService;</span>
<a href="#l1.743"></a><span id="l1.743" class="difflineplus">+  nsCOMPtr&lt;nsIMsgMessageService&gt; msgService;</span>
<a href="#l1.744"></a><span id="l1.744">   nsCOMPtr&lt;nsIURI&gt; aURL;</span>
<a href="#l1.745"></a><span id="l1.745">   nsAutoCString urlString;</span>
<a href="#l1.746"></a><span id="l1.746">   nsresult rv;</span>
<a href="#l1.747"></a><span id="l1.747"> </span>
<a href="#l1.748"></a><span id="l1.748">   // first, convert the rdf msg uri into a url that represents the message...</span>
<a href="#l1.749"></a><span id="l1.749">   if (NS_FAILED(uri-&gt;GetSpec(turl)))</span>
<a href="#l1.750"></a><span id="l1.750">     goto FAIL;</span>
<a href="#l1.751"></a><span id="l1.751"> </span>
<a href="#l1.752"></a><span id="l1.752" class="difflineat">@@ -2190,17 +2190,17 @@ mime_bridge_create_draft_stream(</span>
<a href="#l1.753"></a><span id="l1.753">   newPluginObj2-&gt;GetForwardInline(&amp;mdd-&gt;forwardInline);</span>
<a href="#l1.754"></a><span id="l1.754">   newPluginObj2-&gt;GetForwardInlineFilter(&amp;mdd-&gt;forwardInlineFilter);</span>
<a href="#l1.755"></a><span id="l1.755">   newPluginObj2-&gt;GetForwardToAddress(mdd-&gt;forwardToAddress);</span>
<a href="#l1.756"></a><span id="l1.756">   newPluginObj2-&gt;GetOverrideComposeFormat(&amp;mdd-&gt;overrideComposeFormat);</span>
<a href="#l1.757"></a><span id="l1.757">   newPluginObj2-&gt;GetIdentity(getter_AddRefs(mdd-&gt;identity));</span>
<a href="#l1.758"></a><span id="l1.758">   newPluginObj2-&gt;GetOriginalMsgURI(&amp;mdd-&gt;originalMsgURI);</span>
<a href="#l1.759"></a><span id="l1.759">   newPluginObj2-&gt;GetOrigMsgHdr(getter_AddRefs(mdd-&gt;origMsgHdr));</span>
<a href="#l1.760"></a><span id="l1.760">   mdd-&gt;format_out = format_out;</span>
<a href="#l1.761"></a><span id="l1.761" class="difflineminus">-  mdd-&gt;options = new  MimeDisplayOptions ;</span>
<a href="#l1.762"></a><span id="l1.762" class="difflineplus">+  mdd-&gt;options = new MimeDisplayOptions ;</span>
<a href="#l1.763"></a><span id="l1.763">   if (!mdd-&gt;options)</span>
<a href="#l1.764"></a><span id="l1.764">     goto FAIL;</span>
<a href="#l1.765"></a><span id="l1.765"> </span>
<a href="#l1.766"></a><span id="l1.766">   mdd-&gt;options-&gt;url = strdup(mdd-&gt;url_name);</span>
<a href="#l1.767"></a><span id="l1.767">   mdd-&gt;options-&gt;format_out = format_out;     // output format</span>
<a href="#l1.768"></a><span id="l1.768">   mdd-&gt;options-&gt;decompose_file_p = true; /* new field in MimeDisplayOptions */</span>
<a href="#l1.769"></a><span id="l1.769">   mdd-&gt;options-&gt;stream_closure = mdd;</span>
<a href="#l1.770"></a><span id="l1.770">   mdd-&gt;options-&gt;html_closure = mdd;</span>
<a href="#l1.771"></a><span id="l1.771" class="difflineat">@@ -2217,47 +2217,47 @@ mime_bridge_create_draft_stream(</span>
<a href="#l1.772"></a><span id="l1.772">   /* If we're attaching a message (for forwarding) then we must eradicate all</span>
<a href="#l1.773"></a><span id="l1.773">    traces of xlateion from it, since forwarding someone else a message</span>
<a href="#l1.774"></a><span id="l1.774">    that wasn't xlated for them doesn't work.  We have to dexlate it</span>
<a href="#l1.775"></a><span id="l1.775">    before sending it.</span>
<a href="#l1.776"></a><span id="l1.776">    */</span>
<a href="#l1.777"></a><span id="l1.777">   mdd-&gt;options-&gt;decrypt_p = true;</span>
<a href="#l1.778"></a><span id="l1.778"> #endif /* ENABLE_SMIME */</span>
<a href="#l1.779"></a><span id="l1.779"> </span>
<a href="#l1.780"></a><span id="l1.780" class="difflineminus">-  obj = mime_new ( (MimeObjectClass *) &amp;mimeMessageClass, (MimeHeaders *) NULL, MESSAGE_RFC822 );</span>
<a href="#l1.781"></a><span id="l1.781" class="difflineminus">-  if ( !obj )</span>
<a href="#l1.782"></a><span id="l1.782" class="difflineplus">+  obj = mime_new((MimeObjectClass *)&amp;mimeMessageClass, (MimeHeaders *)NULL, MESSAGE_RFC822);</span>
<a href="#l1.783"></a><span id="l1.783" class="difflineplus">+  if (!obj)</span>
<a href="#l1.784"></a><span id="l1.784">     goto FAIL;</span>
<a href="#l1.785"></a><span id="l1.785"> </span>
<a href="#l1.786"></a><span id="l1.786">   obj-&gt;options = mdd-&gt;options;</span>
<a href="#l1.787"></a><span id="l1.787">   mdd-&gt;obj = obj;</span>
<a href="#l1.788"></a><span id="l1.788"> </span>
<a href="#l1.789"></a><span id="l1.789" class="difflineminus">-  stream = PR_NEWZAP ( nsMIMESession );</span>
<a href="#l1.790"></a><span id="l1.790" class="difflineminus">-  if ( !stream )</span>
<a href="#l1.791"></a><span id="l1.791" class="difflineplus">+  stream = PR_NEWZAP(nsMIMESession);</span>
<a href="#l1.792"></a><span id="l1.792" class="difflineplus">+  if (!stream)</span>
<a href="#l1.793"></a><span id="l1.793">     goto FAIL;</span>
<a href="#l1.794"></a><span id="l1.794"> </span>
<a href="#l1.795"></a><span id="l1.795">   stream-&gt;name = &quot;MIME To Draft Converter Stream&quot;;</span>
<a href="#l1.796"></a><span id="l1.796">   stream-&gt;complete = mime_parse_stream_complete;</span>
<a href="#l1.797"></a><span id="l1.797">   stream-&gt;abort = mime_parse_stream_abort;</span>
<a href="#l1.798"></a><span id="l1.798">   stream-&gt;put_block = mime_parse_stream_write;</span>
<a href="#l1.799"></a><span id="l1.799">   stream-&gt;data_object = mdd;</span>
<a href="#l1.800"></a><span id="l1.800"> </span>
<a href="#l1.801"></a><span id="l1.801" class="difflineminus">-  status = obj-&gt;clazz-&gt;initialize ( obj );</span>
<a href="#l1.802"></a><span id="l1.802" class="difflineminus">-  if ( status &gt;= 0 )</span>
<a href="#l1.803"></a><span id="l1.803" class="difflineminus">-    status = obj-&gt;clazz-&gt;parse_begin ( obj );</span>
<a href="#l1.804"></a><span id="l1.804" class="difflineminus">-  if ( status &lt; 0 )</span>
<a href="#l1.805"></a><span id="l1.805" class="difflineplus">+  status = obj-&gt;clazz-&gt;initialize(obj);</span>
<a href="#l1.806"></a><span id="l1.806" class="difflineplus">+  if (status &gt;= 0)</span>
<a href="#l1.807"></a><span id="l1.807" class="difflineplus">+    status = obj-&gt;clazz-&gt;parse_begin(obj);</span>
<a href="#l1.808"></a><span id="l1.808" class="difflineplus">+  if (status &lt; 0)</span>
<a href="#l1.809"></a><span id="l1.809">     goto FAIL;</span>
<a href="#l1.810"></a><span id="l1.810"> </span>
<a href="#l1.811"></a><span id="l1.811">   return stream;</span>
<a href="#l1.812"></a><span id="l1.812"> </span>
<a href="#l1.813"></a><span id="l1.813"> FAIL:</span>
<a href="#l1.814"></a><span id="l1.814">   if (mdd)</span>
<a href="#l1.815"></a><span id="l1.815">   {</span>
<a href="#l1.816"></a><span id="l1.816">     PR_Free(mdd-&gt;url_name);</span>
<a href="#l1.817"></a><span id="l1.817">     PR_Free(mdd-&gt;originalMsgURI);</span>
<a href="#l1.818"></a><span id="l1.818">     if (mdd-&gt;options)</span>
<a href="#l1.819"></a><span id="l1.819">       delete mdd-&gt;options;</span>
<a href="#l1.820"></a><span id="l1.820" class="difflineminus">-    PR_Free ( mdd );</span>
<a href="#l1.821"></a><span id="l1.821" class="difflineplus">+    PR_Free(mdd);</span>
<a href="#l1.822"></a><span id="l1.822">   }</span>
<a href="#l1.823"></a><span id="l1.823" class="difflineminus">-  PR_Free ( stream );</span>
<a href="#l1.824"></a><span id="l1.824" class="difflineminus">-  PR_Free ( obj );</span>
<a href="#l1.825"></a><span id="l1.825" class="difflineplus">+  PR_Free(stream);</span>
<a href="#l1.826"></a><span id="l1.826" class="difflineplus">+  PR_Free(obj);</span>
<a href="#l1.827"></a><span id="l1.827"> </span>
<a href="#l1.828"></a><span id="l1.828">   return nullptr;</span>
<a href="#l1.829"></a><span id="l1.829"> }</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

