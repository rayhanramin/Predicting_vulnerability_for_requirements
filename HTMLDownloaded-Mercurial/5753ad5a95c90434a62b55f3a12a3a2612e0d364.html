<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 25478:5753ad5a95c90434a62b55f3a12a3a2612e0d364</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 5753ad5a95c90434a62b55f3a12a3a2612e0d364" />
<meta property="og:url" content="/comm-central/rev/5753ad5a95c90434a62b55f3a12a3a2612e0d364" />
<meta property="og:description" content="Bug 1515877 - Turn on ESLint in mailnews/local; r=aceman" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 5753ad5a95c90434a62b55f3a12a3a2612e0d364 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/5753ad5a95c90434a62b55f3a12a3a2612e0d364">shortlog</a> |
<a href="/comm-central/log/5753ad5a95c90434a62b55f3a12a3a2612e0d364">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/5753ad5a95c90434a62b55f3a12a3a2612e0d364">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/5753ad5a95c90434a62b55f3a12a3a2612e0d364">files</a> |
changeset |
<a href="/comm-central/raw-rev/5753ad5a95c90434a62b55f3a12a3a2612e0d364">raw</a>  | <a href="/comm-central/archive/5753ad5a95c90434a62b55f3a12a3a2612e0d364.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1515877">Bug 1515877</a> - Turn on ESLint in mailnews/local; r=aceman
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#71;&#101;&#111;&#102;&#102;&#32;&#76;&#97;&#110;&#107;&#111;&#119;&#32;&#60;&#103;&#101;&#111;&#102;&#102;&#64;&#100;&#97;&#114;&#107;&#116;&#114;&#111;&#106;&#97;&#110;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Tue, 01 Jan 2019 11:21:26 +1300</td></tr>

<tr>
 <td>changeset 25478</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/5753ad5a95c90434a62b55f3a12a3a2612e0d364">5753ad5a95c90434a62b55f3a12a3a2612e0d364</a></td>
</tr>



<tr>
<td>parent 25477</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/71d23319ac8228b0e4b35ad66f13a9221f8947c6">71d23319ac8228b0e4b35ad66f13a9221f8947c6</a>
</td>
</tr>

<tr>
<td>child 25479</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/40bfc93a1dcc6baec73082c6c39999b787023efb">40bfc93a1dcc6baec73082c6c39999b787023efb</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=5753ad5a95c90434a62b55f3a12a3a2612e0d364">15287</a></td></tr>
<tr><td>push user</td><td>geoff@darktrojan.net</td></tr>
<tr><td>push date</td><td class="date age">Mon, 31 Dec 2018 22:24:31 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@a58e59146246 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=a58e591462463eefa900ed706dc866c2c2173717">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=a58e591462463eefa900ed706dc866c2c2173717&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=a58e591462463eefa900ed706dc866c2c2173717&newProject=comm-central&newRevision=5753ad5a95c90434a62b55f3a12a3a2612e0d364&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=a58e591462463eefa900ed706dc866c2c2173717&newProject=comm-central&newRevision=5753ad5a95c90434a62b55f3a12a3a2612e0d364&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=a58e591462463eefa900ed706dc866c2c2173717&newProject=comm-central&newRevision=5753ad5a95c90434a62b55f3a12a3a2612e0d364&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28aceman%29&revcount=50">aceman</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1515877">1515877</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1515877">Bug 1515877</a> - Turn on ESLint in mailnews/local; r=aceman</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5753ad5a95c90434a62b55f3a12a3a2612e0d364/.eslintignore">.eslintignore</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5753ad5a95c90434a62b55f3a12a3a2612e0d364/.eslintignore">file</a> |
<a href="/comm-central/annotate/5753ad5a95c90434a62b55f3a12a3a2612e0d364/.eslintignore">annotate</a> |
<a href="/comm-central/diff/5753ad5a95c90434a62b55f3a12a3a2612e0d364/.eslintignore">diff</a> |
<a href="/comm-central/comparison/5753ad5a95c90434a62b55f3a12a3a2612e0d364/.eslintignore">comparison</a> |
<a href="/comm-central/log/5753ad5a95c90434a62b55f3a12a3a2612e0d364/.eslintignore">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/.eslintrc.js">mailnews/local/test/unit/.eslintrc.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/.eslintrc.js">file</a> |
<a href="/comm-central/annotate/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/.eslintrc.js">annotate</a> |
<a href="/comm-central/diff/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/.eslintrc.js">diff</a> |
<a href="/comm-central/comparison/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/.eslintrc.js">comparison</a> |
<a href="/comm-central/log/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/.eslintrc.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/head_maillocal.js">mailnews/local/test/unit/head_maillocal.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/head_maillocal.js">file</a> |
<a href="/comm-central/annotate/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/head_maillocal.js">annotate</a> |
<a href="/comm-central/diff/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/head_maillocal.js">diff</a> |
<a href="/comm-central/comparison/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/head_maillocal.js">comparison</a> |
<a href="/comm-central/log/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/head_maillocal.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_bug457168.js">mailnews/local/test/unit/test_bug457168.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_bug457168.js">file</a> |
<a href="/comm-central/annotate/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_bug457168.js">annotate</a> |
<a href="/comm-central/diff/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_bug457168.js">diff</a> |
<a href="/comm-central/comparison/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_bug457168.js">comparison</a> |
<a href="/comm-central/log/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_bug457168.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_duplicateKey.js">mailnews/local/test/unit/test_duplicateKey.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_duplicateKey.js">file</a> |
<a href="/comm-central/annotate/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_duplicateKey.js">annotate</a> |
<a href="/comm-central/diff/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_duplicateKey.js">diff</a> |
<a href="/comm-central/comparison/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_duplicateKey.js">comparison</a> |
<a href="/comm-central/log/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_duplicateKey.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_fileName.js">mailnews/local/test/unit/test_fileName.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_fileName.js">file</a> |
<a href="/comm-central/annotate/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_fileName.js">annotate</a> |
<a href="/comm-central/diff/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_fileName.js">diff</a> |
<a href="/comm-central/comparison/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_fileName.js">comparison</a> |
<a href="/comm-central/log/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_fileName.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_folderLoaded.js">mailnews/local/test/unit/test_folderLoaded.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_folderLoaded.js">file</a> |
<a href="/comm-central/annotate/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_folderLoaded.js">annotate</a> |
<a href="/comm-central/diff/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_folderLoaded.js">diff</a> |
<a href="/comm-central/comparison/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_folderLoaded.js">comparison</a> |
<a href="/comm-central/log/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_folderLoaded.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_localFolder.js">mailnews/local/test/unit/test_localFolder.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_localFolder.js">file</a> |
<a href="/comm-central/annotate/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_localFolder.js">annotate</a> |
<a href="/comm-central/diff/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_localFolder.js">diff</a> |
<a href="/comm-central/comparison/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_localFolder.js">comparison</a> |
<a href="/comm-central/log/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_localFolder.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_mailboxContentLength.js">mailnews/local/test/unit/test_mailboxContentLength.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_mailboxContentLength.js">file</a> |
<a href="/comm-central/annotate/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_mailboxContentLength.js">annotate</a> |
<a href="/comm-central/diff/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_mailboxContentLength.js">diff</a> |
<a href="/comm-central/comparison/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_mailboxContentLength.js">comparison</a> |
<a href="/comm-central/log/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_mailboxContentLength.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_mailboxProtocol.js">mailnews/local/test/unit/test_mailboxProtocol.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_mailboxProtocol.js">file</a> |
<a href="/comm-central/annotate/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_mailboxProtocol.js">annotate</a> |
<a href="/comm-central/diff/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_mailboxProtocol.js">diff</a> |
<a href="/comm-central/comparison/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_mailboxProtocol.js">comparison</a> |
<a href="/comm-central/log/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_mailboxProtocol.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_movemailDownload.js">mailnews/local/test/unit/test_movemailDownload.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_movemailDownload.js">file</a> |
<a href="/comm-central/annotate/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_movemailDownload.js">annotate</a> |
<a href="/comm-central/diff/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_movemailDownload.js">diff</a> |
<a href="/comm-central/comparison/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_movemailDownload.js">comparison</a> |
<a href="/comm-central/log/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_movemailDownload.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_msgCopy.js">mailnews/local/test/unit/test_msgCopy.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_msgCopy.js">file</a> |
<a href="/comm-central/annotate/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_msgCopy.js">annotate</a> |
<a href="/comm-central/diff/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_msgCopy.js">diff</a> |
<a href="/comm-central/comparison/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_msgCopy.js">comparison</a> |
<a href="/comm-central/log/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_msgCopy.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_msgIDParsing.js">mailnews/local/test/unit/test_msgIDParsing.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_msgIDParsing.js">file</a> |
<a href="/comm-central/annotate/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_msgIDParsing.js">annotate</a> |
<a href="/comm-central/diff/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_msgIDParsing.js">diff</a> |
<a href="/comm-central/comparison/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_msgIDParsing.js">comparison</a> |
<a href="/comm-central/log/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_msgIDParsing.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_nsIMsgLocalMailFolder.js">mailnews/local/test/unit/test_nsIMsgLocalMailFolder.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_nsIMsgLocalMailFolder.js">file</a> |
<a href="/comm-central/annotate/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_nsIMsgLocalMailFolder.js">annotate</a> |
<a href="/comm-central/diff/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_nsIMsgLocalMailFolder.js">diff</a> |
<a href="/comm-central/comparison/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_nsIMsgLocalMailFolder.js">comparison</a> |
<a href="/comm-central/log/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_nsIMsgLocalMailFolder.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_nsIMsgPluggableStore.js">mailnews/local/test/unit/test_nsIMsgPluggableStore.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_nsIMsgPluggableStore.js">file</a> |
<a href="/comm-central/annotate/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_nsIMsgPluggableStore.js">annotate</a> |
<a href="/comm-central/diff/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_nsIMsgPluggableStore.js">diff</a> |
<a href="/comm-central/comparison/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_nsIMsgPluggableStore.js">comparison</a> |
<a href="/comm-central/log/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_nsIMsgPluggableStore.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_over2GBMailboxes.js">mailnews/local/test/unit/test_over2GBMailboxes.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_over2GBMailboxes.js">file</a> |
<a href="/comm-central/annotate/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_over2GBMailboxes.js">annotate</a> |
<a href="/comm-central/diff/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_over2GBMailboxes.js">diff</a> |
<a href="/comm-central/comparison/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_over2GBMailboxes.js">comparison</a> |
<a href="/comm-central/log/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_over2GBMailboxes.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_over4GBMailboxes.js">mailnews/local/test/unit/test_over4GBMailboxes.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_over4GBMailboxes.js">file</a> |
<a href="/comm-central/annotate/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_over4GBMailboxes.js">annotate</a> |
<a href="/comm-central/diff/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_over4GBMailboxes.js">diff</a> |
<a href="/comm-central/comparison/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_over4GBMailboxes.js">comparison</a> |
<a href="/comm-central/log/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_over4GBMailboxes.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3AuthMethods.js">mailnews/local/test/unit/test_pop3AuthMethods.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3AuthMethods.js">file</a> |
<a href="/comm-central/annotate/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3AuthMethods.js">annotate</a> |
<a href="/comm-central/diff/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3AuthMethods.js">diff</a> |
<a href="/comm-central/comparison/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3AuthMethods.js">comparison</a> |
<a href="/comm-central/log/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3AuthMethods.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3Download.js">mailnews/local/test/unit/test_pop3Download.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3Download.js">file</a> |
<a href="/comm-central/annotate/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3Download.js">annotate</a> |
<a href="/comm-central/diff/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3Download.js">diff</a> |
<a href="/comm-central/comparison/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3Download.js">comparison</a> |
<a href="/comm-central/log/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3Download.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3DownloadTempFileHandling.js">mailnews/local/test/unit/test_pop3DownloadTempFileHandling.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3DownloadTempFileHandling.js">file</a> |
<a href="/comm-central/annotate/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3DownloadTempFileHandling.js">annotate</a> |
<a href="/comm-central/diff/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3DownloadTempFileHandling.js">diff</a> |
<a href="/comm-central/comparison/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3DownloadTempFileHandling.js">comparison</a> |
<a href="/comm-central/log/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3DownloadTempFileHandling.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3Duplicates.js">mailnews/local/test/unit/test_pop3Duplicates.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3Duplicates.js">file</a> |
<a href="/comm-central/annotate/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3Duplicates.js">annotate</a> |
<a href="/comm-central/diff/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3Duplicates.js">diff</a> |
<a href="/comm-central/comparison/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3Duplicates.js">comparison</a> |
<a href="/comm-central/log/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3Duplicates.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3FilterActions.js">mailnews/local/test/unit/test_pop3FilterActions.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3FilterActions.js">file</a> |
<a href="/comm-central/annotate/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3FilterActions.js">annotate</a> |
<a href="/comm-central/diff/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3FilterActions.js">diff</a> |
<a href="/comm-central/comparison/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3FilterActions.js">comparison</a> |
<a href="/comm-central/log/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3FilterActions.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3GSSAPIFail.js">mailnews/local/test/unit/test_pop3GSSAPIFail.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3GSSAPIFail.js">file</a> |
<a href="/comm-central/annotate/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3GSSAPIFail.js">annotate</a> |
<a href="/comm-central/diff/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3GSSAPIFail.js">diff</a> |
<a href="/comm-central/comparison/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3GSSAPIFail.js">comparison</a> |
<a href="/comm-central/log/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3GSSAPIFail.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3GetNewMail.js">mailnews/local/test/unit/test_pop3GetNewMail.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3GetNewMail.js">file</a> |
<a href="/comm-central/annotate/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3GetNewMail.js">annotate</a> |
<a href="/comm-central/diff/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3GetNewMail.js">diff</a> |
<a href="/comm-central/comparison/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3GetNewMail.js">comparison</a> |
<a href="/comm-central/log/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3GetNewMail.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3MoveFilter.js">mailnews/local/test/unit/test_pop3MoveFilter.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3MoveFilter.js">file</a> |
<a href="/comm-central/annotate/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3MoveFilter.js">annotate</a> |
<a href="/comm-central/diff/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3MoveFilter.js">diff</a> |
<a href="/comm-central/comparison/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3MoveFilter.js">comparison</a> |
<a href="/comm-central/log/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3MoveFilter.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3MoveFilter2.js">mailnews/local/test/unit/test_pop3MoveFilter2.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3MoveFilter2.js">file</a> |
<a href="/comm-central/annotate/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3MoveFilter2.js">annotate</a> |
<a href="/comm-central/diff/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3MoveFilter2.js">diff</a> |
<a href="/comm-central/comparison/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3MoveFilter2.js">comparison</a> |
<a href="/comm-central/log/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3MoveFilter2.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3MultiCopy.js">mailnews/local/test/unit/test_pop3MultiCopy.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3MultiCopy.js">file</a> |
<a href="/comm-central/annotate/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3MultiCopy.js">annotate</a> |
<a href="/comm-central/diff/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3MultiCopy.js">diff</a> |
<a href="/comm-central/comparison/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3MultiCopy.js">comparison</a> |
<a href="/comm-central/log/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3MultiCopy.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3MultiCopy2.js">mailnews/local/test/unit/test_pop3MultiCopy2.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3MultiCopy2.js">file</a> |
<a href="/comm-central/annotate/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3MultiCopy2.js">annotate</a> |
<a href="/comm-central/diff/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3MultiCopy2.js">diff</a> |
<a href="/comm-central/comparison/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3MultiCopy2.js">comparison</a> |
<a href="/comm-central/log/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3MultiCopy2.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3Password.js">mailnews/local/test/unit/test_pop3Password.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3Password.js">file</a> |
<a href="/comm-central/annotate/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3Password.js">annotate</a> |
<a href="/comm-central/diff/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3Password.js">diff</a> |
<a href="/comm-central/comparison/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3Password.js">comparison</a> |
<a href="/comm-central/log/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3Password.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3Password2.js">mailnews/local/test/unit/test_pop3Password2.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3Password2.js">file</a> |
<a href="/comm-central/annotate/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3Password2.js">annotate</a> |
<a href="/comm-central/diff/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3Password2.js">diff</a> |
<a href="/comm-central/comparison/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3Password2.js">comparison</a> |
<a href="/comm-central/log/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3Password2.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3Password3.js">mailnews/local/test/unit/test_pop3Password3.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3Password3.js">file</a> |
<a href="/comm-central/annotate/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3Password3.js">annotate</a> |
<a href="/comm-central/diff/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3Password3.js">diff</a> |
<a href="/comm-central/comparison/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3Password3.js">comparison</a> |
<a href="/comm-central/log/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3Password3.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3PasswordFailure.js">mailnews/local/test/unit/test_pop3PasswordFailure.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3PasswordFailure.js">file</a> |
<a href="/comm-central/annotate/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3PasswordFailure.js">annotate</a> |
<a href="/comm-central/diff/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3PasswordFailure.js">diff</a> |
<a href="/comm-central/comparison/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3PasswordFailure.js">comparison</a> |
<a href="/comm-central/log/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3PasswordFailure.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3PasswordFailure2.js">mailnews/local/test/unit/test_pop3PasswordFailure2.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3PasswordFailure2.js">file</a> |
<a href="/comm-central/annotate/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3PasswordFailure2.js">annotate</a> |
<a href="/comm-central/diff/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3PasswordFailure2.js">diff</a> |
<a href="/comm-central/comparison/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3PasswordFailure2.js">comparison</a> |
<a href="/comm-central/log/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3PasswordFailure2.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3PasswordFailure3.js">mailnews/local/test/unit/test_pop3PasswordFailure3.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3PasswordFailure3.js">file</a> |
<a href="/comm-central/annotate/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3PasswordFailure3.js">annotate</a> |
<a href="/comm-central/diff/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3PasswordFailure3.js">diff</a> |
<a href="/comm-central/comparison/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3PasswordFailure3.js">comparison</a> |
<a href="/comm-central/log/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3PasswordFailure3.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3Proxy.js">mailnews/local/test/unit/test_pop3Proxy.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3Proxy.js">file</a> |
<a href="/comm-central/annotate/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3Proxy.js">annotate</a> |
<a href="/comm-central/diff/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3Proxy.js">diff</a> |
<a href="/comm-central/comparison/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3Proxy.js">comparison</a> |
<a href="/comm-central/log/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3Proxy.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3Pump.js">mailnews/local/test/unit/test_pop3Pump.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3Pump.js">file</a> |
<a href="/comm-central/annotate/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3Pump.js">annotate</a> |
<a href="/comm-central/diff/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3Pump.js">diff</a> |
<a href="/comm-central/comparison/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3Pump.js">comparison</a> |
<a href="/comm-central/log/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3Pump.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3ServerBrokenCRAMDisconnect.js">mailnews/local/test/unit/test_pop3ServerBrokenCRAMDisconnect.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3ServerBrokenCRAMDisconnect.js">file</a> |
<a href="/comm-central/annotate/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3ServerBrokenCRAMDisconnect.js">annotate</a> |
<a href="/comm-central/diff/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3ServerBrokenCRAMDisconnect.js">diff</a> |
<a href="/comm-central/comparison/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3ServerBrokenCRAMDisconnect.js">comparison</a> |
<a href="/comm-central/log/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3ServerBrokenCRAMDisconnect.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3ServerBrokenCRAMFail.js">mailnews/local/test/unit/test_pop3ServerBrokenCRAMFail.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3ServerBrokenCRAMFail.js">file</a> |
<a href="/comm-central/annotate/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3ServerBrokenCRAMFail.js">annotate</a> |
<a href="/comm-central/diff/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3ServerBrokenCRAMFail.js">diff</a> |
<a href="/comm-central/comparison/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3ServerBrokenCRAMFail.js">comparison</a> |
<a href="/comm-central/log/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_pop3ServerBrokenCRAMFail.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_preview.js">mailnews/local/test/unit/test_preview.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_preview.js">file</a> |
<a href="/comm-central/annotate/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_preview.js">annotate</a> |
<a href="/comm-central/diff/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_preview.js">diff</a> |
<a href="/comm-central/comparison/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_preview.js">comparison</a> |
<a href="/comm-central/log/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_preview.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_saveMessage.js">mailnews/local/test/unit/test_saveMessage.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_saveMessage.js">file</a> |
<a href="/comm-central/annotate/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_saveMessage.js">annotate</a> |
<a href="/comm-central/diff/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_saveMessage.js">diff</a> |
<a href="/comm-central/comparison/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_saveMessage.js">comparison</a> |
<a href="/comm-central/log/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_saveMessage.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_streamHeaders.js">mailnews/local/test/unit/test_streamHeaders.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_streamHeaders.js">file</a> |
<a href="/comm-central/annotate/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_streamHeaders.js">annotate</a> |
<a href="/comm-central/diff/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_streamHeaders.js">diff</a> |
<a href="/comm-central/comparison/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_streamHeaders.js">comparison</a> |
<a href="/comm-central/log/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_streamHeaders.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_undoDelete.js">mailnews/local/test/unit/test_undoDelete.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_undoDelete.js">file</a> |
<a href="/comm-central/annotate/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_undoDelete.js">annotate</a> |
<a href="/comm-central/diff/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_undoDelete.js">diff</a> |
<a href="/comm-central/comparison/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_undoDelete.js">comparison</a> |
<a href="/comm-central/log/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_undoDelete.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_verifyLogon.js">mailnews/local/test/unit/test_verifyLogon.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_verifyLogon.js">file</a> |
<a href="/comm-central/annotate/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_verifyLogon.js">annotate</a> |
<a href="/comm-central/diff/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_verifyLogon.js">diff</a> |
<a href="/comm-central/comparison/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_verifyLogon.js">comparison</a> |
<a href="/comm-central/log/5753ad5a95c90434a62b55f3a12a3a2612e0d364/mailnews/local/test/unit/test_verifyLogon.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/.eslintignore</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/.eslintignore</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -32,18 +32,16 @@ mailnews/addrbook/*</span>
<a href="#l1.4"></a><span id="l1.4"> mailnews/base/*</span>
<a href="#l1.5"></a><span id="l1.5"> mailnews/build/*</span>
<a href="#l1.6"></a><span id="l1.6"> mailnews/compose/*</span>
<a href="#l1.7"></a><span id="l1.7"> mailnews/db/*</span>
<a href="#l1.8"></a><span id="l1.8"> mailnews/imap/*</span>
<a href="#l1.9"></a><span id="l1.9"> mailnews/import/*</span>
<a href="#l1.10"></a><span id="l1.10"> mailnews/intl/*</span>
<a href="#l1.11"></a><span id="l1.11"> mailnews/jsaccount/*</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-mailnews/local/*</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-mailnews/mapi/*</span>
<a href="#l1.14"></a><span id="l1.14"> mailnews/mime/*</span>
<a href="#l1.15"></a><span id="l1.15"> mailnews/test/*</span>
<a href="#l1.16"></a><span id="l1.16"> </span>
<a href="#l1.17"></a><span id="l1.17"> # mailnews/extensions exclusions</span>
<a href="#l1.18"></a><span id="l1.18"> mailnews/extensions/*</span>
<a href="#l1.19"></a><span id="l1.19"> !mailnews/extensions/newsblog</span>
<a href="#l1.20"></a><span id="l1.20"> </span>
<a href="#l1.21"></a><span id="l1.21"> # mail exclusions</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1">new file mode 100644</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineminus">--- /dev/null</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineplus">+++ b/mailnews/local/test/unit/.eslintrc.js</span>
<a href="#l2.4"></a><span id="l2.4" class="difflineat">@@ -0,0 +1,14 @@</span>
<a href="#l2.5"></a><span id="l2.5" class="difflineplus">+&quot;use strict&quot;;</span>
<a href="#l2.6"></a><span id="l2.6" class="difflineplus">+</span>
<a href="#l2.7"></a><span id="l2.7" class="difflineplus">+module.exports = {</span>
<a href="#l2.8"></a><span id="l2.8" class="difflineplus">+  &quot;extends&quot;: &quot;plugin:mozilla/xpcshell-test&quot;,</span>
<a href="#l2.9"></a><span id="l2.9" class="difflineplus">+</span>
<a href="#l2.10"></a><span id="l2.10" class="difflineplus">+  &quot;rules&quot;: {</span>
<a href="#l2.11"></a><span id="l2.11" class="difflineplus">+    &quot;func-names&quot;: &quot;off&quot;,</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+    &quot;mozilla/import-headjs-globals&quot;: &quot;error&quot;,</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+    &quot;no-unused-vars&quot;: [&quot;error&quot;, {</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+      &quot;args&quot;: &quot;none&quot;,</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+      &quot;vars&quot;: &quot;all&quot;,</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+    }],</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineplus">+  },</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/local/test/unit/head_maillocal.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/local/test/unit/head_maillocal.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -1,32 +1,33 @@</span>
<a href="#l3.4"></a><span id="l3.4"> ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l3.5"></a><span id="l3.5"> ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l3.6"></a><span id="l3.6"> ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l3.7"></a><span id="l3.7"> ChromeUtils.import(&quot;resource://testing-common/mailnews/mailTestUtils.js&quot;);</span>
<a href="#l3.8"></a><span id="l3.8"> ChromeUtils.import(&quot;resource://testing-common/mailnews/localAccountUtils.js&quot;);</span>
<a href="#l3.9"></a><span id="l3.9"> </span>
<a href="#l3.10"></a><span id="l3.10" class="difflineminus">-var CC = Components.Constructor;</span>
<a href="#l3.11"></a><span id="l3.11" class="difflineplus">+var test = null;</span>
<a href="#l3.12"></a><span id="l3.12"> </span>
<a href="#l3.13"></a><span id="l3.13"> // WebApps.jsm called by ProxyAutoConfig (PAC) requires a valid nsIXULAppInfo.</span>
<a href="#l3.14"></a><span id="l3.14"> ChromeUtils.import(&quot;resource://testing-common/AppInfo.jsm&quot;);</span>
<a href="#l3.15"></a><span id="l3.15"> updateAppInfo();</span>
<a href="#l3.16"></a><span id="l3.16"> </span>
<a href="#l3.17"></a><span id="l3.17"> // Ensure the profile directory is set up</span>
<a href="#l3.18"></a><span id="l3.18"> do_get_profile();</span>
<a href="#l3.19"></a><span id="l3.19"> </span>
<a href="#l3.20"></a><span id="l3.20"> var gDEPTH = &quot;../../../../&quot;;</span>
<a href="#l3.21"></a><span id="l3.21"> </span>
<a href="#l3.22"></a><span id="l3.22"> // Import the pop3 server scripts</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineplus">+/* import-globals-from ../../../test/fakeserver/maild.js */</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineplus">+/* import-globals-from ../../../test/fakeserver/auth.js */</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineplus">+/* import-globals-from ../../../test/fakeserver/pop3d.js */</span>
<a href="#l3.26"></a><span id="l3.26"> ChromeUtils.import(&quot;resource://testing-common/mailnews/maild.js&quot;);</span>
<a href="#l3.27"></a><span id="l3.27"> ChromeUtils.import(&quot;resource://testing-common/mailnews/auth.js&quot;);</span>
<a href="#l3.28"></a><span id="l3.28"> ChromeUtils.import(&quot;resource://testing-common/mailnews/pop3d.js&quot;);</span>
<a href="#l3.29"></a><span id="l3.29"> </span>
<a href="#l3.30"></a><span id="l3.30" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineminus">-</span>
<a href="#l3.32"></a><span id="l3.32"> // Setup the daemon and server</span>
<a href="#l3.33"></a><span id="l3.33"> // If the debugOption is set, then it will be applied to the server.</span>
<a href="#l3.34"></a><span id="l3.34"> function setupServerDaemon(debugOption) {</span>
<a href="#l3.35"></a><span id="l3.35">   var daemon = new pop3Daemon();</span>
<a href="#l3.36"></a><span id="l3.36">   var extraProps = {};</span>
<a href="#l3.37"></a><span id="l3.37">   function createHandler(d) {</span>
<a href="#l3.38"></a><span id="l3.38">     var handler = new POP3_RFC5034_handler(d);</span>
<a href="#l3.39"></a><span id="l3.39">     for (var prop in extraProps) {</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineat">@@ -35,44 +36,43 @@ function setupServerDaemon(debugOption) </span>
<a href="#l3.41"></a><span id="l3.41">     return handler;</span>
<a href="#l3.42"></a><span id="l3.42">   }</span>
<a href="#l3.43"></a><span id="l3.43">   var server = new nsMailServer(createHandler, daemon);</span>
<a href="#l3.44"></a><span id="l3.44">   if (debugOption)</span>
<a href="#l3.45"></a><span id="l3.45">     server.setDebugLevel(debugOption);</span>
<a href="#l3.46"></a><span id="l3.46">   return [daemon, server, extraProps];</span>
<a href="#l3.47"></a><span id="l3.47"> }</span>
<a href="#l3.48"></a><span id="l3.48"> </span>
<a href="#l3.49"></a><span id="l3.49" class="difflineminus">-function createPop3ServerAndLocalFolders(port, hostname=&quot;localhost&quot;) {</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineplus">+function createPop3ServerAndLocalFolders(port, hostname = &quot;localhost&quot;) {</span>
<a href="#l3.51"></a><span id="l3.51">   localAccountUtils.loadLocalMailAccount();</span>
<a href="#l3.52"></a><span id="l3.52">   let server = localAccountUtils.create_incoming_server(&quot;pop3&quot;, port,</span>
<a href="#l3.53"></a><span id="l3.53">     &quot;fred&quot;, &quot;wilma&quot;, hostname);</span>
<a href="#l3.54"></a><span id="l3.54">   return server;</span>
<a href="#l3.55"></a><span id="l3.55"> }</span>
<a href="#l3.56"></a><span id="l3.56"> </span>
<a href="#l3.57"></a><span id="l3.57" class="difflineminus">-var gCopyListener =</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineminus">-{</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineplus">+var gCopyListener = {</span>
<a href="#l3.60"></a><span id="l3.60">   callbackFunction: null,</span>
<a href="#l3.61"></a><span id="l3.61">   copiedMessageHeaderKeys: [],</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineminus">-  OnStartCopy: function() {},</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineminus">-  OnProgress: function(aProgress, aProgressMax) {},</span>
<a href="#l3.64"></a><span id="l3.64" class="difflineminus">-  SetMessageKey: function(aKey) {</span>
<a href="#l3.65"></a><span id="l3.65" class="difflineplus">+  OnStartCopy() {},</span>
<a href="#l3.66"></a><span id="l3.66" class="difflineplus">+  OnProgress(aProgress, aProgressMax) {},</span>
<a href="#l3.67"></a><span id="l3.67" class="difflineplus">+  SetMessageKey(aKey) {</span>
<a href="#l3.68"></a><span id="l3.68">     try {</span>
<a href="#l3.69"></a><span id="l3.69">       this.copiedMessageHeaderKeys.push(aKey);</span>
<a href="#l3.70"></a><span id="l3.70">     } catch (ex) {</span>
<a href="#l3.71"></a><span id="l3.71">       dump(ex);</span>
<a href="#l3.72"></a><span id="l3.72">     }</span>
<a href="#l3.73"></a><span id="l3.73">   },</span>
<a href="#l3.74"></a><span id="l3.74" class="difflineminus">-  GetMessageId: function(aMessageId) {},</span>
<a href="#l3.75"></a><span id="l3.75" class="difflineminus">-  OnStopCopy: function(aStatus) {</span>
<a href="#l3.76"></a><span id="l3.76" class="difflineplus">+  GetMessageId(aMessageId) {},</span>
<a href="#l3.77"></a><span id="l3.77" class="difflineplus">+  OnStopCopy(aStatus) {</span>
<a href="#l3.78"></a><span id="l3.78">     if (this.callbackFunction) {</span>
<a href="#l3.79"></a><span id="l3.79">       mailTestUtils.do_timeout_function(0, this.callbackFunction,</span>
<a href="#l3.80"></a><span id="l3.80">                                         null,</span>
<a href="#l3.81"></a><span id="l3.81" class="difflineminus">-                                        [ this.copiedMessageHeaderKeys, aStatus ]);</span>
<a href="#l3.82"></a><span id="l3.82" class="difflineplus">+                                        [this.copiedMessageHeaderKeys, aStatus]);</span>
<a href="#l3.83"></a><span id="l3.83">     }</span>
<a href="#l3.84"></a><span id="l3.84" class="difflineminus">-  }</span>
<a href="#l3.85"></a><span id="l3.85" class="difflineplus">+  },</span>
<a href="#l3.86"></a><span id="l3.86"> };</span>
<a href="#l3.87"></a><span id="l3.87"> </span>
<a href="#l3.88"></a><span id="l3.88"> /**</span>
<a href="#l3.89"></a><span id="l3.89">  * copyFileMessageInLocalFolder</span>
<a href="#l3.90"></a><span id="l3.90">  * A utility wrapper of nsIMsgCopyService.CopyFileMessage to copy a message</span>
<a href="#l3.91"></a><span id="l3.91">  * into local inbox folder.</span>
<a href="#l3.92"></a><span id="l3.92">  *</span>
<a href="#l3.93"></a><span id="l3.93">  * @param aMessageFile     An instance of nsIFile to copy.</span>
<a href="#l3.94"></a><span id="l3.94" class="difflineat">@@ -107,17 +107,17 @@ function do_check_transaction(real, expe</span>
<a href="#l3.95"></a><span id="l3.95">   // If we don't spin the event loop before starting the next test, the readers</span>
<a href="#l3.96"></a><span id="l3.96">   // aren't expired. In this case, the &quot;real&quot; real transaction is the last one.</span>
<a href="#l3.97"></a><span id="l3.97">   if (real instanceof Array)</span>
<a href="#l3.98"></a><span id="l3.98">     real = real[real.length - 1];</span>
<a href="#l3.99"></a><span id="l3.99"> </span>
<a href="#l3.100"></a><span id="l3.100">   // real.them may have an extra QUIT on the end, where the stream is only</span>
<a href="#l3.101"></a><span id="l3.101">   // closed after we have a chance to process it and not them. We therefore</span>
<a href="#l3.102"></a><span id="l3.102">   // excise this from the list</span>
<a href="#l3.103"></a><span id="l3.103" class="difflineminus">-  if (real.them[real.them.length-1] == &quot;QUIT&quot;)</span>
<a href="#l3.104"></a><span id="l3.104" class="difflineplus">+  if (real.them[real.them.length - 1] == &quot;QUIT&quot;)</span>
<a href="#l3.105"></a><span id="l3.105">     real.them.pop();</span>
<a href="#l3.106"></a><span id="l3.106"> </span>
<a href="#l3.107"></a><span id="l3.107">   Assert.equal(real.them.join(&quot;,&quot;), expected.join(&quot;,&quot;));</span>
<a href="#l3.108"></a><span id="l3.108">   dump(&quot;Passed test &quot; + test + &quot;\n&quot;);</span>
<a href="#l3.109"></a><span id="l3.109"> }</span>
<a href="#l3.110"></a><span id="l3.110"> </span>
<a href="#l3.111"></a><span id="l3.111"> function create_temporary_directory() {</span>
<a href="#l3.112"></a><span id="l3.112">   let directory = Services.dirsvc.get(&quot;TmpD&quot;, Ci.nsIFile);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/local/test/unit/test_bug457168.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/local/test/unit/test_bug457168.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -1,57 +1,54 @@</span>
<a href="#l4.4"></a><span id="l4.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l4.5"></a><span id="l4.5"> /**</span>
<a href="#l4.6"></a><span id="l4.6">  * Protocol tests for POP3.</span>
<a href="#l4.7"></a><span id="l4.7">  */</span>
<a href="#l4.8"></a><span id="l4.8" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l4.9"></a><span id="l4.9"> </span>
<a href="#l4.10"></a><span id="l4.10" class="difflineminus">-var type = null;</span>
<a href="#l4.11"></a><span id="l4.11" class="difflineminus">-var test = null;</span>
<a href="#l4.12"></a><span id="l4.12"> var server;</span>
<a href="#l4.13"></a><span id="l4.13"> var daemon;</span>
<a href="#l4.14"></a><span id="l4.14"> var incomingServer;</span>
<a href="#l4.15"></a><span id="l4.15"> var thisTest;</span>
<a href="#l4.16"></a><span id="l4.16"> </span>
<a href="#l4.17"></a><span id="l4.17" class="difflineminus">-var tests = [</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineminus">-  { title: &quot;Get New Mail, One Message&quot;,</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineminus">-    messages: [ &quot;message2.eml&quot;, &quot;message2.eml&quot;, &quot;message3.eml&quot; ],</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineminus">-    transaction: [ &quot;AUTH&quot;, &quot;CAPA&quot;, &quot;AUTH PLAIN&quot;, &quot;STAT&quot;, &quot;LIST&quot;, &quot;UIDL&quot;,</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineminus">-                   &quot;RETR 1&quot;, &quot;DELE 1&quot;, &quot;RETR 2&quot;, &quot;DELE 2&quot;, &quot;RETR 3&quot;, &quot;DELE 3&quot; ] }</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineminus">-];</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineplus">+var tests = [{</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineplus">+  title: &quot;Get New Mail, One Message&quot;,</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineplus">+  messages: [&quot;message2.eml&quot;, &quot;message2.eml&quot;, &quot;message3.eml&quot;],</span>
<a href="#l4.26"></a><span id="l4.26" class="difflineplus">+  transaction: [</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineplus">+    &quot;AUTH&quot;, &quot;CAPA&quot;, &quot;AUTH PLAIN&quot;, &quot;STAT&quot;, &quot;LIST&quot;, &quot;UIDL&quot;,</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineplus">+    &quot;RETR 1&quot;, &quot;DELE 1&quot;, &quot;RETR 2&quot;, &quot;DELE 2&quot;, &quot;RETR 3&quot;, &quot;DELE 3&quot;,</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineplus">+  ],</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineplus">+}];</span>
<a href="#l4.31"></a><span id="l4.31"> </span>
<a href="#l4.32"></a><span id="l4.32" class="difflineminus">-var urlListener =</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineminus">-{</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineminus">-  OnStartRunningUrl: function (url) {</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineplus">+var urlListener = {</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineplus">+  OnStartRunningUrl(url) {</span>
<a href="#l4.37"></a><span id="l4.37">   },</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineminus">-  OnStopRunningUrl: function (url, result) {</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineplus">+  OnStopRunningUrl(url, result) {</span>
<a href="#l4.40"></a><span id="l4.40">     try {</span>
<a href="#l4.41"></a><span id="l4.41">       var transaction = server.playTransaction();</span>
<a href="#l4.42"></a><span id="l4.42"> </span>
<a href="#l4.43"></a><span id="l4.43">       do_check_transaction(transaction, thisTest.transaction);</span>
<a href="#l4.44"></a><span id="l4.44"> </span>
<a href="#l4.45"></a><span id="l4.45">       Assert.equal(localAccountUtils.inboxFolder.getTotalMessages(false), 2);</span>
<a href="#l4.46"></a><span id="l4.46">       Assert.equal(localAccountUtils.inboxFolder.getNumUnread(false), 1);</span>
<a href="#l4.47"></a><span id="l4.47"> </span>
<a href="#l4.48"></a><span id="l4.48">       Assert.equal(result, 0);</span>
<a href="#l4.49"></a><span id="l4.49" class="difflineminus">-    }</span>
<a href="#l4.50"></a><span id="l4.50" class="difflineminus">-    catch (e) {</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineplus">+    } catch (e) {</span>
<a href="#l4.52"></a><span id="l4.52">       // If we have an error, clean up nicely before we throw it.</span>
<a href="#l4.53"></a><span id="l4.53">       server.stop();</span>
<a href="#l4.54"></a><span id="l4.54"> </span>
<a href="#l4.55"></a><span id="l4.55">       var thread = gThreadManager.currentThread;</span>
<a href="#l4.56"></a><span id="l4.56">       while (thread.hasPendingEvents())</span>
<a href="#l4.57"></a><span id="l4.57">         thread.processNextEvent(true);</span>
<a href="#l4.58"></a><span id="l4.58"> </span>
<a href="#l4.59"></a><span id="l4.59">       do_throw(e);</span>
<a href="#l4.60"></a><span id="l4.60">     }</span>
<a href="#l4.61"></a><span id="l4.61"> </span>
<a href="#l4.62"></a><span id="l4.62">     // Let OnStopRunningUrl return cleanly before doing anything else.</span>
<a href="#l4.63"></a><span id="l4.63">     do_timeout(0, checkBusy);</span>
<a href="#l4.64"></a><span id="l4.64" class="difflineminus">-  }</span>
<a href="#l4.65"></a><span id="l4.65" class="difflineplus">+  },</span>
<a href="#l4.66"></a><span id="l4.66"> };</span>
<a href="#l4.67"></a><span id="l4.67"> </span>
<a href="#l4.68"></a><span id="l4.68"> function checkBusy() {</span>
<a href="#l4.69"></a><span id="l4.69">   if (tests.length == 0) {</span>
<a href="#l4.70"></a><span id="l4.70">     incomingServer.closeCachedConnections();</span>
<a href="#l4.71"></a><span id="l4.71"> </span>
<a href="#l4.72"></a><span id="l4.72">     // No more tests, let everything finish</span>
<a href="#l4.73"></a><span id="l4.73">     server.stop();</span>
<a href="#l4.74"></a><span id="l4.74" class="difflineat">@@ -112,18 +109,16 @@ function run_test() {</span>
<a href="#l4.75"></a><span id="l4.75">   Services.prefs.setBoolPref(&quot;mail.biff.animate_dock_icon&quot;, false);</span>
<a href="#l4.76"></a><span id="l4.76">   Services.prefs.setIntPref(&quot;mail.server.default.dup_action&quot;, 2);</span>
<a href="#l4.77"></a><span id="l4.77"> </span>
<a href="#l4.78"></a><span id="l4.78">   server = setupServerDaemon();</span>
<a href="#l4.79"></a><span id="l4.79">   daemon = server[0];</span>
<a href="#l4.80"></a><span id="l4.80">   server = server[1];</span>
<a href="#l4.81"></a><span id="l4.81">   server.start();</span>
<a href="#l4.82"></a><span id="l4.82"> </span>
<a href="#l4.83"></a><span id="l4.83" class="difflineminus">-  type = &quot;RFC 1939&quot;;</span>
<a href="#l4.84"></a><span id="l4.84" class="difflineminus">-</span>
<a href="#l4.85"></a><span id="l4.85">   // Set up the basic accounts and folders</span>
<a href="#l4.86"></a><span id="l4.86">   incomingServer = createPop3ServerAndLocalFolders(server.port);</span>
<a href="#l4.87"></a><span id="l4.87"> </span>
<a href="#l4.88"></a><span id="l4.88">   // Create a cc filter</span>
<a href="#l4.89"></a><span id="l4.89">   var filters = incomingServer.getFilterList(null);</span>
<a href="#l4.90"></a><span id="l4.90"> </span>
<a href="#l4.91"></a><span id="l4.91">   var filter = filters.createFilter(&quot;cc dup test&quot;);</span>
<a href="#l4.92"></a><span id="l4.92">   filter.filterType = Ci.nsMsgFilterType.Incoming;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/local/test/unit/test_duplicateKey.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/local/test/unit/test_duplicateKey.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -1,16 +1,17 @@</span>
<a href="#l5.4"></a><span id="l5.4"> /* Any copyright is dedicated to the Public Domain.</span>
<a href="#l5.5"></a><span id="l5.5">  * http://creativecommons.org/publicdomain/zero/1.0/ */</span>
<a href="#l5.6"></a><span id="l5.6"> </span>
<a href="#l5.7"></a><span id="l5.7"> /**</span>
<a href="#l5.8"></a><span id="l5.8">  * This test deletes intermediate messages, then compacts, then adds more</span>
<a href="#l5.9"></a><span id="l5.9">  * messages, testing for duplicated keys in bug 1202105.</span>
<a href="#l5.10"></a><span id="l5.10">  */</span>
<a href="#l5.11"></a><span id="l5.11"> </span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+/* import-globals-from ../../../test/resources/POP3pump.js */</span>
<a href="#l5.13"></a><span id="l5.13"> load(&quot;../../../resources/POP3pump.js&quot;);</span>
<a href="#l5.14"></a><span id="l5.14"> ChromeUtils.import(&quot;resource://testing-common/mailnews/PromiseTestUtils.jsm&quot;);</span>
<a href="#l5.15"></a><span id="l5.15"> </span>
<a href="#l5.16"></a><span id="l5.16"> add_task(async function runPump() {</span>
<a href="#l5.17"></a><span id="l5.17"> </span>
<a href="#l5.18"></a><span id="l5.18">   gPOP3Pump.files = [&quot;../../../data/bugmail1&quot;,</span>
<a href="#l5.19"></a><span id="l5.19">                      &quot;../../../data/bugmail1&quot;,</span>
<a href="#l5.20"></a><span id="l5.20">                      &quot;../../../data/bugmail1&quot;,</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineat">@@ -26,21 +27,21 @@ add_task(async function runPump() {</span>
<a href="#l5.22"></a><span id="l5.22">   let deletes = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span>
<a href="#l5.23"></a><span id="l5.23">   deletes.appendElement(hdrs[1]);</span>
<a href="#l5.24"></a><span id="l5.24">   deletes.appendElement(hdrs[2]);</span>
<a href="#l5.25"></a><span id="l5.25"> </span>
<a href="#l5.26"></a><span id="l5.26">   // Note the listener won't work because this is a sync delete,</span>
<a href="#l5.27"></a><span id="l5.27">   // but it should!</span>
<a href="#l5.28"></a><span id="l5.28">   localAccountUtils.inboxFolder</span>
<a href="#l5.29"></a><span id="l5.29">                    .deleteMessages(deletes, // in nsIArray messages,</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineminus">-                                   null, //in nsIMsgWindow msgWindow,</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineplus">+                                   null, // in nsIMsgWindow msgWindow,</span>
<a href="#l5.32"></a><span id="l5.32">                                    true, // in boolean deleteStorage,</span>
<a href="#l5.33"></a><span id="l5.33">                                    true, // in boolean isMove,</span>
<a href="#l5.34"></a><span id="l5.34">                                    null, // in nsIMsgCopyServiceListener,</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineminus">-                                   false); //in boolean allowUndo</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineplus">+                                   false); // in boolean allowUndo</span>
<a href="#l5.37"></a><span id="l5.37"> </span>
<a href="#l5.38"></a><span id="l5.38">   dump(&quot;Messages after delete\n&quot;);</span>
<a href="#l5.39"></a><span id="l5.39">   hdrs = showMessages(localAccountUtils.inboxFolder);</span>
<a href="#l5.40"></a><span id="l5.40">   Assert.equal(hdrs.length, 3, &quot;Check db length after deleting two messages&quot;);</span>
<a href="#l5.41"></a><span id="l5.41"> </span>
<a href="#l5.42"></a><span id="l5.42">   // compact</span>
<a href="#l5.43"></a><span id="l5.43">   var listener = new PromiseTestUtils.PromiseUrlListener();</span>
<a href="#l5.44"></a><span id="l5.44">   localAccountUtils.inboxFolder.compact(listener, null);</span>
<a href="#l5.45"></a><span id="l5.45" class="difflineat">@@ -57,20 +58,16 @@ add_task(async function runPump() {</span>
<a href="#l5.46"></a><span id="l5.46"> </span>
<a href="#l5.47"></a><span id="l5.47">   dump(&quot;Messages after new message\n&quot;);</span>
<a href="#l5.48"></a><span id="l5.48">   hdrs = showMessages(localAccountUtils.inboxFolder);</span>
<a href="#l5.49"></a><span id="l5.49">   Assert.equal(hdrs.length, 4, &quot;Check db length after adding one message&quot;);</span>
<a href="#l5.50"></a><span id="l5.50"> </span>
<a href="#l5.51"></a><span id="l5.51">   gPOP3Pump = null;</span>
<a href="#l5.52"></a><span id="l5.52"> });</span>
<a href="#l5.53"></a><span id="l5.53"> </span>
<a href="#l5.54"></a><span id="l5.54" class="difflineminus">-function run_test() {</span>
<a href="#l5.55"></a><span id="l5.55" class="difflineminus">-  run_next_test();</span>
<a href="#l5.56"></a><span id="l5.56" class="difflineminus">-}</span>
<a href="#l5.57"></a><span id="l5.57" class="difflineminus">-</span>
<a href="#l5.58"></a><span id="l5.58"> function showMessages(folder) {</span>
<a href="#l5.59"></a><span id="l5.59">   let enumerator = folder.msgDatabase.EnumerateMessages();</span>
<a href="#l5.60"></a><span id="l5.60">   var hdrs = [];</span>
<a href="#l5.61"></a><span id="l5.61">   while (enumerator.hasMoreElements()) {</span>
<a href="#l5.62"></a><span id="l5.62">     hdrs.push(enumerator.getNext().QueryInterface(Ci.nsIMsgDBHdr));</span>
<a href="#l5.63"></a><span id="l5.63">     dump(&quot;key &quot; + (hdrs.length - 1) + &quot; is &quot; + hdrs[hdrs.length - 1].messageKey + &quot;\n&quot;);</span>
<a href="#l5.64"></a><span id="l5.64">   }</span>
<a href="#l5.65"></a><span id="l5.65">   return hdrs;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/local/test/unit/test_fileName.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/local/test/unit/test_fileName.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -1,16 +1,13 @@</span>
<a href="#l6.4"></a><span id="l6.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l6.5"></a><span id="l6.5"> /**</span>
<a href="#l6.6"></a><span id="l6.6">  * Test handling of special chars in folder names</span>
<a href="#l6.7"></a><span id="l6.7">  */</span>
<a href="#l6.8"></a><span id="l6.8"> </span>
<a href="#l6.9"></a><span id="l6.9" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l6.10"></a><span id="l6.10" class="difflineminus">-ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l6.11"></a><span id="l6.11" class="difflineminus">-</span>
<a href="#l6.12"></a><span id="l6.12"> function run_test() {</span>
<a href="#l6.13"></a><span id="l6.13">   let testFolderName = &quot;&quot;;</span>
<a href="#l6.14"></a><span id="l6.14">   let OSname = Services.sysinfo.getProperty(&quot;name&quot;);</span>
<a href="#l6.15"></a><span id="l6.15">   if (OSname == &quot;Windows_NT&quot;) {</span>
<a href="#l6.16"></a><span id="l6.16">     // On Windows test file with ' ' in the name.</span>
<a href="#l6.17"></a><span id="l6.17">     testFolderName = &quot;bugmail 1&quot;;</span>
<a href="#l6.18"></a><span id="l6.18">   } else if (OSname == &quot;Linux&quot;) {</span>
<a href="#l6.19"></a><span id="l6.19">     // On Linux test file with '`' in the name.</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineat">@@ -62,17 +59,17 @@ function run_test() {</span>
<a href="#l6.21"></a><span id="l6.21">   Services.prefs.setCharPref(&quot;mail.server.server2.name&quot;, &quot;poptest&quot;);</span>
<a href="#l6.22"></a><span id="l6.22">   Services.prefs.setCharPref(&quot;mail.server.server2.type&quot;, &quot;pop3&quot;);</span>
<a href="#l6.23"></a><span id="l6.23">   Services.prefs.setCharPref(&quot;mail.server.server2.userName&quot;, &quot;user&quot;);</span>
<a href="#l6.24"></a><span id="l6.24">   // This basically says to ignore the time stamp in the .msf file</span>
<a href="#l6.25"></a><span id="l6.25">   Services.prefs.setIntPref(&quot;mail.db_timestamp_leeway&quot;, 0x7FFFFFFF);</span>
<a href="#l6.26"></a><span id="l6.26"> </span>
<a href="#l6.27"></a><span id="l6.27">   localAccountUtils.incomingServer = MailServices.accounts.localFoldersServer;</span>
<a href="#l6.28"></a><span id="l6.28">   // force load of accounts.</span>
<a href="#l6.29"></a><span id="l6.29" class="difflineminus">-  let defaultAccount = MailServices.accounts.defaultAccount;</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineplus">+  MailServices.accounts.defaultAccount;</span>
<a href="#l6.31"></a><span id="l6.31"> </span>
<a href="#l6.32"></a><span id="l6.32">   let pop3Server = MailServices.accounts.FindServer(&quot;user&quot;, &quot;poptest&quot;, &quot;pop3&quot;);</span>
<a href="#l6.33"></a><span id="l6.33">   let rootFolder = localAccountUtils.incomingServer.rootMsgFolder</span>
<a href="#l6.34"></a><span id="l6.34">                                     .QueryInterface(Ci.nsIMsgLocalMailFolder);</span>
<a href="#l6.35"></a><span id="l6.35">   let pop3Root = pop3Server.rootMsgFolder;</span>
<a href="#l6.36"></a><span id="l6.36"> </span>
<a href="#l6.37"></a><span id="l6.37">   // Note: Inbox is not created automatically when there is no deferred server,</span>
<a href="#l6.38"></a><span id="l6.38">   // so we need to create it.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/local/test/unit/test_folderLoaded.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/local/test/unit/test_folderLoaded.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -6,79 +6,77 @@</span>
<a href="#l7.4"></a><span id="l7.4">  *</span>
<a href="#l7.5"></a><span id="l7.5">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l7.6"></a><span id="l7.6"> </span>
<a href="#l7.7"></a><span id="l7.7">  /**</span>
<a href="#l7.8"></a><span id="l7.8">  * The intent of this file is to show a folder loaded event after a load</span>
<a href="#l7.9"></a><span id="l7.9">  * with a null database.</span>
<a href="#l7.10"></a><span id="l7.10">  *</span>
<a href="#l7.11"></a><span id="l7.11">  */</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+/* import-globals-from ../../../test/resources/logHelper.js */</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+/* import-globals-from ../../../test/resources/asyncTestUtils.js */</span>
<a href="#l7.15"></a><span id="l7.15"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l7.16"></a><span id="l7.16"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l7.17"></a><span id="l7.17"> </span>
<a href="#l7.18"></a><span id="l7.18"> var testSubjects = [&quot;[Bug 397009] A filter will let me tag, but not untag&quot;,</span>
<a href="#l7.19"></a><span id="l7.19">                     &quot;Hello, did you receive my bugmail?&quot;];</span>
<a href="#l7.20"></a><span id="l7.20"> var gMsgFile1 = do_get_file(&quot;../../../data/bugmail1&quot;);</span>
<a href="#l7.21"></a><span id="l7.21"> var gMsgFile2 = do_get_file(&quot;../../../data/draft1&quot;);</span>
<a href="#l7.22"></a><span id="l7.22"> </span>
<a href="#l7.23"></a><span id="l7.23"> var gTargetFolder = null;</span>
<a href="#l7.24"></a><span id="l7.24"> </span>
<a href="#l7.25"></a><span id="l7.25"> var tests = [</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineminus">-  function* setup()</span>
<a href="#l7.27"></a><span id="l7.27" class="difflineminus">-  {</span>
<a href="#l7.28"></a><span id="l7.28" class="difflineplus">+  function* setup() {</span>
<a href="#l7.29"></a><span id="l7.29">     do_timeout(5000, function() {</span>
<a href="#l7.30"></a><span id="l7.30">       // should be done by now</span>
<a href="#l7.31"></a><span id="l7.31">       Assert.ok(false);</span>
<a href="#l7.32"></a><span id="l7.32">     });</span>
<a href="#l7.33"></a><span id="l7.33"> </span>
<a href="#l7.34"></a><span id="l7.34" class="difflineminus">-    if (typeof localAccountUtils.inboxFolder == 'undefined')</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineplus">+    if (typeof localAccountUtils.inboxFolder == &quot;undefined&quot;)</span>
<a href="#l7.36"></a><span id="l7.36">       localAccountUtils.loadLocalMailAccount();</span>
<a href="#l7.37"></a><span id="l7.37">     localAccountUtils.rootFolder.createSubfolder(&quot;target&quot;, null);</span>
<a href="#l7.38"></a><span id="l7.38">     gTargetFolder = localAccountUtils.rootFolder.getChildNamed(&quot;target&quot;);</span>
<a href="#l7.39"></a><span id="l7.39"> </span>
<a href="#l7.40"></a><span id="l7.40">     MailServices.copy.CopyFileMessage(gMsgFile1, gTargetFolder, null, false, 0,</span>
<a href="#l7.41"></a><span id="l7.41">                                       &quot;&quot;, asyncCopyListener, null);</span>
<a href="#l7.42"></a><span id="l7.42">     yield false;</span>
<a href="#l7.43"></a><span id="l7.43"> </span>
<a href="#l7.44"></a><span id="l7.44">     MailServices.copy.CopyFileMessage(gMsgFile2, gTargetFolder, null, false, 0,</span>
<a href="#l7.45"></a><span id="l7.45">                                       &quot;&quot;, asyncCopyListener, null);</span>
<a href="#l7.46"></a><span id="l7.46">     yield false;</span>
<a href="#l7.47"></a><span id="l7.47"> </span>
<a href="#l7.48"></a><span id="l7.48">   },</span>
<a href="#l7.49"></a><span id="l7.49"> </span>
<a href="#l7.50"></a><span id="l7.50" class="difflineminus">-  function* firstUpdate()</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineminus">-  {</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineplus">+  function* firstUpdate() {</span>
<a href="#l7.53"></a><span id="l7.53">     // get message headers for the target folder</span>
<a href="#l7.54"></a><span id="l7.54">     let enumerator = gTargetFolder.msgDatabase.EnumerateMessages();</span>
<a href="#l7.55"></a><span id="l7.55">     var msgCount = 0;</span>
<a href="#l7.56"></a><span id="l7.56" class="difflineminus">-    while(enumerator.hasMoreElements())</span>
<a href="#l7.57"></a><span id="l7.57" class="difflineminus">-    {</span>
<a href="#l7.58"></a><span id="l7.58" class="difflineplus">+    while (enumerator.hasMoreElements()) {</span>
<a href="#l7.59"></a><span id="l7.59">       msgCount++;</span>
<a href="#l7.60"></a><span id="l7.60">       let hdr = enumerator.getNext().QueryInterface(Ci.nsIMsgDBHdr);</span>
<a href="#l7.61"></a><span id="l7.61">       Assert.equal(hdr.subject, testSubjects[msgCount - 1]);</span>
<a href="#l7.62"></a><span id="l7.62">     }</span>
<a href="#l7.63"></a><span id="l7.63">     Assert.equal(msgCount, 2);</span>
<a href="#l7.64"></a><span id="l7.64"> </span>
<a href="#l7.65"></a><span id="l7.65">     // try an update</span>
<a href="#l7.66"></a><span id="l7.66" class="difflineminus">-    mailTestUtils.updateFolderAndNotify(gTargetFolder, function () {</span>
<a href="#l7.67"></a><span id="l7.67" class="difflineplus">+    mailTestUtils.updateFolderAndNotify(gTargetFolder, function() {</span>
<a href="#l7.68"></a><span id="l7.68">       dump(&quot;after FolderLoaded1\n&quot;);</span>
<a href="#l7.69"></a><span id="l7.69">       async_driver();</span>
<a href="#l7.70"></a><span id="l7.70">     });</span>
<a href="#l7.71"></a><span id="l7.71">     yield false;</span>
<a href="#l7.72"></a><span id="l7.72">   },</span>
<a href="#l7.73"></a><span id="l7.73"> </span>
<a href="#l7.74"></a><span id="l7.74" class="difflineminus">-  function* secondUpdate()</span>
<a href="#l7.75"></a><span id="l7.75" class="difflineminus">-  {</span>
<a href="#l7.76"></a><span id="l7.76" class="difflineplus">+  function* secondUpdate() {</span>
<a href="#l7.77"></a><span id="l7.77">     // If the following executes, the test hangs in bug 787557.</span>
<a href="#l7.78"></a><span id="l7.78">     gTargetFolder.msgDatabase = null;</span>
<a href="#l7.79"></a><span id="l7.79">     // try an update</span>
<a href="#l7.80"></a><span id="l7.80" class="difflineminus">-    mailTestUtils.updateFolderAndNotify(gTargetFolder, function () {</span>
<a href="#l7.81"></a><span id="l7.81" class="difflineplus">+    mailTestUtils.updateFolderAndNotify(gTargetFolder, function() {</span>
<a href="#l7.82"></a><span id="l7.82">       dump(&quot;after FolderLoaded2\n&quot;);</span>
<a href="#l7.83"></a><span id="l7.83">       async_driver();</span>
<a href="#l7.84"></a><span id="l7.84">     });</span>
<a href="#l7.85"></a><span id="l7.85">     yield false;</span>
<a href="#l7.86"></a><span id="l7.86">   },</span>
<a href="#l7.87"></a><span id="l7.87" class="difflineminus">-</span>
<a href="#l7.88"></a><span id="l7.88"> ];</span>
<a href="#l7.89"></a><span id="l7.89"> </span>
<a href="#l7.90"></a><span id="l7.90"> function run_test() {</span>
<a href="#l7.91"></a><span id="l7.91">   async_run_tests(tests);</span>
<a href="#l7.92"></a><span id="l7.92"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/local/test/unit/test_localFolder.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/local/test/unit/test_localFolder.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -6,17 +6,17 @@</span>
<a href="#l8.4"></a><span id="l8.4">  * nsIMsgFolder.subFolders tests</span>
<a href="#l8.5"></a><span id="l8.5">  * These tests intend to test pluggableStore.discoverSubFolders</span>
<a href="#l8.6"></a><span id="l8.6">  * and nsIMsgFolder.hasSubFolders.</span>
<a href="#l8.7"></a><span id="l8.7">  */</span>
<a href="#l8.8"></a><span id="l8.8"> </span>
<a href="#l8.9"></a><span id="l8.9"> // Currently we have two mailbox storage formats.</span>
<a href="#l8.10"></a><span id="l8.10"> var gPluggableStores = [</span>
<a href="#l8.11"></a><span id="l8.11">   &quot;@mozilla.org/msgstore/berkeleystore;1&quot;,</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-  &quot;@mozilla.org/msgstore/maildirstore;1&quot;</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+  &quot;@mozilla.org/msgstore/maildirstore;1&quot;,</span>
<a href="#l8.14"></a><span id="l8.14"> ];</span>
<a href="#l8.15"></a><span id="l8.15"> </span>
<a href="#l8.16"></a><span id="l8.16"> /**</span>
<a href="#l8.17"></a><span id="l8.17">  * Check whether the expected folder structure</span>
<a href="#l8.18"></a><span id="l8.18">  * exists in the root folder &quot;mailFolder&quot;.</span>
<a href="#l8.19"></a><span id="l8.19">  *</span>
<a href="#l8.20"></a><span id="l8.20">  * @param expected  array of folders and subfolders</span>
<a href="#l8.21"></a><span id="l8.21">  *                  we expect</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineat">@@ -42,39 +42,37 @@ function check_sub_folders(expected, act</span>
<a href="#l8.23"></a><span id="l8.23">       check_sub_folders(expected[index].subFolders, actualFolder.subFolders);</span>
<a href="#l8.24"></a><span id="l8.24">     }</span>
<a href="#l8.25"></a><span id="l8.25">   }</span>
<a href="#l8.26"></a><span id="l8.26"> }</span>
<a href="#l8.27"></a><span id="l8.27"> </span>
<a href="#l8.28"></a><span id="l8.28"> /**</span>
<a href="#l8.29"></a><span id="l8.29">  * Test default mailbox without creating any subfolders.</span>
<a href="#l8.30"></a><span id="l8.30">  */</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineminus">-function test_default_mailbox(expected, type)</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineminus">-{</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineplus">+function test_default_mailbox(expected, type) {</span>
<a href="#l8.34"></a><span id="l8.34">   let mailbox = setup_mailbox(type, create_temporary_directory());</span>
<a href="#l8.35"></a><span id="l8.35"> </span>
<a href="#l8.36"></a><span id="l8.36">   check_sub_folders(expected, mailbox.subFolders);</span>
<a href="#l8.37"></a><span id="l8.37"> }</span>
<a href="#l8.38"></a><span id="l8.38"> </span>
<a href="#l8.39"></a><span id="l8.39"> /**</span>
<a href="#l8.40"></a><span id="l8.40">  * A helper method to add the folders in aFolderArray</span>
<a href="#l8.41"></a><span id="l8.41">  * to the aParentFolder as subfolders.</span>
<a href="#l8.42"></a><span id="l8.42">  *</span>
<a href="#l8.43"></a><span id="l8.43">  * @param aFolderArray   array of folders and subfolders</span>
<a href="#l8.44"></a><span id="l8.44">  *                       (js objects).</span>
<a href="#l8.45"></a><span id="l8.45">  * @param aParentFolder  folder (nsIMsgFolder) to which</span>
<a href="#l8.46"></a><span id="l8.46">  *                       the folders and subfolders from</span>
<a href="#l8.47"></a><span id="l8.47">  *                       aFolderArray are to be added.</span>
<a href="#l8.48"></a><span id="l8.48">  */</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineminus">-function add_sub_folders(aFolderArray, aParentFolder)</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineminus">-{</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineplus">+function add_sub_folders(aFolderArray, aParentFolder) {</span>
<a href="#l8.52"></a><span id="l8.52">   for (let msgFolder of aFolderArray) {</span>
<a href="#l8.53"></a><span id="l8.53">     if (!aParentFolder.containsChildNamed(msgFolder.name))</span>
<a href="#l8.54"></a><span id="l8.54">       aParentFolder.createSubfolder(msgFolder.name, null);</span>
<a href="#l8.55"></a><span id="l8.55" class="difflineminus">-    if (!!msgFolder.subFolders) {</span>
<a href="#l8.56"></a><span id="l8.56" class="difflineplus">+    if (msgFolder.subFolders) {</span>
<a href="#l8.57"></a><span id="l8.57">       add_sub_folders(msgFolder.subFolders,</span>
<a href="#l8.58"></a><span id="l8.58">                       aParentFolder.getChildNamed(msgFolder.name));</span>
<a href="#l8.59"></a><span id="l8.59">     }</span>
<a href="#l8.60"></a><span id="l8.60">   }</span>
<a href="#l8.61"></a><span id="l8.61"> }</span>
<a href="#l8.62"></a><span id="l8.62"> </span>
<a href="#l8.63"></a><span id="l8.63"> </span>
<a href="#l8.64"></a><span id="l8.64"> /**</span>
<a href="#l8.65"></a><span id="l8.65" class="difflineat">@@ -92,48 +90,45 @@ function test_mailbox(expected, type) {</span>
<a href="#l8.66"></a><span id="l8.66"> }</span>
<a href="#l8.67"></a><span id="l8.67"> </span>
<a href="#l8.68"></a><span id="l8.68"> function run_all_tests() {</span>
<a href="#l8.69"></a><span id="l8.69">   test_default_mailbox([{ name: &quot;Trash&quot; }, { name: &quot;Outbox&quot; }], &quot;none&quot;);</span>
<a href="#l8.70"></a><span id="l8.70">   test_default_mailbox([{ name: &quot;Inbox&quot; }, { name: &quot;Trash&quot; }], &quot;pop3&quot;);</span>
<a href="#l8.71"></a><span id="l8.71"> </span>
<a href="#l8.72"></a><span id="l8.72">   // Assuming that the order of the folders returned from the actual folder</span>
<a href="#l8.73"></a><span id="l8.73">   // discovery is independent and un-important for this test.</span>
<a href="#l8.74"></a><span id="l8.74" class="difflineminus">-  test_mailbox([</span>
<a href="#l8.75"></a><span id="l8.75" class="difflineminus">-    {</span>
<a href="#l8.76"></a><span id="l8.76" class="difflineminus">-      name: &quot;Inbox&quot;,</span>
<a href="#l8.77"></a><span id="l8.77" class="difflineminus">-      subFolders: [ { name: &quot;sub4&quot; } ]</span>
<a href="#l8.78"></a><span id="l8.78" class="difflineminus">-    },</span>
<a href="#l8.79"></a><span id="l8.79" class="difflineminus">-    {</span>
<a href="#l8.80"></a><span id="l8.80" class="difflineminus">-      name: &quot;Trash&quot;</span>
<a href="#l8.81"></a><span id="l8.81" class="difflineminus">-    }</span>
<a href="#l8.82"></a><span id="l8.82" class="difflineminus">-  ], &quot;pop3&quot;);</span>
<a href="#l8.83"></a><span id="l8.83" class="difflineplus">+  test_mailbox([{</span>
<a href="#l8.84"></a><span id="l8.84" class="difflineplus">+    name: &quot;Inbox&quot;,</span>
<a href="#l8.85"></a><span id="l8.85" class="difflineplus">+    subFolders: [{</span>
<a href="#l8.86"></a><span id="l8.86" class="difflineplus">+      name: &quot;sub4&quot;,</span>
<a href="#l8.87"></a><span id="l8.87" class="difflineplus">+    }],</span>
<a href="#l8.88"></a><span id="l8.88" class="difflineplus">+  }, {</span>
<a href="#l8.89"></a><span id="l8.89" class="difflineplus">+    name: &quot;Trash&quot;,</span>
<a href="#l8.90"></a><span id="l8.90" class="difflineplus">+  }], &quot;pop3&quot;);</span>
<a href="#l8.91"></a><span id="l8.91"> </span>
<a href="#l8.92"></a><span id="l8.92" class="difflineminus">-  test_mailbox([</span>
<a href="#l8.93"></a><span id="l8.93" class="difflineminus">-    {</span>
<a href="#l8.94"></a><span id="l8.94" class="difflineminus">-      name: &quot;Inbox&quot;,</span>
<a href="#l8.95"></a><span id="l8.95" class="difflineminus">-      subFolders: [</span>
<a href="#l8.96"></a><span id="l8.96" class="difflineminus">-        { name: &quot;inbox-sub1&quot;,</span>
<a href="#l8.97"></a><span id="l8.97" class="difflineminus">-          subFolders: [ { name: &quot;inbox-sub-sub1&quot; },</span>
<a href="#l8.98"></a><span id="l8.98" class="difflineminus">-                        { name: &quot;inbox-sub-sub2&quot; }</span>
<a href="#l8.99"></a><span id="l8.99" class="difflineminus">-                      ]</span>
<a href="#l8.100"></a><span id="l8.100" class="difflineminus">-        },</span>
<a href="#l8.101"></a><span id="l8.101" class="difflineminus">-        { name: &quot;inbox-sub2&quot; }</span>
<a href="#l8.102"></a><span id="l8.102" class="difflineminus">-      ]</span>
<a href="#l8.103"></a><span id="l8.103" class="difflineminus">-    },</span>
<a href="#l8.104"></a><span id="l8.104" class="difflineminus">-    {</span>
<a href="#l8.105"></a><span id="l8.105" class="difflineminus">-      name: &quot;Trash&quot;</span>
<a href="#l8.106"></a><span id="l8.106" class="difflineminus">-    },</span>
<a href="#l8.107"></a><span id="l8.107" class="difflineminus">-    {</span>
<a href="#l8.108"></a><span id="l8.108" class="difflineminus">-      name: &quot;Outbox&quot;,</span>
<a href="#l8.109"></a><span id="l8.109" class="difflineminus">-      subFolders: [</span>
<a href="#l8.110"></a><span id="l8.110" class="difflineminus">-        { name: &quot;outbox-sub1&quot; }</span>
<a href="#l8.111"></a><span id="l8.111" class="difflineminus">-      ]</span>
<a href="#l8.112"></a><span id="l8.112" class="difflineminus">-    }</span>
<a href="#l8.113"></a><span id="l8.113" class="difflineminus">-  ], &quot;pop3&quot;);</span>
<a href="#l8.114"></a><span id="l8.114" class="difflineplus">+  test_mailbox([{</span>
<a href="#l8.115"></a><span id="l8.115" class="difflineplus">+    name: &quot;Inbox&quot;,</span>
<a href="#l8.116"></a><span id="l8.116" class="difflineplus">+    subFolders: [{</span>
<a href="#l8.117"></a><span id="l8.117" class="difflineplus">+      name: &quot;inbox-sub1&quot;,</span>
<a href="#l8.118"></a><span id="l8.118" class="difflineplus">+      subFolders: [{</span>
<a href="#l8.119"></a><span id="l8.119" class="difflineplus">+        name: &quot;inbox-sub-sub1&quot;,</span>
<a href="#l8.120"></a><span id="l8.120" class="difflineplus">+      }, {</span>
<a href="#l8.121"></a><span id="l8.121" class="difflineplus">+        name: &quot;inbox-sub-sub2&quot;,</span>
<a href="#l8.122"></a><span id="l8.122" class="difflineplus">+      }],</span>
<a href="#l8.123"></a><span id="l8.123" class="difflineplus">+    }, {</span>
<a href="#l8.124"></a><span id="l8.124" class="difflineplus">+      name: &quot;inbox-sub2&quot;,</span>
<a href="#l8.125"></a><span id="l8.125" class="difflineplus">+    }],</span>
<a href="#l8.126"></a><span id="l8.126" class="difflineplus">+  }, {</span>
<a href="#l8.127"></a><span id="l8.127" class="difflineplus">+    name: &quot;Trash&quot;,</span>
<a href="#l8.128"></a><span id="l8.128" class="difflineplus">+  }, {</span>
<a href="#l8.129"></a><span id="l8.129" class="difflineplus">+    name: &quot;Outbox&quot;,</span>
<a href="#l8.130"></a><span id="l8.130" class="difflineplus">+    subFolders: [{</span>
<a href="#l8.131"></a><span id="l8.131" class="difflineplus">+      name: &quot;outbox-sub1&quot;,</span>
<a href="#l8.132"></a><span id="l8.132" class="difflineplus">+    }],</span>
<a href="#l8.133"></a><span id="l8.133" class="difflineplus">+  }], &quot;pop3&quot;);</span>
<a href="#l8.134"></a><span id="l8.134"> }</span>
<a href="#l8.135"></a><span id="l8.135"> </span>
<a href="#l8.136"></a><span id="l8.136"> function run_test() {</span>
<a href="#l8.137"></a><span id="l8.137">   for (let store in gPluggableStores) {</span>
<a href="#l8.138"></a><span id="l8.138">     Services.prefs.setCharPref(&quot;mail.serverDefaultStoreContractID&quot;,</span>
<a href="#l8.139"></a><span id="l8.139">                                gPluggableStores[store]);</span>
<a href="#l8.140"></a><span id="l8.140">     run_all_tests();</span>
<a href="#l8.141"></a><span id="l8.141">   }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/local/test/unit/test_mailboxContentLength.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/local/test/unit/test_mailboxContentLength.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -9,24 +9,22 @@</span>
<a href="#l9.4"></a><span id="l9.4"> /*</span>
<a href="#l9.5"></a><span id="l9.5">  * Test content length for the mailbox protocol. This focuses on necko URLs</span>
<a href="#l9.6"></a><span id="l9.6">  * that are run externally.</span>
<a href="#l9.7"></a><span id="l9.7">  */</span>
<a href="#l9.8"></a><span id="l9.8"> </span>
<a href="#l9.9"></a><span id="l9.9"> // Take a multipart message as we're testing attachment URLs as well</span>
<a href="#l9.10"></a><span id="l9.10"> var gFile = do_get_file(&quot;../../../data/multipart-complex2&quot;);</span>
<a href="#l9.11"></a><span id="l9.11"> </span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-function run_test()</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineminus">-{</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineplus">+function run_test() {</span>
<a href="#l9.15"></a><span id="l9.15">   do_test_pending();</span>
<a href="#l9.16"></a><span id="l9.16">   copyFileMessageInLocalFolder(gFile, 0, &quot;&quot;, null, verifyContentLength);</span>
<a href="#l9.17"></a><span id="l9.17"> }</span>
<a href="#l9.18"></a><span id="l9.18"> </span>
<a href="#l9.19"></a><span id="l9.19" class="difflineminus">-function verifyContentLength(aMessageHeaderKeys, aStatus)</span>
<a href="#l9.20"></a><span id="l9.20" class="difflineminus">-{</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineplus">+function verifyContentLength(aMessageHeaderKeys, aStatus) {</span>
<a href="#l9.22"></a><span id="l9.22">   Assert.notEqual(aMessageHeaderKeys, null);</span>
<a href="#l9.23"></a><span id="l9.23">   // First get the message URI</span>
<a href="#l9.24"></a><span id="l9.24">   let msgHdr = localAccountUtils.inboxFolder.GetMessageHeader(aMessageHeaderKeys[0]);</span>
<a href="#l9.25"></a><span id="l9.25">   let messageUri = localAccountUtils.inboxFolder.getUriForMsg(msgHdr);</span>
<a href="#l9.26"></a><span id="l9.26">   // Convert this to a URI that necko can run</span>
<a href="#l9.27"></a><span id="l9.27">   let messenger = Cc[&quot;@mozilla.org/messenger;1&quot;].createInstance(Ci.nsIMessenger);</span>
<a href="#l9.28"></a><span id="l9.28">   let neckoURL = {};</span>
<a href="#l9.29"></a><span id="l9.29">   let messageService = messenger.messageServiceFromURI(messageUri);</span>
<a href="#l9.30"></a><span id="l9.30" class="difflineat">@@ -41,20 +39,20 @@ function verifyContentLength(aMessageHea</span>
<a href="#l9.31"></a><span id="l9.31">                                                Services.scriptSecurityManager.getSystemPrincipal(),</span>
<a href="#l9.32"></a><span id="l9.32">                                                null,</span>
<a href="#l9.33"></a><span id="l9.33">                                                Ci.nsILoadInfo.SEC_ALLOW_CROSS_ORIGIN_DATA_IS_NULL,</span>
<a href="#l9.34"></a><span id="l9.34">                                                Ci.nsIContentPolicy.TYPE_OTHER);</span>
<a href="#l9.35"></a><span id="l9.35">   Assert.equal(channel.contentLength, gFile.fileSize);</span>
<a href="#l9.36"></a><span id="l9.36"> </span>
<a href="#l9.37"></a><span id="l9.37">   // Now try an attachment. &amp;part=1.2</span>
<a href="#l9.38"></a><span id="l9.38">   let attachmentURL = Services.io.newURI(neckoURL.value.spec + &quot;&amp;part=1.2&quot;);</span>
<a href="#l9.39"></a><span id="l9.39" class="difflineminus">-  let attachmentChannel = Services.io.newChannelFromURI2(attachmentURL,</span>
<a href="#l9.40"></a><span id="l9.40" class="difflineminus">-                                                         null,</span>
<a href="#l9.41"></a><span id="l9.41" class="difflineminus">-                                                         Services.scriptSecurityManager.getSystemPrincipal(),</span>
<a href="#l9.42"></a><span id="l9.42" class="difflineminus">-                                                         null,</span>
<a href="#l9.43"></a><span id="l9.43" class="difflineminus">-                                                         Ci.nsILoadInfo.SEC_ALLOW_CROSS_ORIGIN_DATA_IS_NULL,</span>
<a href="#l9.44"></a><span id="l9.44" class="difflineminus">-                                                         Ci.nsIContentPolicy.TYPE_OTHER);</span>
<a href="#l9.45"></a><span id="l9.45" class="difflineplus">+  Services.io.newChannelFromURI2(attachmentURL,</span>
<a href="#l9.46"></a><span id="l9.46" class="difflineplus">+                                 null,</span>
<a href="#l9.47"></a><span id="l9.47" class="difflineplus">+                                 Services.scriptSecurityManager.getSystemPrincipal(),</span>
<a href="#l9.48"></a><span id="l9.48" class="difflineplus">+                                 null,</span>
<a href="#l9.49"></a><span id="l9.49" class="difflineplus">+                                 Ci.nsILoadInfo.SEC_ALLOW_CROSS_ORIGIN_DATA_IS_NULL,</span>
<a href="#l9.50"></a><span id="l9.50" class="difflineplus">+                                 Ci.nsIContentPolicy.TYPE_OTHER);</span>
<a href="#l9.51"></a><span id="l9.51">   // Currently attachments have their content length set to the length of the</span>
<a href="#l9.52"></a><span id="l9.52">   // entire message</span>
<a href="#l9.53"></a><span id="l9.53">   Assert.equal(channel.contentLength, gFile.fileSize);</span>
<a href="#l9.54"></a><span id="l9.54"> </span>
<a href="#l9.55"></a><span id="l9.55">   do_test_finished();</span>
<a href="#l9.56"></a><span id="l9.56"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/local/test/unit/test_mailboxProtocol.js</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/local/test/unit/test_mailboxProtocol.js</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -5,26 +5,24 @@</span>
<a href="#l10.4"></a><span id="l10.4"> </span>
<a href="#l10.5"></a><span id="l10.5"> var defaultProtocolFlags =</span>
<a href="#l10.6"></a><span id="l10.6">   Ci.nsIProtocolHandler.URI_NORELATIVE |</span>
<a href="#l10.7"></a><span id="l10.7">   Ci.nsIProtocolHandler.URI_DANGEROUS_TO_LOAD |</span>
<a href="#l10.8"></a><span id="l10.8">   Ci.nsIProtocolHandler.URI_FORBIDS_AUTOMATIC_DOCUMENT_REPLACEMENT |</span>
<a href="#l10.9"></a><span id="l10.9">   Ci.nsIProtocolHandler.URI_FORBIDS_COOKIE_ACCESS |</span>
<a href="#l10.10"></a><span id="l10.10">   Ci.nsIProtocolHandler.ORIGIN_IS_FULL_SPEC;</span>
<a href="#l10.11"></a><span id="l10.11"> </span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-var protocols =</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineminus">-  [ { protocol: &quot;mailbox&quot;,</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineminus">-      urlSpec: &quot;mailbox://user@localhost/&quot;,</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineminus">-      // mailbox protocol doesn't use a port</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineminus">-      defaultPort: -1</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineminus">-    },</span>
<a href="#l10.18"></a><span id="l10.18" class="difflineminus">-  ];</span>
<a href="#l10.19"></a><span id="l10.19" class="difflineplus">+var protocols = [{</span>
<a href="#l10.20"></a><span id="l10.20" class="difflineplus">+  protocol: &quot;mailbox&quot;,</span>
<a href="#l10.21"></a><span id="l10.21" class="difflineplus">+  urlSpec: &quot;mailbox://user@localhost/&quot;,</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineplus">+  // mailbox protocol doesn't use a port</span>
<a href="#l10.23"></a><span id="l10.23" class="difflineplus">+  defaultPort: -1,</span>
<a href="#l10.24"></a><span id="l10.24" class="difflineplus">+}];</span>
<a href="#l10.25"></a><span id="l10.25"> </span>
<a href="#l10.26"></a><span id="l10.26" class="difflineminus">-function run_test()</span>
<a href="#l10.27"></a><span id="l10.27" class="difflineminus">-{</span>
<a href="#l10.28"></a><span id="l10.28" class="difflineplus">+function run_test() {</span>
<a href="#l10.29"></a><span id="l10.29">   for (var part = 0; part &lt; protocols.length; ++part) {</span>
<a href="#l10.30"></a><span id="l10.30">     print(&quot;protocol: &quot; + protocols[part].protocol);</span>
<a href="#l10.31"></a><span id="l10.31"> </span>
<a href="#l10.32"></a><span id="l10.32">     var pH = Cc[&quot;@mozilla.org/network/protocol;1?name=&quot; +</span>
<a href="#l10.33"></a><span id="l10.33">                 protocols[part].protocol]</span>
<a href="#l10.34"></a><span id="l10.34">                .createInstance(Ci.nsIProtocolHandler);</span>
<a href="#l10.35"></a><span id="l10.35"> </span>
<a href="#l10.36"></a><span id="l10.36">     Assert.equal(pH.scheme, protocols[part].protocol);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/local/test/unit/test_movemailDownload.js</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/local/test/unit/test_movemailDownload.js</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -1,35 +1,20 @@</span>
<a href="#l11.4"></a><span id="l11.4"> /**</span>
<a href="#l11.5"></a><span id="l11.5">  * The intent of this file is to test that movemail download code</span>
<a href="#l11.6"></a><span id="l11.6">  * works correctly.</span>
<a href="#l11.7"></a><span id="l11.7">  */</span>
<a href="#l11.8"></a><span id="l11.8" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l11.9"></a><span id="l11.9" class="difflineminus">-ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l11.10"></a><span id="l11.10" class="difflineplus">+</span>
<a href="#l11.11"></a><span id="l11.11"> ChromeUtils.import(&quot;resource://testing-common/mailnews/PromiseTestUtils.jsm&quot;);</span>
<a href="#l11.12"></a><span id="l11.12"> </span>
<a href="#l11.13"></a><span id="l11.13" class="difflineminus">-var gPluggableStores = [</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineminus">-  &quot;@mozilla.org/msgstore/berkeleystore;1&quot;,</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineminus">-  &quot;@mozilla.org/msgstore/maildirstore;1&quot;</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineminus">-];</span>
<a href="#l11.17"></a><span id="l11.17" class="difflineminus">-</span>
<a href="#l11.18"></a><span id="l11.18"> var testSubjects = [&quot;[Bug 397009] A filter will let me tag, but not untag&quot;,</span>
<a href="#l11.19"></a><span id="l11.19">                     &quot;Hello, did you receive my bugmail?&quot;,</span>
<a href="#l11.20"></a><span id="l11.20">                     &quot;[Bug 655578] list-id filter broken&quot;];</span>
<a href="#l11.21"></a><span id="l11.21"> </span>
<a href="#l11.22"></a><span id="l11.22"> var gMsgHdrs = [];</span>
<a href="#l11.23"></a><span id="l11.23" class="difflineminus">-var gHdrIndex = 0;</span>
<a href="#l11.24"></a><span id="l11.24" class="difflineminus">-</span>
<a href="#l11.25"></a><span id="l11.25" class="difflineminus">-// the movemail spool dir file is these three files</span>
<a href="#l11.26"></a><span id="l11.26" class="difflineminus">-// concatenated together.</span>
<a href="#l11.27"></a><span id="l11.27" class="difflineminus">-</span>
<a href="#l11.28"></a><span id="l11.28" class="difflineminus">-var gFiles = [&quot;../../../data/bugmail1&quot;,</span>
<a href="#l11.29"></a><span id="l11.29" class="difflineminus">-              &quot;../../../data/draft1&quot;,</span>
<a href="#l11.30"></a><span id="l11.30" class="difflineminus">-              &quot;../../../data/bugmail19&quot;];</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineminus">-</span>
<a href="#l11.32"></a><span id="l11.32"> var gMoveMailInbox;</span>
<a href="#l11.33"></a><span id="l11.33"> </span>
<a href="#l11.34"></a><span id="l11.34"> function setup(storeID, aHostName) {</span>
<a href="#l11.35"></a><span id="l11.35">   return function _setup() {</span>
<a href="#l11.36"></a><span id="l11.36">     localAccountUtils.loadLocalMailAccount(storeID);</span>
<a href="#l11.37"></a><span id="l11.37">     let movemailServer =</span>
<a href="#l11.38"></a><span id="l11.38">       MailServices.accounts.createIncomingServer(&quot;&quot;, aHostName, &quot;movemail&quot;);</span>
<a href="#l11.39"></a><span id="l11.39">     let workingDir = Services.dirsvc.get(&quot;CurWorkD&quot;, Ci.nsIFile);</span>
<a href="#l11.40"></a><span id="l11.40" class="difflineat">@@ -39,53 +24,51 @@ function setup(storeID, aHostName) {</span>
<a href="#l11.41"></a><span id="l11.41">     // movemail truncates spool file, so make a copy, and use that</span>
<a href="#l11.42"></a><span id="l11.42">     workingDirFile.copyTo(null, &quot;movemailspool-copy&quot;);</span>
<a href="#l11.43"></a><span id="l11.43">     fullPath += &quot;-copy&quot;;</span>
<a href="#l11.44"></a><span id="l11.44">     dump(&quot;full path = &quot; + fullPath + &quot;\n&quot;);</span>
<a href="#l11.45"></a><span id="l11.45">     movemailServer.setCharValue(&quot;spoolDir&quot;, fullPath);</span>
<a href="#l11.46"></a><span id="l11.46">     movemailServer.QueryInterface(Ci.nsILocalMailIncomingServer);</span>
<a href="#l11.47"></a><span id="l11.47">     movemailServer.getNewMail(null, null, null);</span>
<a href="#l11.48"></a><span id="l11.48">     gMoveMailInbox = movemailServer.rootFolder.getChildNamed(&quot;INBOX&quot;);</span>
<a href="#l11.49"></a><span id="l11.49" class="difflineminus">-  }</span>
<a href="#l11.50"></a><span id="l11.50" class="difflineplus">+  };</span>
<a href="#l11.51"></a><span id="l11.51"> }</span>
<a href="#l11.52"></a><span id="l11.52"> </span>
<a href="#l11.53"></a><span id="l11.53"> var gTestArray = [</span>
<a href="#l11.54"></a><span id="l11.54">   function continueTest() {</span>
<a href="#l11.55"></a><span id="l11.55">     // Clear the gMsgHdrs array.</span>
<a href="#l11.56"></a><span id="l11.56">     gMsgHdrs = [];</span>
<a href="#l11.57"></a><span id="l11.57">     // get message headers for the inbox folder</span>
<a href="#l11.58"></a><span id="l11.58">     let enumerator = gMoveMailInbox.msgDatabase.EnumerateMessages();</span>
<a href="#l11.59"></a><span id="l11.59">     var msgCount = 0;</span>
<a href="#l11.60"></a><span id="l11.60" class="difflineminus">-    let hdr;</span>
<a href="#l11.61"></a><span id="l11.61">     while (enumerator.hasMoreElements()) {</span>
<a href="#l11.62"></a><span id="l11.62">       let hdr = enumerator.getNext().QueryInterface(Ci.nsIMsgDBHdr);</span>
<a href="#l11.63"></a><span id="l11.63">       gMsgHdrs.push(hdr);</span>
<a href="#l11.64"></a><span id="l11.64">       Assert.equal(hdr.subject, testSubjects[msgCount++]);</span>
<a href="#l11.65"></a><span id="l11.65">     }</span>
<a href="#l11.66"></a><span id="l11.66">     Assert.equal(msgCount, 3);</span>
<a href="#l11.67"></a><span id="l11.67">   },</span>
<a href="#l11.68"></a><span id="l11.68">   async function streamMessages() {</span>
<a href="#l11.69"></a><span id="l11.69">     for (let msgHdr of gMsgHdrs)</span>
<a href="#l11.70"></a><span id="l11.70">       await streamNextMessage(msgHdr);</span>
<a href="#l11.71"></a><span id="l11.71" class="difflineminus">-  }</span>
<a href="#l11.72"></a><span id="l11.72" class="difflineplus">+  },</span>
<a href="#l11.73"></a><span id="l11.73"> ];</span>
<a href="#l11.74"></a><span id="l11.74"> </span>
<a href="#l11.75"></a><span id="l11.75" class="difflineminus">-function run_test()</span>
<a href="#l11.76"></a><span id="l11.76" class="difflineminus">-{</span>
<a href="#l11.77"></a><span id="l11.77" class="difflineplus">+function run_test() {</span>
<a href="#l11.78"></a><span id="l11.78">   let hostName = &quot;movemail&quot;;</span>
<a href="#l11.79"></a><span id="l11.79">   for (let index = 0; index &lt; localAccountUtils.pluggableStores.length; index++) {</span>
<a href="#l11.80"></a><span id="l11.80">     add_task(setup(localAccountUtils.pluggableStores[index],</span>
<a href="#l11.81"></a><span id="l11.81">                    hostName + &quot;-&quot; + index));</span>
<a href="#l11.82"></a><span id="l11.82">     gTestArray.forEach(x =&gt; add_task(x));</span>
<a href="#l11.83"></a><span id="l11.83">   }</span>
<a href="#l11.84"></a><span id="l11.84"> </span>
<a href="#l11.85"></a><span id="l11.85">   run_next_test();</span>
<a href="#l11.86"></a><span id="l11.86"> }</span>
<a href="#l11.87"></a><span id="l11.87"> </span>
<a href="#l11.88"></a><span id="l11.88" class="difflineminus">-var streamNextMessage = async function (aMsgHdr) {</span>
<a href="#l11.89"></a><span id="l11.89" class="difflineplus">+var streamNextMessage = async function(aMsgHdr) {</span>
<a href="#l11.90"></a><span id="l11.90">   let messenger = Cc[&quot;@mozilla.org/messenger;1&quot;].createInstance(Ci.nsIMessenger);</span>
<a href="#l11.91"></a><span id="l11.91">   let msgURI = aMsgHdr.folder.getUriForMsg(aMsgHdr);</span>
<a href="#l11.92"></a><span id="l11.92">   dump(&quot;streaming msg &quot; + msgURI + &quot; store token = &quot; +</span>
<a href="#l11.93"></a><span id="l11.93">        aMsgHdr.getStringProperty(&quot;storeToken&quot;));</span>
<a href="#l11.94"></a><span id="l11.94">   let msgServ = messenger.messageServiceFromURI(msgURI);</span>
<a href="#l11.95"></a><span id="l11.95">   let streamListener = new PromiseTestUtils.PromiseStreamListener();</span>
<a href="#l11.96"></a><span id="l11.96">   msgServ.streamMessage(msgURI, streamListener, null, null, false, &quot;&quot;, true);</span>
<a href="#l11.97"></a><span id="l11.97">   let data = await streamListener.promise;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/local/test/unit/test_msgCopy.js</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/local/test/unit/test_msgCopy.js</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -6,18 +6,17 @@</span>
<a href="#l12.4"></a><span id="l12.4"> </span>
<a href="#l12.5"></a><span id="l12.5"> var bugmail11 = do_get_file(&quot;../../../data/bugmail11&quot;);</span>
<a href="#l12.6"></a><span id="l12.6"> </span>
<a href="#l12.7"></a><span id="l12.7"> // main test</span>
<a href="#l12.8"></a><span id="l12.8"> </span>
<a href="#l12.9"></a><span id="l12.9"> // tag used with test messages</span>
<a href="#l12.10"></a><span id="l12.10"> var tag1 = &quot;istag&quot;;</span>
<a href="#l12.11"></a><span id="l12.11"> </span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-function run_test()</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineminus">-{</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineplus">+function run_test() {</span>
<a href="#l12.15"></a><span id="l12.15">   do_test_pending();</span>
<a href="#l12.16"></a><span id="l12.16">   copyFileMessageInLocalFolder(bugmail11, 0, tag1, null, test_keywords);</span>
<a href="#l12.17"></a><span id="l12.17"> }</span>
<a href="#l12.18"></a><span id="l12.18"> </span>
<a href="#l12.19"></a><span id="l12.19"> function test_keywords(aMessageHeaderKeys, aStatus) {</span>
<a href="#l12.20"></a><span id="l12.20">   let headerKeys = aMessageHeaderKeys;</span>
<a href="#l12.21"></a><span id="l12.21">   Assert.notEqual(headerKeys, null);</span>
<a href="#l12.22"></a><span id="l12.22">   let copiedMessage = localAccountUtils.inboxFolder.GetMessageHeader(headerKeys[0]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mailnews/local/test/unit/test_msgIDParsing.js</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mailnews/local/test/unit/test_msgIDParsing.js</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -1,31 +1,22 @@</span>
<a href="#l13.4"></a><span id="l13.4"> /*</span>
<a href="#l13.5"></a><span id="l13.5">  * Test bug 676916 - nsParseMailbox parses multi-line message-id header incorrectly</span>
<a href="#l13.6"></a><span id="l13.6">  */</span>
<a href="#l13.7"></a><span id="l13.7"> </span>
<a href="#l13.8"></a><span id="l13.8" class="difflineminus">-</span>
<a href="#l13.9"></a><span id="l13.9" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l13.10"></a><span id="l13.10" class="difflineminus">-ChromeUtils.import(&quot;resource://testing-common/mailnews/localAccountUtils.js&quot;);</span>
<a href="#l13.11"></a><span id="l13.11" class="difflineminus">-</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-var gMessenger = Cc[&quot;@mozilla.org/messenger;1&quot;].</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineminus">-                   createInstance(Ci.nsIMessenger);</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineminus">-</span>
<a href="#l13.15"></a><span id="l13.15"> var headers =</span>
<a href="#l13.16"></a><span id="l13.16">   &quot;from: alice@t1.example.com\r\n&quot; +</span>
<a href="#l13.17"></a><span id="l13.17">   &quot;to: bob@t2.example.net\r\n&quot; +</span>
<a href="#l13.18"></a><span id="l13.18">   &quot;message-id:   \r\n   &lt;abcmessageid&gt;\r\n&quot;;</span>
<a href="#l13.19"></a><span id="l13.19"> </span>
<a href="#l13.20"></a><span id="l13.20" class="difflineminus">-function testMsgID()</span>
<a href="#l13.21"></a><span id="l13.21" class="difflineminus">-{</span>
<a href="#l13.22"></a><span id="l13.22" class="difflineminus">-  let localFolder = localAccountUtils.inboxFolder.QueryInterface(Ci.nsIMsgLocalMailFolder);</span>
<a href="#l13.23"></a><span id="l13.23" class="difflineminus">-  localAccountUtils.inboxFolder.addMessage(&quot;From \r\n&quot;+ headers + &quot;\r\nhello\r\n&quot;);</span>
<a href="#l13.24"></a><span id="l13.24" class="difflineplus">+function testMsgID() {</span>
<a href="#l13.25"></a><span id="l13.25" class="difflineplus">+  localAccountUtils.inboxFolder.QueryInterface(Ci.nsIMsgLocalMailFolder);</span>
<a href="#l13.26"></a><span id="l13.26" class="difflineplus">+  localAccountUtils.inboxFolder.addMessage(&quot;From \r\n&quot; + headers + &quot;\r\nhello\r\n&quot;);</span>
<a href="#l13.27"></a><span id="l13.27">   let msgHdr = localAccountUtils.inboxFolder.firstNewMessage;</span>
<a href="#l13.28"></a><span id="l13.28">   Assert.equal(msgHdr.messageId, &quot;abcmessageid&quot;);</span>
<a href="#l13.29"></a><span id="l13.29"> }</span>
<a href="#l13.30"></a><span id="l13.30"> </span>
<a href="#l13.31"></a><span id="l13.31" class="difflineminus">-function run_test()</span>
<a href="#l13.32"></a><span id="l13.32" class="difflineminus">-{</span>
<a href="#l13.33"></a><span id="l13.33" class="difflineplus">+function run_test() {</span>
<a href="#l13.34"></a><span id="l13.34">   for (let storeID of localAccountUtils.pluggableStores) {</span>
<a href="#l13.35"></a><span id="l13.35">     localAccountUtils.loadLocalMailAccount(storeID);</span>
<a href="#l13.36"></a><span id="l13.36">     testMsgID();</span>
<a href="#l13.37"></a><span id="l13.37">   }</span>
<a href="#l13.38"></a><span id="l13.38"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mailnews/local/test/unit/test_nsIMsgLocalMailFolder.js</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mailnews/local/test/unit/test_nsIMsgLocalMailFolder.js</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -1,17 +1,18 @@</span>
<a href="#l14.4"></a><span id="l14.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l14.5"></a><span id="l14.5"> /*</span>
<a href="#l14.6"></a><span id="l14.6">  * Test suite for local folder functions.</span>
<a href="#l14.7"></a><span id="l14.7">  */</span>
<a href="#l14.8"></a><span id="l14.8"> </span>
<a href="#l14.9"></a><span id="l14.9" class="difflineplus">+/* import-globals-from ../../../test/resources/messageGenerator.js */</span>
<a href="#l14.10"></a><span id="l14.10"> load(&quot;../../../resources/messageGenerator.js&quot;);</span>
<a href="#l14.11"></a><span id="l14.11"> </span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;);</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineplus">+var { toXPCOMArray } = ChromeUtils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;, null);</span>
<a href="#l14.15"></a><span id="l14.15" class="difflineplus">+</span>
<a href="#l14.16"></a><span id="l14.16"> /**</span>
<a href="#l14.17"></a><span id="l14.17">  * Bug 66763</span>
<a href="#l14.18"></a><span id="l14.18">  * Test deletion of a folder with a name already existing in Trash.</span>
<a href="#l14.19"></a><span id="l14.19">  */</span>
<a href="#l14.20"></a><span id="l14.20"> function subtest_folder_deletion(root) {</span>
<a href="#l14.21"></a><span id="l14.21">   // Now we only have &lt;root&gt; and some default subfolders, like Trash.</span>
<a href="#l14.22"></a><span id="l14.22">   let trash = root.getChildNamed(&quot;Trash&quot;);</span>
<a href="#l14.23"></a><span id="l14.23">   Assert.ok(!trash.hasSubFolders);</span>
<a href="#l14.24"></a><span id="l14.24" class="difflineat">@@ -21,33 +22,32 @@ function subtest_folder_deletion(root) {</span>
<a href="#l14.25"></a><span id="l14.25">   let path = folder.filePath;</span>
<a href="#l14.26"></a><span id="l14.26">   Assert.ok(path.exists());</span>
<a href="#l14.27"></a><span id="l14.27"> </span>
<a href="#l14.28"></a><span id="l14.28">   // Delete &quot;folder&quot; into Trash.</span>
<a href="#l14.29"></a><span id="l14.29">   let folderArray = toXPCOMArray([folder], Ci.nsIMutableArray);</span>
<a href="#l14.30"></a><span id="l14.30">   root.deleteSubFolders(folderArray, null);</span>
<a href="#l14.31"></a><span id="l14.31">   Assert.ok(!path.exists());</span>
<a href="#l14.32"></a><span id="l14.32">   Assert.equal(trash.numSubFolders, 1);</span>
<a href="#l14.33"></a><span id="l14.33" class="difflineminus">-  let folderDeleted = trash.getChildNamed(&quot;folder&quot;);</span>
<a href="#l14.34"></a><span id="l14.34" class="difflineplus">+  trash.getChildNamed(&quot;folder&quot;);</span>
<a href="#l14.35"></a><span id="l14.35"> </span>
<a href="#l14.36"></a><span id="l14.36">   // Create another &quot;folder&quot; in root.</span>
<a href="#l14.37"></a><span id="l14.37">   folder = root.createLocalSubfolder(&quot;folder&quot;);</span>
<a href="#l14.38"></a><span id="l14.38">   // Delete &quot;folder&quot; into Trash again.</span>
<a href="#l14.39"></a><span id="l14.39">   folderArray = toXPCOMArray([folder], Ci.nsIMutableArray);</span>
<a href="#l14.40"></a><span id="l14.40">   root.deleteSubFolders(folderArray, null);</span>
<a href="#l14.41"></a><span id="l14.41">   Assert.equal(trash.numSubFolders, 2);</span>
<a href="#l14.42"></a><span id="l14.42">   // The folder should be automatically renamed as the same name already is in Trash.</span>
<a href="#l14.43"></a><span id="l14.43" class="difflineminus">-  let folderDeleted2 = trash.getChildNamed(&quot;folder(2)&quot;);</span>
<a href="#l14.44"></a><span id="l14.44" class="difflineplus">+  trash.getChildNamed(&quot;folder(2)&quot;);</span>
<a href="#l14.45"></a><span id="l14.45"> </span>
<a href="#l14.46"></a><span id="l14.46">   // Create yet another &quot;folder&quot; in root.</span>
<a href="#l14.47"></a><span id="l14.47">   folder = root.createLocalSubfolder(&quot;folder&quot;);</span>
<a href="#l14.48"></a><span id="l14.48"> </span>
<a href="#l14.49"></a><span id="l14.49">   // But now with another subfolder</span>
<a href="#l14.50"></a><span id="l14.50" class="difflineminus">-  let subfolder = folder.QueryInterface(Ci.nsIMsgLocalMailFolder)</span>
<a href="#l14.51"></a><span id="l14.51" class="difflineminus">-                        .createLocalSubfolder(&quot;subfolder&quot;);</span>
<a href="#l14.52"></a><span id="l14.52" class="difflineplus">+  folder.QueryInterface(Ci.nsIMsgLocalMailFolder).createLocalSubfolder(&quot;subfolder&quot;);</span>
<a href="#l14.53"></a><span id="l14.53"> </span>
<a href="#l14.54"></a><span id="l14.54">   // Delete folder into Trash again</span>
<a href="#l14.55"></a><span id="l14.55">   folderArray = toXPCOMArray([folder], Ci.nsIMutableArray);</span>
<a href="#l14.56"></a><span id="l14.56">   root.deleteSubFolders(folderArray, null);</span>
<a href="#l14.57"></a><span id="l14.57">   Assert.equal(trash.numSubFolders, 3);</span>
<a href="#l14.58"></a><span id="l14.58">   // The folder should be automatically renamed as the same name already is in Trash</span>
<a href="#l14.59"></a><span id="l14.59">   // but the subfolder should be untouched.</span>
<a href="#l14.60"></a><span id="l14.60">   let folderDeleted3 = trash.getChildNamed(&quot;folder(3)&quot;);</span>
<a href="#l14.61"></a><span id="l14.61" class="difflineat">@@ -108,25 +108,24 @@ function subtest_folder_operations(root)</span>
<a href="#l14.62"></a><span id="l14.62">   // Test - getChildNamed</span>
<a href="#l14.63"></a><span id="l14.63"> </span>
<a href="#l14.64"></a><span id="l14.64">   Assert.equal(root.getChildNamed(&quot;folder1&quot;), folder);</span>
<a href="#l14.65"></a><span id="l14.65"> </span>
<a href="#l14.66"></a><span id="l14.66">   // Check for non match, this should throw</span>
<a href="#l14.67"></a><span id="l14.67">   var thrown = false;</span>
<a href="#l14.68"></a><span id="l14.68">   try {</span>
<a href="#l14.69"></a><span id="l14.69">     root.getChildNamed(&quot;folder2&quot;);</span>
<a href="#l14.70"></a><span id="l14.70" class="difflineminus">-  }</span>
<a href="#l14.71"></a><span id="l14.71" class="difflineminus">-  catch (e) {</span>
<a href="#l14.72"></a><span id="l14.72" class="difflineplus">+  } catch (e) {</span>
<a href="#l14.73"></a><span id="l14.73">     thrown = true;</span>
<a href="#l14.74"></a><span id="l14.74">   }</span>
<a href="#l14.75"></a><span id="l14.75"> </span>
<a href="#l14.76"></a><span id="l14.76">   Assert.ok(thrown);</span>
<a href="#l14.77"></a><span id="l14.77"> </span>
<a href="#l14.78"></a><span id="l14.78">   // folder2 is a child of folder however.</span>
<a href="#l14.79"></a><span id="l14.79" class="difflineminus">-  var folder2 = folder.getChildNamed(&quot;folder2&quot;);</span>
<a href="#l14.80"></a><span id="l14.80" class="difflineplus">+  folder2 = folder.getChildNamed(&quot;folder2&quot;);</span>
<a href="#l14.81"></a><span id="l14.81"> </span>
<a href="#l14.82"></a><span id="l14.82">   // Test - isAncestorOf</span>
<a href="#l14.83"></a><span id="l14.83"> </span>
<a href="#l14.84"></a><span id="l14.84">   Assert.ok(folder.isAncestorOf(folder2));</span>
<a href="#l14.85"></a><span id="l14.85">   Assert.ok(root.isAncestorOf(folder2));</span>
<a href="#l14.86"></a><span id="l14.86">   Assert.ok(!folder.isAncestorOf(root));</span>
<a href="#l14.87"></a><span id="l14.87"> </span>
<a href="#l14.88"></a><span id="l14.88">   // Test - FoldersWithFlag</span>
<a href="#l14.89"></a><span id="l14.89" class="difflineat">@@ -167,23 +166,22 @@ function subtest_folder_operations(root)</span>
<a href="#l14.90"></a><span id="l14.90">   let hdr = folder1Local.addMessage(message.toMboxString());</span>
<a href="#l14.91"></a><span id="l14.91">   Assert.equal(message.messageId, hdr.messageId);</span>
<a href="#l14.92"></a><span id="l14.92"> </span>
<a href="#l14.93"></a><span id="l14.93">   folder3Local.copyFolderLocal(folder, true, null, null);</span>
<a href="#l14.94"></a><span id="l14.94"> </span>
<a href="#l14.95"></a><span id="l14.95">   // Test - Get the new folders, make sure the old ones don't exist</span>
<a href="#l14.96"></a><span id="l14.96"> </span>
<a href="#l14.97"></a><span id="l14.97">   var folder1Moved = folder3.getChildNamed(&quot;folder1&quot;);</span>
<a href="#l14.98"></a><span id="l14.98" class="difflineminus">-  var folder2Moved = folder1Moved.getChildNamed(&quot;folder2&quot;);</span>
<a href="#l14.99"></a><span id="l14.99" class="difflineplus">+  folder1Moved.getChildNamed(&quot;folder2&quot;);</span>
<a href="#l14.100"></a><span id="l14.100"> </span>
<a href="#l14.101"></a><span id="l14.101">   thrown = false;</span>
<a href="#l14.102"></a><span id="l14.102">   try {</span>
<a href="#l14.103"></a><span id="l14.103">     root.getChildNamed(&quot;folder1&quot;);</span>
<a href="#l14.104"></a><span id="l14.104" class="difflineminus">-  }</span>
<a href="#l14.105"></a><span id="l14.105" class="difflineminus">-  catch (e) {</span>
<a href="#l14.106"></a><span id="l14.106" class="difflineplus">+  } catch (e) {</span>
<a href="#l14.107"></a><span id="l14.107">     thrown = true;</span>
<a href="#l14.108"></a><span id="l14.108">   }</span>
<a href="#l14.109"></a><span id="l14.109"> </span>
<a href="#l14.110"></a><span id="l14.110">   Assert.ok(thrown);</span>
<a href="#l14.111"></a><span id="l14.111"> </span>
<a href="#l14.112"></a><span id="l14.112">   if (folder.filePath.exists())</span>
<a href="#l14.113"></a><span id="l14.113">     dump(&quot;shouldn't exist - folder file path &quot; + folder.URI + &quot;\n&quot;);</span>
<a href="#l14.114"></a><span id="l14.114">   Assert.ok(!folder.filePath.exists());</span>
<a href="#l14.115"></a><span id="l14.115" class="difflineat">@@ -238,17 +236,17 @@ function subtest_folder_operations(root)</span>
<a href="#l14.116"></a><span id="l14.116"> function test_store_rename(root) {</span>
<a href="#l14.117"></a><span id="l14.117">   let folder1 = root.createLocalSubfolder(&quot;newfolder1&quot;)</span>
<a href="#l14.118"></a><span id="l14.118">                     .QueryInterface(Ci.nsIMsgLocalMailFolder);</span>
<a href="#l14.119"></a><span id="l14.119">   Assert.ok(root.hasSubFolders);</span>
<a href="#l14.120"></a><span id="l14.120">   Assert.ok(!folder1.hasSubFolders);</span>
<a href="#l14.121"></a><span id="l14.121">   let folder2 = folder1.createLocalSubfolder(&quot;newfolder1-sub&quot;);</span>
<a href="#l14.122"></a><span id="l14.122">   let folder3 = root.createLocalSubfolder(&quot;newfolder3&quot;)</span>
<a href="#l14.123"></a><span id="l14.123">                     .QueryInterface(Ci.nsIMsgLocalMailFolder);</span>
<a href="#l14.124"></a><span id="l14.124" class="difflineminus">-  let folder3Subfolder = folder3.createLocalSubfolder(&quot;newfolder3-sub&quot;);</span>
<a href="#l14.125"></a><span id="l14.125" class="difflineplus">+  folder3.createLocalSubfolder(&quot;newfolder3-sub&quot;);</span>
<a href="#l14.126"></a><span id="l14.126"> </span>
<a href="#l14.127"></a><span id="l14.127">   Assert.ok(folder1.hasSubFolders);</span>
<a href="#l14.128"></a><span id="l14.128">   Assert.ok(!folder2.hasSubFolders);</span>
<a href="#l14.129"></a><span id="l14.129">   Assert.ok(folder3.hasSubFolders);</span>
<a href="#l14.130"></a><span id="l14.130"> </span>
<a href="#l14.131"></a><span id="l14.131">   folder1.rename(&quot;folder1&quot;, null);</span>
<a href="#l14.132"></a><span id="l14.132">   Assert.ok(root.containsChildNamed(&quot;folder1&quot;));</span>
<a href="#l14.133"></a><span id="l14.133">   folder1 = root.getChildNamed(&quot;folder1&quot;);</span>
<a href="#l14.134"></a><span id="l14.134" class="difflineat">@@ -261,26 +259,26 @@ function test_store_rename(root) {</span>
<a href="#l14.135"></a><span id="l14.135">   Assert.ok(folder1.containsChildNamed(folder2.name));</span>
<a href="#l14.136"></a><span id="l14.136">   Assert.ok(folder2.filePath.exists());</span>
<a href="#l14.137"></a><span id="l14.137"> </span>
<a href="#l14.138"></a><span id="l14.138">   folder3 = root.getChildNamed(&quot;newfolder3&quot;);</span>
<a href="#l14.139"></a><span id="l14.139">   root.propagateDelete(folder3, true, null);</span>
<a href="#l14.140"></a><span id="l14.140">   Assert.ok(!root.containsChildNamed(&quot;newfolder3&quot;));</span>
<a href="#l14.141"></a><span id="l14.141">   folder3 = root.createLocalSubfolder(&quot;newfolder3&quot;)</span>
<a href="#l14.142"></a><span id="l14.142">                 .QueryInterface(Ci.nsIMsgLocalMailFolder);</span>
<a href="#l14.143"></a><span id="l14.143" class="difflineminus">-  folder3Subfolder = folder3.createLocalSubfolder(&quot;newfolder3-sub&quot;);</span>
<a href="#l14.144"></a><span id="l14.144" class="difflineplus">+  folder3.createLocalSubfolder(&quot;newfolder3-sub&quot;);</span>
<a href="#l14.145"></a><span id="l14.145">   folder3.rename(&quot;folder3&quot;, null);</span>
<a href="#l14.146"></a><span id="l14.146"> </span>
<a href="#l14.147"></a><span id="l14.147">   Assert.ok(root.containsChildNamed(&quot;folder3&quot;));</span>
<a href="#l14.148"></a><span id="l14.148">   Assert.ok(!root.containsChildNamed(&quot;newfolder3&quot;));</span>
<a href="#l14.149"></a><span id="l14.149"> }</span>
<a href="#l14.150"></a><span id="l14.150"> </span>
<a href="#l14.151"></a><span id="l14.151"> var gPluggableStores = [</span>
<a href="#l14.152"></a><span id="l14.152">   &quot;@mozilla.org/msgstore/berkeleystore;1&quot;,</span>
<a href="#l14.153"></a><span id="l14.153" class="difflineminus">-  &quot;@mozilla.org/msgstore/maildirstore;1&quot;</span>
<a href="#l14.154"></a><span id="l14.154" class="difflineplus">+  &quot;@mozilla.org/msgstore/maildirstore;1&quot;,</span>
<a href="#l14.155"></a><span id="l14.155"> ];</span>
<a href="#l14.156"></a><span id="l14.156"> </span>
<a href="#l14.157"></a><span id="l14.157"> function run_all_tests(aHostName) {</span>
<a href="#l14.158"></a><span id="l14.158">   let server = MailServices.accounts.createIncomingServer(&quot;nobody&quot;, aHostName,</span>
<a href="#l14.159"></a><span id="l14.159">                                                           &quot;none&quot;);</span>
<a href="#l14.160"></a><span id="l14.160">   let account = MailServices.accounts.createAccount();</span>
<a href="#l14.161"></a><span id="l14.161">   account.incomingServer = server;</span>
<a href="#l14.162"></a><span id="l14.162"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mailnews/local/test/unit/test_nsIMsgPluggableStore.js</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mailnews/local/test/unit/test_nsIMsgPluggableStore.js</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -3,17 +3,17 @@</span>
<a href="#l15.4"></a><span id="l15.4">  * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l15.5"></a><span id="l15.5"> </span>
<a href="#l15.6"></a><span id="l15.6"> /**</span>
<a href="#l15.7"></a><span id="l15.7">  * nsIMsgPluggableStore interface tests</span>
<a href="#l15.8"></a><span id="l15.8">  */</span>
<a href="#l15.9"></a><span id="l15.9"> </span>
<a href="#l15.10"></a><span id="l15.10"> var gPluggableStores = [</span>
<a href="#l15.11"></a><span id="l15.11">   &quot;@mozilla.org/msgstore/berkeleystore;1&quot;,</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-  &quot;@mozilla.org/msgstore/maildirstore;1&quot;</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineplus">+  &quot;@mozilla.org/msgstore/maildirstore;1&quot;,</span>
<a href="#l15.14"></a><span id="l15.14"> ];</span>
<a href="#l15.15"></a><span id="l15.15"> </span>
<a href="#l15.16"></a><span id="l15.16"> function test_discoverSubFolders() {</span>
<a href="#l15.17"></a><span id="l15.17">   let mailbox = setup_mailbox(&quot;none&quot;, create_temporary_directory());</span>
<a href="#l15.18"></a><span id="l15.18"> </span>
<a href="#l15.19"></a><span id="l15.19">   mailbox.msgStore.discoverSubFolders(mailbox, true);</span>
<a href="#l15.20"></a><span id="l15.20"> </span>
<a href="#l15.21"></a><span id="l15.21"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mailnews/local/test/unit/test_over2GBMailboxes.js</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mailnews/local/test/unit/test_over2GBMailboxes.js</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -1,23 +1,23 @@</span>
<a href="#l16.4"></a><span id="l16.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l16.5"></a><span id="l16.5"> </span>
<a href="#l16.6"></a><span id="l16.6"> /* Test of accessing over 2 GiB local folder. */</span>
<a href="#l16.7"></a><span id="l16.7"> </span>
<a href="#l16.8"></a><span id="l16.8" class="difflineplus">+/* import-globals-from ../../../test/resources/messageGenerator.js */</span>
<a href="#l16.9"></a><span id="l16.9"> load(&quot;../../../resources/messageGenerator.js&quot;);</span>
<a href="#l16.10"></a><span id="l16.10"> var bugmail10 = do_get_file(&quot;../../../data/bugmail10&quot;);</span>
<a href="#l16.11"></a><span id="l16.11"> </span>
<a href="#l16.12"></a><span id="l16.12"> Services.prefs.setCharPref(&quot;mail.serverDefaultStoreContractID&quot;,</span>
<a href="#l16.13"></a><span id="l16.13">                            &quot;@mozilla.org/msgstore/berkeleystore;1&quot;);</span>
<a href="#l16.14"></a><span id="l16.14"> </span>
<a href="#l16.15"></a><span id="l16.15"> var gLocalInboxSize;</span>
<a href="#l16.16"></a><span id="l16.16"> var gLocalTrashFolder;</span>
<a href="#l16.17"></a><span id="l16.17"> </span>
<a href="#l16.18"></a><span id="l16.18" class="difflineminus">-function run_test()</span>
<a href="#l16.19"></a><span id="l16.19" class="difflineminus">-{</span>
<a href="#l16.20"></a><span id="l16.20" class="difflineplus">+function run_test() {</span>
<a href="#l16.21"></a><span id="l16.21">   localAccountUtils.loadLocalMailAccount();</span>
<a href="#l16.22"></a><span id="l16.22"> </span>
<a href="#l16.23"></a><span id="l16.23">   // &quot;Master&quot; do_test_pending(), paired with a do_test_finished() at the end of</span>
<a href="#l16.24"></a><span id="l16.24">   // all the operations.</span>
<a href="#l16.25"></a><span id="l16.25">   do_test_pending();</span>
<a href="#l16.26"></a><span id="l16.26"> </span>
<a href="#l16.27"></a><span id="l16.27">   let inboxFile = localAccountUtils.inboxFolder.filePath;</span>
<a href="#l16.28"></a><span id="l16.28"> </span>
<a href="#l16.29"></a><span id="l16.29" class="difflineat">@@ -54,87 +54,85 @@ function run_test()</span>
<a href="#l16.30"></a><span id="l16.30">   info(&quot;Local inbox size (before copyFileMessageInLocalFolder()) = &quot; +</span>
<a href="#l16.31"></a><span id="l16.31">        gLocalInboxSize);</span>
<a href="#l16.32"></a><span id="l16.32"> </span>
<a href="#l16.33"></a><span id="l16.33">   // Append mail data to over 2 GiB position for over 2 GiB msgkey.</span>
<a href="#l16.34"></a><span id="l16.34">   copyFileMessageInLocalFolder(bugmail10, 0, &quot;&quot;, null, copyMessages);</span>
<a href="#l16.35"></a><span id="l16.35"> }</span>
<a href="#l16.36"></a><span id="l16.36"> </span>
<a href="#l16.37"></a><span id="l16.37"> // Get message whose offset is over 2 GiB.</span>
<a href="#l16.38"></a><span id="l16.38" class="difflineminus">-function getMessageHdr()</span>
<a href="#l16.39"></a><span id="l16.39" class="difflineminus">-{</span>
<a href="#l16.40"></a><span id="l16.40" class="difflineplus">+function getMessageHdr() {</span>
<a href="#l16.41"></a><span id="l16.41">   let msgEnum = localAccountUtils.inboxFolder.msgDatabase.EnumerateMessages();</span>
<a href="#l16.42"></a><span id="l16.42">   while (msgEnum.hasMoreElements()) {</span>
<a href="#l16.43"></a><span id="l16.43">     let header = msgEnum.getNext().QueryInterface(Ci.nsIMsgDBHdr);</span>
<a href="#l16.44"></a><span id="l16.44">     if (header.messageOffset &gt;= 0x80000000) {</span>
<a href="#l16.45"></a><span id="l16.45">       return header;</span>
<a href="#l16.46"></a><span id="l16.46">     }</span>
<a href="#l16.47"></a><span id="l16.47">   }</span>
<a href="#l16.48"></a><span id="l16.48"> </span>
<a href="#l16.49"></a><span id="l16.49">   do_throw(&quot;Over 2 GiB msgkey was not found!&quot;);</span>
<a href="#l16.50"></a><span id="l16.50" class="difflineplus">+  return null; // This won't ever happen, but we're keeping the linter happy.</span>
<a href="#l16.51"></a><span id="l16.51"> }</span>
<a href="#l16.52"></a><span id="l16.52"> </span>
<a href="#l16.53"></a><span id="l16.53" class="difflineminus">-function copyMessages()</span>
<a href="#l16.54"></a><span id="l16.54" class="difflineminus">-{</span>
<a href="#l16.55"></a><span id="l16.55" class="difflineplus">+function copyMessages() {</span>
<a href="#l16.56"></a><span id="l16.56">   // Make sure inbox file grew (i.e., we were not writing over data).</span>
<a href="#l16.57"></a><span id="l16.57">   let localInboxSize = localAccountUtils.inboxFolder.filePath.fileSize;</span>
<a href="#l16.58"></a><span id="l16.58">   info(&quot;Local inbox size (after copyFileMessageInLocalFolder()) = &quot; +</span>
<a href="#l16.59"></a><span id="l16.59">        localInboxSize);</span>
<a href="#l16.60"></a><span id="l16.60">   Assert.ok(localInboxSize &gt; gLocalInboxSize);</span>
<a href="#l16.61"></a><span id="l16.61"> </span>
<a href="#l16.62"></a><span id="l16.62">   // Copy the message into the subfolder.</span>
<a href="#l16.63"></a><span id="l16.63">   let messages = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span>
<a href="#l16.64"></a><span id="l16.64">   messages.appendElement(getMessageHdr());</span>
<a href="#l16.65"></a><span id="l16.65">   MailServices.copy.CopyMessages(localAccountUtils.inboxFolder, messages,</span>
<a href="#l16.66"></a><span id="l16.66">                                  gLocalTrashFolder,</span>
<a href="#l16.67"></a><span id="l16.67">                                  false, copyListener2, null, false);</span>
<a href="#l16.68"></a><span id="l16.68"> }</span>
<a href="#l16.69"></a><span id="l16.69"> </span>
<a href="#l16.70"></a><span id="l16.70"> var copyListener2 = {</span>
<a href="#l16.71"></a><span id="l16.71" class="difflineminus">-  OnStartCopy : function() {},</span>
<a href="#l16.72"></a><span id="l16.72" class="difflineminus">-  OnProgress: function(aProgress, aProgressMax) {},</span>
<a href="#l16.73"></a><span id="l16.73" class="difflineminus">-  SetMessageKey : function(aKey) {},</span>
<a href="#l16.74"></a><span id="l16.74" class="difflineminus">-  OnStopCopy : function(aStatus) {</span>
<a href="#l16.75"></a><span id="l16.75" class="difflineplus">+  OnStartCopy() {},</span>
<a href="#l16.76"></a><span id="l16.76" class="difflineplus">+  OnProgress(aProgress, aProgressMax) {},</span>
<a href="#l16.77"></a><span id="l16.77" class="difflineplus">+  SetMessageKey(aKey) {},</span>
<a href="#l16.78"></a><span id="l16.78" class="difflineplus">+  OnStopCopy(aStatus) {</span>
<a href="#l16.79"></a><span id="l16.79">     Assert.equal(aStatus, 0);</span>
<a href="#l16.80"></a><span id="l16.80"> </span>
<a href="#l16.81"></a><span id="l16.81">     do_timeout(0, accessOver2GBMsg);</span>
<a href="#l16.82"></a><span id="l16.82" class="difflineminus">-  }</span>
<a href="#l16.83"></a><span id="l16.83" class="difflineplus">+  },</span>
<a href="#l16.84"></a><span id="l16.84"> };</span>
<a href="#l16.85"></a><span id="l16.85"> </span>
<a href="#l16.86"></a><span id="l16.86"> // streamMessage() test by over 2 GiB mail offset.</span>
<a href="#l16.87"></a><span id="l16.87" class="difflineminus">-function accessOver2GBMsg()</span>
<a href="#l16.88"></a><span id="l16.88" class="difflineminus">-{</span>
<a href="#l16.89"></a><span id="l16.89" class="difflineplus">+function accessOver2GBMsg() {</span>
<a href="#l16.90"></a><span id="l16.90">   let messenger = Cc[&quot;@mozilla.org/messenger;1&quot;].createInstance(Ci.nsIMessenger);</span>
<a href="#l16.91"></a><span id="l16.91">   let msghdr = getMessageHdr();</span>
<a href="#l16.92"></a><span id="l16.92">   let msgURI = msghdr.folder.getUriForMsg(msghdr);</span>
<a href="#l16.93"></a><span id="l16.93">   let msgServ = messenger.messageServiceFromURI(msgURI);</span>
<a href="#l16.94"></a><span id="l16.94">   msgServ.streamMessage(msgURI, gStreamListener, null, null, false, &quot;&quot;, true);</span>
<a href="#l16.95"></a><span id="l16.95"> }</span>
<a href="#l16.96"></a><span id="l16.96"> </span>
<a href="#l16.97"></a><span id="l16.97"> var gStreamListener = {</span>
<a href="#l16.98"></a><span id="l16.98" class="difflineminus">-  QueryInterface : ChromeUtils.generateQI([Ci.nsIStreamListener]),</span>
<a href="#l16.99"></a><span id="l16.99" class="difflineminus">-  _stream : null,</span>
<a href="#l16.100"></a><span id="l16.100" class="difflineminus">-  _data : null,</span>
<a href="#l16.101"></a><span id="l16.101" class="difflineminus">-  onStartRequest : function (aRequest, aContext) {</span>
<a href="#l16.102"></a><span id="l16.102" class="difflineplus">+  QueryInterface: ChromeUtils.generateQI([Ci.nsIStreamListener]),</span>
<a href="#l16.103"></a><span id="l16.103" class="difflineplus">+  _stream: null,</span>
<a href="#l16.104"></a><span id="l16.104" class="difflineplus">+  _data: null,</span>
<a href="#l16.105"></a><span id="l16.105" class="difflineplus">+  onStartRequest(aRequest, aContext) {</span>
<a href="#l16.106"></a><span id="l16.106">     this._data = &quot;&quot;;</span>
<a href="#l16.107"></a><span id="l16.107">   },</span>
<a href="#l16.108"></a><span id="l16.108" class="difflineminus">-  onStopRequest : function (aRequest, aContext, aStatusCode) {</span>
<a href="#l16.109"></a><span id="l16.109" class="difflineplus">+  onStopRequest(aRequest, aContext, aStatusCode) {</span>
<a href="#l16.110"></a><span id="l16.110">     let fstream = Cc[&quot;@mozilla.org/network/file-input-stream;1&quot;]</span>
<a href="#l16.111"></a><span id="l16.111">                     .createInstance(Ci.nsIFileInputStream);</span>
<a href="#l16.112"></a><span id="l16.112">     let stream = Cc[&quot;@mozilla.org/scriptableinputstream;1&quot;]</span>
<a href="#l16.113"></a><span id="l16.113">                    .createInstance(Ci.nsIScriptableInputStream);</span>
<a href="#l16.114"></a><span id="l16.114"> </span>
<a href="#l16.115"></a><span id="l16.115">     fstream.init(bugmail10, -1, 0, 0);</span>
<a href="#l16.116"></a><span id="l16.116">     stream.init(fstream);</span>
<a href="#l16.117"></a><span id="l16.117">     let original = stream.read(this._data.length);</span>
<a href="#l16.118"></a><span id="l16.118">     Assert.equal(this._data, original);</span>
<a href="#l16.119"></a><span id="l16.119"> </span>
<a href="#l16.120"></a><span id="l16.120">     do_timeout(0, endTest);</span>
<a href="#l16.121"></a><span id="l16.121">   },</span>
<a href="#l16.122"></a><span id="l16.122" class="difflineminus">-  onDataAvailable : function (aRequest, aContext, aInputStream, aOff, aCount) {</span>
<a href="#l16.123"></a><span id="l16.123" class="difflineplus">+  onDataAvailable(aRequest, aContext, aInputStream, aOff, aCount) {</span>
<a href="#l16.124"></a><span id="l16.124">     if (this._stream == null) {</span>
<a href="#l16.125"></a><span id="l16.125">       this._stream = Cc[&quot;@mozilla.org/scriptableinputstream;1&quot;].createInstance(Ci.nsIScriptableInputStream);</span>
<a href="#l16.126"></a><span id="l16.126">       this._stream.init(aInputStream);</span>
<a href="#l16.127"></a><span id="l16.127">     }</span>
<a href="#l16.128"></a><span id="l16.128">     this._data += this._stream.read(aCount);</span>
<a href="#l16.129"></a><span id="l16.129">   },</span>
<a href="#l16.130"></a><span id="l16.130"> };</span>
<a href="#l16.131"></a><span id="l16.131"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mailnews/local/test/unit/test_over4GBMailboxes.js</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mailnews/local/test/unit/test_over4GBMailboxes.js</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -16,21 +16,24 @@</span>
<a href="#l17.4"></a><span id="l17.4">  * -  copyIntoOver4GiB_success_check1</span>
<a href="#l17.5"></a><span id="l17.5">  * -  copyIntoOver4GiB_success_check2</span>
<a href="#l17.6"></a><span id="l17.6">  * - compactOver4GiB</span>
<a href="#l17.7"></a><span id="l17.7">  * -  CompactListener_compactOver4GiB</span>
<a href="#l17.8"></a><span id="l17.8">  * - compactUnder4GiB</span>
<a href="#l17.9"></a><span id="l17.9">  * -  CompactListener_compactUnder4GiB</span>
<a href="#l17.10"></a><span id="l17.10">  */</span>
<a href="#l17.11"></a><span id="l17.11"> </span>
<a href="#l17.12"></a><span id="l17.12" class="difflineplus">+/* import-globals-from ../../../test/resources/asyncTestUtils.js */</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineplus">+/* import-globals-from ../../../test/resources/alertTestUtils.js */</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineplus">+/* import-globals-from ../../../test/resources/messageGenerator.js */</span>
<a href="#l17.15"></a><span id="l17.15" class="difflineplus">+/* import-globals-from ../../../test/resources/POP3pump.js */</span>
<a href="#l17.16"></a><span id="l17.16"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l17.17"></a><span id="l17.17"> load(&quot;../../../resources/alertTestUtils.js&quot;);</span>
<a href="#l17.18"></a><span id="l17.18"> load(&quot;../../../resources/messageGenerator.js&quot;);</span>
<a href="#l17.19"></a><span id="l17.19"> load(&quot;../../../resources/POP3pump.js&quot;);</span>
<a href="#l17.20"></a><span id="l17.20" class="difflineminus">-ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l17.21"></a><span id="l17.21"> </span>
<a href="#l17.22"></a><span id="l17.22"> Services.prefs.setCharPref(&quot;mail.serverDefaultStoreContractID&quot;,</span>
<a href="#l17.23"></a><span id="l17.23">                            &quot;@mozilla.org/msgstore/berkeleystore;1&quot;);</span>
<a href="#l17.24"></a><span id="l17.24"> </span>
<a href="#l17.25"></a><span id="l17.25"> // If we're running out of memory parsing the folder, lowering the</span>
<a href="#l17.26"></a><span id="l17.26"> // block size might help, though it will slow the test down and consume</span>
<a href="#l17.27"></a><span id="l17.27"> // more disk space.</span>
<a href="#l17.28"></a><span id="l17.28"> var kSparseBlockSize = 102400000;</span>
<a href="#l17.29"></a><span id="l17.29" class="difflineat">@@ -38,55 +41,56 @@ var kSizeLimit = 0x100000000; // 4GiB</span>
<a href="#l17.30"></a><span id="l17.30"> var kNearLimit = kSizeLimit - 0x1000000; // -16MiB</span>
<a href="#l17.31"></a><span id="l17.31"> </span>
<a href="#l17.32"></a><span id="l17.32"> var gGotAlert = false;</span>
<a href="#l17.33"></a><span id="l17.33"> var gInboxFile = null;         // The mbox file storing the Inbox folder</span>
<a href="#l17.34"></a><span id="l17.34"> var gInboxSize = 0;            // The size of the Inbox folder</span>
<a href="#l17.35"></a><span id="l17.35"> var gInbox;                    // The nsIMsgFolder object of the Inbox folder in Local Folders</span>
<a href="#l17.36"></a><span id="l17.36"> var gExpectedNewMessages = 0;  // The number of messages pushed manually into the mbox file</span>
<a href="#l17.37"></a><span id="l17.37"> </span>
<a href="#l17.38"></a><span id="l17.38" class="difflineplus">+/* exported alert */</span>
<a href="#l17.39"></a><span id="l17.39"> // This alert() is triggered when file size becomes close (enough) to or</span>
<a href="#l17.40"></a><span id="l17.40"> // exceeds 4 GiB.</span>
<a href="#l17.41"></a><span id="l17.41"> // See hardcoded value in nsMsgBrkMBoxStore::HasSpaceAvailable().</span>
<a href="#l17.42"></a><span id="l17.42"> function alert(aDialogTitle, aText) {</span>
<a href="#l17.43"></a><span id="l17.43">   // See &quot;/*/locales/en-US/chrome/*/messenger.properties &gt; mailboxTooLarge&quot;.</span>
<a href="#l17.44"></a><span id="l17.44">   Assert.ok(aText.startsWith(&quot;The folder Inbox is full, and can't hold any more messages.&quot;));</span>
<a href="#l17.45"></a><span id="l17.45">   gGotAlert = true;</span>
<a href="#l17.46"></a><span id="l17.46"> }</span>
<a href="#l17.47"></a><span id="l17.47"> </span>
<a href="#l17.48"></a><span id="l17.48"> // A stub nsIMsgFolderListener that only listens to changes on Inbox and stores</span>
<a href="#l17.49"></a><span id="l17.49"> // the seen values for interesting folder properties so we can later test them.</span>
<a href="#l17.50"></a><span id="l17.50"> var FListener = {</span>
<a href="#l17.51"></a><span id="l17.51">   folderSize: [-1], // an array of seen values of &quot;FolderSize&quot;</span>
<a href="#l17.52"></a><span id="l17.52">   totalMsgs: [-1],  // an array of seen values of &quot;TotalMessages&quot;</span>
<a href="#l17.53"></a><span id="l17.53"> </span>
<a href="#l17.54"></a><span id="l17.54">   // Returns the value that is stored 'aBack' entries from the last one in the history.</span>
<a href="#l17.55"></a><span id="l17.55" class="difflineminus">-  sizeHistory: function (aBack) {</span>
<a href="#l17.56"></a><span id="l17.56" class="difflineplus">+  sizeHistory(aBack) {</span>
<a href="#l17.57"></a><span id="l17.57">     return this.folderSize[this.folderSize.length - 1 - aBack];</span>
<a href="#l17.58"></a><span id="l17.58">   },</span>
<a href="#l17.59"></a><span id="l17.59" class="difflineminus">-  msgsHistory: function (aBack) {</span>
<a href="#l17.60"></a><span id="l17.60" class="difflineplus">+  msgsHistory(aBack) {</span>
<a href="#l17.61"></a><span id="l17.61">     return this.totalMsgs[this.totalMsgs.length - 1 - aBack];</span>
<a href="#l17.62"></a><span id="l17.62">   },</span>
<a href="#l17.63"></a><span id="l17.63"> </span>
<a href="#l17.64"></a><span id="l17.64">   OnItemAdded: function act_add(aRDFParentItem, aItem) {},</span>
<a href="#l17.65"></a><span id="l17.65">   OnItemRemoved: function act_remove(aRDFParentItem, aItem) {},</span>
<a href="#l17.66"></a><span id="l17.66" class="difflineminus">-  OnItemPropertyChanged: function(aItem, aProperty, aOld, aNew) {},</span>
<a href="#l17.67"></a><span id="l17.67" class="difflineminus">-  OnItemIntPropertyChanged: function(aItem, aProperty, aOld, aNew) {</span>
<a href="#l17.68"></a><span id="l17.68" class="difflineplus">+  OnItemPropertyChanged(aItem, aProperty, aOld, aNew) {},</span>
<a href="#l17.69"></a><span id="l17.69" class="difflineplus">+  OnItemIntPropertyChanged(aItem, aProperty, aOld, aNew) {</span>
<a href="#l17.70"></a><span id="l17.70">     if (aItem === gInbox) {</span>
<a href="#l17.71"></a><span id="l17.71">       dump(&quot;Property change on folder Inbox:&quot; + aProperty + &quot;=&quot; + aOld + &quot;-&gt;&quot; + aNew + &quot;\n&quot;);</span>
<a href="#l17.72"></a><span id="l17.72">       if (aProperty == &quot;FolderSize&quot;)</span>
<a href="#l17.73"></a><span id="l17.73">         this.folderSize.push(aNew);</span>
<a href="#l17.74"></a><span id="l17.74">       else if (aProperty == &quot;TotalMessages&quot;)</span>
<a href="#l17.75"></a><span id="l17.75">         this.totalMsgs.push(aNew);</span>
<a href="#l17.76"></a><span id="l17.76">     }</span>
<a href="#l17.77"></a><span id="l17.77">   },</span>
<a href="#l17.78"></a><span id="l17.78" class="difflineminus">-  OnItemBoolPropertyChanged: function(aItem, aProperty, aOld, aNew) {},</span>
<a href="#l17.79"></a><span id="l17.79" class="difflineminus">-  OnItemUnicharPropertyChanged: function(aItem, aProperty, aOld, aNew) {},</span>
<a href="#l17.80"></a><span id="l17.80" class="difflineminus">-  OnItemPropertyFlagChanged: function(aItem, aProperty, aOld, aNew) {},</span>
<a href="#l17.81"></a><span id="l17.81" class="difflineminus">-  OnItemEvent: function(aFolder, aEvent) {},</span>
<a href="#l17.82"></a><span id="l17.82" class="difflineplus">+  OnItemBoolPropertyChanged(aItem, aProperty, aOld, aNew) {},</span>
<a href="#l17.83"></a><span id="l17.83" class="difflineplus">+  OnItemUnicharPropertyChanged(aItem, aProperty, aOld, aNew) {},</span>
<a href="#l17.84"></a><span id="l17.84" class="difflineplus">+  OnItemPropertyFlagChanged(aItem, aProperty, aOld, aNew) {},</span>
<a href="#l17.85"></a><span id="l17.85" class="difflineplus">+  OnItemEvent(aFolder, aEvent) {},</span>
<a href="#l17.86"></a><span id="l17.86"> };</span>
<a href="#l17.87"></a><span id="l17.87"> </span>
<a href="#l17.88"></a><span id="l17.88"> /**</span>
<a href="#l17.89"></a><span id="l17.89">  * Allow folders to grow over 4GB.</span>
<a href="#l17.90"></a><span id="l17.90">  */</span>
<a href="#l17.91"></a><span id="l17.91"> function allow4GBFolders(aOn) {</span>
<a href="#l17.92"></a><span id="l17.92">   Services.prefs.setBoolPref(&quot;mailnews.allowMboxOver4GB&quot;, aOn);</span>
<a href="#l17.93"></a><span id="l17.93"> }</span>
<a href="#l17.94"></a><span id="l17.94" class="difflineat">@@ -117,18 +121,18 @@ function growInbox(aWantedSize) {</span>
<a href="#l17.95"></a><span id="l17.95">   // Grow local inbox to our wished size that is below the max limit.</span>
<a href="#l17.96"></a><span id="l17.96">   do {</span>
<a href="#l17.97"></a><span id="l17.97">     let sparseStart = gInboxFile.clone().fileSize + mboxString.length;</span>
<a href="#l17.98"></a><span id="l17.98">     let nextOffset = Math.min(sparseStart + kSparseBlockSize, aWantedSize - 2);</span>
<a href="#l17.99"></a><span id="l17.99">     if ((aWantedSize - (nextOffset + 2)) &lt; (mboxString.length + 2))</span>
<a href="#l17.100"></a><span id="l17.100">       nextOffset = aWantedSize - 2;</span>
<a href="#l17.101"></a><span id="l17.101"> </span>
<a href="#l17.102"></a><span id="l17.102">     // Get stream to write a new message.</span>
<a href="#l17.103"></a><span id="l17.103" class="difflineminus">-    let reusable = new Object;</span>
<a href="#l17.104"></a><span id="l17.104" class="difflineminus">-    let newMsgHdr = new Object;</span>
<a href="#l17.105"></a><span id="l17.105" class="difflineplus">+    let reusable = {};</span>
<a href="#l17.106"></a><span id="l17.106" class="difflineplus">+    let newMsgHdr = {};</span>
<a href="#l17.107"></a><span id="l17.107">     let outputStream = plugStore.getNewMsgOutputStream(gInbox, newMsgHdr, reusable)</span>
<a href="#l17.108"></a><span id="l17.108">                                 .QueryInterface(Ci.nsISeekableStream);</span>
<a href="#l17.109"></a><span id="l17.109">     // Write message header.</span>
<a href="#l17.110"></a><span id="l17.110">     outputStream.write(mboxString, mboxString.length);</span>
<a href="#l17.111"></a><span id="l17.111">     outputStream.close();</span>
<a href="#l17.112"></a><span id="l17.112"> </span>
<a href="#l17.113"></a><span id="l17.113">     // &quot;Add&quot; a new (empty) sparse block at the end of the file.</span>
<a href="#l17.114"></a><span id="l17.114">     if (nextOffset - sparseStart == kSparseBlockSize)</span>
<a href="#l17.115"></a><span id="l17.115" class="difflineat">@@ -156,36 +160,34 @@ function growInbox(aWantedSize) {</span>
<a href="#l17.116"></a><span id="l17.116"> </span>
<a href="#l17.117"></a><span id="l17.117">   Assert.equal(gInboxFile.clone().fileSize, aWantedSize);</span>
<a href="#l17.118"></a><span id="l17.118">   info(&quot;Local inbox size = &quot; + localSize + &quot;bytes = &quot; +</span>
<a href="#l17.119"></a><span id="l17.119">        mailTestUtils.toMiBString(localSize));</span>
<a href="#l17.120"></a><span id="l17.120">   Assert.equal(localSize, aWantedSize);</span>
<a href="#l17.121"></a><span id="l17.121">   return msgsAdded;</span>
<a href="#l17.122"></a><span id="l17.122"> }</span>
<a href="#l17.123"></a><span id="l17.123"> </span>
<a href="#l17.124"></a><span id="l17.124" class="difflineminus">-function run_test()</span>
<a href="#l17.125"></a><span id="l17.125" class="difflineminus">-{</span>
<a href="#l17.126"></a><span id="l17.126" class="difflineplus">+function run_test() {</span>
<a href="#l17.127"></a><span id="l17.127">   localAccountUtils.loadLocalMailAccount();</span>
<a href="#l17.128"></a><span id="l17.128"> </span>
<a href="#l17.129"></a><span id="l17.129">   allow4GBFolders(false);</span>
<a href="#l17.130"></a><span id="l17.130"> </span>
<a href="#l17.131"></a><span id="l17.131">   // &quot;Master&quot; do_test_pending(), paired with a do_test_finished() at the end of</span>
<a href="#l17.132"></a><span id="l17.132">   // all the operations.</span>
<a href="#l17.133"></a><span id="l17.133">   do_test_pending();</span>
<a href="#l17.134"></a><span id="l17.134"> </span>
<a href="#l17.135"></a><span id="l17.135">   gInbox = localAccountUtils.inboxFolder;</span>
<a href="#l17.136"></a><span id="l17.136">   gInboxFile = gInbox.filePath;</span>
<a href="#l17.137"></a><span id="l17.137"> </span>
<a href="#l17.138"></a><span id="l17.138">   let neededFreeSpace = kSizeLimit + 0x10000000; // +256MiB</span>
<a href="#l17.139"></a><span id="l17.139">   // On Windows, check whether the drive is NTFS. If it is, mark the file as</span>
<a href="#l17.140"></a><span id="l17.140">   // sparse. If it isn't, then bail out now, because in all probability it is</span>
<a href="#l17.141"></a><span id="l17.141">   // FAT32, which doesn't support file sizes greater than 4 GiB.</span>
<a href="#l17.142"></a><span id="l17.142">   if (&quot;@mozilla.org/windows-registry-key;1&quot; in Cc &amp;&amp;</span>
<a href="#l17.143"></a><span id="l17.143" class="difflineminus">-      mailTestUtils.get_file_system(gInboxFile) != &quot;NTFS&quot;)</span>
<a href="#l17.144"></a><span id="l17.144" class="difflineminus">-  {</span>
<a href="#l17.145"></a><span id="l17.145" class="difflineplus">+      mailTestUtils.get_file_system(gInboxFile) != &quot;NTFS&quot;) {</span>
<a href="#l17.146"></a><span id="l17.146">     dump(&quot;On Windows, this test only works on NTFS volumes.\n&quot;);</span>
<a href="#l17.147"></a><span id="l17.147"> </span>
<a href="#l17.148"></a><span id="l17.148">     endTest();</span>
<a href="#l17.149"></a><span id="l17.149">     return;</span>
<a href="#l17.150"></a><span id="l17.150">   }</span>
<a href="#l17.151"></a><span id="l17.151"> </span>
<a href="#l17.152"></a><span id="l17.152">   let freeDiskSpace = gInboxFile.diskSpaceAvailable;</span>
<a href="#l17.153"></a><span id="l17.153">   info(&quot;Free disk space = &quot; + mailTestUtils.toMiBString(freeDiskSpace));</span>
<a href="#l17.154"></a><span id="l17.154" class="difflineat">@@ -213,18 +215,17 @@ function run_test()</span>
<a href="#l17.155"></a><span id="l17.155">     Assert.equal(ex.result, Cr.NS_ERROR_NOT_INITIALIZED);</span>
<a href="#l17.156"></a><span id="l17.156">   }</span>
<a href="#l17.157"></a><span id="l17.157">   // Execution continues in downloadUnder4GiB() when done.</span>
<a href="#l17.158"></a><span id="l17.158"> }</span>
<a href="#l17.159"></a><span id="l17.159"> </span>
<a href="#l17.160"></a><span id="l17.160"> /**</span>
<a href="#l17.161"></a><span id="l17.161">  * Check we can download new mail when we are near 4GiB limit but do not cross it.</span>
<a href="#l17.162"></a><span id="l17.162">  */</span>
<a href="#l17.163"></a><span id="l17.163" class="difflineminus">-function downloadUnder4GiB()</span>
<a href="#l17.164"></a><span id="l17.164" class="difflineminus">-{</span>
<a href="#l17.165"></a><span id="l17.165" class="difflineplus">+function downloadUnder4GiB() {</span>
<a href="#l17.166"></a><span id="l17.166">   // Check fake POP3 server is ready.</span>
<a href="#l17.167"></a><span id="l17.167">   Assert.notEqual(gPOP3Pump.fakeServer, null);</span>
<a href="#l17.168"></a><span id="l17.168"> </span>
<a href="#l17.169"></a><span id="l17.169">   // Download a file that still fits into the limit.</span>
<a href="#l17.170"></a><span id="l17.170">   let bigFile = do_get_file(&quot;../../../data/mime-torture&quot;);</span>
<a href="#l17.171"></a><span id="l17.171">   Assert.ok(bigFile.fileSize &gt;= 1024 * 1024);</span>
<a href="#l17.172"></a><span id="l17.172">   Assert.ok(bigFile.fileSize &lt;= 1024 * 1024 * 2);</span>
<a href="#l17.173"></a><span id="l17.173"> </span>
<a href="#l17.174"></a><span id="l17.174" class="difflineat">@@ -234,18 +235,17 @@ function downloadUnder4GiB()</span>
<a href="#l17.175"></a><span id="l17.175">   gPOP3Pump.run(Cr.NS_OK);</span>
<a href="#l17.176"></a><span id="l17.176">   // Execution continues in downloadOver4GiB_fail() when done.</span>
<a href="#l17.177"></a><span id="l17.177"> }</span>
<a href="#l17.178"></a><span id="l17.178"> </span>
<a href="#l17.179"></a><span id="l17.179"> /**</span>
<a href="#l17.180"></a><span id="l17.180">  * Bug 640371</span>
<a href="#l17.181"></a><span id="l17.181">  * Check we will not cross the 4GiB limit when downloading new mail.</span>
<a href="#l17.182"></a><span id="l17.182">  */</span>
<a href="#l17.183"></a><span id="l17.183" class="difflineminus">-function downloadOver4GiB_fail()</span>
<a href="#l17.184"></a><span id="l17.184" class="difflineminus">-{</span>
<a href="#l17.185"></a><span id="l17.185" class="difflineplus">+function downloadOver4GiB_fail() {</span>
<a href="#l17.186"></a><span id="l17.186">   let localInboxSize = gInboxFile.clone().fileSize;</span>
<a href="#l17.187"></a><span id="l17.187">   Assert.ok(localInboxSize &gt;= kNearLimit);</span>
<a href="#l17.188"></a><span id="l17.188">   Assert.ok(localInboxSize &lt; kSizeLimit);</span>
<a href="#l17.189"></a><span id="l17.189">   Assert.equal(gInbox.sizeOnDisk, localInboxSize);</span>
<a href="#l17.190"></a><span id="l17.190">   Assert.ok(gInbox.msgDatabase.summaryValid);</span>
<a href="#l17.191"></a><span id="l17.191">   // The big file is between 1 and 2 MiB. Append it 16 times to attempt to cross the 4GiB limit.</span>
<a href="#l17.192"></a><span id="l17.192">   gPOP3Pump.files = [&quot;../../../data/mime-torture&quot;, &quot;../../../data/mime-torture&quot;,</span>
<a href="#l17.193"></a><span id="l17.193">                      &quot;../../../data/mime-torture&quot;, &quot;../../../data/mime-torture&quot;,</span>
<a href="#l17.194"></a><span id="l17.194" class="difflineat">@@ -260,18 +260,17 @@ function downloadOver4GiB_fail()</span>
<a href="#l17.195"></a><span id="l17.195">   gPOP3Pump.run(Cr.NS_ERROR_FAILURE);</span>
<a href="#l17.196"></a><span id="l17.196">   // Execution continues in downloadOver4GiB_success() when done.</span>
<a href="#l17.197"></a><span id="l17.197"> }</span>
<a href="#l17.198"></a><span id="l17.198"> </span>
<a href="#l17.199"></a><span id="l17.199"> /**</span>
<a href="#l17.200"></a><span id="l17.200">  * Bug 789679</span>
<a href="#l17.201"></a><span id="l17.201">  * Check we can cross the 4GiB limit when downloading new mail.</span>
<a href="#l17.202"></a><span id="l17.202">  */</span>
<a href="#l17.203"></a><span id="l17.203" class="difflineminus">-function downloadOver4GiB_success()</span>
<a href="#l17.204"></a><span id="l17.204" class="difflineminus">-{</span>
<a href="#l17.205"></a><span id="l17.205" class="difflineplus">+function downloadOver4GiB_success() {</span>
<a href="#l17.206"></a><span id="l17.206">   allow4GBFolders(true);</span>
<a href="#l17.207"></a><span id="l17.207">   // Grow inbox to size greater than the max limit (+16 MiB).</span>
<a href="#l17.208"></a><span id="l17.208">   gExpectedNewMessages = 16;</span>
<a href="#l17.209"></a><span id="l17.209">   // We are in the .onDone() callback of the previous run of gPOP3Pump</span>
<a href="#l17.210"></a><span id="l17.210">   // so we need a new POP3Pump so that internal variables of the previous</span>
<a href="#l17.211"></a><span id="l17.211">   // one don't get confused.</span>
<a href="#l17.212"></a><span id="l17.212">   // TODO: this whole test file should be converted to the new</span>
<a href="#l17.213"></a><span id="l17.213">   // Promise-based task framework to solve this problem cleanly.</span>
<a href="#l17.214"></a><span id="l17.214" class="difflineat">@@ -290,18 +289,17 @@ function downloadOver4GiB_success()</span>
<a href="#l17.215"></a><span id="l17.215">   gPOP3Pump.run(Cr.NS_OK);</span>
<a href="#l17.216"></a><span id="l17.216">   // Execution continues in growOver4GiB_success_check() when done.</span>
<a href="#l17.217"></a><span id="l17.217"> }</span>
<a href="#l17.218"></a><span id="l17.218"> </span>
<a href="#l17.219"></a><span id="l17.219"> /**</span>
<a href="#l17.220"></a><span id="l17.220">  * Bug 608449</span>
<a href="#l17.221"></a><span id="l17.221">  * Check we can parse a folder if it is above 4GiB.</span>
<a href="#l17.222"></a><span id="l17.222">  */</span>
<a href="#l17.223"></a><span id="l17.223" class="difflineminus">-function downloadOver4GiB_success_check()</span>
<a href="#l17.224"></a><span id="l17.224" class="difflineminus">-{</span>
<a href="#l17.225"></a><span id="l17.225" class="difflineplus">+function downloadOver4GiB_success_check() {</span>
<a href="#l17.226"></a><span id="l17.226">   let localInboxSize = gInboxFile.clone().fileSize;</span>
<a href="#l17.227"></a><span id="l17.227">   dump(&quot;Local inbox size (after downloadOver4GiB_success) = &quot; + localInboxSize + &quot;\n&quot;);</span>
<a href="#l17.228"></a><span id="l17.228">   Assert.ok(localInboxSize &gt; kSizeLimit);</span>
<a href="#l17.229"></a><span id="l17.229">   Assert.ok(gInbox.msgDatabase.summaryValid);</span>
<a href="#l17.230"></a><span id="l17.230"> </span>
<a href="#l17.231"></a><span id="l17.231">   // Bug 789679</span>
<a href="#l17.232"></a><span id="l17.232">   // Check if the public SizeOnDisk method can return sizes above 4GB.</span>
<a href="#l17.233"></a><span id="l17.233">   Assert.equal(gInbox.sizeOnDisk, localInboxSize);</span>
<a href="#l17.234"></a><span id="l17.234" class="difflineat">@@ -327,50 +325,47 @@ function downloadOver4GiB_success_check(</span>
<a href="#l17.235"></a><span id="l17.235"> </span>
<a href="#l17.236"></a><span id="l17.236">   copyIntoOver4GiB_fail();</span>
<a href="#l17.237"></a><span id="l17.237"> }</span>
<a href="#l17.238"></a><span id="l17.238"> </span>
<a href="#l17.239"></a><span id="l17.239"> /**</span>
<a href="#l17.240"></a><span id="l17.240">  * Bug 598104</span>
<a href="#l17.241"></a><span id="l17.241">  * Check that copy operation does not allow to grow a local folder above 4 GiB.</span>
<a href="#l17.242"></a><span id="l17.242">  */</span>
<a href="#l17.243"></a><span id="l17.243" class="difflineminus">-function copyIntoOver4GiB_fail()</span>
<a href="#l17.244"></a><span id="l17.244" class="difflineminus">-{</span>
<a href="#l17.245"></a><span id="l17.245" class="difflineplus">+function copyIntoOver4GiB_fail() {</span>
<a href="#l17.246"></a><span id="l17.246">   allow4GBFolders(false);</span>
<a href="#l17.247"></a><span id="l17.247">   // Save initial file size.</span>
<a href="#l17.248"></a><span id="l17.248">   let localInboxSize = gInboxFile.clone().fileSize;</span>
<a href="#l17.249"></a><span id="l17.249">   info(&quot;Local inbox size (before copyFileMessageInLocalFolder()) = &quot; +</span>
<a href="#l17.250"></a><span id="l17.250">        localInboxSize);</span>
<a href="#l17.251"></a><span id="l17.251"> </span>
<a href="#l17.252"></a><span id="l17.252">   // Use copyFileMessageInLocalFolder() to (try to) append another message</span>
<a href="#l17.253"></a><span id="l17.253">   // to local inbox.</span>
<a href="#l17.254"></a><span id="l17.254">   gGotAlert = false;</span>
<a href="#l17.255"></a><span id="l17.255">   let file = do_get_file(&quot;../../../data/mime-torture&quot;);</span>
<a href="#l17.256"></a><span id="l17.256">   copyFileMessageInLocalFolder(file, 0, &quot;&quot;, gDummyMsgWindow, copyIntoOver4GiB_fail_check);</span>
<a href="#l17.257"></a><span id="l17.257"> }</span>
<a href="#l17.258"></a><span id="l17.258"> </span>
<a href="#l17.259"></a><span id="l17.259" class="difflineminus">-function copyIntoOver4GiB_fail_check(aMessageHeadersKeys, aStatus)</span>
<a href="#l17.260"></a><span id="l17.260" class="difflineminus">-{</span>
<a href="#l17.261"></a><span id="l17.261" class="difflineplus">+function copyIntoOver4GiB_fail_check(aMessageHeadersKeys, aStatus) {</span>
<a href="#l17.262"></a><span id="l17.262">   Assert.ok(!Components.isSuccessCode(aStatus));</span>
<a href="#l17.263"></a><span id="l17.263">   Assert.equal(aMessageHeadersKeys.length, 0);</span>
<a href="#l17.264"></a><span id="l17.264">   Assert.ok(gGotAlert);</span>
<a href="#l17.265"></a><span id="l17.265"> </span>
<a href="#l17.266"></a><span id="l17.266">   // Make sure inbox file did not grow (i.e., no data were appended).</span>
<a href="#l17.267"></a><span id="l17.267">   let newLocalInboxSize = gInboxFile.clone().fileSize;</span>
<a href="#l17.268"></a><span id="l17.268">   info(&quot;Local inbox size (after copyFileMessageInLocalFolder()) = &quot; +</span>
<a href="#l17.269"></a><span id="l17.269">        newLocalInboxSize);</span>
<a href="#l17.270"></a><span id="l17.270">   copyIntoOver4GiB_success();</span>
<a href="#l17.271"></a><span id="l17.271"> }</span>
<a href="#l17.272"></a><span id="l17.272"> </span>
<a href="#l17.273"></a><span id="l17.273"> /**</span>
<a href="#l17.274"></a><span id="l17.274">  * Bug 789679</span>
<a href="#l17.275"></a><span id="l17.275">  * Check that copy operation does allow to grow a local folder above 4 GiB.</span>
<a href="#l17.276"></a><span id="l17.276">  */</span>
<a href="#l17.277"></a><span id="l17.277" class="difflineminus">-function copyIntoOver4GiB_success()</span>
<a href="#l17.278"></a><span id="l17.278" class="difflineminus">-{</span>
<a href="#l17.279"></a><span id="l17.279" class="difflineplus">+function copyIntoOver4GiB_success() {</span>
<a href="#l17.280"></a><span id="l17.280">   allow4GBFolders(true);</span>
<a href="#l17.281"></a><span id="l17.281">   // Append 2 new 2MB messages to the folder.</span>
<a href="#l17.282"></a><span id="l17.282">   gExpectedNewMessages = 2;</span>
<a href="#l17.283"></a><span id="l17.283"> </span>
<a href="#l17.284"></a><span id="l17.284">   // This message will be preserved in CompactUnder4GB.</span>
<a href="#l17.285"></a><span id="l17.285">   gGotAlert = false;</span>
<a href="#l17.286"></a><span id="l17.286">   let file = do_get_file(&quot;../../../data/mime-torture&quot;);</span>
<a href="#l17.287"></a><span id="l17.287">   copyFileMessageInLocalFolder(file, 0, &quot;&quot;, gDummyMsgWindow, copyIntoOver4GiB_success_check1);</span>
<a href="#l17.288"></a><span id="l17.288" class="difflineat">@@ -396,18 +391,17 @@ function copyIntoOver4GiB_success_check2</span>
<a href="#l17.289"></a><span id="l17.289"> </span>
<a href="#l17.290"></a><span id="l17.290">   compactOver4GiB();</span>
<a href="#l17.291"></a><span id="l17.291"> }</span>
<a href="#l17.292"></a><span id="l17.292"> </span>
<a href="#l17.293"></a><span id="l17.293"> /**</span>
<a href="#l17.294"></a><span id="l17.294">  * Bug 794303</span>
<a href="#l17.295"></a><span id="l17.295">  * Check we can compact a folder that stays above 4 GiB after compact.</span>
<a href="#l17.296"></a><span id="l17.296">  */</span>
<a href="#l17.297"></a><span id="l17.297" class="difflineminus">-function compactOver4GiB()</span>
<a href="#l17.298"></a><span id="l17.298" class="difflineminus">-{</span>
<a href="#l17.299"></a><span id="l17.299" class="difflineplus">+function compactOver4GiB() {</span>
<a href="#l17.300"></a><span id="l17.300">   gInboxSize = gInboxFile.clone().fileSize;</span>
<a href="#l17.301"></a><span id="l17.301">   Assert.ok(gInboxSize &gt; kSizeLimit);</span>
<a href="#l17.302"></a><span id="l17.302">   Assert.equal(gInbox.expungedBytes, 0);</span>
<a href="#l17.303"></a><span id="l17.303">   // Delete the last small message at folder end.</span>
<a href="#l17.304"></a><span id="l17.304">   let enumerator = gInbox.messages;</span>
<a href="#l17.305"></a><span id="l17.305">   let messages = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span>
<a href="#l17.306"></a><span id="l17.306">   let sizeToExpunge = 0;</span>
<a href="#l17.307"></a><span id="l17.307">   while (enumerator.hasMoreElements()) {</span>
<a href="#l17.308"></a><span id="l17.308" class="difflineat">@@ -436,18 +430,17 @@ function compactOver4GiB()</span>
<a href="#l17.309"></a><span id="l17.309">     compactUnder4GiB();</span>
<a href="#l17.310"></a><span id="l17.310">   }</span>
<a href="#l17.311"></a><span id="l17.311"> }</span>
<a href="#l17.312"></a><span id="l17.312"> </span>
<a href="#l17.313"></a><span id="l17.313"> /**</span>
<a href="#l17.314"></a><span id="l17.314">  * Bug 608449</span>
<a href="#l17.315"></a><span id="l17.315">  * Check we can compact a folder to get it under 4 GiB.</span>
<a href="#l17.316"></a><span id="l17.316">  */</span>
<a href="#l17.317"></a><span id="l17.317" class="difflineminus">-function compactUnder4GiB()</span>
<a href="#l17.318"></a><span id="l17.318" class="difflineminus">-{</span>
<a href="#l17.319"></a><span id="l17.319" class="difflineplus">+function compactUnder4GiB() {</span>
<a href="#l17.320"></a><span id="l17.320">   // The folder is still above 4GB.</span>
<a href="#l17.321"></a><span id="l17.321">   Assert.ok(gInboxFile.clone().fileSize &gt; kSizeLimit);</span>
<a href="#l17.322"></a><span id="l17.322">   let folderSize = gInbox.sizeOnDisk;</span>
<a href="#l17.323"></a><span id="l17.323">   let totalMsgs = gInbox.getTotalMessages(false);</span>
<a href="#l17.324"></a><span id="l17.324">   // Let's close the database and re-open the folder (hopefully dumping memory caches)</span>
<a href="#l17.325"></a><span id="l17.325">   // and re-reading the values from disk (msg database). That is to test if</span>
<a href="#l17.326"></a><span id="l17.326">   // the values were properly serialized to the database.</span>
<a href="#l17.327"></a><span id="l17.327">   gInbox.ForceDBClosed();</span>
<a href="#l17.328"></a><span id="l17.328" class="difflineat">@@ -477,58 +470,55 @@ function compactUnder4GiB()</span>
<a href="#l17.329"></a><span id="l17.329">   Assert.ok(sizeToExpunge &gt; kSizeLimit);</span>
<a href="#l17.330"></a><span id="l17.330"> </span>
<a href="#l17.331"></a><span id="l17.331">   // Note: compact() will also add 'X-Mozilla-Status' and 'X-Mozilla-Status2'</span>
<a href="#l17.332"></a><span id="l17.332">   // lines to message(s).</span>
<a href="#l17.333"></a><span id="l17.333">   gInbox.compact(CompactListener_compactUnder4GiB, null);</span>
<a href="#l17.334"></a><span id="l17.334">   // Test ends after compaction is done.</span>
<a href="#l17.335"></a><span id="l17.335"> }</span>
<a href="#l17.336"></a><span id="l17.336"> </span>
<a href="#l17.337"></a><span id="l17.337" class="difflineminus">-var ParseListener_run_test =</span>
<a href="#l17.338"></a><span id="l17.338" class="difflineminus">-{</span>
<a href="#l17.339"></a><span id="l17.339" class="difflineminus">-  OnStartRunningUrl: function (aUrl) {},</span>
<a href="#l17.340"></a><span id="l17.340" class="difflineminus">-  OnStopRunningUrl: function (aUrl, aExitCode) {</span>
<a href="#l17.341"></a><span id="l17.341" class="difflineplus">+var ParseListener_run_test = {</span>
<a href="#l17.342"></a><span id="l17.342" class="difflineplus">+  OnStartRunningUrl(aUrl) {},</span>
<a href="#l17.343"></a><span id="l17.343" class="difflineplus">+  OnStopRunningUrl(aUrl, aExitCode) {</span>
<a href="#l17.344"></a><span id="l17.344">     // Check: reparse successful</span>
<a href="#l17.345"></a><span id="l17.345">     Assert.equal(aExitCode, Cr.NS_OK);</span>
<a href="#l17.346"></a><span id="l17.346">     Assert.notEqual(gInbox.msgDatabase, null);</span>
<a href="#l17.347"></a><span id="l17.347">     Assert.ok(gInbox.msgDatabase.summaryValid);</span>
<a href="#l17.348"></a><span id="l17.348">     // Bug 813459</span>
<a href="#l17.349"></a><span id="l17.349">     // Check if the OnItemIntPropertyChanged folder listener hook can return</span>
<a href="#l17.350"></a><span id="l17.350">     // values below 2^32 for properties which are not 64 bits long.</span>
<a href="#l17.351"></a><span id="l17.351">     Assert.equal(FListener.msgsHistory(0), gExpectedNewMessages);</span>
<a href="#l17.352"></a><span id="l17.352">     Assert.equal(FListener.msgsHistory(0), gInbox.getTotalMessages(false));</span>
<a href="#l17.353"></a><span id="l17.353">     Assert.equal(FListener.sizeHistory(0), gInbox.sizeOnDisk);</span>
<a href="#l17.354"></a><span id="l17.354"> </span>
<a href="#l17.355"></a><span id="l17.355">     downloadUnder4GiB();</span>
<a href="#l17.356"></a><span id="l17.356" class="difflineminus">-  }</span>
<a href="#l17.357"></a><span id="l17.357" class="difflineplus">+  },</span>
<a href="#l17.358"></a><span id="l17.358"> };</span>
<a href="#l17.359"></a><span id="l17.359"> </span>
<a href="#l17.360"></a><span id="l17.360" class="difflineminus">-var CompactListener_compactOver4GiB =</span>
<a href="#l17.361"></a><span id="l17.361" class="difflineminus">-{</span>
<a href="#l17.362"></a><span id="l17.362" class="difflineminus">-  OnStartRunningUrl: function (aUrl) {},</span>
<a href="#l17.363"></a><span id="l17.363" class="difflineminus">-  OnStopRunningUrl: function (aUrl, aExitCode) {</span>
<a href="#l17.364"></a><span id="l17.364" class="difflineplus">+var CompactListener_compactOver4GiB = {</span>
<a href="#l17.365"></a><span id="l17.365" class="difflineplus">+  OnStartRunningUrl(aUrl) {},</span>
<a href="#l17.366"></a><span id="l17.366" class="difflineplus">+  OnStopRunningUrl(aUrl, aExitCode) {</span>
<a href="#l17.367"></a><span id="l17.367">     // Check: message successfully copied.</span>
<a href="#l17.368"></a><span id="l17.368">     Assert.equal(aExitCode, Cr.NS_OK);</span>
<a href="#l17.369"></a><span id="l17.369">     Assert.ok(gInbox.msgDatabase.summaryValid);</span>
<a href="#l17.370"></a><span id="l17.370">     // Check that folder size is still above max limit ...</span>
<a href="#l17.371"></a><span id="l17.371">     let localInboxSize = gInbox.filePath.clone().fileSize;</span>
<a href="#l17.372"></a><span id="l17.372">     info(&quot;Local inbox size (after compact 1) = &quot; + localInboxSize);</span>
<a href="#l17.373"></a><span id="l17.373">     Assert.ok(localInboxSize &gt; kSizeLimit);</span>
<a href="#l17.374"></a><span id="l17.374">     // ... but it got smaller by removing 1 message.</span>
<a href="#l17.375"></a><span id="l17.375">     Assert.ok(gInboxSize &gt; localInboxSize);</span>
<a href="#l17.376"></a><span id="l17.376">     Assert.equal(gInbox.sizeOnDisk, localInboxSize);</span>
<a href="#l17.377"></a><span id="l17.377"> </span>
<a href="#l17.378"></a><span id="l17.378">     compactUnder4GiB();</span>
<a href="#l17.379"></a><span id="l17.379" class="difflineminus">-  }</span>
<a href="#l17.380"></a><span id="l17.380" class="difflineplus">+  },</span>
<a href="#l17.381"></a><span id="l17.381"> };</span>
<a href="#l17.382"></a><span id="l17.382"> </span>
<a href="#l17.383"></a><span id="l17.383" class="difflineminus">-var CompactListener_compactUnder4GiB =</span>
<a href="#l17.384"></a><span id="l17.384" class="difflineminus">-{</span>
<a href="#l17.385"></a><span id="l17.385" class="difflineminus">-  OnStartRunningUrl: function (aUrl) {},</span>
<a href="#l17.386"></a><span id="l17.386" class="difflineminus">-  OnStopRunningUrl: function (aUrl, aExitCode) {</span>
<a href="#l17.387"></a><span id="l17.387" class="difflineplus">+var CompactListener_compactUnder4GiB = {</span>
<a href="#l17.388"></a><span id="l17.388" class="difflineplus">+  OnStartRunningUrl(aUrl) {},</span>
<a href="#l17.389"></a><span id="l17.389" class="difflineplus">+  OnStopRunningUrl(aUrl, aExitCode) {</span>
<a href="#l17.390"></a><span id="l17.390">     // Check: message successfully copied.</span>
<a href="#l17.391"></a><span id="l17.391">     Assert.equal(aExitCode, Cr.NS_OK);</span>
<a href="#l17.392"></a><span id="l17.392">     Assert.ok(gInbox.msgDatabase.summaryValid);</span>
<a href="#l17.393"></a><span id="l17.393"> </span>
<a href="#l17.394"></a><span id="l17.394">     // Check that folder size isn't much bigger than our sparse block size, ...</span>
<a href="#l17.395"></a><span id="l17.395">     let localInboxSize = gInbox.filePath.clone().fileSize;</span>
<a href="#l17.396"></a><span id="l17.396">     info(&quot;Local inbox size (after compact 2) = &quot; + localInboxSize);</span>
<a href="#l17.397"></a><span id="l17.397">     Assert.equal(gInbox.sizeOnDisk, localInboxSize);</span>
<a href="#l17.398"></a><span id="l17.398" class="difflineat">@@ -537,21 +527,20 @@ var CompactListener_compactUnder4GiB =</span>
<a href="#l17.399"></a><span id="l17.399">     Assert.equal(gInbox.getTotalMessages(false), 1);</span>
<a href="#l17.400"></a><span id="l17.400">     Assert.equal(FListener.sizeHistory(0), gInbox.sizeOnDisk);</span>
<a href="#l17.401"></a><span id="l17.401">     Assert.equal(FListener.msgsHistory(0), 1);</span>
<a href="#l17.402"></a><span id="l17.402"> </span>
<a href="#l17.403"></a><span id="l17.403">     // The message has its key preserved in compact.</span>
<a href="#l17.404"></a><span id="l17.404">     Assert.equal(gInbox.messages.getNext().QueryInterface(Ci.nsIMsgDBHdr).messageKey, 60);</span>
<a href="#l17.405"></a><span id="l17.405"> </span>
<a href="#l17.406"></a><span id="l17.406">     endTest();</span>
<a href="#l17.407"></a><span id="l17.407" class="difflineminus">-  }</span>
<a href="#l17.408"></a><span id="l17.408" class="difflineplus">+  },</span>
<a href="#l17.409"></a><span id="l17.409"> };</span>
<a href="#l17.410"></a><span id="l17.410"> </span>
<a href="#l17.411"></a><span id="l17.411" class="difflineminus">-function endTest()</span>
<a href="#l17.412"></a><span id="l17.412" class="difflineminus">-{</span>
<a href="#l17.413"></a><span id="l17.413" class="difflineplus">+function endTest() {</span>
<a href="#l17.414"></a><span id="l17.414">   MailServices.mailSession.RemoveFolderListener(FListener);</span>
<a href="#l17.415"></a><span id="l17.415">   // Free up disk space - if you want to look at the file after running</span>
<a href="#l17.416"></a><span id="l17.416">   // this test, comment out this line.</span>
<a href="#l17.417"></a><span id="l17.417">   gInbox.filePath.remove(false);</span>
<a href="#l17.418"></a><span id="l17.418">   Services.prefs.clearUserPref(&quot;mailnews.allowMboxOver4GB&quot;);</span>
<a href="#l17.419"></a><span id="l17.419"> </span>
<a href="#l17.420"></a><span id="l17.420">   do_test_finished();</span>
<a href="#l17.421"></a><span id="l17.421"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mailnews/local/test/unit/test_pop3AuthMethods.js</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mailnews/local/test/unit/test_pop3AuthMethods.js</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -1,73 +1,75 @@</span>
<a href="#l18.4"></a><span id="l18.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l18.5"></a><span id="l18.5"> /**</span>
<a href="#l18.6"></a><span id="l18.6">  * Login tests for POP3</span>
<a href="#l18.7"></a><span id="l18.7">  *</span>
<a href="#l18.8"></a><span id="l18.8">  * Test code &lt;copied from=&quot;test_pop3GetNewMail.js&quot;&gt;</span>
<a href="#l18.9"></a><span id="l18.9">  */</span>
<a href="#l18.10"></a><span id="l18.10"> </span>
<a href="#l18.11"></a><span id="l18.11" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-</span>
<a href="#l18.13"></a><span id="l18.13"> var server;</span>
<a href="#l18.14"></a><span id="l18.14" class="difflineminus">-var daemon;</span>
<a href="#l18.15"></a><span id="l18.15"> var handler;</span>
<a href="#l18.16"></a><span id="l18.16"> var incomingServer;</span>
<a href="#l18.17"></a><span id="l18.17"> var thisTest;</span>
<a href="#l18.18"></a><span id="l18.18" class="difflineminus">-var test = null;</span>
<a href="#l18.19"></a><span id="l18.19"> </span>
<a href="#l18.20"></a><span id="l18.20" class="difflineminus">-var tests = [</span>
<a href="#l18.21"></a><span id="l18.21" class="difflineminus">-  { title: &quot;Cleartext password, with server only supporting USER/PASS&quot;,</span>
<a href="#l18.22"></a><span id="l18.22" class="difflineminus">-    clientAuthMethod : Ci.nsMsgAuthMethod.passwordCleartext,</span>
<a href="#l18.23"></a><span id="l18.23" class="difflineminus">-    serverAuthMethods : [],</span>
<a href="#l18.24"></a><span id="l18.24" class="difflineminus">-    expectSuccess : true,</span>
<a href="#l18.25"></a><span id="l18.25" class="difflineminus">-    transaction: [ &quot;AUTH&quot;, &quot;CAPA&quot;, &quot;USER fred&quot;, &quot;PASS wilma&quot;, &quot;STAT&quot; ] },</span>
<a href="#l18.26"></a><span id="l18.26" class="difflineplus">+var tests = [{</span>
<a href="#l18.27"></a><span id="l18.27" class="difflineplus">+  title: &quot;Cleartext password, with server only supporting USER/PASS&quot;,</span>
<a href="#l18.28"></a><span id="l18.28" class="difflineplus">+  clientAuthMethod: Ci.nsMsgAuthMethod.passwordCleartext,</span>
<a href="#l18.29"></a><span id="l18.29" class="difflineplus">+  serverAuthMethods: [],</span>
<a href="#l18.30"></a><span id="l18.30" class="difflineplus">+  expectSuccess: true,</span>
<a href="#l18.31"></a><span id="l18.31" class="difflineplus">+  transaction: [&quot;AUTH&quot;, &quot;CAPA&quot;, &quot;USER fred&quot;, &quot;PASS wilma&quot;, &quot;STAT&quot;],</span>
<a href="#l18.32"></a><span id="l18.32" class="difflineplus">+}, {</span>
<a href="#l18.33"></a><span id="l18.33">   // Just to make sure we clear the auth flags and re-issue &quot;AUTH&quot;</span>
<a href="#l18.34"></a><span id="l18.34" class="difflineminus">-  { title: &quot;Second time Cleartext password, with server only supporting USER/PASS&quot;,</span>
<a href="#l18.35"></a><span id="l18.35" class="difflineminus">-    clientAuthMethod : Ci.nsMsgAuthMethod.passwordCleartext,</span>
<a href="#l18.36"></a><span id="l18.36" class="difflineminus">-    serverAuthMethods : [],</span>
<a href="#l18.37"></a><span id="l18.37" class="difflineminus">-    expectSuccess : true,</span>
<a href="#l18.38"></a><span id="l18.38" class="difflineminus">-    transaction: [ &quot;AUTH&quot;, &quot;CAPA&quot;, &quot;USER fred&quot;, &quot;PASS wilma&quot;, &quot;STAT&quot; ] },</span>
<a href="#l18.39"></a><span id="l18.39" class="difflineminus">-  { title: &quot;Cleartext password, with server supporting AUTH PLAIN, LOGIN and CRAM&quot;,</span>
<a href="#l18.40"></a><span id="l18.40" class="difflineminus">-    clientAuthMethod : Ci.nsMsgAuthMethod.passwordCleartext,</span>
<a href="#l18.41"></a><span id="l18.41" class="difflineminus">-    serverAuthMethods : [ &quot;PLAIN&quot;, &quot;LOGIN&quot;, &quot;CRAM-MD5&quot; ],</span>
<a href="#l18.42"></a><span id="l18.42" class="difflineminus">-    expectSuccess : true,</span>
<a href="#l18.43"></a><span id="l18.43" class="difflineminus">-    transaction: [ &quot;AUTH&quot;, &quot;CAPA&quot;, &quot;AUTH PLAIN&quot;, &quot;STAT&quot; ] },</span>
<a href="#l18.44"></a><span id="l18.44" class="difflineminus">-  { title: &quot;Cleartext password, with server supporting only AUTH LOGIN&quot;,</span>
<a href="#l18.45"></a><span id="l18.45" class="difflineminus">-    clientAuthMethod : Ci.nsMsgAuthMethod.passwordCleartext,</span>
<a href="#l18.46"></a><span id="l18.46" class="difflineminus">-    serverAuthMethods : [ &quot;LOGIN&quot; ],</span>
<a href="#l18.47"></a><span id="l18.47" class="difflineminus">-    expectSuccess : true,</span>
<a href="#l18.48"></a><span id="l18.48" class="difflineminus">-    transaction: [ &quot;AUTH&quot;, &quot;CAPA&quot;, &quot;AUTH LOGIN&quot;, &quot;STAT&quot; ] },</span>
<a href="#l18.49"></a><span id="l18.49" class="difflineminus">-  { title: &quot;Encrypted password, with server supporting PLAIN and CRAM&quot;,</span>
<a href="#l18.50"></a><span id="l18.50" class="difflineminus">-    clientAuthMethod : Ci.nsMsgAuthMethod.passwordEncrypted,</span>
<a href="#l18.51"></a><span id="l18.51" class="difflineminus">-    serverAuthMethods : [ &quot;PLAIN&quot;, &quot;LOGIN&quot;, &quot;CRAM-MD5&quot; ],</span>
<a href="#l18.52"></a><span id="l18.52" class="difflineminus">-    expectSuccess : true,</span>
<a href="#l18.53"></a><span id="l18.53" class="difflineminus">-    transaction: [ &quot;AUTH&quot;, &quot;CAPA&quot;, &quot;AUTH CRAM-MD5&quot;, &quot;STAT&quot; ] },</span>
<a href="#l18.54"></a><span id="l18.54" class="difflineminus">-  { title: &quot;Encrypted password, with server only supporting AUTH PLAIN and LOGIN (must fail)&quot;,</span>
<a href="#l18.55"></a><span id="l18.55" class="difflineminus">-    clientAuthMethod : Ci.nsMsgAuthMethod.passwordEncrypted,</span>
<a href="#l18.56"></a><span id="l18.56" class="difflineminus">-    serverAuthMethods : [ &quot;PLAIN&quot;, &quot;LOGIN&quot; ],</span>
<a href="#l18.57"></a><span id="l18.57" class="difflineminus">-    expectSuccess : false,</span>
<a href="#l18.58"></a><span id="l18.58" class="difflineminus">-    transaction: [ &quot;AUTH&quot;, &quot;CAPA&quot;] },</span>
<a href="#l18.59"></a><span id="l18.59" class="difflineminus">-  { title: &quot;Any secure method, with server supporting AUTH PLAIN and CRAM&quot;,</span>
<a href="#l18.60"></a><span id="l18.60" class="difflineminus">-    clientAuthMethod : Ci.nsMsgAuthMethod.secure,</span>
<a href="#l18.61"></a><span id="l18.61" class="difflineminus">-    serverAuthMethods : [ &quot;PLAIN&quot; , &quot;LOGIN&quot;, &quot;CRAM-MD5&quot; ],</span>
<a href="#l18.62"></a><span id="l18.62" class="difflineminus">-    expectSuccess : true,</span>
<a href="#l18.63"></a><span id="l18.63" class="difflineminus">-    transaction: [ &quot;AUTH&quot;, &quot;CAPA&quot;, &quot;AUTH CRAM-MD5&quot;, &quot;STAT&quot; ] },</span>
<a href="#l18.64"></a><span id="l18.64" class="difflineminus">-  { title: &quot;Any secure method, with server only supporting AUTH PLAIN and LOGIN (must fail)&quot;,</span>
<a href="#l18.65"></a><span id="l18.65" class="difflineminus">-    clientAuthMethod : Ci.nsMsgAuthMethod.secure,</span>
<a href="#l18.66"></a><span id="l18.66" class="difflineminus">-    serverAuthMethods : [ &quot;PLAIN&quot; ],</span>
<a href="#l18.67"></a><span id="l18.67" class="difflineminus">-    expectSuccess : false,</span>
<a href="#l18.68"></a><span id="l18.68" class="difflineminus">-    transaction: [ &quot;AUTH&quot;, &quot;CAPA&quot; ] }</span>
<a href="#l18.69"></a><span id="l18.69" class="difflineminus">-];</span>
<a href="#l18.70"></a><span id="l18.70" class="difflineplus">+  title: &quot;Second time Cleartext password, with server only supporting USER/PASS&quot;,</span>
<a href="#l18.71"></a><span id="l18.71" class="difflineplus">+  clientAuthMethod: Ci.nsMsgAuthMethod.passwordCleartext,</span>
<a href="#l18.72"></a><span id="l18.72" class="difflineplus">+  serverAuthMethods: [],</span>
<a href="#l18.73"></a><span id="l18.73" class="difflineplus">+  expectSuccess: true,</span>
<a href="#l18.74"></a><span id="l18.74" class="difflineplus">+  transaction: [&quot;AUTH&quot;, &quot;CAPA&quot;, &quot;USER fred&quot;, &quot;PASS wilma&quot;, &quot;STAT&quot;],</span>
<a href="#l18.75"></a><span id="l18.75" class="difflineplus">+}, {</span>
<a href="#l18.76"></a><span id="l18.76" class="difflineplus">+  title: &quot;Cleartext password, with server supporting AUTH PLAIN, LOGIN and CRAM&quot;,</span>
<a href="#l18.77"></a><span id="l18.77" class="difflineplus">+  clientAuthMethod: Ci.nsMsgAuthMethod.passwordCleartext,</span>
<a href="#l18.78"></a><span id="l18.78" class="difflineplus">+  serverAuthMethods: [&quot;PLAIN&quot;, &quot;LOGIN&quot;, &quot;CRAM-MD5&quot;],</span>
<a href="#l18.79"></a><span id="l18.79" class="difflineplus">+  expectSuccess: true,</span>
<a href="#l18.80"></a><span id="l18.80" class="difflineplus">+  transaction: [&quot;AUTH&quot;, &quot;CAPA&quot;, &quot;AUTH PLAIN&quot;, &quot;STAT&quot;],</span>
<a href="#l18.81"></a><span id="l18.81" class="difflineplus">+}, {</span>
<a href="#l18.82"></a><span id="l18.82" class="difflineplus">+  title: &quot;Cleartext password, with server supporting only AUTH LOGIN&quot;,</span>
<a href="#l18.83"></a><span id="l18.83" class="difflineplus">+  clientAuthMethod: Ci.nsMsgAuthMethod.passwordCleartext,</span>
<a href="#l18.84"></a><span id="l18.84" class="difflineplus">+  serverAuthMethods: [&quot;LOGIN&quot;],</span>
<a href="#l18.85"></a><span id="l18.85" class="difflineplus">+  expectSuccess: true,</span>
<a href="#l18.86"></a><span id="l18.86" class="difflineplus">+  transaction: [&quot;AUTH&quot;, &quot;CAPA&quot;, &quot;AUTH LOGIN&quot;, &quot;STAT&quot;],</span>
<a href="#l18.87"></a><span id="l18.87" class="difflineplus">+}, {</span>
<a href="#l18.88"></a><span id="l18.88" class="difflineplus">+  title: &quot;Encrypted password, with server supporting PLAIN and CRAM&quot;,</span>
<a href="#l18.89"></a><span id="l18.89" class="difflineplus">+  clientAuthMethod: Ci.nsMsgAuthMethod.passwordEncrypted,</span>
<a href="#l18.90"></a><span id="l18.90" class="difflineplus">+  serverAuthMethods: [&quot;PLAIN&quot;, &quot;LOGIN&quot;, &quot;CRAM-MD5&quot;],</span>
<a href="#l18.91"></a><span id="l18.91" class="difflineplus">+  expectSuccess: true,</span>
<a href="#l18.92"></a><span id="l18.92" class="difflineplus">+  transaction: [&quot;AUTH&quot;, &quot;CAPA&quot;, &quot;AUTH CRAM-MD5&quot;, &quot;STAT&quot;],</span>
<a href="#l18.93"></a><span id="l18.93" class="difflineplus">+}, {</span>
<a href="#l18.94"></a><span id="l18.94" class="difflineplus">+  title: &quot;Encrypted password, with server only supporting AUTH PLAIN and LOGIN (must fail)&quot;,</span>
<a href="#l18.95"></a><span id="l18.95" class="difflineplus">+  clientAuthMethod: Ci.nsMsgAuthMethod.passwordEncrypted,</span>
<a href="#l18.96"></a><span id="l18.96" class="difflineplus">+  serverAuthMethods: [&quot;PLAIN&quot;, &quot;LOGIN&quot;],</span>
<a href="#l18.97"></a><span id="l18.97" class="difflineplus">+  expectSuccess: false,</span>
<a href="#l18.98"></a><span id="l18.98" class="difflineplus">+  transaction: [&quot;AUTH&quot;, &quot;CAPA&quot;],</span>
<a href="#l18.99"></a><span id="l18.99" class="difflineplus">+}, {</span>
<a href="#l18.100"></a><span id="l18.100" class="difflineplus">+  title: &quot;Any secure method, with server supporting AUTH PLAIN and CRAM&quot;,</span>
<a href="#l18.101"></a><span id="l18.101" class="difflineplus">+  clientAuthMethod: Ci.nsMsgAuthMethod.secure,</span>
<a href="#l18.102"></a><span id="l18.102" class="difflineplus">+  serverAuthMethods: [&quot;PLAIN&quot;, &quot;LOGIN&quot;, &quot;CRAM-MD5&quot;],</span>
<a href="#l18.103"></a><span id="l18.103" class="difflineplus">+  expectSuccess: true,</span>
<a href="#l18.104"></a><span id="l18.104" class="difflineplus">+  transaction: [&quot;AUTH&quot;, &quot;CAPA&quot;, &quot;AUTH CRAM-MD5&quot;, &quot;STAT&quot;],</span>
<a href="#l18.105"></a><span id="l18.105" class="difflineplus">+}, {</span>
<a href="#l18.106"></a><span id="l18.106" class="difflineplus">+  title: &quot;Any secure method, with server only supporting AUTH PLAIN and LOGIN (must fail)&quot;,</span>
<a href="#l18.107"></a><span id="l18.107" class="difflineplus">+  clientAuthMethod: Ci.nsMsgAuthMethod.secure,</span>
<a href="#l18.108"></a><span id="l18.108" class="difflineplus">+  serverAuthMethods: [&quot;PLAIN&quot;],</span>
<a href="#l18.109"></a><span id="l18.109" class="difflineplus">+  expectSuccess: false,</span>
<a href="#l18.110"></a><span id="l18.110" class="difflineplus">+  transaction: [&quot;AUTH&quot;, &quot;CAPA&quot;],</span>
<a href="#l18.111"></a><span id="l18.111" class="difflineplus">+}];</span>
<a href="#l18.112"></a><span id="l18.112"> </span>
<a href="#l18.113"></a><span id="l18.113" class="difflineminus">-var urlListener =</span>
<a href="#l18.114"></a><span id="l18.114" class="difflineminus">-{</span>
<a href="#l18.115"></a><span id="l18.115" class="difflineminus">-  OnStartRunningUrl: function (url) {</span>
<a href="#l18.116"></a><span id="l18.116" class="difflineplus">+var urlListener = {</span>
<a href="#l18.117"></a><span id="l18.117" class="difflineplus">+  OnStartRunningUrl(url) {</span>
<a href="#l18.118"></a><span id="l18.118">   },</span>
<a href="#l18.119"></a><span id="l18.119" class="difflineminus">-  OnStopRunningUrl: function (url, result) {</span>
<a href="#l18.120"></a><span id="l18.120" class="difflineplus">+  OnStopRunningUrl(url, result) {</span>
<a href="#l18.121"></a><span id="l18.121">     try {</span>
<a href="#l18.122"></a><span id="l18.122">       if (thisTest.expectSuccess)</span>
<a href="#l18.123"></a><span id="l18.123">         Assert.equal(result, 0);</span>
<a href="#l18.124"></a><span id="l18.124">       else</span>
<a href="#l18.125"></a><span id="l18.125">         Assert.notEqual(result, 0);</span>
<a href="#l18.126"></a><span id="l18.126"> </span>
<a href="#l18.127"></a><span id="l18.127">       var transaction = server.playTransaction();</span>
<a href="#l18.128"></a><span id="l18.128">       do_check_transaction(transaction, thisTest.transaction);</span>
<a href="#l18.129"></a><span id="l18.129" class="difflineat">@@ -76,17 +78,17 @@ var urlListener =</span>
<a href="#l18.130"></a><span id="l18.130">     } catch (e) {</span>
<a href="#l18.131"></a><span id="l18.131">       server.stop();</span>
<a href="#l18.132"></a><span id="l18.132">       var thread = gThreadManager.currentThread;</span>
<a href="#l18.133"></a><span id="l18.133">       while (thread.hasPendingEvents())</span>
<a href="#l18.134"></a><span id="l18.134">         thread.processNextEvent(true);</span>
<a href="#l18.135"></a><span id="l18.135"> </span>
<a href="#l18.136"></a><span id="l18.136">       do_throw(e);</span>
<a href="#l18.137"></a><span id="l18.137">     }</span>
<a href="#l18.138"></a><span id="l18.138" class="difflineminus">-  }</span>
<a href="#l18.139"></a><span id="l18.139" class="difflineplus">+  },</span>
<a href="#l18.140"></a><span id="l18.140"> };</span>
<a href="#l18.141"></a><span id="l18.141"> </span>
<a href="#l18.142"></a><span id="l18.142"> function checkBusy() {</span>
<a href="#l18.143"></a><span id="l18.143">   if (tests.length == 0) {</span>
<a href="#l18.144"></a><span id="l18.144">     incomingServer.closeCachedConnections();</span>
<a href="#l18.145"></a><span id="l18.145"> </span>
<a href="#l18.146"></a><span id="l18.146">     // No more tests, let everything finish</span>
<a href="#l18.147"></a><span id="l18.147">     server.stop();</span>
<a href="#l18.148"></a><span id="l18.148" class="difflineat">@@ -137,45 +139,42 @@ function testNext() {</span>
<a href="#l18.149"></a><span id="l18.149">     server.performTest();</span>
<a href="#l18.150"></a><span id="l18.150">   } catch (e) {</span>
<a href="#l18.151"></a><span id="l18.151">     server.stop();</span>
<a href="#l18.152"></a><span id="l18.152">     do_throw(e);</span>
<a href="#l18.153"></a><span id="l18.153">   }</span>
<a href="#l18.154"></a><span id="l18.154"> }</span>
<a href="#l18.155"></a><span id="l18.155"> </span>
<a href="#l18.156"></a><span id="l18.156"> // &lt;copied from=&quot;head_maillocal.js::createPop3ServerAndLocalFolders()&quot;&gt;</span>
<a href="#l18.157"></a><span id="l18.157" class="difflineminus">-function createPop3Server()</span>
<a href="#l18.158"></a><span id="l18.158" class="difflineminus">-{</span>
<a href="#l18.159"></a><span id="l18.159" class="difflineplus">+function createPop3Server() {</span>
<a href="#l18.160"></a><span id="l18.160">   let incoming = MailServices.accounts.createIncomingServer(&quot;fred&quot;, &quot;localhost&quot;, &quot;pop3&quot;);</span>
<a href="#l18.161"></a><span id="l18.161">   incoming.port = server.port;</span>
<a href="#l18.162"></a><span id="l18.162">   incoming.password = &quot;wilma&quot;;</span>
<a href="#l18.163"></a><span id="l18.163">   return incoming;</span>
<a href="#l18.164"></a><span id="l18.164"> }</span>
<a href="#l18.165"></a><span id="l18.165" class="difflineminus">-//&lt;/copied&gt;</span>
<a href="#l18.166"></a><span id="l18.166" class="difflineplus">+// &lt;/copied&gt;</span>
<a href="#l18.167"></a><span id="l18.167"> </span>
<a href="#l18.168"></a><span id="l18.168" class="difflineminus">-function deletePop3Server()</span>
<a href="#l18.169"></a><span id="l18.169" class="difflineminus">-{</span>
<a href="#l18.170"></a><span id="l18.170" class="difflineplus">+function deletePop3Server() {</span>
<a href="#l18.171"></a><span id="l18.171">   if (!incomingServer)</span>
<a href="#l18.172"></a><span id="l18.172">     return;</span>
<a href="#l18.173"></a><span id="l18.173">   MailServices.accounts.removeIncomingServer(incomingServer, true);</span>
<a href="#l18.174"></a><span id="l18.174">   incomingServer = null;</span>
<a href="#l18.175"></a><span id="l18.175"> }</span>
<a href="#l18.176"></a><span id="l18.176"> </span>
<a href="#l18.177"></a><span id="l18.177"> function run_test() {</span>
<a href="#l18.178"></a><span id="l18.178">   // Disable new mail notifications</span>
<a href="#l18.179"></a><span id="l18.179">   Services.prefs.setBoolPref(&quot;mail.biff.play_sound&quot;, false);</span>
<a href="#l18.180"></a><span id="l18.180">   Services.prefs.setBoolPref(&quot;mail.biff.show_alert&quot;, false);</span>
<a href="#l18.181"></a><span id="l18.181">   Services.prefs.setBoolPref(&quot;mail.biff.show_tray_icon&quot;, false);</span>
<a href="#l18.182"></a><span id="l18.182">   Services.prefs.setBoolPref(&quot;mail.biff.animate_dock_icon&quot;, false);</span>
<a href="#l18.183"></a><span id="l18.183"> </span>
<a href="#l18.184"></a><span id="l18.184" class="difflineminus">-  ssd = setupServerDaemon();</span>
<a href="#l18.185"></a><span id="l18.185" class="difflineminus">-  daemon = ssd[0];</span>
<a href="#l18.186"></a><span id="l18.186" class="difflineplus">+  let ssd = setupServerDaemon();</span>
<a href="#l18.187"></a><span id="l18.187">   server = ssd[1];</span>
<a href="#l18.188"></a><span id="l18.188">   handler = ssd[2];</span>
<a href="#l18.189"></a><span id="l18.189">   server.start();</span>
<a href="#l18.190"></a><span id="l18.190"> </span>
<a href="#l18.191"></a><span id="l18.191" class="difflineminus">-  //incomingServer = createPop3ServerAndLocalFolders();</span>
<a href="#l18.192"></a><span id="l18.192" class="difflineplus">+  // incomingServer = createPop3ServerAndLocalFolders();</span>
<a href="#l18.193"></a><span id="l18.193">   localAccountUtils.loadLocalMailAccount();</span>
<a href="#l18.194"></a><span id="l18.194"> </span>
<a href="#l18.195"></a><span id="l18.195">   do_test_pending();</span>
<a href="#l18.196"></a><span id="l18.196"> </span>
<a href="#l18.197"></a><span id="l18.197">   testNext();</span>
<a href="#l18.198"></a><span id="l18.198"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mailnews/local/test/unit/test_pop3Download.js</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mailnews/local/test/unit/test_pop3Download.js</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -1,82 +1,78 @@</span>
<a href="#l19.4"></a><span id="l19.4"> /**</span>
<a href="#l19.5"></a><span id="l19.5">  * The intent of this file is to test that pop3 download code message storage</span>
<a href="#l19.6"></a><span id="l19.6">  * works correctly.</span>
<a href="#l19.7"></a><span id="l19.7">  */</span>
<a href="#l19.8"></a><span id="l19.8" class="difflineplus">+</span>
<a href="#l19.9"></a><span id="l19.9" class="difflineplus">+/* import-globals-from ../../../test/resources/POP3pump.js */</span>
<a href="#l19.10"></a><span id="l19.10"> load(&quot;../../../resources/POP3pump.js&quot;);</span>
<a href="#l19.11"></a><span id="l19.11" class="difflineminus">-ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l19.12"></a><span id="l19.12"> </span>
<a href="#l19.13"></a><span id="l19.13"> var testSubjects = [&quot;[Bug 397009] A filter will let me tag, but not untag&quot;,</span>
<a href="#l19.14"></a><span id="l19.14">                     &quot;Hello, did you receive my bugmail?&quot;,</span>
<a href="#l19.15"></a><span id="l19.15">                     &quot;[Bug 655578] list-id filter broken&quot;];</span>
<a href="#l19.16"></a><span id="l19.16"> </span>
<a href="#l19.17"></a><span id="l19.17"> var gMsgHdrs = [];</span>
<a href="#l19.18"></a><span id="l19.18"> var gHdrIndex = 0;</span>
<a href="#l19.19"></a><span id="l19.19"> var gFiles = [&quot;../../../data/bugmail1&quot;,</span>
<a href="#l19.20"></a><span id="l19.20">               &quot;../../../data/draft1&quot;,</span>
<a href="#l19.21"></a><span id="l19.21">               &quot;../../../data/bugmail19&quot;];</span>
<a href="#l19.22"></a><span id="l19.22"> </span>
<a href="#l19.23"></a><span id="l19.23"> // This combination of prefs is required to reproduce bug 713611, which</span>
<a href="#l19.24"></a><span id="l19.24"> // is what this test is about.</span>
<a href="#l19.25"></a><span id="l19.25"> Services.prefs.setBoolPref(&quot;mailnews.downloadToTempFile&quot;, false);</span>
<a href="#l19.26"></a><span id="l19.26"> Services.prefs.setBoolPref(&quot;mail.server.default.leave_on_server&quot;, true);</span>
<a href="#l19.27"></a><span id="l19.27"> </span>
<a href="#l19.28"></a><span id="l19.28" class="difflineminus">-function run_test()</span>
<a href="#l19.29"></a><span id="l19.29" class="difflineminus">-{</span>
<a href="#l19.30"></a><span id="l19.30" class="difflineplus">+function run_test() {</span>
<a href="#l19.31"></a><span id="l19.31">   // add 3 messages</span>
<a href="#l19.32"></a><span id="l19.32">   gPOP3Pump.files = gFiles;</span>
<a href="#l19.33"></a><span id="l19.33">   gPOP3Pump.onDone = continueTest;</span>
<a href="#l19.34"></a><span id="l19.34">   do_test_pending();</span>
<a href="#l19.35"></a><span id="l19.35">   gPOP3Pump.run();</span>
<a href="#l19.36"></a><span id="l19.36"> }</span>
<a href="#l19.37"></a><span id="l19.37"> </span>
<a href="#l19.38"></a><span id="l19.38" class="difflineminus">-function continueTest()</span>
<a href="#l19.39"></a><span id="l19.39" class="difflineminus">-{</span>
<a href="#l19.40"></a><span id="l19.40" class="difflineplus">+function continueTest() {</span>
<a href="#l19.41"></a><span id="l19.41">   // get message headers for the inbox folder</span>
<a href="#l19.42"></a><span id="l19.42">   let enumerator = localAccountUtils.inboxFolder.msgDatabase.EnumerateMessages();</span>
<a href="#l19.43"></a><span id="l19.43">   var msgCount = 0;</span>
<a href="#l19.44"></a><span id="l19.44" class="difflineminus">-  let hdr;</span>
<a href="#l19.45"></a><span id="l19.45" class="difflineminus">-  while (enumerator.hasMoreElements())</span>
<a href="#l19.46"></a><span id="l19.46" class="difflineminus">-  {</span>
<a href="#l19.47"></a><span id="l19.47" class="difflineplus">+  while (enumerator.hasMoreElements()) {</span>
<a href="#l19.48"></a><span id="l19.48">     let hdr = enumerator.getNext().QueryInterface(Ci.nsIMsgDBHdr);</span>
<a href="#l19.49"></a><span id="l19.49">     gMsgHdrs.push(hdr);</span>
<a href="#l19.50"></a><span id="l19.50">     Assert.equal(hdr.subject, testSubjects[msgCount++]);</span>
<a href="#l19.51"></a><span id="l19.51">   }</span>
<a href="#l19.52"></a><span id="l19.52">   Assert.equal(msgCount, 3);</span>
<a href="#l19.53"></a><span id="l19.53">   gPOP3Pump = null;</span>
<a href="#l19.54"></a><span id="l19.54">   streamNextMessage();</span>
<a href="#l19.55"></a><span id="l19.55"> }</span>
<a href="#l19.56"></a><span id="l19.56"> </span>
<a href="#l19.57"></a><span id="l19.57" class="difflineminus">-function streamNextMessage()</span>
<a href="#l19.58"></a><span id="l19.58" class="difflineminus">-{</span>
<a href="#l19.59"></a><span id="l19.59" class="difflineplus">+function streamNextMessage() {</span>
<a href="#l19.60"></a><span id="l19.60">   let messenger = Cc[&quot;@mozilla.org/messenger;1&quot;].createInstance(Ci.nsIMessenger);</span>
<a href="#l19.61"></a><span id="l19.61">   let msghdr = gMsgHdrs[gHdrIndex];</span>
<a href="#l19.62"></a><span id="l19.62">   let msgURI = msghdr.folder.getUriForMsg(msghdr);</span>
<a href="#l19.63"></a><span id="l19.63">   let msgServ = messenger.messageServiceFromURI(msgURI);</span>
<a href="#l19.64"></a><span id="l19.64">   msgServ.streamMessage(msgURI, gStreamListener, null, null, false, &quot;&quot;, true);</span>
<a href="#l19.65"></a><span id="l19.65"> }</span>
<a href="#l19.66"></a><span id="l19.66"> </span>
<a href="#l19.67"></a><span id="l19.67" class="difflineminus">-gStreamListener = {</span>
<a href="#l19.68"></a><span id="l19.68" class="difflineminus">-  QueryInterface : ChromeUtils.generateQI([Ci.nsIStreamListener]),</span>
<a href="#l19.69"></a><span id="l19.69" class="difflineminus">-  _stream : null,</span>
<a href="#l19.70"></a><span id="l19.70" class="difflineminus">-  _data : null,</span>
<a href="#l19.71"></a><span id="l19.71" class="difflineminus">-  onStartRequest : function (aRequest, aContext) {</span>
<a href="#l19.72"></a><span id="l19.72" class="difflineplus">+var gStreamListener = {</span>
<a href="#l19.73"></a><span id="l19.73" class="difflineplus">+  QueryInterface: ChromeUtils.generateQI([Ci.nsIStreamListener]),</span>
<a href="#l19.74"></a><span id="l19.74" class="difflineplus">+  _stream: null,</span>
<a href="#l19.75"></a><span id="l19.75" class="difflineplus">+  _data: null,</span>
<a href="#l19.76"></a><span id="l19.76" class="difflineplus">+  onStartRequest(aRequest, aContext) {</span>
<a href="#l19.77"></a><span id="l19.77">     this._stream = null;</span>
<a href="#l19.78"></a><span id="l19.78">     this._data = &quot;&quot;;</span>
<a href="#l19.79"></a><span id="l19.79">   },</span>
<a href="#l19.80"></a><span id="l19.80" class="difflineminus">-  onStopRequest : function (aRequest, aContext, aStatusCode) {</span>
<a href="#l19.81"></a><span id="l19.81" class="difflineplus">+  onStopRequest(aRequest, aContext, aStatusCode) {</span>
<a href="#l19.82"></a><span id="l19.82">     // check that the streamed message starts with &quot;From &quot;</span>
<a href="#l19.83"></a><span id="l19.83">     Assert.ok(this._data.startsWith(&quot;From &quot;));</span>
<a href="#l19.84"></a><span id="l19.84">     if (++gHdrIndex == gFiles.length)</span>
<a href="#l19.85"></a><span id="l19.85">       do_test_finished();</span>
<a href="#l19.86"></a><span id="l19.86">     else</span>
<a href="#l19.87"></a><span id="l19.87">       streamNextMessage();</span>
<a href="#l19.88"></a><span id="l19.88">   },</span>
<a href="#l19.89"></a><span id="l19.89" class="difflineminus">-  onDataAvailable : function (aRequest, aContext, aInputStream, aOff, aCount) {</span>
<a href="#l19.90"></a><span id="l19.90" class="difflineplus">+  onDataAvailable(aRequest, aContext, aInputStream, aOff, aCount) {</span>
<a href="#l19.91"></a><span id="l19.91">     if (this._stream == null) {</span>
<a href="#l19.92"></a><span id="l19.92">       this._stream = Cc[&quot;@mozilla.org/scriptableinputstream;1&quot;].createInstance(Ci.nsIScriptableInputStream);</span>
<a href="#l19.93"></a><span id="l19.93">       this._stream.init(aInputStream);</span>
<a href="#l19.94"></a><span id="l19.94">     }</span>
<a href="#l19.95"></a><span id="l19.95">     this._data += this._stream.read(aCount);</span>
<a href="#l19.96"></a><span id="l19.96">   },</span>
<a href="#l19.97"></a><span id="l19.97"> };</span>
<a href="#l19.98"></a><span id="l19.98"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/mailnews/local/test/unit/test_pop3DownloadTempFileHandling.js</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/mailnews/local/test/unit/test_pop3DownloadTempFileHandling.js</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -1,45 +1,43 @@</span>
<a href="#l20.4"></a><span id="l20.4"> /**</span>
<a href="#l20.5"></a><span id="l20.5">  * The intent of this file is to test temp file handling when</span>
<a href="#l20.6"></a><span id="l20.6">  * downloading multiple pop3 messages with quarantining turned on.</span>
<a href="#l20.7"></a><span id="l20.7">  *</span>
<a href="#l20.8"></a><span id="l20.8">  * Original author: David Bienvenu &lt;dbienvenu@mozilla.com&gt;</span>
<a href="#l20.9"></a><span id="l20.9">  */</span>
<a href="#l20.10"></a><span id="l20.10" class="difflineplus">+</span>
<a href="#l20.11"></a><span id="l20.11" class="difflineplus">+/* import-globals-from ../../../test/resources/POP3pump.js */</span>
<a href="#l20.12"></a><span id="l20.12"> load(&quot;../../../resources/POP3pump.js&quot;);</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineminus">-ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l20.14"></a><span id="l20.14"> </span>
<a href="#l20.15"></a><span id="l20.15"> var testSubjects = [&quot;[Bug 397009] A filter will let me tag, but not untag&quot;,</span>
<a href="#l20.16"></a><span id="l20.16">                     &quot;Hello, did you receive my bugmail?&quot;];</span>
<a href="#l20.17"></a><span id="l20.17"> var gExpectedFiles;</span>
<a href="#l20.18"></a><span id="l20.18"> </span>
<a href="#l20.19"></a><span id="l20.19" class="difflineminus">-function run_test()</span>
<a href="#l20.20"></a><span id="l20.20" class="difflineminus">-{</span>
<a href="#l20.21"></a><span id="l20.21" class="difflineplus">+function run_test() {</span>
<a href="#l20.22"></a><span id="l20.22">   Services.prefs.setBoolPref(&quot;mailnews.downloadToTempFile&quot;, true);</span>
<a href="#l20.23"></a><span id="l20.23">   gExpectedFiles = createExpectedTemporaryFiles(2);</span>
<a href="#l20.24"></a><span id="l20.24">   // add 2 messages</span>
<a href="#l20.25"></a><span id="l20.25">   gPOP3Pump.files = [&quot;../../../data/bugmail1&quot;,</span>
<a href="#l20.26"></a><span id="l20.26">                      &quot;../../../data/draft1&quot;];</span>
<a href="#l20.27"></a><span id="l20.27">   gPOP3Pump.onDone = continueTest;</span>
<a href="#l20.28"></a><span id="l20.28">   do_test_pending();</span>
<a href="#l20.29"></a><span id="l20.29">   gPOP3Pump.run();</span>
<a href="#l20.30"></a><span id="l20.30"> }</span>
<a href="#l20.31"></a><span id="l20.31"> </span>
<a href="#l20.32"></a><span id="l20.32" class="difflineminus">-function continueTest()</span>
<a href="#l20.33"></a><span id="l20.33" class="difflineminus">-{</span>
<a href="#l20.34"></a><span id="l20.34" class="difflineplus">+function continueTest() {</span>
<a href="#l20.35"></a><span id="l20.35">   dump(&quot;temp file path = &quot; + gExpectedFiles[0].path + &quot;\n&quot;);</span>
<a href="#l20.36"></a><span id="l20.36">   dump(&quot;temp file path = &quot; + gExpectedFiles[1].path + &quot;\n&quot;);</span>
<a href="#l20.37"></a><span id="l20.37">   for (let expectedFile of gExpectedFiles)</span>
<a href="#l20.38"></a><span id="l20.38">     Assert.ok(!expectedFile.exists());</span>
<a href="#l20.39"></a><span id="l20.39"> </span>
<a href="#l20.40"></a><span id="l20.40">   // get message headers for the inbox folder</span>
<a href="#l20.41"></a><span id="l20.41">   let enumerator = localAccountUtils.inboxFolder.msgDatabase.EnumerateMessages();</span>
<a href="#l20.42"></a><span id="l20.42">   var msgCount = 0;</span>
<a href="#l20.43"></a><span id="l20.43" class="difflineminus">-  while (enumerator.hasMoreElements())</span>
<a href="#l20.44"></a><span id="l20.44" class="difflineminus">-  {</span>
<a href="#l20.45"></a><span id="l20.45" class="difflineplus">+  while (enumerator.hasMoreElements()) {</span>
<a href="#l20.46"></a><span id="l20.46">     let hdr = enumerator.getNext().QueryInterface(Ci.nsIMsgDBHdr);</span>
<a href="#l20.47"></a><span id="l20.47">     Assert.equal(hdr.subject, testSubjects[msgCount++]);</span>
<a href="#l20.48"></a><span id="l20.48">   }</span>
<a href="#l20.49"></a><span id="l20.49">   Assert.equal(msgCount, 2);</span>
<a href="#l20.50"></a><span id="l20.50">   gPOP3Pump = null;</span>
<a href="#l20.51"></a><span id="l20.51">   do_test_finished();</span>
<a href="#l20.52"></a><span id="l20.52"> }</span>
<a href="#l20.53"></a><span id="l20.53"> </span>
<a href="#l20.54"></a><span id="l20.54" class="difflineat">@@ -47,17 +45,17 @@ function createExpectedTemporaryFiles(nu</span>
<a href="#l20.55"></a><span id="l20.55">   function createTemporaryFile() {</span>
<a href="#l20.56"></a><span id="l20.56">     let file = Services.dirsvc.get(&quot;TmpD&quot;, Ci.nsIFile);</span>
<a href="#l20.57"></a><span id="l20.57">     file.append(&quot;newmsg&quot;);</span>
<a href="#l20.58"></a><span id="l20.58">     file.createUnique(Ci.nsIFile.NORMAL_FILE_TYPE, 0o600);</span>
<a href="#l20.59"></a><span id="l20.59">     return file;</span>
<a href="#l20.60"></a><span id="l20.60">   }</span>
<a href="#l20.61"></a><span id="l20.61"> </span>
<a href="#l20.62"></a><span id="l20.62">   let expectedFiles = [];</span>
<a href="#l20.63"></a><span id="l20.63" class="difflineminus">-  for (i = 0; i &lt; numFiles; i++)</span>
<a href="#l20.64"></a><span id="l20.64" class="difflineplus">+  for (let i = 0; i &lt; numFiles; i++)</span>
<a href="#l20.65"></a><span id="l20.65">     expectedFiles.push(createTemporaryFile());</span>
<a href="#l20.66"></a><span id="l20.66"> </span>
<a href="#l20.67"></a><span id="l20.67">   for (let expectedFile of expectedFiles)</span>
<a href="#l20.68"></a><span id="l20.68">     expectedFile.remove(false);</span>
<a href="#l20.69"></a><span id="l20.69"> </span>
<a href="#l20.70"></a><span id="l20.70">   return expectedFiles;</span>
<a href="#l20.71"></a><span id="l20.71"> }</span>
<a href="#l20.72"></a><span id="l20.72"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/mailnews/local/test/unit/test_pop3Duplicates.js</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/mailnews/local/test/unit/test_pop3Duplicates.js</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -1,38 +1,36 @@</span>
<a href="#l21.4"></a><span id="l21.4"> /**</span>
<a href="#l21.5"></a><span id="l21.5">  * The intent of this file is to test duplicate handling options</span>
<a href="#l21.6"></a><span id="l21.6">  * in the pop3 download code.</span>
<a href="#l21.7"></a><span id="l21.7">  */</span>
<a href="#l21.8"></a><span id="l21.8" class="difflineplus">+</span>
<a href="#l21.9"></a><span id="l21.9" class="difflineplus">+/* import-globals-from ../../../test/resources/POP3pump.js */</span>
<a href="#l21.10"></a><span id="l21.10"> load(&quot;../../../resources/POP3pump.js&quot;);</span>
<a href="#l21.11"></a><span id="l21.11" class="difflineminus">-ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l21.12"></a><span id="l21.12"> </span>
<a href="#l21.13"></a><span id="l21.13"> var testSubjects = [&quot;[Bug 397009] A filter will let me tag, but not untag&quot;,</span>
<a href="#l21.14"></a><span id="l21.14">                     &quot;Hello, did you receive my bugmail?&quot;];</span>
<a href="#l21.15"></a><span id="l21.15"> </span>
<a href="#l21.16"></a><span id="l21.16" class="difflineminus">-function run_test()</span>
<a href="#l21.17"></a><span id="l21.17" class="difflineminus">-{</span>
<a href="#l21.18"></a><span id="l21.18" class="difflineplus">+function run_test() {</span>
<a href="#l21.19"></a><span id="l21.19">   // Set duplicate action to be delete duplicates.</span>
<a href="#l21.20"></a><span id="l21.20">   Services.prefs.setIntPref(&quot;mail.server.default.dup_action&quot;,</span>
<a href="#l21.21"></a><span id="l21.21">                             Ci.nsIMsgIncomingServer.deleteDups);</span>
<a href="#l21.22"></a><span id="l21.22">   // add 3 messages, 2 of which are duplicates.</span>
<a href="#l21.23"></a><span id="l21.23">   gPOP3Pump.files = [&quot;../../../data/bugmail1&quot;,</span>
<a href="#l21.24"></a><span id="l21.24">                      &quot;../../../data/draft1&quot;,</span>
<a href="#l21.25"></a><span id="l21.25">                      &quot;../../../data/bugmail1&quot;];</span>
<a href="#l21.26"></a><span id="l21.26">   gPOP3Pump.onDone = continueTest;</span>
<a href="#l21.27"></a><span id="l21.27">   do_test_pending();</span>
<a href="#l21.28"></a><span id="l21.28">   gPOP3Pump.run();</span>
<a href="#l21.29"></a><span id="l21.29"> }</span>
<a href="#l21.30"></a><span id="l21.30"> </span>
<a href="#l21.31"></a><span id="l21.31" class="difflineminus">-function continueTest()</span>
<a href="#l21.32"></a><span id="l21.32" class="difflineminus">-{</span>
<a href="#l21.33"></a><span id="l21.33" class="difflineplus">+function continueTest() {</span>
<a href="#l21.34"></a><span id="l21.34">   // get message headers for the inbox folder</span>
<a href="#l21.35"></a><span id="l21.35">   let enumerator = localAccountUtils.inboxFolder.msgDatabase.EnumerateMessages();</span>
<a href="#l21.36"></a><span id="l21.36">   var msgCount = 0;</span>
<a href="#l21.37"></a><span id="l21.37" class="difflineminus">-  while (enumerator.hasMoreElements())</span>
<a href="#l21.38"></a><span id="l21.38" class="difflineminus">-  {</span>
<a href="#l21.39"></a><span id="l21.39" class="difflineplus">+  while (enumerator.hasMoreElements()) {</span>
<a href="#l21.40"></a><span id="l21.40">     let hdr = enumerator.getNext().QueryInterface(Ci.nsIMsgDBHdr);</span>
<a href="#l21.41"></a><span id="l21.41">     Assert.equal(hdr.subject, testSubjects[msgCount++]);</span>
<a href="#l21.42"></a><span id="l21.42">   }</span>
<a href="#l21.43"></a><span id="l21.43">   Assert.equal(msgCount, 2);</span>
<a href="#l21.44"></a><span id="l21.44">   gPOP3Pump = null;</span>
<a href="#l21.45"></a><span id="l21.45">   do_test_finished();</span>
<a href="#l21.46"></a><span id="l21.46"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/mailnews/local/test/unit/test_pop3FilterActions.js</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/mailnews/local/test/unit/test_pop3FilterActions.js</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -1,43 +1,39 @@</span>
<a href="#l22.4"></a><span id="l22.4"> /*</span>
<a href="#l22.5"></a><span id="l22.5">  * This file tests that a pop3 add tag filter writes the new tag</span>
<a href="#l22.6"></a><span id="l22.6">  * into the message keywords header. It also tests marking read,</span>
<a href="#l22.7"></a><span id="l22.7">  * and flagging messages.</span>
<a href="#l22.8"></a><span id="l22.8">  *</span>
<a href="#l22.9"></a><span id="l22.9">  * Original author: David Bienvenu &lt;dbienvenu@mozilla.com&gt;</span>
<a href="#l22.10"></a><span id="l22.10">  */</span>
<a href="#l22.11"></a><span id="l22.11"> </span>
<a href="#l22.12"></a><span id="l22.12" class="difflineminus">-</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineplus">+/* import-globals-from ../../../test/resources/POP3pump.js */</span>
<a href="#l22.14"></a><span id="l22.14"> load(&quot;../../../resources/POP3pump.js&quot;);</span>
<a href="#l22.15"></a><span id="l22.15" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l22.16"></a><span id="l22.16" class="difflineminus">-ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l22.17"></a><span id="l22.17" class="difflineminus">-ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l22.18"></a><span id="l22.18"> ChromeUtils.import(&quot;resource://testing-common/mailnews/PromiseTestUtils.jsm&quot;);</span>
<a href="#l22.19"></a><span id="l22.19"> </span>
<a href="#l22.20"></a><span id="l22.20"> var gFiles = [&quot;../../../data/bugmail10&quot;, &quot;../../../data/bugmail11&quot;];</span>
<a href="#l22.21"></a><span id="l22.21"> </span>
<a href="#l22.22"></a><span id="l22.22"> Services.prefs.setBoolPref(&quot;mail.server.default.leave_on_server&quot;, true);</span>
<a href="#l22.23"></a><span id="l22.23"> </span>
<a href="#l22.24"></a><span id="l22.24"> // Currently we have two mailbox storage formats.</span>
<a href="#l22.25"></a><span id="l22.25"> var gPluggableStores = [</span>
<a href="#l22.26"></a><span id="l22.26">   &quot;@mozilla.org/msgstore/berkeleystore;1&quot;,</span>
<a href="#l22.27"></a><span id="l22.27" class="difflineminus">-  &quot;@mozilla.org/msgstore/maildirstore;1&quot;</span>
<a href="#l22.28"></a><span id="l22.28" class="difflineplus">+  &quot;@mozilla.org/msgstore/maildirstore;1&quot;,</span>
<a href="#l22.29"></a><span id="l22.29"> ];</span>
<a href="#l22.30"></a><span id="l22.30"> </span>
<a href="#l22.31"></a><span id="l22.31"> // Map subject to previews using subject as the key.</span>
<a href="#l22.32"></a><span id="l22.32"> var previews = {</span>
<a href="#l22.33"></a><span id="l22.33" class="difflineminus">-&quot;[Bug 436880] IMAP itemDeleted and itemMoveCopyCompleted notifications quite broken&quot;: 'Do not reply to this email. You can add comments to this bug at https://bugzilla.mozilla.org/show_bug.cgi?id=436880 -- Configure bugmail: https://bugzilla.mozilla.org/userprefs.cgi?tab=email ------- You are receiving this mail because: -----',</span>
<a href="#l22.34"></a><span id="l22.34" class="difflineminus">-&quot;Bugzilla: confirm account creation&quot;: 'Bugzilla has received a request to create a user account using your email address (example@example.org). To confirm that you want to create an account using that email address, visit the following link: https://bugzilla.mozilla.org/token.cgi?t=xxx'</span>
<a href="#l22.35"></a><span id="l22.35" class="difflineminus">-}</span>
<a href="#l22.36"></a><span id="l22.36" class="difflineplus">+  &quot;[Bug 436880] IMAP itemDeleted and itemMoveCopyCompleted notifications quite broken&quot;: &quot;Do not reply to this email. You can add comments to this bug at https://bugzilla.mozilla.org/show_bug.cgi?id=436880 -- Configure bugmail: https://bugzilla.mozilla.org/userprefs.cgi?tab=email ------- You are receiving this mail because: -----&quot;,</span>
<a href="#l22.37"></a><span id="l22.37" class="difflineplus">+  &quot;Bugzilla: confirm account creation&quot;: &quot;Bugzilla has received a request to create a user account using your email address (example@example.org). To confirm that you want to create an account using that email address, visit the following link: https://bugzilla.mozilla.org/token.cgi?t=xxx&quot;,</span>
<a href="#l22.38"></a><span id="l22.38" class="difflineplus">+};</span>
<a href="#l22.39"></a><span id="l22.39"> </span>
<a href="#l22.40"></a><span id="l22.40"> var gFilter; // the test filter</span>
<a href="#l22.41"></a><span id="l22.41"> var gFilterList;</span>
<a href="#l22.42"></a><span id="l22.42" class="difflineminus">-var gTestArray =</span>
<a href="#l22.43"></a><span id="l22.43" class="difflineminus">-[</span>
<a href="#l22.44"></a><span id="l22.44" class="difflineplus">+var gTestArray = [</span>
<a href="#l22.45"></a><span id="l22.45">   function createFilters() {</span>
<a href="#l22.46"></a><span id="l22.46">     gFilterList = gPOP3Pump.fakeServer.getFilterList(null);</span>
<a href="#l22.47"></a><span id="l22.47">     gFilter = gFilterList.createFilter(&quot;AddKeyword&quot;);</span>
<a href="#l22.48"></a><span id="l22.48">     let searchTerm = gFilter.createTerm();</span>
<a href="#l22.49"></a><span id="l22.49">     searchTerm.matchAll = true;</span>
<a href="#l22.50"></a><span id="l22.50">     gFilter.appendTerm(searchTerm);</span>
<a href="#l22.51"></a><span id="l22.51">     let tagAction = gFilter.createAction();</span>
<a href="#l22.52"></a><span id="l22.52">     tagAction.type = Ci.nsMsgFilterAction.AddTag;</span>
<a href="#l22.53"></a><span id="l22.53" class="difflineat">@@ -87,67 +83,62 @@ var gTestArray =</span>
<a href="#l22.54"></a><span id="l22.54">     while (enumerator.hasMoreElements()) {</span>
<a href="#l22.55"></a><span id="l22.55">       let hdr = enumerator.getNext().QueryInterface(Ci.nsIMsgDBHdr);</span>
<a href="#l22.56"></a><span id="l22.56">       keys.push(hdr.messageKey);</span>
<a href="#l22.57"></a><span id="l22.57">       hdrs.push(hdr);</span>
<a href="#l22.58"></a><span id="l22.58">     }</span>
<a href="#l22.59"></a><span id="l22.59">     Assert.ok(!localAccountUtils.inboxFolder</span>
<a href="#l22.60"></a><span id="l22.60">                                 .fetchMsgPreviewText(keys, keys.length,</span>
<a href="#l22.61"></a><span id="l22.61">                                                      false, null));</span>
<a href="#l22.62"></a><span id="l22.62" class="difflineminus">-    let preview1 = hdrs[0].getStringProperty('preview');</span>
<a href="#l22.63"></a><span id="l22.63" class="difflineminus">-    let preview2 = hdrs[1].getStringProperty('preview');</span>
<a href="#l22.64"></a><span id="l22.64" class="difflineplus">+    let preview1 = hdrs[0].getStringProperty(&quot;preview&quot;);</span>
<a href="#l22.65"></a><span id="l22.65" class="difflineplus">+    let preview2 = hdrs[1].getStringProperty(&quot;preview&quot;);</span>
<a href="#l22.66"></a><span id="l22.66">     Assert.equal(preview1, previews[hdrs[0].subject]);</span>
<a href="#l22.67"></a><span id="l22.67">     Assert.equal(preview2, previews[hdrs[1].subject]);</span>
<a href="#l22.68"></a><span id="l22.68" class="difflineminus">-    Assert.equal(hdrs[0].getStringProperty('keywords'), &quot;TheTag&quot;);</span>
<a href="#l22.69"></a><span id="l22.69" class="difflineminus">-    Assert.equal(hdrs[1].getStringProperty('keywords'), &quot;TheTag&quot;);</span>
<a href="#l22.70"></a><span id="l22.70" class="difflineplus">+    Assert.equal(hdrs[0].getStringProperty(&quot;keywords&quot;), &quot;TheTag&quot;);</span>
<a href="#l22.71"></a><span id="l22.71" class="difflineplus">+    Assert.equal(hdrs[1].getStringProperty(&quot;keywords&quot;), &quot;TheTag&quot;);</span>
<a href="#l22.72"></a><span id="l22.72">     Assert.equal(hdrs[0].flags, Ci.nsMsgMessageFlags.Read |</span>
<a href="#l22.73"></a><span id="l22.73">                                 Ci.nsMsgMessageFlags.Marked);</span>
<a href="#l22.74"></a><span id="l22.74">     Assert.equal(hdrs[1].flags, Ci.nsMsgMessageFlags.Read |</span>
<a href="#l22.75"></a><span id="l22.75">                                 Ci.nsMsgMessageFlags.Marked);</span>
<a href="#l22.76"></a><span id="l22.76" class="difflineminus">-  }</span>
<a href="#l22.77"></a><span id="l22.77" class="difflineplus">+  },</span>
<a href="#l22.78"></a><span id="l22.78"> ];</span>
<a href="#l22.79"></a><span id="l22.79"> </span>
<a href="#l22.80"></a><span id="l22.80" class="difflineminus">-function folderCount(folder)</span>
<a href="#l22.81"></a><span id="l22.81" class="difflineminus">-{</span>
<a href="#l22.82"></a><span id="l22.82" class="difflineplus">+function folderCount(folder) {</span>
<a href="#l22.83"></a><span id="l22.83">   let enumerator = folder.msgDatabase.EnumerateMessages();</span>
<a href="#l22.84"></a><span id="l22.84">   let count = 0;</span>
<a href="#l22.85"></a><span id="l22.85" class="difflineminus">-  while (enumerator.hasMoreElements())</span>
<a href="#l22.86"></a><span id="l22.86" class="difflineminus">-  {</span>
<a href="#l22.87"></a><span id="l22.87" class="difflineplus">+  while (enumerator.hasMoreElements()) {</span>
<a href="#l22.88"></a><span id="l22.88">     count++;</span>
<a href="#l22.89"></a><span id="l22.89" class="difflineminus">-    let hdr = enumerator.getNext();</span>
<a href="#l22.90"></a><span id="l22.90" class="difflineplus">+    enumerator.getNext();</span>
<a href="#l22.91"></a><span id="l22.91">   }</span>
<a href="#l22.92"></a><span id="l22.92">   return count;</span>
<a href="#l22.93"></a><span id="l22.93"> }</span>
<a href="#l22.94"></a><span id="l22.94"> </span>
<a href="#l22.95"></a><span id="l22.95" class="difflineminus">-function setup_store(storeID)</span>
<a href="#l22.96"></a><span id="l22.96" class="difflineminus">-{</span>
<a href="#l22.97"></a><span id="l22.97" class="difflineplus">+function setup_store(storeID) {</span>
<a href="#l22.98"></a><span id="l22.98">   return function _setup_store() {</span>
<a href="#l22.99"></a><span id="l22.99">     // Initialize pop3Pump with correct mailbox format.</span>
<a href="#l22.100"></a><span id="l22.100">     gPOP3Pump.resetPluggableStore(storeID);</span>
<a href="#l22.101"></a><span id="l22.101"> </span>
<a href="#l22.102"></a><span id="l22.102">     // Set the default mailbox store.</span>
<a href="#l22.103"></a><span id="l22.103">     Services.prefs.setCharPref(&quot;mail.serverDefaultStoreContractID&quot;,</span>
<a href="#l22.104"></a><span id="l22.104">                                storeID);</span>
<a href="#l22.105"></a><span id="l22.105"> </span>
<a href="#l22.106"></a><span id="l22.106">     // Make sure we're not quarantining messages</span>
<a href="#l22.107"></a><span id="l22.107">     Services.prefs.setBoolPref(&quot;mailnews.downloadToTempFile&quot;, false);</span>
<a href="#l22.108"></a><span id="l22.108"> </span>
<a href="#l22.109"></a><span id="l22.109">     if (!localAccountUtils.inboxFolder)</span>
<a href="#l22.110"></a><span id="l22.110">       localAccountUtils.loadLocalMailAccount();</span>
<a href="#l22.111"></a><span id="l22.111" class="difflineminus">-  }</span>
<a href="#l22.112"></a><span id="l22.112" class="difflineplus">+  };</span>
<a href="#l22.113"></a><span id="l22.113"> }</span>
<a href="#l22.114"></a><span id="l22.114"> </span>
<a href="#l22.115"></a><span id="l22.115" class="difflineminus">-function run_test()</span>
<a href="#l22.116"></a><span id="l22.116" class="difflineminus">-{</span>
<a href="#l22.117"></a><span id="l22.117" class="difflineplus">+function run_test() {</span>
<a href="#l22.118"></a><span id="l22.118">   for (let store of gPluggableStores) {</span>
<a href="#l22.119"></a><span id="l22.119">     add_task(setup_store(store));</span>
<a href="#l22.120"></a><span id="l22.120">     gTestArray.forEach(x =&gt; add_task(x));</span>
<a href="#l22.121"></a><span id="l22.121">   }</span>
<a href="#l22.122"></a><span id="l22.122"> </span>
<a href="#l22.123"></a><span id="l22.123">   add_task(exitTest);</span>
<a href="#l22.124"></a><span id="l22.124">   run_next_test();</span>
<a href="#l22.125"></a><span id="l22.125"> }</span>
<a href="#l22.126"></a><span id="l22.126"> </span>
<a href="#l22.127"></a><span id="l22.127" class="difflineminus">-function exitTest()</span>
<a href="#l22.128"></a><span id="l22.128" class="difflineminus">-{</span>
<a href="#l22.129"></a><span id="l22.129" class="difflineplus">+function exitTest() {</span>
<a href="#l22.130"></a><span id="l22.130">   info(&quot;Exiting mail tests\n&quot;);</span>
<a href="#l22.131"></a><span id="l22.131">   gPOP3Pump = null;</span>
<a href="#l22.132"></a><span id="l22.132"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/mailnews/local/test/unit/test_pop3GSSAPIFail.js</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/mailnews/local/test/unit/test_pop3GSSAPIFail.js</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -13,59 +13,59 @@</span>
<a href="#l23.4"></a><span id="l23.4">  * of reality of the above cases.</span>
<a href="#l23.5"></a><span id="l23.5">  *</span>
<a href="#l23.6"></a><span id="l23.6">  * Actually, we (more precisely the OS GSSAPI lib) fail out of band</span>
<a href="#l23.7"></a><span id="l23.7">  * in the Kerberos protocol, before the AUTH GSSAPI command is even issued.</span>
<a href="#l23.8"></a><span id="l23.8">  *</span>
<a href="#l23.9"></a><span id="l23.9">  * @author Ben Bucksch</span>
<a href="#l23.10"></a><span id="l23.10">  */</span>
<a href="#l23.11"></a><span id="l23.11"> </span>
<a href="#l23.12"></a><span id="l23.12" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l23.13"></a><span id="l23.13" class="difflineminus">-</span>
<a href="#l23.14"></a><span id="l23.14"> var server;</span>
<a href="#l23.15"></a><span id="l23.15"> var daemon;</span>
<a href="#l23.16"></a><span id="l23.16"> var authSchemes;</span>
<a href="#l23.17"></a><span id="l23.17"> var incomingServer;</span>
<a href="#l23.18"></a><span id="l23.18"> var thisTest;</span>
<a href="#l23.19"></a><span id="l23.19" class="difflineminus">-var test = null;</span>
<a href="#l23.20"></a><span id="l23.20"> </span>
<a href="#l23.21"></a><span id="l23.21" class="difflineminus">-var tests = [</span>
<a href="#l23.22"></a><span id="l23.22" class="difflineminus">-  { title: &quot;GSSAPI auth, server with GSSAPI only&quot;,</span>
<a href="#l23.23"></a><span id="l23.23" class="difflineminus">-    clientAuthMethod : Ci.nsMsgAuthMethod.GSSAPI,</span>
<a href="#l23.24"></a><span id="l23.24" class="difflineminus">-    serverAuthMethods : [ &quot;GSSAPI&quot; ],</span>
<a href="#l23.25"></a><span id="l23.25" class="difflineminus">-    expectSuccess : false,</span>
<a href="#l23.26"></a><span id="l23.26" class="difflineminus">-    transaction: [ &quot;AUTH&quot;, &quot;CAPA&quot; ] },</span>
<a href="#l23.27"></a><span id="l23.27" class="difflineminus">-    // First GSSAPI step happens and fails out of band, thus no &quot;AUTH GSSAPI&quot;</span>
<a href="#l23.28"></a><span id="l23.28" class="difflineminus">-  { title: &quot;GSSAPI auth, server with GSSAPI and CRAM-MD5&quot;,</span>
<a href="#l23.29"></a><span id="l23.29" class="difflineminus">-    clientAuthMethod : Ci.nsMsgAuthMethod.GSSAPI,</span>
<a href="#l23.30"></a><span id="l23.30" class="difflineminus">-    serverAuthMethods : [ &quot;GSSAPI&quot;, &quot;CRAM-MD5&quot; ],</span>
<a href="#l23.31"></a><span id="l23.31" class="difflineminus">-    expectSuccess : false,</span>
<a href="#l23.32"></a><span id="l23.32" class="difflineminus">-    transaction: [ &quot;AUTH&quot;, &quot;CAPA&quot; ] },</span>
<a href="#l23.33"></a><span id="l23.33" class="difflineminus">-  { title: &quot;Any secure auth, server with GSSAPI only&quot;,</span>
<a href="#l23.34"></a><span id="l23.34" class="difflineminus">-    clientAuthMethod : Ci.nsMsgAuthMethod.secure,</span>
<a href="#l23.35"></a><span id="l23.35" class="difflineminus">-    serverAuthMethods : [ &quot;GSSAPI&quot; ],</span>
<a href="#l23.36"></a><span id="l23.36" class="difflineminus">-    expectSuccess : false,</span>
<a href="#l23.37"></a><span id="l23.37" class="difflineminus">-    transaction: [ &quot;AUTH&quot;, &quot;CAPA&quot; ] },</span>
<a href="#l23.38"></a><span id="l23.38" class="difflineminus">-  { title: &quot;Any secure auth, server with GSSAPI and CRAM-MD5&quot;,</span>
<a href="#l23.39"></a><span id="l23.39" class="difflineminus">-    clientAuthMethod : Ci.nsMsgAuthMethod.secure,</span>
<a href="#l23.40"></a><span id="l23.40" class="difflineminus">-    serverAuthMethods : [ &quot;GSSAPI&quot;, &quot;CRAM-MD5&quot; ],</span>
<a href="#l23.41"></a><span id="l23.41" class="difflineminus">-    expectSuccess : true,</span>
<a href="#l23.42"></a><span id="l23.42" class="difflineminus">-    transaction: [ &quot;AUTH&quot;, &quot;CAPA&quot;, &quot;AUTH CRAM-MD5&quot;, &quot;STAT&quot; ] },</span>
<a href="#l23.43"></a><span id="l23.43" class="difflineminus">-  { title: &quot;Encrypted password, server with GSSAPI and CRAM-MD5&quot;,</span>
<a href="#l23.44"></a><span id="l23.44" class="difflineminus">-    clientAuthMethod : Ci.nsMsgAuthMethod.passwordEncrypted,</span>
<a href="#l23.45"></a><span id="l23.45" class="difflineminus">-    serverAuthMethods : [ &quot;GSSAPI&quot;, &quot;CRAM-MD5&quot; ],</span>
<a href="#l23.46"></a><span id="l23.46" class="difflineminus">-    expectSuccess : true,</span>
<a href="#l23.47"></a><span id="l23.47" class="difflineminus">-    transaction: [ &quot;AUTH&quot;, &quot;CAPA&quot;, &quot;AUTH CRAM-MD5&quot;, &quot;STAT&quot; ] },</span>
<a href="#l23.48"></a><span id="l23.48" class="difflineminus">-];</span>
<a href="#l23.49"></a><span id="l23.49" class="difflineplus">+var tests = [{</span>
<a href="#l23.50"></a><span id="l23.50" class="difflineplus">+  title: &quot;GSSAPI auth, server with GSSAPI only&quot;,</span>
<a href="#l23.51"></a><span id="l23.51" class="difflineplus">+  clientAuthMethod: Ci.nsMsgAuthMethod.GSSAPI,</span>
<a href="#l23.52"></a><span id="l23.52" class="difflineplus">+  serverAuthMethods: [&quot;GSSAPI&quot;],</span>
<a href="#l23.53"></a><span id="l23.53" class="difflineplus">+  expectSuccess: false,</span>
<a href="#l23.54"></a><span id="l23.54" class="difflineplus">+  transaction: [&quot;AUTH&quot;, &quot;CAPA&quot;],</span>
<a href="#l23.55"></a><span id="l23.55" class="difflineplus">+}, {</span>
<a href="#l23.56"></a><span id="l23.56" class="difflineplus">+  // First GSSAPI step happens and fails out of band, thus no &quot;AUTH GSSAPI&quot;</span>
<a href="#l23.57"></a><span id="l23.57" class="difflineplus">+  title: &quot;GSSAPI auth, server with GSSAPI and CRAM-MD5&quot;,</span>
<a href="#l23.58"></a><span id="l23.58" class="difflineplus">+  clientAuthMethod: Ci.nsMsgAuthMethod.GSSAPI,</span>
<a href="#l23.59"></a><span id="l23.59" class="difflineplus">+  serverAuthMethods: [&quot;GSSAPI&quot;, &quot;CRAM-MD5&quot;],</span>
<a href="#l23.60"></a><span id="l23.60" class="difflineplus">+  expectSuccess: false,</span>
<a href="#l23.61"></a><span id="l23.61" class="difflineplus">+  transaction: [&quot;AUTH&quot;, &quot;CAPA&quot;],</span>
<a href="#l23.62"></a><span id="l23.62" class="difflineplus">+}, {</span>
<a href="#l23.63"></a><span id="l23.63" class="difflineplus">+  title: &quot;Any secure auth, server with GSSAPI only&quot;,</span>
<a href="#l23.64"></a><span id="l23.64" class="difflineplus">+  clientAuthMethod: Ci.nsMsgAuthMethod.secure,</span>
<a href="#l23.65"></a><span id="l23.65" class="difflineplus">+  serverAuthMethods: [&quot;GSSAPI&quot;],</span>
<a href="#l23.66"></a><span id="l23.66" class="difflineplus">+  expectSuccess: false,</span>
<a href="#l23.67"></a><span id="l23.67" class="difflineplus">+  transaction: [&quot;AUTH&quot;, &quot;CAPA&quot;],</span>
<a href="#l23.68"></a><span id="l23.68" class="difflineplus">+}, {</span>
<a href="#l23.69"></a><span id="l23.69" class="difflineplus">+  title: &quot;Any secure auth, server with GSSAPI and CRAM-MD5&quot;,</span>
<a href="#l23.70"></a><span id="l23.70" class="difflineplus">+  clientAuthMethod: Ci.nsMsgAuthMethod.secure,</span>
<a href="#l23.71"></a><span id="l23.71" class="difflineplus">+  serverAuthMethods: [&quot;GSSAPI&quot;, &quot;CRAM-MD5&quot;],</span>
<a href="#l23.72"></a><span id="l23.72" class="difflineplus">+  expectSuccess: true,</span>
<a href="#l23.73"></a><span id="l23.73" class="difflineplus">+  transaction: [&quot;AUTH&quot;, &quot;CAPA&quot;, &quot;AUTH CRAM-MD5&quot;, &quot;STAT&quot;],</span>
<a href="#l23.74"></a><span id="l23.74" class="difflineplus">+}, {</span>
<a href="#l23.75"></a><span id="l23.75" class="difflineplus">+  title: &quot;Encrypted password, server with GSSAPI and CRAM-MD5&quot;,</span>
<a href="#l23.76"></a><span id="l23.76" class="difflineplus">+  clientAuthMethod: Ci.nsMsgAuthMethod.passwordEncrypted,</span>
<a href="#l23.77"></a><span id="l23.77" class="difflineplus">+  serverAuthMethods: [&quot;GSSAPI&quot;, &quot;CRAM-MD5&quot;],</span>
<a href="#l23.78"></a><span id="l23.78" class="difflineplus">+  expectSuccess: true,</span>
<a href="#l23.79"></a><span id="l23.79" class="difflineplus">+  transaction: [&quot;AUTH&quot;, &quot;CAPA&quot;, &quot;AUTH CRAM-MD5&quot;, &quot;STAT&quot;],</span>
<a href="#l23.80"></a><span id="l23.80" class="difflineplus">+}];</span>
<a href="#l23.81"></a><span id="l23.81"> </span>
<a href="#l23.82"></a><span id="l23.82" class="difflineminus">-var urlListener =</span>
<a href="#l23.83"></a><span id="l23.83" class="difflineminus">-{</span>
<a href="#l23.84"></a><span id="l23.84" class="difflineminus">-  OnStartRunningUrl: function (url) {</span>
<a href="#l23.85"></a><span id="l23.85" class="difflineplus">+var urlListener = {</span>
<a href="#l23.86"></a><span id="l23.86" class="difflineplus">+  OnStartRunningUrl(url) {</span>
<a href="#l23.87"></a><span id="l23.87">   },</span>
<a href="#l23.88"></a><span id="l23.88" class="difflineminus">-  OnStopRunningUrl: function (url, result) {</span>
<a href="#l23.89"></a><span id="l23.89" class="difflineplus">+  OnStopRunningUrl(url, result) {</span>
<a href="#l23.90"></a><span id="l23.90">     try {</span>
<a href="#l23.91"></a><span id="l23.91">       if (thisTest.expectSuccess)</span>
<a href="#l23.92"></a><span id="l23.92">         Assert.equal(result, 0);</span>
<a href="#l23.93"></a><span id="l23.93">       else</span>
<a href="#l23.94"></a><span id="l23.94">         Assert.notEqual(result, 0);</span>
<a href="#l23.95"></a><span id="l23.95"> </span>
<a href="#l23.96"></a><span id="l23.96">       var transaction = server.playTransaction();</span>
<a href="#l23.97"></a><span id="l23.97">       do_check_transaction(transaction, thisTest.transaction);</span>
<a href="#l23.98"></a><span id="l23.98" class="difflineat">@@ -74,17 +74,17 @@ var urlListener =</span>
<a href="#l23.99"></a><span id="l23.99">     } catch (e) {</span>
<a href="#l23.100"></a><span id="l23.100">       server.stop();</span>
<a href="#l23.101"></a><span id="l23.101">       var thread = gThreadManager.currentThread;</span>
<a href="#l23.102"></a><span id="l23.102">       while (thread.hasPendingEvents())</span>
<a href="#l23.103"></a><span id="l23.103">         thread.processNextEvent(true);</span>
<a href="#l23.104"></a><span id="l23.104"> </span>
<a href="#l23.105"></a><span id="l23.105">       do_throw(e);</span>
<a href="#l23.106"></a><span id="l23.106">     }</span>
<a href="#l23.107"></a><span id="l23.107" class="difflineminus">-  }</span>
<a href="#l23.108"></a><span id="l23.108" class="difflineplus">+  },</span>
<a href="#l23.109"></a><span id="l23.109"> };</span>
<a href="#l23.110"></a><span id="l23.110"> </span>
<a href="#l23.111"></a><span id="l23.111"> function checkBusy() {</span>
<a href="#l23.112"></a><span id="l23.112">   if (tests.length == 0) {</span>
<a href="#l23.113"></a><span id="l23.113">     incomingServer.closeCachedConnections();</span>
<a href="#l23.114"></a><span id="l23.114"> </span>
<a href="#l23.115"></a><span id="l23.115">     // No more tests, let everything finish</span>
<a href="#l23.116"></a><span id="l23.116">     server.stop();</span>
<a href="#l23.117"></a><span id="l23.117" class="difflineat">@@ -134,65 +134,60 @@ function testNext() {</span>
<a href="#l23.118"></a><span id="l23.118">     server.performTest();</span>
<a href="#l23.119"></a><span id="l23.119">   } catch (e) {</span>
<a href="#l23.120"></a><span id="l23.120">     server.stop();</span>
<a href="#l23.121"></a><span id="l23.121">     do_throw(e);</span>
<a href="#l23.122"></a><span id="l23.122">   }</span>
<a href="#l23.123"></a><span id="l23.123"> }</span>
<a href="#l23.124"></a><span id="l23.124"> </span>
<a href="#l23.125"></a><span id="l23.125"> // &lt;copied from=&quot;head_maillocal.js::createPop3ServerAndLocalFolders()&quot;&gt;</span>
<a href="#l23.126"></a><span id="l23.126" class="difflineminus">-function createPop3Server()</span>
<a href="#l23.127"></a><span id="l23.127" class="difflineminus">-{</span>
<a href="#l23.128"></a><span id="l23.128" class="difflineplus">+function createPop3Server() {</span>
<a href="#l23.129"></a><span id="l23.129">   let incoming = MailServices.accounts.createIncomingServer(&quot;fred&quot;, &quot;localhost&quot;, &quot;pop3&quot;);</span>
<a href="#l23.130"></a><span id="l23.130">   incoming.port = server.port;</span>
<a href="#l23.131"></a><span id="l23.131">   incoming.password = &quot;wilma&quot;;</span>
<a href="#l23.132"></a><span id="l23.132">   return incoming;</span>
<a href="#l23.133"></a><span id="l23.133"> }</span>
<a href="#l23.134"></a><span id="l23.134" class="difflineminus">-//&lt;/copied&gt;</span>
<a href="#l23.135"></a><span id="l23.135" class="difflineplus">+// &lt;/copied&gt;</span>
<a href="#l23.136"></a><span id="l23.136"> </span>
<a href="#l23.137"></a><span id="l23.137" class="difflineminus">-function deletePop3Server()</span>
<a href="#l23.138"></a><span id="l23.138" class="difflineminus">-{</span>
<a href="#l23.139"></a><span id="l23.139" class="difflineplus">+function deletePop3Server() {</span>
<a href="#l23.140"></a><span id="l23.140">   if (!incomingServer)</span>
<a href="#l23.141"></a><span id="l23.141">     return;</span>
<a href="#l23.142"></a><span id="l23.142">   MailServices.accounts.removeIncomingServer(incomingServer, true);</span>
<a href="#l23.143"></a><span id="l23.143">   incomingServer = null;</span>
<a href="#l23.144"></a><span id="l23.144"> }</span>
<a href="#l23.145"></a><span id="l23.145"> </span>
<a href="#l23.146"></a><span id="l23.146" class="difflineminus">-function GSSAPIFail_handler(daemon)</span>
<a href="#l23.147"></a><span id="l23.147" class="difflineminus">-{</span>
<a href="#l23.148"></a><span id="l23.148" class="difflineminus">-  POP3_RFC5034_handler.call(this, daemon);</span>
<a href="#l23.149"></a><span id="l23.149" class="difflineplus">+function GSSAPIFail_handler(daemon_) {</span>
<a href="#l23.150"></a><span id="l23.150" class="difflineplus">+  POP3_RFC5034_handler.call(this, daemon_);</span>
<a href="#l23.151"></a><span id="l23.151"> }</span>
<a href="#l23.152"></a><span id="l23.152"> GSSAPIFail_handler.prototype = {</span>
<a href="#l23.153"></a><span id="l23.153" class="difflineminus">-  __proto__ : POP3_RFC5034_handler.prototype, // inherit</span>
<a href="#l23.154"></a><span id="l23.154" class="difflineminus">-  _needGSSAPI : false,</span>
<a href="#l23.155"></a><span id="l23.155" class="difflineplus">+  __proto__: POP3_RFC5034_handler.prototype, // inherit</span>
<a href="#l23.156"></a><span id="l23.156" class="difflineplus">+  _needGSSAPI: false,</span>
<a href="#l23.157"></a><span id="l23.157">   // kAuthSchemes will be set by test</span>
<a href="#l23.158"></a><span id="l23.158"> </span>
<a href="#l23.159"></a><span id="l23.159" class="difflineminus">-  AUTH: function(restLine)</span>
<a href="#l23.160"></a><span id="l23.160" class="difflineminus">-  {</span>
<a href="#l23.161"></a><span id="l23.161" class="difflineplus">+  AUTH(restLine) {</span>
<a href="#l23.162"></a><span id="l23.162">     var scheme = restLine.split(&quot; &quot;)[0];</span>
<a href="#l23.163"></a><span id="l23.163" class="difflineminus">-    if (scheme == &quot;GSSAPI&quot;)</span>
<a href="#l23.164"></a><span id="l23.164" class="difflineminus">-    {</span>
<a href="#l23.165"></a><span id="l23.165" class="difflineplus">+    if (scheme == &quot;GSSAPI&quot;) {</span>
<a href="#l23.166"></a><span id="l23.166">       this._multiline = true;</span>
<a href="#l23.167"></a><span id="l23.167">       this._needGSSAPI = true;</span>
<a href="#l23.168"></a><span id="l23.168">       return &quot;+&quot;;</span>
<a href="#l23.169"></a><span id="l23.169">     }</span>
<a href="#l23.170"></a><span id="l23.170">     return POP3_RFC5034_handler.prototype.AUTH.call(this, restLine); // call parent</span>
<a href="#l23.171"></a><span id="l23.171">   },</span>
<a href="#l23.172"></a><span id="l23.172" class="difflineminus">-  onMultiline: function(line) {</span>
<a href="#l23.173"></a><span id="l23.173" class="difflineplus">+  onMultiline(line) {</span>
<a href="#l23.174"></a><span id="l23.174">     if (this._needGSSAPI) {</span>
<a href="#l23.175"></a><span id="l23.175">       this._multiline = false;</span>
<a href="#l23.176"></a><span id="l23.176">       this._needGSSAPI = false;</span>
<a href="#l23.177"></a><span id="l23.177">       return &quot;-ERR hm.... shall I allow you? hm... NO.&quot;;</span>
<a href="#l23.178"></a><span id="l23.178">     }</span>
<a href="#l23.179"></a><span id="l23.179"> </span>
<a href="#l23.180"></a><span id="l23.180">     if (POP3_RFC5034_handler.prototype.onMultiline)</span>
<a href="#l23.181"></a><span id="l23.181">       return POP3_RFC5034_handler.prototype.onMultiline.call(this, line); // call parent</span>
<a href="#l23.182"></a><span id="l23.182">     return undefined;</span>
<a href="#l23.183"></a><span id="l23.183" class="difflineminus">-  }</span>
<a href="#l23.184"></a><span id="l23.184" class="difflineminus">-}</span>
<a href="#l23.185"></a><span id="l23.185" class="difflineplus">+  },</span>
<a href="#l23.186"></a><span id="l23.186" class="difflineplus">+};</span>
<a href="#l23.187"></a><span id="l23.187"> </span>
<a href="#l23.188"></a><span id="l23.188"> function run_test() {</span>
<a href="#l23.189"></a><span id="l23.189">   // Disable new mail notifications</span>
<a href="#l23.190"></a><span id="l23.190">   Services.prefs.setBoolPref(&quot;mail.biff.play_sound&quot;, false);</span>
<a href="#l23.191"></a><span id="l23.191">   Services.prefs.setBoolPref(&quot;mail.biff.show_alert&quot;, false);</span>
<a href="#l23.192"></a><span id="l23.192">   Services.prefs.setBoolPref(&quot;mail.biff.show_tray_icon&quot;, false);</span>
<a href="#l23.193"></a><span id="l23.193">   Services.prefs.setBoolPref(&quot;mail.biff.animate_dock_icon&quot;, false);</span>
<a href="#l23.194"></a><span id="l23.194"> </span>
<a href="#l23.195"></a><span id="l23.195" class="difflineat">@@ -200,15 +195,15 @@ function run_test() {</span>
<a href="#l23.196"></a><span id="l23.196">   function createHandler(d) {</span>
<a href="#l23.197"></a><span id="l23.197">     var handler = new GSSAPIFail_handler(d);</span>
<a href="#l23.198"></a><span id="l23.198">     handler.kAuthSchemes = authSchemes;</span>
<a href="#l23.199"></a><span id="l23.199">     return handler;</span>
<a href="#l23.200"></a><span id="l23.200">   }</span>
<a href="#l23.201"></a><span id="l23.201">   server = new nsMailServer(createHandler, daemon);</span>
<a href="#l23.202"></a><span id="l23.202">   server.start();</span>
<a href="#l23.203"></a><span id="l23.203"> </span>
<a href="#l23.204"></a><span id="l23.204" class="difflineminus">-  //incomingServer = createPop3ServerAndLocalFolders();</span>
<a href="#l23.205"></a><span id="l23.205" class="difflineplus">+  // incomingServer = createPop3ServerAndLocalFolders();</span>
<a href="#l23.206"></a><span id="l23.206">   localAccountUtils.loadLocalMailAccount();</span>
<a href="#l23.207"></a><span id="l23.207"> </span>
<a href="#l23.208"></a><span id="l23.208">   do_test_pending();</span>
<a href="#l23.209"></a><span id="l23.209"> </span>
<a href="#l23.210"></a><span id="l23.210">   testNext();</span>
<a href="#l23.211"></a><span id="l23.211"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/mailnews/local/test/unit/test_pop3GetNewMail.js</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/mailnews/local/test/unit/test_pop3GetNewMail.js</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -1,60 +1,58 @@</span>
<a href="#l24.4"></a><span id="l24.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l24.5"></a><span id="l24.5"> /**</span>
<a href="#l24.6"></a><span id="l24.6">  * Protocol tests for POP3.</span>
<a href="#l24.7"></a><span id="l24.7">  */</span>
<a href="#l24.8"></a><span id="l24.8" class="difflineminus">-var test = null;</span>
<a href="#l24.9"></a><span id="l24.9"> var server;</span>
<a href="#l24.10"></a><span id="l24.10"> var daemon;</span>
<a href="#l24.11"></a><span id="l24.11"> var incomingServer;</span>
<a href="#l24.12"></a><span id="l24.12"> var thisTest;</span>
<a href="#l24.13"></a><span id="l24.13"> </span>
<a href="#l24.14"></a><span id="l24.14" class="difflineminus">-var tests = [</span>
<a href="#l24.15"></a><span id="l24.15" class="difflineminus">-  { title: &quot;Get New Mail, No Messages&quot;,</span>
<a href="#l24.16"></a><span id="l24.16" class="difflineminus">-    messages: [],</span>
<a href="#l24.17"></a><span id="l24.17" class="difflineminus">-    transaction: [ &quot;AUTH&quot;, &quot;CAPA&quot;, &quot;AUTH PLAIN&quot;, &quot;STAT&quot; ] },</span>
<a href="#l24.18"></a><span id="l24.18" class="difflineminus">-  { title: &quot;Get New Mail, No Messages 2&quot;,</span>
<a href="#l24.19"></a><span id="l24.19" class="difflineminus">-    messages: [],</span>
<a href="#l24.20"></a><span id="l24.20" class="difflineminus">-    transaction: [ &quot;CAPA&quot;, &quot;AUTH PLAIN&quot;, &quot;STAT&quot; ] },</span>
<a href="#l24.21"></a><span id="l24.21" class="difflineminus">-  { title: &quot;Get New Mail, One Message&quot;,</span>
<a href="#l24.22"></a><span id="l24.22" class="difflineminus">-    messages: [&quot;message1.eml&quot;],</span>
<a href="#l24.23"></a><span id="l24.23" class="difflineminus">-    transaction: [ &quot;CAPA&quot;, &quot;AUTH PLAIN&quot;, &quot;STAT&quot;, &quot;LIST&quot;,</span>
<a href="#l24.24"></a><span id="l24.24" class="difflineminus">-                   &quot;UIDL&quot;, &quot;RETR 1&quot;, &quot;DELE 1&quot; ] }</span>
<a href="#l24.25"></a><span id="l24.25" class="difflineminus">-];</span>
<a href="#l24.26"></a><span id="l24.26" class="difflineplus">+var tests = [{</span>
<a href="#l24.27"></a><span id="l24.27" class="difflineplus">+  title: &quot;Get New Mail, No Messages&quot;,</span>
<a href="#l24.28"></a><span id="l24.28" class="difflineplus">+  messages: [],</span>
<a href="#l24.29"></a><span id="l24.29" class="difflineplus">+  transaction: [&quot;AUTH&quot;, &quot;CAPA&quot;, &quot;AUTH PLAIN&quot;, &quot;STAT&quot;],</span>
<a href="#l24.30"></a><span id="l24.30" class="difflineplus">+}, {</span>
<a href="#l24.31"></a><span id="l24.31" class="difflineplus">+  title: &quot;Get New Mail, No Messages 2&quot;,</span>
<a href="#l24.32"></a><span id="l24.32" class="difflineplus">+  messages: [],</span>
<a href="#l24.33"></a><span id="l24.33" class="difflineplus">+  transaction: [&quot;CAPA&quot;, &quot;AUTH PLAIN&quot;, &quot;STAT&quot;],</span>
<a href="#l24.34"></a><span id="l24.34" class="difflineplus">+}, {</span>
<a href="#l24.35"></a><span id="l24.35" class="difflineplus">+  title: &quot;Get New Mail, One Message&quot;,</span>
<a href="#l24.36"></a><span id="l24.36" class="difflineplus">+  messages: [&quot;message1.eml&quot;],</span>
<a href="#l24.37"></a><span id="l24.37" class="difflineplus">+  transaction: [&quot;CAPA&quot;, &quot;AUTH PLAIN&quot;, &quot;STAT&quot;, &quot;LIST&quot;, &quot;UIDL&quot;, &quot;RETR 1&quot;, &quot;DELE 1&quot;],</span>
<a href="#l24.38"></a><span id="l24.38" class="difflineplus">+}];</span>
<a href="#l24.39"></a><span id="l24.39"> </span>
<a href="#l24.40"></a><span id="l24.40" class="difflineminus">-var urlListener =</span>
<a href="#l24.41"></a><span id="l24.41" class="difflineminus">-{</span>
<a href="#l24.42"></a><span id="l24.42" class="difflineminus">-  OnStartRunningUrl: function (url) {</span>
<a href="#l24.43"></a><span id="l24.43" class="difflineplus">+var urlListener = {</span>
<a href="#l24.44"></a><span id="l24.44" class="difflineplus">+  OnStartRunningUrl(url) {</span>
<a href="#l24.45"></a><span id="l24.45">   },</span>
<a href="#l24.46"></a><span id="l24.46" class="difflineminus">-  OnStopRunningUrl: function (url, result) {</span>
<a href="#l24.47"></a><span id="l24.47" class="difflineplus">+  OnStopRunningUrl(url, result) {</span>
<a href="#l24.48"></a><span id="l24.48">     try {</span>
<a href="#l24.49"></a><span id="l24.49">       var transaction = server.playTransaction();</span>
<a href="#l24.50"></a><span id="l24.50"> </span>
<a href="#l24.51"></a><span id="l24.51">       do_check_transaction(transaction, thisTest.transaction);</span>
<a href="#l24.52"></a><span id="l24.52"> </span>
<a href="#l24.53"></a><span id="l24.53">       Assert.equal(localAccountUtils.inboxFolder.getTotalMessages(false),</span>
<a href="#l24.54"></a><span id="l24.54">                    thisTest.messages.length);</span>
<a href="#l24.55"></a><span id="l24.55"> </span>
<a href="#l24.56"></a><span id="l24.56">       Assert.equal(result, 0);</span>
<a href="#l24.57"></a><span id="l24.57" class="difflineminus">-    }</span>
<a href="#l24.58"></a><span id="l24.58" class="difflineminus">-    catch (e) {</span>
<a href="#l24.59"></a><span id="l24.59" class="difflineplus">+    } catch (e) {</span>
<a href="#l24.60"></a><span id="l24.60">       // If we have an error, clean up nicely before we throw it.</span>
<a href="#l24.61"></a><span id="l24.61">       server.stop();</span>
<a href="#l24.62"></a><span id="l24.62"> </span>
<a href="#l24.63"></a><span id="l24.63">       var thread = gThreadManager.currentThread;</span>
<a href="#l24.64"></a><span id="l24.64">       while (thread.hasPendingEvents())</span>
<a href="#l24.65"></a><span id="l24.65">         thread.processNextEvent(true);</span>
<a href="#l24.66"></a><span id="l24.66"> </span>
<a href="#l24.67"></a><span id="l24.67">       do_throw(e);</span>
<a href="#l24.68"></a><span id="l24.68">     }</span>
<a href="#l24.69"></a><span id="l24.69"> </span>
<a href="#l24.70"></a><span id="l24.70">     // Let OnStopRunningUrl return cleanly before doing anything else.</span>
<a href="#l24.71"></a><span id="l24.71">     do_timeout(0, checkBusy);</span>
<a href="#l24.72"></a><span id="l24.72" class="difflineminus">-  }</span>
<a href="#l24.73"></a><span id="l24.73" class="difflineplus">+  },</span>
<a href="#l24.74"></a><span id="l24.74"> };</span>
<a href="#l24.75"></a><span id="l24.75"> </span>
<a href="#l24.76"></a><span id="l24.76"> function checkBusy() {</span>
<a href="#l24.77"></a><span id="l24.77">   if (tests.length == 0) {</span>
<a href="#l24.78"></a><span id="l24.78">     incomingServer.closeCachedConnections();</span>
<a href="#l24.79"></a><span id="l24.79"> </span>
<a href="#l24.80"></a><span id="l24.80">     // No more tests, let everything finish</span>
<a href="#l24.81"></a><span id="l24.81">     server.stop();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1" class="difflineminus">--- a/mailnews/local/test/unit/test_pop3MoveFilter.js</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineplus">+++ b/mailnews/local/test/unit/test_pop3MoveFilter.js</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineat">@@ -1,44 +1,40 @@</span>
<a href="#l25.4"></a><span id="l25.4"> /*</span>
<a href="#l25.5"></a><span id="l25.5">  * This file tests that a pop3 move filter doesn't leave the</span>
<a href="#l25.6"></a><span id="l25.6">  * original message in the inbox.</span>
<a href="#l25.7"></a><span id="l25.7">  *</span>
<a href="#l25.8"></a><span id="l25.8">  * Original author: David Bienvenu &lt;dbienvenu@mozilla.com&gt;</span>
<a href="#l25.9"></a><span id="l25.9">  */</span>
<a href="#l25.10"></a><span id="l25.10"> </span>
<a href="#l25.11"></a><span id="l25.11" class="difflineminus">-</span>
<a href="#l25.12"></a><span id="l25.12" class="difflineplus">+/* import-globals-from ../../../test/resources/POP3pump.js */</span>
<a href="#l25.13"></a><span id="l25.13"> load(&quot;../../../resources/POP3pump.js&quot;);</span>
<a href="#l25.14"></a><span id="l25.14" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l25.15"></a><span id="l25.15" class="difflineminus">-ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l25.16"></a><span id="l25.16" class="difflineminus">-ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l25.17"></a><span id="l25.17"> ChromeUtils.import(&quot;resource://testing-common/mailnews/PromiseTestUtils.jsm&quot;);</span>
<a href="#l25.18"></a><span id="l25.18"> </span>
<a href="#l25.19"></a><span id="l25.19"> var gFiles = [&quot;../../../data/bugmail10&quot;, &quot;../../../data/bugmail11&quot;];</span>
<a href="#l25.20"></a><span id="l25.20"> </span>
<a href="#l25.21"></a><span id="l25.21"> // make sure limiting download size doesn't causes issues with move filters.</span>
<a href="#l25.22"></a><span id="l25.22"> Services.prefs.setBoolPref(&quot;mail.server.default.limit_offline_message_size&quot;, true);</span>
<a href="#l25.23"></a><span id="l25.23"> Services.prefs.setBoolPref(&quot;mail.server.default.leave_on_server&quot;, true);</span>
<a href="#l25.24"></a><span id="l25.24"> </span>
<a href="#l25.25"></a><span id="l25.25"> // Currently we have two mailbox storage formats.</span>
<a href="#l25.26"></a><span id="l25.26"> var gPluggableStores = [</span>
<a href="#l25.27"></a><span id="l25.27">   &quot;@mozilla.org/msgstore/berkeleystore;1&quot;,</span>
<a href="#l25.28"></a><span id="l25.28" class="difflineminus">-  &quot;@mozilla.org/msgstore/maildirstore;1&quot;</span>
<a href="#l25.29"></a><span id="l25.29" class="difflineplus">+  &quot;@mozilla.org/msgstore/maildirstore;1&quot;,</span>
<a href="#l25.30"></a><span id="l25.30"> ];</span>
<a href="#l25.31"></a><span id="l25.31"> </span>
<a href="#l25.32"></a><span id="l25.32"> var previews = {</span>
<a href="#l25.33"></a><span id="l25.33" class="difflineminus">-&quot;[Bug 436880] IMAP itemDeleted and itemMoveCopyCompleted notifications quite broken&quot;: 'Do not reply to this email. You can add comments to this bug at https://bugzilla.mozilla.org/show_bug.cgi?id=436880 -- Configure bugmail: https://bugzilla.mozilla.org/userprefs.cgi?tab=email ------- You are receiving this mail because: -----',</span>
<a href="#l25.34"></a><span id="l25.34" class="difflineminus">-&quot;Bugzilla: confirm account creation&quot;: 'Bugzilla has received a request to create a user account using your email address (example@example.org). To confirm that you want to create an account using that email address, visit the following link: https://bugzilla.mozilla.org/token.cgi?t=xxx'</span>
<a href="#l25.35"></a><span id="l25.35" class="difflineplus">+&quot;[Bug 436880] IMAP itemDeleted and itemMoveCopyCompleted notifications quite broken&quot;: &quot;Do not reply to this email. You can add comments to this bug at https://bugzilla.mozilla.org/show_bug.cgi?id=436880 -- Configure bugmail: https://bugzilla.mozilla.org/userprefs.cgi?tab=email ------- You are receiving this mail because: -----&quot;,</span>
<a href="#l25.36"></a><span id="l25.36" class="difflineplus">+&quot;Bugzilla: confirm account creation&quot;: &quot;Bugzilla has received a request to create a user account using your email address (example@example.org). To confirm that you want to create an account using that email address, visit the following link: https://bugzilla.mozilla.org/token.cgi?t=xxx&quot;,</span>
<a href="#l25.37"></a><span id="l25.37"> };</span>
<a href="#l25.38"></a><span id="l25.38"> </span>
<a href="#l25.39"></a><span id="l25.39"> var gMoveFolder;</span>
<a href="#l25.40"></a><span id="l25.40"> var gFilter; // the test filter</span>
<a href="#l25.41"></a><span id="l25.41"> var gFilterList;</span>
<a href="#l25.42"></a><span id="l25.42" class="difflineminus">-var gTestArray =</span>
<a href="#l25.43"></a><span id="l25.43" class="difflineminus">-[</span>
<a href="#l25.44"></a><span id="l25.44" class="difflineplus">+var gTestArray = [</span>
<a href="#l25.45"></a><span id="l25.45">   function createFilters() {</span>
<a href="#l25.46"></a><span id="l25.46">     gFilterList = gPOP3Pump.fakeServer.getFilterList(null);</span>
<a href="#l25.47"></a><span id="l25.47">     gFilter = gFilterList.createFilter(&quot;MoveAll&quot;);</span>
<a href="#l25.48"></a><span id="l25.48">     let searchTerm = gFilter.createTerm();</span>
<a href="#l25.49"></a><span id="l25.49">     searchTerm.matchAll = true;</span>
<a href="#l25.50"></a><span id="l25.50">     gFilter.appendTerm(searchTerm);</span>
<a href="#l25.51"></a><span id="l25.51">     let moveAction = gFilter.createAction();</span>
<a href="#l25.52"></a><span id="l25.52">     moveAction.type = Ci.nsMsgFilterAction.MoveToFolder;</span>
<a href="#l25.53"></a><span id="l25.53" class="difflineat">@@ -62,80 +58,74 @@ var gTestArray =</span>
<a href="#l25.54"></a><span id="l25.54">     // the mail.</span>
<a href="#l25.55"></a><span id="l25.55">     localAccountUtils.inboxFolder.msgDatabase.summaryValid = false;</span>
<a href="#l25.56"></a><span id="l25.56">     localAccountUtils.inboxFolder.msgDatabase = null;</span>
<a href="#l25.57"></a><span id="l25.57">     localAccountUtils.inboxFolder.ForceDBClosed();</span>
<a href="#l25.58"></a><span id="l25.58">     let promiseUrlListener = new PromiseTestUtils.PromiseUrlListener();</span>
<a href="#l25.59"></a><span id="l25.59">     try {</span>
<a href="#l25.60"></a><span id="l25.60">       localAccountUtils.inboxFolder</span>
<a href="#l25.61"></a><span id="l25.61">                        .getDatabaseWithReparse(promiseUrlListener, null);</span>
<a href="#l25.62"></a><span id="l25.62" class="difflineminus">-    } catch(ex) {</span>
<a href="#l25.63"></a><span id="l25.63" class="difflineplus">+    } catch (ex) {</span>
<a href="#l25.64"></a><span id="l25.64">       await promiseUrlListener.promise;</span>
<a href="#l25.65"></a><span id="l25.65">       Assert.ok(ex.result == Cr.NS_ERROR_NOT_INITIALIZED);</span>
<a href="#l25.66"></a><span id="l25.66">       return;</span>
<a href="#l25.67"></a><span id="l25.67">     }</span>
<a href="#l25.68"></a><span id="l25.68">     // This statement isn't reached since the error is thrown.</span>
<a href="#l25.69"></a><span id="l25.69">     Assert.ok(false);</span>
<a href="#l25.70"></a><span id="l25.70">   },</span>
<a href="#l25.71"></a><span id="l25.71">   function verifyMessages() {</span>
<a href="#l25.72"></a><span id="l25.72">     let hdrs = [];</span>
<a href="#l25.73"></a><span id="l25.73">     let keys = [];</span>
<a href="#l25.74"></a><span id="l25.74">     let enumerator = gMoveFolder.msgDatabase.EnumerateMessages();</span>
<a href="#l25.75"></a><span id="l25.75" class="difflineminus">-    while (enumerator.hasMoreElements())</span>
<a href="#l25.76"></a><span id="l25.76" class="difflineminus">-    {</span>
<a href="#l25.77"></a><span id="l25.77" class="difflineplus">+    while (enumerator.hasMoreElements()) {</span>
<a href="#l25.78"></a><span id="l25.78">       let hdr = enumerator.getNext().QueryInterface(Ci.nsIMsgDBHdr);</span>
<a href="#l25.79"></a><span id="l25.79">       keys.push(hdr.messageKey);</span>
<a href="#l25.80"></a><span id="l25.80">       hdrs.push(hdr);</span>
<a href="#l25.81"></a><span id="l25.81">     }</span>
<a href="#l25.82"></a><span id="l25.82">     Assert.ok(!gMoveFolder.fetchMsgPreviewText(keys, keys.length, false,</span>
<a href="#l25.83"></a><span id="l25.83">                                                null));</span>
<a href="#l25.84"></a><span id="l25.84" class="difflineminus">-    Assert.equal(hdrs[0].getStringProperty('preview'), previews[hdrs[0].subject]);</span>
<a href="#l25.85"></a><span id="l25.85" class="difflineminus">-    Assert.equal(hdrs[1].getStringProperty('preview'), previews[hdrs[1].subject]);</span>
<a href="#l25.86"></a><span id="l25.86" class="difflineplus">+    Assert.equal(hdrs[0].getStringProperty(&quot;preview&quot;), previews[hdrs[0].subject]);</span>
<a href="#l25.87"></a><span id="l25.87" class="difflineplus">+    Assert.equal(hdrs[1].getStringProperty(&quot;preview&quot;), previews[hdrs[1].subject]);</span>
<a href="#l25.88"></a><span id="l25.88">   },</span>
<a href="#l25.89"></a><span id="l25.89"> ];</span>
<a href="#l25.90"></a><span id="l25.90"> </span>
<a href="#l25.91"></a><span id="l25.91" class="difflineminus">-function folderCount(folder)</span>
<a href="#l25.92"></a><span id="l25.92" class="difflineminus">-{</span>
<a href="#l25.93"></a><span id="l25.93" class="difflineplus">+function folderCount(folder) {</span>
<a href="#l25.94"></a><span id="l25.94">   let enumerator = folder.msgDatabase.EnumerateMessages();</span>
<a href="#l25.95"></a><span id="l25.95">   let count = 0;</span>
<a href="#l25.96"></a><span id="l25.96" class="difflineminus">-  while (enumerator.hasMoreElements())</span>
<a href="#l25.97"></a><span id="l25.97" class="difflineminus">-  {</span>
<a href="#l25.98"></a><span id="l25.98" class="difflineplus">+  while (enumerator.hasMoreElements()) {</span>
<a href="#l25.99"></a><span id="l25.99">     count++;</span>
<a href="#l25.100"></a><span id="l25.100" class="difflineminus">-    let hdr = enumerator.getNext();</span>
<a href="#l25.101"></a><span id="l25.101" class="difflineplus">+    enumerator.getNext();</span>
<a href="#l25.102"></a><span id="l25.102">   }</span>
<a href="#l25.103"></a><span id="l25.103">   return count;</span>
<a href="#l25.104"></a><span id="l25.104"> }</span>
<a href="#l25.105"></a><span id="l25.105"> </span>
<a href="#l25.106"></a><span id="l25.106" class="difflineminus">-function setup_store(storeID)</span>
<a href="#l25.107"></a><span id="l25.107" class="difflineminus">-{</span>
<a href="#l25.108"></a><span id="l25.108" class="difflineplus">+function setup_store(storeID) {</span>
<a href="#l25.109"></a><span id="l25.109">   return function _setup_store() {</span>
<a href="#l25.110"></a><span id="l25.110">     // Reset pop3Pump with correct mailbox format.</span>
<a href="#l25.111"></a><span id="l25.111">     gPOP3Pump.resetPluggableStore(storeID);</span>
<a href="#l25.112"></a><span id="l25.112"> </span>
<a href="#l25.113"></a><span id="l25.113">     // Make sure we're not quarantining messages</span>
<a href="#l25.114"></a><span id="l25.114">     Services.prefs.setBoolPref(&quot;mailnews.downloadToTempFile&quot;, false);</span>
<a href="#l25.115"></a><span id="l25.115"> </span>
<a href="#l25.116"></a><span id="l25.116">     if (!localAccountUtils.inboxFolder)</span>
<a href="#l25.117"></a><span id="l25.117">       localAccountUtils.loadLocalMailAccount();</span>
<a href="#l25.118"></a><span id="l25.118"> </span>
<a href="#l25.119"></a><span id="l25.119">     gMoveFolder = localAccountUtils.rootFolder</span>
<a href="#l25.120"></a><span id="l25.120">                                    .createLocalSubfolder(&quot;MoveFolder&quot;);</span>
<a href="#l25.121"></a><span id="l25.121" class="difflineminus">-  }</span>
<a href="#l25.122"></a><span id="l25.122" class="difflineplus">+  };</span>
<a href="#l25.123"></a><span id="l25.123"> }</span>
<a href="#l25.124"></a><span id="l25.124"> </span>
<a href="#l25.125"></a><span id="l25.125" class="difflineminus">-function run_test()</span>
<a href="#l25.126"></a><span id="l25.126" class="difflineminus">-{</span>
<a href="#l25.127"></a><span id="l25.127" class="difflineplus">+function run_test() {</span>
<a href="#l25.128"></a><span id="l25.128">   for (let store of gPluggableStores) {</span>
<a href="#l25.129"></a><span id="l25.129">     add_task(setup_store(store));</span>
<a href="#l25.130"></a><span id="l25.130">     gTestArray.forEach(x =&gt; add_task(x));</span>
<a href="#l25.131"></a><span id="l25.131">   }</span>
<a href="#l25.132"></a><span id="l25.132"> </span>
<a href="#l25.133"></a><span id="l25.133">   add_task(exitTest);</span>
<a href="#l25.134"></a><span id="l25.134">   run_next_test();</span>
<a href="#l25.135"></a><span id="l25.135"> }</span>
<a href="#l25.136"></a><span id="l25.136"> </span>
<a href="#l25.137"></a><span id="l25.137" class="difflineminus">-function exitTest()</span>
<a href="#l25.138"></a><span id="l25.138" class="difflineminus">-{</span>
<a href="#l25.139"></a><span id="l25.139" class="difflineplus">+function exitTest() {</span>
<a href="#l25.140"></a><span id="l25.140">   // Cleanup and exit the test.</span>
<a href="#l25.141"></a><span id="l25.141">   info(&quot;Exiting mail tests\n&quot;);</span>
<a href="#l25.142"></a><span id="l25.142">   gPOP3Pump = null;</span>
<a href="#l25.143"></a><span id="l25.143"> }</span>
<a href="#l25.144"></a><span id="l25.144"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1" class="difflineminus">--- a/mailnews/local/test/unit/test_pop3MoveFilter2.js</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineplus">+++ b/mailnews/local/test/unit/test_pop3MoveFilter2.js</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineat">@@ -1,37 +1,34 @@</span>
<a href="#l26.4"></a><span id="l26.4"> /*</span>
<a href="#l26.5"></a><span id="l26.5">  * This file tests that a pop3 move filter doesn't reuse msg hdr</span>
<a href="#l26.6"></a><span id="l26.6">  * info from previous moves.</span>
<a href="#l26.7"></a><span id="l26.7">  *</span>
<a href="#l26.8"></a><span id="l26.8">  * Original author: David Bienvenu &lt;dbienvenu@mozilla.com&gt;</span>
<a href="#l26.9"></a><span id="l26.9">  */</span>
<a href="#l26.10"></a><span id="l26.10"> </span>
<a href="#l26.11"></a><span id="l26.11"> </span>
<a href="#l26.12"></a><span id="l26.12" class="difflineplus">+/* import-globals-from ../../../test/resources/POP3pump.js */</span>
<a href="#l26.13"></a><span id="l26.13"> load(&quot;../../../resources/POP3pump.js&quot;);</span>
<a href="#l26.14"></a><span id="l26.14" class="difflineminus">-ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l26.15"></a><span id="l26.15" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l26.16"></a><span id="l26.16" class="difflineminus">-ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l26.17"></a><span id="l26.17"> var gFiles = [&quot;../../../data/bugmail10&quot;, &quot;../../../data/basic1&quot;];</span>
<a href="#l26.18"></a><span id="l26.18"> </span>
<a href="#l26.19"></a><span id="l26.19"> Services.prefs.setBoolPref(&quot;mail.server.default.leave_on_server&quot;, true);</span>
<a href="#l26.20"></a><span id="l26.20"> </span>
<a href="#l26.21"></a><span id="l26.21"> // Currently we have two mailbox storage formats.</span>
<a href="#l26.22"></a><span id="l26.22"> var gPluggableStores = [</span>
<a href="#l26.23"></a><span id="l26.23">   &quot;@mozilla.org/msgstore/berkeleystore;1&quot;,</span>
<a href="#l26.24"></a><span id="l26.24" class="difflineminus">-  &quot;@mozilla.org/msgstore/maildirstore;1&quot;</span>
<a href="#l26.25"></a><span id="l26.25" class="difflineplus">+  &quot;@mozilla.org/msgstore/maildirstore;1&quot;,</span>
<a href="#l26.26"></a><span id="l26.26"> ];</span>
<a href="#l26.27"></a><span id="l26.27" class="difflineminus">-var basic1_preview = 'Hello, world!';</span>
<a href="#l26.28"></a><span id="l26.28" class="difflineminus">-var bugmail10_preview = 'Do not reply to this email. You can add comments to this bug at https://bugzilla.mozilla.org/show_bug.cgi?id=436880 -- Configure bugmail: https://bugzilla.mozilla.org/userprefs.cgi?tab=email ------- You are receiving this mail because: -----';</span>
<a href="#l26.29"></a><span id="l26.29" class="difflineplus">+var basic1_preview = &quot;Hello, world!&quot;;</span>
<a href="#l26.30"></a><span id="l26.30" class="difflineplus">+var bugmail10_preview = &quot;Do not reply to this email. You can add comments to this bug at https://bugzilla.mozilla.org/show_bug.cgi?id=436880 -- Configure bugmail: https://bugzilla.mozilla.org/userprefs.cgi?tab=email ------- You are receiving this mail because: -----&quot;;</span>
<a href="#l26.31"></a><span id="l26.31"> </span>
<a href="#l26.32"></a><span id="l26.32"> var gMoveFolder;</span>
<a href="#l26.33"></a><span id="l26.33"> var gFilter; // the test filter</span>
<a href="#l26.34"></a><span id="l26.34"> var gFilterList;</span>
<a href="#l26.35"></a><span id="l26.35" class="difflineminus">-var gTestArray =</span>
<a href="#l26.36"></a><span id="l26.36" class="difflineminus">-[</span>
<a href="#l26.37"></a><span id="l26.37" class="difflineplus">+var gTestArray = [</span>
<a href="#l26.38"></a><span id="l26.38">   function createFilters() {</span>
<a href="#l26.39"></a><span id="l26.39">     gFilterList = gPOP3Pump.fakeServer.getFilterList(null);</span>
<a href="#l26.40"></a><span id="l26.40">     // create a cc filter which will match the first message but not the second.</span>
<a href="#l26.41"></a><span id="l26.41">     gFilter = gFilterList.createFilter(&quot;MoveCc&quot;);</span>
<a href="#l26.42"></a><span id="l26.42">     let searchTerm = gFilter.createTerm();</span>
<a href="#l26.43"></a><span id="l26.43">     searchTerm.attrib = Ci.nsMsgSearchAttrib.CC;</span>
<a href="#l26.44"></a><span id="l26.44">     searchTerm.op = Ci.nsMsgSearchOp.Contains;</span>
<a href="#l26.45"></a><span id="l26.45">     var oldValue = searchTerm.value;</span>
<a href="#l26.46"></a><span id="l26.46" class="difflineat">@@ -62,71 +59,66 @@ var gTestArray =</span>
<a href="#l26.47"></a><span id="l26.47">     let hdrs = [];</span>
<a href="#l26.48"></a><span id="l26.48">     let keys = [];</span>
<a href="#l26.49"></a><span id="l26.49">     let enumerator = gMoveFolder.msgDatabase.EnumerateMessages();</span>
<a href="#l26.50"></a><span id="l26.50">     let hdr = enumerator.getNext().QueryInterface(Ci.nsIMsgDBHdr);</span>
<a href="#l26.51"></a><span id="l26.51">     keys.push(hdr.messageKey);</span>
<a href="#l26.52"></a><span id="l26.52">     hdrs.push(hdr);</span>
<a href="#l26.53"></a><span id="l26.53">     Assert.ok(!gMoveFolder.fetchMsgPreviewText(keys, keys.length,</span>
<a href="#l26.54"></a><span id="l26.54">                                                false, null));</span>
<a href="#l26.55"></a><span id="l26.55" class="difflineminus">-    Assert.equal(hdrs[0].getStringProperty('preview'), bugmail10_preview);</span>
<a href="#l26.56"></a><span id="l26.56" class="difflineplus">+    Assert.equal(hdrs[0].getStringProperty(&quot;preview&quot;), bugmail10_preview);</span>
<a href="#l26.57"></a><span id="l26.57">     // check inbox message</span>
<a href="#l26.58"></a><span id="l26.58">     hdrs = [];</span>
<a href="#l26.59"></a><span id="l26.59">     keys = [];</span>
<a href="#l26.60"></a><span id="l26.60">     enumerator = localAccountUtils.inboxFolder.msgDatabase.EnumerateMessages();</span>
<a href="#l26.61"></a><span id="l26.61">     hdr = enumerator.getNext().QueryInterface(Ci.nsIMsgDBHdr);</span>
<a href="#l26.62"></a><span id="l26.62">     keys.push(hdr.messageKey);</span>
<a href="#l26.63"></a><span id="l26.63">     hdrs.push(hdr);</span>
<a href="#l26.64"></a><span id="l26.64">     Assert.ok(!localAccountUtils.inboxFolder</span>
<a href="#l26.65"></a><span id="l26.65">                                 .fetchMsgPreviewText(keys, keys.length,</span>
<a href="#l26.66"></a><span id="l26.66">                                                      false, null));</span>
<a href="#l26.67"></a><span id="l26.67" class="difflineminus">-    Assert.equal(hdrs[0].getStringProperty('preview'), basic1_preview);</span>
<a href="#l26.68"></a><span id="l26.68" class="difflineminus">-  }</span>
<a href="#l26.69"></a><span id="l26.69" class="difflineplus">+    Assert.equal(hdrs[0].getStringProperty(&quot;preview&quot;), basic1_preview);</span>
<a href="#l26.70"></a><span id="l26.70" class="difflineplus">+  },</span>
<a href="#l26.71"></a><span id="l26.71"> ];</span>
<a href="#l26.72"></a><span id="l26.72"> </span>
<a href="#l26.73"></a><span id="l26.73" class="difflineminus">-function folderCount(folder)</span>
<a href="#l26.74"></a><span id="l26.74" class="difflineminus">-{</span>
<a href="#l26.75"></a><span id="l26.75" class="difflineplus">+function folderCount(folder) {</span>
<a href="#l26.76"></a><span id="l26.76">   let enumerator = folder.msgDatabase.EnumerateMessages();</span>
<a href="#l26.77"></a><span id="l26.77">   let count = 0;</span>
<a href="#l26.78"></a><span id="l26.78" class="difflineminus">-  while (enumerator.hasMoreElements())</span>
<a href="#l26.79"></a><span id="l26.79" class="difflineminus">-  {</span>
<a href="#l26.80"></a><span id="l26.80" class="difflineplus">+  while (enumerator.hasMoreElements()) {</span>
<a href="#l26.81"></a><span id="l26.81">     count++;</span>
<a href="#l26.82"></a><span id="l26.82" class="difflineminus">-    let hdr = enumerator.getNext();</span>
<a href="#l26.83"></a><span id="l26.83" class="difflineplus">+    enumerator.getNext();</span>
<a href="#l26.84"></a><span id="l26.84">   }</span>
<a href="#l26.85"></a><span id="l26.85">   return count;</span>
<a href="#l26.86"></a><span id="l26.86"> }</span>
<a href="#l26.87"></a><span id="l26.87"> </span>
<a href="#l26.88"></a><span id="l26.88" class="difflineminus">-function setup_store(storeID)</span>
<a href="#l26.89"></a><span id="l26.89" class="difflineminus">-{</span>
<a href="#l26.90"></a><span id="l26.90" class="difflineplus">+function setup_store(storeID) {</span>
<a href="#l26.91"></a><span id="l26.91">   return function _setup_store() {</span>
<a href="#l26.92"></a><span id="l26.92">     // Initialize pop3Pump with correct mailbox format.</span>
<a href="#l26.93"></a><span id="l26.93">     gPOP3Pump.resetPluggableStore(storeID);</span>
<a href="#l26.94"></a><span id="l26.94"> </span>
<a href="#l26.95"></a><span id="l26.95">     // Set the default mailbox store.</span>
<a href="#l26.96"></a><span id="l26.96">     Services.prefs.setCharPref(&quot;mail.serverDefaultStoreContractID&quot;,</span>
<a href="#l26.97"></a><span id="l26.97">                                storeID);</span>
<a href="#l26.98"></a><span id="l26.98"> </span>
<a href="#l26.99"></a><span id="l26.99">     // Make sure we're not quarantining messages</span>
<a href="#l26.100"></a><span id="l26.100">     Services.prefs.setBoolPref(&quot;mailnews.downloadToTempFile&quot;, false);</span>
<a href="#l26.101"></a><span id="l26.101">     if (!localAccountUtils.inboxFolder)</span>
<a href="#l26.102"></a><span id="l26.102">       localAccountUtils.loadLocalMailAccount();</span>
<a href="#l26.103"></a><span id="l26.103"> </span>
<a href="#l26.104"></a><span id="l26.104">     gMoveFolder = localAccountUtils.rootFolder.createLocalSubfolder(&quot;MoveFolder&quot;);</span>
<a href="#l26.105"></a><span id="l26.105" class="difflineminus">-  }</span>
<a href="#l26.106"></a><span id="l26.106" class="difflineplus">+  };</span>
<a href="#l26.107"></a><span id="l26.107"> }</span>
<a href="#l26.108"></a><span id="l26.108"> </span>
<a href="#l26.109"></a><span id="l26.109" class="difflineminus">-function run_test()</span>
<a href="#l26.110"></a><span id="l26.110" class="difflineminus">-{</span>
<a href="#l26.111"></a><span id="l26.111" class="difflineplus">+function run_test() {</span>
<a href="#l26.112"></a><span id="l26.112">   for (let store of gPluggableStores) {</span>
<a href="#l26.113"></a><span id="l26.113">     add_task(setup_store(store));</span>
<a href="#l26.114"></a><span id="l26.114">     gTestArray.forEach(x =&gt; add_task(x));</span>
<a href="#l26.115"></a><span id="l26.115">   }</span>
<a href="#l26.116"></a><span id="l26.116"> </span>
<a href="#l26.117"></a><span id="l26.117">   add_task(exitTest);</span>
<a href="#l26.118"></a><span id="l26.118">   run_next_test();</span>
<a href="#l26.119"></a><span id="l26.119"> }</span>
<a href="#l26.120"></a><span id="l26.120"> </span>
<a href="#l26.121"></a><span id="l26.121" class="difflineminus">-function exitTest()</span>
<a href="#l26.122"></a><span id="l26.122" class="difflineminus">-{</span>
<a href="#l26.123"></a><span id="l26.123" class="difflineplus">+function exitTest() {</span>
<a href="#l26.124"></a><span id="l26.124">   // Cleanup and exit the test.</span>
<a href="#l26.125"></a><span id="l26.125">   info(&quot;Exiting mail tests\n&quot;);</span>
<a href="#l26.126"></a><span id="l26.126">   gPOP3Pump = null;</span>
<a href="#l26.127"></a><span id="l26.127"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1" class="difflineminus">--- a/mailnews/local/test/unit/test_pop3MultiCopy.js</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineplus">+++ b/mailnews/local/test/unit/test_pop3MultiCopy.js</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineat">@@ -1,15 +1,16 @@</span>
<a href="#l27.4"></a><span id="l27.4"> /* Any copyright is dedicated to the Public Domain.</span>
<a href="#l27.5"></a><span id="l27.5">    http://creativecommons.org/publicdomain/zero/1.0/ */</span>
<a href="#l27.6"></a><span id="l27.6"> </span>
<a href="#l27.7"></a><span id="l27.7"> /**</span>
<a href="#l27.8"></a><span id="l27.8">  * This tests that copied multiple messages in maildir are correct.</span>
<a href="#l27.9"></a><span id="l27.9">  */</span>
<a href="#l27.10"></a><span id="l27.10"> </span>
<a href="#l27.11"></a><span id="l27.11" class="difflineplus">+/* import-globals-from ../../../test/resources/POP3pump.js */</span>
<a href="#l27.12"></a><span id="l27.12"> load(&quot;../../../resources/POP3pump.js&quot;);</span>
<a href="#l27.13"></a><span id="l27.13"> ChromeUtils.import(&quot;resource://testing-common/mailnews/PromiseTestUtils.jsm&quot;);</span>
<a href="#l27.14"></a><span id="l27.14"> </span>
<a href="#l27.15"></a><span id="l27.15"> var testSubjects = [&quot;[Bug 397009] A filter will let me tag, but not untag&quot;,</span>
<a href="#l27.16"></a><span id="l27.16">                     &quot;Hello, did you receive my bugmail?&quot;];</span>
<a href="#l27.17"></a><span id="l27.17"> </span>
<a href="#l27.18"></a><span id="l27.18"> Services.prefs.setCharPref(&quot;mail.serverDefaultStoreContractID&quot;,</span>
<a href="#l27.19"></a><span id="l27.19">                            &quot;@mozilla.org/msgstore/maildirstore;1&quot;);</span>
<a href="#l27.20"></a><span id="l27.20" class="difflineat">@@ -78,17 +79,13 @@ add_task(async function runPump() {</span>
<a href="#l27.21"></a><span id="l27.21">     Assert.ok(subjects.includes(subject));</span>
<a href="#l27.22"></a><span id="l27.22">   }</span>
<a href="#l27.23"></a><span id="l27.23"> </span>
<a href="#l27.24"></a><span id="l27.24">   // Make sure the body matches the message.</span>
<a href="#l27.25"></a><span id="l27.25">   enumerator = testFolder.msgDatabase.EnumerateMessages();</span>
<a href="#l27.26"></a><span id="l27.26">   while (enumerator.hasMoreElements()) {</span>
<a href="#l27.27"></a><span id="l27.27">     let hdr = enumerator.getNext().QueryInterface(Ci.nsIMsgDBHdr);</span>
<a href="#l27.28"></a><span id="l27.28">     let body = mailTestUtils.loadMessageToString(testFolder, hdr);</span>
<a href="#l27.29"></a><span id="l27.29" class="difflineminus">-    Assert.ok(body.indexOf(hdr.subject) &gt;= 0);</span>
<a href="#l27.30"></a><span id="l27.30" class="difflineplus">+    Assert.ok(body.includes(hdr.subject));</span>
<a href="#l27.31"></a><span id="l27.31">   }</span>
<a href="#l27.32"></a><span id="l27.32"> </span>
<a href="#l27.33"></a><span id="l27.33">   gPOP3Pump = null;</span>
<a href="#l27.34"></a><span id="l27.34"> });</span>
<a href="#l27.35"></a><span id="l27.35" class="difflineminus">-</span>
<a href="#l27.36"></a><span id="l27.36" class="difflineminus">-function run_test() {</span>
<a href="#l27.37"></a><span id="l27.37" class="difflineminus">-  run_next_test();</span>
<a href="#l27.38"></a><span id="l27.38" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l28.1"></a><span id="l28.1" class="difflineminus">--- a/mailnews/local/test/unit/test_pop3MultiCopy2.js</span>
<a href="#l28.2"></a><span id="l28.2" class="difflineplus">+++ b/mailnews/local/test/unit/test_pop3MultiCopy2.js</span>
<a href="#l28.3"></a><span id="l28.3" class="difflineat">@@ -1,16 +1,17 @@</span>
<a href="#l28.4"></a><span id="l28.4"> /* Any copyright is dedicated to the Public Domain.</span>
<a href="#l28.5"></a><span id="l28.5">    http://creativecommons.org/publicdomain/zero/1.0/ */</span>
<a href="#l28.6"></a><span id="l28.6"> </span>
<a href="#l28.7"></a><span id="l28.7"> /**</span>
<a href="#l28.8"></a><span id="l28.8">  * This tests that moved multiple messages from maildir-&gt;mbox and</span>
<a href="#l28.9"></a><span id="l28.9">    mbox-&gt;maildir are correct.</span>
<a href="#l28.10"></a><span id="l28.10">  */</span>
<a href="#l28.11"></a><span id="l28.11"> </span>
<a href="#l28.12"></a><span id="l28.12" class="difflineplus">+/* import-globals-from ../../../test/resources/POP3pump.js */</span>
<a href="#l28.13"></a><span id="l28.13"> load(&quot;../../../resources/POP3pump.js&quot;);</span>
<a href="#l28.14"></a><span id="l28.14"> ChromeUtils.import(&quot;resource://testing-common/mailnews/PromiseTestUtils.jsm&quot;);</span>
<a href="#l28.15"></a><span id="l28.15"> </span>
<a href="#l28.16"></a><span id="l28.16"> Services.prefs.setCharPref(&quot;mail.serverDefaultStoreContractID&quot;,</span>
<a href="#l28.17"></a><span id="l28.17">                            &quot;@mozilla.org/msgstore/maildirstore;1&quot;);</span>
<a href="#l28.18"></a><span id="l28.18"> </span>
<a href="#l28.19"></a><span id="l28.19"> var gInboxFolder, gTestFolder;</span>
<a href="#l28.20"></a><span id="l28.20"> </span>
<a href="#l28.21"></a><span id="l28.21" class="difflineat">@@ -79,17 +80,17 @@ add_task(async function maildirToMbox() </span>
<a href="#l28.22"></a><span id="l28.22">     Assert.ok(subjects.includes(subject));</span>
<a href="#l28.23"></a><span id="l28.23">   }</span>
<a href="#l28.24"></a><span id="l28.24"> </span>
<a href="#l28.25"></a><span id="l28.25">   // Make sure the body matches the message.</span>
<a href="#l28.26"></a><span id="l28.26">   enumerator = gTestFolder.msgDatabase.EnumerateMessages();</span>
<a href="#l28.27"></a><span id="l28.27">   while (enumerator.hasMoreElements()) {</span>
<a href="#l28.28"></a><span id="l28.28">     let hdr = enumerator.getNext().QueryInterface(Ci.nsIMsgDBHdr);</span>
<a href="#l28.29"></a><span id="l28.29">     let body = mailTestUtils.loadMessageToString(gTestFolder, hdr);</span>
<a href="#l28.30"></a><span id="l28.30" class="difflineminus">-    Assert.ok(body.indexOf(hdr.subject) &gt;= 0);</span>
<a href="#l28.31"></a><span id="l28.31" class="difflineplus">+    Assert.ok(body.includes(hdr.subject));</span>
<a href="#l28.32"></a><span id="l28.32">   }</span>
<a href="#l28.33"></a><span id="l28.33"> });</span>
<a href="#l28.34"></a><span id="l28.34"> </span>
<a href="#l28.35"></a><span id="l28.35"> add_task(async function mboxToMaildir() {</span>
<a href="#l28.36"></a><span id="l28.36">   // Test for multiple message copy for mbox-&gt;maildir.</span>
<a href="#l28.37"></a><span id="l28.37"> </span>
<a href="#l28.38"></a><span id="l28.38">   // Accumulate messages to copy.</span>
<a href="#l28.39"></a><span id="l28.39">   let messages = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span>
<a href="#l28.40"></a><span id="l28.40" class="difflineat">@@ -127,42 +128,37 @@ add_task(async function mboxToMaildir() </span>
<a href="#l28.41"></a><span id="l28.41">     Assert.ok(subjects.includes(subject));</span>
<a href="#l28.42"></a><span id="l28.42">   }</span>
<a href="#l28.43"></a><span id="l28.43"> </span>
<a href="#l28.44"></a><span id="l28.44">   // Make sure the body matches the message.</span>
<a href="#l28.45"></a><span id="l28.45">   enumerator = gInboxFolder.msgDatabase.EnumerateMessages();</span>
<a href="#l28.46"></a><span id="l28.46">   while (enumerator.hasMoreElements()) {</span>
<a href="#l28.47"></a><span id="l28.47">     let hdr = enumerator.getNext().QueryInterface(Ci.nsIMsgDBHdr);</span>
<a href="#l28.48"></a><span id="l28.48">     let body = mailTestUtils.loadMessageToString(gInboxFolder, hdr);</span>
<a href="#l28.49"></a><span id="l28.49" class="difflineminus">-    Assert.ok(body.indexOf(hdr.subject) &gt;= 0);</span>
<a href="#l28.50"></a><span id="l28.50" class="difflineplus">+    Assert.ok(body.includes(hdr.subject));</span>
<a href="#l28.51"></a><span id="l28.51">   }</span>
<a href="#l28.52"></a><span id="l28.52"> });</span>
<a href="#l28.53"></a><span id="l28.53"> </span>
<a href="#l28.54"></a><span id="l28.54"> add_task(function testCleanup() {</span>
<a href="#l28.55"></a><span id="l28.55">   gPOP3Pump = null;</span>
<a href="#l28.56"></a><span id="l28.56"> });</span>
<a href="#l28.57"></a><span id="l28.57"> </span>
<a href="#l28.58"></a><span id="l28.58" class="difflineminus">-function run_test() {</span>
<a href="#l28.59"></a><span id="l28.59" class="difflineminus">-  run_next_test();</span>
<a href="#l28.60"></a><span id="l28.60" class="difflineminus">-}</span>
<a href="#l28.61"></a><span id="l28.61" class="difflineminus">-</span>
<a href="#l28.62"></a><span id="l28.62"> // Clone of POP3pump resetPluggableStore that does not reset local folders.</span>
<a href="#l28.63"></a><span id="l28.63" class="difflineminus">-function resetPluggableStoreLocal(aStoreContractID)</span>
<a href="#l28.64"></a><span id="l28.64" class="difflineminus">-{</span>
<a href="#l28.65"></a><span id="l28.65" class="difflineplus">+function resetPluggableStoreLocal(aStoreContractID) {</span>
<a href="#l28.66"></a><span id="l28.66">   Services.prefs.setCharPref(&quot;mail.serverDefaultStoreContractID&quot;, aStoreContractID);</span>
<a href="#l28.67"></a><span id="l28.67"> </span>
<a href="#l28.68"></a><span id="l28.68">   // Cleanup existing files, server and account instances, if any.</span>
<a href="#l28.69"></a><span id="l28.69">   if (gPOP3Pump._server)</span>
<a href="#l28.70"></a><span id="l28.70">     gPOP3Pump._server.stop();</span>
<a href="#l28.71"></a><span id="l28.71"> </span>
<a href="#l28.72"></a><span id="l28.72">   if (gPOP3Pump.fakeServer &amp;&amp; gPOP3Pump.fakeServer.valid) {</span>
<a href="#l28.73"></a><span id="l28.73">     gPOP3Pump.fakeServer.closeCachedConnections();</span>
<a href="#l28.74"></a><span id="l28.74">     MailServices.accounts.removeIncomingServer(gPOP3Pump.fakeServer, false);</span>
<a href="#l28.75"></a><span id="l28.75">   }</span>
<a href="#l28.76"></a><span id="l28.76"> </span>
<a href="#l28.77"></a><span id="l28.77">   gPOP3Pump.fakeServer = localAccountUtils.create_incoming_server(&quot;pop3&quot;,</span>
<a href="#l28.78"></a><span id="l28.78">       gPOP3Pump.kPOP3_PORT, &quot;fred&quot;, &quot;wilma&quot;);</span>
<a href="#l28.79"></a><span id="l28.79"> </span>
<a href="#l28.80"></a><span id="l28.80" class="difflineminus">-  //localAccountUtils.clearAll();</span>
<a href="#l28.81"></a><span id="l28.81" class="difflineplus">+  // localAccountUtils.clearAll();</span>
<a href="#l28.82"></a><span id="l28.82"> </span>
<a href="#l28.83"></a><span id="l28.83">   gPOP3Pump._incomingServer = gPOP3Pump.fakeServer;</span>
<a href="#l28.84"></a><span id="l28.84">   gPOP3Pump._mailboxStoreContractID = aStoreContractID;</span>
<a href="#l28.85"></a><span id="l28.85" class="difflineminus">-};</span>
<a href="#l28.86"></a><span id="l28.86" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l29.1"></a><span id="l29.1" class="difflineminus">--- a/mailnews/local/test/unit/test_pop3Password.js</span>
<a href="#l29.2"></a><span id="l29.2" class="difflineplus">+++ b/mailnews/local/test/unit/test_pop3Password.js</span>
<a href="#l29.3"></a><span id="l29.3" class="difflineat">@@ -1,59 +1,54 @@</span>
<a href="#l29.4"></a><span id="l29.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l29.5"></a><span id="l29.5"> /**</span>
<a href="#l29.6"></a><span id="l29.6">  * Authentication tests for POP3.</span>
<a href="#l29.7"></a><span id="l29.7">  */</span>
<a href="#l29.8"></a><span id="l29.8"> </span>
<a href="#l29.9"></a><span id="l29.9" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l29.10"></a><span id="l29.10" class="difflineminus">-</span>
<a href="#l29.11"></a><span id="l29.11" class="difflineplus">+/* import-globals-from ../../../test/resources/passwordStorage.js */</span>
<a href="#l29.12"></a><span id="l29.12"> load(&quot;../../../resources/passwordStorage.js&quot;);</span>
<a href="#l29.13"></a><span id="l29.13"> </span>
<a href="#l29.14"></a><span id="l29.14" class="difflineminus">-var test = null;</span>
<a href="#l29.15"></a><span id="l29.15"> var server;</span>
<a href="#l29.16"></a><span id="l29.16"> var daemon;</span>
<a href="#l29.17"></a><span id="l29.17"> var incomingServer;</span>
<a href="#l29.18"></a><span id="l29.18"> var thisTest;</span>
<a href="#l29.19"></a><span id="l29.19"> </span>
<a href="#l29.20"></a><span id="l29.20" class="difflineminus">-var tests = [</span>
<a href="#l29.21"></a><span id="l29.21" class="difflineminus">-  { title: &quot;Get New Mail, One Message&quot;,</span>
<a href="#l29.22"></a><span id="l29.22" class="difflineminus">-    messages: [&quot;message1.eml&quot;],</span>
<a href="#l29.23"></a><span id="l29.23" class="difflineminus">-    transaction: [ &quot;AUTH&quot;, &quot;CAPA&quot;, &quot;AUTH PLAIN&quot;, &quot;STAT&quot;, &quot;LIST&quot;,</span>
<a href="#l29.24"></a><span id="l29.24" class="difflineminus">-                   &quot;UIDL&quot;, &quot;RETR 1&quot;, &quot;DELE 1&quot; ] }</span>
<a href="#l29.25"></a><span id="l29.25" class="difflineminus">-];</span>
<a href="#l29.26"></a><span id="l29.26" class="difflineplus">+var tests = [{</span>
<a href="#l29.27"></a><span id="l29.27" class="difflineplus">+  title: &quot;Get New Mail, One Message&quot;,</span>
<a href="#l29.28"></a><span id="l29.28" class="difflineplus">+  messages: [&quot;message1.eml&quot;],</span>
<a href="#l29.29"></a><span id="l29.29" class="difflineplus">+  transaction: [&quot;AUTH&quot;, &quot;CAPA&quot;, &quot;AUTH PLAIN&quot;, &quot;STAT&quot;, &quot;LIST&quot;, &quot;UIDL&quot;, &quot;RETR 1&quot;, &quot;DELE 1&quot;],</span>
<a href="#l29.30"></a><span id="l29.30" class="difflineplus">+}];</span>
<a href="#l29.31"></a><span id="l29.31"> </span>
<a href="#l29.32"></a><span id="l29.32" class="difflineminus">-var urlListener =</span>
<a href="#l29.33"></a><span id="l29.33" class="difflineminus">-{</span>
<a href="#l29.34"></a><span id="l29.34" class="difflineminus">-  OnStartRunningUrl: function (url) {</span>
<a href="#l29.35"></a><span id="l29.35" class="difflineplus">+var urlListener = {</span>
<a href="#l29.36"></a><span id="l29.36" class="difflineplus">+  OnStartRunningUrl(url) {</span>
<a href="#l29.37"></a><span id="l29.37">   },</span>
<a href="#l29.38"></a><span id="l29.38" class="difflineminus">-  OnStopRunningUrl: function (url, result) {</span>
<a href="#l29.39"></a><span id="l29.39" class="difflineplus">+  OnStopRunningUrl(url, result) {</span>
<a href="#l29.40"></a><span id="l29.40">     try {</span>
<a href="#l29.41"></a><span id="l29.41">       var transaction = server.playTransaction();</span>
<a href="#l29.42"></a><span id="l29.42"> </span>
<a href="#l29.43"></a><span id="l29.43">       do_check_transaction(transaction, thisTest.transaction);</span>
<a href="#l29.44"></a><span id="l29.44"> </span>
<a href="#l29.45"></a><span id="l29.45">       Assert.equal(localAccountUtils.inboxFolder.getTotalMessages(false),</span>
<a href="#l29.46"></a><span id="l29.46">                    thisTest.messages.length);</span>
<a href="#l29.47"></a><span id="l29.47"> </span>
<a href="#l29.48"></a><span id="l29.48">       Assert.equal(result, 0);</span>
<a href="#l29.49"></a><span id="l29.49" class="difflineminus">-    }</span>
<a href="#l29.50"></a><span id="l29.50" class="difflineminus">-    catch (e) {</span>
<a href="#l29.51"></a><span id="l29.51" class="difflineplus">+    } catch (e) {</span>
<a href="#l29.52"></a><span id="l29.52">       // If we have an error, clean up nicely before we throw it.</span>
<a href="#l29.53"></a><span id="l29.53">       server.stop();</span>
<a href="#l29.54"></a><span id="l29.54"> </span>
<a href="#l29.55"></a><span id="l29.55">       var thread = gThreadManager.currentThread;</span>
<a href="#l29.56"></a><span id="l29.56">       while (thread.hasPendingEvents())</span>
<a href="#l29.57"></a><span id="l29.57">         thread.processNextEvent(true);</span>
<a href="#l29.58"></a><span id="l29.58"> </span>
<a href="#l29.59"></a><span id="l29.59">       do_throw(e);</span>
<a href="#l29.60"></a><span id="l29.60">     }</span>
<a href="#l29.61"></a><span id="l29.61"> </span>
<a href="#l29.62"></a><span id="l29.62">     // Let OnStopRunningUrl return cleanly before doing anything else.</span>
<a href="#l29.63"></a><span id="l29.63">     do_timeout(0, checkBusy);</span>
<a href="#l29.64"></a><span id="l29.64" class="difflineminus">-  }</span>
<a href="#l29.65"></a><span id="l29.65" class="difflineplus">+  },</span>
<a href="#l29.66"></a><span id="l29.66"> };</span>
<a href="#l29.67"></a><span id="l29.67"> </span>
<a href="#l29.68"></a><span id="l29.68"> function checkBusy() {</span>
<a href="#l29.69"></a><span id="l29.69">   if (tests.length == 0) {</span>
<a href="#l29.70"></a><span id="l29.70">     incomingServer.closeCachedConnections();</span>
<a href="#l29.71"></a><span id="l29.71"> </span>
<a href="#l29.72"></a><span id="l29.72">     // No more tests, let everything finish</span>
<a href="#l29.73"></a><span id="l29.73">     server.stop();</span>
<a href="#l29.74"></a><span id="l29.74" class="difflineat">@@ -100,17 +95,17 @@ function testNext() {</span>
<a href="#l29.75"></a><span id="l29.75">     do_throw(e);</span>
<a href="#l29.76"></a><span id="l29.76">   } finally {</span>
<a href="#l29.77"></a><span id="l29.77">     var thread = gThreadManager.currentThread;</span>
<a href="#l29.78"></a><span id="l29.78">     while (thread.hasPendingEvents())</span>
<a href="#l29.79"></a><span id="l29.79">       thread.processNextEvent(true);</span>
<a href="#l29.80"></a><span id="l29.80">   }</span>
<a href="#l29.81"></a><span id="l29.81"> }</span>
<a href="#l29.82"></a><span id="l29.82"> </span>
<a href="#l29.83"></a><span id="l29.83" class="difflineminus">-add_task(async function () {</span>
<a href="#l29.84"></a><span id="l29.84" class="difflineplus">+add_task(async function() {</span>
<a href="#l29.85"></a><span id="l29.85">   // Disable new mail notifications</span>
<a href="#l29.86"></a><span id="l29.86">   Services.prefs.setBoolPref(&quot;mail.biff.play_sound&quot;, false);</span>
<a href="#l29.87"></a><span id="l29.87">   Services.prefs.setBoolPref(&quot;mail.biff.show_alert&quot;, false);</span>
<a href="#l29.88"></a><span id="l29.88">   Services.prefs.setBoolPref(&quot;mail.biff.show_tray_icon&quot;, false);</span>
<a href="#l29.89"></a><span id="l29.89">   Services.prefs.setBoolPref(&quot;mail.biff.animate_dock_icon&quot;, false);</span>
<a href="#l29.90"></a><span id="l29.90"> </span>
<a href="#l29.91"></a><span id="l29.91">   // Prepare files for passwords (generated by a script in bug 1018624).</span>
<a href="#l29.92"></a><span id="l29.92">   await setupForPassword(&quot;signons-mailnews1.8.json&quot;);</span>
<a href="#l29.93"></a><span id="l29.93" class="difflineat">@@ -139,12 +134,8 @@ add_task(async function () {</span>
<a href="#l29.94"></a><span id="l29.94">   // Check that we haven't got any messages in the folder, if we have its a test</span>
<a href="#l29.95"></a><span id="l29.95">   // setup issue.</span>
<a href="#l29.96"></a><span id="l29.96">   Assert.equal(localAccountUtils.inboxFolder.getTotalMessages(false), 0);</span>
<a href="#l29.97"></a><span id="l29.97"> </span>
<a href="#l29.98"></a><span id="l29.98">   do_test_pending();</span>
<a href="#l29.99"></a><span id="l29.99"> </span>
<a href="#l29.100"></a><span id="l29.100">   testNext();</span>
<a href="#l29.101"></a><span id="l29.101"> });</span>
<a href="#l29.102"></a><span id="l29.102" class="difflineminus">-</span>
<a href="#l29.103"></a><span id="l29.103" class="difflineminus">-function run_test() {</span>
<a href="#l29.104"></a><span id="l29.104" class="difflineminus">-  run_next_test();</span>
<a href="#l29.105"></a><span id="l29.105" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l30.1"></a><span id="l30.1" class="difflineminus">--- a/mailnews/local/test/unit/test_pop3Password2.js</span>
<a href="#l30.2"></a><span id="l30.2" class="difflineplus">+++ b/mailnews/local/test/unit/test_pop3Password2.js</span>
<a href="#l30.3"></a><span id="l30.3" class="difflineat">@@ -1,61 +1,56 @@</span>
<a href="#l30.4"></a><span id="l30.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l30.5"></a><span id="l30.5"> /**</span>
<a href="#l30.6"></a><span id="l30.6">  * Authentication tests for POP3 - checks for servers whose details have</span>
<a href="#l30.7"></a><span id="l30.7">  * changed (e.g. realusername and realhostname are different from username and</span>
<a href="#l30.8"></a><span id="l30.8">  * hostname).</span>
<a href="#l30.9"></a><span id="l30.9">  */</span>
<a href="#l30.10"></a><span id="l30.10"> </span>
<a href="#l30.11"></a><span id="l30.11" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l30.12"></a><span id="l30.12" class="difflineminus">-</span>
<a href="#l30.13"></a><span id="l30.13" class="difflineplus">+/* import-globals-from ../../../test/resources/passwordStorage.js */</span>
<a href="#l30.14"></a><span id="l30.14"> load(&quot;../../../resources/passwordStorage.js&quot;);</span>
<a href="#l30.15"></a><span id="l30.15"> </span>
<a href="#l30.16"></a><span id="l30.16" class="difflineminus">-var test = null;</span>
<a href="#l30.17"></a><span id="l30.17"> var server;</span>
<a href="#l30.18"></a><span id="l30.18"> var daemon;</span>
<a href="#l30.19"></a><span id="l30.19"> var incomingServer;</span>
<a href="#l30.20"></a><span id="l30.20"> var thisTest;</span>
<a href="#l30.21"></a><span id="l30.21"> </span>
<a href="#l30.22"></a><span id="l30.22" class="difflineminus">-var tests = [</span>
<a href="#l30.23"></a><span id="l30.23" class="difflineminus">-  { title: &quot;Get New Mail, One Message&quot;,</span>
<a href="#l30.24"></a><span id="l30.24" class="difflineminus">-    messages: [&quot;message1.eml&quot;],</span>
<a href="#l30.25"></a><span id="l30.25" class="difflineminus">-    transaction: [ &quot;AUTH&quot;, &quot;CAPA&quot;, &quot;AUTH PLAIN&quot;, &quot;STAT&quot;, &quot;LIST&quot;,</span>
<a href="#l30.26"></a><span id="l30.26" class="difflineminus">-                   &quot;UIDL&quot;, &quot;RETR 1&quot;, &quot;DELE 1&quot; ] }</span>
<a href="#l30.27"></a><span id="l30.27" class="difflineminus">-];</span>
<a href="#l30.28"></a><span id="l30.28" class="difflineplus">+var tests = [{</span>
<a href="#l30.29"></a><span id="l30.29" class="difflineplus">+  title: &quot;Get New Mail, One Message&quot;,</span>
<a href="#l30.30"></a><span id="l30.30" class="difflineplus">+  messages: [&quot;message1.eml&quot;],</span>
<a href="#l30.31"></a><span id="l30.31" class="difflineplus">+  transaction: [&quot;AUTH&quot;, &quot;CAPA&quot;, &quot;AUTH PLAIN&quot;, &quot;STAT&quot;, &quot;LIST&quot;, &quot;UIDL&quot;, &quot;RETR 1&quot;, &quot;DELE 1&quot;],</span>
<a href="#l30.32"></a><span id="l30.32" class="difflineplus">+}];</span>
<a href="#l30.33"></a><span id="l30.33"> </span>
<a href="#l30.34"></a><span id="l30.34" class="difflineminus">-var urlListener =</span>
<a href="#l30.35"></a><span id="l30.35" class="difflineminus">-{</span>
<a href="#l30.36"></a><span id="l30.36" class="difflineminus">-  OnStartRunningUrl: function (url) {</span>
<a href="#l30.37"></a><span id="l30.37" class="difflineplus">+var urlListener = {</span>
<a href="#l30.38"></a><span id="l30.38" class="difflineplus">+  OnStartRunningUrl(url) {</span>
<a href="#l30.39"></a><span id="l30.39">   },</span>
<a href="#l30.40"></a><span id="l30.40" class="difflineminus">-  OnStopRunningUrl: function (url, result) {</span>
<a href="#l30.41"></a><span id="l30.41" class="difflineplus">+  OnStopRunningUrl(url, result) {</span>
<a href="#l30.42"></a><span id="l30.42">     try {</span>
<a href="#l30.43"></a><span id="l30.43">       var transaction = server.playTransaction();</span>
<a href="#l30.44"></a><span id="l30.44"> </span>
<a href="#l30.45"></a><span id="l30.45">       do_check_transaction(transaction, thisTest.transaction);</span>
<a href="#l30.46"></a><span id="l30.46"> </span>
<a href="#l30.47"></a><span id="l30.47">       Assert.equal(localAccountUtils.inboxFolder.getTotalMessages(false),</span>
<a href="#l30.48"></a><span id="l30.48">                    thisTest.messages.length);</span>
<a href="#l30.49"></a><span id="l30.49"> </span>
<a href="#l30.50"></a><span id="l30.50">       Assert.equal(result, 0);</span>
<a href="#l30.51"></a><span id="l30.51" class="difflineminus">-    }</span>
<a href="#l30.52"></a><span id="l30.52" class="difflineminus">-    catch (e) {</span>
<a href="#l30.53"></a><span id="l30.53" class="difflineplus">+    } catch (e) {</span>
<a href="#l30.54"></a><span id="l30.54">       // If we have an error, clean up nicely before we throw it.</span>
<a href="#l30.55"></a><span id="l30.55">       server.stop();</span>
<a href="#l30.56"></a><span id="l30.56"> </span>
<a href="#l30.57"></a><span id="l30.57">       var thread = gThreadManager.currentThread;</span>
<a href="#l30.58"></a><span id="l30.58">       while (thread.hasPendingEvents())</span>
<a href="#l30.59"></a><span id="l30.59">         thread.processNextEvent(true);</span>
<a href="#l30.60"></a><span id="l30.60"> </span>
<a href="#l30.61"></a><span id="l30.61">       do_throw(e);</span>
<a href="#l30.62"></a><span id="l30.62">     }</span>
<a href="#l30.63"></a><span id="l30.63"> </span>
<a href="#l30.64"></a><span id="l30.64">     // Let OnStopRunningUrl return cleanly before doing anything else.</span>
<a href="#l30.65"></a><span id="l30.65">     do_timeout(0, checkBusy);</span>
<a href="#l30.66"></a><span id="l30.66" class="difflineminus">-  }</span>
<a href="#l30.67"></a><span id="l30.67" class="difflineplus">+  },</span>
<a href="#l30.68"></a><span id="l30.68"> };</span>
<a href="#l30.69"></a><span id="l30.69"> </span>
<a href="#l30.70"></a><span id="l30.70"> function checkBusy() {</span>
<a href="#l30.71"></a><span id="l30.71">   if (tests.length == 0) {</span>
<a href="#l30.72"></a><span id="l30.72">     incomingServer.closeCachedConnections();</span>
<a href="#l30.73"></a><span id="l30.73"> </span>
<a href="#l30.74"></a><span id="l30.74">     // No more tests, let everything finish</span>
<a href="#l30.75"></a><span id="l30.75">     server.stop();</span>
<a href="#l30.76"></a><span id="l30.76" class="difflineat">@@ -102,17 +97,17 @@ function testNext() {</span>
<a href="#l30.77"></a><span id="l30.77">     do_throw(e);</span>
<a href="#l30.78"></a><span id="l30.78">   } finally {</span>
<a href="#l30.79"></a><span id="l30.79">     var thread = gThreadManager.currentThread;</span>
<a href="#l30.80"></a><span id="l30.80">     while (thread.hasPendingEvents())</span>
<a href="#l30.81"></a><span id="l30.81">       thread.processNextEvent(true);</span>
<a href="#l30.82"></a><span id="l30.82">   }</span>
<a href="#l30.83"></a><span id="l30.83"> }</span>
<a href="#l30.84"></a><span id="l30.84"> </span>
<a href="#l30.85"></a><span id="l30.85" class="difflineminus">-add_task(async function () {</span>
<a href="#l30.86"></a><span id="l30.86" class="difflineplus">+add_task(async function() {</span>
<a href="#l30.87"></a><span id="l30.87">   // Disable new mail notifications</span>
<a href="#l30.88"></a><span id="l30.88">   Services.prefs.setBoolPref(&quot;mail.biff.play_sound&quot;, false);</span>
<a href="#l30.89"></a><span id="l30.89">   Services.prefs.setBoolPref(&quot;mail.biff.show_alert&quot;, false);</span>
<a href="#l30.90"></a><span id="l30.90">   Services.prefs.setBoolPref(&quot;mail.biff.show_tray_icon&quot;, false);</span>
<a href="#l30.91"></a><span id="l30.91">   Services.prefs.setBoolPref(&quot;mail.biff.animate_dock_icon&quot;, false);</span>
<a href="#l30.92"></a><span id="l30.92"> </span>
<a href="#l30.93"></a><span id="l30.93">   // These preferences set up a local pop server that has had its hostname</span>
<a href="#l30.94"></a><span id="l30.94">   // and username changed from the original settings. We can't do this by</span>
<a href="#l30.95"></a><span id="l30.95" class="difflineat">@@ -174,12 +169,8 @@ add_task(async function () {</span>
<a href="#l30.96"></a><span id="l30.96">   // Check that we haven't got any messages in the folder, if we have its a test</span>
<a href="#l30.97"></a><span id="l30.97">   // setup issue.</span>
<a href="#l30.98"></a><span id="l30.98">   Assert.equal(localAccountUtils.inboxFolder.getTotalMessages(false), 0);</span>
<a href="#l30.99"></a><span id="l30.99"> </span>
<a href="#l30.100"></a><span id="l30.100">   do_test_pending();</span>
<a href="#l30.101"></a><span id="l30.101"> </span>
<a href="#l30.102"></a><span id="l30.102">   testNext();</span>
<a href="#l30.103"></a><span id="l30.103"> });</span>
<a href="#l30.104"></a><span id="l30.104" class="difflineminus">-</span>
<a href="#l30.105"></a><span id="l30.105" class="difflineminus">-function run_test() {</span>
<a href="#l30.106"></a><span id="l30.106" class="difflineminus">-  run_next_test();</span>
<a href="#l30.107"></a><span id="l30.107" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l31.1"></a><span id="l31.1" class="difflineminus">--- a/mailnews/local/test/unit/test_pop3Password3.js</span>
<a href="#l31.2"></a><span id="l31.2" class="difflineplus">+++ b/mailnews/local/test/unit/test_pop3Password3.js</span>
<a href="#l31.3"></a><span id="l31.3" class="difflineat">@@ -1,25 +1,23 @@</span>
<a href="#l31.4"></a><span id="l31.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l31.5"></a><span id="l31.5"> /**</span>
<a href="#l31.6"></a><span id="l31.6">  * Extra tests for POP3 passwords (forgetPassword)</span>
<a href="#l31.7"></a><span id="l31.7">  */</span>
<a href="#l31.8"></a><span id="l31.8"> </span>
<a href="#l31.9"></a><span id="l31.9" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l31.10"></a><span id="l31.10" class="difflineminus">-ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l31.11"></a><span id="l31.11" class="difflineminus">-</span>
<a href="#l31.12"></a><span id="l31.12" class="difflineplus">+/* import-globals-from ../../../test/resources/passwordStorage.js */</span>
<a href="#l31.13"></a><span id="l31.13"> load(&quot;../../../resources/passwordStorage.js&quot;);</span>
<a href="#l31.14"></a><span id="l31.14"> </span>
<a href="#l31.15"></a><span id="l31.15"> var kUser1 = &quot;testpop3&quot;;</span>
<a href="#l31.16"></a><span id="l31.16"> var kUser2 = &quot;testpop3a&quot;;</span>
<a href="#l31.17"></a><span id="l31.17"> var kProtocol = &quot;pop3&quot;;</span>
<a href="#l31.18"></a><span id="l31.18"> var kHostname = &quot;localhost&quot;;</span>
<a href="#l31.19"></a><span id="l31.19"> var kServerUrl = &quot;mailbox://&quot; + kHostname;</span>
<a href="#l31.20"></a><span id="l31.20"> </span>
<a href="#l31.21"></a><span id="l31.21" class="difflineminus">-add_task(async function () {</span>
<a href="#l31.22"></a><span id="l31.22" class="difflineplus">+add_task(async function() {</span>
<a href="#l31.23"></a><span id="l31.23">   // Prepare files for passwords (generated by a script in bug 1018624).</span>
<a href="#l31.24"></a><span id="l31.24">   await setupForPassword(&quot;signons-mailnews1.8-multiple.json&quot;);</span>
<a href="#l31.25"></a><span id="l31.25"> </span>
<a href="#l31.26"></a><span id="l31.26">   // Set up the basic accounts and folders.</span>
<a href="#l31.27"></a><span id="l31.27">   // We would use createPop3ServerAndLocalFolders() however we want to have</span>
<a href="#l31.28"></a><span id="l31.28">   // a different username and NO password for this test (as we expect to load</span>
<a href="#l31.29"></a><span id="l31.29">   // it from the signons json file in which the login information is stored).</span>
<a href="#l31.30"></a><span id="l31.30">   localAccountUtils.loadLocalMailAccount();</span>
<a href="#l31.31"></a><span id="l31.31" class="difflineat">@@ -68,12 +66,8 @@ add_task(async function () {</span>
<a href="#l31.32"></a><span id="l31.32">   incomingServer2.realUsername = &quot;testpop&quot;;</span>
<a href="#l31.33"></a><span id="l31.33"> </span>
<a href="#l31.34"></a><span id="l31.34">   logins = Services.logins.findLogins(count, kServerUrl, null, kServerUrl);</span>
<a href="#l31.35"></a><span id="l31.35"> </span>
<a href="#l31.36"></a><span id="l31.36">   // There should be no login left.</span>
<a href="#l31.37"></a><span id="l31.37">   Assert.equal(count.value, 0);</span>
<a href="#l31.38"></a><span id="l31.38">   Assert.equal(logins.length, 0);</span>
<a href="#l31.39"></a><span id="l31.39"> });</span>
<a href="#l31.40"></a><span id="l31.40" class="difflineminus">-</span>
<a href="#l31.41"></a><span id="l31.41" class="difflineminus">-function run_test() {</span>
<a href="#l31.42"></a><span id="l31.42" class="difflineminus">-  run_next_test();</span>
<a href="#l31.43"></a><span id="l31.43" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l32.1"></a><span id="l32.1" class="difflineminus">--- a/mailnews/local/test/unit/test_pop3PasswordFailure.js</span>
<a href="#l32.2"></a><span id="l32.2" class="difflineplus">+++ b/mailnews/local/test/unit/test_pop3PasswordFailure.js</span>
<a href="#l32.3"></a><span id="l32.3" class="difflineat">@@ -4,38 +4,38 @@</span>
<a href="#l32.4"></a><span id="l32.4">  *   - Have an invalid password in the password database.</span>
<a href="#l32.5"></a><span id="l32.5">  *   - Check we get a prompt asking what to do.</span>
<a href="#l32.6"></a><span id="l32.6">  *   - Check retry does what it should do.</span>
<a href="#l32.7"></a><span id="l32.7">  *   - Check cancel does what it should do.</span>
<a href="#l32.8"></a><span id="l32.8">  *   - Re-initiate connection, this time select enter new password, check that</span>
<a href="#l32.9"></a><span id="l32.9">  *     we get a new password prompt and can enter the password.</span>
<a href="#l32.10"></a><span id="l32.10">  */</span>
<a href="#l32.11"></a><span id="l32.11"> </span>
<a href="#l32.12"></a><span id="l32.12" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l32.13"></a><span id="l32.13" class="difflineminus">-ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l32.14"></a><span id="l32.14" class="difflineminus">-ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l32.15"></a><span id="l32.15" class="difflineminus">-</span>
<a href="#l32.16"></a><span id="l32.16" class="difflineplus">+/* import-globals-from ../../../test/resources/logHelper.js */</span>
<a href="#l32.17"></a><span id="l32.17" class="difflineplus">+/* import-globals-from ../../../test/resources/alertTestUtils.js */</span>
<a href="#l32.18"></a><span id="l32.18" class="difflineplus">+/* import-globals-from ../../../test/resources/passwordStorage.js */</span>
<a href="#l32.19"></a><span id="l32.19" class="difflineplus">+/* import-globals-from ../../../test/resources/mailTestUtils.js */</span>
<a href="#l32.20"></a><span id="l32.20" class="difflineplus">+/* import-globals-from ../../../test/resources/asyncTestUtils.js */</span>
<a href="#l32.21"></a><span id="l32.21"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l32.22"></a><span id="l32.22"> load(&quot;../../../resources/alertTestUtils.js&quot;);</span>
<a href="#l32.23"></a><span id="l32.23"> load(&quot;../../../resources/passwordStorage.js&quot;);</span>
<a href="#l32.24"></a><span id="l32.24"> load(&quot;../../../resources/mailTestUtils.js&quot;);</span>
<a href="#l32.25"></a><span id="l32.25"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l32.26"></a><span id="l32.26"> </span>
<a href="#l32.27"></a><span id="l32.27" class="difflineminus">-var test = null;</span>
<a href="#l32.28"></a><span id="l32.28"> var server;</span>
<a href="#l32.29"></a><span id="l32.29"> var daemon;</span>
<a href="#l32.30"></a><span id="l32.30"> var incomingServer;</span>
<a href="#l32.31"></a><span id="l32.31"> var attempt = 0;</span>
<a href="#l32.32"></a><span id="l32.32"> </span>
<a href="#l32.33"></a><span id="l32.33"> var kUserName = &quot;testpop3&quot;;</span>
<a href="#l32.34"></a><span id="l32.34"> var kInvalidPassword = &quot;pop3test&quot;;</span>
<a href="#l32.35"></a><span id="l32.35"> var kValidPassword = &quot;testpop3&quot;;</span>
<a href="#l32.36"></a><span id="l32.36"> </span>
<a href="#l32.37"></a><span id="l32.37" class="difflineminus">-function alert(aDialogText, aText)</span>
<a href="#l32.38"></a><span id="l32.38" class="difflineminus">-{</span>
<a href="#l32.39"></a><span id="l32.39" class="difflineplus">+/* exported alert, confirmEx, promptPasswordPS */</span>
<a href="#l32.40"></a><span id="l32.40" class="difflineplus">+function alert(aDialogText, aText) {</span>
<a href="#l32.41"></a><span id="l32.41">   // The first few attempts may prompt about the password problem, the last</span>
<a href="#l32.42"></a><span id="l32.42">   // attempt shouldn't.</span>
<a href="#l32.43"></a><span id="l32.43">   Assert.ok(attempt &lt; 4);</span>
<a href="#l32.44"></a><span id="l32.44"> </span>
<a href="#l32.45"></a><span id="l32.45">   // Log the fact we've got an alert, but we don't need to test anything here.</span>
<a href="#l32.46"></a><span id="l32.46">   dump(&quot;Alert Title: &quot; + aDialogText + &quot;\nAlert Text: &quot; + aText + &quot;\n&quot;);</span>
<a href="#l32.47"></a><span id="l32.47"> }</span>
<a href="#l32.48"></a><span id="l32.48"> </span>
<a href="#l32.49"></a><span id="l32.49" class="difflineat">@@ -77,59 +77,56 @@ function promptPasswordPS(aParent, aDial</span>
<a href="#l32.50"></a><span id="l32.50"> function getPopMail() {</span>
<a href="#l32.51"></a><span id="l32.51">   MailServices.pop3.GetNewMail(gDummyMsgWindow, urlListener, localAccountUtils.inboxFolder,</span>
<a href="#l32.52"></a><span id="l32.52">                                incomingServer);</span>
<a href="#l32.53"></a><span id="l32.53"> </span>
<a href="#l32.54"></a><span id="l32.54">   server.performTest();</span>
<a href="#l32.55"></a><span id="l32.55">   return false;</span>
<a href="#l32.56"></a><span id="l32.56"> }</span>
<a href="#l32.57"></a><span id="l32.57"> </span>
<a href="#l32.58"></a><span id="l32.58" class="difflineminus">-var urlListener =</span>
<a href="#l32.59"></a><span id="l32.59" class="difflineminus">-{</span>
<a href="#l32.60"></a><span id="l32.60" class="difflineminus">-  OnStartRunningUrl: function (url) {</span>
<a href="#l32.61"></a><span id="l32.61" class="difflineplus">+var urlListener = {</span>
<a href="#l32.62"></a><span id="l32.62" class="difflineplus">+  OnStartRunningUrl(url) {</span>
<a href="#l32.63"></a><span id="l32.63">   },</span>
<a href="#l32.64"></a><span id="l32.64" class="difflineminus">-  OnStopRunningUrl: function (url, result) {</span>
<a href="#l32.65"></a><span id="l32.65" class="difflineplus">+  OnStopRunningUrl(url, result) {</span>
<a href="#l32.66"></a><span id="l32.66">     try {</span>
<a href="#l32.67"></a><span id="l32.67" class="difflineminus">-      var transaction = server.playTransaction();</span>
<a href="#l32.68"></a><span id="l32.68" class="difflineplus">+      server.playTransaction();</span>
<a href="#l32.69"></a><span id="l32.69"> </span>
<a href="#l32.70"></a><span id="l32.70">       // On the last attempt, we should have successfully got one mail.</span>
<a href="#l32.71"></a><span id="l32.71">       Assert.equal(localAccountUtils.inboxFolder.getTotalMessages(false),</span>
<a href="#l32.72"></a><span id="l32.72">                    attempt == 4 ? 1 : 0);</span>
<a href="#l32.73"></a><span id="l32.73"> </span>
<a href="#l32.74"></a><span id="l32.74">       // If we've just cancelled, expect binding aborted rather than success.</span>
<a href="#l32.75"></a><span id="l32.75">       Assert.equal(result, attempt == 2 ? Cr.NS_BINDING_ABORTED : 0);</span>
<a href="#l32.76"></a><span id="l32.76">       async_driver();</span>
<a href="#l32.77"></a><span id="l32.77" class="difflineminus">-    }</span>
<a href="#l32.78"></a><span id="l32.78" class="difflineminus">-    catch (e) {</span>
<a href="#l32.79"></a><span id="l32.79" class="difflineplus">+    } catch (e) {</span>
<a href="#l32.80"></a><span id="l32.80">       // If we have an error, clean up nicely before we throw it.</span>
<a href="#l32.81"></a><span id="l32.81">       server.stop();</span>
<a href="#l32.82"></a><span id="l32.82"> </span>
<a href="#l32.83"></a><span id="l32.83">       var thread = gThreadManager.currentThread;</span>
<a href="#l32.84"></a><span id="l32.84">       while (thread.hasPendingEvents())</span>
<a href="#l32.85"></a><span id="l32.85">         thread.processNextEvent(true);</span>
<a href="#l32.86"></a><span id="l32.86"> </span>
<a href="#l32.87"></a><span id="l32.87">       do_throw(e);</span>
<a href="#l32.88"></a><span id="l32.88">     }</span>
<a href="#l32.89"></a><span id="l32.89" class="difflineminus">-  }</span>
<a href="#l32.90"></a><span id="l32.90" class="difflineplus">+  },</span>
<a href="#l32.91"></a><span id="l32.91"> };</span>
<a href="#l32.92"></a><span id="l32.92"> </span>
<a href="#l32.93"></a><span id="l32.93"> // Definition of tests</span>
<a href="#l32.94"></a><span id="l32.94"> var tests = [</span>
<a href="#l32.95"></a><span id="l32.95">   getMail1,</span>
<a href="#l32.96"></a><span id="l32.96">   getMail2,</span>
<a href="#l32.97"></a><span id="l32.97" class="difflineminus">-  end_test</span>
<a href="#l32.98"></a><span id="l32.98" class="difflineminus">-]</span>
<a href="#l32.99"></a><span id="l32.99" class="difflineplus">+  end_test,</span>
<a href="#l32.100"></a><span id="l32.100" class="difflineplus">+];</span>
<a href="#l32.101"></a><span id="l32.101"> </span>
<a href="#l32.102"></a><span id="l32.102"> function actually_run_test() {</span>
<a href="#l32.103"></a><span id="l32.103">   daemon.setMessages([&quot;message1.eml&quot;]);</span>
<a href="#l32.104"></a><span id="l32.104">   async_run_tests(tests);</span>
<a href="#l32.105"></a><span id="l32.105"> }</span>
<a href="#l32.106"></a><span id="l32.106"> </span>
<a href="#l32.107"></a><span id="l32.107" class="difflineminus">-function* getMail1()</span>
<a href="#l32.108"></a><span id="l32.108" class="difflineminus">-{</span>
<a href="#l32.109"></a><span id="l32.109" class="difflineplus">+function* getMail1() {</span>
<a href="#l32.110"></a><span id="l32.110">   dump(&quot;\nGet Mail 1\n&quot;);</span>
<a href="#l32.111"></a><span id="l32.111"> </span>
<a href="#l32.112"></a><span id="l32.112">   // Now get mail</span>
<a href="#l32.113"></a><span id="l32.113">   getPopMail();</span>
<a href="#l32.114"></a><span id="l32.114">   yield false;</span>
<a href="#l32.115"></a><span id="l32.115"> </span>
<a href="#l32.116"></a><span id="l32.116">   dump(&quot;\nGot Mail 1\n&quot;);</span>
<a href="#l32.117"></a><span id="l32.117"> </span>
<a href="#l32.118"></a><span id="l32.118" class="difflineat">@@ -144,18 +141,17 @@ function* getMail1()</span>
<a href="#l32.119"></a><span id="l32.119">   Assert.equal(count.value, 1);</span>
<a href="#l32.120"></a><span id="l32.120">   Assert.equal(logins[0].username, kUserName);</span>
<a href="#l32.121"></a><span id="l32.121">   Assert.equal(logins[0].password, kInvalidPassword);</span>
<a href="#l32.122"></a><span id="l32.122"> </span>
<a href="#l32.123"></a><span id="l32.123">   server.resetTest();</span>
<a href="#l32.124"></a><span id="l32.124">   yield true;</span>
<a href="#l32.125"></a><span id="l32.125"> }</span>
<a href="#l32.126"></a><span id="l32.126"> </span>
<a href="#l32.127"></a><span id="l32.127" class="difflineminus">-function* getMail2()</span>
<a href="#l32.128"></a><span id="l32.128" class="difflineminus">-{</span>
<a href="#l32.129"></a><span id="l32.129" class="difflineplus">+function* getMail2() {</span>
<a href="#l32.130"></a><span id="l32.130">   dump(&quot;\nGet Mail 2\n&quot;);</span>
<a href="#l32.131"></a><span id="l32.131"> </span>
<a href="#l32.132"></a><span id="l32.132">   // Now get the mail</span>
<a href="#l32.133"></a><span id="l32.133">   getPopMail();</span>
<a href="#l32.134"></a><span id="l32.134">   yield false;</span>
<a href="#l32.135"></a><span id="l32.135">   dump(&quot;\nGot Mail 2\n&quot;);</span>
<a href="#l32.136"></a><span id="l32.136"> </span>
<a href="#l32.137"></a><span id="l32.137">   // Now check the new one has been saved.</span>
<a href="#l32.138"></a><span id="l32.138" class="difflineat">@@ -164,22 +160,21 @@ function* getMail2()</span>
<a href="#l32.139"></a><span id="l32.139">                                           &quot;mailbox://localhost&quot;);</span>
<a href="#l32.140"></a><span id="l32.140"> </span>
<a href="#l32.141"></a><span id="l32.141">   Assert.equal(count.value, 1);</span>
<a href="#l32.142"></a><span id="l32.142">   Assert.equal(logins[0].username, kUserName);</span>
<a href="#l32.143"></a><span id="l32.143">   Assert.equal(logins[0].password, kValidPassword);</span>
<a href="#l32.144"></a><span id="l32.144">   yield true;</span>
<a href="#l32.145"></a><span id="l32.145"> }</span>
<a href="#l32.146"></a><span id="l32.146"> </span>
<a href="#l32.147"></a><span id="l32.147" class="difflineminus">-function* end_test()</span>
<a href="#l32.148"></a><span id="l32.148" class="difflineminus">-{</span>
<a href="#l32.149"></a><span id="l32.149" class="difflineplus">+function* end_test() {</span>
<a href="#l32.150"></a><span id="l32.150">   do_test_finished();</span>
<a href="#l32.151"></a><span id="l32.151"> }</span>
<a href="#l32.152"></a><span id="l32.152"> </span>
<a href="#l32.153"></a><span id="l32.153" class="difflineminus">-add_task(async function () {</span>
<a href="#l32.154"></a><span id="l32.154" class="difflineplus">+add_task(async function() {</span>
<a href="#l32.155"></a><span id="l32.155">   // Disable new mail notifications</span>
<a href="#l32.156"></a><span id="l32.156">   Services.prefs.setBoolPref(&quot;mail.biff.play_sound&quot;, false);</span>
<a href="#l32.157"></a><span id="l32.157">   Services.prefs.setBoolPref(&quot;mail.biff.show_alert&quot;, false);</span>
<a href="#l32.158"></a><span id="l32.158">   Services.prefs.setBoolPref(&quot;mail.biff.show_tray_icon&quot;, false);</span>
<a href="#l32.159"></a><span id="l32.159">   Services.prefs.setBoolPref(&quot;mail.biff.animate_dock_icon&quot;, false);</span>
<a href="#l32.160"></a><span id="l32.160">   Services.prefs.setBoolPref(&quot;signon.debug&quot;, true);</span>
<a href="#l32.161"></a><span id="l32.161"> </span>
<a href="#l32.162"></a><span id="l32.162">   // Prepare files for passwords (generated by a script in bug 1018624).</span>
<a href="#l32.163"></a><span id="l32.163" class="difflineat">@@ -211,12 +206,8 @@ add_task(async function () {</span>
<a href="#l32.164"></a><span id="l32.164">   // Check that we haven't got any messages in the folder, if we have its a test</span>
<a href="#l32.165"></a><span id="l32.165">   // setup issue.</span>
<a href="#l32.166"></a><span id="l32.166">   Assert.equal(localAccountUtils.inboxFolder.getTotalMessages(false), 0);</span>
<a href="#l32.167"></a><span id="l32.167"> </span>
<a href="#l32.168"></a><span id="l32.168">   do_test_pending();</span>
<a href="#l32.169"></a><span id="l32.169"> </span>
<a href="#l32.170"></a><span id="l32.170">   actually_run_test();</span>
<a href="#l32.171"></a><span id="l32.171"> });</span>
<a href="#l32.172"></a><span id="l32.172" class="difflineminus">-</span>
<a href="#l32.173"></a><span id="l32.173" class="difflineminus">-function run_test() {</span>
<a href="#l32.174"></a><span id="l32.174" class="difflineminus">-  run_next_test();</span>
<a href="#l32.175"></a><span id="l32.175" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l33.1"></a><span id="l33.1" class="difflineminus">--- a/mailnews/local/test/unit/test_pop3PasswordFailure2.js</span>
<a href="#l33.2"></a><span id="l33.2" class="difflineplus">+++ b/mailnews/local/test/unit/test_pop3PasswordFailure2.js</span>
<a href="#l33.3"></a><span id="l33.3" class="difflineat">@@ -4,39 +4,40 @@</span>
<a href="#l33.4"></a><span id="l33.4">  *   - Have an invalid password in the password database.</span>
<a href="#l33.5"></a><span id="l33.5">  *   - Check we get a prompt asking what to do.</span>
<a href="#l33.6"></a><span id="l33.6">  *   - Check retry does what it should do.</span>
<a href="#l33.7"></a><span id="l33.7">  *   - Check cancel does what it should do.</span>
<a href="#l33.8"></a><span id="l33.8">  *   - Re-initiate connection, this time select enter new password, check that</span>
<a href="#l33.9"></a><span id="l33.9">  *     we get a new password prompt and can enter the password.</span>
<a href="#l33.10"></a><span id="l33.10">  */</span>
<a href="#l33.11"></a><span id="l33.11"> </span>
<a href="#l33.12"></a><span id="l33.12" class="difflineminus">-ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l33.13"></a><span id="l33.13" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l33.14"></a><span id="l33.14" class="difflineminus">-ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l33.15"></a><span id="l33.15" class="difflineplus">+/* import-globals-from ../../../test/resources/logHelper.js */</span>
<a href="#l33.16"></a><span id="l33.16" class="difflineplus">+/* import-globals-from ../../../test/resources/asyncTestUtils.js */</span>
<a href="#l33.17"></a><span id="l33.17" class="difflineplus">+/* import-globals-from ../../../test/resources/alertTestUtils.js */</span>
<a href="#l33.18"></a><span id="l33.18" class="difflineplus">+/* import-globals-from ../../../test/resources/passwordStorage.js */</span>
<a href="#l33.19"></a><span id="l33.19" class="difflineplus">+/* import-globals-from ../../../test/resources/mailTestUtils.js */</span>
<a href="#l33.20"></a><span id="l33.20"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l33.21"></a><span id="l33.21"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l33.22"></a><span id="l33.22"> load(&quot;../../../resources/alertTestUtils.js&quot;);</span>
<a href="#l33.23"></a><span id="l33.23"> load(&quot;../../../resources/passwordStorage.js&quot;);</span>
<a href="#l33.24"></a><span id="l33.24"> load(&quot;../../../resources/mailTestUtils.js&quot;);</span>
<a href="#l33.25"></a><span id="l33.25"> </span>
<a href="#l33.26"></a><span id="l33.26" class="difflineminus">-var test = null;</span>
<a href="#l33.27"></a><span id="l33.27"> var server;</span>
<a href="#l33.28"></a><span id="l33.28"> var daemon;</span>
<a href="#l33.29"></a><span id="l33.29"> var incomingServer;</span>
<a href="#l33.30"></a><span id="l33.30"> var attempt = 0;</span>
<a href="#l33.31"></a><span id="l33.31"> var count = {};</span>
<a href="#l33.32"></a><span id="l33.32"> var logins;</span>
<a href="#l33.33"></a><span id="l33.33"> </span>
<a href="#l33.34"></a><span id="l33.34"> var kUserName = &quot;testpop3&quot;;</span>
<a href="#l33.35"></a><span id="l33.35"> var kInvalidPassword = &quot;pop3test&quot;;</span>
<a href="#l33.36"></a><span id="l33.36"> var kValidPassword = &quot;testpop3&quot;;</span>
<a href="#l33.37"></a><span id="l33.37"> </span>
<a href="#l33.38"></a><span id="l33.38" class="difflineminus">-function alert(aDialogText, aText)</span>
<a href="#l33.39"></a><span id="l33.39" class="difflineminus">-{</span>
<a href="#l33.40"></a><span id="l33.40" class="difflineplus">+/* exported alert, confirmEx, promptPasswordPS */</span>
<a href="#l33.41"></a><span id="l33.41" class="difflineplus">+function alert(aDialogText, aText) {</span>
<a href="#l33.42"></a><span id="l33.42">   // The first few attempts may prompt about the password problem, the last</span>
<a href="#l33.43"></a><span id="l33.43">   // attempt shouldn't.</span>
<a href="#l33.44"></a><span id="l33.44">   Assert.ok(attempt &lt; 4);</span>
<a href="#l33.45"></a><span id="l33.45"> </span>
<a href="#l33.46"></a><span id="l33.46">   // Log the fact we've got an alert, but we don't need to test anything here.</span>
<a href="#l33.47"></a><span id="l33.47">   dump(&quot;Alert Title: &quot; + aDialogText + &quot;\nAlert Text: &quot; + aText + &quot;\n&quot;);</span>
<a href="#l33.48"></a><span id="l33.48"> }</span>
<a href="#l33.49"></a><span id="l33.49"> </span>
<a href="#l33.50"></a><span id="l33.50" class="difflineat">@@ -75,51 +76,49 @@ function promptPasswordPS(aParent, aDial</span>
<a href="#l33.51"></a><span id="l33.51">   return false;</span>
<a href="#l33.52"></a><span id="l33.52"> }</span>
<a href="#l33.53"></a><span id="l33.53"> </span>
<a href="#l33.54"></a><span id="l33.54"> function getPopMail() {</span>
<a href="#l33.55"></a><span id="l33.55">   MailServices.pop3.GetNewMail(gDummyMsgWindow, urlListener, localAccountUtils.inboxFolder,</span>
<a href="#l33.56"></a><span id="l33.56">                                incomingServer);</span>
<a href="#l33.57"></a><span id="l33.57"> }</span>
<a href="#l33.58"></a><span id="l33.58"> </span>
<a href="#l33.59"></a><span id="l33.59" class="difflineminus">-var urlListener =</span>
<a href="#l33.60"></a><span id="l33.60" class="difflineminus">-{</span>
<a href="#l33.61"></a><span id="l33.61" class="difflineminus">-  OnStartRunningUrl: function (url) {</span>
<a href="#l33.62"></a><span id="l33.62" class="difflineplus">+var urlListener = {</span>
<a href="#l33.63"></a><span id="l33.63" class="difflineplus">+  OnStartRunningUrl(url) {</span>
<a href="#l33.64"></a><span id="l33.64">   },</span>
<a href="#l33.65"></a><span id="l33.65" class="difflineminus">-  OnStopRunningUrl: function (url, result) {</span>
<a href="#l33.66"></a><span id="l33.66" class="difflineplus">+  OnStopRunningUrl(url, result) {</span>
<a href="#l33.67"></a><span id="l33.67">     try {</span>
<a href="#l33.68"></a><span id="l33.68">       // On the last attempt, we should have successfully got one mail.</span>
<a href="#l33.69"></a><span id="l33.69">       Assert.equal(localAccountUtils.inboxFolder.getTotalMessages(false),</span>
<a href="#l33.70"></a><span id="l33.70">                    attempt == 4 ? 1 : 0);</span>
<a href="#l33.71"></a><span id="l33.71"> </span>
<a href="#l33.72"></a><span id="l33.72">       // If we've just cancelled, expect failure rather than success</span>
<a href="#l33.73"></a><span id="l33.73">       // because the server dropped the connection.</span>
<a href="#l33.74"></a><span id="l33.74">       dump(&quot;in onStopRunning, result = &quot; + result + &quot;\n&quot;);</span>
<a href="#l33.75"></a><span id="l33.75">       Assert.equal(result, attempt == 2 ? Cr.NS_ERROR_FAILURE : 0);</span>
<a href="#l33.76"></a><span id="l33.76">       async_driver();</span>
<a href="#l33.77"></a><span id="l33.77" class="difflineminus">-    }</span>
<a href="#l33.78"></a><span id="l33.78" class="difflineminus">-    catch (e) {</span>
<a href="#l33.79"></a><span id="l33.79" class="difflineplus">+    } catch (e) {</span>
<a href="#l33.80"></a><span id="l33.80">       // If we have an error, clean up nicely before we throw it.</span>
<a href="#l33.81"></a><span id="l33.81">       server.stop();</span>
<a href="#l33.82"></a><span id="l33.82"> </span>
<a href="#l33.83"></a><span id="l33.83">       var thread = gThreadManager.currentThread;</span>
<a href="#l33.84"></a><span id="l33.84">       while (thread.hasPendingEvents())</span>
<a href="#l33.85"></a><span id="l33.85">         thread.processNextEvent(true);</span>
<a href="#l33.86"></a><span id="l33.86"> </span>
<a href="#l33.87"></a><span id="l33.87">       do_throw(e);</span>
<a href="#l33.88"></a><span id="l33.88">     }</span>
<a href="#l33.89"></a><span id="l33.89" class="difflineminus">-  }</span>
<a href="#l33.90"></a><span id="l33.90" class="difflineplus">+  },</span>
<a href="#l33.91"></a><span id="l33.91"> };</span>
<a href="#l33.92"></a><span id="l33.92"> </span>
<a href="#l33.93"></a><span id="l33.93"> // Definition of tests</span>
<a href="#l33.94"></a><span id="l33.94"> var tests = [</span>
<a href="#l33.95"></a><span id="l33.95">   getMail1,</span>
<a href="#l33.96"></a><span id="l33.96">   getMail2,</span>
<a href="#l33.97"></a><span id="l33.97" class="difflineminus">-  endTest</span>
<a href="#l33.98"></a><span id="l33.98" class="difflineminus">-]</span>
<a href="#l33.99"></a><span id="l33.99" class="difflineplus">+  endTest,</span>
<a href="#l33.100"></a><span id="l33.100" class="difflineplus">+];</span>
<a href="#l33.101"></a><span id="l33.101"> </span>
<a href="#l33.102"></a><span id="l33.102"> function actually_run_test() {</span>
<a href="#l33.103"></a><span id="l33.103">   daemon.setMessages([&quot;message1.eml&quot;]);</span>
<a href="#l33.104"></a><span id="l33.104">   async_run_tests(tests);</span>
<a href="#l33.105"></a><span id="l33.105"> }</span>
<a href="#l33.106"></a><span id="l33.106"> </span>
<a href="#l33.107"></a><span id="l33.107"> function* getMail1() {</span>
<a href="#l33.108"></a><span id="l33.108">   dump(&quot;\nGet Mail 1\n&quot;);</span>
<a href="#l33.109"></a><span id="l33.109" class="difflineat">@@ -159,18 +158,17 @@ function* endTest() {</span>
<a href="#l33.110"></a><span id="l33.110">                                       &quot;mailbox://localhost&quot;);</span>
<a href="#l33.111"></a><span id="l33.111"> </span>
<a href="#l33.112"></a><span id="l33.112">   Assert.equal(count.value, 1);</span>
<a href="#l33.113"></a><span id="l33.113">   Assert.equal(logins[0].username, kUserName);</span>
<a href="#l33.114"></a><span id="l33.114">   Assert.equal(logins[0].password, kValidPassword);</span>
<a href="#l33.115"></a><span id="l33.115">   yield true;</span>
<a href="#l33.116"></a><span id="l33.116"> }</span>
<a href="#l33.117"></a><span id="l33.117"> </span>
<a href="#l33.118"></a><span id="l33.118" class="difflineminus">-function run_test()</span>
<a href="#l33.119"></a><span id="l33.119" class="difflineminus">-{</span>
<a href="#l33.120"></a><span id="l33.120" class="difflineplus">+function run_test() {</span>
<a href="#l33.121"></a><span id="l33.121">   // Disable new mail notifications</span>
<a href="#l33.122"></a><span id="l33.122">   Services.prefs.setBoolPref(&quot;mail.biff.play_sound&quot;, false);</span>
<a href="#l33.123"></a><span id="l33.123">   Services.prefs.setBoolPref(&quot;mail.biff.show_alert&quot;, false);</span>
<a href="#l33.124"></a><span id="l33.124">   Services.prefs.setBoolPref(&quot;mail.biff.show_tray_icon&quot;, false);</span>
<a href="#l33.125"></a><span id="l33.125">   Services.prefs.setBoolPref(&quot;mail.biff.animate_dock_icon&quot;, false);</span>
<a href="#l33.126"></a><span id="l33.126">   Services.prefs.setBoolPref(&quot;signon.debug&quot;, true);</span>
<a href="#l33.127"></a><span id="l33.127"> </span>
<a href="#l33.128"></a><span id="l33.128">   // Prepare files for passwords (generated by a script in bug 1018624).</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l34.1"></a><span id="l34.1" class="difflineminus">--- a/mailnews/local/test/unit/test_pop3PasswordFailure3.js</span>
<a href="#l34.2"></a><span id="l34.2" class="difflineplus">+++ b/mailnews/local/test/unit/test_pop3PasswordFailure3.js</span>
<a href="#l34.3"></a><span id="l34.3" class="difflineat">@@ -6,39 +6,40 @@</span>
<a href="#l34.4"></a><span id="l34.4">  *   - Have an invalid password in the password database.</span>
<a href="#l34.5"></a><span id="l34.5">  *   - Check we get a prompt asking what to do.</span>
<a href="#l34.6"></a><span id="l34.6">  *   - Check retry does what it should do.</span>
<a href="#l34.7"></a><span id="l34.7">  *   - Check cancel does what it should do.</span>
<a href="#l34.8"></a><span id="l34.8">  *   - Re-initiate connection, this time select enter new password, check that</span>
<a href="#l34.9"></a><span id="l34.9">  *     we get a new password prompt and can enter the password.</span>
<a href="#l34.10"></a><span id="l34.10">  */</span>
<a href="#l34.11"></a><span id="l34.11"> </span>
<a href="#l34.12"></a><span id="l34.12" class="difflineminus">-ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l34.13"></a><span id="l34.13" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l34.14"></a><span id="l34.14" class="difflineminus">-ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l34.15"></a><span id="l34.15" class="difflineplus">+/* import-globals-from ../../../test/resources/logHelper.js */</span>
<a href="#l34.16"></a><span id="l34.16" class="difflineplus">+/* import-globals-from ../../../test/resources/asyncTestUtils.js */</span>
<a href="#l34.17"></a><span id="l34.17" class="difflineplus">+/* import-globals-from ../../../test/resources/alertTestUtils.js */</span>
<a href="#l34.18"></a><span id="l34.18" class="difflineplus">+/* import-globals-from ../../../test/resources/passwordStorage.js */</span>
<a href="#l34.19"></a><span id="l34.19" class="difflineplus">+/* import-globals-from ../../../test/resources/mailTestUtils.js */</span>
<a href="#l34.20"></a><span id="l34.20"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l34.21"></a><span id="l34.21"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l34.22"></a><span id="l34.22"> load(&quot;../../../resources/alertTestUtils.js&quot;);</span>
<a href="#l34.23"></a><span id="l34.23"> load(&quot;../../../resources/passwordStorage.js&quot;);</span>
<a href="#l34.24"></a><span id="l34.24"> load(&quot;../../../resources/mailTestUtils.js&quot;);</span>
<a href="#l34.25"></a><span id="l34.25"> </span>
<a href="#l34.26"></a><span id="l34.26" class="difflineminus">-var test = null;</span>
<a href="#l34.27"></a><span id="l34.27"> var server;</span>
<a href="#l34.28"></a><span id="l34.28"> var daemon;</span>
<a href="#l34.29"></a><span id="l34.29"> var incomingServer;</span>
<a href="#l34.30"></a><span id="l34.30"> var attempt = 0;</span>
<a href="#l34.31"></a><span id="l34.31"> var count = {};</span>
<a href="#l34.32"></a><span id="l34.32"> var logins;</span>
<a href="#l34.33"></a><span id="l34.33"> </span>
<a href="#l34.34"></a><span id="l34.34"> var kUserName = &quot;testpop3&quot;;</span>
<a href="#l34.35"></a><span id="l34.35"> var kInvalidPassword = &quot;pop3test&quot;;</span>
<a href="#l34.36"></a><span id="l34.36"> var kValidPassword = &quot;testpop3&quot;;</span>
<a href="#l34.37"></a><span id="l34.37"> </span>
<a href="#l34.38"></a><span id="l34.38" class="difflineminus">-function alert(aDialogText, aText)</span>
<a href="#l34.39"></a><span id="l34.39" class="difflineminus">-{</span>
<a href="#l34.40"></a><span id="l34.40" class="difflineplus">+/* exported alert, confirmEx, promptPasswordPS */</span>
<a href="#l34.41"></a><span id="l34.41" class="difflineplus">+function alert(aDialogText, aText) {</span>
<a href="#l34.42"></a><span id="l34.42">   // The first few attempts may prompt about the password problem, the last</span>
<a href="#l34.43"></a><span id="l34.43">   // attempt shouldn't.</span>
<a href="#l34.44"></a><span id="l34.44">   Assert.ok(attempt &lt; 4);</span>
<a href="#l34.45"></a><span id="l34.45"> </span>
<a href="#l34.46"></a><span id="l34.46">   // Log the fact we've got an alert, but we don't need to test anything here.</span>
<a href="#l34.47"></a><span id="l34.47">   dump(&quot;Alert Title: &quot; + aDialogText + &quot;\nAlert Text: &quot; + aText + &quot;\n&quot;);</span>
<a href="#l34.48"></a><span id="l34.48"> }</span>
<a href="#l34.49"></a><span id="l34.49"> </span>
<a href="#l34.50"></a><span id="l34.50" class="difflineat">@@ -77,51 +78,49 @@ function promptPasswordPS(aParent, aDial</span>
<a href="#l34.51"></a><span id="l34.51">   return false;</span>
<a href="#l34.52"></a><span id="l34.52"> }</span>
<a href="#l34.53"></a><span id="l34.53"> </span>
<a href="#l34.54"></a><span id="l34.54"> function getPopMail() {</span>
<a href="#l34.55"></a><span id="l34.55">   MailServices.pop3.GetNewMail(gDummyMsgWindow, urlListener, localAccountUtils.inboxFolder,</span>
<a href="#l34.56"></a><span id="l34.56">                                incomingServer);</span>
<a href="#l34.57"></a><span id="l34.57"> }</span>
<a href="#l34.58"></a><span id="l34.58"> </span>
<a href="#l34.59"></a><span id="l34.59" class="difflineminus">-var urlListener =</span>
<a href="#l34.60"></a><span id="l34.60" class="difflineminus">-{</span>
<a href="#l34.61"></a><span id="l34.61" class="difflineminus">-  OnStartRunningUrl: function (url) {</span>
<a href="#l34.62"></a><span id="l34.62" class="difflineplus">+var urlListener = {</span>
<a href="#l34.63"></a><span id="l34.63" class="difflineplus">+  OnStartRunningUrl(url) {</span>
<a href="#l34.64"></a><span id="l34.64">   },</span>
<a href="#l34.65"></a><span id="l34.65" class="difflineminus">-  OnStopRunningUrl: function (url, result) {</span>
<a href="#l34.66"></a><span id="l34.66" class="difflineplus">+  OnStopRunningUrl(url, result) {</span>
<a href="#l34.67"></a><span id="l34.67">     try {</span>
<a href="#l34.68"></a><span id="l34.68">       // On the last attempt, we should have successfully got one mail.</span>
<a href="#l34.69"></a><span id="l34.69">       Assert.equal(localAccountUtils.inboxFolder.getTotalMessages(false),</span>
<a href="#l34.70"></a><span id="l34.70">                    attempt == 4 ? 1 : 0);</span>
<a href="#l34.71"></a><span id="l34.71"> </span>
<a href="#l34.72"></a><span id="l34.72">       // If we've just cancelled, expect failure rather than success</span>
<a href="#l34.73"></a><span id="l34.73">       // because the server dropped the connection.</span>
<a href="#l34.74"></a><span id="l34.74">       dump(&quot;in onStopRunning, result = &quot; + result + &quot;\n&quot;);</span>
<a href="#l34.75"></a><span id="l34.75">       Assert.equal(result, attempt == 2 ? Cr.NS_ERROR_FAILURE : 0);</span>
<a href="#l34.76"></a><span id="l34.76">       async_driver();</span>
<a href="#l34.77"></a><span id="l34.77" class="difflineminus">-    }</span>
<a href="#l34.78"></a><span id="l34.78" class="difflineminus">-    catch (e) {</span>
<a href="#l34.79"></a><span id="l34.79" class="difflineplus">+    } catch (e) {</span>
<a href="#l34.80"></a><span id="l34.80">       // If we have an error, clean up nicely before we throw it.</span>
<a href="#l34.81"></a><span id="l34.81">       server.stop();</span>
<a href="#l34.82"></a><span id="l34.82"> </span>
<a href="#l34.83"></a><span id="l34.83">       var thread = gThreadManager.currentThread;</span>
<a href="#l34.84"></a><span id="l34.84">       while (thread.hasPendingEvents())</span>
<a href="#l34.85"></a><span id="l34.85">         thread.processNextEvent(true);</span>
<a href="#l34.86"></a><span id="l34.86"> </span>
<a href="#l34.87"></a><span id="l34.87">       do_throw(e);</span>
<a href="#l34.88"></a><span id="l34.88">     }</span>
<a href="#l34.89"></a><span id="l34.89" class="difflineminus">-  }</span>
<a href="#l34.90"></a><span id="l34.90" class="difflineplus">+  },</span>
<a href="#l34.91"></a><span id="l34.91"> };</span>
<a href="#l34.92"></a><span id="l34.92"> </span>
<a href="#l34.93"></a><span id="l34.93"> // Definition of tests</span>
<a href="#l34.94"></a><span id="l34.94"> var tests = [</span>
<a href="#l34.95"></a><span id="l34.95">   getMail1,</span>
<a href="#l34.96"></a><span id="l34.96">   getMail2,</span>
<a href="#l34.97"></a><span id="l34.97" class="difflineminus">-  endTest</span>
<a href="#l34.98"></a><span id="l34.98" class="difflineminus">-]</span>
<a href="#l34.99"></a><span id="l34.99" class="difflineplus">+  endTest,</span>
<a href="#l34.100"></a><span id="l34.100" class="difflineplus">+];</span>
<a href="#l34.101"></a><span id="l34.101"> </span>
<a href="#l34.102"></a><span id="l34.102"> function actually_run_test() {</span>
<a href="#l34.103"></a><span id="l34.103">   daemon.setMessages([&quot;message1.eml&quot;]);</span>
<a href="#l34.104"></a><span id="l34.104">   async_run_tests(tests);</span>
<a href="#l34.105"></a><span id="l34.105"> }</span>
<a href="#l34.106"></a><span id="l34.106"> </span>
<a href="#l34.107"></a><span id="l34.107"> function* getMail1() {</span>
<a href="#l34.108"></a><span id="l34.108">   dump(&quot;\nGet Mail 1\n&quot;);</span>
<a href="#l34.109"></a><span id="l34.109" class="difflineat">@@ -161,18 +160,17 @@ function* endTest() {</span>
<a href="#l34.110"></a><span id="l34.110">                                       &quot;mailbox://localhost&quot;);</span>
<a href="#l34.111"></a><span id="l34.111"> </span>
<a href="#l34.112"></a><span id="l34.112">   Assert.equal(count.value, 1);</span>
<a href="#l34.113"></a><span id="l34.113">   Assert.equal(logins[0].username, kUserName);</span>
<a href="#l34.114"></a><span id="l34.114">   Assert.equal(logins[0].password, kValidPassword);</span>
<a href="#l34.115"></a><span id="l34.115">   yield true;</span>
<a href="#l34.116"></a><span id="l34.116"> }</span>
<a href="#l34.117"></a><span id="l34.117"> </span>
<a href="#l34.118"></a><span id="l34.118" class="difflineminus">-function run_test()</span>
<a href="#l34.119"></a><span id="l34.119" class="difflineminus">-{</span>
<a href="#l34.120"></a><span id="l34.120" class="difflineplus">+function run_test() {</span>
<a href="#l34.121"></a><span id="l34.121">   // Disable new mail notifications</span>
<a href="#l34.122"></a><span id="l34.122">   Services.prefs.setBoolPref(&quot;mail.biff.play_sound&quot;, false);</span>
<a href="#l34.123"></a><span id="l34.123">   Services.prefs.setBoolPref(&quot;mail.biff.show_alert&quot;, false);</span>
<a href="#l34.124"></a><span id="l34.124">   Services.prefs.setBoolPref(&quot;mail.biff.show_tray_icon&quot;, false);</span>
<a href="#l34.125"></a><span id="l34.125">   Services.prefs.setBoolPref(&quot;mail.biff.animate_dock_icon&quot;, false);</span>
<a href="#l34.126"></a><span id="l34.126">   Services.prefs.setBoolPref(&quot;signon.debug&quot;, true);</span>
<a href="#l34.127"></a><span id="l34.127"> </span>
<a href="#l34.128"></a><span id="l34.128">   // Prepare files for passwords (generated by a script in bug 1018624).</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l35.1"></a><span id="l35.1" class="difflineminus">--- a/mailnews/local/test/unit/test_pop3Proxy.js</span>
<a href="#l35.2"></a><span id="l35.2" class="difflineplus">+++ b/mailnews/local/test/unit/test_pop3Proxy.js</span>
<a href="#l35.3"></a><span id="l35.3" class="difflineat">@@ -42,12 +42,8 @@ add_task(async function downloadEmail() </span>
<a href="#l35.4"></a><span id="l35.4">   equal(localAccountUtils.inboxFolder.getTotalMessages(false), 1);</span>
<a href="#l35.5"></a><span id="l35.5"> });</span>
<a href="#l35.6"></a><span id="l35.6"> </span>
<a href="#l35.7"></a><span id="l35.7"> add_task(async function cleanUp() {</span>
<a href="#l35.8"></a><span id="l35.8">   NetworkTestUtils.shutdownServers();</span>
<a href="#l35.9"></a><span id="l35.9">   incomingServer.closeCachedConnections();</span>
<a href="#l35.10"></a><span id="l35.10">   server.stop();</span>
<a href="#l35.11"></a><span id="l35.11"> });</span>
<a href="#l35.12"></a><span id="l35.12" class="difflineminus">-</span>
<a href="#l35.13"></a><span id="l35.13" class="difflineminus">-function run_test() {</span>
<a href="#l35.14"></a><span id="l35.14" class="difflineminus">-  run_next_test();</span>
<a href="#l35.15"></a><span id="l35.15" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l36.1"></a><span id="l36.1" class="difflineminus">--- a/mailnews/local/test/unit/test_pop3Pump.js</span>
<a href="#l36.2"></a><span id="l36.2" class="difflineplus">+++ b/mailnews/local/test/unit/test_pop3Pump.js</span>
<a href="#l36.3"></a><span id="l36.3" class="difflineat">@@ -1,12 +1,13 @@</span>
<a href="#l36.4"></a><span id="l36.4"> /**</span>
<a href="#l36.5"></a><span id="l36.5">  * The intent of this file is to demonstrate a minimal</span>
<a href="#l36.6"></a><span id="l36.6">  * POP3 unit test using the testing file POP3Pump.js</span>
<a href="#l36.7"></a><span id="l36.7">  */</span>
<a href="#l36.8"></a><span id="l36.8" class="difflineplus">+/* import-globals-from ../../../test/resources/POP3pump.js */</span>
<a href="#l36.9"></a><span id="l36.9"> load(&quot;../../../resources/POP3pump.js&quot;);</span>
<a href="#l36.10"></a><span id="l36.10"> </span>
<a href="#l36.11"></a><span id="l36.11"> var testSubjects = [&quot;[Bug 397009] A filter will let me tag, but not untag&quot;,</span>
<a href="#l36.12"></a><span id="l36.12">                     &quot;Hello, did you receive my bugmail?&quot;];</span>
<a href="#l36.13"></a><span id="l36.13"> </span>
<a href="#l36.14"></a><span id="l36.14"> add_task(async function runPump() {</span>
<a href="#l36.15"></a><span id="l36.15">   // demonstration of access to the local inbox folder</span>
<a href="#l36.16"></a><span id="l36.16">   dump(&quot;local inbox folder &quot; + localAccountUtils.inboxFolder.URI + &quot; is loaded\n&quot;);</span>
<a href="#l36.17"></a><span id="l36.17" class="difflineat">@@ -23,12 +24,8 @@ add_task(async function runPump() {</span>
<a href="#l36.18"></a><span id="l36.18">   while (enumerator.hasMoreElements()) {</span>
<a href="#l36.19"></a><span id="l36.19">     msgCount++;</span>
<a href="#l36.20"></a><span id="l36.20">     let hdr = enumerator.getNext().QueryInterface(Ci.nsIMsgDBHdr);</span>
<a href="#l36.21"></a><span id="l36.21">     Assert.equal(hdr.subject, testSubjects[msgCount - 1]);</span>
<a href="#l36.22"></a><span id="l36.22">   }</span>
<a href="#l36.23"></a><span id="l36.23">   Assert.equal(msgCount, 2);</span>
<a href="#l36.24"></a><span id="l36.24">   gPOP3Pump = null;</span>
<a href="#l36.25"></a><span id="l36.25"> });</span>
<a href="#l36.26"></a><span id="l36.26" class="difflineminus">-</span>
<a href="#l36.27"></a><span id="l36.27" class="difflineminus">-function run_test() {</span>
<a href="#l36.28"></a><span id="l36.28" class="difflineminus">-  run_next_test();</span>
<a href="#l36.29"></a><span id="l36.29" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l37.1"></a><span id="l37.1" class="difflineminus">--- a/mailnews/local/test/unit/test_pop3ServerBrokenCRAMDisconnect.js</span>
<a href="#l37.2"></a><span id="l37.2" class="difflineplus">+++ b/mailnews/local/test/unit/test_pop3ServerBrokenCRAMDisconnect.js</span>
<a href="#l37.3"></a><span id="l37.3" class="difflineat">@@ -18,77 +18,72 @@</span>
<a href="#l37.4"></a><span id="l37.4">  *    and start with the next in list, not trying the broken one again.</span>
<a href="#l37.5"></a><span id="l37.5">  *    We currently neither retry nor remember.</span>
<a href="#l37.6"></a><span id="l37.6">  * - incomingServer thinks it is still running/busy although the connection is</span>
<a href="#l37.7"></a><span id="l37.7">  *    clearly done and over.</span>
<a href="#l37.8"></a><span id="l37.8">  *</span>
<a href="#l37.9"></a><span id="l37.9">  * @author Ben Bucksch</span>
<a href="#l37.10"></a><span id="l37.10">  */</span>
<a href="#l37.11"></a><span id="l37.11"> </span>
<a href="#l37.12"></a><span id="l37.12" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l37.13"></a><span id="l37.13" class="difflineminus">-</span>
<a href="#l37.14"></a><span id="l37.14"> var server;</span>
<a href="#l37.15"></a><span id="l37.15"> var daemon;</span>
<a href="#l37.16"></a><span id="l37.16"> var incomingServer;</span>
<a href="#l37.17"></a><span id="l37.17" class="difflineminus">-var test = &quot;Server which advertises CRAM-MD5, but closes the connection when it's tried&quot;;</span>
<a href="#l37.18"></a><span id="l37.18" class="difflineplus">+test = &quot;Server which advertises CRAM-MD5, but closes the connection when it's tried&quot;;</span>
<a href="#l37.19"></a><span id="l37.19"> // that's how it currently looks like (we fail to log in):</span>
<a href="#l37.20"></a><span id="l37.20" class="difflineminus">-var expectedTransaction = [ &quot;AUTH&quot;, &quot;CAPA&quot;, &quot;AUTH CRAM-MD5&quot; ];</span>
<a href="#l37.21"></a><span id="l37.21" class="difflineplus">+var expectedTransaction = [&quot;AUTH&quot;, &quot;CAPA&quot;, &quot;AUTH CRAM-MD5&quot;];</span>
<a href="#l37.22"></a><span id="l37.22"> // TODO that's how it should look like (we start a new connection and try another scheme):</span>
<a href="#l37.23"></a><span id="l37.23" class="difflineminus">-//const expectedTransaction = [ &quot;AUTH&quot;, &quot;CAPA&quot;, &quot;AUTH CRAM-MD5&quot;, &quot;CAPA&quot;, &quot;AUTH PLAIN&quot;, &quot;STAT&quot; ];</span>
<a href="#l37.24"></a><span id="l37.24" class="difflineplus">+// const expectedTransaction = [&quot;AUTH&quot;, &quot;CAPA&quot;, &quot;AUTH CRAM-MD5&quot;, &quot;CAPA&quot;, &quot;AUTH PLAIN&quot;, &quot;STAT&quot;];</span>
<a href="#l37.25"></a><span id="l37.25"> </span>
<a href="#l37.26"></a><span id="l37.26" class="difflineminus">-var urlListener =</span>
<a href="#l37.27"></a><span id="l37.27" class="difflineminus">-{</span>
<a href="#l37.28"></a><span id="l37.28" class="difflineminus">-  OnStartRunningUrl: function (url) {</span>
<a href="#l37.29"></a><span id="l37.29" class="difflineplus">+var urlListener = {</span>
<a href="#l37.30"></a><span id="l37.30" class="difflineplus">+  OnStartRunningUrl(url) {</span>
<a href="#l37.31"></a><span id="l37.31">   },</span>
<a href="#l37.32"></a><span id="l37.32" class="difflineminus">-  OnStopRunningUrl: function (url, result) {</span>
<a href="#l37.33"></a><span id="l37.33" class="difflineplus">+  OnStopRunningUrl(url, result) {</span>
<a href="#l37.34"></a><span id="l37.34">     try {</span>
<a href="#l37.35"></a><span id="l37.35">       // We should be getting an error here, because we couldn't log in.</span>
<a href="#l37.36"></a><span id="l37.36">       Assert.equal(result, Cr.NS_ERROR_FAILURE);</span>
<a href="#l37.37"></a><span id="l37.37"> </span>
<a href="#l37.38"></a><span id="l37.38">       var transaction = server.playTransaction();</span>
<a href="#l37.39"></a><span id="l37.39">       do_check_transaction(transaction, expectedTransaction);</span>
<a href="#l37.40"></a><span id="l37.40"> </span>
<a href="#l37.41"></a><span id="l37.41">       do_timeout(0, endTest);</span>
<a href="#l37.42"></a><span id="l37.42">     } catch (e) {</span>
<a href="#l37.43"></a><span id="l37.43">       server.stop();</span>
<a href="#l37.44"></a><span id="l37.44">       var thread = gThreadManager.currentThread;</span>
<a href="#l37.45"></a><span id="l37.45">       while (thread.hasPendingEvents())</span>
<a href="#l37.46"></a><span id="l37.46">         thread.processNextEvent(true);</span>
<a href="#l37.47"></a><span id="l37.47"> </span>
<a href="#l37.48"></a><span id="l37.48">       do_throw(e);</span>
<a href="#l37.49"></a><span id="l37.49">     }</span>
<a href="#l37.50"></a><span id="l37.50" class="difflineminus">-  }</span>
<a href="#l37.51"></a><span id="l37.51" class="difflineplus">+  },</span>
<a href="#l37.52"></a><span id="l37.52"> };</span>
<a href="#l37.53"></a><span id="l37.53"> </span>
<a href="#l37.54"></a><span id="l37.54"> function endTest() {</span>
<a href="#l37.55"></a><span id="l37.55">   // No more tests, let everything finish</span>
<a href="#l37.56"></a><span id="l37.56">   server.stop();</span>
<a href="#l37.57"></a><span id="l37.57"> </span>
<a href="#l37.58"></a><span id="l37.58">   var thread = gThreadManager.currentThread;</span>
<a href="#l37.59"></a><span id="l37.59">   while (thread.hasPendingEvents())</span>
<a href="#l37.60"></a><span id="l37.60">     thread.processNextEvent(true);</span>
<a href="#l37.61"></a><span id="l37.61"> </span>
<a href="#l37.62"></a><span id="l37.62">   do_test_finished();</span>
<a href="#l37.63"></a><span id="l37.63"> }</span>
<a href="#l37.64"></a><span id="l37.64"> </span>
<a href="#l37.65"></a><span id="l37.65" class="difflineminus">-function CRAMFail_handler(daemon)</span>
<a href="#l37.66"></a><span id="l37.66" class="difflineminus">-{</span>
<a href="#l37.67"></a><span id="l37.67" class="difflineminus">-  POP3_RFC5034_handler.call(this, daemon);</span>
<a href="#l37.68"></a><span id="l37.68" class="difflineplus">+function CRAMFail_handler(daemon_) {</span>
<a href="#l37.69"></a><span id="l37.69" class="difflineplus">+  POP3_RFC5034_handler.call(this, daemon_);</span>
<a href="#l37.70"></a><span id="l37.70"> </span>
<a href="#l37.71"></a><span id="l37.71">   this._kAuthSchemeStartFunction[&quot;CRAM-MD5&quot;] = this.killConn;</span>
<a href="#l37.72"></a><span id="l37.72"> }</span>
<a href="#l37.73"></a><span id="l37.73"> CRAMFail_handler.prototype = {</span>
<a href="#l37.74"></a><span id="l37.74" class="difflineminus">-  __proto__ : POP3_RFC5034_handler.prototype, // inherit</span>
<a href="#l37.75"></a><span id="l37.75" class="difflineplus">+  __proto__: POP3_RFC5034_handler.prototype, // inherit</span>
<a href="#l37.76"></a><span id="l37.76"> </span>
<a href="#l37.77"></a><span id="l37.77" class="difflineminus">-  killConn : function()</span>
<a href="#l37.78"></a><span id="l37.78" class="difflineminus">-  {</span>
<a href="#l37.79"></a><span id="l37.79" class="difflineplus">+  killConn() {</span>
<a href="#l37.80"></a><span id="l37.80">     this.closing = true;</span>
<a href="#l37.81"></a><span id="l37.81">     return &quot;-ERR I don't feel like it&quot;;</span>
<a href="#l37.82"></a><span id="l37.82" class="difflineminus">-  }</span>
<a href="#l37.83"></a><span id="l37.83" class="difflineminus">-}</span>
<a href="#l37.84"></a><span id="l37.84" class="difflineplus">+  },</span>
<a href="#l37.85"></a><span id="l37.85" class="difflineplus">+};</span>
<a href="#l37.86"></a><span id="l37.86"> </span>
<a href="#l37.87"></a><span id="l37.87"> function run_test() {</span>
<a href="#l37.88"></a><span id="l37.88">   try {</span>
<a href="#l37.89"></a><span id="l37.89">     do_test_pending();</span>
<a href="#l37.90"></a><span id="l37.90"> </span>
<a href="#l37.91"></a><span id="l37.91">     // Disable new mail notifications</span>
<a href="#l37.92"></a><span id="l37.92">     Services.prefs.setBoolPref(&quot;mail.biff.play_sound&quot;, false);</span>
<a href="#l37.93"></a><span id="l37.93">     Services.prefs.setBoolPref(&quot;mail.biff.show_alert&quot;, false);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l38.1"></a><span id="l38.1" class="difflineminus">--- a/mailnews/local/test/unit/test_pop3ServerBrokenCRAMFail.js</span>
<a href="#l38.2"></a><span id="l38.2" class="difflineplus">+++ b/mailnews/local/test/unit/test_pop3ServerBrokenCRAMFail.js</span>
<a href="#l38.3"></a><span id="l38.3" class="difflineat">@@ -1,42 +1,40 @@</span>
<a href="#l38.4"></a><span id="l38.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l38.5"></a><span id="l38.5"> /**</span>
<a href="#l38.6"></a><span id="l38.6">  * Server which advertises CRAM-MD5, but fails when it's tried.</span>
<a href="#l38.7"></a><span id="l38.7">  * This reportedly happens for some misconfigured servers.</span>
<a href="#l38.8"></a><span id="l38.8">  */</span>
<a href="#l38.9"></a><span id="l38.9" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l38.10"></a><span id="l38.10"> </span>
<a href="#l38.11"></a><span id="l38.11"> var server;</span>
<a href="#l38.12"></a><span id="l38.12"> var daemon;</span>
<a href="#l38.13"></a><span id="l38.13"> var incomingServer;</span>
<a href="#l38.14"></a><span id="l38.14" class="difflineminus">-var test = &quot;Server which advertises CRAM-MD5, but fails when it's tried&quot;;</span>
<a href="#l38.15"></a><span id="l38.15" class="difflineminus">-var expectedTransaction = [ &quot;AUTH&quot;, &quot;CAPA&quot;, &quot;AUTH CRAM-MD5&quot;, &quot;AUTH PLAIN&quot;, &quot;STAT&quot; ];</span>
<a href="#l38.16"></a><span id="l38.16" class="difflineplus">+test = &quot;Server which advertises CRAM-MD5, but fails when it's tried&quot;;</span>
<a href="#l38.17"></a><span id="l38.17" class="difflineplus">+var expectedTransaction = [&quot;AUTH&quot;, &quot;CAPA&quot;, &quot;AUTH CRAM-MD5&quot;, &quot;AUTH PLAIN&quot;, &quot;STAT&quot;];</span>
<a href="#l38.18"></a><span id="l38.18"> </span>
<a href="#l38.19"></a><span id="l38.19" class="difflineminus">-var urlListener =</span>
<a href="#l38.20"></a><span id="l38.20" class="difflineminus">-{</span>
<a href="#l38.21"></a><span id="l38.21" class="difflineminus">-  OnStartRunningUrl: function (url) {</span>
<a href="#l38.22"></a><span id="l38.22" class="difflineplus">+var urlListener = {</span>
<a href="#l38.23"></a><span id="l38.23" class="difflineplus">+  OnStartRunningUrl(url) {</span>
<a href="#l38.24"></a><span id="l38.24">   },</span>
<a href="#l38.25"></a><span id="l38.25" class="difflineminus">-  OnStopRunningUrl: function (url, result) {</span>
<a href="#l38.26"></a><span id="l38.26" class="difflineplus">+  OnStopRunningUrl(url, result) {</span>
<a href="#l38.27"></a><span id="l38.27">     try {</span>
<a href="#l38.28"></a><span id="l38.28">       Assert.equal(result, 0);</span>
<a href="#l38.29"></a><span id="l38.29"> </span>
<a href="#l38.30"></a><span id="l38.30">       var transaction = server.playTransaction();</span>
<a href="#l38.31"></a><span id="l38.31">       do_check_transaction(transaction, expectedTransaction);</span>
<a href="#l38.32"></a><span id="l38.32"> </span>
<a href="#l38.33"></a><span id="l38.33">       do_timeout(0, checkBusy);</span>
<a href="#l38.34"></a><span id="l38.34">     } catch (e) {</span>
<a href="#l38.35"></a><span id="l38.35">       server.stop();</span>
<a href="#l38.36"></a><span id="l38.36">       var thread = gThreadManager.currentThread;</span>
<a href="#l38.37"></a><span id="l38.37">       while (thread.hasPendingEvents())</span>
<a href="#l38.38"></a><span id="l38.38">         thread.processNextEvent(true);</span>
<a href="#l38.39"></a><span id="l38.39"> </span>
<a href="#l38.40"></a><span id="l38.40">       do_throw(e);</span>
<a href="#l38.41"></a><span id="l38.41">     }</span>
<a href="#l38.42"></a><span id="l38.42" class="difflineminus">-  }</span>
<a href="#l38.43"></a><span id="l38.43" class="difflineplus">+  },</span>
<a href="#l38.44"></a><span id="l38.44"> };</span>
<a href="#l38.45"></a><span id="l38.45"> </span>
<a href="#l38.46"></a><span id="l38.46"> function checkBusy() {</span>
<a href="#l38.47"></a><span id="l38.47">   // If the server hasn't quite finished, just delay a little longer.</span>
<a href="#l38.48"></a><span id="l38.48">   if (incomingServer.serverBusy ||</span>
<a href="#l38.49"></a><span id="l38.49">       (incomingServer instanceof Ci.nsIPop3IncomingServer &amp;&amp;</span>
<a href="#l38.50"></a><span id="l38.50">        incomingServer.runningProtocol)) {</span>
<a href="#l38.51"></a><span id="l38.51">     do_timeout(20, checkBusy);</span>
<a href="#l38.52"></a><span id="l38.52" class="difflineat">@@ -54,32 +52,30 @@ function endTest() {</span>
<a href="#l38.53"></a><span id="l38.53"> </span>
<a href="#l38.54"></a><span id="l38.54">   var thread = gThreadManager.currentThread;</span>
<a href="#l38.55"></a><span id="l38.55">   while (thread.hasPendingEvents())</span>
<a href="#l38.56"></a><span id="l38.56">     thread.processNextEvent(true);</span>
<a href="#l38.57"></a><span id="l38.57"> </span>
<a href="#l38.58"></a><span id="l38.58">   do_test_finished();</span>
<a href="#l38.59"></a><span id="l38.59"> }</span>
<a href="#l38.60"></a><span id="l38.60"> </span>
<a href="#l38.61"></a><span id="l38.61" class="difflineminus">-function CRAMFail_handler(daemon)</span>
<a href="#l38.62"></a><span id="l38.62" class="difflineminus">-{</span>
<a href="#l38.63"></a><span id="l38.63" class="difflineminus">-  POP3_RFC5034_handler.call(this, daemon);</span>
<a href="#l38.64"></a><span id="l38.64" class="difflineplus">+function CRAMFail_handler(daemon_) {</span>
<a href="#l38.65"></a><span id="l38.65" class="difflineplus">+  POP3_RFC5034_handler.call(this, daemon_);</span>
<a href="#l38.66"></a><span id="l38.66"> </span>
<a href="#l38.67"></a><span id="l38.67">   this._kAuthSchemeStartFunction[&quot;CRAM-MD5&quot;] = this.killConn;</span>
<a href="#l38.68"></a><span id="l38.68"> }</span>
<a href="#l38.69"></a><span id="l38.69"> CRAMFail_handler.prototype = {</span>
<a href="#l38.70"></a><span id="l38.70" class="difflineminus">-  __proto__ : POP3_RFC5034_handler.prototype, // inherit</span>
<a href="#l38.71"></a><span id="l38.71" class="difflineplus">+  __proto__: POP3_RFC5034_handler.prototype, // inherit</span>
<a href="#l38.72"></a><span id="l38.72"> </span>
<a href="#l38.73"></a><span id="l38.73" class="difflineminus">-  killConn : function()</span>
<a href="#l38.74"></a><span id="l38.74" class="difflineminus">-  {</span>
<a href="#l38.75"></a><span id="l38.75" class="difflineplus">+  killConn() {</span>
<a href="#l38.76"></a><span id="l38.76">     this._multiline = false;</span>
<a href="#l38.77"></a><span id="l38.77">     this._state = kStateAuthNeeded;</span>
<a href="#l38.78"></a><span id="l38.78">     return &quot;-ERR I just pretended to implement CRAM-MD5&quot;;</span>
<a href="#l38.79"></a><span id="l38.79" class="difflineminus">-  }</span>
<a href="#l38.80"></a><span id="l38.80" class="difflineminus">-}</span>
<a href="#l38.81"></a><span id="l38.81" class="difflineplus">+  },</span>
<a href="#l38.82"></a><span id="l38.82" class="difflineplus">+};</span>
<a href="#l38.83"></a><span id="l38.83"> </span>
<a href="#l38.84"></a><span id="l38.84"> function run_test() {</span>
<a href="#l38.85"></a><span id="l38.85">   try {</span>
<a href="#l38.86"></a><span id="l38.86">     do_test_pending();</span>
<a href="#l38.87"></a><span id="l38.87"> </span>
<a href="#l38.88"></a><span id="l38.88">     // Disable new mail notifications</span>
<a href="#l38.89"></a><span id="l38.89">     Services.prefs.setBoolPref(&quot;mail.biff.play_sound&quot;, false);</span>
<a href="#l38.90"></a><span id="l38.90">     Services.prefs.setBoolPref(&quot;mail.biff.show_alert&quot;, false);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l39.1"></a><span id="l39.1" class="difflineminus">--- a/mailnews/local/test/unit/test_preview.js</span>
<a href="#l39.2"></a><span id="l39.2" class="difflineplus">+++ b/mailnews/local/test/unit/test_preview.js</span>
<a href="#l39.3"></a><span id="l39.3" class="difflineat">@@ -1,12 +1,12 @@</span>
<a href="#l39.4"></a><span id="l39.4"> var bugmail10 = do_get_file(&quot;../../../data/bugmail10&quot;);</span>
<a href="#l39.5"></a><span id="l39.5"> var bugmail11 = do_get_file(&quot;../../../data/bugmail11&quot;);</span>
<a href="#l39.6"></a><span id="l39.6" class="difflineminus">-var bugmail10_preview = 'Do not reply to this email. You can add comments to this bug at https://bugzilla.mozilla.org/show_bug.cgi?id=436880 -- Configure bugmail: https://bugzilla.mozilla.org/userprefs.cgi?tab=email ------- You are receiving this mail because: -----';</span>
<a href="#l39.7"></a><span id="l39.7" class="difflineminus">-var bugmail11_preview = 'Bugzilla has received a request to create a user account using your email address (example@example.org). To confirm that you want to create an account using that email address, visit the following link: https://bugzilla.mozilla.org/token.cgi?t=xxx';</span>
<a href="#l39.8"></a><span id="l39.8" class="difflineplus">+var bugmail10_preview = &quot;Do not reply to this email. You can add comments to this bug at https://bugzilla.mozilla.org/show_bug.cgi?id=436880 -- Configure bugmail: https://bugzilla.mozilla.org/userprefs.cgi?tab=email ------- You are receiving this mail because: -----&quot;;</span>
<a href="#l39.9"></a><span id="l39.9" class="difflineplus">+var bugmail11_preview = &quot;Bugzilla has received a request to create a user account using your email address (example@example.org). To confirm that you want to create an account using that email address, visit the following link: https://bugzilla.mozilla.org/token.cgi?t=xxx&quot;;</span>
<a href="#l39.10"></a><span id="l39.10"> </span>
<a href="#l39.11"></a><span id="l39.11"> function run_test() {</span>
<a href="#l39.12"></a><span id="l39.12">   do_test_pending();</span>
<a href="#l39.13"></a><span id="l39.13">   copyFileMessageInLocalFolder(bugmail10, 0, &quot;&quot;, null, copy_next_message);</span>
<a href="#l39.14"></a><span id="l39.14"> }</span>
<a href="#l39.15"></a><span id="l39.15"> </span>
<a href="#l39.16"></a><span id="l39.16"> function copy_next_message(aMessageHeaderKeys, aStatus) {</span>
<a href="#l39.17"></a><span id="l39.17">   copyFileMessageInLocalFolder(bugmail11, 0, &quot;&quot;, null, test_preview);</span>
<a href="#l39.18"></a><span id="l39.18" class="difflineat">@@ -14,15 +14,18 @@ function copy_next_message(aMessageHeade</span>
<a href="#l39.19"></a><span id="l39.19"> </span>
<a href="#l39.20"></a><span id="l39.20"> function test_preview(aMessageHeaderKeys, aStatus) {</span>
<a href="#l39.21"></a><span id="l39.21">   let headerKeys = aMessageHeaderKeys;</span>
<a href="#l39.22"></a><span id="l39.22">   Assert.notEqual(headerKeys, null);</span>
<a href="#l39.23"></a><span id="l39.23">   Assert.equal(headerKeys.length, 2);</span>
<a href="#l39.24"></a><span id="l39.24">   try {</span>
<a href="#l39.25"></a><span id="l39.25">     localAccountUtils.inboxFolder.fetchMsgPreviewText(headerKeys,</span>
<a href="#l39.26"></a><span id="l39.26">                                           headerKeys.length, false, null);</span>
<a href="#l39.27"></a><span id="l39.27" class="difflineminus">-    Assert.equal(localAccountUtils.inboxFolder.GetMessageHeader(headerKeys[0]).getStringProperty('preview'),</span>
<a href="#l39.28"></a><span id="l39.28" class="difflineplus">+    Assert.equal(localAccountUtils.inboxFolder.GetMessageHeader(headerKeys[0]).getStringProperty(&quot;preview&quot;),</span>
<a href="#l39.29"></a><span id="l39.29">                  bugmail10_preview);</span>
<a href="#l39.30"></a><span id="l39.30" class="difflineminus">-    Assert.equal(localAccountUtils.inboxFolder.GetMessageHeader(headerKeys[1]).getStringProperty('preview'),</span>
<a href="#l39.31"></a><span id="l39.31" class="difflineplus">+    Assert.equal(localAccountUtils.inboxFolder.GetMessageHeader(headerKeys[1]).getStringProperty(&quot;preview&quot;),</span>
<a href="#l39.32"></a><span id="l39.32">                  bugmail11_preview);</span>
<a href="#l39.33"></a><span id="l39.33" class="difflineminus">-  } catch(ex) {dump(ex); do_throw(ex) }</span>
<a href="#l39.34"></a><span id="l39.34" class="difflineplus">+  } catch (ex) {</span>
<a href="#l39.35"></a><span id="l39.35" class="difflineplus">+    dump(ex);</span>
<a href="#l39.36"></a><span id="l39.36" class="difflineplus">+    do_throw(ex);</span>
<a href="#l39.37"></a><span id="l39.37" class="difflineplus">+  }</span>
<a href="#l39.38"></a><span id="l39.38">   do_test_finished();</span>
<a href="#l39.39"></a><span id="l39.39"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l40.1"></a><span id="l40.1" class="difflineminus">--- a/mailnews/local/test/unit/test_saveMessage.js</span>
<a href="#l40.2"></a><span id="l40.2" class="difflineplus">+++ b/mailnews/local/test/unit/test_saveMessage.js</span>
<a href="#l40.3"></a><span id="l40.3" class="difflineat">@@ -5,23 +5,22 @@</span>
<a href="#l40.4"></a><span id="l40.4"> ChromeUtils.import(&quot;resource:///modules/IOUtils.js&quot;);</span>
<a href="#l40.5"></a><span id="l40.5"> </span>
<a href="#l40.6"></a><span id="l40.6"> var MSG_LINEBREAK = &quot;\r\n&quot;;</span>
<a href="#l40.7"></a><span id="l40.7"> var dot = do_get_file(&quot;data/dot&quot;);</span>
<a href="#l40.8"></a><span id="l40.8"> var saveFile = Services.dirsvc.get(&quot;TmpD&quot;, Ci.nsIFile);</span>
<a href="#l40.9"></a><span id="l40.9"> saveFile.append(dot.leafName + &quot;.eml&quot;);</span>
<a href="#l40.10"></a><span id="l40.10"> saveFile.createUnique(Ci.nsIFile.NORMAL_FILE_TYPE, 0o600);</span>
<a href="#l40.11"></a><span id="l40.11"> </span>
<a href="#l40.12"></a><span id="l40.12" class="difflineminus">-function run_test()</span>
<a href="#l40.13"></a><span id="l40.13" class="difflineminus">-{</span>
<a href="#l40.14"></a><span id="l40.14" class="difflineplus">+function run_test() {</span>
<a href="#l40.15"></a><span id="l40.15">   registerCleanupFunction(teardown);</span>
<a href="#l40.16"></a><span id="l40.16">   do_test_pending();</span>
<a href="#l40.17"></a><span id="l40.17">   do_timeout(10000, function() {</span>
<a href="#l40.18"></a><span id="l40.18" class="difflineminus">-    do_throw('SaveMessageToDisk did not complete within 10 seconds' +</span>
<a href="#l40.19"></a><span id="l40.19" class="difflineminus">-      '(incorrect messageURI?). ABORTING.');</span>
<a href="#l40.20"></a><span id="l40.20" class="difflineplus">+    do_throw(&quot;SaveMessageToDisk did not complete within 10 seconds&quot; +</span>
<a href="#l40.21"></a><span id="l40.21" class="difflineplus">+      &quot;(incorrect messageURI?). ABORTING.&quot;);</span>
<a href="#l40.22"></a><span id="l40.22">   });</span>
<a href="#l40.23"></a><span id="l40.23">   copyFileMessageInLocalFolder(dot, 0, &quot;&quot;, null, save_message);</span>
<a href="#l40.24"></a><span id="l40.24"> }</span>
<a href="#l40.25"></a><span id="l40.25"> </span>
<a href="#l40.26"></a><span id="l40.26"> function save_message(aMessageHeaderKeys, aStatus) {</span>
<a href="#l40.27"></a><span id="l40.27">   let headerKeys = aMessageHeaderKeys;</span>
<a href="#l40.28"></a><span id="l40.28">   Assert.notEqual(headerKeys, null);</span>
<a href="#l40.29"></a><span id="l40.29"> </span>
<a href="#l40.30"></a><span id="l40.30" class="difflineat">@@ -39,22 +38,22 @@ function check_each_line(aExpectedLines,</span>
<a href="#l40.31"></a><span id="l40.31"> </span>
<a href="#l40.32"></a><span id="l40.32">   expectedStrings.shift();</span>
<a href="#l40.33"></a><span id="l40.33">   Assert.equal(expectedStrings.length, actualStrings.length);</span>
<a href="#l40.34"></a><span id="l40.34">   for (let line = 0; line &lt; expectedStrings.length; line++)</span>
<a href="#l40.35"></a><span id="l40.35">     Assert.equal(expectedStrings[line], actualStrings[line]);</span>
<a href="#l40.36"></a><span id="l40.36"> }</span>
<a href="#l40.37"></a><span id="l40.37"> </span>
<a href="#l40.38"></a><span id="l40.38"> var UrlListener = {</span>
<a href="#l40.39"></a><span id="l40.39" class="difflineminus">-  OnStartRunningUrl: function(aUrl) {</span>
<a href="#l40.40"></a><span id="l40.40" class="difflineplus">+  OnStartRunningUrl(aUrl) {</span>
<a href="#l40.41"></a><span id="l40.41">   },</span>
<a href="#l40.42"></a><span id="l40.42" class="difflineminus">-  OnStopRunningUrl: function(aUrl, aExitCode) {</span>
<a href="#l40.43"></a><span id="l40.43" class="difflineplus">+  OnStopRunningUrl(aUrl, aExitCode) {</span>
<a href="#l40.44"></a><span id="l40.44">     Assert.equal(aExitCode, 0);</span>
<a href="#l40.45"></a><span id="l40.45">     check_each_line(IOUtils.loadFileToString(dot),</span>
<a href="#l40.46"></a><span id="l40.46">                     IOUtils.loadFileToString(saveFile));</span>
<a href="#l40.47"></a><span id="l40.47">     do_test_finished();</span>
<a href="#l40.48"></a><span id="l40.48" class="difflineminus">-  }</span>
<a href="#l40.49"></a><span id="l40.49" class="difflineplus">+  },</span>
<a href="#l40.50"></a><span id="l40.50"> };</span>
<a href="#l40.51"></a><span id="l40.51"> </span>
<a href="#l40.52"></a><span id="l40.52"> function teardown() {</span>
<a href="#l40.53"></a><span id="l40.53">   if (saveFile.exists())</span>
<a href="#l40.54"></a><span id="l40.54">     saveFile.remove(false);</span>
<a href="#l40.55"></a><span id="l40.55"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l41.1"></a><span id="l41.1" class="difflineminus">--- a/mailnews/local/test/unit/test_streamHeaders.js</span>
<a href="#l41.2"></a><span id="l41.2" class="difflineplus">+++ b/mailnews/local/test/unit/test_streamHeaders.js</span>
<a href="#l41.3"></a><span id="l41.3" class="difflineat">@@ -5,116 +5,118 @@</span>
<a href="#l41.4"></a><span id="l41.4">  /**</span>
<a href="#l41.5"></a><span id="l41.5">  * This mainly tests that streamHeaders does not result in the crash</span>
<a href="#l41.6"></a><span id="l41.6">  * of bug 752768</span>
<a href="#l41.7"></a><span id="l41.7">  *</span>
<a href="#l41.8"></a><span id="l41.8">  * adapted from test_pop3Pump.js by Kent James &lt;kent@caspia.com&gt;</span>
<a href="#l41.9"></a><span id="l41.9">  */</span>
<a href="#l41.10"></a><span id="l41.10"> </span>
<a href="#l41.11"></a><span id="l41.11"> // async support</span>
<a href="#l41.12"></a><span id="l41.12" class="difflineplus">+/* import-globals-from ../../../test/resources/logHelper.js */</span>
<a href="#l41.13"></a><span id="l41.13" class="difflineplus">+/* import-globals-from ../../../test/resources/asyncTestUtils.js */</span>
<a href="#l41.14"></a><span id="l41.14" class="difflineplus">+/* import-globals-from ../../../test/resources/alertTestUtils.js */</span>
<a href="#l41.15"></a><span id="l41.15" class="difflineplus">+/* import-globals-from ../../../test/resources/POP3pump.js */</span>
<a href="#l41.16"></a><span id="l41.16"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l41.17"></a><span id="l41.17"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l41.18"></a><span id="l41.18"> load(&quot;../../../resources/alertTestUtils.js&quot;);</span>
<a href="#l41.19"></a><span id="l41.19"> </span>
<a href="#l41.20"></a><span id="l41.20"> load(&quot;../../../resources/POP3pump.js&quot;);</span>
<a href="#l41.21"></a><span id="l41.21"> </span>
<a href="#l41.22"></a><span id="l41.22"> var testSubjects = [&quot;Hello, did you receive my bugmail?&quot;];</span>
<a href="#l41.23"></a><span id="l41.23" class="difflineminus">-var tests = [loadMessages,</span>
<a href="#l41.24"></a><span id="l41.24" class="difflineminus">-             goodStreaming,</span>
<a href="#l41.25"></a><span id="l41.25" class="difflineminus">-             badStreaming,</span>
<a href="#l41.26"></a><span id="l41.26" class="difflineminus">-            ];</span>
<a href="#l41.27"></a><span id="l41.27" class="difflineplus">+var tests = [</span>
<a href="#l41.28"></a><span id="l41.28" class="difflineplus">+  loadMessages,</span>
<a href="#l41.29"></a><span id="l41.29" class="difflineplus">+  goodStreaming,</span>
<a href="#l41.30"></a><span id="l41.30" class="difflineplus">+  badStreaming,</span>
<a href="#l41.31"></a><span id="l41.31" class="difflineplus">+];</span>
<a href="#l41.32"></a><span id="l41.32"> </span>
<a href="#l41.33"></a><span id="l41.33" class="difflineminus">-function run_test()</span>
<a href="#l41.34"></a><span id="l41.34" class="difflineminus">-{</span>
<a href="#l41.35"></a><span id="l41.35" class="difflineplus">+function run_test() {</span>
<a href="#l41.36"></a><span id="l41.36">   async_run_tests(tests);</span>
<a href="#l41.37"></a><span id="l41.37"> }</span>
<a href="#l41.38"></a><span id="l41.38"> </span>
<a href="#l41.39"></a><span id="l41.39"> var gHdr;</span>
<a href="#l41.40"></a><span id="l41.40" class="difflineminus">-function* loadMessages()</span>
<a href="#l41.41"></a><span id="l41.41" class="difflineminus">-{</span>
<a href="#l41.42"></a><span id="l41.42" class="difflineplus">+function* loadMessages() {</span>
<a href="#l41.43"></a><span id="l41.43">   gPOP3Pump.files = [&quot;../../../data/draft1&quot;];</span>
<a href="#l41.44"></a><span id="l41.44">   gPOP3Pump.onDone = async_driver;</span>
<a href="#l41.45"></a><span id="l41.45">   gPOP3Pump.run();</span>
<a href="#l41.46"></a><span id="l41.46">   yield false;</span>
<a href="#l41.47"></a><span id="l41.47"> </span>
<a href="#l41.48"></a><span id="l41.48">   // get message headers for the inbox folder</span>
<a href="#l41.49"></a><span id="l41.49">   let enumerator = localAccountUtils.inboxFolder.msgDatabase.EnumerateMessages();</span>
<a href="#l41.50"></a><span id="l41.50">   var msgCount = 0;</span>
<a href="#l41.51"></a><span id="l41.51" class="difflineminus">-  while(enumerator.hasMoreElements())</span>
<a href="#l41.52"></a><span id="l41.52" class="difflineminus">-  {</span>
<a href="#l41.53"></a><span id="l41.53" class="difflineplus">+  while (enumerator.hasMoreElements()) {</span>
<a href="#l41.54"></a><span id="l41.54">     msgCount++;</span>
<a href="#l41.55"></a><span id="l41.55">     gHdr = enumerator.getNext().QueryInterface(Ci.nsIMsgDBHdr);</span>
<a href="#l41.56"></a><span id="l41.56">     Assert.equal(gHdr.subject, testSubjects[msgCount - 1]);</span>
<a href="#l41.57"></a><span id="l41.57">   }</span>
<a href="#l41.58"></a><span id="l41.58">   Assert.equal(msgCount, 1);</span>
<a href="#l41.59"></a><span id="l41.59">   gPOP3Pump = null;</span>
<a href="#l41.60"></a><span id="l41.60"> }</span>
<a href="#l41.61"></a><span id="l41.61"> </span>
<a href="#l41.62"></a><span id="l41.62" class="difflineminus">-function* goodStreaming()</span>
<a href="#l41.63"></a><span id="l41.63" class="difflineminus">-{</span>
<a href="#l41.64"></a><span id="l41.64" class="difflineplus">+function* goodStreaming() {</span>
<a href="#l41.65"></a><span id="l41.65">   // try to stream the headers of the last message</span>
<a href="#l41.66"></a><span id="l41.66">   let uri = gHdr.folder.getUriForMsg(gHdr);</span>
<a href="#l41.67"></a><span id="l41.67">   let messageService = Cc[&quot;@mozilla.org/messenger;1&quot;].createInstance(Ci.nsIMessenger)</span>
<a href="#l41.68"></a><span id="l41.68">                                                      .messageServiceFromURI(uri);</span>
<a href="#l41.69"></a><span id="l41.69">   messageService.streamHeaders(uri, createStreamListener(</span>
<a href="#l41.70"></a><span id="l41.70">     function theString(k) {</span>
<a href="#l41.71"></a><span id="l41.71" class="difflineminus">-      dump('the string:\n' + k + '\n');</span>
<a href="#l41.72"></a><span id="l41.72" class="difflineplus">+      dump(&quot;the string:\n&quot; + k + &quot;\n&quot;);</span>
<a href="#l41.73"></a><span id="l41.73">       // The message contains this header</span>
<a href="#l41.74"></a><span id="l41.74">       Assert.ok(k.includes(&quot;X-Mozilla-Draft-Info: internal/draft; vcard=0; receipt=0; DSN=0; uuencode=0&quot;));</span>
<a href="#l41.75"></a><span id="l41.75">       async_driver();</span>
<a href="#l41.76"></a><span id="l41.76">     }), null, true);</span>
<a href="#l41.77"></a><span id="l41.77">   yield false;</span>
<a href="#l41.78"></a><span id="l41.78"> }</span>
<a href="#l41.79"></a><span id="l41.79"> </span>
<a href="#l41.80"></a><span id="l41.80"> // crash from bug 752768</span>
<a href="#l41.81"></a><span id="l41.81" class="difflineminus">-function badStreaming()</span>
<a href="#l41.82"></a><span id="l41.82" class="difflineminus">-{</span>
<a href="#l41.83"></a><span id="l41.83" class="difflineplus">+function badStreaming() {</span>
<a href="#l41.84"></a><span id="l41.84">   // try to stream the headers of the last message</span>
<a href="#l41.85"></a><span id="l41.85">   let folder = gHdr.folder;</span>
<a href="#l41.86"></a><span id="l41.86">   let uri = folder.getUriForMsg(gHdr);</span>
<a href="#l41.87"></a><span id="l41.87"> </span>
<a href="#l41.88"></a><span id="l41.88">   let dbFile = folder.summaryFile;</span>
<a href="#l41.89"></a><span id="l41.89">   // force invalid database</span>
<a href="#l41.90"></a><span id="l41.90">   folder.msgDatabase.ForceClosed();</span>
<a href="#l41.91"></a><span id="l41.91">   dbFile.remove(false);</span>
<a href="#l41.92"></a><span id="l41.92">   folder.msgDatabase = null;</span>
<a href="#l41.93"></a><span id="l41.93"> </span>
<a href="#l41.94"></a><span id="l41.94">   let messageService = Cc[&quot;@mozilla.org/messenger;1&quot;].createInstance(Ci.nsIMessenger)</span>
<a href="#l41.95"></a><span id="l41.95">                                                      .messageServiceFromURI(uri);</span>
<a href="#l41.96"></a><span id="l41.96">   let haveError = false;</span>
<a href="#l41.97"></a><span id="l41.97">   try {</span>
<a href="#l41.98"></a><span id="l41.98">     messageService.streamHeaders(uri, createStreamListener(</span>
<a href="#l41.99"></a><span id="l41.99" class="difflineminus">-      function theString(k) {} ), null, true);</span>
<a href="#l41.100"></a><span id="l41.100" class="difflineminus">-  } catch (e) {haveError = true;}</span>
<a href="#l41.101"></a><span id="l41.101" class="difflineplus">+      function theString(k) {}), null, true);</span>
<a href="#l41.102"></a><span id="l41.102" class="difflineplus">+  } catch (e) {</span>
<a href="#l41.103"></a><span id="l41.103" class="difflineplus">+    haveError = true;</span>
<a href="#l41.104"></a><span id="l41.104" class="difflineplus">+  }</span>
<a href="#l41.105"></a><span id="l41.105">   Assert.ok(haveError);</span>
<a href="#l41.106"></a><span id="l41.106"> }</span>
<a href="#l41.107"></a><span id="l41.107"> </span>
<a href="#l41.108"></a><span id="l41.108"> // This function is adapted from the Conversations addon, which</span>
<a href="#l41.109"></a><span id="l41.109"> //  seems to be one of the drivers for the creation of streamHeaders</span>
<a href="#l41.110"></a><span id="l41.110"> /**</span>
<a href="#l41.111"></a><span id="l41.111">  * Creates a stream listener that will call k once done, passing it the string</span>
<a href="#l41.112"></a><span id="l41.112">  * that has been read.</span>
<a href="#l41.113"></a><span id="l41.113">  */</span>
<a href="#l41.114"></a><span id="l41.114"> function createStreamListener(k) {</span>
<a href="#l41.115"></a><span id="l41.115">   return {</span>
<a href="#l41.116"></a><span id="l41.116">     _data: &quot;&quot;,</span>
<a href="#l41.117"></a><span id="l41.117" class="difflineminus">-    _stream : null,</span>
<a href="#l41.118"></a><span id="l41.118" class="difflineplus">+    _stream: null,</span>
<a href="#l41.119"></a><span id="l41.119"> </span>
<a href="#l41.120"></a><span id="l41.120">     QueryInterface:</span>
<a href="#l41.121"></a><span id="l41.121">       ChromeUtils.generateQI([Ci.nsIStreamListener, Ci.nsIRequestObserver]),</span>
<a href="#l41.122"></a><span id="l41.122"> </span>
<a href="#l41.123"></a><span id="l41.123">     // nsIRequestObserver</span>
<a href="#l41.124"></a><span id="l41.124" class="difflineminus">-    onStartRequest: function(aRequest, aContext) {</span>
<a href="#l41.125"></a><span id="l41.125" class="difflineplus">+    onStartRequest(aRequest, aContext) {</span>
<a href="#l41.126"></a><span id="l41.126">     },</span>
<a href="#l41.127"></a><span id="l41.127" class="difflineminus">-    onStopRequest: function(aRequest, aContext, aStatusCode) {</span>
<a href="#l41.128"></a><span id="l41.128" class="difflineplus">+    onStopRequest(aRequest, aContext, aStatusCode) {</span>
<a href="#l41.129"></a><span id="l41.129">       k(this._data);</span>
<a href="#l41.130"></a><span id="l41.130">     },</span>
<a href="#l41.131"></a><span id="l41.131"> </span>
<a href="#l41.132"></a><span id="l41.132">     // nsIStreamListener</span>
<a href="#l41.133"></a><span id="l41.133" class="difflineminus">-    onDataAvailable: function(aRequest, aContext, aInputStream, aOffset, aCount) {</span>
<a href="#l41.134"></a><span id="l41.134" class="difflineplus">+    onDataAvailable(aRequest, aContext, aInputStream, aOffset, aCount) {</span>
<a href="#l41.135"></a><span id="l41.135">       if (this._stream == null) {</span>
<a href="#l41.136"></a><span id="l41.136">         this._stream = Cc[&quot;@mozilla.org/scriptableinputstream;1&quot;].createInstance(Ci.nsIScriptableInputStream);</span>
<a href="#l41.137"></a><span id="l41.137">         this._stream.init(aInputStream);</span>
<a href="#l41.138"></a><span id="l41.138">       }</span>
<a href="#l41.139"></a><span id="l41.139">       this._data += this._stream.read(aCount);</span>
<a href="#l41.140"></a><span id="l41.140" class="difflineminus">-    }</span>
<a href="#l41.141"></a><span id="l41.141" class="difflineplus">+    },</span>
<a href="#l41.142"></a><span id="l41.142">   };</span>
<a href="#l41.143"></a><span id="l41.143"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l42.1"></a><span id="l42.1" class="difflineminus">--- a/mailnews/local/test/unit/test_undoDelete.js</span>
<a href="#l42.2"></a><span id="l42.2" class="difflineplus">+++ b/mailnews/local/test/unit/test_undoDelete.js</span>
<a href="#l42.3"></a><span id="l42.3" class="difflineat">@@ -1,53 +1,51 @@</span>
<a href="#l42.4"></a><span id="l42.4"> // This file tests undoing of an local folder message deleted to the trash.</span>
<a href="#l42.5"></a><span id="l42.5"> //</span>
<a href="#l42.6"></a><span id="l42.6"> // Original Author: David Bienvenu &lt;dbienvenu@mozilla.com&gt;</span>
<a href="#l42.7"></a><span id="l42.7"> </span>
<a href="#l42.8"></a><span id="l42.8" class="difflineminus">-ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l42.9"></a><span id="l42.9" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l42.10"></a><span id="l42.10" class="difflineminus">-</span>
<a href="#l42.11"></a><span id="l42.11"> // Globals</span>
<a href="#l42.12"></a><span id="l42.12"> var gMsg1;</span>
<a href="#l42.13"></a><span id="l42.13"> var gMessages = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span>
<a href="#l42.14"></a><span id="l42.14"> var gMsgWindow;</span>
<a href="#l42.15"></a><span id="l42.15"> var gCurTestNum;</span>
<a href="#l42.16"></a><span id="l42.16"> var gMsgId1;</span>
<a href="#l42.17"></a><span id="l42.17"> var gTestFolder;</span>
<a href="#l42.18"></a><span id="l42.18"> </span>
<a href="#l42.19"></a><span id="l42.19" class="difflineplus">+/* import-globals-from ../../../test/resources/asyncTestUtils.js */</span>
<a href="#l42.20"></a><span id="l42.20" class="difflineplus">+/* import-globals-from ../../../test/resources/messageModifier.js */</span>
<a href="#l42.21"></a><span id="l42.21" class="difflineplus">+/* import-globals-from ../../../test/resources/messageGenerator.js */</span>
<a href="#l42.22"></a><span id="l42.22" class="difflineplus">+/* import-globals-from ../../../test/resources/messageInjection.js */</span>
<a href="#l42.23"></a><span id="l42.23"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l42.24"></a><span id="l42.24" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;);</span>
<a href="#l42.25"></a><span id="l42.25"> load(&quot;../../../resources/messageModifier.js&quot;);</span>
<a href="#l42.26"></a><span id="l42.26"> load(&quot;../../../resources/messageGenerator.js&quot;);</span>
<a href="#l42.27"></a><span id="l42.27"> load(&quot;../../../resources/messageInjection.js&quot;);</span>
<a href="#l42.28"></a><span id="l42.28"> </span>
<a href="#l42.29"></a><span id="l42.29" class="difflineminus">-var gTestArray =</span>
<a href="#l42.30"></a><span id="l42.30" class="difflineminus">-[</span>
<a href="#l42.31"></a><span id="l42.31" class="difflineplus">+var gTestArray = [</span>
<a href="#l42.32"></a><span id="l42.32">   function deleteMessage() {</span>
<a href="#l42.33"></a><span id="l42.33">     let msgToDelete = mailTestUtils.firstMsgHdr(gTestFolder);</span>
<a href="#l42.34"></a><span id="l42.34">     gMsgId1 = msgToDelete.messageId;</span>
<a href="#l42.35"></a><span id="l42.35">     gMessages.appendElement(msgToDelete);</span>
<a href="#l42.36"></a><span id="l42.36">     gTestFolder.deleteMessages(gMessages, gMsgWindow, false, true, CopyListener,</span>
<a href="#l42.37"></a><span id="l42.37">                                true);</span>
<a href="#l42.38"></a><span id="l42.38">   },</span>
<a href="#l42.39"></a><span id="l42.39">   function undoDelete() {</span>
<a href="#l42.40"></a><span id="l42.40">     gMsgWindow.transactionManager.undoTransaction();</span>
<a href="#l42.41"></a><span id="l42.41">     // There's no listener for this, so we'll just have to wait a little.</span>
<a href="#l42.42"></a><span id="l42.42" class="difflineminus">-    do_timeout(1500, function(){doTest(++gCurTestNum);});</span>
<a href="#l42.43"></a><span id="l42.43" class="difflineplus">+    do_timeout(1500, function() { doTest(++gCurTestNum); });</span>
<a href="#l42.44"></a><span id="l42.44">   },</span>
<a href="#l42.45"></a><span id="l42.45">   function verifyFolders() {</span>
<a href="#l42.46"></a><span id="l42.46">     let msgRestored = gTestFolder.msgDatabase.getMsgHdrForMessageID(gMsgId1);</span>
<a href="#l42.47"></a><span id="l42.47">     let msg = mailTestUtils.loadMessageToString(gTestFolder, msgRestored);</span>
<a href="#l42.48"></a><span id="l42.48">     Assert.equal(msg, gMsg1.toMboxString());</span>
<a href="#l42.49"></a><span id="l42.49">     doTest(++gCurTestNum);</span>
<a href="#l42.50"></a><span id="l42.50">   },</span>
<a href="#l42.51"></a><span id="l42.51"> ];</span>
<a href="#l42.52"></a><span id="l42.52"> </span>
<a href="#l42.53"></a><span id="l42.53" class="difflineminus">-function run_test()</span>
<a href="#l42.54"></a><span id="l42.54" class="difflineminus">-{</span>
<a href="#l42.55"></a><span id="l42.55" class="difflineplus">+function run_test() {</span>
<a href="#l42.56"></a><span id="l42.56">   configure_message_injection({mode: &quot;local&quot;});</span>
<a href="#l42.57"></a><span id="l42.57"> </span>
<a href="#l42.58"></a><span id="l42.58">   gMsgWindow = Cc[&quot;@mozilla.org/messenger/msgwindow;1&quot;]</span>
<a href="#l42.59"></a><span id="l42.59">                   .createInstance(Ci.nsIMsgWindow);</span>
<a href="#l42.60"></a><span id="l42.60"> </span>
<a href="#l42.61"></a><span id="l42.61">   var messageGenerator = new MessageGenerator();</span>
<a href="#l42.62"></a><span id="l42.62">   gMsg1 = messageGenerator.makeMessage();</span>
<a href="#l42.63"></a><span id="l42.63">   let msg2 = messageGenerator.makeMessage({inReplyTo: gMsg1});</span>
<a href="#l42.64"></a><span id="l42.64" class="difflineat">@@ -56,82 +54,73 @@ function run_test()</span>
<a href="#l42.65"></a><span id="l42.65">   messages = messages.concat([gMsg1, msg2]);</span>
<a href="#l42.66"></a><span id="l42.66">   let msgSet = new SyntheticMessageSet(messages);</span>
<a href="#l42.67"></a><span id="l42.67">   gTestFolder = make_empty_folder();</span>
<a href="#l42.68"></a><span id="l42.68">   add_sets_to_folder(gTestFolder, [msgSet]);</span>
<a href="#l42.69"></a><span id="l42.69"> </span>
<a href="#l42.70"></a><span id="l42.70">   // &quot;Master&quot; do_test_pending(), paired with a do_test_finished() at the end of</span>
<a href="#l42.71"></a><span id="l42.71">   // all the operations.</span>
<a href="#l42.72"></a><span id="l42.72">   do_test_pending();</span>
<a href="#l42.73"></a><span id="l42.73" class="difflineminus">-  //start first test</span>
<a href="#l42.74"></a><span id="l42.74" class="difflineplus">+  // start first test</span>
<a href="#l42.75"></a><span id="l42.75">   doTest(1);</span>
<a href="#l42.76"></a><span id="l42.76"> }</span>
<a href="#l42.77"></a><span id="l42.77"> </span>
<a href="#l42.78"></a><span id="l42.78" class="difflineminus">-function doTest(test)</span>
<a href="#l42.79"></a><span id="l42.79" class="difflineminus">-{</span>
<a href="#l42.80"></a><span id="l42.80" class="difflineminus">-  if (test &lt;= gTestArray.length)</span>
<a href="#l42.81"></a><span id="l42.81" class="difflineminus">-  {</span>
<a href="#l42.82"></a><span id="l42.82" class="difflineplus">+function doTest(test) {</span>
<a href="#l42.83"></a><span id="l42.83" class="difflineplus">+  if (test &lt;= gTestArray.length) {</span>
<a href="#l42.84"></a><span id="l42.84">     dump(&quot;Doing test &quot; + test + &quot;\n&quot;);</span>
<a href="#l42.85"></a><span id="l42.85">     gCurTestNum = test;</span>
<a href="#l42.86"></a><span id="l42.86"> </span>
<a href="#l42.87"></a><span id="l42.87">     var testFn = gTestArray[test - 1];</span>
<a href="#l42.88"></a><span id="l42.88">     // Set a limit of ten seconds; if the notifications haven't arrived by then there's a problem.</span>
<a href="#l42.89"></a><span id="l42.89" class="difflineminus">-    do_timeout(10000, function(){</span>
<a href="#l42.90"></a><span id="l42.90" class="difflineplus">+    do_timeout(10000, function() {</span>
<a href="#l42.91"></a><span id="l42.91">         if (gCurTestNum == test)</span>
<a href="#l42.92"></a><span id="l42.92">           do_throw(&quot;Notifications not received in 10000 ms for operation &quot; + testFn.name);</span>
<a href="#l42.93"></a><span id="l42.93">         }</span>
<a href="#l42.94"></a><span id="l42.94">       );</span>
<a href="#l42.95"></a><span id="l42.95">     try {</span>
<a href="#l42.96"></a><span id="l42.96">     testFn();</span>
<a href="#l42.97"></a><span id="l42.97" class="difflineminus">-    } catch(ex) {</span>
<a href="#l42.98"></a><span id="l42.98" class="difflineminus">-      do_throw ('TEST FAILED ' + ex);</span>
<a href="#l42.99"></a><span id="l42.99" class="difflineplus">+    } catch (ex) {</span>
<a href="#l42.100"></a><span id="l42.100" class="difflineplus">+      do_throw(&quot;TEST FAILED &quot; + ex);</span>
<a href="#l42.101"></a><span id="l42.101">     }</span>
<a href="#l42.102"></a><span id="l42.102" class="difflineminus">-  }</span>
<a href="#l42.103"></a><span id="l42.103" class="difflineminus">-  else</span>
<a href="#l42.104"></a><span id="l42.104" class="difflineminus">-  {</span>
<a href="#l42.105"></a><span id="l42.105" class="difflineplus">+  } else {</span>
<a href="#l42.106"></a><span id="l42.106">     do_timeout(1000, endTest);</span>
<a href="#l42.107"></a><span id="l42.107">   }</span>
<a href="#l42.108"></a><span id="l42.108"> }</span>
<a href="#l42.109"></a><span id="l42.109"> </span>
<a href="#l42.110"></a><span id="l42.110"> // nsIMsgCopyServiceListener implementation - runs next test when copy</span>
<a href="#l42.111"></a><span id="l42.111"> // is completed.</span>
<a href="#l42.112"></a><span id="l42.112" class="difflineminus">-var CopyListener =</span>
<a href="#l42.113"></a><span id="l42.113" class="difflineminus">-{</span>
<a href="#l42.114"></a><span id="l42.114" class="difflineminus">-  OnStartCopy: function() {},</span>
<a href="#l42.115"></a><span id="l42.115" class="difflineminus">-  OnProgress: function(aProgress, aProgressMax) {},</span>
<a href="#l42.116"></a><span id="l42.116" class="difflineminus">-  SetMessageKey: function(aKey){},</span>
<a href="#l42.117"></a><span id="l42.117" class="difflineminus">-  SetMessageId: function(aMessageId) {},</span>
<a href="#l42.118"></a><span id="l42.118" class="difflineminus">-  OnStopCopy: function(aStatus)</span>
<a href="#l42.119"></a><span id="l42.119" class="difflineminus">-  {</span>
<a href="#l42.120"></a><span id="l42.120" class="difflineplus">+var CopyListener = {</span>
<a href="#l42.121"></a><span id="l42.121" class="difflineplus">+  OnStartCopy() {},</span>
<a href="#l42.122"></a><span id="l42.122" class="difflineplus">+  OnProgress(aProgress, aProgressMax) {},</span>
<a href="#l42.123"></a><span id="l42.123" class="difflineplus">+  SetMessageKey(aKey) {},</span>
<a href="#l42.124"></a><span id="l42.124" class="difflineplus">+  SetMessageId(aMessageId) {},</span>
<a href="#l42.125"></a><span id="l42.125" class="difflineplus">+  OnStopCopy(aStatus) {</span>
<a href="#l42.126"></a><span id="l42.126">     dump(&quot;in OnStopCopy &quot; + gCurTestNum + &quot;\n&quot;);</span>
<a href="#l42.127"></a><span id="l42.127">     // Check: message successfully copied.</span>
<a href="#l42.128"></a><span id="l42.128">     Assert.equal(aStatus, 0);</span>
<a href="#l42.129"></a><span id="l42.129">     // Ugly hack: make sure we don't get stuck in a JS-&gt;C++-&gt;JS-&gt;C++... call stack</span>
<a href="#l42.130"></a><span id="l42.130">     // This can happen with a bunch of synchronous functions grouped together, and</span>
<a href="#l42.131"></a><span id="l42.131">     // can even cause tests to fail because they're still waiting for the listener</span>
<a href="#l42.132"></a><span id="l42.132">     // to return</span>
<a href="#l42.133"></a><span id="l42.133" class="difflineminus">-    do_timeout(0, function(){doTest(++gCurTestNum);});</span>
<a href="#l42.134"></a><span id="l42.134" class="difflineminus">-  }</span>
<a href="#l42.135"></a><span id="l42.135" class="difflineplus">+    do_timeout(0, function() { doTest(++gCurTestNum); });</span>
<a href="#l42.136"></a><span id="l42.136" class="difflineplus">+  },</span>
<a href="#l42.137"></a><span id="l42.137"> };</span>
<a href="#l42.138"></a><span id="l42.138"> </span>
<a href="#l42.139"></a><span id="l42.139" class="difflineminus">-</span>
<a href="#l42.140"></a><span id="l42.140" class="difflineplus">+/* exported URLListener */</span>
<a href="#l42.141"></a><span id="l42.141"> // nsIURLListener implementation - runs next test</span>
<a href="#l42.142"></a><span id="l42.142" class="difflineminus">-var URLListener =</span>
<a href="#l42.143"></a><span id="l42.143" class="difflineminus">-{</span>
<a href="#l42.144"></a><span id="l42.144" class="difflineminus">-  OnStartRunningUrl: function(aURL) {},</span>
<a href="#l42.145"></a><span id="l42.145" class="difflineminus">-  OnStopRunningUrl: function(aURL, aStatus)</span>
<a href="#l42.146"></a><span id="l42.146" class="difflineminus">-  {</span>
<a href="#l42.147"></a><span id="l42.147" class="difflineplus">+var URLListener = {</span>
<a href="#l42.148"></a><span id="l42.148" class="difflineplus">+  OnStartRunningUrl(aURL) {},</span>
<a href="#l42.149"></a><span id="l42.149" class="difflineplus">+  OnStopRunningUrl(aURL, aStatus) {</span>
<a href="#l42.150"></a><span id="l42.150">     dump(&quot;in OnStopRunningURL &quot; + gCurTestNum + &quot;\n&quot;);</span>
<a href="#l42.151"></a><span id="l42.151">     Assert.equal(aStatus, 0);</span>
<a href="#l42.152"></a><span id="l42.152" class="difflineminus">-    do_timeout(0, function(){doTest(++gCurTestNum);});</span>
<a href="#l42.153"></a><span id="l42.153" class="difflineminus">-  }</span>
<a href="#l42.154"></a><span id="l42.154" class="difflineminus">-}</span>
<a href="#l42.155"></a><span id="l42.155" class="difflineplus">+    do_timeout(0, function() { doTest(++gCurTestNum); });</span>
<a href="#l42.156"></a><span id="l42.156" class="difflineplus">+  },</span>
<a href="#l42.157"></a><span id="l42.157" class="difflineplus">+};</span>
<a href="#l42.158"></a><span id="l42.158"> </span>
<a href="#l42.159"></a><span id="l42.159" class="difflineminus">-function endTest()</span>
<a href="#l42.160"></a><span id="l42.160" class="difflineminus">-{</span>
<a href="#l42.161"></a><span id="l42.161" class="difflineplus">+function endTest() {</span>
<a href="#l42.162"></a><span id="l42.162">   // Cleanup, null out everything</span>
<a href="#l42.163"></a><span id="l42.163">   gMessages.clear();</span>
<a href="#l42.164"></a><span id="l42.164">   gMsgWindow.closeWindow();</span>
<a href="#l42.165"></a><span id="l42.165">   gMsgWindow = null;</span>
<a href="#l42.166"></a><span id="l42.166">   localAccountUtils.inboxFolder = null;</span>
<a href="#l42.167"></a><span id="l42.167">   localAccountUtils.incomingServer = null;</span>
<a href="#l42.168"></a><span id="l42.168"> </span>
<a href="#l42.169"></a><span id="l42.169">   do_test_finished(); // for the one in run_test()</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l43.1"></a><span id="l43.1" class="difflineminus">--- a/mailnews/local/test/unit/test_verifyLogon.js</span>
<a href="#l43.2"></a><span id="l43.2" class="difflineplus">+++ b/mailnews/local/test/unit/test_verifyLogon.js</span>
<a href="#l43.3"></a><span id="l43.3" class="difflineat">@@ -1,50 +1,44 @@</span>
<a href="#l43.4"></a><span id="l43.4"> /**</span>
<a href="#l43.5"></a><span id="l43.5">  * This test checks to see if the pop3 verify logon handles password failure correctly.</span>
<a href="#l43.6"></a><span id="l43.6">  * The steps are:</span>
<a href="#l43.7"></a><span id="l43.7">  *   - Set an invalid password on the server object.</span>
<a href="#l43.8"></a><span id="l43.8">  *   - Check that verifyLogon fails</span>
<a href="#l43.9"></a><span id="l43.9">  */</span>
<a href="#l43.10"></a><span id="l43.10"> </span>
<a href="#l43.11"></a><span id="l43.11" class="difflineminus">-ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l43.12"></a><span id="l43.12" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l43.13"></a><span id="l43.13" class="difflineminus">-</span>
<a href="#l43.14"></a><span id="l43.14" class="difflineplus">+/* import-globals-from ../../../test/resources/alertTestUtils.js */</span>
<a href="#l43.15"></a><span id="l43.15"> load(&quot;../../../resources/alertTestUtils.js&quot;);</span>
<a href="#l43.16"></a><span id="l43.16"> </span>
<a href="#l43.17"></a><span id="l43.17" class="difflineminus">-var test = null;</span>
<a href="#l43.18"></a><span id="l43.18"> var server;</span>
<a href="#l43.19"></a><span id="l43.19"> var daemon;</span>
<a href="#l43.20"></a><span id="l43.20"> var incomingServer;</span>
<a href="#l43.21"></a><span id="l43.21" class="difflineminus">-var pop3Service;</span>
<a href="#l43.22"></a><span id="l43.22" class="difflineminus">-var attempt = 0;</span>
<a href="#l43.23"></a><span id="l43.23"> </span>
<a href="#l43.24"></a><span id="l43.24"> var kUserName = &quot;testpop3&quot;;</span>
<a href="#l43.25"></a><span id="l43.25"> var kInvalidPassword = &quot;pop3test&quot;;</span>
<a href="#l43.26"></a><span id="l43.26"> var kValidPassword = &quot;testpop3&quot;;</span>
<a href="#l43.27"></a><span id="l43.27"> </span>
<a href="#l43.28"></a><span id="l43.28"> function verifyPop3Logon(validPassword) {</span>
<a href="#l43.29"></a><span id="l43.29">   incomingServer.password = (validPassword) ? kValidPassword : kInvalidPassword;</span>
<a href="#l43.30"></a><span id="l43.30">   urlListener.expectSuccess = validPassword;</span>
<a href="#l43.31"></a><span id="l43.31">   let uri = incomingServer.verifyLogon(urlListener, gDummyMsgWindow);</span>
<a href="#l43.32"></a><span id="l43.32">   // clear msgWindow so url won't prompt for passwords.</span>
<a href="#l43.33"></a><span id="l43.33">   uri.QueryInterface(Ci.nsIMsgMailNewsUrl).msgWindow = null;</span>
<a href="#l43.34"></a><span id="l43.34"> </span>
<a href="#l43.35"></a><span id="l43.35">   server.performTest();</span>
<a href="#l43.36"></a><span id="l43.36">   return false;</span>
<a href="#l43.37"></a><span id="l43.37"> }</span>
<a href="#l43.38"></a><span id="l43.38"> </span>
<a href="#l43.39"></a><span id="l43.39" class="difflineminus">-var urlListener =</span>
<a href="#l43.40"></a><span id="l43.40" class="difflineminus">-{</span>
<a href="#l43.41"></a><span id="l43.41" class="difflineminus">-  expectSucess : false,</span>
<a href="#l43.42"></a><span id="l43.42" class="difflineminus">-  OnStartRunningUrl: function (url) {</span>
<a href="#l43.43"></a><span id="l43.43" class="difflineplus">+var urlListener = {</span>
<a href="#l43.44"></a><span id="l43.44" class="difflineplus">+  expectSucess: false,</span>
<a href="#l43.45"></a><span id="l43.45" class="difflineplus">+  OnStartRunningUrl(url) {</span>
<a href="#l43.46"></a><span id="l43.46">   },</span>
<a href="#l43.47"></a><span id="l43.47" class="difflineminus">-  OnStopRunningUrl: function (url, aResult) {</span>
<a href="#l43.48"></a><span id="l43.48" class="difflineplus">+  OnStopRunningUrl(url, aResult) {</span>
<a href="#l43.49"></a><span id="l43.49">     Assert.equal(Components.isSuccessCode(aResult), this.expectSuccess);</span>
<a href="#l43.50"></a><span id="l43.50" class="difflineminus">-  }</span>
<a href="#l43.51"></a><span id="l43.51" class="difflineplus">+  },</span>
<a href="#l43.52"></a><span id="l43.52"> };</span>
<a href="#l43.53"></a><span id="l43.53"> </span>
<a href="#l43.54"></a><span id="l43.54"> function actually_run_test() {</span>
<a href="#l43.55"></a><span id="l43.55">   daemon.setMessages([&quot;message1.eml&quot;]);</span>
<a href="#l43.56"></a><span id="l43.56"> </span>
<a href="#l43.57"></a><span id="l43.57">   // check that verifyLogon fails with bad password</span>
<a href="#l43.58"></a><span id="l43.58">   verifyPop3Logon(false);</span>
<a href="#l43.59"></a><span id="l43.59"> </span>
<a href="#l43.60"></a><span id="l43.60" class="difflineat">@@ -57,18 +51,17 @@ function verifyGoodLogon() {</span>
<a href="#l43.61"></a><span id="l43.61"> </span>
<a href="#l43.62"></a><span id="l43.62">   // check that verifyLogon succeeds with good password</span>
<a href="#l43.63"></a><span id="l43.63">   verifyPop3Logon(true);</span>
<a href="#l43.64"></a><span id="l43.64"> </span>
<a href="#l43.65"></a><span id="l43.65">   dump(&quot;\nverify logon true 1\n&quot;);</span>
<a href="#l43.66"></a><span id="l43.66">   do_test_finished();</span>
<a href="#l43.67"></a><span id="l43.67"> }</span>
<a href="#l43.68"></a><span id="l43.68"> </span>
<a href="#l43.69"></a><span id="l43.69" class="difflineminus">-function run_test()</span>
<a href="#l43.70"></a><span id="l43.70" class="difflineminus">-{</span>
<a href="#l43.71"></a><span id="l43.71" class="difflineplus">+function run_test() {</span>
<a href="#l43.72"></a><span id="l43.72">   // Disable new mail notifications</span>
<a href="#l43.73"></a><span id="l43.73">   Services.prefs.setBoolPref(&quot;mail.biff.play_sound&quot;, false);</span>
<a href="#l43.74"></a><span id="l43.74">   Services.prefs.setBoolPref(&quot;mail.biff.show_alert&quot;, false);</span>
<a href="#l43.75"></a><span id="l43.75">   Services.prefs.setBoolPref(&quot;mail.biff.show_tray_icon&quot;, false);</span>
<a href="#l43.76"></a><span id="l43.76">   Services.prefs.setBoolPref(&quot;mail.biff.animate_dock_icon&quot;, false);</span>
<a href="#l43.77"></a><span id="l43.77">   // Set up the Server</span>
<a href="#l43.78"></a><span id="l43.78">   daemon = new pop3Daemon();</span>
<a href="#l43.79"></a><span id="l43.79">   function createHandler(d) {</span>
<a href="#l43.80"></a><span id="l43.80" class="difflineat">@@ -83,18 +76,15 @@ function run_test()</span>
<a href="#l43.81"></a><span id="l43.81">   server.start();</span>
<a href="#l43.82"></a><span id="l43.82"> </span>
<a href="#l43.83"></a><span id="l43.83">   // Set up the basic accounts and folders.</span>
<a href="#l43.84"></a><span id="l43.84">   // We would use createPop3ServerAndLocalFolders() however we want to have</span>
<a href="#l43.85"></a><span id="l43.85">   // a different username and NO password for this test (as we expect to load</span>
<a href="#l43.86"></a><span id="l43.86">   // it from the signons json file in which the login information is stored).</span>
<a href="#l43.87"></a><span id="l43.87">   localAccountUtils.loadLocalMailAccount();</span>
<a href="#l43.88"></a><span id="l43.88"> </span>
<a href="#l43.89"></a><span id="l43.89" class="difflineminus">-</span>
<a href="#l43.90"></a><span id="l43.90" class="difflineminus">-  incomingServer = MailServices.accounts</span>
<a href="#l43.91"></a><span id="l43.91" class="difflineminus">-                    .createIncomingServer(kUserName,&quot;localhost&quot;, &quot;pop3&quot;);</span>
<a href="#l43.92"></a><span id="l43.92" class="difflineminus">-</span>
<a href="#l43.93"></a><span id="l43.93" class="difflineplus">+  incomingServer = MailServices.accounts.createIncomingServer(kUserName, &quot;localhost&quot;, &quot;pop3&quot;);</span>
<a href="#l43.94"></a><span id="l43.94">   incomingServer.port = server.port;</span>
<a href="#l43.95"></a><span id="l43.95"> </span>
<a href="#l43.96"></a><span id="l43.96">   do_test_pending();</span>
<a href="#l43.97"></a><span id="l43.97"> </span>
<a href="#l43.98"></a><span id="l43.98">   actually_run_test();</span>
<a href="#l43.99"></a><span id="l43.99"> }</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:33Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

