<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 26419:800083958fbff28505e21949e35db34901c9d71d</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 800083958fbff28505e21949e35db34901c9d71d" />
<meta property="og:url" content="/comm-central/rev/800083958fbff28505e21949e35db34901c9d71d" />
<meta property="og:description" content="Bug 1546364 - Reformat to Google coding style in calendar/base/backend/libical. r=philipp" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 800083958fbff28505e21949e35db34901c9d71d 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/800083958fbff28505e21949e35db34901c9d71d">shortlog</a> |
<a href="/comm-central/log/800083958fbff28505e21949e35db34901c9d71d">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/800083958fbff28505e21949e35db34901c9d71d">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/800083958fbff28505e21949e35db34901c9d71d">files</a> |
changeset |
<a href="/comm-central/raw-rev/800083958fbff28505e21949e35db34901c9d71d">raw</a>  | <a href="/comm-central/archive/800083958fbff28505e21949e35db34901c9d71d.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1546364">Bug 1546364</a> - Reformat to Google coding style in calendar/base/backend/libical. r=philipp
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#74;&#111;&#114;&#103;&#32;&#75;&#32;&#60;&#106;&#111;&#114;&#103;&#107;&#64;&#106;&#111;&#114;&#103;&#107;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Wed, 24 Apr 2019 09:40:08 +0200</td></tr>

<tr>
 <td>changeset 26419</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/800083958fbff28505e21949e35db34901c9d71d">800083958fbff28505e21949e35db34901c9d71d</a></td>
</tr>



<tr>
<td>parent 26418</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/a7efaecb39ccf179d84a3375da8609698435ef58">a7efaecb39ccf179d84a3375da8609698435ef58</a>
</td>
</tr>

<tr>
<td>child 26420</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/4d5ec0d7a32c6002e26b1b807bfa2796a292c9b1">4d5ec0d7a32c6002e26b1b807bfa2796a292c9b1</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=800083958fbff28505e21949e35db34901c9d71d">15829</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Wed, 24 Apr 2019 08:37:09 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@4965f8d61f03 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=4965f8d61f03bad242a90df92454e5fd52763f4f">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=4965f8d61f03bad242a90df92454e5fd52763f4f&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=4965f8d61f03bad242a90df92454e5fd52763f4f&newProject=comm-central&newRevision=a7efaecb39ccf179d84a3375da8609698435ef58&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=4965f8d61f03bad242a90df92454e5fd52763f4f&newProject=comm-central&newRevision=a7efaecb39ccf179d84a3375da8609698435ef58&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=4965f8d61f03bad242a90df92454e5fd52763f4f&newProject=comm-central&newRevision=a7efaecb39ccf179d84a3375da8609698435ef58&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28philipp%29&revcount=50">philipp</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1546364">1546364</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1546364">Bug 1546364</a> - Reformat to Google coding style in calendar/base/backend/libical. r=philipp
# ignore-this-changeset</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/800083958fbff28505e21949e35db34901c9d71d/calendar/base/backend/libical/build/calBaseModule.cpp">calendar/base/backend/libical/build/calBaseModule.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/800083958fbff28505e21949e35db34901c9d71d/calendar/base/backend/libical/build/calBaseModule.cpp">file</a> |
<a href="/comm-central/annotate/800083958fbff28505e21949e35db34901c9d71d/calendar/base/backend/libical/build/calBaseModule.cpp">annotate</a> |
<a href="/comm-central/diff/800083958fbff28505e21949e35db34901c9d71d/calendar/base/backend/libical/build/calBaseModule.cpp">diff</a> |
<a href="/comm-central/comparison/800083958fbff28505e21949e35db34901c9d71d/calendar/base/backend/libical/build/calBaseModule.cpp">comparison</a> |
<a href="/comm-central/log/800083958fbff28505e21949e35db34901c9d71d/calendar/base/backend/libical/build/calBaseModule.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/800083958fbff28505e21949e35db34901c9d71d/calendar/base/backend/libical/calAttributeHelpers.h">calendar/base/backend/libical/calAttributeHelpers.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/800083958fbff28505e21949e35db34901c9d71d/calendar/base/backend/libical/calAttributeHelpers.h">file</a> |
<a href="/comm-central/annotate/800083958fbff28505e21949e35db34901c9d71d/calendar/base/backend/libical/calAttributeHelpers.h">annotate</a> |
<a href="/comm-central/diff/800083958fbff28505e21949e35db34901c9d71d/calendar/base/backend/libical/calAttributeHelpers.h">diff</a> |
<a href="/comm-central/comparison/800083958fbff28505e21949e35db34901c9d71d/calendar/base/backend/libical/calAttributeHelpers.h">comparison</a> |
<a href="/comm-central/log/800083958fbff28505e21949e35db34901c9d71d/calendar/base/backend/libical/calAttributeHelpers.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/800083958fbff28505e21949e35db34901c9d71d/calendar/base/backend/libical/calDateTime.cpp">calendar/base/backend/libical/calDateTime.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/800083958fbff28505e21949e35db34901c9d71d/calendar/base/backend/libical/calDateTime.cpp">file</a> |
<a href="/comm-central/annotate/800083958fbff28505e21949e35db34901c9d71d/calendar/base/backend/libical/calDateTime.cpp">annotate</a> |
<a href="/comm-central/diff/800083958fbff28505e21949e35db34901c9d71d/calendar/base/backend/libical/calDateTime.cpp">diff</a> |
<a href="/comm-central/comparison/800083958fbff28505e21949e35db34901c9d71d/calendar/base/backend/libical/calDateTime.cpp">comparison</a> |
<a href="/comm-central/log/800083958fbff28505e21949e35db34901c9d71d/calendar/base/backend/libical/calDateTime.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/800083958fbff28505e21949e35db34901c9d71d/calendar/base/backend/libical/calDateTime.h">calendar/base/backend/libical/calDateTime.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/800083958fbff28505e21949e35db34901c9d71d/calendar/base/backend/libical/calDateTime.h">file</a> |
<a href="/comm-central/annotate/800083958fbff28505e21949e35db34901c9d71d/calendar/base/backend/libical/calDateTime.h">annotate</a> |
<a href="/comm-central/diff/800083958fbff28505e21949e35db34901c9d71d/calendar/base/backend/libical/calDateTime.h">diff</a> |
<a href="/comm-central/comparison/800083958fbff28505e21949e35db34901c9d71d/calendar/base/backend/libical/calDateTime.h">comparison</a> |
<a href="/comm-central/log/800083958fbff28505e21949e35db34901c9d71d/calendar/base/backend/libical/calDateTime.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/800083958fbff28505e21949e35db34901c9d71d/calendar/base/backend/libical/calDuration.cpp">calendar/base/backend/libical/calDuration.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/800083958fbff28505e21949e35db34901c9d71d/calendar/base/backend/libical/calDuration.cpp">file</a> |
<a href="/comm-central/annotate/800083958fbff28505e21949e35db34901c9d71d/calendar/base/backend/libical/calDuration.cpp">annotate</a> |
<a href="/comm-central/diff/800083958fbff28505e21949e35db34901c9d71d/calendar/base/backend/libical/calDuration.cpp">diff</a> |
<a href="/comm-central/comparison/800083958fbff28505e21949e35db34901c9d71d/calendar/base/backend/libical/calDuration.cpp">comparison</a> |
<a href="/comm-central/log/800083958fbff28505e21949e35db34901c9d71d/calendar/base/backend/libical/calDuration.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/800083958fbff28505e21949e35db34901c9d71d/calendar/base/backend/libical/calDuration.h">calendar/base/backend/libical/calDuration.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/800083958fbff28505e21949e35db34901c9d71d/calendar/base/backend/libical/calDuration.h">file</a> |
<a href="/comm-central/annotate/800083958fbff28505e21949e35db34901c9d71d/calendar/base/backend/libical/calDuration.h">annotate</a> |
<a href="/comm-central/diff/800083958fbff28505e21949e35db34901c9d71d/calendar/base/backend/libical/calDuration.h">diff</a> |
<a href="/comm-central/comparison/800083958fbff28505e21949e35db34901c9d71d/calendar/base/backend/libical/calDuration.h">comparison</a> |
<a href="/comm-central/log/800083958fbff28505e21949e35db34901c9d71d/calendar/base/backend/libical/calDuration.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/800083958fbff28505e21949e35db34901c9d71d/calendar/base/backend/libical/calICSService.cpp">calendar/base/backend/libical/calICSService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/800083958fbff28505e21949e35db34901c9d71d/calendar/base/backend/libical/calICSService.cpp">file</a> |
<a href="/comm-central/annotate/800083958fbff28505e21949e35db34901c9d71d/calendar/base/backend/libical/calICSService.cpp">annotate</a> |
<a href="/comm-central/diff/800083958fbff28505e21949e35db34901c9d71d/calendar/base/backend/libical/calICSService.cpp">diff</a> |
<a href="/comm-central/comparison/800083958fbff28505e21949e35db34901c9d71d/calendar/base/backend/libical/calICSService.cpp">comparison</a> |
<a href="/comm-central/log/800083958fbff28505e21949e35db34901c9d71d/calendar/base/backend/libical/calICSService.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/800083958fbff28505e21949e35db34901c9d71d/calendar/base/backend/libical/calICSService.h">calendar/base/backend/libical/calICSService.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/800083958fbff28505e21949e35db34901c9d71d/calendar/base/backend/libical/calICSService.h">file</a> |
<a href="/comm-central/annotate/800083958fbff28505e21949e35db34901c9d71d/calendar/base/backend/libical/calICSService.h">annotate</a> |
<a href="/comm-central/diff/800083958fbff28505e21949e35db34901c9d71d/calendar/base/backend/libical/calICSService.h">diff</a> |
<a href="/comm-central/comparison/800083958fbff28505e21949e35db34901c9d71d/calendar/base/backend/libical/calICSService.h">comparison</a> |
<a href="/comm-central/log/800083958fbff28505e21949e35db34901c9d71d/calendar/base/backend/libical/calICSService.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/800083958fbff28505e21949e35db34901c9d71d/calendar/base/backend/libical/calPeriod.cpp">calendar/base/backend/libical/calPeriod.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/800083958fbff28505e21949e35db34901c9d71d/calendar/base/backend/libical/calPeriod.cpp">file</a> |
<a href="/comm-central/annotate/800083958fbff28505e21949e35db34901c9d71d/calendar/base/backend/libical/calPeriod.cpp">annotate</a> |
<a href="/comm-central/diff/800083958fbff28505e21949e35db34901c9d71d/calendar/base/backend/libical/calPeriod.cpp">diff</a> |
<a href="/comm-central/comparison/800083958fbff28505e21949e35db34901c9d71d/calendar/base/backend/libical/calPeriod.cpp">comparison</a> |
<a href="/comm-central/log/800083958fbff28505e21949e35db34901c9d71d/calendar/base/backend/libical/calPeriod.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/800083958fbff28505e21949e35db34901c9d71d/calendar/base/backend/libical/calPeriod.h">calendar/base/backend/libical/calPeriod.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/800083958fbff28505e21949e35db34901c9d71d/calendar/base/backend/libical/calPeriod.h">file</a> |
<a href="/comm-central/annotate/800083958fbff28505e21949e35db34901c9d71d/calendar/base/backend/libical/calPeriod.h">annotate</a> |
<a href="/comm-central/diff/800083958fbff28505e21949e35db34901c9d71d/calendar/base/backend/libical/calPeriod.h">diff</a> |
<a href="/comm-central/comparison/800083958fbff28505e21949e35db34901c9d71d/calendar/base/backend/libical/calPeriod.h">comparison</a> |
<a href="/comm-central/log/800083958fbff28505e21949e35db34901c9d71d/calendar/base/backend/libical/calPeriod.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/800083958fbff28505e21949e35db34901c9d71d/calendar/base/backend/libical/calRecurrenceRule.cpp">calendar/base/backend/libical/calRecurrenceRule.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/800083958fbff28505e21949e35db34901c9d71d/calendar/base/backend/libical/calRecurrenceRule.cpp">file</a> |
<a href="/comm-central/annotate/800083958fbff28505e21949e35db34901c9d71d/calendar/base/backend/libical/calRecurrenceRule.cpp">annotate</a> |
<a href="/comm-central/diff/800083958fbff28505e21949e35db34901c9d71d/calendar/base/backend/libical/calRecurrenceRule.cpp">diff</a> |
<a href="/comm-central/comparison/800083958fbff28505e21949e35db34901c9d71d/calendar/base/backend/libical/calRecurrenceRule.cpp">comparison</a> |
<a href="/comm-central/log/800083958fbff28505e21949e35db34901c9d71d/calendar/base/backend/libical/calRecurrenceRule.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/800083958fbff28505e21949e35db34901c9d71d/calendar/base/backend/libical/calRecurrenceRule.h">calendar/base/backend/libical/calRecurrenceRule.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/800083958fbff28505e21949e35db34901c9d71d/calendar/base/backend/libical/calRecurrenceRule.h">file</a> |
<a href="/comm-central/annotate/800083958fbff28505e21949e35db34901c9d71d/calendar/base/backend/libical/calRecurrenceRule.h">annotate</a> |
<a href="/comm-central/diff/800083958fbff28505e21949e35db34901c9d71d/calendar/base/backend/libical/calRecurrenceRule.h">diff</a> |
<a href="/comm-central/comparison/800083958fbff28505e21949e35db34901c9d71d/calendar/base/backend/libical/calRecurrenceRule.h">comparison</a> |
<a href="/comm-central/log/800083958fbff28505e21949e35db34901c9d71d/calendar/base/backend/libical/calRecurrenceRule.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/800083958fbff28505e21949e35db34901c9d71d/calendar/base/backend/libical/calTimezone.cpp">calendar/base/backend/libical/calTimezone.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/800083958fbff28505e21949e35db34901c9d71d/calendar/base/backend/libical/calTimezone.cpp">file</a> |
<a href="/comm-central/annotate/800083958fbff28505e21949e35db34901c9d71d/calendar/base/backend/libical/calTimezone.cpp">annotate</a> |
<a href="/comm-central/diff/800083958fbff28505e21949e35db34901c9d71d/calendar/base/backend/libical/calTimezone.cpp">diff</a> |
<a href="/comm-central/comparison/800083958fbff28505e21949e35db34901c9d71d/calendar/base/backend/libical/calTimezone.cpp">comparison</a> |
<a href="/comm-central/log/800083958fbff28505e21949e35db34901c9d71d/calendar/base/backend/libical/calTimezone.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/800083958fbff28505e21949e35db34901c9d71d/calendar/base/backend/libical/calTimezone.h">calendar/base/backend/libical/calTimezone.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/800083958fbff28505e21949e35db34901c9d71d/calendar/base/backend/libical/calTimezone.h">file</a> |
<a href="/comm-central/annotate/800083958fbff28505e21949e35db34901c9d71d/calendar/base/backend/libical/calTimezone.h">annotate</a> |
<a href="/comm-central/diff/800083958fbff28505e21949e35db34901c9d71d/calendar/base/backend/libical/calTimezone.h">diff</a> |
<a href="/comm-central/comparison/800083958fbff28505e21949e35db34901c9d71d/calendar/base/backend/libical/calTimezone.h">comparison</a> |
<a href="/comm-central/log/800083958fbff28505e21949e35db34901c9d71d/calendar/base/backend/libical/calTimezone.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/800083958fbff28505e21949e35db34901c9d71d/calendar/base/backend/libical/calUtils.cpp">calendar/base/backend/libical/calUtils.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/800083958fbff28505e21949e35db34901c9d71d/calendar/base/backend/libical/calUtils.cpp">file</a> |
<a href="/comm-central/annotate/800083958fbff28505e21949e35db34901c9d71d/calendar/base/backend/libical/calUtils.cpp">annotate</a> |
<a href="/comm-central/diff/800083958fbff28505e21949e35db34901c9d71d/calendar/base/backend/libical/calUtils.cpp">diff</a> |
<a href="/comm-central/comparison/800083958fbff28505e21949e35db34901c9d71d/calendar/base/backend/libical/calUtils.cpp">comparison</a> |
<a href="/comm-central/log/800083958fbff28505e21949e35db34901c9d71d/calendar/base/backend/libical/calUtils.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/800083958fbff28505e21949e35db34901c9d71d/calendar/base/backend/libical/calUtils.h">calendar/base/backend/libical/calUtils.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/800083958fbff28505e21949e35db34901c9d71d/calendar/base/backend/libical/calUtils.h">file</a> |
<a href="/comm-central/annotate/800083958fbff28505e21949e35db34901c9d71d/calendar/base/backend/libical/calUtils.h">annotate</a> |
<a href="/comm-central/diff/800083958fbff28505e21949e35db34901c9d71d/calendar/base/backend/libical/calUtils.h">diff</a> |
<a href="/comm-central/comparison/800083958fbff28505e21949e35db34901c9d71d/calendar/base/backend/libical/calUtils.h">comparison</a> |
<a href="/comm-central/log/800083958fbff28505e21949e35db34901c9d71d/calendar/base/backend/libical/calUtils.h">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/calendar/base/backend/libical/build/calBaseModule.cpp</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/calendar/base/backend/libical/build/calBaseModule.cpp</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -21,44 +21,34 @@ NS_GENERIC_FACTORY_CONSTRUCTOR(calICSSer</span>
<a href="#l1.4"></a><span id="l1.4"> NS_DEFINE_NAMED_CID(CAL_ICSSERVICE_CID);</span>
<a href="#l1.5"></a><span id="l1.5"> </span>
<a href="#l1.6"></a><span id="l1.6"> NS_GENERIC_FACTORY_CONSTRUCTOR(calPeriod)</span>
<a href="#l1.7"></a><span id="l1.7"> NS_DEFINE_NAMED_CID(CAL_PERIOD_CID);</span>
<a href="#l1.8"></a><span id="l1.8"> </span>
<a href="#l1.9"></a><span id="l1.9"> NS_GENERIC_FACTORY_CONSTRUCTOR(calRecurrenceRule)</span>
<a href="#l1.10"></a><span id="l1.10"> NS_DEFINE_NAMED_CID(CAL_RECURRENCERULE_CID);</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-</span>
<a href="#l1.13"></a><span id="l1.13"> const mozilla::Module::CIDEntry kCalBaseCIDs[] = {</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineminus">-    { &amp;kCAL_DATETIME_CID, false, NULL, calDateTimeConstructor },</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineminus">-    { &amp;kCAL_DURATION_CID, false, NULL, calDurationConstructor },</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineminus">-    { &amp;kCAL_ICSSERVICE_CID, true, NULL, calICSServiceConstructor },</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineminus">-    { &amp;kCAL_PERIOD_CID, false, NULL, calPeriodConstructor },</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineminus">-    { &amp;kCAL_RECURRENCERULE_CID, false, NULL, calRecurrenceRuleConstructor },</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineminus">-    { NULL }</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineminus">-};</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineplus">+    {&amp;kCAL_DATETIME_CID, false, NULL, calDateTimeConstructor},</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineplus">+    {&amp;kCAL_DURATION_CID, false, NULL, calDurationConstructor},</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineplus">+    {&amp;kCAL_ICSSERVICE_CID, true, NULL, calICSServiceConstructor},</span>
<a href="#l1.24"></a><span id="l1.24" class="difflineplus">+    {&amp;kCAL_PERIOD_CID, false, NULL, calPeriodConstructor},</span>
<a href="#l1.25"></a><span id="l1.25" class="difflineplus">+    {&amp;kCAL_RECURRENCERULE_CID, false, NULL, calRecurrenceRuleConstructor},</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineplus">+    {NULL}};</span>
<a href="#l1.27"></a><span id="l1.27"> </span>
<a href="#l1.28"></a><span id="l1.28"> const mozilla::Module::ContractIDEntry kCalBaseContracts[] = {</span>
<a href="#l1.29"></a><span id="l1.29" class="difflineminus">-    { CAL_DATETIME_CONTRACTID, &amp;kCAL_DATETIME_CID },</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineminus">-    { CAL_DURATION_CONTRACTID, &amp;kCAL_DURATION_CID },</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineminus">-    { CAL_ICSSERVICE_CONTRACTID, &amp;kCAL_ICSSERVICE_CID },</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineminus">-    { CAL_PERIOD_CONTRACTID, &amp;kCAL_PERIOD_CID },</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineminus">-    { CAL_RECURRENCERULE_CONTRACTID, &amp;kCAL_RECURRENCERULE_CID },</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineminus">-    { NULL }</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineminus">-};</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineplus">+    {CAL_DATETIME_CONTRACTID, &amp;kCAL_DATETIME_CID},</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineplus">+    {CAL_DURATION_CONTRACTID, &amp;kCAL_DURATION_CID},</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineplus">+    {CAL_ICSSERVICE_CONTRACTID, &amp;kCAL_ICSSERVICE_CID},</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineplus">+    {CAL_PERIOD_CONTRACTID, &amp;kCAL_PERIOD_CID},</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineplus">+    {CAL_RECURRENCERULE_CONTRACTID, &amp;kCAL_RECURRENCERULE_CID},</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineplus">+    {NULL}};</span>
<a href="#l1.42"></a><span id="l1.42"> </span>
<a href="#l1.43"></a><span id="l1.43" class="difflineminus">-static nsresult</span>
<a href="#l1.44"></a><span id="l1.44" class="difflineminus">-nsInitBaseModule()</span>
<a href="#l1.45"></a><span id="l1.45" class="difflineminus">-{</span>
<a href="#l1.46"></a><span id="l1.46" class="difflineminus">-    // This needs to be done once in the application, we want to make</span>
<a href="#l1.47"></a><span id="l1.47" class="difflineminus">-    // sure that new parameters are not thrown away</span>
<a href="#l1.48"></a><span id="l1.48" class="difflineminus">-    ical_set_unknown_token_handling_setting(ICAL_ASSUME_IANA_TOKEN);</span>
<a href="#l1.49"></a><span id="l1.49" class="difflineminus">-    return NS_OK;</span>
<a href="#l1.50"></a><span id="l1.50" class="difflineplus">+static nsresult nsInitBaseModule() {</span>
<a href="#l1.51"></a><span id="l1.51" class="difflineplus">+  // This needs to be done once in the application, we want to make</span>
<a href="#l1.52"></a><span id="l1.52" class="difflineplus">+  // sure that new parameters are not thrown away</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineplus">+  ical_set_unknown_token_handling_setting(ICAL_ASSUME_IANA_TOKEN);</span>
<a href="#l1.54"></a><span id="l1.54" class="difflineplus">+  return NS_OK;</span>
<a href="#l1.55"></a><span id="l1.55"> }</span>
<a href="#l1.56"></a><span id="l1.56"> </span>
<a href="#l1.57"></a><span id="l1.57"> extern const mozilla::Module kCalBaseModule = {</span>
<a href="#l1.58"></a><span id="l1.58" class="difflineminus">-    mozilla::Module::kVersion,</span>
<a href="#l1.59"></a><span id="l1.59" class="difflineminus">-    kCalBaseCIDs,</span>
<a href="#l1.60"></a><span id="l1.60" class="difflineminus">-    kCalBaseContracts,</span>
<a href="#l1.61"></a><span id="l1.61" class="difflineminus">-    NULL,</span>
<a href="#l1.62"></a><span id="l1.62" class="difflineminus">-    NULL,</span>
<a href="#l1.63"></a><span id="l1.63" class="difflineminus">-    nsInitBaseModule</span>
<a href="#l1.64"></a><span id="l1.64" class="difflineminus">-};</span>
<a href="#l1.65"></a><span id="l1.65" class="difflineplus">+    mozilla::Module::kVersion, kCalBaseCIDs, kCalBaseContracts, NULL, NULL,</span>
<a href="#l1.66"></a><span id="l1.66" class="difflineplus">+    nsInitBaseModule};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/calendar/base/backend/libical/calAttributeHelpers.h</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/calendar/base/backend/libical/calAttributeHelpers.h</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -2,91 +2,90 @@</span>
<a href="#l2.4"></a><span id="l2.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l2.5"></a><span id="l2.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l2.6"></a><span id="l2.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l2.7"></a><span id="l2.7"> </span>
<a href="#l2.8"></a><span id="l2.8"> #ifndef CALATTRIBUTEHELPERS_H_</span>
<a href="#l2.9"></a><span id="l2.9"> #define CALATTRIBUTEHELPERS_H_</span>
<a href="#l2.10"></a><span id="l2.10"> </span>
<a href="#l2.11"></a><span id="l2.11"> #ifndef CAL_ATTR_SET_PRE</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-#define CAL_ATTR_SET_PRE /**/</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+#  define CAL_ATTR_SET_PRE /**/</span>
<a href="#l2.14"></a><span id="l2.14"> #endif</span>
<a href="#l2.15"></a><span id="l2.15"> </span>
<a href="#l2.16"></a><span id="l2.16"> #ifndef CAL_ATTR_SET_POST</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineminus">-#define CAL_ATTR_SET_POST /**/</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineplus">+#  define CAL_ATTR_SET_POST /**/</span>
<a href="#l2.19"></a><span id="l2.19"> #endif</span>
<a href="#l2.20"></a><span id="l2.20"> </span>
<a href="#l2.21"></a><span id="l2.21"> /**</span>
<a href="#l2.22"></a><span id="l2.22">  ** A few helpers for declaring simple attribute getters and setters in</span>
<a href="#l2.23"></a><span id="l2.23">  ** calItemBase derivatives</span>
<a href="#l2.24"></a><span id="l2.24">  **/</span>
<a href="#l2.25"></a><span id="l2.25"> </span>
<a href="#l2.26"></a><span id="l2.26"> // helpers for string types</span>
<a href="#l2.27"></a><span id="l2.27" class="difflineminus">-#define CAL_STRINGTYPE_ATTR_GETTER(cname,mtype,name) \</span>
<a href="#l2.28"></a><span id="l2.28" class="difflineminus">-NS_IMETHODIMP \</span>
<a href="#l2.29"></a><span id="l2.29" class="difflineminus">-cname::Get##name (mtype &amp;_retval) { \</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineminus">-    _retval.Assign(m##name); \</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineminus">-    return NS_OK; \</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineminus">-}</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineplus">+#define CAL_STRINGTYPE_ATTR_GETTER(cname, mtype, name) \</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineplus">+  NS_IMETHODIMP                                        \</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineplus">+  cname::Get##name(mtype &amp;_retval) {                   \</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineplus">+    _retval.Assign(m##name);                           \</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineplus">+    return NS_OK;                                      \</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineplus">+  }</span>
<a href="#l2.39"></a><span id="l2.39"> </span>
<a href="#l2.40"></a><span id="l2.40" class="difflineminus">-#define CAL_STRINGTYPE_ATTR_SETTER(cname,mtype,name) \</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineminus">-NS_IMETHODIMP \</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineminus">-cname::Set##name (const mtype &amp;aValue) { \</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineminus">-    CAL_ATTR_SET_PRE; \</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineminus">-    m##name.Assign(aValue); \</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineminus">-    CAL_ATTR_SET_POST; \</span>
<a href="#l2.46"></a><span id="l2.46" class="difflineminus">-    return NS_OK; \</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineminus">-}</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineplus">+#define CAL_STRINGTYPE_ATTR_SETTER(cname, mtype, name) \</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineplus">+  NS_IMETHODIMP                                        \</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineplus">+  cname::Set##name(const mtype &amp;aValue) {              \</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineplus">+    CAL_ATTR_SET_PRE;                                  \</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineplus">+    m##name.Assign(aValue);                            \</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineplus">+    CAL_ATTR_SET_POST;                                 \</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineplus">+    return NS_OK;                                      \</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineplus">+  }</span>
<a href="#l2.56"></a><span id="l2.56"> </span>
<a href="#l2.57"></a><span id="l2.57" class="difflineminus">-#define CAL_STRINGTYPE_ATTR(cname,mtype,name) \</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineminus">-    CAL_STRINGTYPE_ATTR_GETTER(cname,mtype,name) \</span>
<a href="#l2.59"></a><span id="l2.59" class="difflineminus">-    CAL_STRINGTYPE_ATTR_SETTER(cname,mtype,name)</span>
<a href="#l2.60"></a><span id="l2.60" class="difflineplus">+#define CAL_STRINGTYPE_ATTR(cname, mtype, name)  \</span>
<a href="#l2.61"></a><span id="l2.61" class="difflineplus">+  CAL_STRINGTYPE_ATTR_GETTER(cname, mtype, name) \</span>
<a href="#l2.62"></a><span id="l2.62" class="difflineplus">+  CAL_STRINGTYPE_ATTR_SETTER(cname, mtype, name)</span>
<a href="#l2.63"></a><span id="l2.63"> </span>
<a href="#l2.64"></a><span id="l2.64"> // helpers for value types</span>
<a href="#l2.65"></a><span id="l2.65" class="difflineminus">-#define CAL_VALUETYPE_ATTR_GETTER(cname,mtype,name) \</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineminus">-NS_IMETHODIMP \</span>
<a href="#l2.67"></a><span id="l2.67" class="difflineminus">-cname::Get##name (mtype *_retval) { \</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineminus">-    NS_ENSURE_ARG_POINTER(_retval); \</span>
<a href="#l2.69"></a><span id="l2.69" class="difflineminus">-    *_retval = m##name; \</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineminus">-    return NS_OK; \</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineminus">-}</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineplus">+#define CAL_VALUETYPE_ATTR_GETTER(cname, mtype, name) \</span>
<a href="#l2.73"></a><span id="l2.73" class="difflineplus">+  NS_IMETHODIMP                                       \</span>
<a href="#l2.74"></a><span id="l2.74" class="difflineplus">+  cname::Get##name(mtype *_retval) {                  \</span>
<a href="#l2.75"></a><span id="l2.75" class="difflineplus">+    NS_ENSURE_ARG_POINTER(_retval);                   \</span>
<a href="#l2.76"></a><span id="l2.76" class="difflineplus">+    *_retval = m##name;                               \</span>
<a href="#l2.77"></a><span id="l2.77" class="difflineplus">+    return NS_OK;                                     \</span>
<a href="#l2.78"></a><span id="l2.78" class="difflineplus">+  }</span>
<a href="#l2.79"></a><span id="l2.79"> </span>
<a href="#l2.80"></a><span id="l2.80" class="difflineminus">-#define CAL_VALUETYPE_ATTR_SETTER(cname,mtype,name) \</span>
<a href="#l2.81"></a><span id="l2.81" class="difflineminus">-NS_IMETHODIMP \</span>
<a href="#l2.82"></a><span id="l2.82" class="difflineminus">-cname::Set##name (mtype aValue) { \</span>
<a href="#l2.83"></a><span id="l2.83" class="difflineminus">-    CAL_ATTR_SET_PRE; \</span>
<a href="#l2.84"></a><span id="l2.84" class="difflineminus">-    if (m##name != aValue) { \</span>
<a href="#l2.85"></a><span id="l2.85" class="difflineminus">-        m##name = aValue; \</span>
<a href="#l2.86"></a><span id="l2.86" class="difflineminus">-        CAL_ATTR_SET_POST; \</span>
<a href="#l2.87"></a><span id="l2.87" class="difflineminus">-    } \</span>
<a href="#l2.88"></a><span id="l2.88" class="difflineminus">-    return NS_OK; \</span>
<a href="#l2.89"></a><span id="l2.89" class="difflineminus">-}</span>
<a href="#l2.90"></a><span id="l2.90" class="difflineplus">+#define CAL_VALUETYPE_ATTR_SETTER(cname, mtype, name) \</span>
<a href="#l2.91"></a><span id="l2.91" class="difflineplus">+  NS_IMETHODIMP                                       \</span>
<a href="#l2.92"></a><span id="l2.92" class="difflineplus">+  cname::Set##name(mtype aValue) {                    \</span>
<a href="#l2.93"></a><span id="l2.93" class="difflineplus">+    CAL_ATTR_SET_PRE;                                 \</span>
<a href="#l2.94"></a><span id="l2.94" class="difflineplus">+    if (m##name != aValue) {                          \</span>
<a href="#l2.95"></a><span id="l2.95" class="difflineplus">+      m##name = aValue;                               \</span>
<a href="#l2.96"></a><span id="l2.96" class="difflineplus">+      CAL_ATTR_SET_POST;                              \</span>
<a href="#l2.97"></a><span id="l2.97" class="difflineplus">+    }                                                 \</span>
<a href="#l2.98"></a><span id="l2.98" class="difflineplus">+    return NS_OK;                                     \</span>
<a href="#l2.99"></a><span id="l2.99" class="difflineplus">+  }</span>
<a href="#l2.100"></a><span id="l2.100"> </span>
<a href="#l2.101"></a><span id="l2.101" class="difflineminus">-#define CAL_VALUETYPE_ATTR(cname,mtype,name) \</span>
<a href="#l2.102"></a><span id="l2.102" class="difflineminus">-    CAL_VALUETYPE_ATTR_GETTER(cname,mtype,name) \</span>
<a href="#l2.103"></a><span id="l2.103" class="difflineminus">-    CAL_VALUETYPE_ATTR_SETTER(cname,mtype,name)</span>
<a href="#l2.104"></a><span id="l2.104" class="difflineplus">+#define CAL_VALUETYPE_ATTR(cname, mtype, name)  \</span>
<a href="#l2.105"></a><span id="l2.105" class="difflineplus">+  CAL_VALUETYPE_ATTR_GETTER(cname, mtype, name) \</span>
<a href="#l2.106"></a><span id="l2.106" class="difflineplus">+  CAL_VALUETYPE_ATTR_SETTER(cname, mtype, name)</span>
<a href="#l2.107"></a><span id="l2.107"> </span>
<a href="#l2.108"></a><span id="l2.108"> // helpers for interface types</span>
<a href="#l2.109"></a><span id="l2.109" class="difflineminus">-#define CAL_ISUPPORTS_ATTR_GETTER(cname,mtype,name) \</span>
<a href="#l2.110"></a><span id="l2.110" class="difflineminus">-NS_IMETHODIMP \</span>
<a href="#l2.111"></a><span id="l2.111" class="difflineminus">-cname::Get##name (mtype **_retval) { \</span>
<a href="#l2.112"></a><span id="l2.112" class="difflineminus">-    NS_ENSURE_ARG_POINTER(_retval); \</span>
<a href="#l2.113"></a><span id="l2.113" class="difflineminus">-    NS_IF_ADDREF (*_retval = m##name); \</span>
<a href="#l2.114"></a><span id="l2.114" class="difflineminus">-    return NS_OK; \</span>
<a href="#l2.115"></a><span id="l2.115" class="difflineminus">-}</span>
<a href="#l2.116"></a><span id="l2.116" class="difflineplus">+#define CAL_ISUPPORTS_ATTR_GETTER(cname, mtype, name) \</span>
<a href="#l2.117"></a><span id="l2.117" class="difflineplus">+  NS_IMETHODIMP                                       \</span>
<a href="#l2.118"></a><span id="l2.118" class="difflineplus">+  cname::Get##name(mtype **_retval) {                 \</span>
<a href="#l2.119"></a><span id="l2.119" class="difflineplus">+    NS_ENSURE_ARG_POINTER(_retval);                   \</span>
<a href="#l2.120"></a><span id="l2.120" class="difflineplus">+    NS_IF_ADDREF(*_retval = m##name);                 \</span>
<a href="#l2.121"></a><span id="l2.121" class="difflineplus">+    return NS_OK;                                     \</span>
<a href="#l2.122"></a><span id="l2.122" class="difflineplus">+  }</span>
<a href="#l2.123"></a><span id="l2.123"> </span>
<a href="#l2.124"></a><span id="l2.124" class="difflineminus">-#define CAL_ISUPPORTS_ATTR_SETTER(cname,mtype,name) \</span>
<a href="#l2.125"></a><span id="l2.125" class="difflineminus">-NS_IMETHODIMP \</span>
<a href="#l2.126"></a><span id="l2.126" class="difflineminus">-cname::Set##name (mtype *aValue) { \</span>
<a href="#l2.127"></a><span id="l2.127" class="difflineminus">-    CAL_ATTR_SET_PRE; \</span>
<a href="#l2.128"></a><span id="l2.128" class="difflineminus">-    if (m##name != aValue) { \</span>
<a href="#l2.129"></a><span id="l2.129" class="difflineminus">-        m##name = aValue; \</span>
<a href="#l2.130"></a><span id="l2.130" class="difflineminus">-        CAL_ATTR_SET_POST; \</span>
<a href="#l2.131"></a><span id="l2.131" class="difflineminus">-    } \</span>
<a href="#l2.132"></a><span id="l2.132" class="difflineminus">-    return NS_OK; \</span>
<a href="#l2.133"></a><span id="l2.133" class="difflineminus">-}</span>
<a href="#l2.134"></a><span id="l2.134" class="difflineplus">+#define CAL_ISUPPORTS_ATTR_SETTER(cname, mtype, name) \</span>
<a href="#l2.135"></a><span id="l2.135" class="difflineplus">+  NS_IMETHODIMP                                       \</span>
<a href="#l2.136"></a><span id="l2.136" class="difflineplus">+  cname::Set##name(mtype *aValue) {                   \</span>
<a href="#l2.137"></a><span id="l2.137" class="difflineplus">+    CAL_ATTR_SET_PRE;                                 \</span>
<a href="#l2.138"></a><span id="l2.138" class="difflineplus">+    if (m##name != aValue) {                          \</span>
<a href="#l2.139"></a><span id="l2.139" class="difflineplus">+      m##name = aValue;                               \</span>
<a href="#l2.140"></a><span id="l2.140" class="difflineplus">+      CAL_ATTR_SET_POST;                              \</span>
<a href="#l2.141"></a><span id="l2.141" class="difflineplus">+    }                                                 \</span>
<a href="#l2.142"></a><span id="l2.142" class="difflineplus">+    return NS_OK;                                     \</span>
<a href="#l2.143"></a><span id="l2.143" class="difflineplus">+  }</span>
<a href="#l2.144"></a><span id="l2.144"> </span>
<a href="#l2.145"></a><span id="l2.145" class="difflineminus">-#define CAL_ISUPPORTS_ATTR(cname,mtype,name) \</span>
<a href="#l2.146"></a><span id="l2.146" class="difflineminus">-    CAL_ISUPPORTS_ATTR_GETTER(cname,mtype,name) \</span>
<a href="#l2.147"></a><span id="l2.147" class="difflineminus">-    CAL_ISUPPORTS_ATTR_SETTER(cname,mtype,name)</span>
<a href="#l2.148"></a><span id="l2.148" class="difflineminus">-</span>
<a href="#l2.149"></a><span id="l2.149" class="difflineplus">+#define CAL_ISUPPORTS_ATTR(cname, mtype, name)  \</span>
<a href="#l2.150"></a><span id="l2.150" class="difflineplus">+  CAL_ISUPPORTS_ATTR_GETTER(cname, mtype, name) \</span>
<a href="#l2.151"></a><span id="l2.151" class="difflineplus">+  CAL_ISUPPORTS_ATTR_SETTER(cname, mtype, name)</span>
<a href="#l2.152"></a><span id="l2.152"> </span>
<a href="#l2.153"></a><span id="l2.153"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/calendar/base/backend/libical/calDateTime.cpp</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/calendar/base/backend/libical/calDateTime.cpp</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -15,591 +15,555 @@</span>
<a href="#l3.4"></a><span id="l3.4"> #include &quot;jsfriendapi.h&quot;</span>
<a href="#l3.5"></a><span id="l3.5"> #include &quot;js/Wrapper.h&quot;</span>
<a href="#l3.6"></a><span id="l3.6"> #include &quot;prprf.h&quot;</span>
<a href="#l3.7"></a><span id="l3.7"> </span>
<a href="#l3.8"></a><span id="l3.8"> extern &quot;C&quot; {</span>
<a href="#l3.9"></a><span id="l3.9"> #include &quot;ical.h&quot;</span>
<a href="#l3.10"></a><span id="l3.10"> }</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-#define CAL_ATTR_SET_PRE NS_ENSURE_FALSE(mImmutable, NS_ERROR_OBJECT_IS_IMMUTABLE)</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+#define CAL_ATTR_SET_PRE \</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+  NS_ENSURE_FALSE(mImmutable, NS_ERROR_OBJECT_IS_IMMUTABLE)</span>
<a href="#l3.15"></a><span id="l3.15"> #define CAL_ATTR_SET_POST Normalize()</span>
<a href="#l3.16"></a><span id="l3.16"> #include &quot;calAttributeHelpers.h&quot;</span>
<a href="#l3.17"></a><span id="l3.17"> </span>
<a href="#l3.18"></a><span id="l3.18"> NS_IMPL_CLASSINFO(calDateTime, nullptr, 0, CAL_DATETIME_CID)</span>
<a href="#l3.19"></a><span id="l3.19"> NS_IMPL_ISUPPORTS_CI(calDateTime, calIDateTime, calIDateTimeLibical)</span>
<a href="#l3.20"></a><span id="l3.20"> </span>
<a href="#l3.21"></a><span id="l3.21" class="difflineminus">-calDateTime::calDateTime()</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineminus">-    : mImmutable(false)</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineminus">-{</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineminus">-    Reset();</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineplus">+calDateTime::calDateTime() : mImmutable(false) { Reset(); }</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineplus">+</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineplus">+calDateTime::calDateTime(icaltimetype const *atimeptr, calITimezone *tz)</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineplus">+    : mImmutable(false) {</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineplus">+  FromIcalTime(atimeptr, tz);</span>
<a href="#l3.30"></a><span id="l3.30"> }</span>
<a href="#l3.31"></a><span id="l3.31"> </span>
<a href="#l3.32"></a><span id="l3.32" class="difflineminus">-calDateTime::calDateTime(icaltimetype const* atimeptr, calITimezone *tz)</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineminus">-    : mImmutable(false)</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineminus">-{</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineminus">-    FromIcalTime(atimeptr, tz);</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineplus">+calDateTime::GetIsMutable(bool *aResult) {</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineplus">+  *aResult = !mImmutable;</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineplus">+  return NS_OK;</span>
<a href="#l3.41"></a><span id="l3.41"> }</span>
<a href="#l3.42"></a><span id="l3.42"> </span>
<a href="#l3.43"></a><span id="l3.43"> NS_IMETHODIMP</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineminus">-calDateTime::GetIsMutable(bool *aResult)</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineminus">-{</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineminus">-    *aResult = !mImmutable;</span>
<a href="#l3.48"></a><span id="l3.48" class="difflineminus">-    return NS_OK;</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineplus">+calDateTime::MakeImmutable() {</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineplus">+  mImmutable = true;</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineplus">+  return NS_OK;</span>
<a href="#l3.52"></a><span id="l3.52"> }</span>
<a href="#l3.53"></a><span id="l3.53"> </span>
<a href="#l3.54"></a><span id="l3.54"> NS_IMETHODIMP</span>
<a href="#l3.55"></a><span id="l3.55" class="difflineminus">-calDateTime::MakeImmutable()</span>
<a href="#l3.56"></a><span id="l3.56" class="difflineminus">-{</span>
<a href="#l3.57"></a><span id="l3.57" class="difflineminus">-    mImmutable = true;</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineminus">-    return NS_OK;</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineminus">-}</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineminus">-</span>
<a href="#l3.61"></a><span id="l3.61" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineminus">-calDateTime::Clone(calIDateTime **aResult)</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineminus">-{</span>
<a href="#l3.64"></a><span id="l3.64" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l3.65"></a><span id="l3.65" class="difflineminus">-    icaltimetype itt;</span>
<a href="#l3.66"></a><span id="l3.66" class="difflineminus">-    ToIcalTime(&amp;itt);</span>
<a href="#l3.67"></a><span id="l3.67" class="difflineminus">-    calDateTime * const cdt = new calDateTime(&amp;itt, mTimezone);</span>
<a href="#l3.68"></a><span id="l3.68" class="difflineminus">-    CAL_ENSURE_MEMORY(cdt);</span>
<a href="#l3.69"></a><span id="l3.69" class="difflineminus">-    NS_ADDREF(*aResult = cdt);</span>
<a href="#l3.70"></a><span id="l3.70" class="difflineminus">-    return NS_OK;</span>
<a href="#l3.71"></a><span id="l3.71" class="difflineplus">+calDateTime::Clone(calIDateTime **aResult) {</span>
<a href="#l3.72"></a><span id="l3.72" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l3.73"></a><span id="l3.73" class="difflineplus">+  icaltimetype itt;</span>
<a href="#l3.74"></a><span id="l3.74" class="difflineplus">+  ToIcalTime(&amp;itt);</span>
<a href="#l3.75"></a><span id="l3.75" class="difflineplus">+  calDateTime *const cdt = new calDateTime(&amp;itt, mTimezone);</span>
<a href="#l3.76"></a><span id="l3.76" class="difflineplus">+  CAL_ENSURE_MEMORY(cdt);</span>
<a href="#l3.77"></a><span id="l3.77" class="difflineplus">+  NS_ADDREF(*aResult = cdt);</span>
<a href="#l3.78"></a><span id="l3.78" class="difflineplus">+  return NS_OK;</span>
<a href="#l3.79"></a><span id="l3.79"> }</span>
<a href="#l3.80"></a><span id="l3.80"> </span>
<a href="#l3.81"></a><span id="l3.81"> NS_IMETHODIMP</span>
<a href="#l3.82"></a><span id="l3.82" class="difflineminus">-calDateTime::ResetTo(int16_t year,</span>
<a href="#l3.83"></a><span id="l3.83" class="difflineminus">-                     int16_t month,</span>
<a href="#l3.84"></a><span id="l3.84" class="difflineminus">-                     int16_t day,</span>
<a href="#l3.85"></a><span id="l3.85" class="difflineminus">-                     int16_t hour,</span>
<a href="#l3.86"></a><span id="l3.86" class="difflineminus">-                     int16_t minute,</span>
<a href="#l3.87"></a><span id="l3.87" class="difflineminus">-                     int16_t second,</span>
<a href="#l3.88"></a><span id="l3.88" class="difflineminus">-                     calITimezone * tz)</span>
<a href="#l3.89"></a><span id="l3.89" class="difflineminus">-{</span>
<a href="#l3.90"></a><span id="l3.90" class="difflineminus">-    NS_ENSURE_FALSE(mImmutable, NS_ERROR_OBJECT_IS_IMMUTABLE);</span>
<a href="#l3.91"></a><span id="l3.91" class="difflineminus">-    NS_ENSURE_ARG_POINTER(tz);</span>
<a href="#l3.92"></a><span id="l3.92" class="difflineminus">-    mYear = year;</span>
<a href="#l3.93"></a><span id="l3.93" class="difflineminus">-    mMonth = month;</span>
<a href="#l3.94"></a><span id="l3.94" class="difflineminus">-    mDay = day;</span>
<a href="#l3.95"></a><span id="l3.95" class="difflineminus">-    mHour = hour;</span>
<a href="#l3.96"></a><span id="l3.96" class="difflineminus">-    mMinute = minute;</span>
<a href="#l3.97"></a><span id="l3.97" class="difflineminus">-    mSecond = second;</span>
<a href="#l3.98"></a><span id="l3.98" class="difflineminus">-    mIsDate = false;</span>
<a href="#l3.99"></a><span id="l3.99" class="difflineminus">-    mTimezone = tz;</span>
<a href="#l3.100"></a><span id="l3.100" class="difflineminus">-    Normalize();</span>
<a href="#l3.101"></a><span id="l3.101" class="difflineminus">-    return NS_OK;</span>
<a href="#l3.102"></a><span id="l3.102" class="difflineplus">+calDateTime::ResetTo(int16_t year, int16_t month, int16_t day, int16_t hour,</span>
<a href="#l3.103"></a><span id="l3.103" class="difflineplus">+                     int16_t minute, int16_t second, calITimezone *tz) {</span>
<a href="#l3.104"></a><span id="l3.104" class="difflineplus">+  NS_ENSURE_FALSE(mImmutable, NS_ERROR_OBJECT_IS_IMMUTABLE);</span>
<a href="#l3.105"></a><span id="l3.105" class="difflineplus">+  NS_ENSURE_ARG_POINTER(tz);</span>
<a href="#l3.106"></a><span id="l3.106" class="difflineplus">+  mYear = year;</span>
<a href="#l3.107"></a><span id="l3.107" class="difflineplus">+  mMonth = month;</span>
<a href="#l3.108"></a><span id="l3.108" class="difflineplus">+  mDay = day;</span>
<a href="#l3.109"></a><span id="l3.109" class="difflineplus">+  mHour = hour;</span>
<a href="#l3.110"></a><span id="l3.110" class="difflineplus">+  mMinute = minute;</span>
<a href="#l3.111"></a><span id="l3.111" class="difflineplus">+  mSecond = second;</span>
<a href="#l3.112"></a><span id="l3.112" class="difflineplus">+  mIsDate = false;</span>
<a href="#l3.113"></a><span id="l3.113" class="difflineplus">+  mTimezone = tz;</span>
<a href="#l3.114"></a><span id="l3.114" class="difflineplus">+  Normalize();</span>
<a href="#l3.115"></a><span id="l3.115" class="difflineplus">+  return NS_OK;</span>
<a href="#l3.116"></a><span id="l3.116"> }</span>
<a href="#l3.117"></a><span id="l3.117"> </span>
<a href="#l3.118"></a><span id="l3.118"> NS_IMETHODIMP</span>
<a href="#l3.119"></a><span id="l3.119" class="difflineminus">-calDateTime::Reset()</span>
<a href="#l3.120"></a><span id="l3.120" class="difflineminus">-{</span>
<a href="#l3.121"></a><span id="l3.121" class="difflineminus">-    NS_ENSURE_FALSE(mImmutable, NS_ERROR_OBJECT_IS_IMMUTABLE);</span>
<a href="#l3.122"></a><span id="l3.122" class="difflineminus">-    mYear = 1970;</span>
<a href="#l3.123"></a><span id="l3.123" class="difflineminus">-    mMonth = 0;</span>
<a href="#l3.124"></a><span id="l3.124" class="difflineminus">-    mDay = 1;</span>
<a href="#l3.125"></a><span id="l3.125" class="difflineminus">-    mHour = 0;</span>
<a href="#l3.126"></a><span id="l3.126" class="difflineminus">-    mMinute = 0;</span>
<a href="#l3.127"></a><span id="l3.127" class="difflineminus">-    mSecond = 0;</span>
<a href="#l3.128"></a><span id="l3.128" class="difflineminus">-    mWeekday = 4;</span>
<a href="#l3.129"></a><span id="l3.129" class="difflineminus">-    mYearday = 1;</span>
<a href="#l3.130"></a><span id="l3.130" class="difflineminus">-    mIsDate = false;</span>
<a href="#l3.131"></a><span id="l3.131" class="difflineminus">-    mTimezone = nullptr;</span>
<a href="#l3.132"></a><span id="l3.132" class="difflineminus">-    mNativeTime = 0;</span>
<a href="#l3.133"></a><span id="l3.133" class="difflineminus">-    mIsValid = true;</span>
<a href="#l3.134"></a><span id="l3.134" class="difflineminus">-    return NS_OK;</span>
<a href="#l3.135"></a><span id="l3.135" class="difflineplus">+calDateTime::Reset() {</span>
<a href="#l3.136"></a><span id="l3.136" class="difflineplus">+  NS_ENSURE_FALSE(mImmutable, NS_ERROR_OBJECT_IS_IMMUTABLE);</span>
<a href="#l3.137"></a><span id="l3.137" class="difflineplus">+  mYear = 1970;</span>
<a href="#l3.138"></a><span id="l3.138" class="difflineplus">+  mMonth = 0;</span>
<a href="#l3.139"></a><span id="l3.139" class="difflineplus">+  mDay = 1;</span>
<a href="#l3.140"></a><span id="l3.140" class="difflineplus">+  mHour = 0;</span>
<a href="#l3.141"></a><span id="l3.141" class="difflineplus">+  mMinute = 0;</span>
<a href="#l3.142"></a><span id="l3.142" class="difflineplus">+  mSecond = 0;</span>
<a href="#l3.143"></a><span id="l3.143" class="difflineplus">+  mWeekday = 4;</span>
<a href="#l3.144"></a><span id="l3.144" class="difflineplus">+  mYearday = 1;</span>
<a href="#l3.145"></a><span id="l3.145" class="difflineplus">+  mIsDate = false;</span>
<a href="#l3.146"></a><span id="l3.146" class="difflineplus">+  mTimezone = nullptr;</span>
<a href="#l3.147"></a><span id="l3.147" class="difflineplus">+  mNativeTime = 0;</span>
<a href="#l3.148"></a><span id="l3.148" class="difflineplus">+  mIsValid = true;</span>
<a href="#l3.149"></a><span id="l3.149" class="difflineplus">+  return NS_OK;</span>
<a href="#l3.150"></a><span id="l3.150"> }</span>
<a href="#l3.151"></a><span id="l3.151"> </span>
<a href="#l3.152"></a><span id="l3.152"> CAL_VALUETYPE_ATTR(calDateTime, int16_t, Year)</span>
<a href="#l3.153"></a><span id="l3.153"> CAL_VALUETYPE_ATTR(calDateTime, int16_t, Month)</span>
<a href="#l3.154"></a><span id="l3.154"> CAL_VALUETYPE_ATTR(calDateTime, int16_t, Day)</span>
<a href="#l3.155"></a><span id="l3.155"> CAL_VALUETYPE_ATTR(calDateTime, int16_t, Hour)</span>
<a href="#l3.156"></a><span id="l3.156"> CAL_VALUETYPE_ATTR(calDateTime, int16_t, Minute)</span>
<a href="#l3.157"></a><span id="l3.157"> CAL_VALUETYPE_ATTR(calDateTime, int16_t, Second)</span>
<a href="#l3.158"></a><span id="l3.158"> CAL_VALUETYPE_ATTR(calDateTime, bool, IsDate)</span>
<a href="#l3.159"></a><span id="l3.159"> CAL_VALUETYPE_ATTR_GETTER(calDateTime, bool, IsValid)</span>
<a href="#l3.160"></a><span id="l3.160"> CAL_VALUETYPE_ATTR_GETTER(calDateTime, PRTime, NativeTime)</span>
<a href="#l3.161"></a><span id="l3.161"> CAL_VALUETYPE_ATTR_GETTER(calDateTime, int16_t, Weekday)</span>
<a href="#l3.162"></a><span id="l3.162"> CAL_VALUETYPE_ATTR_GETTER(calDateTime, int16_t, Yearday)</span>
<a href="#l3.163"></a><span id="l3.163"> </span>
<a href="#l3.164"></a><span id="l3.164" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l3.165"></a><span id="l3.165" class="difflineplus">+calDateTime::GetTimezone(calITimezone **aResult) {</span>
<a href="#l3.166"></a><span id="l3.166" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l3.167"></a><span id="l3.167" class="difflineplus">+  ensureTimezone();</span>
<a href="#l3.168"></a><span id="l3.168"> </span>
<a href="#l3.169"></a><span id="l3.169" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l3.170"></a><span id="l3.170" class="difflineminus">-calDateTime::GetTimezone(calITimezone **aResult)</span>
<a href="#l3.171"></a><span id="l3.171" class="difflineminus">-{</span>
<a href="#l3.172"></a><span id="l3.172" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l3.173"></a><span id="l3.173" class="difflineminus">-    ensureTimezone();</span>
<a href="#l3.174"></a><span id="l3.174" class="difflineminus">-</span>
<a href="#l3.175"></a><span id="l3.175" class="difflineminus">-    NS_IF_ADDREF(*aResult = mTimezone);</span>
<a href="#l3.176"></a><span id="l3.176" class="difflineminus">-    return NS_OK;</span>
<a href="#l3.177"></a><span id="l3.177" class="difflineplus">+  NS_IF_ADDREF(*aResult = mTimezone);</span>
<a href="#l3.178"></a><span id="l3.178" class="difflineplus">+  return NS_OK;</span>
<a href="#l3.179"></a><span id="l3.179"> }</span>
<a href="#l3.180"></a><span id="l3.180"> </span>
<a href="#l3.181"></a><span id="l3.181"> NS_IMETHODIMP</span>
<a href="#l3.182"></a><span id="l3.182" class="difflineminus">-calDateTime::SetTimezone(calITimezone *aValue)</span>
<a href="#l3.183"></a><span id="l3.183" class="difflineminus">-{</span>
<a href="#l3.184"></a><span id="l3.184" class="difflineminus">-    NS_ENSURE_FALSE(mImmutable, NS_ERROR_OBJECT_IS_IMMUTABLE);</span>
<a href="#l3.185"></a><span id="l3.185" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aValue);</span>
<a href="#l3.186"></a><span id="l3.186" class="difflineminus">-    mTimezone = aValue;</span>
<a href="#l3.187"></a><span id="l3.187" class="difflineminus">-    CAL_ATTR_SET_POST;</span>
<a href="#l3.188"></a><span id="l3.188" class="difflineminus">-    return NS_OK;</span>
<a href="#l3.189"></a><span id="l3.189" class="difflineplus">+calDateTime::SetTimezone(calITimezone *aValue) {</span>
<a href="#l3.190"></a><span id="l3.190" class="difflineplus">+  NS_ENSURE_FALSE(mImmutable, NS_ERROR_OBJECT_IS_IMMUTABLE);</span>
<a href="#l3.191"></a><span id="l3.191" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aValue);</span>
<a href="#l3.192"></a><span id="l3.192" class="difflineplus">+  mTimezone = aValue;</span>
<a href="#l3.193"></a><span id="l3.193" class="difflineplus">+  CAL_ATTR_SET_POST;</span>
<a href="#l3.194"></a><span id="l3.194" class="difflineplus">+  return NS_OK;</span>
<a href="#l3.195"></a><span id="l3.195"> }</span>
<a href="#l3.196"></a><span id="l3.196"> </span>
<a href="#l3.197"></a><span id="l3.197"> NS_IMETHODIMP</span>
<a href="#l3.198"></a><span id="l3.198" class="difflineminus">-calDateTime::GetTimezoneOffset(int32_t *aResult)</span>
<a href="#l3.199"></a><span id="l3.199" class="difflineminus">-{</span>
<a href="#l3.200"></a><span id="l3.200" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l3.201"></a><span id="l3.201" class="difflineminus">-    icaltimetype icalt;</span>
<a href="#l3.202"></a><span id="l3.202" class="difflineminus">-    ToIcalTime(&amp;icalt);</span>
<a href="#l3.203"></a><span id="l3.203" class="difflineminus">-    int dst;</span>
<a href="#l3.204"></a><span id="l3.204" class="difflineminus">-    *aResult = icaltimezone_get_utc_offset(const_cast&lt;icaltimezone *&gt;(icalt.zone), &amp;icalt, &amp;dst);</span>
<a href="#l3.205"></a><span id="l3.205" class="difflineminus">-    return NS_OK;</span>
<a href="#l3.206"></a><span id="l3.206" class="difflineplus">+calDateTime::GetTimezoneOffset(int32_t *aResult) {</span>
<a href="#l3.207"></a><span id="l3.207" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l3.208"></a><span id="l3.208" class="difflineplus">+  icaltimetype icalt;</span>
<a href="#l3.209"></a><span id="l3.209" class="difflineplus">+  ToIcalTime(&amp;icalt);</span>
<a href="#l3.210"></a><span id="l3.210" class="difflineplus">+  int dst;</span>
<a href="#l3.211"></a><span id="l3.211" class="difflineplus">+  *aResult = icaltimezone_get_utc_offset(const_cast&lt;icaltimezone *&gt;(icalt.zone),</span>
<a href="#l3.212"></a><span id="l3.212" class="difflineplus">+                                         &amp;icalt, &amp;dst);</span>
<a href="#l3.213"></a><span id="l3.213" class="difflineplus">+  return NS_OK;</span>
<a href="#l3.214"></a><span id="l3.214"> }</span>
<a href="#l3.215"></a><span id="l3.215"> </span>
<a href="#l3.216"></a><span id="l3.216"> NS_IMETHODIMP</span>
<a href="#l3.217"></a><span id="l3.217" class="difflineminus">-calDateTime::SetNativeTime(PRTime aNativeTime)</span>
<a href="#l3.218"></a><span id="l3.218" class="difflineminus">-{</span>
<a href="#l3.219"></a><span id="l3.219" class="difflineminus">-    icaltimetype icalt;</span>
<a href="#l3.220"></a><span id="l3.220" class="difflineminus">-    PRTimeToIcaltime(aNativeTime, false, icaltimezone_get_utc_timezone(), &amp;icalt);</span>
<a href="#l3.221"></a><span id="l3.221" class="difflineminus">-    nsCOMPtr&lt;calITimezone&gt; ctz = cal::UTC();</span>
<a href="#l3.222"></a><span id="l3.222" class="difflineminus">-    FromIcalTime(&amp;icalt, ctz);</span>
<a href="#l3.223"></a><span id="l3.223" class="difflineminus">-    return NS_OK;</span>
<a href="#l3.224"></a><span id="l3.224" class="difflineplus">+calDateTime::SetNativeTime(PRTime aNativeTime) {</span>
<a href="#l3.225"></a><span id="l3.225" class="difflineplus">+  icaltimetype icalt;</span>
<a href="#l3.226"></a><span id="l3.226" class="difflineplus">+  PRTimeToIcaltime(aNativeTime, false, icaltimezone_get_utc_timezone(), &amp;icalt);</span>
<a href="#l3.227"></a><span id="l3.227" class="difflineplus">+  nsCOMPtr&lt;calITimezone&gt; ctz = cal::UTC();</span>
<a href="#l3.228"></a><span id="l3.228" class="difflineplus">+  FromIcalTime(&amp;icalt, ctz);</span>
<a href="#l3.229"></a><span id="l3.229" class="difflineplus">+  return NS_OK;</span>
<a href="#l3.230"></a><span id="l3.230"> }</span>
<a href="#l3.231"></a><span id="l3.231"> </span>
<a href="#l3.232"></a><span id="l3.232"> NS_IMETHODIMP</span>
<a href="#l3.233"></a><span id="l3.233" class="difflineminus">-calDateTime::AddDuration(calIDuration *aDuration)</span>
<a href="#l3.234"></a><span id="l3.234" class="difflineminus">-{</span>
<a href="#l3.235"></a><span id="l3.235" class="difflineminus">-    NS_ENSURE_FALSE(mImmutable, NS_ERROR_OBJECT_IS_IMMUTABLE);</span>
<a href="#l3.236"></a><span id="l3.236" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aDuration);</span>
<a href="#l3.237"></a><span id="l3.237" class="difflineminus">-    ensureTimezone();</span>
<a href="#l3.238"></a><span id="l3.238" class="difflineplus">+calDateTime::AddDuration(calIDuration *aDuration) {</span>
<a href="#l3.239"></a><span id="l3.239" class="difflineplus">+  NS_ENSURE_FALSE(mImmutable, NS_ERROR_OBJECT_IS_IMMUTABLE);</span>
<a href="#l3.240"></a><span id="l3.240" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aDuration);</span>
<a href="#l3.241"></a><span id="l3.241" class="difflineplus">+  ensureTimezone();</span>
<a href="#l3.242"></a><span id="l3.242"> </span>
<a href="#l3.243"></a><span id="l3.243" class="difflineminus">-    nsresult rv;</span>
<a href="#l3.244"></a><span id="l3.244" class="difflineminus">-    nsCOMPtr&lt;calIDurationLibical&gt; icaldur = do_QueryInterface(aDuration, &amp;rv);</span>
<a href="#l3.245"></a><span id="l3.245" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.246"></a><span id="l3.246" class="difflineplus">+  nsresult rv;</span>
<a href="#l3.247"></a><span id="l3.247" class="difflineplus">+  nsCOMPtr&lt;calIDurationLibical&gt; icaldur = do_QueryInterface(aDuration, &amp;rv);</span>
<a href="#l3.248"></a><span id="l3.248" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.249"></a><span id="l3.249"> </span>
<a href="#l3.250"></a><span id="l3.250" class="difflineminus">-    icaldurationtype idt;</span>
<a href="#l3.251"></a><span id="l3.251" class="difflineminus">-    icaldur-&gt;ToIcalDuration(&amp;idt);</span>
<a href="#l3.252"></a><span id="l3.252" class="difflineplus">+  icaldurationtype idt;</span>
<a href="#l3.253"></a><span id="l3.253" class="difflineplus">+  icaldur-&gt;ToIcalDuration(&amp;idt);</span>
<a href="#l3.254"></a><span id="l3.254"> </span>
<a href="#l3.255"></a><span id="l3.255" class="difflineminus">-    icaltimetype itt;</span>
<a href="#l3.256"></a><span id="l3.256" class="difflineminus">-    ToIcalTime(&amp;itt);</span>
<a href="#l3.257"></a><span id="l3.257" class="difflineplus">+  icaltimetype itt;</span>
<a href="#l3.258"></a><span id="l3.258" class="difflineplus">+  ToIcalTime(&amp;itt);</span>
<a href="#l3.259"></a><span id="l3.259"> </span>
<a href="#l3.260"></a><span id="l3.260" class="difflineminus">-    icaltimetype const newitt = icaltime_add(itt, idt);</span>
<a href="#l3.261"></a><span id="l3.261" class="difflineminus">-    FromIcalTime(&amp;newitt, mTimezone);</span>
<a href="#l3.262"></a><span id="l3.262" class="difflineplus">+  icaltimetype const newitt = icaltime_add(itt, idt);</span>
<a href="#l3.263"></a><span id="l3.263" class="difflineplus">+  FromIcalTime(&amp;newitt, mTimezone);</span>
<a href="#l3.264"></a><span id="l3.264"> </span>
<a href="#l3.265"></a><span id="l3.265" class="difflineminus">-    return NS_OK;</span>
<a href="#l3.266"></a><span id="l3.266" class="difflineplus">+  return NS_OK;</span>
<a href="#l3.267"></a><span id="l3.267"> }</span>
<a href="#l3.268"></a><span id="l3.268"> </span>
<a href="#l3.269"></a><span id="l3.269"> NS_IMETHODIMP</span>
<a href="#l3.270"></a><span id="l3.270" class="difflineminus">-calDateTime::SubtractDate(calIDateTime *aDate, calIDuration **aDuration)</span>
<a href="#l3.271"></a><span id="l3.271" class="difflineminus">-{</span>
<a href="#l3.272"></a><span id="l3.272" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aDate);</span>
<a href="#l3.273"></a><span id="l3.273" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aDuration);</span>
<a href="#l3.274"></a><span id="l3.274" class="difflineplus">+calDateTime::SubtractDate(calIDateTime *aDate, calIDuration **aDuration) {</span>
<a href="#l3.275"></a><span id="l3.275" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aDate);</span>
<a href="#l3.276"></a><span id="l3.276" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aDuration);</span>
<a href="#l3.277"></a><span id="l3.277"> </span>
<a href="#l3.278"></a><span id="l3.278" class="difflineminus">-    // same as icaltime_subtract(), but minding timezones:</span>
<a href="#l3.279"></a><span id="l3.279" class="difflineminus">-    PRTime t2t;</span>
<a href="#l3.280"></a><span id="l3.280" class="difflineminus">-    aDate-&gt;GetNativeTime(&amp;t2t);</span>
<a href="#l3.281"></a><span id="l3.281" class="difflineminus">-    // for a duration, need to convert the difference in microseconds (prtime)</span>
<a href="#l3.282"></a><span id="l3.282" class="difflineminus">-    // to seconds (libical), so divide by one million.</span>
<a href="#l3.283"></a><span id="l3.283" class="difflineminus">-    icaldurationtype const idt = icaldurationtype_from_int(</span>
<a href="#l3.284"></a><span id="l3.284" class="difflineminus">-        static_cast&lt;int&gt;((mNativeTime - t2t) / int64_t(PR_USEC_PER_SEC)));</span>
<a href="#l3.285"></a><span id="l3.285" class="difflineplus">+  // same as icaltime_subtract(), but minding timezones:</span>
<a href="#l3.286"></a><span id="l3.286" class="difflineplus">+  PRTime t2t;</span>
<a href="#l3.287"></a><span id="l3.287" class="difflineplus">+  aDate-&gt;GetNativeTime(&amp;t2t);</span>
<a href="#l3.288"></a><span id="l3.288" class="difflineplus">+  // for a duration, need to convert the difference in microseconds (prtime)</span>
<a href="#l3.289"></a><span id="l3.289" class="difflineplus">+  // to seconds (libical), so divide by one million.</span>
<a href="#l3.290"></a><span id="l3.290" class="difflineplus">+  icaldurationtype const idt = icaldurationtype_from_int(</span>
<a href="#l3.291"></a><span id="l3.291" class="difflineplus">+      static_cast&lt;int&gt;((mNativeTime - t2t) / int64_t(PR_USEC_PER_SEC)));</span>
<a href="#l3.292"></a><span id="l3.292"> </span>
<a href="#l3.293"></a><span id="l3.293" class="difflineminus">-    calDuration * const dur = new calDuration(&amp;idt);</span>
<a href="#l3.294"></a><span id="l3.294" class="difflineminus">-    CAL_ENSURE_MEMORY(dur);</span>
<a href="#l3.295"></a><span id="l3.295" class="difflineminus">-    NS_ADDREF(*aDuration = dur);</span>
<a href="#l3.296"></a><span id="l3.296" class="difflineminus">-    return NS_OK;</span>
<a href="#l3.297"></a><span id="l3.297" class="difflineplus">+  calDuration *const dur = new calDuration(&amp;idt);</span>
<a href="#l3.298"></a><span id="l3.298" class="difflineplus">+  CAL_ENSURE_MEMORY(dur);</span>
<a href="#l3.299"></a><span id="l3.299" class="difflineplus">+  NS_ADDREF(*aDuration = dur);</span>
<a href="#l3.300"></a><span id="l3.300" class="difflineplus">+  return NS_OK;</span>
<a href="#l3.301"></a><span id="l3.301"> }</span>
<a href="#l3.302"></a><span id="l3.302"> </span>
<a href="#l3.303"></a><span id="l3.303"> NS_IMETHODIMP</span>
<a href="#l3.304"></a><span id="l3.304" class="difflineminus">-calDateTime::ToString(nsACString &amp; aResult)</span>
<a href="#l3.305"></a><span id="l3.305" class="difflineminus">-{</span>
<a href="#l3.306"></a><span id="l3.306" class="difflineminus">-    nsAutoCString tzid;</span>
<a href="#l3.307"></a><span id="l3.307" class="difflineminus">-    char buffer[256];</span>
<a href="#l3.308"></a><span id="l3.308" class="difflineplus">+calDateTime::ToString(nsACString &amp;aResult) {</span>
<a href="#l3.309"></a><span id="l3.309" class="difflineplus">+  nsAutoCString tzid;</span>
<a href="#l3.310"></a><span id="l3.310" class="difflineplus">+  char buffer[256];</span>
<a href="#l3.311"></a><span id="l3.311"> </span>
<a href="#l3.312"></a><span id="l3.312" class="difflineminus">-    ensureTimezone();</span>
<a href="#l3.313"></a><span id="l3.313" class="difflineminus">-    mTimezone-&gt;GetTzid(tzid);</span>
<a href="#l3.314"></a><span id="l3.314" class="difflineplus">+  ensureTimezone();</span>
<a href="#l3.315"></a><span id="l3.315" class="difflineplus">+  mTimezone-&gt;GetTzid(tzid);</span>
<a href="#l3.316"></a><span id="l3.316"> </span>
<a href="#l3.317"></a><span id="l3.317" class="difflineminus">-    uint32_t const length = PR_snprintf(</span>
<a href="#l3.318"></a><span id="l3.318" class="difflineminus">-        buffer, sizeof(buffer), &quot;%04hd/%02hd/%02hd %02hd:%02hd:%02hd %s isDate=%01hd nativeTime=%lld&quot;,</span>
<a href="#l3.319"></a><span id="l3.319" class="difflineminus">-        mYear, mMonth + 1, mDay, mHour, mMinute, mSecond,</span>
<a href="#l3.320"></a><span id="l3.320" class="difflineminus">-        tzid.get(), static_cast&lt;int16_t&gt;(mIsDate), mNativeTime);</span>
<a href="#l3.321"></a><span id="l3.321" class="difflineminus">-    if (length != static_cast&lt;uint32_t&gt;(-1))</span>
<a href="#l3.322"></a><span id="l3.322" class="difflineminus">-        aResult.Assign(buffer, length);</span>
<a href="#l3.323"></a><span id="l3.323" class="difflineminus">-    return NS_OK;</span>
<a href="#l3.324"></a><span id="l3.324" class="difflineplus">+  uint32_t const length = PR_snprintf(</span>
<a href="#l3.325"></a><span id="l3.325" class="difflineplus">+      buffer, sizeof(buffer),</span>
<a href="#l3.326"></a><span id="l3.326" class="difflineplus">+      &quot;%04hd/%02hd/%02hd %02hd:%02hd:%02hd %s isDate=%01hd nativeTime=%lld&quot;,</span>
<a href="#l3.327"></a><span id="l3.327" class="difflineplus">+      mYear, mMonth + 1, mDay, mHour, mMinute, mSecond, tzid.get(),</span>
<a href="#l3.328"></a><span id="l3.328" class="difflineplus">+      static_cast&lt;int16_t&gt;(mIsDate), mNativeTime);</span>
<a href="#l3.329"></a><span id="l3.329" class="difflineplus">+  if (length != static_cast&lt;uint32_t&gt;(-1)) aResult.Assign(buffer, length);</span>
<a href="#l3.330"></a><span id="l3.330" class="difflineplus">+  return NS_OK;</span>
<a href="#l3.331"></a><span id="l3.331"> }</span>
<a href="#l3.332"></a><span id="l3.332"> </span>
<a href="#l3.333"></a><span id="l3.333"> NS_IMETHODIMP</span>
<a href="#l3.334"></a><span id="l3.334" class="difflineminus">-calDateTime::GetInTimezone(calITimezone * aTimezone, calIDateTime ** aResult)</span>
<a href="#l3.335"></a><span id="l3.335" class="difflineminus">-{</span>
<a href="#l3.336"></a><span id="l3.336" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aTimezone);</span>
<a href="#l3.337"></a><span id="l3.337" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l3.338"></a><span id="l3.338" class="difflineplus">+calDateTime::GetInTimezone(calITimezone *aTimezone, calIDateTime **aResult) {</span>
<a href="#l3.339"></a><span id="l3.339" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aTimezone);</span>
<a href="#l3.340"></a><span id="l3.340" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l3.341"></a><span id="l3.341"> </span>
<a href="#l3.342"></a><span id="l3.342" class="difflineminus">-    if (mIsDate) {</span>
<a href="#l3.343"></a><span id="l3.343" class="difflineminus">-        // if it's a date, we really just want to make a copy of this</span>
<a href="#l3.344"></a><span id="l3.344" class="difflineminus">-        // and set the timezone.</span>
<a href="#l3.345"></a><span id="l3.345" class="difflineminus">-        nsresult rv = Clone(aResult);</span>
<a href="#l3.346"></a><span id="l3.346" class="difflineminus">-        if (NS_SUCCEEDED(rv)) {</span>
<a href="#l3.347"></a><span id="l3.347" class="difflineminus">-            rv = (*aResult)-&gt;SetTimezone(aTimezone);</span>
<a href="#l3.348"></a><span id="l3.348" class="difflineminus">-        }</span>
<a href="#l3.349"></a><span id="l3.349" class="difflineminus">-        return rv;</span>
<a href="#l3.350"></a><span id="l3.350" class="difflineminus">-    } else {</span>
<a href="#l3.351"></a><span id="l3.351" class="difflineminus">-        icaltimetype icalt;</span>
<a href="#l3.352"></a><span id="l3.352" class="difflineminus">-        ToIcalTime(&amp;icalt);</span>
<a href="#l3.353"></a><span id="l3.353" class="difflineplus">+  if (mIsDate) {</span>
<a href="#l3.354"></a><span id="l3.354" class="difflineplus">+    // if it's a date, we really just want to make a copy of this</span>
<a href="#l3.355"></a><span id="l3.355" class="difflineplus">+    // and set the timezone.</span>
<a href="#l3.356"></a><span id="l3.356" class="difflineplus">+    nsresult rv = Clone(aResult);</span>
<a href="#l3.357"></a><span id="l3.357" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l3.358"></a><span id="l3.358" class="difflineplus">+      rv = (*aResult)-&gt;SetTimezone(aTimezone);</span>
<a href="#l3.359"></a><span id="l3.359" class="difflineplus">+    }</span>
<a href="#l3.360"></a><span id="l3.360" class="difflineplus">+    return rv;</span>
<a href="#l3.361"></a><span id="l3.361" class="difflineplus">+  } else {</span>
<a href="#l3.362"></a><span id="l3.362" class="difflineplus">+    icaltimetype icalt;</span>
<a href="#l3.363"></a><span id="l3.363" class="difflineplus">+    ToIcalTime(&amp;icalt);</span>
<a href="#l3.364"></a><span id="l3.364"> </span>
<a href="#l3.365"></a><span id="l3.365" class="difflineminus">-        icaltimezone * tz = cal::getIcalTimezone(aTimezone);</span>
<a href="#l3.366"></a><span id="l3.366" class="difflineminus">-        if (icalt.zone == tz) {</span>
<a href="#l3.367"></a><span id="l3.367" class="difflineminus">-            return Clone(aResult);</span>
<a href="#l3.368"></a><span id="l3.368" class="difflineminus">-        }</span>
<a href="#l3.369"></a><span id="l3.369" class="difflineplus">+    icaltimezone *tz = cal::getIcalTimezone(aTimezone);</span>
<a href="#l3.370"></a><span id="l3.370" class="difflineplus">+    if (icalt.zone == tz) {</span>
<a href="#l3.371"></a><span id="l3.371" class="difflineplus">+      return Clone(aResult);</span>
<a href="#l3.372"></a><span id="l3.372" class="difflineplus">+    }</span>
<a href="#l3.373"></a><span id="l3.373"> </span>
<a href="#l3.374"></a><span id="l3.374" class="difflineminus">-        /* If there's a zone, we need to convert; otherwise, we just</span>
<a href="#l3.375"></a><span id="l3.375" class="difflineminus">-         * assign, since this item is floating */</span>
<a href="#l3.376"></a><span id="l3.376" class="difflineminus">-        if (icalt.zone &amp;&amp; tz) {</span>
<a href="#l3.377"></a><span id="l3.377" class="difflineminus">-            icaltimezone_convert_time(&amp;icalt, const_cast&lt;icaltimezone *&gt;(icalt.zone), tz);</span>
<a href="#l3.378"></a><span id="l3.378" class="difflineminus">-        }</span>
<a href="#l3.379"></a><span id="l3.379" class="difflineminus">-        icalt.zone = tz;</span>
<a href="#l3.380"></a><span id="l3.380" class="difflineminus">-        icalt.is_utc = (tz &amp;&amp; tz == icaltimezone_get_utc_timezone());</span>
<a href="#l3.381"></a><span id="l3.381" class="difflineplus">+    /* If there's a zone, we need to convert; otherwise, we just</span>
<a href="#l3.382"></a><span id="l3.382" class="difflineplus">+     * assign, since this item is floating */</span>
<a href="#l3.383"></a><span id="l3.383" class="difflineplus">+    if (icalt.zone &amp;&amp; tz) {</span>
<a href="#l3.384"></a><span id="l3.384" class="difflineplus">+      icaltimezone_convert_time(&amp;icalt, const_cast&lt;icaltimezone *&gt;(icalt.zone),</span>
<a href="#l3.385"></a><span id="l3.385" class="difflineplus">+                                tz);</span>
<a href="#l3.386"></a><span id="l3.386" class="difflineplus">+    }</span>
<a href="#l3.387"></a><span id="l3.387" class="difflineplus">+    icalt.zone = tz;</span>
<a href="#l3.388"></a><span id="l3.388" class="difflineplus">+    icalt.is_utc = (tz &amp;&amp; tz == icaltimezone_get_utc_timezone());</span>
<a href="#l3.389"></a><span id="l3.389"> </span>
<a href="#l3.390"></a><span id="l3.390" class="difflineminus">-        calDateTime * cdt = new calDateTime(&amp;icalt, aTimezone);</span>
<a href="#l3.391"></a><span id="l3.391" class="difflineminus">-        CAL_ENSURE_MEMORY(cdt);</span>
<a href="#l3.392"></a><span id="l3.392" class="difflineminus">-        NS_ADDREF (*aResult = cdt);</span>
<a href="#l3.393"></a><span id="l3.393" class="difflineminus">-        return NS_OK;</span>
<a href="#l3.394"></a><span id="l3.394" class="difflineminus">-    }</span>
<a href="#l3.395"></a><span id="l3.395" class="difflineplus">+    calDateTime *cdt = new calDateTime(&amp;icalt, aTimezone);</span>
<a href="#l3.396"></a><span id="l3.396" class="difflineplus">+    CAL_ENSURE_MEMORY(cdt);</span>
<a href="#l3.397"></a><span id="l3.397" class="difflineplus">+    NS_ADDREF(*aResult = cdt);</span>
<a href="#l3.398"></a><span id="l3.398" class="difflineplus">+    return NS_OK;</span>
<a href="#l3.399"></a><span id="l3.399" class="difflineplus">+  }</span>
<a href="#l3.400"></a><span id="l3.400"> }</span>
<a href="#l3.401"></a><span id="l3.401"> </span>
<a href="#l3.402"></a><span id="l3.402"> NS_IMETHODIMP</span>
<a href="#l3.403"></a><span id="l3.403" class="difflineminus">-calDateTime::GetStartOfWeek(calIDateTime ** aResult)</span>
<a href="#l3.404"></a><span id="l3.404" class="difflineminus">-{</span>
<a href="#l3.405"></a><span id="l3.405" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l3.406"></a><span id="l3.406" class="difflineminus">-    ensureTimezone();</span>
<a href="#l3.407"></a><span id="l3.407" class="difflineplus">+calDateTime::GetStartOfWeek(calIDateTime **aResult) {</span>
<a href="#l3.408"></a><span id="l3.408" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l3.409"></a><span id="l3.409" class="difflineplus">+  ensureTimezone();</span>
<a href="#l3.410"></a><span id="l3.410"> </span>
<a href="#l3.411"></a><span id="l3.411" class="difflineminus">-    icaltimetype icalt;</span>
<a href="#l3.412"></a><span id="l3.412" class="difflineminus">-    ToIcalTime(&amp;icalt);</span>
<a href="#l3.413"></a><span id="l3.413" class="difflineminus">-    int day_of_week = icaltime_day_of_week(icalt);</span>
<a href="#l3.414"></a><span id="l3.414" class="difflineminus">-    if (day_of_week &gt; 1)</span>
<a href="#l3.415"></a><span id="l3.415" class="difflineminus">-        icaltime_adjust(&amp;icalt, - (day_of_week - 1), 0, 0, 0);</span>
<a href="#l3.416"></a><span id="l3.416" class="difflineminus">-    icalt.is_date = 1;</span>
<a href="#l3.417"></a><span id="l3.417" class="difflineplus">+  icaltimetype icalt;</span>
<a href="#l3.418"></a><span id="l3.418" class="difflineplus">+  ToIcalTime(&amp;icalt);</span>
<a href="#l3.419"></a><span id="l3.419" class="difflineplus">+  int day_of_week = icaltime_day_of_week(icalt);</span>
<a href="#l3.420"></a><span id="l3.420" class="difflineplus">+  if (day_of_week &gt; 1) icaltime_adjust(&amp;icalt, -(day_of_week - 1), 0, 0, 0);</span>
<a href="#l3.421"></a><span id="l3.421" class="difflineplus">+  icalt.is_date = 1;</span>
<a href="#l3.422"></a><span id="l3.422"> </span>
<a href="#l3.423"></a><span id="l3.423" class="difflineminus">-    calDateTime * const cdt = new calDateTime(&amp;icalt, mTimezone);</span>
<a href="#l3.424"></a><span id="l3.424" class="difflineminus">-    CAL_ENSURE_MEMORY(cdt);</span>
<a href="#l3.425"></a><span id="l3.425" class="difflineminus">-    NS_ADDREF(*aResult = cdt);</span>
<a href="#l3.426"></a><span id="l3.426" class="difflineminus">-    return NS_OK;</span>
<a href="#l3.427"></a><span id="l3.427" class="difflineplus">+  calDateTime *const cdt = new calDateTime(&amp;icalt, mTimezone);</span>
<a href="#l3.428"></a><span id="l3.428" class="difflineplus">+  CAL_ENSURE_MEMORY(cdt);</span>
<a href="#l3.429"></a><span id="l3.429" class="difflineplus">+  NS_ADDREF(*aResult = cdt);</span>
<a href="#l3.430"></a><span id="l3.430" class="difflineplus">+  return NS_OK;</span>
<a href="#l3.431"></a><span id="l3.431"> }</span>
<a href="#l3.432"></a><span id="l3.432"> </span>
<a href="#l3.433"></a><span id="l3.433"> NS_IMETHODIMP</span>
<a href="#l3.434"></a><span id="l3.434" class="difflineminus">-calDateTime::GetEndOfWeek(calIDateTime ** aResult)</span>
<a href="#l3.435"></a><span id="l3.435" class="difflineminus">-{</span>
<a href="#l3.436"></a><span id="l3.436" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l3.437"></a><span id="l3.437" class="difflineminus">-    ensureTimezone();</span>
<a href="#l3.438"></a><span id="l3.438" class="difflineplus">+calDateTime::GetEndOfWeek(calIDateTime **aResult) {</span>
<a href="#l3.439"></a><span id="l3.439" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l3.440"></a><span id="l3.440" class="difflineplus">+  ensureTimezone();</span>
<a href="#l3.441"></a><span id="l3.441"> </span>
<a href="#l3.442"></a><span id="l3.442" class="difflineminus">-    icaltimetype icalt;</span>
<a href="#l3.443"></a><span id="l3.443" class="difflineminus">-    ToIcalTime(&amp;icalt);</span>
<a href="#l3.444"></a><span id="l3.444" class="difflineminus">-    int day_of_week = icaltime_day_of_week(icalt);</span>
<a href="#l3.445"></a><span id="l3.445" class="difflineminus">-    if (day_of_week &lt; 7)</span>
<a href="#l3.446"></a><span id="l3.446" class="difflineminus">-        icaltime_adjust(&amp;icalt, 7 - day_of_week, 0, 0, 0);</span>
<a href="#l3.447"></a><span id="l3.447" class="difflineminus">-    icalt.is_date = 1;</span>
<a href="#l3.448"></a><span id="l3.448" class="difflineplus">+  icaltimetype icalt;</span>
<a href="#l3.449"></a><span id="l3.449" class="difflineplus">+  ToIcalTime(&amp;icalt);</span>
<a href="#l3.450"></a><span id="l3.450" class="difflineplus">+  int day_of_week = icaltime_day_of_week(icalt);</span>
<a href="#l3.451"></a><span id="l3.451" class="difflineplus">+  if (day_of_week &lt; 7) icaltime_adjust(&amp;icalt, 7 - day_of_week, 0, 0, 0);</span>
<a href="#l3.452"></a><span id="l3.452" class="difflineplus">+  icalt.is_date = 1;</span>
<a href="#l3.453"></a><span id="l3.453"> </span>
<a href="#l3.454"></a><span id="l3.454" class="difflineminus">-    calDateTime * const cdt = new calDateTime(&amp;icalt, mTimezone);</span>
<a href="#l3.455"></a><span id="l3.455" class="difflineminus">-    CAL_ENSURE_MEMORY(cdt);</span>
<a href="#l3.456"></a><span id="l3.456" class="difflineminus">-    NS_ADDREF(*aResult = cdt);</span>
<a href="#l3.457"></a><span id="l3.457" class="difflineminus">-    return NS_OK;</span>
<a href="#l3.458"></a><span id="l3.458" class="difflineplus">+  calDateTime *const cdt = new calDateTime(&amp;icalt, mTimezone);</span>
<a href="#l3.459"></a><span id="l3.459" class="difflineplus">+  CAL_ENSURE_MEMORY(cdt);</span>
<a href="#l3.460"></a><span id="l3.460" class="difflineplus">+  NS_ADDREF(*aResult = cdt);</span>
<a href="#l3.461"></a><span id="l3.461" class="difflineplus">+  return NS_OK;</span>
<a href="#l3.462"></a><span id="l3.462"> }</span>
<a href="#l3.463"></a><span id="l3.463"> </span>
<a href="#l3.464"></a><span id="l3.464"> NS_IMETHODIMP</span>
<a href="#l3.465"></a><span id="l3.465" class="difflineminus">-calDateTime::GetStartOfMonth(calIDateTime ** aResult)</span>
<a href="#l3.466"></a><span id="l3.466" class="difflineminus">-{</span>
<a href="#l3.467"></a><span id="l3.467" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l3.468"></a><span id="l3.468" class="difflineminus">-    ensureTimezone();</span>
<a href="#l3.469"></a><span id="l3.469" class="difflineplus">+calDateTime::GetStartOfMonth(calIDateTime **aResult) {</span>
<a href="#l3.470"></a><span id="l3.470" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l3.471"></a><span id="l3.471" class="difflineplus">+  ensureTimezone();</span>
<a href="#l3.472"></a><span id="l3.472"> </span>
<a href="#l3.473"></a><span id="l3.473" class="difflineminus">-    icaltimetype icalt;</span>
<a href="#l3.474"></a><span id="l3.474" class="difflineminus">-    ToIcalTime(&amp;icalt);</span>
<a href="#l3.475"></a><span id="l3.475" class="difflineminus">-    icalt.day = 1;</span>
<a href="#l3.476"></a><span id="l3.476" class="difflineminus">-    icalt.is_date = 1;</span>
<a href="#l3.477"></a><span id="l3.477" class="difflineplus">+  icaltimetype icalt;</span>
<a href="#l3.478"></a><span id="l3.478" class="difflineplus">+  ToIcalTime(&amp;icalt);</span>
<a href="#l3.479"></a><span id="l3.479" class="difflineplus">+  icalt.day = 1;</span>
<a href="#l3.480"></a><span id="l3.480" class="difflineplus">+  icalt.is_date = 1;</span>
<a href="#l3.481"></a><span id="l3.481"> </span>
<a href="#l3.482"></a><span id="l3.482" class="difflineminus">-    calDateTime * const cdt = new calDateTime(&amp;icalt, mTimezone);</span>
<a href="#l3.483"></a><span id="l3.483" class="difflineminus">-    CAL_ENSURE_MEMORY(cdt);</span>
<a href="#l3.484"></a><span id="l3.484" class="difflineminus">-    NS_ADDREF(*aResult = cdt);</span>
<a href="#l3.485"></a><span id="l3.485" class="difflineminus">-    return NS_OK;</span>
<a href="#l3.486"></a><span id="l3.486" class="difflineplus">+  calDateTime *const cdt = new calDateTime(&amp;icalt, mTimezone);</span>
<a href="#l3.487"></a><span id="l3.487" class="difflineplus">+  CAL_ENSURE_MEMORY(cdt);</span>
<a href="#l3.488"></a><span id="l3.488" class="difflineplus">+  NS_ADDREF(*aResult = cdt);</span>
<a href="#l3.489"></a><span id="l3.489" class="difflineplus">+  return NS_OK;</span>
<a href="#l3.490"></a><span id="l3.490"> }</span>
<a href="#l3.491"></a><span id="l3.491"> </span>
<a href="#l3.492"></a><span id="l3.492"> NS_IMETHODIMP</span>
<a href="#l3.493"></a><span id="l3.493" class="difflineminus">-calDateTime::GetEndOfMonth(calIDateTime ** aResult)</span>
<a href="#l3.494"></a><span id="l3.494" class="difflineminus">-{</span>
<a href="#l3.495"></a><span id="l3.495" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l3.496"></a><span id="l3.496" class="difflineminus">-    ensureTimezone();</span>
<a href="#l3.497"></a><span id="l3.497" class="difflineplus">+calDateTime::GetEndOfMonth(calIDateTime **aResult) {</span>
<a href="#l3.498"></a><span id="l3.498" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l3.499"></a><span id="l3.499" class="difflineplus">+  ensureTimezone();</span>
<a href="#l3.500"></a><span id="l3.500"> </span>
<a href="#l3.501"></a><span id="l3.501" class="difflineminus">-    icaltimetype icalt;</span>
<a href="#l3.502"></a><span id="l3.502" class="difflineminus">-    ToIcalTime(&amp;icalt);</span>
<a href="#l3.503"></a><span id="l3.503" class="difflineminus">-    icalt.day = icaltime_days_in_month(icalt.month, icalt.year);</span>
<a href="#l3.504"></a><span id="l3.504" class="difflineminus">-    icalt.is_date = 1;</span>
<a href="#l3.505"></a><span id="l3.505" class="difflineplus">+  icaltimetype icalt;</span>
<a href="#l3.506"></a><span id="l3.506" class="difflineplus">+  ToIcalTime(&amp;icalt);</span>
<a href="#l3.507"></a><span id="l3.507" class="difflineplus">+  icalt.day = icaltime_days_in_month(icalt.month, icalt.year);</span>
<a href="#l3.508"></a><span id="l3.508" class="difflineplus">+  icalt.is_date = 1;</span>
<a href="#l3.509"></a><span id="l3.509"> </span>
<a href="#l3.510"></a><span id="l3.510" class="difflineminus">-    calDateTime * const cdt = new calDateTime(&amp;icalt, mTimezone);</span>
<a href="#l3.511"></a><span id="l3.511" class="difflineminus">-    CAL_ENSURE_MEMORY(cdt);</span>
<a href="#l3.512"></a><span id="l3.512" class="difflineminus">-    NS_ADDREF(*aResult = cdt);</span>
<a href="#l3.513"></a><span id="l3.513" class="difflineminus">-    return NS_OK;</span>
<a href="#l3.514"></a><span id="l3.514" class="difflineplus">+  calDateTime *const cdt = new calDateTime(&amp;icalt, mTimezone);</span>
<a href="#l3.515"></a><span id="l3.515" class="difflineplus">+  CAL_ENSURE_MEMORY(cdt);</span>
<a href="#l3.516"></a><span id="l3.516" class="difflineplus">+  NS_ADDREF(*aResult = cdt);</span>
<a href="#l3.517"></a><span id="l3.517" class="difflineplus">+  return NS_OK;</span>
<a href="#l3.518"></a><span id="l3.518"> }</span>
<a href="#l3.519"></a><span id="l3.519"> </span>
<a href="#l3.520"></a><span id="l3.520"> NS_IMETHODIMP</span>
<a href="#l3.521"></a><span id="l3.521" class="difflineminus">-calDateTime::GetStartOfYear(calIDateTime ** aResult)</span>
<a href="#l3.522"></a><span id="l3.522" class="difflineminus">-{</span>
<a href="#l3.523"></a><span id="l3.523" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l3.524"></a><span id="l3.524" class="difflineminus">-    ensureTimezone();</span>
<a href="#l3.525"></a><span id="l3.525" class="difflineplus">+calDateTime::GetStartOfYear(calIDateTime **aResult) {</span>
<a href="#l3.526"></a><span id="l3.526" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l3.527"></a><span id="l3.527" class="difflineplus">+  ensureTimezone();</span>
<a href="#l3.528"></a><span id="l3.528"> </span>
<a href="#l3.529"></a><span id="l3.529" class="difflineminus">-    icaltimetype icalt;</span>
<a href="#l3.530"></a><span id="l3.530" class="difflineminus">-    ToIcalTime(&amp;icalt);</span>
<a href="#l3.531"></a><span id="l3.531" class="difflineminus">-    icalt.month = 1;</span>
<a href="#l3.532"></a><span id="l3.532" class="difflineminus">-    icalt.day = 1;</span>
<a href="#l3.533"></a><span id="l3.533" class="difflineminus">-    icalt.is_date = 1;</span>
<a href="#l3.534"></a><span id="l3.534" class="difflineplus">+  icaltimetype icalt;</span>
<a href="#l3.535"></a><span id="l3.535" class="difflineplus">+  ToIcalTime(&amp;icalt);</span>
<a href="#l3.536"></a><span id="l3.536" class="difflineplus">+  icalt.month = 1;</span>
<a href="#l3.537"></a><span id="l3.537" class="difflineplus">+  icalt.day = 1;</span>
<a href="#l3.538"></a><span id="l3.538" class="difflineplus">+  icalt.is_date = 1;</span>
<a href="#l3.539"></a><span id="l3.539"> </span>
<a href="#l3.540"></a><span id="l3.540" class="difflineminus">-    calDateTime * const cdt = new calDateTime(&amp;icalt, mTimezone);</span>
<a href="#l3.541"></a><span id="l3.541" class="difflineminus">-    CAL_ENSURE_MEMORY(cdt);</span>
<a href="#l3.542"></a><span id="l3.542" class="difflineminus">-    NS_ADDREF(*aResult = cdt);</span>
<a href="#l3.543"></a><span id="l3.543" class="difflineminus">-    return NS_OK;</span>
<a href="#l3.544"></a><span id="l3.544" class="difflineplus">+  calDateTime *const cdt = new calDateTime(&amp;icalt, mTimezone);</span>
<a href="#l3.545"></a><span id="l3.545" class="difflineplus">+  CAL_ENSURE_MEMORY(cdt);</span>
<a href="#l3.546"></a><span id="l3.546" class="difflineplus">+  NS_ADDREF(*aResult = cdt);</span>
<a href="#l3.547"></a><span id="l3.547" class="difflineplus">+  return NS_OK;</span>
<a href="#l3.548"></a><span id="l3.548"> }</span>
<a href="#l3.549"></a><span id="l3.549"> </span>
<a href="#l3.550"></a><span id="l3.550"> NS_IMETHODIMP</span>
<a href="#l3.551"></a><span id="l3.551" class="difflineminus">-calDateTime::GetEndOfYear(calIDateTime ** aResult)</span>
<a href="#l3.552"></a><span id="l3.552" class="difflineminus">-{</span>
<a href="#l3.553"></a><span id="l3.553" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l3.554"></a><span id="l3.554" class="difflineminus">-    ensureTimezone();</span>
<a href="#l3.555"></a><span id="l3.555" class="difflineplus">+calDateTime::GetEndOfYear(calIDateTime **aResult) {</span>
<a href="#l3.556"></a><span id="l3.556" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l3.557"></a><span id="l3.557" class="difflineplus">+  ensureTimezone();</span>
<a href="#l3.558"></a><span id="l3.558"> </span>
<a href="#l3.559"></a><span id="l3.559" class="difflineminus">-    icaltimetype icalt;</span>
<a href="#l3.560"></a><span id="l3.560" class="difflineminus">-    ToIcalTime(&amp;icalt);</span>
<a href="#l3.561"></a><span id="l3.561" class="difflineminus">-    icalt.month = 12;</span>
<a href="#l3.562"></a><span id="l3.562" class="difflineminus">-    icalt.day = 31;</span>
<a href="#l3.563"></a><span id="l3.563" class="difflineminus">-    icalt.is_date = 1;</span>
<a href="#l3.564"></a><span id="l3.564" class="difflineplus">+  icaltimetype icalt;</span>
<a href="#l3.565"></a><span id="l3.565" class="difflineplus">+  ToIcalTime(&amp;icalt);</span>
<a href="#l3.566"></a><span id="l3.566" class="difflineplus">+  icalt.month = 12;</span>
<a href="#l3.567"></a><span id="l3.567" class="difflineplus">+  icalt.day = 31;</span>
<a href="#l3.568"></a><span id="l3.568" class="difflineplus">+  icalt.is_date = 1;</span>
<a href="#l3.569"></a><span id="l3.569"> </span>
<a href="#l3.570"></a><span id="l3.570" class="difflineminus">-    calDateTime * const cdt = new calDateTime(&amp;icalt, mTimezone);</span>
<a href="#l3.571"></a><span id="l3.571" class="difflineminus">-    CAL_ENSURE_MEMORY(cdt);</span>
<a href="#l3.572"></a><span id="l3.572" class="difflineminus">-    NS_ADDREF(*aResult = cdt);</span>
<a href="#l3.573"></a><span id="l3.573" class="difflineminus">-    return NS_OK;</span>
<a href="#l3.574"></a><span id="l3.574" class="difflineplus">+  calDateTime *const cdt = new calDateTime(&amp;icalt, mTimezone);</span>
<a href="#l3.575"></a><span id="l3.575" class="difflineplus">+  CAL_ENSURE_MEMORY(cdt);</span>
<a href="#l3.576"></a><span id="l3.576" class="difflineplus">+  NS_ADDREF(*aResult = cdt);</span>
<a href="#l3.577"></a><span id="l3.577" class="difflineplus">+  return NS_OK;</span>
<a href="#l3.578"></a><span id="l3.578"> }</span>
<a href="#l3.579"></a><span id="l3.579"> </span>
<a href="#l3.580"></a><span id="l3.580"> NS_IMETHODIMP</span>
<a href="#l3.581"></a><span id="l3.581" class="difflineminus">-calDateTime::GetIcalString(nsACString&amp; aResult)</span>
<a href="#l3.582"></a><span id="l3.582" class="difflineminus">-{</span>
<a href="#l3.583"></a><span id="l3.583" class="difflineminus">-    icaltimetype t;</span>
<a href="#l3.584"></a><span id="l3.584" class="difflineminus">-    ToIcalTime(&amp;t);</span>
<a href="#l3.585"></a><span id="l3.585" class="difflineplus">+calDateTime::GetIcalString(nsACString &amp;aResult) {</span>
<a href="#l3.586"></a><span id="l3.586" class="difflineplus">+  icaltimetype t;</span>
<a href="#l3.587"></a><span id="l3.587" class="difflineplus">+  ToIcalTime(&amp;t);</span>
<a href="#l3.588"></a><span id="l3.588"> </span>
<a href="#l3.589"></a><span id="l3.589" class="difflineminus">-    // note that ics is owned by libical, so we don't need to free</span>
<a href="#l3.590"></a><span id="l3.590" class="difflineminus">-    char const * const ics = icaltime_as_ical_string(t);</span>
<a href="#l3.591"></a><span id="l3.591" class="difflineminus">-    CAL_ENSURE_MEMORY(ics);</span>
<a href="#l3.592"></a><span id="l3.592" class="difflineminus">-    aResult.Assign(ics);</span>
<a href="#l3.593"></a><span id="l3.593" class="difflineminus">-    return NS_OK;</span>
<a href="#l3.594"></a><span id="l3.594" class="difflineplus">+  // note that ics is owned by libical, so we don't need to free</span>
<a href="#l3.595"></a><span id="l3.595" class="difflineplus">+  char const *const ics = icaltime_as_ical_string(t);</span>
<a href="#l3.596"></a><span id="l3.596" class="difflineplus">+  CAL_ENSURE_MEMORY(ics);</span>
<a href="#l3.597"></a><span id="l3.597" class="difflineplus">+  aResult.Assign(ics);</span>
<a href="#l3.598"></a><span id="l3.598" class="difflineplus">+  return NS_OK;</span>
<a href="#l3.599"></a><span id="l3.599"> }</span>
<a href="#l3.600"></a><span id="l3.600"> </span>
<a href="#l3.601"></a><span id="l3.601"> NS_IMETHODIMP</span>
<a href="#l3.602"></a><span id="l3.602" class="difflineminus">-calDateTime::SetIcalString(nsACString const&amp; aIcalString)</span>
<a href="#l3.603"></a><span id="l3.603" class="difflineminus">-{</span>
<a href="#l3.604"></a><span id="l3.604" class="difflineminus">-    NS_ENSURE_FALSE(mImmutable, NS_ERROR_OBJECT_IS_IMMUTABLE);</span>
<a href="#l3.605"></a><span id="l3.605" class="difflineminus">-    icaltimetype icalt;</span>
<a href="#l3.606"></a><span id="l3.606" class="difflineminus">-    icalt = icaltime_from_string(PromiseFlatCString(aIcalString).get());</span>
<a href="#l3.607"></a><span id="l3.607" class="difflineminus">-    if (icaltime_is_null_time(icalt)) {</span>
<a href="#l3.608"></a><span id="l3.608" class="difflineminus">-        return static_cast&lt;nsresult&gt;(calIErrors::ICS_ERROR_BASE + icalerrno);</span>
<a href="#l3.609"></a><span id="l3.609" class="difflineminus">-    }</span>
<a href="#l3.610"></a><span id="l3.610" class="difflineminus">-    FromIcalTime(&amp;icalt, nullptr);</span>
<a href="#l3.611"></a><span id="l3.611" class="difflineminus">-    return NS_OK;</span>
<a href="#l3.612"></a><span id="l3.612" class="difflineplus">+calDateTime::SetIcalString(nsACString const &amp;aIcalString) {</span>
<a href="#l3.613"></a><span id="l3.613" class="difflineplus">+  NS_ENSURE_FALSE(mImmutable, NS_ERROR_OBJECT_IS_IMMUTABLE);</span>
<a href="#l3.614"></a><span id="l3.614" class="difflineplus">+  icaltimetype icalt;</span>
<a href="#l3.615"></a><span id="l3.615" class="difflineplus">+  icalt = icaltime_from_string(PromiseFlatCString(aIcalString).get());</span>
<a href="#l3.616"></a><span id="l3.616" class="difflineplus">+  if (icaltime_is_null_time(icalt)) {</span>
<a href="#l3.617"></a><span id="l3.617" class="difflineplus">+    return static_cast&lt;nsresult&gt;(calIErrors::ICS_ERROR_BASE + icalerrno);</span>
<a href="#l3.618"></a><span id="l3.618" class="difflineplus">+  }</span>
<a href="#l3.619"></a><span id="l3.619" class="difflineplus">+  FromIcalTime(&amp;icalt, nullptr);</span>
<a href="#l3.620"></a><span id="l3.620" class="difflineplus">+  return NS_OK;</span>
<a href="#l3.621"></a><span id="l3.621"> }</span>
<a href="#l3.622"></a><span id="l3.622"> </span>
<a href="#l3.623"></a><span id="l3.623"> /**</span>
<a href="#l3.624"></a><span id="l3.624">  ** utility/protected methods</span>
<a href="#l3.625"></a><span id="l3.625">  **/</span>
<a href="#l3.626"></a><span id="l3.626"> </span>
<a href="#l3.627"></a><span id="l3.627"> // internal Normalize():</span>
<a href="#l3.628"></a><span id="l3.628" class="difflineminus">-void calDateTime::Normalize()</span>
<a href="#l3.629"></a><span id="l3.629" class="difflineminus">-{</span>
<a href="#l3.630"></a><span id="l3.630" class="difflineminus">-    icaltimetype icalt;</span>
<a href="#l3.631"></a><span id="l3.631" class="difflineplus">+void calDateTime::Normalize() {</span>
<a href="#l3.632"></a><span id="l3.632" class="difflineplus">+  icaltimetype icalt;</span>
<a href="#l3.633"></a><span id="l3.633"> </span>
<a href="#l3.634"></a><span id="l3.634" class="difflineminus">-    ensureTimezone();</span>
<a href="#l3.635"></a><span id="l3.635" class="difflineminus">-    ToIcalTime(&amp;icalt);</span>
<a href="#l3.636"></a><span id="l3.636" class="difflineminus">-    FromIcalTime(&amp;icalt, mTimezone);</span>
<a href="#l3.637"></a><span id="l3.637" class="difflineplus">+  ensureTimezone();</span>
<a href="#l3.638"></a><span id="l3.638" class="difflineplus">+  ToIcalTime(&amp;icalt);</span>
<a href="#l3.639"></a><span id="l3.639" class="difflineplus">+  FromIcalTime(&amp;icalt, mTimezone);</span>
<a href="#l3.640"></a><span id="l3.640"> }</span>
<a href="#l3.641"></a><span id="l3.641"> </span>
<a href="#l3.642"></a><span id="l3.642" class="difflineminus">-void</span>
<a href="#l3.643"></a><span id="l3.643" class="difflineminus">-calDateTime::ensureTimezone()</span>
<a href="#l3.644"></a><span id="l3.644" class="difflineminus">-{</span>
<a href="#l3.645"></a><span id="l3.645" class="difflineminus">-    if (mTimezone == nullptr) {</span>
<a href="#l3.646"></a><span id="l3.646" class="difflineminus">-        mTimezone = cal::UTC();</span>
<a href="#l3.647"></a><span id="l3.647" class="difflineminus">-    }</span>
<a href="#l3.648"></a><span id="l3.648" class="difflineplus">+void calDateTime::ensureTimezone() {</span>
<a href="#l3.649"></a><span id="l3.649" class="difflineplus">+  if (mTimezone == nullptr) {</span>
<a href="#l3.650"></a><span id="l3.650" class="difflineplus">+    mTimezone = cal::UTC();</span>
<a href="#l3.651"></a><span id="l3.651" class="difflineplus">+  }</span>
<a href="#l3.652"></a><span id="l3.652"> }</span>
<a href="#l3.653"></a><span id="l3.653"> </span>
<a href="#l3.654"></a><span id="l3.654"> NS_IMETHODIMP_(void)</span>
<a href="#l3.655"></a><span id="l3.655" class="difflineminus">-calDateTime::ToIcalTime(struct icaltimetype * icalt)</span>
<a href="#l3.656"></a><span id="l3.656" class="difflineminus">-{</span>
<a href="#l3.657"></a><span id="l3.657" class="difflineminus">-    ensureTimezone();</span>
<a href="#l3.658"></a><span id="l3.658" class="difflineplus">+calDateTime::ToIcalTime(struct icaltimetype *icalt) {</span>
<a href="#l3.659"></a><span id="l3.659" class="difflineplus">+  ensureTimezone();</span>
<a href="#l3.660"></a><span id="l3.660"> </span>
<a href="#l3.661"></a><span id="l3.661" class="difflineminus">-    icalt-&gt;year = mYear;</span>
<a href="#l3.662"></a><span id="l3.662" class="difflineminus">-    icalt-&gt;month = mMonth + 1;</span>
<a href="#l3.663"></a><span id="l3.663" class="difflineminus">-    icalt-&gt;day = mDay;</span>
<a href="#l3.664"></a><span id="l3.664" class="difflineminus">-    icalt-&gt;hour = mHour;</span>
<a href="#l3.665"></a><span id="l3.665" class="difflineminus">-    icalt-&gt;minute = mMinute;</span>
<a href="#l3.666"></a><span id="l3.666" class="difflineminus">-    icalt-&gt;second = mSecond;</span>
<a href="#l3.667"></a><span id="l3.667" class="difflineplus">+  icalt-&gt;year = mYear;</span>
<a href="#l3.668"></a><span id="l3.668" class="difflineplus">+  icalt-&gt;month = mMonth + 1;</span>
<a href="#l3.669"></a><span id="l3.669" class="difflineplus">+  icalt-&gt;day = mDay;</span>
<a href="#l3.670"></a><span id="l3.670" class="difflineplus">+  icalt-&gt;hour = mHour;</span>
<a href="#l3.671"></a><span id="l3.671" class="difflineplus">+  icalt-&gt;minute = mMinute;</span>
<a href="#l3.672"></a><span id="l3.672" class="difflineplus">+  icalt-&gt;second = mSecond;</span>
<a href="#l3.673"></a><span id="l3.673"> </span>
<a href="#l3.674"></a><span id="l3.674" class="difflineminus">-    icalt-&gt;is_date = mIsDate ? 1 : 0;</span>
<a href="#l3.675"></a><span id="l3.675" class="difflineminus">-    icalt-&gt;is_daylight = 0;</span>
<a href="#l3.676"></a><span id="l3.676" class="difflineplus">+  icalt-&gt;is_date = mIsDate ? 1 : 0;</span>
<a href="#l3.677"></a><span id="l3.677" class="difflineplus">+  icalt-&gt;is_daylight = 0;</span>
<a href="#l3.678"></a><span id="l3.678"> </span>
<a href="#l3.679"></a><span id="l3.679" class="difflineminus">-    icaltimezone * tz = cal::getIcalTimezone(mTimezone);</span>
<a href="#l3.680"></a><span id="l3.680" class="difflineminus">-    icalt-&gt;zone = tz;</span>
<a href="#l3.681"></a><span id="l3.681" class="difflineminus">-    icalt-&gt;is_utc = (tz &amp;&amp; tz == icaltimezone_get_utc_timezone());</span>
<a href="#l3.682"></a><span id="l3.682" class="difflineminus">-    icalt-&gt;is_daylight = 0;</span>
<a href="#l3.683"></a><span id="l3.683" class="difflineminus">-    // xxx todo: discuss/investigate is_daylight</span>
<a href="#l3.684"></a><span id="l3.684" class="difflineminus">-//     if (tz) {</span>
<a href="#l3.685"></a><span id="l3.685" class="difflineminus">-//         icaltimezone_get_utc_offset(tz, icalt, &amp;icalt-&gt;is_daylight);</span>
<a href="#l3.686"></a><span id="l3.686" class="difflineminus">-//     }</span>
<a href="#l3.687"></a><span id="l3.687" class="difflineplus">+  icaltimezone *tz = cal::getIcalTimezone(mTimezone);</span>
<a href="#l3.688"></a><span id="l3.688" class="difflineplus">+  icalt-&gt;zone = tz;</span>
<a href="#l3.689"></a><span id="l3.689" class="difflineplus">+  icalt-&gt;is_utc = (tz &amp;&amp; tz == icaltimezone_get_utc_timezone());</span>
<a href="#l3.690"></a><span id="l3.690" class="difflineplus">+  icalt-&gt;is_daylight = 0;</span>
<a href="#l3.691"></a><span id="l3.691" class="difflineplus">+  // xxx todo: discuss/investigate is_daylight</span>
<a href="#l3.692"></a><span id="l3.692" class="difflineplus">+  //     if (tz) {</span>
<a href="#l3.693"></a><span id="l3.693" class="difflineplus">+  //         icaltimezone_get_utc_offset(tz, icalt, &amp;icalt-&gt;is_daylight);</span>
<a href="#l3.694"></a><span id="l3.694" class="difflineplus">+  //     }</span>
<a href="#l3.695"></a><span id="l3.695"> }</span>
<a href="#l3.696"></a><span id="l3.696"> </span>
<a href="#l3.697"></a><span id="l3.697" class="difflineminus">-void calDateTime::FromIcalTime(icaltimetype const* icalt, calITimezone * tz)</span>
<a href="#l3.698"></a><span id="l3.698" class="difflineminus">-{</span>
<a href="#l3.699"></a><span id="l3.699" class="difflineminus">-    icaltimetype t = *icalt;</span>
<a href="#l3.700"></a><span id="l3.700" class="difflineminus">-    mIsValid = (icaltime_is_null_time(t) ||</span>
<a href="#l3.701"></a><span id="l3.701" class="difflineminus">-                icaltime_is_valid_time(t) ? true : false);</span>
<a href="#l3.702"></a><span id="l3.702" class="difflineplus">+void calDateTime::FromIcalTime(icaltimetype const *icalt, calITimezone *tz) {</span>
<a href="#l3.703"></a><span id="l3.703" class="difflineplus">+  icaltimetype t = *icalt;</span>
<a href="#l3.704"></a><span id="l3.704" class="difflineplus">+  mIsValid =</span>
<a href="#l3.705"></a><span id="l3.705" class="difflineplus">+      (icaltime_is_null_time(t) || icaltime_is_valid_time(t) ? true : false);</span>
<a href="#l3.706"></a><span id="l3.706"> </span>
<a href="#l3.707"></a><span id="l3.707" class="difflineminus">-    mIsDate = t.is_date ? true : false;</span>
<a href="#l3.708"></a><span id="l3.708" class="difflineminus">-    if (mIsDate) {</span>
<a href="#l3.709"></a><span id="l3.709" class="difflineminus">-        t.hour = 0;</span>
<a href="#l3.710"></a><span id="l3.710" class="difflineminus">-        t.minute = 0;</span>
<a href="#l3.711"></a><span id="l3.711" class="difflineminus">-        t.second = 0;</span>
<a href="#l3.712"></a><span id="l3.712" class="difflineminus">-    }</span>
<a href="#l3.713"></a><span id="l3.713" class="difflineplus">+  mIsDate = t.is_date ? true : false;</span>
<a href="#l3.714"></a><span id="l3.714" class="difflineplus">+  if (mIsDate) {</span>
<a href="#l3.715"></a><span id="l3.715" class="difflineplus">+    t.hour = 0;</span>
<a href="#l3.716"></a><span id="l3.716" class="difflineplus">+    t.minute = 0;</span>
<a href="#l3.717"></a><span id="l3.717" class="difflineplus">+    t.second = 0;</span>
<a href="#l3.718"></a><span id="l3.718" class="difflineplus">+  }</span>
<a href="#l3.719"></a><span id="l3.719"> </span>
<a href="#l3.720"></a><span id="l3.720" class="difflineminus">-    if (mIsValid) {</span>
<a href="#l3.721"></a><span id="l3.721" class="difflineminus">-        t = icaltime_normalize(t);</span>
<a href="#l3.722"></a><span id="l3.722" class="difflineminus">-    }</span>
<a href="#l3.723"></a><span id="l3.723" class="difflineplus">+  if (mIsValid) {</span>
<a href="#l3.724"></a><span id="l3.724" class="difflineplus">+    t = icaltime_normalize(t);</span>
<a href="#l3.725"></a><span id="l3.725" class="difflineplus">+  }</span>
<a href="#l3.726"></a><span id="l3.726"> </span>
<a href="#l3.727"></a><span id="l3.727" class="difflineminus">-    mYear = static_cast&lt;int16_t&gt;(t.year);</span>
<a href="#l3.728"></a><span id="l3.728" class="difflineminus">-    mMonth = static_cast&lt;int16_t&gt;(t.month - 1);</span>
<a href="#l3.729"></a><span id="l3.729" class="difflineminus">-    mDay = static_cast&lt;int16_t&gt;(t.day);</span>
<a href="#l3.730"></a><span id="l3.730" class="difflineminus">-    mHour = static_cast&lt;int16_t&gt;(t.hour);</span>
<a href="#l3.731"></a><span id="l3.731" class="difflineminus">-    mMinute = static_cast&lt;int16_t&gt;(t.minute);</span>
<a href="#l3.732"></a><span id="l3.732" class="difflineminus">-    mSecond = static_cast&lt;int16_t&gt;(t.second);</span>
<a href="#l3.733"></a><span id="l3.733" class="difflineplus">+  mYear = static_cast&lt;int16_t&gt;(t.year);</span>
<a href="#l3.734"></a><span id="l3.734" class="difflineplus">+  mMonth = static_cast&lt;int16_t&gt;(t.month - 1);</span>
<a href="#l3.735"></a><span id="l3.735" class="difflineplus">+  mDay = static_cast&lt;int16_t&gt;(t.day);</span>
<a href="#l3.736"></a><span id="l3.736" class="difflineplus">+  mHour = static_cast&lt;int16_t&gt;(t.hour);</span>
<a href="#l3.737"></a><span id="l3.737" class="difflineplus">+  mMinute = static_cast&lt;int16_t&gt;(t.minute);</span>
<a href="#l3.738"></a><span id="l3.738" class="difflineplus">+  mSecond = static_cast&lt;int16_t&gt;(t.second);</span>
<a href="#l3.739"></a><span id="l3.739"> </span>
<a href="#l3.740"></a><span id="l3.740" class="difflineminus">-    if (tz) {</span>
<a href="#l3.741"></a><span id="l3.741" class="difflineminus">-        mTimezone = tz;</span>
<a href="#l3.742"></a><span id="l3.742" class="difflineminus">-    } else {</span>
<a href="#l3.743"></a><span id="l3.743" class="difflineminus">-        mTimezone = cal::detectTimezone(t, nullptr);</span>
<a href="#l3.744"></a><span id="l3.744" class="difflineminus">-    }</span>
<a href="#l3.745"></a><span id="l3.745" class="difflineplus">+  if (tz) {</span>
<a href="#l3.746"></a><span id="l3.746" class="difflineplus">+    mTimezone = tz;</span>
<a href="#l3.747"></a><span id="l3.747" class="difflineplus">+  } else {</span>
<a href="#l3.748"></a><span id="l3.748" class="difflineplus">+    mTimezone = cal::detectTimezone(t, nullptr);</span>
<a href="#l3.749"></a><span id="l3.749" class="difflineplus">+  }</span>
<a href="#l3.750"></a><span id="l3.750"> #if defined(DEBUG)</span>
<a href="#l3.751"></a><span id="l3.751" class="difflineminus">-    if (mTimezone) {</span>
<a href="#l3.752"></a><span id="l3.752" class="difflineminus">-        if (t.is_utc) {</span>
<a href="#l3.753"></a><span id="l3.753" class="difflineminus">-            nsCOMPtr&lt;calITimezone&gt; ctz = cal::UTC();</span>
<a href="#l3.754"></a><span id="l3.754" class="difflineminus">-            NS_ASSERTION(SameCOMIdentity(mTimezone, ctz), &quot;UTC mismatch!&quot;);</span>
<a href="#l3.755"></a><span id="l3.755" class="difflineminus">-        } else if (!t.zone) {</span>
<a href="#l3.756"></a><span id="l3.756" class="difflineminus">-            nsAutoCString tzid;</span>
<a href="#l3.757"></a><span id="l3.757" class="difflineminus">-            mTimezone-&gt;GetTzid(tzid);</span>
<a href="#l3.758"></a><span id="l3.758" class="difflineminus">-            if (tzid.EqualsLiteral(&quot;floating&quot;)) {</span>
<a href="#l3.759"></a><span id="l3.759" class="difflineminus">-                nsCOMPtr&lt;calITimezone&gt; ctz = cal::floating();</span>
<a href="#l3.760"></a><span id="l3.760" class="difflineminus">-                NS_ASSERTION(SameCOMIdentity(mTimezone, ctz), &quot;floating mismatch!&quot;);</span>
<a href="#l3.761"></a><span id="l3.761" class="difflineminus">-            }</span>
<a href="#l3.762"></a><span id="l3.762" class="difflineminus">-        } else {</span>
<a href="#l3.763"></a><span id="l3.763" class="difflineminus">-            nsAutoCString tzid;</span>
<a href="#l3.764"></a><span id="l3.764" class="difflineminus">-            mTimezone-&gt;GetTzid(tzid);</span>
<a href="#l3.765"></a><span id="l3.765" class="difflineminus">-            NS_ASSERTION(tzid.Equals(icaltimezone_get_tzid(const_cast&lt;icaltimezone *&gt;(t.zone))),</span>
<a href="#l3.766"></a><span id="l3.766" class="difflineminus">-                         &quot;tzid mismatch!&quot;);</span>
<a href="#l3.767"></a><span id="l3.767" class="difflineminus">-        }</span>
<a href="#l3.768"></a><span id="l3.768" class="difflineplus">+  if (mTimezone) {</span>
<a href="#l3.769"></a><span id="l3.769" class="difflineplus">+    if (t.is_utc) {</span>
<a href="#l3.770"></a><span id="l3.770" class="difflineplus">+      nsCOMPtr&lt;calITimezone&gt; ctz = cal::UTC();</span>
<a href="#l3.771"></a><span id="l3.771" class="difflineplus">+      NS_ASSERTION(SameCOMIdentity(mTimezone, ctz), &quot;UTC mismatch!&quot;);</span>
<a href="#l3.772"></a><span id="l3.772" class="difflineplus">+    } else if (!t.zone) {</span>
<a href="#l3.773"></a><span id="l3.773" class="difflineplus">+      nsAutoCString tzid;</span>
<a href="#l3.774"></a><span id="l3.774" class="difflineplus">+      mTimezone-&gt;GetTzid(tzid);</span>
<a href="#l3.775"></a><span id="l3.775" class="difflineplus">+      if (tzid.EqualsLiteral(&quot;floating&quot;)) {</span>
<a href="#l3.776"></a><span id="l3.776" class="difflineplus">+        nsCOMPtr&lt;calITimezone&gt; ctz = cal::floating();</span>
<a href="#l3.777"></a><span id="l3.777" class="difflineplus">+        NS_ASSERTION(SameCOMIdentity(mTimezone, ctz), &quot;floating mismatch!&quot;);</span>
<a href="#l3.778"></a><span id="l3.778" class="difflineplus">+      }</span>
<a href="#l3.779"></a><span id="l3.779" class="difflineplus">+    } else {</span>
<a href="#l3.780"></a><span id="l3.780" class="difflineplus">+      nsAutoCString tzid;</span>
<a href="#l3.781"></a><span id="l3.781" class="difflineplus">+      mTimezone-&gt;GetTzid(tzid);</span>
<a href="#l3.782"></a><span id="l3.782" class="difflineplus">+      NS_ASSERTION(tzid.Equals(icaltimezone_get_tzid(</span>
<a href="#l3.783"></a><span id="l3.783" class="difflineplus">+                       const_cast&lt;icaltimezone *&gt;(t.zone))),</span>
<a href="#l3.784"></a><span id="l3.784" class="difflineplus">+                   &quot;tzid mismatch!&quot;);</span>
<a href="#l3.785"></a><span id="l3.785">     }</span>
<a href="#l3.786"></a><span id="l3.786" class="difflineplus">+  }</span>
<a href="#l3.787"></a><span id="l3.787"> #endif</span>
<a href="#l3.788"></a><span id="l3.788"> </span>
<a href="#l3.789"></a><span id="l3.789" class="difflineminus">-    mWeekday = static_cast&lt;int16_t&gt;(icaltime_day_of_week(t) - 1);</span>
<a href="#l3.790"></a><span id="l3.790" class="difflineminus">-    mYearday = static_cast&lt;int16_t&gt;(icaltime_day_of_year(t));</span>
<a href="#l3.791"></a><span id="l3.791" class="difflineplus">+  mWeekday = static_cast&lt;int16_t&gt;(icaltime_day_of_week(t) - 1);</span>
<a href="#l3.792"></a><span id="l3.792" class="difflineplus">+  mYearday = static_cast&lt;int16_t&gt;(icaltime_day_of_year(t));</span>
<a href="#l3.793"></a><span id="l3.793"> </span>
<a href="#l3.794"></a><span id="l3.794" class="difflineminus">-    // mNativeTime: not moving the existing date to UTC,</span>
<a href="#l3.795"></a><span id="l3.795" class="difflineminus">-    // but merely representing it a UTC-based way.</span>
<a href="#l3.796"></a><span id="l3.796" class="difflineminus">-    t.is_date = 0;</span>
<a href="#l3.797"></a><span id="l3.797" class="difflineminus">-    mNativeTime = IcaltimeToPRTime(&amp;t, icaltimezone_get_utc_timezone());</span>
<a href="#l3.798"></a><span id="l3.798" class="difflineplus">+  // mNativeTime: not moving the existing date to UTC,</span>
<a href="#l3.799"></a><span id="l3.799" class="difflineplus">+  // but merely representing it a UTC-based way.</span>
<a href="#l3.800"></a><span id="l3.800" class="difflineplus">+  t.is_date = 0;</span>
<a href="#l3.801"></a><span id="l3.801" class="difflineplus">+  mNativeTime = IcaltimeToPRTime(&amp;t, icaltimezone_get_utc_timezone());</span>
<a href="#l3.802"></a><span id="l3.802"> }</span>
<a href="#l3.803"></a><span id="l3.803"> </span>
<a href="#l3.804"></a><span id="l3.804" class="difflineminus">-PRTime calDateTime::IcaltimeToPRTime(icaltimetype const* icalt, icaltimezone const* tz)</span>
<a href="#l3.805"></a><span id="l3.805" class="difflineminus">-{</span>
<a href="#l3.806"></a><span id="l3.806" class="difflineminus">-    icaltimetype tt;</span>
<a href="#l3.807"></a><span id="l3.807" class="difflineminus">-    PRExplodedTime et;</span>
<a href="#l3.808"></a><span id="l3.808" class="difflineplus">+PRTime calDateTime::IcaltimeToPRTime(icaltimetype const *icalt,</span>
<a href="#l3.809"></a><span id="l3.809" class="difflineplus">+                                     icaltimezone const *tz) {</span>
<a href="#l3.810"></a><span id="l3.810" class="difflineplus">+  icaltimetype tt;</span>
<a href="#l3.811"></a><span id="l3.811" class="difflineplus">+  PRExplodedTime et;</span>
<a href="#l3.812"></a><span id="l3.812"> </span>
<a href="#l3.813"></a><span id="l3.813" class="difflineminus">-    /* If the time is the special null time, return 0. */</span>
<a href="#l3.814"></a><span id="l3.814" class="difflineminus">-    if (icaltime_is_null_time(*icalt)) {</span>
<a href="#l3.815"></a><span id="l3.815" class="difflineminus">-        return 0;</span>
<a href="#l3.816"></a><span id="l3.816" class="difflineminus">-    }</span>
<a href="#l3.817"></a><span id="l3.817" class="difflineplus">+  /* If the time is the special null time, return 0. */</span>
<a href="#l3.818"></a><span id="l3.818" class="difflineplus">+  if (icaltime_is_null_time(*icalt)) {</span>
<a href="#l3.819"></a><span id="l3.819" class="difflineplus">+    return 0;</span>
<a href="#l3.820"></a><span id="l3.820" class="difflineplus">+  }</span>
<a href="#l3.821"></a><span id="l3.821"> </span>
<a href="#l3.822"></a><span id="l3.822" class="difflineminus">-    if (tz) {</span>
<a href="#l3.823"></a><span id="l3.823" class="difflineminus">-        // use libical for timezone conversion, as it can handle all ics</span>
<a href="#l3.824"></a><span id="l3.824" class="difflineminus">-        // timezones. having nspr do it is much harder.</span>
<a href="#l3.825"></a><span id="l3.825" class="difflineminus">-        tt = icaltime_convert_to_zone(*icalt, const_cast&lt;icaltimezone *&gt;(tz));</span>
<a href="#l3.826"></a><span id="l3.826" class="difflineminus">-    } else {</span>
<a href="#l3.827"></a><span id="l3.827" class="difflineminus">-        tt = *icalt;</span>
<a href="#l3.828"></a><span id="l3.828" class="difflineminus">-    }</span>
<a href="#l3.829"></a><span id="l3.829" class="difflineplus">+  if (tz) {</span>
<a href="#l3.830"></a><span id="l3.830" class="difflineplus">+    // use libical for timezone conversion, as it can handle all ics</span>
<a href="#l3.831"></a><span id="l3.831" class="difflineplus">+    // timezones. having nspr do it is much harder.</span>
<a href="#l3.832"></a><span id="l3.832" class="difflineplus">+    tt = icaltime_convert_to_zone(*icalt, const_cast&lt;icaltimezone *&gt;(tz));</span>
<a href="#l3.833"></a><span id="l3.833" class="difflineplus">+  } else {</span>
<a href="#l3.834"></a><span id="l3.834" class="difflineplus">+    tt = *icalt;</span>
<a href="#l3.835"></a><span id="l3.835" class="difflineplus">+  }</span>
<a href="#l3.836"></a><span id="l3.836"> </span>
<a href="#l3.837"></a><span id="l3.837" class="difflineminus">-    /* Empty the destination */</span>
<a href="#l3.838"></a><span id="l3.838" class="difflineminus">-    memset(&amp;et, 0, sizeof(struct PRExplodedTime));</span>
<a href="#l3.839"></a><span id="l3.839" class="difflineplus">+  /* Empty the destination */</span>
<a href="#l3.840"></a><span id="l3.840" class="difflineplus">+  memset(&amp;et, 0, sizeof(struct PRExplodedTime));</span>
<a href="#l3.841"></a><span id="l3.841"> </span>
<a href="#l3.842"></a><span id="l3.842" class="difflineminus">-    /* Fill the fields */</span>
<a href="#l3.843"></a><span id="l3.843" class="difflineminus">-    if (icaltime_is_date(tt)) {</span>
<a href="#l3.844"></a><span id="l3.844" class="difflineminus">-        et.tm_sec = et.tm_min = et.tm_hour = 0;</span>
<a href="#l3.845"></a><span id="l3.845" class="difflineminus">-    } else {</span>
<a href="#l3.846"></a><span id="l3.846" class="difflineminus">-        et.tm_sec = tt.second;</span>
<a href="#l3.847"></a><span id="l3.847" class="difflineminus">-        et.tm_min = tt.minute;</span>
<a href="#l3.848"></a><span id="l3.848" class="difflineminus">-        et.tm_hour = tt.hour;</span>
<a href="#l3.849"></a><span id="l3.849" class="difflineminus">-    }</span>
<a href="#l3.850"></a><span id="l3.850" class="difflineminus">-    et.tm_mday = static_cast&lt;int16_t&gt;(tt.day);</span>
<a href="#l3.851"></a><span id="l3.851" class="difflineminus">-    et.tm_month = static_cast&lt;int16_t&gt;(tt.month-1);</span>
<a href="#l3.852"></a><span id="l3.852" class="difflineminus">-    et.tm_year = static_cast&lt;int16_t&gt;(tt.year);</span>
<a href="#l3.853"></a><span id="l3.853" class="difflineplus">+  /* Fill the fields */</span>
<a href="#l3.854"></a><span id="l3.854" class="difflineplus">+  if (icaltime_is_date(tt)) {</span>
<a href="#l3.855"></a><span id="l3.855" class="difflineplus">+    et.tm_sec = et.tm_min = et.tm_hour = 0;</span>
<a href="#l3.856"></a><span id="l3.856" class="difflineplus">+  } else {</span>
<a href="#l3.857"></a><span id="l3.857" class="difflineplus">+    et.tm_sec = tt.second;</span>
<a href="#l3.858"></a><span id="l3.858" class="difflineplus">+    et.tm_min = tt.minute;</span>
<a href="#l3.859"></a><span id="l3.859" class="difflineplus">+    et.tm_hour = tt.hour;</span>
<a href="#l3.860"></a><span id="l3.860" class="difflineplus">+  }</span>
<a href="#l3.861"></a><span id="l3.861" class="difflineplus">+  et.tm_mday = static_cast&lt;int16_t&gt;(tt.day);</span>
<a href="#l3.862"></a><span id="l3.862" class="difflineplus">+  et.tm_month = static_cast&lt;int16_t&gt;(tt.month - 1);</span>
<a href="#l3.863"></a><span id="l3.863" class="difflineplus">+  et.tm_year = static_cast&lt;int16_t&gt;(tt.year);</span>
<a href="#l3.864"></a><span id="l3.864"> </span>
<a href="#l3.865"></a><span id="l3.865" class="difflineminus">-    return PR_ImplodeTime(&amp;et);</span>
<a href="#l3.866"></a><span id="l3.866" class="difflineplus">+  return PR_ImplodeTime(&amp;et);</span>
<a href="#l3.867"></a><span id="l3.867"> }</span>
<a href="#l3.868"></a><span id="l3.868"> </span>
<a href="#l3.869"></a><span id="l3.869"> void calDateTime::PRTimeToIcaltime(PRTime time, bool isdate,</span>
<a href="#l3.870"></a><span id="l3.870" class="difflineminus">-                                   icaltimezone const* tz,</span>
<a href="#l3.871"></a><span id="l3.871" class="difflineminus">-                                   icaltimetype * icalt)</span>
<a href="#l3.872"></a><span id="l3.872" class="difflineminus">-{</span>
<a href="#l3.873"></a><span id="l3.873" class="difflineminus">-    PRExplodedTime et;</span>
<a href="#l3.874"></a><span id="l3.874" class="difflineminus">-    PR_ExplodeTime(time, PR_GMTParameters, &amp;et);</span>
<a href="#l3.875"></a><span id="l3.875" class="difflineplus">+                                   icaltimezone const *tz,</span>
<a href="#l3.876"></a><span id="l3.876" class="difflineplus">+                                   icaltimetype *icalt) {</span>
<a href="#l3.877"></a><span id="l3.877" class="difflineplus">+  PRExplodedTime et;</span>
<a href="#l3.878"></a><span id="l3.878" class="difflineplus">+  PR_ExplodeTime(time, PR_GMTParameters, &amp;et);</span>
<a href="#l3.879"></a><span id="l3.879"> </span>
<a href="#l3.880"></a><span id="l3.880" class="difflineminus">-    icalt-&gt;year   = et.tm_year;</span>
<a href="#l3.881"></a><span id="l3.881" class="difflineminus">-    icalt-&gt;month  = et.tm_month + 1;</span>
<a href="#l3.882"></a><span id="l3.882" class="difflineminus">-    icalt-&gt;day    = et.tm_mday;</span>
<a href="#l3.883"></a><span id="l3.883" class="difflineplus">+  icalt-&gt;year = et.tm_year;</span>
<a href="#l3.884"></a><span id="l3.884" class="difflineplus">+  icalt-&gt;month = et.tm_month + 1;</span>
<a href="#l3.885"></a><span id="l3.885" class="difflineplus">+  icalt-&gt;day = et.tm_mday;</span>
<a href="#l3.886"></a><span id="l3.886"> </span>
<a href="#l3.887"></a><span id="l3.887" class="difflineminus">-    if (isdate) {</span>
<a href="#l3.888"></a><span id="l3.888" class="difflineminus">-        icalt-&gt;hour    = 0;</span>
<a href="#l3.889"></a><span id="l3.889" class="difflineminus">-        icalt-&gt;minute  = 0;</span>
<a href="#l3.890"></a><span id="l3.890" class="difflineminus">-        icalt-&gt;second  = 0;</span>
<a href="#l3.891"></a><span id="l3.891" class="difflineminus">-        icalt-&gt;is_date = 1;</span>
<a href="#l3.892"></a><span id="l3.892" class="difflineminus">-    } else {</span>
<a href="#l3.893"></a><span id="l3.893" class="difflineminus">-        icalt-&gt;hour   = et.tm_hour;</span>
<a href="#l3.894"></a><span id="l3.894" class="difflineminus">-        icalt-&gt;minute = et.tm_min;</span>
<a href="#l3.895"></a><span id="l3.895" class="difflineminus">-        icalt-&gt;second = et.tm_sec;</span>
<a href="#l3.896"></a><span id="l3.896" class="difflineminus">-        icalt-&gt;is_date = 0;</span>
<a href="#l3.897"></a><span id="l3.897" class="difflineminus">-    }</span>
<a href="#l3.898"></a><span id="l3.898" class="difflineplus">+  if (isdate) {</span>
<a href="#l3.899"></a><span id="l3.899" class="difflineplus">+    icalt-&gt;hour = 0;</span>
<a href="#l3.900"></a><span id="l3.900" class="difflineplus">+    icalt-&gt;minute = 0;</span>
<a href="#l3.901"></a><span id="l3.901" class="difflineplus">+    icalt-&gt;second = 0;</span>
<a href="#l3.902"></a><span id="l3.902" class="difflineplus">+    icalt-&gt;is_date = 1;</span>
<a href="#l3.903"></a><span id="l3.903" class="difflineplus">+  } else {</span>
<a href="#l3.904"></a><span id="l3.904" class="difflineplus">+    icalt-&gt;hour = et.tm_hour;</span>
<a href="#l3.905"></a><span id="l3.905" class="difflineplus">+    icalt-&gt;minute = et.tm_min;</span>
<a href="#l3.906"></a><span id="l3.906" class="difflineplus">+    icalt-&gt;second = et.tm_sec;</span>
<a href="#l3.907"></a><span id="l3.907" class="difflineplus">+    icalt-&gt;is_date = 0;</span>
<a href="#l3.908"></a><span id="l3.908" class="difflineplus">+  }</span>
<a href="#l3.909"></a><span id="l3.909"> </span>
<a href="#l3.910"></a><span id="l3.910" class="difflineminus">-    icalt-&gt;zone = tz;</span>
<a href="#l3.911"></a><span id="l3.911" class="difflineminus">-    icalt-&gt;is_utc = ((tz &amp;&amp; tz == icaltimezone_get_utc_timezone()) ? 1 : 0);</span>
<a href="#l3.912"></a><span id="l3.912" class="difflineminus">-    icalt-&gt;is_daylight = 0;</span>
<a href="#l3.913"></a><span id="l3.913" class="difflineminus">-    // xxx todo: discuss/investigate is_daylight</span>
<a href="#l3.914"></a><span id="l3.914" class="difflineminus">-//     if (tz) {</span>
<a href="#l3.915"></a><span id="l3.915" class="difflineminus">-//         icaltimezone_get_utc_offset(tz, icalt, &amp;icalt-&gt;is_daylight);</span>
<a href="#l3.916"></a><span id="l3.916" class="difflineminus">-//     }</span>
<a href="#l3.917"></a><span id="l3.917" class="difflineplus">+  icalt-&gt;zone = tz;</span>
<a href="#l3.918"></a><span id="l3.918" class="difflineplus">+  icalt-&gt;is_utc = ((tz &amp;&amp; tz == icaltimezone_get_utc_timezone()) ? 1 : 0);</span>
<a href="#l3.919"></a><span id="l3.919" class="difflineplus">+  icalt-&gt;is_daylight = 0;</span>
<a href="#l3.920"></a><span id="l3.920" class="difflineplus">+  // xxx todo: discuss/investigate is_daylight</span>
<a href="#l3.921"></a><span id="l3.921" class="difflineplus">+  //     if (tz) {</span>
<a href="#l3.922"></a><span id="l3.922" class="difflineplus">+  //         icaltimezone_get_utc_offset(tz, icalt, &amp;icalt-&gt;is_daylight);</span>
<a href="#l3.923"></a><span id="l3.923" class="difflineplus">+  //     }</span>
<a href="#l3.924"></a><span id="l3.924"> }</span>
<a href="#l3.925"></a><span id="l3.925"> </span>
<a href="#l3.926"></a><span id="l3.926"> NS_IMETHODIMP</span>
<a href="#l3.927"></a><span id="l3.927" class="difflineminus">-calDateTime::Compare(calIDateTime * aOther, int32_t * aResult)</span>
<a href="#l3.928"></a><span id="l3.928" class="difflineminus">-{</span>
<a href="#l3.929"></a><span id="l3.929" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aOther);</span>
<a href="#l3.930"></a><span id="l3.930" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l3.931"></a><span id="l3.931" class="difflineplus">+calDateTime::Compare(calIDateTime *aOther, int32_t *aResult) {</span>
<a href="#l3.932"></a><span id="l3.932" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aOther);</span>
<a href="#l3.933"></a><span id="l3.933" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l3.934"></a><span id="l3.934"> </span>
<a href="#l3.935"></a><span id="l3.935" class="difflineminus">-    nsresult rv;</span>
<a href="#l3.936"></a><span id="l3.936" class="difflineminus">-    nsCOMPtr&lt;calIDateTimeLibical&gt; icalother = do_QueryInterface(aOther, &amp;rv);</span>
<a href="#l3.937"></a><span id="l3.937" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.938"></a><span id="l3.938" class="difflineplus">+  nsresult rv;</span>
<a href="#l3.939"></a><span id="l3.939" class="difflineplus">+  nsCOMPtr&lt;calIDateTimeLibical&gt; icalother = do_QueryInterface(aOther, &amp;rv);</span>
<a href="#l3.940"></a><span id="l3.940" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.941"></a><span id="l3.941"> </span>
<a href="#l3.942"></a><span id="l3.942" class="difflineminus">-    bool otherIsDate = false;</span>
<a href="#l3.943"></a><span id="l3.943" class="difflineminus">-    aOther-&gt;GetIsDate(&amp;otherIsDate);</span>
<a href="#l3.944"></a><span id="l3.944" class="difflineplus">+  bool otherIsDate = false;</span>
<a href="#l3.945"></a><span id="l3.945" class="difflineplus">+  aOther-&gt;GetIsDate(&amp;otherIsDate);</span>
<a href="#l3.946"></a><span id="l3.946"> </span>
<a href="#l3.947"></a><span id="l3.947" class="difflineminus">-    icaltimetype a, b;</span>
<a href="#l3.948"></a><span id="l3.948" class="difflineminus">-    ToIcalTime(&amp;a);</span>
<a href="#l3.949"></a><span id="l3.949" class="difflineminus">-    icalother-&gt;ToIcalTime(&amp;b);</span>
<a href="#l3.950"></a><span id="l3.950" class="difflineplus">+  icaltimetype a, b;</span>
<a href="#l3.951"></a><span id="l3.951" class="difflineplus">+  ToIcalTime(&amp;a);</span>
<a href="#l3.952"></a><span id="l3.952" class="difflineplus">+  icalother-&gt;ToIcalTime(&amp;b);</span>
<a href="#l3.953"></a><span id="l3.953"> </span>
<a href="#l3.954"></a><span id="l3.954" class="difflineminus">-    // If either this or aOther is floating, both objects are treated</span>
<a href="#l3.955"></a><span id="l3.955" class="difflineminus">-    // as floating for the comparison.</span>
<a href="#l3.956"></a><span id="l3.956" class="difflineminus">-    if (!a.zone || !b.zone) {</span>
<a href="#l3.957"></a><span id="l3.957" class="difflineminus">-        a.zone = nullptr;</span>
<a href="#l3.958"></a><span id="l3.958" class="difflineminus">-        a.is_utc = 0;</span>
<a href="#l3.959"></a><span id="l3.959" class="difflineminus">-        b.zone = nullptr;</span>
<a href="#l3.960"></a><span id="l3.960" class="difflineminus">-        b.is_utc = 0;</span>
<a href="#l3.961"></a><span id="l3.961" class="difflineminus">-    }</span>
<a href="#l3.962"></a><span id="l3.962" class="difflineplus">+  // If either this or aOther is floating, both objects are treated</span>
<a href="#l3.963"></a><span id="l3.963" class="difflineplus">+  // as floating for the comparison.</span>
<a href="#l3.964"></a><span id="l3.964" class="difflineplus">+  if (!a.zone || !b.zone) {</span>
<a href="#l3.965"></a><span id="l3.965" class="difflineplus">+    a.zone = nullptr;</span>
<a href="#l3.966"></a><span id="l3.966" class="difflineplus">+    a.is_utc = 0;</span>
<a href="#l3.967"></a><span id="l3.967" class="difflineplus">+    b.zone = nullptr;</span>
<a href="#l3.968"></a><span id="l3.968" class="difflineplus">+    b.is_utc = 0;</span>
<a href="#l3.969"></a><span id="l3.969" class="difflineplus">+  }</span>
<a href="#l3.970"></a><span id="l3.970"> </span>
<a href="#l3.971"></a><span id="l3.971" class="difflineminus">-    if (mIsDate || otherIsDate) {</span>
<a href="#l3.972"></a><span id="l3.972" class="difflineminus">-        *aResult = icaltime_compare_date_only_tz(a, b, cal::getIcalTimezone(mTimezone));</span>
<a href="#l3.973"></a><span id="l3.973" class="difflineminus">-    } else {</span>
<a href="#l3.974"></a><span id="l3.974" class="difflineminus">-        *aResult = icaltime_compare(a, b);</span>
<a href="#l3.975"></a><span id="l3.975" class="difflineminus">-    }</span>
<a href="#l3.976"></a><span id="l3.976" class="difflineplus">+  if (mIsDate || otherIsDate) {</span>
<a href="#l3.977"></a><span id="l3.977" class="difflineplus">+    *aResult =</span>
<a href="#l3.978"></a><span id="l3.978" class="difflineplus">+        icaltime_compare_date_only_tz(a, b, cal::getIcalTimezone(mTimezone));</span>
<a href="#l3.979"></a><span id="l3.979" class="difflineplus">+  } else {</span>
<a href="#l3.980"></a><span id="l3.980" class="difflineplus">+    *aResult = icaltime_compare(a, b);</span>
<a href="#l3.981"></a><span id="l3.981" class="difflineplus">+  }</span>
<a href="#l3.982"></a><span id="l3.982"> </span>
<a href="#l3.983"></a><span id="l3.983" class="difflineminus">-    return NS_OK;</span>
<a href="#l3.984"></a><span id="l3.984" class="difflineplus">+  return NS_OK;</span>
<a href="#l3.985"></a><span id="l3.985"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/calendar/base/backend/libical/calDateTime.h</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/calendar/base/backend/libical/calDateTime.h</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -1,52 +1,51 @@</span>
<a href="#l4.4"></a><span id="l4.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l4.5"></a><span id="l4.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l4.6"></a><span id="l4.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l4.7"></a><span id="l4.7"> #if !defined(INCLUDED_CALDATETIME_H)</span>
<a href="#l4.8"></a><span id="l4.8" class="difflineminus">-#define INCLUDED_CALDATETIME_H</span>
<a href="#l4.9"></a><span id="l4.9" class="difflineplus">+#  define INCLUDED_CALDATETIME_H</span>
<a href="#l4.10"></a><span id="l4.10"> </span>
<a href="#l4.11"></a><span id="l4.11" class="difflineminus">-#include &quot;calIDateTime.h&quot;</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-#include &quot;calITimezoneProvider.h&quot;</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-#include &quot;calUtils.h&quot;</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+#  include &quot;calIDateTime.h&quot;</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+#  include &quot;calITimezoneProvider.h&quot;</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineplus">+#  include &quot;calUtils.h&quot;</span>
<a href="#l4.17"></a><span id="l4.17"> </span>
<a href="#l4.18"></a><span id="l4.18"> struct icaltimetype;</span>
<a href="#l4.19"></a><span id="l4.19"> typedef struct _icaltimezone icaltimezone;</span>
<a href="#l4.20"></a><span id="l4.20"> </span>
<a href="#l4.21"></a><span id="l4.21" class="difflineminus">-class calDateTime : public calIDateTimeLibical,</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineminus">-                    public cal::XpcomBase</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineminus">-{</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineminus">-public:</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineminus">-    calDateTime();</span>
<a href="#l4.26"></a><span id="l4.26" class="difflineminus">-    calDateTime(icaltimetype const* icalt, calITimezone * tz);</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineplus">+class calDateTime : public calIDateTimeLibical, public cal::XpcomBase {</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineplus">+ public:</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineplus">+  calDateTime();</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineplus">+  calDateTime(icaltimetype const* icalt, calITimezone* tz);</span>
<a href="#l4.31"></a><span id="l4.31"> </span>
<a href="#l4.32"></a><span id="l4.32" class="difflineminus">-    NS_DECL_ISUPPORTS</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineminus">-    NS_DECL_CALIDATETIME</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineminus">-    NS_DECL_CALIDATETIMELIBICAL</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineplus">+  NS_DECL_ISUPPORTS</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineplus">+  NS_DECL_CALIDATETIME</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineplus">+  NS_DECL_CALIDATETIMELIBICAL</span>
<a href="#l4.38"></a><span id="l4.38"> </span>
<a href="#l4.39"></a><span id="l4.39" class="difflineminus">-protected:</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineminus">-    virtual ~calDateTime() {}</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineminus">-    bool mImmutable;</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineminus">-    bool mIsValid;</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineminus">-    bool mIsDate;</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineplus">+ protected:</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineplus">+  virtual ~calDateTime() {}</span>
<a href="#l4.46"></a><span id="l4.46" class="difflineplus">+  bool mImmutable;</span>
<a href="#l4.47"></a><span id="l4.47" class="difflineplus">+  bool mIsValid;</span>
<a href="#l4.48"></a><span id="l4.48" class="difflineplus">+  bool mIsDate;</span>
<a href="#l4.49"></a><span id="l4.49"> </span>
<a href="#l4.50"></a><span id="l4.50" class="difflineminus">-    int16_t mYear;</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineminus">-    int16_t mMonth;</span>
<a href="#l4.52"></a><span id="l4.52" class="difflineminus">-    int16_t mDay;</span>
<a href="#l4.53"></a><span id="l4.53" class="difflineminus">-    int16_t mHour;</span>
<a href="#l4.54"></a><span id="l4.54" class="difflineminus">-    int16_t mMinute;</span>
<a href="#l4.55"></a><span id="l4.55" class="difflineminus">-    int16_t mSecond;</span>
<a href="#l4.56"></a><span id="l4.56" class="difflineminus">-    int16_t mWeekday;</span>
<a href="#l4.57"></a><span id="l4.57" class="difflineminus">-    int16_t mYearday;</span>
<a href="#l4.58"></a><span id="l4.58" class="difflineplus">+  int16_t mYear;</span>
<a href="#l4.59"></a><span id="l4.59" class="difflineplus">+  int16_t mMonth;</span>
<a href="#l4.60"></a><span id="l4.60" class="difflineplus">+  int16_t mDay;</span>
<a href="#l4.61"></a><span id="l4.61" class="difflineplus">+  int16_t mHour;</span>
<a href="#l4.62"></a><span id="l4.62" class="difflineplus">+  int16_t mMinute;</span>
<a href="#l4.63"></a><span id="l4.63" class="difflineplus">+  int16_t mSecond;</span>
<a href="#l4.64"></a><span id="l4.64" class="difflineplus">+  int16_t mWeekday;</span>
<a href="#l4.65"></a><span id="l4.65" class="difflineplus">+  int16_t mYearday;</span>
<a href="#l4.66"></a><span id="l4.66"> </span>
<a href="#l4.67"></a><span id="l4.67" class="difflineminus">-    PRTime mNativeTime;</span>
<a href="#l4.68"></a><span id="l4.68" class="difflineminus">-    nsCOMPtr&lt;calITimezone&gt; mTimezone;</span>
<a href="#l4.69"></a><span id="l4.69" class="difflineplus">+  PRTime mNativeTime;</span>
<a href="#l4.70"></a><span id="l4.70" class="difflineplus">+  nsCOMPtr&lt;calITimezone&gt; mTimezone;</span>
<a href="#l4.71"></a><span id="l4.71"> </span>
<a href="#l4.72"></a><span id="l4.72" class="difflineminus">-    void Normalize();</span>
<a href="#l4.73"></a><span id="l4.73" class="difflineminus">-    void FromIcalTime(icaltimetype const* icalt, calITimezone *tz);</span>
<a href="#l4.74"></a><span id="l4.74" class="difflineminus">-    void ensureTimezone();</span>
<a href="#l4.75"></a><span id="l4.75" class="difflineplus">+  void Normalize();</span>
<a href="#l4.76"></a><span id="l4.76" class="difflineplus">+  void FromIcalTime(icaltimetype const* icalt, calITimezone* tz);</span>
<a href="#l4.77"></a><span id="l4.77" class="difflineplus">+  void ensureTimezone();</span>
<a href="#l4.78"></a><span id="l4.78"> </span>
<a href="#l4.79"></a><span id="l4.79" class="difflineminus">-    static PRTime IcaltimeToPRTime(icaltimetype const* icalt, icaltimezone const* tz);</span>
<a href="#l4.80"></a><span id="l4.80" class="difflineminus">-    static void PRTimeToIcaltime(PRTime time, bool isdate,</span>
<a href="#l4.81"></a><span id="l4.81" class="difflineminus">-                                 icaltimezone const* tz, icaltimetype *icalt);</span>
<a href="#l4.82"></a><span id="l4.82" class="difflineplus">+  static PRTime IcaltimeToPRTime(icaltimetype const* icalt,</span>
<a href="#l4.83"></a><span id="l4.83" class="difflineplus">+                                 icaltimezone const* tz);</span>
<a href="#l4.84"></a><span id="l4.84" class="difflineplus">+  static void PRTimeToIcaltime(PRTime time, bool isdate, icaltimezone const* tz,</span>
<a href="#l4.85"></a><span id="l4.85" class="difflineplus">+                               icaltimetype* icalt);</span>
<a href="#l4.86"></a><span id="l4.86"> };</span>
<a href="#l4.87"></a><span id="l4.87"> </span>
<a href="#l4.88"></a><span id="l4.88" class="difflineminus">-#endif // INCLUDED_CALDATETIME_H</span>
<a href="#l4.89"></a><span id="l4.89" class="difflineplus">+#endif  // INCLUDED_CALDATETIME_H</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/calendar/base/backend/libical/calDuration.cpp</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/calendar/base/backend/libical/calDuration.cpp</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -8,327 +8,285 @@</span>
<a href="#l5.4"></a><span id="l5.4"> </span>
<a href="#l5.5"></a><span id="l5.5"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l5.6"></a><span id="l5.6"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l5.7"></a><span id="l5.7"> </span>
<a href="#l5.8"></a><span id="l5.8"> #include &quot;nsIClassInfoImpl.h&quot;</span>
<a href="#l5.9"></a><span id="l5.9"> </span>
<a href="#l5.10"></a><span id="l5.10"> #include &quot;calUtils.h&quot;</span>
<a href="#l5.11"></a><span id="l5.11"> </span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-#define SECONDS_PER_WEEK   604800</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineminus">-#define SECONDS_PER_DAY     86400</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineminus">-#define SECONDS_PER_HOUR     3600</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineminus">-#define SECONDS_PER_MINUTE     60</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineplus">+#define SECONDS_PER_WEEK 604800</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineplus">+#define SECONDS_PER_DAY 86400</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineplus">+#define SECONDS_PER_HOUR 3600</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineplus">+#define SECONDS_PER_MINUTE 60</span>
<a href="#l5.20"></a><span id="l5.20"> </span>
<a href="#l5.21"></a><span id="l5.21"> NS_IMPL_CLASSINFO(calDuration, nullptr, 0, CAL_DURATION_CID)</span>
<a href="#l5.22"></a><span id="l5.22"> NS_IMPL_ISUPPORTS_CI(calDuration, calIDuration, calIDurationLibical)</span>
<a href="#l5.23"></a><span id="l5.23"> </span>
<a href="#l5.24"></a><span id="l5.24" class="difflineminus">-calDuration::calDuration()</span>
<a href="#l5.25"></a><span id="l5.25" class="difflineminus">-    : mImmutable(false)</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineminus">-{</span>
<a href="#l5.27"></a><span id="l5.27" class="difflineminus">-    Reset();</span>
<a href="#l5.28"></a><span id="l5.28" class="difflineplus">+calDuration::calDuration() : mImmutable(false) { Reset(); }</span>
<a href="#l5.29"></a><span id="l5.29" class="difflineplus">+</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineplus">+calDuration::calDuration(const calDuration &amp;cdt) {</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineplus">+  mDuration.is_neg = cdt.mDuration.is_neg;</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineplus">+  mDuration.weeks = cdt.mDuration.weeks;</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineplus">+  mDuration.days = cdt.mDuration.days;</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineplus">+  mDuration.hours = cdt.mDuration.hours;</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineplus">+  mDuration.minutes = cdt.mDuration.minutes;</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineplus">+  mDuration.seconds = cdt.mDuration.seconds;</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineplus">+</span>
<a href="#l5.38"></a><span id="l5.38" class="difflineplus">+  // copies are always mutable</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineplus">+  mImmutable = false;</span>
<a href="#l5.40"></a><span id="l5.40"> }</span>
<a href="#l5.41"></a><span id="l5.41"> </span>
<a href="#l5.42"></a><span id="l5.42" class="difflineminus">-calDuration::calDuration(const calDuration&amp; cdt)</span>
<a href="#l5.43"></a><span id="l5.43" class="difflineminus">-{</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineminus">-    mDuration.is_neg = cdt.mDuration.is_neg;</span>
<a href="#l5.45"></a><span id="l5.45" class="difflineminus">-    mDuration.weeks = cdt.mDuration.weeks;</span>
<a href="#l5.46"></a><span id="l5.46" class="difflineminus">-    mDuration.days = cdt.mDuration.days;</span>
<a href="#l5.47"></a><span id="l5.47" class="difflineminus">-    mDuration.hours = cdt.mDuration.hours;</span>
<a href="#l5.48"></a><span id="l5.48" class="difflineminus">-    mDuration.minutes = cdt.mDuration.minutes;</span>
<a href="#l5.49"></a><span id="l5.49" class="difflineminus">-    mDuration.seconds = cdt.mDuration.seconds;</span>
<a href="#l5.50"></a><span id="l5.50" class="difflineminus">-</span>
<a href="#l5.51"></a><span id="l5.51" class="difflineminus">-    // copies are always mutable</span>
<a href="#l5.52"></a><span id="l5.52" class="difflineminus">-    mImmutable = false;</span>
<a href="#l5.53"></a><span id="l5.53" class="difflineplus">+calDuration::calDuration(const struct icaldurationtype *const aDurationPtr)</span>
<a href="#l5.54"></a><span id="l5.54" class="difflineplus">+    : mImmutable(false) {</span>
<a href="#l5.55"></a><span id="l5.55" class="difflineplus">+  FromIcalDuration(aDurationPtr);</span>
<a href="#l5.56"></a><span id="l5.56"> }</span>
<a href="#l5.57"></a><span id="l5.57"> </span>
<a href="#l5.58"></a><span id="l5.58" class="difflineminus">-calDuration::calDuration(const struct icaldurationtype * const aDurationPtr)</span>
<a href="#l5.59"></a><span id="l5.59" class="difflineminus">-    : mImmutable(false)</span>
<a href="#l5.60"></a><span id="l5.60" class="difflineminus">-{</span>
<a href="#l5.61"></a><span id="l5.61" class="difflineminus">-    FromIcalDuration(aDurationPtr);</span>
<a href="#l5.62"></a><span id="l5.62" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l5.63"></a><span id="l5.63" class="difflineplus">+calDuration::GetIcalDuration(JS::MutableHandleValue) {</span>
<a href="#l5.64"></a><span id="l5.64" class="difflineplus">+  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l5.65"></a><span id="l5.65"> }</span>
<a href="#l5.66"></a><span id="l5.66"> </span>
<a href="#l5.67"></a><span id="l5.67"> NS_IMETHODIMP</span>
<a href="#l5.68"></a><span id="l5.68" class="difflineminus">-calDuration::GetIcalDuration(JS::MutableHandleValue)</span>
<a href="#l5.69"></a><span id="l5.69" class="difflineminus">-{</span>
<a href="#l5.70"></a><span id="l5.70" class="difflineminus">-    return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l5.71"></a><span id="l5.71" class="difflineplus">+calDuration::SetIcalDuration(JS::HandleValue) {</span>
<a href="#l5.72"></a><span id="l5.72" class="difflineplus">+  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l5.73"></a><span id="l5.73"> }</span>
<a href="#l5.74"></a><span id="l5.74"> </span>
<a href="#l5.75"></a><span id="l5.75"> NS_IMETHODIMP</span>
<a href="#l5.76"></a><span id="l5.76" class="difflineminus">-calDuration::SetIcalDuration(JS::HandleValue)</span>
<a href="#l5.77"></a><span id="l5.77" class="difflineminus">-{</span>
<a href="#l5.78"></a><span id="l5.78" class="difflineminus">-    return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l5.79"></a><span id="l5.79" class="difflineplus">+calDuration::GetIsMutable(bool *aResult) {</span>
<a href="#l5.80"></a><span id="l5.80" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l5.81"></a><span id="l5.81" class="difflineplus">+</span>
<a href="#l5.82"></a><span id="l5.82" class="difflineplus">+  *aResult = !mImmutable;</span>
<a href="#l5.83"></a><span id="l5.83" class="difflineplus">+  return NS_OK;</span>
<a href="#l5.84"></a><span id="l5.84"> }</span>
<a href="#l5.85"></a><span id="l5.85"> </span>
<a href="#l5.86"></a><span id="l5.86"> NS_IMETHODIMP</span>
<a href="#l5.87"></a><span id="l5.87" class="difflineminus">-calDuration::GetIsMutable(bool *aResult)</span>
<a href="#l5.88"></a><span id="l5.88" class="difflineminus">-{</span>
<a href="#l5.89"></a><span id="l5.89" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l5.90"></a><span id="l5.90" class="difflineminus">-</span>
<a href="#l5.91"></a><span id="l5.91" class="difflineminus">-    *aResult = !mImmutable;</span>
<a href="#l5.92"></a><span id="l5.92" class="difflineminus">-    return NS_OK;</span>
<a href="#l5.93"></a><span id="l5.93" class="difflineplus">+calDuration::MakeImmutable() {</span>
<a href="#l5.94"></a><span id="l5.94" class="difflineplus">+  mImmutable = true;</span>
<a href="#l5.95"></a><span id="l5.95" class="difflineplus">+  return NS_OK;</span>
<a href="#l5.96"></a><span id="l5.96"> }</span>
<a href="#l5.97"></a><span id="l5.97"> </span>
<a href="#l5.98"></a><span id="l5.98"> NS_IMETHODIMP</span>
<a href="#l5.99"></a><span id="l5.99" class="difflineminus">-calDuration::MakeImmutable()</span>
<a href="#l5.100"></a><span id="l5.100" class="difflineminus">-{</span>
<a href="#l5.101"></a><span id="l5.101" class="difflineminus">-    mImmutable = true;</span>
<a href="#l5.102"></a><span id="l5.102" class="difflineminus">-    return NS_OK;</span>
<a href="#l5.103"></a><span id="l5.103" class="difflineminus">-}</span>
<a href="#l5.104"></a><span id="l5.104" class="difflineplus">+calDuration::Clone(calIDuration **aResult) {</span>
<a href="#l5.105"></a><span id="l5.105" class="difflineplus">+  calDuration *cdt = new calDuration(*this);</span>
<a href="#l5.106"></a><span id="l5.106" class="difflineplus">+  if (!cdt) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l5.107"></a><span id="l5.107"> </span>
<a href="#l5.108"></a><span id="l5.108" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l5.109"></a><span id="l5.109" class="difflineminus">-calDuration::Clone(calIDuration **aResult)</span>
<a href="#l5.110"></a><span id="l5.110" class="difflineminus">-{</span>
<a href="#l5.111"></a><span id="l5.111" class="difflineminus">-    calDuration *cdt = new calDuration(*this);</span>
<a href="#l5.112"></a><span id="l5.112" class="difflineminus">-    if (!cdt)</span>
<a href="#l5.113"></a><span id="l5.113" class="difflineminus">-        return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l5.114"></a><span id="l5.114" class="difflineminus">-</span>
<a href="#l5.115"></a><span id="l5.115" class="difflineminus">-    NS_ADDREF(*aResult = cdt);</span>
<a href="#l5.116"></a><span id="l5.116" class="difflineminus">-    return NS_OK;</span>
<a href="#l5.117"></a><span id="l5.117" class="difflineplus">+  NS_ADDREF(*aResult = cdt);</span>
<a href="#l5.118"></a><span id="l5.118" class="difflineplus">+  return NS_OK;</span>
<a href="#l5.119"></a><span id="l5.119"> }</span>
<a href="#l5.120"></a><span id="l5.120"> </span>
<a href="#l5.121"></a><span id="l5.121"> NS_IMETHODIMP</span>
<a href="#l5.122"></a><span id="l5.122" class="difflineminus">-calDuration::Reset()</span>
<a href="#l5.123"></a><span id="l5.123" class="difflineminus">-{</span>
<a href="#l5.124"></a><span id="l5.124" class="difflineminus">-    if (mImmutable)</span>
<a href="#l5.125"></a><span id="l5.125" class="difflineminus">-        return NS_ERROR_FAILURE;</span>
<a href="#l5.126"></a><span id="l5.126" class="difflineplus">+calDuration::Reset() {</span>
<a href="#l5.127"></a><span id="l5.127" class="difflineplus">+  if (mImmutable) return NS_ERROR_FAILURE;</span>
<a href="#l5.128"></a><span id="l5.128"> </span>
<a href="#l5.129"></a><span id="l5.129" class="difflineminus">-    mDuration.is_neg = 0;</span>
<a href="#l5.130"></a><span id="l5.130" class="difflineminus">-    mDuration.weeks = 0;</span>
<a href="#l5.131"></a><span id="l5.131" class="difflineminus">-    mDuration.days = 0;</span>
<a href="#l5.132"></a><span id="l5.132" class="difflineminus">-    mDuration.hours = 0;</span>
<a href="#l5.133"></a><span id="l5.133" class="difflineminus">-    mDuration.minutes = 0;</span>
<a href="#l5.134"></a><span id="l5.134" class="difflineminus">-    mDuration.seconds = 0;</span>
<a href="#l5.135"></a><span id="l5.135" class="difflineplus">+  mDuration.is_neg = 0;</span>
<a href="#l5.136"></a><span id="l5.136" class="difflineplus">+  mDuration.weeks = 0;</span>
<a href="#l5.137"></a><span id="l5.137" class="difflineplus">+  mDuration.days = 0;</span>
<a href="#l5.138"></a><span id="l5.138" class="difflineplus">+  mDuration.hours = 0;</span>
<a href="#l5.139"></a><span id="l5.139" class="difflineplus">+  mDuration.minutes = 0;</span>
<a href="#l5.140"></a><span id="l5.140" class="difflineplus">+  mDuration.seconds = 0;</span>
<a href="#l5.141"></a><span id="l5.141"> </span>
<a href="#l5.142"></a><span id="l5.142" class="difflineminus">-    return NS_OK;</span>
<a href="#l5.143"></a><span id="l5.143" class="difflineplus">+  return NS_OK;</span>
<a href="#l5.144"></a><span id="l5.144"> }</span>
<a href="#l5.145"></a><span id="l5.145"> </span>
<a href="#l5.146"></a><span id="l5.146" class="difflineminus">-NS_IMETHODIMP calDuration::GetIsNegative(bool *_retval)</span>
<a href="#l5.147"></a><span id="l5.147" class="difflineminus">-{</span>
<a href="#l5.148"></a><span id="l5.148" class="difflineminus">-    *_retval = mDuration.is_neg;</span>
<a href="#l5.149"></a><span id="l5.149" class="difflineminus">-    return NS_OK;</span>
<a href="#l5.150"></a><span id="l5.150" class="difflineplus">+NS_IMETHODIMP calDuration::GetIsNegative(bool *_retval) {</span>
<a href="#l5.151"></a><span id="l5.151" class="difflineplus">+  *_retval = mDuration.is_neg;</span>
<a href="#l5.152"></a><span id="l5.152" class="difflineplus">+  return NS_OK;</span>
<a href="#l5.153"></a><span id="l5.153"> }</span>
<a href="#l5.154"></a><span id="l5.154" class="difflineminus">-NS_IMETHODIMP calDuration::SetIsNegative(bool aValue)</span>
<a href="#l5.155"></a><span id="l5.155" class="difflineminus">-{</span>
<a href="#l5.156"></a><span id="l5.156" class="difflineminus">-    if (mImmutable) return NS_ERROR_CALENDAR_IMMUTABLE;</span>
<a href="#l5.157"></a><span id="l5.157" class="difflineminus">-    mDuration.is_neg = aValue;</span>
<a href="#l5.158"></a><span id="l5.158" class="difflineminus">-    return NS_OK;</span>
<a href="#l5.159"></a><span id="l5.159" class="difflineplus">+NS_IMETHODIMP calDuration::SetIsNegative(bool aValue) {</span>
<a href="#l5.160"></a><span id="l5.160" class="difflineplus">+  if (mImmutable) return NS_ERROR_CALENDAR_IMMUTABLE;</span>
<a href="#l5.161"></a><span id="l5.161" class="difflineplus">+  mDuration.is_neg = aValue;</span>
<a href="#l5.162"></a><span id="l5.162" class="difflineplus">+  return NS_OK;</span>
<a href="#l5.163"></a><span id="l5.163"> }</span>
<a href="#l5.164"></a><span id="l5.164"> </span>
<a href="#l5.165"></a><span id="l5.165" class="difflineminus">-NS_IMETHODIMP calDuration::GetWeeks(int16_t *_retval)</span>
<a href="#l5.166"></a><span id="l5.166" class="difflineminus">-{</span>
<a href="#l5.167"></a><span id="l5.167" class="difflineminus">-    *_retval = (int16_t)mDuration.weeks;</span>
<a href="#l5.168"></a><span id="l5.168" class="difflineminus">-    return NS_OK;</span>
<a href="#l5.169"></a><span id="l5.169" class="difflineplus">+NS_IMETHODIMP calDuration::GetWeeks(int16_t *_retval) {</span>
<a href="#l5.170"></a><span id="l5.170" class="difflineplus">+  *_retval = (int16_t)mDuration.weeks;</span>
<a href="#l5.171"></a><span id="l5.171" class="difflineplus">+  return NS_OK;</span>
<a href="#l5.172"></a><span id="l5.172"> }</span>
<a href="#l5.173"></a><span id="l5.173" class="difflineminus">-NS_IMETHODIMP calDuration::SetWeeks(int16_t aValue)</span>
<a href="#l5.174"></a><span id="l5.174" class="difflineminus">-{</span>
<a href="#l5.175"></a><span id="l5.175" class="difflineminus">-    if (mImmutable) return NS_ERROR_CALENDAR_IMMUTABLE;</span>
<a href="#l5.176"></a><span id="l5.176" class="difflineminus">-    mDuration.weeks = aValue;</span>
<a href="#l5.177"></a><span id="l5.177" class="difflineminus">-    return NS_OK;</span>
<a href="#l5.178"></a><span id="l5.178" class="difflineplus">+NS_IMETHODIMP calDuration::SetWeeks(int16_t aValue) {</span>
<a href="#l5.179"></a><span id="l5.179" class="difflineplus">+  if (mImmutable) return NS_ERROR_CALENDAR_IMMUTABLE;</span>
<a href="#l5.180"></a><span id="l5.180" class="difflineplus">+  mDuration.weeks = aValue;</span>
<a href="#l5.181"></a><span id="l5.181" class="difflineplus">+  return NS_OK;</span>
<a href="#l5.182"></a><span id="l5.182"> }</span>
<a href="#l5.183"></a><span id="l5.183"> </span>
<a href="#l5.184"></a><span id="l5.184" class="difflineminus">-NS_IMETHODIMP calDuration::GetDays(int16_t *_retval)</span>
<a href="#l5.185"></a><span id="l5.185" class="difflineminus">-{</span>
<a href="#l5.186"></a><span id="l5.186" class="difflineminus">-    *_retval = (int16_t)mDuration.days;</span>
<a href="#l5.187"></a><span id="l5.187" class="difflineminus">-    return NS_OK;</span>
<a href="#l5.188"></a><span id="l5.188" class="difflineplus">+NS_IMETHODIMP calDuration::GetDays(int16_t *_retval) {</span>
<a href="#l5.189"></a><span id="l5.189" class="difflineplus">+  *_retval = (int16_t)mDuration.days;</span>
<a href="#l5.190"></a><span id="l5.190" class="difflineplus">+  return NS_OK;</span>
<a href="#l5.191"></a><span id="l5.191"> }</span>
<a href="#l5.192"></a><span id="l5.192" class="difflineminus">-NS_IMETHODIMP calDuration::SetDays(int16_t aValue)</span>
<a href="#l5.193"></a><span id="l5.193" class="difflineminus">-{</span>
<a href="#l5.194"></a><span id="l5.194" class="difflineminus">-    if (mImmutable) return NS_ERROR_CALENDAR_IMMUTABLE;</span>
<a href="#l5.195"></a><span id="l5.195" class="difflineminus">-    mDuration.days = aValue;</span>
<a href="#l5.196"></a><span id="l5.196" class="difflineminus">-    return NS_OK;</span>
<a href="#l5.197"></a><span id="l5.197" class="difflineplus">+NS_IMETHODIMP calDuration::SetDays(int16_t aValue) {</span>
<a href="#l5.198"></a><span id="l5.198" class="difflineplus">+  if (mImmutable) return NS_ERROR_CALENDAR_IMMUTABLE;</span>
<a href="#l5.199"></a><span id="l5.199" class="difflineplus">+  mDuration.days = aValue;</span>
<a href="#l5.200"></a><span id="l5.200" class="difflineplus">+  return NS_OK;</span>
<a href="#l5.201"></a><span id="l5.201"> }</span>
<a href="#l5.202"></a><span id="l5.202"> </span>
<a href="#l5.203"></a><span id="l5.203" class="difflineminus">-NS_IMETHODIMP calDuration::GetHours(int16_t *_retval)</span>
<a href="#l5.204"></a><span id="l5.204" class="difflineminus">-{</span>
<a href="#l5.205"></a><span id="l5.205" class="difflineminus">-    *_retval = (int16_t)mDuration.hours;</span>
<a href="#l5.206"></a><span id="l5.206" class="difflineminus">-    return NS_OK;</span>
<a href="#l5.207"></a><span id="l5.207" class="difflineplus">+NS_IMETHODIMP calDuration::GetHours(int16_t *_retval) {</span>
<a href="#l5.208"></a><span id="l5.208" class="difflineplus">+  *_retval = (int16_t)mDuration.hours;</span>
<a href="#l5.209"></a><span id="l5.209" class="difflineplus">+  return NS_OK;</span>
<a href="#l5.210"></a><span id="l5.210"> }</span>
<a href="#l5.211"></a><span id="l5.211" class="difflineminus">-NS_IMETHODIMP calDuration::SetHours(int16_t aValue)</span>
<a href="#l5.212"></a><span id="l5.212" class="difflineminus">-{</span>
<a href="#l5.213"></a><span id="l5.213" class="difflineminus">-    if (mImmutable) return NS_ERROR_CALENDAR_IMMUTABLE;</span>
<a href="#l5.214"></a><span id="l5.214" class="difflineminus">-    mDuration.hours = aValue;</span>
<a href="#l5.215"></a><span id="l5.215" class="difflineminus">-    return NS_OK;</span>
<a href="#l5.216"></a><span id="l5.216" class="difflineplus">+NS_IMETHODIMP calDuration::SetHours(int16_t aValue) {</span>
<a href="#l5.217"></a><span id="l5.217" class="difflineplus">+  if (mImmutable) return NS_ERROR_CALENDAR_IMMUTABLE;</span>
<a href="#l5.218"></a><span id="l5.218" class="difflineplus">+  mDuration.hours = aValue;</span>
<a href="#l5.219"></a><span id="l5.219" class="difflineplus">+  return NS_OK;</span>
<a href="#l5.220"></a><span id="l5.220"> }</span>
<a href="#l5.221"></a><span id="l5.221"> </span>
<a href="#l5.222"></a><span id="l5.222" class="difflineminus">-NS_IMETHODIMP calDuration::GetMinutes(int16_t *_retval)</span>
<a href="#l5.223"></a><span id="l5.223" class="difflineminus">-{</span>
<a href="#l5.224"></a><span id="l5.224" class="difflineminus">-    *_retval = (int16_t)mDuration.minutes;</span>
<a href="#l5.225"></a><span id="l5.225" class="difflineminus">-    return NS_OK;</span>
<a href="#l5.226"></a><span id="l5.226" class="difflineplus">+NS_IMETHODIMP calDuration::GetMinutes(int16_t *_retval) {</span>
<a href="#l5.227"></a><span id="l5.227" class="difflineplus">+  *_retval = (int16_t)mDuration.minutes;</span>
<a href="#l5.228"></a><span id="l5.228" class="difflineplus">+  return NS_OK;</span>
<a href="#l5.229"></a><span id="l5.229"> }</span>
<a href="#l5.230"></a><span id="l5.230" class="difflineminus">-NS_IMETHODIMP calDuration::SetMinutes(int16_t aValue)</span>
<a href="#l5.231"></a><span id="l5.231" class="difflineminus">-{</span>
<a href="#l5.232"></a><span id="l5.232" class="difflineminus">-    if (mImmutable) return NS_ERROR_CALENDAR_IMMUTABLE;</span>
<a href="#l5.233"></a><span id="l5.233" class="difflineminus">-    mDuration.minutes = aValue;</span>
<a href="#l5.234"></a><span id="l5.234" class="difflineminus">-    return NS_OK;</span>
<a href="#l5.235"></a><span id="l5.235" class="difflineplus">+NS_IMETHODIMP calDuration::SetMinutes(int16_t aValue) {</span>
<a href="#l5.236"></a><span id="l5.236" class="difflineplus">+  if (mImmutable) return NS_ERROR_CALENDAR_IMMUTABLE;</span>
<a href="#l5.237"></a><span id="l5.237" class="difflineplus">+  mDuration.minutes = aValue;</span>
<a href="#l5.238"></a><span id="l5.238" class="difflineplus">+  return NS_OK;</span>
<a href="#l5.239"></a><span id="l5.239"> }</span>
<a href="#l5.240"></a><span id="l5.240"> </span>
<a href="#l5.241"></a><span id="l5.241" class="difflineminus">-NS_IMETHODIMP calDuration::GetSeconds(int16_t *_retval)</span>
<a href="#l5.242"></a><span id="l5.242" class="difflineminus">-{</span>
<a href="#l5.243"></a><span id="l5.243" class="difflineminus">-    *_retval = (int16_t)mDuration.seconds;</span>
<a href="#l5.244"></a><span id="l5.244" class="difflineminus">-    return NS_OK;</span>
<a href="#l5.245"></a><span id="l5.245" class="difflineplus">+NS_IMETHODIMP calDuration::GetSeconds(int16_t *_retval) {</span>
<a href="#l5.246"></a><span id="l5.246" class="difflineplus">+  *_retval = (int16_t)mDuration.seconds;</span>
<a href="#l5.247"></a><span id="l5.247" class="difflineplus">+  return NS_OK;</span>
<a href="#l5.248"></a><span id="l5.248"> }</span>
<a href="#l5.249"></a><span id="l5.249" class="difflineminus">-NS_IMETHODIMP calDuration::SetSeconds(int16_t aValue)</span>
<a href="#l5.250"></a><span id="l5.250" class="difflineminus">-{</span>
<a href="#l5.251"></a><span id="l5.251" class="difflineminus">-    if (mImmutable) return NS_ERROR_CALENDAR_IMMUTABLE;</span>
<a href="#l5.252"></a><span id="l5.252" class="difflineminus">-    mDuration.seconds = aValue;</span>
<a href="#l5.253"></a><span id="l5.253" class="difflineminus">-    return NS_OK;</span>
<a href="#l5.254"></a><span id="l5.254" class="difflineplus">+NS_IMETHODIMP calDuration::SetSeconds(int16_t aValue) {</span>
<a href="#l5.255"></a><span id="l5.255" class="difflineplus">+  if (mImmutable) return NS_ERROR_CALENDAR_IMMUTABLE;</span>
<a href="#l5.256"></a><span id="l5.256" class="difflineplus">+  mDuration.seconds = aValue;</span>
<a href="#l5.257"></a><span id="l5.257" class="difflineplus">+  return NS_OK;</span>
<a href="#l5.258"></a><span id="l5.258"> }</span>
<a href="#l5.259"></a><span id="l5.259"> </span>
<a href="#l5.260"></a><span id="l5.260" class="difflineplus">+NS_IMETHODIMP calDuration::GetInSeconds(int32_t *_retval) {</span>
<a href="#l5.261"></a><span id="l5.261" class="difflineplus">+  int32_t retval =</span>
<a href="#l5.262"></a><span id="l5.262" class="difflineplus">+      (((int32_t)((int16_t)mDuration.weeks * SECONDS_PER_WEEK)) +</span>
<a href="#l5.263"></a><span id="l5.263" class="difflineplus">+       ((int32_t)((int16_t)mDuration.days * SECONDS_PER_DAY)) +</span>
<a href="#l5.264"></a><span id="l5.264" class="difflineplus">+       ((int32_t)((int16_t)mDuration.hours * SECONDS_PER_HOUR)) +</span>
<a href="#l5.265"></a><span id="l5.265" class="difflineplus">+       ((int32_t)((int16_t)mDuration.minutes * SECONDS_PER_MINUTE)) +</span>
<a href="#l5.266"></a><span id="l5.266" class="difflineplus">+       ((int32_t)((int16_t)mDuration.seconds)));</span>
<a href="#l5.267"></a><span id="l5.267" class="difflineplus">+  if (mDuration.is_neg) retval = -retval;</span>
<a href="#l5.268"></a><span id="l5.268" class="difflineplus">+  *_retval = retval;</span>
<a href="#l5.269"></a><span id="l5.269"> </span>
<a href="#l5.270"></a><span id="l5.270" class="difflineminus">-NS_IMETHODIMP calDuration::GetInSeconds(int32_t *_retval)</span>
<a href="#l5.271"></a><span id="l5.271" class="difflineminus">-{</span>
<a href="#l5.272"></a><span id="l5.272" class="difflineminus">-	int32_t retval =</span>
<a href="#l5.273"></a><span id="l5.273" class="difflineminus">-        (((int32_t)((int16_t)mDuration.weeks   * SECONDS_PER_WEEK)) + </span>
<a href="#l5.274"></a><span id="l5.274" class="difflineminus">-         ((int32_t)((int16_t)mDuration.days    * SECONDS_PER_DAY)) +</span>
<a href="#l5.275"></a><span id="l5.275" class="difflineminus">-         ((int32_t)((int16_t)mDuration.hours   * SECONDS_PER_HOUR)) +</span>
<a href="#l5.276"></a><span id="l5.276" class="difflineminus">-         ((int32_t)((int16_t)mDuration.minutes * SECONDS_PER_MINUTE)) +</span>
<a href="#l5.277"></a><span id="l5.277" class="difflineminus">-         ((int32_t)((int16_t)mDuration.seconds)));</span>
<a href="#l5.278"></a><span id="l5.278" class="difflineminus">-    if (mDuration.is_neg)</span>
<a href="#l5.279"></a><span id="l5.279" class="difflineminus">-		retval=-retval;</span>
<a href="#l5.280"></a><span id="l5.280" class="difflineminus">-    *_retval = retval;</span>
<a href="#l5.281"></a><span id="l5.281" class="difflineplus">+  return NS_OK;</span>
<a href="#l5.282"></a><span id="l5.282" class="difflineplus">+}</span>
<a href="#l5.283"></a><span id="l5.283" class="difflineplus">+NS_IMETHODIMP calDuration::SetInSeconds(int32_t aValue) {</span>
<a href="#l5.284"></a><span id="l5.284" class="difflineplus">+  if (mImmutable) return NS_ERROR_CALENDAR_IMMUTABLE;</span>
<a href="#l5.285"></a><span id="l5.285"> </span>
<a href="#l5.286"></a><span id="l5.286" class="difflineminus">-    return NS_OK;</span>
<a href="#l5.287"></a><span id="l5.287" class="difflineminus">-}</span>
<a href="#l5.288"></a><span id="l5.288" class="difflineminus">-NS_IMETHODIMP calDuration::SetInSeconds(int32_t aValue)</span>
<a href="#l5.289"></a><span id="l5.289" class="difflineminus">-{</span>
<a href="#l5.290"></a><span id="l5.290" class="difflineminus">-    if (mImmutable) return NS_ERROR_CALENDAR_IMMUTABLE;</span>
<a href="#l5.291"></a><span id="l5.291" class="difflineplus">+  mDuration.is_neg = (aValue &lt; 0);</span>
<a href="#l5.292"></a><span id="l5.292" class="difflineplus">+  if (mDuration.is_neg) aValue = -aValue;</span>
<a href="#l5.293"></a><span id="l5.293"> </span>
<a href="#l5.294"></a><span id="l5.294" class="difflineminus">-    mDuration.is_neg = (aValue &lt; 0);</span>
<a href="#l5.295"></a><span id="l5.295" class="difflineminus">-    if (mDuration.is_neg)</span>
<a href="#l5.296"></a><span id="l5.296" class="difflineminus">-        aValue = -aValue;</span>
<a href="#l5.297"></a><span id="l5.297" class="difflineplus">+  // set weeks exOR days/hours/...</span>
<a href="#l5.298"></a><span id="l5.298" class="difflineplus">+  mDuration.weeks =</span>
<a href="#l5.299"></a><span id="l5.299" class="difflineplus">+      ((aValue % SECONDS_PER_WEEK) == 0 ? aValue / SECONDS_PER_WEEK : 0);</span>
<a href="#l5.300"></a><span id="l5.300" class="difflineplus">+  aValue -= (mDuration.weeks * SECONDS_PER_WEEK);</span>
<a href="#l5.301"></a><span id="l5.301"> </span>
<a href="#l5.302"></a><span id="l5.302" class="difflineminus">-    // set weeks exOR days/hours/...</span>
<a href="#l5.303"></a><span id="l5.303" class="difflineminus">-    mDuration.weeks = ((aValue % SECONDS_PER_WEEK) == 0 ? aValue / SECONDS_PER_WEEK : 0);</span>
<a href="#l5.304"></a><span id="l5.304" class="difflineminus">-    aValue -= (mDuration.weeks * SECONDS_PER_WEEK);</span>
<a href="#l5.305"></a><span id="l5.305" class="difflineplus">+  mDuration.days = aValue / SECONDS_PER_DAY;</span>
<a href="#l5.306"></a><span id="l5.306" class="difflineplus">+  aValue -= (mDuration.days * SECONDS_PER_DAY);</span>
<a href="#l5.307"></a><span id="l5.307"> </span>
<a href="#l5.308"></a><span id="l5.308" class="difflineminus">-    mDuration.days = aValue / SECONDS_PER_DAY;</span>
<a href="#l5.309"></a><span id="l5.309" class="difflineminus">-    aValue -= (mDuration.days * SECONDS_PER_DAY);</span>
<a href="#l5.310"></a><span id="l5.310" class="difflineminus">-</span>
<a href="#l5.311"></a><span id="l5.311" class="difflineminus">-    mDuration.hours = aValue / SECONDS_PER_HOUR;</span>
<a href="#l5.312"></a><span id="l5.312" class="difflineminus">-    aValue -= (mDuration.hours * SECONDS_PER_HOUR);</span>
<a href="#l5.313"></a><span id="l5.313" class="difflineplus">+  mDuration.hours = aValue / SECONDS_PER_HOUR;</span>
<a href="#l5.314"></a><span id="l5.314" class="difflineplus">+  aValue -= (mDuration.hours * SECONDS_PER_HOUR);</span>
<a href="#l5.315"></a><span id="l5.315"> </span>
<a href="#l5.316"></a><span id="l5.316" class="difflineminus">-    mDuration.minutes = aValue / SECONDS_PER_MINUTE;</span>
<a href="#l5.317"></a><span id="l5.317" class="difflineminus">-    aValue -= (mDuration.minutes * SECONDS_PER_MINUTE);</span>
<a href="#l5.318"></a><span id="l5.318" class="difflineplus">+  mDuration.minutes = aValue / SECONDS_PER_MINUTE;</span>
<a href="#l5.319"></a><span id="l5.319" class="difflineplus">+  aValue -= (mDuration.minutes * SECONDS_PER_MINUTE);</span>
<a href="#l5.320"></a><span id="l5.320"> </span>
<a href="#l5.321"></a><span id="l5.321" class="difflineminus">-    mDuration.seconds = aValue;</span>
<a href="#l5.322"></a><span id="l5.322" class="difflineplus">+  mDuration.seconds = aValue;</span>
<a href="#l5.323"></a><span id="l5.323"> </span>
<a href="#l5.324"></a><span id="l5.324" class="difflineminus">-    return NS_OK;</span>
<a href="#l5.325"></a><span id="l5.325" class="difflineplus">+  return NS_OK;</span>
<a href="#l5.326"></a><span id="l5.326"> }</span>
<a href="#l5.327"></a><span id="l5.327"> </span>
<a href="#l5.328"></a><span id="l5.328" class="difflineminus">-NS_IMETHODIMP calDuration::AddDuration(calIDuration *aDuration)</span>
<a href="#l5.329"></a><span id="l5.329" class="difflineminus">-{</span>
<a href="#l5.330"></a><span id="l5.330" class="difflineminus">-    if (mImmutable)</span>
<a href="#l5.331"></a><span id="l5.331" class="difflineminus">-        return NS_ERROR_CALENDAR_IMMUTABLE;</span>
<a href="#l5.332"></a><span id="l5.332" class="difflineplus">+NS_IMETHODIMP calDuration::AddDuration(calIDuration *aDuration) {</span>
<a href="#l5.333"></a><span id="l5.333" class="difflineplus">+  if (mImmutable) return NS_ERROR_CALENDAR_IMMUTABLE;</span>
<a href="#l5.334"></a><span id="l5.334"> </span>
<a href="#l5.335"></a><span id="l5.335" class="difflineminus">-    nsresult rv;</span>
<a href="#l5.336"></a><span id="l5.336" class="difflineminus">-    nsCOMPtr&lt;calIDurationLibical&gt; icaldur = do_QueryInterface(aDuration, &amp;rv);</span>
<a href="#l5.337"></a><span id="l5.337" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.338"></a><span id="l5.338" class="difflineplus">+  nsresult rv;</span>
<a href="#l5.339"></a><span id="l5.339" class="difflineplus">+  nsCOMPtr&lt;calIDurationLibical&gt; icaldur = do_QueryInterface(aDuration, &amp;rv);</span>
<a href="#l5.340"></a><span id="l5.340" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.341"></a><span id="l5.341"> </span>
<a href="#l5.342"></a><span id="l5.342" class="difflineminus">-    struct icaldurationtype idt;</span>
<a href="#l5.343"></a><span id="l5.343" class="difflineminus">-    icaldur-&gt;ToIcalDuration(&amp;idt);</span>
<a href="#l5.344"></a><span id="l5.344" class="difflineplus">+  struct icaldurationtype idt;</span>
<a href="#l5.345"></a><span id="l5.345" class="difflineplus">+  icaldur-&gt;ToIcalDuration(&amp;idt);</span>
<a href="#l5.346"></a><span id="l5.346"> </span>
<a href="#l5.347"></a><span id="l5.347" class="difflineminus">-    // Calculate the new absolute value of the duration</span>
<a href="#l5.348"></a><span id="l5.348" class="difflineminus">-    // For two negative durations, the abs. value will increase,</span>
<a href="#l5.349"></a><span id="l5.349" class="difflineminus">-    // so use + in that case.</span>
<a href="#l5.350"></a><span id="l5.350" class="difflineminus">-    // Of course, also use + when both durations are positive.</span>
<a href="#l5.351"></a><span id="l5.351" class="difflineminus">-    if (idt.is_neg == mDuration.is_neg) {</span>
<a href="#l5.352"></a><span id="l5.352" class="difflineminus">-        mDuration.weeks   += idt.weeks;</span>
<a href="#l5.353"></a><span id="l5.353" class="difflineminus">-        mDuration.days    += idt.days;</span>
<a href="#l5.354"></a><span id="l5.354" class="difflineminus">-        mDuration.hours   += idt.hours;</span>
<a href="#l5.355"></a><span id="l5.355" class="difflineminus">-        mDuration.minutes += idt.minutes;</span>
<a href="#l5.356"></a><span id="l5.356" class="difflineminus">-        mDuration.seconds += idt.seconds;</span>
<a href="#l5.357"></a><span id="l5.357" class="difflineminus">-    } else {</span>
<a href="#l5.358"></a><span id="l5.358" class="difflineminus">-        mDuration.weeks   -= idt.weeks;</span>
<a href="#l5.359"></a><span id="l5.359" class="difflineminus">-        mDuration.days    -= idt.days;</span>
<a href="#l5.360"></a><span id="l5.360" class="difflineminus">-        mDuration.hours   -= idt.hours;</span>
<a href="#l5.361"></a><span id="l5.361" class="difflineminus">-        mDuration.minutes -= idt.minutes;</span>
<a href="#l5.362"></a><span id="l5.362" class="difflineminus">-        mDuration.seconds -= idt.seconds;</span>
<a href="#l5.363"></a><span id="l5.363" class="difflineminus">-    }</span>
<a href="#l5.364"></a><span id="l5.364" class="difflineplus">+  // Calculate the new absolute value of the duration</span>
<a href="#l5.365"></a><span id="l5.365" class="difflineplus">+  // For two negative durations, the abs. value will increase,</span>
<a href="#l5.366"></a><span id="l5.366" class="difflineplus">+  // so use + in that case.</span>
<a href="#l5.367"></a><span id="l5.367" class="difflineplus">+  // Of course, also use + when both durations are positive.</span>
<a href="#l5.368"></a><span id="l5.368" class="difflineplus">+  if (idt.is_neg == mDuration.is_neg) {</span>
<a href="#l5.369"></a><span id="l5.369" class="difflineplus">+    mDuration.weeks += idt.weeks;</span>
<a href="#l5.370"></a><span id="l5.370" class="difflineplus">+    mDuration.days += idt.days;</span>
<a href="#l5.371"></a><span id="l5.371" class="difflineplus">+    mDuration.hours += idt.hours;</span>
<a href="#l5.372"></a><span id="l5.372" class="difflineplus">+    mDuration.minutes += idt.minutes;</span>
<a href="#l5.373"></a><span id="l5.373" class="difflineplus">+    mDuration.seconds += idt.seconds;</span>
<a href="#l5.374"></a><span id="l5.374" class="difflineplus">+  } else {</span>
<a href="#l5.375"></a><span id="l5.375" class="difflineplus">+    mDuration.weeks -= idt.weeks;</span>
<a href="#l5.376"></a><span id="l5.376" class="difflineplus">+    mDuration.days -= idt.days;</span>
<a href="#l5.377"></a><span id="l5.377" class="difflineplus">+    mDuration.hours -= idt.hours;</span>
<a href="#l5.378"></a><span id="l5.378" class="difflineplus">+    mDuration.minutes -= idt.minutes;</span>
<a href="#l5.379"></a><span id="l5.379" class="difflineplus">+    mDuration.seconds -= idt.seconds;</span>
<a href="#l5.380"></a><span id="l5.380" class="difflineplus">+  }</span>
<a href="#l5.381"></a><span id="l5.381"> </span>
<a href="#l5.382"></a><span id="l5.382" class="difflineminus">-    Normalize();</span>
<a href="#l5.383"></a><span id="l5.383" class="difflineplus">+  Normalize();</span>
<a href="#l5.384"></a><span id="l5.384"> </span>
<a href="#l5.385"></a><span id="l5.385" class="difflineminus">-    return NS_OK;</span>
<a href="#l5.386"></a><span id="l5.386" class="difflineplus">+  return NS_OK;</span>
<a href="#l5.387"></a><span id="l5.387"> }</span>
<a href="#l5.388"></a><span id="l5.388"> </span>
<a href="#l5.389"></a><span id="l5.389"> NS_IMETHODIMP</span>
<a href="#l5.390"></a><span id="l5.390" class="difflineminus">-calDuration::Normalize()</span>
<a href="#l5.391"></a><span id="l5.391" class="difflineminus">-{</span>
<a href="#l5.392"></a><span id="l5.392" class="difflineminus">-    if (mImmutable)</span>
<a href="#l5.393"></a><span id="l5.393" class="difflineminus">-        return NS_ERROR_CALENDAR_IMMUTABLE;</span>
<a href="#l5.394"></a><span id="l5.394" class="difflineplus">+calDuration::Normalize() {</span>
<a href="#l5.395"></a><span id="l5.395" class="difflineplus">+  if (mImmutable) return NS_ERROR_CALENDAR_IMMUTABLE;</span>
<a href="#l5.396"></a><span id="l5.396" class="difflineplus">+</span>
<a href="#l5.397"></a><span id="l5.397" class="difflineplus">+  int32_t totalInSeconds;</span>
<a href="#l5.398"></a><span id="l5.398" class="difflineplus">+  GetInSeconds(&amp;totalInSeconds);</span>
<a href="#l5.399"></a><span id="l5.399" class="difflineplus">+  SetInSeconds(totalInSeconds);</span>
<a href="#l5.400"></a><span id="l5.400" class="difflineplus">+</span>
<a href="#l5.401"></a><span id="l5.401" class="difflineplus">+  return NS_OK;</span>
<a href="#l5.402"></a><span id="l5.402" class="difflineplus">+}</span>
<a href="#l5.403"></a><span id="l5.403" class="difflineplus">+</span>
<a href="#l5.404"></a><span id="l5.404" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l5.405"></a><span id="l5.405" class="difflineplus">+calDuration::ToString(nsACString &amp;aResult) { return GetIcalString(aResult); }</span>
<a href="#l5.406"></a><span id="l5.406"> </span>
<a href="#l5.407"></a><span id="l5.407" class="difflineminus">-    int32_t totalInSeconds;</span>
<a href="#l5.408"></a><span id="l5.408" class="difflineminus">-    GetInSeconds(&amp;totalInSeconds);</span>
<a href="#l5.409"></a><span id="l5.409" class="difflineminus">-    SetInSeconds(totalInSeconds);</span>
<a href="#l5.410"></a><span id="l5.410" class="difflineplus">+NS_IMETHODIMP_(void)</span>
<a href="#l5.411"></a><span id="l5.411" class="difflineplus">+calDuration::ToIcalDuration(struct icaldurationtype *icald) {</span>
<a href="#l5.412"></a><span id="l5.412" class="difflineplus">+  icald-&gt;is_neg = mDuration.is_neg;</span>
<a href="#l5.413"></a><span id="l5.413" class="difflineplus">+  icald-&gt;weeks = mDuration.weeks;</span>
<a href="#l5.414"></a><span id="l5.414" class="difflineplus">+  icald-&gt;days = mDuration.days;</span>
<a href="#l5.415"></a><span id="l5.415" class="difflineplus">+  icald-&gt;hours = mDuration.hours;</span>
<a href="#l5.416"></a><span id="l5.416" class="difflineplus">+  icald-&gt;minutes = mDuration.minutes;</span>
<a href="#l5.417"></a><span id="l5.417" class="difflineplus">+  icald-&gt;seconds = mDuration.seconds;</span>
<a href="#l5.418"></a><span id="l5.418" class="difflineplus">+  return;</span>
<a href="#l5.419"></a><span id="l5.419" class="difflineplus">+}</span>
<a href="#l5.420"></a><span id="l5.420"> </span>
<a href="#l5.421"></a><span id="l5.421" class="difflineminus">-    return NS_OK;</span>
<a href="#l5.422"></a><span id="l5.422" class="difflineplus">+void calDuration::FromIcalDuration(const struct icaldurationtype *const icald) {</span>
<a href="#l5.423"></a><span id="l5.423" class="difflineplus">+  mDuration.is_neg = icald-&gt;is_neg;</span>
<a href="#l5.424"></a><span id="l5.424" class="difflineplus">+  mDuration.weeks = icald-&gt;weeks;</span>
<a href="#l5.425"></a><span id="l5.425" class="difflineplus">+  mDuration.days = icald-&gt;days;</span>
<a href="#l5.426"></a><span id="l5.426" class="difflineplus">+  mDuration.hours = icald-&gt;hours;</span>
<a href="#l5.427"></a><span id="l5.427" class="difflineplus">+  mDuration.minutes = icald-&gt;minutes;</span>
<a href="#l5.428"></a><span id="l5.428" class="difflineplus">+  mDuration.seconds = icald-&gt;seconds;</span>
<a href="#l5.429"></a><span id="l5.429" class="difflineplus">+  return;</span>
<a href="#l5.430"></a><span id="l5.430"> }</span>
<a href="#l5.431"></a><span id="l5.431"> </span>
<a href="#l5.432"></a><span id="l5.432"> NS_IMETHODIMP</span>
<a href="#l5.433"></a><span id="l5.433" class="difflineminus">-calDuration::ToString(nsACString&amp; aResult)</span>
<a href="#l5.434"></a><span id="l5.434" class="difflineminus">-{</span>
<a href="#l5.435"></a><span id="l5.435" class="difflineminus">-    return GetIcalString(aResult);</span>
<a href="#l5.436"></a><span id="l5.436" class="difflineminus">-}</span>
<a href="#l5.437"></a><span id="l5.437" class="difflineplus">+calDuration::GetIcalString(nsACString &amp;aResult) {</span>
<a href="#l5.438"></a><span id="l5.438" class="difflineplus">+  // note that ics is owned by libical, so we don't need to free</span>
<a href="#l5.439"></a><span id="l5.439" class="difflineplus">+  const char *ics = icaldurationtype_as_ical_string(mDuration);</span>
<a href="#l5.440"></a><span id="l5.440"> </span>
<a href="#l5.441"></a><span id="l5.441" class="difflineminus">-NS_IMETHODIMP_(void)</span>
<a href="#l5.442"></a><span id="l5.442" class="difflineminus">-calDuration::ToIcalDuration(struct icaldurationtype *icald)</span>
<a href="#l5.443"></a><span id="l5.443" class="difflineminus">-{</span>
<a href="#l5.444"></a><span id="l5.444" class="difflineminus">-    icald-&gt;is_neg  = mDuration.is_neg;</span>
<a href="#l5.445"></a><span id="l5.445" class="difflineminus">-    icald-&gt;weeks   = mDuration.weeks;</span>
<a href="#l5.446"></a><span id="l5.446" class="difflineminus">-    icald-&gt;days    = mDuration.days;</span>
<a href="#l5.447"></a><span id="l5.447" class="difflineminus">-    icald-&gt;hours   = mDuration.hours;</span>
<a href="#l5.448"></a><span id="l5.448" class="difflineminus">-    icald-&gt;minutes = mDuration.minutes;</span>
<a href="#l5.449"></a><span id="l5.449" class="difflineminus">-    icald-&gt;seconds = mDuration.seconds;</span>
<a href="#l5.450"></a><span id="l5.450" class="difflineminus">-    return;</span>
<a href="#l5.451"></a><span id="l5.451" class="difflineminus">-}</span>
<a href="#l5.452"></a><span id="l5.452" class="difflineplus">+  if (ics) {</span>
<a href="#l5.453"></a><span id="l5.453" class="difflineplus">+    aResult.Assign(ics);</span>
<a href="#l5.454"></a><span id="l5.454" class="difflineplus">+    return NS_OK;</span>
<a href="#l5.455"></a><span id="l5.455" class="difflineplus">+  }</span>
<a href="#l5.456"></a><span id="l5.456"> </span>
<a href="#l5.457"></a><span id="l5.457" class="difflineminus">-void</span>
<a href="#l5.458"></a><span id="l5.458" class="difflineminus">-calDuration::FromIcalDuration(const struct icaldurationtype * const icald)</span>
<a href="#l5.459"></a><span id="l5.459" class="difflineminus">-{</span>
<a href="#l5.460"></a><span id="l5.460" class="difflineminus">-    mDuration.is_neg  = icald-&gt;is_neg;</span>
<a href="#l5.461"></a><span id="l5.461" class="difflineminus">-    mDuration.weeks   = icald-&gt;weeks;</span>
<a href="#l5.462"></a><span id="l5.462" class="difflineminus">-    mDuration.days    = icald-&gt;days;</span>
<a href="#l5.463"></a><span id="l5.463" class="difflineminus">-    mDuration.hours   = icald-&gt;hours;</span>
<a href="#l5.464"></a><span id="l5.464" class="difflineminus">-    mDuration.minutes = icald-&gt;minutes;</span>
<a href="#l5.465"></a><span id="l5.465" class="difflineminus">-    mDuration.seconds = icald-&gt;seconds;</span>
<a href="#l5.466"></a><span id="l5.466" class="difflineminus">-    return;</span>
<a href="#l5.467"></a><span id="l5.467" class="difflineplus">+  return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l5.468"></a><span id="l5.468"> }</span>
<a href="#l5.469"></a><span id="l5.469"> </span>
<a href="#l5.470"></a><span id="l5.470"> NS_IMETHODIMP</span>
<a href="#l5.471"></a><span id="l5.471" class="difflineminus">-calDuration::GetIcalString(nsACString&amp; aResult)</span>
<a href="#l5.472"></a><span id="l5.472" class="difflineminus">-{</span>
<a href="#l5.473"></a><span id="l5.473" class="difflineminus">-    // note that ics is owned by libical, so we don't need to free</span>
<a href="#l5.474"></a><span id="l5.474" class="difflineminus">-    const char *ics = icaldurationtype_as_ical_string(mDuration);</span>
<a href="#l5.475"></a><span id="l5.475" class="difflineminus">-    </span>
<a href="#l5.476"></a><span id="l5.476" class="difflineminus">-    if (ics) {</span>
<a href="#l5.477"></a><span id="l5.477" class="difflineminus">-        aResult.Assign(ics);</span>
<a href="#l5.478"></a><span id="l5.478" class="difflineminus">-        return NS_OK;</span>
<a href="#l5.479"></a><span id="l5.479" class="difflineminus">-    }</span>
<a href="#l5.480"></a><span id="l5.480" class="difflineminus">-</span>
<a href="#l5.481"></a><span id="l5.481" class="difflineminus">-    return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l5.482"></a><span id="l5.482" class="difflineplus">+calDuration::SetIcalString(const nsACString &amp;aIcalString) {</span>
<a href="#l5.483"></a><span id="l5.483" class="difflineplus">+  mDuration =</span>
<a href="#l5.484"></a><span id="l5.484" class="difflineplus">+      icaldurationtype_from_string(PromiseFlatCString(aIcalString).get());</span>
<a href="#l5.485"></a><span id="l5.485" class="difflineplus">+  return NS_OK;</span>
<a href="#l5.486"></a><span id="l5.486"> }</span>
<a href="#l5.487"></a><span id="l5.487"> </span>
<a href="#l5.488"></a><span id="l5.488"> NS_IMETHODIMP</span>
<a href="#l5.489"></a><span id="l5.489" class="difflineminus">-calDuration::SetIcalString(const nsACString&amp; aIcalString)</span>
<a href="#l5.490"></a><span id="l5.490" class="difflineminus">-{</span>
<a href="#l5.491"></a><span id="l5.491" class="difflineminus">-    mDuration = icaldurationtype_from_string(PromiseFlatCString(aIcalString).get());</span>
<a href="#l5.492"></a><span id="l5.492" class="difflineminus">-    return NS_OK;</span>
<a href="#l5.493"></a><span id="l5.493" class="difflineminus">-}</span>
<a href="#l5.494"></a><span id="l5.494" class="difflineplus">+calDuration::Compare(calIDuration *aOther, int32_t *aResult) {</span>
<a href="#l5.495"></a><span id="l5.495" class="difflineplus">+  int32_t thisInSeconds, otherInSeconds;</span>
<a href="#l5.496"></a><span id="l5.496"> </span>
<a href="#l5.497"></a><span id="l5.497" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l5.498"></a><span id="l5.498" class="difflineminus">-calDuration::Compare(calIDuration *aOther, int32_t *aResult)</span>
<a href="#l5.499"></a><span id="l5.499" class="difflineminus">-{</span>
<a href="#l5.500"></a><span id="l5.500" class="difflineminus">-    int32_t thisInSeconds, otherInSeconds;</span>
<a href="#l5.501"></a><span id="l5.501" class="difflineplus">+  // cast to void because these calls can't fail</span>
<a href="#l5.502"></a><span id="l5.502" class="difflineplus">+  (void)GetInSeconds(&amp;thisInSeconds);</span>
<a href="#l5.503"></a><span id="l5.503" class="difflineplus">+  (void)aOther-&gt;GetInSeconds(&amp;otherInSeconds);</span>
<a href="#l5.504"></a><span id="l5.504"> </span>
<a href="#l5.505"></a><span id="l5.505" class="difflineminus">-    // cast to void because these calls can't fail</span>
<a href="#l5.506"></a><span id="l5.506" class="difflineminus">-    (void)GetInSeconds(&amp;thisInSeconds);</span>
<a href="#l5.507"></a><span id="l5.507" class="difflineminus">-    (void)aOther-&gt;GetInSeconds(&amp;otherInSeconds);</span>
<a href="#l5.508"></a><span id="l5.508" class="difflineplus">+  if (thisInSeconds &lt; otherInSeconds) {</span>
<a href="#l5.509"></a><span id="l5.509" class="difflineplus">+    *aResult = -1;</span>
<a href="#l5.510"></a><span id="l5.510" class="difflineplus">+  } else if (thisInSeconds &gt; otherInSeconds) {</span>
<a href="#l5.511"></a><span id="l5.511" class="difflineplus">+    *aResult = 1;</span>
<a href="#l5.512"></a><span id="l5.512" class="difflineplus">+  } else {</span>
<a href="#l5.513"></a><span id="l5.513" class="difflineplus">+    *aResult = 0;</span>
<a href="#l5.514"></a><span id="l5.514" class="difflineplus">+  }</span>
<a href="#l5.515"></a><span id="l5.515"> </span>
<a href="#l5.516"></a><span id="l5.516" class="difflineminus">-    if ( thisInSeconds &lt; otherInSeconds ) {</span>
<a href="#l5.517"></a><span id="l5.517" class="difflineminus">-      *aResult = -1;</span>
<a href="#l5.518"></a><span id="l5.518" class="difflineminus">-    } else if ( thisInSeconds &gt; otherInSeconds ) {</span>
<a href="#l5.519"></a><span id="l5.519" class="difflineminus">-      *aResult = 1;</span>
<a href="#l5.520"></a><span id="l5.520" class="difflineminus">-    } else {</span>
<a href="#l5.521"></a><span id="l5.521" class="difflineminus">-      *aResult = 0;</span>
<a href="#l5.522"></a><span id="l5.522" class="difflineminus">-    }</span>
<a href="#l5.523"></a><span id="l5.523" class="difflineminus">-</span>
<a href="#l5.524"></a><span id="l5.524" class="difflineminus">-    return NS_OK;</span>
<a href="#l5.525"></a><span id="l5.525" class="difflineplus">+  return NS_OK;</span>
<a href="#l5.526"></a><span id="l5.526"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/calendar/base/backend/libical/calDuration.h</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/calendar/base/backend/libical/calDuration.h</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -4,36 +4,34 @@</span>
<a href="#l6.4"></a><span id="l6.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l6.5"></a><span id="l6.5"> </span>
<a href="#l6.6"></a><span id="l6.6"> #ifndef CALDURATION_H_</span>
<a href="#l6.7"></a><span id="l6.7"> #define CALDURATION_H_</span>
<a href="#l6.8"></a><span id="l6.8"> </span>
<a href="#l6.9"></a><span id="l6.9"> #include &quot;calIDuration.h&quot;</span>
<a href="#l6.10"></a><span id="l6.10"> </span>
<a href="#l6.11"></a><span id="l6.11"> extern &quot;C&quot; {</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-    #include &quot;ical.h&quot;</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+#include &quot;ical.h&quot;</span>
<a href="#l6.14"></a><span id="l6.14"> }</span>
<a href="#l6.15"></a><span id="l6.15"> </span>
<a href="#l6.16"></a><span id="l6.16" class="difflineminus">-class calDuration final : public calIDurationLibical</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineminus">-{</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineminus">-public:</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineminus">-    calDuration ();</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineminus">-    calDuration (const calDuration&amp; cdt);</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineminus">-    explicit calDuration (const struct icaldurationtype * const aDurationPtr);</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineplus">+class calDuration final : public calIDurationLibical {</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineplus">+ public:</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineplus">+  calDuration();</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineplus">+  calDuration(const calDuration&amp; cdt);</span>
<a href="#l6.26"></a><span id="l6.26" class="difflineplus">+  explicit calDuration(const struct icaldurationtype* const aDurationPtr);</span>
<a href="#l6.27"></a><span id="l6.27"> </span>
<a href="#l6.28"></a><span id="l6.28" class="difflineminus">-    // nsISupports interface</span>
<a href="#l6.29"></a><span id="l6.29" class="difflineminus">-    NS_DECL_ISUPPORTS</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineplus">+  // nsISupports interface</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineplus">+  NS_DECL_ISUPPORTS</span>
<a href="#l6.32"></a><span id="l6.32"> </span>
<a href="#l6.33"></a><span id="l6.33" class="difflineminus">-    // calIDateTime interface</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineminus">-    NS_DECL_CALIDURATION</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineminus">-    NS_DECL_CALIDURATIONLIBICAL</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineplus">+  // calIDateTime interface</span>
<a href="#l6.37"></a><span id="l6.37" class="difflineplus">+  NS_DECL_CALIDURATION</span>
<a href="#l6.38"></a><span id="l6.38" class="difflineplus">+  NS_DECL_CALIDURATIONLIBICAL</span>
<a href="#l6.39"></a><span id="l6.39"> </span>
<a href="#l6.40"></a><span id="l6.40" class="difflineminus">-protected:</span>
<a href="#l6.41"></a><span id="l6.41" class="difflineminus">-    ~calDuration() {}</span>
<a href="#l6.42"></a><span id="l6.42" class="difflineminus">-    bool mImmutable;</span>
<a href="#l6.43"></a><span id="l6.43" class="difflineplus">+ protected:</span>
<a href="#l6.44"></a><span id="l6.44" class="difflineplus">+  ~calDuration() {}</span>
<a href="#l6.45"></a><span id="l6.45" class="difflineplus">+  bool mImmutable;</span>
<a href="#l6.46"></a><span id="l6.46"> </span>
<a href="#l6.47"></a><span id="l6.47" class="difflineminus">-    struct icaldurationtype mDuration;</span>
<a href="#l6.48"></a><span id="l6.48" class="difflineplus">+  struct icaldurationtype mDuration;</span>
<a href="#l6.49"></a><span id="l6.49"> </span>
<a href="#l6.50"></a><span id="l6.50" class="difflineminus">-    void FromIcalDuration(const struct icaldurationtype * const icald);</span>
<a href="#l6.51"></a><span id="l6.51" class="difflineplus">+  void FromIcalDuration(const struct icaldurationtype* const icald);</span>
<a href="#l6.52"></a><span id="l6.52"> };</span>
<a href="#l6.53"></a><span id="l6.53"> </span>
<a href="#l6.54"></a><span id="l6.54"> #endif /* CALDURATION_H_ */</span>
<a href="#l6.55"></a><span id="l6.55" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/calendar/base/backend/libical/calICSService.cpp</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/calendar/base/backend/libical/calICSService.cpp</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -10,940 +10,867 @@</span>
<a href="#l7.4"></a><span id="l7.4"> #include &quot;calDuration.h&quot;</span>
<a href="#l7.5"></a><span id="l7.5"> #include &quot;calIErrors.h&quot;</span>
<a href="#l7.6"></a><span id="l7.6"> #include &quot;calUtils.h&quot;</span>
<a href="#l7.7"></a><span id="l7.7"> </span>
<a href="#l7.8"></a><span id="l7.8"> extern &quot;C&quot; {</span>
<a href="#l7.9"></a><span id="l7.9"> #include &quot;ical.h&quot;</span>
<a href="#l7.10"></a><span id="l7.10"> }</span>
<a href="#l7.11"></a><span id="l7.11"> </span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-calIcalProperty::~calIcalProperty()</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">-{</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineminus">-    if (!mParent) {</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineminus">-        icalproperty_free(mProperty);</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineminus">-    }</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineplus">+calIcalProperty::~calIcalProperty() {</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineplus">+  if (!mParent) {</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineplus">+    icalproperty_free(mProperty);</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineplus">+  }</span>
<a href="#l7.21"></a><span id="l7.21"> }</span>
<a href="#l7.22"></a><span id="l7.22"> </span>
<a href="#l7.23"></a><span id="l7.23"> NS_IMPL_CLASSINFO(calIcalProperty, nullptr, 0, CAL_ICALPROPERTY_CID)</span>
<a href="#l7.24"></a><span id="l7.24"> NS_IMPL_ISUPPORTS_CI(calIcalProperty, calIIcalProperty, calIIcalPropertyLibical)</span>
<a href="#l7.25"></a><span id="l7.25"> </span>
<a href="#l7.26"></a><span id="l7.26"> NS_IMETHODIMP_(icalproperty *)</span>
<a href="#l7.27"></a><span id="l7.27" class="difflineminus">-calIcalProperty::GetLibicalProperty()</span>
<a href="#l7.28"></a><span id="l7.28" class="difflineminus">-{</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineminus">-    return mProperty;</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineminus">-}</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineplus">+calIcalProperty::GetLibicalProperty() { return mProperty; }</span>
<a href="#l7.32"></a><span id="l7.32"> </span>
<a href="#l7.33"></a><span id="l7.33"> NS_IMETHODIMP_(icalcomponent *)</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineminus">-calIcalProperty::GetLibicalComponent()</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineminus">-{</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineminus">-    return mParent-&gt;GetLibicalComponent();</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineplus">+calIcalProperty::GetLibicalComponent() {</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineplus">+  return mParent-&gt;GetLibicalComponent();</span>
<a href="#l7.39"></a><span id="l7.39"> }</span>
<a href="#l7.40"></a><span id="l7.40"> </span>
<a href="#l7.41"></a><span id="l7.41"> NS_IMETHODIMP</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineminus">-calIcalProperty::GetIcalString(nsACString &amp;str)</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineminus">-{</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineminus">-    char const* icalstr = icalproperty_as_ical_string(mProperty);</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineminus">-    if (icalstr == 0) {</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineplus">+calIcalProperty::GetIcalString(nsACString &amp;str) {</span>
<a href="#l7.47"></a><span id="l7.47" class="difflineplus">+  char const *icalstr = icalproperty_as_ical_string(mProperty);</span>
<a href="#l7.48"></a><span id="l7.48" class="difflineplus">+  if (icalstr == 0) {</span>
<a href="#l7.49"></a><span id="l7.49"> #ifdef DEBUG</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineminus">-        fprintf(stderr, &quot;Error getting ical string: %d (%s)\n&quot;,</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineminus">-                icalerrno, icalerror_strerror(icalerrno));</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineplus">+    fprintf(stderr, &quot;Error getting ical string: %d (%s)\n&quot;, icalerrno,</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineplus">+            icalerror_strerror(icalerrno));</span>
<a href="#l7.54"></a><span id="l7.54"> #endif</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineminus">-        return static_cast&lt;nsresult&gt;(calIErrors::ICS_ERROR_BASE + icalerrno);</span>
<a href="#l7.56"></a><span id="l7.56" class="difflineminus">-    }</span>
<a href="#l7.57"></a><span id="l7.57" class="difflineminus">-    str.Assign(icalstr);</span>
<a href="#l7.58"></a><span id="l7.58" class="difflineminus">-    return NS_OK;</span>
<a href="#l7.59"></a><span id="l7.59" class="difflineplus">+    return static_cast&lt;nsresult&gt;(calIErrors::ICS_ERROR_BASE + icalerrno);</span>
<a href="#l7.60"></a><span id="l7.60" class="difflineplus">+  }</span>
<a href="#l7.61"></a><span id="l7.61" class="difflineplus">+  str.Assign(icalstr);</span>
<a href="#l7.62"></a><span id="l7.62" class="difflineplus">+  return NS_OK;</span>
<a href="#l7.63"></a><span id="l7.63"> }</span>
<a href="#l7.64"></a><span id="l7.64"> </span>
<a href="#l7.65"></a><span id="l7.65"> NS_IMETHODIMP</span>
<a href="#l7.66"></a><span id="l7.66" class="difflineminus">-calIcalProperty::ToString(nsACString&amp; aResult)</span>
<a href="#l7.67"></a><span id="l7.67" class="difflineminus">-{</span>
<a href="#l7.68"></a><span id="l7.68" class="difflineminus">-    return GetIcalString(aResult);</span>
<a href="#l7.69"></a><span id="l7.69" class="difflineplus">+calIcalProperty::ToString(nsACString &amp;aResult) {</span>
<a href="#l7.70"></a><span id="l7.70" class="difflineplus">+  return GetIcalString(aResult);</span>
<a href="#l7.71"></a><span id="l7.71"> }</span>
<a href="#l7.72"></a><span id="l7.72"> </span>
<a href="#l7.73"></a><span id="l7.73"> NS_IMETHODIMP</span>
<a href="#l7.74"></a><span id="l7.74" class="difflineminus">-calIcalProperty::GetValue(nsACString &amp;str)</span>
<a href="#l7.75"></a><span id="l7.75" class="difflineminus">-{</span>
<a href="#l7.76"></a><span id="l7.76" class="difflineminus">-    icalvalue *value = icalproperty_get_value(mProperty);</span>
<a href="#l7.77"></a><span id="l7.77" class="difflineminus">-    icalvalue_kind valuekind = icalvalue_isa(value);</span>
<a href="#l7.78"></a><span id="l7.78" class="difflineplus">+calIcalProperty::GetValue(nsACString &amp;str) {</span>
<a href="#l7.79"></a><span id="l7.79" class="difflineplus">+  icalvalue *value = icalproperty_get_value(mProperty);</span>
<a href="#l7.80"></a><span id="l7.80" class="difflineplus">+  icalvalue_kind valuekind = icalvalue_isa(value);</span>
<a href="#l7.81"></a><span id="l7.81"> </span>
<a href="#l7.82"></a><span id="l7.82" class="difflineminus">-    const char *icalstr;</span>
<a href="#l7.83"></a><span id="l7.83" class="difflineminus">-    if (valuekind == ICAL_TEXT_VALUE) {</span>
<a href="#l7.84"></a><span id="l7.84" class="difflineminus">-        icalstr = icalvalue_get_text(value);</span>
<a href="#l7.85"></a><span id="l7.85" class="difflineminus">-    } else if (valuekind == ICAL_X_VALUE) {</span>
<a href="#l7.86"></a><span id="l7.86" class="difflineminus">-        icalstr = icalvalue_get_x(value);</span>
<a href="#l7.87"></a><span id="l7.87" class="difflineminus">-    } else if (valuekind == ICAL_ATTACH_VALUE) {</span>
<a href="#l7.88"></a><span id="l7.88" class="difflineminus">-        icalattach *attach = icalvalue_get_attach(value);</span>
<a href="#l7.89"></a><span id="l7.89" class="difflineminus">-        if (icalattach_get_is_url(attach)) {</span>
<a href="#l7.90"></a><span id="l7.90" class="difflineminus">-            icalstr = icalattach_get_url(attach);</span>
<a href="#l7.91"></a><span id="l7.91" class="difflineminus">-        } else {</span>
<a href="#l7.92"></a><span id="l7.92" class="difflineminus">-            icalstr = (const char *)icalattach_get_data(attach);</span>
<a href="#l7.93"></a><span id="l7.93" class="difflineminus">-        }</span>
<a href="#l7.94"></a><span id="l7.94" class="difflineplus">+  const char *icalstr;</span>
<a href="#l7.95"></a><span id="l7.95" class="difflineplus">+  if (valuekind == ICAL_TEXT_VALUE) {</span>
<a href="#l7.96"></a><span id="l7.96" class="difflineplus">+    icalstr = icalvalue_get_text(value);</span>
<a href="#l7.97"></a><span id="l7.97" class="difflineplus">+  } else if (valuekind == ICAL_X_VALUE) {</span>
<a href="#l7.98"></a><span id="l7.98" class="difflineplus">+    icalstr = icalvalue_get_x(value);</span>
<a href="#l7.99"></a><span id="l7.99" class="difflineplus">+  } else if (valuekind == ICAL_ATTACH_VALUE) {</span>
<a href="#l7.100"></a><span id="l7.100" class="difflineplus">+    icalattach *attach = icalvalue_get_attach(value);</span>
<a href="#l7.101"></a><span id="l7.101" class="difflineplus">+    if (icalattach_get_is_url(attach)) {</span>
<a href="#l7.102"></a><span id="l7.102" class="difflineplus">+      icalstr = icalattach_get_url(attach);</span>
<a href="#l7.103"></a><span id="l7.103">     } else {</span>
<a href="#l7.104"></a><span id="l7.104" class="difflineminus">-        icalstr = icalproperty_get_value_as_string(mProperty);</span>
<a href="#l7.105"></a><span id="l7.105" class="difflineplus">+      icalstr = (const char *)icalattach_get_data(attach);</span>
<a href="#l7.106"></a><span id="l7.106" class="difflineplus">+    }</span>
<a href="#l7.107"></a><span id="l7.107" class="difflineplus">+  } else {</span>
<a href="#l7.108"></a><span id="l7.108" class="difflineplus">+    icalstr = icalproperty_get_value_as_string(mProperty);</span>
<a href="#l7.109"></a><span id="l7.109" class="difflineplus">+  }</span>
<a href="#l7.110"></a><span id="l7.110" class="difflineplus">+</span>
<a href="#l7.111"></a><span id="l7.111" class="difflineplus">+  if (!icalstr) {</span>
<a href="#l7.112"></a><span id="l7.112" class="difflineplus">+    if (icalerrno == ICAL_BADARG_ERROR) {</span>
<a href="#l7.113"></a><span id="l7.113" class="difflineplus">+      str.Truncate();</span>
<a href="#l7.114"></a><span id="l7.114" class="difflineplus">+      // Set string to null, because we don't have a value</span>
<a href="#l7.115"></a><span id="l7.115" class="difflineplus">+      // (which is something different then an empty value)</span>
<a href="#l7.116"></a><span id="l7.116" class="difflineplus">+      str.SetIsVoid(true);</span>
<a href="#l7.117"></a><span id="l7.117" class="difflineplus">+      return NS_OK;</span>
<a href="#l7.118"></a><span id="l7.118">     }</span>
<a href="#l7.119"></a><span id="l7.119"> </span>
<a href="#l7.120"></a><span id="l7.120" class="difflineminus">-    if (!icalstr) {</span>
<a href="#l7.121"></a><span id="l7.121" class="difflineminus">-        if (icalerrno == ICAL_BADARG_ERROR) {</span>
<a href="#l7.122"></a><span id="l7.122" class="difflineminus">-            str.Truncate();</span>
<a href="#l7.123"></a><span id="l7.123" class="difflineminus">-            // Set string to null, because we don't have a value</span>
<a href="#l7.124"></a><span id="l7.124" class="difflineminus">-            // (which is something different then an empty value)</span>
<a href="#l7.125"></a><span id="l7.125" class="difflineminus">-            str.SetIsVoid(true);</span>
<a href="#l7.126"></a><span id="l7.126" class="difflineminus">-            return NS_OK;</span>
<a href="#l7.127"></a><span id="l7.127" class="difflineminus">-        }</span>
<a href="#l7.128"></a><span id="l7.128" class="difflineplus">+#ifdef DEBUG</span>
<a href="#l7.129"></a><span id="l7.129" class="difflineplus">+    fprintf(stderr, &quot;Error getting string value: %d (%s)\n&quot;, icalerrno,</span>
<a href="#l7.130"></a><span id="l7.130" class="difflineplus">+            icalerror_strerror(icalerrno));</span>
<a href="#l7.131"></a><span id="l7.131" class="difflineplus">+#endif</span>
<a href="#l7.132"></a><span id="l7.132" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l7.133"></a><span id="l7.133" class="difflineplus">+  }</span>
<a href="#l7.134"></a><span id="l7.134"> </span>
<a href="#l7.135"></a><span id="l7.135" class="difflineminus">-#ifdef DEBUG</span>
<a href="#l7.136"></a><span id="l7.136" class="difflineminus">-        fprintf(stderr, &quot;Error getting string value: %d (%s)\n&quot;,</span>
<a href="#l7.137"></a><span id="l7.137" class="difflineminus">-                icalerrno, icalerror_strerror(icalerrno));</span>
<a href="#l7.138"></a><span id="l7.138" class="difflineminus">-#endif</span>
<a href="#l7.139"></a><span id="l7.139" class="difflineminus">-        return NS_ERROR_FAILURE;</span>
<a href="#l7.140"></a><span id="l7.140" class="difflineminus">-    }</span>
<a href="#l7.141"></a><span id="l7.141" class="difflineminus">-</span>
<a href="#l7.142"></a><span id="l7.142" class="difflineminus">-    str.Assign(icalstr);</span>
<a href="#l7.143"></a><span id="l7.143" class="difflineminus">-    return NS_OK;</span>
<a href="#l7.144"></a><span id="l7.144" class="difflineplus">+  str.Assign(icalstr);</span>
<a href="#l7.145"></a><span id="l7.145" class="difflineplus">+  return NS_OK;</span>
<a href="#l7.146"></a><span id="l7.146"> }</span>
<a href="#l7.147"></a><span id="l7.147"> </span>
<a href="#l7.148"></a><span id="l7.148"> NS_IMETHODIMP</span>
<a href="#l7.149"></a><span id="l7.149" class="difflineminus">-calIcalProperty::SetValue(const nsACString &amp;str)</span>
<a href="#l7.150"></a><span id="l7.150" class="difflineminus">-{</span>
<a href="#l7.151"></a><span id="l7.151" class="difflineminus">-    icalvalue_kind kind = icalproperty_kind_to_value_kind(icalproperty_isa(mProperty));</span>
<a href="#l7.152"></a><span id="l7.152" class="difflineminus">-    if (kind == ICAL_TEXT_VALUE) {</span>
<a href="#l7.153"></a><span id="l7.153" class="difflineminus">-        icalvalue *v = icalvalue_new_text(PromiseFlatCString(str).get());</span>
<a href="#l7.154"></a><span id="l7.154" class="difflineminus">-        icalproperty_set_value(mProperty, v);</span>
<a href="#l7.155"></a><span id="l7.155" class="difflineminus">-    } else if (kind == ICAL_X_VALUE) {</span>
<a href="#l7.156"></a><span id="l7.156" class="difflineminus">-        icalvalue *v = icalvalue_new_x(PromiseFlatCString(str).get());</span>
<a href="#l7.157"></a><span id="l7.157" class="difflineminus">-        icalproperty_set_value(mProperty, v);</span>
<a href="#l7.158"></a><span id="l7.158" class="difflineminus">-    } else if (kind == ICAL_ATTACH_VALUE) {</span>
<a href="#l7.159"></a><span id="l7.159" class="difflineminus">-        icalattach *v = icalattach_new_from_data(PromiseFlatCString(str).get(), nullptr, nullptr);</span>
<a href="#l7.160"></a><span id="l7.160" class="difflineminus">-        icalproperty_set_attach(mProperty, v);</span>
<a href="#l7.161"></a><span id="l7.161" class="difflineminus">-    } else {</span>
<a href="#l7.162"></a><span id="l7.162" class="difflineminus">-        icalproperty_set_value_from_string(mProperty,</span>
<a href="#l7.163"></a><span id="l7.163" class="difflineminus">-                                           PromiseFlatCString(str).get(),</span>
<a href="#l7.164"></a><span id="l7.164" class="difflineminus">-                                           icalvalue_kind_to_string(kind));</span>
<a href="#l7.165"></a><span id="l7.165" class="difflineminus">-    }</span>
<a href="#l7.166"></a><span id="l7.166" class="difflineminus">-    return NS_OK;</span>
<a href="#l7.167"></a><span id="l7.167" class="difflineplus">+calIcalProperty::SetValue(const nsACString &amp;str) {</span>
<a href="#l7.168"></a><span id="l7.168" class="difflineplus">+  icalvalue_kind kind =</span>
<a href="#l7.169"></a><span id="l7.169" class="difflineplus">+      icalproperty_kind_to_value_kind(icalproperty_isa(mProperty));</span>
<a href="#l7.170"></a><span id="l7.170" class="difflineplus">+  if (kind == ICAL_TEXT_VALUE) {</span>
<a href="#l7.171"></a><span id="l7.171" class="difflineplus">+    icalvalue *v = icalvalue_new_text(PromiseFlatCString(str).get());</span>
<a href="#l7.172"></a><span id="l7.172" class="difflineplus">+    icalproperty_set_value(mProperty, v);</span>
<a href="#l7.173"></a><span id="l7.173" class="difflineplus">+  } else if (kind == ICAL_X_VALUE) {</span>
<a href="#l7.174"></a><span id="l7.174" class="difflineplus">+    icalvalue *v = icalvalue_new_x(PromiseFlatCString(str).get());</span>
<a href="#l7.175"></a><span id="l7.175" class="difflineplus">+    icalproperty_set_value(mProperty, v);</span>
<a href="#l7.176"></a><span id="l7.176" class="difflineplus">+  } else if (kind == ICAL_ATTACH_VALUE) {</span>
<a href="#l7.177"></a><span id="l7.177" class="difflineplus">+    icalattach *v = icalattach_new_from_data(PromiseFlatCString(str).get(),</span>
<a href="#l7.178"></a><span id="l7.178" class="difflineplus">+                                             nullptr, nullptr);</span>
<a href="#l7.179"></a><span id="l7.179" class="difflineplus">+    icalproperty_set_attach(mProperty, v);</span>
<a href="#l7.180"></a><span id="l7.180" class="difflineplus">+  } else {</span>
<a href="#l7.181"></a><span id="l7.181" class="difflineplus">+    icalproperty_set_value_from_string(mProperty, PromiseFlatCString(str).get(),</span>
<a href="#l7.182"></a><span id="l7.182" class="difflineplus">+                                       icalvalue_kind_to_string(kind));</span>
<a href="#l7.183"></a><span id="l7.183" class="difflineplus">+  }</span>
<a href="#l7.184"></a><span id="l7.184" class="difflineplus">+  return NS_OK;</span>
<a href="#l7.185"></a><span id="l7.185"> }</span>
<a href="#l7.186"></a><span id="l7.186"> </span>
<a href="#l7.187"></a><span id="l7.187"> NS_IMETHODIMP</span>
<a href="#l7.188"></a><span id="l7.188" class="difflineminus">-calIcalProperty::GetValueAsIcalString(nsACString &amp;str)</span>
<a href="#l7.189"></a><span id="l7.189" class="difflineminus">-{</span>
<a href="#l7.190"></a><span id="l7.190" class="difflineminus">-    const char *icalstr = icalproperty_get_value_as_string(mProperty);</span>
<a href="#l7.191"></a><span id="l7.191" class="difflineminus">-    if (!icalstr) {</span>
<a href="#l7.192"></a><span id="l7.192" class="difflineminus">-        if (icalerrno == ICAL_BADARG_ERROR) {</span>
<a href="#l7.193"></a><span id="l7.193" class="difflineminus">-            str.Truncate();</span>
<a href="#l7.194"></a><span id="l7.194" class="difflineminus">-            // Set string to null, because we don't have a value</span>
<a href="#l7.195"></a><span id="l7.195" class="difflineminus">-            // (which is something different then an empty value)</span>
<a href="#l7.196"></a><span id="l7.196" class="difflineminus">-            str.SetIsVoid(true);</span>
<a href="#l7.197"></a><span id="l7.197" class="difflineminus">-            return NS_OK;</span>
<a href="#l7.198"></a><span id="l7.198" class="difflineminus">-        }</span>
<a href="#l7.199"></a><span id="l7.199" class="difflineplus">+calIcalProperty::GetValueAsIcalString(nsACString &amp;str) {</span>
<a href="#l7.200"></a><span id="l7.200" class="difflineplus">+  const char *icalstr = icalproperty_get_value_as_string(mProperty);</span>
<a href="#l7.201"></a><span id="l7.201" class="difflineplus">+  if (!icalstr) {</span>
<a href="#l7.202"></a><span id="l7.202" class="difflineplus">+    if (icalerrno == ICAL_BADARG_ERROR) {</span>
<a href="#l7.203"></a><span id="l7.203" class="difflineplus">+      str.Truncate();</span>
<a href="#l7.204"></a><span id="l7.204" class="difflineplus">+      // Set string to null, because we don't have a value</span>
<a href="#l7.205"></a><span id="l7.205" class="difflineplus">+      // (which is something different then an empty value)</span>
<a href="#l7.206"></a><span id="l7.206" class="difflineplus">+      str.SetIsVoid(true);</span>
<a href="#l7.207"></a><span id="l7.207" class="difflineplus">+      return NS_OK;</span>
<a href="#l7.208"></a><span id="l7.208" class="difflineplus">+    }</span>
<a href="#l7.209"></a><span id="l7.209"> </span>
<a href="#l7.210"></a><span id="l7.210"> #ifdef DEBUG</span>
<a href="#l7.211"></a><span id="l7.211" class="difflineminus">-        fprintf(stderr, &quot;Error getting string value: %d (%s)\n&quot;,</span>
<a href="#l7.212"></a><span id="l7.212" class="difflineminus">-                icalerrno, icalerror_strerror(icalerrno));</span>
<a href="#l7.213"></a><span id="l7.213" class="difflineplus">+    fprintf(stderr, &quot;Error getting string value: %d (%s)\n&quot;, icalerrno,</span>
<a href="#l7.214"></a><span id="l7.214" class="difflineplus">+            icalerror_strerror(icalerrno));</span>
<a href="#l7.215"></a><span id="l7.215"> #endif</span>
<a href="#l7.216"></a><span id="l7.216" class="difflineminus">-        return NS_ERROR_FAILURE;</span>
<a href="#l7.217"></a><span id="l7.217" class="difflineminus">-    }</span>
<a href="#l7.218"></a><span id="l7.218" class="difflineminus">-</span>
<a href="#l7.219"></a><span id="l7.219" class="difflineminus">-    str.Assign(icalstr);</span>
<a href="#l7.220"></a><span id="l7.220" class="difflineminus">-    return NS_OK;</span>
<a href="#l7.221"></a><span id="l7.221" class="difflineminus">-}</span>
<a href="#l7.222"></a><span id="l7.222" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l7.223"></a><span id="l7.223" class="difflineplus">+  }</span>
<a href="#l7.224"></a><span id="l7.224"> </span>
<a href="#l7.225"></a><span id="l7.225" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l7.226"></a><span id="l7.226" class="difflineminus">-calIcalProperty::SetValueAsIcalString(const nsACString &amp;str)</span>
<a href="#l7.227"></a><span id="l7.227" class="difflineminus">-{</span>
<a href="#l7.228"></a><span id="l7.228" class="difflineminus">-    const char *kindstr =</span>
<a href="#l7.229"></a><span id="l7.229" class="difflineminus">-        icalvalue_kind_to_string(icalproperty_kind_to_value_kind(icalproperty_isa(mProperty)));</span>
<a href="#l7.230"></a><span id="l7.230" class="difflineminus">-    icalproperty_set_value_from_string(mProperty,</span>
<a href="#l7.231"></a><span id="l7.231" class="difflineminus">-                                       PromiseFlatCString(str).get(),</span>
<a href="#l7.232"></a><span id="l7.232" class="difflineminus">-                                       kindstr);</span>
<a href="#l7.233"></a><span id="l7.233" class="difflineminus">-    return NS_OK;</span>
<a href="#l7.234"></a><span id="l7.234" class="difflineplus">+  str.Assign(icalstr);</span>
<a href="#l7.235"></a><span id="l7.235" class="difflineplus">+  return NS_OK;</span>
<a href="#l7.236"></a><span id="l7.236"> }</span>
<a href="#l7.237"></a><span id="l7.237"> </span>
<a href="#l7.238"></a><span id="l7.238"> NS_IMETHODIMP</span>
<a href="#l7.239"></a><span id="l7.239" class="difflineminus">-calIcalProperty::GetPropertyName(nsACString &amp;name)</span>
<a href="#l7.240"></a><span id="l7.240" class="difflineminus">-{</span>
<a href="#l7.241"></a><span id="l7.241" class="difflineminus">-    const char *icalstr = icalproperty_get_property_name(mProperty);</span>
<a href="#l7.242"></a><span id="l7.242" class="difflineminus">-    if (!icalstr) {</span>
<a href="#l7.243"></a><span id="l7.243" class="difflineminus">-#ifdef DEBUG</span>
<a href="#l7.244"></a><span id="l7.244" class="difflineminus">-        fprintf(stderr, &quot;Error getting property name: %d (%s)\n&quot;,</span>
<a href="#l7.245"></a><span id="l7.245" class="difflineminus">-                icalerrno, icalerror_strerror(icalerrno));</span>
<a href="#l7.246"></a><span id="l7.246" class="difflineminus">-#endif</span>
<a href="#l7.247"></a><span id="l7.247" class="difflineminus">-        return NS_ERROR_FAILURE;</span>
<a href="#l7.248"></a><span id="l7.248" class="difflineminus">-    }</span>
<a href="#l7.249"></a><span id="l7.249" class="difflineminus">-    name.Assign(icalstr);</span>
<a href="#l7.250"></a><span id="l7.250" class="difflineminus">-    return NS_OK;</span>
<a href="#l7.251"></a><span id="l7.251" class="difflineminus">-}</span>
<a href="#l7.252"></a><span id="l7.252" class="difflineminus">-</span>
<a href="#l7.253"></a><span id="l7.253" class="difflineminus">-static icalparameter*</span>
<a href="#l7.254"></a><span id="l7.254" class="difflineminus">-FindParameter(icalproperty *prop, const nsACString &amp;param, icalparameter_kind kind)</span>
<a href="#l7.255"></a><span id="l7.255" class="difflineminus">-{</span>
<a href="#l7.256"></a><span id="l7.256" class="difflineminus">-    for (icalparameter *icalparam =</span>
<a href="#l7.257"></a><span id="l7.257" class="difflineminus">-             icalproperty_get_first_parameter(prop, kind);</span>
<a href="#l7.258"></a><span id="l7.258" class="difflineminus">-         icalparam;</span>
<a href="#l7.259"></a><span id="l7.259" class="difflineminus">-         icalparam = icalproperty_get_next_parameter(prop, kind)) {</span>
<a href="#l7.260"></a><span id="l7.260" class="difflineminus">-        if (param.Equals(icalparameter_get_xname(icalparam)))</span>
<a href="#l7.261"></a><span id="l7.261" class="difflineminus">-            return icalparam;</span>
<a href="#l7.262"></a><span id="l7.262" class="difflineminus">-    }</span>
<a href="#l7.263"></a><span id="l7.263" class="difflineminus">-    return nullptr;</span>
<a href="#l7.264"></a><span id="l7.264" class="difflineplus">+calIcalProperty::SetValueAsIcalString(const nsACString &amp;str) {</span>
<a href="#l7.265"></a><span id="l7.265" class="difflineplus">+  const char *kindstr = icalvalue_kind_to_string(</span>
<a href="#l7.266"></a><span id="l7.266" class="difflineplus">+      icalproperty_kind_to_value_kind(icalproperty_isa(mProperty)));</span>
<a href="#l7.267"></a><span id="l7.267" class="difflineplus">+  icalproperty_set_value_from_string(mProperty, PromiseFlatCString(str).get(),</span>
<a href="#l7.268"></a><span id="l7.268" class="difflineplus">+                                     kindstr);</span>
<a href="#l7.269"></a><span id="l7.269" class="difflineplus">+  return NS_OK;</span>
<a href="#l7.270"></a><span id="l7.270"> }</span>
<a href="#l7.271"></a><span id="l7.271"> </span>
<a href="#l7.272"></a><span id="l7.272"> NS_IMETHODIMP</span>
<a href="#l7.273"></a><span id="l7.273" class="difflineminus">-calIcalProperty::GetParameter(const nsACString &amp;param, nsACString &amp;value)</span>
<a href="#l7.274"></a><span id="l7.274" class="difflineminus">-{</span>
<a href="#l7.275"></a><span id="l7.275" class="difflineminus">-    // More ridiculous parameter/X-PARAMETER handling.</span>
<a href="#l7.276"></a><span id="l7.276" class="difflineminus">-    icalparameter_kind paramkind =</span>
<a href="#l7.277"></a><span id="l7.277" class="difflineminus">-        icalparameter_string_to_kind(PromiseFlatCString(param).get());</span>
<a href="#l7.278"></a><span id="l7.278" class="difflineplus">+calIcalProperty::GetPropertyName(nsACString &amp;name) {</span>
<a href="#l7.279"></a><span id="l7.279" class="difflineplus">+  const char *icalstr = icalproperty_get_property_name(mProperty);</span>
<a href="#l7.280"></a><span id="l7.280" class="difflineplus">+  if (!icalstr) {</span>
<a href="#l7.281"></a><span id="l7.281" class="difflineplus">+#ifdef DEBUG</span>
<a href="#l7.282"></a><span id="l7.282" class="difflineplus">+    fprintf(stderr, &quot;Error getting property name: %d (%s)\n&quot;, icalerrno,</span>
<a href="#l7.283"></a><span id="l7.283" class="difflineplus">+            icalerror_strerror(icalerrno));</span>
<a href="#l7.284"></a><span id="l7.284" class="difflineplus">+#endif</span>
<a href="#l7.285"></a><span id="l7.285" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l7.286"></a><span id="l7.286" class="difflineplus">+  }</span>
<a href="#l7.287"></a><span id="l7.287" class="difflineplus">+  name.Assign(icalstr);</span>
<a href="#l7.288"></a><span id="l7.288" class="difflineplus">+  return NS_OK;</span>
<a href="#l7.289"></a><span id="l7.289" class="difflineplus">+}</span>
<a href="#l7.290"></a><span id="l7.290"> </span>
<a href="#l7.291"></a><span id="l7.291" class="difflineminus">-    if (paramkind == ICAL_NO_PARAMETER)</span>
<a href="#l7.292"></a><span id="l7.292" class="difflineminus">-        return NS_ERROR_INVALID_ARG;</span>
<a href="#l7.293"></a><span id="l7.293" class="difflineplus">+static icalparameter *FindParameter(icalproperty *prop, const nsACString &amp;param,</span>
<a href="#l7.294"></a><span id="l7.294" class="difflineplus">+                                    icalparameter_kind kind) {</span>
<a href="#l7.295"></a><span id="l7.295" class="difflineplus">+  for (icalparameter *icalparam = icalproperty_get_first_parameter(prop, kind);</span>
<a href="#l7.296"></a><span id="l7.296" class="difflineplus">+       icalparam; icalparam = icalproperty_get_next_parameter(prop, kind)) {</span>
<a href="#l7.297"></a><span id="l7.297" class="difflineplus">+    if (param.Equals(icalparameter_get_xname(icalparam))) return icalparam;</span>
<a href="#l7.298"></a><span id="l7.298" class="difflineplus">+  }</span>
<a href="#l7.299"></a><span id="l7.299" class="difflineplus">+  return nullptr;</span>
<a href="#l7.300"></a><span id="l7.300" class="difflineplus">+}</span>
<a href="#l7.301"></a><span id="l7.301"> </span>
<a href="#l7.302"></a><span id="l7.302" class="difflineminus">-    const char *icalstr = nullptr;</span>
<a href="#l7.303"></a><span id="l7.303" class="difflineminus">-    if (paramkind == ICAL_X_PARAMETER) {</span>
<a href="#l7.304"></a><span id="l7.304" class="difflineminus">-        icalparameter *icalparam = FindParameter(mProperty, param, ICAL_X_PARAMETER);</span>
<a href="#l7.305"></a><span id="l7.305" class="difflineminus">-        if (icalparam)</span>
<a href="#l7.306"></a><span id="l7.306" class="difflineminus">-            icalstr = icalparameter_get_xvalue(icalparam);</span>
<a href="#l7.307"></a><span id="l7.307" class="difflineminus">-    } else if (paramkind == ICAL_IANA_PARAMETER) {</span>
<a href="#l7.308"></a><span id="l7.308" class="difflineminus">-        icalparameter *icalparam = FindParameter(mProperty, param, ICAL_IANA_PARAMETER);</span>
<a href="#l7.309"></a><span id="l7.309" class="difflineminus">-        if (icalparam)</span>
<a href="#l7.310"></a><span id="l7.310" class="difflineminus">-            icalstr = icalparameter_get_iana_value(icalparam);</span>
<a href="#l7.311"></a><span id="l7.311" class="difflineminus">-    } else {</span>
<a href="#l7.312"></a><span id="l7.312" class="difflineminus">-        icalstr = icalproperty_get_parameter_as_string(mProperty,</span>
<a href="#l7.313"></a><span id="l7.313" class="difflineminus">-                                                       PromiseFlatCString(param).get());</span>
<a href="#l7.314"></a><span id="l7.314" class="difflineminus">-    }</span>
<a href="#l7.315"></a><span id="l7.315" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l7.316"></a><span id="l7.316" class="difflineplus">+calIcalProperty::GetParameter(const nsACString &amp;param, nsACString &amp;value) {</span>
<a href="#l7.317"></a><span id="l7.317" class="difflineplus">+  // More ridiculous parameter/X-PARAMETER handling.</span>
<a href="#l7.318"></a><span id="l7.318" class="difflineplus">+  icalparameter_kind paramkind =</span>
<a href="#l7.319"></a><span id="l7.319" class="difflineplus">+      icalparameter_string_to_kind(PromiseFlatCString(param).get());</span>
<a href="#l7.320"></a><span id="l7.320" class="difflineplus">+</span>
<a href="#l7.321"></a><span id="l7.321" class="difflineplus">+  if (paramkind == ICAL_NO_PARAMETER) return NS_ERROR_INVALID_ARG;</span>
<a href="#l7.322"></a><span id="l7.322"> </span>
<a href="#l7.323"></a><span id="l7.323" class="difflineminus">-    if (!icalstr) {</span>
<a href="#l7.324"></a><span id="l7.324" class="difflineminus">-        value.Truncate();</span>
<a href="#l7.325"></a><span id="l7.325" class="difflineminus">-        value.SetIsVoid(true);</span>
<a href="#l7.326"></a><span id="l7.326" class="difflineminus">-    } else {</span>
<a href="#l7.327"></a><span id="l7.327" class="difflineminus">-        value.Assign(icalstr);</span>
<a href="#l7.328"></a><span id="l7.328" class="difflineminus">-    }</span>
<a href="#l7.329"></a><span id="l7.329" class="difflineminus">-    return NS_OK;</span>
<a href="#l7.330"></a><span id="l7.330" class="difflineplus">+  const char *icalstr = nullptr;</span>
<a href="#l7.331"></a><span id="l7.331" class="difflineplus">+  if (paramkind == ICAL_X_PARAMETER) {</span>
<a href="#l7.332"></a><span id="l7.332" class="difflineplus">+    icalparameter *icalparam =</span>
<a href="#l7.333"></a><span id="l7.333" class="difflineplus">+        FindParameter(mProperty, param, ICAL_X_PARAMETER);</span>
<a href="#l7.334"></a><span id="l7.334" class="difflineplus">+    if (icalparam) icalstr = icalparameter_get_xvalue(icalparam);</span>
<a href="#l7.335"></a><span id="l7.335" class="difflineplus">+  } else if (paramkind == ICAL_IANA_PARAMETER) {</span>
<a href="#l7.336"></a><span id="l7.336" class="difflineplus">+    icalparameter *icalparam =</span>
<a href="#l7.337"></a><span id="l7.337" class="difflineplus">+        FindParameter(mProperty, param, ICAL_IANA_PARAMETER);</span>
<a href="#l7.338"></a><span id="l7.338" class="difflineplus">+    if (icalparam) icalstr = icalparameter_get_iana_value(icalparam);</span>
<a href="#l7.339"></a><span id="l7.339" class="difflineplus">+  } else {</span>
<a href="#l7.340"></a><span id="l7.340" class="difflineplus">+    icalstr = icalproperty_get_parameter_as_string(</span>
<a href="#l7.341"></a><span id="l7.341" class="difflineplus">+        mProperty, PromiseFlatCString(param).get());</span>
<a href="#l7.342"></a><span id="l7.342" class="difflineplus">+  }</span>
<a href="#l7.343"></a><span id="l7.343" class="difflineplus">+</span>
<a href="#l7.344"></a><span id="l7.344" class="difflineplus">+  if (!icalstr) {</span>
<a href="#l7.345"></a><span id="l7.345" class="difflineplus">+    value.Truncate();</span>
<a href="#l7.346"></a><span id="l7.346" class="difflineplus">+    value.SetIsVoid(true);</span>
<a href="#l7.347"></a><span id="l7.347" class="difflineplus">+  } else {</span>
<a href="#l7.348"></a><span id="l7.348" class="difflineplus">+    value.Assign(icalstr);</span>
<a href="#l7.349"></a><span id="l7.349" class="difflineplus">+  }</span>
<a href="#l7.350"></a><span id="l7.350" class="difflineplus">+  return NS_OK;</span>
<a href="#l7.351"></a><span id="l7.351"> }</span>
<a href="#l7.352"></a><span id="l7.352"> </span>
<a href="#l7.353"></a><span id="l7.353"> NS_IMETHODIMP</span>
<a href="#l7.354"></a><span id="l7.354" class="difflineminus">-calIcalProperty::SetParameter(const nsACString &amp;param, const nsACString &amp;value)</span>
<a href="#l7.355"></a><span id="l7.355" class="difflineminus">-{</span>
<a href="#l7.356"></a><span id="l7.356" class="difflineminus">-    icalparameter_kind paramkind =</span>
<a href="#l7.357"></a><span id="l7.357" class="difflineminus">-        icalparameter_string_to_kind(PromiseFlatCString(param).get());</span>
<a href="#l7.358"></a><span id="l7.358" class="difflineplus">+calIcalProperty::SetParameter(const nsACString &amp;param,</span>
<a href="#l7.359"></a><span id="l7.359" class="difflineplus">+                              const nsACString &amp;value) {</span>
<a href="#l7.360"></a><span id="l7.360" class="difflineplus">+  icalparameter_kind paramkind =</span>
<a href="#l7.361"></a><span id="l7.361" class="difflineplus">+      icalparameter_string_to_kind(PromiseFlatCString(param).get());</span>
<a href="#l7.362"></a><span id="l7.362"> </span>
<a href="#l7.363"></a><span id="l7.363" class="difflineminus">-    if (paramkind == ICAL_NO_PARAMETER)</span>
<a href="#l7.364"></a><span id="l7.364" class="difflineminus">-        return NS_ERROR_INVALID_ARG;</span>
<a href="#l7.365"></a><span id="l7.365" class="difflineplus">+  if (paramkind == ICAL_NO_PARAMETER) return NS_ERROR_INVALID_ARG;</span>
<a href="#l7.366"></a><span id="l7.366"> </span>
<a href="#l7.367"></a><span id="l7.367" class="difflineminus">-    // Because libical's support for manipulating parameters is weak, and</span>
<a href="#l7.368"></a><span id="l7.368" class="difflineminus">-    // X-PARAMETERS doubly so, we walk the list looking for an existing one of</span>
<a href="#l7.369"></a><span id="l7.369" class="difflineminus">-    // that name, and reset its value if found.</span>
<a href="#l7.370"></a><span id="l7.370" class="difflineminus">-    if (paramkind == ICAL_X_PARAMETER) {</span>
<a href="#l7.371"></a><span id="l7.371" class="difflineminus">-        icalparameter *icalparam = FindParameter(mProperty, param, ICAL_X_PARAMETER);</span>
<a href="#l7.372"></a><span id="l7.372" class="difflineminus">-        if (icalparam) {</span>
<a href="#l7.373"></a><span id="l7.373" class="difflineminus">-            icalparameter_set_xvalue(icalparam,</span>
<a href="#l7.374"></a><span id="l7.374" class="difflineminus">-                                     PromiseFlatCString(value).get());</span>
<a href="#l7.375"></a><span id="l7.375" class="difflineminus">-            return NS_OK;</span>
<a href="#l7.376"></a><span id="l7.376" class="difflineminus">-        }</span>
<a href="#l7.377"></a><span id="l7.377" class="difflineminus">-        // If not found, fall through to adding a new parameter below.</span>
<a href="#l7.378"></a><span id="l7.378" class="difflineminus">-    } else if (paramkind == ICAL_IANA_PARAMETER) {</span>
<a href="#l7.379"></a><span id="l7.379" class="difflineminus">-        icalparameter *icalparam = FindParameter(mProperty, param, ICAL_IANA_PARAMETER);</span>
<a href="#l7.380"></a><span id="l7.380" class="difflineminus">-        if (icalparam) {</span>
<a href="#l7.381"></a><span id="l7.381" class="difflineminus">-            icalparameter_set_iana_value(icalparam,</span>
<a href="#l7.382"></a><span id="l7.382" class="difflineminus">-                                         PromiseFlatCString(value).get());</span>
<a href="#l7.383"></a><span id="l7.383" class="difflineminus">-            return NS_OK;</span>
<a href="#l7.384"></a><span id="l7.384" class="difflineminus">-        }</span>
<a href="#l7.385"></a><span id="l7.385" class="difflineminus">-        // If not found, fall through to adding a new parameter below.</span>
<a href="#l7.386"></a><span id="l7.386" class="difflineminus">-    } else {</span>
<a href="#l7.387"></a><span id="l7.387" class="difflineminus">-        // We could try getting an existing parameter here and resetting its</span>
<a href="#l7.388"></a><span id="l7.388" class="difflineminus">-        // value, but this is easier and I don't care that much about parameter</span>
<a href="#l7.389"></a><span id="l7.389" class="difflineminus">-        // performance at this point.</span>
<a href="#l7.390"></a><span id="l7.390" class="difflineminus">-        RemoveParameter(param);</span>
<a href="#l7.391"></a><span id="l7.391" class="difflineplus">+  // Because libical's support for manipulating parameters is weak, and</span>
<a href="#l7.392"></a><span id="l7.392" class="difflineplus">+  // X-PARAMETERS doubly so, we walk the list looking for an existing one of</span>
<a href="#l7.393"></a><span id="l7.393" class="difflineplus">+  // that name, and reset its value if found.</span>
<a href="#l7.394"></a><span id="l7.394" class="difflineplus">+  if (paramkind == ICAL_X_PARAMETER) {</span>
<a href="#l7.395"></a><span id="l7.395" class="difflineplus">+    icalparameter *icalparam =</span>
<a href="#l7.396"></a><span id="l7.396" class="difflineplus">+        FindParameter(mProperty, param, ICAL_X_PARAMETER);</span>
<a href="#l7.397"></a><span id="l7.397" class="difflineplus">+    if (icalparam) {</span>
<a href="#l7.398"></a><span id="l7.398" class="difflineplus">+      icalparameter_set_xvalue(icalparam, PromiseFlatCString(value).get());</span>
<a href="#l7.399"></a><span id="l7.399" class="difflineplus">+      return NS_OK;</span>
<a href="#l7.400"></a><span id="l7.400" class="difflineplus">+    }</span>
<a href="#l7.401"></a><span id="l7.401" class="difflineplus">+    // If not found, fall through to adding a new parameter below.</span>
<a href="#l7.402"></a><span id="l7.402" class="difflineplus">+  } else if (paramkind == ICAL_IANA_PARAMETER) {</span>
<a href="#l7.403"></a><span id="l7.403" class="difflineplus">+    icalparameter *icalparam =</span>
<a href="#l7.404"></a><span id="l7.404" class="difflineplus">+        FindParameter(mProperty, param, ICAL_IANA_PARAMETER);</span>
<a href="#l7.405"></a><span id="l7.405" class="difflineplus">+    if (icalparam) {</span>
<a href="#l7.406"></a><span id="l7.406" class="difflineplus">+      icalparameter_set_iana_value(icalparam, PromiseFlatCString(value).get());</span>
<a href="#l7.407"></a><span id="l7.407" class="difflineplus">+      return NS_OK;</span>
<a href="#l7.408"></a><span id="l7.408">     }</span>
<a href="#l7.409"></a><span id="l7.409" class="difflineplus">+    // If not found, fall through to adding a new parameter below.</span>
<a href="#l7.410"></a><span id="l7.410" class="difflineplus">+  } else {</span>
<a href="#l7.411"></a><span id="l7.411" class="difflineplus">+    // We could try getting an existing parameter here and resetting its</span>
<a href="#l7.412"></a><span id="l7.412" class="difflineplus">+    // value, but this is easier and I don't care that much about parameter</span>
<a href="#l7.413"></a><span id="l7.413" class="difflineplus">+    // performance at this point.</span>
<a href="#l7.414"></a><span id="l7.414" class="difflineplus">+    RemoveParameter(param);</span>
<a href="#l7.415"></a><span id="l7.415" class="difflineplus">+  }</span>
<a href="#l7.416"></a><span id="l7.416"> </span>
<a href="#l7.417"></a><span id="l7.417" class="difflineminus">-    icalparameter *icalparam =</span>
<a href="#l7.418"></a><span id="l7.418" class="difflineminus">-        icalparameter_new_from_value_string(paramkind,</span>
<a href="#l7.419"></a><span id="l7.419" class="difflineminus">-                                            PromiseFlatCString(value).get());</span>
<a href="#l7.420"></a><span id="l7.420" class="difflineminus">-    if (!icalparam)</span>
<a href="#l7.421"></a><span id="l7.421" class="difflineminus">-        return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l7.422"></a><span id="l7.422" class="difflineplus">+  icalparameter *icalparam = icalparameter_new_from_value_string(</span>
<a href="#l7.423"></a><span id="l7.423" class="difflineplus">+      paramkind, PromiseFlatCString(value).get());</span>
<a href="#l7.424"></a><span id="l7.424" class="difflineplus">+  if (!icalparam) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l7.425"></a><span id="l7.425"> </span>
<a href="#l7.426"></a><span id="l7.426" class="difflineminus">-    // You might ask me &quot;why does libical not do this for us?&quot; and I would</span>
<a href="#l7.427"></a><span id="l7.427" class="difflineminus">-    // just nod knowingly but sadly at you in return.</span>
<a href="#l7.428"></a><span id="l7.428" class="difflineminus">-    //</span>
<a href="#l7.429"></a><span id="l7.429" class="difflineminus">-    // You might also, if you were not too distracted by the first question,</span>
<a href="#l7.430"></a><span id="l7.430" class="difflineminus">-    // ask why we have icalproperty_set_x_name but icalparameter_set_xname.</span>
<a href="#l7.431"></a><span id="l7.431" class="difflineminus">-    // More nodding would ensue.</span>
<a href="#l7.432"></a><span id="l7.432" class="difflineminus">-    if (paramkind == ICAL_X_PARAMETER)</span>
<a href="#l7.433"></a><span id="l7.433" class="difflineminus">-        icalparameter_set_xname(icalparam, PromiseFlatCString(param).get());</span>
<a href="#l7.434"></a><span id="l7.434" class="difflineminus">-    else if (paramkind == ICAL_IANA_PARAMETER)</span>
<a href="#l7.435"></a><span id="l7.435" class="difflineminus">-        icalparameter_set_iana_name(icalparam, PromiseFlatCString(param).get());</span>
<a href="#l7.436"></a><span id="l7.436" class="difflineplus">+  // You might ask me &quot;why does libical not do this for us?&quot; and I would</span>
<a href="#l7.437"></a><span id="l7.437" class="difflineplus">+  // just nod knowingly but sadly at you in return.</span>
<a href="#l7.438"></a><span id="l7.438" class="difflineplus">+  //</span>
<a href="#l7.439"></a><span id="l7.439" class="difflineplus">+  // You might also, if you were not too distracted by the first question,</span>
<a href="#l7.440"></a><span id="l7.440" class="difflineplus">+  // ask why we have icalproperty_set_x_name but icalparameter_set_xname.</span>
<a href="#l7.441"></a><span id="l7.441" class="difflineplus">+  // More nodding would ensue.</span>
<a href="#l7.442"></a><span id="l7.442" class="difflineplus">+  if (paramkind == ICAL_X_PARAMETER)</span>
<a href="#l7.443"></a><span id="l7.443" class="difflineplus">+    icalparameter_set_xname(icalparam, PromiseFlatCString(param).get());</span>
<a href="#l7.444"></a><span id="l7.444" class="difflineplus">+  else if (paramkind == ICAL_IANA_PARAMETER)</span>
<a href="#l7.445"></a><span id="l7.445" class="difflineplus">+    icalparameter_set_iana_name(icalparam, PromiseFlatCString(param).get());</span>
<a href="#l7.446"></a><span id="l7.446"> </span>
<a href="#l7.447"></a><span id="l7.447" class="difflineminus">-    icalproperty_add_parameter(mProperty, icalparam);</span>
<a href="#l7.448"></a><span id="l7.448" class="difflineminus">-    // XXX check ical errno</span>
<a href="#l7.449"></a><span id="l7.449" class="difflineminus">-    return NS_OK;</span>
<a href="#l7.450"></a><span id="l7.450" class="difflineplus">+  icalproperty_add_parameter(mProperty, icalparam);</span>
<a href="#l7.451"></a><span id="l7.451" class="difflineplus">+  // XXX check ical errno</span>
<a href="#l7.452"></a><span id="l7.452" class="difflineplus">+  return NS_OK;</span>
<a href="#l7.453"></a><span id="l7.453"> }</span>
<a href="#l7.454"></a><span id="l7.454"> </span>
<a href="#l7.455"></a><span id="l7.455" class="difflineminus">-static nsresult</span>
<a href="#l7.456"></a><span id="l7.456" class="difflineminus">-FillParameterName(icalparameter *icalparam, nsACString &amp;name)</span>
<a href="#l7.457"></a><span id="l7.457" class="difflineminus">-{</span>
<a href="#l7.458"></a><span id="l7.458" class="difflineminus">-    const char *propname = nullptr;</span>
<a href="#l7.459"></a><span id="l7.459" class="difflineminus">-    if (icalparam) {</span>
<a href="#l7.460"></a><span id="l7.460" class="difflineminus">-        icalparameter_kind paramkind = icalparameter_isa(icalparam);</span>
<a href="#l7.461"></a><span id="l7.461" class="difflineminus">-        if (paramkind == ICAL_X_PARAMETER)</span>
<a href="#l7.462"></a><span id="l7.462" class="difflineminus">-            propname = icalparameter_get_xname(icalparam);</span>
<a href="#l7.463"></a><span id="l7.463" class="difflineminus">-        else if (paramkind == ICAL_IANA_PARAMETER)</span>
<a href="#l7.464"></a><span id="l7.464" class="difflineminus">-            propname = icalparameter_get_iana_name(icalparam);</span>
<a href="#l7.465"></a><span id="l7.465" class="difflineminus">-        else if (paramkind != ICAL_NO_PARAMETER)</span>
<a href="#l7.466"></a><span id="l7.466" class="difflineminus">-            propname = icalparameter_kind_to_string(paramkind);</span>
<a href="#l7.467"></a><span id="l7.467" class="difflineminus">-    }</span>
<a href="#l7.468"></a><span id="l7.468" class="difflineplus">+static nsresult FillParameterName(icalparameter *icalparam, nsACString &amp;name) {</span>
<a href="#l7.469"></a><span id="l7.469" class="difflineplus">+  const char *propname = nullptr;</span>
<a href="#l7.470"></a><span id="l7.470" class="difflineplus">+  if (icalparam) {</span>
<a href="#l7.471"></a><span id="l7.471" class="difflineplus">+    icalparameter_kind paramkind = icalparameter_isa(icalparam);</span>
<a href="#l7.472"></a><span id="l7.472" class="difflineplus">+    if (paramkind == ICAL_X_PARAMETER)</span>
<a href="#l7.473"></a><span id="l7.473" class="difflineplus">+      propname = icalparameter_get_xname(icalparam);</span>
<a href="#l7.474"></a><span id="l7.474" class="difflineplus">+    else if (paramkind == ICAL_IANA_PARAMETER)</span>
<a href="#l7.475"></a><span id="l7.475" class="difflineplus">+      propname = icalparameter_get_iana_name(icalparam);</span>
<a href="#l7.476"></a><span id="l7.476" class="difflineplus">+    else if (paramkind != ICAL_NO_PARAMETER)</span>
<a href="#l7.477"></a><span id="l7.477" class="difflineplus">+      propname = icalparameter_kind_to_string(paramkind);</span>
<a href="#l7.478"></a><span id="l7.478" class="difflineplus">+  }</span>
<a href="#l7.479"></a><span id="l7.479"> </span>
<a href="#l7.480"></a><span id="l7.480" class="difflineminus">-    if (propname) {</span>
<a href="#l7.481"></a><span id="l7.481" class="difflineminus">-        name.Assign(propname);</span>
<a href="#l7.482"></a><span id="l7.482" class="difflineminus">-    } else {</span>
<a href="#l7.483"></a><span id="l7.483" class="difflineminus">-        name.Truncate();</span>
<a href="#l7.484"></a><span id="l7.484" class="difflineminus">-        name.SetIsVoid(true);</span>
<a href="#l7.485"></a><span id="l7.485" class="difflineminus">-    }</span>
<a href="#l7.486"></a><span id="l7.486" class="difflineplus">+  if (propname) {</span>
<a href="#l7.487"></a><span id="l7.487" class="difflineplus">+    name.Assign(propname);</span>
<a href="#l7.488"></a><span id="l7.488" class="difflineplus">+  } else {</span>
<a href="#l7.489"></a><span id="l7.489" class="difflineplus">+    name.Truncate();</span>
<a href="#l7.490"></a><span id="l7.490" class="difflineplus">+    name.SetIsVoid(true);</span>
<a href="#l7.491"></a><span id="l7.491" class="difflineplus">+  }</span>
<a href="#l7.492"></a><span id="l7.492"> </span>
<a href="#l7.493"></a><span id="l7.493" class="difflineminus">-    return NS_OK;</span>
<a href="#l7.494"></a><span id="l7.494" class="difflineplus">+  return NS_OK;</span>
<a href="#l7.495"></a><span id="l7.495"> }</span>
<a href="#l7.496"></a><span id="l7.496"> </span>
<a href="#l7.497"></a><span id="l7.497"> NS_IMETHODIMP</span>
<a href="#l7.498"></a><span id="l7.498" class="difflineminus">-calIcalProperty::GetFirstParameterName(nsACString &amp;name)</span>
<a href="#l7.499"></a><span id="l7.499" class="difflineminus">-{</span>
<a href="#l7.500"></a><span id="l7.500" class="difflineminus">-    icalparameter *icalparam =</span>
<a href="#l7.501"></a><span id="l7.501" class="difflineminus">-        icalproperty_get_first_parameter(mProperty,</span>
<a href="#l7.502"></a><span id="l7.502" class="difflineminus">-                                         ICAL_ANY_PARAMETER);</span>
<a href="#l7.503"></a><span id="l7.503" class="difflineminus">-    return FillParameterName(icalparam, name);</span>
<a href="#l7.504"></a><span id="l7.504" class="difflineplus">+calIcalProperty::GetFirstParameterName(nsACString &amp;name) {</span>
<a href="#l7.505"></a><span id="l7.505" class="difflineplus">+  icalparameter *icalparam =</span>
<a href="#l7.506"></a><span id="l7.506" class="difflineplus">+      icalproperty_get_first_parameter(mProperty, ICAL_ANY_PARAMETER);</span>
<a href="#l7.507"></a><span id="l7.507" class="difflineplus">+  return FillParameterName(icalparam, name);</span>
<a href="#l7.508"></a><span id="l7.508" class="difflineplus">+}</span>
<a href="#l7.509"></a><span id="l7.509" class="difflineplus">+</span>
<a href="#l7.510"></a><span id="l7.510" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l7.511"></a><span id="l7.511" class="difflineplus">+calIcalProperty::GetNextParameterName(nsACString &amp;name) {</span>
<a href="#l7.512"></a><span id="l7.512" class="difflineplus">+  icalparameter *icalparam =</span>
<a href="#l7.513"></a><span id="l7.513" class="difflineplus">+      icalproperty_get_next_parameter(mProperty, ICAL_ANY_PARAMETER);</span>
<a href="#l7.514"></a><span id="l7.514" class="difflineplus">+  return FillParameterName(icalparam, name);</span>
<a href="#l7.515"></a><span id="l7.515"> }</span>
<a href="#l7.516"></a><span id="l7.516"> </span>
<a href="#l7.517"></a><span id="l7.517"> NS_IMETHODIMP</span>
<a href="#l7.518"></a><span id="l7.518" class="difflineminus">-calIcalProperty::GetNextParameterName(nsACString &amp;name)</span>
<a href="#l7.519"></a><span id="l7.519" class="difflineminus">-{</span>
<a href="#l7.520"></a><span id="l7.520" class="difflineminus">-    icalparameter *icalparam =</span>
<a href="#l7.521"></a><span id="l7.521" class="difflineminus">-        icalproperty_get_next_parameter(mProperty,</span>
<a href="#l7.522"></a><span id="l7.522" class="difflineminus">-                                        ICAL_ANY_PARAMETER);</span>
<a href="#l7.523"></a><span id="l7.523" class="difflineminus">-    return FillParameterName(icalparam, name);</span>
<a href="#l7.524"></a><span id="l7.524" class="difflineplus">+calIcalProperty::RemoveParameter(const nsACString &amp;param) {</span>
<a href="#l7.525"></a><span id="l7.525" class="difflineplus">+  icalproperty_remove_parameter_by_name(mProperty,</span>
<a href="#l7.526"></a><span id="l7.526" class="difflineplus">+                                        PromiseFlatCString(param).get());</span>
<a href="#l7.527"></a><span id="l7.527" class="difflineplus">+  // XXX check ical errno</span>
<a href="#l7.528"></a><span id="l7.528" class="difflineplus">+  return NS_OK;</span>
<a href="#l7.529"></a><span id="l7.529"> }</span>
<a href="#l7.530"></a><span id="l7.530"> </span>
<a href="#l7.531"></a><span id="l7.531"> NS_IMETHODIMP</span>
<a href="#l7.532"></a><span id="l7.532" class="difflineminus">-calIcalProperty::RemoveParameter(const nsACString &amp;param)</span>
<a href="#l7.533"></a><span id="l7.533" class="difflineminus">-{</span>
<a href="#l7.534"></a><span id="l7.534" class="difflineminus">-    icalproperty_remove_parameter_by_name(mProperty, PromiseFlatCString(param).get());</span>
<a href="#l7.535"></a><span id="l7.535" class="difflineminus">-    // XXX check ical errno</span>
<a href="#l7.536"></a><span id="l7.536" class="difflineminus">-    return NS_OK;</span>
<a href="#l7.537"></a><span id="l7.537" class="difflineplus">+calIcalProperty::ClearXParameters() {</span>
<a href="#l7.538"></a><span id="l7.538" class="difflineplus">+  int oldcount, paramcount = 0;</span>
<a href="#l7.539"></a><span id="l7.539" class="difflineplus">+  do {</span>
<a href="#l7.540"></a><span id="l7.540" class="difflineplus">+    oldcount = paramcount;</span>
<a href="#l7.541"></a><span id="l7.541" class="difflineplus">+    icalproperty_remove_parameter(mProperty, ICAL_X_PARAMETER);</span>
<a href="#l7.542"></a><span id="l7.542" class="difflineplus">+    paramcount = icalproperty_count_parameters(mProperty);</span>
<a href="#l7.543"></a><span id="l7.543" class="difflineplus">+  } while (oldcount != paramcount);</span>
<a href="#l7.544"></a><span id="l7.544" class="difflineplus">+  return NS_OK;</span>
<a href="#l7.545"></a><span id="l7.545"> }</span>
<a href="#l7.546"></a><span id="l7.546"> </span>
<a href="#l7.547"></a><span id="l7.547"> NS_IMETHODIMP</span>
<a href="#l7.548"></a><span id="l7.548" class="difflineminus">-calIcalProperty::ClearXParameters()</span>
<a href="#l7.549"></a><span id="l7.549" class="difflineminus">-{</span>
<a href="#l7.550"></a><span id="l7.550" class="difflineminus">-    int oldcount, paramcount = 0;</span>
<a href="#l7.551"></a><span id="l7.551" class="difflineminus">-    do {</span>
<a href="#l7.552"></a><span id="l7.552" class="difflineminus">-        oldcount = paramcount;</span>
<a href="#l7.553"></a><span id="l7.553" class="difflineminus">-        icalproperty_remove_parameter(mProperty, ICAL_X_PARAMETER);</span>
<a href="#l7.554"></a><span id="l7.554" class="difflineminus">-        paramcount = icalproperty_count_parameters(mProperty);</span>
<a href="#l7.555"></a><span id="l7.555" class="difflineminus">-    } while (oldcount != paramcount);</span>
<a href="#l7.556"></a><span id="l7.556" class="difflineminus">-    return NS_OK;</span>
<a href="#l7.557"></a><span id="l7.557" class="difflineminus">-}</span>
<a href="#l7.558"></a><span id="l7.558" class="difflineminus">-</span>
<a href="#l7.559"></a><span id="l7.559" class="difflineminus">-</span>
<a href="#l7.560"></a><span id="l7.560" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l7.561"></a><span id="l7.561" class="difflineminus">-calIcalProperty::GetValueAsDatetime(calIDateTime **dtp)</span>
<a href="#l7.562"></a><span id="l7.562" class="difflineminus">-{</span>
<a href="#l7.563"></a><span id="l7.563" class="difflineminus">-    NS_ENSURE_ARG_POINTER(dtp);</span>
<a href="#l7.564"></a><span id="l7.564" class="difflineminus">-    return getDatetime_(toIcalComponent(mParent), mProperty, dtp);</span>
<a href="#l7.565"></a><span id="l7.565" class="difflineplus">+calIcalProperty::GetValueAsDatetime(calIDateTime **dtp) {</span>
<a href="#l7.566"></a><span id="l7.566" class="difflineplus">+  NS_ENSURE_ARG_POINTER(dtp);</span>
<a href="#l7.567"></a><span id="l7.567" class="difflineplus">+  return getDatetime_(toIcalComponent(mParent), mProperty, dtp);</span>
<a href="#l7.568"></a><span id="l7.568"> }</span>
<a href="#l7.569"></a><span id="l7.569"> </span>
<a href="#l7.570"></a><span id="l7.570" class="difflineminus">-nsresult calIcalProperty::getDatetime_(calIcalComponent * parent,</span>
<a href="#l7.571"></a><span id="l7.571" class="difflineminus">-                                       icalproperty * prop,</span>
<a href="#l7.572"></a><span id="l7.572" class="difflineminus">-                                       calIDateTime ** dtp)</span>
<a href="#l7.573"></a><span id="l7.573" class="difflineminus">-{</span>
<a href="#l7.574"></a><span id="l7.574" class="difflineminus">-    icalvalue * const val = icalproperty_get_value(prop);</span>
<a href="#l7.575"></a><span id="l7.575" class="difflineminus">-    icalvalue_kind const valkind = icalvalue_isa(val);</span>
<a href="#l7.576"></a><span id="l7.576" class="difflineminus">-    if (valkind != ICAL_DATETIME_VALUE &amp;&amp; valkind != ICAL_DATE_VALUE) {</span>
<a href="#l7.577"></a><span id="l7.577" class="difflineminus">-        return NS_ERROR_UNEXPECTED;</span>
<a href="#l7.578"></a><span id="l7.578" class="difflineplus">+nsresult calIcalProperty::getDatetime_(calIcalComponent *parent,</span>
<a href="#l7.579"></a><span id="l7.579" class="difflineplus">+                                       icalproperty *prop, calIDateTime **dtp) {</span>
<a href="#l7.580"></a><span id="l7.580" class="difflineplus">+  icalvalue *const val = icalproperty_get_value(prop);</span>
<a href="#l7.581"></a><span id="l7.581" class="difflineplus">+  icalvalue_kind const valkind = icalvalue_isa(val);</span>
<a href="#l7.582"></a><span id="l7.582" class="difflineplus">+  if (valkind != ICAL_DATETIME_VALUE &amp;&amp; valkind != ICAL_DATE_VALUE) {</span>
<a href="#l7.583"></a><span id="l7.583" class="difflineplus">+    return NS_ERROR_UNEXPECTED;</span>
<a href="#l7.584"></a><span id="l7.584" class="difflineplus">+  }</span>
<a href="#l7.585"></a><span id="l7.585" class="difflineplus">+  icaltimetype itt = icalvalue_get_datetime(val);</span>
<a href="#l7.586"></a><span id="l7.586" class="difflineplus">+</span>
<a href="#l7.587"></a><span id="l7.587" class="difflineplus">+  char const *tzid_ = nullptr;</span>
<a href="#l7.588"></a><span id="l7.588" class="difflineplus">+  if (!itt.is_utc) {</span>
<a href="#l7.589"></a><span id="l7.589" class="difflineplus">+    if (itt.zone) {</span>
<a href="#l7.590"></a><span id="l7.590" class="difflineplus">+      tzid_ = icaltimezone_get_tzid(const_cast&lt;icaltimezone *&gt;(itt.zone));</span>
<a href="#l7.591"></a><span id="l7.591" class="difflineplus">+    } else {</span>
<a href="#l7.592"></a><span id="l7.592" class="difflineplus">+      // Need to get the tzid param. Unfortunately, libical tends to return raw</span>
<a href="#l7.593"></a><span id="l7.593" class="difflineplus">+      // ics strings, with quotes and everything. That's not what we want. Need</span>
<a href="#l7.594"></a><span id="l7.594" class="difflineplus">+      // to work around.</span>
<a href="#l7.595"></a><span id="l7.595" class="difflineplus">+      icalparameter *const tzparam =</span>
<a href="#l7.596"></a><span id="l7.596" class="difflineplus">+          icalproperty_get_first_parameter(prop, ICAL_TZID_PARAMETER);</span>
<a href="#l7.597"></a><span id="l7.597" class="difflineplus">+      if (tzparam) {</span>
<a href="#l7.598"></a><span id="l7.598" class="difflineplus">+        tzid_ = icalparameter_get_xvalue(tzparam);</span>
<a href="#l7.599"></a><span id="l7.599" class="difflineplus">+      }</span>
<a href="#l7.600"></a><span id="l7.600">     }</span>
<a href="#l7.601"></a><span id="l7.601" class="difflineminus">-    icaltimetype itt = icalvalue_get_datetime(val);</span>
<a href="#l7.602"></a><span id="l7.602" class="difflineplus">+  }</span>
<a href="#l7.603"></a><span id="l7.603"> </span>
<a href="#l7.604"></a><span id="l7.604" class="difflineminus">-    char const* tzid_ = nullptr;</span>
<a href="#l7.605"></a><span id="l7.605" class="difflineminus">-    if (!itt.is_utc) {</span>
<a href="#l7.606"></a><span id="l7.606" class="difflineminus">-        if (itt.zone) {</span>
<a href="#l7.607"></a><span id="l7.607" class="difflineminus">-            tzid_ = icaltimezone_get_tzid(const_cast&lt;icaltimezone *&gt;(itt.zone));</span>
<a href="#l7.608"></a><span id="l7.608" class="difflineminus">-        } else {</span>
<a href="#l7.609"></a><span id="l7.609" class="difflineminus">-            // Need to get the tzid param. Unfortunately, libical tends to return raw</span>
<a href="#l7.610"></a><span id="l7.610" class="difflineminus">-            // ics strings, with quotes and everything. That's not what we want. Need</span>
<a href="#l7.611"></a><span id="l7.611" class="difflineminus">-            // to work around.</span>
<a href="#l7.612"></a><span id="l7.612" class="difflineminus">-            icalparameter * const tzparam = icalproperty_get_first_parameter(prop, ICAL_TZID_PARAMETER);</span>
<a href="#l7.613"></a><span id="l7.613" class="difflineminus">-            if (tzparam) {</span>
<a href="#l7.614"></a><span id="l7.614" class="difflineminus">-                tzid_ = icalparameter_get_xvalue(tzparam);</span>
<a href="#l7.615"></a><span id="l7.615" class="difflineminus">-            }</span>
<a href="#l7.616"></a><span id="l7.616" class="difflineplus">+  nsCOMPtr&lt;calITimezone&gt; tz;</span>
<a href="#l7.617"></a><span id="l7.617" class="difflineplus">+  if (tzid_) {</span>
<a href="#l7.618"></a><span id="l7.618" class="difflineplus">+    nsDependentCString const tzid(tzid_);</span>
<a href="#l7.619"></a><span id="l7.619" class="difflineplus">+    calIcalComponent *comp = nullptr;</span>
<a href="#l7.620"></a><span id="l7.620" class="difflineplus">+    if (parent) {</span>
<a href="#l7.621"></a><span id="l7.621" class="difflineplus">+      comp = parent-&gt;getParentVCalendarOrThis();</span>
<a href="#l7.622"></a><span id="l7.622" class="difflineplus">+    }</span>
<a href="#l7.623"></a><span id="l7.623" class="difflineplus">+    // look up parent if timezone is already referenced:</span>
<a href="#l7.624"></a><span id="l7.624" class="difflineplus">+    if (comp) {</span>
<a href="#l7.625"></a><span id="l7.625" class="difflineplus">+      comp-&gt;mReferencedTimezones.Get(tzid, getter_AddRefs(tz));</span>
<a href="#l7.626"></a><span id="l7.626" class="difflineplus">+    }</span>
<a href="#l7.627"></a><span id="l7.627" class="difflineplus">+    if (!tz) {</span>
<a href="#l7.628"></a><span id="l7.628" class="difflineplus">+      if (parent) {</span>
<a href="#l7.629"></a><span id="l7.629" class="difflineplus">+        // passed tz provider has precedence over timezone service:</span>
<a href="#l7.630"></a><span id="l7.630" class="difflineplus">+        calITimezoneProvider *const tzProvider = parent-&gt;getTzProvider();</span>
<a href="#l7.631"></a><span id="l7.631" class="difflineplus">+        if (tzProvider) {</span>
<a href="#l7.632"></a><span id="l7.632" class="difflineplus">+          tzProvider-&gt;GetTimezone(tzid, getter_AddRefs(tz));</span>
<a href="#l7.633"></a><span id="l7.633" class="difflineplus">+          NS_ASSERTION(tz, tzid_);</span>
<a href="#l7.634"></a><span id="l7.634">         }</span>
<a href="#l7.635"></a><span id="l7.635" class="difflineminus">-    }</span>
<a href="#l7.636"></a><span id="l7.636" class="difflineplus">+      }</span>
<a href="#l7.637"></a><span id="l7.637" class="difflineplus">+      if (!tz) {</span>
<a href="#l7.638"></a><span id="l7.638" class="difflineplus">+        // look up tz in tz service.</span>
<a href="#l7.639"></a><span id="l7.639" class="difflineplus">+        // this hides errors from incorrect ics files, which could state</span>
<a href="#l7.640"></a><span id="l7.640" class="difflineplus">+        // a TZID that is not present in the ics file.</span>
<a href="#l7.641"></a><span id="l7.641" class="difflineplus">+        // The other way round, it makes this product more error tolerant.</span>
<a href="#l7.642"></a><span id="l7.642" class="difflineplus">+        nsresult rv =</span>
<a href="#l7.643"></a><span id="l7.643" class="difflineplus">+            cal::getTimezoneService()-&gt;GetTimezone(tzid, getter_AddRefs(tz));</span>
<a href="#l7.644"></a><span id="l7.644"> </span>
<a href="#l7.645"></a><span id="l7.645" class="difflineminus">-    nsCOMPtr&lt;calITimezone&gt; tz;</span>
<a href="#l7.646"></a><span id="l7.646" class="difflineminus">-    if (tzid_) {</span>
<a href="#l7.647"></a><span id="l7.647" class="difflineminus">-        nsDependentCString const tzid(tzid_);</span>
<a href="#l7.648"></a><span id="l7.648" class="difflineminus">-        calIcalComponent * comp = nullptr;</span>
<a href="#l7.649"></a><span id="l7.649" class="difflineminus">-        if (parent) {</span>
<a href="#l7.650"></a><span id="l7.650" class="difflineminus">-            comp = parent-&gt;getParentVCalendarOrThis();</span>
<a href="#l7.651"></a><span id="l7.651" class="difflineminus">-        }</span>
<a href="#l7.652"></a><span id="l7.652" class="difflineminus">-        // look up parent if timezone is already referenced:</span>
<a href="#l7.653"></a><span id="l7.653" class="difflineminus">-        if (comp) {</span>
<a href="#l7.654"></a><span id="l7.654" class="difflineminus">-            comp-&gt;mReferencedTimezones.Get(tzid, getter_AddRefs(tz));</span>
<a href="#l7.655"></a><span id="l7.655" class="difflineminus">-        }</span>
<a href="#l7.656"></a><span id="l7.656" class="difflineminus">-        if (!tz) {</span>
<a href="#l7.657"></a><span id="l7.657" class="difflineminus">-            if (parent) {</span>
<a href="#l7.658"></a><span id="l7.658" class="difflineminus">-                // passed tz provider has precedence over timezone service:</span>
<a href="#l7.659"></a><span id="l7.659" class="difflineminus">-                calITimezoneProvider * const tzProvider = parent-&gt;getTzProvider();</span>
<a href="#l7.660"></a><span id="l7.660" class="difflineminus">-                if (tzProvider) {</span>
<a href="#l7.661"></a><span id="l7.661" class="difflineminus">-                    tzProvider-&gt;GetTimezone(tzid, getter_AddRefs(tz));</span>
<a href="#l7.662"></a><span id="l7.662" class="difflineminus">-                    NS_ASSERTION(tz, tzid_);</span>
<a href="#l7.663"></a><span id="l7.663" class="difflineminus">-                }</span>
<a href="#l7.664"></a><span id="l7.664" class="difflineplus">+        if (NS_FAILED(rv) || !tz) {</span>
<a href="#l7.665"></a><span id="l7.665" class="difflineplus">+          icaltimezone const *zone = itt.zone;</span>
<a href="#l7.666"></a><span id="l7.666" class="difflineplus">+          if (!zone &amp;&amp; comp) {</span>
<a href="#l7.667"></a><span id="l7.667" class="difflineplus">+            // look up parent VCALENDAR for VTIMEZONE:</span>
<a href="#l7.668"></a><span id="l7.668" class="difflineplus">+            zone = icalcomponent_get_timezone(comp-&gt;mComponent, tzid_);</span>
<a href="#l7.669"></a><span id="l7.669" class="difflineplus">+            NS_ASSERTION(zone, tzid_);</span>
<a href="#l7.670"></a><span id="l7.670" class="difflineplus">+          }</span>
<a href="#l7.671"></a><span id="l7.671" class="difflineplus">+          if (zone) {</span>
<a href="#l7.672"></a><span id="l7.672" class="difflineplus">+            // We need to decouple this (inner) VTIMEZONE from the parent</span>
<a href="#l7.673"></a><span id="l7.673" class="difflineplus">+            // VCALENDAR to avoid running into circular references (referenced</span>
<a href="#l7.674"></a><span id="l7.674" class="difflineplus">+            // timezones):</span>
<a href="#l7.675"></a><span id="l7.675" class="difflineplus">+            icaltimezone *const clonedZone = icaltimezone_new();</span>
<a href="#l7.676"></a><span id="l7.676" class="difflineplus">+            CAL_ENSURE_MEMORY(clonedZone);</span>
<a href="#l7.677"></a><span id="l7.677" class="difflineplus">+            icalcomponent *const clonedZoneComp = icalcomponent_new_clone(</span>
<a href="#l7.678"></a><span id="l7.678" class="difflineplus">+                icaltimezone_get_component(const_cast&lt;icaltimezone *&gt;(zone)));</span>
<a href="#l7.679"></a><span id="l7.679" class="difflineplus">+            if (!clonedZoneComp) {</span>
<a href="#l7.680"></a><span id="l7.680" class="difflineplus">+              icaltimezone_free(clonedZone, 1 /* free struct */);</span>
<a href="#l7.681"></a><span id="l7.681" class="difflineplus">+              CAL_ENSURE_MEMORY(clonedZoneComp);</span>
<a href="#l7.682"></a><span id="l7.682">             }</span>
<a href="#l7.683"></a><span id="l7.683" class="difflineminus">-            if (!tz) {</span>
<a href="#l7.684"></a><span id="l7.684" class="difflineminus">-                // look up tz in tz service.</span>
<a href="#l7.685"></a><span id="l7.685" class="difflineminus">-                // this hides errors from incorrect ics files, which could state</span>
<a href="#l7.686"></a><span id="l7.686" class="difflineminus">-                // a TZID that is not present in the ics file.</span>
<a href="#l7.687"></a><span id="l7.687" class="difflineminus">-                // The other way round, it makes this product more error tolerant.</span>
<a href="#l7.688"></a><span id="l7.688" class="difflineminus">-                nsresult rv = cal::getTimezoneService()-&gt;GetTimezone(tzid, getter_AddRefs(tz));</span>
<a href="#l7.689"></a><span id="l7.689" class="difflineminus">-</span>
<a href="#l7.690"></a><span id="l7.690" class="difflineminus">-                if (NS_FAILED(rv) || !tz) {</span>
<a href="#l7.691"></a><span id="l7.691" class="difflineminus">-                    icaltimezone const* zone = itt.zone;</span>
<a href="#l7.692"></a><span id="l7.692" class="difflineminus">-                    if (!zone &amp;&amp; comp) {</span>
<a href="#l7.693"></a><span id="l7.693" class="difflineminus">-                        // look up parent VCALENDAR for VTIMEZONE:</span>
<a href="#l7.694"></a><span id="l7.694" class="difflineminus">-                        zone = icalcomponent_get_timezone(comp-&gt;mComponent, tzid_);</span>
<a href="#l7.695"></a><span id="l7.695" class="difflineminus">-                        NS_ASSERTION(zone, tzid_);</span>
<a href="#l7.696"></a><span id="l7.696" class="difflineminus">-                    }</span>
<a href="#l7.697"></a><span id="l7.697" class="difflineminus">-                    if (zone) {</span>
<a href="#l7.698"></a><span id="l7.698" class="difflineminus">-                        // We need to decouple this (inner) VTIMEZONE from the parent VCALENDAR to avoid</span>
<a href="#l7.699"></a><span id="l7.699" class="difflineminus">-                        // running into circular references (referenced timezones):</span>
<a href="#l7.700"></a><span id="l7.700" class="difflineminus">-                        icaltimezone * const clonedZone = icaltimezone_new();</span>
<a href="#l7.701"></a><span id="l7.701" class="difflineminus">-                        CAL_ENSURE_MEMORY(clonedZone);</span>
<a href="#l7.702"></a><span id="l7.702" class="difflineminus">-                        icalcomponent * const clonedZoneComp =</span>
<a href="#l7.703"></a><span id="l7.703" class="difflineminus">-                            icalcomponent_new_clone(icaltimezone_get_component(const_cast&lt;icaltimezone *&gt;(zone)));</span>
<a href="#l7.704"></a><span id="l7.704" class="difflineminus">-                        if (!clonedZoneComp) {</span>
<a href="#l7.705"></a><span id="l7.705" class="difflineminus">-                            icaltimezone_free(clonedZone, 1 /* free struct */);</span>
<a href="#l7.706"></a><span id="l7.706" class="difflineminus">-                            CAL_ENSURE_MEMORY(clonedZoneComp);</span>
<a href="#l7.707"></a><span id="l7.707" class="difflineminus">-                        }</span>
<a href="#l7.708"></a><span id="l7.708" class="difflineminus">-                        if (!icaltimezone_set_component(clonedZone, clonedZoneComp)) {</span>
<a href="#l7.709"></a><span id="l7.709" class="difflineminus">-                            icaltimezone_free(clonedZone, 1 /* free struct */);</span>
<a href="#l7.710"></a><span id="l7.710" class="difflineminus">-                            return NS_ERROR_INVALID_ARG;</span>
<a href="#l7.711"></a><span id="l7.711" class="difflineminus">-                        }</span>
<a href="#l7.712"></a><span id="l7.712" class="difflineminus">-                        nsCOMPtr&lt;calIIcalComponent&gt; const tzComp(new calIcalComponent(clonedZone, clonedZoneComp));</span>
<a href="#l7.713"></a><span id="l7.713" class="difflineminus">-                        CAL_ENSURE_MEMORY(tzComp);</span>
<a href="#l7.714"></a><span id="l7.714" class="difflineminus">-                        tz = new calTimezone(tzid, tzComp);</span>
<a href="#l7.715"></a><span id="l7.715" class="difflineminus">-                        CAL_ENSURE_MEMORY(tz);</span>
<a href="#l7.716"></a><span id="l7.716" class="difflineminus">-                    } else { // install phantom timezone, so the data could be repaired:</span>
<a href="#l7.717"></a><span id="l7.717" class="difflineminus">-                        tz = new calTimezone(tzid, nullptr);</span>
<a href="#l7.718"></a><span id="l7.718" class="difflineminus">-                        CAL_ENSURE_MEMORY(tz);</span>
<a href="#l7.719"></a><span id="l7.719" class="difflineminus">-                    }</span>
<a href="#l7.720"></a><span id="l7.720" class="difflineminus">-                }</span>
<a href="#l7.721"></a><span id="l7.721" class="difflineplus">+            if (!icaltimezone_set_component(clonedZone, clonedZoneComp)) {</span>
<a href="#l7.722"></a><span id="l7.722" class="difflineplus">+              icaltimezone_free(clonedZone, 1 /* free struct */);</span>
<a href="#l7.723"></a><span id="l7.723" class="difflineplus">+              return NS_ERROR_INVALID_ARG;</span>
<a href="#l7.724"></a><span id="l7.724">             }</span>
<a href="#l7.725"></a><span id="l7.725" class="difflineminus">-            if (comp &amp;&amp; tz) {</span>
<a href="#l7.726"></a><span id="l7.726" class="difflineminus">-                // assure timezone is known:</span>
<a href="#l7.727"></a><span id="l7.727" class="difflineminus">-                comp-&gt;AddTimezoneReference(tz);</span>
<a href="#l7.728"></a><span id="l7.728" class="difflineminus">-            }</span>
<a href="#l7.729"></a><span id="l7.729" class="difflineplus">+            nsCOMPtr&lt;calIIcalComponent&gt; const tzComp(</span>
<a href="#l7.730"></a><span id="l7.730" class="difflineplus">+                new calIcalComponent(clonedZone, clonedZoneComp));</span>
<a href="#l7.731"></a><span id="l7.731" class="difflineplus">+            CAL_ENSURE_MEMORY(tzComp);</span>
<a href="#l7.732"></a><span id="l7.732" class="difflineplus">+            tz = new calTimezone(tzid, tzComp);</span>
<a href="#l7.733"></a><span id="l7.733" class="difflineplus">+            CAL_ENSURE_MEMORY(tz);</span>
<a href="#l7.734"></a><span id="l7.734" class="difflineplus">+          } else {  // install phantom timezone, so the data could be repaired:</span>
<a href="#l7.735"></a><span id="l7.735" class="difflineplus">+            tz = new calTimezone(tzid, nullptr);</span>
<a href="#l7.736"></a><span id="l7.736" class="difflineplus">+            CAL_ENSURE_MEMORY(tz);</span>
<a href="#l7.737"></a><span id="l7.737" class="difflineplus">+          }</span>
<a href="#l7.738"></a><span id="l7.738">         }</span>
<a href="#l7.739"></a><span id="l7.739" class="difflineminus">-        if (tz) {</span>
<a href="#l7.740"></a><span id="l7.740" class="difflineminus">-            // correct itt which would else appear floating:</span>
<a href="#l7.741"></a><span id="l7.741" class="difflineminus">-            itt.zone = cal::getIcalTimezone(tz);</span>
<a href="#l7.742"></a><span id="l7.742" class="difflineminus">-            itt.is_utc = 0;</span>
<a href="#l7.743"></a><span id="l7.743" class="difflineminus">-        } else {</span>
<a href="#l7.744"></a><span id="l7.744" class="difflineminus">-            cal::logMissingTimezone(tzid_);</span>
<a href="#l7.745"></a><span id="l7.745" class="difflineminus">-        }</span>
<a href="#l7.746"></a><span id="l7.746" class="difflineplus">+      }</span>
<a href="#l7.747"></a><span id="l7.747" class="difflineplus">+      if (comp &amp;&amp; tz) {</span>
<a href="#l7.748"></a><span id="l7.748" class="difflineplus">+        // assure timezone is known:</span>
<a href="#l7.749"></a><span id="l7.749" class="difflineplus">+        comp-&gt;AddTimezoneReference(tz);</span>
<a href="#l7.750"></a><span id="l7.750" class="difflineplus">+      }</span>
<a href="#l7.751"></a><span id="l7.751">     }</span>
<a href="#l7.752"></a><span id="l7.752" class="difflineminus">-    *dtp = new calDateTime(&amp;itt, tz);</span>
<a href="#l7.753"></a><span id="l7.753" class="difflineminus">-    CAL_ENSURE_MEMORY(*dtp);</span>
<a href="#l7.754"></a><span id="l7.754" class="difflineminus">-    NS_ADDREF(*dtp);</span>
<a href="#l7.755"></a><span id="l7.755" class="difflineminus">-    return NS_OK;</span>
<a href="#l7.756"></a><span id="l7.756" class="difflineplus">+    if (tz) {</span>
<a href="#l7.757"></a><span id="l7.757" class="difflineplus">+      // correct itt which would else appear floating:</span>
<a href="#l7.758"></a><span id="l7.758" class="difflineplus">+      itt.zone = cal::getIcalTimezone(tz);</span>
<a href="#l7.759"></a><span id="l7.759" class="difflineplus">+      itt.is_utc = 0;</span>
<a href="#l7.760"></a><span id="l7.760" class="difflineplus">+    } else {</span>
<a href="#l7.761"></a><span id="l7.761" class="difflineplus">+      cal::logMissingTimezone(tzid_);</span>
<a href="#l7.762"></a><span id="l7.762" class="difflineplus">+    }</span>
<a href="#l7.763"></a><span id="l7.763" class="difflineplus">+  }</span>
<a href="#l7.764"></a><span id="l7.764" class="difflineplus">+  *dtp = new calDateTime(&amp;itt, tz);</span>
<a href="#l7.765"></a><span id="l7.765" class="difflineplus">+  CAL_ENSURE_MEMORY(*dtp);</span>
<a href="#l7.766"></a><span id="l7.766" class="difflineplus">+  NS_ADDREF(*dtp);</span>
<a href="#l7.767"></a><span id="l7.767" class="difflineplus">+  return NS_OK;</span>
<a href="#l7.768"></a><span id="l7.768"> }</span>
<a href="#l7.769"></a><span id="l7.769"> </span>
<a href="#l7.770"></a><span id="l7.770" class="difflineminus">-</span>
<a href="#l7.771"></a><span id="l7.771" class="difflineminus">-calIcalComponent::~calIcalComponent()</span>
<a href="#l7.772"></a><span id="l7.772" class="difflineminus">-{</span>
<a href="#l7.773"></a><span id="l7.773" class="difflineminus">-    if (!mParent) {</span>
<a href="#l7.774"></a><span id="l7.774" class="difflineminus">-        // We free either a plain icalcomponent or a icaltimezone.</span>
<a href="#l7.775"></a><span id="l7.775" class="difflineminus">-        // In the latter case icaltimezone_free frees the VTIMEZONE component.</span>
<a href="#l7.776"></a><span id="l7.776" class="difflineminus">-        if (mTimezone) {</span>
<a href="#l7.777"></a><span id="l7.777" class="difflineminus">-            icaltimezone_free(mTimezone, 1 /* free struct */);</span>
<a href="#l7.778"></a><span id="l7.778" class="difflineminus">-        } else {</span>
<a href="#l7.779"></a><span id="l7.779" class="difflineminus">-            icalcomponent_free(mComponent);</span>
<a href="#l7.780"></a><span id="l7.780" class="difflineminus">-        }</span>
<a href="#l7.781"></a><span id="l7.781" class="difflineplus">+calIcalComponent::~calIcalComponent() {</span>
<a href="#l7.782"></a><span id="l7.782" class="difflineplus">+  if (!mParent) {</span>
<a href="#l7.783"></a><span id="l7.783" class="difflineplus">+    // We free either a plain icalcomponent or a icaltimezone.</span>
<a href="#l7.784"></a><span id="l7.784" class="difflineplus">+    // In the latter case icaltimezone_free frees the VTIMEZONE component.</span>
<a href="#l7.785"></a><span id="l7.785" class="difflineplus">+    if (mTimezone) {</span>
<a href="#l7.786"></a><span id="l7.786" class="difflineplus">+      icaltimezone_free(mTimezone, 1 /* free struct */);</span>
<a href="#l7.787"></a><span id="l7.787" class="difflineplus">+    } else {</span>
<a href="#l7.788"></a><span id="l7.788" class="difflineplus">+      icalcomponent_free(mComponent);</span>
<a href="#l7.789"></a><span id="l7.789">     }</span>
<a href="#l7.790"></a><span id="l7.790" class="difflineplus">+  }</span>
<a href="#l7.791"></a><span id="l7.791"> }</span>
<a href="#l7.792"></a><span id="l7.792"> NS_IMETHODIMP</span>
<a href="#l7.793"></a><span id="l7.793" class="difflineminus">-calIcalComponent::GetIcalComponent(JS::MutableHandleValue)</span>
<a href="#l7.794"></a><span id="l7.794" class="difflineminus">-{</span>
<a href="#l7.795"></a><span id="l7.795" class="difflineminus">-    return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l7.796"></a><span id="l7.796" class="difflineplus">+calIcalComponent::GetIcalComponent(JS::MutableHandleValue) {</span>
<a href="#l7.797"></a><span id="l7.797" class="difflineplus">+  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l7.798"></a><span id="l7.798"> }</span>
<a href="#l7.799"></a><span id="l7.799"> </span>
<a href="#l7.800"></a><span id="l7.800"> NS_IMETHODIMP</span>
<a href="#l7.801"></a><span id="l7.801" class="difflineminus">-calIcalComponent::SetIcalComponent(JS::HandleValue)</span>
<a href="#l7.802"></a><span id="l7.802" class="difflineminus">-{</span>
<a href="#l7.803"></a><span id="l7.803" class="difflineminus">-    return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l7.804"></a><span id="l7.804" class="difflineminus">-}</span>
<a href="#l7.805"></a><span id="l7.805" class="difflineminus">-</span>
<a href="#l7.806"></a><span id="l7.806" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l7.807"></a><span id="l7.807" class="difflineminus">-calIcalComponent::GetParent(calIIcalComponent** parent)</span>
<a href="#l7.808"></a><span id="l7.808" class="difflineminus">-{</span>
<a href="#l7.809"></a><span id="l7.809" class="difflineminus">-    NS_ENSURE_ARG_POINTER(parent);</span>
<a href="#l7.810"></a><span id="l7.810" class="difflineminus">-    NS_IF_ADDREF(*parent = mParent);</span>
<a href="#l7.811"></a><span id="l7.811" class="difflineminus">-    return NS_OK;</span>
<a href="#l7.812"></a><span id="l7.812" class="difflineplus">+calIcalComponent::SetIcalComponent(JS::HandleValue) {</span>
<a href="#l7.813"></a><span id="l7.813" class="difflineplus">+  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l7.814"></a><span id="l7.814"> }</span>
<a href="#l7.815"></a><span id="l7.815"> </span>
<a href="#l7.816"></a><span id="l7.816"> NS_IMETHODIMP</span>
<a href="#l7.817"></a><span id="l7.817" class="difflineminus">-calIcalComponent::GetIcalTimezone(JS::MutableHandleValue)</span>
<a href="#l7.818"></a><span id="l7.818" class="difflineminus">-{</span>
<a href="#l7.819"></a><span id="l7.819" class="difflineminus">-    return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l7.820"></a><span id="l7.820" class="difflineplus">+calIcalComponent::GetParent(calIIcalComponent **parent) {</span>
<a href="#l7.821"></a><span id="l7.821" class="difflineplus">+  NS_ENSURE_ARG_POINTER(parent);</span>
<a href="#l7.822"></a><span id="l7.822" class="difflineplus">+  NS_IF_ADDREF(*parent = mParent);</span>
<a href="#l7.823"></a><span id="l7.823" class="difflineplus">+  return NS_OK;</span>
<a href="#l7.824"></a><span id="l7.824" class="difflineplus">+}</span>
<a href="#l7.825"></a><span id="l7.825" class="difflineplus">+</span>
<a href="#l7.826"></a><span id="l7.826" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l7.827"></a><span id="l7.827" class="difflineplus">+calIcalComponent::GetIcalTimezone(JS::MutableHandleValue) {</span>
<a href="#l7.828"></a><span id="l7.828" class="difflineplus">+  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l7.829"></a><span id="l7.829"> }</span>
<a href="#l7.830"></a><span id="l7.830"> </span>
<a href="#l7.831"></a><span id="l7.831"> NS_IMETHODIMP</span>
<a href="#l7.832"></a><span id="l7.832" class="difflineminus">-calIcalComponent::SetIcalTimezone(JS::HandleValue)</span>
<a href="#l7.833"></a><span id="l7.833" class="difflineminus">-{</span>
<a href="#l7.834"></a><span id="l7.834" class="difflineminus">-    return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l7.835"></a><span id="l7.835" class="difflineplus">+calIcalComponent::SetIcalTimezone(JS::HandleValue) {</span>
<a href="#l7.836"></a><span id="l7.836" class="difflineplus">+  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l7.837"></a><span id="l7.837" class="difflineplus">+}</span>
<a href="#l7.838"></a><span id="l7.838" class="difflineplus">+</span>
<a href="#l7.839"></a><span id="l7.839" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l7.840"></a><span id="l7.840" class="difflineplus">+calIcalComponent::AddTimezoneReference(calITimezone *aTimezone) {</span>
<a href="#l7.841"></a><span id="l7.841" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aTimezone);</span>
<a href="#l7.842"></a><span id="l7.842" class="difflineplus">+  nsAutoCString tzid;</span>
<a href="#l7.843"></a><span id="l7.843" class="difflineplus">+  nsresult rv = aTimezone-&gt;GetTzid(tzid);</span>
<a href="#l7.844"></a><span id="l7.844" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.845"></a><span id="l7.845" class="difflineplus">+  mReferencedTimezones.Put(tzid, aTimezone);</span>
<a href="#l7.846"></a><span id="l7.846" class="difflineplus">+</span>
<a href="#l7.847"></a><span id="l7.847" class="difflineplus">+  return NS_OK;</span>
<a href="#l7.848"></a><span id="l7.848"> }</span>
<a href="#l7.849"></a><span id="l7.849"> </span>
<a href="#l7.850"></a><span id="l7.850"> NS_IMETHODIMP</span>
<a href="#l7.851"></a><span id="l7.851" class="difflineminus">-calIcalComponent::AddTimezoneReference(calITimezone *aTimezone)</span>
<a href="#l7.852"></a><span id="l7.852" class="difflineminus">-{</span>
<a href="#l7.853"></a><span id="l7.853" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aTimezone);</span>
<a href="#l7.854"></a><span id="l7.854" class="difflineminus">-    nsAutoCString tzid;</span>
<a href="#l7.855"></a><span id="l7.855" class="difflineminus">-    nsresult rv = aTimezone-&gt;GetTzid(tzid);</span>
<a href="#l7.856"></a><span id="l7.856" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.857"></a><span id="l7.857" class="difflineminus">-    mReferencedTimezones.Put(tzid, aTimezone);</span>
<a href="#l7.858"></a><span id="l7.858" class="difflineplus">+calIcalComponent::GetReferencedTimezones(uint32_t *aCount,</span>
<a href="#l7.859"></a><span id="l7.859" class="difflineplus">+                                         calITimezone ***aTimezones) {</span>
<a href="#l7.860"></a><span id="l7.860" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aCount);</span>
<a href="#l7.861"></a><span id="l7.861" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aTimezones);</span>
<a href="#l7.862"></a><span id="l7.862" class="difflineplus">+</span>
<a href="#l7.863"></a><span id="l7.863" class="difflineplus">+  uint32_t const count = mReferencedTimezones.Count();</span>
<a href="#l7.864"></a><span id="l7.864" class="difflineplus">+  if (count == 0) {</span>
<a href="#l7.865"></a><span id="l7.865" class="difflineplus">+    *aCount = 0;</span>
<a href="#l7.866"></a><span id="l7.866" class="difflineplus">+    *aTimezones = nullptr;</span>
<a href="#l7.867"></a><span id="l7.867" class="difflineplus">+    return NS_OK;</span>
<a href="#l7.868"></a><span id="l7.868" class="difflineplus">+  }</span>
<a href="#l7.869"></a><span id="l7.869"> </span>
<a href="#l7.870"></a><span id="l7.870" class="difflineminus">-    return NS_OK;</span>
<a href="#l7.871"></a><span id="l7.871" class="difflineplus">+  calITimezone **const timezones =</span>
<a href="#l7.872"></a><span id="l7.872" class="difflineplus">+      static_cast&lt;calITimezone **&gt;(moz_xmalloc(sizeof(calITimezone *) * count));</span>
<a href="#l7.873"></a><span id="l7.873" class="difflineplus">+  CAL_ENSURE_MEMORY(timezones);</span>
<a href="#l7.874"></a><span id="l7.874" class="difflineplus">+  // tzptr will get used as an iterator by the enumerator function</span>
<a href="#l7.875"></a><span id="l7.875" class="difflineplus">+  calITimezone **tzptr = timezones;</span>
<a href="#l7.876"></a><span id="l7.876" class="difflineplus">+  for (auto iter = mReferencedTimezones.ConstIter(); !iter.Done();</span>
<a href="#l7.877"></a><span id="l7.877" class="difflineplus">+       iter.Next()) {</span>
<a href="#l7.878"></a><span id="l7.878" class="difflineplus">+    NS_ADDREF(*tzptr = iter.Data());</span>
<a href="#l7.879"></a><span id="l7.879" class="difflineplus">+    ++tzptr;</span>
<a href="#l7.880"></a><span id="l7.880" class="difflineplus">+  }</span>
<a href="#l7.881"></a><span id="l7.881" class="difflineplus">+</span>
<a href="#l7.882"></a><span id="l7.882" class="difflineplus">+  *aTimezones = timezones;</span>
<a href="#l7.883"></a><span id="l7.883" class="difflineplus">+  *aCount = count;</span>
<a href="#l7.884"></a><span id="l7.884" class="difflineplus">+  return NS_OK;</span>
<a href="#l7.885"></a><span id="l7.885"> }</span>
<a href="#l7.886"></a><span id="l7.886"> </span>
<a href="#l7.887"></a><span id="l7.887" class="difflineminus">-</span>
<a href="#l7.888"></a><span id="l7.888" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l7.889"></a><span id="l7.889" class="difflineminus">-calIcalComponent::GetReferencedTimezones(uint32_t * aCount, calITimezone *** aTimezones)</span>
<a href="#l7.890"></a><span id="l7.890" class="difflineminus">-{</span>
<a href="#l7.891"></a><span id="l7.891" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aCount);</span>
<a href="#l7.892"></a><span id="l7.892" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aTimezones);</span>
<a href="#l7.893"></a><span id="l7.893" class="difflineminus">-</span>
<a href="#l7.894"></a><span id="l7.894" class="difflineminus">-    uint32_t const count = mReferencedTimezones.Count();</span>
<a href="#l7.895"></a><span id="l7.895" class="difflineminus">-    if (count == 0) {</span>
<a href="#l7.896"></a><span id="l7.896" class="difflineminus">-        *aCount = 0;</span>
<a href="#l7.897"></a><span id="l7.897" class="difflineminus">-        *aTimezones = nullptr;</span>
<a href="#l7.898"></a><span id="l7.898" class="difflineminus">-        return NS_OK;</span>
<a href="#l7.899"></a><span id="l7.899" class="difflineminus">-    }</span>
<a href="#l7.900"></a><span id="l7.900" class="difflineplus">+nsresult calIcalComponent::SetPropertyValue(icalproperty_kind kind,</span>
<a href="#l7.901"></a><span id="l7.901" class="difflineplus">+                                            icalvalue *val) {</span>
<a href="#l7.902"></a><span id="l7.902" class="difflineplus">+  ClearAllProperties(kind);</span>
<a href="#l7.903"></a><span id="l7.903" class="difflineplus">+  if (!val) return NS_OK;</span>
<a href="#l7.904"></a><span id="l7.904"> </span>
<a href="#l7.905"></a><span id="l7.905" class="difflineminus">-    calITimezone ** const timezones = static_cast&lt;calITimezone **&gt;(</span>
<a href="#l7.906"></a><span id="l7.906" class="difflineminus">-        moz_xmalloc(sizeof(calITimezone *) * count));</span>
<a href="#l7.907"></a><span id="l7.907" class="difflineminus">-    CAL_ENSURE_MEMORY(timezones);</span>
<a href="#l7.908"></a><span id="l7.908" class="difflineminus">-    // tzptr will get used as an iterator by the enumerator function</span>
<a href="#l7.909"></a><span id="l7.909" class="difflineminus">-    calITimezone ** tzptr = timezones;</span>
<a href="#l7.910"></a><span id="l7.910" class="difflineminus">-    for (auto iter = mReferencedTimezones.ConstIter(); !iter.Done(); iter.Next() ) {</span>
<a href="#l7.911"></a><span id="l7.911" class="difflineminus">-        NS_ADDREF(*tzptr = iter.Data());</span>
<a href="#l7.912"></a><span id="l7.912" class="difflineminus">-        ++tzptr;</span>
<a href="#l7.913"></a><span id="l7.913" class="difflineminus">-    }</span>
<a href="#l7.914"></a><span id="l7.914" class="difflineplus">+  icalproperty *prop = icalproperty_new(kind);</span>
<a href="#l7.915"></a><span id="l7.915" class="difflineplus">+  if (!prop) {</span>
<a href="#l7.916"></a><span id="l7.916" class="difflineplus">+    icalvalue_free(val);</span>
<a href="#l7.917"></a><span id="l7.917" class="difflineplus">+    return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l7.918"></a><span id="l7.918" class="difflineplus">+  }</span>
<a href="#l7.919"></a><span id="l7.919"> </span>
<a href="#l7.920"></a><span id="l7.920" class="difflineminus">-    *aTimezones = timezones;</span>
<a href="#l7.921"></a><span id="l7.921" class="difflineminus">-    *aCount = count;</span>
<a href="#l7.922"></a><span id="l7.922" class="difflineminus">-    return NS_OK;</span>
<a href="#l7.923"></a><span id="l7.923" class="difflineplus">+  icalproperty_set_value(prop, val);</span>
<a href="#l7.924"></a><span id="l7.924" class="difflineplus">+  icalcomponent_add_property(mComponent, prop);</span>
<a href="#l7.925"></a><span id="l7.925" class="difflineplus">+  return NS_OK;</span>
<a href="#l7.926"></a><span id="l7.926"> }</span>
<a href="#l7.927"></a><span id="l7.927"> </span>
<a href="#l7.928"></a><span id="l7.928" class="difflineminus">-nsresult</span>
<a href="#l7.929"></a><span id="l7.929" class="difflineminus">-calIcalComponent::SetPropertyValue(icalproperty_kind kind, icalvalue *val)</span>
<a href="#l7.930"></a><span id="l7.930" class="difflineminus">-{</span>
<a href="#l7.931"></a><span id="l7.931" class="difflineminus">-    ClearAllProperties(kind);</span>
<a href="#l7.932"></a><span id="l7.932" class="difflineminus">-    if (!val)</span>
<a href="#l7.933"></a><span id="l7.933" class="difflineminus">-        return NS_OK;</span>
<a href="#l7.934"></a><span id="l7.934" class="difflineminus">-</span>
<a href="#l7.935"></a><span id="l7.935" class="difflineminus">-    icalproperty *prop = icalproperty_new(kind);</span>
<a href="#l7.936"></a><span id="l7.936" class="difflineminus">-    if (!prop) {</span>
<a href="#l7.937"></a><span id="l7.937" class="difflineminus">-        icalvalue_free(val);</span>
<a href="#l7.938"></a><span id="l7.938" class="difflineminus">-        return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l7.939"></a><span id="l7.939" class="difflineminus">-    }</span>
<a href="#l7.940"></a><span id="l7.940" class="difflineminus">-</span>
<a href="#l7.941"></a><span id="l7.941" class="difflineminus">-    icalproperty_set_value(prop, val);</span>
<a href="#l7.942"></a><span id="l7.942" class="difflineminus">-    icalcomponent_add_property(mComponent, prop);</span>
<a href="#l7.943"></a><span id="l7.943" class="difflineminus">-    return NS_OK;</span>
<a href="#l7.944"></a><span id="l7.944" class="difflineminus">-}</span>
<a href="#l7.945"></a><span id="l7.945" class="difflineminus">-</span>
<a href="#l7.946"></a><span id="l7.946" class="difflineminus">-nsresult</span>
<a href="#l7.947"></a><span id="l7.947" class="difflineminus">-calIcalComponent::SetProperty(icalproperty_kind kind, icalproperty *prop)</span>
<a href="#l7.948"></a><span id="l7.948" class="difflineminus">-{</span>
<a href="#l7.949"></a><span id="l7.949" class="difflineminus">-    ClearAllProperties(kind);</span>
<a href="#l7.950"></a><span id="l7.950" class="difflineminus">-    if (!prop)</span>
<a href="#l7.951"></a><span id="l7.951" class="difflineminus">-        return NS_OK;</span>
<a href="#l7.952"></a><span id="l7.952" class="difflineminus">-    icalcomponent_add_property(mComponent, prop);</span>
<a href="#l7.953"></a><span id="l7.953" class="difflineminus">-    return NS_OK;</span>
<a href="#l7.954"></a><span id="l7.954" class="difflineplus">+nsresult calIcalComponent::SetProperty(icalproperty_kind kind,</span>
<a href="#l7.955"></a><span id="l7.955" class="difflineplus">+                                       icalproperty *prop) {</span>
<a href="#l7.956"></a><span id="l7.956" class="difflineplus">+  ClearAllProperties(kind);</span>
<a href="#l7.957"></a><span id="l7.957" class="difflineplus">+  if (!prop) return NS_OK;</span>
<a href="#l7.958"></a><span id="l7.958" class="difflineplus">+  icalcomponent_add_property(mComponent, prop);</span>
<a href="#l7.959"></a><span id="l7.959" class="difflineplus">+  return NS_OK;</span>
<a href="#l7.960"></a><span id="l7.960"> }</span>
<a href="#l7.961"></a><span id="l7.961"> </span>
<a href="#l7.962"></a><span id="l7.962" class="difflineminus">-#define COMP_STRING_TO_ENUM_ATTRIBUTE(Attrname, ICALNAME, lcname)       \</span>
<a href="#l7.963"></a><span id="l7.963" class="difflineminus">-NS_IMETHODIMP                                                           \</span>
<a href="#l7.964"></a><span id="l7.964" class="difflineminus">-calIcalComponent::Get##Attrname(nsACString &amp;str)                        \</span>
<a href="#l7.965"></a><span id="l7.965" class="difflineminus">-{                                                                       \</span>
<a href="#l7.966"></a><span id="l7.966" class="difflineminus">-    int32_t val;                                                        \</span>
<a href="#l7.967"></a><span id="l7.967" class="difflineminus">-    nsresult rv = GetIntProperty(ICAL_##ICALNAME##_PROPERTY, &amp;val);     \</span>
<a href="#l7.968"></a><span id="l7.968" class="difflineminus">-    if (NS_FAILED(rv))                                                  \</span>
<a href="#l7.969"></a><span id="l7.969" class="difflineminus">-        return rv;                                                      \</span>
<a href="#l7.970"></a><span id="l7.970" class="difflineminus">-    if (val == -1) {                                                    \</span>
<a href="#l7.971"></a><span id="l7.971" class="difflineminus">-        str.Truncate();                                                 \</span>
<a href="#l7.972"></a><span id="l7.972" class="difflineminus">-        str.SetIsVoid(true);                                         \</span>
<a href="#l7.973"></a><span id="l7.973" class="difflineminus">-    } else {                                                            \</span>
<a href="#l7.974"></a><span id="l7.974" class="difflineminus">-        str.Assign(icalproperty_##lcname##_to_string((icalproperty_##lcname)val)); \</span>
<a href="#l7.975"></a><span id="l7.975" class="difflineminus">-    }                                                                   \</span>
<a href="#l7.976"></a><span id="l7.976" class="difflineminus">-    return NS_OK;                                                       \</span>
<a href="#l7.977"></a><span id="l7.977" class="difflineminus">-}                                                                       \</span>
<a href="#l7.978"></a><span id="l7.978" class="difflineminus">-                                                                        \</span>
<a href="#l7.979"></a><span id="l7.979" class="difflineminus">-NS_IMETHODIMP                                                           \</span>
<a href="#l7.980"></a><span id="l7.980" class="difflineminus">-calIcalComponent::Set##Attrname(const nsACString &amp;str)                  \</span>
<a href="#l7.981"></a><span id="l7.981" class="difflineminus">-{                                                                       \</span>
<a href="#l7.982"></a><span id="l7.982" class="difflineminus">-    icalproperty *prop = nullptr;                                        \</span>
<a href="#l7.983"></a><span id="l7.983" class="difflineminus">-    if (!str.IsVoid()) {                                                \</span>
<a href="#l7.984"></a><span id="l7.984" class="difflineminus">-        icalproperty_##lcname val =                                     \</span>
<a href="#l7.985"></a><span id="l7.985" class="difflineminus">-            icalproperty_string_to_##lcname(PromiseFlatCString(str).get()); \</span>
<a href="#l7.986"></a><span id="l7.986" class="difflineminus">-        prop = icalproperty_new_##lcname(val);                          \</span>
<a href="#l7.987"></a><span id="l7.987" class="difflineminus">-        if (!prop)                                                      \</span>
<a href="#l7.988"></a><span id="l7.988" class="difflineminus">-            return NS_ERROR_OUT_OF_MEMORY; /* XXX map errno */          \</span>
<a href="#l7.989"></a><span id="l7.989" class="difflineminus">-    }                                                                   \</span>
<a href="#l7.990"></a><span id="l7.990" class="difflineminus">-    return SetProperty(ICAL_##ICALNAME##_PROPERTY, prop);               \</span>
<a href="#l7.991"></a><span id="l7.991" class="difflineminus">-}</span>
<a href="#l7.992"></a><span id="l7.992" class="difflineplus">+#define COMP_STRING_TO_ENUM_ATTRIBUTE(Attrname, ICALNAME, lcname)         \</span>
<a href="#l7.993"></a><span id="l7.993" class="difflineplus">+  NS_IMETHODIMP                                                           \</span>
<a href="#l7.994"></a><span id="l7.994" class="difflineplus">+  calIcalComponent::Get##Attrname(nsACString &amp;str) {                      \</span>
<a href="#l7.995"></a><span id="l7.995" class="difflineplus">+    int32_t val;                                                          \</span>
<a href="#l7.996"></a><span id="l7.996" class="difflineplus">+    nsresult rv = GetIntProperty(ICAL_##ICALNAME##_PROPERTY, &amp;val);       \</span>
<a href="#l7.997"></a><span id="l7.997" class="difflineplus">+    if (NS_FAILED(rv)) return rv;                                         \</span>
<a href="#l7.998"></a><span id="l7.998" class="difflineplus">+    if (val == -1) {                                                      \</span>
<a href="#l7.999"></a><span id="l7.999" class="difflineplus">+      str.Truncate();                                                     \</span>
<a href="#l7.1000"></a><span id="l7.1000" class="difflineplus">+      str.SetIsVoid(true);                                                \</span>
<a href="#l7.1001"></a><span id="l7.1001" class="difflineplus">+    } else {                                                              \</span>
<a href="#l7.1002"></a><span id="l7.1002" class="difflineplus">+      str.Assign(                                                         \</span>
<a href="#l7.1003"></a><span id="l7.1003" class="difflineplus">+          icalproperty_##lcname##_to_string((icalproperty_##lcname)val)); \</span>
<a href="#l7.1004"></a><span id="l7.1004" class="difflineplus">+    }                                                                     \</span>
<a href="#l7.1005"></a><span id="l7.1005" class="difflineplus">+    return NS_OK;                                                         \</span>
<a href="#l7.1006"></a><span id="l7.1006" class="difflineplus">+  }                                                                       \</span>
<a href="#l7.1007"></a><span id="l7.1007" class="difflineplus">+                                                                          \</span>
<a href="#l7.1008"></a><span id="l7.1008" class="difflineplus">+  NS_IMETHODIMP                                                           \</span>
<a href="#l7.1009"></a><span id="l7.1009" class="difflineplus">+  calIcalComponent::Set##Attrname(const nsACString &amp;str) {                \</span>
<a href="#l7.1010"></a><span id="l7.1010" class="difflineplus">+    icalproperty *prop = nullptr;                                         \</span>
<a href="#l7.1011"></a><span id="l7.1011" class="difflineplus">+    if (!str.IsVoid()) {                                                  \</span>
<a href="#l7.1012"></a><span id="l7.1012" class="difflineplus">+      icalproperty_##lcname val =                                         \</span>
<a href="#l7.1013"></a><span id="l7.1013" class="difflineplus">+          icalproperty_string_to_##lcname(PromiseFlatCString(str).get()); \</span>
<a href="#l7.1014"></a><span id="l7.1014" class="difflineplus">+      prop = icalproperty_new_##lcname(val);                              \</span>
<a href="#l7.1015"></a><span id="l7.1015" class="difflineplus">+      if (!prop) return NS_ERROR_OUT_OF_MEMORY; /* XXX map errno */       \</span>
<a href="#l7.1016"></a><span id="l7.1016" class="difflineplus">+    }                                                                     \</span>
<a href="#l7.1017"></a><span id="l7.1017" class="difflineplus">+    return SetProperty(ICAL_##ICALNAME##_PROPERTY, prop);                 \</span>
<a href="#l7.1018"></a><span id="l7.1018" class="difflineplus">+  }</span>
<a href="#l7.1019"></a><span id="l7.1019"> </span>
<a href="#l7.1020"></a><span id="l7.1020" class="difflineminus">-#define COMP_GENERAL_STRING_ATTRIBUTE(Attrname, ICALNAME)       \</span>
<a href="#l7.1021"></a><span id="l7.1021" class="difflineminus">-NS_IMETHODIMP                                                   \</span>
<a href="#l7.1022"></a><span id="l7.1022" class="difflineminus">-calIcalComponent::Get##Attrname(nsACString &amp;str)                \</span>
<a href="#l7.1023"></a><span id="l7.1023" class="difflineminus">-{                                                               \</span>
<a href="#l7.1024"></a><span id="l7.1024" class="difflineminus">-    return GetStringProperty(ICAL_##ICALNAME##_PROPERTY, str);  \</span>
<a href="#l7.1025"></a><span id="l7.1025" class="difflineminus">-}                                                               \</span>
<a href="#l7.1026"></a><span id="l7.1026" class="difflineminus">-                                                                \</span>
<a href="#l7.1027"></a><span id="l7.1027" class="difflineminus">-NS_IMETHODIMP                                                   \</span>
<a href="#l7.1028"></a><span id="l7.1028" class="difflineminus">-calIcalComponent::Set##Attrname(const nsACString &amp;str)          \</span>
<a href="#l7.1029"></a><span id="l7.1029" class="difflineminus">-{                                                               \</span>
<a href="#l7.1030"></a><span id="l7.1030" class="difflineminus">-    return SetStringProperty(ICAL_##ICALNAME##_PROPERTY, str);  \</span>
<a href="#l7.1031"></a><span id="l7.1031" class="difflineminus">-}</span>
<a href="#l7.1032"></a><span id="l7.1032" class="difflineplus">+#define COMP_GENERAL_STRING_ATTRIBUTE(Attrname, ICALNAME)      \</span>
<a href="#l7.1033"></a><span id="l7.1033" class="difflineplus">+  NS_IMETHODIMP                                                \</span>
<a href="#l7.1034"></a><span id="l7.1034" class="difflineplus">+  calIcalComponent::Get##Attrname(nsACString &amp;str) {           \</span>
<a href="#l7.1035"></a><span id="l7.1035" class="difflineplus">+    return GetStringProperty(ICAL_##ICALNAME##_PROPERTY, str); \</span>
<a href="#l7.1036"></a><span id="l7.1036" class="difflineplus">+  }                                                            \</span>
<a href="#l7.1037"></a><span id="l7.1037" class="difflineplus">+                                                               \</span>
<a href="#l7.1038"></a><span id="l7.1038" class="difflineplus">+  NS_IMETHODIMP                                                \</span>
<a href="#l7.1039"></a><span id="l7.1039" class="difflineplus">+  calIcalComponent::Set##Attrname(const nsACString &amp;str) {     \</span>
<a href="#l7.1040"></a><span id="l7.1040" class="difflineplus">+    return SetStringProperty(ICAL_##ICALNAME##_PROPERTY, str); \</span>
<a href="#l7.1041"></a><span id="l7.1041" class="difflineplus">+  }</span>
<a href="#l7.1042"></a><span id="l7.1042"> </span>
<a href="#l7.1043"></a><span id="l7.1043" class="difflineminus">-#define COMP_STRING_ATTRIBUTE(Attrname, ICALNAME, lcname)       \</span>
<a href="#l7.1044"></a><span id="l7.1044" class="difflineminus">-NS_IMETHODIMP                                                   \</span>
<a href="#l7.1045"></a><span id="l7.1045" class="difflineminus">-calIcalComponent::Get##Attrname(nsACString &amp;str)                \</span>
<a href="#l7.1046"></a><span id="l7.1046" class="difflineminus">-{                                                               \</span>
<a href="#l7.1047"></a><span id="l7.1047" class="difflineminus">-    return GetStringProperty(ICAL_##ICALNAME##_PROPERTY, str);  \</span>
<a href="#l7.1048"></a><span id="l7.1048" class="difflineminus">-}                                                               \</span>
<a href="#l7.1049"></a><span id="l7.1049" class="difflineminus">-                                                                \</span>
<a href="#l7.1050"></a><span id="l7.1050" class="difflineminus">-NS_IMETHODIMP                                                   \</span>
<a href="#l7.1051"></a><span id="l7.1051" class="difflineminus">-calIcalComponent::Set##Attrname(const nsACString &amp;str)          \</span>
<a href="#l7.1052"></a><span id="l7.1052" class="difflineminus">-{                                                               \</span>
<a href="#l7.1053"></a><span id="l7.1053" class="difflineminus">-    icalproperty *prop =                                        \</span>
<a href="#l7.1054"></a><span id="l7.1054" class="difflineplus">+#define COMP_STRING_ATTRIBUTE(Attrname, ICALNAME, lcname)         \</span>
<a href="#l7.1055"></a><span id="l7.1055" class="difflineplus">+  NS_IMETHODIMP                                                   \</span>
<a href="#l7.1056"></a><span id="l7.1056" class="difflineplus">+  calIcalComponent::Get##Attrname(nsACString &amp;str) {              \</span>
<a href="#l7.1057"></a><span id="l7.1057" class="difflineplus">+    return GetStringProperty(ICAL_##ICALNAME##_PROPERTY, str);    \</span>
<a href="#l7.1058"></a><span id="l7.1058" class="difflineplus">+  }                                                               \</span>
<a href="#l7.1059"></a><span id="l7.1059" class="difflineplus">+                                                                  \</span>
<a href="#l7.1060"></a><span id="l7.1060" class="difflineplus">+  NS_IMETHODIMP                                                   \</span>
<a href="#l7.1061"></a><span id="l7.1061" class="difflineplus">+  calIcalComponent::Set##Attrname(const nsACString &amp;str) {        \</span>
<a href="#l7.1062"></a><span id="l7.1062" class="difflineplus">+    icalproperty *prop =                                          \</span>
<a href="#l7.1063"></a><span id="l7.1063">         icalproperty_new_##lcname(PromiseFlatCString(str).get()); \</span>
<a href="#l7.1064"></a><span id="l7.1064" class="difflineminus">-    return SetProperty(ICAL_##ICALNAME##_PROPERTY, prop);       \</span>
<a href="#l7.1065"></a><span id="l7.1065" class="difflineminus">-}</span>
<a href="#l7.1066"></a><span id="l7.1066" class="difflineplus">+    return SetProperty(ICAL_##ICALNAME##_PROPERTY, prop);         \</span>
<a href="#l7.1067"></a><span id="l7.1067" class="difflineplus">+  }</span>
<a href="#l7.1068"></a><span id="l7.1068"> </span>
<a href="#l7.1069"></a><span id="l7.1069" class="difflineminus">-#define COMP_GENERAL_INT_ATTRIBUTE(Attrname, ICALNAME)          \</span>
<a href="#l7.1070"></a><span id="l7.1070" class="difflineminus">-NS_IMETHODIMP                                                   \</span>
<a href="#l7.1071"></a><span id="l7.1071" class="difflineminus">-calIcalComponent::Get##Attrname(int32_t *valp)                  \</span>
<a href="#l7.1072"></a><span id="l7.1072" class="difflineminus">-{                                                               \</span>
<a href="#l7.1073"></a><span id="l7.1073" class="difflineminus">-    return GetIntProperty(ICAL_##ICALNAME##_PROPERTY, valp);    \</span>
<a href="#l7.1074"></a><span id="l7.1074" class="difflineminus">-}                                                               \</span>
<a href="#l7.1075"></a><span id="l7.1075" class="difflineminus">-                                                                \</span>
<a href="#l7.1076"></a><span id="l7.1076" class="difflineminus">-NS_IMETHODIMP                                                   \</span>
<a href="#l7.1077"></a><span id="l7.1077" class="difflineminus">-calIcalComponent::Set##Attrname(int32_t val)                    \</span>
<a href="#l7.1078"></a><span id="l7.1078" class="difflineminus">-{                                                               \</span>
<a href="#l7.1079"></a><span id="l7.1079" class="difflineminus">-    return SetIntProperty(ICAL_##ICALNAME##_PROPERTY, val);     \</span>
<a href="#l7.1080"></a><span id="l7.1080" class="difflineminus">-}</span>
<a href="#l7.1081"></a><span id="l7.1081" class="difflineplus">+#define COMP_GENERAL_INT_ATTRIBUTE(Attrname, ICALNAME)       \</span>
<a href="#l7.1082"></a><span id="l7.1082" class="difflineplus">+  NS_IMETHODIMP                                              \</span>
<a href="#l7.1083"></a><span id="l7.1083" class="difflineplus">+  calIcalComponent::Get##Attrname(int32_t *valp) {           \</span>
<a href="#l7.1084"></a><span id="l7.1084" class="difflineplus">+    return GetIntProperty(ICAL_##ICALNAME##_PROPERTY, valp); \</span>
<a href="#l7.1085"></a><span id="l7.1085" class="difflineplus">+  }                                                          \</span>
<a href="#l7.1086"></a><span id="l7.1086" class="difflineplus">+                                                             \</span>
<a href="#l7.1087"></a><span id="l7.1087" class="difflineplus">+  NS_IMETHODIMP                                              \</span>
<a href="#l7.1088"></a><span id="l7.1088" class="difflineplus">+  calIcalComponent::Set##Attrname(int32_t val) {             \</span>
<a href="#l7.1089"></a><span id="l7.1089" class="difflineplus">+    return SetIntProperty(ICAL_##ICALNAME##_PROPERTY, val);  \</span>
<a href="#l7.1090"></a><span id="l7.1090" class="difflineplus">+  }</span>
<a href="#l7.1091"></a><span id="l7.1091"> </span>
<a href="#l7.1092"></a><span id="l7.1092" class="difflineminus">-#define COMP_ENUM_ATTRIBUTE(Attrname, ICALNAME, lcname)         \</span>
<a href="#l7.1093"></a><span id="l7.1093" class="difflineminus">-NS_IMETHODIMP                                                   \</span>
<a href="#l7.1094"></a><span id="l7.1094" class="difflineminus">-calIcalComponent::Get##Attrname(int32_t *valp)                  \</span>
<a href="#l7.1095"></a><span id="l7.1095" class="difflineminus">-{                                                               \</span>
<a href="#l7.1096"></a><span id="l7.1096" class="difflineminus">-    return GetIntProperty(ICAL_##ICALNAME##_PROPERTY, valp);    \</span>
<a href="#l7.1097"></a><span id="l7.1097" class="difflineminus">-}                                                               \</span>
<a href="#l7.1098"></a><span id="l7.1098" class="difflineminus">-                                                                \</span>
<a href="#l7.1099"></a><span id="l7.1099" class="difflineminus">-NS_IMETHODIMP                                                   \</span>
<a href="#l7.1100"></a><span id="l7.1100" class="difflineminus">-calIcalComponent::Set##Attrname(int32_t val)                    \</span>
<a href="#l7.1101"></a><span id="l7.1101" class="difflineminus">-{                                                               \</span>
<a href="#l7.1102"></a><span id="l7.1102" class="difflineminus">-    icalproperty *prop =                                        \</span>
<a href="#l7.1103"></a><span id="l7.1103" class="difflineminus">-      icalproperty_new_##lcname((icalproperty_##lcname)val);    \</span>
<a href="#l7.1104"></a><span id="l7.1104" class="difflineminus">-    return SetProperty(ICAL_##ICALNAME##_PROPERTY, prop);       \</span>
<a href="#l7.1105"></a><span id="l7.1105" class="difflineminus">-}</span>
<a href="#l7.1106"></a><span id="l7.1106" class="difflineplus">+#define COMP_ENUM_ATTRIBUTE(Attrname, ICALNAME, lcname)        \</span>
<a href="#l7.1107"></a><span id="l7.1107" class="difflineplus">+  NS_IMETHODIMP                                                \</span>
<a href="#l7.1108"></a><span id="l7.1108" class="difflineplus">+  calIcalComponent::Get##Attrname(int32_t *valp) {             \</span>
<a href="#l7.1109"></a><span id="l7.1109" class="difflineplus">+    return GetIntProperty(ICAL_##ICALNAME##_PROPERTY, valp);   \</span>
<a href="#l7.1110"></a><span id="l7.1110" class="difflineplus">+  }                                                            \</span>
<a href="#l7.1111"></a><span id="l7.1111" class="difflineplus">+                                                               \</span>
<a href="#l7.1112"></a><span id="l7.1112" class="difflineplus">+  NS_IMETHODIMP                                                \</span>
<a href="#l7.1113"></a><span id="l7.1113" class="difflineplus">+  calIcalComponent::Set##Attrname(int32_t val) {               \</span>
<a href="#l7.1114"></a><span id="l7.1114" class="difflineplus">+    icalproperty *prop =                                       \</span>
<a href="#l7.1115"></a><span id="l7.1115" class="difflineplus">+        icalproperty_new_##lcname((icalproperty_##lcname)val); \</span>
<a href="#l7.1116"></a><span id="l7.1116" class="difflineplus">+    return SetProperty(ICAL_##ICALNAME##_PROPERTY, prop);      \</span>
<a href="#l7.1117"></a><span id="l7.1117" class="difflineplus">+  }</span>
<a href="#l7.1118"></a><span id="l7.1118"> </span>
<a href="#l7.1119"></a><span id="l7.1119" class="difflineminus">-#define COMP_INT_ATTRIBUTE(Attrname, ICALNAME, lcname)          \</span>
<a href="#l7.1120"></a><span id="l7.1120" class="difflineminus">-NS_IMETHODIMP                                                   \</span>
<a href="#l7.1121"></a><span id="l7.1121" class="difflineminus">-calIcalComponent::Get##Attrname(int32_t *valp)                  \</span>
<a href="#l7.1122"></a><span id="l7.1122" class="difflineminus">-{                                                               \</span>
<a href="#l7.1123"></a><span id="l7.1123" class="difflineminus">-    return GetIntProperty(ICAL_##ICALNAME##_PROPERTY, valp);    \</span>
<a href="#l7.1124"></a><span id="l7.1124" class="difflineminus">-}                                                               \</span>
<a href="#l7.1125"></a><span id="l7.1125" class="difflineminus">-                                                                \</span>
<a href="#l7.1126"></a><span id="l7.1126" class="difflineminus">-NS_IMETHODIMP                                                   \</span>
<a href="#l7.1127"></a><span id="l7.1127" class="difflineminus">-calIcalComponent::Set##Attrname(int32_t val)                    \</span>
<a href="#l7.1128"></a><span id="l7.1128" class="difflineminus">-{                                                               \</span>
<a href="#l7.1129"></a><span id="l7.1129" class="difflineminus">-    icalproperty *prop = icalproperty_new_##lcname(val);        \</span>
<a href="#l7.1130"></a><span id="l7.1130" class="difflineminus">-    return SetProperty(ICAL_##ICALNAME##_PROPERTY, prop);       \</span>
<a href="#l7.1131"></a><span id="l7.1131" class="difflineminus">-}</span>
<a href="#l7.1132"></a><span id="l7.1132" class="difflineplus">+#define COMP_INT_ATTRIBUTE(Attrname, ICALNAME, lcname)       \</span>
<a href="#l7.1133"></a><span id="l7.1133" class="difflineplus">+  NS_IMETHODIMP                                              \</span>
<a href="#l7.1134"></a><span id="l7.1134" class="difflineplus">+  calIcalComponent::Get##Attrname(int32_t *valp) {           \</span>
<a href="#l7.1135"></a><span id="l7.1135" class="difflineplus">+    return GetIntProperty(ICAL_##ICALNAME##_PROPERTY, valp); \</span>
<a href="#l7.1136"></a><span id="l7.1136" class="difflineplus">+  }                                                          \</span>
<a href="#l7.1137"></a><span id="l7.1137" class="difflineplus">+                                                             \</span>
<a href="#l7.1138"></a><span id="l7.1138" class="difflineplus">+  NS_IMETHODIMP                                              \</span>
<a href="#l7.1139"></a><span id="l7.1139" class="difflineplus">+  calIcalComponent::Set##Attrname(int32_t val) {             \</span>
<a href="#l7.1140"></a><span id="l7.1140" class="difflineplus">+    icalproperty *prop = icalproperty_new_##lcname(val);     \</span>
<a href="#l7.1141"></a><span id="l7.1141" class="difflineplus">+    return SetProperty(ICAL_##ICALNAME##_PROPERTY, prop);    \</span>
<a href="#l7.1142"></a><span id="l7.1142" class="difflineplus">+  }</span>
<a href="#l7.1143"></a><span id="l7.1143"> </span>
<a href="#l7.1144"></a><span id="l7.1144" class="difflineminus">-nsresult calIcalComponent::GetStringProperty(icalproperty_kind kind, nsACString &amp;str)</span>
<a href="#l7.1145"></a><span id="l7.1145" class="difflineminus">-{</span>
<a href="#l7.1146"></a><span id="l7.1146" class="difflineminus">-    icalproperty *prop = icalcomponent_get_first_property(mComponent, kind);</span>
<a href="#l7.1147"></a><span id="l7.1147" class="difflineminus">-    if (!prop) {</span>
<a href="#l7.1148"></a><span id="l7.1148" class="difflineminus">-        str.Truncate();</span>
<a href="#l7.1149"></a><span id="l7.1149" class="difflineminus">-        str.SetIsVoid(true);</span>
<a href="#l7.1150"></a><span id="l7.1150" class="difflineminus">-    } else {</span>
<a href="#l7.1151"></a><span id="l7.1151" class="difflineminus">-        str.Assign(icalvalue_get_string(icalproperty_get_value(prop)));</span>
<a href="#l7.1152"></a><span id="l7.1152" class="difflineminus">-    }</span>
<a href="#l7.1153"></a><span id="l7.1153" class="difflineminus">-    return NS_OK;</span>
<a href="#l7.1154"></a><span id="l7.1154" class="difflineplus">+nsresult calIcalComponent::GetStringProperty(icalproperty_kind kind,</span>
<a href="#l7.1155"></a><span id="l7.1155" class="difflineplus">+                                             nsACString &amp;str) {</span>
<a href="#l7.1156"></a><span id="l7.1156" class="difflineplus">+  icalproperty *prop = icalcomponent_get_first_property(mComponent, kind);</span>
<a href="#l7.1157"></a><span id="l7.1157" class="difflineplus">+  if (!prop) {</span>
<a href="#l7.1158"></a><span id="l7.1158" class="difflineplus">+    str.Truncate();</span>
<a href="#l7.1159"></a><span id="l7.1159" class="difflineplus">+    str.SetIsVoid(true);</span>
<a href="#l7.1160"></a><span id="l7.1160" class="difflineplus">+  } else {</span>
<a href="#l7.1161"></a><span id="l7.1161" class="difflineplus">+    str.Assign(icalvalue_get_string(icalproperty_get_value(prop)));</span>
<a href="#l7.1162"></a><span id="l7.1162" class="difflineplus">+  }</span>
<a href="#l7.1163"></a><span id="l7.1163" class="difflineplus">+  return NS_OK;</span>
<a href="#l7.1164"></a><span id="l7.1164"> }</span>
<a href="#l7.1165"></a><span id="l7.1165"> </span>
<a href="#l7.1166"></a><span id="l7.1166"> nsresult calIcalComponent::SetStringProperty(icalproperty_kind kind,</span>
<a href="#l7.1167"></a><span id="l7.1167" class="difflineminus">-                                             const nsACString &amp;str)</span>
<a href="#l7.1168"></a><span id="l7.1168" class="difflineminus">-{</span>
<a href="#l7.1169"></a><span id="l7.1169" class="difflineminus">-    icalvalue *val = nullptr;</span>
<a href="#l7.1170"></a><span id="l7.1170" class="difflineminus">-    if (!str.IsVoid()) {</span>
<a href="#l7.1171"></a><span id="l7.1171" class="difflineminus">-        val = icalvalue_new_string(PromiseFlatCString(str).get());</span>
<a href="#l7.1172"></a><span id="l7.1172" class="difflineminus">-        if (!val)</span>
<a href="#l7.1173"></a><span id="l7.1173" class="difflineminus">-            return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l7.1174"></a><span id="l7.1174" class="difflineminus">-    }</span>
<a href="#l7.1175"></a><span id="l7.1175" class="difflineminus">-    return SetPropertyValue(kind, val);</span>
<a href="#l7.1176"></a><span id="l7.1176" class="difflineplus">+                                             const nsACString &amp;str) {</span>
<a href="#l7.1177"></a><span id="l7.1177" class="difflineplus">+  icalvalue *val = nullptr;</span>
<a href="#l7.1178"></a><span id="l7.1178" class="difflineplus">+  if (!str.IsVoid()) {</span>
<a href="#l7.1179"></a><span id="l7.1179" class="difflineplus">+    val = icalvalue_new_string(PromiseFlatCString(str).get());</span>
<a href="#l7.1180"></a><span id="l7.1180" class="difflineplus">+    if (!val) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l7.1181"></a><span id="l7.1181" class="difflineplus">+  }</span>
<a href="#l7.1182"></a><span id="l7.1182" class="difflineplus">+  return SetPropertyValue(kind, val);</span>
<a href="#l7.1183"></a><span id="l7.1183"> }</span>
<a href="#l7.1184"></a><span id="l7.1184"> </span>
<a href="#l7.1185"></a><span id="l7.1185" class="difflineminus">-nsresult calIcalComponent::GetIntProperty(icalproperty_kind kind, int32_t *valp)</span>
<a href="#l7.1186"></a><span id="l7.1186" class="difflineminus">-{</span>
<a href="#l7.1187"></a><span id="l7.1187" class="difflineminus">-    icalproperty *prop = icalcomponent_get_first_property(mComponent, kind);</span>
<a href="#l7.1188"></a><span id="l7.1188" class="difflineminus">-    if (!prop)</span>
<a href="#l7.1189"></a><span id="l7.1189" class="difflineminus">-        *valp = calIIcalComponent::INVALID_VALUE;</span>
<a href="#l7.1190"></a><span id="l7.1190" class="difflineminus">-    else</span>
<a href="#l7.1191"></a><span id="l7.1191" class="difflineminus">-        *valp = (int32_t)icalvalue_get_integer(icalproperty_get_value(prop));</span>
<a href="#l7.1192"></a><span id="l7.1192" class="difflineminus">-    return NS_OK;</span>
<a href="#l7.1193"></a><span id="l7.1193" class="difflineplus">+nsresult calIcalComponent::GetIntProperty(icalproperty_kind kind,</span>
<a href="#l7.1194"></a><span id="l7.1194" class="difflineplus">+                                          int32_t *valp) {</span>
<a href="#l7.1195"></a><span id="l7.1195" class="difflineplus">+  icalproperty *prop = icalcomponent_get_first_property(mComponent, kind);</span>
<a href="#l7.1196"></a><span id="l7.1196" class="difflineplus">+  if (!prop)</span>
<a href="#l7.1197"></a><span id="l7.1197" class="difflineplus">+    *valp = calIIcalComponent::INVALID_VALUE;</span>
<a href="#l7.1198"></a><span id="l7.1198" class="difflineplus">+  else</span>
<a href="#l7.1199"></a><span id="l7.1199" class="difflineplus">+    *valp = (int32_t)icalvalue_get_integer(icalproperty_get_value(prop));</span>
<a href="#l7.1200"></a><span id="l7.1200" class="difflineplus">+  return NS_OK;</span>
<a href="#l7.1201"></a><span id="l7.1201"> }</span>
<a href="#l7.1202"></a><span id="l7.1202"> </span>
<a href="#l7.1203"></a><span id="l7.1203" class="difflineminus">-nsresult calIcalComponent::SetIntProperty(icalproperty_kind kind, int32_t i)</span>
<a href="#l7.1204"></a><span id="l7.1204" class="difflineminus">-{</span>
<a href="#l7.1205"></a><span id="l7.1205" class="difflineminus">-    icalvalue *val = icalvalue_new_integer(i);</span>
<a href="#l7.1206"></a><span id="l7.1206" class="difflineminus">-    if (!val)</span>
<a href="#l7.1207"></a><span id="l7.1207" class="difflineminus">-        return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l7.1208"></a><span id="l7.1208" class="difflineminus">-    return SetPropertyValue(kind, val);</span>
<a href="#l7.1209"></a><span id="l7.1209" class="difflineplus">+nsresult calIcalComponent::SetIntProperty(icalproperty_kind kind, int32_t i) {</span>
<a href="#l7.1210"></a><span id="l7.1210" class="difflineplus">+  icalvalue *val = icalvalue_new_integer(i);</span>
<a href="#l7.1211"></a><span id="l7.1211" class="difflineplus">+  if (!val) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l7.1212"></a><span id="l7.1212" class="difflineplus">+  return SetPropertyValue(kind, val);</span>
<a href="#l7.1213"></a><span id="l7.1213"> }</span>
<a href="#l7.1214"></a><span id="l7.1214"> </span>
<a href="#l7.1215"></a><span id="l7.1215"> nsresult calIcalComponent::GetDateTimeAttribute(icalproperty_kind kind,</span>
<a href="#l7.1216"></a><span id="l7.1216" class="difflineminus">-                                                calIDateTime ** dtp)</span>
<a href="#l7.1217"></a><span id="l7.1217" class="difflineminus">-{</span>
<a href="#l7.1218"></a><span id="l7.1218" class="difflineminus">-    NS_ENSURE_ARG_POINTER(dtp);</span>
<a href="#l7.1219"></a><span id="l7.1219" class="difflineminus">-    icalproperty *prop = icalcomponent_get_first_property(mComponent, kind);</span>
<a href="#l7.1220"></a><span id="l7.1220" class="difflineminus">-    if (!prop) {</span>
<a href="#l7.1221"></a><span id="l7.1221" class="difflineminus">-        *dtp = nullptr;  /* invalid date */</span>
<a href="#l7.1222"></a><span id="l7.1222" class="difflineminus">-        return NS_OK;</span>
<a href="#l7.1223"></a><span id="l7.1223" class="difflineminus">-    }</span>
<a href="#l7.1224"></a><span id="l7.1224" class="difflineminus">-    return calIcalProperty::getDatetime_(this, prop, dtp);</span>
<a href="#l7.1225"></a><span id="l7.1225" class="difflineplus">+                                                calIDateTime **dtp) {</span>
<a href="#l7.1226"></a><span id="l7.1226" class="difflineplus">+  NS_ENSURE_ARG_POINTER(dtp);</span>
<a href="#l7.1227"></a><span id="l7.1227" class="difflineplus">+  icalproperty *prop = icalcomponent_get_first_property(mComponent, kind);</span>
<a href="#l7.1228"></a><span id="l7.1228" class="difflineplus">+  if (!prop) {</span>
<a href="#l7.1229"></a><span id="l7.1229" class="difflineplus">+    *dtp = nullptr; /* invalid date */</span>
<a href="#l7.1230"></a><span id="l7.1230" class="difflineplus">+    return NS_OK;</span>
<a href="#l7.1231"></a><span id="l7.1231" class="difflineplus">+  }</span>
<a href="#l7.1232"></a><span id="l7.1232" class="difflineplus">+  return calIcalProperty::getDatetime_(this, prop, dtp);</span>
<a href="#l7.1233"></a><span id="l7.1233"> }</span>
<a href="#l7.1234"></a><span id="l7.1234"> </span>
<a href="#l7.1235"></a><span id="l7.1235"> nsresult calIcalComponent::SetDateTimeAttribute(icalproperty_kind kind,</span>
<a href="#l7.1236"></a><span id="l7.1236" class="difflineminus">-                                                calIDateTime * dt)</span>
<a href="#l7.1237"></a><span id="l7.1237" class="difflineminus">-{</span>
<a href="#l7.1238"></a><span id="l7.1238" class="difflineminus">-    ClearAllProperties(kind);</span>
<a href="#l7.1239"></a><span id="l7.1239" class="difflineminus">-    bool isValid;</span>
<a href="#l7.1240"></a><span id="l7.1240" class="difflineminus">-    if (!dt || NS_FAILED(dt-&gt;GetIsValid(&amp;isValid)) || !isValid) {</span>
<a href="#l7.1241"></a><span id="l7.1241" class="difflineminus">-        return NS_OK;</span>
<a href="#l7.1242"></a><span id="l7.1242" class="difflineminus">-    }</span>
<a href="#l7.1243"></a><span id="l7.1243" class="difflineminus">-    icalproperty *prop = icalproperty_new(kind);</span>
<a href="#l7.1244"></a><span id="l7.1244" class="difflineminus">-    CAL_ENSURE_MEMORY(prop);</span>
<a href="#l7.1245"></a><span id="l7.1245" class="difflineminus">-    nsresult rc = calIcalProperty::setDatetime_(this, prop, dt);</span>
<a href="#l7.1246"></a><span id="l7.1246" class="difflineminus">-    if (NS_SUCCEEDED(rc))</span>
<a href="#l7.1247"></a><span id="l7.1247" class="difflineminus">-        icalcomponent_add_property(mComponent, prop);</span>
<a href="#l7.1248"></a><span id="l7.1248" class="difflineminus">-    else</span>
<a href="#l7.1249"></a><span id="l7.1249" class="difflineminus">-        icalproperty_free(prop);</span>
<a href="#l7.1250"></a><span id="l7.1250" class="difflineminus">-    return rc;</span>
<a href="#l7.1251"></a><span id="l7.1251" class="difflineplus">+                                                calIDateTime *dt) {</span>
<a href="#l7.1252"></a><span id="l7.1252" class="difflineplus">+  ClearAllProperties(kind);</span>
<a href="#l7.1253"></a><span id="l7.1253" class="difflineplus">+  bool isValid;</span>
<a href="#l7.1254"></a><span id="l7.1254" class="difflineplus">+  if (!dt || NS_FAILED(dt-&gt;GetIsValid(&amp;isValid)) || !isValid) {</span>
<a href="#l7.1255"></a><span id="l7.1255" class="difflineplus">+    return NS_OK;</span>
<a href="#l7.1256"></a><span id="l7.1256" class="difflineplus">+  }</span>
<a href="#l7.1257"></a><span id="l7.1257" class="difflineplus">+  icalproperty *prop = icalproperty_new(kind);</span>
<a href="#l7.1258"></a><span id="l7.1258" class="difflineplus">+  CAL_ENSURE_MEMORY(prop);</span>
<a href="#l7.1259"></a><span id="l7.1259" class="difflineplus">+  nsresult rc = calIcalProperty::setDatetime_(this, prop, dt);</span>
<a href="#l7.1260"></a><span id="l7.1260" class="difflineplus">+  if (NS_SUCCEEDED(rc))</span>
<a href="#l7.1261"></a><span id="l7.1261" class="difflineplus">+    icalcomponent_add_property(mComponent, prop);</span>
<a href="#l7.1262"></a><span id="l7.1262" class="difflineplus">+  else</span>
<a href="#l7.1263"></a><span id="l7.1263" class="difflineplus">+    icalproperty_free(prop);</span>
<a href="#l7.1264"></a><span id="l7.1264" class="difflineplus">+  return rc;</span>
<a href="#l7.1265"></a><span id="l7.1265"> }</span>
<a href="#l7.1266"></a><span id="l7.1266"> </span>
<a href="#l7.1267"></a><span id="l7.1267"> NS_IMETHODIMP</span>
<a href="#l7.1268"></a><span id="l7.1268" class="difflineminus">-calIcalProperty::GetParent(calIIcalComponent** parent)</span>
<a href="#l7.1269"></a><span id="l7.1269" class="difflineminus">-{</span>
<a href="#l7.1270"></a><span id="l7.1270" class="difflineminus">-    NS_IF_ADDREF(*parent = mParent);</span>
<a href="#l7.1271"></a><span id="l7.1271" class="difflineminus">-    return NS_OK;</span>
<a href="#l7.1272"></a><span id="l7.1272" class="difflineplus">+calIcalProperty::GetParent(calIIcalComponent **parent) {</span>
<a href="#l7.1273"></a><span id="l7.1273" class="difflineplus">+  NS_IF_ADDREF(*parent = mParent);</span>
<a href="#l7.1274"></a><span id="l7.1274" class="difflineplus">+  return NS_OK;</span>
<a href="#l7.1275"></a><span id="l7.1275"> }</span>
<a href="#l7.1276"></a><span id="l7.1276"> </span>
<a href="#l7.1277"></a><span id="l7.1277"> NS_IMETHODIMP</span>
<a href="#l7.1278"></a><span id="l7.1278" class="difflineminus">-calIcalProperty::GetIcalProperty(JS::MutableHandleValue)</span>
<a href="#l7.1279"></a><span id="l7.1279" class="difflineminus">-{</span>
<a href="#l7.1280"></a><span id="l7.1280" class="difflineminus">-    return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l7.1281"></a><span id="l7.1281" class="difflineplus">+calIcalProperty::GetIcalProperty(JS::MutableHandleValue) {</span>
<a href="#l7.1282"></a><span id="l7.1282" class="difflineplus">+  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l7.1283"></a><span id="l7.1283"> }</span>
<a href="#l7.1284"></a><span id="l7.1284"> </span>
<a href="#l7.1285"></a><span id="l7.1285"> NS_IMETHODIMP</span>
<a href="#l7.1286"></a><span id="l7.1286" class="difflineminus">-calIcalProperty::SetIcalProperty(JS::HandleValue)</span>
<a href="#l7.1287"></a><span id="l7.1287" class="difflineminus">-{</span>
<a href="#l7.1288"></a><span id="l7.1288" class="difflineminus">-    return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l7.1289"></a><span id="l7.1289" class="difflineplus">+calIcalProperty::SetIcalProperty(JS::HandleValue) {</span>
<a href="#l7.1290"></a><span id="l7.1290" class="difflineplus">+  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l7.1291"></a><span id="l7.1291"> }</span>
<a href="#l7.1292"></a><span id="l7.1292"> </span>
<a href="#l7.1293"></a><span id="l7.1293"> NS_IMETHODIMP</span>
<a href="#l7.1294"></a><span id="l7.1294" class="difflineminus">-calIcalProperty::SetValueAsDatetime(calIDateTime *dt)</span>
<a href="#l7.1295"></a><span id="l7.1295" class="difflineminus">-{</span>
<a href="#l7.1296"></a><span id="l7.1296" class="difflineminus">-    NS_ENSURE_ARG_POINTER(dt);</span>
<a href="#l7.1297"></a><span id="l7.1297" class="difflineminus">-    return setDatetime_(toIcalComponent(mParent), mProperty, dt);</span>
<a href="#l7.1298"></a><span id="l7.1298" class="difflineplus">+calIcalProperty::SetValueAsDatetime(calIDateTime *dt) {</span>
<a href="#l7.1299"></a><span id="l7.1299" class="difflineplus">+  NS_ENSURE_ARG_POINTER(dt);</span>
<a href="#l7.1300"></a><span id="l7.1300" class="difflineplus">+  return setDatetime_(toIcalComponent(mParent), mProperty, dt);</span>
<a href="#l7.1301"></a><span id="l7.1301"> }</span>
<a href="#l7.1302"></a><span id="l7.1302"> </span>
<a href="#l7.1303"></a><span id="l7.1303" class="difflineminus">-nsresult calIcalProperty::setDatetime_(calIcalComponent * parent,</span>
<a href="#l7.1304"></a><span id="l7.1304" class="difflineminus">-                                       icalproperty * prop,</span>
<a href="#l7.1305"></a><span id="l7.1305" class="difflineminus">-                                       calIDateTime * dt)</span>
<a href="#l7.1306"></a><span id="l7.1306" class="difflineminus">-{</span>
<a href="#l7.1307"></a><span id="l7.1307" class="difflineminus">-    NS_ENSURE_ARG_POINTER(prop);</span>
<a href="#l7.1308"></a><span id="l7.1308" class="difflineminus">-    NS_ENSURE_ARG_POINTER(dt);</span>
<a href="#l7.1309"></a><span id="l7.1309" class="difflineplus">+nsresult calIcalProperty::setDatetime_(calIcalComponent *parent,</span>
<a href="#l7.1310"></a><span id="l7.1310" class="difflineplus">+                                       icalproperty *prop, calIDateTime *dt) {</span>
<a href="#l7.1311"></a><span id="l7.1311" class="difflineplus">+  NS_ENSURE_ARG_POINTER(prop);</span>
<a href="#l7.1312"></a><span id="l7.1312" class="difflineplus">+  NS_ENSURE_ARG_POINTER(dt);</span>
<a href="#l7.1313"></a><span id="l7.1313"> </span>
<a href="#l7.1314"></a><span id="l7.1314" class="difflineminus">-    nsresult rv;</span>
<a href="#l7.1315"></a><span id="l7.1315" class="difflineminus">-    nsCOMPtr&lt;calIDateTimeLibical&gt; icaldt = do_QueryInterface(dt, &amp;rv);</span>
<a href="#l7.1316"></a><span id="l7.1316" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.1317"></a><span id="l7.1317" class="difflineplus">+  nsresult rv;</span>
<a href="#l7.1318"></a><span id="l7.1318" class="difflineplus">+  nsCOMPtr&lt;calIDateTimeLibical&gt; icaldt = do_QueryInterface(dt, &amp;rv);</span>
<a href="#l7.1319"></a><span id="l7.1319" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.1320"></a><span id="l7.1320"> </span>
<a href="#l7.1321"></a><span id="l7.1321" class="difflineminus">-    icaltimetype itt;</span>
<a href="#l7.1322"></a><span id="l7.1322" class="difflineminus">-    icaldt-&gt;ToIcalTime(&amp;itt);</span>
<a href="#l7.1323"></a><span id="l7.1323" class="difflineplus">+  icaltimetype itt;</span>
<a href="#l7.1324"></a><span id="l7.1324" class="difflineplus">+  icaldt-&gt;ToIcalTime(&amp;itt);</span>
<a href="#l7.1325"></a><span id="l7.1325"> </span>
<a href="#l7.1326"></a><span id="l7.1326" class="difflineminus">-    if (parent) {</span>
<a href="#l7.1327"></a><span id="l7.1327" class="difflineminus">-        if (!itt.is_utc) {</span>
<a href="#l7.1328"></a><span id="l7.1328" class="difflineminus">-            nsCOMPtr&lt;calITimezone&gt; tz;</span>
<a href="#l7.1329"></a><span id="l7.1329" class="difflineminus">-            rv = dt-&gt;GetTimezone(getter_AddRefs(tz));</span>
<a href="#l7.1330"></a><span id="l7.1330" class="difflineminus">-            NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.1331"></a><span id="l7.1331" class="difflineminus">-            if (itt.zone) {</span>
<a href="#l7.1332"></a><span id="l7.1332" class="difflineminus">-                rv = parent-&gt;getParentVCalendarOrThis()-&gt;AddTimezoneReference(tz);</span>
<a href="#l7.1333"></a><span id="l7.1333" class="difflineminus">-                NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.1334"></a><span id="l7.1334" class="difflineminus">-                icalparameter * const param = icalparameter_new_from_value_string(</span>
<a href="#l7.1335"></a><span id="l7.1335" class="difflineminus">-                    ICAL_TZID_PARAMETER, icaltimezone_get_tzid(const_cast&lt;icaltimezone *&gt;(itt.zone)));</span>
<a href="#l7.1336"></a><span id="l7.1336" class="difflineminus">-                icalproperty_set_parameter(prop, param);</span>
<a href="#l7.1337"></a><span id="l7.1337" class="difflineminus">-            } else { // either floating or phantom:</span>
<a href="#l7.1338"></a><span id="l7.1338" class="difflineminus">-                bool b = false;</span>
<a href="#l7.1339"></a><span id="l7.1339" class="difflineminus">-                if (NS_FAILED(tz-&gt;GetIsFloating(&amp;b)) || !b) {</span>
<a href="#l7.1340"></a><span id="l7.1340" class="difflineminus">-                    // restore the same phantom TZID:</span>
<a href="#l7.1341"></a><span id="l7.1341" class="difflineminus">-                    nsAutoCString tzid;</span>
<a href="#l7.1342"></a><span id="l7.1342" class="difflineminus">-                    rv = tz-&gt;GetTzid(tzid);</span>
<a href="#l7.1343"></a><span id="l7.1343" class="difflineminus">-                    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.1344"></a><span id="l7.1344" class="difflineminus">-                    icalparameter * const param = icalparameter_new_from_value_string(ICAL_TZID_PARAMETER,</span>
<a href="#l7.1345"></a><span id="l7.1345" class="difflineminus">-                                                                                      tzid.get());</span>
<a href="#l7.1346"></a><span id="l7.1346" class="difflineminus">-                    icalproperty_set_parameter(prop, param);</span>
<a href="#l7.1347"></a><span id="l7.1347" class="difflineminus">-                }</span>
<a href="#l7.1348"></a><span id="l7.1348" class="difflineminus">-            }</span>
<a href="#l7.1349"></a><span id="l7.1349" class="difflineplus">+  if (parent) {</span>
<a href="#l7.1350"></a><span id="l7.1350" class="difflineplus">+    if (!itt.is_utc) {</span>
<a href="#l7.1351"></a><span id="l7.1351" class="difflineplus">+      nsCOMPtr&lt;calITimezone&gt; tz;</span>
<a href="#l7.1352"></a><span id="l7.1352" class="difflineplus">+      rv = dt-&gt;GetTimezone(getter_AddRefs(tz));</span>
<a href="#l7.1353"></a><span id="l7.1353" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.1354"></a><span id="l7.1354" class="difflineplus">+      if (itt.zone) {</span>
<a href="#l7.1355"></a><span id="l7.1355" class="difflineplus">+        rv = parent-&gt;getParentVCalendarOrThis()-&gt;AddTimezoneReference(tz);</span>
<a href="#l7.1356"></a><span id="l7.1356" class="difflineplus">+        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.1357"></a><span id="l7.1357" class="difflineplus">+        icalparameter *const param = icalparameter_new_from_value_string(</span>
<a href="#l7.1358"></a><span id="l7.1358" class="difflineplus">+            ICAL_TZID_PARAMETER,</span>
<a href="#l7.1359"></a><span id="l7.1359" class="difflineplus">+            icaltimezone_get_tzid(const_cast&lt;icaltimezone *&gt;(itt.zone)));</span>
<a href="#l7.1360"></a><span id="l7.1360" class="difflineplus">+        icalproperty_set_parameter(prop, param);</span>
<a href="#l7.1361"></a><span id="l7.1361" class="difflineplus">+      } else {  // either floating or phantom:</span>
<a href="#l7.1362"></a><span id="l7.1362" class="difflineplus">+        bool b = false;</span>
<a href="#l7.1363"></a><span id="l7.1363" class="difflineplus">+        if (NS_FAILED(tz-&gt;GetIsFloating(&amp;b)) || !b) {</span>
<a href="#l7.1364"></a><span id="l7.1364" class="difflineplus">+          // restore the same phantom TZID:</span>
<a href="#l7.1365"></a><span id="l7.1365" class="difflineplus">+          nsAutoCString tzid;</span>
<a href="#l7.1366"></a><span id="l7.1366" class="difflineplus">+          rv = tz-&gt;GetTzid(tzid);</span>
<a href="#l7.1367"></a><span id="l7.1367" class="difflineplus">+          NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.1368"></a><span id="l7.1368" class="difflineplus">+          icalparameter *const param = icalparameter_new_from_value_string(</span>
<a href="#l7.1369"></a><span id="l7.1369" class="difflineplus">+              ICAL_TZID_PARAMETER, tzid.get());</span>
<a href="#l7.1370"></a><span id="l7.1370" class="difflineplus">+          icalproperty_set_parameter(prop, param);</span>
<a href="#l7.1371"></a><span id="l7.1371">         }</span>
<a href="#l7.1372"></a><span id="l7.1372" class="difflineminus">-    } else if (!itt.is_date &amp;&amp; !itt.is_utc &amp;&amp; itt.zone) {</span>
<a href="#l7.1373"></a><span id="l7.1373" class="difflineminus">-        // no parent to add the CTIMEZONE to: coerce DATETIMEs to UTC, DATEs to floating</span>
<a href="#l7.1374"></a><span id="l7.1374" class="difflineminus">-        icaltimezone_convert_time(&amp;itt,</span>
<a href="#l7.1375"></a><span id="l7.1375" class="difflineminus">-                                  const_cast&lt;icaltimezone *&gt;(itt.zone),</span>
<a href="#l7.1376"></a><span id="l7.1376" class="difflineminus">-                                  icaltimezone_get_utc_timezone());</span>
<a href="#l7.1377"></a><span id="l7.1377" class="difflineminus">-        itt.zone = icaltimezone_get_utc_timezone();</span>
<a href="#l7.1378"></a><span id="l7.1378" class="difflineminus">-        itt.is_utc = 1;</span>
<a href="#l7.1379"></a><span id="l7.1379" class="difflineplus">+      }</span>
<a href="#l7.1380"></a><span id="l7.1380">     }</span>
<a href="#l7.1381"></a><span id="l7.1381" class="difflineplus">+  } else if (!itt.is_date &amp;&amp; !itt.is_utc &amp;&amp; itt.zone) {</span>
<a href="#l7.1382"></a><span id="l7.1382" class="difflineplus">+    // no parent to add the CTIMEZONE to: coerce DATETIMEs to UTC, DATEs to</span>
<a href="#l7.1383"></a><span id="l7.1383" class="difflineplus">+    // floating</span>
<a href="#l7.1384"></a><span id="l7.1384" class="difflineplus">+    icaltimezone_convert_time(&amp;itt, const_cast&lt;icaltimezone *&gt;(itt.zone),</span>
<a href="#l7.1385"></a><span id="l7.1385" class="difflineplus">+                              icaltimezone_get_utc_timezone());</span>
<a href="#l7.1386"></a><span id="l7.1386" class="difflineplus">+    itt.zone = icaltimezone_get_utc_timezone();</span>
<a href="#l7.1387"></a><span id="l7.1387" class="difflineplus">+    itt.is_utc = 1;</span>
<a href="#l7.1388"></a><span id="l7.1388" class="difflineplus">+  }</span>
<a href="#l7.1389"></a><span id="l7.1389"> </span>
<a href="#l7.1390"></a><span id="l7.1390" class="difflineminus">-    icalvalue * const val = icalvalue_new_datetime(itt);</span>
<a href="#l7.1391"></a><span id="l7.1391" class="difflineminus">-    CAL_ENSURE_MEMORY(val);</span>
<a href="#l7.1392"></a><span id="l7.1392" class="difflineminus">-    icalproperty_set_value(prop, val);</span>
<a href="#l7.1393"></a><span id="l7.1393" class="difflineminus">-    return NS_OK;</span>
<a href="#l7.1394"></a><span id="l7.1394" class="difflineplus">+  icalvalue *const val = icalvalue_new_datetime(itt);</span>
<a href="#l7.1395"></a><span id="l7.1395" class="difflineplus">+  CAL_ENSURE_MEMORY(val);</span>
<a href="#l7.1396"></a><span id="l7.1396" class="difflineplus">+  icalproperty_set_value(prop, val);</span>
<a href="#l7.1397"></a><span id="l7.1397" class="difflineplus">+  return NS_OK;</span>
<a href="#l7.1398"></a><span id="l7.1398"> }</span>
<a href="#l7.1399"></a><span id="l7.1399"> </span>
<a href="#l7.1400"></a><span id="l7.1400" class="difflineminus">-#define RO_COMP_DATE_ATTRIBUTE(Attrname, ICALNAME)                      \</span>
<a href="#l7.1401"></a><span id="l7.1401" class="difflineminus">-NS_IMETHODIMP                                                           \</span>
<a href="#l7.1402"></a><span id="l7.1402" class="difflineminus">-calIcalComponent::Get##Attrname(calIDateTime **dtp)                     \</span>
<a href="#l7.1403"></a><span id="l7.1403" class="difflineminus">-{                                                                       \</span>
<a href="#l7.1404"></a><span id="l7.1404" class="difflineminus">-    return GetDateTimeAttribute(ICAL_##ICALNAME##_PROPERTY, dtp);       \</span>
<a href="#l7.1405"></a><span id="l7.1405" class="difflineminus">-}</span>
<a href="#l7.1406"></a><span id="l7.1406" class="difflineplus">+#define RO_COMP_DATE_ATTRIBUTE(Attrname, ICALNAME)                \</span>
<a href="#l7.1407"></a><span id="l7.1407" class="difflineplus">+  NS_IMETHODIMP                                                   \</span>
<a href="#l7.1408"></a><span id="l7.1408" class="difflineplus">+  calIcalComponent::Get##Attrname(calIDateTime **dtp) {           \</span>
<a href="#l7.1409"></a><span id="l7.1409" class="difflineplus">+    return GetDateTimeAttribute(ICAL_##ICALNAME##_PROPERTY, dtp); \</span>
<a href="#l7.1410"></a><span id="l7.1410" class="difflineplus">+  }</span>
<a href="#l7.1411"></a><span id="l7.1411"> </span>
<a href="#l7.1412"></a><span id="l7.1412" class="difflineminus">-#define COMP_DATE_ATTRIBUTE(Attrname, ICALNAME)                         \</span>
<a href="#l7.1413"></a><span id="l7.1413" class="difflineminus">-RO_COMP_DATE_ATTRIBUTE(Attrname, ICALNAME)                              \</span>
<a href="#l7.1414"></a><span id="l7.1414" class="difflineminus">-                                                                        \</span>
<a href="#l7.1415"></a><span id="l7.1415" class="difflineminus">-NS_IMETHODIMP                                                           \</span>
<a href="#l7.1416"></a><span id="l7.1416" class="difflineminus">-calIcalComponent::Set##Attrname(calIDateTime *dt)                       \</span>
<a href="#l7.1417"></a><span id="l7.1417" class="difflineminus">-{                                                                       \</span>
<a href="#l7.1418"></a><span id="l7.1418" class="difflineminus">-    return SetDateTimeAttribute(ICAL_##ICALNAME##_PROPERTY, dt);        \</span>
<a href="#l7.1419"></a><span id="l7.1419" class="difflineminus">-}</span>
<a href="#l7.1420"></a><span id="l7.1420" class="difflineplus">+#define COMP_DATE_ATTRIBUTE(Attrname, ICALNAME)                  \</span>
<a href="#l7.1421"></a><span id="l7.1421" class="difflineplus">+  RO_COMP_DATE_ATTRIBUTE(Attrname, ICALNAME)                     \</span>
<a href="#l7.1422"></a><span id="l7.1422" class="difflineplus">+                                                                 \</span>
<a href="#l7.1423"></a><span id="l7.1423" class="difflineplus">+  NS_IMETHODIMP                                                  \</span>
<a href="#l7.1424"></a><span id="l7.1424" class="difflineplus">+  calIcalComponent::Set##Attrname(calIDateTime *dt) {            \</span>
<a href="#l7.1425"></a><span id="l7.1425" class="difflineplus">+    return SetDateTimeAttribute(ICAL_##ICALNAME##_PROPERTY, dt); \</span>
<a href="#l7.1426"></a><span id="l7.1426" class="difflineplus">+  }</span>
<a href="#l7.1427"></a><span id="l7.1427"> </span>
<a href="#l7.1428"></a><span id="l7.1428" class="difflineminus">-#define RO_COMP_DURATION_ATTRIBUTE(Attrname, ICALNAME)                  \</span>
<a href="#l7.1429"></a><span id="l7.1429" class="difflineminus">-NS_IMETHODIMP                                                           \</span>
<a href="#l7.1430"></a><span id="l7.1430" class="difflineminus">-calIcalComponent::Get##Attrname(calIDuration **dtp)                     \</span>
<a href="#l7.1431"></a><span id="l7.1431" class="difflineminus">-{                                                                       \</span>
<a href="#l7.1432"></a><span id="l7.1432" class="difflineminus">-    icalproperty *prop =                                                \</span>
<a href="#l7.1433"></a><span id="l7.1433" class="difflineminus">-        icalcomponent_get_first_property(mComponent,                    \</span>
<a href="#l7.1434"></a><span id="l7.1434" class="difflineminus">-                                         ICAL_##ICALNAME##_PROPERTY);   \</span>
<a href="#l7.1435"></a><span id="l7.1435" class="difflineminus">-    if (!prop) {                                                        \</span>
<a href="#l7.1436"></a><span id="l7.1436" class="difflineminus">-        *dtp = nullptr;  /* invalid duration */                          \</span>
<a href="#l7.1437"></a><span id="l7.1437" class="difflineminus">-        return NS_OK;                                                   \</span>
<a href="#l7.1438"></a><span id="l7.1438" class="difflineminus">-    }                                                                   \</span>
<a href="#l7.1439"></a><span id="l7.1439" class="difflineminus">-    struct icaldurationtype idt =                                       \</span>
<a href="#l7.1440"></a><span id="l7.1440" class="difflineminus">-        icalvalue_get_duration(icalproperty_get_value(prop));           \</span>
<a href="#l7.1441"></a><span id="l7.1441" class="difflineminus">-    *dtp = new calDuration(&amp;idt);                                       \</span>
<a href="#l7.1442"></a><span id="l7.1442" class="difflineminus">-    CAL_ENSURE_MEMORY(*dtp);                                            \</span>
<a href="#l7.1443"></a><span id="l7.1443" class="difflineminus">-    NS_ADDREF(*dtp);                                                    \</span>
<a href="#l7.1444"></a><span id="l7.1444" class="difflineminus">-    return NS_OK;                                                       \</span>
<a href="#l7.1445"></a><span id="l7.1445" class="difflineminus">-}</span>
<a href="#l7.1446"></a><span id="l7.1446" class="difflineplus">+#define RO_COMP_DURATION_ATTRIBUTE(Attrname, ICALNAME)        \</span>
<a href="#l7.1447"></a><span id="l7.1447" class="difflineplus">+  NS_IMETHODIMP                                               \</span>
<a href="#l7.1448"></a><span id="l7.1448" class="difflineplus">+  calIcalComponent::Get##Attrname(calIDuration **dtp) {       \</span>
<a href="#l7.1449"></a><span id="l7.1449" class="difflineplus">+    icalproperty *prop = icalcomponent_get_first_property(    \</span>
<a href="#l7.1450"></a><span id="l7.1450" class="difflineplus">+        mComponent, ICAL_##ICALNAME##_PROPERTY);              \</span>
<a href="#l7.1451"></a><span id="l7.1451" class="difflineplus">+    if (!prop) {                                              \</span>
<a href="#l7.1452"></a><span id="l7.1452" class="difflineplus">+      *dtp = nullptr; /* invalid duration */                  \</span>
<a href="#l7.1453"></a><span id="l7.1453" class="difflineplus">+      return NS_OK;                                           \</span>
<a href="#l7.1454"></a><span id="l7.1454" class="difflineplus">+    }                                                         \</span>
<a href="#l7.1455"></a><span id="l7.1455" class="difflineplus">+    struct icaldurationtype idt =                             \</span>
<a href="#l7.1456"></a><span id="l7.1456" class="difflineplus">+        icalvalue_get_duration(icalproperty_get_value(prop)); \</span>
<a href="#l7.1457"></a><span id="l7.1457" class="difflineplus">+    *dtp = new calDuration(&amp;idt);                             \</span>
<a href="#l7.1458"></a><span id="l7.1458" class="difflineplus">+    CAL_ENSURE_MEMORY(*dtp);                                  \</span>
<a href="#l7.1459"></a><span id="l7.1459" class="difflineplus">+    NS_ADDREF(*dtp);                                          \</span>
<a href="#l7.1460"></a><span id="l7.1460" class="difflineplus">+    return NS_OK;                                             \</span>
<a href="#l7.1461"></a><span id="l7.1461" class="difflineplus">+  }</span>
<a href="#l7.1462"></a><span id="l7.1462"> </span>
<a href="#l7.1463"></a><span id="l7.1463" class="difflineminus">-</span>
<a href="#l7.1464"></a><span id="l7.1464" class="difflineminus">-</span>
<a href="#l7.1465"></a><span id="l7.1465" class="difflineminus">-NS_IMPL_CLASSINFO(calIcalComponent, nullptr, nsIClassInfo::THREADSAFE, CAL_ICALCOMPONENT_CID)</span>
<a href="#l7.1466"></a><span id="l7.1466" class="difflineminus">-NS_IMPL_ISUPPORTS_CI(calIcalComponent, calIIcalComponent, calIIcalComponentLibical)</span>
<a href="#l7.1467"></a><span id="l7.1467" class="difflineplus">+NS_IMPL_CLASSINFO(calIcalComponent, nullptr, nsIClassInfo::THREADSAFE,</span>
<a href="#l7.1468"></a><span id="l7.1468" class="difflineplus">+                  CAL_ICALCOMPONENT_CID)</span>
<a href="#l7.1469"></a><span id="l7.1469" class="difflineplus">+NS_IMPL_ISUPPORTS_CI(calIcalComponent, calIIcalComponent,</span>
<a href="#l7.1470"></a><span id="l7.1470" class="difflineplus">+                     calIIcalComponentLibical)</span>
<a href="#l7.1471"></a><span id="l7.1471"> </span>
<a href="#l7.1472"></a><span id="l7.1472"> NS_IMETHODIMP_(icalcomponent *)</span>
<a href="#l7.1473"></a><span id="l7.1473" class="difflineminus">-calIcalComponent::GetLibicalComponent()</span>
<a href="#l7.1474"></a><span id="l7.1474" class="difflineminus">-{</span>
<a href="#l7.1475"></a><span id="l7.1475" class="difflineminus">-    return mComponent;</span>
<a href="#l7.1476"></a><span id="l7.1476" class="difflineminus">-}</span>
<a href="#l7.1477"></a><span id="l7.1477" class="difflineplus">+calIcalComponent::GetLibicalComponent() { return mComponent; }</span>
<a href="#l7.1478"></a><span id="l7.1478"> </span>
<a href="#l7.1479"></a><span id="l7.1479"> NS_IMETHODIMP_(icaltimezone *)</span>
<a href="#l7.1480"></a><span id="l7.1480" class="difflineminus">-calIcalComponent::GetLibicalTimezone()</span>
<a href="#l7.1481"></a><span id="l7.1481" class="difflineminus">-{</span>
<a href="#l7.1482"></a><span id="l7.1482" class="difflineminus">-    NS_ASSERTION(icalcomponent_isa(mComponent) == ICAL_VTIMEZONE_COMPONENT, &quot;no VTIMEZONE -- unexpected!&quot;);</span>
<a href="#l7.1483"></a><span id="l7.1483" class="difflineminus">-    if (!mTimezone &amp;&amp; (icalcomponent_isa(mComponent) == ICAL_VTIMEZONE_COMPONENT)) {</span>
<a href="#l7.1484"></a><span id="l7.1484" class="difflineminus">-        // xxx todo: libical needs a parent VCALENDAR to retrieve a icaltimezone</span>
<a href="#l7.1485"></a><span id="l7.1485" class="difflineminus">-        NS_ASSERTION(mParent, &quot;VTIMEZONE has no parent!&quot;);</span>
<a href="#l7.1486"></a><span id="l7.1486" class="difflineminus">-        if (mParent) {</span>
<a href="#l7.1487"></a><span id="l7.1487" class="difflineminus">-            icalproperty * const tzidProp = icalcomponent_get_first_property(mComponent, ICAL_TZID_PROPERTY);</span>
<a href="#l7.1488"></a><span id="l7.1488" class="difflineminus">-            NS_ASSERTION(tzidProp, &quot;no TZID property in VTIMEZONE!?&quot;);</span>
<a href="#l7.1489"></a><span id="l7.1489" class="difflineminus">-            if (tzidProp) {</span>
<a href="#l7.1490"></a><span id="l7.1490" class="difflineminus">-                mTimezone = icalcomponent_get_timezone(mParent-&gt;GetLibicalComponent(),</span>
<a href="#l7.1491"></a><span id="l7.1491" class="difflineminus">-                                                       icalvalue_get_string(icalproperty_get_value(tzidProp)));</span>
<a href="#l7.1492"></a><span id="l7.1492" class="difflineminus">-            }</span>
<a href="#l7.1493"></a><span id="l7.1493" class="difflineminus">-        }</span>
<a href="#l7.1494"></a><span id="l7.1494" class="difflineplus">+calIcalComponent::GetLibicalTimezone() {</span>
<a href="#l7.1495"></a><span id="l7.1495" class="difflineplus">+  NS_ASSERTION(icalcomponent_isa(mComponent) == ICAL_VTIMEZONE_COMPONENT,</span>
<a href="#l7.1496"></a><span id="l7.1496" class="difflineplus">+               &quot;no VTIMEZONE -- unexpected!&quot;);</span>
<a href="#l7.1497"></a><span id="l7.1497" class="difflineplus">+  if (!mTimezone &amp;&amp;</span>
<a href="#l7.1498"></a><span id="l7.1498" class="difflineplus">+      (icalcomponent_isa(mComponent) == ICAL_VTIMEZONE_COMPONENT)) {</span>
<a href="#l7.1499"></a><span id="l7.1499" class="difflineplus">+    // xxx todo: libical needs a parent VCALENDAR to retrieve a icaltimezone</span>
<a href="#l7.1500"></a><span id="l7.1500" class="difflineplus">+    NS_ASSERTION(mParent, &quot;VTIMEZONE has no parent!&quot;);</span>
<a href="#l7.1501"></a><span id="l7.1501" class="difflineplus">+    if (mParent) {</span>
<a href="#l7.1502"></a><span id="l7.1502" class="difflineplus">+      icalproperty *const tzidProp =</span>
<a href="#l7.1503"></a><span id="l7.1503" class="difflineplus">+          icalcomponent_get_first_property(mComponent, ICAL_TZID_PROPERTY);</span>
<a href="#l7.1504"></a><span id="l7.1504" class="difflineplus">+      NS_ASSERTION(tzidProp, &quot;no TZID property in VTIMEZONE!?&quot;);</span>
<a href="#l7.1505"></a><span id="l7.1505" class="difflineplus">+      if (tzidProp) {</span>
<a href="#l7.1506"></a><span id="l7.1506" class="difflineplus">+        mTimezone = icalcomponent_get_timezone(</span>
<a href="#l7.1507"></a><span id="l7.1507" class="difflineplus">+            mParent-&gt;GetLibicalComponent(),</span>
<a href="#l7.1508"></a><span id="l7.1508" class="difflineplus">+            icalvalue_get_string(icalproperty_get_value(tzidProp)));</span>
<a href="#l7.1509"></a><span id="l7.1509" class="difflineplus">+      }</span>
<a href="#l7.1510"></a><span id="l7.1510">     }</span>
<a href="#l7.1511"></a><span id="l7.1511" class="difflineminus">-    return mTimezone;</span>
<a href="#l7.1512"></a><span id="l7.1512" class="difflineplus">+  }</span>
<a href="#l7.1513"></a><span id="l7.1513" class="difflineplus">+  return mTimezone;</span>
<a href="#l7.1514"></a><span id="l7.1514"> }</span>
<a href="#l7.1515"></a><span id="l7.1515"> </span>
<a href="#l7.1516"></a><span id="l7.1516"> NS_IMETHODIMP</span>
<a href="#l7.1517"></a><span id="l7.1517" class="difflineminus">-calIcalComponent::GetFirstSubcomponent(const nsACString&amp; kind,</span>
<a href="#l7.1518"></a><span id="l7.1518" class="difflineminus">-                                       calIIcalComponent **subcomp)</span>
<a href="#l7.1519"></a><span id="l7.1519" class="difflineminus">-{</span>
<a href="#l7.1520"></a><span id="l7.1520" class="difflineminus">-    NS_ENSURE_ARG_POINTER(subcomp);</span>
<a href="#l7.1521"></a><span id="l7.1521" class="difflineplus">+calIcalComponent::GetFirstSubcomponent(const nsACString &amp;kind,</span>
<a href="#l7.1522"></a><span id="l7.1522" class="difflineplus">+                                       calIIcalComponent **subcomp) {</span>
<a href="#l7.1523"></a><span id="l7.1523" class="difflineplus">+  NS_ENSURE_ARG_POINTER(subcomp);</span>
<a href="#l7.1524"></a><span id="l7.1524"> </span>
<a href="#l7.1525"></a><span id="l7.1525" class="difflineminus">-    icalcomponent_kind compkind =</span>
<a href="#l7.1526"></a><span id="l7.1526" class="difflineminus">-        icalcomponent_string_to_kind(PromiseFlatCString(kind).get());</span>
<a href="#l7.1527"></a><span id="l7.1527" class="difflineplus">+  icalcomponent_kind compkind =</span>
<a href="#l7.1528"></a><span id="l7.1528" class="difflineplus">+      icalcomponent_string_to_kind(PromiseFlatCString(kind).get());</span>
<a href="#l7.1529"></a><span id="l7.1529"> </span>
<a href="#l7.1530"></a><span id="l7.1530" class="difflineminus">-    // Maybe someday I'll support X-COMPONENTs</span>
<a href="#l7.1531"></a><span id="l7.1531" class="difflineminus">-    if (compkind == ICAL_NO_COMPONENT || compkind == ICAL_X_COMPONENT)</span>
<a href="#l7.1532"></a><span id="l7.1532" class="difflineminus">-        return NS_ERROR_INVALID_ARG;</span>
<a href="#l7.1533"></a><span id="l7.1533" class="difflineplus">+  // Maybe someday I'll support X-COMPONENTs</span>
<a href="#l7.1534"></a><span id="l7.1534" class="difflineplus">+  if (compkind == ICAL_NO_COMPONENT || compkind == ICAL_X_COMPONENT)</span>
<a href="#l7.1535"></a><span id="l7.1535" class="difflineplus">+    return NS_ERROR_INVALID_ARG;</span>
<a href="#l7.1536"></a><span id="l7.1536"> </span>
<a href="#l7.1537"></a><span id="l7.1537" class="difflineminus">-    icalcomponent *ical =</span>
<a href="#l7.1538"></a><span id="l7.1538" class="difflineminus">-        icalcomponent_get_first_component(mComponent, compkind);</span>
<a href="#l7.1539"></a><span id="l7.1539" class="difflineminus">-    if (!ical) {</span>
<a href="#l7.1540"></a><span id="l7.1540" class="difflineminus">-        *subcomp = nullptr;</span>
<a href="#l7.1541"></a><span id="l7.1541" class="difflineminus">-        return NS_OK;</span>
<a href="#l7.1542"></a><span id="l7.1542" class="difflineminus">-    }</span>
<a href="#l7.1543"></a><span id="l7.1543" class="difflineplus">+  icalcomponent *ical = icalcomponent_get_first_component(mComponent, compkind);</span>
<a href="#l7.1544"></a><span id="l7.1544" class="difflineplus">+  if (!ical) {</span>
<a href="#l7.1545"></a><span id="l7.1545" class="difflineplus">+    *subcomp = nullptr;</span>
<a href="#l7.1546"></a><span id="l7.1546" class="difflineplus">+    return NS_OK;</span>
<a href="#l7.1547"></a><span id="l7.1547" class="difflineplus">+  }</span>
<a href="#l7.1548"></a><span id="l7.1548"> </span>
<a href="#l7.1549"></a><span id="l7.1549" class="difflineminus">-    *subcomp = new calIcalComponent(ical, this);</span>
<a href="#l7.1550"></a><span id="l7.1550" class="difflineminus">-    CAL_ENSURE_MEMORY(*subcomp);</span>
<a href="#l7.1551"></a><span id="l7.1551" class="difflineminus">-    NS_ADDREF(*subcomp);</span>
<a href="#l7.1552"></a><span id="l7.1552" class="difflineminus">-    return NS_OK;</span>
<a href="#l7.1553"></a><span id="l7.1553" class="difflineplus">+  *subcomp = new calIcalComponent(ical, this);</span>
<a href="#l7.1554"></a><span id="l7.1554" class="difflineplus">+  CAL_ENSURE_MEMORY(*subcomp);</span>
<a href="#l7.1555"></a><span id="l7.1555" class="difflineplus">+  NS_ADDREF(*subcomp);</span>
<a href="#l7.1556"></a><span id="l7.1556" class="difflineplus">+  return NS_OK;</span>
<a href="#l7.1557"></a><span id="l7.1557"> }</span>
<a href="#l7.1558"></a><span id="l7.1558"> </span>
<a href="#l7.1559"></a><span id="l7.1559"> NS_IMETHODIMP</span>
<a href="#l7.1560"></a><span id="l7.1560" class="difflineminus">-calIcalComponent::GetNextSubcomponent(const nsACString&amp; kind,</span>
<a href="#l7.1561"></a><span id="l7.1561" class="difflineminus">-                                      calIIcalComponent **subcomp)</span>
<a href="#l7.1562"></a><span id="l7.1562" class="difflineminus">-{</span>
<a href="#l7.1563"></a><span id="l7.1563" class="difflineminus">-    NS_ENSURE_ARG_POINTER(subcomp);</span>
<a href="#l7.1564"></a><span id="l7.1564" class="difflineplus">+calIcalComponent::GetNextSubcomponent(const nsACString &amp;kind,</span>
<a href="#l7.1565"></a><span id="l7.1565" class="difflineplus">+                                      calIIcalComponent **subcomp) {</span>
<a href="#l7.1566"></a><span id="l7.1566" class="difflineplus">+  NS_ENSURE_ARG_POINTER(subcomp);</span>
<a href="#l7.1567"></a><span id="l7.1567"> </span>
<a href="#l7.1568"></a><span id="l7.1568" class="difflineminus">-    icalcomponent_kind compkind =</span>
<a href="#l7.1569"></a><span id="l7.1569" class="difflineminus">-        icalcomponent_string_to_kind(PromiseFlatCString(kind).get());</span>
<a href="#l7.1570"></a><span id="l7.1570" class="difflineplus">+  icalcomponent_kind compkind =</span>
<a href="#l7.1571"></a><span id="l7.1571" class="difflineplus">+      icalcomponent_string_to_kind(PromiseFlatCString(kind).get());</span>
<a href="#l7.1572"></a><span id="l7.1572"> </span>
<a href="#l7.1573"></a><span id="l7.1573" class="difflineminus">-    // Maybe someday I'll support X-COMPONENTs</span>
<a href="#l7.1574"></a><span id="l7.1574" class="difflineminus">-    if (compkind == ICAL_NO_COMPONENT || compkind == ICAL_X_COMPONENT)</span>
<a href="#l7.1575"></a><span id="l7.1575" class="difflineminus">-        return NS_ERROR_INVALID_ARG;</span>
<a href="#l7.1576"></a><span id="l7.1576" class="difflineplus">+  // Maybe someday I'll support X-COMPONENTs</span>
<a href="#l7.1577"></a><span id="l7.1577" class="difflineplus">+  if (compkind == ICAL_NO_COMPONENT || compkind == ICAL_X_COMPONENT)</span>
<a href="#l7.1578"></a><span id="l7.1578" class="difflineplus">+    return NS_ERROR_INVALID_ARG;</span>
<a href="#l7.1579"></a><span id="l7.1579"> </span>
<a href="#l7.1580"></a><span id="l7.1580" class="difflineminus">-    icalcomponent *ical =</span>
<a href="#l7.1581"></a><span id="l7.1581" class="difflineminus">-        icalcomponent_get_next_component(mComponent, compkind);</span>
<a href="#l7.1582"></a><span id="l7.1582" class="difflineminus">-    if (!ical) {</span>
<a href="#l7.1583"></a><span id="l7.1583" class="difflineminus">-        *subcomp = nullptr;</span>
<a href="#l7.1584"></a><span id="l7.1584" class="difflineminus">-        return NS_OK;</span>
<a href="#l7.1585"></a><span id="l7.1585" class="difflineminus">-    }</span>
<a href="#l7.1586"></a><span id="l7.1586" class="difflineplus">+  icalcomponent *ical = icalcomponent_get_next_component(mComponent, compkind);</span>
<a href="#l7.1587"></a><span id="l7.1587" class="difflineplus">+  if (!ical) {</span>
<a href="#l7.1588"></a><span id="l7.1588" class="difflineplus">+    *subcomp = nullptr;</span>
<a href="#l7.1589"></a><span id="l7.1589" class="difflineplus">+    return NS_OK;</span>
<a href="#l7.1590"></a><span id="l7.1590" class="difflineplus">+  }</span>
<a href="#l7.1591"></a><span id="l7.1591"> </span>
<a href="#l7.1592"></a><span id="l7.1592" class="difflineminus">-    *subcomp = new calIcalComponent(ical, this);</span>
<a href="#l7.1593"></a><span id="l7.1593" class="difflineminus">-    CAL_ENSURE_MEMORY(*subcomp);</span>
<a href="#l7.1594"></a><span id="l7.1594" class="difflineminus">-    NS_ADDREF(*subcomp);</span>
<a href="#l7.1595"></a><span id="l7.1595" class="difflineminus">-    return NS_OK;</span>
<a href="#l7.1596"></a><span id="l7.1596" class="difflineplus">+  *subcomp = new calIcalComponent(ical, this);</span>
<a href="#l7.1597"></a><span id="l7.1597" class="difflineplus">+  CAL_ENSURE_MEMORY(*subcomp);</span>
<a href="#l7.1598"></a><span id="l7.1598" class="difflineplus">+  NS_ADDREF(*subcomp);</span>
<a href="#l7.1599"></a><span id="l7.1599" class="difflineplus">+  return NS_OK;</span>
<a href="#l7.1600"></a><span id="l7.1600"> }</span>
<a href="#l7.1601"></a><span id="l7.1601"> </span>
<a href="#l7.1602"></a><span id="l7.1602"> NS_IMETHODIMP</span>
<a href="#l7.1603"></a><span id="l7.1603" class="difflineminus">-calIcalComponent::GetComponentType(nsACString &amp;componentType)</span>
<a href="#l7.1604"></a><span id="l7.1604" class="difflineminus">-{</span>
<a href="#l7.1605"></a><span id="l7.1605" class="difflineminus">-    componentType.Assign(icalcomponent_kind_to_string(icalcomponent_isa(mComponent)));</span>
<a href="#l7.1606"></a><span id="l7.1606" class="difflineminus">-    return NS_OK;</span>
<a href="#l7.1607"></a><span id="l7.1607" class="difflineplus">+calIcalComponent::GetComponentType(nsACString &amp;componentType) {</span>
<a href="#l7.1608"></a><span id="l7.1608" class="difflineplus">+  componentType.Assign(</span>
<a href="#l7.1609"></a><span id="l7.1609" class="difflineplus">+      icalcomponent_kind_to_string(icalcomponent_isa(mComponent)));</span>
<a href="#l7.1610"></a><span id="l7.1610" class="difflineplus">+  return NS_OK;</span>
<a href="#l7.1611"></a><span id="l7.1611"> }</span>
<a href="#l7.1612"></a><span id="l7.1612"> </span>
<a href="#l7.1613"></a><span id="l7.1613" class="difflineminus">-</span>
<a href="#l7.1614"></a><span id="l7.1614"> COMP_STRING_ATTRIBUTE(Uid, UID, uid)</span>
<a href="#l7.1615"></a><span id="l7.1615"> COMP_STRING_ATTRIBUTE(Prodid, PRODID, prodid)</span>
<a href="#l7.1616"></a><span id="l7.1616"> COMP_STRING_ATTRIBUTE(Version, VERSION, version)</span>
<a href="#l7.1617"></a><span id="l7.1617"> COMP_STRING_TO_ENUM_ATTRIBUTE(Method, METHOD, method)</span>
<a href="#l7.1618"></a><span id="l7.1618"> COMP_STRING_TO_ENUM_ATTRIBUTE(Status, STATUS, status)</span>
<a href="#l7.1619"></a><span id="l7.1619"> COMP_STRING_ATTRIBUTE(Summary, SUMMARY, summary)</span>
<a href="#l7.1620"></a><span id="l7.1620"> COMP_STRING_ATTRIBUTE(Description, DESCRIPTION, description)</span>
<a href="#l7.1621"></a><span id="l7.1621"> COMP_STRING_ATTRIBUTE(Location, LOCATION, location)</span>
<a href="#l7.1622"></a><span id="l7.1622" class="difflineat">@@ -955,445 +882,420 @@ COMP_DATE_ATTRIBUTE(StartTime, DTSTART)</span>
<a href="#l7.1623"></a><span id="l7.1623"> COMP_DATE_ATTRIBUTE(EndTime, DTEND)</span>
<a href="#l7.1624"></a><span id="l7.1624"> COMP_DATE_ATTRIBUTE(DueTime, DUE)</span>
<a href="#l7.1625"></a><span id="l7.1625"> COMP_DATE_ATTRIBUTE(StampTime, DTSTAMP)</span>
<a href="#l7.1626"></a><span id="l7.1626"> COMP_DATE_ATTRIBUTE(LastModified, LASTMODIFIED)</span>
<a href="#l7.1627"></a><span id="l7.1627"> COMP_DATE_ATTRIBUTE(CreatedTime, CREATED)</span>
<a href="#l7.1628"></a><span id="l7.1628"> COMP_DATE_ATTRIBUTE(CompletedTime, COMPLETED)</span>
<a href="#l7.1629"></a><span id="l7.1629"> COMP_DATE_ATTRIBUTE(RecurrenceId, RECURRENCEID)</span>
<a href="#l7.1630"></a><span id="l7.1630"> </span>
<a href="#l7.1631"></a><span id="l7.1631" class="difflineminus">-void calIcalComponent::ClearAllProperties(icalproperty_kind kind)</span>
<a href="#l7.1632"></a><span id="l7.1632" class="difflineminus">-{</span>
<a href="#l7.1633"></a><span id="l7.1633" class="difflineminus">-    for (icalproperty *prop = icalcomponent_get_first_property(mComponent, kind), *next;</span>
<a href="#l7.1634"></a><span id="l7.1634" class="difflineminus">-         prop; prop = next)</span>
<a href="#l7.1635"></a><span id="l7.1635" class="difflineminus">-    {</span>
<a href="#l7.1636"></a><span id="l7.1636" class="difflineminus">-        next = icalcomponent_get_next_property(mComponent, kind);</span>
<a href="#l7.1637"></a><span id="l7.1637" class="difflineminus">-        icalcomponent_remove_property(mComponent, prop);</span>
<a href="#l7.1638"></a><span id="l7.1638" class="difflineminus">-        icalproperty_free(prop);</span>
<a href="#l7.1639"></a><span id="l7.1639" class="difflineminus">-    }</span>
<a href="#l7.1640"></a><span id="l7.1640" class="difflineminus">-}</span>
<a href="#l7.1641"></a><span id="l7.1641" class="difflineminus">-</span>
<a href="#l7.1642"></a><span id="l7.1642" class="difflineminus">-</span>
<a href="#l7.1643"></a><span id="l7.1643" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l7.1644"></a><span id="l7.1644" class="difflineminus">-calIcalComponent::SerializeToICS(nsACString &amp;serialized)</span>
<a href="#l7.1645"></a><span id="l7.1645" class="difflineminus">-{</span>
<a href="#l7.1646"></a><span id="l7.1646" class="difflineminus">-    char *icalstr;</span>
<a href="#l7.1647"></a><span id="l7.1647" class="difflineminus">-</span>
<a href="#l7.1648"></a><span id="l7.1648" class="difflineminus">-    nsresult rv = Serialize(&amp;icalstr);</span>
<a href="#l7.1649"></a><span id="l7.1649" class="difflineminus">-    if (NS_FAILED(rv)) {</span>
<a href="#l7.1650"></a><span id="l7.1650" class="difflineminus">-        return rv;</span>
<a href="#l7.1651"></a><span id="l7.1651" class="difflineminus">-    }</span>
<a href="#l7.1652"></a><span id="l7.1652" class="difflineminus">-</span>
<a href="#l7.1653"></a><span id="l7.1653" class="difflineminus">-    serialized.Assign(icalstr);</span>
<a href="#l7.1654"></a><span id="l7.1654" class="difflineminus">-    return NS_OK;</span>
<a href="#l7.1655"></a><span id="l7.1655" class="difflineplus">+void calIcalComponent::ClearAllProperties(icalproperty_kind kind) {</span>
<a href="#l7.1656"></a><span id="l7.1656" class="difflineplus">+  for (icalproperty *prop = icalcomponent_get_first_property(mComponent, kind),</span>
<a href="#l7.1657"></a><span id="l7.1657" class="difflineplus">+                    *next;</span>
<a href="#l7.1658"></a><span id="l7.1658" class="difflineplus">+       prop; prop = next) {</span>
<a href="#l7.1659"></a><span id="l7.1659" class="difflineplus">+    next = icalcomponent_get_next_property(mComponent, kind);</span>
<a href="#l7.1660"></a><span id="l7.1660" class="difflineplus">+    icalcomponent_remove_property(mComponent, prop);</span>
<a href="#l7.1661"></a><span id="l7.1661" class="difflineplus">+    icalproperty_free(prop);</span>
<a href="#l7.1662"></a><span id="l7.1662" class="difflineplus">+  }</span>
<a href="#l7.1663"></a><span id="l7.1663"> }</span>
<a href="#l7.1664"></a><span id="l7.1664"> </span>
<a href="#l7.1665"></a><span id="l7.1665"> NS_IMETHODIMP</span>
<a href="#l7.1666"></a><span id="l7.1666" class="difflineminus">-calIcalComponent::ToString(nsACString&amp; aResult)</span>
<a href="#l7.1667"></a><span id="l7.1667" class="difflineminus">-{</span>
<a href="#l7.1668"></a><span id="l7.1668" class="difflineminus">-    return SerializeToICS(aResult);</span>
<a href="#l7.1669"></a><span id="l7.1669" class="difflineplus">+calIcalComponent::SerializeToICS(nsACString &amp;serialized) {</span>
<a href="#l7.1670"></a><span id="l7.1670" class="difflineplus">+  char *icalstr;</span>
<a href="#l7.1671"></a><span id="l7.1671" class="difflineplus">+</span>
<a href="#l7.1672"></a><span id="l7.1672" class="difflineplus">+  nsresult rv = Serialize(&amp;icalstr);</span>
<a href="#l7.1673"></a><span id="l7.1673" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l7.1674"></a><span id="l7.1674" class="difflineplus">+    return rv;</span>
<a href="#l7.1675"></a><span id="l7.1675" class="difflineplus">+  }</span>
<a href="#l7.1676"></a><span id="l7.1676" class="difflineplus">+</span>
<a href="#l7.1677"></a><span id="l7.1677" class="difflineplus">+  serialized.Assign(icalstr);</span>
<a href="#l7.1678"></a><span id="l7.1678" class="difflineplus">+  return NS_OK;</span>
<a href="#l7.1679"></a><span id="l7.1679" class="difflineplus">+}</span>
<a href="#l7.1680"></a><span id="l7.1680" class="difflineplus">+</span>
<a href="#l7.1681"></a><span id="l7.1681" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l7.1682"></a><span id="l7.1682" class="difflineplus">+calIcalComponent::ToString(nsACString &amp;aResult) {</span>
<a href="#l7.1683"></a><span id="l7.1683" class="difflineplus">+  return SerializeToICS(aResult);</span>
<a href="#l7.1684"></a><span id="l7.1684"> }</span>
<a href="#l7.1685"></a><span id="l7.1685"> </span>
<a href="#l7.1686"></a><span id="l7.1686"> NS_IMETHODIMP</span>
<a href="#l7.1687"></a><span id="l7.1687" class="difflineminus">-calIcalComponent::SerializeToICSStream(nsIInputStream **aStreamResult)</span>
<a href="#l7.1688"></a><span id="l7.1688" class="difflineminus">-{</span>
<a href="#l7.1689"></a><span id="l7.1689" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aStreamResult);</span>
<a href="#l7.1690"></a><span id="l7.1690" class="difflineplus">+calIcalComponent::SerializeToICSStream(nsIInputStream **aStreamResult) {</span>
<a href="#l7.1691"></a><span id="l7.1691" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aStreamResult);</span>
<a href="#l7.1692"></a><span id="l7.1692"> </span>
<a href="#l7.1693"></a><span id="l7.1693" class="difflineminus">-    char *icalstr;</span>
<a href="#l7.1694"></a><span id="l7.1694" class="difflineminus">-    nsresult rv = Serialize(&amp;icalstr);</span>
<a href="#l7.1695"></a><span id="l7.1695" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.1696"></a><span id="l7.1696" class="difflineplus">+  char *icalstr;</span>
<a href="#l7.1697"></a><span id="l7.1697" class="difflineplus">+  nsresult rv = Serialize(&amp;icalstr);</span>
<a href="#l7.1698"></a><span id="l7.1698" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.1699"></a><span id="l7.1699"> </span>
<a href="#l7.1700"></a><span id="l7.1700" class="difflineminus">-    nsCOMPtr&lt;nsIStringInputStream&gt; aStringStream(</span>
<a href="#l7.1701"></a><span id="l7.1701" class="difflineminus">-        do_CreateInstance(NS_STRINGINPUTSTREAM_CONTRACTID, &amp;rv));</span>
<a href="#l7.1702"></a><span id="l7.1702" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.1703"></a><span id="l7.1703" class="difflineminus">-    // copies the string into the input stream that's handed back.</span>
<a href="#l7.1704"></a><span id="l7.1704" class="difflineminus">-    // This copy is necessary because we don't really own icalstr;</span>
<a href="#l7.1705"></a><span id="l7.1705" class="difflineminus">-    // it's one of libical's ring buffers</span>
<a href="#l7.1706"></a><span id="l7.1706" class="difflineminus">-    rv = aStringStream-&gt;SetData(icalstr, -1);</span>
<a href="#l7.1707"></a><span id="l7.1707" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.1708"></a><span id="l7.1708" class="difflineplus">+  nsCOMPtr&lt;nsIStringInputStream&gt; aStringStream(</span>
<a href="#l7.1709"></a><span id="l7.1709" class="difflineplus">+      do_CreateInstance(NS_STRINGINPUTSTREAM_CONTRACTID, &amp;rv));</span>
<a href="#l7.1710"></a><span id="l7.1710" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.1711"></a><span id="l7.1711" class="difflineplus">+  // copies the string into the input stream that's handed back.</span>
<a href="#l7.1712"></a><span id="l7.1712" class="difflineplus">+  // This copy is necessary because we don't really own icalstr;</span>
<a href="#l7.1713"></a><span id="l7.1713" class="difflineplus">+  // it's one of libical's ring buffers</span>
<a href="#l7.1714"></a><span id="l7.1714" class="difflineplus">+  rv = aStringStream-&gt;SetData(icalstr, -1);</span>
<a href="#l7.1715"></a><span id="l7.1715" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.1716"></a><span id="l7.1716"> </span>
<a href="#l7.1717"></a><span id="l7.1717" class="difflineminus">-    aStringStream.forget(aStreamResult);</span>
<a href="#l7.1718"></a><span id="l7.1718" class="difflineminus">-    return NS_OK;</span>
<a href="#l7.1719"></a><span id="l7.1719" class="difflineplus">+  aStringStream.forget(aStreamResult);</span>
<a href="#l7.1720"></a><span id="l7.1720" class="difflineplus">+  return NS_OK;</span>
<a href="#l7.1721"></a><span id="l7.1721"> }</span>
<a href="#l7.1722"></a><span id="l7.1722"> </span>
<a href="#l7.1723"></a><span id="l7.1723" class="difflineminus">-nsresult</span>
<a href="#l7.1724"></a><span id="l7.1724" class="difflineminus">-calIcalComponent::Serialize(char **icalstr)</span>
<a href="#l7.1725"></a><span id="l7.1725" class="difflineminus">-{</span>
<a href="#l7.1726"></a><span id="l7.1726" class="difflineminus">-    NS_ENSURE_ARG_POINTER(icalstr);</span>
<a href="#l7.1727"></a><span id="l7.1727" class="difflineplus">+nsresult calIcalComponent::Serialize(char **icalstr) {</span>
<a href="#l7.1728"></a><span id="l7.1728" class="difflineplus">+  NS_ENSURE_ARG_POINTER(icalstr);</span>
<a href="#l7.1729"></a><span id="l7.1729"> </span>
<a href="#l7.1730"></a><span id="l7.1730" class="difflineminus">-    // add the timezone bits</span>
<a href="#l7.1731"></a><span id="l7.1731" class="difflineminus">-    if (icalcomponent_isa(mComponent) == ICAL_VCALENDAR_COMPONENT &amp;&amp; mReferencedTimezones.Count() &gt; 0) {</span>
<a href="#l7.1732"></a><span id="l7.1732" class="difflineminus">-        for (auto iter = mReferencedTimezones.ConstIter(); !iter.Done(); iter.Next() ) {</span>
<a href="#l7.1733"></a><span id="l7.1733" class="difflineminus">-            icaltimezone * icaltz = cal::getIcalTimezone(iter.Data());</span>
<a href="#l7.1734"></a><span id="l7.1734" class="difflineminus">-            if (icaltz) {</span>
<a href="#l7.1735"></a><span id="l7.1735" class="difflineminus">-                icalcomponent * const tzcomp = icalcomponent_new_clone(icaltimezone_get_component(icaltz));</span>
<a href="#l7.1736"></a><span id="l7.1736" class="difflineminus">-                icalcomponent_add_component(mComponent, tzcomp);</span>
<a href="#l7.1737"></a><span id="l7.1737" class="difflineminus">-            }</span>
<a href="#l7.1738"></a><span id="l7.1738" class="difflineminus">-        }</span>
<a href="#l7.1739"></a><span id="l7.1739" class="difflineplus">+  // add the timezone bits</span>
<a href="#l7.1740"></a><span id="l7.1740" class="difflineplus">+  if (icalcomponent_isa(mComponent) == ICAL_VCALENDAR_COMPONENT &amp;&amp;</span>
<a href="#l7.1741"></a><span id="l7.1741" class="difflineplus">+      mReferencedTimezones.Count() &gt; 0) {</span>
<a href="#l7.1742"></a><span id="l7.1742" class="difflineplus">+    for (auto iter = mReferencedTimezones.ConstIter(); !iter.Done();</span>
<a href="#l7.1743"></a><span id="l7.1743" class="difflineplus">+         iter.Next()) {</span>
<a href="#l7.1744"></a><span id="l7.1744" class="difflineplus">+      icaltimezone *icaltz = cal::getIcalTimezone(iter.Data());</span>
<a href="#l7.1745"></a><span id="l7.1745" class="difflineplus">+      if (icaltz) {</span>
<a href="#l7.1746"></a><span id="l7.1746" class="difflineplus">+        icalcomponent *const tzcomp =</span>
<a href="#l7.1747"></a><span id="l7.1747" class="difflineplus">+            icalcomponent_new_clone(icaltimezone_get_component(icaltz));</span>
<a href="#l7.1748"></a><span id="l7.1748" class="difflineplus">+        icalcomponent_add_component(mComponent, tzcomp);</span>
<a href="#l7.1749"></a><span id="l7.1749" class="difflineplus">+      }</span>
<a href="#l7.1750"></a><span id="l7.1750">     }</span>
<a href="#l7.1751"></a><span id="l7.1751" class="difflineplus">+  }</span>
<a href="#l7.1752"></a><span id="l7.1752"> </span>
<a href="#l7.1753"></a><span id="l7.1753" class="difflineminus">-    *icalstr = icalcomponent_as_ical_string(mComponent);</span>
<a href="#l7.1754"></a><span id="l7.1754" class="difflineminus">-    if (!*icalstr) {</span>
<a href="#l7.1755"></a><span id="l7.1755" class="difflineminus">-        // xxx todo: what about NS_ERROR_OUT_OF_MEMORY?</span>
<a href="#l7.1756"></a><span id="l7.1756" class="difflineplus">+  *icalstr = icalcomponent_as_ical_string(mComponent);</span>
<a href="#l7.1757"></a><span id="l7.1757" class="difflineplus">+  if (!*icalstr) {</span>
<a href="#l7.1758"></a><span id="l7.1758" class="difflineplus">+    // xxx todo: what about NS_ERROR_OUT_OF_MEMORY?</span>
<a href="#l7.1759"></a><span id="l7.1759"> #ifdef DEBUG</span>
<a href="#l7.1760"></a><span id="l7.1760" class="difflineminus">-        fprintf(stderr, &quot;Error serializing: %d (%s)\n&quot;,</span>
<a href="#l7.1761"></a><span id="l7.1761" class="difflineminus">-                icalerrno, icalerror_strerror(icalerrno));</span>
<a href="#l7.1762"></a><span id="l7.1762" class="difflineplus">+    fprintf(stderr, &quot;Error serializing: %d (%s)\n&quot;, icalerrno,</span>
<a href="#l7.1763"></a><span id="l7.1763" class="difflineplus">+            icalerror_strerror(icalerrno));</span>
<a href="#l7.1764"></a><span id="l7.1764"> #endif</span>
<a href="#l7.1765"></a><span id="l7.1765" class="difflineminus">-        // The return values in calIError match with libical errnos,</span>
<a href="#l7.1766"></a><span id="l7.1766" class="difflineminus">-        // so no need for a conversion table or anything.</span>
<a href="#l7.1767"></a><span id="l7.1767" class="difflineminus">-        return static_cast&lt;nsresult&gt;(calIErrors::ICS_ERROR_BASE + icalerrno);</span>
<a href="#l7.1768"></a><span id="l7.1768" class="difflineminus">-    }</span>
<a href="#l7.1769"></a><span id="l7.1769" class="difflineplus">+    // The return values in calIError match with libical errnos,</span>
<a href="#l7.1770"></a><span id="l7.1770" class="difflineplus">+    // so no need for a conversion table or anything.</span>
<a href="#l7.1771"></a><span id="l7.1771" class="difflineplus">+    return static_cast&lt;nsresult&gt;(calIErrors::ICS_ERROR_BASE + icalerrno);</span>
<a href="#l7.1772"></a><span id="l7.1772" class="difflineplus">+  }</span>
<a href="#l7.1773"></a><span id="l7.1773"> </span>
<a href="#l7.1774"></a><span id="l7.1774" class="difflineminus">-    return NS_OK;</span>
<a href="#l7.1775"></a><span id="l7.1775" class="difflineplus">+  return NS_OK;</span>
<a href="#l7.1776"></a><span id="l7.1776"> }</span>
<a href="#l7.1777"></a><span id="l7.1777"> </span>
<a href="#l7.1778"></a><span id="l7.1778"> NS_IMETHODIMP</span>
<a href="#l7.1779"></a><span id="l7.1779" class="difflineminus">-calIcalComponent::Clone(calIIcalComponent **_retval)</span>
<a href="#l7.1780"></a><span id="l7.1780" class="difflineminus">-{</span>
<a href="#l7.1781"></a><span id="l7.1781" class="difflineminus">-    NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l7.1782"></a><span id="l7.1782" class="difflineminus">-    icalcomponent * cloned = icalcomponent_new_clone(mComponent);</span>
<a href="#l7.1783"></a><span id="l7.1783" class="difflineminus">-    if (cloned == nullptr)</span>
<a href="#l7.1784"></a><span id="l7.1784" class="difflineminus">-        return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l7.1785"></a><span id="l7.1785" class="difflineminus">-    calIcalComponent * const comp = new calIcalComponent(cloned, nullptr, getTzProvider());</span>
<a href="#l7.1786"></a><span id="l7.1786" class="difflineminus">-    if (comp == nullptr) {</span>
<a href="#l7.1787"></a><span id="l7.1787" class="difflineminus">-        icalcomponent_free(cloned);</span>
<a href="#l7.1788"></a><span id="l7.1788" class="difflineminus">-        return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l7.1789"></a><span id="l7.1789" class="difflineminus">-    }</span>
<a href="#l7.1790"></a><span id="l7.1790" class="difflineminus">-    NS_ADDREF(*_retval = comp);</span>
<a href="#l7.1791"></a><span id="l7.1791" class="difflineminus">-    return NS_OK;</span>
<a href="#l7.1792"></a><span id="l7.1792" class="difflineplus">+calIcalComponent::Clone(calIIcalComponent **_retval) {</span>
<a href="#l7.1793"></a><span id="l7.1793" class="difflineplus">+  NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l7.1794"></a><span id="l7.1794" class="difflineplus">+  icalcomponent *cloned = icalcomponent_new_clone(mComponent);</span>
<a href="#l7.1795"></a><span id="l7.1795" class="difflineplus">+  if (cloned == nullptr) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l7.1796"></a><span id="l7.1796" class="difflineplus">+  calIcalComponent *const comp =</span>
<a href="#l7.1797"></a><span id="l7.1797" class="difflineplus">+      new calIcalComponent(cloned, nullptr, getTzProvider());</span>
<a href="#l7.1798"></a><span id="l7.1798" class="difflineplus">+  if (comp == nullptr) {</span>
<a href="#l7.1799"></a><span id="l7.1799" class="difflineplus">+    icalcomponent_free(cloned);</span>
<a href="#l7.1800"></a><span id="l7.1800" class="difflineplus">+    return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l7.1801"></a><span id="l7.1801" class="difflineplus">+  }</span>
<a href="#l7.1802"></a><span id="l7.1802" class="difflineplus">+  NS_ADDREF(*_retval = comp);</span>
<a href="#l7.1803"></a><span id="l7.1803" class="difflineplus">+  return NS_OK;</span>
<a href="#l7.1804"></a><span id="l7.1804"> }</span>
<a href="#l7.1805"></a><span id="l7.1805"> </span>
<a href="#l7.1806"></a><span id="l7.1806"> NS_IMETHODIMP</span>
<a href="#l7.1807"></a><span id="l7.1807" class="difflineminus">-calIcalComponent::AddSubcomponent(calIIcalComponent *aComp)</span>
<a href="#l7.1808"></a><span id="l7.1808" class="difflineminus">-{</span>
<a href="#l7.1809"></a><span id="l7.1809" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aComp);</span>
<a href="#l7.1810"></a><span id="l7.1810" class="difflineplus">+calIcalComponent::AddSubcomponent(calIIcalComponent *aComp) {</span>
<a href="#l7.1811"></a><span id="l7.1811" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aComp);</span>
<a href="#l7.1812"></a><span id="l7.1812"> </span>
<a href="#l7.1813"></a><span id="l7.1813" class="difflineminus">-    /* XXX mildly unsafe assumption here.</span>
<a href="#l7.1814"></a><span id="l7.1814" class="difflineminus">-     * To fix it, I will:</span>
<a href="#l7.1815"></a><span id="l7.1815" class="difflineminus">-     * - check the object's classinfo to find out if I have one of my</span>
<a href="#l7.1816"></a><span id="l7.1816" class="difflineminus">-     *   own objects, and if not</span>
<a href="#l7.1817"></a><span id="l7.1817" class="difflineminus">-     * - use comp-&gt;serializeToICS and reparse to create a copy.</span>
<a href="#l7.1818"></a><span id="l7.1818" class="difflineminus">-     *</span>
<a href="#l7.1819"></a><span id="l7.1819" class="difflineminus">-     * I should probably also return the new/reused component so that the</span>
<a href="#l7.1820"></a><span id="l7.1820" class="difflineminus">-     * caller has something it can poke at all live-like.</span>
<a href="#l7.1821"></a><span id="l7.1821" class="difflineminus">-     */</span>
<a href="#l7.1822"></a><span id="l7.1822" class="difflineminus">-</span>
<a href="#l7.1823"></a><span id="l7.1823" class="difflineminus">-    nsresult rv;</span>
<a href="#l7.1824"></a><span id="l7.1824" class="difflineminus">-    nsCOMPtr&lt;calIIcalComponentLibical&gt; icalcomp = do_QueryInterface(aComp, &amp;rv);</span>
<a href="#l7.1825"></a><span id="l7.1825" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.1826"></a><span id="l7.1826" class="difflineplus">+  /* XXX mildly unsafe assumption here.</span>
<a href="#l7.1827"></a><span id="l7.1827" class="difflineplus">+   * To fix it, I will:</span>
<a href="#l7.1828"></a><span id="l7.1828" class="difflineplus">+   * - check the object's classinfo to find out if I have one of my</span>
<a href="#l7.1829"></a><span id="l7.1829" class="difflineplus">+   *   own objects, and if not</span>
<a href="#l7.1830"></a><span id="l7.1830" class="difflineplus">+   * - use comp-&gt;serializeToICS and reparse to create a copy.</span>
<a href="#l7.1831"></a><span id="l7.1831" class="difflineplus">+   *</span>
<a href="#l7.1832"></a><span id="l7.1832" class="difflineplus">+   * I should probably also return the new/reused component so that the</span>
<a href="#l7.1833"></a><span id="l7.1833" class="difflineplus">+   * caller has something it can poke at all live-like.</span>
<a href="#l7.1834"></a><span id="l7.1834" class="difflineplus">+   */</span>
<a href="#l7.1835"></a><span id="l7.1835"> </span>
<a href="#l7.1836"></a><span id="l7.1836" class="difflineminus">-    calIcalComponent * const ical = toIcalComponent(icalcomp);</span>
<a href="#l7.1837"></a><span id="l7.1837" class="difflineplus">+  nsresult rv;</span>
<a href="#l7.1838"></a><span id="l7.1838" class="difflineplus">+  nsCOMPtr&lt;calIIcalComponentLibical&gt; icalcomp = do_QueryInterface(aComp, &amp;rv);</span>
<a href="#l7.1839"></a><span id="l7.1839" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.1840"></a><span id="l7.1840"> </span>
<a href="#l7.1841"></a><span id="l7.1841" class="difflineminus">-    uint32_t tzCount = 0;</span>
<a href="#l7.1842"></a><span id="l7.1842" class="difflineminus">-    calITimezone ** timezones = nullptr;</span>
<a href="#l7.1843"></a><span id="l7.1843" class="difflineminus">-    rv = ical-&gt;GetReferencedTimezones(&amp;tzCount, &amp;timezones);</span>
<a href="#l7.1844"></a><span id="l7.1844" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.1845"></a><span id="l7.1845" class="difflineplus">+  calIcalComponent *const ical = toIcalComponent(icalcomp);</span>
<a href="#l7.1846"></a><span id="l7.1846"> </span>
<a href="#l7.1847"></a><span id="l7.1847" class="difflineminus">-    calIcalComponent * const vcal = getParentVCalendarOrThis();</span>
<a href="#l7.1848"></a><span id="l7.1848" class="difflineminus">-    bool failed = false;</span>
<a href="#l7.1849"></a><span id="l7.1849" class="difflineminus">-    for (uint32_t i = 0; i &lt; tzCount; i++) {</span>
<a href="#l7.1850"></a><span id="l7.1850" class="difflineminus">-        if (!failed) {</span>
<a href="#l7.1851"></a><span id="l7.1851" class="difflineminus">-            rv = vcal-&gt;AddTimezoneReference(timezones[i]);</span>
<a href="#l7.1852"></a><span id="l7.1852" class="difflineminus">-            if (NS_FAILED(rv))</span>
<a href="#l7.1853"></a><span id="l7.1853" class="difflineminus">-                failed = true;</span>
<a href="#l7.1854"></a><span id="l7.1854" class="difflineminus">-        }</span>
<a href="#l7.1855"></a><span id="l7.1855" class="difflineplus">+  uint32_t tzCount = 0;</span>
<a href="#l7.1856"></a><span id="l7.1856" class="difflineplus">+  calITimezone **timezones = nullptr;</span>
<a href="#l7.1857"></a><span id="l7.1857" class="difflineplus">+  rv = ical-&gt;GetReferencedTimezones(&amp;tzCount, &amp;timezones);</span>
<a href="#l7.1858"></a><span id="l7.1858" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.1859"></a><span id="l7.1859"> </span>
<a href="#l7.1860"></a><span id="l7.1860" class="difflineminus">-        NS_RELEASE(timezones[i]);</span>
<a href="#l7.1861"></a><span id="l7.1861" class="difflineplus">+  calIcalComponent *const vcal = getParentVCalendarOrThis();</span>
<a href="#l7.1862"></a><span id="l7.1862" class="difflineplus">+  bool failed = false;</span>
<a href="#l7.1863"></a><span id="l7.1863" class="difflineplus">+  for (uint32_t i = 0; i &lt; tzCount; i++) {</span>
<a href="#l7.1864"></a><span id="l7.1864" class="difflineplus">+    if (!failed) {</span>
<a href="#l7.1865"></a><span id="l7.1865" class="difflineplus">+      rv = vcal-&gt;AddTimezoneReference(timezones[i]);</span>
<a href="#l7.1866"></a><span id="l7.1866" class="difflineplus">+      if (NS_FAILED(rv)) failed = true;</span>
<a href="#l7.1867"></a><span id="l7.1867">     }</span>
<a href="#l7.1868"></a><span id="l7.1868"> </span>
<a href="#l7.1869"></a><span id="l7.1869" class="difflineminus">-    free(timezones);</span>
<a href="#l7.1870"></a><span id="l7.1870" class="difflineplus">+    NS_RELEASE(timezones[i]);</span>
<a href="#l7.1871"></a><span id="l7.1871" class="difflineplus">+  }</span>
<a href="#l7.1872"></a><span id="l7.1872"> </span>
<a href="#l7.1873"></a><span id="l7.1873" class="difflineminus">-    if (failed)</span>
<a href="#l7.1874"></a><span id="l7.1874" class="difflineminus">-        return rv;</span>
<a href="#l7.1875"></a><span id="l7.1875" class="difflineplus">+  free(timezones);</span>
<a href="#l7.1876"></a><span id="l7.1876" class="difflineplus">+</span>
<a href="#l7.1877"></a><span id="l7.1877" class="difflineplus">+  if (failed) return rv;</span>
<a href="#l7.1878"></a><span id="l7.1878"> </span>
<a href="#l7.1879"></a><span id="l7.1879" class="difflineminus">-    if (ical-&gt;mParent) {</span>
<a href="#l7.1880"></a><span id="l7.1880" class="difflineminus">-        ical-&gt;mComponent = icalcomponent_new_clone(ical-&gt;mComponent);</span>
<a href="#l7.1881"></a><span id="l7.1881" class="difflineminus">-    }</span>
<a href="#l7.1882"></a><span id="l7.1882" class="difflineminus">-    ical-&gt;mParent = this;</span>
<a href="#l7.1883"></a><span id="l7.1883" class="difflineminus">-    icalcomponent_add_component(mComponent, ical-&gt;mComponent);</span>
<a href="#l7.1884"></a><span id="l7.1884" class="difflineminus">-    return NS_OK;</span>
<a href="#l7.1885"></a><span id="l7.1885" class="difflineplus">+  if (ical-&gt;mParent) {</span>
<a href="#l7.1886"></a><span id="l7.1886" class="difflineplus">+    ical-&gt;mComponent = icalcomponent_new_clone(ical-&gt;mComponent);</span>
<a href="#l7.1887"></a><span id="l7.1887" class="difflineplus">+  }</span>
<a href="#l7.1888"></a><span id="l7.1888" class="difflineplus">+  ical-&gt;mParent = this;</span>
<a href="#l7.1889"></a><span id="l7.1889" class="difflineplus">+  icalcomponent_add_component(mComponent, ical-&gt;mComponent);</span>
<a href="#l7.1890"></a><span id="l7.1890" class="difflineplus">+  return NS_OK;</span>
<a href="#l7.1891"></a><span id="l7.1891"> }</span>
<a href="#l7.1892"></a><span id="l7.1892"> </span>
<a href="#l7.1893"></a><span id="l7.1893"> // NS_IMETHODIMP</span>
<a href="#l7.1894"></a><span id="l7.1894"> // IcalComponent::RemoveSubcomponent(calIIcalComponent *comp)</span>
<a href="#l7.1895"></a><span id="l7.1895"> // {</span>
<a href="#l7.1896"></a><span id="l7.1896"> //     NS_ENSURE_ARG_POINTER(comp);</span>
<a href="#l7.1897"></a><span id="l7.1897"> //     calIcalComponent *ical = static_cast&lt;calIcalComponent *&gt;(comp);</span>
<a href="#l7.1898"></a><span id="l7.1898"> //     icalcomponent_remove_component(mComponent, ical-&gt;mComponent);</span>
<a href="#l7.1899"></a><span id="l7.1899"> //     ical-&gt;mParent = nullptr;</span>
<a href="#l7.1900"></a><span id="l7.1900"> //     return NS_OK;</span>
<a href="#l7.1901"></a><span id="l7.1901"> // }</span>
<a href="#l7.1902"></a><span id="l7.1902"> </span>
<a href="#l7.1903"></a><span id="l7.1903"> NS_IMETHODIMP</span>
<a href="#l7.1904"></a><span id="l7.1904"> calIcalComponent::GetFirstProperty(const nsACString &amp;kind,</span>
<a href="#l7.1905"></a><span id="l7.1905" class="difflineminus">-                                   calIIcalProperty **prop)</span>
<a href="#l7.1906"></a><span id="l7.1906" class="difflineminus">-{</span>
<a href="#l7.1907"></a><span id="l7.1907" class="difflineminus">-    NS_ENSURE_ARG_POINTER(prop);</span>
<a href="#l7.1908"></a><span id="l7.1908" class="difflineplus">+                                   calIIcalProperty **prop) {</span>
<a href="#l7.1909"></a><span id="l7.1909" class="difflineplus">+  NS_ENSURE_ARG_POINTER(prop);</span>
<a href="#l7.1910"></a><span id="l7.1910"> </span>
<a href="#l7.1911"></a><span id="l7.1911" class="difflineminus">-    icalproperty_kind propkind =</span>
<a href="#l7.1912"></a><span id="l7.1912" class="difflineminus">-        icalproperty_string_to_kind(PromiseFlatCString(kind).get());</span>
<a href="#l7.1913"></a><span id="l7.1913" class="difflineplus">+  icalproperty_kind propkind =</span>
<a href="#l7.1914"></a><span id="l7.1914" class="difflineplus">+      icalproperty_string_to_kind(PromiseFlatCString(kind).get());</span>
<a href="#l7.1915"></a><span id="l7.1915"> </span>
<a href="#l7.1916"></a><span id="l7.1916" class="difflineminus">-    if (propkind == ICAL_NO_PROPERTY)</span>
<a href="#l7.1917"></a><span id="l7.1917" class="difflineminus">-        return NS_ERROR_INVALID_ARG;</span>
<a href="#l7.1918"></a><span id="l7.1918" class="difflineplus">+  if (propkind == ICAL_NO_PROPERTY) return NS_ERROR_INVALID_ARG;</span>
<a href="#l7.1919"></a><span id="l7.1919"> </span>
<a href="#l7.1920"></a><span id="l7.1920" class="difflineminus">-    icalproperty *icalprop = nullptr;</span>
<a href="#l7.1921"></a><span id="l7.1921" class="difflineminus">-    if (propkind == ICAL_X_PROPERTY) {</span>
<a href="#l7.1922"></a><span id="l7.1922" class="difflineminus">-        for (icalprop =</span>
<a href="#l7.1923"></a><span id="l7.1923" class="difflineminus">-                 icalcomponent_get_first_property(mComponent, ICAL_X_PROPERTY);</span>
<a href="#l7.1924"></a><span id="l7.1924" class="difflineminus">-             icalprop;</span>
<a href="#l7.1925"></a><span id="l7.1925" class="difflineminus">-             icalprop = icalcomponent_get_next_property(mComponent,</span>
<a href="#l7.1926"></a><span id="l7.1926" class="difflineminus">-                                                        ICAL_X_PROPERTY)) {</span>
<a href="#l7.1927"></a><span id="l7.1927" class="difflineplus">+  icalproperty *icalprop = nullptr;</span>
<a href="#l7.1928"></a><span id="l7.1928" class="difflineplus">+  if (propkind == ICAL_X_PROPERTY) {</span>
<a href="#l7.1929"></a><span id="l7.1929" class="difflineplus">+    for (icalprop =</span>
<a href="#l7.1930"></a><span id="l7.1930" class="difflineplus">+             icalcomponent_get_first_property(mComponent, ICAL_X_PROPERTY);</span>
<a href="#l7.1931"></a><span id="l7.1931" class="difflineplus">+         icalprop; icalprop = icalcomponent_get_next_property(</span>
<a href="#l7.1932"></a><span id="l7.1932" class="difflineplus">+                       mComponent, ICAL_X_PROPERTY)) {</span>
<a href="#l7.1933"></a><span id="l7.1933" class="difflineplus">+      if (kind.Equals(icalproperty_get_x_name(icalprop))) break;</span>
<a href="#l7.1934"></a><span id="l7.1934" class="difflineplus">+    }</span>
<a href="#l7.1935"></a><span id="l7.1935" class="difflineplus">+  } else {</span>
<a href="#l7.1936"></a><span id="l7.1936" class="difflineplus">+    icalprop = icalcomponent_get_first_property(mComponent, propkind);</span>
<a href="#l7.1937"></a><span id="l7.1937" class="difflineplus">+  }</span>
<a href="#l7.1938"></a><span id="l7.1938"> </span>
<a href="#l7.1939"></a><span id="l7.1939" class="difflineminus">-            if (kind.Equals(icalproperty_get_x_name(icalprop)))</span>
<a href="#l7.1940"></a><span id="l7.1940" class="difflineminus">-                break;</span>
<a href="#l7.1941"></a><span id="l7.1941" class="difflineminus">-        }</span>
<a href="#l7.1942"></a><span id="l7.1942" class="difflineminus">-    } else {</span>
<a href="#l7.1943"></a><span id="l7.1943" class="difflineminus">-        icalprop = icalcomponent_get_first_property(mComponent, propkind);</span>
<a href="#l7.1944"></a><span id="l7.1944" class="difflineminus">-    }</span>
<a href="#l7.1945"></a><span id="l7.1945" class="difflineplus">+  if (!icalprop) {</span>
<a href="#l7.1946"></a><span id="l7.1946" class="difflineplus">+    *prop = nullptr;</span>
<a href="#l7.1947"></a><span id="l7.1947" class="difflineplus">+    return NS_OK;</span>
<a href="#l7.1948"></a><span id="l7.1948" class="difflineplus">+  }</span>
<a href="#l7.1949"></a><span id="l7.1949"> </span>
<a href="#l7.1950"></a><span id="l7.1950" class="difflineminus">-    if (!icalprop) {</span>
<a href="#l7.1951"></a><span id="l7.1951" class="difflineminus">-        *prop = nullptr;</span>
<a href="#l7.1952"></a><span id="l7.1952" class="difflineminus">-        return NS_OK;</span>
<a href="#l7.1953"></a><span id="l7.1953" class="difflineminus">-    }</span>
<a href="#l7.1954"></a><span id="l7.1954" class="difflineminus">-</span>
<a href="#l7.1955"></a><span id="l7.1955" class="difflineminus">-    *prop = new calIcalProperty(icalprop, this);</span>
<a href="#l7.1956"></a><span id="l7.1956" class="difflineminus">-    CAL_ENSURE_MEMORY(*prop);</span>
<a href="#l7.1957"></a><span id="l7.1957" class="difflineminus">-    NS_ADDREF(*prop);</span>
<a href="#l7.1958"></a><span id="l7.1958" class="difflineminus">-    return NS_OK;</span>
<a href="#l7.1959"></a><span id="l7.1959" class="difflineplus">+  *prop = new calIcalProperty(icalprop, this);</span>
<a href="#l7.1960"></a><span id="l7.1960" class="difflineplus">+  CAL_ENSURE_MEMORY(*prop);</span>
<a href="#l7.1961"></a><span id="l7.1961" class="difflineplus">+  NS_ADDREF(*prop);</span>
<a href="#l7.1962"></a><span id="l7.1962" class="difflineplus">+  return NS_OK;</span>
<a href="#l7.1963"></a><span id="l7.1963"> }</span>
<a href="#l7.1964"></a><span id="l7.1964"> </span>
<a href="#l7.1965"></a><span id="l7.1965"> NS_IMETHODIMP</span>
<a href="#l7.1966"></a><span id="l7.1966" class="difflineminus">-calIcalComponent::GetNextProperty(const nsACString &amp;kind, calIIcalProperty **prop)</span>
<a href="#l7.1967"></a><span id="l7.1967" class="difflineminus">-{</span>
<a href="#l7.1968"></a><span id="l7.1968" class="difflineminus">-    NS_ENSURE_ARG_POINTER(prop);</span>
<a href="#l7.1969"></a><span id="l7.1969" class="difflineminus">-</span>
<a href="#l7.1970"></a><span id="l7.1970" class="difflineminus">-    icalproperty_kind propkind =</span>
<a href="#l7.1971"></a><span id="l7.1971" class="difflineminus">-        icalproperty_string_to_kind(PromiseFlatCString(kind).get());</span>
<a href="#l7.1972"></a><span id="l7.1972" class="difflineplus">+calIcalComponent::GetNextProperty(const nsACString &amp;kind,</span>
<a href="#l7.1973"></a><span id="l7.1973" class="difflineplus">+                                  calIIcalProperty **prop) {</span>
<a href="#l7.1974"></a><span id="l7.1974" class="difflineplus">+  NS_ENSURE_ARG_POINTER(prop);</span>
<a href="#l7.1975"></a><span id="l7.1975"> </span>
<a href="#l7.1976"></a><span id="l7.1976" class="difflineminus">-    if (propkind == ICAL_NO_PROPERTY)</span>
<a href="#l7.1977"></a><span id="l7.1977" class="difflineminus">-        return NS_ERROR_INVALID_ARG;</span>
<a href="#l7.1978"></a><span id="l7.1978" class="difflineminus">-    icalproperty *icalprop = nullptr;</span>
<a href="#l7.1979"></a><span id="l7.1979" class="difflineminus">-    if (propkind == ICAL_X_PROPERTY) {</span>
<a href="#l7.1980"></a><span id="l7.1980" class="difflineminus">-        for (icalprop =</span>
<a href="#l7.1981"></a><span id="l7.1981" class="difflineminus">-                 icalcomponent_get_next_property(mComponent, ICAL_X_PROPERTY);</span>
<a href="#l7.1982"></a><span id="l7.1982" class="difflineminus">-             icalprop;</span>
<a href="#l7.1983"></a><span id="l7.1983" class="difflineminus">-             icalprop = icalcomponent_get_next_property(mComponent,</span>
<a href="#l7.1984"></a><span id="l7.1984" class="difflineminus">-                                                        ICAL_X_PROPERTY)) {</span>
<a href="#l7.1985"></a><span id="l7.1985" class="difflineplus">+  icalproperty_kind propkind =</span>
<a href="#l7.1986"></a><span id="l7.1986" class="difflineplus">+      icalproperty_string_to_kind(PromiseFlatCString(kind).get());</span>
<a href="#l7.1987"></a><span id="l7.1987"> </span>
<a href="#l7.1988"></a><span id="l7.1988" class="difflineminus">-            if (kind.Equals(icalproperty_get_x_name(icalprop)))</span>
<a href="#l7.1989"></a><span id="l7.1989" class="difflineminus">-                break;</span>
<a href="#l7.1990"></a><span id="l7.1990" class="difflineminus">-        }</span>
<a href="#l7.1991"></a><span id="l7.1991" class="difflineminus">-    } else {</span>
<a href="#l7.1992"></a><span id="l7.1992" class="difflineminus">-        icalprop = icalcomponent_get_next_property(mComponent, propkind);</span>
<a href="#l7.1993"></a><span id="l7.1993" class="difflineplus">+  if (propkind == ICAL_NO_PROPERTY) return NS_ERROR_INVALID_ARG;</span>
<a href="#l7.1994"></a><span id="l7.1994" class="difflineplus">+  icalproperty *icalprop = nullptr;</span>
<a href="#l7.1995"></a><span id="l7.1995" class="difflineplus">+  if (propkind == ICAL_X_PROPERTY) {</span>
<a href="#l7.1996"></a><span id="l7.1996" class="difflineplus">+    for (icalprop =</span>
<a href="#l7.1997"></a><span id="l7.1997" class="difflineplus">+             icalcomponent_get_next_property(mComponent, ICAL_X_PROPERTY);</span>
<a href="#l7.1998"></a><span id="l7.1998" class="difflineplus">+         icalprop; icalprop = icalcomponent_get_next_property(</span>
<a href="#l7.1999"></a><span id="l7.1999" class="difflineplus">+                       mComponent, ICAL_X_PROPERTY)) {</span>
<a href="#l7.2000"></a><span id="l7.2000" class="difflineplus">+      if (kind.Equals(icalproperty_get_x_name(icalprop))) break;</span>
<a href="#l7.2001"></a><span id="l7.2001">     }</span>
<a href="#l7.2002"></a><span id="l7.2002" class="difflineplus">+  } else {</span>
<a href="#l7.2003"></a><span id="l7.2003" class="difflineplus">+    icalprop = icalcomponent_get_next_property(mComponent, propkind);</span>
<a href="#l7.2004"></a><span id="l7.2004" class="difflineplus">+  }</span>
<a href="#l7.2005"></a><span id="l7.2005"> </span>
<a href="#l7.2006"></a><span id="l7.2006" class="difflineminus">-    if (!icalprop) {</span>
<a href="#l7.2007"></a><span id="l7.2007" class="difflineminus">-        *prop = nullptr;</span>
<a href="#l7.2008"></a><span id="l7.2008" class="difflineminus">-        return NS_OK;</span>
<a href="#l7.2009"></a><span id="l7.2009" class="difflineminus">-    }</span>
<a href="#l7.2010"></a><span id="l7.2010" class="difflineplus">+  if (!icalprop) {</span>
<a href="#l7.2011"></a><span id="l7.2011" class="difflineplus">+    *prop = nullptr;</span>
<a href="#l7.2012"></a><span id="l7.2012" class="difflineplus">+    return NS_OK;</span>
<a href="#l7.2013"></a><span id="l7.2013" class="difflineplus">+  }</span>
<a href="#l7.2014"></a><span id="l7.2014"> </span>
<a href="#l7.2015"></a><span id="l7.2015" class="difflineminus">-    *prop = new calIcalProperty(icalprop, this);</span>
<a href="#l7.2016"></a><span id="l7.2016" class="difflineminus">-    CAL_ENSURE_MEMORY(*prop);</span>
<a href="#l7.2017"></a><span id="l7.2017" class="difflineminus">-    NS_ADDREF(*prop);</span>
<a href="#l7.2018"></a><span id="l7.2018" class="difflineminus">-    return NS_OK;</span>
<a href="#l7.2019"></a><span id="l7.2019" class="difflineplus">+  *prop = new calIcalProperty(icalprop, this);</span>
<a href="#l7.2020"></a><span id="l7.2020" class="difflineplus">+  CAL_ENSURE_MEMORY(*prop);</span>
<a href="#l7.2021"></a><span id="l7.2021" class="difflineplus">+  NS_ADDREF(*prop);</span>
<a href="#l7.2022"></a><span id="l7.2022" class="difflineplus">+  return NS_OK;</span>
<a href="#l7.2023"></a><span id="l7.2023"> }</span>
<a href="#l7.2024"></a><span id="l7.2024"> </span>
<a href="#l7.2025"></a><span id="l7.2025"> NS_IMETHODIMP</span>
<a href="#l7.2026"></a><span id="l7.2026" class="difflineminus">-calIcalComponent::AddProperty(calIIcalProperty * aProp)</span>
<a href="#l7.2027"></a><span id="l7.2027" class="difflineminus">-{</span>
<a href="#l7.2028"></a><span id="l7.2028" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aProp);</span>
<a href="#l7.2029"></a><span id="l7.2029" class="difflineminus">-    // We assume a calIcalProperty is passed in (else the cast wouldn't run and</span>
<a href="#l7.2030"></a><span id="l7.2030" class="difflineminus">-    // we are about to crash), so we assume that this ICS service code has created</span>
<a href="#l7.2031"></a><span id="l7.2031" class="difflineminus">-    // the property.</span>
<a href="#l7.2032"></a><span id="l7.2032" class="difflineplus">+calIcalComponent::AddProperty(calIIcalProperty *aProp) {</span>
<a href="#l7.2033"></a><span id="l7.2033" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aProp);</span>
<a href="#l7.2034"></a><span id="l7.2034" class="difflineplus">+  // We assume a calIcalProperty is passed in (else the cast wouldn't run and</span>
<a href="#l7.2035"></a><span id="l7.2035" class="difflineplus">+  // we are about to crash), so we assume that this ICS service code has created</span>
<a href="#l7.2036"></a><span id="l7.2036" class="difflineplus">+  // the property.</span>
<a href="#l7.2037"></a><span id="l7.2037"> </span>
<a href="#l7.2038"></a><span id="l7.2038" class="difflineminus">-    nsresult rv;</span>
<a href="#l7.2039"></a><span id="l7.2039" class="difflineminus">-    nsCOMPtr&lt;calIIcalPropertyLibical&gt; icalprop = do_QueryInterface(aProp, &amp;rv);</span>
<a href="#l7.2040"></a><span id="l7.2040" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.2041"></a><span id="l7.2041" class="difflineplus">+  nsresult rv;</span>
<a href="#l7.2042"></a><span id="l7.2042" class="difflineplus">+  nsCOMPtr&lt;calIIcalPropertyLibical&gt; icalprop = do_QueryInterface(aProp, &amp;rv);</span>
<a href="#l7.2043"></a><span id="l7.2043" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.2044"></a><span id="l7.2044"> </span>
<a href="#l7.2045"></a><span id="l7.2045" class="difflineminus">-    calIcalProperty * const ical = toIcalProperty(icalprop);</span>
<a href="#l7.2046"></a><span id="l7.2046" class="difflineminus">-    if (ical-&gt;mParent) {</span>
<a href="#l7.2047"></a><span id="l7.2047" class="difflineminus">-        ical-&gt;mProperty = icalproperty_new_clone(ical-&gt;mProperty);</span>
<a href="#l7.2048"></a><span id="l7.2048" class="difflineminus">-    }</span>
<a href="#l7.2049"></a><span id="l7.2049" class="difflineminus">-    ical-&gt;mParent = this;</span>
<a href="#l7.2050"></a><span id="l7.2050" class="difflineminus">-    icalcomponent_add_property(mComponent, ical-&gt;mProperty);</span>
<a href="#l7.2051"></a><span id="l7.2051" class="difflineplus">+  calIcalProperty *const ical = toIcalProperty(icalprop);</span>
<a href="#l7.2052"></a><span id="l7.2052" class="difflineplus">+  if (ical-&gt;mParent) {</span>
<a href="#l7.2053"></a><span id="l7.2053" class="difflineplus">+    ical-&gt;mProperty = icalproperty_new_clone(ical-&gt;mProperty);</span>
<a href="#l7.2054"></a><span id="l7.2054" class="difflineplus">+  }</span>
<a href="#l7.2055"></a><span id="l7.2055" class="difflineplus">+  ical-&gt;mParent = this;</span>
<a href="#l7.2056"></a><span id="l7.2056" class="difflineplus">+  icalcomponent_add_property(mComponent, ical-&gt;mProperty);</span>
<a href="#l7.2057"></a><span id="l7.2057"> </span>
<a href="#l7.2058"></a><span id="l7.2058" class="difflineminus">-    nsCOMPtr&lt;calIDateTime&gt; dt;</span>
<a href="#l7.2059"></a><span id="l7.2059" class="difflineminus">-    if (NS_SUCCEEDED(aProp-&gt;GetValueAsDatetime(getter_AddRefs(dt))) &amp;&amp; dt) {</span>
<a href="#l7.2060"></a><span id="l7.2060" class="difflineminus">-        // make sure timezone definition will be included:</span>
<a href="#l7.2061"></a><span id="l7.2061" class="difflineminus">-        nsCOMPtr&lt;calITimezone&gt; tz;</span>
<a href="#l7.2062"></a><span id="l7.2062" class="difflineminus">-        if (NS_SUCCEEDED(dt-&gt;GetTimezone(getter_AddRefs(tz))) &amp;&amp; tz) {</span>
<a href="#l7.2063"></a><span id="l7.2063" class="difflineminus">-            getParentVCalendarOrThis()-&gt;AddTimezoneReference(tz);</span>
<a href="#l7.2064"></a><span id="l7.2064" class="difflineminus">-        }</span>
<a href="#l7.2065"></a><span id="l7.2065" class="difflineplus">+  nsCOMPtr&lt;calIDateTime&gt; dt;</span>
<a href="#l7.2066"></a><span id="l7.2066" class="difflineplus">+  if (NS_SUCCEEDED(aProp-&gt;GetValueAsDatetime(getter_AddRefs(dt))) &amp;&amp; dt) {</span>
<a href="#l7.2067"></a><span id="l7.2067" class="difflineplus">+    // make sure timezone definition will be included:</span>
<a href="#l7.2068"></a><span id="l7.2068" class="difflineplus">+    nsCOMPtr&lt;calITimezone&gt; tz;</span>
<a href="#l7.2069"></a><span id="l7.2069" class="difflineplus">+    if (NS_SUCCEEDED(dt-&gt;GetTimezone(getter_AddRefs(tz))) &amp;&amp; tz) {</span>
<a href="#l7.2070"></a><span id="l7.2070" class="difflineplus">+      getParentVCalendarOrThis()-&gt;AddTimezoneReference(tz);</span>
<a href="#l7.2071"></a><span id="l7.2071">     }</span>
<a href="#l7.2072"></a><span id="l7.2072" class="difflineminus">-    return NS_OK;</span>
<a href="#l7.2073"></a><span id="l7.2073" class="difflineplus">+  }</span>
<a href="#l7.2074"></a><span id="l7.2074" class="difflineplus">+  return NS_OK;</span>
<a href="#l7.2075"></a><span id="l7.2075"> }</span>
<a href="#l7.2076"></a><span id="l7.2076"> </span>
<a href="#l7.2077"></a><span id="l7.2077"> // If you add then remove a property/component, the referenced</span>
<a href="#l7.2078"></a><span id="l7.2078"> // timezones won't get purged out. There's currently no client code.</span>
<a href="#l7.2079"></a><span id="l7.2079"> </span>
<a href="#l7.2080"></a><span id="l7.2080"> // NS_IMETHODIMP</span>
<a href="#l7.2081"></a><span id="l7.2081"> // calIcalComponent::RemoveProperty(calIIcalProperty *prop)</span>
<a href="#l7.2082"></a><span id="l7.2082"> // {</span>
<a href="#l7.2083"></a><span id="l7.2083"> //     NS_ENSURE_ARG_POINTER(prop);</span>
<a href="#l7.2084"></a><span id="l7.2084"> //     // XXX like AddSubcomponent, this is questionable</span>
<a href="#l7.2085"></a><span id="l7.2085"> //     calIcalProperty *ical = static_cast&lt;calIcalProperty *&gt;(prop);</span>
<a href="#l7.2086"></a><span id="l7.2086"> //     icalcomponent_remove_property(mComponent, ical-&gt;mProperty);</span>
<a href="#l7.2087"></a><span id="l7.2087"> //     ical-&gt;mParent = nullptr;</span>
<a href="#l7.2088"></a><span id="l7.2088"> //     return NS_OK;</span>
<a href="#l7.2089"></a><span id="l7.2089"> // }</span>
<a href="#l7.2090"></a><span id="l7.2090"> </span>
<a href="#l7.2091"></a><span id="l7.2091" class="difflineminus">-NS_IMPL_CLASSINFO(calICSService, nullptr, nsIClassInfo::THREADSAFE, CAL_ICSSERVICE_CID)</span>
<a href="#l7.2092"></a><span id="l7.2092" class="difflineplus">+NS_IMPL_CLASSINFO(calICSService, nullptr, nsIClassInfo::THREADSAFE,</span>
<a href="#l7.2093"></a><span id="l7.2093" class="difflineplus">+                  CAL_ICSSERVICE_CID)</span>
<a href="#l7.2094"></a><span id="l7.2094"> NS_IMPL_ISUPPORTS_CI(calICSService, calIICSService)</span>
<a href="#l7.2095"></a><span id="l7.2095"> </span>
<a href="#l7.2096"></a><span id="l7.2096" class="difflineminus">-calICSService::calICSService()</span>
<a href="#l7.2097"></a><span id="l7.2097" class="difflineminus">-{</span>
<a href="#l7.2098"></a><span id="l7.2098" class="difflineminus">-}</span>
<a href="#l7.2099"></a><span id="l7.2099" class="difflineplus">+calICSService::calICSService() {}</span>
<a href="#l7.2100"></a><span id="l7.2100"> </span>
<a href="#l7.2101"></a><span id="l7.2101"> NS_IMETHODIMP</span>
<a href="#l7.2102"></a><span id="l7.2102" class="difflineminus">-calICSService::ParseICS(const nsACString&amp; serialized,</span>
<a href="#l7.2103"></a><span id="l7.2103" class="difflineplus">+calICSService::ParseICS(const nsACString &amp;serialized,</span>
<a href="#l7.2104"></a><span id="l7.2104">                         calITimezoneProvider *tzProvider,</span>
<a href="#l7.2105"></a><span id="l7.2105" class="difflineminus">-                        calIIcalComponent **component)</span>
<a href="#l7.2106"></a><span id="l7.2106" class="difflineminus">-{</span>
<a href="#l7.2107"></a><span id="l7.2107" class="difflineminus">-    NS_ENSURE_ARG_POINTER(component);</span>
<a href="#l7.2108"></a><span id="l7.2108" class="difflineminus">-    icalcomponent *ical =</span>
<a href="#l7.2109"></a><span id="l7.2109" class="difflineminus">-        icalparser_parse_string(PromiseFlatCString(serialized).get());</span>
<a href="#l7.2110"></a><span id="l7.2110" class="difflineminus">-    if (!ical) {</span>
<a href="#l7.2111"></a><span id="l7.2111" class="difflineplus">+                        calIIcalComponent **component) {</span>
<a href="#l7.2112"></a><span id="l7.2112" class="difflineplus">+  NS_ENSURE_ARG_POINTER(component);</span>
<a href="#l7.2113"></a><span id="l7.2113" class="difflineplus">+  icalcomponent *ical =</span>
<a href="#l7.2114"></a><span id="l7.2114" class="difflineplus">+      icalparser_parse_string(PromiseFlatCString(serialized).get());</span>
<a href="#l7.2115"></a><span id="l7.2115" class="difflineplus">+  if (!ical) {</span>
<a href="#l7.2116"></a><span id="l7.2116"> #ifdef DEBUG</span>
<a href="#l7.2117"></a><span id="l7.2117" class="difflineminus">-        fprintf(stderr, &quot;Error parsing: '%20s': %d (%s)\n&quot;,</span>
<a href="#l7.2118"></a><span id="l7.2118" class="difflineminus">-                PromiseFlatCString(serialized).get(), icalerrno,</span>
<a href="#l7.2119"></a><span id="l7.2119" class="difflineminus">-                icalerror_strerror(icalerrno));</span>
<a href="#l7.2120"></a><span id="l7.2120" class="difflineplus">+    fprintf(stderr, &quot;Error parsing: '%20s': %d (%s)\n&quot;,</span>
<a href="#l7.2121"></a><span id="l7.2121" class="difflineplus">+            PromiseFlatCString(serialized).get(), icalerrno,</span>
<a href="#l7.2122"></a><span id="l7.2122" class="difflineplus">+            icalerror_strerror(icalerrno));</span>
<a href="#l7.2123"></a><span id="l7.2123"> #endif</span>
<a href="#l7.2124"></a><span id="l7.2124" class="difflineminus">-        // The return values is calIError match with ical errors,</span>
<a href="#l7.2125"></a><span id="l7.2125" class="difflineminus">-        // so no need for a conversion table or anything.</span>
<a href="#l7.2126"></a><span id="l7.2126" class="difflineminus">-        return static_cast&lt;nsresult&gt;(calIErrors::ICS_ERROR_BASE + icalerrno);</span>
<a href="#l7.2127"></a><span id="l7.2127" class="difflineminus">-    }</span>
<a href="#l7.2128"></a><span id="l7.2128" class="difflineminus">-    calIcalComponent *comp = new calIcalComponent(ical, nullptr, tzProvider);</span>
<a href="#l7.2129"></a><span id="l7.2129" class="difflineminus">-    if (!comp) {</span>
<a href="#l7.2130"></a><span id="l7.2130" class="difflineminus">-        icalcomponent_free(ical);</span>
<a href="#l7.2131"></a><span id="l7.2131" class="difflineminus">-        return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l7.2132"></a><span id="l7.2132" class="difflineminus">-    }</span>
<a href="#l7.2133"></a><span id="l7.2133" class="difflineminus">-    NS_ADDREF(*component = comp);</span>
<a href="#l7.2134"></a><span id="l7.2134" class="difflineminus">-    return NS_OK;</span>
<a href="#l7.2135"></a><span id="l7.2135" class="difflineplus">+    // The return values is calIError match with ical errors,</span>
<a href="#l7.2136"></a><span id="l7.2136" class="difflineplus">+    // so no need for a conversion table or anything.</span>
<a href="#l7.2137"></a><span id="l7.2137" class="difflineplus">+    return static_cast&lt;nsresult&gt;(calIErrors::ICS_ERROR_BASE + icalerrno);</span>
<a href="#l7.2138"></a><span id="l7.2138" class="difflineplus">+  }</span>
<a href="#l7.2139"></a><span id="l7.2139" class="difflineplus">+  calIcalComponent *comp = new calIcalComponent(ical, nullptr, tzProvider);</span>
<a href="#l7.2140"></a><span id="l7.2140" class="difflineplus">+  if (!comp) {</span>
<a href="#l7.2141"></a><span id="l7.2141" class="difflineplus">+    icalcomponent_free(ical);</span>
<a href="#l7.2142"></a><span id="l7.2142" class="difflineplus">+    return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l7.2143"></a><span id="l7.2143" class="difflineplus">+  }</span>
<a href="#l7.2144"></a><span id="l7.2144" class="difflineplus">+  NS_ADDREF(*component = comp);</span>
<a href="#l7.2145"></a><span id="l7.2145" class="difflineplus">+  return NS_OK;</span>
<a href="#l7.2146"></a><span id="l7.2146"> }</span>
<a href="#l7.2147"></a><span id="l7.2147"> </span>
<a href="#l7.2148"></a><span id="l7.2148"> NS_IMETHODIMP</span>
<a href="#l7.2149"></a><span id="l7.2149" class="difflineminus">-calICSService::ParserWorker::Run()</span>
<a href="#l7.2150"></a><span id="l7.2150" class="difflineminus">-{</span>
<a href="#l7.2151"></a><span id="l7.2151" class="difflineminus">-    icalcomponent *ical = icalparser_parse_string(mString.get());</span>
<a href="#l7.2152"></a><span id="l7.2152" class="difflineminus">-    nsresult status = NS_OK;</span>
<a href="#l7.2153"></a><span id="l7.2153" class="difflineminus">-    calIIcalComponent *comp = nullptr;</span>
<a href="#l7.2154"></a><span id="l7.2154" class="difflineplus">+calICSService::ParserWorker::Run() {</span>
<a href="#l7.2155"></a><span id="l7.2155" class="difflineplus">+  icalcomponent *ical = icalparser_parse_string(mString.get());</span>
<a href="#l7.2156"></a><span id="l7.2156" class="difflineplus">+  nsresult status = NS_OK;</span>
<a href="#l7.2157"></a><span id="l7.2157" class="difflineplus">+  calIIcalComponent *comp = nullptr;</span>
<a href="#l7.2158"></a><span id="l7.2158"> </span>
<a href="#l7.2159"></a><span id="l7.2159" class="difflineminus">-    if (ical) {</span>
<a href="#l7.2160"></a><span id="l7.2160" class="difflineminus">-        comp = new calIcalComponent(ical, nullptr, mProvider);</span>
<a href="#l7.2161"></a><span id="l7.2161" class="difflineminus">-        if (!comp) {</span>
<a href="#l7.2162"></a><span id="l7.2162" class="difflineminus">-            icalcomponent_free(ical);</span>
<a href="#l7.2163"></a><span id="l7.2163" class="difflineminus">-            status = NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l7.2164"></a><span id="l7.2164" class="difflineminus">-        }</span>
<a href="#l7.2165"></a><span id="l7.2165" class="difflineminus">-    } else {</span>
<a href="#l7.2166"></a><span id="l7.2166" class="difflineminus">-        status = static_cast&lt;nsresult&gt;(calIErrors::ICS_ERROR_BASE + icalerrno);</span>
<a href="#l7.2167"></a><span id="l7.2167" class="difflineplus">+  if (ical) {</span>
<a href="#l7.2168"></a><span id="l7.2168" class="difflineplus">+    comp = new calIcalComponent(ical, nullptr, mProvider);</span>
<a href="#l7.2169"></a><span id="l7.2169" class="difflineplus">+    if (!comp) {</span>
<a href="#l7.2170"></a><span id="l7.2170" class="difflineplus">+      icalcomponent_free(ical);</span>
<a href="#l7.2171"></a><span id="l7.2171" class="difflineplus">+      status = NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l7.2172"></a><span id="l7.2172">     }</span>
<a href="#l7.2173"></a><span id="l7.2173" class="difflineplus">+  } else {</span>
<a href="#l7.2174"></a><span id="l7.2174" class="difflineplus">+    status = static_cast&lt;nsresult&gt;(calIErrors::ICS_ERROR_BASE + icalerrno);</span>
<a href="#l7.2175"></a><span id="l7.2175" class="difflineplus">+  }</span>
<a href="#l7.2176"></a><span id="l7.2176"> </span>
<a href="#l7.2177"></a><span id="l7.2177" class="difflineminus">-    nsCOMPtr&lt;nsIRunnable&gt; completer = new ParserWorkerCompleter(mWorkerThread, status,</span>
<a href="#l7.2178"></a><span id="l7.2178" class="difflineminus">-                                                                comp, mListener);</span>
<a href="#l7.2179"></a><span id="l7.2179" class="difflineminus">-    mMainThread-&gt;Dispatch(completer, NS_DISPATCH_NORMAL);</span>
<a href="#l7.2180"></a><span id="l7.2180" class="difflineplus">+  nsCOMPtr&lt;nsIRunnable&gt; completer =</span>
<a href="#l7.2181"></a><span id="l7.2181" class="difflineplus">+      new ParserWorkerCompleter(mWorkerThread, status, comp, mListener);</span>
<a href="#l7.2182"></a><span id="l7.2182" class="difflineplus">+  mMainThread-&gt;Dispatch(completer, NS_DISPATCH_NORMAL);</span>
<a href="#l7.2183"></a><span id="l7.2183"> </span>
<a href="#l7.2184"></a><span id="l7.2184" class="difflineminus">-    mWorkerThread = nullptr;</span>
<a href="#l7.2185"></a><span id="l7.2185" class="difflineminus">-    mMainThread = nullptr;</span>
<a href="#l7.2186"></a><span id="l7.2186" class="difflineminus">-    return NS_OK;</span>
<a href="#l7.2187"></a><span id="l7.2187" class="difflineplus">+  mWorkerThread = nullptr;</span>
<a href="#l7.2188"></a><span id="l7.2188" class="difflineplus">+  mMainThread = nullptr;</span>
<a href="#l7.2189"></a><span id="l7.2189" class="difflineplus">+  return NS_OK;</span>
<a href="#l7.2190"></a><span id="l7.2190"> }</span>
<a href="#l7.2191"></a><span id="l7.2191"> </span>
<a href="#l7.2192"></a><span id="l7.2192"> NS_IMETHODIMP</span>
<a href="#l7.2193"></a><span id="l7.2193" class="difflineminus">-calICSService::ParserWorker::ParserWorkerCompleter::Run()</span>
<a href="#l7.2194"></a><span id="l7.2194" class="difflineminus">-{</span>
<a href="#l7.2195"></a><span id="l7.2195" class="difflineminus">-    mListener-&gt;OnParsingComplete(mStatus, mComp);</span>
<a href="#l7.2196"></a><span id="l7.2196" class="difflineplus">+calICSService::ParserWorker::ParserWorkerCompleter::Run() {</span>
<a href="#l7.2197"></a><span id="l7.2197" class="difflineplus">+  mListener-&gt;OnParsingComplete(mStatus, mComp);</span>
<a href="#l7.2198"></a><span id="l7.2198"> </span>
<a href="#l7.2199"></a><span id="l7.2199" class="difflineminus">-    nsresult rv = mWorkerThread-&gt;Shutdown();</span>
<a href="#l7.2200"></a><span id="l7.2200" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.2201"></a><span id="l7.2201" class="difflineplus">+  nsresult rv = mWorkerThread-&gt;Shutdown();</span>
<a href="#l7.2202"></a><span id="l7.2202" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.2203"></a><span id="l7.2203"> </span>
<a href="#l7.2204"></a><span id="l7.2204" class="difflineminus">-    mWorkerThread = nullptr;</span>
<a href="#l7.2205"></a><span id="l7.2205" class="difflineminus">-    return NS_OK;</span>
<a href="#l7.2206"></a><span id="l7.2206" class="difflineplus">+  mWorkerThread = nullptr;</span>
<a href="#l7.2207"></a><span id="l7.2207" class="difflineplus">+  return NS_OK;</span>
<a href="#l7.2208"></a><span id="l7.2208"> }</span>
<a href="#l7.2209"></a><span id="l7.2209"> </span>
<a href="#l7.2210"></a><span id="l7.2210"> NS_IMETHODIMP</span>
<a href="#l7.2211"></a><span id="l7.2211" class="difflineminus">-calICSService::ParseICSAsync(const nsACString&amp; serialized,</span>
<a href="#l7.2212"></a><span id="l7.2212" class="difflineplus">+calICSService::ParseICSAsync(const nsACString &amp;serialized,</span>
<a href="#l7.2213"></a><span id="l7.2213">                              calITimezoneProvider *tzProvider,</span>
<a href="#l7.2214"></a><span id="l7.2214" class="difflineminus">-                             calIIcsComponentParsingListener *listener)</span>
<a href="#l7.2215"></a><span id="l7.2215" class="difflineminus">-{</span>
<a href="#l7.2216"></a><span id="l7.2216" class="difflineminus">-    nsresult rv;</span>
<a href="#l7.2217"></a><span id="l7.2217" class="difflineminus">-    NS_ENSURE_ARG_POINTER(listener);</span>
<a href="#l7.2218"></a><span id="l7.2218" class="difflineplus">+                             calIIcsComponentParsingListener *listener) {</span>
<a href="#l7.2219"></a><span id="l7.2219" class="difflineplus">+  nsresult rv;</span>
<a href="#l7.2220"></a><span id="l7.2220" class="difflineplus">+  NS_ENSURE_ARG_POINTER(listener);</span>
<a href="#l7.2221"></a><span id="l7.2221"> </span>
<a href="#l7.2222"></a><span id="l7.2222" class="difflineminus">-    nsCOMPtr&lt;nsIThread&gt; workerThread;</span>
<a href="#l7.2223"></a><span id="l7.2223" class="difflineminus">-    nsCOMPtr&lt;nsIThread&gt; currentThread;</span>
<a href="#l7.2224"></a><span id="l7.2224" class="difflineminus">-    rv = NS_GetCurrentThread(getter_AddRefs(currentThread));</span>
<a href="#l7.2225"></a><span id="l7.2225" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.2226"></a><span id="l7.2226" class="difflineminus">-    rv = NS_NewThread(getter_AddRefs(workerThread));</span>
<a href="#l7.2227"></a><span id="l7.2227" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.2228"></a><span id="l7.2228" class="difflineplus">+  nsCOMPtr&lt;nsIThread&gt; workerThread;</span>
<a href="#l7.2229"></a><span id="l7.2229" class="difflineplus">+  nsCOMPtr&lt;nsIThread&gt; currentThread;</span>
<a href="#l7.2230"></a><span id="l7.2230" class="difflineplus">+  rv = NS_GetCurrentThread(getter_AddRefs(currentThread));</span>
<a href="#l7.2231"></a><span id="l7.2231" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.2232"></a><span id="l7.2232" class="difflineplus">+  rv = NS_NewThread(getter_AddRefs(workerThread));</span>
<a href="#l7.2233"></a><span id="l7.2233" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.2234"></a><span id="l7.2234"> </span>
<a href="#l7.2235"></a><span id="l7.2235" class="difflineminus">-    nsCOMPtr&lt;nsIRunnable&gt; worker = new ParserWorker(currentThread, workerThread,</span>
<a href="#l7.2236"></a><span id="l7.2236" class="difflineminus">-                                                    serialized, tzProvider, listener);</span>
<a href="#l7.2237"></a><span id="l7.2237" class="difflineminus">-    NS_ENSURE_TRUE(worker, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l7.2238"></a><span id="l7.2238" class="difflineplus">+  nsCOMPtr&lt;nsIRunnable&gt; worker = new ParserWorker(</span>
<a href="#l7.2239"></a><span id="l7.2239" class="difflineplus">+      currentThread, workerThread, serialized, tzProvider, listener);</span>
<a href="#l7.2240"></a><span id="l7.2240" class="difflineplus">+  NS_ENSURE_TRUE(worker, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l7.2241"></a><span id="l7.2241"> </span>
<a href="#l7.2242"></a><span id="l7.2242" class="difflineminus">-    rv = workerThread-&gt;Dispatch(worker, NS_DISPATCH_NORMAL);</span>
<a href="#l7.2243"></a><span id="l7.2243" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.2244"></a><span id="l7.2244" class="difflineplus">+  rv = workerThread-&gt;Dispatch(worker, NS_DISPATCH_NORMAL);</span>
<a href="#l7.2245"></a><span id="l7.2245" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.2246"></a><span id="l7.2246"> </span>
<a href="#l7.2247"></a><span id="l7.2247" class="difflineminus">-    return NS_OK;</span>
<a href="#l7.2248"></a><span id="l7.2248" class="difflineplus">+  return NS_OK;</span>
<a href="#l7.2249"></a><span id="l7.2249"> }</span>
<a href="#l7.2250"></a><span id="l7.2250"> </span>
<a href="#l7.2251"></a><span id="l7.2251"> NS_IMETHODIMP</span>
<a href="#l7.2252"></a><span id="l7.2252" class="difflineminus">-calICSService::CreateIcalComponent(const nsACString &amp;kind, calIIcalComponent **comp)</span>
<a href="#l7.2253"></a><span id="l7.2253" class="difflineminus">-{</span>
<a href="#l7.2254"></a><span id="l7.2254" class="difflineminus">-    NS_ENSURE_ARG_POINTER(comp);</span>
<a href="#l7.2255"></a><span id="l7.2255" class="difflineminus">-    icalcomponent_kind compkind =</span>
<a href="#l7.2256"></a><span id="l7.2256" class="difflineminus">-        icalcomponent_string_to_kind(PromiseFlatCString(kind).get());</span>
<a href="#l7.2257"></a><span id="l7.2257" class="difflineplus">+calICSService::CreateIcalComponent(const nsACString &amp;kind,</span>
<a href="#l7.2258"></a><span id="l7.2258" class="difflineplus">+                                   calIIcalComponent **comp) {</span>
<a href="#l7.2259"></a><span id="l7.2259" class="difflineplus">+  NS_ENSURE_ARG_POINTER(comp);</span>
<a href="#l7.2260"></a><span id="l7.2260" class="difflineplus">+  icalcomponent_kind compkind =</span>
<a href="#l7.2261"></a><span id="l7.2261" class="difflineplus">+      icalcomponent_string_to_kind(PromiseFlatCString(kind).get());</span>
<a href="#l7.2262"></a><span id="l7.2262"> </span>
<a href="#l7.2263"></a><span id="l7.2263" class="difflineminus">-    // Maybe someday I'll support X-COMPONENTs</span>
<a href="#l7.2264"></a><span id="l7.2264" class="difflineminus">-    if (compkind == ICAL_NO_COMPONENT || compkind == ICAL_X_COMPONENT)</span>
<a href="#l7.2265"></a><span id="l7.2265" class="difflineminus">-        return NS_ERROR_INVALID_ARG;</span>
<a href="#l7.2266"></a><span id="l7.2266" class="difflineplus">+  // Maybe someday I'll support X-COMPONENTs</span>
<a href="#l7.2267"></a><span id="l7.2267" class="difflineplus">+  if (compkind == ICAL_NO_COMPONENT || compkind == ICAL_X_COMPONENT)</span>
<a href="#l7.2268"></a><span id="l7.2268" class="difflineplus">+    return NS_ERROR_INVALID_ARG;</span>
<a href="#l7.2269"></a><span id="l7.2269"> </span>
<a href="#l7.2270"></a><span id="l7.2270" class="difflineminus">-    icalcomponent *ical = icalcomponent_new(compkind);</span>
<a href="#l7.2271"></a><span id="l7.2271" class="difflineminus">-    if (!ical)</span>
<a href="#l7.2272"></a><span id="l7.2272" class="difflineminus">-        return NS_ERROR_OUT_OF_MEMORY; // XXX translate</span>
<a href="#l7.2273"></a><span id="l7.2273" class="difflineplus">+  icalcomponent *ical = icalcomponent_new(compkind);</span>
<a href="#l7.2274"></a><span id="l7.2274" class="difflineplus">+  if (!ical) return NS_ERROR_OUT_OF_MEMORY;  // XXX translate</span>
<a href="#l7.2275"></a><span id="l7.2275"> </span>
<a href="#l7.2276"></a><span id="l7.2276" class="difflineminus">-    *comp = new calIcalComponent(ical, nullptr);</span>
<a href="#l7.2277"></a><span id="l7.2277" class="difflineminus">-    if (!*comp) {</span>
<a href="#l7.2278"></a><span id="l7.2278" class="difflineminus">-        icalcomponent_free(ical);</span>
<a href="#l7.2279"></a><span id="l7.2279" class="difflineminus">-        return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l7.2280"></a><span id="l7.2280" class="difflineminus">-    }</span>
<a href="#l7.2281"></a><span id="l7.2281" class="difflineplus">+  *comp = new calIcalComponent(ical, nullptr);</span>
<a href="#l7.2282"></a><span id="l7.2282" class="difflineplus">+  if (!*comp) {</span>
<a href="#l7.2283"></a><span id="l7.2283" class="difflineplus">+    icalcomponent_free(ical);</span>
<a href="#l7.2284"></a><span id="l7.2284" class="difflineplus">+    return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l7.2285"></a><span id="l7.2285" class="difflineplus">+  }</span>
<a href="#l7.2286"></a><span id="l7.2286"> </span>
<a href="#l7.2287"></a><span id="l7.2287" class="difflineminus">-    NS_ADDREF(*comp);</span>
<a href="#l7.2288"></a><span id="l7.2288" class="difflineminus">-    return NS_OK;</span>
<a href="#l7.2289"></a><span id="l7.2289" class="difflineplus">+  NS_ADDREF(*comp);</span>
<a href="#l7.2290"></a><span id="l7.2290" class="difflineplus">+  return NS_OK;</span>
<a href="#l7.2291"></a><span id="l7.2291"> }</span>
<a href="#l7.2292"></a><span id="l7.2292"> </span>
<a href="#l7.2293"></a><span id="l7.2293"> NS_IMETHODIMP</span>
<a href="#l7.2294"></a><span id="l7.2294" class="difflineminus">-calICSService::CreateIcalProperty(const nsACString &amp;kind, calIIcalProperty **prop)</span>
<a href="#l7.2295"></a><span id="l7.2295" class="difflineminus">-{</span>
<a href="#l7.2296"></a><span id="l7.2296" class="difflineminus">-    NS_ENSURE_ARG_POINTER(prop);</span>
<a href="#l7.2297"></a><span id="l7.2297" class="difflineminus">-    icalproperty_kind propkind =</span>
<a href="#l7.2298"></a><span id="l7.2298" class="difflineminus">-        icalproperty_string_to_kind(PromiseFlatCString(kind).get());</span>
<a href="#l7.2299"></a><span id="l7.2299" class="difflineplus">+calICSService::CreateIcalProperty(const nsACString &amp;kind,</span>
<a href="#l7.2300"></a><span id="l7.2300" class="difflineplus">+                                  calIIcalProperty **prop) {</span>
<a href="#l7.2301"></a><span id="l7.2301" class="difflineplus">+  NS_ENSURE_ARG_POINTER(prop);</span>
<a href="#l7.2302"></a><span id="l7.2302" class="difflineplus">+  icalproperty_kind propkind =</span>
<a href="#l7.2303"></a><span id="l7.2303" class="difflineplus">+      icalproperty_string_to_kind(PromiseFlatCString(kind).get());</span>
<a href="#l7.2304"></a><span id="l7.2304"> </span>
<a href="#l7.2305"></a><span id="l7.2305" class="difflineminus">-    if (propkind == ICAL_NO_PROPERTY)</span>
<a href="#l7.2306"></a><span id="l7.2306" class="difflineminus">-        return NS_ERROR_INVALID_ARG;</span>
<a href="#l7.2307"></a><span id="l7.2307" class="difflineplus">+  if (propkind == ICAL_NO_PROPERTY) return NS_ERROR_INVALID_ARG;</span>
<a href="#l7.2308"></a><span id="l7.2308"> </span>
<a href="#l7.2309"></a><span id="l7.2309" class="difflineminus">-    icalproperty *icalprop = icalproperty_new(propkind);</span>
<a href="#l7.2310"></a><span id="l7.2310" class="difflineminus">-    if (!icalprop)</span>
<a href="#l7.2311"></a><span id="l7.2311" class="difflineminus">-        return NS_ERROR_OUT_OF_MEMORY; // XXX translate</span>
<a href="#l7.2312"></a><span id="l7.2312" class="difflineplus">+  icalproperty *icalprop = icalproperty_new(propkind);</span>
<a href="#l7.2313"></a><span id="l7.2313" class="difflineplus">+  if (!icalprop) return NS_ERROR_OUT_OF_MEMORY;  // XXX translate</span>
<a href="#l7.2314"></a><span id="l7.2314"> </span>
<a href="#l7.2315"></a><span id="l7.2315" class="difflineminus">-    if (propkind == ICAL_X_PROPERTY)</span>
<a href="#l7.2316"></a><span id="l7.2316" class="difflineminus">-        icalproperty_set_x_name(icalprop, PromiseFlatCString(kind).get());</span>
<a href="#l7.2317"></a><span id="l7.2317" class="difflineplus">+  if (propkind == ICAL_X_PROPERTY)</span>
<a href="#l7.2318"></a><span id="l7.2318" class="difflineplus">+    icalproperty_set_x_name(icalprop, PromiseFlatCString(kind).get());</span>
<a href="#l7.2319"></a><span id="l7.2319"> </span>
<a href="#l7.2320"></a><span id="l7.2320" class="difflineminus">-    *prop = new calIcalProperty(icalprop, nullptr);</span>
<a href="#l7.2321"></a><span id="l7.2321" class="difflineminus">-    CAL_ENSURE_MEMORY(*prop);</span>
<a href="#l7.2322"></a><span id="l7.2322" class="difflineminus">-    NS_ADDREF(*prop);</span>
<a href="#l7.2323"></a><span id="l7.2323" class="difflineminus">-    return NS_OK;</span>
<a href="#l7.2324"></a><span id="l7.2324" class="difflineplus">+  *prop = new calIcalProperty(icalprop, nullptr);</span>
<a href="#l7.2325"></a><span id="l7.2325" class="difflineplus">+  CAL_ENSURE_MEMORY(*prop);</span>
<a href="#l7.2326"></a><span id="l7.2326" class="difflineplus">+  NS_ADDREF(*prop);</span>
<a href="#l7.2327"></a><span id="l7.2327" class="difflineplus">+  return NS_OK;</span>
<a href="#l7.2328"></a><span id="l7.2328"> }</span>
<a href="#l7.2329"></a><span id="l7.2329"> </span>
<a href="#l7.2330"></a><span id="l7.2330"> NS_IMETHODIMP</span>
<a href="#l7.2331"></a><span id="l7.2331" class="difflineminus">-calICSService::CreateIcalPropertyFromString(const nsACString &amp;str, calIIcalProperty **prop)</span>
<a href="#l7.2332"></a><span id="l7.2332" class="difflineminus">-{</span>
<a href="#l7.2333"></a><span id="l7.2333" class="difflineminus">-    NS_ENSURE_ARG_POINTER(prop);</span>
<a href="#l7.2334"></a><span id="l7.2334" class="difflineminus">-</span>
<a href="#l7.2335"></a><span id="l7.2335" class="difflineminus">-    icalproperty *icalprop = icalproperty_new_from_string(PromiseFlatCString(str).get());</span>
<a href="#l7.2336"></a><span id="l7.2336" class="difflineplus">+calICSService::CreateIcalPropertyFromString(const nsACString &amp;str,</span>
<a href="#l7.2337"></a><span id="l7.2337" class="difflineplus">+                                            calIIcalProperty **prop) {</span>
<a href="#l7.2338"></a><span id="l7.2338" class="difflineplus">+  NS_ENSURE_ARG_POINTER(prop);</span>
<a href="#l7.2339"></a><span id="l7.2339"> </span>
<a href="#l7.2340"></a><span id="l7.2340" class="difflineminus">-    *prop = new calIcalProperty(icalprop, nullptr);</span>
<a href="#l7.2341"></a><span id="l7.2341" class="difflineminus">-    CAL_ENSURE_MEMORY(*prop);</span>
<a href="#l7.2342"></a><span id="l7.2342" class="difflineminus">-    NS_ADDREF(*prop);</span>
<a href="#l7.2343"></a><span id="l7.2343" class="difflineminus">-    return NS_OK;</span>
<a href="#l7.2344"></a><span id="l7.2344" class="difflineplus">+  icalproperty *icalprop =</span>
<a href="#l7.2345"></a><span id="l7.2345" class="difflineplus">+      icalproperty_new_from_string(PromiseFlatCString(str).get());</span>
<a href="#l7.2346"></a><span id="l7.2346" class="difflineplus">+</span>
<a href="#l7.2347"></a><span id="l7.2347" class="difflineplus">+  *prop = new calIcalProperty(icalprop, nullptr);</span>
<a href="#l7.2348"></a><span id="l7.2348" class="difflineplus">+  CAL_ENSURE_MEMORY(*prop);</span>
<a href="#l7.2349"></a><span id="l7.2349" class="difflineplus">+  NS_ADDREF(*prop);</span>
<a href="#l7.2350"></a><span id="l7.2350" class="difflineplus">+  return NS_OK;</span>
<a href="#l7.2351"></a><span id="l7.2351"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/calendar/base/backend/libical/calICSService.h</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/calendar/base/backend/libical/calICSService.h</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -1,180 +1,178 @@</span>
<a href="#l8.4"></a><span id="l8.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l8.5"></a><span id="l8.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l8.6"></a><span id="l8.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l8.7"></a><span id="l8.7"> #if !defined(INCLUDED_CALICSSERVICE_H)</span>
<a href="#l8.8"></a><span id="l8.8" class="difflineminus">-#define INCLUDED_CALICSSERVICE_H</span>
<a href="#l8.9"></a><span id="l8.9" class="difflineplus">+#  define INCLUDED_CALICSSERVICE_H</span>
<a href="#l8.10"></a><span id="l8.10"> </span>
<a href="#l8.11"></a><span id="l8.11" class="difflineminus">-#include &quot;nsCOMPtr.h&quot;</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-#include &quot;calIICSService.h&quot;</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineminus">-#include &quot;calITimezoneProvider.h&quot;</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineminus">-#include &quot;nsInterfaceHashtable.h&quot;</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineminus">-#include &quot;nsProxyRelease.h&quot;</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineminus">-#include &quot;nsThreadUtils.h&quot;</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineminus">-#include &quot;calUtils.h&quot;</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineplus">+#  include &quot;nsCOMPtr.h&quot;</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineplus">+#  include &quot;calIICSService.h&quot;</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineplus">+#  include &quot;calITimezoneProvider.h&quot;</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineplus">+#  include &quot;nsInterfaceHashtable.h&quot;</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineplus">+#  include &quot;nsProxyRelease.h&quot;</span>
<a href="#l8.23"></a><span id="l8.23" class="difflineplus">+#  include &quot;nsThreadUtils.h&quot;</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineplus">+#  include &quot;calUtils.h&quot;</span>
<a href="#l8.25"></a><span id="l8.25"> </span>
<a href="#l8.26"></a><span id="l8.26"> extern &quot;C&quot; {</span>
<a href="#l8.27"></a><span id="l8.27" class="difflineminus">-#include &quot;ical.h&quot;</span>
<a href="#l8.28"></a><span id="l8.28" class="difflineplus">+#  include &quot;ical.h&quot;</span>
<a href="#l8.29"></a><span id="l8.29"> }</span>
<a href="#l8.30"></a><span id="l8.30"> </span>
<a href="#l8.31"></a><span id="l8.31" class="difflineminus">-class calICSService : public calIICSService,</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineminus">-                      public cal::XpcomBase</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineminus">-{</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineminus">-protected:</span>
<a href="#l8.35"></a><span id="l8.35" class="difflineminus">-    virtual ~calICSService() {}</span>
<a href="#l8.36"></a><span id="l8.36" class="difflineminus">-    class ParserWorker : public mozilla::Runnable {</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineminus">-    public:</span>
<a href="#l8.38"></a><span id="l8.38" class="difflineminus">-      ParserWorker(nsIThread *mainThread,</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineminus">-                   nsIThread *workerThread,</span>
<a href="#l8.40"></a><span id="l8.40" class="difflineminus">-                   const nsACString &amp;icsString,</span>
<a href="#l8.41"></a><span id="l8.41" class="difflineminus">-                   calITimezoneProvider *tzProvider,</span>
<a href="#l8.42"></a><span id="l8.42" class="difflineminus">-                   calIIcsComponentParsingListener *listener) :</span>
<a href="#l8.43"></a><span id="l8.43" class="difflineminus">-        mozilla::Runnable(&quot;ParserWorker&quot;),</span>
<a href="#l8.44"></a><span id="l8.44" class="difflineminus">-        mString(icsString), mProvider(tzProvider),</span>
<a href="#l8.45"></a><span id="l8.45" class="difflineminus">-        mMainThread(mainThread), mWorkerThread(workerThread)</span>
<a href="#l8.46"></a><span id="l8.46" class="difflineminus">-      {</span>
<a href="#l8.47"></a><span id="l8.47" class="difflineminus">-        mListener = new nsMainThreadPtrHolder&lt;calIIcsComponentParsingListener&gt;(&quot;calICSService::mListener&quot;, listener);</span>
<a href="#l8.48"></a><span id="l8.48" class="difflineminus">-      }</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineplus">+class calICSService : public calIICSService, public cal::XpcomBase {</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineplus">+ protected:</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineplus">+  virtual ~calICSService() {}</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineplus">+  class ParserWorker : public mozilla::Runnable {</span>
<a href="#l8.53"></a><span id="l8.53" class="difflineplus">+   public:</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineplus">+    ParserWorker(nsIThread *mainThread, nsIThread *workerThread,</span>
<a href="#l8.55"></a><span id="l8.55" class="difflineplus">+                 const nsACString &amp;icsString, calITimezoneProvider *tzProvider,</span>
<a href="#l8.56"></a><span id="l8.56" class="difflineplus">+                 calIIcsComponentParsingListener *listener)</span>
<a href="#l8.57"></a><span id="l8.57" class="difflineplus">+        : mozilla::Runnable(&quot;ParserWorker&quot;),</span>
<a href="#l8.58"></a><span id="l8.58" class="difflineplus">+          mString(icsString),</span>
<a href="#l8.59"></a><span id="l8.59" class="difflineplus">+          mProvider(tzProvider),</span>
<a href="#l8.60"></a><span id="l8.60" class="difflineplus">+          mMainThread(mainThread),</span>
<a href="#l8.61"></a><span id="l8.61" class="difflineplus">+          mWorkerThread(workerThread) {</span>
<a href="#l8.62"></a><span id="l8.62" class="difflineplus">+      mListener = new nsMainThreadPtrHolder&lt;calIIcsComponentParsingListener&gt;(</span>
<a href="#l8.63"></a><span id="l8.63" class="difflineplus">+          &quot;calICSService::mListener&quot;, listener);</span>
<a href="#l8.64"></a><span id="l8.64" class="difflineplus">+    }</span>
<a href="#l8.65"></a><span id="l8.65" class="difflineplus">+</span>
<a href="#l8.66"></a><span id="l8.66" class="difflineplus">+    NS_DECL_NSIRUNNABLE</span>
<a href="#l8.67"></a><span id="l8.67" class="difflineplus">+</span>
<a href="#l8.68"></a><span id="l8.68" class="difflineplus">+   protected:</span>
<a href="#l8.69"></a><span id="l8.69" class="difflineplus">+    nsCString mString;</span>
<a href="#l8.70"></a><span id="l8.70" class="difflineplus">+    nsCOMPtr&lt;calITimezoneProvider&gt; mProvider;</span>
<a href="#l8.71"></a><span id="l8.71" class="difflineplus">+    nsMainThreadPtrHandle&lt;calIIcsComponentParsingListener&gt; mListener;</span>
<a href="#l8.72"></a><span id="l8.72" class="difflineplus">+    nsCOMPtr&lt;nsIThread&gt; mMainThread;</span>
<a href="#l8.73"></a><span id="l8.73" class="difflineplus">+    nsCOMPtr&lt;nsIThread&gt; mWorkerThread;</span>
<a href="#l8.74"></a><span id="l8.74" class="difflineplus">+</span>
<a href="#l8.75"></a><span id="l8.75" class="difflineplus">+    class ParserWorkerCompleter : public mozilla::Runnable {</span>
<a href="#l8.76"></a><span id="l8.76" class="difflineplus">+     public:</span>
<a href="#l8.77"></a><span id="l8.77" class="difflineplus">+      ParserWorkerCompleter(</span>
<a href="#l8.78"></a><span id="l8.78" class="difflineplus">+          nsIThread *workerThread, nsresult status,</span>
<a href="#l8.79"></a><span id="l8.79" class="difflineplus">+          calIIcalComponent *component,</span>
<a href="#l8.80"></a><span id="l8.80" class="difflineplus">+          const nsMainThreadPtrHandle&lt;calIIcsComponentParsingListener&gt;</span>
<a href="#l8.81"></a><span id="l8.81" class="difflineplus">+              &amp;listener)</span>
<a href="#l8.82"></a><span id="l8.82" class="difflineplus">+          : mozilla::Runnable(&quot;ParserWorkerCompleter&quot;),</span>
<a href="#l8.83"></a><span id="l8.83" class="difflineplus">+            mWorkerThread(workerThread),</span>
<a href="#l8.84"></a><span id="l8.84" class="difflineplus">+            mListener(listener),</span>
<a href="#l8.85"></a><span id="l8.85" class="difflineplus">+            mComp(component),</span>
<a href="#l8.86"></a><span id="l8.86" class="difflineplus">+            mStatus(status) {}</span>
<a href="#l8.87"></a><span id="l8.87"> </span>
<a href="#l8.88"></a><span id="l8.88">       NS_DECL_NSIRUNNABLE</span>
<a href="#l8.89"></a><span id="l8.89" class="difflineminus">-</span>
<a href="#l8.90"></a><span id="l8.90" class="difflineminus">-    protected:</span>
<a href="#l8.91"></a><span id="l8.91" class="difflineminus">-      nsCString mString;</span>
<a href="#l8.92"></a><span id="l8.92" class="difflineminus">-      nsCOMPtr&lt;calITimezoneProvider&gt; mProvider;</span>
<a href="#l8.93"></a><span id="l8.93" class="difflineplus">+     protected:</span>
<a href="#l8.94"></a><span id="l8.94" class="difflineplus">+      nsCOMPtr&lt;nsIThread&gt; mWorkerThread;</span>
<a href="#l8.95"></a><span id="l8.95">       nsMainThreadPtrHandle&lt;calIIcsComponentParsingListener&gt; mListener;</span>
<a href="#l8.96"></a><span id="l8.96" class="difflineminus">-      nsCOMPtr&lt;nsIThread&gt; mMainThread;</span>
<a href="#l8.97"></a><span id="l8.97" class="difflineminus">-      nsCOMPtr&lt;nsIThread&gt; mWorkerThread;</span>
<a href="#l8.98"></a><span id="l8.98" class="difflineplus">+      nsCOMPtr&lt;calIIcalComponent&gt; mComp;</span>
<a href="#l8.99"></a><span id="l8.99" class="difflineplus">+      nsresult mStatus;</span>
<a href="#l8.100"></a><span id="l8.100" class="difflineplus">+    };</span>
<a href="#l8.101"></a><span id="l8.101" class="difflineplus">+  };</span>
<a href="#l8.102"></a><span id="l8.102"> </span>
<a href="#l8.103"></a><span id="l8.103" class="difflineminus">-      class ParserWorkerCompleter : public mozilla::Runnable {</span>
<a href="#l8.104"></a><span id="l8.104" class="difflineminus">-      public:</span>
<a href="#l8.105"></a><span id="l8.105" class="difflineminus">-        ParserWorkerCompleter(nsIThread *workerThread,</span>
<a href="#l8.106"></a><span id="l8.106" class="difflineminus">-                              nsresult status,</span>
<a href="#l8.107"></a><span id="l8.107" class="difflineminus">-                              calIIcalComponent *component,</span>
<a href="#l8.108"></a><span id="l8.108" class="difflineminus">-                              const nsMainThreadPtrHandle&lt;calIIcsComponentParsingListener&gt; &amp;listener) :</span>
<a href="#l8.109"></a><span id="l8.109" class="difflineminus">-          mozilla::Runnable(&quot;ParserWorkerCompleter&quot;),</span>
<a href="#l8.110"></a><span id="l8.110" class="difflineminus">-          mWorkerThread(workerThread), mListener(listener),</span>
<a href="#l8.111"></a><span id="l8.111" class="difflineminus">-          mComp(component), mStatus(status)</span>
<a href="#l8.112"></a><span id="l8.112" class="difflineminus">-        {</span>
<a href="#l8.113"></a><span id="l8.113" class="difflineminus">-        }</span>
<a href="#l8.114"></a><span id="l8.114" class="difflineplus">+ public:</span>
<a href="#l8.115"></a><span id="l8.115" class="difflineplus">+  calICSService();</span>
<a href="#l8.116"></a><span id="l8.116"> </span>
<a href="#l8.117"></a><span id="l8.117" class="difflineminus">-        NS_DECL_NSIRUNNABLE</span>
<a href="#l8.118"></a><span id="l8.118" class="difflineminus">-      protected:</span>
<a href="#l8.119"></a><span id="l8.119" class="difflineminus">-        nsCOMPtr&lt;nsIThread&gt; mWorkerThread;</span>
<a href="#l8.120"></a><span id="l8.120" class="difflineminus">-        nsMainThreadPtrHandle&lt;calIIcsComponentParsingListener&gt; mListener;</span>
<a href="#l8.121"></a><span id="l8.121" class="difflineminus">-        nsCOMPtr&lt;calIIcalComponent&gt; mComp;</span>
<a href="#l8.122"></a><span id="l8.122" class="difflineminus">-        nsresult mStatus;</span>
<a href="#l8.123"></a><span id="l8.123" class="difflineminus">-      };</span>
<a href="#l8.124"></a><span id="l8.124" class="difflineminus">-    };</span>
<a href="#l8.125"></a><span id="l8.125" class="difflineminus">-public:</span>
<a href="#l8.126"></a><span id="l8.126" class="difflineminus">-    calICSService();</span>
<a href="#l8.127"></a><span id="l8.127" class="difflineminus">-</span>
<a href="#l8.128"></a><span id="l8.128" class="difflineminus">-    NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l8.129"></a><span id="l8.129" class="difflineminus">-    NS_DECL_CALIICSSERVICE</span>
<a href="#l8.130"></a><span id="l8.130" class="difflineplus">+  NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l8.131"></a><span id="l8.131" class="difflineplus">+  NS_DECL_CALIICSSERVICE</span>
<a href="#l8.132"></a><span id="l8.132"> };</span>
<a href="#l8.133"></a><span id="l8.133"> </span>
<a href="#l8.134"></a><span id="l8.134"> class calIcalComponent;</span>
<a href="#l8.135"></a><span id="l8.135"> </span>
<a href="#l8.136"></a><span id="l8.136" class="difflineminus">-class calIcalProperty : public calIIcalPropertyLibical,</span>
<a href="#l8.137"></a><span id="l8.137" class="difflineminus">-                        public cal::XpcomBase</span>
<a href="#l8.138"></a><span id="l8.138" class="difflineminus">-{</span>
<a href="#l8.139"></a><span id="l8.139" class="difflineminus">-    friend class calIcalComponent;</span>
<a href="#l8.140"></a><span id="l8.140" class="difflineminus">-public:</span>
<a href="#l8.141"></a><span id="l8.141" class="difflineminus">-    calIcalProperty(icalproperty * prop, calIIcalComponentLibical * parent)</span>
<a href="#l8.142"></a><span id="l8.142" class="difflineminus">-        : mProperty(prop), mParent(parent) {}</span>
<a href="#l8.143"></a><span id="l8.143" class="difflineplus">+class calIcalProperty : public calIIcalPropertyLibical, public cal::XpcomBase {</span>
<a href="#l8.144"></a><span id="l8.144" class="difflineplus">+  friend class calIcalComponent;</span>
<a href="#l8.145"></a><span id="l8.145"> </span>
<a href="#l8.146"></a><span id="l8.146" class="difflineminus">-    NS_DECL_ISUPPORTS</span>
<a href="#l8.147"></a><span id="l8.147" class="difflineminus">-    NS_DECL_CALIICALPROPERTY</span>
<a href="#l8.148"></a><span id="l8.148" class="difflineminus">-    NS_DECL_CALIICALPROPERTYLIBICAL</span>
<a href="#l8.149"></a><span id="l8.149" class="difflineplus">+ public:</span>
<a href="#l8.150"></a><span id="l8.150" class="difflineplus">+  calIcalProperty(icalproperty *prop, calIIcalComponentLibical *parent)</span>
<a href="#l8.151"></a><span id="l8.151" class="difflineplus">+      : mProperty(prop), mParent(parent) {}</span>
<a href="#l8.152"></a><span id="l8.152" class="difflineplus">+</span>
<a href="#l8.153"></a><span id="l8.153" class="difflineplus">+  NS_DECL_ISUPPORTS</span>
<a href="#l8.154"></a><span id="l8.154" class="difflineplus">+  NS_DECL_CALIICALPROPERTY</span>
<a href="#l8.155"></a><span id="l8.155" class="difflineplus">+  NS_DECL_CALIICALPROPERTYLIBICAL</span>
<a href="#l8.156"></a><span id="l8.156"> </span>
<a href="#l8.157"></a><span id="l8.157" class="difflineminus">-protected:</span>
<a href="#l8.158"></a><span id="l8.158" class="difflineminus">-    virtual ~calIcalProperty();</span>
<a href="#l8.159"></a><span id="l8.159" class="difflineplus">+ protected:</span>
<a href="#l8.160"></a><span id="l8.160" class="difflineplus">+  virtual ~calIcalProperty();</span>
<a href="#l8.161"></a><span id="l8.161"> </span>
<a href="#l8.162"></a><span id="l8.162" class="difflineminus">-    static nsresult getDatetime_(calIcalComponent *parent,</span>
<a href="#l8.163"></a><span id="l8.163" class="difflineminus">-                                 icalproperty *prop,</span>
<a href="#l8.164"></a><span id="l8.164" class="difflineminus">-                                 calIDateTime **dtp);</span>
<a href="#l8.165"></a><span id="l8.165" class="difflineminus">-    static nsresult setDatetime_(calIcalComponent *parent,</span>
<a href="#l8.166"></a><span id="l8.166" class="difflineminus">-                                 icalproperty *prop,</span>
<a href="#l8.167"></a><span id="l8.167" class="difflineminus">-                                 calIDateTime *dt);</span>
<a href="#l8.168"></a><span id="l8.168" class="difflineplus">+  static nsresult getDatetime_(calIcalComponent *parent, icalproperty *prop,</span>
<a href="#l8.169"></a><span id="l8.169" class="difflineplus">+                               calIDateTime **dtp);</span>
<a href="#l8.170"></a><span id="l8.170" class="difflineplus">+  static nsresult setDatetime_(calIcalComponent *parent, icalproperty *prop,</span>
<a href="#l8.171"></a><span id="l8.171" class="difflineplus">+                               calIDateTime *dt);</span>
<a href="#l8.172"></a><span id="l8.172"> </span>
<a href="#l8.173"></a><span id="l8.173" class="difflineminus">-    icalproperty *                     mProperty;</span>
<a href="#l8.174"></a><span id="l8.174" class="difflineminus">-    nsCOMPtr&lt;calIIcalComponentLibical&gt; mParent;</span>
<a href="#l8.175"></a><span id="l8.175" class="difflineplus">+  icalproperty *mProperty;</span>
<a href="#l8.176"></a><span id="l8.176" class="difflineplus">+  nsCOMPtr&lt;calIIcalComponentLibical&gt; mParent;</span>
<a href="#l8.177"></a><span id="l8.177"> };</span>
<a href="#l8.178"></a><span id="l8.178"> </span>
<a href="#l8.179"></a><span id="l8.179"> class calIcalComponent : public calIIcalComponentLibical,</span>
<a href="#l8.180"></a><span id="l8.180" class="difflineminus">-                         public cal::XpcomBase</span>
<a href="#l8.181"></a><span id="l8.181" class="difflineminus">-{</span>
<a href="#l8.182"></a><span id="l8.182" class="difflineminus">-    friend class calIcalProperty;</span>
<a href="#l8.183"></a><span id="l8.183" class="difflineminus">-public:</span>
<a href="#l8.184"></a><span id="l8.184" class="difflineminus">-    calIcalComponent(icalcomponent *ical, calIIcalComponentLibical *parent,</span>
<a href="#l8.185"></a><span id="l8.185" class="difflineminus">-                     calITimezoneProvider *tzProvider = nullptr)</span>
<a href="#l8.186"></a><span id="l8.186" class="difflineminus">-        : mComponent(ical), mTimezone(nullptr), mTzProvider(tzProvider), mParent(parent)</span>
<a href="#l8.187"></a><span id="l8.187" class="difflineminus">-    {</span>
<a href="#l8.188"></a><span id="l8.188" class="difflineminus">-    }</span>
<a href="#l8.189"></a><span id="l8.189" class="difflineplus">+                         public cal::XpcomBase {</span>
<a href="#l8.190"></a><span id="l8.190" class="difflineplus">+  friend class calIcalProperty;</span>
<a href="#l8.191"></a><span id="l8.191"> </span>
<a href="#l8.192"></a><span id="l8.192" class="difflineminus">-    // VTIMEZONE ctor</span>
<a href="#l8.193"></a><span id="l8.193" class="difflineminus">-    calIcalComponent(icaltimezone * icaltz, icalcomponent * ical) : mComponent(ical), mTimezone(icaltz) {</span>
<a href="#l8.194"></a><span id="l8.194" class="difflineminus">-    }</span>
<a href="#l8.195"></a><span id="l8.195" class="difflineplus">+ public:</span>
<a href="#l8.196"></a><span id="l8.196" class="difflineplus">+  calIcalComponent(icalcomponent *ical, calIIcalComponentLibical *parent,</span>
<a href="#l8.197"></a><span id="l8.197" class="difflineplus">+                   calITimezoneProvider *tzProvider = nullptr)</span>
<a href="#l8.198"></a><span id="l8.198" class="difflineplus">+      : mComponent(ical),</span>
<a href="#l8.199"></a><span id="l8.199" class="difflineplus">+        mTimezone(nullptr),</span>
<a href="#l8.200"></a><span id="l8.200" class="difflineplus">+        mTzProvider(tzProvider),</span>
<a href="#l8.201"></a><span id="l8.201" class="difflineplus">+        mParent(parent) {}</span>
<a href="#l8.202"></a><span id="l8.202" class="difflineplus">+</span>
<a href="#l8.203"></a><span id="l8.203" class="difflineplus">+  // VTIMEZONE ctor</span>
<a href="#l8.204"></a><span id="l8.204" class="difflineplus">+  calIcalComponent(icaltimezone *icaltz, icalcomponent *ical)</span>
<a href="#l8.205"></a><span id="l8.205" class="difflineplus">+      : mComponent(ical), mTimezone(icaltz) {}</span>
<a href="#l8.206"></a><span id="l8.206"> </span>
<a href="#l8.207"></a><span id="l8.207" class="difflineminus">-    NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l8.208"></a><span id="l8.208" class="difflineminus">-    NS_DECL_CALIICALCOMPONENT</span>
<a href="#l8.209"></a><span id="l8.209" class="difflineminus">-    NS_DECL_CALIICALCOMPONENTLIBICAL</span>
<a href="#l8.210"></a><span id="l8.210" class="difflineplus">+  NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l8.211"></a><span id="l8.211" class="difflineplus">+  NS_DECL_CALIICALCOMPONENT</span>
<a href="#l8.212"></a><span id="l8.212" class="difflineplus">+  NS_DECL_CALIICALCOMPONENTLIBICAL</span>
<a href="#l8.213"></a><span id="l8.213"> </span>
<a href="#l8.214"></a><span id="l8.214" class="difflineminus">-protected:</span>
<a href="#l8.215"></a><span id="l8.215" class="difflineminus">-    virtual ~calIcalComponent();</span>
<a href="#l8.216"></a><span id="l8.216" class="difflineplus">+ protected:</span>
<a href="#l8.217"></a><span id="l8.217" class="difflineplus">+  virtual ~calIcalComponent();</span>
<a href="#l8.218"></a><span id="l8.218"> </span>
<a href="#l8.219"></a><span id="l8.219" class="difflineminus">-    calITimezoneProvider * getTzProvider() const {</span>
<a href="#l8.220"></a><span id="l8.220" class="difflineminus">-        // walk up the parents to find a tz provider:</span>
<a href="#l8.221"></a><span id="l8.221" class="difflineminus">-        calIcalComponent const * that = this;</span>
<a href="#l8.222"></a><span id="l8.222" class="difflineminus">-        while (that) {</span>
<a href="#l8.223"></a><span id="l8.223" class="difflineminus">-            calITimezoneProvider * const ret = that-&gt;mTzProvider;</span>
<a href="#l8.224"></a><span id="l8.224" class="difflineminus">-            if (ret) {</span>
<a href="#l8.225"></a><span id="l8.225" class="difflineminus">-                return ret;</span>
<a href="#l8.226"></a><span id="l8.226" class="difflineminus">-            }</span>
<a href="#l8.227"></a><span id="l8.227" class="difflineminus">-            calIIcalComponentLibical * const p = that-&gt;mParent;</span>
<a href="#l8.228"></a><span id="l8.228" class="difflineminus">-            that = static_cast&lt;calIcalComponent const *&gt;(p);</span>
<a href="#l8.229"></a><span id="l8.229" class="difflineminus">-        }</span>
<a href="#l8.230"></a><span id="l8.230" class="difflineminus">-        return nullptr;</span>
<a href="#l8.231"></a><span id="l8.231" class="difflineplus">+  calITimezoneProvider *getTzProvider() const {</span>
<a href="#l8.232"></a><span id="l8.232" class="difflineplus">+    // walk up the parents to find a tz provider:</span>
<a href="#l8.233"></a><span id="l8.233" class="difflineplus">+    calIcalComponent const *that = this;</span>
<a href="#l8.234"></a><span id="l8.234" class="difflineplus">+    while (that) {</span>
<a href="#l8.235"></a><span id="l8.235" class="difflineplus">+      calITimezoneProvider *const ret = that-&gt;mTzProvider;</span>
<a href="#l8.236"></a><span id="l8.236" class="difflineplus">+      if (ret) {</span>
<a href="#l8.237"></a><span id="l8.237" class="difflineplus">+        return ret;</span>
<a href="#l8.238"></a><span id="l8.238" class="difflineplus">+      }</span>
<a href="#l8.239"></a><span id="l8.239" class="difflineplus">+      calIIcalComponentLibical *const p = that-&gt;mParent;</span>
<a href="#l8.240"></a><span id="l8.240" class="difflineplus">+      that = static_cast&lt;calIcalComponent const *&gt;(p);</span>
<a href="#l8.241"></a><span id="l8.241">     }</span>
<a href="#l8.242"></a><span id="l8.242" class="difflineplus">+    return nullptr;</span>
<a href="#l8.243"></a><span id="l8.243" class="difflineplus">+  }</span>
<a href="#l8.244"></a><span id="l8.244"> </span>
<a href="#l8.245"></a><span id="l8.245" class="difflineminus">-    calIcalComponent * getParentVCalendarOrThis() {</span>
<a href="#l8.246"></a><span id="l8.246" class="difflineminus">-        // walk up the parents to find a VCALENDAR:</span>
<a href="#l8.247"></a><span id="l8.247" class="difflineminus">-        calIcalComponent * that = this;</span>
<a href="#l8.248"></a><span id="l8.248" class="difflineminus">-        while (that &amp;&amp; icalcomponent_isa(that-&gt;mComponent) != ICAL_VCALENDAR_COMPONENT) {</span>
<a href="#l8.249"></a><span id="l8.249" class="difflineminus">-            calIIcalComponentLibical * const p = that-&gt;mParent;</span>
<a href="#l8.250"></a><span id="l8.250" class="difflineminus">-            that = static_cast&lt;calIcalComponent *&gt;(p);</span>
<a href="#l8.251"></a><span id="l8.251" class="difflineminus">-        }</span>
<a href="#l8.252"></a><span id="l8.252" class="difflineminus">-        if (!that)</span>
<a href="#l8.253"></a><span id="l8.253" class="difflineminus">-            that = this;</span>
<a href="#l8.254"></a><span id="l8.254" class="difflineminus">-        return that;</span>
<a href="#l8.255"></a><span id="l8.255" class="difflineplus">+  calIcalComponent *getParentVCalendarOrThis() {</span>
<a href="#l8.256"></a><span id="l8.256" class="difflineplus">+    // walk up the parents to find a VCALENDAR:</span>
<a href="#l8.257"></a><span id="l8.257" class="difflineplus">+    calIcalComponent *that = this;</span>
<a href="#l8.258"></a><span id="l8.258" class="difflineplus">+    while (that &amp;&amp;</span>
<a href="#l8.259"></a><span id="l8.259" class="difflineplus">+           icalcomponent_isa(that-&gt;mComponent) != ICAL_VCALENDAR_COMPONENT) {</span>
<a href="#l8.260"></a><span id="l8.260" class="difflineplus">+      calIIcalComponentLibical *const p = that-&gt;mParent;</span>
<a href="#l8.261"></a><span id="l8.261" class="difflineplus">+      that = static_cast&lt;calIcalComponent *&gt;(p);</span>
<a href="#l8.262"></a><span id="l8.262">     }</span>
<a href="#l8.263"></a><span id="l8.263" class="difflineplus">+    if (!that) that = this;</span>
<a href="#l8.264"></a><span id="l8.264" class="difflineplus">+    return that;</span>
<a href="#l8.265"></a><span id="l8.265" class="difflineplus">+  }</span>
<a href="#l8.266"></a><span id="l8.266"> </span>
<a href="#l8.267"></a><span id="l8.267" class="difflineminus">-    nsresult GetDateTimeAttribute(icalproperty_kind kind, calIDateTime ** dtp);</span>
<a href="#l8.268"></a><span id="l8.268" class="difflineminus">-    nsresult SetDateTimeAttribute(icalproperty_kind kind, calIDateTime * dt);</span>
<a href="#l8.269"></a><span id="l8.269" class="difflineplus">+  nsresult GetDateTimeAttribute(icalproperty_kind kind, calIDateTime **dtp);</span>
<a href="#l8.270"></a><span id="l8.270" class="difflineplus">+  nsresult SetDateTimeAttribute(icalproperty_kind kind, calIDateTime *dt);</span>
<a href="#l8.271"></a><span id="l8.271"> </span>
<a href="#l8.272"></a><span id="l8.272" class="difflineminus">-    nsresult SetPropertyValue(icalproperty_kind kind, icalvalue *val);</span>
<a href="#l8.273"></a><span id="l8.273" class="difflineminus">-    nsresult SetProperty(icalproperty_kind kind, icalproperty *prop);</span>
<a href="#l8.274"></a><span id="l8.274" class="difflineplus">+  nsresult SetPropertyValue(icalproperty_kind kind, icalvalue *val);</span>
<a href="#l8.275"></a><span id="l8.275" class="difflineplus">+  nsresult SetProperty(icalproperty_kind kind, icalproperty *prop);</span>
<a href="#l8.276"></a><span id="l8.276"> </span>
<a href="#l8.277"></a><span id="l8.277" class="difflineminus">-    nsresult GetStringProperty(icalproperty_kind kind, nsACString &amp;str);</span>
<a href="#l8.278"></a><span id="l8.278" class="difflineminus">-    nsresult SetStringProperty(icalproperty_kind kind, const nsACString &amp;str);</span>
<a href="#l8.279"></a><span id="l8.279" class="difflineplus">+  nsresult GetStringProperty(icalproperty_kind kind, nsACString &amp;str);</span>
<a href="#l8.280"></a><span id="l8.280" class="difflineplus">+  nsresult SetStringProperty(icalproperty_kind kind, const nsACString &amp;str);</span>
<a href="#l8.281"></a><span id="l8.281"> </span>
<a href="#l8.282"></a><span id="l8.282" class="difflineminus">-    nsresult GetIntProperty(icalproperty_kind kind, int32_t *valp);</span>
<a href="#l8.283"></a><span id="l8.283" class="difflineminus">-    nsresult SetIntProperty(icalproperty_kind kind, int32_t i);</span>
<a href="#l8.284"></a><span id="l8.284" class="difflineplus">+  nsresult GetIntProperty(icalproperty_kind kind, int32_t *valp);</span>
<a href="#l8.285"></a><span id="l8.285" class="difflineplus">+  nsresult SetIntProperty(icalproperty_kind kind, int32_t i);</span>
<a href="#l8.286"></a><span id="l8.286"> </span>
<a href="#l8.287"></a><span id="l8.287" class="difflineminus">-    void ClearAllProperties(icalproperty_kind kind);</span>
<a href="#l8.288"></a><span id="l8.288" class="difflineplus">+  void ClearAllProperties(icalproperty_kind kind);</span>
<a href="#l8.289"></a><span id="l8.289"> </span>
<a href="#l8.290"></a><span id="l8.290" class="difflineminus">-    nsresult Serialize(char ** icalstr);</span>
<a href="#l8.291"></a><span id="l8.291" class="difflineplus">+  nsresult Serialize(char **icalstr);</span>
<a href="#l8.292"></a><span id="l8.292"> </span>
<a href="#l8.293"></a><span id="l8.293" class="difflineminus">-    nsInterfaceHashtable&lt;nsCStringHashKey, calITimezone&gt; mReferencedTimezones;</span>
<a href="#l8.294"></a><span id="l8.294" class="difflineminus">-    icalcomponent *                                      mComponent;</span>
<a href="#l8.295"></a><span id="l8.295" class="difflineminus">-    icaltimezone *                                       mTimezone; // set iff VTIMEZONE</span>
<a href="#l8.296"></a><span id="l8.296" class="difflineminus">-    nsCOMPtr&lt;calITimezoneProvider&gt; const                 mTzProvider;</span>
<a href="#l8.297"></a><span id="l8.297" class="difflineminus">-    nsCOMPtr&lt;calIIcalComponentLibical&gt;                   mParent;</span>
<a href="#l8.298"></a><span id="l8.298" class="difflineplus">+  nsInterfaceHashtable&lt;nsCStringHashKey, calITimezone&gt; mReferencedTimezones;</span>
<a href="#l8.299"></a><span id="l8.299" class="difflineplus">+  icalcomponent *mComponent;</span>
<a href="#l8.300"></a><span id="l8.300" class="difflineplus">+  icaltimezone *mTimezone;  // set iff VTIMEZONE</span>
<a href="#l8.301"></a><span id="l8.301" class="difflineplus">+  nsCOMPtr&lt;calITimezoneProvider&gt; const mTzProvider;</span>
<a href="#l8.302"></a><span id="l8.302" class="difflineplus">+  nsCOMPtr&lt;calIIcalComponentLibical&gt; mParent;</span>
<a href="#l8.303"></a><span id="l8.303"> };</span>
<a href="#l8.304"></a><span id="l8.304"> </span>
<a href="#l8.305"></a><span id="l8.305" class="difflineminus">-inline calIcalProperty * toIcalProperty(calIIcalPropertyLibical * p) {</span>
<a href="#l8.306"></a><span id="l8.306" class="difflineminus">-    return static_cast&lt;calIcalProperty *&gt;(p);</span>
<a href="#l8.307"></a><span id="l8.307" class="difflineplus">+inline calIcalProperty *toIcalProperty(calIIcalPropertyLibical *p) {</span>
<a href="#l8.308"></a><span id="l8.308" class="difflineplus">+  return static_cast&lt;calIcalProperty *&gt;(p);</span>
<a href="#l8.309"></a><span id="l8.309"> }</span>
<a href="#l8.310"></a><span id="l8.310" class="difflineminus">-inline calIcalComponent * toIcalComponent(calIIcalComponentLibical * p) {</span>
<a href="#l8.311"></a><span id="l8.311" class="difflineminus">-    return static_cast&lt;calIcalComponent *&gt;(p);</span>
<a href="#l8.312"></a><span id="l8.312" class="difflineplus">+inline calIcalComponent *toIcalComponent(calIIcalComponentLibical *p) {</span>
<a href="#l8.313"></a><span id="l8.313" class="difflineplus">+  return static_cast&lt;calIcalComponent *&gt;(p);</span>
<a href="#l8.314"></a><span id="l8.314"> }</span>
<a href="#l8.315"></a><span id="l8.315"> </span>
<a href="#l8.316"></a><span id="l8.316" class="difflineminus">-#endif // INCLUDED_CALICSSERVICE_H</span>
<a href="#l8.317"></a><span id="l8.317" class="difflineplus">+#endif  // INCLUDED_CALICSSERVICE_H</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/calendar/base/backend/libical/calPeriod.cpp</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/calendar/base/backend/libical/calPeriod.cpp</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -8,181 +8,149 @@</span>
<a href="#l9.4"></a><span id="l9.4"> </span>
<a href="#l9.5"></a><span id="l9.5"> #include &quot;nsIClassInfoImpl.h&quot;</span>
<a href="#l9.6"></a><span id="l9.6"> </span>
<a href="#l9.7"></a><span id="l9.7"> #include &quot;calUtils.h&quot;</span>
<a href="#l9.8"></a><span id="l9.8"> </span>
<a href="#l9.9"></a><span id="l9.9"> NS_IMPL_CLASSINFO(calPeriod, nullptr, 0, CAL_PERIOD_CID)</span>
<a href="#l9.10"></a><span id="l9.10"> NS_IMPL_ISUPPORTS_CI(calPeriod, calIPeriod, calIPeriodLibical)</span>
<a href="#l9.11"></a><span id="l9.11"> </span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-calPeriod::calPeriod()</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineminus">-    : mImmutable(false)</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineminus">-{</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineplus">+calPeriod::calPeriod() : mImmutable(false) {}</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineplus">+</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineplus">+calPeriod::calPeriod(const calPeriod &amp;cpt) : mImmutable(false) {</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineplus">+  if (cpt.mStart) {</span>
<a href="#l9.19"></a><span id="l9.19" class="difflineplus">+    nsCOMPtr&lt;calIDateTime&gt; start;</span>
<a href="#l9.20"></a><span id="l9.20" class="difflineplus">+    cpt.mStart-&gt;Clone(getter_AddRefs(start));</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineplus">+    mStart = do_QueryInterface(start);</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineplus">+  }</span>
<a href="#l9.23"></a><span id="l9.23" class="difflineplus">+  if (cpt.mEnd) {</span>
<a href="#l9.24"></a><span id="l9.24" class="difflineplus">+    nsCOMPtr&lt;calIDateTime&gt; end;</span>
<a href="#l9.25"></a><span id="l9.25" class="difflineplus">+    cpt.mEnd-&gt;Clone(getter_AddRefs(end));</span>
<a href="#l9.26"></a><span id="l9.26" class="difflineplus">+    mEnd = do_QueryInterface(end);</span>
<a href="#l9.27"></a><span id="l9.27" class="difflineplus">+  }</span>
<a href="#l9.28"></a><span id="l9.28"> }</span>
<a href="#l9.29"></a><span id="l9.29"> </span>
<a href="#l9.30"></a><span id="l9.30" class="difflineminus">-calPeriod::calPeriod(const calPeriod&amp; cpt)</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineminus">-    : mImmutable(false)</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineminus">-{</span>
<a href="#l9.33"></a><span id="l9.33" class="difflineminus">-    if (cpt.mStart) {</span>
<a href="#l9.34"></a><span id="l9.34" class="difflineminus">-        nsCOMPtr&lt;calIDateTime&gt; start;</span>
<a href="#l9.35"></a><span id="l9.35" class="difflineminus">-        cpt.mStart-&gt;Clone(getter_AddRefs(start));</span>
<a href="#l9.36"></a><span id="l9.36" class="difflineminus">-        mStart = do_QueryInterface(start);</span>
<a href="#l9.37"></a><span id="l9.37" class="difflineminus">-    }</span>
<a href="#l9.38"></a><span id="l9.38" class="difflineminus">-    if (cpt.mEnd) {</span>
<a href="#l9.39"></a><span id="l9.39" class="difflineminus">-        nsCOMPtr&lt;calIDateTime&gt; end;</span>
<a href="#l9.40"></a><span id="l9.40" class="difflineminus">-        cpt.mEnd-&gt;Clone(getter_AddRefs(end));</span>
<a href="#l9.41"></a><span id="l9.41" class="difflineminus">-        mEnd = do_QueryInterface(end);</span>
<a href="#l9.42"></a><span id="l9.42" class="difflineminus">-    }</span>
<a href="#l9.43"></a><span id="l9.43" class="difflineminus">-}</span>
<a href="#l9.44"></a><span id="l9.44" class="difflineminus">-</span>
<a href="#l9.45"></a><span id="l9.45" class="difflineminus">-calPeriod::calPeriod(struct icalperiodtype const* aPeriodPtr)</span>
<a href="#l9.46"></a><span id="l9.46" class="difflineminus">-    : mImmutable(false)</span>
<a href="#l9.47"></a><span id="l9.47" class="difflineminus">-{</span>
<a href="#l9.48"></a><span id="l9.48" class="difflineminus">-    FromIcalPeriod(aPeriodPtr);</span>
<a href="#l9.49"></a><span id="l9.49" class="difflineplus">+calPeriod::calPeriod(struct icalperiodtype const *aPeriodPtr)</span>
<a href="#l9.50"></a><span id="l9.50" class="difflineplus">+    : mImmutable(false) {</span>
<a href="#l9.51"></a><span id="l9.51" class="difflineplus">+  FromIcalPeriod(aPeriodPtr);</span>
<a href="#l9.52"></a><span id="l9.52"> }</span>
<a href="#l9.53"></a><span id="l9.53"> </span>
<a href="#l9.54"></a><span id="l9.54"> NS_IMETHODIMP</span>
<a href="#l9.55"></a><span id="l9.55" class="difflineminus">-calPeriod::GetIcalPeriod(JS::MutableHandleValue)</span>
<a href="#l9.56"></a><span id="l9.56" class="difflineminus">-{</span>
<a href="#l9.57"></a><span id="l9.57" class="difflineminus">-    return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l9.58"></a><span id="l9.58" class="difflineminus">-}</span>
<a href="#l9.59"></a><span id="l9.59" class="difflineminus">-</span>
<a href="#l9.60"></a><span id="l9.60" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l9.61"></a><span id="l9.61" class="difflineminus">-calPeriod::SetIcalPeriod(JS::HandleValue)</span>
<a href="#l9.62"></a><span id="l9.62" class="difflineminus">-{</span>
<a href="#l9.63"></a><span id="l9.63" class="difflineminus">-    return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l9.64"></a><span id="l9.64" class="difflineplus">+calPeriod::GetIcalPeriod(JS::MutableHandleValue) {</span>
<a href="#l9.65"></a><span id="l9.65" class="difflineplus">+  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l9.66"></a><span id="l9.66"> }</span>
<a href="#l9.67"></a><span id="l9.67"> </span>
<a href="#l9.68"></a><span id="l9.68"> NS_IMETHODIMP</span>
<a href="#l9.69"></a><span id="l9.69" class="difflineminus">-calPeriod::GetIsMutable(bool *aResult)</span>
<a href="#l9.70"></a><span id="l9.70" class="difflineminus">-{</span>
<a href="#l9.71"></a><span id="l9.71" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l9.72"></a><span id="l9.72" class="difflineplus">+calPeriod::SetIcalPeriod(JS::HandleValue) { return NS_ERROR_NOT_IMPLEMENTED; }</span>
<a href="#l9.73"></a><span id="l9.73"> </span>
<a href="#l9.74"></a><span id="l9.74" class="difflineminus">-    *aResult = !mImmutable;</span>
<a href="#l9.75"></a><span id="l9.75" class="difflineminus">-    return NS_OK;</span>
<a href="#l9.76"></a><span id="l9.76" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l9.77"></a><span id="l9.77" class="difflineplus">+calPeriod::GetIsMutable(bool *aResult) {</span>
<a href="#l9.78"></a><span id="l9.78" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l9.79"></a><span id="l9.79" class="difflineplus">+</span>
<a href="#l9.80"></a><span id="l9.80" class="difflineplus">+  *aResult = !mImmutable;</span>
<a href="#l9.81"></a><span id="l9.81" class="difflineplus">+  return NS_OK;</span>
<a href="#l9.82"></a><span id="l9.82"> }</span>
<a href="#l9.83"></a><span id="l9.83"> </span>
<a href="#l9.84"></a><span id="l9.84"> NS_IMETHODIMP</span>
<a href="#l9.85"></a><span id="l9.85" class="difflineminus">-calPeriod::MakeImmutable()</span>
<a href="#l9.86"></a><span id="l9.86" class="difflineminus">-{</span>
<a href="#l9.87"></a><span id="l9.87" class="difflineminus">-    mImmutable = true;</span>
<a href="#l9.88"></a><span id="l9.88" class="difflineminus">-    return NS_OK;</span>
<a href="#l9.89"></a><span id="l9.89" class="difflineplus">+calPeriod::MakeImmutable() {</span>
<a href="#l9.90"></a><span id="l9.90" class="difflineplus">+  mImmutable = true;</span>
<a href="#l9.91"></a><span id="l9.91" class="difflineplus">+  return NS_OK;</span>
<a href="#l9.92"></a><span id="l9.92"> }</span>
<a href="#l9.93"></a><span id="l9.93"> </span>
<a href="#l9.94"></a><span id="l9.94"> NS_IMETHODIMP</span>
<a href="#l9.95"></a><span id="l9.95" class="difflineminus">-calPeriod::Clone(calIPeriod **aResult)</span>
<a href="#l9.96"></a><span id="l9.96" class="difflineminus">-{</span>
<a href="#l9.97"></a><span id="l9.97" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l9.98"></a><span id="l9.98" class="difflineminus">-    calPeriod *cpt = new calPeriod(*this);</span>
<a href="#l9.99"></a><span id="l9.99" class="difflineminus">-    if (!cpt)</span>
<a href="#l9.100"></a><span id="l9.100" class="difflineminus">-        return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l9.101"></a><span id="l9.101" class="difflineplus">+calPeriod::Clone(calIPeriod **aResult) {</span>
<a href="#l9.102"></a><span id="l9.102" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l9.103"></a><span id="l9.103" class="difflineplus">+  calPeriod *cpt = new calPeriod(*this);</span>
<a href="#l9.104"></a><span id="l9.104" class="difflineplus">+  if (!cpt) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l9.105"></a><span id="l9.105"> </span>
<a href="#l9.106"></a><span id="l9.106" class="difflineminus">-    NS_ADDREF(*aResult = cpt);</span>
<a href="#l9.107"></a><span id="l9.107" class="difflineminus">-    return NS_OK;</span>
<a href="#l9.108"></a><span id="l9.108" class="difflineplus">+  NS_ADDREF(*aResult = cpt);</span>
<a href="#l9.109"></a><span id="l9.109" class="difflineplus">+  return NS_OK;</span>
<a href="#l9.110"></a><span id="l9.110"> }</span>
<a href="#l9.111"></a><span id="l9.111"> </span>
<a href="#l9.112"></a><span id="l9.112" class="difflineminus">-</span>
<a href="#l9.113"></a><span id="l9.113" class="difflineminus">-NS_IMETHODIMP calPeriod::GetStart(calIDateTime **_retval)</span>
<a href="#l9.114"></a><span id="l9.114" class="difflineminus">-{</span>
<a href="#l9.115"></a><span id="l9.115" class="difflineminus">-    NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l9.116"></a><span id="l9.116" class="difflineminus">-    *_retval = mStart;</span>
<a href="#l9.117"></a><span id="l9.117" class="difflineminus">-    NS_IF_ADDREF(*_retval);</span>
<a href="#l9.118"></a><span id="l9.118" class="difflineminus">-    return NS_OK;</span>
<a href="#l9.119"></a><span id="l9.119" class="difflineplus">+NS_IMETHODIMP calPeriod::GetStart(calIDateTime **_retval) {</span>
<a href="#l9.120"></a><span id="l9.120" class="difflineplus">+  NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l9.121"></a><span id="l9.121" class="difflineplus">+  *_retval = mStart;</span>
<a href="#l9.122"></a><span id="l9.122" class="difflineplus">+  NS_IF_ADDREF(*_retval);</span>
<a href="#l9.123"></a><span id="l9.123" class="difflineplus">+  return NS_OK;</span>
<a href="#l9.124"></a><span id="l9.124"> }</span>
<a href="#l9.125"></a><span id="l9.125" class="difflineminus">-NS_IMETHODIMP calPeriod::SetStart(calIDateTime *aValue)</span>
<a href="#l9.126"></a><span id="l9.126" class="difflineminus">-{</span>
<a href="#l9.127"></a><span id="l9.127" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aValue);</span>
<a href="#l9.128"></a><span id="l9.128" class="difflineminus">-    if (mImmutable)</span>
<a href="#l9.129"></a><span id="l9.129" class="difflineminus">-        return NS_ERROR_OBJECT_IS_IMMUTABLE;</span>
<a href="#l9.130"></a><span id="l9.130" class="difflineplus">+NS_IMETHODIMP calPeriod::SetStart(calIDateTime *aValue) {</span>
<a href="#l9.131"></a><span id="l9.131" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aValue);</span>
<a href="#l9.132"></a><span id="l9.132" class="difflineplus">+  if (mImmutable) return NS_ERROR_OBJECT_IS_IMMUTABLE;</span>
<a href="#l9.133"></a><span id="l9.133"> </span>
<a href="#l9.134"></a><span id="l9.134" class="difflineminus">-    mStart = do_QueryInterface(aValue);</span>
<a href="#l9.135"></a><span id="l9.135" class="difflineminus">-    return mStart-&gt;MakeImmutable();</span>
<a href="#l9.136"></a><span id="l9.136" class="difflineplus">+  mStart = do_QueryInterface(aValue);</span>
<a href="#l9.137"></a><span id="l9.137" class="difflineplus">+  return mStart-&gt;MakeImmutable();</span>
<a href="#l9.138"></a><span id="l9.138"> }</span>
<a href="#l9.139"></a><span id="l9.139"> </span>
<a href="#l9.140"></a><span id="l9.140" class="difflineminus">-NS_IMETHODIMP calPeriod::GetEnd(calIDateTime **_retval)</span>
<a href="#l9.141"></a><span id="l9.141" class="difflineminus">-{</span>
<a href="#l9.142"></a><span id="l9.142" class="difflineminus">-    NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l9.143"></a><span id="l9.143" class="difflineminus">-    *_retval = mEnd;</span>
<a href="#l9.144"></a><span id="l9.144" class="difflineminus">-    NS_IF_ADDREF(*_retval);</span>
<a href="#l9.145"></a><span id="l9.145" class="difflineminus">-    return NS_OK;</span>
<a href="#l9.146"></a><span id="l9.146" class="difflineplus">+NS_IMETHODIMP calPeriod::GetEnd(calIDateTime **_retval) {</span>
<a href="#l9.147"></a><span id="l9.147" class="difflineplus">+  NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l9.148"></a><span id="l9.148" class="difflineplus">+  *_retval = mEnd;</span>
<a href="#l9.149"></a><span id="l9.149" class="difflineplus">+  NS_IF_ADDREF(*_retval);</span>
<a href="#l9.150"></a><span id="l9.150" class="difflineplus">+  return NS_OK;</span>
<a href="#l9.151"></a><span id="l9.151"> }</span>
<a href="#l9.152"></a><span id="l9.152" class="difflineminus">-NS_IMETHODIMP calPeriod::SetEnd(calIDateTime *aValue)</span>
<a href="#l9.153"></a><span id="l9.153" class="difflineminus">-{</span>
<a href="#l9.154"></a><span id="l9.154" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aValue);</span>
<a href="#l9.155"></a><span id="l9.155" class="difflineminus">-    if (mImmutable)</span>
<a href="#l9.156"></a><span id="l9.156" class="difflineminus">-        return NS_ERROR_OBJECT_IS_IMMUTABLE;</span>
<a href="#l9.157"></a><span id="l9.157" class="difflineplus">+NS_IMETHODIMP calPeriod::SetEnd(calIDateTime *aValue) {</span>
<a href="#l9.158"></a><span id="l9.158" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aValue);</span>
<a href="#l9.159"></a><span id="l9.159" class="difflineplus">+  if (mImmutable) return NS_ERROR_OBJECT_IS_IMMUTABLE;</span>
<a href="#l9.160"></a><span id="l9.160"> </span>
<a href="#l9.161"></a><span id="l9.161" class="difflineminus">-    mEnd = do_QueryInterface(aValue);</span>
<a href="#l9.162"></a><span id="l9.162" class="difflineminus">-    return mEnd-&gt;MakeImmutable();</span>
<a href="#l9.163"></a><span id="l9.163" class="difflineplus">+  mEnd = do_QueryInterface(aValue);</span>
<a href="#l9.164"></a><span id="l9.164" class="difflineplus">+  return mEnd-&gt;MakeImmutable();</span>
<a href="#l9.165"></a><span id="l9.165"> }</span>
<a href="#l9.166"></a><span id="l9.166"> </span>
<a href="#l9.167"></a><span id="l9.167" class="difflineminus">-NS_IMETHODIMP calPeriod::GetDuration(calIDuration **_retval)</span>
<a href="#l9.168"></a><span id="l9.168" class="difflineminus">-{</span>
<a href="#l9.169"></a><span id="l9.169" class="difflineminus">-    NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l9.170"></a><span id="l9.170" class="difflineminus">-    if (!mStart || !mEnd)</span>
<a href="#l9.171"></a><span id="l9.171" class="difflineminus">-        return NS_ERROR_UNEXPECTED;</span>
<a href="#l9.172"></a><span id="l9.172" class="difflineminus">-    return mEnd-&gt;SubtractDate(mStart, _retval);</span>
<a href="#l9.173"></a><span id="l9.173" class="difflineplus">+NS_IMETHODIMP calPeriod::GetDuration(calIDuration **_retval) {</span>
<a href="#l9.174"></a><span id="l9.174" class="difflineplus">+  NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l9.175"></a><span id="l9.175" class="difflineplus">+  if (!mStart || !mEnd) return NS_ERROR_UNEXPECTED;</span>
<a href="#l9.176"></a><span id="l9.176" class="difflineplus">+  return mEnd-&gt;SubtractDate(mStart, _retval);</span>
<a href="#l9.177"></a><span id="l9.177"> }</span>
<a href="#l9.178"></a><span id="l9.178"> </span>
<a href="#l9.179"></a><span id="l9.179"> NS_IMETHODIMP</span>
<a href="#l9.180"></a><span id="l9.180" class="difflineminus">-calPeriod::ToString(nsACString&amp; aResult)</span>
<a href="#l9.181"></a><span id="l9.181" class="difflineminus">-{</span>
<a href="#l9.182"></a><span id="l9.182" class="difflineminus">-    return GetIcalString(aResult);</span>
<a href="#l9.183"></a><span id="l9.183" class="difflineminus">-}</span>
<a href="#l9.184"></a><span id="l9.184" class="difflineplus">+calPeriod::ToString(nsACString &amp;aResult) { return GetIcalString(aResult); }</span>
<a href="#l9.185"></a><span id="l9.185"> </span>
<a href="#l9.186"></a><span id="l9.186"> NS_IMETHODIMP_(void)</span>
<a href="#l9.187"></a><span id="l9.187" class="difflineminus">-calPeriod::ToIcalPeriod(struct icalperiodtype *icalp)</span>
<a href="#l9.188"></a><span id="l9.188" class="difflineminus">-{</span>
<a href="#l9.189"></a><span id="l9.189" class="difflineminus">-    // makes no sense to create a duration without bath a start and end</span>
<a href="#l9.190"></a><span id="l9.190" class="difflineminus">-    if (!mStart || !mEnd) {</span>
<a href="#l9.191"></a><span id="l9.191" class="difflineminus">-        *icalp = icalperiodtype_null_period();</span>
<a href="#l9.192"></a><span id="l9.192" class="difflineminus">-        return;</span>
<a href="#l9.193"></a><span id="l9.193" class="difflineminus">-    }</span>
<a href="#l9.194"></a><span id="l9.194" class="difflineminus">-    </span>
<a href="#l9.195"></a><span id="l9.195" class="difflineminus">-    mStart-&gt;ToIcalTime(&amp;icalp-&gt;start);</span>
<a href="#l9.196"></a><span id="l9.196" class="difflineminus">-    mEnd-&gt;ToIcalTime(&amp;icalp-&gt;end);</span>
<a href="#l9.197"></a><span id="l9.197" class="difflineplus">+calPeriod::ToIcalPeriod(struct icalperiodtype *icalp) {</span>
<a href="#l9.198"></a><span id="l9.198" class="difflineplus">+  // makes no sense to create a duration without bath a start and end</span>
<a href="#l9.199"></a><span id="l9.199" class="difflineplus">+  if (!mStart || !mEnd) {</span>
<a href="#l9.200"></a><span id="l9.200" class="difflineplus">+    *icalp = icalperiodtype_null_period();</span>
<a href="#l9.201"></a><span id="l9.201" class="difflineplus">+    return;</span>
<a href="#l9.202"></a><span id="l9.202" class="difflineplus">+  }</span>
<a href="#l9.203"></a><span id="l9.203" class="difflineplus">+</span>
<a href="#l9.204"></a><span id="l9.204" class="difflineplus">+  mStart-&gt;ToIcalTime(&amp;icalp-&gt;start);</span>
<a href="#l9.205"></a><span id="l9.205" class="difflineplus">+  mEnd-&gt;ToIcalTime(&amp;icalp-&gt;end);</span>
<a href="#l9.206"></a><span id="l9.206"> }</span>
<a href="#l9.207"></a><span id="l9.207"> </span>
<a href="#l9.208"></a><span id="l9.208" class="difflineminus">-void</span>
<a href="#l9.209"></a><span id="l9.209" class="difflineminus">-calPeriod::FromIcalPeriod(struct icalperiodtype const* icalp)</span>
<a href="#l9.210"></a><span id="l9.210" class="difflineminus">-{</span>
<a href="#l9.211"></a><span id="l9.211" class="difflineminus">-    mStart = new calDateTime(&amp;(icalp-&gt;start), nullptr);</span>
<a href="#l9.212"></a><span id="l9.212" class="difflineminus">-    mStart-&gt;MakeImmutable();</span>
<a href="#l9.213"></a><span id="l9.213" class="difflineminus">-    mEnd = new calDateTime(&amp;(icalp-&gt;end), nullptr);</span>
<a href="#l9.214"></a><span id="l9.214" class="difflineminus">-    mEnd-&gt;MakeImmutable();</span>
<a href="#l9.215"></a><span id="l9.215" class="difflineminus">-    return;</span>
<a href="#l9.216"></a><span id="l9.216" class="difflineplus">+void calPeriod::FromIcalPeriod(struct icalperiodtype const *icalp) {</span>
<a href="#l9.217"></a><span id="l9.217" class="difflineplus">+  mStart = new calDateTime(&amp;(icalp-&gt;start), nullptr);</span>
<a href="#l9.218"></a><span id="l9.218" class="difflineplus">+  mStart-&gt;MakeImmutable();</span>
<a href="#l9.219"></a><span id="l9.219" class="difflineplus">+  mEnd = new calDateTime(&amp;(icalp-&gt;end), nullptr);</span>
<a href="#l9.220"></a><span id="l9.220" class="difflineplus">+  mEnd-&gt;MakeImmutable();</span>
<a href="#l9.221"></a><span id="l9.221" class="difflineplus">+  return;</span>
<a href="#l9.222"></a><span id="l9.222"> }</span>
<a href="#l9.223"></a><span id="l9.223"> </span>
<a href="#l9.224"></a><span id="l9.224"> NS_IMETHODIMP</span>
<a href="#l9.225"></a><span id="l9.225" class="difflineminus">-calPeriod::GetIcalString(nsACString&amp; aResult)</span>
<a href="#l9.226"></a><span id="l9.226" class="difflineminus">-{</span>
<a href="#l9.227"></a><span id="l9.227" class="difflineminus">-    struct icalperiodtype ip;</span>
<a href="#l9.228"></a><span id="l9.228" class="difflineminus">-    ToIcalPeriod(&amp;ip);</span>
<a href="#l9.229"></a><span id="l9.229" class="difflineminus">-    </span>
<a href="#l9.230"></a><span id="l9.230" class="difflineminus">-    // note that ics is owned by libical, so we don't need to free</span>
<a href="#l9.231"></a><span id="l9.231" class="difflineminus">-    const char *ics = icalperiodtype_as_ical_string(ip);</span>
<a href="#l9.232"></a><span id="l9.232" class="difflineminus">-    </span>
<a href="#l9.233"></a><span id="l9.233" class="difflineminus">-    if (ics) {</span>
<a href="#l9.234"></a><span id="l9.234" class="difflineminus">-        aResult.Assign(ics);</span>
<a href="#l9.235"></a><span id="l9.235" class="difflineminus">-        return NS_OK;</span>
<a href="#l9.236"></a><span id="l9.236" class="difflineminus">-    }</span>
<a href="#l9.237"></a><span id="l9.237" class="difflineplus">+calPeriod::GetIcalString(nsACString &amp;aResult) {</span>
<a href="#l9.238"></a><span id="l9.238" class="difflineplus">+  struct icalperiodtype ip;</span>
<a href="#l9.239"></a><span id="l9.239" class="difflineplus">+  ToIcalPeriod(&amp;ip);</span>
<a href="#l9.240"></a><span id="l9.240" class="difflineplus">+</span>
<a href="#l9.241"></a><span id="l9.241" class="difflineplus">+  // note that ics is owned by libical, so we don't need to free</span>
<a href="#l9.242"></a><span id="l9.242" class="difflineplus">+  const char *ics = icalperiodtype_as_ical_string(ip);</span>
<a href="#l9.243"></a><span id="l9.243"> </span>
<a href="#l9.244"></a><span id="l9.244" class="difflineminus">-    return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l9.245"></a><span id="l9.245" class="difflineplus">+  if (ics) {</span>
<a href="#l9.246"></a><span id="l9.246" class="difflineplus">+    aResult.Assign(ics);</span>
<a href="#l9.247"></a><span id="l9.247" class="difflineplus">+    return NS_OK;</span>
<a href="#l9.248"></a><span id="l9.248" class="difflineplus">+  }</span>
<a href="#l9.249"></a><span id="l9.249" class="difflineplus">+</span>
<a href="#l9.250"></a><span id="l9.250" class="difflineplus">+  return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l9.251"></a><span id="l9.251"> }</span>
<a href="#l9.252"></a><span id="l9.252"> </span>
<a href="#l9.253"></a><span id="l9.253"> NS_IMETHODIMP</span>
<a href="#l9.254"></a><span id="l9.254" class="difflineminus">-calPeriod::SetIcalString(const nsACString&amp; aIcalString)</span>
<a href="#l9.255"></a><span id="l9.255" class="difflineminus">-{</span>
<a href="#l9.256"></a><span id="l9.256" class="difflineminus">-    if (mImmutable)</span>
<a href="#l9.257"></a><span id="l9.257" class="difflineminus">-        return NS_ERROR_OBJECT_IS_IMMUTABLE;</span>
<a href="#l9.258"></a><span id="l9.258" class="difflineminus">-    struct icalperiodtype ip;</span>
<a href="#l9.259"></a><span id="l9.259" class="difflineminus">-    ip = icalperiodtype_from_string(PromiseFlatCString(aIcalString).get());</span>
<a href="#l9.260"></a><span id="l9.260" class="difflineminus">-    //XXX Shortcut. Assumes nobody tried to overrule our impl. of calIDateTime</span>
<a href="#l9.261"></a><span id="l9.261" class="difflineminus">-    mStart = new calDateTime(&amp;ip.start, nullptr);</span>
<a href="#l9.262"></a><span id="l9.262" class="difflineminus">-    if (icaltime_is_null_time(ip.end)) {</span>
<a href="#l9.263"></a><span id="l9.263" class="difflineminus">-        struct icaltimetype end;</span>
<a href="#l9.264"></a><span id="l9.264" class="difflineminus">-        end = icaltime_add(ip.start, ip.duration);</span>
<a href="#l9.265"></a><span id="l9.265" class="difflineminus">-        mEnd = new calDateTime(&amp;end, nullptr);</span>
<a href="#l9.266"></a><span id="l9.266" class="difflineminus">-    } else {</span>
<a href="#l9.267"></a><span id="l9.267" class="difflineminus">-        mEnd = new calDateTime(&amp;ip.end, nullptr);</span>
<a href="#l9.268"></a><span id="l9.268" class="difflineminus">-    }</span>
<a href="#l9.269"></a><span id="l9.269" class="difflineminus">-    return NS_OK;</span>
<a href="#l9.270"></a><span id="l9.270" class="difflineplus">+calPeriod::SetIcalString(const nsACString &amp;aIcalString) {</span>
<a href="#l9.271"></a><span id="l9.271" class="difflineplus">+  if (mImmutable) return NS_ERROR_OBJECT_IS_IMMUTABLE;</span>
<a href="#l9.272"></a><span id="l9.272" class="difflineplus">+  struct icalperiodtype ip;</span>
<a href="#l9.273"></a><span id="l9.273" class="difflineplus">+  ip = icalperiodtype_from_string(PromiseFlatCString(aIcalString).get());</span>
<a href="#l9.274"></a><span id="l9.274" class="difflineplus">+  // XXX Shortcut. Assumes nobody tried to overrule our impl. of calIDateTime</span>
<a href="#l9.275"></a><span id="l9.275" class="difflineplus">+  mStart = new calDateTime(&amp;ip.start, nullptr);</span>
<a href="#l9.276"></a><span id="l9.276" class="difflineplus">+  if (icaltime_is_null_time(ip.end)) {</span>
<a href="#l9.277"></a><span id="l9.277" class="difflineplus">+    struct icaltimetype end;</span>
<a href="#l9.278"></a><span id="l9.278" class="difflineplus">+    end = icaltime_add(ip.start, ip.duration);</span>
<a href="#l9.279"></a><span id="l9.279" class="difflineplus">+    mEnd = new calDateTime(&amp;end, nullptr);</span>
<a href="#l9.280"></a><span id="l9.280" class="difflineplus">+  } else {</span>
<a href="#l9.281"></a><span id="l9.281" class="difflineplus">+    mEnd = new calDateTime(&amp;ip.end, nullptr);</span>
<a href="#l9.282"></a><span id="l9.282" class="difflineplus">+  }</span>
<a href="#l9.283"></a><span id="l9.283" class="difflineplus">+  return NS_OK;</span>
<a href="#l9.284"></a><span id="l9.284"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/calendar/base/backend/libical/calPeriod.h</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/calendar/base/backend/libical/calPeriod.h</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -8,40 +8,38 @@</span>
<a href="#l10.4"></a><span id="l10.4"> </span>
<a href="#l10.5"></a><span id="l10.5"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l10.6"></a><span id="l10.6"> </span>
<a href="#l10.7"></a><span id="l10.7"> #include &quot;calIPeriod.h&quot;</span>
<a href="#l10.8"></a><span id="l10.8"> #include &quot;calDateTime.h&quot;</span>
<a href="#l10.9"></a><span id="l10.9"> #include &quot;calIDuration.h&quot;</span>
<a href="#l10.10"></a><span id="l10.10"> </span>
<a href="#l10.11"></a><span id="l10.11"> extern &quot;C&quot; {</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-    #include &quot;ical.h&quot;</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+#include &quot;ical.h&quot;</span>
<a href="#l10.14"></a><span id="l10.14"> }</span>
<a href="#l10.15"></a><span id="l10.15"> </span>
<a href="#l10.16"></a><span id="l10.16" class="difflineminus">-class calPeriod final : public calIPeriodLibical</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineminus">-{</span>
<a href="#l10.18"></a><span id="l10.18" class="difflineminus">-public:</span>
<a href="#l10.19"></a><span id="l10.19" class="difflineminus">-    calPeriod ();</span>
<a href="#l10.20"></a><span id="l10.20" class="difflineminus">-    explicit calPeriod (const calPeriod&amp; cpt);</span>
<a href="#l10.21"></a><span id="l10.21" class="difflineminus">-    explicit calPeriod (struct icalperiodtype const* aPeriodPtr);</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineplus">+class calPeriod final : public calIPeriodLibical {</span>
<a href="#l10.23"></a><span id="l10.23" class="difflineplus">+ public:</span>
<a href="#l10.24"></a><span id="l10.24" class="difflineplus">+  calPeriod();</span>
<a href="#l10.25"></a><span id="l10.25" class="difflineplus">+  explicit calPeriod(const calPeriod&amp; cpt);</span>
<a href="#l10.26"></a><span id="l10.26" class="difflineplus">+  explicit calPeriod(struct icalperiodtype const* aPeriodPtr);</span>
<a href="#l10.27"></a><span id="l10.27"> </span>
<a href="#l10.28"></a><span id="l10.28" class="difflineminus">-    // nsISupports interface</span>
<a href="#l10.29"></a><span id="l10.29" class="difflineminus">-    NS_DECL_ISUPPORTS</span>
<a href="#l10.30"></a><span id="l10.30" class="difflineplus">+  // nsISupports interface</span>
<a href="#l10.31"></a><span id="l10.31" class="difflineplus">+  NS_DECL_ISUPPORTS</span>
<a href="#l10.32"></a><span id="l10.32"> </span>
<a href="#l10.33"></a><span id="l10.33" class="difflineminus">-    // calIPeriod interface</span>
<a href="#l10.34"></a><span id="l10.34" class="difflineminus">-    NS_DECL_CALIPERIOD</span>
<a href="#l10.35"></a><span id="l10.35" class="difflineminus">-    NS_DECL_CALIPERIODLIBICAL</span>
<a href="#l10.36"></a><span id="l10.36" class="difflineplus">+  // calIPeriod interface</span>
<a href="#l10.37"></a><span id="l10.37" class="difflineplus">+  NS_DECL_CALIPERIOD</span>
<a href="#l10.38"></a><span id="l10.38" class="difflineplus">+  NS_DECL_CALIPERIODLIBICAL</span>
<a href="#l10.39"></a><span id="l10.39"> </span>
<a href="#l10.40"></a><span id="l10.40" class="difflineminus">-protected:</span>
<a href="#l10.41"></a><span id="l10.41" class="difflineminus">-    ~calPeriod() {}</span>
<a href="#l10.42"></a><span id="l10.42" class="difflineminus">-    calPeriod const&amp; operator=(calPeriod const&amp;);</span>
<a href="#l10.43"></a><span id="l10.43" class="difflineplus">+ protected:</span>
<a href="#l10.44"></a><span id="l10.44" class="difflineplus">+  ~calPeriod() {}</span>
<a href="#l10.45"></a><span id="l10.45" class="difflineplus">+  calPeriod const&amp; operator=(calPeriod const&amp;);</span>
<a href="#l10.46"></a><span id="l10.46"> </span>
<a href="#l10.47"></a><span id="l10.47" class="difflineminus">-    bool mImmutable;</span>
<a href="#l10.48"></a><span id="l10.48" class="difflineplus">+  bool mImmutable;</span>
<a href="#l10.49"></a><span id="l10.49"> </span>
<a href="#l10.50"></a><span id="l10.50" class="difflineminus">-    //struct icaldurationtype mPeriod;</span>
<a href="#l10.51"></a><span id="l10.51" class="difflineminus">-    nsCOMPtr&lt;calIDateTimeLibical&gt; mStart;</span>
<a href="#l10.52"></a><span id="l10.52" class="difflineminus">-    nsCOMPtr&lt;calIDateTimeLibical&gt; mEnd;</span>
<a href="#l10.53"></a><span id="l10.53" class="difflineminus">-    </span>
<a href="#l10.54"></a><span id="l10.54" class="difflineminus">-    void FromIcalPeriod(struct icalperiodtype const* icalp);</span>
<a href="#l10.55"></a><span id="l10.55" class="difflineplus">+  // struct icaldurationtype mPeriod;</span>
<a href="#l10.56"></a><span id="l10.56" class="difflineplus">+  nsCOMPtr&lt;calIDateTimeLibical&gt; mStart;</span>
<a href="#l10.57"></a><span id="l10.57" class="difflineplus">+  nsCOMPtr&lt;calIDateTimeLibical&gt; mEnd;</span>
<a href="#l10.58"></a><span id="l10.58" class="difflineplus">+</span>
<a href="#l10.59"></a><span id="l10.59" class="difflineplus">+  void FromIcalPeriod(struct icalperiodtype const* icalp);</span>
<a href="#l10.60"></a><span id="l10.60"> };</span>
<a href="#l10.61"></a><span id="l10.61"> </span>
<a href="#l10.62"></a><span id="l10.62"> #endif /* CALPERIOD_H_ */</span>
<a href="#l10.63"></a><span id="l10.63" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/calendar/base/backend/libical/calRecurrenceRule.cpp</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/calendar/base/backend/libical/calRecurrenceRule.cpp</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -15,619 +15,585 @@</span>
<a href="#l11.4"></a><span id="l11.4"> #include &quot;nsIClassInfoImpl.h&quot;</span>
<a href="#l11.5"></a><span id="l11.5"> </span>
<a href="#l11.6"></a><span id="l11.6"> #include &lt;climits&gt;</span>
<a href="#l11.7"></a><span id="l11.7"> </span>
<a href="#l11.8"></a><span id="l11.8"> NS_IMPL_CLASSINFO(calRecurrenceRule, NULL, 0, CAL_RECURRENCERULE_CID)</span>
<a href="#l11.9"></a><span id="l11.9"> NS_IMPL_ISUPPORTS_CI(calRecurrenceRule, calIRecurrenceItem, calIRecurrenceRule)</span>
<a href="#l11.10"></a><span id="l11.10"> </span>
<a href="#l11.11"></a><span id="l11.11"> calRecurrenceRule::calRecurrenceRule()</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-    : mImmutable(false),</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineminus">-      mIsNegative(false),</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineminus">-      mIsByCount(false)</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineminus">-{</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineminus">-    icalrecurrencetype_clear(&amp;mIcalRecur);</span>
<a href="#l11.17"></a><span id="l11.17" class="difflineplus">+    : mImmutable(false), mIsNegative(false), mIsByCount(false) {</span>
<a href="#l11.18"></a><span id="l11.18" class="difflineplus">+  icalrecurrencetype_clear(&amp;mIcalRecur);</span>
<a href="#l11.19"></a><span id="l11.19"> }</span>
<a href="#l11.20"></a><span id="l11.20"> </span>
<a href="#l11.21"></a><span id="l11.21"> NS_IMETHODIMP</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineminus">-calRecurrenceRule::GetIsMutable(bool *aResult)</span>
<a href="#l11.23"></a><span id="l11.23" class="difflineminus">-{</span>
<a href="#l11.24"></a><span id="l11.24" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l11.25"></a><span id="l11.25" class="difflineminus">-    *aResult = !mImmutable;</span>
<a href="#l11.26"></a><span id="l11.26" class="difflineminus">-    return NS_OK;</span>
<a href="#l11.27"></a><span id="l11.27" class="difflineplus">+calRecurrenceRule::GetIsMutable(bool *aResult) {</span>
<a href="#l11.28"></a><span id="l11.28" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l11.29"></a><span id="l11.29" class="difflineplus">+  *aResult = !mImmutable;</span>
<a href="#l11.30"></a><span id="l11.30" class="difflineplus">+  return NS_OK;</span>
<a href="#l11.31"></a><span id="l11.31"> }</span>
<a href="#l11.32"></a><span id="l11.32"> </span>
<a href="#l11.33"></a><span id="l11.33"> NS_IMETHODIMP</span>
<a href="#l11.34"></a><span id="l11.34" class="difflineminus">-calRecurrenceRule::MakeImmutable()</span>
<a href="#l11.35"></a><span id="l11.35" class="difflineminus">-{</span>
<a href="#l11.36"></a><span id="l11.36" class="difflineminus">-    mImmutable = true;</span>
<a href="#l11.37"></a><span id="l11.37" class="difflineminus">-    return NS_OK;</span>
<a href="#l11.38"></a><span id="l11.38" class="difflineplus">+calRecurrenceRule::MakeImmutable() {</span>
<a href="#l11.39"></a><span id="l11.39" class="difflineplus">+  mImmutable = true;</span>
<a href="#l11.40"></a><span id="l11.40" class="difflineplus">+  return NS_OK;</span>
<a href="#l11.41"></a><span id="l11.41"> }</span>
<a href="#l11.42"></a><span id="l11.42"> </span>
<a href="#l11.43"></a><span id="l11.43"> NS_IMETHODIMP</span>
<a href="#l11.44"></a><span id="l11.44" class="difflineminus">-calRecurrenceRule::Clone(calIRecurrenceItem **aResult)</span>
<a href="#l11.45"></a><span id="l11.45" class="difflineminus">-{</span>
<a href="#l11.46"></a><span id="l11.46" class="difflineminus">-    calRecurrenceRule * const crc = new calRecurrenceRule();</span>
<a href="#l11.47"></a><span id="l11.47" class="difflineminus">-    CAL_ENSURE_MEMORY(crc);</span>
<a href="#l11.48"></a><span id="l11.48" class="difflineplus">+calRecurrenceRule::Clone(calIRecurrenceItem **aResult) {</span>
<a href="#l11.49"></a><span id="l11.49" class="difflineplus">+  calRecurrenceRule *const crc = new calRecurrenceRule();</span>
<a href="#l11.50"></a><span id="l11.50" class="difflineplus">+  CAL_ENSURE_MEMORY(crc);</span>
<a href="#l11.51"></a><span id="l11.51"> </span>
<a href="#l11.52"></a><span id="l11.52" class="difflineminus">-    crc-&gt;mIsNegative = mIsNegative;</span>
<a href="#l11.53"></a><span id="l11.53" class="difflineminus">-    crc-&gt;mIsByCount = mIsByCount;</span>
<a href="#l11.54"></a><span id="l11.54" class="difflineminus">-    crc-&gt;mIcalRecur = mIcalRecur;</span>
<a href="#l11.55"></a><span id="l11.55" class="difflineplus">+  crc-&gt;mIsNegative = mIsNegative;</span>
<a href="#l11.56"></a><span id="l11.56" class="difflineplus">+  crc-&gt;mIsByCount = mIsByCount;</span>
<a href="#l11.57"></a><span id="l11.57" class="difflineplus">+  crc-&gt;mIcalRecur = mIcalRecur;</span>
<a href="#l11.58"></a><span id="l11.58"> </span>
<a href="#l11.59"></a><span id="l11.59" class="difflineminus">-    NS_ADDREF(*aResult = crc);</span>
<a href="#l11.60"></a><span id="l11.60" class="difflineminus">-    return NS_OK;</span>
<a href="#l11.61"></a><span id="l11.61" class="difflineplus">+  NS_ADDREF(*aResult = crc);</span>
<a href="#l11.62"></a><span id="l11.62" class="difflineplus">+  return NS_OK;</span>
<a href="#l11.63"></a><span id="l11.63"> }</span>
<a href="#l11.64"></a><span id="l11.64"> </span>
<a href="#l11.65"></a><span id="l11.65"> /* attribute boolean isNegative; */</span>
<a href="#l11.66"></a><span id="l11.66"> NS_IMETHODIMP</span>
<a href="#l11.67"></a><span id="l11.67" class="difflineminus">-calRecurrenceRule::GetIsNegative(bool *_retval)</span>
<a href="#l11.68"></a><span id="l11.68" class="difflineminus">-{</span>
<a href="#l11.69"></a><span id="l11.69" class="difflineminus">-    NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l11.70"></a><span id="l11.70" class="difflineminus">-    *_retval = mIsNegative;</span>
<a href="#l11.71"></a><span id="l11.71" class="difflineminus">-    return NS_OK;</span>
<a href="#l11.72"></a><span id="l11.72" class="difflineplus">+calRecurrenceRule::GetIsNegative(bool *_retval) {</span>
<a href="#l11.73"></a><span id="l11.73" class="difflineplus">+  NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l11.74"></a><span id="l11.74" class="difflineplus">+  *_retval = mIsNegative;</span>
<a href="#l11.75"></a><span id="l11.75" class="difflineplus">+  return NS_OK;</span>
<a href="#l11.76"></a><span id="l11.76"> }</span>
<a href="#l11.77"></a><span id="l11.77"> </span>
<a href="#l11.78"></a><span id="l11.78"> NS_IMETHODIMP</span>
<a href="#l11.79"></a><span id="l11.79" class="difflineminus">-calRecurrenceRule::SetIsNegative(bool aIsNegative)</span>
<a href="#l11.80"></a><span id="l11.80" class="difflineminus">-{</span>
<a href="#l11.81"></a><span id="l11.81" class="difflineminus">-    if (mImmutable)</span>
<a href="#l11.82"></a><span id="l11.82" class="difflineminus">-        return NS_ERROR_OBJECT_IS_IMMUTABLE;</span>
<a href="#l11.83"></a><span id="l11.83" class="difflineminus">-    mIsNegative = aIsNegative;</span>
<a href="#l11.84"></a><span id="l11.84" class="difflineminus">-    return NS_OK;</span>
<a href="#l11.85"></a><span id="l11.85" class="difflineplus">+calRecurrenceRule::SetIsNegative(bool aIsNegative) {</span>
<a href="#l11.86"></a><span id="l11.86" class="difflineplus">+  if (mImmutable) return NS_ERROR_OBJECT_IS_IMMUTABLE;</span>
<a href="#l11.87"></a><span id="l11.87" class="difflineplus">+  mIsNegative = aIsNegative;</span>
<a href="#l11.88"></a><span id="l11.88" class="difflineplus">+  return NS_OK;</span>
<a href="#l11.89"></a><span id="l11.89"> }</span>
<a href="#l11.90"></a><span id="l11.90"> </span>
<a href="#l11.91"></a><span id="l11.91"> /* readonly attribute boolean isFinite; */</span>
<a href="#l11.92"></a><span id="l11.92"> NS_IMETHODIMP</span>
<a href="#l11.93"></a><span id="l11.93" class="difflineminus">-calRecurrenceRule::GetIsFinite(bool *_retval)</span>
<a href="#l11.94"></a><span id="l11.94" class="difflineminus">-{</span>
<a href="#l11.95"></a><span id="l11.95" class="difflineminus">-    NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l11.96"></a><span id="l11.96" class="difflineplus">+calRecurrenceRule::GetIsFinite(bool *_retval) {</span>
<a href="#l11.97"></a><span id="l11.97" class="difflineplus">+  NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l11.98"></a><span id="l11.98"> </span>
<a href="#l11.99"></a><span id="l11.99" class="difflineminus">-    if ((mIsByCount &amp;&amp; mIcalRecur.count == 0) ||</span>
<a href="#l11.100"></a><span id="l11.100" class="difflineminus">-        (!mIsByCount &amp;&amp; icaltime_is_null_time(mIcalRecur.until)))</span>
<a href="#l11.101"></a><span id="l11.101" class="difflineminus">-    {</span>
<a href="#l11.102"></a><span id="l11.102" class="difflineminus">-        *_retval = false;</span>
<a href="#l11.103"></a><span id="l11.103" class="difflineminus">-    } else {</span>
<a href="#l11.104"></a><span id="l11.104" class="difflineminus">-        *_retval = true;</span>
<a href="#l11.105"></a><span id="l11.105" class="difflineminus">-    }</span>
<a href="#l11.106"></a><span id="l11.106" class="difflineminus">-    return NS_OK;</span>
<a href="#l11.107"></a><span id="l11.107" class="difflineplus">+  if ((mIsByCount &amp;&amp; mIcalRecur.count == 0) ||</span>
<a href="#l11.108"></a><span id="l11.108" class="difflineplus">+      (!mIsByCount &amp;&amp; icaltime_is_null_time(mIcalRecur.until))) {</span>
<a href="#l11.109"></a><span id="l11.109" class="difflineplus">+    *_retval = false;</span>
<a href="#l11.110"></a><span id="l11.110" class="difflineplus">+  } else {</span>
<a href="#l11.111"></a><span id="l11.111" class="difflineplus">+    *_retval = true;</span>
<a href="#l11.112"></a><span id="l11.112" class="difflineplus">+  }</span>
<a href="#l11.113"></a><span id="l11.113" class="difflineplus">+  return NS_OK;</span>
<a href="#l11.114"></a><span id="l11.114"> }</span>
<a href="#l11.115"></a><span id="l11.115"> </span>
<a href="#l11.116"></a><span id="l11.116"> /* attribute long type; */</span>
<a href="#l11.117"></a><span id="l11.117"> NS_IMETHODIMP</span>
<a href="#l11.118"></a><span id="l11.118" class="difflineminus">-calRecurrenceRule::GetType(nsACString &amp;aType)</span>
<a href="#l11.119"></a><span id="l11.119" class="difflineminus">-{</span>
<a href="#l11.120"></a><span id="l11.120" class="difflineminus">-    switch (mIcalRecur.freq) {</span>
<a href="#l11.121"></a><span id="l11.121" class="difflineminus">-#define RECUR_HELPER(x) \</span>
<a href="#l11.122"></a><span id="l11.122" class="difflineminus">-        case ICAL_##x##_RECURRENCE: aType.AssignLiteral( #x ); break</span>
<a href="#l11.123"></a><span id="l11.123" class="difflineminus">-        RECUR_HELPER(SECONDLY);</span>
<a href="#l11.124"></a><span id="l11.124" class="difflineminus">-        RECUR_HELPER(MINUTELY);</span>
<a href="#l11.125"></a><span id="l11.125" class="difflineminus">-        RECUR_HELPER(HOURLY);</span>
<a href="#l11.126"></a><span id="l11.126" class="difflineminus">-        RECUR_HELPER(DAILY);</span>
<a href="#l11.127"></a><span id="l11.127" class="difflineminus">-        RECUR_HELPER(WEEKLY);</span>
<a href="#l11.128"></a><span id="l11.128" class="difflineminus">-        RECUR_HELPER(MONTHLY);</span>
<a href="#l11.129"></a><span id="l11.129" class="difflineminus">-        RECUR_HELPER(YEARLY);</span>
<a href="#l11.130"></a><span id="l11.130" class="difflineplus">+calRecurrenceRule::GetType(nsACString &amp;aType) {</span>
<a href="#l11.131"></a><span id="l11.131" class="difflineplus">+  switch (mIcalRecur.freq) {</span>
<a href="#l11.132"></a><span id="l11.132" class="difflineplus">+#define RECUR_HELPER(x)       \</span>
<a href="#l11.133"></a><span id="l11.133" class="difflineplus">+  case ICAL_##x##_RECURRENCE: \</span>
<a href="#l11.134"></a><span id="l11.134" class="difflineplus">+    aType.AssignLiteral(#x);  \</span>
<a href="#l11.135"></a><span id="l11.135" class="difflineplus">+    break</span>
<a href="#l11.136"></a><span id="l11.136" class="difflineplus">+    RECUR_HELPER(SECONDLY);</span>
<a href="#l11.137"></a><span id="l11.137" class="difflineplus">+    RECUR_HELPER(MINUTELY);</span>
<a href="#l11.138"></a><span id="l11.138" class="difflineplus">+    RECUR_HELPER(HOURLY);</span>
<a href="#l11.139"></a><span id="l11.139" class="difflineplus">+    RECUR_HELPER(DAILY);</span>
<a href="#l11.140"></a><span id="l11.140" class="difflineplus">+    RECUR_HELPER(WEEKLY);</span>
<a href="#l11.141"></a><span id="l11.141" class="difflineplus">+    RECUR_HELPER(MONTHLY);</span>
<a href="#l11.142"></a><span id="l11.142" class="difflineplus">+    RECUR_HELPER(YEARLY);</span>
<a href="#l11.143"></a><span id="l11.143"> #undef RECUR_HELPER</span>
<a href="#l11.144"></a><span id="l11.144" class="difflineminus">-        default:</span>
<a href="#l11.145"></a><span id="l11.145" class="difflineminus">-            aType.AssignLiteral(&quot;&quot;);</span>
<a href="#l11.146"></a><span id="l11.146" class="difflineminus">-    }</span>
<a href="#l11.147"></a><span id="l11.147" class="difflineplus">+    default:</span>
<a href="#l11.148"></a><span id="l11.148" class="difflineplus">+      aType.AssignLiteral(&quot;&quot;);</span>
<a href="#l11.149"></a><span id="l11.149" class="difflineplus">+  }</span>
<a href="#l11.150"></a><span id="l11.150"> </span>
<a href="#l11.151"></a><span id="l11.151" class="difflineminus">-    return NS_OK;</span>
<a href="#l11.152"></a><span id="l11.152" class="difflineplus">+  return NS_OK;</span>
<a href="#l11.153"></a><span id="l11.153"> }</span>
<a href="#l11.154"></a><span id="l11.154"> </span>
<a href="#l11.155"></a><span id="l11.155"> NS_IMETHODIMP</span>
<a href="#l11.156"></a><span id="l11.156" class="difflineminus">-calRecurrenceRule::SetType(const nsACString &amp;aType)</span>
<a href="#l11.157"></a><span id="l11.157" class="difflineminus">-{</span>
<a href="#l11.158"></a><span id="l11.158" class="difflineplus">+calRecurrenceRule::SetType(const nsACString &amp;aType) {</span>
<a href="#l11.159"></a><span id="l11.159"> #define RECUR_HELPER(x) \</span>
<a href="#l11.160"></a><span id="l11.160" class="difflineminus">-    if (aType.EqualsLiteral( #x )) mIcalRecur.freq = ICAL_##x##_RECURRENCE</span>
<a href="#l11.161"></a><span id="l11.161" class="difflineminus">-    RECUR_HELPER(SECONDLY);</span>
<a href="#l11.162"></a><span id="l11.162" class="difflineminus">-    else RECUR_HELPER(MINUTELY);</span>
<a href="#l11.163"></a><span id="l11.163" class="difflineminus">-    else RECUR_HELPER(HOURLY);</span>
<a href="#l11.164"></a><span id="l11.164" class="difflineminus">-    else RECUR_HELPER(DAILY);</span>
<a href="#l11.165"></a><span id="l11.165" class="difflineminus">-    else RECUR_HELPER(WEEKLY);</span>
<a href="#l11.166"></a><span id="l11.166" class="difflineminus">-    else RECUR_HELPER(MONTHLY);</span>
<a href="#l11.167"></a><span id="l11.167" class="difflineminus">-    else RECUR_HELPER(YEARLY);</span>
<a href="#l11.168"></a><span id="l11.168" class="difflineplus">+  if (aType.EqualsLiteral(#x)) mIcalRecur.freq = ICAL_##x##_RECURRENCE</span>
<a href="#l11.169"></a><span id="l11.169" class="difflineplus">+  RECUR_HELPER(SECONDLY);</span>
<a href="#l11.170"></a><span id="l11.170" class="difflineplus">+  else RECUR_HELPER(MINUTELY);</span>
<a href="#l11.171"></a><span id="l11.171" class="difflineplus">+  else RECUR_HELPER(HOURLY);</span>
<a href="#l11.172"></a><span id="l11.172" class="difflineplus">+  else RECUR_HELPER(DAILY);</span>
<a href="#l11.173"></a><span id="l11.173" class="difflineplus">+  else RECUR_HELPER(WEEKLY);</span>
<a href="#l11.174"></a><span id="l11.174" class="difflineplus">+  else RECUR_HELPER(MONTHLY);</span>
<a href="#l11.175"></a><span id="l11.175" class="difflineplus">+  else RECUR_HELPER(YEARLY);</span>
<a href="#l11.176"></a><span id="l11.176"> #undef RECUR_HELPER</span>
<a href="#l11.177"></a><span id="l11.177" class="difflineminus">-    else if (aType.IsEmpty() || aType.EqualsLiteral(&quot;&quot;))</span>
<a href="#l11.178"></a><span id="l11.178" class="difflineminus">-        mIcalRecur.freq = ICAL_NO_RECURRENCE;</span>
<a href="#l11.179"></a><span id="l11.179" class="difflineminus">-    else</span>
<a href="#l11.180"></a><span id="l11.180" class="difflineminus">-        return NS_ERROR_FAILURE;</span>
<a href="#l11.181"></a><span id="l11.181" class="difflineplus">+  else if (aType.IsEmpty() || aType.EqualsLiteral(&quot;&quot;)) mIcalRecur.freq =</span>
<a href="#l11.182"></a><span id="l11.182" class="difflineplus">+      ICAL_NO_RECURRENCE;</span>
<a href="#l11.183"></a><span id="l11.183" class="difflineplus">+  else return NS_ERROR_FAILURE;</span>
<a href="#l11.184"></a><span id="l11.184"> </span>
<a href="#l11.185"></a><span id="l11.185" class="difflineminus">-    return NS_OK;</span>
<a href="#l11.186"></a><span id="l11.186" class="difflineplus">+  return NS_OK;</span>
<a href="#l11.187"></a><span id="l11.187"> }</span>
<a href="#l11.188"></a><span id="l11.188"> </span>
<a href="#l11.189"></a><span id="l11.189"> /* attribute long count; */</span>
<a href="#l11.190"></a><span id="l11.190"> NS_IMETHODIMP</span>
<a href="#l11.191"></a><span id="l11.191" class="difflineminus">-calRecurrenceRule::GetCount(int32_t *aRecurCount)</span>
<a href="#l11.192"></a><span id="l11.192" class="difflineminus">-{</span>
<a href="#l11.193"></a><span id="l11.193" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aRecurCount);</span>
<a href="#l11.194"></a><span id="l11.194" class="difflineplus">+calRecurrenceRule::GetCount(int32_t *aRecurCount) {</span>
<a href="#l11.195"></a><span id="l11.195" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aRecurCount);</span>
<a href="#l11.196"></a><span id="l11.196"> </span>
<a href="#l11.197"></a><span id="l11.197" class="difflineminus">-    if (!mIsByCount)</span>
<a href="#l11.198"></a><span id="l11.198" class="difflineminus">-        return NS_ERROR_FAILURE;</span>
<a href="#l11.199"></a><span id="l11.199" class="difflineplus">+  if (!mIsByCount) return NS_ERROR_FAILURE;</span>
<a href="#l11.200"></a><span id="l11.200"> </span>
<a href="#l11.201"></a><span id="l11.201" class="difflineminus">-    if (mIcalRecur.count == 0 &amp;&amp; icaltime_is_null_time(mIcalRecur.until)) {</span>
<a href="#l11.202"></a><span id="l11.202" class="difflineminus">-        *aRecurCount = -1;</span>
<a href="#l11.203"></a><span id="l11.203" class="difflineminus">-    } else if (mIcalRecur.count) {</span>
<a href="#l11.204"></a><span id="l11.204" class="difflineminus">-        *aRecurCount = mIcalRecur.count;</span>
<a href="#l11.205"></a><span id="l11.205" class="difflineminus">-    } else {</span>
<a href="#l11.206"></a><span id="l11.206" class="difflineminus">-        // count wasn't set, so we don't know</span>
<a href="#l11.207"></a><span id="l11.207" class="difflineminus">-        return NS_ERROR_FAILURE;</span>
<a href="#l11.208"></a><span id="l11.208" class="difflineminus">-    }</span>
<a href="#l11.209"></a><span id="l11.209" class="difflineplus">+  if (mIcalRecur.count == 0 &amp;&amp; icaltime_is_null_time(mIcalRecur.until)) {</span>
<a href="#l11.210"></a><span id="l11.210" class="difflineplus">+    *aRecurCount = -1;</span>
<a href="#l11.211"></a><span id="l11.211" class="difflineplus">+  } else if (mIcalRecur.count) {</span>
<a href="#l11.212"></a><span id="l11.212" class="difflineplus">+    *aRecurCount = mIcalRecur.count;</span>
<a href="#l11.213"></a><span id="l11.213" class="difflineplus">+  } else {</span>
<a href="#l11.214"></a><span id="l11.214" class="difflineplus">+    // count wasn't set, so we don't know</span>
<a href="#l11.215"></a><span id="l11.215" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l11.216"></a><span id="l11.216" class="difflineplus">+  }</span>
<a href="#l11.217"></a><span id="l11.217"> </span>
<a href="#l11.218"></a><span id="l11.218" class="difflineminus">-    return NS_OK;</span>
<a href="#l11.219"></a><span id="l11.219" class="difflineplus">+  return NS_OK;</span>
<a href="#l11.220"></a><span id="l11.220"> }</span>
<a href="#l11.221"></a><span id="l11.221"> </span>
<a href="#l11.222"></a><span id="l11.222"> NS_IMETHODIMP</span>
<a href="#l11.223"></a><span id="l11.223" class="difflineminus">-calRecurrenceRule::SetCount(int32_t aRecurCount)</span>
<a href="#l11.224"></a><span id="l11.224" class="difflineminus">-{</span>
<a href="#l11.225"></a><span id="l11.225" class="difflineminus">-    if (aRecurCount != -1) {</span>
<a href="#l11.226"></a><span id="l11.226" class="difflineminus">-        if (aRecurCount &lt; 0 || aRecurCount &gt; INT_MAX)</span>
<a href="#l11.227"></a><span id="l11.227" class="difflineminus">-            return NS_ERROR_ILLEGAL_VALUE;</span>
<a href="#l11.228"></a><span id="l11.228" class="difflineminus">-        mIcalRecur.count = static_cast&lt;int&gt;(aRecurCount);</span>
<a href="#l11.229"></a><span id="l11.229" class="difflineminus">-        mIsByCount = true;</span>
<a href="#l11.230"></a><span id="l11.230" class="difflineminus">-    } else {</span>
<a href="#l11.231"></a><span id="l11.231" class="difflineminus">-        mIcalRecur.count = 0;</span>
<a href="#l11.232"></a><span id="l11.232" class="difflineminus">-        mIsByCount = false;</span>
<a href="#l11.233"></a><span id="l11.233" class="difflineminus">-    }</span>
<a href="#l11.234"></a><span id="l11.234" class="difflineplus">+calRecurrenceRule::SetCount(int32_t aRecurCount) {</span>
<a href="#l11.235"></a><span id="l11.235" class="difflineplus">+  if (aRecurCount != -1) {</span>
<a href="#l11.236"></a><span id="l11.236" class="difflineplus">+    if (aRecurCount &lt; 0 || aRecurCount &gt; INT_MAX) return NS_ERROR_ILLEGAL_VALUE;</span>
<a href="#l11.237"></a><span id="l11.237" class="difflineplus">+    mIcalRecur.count = static_cast&lt;int&gt;(aRecurCount);</span>
<a href="#l11.238"></a><span id="l11.238" class="difflineplus">+    mIsByCount = true;</span>
<a href="#l11.239"></a><span id="l11.239" class="difflineplus">+  } else {</span>
<a href="#l11.240"></a><span id="l11.240" class="difflineplus">+    mIcalRecur.count = 0;</span>
<a href="#l11.241"></a><span id="l11.241" class="difflineplus">+    mIsByCount = false;</span>
<a href="#l11.242"></a><span id="l11.242" class="difflineplus">+  }</span>
<a href="#l11.243"></a><span id="l11.243"> </span>
<a href="#l11.244"></a><span id="l11.244" class="difflineminus">-    mIcalRecur.until = icaltime_null_time();</span>
<a href="#l11.245"></a><span id="l11.245" class="difflineplus">+  mIcalRecur.until = icaltime_null_time();</span>
<a href="#l11.246"></a><span id="l11.246"> </span>
<a href="#l11.247"></a><span id="l11.247" class="difflineminus">-</span>
<a href="#l11.248"></a><span id="l11.248" class="difflineminus">-    return NS_OK;</span>
<a href="#l11.249"></a><span id="l11.249" class="difflineplus">+  return NS_OK;</span>
<a href="#l11.250"></a><span id="l11.250"> }</span>
<a href="#l11.251"></a><span id="l11.251"> </span>
<a href="#l11.252"></a><span id="l11.252"> /* attribute calIDateTime untilDate; */</span>
<a href="#l11.253"></a><span id="l11.253"> NS_IMETHODIMP</span>
<a href="#l11.254"></a><span id="l11.254" class="difflineminus">-calRecurrenceRule::GetUntilDate(calIDateTime * *aRecurEnd)</span>
<a href="#l11.255"></a><span id="l11.255" class="difflineminus">-{</span>
<a href="#l11.256"></a><span id="l11.256" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aRecurEnd);</span>
<a href="#l11.257"></a><span id="l11.257" class="difflineplus">+calRecurrenceRule::GetUntilDate(calIDateTime **aRecurEnd) {</span>
<a href="#l11.258"></a><span id="l11.258" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aRecurEnd);</span>
<a href="#l11.259"></a><span id="l11.259"> </span>
<a href="#l11.260"></a><span id="l11.260" class="difflineminus">-    if (mIsByCount)</span>
<a href="#l11.261"></a><span id="l11.261" class="difflineminus">-        return NS_ERROR_FAILURE;</span>
<a href="#l11.262"></a><span id="l11.262" class="difflineplus">+  if (mIsByCount) return NS_ERROR_FAILURE;</span>
<a href="#l11.263"></a><span id="l11.263"> </span>
<a href="#l11.264"></a><span id="l11.264" class="difflineminus">-    if (!icaltime_is_null_time(mIcalRecur.until)) {</span>
<a href="#l11.265"></a><span id="l11.265" class="difflineminus">-        *aRecurEnd = new calDateTime(&amp;mIcalRecur.until, nullptr);</span>
<a href="#l11.266"></a><span id="l11.266" class="difflineminus">-        CAL_ENSURE_MEMORY(*aRecurEnd);</span>
<a href="#l11.267"></a><span id="l11.267" class="difflineminus">-        NS_ADDREF(*aRecurEnd);</span>
<a href="#l11.268"></a><span id="l11.268" class="difflineminus">-    } else {</span>
<a href="#l11.269"></a><span id="l11.269" class="difflineminus">-        // infinite recurrence</span>
<a href="#l11.270"></a><span id="l11.270" class="difflineminus">-        *aRecurEnd = nullptr;</span>
<a href="#l11.271"></a><span id="l11.271" class="difflineminus">-    }</span>
<a href="#l11.272"></a><span id="l11.272" class="difflineminus">-    return NS_OK;</span>
<a href="#l11.273"></a><span id="l11.273" class="difflineplus">+  if (!icaltime_is_null_time(mIcalRecur.until)) {</span>
<a href="#l11.274"></a><span id="l11.274" class="difflineplus">+    *aRecurEnd = new calDateTime(&amp;mIcalRecur.until, nullptr);</span>
<a href="#l11.275"></a><span id="l11.275" class="difflineplus">+    CAL_ENSURE_MEMORY(*aRecurEnd);</span>
<a href="#l11.276"></a><span id="l11.276" class="difflineplus">+    NS_ADDREF(*aRecurEnd);</span>
<a href="#l11.277"></a><span id="l11.277" class="difflineplus">+  } else {</span>
<a href="#l11.278"></a><span id="l11.278" class="difflineplus">+    // infinite recurrence</span>
<a href="#l11.279"></a><span id="l11.279" class="difflineplus">+    *aRecurEnd = nullptr;</span>
<a href="#l11.280"></a><span id="l11.280" class="difflineplus">+  }</span>
<a href="#l11.281"></a><span id="l11.281" class="difflineplus">+  return NS_OK;</span>
<a href="#l11.282"></a><span id="l11.282"> }</span>
<a href="#l11.283"></a><span id="l11.283"> </span>
<a href="#l11.284"></a><span id="l11.284"> NS_IMETHODIMP</span>
<a href="#l11.285"></a><span id="l11.285" class="difflineminus">-calRecurrenceRule::SetUntilDate(calIDateTime * aRecurEnd)</span>
<a href="#l11.286"></a><span id="l11.286" class="difflineminus">-{</span>
<a href="#l11.287"></a><span id="l11.287" class="difflineminus">-    if (aRecurEnd) {</span>
<a href="#l11.288"></a><span id="l11.288" class="difflineminus">-        nsresult rv;</span>
<a href="#l11.289"></a><span id="l11.289" class="difflineminus">-        bool b;</span>
<a href="#l11.290"></a><span id="l11.290" class="difflineminus">-        nsCOMPtr&lt;calIDateTimeLibical&gt; icaldt;</span>
<a href="#l11.291"></a><span id="l11.291" class="difflineminus">-        nsCOMPtr&lt;calITimezone&gt; tz;</span>
<a href="#l11.292"></a><span id="l11.292" class="difflineminus">-        aRecurEnd-&gt;GetTimezone(getter_AddRefs(tz));</span>
<a href="#l11.293"></a><span id="l11.293" class="difflineplus">+calRecurrenceRule::SetUntilDate(calIDateTime *aRecurEnd) {</span>
<a href="#l11.294"></a><span id="l11.294" class="difflineplus">+  if (aRecurEnd) {</span>
<a href="#l11.295"></a><span id="l11.295" class="difflineplus">+    nsresult rv;</span>
<a href="#l11.296"></a><span id="l11.296" class="difflineplus">+    bool b;</span>
<a href="#l11.297"></a><span id="l11.297" class="difflineplus">+    nsCOMPtr&lt;calIDateTimeLibical&gt; icaldt;</span>
<a href="#l11.298"></a><span id="l11.298" class="difflineplus">+    nsCOMPtr&lt;calITimezone&gt; tz;</span>
<a href="#l11.299"></a><span id="l11.299" class="difflineplus">+    aRecurEnd-&gt;GetTimezone(getter_AddRefs(tz));</span>
<a href="#l11.300"></a><span id="l11.300"> </span>
<a href="#l11.301"></a><span id="l11.301" class="difflineminus">-        if (NS_SUCCEEDED(tz-&gt;GetIsUTC(&amp;b)) &amp;&amp; !b &amp;&amp;</span>
<a href="#l11.302"></a><span id="l11.302" class="difflineminus">-            NS_SUCCEEDED(tz-&gt;GetIsFloating(&amp;b)) &amp;&amp; !b) {</span>
<a href="#l11.303"></a><span id="l11.303" class="difflineminus">-            // convert to UTC:</span>
<a href="#l11.304"></a><span id="l11.304" class="difflineminus">-            nsCOMPtr&lt;calIDateTime&gt; dt;</span>
<a href="#l11.305"></a><span id="l11.305" class="difflineminus">-            nsCOMPtr&lt;calITimezone&gt; ctz = cal::UTC();</span>
<a href="#l11.306"></a><span id="l11.306" class="difflineminus">-            aRecurEnd-&gt;GetInTimezone(ctz, getter_AddRefs(dt));</span>
<a href="#l11.307"></a><span id="l11.307" class="difflineminus">-            icaldt = do_QueryInterface(dt, &amp;rv);</span>
<a href="#l11.308"></a><span id="l11.308" class="difflineminus">-        } else {</span>
<a href="#l11.309"></a><span id="l11.309" class="difflineminus">-            icaldt = do_QueryInterface(aRecurEnd, &amp;rv);</span>
<a href="#l11.310"></a><span id="l11.310" class="difflineminus">-        }</span>
<a href="#l11.311"></a><span id="l11.311" class="difflineminus">-</span>
<a href="#l11.312"></a><span id="l11.312" class="difflineminus">-        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.313"></a><span id="l11.313" class="difflineminus">-        struct icaltimetype itt;</span>
<a href="#l11.314"></a><span id="l11.314" class="difflineminus">-        icaldt-&gt;ToIcalTime(&amp;itt);</span>
<a href="#l11.315"></a><span id="l11.315" class="difflineminus">-</span>
<a href="#l11.316"></a><span id="l11.316" class="difflineminus">-        mIcalRecur.until = itt;</span>
<a href="#l11.317"></a><span id="l11.317" class="difflineplus">+    if (NS_SUCCEEDED(tz-&gt;GetIsUTC(&amp;b)) &amp;&amp; !b &amp;&amp;</span>
<a href="#l11.318"></a><span id="l11.318" class="difflineplus">+        NS_SUCCEEDED(tz-&gt;GetIsFloating(&amp;b)) &amp;&amp; !b) {</span>
<a href="#l11.319"></a><span id="l11.319" class="difflineplus">+      // convert to UTC:</span>
<a href="#l11.320"></a><span id="l11.320" class="difflineplus">+      nsCOMPtr&lt;calIDateTime&gt; dt;</span>
<a href="#l11.321"></a><span id="l11.321" class="difflineplus">+      nsCOMPtr&lt;calITimezone&gt; ctz = cal::UTC();</span>
<a href="#l11.322"></a><span id="l11.322" class="difflineplus">+      aRecurEnd-&gt;GetInTimezone(ctz, getter_AddRefs(dt));</span>
<a href="#l11.323"></a><span id="l11.323" class="difflineplus">+      icaldt = do_QueryInterface(dt, &amp;rv);</span>
<a href="#l11.324"></a><span id="l11.324">     } else {</span>
<a href="#l11.325"></a><span id="l11.325" class="difflineminus">-        mIcalRecur.until = icaltime_null_time();</span>
<a href="#l11.326"></a><span id="l11.326" class="difflineplus">+      icaldt = do_QueryInterface(aRecurEnd, &amp;rv);</span>
<a href="#l11.327"></a><span id="l11.327">     }</span>
<a href="#l11.328"></a><span id="l11.328"> </span>
<a href="#l11.329"></a><span id="l11.329" class="difflineminus">-    mIcalRecur.count = 0;</span>
<a href="#l11.330"></a><span id="l11.330" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.331"></a><span id="l11.331" class="difflineplus">+    struct icaltimetype itt;</span>
<a href="#l11.332"></a><span id="l11.332" class="difflineplus">+    icaldt-&gt;ToIcalTime(&amp;itt);</span>
<a href="#l11.333"></a><span id="l11.333"> </span>
<a href="#l11.334"></a><span id="l11.334" class="difflineminus">-    mIsByCount = false;</span>
<a href="#l11.335"></a><span id="l11.335" class="difflineplus">+    mIcalRecur.until = itt;</span>
<a href="#l11.336"></a><span id="l11.336" class="difflineplus">+  } else {</span>
<a href="#l11.337"></a><span id="l11.337" class="difflineplus">+    mIcalRecur.until = icaltime_null_time();</span>
<a href="#l11.338"></a><span id="l11.338" class="difflineplus">+  }</span>
<a href="#l11.339"></a><span id="l11.339"> </span>
<a href="#l11.340"></a><span id="l11.340" class="difflineminus">-    return NS_OK;</span>
<a href="#l11.341"></a><span id="l11.341" class="difflineplus">+  mIcalRecur.count = 0;</span>
<a href="#l11.342"></a><span id="l11.342" class="difflineplus">+</span>
<a href="#l11.343"></a><span id="l11.343" class="difflineplus">+  mIsByCount = false;</span>
<a href="#l11.344"></a><span id="l11.344" class="difflineplus">+</span>
<a href="#l11.345"></a><span id="l11.345" class="difflineplus">+  return NS_OK;</span>
<a href="#l11.346"></a><span id="l11.346"> }</span>
<a href="#l11.347"></a><span id="l11.347"> </span>
<a href="#l11.348"></a><span id="l11.348"> /* readonly attribute boolean isByCount; */</span>
<a href="#l11.349"></a><span id="l11.349"> NS_IMETHODIMP</span>
<a href="#l11.350"></a><span id="l11.350" class="difflineminus">-calRecurrenceRule::GetIsByCount (bool *aIsByCount)</span>
<a href="#l11.351"></a><span id="l11.351" class="difflineminus">-{</span>
<a href="#l11.352"></a><span id="l11.352" class="difflineminus">-    *aIsByCount = mIsByCount;</span>
<a href="#l11.353"></a><span id="l11.353" class="difflineminus">-    return NS_OK;</span>
<a href="#l11.354"></a><span id="l11.354" class="difflineplus">+calRecurrenceRule::GetIsByCount(bool *aIsByCount) {</span>
<a href="#l11.355"></a><span id="l11.355" class="difflineplus">+  *aIsByCount = mIsByCount;</span>
<a href="#l11.356"></a><span id="l11.356" class="difflineplus">+  return NS_OK;</span>
<a href="#l11.357"></a><span id="l11.357"> }</span>
<a href="#l11.358"></a><span id="l11.358"> </span>
<a href="#l11.359"></a><span id="l11.359"> /* attribute long interval; */</span>
<a href="#l11.360"></a><span id="l11.360"> NS_IMETHODIMP</span>
<a href="#l11.361"></a><span id="l11.361" class="difflineminus">-calRecurrenceRule::GetInterval(int32_t *aInterval)</span>
<a href="#l11.362"></a><span id="l11.362" class="difflineminus">-{</span>
<a href="#l11.363"></a><span id="l11.363" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aInterval);</span>
<a href="#l11.364"></a><span id="l11.364" class="difflineminus">-    *aInterval = mIcalRecur.interval;</span>
<a href="#l11.365"></a><span id="l11.365" class="difflineminus">-    return NS_OK;</span>
<a href="#l11.366"></a><span id="l11.366" class="difflineplus">+calRecurrenceRule::GetInterval(int32_t *aInterval) {</span>
<a href="#l11.367"></a><span id="l11.367" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aInterval);</span>
<a href="#l11.368"></a><span id="l11.368" class="difflineplus">+  *aInterval = mIcalRecur.interval;</span>
<a href="#l11.369"></a><span id="l11.369" class="difflineplus">+  return NS_OK;</span>
<a href="#l11.370"></a><span id="l11.370"> }</span>
<a href="#l11.371"></a><span id="l11.371"> </span>
<a href="#l11.372"></a><span id="l11.372"> NS_IMETHODIMP</span>
<a href="#l11.373"></a><span id="l11.373" class="difflineminus">-calRecurrenceRule::SetInterval(int32_t aInterval)</span>
<a href="#l11.374"></a><span id="l11.374" class="difflineminus">-{</span>
<a href="#l11.375"></a><span id="l11.375" class="difflineminus">-    if (aInterval &lt; 0 || aInterval &gt; SHRT_MAX)</span>
<a href="#l11.376"></a><span id="l11.376" class="difflineminus">-        return NS_ERROR_ILLEGAL_VALUE;</span>
<a href="#l11.377"></a><span id="l11.377" class="difflineminus">-    mIcalRecur.interval = static_cast&lt;short&gt;(aInterval);</span>
<a href="#l11.378"></a><span id="l11.378" class="difflineminus">-    return NS_OK;</span>
<a href="#l11.379"></a><span id="l11.379" class="difflineplus">+calRecurrenceRule::SetInterval(int32_t aInterval) {</span>
<a href="#l11.380"></a><span id="l11.380" class="difflineplus">+  if (aInterval &lt; 0 || aInterval &gt; SHRT_MAX) return NS_ERROR_ILLEGAL_VALUE;</span>
<a href="#l11.381"></a><span id="l11.381" class="difflineplus">+  mIcalRecur.interval = static_cast&lt;short&gt;(aInterval);</span>
<a href="#l11.382"></a><span id="l11.382" class="difflineplus">+  return NS_OK;</span>
<a href="#l11.383"></a><span id="l11.383"> }</span>
<a href="#l11.384"></a><span id="l11.384"> </span>
<a href="#l11.385"></a><span id="l11.385" class="difflineminus">-/* void getComponent (in AUTF8String aComponentType, out unsigned long aCount, [array, size_is (aCount), retval] out long aValues); */</span>
<a href="#l11.386"></a><span id="l11.386" class="difflineplus">+/* void getComponent (in AUTF8String aComponentType, out unsigned long aCount,</span>
<a href="#l11.387"></a><span id="l11.387" class="difflineplus">+ * [array, size_is (aCount), retval] out long aValues); */</span>
<a href="#l11.388"></a><span id="l11.388"> NS_IMETHODIMP</span>
<a href="#l11.389"></a><span id="l11.389" class="difflineminus">-calRecurrenceRule::GetComponent(const nsACString &amp;aComponentType, uint32_t *aCount, int16_t **aValues)</span>
<a href="#l11.390"></a><span id="l11.390" class="difflineminus">-{</span>
<a href="#l11.391"></a><span id="l11.391" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aCount);</span>
<a href="#l11.392"></a><span id="l11.392" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aValues);</span>
<a href="#l11.393"></a><span id="l11.393" class="difflineplus">+calRecurrenceRule::GetComponent(const nsACString &amp;aComponentType,</span>
<a href="#l11.394"></a><span id="l11.394" class="difflineplus">+                                uint32_t *aCount, int16_t **aValues) {</span>
<a href="#l11.395"></a><span id="l11.395" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aCount);</span>
<a href="#l11.396"></a><span id="l11.396" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aValues);</span>
<a href="#l11.397"></a><span id="l11.397"> </span>
<a href="#l11.398"></a><span id="l11.398" class="difflineminus">-    // This little ugly macro counts the number of real entries</span>
<a href="#l11.399"></a><span id="l11.399" class="difflineminus">-    // we have in the relevant array, and then clones it to the result.</span>
<a href="#l11.400"></a><span id="l11.400" class="difflineminus">-#define HANDLE_COMPONENT(_comptype,_icalvar,_icalmax)                   \</span>
<a href="#l11.401"></a><span id="l11.401" class="difflineminus">-    if (aComponentType.EqualsLiteral( #_comptype )) {                    \</span>
<a href="#l11.402"></a><span id="l11.402" class="difflineminus">-        int count;                                                      \</span>
<a href="#l11.403"></a><span id="l11.403" class="difflineminus">-        for (count = 0; count &lt; _icalmax; count++) {                    \</span>
<a href="#l11.404"></a><span id="l11.404" class="difflineminus">-            if (mIcalRecur._icalvar[count] == ICAL_RECURRENCE_ARRAY_MAX) \</span>
<a href="#l11.405"></a><span id="l11.405" class="difflineminus">-                break;                                                  \</span>
<a href="#l11.406"></a><span id="l11.406" class="difflineminus">-        }                                                               \</span>
<a href="#l11.407"></a><span id="l11.407" class="difflineminus">-        if (count) {                                                    \</span>
<a href="#l11.408"></a><span id="l11.408" class="difflineminus">-            *aValues = (int16_t*) moz_xmemdup(mIcalRecur._icalvar,      \</span>
<a href="#l11.409"></a><span id="l11.409" class="difflineminus">-                                              count * sizeof(int16_t)); \</span>
<a href="#l11.410"></a><span id="l11.410" class="difflineminus">-            if (!*aValues) return NS_ERROR_OUT_OF_MEMORY;               \</span>
<a href="#l11.411"></a><span id="l11.411" class="difflineminus">-        } else {                                                        \</span>
<a href="#l11.412"></a><span id="l11.412" class="difflineminus">-            *aValues = nullptr;                                          \</span>
<a href="#l11.413"></a><span id="l11.413" class="difflineminus">-        }                                                               \</span>
<a href="#l11.414"></a><span id="l11.414" class="difflineminus">-        *aCount = count;                                                \</span>
<a href="#l11.415"></a><span id="l11.415" class="difflineminus">-    }</span>
<a href="#l11.416"></a><span id="l11.416" class="difflineplus">+  // This little ugly macro counts the number of real entries</span>
<a href="#l11.417"></a><span id="l11.417" class="difflineplus">+  // we have in the relevant array, and then clones it to the result.</span>
<a href="#l11.418"></a><span id="l11.418" class="difflineplus">+#define HANDLE_COMPONENT(_comptype, _icalvar, _icalmax)                   \</span>
<a href="#l11.419"></a><span id="l11.419" class="difflineplus">+  if (aComponentType.EqualsLiteral(#_comptype)) {                         \</span>
<a href="#l11.420"></a><span id="l11.420" class="difflineplus">+    int count;                                                            \</span>
<a href="#l11.421"></a><span id="l11.421" class="difflineplus">+    for (count = 0; count &lt; _icalmax; count++) {                          \</span>
<a href="#l11.422"></a><span id="l11.422" class="difflineplus">+      if (mIcalRecur._icalvar[count] == ICAL_RECURRENCE_ARRAY_MAX) break; \</span>
<a href="#l11.423"></a><span id="l11.423" class="difflineplus">+    }                                                                     \</span>
<a href="#l11.424"></a><span id="l11.424" class="difflineplus">+    if (count) {                                                          \</span>
<a href="#l11.425"></a><span id="l11.425" class="difflineplus">+      *aValues = (int16_t *)moz_xmemdup(mIcalRecur._icalvar,              \</span>
<a href="#l11.426"></a><span id="l11.426" class="difflineplus">+                                        count * sizeof(int16_t));         \</span>
<a href="#l11.427"></a><span id="l11.427" class="difflineplus">+      if (!*aValues) return NS_ERROR_OUT_OF_MEMORY;                       \</span>
<a href="#l11.428"></a><span id="l11.428" class="difflineplus">+    } else {                                                              \</span>
<a href="#l11.429"></a><span id="l11.429" class="difflineplus">+      *aValues = nullptr;                                                 \</span>
<a href="#l11.430"></a><span id="l11.430" class="difflineplus">+    }                                                                     \</span>
<a href="#l11.431"></a><span id="l11.431" class="difflineplus">+    *aCount = count;                                                      \</span>
<a href="#l11.432"></a><span id="l11.432" class="difflineplus">+  }</span>
<a href="#l11.433"></a><span id="l11.433"> </span>
<a href="#l11.434"></a><span id="l11.434" class="difflineminus">-    HANDLE_COMPONENT(BYSECOND, by_second, ICAL_BY_SECOND_SIZE)</span>
<a href="#l11.435"></a><span id="l11.435" class="difflineminus">-    else HANDLE_COMPONENT(BYMINUTE, by_minute, ICAL_BY_MINUTE_SIZE)</span>
<a href="#l11.436"></a><span id="l11.436" class="difflineminus">-    else HANDLE_COMPONENT(BYHOUR, by_hour, ICAL_BY_HOUR_SIZE)</span>
<a href="#l11.437"></a><span id="l11.437" class="difflineminus">-    else HANDLE_COMPONENT(BYDAY, by_day, ICAL_BY_DAY_SIZE) // special</span>
<a href="#l11.438"></a><span id="l11.438" class="difflineminus">-    else HANDLE_COMPONENT(BYMONTHDAY, by_month_day, ICAL_BY_MONTHDAY_SIZE)</span>
<a href="#l11.439"></a><span id="l11.439" class="difflineminus">-    else HANDLE_COMPONENT(BYYEARDAY, by_year_day, ICAL_BY_YEARDAY_SIZE)</span>
<a href="#l11.440"></a><span id="l11.440" class="difflineminus">-    else HANDLE_COMPONENT(BYWEEKNO, by_week_no, ICAL_BY_WEEKNO_SIZE)</span>
<a href="#l11.441"></a><span id="l11.441" class="difflineminus">-    else HANDLE_COMPONENT(BYMONTH, by_month, ICAL_BY_MONTH_SIZE)</span>
<a href="#l11.442"></a><span id="l11.442" class="difflineminus">-    else HANDLE_COMPONENT(BYSETPOS, by_set_pos, ICAL_BY_SETPOS_SIZE)</span>
<a href="#l11.443"></a><span id="l11.443" class="difflineminus">-    else {</span>
<a href="#l11.444"></a><span id="l11.444" class="difflineminus">-        // invalid component; XXX - error code</span>
<a href="#l11.445"></a><span id="l11.445" class="difflineminus">-        return NS_ERROR_FAILURE;</span>
<a href="#l11.446"></a><span id="l11.446" class="difflineminus">-    }</span>
<a href="#l11.447"></a><span id="l11.447" class="difflineplus">+  HANDLE_COMPONENT(BYSECOND, by_second, ICAL_BY_SECOND_SIZE)</span>
<a href="#l11.448"></a><span id="l11.448" class="difflineplus">+  else HANDLE_COMPONENT(BYMINUTE, by_minute, ICAL_BY_MINUTE_SIZE) else HANDLE_COMPONENT(</span>
<a href="#l11.449"></a><span id="l11.449" class="difflineplus">+      BYHOUR, by_hour,</span>
<a href="#l11.450"></a><span id="l11.450" class="difflineplus">+      ICAL_BY_HOUR_SIZE) else HANDLE_COMPONENT(BYDAY, by_day,</span>
<a href="#l11.451"></a><span id="l11.451" class="difflineplus">+                                               ICAL_BY_DAY_SIZE)  // special</span>
<a href="#l11.452"></a><span id="l11.452" class="difflineplus">+      else HANDLE_COMPONENT(BYMONTHDAY, by_month_day, ICAL_BY_MONTHDAY_SIZE) else HANDLE_COMPONENT(BYYEARDAY, by_year_day, ICAL_BY_YEARDAY_SIZE) else HANDLE_COMPONENT(</span>
<a href="#l11.453"></a><span id="l11.453" class="difflineplus">+          BYWEEKNO, by_week_no,</span>
<a href="#l11.454"></a><span id="l11.454" class="difflineplus">+          ICAL_BY_WEEKNO_SIZE) else HANDLE_COMPONENT(BYMONTH, by_month,</span>
<a href="#l11.455"></a><span id="l11.455" class="difflineplus">+                                                     ICAL_BY_MONTH_SIZE) else HANDLE_COMPONENT(BYSETPOS,</span>
<a href="#l11.456"></a><span id="l11.456" class="difflineplus">+                                                                                               by_set_pos,</span>
<a href="#l11.457"></a><span id="l11.457" class="difflineplus">+                                                                                               ICAL_BY_SETPOS_SIZE) else {</span>
<a href="#l11.458"></a><span id="l11.458" class="difflineplus">+    // invalid component; XXX - error code</span>
<a href="#l11.459"></a><span id="l11.459" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l11.460"></a><span id="l11.460" class="difflineplus">+  }</span>
<a href="#l11.461"></a><span id="l11.461"> #undef HANDLE_COMPONENT</span>
<a href="#l11.462"></a><span id="l11.462"> </span>
<a href="#l11.463"></a><span id="l11.463" class="difflineminus">-    return NS_OK;</span>
<a href="#l11.464"></a><span id="l11.464" class="difflineplus">+  return NS_OK;</span>
<a href="#l11.465"></a><span id="l11.465"> }</span>
<a href="#l11.466"></a><span id="l11.466"> </span>
<a href="#l11.467"></a><span id="l11.467" class="difflineminus">-/* void setComponent (in AUTF8String aComponentType, in unsigned long aCount, [array, size_is (aCount)] in long aValues); */</span>
<a href="#l11.468"></a><span id="l11.468" class="difflineplus">+/* void setComponent (in AUTF8String aComponentType, in unsigned long aCount,</span>
<a href="#l11.469"></a><span id="l11.469" class="difflineplus">+ * [array, size_is (aCount)] in long aValues); */</span>
<a href="#l11.470"></a><span id="l11.470"> NS_IMETHODIMP</span>
<a href="#l11.471"></a><span id="l11.471" class="difflineminus">-calRecurrenceRule::SetComponent(const nsACString&amp; aComponentType, uint32_t aCount, int16_t *aValues)</span>
<a href="#l11.472"></a><span id="l11.472" class="difflineminus">-{</span>
<a href="#l11.473"></a><span id="l11.473" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aValues);</span>
<a href="#l11.474"></a><span id="l11.474" class="difflineplus">+calRecurrenceRule::SetComponent(const nsACString &amp;aComponentType,</span>
<a href="#l11.475"></a><span id="l11.475" class="difflineplus">+                                uint32_t aCount, int16_t *aValues) {</span>
<a href="#l11.476"></a><span id="l11.476" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aValues);</span>
<a href="#l11.477"></a><span id="l11.477"> </span>
<a href="#l11.478"></a><span id="l11.478" class="difflineminus">-    // Copy the passed-in array into the ical structure array</span>
<a href="#l11.479"></a><span id="l11.479" class="difflineminus">-#define HANDLE_COMPONENT(_comptype,_icalvar,_icalmax)                   \</span>
<a href="#l11.480"></a><span id="l11.480" class="difflineminus">-    if (aComponentType.EqualsLiteral( #_comptype )) {                    \</span>
<a href="#l11.481"></a><span id="l11.481" class="difflineminus">-        if (aCount &gt; _icalmax)                                          \</span>
<a href="#l11.482"></a><span id="l11.482" class="difflineminus">-            return NS_ERROR_FAILURE;                                    \</span>
<a href="#l11.483"></a><span id="l11.483" class="difflineminus">-        memcpy(mIcalRecur._icalvar, aValues, aCount * sizeof(int16_t)); \</span>
<a href="#l11.484"></a><span id="l11.484" class="difflineminus">-        if (aCount &lt; _icalmax)                                          \</span>
<a href="#l11.485"></a><span id="l11.485" class="difflineminus">-            mIcalRecur._icalvar[aCount] = ICAL_RECURRENCE_ARRAY_MAX;    \</span>
<a href="#l11.486"></a><span id="l11.486" class="difflineminus">-    }</span>
<a href="#l11.487"></a><span id="l11.487" class="difflineplus">+  // Copy the passed-in array into the ical structure array</span>
<a href="#l11.488"></a><span id="l11.488" class="difflineplus">+#define HANDLE_COMPONENT(_comptype, _icalvar, _icalmax)             \</span>
<a href="#l11.489"></a><span id="l11.489" class="difflineplus">+  if (aComponentType.EqualsLiteral(#_comptype)) {                   \</span>
<a href="#l11.490"></a><span id="l11.490" class="difflineplus">+    if (aCount &gt; _icalmax) return NS_ERROR_FAILURE;                 \</span>
<a href="#l11.491"></a><span id="l11.491" class="difflineplus">+    memcpy(mIcalRecur._icalvar, aValues, aCount * sizeof(int16_t)); \</span>
<a href="#l11.492"></a><span id="l11.492" class="difflineplus">+    if (aCount &lt; _icalmax)                                          \</span>
<a href="#l11.493"></a><span id="l11.493" class="difflineplus">+      mIcalRecur._icalvar[aCount] = ICAL_RECURRENCE_ARRAY_MAX;      \</span>
<a href="#l11.494"></a><span id="l11.494" class="difflineplus">+  }</span>
<a href="#l11.495"></a><span id="l11.495"> </span>
<a href="#l11.496"></a><span id="l11.496" class="difflineminus">-    HANDLE_COMPONENT(BYSECOND, by_second, ICAL_BY_SECOND_SIZE)</span>
<a href="#l11.497"></a><span id="l11.497" class="difflineminus">-    else HANDLE_COMPONENT(BYMINUTE, by_minute, ICAL_BY_MINUTE_SIZE)</span>
<a href="#l11.498"></a><span id="l11.498" class="difflineminus">-    else HANDLE_COMPONENT(BYHOUR, by_hour, ICAL_BY_HOUR_SIZE)</span>
<a href="#l11.499"></a><span id="l11.499" class="difflineminus">-    else HANDLE_COMPONENT(BYDAY, by_day, ICAL_BY_DAY_SIZE) // special</span>
<a href="#l11.500"></a><span id="l11.500" class="difflineminus">-    else HANDLE_COMPONENT(BYMONTHDAY, by_month_day, ICAL_BY_MONTHDAY_SIZE)</span>
<a href="#l11.501"></a><span id="l11.501" class="difflineminus">-    else HANDLE_COMPONENT(BYYEARDAY, by_year_day, ICAL_BY_YEARDAY_SIZE)</span>
<a href="#l11.502"></a><span id="l11.502" class="difflineminus">-    else HANDLE_COMPONENT(BYWEEKNO, by_week_no, ICAL_BY_WEEKNO_SIZE)</span>
<a href="#l11.503"></a><span id="l11.503" class="difflineminus">-    else HANDLE_COMPONENT(BYMONTH, by_month, ICAL_BY_MONTH_SIZE)</span>
<a href="#l11.504"></a><span id="l11.504" class="difflineminus">-    else HANDLE_COMPONENT(BYSETPOS, by_set_pos, ICAL_BY_SETPOS_SIZE)</span>
<a href="#l11.505"></a><span id="l11.505" class="difflineminus">-    else {</span>
<a href="#l11.506"></a><span id="l11.506" class="difflineminus">-        // invalid component; XXX - error code</span>
<a href="#l11.507"></a><span id="l11.507" class="difflineminus">-        return NS_ERROR_FAILURE;</span>
<a href="#l11.508"></a><span id="l11.508" class="difflineminus">-    }</span>
<a href="#l11.509"></a><span id="l11.509" class="difflineplus">+  HANDLE_COMPONENT(BYSECOND, by_second, ICAL_BY_SECOND_SIZE)</span>
<a href="#l11.510"></a><span id="l11.510" class="difflineplus">+  else HANDLE_COMPONENT(BYMINUTE, by_minute, ICAL_BY_MINUTE_SIZE) else HANDLE_COMPONENT(</span>
<a href="#l11.511"></a><span id="l11.511" class="difflineplus">+      BYHOUR, by_hour,</span>
<a href="#l11.512"></a><span id="l11.512" class="difflineplus">+      ICAL_BY_HOUR_SIZE) else HANDLE_COMPONENT(BYDAY, by_day,</span>
<a href="#l11.513"></a><span id="l11.513" class="difflineplus">+                                               ICAL_BY_DAY_SIZE)  // special</span>
<a href="#l11.514"></a><span id="l11.514" class="difflineplus">+      else HANDLE_COMPONENT(BYMONTHDAY, by_month_day, ICAL_BY_MONTHDAY_SIZE) else HANDLE_COMPONENT(BYYEARDAY, by_year_day, ICAL_BY_YEARDAY_SIZE) else HANDLE_COMPONENT(</span>
<a href="#l11.515"></a><span id="l11.515" class="difflineplus">+          BYWEEKNO, by_week_no,</span>
<a href="#l11.516"></a><span id="l11.516" class="difflineplus">+          ICAL_BY_WEEKNO_SIZE) else HANDLE_COMPONENT(BYMONTH, by_month,</span>
<a href="#l11.517"></a><span id="l11.517" class="difflineplus">+                                                     ICAL_BY_MONTH_SIZE) else HANDLE_COMPONENT(BYSETPOS,</span>
<a href="#l11.518"></a><span id="l11.518" class="difflineplus">+                                                                                               by_set_pos,</span>
<a href="#l11.519"></a><span id="l11.519" class="difflineplus">+                                                                                               ICAL_BY_SETPOS_SIZE) else {</span>
<a href="#l11.520"></a><span id="l11.520" class="difflineplus">+    // invalid component; XXX - error code</span>
<a href="#l11.521"></a><span id="l11.521" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l11.522"></a><span id="l11.522" class="difflineplus">+  }</span>
<a href="#l11.523"></a><span id="l11.523"> #undef HANDLE_COMPONENT</span>
<a href="#l11.524"></a><span id="l11.524"> </span>
<a href="#l11.525"></a><span id="l11.525" class="difflineminus">-    return NS_OK;</span>
<a href="#l11.526"></a><span id="l11.526" class="difflineplus">+  return NS_OK;</span>
<a href="#l11.527"></a><span id="l11.527"> }</span>
<a href="#l11.528"></a><span id="l11.528"> </span>
<a href="#l11.529"></a><span id="l11.529" class="difflineminus">-/* calIDateTime getNextOccurrence (in calIDateTime aStartTime, in calIDateTime aOccurrenceTime); */</span>
<a href="#l11.530"></a><span id="l11.530" class="difflineplus">+/* calIDateTime getNextOccurrence (in calIDateTime aStartTime, in calIDateTime</span>
<a href="#l11.531"></a><span id="l11.531" class="difflineplus">+ * aOccurrenceTime); */</span>
<a href="#l11.532"></a><span id="l11.532"> NS_IMETHODIMP</span>
<a href="#l11.533"></a><span id="l11.533"> calRecurrenceRule::GetNextOccurrence(calIDateTime *aStartTime,</span>
<a href="#l11.534"></a><span id="l11.534">                                      calIDateTime *aOccurrenceTime,</span>
<a href="#l11.535"></a><span id="l11.535" class="difflineminus">-                                     calIDateTime **_retval)</span>
<a href="#l11.536"></a><span id="l11.536" class="difflineminus">-{</span>
<a href="#l11.537"></a><span id="l11.537" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aStartTime);</span>
<a href="#l11.538"></a><span id="l11.538" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aOccurrenceTime);</span>
<a href="#l11.539"></a><span id="l11.539" class="difflineminus">-    NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l11.540"></a><span id="l11.540" class="difflineplus">+                                     calIDateTime **_retval) {</span>
<a href="#l11.541"></a><span id="l11.541" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aStartTime);</span>
<a href="#l11.542"></a><span id="l11.542" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aOccurrenceTime);</span>
<a href="#l11.543"></a><span id="l11.543" class="difflineplus">+  NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l11.544"></a><span id="l11.544"> </span>
<a href="#l11.545"></a><span id="l11.545" class="difflineminus">-    nsresult rv;</span>
<a href="#l11.546"></a><span id="l11.546" class="difflineplus">+  nsresult rv;</span>
<a href="#l11.547"></a><span id="l11.547"> </span>
<a href="#l11.548"></a><span id="l11.548" class="difflineminus">-    nsCOMPtr&lt;calIDateTimeLibical&gt; icaldtstart = do_QueryInterface(aStartTime, &amp;rv);</span>
<a href="#l11.549"></a><span id="l11.549" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.550"></a><span id="l11.550" class="difflineminus">-</span>
<a href="#l11.551"></a><span id="l11.551" class="difflineminus">-    nsCOMPtr&lt;calIDateTimeLibical&gt; icaloccurtime = do_QueryInterface(aOccurrenceTime, &amp;rv);</span>
<a href="#l11.552"></a><span id="l11.552" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.553"></a><span id="l11.553" class="difflineplus">+  nsCOMPtr&lt;calIDateTimeLibical&gt; icaldtstart =</span>
<a href="#l11.554"></a><span id="l11.554" class="difflineplus">+      do_QueryInterface(aStartTime, &amp;rv);</span>
<a href="#l11.555"></a><span id="l11.555" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.556"></a><span id="l11.556"> </span>
<a href="#l11.557"></a><span id="l11.557" class="difflineminus">-    struct icaltimetype dtstart;</span>
<a href="#l11.558"></a><span id="l11.558" class="difflineminus">-    icaldtstart-&gt;ToIcalTime(&amp;dtstart);</span>
<a href="#l11.559"></a><span id="l11.559" class="difflineplus">+  nsCOMPtr&lt;calIDateTimeLibical&gt; icaloccurtime =</span>
<a href="#l11.560"></a><span id="l11.560" class="difflineplus">+      do_QueryInterface(aOccurrenceTime, &amp;rv);</span>
<a href="#l11.561"></a><span id="l11.561" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.562"></a><span id="l11.562"> </span>
<a href="#l11.563"></a><span id="l11.563" class="difflineminus">-    struct icaltimetype occurtime;</span>
<a href="#l11.564"></a><span id="l11.564" class="difflineminus">-    icaloccurtime-&gt;ToIcalTime(&amp;occurtime);</span>
<a href="#l11.565"></a><span id="l11.565" class="difflineplus">+  struct icaltimetype dtstart;</span>
<a href="#l11.566"></a><span id="l11.566" class="difflineplus">+  icaldtstart-&gt;ToIcalTime(&amp;dtstart);</span>
<a href="#l11.567"></a><span id="l11.567" class="difflineplus">+</span>
<a href="#l11.568"></a><span id="l11.568" class="difflineplus">+  struct icaltimetype occurtime;</span>
<a href="#l11.569"></a><span id="l11.569" class="difflineplus">+  icaloccurtime-&gt;ToIcalTime(&amp;occurtime);</span>
<a href="#l11.570"></a><span id="l11.570"> </span>
<a href="#l11.571"></a><span id="l11.571" class="difflineminus">-    icalrecur_iterator* recur_iter;</span>
<a href="#l11.572"></a><span id="l11.572" class="difflineminus">-    recur_iter = icalrecur_iterator_new(mIcalRecur, dtstart);</span>
<a href="#l11.573"></a><span id="l11.573" class="difflineminus">-    if (!recur_iter)</span>
<a href="#l11.574"></a><span id="l11.574" class="difflineminus">-        return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l11.575"></a><span id="l11.575" class="difflineplus">+  icalrecur_iterator *recur_iter;</span>
<a href="#l11.576"></a><span id="l11.576" class="difflineplus">+  recur_iter = icalrecur_iterator_new(mIcalRecur, dtstart);</span>
<a href="#l11.577"></a><span id="l11.577" class="difflineplus">+  if (!recur_iter) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l11.578"></a><span id="l11.578"> </span>
<a href="#l11.579"></a><span id="l11.579" class="difflineminus">-    struct icaltimetype next = icalrecur_iterator_next(recur_iter);</span>
<a href="#l11.580"></a><span id="l11.580" class="difflineminus">-    while (!icaltime_is_null_time(next)) {</span>
<a href="#l11.581"></a><span id="l11.581" class="difflineminus">-        if (icaltime_compare(next, occurtime) &gt; 0)</span>
<a href="#l11.582"></a><span id="l11.582" class="difflineminus">-            break;</span>
<a href="#l11.583"></a><span id="l11.583" class="difflineplus">+  struct icaltimetype next = icalrecur_iterator_next(recur_iter);</span>
<a href="#l11.584"></a><span id="l11.584" class="difflineplus">+  while (!icaltime_is_null_time(next)) {</span>
<a href="#l11.585"></a><span id="l11.585" class="difflineplus">+    if (icaltime_compare(next, occurtime) &gt; 0) break;</span>
<a href="#l11.586"></a><span id="l11.586"> </span>
<a href="#l11.587"></a><span id="l11.587" class="difflineminus">-        next = icalrecur_iterator_next(recur_iter);</span>
<a href="#l11.588"></a><span id="l11.588" class="difflineminus">-    }</span>
<a href="#l11.589"></a><span id="l11.589" class="difflineplus">+    next = icalrecur_iterator_next(recur_iter);</span>
<a href="#l11.590"></a><span id="l11.590" class="difflineplus">+  }</span>
<a href="#l11.591"></a><span id="l11.591"> </span>
<a href="#l11.592"></a><span id="l11.592" class="difflineminus">-    icalrecur_iterator_free(recur_iter);</span>
<a href="#l11.593"></a><span id="l11.593" class="difflineplus">+  icalrecur_iterator_free(recur_iter);</span>
<a href="#l11.594"></a><span id="l11.594"> </span>
<a href="#l11.595"></a><span id="l11.595" class="difflineminus">-    if (icaltime_is_null_time(next)) {</span>
<a href="#l11.596"></a><span id="l11.596" class="difflineminus">-        *_retval = nullptr;</span>
<a href="#l11.597"></a><span id="l11.597" class="difflineminus">-        return NS_OK;</span>
<a href="#l11.598"></a><span id="l11.598" class="difflineminus">-    }</span>
<a href="#l11.599"></a><span id="l11.599" class="difflineplus">+  if (icaltime_is_null_time(next)) {</span>
<a href="#l11.600"></a><span id="l11.600" class="difflineplus">+    *_retval = nullptr;</span>
<a href="#l11.601"></a><span id="l11.601" class="difflineplus">+    return NS_OK;</span>
<a href="#l11.602"></a><span id="l11.602" class="difflineplus">+  }</span>
<a href="#l11.603"></a><span id="l11.603"> </span>
<a href="#l11.604"></a><span id="l11.604" class="difflineminus">-    nsCOMPtr&lt;calITimezone&gt; tz;</span>
<a href="#l11.605"></a><span id="l11.605" class="difflineminus">-    aStartTime-&gt;GetTimezone(getter_AddRefs(tz));</span>
<a href="#l11.606"></a><span id="l11.606" class="difflineminus">-    *_retval = new calDateTime(&amp;next, tz);</span>
<a href="#l11.607"></a><span id="l11.607" class="difflineminus">-    CAL_ENSURE_MEMORY(*_retval);</span>
<a href="#l11.608"></a><span id="l11.608" class="difflineminus">-    NS_ADDREF(*_retval);</span>
<a href="#l11.609"></a><span id="l11.609" class="difflineminus">-    return NS_OK;</span>
<a href="#l11.610"></a><span id="l11.610" class="difflineplus">+  nsCOMPtr&lt;calITimezone&gt; tz;</span>
<a href="#l11.611"></a><span id="l11.611" class="difflineplus">+  aStartTime-&gt;GetTimezone(getter_AddRefs(tz));</span>
<a href="#l11.612"></a><span id="l11.612" class="difflineplus">+  *_retval = new calDateTime(&amp;next, tz);</span>
<a href="#l11.613"></a><span id="l11.613" class="difflineplus">+  CAL_ENSURE_MEMORY(*_retval);</span>
<a href="#l11.614"></a><span id="l11.614" class="difflineplus">+  NS_ADDREF(*_retval);</span>
<a href="#l11.615"></a><span id="l11.615" class="difflineplus">+  return NS_OK;</span>
<a href="#l11.616"></a><span id="l11.616"> }</span>
<a href="#l11.617"></a><span id="l11.617"> </span>
<a href="#l11.618"></a><span id="l11.618" class="difflineminus">-static inline icaltimetype ensureDateTime(icaltimetype const&amp; icalt) {</span>
<a href="#l11.619"></a><span id="l11.619" class="difflineminus">-    if (!icalt.is_date) {</span>
<a href="#l11.620"></a><span id="l11.620" class="difflineminus">-        return icalt;</span>
<a href="#l11.621"></a><span id="l11.621" class="difflineminus">-    } else {</span>
<a href="#l11.622"></a><span id="l11.622" class="difflineminus">-        icaltimetype ret = icalt;</span>
<a href="#l11.623"></a><span id="l11.623" class="difflineminus">-        ret.is_date = 0;</span>
<a href="#l11.624"></a><span id="l11.624" class="difflineminus">-        ret.hour = 0;</span>
<a href="#l11.625"></a><span id="l11.625" class="difflineminus">-        ret.minute = 0;</span>
<a href="#l11.626"></a><span id="l11.626" class="difflineminus">-        ret.second = 0;</span>
<a href="#l11.627"></a><span id="l11.627" class="difflineminus">-        return ret;</span>
<a href="#l11.628"></a><span id="l11.628" class="difflineminus">-    }</span>
<a href="#l11.629"></a><span id="l11.629" class="difflineplus">+static inline icaltimetype ensureDateTime(icaltimetype const &amp;icalt) {</span>
<a href="#l11.630"></a><span id="l11.630" class="difflineplus">+  if (!icalt.is_date) {</span>
<a href="#l11.631"></a><span id="l11.631" class="difflineplus">+    return icalt;</span>
<a href="#l11.632"></a><span id="l11.632" class="difflineplus">+  } else {</span>
<a href="#l11.633"></a><span id="l11.633" class="difflineplus">+    icaltimetype ret = icalt;</span>
<a href="#l11.634"></a><span id="l11.634" class="difflineplus">+    ret.is_date = 0;</span>
<a href="#l11.635"></a><span id="l11.635" class="difflineplus">+    ret.hour = 0;</span>
<a href="#l11.636"></a><span id="l11.636" class="difflineplus">+    ret.minute = 0;</span>
<a href="#l11.637"></a><span id="l11.637" class="difflineplus">+    ret.second = 0;</span>
<a href="#l11.638"></a><span id="l11.638" class="difflineplus">+    return ret;</span>
<a href="#l11.639"></a><span id="l11.639" class="difflineplus">+  }</span>
<a href="#l11.640"></a><span id="l11.640"> }</span>
<a href="#l11.641"></a><span id="l11.641"> </span>
<a href="#l11.642"></a><span id="l11.642"> NS_IMETHODIMP</span>
<a href="#l11.643"></a><span id="l11.643"> calRecurrenceRule::GetOccurrences(calIDateTime *aStartTime,</span>
<a href="#l11.644"></a><span id="l11.644">                                   calIDateTime *aRangeStart,</span>
<a href="#l11.645"></a><span id="l11.645" class="difflineminus">-                                  calIDateTime *aRangeEnd,</span>
<a href="#l11.646"></a><span id="l11.646" class="difflineminus">-                                  uint32_t aMaxCount,</span>
<a href="#l11.647"></a><span id="l11.647" class="difflineminus">-                                  uint32_t *aCount, calIDateTime ***aDates)</span>
<a href="#l11.648"></a><span id="l11.648" class="difflineminus">-{</span>
<a href="#l11.649"></a><span id="l11.649" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aStartTime);</span>
<a href="#l11.650"></a><span id="l11.650" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aRangeStart);</span>
<a href="#l11.651"></a><span id="l11.651" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aCount);</span>
<a href="#l11.652"></a><span id="l11.652" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aDates);</span>
<a href="#l11.653"></a><span id="l11.653" class="difflineplus">+                                  calIDateTime *aRangeEnd, uint32_t aMaxCount,</span>
<a href="#l11.654"></a><span id="l11.654" class="difflineplus">+                                  uint32_t *aCount, calIDateTime ***aDates) {</span>
<a href="#l11.655"></a><span id="l11.655" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aStartTime);</span>
<a href="#l11.656"></a><span id="l11.656" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aRangeStart);</span>
<a href="#l11.657"></a><span id="l11.657" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aCount);</span>
<a href="#l11.658"></a><span id="l11.658" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aDates);</span>
<a href="#l11.659"></a><span id="l11.659"> </span>
<a href="#l11.660"></a><span id="l11.660" class="difflineminus">-    // make sure the request is sane; infinite recurrence</span>
<a href="#l11.661"></a><span id="l11.661" class="difflineminus">-    // with no end time is bad times.</span>
<a href="#l11.662"></a><span id="l11.662" class="difflineminus">-    if (!aMaxCount &amp;&amp; !aRangeEnd &amp;&amp; mIcalRecur.count == 0 &amp;&amp; icaltime_is_null_time(mIcalRecur.until))</span>
<a href="#l11.663"></a><span id="l11.663" class="difflineminus">-        return NS_ERROR_INVALID_ARG;</span>
<a href="#l11.664"></a><span id="l11.664" class="difflineplus">+  // make sure the request is sane; infinite recurrence</span>
<a href="#l11.665"></a><span id="l11.665" class="difflineplus">+  // with no end time is bad times.</span>
<a href="#l11.666"></a><span id="l11.666" class="difflineplus">+  if (!aMaxCount &amp;&amp; !aRangeEnd &amp;&amp; mIcalRecur.count == 0 &amp;&amp;</span>
<a href="#l11.667"></a><span id="l11.667" class="difflineplus">+      icaltime_is_null_time(mIcalRecur.until))</span>
<a href="#l11.668"></a><span id="l11.668" class="difflineplus">+    return NS_ERROR_INVALID_ARG;</span>
<a href="#l11.669"></a><span id="l11.669"> </span>
<a href="#l11.670"></a><span id="l11.670" class="difflineminus">-    nsCOMArray&lt;calIDateTime&gt; dates;</span>
<a href="#l11.671"></a><span id="l11.671" class="difflineplus">+  nsCOMArray&lt;calIDateTime&gt; dates;</span>
<a href="#l11.672"></a><span id="l11.672"> </span>
<a href="#l11.673"></a><span id="l11.673"> #ifdef DEBUG_dbo</span>
<a href="#l11.674"></a><span id="l11.674" class="difflineminus">-    {</span>
<a href="#l11.675"></a><span id="l11.675" class="difflineminus">-        char const * const ss = icalrecurrencetype_as_string(&amp;mIcalRecur);</span>
<a href="#l11.676"></a><span id="l11.676" class="difflineminus">-        nsAutoCString tst, tend;</span>
<a href="#l11.677"></a><span id="l11.677" class="difflineminus">-        aRangeStart-&gt;ToString(tst);</span>
<a href="#l11.678"></a><span id="l11.678" class="difflineminus">-        aRangeEnd-&gt;ToString(tend);</span>
<a href="#l11.679"></a><span id="l11.679" class="difflineminus">-        printf(&quot;RULE: [%s -&gt; %s, %d]: %s\n&quot;, tst.get(), tend.get(), mIcalRecur.count, ss);</span>
<a href="#l11.680"></a><span id="l11.680" class="difflineminus">-    }</span>
<a href="#l11.681"></a><span id="l11.681" class="difflineplus">+  {</span>
<a href="#l11.682"></a><span id="l11.682" class="difflineplus">+    char const *const ss = icalrecurrencetype_as_string(&amp;mIcalRecur);</span>
<a href="#l11.683"></a><span id="l11.683" class="difflineplus">+    nsAutoCString tst, tend;</span>
<a href="#l11.684"></a><span id="l11.684" class="difflineplus">+    aRangeStart-&gt;ToString(tst);</span>
<a href="#l11.685"></a><span id="l11.685" class="difflineplus">+    aRangeEnd-&gt;ToString(tend);</span>
<a href="#l11.686"></a><span id="l11.686" class="difflineplus">+    printf(&quot;RULE: [%s -&gt; %s, %d]: %s\n&quot;, tst.get(), tend.get(),</span>
<a href="#l11.687"></a><span id="l11.687" class="difflineplus">+           mIcalRecur.count, ss);</span>
<a href="#l11.688"></a><span id="l11.688" class="difflineplus">+  }</span>
<a href="#l11.689"></a><span id="l11.689"> #endif</span>
<a href="#l11.690"></a><span id="l11.690"> </span>
<a href="#l11.691"></a><span id="l11.691" class="difflineminus">-    nsresult rv;</span>
<a href="#l11.692"></a><span id="l11.692" class="difflineplus">+  nsresult rv;</span>
<a href="#l11.693"></a><span id="l11.693" class="difflineplus">+</span>
<a href="#l11.694"></a><span id="l11.694" class="difflineplus">+  nsCOMPtr&lt;calIDateTimeLibical&gt; icalrangestart =</span>
<a href="#l11.695"></a><span id="l11.695" class="difflineplus">+      do_QueryInterface(aRangeStart, &amp;rv);</span>
<a href="#l11.696"></a><span id="l11.696" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.697"></a><span id="l11.697" class="difflineplus">+  nsCOMPtr&lt;calIDateTimeLibical&gt; icaldtstart =</span>
<a href="#l11.698"></a><span id="l11.698" class="difflineplus">+      do_QueryInterface(aStartTime, &amp;rv);</span>
<a href="#l11.699"></a><span id="l11.699" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.700"></a><span id="l11.700"> </span>
<a href="#l11.701"></a><span id="l11.701" class="difflineminus">-    nsCOMPtr&lt;calIDateTimeLibical&gt; icalrangestart = do_QueryInterface(aRangeStart, &amp;rv);</span>
<a href="#l11.702"></a><span id="l11.702" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.703"></a><span id="l11.703" class="difflineminus">-    nsCOMPtr&lt;calIDateTimeLibical&gt; icaldtstart = do_QueryInterface(aStartTime, &amp;rv);</span>
<a href="#l11.704"></a><span id="l11.704" class="difflineplus">+  struct icaltimetype rangestart, dtstart, dtend;</span>
<a href="#l11.705"></a><span id="l11.705" class="difflineplus">+  icalrangestart-&gt;ToIcalTime(&amp;rangestart);</span>
<a href="#l11.706"></a><span id="l11.706" class="difflineplus">+  rangestart = ensureDateTime(rangestart);</span>
<a href="#l11.707"></a><span id="l11.707" class="difflineplus">+  icaldtstart-&gt;ToIcalTime(&amp;dtstart);</span>
<a href="#l11.708"></a><span id="l11.708" class="difflineplus">+  nsCOMPtr&lt;calITimezone&gt; tz;</span>
<a href="#l11.709"></a><span id="l11.709" class="difflineplus">+  aStartTime-&gt;GetTimezone(getter_AddRefs(tz));</span>
<a href="#l11.710"></a><span id="l11.710" class="difflineplus">+</span>
<a href="#l11.711"></a><span id="l11.711" class="difflineplus">+  if (aRangeEnd) {</span>
<a href="#l11.712"></a><span id="l11.712" class="difflineplus">+    nsCOMPtr&lt;calIDateTimeLibical&gt; icalrangeend =</span>
<a href="#l11.713"></a><span id="l11.713" class="difflineplus">+        do_QueryInterface(aRangeEnd, &amp;rv);</span>
<a href="#l11.714"></a><span id="l11.714">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.715"></a><span id="l11.715"> </span>
<a href="#l11.716"></a><span id="l11.716" class="difflineminus">-    struct icaltimetype rangestart, dtstart, dtend;</span>
<a href="#l11.717"></a><span id="l11.717" class="difflineminus">-    icalrangestart-&gt;ToIcalTime(&amp;rangestart);</span>
<a href="#l11.718"></a><span id="l11.718" class="difflineminus">-    rangestart = ensureDateTime(rangestart);</span>
<a href="#l11.719"></a><span id="l11.719" class="difflineminus">-    icaldtstart-&gt;ToIcalTime(&amp;dtstart);</span>
<a href="#l11.720"></a><span id="l11.720" class="difflineminus">-    nsCOMPtr&lt;calITimezone&gt; tz;</span>
<a href="#l11.721"></a><span id="l11.721" class="difflineminus">-    aStartTime-&gt;GetTimezone(getter_AddRefs(tz));</span>
<a href="#l11.722"></a><span id="l11.722" class="difflineplus">+    icalrangeend-&gt;ToIcalTime(&amp;dtend);</span>
<a href="#l11.723"></a><span id="l11.723" class="difflineplus">+    dtend = ensureDateTime(dtend);</span>
<a href="#l11.724"></a><span id="l11.724"> </span>
<a href="#l11.725"></a><span id="l11.725" class="difflineminus">-    if (aRangeEnd) {</span>
<a href="#l11.726"></a><span id="l11.726" class="difflineminus">-        nsCOMPtr&lt;calIDateTimeLibical&gt; icalrangeend = do_QueryInterface(aRangeEnd, &amp;rv);</span>
<a href="#l11.727"></a><span id="l11.727" class="difflineminus">-        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.728"></a><span id="l11.728" class="difflineplus">+    // if the start of the recurrence is past the end,</span>
<a href="#l11.729"></a><span id="l11.729" class="difflineplus">+    // we have no dates</span>
<a href="#l11.730"></a><span id="l11.730" class="difflineplus">+    if (icaltime_compare(dtstart, dtend) &gt;= 0) {</span>
<a href="#l11.731"></a><span id="l11.731" class="difflineplus">+      *aDates = nullptr;</span>
<a href="#l11.732"></a><span id="l11.732" class="difflineplus">+      *aCount = 0;</span>
<a href="#l11.733"></a><span id="l11.733" class="difflineplus">+      return NS_OK;</span>
<a href="#l11.734"></a><span id="l11.734" class="difflineplus">+    }</span>
<a href="#l11.735"></a><span id="l11.735" class="difflineplus">+  }</span>
<a href="#l11.736"></a><span id="l11.736"> </span>
<a href="#l11.737"></a><span id="l11.737" class="difflineminus">-        icalrangeend-&gt;ToIcalTime(&amp;dtend);</span>
<a href="#l11.738"></a><span id="l11.738" class="difflineminus">-        dtend = ensureDateTime(dtend);</span>
<a href="#l11.739"></a><span id="l11.739" class="difflineplus">+  icalrecur_iterator *recur_iter;</span>
<a href="#l11.740"></a><span id="l11.740" class="difflineplus">+  recur_iter = icalrecur_iterator_new(mIcalRecur, dtstart);</span>
<a href="#l11.741"></a><span id="l11.741" class="difflineplus">+  if (!recur_iter) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l11.742"></a><span id="l11.742" class="difflineplus">+</span>
<a href="#l11.743"></a><span id="l11.743" class="difflineplus">+  uint32_t count = 0;</span>
<a href="#l11.744"></a><span id="l11.744"> </span>
<a href="#l11.745"></a><span id="l11.745" class="difflineminus">-        // if the start of the recurrence is past the end,</span>
<a href="#l11.746"></a><span id="l11.746" class="difflineminus">-        // we have no dates</span>
<a href="#l11.747"></a><span id="l11.747" class="difflineminus">-        if (icaltime_compare (dtstart, dtend) &gt;= 0) {</span>
<a href="#l11.748"></a><span id="l11.748" class="difflineminus">-            *aDates = nullptr;</span>
<a href="#l11.749"></a><span id="l11.749" class="difflineminus">-            *aCount = 0;</span>
<a href="#l11.750"></a><span id="l11.750" class="difflineminus">-            return NS_OK;</span>
<a href="#l11.751"></a><span id="l11.751" class="difflineminus">-        }</span>
<a href="#l11.752"></a><span id="l11.752" class="difflineplus">+  for (icaltimetype next = icalrecur_iterator_next(recur_iter);</span>
<a href="#l11.753"></a><span id="l11.753" class="difflineplus">+       !icaltime_is_null_time(next);</span>
<a href="#l11.754"></a><span id="l11.754" class="difflineplus">+       next = icalrecur_iterator_next(recur_iter)) {</span>
<a href="#l11.755"></a><span id="l11.755" class="difflineplus">+    icaltimetype const dtNext(ensureDateTime(next));</span>
<a href="#l11.756"></a><span id="l11.756" class="difflineplus">+</span>
<a href="#l11.757"></a><span id="l11.757" class="difflineplus">+    // if this thing is before the range start</span>
<a href="#l11.758"></a><span id="l11.758" class="difflineplus">+    if (icaltime_compare(dtNext, rangestart) &lt; 0) {</span>
<a href="#l11.759"></a><span id="l11.759" class="difflineplus">+      continue;</span>
<a href="#l11.760"></a><span id="l11.760">     }</span>
<a href="#l11.761"></a><span id="l11.761"> </span>
<a href="#l11.762"></a><span id="l11.762" class="difflineminus">-    icalrecur_iterator* recur_iter;</span>
<a href="#l11.763"></a><span id="l11.763" class="difflineminus">-    recur_iter = icalrecur_iterator_new(mIcalRecur, dtstart);</span>
<a href="#l11.764"></a><span id="l11.764" class="difflineminus">-    if (!recur_iter)</span>
<a href="#l11.765"></a><span id="l11.765" class="difflineminus">-        return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l11.766"></a><span id="l11.766" class="difflineminus">-</span>
<a href="#l11.767"></a><span id="l11.767" class="difflineminus">-    uint32_t count = 0;</span>
<a href="#l11.768"></a><span id="l11.768" class="difflineminus">-</span>
<a href="#l11.769"></a><span id="l11.769" class="difflineminus">-    for (icaltimetype next = icalrecur_iterator_next(recur_iter);</span>
<a href="#l11.770"></a><span id="l11.770" class="difflineminus">-         !icaltime_is_null_time(next);</span>
<a href="#l11.771"></a><span id="l11.771" class="difflineminus">-         next = icalrecur_iterator_next(recur_iter))</span>
<a href="#l11.772"></a><span id="l11.772" class="difflineminus">-    {</span>
<a href="#l11.773"></a><span id="l11.773" class="difflineminus">-        icaltimetype const dtNext(ensureDateTime(next));</span>
<a href="#l11.774"></a><span id="l11.774" class="difflineminus">-</span>
<a href="#l11.775"></a><span id="l11.775" class="difflineminus">-        // if this thing is before the range start</span>
<a href="#l11.776"></a><span id="l11.776" class="difflineminus">-        if (icaltime_compare(dtNext, rangestart) &lt; 0) {</span>
<a href="#l11.777"></a><span id="l11.777" class="difflineminus">-            continue;</span>
<a href="#l11.778"></a><span id="l11.778" class="difflineminus">-        }</span>
<a href="#l11.779"></a><span id="l11.779" class="difflineplus">+    if (aRangeEnd &amp;&amp; icaltime_compare(dtNext, dtend) &gt;= 0) break;</span>
<a href="#l11.780"></a><span id="l11.780"> </span>
<a href="#l11.781"></a><span id="l11.781" class="difflineminus">-        if (aRangeEnd &amp;&amp; icaltime_compare(dtNext, dtend) &gt;= 0)</span>
<a href="#l11.782"></a><span id="l11.782" class="difflineminus">-            break;</span>
<a href="#l11.783"></a><span id="l11.783" class="difflineminus">-</span>
<a href="#l11.784"></a><span id="l11.784" class="difflineminus">-        calIDateTime * const cdt = new calDateTime(&amp;next, tz);</span>
<a href="#l11.785"></a><span id="l11.785" class="difflineminus">-        if (!cdt) {</span>
<a href="#l11.786"></a><span id="l11.786" class="difflineminus">-            icalrecur_iterator_free(recur_iter);</span>
<a href="#l11.787"></a><span id="l11.787" class="difflineminus">-            return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l11.788"></a><span id="l11.788" class="difflineminus">-        }</span>
<a href="#l11.789"></a><span id="l11.789" class="difflineminus">-</span>
<a href="#l11.790"></a><span id="l11.790" class="difflineminus">-        dates.AppendObject(cdt);</span>
<a href="#l11.791"></a><span id="l11.791" class="difflineminus">-#ifdef DEBUG_dbo</span>
<a href="#l11.792"></a><span id="l11.792" class="difflineminus">-        {</span>
<a href="#l11.793"></a><span id="l11.793" class="difflineminus">-            nsAutoCString str;</span>
<a href="#l11.794"></a><span id="l11.794" class="difflineminus">-            cdt-&gt;ToString(str);</span>
<a href="#l11.795"></a><span id="l11.795" class="difflineminus">-            printf(&quot;  occ: %s\n&quot;, str.get());</span>
<a href="#l11.796"></a><span id="l11.796" class="difflineminus">-        }</span>
<a href="#l11.797"></a><span id="l11.797" class="difflineminus">-#endif</span>
<a href="#l11.798"></a><span id="l11.798" class="difflineminus">-        count++;</span>
<a href="#l11.799"></a><span id="l11.799" class="difflineminus">-        if (aMaxCount &amp;&amp; aMaxCount &lt;= count)</span>
<a href="#l11.800"></a><span id="l11.800" class="difflineminus">-            break;</span>
<a href="#l11.801"></a><span id="l11.801" class="difflineplus">+    calIDateTime *const cdt = new calDateTime(&amp;next, tz);</span>
<a href="#l11.802"></a><span id="l11.802" class="difflineplus">+    if (!cdt) {</span>
<a href="#l11.803"></a><span id="l11.803" class="difflineplus">+      icalrecur_iterator_free(recur_iter);</span>
<a href="#l11.804"></a><span id="l11.804" class="difflineplus">+      return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l11.805"></a><span id="l11.805">     }</span>
<a href="#l11.806"></a><span id="l11.806"> </span>
<a href="#l11.807"></a><span id="l11.807" class="difflineminus">-    icalrecur_iterator_free(recur_iter);</span>
<a href="#l11.808"></a><span id="l11.808" class="difflineplus">+    dates.AppendObject(cdt);</span>
<a href="#l11.809"></a><span id="l11.809" class="difflineplus">+#ifdef DEBUG_dbo</span>
<a href="#l11.810"></a><span id="l11.810" class="difflineplus">+    {</span>
<a href="#l11.811"></a><span id="l11.811" class="difflineplus">+      nsAutoCString str;</span>
<a href="#l11.812"></a><span id="l11.812" class="difflineplus">+      cdt-&gt;ToString(str);</span>
<a href="#l11.813"></a><span id="l11.813" class="difflineplus">+      printf(&quot;  occ: %s\n&quot;, str.get());</span>
<a href="#l11.814"></a><span id="l11.814" class="difflineplus">+    }</span>
<a href="#l11.815"></a><span id="l11.815" class="difflineplus">+#endif</span>
<a href="#l11.816"></a><span id="l11.816" class="difflineplus">+    count++;</span>
<a href="#l11.817"></a><span id="l11.817" class="difflineplus">+    if (aMaxCount &amp;&amp; aMaxCount &lt;= count) break;</span>
<a href="#l11.818"></a><span id="l11.818" class="difflineplus">+  }</span>
<a href="#l11.819"></a><span id="l11.819" class="difflineplus">+</span>
<a href="#l11.820"></a><span id="l11.820" class="difflineplus">+  icalrecur_iterator_free(recur_iter);</span>
<a href="#l11.821"></a><span id="l11.821"> </span>
<a href="#l11.822"></a><span id="l11.822" class="difflineminus">-    if (count) {</span>
<a href="#l11.823"></a><span id="l11.823" class="difflineminus">-        calIDateTime ** const dateArray =</span>
<a href="#l11.824"></a><span id="l11.824" class="difflineminus">-            static_cast&lt;calIDateTime **&gt;(moz_xmalloc(sizeof(calIDateTime*) * count));</span>
<a href="#l11.825"></a><span id="l11.825" class="difflineminus">-        CAL_ENSURE_MEMORY(dateArray);</span>
<a href="#l11.826"></a><span id="l11.826" class="difflineminus">-        for (uint32_t i = 0; i &lt; count; ++i) {</span>
<a href="#l11.827"></a><span id="l11.827" class="difflineminus">-            NS_ADDREF(dateArray[i] = dates[i]);</span>
<a href="#l11.828"></a><span id="l11.828" class="difflineminus">-        }</span>
<a href="#l11.829"></a><span id="l11.829" class="difflineminus">-        *aDates = dateArray;</span>
<a href="#l11.830"></a><span id="l11.830" class="difflineminus">-    } else {</span>
<a href="#l11.831"></a><span id="l11.831" class="difflineminus">-        *aDates = nullptr;</span>
<a href="#l11.832"></a><span id="l11.832" class="difflineplus">+  if (count) {</span>
<a href="#l11.833"></a><span id="l11.833" class="difflineplus">+    calIDateTime **const dateArray = static_cast&lt;calIDateTime **&gt;(</span>
<a href="#l11.834"></a><span id="l11.834" class="difflineplus">+        moz_xmalloc(sizeof(calIDateTime *) * count));</span>
<a href="#l11.835"></a><span id="l11.835" class="difflineplus">+    CAL_ENSURE_MEMORY(dateArray);</span>
<a href="#l11.836"></a><span id="l11.836" class="difflineplus">+    for (uint32_t i = 0; i &lt; count; ++i) {</span>
<a href="#l11.837"></a><span id="l11.837" class="difflineplus">+      NS_ADDREF(dateArray[i] = dates[i]);</span>
<a href="#l11.838"></a><span id="l11.838">     }</span>
<a href="#l11.839"></a><span id="l11.839" class="difflineplus">+    *aDates = dateArray;</span>
<a href="#l11.840"></a><span id="l11.840" class="difflineplus">+  } else {</span>
<a href="#l11.841"></a><span id="l11.841" class="difflineplus">+    *aDates = nullptr;</span>
<a href="#l11.842"></a><span id="l11.842" class="difflineplus">+  }</span>
<a href="#l11.843"></a><span id="l11.843"> </span>
<a href="#l11.844"></a><span id="l11.844" class="difflineminus">-    *aCount = count;</span>
<a href="#l11.845"></a><span id="l11.845" class="difflineplus">+  *aCount = count;</span>
<a href="#l11.846"></a><span id="l11.846"> </span>
<a href="#l11.847"></a><span id="l11.847" class="difflineminus">-    return NS_OK;</span>
<a href="#l11.848"></a><span id="l11.848" class="difflineplus">+  return NS_OK;</span>
<a href="#l11.849"></a><span id="l11.849"> }</span>
<a href="#l11.850"></a><span id="l11.850"> </span>
<a href="#l11.851"></a><span id="l11.851"> /**</span>
<a href="#l11.852"></a><span id="l11.852">  ** ical property getting/setting</span>
<a href="#l11.853"></a><span id="l11.853">  **/</span>
<a href="#l11.854"></a><span id="l11.854"> NS_IMETHODIMP</span>
<a href="#l11.855"></a><span id="l11.855" class="difflineminus">-calRecurrenceRule::GetIcalProperty(calIIcalProperty **prop)</span>
<a href="#l11.856"></a><span id="l11.856" class="difflineminus">-{</span>
<a href="#l11.857"></a><span id="l11.857" class="difflineminus">-    icalproperty * const rrule = icalproperty_new_rrule(mIcalRecur);</span>
<a href="#l11.858"></a><span id="l11.858" class="difflineminus">-    CAL_ENSURE_MEMORY(rrule);</span>
<a href="#l11.859"></a><span id="l11.859" class="difflineminus">-    *prop = new calIcalProperty(rrule, nullptr);</span>
<a href="#l11.860"></a><span id="l11.860" class="difflineminus">-    if (!*prop) {</span>
<a href="#l11.861"></a><span id="l11.861" class="difflineminus">-        icalproperty_free(rrule);</span>
<a href="#l11.862"></a><span id="l11.862" class="difflineminus">-        return NS_ERROR_FAILURE;</span>
<a href="#l11.863"></a><span id="l11.863" class="difflineminus">-    }</span>
<a href="#l11.864"></a><span id="l11.864" class="difflineplus">+calRecurrenceRule::GetIcalProperty(calIIcalProperty **prop) {</span>
<a href="#l11.865"></a><span id="l11.865" class="difflineplus">+  icalproperty *const rrule = icalproperty_new_rrule(mIcalRecur);</span>
<a href="#l11.866"></a><span id="l11.866" class="difflineplus">+  CAL_ENSURE_MEMORY(rrule);</span>
<a href="#l11.867"></a><span id="l11.867" class="difflineplus">+  *prop = new calIcalProperty(rrule, nullptr);</span>
<a href="#l11.868"></a><span id="l11.868" class="difflineplus">+  if (!*prop) {</span>
<a href="#l11.869"></a><span id="l11.869" class="difflineplus">+    icalproperty_free(rrule);</span>
<a href="#l11.870"></a><span id="l11.870" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l11.871"></a><span id="l11.871" class="difflineplus">+  }</span>
<a href="#l11.872"></a><span id="l11.872"> </span>
<a href="#l11.873"></a><span id="l11.873" class="difflineminus">-    NS_ADDREF(*prop);</span>
<a href="#l11.874"></a><span id="l11.874" class="difflineminus">-    return NS_OK;</span>
<a href="#l11.875"></a><span id="l11.875" class="difflineplus">+  NS_ADDREF(*prop);</span>
<a href="#l11.876"></a><span id="l11.876" class="difflineplus">+  return NS_OK;</span>
<a href="#l11.877"></a><span id="l11.877"> }</span>
<a href="#l11.878"></a><span id="l11.878"> </span>
<a href="#l11.879"></a><span id="l11.879"> NS_IMETHODIMP</span>
<a href="#l11.880"></a><span id="l11.880" class="difflineminus">-calRecurrenceRule::SetIcalProperty(calIIcalProperty *aProp)</span>
<a href="#l11.881"></a><span id="l11.881" class="difflineminus">-{</span>
<a href="#l11.882"></a><span id="l11.882" class="difflineminus">-    NS_ENSURE_ARG_POINTER(aProp);</span>
<a href="#l11.883"></a><span id="l11.883" class="difflineminus">-    nsresult rv;</span>
<a href="#l11.884"></a><span id="l11.884" class="difflineplus">+calRecurrenceRule::SetIcalProperty(calIIcalProperty *aProp) {</span>
<a href="#l11.885"></a><span id="l11.885" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aProp);</span>
<a href="#l11.886"></a><span id="l11.886" class="difflineplus">+  nsresult rv;</span>
<a href="#l11.887"></a><span id="l11.887"> </span>
<a href="#l11.888"></a><span id="l11.888" class="difflineminus">-    nsCOMPtr&lt;calIIcalPropertyLibical&gt; icalprop = do_QueryInterface(aProp, &amp;rv);</span>
<a href="#l11.889"></a><span id="l11.889" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.890"></a><span id="l11.890" class="difflineplus">+  nsCOMPtr&lt;calIIcalPropertyLibical&gt; icalprop = do_QueryInterface(aProp, &amp;rv);</span>
<a href="#l11.891"></a><span id="l11.891" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.892"></a><span id="l11.892"> </span>
<a href="#l11.893"></a><span id="l11.893" class="difflineminus">-    if (mImmutable)</span>
<a href="#l11.894"></a><span id="l11.894" class="difflineminus">-        return NS_ERROR_OBJECT_IS_IMMUTABLE;</span>
<a href="#l11.895"></a><span id="l11.895" class="difflineplus">+  if (mImmutable) return NS_ERROR_OBJECT_IS_IMMUTABLE;</span>
<a href="#l11.896"></a><span id="l11.896"> </span>
<a href="#l11.897"></a><span id="l11.897" class="difflineminus">-    nsAutoCString propname;</span>
<a href="#l11.898"></a><span id="l11.898" class="difflineminus">-    rv = aProp-&gt;GetPropertyName(propname);</span>
<a href="#l11.899"></a><span id="l11.899" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.900"></a><span id="l11.900" class="difflineminus">-    if (propname.EqualsLiteral(&quot;RRULE&quot;)) {</span>
<a href="#l11.901"></a><span id="l11.901" class="difflineminus">-        mIsNegative = false;</span>
<a href="#l11.902"></a><span id="l11.902" class="difflineminus">-    } else {</span>
<a href="#l11.903"></a><span id="l11.903" class="difflineminus">-        return NS_ERROR_INVALID_ARG;</span>
<a href="#l11.904"></a><span id="l11.904" class="difflineminus">-    }</span>
<a href="#l11.905"></a><span id="l11.905" class="difflineplus">+  nsAutoCString propname;</span>
<a href="#l11.906"></a><span id="l11.906" class="difflineplus">+  rv = aProp-&gt;GetPropertyName(propname);</span>
<a href="#l11.907"></a><span id="l11.907" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.908"></a><span id="l11.908" class="difflineplus">+  if (propname.EqualsLiteral(&quot;RRULE&quot;)) {</span>
<a href="#l11.909"></a><span id="l11.909" class="difflineplus">+    mIsNegative = false;</span>
<a href="#l11.910"></a><span id="l11.910" class="difflineplus">+  } else {</span>
<a href="#l11.911"></a><span id="l11.911" class="difflineplus">+    return NS_ERROR_INVALID_ARG;</span>
<a href="#l11.912"></a><span id="l11.912" class="difflineplus">+  }</span>
<a href="#l11.913"></a><span id="l11.913"> </span>
<a href="#l11.914"></a><span id="l11.914" class="difflineminus">-    icalproperty *prop;</span>
<a href="#l11.915"></a><span id="l11.915" class="difflineminus">-    struct icalrecurrencetype icalrecur;</span>
<a href="#l11.916"></a><span id="l11.916" class="difflineplus">+  icalproperty *prop;</span>
<a href="#l11.917"></a><span id="l11.917" class="difflineplus">+  struct icalrecurrencetype icalrecur;</span>
<a href="#l11.918"></a><span id="l11.918"> </span>
<a href="#l11.919"></a><span id="l11.919" class="difflineminus">-    prop = icalprop-&gt;GetLibicalProperty();</span>
<a href="#l11.920"></a><span id="l11.920" class="difflineplus">+  prop = icalprop-&gt;GetLibicalProperty();</span>
<a href="#l11.921"></a><span id="l11.921"> </span>
<a href="#l11.922"></a><span id="l11.922" class="difflineminus">-    icalrecur = icalproperty_get_rrule(prop);</span>
<a href="#l11.923"></a><span id="l11.923" class="difflineplus">+  icalrecur = icalproperty_get_rrule(prop);</span>
<a href="#l11.924"></a><span id="l11.924"> </span>
<a href="#l11.925"></a><span id="l11.925" class="difflineminus">-    // XXX Note that we ignore the dtstart and use the one from the</span>
<a href="#l11.926"></a><span id="l11.926" class="difflineminus">-    // event, though I realize now that we shouldn't.  Ignoring</span>
<a href="#l11.927"></a><span id="l11.927" class="difflineminus">-    // dtstart makes it impossible to have multiple RRULEs on one</span>
<a href="#l11.928"></a><span id="l11.928" class="difflineminus">-    // event that start at different times (e.g. every day starting on</span>
<a href="#l11.929"></a><span id="l11.929" class="difflineminus">-    // jan 1 for 2 weeks, every other day starting on feb 1 for 2</span>
<a href="#l11.930"></a><span id="l11.930" class="difflineminus">-    // weeks).  Neither the server nor the UI supports this now,</span>
<a href="#l11.931"></a><span id="l11.931" class="difflineminus">-    // but we really ought to!</span>
<a href="#l11.932"></a><span id="l11.932" class="difflineminus">-    //struct icaltimetype icaldtstart;</span>
<a href="#l11.933"></a><span id="l11.933" class="difflineminus">-    //icaldtstrat = icalproperty_get_dtstart(prop);</span>
<a href="#l11.934"></a><span id="l11.934" class="difflineplus">+  // XXX Note that we ignore the dtstart and use the one from the</span>
<a href="#l11.935"></a><span id="l11.935" class="difflineplus">+  // event, though I realize now that we shouldn't.  Ignoring</span>
<a href="#l11.936"></a><span id="l11.936" class="difflineplus">+  // dtstart makes it impossible to have multiple RRULEs on one</span>
<a href="#l11.937"></a><span id="l11.937" class="difflineplus">+  // event that start at different times (e.g. every day starting on</span>
<a href="#l11.938"></a><span id="l11.938" class="difflineplus">+  // jan 1 for 2 weeks, every other day starting on feb 1 for 2</span>
<a href="#l11.939"></a><span id="l11.939" class="difflineplus">+  // weeks).  Neither the server nor the UI supports this now,</span>
<a href="#l11.940"></a><span id="l11.940" class="difflineplus">+  // but we really ought to!</span>
<a href="#l11.941"></a><span id="l11.941" class="difflineplus">+  // struct icaltimetype icaldtstart;</span>
<a href="#l11.942"></a><span id="l11.942" class="difflineplus">+  // icaldtstrat = icalproperty_get_dtstart(prop);</span>
<a href="#l11.943"></a><span id="l11.943"> </span>
<a href="#l11.944"></a><span id="l11.944" class="difflineminus">-    if (icalrecur.count != 0)</span>
<a href="#l11.945"></a><span id="l11.945" class="difflineminus">-        mIsByCount = true;</span>
<a href="#l11.946"></a><span id="l11.946" class="difflineminus">-    else</span>
<a href="#l11.947"></a><span id="l11.947" class="difflineminus">-        mIsByCount = false;</span>
<a href="#l11.948"></a><span id="l11.948" class="difflineplus">+  if (icalrecur.count != 0)</span>
<a href="#l11.949"></a><span id="l11.949" class="difflineplus">+    mIsByCount = true;</span>
<a href="#l11.950"></a><span id="l11.950" class="difflineplus">+  else</span>
<a href="#l11.951"></a><span id="l11.951" class="difflineplus">+    mIsByCount = false;</span>
<a href="#l11.952"></a><span id="l11.952"> </span>
<a href="#l11.953"></a><span id="l11.953" class="difflineminus">-    mIcalRecur = icalrecur;</span>
<a href="#l11.954"></a><span id="l11.954" class="difflineplus">+  mIcalRecur = icalrecur;</span>
<a href="#l11.955"></a><span id="l11.955"> </span>
<a href="#l11.956"></a><span id="l11.956" class="difflineminus">-    return NS_OK;</span>
<a href="#l11.957"></a><span id="l11.957" class="difflineplus">+  return NS_OK;</span>
<a href="#l11.958"></a><span id="l11.958"> }</span>
<a href="#l11.959"></a><span id="l11.959"> </span>
<a href="#l11.960"></a><span id="l11.960"> NS_IMETHODIMP</span>
<a href="#l11.961"></a><span id="l11.961" class="difflineminus">-calRecurrenceRule::SetIcalString(const nsACString &amp;str)</span>
<a href="#l11.962"></a><span id="l11.962" class="difflineminus">-{</span>
<a href="#l11.963"></a><span id="l11.963" class="difflineminus">-    nsresult rv = NS_OK;</span>
<a href="#l11.964"></a><span id="l11.964" class="difflineminus">-    nsAutoCString name;</span>
<a href="#l11.965"></a><span id="l11.965" class="difflineminus">-    nsCOMPtr&lt;calIICSService&gt; icsSvc = cal::getICSService();</span>
<a href="#l11.966"></a><span id="l11.966" class="difflineminus">-    nsCOMPtr&lt;calIIcalProperty&gt; prop;</span>
<a href="#l11.967"></a><span id="l11.967" class="difflineplus">+calRecurrenceRule::SetIcalString(const nsACString &amp;str) {</span>
<a href="#l11.968"></a><span id="l11.968" class="difflineplus">+  nsresult rv = NS_OK;</span>
<a href="#l11.969"></a><span id="l11.969" class="difflineplus">+  nsAutoCString name;</span>
<a href="#l11.970"></a><span id="l11.970" class="difflineplus">+  nsCOMPtr&lt;calIICSService&gt; icsSvc = cal::getICSService();</span>
<a href="#l11.971"></a><span id="l11.971" class="difflineplus">+  nsCOMPtr&lt;calIIcalProperty&gt; prop;</span>
<a href="#l11.972"></a><span id="l11.972" class="difflineplus">+</span>
<a href="#l11.973"></a><span id="l11.973" class="difflineplus">+  rv = icsSvc-&gt;CreateIcalPropertyFromString(str, getter_AddRefs(prop));</span>
<a href="#l11.974"></a><span id="l11.974" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.975"></a><span id="l11.975"> </span>
<a href="#l11.976"></a><span id="l11.976" class="difflineminus">-    rv = icsSvc-&gt;CreateIcalPropertyFromString(str, getter_AddRefs(prop));</span>
<a href="#l11.977"></a><span id="l11.977" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.978"></a><span id="l11.978" class="difflineminus">-</span>
<a href="#l11.979"></a><span id="l11.979" class="difflineminus">-    rv = prop-&gt;GetPropertyName(name);</span>
<a href="#l11.980"></a><span id="l11.980" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.981"></a><span id="l11.981" class="difflineplus">+  rv = prop-&gt;GetPropertyName(name);</span>
<a href="#l11.982"></a><span id="l11.982" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.983"></a><span id="l11.983"> </span>
<a href="#l11.984"></a><span id="l11.984" class="difflineminus">-    if (!name.EqualsLiteral(&quot;RRULE&quot;)) {</span>
<a href="#l11.985"></a><span id="l11.985" class="difflineminus">-        return NS_ERROR_ILLEGAL_VALUE;</span>
<a href="#l11.986"></a><span id="l11.986" class="difflineminus">-    }</span>
<a href="#l11.987"></a><span id="l11.987" class="difflineplus">+  if (!name.EqualsLiteral(&quot;RRULE&quot;)) {</span>
<a href="#l11.988"></a><span id="l11.988" class="difflineplus">+    return NS_ERROR_ILLEGAL_VALUE;</span>
<a href="#l11.989"></a><span id="l11.989" class="difflineplus">+  }</span>
<a href="#l11.990"></a><span id="l11.990"> </span>
<a href="#l11.991"></a><span id="l11.991" class="difflineminus">-    return SetIcalProperty(prop);</span>
<a href="#l11.992"></a><span id="l11.992" class="difflineplus">+  return SetIcalProperty(prop);</span>
<a href="#l11.993"></a><span id="l11.993"> }</span>
<a href="#l11.994"></a><span id="l11.994"> </span>
<a href="#l11.995"></a><span id="l11.995"> NS_IMETHODIMP</span>
<a href="#l11.996"></a><span id="l11.996" class="difflineminus">-calRecurrenceRule::GetIcalString(nsACString &amp;str)</span>
<a href="#l11.997"></a><span id="l11.997" class="difflineminus">-{</span>
<a href="#l11.998"></a><span id="l11.998" class="difflineminus">-    nsresult rv = NS_OK;</span>
<a href="#l11.999"></a><span id="l11.999" class="difflineplus">+calRecurrenceRule::GetIcalString(nsACString &amp;str) {</span>
<a href="#l11.1000"></a><span id="l11.1000" class="difflineplus">+  nsresult rv = NS_OK;</span>
<a href="#l11.1001"></a><span id="l11.1001"> </span>
<a href="#l11.1002"></a><span id="l11.1002" class="difflineminus">-    nsCOMPtr&lt;calIIcalProperty&gt; prop;</span>
<a href="#l11.1003"></a><span id="l11.1003" class="difflineplus">+  nsCOMPtr&lt;calIIcalProperty&gt; prop;</span>
<a href="#l11.1004"></a><span id="l11.1004"> </span>
<a href="#l11.1005"></a><span id="l11.1005" class="difflineminus">-    rv = this-&gt;GetIcalProperty(getter_AddRefs(prop));</span>
<a href="#l11.1006"></a><span id="l11.1006" class="difflineplus">+  rv = this-&gt;GetIcalProperty(getter_AddRefs(prop));</span>
<a href="#l11.1007"></a><span id="l11.1007"> </span>
<a href="#l11.1008"></a><span id="l11.1008" class="difflineminus">-    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l11.1009"></a><span id="l11.1009" class="difflineminus">-        rv = prop-&gt;GetIcalString(str);</span>
<a href="#l11.1010"></a><span id="l11.1010" class="difflineminus">-    }</span>
<a href="#l11.1011"></a><span id="l11.1011" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l11.1012"></a><span id="l11.1012" class="difflineplus">+    rv = prop-&gt;GetIcalString(str);</span>
<a href="#l11.1013"></a><span id="l11.1013" class="difflineplus">+  }</span>
<a href="#l11.1014"></a><span id="l11.1014"> </span>
<a href="#l11.1015"></a><span id="l11.1015" class="difflineminus">-    return rv;</span>
<a href="#l11.1016"></a><span id="l11.1016" class="difflineplus">+  return rv;</span>
<a href="#l11.1017"></a><span id="l11.1017"> }</span>
<a href="#l11.1018"></a><span id="l11.1018"> </span>
<a href="#l11.1019"></a><span id="l11.1019"> NS_IMETHODIMP</span>
<a href="#l11.1020"></a><span id="l11.1020" class="difflineminus">-calRecurrenceRule::GetWeekStart(short*)</span>
<a href="#l11.1021"></a><span id="l11.1021" class="difflineminus">-{</span>
<a href="#l11.1022"></a><span id="l11.1022" class="difflineminus">-    return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l11.1023"></a><span id="l11.1023" class="difflineminus">-}</span>
<a href="#l11.1024"></a><span id="l11.1024" class="difflineplus">+calRecurrenceRule::GetWeekStart(short *) { return NS_ERROR_NOT_IMPLEMENTED; }</span>
<a href="#l11.1025"></a><span id="l11.1025"> </span>
<a href="#l11.1026"></a><span id="l11.1026"> NS_IMETHODIMP</span>
<a href="#l11.1027"></a><span id="l11.1027" class="difflineminus">-calRecurrenceRule::SetWeekStart(short)</span>
<a href="#l11.1028"></a><span id="l11.1028" class="difflineminus">-{</span>
<a href="#l11.1029"></a><span id="l11.1029" class="difflineminus">-    return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l11.1030"></a><span id="l11.1030" class="difflineminus">-}</span>
<a href="#l11.1031"></a><span id="l11.1031" class="difflineplus">+calRecurrenceRule::SetWeekStart(short) { return NS_ERROR_NOT_IMPLEMENTED; }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/calendar/base/backend/libical/calRecurrenceRule.h</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/calendar/base/backend/libical/calRecurrenceRule.h</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -1,33 +1,31 @@</span>
<a href="#l12.4"></a><span id="l12.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l12.5"></a><span id="l12.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l12.6"></a><span id="l12.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l12.7"></a><span id="l12.7"> #if !defined(INCLUDED_CAL_RECURRENCERULE_H)</span>
<a href="#l12.8"></a><span id="l12.8" class="difflineminus">-#define INCLUDED_CAL_RECURRENCERULE_H</span>
<a href="#l12.9"></a><span id="l12.9" class="difflineplus">+#  define INCLUDED_CAL_RECURRENCERULE_H</span>
<a href="#l12.10"></a><span id="l12.10"> </span>
<a href="#l12.11"></a><span id="l12.11" class="difflineminus">-#include &quot;calIRecurrenceRule.h&quot;</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-#include &quot;calUtils.h&quot;</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+#  include &quot;calIRecurrenceRule.h&quot;</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineplus">+#  include &quot;calUtils.h&quot;</span>
<a href="#l12.15"></a><span id="l12.15"> </span>
<a href="#l12.16"></a><span id="l12.16"> extern &quot;C&quot; {</span>
<a href="#l12.17"></a><span id="l12.17" class="difflineminus">-#include &quot;ical.h&quot;</span>
<a href="#l12.18"></a><span id="l12.18" class="difflineplus">+#  include &quot;ical.h&quot;</span>
<a href="#l12.19"></a><span id="l12.19"> }</span>
<a href="#l12.20"></a><span id="l12.20"> </span>
<a href="#l12.21"></a><span id="l12.21" class="difflineminus">-class calRecurrenceRule : public calIRecurrenceRule,</span>
<a href="#l12.22"></a><span id="l12.22" class="difflineminus">-                          public cal::XpcomBase</span>
<a href="#l12.23"></a><span id="l12.23" class="difflineminus">-{</span>
<a href="#l12.24"></a><span id="l12.24" class="difflineminus">-public:</span>
<a href="#l12.25"></a><span id="l12.25" class="difflineminus">-    calRecurrenceRule();</span>
<a href="#l12.26"></a><span id="l12.26" class="difflineplus">+class calRecurrenceRule : public calIRecurrenceRule, public cal::XpcomBase {</span>
<a href="#l12.27"></a><span id="l12.27" class="difflineplus">+ public:</span>
<a href="#l12.28"></a><span id="l12.28" class="difflineplus">+  calRecurrenceRule();</span>
<a href="#l12.29"></a><span id="l12.29"> </span>
<a href="#l12.30"></a><span id="l12.30" class="difflineminus">-    NS_DECL_ISUPPORTS</span>
<a href="#l12.31"></a><span id="l12.31" class="difflineminus">-    NS_DECL_CALIRECURRENCEITEM</span>
<a href="#l12.32"></a><span id="l12.32" class="difflineminus">-    NS_DECL_CALIRECURRENCERULE</span>
<a href="#l12.33"></a><span id="l12.33" class="difflineminus">-protected:</span>
<a href="#l12.34"></a><span id="l12.34" class="difflineminus">-    virtual ~calRecurrenceRule() {}</span>
<a href="#l12.35"></a><span id="l12.35" class="difflineplus">+  NS_DECL_ISUPPORTS</span>
<a href="#l12.36"></a><span id="l12.36" class="difflineplus">+  NS_DECL_CALIRECURRENCEITEM</span>
<a href="#l12.37"></a><span id="l12.37" class="difflineplus">+  NS_DECL_CALIRECURRENCERULE</span>
<a href="#l12.38"></a><span id="l12.38" class="difflineplus">+ protected:</span>
<a href="#l12.39"></a><span id="l12.39" class="difflineplus">+  virtual ~calRecurrenceRule() {}</span>
<a href="#l12.40"></a><span id="l12.40"> </span>
<a href="#l12.41"></a><span id="l12.41" class="difflineminus">-    icalrecurrencetype mIcalRecur;</span>
<a href="#l12.42"></a><span id="l12.42" class="difflineplus">+  icalrecurrencetype mIcalRecur;</span>
<a href="#l12.43"></a><span id="l12.43"> </span>
<a href="#l12.44"></a><span id="l12.44" class="difflineminus">-    bool mImmutable;</span>
<a href="#l12.45"></a><span id="l12.45" class="difflineminus">-    bool mIsNegative;</span>
<a href="#l12.46"></a><span id="l12.46" class="difflineminus">-    bool mIsByCount;</span>
<a href="#l12.47"></a><span id="l12.47" class="difflineplus">+  bool mImmutable;</span>
<a href="#l12.48"></a><span id="l12.48" class="difflineplus">+  bool mIsNegative;</span>
<a href="#l12.49"></a><span id="l12.49" class="difflineplus">+  bool mIsByCount;</span>
<a href="#l12.50"></a><span id="l12.50"> };</span>
<a href="#l12.51"></a><span id="l12.51"> </span>
<a href="#l12.52"></a><span id="l12.52" class="difflineminus">-#endif // INCLUDED_CAL_RECURRENCERULE_H</span>
<a href="#l12.53"></a><span id="l12.53" class="difflineplus">+#endif  // INCLUDED_CAL_RECURRENCERULE_H</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/calendar/base/backend/libical/calTimezone.cpp</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/calendar/base/backend/libical/calTimezone.cpp</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -6,55 +6,54 @@</span>
<a href="#l13.4"></a><span id="l13.4"> #include &quot;calAttributeHelpers.h&quot;</span>
<a href="#l13.5"></a><span id="l13.5"> </span>
<a href="#l13.6"></a><span id="l13.6"> NS_IMPL_ISUPPORTS(calTimezone, calITimezone)</span>
<a href="#l13.7"></a><span id="l13.7"> </span>
<a href="#l13.8"></a><span id="l13.8"> CAL_ISUPPORTS_ATTR_GETTER(calTimezone, calIIcalComponent, IcalComponent)</span>
<a href="#l13.9"></a><span id="l13.9"> CAL_STRINGTYPE_ATTR_GETTER(calTimezone, nsACString, Tzid)</span>
<a href="#l13.10"></a><span id="l13.10"> </span>
<a href="#l13.11"></a><span id="l13.11"> NS_IMETHODIMP</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-calTimezone::GetIsFloating(bool * _retval) {</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineminus">-    NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineminus">-    *_retval = false;</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineminus">-    return NS_OK;</span>
<a href="#l13.16"></a><span id="l13.16" class="difflineplus">+calTimezone::GetIsFloating(bool* _retval) {</span>
<a href="#l13.17"></a><span id="l13.17" class="difflineplus">+  NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l13.18"></a><span id="l13.18" class="difflineplus">+  *_retval = false;</span>
<a href="#l13.19"></a><span id="l13.19" class="difflineplus">+  return NS_OK;</span>
<a href="#l13.20"></a><span id="l13.20"> }</span>
<a href="#l13.21"></a><span id="l13.21"> </span>
<a href="#l13.22"></a><span id="l13.22"> NS_IMETHODIMP</span>
<a href="#l13.23"></a><span id="l13.23" class="difflineminus">-calTimezone::GetIsUTC(bool * _retval) {</span>
<a href="#l13.24"></a><span id="l13.24" class="difflineminus">-    NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l13.25"></a><span id="l13.25" class="difflineminus">-    *_retval = false;</span>
<a href="#l13.26"></a><span id="l13.26" class="difflineminus">-    return NS_OK;</span>
<a href="#l13.27"></a><span id="l13.27" class="difflineplus">+calTimezone::GetIsUTC(bool* _retval) {</span>
<a href="#l13.28"></a><span id="l13.28" class="difflineplus">+  NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l13.29"></a><span id="l13.29" class="difflineplus">+  *_retval = false;</span>
<a href="#l13.30"></a><span id="l13.30" class="difflineplus">+  return NS_OK;</span>
<a href="#l13.31"></a><span id="l13.31"> }</span>
<a href="#l13.32"></a><span id="l13.32"> </span>
<a href="#l13.33"></a><span id="l13.33"> NS_IMETHODIMP</span>
<a href="#l13.34"></a><span id="l13.34" class="difflineminus">-calTimezone::GetDisplayName(nsAString &amp; _retval) {</span>
<a href="#l13.35"></a><span id="l13.35" class="difflineminus">-    _retval = NS_ConvertUTF8toUTF16(mTzid);</span>
<a href="#l13.36"></a><span id="l13.36" class="difflineminus">-    return NS_OK;</span>
<a href="#l13.37"></a><span id="l13.37" class="difflineplus">+calTimezone::GetDisplayName(nsAString&amp; _retval) {</span>
<a href="#l13.38"></a><span id="l13.38" class="difflineplus">+  _retval = NS_ConvertUTF8toUTF16(mTzid);</span>
<a href="#l13.39"></a><span id="l13.39" class="difflineplus">+  return NS_OK;</span>
<a href="#l13.40"></a><span id="l13.40"> }</span>
<a href="#l13.41"></a><span id="l13.41"> </span>
<a href="#l13.42"></a><span id="l13.42"> NS_IMETHODIMP</span>
<a href="#l13.43"></a><span id="l13.43" class="difflineminus">-calTimezone::GetLatitude(nsACString &amp; _retval) {</span>
<a href="#l13.44"></a><span id="l13.44" class="difflineminus">-    _retval.SetIsVoid(true);</span>
<a href="#l13.45"></a><span id="l13.45" class="difflineminus">-    return NS_OK;</span>
<a href="#l13.46"></a><span id="l13.46" class="difflineplus">+calTimezone::GetLatitude(nsACString&amp; _retval) {</span>
<a href="#l13.47"></a><span id="l13.47" class="difflineplus">+  _retval.SetIsVoid(true);</span>
<a href="#l13.48"></a><span id="l13.48" class="difflineplus">+  return NS_OK;</span>
<a href="#l13.49"></a><span id="l13.49"> }</span>
<a href="#l13.50"></a><span id="l13.50"> </span>
<a href="#l13.51"></a><span id="l13.51"> NS_IMETHODIMP</span>
<a href="#l13.52"></a><span id="l13.52" class="difflineminus">-calTimezone::GetLongitude(nsACString &amp; _retval) {</span>
<a href="#l13.53"></a><span id="l13.53" class="difflineminus">-    _retval.SetIsVoid(true);</span>
<a href="#l13.54"></a><span id="l13.54" class="difflineminus">-    return NS_OK;</span>
<a href="#l13.55"></a><span id="l13.55" class="difflineplus">+calTimezone::GetLongitude(nsACString&amp; _retval) {</span>
<a href="#l13.56"></a><span id="l13.56" class="difflineplus">+  _retval.SetIsVoid(true);</span>
<a href="#l13.57"></a><span id="l13.57" class="difflineplus">+  return NS_OK;</span>
<a href="#l13.58"></a><span id="l13.58"> }</span>
<a href="#l13.59"></a><span id="l13.59"> </span>
<a href="#l13.60"></a><span id="l13.60"> NS_IMETHODIMP</span>
<a href="#l13.61"></a><span id="l13.61" class="difflineminus">-calTimezone::GetProvider(calITimezoneProvider ** _retval) {</span>
<a href="#l13.62"></a><span id="l13.62" class="difflineminus">-    NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l13.63"></a><span id="l13.63" class="difflineminus">-    *_retval = nullptr;</span>
<a href="#l13.64"></a><span id="l13.64" class="difflineminus">-    return NS_OK;</span>
<a href="#l13.65"></a><span id="l13.65" class="difflineplus">+calTimezone::GetProvider(calITimezoneProvider** _retval) {</span>
<a href="#l13.66"></a><span id="l13.66" class="difflineplus">+  NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l13.67"></a><span id="l13.67" class="difflineplus">+  *_retval = nullptr;</span>
<a href="#l13.68"></a><span id="l13.68" class="difflineplus">+  return NS_OK;</span>
<a href="#l13.69"></a><span id="l13.69"> }</span>
<a href="#l13.70"></a><span id="l13.70"> </span>
<a href="#l13.71"></a><span id="l13.71"> NS_IMETHODIMP</span>
<a href="#l13.72"></a><span id="l13.72" class="difflineminus">-calTimezone::ToString(nsACString &amp; aResult) {</span>
<a href="#l13.73"></a><span id="l13.73" class="difflineminus">-    if (mIcalComponent) {</span>
<a href="#l13.74"></a><span id="l13.74" class="difflineminus">-        return mIcalComponent-&gt;ToString(aResult);</span>
<a href="#l13.75"></a><span id="l13.75" class="difflineminus">-    } else {</span>
<a href="#l13.76"></a><span id="l13.76" class="difflineminus">-        return GetTzid(aResult);</span>
<a href="#l13.77"></a><span id="l13.77" class="difflineminus">-    }</span>
<a href="#l13.78"></a><span id="l13.78" class="difflineplus">+calTimezone::ToString(nsACString&amp; aResult) {</span>
<a href="#l13.79"></a><span id="l13.79" class="difflineplus">+  if (mIcalComponent) {</span>
<a href="#l13.80"></a><span id="l13.80" class="difflineplus">+    return mIcalComponent-&gt;ToString(aResult);</span>
<a href="#l13.81"></a><span id="l13.81" class="difflineplus">+  } else {</span>
<a href="#l13.82"></a><span id="l13.82" class="difflineplus">+    return GetTzid(aResult);</span>
<a href="#l13.83"></a><span id="l13.83" class="difflineplus">+  }</span>
<a href="#l13.84"></a><span id="l13.84"> }</span>
<a href="#l13.85"></a><span id="l13.85" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/calendar/base/backend/libical/calTimezone.h</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/calendar/base/backend/libical/calTimezone.h</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -1,28 +1,25 @@</span>
<a href="#l14.4"></a><span id="l14.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l14.5"></a><span id="l14.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l14.6"></a><span id="l14.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l14.7"></a><span id="l14.7"> #if !defined(INCLUDED_CAL_TIMEZONE_H)</span>
<a href="#l14.8"></a><span id="l14.8" class="difflineminus">-#define INCLUDED_CAL_TIMEZONE_H</span>
<a href="#l14.9"></a><span id="l14.9" class="difflineplus">+#  define INCLUDED_CAL_TIMEZONE_H</span>
<a href="#l14.10"></a><span id="l14.10"> </span>
<a href="#l14.11"></a><span id="l14.11" class="difflineminus">-#include &quot;nsCOMPtr.h&quot;</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-#include &quot;calITimezone.h&quot;</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineminus">-#include &quot;calUtils.h&quot;</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineplus">+#  include &quot;nsCOMPtr.h&quot;</span>
<a href="#l14.15"></a><span id="l14.15" class="difflineplus">+#  include &quot;calITimezone.h&quot;</span>
<a href="#l14.16"></a><span id="l14.16" class="difflineplus">+#  include &quot;calUtils.h&quot;</span>
<a href="#l14.17"></a><span id="l14.17"> </span>
<a href="#l14.18"></a><span id="l14.18" class="difflineminus">-class calTimezone : public calITimezone,</span>
<a href="#l14.19"></a><span id="l14.19" class="difflineminus">-                    public cal::XpcomBase</span>
<a href="#l14.20"></a><span id="l14.20" class="difflineminus">-{</span>
<a href="#l14.21"></a><span id="l14.21" class="difflineminus">-public:</span>
<a href="#l14.22"></a><span id="l14.22" class="difflineminus">-    calTimezone(nsCString const&amp; tzid, calIIcalComponent * component)</span>
<a href="#l14.23"></a><span id="l14.23" class="difflineminus">-        : mTzid(tzid),</span>
<a href="#l14.24"></a><span id="l14.24" class="difflineminus">-          mIcalComponent(component) {}</span>
<a href="#l14.25"></a><span id="l14.25" class="difflineplus">+class calTimezone : public calITimezone, public cal::XpcomBase {</span>
<a href="#l14.26"></a><span id="l14.26" class="difflineplus">+ public:</span>
<a href="#l14.27"></a><span id="l14.27" class="difflineplus">+  calTimezone(nsCString const&amp; tzid, calIIcalComponent* component)</span>
<a href="#l14.28"></a><span id="l14.28" class="difflineplus">+      : mTzid(tzid), mIcalComponent(component) {}</span>
<a href="#l14.29"></a><span id="l14.29"> </span>
<a href="#l14.30"></a><span id="l14.30" class="difflineminus">-    NS_DECL_ISUPPORTS</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineminus">-    NS_DECL_CALITIMEZONE</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineplus">+  NS_DECL_ISUPPORTS</span>
<a href="#l14.33"></a><span id="l14.33" class="difflineplus">+  NS_DECL_CALITIMEZONE</span>
<a href="#l14.34"></a><span id="l14.34"> </span>
<a href="#l14.35"></a><span id="l14.35" class="difflineminus">-protected:</span>
<a href="#l14.36"></a><span id="l14.36" class="difflineminus">-    virtual ~calTimezone() {}</span>
<a href="#l14.37"></a><span id="l14.37" class="difflineminus">-    nsCString const                   mTzid;</span>
<a href="#l14.38"></a><span id="l14.38" class="difflineminus">-    nsCOMPtr&lt;calIIcalComponent&gt; const mIcalComponent;</span>
<a href="#l14.39"></a><span id="l14.39" class="difflineplus">+ protected:</span>
<a href="#l14.40"></a><span id="l14.40" class="difflineplus">+  virtual ~calTimezone() {}</span>
<a href="#l14.41"></a><span id="l14.41" class="difflineplus">+  nsCString const mTzid;</span>
<a href="#l14.42"></a><span id="l14.42" class="difflineplus">+  nsCOMPtr&lt;calIIcalComponent&gt; const mIcalComponent;</span>
<a href="#l14.43"></a><span id="l14.43"> };</span>
<a href="#l14.44"></a><span id="l14.44"> </span>
<a href="#l14.45"></a><span id="l14.45" class="difflineminus">-#endif // INCLUDED_CAL_TIMEZONE_H</span>
<a href="#l14.46"></a><span id="l14.46" class="difflineplus">+#endif  // INCLUDED_CAL_TIMEZONE_H</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/calendar/base/backend/libical/calUtils.cpp</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/calendar/base/backend/libical/calUtils.cpp</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -8,86 +8,91 @@</span>
<a href="#l15.4"></a><span id="l15.4"> </span>
<a href="#l15.5"></a><span id="l15.5"> extern &quot;C&quot; {</span>
<a href="#l15.6"></a><span id="l15.6"> #include &quot;ical.h&quot;</span>
<a href="#l15.7"></a><span id="l15.7"> }</span>
<a href="#l15.8"></a><span id="l15.8"> </span>
<a href="#l15.9"></a><span id="l15.9"> namespace cal {</span>
<a href="#l15.10"></a><span id="l15.10"> </span>
<a href="#l15.11"></a><span id="l15.11"> nsresult logError(const nsAString&amp; msg) {</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-    nsresult rc;</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineminus">-    nsCOMPtr&lt;nsIScriptError&gt; const scriptError(do_CreateInstance(&quot;@mozilla.org/scripterror;1&quot;, &amp;rc));</span>
<a href="#l15.14"></a><span id="l15.14" class="difflineminus">-    NS_ENSURE_SUCCESS(rc, rc);</span>
<a href="#l15.15"></a><span id="l15.15" class="difflineminus">-    rc = scriptError-&gt;Init(msg, EmptyString(), EmptyString(), 0, 0, nsIScriptError::errorFlag, &quot;calendar&quot;, false, false);</span>
<a href="#l15.16"></a><span id="l15.16" class="difflineminus">-    return getConsoleService()-&gt;LogMessage(scriptError);</span>
<a href="#l15.17"></a><span id="l15.17" class="difflineplus">+  nsresult rc;</span>
<a href="#l15.18"></a><span id="l15.18" class="difflineplus">+  nsCOMPtr&lt;nsIScriptError&gt; const scriptError(</span>
<a href="#l15.19"></a><span id="l15.19" class="difflineplus">+      do_CreateInstance(&quot;@mozilla.org/scripterror;1&quot;, &amp;rc));</span>
<a href="#l15.20"></a><span id="l15.20" class="difflineplus">+  NS_ENSURE_SUCCESS(rc, rc);</span>
<a href="#l15.21"></a><span id="l15.21" class="difflineplus">+  rc = scriptError-&gt;Init(msg, EmptyString(), EmptyString(), 0, 0,</span>
<a href="#l15.22"></a><span id="l15.22" class="difflineplus">+                         nsIScriptError::errorFlag, &quot;calendar&quot;, false, false);</span>
<a href="#l15.23"></a><span id="l15.23" class="difflineplus">+  return getConsoleService()-&gt;LogMessage(scriptError);</span>
<a href="#l15.24"></a><span id="l15.24"> }</span>
<a href="#l15.25"></a><span id="l15.25"> </span>
<a href="#l15.26"></a><span id="l15.26"> nsresult logWarning(const nsAString&amp; msg) {</span>
<a href="#l15.27"></a><span id="l15.27" class="difflineminus">-    nsresult rc;</span>
<a href="#l15.28"></a><span id="l15.28" class="difflineminus">-    nsCOMPtr&lt;nsIScriptError&gt; const scriptError(do_CreateInstance(&quot;@mozilla.org/scripterror;1&quot;, &amp;rc));</span>
<a href="#l15.29"></a><span id="l15.29" class="difflineminus">-    NS_ENSURE_SUCCESS(rc, rc);</span>
<a href="#l15.30"></a><span id="l15.30" class="difflineminus">-    rc = scriptError-&gt;Init(msg, EmptyString(), EmptyString(), 0, 0, nsIScriptError::warningFlag, &quot;calendar&quot;, false, false);</span>
<a href="#l15.31"></a><span id="l15.31" class="difflineminus">-    return getConsoleService()-&gt;LogMessage(scriptError);</span>
<a href="#l15.32"></a><span id="l15.32" class="difflineplus">+  nsresult rc;</span>
<a href="#l15.33"></a><span id="l15.33" class="difflineplus">+  nsCOMPtr&lt;nsIScriptError&gt; const scriptError(</span>
<a href="#l15.34"></a><span id="l15.34" class="difflineplus">+      do_CreateInstance(&quot;@mozilla.org/scripterror;1&quot;, &amp;rc));</span>
<a href="#l15.35"></a><span id="l15.35" class="difflineplus">+  NS_ENSURE_SUCCESS(rc, rc);</span>
<a href="#l15.36"></a><span id="l15.36" class="difflineplus">+  rc = scriptError-&gt;Init(msg, EmptyString(), EmptyString(), 0, 0,</span>
<a href="#l15.37"></a><span id="l15.37" class="difflineplus">+                         nsIScriptError::warningFlag, &quot;calendar&quot;, false, false);</span>
<a href="#l15.38"></a><span id="l15.38" class="difflineplus">+  return getConsoleService()-&gt;LogMessage(scriptError);</span>
<a href="#l15.39"></a><span id="l15.39"> }</span>
<a href="#l15.40"></a><span id="l15.40"> </span>
<a href="#l15.41"></a><span id="l15.41"> nsresult log(char16_t const* msg) {</span>
<a href="#l15.42"></a><span id="l15.42" class="difflineminus">-    return getConsoleService()-&gt;LogStringMessage(msg);</span>
<a href="#l15.43"></a><span id="l15.43" class="difflineplus">+  return getConsoleService()-&gt;LogStringMessage(msg);</span>
<a href="#l15.44"></a><span id="l15.44"> }</span>
<a href="#l15.45"></a><span id="l15.45"> </span>
<a href="#l15.46"></a><span id="l15.46"> nsCOMPtr&lt;calITimezone&gt; detectTimezone(icaltimetype const&amp; icalt,</span>
<a href="#l15.47"></a><span id="l15.47" class="difflineminus">-                                      calITimezoneProvider * tzProvider)</span>
<a href="#l15.48"></a><span id="l15.48" class="difflineminus">-{</span>
<a href="#l15.49"></a><span id="l15.49" class="difflineminus">-    if (icalt.is_utc) {</span>
<a href="#l15.50"></a><span id="l15.50" class="difflineminus">-        return UTC();</span>
<a href="#l15.51"></a><span id="l15.51" class="difflineplus">+                                      calITimezoneProvider* tzProvider) {</span>
<a href="#l15.52"></a><span id="l15.52" class="difflineplus">+  if (icalt.is_utc) {</span>
<a href="#l15.53"></a><span id="l15.53" class="difflineplus">+    return UTC();</span>
<a href="#l15.54"></a><span id="l15.54" class="difflineplus">+  }</span>
<a href="#l15.55"></a><span id="l15.55" class="difflineplus">+  if (icalt.zone) {</span>
<a href="#l15.56"></a><span id="l15.56" class="difflineplus">+    char const* const tzid =</span>
<a href="#l15.57"></a><span id="l15.57" class="difflineplus">+        icaltimezone_get_tzid(const_cast&lt;icaltimezone*&gt;(icalt.zone));</span>
<a href="#l15.58"></a><span id="l15.58" class="difflineplus">+    if (tzid) {</span>
<a href="#l15.59"></a><span id="l15.59" class="difflineplus">+      nsCOMPtr&lt;calITimezone&gt; tz;</span>
<a href="#l15.60"></a><span id="l15.60" class="difflineplus">+      if (tzProvider) {</span>
<a href="#l15.61"></a><span id="l15.61" class="difflineplus">+        tzProvider-&gt;GetTimezone(nsDependentCString(tzid), getter_AddRefs(tz));</span>
<a href="#l15.62"></a><span id="l15.62" class="difflineplus">+      } else {</span>
<a href="#l15.63"></a><span id="l15.63" class="difflineplus">+        getTimezoneService()-&gt;GetTimezone(nsDependentCString(tzid),</span>
<a href="#l15.64"></a><span id="l15.64" class="difflineplus">+                                          getter_AddRefs(tz));</span>
<a href="#l15.65"></a><span id="l15.65" class="difflineplus">+      }</span>
<a href="#l15.66"></a><span id="l15.66" class="difflineplus">+      if (tz) {</span>
<a href="#l15.67"></a><span id="l15.67" class="difflineplus">+        return tz;</span>
<a href="#l15.68"></a><span id="l15.68" class="difflineplus">+      }</span>
<a href="#l15.69"></a><span id="l15.69" class="difflineplus">+      NS_ASSERTION(tz, &quot;no timezone found, falling back to floating!&quot;);</span>
<a href="#l15.70"></a><span id="l15.70" class="difflineplus">+      logMissingTimezone(tzid);</span>
<a href="#l15.71"></a><span id="l15.71">     }</span>
<a href="#l15.72"></a><span id="l15.72" class="difflineminus">-    if (icalt.zone) {</span>
<a href="#l15.73"></a><span id="l15.73" class="difflineminus">-        char const* const tzid = icaltimezone_get_tzid(const_cast&lt;icaltimezone *&gt;(icalt.zone));</span>
<a href="#l15.74"></a><span id="l15.74" class="difflineminus">-        if (tzid) {</span>
<a href="#l15.75"></a><span id="l15.75" class="difflineminus">-            nsCOMPtr&lt;calITimezone&gt; tz;</span>
<a href="#l15.76"></a><span id="l15.76" class="difflineminus">-            if (tzProvider) {</span>
<a href="#l15.77"></a><span id="l15.77" class="difflineminus">-                tzProvider-&gt;GetTimezone(nsDependentCString(tzid), getter_AddRefs(tz));</span>
<a href="#l15.78"></a><span id="l15.78" class="difflineminus">-            } else {</span>
<a href="#l15.79"></a><span id="l15.79" class="difflineminus">-                getTimezoneService()-&gt;GetTimezone(nsDependentCString(tzid), getter_AddRefs(tz));</span>
<a href="#l15.80"></a><span id="l15.80" class="difflineminus">-            }</span>
<a href="#l15.81"></a><span id="l15.81" class="difflineminus">-            if (tz) {</span>
<a href="#l15.82"></a><span id="l15.82" class="difflineminus">-                return tz;</span>
<a href="#l15.83"></a><span id="l15.83" class="difflineminus">-            }</span>
<a href="#l15.84"></a><span id="l15.84" class="difflineminus">-            NS_ASSERTION(tz, &quot;no timezone found, falling back to floating!&quot;);</span>
<a href="#l15.85"></a><span id="l15.85" class="difflineminus">-            logMissingTimezone(tzid);</span>
<a href="#l15.86"></a><span id="l15.86" class="difflineminus">-        }</span>
<a href="#l15.87"></a><span id="l15.87" class="difflineminus">-    }</span>
<a href="#l15.88"></a><span id="l15.88" class="difflineminus">-    return floating();</span>
<a href="#l15.89"></a><span id="l15.89" class="difflineplus">+  }</span>
<a href="#l15.90"></a><span id="l15.90" class="difflineplus">+  return floating();</span>
<a href="#l15.91"></a><span id="l15.91"> }</span>
<a href="#l15.92"></a><span id="l15.92"> </span>
<a href="#l15.93"></a><span id="l15.93"> void logMissingTimezone(char const* tzid) {</span>
<a href="#l15.94"></a><span id="l15.94" class="difflineminus">-    // xxx todo: needs l10n</span>
<a href="#l15.95"></a><span id="l15.95" class="difflineminus">-    nsString msg(NS_LITERAL_STRING(&quot;Timezone \&quot;&quot;));</span>
<a href="#l15.96"></a><span id="l15.96" class="difflineminus">-    msg += NS_ConvertUTF8toUTF16(tzid);</span>
<a href="#l15.97"></a><span id="l15.97" class="difflineminus">-    msg += NS_LITERAL_STRING(&quot;\&quot; not found, falling back to floating!&quot;);</span>
<a href="#l15.98"></a><span id="l15.98" class="difflineminus">-    logError(msg);</span>
<a href="#l15.99"></a><span id="l15.99" class="difflineplus">+  // xxx todo: needs l10n</span>
<a href="#l15.100"></a><span id="l15.100" class="difflineplus">+  nsString msg(NS_LITERAL_STRING(&quot;Timezone \&quot;&quot;));</span>
<a href="#l15.101"></a><span id="l15.101" class="difflineplus">+  msg += NS_ConvertUTF8toUTF16(tzid);</span>
<a href="#l15.102"></a><span id="l15.102" class="difflineplus">+  msg += NS_LITERAL_STRING(&quot;\&quot; not found, falling back to floating!&quot;);</span>
<a href="#l15.103"></a><span id="l15.103" class="difflineplus">+  logError(msg);</span>
<a href="#l15.104"></a><span id="l15.104"> }</span>
<a href="#l15.105"></a><span id="l15.105"> </span>
<a href="#l15.106"></a><span id="l15.106" class="difflineminus">-icaltimezone * getIcalTimezone(calITimezone * tz) {</span>
<a href="#l15.107"></a><span id="l15.107" class="difflineminus">-    icaltimezone * icaltz = nullptr;</span>
<a href="#l15.108"></a><span id="l15.108" class="difflineminus">-    if (!tz) {</span>
<a href="#l15.109"></a><span id="l15.109" class="difflineminus">-        NS_ASSERTION(false, &quot;No Timezone passed to getIcalTimezone&quot;);</span>
<a href="#l15.110"></a><span id="l15.110" class="difflineminus">-        return nullptr;</span>
<a href="#l15.111"></a><span id="l15.111" class="difflineminus">-    }</span>
<a href="#l15.112"></a><span id="l15.112" class="difflineplus">+icaltimezone* getIcalTimezone(calITimezone* tz) {</span>
<a href="#l15.113"></a><span id="l15.113" class="difflineplus">+  icaltimezone* icaltz = nullptr;</span>
<a href="#l15.114"></a><span id="l15.114" class="difflineplus">+  if (!tz) {</span>
<a href="#l15.115"></a><span id="l15.115" class="difflineplus">+    NS_ASSERTION(false, &quot;No Timezone passed to getIcalTimezone&quot;);</span>
<a href="#l15.116"></a><span id="l15.116" class="difflineplus">+    return nullptr;</span>
<a href="#l15.117"></a><span id="l15.117" class="difflineplus">+  }</span>
<a href="#l15.118"></a><span id="l15.118"> </span>
<a href="#l15.119"></a><span id="l15.119" class="difflineminus">-    bool b;</span>
<a href="#l15.120"></a><span id="l15.120" class="difflineminus">-    tz-&gt;GetIsUTC(&amp;b);</span>
<a href="#l15.121"></a><span id="l15.121" class="difflineminus">-    if (b) {</span>
<a href="#l15.122"></a><span id="l15.122" class="difflineminus">-        icaltz = icaltimezone_get_utc_timezone();</span>
<a href="#l15.123"></a><span id="l15.123" class="difflineminus">-    } else {</span>
<a href="#l15.124"></a><span id="l15.124" class="difflineminus">-        nsCOMPtr&lt;calIIcalComponent&gt; tzComp;</span>
<a href="#l15.125"></a><span id="l15.125" class="difflineminus">-        tz-&gt;GetIcalComponent(getter_AddRefs(tzComp));</span>
<a href="#l15.126"></a><span id="l15.126" class="difflineminus">-        if (tzComp) {</span>
<a href="#l15.127"></a><span id="l15.127" class="difflineminus">-            nsCOMPtr&lt;calIIcalComponentLibical&gt; tzCompLibical = do_QueryInterface(tzComp);</span>
<a href="#l15.128"></a><span id="l15.128" class="difflineminus">-            icaltz = tzCompLibical-&gt;GetLibicalTimezone();</span>
<a href="#l15.129"></a><span id="l15.129" class="difflineminus">-        } // else floating or phantom timezone</span>
<a href="#l15.130"></a><span id="l15.130" class="difflineminus">-    }</span>
<a href="#l15.131"></a><span id="l15.131" class="difflineminus">-    return icaltz;</span>
<a href="#l15.132"></a><span id="l15.132" class="difflineplus">+  bool b;</span>
<a href="#l15.133"></a><span id="l15.133" class="difflineplus">+  tz-&gt;GetIsUTC(&amp;b);</span>
<a href="#l15.134"></a><span id="l15.134" class="difflineplus">+  if (b) {</span>
<a href="#l15.135"></a><span id="l15.135" class="difflineplus">+    icaltz = icaltimezone_get_utc_timezone();</span>
<a href="#l15.136"></a><span id="l15.136" class="difflineplus">+  } else {</span>
<a href="#l15.137"></a><span id="l15.137" class="difflineplus">+    nsCOMPtr&lt;calIIcalComponent&gt; tzComp;</span>
<a href="#l15.138"></a><span id="l15.138" class="difflineplus">+    tz-&gt;GetIcalComponent(getter_AddRefs(tzComp));</span>
<a href="#l15.139"></a><span id="l15.139" class="difflineplus">+    if (tzComp) {</span>
<a href="#l15.140"></a><span id="l15.140" class="difflineplus">+      nsCOMPtr&lt;calIIcalComponentLibical&gt; tzCompLibical =</span>
<a href="#l15.141"></a><span id="l15.141" class="difflineplus">+          do_QueryInterface(tzComp);</span>
<a href="#l15.142"></a><span id="l15.142" class="difflineplus">+      icaltz = tzCompLibical-&gt;GetLibicalTimezone();</span>
<a href="#l15.143"></a><span id="l15.143" class="difflineplus">+    }  // else floating or phantom timezone</span>
<a href="#l15.144"></a><span id="l15.144" class="difflineplus">+  }</span>
<a href="#l15.145"></a><span id="l15.145" class="difflineplus">+  return icaltz;</span>
<a href="#l15.146"></a><span id="l15.146"> }</span>
<a href="#l15.147"></a><span id="l15.147"> </span>
<a href="#l15.148"></a><span id="l15.148" class="difflineminus">-XpcomBase::~XpcomBase() {</span>
<a href="#l15.149"></a><span id="l15.149" class="difflineminus">-}</span>
<a href="#l15.150"></a><span id="l15.150" class="difflineplus">+XpcomBase::~XpcomBase() {}</span>
<a href="#l15.151"></a><span id="l15.151"> </span>
<a href="#l15.152"></a><span id="l15.152" class="difflineminus">-}</span>
<a href="#l15.153"></a><span id="l15.153" class="difflineplus">+}  // namespace cal</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/calendar/base/backend/libical/calUtils.h</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/calendar/base/backend/libical/calUtils.h</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -1,166 +1,172 @@</span>
<a href="#l16.4"></a><span id="l16.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l16.5"></a><span id="l16.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l16.6"></a><span id="l16.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l16.7"></a><span id="l16.7"> #if !defined(INCLUDED_CAL_UTILS_H)</span>
<a href="#l16.8"></a><span id="l16.8" class="difflineminus">-#define INCLUDED_CAL_UTILS_H</span>
<a href="#l16.9"></a><span id="l16.9" class="difflineplus">+#  define INCLUDED_CAL_UTILS_H</span>
<a href="#l16.10"></a><span id="l16.10"> </span>
<a href="#l16.11"></a><span id="l16.11" class="difflineminus">-#include &quot;nsCRT.h&quot;</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-#include &quot;nsString.h&quot;</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineplus">+#  include &quot;nsCRT.h&quot;</span>
<a href="#l16.14"></a><span id="l16.14" class="difflineplus">+#  include &quot;nsString.h&quot;</span>
<a href="#l16.15"></a><span id="l16.15"> </span>
<a href="#l16.16"></a><span id="l16.16" class="difflineminus">-#include &quot;nsAutoPtr.h&quot;</span>
<a href="#l16.17"></a><span id="l16.17" class="difflineminus">-#include &quot;nsIStringEnumerator.h&quot;</span>
<a href="#l16.18"></a><span id="l16.18" class="difflineplus">+#  include &quot;nsAutoPtr.h&quot;</span>
<a href="#l16.19"></a><span id="l16.19" class="difflineplus">+#  include &quot;nsIStringEnumerator.h&quot;</span>
<a href="#l16.20"></a><span id="l16.20"> </span>
<a href="#l16.21"></a><span id="l16.21" class="difflineminus">-#include &quot;calITimezone.h&quot;</span>
<a href="#l16.22"></a><span id="l16.22" class="difflineminus">-#include &quot;calITimezoneProvider.h&quot;</span>
<a href="#l16.23"></a><span id="l16.23" class="difflineminus">-#include &quot;calIICSService.h&quot;</span>
<a href="#l16.24"></a><span id="l16.24" class="difflineminus">-#include &quot;nsIConsoleService.h&quot;</span>
<a href="#l16.25"></a><span id="l16.25" class="difflineminus">-#include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l16.26"></a><span id="l16.26" class="difflineminus">-#include &quot;nsIClassInfoImpl.h&quot;</span>
<a href="#l16.27"></a><span id="l16.27" class="difflineminus">-#include &quot;nsCOMPtr.h&quot;</span>
<a href="#l16.28"></a><span id="l16.28" class="difflineplus">+#  include &quot;calITimezone.h&quot;</span>
<a href="#l16.29"></a><span id="l16.29" class="difflineplus">+#  include &quot;calITimezoneProvider.h&quot;</span>
<a href="#l16.30"></a><span id="l16.30" class="difflineplus">+#  include &quot;calIICSService.h&quot;</span>
<a href="#l16.31"></a><span id="l16.31" class="difflineplus">+#  include &quot;nsIConsoleService.h&quot;</span>
<a href="#l16.32"></a><span id="l16.32" class="difflineplus">+#  include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l16.33"></a><span id="l16.33" class="difflineplus">+#  include &quot;nsIClassInfoImpl.h&quot;</span>
<a href="#l16.34"></a><span id="l16.34" class="difflineplus">+#  include &quot;nsCOMPtr.h&quot;</span>
<a href="#l16.35"></a><span id="l16.35"> </span>
<a href="#l16.36"></a><span id="l16.36" class="difflineminus">-#include &quot;calBaseCID.h&quot;</span>
<a href="#l16.37"></a><span id="l16.37" class="difflineplus">+#  include &quot;calBaseCID.h&quot;</span>
<a href="#l16.38"></a><span id="l16.38"> </span>
<a href="#l16.39"></a><span id="l16.39" class="difflineminus">-#define CAL_STRLEN_ARGS(x) x, sizeof(x)-1</span>
<a href="#l16.40"></a><span id="l16.40" class="difflineminus">-#define CAL_ENSURE_MEMORY(p) NS_ENSURE_TRUE(p, NS_ERROR_OUT_OF_MEMORY)</span>
<a href="#l16.41"></a><span id="l16.41" class="difflineplus">+#  define CAL_STRLEN_ARGS(x) x, sizeof(x) - 1</span>
<a href="#l16.42"></a><span id="l16.42" class="difflineplus">+#  define CAL_ENSURE_MEMORY(p) NS_ENSURE_TRUE(p, NS_ERROR_OUT_OF_MEMORY)</span>
<a href="#l16.43"></a><span id="l16.43"> </span>
<a href="#l16.44"></a><span id="l16.44"> typedef struct _icaltimezone icaltimezone;</span>
<a href="#l16.45"></a><span id="l16.45"> typedef struct icaltimetype icaltimetype;</span>
<a href="#l16.46"></a><span id="l16.46"> </span>
<a href="#l16.47"></a><span id="l16.47"> namespace cal {</span>
<a href="#l16.48"></a><span id="l16.48"> </span>
<a href="#l16.49"></a><span id="l16.49"> /**</span>
<a href="#l16.50"></a><span id="l16.50">  * Gets the global console service.</span>
<a href="#l16.51"></a><span id="l16.51">  */</span>
<a href="#l16.52"></a><span id="l16.52"> inline nsCOMPtr&lt;nsIConsoleService&gt; getConsoleService() {</span>
<a href="#l16.53"></a><span id="l16.53" class="difflineminus">-    return do_GetService(&quot;@mozilla.org/consoleservice;1&quot;);</span>
<a href="#l16.54"></a><span id="l16.54" class="difflineplus">+  return do_GetService(&quot;@mozilla.org/consoleservice;1&quot;);</span>
<a href="#l16.55"></a><span id="l16.55"> }</span>
<a href="#l16.56"></a><span id="l16.56"> </span>
<a href="#l16.57"></a><span id="l16.57"> /**</span>
<a href="#l16.58"></a><span id="l16.58">  * Gets the global ICS service.</span>
<a href="#l16.59"></a><span id="l16.59">  */</span>
<a href="#l16.60"></a><span id="l16.60"> inline nsCOMPtr&lt;calIICSService&gt; getICSService() {</span>
<a href="#l16.61"></a><span id="l16.61" class="difflineminus">-    return do_GetService(CAL_ICSSERVICE_CONTRACTID);</span>
<a href="#l16.62"></a><span id="l16.62" class="difflineplus">+  return do_GetService(CAL_ICSSERVICE_CONTRACTID);</span>
<a href="#l16.63"></a><span id="l16.63"> }</span>
<a href="#l16.64"></a><span id="l16.64"> </span>
<a href="#l16.65"></a><span id="l16.65"> /**</span>
<a href="#l16.66"></a><span id="l16.66">  * Gets the global timezone service.</span>
<a href="#l16.67"></a><span id="l16.67">  */</span>
<a href="#l16.68"></a><span id="l16.68"> inline nsCOMPtr&lt;calITimezoneService&gt; getTimezoneService() {</span>
<a href="#l16.69"></a><span id="l16.69" class="difflineminus">-    nsresult rv;</span>
<a href="#l16.70"></a><span id="l16.70" class="difflineminus">-    nsCOMPtr&lt;calITimezoneService&gt; tzs;</span>
<a href="#l16.71"></a><span id="l16.71" class="difflineplus">+  nsresult rv;</span>
<a href="#l16.72"></a><span id="l16.72" class="difflineplus">+  nsCOMPtr&lt;calITimezoneService&gt; tzs;</span>
<a href="#l16.73"></a><span id="l16.73"> </span>
<a href="#l16.74"></a><span id="l16.74" class="difflineminus">-    tzs = do_GetService(CAL_TIMEZONESERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l16.75"></a><span id="l16.75" class="difflineminus">-    if (NS_FAILED(rv)) {</span>
<a href="#l16.76"></a><span id="l16.76" class="difflineminus">-        MOZ_CRASH(&quot;Could not load timezone service, brace yourself and prepare for crash&quot;);</span>
<a href="#l16.77"></a><span id="l16.77" class="difflineminus">-    }</span>
<a href="#l16.78"></a><span id="l16.78" class="difflineminus">-    return tzs;</span>
<a href="#l16.79"></a><span id="l16.79" class="difflineplus">+  tzs = do_GetService(CAL_TIMEZONESERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l16.80"></a><span id="l16.80" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l16.81"></a><span id="l16.81" class="difflineplus">+    MOZ_CRASH(</span>
<a href="#l16.82"></a><span id="l16.82" class="difflineplus">+        &quot;Could not load timezone service, brace yourself and prepare for &quot;</span>
<a href="#l16.83"></a><span id="l16.83" class="difflineplus">+        &quot;crash&quot;);</span>
<a href="#l16.84"></a><span id="l16.84" class="difflineplus">+  }</span>
<a href="#l16.85"></a><span id="l16.85" class="difflineplus">+  return tzs;</span>
<a href="#l16.86"></a><span id="l16.86"> }</span>
<a href="#l16.87"></a><span id="l16.87"> </span>
<a href="#l16.88"></a><span id="l16.88"> /**</span>
<a href="#l16.89"></a><span id="l16.89">  * Logs an error.</span>
<a href="#l16.90"></a><span id="l16.90">  */</span>
<a href="#l16.91"></a><span id="l16.91"> nsresult logError(const nsAString&amp; msg);</span>
<a href="#l16.92"></a><span id="l16.92"> inline nsresult logError(char const* msg) {</span>
<a href="#l16.93"></a><span id="l16.93" class="difflineminus">-    return logError(NS_ConvertASCIItoUTF16(msg));</span>
<a href="#l16.94"></a><span id="l16.94" class="difflineplus">+  return logError(NS_ConvertASCIItoUTF16(msg));</span>
<a href="#l16.95"></a><span id="l16.95"> }</span>
<a href="#l16.96"></a><span id="l16.96"> inline nsresult logError(nsACString const&amp; msg) {</span>
<a href="#l16.97"></a><span id="l16.97" class="difflineminus">-    return logError(NS_ConvertASCIItoUTF16(msg));</span>
<a href="#l16.98"></a><span id="l16.98" class="difflineplus">+  return logError(NS_ConvertASCIItoUTF16(msg));</span>
<a href="#l16.99"></a><span id="l16.99"> }</span>
<a href="#l16.100"></a><span id="l16.100"> </span>
<a href="#l16.101"></a><span id="l16.101"> /**</span>
<a href="#l16.102"></a><span id="l16.102">  * Logs a warning.</span>
<a href="#l16.103"></a><span id="l16.103">  */</span>
<a href="#l16.104"></a><span id="l16.104"> nsresult logWarning(const nsAString&amp; msg);</span>
<a href="#l16.105"></a><span id="l16.105"> inline nsresult logWarning(char const* msg) {</span>
<a href="#l16.106"></a><span id="l16.106" class="difflineminus">-    return logWarning(NS_ConvertASCIItoUTF16(msg));</span>
<a href="#l16.107"></a><span id="l16.107" class="difflineplus">+  return logWarning(NS_ConvertASCIItoUTF16(msg));</span>
<a href="#l16.108"></a><span id="l16.108"> }</span>
<a href="#l16.109"></a><span id="l16.109"> inline nsresult logWarning(nsACString const&amp; msg) {</span>
<a href="#l16.110"></a><span id="l16.110" class="difflineminus">-    return logWarning(NS_ConvertASCIItoUTF16(msg));</span>
<a href="#l16.111"></a><span id="l16.111" class="difflineplus">+  return logWarning(NS_ConvertASCIItoUTF16(msg));</span>
<a href="#l16.112"></a><span id="l16.112"> }</span>
<a href="#l16.113"></a><span id="l16.113"> </span>
<a href="#l16.114"></a><span id="l16.114"> /**</span>
<a href="#l16.115"></a><span id="l16.115">  * Just logs.</span>
<a href="#l16.116"></a><span id="l16.116">  */</span>
<a href="#l16.117"></a><span id="l16.117"> nsresult log(char16_t const* msg);</span>
<a href="#l16.118"></a><span id="l16.118"> inline nsresult log(char const* msg) {</span>
<a href="#l16.119"></a><span id="l16.119" class="difflineminus">-    return log(NS_ConvertASCIItoUTF16(msg).get());</span>
<a href="#l16.120"></a><span id="l16.120" class="difflineplus">+  return log(NS_ConvertASCIItoUTF16(msg).get());</span>
<a href="#l16.121"></a><span id="l16.121"> }</span>
<a href="#l16.122"></a><span id="l16.122"> inline nsresult log(nsACString const&amp; msg) {</span>
<a href="#l16.123"></a><span id="l16.123" class="difflineminus">-    return log(NS_ConvertASCIItoUTF16(msg).get());</span>
<a href="#l16.124"></a><span id="l16.124" class="difflineplus">+  return log(NS_ConvertASCIItoUTF16(msg).get());</span>
<a href="#l16.125"></a><span id="l16.125"> }</span>
<a href="#l16.126"></a><span id="l16.126"> </span>
<a href="#l16.127"></a><span id="l16.127"> // some timezone helpers</span>
<a href="#l16.128"></a><span id="l16.128"> </span>
<a href="#l16.129"></a><span id="l16.129"> /**</span>
<a href="#l16.130"></a><span id="l16.130">  * Gets the &quot;UTC&quot; timezone.</span>
<a href="#l16.131"></a><span id="l16.131">  */</span>
<a href="#l16.132"></a><span id="l16.132"> inline nsCOMPtr&lt;calITimezone&gt; UTC() {</span>
<a href="#l16.133"></a><span id="l16.133" class="difflineminus">-    nsresult rv;</span>
<a href="#l16.134"></a><span id="l16.134" class="difflineminus">-    nsCOMPtr&lt;calITimezone&gt; tz;</span>
<a href="#l16.135"></a><span id="l16.135" class="difflineplus">+  nsresult rv;</span>
<a href="#l16.136"></a><span id="l16.136" class="difflineplus">+  nsCOMPtr&lt;calITimezone&gt; tz;</span>
<a href="#l16.137"></a><span id="l16.137"> </span>
<a href="#l16.138"></a><span id="l16.138" class="difflineminus">-    rv = getTimezoneService()-&gt;GetUTC(getter_AddRefs(tz));</span>
<a href="#l16.139"></a><span id="l16.139" class="difflineminus">-    if (NS_FAILED(rv)) {</span>
<a href="#l16.140"></a><span id="l16.140" class="difflineminus">-        MOZ_CRASH(&quot;Could not load UTC timezone, brace yourself and prepare for crash&quot;);</span>
<a href="#l16.141"></a><span id="l16.141" class="difflineminus">-    }</span>
<a href="#l16.142"></a><span id="l16.142" class="difflineplus">+  rv = getTimezoneService()-&gt;GetUTC(getter_AddRefs(tz));</span>
<a href="#l16.143"></a><span id="l16.143" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l16.144"></a><span id="l16.144" class="difflineplus">+    MOZ_CRASH(</span>
<a href="#l16.145"></a><span id="l16.145" class="difflineplus">+        &quot;Could not load UTC timezone, brace yourself and prepare for crash&quot;);</span>
<a href="#l16.146"></a><span id="l16.146" class="difflineplus">+  }</span>
<a href="#l16.147"></a><span id="l16.147"> </span>
<a href="#l16.148"></a><span id="l16.148" class="difflineminus">-    return tz;</span>
<a href="#l16.149"></a><span id="l16.149" class="difflineplus">+  return tz;</span>
<a href="#l16.150"></a><span id="l16.150"> }</span>
<a href="#l16.151"></a><span id="l16.151"> </span>
<a href="#l16.152"></a><span id="l16.152"> /**</span>
<a href="#l16.153"></a><span id="l16.153">  * Gets the &quot;floating&quot; timezone</span>
<a href="#l16.154"></a><span id="l16.154">  */</span>
<a href="#l16.155"></a><span id="l16.155"> inline nsCOMPtr&lt;calITimezone&gt; floating() {</span>
<a href="#l16.156"></a><span id="l16.156" class="difflineminus">-    nsresult rv;</span>
<a href="#l16.157"></a><span id="l16.157" class="difflineminus">-    nsCOMPtr&lt;calITimezone&gt; tz;</span>
<a href="#l16.158"></a><span id="l16.158" class="difflineplus">+  nsresult rv;</span>
<a href="#l16.159"></a><span id="l16.159" class="difflineplus">+  nsCOMPtr&lt;calITimezone&gt; tz;</span>
<a href="#l16.160"></a><span id="l16.160"> </span>
<a href="#l16.161"></a><span id="l16.161" class="difflineminus">-    rv = getTimezoneService()-&gt;GetFloating(getter_AddRefs(tz));</span>
<a href="#l16.162"></a><span id="l16.162" class="difflineminus">-    if (NS_FAILED(rv)) {</span>
<a href="#l16.163"></a><span id="l16.163" class="difflineminus">-        MOZ_CRASH(&quot;Could not load floating timezone, brace yourself and prepare for crash&quot;);</span>
<a href="#l16.164"></a><span id="l16.164" class="difflineminus">-    }</span>
<a href="#l16.165"></a><span id="l16.165" class="difflineplus">+  rv = getTimezoneService()-&gt;GetFloating(getter_AddRefs(tz));</span>
<a href="#l16.166"></a><span id="l16.166" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l16.167"></a><span id="l16.167" class="difflineplus">+    MOZ_CRASH(</span>
<a href="#l16.168"></a><span id="l16.168" class="difflineplus">+        &quot;Could not load floating timezone, brace yourself and prepare for &quot;</span>
<a href="#l16.169"></a><span id="l16.169" class="difflineplus">+        &quot;crash&quot;);</span>
<a href="#l16.170"></a><span id="l16.170" class="difflineplus">+  }</span>
<a href="#l16.171"></a><span id="l16.171"> </span>
<a href="#l16.172"></a><span id="l16.172" class="difflineminus">-    return tz;</span>
<a href="#l16.173"></a><span id="l16.173" class="difflineplus">+  return tz;</span>
<a href="#l16.174"></a><span id="l16.174"> }</span>
<a href="#l16.175"></a><span id="l16.175"> </span>
<a href="#l16.176"></a><span id="l16.176"> /**</span>
<a href="#l16.177"></a><span id="l16.177">  * Returns the libical VTIMEZONE component, null if floating.</span>
<a href="#l16.178"></a><span id="l16.178" class="difflineminus">- * </span>
<a href="#l16.179"></a><span id="l16.179" class="difflineplus">+ *</span>
<a href="#l16.180"></a><span id="l16.180">  * @attention</span>
<a href="#l16.181"></a><span id="l16.181">  * Every timezone provider needs to use calICSService for</span>
<a href="#l16.182"></a><span id="l16.182">  * creating its timezone components since we need to stick to the</span>
<a href="#l16.183"></a><span id="l16.183">  * same libical.</span>
<a href="#l16.184"></a><span id="l16.184" class="difflineminus">- */    </span>
<a href="#l16.185"></a><span id="l16.185" class="difflineminus">-icaltimezone * getIcalTimezone(calITimezone * tz);</span>
<a href="#l16.186"></a><span id="l16.186" class="difflineplus">+ */</span>
<a href="#l16.187"></a><span id="l16.187" class="difflineplus">+icaltimezone* getIcalTimezone(calITimezone* tz);</span>
<a href="#l16.188"></a><span id="l16.188"> </span>
<a href="#l16.189"></a><span id="l16.189"> /**</span>
<a href="#l16.190"></a><span id="l16.190">  * Detects the timezone icalt refers to, either using the</span>
<a href="#l16.191"></a><span id="l16.191">  * passed timezone provider or the global timezone service.</span>
<a href="#l16.192"></a><span id="l16.192">  *</span>
<a href="#l16.193"></a><span id="l16.193">  * @param icalt      an icaltime</span>
<a href="#l16.194"></a><span id="l16.194">  * @param tzProvider timezone provider or null which</span>
<a href="#l16.195"></a><span id="l16.195">  *                   defaults to the timezone service</span>
<a href="#l16.196"></a><span id="l16.196">  */</span>
<a href="#l16.197"></a><span id="l16.197"> nsCOMPtr&lt;calITimezone&gt; detectTimezone(icaltimetype const&amp; icalt,</span>
<a href="#l16.198"></a><span id="l16.198" class="difflineminus">-                                      calITimezoneProvider * tzProvider);</span>
<a href="#l16.199"></a><span id="l16.199" class="difflineplus">+                                      calITimezoneProvider* tzProvider);</span>
<a href="#l16.200"></a><span id="l16.200"> </span>
<a href="#l16.201"></a><span id="l16.201"> /**</span>
<a href="#l16.202"></a><span id="l16.202">  * Logs a missing timezone into the js console.</span>
<a href="#l16.203"></a><span id="l16.203">  */</span>
<a href="#l16.204"></a><span id="l16.204"> void logMissingTimezone(char const* tzid);</span>
<a href="#l16.205"></a><span id="l16.205"> </span>
<a href="#l16.206"></a><span id="l16.206"> /**</span>
<a href="#l16.207"></a><span id="l16.207">  * Common base class for XPCOM object implementations:</span>
<a href="#l16.208"></a><span id="l16.208">  * - disallows public deletion (virtual protected dtor)</span>
<a href="#l16.209"></a><span id="l16.209">  * - disallows copy semantics (no assignment, no copy ctor)</span>
<a href="#l16.210"></a><span id="l16.210">  */</span>
<a href="#l16.211"></a><span id="l16.211"> class XpcomBase {</span>
<a href="#l16.212"></a><span id="l16.212" class="difflineminus">-protected:</span>
<a href="#l16.213"></a><span id="l16.213" class="difflineminus">-    XpcomBase() {}</span>
<a href="#l16.214"></a><span id="l16.214" class="difflineminus">-    virtual ~XpcomBase();</span>
<a href="#l16.215"></a><span id="l16.215" class="difflineminus">-private:</span>
<a href="#l16.216"></a><span id="l16.216" class="difflineminus">-    XpcomBase(XpcomBase const&amp;); // left unimplemented</span>
<a href="#l16.217"></a><span id="l16.217" class="difflineminus">-    XpcomBase const&amp; operator=(XpcomBase const&amp;); // left unimplemented</span>
<a href="#l16.218"></a><span id="l16.218" class="difflineplus">+ protected:</span>
<a href="#l16.219"></a><span id="l16.219" class="difflineplus">+  XpcomBase() {}</span>
<a href="#l16.220"></a><span id="l16.220" class="difflineplus">+  virtual ~XpcomBase();</span>
<a href="#l16.221"></a><span id="l16.221" class="difflineplus">+</span>
<a href="#l16.222"></a><span id="l16.222" class="difflineplus">+ private:</span>
<a href="#l16.223"></a><span id="l16.223" class="difflineplus">+  XpcomBase(XpcomBase const&amp;);                   // left unimplemented</span>
<a href="#l16.224"></a><span id="l16.224" class="difflineplus">+  XpcomBase const&amp; operator=(XpcomBase const&amp;);  // left unimplemented</span>
<a href="#l16.225"></a><span id="l16.225"> };</span>
<a href="#l16.226"></a><span id="l16.226"> </span>
<a href="#l16.227"></a><span id="l16.227" class="difflineminus">-} // namespace cal</span>
<a href="#l16.228"></a><span id="l16.228" class="difflineplus">+}  // namespace cal</span>
<a href="#l16.229"></a><span id="l16.229"> </span>
<a href="#l16.230"></a><span id="l16.230" class="difflineminus">-#endif // !defined(INCLUDED_CAL_UTILS_H)</span>
<a href="#l16.231"></a><span id="l16.231" class="difflineplus">+#endif  // !defined(INCLUDED_CAL_UTILS_H)</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:31Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

